cscope 15 $HOME/workspace_la/btrfs_mfs_v4.3               0003594279
	@accessors.c

6 
	~<asm/uÇligÃd.h
>

7 
	~"mes§ges.h
"

8 
	~"ù»e.h
"

9 
	~"acûssÜs.h
"

11 
boŞ
 
	$check_£tg‘_bounds
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

12 cÚ¡ *
±r
, 
off
, 
size
)

14 cÚ¡ 
memb”_off£t
 = ()
±r
 + 
off
;

16 ià(
	`uÆik–y
(
memb”_off£t
 + 
size
 > 
eb
->
Ën
)) {

17 
	`bŒfs_w¬n
(
eb
->
fs_šfo
,

19 (
memb”_off£t
 > 
eb
->
Ën
 ? "start" : "end"),

20 ()
±r
, 
eb
->
¡¬t
, 
memb”_off£t
, 
size
);

21  
çl£
;

24  
Œue
;

25 
	}
}

27 
	$bŒfs_š™_m­_tok’
(
bŒfs_m­_tok’
 *
tok’
, 
ex‹Á_bufãr
 *
eb
)

29 
tok’
->
eb
 =ƒb;

30 
tok’
->
kaddr
 = 
	`·ge_add»ss
(
eb
->
·ges
[0]);

31 
tok’
->
off£t
 = 0;

32 
	}
}

58 
	#DEFINE_BTRFS_SETGET_BITS
(
b™s
) \

59 
u
##
b™s
 
bŒfs_g‘_tok’_
##
	`b™s
(
bŒfs_m­_tok’
 *
tok’
, \

60 cÚ¡ *
±r
, 
off
) \

62 cÚ¡ 
memb”_off£t
 = ()
±r
 + 
off
; \

63 cÚ¡ 
idx
 = 
	`g‘_eb_·ge_šdex
(
memb”_off£t
); \

64 cÚ¡ 
o
 = 
	`g‘_eb_off£t_š_·ge
(
tok’
->
eb
, \

65 
memb”_off£t
); \

66 cÚ¡ 
size
 = (
u
##
b™s
); \

67 
u8
 
Ëby‹s
[(
u
##
b™s
)]; \

68 cÚ¡ 
·¹
 = 
PAGE_SIZE
 - 
o
; \

70 
	`ASSERT
(
tok’
); \

71 
	`ASSERT
(
tok’
->
kaddr
); \

72 
	`ASSERT
(
	`check_£tg‘_bounds
(
tok’
->
eb
, 
±r
, 
off
, 
size
)); \

73 ià(
tok’
->
off£t
 <ğ
memb”_off£t
 && \

74 
memb”_off£t
 + 
size
 <ğ
tok’
->
off£t
 + 
PAGE_SIZE
) { \

75  
g‘_uÇligÃd_Ë
##
	`b™s
(
tok’
->
kaddr
 + 
o
); \

77 
tok’
->
kaddr
 = 
	`·ge_add»ss
Ñok’->
eb
->
·ges
[
idx
]); \

78 
tok’
->
off£t
 = 
idx
 << 
PAGE_SHIFT
; \

79 ià(
INLINE_EXTENT_BUFFER_PAGES
 =ğ1 || 
o
 + 
size
 <ğ
PAGE_SIZE
 ) \

80  
g‘_uÇligÃd_Ë
##
	`b™s
(
tok’
->
kaddr
 + 
o
); \

82 
	`memıy
(
Ëby‹s
, 
tok’
->
kaddr
 + 
o
, 
·¹
); \

83 
tok’
->
kaddr
 = 
	`·ge_add»ss
Ñok’->
eb
->
·ges
[
idx
 + 1]); \

84 
tok’
->
off£t
 = (
idx
 + 1è<< 
PAGE_SHIFT
; \

85 
	`memıy
(
Ëby‹s
 + 
·¹
, 
tok’
->
kaddr
, 
size
 -…art); \

86  
g‘_uÇligÃd_Ë
##
	`b™s
(
Ëby‹s
); \

88 
u
##
b™s
 
bŒfs_g‘_
##
	`b™s
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, \

89 cÚ¡ *
±r
, 
off
) \

91 cÚ¡ 
memb”_off£t
 = ()
±r
 + 
off
; \

92 cÚ¡ 
o
 = 
	`g‘_eb_off£t_š_·ge
(
eb
, 
memb”_off£t
); \

93 cÚ¡ 
idx
 = 
	`g‘_eb_·ge_šdex
(
memb”_off£t
); \

94 *
kaddr
 = 
	`·ge_add»ss
(
eb
->
·ges
[
idx
]); \

95 cÚ¡ 
size
 = (
u
##
b™s
); \

96 cÚ¡ 
·¹
 = 
PAGE_SIZE
 - 
o
; \

97 
u8
 
Ëby‹s
[(
u
##
b™s
)]; \

99 
	`ASSERT
(
	`check_£tg‘_bounds
(
eb
, 
±r
, 
off
, 
size
)); \

100 ià(
INLINE_EXTENT_BUFFER_PAGES
 =ğ1 || 
o
 + 
size
 <ğ
PAGE_SIZE
) \

101  
g‘_uÇligÃd_Ë
##
	`b™s
(
kaddr
 + 
o
); \

103 
	`memıy
(
Ëby‹s
, 
kaddr
 + 
o
, 
·¹
); \

104 
kaddr
 = 
	`·ge_add»ss
(
eb
->
·ges
[
idx
 + 1]); \

105 
	`memıy
(
Ëby‹s
 + 
·¹
, 
kaddr
, 
size
 -…art); \

106  
g‘_uÇligÃd_Ë
##
	`b™s
(
Ëby‹s
); \

108 
bŒfs_£t_tok’_
##
	`b™s
(
bŒfs_m­_tok’
 *
tok’
, \

109 cÚ¡ *
±r
, 
off
, \

110 
u
##
b™s
 
v®
) \

112 cÚ¡ 
memb”_off£t
 = ()
±r
 + 
off
; \

113 cÚ¡ 
idx
 = 
	`g‘_eb_·ge_šdex
(
memb”_off£t
); \

114 cÚ¡ 
o
 = 
	`g‘_eb_off£t_š_·ge
(
tok’
->
eb
, \

115 
memb”_off£t
); \

116 cÚ¡ 
size
 = (
u
##
b™s
); \

117 
u8
 
Ëby‹s
[(
u
##
b™s
)]; \

118 cÚ¡ 
·¹
 = 
PAGE_SIZE
 - 
o
; \

120 
	`ASSERT
(
tok’
); \

121 
	`ASSERT
(
tok’
->
kaddr
); \

122 
	`ASSERT
(
	`check_£tg‘_bounds
(
tok’
->
eb
, 
±r
, 
off
, 
size
)); \

123 ià(
tok’
->
off£t
 <ğ
memb”_off£t
 && \

124 
memb”_off£t
 + 
size
 <ğ
tok’
->
off£t
 + 
PAGE_SIZE
) { \

125 
put_uÇligÃd_Ë
##
	`b™s
(
v®
, 
tok’
->
kaddr
 + 
o
); \

128 
tok’
->
kaddr
 = 
	`·ge_add»ss
Ñok’->
eb
->
·ges
[
idx
]); \

129 
tok’
->
off£t
 = 
idx
 << 
PAGE_SHIFT
; \

130 ià(
INLINE_EXTENT_BUFFER_PAGES
 =ğ1 || 
o
 + 
size
 <ğ
PAGE_SIZE
) { \

131 
put_uÇligÃd_Ë
##
	`b™s
(
v®
, 
tok’
->
kaddr
 + 
o
); \

134 
put_uÇligÃd_Ë
##
	`b™s
(
v®
, 
Ëby‹s
); \

135 
	`memıy
(
tok’
->
kaddr
 + 
o
, 
Ëby‹s
, 
·¹
); \

136 
tok’
->
kaddr
 = 
	`·ge_add»ss
Ñok’->
eb
->
·ges
[
idx
 + 1]); \

137 
tok’
->
off£t
 = (
idx
 + 1è<< 
PAGE_SHIFT
; \

138 
	`memıy
(
tok’
->
kaddr
, 
Ëby‹s
 + 
·¹
, 
size
 -…art); \

140 
bŒfs_£t_
##
	`b™s
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, *
±r
, \

141 
off
, 
u
##
b™s
 
v®
) \

143 cÚ¡ 
memb”_off£t
 = ()
±r
 + 
off
; \

144 cÚ¡ 
o
 = 
	`g‘_eb_off£t_š_·ge
(
eb
, 
memb”_off£t
); \

145 cÚ¡ 
idx
 = 
	`g‘_eb_·ge_šdex
(
memb”_off£t
); \

146 *
kaddr
 = 
	`·ge_add»ss
(
eb
->
·ges
[
idx
]); \

147 cÚ¡ 
size
 = (
u
##
b™s
); \

148 cÚ¡ 
·¹
 = 
PAGE_SIZE
 - 
o
; \

149 
u8
 
Ëby‹s
[(
u
##
b™s
)]; \

151 
	`ASSERT
(
	`check_£tg‘_bounds
(
eb
, 
±r
, 
off
, 
size
)); \

152 ià(
INLINE_EXTENT_BUFFER_PAGES
 =ğ1 || 
o
 + 
size
 <ğ
PAGE_SIZE
) { \

153 
put_uÇligÃd_Ë
##
	`b™s
(
v®
, 
kaddr
 + 
o
); \

157 
put_uÇligÃd_Ë
##
	`b™s
(
v®
, 
Ëby‹s
); \

158 
	`memıy
(
kaddr
 + 
o
, 
Ëby‹s
, 
·¹
); \

159 
kaddr
 = 
	`·ge_add»ss
(
eb
->
·ges
[
idx
 + 1]); \

160 
	`memıy
(
kaddr
, 
Ëby‹s
 + 
·¹
, 
size
 -…art); \

161 }

	)

163 
	$DEFINE_BTRFS_SETGET_BITS
(8)

164 
	$DEFINE_BTRFS_SETGET_BITS
(16)

165 
	$DEFINE_BTRFS_SETGET_BITS
(32)

166 
	$DEFINE_BTRFS_SETGET_BITS
(64)

168 
	$bŒfs_node_key
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

169 
bŒfs_disk_key
 *
disk_key
, 
Ä
)

171 
±r
 = 
	`bŒfs_node_key_±r_off£t
(
eb
, 
Ä
);

172 
	`»ad_eb_memb”
(
eb
, (
bŒfs_key_±r
 *)
±r
,

173 
bŒfs_key_±r
, 
key
, 
disk_key
);

174 
	}
}

	@accessors.h

3 #iâdeà
BTRFS_ACCESSORS_H


4 
	#BTRFS_ACCESSORS_H


	)

6 
	~<lšux/¡ddef.h
>

8 
	sbŒfs_m­_tok’
 {

9 
ex‹Á_bufãr
 *
	meb
;

10 *
	mkaddr
;

11 
	moff£t
;

14 
bŒfs_š™_m­_tok’
(
bŒfs_m­_tok’
 *
tok’
, 
ex‹Á_bufãr
 *
eb
);

21 
	#Ë8_to_ıu
(
v
è(v)

	)

22 
	#ıu_to_Ë8
(
v
è(v)

	)

23 
	#__Ë8
 
u8


	)

25 
šlše
 
u8
 
	$g‘_uÇligÃd_Ë8
(cÚ¡ *
p
)

27  *(
u8
 *)
p
;

28 
	}
}

30 
šlše
 
	$put_uÇligÃd_Ë8
(
u8
 
v®
, *
p
)

32 *(
u8
 *)
p
 = 
v®
;

33 
	}
}

35 
	#»ad_eb_memb”
(
eb
, 
±r
, 
ty³
, 
memb”
, 
»suÉ
) (\

36 
	`»ad_ex‹Á_bufãr
(
eb
, (*)(
»suÉ
), \

37 (()(
±r
)) + \

38 
	`off£tof
(
ty³
, 
memb”
), \

39 
	`sizeof_f›ld
(
ty³
, 
memb”
)))

	)

41 
	#wr™e_eb_memb”
(
eb
, 
±r
, 
ty³
, 
memb”
, 
»suÉ
) (\

42 
	`wr™e_ex‹Á_bufãr
(
eb
, (*)(
»suÉ
), \

43 (()(
±r
)) + \

44 
	`off£tof
(
ty³
, 
memb”
), \

45 
	`sizeof_f›ld
(
ty³
, 
memb”
)))

	)

47 
	#DECLARE_BTRFS_SETGET_BITS
(
b™s
) \

48 
u
##
b™s
 
bŒfs_g‘_tok’_
##
	`b™s
(
bŒfs_m­_tok’
 *
tok’
, \

49 cÚ¡ *
±r
, 
off
); \

50 
bŒfs_£t_tok’_
##
	`b™s
(
bŒfs_m­_tok’
 *
tok’
, \

51 cÚ¡ *
±r
, 
off
, \

52 
u
##
b™s
 
v®
); \

53 
u
##
b™s
 
bŒfs_g‘_
##
	`b™s
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, \

54 cÚ¡ *
±r
, 
off
); \

55 
bŒfs_£t_
##
	`b™s
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, *
±r
, \

56 
off
, 
u
##
b™s
 
v®
);

	)

58 
	$DECLARE_BTRFS_SETGET_BITS
(8)

59 
	$DECLARE_BTRFS_SETGET_BITS
(16)

60 
	$DECLARE_BTRFS_SETGET_BITS
(32)

61 
	$DECLARE_BTRFS_SETGET_BITS
(64)

63 
	#BTRFS_SETGET_FUNCS
(
Çme
, 
ty³
, 
memb”
, 
b™s
) \

64 
šlše
 
u
##
b™s
 
bŒfs_
##
	`Çme
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, \

65 cÚ¡ 
ty³
 *
s
) \

67 
	`¡©ic_as£¹
((
u
##
b™s
è=ğ
	`sizeof_f›ld
(
ty³
, 
memb”
)); \

68  
bŒfs_g‘_
##
	`b™s
(
eb
, 
s
, 
	`off£tof
(
ty³
, 
memb”
)); \

69 
	}
} \

70 
šlše
 
bŒfs_£t_
##
	`Çme
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
ty³
 *
s
, \

71 
u
##
b™s
 
v®
) \

73 
	`¡©ic_as£¹
((
u
##
b™s
è=ğ
	`sizeof_f›ld
(
ty³
, 
memb”
)); \

74 
bŒfs_£t_
##
	`b™s
(
eb
, 
s
, 
	`off£tof
(
ty³
, 
memb”
), 
v®
); \

76 
šlše
 
u
##
b™s
 
bŒfs_tok’_
##
	`Çme
(
bŒfs_m­_tok’
 *
tok’
, \

77 cÚ¡ 
ty³
 *
s
) \

79 
	`¡©ic_as£¹
((
u
##
b™s
è=ğ
	`sizeof_f›ld
(
ty³
, 
memb”
)); \

80  
bŒfs_g‘_tok’_
##
	`b™s
(
tok’
, 
s
, 
	`off£tof
(
ty³
, 
memb”
));\

82 
šlše
 
bŒfs_£t_tok’_
##
	`Çme
(
bŒfs_m­_tok’
 *
tok’
,\

83 
ty³
 *
s
, 
u
##
b™s
 
v®
) \

85 
	`¡©ic_as£¹
((
u
##
b™s
è=ğ
	`sizeof_f›ld
(
ty³
, 
memb”
)); \

86 
bŒfs_£t_tok’_
##
	`b™s
(
tok’
, 
s
, 
	`off£tof
(
ty³
, 
memb”
), 
v®
); \

87 }

	)

89 
	#BTRFS_SETGET_HEADER_FUNCS
(
Çme
, 
ty³
, 
memb”
, 
b™s
) \

90 
šlše
 
u
##
b™s
 
bŒfs_
##
	`Çme
(cÚ¡ 
ex‹Á_bufãr
 *
eb
) \

92 cÚ¡ 
ty³
 *
p
 = 
	`·ge_add»ss
(
eb
->
·ges
[0]) + \

93 
	`off£t_š_·ge
(
eb
->
¡¬t
); \

94  
g‘_uÇligÃd_Ë
##
	`b™s
(&
p
->
memb”
); \

96 
šlše
 
bŒfs_£t_
##
	`Çme
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, \

97 
u
##
b™s
 
v®
) \

99 
ty³
 *
p
 = 
	`·ge_add»ss
(
eb
->
·ges
[0]è+ 
	`off£t_š_·ge
Ób->
¡¬t
); \

100 
put_uÇligÃd_Ë
##
	`b™s
(
v®
, &
p
->
memb”
); \

101 }

	)

103 
	#BTRFS_SETGET_STACK_FUNCS
(
Çme
, 
ty³
, 
memb”
, 
b™s
) \

104 
šlše
 
u
##
b™s
 
bŒfs_
##
	`Çme
(cÚ¡ 
ty³
 *
s
) \

106  
g‘_uÇligÃd_Ë
##
	`b™s
(&
s
->
memb”
); \

108 
šlše
 
bŒfs_£t_
##
	`Çme
(
ty³
 *
s
, 
u
##
b™s
 
v®
) \

110 
put_uÇligÃd_Ë
##
	`b™s
(
v®
, &
s
->
memb”
); \

111 }

	)

113 
šlše
 
u64
 
	$bŒfs_deviû_tÙ®_by‹s
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

114 
bŒfs_dev_™em
 *
s
)

116 
	`¡©ic_as£¹
((
u64
è=ğ
	`sizeof_f›ld
(
bŒfs_dev_™em
, 
tÙ®_by‹s
));

117  
	`bŒfs_g‘_64
(
eb
, 
s
, 
	`off£tof
(
bŒfs_dev_™em
, 
tÙ®_by‹s
));

118 
	}
}

119 
šlše
 
	$bŒfs_£t_deviû_tÙ®_by‹s
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

120 
bŒfs_dev_™em
 *
s
,

121 
u64
 
v®
)

123 
	`¡©ic_as£¹
((
u64
è=ğ
	`sizeof_f›ld
(
bŒfs_dev_™em
, 
tÙ®_by‹s
));

124 
	`WARN_ON
(!
	`IS_ALIGNED
(
v®
, 
eb
->
fs_šfo
->
£ùÜsize
));

125 
	`bŒfs_£t_64
(
eb
, 
s
, 
	`off£tof
(
bŒfs_dev_™em
, 
tÙ®_by‹s
), 
v®
);

126 
	}
}

128 
BTRFS_SETGET_FUNCS
(
deviû_ty³
, 
bŒfs_dev_™em
, 
ty³
, 64);

129 
BTRFS_SETGET_FUNCS
(
deviû_by‹s_u£d
, 
bŒfs_dev_™em
, 
by‹s_u£d
, 64);

130 
BTRFS_SETGET_FUNCS
(
deviû_io_®ign
, 
bŒfs_dev_™em
, 
io_®ign
, 32);

131 
BTRFS_SETGET_FUNCS
(
deviû_io_width
, 
bŒfs_dev_™em
, 
io_width
, 32);

132 
BTRFS_SETGET_FUNCS
(
deviû_¡¬t_off£t
, 
bŒfs_dev_™em
, 
¡¬t_off£t
, 64);

133 
BTRFS_SETGET_FUNCS
(
deviû_£ùÜ_size
, 
bŒfs_dev_™em
, 
£ùÜ_size
, 32);

134 
BTRFS_SETGET_FUNCS
(
deviû_id
, 
bŒfs_dev_™em
, 
devid
, 64);

135 
BTRFS_SETGET_FUNCS
(
deviû_group
, 
bŒfs_dev_™em
, 
dev_group
, 32);

136 
BTRFS_SETGET_FUNCS
(
deviû_£ek_¥“d
, 
bŒfs_dev_™em
, 
£ek_¥“d
, 8);

137 
BTRFS_SETGET_FUNCS
(
deviû_bªdwidth
, 
bŒfs_dev_™em
, 
bªdwidth
, 8);

138 
BTRFS_SETGET_FUNCS
(
deviû_g’”©iÚ
, 
bŒfs_dev_™em
, 
g’”©iÚ
, 64);

140 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_ty³
, 
bŒfs_dev_™em
, 
ty³
, 64);

141 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_tÙ®_by‹s
, 
bŒfs_dev_™em
,

142 
tÙ®_by‹s
, 64);

143 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_by‹s_u£d
, 
bŒfs_dev_™em
,

144 
by‹s_u£d
, 64);

145 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_io_®ign
, 
bŒfs_dev_™em
,

146 
io_®ign
, 32);

147 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_io_width
, 
bŒfs_dev_™em
,

148 
io_width
, 32);

149 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_£ùÜ_size
, 
bŒfs_dev_™em
,

150 
£ùÜ_size
, 32);

151 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_id
, 
bŒfs_dev_™em
, 
devid
, 64);

152 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_group
, 
bŒfs_dev_™em
, 
dev_group
, 32);

153 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_£ek_¥“d
, 
bŒfs_dev_™em
,

154 
£ek_¥“d
, 8);

155 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_bªdwidth
, 
bŒfs_dev_™em
,

156 
bªdwidth
, 8);

157 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_g’”©iÚ
, 
bŒfs_dev_™em
,

158 
g’”©iÚ
, 64);

160 
šlše
 
	$bŒfs_deviû_uuid
(
bŒfs_dev_™em
 *
d
)

162  ()
d
 + 
	`off£tof
(
bŒfs_dev_™em
, 
uuid
);

163 
	}
}

165 
šlše
 
	$bŒfs_deviû_fsid
(
bŒfs_dev_™em
 *
d
)

167  ()
d
 + 
	`off£tof
(
bŒfs_dev_™em
, 
fsid
);

168 
	}
}

170 
BTRFS_SETGET_FUNCS
(
chunk_Ëngth
, 
bŒfs_chunk
, 
Ëngth
, 64);

171 
BTRFS_SETGET_FUNCS
(
chunk_owÃr
, 
bŒfs_chunk
, 
owÃr
, 64);

172 
BTRFS_SETGET_FUNCS
(
chunk_¡re_Ën
, 
bŒfs_chunk
, 
¡re_Ën
, 64);

173 
BTRFS_SETGET_FUNCS
(
chunk_io_®ign
, 
bŒfs_chunk
, 
io_®ign
, 32);

174 
BTRFS_SETGET_FUNCS
(
chunk_io_width
, 
bŒfs_chunk
, 
io_width
, 32);

175 
BTRFS_SETGET_FUNCS
(
chunk_£ùÜ_size
, 
bŒfs_chunk
, 
£ùÜ_size
, 32);

176 
BTRFS_SETGET_FUNCS
(
chunk_ty³
, 
bŒfs_chunk
, 
ty³
, 64);

177 
BTRFS_SETGET_FUNCS
(
chunk_num_¡res
, 
bŒfs_chunk
, 
num_¡res
, 16);

178 
BTRFS_SETGET_FUNCS
(
chunk_sub_¡res
, 
bŒfs_chunk
, 
sub_¡res
, 16);

179 
BTRFS_SETGET_FUNCS
(
¡re_devid
, 
bŒfs_¡re
, 
devid
, 64);

180 
BTRFS_SETGET_FUNCS
(
¡re_off£t
, 
bŒfs_¡re
, 
off£t
, 64);

182 
šlše
 *
	$bŒfs_¡re_dev_uuid
(
bŒfs_¡re
 *
s
)

184  (*)
s
 + 
	`off£tof
(
bŒfs_¡re
, 
dev_uuid
);

185 
	}
}

187 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_Ëngth
, 
bŒfs_chunk
, 
Ëngth
, 64);

188 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_owÃr
, 
bŒfs_chunk
, 
owÃr
, 64);

189 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_¡re_Ën
, 
bŒfs_chunk
,

190 
¡re_Ën
, 64);

191 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_io_®ign
, 
bŒfs_chunk
, 
io_®ign
, 32);

192 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_io_width
, 
bŒfs_chunk
, 
io_width
, 32);

193 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_£ùÜ_size
, 
bŒfs_chunk
,

194 
£ùÜ_size
, 32);

195 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_ty³
, 
bŒfs_chunk
, 
ty³
, 64);

196 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_num_¡res
, 
bŒfs_chunk
,

197 
num_¡res
, 16);

198 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_sub_¡res
, 
bŒfs_chunk
,

199 
sub_¡res
, 16);

200 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_¡re_devid
, 
bŒfs_¡re
, 
devid
, 64);

201 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_¡re_off£t
, 
bŒfs_¡re
, 
off£t
, 64);

203 
šlše
 
bŒfs_¡re
 *
	$bŒfs_¡re_Ä
(
bŒfs_chunk
 *
c
, 
Ä
)

205 
off£t
 = ()
c
;

207 
off£t
 +ğ
	`off£tof
(
bŒfs_chunk
, 
¡re
);

208 
off£t
 +ğ
Ä
 * (
bŒfs_¡re
);

209  (
bŒfs_¡re
 *)
off£t
;

210 
	}
}

212 
šlše
 *
	$bŒfs_¡re_dev_uuid_Ä
(
bŒfs_chunk
 *
c
, 
Ä
)

214  
	`bŒfs_¡re_dev_uuid
(
	`bŒfs_¡re_Ä
(
c
, 
Ä
));

215 
	}
}

217 
šlše
 
u64
 
	$bŒfs_¡re_off£t_Ä
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

218 
bŒfs_chunk
 *
c
, 
Ä
)

220  
	`bŒfs_¡re_off£t
(
eb
, 
	`bŒfs_¡re_Ä
(
c
, 
Ä
));

221 
	}
}

223 
šlše
 
	$bŒfs_£t_¡re_off£t_Ä
(
ex‹Á_bufãr
 *
eb
,

224 
bŒfs_chunk
 *
c
, 
Ä
,

225 
u64
 
v®
)

227 
	`bŒfs_£t_¡re_off£t
(
eb
, 
	`bŒfs_¡re_Ä
(
c
, 
Ä
), 
v®
);

228 
	}
}

230 
šlše
 
u64
 
	$bŒfs_¡re_devid_Ä
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

231 
bŒfs_chunk
 *
c
, 
Ä
)

233  
	`bŒfs_¡re_devid
(
eb
, 
	`bŒfs_¡re_Ä
(
c
, 
Ä
));

234 
	}
}

236 
šlše
 
	$bŒfs_£t_¡re_devid_Ä
(
ex‹Á_bufãr
 *
eb
,

237 
bŒfs_chunk
 *
c
, 
Ä
,

238 
u64
 
v®
)

240 
	`bŒfs_£t_¡re_devid
(
eb
, 
	`bŒfs_¡re_Ä
(
c
, 
Ä
), 
v®
);

241 
	}
}

244 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_block_group_u£d
, 
bŒfs_block_group_™em
,

245 
u£d
, 64);

246 
BTRFS_SETGET_FUNCS
(
block_group_u£d
, 
bŒfs_block_group_™em
, 
u£d
, 64);

247 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_block_group_chunk_objeùid
,

248 
bŒfs_block_group_™em
, 
chunk_objeùid
, 64);

250 
BTRFS_SETGET_FUNCS
(
block_group_chunk_objeùid
,

251 
bŒfs_block_group_™em
, 
chunk_objeùid
, 64);

252 
BTRFS_SETGET_FUNCS
(
block_group_æags
, 
bŒfs_block_group_™em
, 
æags
, 64);

253 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_block_group_æags
,

254 
bŒfs_block_group_™em
, 
æags
, 64);

257 
BTRFS_SETGET_FUNCS
(
ä“_¥aû_ex‹Á_couÁ
, 
bŒfs_ä“_¥aû_šfo
,

258 
ex‹Á_couÁ
, 32);

259 
BTRFS_SETGET_FUNCS
(
ä“_¥aû_æags
, 
bŒfs_ä“_¥aû_šfo
, 
æags
, 32);

262 
BTRFS_SETGET_FUNCS
(
šode_»f_Çme_Ën
, 
bŒfs_šode_»f
, 
Çme_Ën
, 16);

263 
BTRFS_SETGET_FUNCS
(
šode_»f_šdex
, 
bŒfs_šode_»f
, 
šdex
, 64);

264 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_»f_Çme_Ën
, 
bŒfs_šode_»f
, 
Çme_Ën
, 16);

265 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_»f_šdex
, 
bŒfs_šode_»f
, 
šdex
, 64);

268 
BTRFS_SETGET_FUNCS
(
šode_exŒef_·»Á
, 
bŒfs_šode_exŒef
,

269 
·»Á_objeùid
, 64);

270 
BTRFS_SETGET_FUNCS
(
šode_exŒef_Çme_Ën
, 
bŒfs_šode_exŒef
,

271 
Çme_Ën
, 16);

272 
BTRFS_SETGET_FUNCS
(
šode_exŒef_šdex
, 
bŒfs_šode_exŒef
, 
šdex
, 64);

275 
BTRFS_SETGET_FUNCS
(
šode_g’”©iÚ
, 
bŒfs_šode_™em
, 
g’”©iÚ
, 64);

276 
BTRFS_SETGET_FUNCS
(
šode_£qu’û
, 
bŒfs_šode_™em
, 
£qu’û
, 64);

277 
BTRFS_SETGET_FUNCS
(
šode_Œªsid
, 
bŒfs_šode_™em
, 
Œªsid
, 64);

278 
BTRFS_SETGET_FUNCS
(
šode_size
, 
bŒfs_šode_™em
, 
size
, 64);

279 
BTRFS_SETGET_FUNCS
(
šode_nby‹s
, 
bŒfs_šode_™em
, 
nby‹s
, 64);

280 
BTRFS_SETGET_FUNCS
(
šode_block_group
, 
bŒfs_šode_™em
, 
block_group
, 64);

281 
BTRFS_SETGET_FUNCS
(
šode_Æšk
, 
bŒfs_šode_™em
, 
Æšk
, 32);

282 
BTRFS_SETGET_FUNCS
(
šode_uid
, 
bŒfs_šode_™em
, 
uid
, 32);

283 
BTRFS_SETGET_FUNCS
(
šode_gid
, 
bŒfs_šode_™em
, 
gid
, 32);

284 
BTRFS_SETGET_FUNCS
(
šode_mode
, 
bŒfs_šode_™em
, 
mode
, 32);

285 
BTRFS_SETGET_FUNCS
(
šode_rdev
, 
bŒfs_šode_™em
, 
rdev
, 64);

286 
BTRFS_SETGET_FUNCS
(
šode_æags
, 
bŒfs_šode_™em
, 
æags
, 64);

287 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_g’”©iÚ
, 
bŒfs_šode_™em
,

288 
g’”©iÚ
, 64);

289 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_£qu’û
, 
bŒfs_šode_™em
,

290 
£qu’û
, 64);

291 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_Œªsid
, 
bŒfs_šode_™em
,

292 
Œªsid
, 64);

293 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_size
, 
bŒfs_šode_™em
, 
size
, 64);

294 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_nby‹s
, 
bŒfs_šode_™em
, 
nby‹s
, 64);

295 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_block_group
, 
bŒfs_šode_™em
,

296 
block_group
, 64);

297 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_Æšk
, 
bŒfs_šode_™em
, 
Æšk
, 32);

298 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_uid
, 
bŒfs_šode_™em
, 
uid
, 32);

299 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_gid
, 
bŒfs_šode_™em
, 
gid
, 32);

300 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_mode
, 
bŒfs_šode_™em
, 
mode
, 32);

301 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_rdev
, 
bŒfs_šode_™em
, 
rdev
, 64);

302 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_æags
, 
bŒfs_šode_™em
, 
æags
, 64);

303 
BTRFS_SETGET_FUNCS
(
time¥ec_£c
, 
bŒfs_time¥ec
, 
£c
, 64);

304 
BTRFS_SETGET_FUNCS
(
time¥ec_n£c
, 
bŒfs_time¥ec
, 
n£c
, 32);

305 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_time¥ec_£c
, 
bŒfs_time¥ec
, 
£c
, 64);

306 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_time¥ec_n£c
, 
bŒfs_time¥ec
, 
n£c
, 32);

309 
BTRFS_SETGET_FUNCS
(
dev_ex‹Á_chunk_Œ“
, 
bŒfs_dev_ex‹Á
, 
chunk_Œ“
, 64);

310 
BTRFS_SETGET_FUNCS
(
dev_ex‹Á_chunk_objeùid
, 
bŒfs_dev_ex‹Á
,

311 
chunk_objeùid
, 64);

312 
BTRFS_SETGET_FUNCS
(
dev_ex‹Á_chunk_off£t
, 
bŒfs_dev_ex‹Á
,

313 
chunk_off£t
, 64);

314 
BTRFS_SETGET_FUNCS
(
dev_ex‹Á_Ëngth
, 
bŒfs_dev_ex‹Á
, 
Ëngth
, 64);

315 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_ex‹Á_chunk_Œ“
, 
bŒfs_dev_ex‹Á
,

316 
chunk_Œ“
, 64);

317 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_ex‹Á_chunk_objeùid
, 
bŒfs_dev_ex‹Á
,

318 
chunk_objeùid
, 64);

319 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_ex‹Á_chunk_off£t
, 
bŒfs_dev_ex‹Á
,

320 
chunk_off£t
, 64);

321 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_ex‹Á_Ëngth
, 
bŒfs_dev_ex‹Á
, 
Ëngth
, 64);

323 
BTRFS_SETGET_FUNCS
(
ex‹Á_»fs
, 
bŒfs_ex‹Á_™em
, 
»fs
, 64);

324 
BTRFS_SETGET_FUNCS
(
ex‹Á_g’”©iÚ
, 
bŒfs_ex‹Á_™em
, 
g’”©iÚ
, 64);

325 
BTRFS_SETGET_FUNCS
(
ex‹Á_æags
, 
bŒfs_ex‹Á_™em
, 
æags
, 64);

327 
BTRFS_SETGET_FUNCS
(
Œ“_block_Ëv–
, 
bŒfs_Œ“_block_šfo
, 
Ëv–
, 8);

329 
šlše
 
	$bŒfs_Œ“_block_key
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

330 
bŒfs_Œ“_block_šfo
 *
™em
,

331 
bŒfs_disk_key
 *
key
)

333 
	`»ad_eb_memb”
(
eb
, 
™em
, 
bŒfs_Œ“_block_šfo
, 
key
, key);

334 
	}
}

336 
šlše
 
	$bŒfs_£t_Œ“_block_key
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

337 
bŒfs_Œ“_block_šfo
 *
™em
,

338 
bŒfs_disk_key
 *
key
)

340 
	`wr™e_eb_memb”
(
eb
, 
™em
, 
bŒfs_Œ“_block_šfo
, 
key
, key);

341 
	}
}

343 
BTRFS_SETGET_FUNCS
(
ex‹Á_d©a_»f_roÙ
, 
bŒfs_ex‹Á_d©a_»f
, 
roÙ
, 64);

344 
BTRFS_SETGET_FUNCS
(
ex‹Á_d©a_»f_objeùid
, 
bŒfs_ex‹Á_d©a_»f
,

345 
objeùid
, 64);

346 
BTRFS_SETGET_FUNCS
(
ex‹Á_d©a_»f_off£t
, 
bŒfs_ex‹Á_d©a_»f
,

347 
off£t
, 64);

348 
BTRFS_SETGET_FUNCS
(
ex‹Á_d©a_»f_couÁ
, 
bŒfs_ex‹Á_d©a_»f
, 
couÁ
, 32);

350 
BTRFS_SETGET_FUNCS
(
sh¬ed_d©a_»f_couÁ
, 
bŒfs_sh¬ed_d©a_»f
, 
couÁ
, 32);

352 
BTRFS_SETGET_FUNCS
(
ex‹Á_šlše_»f_ty³
, 
bŒfs_ex‹Á_šlše_»f
,

353 
ty³
, 8);

354 
BTRFS_SETGET_FUNCS
(
ex‹Á_šlše_»f_off£t
, 
bŒfs_ex‹Á_šlše_»f
,

355 
off£t
, 64);

357 
šlše
 
u32
 
	$bŒfs_ex‹Á_šlše_»f_size
(
ty³
)

359 ià(
ty³
 =ğ
BTRFS_TREE_BLOCK_REF_KEY
 ||

360 
ty³
 =ğ
BTRFS_SHARED_BLOCK_REF_KEY
)

361  (
bŒfs_ex‹Á_šlše_»f
);

362 ià(
ty³
 =ğ
BTRFS_SHARED_DATA_REF_KEY
)

363  (
bŒfs_sh¬ed_d©a_»f
) +

364 (
bŒfs_ex‹Á_šlše_»f
);

365 ià(
ty³
 =ğ
BTRFS_EXTENT_DATA_REF_KEY
)

366  (
bŒfs_ex‹Á_d©a_»f
) +

367 
	`off£tof
(
bŒfs_ex‹Á_šlše_»f
, 
off£t
);

369 
	}
}

372 
BTRFS_SETGET_FUNCS
(
key_block±r
, 
bŒfs_key_±r
, 
block±r
, 64);

373 
BTRFS_SETGET_FUNCS
(
key_g’”©iÚ
, 
bŒfs_key_±r
, 
g’”©iÚ
, 64);

374 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_key_block±r
, 
bŒfs_key_±r
, 
block±r
, 64);

375 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_key_g’”©iÚ
, 
bŒfs_key_±r
,

376 
g’”©iÚ
, 64);

378 
šlše
 
u64
 
	$bŒfs_node_block±r
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
Ä
)

380 
±r
;

382 
±r
 = 
	`off£tof
(
bŒfs_node
, 
±rs
) +

383 (
bŒfs_key_±r
è* 
Ä
;

384  
	`bŒfs_key_block±r
(
eb
, (
bŒfs_key_±r
 *)
±r
);

385 
	}
}

387 
šlše
 
	$bŒfs_£t_node_block±r
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

388 
Ä
, 
u64
 
v®
)

390 
±r
;

392 
±r
 = 
	`off£tof
(
bŒfs_node
, 
±rs
) +

393 (
bŒfs_key_±r
è* 
Ä
;

394 
	`bŒfs_£t_key_block±r
(
eb
, (
bŒfs_key_±r
 *)
±r
, 
v®
);

395 
	}
}

397 
šlše
 
u64
 
	$bŒfs_node_±r_g’”©iÚ
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
Ä
)

399 
±r
;

401 
±r
 = 
	`off£tof
(
bŒfs_node
, 
±rs
) +

402 (
bŒfs_key_±r
è* 
Ä
;

403  
	`bŒfs_key_g’”©iÚ
(
eb
, (
bŒfs_key_±r
 *)
±r
);

404 
	}
}

406 
šlše
 
	$bŒfs_£t_node_±r_g’”©iÚ
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

407 
Ä
, 
u64
 
v®
)

409 
±r
;

411 
±r
 = 
	`off£tof
(
bŒfs_node
, 
±rs
) +

412 (
bŒfs_key_±r
è* 
Ä
;

413 
	`bŒfs_£t_key_g’”©iÚ
(
eb
, (
bŒfs_key_±r
 *)
±r
, 
v®
);

414 
	}
}

416 
šlše
 
	$bŒfs_node_key_±r_off£t
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
Ä
)

418  
	`off£tof
(
bŒfs_node
, 
±rs
) +

419 (
bŒfs_key_±r
è* 
Ä
;

420 
	}
}

422 
bŒfs_node_key
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

423 
bŒfs_disk_key
 *
disk_key
, 
Ä
);

425 
šlše
 
	$bŒfs_£t_node_key
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

426 
bŒfs_disk_key
 *
disk_key
, 
Ä
)

428 
±r
;

430 
±r
 = 
	`bŒfs_node_key_±r_off£t
(
eb
, 
Ä
);

431 
	`wr™e_eb_memb”
(
eb
, (
bŒfs_key_±r
 *)
±r
,

432 
bŒfs_key_±r
, 
key
, 
disk_key
);

433 
	}
}

436 
BTRFS_SETGET_FUNCS
(
¿w_™em_off£t
, 
bŒfs_™em
, 
off£t
, 32);

437 
BTRFS_SETGET_FUNCS
(
¿w_™em_size
, 
bŒfs_™em
, 
size
, 32);

438 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_™em_off£t
, 
bŒfs_™em
, 
off£t
, 32);

439 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_™em_size
, 
bŒfs_™em
, 
size
, 32);

441 
šlše
 
	$bŒfs_™em_Ä_off£t
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
Ä
)

443  
	`off£tof
(
bŒfs_Ëaf
, 
™ems
) +

444 (
bŒfs_™em
è* 
Ä
;

445 
	}
}

447 
šlše
 
bŒfs_™em
 *
	$bŒfs_™em_Ä
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
Ä
)

449  (
bŒfs_™em
 *)
	`bŒfs_™em_Ä_off£t
(
eb
, 
Ä
);

450 
	}
}

452 
	#BTRFS_ITEM_SETGET_FUNCS
(
memb”
) \

453 
šlše
 
u32
 
bŒfs_™em_
##
	`memb”
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
¦Ù
) \

455  
bŒfs_¿w_™em_
##
	`memb”
(
eb
, 
	`bŒfs_™em_Ä
Ób, 
¦Ù
)); \

457 
šlše
 
bŒfs_£t_™em_
##
	`memb”
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, \

458 
¦Ù
, 
u32
 
v®
) \

460 
bŒfs_£t_¿w_™em_
##
	`memb”
(
eb
, 
	`bŒfs_™em_Ä
Ób, 
¦Ù
), 
v®
); \

462 
šlše
 
u32
 
bŒfs_tok’_™em_
##
	`memb”
(
bŒfs_m­_tok’
 *
tok’
, \

463 
¦Ù
) \

465 
bŒfs_™em
 *
™em
 = 
	`bŒfs_™em_Ä
(
tok’
->
eb
, 
¦Ù
); \

466  
bŒfs_tok’_¿w_™em_
##
	`memb”
(
tok’
, 
™em
); \

468 
šlše
 
bŒfs_£t_tok’_™em_
##
	`memb”
(
bŒfs_m­_tok’
 *
tok’
, \

469 
¦Ù
, 
u32
 
v®
) \

471 
bŒfs_™em
 *
™em
 = 
	`bŒfs_™em_Ä
(
tok’
->
eb
, 
¦Ù
); \

472 
bŒfs_£t_tok’_¿w_™em_
##
	`memb”
(
tok’
, 
™em
, 
v®
); \

473 }

	)

475 
	$BTRFS_ITEM_SETGET_FUNCS
(
off£t
)

476 
	`BTRFS_ITEM_SETGET_FUNCS
(
size
);

478 
šlše
 
u32
 
	$bŒfs_™em_d©a_’d
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
Ä
)

480  
	`bŒfs_™em_off£t
(
eb
, 
Ä
è+ 
	`bŒfs_™em_size
(eb,‚r);

481 
	}
}

483 
šlše
 
	$bŒfs_™em_key
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

484 
bŒfs_disk_key
 *
disk_key
, 
Ä
)

486 
bŒfs_™em
 *
™em
 = 
	`bŒfs_™em_Ä
(
eb
, 
Ä
);

488 
	`»ad_eb_memb”
(
eb
, 
™em
, 
bŒfs_™em
, 
key
, 
disk_key
);

489 
	}
}

491 
šlše
 
	$bŒfs_£t_™em_key
(
ex‹Á_bufãr
 *
eb
,

492 
bŒfs_disk_key
 *
disk_key
, 
Ä
)

494 
bŒfs_™em
 *
™em
 = 
	`bŒfs_™em_Ä
(
eb
, 
Ä
);

496 
	`wr™e_eb_memb”
(
eb
, 
™em
, 
bŒfs_™em
, 
key
, 
disk_key
);

497 
	}
}

499 
BTRFS_SETGET_FUNCS
(
dœ_log_’d
, 
bŒfs_dœ_log_™em
, 
’d
, 64);

502 
BTRFS_SETGET_FUNCS
(
roÙ_»f_dœid
, 
bŒfs_roÙ_»f
, 
dœid
, 64);

503 
BTRFS_SETGET_FUNCS
(
roÙ_»f_£qu’û
, 
bŒfs_roÙ_»f
, 
£qu’û
, 64);

504 
BTRFS_SETGET_FUNCS
(
roÙ_»f_Çme_Ën
, 
bŒfs_roÙ_»f
, 
Çme_Ën
, 16);

505 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_roÙ_»f_dœid
, 
bŒfs_roÙ_»f
, 
dœid
, 64);

506 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_roÙ_»f_£qu’û
, 
bŒfs_roÙ_»f
, 
£qu’û
, 64);

507 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_roÙ_»f_Çme_Ën
, 
bŒfs_roÙ_»f
, 
Çme_Ën
, 16);

510 
BTRFS_SETGET_FUNCS
(
dœ_d©a_Ën
, 
bŒfs_dœ_™em
, 
d©a_Ën
, 16);

511 
BTRFS_SETGET_FUNCS
(
dœ_æags
, 
bŒfs_dœ_™em
, 
ty³
, 8);

512 
BTRFS_SETGET_FUNCS
(
dœ_Çme_Ën
, 
bŒfs_dœ_™em
, 
Çme_Ën
, 16);

513 
BTRFS_SETGET_FUNCS
(
dœ_Œªsid
, 
bŒfs_dœ_™em
, 
Œªsid
, 64);

514 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dœ_æags
, 
bŒfs_dœ_™em
, 
ty³
, 8);

515 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dœ_d©a_Ën
, 
bŒfs_dœ_™em
, 
d©a_Ën
, 16);

516 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dœ_Çme_Ën
, 
bŒfs_dœ_™em
, 
Çme_Ën
, 16);

517 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dœ_Œªsid
, 
bŒfs_dœ_™em
, 
Œªsid
, 64);

519 
šlše
 
u8
 
	$bŒfs_dœ_áy³
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

520 cÚ¡ 
bŒfs_dœ_™em
 *
™em
)

522  
	`bŒfs_dœ_æags_to_áy³
(
	`bŒfs_dœ_æags
(
eb
, 
™em
));

523 
	}
}

525 
šlše
 
u8
 
	$bŒfs_¡ack_dœ_áy³
(cÚ¡ 
bŒfs_dœ_™em
 *
™em
)

527  
	`bŒfs_dœ_æags_to_áy³
(
	`bŒfs_¡ack_dœ_æags
(
™em
));

528 
	}
}

530 
šlše
 
	$bŒfs_dœ_™em_key
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

531 cÚ¡ 
bŒfs_dœ_™em
 *
™em
,

532 
bŒfs_disk_key
 *
key
)

534 
	`»ad_eb_memb”
(
eb
, 
™em
, 
bŒfs_dœ_™em
, 
loÿtiÚ
, 
key
);

535 
	}
}

537 
šlše
 
	$bŒfs_£t_dœ_™em_key
(
ex‹Á_bufãr
 *
eb
,

538 
bŒfs_dœ_™em
 *
™em
,

539 cÚ¡ 
bŒfs_disk_key
 *
key
)

541 
	`wr™e_eb_memb”
(
eb
, 
™em
, 
bŒfs_dœ_™em
, 
loÿtiÚ
, 
key
);

542 
	}
}

544 
BTRFS_SETGET_FUNCS
(
ä“_¥aû_’Œ›s
, 
bŒfs_ä“_¥aû_h—d”
,

545 
num_’Œ›s
, 64);

546 
BTRFS_SETGET_FUNCS
(
ä“_¥aû_b™m­s
, 
bŒfs_ä“_¥aû_h—d”
,

547 
num_b™m­s
, 64);

548 
BTRFS_SETGET_FUNCS
(
ä“_¥aû_g’”©iÚ
, 
bŒfs_ä“_¥aû_h—d”
,

549 
g’”©iÚ
, 64);

551 
šlše
 
	$bŒfs_ä“_¥aû_key
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

552 cÚ¡ 
bŒfs_ä“_¥aû_h—d”
 *
h
,

553 
bŒfs_disk_key
 *
key
)

555 
	`»ad_eb_memb”
(
eb
, 
h
, 
bŒfs_ä“_¥aû_h—d”
, 
loÿtiÚ
, 
key
);

556 
	}
}

558 
šlše
 
	$bŒfs_£t_ä“_¥aû_key
(
ex‹Á_bufãr
 *
eb
,

559 
bŒfs_ä“_¥aû_h—d”
 *
h
,

560 cÚ¡ 
bŒfs_disk_key
 *
key
)

562 
	`wr™e_eb_memb”
(
eb
, 
h
, 
bŒfs_ä“_¥aû_h—d”
, 
loÿtiÚ
, 
key
);

563 
	}
}

566 
BTRFS_SETGET_STACK_FUNCS
(
disk_key_objeùid
, 
bŒfs_disk_key
, 
objeùid
, 64);

567 
BTRFS_SETGET_STACK_FUNCS
(
disk_key_off£t
, 
bŒfs_disk_key
, 
off£t
, 64);

568 
BTRFS_SETGET_STACK_FUNCS
(
disk_key_ty³
, 
bŒfs_disk_key
, 
ty³
, 8);

570 #ifdeà
__LITTLE_ENDIAN


577 
šlše
 
	$bŒfs_disk_key_to_ıu
(
bŒfs_key
 *
ıu_key
,

578 cÚ¡ 
bŒfs_disk_key
 *
disk_key
)

580 
	`memıy
(
ıu_key
, 
disk_key
, (
bŒfs_key
));

581 
	}
}

583 
šlše
 
	$bŒfs_ıu_key_to_disk
(
bŒfs_disk_key
 *
disk_key
,

584 cÚ¡ 
bŒfs_key
 *
ıu_key
)

586 
	`memıy
(
disk_key
, 
ıu_key
, (
bŒfs_key
));

587 
	}
}

589 
šlše
 
	$bŒfs_node_key_to_ıu
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

590 
bŒfs_key
 *
ıu_key
, 
Ä
)

592 
bŒfs_disk_key
 *
disk_key
 = (bŒfs_disk_key *)
ıu_key
;

594 
	`bŒfs_node_key
(
eb
, 
disk_key
, 
Ä
);

595 
	}
}

597 
šlše
 
	$bŒfs_™em_key_to_ıu
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

598 
bŒfs_key
 *
ıu_key
, 
Ä
)

600 
bŒfs_disk_key
 *
disk_key
 = (bŒfs_disk_key *)
ıu_key
;

602 
	`bŒfs_™em_key
(
eb
, 
disk_key
, 
Ä
);

603 
	}
}

605 
šlše
 
	$bŒfs_dœ_™em_key_to_ıu
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

606 cÚ¡ 
bŒfs_dœ_™em
 *
™em
,

607 
bŒfs_key
 *
ıu_key
)

609 
bŒfs_disk_key
 *
disk_key
 = (bŒfs_disk_key *)
ıu_key
;

611 
	`bŒfs_dœ_™em_key
(
eb
, 
™em
, 
disk_key
);

612 
	}
}

616 
šlše
 
	$bŒfs_disk_key_to_ıu
(
bŒfs_key
 *
ıu
,

617 cÚ¡ 
bŒfs_disk_key
 *
disk
)

619 
ıu
->
off£t
 = 
	`Ë64_to_ıu
(
disk
->offset);

620 
ıu
->
ty³
 = 
disk
->type;

621 
ıu
->
objeùid
 = 
	`Ë64_to_ıu
(
disk
->objectid);

622 
	}
}

624 
šlše
 
	$bŒfs_ıu_key_to_disk
(
bŒfs_disk_key
 *
disk
,

625 cÚ¡ 
bŒfs_key
 *
ıu
)

627 
disk
->
off£t
 = 
	`ıu_to_Ë64
(
ıu
->offset);

628 
disk
->
ty³
 = 
ıu
->type;

629 
disk
->
objeùid
 = 
	`ıu_to_Ë64
(
ıu
->objectid);

630 
	}
}

632 
šlše
 
	$bŒfs_node_key_to_ıu
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

633 
bŒfs_key
 *
key
, 
Ä
)

635 
bŒfs_disk_key
 
disk_key
;

637 
	`bŒfs_node_key
(
eb
, &
disk_key
, 
Ä
);

638 
	`bŒfs_disk_key_to_ıu
(
key
, &
disk_key
);

639 
	}
}

641 
šlše
 
	$bŒfs_™em_key_to_ıu
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

642 
bŒfs_key
 *
key
, 
Ä
)

644 
bŒfs_disk_key
 
disk_key
;

646 
	`bŒfs_™em_key
(
eb
, &
disk_key
, 
Ä
);

647 
	`bŒfs_disk_key_to_ıu
(
key
, &
disk_key
);

648 
	}
}

650 
šlše
 
	$bŒfs_dœ_™em_key_to_ıu
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

651 cÚ¡ 
bŒfs_dœ_™em
 *
™em
,

652 
bŒfs_key
 *
key
)

654 
bŒfs_disk_key
 
disk_key
;

656 
	`bŒfs_dœ_™em_key
(
eb
, 
™em
, &
disk_key
);

657 
	`bŒfs_disk_key_to_ıu
(
key
, &
disk_key
);

658 
	}
}

663 
BTRFS_SETGET_HEADER_FUNCS
(
h—d”_by‹Ä
, 
bŒfs_h—d”
, 
by‹Ä
, 64);

664 
BTRFS_SETGET_HEADER_FUNCS
(
h—d”_g’”©iÚ
, 
bŒfs_h—d”
, 
g’”©iÚ
, 64);

665 
BTRFS_SETGET_HEADER_FUNCS
(
h—d”_owÃr
, 
bŒfs_h—d”
, 
owÃr
, 64);

666 
BTRFS_SETGET_HEADER_FUNCS
(
h—d”_Ä™ems
, 
bŒfs_h—d”
, 
Ä™ems
, 32);

667 
BTRFS_SETGET_HEADER_FUNCS
(
h—d”_æags
, 
bŒfs_h—d”
, 
æags
, 64);

668 
BTRFS_SETGET_HEADER_FUNCS
(
h—d”_Ëv–
, 
bŒfs_h—d”
, 
Ëv–
, 8);

669 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_h—d”_g’”©iÚ
, 
bŒfs_h—d”
,

670 
g’”©iÚ
, 64);

671 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_h—d”_owÃr
, 
bŒfs_h—d”
, 
owÃr
, 64);

672 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_h—d”_Ä™ems
, 
bŒfs_h—d”
, 
Ä™ems
, 32);

673 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_h—d”_by‹Ä
, 
bŒfs_h—d”
, 
by‹Ä
, 64);

675 
šlše
 
	$bŒfs_h—d”_æag
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
u64
 
æag
)

677  (
	`bŒfs_h—d”_æags
(
eb
è& 
æag
) == flag;

678 
	}
}

680 
šlše
 
	$bŒfs_£t_h—d”_æag
(
ex‹Á_bufãr
 *
eb
, 
u64
 
æag
)

682 
u64
 
æags
 = 
	`bŒfs_h—d”_æags
(
eb
);

684 
	`bŒfs_£t_h—d”_æags
(
eb
, 
æags
 | 
æag
);

685 
	}
}

687 
šlše
 
	$bŒfs_ş—r_h—d”_æag
(
ex‹Á_bufãr
 *
eb
, 
u64
 
æag
)

689 
u64
 
æags
 = 
	`bŒfs_h—d”_æags
(
eb
);

691 
	`bŒfs_£t_h—d”_æags
(
eb
, 
æags
 & ~
æag
);

692 
	}
}

694 
šlše
 
	$bŒfs_h—d”_back»f_»v
(cÚ¡ 
ex‹Á_bufãr
 *
eb
)

696 
u64
 
æags
 = 
	`bŒfs_h—d”_æags
(
eb
);

698  
æags
 >> 
BTRFS_BACKREF_REV_SHIFT
;

699 
	}
}

701 
šlše
 
	$bŒfs_£t_h—d”_back»f_»v
(
ex‹Á_bufãr
 *
eb
, 
»v
)

703 
u64
 
æags
 = 
	`bŒfs_h—d”_æags
(
eb
);

705 
æags
 &ğ~
BTRFS_BACKREF_REV_MASK
;

706 
æags
 |ğ(
u64
)
»v
 << 
BTRFS_BACKREF_REV_SHIFT
;

707 
	`bŒfs_£t_h—d”_æags
(
eb
, 
æags
);

708 
	}
}

710 
šlše
 
	$bŒfs_is_Ëaf
(cÚ¡ 
ex‹Á_bufãr
 *
eb
)

712  
	`bŒfs_h—d”_Ëv–
(
eb
) == 0;

713 
	}
}

716 
BTRFS_SETGET_FUNCS
(
disk_roÙ_g’”©iÚ
, 
bŒfs_roÙ_™em
, 
g’”©iÚ
, 64);

717 
BTRFS_SETGET_FUNCS
(
disk_roÙ_»fs
, 
bŒfs_roÙ_™em
, 
»fs
, 32);

718 
BTRFS_SETGET_FUNCS
(
disk_roÙ_by‹Ä
, 
bŒfs_roÙ_™em
, 
by‹Ä
, 64);

719 
BTRFS_SETGET_FUNCS
(
disk_roÙ_Ëv–
, 
bŒfs_roÙ_™em
, 
Ëv–
, 8);

721 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_g’”©iÚ
, 
bŒfs_roÙ_™em
, 
g’”©iÚ
, 64);

722 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_by‹Ä
, 
bŒfs_roÙ_™em
, 
by‹Ä
, 64);

723 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_drİ_Ëv–
, 
bŒfs_roÙ_™em
, 
drİ_Ëv–
, 8);

724 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_Ëv–
, 
bŒfs_roÙ_™em
, 
Ëv–
, 8);

725 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_dœid
, 
bŒfs_roÙ_™em
,„oot_dirid, 64);

726 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_»fs
, 
bŒfs_roÙ_™em
, 
»fs
, 32);

727 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_æags
, 
bŒfs_roÙ_™em
, 
æags
, 64);

728 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_u£d
, 
bŒfs_roÙ_™em
, 
by‹s_u£d
, 64);

729 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_lim™
, 
bŒfs_roÙ_™em
, 
by‹_lim™
, 64);

730 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_Ï¡_¢­shÙ
, 
bŒfs_roÙ_™em
,

731 
Ï¡_¢­shÙ
, 64);

732 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_g’”©iÚ_v2
, 
bŒfs_roÙ_™em
,

733 
g’”©iÚ_v2
, 64);

734 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_ù¿nsid
, 
bŒfs_roÙ_™em
, 
ù¿nsid
, 64);

735 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_Ù¿nsid
, 
bŒfs_roÙ_™em
, 
Ù¿nsid
, 64);

736 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_¡¿nsid
, 
bŒfs_roÙ_™em
, 
¡¿nsid
, 64);

737 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_¹¿nsid
, 
bŒfs_roÙ_™em
, 
¹¿nsid
, 64);

740 
BTRFS_SETGET_STACK_FUNCS
(
backup_Œ“_roÙ
, 
bŒfs_roÙ_backup
,

741 
Œ“_roÙ
, 64);

742 
BTRFS_SETGET_STACK_FUNCS
(
backup_Œ“_roÙ_g’
, 
bŒfs_roÙ_backup
,

743 
Œ“_roÙ_g’
, 64);

744 
BTRFS_SETGET_STACK_FUNCS
(
backup_Œ“_roÙ_Ëv–
, 
bŒfs_roÙ_backup
,

745 
Œ“_roÙ_Ëv–
, 8);

747 
BTRFS_SETGET_STACK_FUNCS
(
backup_chunk_roÙ
, 
bŒfs_roÙ_backup
,

748 
chunk_roÙ
, 64);

749 
BTRFS_SETGET_STACK_FUNCS
(
backup_chunk_roÙ_g’
, 
bŒfs_roÙ_backup
,

750 
chunk_roÙ_g’
, 64);

751 
BTRFS_SETGET_STACK_FUNCS
(
backup_chunk_roÙ_Ëv–
, 
bŒfs_roÙ_backup
,

752 
chunk_roÙ_Ëv–
, 8);

754 
BTRFS_SETGET_STACK_FUNCS
(
backup_ex‹Á_roÙ
, 
bŒfs_roÙ_backup
,

755 
ex‹Á_roÙ
, 64);

756 
BTRFS_SETGET_STACK_FUNCS
(
backup_ex‹Á_roÙ_g’
, 
bŒfs_roÙ_backup
,

757 
ex‹Á_roÙ_g’
, 64);

758 
BTRFS_SETGET_STACK_FUNCS
(
backup_ex‹Á_roÙ_Ëv–
, 
bŒfs_roÙ_backup
,

759 
ex‹Á_roÙ_Ëv–
, 8);

761 
BTRFS_SETGET_STACK_FUNCS
(
backup_fs_roÙ
, 
bŒfs_roÙ_backup
,

762 
fs_roÙ
, 64);

763 
BTRFS_SETGET_STACK_FUNCS
(
backup_fs_roÙ_g’
, 
bŒfs_roÙ_backup
,

764 
fs_roÙ_g’
, 64);

765 
BTRFS_SETGET_STACK_FUNCS
(
backup_fs_roÙ_Ëv–
, 
bŒfs_roÙ_backup
,

766 
fs_roÙ_Ëv–
, 8);

768 
BTRFS_SETGET_STACK_FUNCS
(
backup_dev_roÙ
, 
bŒfs_roÙ_backup
,

769 
dev_roÙ
, 64);

770 
BTRFS_SETGET_STACK_FUNCS
(
backup_dev_roÙ_g’
, 
bŒfs_roÙ_backup
,

771 
dev_roÙ_g’
, 64);

772 
BTRFS_SETGET_STACK_FUNCS
(
backup_dev_roÙ_Ëv–
, 
bŒfs_roÙ_backup
,

773 
dev_roÙ_Ëv–
, 8);

775 
BTRFS_SETGET_STACK_FUNCS
(
backup_csum_roÙ
, 
bŒfs_roÙ_backup
,

776 
csum_roÙ
, 64);

777 
BTRFS_SETGET_STACK_FUNCS
(
backup_csum_roÙ_g’
, 
bŒfs_roÙ_backup
,

778 
csum_roÙ_g’
, 64);

779 
BTRFS_SETGET_STACK_FUNCS
(
backup_csum_roÙ_Ëv–
, 
bŒfs_roÙ_backup
,

780 
csum_roÙ_Ëv–
, 8);

781 
BTRFS_SETGET_STACK_FUNCS
(
backup_tÙ®_by‹s
, 
bŒfs_roÙ_backup
,

782 
tÙ®_by‹s
, 64);

783 
BTRFS_SETGET_STACK_FUNCS
(
backup_by‹s_u£d
, 
bŒfs_roÙ_backup
,

784 
by‹s_u£d
, 64);

785 
BTRFS_SETGET_STACK_FUNCS
(
backup_num_deviûs
, 
bŒfs_roÙ_backup
,

786 
num_deviûs
, 64);

789 
BTRFS_SETGET_FUNCS
(
b®ªû_æags
, 
bŒfs_b®ªû_™em
, 
æags
, 64);

791 
šlše
 
	$bŒfs_b®ªû_d©a
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

792 cÚ¡ 
bŒfs_b®ªû_™em
 *
bi
,

793 
bŒfs_disk_b®ªû_¬gs
 *
ba
)

795 
	`»ad_eb_memb”
(
eb
, 
bi
, 
bŒfs_b®ªû_™em
, 
d©a
, 
ba
);

796 
	}
}

798 
šlše
 
	$bŒfs_£t_b®ªû_d©a
(
ex‹Á_bufãr
 *
eb
,

799 
bŒfs_b®ªû_™em
 *
bi
,

800 cÚ¡ 
bŒfs_disk_b®ªû_¬gs
 *
ba
)

802 
	`wr™e_eb_memb”
(
eb
, 
bi
, 
bŒfs_b®ªû_™em
, 
d©a
, 
ba
);

803 
	}
}

805 
šlše
 
	$bŒfs_b®ªû_m‘a
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

806 cÚ¡ 
bŒfs_b®ªû_™em
 *
bi
,

807 
bŒfs_disk_b®ªû_¬gs
 *
ba
)

809 
	`»ad_eb_memb”
(
eb
, 
bi
, 
bŒfs_b®ªû_™em
, 
m‘a
, 
ba
);

810 
	}
}

812 
šlše
 
	$bŒfs_£t_b®ªû_m‘a
(
ex‹Á_bufãr
 *
eb
,

813 
bŒfs_b®ªû_™em
 *
bi
,

814 cÚ¡ 
bŒfs_disk_b®ªû_¬gs
 *
ba
)

816 
	`wr™e_eb_memb”
(
eb
, 
bi
, 
bŒfs_b®ªû_™em
, 
m‘a
, 
ba
);

817 
	}
}

819 
šlše
 
	$bŒfs_b®ªû_sys
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

820 cÚ¡ 
bŒfs_b®ªû_™em
 *
bi
,

821 
bŒfs_disk_b®ªû_¬gs
 *
ba
)

823 
	`»ad_eb_memb”
(
eb
, 
bi
, 
bŒfs_b®ªû_™em
, 
sys
, 
ba
);

824 
	}
}

826 
šlše
 
	$bŒfs_£t_b®ªû_sys
(
ex‹Á_bufãr
 *
eb
,

827 
bŒfs_b®ªû_™em
 *
bi
,

828 cÚ¡ 
bŒfs_disk_b®ªû_¬gs
 *
ba
)

830 
	`wr™e_eb_memb”
(
eb
, 
bi
, 
bŒfs_b®ªû_™em
, 
sys
, 
ba
);

831 
	}
}

833 
šlše
 
	$bŒfs_disk_b®ªû_¬gs_to_ıu
(
bŒfs_b®ªû_¬gs
 *
ıu
,

834 cÚ¡ 
bŒfs_disk_b®ªû_¬gs
 *
disk
)

836 
	`mem£t
(
ıu
, 0, (*cpu));

838 
ıu
->
´ofes
 = 
	`Ë64_to_ıu
(
disk
->profiles);

839 
ıu
->
u§ge
 = 
	`Ë64_to_ıu
(
disk
->usage);

840 
ıu
->
devid
 = 
	`Ë64_to_ıu
(
disk
->devid);

841 
ıu
->
p¡¬t
 = 
	`Ë64_to_ıu
(
disk
->pstart);

842 
ıu
->
³nd
 = 
	`Ë64_to_ıu
(
disk
->pend);

843 
ıu
->
v¡¬t
 = 
	`Ë64_to_ıu
(
disk
->vstart);

844 
ıu
->
v’d
 = 
	`Ë64_to_ıu
(
disk
->vend);

845 
ıu
->
rg‘
 = 
	`Ë64_to_ıu
(
disk
->target);

846 
ıu
->
æags
 = 
	`Ë64_to_ıu
(
disk
->flags);

847 
ıu
->
lim™
 = 
	`Ë64_to_ıu
(
disk
->limit);

848 
ıu
->
¡res_mš
 = 
	`Ë32_to_ıu
(
disk
->stripes_min);

849 
ıu
->
¡res_max
 = 
	`Ë32_to_ıu
(
disk
->stripes_max);

850 
	}
}

852 
šlše
 
	$bŒfs_ıu_b®ªû_¬gs_to_disk
(

853 
bŒfs_disk_b®ªû_¬gs
 *
disk
,

854 cÚ¡ 
bŒfs_b®ªû_¬gs
 *
ıu
)

856 
	`mem£t
(
disk
, 0, (*disk));

858 
disk
->
´ofes
 = 
	`ıu_to_Ë64
(
ıu
->profiles);

859 
disk
->
u§ge
 = 
	`ıu_to_Ë64
(
ıu
->usage);

860 
disk
->
devid
 = 
	`ıu_to_Ë64
(
ıu
->devid);

861 
disk
->
p¡¬t
 = 
	`ıu_to_Ë64
(
ıu
->pstart);

862 
disk
->
³nd
 = 
	`ıu_to_Ë64
(
ıu
->pend);

863 
disk
->
v¡¬t
 = 
	`ıu_to_Ë64
(
ıu
->vstart);

864 
disk
->
v’d
 = 
	`ıu_to_Ë64
(
ıu
->vend);

865 
disk
->
rg‘
 = 
	`ıu_to_Ë64
(
ıu
->target);

866 
disk
->
æags
 = 
	`ıu_to_Ë64
(
ıu
->flags);

867 
disk
->
lim™
 = 
	`ıu_to_Ë64
(
ıu
->limit);

868 
disk
->
¡res_mš
 = 
	`ıu_to_Ë32
(
ıu
->stripes_min);

869 
disk
->
¡res_max
 = 
	`ıu_to_Ë32
(
ıu
->stripes_max);

870 
	}
}

873 
BTRFS_SETGET_STACK_FUNCS
(
su³r_by‹Ä
, 
bŒfs_su³r_block
, 
by‹Ä
, 64);

874 
BTRFS_SETGET_STACK_FUNCS
(
su³r_æags
, 
bŒfs_su³r_block
, 
æags
, 64);

875 
BTRFS_SETGET_STACK_FUNCS
(
su³r_g’”©iÚ
, 
bŒfs_su³r_block
,

876 
g’”©iÚ
, 64);

877 
BTRFS_SETGET_STACK_FUNCS
(
su³r_roÙ
, 
bŒfs_su³r_block
, 
roÙ
, 64);

878 
BTRFS_SETGET_STACK_FUNCS
(
su³r_sys_¬¿y_size
,

879 
bŒfs_su³r_block
, 
sys_chunk_¬¿y_size
, 32);

880 
BTRFS_SETGET_STACK_FUNCS
(
su³r_chunk_roÙ_g’”©iÚ
,

881 
bŒfs_su³r_block
, 
chunk_roÙ_g’”©iÚ
, 64);

882 
BTRFS_SETGET_STACK_FUNCS
(
su³r_roÙ_Ëv–
, 
bŒfs_su³r_block
,

883 
roÙ_Ëv–
, 8);

884 
BTRFS_SETGET_STACK_FUNCS
(
su³r_chunk_roÙ
, 
bŒfs_su³r_block
,

885 
chunk_roÙ
, 64);

886 
BTRFS_SETGET_STACK_FUNCS
(
su³r_chunk_roÙ_Ëv–
, 
bŒfs_su³r_block
,

887 
chunk_roÙ_Ëv–
, 8);

888 
BTRFS_SETGET_STACK_FUNCS
(
su³r_log_roÙ
, 
bŒfs_su³r_block
, 
log_roÙ
, 64);

889 
BTRFS_SETGET_STACK_FUNCS
(
su³r_log_roÙ_Ëv–
, 
bŒfs_su³r_block
,

890 
log_roÙ_Ëv–
, 8);

891 
BTRFS_SETGET_STACK_FUNCS
(
su³r_tÙ®_by‹s
, 
bŒfs_su³r_block
,

892 
tÙ®_by‹s
, 64);

893 
BTRFS_SETGET_STACK_FUNCS
(
su³r_by‹s_u£d
, 
bŒfs_su³r_block
,

894 
by‹s_u£d
, 64);

895 
BTRFS_SETGET_STACK_FUNCS
(
su³r_£ùÜsize
, 
bŒfs_su³r_block
,

896 
£ùÜsize
, 32);

897 
BTRFS_SETGET_STACK_FUNCS
(
su³r_nodesize
, 
bŒfs_su³r_block
,

898 
nodesize
, 32);

899 
BTRFS_SETGET_STACK_FUNCS
(
su³r_¡resize
, 
bŒfs_su³r_block
,

900 
¡resize
, 32);

901 
BTRFS_SETGET_STACK_FUNCS
(
su³r_roÙ_dœ
, 
bŒfs_su³r_block
,

902 
roÙ_dœ_objeùid
, 64);

903 
BTRFS_SETGET_STACK_FUNCS
(
su³r_num_deviûs
, 
bŒfs_su³r_block
,

904 
num_deviûs
, 64);

905 
BTRFS_SETGET_STACK_FUNCS
(
su³r_com·t_æags
, 
bŒfs_su³r_block
,

906 
com·t_æags
, 64);

907 
BTRFS_SETGET_STACK_FUNCS
(
su³r_com·t_ro_æags
, 
bŒfs_su³r_block
,

908 
com·t_ro_æags
, 64);

909 
BTRFS_SETGET_STACK_FUNCS
(
su³r_šcom·t_æags
, 
bŒfs_su³r_block
,

910 
šcom·t_æags
, 64);

911 
BTRFS_SETGET_STACK_FUNCS
(
su³r_csum_ty³
, 
bŒfs_su³r_block
,

912 
csum_ty³
, 16);

913 
BTRFS_SETGET_STACK_FUNCS
(
su³r_ÿche_g’”©iÚ
, 
bŒfs_su³r_block
,

914 
ÿche_g’”©iÚ
, 64);

915 
BTRFS_SETGET_STACK_FUNCS
(
su³r_magic
, 
bŒfs_su³r_block
, 
magic
, 64);

916 
BTRFS_SETGET_STACK_FUNCS
(
su³r_uuid_Œ“_g’”©iÚ
, 
bŒfs_su³r_block
,

917 
uuid_Œ“_g’”©iÚ
, 64);

918 
BTRFS_SETGET_STACK_FUNCS
(
su³r_Ä_glob®_roÙs
, 
bŒfs_su³r_block
,

919 
Ä_glob®_roÙs
, 64);

922 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_fe_ex‹Á_ty³
, 
bŒfs_fe_ex‹Á_™em
,

923 
ty³
, 8);

924 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_fe_ex‹Á_disk_by‹Ä
,

925 
bŒfs_fe_ex‹Á_™em
, 
disk_by‹Ä
, 64);

926 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_fe_ex‹Á_off£t
,

927 
bŒfs_fe_ex‹Á_™em
, 
off£t
, 64);

928 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_fe_ex‹Á_g’”©iÚ
,

929 
bŒfs_fe_ex‹Á_™em
, 
g’”©iÚ
, 64);

930 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_fe_ex‹Á_num_by‹s
,

931 
bŒfs_fe_ex‹Á_™em
, 
num_by‹s
, 64);

932 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_fe_ex‹Á_¿m_by‹s
,

933 
bŒfs_fe_ex‹Á_™em
, 
¿m_by‹s
, 64);

934 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_fe_ex‹Á_disk_num_by‹s
,

935 
bŒfs_fe_ex‹Á_™em
, 
disk_num_by‹s
, 64);

936 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_fe_ex‹Á_com´essiÚ
,

937 
bŒfs_fe_ex‹Á_™em
, 
com´essiÚ
, 8);

940 
BTRFS_SETGET_FUNCS
(
fe_ex‹Á_ty³
, 
bŒfs_fe_ex‹Á_™em
, 
ty³
, 8);

941 
BTRFS_SETGET_FUNCS
(
fe_ex‹Á_disk_by‹Ä
, 
bŒfs_fe_ex‹Á_™em
,

942 
disk_by‹Ä
, 64);

943 
BTRFS_SETGET_FUNCS
(
fe_ex‹Á_g’”©iÚ
, 
bŒfs_fe_ex‹Á_™em
,

944 
g’”©iÚ
, 64);

945 
BTRFS_SETGET_FUNCS
(
fe_ex‹Á_disk_num_by‹s
, 
bŒfs_fe_ex‹Á_™em
,

946 
disk_num_by‹s
, 64);

947 
BTRFS_SETGET_FUNCS
(
fe_ex‹Á_off£t
, 
bŒfs_fe_ex‹Á_™em
,

948 
off£t
, 64);

949 
BTRFS_SETGET_FUNCS
(
fe_ex‹Á_num_by‹s
, 
bŒfs_fe_ex‹Á_™em
,

950 
num_by‹s
, 64);

951 
BTRFS_SETGET_FUNCS
(
fe_ex‹Á_¿m_by‹s
, 
bŒfs_fe_ex‹Á_™em
,

952 
¿m_by‹s
, 64);

953 
BTRFS_SETGET_FUNCS
(
fe_ex‹Á_com´essiÚ
, 
bŒfs_fe_ex‹Á_™em
,

954 
com´essiÚ
, 8);

955 
BTRFS_SETGET_FUNCS
(
fe_ex‹Á_’üy±iÚ
, 
bŒfs_fe_ex‹Á_™em
,

956 
’üy±iÚ
, 8);

957 
BTRFS_SETGET_FUNCS
(
fe_ex‹Á_Ùh”_’codšg
, 
bŒfs_fe_ex‹Á_™em
,

958 
Ùh”_’codšg
, 16);

961 
BTRFS_SETGET_FUNCS
(
qgroup_¡©us_g’”©iÚ
, 
bŒfs_qgroup_¡©us_™em
,

962 
g’”©iÚ
, 64);

963 
BTRFS_SETGET_FUNCS
(
qgroup_¡©us_v”siÚ
, 
bŒfs_qgroup_¡©us_™em
,

964 
v”siÚ
, 64);

965 
BTRFS_SETGET_FUNCS
(
qgroup_¡©us_æags
, 
bŒfs_qgroup_¡©us_™em
,

966 
æags
, 64);

967 
BTRFS_SETGET_FUNCS
(
qgroup_¡©us_»sÿn
, 
bŒfs_qgroup_¡©us_™em
,

968 
»sÿn
, 64);

971 
BTRFS_SETGET_FUNCS
(
qgroup_šfo_g’”©iÚ
, 
bŒfs_qgroup_šfo_™em
,

972 
g’”©iÚ
, 64);

973 
BTRFS_SETGET_FUNCS
(
qgroup_šfo_rãr
, 
bŒfs_qgroup_šfo_™em
, 
rãr
, 64);

974 
BTRFS_SETGET_FUNCS
(
qgroup_šfo_rãr_cm´
, 
bŒfs_qgroup_šfo_™em
,

975 
rãr_cm´
, 64);

976 
BTRFS_SETGET_FUNCS
(
qgroup_šfo_exş
, 
bŒfs_qgroup_šfo_™em
, 
exş
, 64);

977 
BTRFS_SETGET_FUNCS
(
qgroup_šfo_exş_cm´
, 
bŒfs_qgroup_šfo_™em
,

978 
exş_cm´
, 64);

980 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_qgroup_šfo_g’”©iÚ
,

981 
bŒfs_qgroup_šfo_™em
, 
g’”©iÚ
, 64);

982 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_qgroup_šfo_rãr
, 
bŒfs_qgroup_šfo_™em
,

983 
rãr
, 64);

984 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_qgroup_šfo_rãr_cm´
,

985 
bŒfs_qgroup_šfo_™em
, 
rãr_cm´
, 64);

986 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_qgroup_šfo_exş
, 
bŒfs_qgroup_šfo_™em
,

987 
exş
, 64);

988 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_qgroup_šfo_exş_cm´
,

989 
bŒfs_qgroup_šfo_™em
, 
exş_cm´
, 64);

992 
BTRFS_SETGET_FUNCS
(
qgroup_lim™_æags
, 
bŒfs_qgroup_lim™_™em
, 
æags
, 64);

993 
BTRFS_SETGET_FUNCS
(
qgroup_lim™_max_rãr
, 
bŒfs_qgroup_lim™_™em
,

994 
max_rãr
, 64);

995 
BTRFS_SETGET_FUNCS
(
qgroup_lim™_max_exş
, 
bŒfs_qgroup_lim™_™em
,

996 
max_exş
, 64);

997 
BTRFS_SETGET_FUNCS
(
qgroup_lim™_rsv_rãr
, 
bŒfs_qgroup_lim™_™em
,

998 
rsv_rãr
, 64);

999 
BTRFS_SETGET_FUNCS
(
qgroup_lim™_rsv_exş
, 
bŒfs_qgroup_lim™_™em
,

1000 
rsv_exş
, 64);

1001 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_qgroup_lim™_æags
,

1002 
bŒfs_qgroup_lim™_™em
, 
æags
, 64);

1003 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_qgroup_lim™_max_rãr
,

1004 
bŒfs_qgroup_lim™_™em
, 
max_rãr
, 64);

1005 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_qgroup_lim™_max_exş
,

1006 
bŒfs_qgroup_lim™_™em
, 
max_exş
, 64);

1007 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_qgroup_lim™_rsv_rãr
,

1008 
bŒfs_qgroup_lim™_™em
, 
rsv_rãr
, 64);

1009 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_qgroup_lim™_rsv_exş
,

1010 
bŒfs_qgroup_lim™_™em
, 
rsv_exş
, 64);

1013 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_¤c_devid
,

1014 
bŒfs_dev_»¶aû_™em
, 
¤c_devid
, 64);

1015 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_cÚt_»adšg_äom_¤cdev_mode
,

1016 
bŒfs_dev_»¶aû_™em
, 
cÚt_»adšg_äom_¤cdev_mode
,

1018 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_»¶aû_¡©e
, 
bŒfs_dev_»¶aû_™em
,

1019 
»¶aû_¡©e
, 64);

1020 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_time_¡¬‹d
, 
bŒfs_dev_»¶aû_™em
,

1021 
time_¡¬‹d
, 64);

1022 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_time_¡İ³d
, 
bŒfs_dev_»¶aû_™em
,

1023 
time_¡İ³d
, 64);

1024 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_num_wr™e_”rÜs
, 
bŒfs_dev_»¶aû_™em
,

1025 
num_wr™e_”rÜs
, 64);

1026 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_num_uncÜ»ùabË_»ad_”rÜs
,

1027 
bŒfs_dev_»¶aû_™em
, 
num_uncÜ»ùabË_»ad_”rÜs
,

1029 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_cursÜ_Ëá
, 
bŒfs_dev_»¶aû_™em
,

1030 
cursÜ_Ëá
, 64);

1031 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_cursÜ_right
, 
bŒfs_dev_»¶aû_™em
,

1032 
cursÜ_right
, 64);

1034 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_¤c_devid
,

1035 
bŒfs_dev_»¶aû_™em
, 
¤c_devid
, 64);

1036 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_cÚt_»adšg_äom_¤cdev_mode
,

1037 
bŒfs_dev_»¶aû_™em
,

1038 
cÚt_»adšg_äom_¤cdev_mode
, 64);

1039 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_»¶aû_¡©e
,

1040 
bŒfs_dev_»¶aû_™em
, 
»¶aû_¡©e
, 64);

1041 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_time_¡¬‹d
,

1042 
bŒfs_dev_»¶aû_™em
, 
time_¡¬‹d
, 64);

1043 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_time_¡İ³d
,

1044 
bŒfs_dev_»¶aû_™em
, 
time_¡İ³d
, 64);

1045 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_num_wr™e_”rÜs
,

1046 
bŒfs_dev_»¶aû_™em
, 
num_wr™e_”rÜs
, 64);

1047 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_num_uncÜ»ùabË_»ad_”rÜs
,

1048 
bŒfs_dev_»¶aû_™em
,

1049 
num_uncÜ»ùabË_»ad_”rÜs
, 64);

1050 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_cursÜ_Ëá
,

1051 
bŒfs_dev_»¶aû_™em
, 
cursÜ_Ëá
, 64);

1052 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_cursÜ_right
,

1053 
bŒfs_dev_»¶aû_™em
, 
cursÜ_right
, 64);

1056 
BTRFS_SETGET_FUNCS
(
v”™y_desütÜ_’üy±iÚ
, 
bŒfs_v”™y_desütÜ_™em
,

1057 
’üy±iÚ
, 8);

1058 
BTRFS_SETGET_FUNCS
(
v”™y_desütÜ_size
, 
bŒfs_v”™y_desütÜ_™em
,

1059 
size
, 64);

1060 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_v”™y_desütÜ_’üy±iÚ
,

1061 
bŒfs_v”™y_desütÜ_™em
, 
’üy±iÚ
, 8);

1062 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_v”™y_desütÜ_size
,

1063 
bŒfs_v”™y_desütÜ_™em
, 
size
, 64);

1066 
	#bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
ty³
) \

1067 ((
ty³
 *)(
	`bŒfs_™em_Ä_off£t
(
Ëaf
, 0è+ 
	`bŒfs_™em_off£t
Ö—f, 
¦Ù
)))

	)

1069 
	#bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
) \

1070 (()(
	`bŒfs_™em_Ä_off£t
(
Ëaf
, 0è+ 
	`bŒfs_™em_off£t
Ö—f, 
¦Ù
)))

	)

	@acl.c

6 
	~<lšux/fs.h
>

7 
	~<lšux/¡ršg.h
>

8 
	~<lšux/x©Œ.h
>

9 
	~<lšux/posix_aş_x©Œ.h
>

10 
	~<lšux/posix_aş.h
>

11 
	~<lšux/sched.h
>

12 
	~<lšux/sched/mm.h
>

13 
	~<lšux/¦ab.h
>

14 
	~"ù»e.h
"

15 
	~"bŒfs_šode.h
"

16 
	~"x©Œ.h
"

17 
	~"aş.h
"

19 
posix_aş
 *
	$bŒfs_g‘_aş
(
šode
 *šode, 
ty³
, 
boŞ
 
rcu
)

21 
size
;

22 cÚ¡ *
Çme
;

23 *
v®ue
 = 
NULL
;

24 
posix_aş
 *
aş
;

26 ià(
rcu
)

27  
	`ERR_PTR
(-
ECHILD
);

29 
ty³
) {

30 
ACL_TYPE_ACCESS
:

31 
Çme
 = 
XATTR_NAME_POSIX_ACL_ACCESS
;

33 
ACL_TYPE_DEFAULT
:

34 
Çme
 = 
XATTR_NAME_POSIX_ACL_DEFAULT
;

37  
	`ERR_PTR
(-
EINVAL
);

40 
size
 = 
	`bŒfs_g‘x©Œ
(
šode
, 
Çme
, 
NULL
, 0);

41 ià(
size
 > 0) {

42 
v®ue
 = 
	`kz®loc
(
size
, 
GFP_KERNEL
);

43 ià(!
v®ue
)

44  
	`ERR_PTR
(-
ENOMEM
);

45 
size
 = 
	`bŒfs_g‘x©Œ
(
šode
, 
Çme
, 
v®ue
, size);

47 ià(
size
 > 0)

48 
aş
 = 
	`posix_aş_äom_x©Œ
(&
š™_u£r_ns
, 
v®ue
, 
size
);

49 ià(
size
 =ğ-
ENODATA
 || size == 0)

50 
aş
 = 
NULL
;

52 
aş
 = 
	`ERR_PTR
(
size
);

53 
	`kä“
(
v®ue
);

55  
aş
;

56 
	}
}

58 
	$__bŒfs_£t_aş
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
šode
 *inode,

59 
posix_aş
 *
aş
, 
ty³
)

61 
»t
, 
size
 = 0;

62 cÚ¡ *
Çme
;

63 *
v®ue
 = 
NULL
;

65 
ty³
) {

66 
ACL_TYPE_ACCESS
:

67 
Çme
 = 
XATTR_NAME_POSIX_ACL_ACCESS
;

69 
ACL_TYPE_DEFAULT
:

70 ià(!
	`S_ISDIR
(
šode
->
i_mode
))

71  
aş
 ? -
EINVAL
 : 0;

72 
Çme
 = 
XATTR_NAME_POSIX_ACL_DEFAULT
;

75  -
EINVAL
;

78 ià(
aş
) {

79 
nofs_æag
;

81 
size
 = 
	`posix_aş_x©Œ_size
(
aş
->
a_couÁ
);

86 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

87 
v®ue
 = 
	`km®loc
(
size
, 
GFP_KERNEL
);

88 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

89 ià(!
v®ue
) {

90 
»t
 = -
ENOMEM
;

91 
out
;

94 
»t
 = 
	`posix_aş_to_x©Œ
(&
š™_u£r_ns
, 
aş
, 
v®ue
, 
size
);

95 ià(
»t
 < 0)

96 
out
;

99 ià(
Œªs
)

100 
»t
 = 
	`bŒfs_£tx©Œ
(
Œªs
, 
šode
, 
Çme
, 
v®ue
, 
size
, 0);

102 
»t
 = 
	`bŒfs_£tx©Œ_Œªs
(
šode
, 
Çme
, 
v®ue
, 
size
, 0);

104 
out
:

105 
	`kä“
(
v®ue
);

107 ià(!
»t
)

108 
	`£t_ÿched_aş
(
šode
, 
ty³
, 
aş
);

110  
»t
;

111 
	}
}

113 
	$bŒfs_£t_aş
(
mÁ_idm­
 *
idm­
, 
d’Œy
 *dentry,

114 
posix_aş
 *
aş
, 
ty³
)

116 
»t
;

117 
šode
 *šodğ
	`d_šode
(
d’Œy
);

118 
umode_t
 
Şd_mode
 = 
šode
->
i_mode
;

120 ià(
ty³
 =ğ
ACL_TYPE_ACCESS
 && 
aş
) {

121 
»t
 = 
	`posix_aş_upd©e_mode
(
idm­
, 
šode
,

122 &
šode
->
i_mode
, &
aş
);

123 ià(
»t
)

124  
»t
;

126 
»t
 = 
	`__bŒfs_£t_aş
(
NULL
, 
šode
, 
aş
, 
ty³
);

127 ià(
»t
)

128 
šode
->
i_mode
 = 
Şd_mode
;

129  
»t
;

130 
	}
}

	@acl.h

3 #iâdeà
BTRFS_ACL_H


4 
	#BTRFS_ACL_H


	)

6 #ifdeà
CONFIG_BTRFS_FS_POSIX_ACL


8 
posix_aş
 *
bŒfs_g‘_aş
(
šode
 *šode, 
ty³
, 
boŞ
 
rcu
);

9 
bŒfs_£t_aş
(
mÁ_idm­
 *
idm­
, 
d’Œy
 *dentry,

10 
posix_aş
 *
aş
, 
ty³
);

11 
__bŒfs_£t_aş
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
šode
 *inode,

12 
posix_aş
 *
aş
, 
ty³
);

16 
	#bŒfs_g‘_aş
 
NULL


	)

17 
	#bŒfs_£t_aş
 
NULL


	)

18 
šlše
 
	$__bŒfs_£t_aş
(
bŒfs_Œªs_hªdË
 *
Œªs
,

19 
šode
 *šode, 
posix_aş
 *
aş
,

20 
ty³
)

22  -
EOPNOTSUPP
;

23 
	}
}

	@async-thread.c

7 
	~<lšux/kth»ad.h
>

8 
	~<lšux/¦ab.h
>

9 
	~<lšux/li¡.h
>

10 
	~<lšux/¥šlock.h
>

11 
	~<lšux/ä“z”.h
>

12 
	~"async-th»ad.h
"

13 
	~"ù»e.h
"

16 
	mWORK_DONE_BIT
,

17 
	mWORK_ORDER_DONE_BIT
,

20 
	#NO_THRESHOLD
 (-1)

	)

21 
	#DFT_THRESHOLD
 (32)

	)

23 
	sbŒfs_wÜkqueue
 {

24 
wÜkqueue_¡ruù
 *
	mnÜm®_wq
;

27 
bŒfs_fs_šfo
 *
	mfs_šfo
;

30 
li¡_h—d
 
	mÜd”ed_li¡
;

33 
¥šlock_t
 
	mli¡_lock
;

36 
©omic_t
 
	m³ndšg
;

39 
	mlim™_aùive
;

42 
	mcu¼’t_aùive
;

45 
	mth»sh
;

46 
	mcouÁ
;

47 
¥šlock_t
 
	mth»s_lock
;

50 
bŒfs_fs_šfo
 * 
__pu»
 
	$bŒfs_wÜkqueue_owÃr
(cÚ¡ 
bŒfs_wÜkqueue
 *
wq
)

52  
wq
->
fs_šfo
;

53 
	}
}

55 
bŒfs_fs_šfo
 * 
__pu»
 
	$bŒfs_wÜk_owÃr
(cÚ¡ 
bŒfs_wÜk
 *
wÜk
)

57  
wÜk
->
wq
->
fs_šfo
;

58 
	}
}

60 
boŞ
 
	$bŒfs_wÜkqueue_nÜm®_cÚge¡ed
(cÚ¡ 
bŒfs_wÜkqueue
 *
wq
)

68 ià(
wq
->
th»sh
 =ğ
NO_THRESHOLD
)

69  
çl£
;

71  
	`©omic_»ad
(&
wq
->
³ndšg
è> wq->
th»sh
 * 2;

72 
	}
}

74 
	$bŒfs_š™_wÜkqueue
(
bŒfs_wÜkqueue
 *
wq
,

75 
bŒfs_fs_šfo
 *
fs_šfo
)

77 
wq
->
fs_šfo
 = fs_info;

78 
	`©omic_£t
(&
wq
->
³ndšg
, 0);

79 
	`INIT_LIST_HEAD
(&
wq
->
Üd”ed_li¡
);

80 
	`¥š_lock_š™
(&
wq
->
li¡_lock
);

81 
	`¥š_lock_š™
(&
wq
->
th»s_lock
);

82 
	}
}

84 
bŒfs_wÜkqueue
 *
	$bŒfs_®loc_wÜkqueue
(
bŒfs_fs_šfo
 *
fs_šfo
,

85 cÚ¡ *
Çme
, 
æags
,

86 
lim™_aùive
, 
th»sh
)

88 
bŒfs_wÜkqueue
 *
»t
 = 
	`kz®loc
((*»t), 
GFP_KERNEL
);

90 ià(!
»t
)

91  
NULL
;

93 
	`bŒfs_š™_wÜkqueue
(
»t
, 
fs_šfo
);

95 
»t
->
lim™_aùive
 =†imit_active;

96 ià(
th»sh
 == 0)

97 
th»sh
 = 
DFT_THRESHOLD
;

99 ià(
th»sh
 < 
DFT_THRESHOLD
) {

100 
»t
->
cu¼’t_aùive
 = 
lim™_aùive
;

101 
»t
->
th»sh
 = 
NO_THRESHOLD
;

108 
»t
->
cu¼’t_aùive
 = 1;

109 
»t
->
th»sh
 =hresh;

112 
»t
->
nÜm®_wq
 = 
	`®loc_wÜkqueue
("bŒfs-%s", 
æags
,„‘->
cu¼’t_aùive
,

113 
Çme
);

114 ià(!
»t
->
nÜm®_wq
) {

115 
	`kä“
(
»t
);

116  
NULL
;

119 
	`Œaû_bŒfs_wÜkqueue_®loc
(
»t
, 
Çme
);

120  
»t
;

121 
	}
}

123 
bŒfs_wÜkqueue
 *
	$bŒfs_®loc_Üd”ed_wÜkqueue
(

124 
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
Çme
,

125 
æags
)

127 
bŒfs_wÜkqueue
 *
»t
;

129 
»t
 = 
	`kz®loc
((*»t), 
GFP_KERNEL
);

130 ià(!
»t
)

131  
NULL
;

133 
	`bŒfs_š™_wÜkqueue
(
»t
, 
fs_šfo
);

136 
»t
->
lim™_aùive
 = 1;

137 
»t
->
cu¼’t_aùive
 = 1;

138 
»t
->
th»sh
 = 
NO_THRESHOLD
;

140 
»t
->
nÜm®_wq
 = 
	`®loc_Üd”ed_wÜkqueue
("bŒfs-%s", 
æags
, 
Çme
);

141 ià(!
»t
->
nÜm®_wq
) {

142 
	`kä“
(
»t
);

143  
NULL
;

146 
	`Œaû_bŒfs_wÜkqueue_®loc
(
»t
, 
Çme
);

147  
»t
;

148 
	}
}

155 
šlše
 
	$th»sh_queue_hook
(
bŒfs_wÜkqueue
 *
wq
)

157 ià(
wq
->
th»sh
 =ğ
NO_THRESHOLD
)

159 
	`©omic_šc
(&
wq
->
³ndšg
);

160 
	}
}

167 
šlše
 
	$th»sh_exec_hook
(
bŒfs_wÜkqueue
 *
wq
)

169 
Ãw_cu¼’t_aùive
;

170 
³ndšg
;

171 
Ãed_chªge
 = 0;

173 ià(
wq
->
th»sh
 =ğ
NO_THRESHOLD
)

176 
	`©omic_dec
(&
wq
->
³ndšg
);

177 
	`¥š_lock
(&
wq
->
th»s_lock
);

182 
wq
->
couÁ
++;

183 
wq
->
couÁ
 %ğ(wq->
th»sh
 / 4);

184 ià(!
wq
->
couÁ
)

185 
out
;

186 
Ãw_cu¼’t_aùive
 = 
wq
->
cu¼’t_aùive
;

192 
³ndšg
 = 
	`©omic_»ad
(&
wq
->pending);

193 ià(
³ndšg
 > 
wq
->
th»sh
)

194 
Ãw_cu¼’t_aùive
++;

195 ià(
³ndšg
 < 
wq
->
th»sh
 / 2)

196 
Ãw_cu¼’t_aùive
--;

197 
Ãw_cu¼’t_aùive
 = 
	`şamp_v®
Òew_cu¼’t_aùive, 1, 
wq
->
lim™_aùive
);

198 ià(
Ãw_cu¼’t_aùive
 !ğ
wq
->
cu¼’t_aùive
) {

199 
Ãed_chªge
 = 1;

200 
wq
->
cu¼’t_aùive
 = 
Ãw_cu¼’t_aùive
;

202 
out
:

203 
	`¥š_uÆock
(&
wq
->
th»s_lock
);

205 ià(
Ãed_chªge
) {

206 
	`wÜkqueue_£t_max_aùive
(
wq
->
nÜm®_wq
, wq->
cu¼’t_aùive
);

208 
	}
}

210 
	$run_Üd”ed_wÜk
(
bŒfs_wÜkqueue
 *
wq
,

211 
bŒfs_wÜk
 *
£lf
)

213 
li¡_h—d
 *
li¡
 = &
wq
->
Üd”ed_li¡
;

214 
bŒfs_wÜk
 *
wÜk
;

215 
¥šlock_t
 *
lock
 = &
wq
->
li¡_lock
;

216 
æags
;

217 
boŞ
 
ä“_£lf
 = 
çl£
;

220 
	`¥š_lock_œq§ve
(
lock
, 
æags
);

221 ià(
	`li¡_em±y
(
li¡
))

223 
wÜk
 = 
	`li¡_’Œy
(
li¡
->
Ãxt
, 
bŒfs_wÜk
,

224 
Üd”ed_li¡
);

225 ià(!
	`‹¡_b™
(
WORK_DONE_BIT
, &
wÜk
->
æags
))

233 
	`smp_rmb
();

241 ià(
	`‹¡_ªd_£t_b™
(
WORK_ORDER_DONE_BIT
, &
wÜk
->
æags
))

243 
	`Œaû_bŒfs_Üd”ed_sched
(
wÜk
);

244 
	`¥š_uÆock_œq»¡Üe
(
lock
, 
æags
);

245 
wÜk
->
	`Üd”ed_func
(work);

248 
	`¥š_lock_œq§ve
(
lock
, 
æags
);

249 
	`li¡_d–
(&
wÜk
->
Üd”ed_li¡
);

250 
	`¥š_uÆock_œq»¡Üe
(
lock
, 
æags
);

252 ià(
wÜk
 =ğ
£lf
) {

274 
ä“_£lf
 = 
Œue
;

280 
wÜk
->
	`Üd”ed_ä“
(work);

282 
	`Œaû_bŒfs_®l_wÜk_dÚe
(
wq
->
fs_šfo
, 
wÜk
);

285 
	`¥š_uÆock_œq»¡Üe
(
lock
, 
æags
);

287 ià(
ä“_£lf
) {

288 
£lf
->
	`Üd”ed_ä“
(self);

290 
	`Œaû_bŒfs_®l_wÜk_dÚe
(
wq
->
fs_šfo
, 
£lf
);

292 
	}
}

294 
	$bŒfs_wÜk_h–³r
(
wÜk_¡ruù
 *
nÜm®_wÜk
)

296 
bŒfs_wÜk
 *
wÜk
 = 
	`cÚš”_of
(
nÜm®_wÜk
, btrfs_work,

297 
nÜm®_wÜk
);

298 
bŒfs_wÜkqueue
 *
wq
 = 
wÜk
->wq;

299 
Ãed_Üd”
 = 0;

309 ià(
wÜk
->
Üd”ed_func
)

310 
Ãed_Üd”
 = 1;

312 
	`Œaû_bŒfs_wÜk_sched
(
wÜk
);

313 
	`th»sh_exec_hook
(
wq
);

314 
wÜk
->
	`func
(work);

315 ià(
Ãed_Üd”
) {

322 
	`smp_mb__befÜe_©omic
();

323 
	`£t_b™
(
WORK_DONE_BIT
, &
wÜk
->
æags
);

324 
	`run_Üd”ed_wÜk
(
wq
, 
wÜk
);

327 
	`Œaû_bŒfs_®l_wÜk_dÚe
(
wq
->
fs_šfo
, 
wÜk
);

329 
	}
}

331 
	$bŒfs_š™_wÜk
(
bŒfs_wÜk
 *
wÜk
, 
bŒfs_func_t
 
func
,

332 
bŒfs_func_t
 
Üd”ed_func
, bŒfs_func_ˆ
Üd”ed_ä“
)

334 
wÜk
->
func
 = func;

335 
wÜk
->
Üd”ed_func
 = ordered_func;

336 
wÜk
->
Üd”ed_ä“
 = ordered_free;

337 
	`INIT_WORK
(&
wÜk
->
nÜm®_wÜk
, 
bŒfs_wÜk_h–³r
);

338 
	`INIT_LIST_HEAD
(&
wÜk
->
Üd”ed_li¡
);

339 
wÜk
->
æags
 = 0;

340 
	}
}

342 
	$bŒfs_queue_wÜk
(
bŒfs_wÜkqueue
 *
wq
, 
bŒfs_wÜk
 *
wÜk
)

344 
æags
;

346 
wÜk
->
wq
 = wq;

347 
	`th»sh_queue_hook
(
wq
);

348 ià(
wÜk
->
Üd”ed_func
) {

349 
	`¥š_lock_œq§ve
(&
wq
->
li¡_lock
, 
æags
);

350 
	`li¡_add_
(&
wÜk
->
Üd”ed_li¡
, &
wq
->ordered_list);

351 
	`¥š_uÆock_œq»¡Üe
(&
wq
->
li¡_lock
, 
æags
);

353 
	`Œaû_bŒfs_wÜk_queued
(
wÜk
);

354 
	`queue_wÜk
(
wq
->
nÜm®_wq
, &
wÜk
->
nÜm®_wÜk
);

355 
	}
}

357 
	$bŒfs_de¡roy_wÜkqueue
(
bŒfs_wÜkqueue
 *
wq
)

359 ià(!
wq
)

361 
	`de¡roy_wÜkqueue
(
wq
->
nÜm®_wq
);

362 
	`Œaû_bŒfs_wÜkqueue_de¡roy
(
wq
);

363 
	`kä“
(
wq
);

364 
	}
}

366 
	$bŒfs_wÜkqueue_£t_max
(
bŒfs_wÜkqueue
 *
wq
, 
lim™_aùive
)

368 ià(
wq
)

369 
wq
->
lim™_aùive
 =†imit_active;

370 
	}
}

372 
	$bŒfs_æush_wÜkqueue
(
bŒfs_wÜkqueue
 *
wq
)

374 
	`æush_wÜkqueue
(
wq
->
nÜm®_wq
);

375 
	}
}

	@async-thread.h

7 #iâdeà
BTRFS_ASYNC_THREAD_H


8 
	#BTRFS_ASYNC_THREAD_H


	)

10 
	~<lšux/wÜkqueue.h
>

12 
	gbŒfs_fs_šfo
;

13 
	gbŒfs_wÜkqueue
;

14 
	gbŒfs_wÜk
;

15 (*
	tbŒfs_func_t
)(
	tbŒfs_wÜk
 *
	t¬g
);

17 
	sbŒfs_wÜk
 {

18 
bŒfs_func_t
 
func
;

19 
bŒfs_func_t
 
Üd”ed_func
;

20 
bŒfs_func_t
 
Üd”ed_ä“
;

23 
wÜk_¡ruù
 
nÜm®_wÜk
;

24 
li¡_h—d
 
Üd”ed_li¡
;

25 
bŒfs_wÜkqueue
 *
wq
;

26 
æags
;

29 
bŒfs_wÜkqueue
 *
	`bŒfs_®loc_wÜkqueue
(
bŒfs_fs_šfo
 *
fs_šfo
,

30 cÚ¡ *
Çme
,

31 
æags
,

32 
lim™_aùive
,

33 
th»sh
);

34 
bŒfs_wÜkqueue
 *
	`bŒfs_®loc_Üd”ed_wÜkqueue
(

35 
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
Çme
,

36 
æags
);

37 
	`bŒfs_š™_wÜk
(
bŒfs_wÜk
 *
wÜk
, 
bŒfs_func_t
 
func
,

38 
bŒfs_func_t
 
Üd”ed_func
, bŒfs_func_ˆ
Üd”ed_ä“
);

39 
	`bŒfs_queue_wÜk
(
bŒfs_wÜkqueue
 *
wq
,

40 
bŒfs_wÜk
 *
wÜk
);

41 
	`bŒfs_de¡roy_wÜkqueue
(
bŒfs_wÜkqueue
 *
wq
);

42 
	`bŒfs_wÜkqueue_£t_max
(
bŒfs_wÜkqueue
 *
wq
, 
max
);

43 
bŒfs_fs_šfo
 * 
__pu»
 
	`bŒfs_wÜk_owÃr
(cÚ¡ 
bŒfs_wÜk
 *
wÜk
);

44 
bŒfs_fs_šfo
 * 
__pu»
 
	`bŒfs_wÜkqueue_owÃr
(cÚ¡ 
bŒfs_wÜkqueue
 *
wq
);

45 
boŞ
 
	`bŒfs_wÜkqueue_nÜm®_cÚge¡ed
(cÚ¡ 
bŒfs_wÜkqueue
 *
wq
);

46 
	`bŒfs_æush_wÜkqueue
(
bŒfs_wÜkqueue
 *
wq
);

	@backref.c

6 
	~<lšux/mm.h
>

7 
	~<lšux/rbŒ“.h
>

8 
	~<Œaû/ev’ts/bŒfs.h
>

9 
	~"ù»e.h
"

10 
	~"disk-io.h
"

11 
	~"back»f.h
"

12 
	~"uli¡.h
"

13 
	~"Œª§ùiÚ.h
"

14 
	~"d–ayed-»f.h
"

15 
	~"lockšg.h
"

16 
	~"misc.h
"

17 
	~"Œ“-mod-log.h
"

18 
	~"fs.h
"

19 
	~"acûssÜs.h
"

20 
	~"ex‹Á-Œ“.h
"

21 
	~"»loÿtiÚ.h
"

22 
	~"Œ“-check”.h
"

25 
	#BACKREF_FOUND_SHARED
 6

	)

26 
	#BACKREF_FOUND_NOT_SHARED
 7

	)

28 
	sex‹Á_šode_–em
 {

29 
u64
 
	mšum
;

30 
u64
 
	moff£t
;

31 
u64
 
	mnum_by‹s
;

32 
ex‹Á_šode_–em
 *
	mÃxt
;

35 
	$check_ex‹Á_š_eb
(
bŒfs_back»f_w®k_ùx
 *
ùx
,

36 cÚ¡ 
bŒfs_key
 *
key
,

37 cÚ¡ 
ex‹Á_bufãr
 *
eb
,

38 cÚ¡ 
bŒfs_fe_ex‹Á_™em
 *
fi
,

39 
ex‹Á_šode_–em
 **
e›
)

41 cÚ¡ 
u64
 
d©a_Ën
 = 
	`bŒfs_fe_ex‹Á_num_by‹s
(
eb
, 
fi
);

42 
u64
 
off£t
 = 
key
->offset;

43 
ex‹Á_šode_–em
 *
e
;

44 cÚ¡ 
u64
 *
roÙ_ids
;

45 
roÙ_couÁ
;

46 
boŞ
 
ÿched
;

48 ià(!
ùx
->
ignÜe_ex‹Á_™em_pos
 &&

49 !
	`bŒfs_fe_ex‹Á_com´essiÚ
(
eb
, 
fi
) &&

50 !
	`bŒfs_fe_ex‹Á_’üy±iÚ
(
eb
, 
fi
) &&

51 !
	`bŒfs_fe_ex‹Á_Ùh”_’codšg
(
eb
, 
fi
)) {

52 
u64
 
d©a_off£t
;

54 
d©a_off£t
 = 
	`bŒfs_fe_ex‹Á_off£t
(
eb
, 
fi
);

56 ià(
ùx
->
ex‹Á_™em_pos
 < 
d©a_off£t
 ||

57 
ùx
->
ex‹Á_™em_pos
 >ğ
d©a_off£t
 + 
d©a_Ën
)

59 
off£t
 +ğ
ùx
->
ex‹Á_™em_pos
 - 
d©a_off£t
;

62 ià(!
ùx
->
šdœeù_»f_™”©Ü
 || !ùx->
ÿche_lookup
)

63 
add_šode_–em
;

65 
ÿched
 = 
ùx
->
	`ÿche_lookup
(
eb
->
¡¬t
, ctx->
u£r_ùx
, &
roÙ_ids
,

66 &
roÙ_couÁ
);

67 ià(!
ÿched
)

68 
add_šode_–em
;

70 
i
 = 0; i < 
roÙ_couÁ
; i++) {

71 
»t
;

73 
»t
 = 
ùx
->
	`šdœeù_»f_™”©Ü
(
key
->
objeùid
, 
off£t
,

74 
d©a_Ën
, 
roÙ_ids
[
i
],

75 
ùx
->
u£r_ùx
);

76 ià(
»t
)

77  
»t
;

80 
add_šode_–em
:

81 
e
 = 
	`km®loc
((*e), 
GFP_NOFS
);

82 ià(!
e
)

83  -
ENOMEM
;

85 
e
->
Ãxt
 = *
e›
;

86 
e
->
šum
 = 
key
->
objeùid
;

87 
e
->
off£t
 = offset;

88 
e
->
num_by‹s
 = 
d©a_Ën
;

89 *
e›
 = 
e
;

92 
	}
}

94 
	$ä“_šode_–em_li¡
(
ex‹Á_šode_–em
 *
e›
)

96 
ex‹Á_šode_–em
 *
e›_Ãxt
;

98 ; 
e›
;ƒ› = 
e›_Ãxt
) {

99 
e›_Ãxt
 = 
e›
->
Ãxt
;

100 
	`kä“
(
e›
);

102 
	}
}

104 
	$fšd_ex‹Á_š_eb
(
bŒfs_back»f_w®k_ùx
 *
ùx
,

105 cÚ¡ 
ex‹Á_bufãr
 *
eb
,

106 
ex‹Á_šode_–em
 **
e›
)

108 
u64
 
disk_by‹
;

109 
bŒfs_key
 
key
;

110 
bŒfs_fe_ex‹Á_™em
 *
fi
;

111 
¦Ù
;

112 
Ä™ems
;

113 
ex‹Á_ty³
;

114 
»t
;

121 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

122 
¦Ù
 = 0; slÙ < 
Ä™ems
; ++slot) {

123 
	`bŒfs_™em_key_to_ıu
(
eb
, &
key
, 
¦Ù
);

124 ià(
key
.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

126 
fi
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_fe_ex‹Á_™em
);

127 
ex‹Á_ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
eb
, 
fi
);

128 ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
)

131 
disk_by‹
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
eb
, 
fi
);

132 ià(
disk_by‹
 !ğ
ùx
->
by‹Ä
)

135 
»t
 = 
	`check_ex‹Á_š_eb
(
ùx
, &
key
, 
eb
, 
fi
, 
e›
);

136 ià(
»t
 =ğ
BTRFS_ITERATE_EXTENT_INODES_STOP
 ||„et < 0)

137  
»t
;

141 
	}
}

143 
	s´eá»e
 {

144 
rb_roÙ_ÿched
 
	mroÙ
;

145 
	mcouÁ
;

148 
	#PREFTREE_INIT
 { .
roÙ
 = 
RB_ROOT_CACHED
, .
couÁ
 = 0 }

	)

150 
	s´eá»es
 {

151 
´eá»e
 
	mdœeù
;

152 
´eá»e
 
	mšdœeù
;

153 
´eá»e
 
	mšdœeù_missšg_keys
;

164 
	ssh¬e_check
 {

165 
bŒfs_back»f_sh¬e_check_ùx
 *
	mùx
;

166 
bŒfs_roÙ
 *
	mroÙ
;

167 
u64
 
	mšum
;

168 
u64
 
	md©a_by‹Ä
;

169 
u64
 
	md©a_ex‹Á_g’
;

176 
	msh¬e_couÁ
;

187 
	m£lf_»f_couÁ
;

188 
boŞ
 
	mhave_d–ayed_d–‘e_»fs
;

191 
šlše
 
	$ex‹Á_is_sh¬ed
(
sh¬e_check
 *
sc
)

193  (
sc
 && sc->
sh¬e_couÁ
 > 1è? 
BACKREF_FOUND_SHARED
 : 0;

194 
	}
}

196 
kmem_ÿche
 *
	gbŒfs_´–im_»f_ÿche
;

198 
__š™
 
	$bŒfs_´–im_»f_š™
()

200 
bŒfs_´–im_»f_ÿche
 = 
	`kmem_ÿche_ü—‹
("btrfs_prelim_ref",

201 (
´–im_»f
),

203 
SLAB_MEM_SPREAD
,

204 
NULL
);

205 ià(!
bŒfs_´–im_»f_ÿche
)

206  -
ENOMEM
;

208 
	}
}

210 
__cŞd
 
	$bŒfs_´–im_»f_ex™
()

212 
	`kmem_ÿche_de¡roy
(
bŒfs_´–im_»f_ÿche
);

213 
	}
}

215 
	$ä“_´ef
(
´–im_»f
 *
»f
)

217 
	`kmem_ÿche_ä“
(
bŒfs_´–im_»f_ÿche
, 
»f
);

218 
	}
}

225 
	$´–im_»f_com·»
(
´–im_»f
 *
»f1
,

226 
´–im_»f
 *
»f2
)

228 ià(
»f1
->
Ëv–
 < 
»f2
->level)

230 ià(
»f1
->
Ëv–
 > 
»f2
->level)

232 ià(
»f1
->
roÙ_id
 < 
»f2
->root_id)

234 ià(
»f1
->
roÙ_id
 > 
»f2
->root_id)

236 ià(
»f1
->
key_fÜ_£¬ch
.
ty³
 < 
»f2
->key_for_search.type)

238 ià(
»f1
->
key_fÜ_£¬ch
.
ty³
 > 
»f2
->key_for_search.type)

240 ià(
»f1
->
key_fÜ_£¬ch
.
objeùid
 < 
»f2
->key_for_search.objectid)

242 ià(
»f1
->
key_fÜ_£¬ch
.
objeùid
 > 
»f2
->key_for_search.objectid)

244 ià(
»f1
->
key_fÜ_£¬ch
.
off£t
 < 
»f2
->key_for_search.offset)

246 ià(
»f1
->
key_fÜ_£¬ch
.
off£t
 > 
»f2
->key_for_search.offset)

248 ià(
»f1
->
·»Á
 < 
»f2
->parent)

250 ià(
»f1
->
·»Á
 > 
»f2
->parent)

254 
	}
}

256 
	$upd©e_sh¬e_couÁ
(
sh¬e_check
 *
sc
, 
ŞdcouÁ
,

257 
ÃwcouÁ
, 
´–im_»f
 *
Ãw»f
)

259 ià((!
sc
è|| (
ŞdcouÁ
 =ğ0 && 
ÃwcouÁ
 < 1))

262 ià(
ŞdcouÁ
 > 0 && 
ÃwcouÁ
 < 1)

263 
sc
->
sh¬e_couÁ
--;

264 ià(
ŞdcouÁ
 < 1 && 
ÃwcouÁ
 > 0)

265 
sc
->
sh¬e_couÁ
++;

267 ià(
Ãw»f
->
roÙ_id
 =ğ
sc
->
roÙ
->
roÙ_key
.
objeùid
 &&

268 
Ãw»f
->
wª‹d_disk_by‹
 =ğ
sc
->
d©a_by‹Ä
 &&

269 
Ãw»f
->
key_fÜ_£¬ch
.
objeùid
 =ğ
sc
->
šum
)

270 
sc
->
£lf_»f_couÁ
 +ğ
Ãw»f
->
couÁ
;

271 
	}
}

278 
	$´–im_»f_š£¹
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

279 
´eá»e
 *preftree,

280 
´–im_»f
 *
Ãw»f
,

281 
sh¬e_check
 *
sc
)

283 
rb_roÙ_ÿched
 *
roÙ
;

284 
rb_node
 **
p
;

285 
rb_node
 *
·»Á
 = 
NULL
;

286 
´–im_»f
 *
»f
;

287 
»suÉ
;

288 
boŞ
 
Ëámo¡
 = 
Œue
;

290 
roÙ
 = &
´eá»e
->root;

291 
p
 = &
roÙ
->
rb_roÙ
.
rb_node
;

293 *
p
) {

294 
·»Á
 = *
p
;

295 
»f
 = 
	`rb_’Œy
(
·»Á
, 
´–im_»f
, 
rbnode
);

296 
»suÉ
 = 
	`´–im_»f_com·»
(
»f
, 
Ãw»f
);

297 ià(
»suÉ
 < 0) {

298 
p
 = &(*p)->
rb_Ëá
;

299 } ià(
»suÉ
 > 0) {

300 
p
 = &(*p)->
rb_right
;

301 
Ëámo¡
 = 
çl£
;

304 
ex‹Á_šode_–em
 *
e›
 = 
»f
->
šode_li¡
;

306 
e›
 &&ƒ›->
Ãxt
)

307 
e›
 =ƒ›->
Ãxt
;

309 ià(!
e›
)

310 
»f
->
šode_li¡
 = 
Ãw»f
->inode_list;

312 
e›
->
Ãxt
 = 
Ãw»f
->
šode_li¡
;

313 
	`Œaû_bŒfs_´–im_»f_m”ge
(
fs_šfo
, 
»f
, 
Ãw»f
,

314 
´eá»e
->
couÁ
);

320 
	`upd©e_sh¬e_couÁ
(
sc
, 
»f
->
couÁ
,

321 
»f
->
couÁ
 + 
Ãw»f
->count,‚ewref);

322 
»f
->
couÁ
 +ğ
Ãw»f
->count;

323 
	`ä“_´ef
(
Ãw»f
);

328 
	`upd©e_sh¬e_couÁ
(
sc
, 0, 
Ãw»f
->
couÁ
,‚ewref);

329 
´eá»e
->
couÁ
++;

330 
	`Œaû_bŒfs_´–im_»f_š£¹
(
fs_šfo
, 
Ãw»f
, 
NULL
, 
´eá»e
->
couÁ
);

331 
	`rb_lšk_node
(&
Ãw»f
->
rbnode
, 
·»Á
, 
p
);

332 
	`rb_š£¹_cŞÜ_ÿched
(&
Ãw»f
->
rbnode
, 
roÙ
, 
Ëámo¡
);

333 
	}
}

339 
	$´–im_»Ëa£
(
´eá»e
 *preftree)

341 
´–im_»f
 *
»f
, *
Ãxt_»f
;

343 
	`rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
»f
, 
Ãxt_»f
,

344 &
´eá»e
->
roÙ
.
rb_roÙ
, 
rbnode
) {

345 
	`ä“_šode_–em_li¡
(
»f
->
šode_li¡
);

346 
	`ä“_´ef
(
»f
);

349 
´eá»e
->
roÙ
 = 
RB_ROOT_CACHED
;

350 
´eá»e
->
couÁ
 = 0;

351 
	}
}

391 
	$add_´–im_»f
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

392 
´eá»e
 *´eá»e, 
u64
 
roÙ_id
,

393 cÚ¡ 
bŒfs_key
 *
key
, 
Ëv–
, 
u64
 
·»Á
,

394 
u64
 
wª‹d_disk_by‹
, 
couÁ
,

395 
sh¬e_check
 *
sc
, 
gå_t
 
gå_mask
)

397 
´–im_»f
 *
»f
;

399 ià(
roÙ_id
 =ğ
BTRFS_DATA_RELOC_TREE_OBJECTID
)

402 
»f
 = 
	`kmem_ÿche_®loc
(
bŒfs_´–im_»f_ÿche
, 
gå_mask
);

403 ià(!
»f
)

404  -
ENOMEM
;

406 
»f
->
roÙ_id
 =„oot_id;

407 ià(
key
)

408 
»f
->
key_fÜ_£¬ch
 = *
key
;

410 
	`mem£t
(&
»f
->
key_fÜ_£¬ch
, 0, (ref->key_for_search));

412 
»f
->
šode_li¡
 = 
NULL
;

413 
»f
->
Ëv–
 =†evel;

414 
»f
->
couÁ
 = count;

415 
»f
->
·»Á
 =…arent;

416 
»f
->
wª‹d_disk_by‹
 = wanted_disk_byte;

417 
	`´–im_»f_š£¹
(
fs_šfo
, 
´eá»e
, 
»f
, 
sc
);

418  
	`ex‹Á_is_sh¬ed
(
sc
);

419 
	}
}

422 
	$add_dœeù_»f
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

423 
´eá»es
 *´eá»es, 
Ëv–
, 
u64
 
·»Á
,

424 
u64
 
wª‹d_disk_by‹
, 
couÁ
,

425 
sh¬e_check
 *
sc
, 
gå_t
 
gå_mask
)

427  
	`add_´–im_»f
(
fs_šfo
, &
´eá»es
->
dœeù
, 0, 
NULL
, 
Ëv–
,

428 
·»Á
, 
wª‹d_disk_by‹
, 
couÁ
, 
sc
, 
gå_mask
);

429 
	}
}

432 
	$add_šdœeù_»f
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

433 
´eá»es
 *´eá»es, 
u64
 
roÙ_id
,

434 cÚ¡ 
bŒfs_key
 *
key
, 
Ëv–
,

435 
u64
 
wª‹d_disk_by‹
, 
couÁ
,

436 
sh¬e_check
 *
sc
, 
gå_t
 
gå_mask
)

438 
´eá»e
 *
Œ“
 = &
´eá»es
->
šdœeù
;

440 ià(!
key
)

441 
Œ“
 = &
´eá»es
->
šdœeù_missšg_keys
;

442  
	`add_´–im_»f
(
fs_šfo
, 
Œ“
, 
roÙ_id
, 
key
, 
Ëv–
, 0,

443 
wª‹d_disk_by‹
, 
couÁ
, 
sc
, 
gå_mask
);

444 
	}
}

446 
	$is_sh¬ed_d©a_back»f
(
´eá»es
 *´eá»es, 
u64
 
by‹Ä
)

448 
rb_node
 **
p
 = &
´eá»es
->
dœeù
.
roÙ
.
rb_roÙ
.rb_node;

449 
rb_node
 *
·»Á
 = 
NULL
;

450 
´–im_»f
 *
»f
 = 
NULL
;

451 
´–im_»f
 
rg‘
 = {};

452 
»suÉ
;

454 
rg‘
.
·»Á
 = 
by‹Ä
;

456 *
p
) {

457 
·»Á
 = *
p
;

458 
»f
 = 
	`rb_’Œy
(
·»Á
, 
´–im_»f
, 
rbnode
);

459 
»suÉ
 = 
	`´–im_»f_com·»
(
»f
, &
rg‘
);

461 ià(
»suÉ
 < 0)

462 
p
 = &(*p)->
rb_Ëá
;

463 ià(
»suÉ
 > 0)

464 
p
 = &(*p)->
rb_right
;

469 
	}
}

471 
	$add_®l_·»Ás
(
bŒfs_back»f_w®k_ùx
 *
ùx
,

472 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

473 
uli¡
 *
·»Ás
,

474 
´eá»es
 *´eá»es, 
´–im_»f
 *
»f
,

475 
Ëv–
)

477 
»t
 = 0;

478 
¦Ù
;

479 
ex‹Á_bufãr
 *
eb
;

480 
bŒfs_key
 
key
;

481 
bŒfs_key
 *
key_fÜ_£¬ch
 = &
»f
->key_for_search;

482 
bŒfs_fe_ex‹Á_™em
 *
fi
;

483 
ex‹Á_šode_–em
 *
e›
 = 
NULL
, *
Şd
 = NULL;

484 
u64
 
disk_by‹
;

485 
u64
 
wª‹d_disk_by‹
 = 
»f
->wanted_disk_byte;

486 
u64
 
couÁ
 = 0;

487 
u64
 
d©a_off£t
;

488 
u8
 
ty³
;

490 ià(
Ëv–
 != 0) {

491 
eb
 = 
·th
->
nodes
[
Ëv–
];

492 
»t
 = 
	`uli¡_add
(
·»Ás
, 
eb
->
¡¬t
, 0, 
GFP_NOFS
);

493 ià(
»t
 < 0)

494  
»t
;

508 
eb
 = 
·th
->
nodes
[0];

509 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
(
eb
) ||

510 
	`is_sh¬ed_d©a_back»f
(
´eá»es
, 
eb
->
¡¬t
) ||

511 
»f
->
roÙ_id
 !ğ
	`bŒfs_h—d”_owÃr
(
eb
)) {

512 ià(
ùx
->
time_£q
 =ğ
BTRFS_SEQ_LAST
)

513 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

515 
»t
 = 
	`bŒfs_Ãxt_Şd_Ëaf
(
roÙ
, 
·th
, 
ùx
->
time_£q
);

518 !
»t
 && 
couÁ
 < 
»f
->count) {

519 
eb
 = 
·th
->
nodes
[0];

520 
¦Ù
 = 
·th
->
¦Ùs
[0];

522 
	`bŒfs_™em_key_to_ıu
(
eb
, &
key
, 
¦Ù
);

524 ià(
key
.
objeùid
 !ğ
key_fÜ_£¬ch
->objectid ||

525 
key
.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

533 ià(
¦Ù
 == 0 &&

534 (
	`is_sh¬ed_d©a_back»f
(
´eá»es
, 
eb
->
¡¬t
) ||

535 
»f
->
roÙ_id
 !ğ
	`bŒfs_h—d”_owÃr
(
eb
))) {

536 ià(
ùx
->
time_£q
 =ğ
BTRFS_SEQ_LAST
)

537 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

539 
»t
 = 
	`bŒfs_Ãxt_Şd_Ëaf
(
roÙ
, 
·th
, 
ùx
->
time_£q
);

542 
fi
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_fe_ex‹Á_™em
);

543 
ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
eb
, 
fi
);

544 ià(
ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
)

545 
Ãxt
;

546 
disk_by‹
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
eb
, 
fi
);

547 
d©a_off£t
 = 
	`bŒfs_fe_ex‹Á_off£t
(
eb
, 
fi
);

549 ià(
disk_by‹
 =ğ
wª‹d_disk_by‹
) {

550 
e›
 = 
NULL
;

551 
Şd
 = 
NULL
;

552 ià(
»f
->
key_fÜ_£¬ch
.
off£t
 =ğ
key
.off£ˆ- 
d©a_off£t
)

553 
couÁ
++;

555 
Ãxt
;

556 ià(!
ùx
->
sk_šode_»f_li¡
) {

557 
»t
 = 
	`check_ex‹Á_š_eb
(
ùx
, &
key
, 
eb
, 
fi
, &
e›
);

558 ià(
»t
 =ğ
BTRFS_ITERATE_EXTENT_INODES_STOP
 ||

559 
»t
 < 0)

562 ià(
»t
 > 0)

563 
Ãxt
;

564 
»t
 = 
	`uli¡_add_m”ge_±r
(
·»Ás
, 
eb
->
¡¬t
,

565 
e›
, (**)&
Şd
, 
GFP_NOFS
);

566 ià(
»t
 < 0)

568 ià(!
»t
 && !
ùx
->
sk_šode_»f_li¡
) {

569 
Şd
->
Ãxt
)

570 
Şd
 = old->
Ãxt
;

571 
Şd
->
Ãxt
 = 
e›
;

573 
e›
 = 
NULL
;

575 
Ãxt
:

576 ià(
ùx
->
time_£q
 =ğ
BTRFS_SEQ_LAST
)

577 
»t
 = 
	`bŒfs_Ãxt_™em
(
roÙ
, 
·th
);

579 
»t
 = 
	`bŒfs_Ãxt_Şd_™em
(
roÙ
, 
·th
, 
ùx
->
time_£q
);

582 ià(
»t
 =ğ
BTRFS_ITERATE_EXTENT_INODES_STOP
 ||„et < 0)

583 
	`ä“_šode_–em_li¡
(
e›
);

584 ià(
»t
 > 0)

585 
»t
 = 0;

587  
»t
;

588 
	}
}

594 
	$»sŞve_šdœeù_»f
(
bŒfs_back»f_w®k_ùx
 *
ùx
,

595 
bŒfs_·th
 *
·th
,

596 
´eá»es
 *preftrees,

597 
´–im_»f
 *
»f
, 
uli¡
 *
·»Ás
)

599 
bŒfs_roÙ
 *
roÙ
;

600 
ex‹Á_bufãr
 *
eb
;

601 
»t
 = 0;

602 
roÙ_Ëv–
;

603 
Ëv–
 = 
»f
->level;

604 
bŒfs_key
 
£¬ch_key
 = 
»f
->
key_fÜ_£¬ch
;

614 ià(
·th
->
£¬ch_comm™_roÙ
)

615 
roÙ
 = 
	`bŒfs_g‘_fs_roÙ_comm™_roÙ
(
ùx
->
fs_šfo
, 
·th
, 
»f
->
roÙ_id
);

617 
roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
ùx
->
fs_šfo
, 
»f
->
roÙ_id
, 
çl£
);

618 ià(
	`IS_ERR
(
roÙ
)) {

619 
»t
 = 
	`PTR_ERR
(
roÙ
);

620 
out_ä“
;

623 ià(!
·th
->
£¬ch_comm™_roÙ
 &&

624 
	`‹¡_b™
(
BTRFS_ROOT_DELETING
, &
roÙ
->
¡©e
)) {

625 
»t
 = -
ENOENT
;

626 
out
;

629 ià(
	`bŒfs_is_‹¡šg
(
ùx
->
fs_šfo
)) {

630 
»t
 = -
ENOENT
;

631 
out
;

634 ià(
·th
->
£¬ch_comm™_roÙ
)

635 
roÙ_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
roÙ
->
comm™_roÙ
);

636 ià(
ùx
->
time_£q
 =ğ
BTRFS_SEQ_LAST
)

637 
roÙ_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
roÙ
->
node
);

639 
roÙ_Ëv–
 = 
	`bŒfs_Şd_roÙ_Ëv–
(
roÙ
, 
ùx
->
time_£q
);

641 ià(
roÙ_Ëv–
 + 1 =ğ
Ëv–
)

642 
out
;

663 ià(
£¬ch_key
.
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
 &&

664 
£¬ch_key
.
off£t
 >ğ
LLONG_MAX
)

665 
£¬ch_key
.
off£t
 = 0;

666 
·th
->
lowe¡_Ëv–
 = 
Ëv–
;

667 ià(
ùx
->
time_£q
 =ğ
BTRFS_SEQ_LAST
)

668 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
£¬ch_key
, 
·th
, 0, 0);

670 
»t
 = 
	`bŒfs_£¬ch_Şd_¦Ù
(
roÙ
, &
£¬ch_key
, 
·th
, 
ùx
->
time_£q
);

672 
	`bŒfs_debug
(
ùx
->
fs_šfo
,

674 
»f
->
roÙ_id
, 
Ëv–
,„ef->
couÁ
, 
»t
,

675 
»f
->
key_fÜ_£¬ch
.
objeùid
,„ef->key_fÜ_£¬ch.
ty³
,

676 
»f
->
key_fÜ_£¬ch
.
off£t
);

677 ià(
»t
 < 0)

678 
out
;

680 
eb
 = 
·th
->
nodes
[
Ëv–
];

681 !
eb
) {

682 ià(
	`WARN_ON
(!
Ëv–
)) {

683 
»t
 = 1;

684 
out
;

686 
Ëv–
--;

687 
eb
 = 
·th
->
nodes
[
Ëv–
];

690 
»t
 = 
	`add_®l_·»Ás
(
ùx
, 
roÙ
, 
·th
, 
·»Ás
, 
´eá»es
, 
»f
, 
Ëv–
);

691 
out
:

692 
	`bŒfs_put_roÙ
(
roÙ
);

693 
out_ä“
:

694 
·th
->
lowe¡_Ëv–
 = 0;

695 
	`bŒfs_»Ëa£_·th
(
·th
);

696  
»t
;

697 
	}
}

699 
ex‹Á_šode_–em
 *

700 
	$unode_aux_to_šode_li¡
(
uli¡_node
 *
node
)

702 ià(!
node
)

703  
NULL
;

704  (
ex‹Á_šode_–em
 *)(
ušŒ_t
)
node
->
aux
;

705 
	}
}

707 
	$ä“_Ëaf_li¡
(
uli¡
 *ulist)

709 
uli¡_node
 *
node
;

710 
uli¡_™”©Ü
 
u™”
;

712 
	`ULIST_ITER_INIT
(&
u™”
);

713 (
node
 = 
	`uli¡_Ãxt
(
uli¡
, &
u™”
)))

714 
	`ä“_šode_–em_li¡
(
	`unode_aux_to_šode_li¡
(
node
));

716 
	`uli¡_ä“
(
uli¡
);

717 
	}
}

735 
	$»sŞve_šdœeù_»fs
(
bŒfs_back»f_w®k_ùx
 *
ùx
,

736 
bŒfs_·th
 *
·th
,

737 
´eá»es
 *preftrees,

738 
sh¬e_check
 *
sc
)

740 
”r
;

741 
»t
 = 0;

742 
uli¡
 *
·»Ás
;

743 
uli¡_node
 *
node
;

744 
uli¡_™”©Ü
 
u™”
;

745 
rb_node
 *
ºode
;

747 
·»Ás
 = 
	`uli¡_®loc
(
GFP_NOFS
);

748 ià(!
·»Ás
)

749  -
ENOMEM
;

757 (
ºode
 = 
	`rb_fœ¡_ÿched
(&
´eá»es
->
šdœeù
.
roÙ
))) {

758 
´–im_»f
 *
»f
;

760 
»f
 = 
	`rb_’Œy
(
ºode
, 
´–im_»f
, 
rbnode
);

761 ià(
	`WARN
(
»f
->
·»Á
,

763 
»t
 = -
EINVAL
;

764 
out
;

767 
	`rb_”a£_ÿched
(&
»f
->
rbnode
, &
´eá»es
->
šdœeù
.
roÙ
);

768 
´eá»es
->
šdœeù
.
couÁ
--;

770 ià(
»f
->
couÁ
 == 0) {

771 
	`ä“_´ef
(
»f
);

775 ià(
sc
 && 
»f
->
roÙ_id
 !ğsc->
roÙ
->
roÙ_key
.
objeùid
) {

776 
	`ä“_´ef
(
»f
);

777 
»t
 = 
BACKREF_FOUND_SHARED
;

778 
out
;

780 
”r
 = 
	`»sŞve_šdœeù_»f
(
ùx
, 
·th
, 
´eá»es
, 
»f
, 
·»Ás
);

785 ià(
”r
 =ğ-
ENOENT
) {

786 
	`´–im_»f_š£¹
(
ùx
->
fs_šfo
, &
´eá»es
->
dœeù
, 
»f
,

787 
NULL
);

789 } ià(
”r
) {

790 
	`ä“_´ef
(
»f
);

791 
»t
 = 
”r
;

792 
out
;

796 
	`ULIST_ITER_INIT
(&
u™”
);

797 
node
 = 
	`uli¡_Ãxt
(
·»Ás
, &
u™”
);

798 
»f
->
·»Á
 = 
node
 ?‚ode->
v®
 : 0;

799 
»f
->
šode_li¡
 = 
	`unode_aux_to_šode_li¡
(
node
);

802 (
node
 = 
	`uli¡_Ãxt
(
·»Ás
, &
u™”
))) {

803 
´–im_»f
 *
Ãw_»f
;

805 
Ãw_»f
 = 
	`kmem_ÿche_®loc
(
bŒfs_´–im_»f_ÿche
,

806 
GFP_NOFS
);

807 ià(!
Ãw_»f
) {

808 
	`ä“_´ef
(
»f
);

809 
»t
 = -
ENOMEM
;

810 
out
;

812 
	`memıy
(
Ãw_»f
, 
»f
, (*ref));

813 
Ãw_»f
->
·»Á
 = 
node
->
v®
;

814 
Ãw_»f
->
šode_li¡
 = 
	`unode_aux_to_šode_li¡
(
node
);

815 
	`´–im_»f_š£¹
(
ùx
->
fs_šfo
, &
´eá»es
->
dœeù
,

816 
Ãw_»f
, 
NULL
);

823 
	`´–im_»f_š£¹
(
ùx
->
fs_šfo
, &
´eá»es
->
dœeù
, 
»f
, 
NULL
);

825 
	`uli¡_»š™
(
·»Ás
);

826 
	`cÚd_»sched
();

828 
out
:

833 
	`ä“_Ëaf_li¡
(
·»Ás
);

834  
»t
;

835 
	}
}

840 
	$add_missšg_keys
(
bŒfs_fs_šfo
 *
fs_šfo
,

841 
´eá»es
 *´eá»es, 
boŞ
 
lock
)

843 
´–im_»f
 *
»f
;

844 
ex‹Á_bufãr
 *
eb
;

845 
´eá»e
 *
Œ“
 = &
´eá»es
->
šdœeù_missšg_keys
;

846 
rb_node
 *
node
;

848 (
node
 = 
	`rb_fœ¡_ÿched
(&
Œ“
->
roÙ
))) {

849 
bŒfs_Œ“_·»Á_check
 
check
 = { 0 };

851 
»f
 = 
	`rb_’Œy
(
node
, 
´–im_»f
, 
rbnode
);

852 
	`rb_”a£_ÿched
(
node
, &
Œ“
->
roÙ
);

854 
	`BUG_ON
(
»f
->
·»Á
);

855 
	`BUG_ON
(
»f
->
key_fÜ_£¬ch
.
ty³
);

856 
	`BUG_ON
(!
»f
->
wª‹d_disk_by‹
);

858 
check
.
Ëv–
 = 
»f
->level - 1;

859 
check
.
owÃr_roÙ
 = 
»f
->
roÙ_id
;

861 
eb
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
»f
->
wª‹d_disk_by‹
, &
check
);

862 ià(
	`IS_ERR
(
eb
)) {

863 
	`ä“_´ef
(
»f
);

864  
	`PTR_ERR
(
eb
);

866 ià(!
	`ex‹Á_bufãr_u±od©e
(
eb
)) {

867 
	`ä“_´ef
(
»f
);

868 
	`ä“_ex‹Á_bufãr
(
eb
);

869  -
EIO
;

872 ià(
lock
)

873 
	`bŒfs_Œ“_»ad_lock
(
eb
);

874 ià(
	`bŒfs_h—d”_Ëv–
(
eb
) == 0)

875 
	`bŒfs_™em_key_to_ıu
(
eb
, &
»f
->
key_fÜ_£¬ch
, 0);

877 
	`bŒfs_node_key_to_ıu
(
eb
, &
»f
->
key_fÜ_£¬ch
, 0);

878 ià(
lock
)

879 
	`bŒfs_Œ“_»ad_uÆock
(
eb
);

880 
	`ä“_ex‹Á_bufãr
(
eb
);

881 
	`´–im_»f_š£¹
(
fs_šfo
, &
´eá»es
->
šdœeù
, 
»f
, 
NULL
);

882 
	`cÚd_»sched
();

885 
	}
}

891 
	$add_d–ayed_»fs
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

892 
bŒfs_d–ayed_»f_h—d
 *
h—d
, 
u64
 
£q
,

893 
´eá»es
 *´eá»es, 
sh¬e_check
 *
sc
)

895 
bŒfs_d–ayed_»f_node
 *
node
;

896 
bŒfs_key
 
key
;

897 
rb_node
 *
n
;

898 
couÁ
;

899 
»t
 = 0;

901 
	`¥š_lock
(&
h—d
->
lock
);

902 
n
 = 
	`rb_fœ¡_ÿched
(&
h—d
->
»f_Œ“
);‚;‚ = 
	`rb_Ãxt
(n)) {

903 
node
 = 
	`rb_’Œy
(
n
, 
bŒfs_d–ayed_»f_node
,

904 
»f_node
);

905 ià(
node
->
£q
 > seq)

908 
node
->
aùiÚ
) {

909 
BTRFS_ADD_DELAYED_EXTENT
:

910 
BTRFS_UPDATE_DELAYED_HEAD
:

911 
	`WARN_ON
(1);

913 
BTRFS_ADD_DELAYED_REF
:

914 
couÁ
 = 
node
->
»f_mod
;

916 
BTRFS_DROP_DELAYED_REF
:

917 
couÁ
 = 
node
->
»f_mod
 * -1;

920 
	`BUG
();

922 
node
->
ty³
) {

923 
BTRFS_TREE_BLOCK_REF_KEY
: {

925 
bŒfs_d–ayed_Œ“_»f
 *
»f
;

926 
bŒfs_key
 *
key_±r
 = 
NULL
;

928 ià(
h—d
->
ex‹Á_İ
 && h—d->ex‹Á_İ->
upd©e_key
) {

929 
	`bŒfs_disk_key_to_ıu
(&
key
, &
h—d
->
ex‹Á_İ
->key);

930 
key_±r
 = &
key
;

933 
»f
 = 
	`bŒfs_d–ayed_node_to_Œ“_»f
(
node
);

934 
»t
 = 
	`add_šdœeù_»f
(
fs_šfo
, 
´eá»es
, 
»f
->
roÙ
,

935 
key_±r
, 
»f
->
Ëv–
 + 1,

936 
node
->
by‹Ä
, 
couÁ
, 
sc
,

937 
GFP_ATOMIC
);

940 
BTRFS_SHARED_BLOCK_REF_KEY
: {

942 
bŒfs_d–ayed_Œ“_»f
 *
»f
;

944 
»f
 = 
	`bŒfs_d–ayed_node_to_Œ“_»f
(
node
);

946 
»t
 = 
	`add_dœeù_»f
(
fs_šfo
, 
´eá»es
, 
»f
->
Ëv–
 + 1,

947 
»f
->
·»Á
, 
node
->
by‹Ä
, 
couÁ
,

948 
sc
, 
GFP_ATOMIC
);

951 
BTRFS_EXTENT_DATA_REF_KEY
: {

953 
bŒfs_d–ayed_d©a_»f
 *
»f
;

954 
»f
 = 
	`bŒfs_d–ayed_node_to_d©a_»f
(
node
);

956 
key
.
objeùid
 = 
»f
->objectid;

957 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

958 
key
.
off£t
 = 
»f
->offset;

975 ià(
sc
 && 
couÁ
 < 0)

976 
sc
->
have_d–ayed_d–‘e_»fs
 = 
Œue
;

978 
»t
 = 
	`add_šdœeù_»f
(
fs_šfo
, 
´eá»es
, 
»f
->
roÙ
,

979 &
key
, 0, 
node
->
by‹Ä
, 
couÁ
, 
sc
,

980 
GFP_ATOMIC
);

983 
BTRFS_SHARED_DATA_REF_KEY
: {

985 
bŒfs_d–ayed_d©a_»f
 *
»f
;

987 
»f
 = 
	`bŒfs_d–ayed_node_to_d©a_»f
(
node
);

989 
»t
 = 
	`add_dœeù_»f
(
fs_šfo
, 
´eá»es
, 0, 
»f
->
·»Á
,

990 
node
->
by‹Ä
, 
couÁ
, 
sc
,

991 
GFP_ATOMIC
);

995 
	`WARN_ON
(1);

1001 ià(
»t
 && (»ˆ!ğ
BACKREF_FOUND_SHARED
))

1004 ià(!
»t
)

1005 
»t
 = 
	`ex‹Á_is_sh¬ed
(
sc
);

1007 
	`¥š_uÆock
(&
h—d
->
lock
);

1008  
»t
;

1009 
	}
}

1016 
	$add_šlše_»fs
(
bŒfs_back»f_w®k_ùx
 *
ùx
,

1017 
bŒfs_·th
 *
·th
,

1018 *
šfo_Ëv–
, 
´eá»es
 *preftrees,

1019 
sh¬e_check
 *
sc
)

1021 
»t
 = 0;

1022 
¦Ù
;

1023 
ex‹Á_bufãr
 *
Ëaf
;

1024 
bŒfs_key
 
key
;

1025 
bŒfs_key
 
found_key
;

1026 
±r
;

1027 
’d
;

1028 
bŒfs_ex‹Á_™em
 *
ei
;

1029 
u64
 
æags
;

1030 
u64
 
™em_size
;

1035 
Ëaf
 = 
·th
->
nodes
[0];

1036 
¦Ù
 = 
·th
->
¦Ùs
[0];

1038 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

1039 
	`BUG_ON
(
™em_size
 < (*
ei
));

1041 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_ex‹Á_™em
);

1043 ià(
ùx
->
check_ex‹Á_™em
) {

1044 
»t
 = 
ùx
->
	`check_ex‹Á_™em
(ùx->
by‹Ä
, 
ei
, 
Ëaf
, ctx->
u£r_ùx
);

1045 ià(
»t
)

1046  
»t
;

1049 
æags
 = 
	`bŒfs_ex‹Á_æags
(
Ëaf
, 
ei
);

1050 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
¦Ù
);

1052 
±r
 = ()(
ei
 + 1);

1053 
’d
 = ()
ei
 + 
™em_size
;

1055 ià(
found_key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 &&

1056 
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

1057 
bŒfs_Œ“_block_šfo
 *
šfo
;

1059 
šfo
 = (
bŒfs_Œ“_block_šfo
 *)
±r
;

1060 *
šfo_Ëv–
 = 
	`bŒfs_Œ“_block_Ëv–
(
Ëaf
, 
šfo
);

1061 
±r
 +ğ(
bŒfs_Œ“_block_šfo
);

1062 
	`BUG_ON
(
±r
 > 
’d
);

1063 } ià(
found_key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
) {

1064 *
šfo_Ëv–
 = 
found_key
.
off£t
;

1066 
	`BUG_ON
(!(
æags
 & 
BTRFS_EXTENT_FLAG_DATA
));

1069 
±r
 < 
’d
) {

1070 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

1071 
u64
 
off£t
;

1072 
ty³
;

1074 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)
±r
;

1075 
ty³
 = 
	`bŒfs_g‘_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
,

1076 
BTRFS_REF_TYPE_ANY
);

1077 ià(
ty³
 =ğ
BTRFS_REF_TYPE_INVALID
)

1078  -
EUCLEAN
;

1080 
off£t
 = 
	`bŒfs_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
);

1082 
ty³
) {

1083 
BTRFS_SHARED_BLOCK_REF_KEY
:

1084 
»t
 = 
	`add_dœeù_»f
(
ùx
->
fs_šfo
, 
´eá»es
,

1085 *
šfo_Ëv–
 + 1, 
off£t
,

1086 
ùx
->
by‹Ä
, 1, 
NULL
, 
GFP_NOFS
);

1088 
BTRFS_SHARED_DATA_REF_KEY
: {

1089 
bŒfs_sh¬ed_d©a_»f
 *
sd»f
;

1090 
couÁ
;

1092 
sd»f
 = (
bŒfs_sh¬ed_d©a_»f
 *)(
œef
 + 1);

1093 
couÁ
 = 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
sd»f
);

1095 
»t
 = 
	`add_dœeù_»f
(
ùx
->
fs_šfo
, 
´eá»es
, 0, 
off£t
,

1096 
ùx
->
by‹Ä
, 
couÁ
, 
sc
, 
GFP_NOFS
);

1099 
BTRFS_TREE_BLOCK_REF_KEY
:

1100 
»t
 = 
	`add_šdœeù_»f
(
ùx
->
fs_šfo
, 
´eá»es
, 
off£t
,

1101 
NULL
, *
šfo_Ëv–
 + 1,

1102 
ùx
->
by‹Ä
, 1, 
NULL
, 
GFP_NOFS
);

1104 
BTRFS_EXTENT_DATA_REF_KEY
: {

1105 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

1106 
couÁ
;

1107 
u64
 
roÙ
;

1109 
d»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

1110 
couÁ
 = 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
d»f
);

1111 
key
.
objeùid
 = 
	`bŒfs_ex‹Á_d©a_»f_objeùid
(
Ëaf
,

1112 
d»f
);

1113 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

1114 
key
.
off£t
 = 
	`bŒfs_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
d»f
);

1116 ià(
sc
 && 
key
.
objeùid
 !ğsc->
šum
 &&

1117 !
sc
->
have_d–ayed_d–‘e_»fs
) {

1118 
»t
 = 
BACKREF_FOUND_SHARED
;

1122 
roÙ
 = 
	`bŒfs_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
d»f
);

1124 ià(!
ùx
->
sk_d©a_»f
 ||

1125 !
ùx
->
	`sk_d©a_»f
(
roÙ
, 
key
.
objeùid
, key.
off£t
,

1126 
ùx
->
u£r_ùx
))

1127 
»t
 = 
	`add_šdœeù_»f
(
ùx
->
fs_šfo
, 
´eá»es
,

1128 
roÙ
, &
key
, 0, 
ùx
->
by‹Ä
,

1129 
couÁ
, 
sc
, 
GFP_NOFS
);

1133 
	`WARN_ON
(1);

1135 ià(
»t
)

1136  
»t
;

1137 
±r
 +ğ
	`bŒfs_ex‹Á_šlše_»f_size
(
ty³
);

1141 
	}
}

1148 
	$add_keyed_»fs
(
bŒfs_back»f_w®k_ùx
 *
ùx
,

1149 
bŒfs_roÙ
 *
ex‹Á_roÙ
,

1150 
bŒfs_·th
 *
·th
,

1151 
šfo_Ëv–
, 
´eá»es
 *preftrees,

1152 
sh¬e_check
 *
sc
)

1154 
bŒfs_fs_šfo
 *
fs_šfo
 = 
ex‹Á_roÙ
->fs_info;

1155 
»t
;

1156 
¦Ù
;

1157 
ex‹Á_bufãr
 *
Ëaf
;

1158 
bŒfs_key
 
key
;

1161 
»t
 = 
	`bŒfs_Ãxt_™em
(
ex‹Á_roÙ
, 
·th
);

1162 ià(
»t
 < 0)

1164 ià(
»t
) {

1165 
»t
 = 0;

1169 
¦Ù
 = 
·th
->
¦Ùs
[0];

1170 
Ëaf
 = 
·th
->
nodes
[0];

1171 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

1173 ià(
key
.
objeùid
 !ğ
ùx
->
by‹Ä
)

1175 ià(
key
.
ty³
 < 
BTRFS_TREE_BLOCK_REF_KEY
)

1177 ià(
key
.
ty³
 > 
BTRFS_SHARED_DATA_REF_KEY
)

1180 
key
.
ty³
) {

1181 
BTRFS_SHARED_BLOCK_REF_KEY
:

1183 
»t
 = 
	`add_dœeù_»f
(
fs_šfo
, 
´eá»es
,

1184 
šfo_Ëv–
 + 1, 
key
.
off£t
,

1185 
ùx
->
by‹Ä
, 1, 
NULL
, 
GFP_NOFS
);

1187 
BTRFS_SHARED_DATA_REF_KEY
: {

1189 
bŒfs_sh¬ed_d©a_»f
 *
sd»f
;

1190 
couÁ
;

1192 
sd»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
,

1193 
bŒfs_sh¬ed_d©a_»f
);

1194 
couÁ
 = 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
sd»f
);

1195 
»t
 = 
	`add_dœeù_»f
(
fs_šfo
, 
´eá»es
, 0,

1196 
key
.
off£t
, 
ùx
->
by‹Ä
, 
couÁ
,

1197 
sc
, 
GFP_NOFS
);

1200 
BTRFS_TREE_BLOCK_REF_KEY
:

1202 
»t
 = 
	`add_šdœeù_»f
(
fs_šfo
, 
´eá»es
, 
key
.
off£t
,

1203 
NULL
, 
šfo_Ëv–
 + 1, 
ùx
->
by‹Ä
,

1204 1, 
NULL
, 
GFP_NOFS
);

1206 
BTRFS_EXTENT_DATA_REF_KEY
: {

1208 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

1209 
couÁ
;

1210 
u64
 
roÙ
;

1212 
d»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
,

1213 
bŒfs_ex‹Á_d©a_»f
);

1214 
couÁ
 = 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
d»f
);

1215 
key
.
objeùid
 = 
	`bŒfs_ex‹Á_d©a_»f_objeùid
(
Ëaf
,

1216 
d»f
);

1217 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

1218 
key
.
off£t
 = 
	`bŒfs_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
d»f
);

1220 ià(
sc
 && 
key
.
objeùid
 !ğsc->
šum
 &&

1221 !
sc
->
have_d–ayed_d–‘e_»fs
) {

1222 
»t
 = 
BACKREF_FOUND_SHARED
;

1226 
roÙ
 = 
	`bŒfs_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
d»f
);

1228 ià(!
ùx
->
sk_d©a_»f
 ||

1229 !
ùx
->
	`sk_d©a_»f
(
roÙ
, 
key
.
objeùid
, key.
off£t
,

1230 
ùx
->
u£r_ùx
))

1231 
»t
 = 
	`add_šdœeù_»f
(
fs_šfo
, 
´eá»es
, 
roÙ
,

1232 &
key
, 0, 
ùx
->
by‹Ä
,

1233 
couÁ
, 
sc
, 
GFP_NOFS
);

1237 
	`WARN_ON
(1);

1239 ià(
»t
)

1240  
»t
;

1244  
»t
;

1245 
	}
}

1252 
boŞ
 
	$lookup_back»f_sh¬ed_ÿche
(
bŒfs_back»f_sh¬e_check_ùx
 *
ùx
,

1253 
bŒfs_roÙ
 *
roÙ
,

1254 
u64
 
by‹Ä
, 
Ëv–
, 
boŞ
 *
is_sh¬ed
)

1256 cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1257 
bŒfs_back»f_sh¬ed_ÿche_’Œy
 *
’Œy
;

1259 ià(!
cu¼’t
->
jouº®_šfo
)

1260 
	`lockd•_as£¹_h–d
(&
fs_šfo
->
comm™_roÙ_£m
);

1262 ià(!
ùx
->
u£_·th_ÿche
)

1263  
çl£
;

1265 ià(
	`WARN_ON_ONCE
(
Ëv–
 >ğ
BTRFS_MAX_LEVEL
))

1266  
çl£
;

1274 
	`ASSERT
(
Ëv–
 >= 0);

1276 
’Œy
 = &
ùx
->
·th_ÿche_’Œ›s
[
Ëv–
];

1279 ià(
’Œy
->
by‹Ä
 != bytenr)

1280  
çl£
;

1286 ià(!
’Œy
->
is_sh¬ed
 &&

1287 
’Œy
->
g’
 !ğ
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
))

1288  
çl£
;

1295 ià(
’Œy
->
is_sh¬ed
 &&

1296 
’Œy
->
g’
 !ğ
	`bŒfs_g‘_Ï¡_roÙ_drİ_g’
(
fs_šfo
))

1297  
çl£
;

1299 *
is_sh¬ed
 = 
’Œy
->is_shared;

1307 ià(*
is_sh¬ed
) {

1308 
i
 = 0; i < 
Ëv–
; i++) {

1309 
ùx
->
·th_ÿche_’Œ›s
[
i
].
is_sh¬ed
 = 
Œue
;

1310 
ùx
->
·th_ÿche_’Œ›s
[
i
].
g’
 = 
’Œy
->gen;

1314  
Œue
;

1315 
	}
}

1322 
	$¡Üe_back»f_sh¬ed_ÿche
(
bŒfs_back»f_sh¬e_check_ùx
 *
ùx
,

1323 
bŒfs_roÙ
 *
roÙ
,

1324 
u64
 
by‹Ä
, 
Ëv–
, 
boŞ
 
is_sh¬ed
)

1326 cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1327 
bŒfs_back»f_sh¬ed_ÿche_’Œy
 *
’Œy
;

1328 
u64
 
g’
;

1330 ià(!
cu¼’t
->
jouº®_šfo
)

1331 
	`lockd•_as£¹_h–d
(&
fs_šfo
->
comm™_roÙ_£m
);

1333 ià(!
ùx
->
u£_·th_ÿche
)

1336 ià(
	`WARN_ON_ONCE
(
Ëv–
 >ğ
BTRFS_MAX_LEVEL
))

1345 
	`ASSERT
(
Ëv–
 >= 0);

1347 ià(
is_sh¬ed
)

1348 
g’
 = 
	`bŒfs_g‘_Ï¡_roÙ_drİ_g’
(
fs_šfo
);

1350 
g’
 = 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
);

1352 
’Œy
 = &
ùx
->
·th_ÿche_’Œ›s
[
Ëv–
];

1353 
’Œy
->
by‹Ä
 = bytenr;

1354 
’Œy
->
is_sh¬ed
 = is_shared;

1355 
’Œy
->
g’
 = gen;

1364 ià(
is_sh¬ed
) {

1365 
i
 = 0; i < 
Ëv–
; i++) {

1366 
’Œy
 = &
ùx
->
·th_ÿche_’Œ›s
[
i
];

1367 
’Œy
->
is_sh¬ed
 = is_shared;

1368 
’Œy
->
g’
 = gen;

1371 
	}
}

1387 
	$fšd_·»Á_nodes
(
bŒfs_back»f_w®k_ùx
 *
ùx
,

1388 
sh¬e_check
 *
sc
)

1390 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
ùx
->
fs_šfo
, ctx->
by‹Ä
);

1391 
bŒfs_key
 
key
;

1392 
bŒfs_·th
 *
·th
;

1393 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
 = 
NULL
;

1394 
bŒfs_d–ayed_»f_h—d
 *
h—d
;

1395 
šfo_Ëv–
 = 0;

1396 
»t
;

1397 
´–im_»f
 *
»f
;

1398 
rb_node
 *
node
;

1399 
ex‹Á_šode_–em
 *
e›
 = 
NULL
;

1400 
´eá»es
…reftrees = {

1401 .
dœeù
 = 
PREFTREE_INIT
,

1402 .
šdœeù
 = 
PREFTREE_INIT
,

1403 .
šdœeù_missšg_keys
 = 
PREFTREE_INIT


1407 ià(
sc
)

1408 
	`ASSERT
(
ùx
->
roÙs
 =ğ
NULL
);

1410 
key
.
objeùid
 = 
ùx
->
by‹Ä
;

1411 
key
.
off£t
 = (
u64
)-1;

1412 ià(
	`bŒfs_fs_šcom·t
(
ùx
->
fs_šfo
, 
SKINNY_METADATA
))

1413 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

1415 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

1417 
·th
 = 
	`bŒfs_®loc_·th
();

1418 ià(!
·th
)

1419  -
ENOMEM
;

1420 ià(!
ùx
->
Œªs
) {

1421 
·th
->
£¬ch_comm™_roÙ
 = 1;

1422 
·th
->
sk_lockšg
 = 1;

1425 ià(
ùx
->
time_£q
 =ğ
BTRFS_SEQ_LAST
)

1426 
·th
->
sk_lockšg
 = 1;

1428 
agaš
:

1429 
h—d
 = 
NULL
;

1431 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

1432 ià(
»t
 < 0)

1433 
out
;

1434 ià(
»t
 == 0) {

1436 
	`ASSERT
(
»t
 != 0);

1437 
»t
 = -
EUCLEAN
;

1438 
out
;

1441 ià(
ùx
->
Œªs
 && 
	`lik–y
(ùx->Œªs->
ty³
 !ğ
__TRANS_DUMMY
) &&

1442 
ùx
->
time_£q
 !ğ
BTRFS_SEQ_LAST
) {

1449 
d–ayed_»fs
 = &
ùx
->
Œªs
->
Œª§ùiÚ
->delayed_refs;

1450 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

1451 
h—d
 = 
	`bŒfs_fšd_d–ayed_»f_h—d
(
d–ayed_»fs
, 
ùx
->
by‹Ä
);

1452 ià(
h—d
) {

1453 ià(!
	`mu‹x_Œylock
(&
h—d
->
mu‹x
)) {

1454 
	`»fcouÁ_šc
(&
h—d
->
»fs
);

1455 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

1457 
	`bŒfs_»Ëa£_·th
(
·th
);

1463 
	`mu‹x_lock
(&
h—d
->
mu‹x
);

1464 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

1465 
	`bŒfs_put_d–ayed_»f_h—d
(
h—d
);

1466 
agaš
;

1468 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

1469 
»t
 = 
	`add_d–ayed_»fs
(
ùx
->
fs_šfo
, 
h—d
, ctx->
time_£q
,

1470 &
´eá»es
, 
sc
);

1471 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

1472 ià(
»t
)

1473 
out
;

1475 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

1479 ià(
·th
->
¦Ùs
[0]) {

1480 
ex‹Á_bufãr
 *
Ëaf
;

1481 
¦Ù
;

1483 
·th
->
¦Ùs
[0]--;

1484 
Ëaf
 = 
·th
->
nodes
[0];

1485 
¦Ù
 = 
·th
->
¦Ùs
[0];

1486 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

1487 ià(
key
.
objeùid
 =ğ
ùx
->
by‹Ä
 &&

1488 (
key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 ||

1489 
key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
)) {

1490 
»t
 = 
	`add_šlše_»fs
(
ùx
, 
·th
, &
šfo_Ëv–
,

1491 &
´eá»es
, 
sc
);

1492 ià(
»t
)

1493 
out
;

1494 
»t
 = 
	`add_keyed_»fs
(
ùx
, 
roÙ
, 
·th
, 
šfo_Ëv–
,

1495 &
´eá»es
, 
sc
);

1496 ià(
»t
)

1497 
out
;

1513 
	`ASSERT
(
	`ex‹Á_is_sh¬ed
(
sc
) == 0);

1523 ià(
sc
 && 
ùx
->
by‹Ä
 =ğsc->
d©a_by‹Ä
) {

1533 ià(
sc
->
d©a_ex‹Á_g’
 >

1534 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
sc
->
roÙ
->
roÙ_™em
)) {

1535 
»t
 = 
BACKREF_FOUND_NOT_SHARED
;

1536 
out
;

1550 ià(
sc
->
ùx
->
cu¼_Ëaf_by‹Ä
 =ğsc->ùx->
´ev_Ëaf_by‹Ä
 &&

1551 
sc
->
£lf_»f_couÁ
 == 1) {

1552 
boŞ
 
ÿched
;

1553 
boŞ
 
is_sh¬ed
;

1555 
ÿched
 = 
	`lookup_back»f_sh¬ed_ÿche
(
sc
->
ùx
, sc->
roÙ
,

1556 
sc
->
ùx
->
cu¼_Ëaf_by‹Ä
,

1557 0, &
is_sh¬ed
);

1558 ià(
ÿched
) {

1559 ià(
is_sh¬ed
)

1560 
»t
 = 
BACKREF_FOUND_SHARED
;

1562 
»t
 = 
BACKREF_FOUND_NOT_SHARED
;

1563 
out
;

1568 
	`bŒfs_»Ëa£_·th
(
·th
);

1570 
»t
 = 
	`add_missšg_keys
(
ùx
->
fs_šfo
, &
´eá»es
, 
·th
->
sk_lockšg
 == 0);

1571 ià(
»t
)

1572 
out
;

1574 
	`WARN_ON
(!
	`RB_EMPTY_ROOT
(&
´eá»es
.
šdœeù_missšg_keys
.
roÙ
.
rb_roÙ
));

1576 
»t
 = 
	`»sŞve_šdœeù_»fs
(
ùx
, 
·th
, &
´eá»es
, 
sc
);

1577 ià(
»t
)

1578 
out
;

1580 
	`WARN_ON
(!
	`RB_EMPTY_ROOT
(&
´eá»es
.
šdœeù
.
roÙ
.
rb_roÙ
));

1589 
node
 = 
	`rb_fœ¡_ÿched
(&
´eá»es
.
dœeù
.
roÙ
);

1590 
node
) {

1591 
»f
 = 
	`rb_’Œy
(
node
, 
´–im_»f
, 
rbnode
);

1592 
node
 = 
	`rb_Ãxt
(&
»f
->
rbnode
);

1603 ià(
ùx
->
roÙs
 && 
»f
->
couÁ
 &&„ef->
roÙ_id
 &&„ef->
·»Á
 == 0) {

1605 
»t
 = 
	`uli¡_add
(
ùx
->
roÙs
, 
»f
->
roÙ_id
, 0, 
GFP_NOFS
);

1606 ià(
»t
 < 0)

1607 
out
;

1609 ià(
»f
->
couÁ
 &&„ef->
·»Á
) {

1610 ià(!
ùx
->
sk_šode_»f_li¡
 && !
»f
->
šode_li¡
 &&

1611 
»f
->
Ëv–
 == 0) {

1612 
bŒfs_Œ“_·»Á_check
 
check
 = { 0 };

1613 
ex‹Á_bufãr
 *
eb
;

1615 
check
.
Ëv–
 = 
»f
->level;

1617 
eb
 = 
	`»ad_Œ“_block
(
ùx
->
fs_šfo
, 
»f
->
·»Á
,

1618 &
check
);

1619 ià(
	`IS_ERR
(
eb
)) {

1620 
»t
 = 
	`PTR_ERR
(
eb
);

1621 
out
;

1623 ià(!
	`ex‹Á_bufãr_u±od©e
(
eb
)) {

1624 
	`ä“_ex‹Á_bufãr
(
eb
);

1625 
»t
 = -
EIO
;

1626 
out
;

1629 ià(!
·th
->
sk_lockšg
)

1630 
	`bŒfs_Œ“_»ad_lock
(
eb
);

1631 
»t
 = 
	`fšd_ex‹Á_š_eb
(
ùx
, 
eb
, &
e›
);

1632 ià(!
·th
->
sk_lockšg
)

1633 
	`bŒfs_Œ“_»ad_uÆock
(
eb
);

1634 
	`ä“_ex‹Á_bufãr
(
eb
);

1635 ià(
»t
 =ğ
BTRFS_ITERATE_EXTENT_INODES_STOP
 ||

1636 
»t
 < 0)

1637 
out
;

1638 
»f
->
šode_li¡
 = 
e›
;

1644 
e›
 = 
NULL
;

1646 
»t
 = 
	`uli¡_add_m”ge_±r
(
ùx
->
»fs
, 
»f
->
·»Á
,

1647 
»f
->
šode_li¡
,

1648 (**)&
e›
, 
GFP_NOFS
);

1649 ià(
»t
 < 0)

1650 
out
;

1651 ià(!
»t
 && !
ùx
->
sk_šode_»f_li¡
) {

1660 
	`ASSERT
(
e›
);

1661 ià(!
e›
) {

1662 
»t
 = -
EUCLEAN
;

1663 
out
;

1665 
e›
->
Ãxt
)

1666 
e›
 =ƒ›->
Ãxt
;

1667 
e›
->
Ãxt
 = 
»f
->
šode_li¡
;

1669 
e›
 = 
NULL
;

1677 
»f
->
šode_li¡
 = 
NULL
;

1679 
	`cÚd_»sched
();

1682 
out
:

1683 
	`bŒfs_ä“_·th
(
·th
);

1685 
	`´–im_»Ëa£
(&
´eá»es
.
dœeù
);

1686 
	`´–im_»Ëa£
(&
´eá»es
.
šdœeù
);

1687 
	`´–im_»Ëa£
(&
´eá»es
.
šdœeù_missšg_keys
);

1689 ià(
»t
 =ğ
BTRFS_ITERATE_EXTENT_INODES_STOP
 ||„et < 0)

1690 
	`ä“_šode_–em_li¡
(
e›
);

1691  
»t
;

1692 
	}
}

1704 
	$bŒfs_fšd_®l_Ëafs
(
bŒfs_back»f_w®k_ùx
 *
ùx
)

1706 
»t
;

1708 
	`ASSERT
(
ùx
->
»fs
 =ğ
NULL
);

1710 
ùx
->
»fs
 = 
	`uli¡_®loc
(
GFP_NOFS
);

1711 ià(!
ùx
->
»fs
)

1712  -
ENOMEM
;

1714 
»t
 = 
	`fšd_·»Á_nodes
(
ùx
, 
NULL
);

1715 ià(
»t
 =ğ
BTRFS_ITERATE_EXTENT_INODES_STOP
 ||

1716 (
»t
 < 0 &&„‘ !ğ-
ENOENT
)) {

1717 
	`ä“_Ëaf_li¡
(
ùx
->
»fs
);

1718 
ùx
->
»fs
 = 
NULL
;

1719  
»t
;

1723 
	}
}

1744 
	$bŒfs_fšd_®l_roÙs_§ã
(
bŒfs_back»f_w®k_ùx
 *
ùx
)

1746 cÚ¡ 
u64
 
Üig_by‹Ä
 = 
ùx
->
by‹Ä
;

1747 cÚ¡ 
boŞ
 
Üig_sk_šode_»f_li¡
 = 
ùx
->
sk_šode_»f_li¡
;

1748 
boŞ
 
roÙs_uli¡_®loÿ‹d
 = 
çl£
;

1749 
uli¡_™”©Ü
 
u™”
;

1750 
»t
 = 0;

1752 
	`ASSERT
(
ùx
->
»fs
 =ğ
NULL
);

1754 
ùx
->
»fs
 = 
	`uli¡_®loc
(
GFP_NOFS
);

1755 ià(!
ùx
->
»fs
)

1756  -
ENOMEM
;

1758 ià(!
ùx
->
roÙs
) {

1759 
ùx
->
roÙs
 = 
	`uli¡_®loc
(
GFP_NOFS
);

1760 ià(!
ùx
->
roÙs
) {

1761 
	`uli¡_ä“
(
ùx
->
»fs
);

1762 
ùx
->
»fs
 = 
NULL
;

1763  -
ENOMEM
;

1765 
roÙs_uli¡_®loÿ‹d
 = 
Œue
;

1768 
ùx
->
sk_šode_»f_li¡
 = 
Œue
;

1770 
	`ULIST_ITER_INIT
(&
u™”
);

1772 
uli¡_node
 *
node
;

1774 
»t
 = 
	`fšd_·»Á_nodes
(
ùx
, 
NULL
);

1775 ià(
»t
 < 0 &&„‘ !ğ-
ENOENT
) {

1776 ià(
roÙs_uli¡_®loÿ‹d
) {

1777 
	`uli¡_ä“
(
ùx
->
roÙs
);

1778 
ùx
->
roÙs
 = 
NULL
;

1782 
»t
 = 0;

1783 
node
 = 
	`uli¡_Ãxt
(
ùx
->
»fs
, &
u™”
);

1784 ià(!
node
)

1786 
ùx
->
by‹Ä
 = 
node
->
v®
;

1787 
	`cÚd_»sched
();

1790 
	`uli¡_ä“
(
ùx
->
»fs
);

1791 
ùx
->
»fs
 = 
NULL
;

1792 
ùx
->
by‹Ä
 = 
Üig_by‹Ä
;

1793 
ùx
->
sk_šode_»f_li¡
 = 
Üig_sk_šode_»f_li¡
;

1795  
»t
;

1796 
	}
}

1798 
	$bŒfs_fšd_®l_roÙs
(
bŒfs_back»f_w®k_ùx
 *
ùx
,

1799 
boŞ
 
sk_comm™_roÙ_£m
)

1801 
»t
;

1803 ià(!
ùx
->
Œªs
 && !
sk_comm™_roÙ_£m
)

1804 
	`down_»ad
(&
ùx
->
fs_šfo
->
comm™_roÙ_£m
);

1805 
»t
 = 
	`bŒfs_fšd_®l_roÙs_§ã
(
ùx
);

1806 ià(!
ùx
->
Œªs
 && !
sk_comm™_roÙ_£m
)

1807 
	`up_»ad
(&
ùx
->
fs_šfo
->
comm™_roÙ_£m
);

1808  
»t
;

1809 
	}
}

1811 
bŒfs_back»f_sh¬e_check_ùx
 *
	$bŒfs_®loc_back»f_sh¬e_check_ùx
()

1813 
bŒfs_back»f_sh¬e_check_ùx
 *
ùx
;

1815 
ùx
 = 
	`kz®loc
((*ùx), 
GFP_KERNEL
);

1816 ià(!
ùx
)

1817  
NULL
;

1819 
	`uli¡_š™
(&
ùx
->
»fs
);

1821  
ùx
;

1822 
	}
}

1824 
	$bŒfs_ä“_back»f_sh¬e_ùx
(
bŒfs_back»f_sh¬e_check_ùx
 *
ùx
)

1826 ià(!
ùx
)

1829 
	`uli¡_»Ëa£
(&
ùx
->
»fs
);

1830 
	`kä“
(
ùx
);

1831 
	}
}

1853 
	$bŒfs_is_d©a_ex‹Á_sh¬ed
(
bŒfs_šode
 *
šode
, 
u64
 
by‹Ä
,

1854 
u64
 
ex‹Á_g’
,

1855 
bŒfs_back»f_sh¬e_check_ùx
 *
ùx
)

1857 
bŒfs_back»f_w®k_ùx
 
w®k_ùx
 = { 0 };

1858 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

1859 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1860 
bŒfs_Œªs_hªdË
 *
Œªs
;

1861 
uli¡_™”©Ü
 
u™”
;

1862 
uli¡_node
 *
node
;

1863 
bŒfs_£q_li¡
 
–em
 = 
	`BTRFS_SEQ_LIST_INIT
(elem);

1864 
»t
 = 0;

1865 
sh¬e_check
 
sh¬ed
 = {

1866 .
ùx
 = ctx,

1867 .
roÙ
 =„oot,

1868 .
šum
 = 
	`bŒfs_šo
(
šode
),

1869 .
d©a_by‹Ä
 = 
by‹Ä
,

1870 .
d©a_ex‹Á_g’
 = 
ex‹Á_g’
,

1871 .
sh¬e_couÁ
 = 0,

1872 .
£lf_»f_couÁ
 = 0,

1873 .
have_d–ayed_d–‘e_»fs
 = 
çl£
,

1875 
Ëv–
;

1876 
boŞ
 
Ëaf_ÿched
;

1877 
boŞ
 
Ëaf_is_sh¬ed
;

1879 
i
 = 0; i < 
BTRFS_BACKREF_CTX_PREV_EXTENTS_SIZE
; i++) {

1880 ià(
ùx
->
´ev_ex‹Ás_ÿche
[
i
].
by‹Ä
 == bytenr)

1881  
ùx
->
´ev_ex‹Ás_ÿche
[
i
].
is_sh¬ed
;

1884 
	`uli¡_š™
(&
ùx
->
»fs
);

1886 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ_no¡¬t
(
roÙ
);

1887 ià(
	`IS_ERR
(
Œªs
)) {

1888 ià(
	`PTR_ERR
(
Œªs
è!ğ-
ENOENT
 && PTR_ERRÑ¿nsè!ğ-
EROFS
) {

1889 
»t
 = 
	`PTR_ERR
(
Œªs
);

1890 
out
;

1892 
Œªs
 = 
NULL
;

1893 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

1895 
	`bŒfs_g‘_Œ“_mod_£q
(
fs_šfo
, &
–em
);

1896 
w®k_ùx
.
time_£q
 = 
–em
.
£q
;

1899 
ùx
->
u£_·th_ÿche
 = 
Œue
;

1908 
Ëaf_ÿched
 = 
	`lookup_back»f_sh¬ed_ÿche
(
ùx
, 
roÙ
,

1909 
ùx
->
cu¼_Ëaf_by‹Ä
, 0,

1910 &
Ëaf_is_sh¬ed
);

1911 ià(
Ëaf_ÿched
 && 
Ëaf_is_sh¬ed
) {

1912 
»t
 = 1;

1913 
out_Œªs
;

1916 
w®k_ùx
.
sk_šode_»f_li¡
 = 
Œue
;

1917 
w®k_ùx
.
Œªs
 =rans;

1918 
w®k_ùx
.
fs_šfo
 = fs_info;

1919 
w®k_ùx
.
»fs
 = &
ùx
->refs;

1922 
Ëv–
 = -1;

1923 
	`ULIST_ITER_INIT
(&
u™”
);

1925 cÚ¡ 
´ev_»f_couÁ
 = 
ùx
->
»fs
.
Âodes
;

1927 
w®k_ùx
.
by‹Ä
 = bytenr;

1928 
»t
 = 
	`fšd_·»Á_nodes
(&
w®k_ùx
, &
sh¬ed
);

1929 ià(
»t
 =ğ
BACKREF_FOUND_SHARED
 ||

1930 
»t
 =ğ
BACKREF_FOUND_NOT_SHARED
) {

1932 
»t
 = (»ˆ=ğ
BACKREF_FOUND_SHARED
) ? 1 : 0;

1933 ià(
Ëv–
 >= 0)

1934 
	`¡Üe_back»f_sh¬ed_ÿche
(
ùx
, 
roÙ
, 
by‹Ä
,

1935 
Ëv–
, 
»t
 == 1);

1938 ià(
»t
 < 0 &&„‘ !ğ-
ENOENT
)

1940 
»t
 = 0;

1972 ià((
ùx
->
»fs
.
Âodes
 - 
´ev_»f_couÁ
) > 1)

1973 
ùx
->
u£_·th_ÿche
 = 
çl£
;

1975 ià(
Ëv–
 >= 0)

1976 
	`¡Üe_back»f_sh¬ed_ÿche
(
ùx
, 
roÙ
, 
by‹Ä
,

1977 
Ëv–
, 
çl£
);

1978 
node
 = 
	`uli¡_Ãxt
(&
ùx
->
»fs
, &
u™”
);

1979 ià(!
node
)

1981 
by‹Ä
 = 
node
->
v®
;

1982 ià(
ùx
->
u£_·th_ÿche
) {

1983 
boŞ
 
is_sh¬ed
;

1984 
boŞ
 
ÿched
;

1986 
Ëv–
++;

1987 
ÿched
 = 
	`lookup_back»f_sh¬ed_ÿche
(
ùx
, 
roÙ
, 
by‹Ä
,

1988 
Ëv–
, &
is_sh¬ed
);

1989 ià(
ÿched
) {

1990 
»t
 = (
is_sh¬ed
 ? 1 : 0);

1994 
sh¬ed
.
sh¬e_couÁ
 = 0;

1995 
sh¬ed
.
have_d–ayed_d–‘e_»fs
 = 
çl£
;

1996 
	`cÚd_»sched
();

2006 ià(!
ùx
->
u£_·th_ÿche
) {

2007 
i
 = 0;

2009 
Ëv–
--;

2010 ià(
»t
 >ğ0 && 
Ëv–
 >= 0) {

2011 
by‹Ä
 = 
ùx
->
·th_ÿche_’Œ›s
[
Ëv–
].bytenr;

2012 
ùx
->
u£_·th_ÿche
 = 
Œue
;

2013 
	`¡Üe_back»f_sh¬ed_ÿche
(
ùx
, 
roÙ
, 
by‹Ä
, 
Ëv–
, 
»t
);

2014 
i
 = 
Ëv–
 + 1;

2017  ; 
i
 < 
BTRFS_MAX_LEVEL
; i++)

2018 
ùx
->
·th_ÿche_’Œ›s
[
i
].
by‹Ä
 = 0;

2025 ià(
»t
 >ğ0 && 
sh¬ed
.
£lf_»f_couÁ
 > 1) {

2026 
¦Ù
 = 
ùx
->
´ev_ex‹Ás_ÿche_¦Ù
;

2028 
ùx
->
´ev_ex‹Ás_ÿche
[
¦Ù
].
by‹Ä
 = 
sh¬ed
.
d©a_by‹Ä
;

2029 
ùx
->
´ev_ex‹Ás_ÿche
[
¦Ù
].
is_sh¬ed
 = (
»t
 == 1);

2031 
¦Ù
 = (¦Ù + 1è% 
BTRFS_BACKREF_CTX_PREV_EXTENTS_SIZE
;

2032 
ùx
->
´ev_ex‹Ás_ÿche_¦Ù
 = 
¦Ù
;

2035 
out_Œªs
:

2036 ià(
Œªs
) {

2037 
	`bŒfs_put_Œ“_mod_£q
(
fs_šfo
, &
–em
);

2038 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2040 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

2042 
out
:

2043 
	`uli¡_»Ëa£
(&
ùx
->
»fs
);

2044 
ùx
->
´ev_Ëaf_by‹Ä
 = ctx->
cu¼_Ëaf_by‹Ä
;

2046  
»t
;

2047 
	}
}

2049 
	$bŒfs_fšd_Úe_exŒef
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
šode_objeùid
,

2050 
u64
 
¡¬t_off
, 
bŒfs_·th
 *
·th
,

2051 
bŒfs_šode_exŒef
 **
»t_exŒef
,

2052 
u64
 *
found_off
)

2054 
»t
, 
¦Ù
;

2055 
bŒfs_key
 
key
;

2056 
bŒfs_key
 
found_key
;

2057 
bŒfs_šode_exŒef
 *
exŒef
;

2058 cÚ¡ 
ex‹Á_bufãr
 *
Ëaf
;

2059 
±r
;

2061 
key
.
objeùid
 = 
šode_objeùid
;

2062 
key
.
ty³
 = 
BTRFS_INODE_EXTREF_KEY
;

2063 
key
.
off£t
 = 
¡¬t_off
;

2065 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

2066 ià(
»t
 < 0)

2067  
»t
;

2070 
Ëaf
 = 
·th
->
nodes
[0];

2071 
¦Ù
 = 
·th
->
¦Ùs
[0];

2072 ià(
¦Ù
 >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

2082 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

2083 ià(
»t
) {

2084 ià(
»t
 >= 1)

2085 
»t
 = -
ENOENT
;

2091 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
¦Ù
);

2099 
»t
 = -
ENOENT
;

2100 ià(
found_key
.
objeùid
 !ğ
šode_objeùid
)

2102 ià(
found_key
.
ty³
 !ğ
BTRFS_INODE_EXTREF_KEY
)

2105 
»t
 = 0;

2106 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

2107 
exŒef
 = (
bŒfs_šode_exŒef
 *)
±r
;

2108 *
»t_exŒef
 = 
exŒef
;

2109 ià(
found_off
)

2110 *
found_off
 = 
found_key
.
off£t
;

2114  
»t
;

2115 
	}
}

2131 *
	$bŒfs_»f_to_·th
(
bŒfs_roÙ
 *
fs_roÙ
, 
bŒfs_·th
 *
·th
,

2132 
u32
 
Çme_Ën
, 
Çme_off
,

2133 
ex‹Á_bufãr
 *
eb_š
, 
u64
 
·»Á
,

2134 *
de¡
, 
u32
 
size
)

2136 
¦Ù
;

2137 
u64
 
Ãxt_šum
;

2138 
»t
;

2139 
s64
 
by‹s_Ëá
 = ((s64)
size
) - 1;

2140 
ex‹Á_bufãr
 *
eb
 = 
eb_š
;

2141 
bŒfs_key
 
found_key
;

2142 
bŒfs_šode_»f
 *
œef
;

2144 ià(
by‹s_Ëá
 >= 0)

2145 
de¡
[
by‹s_Ëá
] = '\0';

2148 
by‹s_Ëá
 -ğ
Çme_Ën
;

2149 ià(
by‹s_Ëá
 >= 0)

2150 
	`»ad_ex‹Á_bufãr
(
eb
, 
de¡
 + 
by‹s_Ëá
,

2151 
Çme_off
, 
Çme_Ën
);

2152 ià(
eb
 !ğ
eb_š
) {

2153 ià(!
·th
->
sk_lockšg
)

2154 
	`bŒfs_Œ“_»ad_uÆock
(
eb
);

2155 
	`ä“_ex‹Á_bufãr
(
eb
);

2157 
»t
 = 
	`bŒfs_fšd_™em
(
fs_roÙ
, 
·th
, 
·»Á
, 0,

2158 
BTRFS_INODE_REF_KEY
, &
found_key
);

2159 ià(
»t
 > 0)

2160 
»t
 = -
ENOENT
;

2161 ià(
»t
)

2164 
Ãxt_šum
 = 
found_key
.
off£t
;

2167 ià(
·»Á
 =ğ
Ãxt_šum
)

2170 
¦Ù
 = 
·th
->
¦Ùs
[0];

2171 
eb
 = 
·th
->
nodes
[0];

2173 ià(
eb
 !ğ
eb_š
) {

2174 
·th
->
nodes
[0] = 
NULL
;

2175 
·th
->
locks
[0] = 0;

2177 
	`bŒfs_»Ëa£_·th
(
·th
);

2178 
œef
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_šode_»f
);

2180 
Çme_Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
eb
, 
œef
);

2181 
Çme_off
 = ()(
œef
 + 1);

2183 
·»Á
 = 
Ãxt_šum
;

2184 --
by‹s_Ëá
;

2185 ià(
by‹s_Ëá
 >= 0)

2186 
de¡
[
by‹s_Ëá
] = '/';

2189 
	`bŒfs_»Ëa£_·th
(
·th
);

2191 ià(
»t
)

2192  
	`ERR_PTR
(
»t
);

2194  
de¡
 + 
by‹s_Ëá
;

2195 
	}
}

2202 
	$ex‹Á_äom_logiÿl
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
,

2203 
bŒfs_·th
 *
·th
, 
bŒfs_key
 *
found_key
,

2204 
u64
 *
æags_»t
)

2206 
bŒfs_roÙ
 *
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 
logiÿl
);

2207 
»t
;

2208 
u64
 
æags
;

2209 
u64
 
size
 = 0;

2210 
u32
 
™em_size
;

2211 cÚ¡ 
ex‹Á_bufãr
 *
eb
;

2212 
bŒfs_ex‹Á_™em
 *
ei
;

2213 
bŒfs_key
 
key
;

2215 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
))

2216 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

2218 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

2219 
key
.
objeùid
 = 
logiÿl
;

2220 
key
.
off£t
 = (
u64
)-1;

2222 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
ex‹Á_roÙ
, &
key
, 
·th
, 0, 0);

2223 ià(
»t
 < 0)

2224  
»t
;

2226 
»t
 = 
	`bŒfs_´evious_ex‹Á_™em
(
ex‹Á_roÙ
, 
·th
, 0);

2227 ià(
»t
) {

2228 ià(
»t
 > 0)

2229 
»t
 = -
ENOENT
;

2230  
»t
;

2232 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], 
found_key
,…©h->
¦Ùs
[0]);

2233 ià(
found_key
->
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
)

2234 
size
 = 
fs_šfo
->
nodesize
;

2235 ià(
found_key
->
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
)

2236 
size
 = 
found_key
->
off£t
;

2238 ià(
found_key
->
objeùid
 > 
logiÿl
 ||

2239 
found_key
->
objeùid
 + 
size
 <ğ
logiÿl
) {

2240 
	`bŒfs_debug
(
fs_šfo
,

2241 "logiÿÈ%Îu i nÙ w™hš‡nyƒx‹Á", 
logiÿl
);

2242  -
ENOENT
;

2245 
eb
 = 
·th
->
nodes
[0];

2246 
™em_size
 = 
	`bŒfs_™em_size
(
eb
, 
·th
->
¦Ùs
[0]);

2247 
	`BUG_ON
(
™em_size
 < (*
ei
));

2249 
ei
 = 
	`bŒfs_™em_±r
(
eb
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

2250 
æags
 = 
	`bŒfs_ex‹Á_æags
(
eb
, 
ei
);

2252 
	`bŒfs_debug
(
fs_šfo
,

2254 
logiÿl
,†ogiÿÈ- 
found_key
->
objeùid
, found_key->objectid,

2255 
found_key
->
off£t
, 
æags
, 
™em_size
);

2257 
	`WARN_ON
(!
æags_»t
);

2258 ià(
æags_»t
) {

2259 ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
)

2260 *
æags_»t
 = 
BTRFS_EXTENT_FLAG_TREE_BLOCK
;

2261 ià(
æags
 & 
BTRFS_EXTENT_FLAG_DATA
)

2262 *
æags_»t
 = 
BTRFS_EXTENT_FLAG_DATA
;

2264 
	`BUG
();

2268  -
EIO
;

2269 
	}
}

2279 
	$g‘_ex‹Á_šlše_»f
(*
±r
,

2280 cÚ¡ 
ex‹Á_bufãr
 *
eb
,

2281 cÚ¡ 
bŒfs_key
 *
key
,

2282 cÚ¡ 
bŒfs_ex‹Á_™em
 *
ei
,

2283 
u32
 
™em_size
,

2284 
bŒfs_ex‹Á_šlše_»f
 **
out_eœef
,

2285 *
out_ty³
)

2287 
’d
;

2288 
u64
 
æags
;

2289 
bŒfs_Œ“_block_šfo
 *
šfo
;

2291 ià(!*
±r
) {

2293 
æags
 = 
	`bŒfs_ex‹Á_æags
(
eb
, 
ei
);

2294 ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

2295 ià(
key
->
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
) {

2297 *
out_eœef
 =

2298 (
bŒfs_ex‹Á_šlše_»f
 *)(
ei
 + 1);

2300 
	`WARN_ON
(
key
->
ty³
 !ğ
BTRFS_EXTENT_ITEM_KEY
);

2301 
šfo
 = (
bŒfs_Œ“_block_šfo
 *)(
ei
 + 1);

2302 *
out_eœef
 =

2303 (
bŒfs_ex‹Á_šlše_»f
 *)(
šfo
 + 1);

2306 *
out_eœef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
ei
 + 1);

2308 *
±r
 = ()*
out_eœef
;

2309 ià(()(*
±r
è>ğ()
ei
 + 
™em_size
)

2310  -
ENOENT
;

2313 
’d
 = ()
ei
 + 
™em_size
;

2314 *
out_eœef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(*
±r
);

2315 *
out_ty³
 = 
	`bŒfs_g‘_ex‹Á_šlše_»f_ty³
(
eb
, *
out_eœef
,

2316 
BTRFS_REF_TYPE_ANY
);

2317 ià(*
out_ty³
 =ğ
BTRFS_REF_TYPE_INVALID
)

2318  -
EUCLEAN
;

2320 *
±r
 +ğ
	`bŒfs_ex‹Á_šlše_»f_size
(*
out_ty³
);

2321 
	`WARN_ON
(*
±r
 > 
’d
);

2322 ià(*
±r
 =ğ
’d
)

2326 
	}
}

2335 
	$Œ“_back»f_fÜ_ex‹Á
(*
±r
, 
ex‹Á_bufãr
 *
eb
,

2336 
bŒfs_key
 *
key
, 
bŒfs_ex‹Á_™em
 *
ei
,

2337 
u32
 
™em_size
, 
u64
 *
out_roÙ
, 
u8
 *
out_Ëv–
)

2339 
»t
;

2340 
ty³
;

2341 
bŒfs_ex‹Á_šlše_»f
 *
eœef
;

2343 ià(*
±r
 == ()-1)

2347 
»t
 = 
	`g‘_ex‹Á_šlše_»f
(
±r
, 
eb
, 
key
, 
ei
, 
™em_size
,

2348 &
eœef
, &
ty³
);

2349 ià(
»t
 < 0)

2350  
»t
;

2352 ià(
ty³
 =ğ
BTRFS_TREE_BLOCK_REF_KEY
 ||

2353 
ty³
 =ğ
BTRFS_SHARED_BLOCK_REF_KEY
)

2356 ià(
»t
 == 1)

2361 *
out_roÙ
 = 
	`bŒfs_ex‹Á_šlše_»f_off£t
(
eb
, 
eœef
);

2363 ià(
key
->
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
) {

2364 
bŒfs_Œ“_block_šfo
 *
šfo
;

2366 
šfo
 = (
bŒfs_Œ“_block_šfo
 *)(
ei
 + 1);

2367 *
out_Ëv–
 = 
	`bŒfs_Œ“_block_Ëv–
(
eb
, 
šfo
);

2369 
	`ASSERT
(
key
->
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
);

2370 *
out_Ëv–
 = (
u8
)
key
->
off£t
;

2373 ià(
»t
 == 1)

2374 *
±r
 = ()-1;

2377 
	}
}

2379 
	$™”©e_Ëaf_»fs
(
bŒfs_fs_šfo
 *
fs_šfo
,

2380 
ex‹Á_šode_–em
 *
šode_li¡
,

2381 
u64
 
roÙ
, u64 
ex‹Á_™em_objeùid
,

2382 
™”©e_ex‹Á_šodes_t
 *
™”©e
, *
ùx
)

2384 
ex‹Á_šode_–em
 *
e›
;

2385 
»t
 = 0;

2387 
e›
 = 
šode_li¡
;ƒ›;ƒ› =ƒ›->
Ãxt
) {

2388 
	`bŒfs_debug
(
fs_šfo
,

2390 
ex‹Á_™em_objeùid
, 
e›
->
šum
,

2391 
e›
->
off£t
, 
roÙ
);

2392 
»t
 = 
	`™”©e
(
e›
->
šum
,ƒ›->
off£t
,ƒ›->
num_by‹s
, 
roÙ
, 
ùx
);

2393 ià(
»t
) {

2394 
	`bŒfs_debug
(
fs_šfo
,

2396 
ex‹Á_™em_objeùid
, 
»t
);

2401  
»t
;

2402 
	}
}

2409 
	$™”©e_ex‹Á_šodes
(
bŒfs_back»f_w®k_ùx
 *
ùx
,

2410 
boŞ
 
£¬ch_comm™_roÙ
,

2411 
™”©e_ex‹Á_šodes_t
 *
™”©e
, *
u£r_ùx
)

2413 
»t
;

2414 
uli¡
 *
»fs
;

2415 
uli¡_node
 *
»f_node
;

2416 
bŒfs_£q_li¡
 
£q_–em
 = 
	`BTRFS_SEQ_LIST_INIT
(seq_elem);

2417 
uli¡_™”©Ü
 
»f_u™”
;

2419 
	`bŒfs_debug
(
ùx
->
fs_šfo
, "resolving‡ll inodes forƒxtent %llu",

2420 
ùx
->
by‹Ä
);

2422 
	`ASSERT
(
ùx
->
Œªs
 =ğ
NULL
);

2423 
	`ASSERT
(
ùx
->
roÙs
 =ğ
NULL
);

2425 ià(!
£¬ch_comm™_roÙ
) {

2426 
bŒfs_Œªs_hªdË
 *
Œªs
;

2428 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ
(
ùx
->
fs_šfo
->
Œ“_roÙ
);

2429 ià(
	`IS_ERR
(
Œªs
)) {

2430 ià(
	`PTR_ERR
(
Œªs
è!ğ-
ENOENT
 &&

2431 
	`PTR_ERR
(
Œªs
è!ğ-
EROFS
)

2432  
	`PTR_ERR
(
Œªs
);

2433 
Œªs
 = 
NULL
;

2435 
ùx
->
Œªs
 =rans;

2438 ià(
ùx
->
Œªs
) {

2439 
	`bŒfs_g‘_Œ“_mod_£q
(
ùx
->
fs_šfo
, &
£q_–em
);

2440 
ùx
->
time_£q
 = 
£q_–em
.
£q
;

2442 
	`down_»ad
(&
ùx
->
fs_šfo
->
comm™_roÙ_£m
);

2445 
»t
 = 
	`bŒfs_fšd_®l_Ëafs
(
ùx
);

2446 ià(
»t
)

2447 
out
;

2448 
»fs
 = 
ùx
->refs;

2449 
ùx
->
»fs
 = 
NULL
;

2451 
	`ULIST_ITER_INIT
(&
»f_u™”
);

2452 !
»t
 && (
»f_node
 = 
	`uli¡_Ãxt
(
»fs
, &
»f_u™”
))) {

2453 cÚ¡ 
u64
 
Ëaf_by‹Ä
 = 
»f_node
->
v®
;

2454 
uli¡_node
 *
roÙ_node
;

2455 
uli¡_™”©Ü
 
roÙ_u™”
;

2456 
ex‹Á_šode_–em
 *
šode_li¡
;

2458 
šode_li¡
 = (
ex‹Á_šode_–em
 *)(
ušŒ_t
)
»f_node
->
aux
;

2460 ià(
ùx
->
ÿche_lookup
) {

2461 cÚ¡ 
u64
 *
roÙ_ids
;

2462 
roÙ_couÁ
;

2463 
boŞ
 
ÿched
;

2465 
ÿched
 = 
ùx
->
	`ÿche_lookup
(
Ëaf_by‹Ä
, ctx->
u£r_ùx
,

2466 &
roÙ_ids
, &
roÙ_couÁ
);

2467 ià(
ÿched
) {

2468 
i
 = 0; i < 
roÙ_couÁ
; i++) {

2469 
»t
 = 
	`™”©e_Ëaf_»fs
(
ùx
->
fs_šfo
,

2470 
šode_li¡
,

2471 
roÙ_ids
[
i
],

2472 
Ëaf_by‹Ä
,

2473 
™”©e
,

2474 
u£r_ùx
);

2475 ià(
»t
)

2482 ià(!
ùx
->
roÙs
) {

2483 
ùx
->
roÙs
 = 
	`uli¡_®loc
(
GFP_NOFS
);

2484 ià(!
ùx
->
roÙs
) {

2485 
»t
 = -
ENOMEM
;

2490 
ùx
->
by‹Ä
 = 
Ëaf_by‹Ä
;

2491 
»t
 = 
	`bŒfs_fšd_®l_roÙs_§ã
(
ùx
);

2492 ià(
»t
)

2495 ià(
ùx
->
ÿche_¡Üe
)

2496 
ùx
->
	`ÿche_¡Üe
(
Ëaf_by‹Ä
, ctx->
roÙs
, ctx->
u£r_ùx
);

2498 
	`ULIST_ITER_INIT
(&
roÙ_u™”
);

2499 !
»t
 && (
roÙ_node
 = 
	`uli¡_Ãxt
(
ùx
->
roÙs
, &
roÙ_u™”
))) {

2500 
	`bŒfs_debug
(
ùx
->
fs_šfo
,

2502 
roÙ_node
->
v®
, 
»f_node
->val,

2503 
»f_node
->
aux
);

2504 
»t
 = 
	`™”©e_Ëaf_»fs
(
ùx
->
fs_šfo
, 
šode_li¡
,

2505 
roÙ_node
->
v®
, 
ùx
->
by‹Ä
,

2506 
™”©e
, 
u£r_ùx
);

2508 
	`uli¡_»š™
(
ùx
->
roÙs
);

2511 
	`ä“_Ëaf_li¡
(
»fs
);

2512 
out
:

2513 ià(
ùx
->
Œªs
) {

2514 
	`bŒfs_put_Œ“_mod_£q
(
ùx
->
fs_šfo
, &
£q_–em
);

2515 
	`bŒfs_’d_Œª§ùiÚ
(
ùx
->
Œªs
);

2516 
ùx
->
Œªs
 = 
NULL
;

2518 
	`up_»ad
(&
ùx
->
fs_šfo
->
comm™_roÙ_£m
);

2521 
	`uli¡_ä“
(
ùx
->
roÙs
);

2522 
ùx
->
roÙs
 = 
NULL
;

2524 ià(
»t
 =ğ
BTRFS_ITERATE_EXTENT_INODES_STOP
)

2525 
»t
 = 0;

2527  
»t
;

2528 
	}
}

2530 
	$bud_šo_li¡
(
u64
 
šum
, u64 
off£t
, u64 
num_by‹s
, u64 
roÙ
, *
ùx
)

2532 
bŒfs_d©a_cÚš”
 *
šodes
 = 
ùx
;

2533 cÚ¡ 
size_t
 
c
 = 3 * (
u64
);

2535 ià(
šodes
->
by‹s_Ëá
 >ğ
c
) {

2536 
šodes
->
by‹s_Ëá
 -ğ
c
;

2537 
šodes
->
v®
[šodes->
–em_út
] = 
šum
;

2538 
šodes
->
v®
[šodes->
–em_út
 + 1] = 
off£t
;

2539 
šodes
->
v®
[šodes->
–em_út
 + 2] = 
roÙ
;

2540 
šodes
->
–em_út
 += 3;

2542 
šodes
->
by‹s_missšg
 +ğ
c
 - inodes->
by‹s_Ëá
;

2543 
šodes
->
by‹s_Ëá
 = 0;

2544 
šodes
->
–em_mis£d
 += 3;

2548 
	}
}

2550 
	$™”©e_šodes_äom_logiÿl
(
u64
 
logiÿl
, 
bŒfs_fs_šfo
 *
fs_šfo
,

2551 
bŒfs_·th
 *
·th
,

2552 *
ùx
, 
boŞ
 
ignÜe_off£t
)

2554 
bŒfs_back»f_w®k_ùx
 
w®k_ùx
 = { 0 };

2555 
»t
;

2556 
u64
 
æags
 = 0;

2557 
bŒfs_key
 
found_key
;

2558 
£¬ch_comm™_roÙ
 = 
·th
->search_commit_root;

2560 
»t
 = 
	`ex‹Á_äom_logiÿl
(
fs_šfo
, 
logiÿl
, 
·th
, &
found_key
, &
æags
);

2561 
	`bŒfs_»Ëa£_·th
(
·th
);

2562 ià(
»t
 < 0)

2563  
»t
;

2564 ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
)

2565  -
EINVAL
;

2567 
w®k_ùx
.
by‹Ä
 = 
found_key
.
objeùid
;

2568 ià(
ignÜe_off£t
)

2569 
w®k_ùx
.
ignÜe_ex‹Á_™em_pos
 = 
Œue
;

2571 
w®k_ùx
.
ex‹Á_™em_pos
 = 
logiÿl
 - 
found_key
.
objeùid
;

2572 
w®k_ùx
.
fs_šfo
 = fs_info;

2574  
	`™”©e_ex‹Á_šodes
(&
w®k_ùx
, 
£¬ch_comm™_roÙ
,

2575 
bud_šo_li¡
, 
ùx
);

2576 
	}
}

2578 
šode_to_·th
(
u64
 
šum
, 
u32
 
Çme_Ën
, 
Çme_off
,

2579 
ex‹Á_bufãr
 *
eb
, 
šode_fs_·ths
 *
©h
);

2581 
	$™”©e_šode_»fs
(
u64
 
šum
, 
šode_fs_·ths
 *
©h
)

2583 
»t
 = 0;

2584 
¦Ù
;

2585 
u32
 
cur
;

2586 
u32
 
Ën
;

2587 
u32
 
Çme_Ën
;

2588 
u64
 
·»Á
 = 0;

2589 
found
 = 0;

2590 
bŒfs_roÙ
 *
fs_roÙ
 = 
©h
->fs_root;

2591 
bŒfs_·th
 *
·th
 = 
©h
->btrfs_path;

2592 
ex‹Á_bufãr
 *
eb
;

2593 
bŒfs_šode_»f
 *
œef
;

2594 
bŒfs_key
 
found_key
;

2596 !
»t
) {

2597 
»t
 = 
	`bŒfs_fšd_™em
(
fs_roÙ
, 
·th
, 
šum
,

2598 
·»Á
 ?…¬’ˆ+ 1 : 0, 
BTRFS_INODE_REF_KEY
,

2599 &
found_key
);

2601 ià(
»t
 < 0)

2603 ià(
»t
) {

2604 
»t
 = 
found
 ? 0 : -
ENOENT
;

2607 ++
found
;

2609 
·»Á
 = 
found_key
.
off£t
;

2610 
¦Ù
 = 
·th
->
¦Ùs
[0];

2611 
eb
 = 
	`bŒfs_şÚe_ex‹Á_bufãr
(
·th
->
nodes
[0]);

2612 ià(!
eb
) {

2613 
»t
 = -
ENOMEM
;

2616 
	`bŒfs_»Ëa£_·th
(
·th
);

2618 
œef
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_šode_»f
);

2620 
cur
 = 0; cu¸< 
	`bŒfs_™em_size
(
eb
, 
¦Ù
); cu¸+ğ
Ën
) {

2621 
Çme_Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
eb
, 
œef
);

2623 
	`bŒfs_debug
(
fs_roÙ
->
fs_šfo
,

2625 
cur
, 
found_key
.
objeùid
,

2626 
fs_roÙ
->
roÙ_key
.
objeùid
);

2627 
»t
 = 
	`šode_to_·th
(
·»Á
, 
Çme_Ën
,

2628 ()(
œef
 + 1), 
eb
, 
©h
);

2629 ià(
»t
)

2631 
Ën
 = (*
œef
è+ 
Çme_Ën
;

2632 
œef
 = (
bŒfs_šode_»f
 *)((*)œeà+ 
Ën
);

2634 
	`ä“_ex‹Á_bufãr
(
eb
);

2637 
	`bŒfs_»Ëa£_·th
(
·th
);

2639  
»t
;

2640 
	}
}

2642 
	$™”©e_šode_exŒefs
(
u64
 
šum
, 
šode_fs_·ths
 *
©h
)

2644 
»t
;

2645 
¦Ù
;

2646 
u64
 
off£t
 = 0;

2647 
u64
 
·»Á
;

2648 
found
 = 0;

2649 
bŒfs_roÙ
 *
fs_roÙ
 = 
©h
->fs_root;

2650 
bŒfs_·th
 *
·th
 = 
©h
->btrfs_path;

2651 
ex‹Á_bufãr
 *
eb
;

2652 
bŒfs_šode_exŒef
 *
exŒef
;

2653 
u32
 
™em_size
;

2654 
u32
 
cur_off£t
;

2655 
±r
;

2658 
»t
 = 
	`bŒfs_fšd_Úe_exŒef
(
fs_roÙ
, 
šum
, 
off£t
, 
·th
, &
exŒef
,

2659 &
off£t
);

2660 ià(
»t
 < 0)

2662 ià(
»t
) {

2663 
»t
 = 
found
 ? 0 : -
ENOENT
;

2666 ++
found
;

2668 
¦Ù
 = 
·th
->
¦Ùs
[0];

2669 
eb
 = 
	`bŒfs_şÚe_ex‹Á_bufãr
(
·th
->
nodes
[0]);

2670 ià(!
eb
) {

2671 
»t
 = -
ENOMEM
;

2674 
	`bŒfs_»Ëa£_·th
(
·th
);

2676 
™em_size
 = 
	`bŒfs_™em_size
(
eb
, 
¦Ù
);

2677 
±r
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

2678 
cur_off£t
 = 0;

2680 
cur_off£t
 < 
™em_size
) {

2681 
u32
 
Çme_Ën
;

2683 
exŒef
 = (
bŒfs_šode_exŒef
 *)(
±r
 + 
cur_off£t
);

2684 
·»Á
 = 
	`bŒfs_šode_exŒef_·»Á
(
eb
, 
exŒef
);

2685 
Çme_Ën
 = 
	`bŒfs_šode_exŒef_Çme_Ën
(
eb
, 
exŒef
);

2686 
»t
 = 
	`šode_to_·th
(
·»Á
, 
Çme_Ën
,

2687 ()&
exŒef
->
Çme
, 
eb
, 
©h
);

2688 ià(
»t
)

2691 
cur_off£t
 +ğ
	`bŒfs_šode_exŒef_Çme_Ën
(
eb
, 
exŒef
);

2692 
cur_off£t
 +ğ(*
exŒef
);

2694 
	`ä“_ex‹Á_bufãr
(
eb
);

2696 
off£t
++;

2699 
	`bŒfs_»Ëa£_·th
(
·th
);

2701  
»t
;

2702 
	}
}

2708 
	$šode_to_·th
(
u64
 
šum
, 
u32
 
Çme_Ën
, 
Çme_off
,

2709 
ex‹Á_bufãr
 *
eb
, 
šode_fs_·ths
 *
©h
)

2711 *
f¥©h
;

2712 *
f¥©h_mš
;

2713 
i
 = 
©h
->
f¥©h
->
–em_út
;

2714 cÚ¡ 
s_±r
 = (*);

2715 
u32
 
by‹s_Ëá
;

2717 
by‹s_Ëá
 = 
©h
->
f¥©h
->by‹s_Ëá > 
s_±r
 ?

2718 
©h
->
f¥©h
->
by‹s_Ëá
 - 
s_±r
 : 0;

2720 
f¥©h_mš
 = (*)
©h
->
f¥©h
->
v®
 + (
i
 + 1è* 
s_±r
;

2721 
f¥©h
 = 
	`bŒfs_»f_to_·th
(
©h
->
fs_roÙ
, i·th->
bŒfs_·th
, 
Çme_Ën
,

2722 
Çme_off
, 
eb
, 
šum
, 
f¥©h_mš
, 
by‹s_Ëá
);

2723 ià(
	`IS_ERR
(
f¥©h
))

2724  
	`PTR_ERR
(
f¥©h
);

2726 ià(
f¥©h
 > 
f¥©h_mš
) {

2727 
©h
->
f¥©h
->
v®
[
i
] = (
u64
)()fspath;

2728 ++
©h
->
f¥©h
->
–em_út
;

2729 
©h
->
f¥©h
->
by‹s_Ëá
 = f¥©h - 
f¥©h_mš
;

2731 ++
©h
->
f¥©h
->
–em_mis£d
;

2732 
©h
->
f¥©h
->
by‹s_missšg
 +ğ
f¥©h_mš
 - fspath;

2733 
©h
->
f¥©h
->
by‹s_Ëá
 = 0;

2737 
	}
}

2749 
	$·ths_äom_šode
(
u64
 
šum
, 
šode_fs_·ths
 *
©h
)

2751 
»t
;

2752 
found_»fs
 = 0;

2754 
»t
 = 
	`™”©e_šode_»fs
(
šum
, 
©h
);

2755 ià(!
»t
)

2756 ++
found_»fs
;

2757 ià(
»t
 !ğ-
ENOENT
)

2758  
»t
;

2760 
»t
 = 
	`™”©e_šode_exŒefs
(
šum
, 
©h
);

2761 ià(
»t
 =ğ-
ENOENT
 && 
found_»fs
)

2764  
»t
;

2765 
	}
}

2767 
bŒfs_d©a_cÚš”
 *
	$š™_d©a_cÚš”
(
u32
 
tÙ®_by‹s
)

2769 
bŒfs_d©a_cÚš”
 *
d©a
;

2770 
size_t
 
®loc_by‹s
;

2772 
®loc_by‹s
 = 
	`max_t
(
size_t
, 
tÙ®_by‹s
, (*
d©a
));

2773 
d©a
 = 
	`kvm®loc
(
®loc_by‹s
, 
GFP_KERNEL
);

2774 ià(!
d©a
)

2775  
	`ERR_PTR
(-
ENOMEM
);

2777 ià(
tÙ®_by‹s
 >ğ(*
d©a
)) {

2778 
d©a
->
by‹s_Ëá
 = 
tÙ®_by‹s
 - (*data);

2779 
d©a
->
by‹s_missšg
 = 0;

2781 
d©a
->
by‹s_missšg
 = (*d©aè- 
tÙ®_by‹s
;

2782 
d©a
->
by‹s_Ëá
 = 0;

2785 
d©a
->
–em_út
 = 0;

2786 
d©a
->
–em_mis£d
 = 0;

2788  
d©a
;

2789 
	}
}

2797 
šode_fs_·ths
 *
	$š™_©h
(
s32
 
tÙ®_by‹s
, 
bŒfs_roÙ
 *
fs_roÙ
,

2798 
bŒfs_·th
 *
·th
)

2800 
šode_fs_·ths
 *
iå
;

2801 
bŒfs_d©a_cÚš”
 *
f¥©h
;

2803 
f¥©h
 = 
	`š™_d©a_cÚš”
(
tÙ®_by‹s
);

2804 ià(
	`IS_ERR
(
f¥©h
))

2805  
	`ERR_CAST
(
f¥©h
);

2807 
iå
 = 
	`km®loc
((*iå), 
GFP_KERNEL
);

2808 ià(!
iå
) {

2809 
	`kvä“
(
f¥©h
);

2810  
	`ERR_PTR
(-
ENOMEM
);

2813 
iå
->
bŒfs_·th
 = 
·th
;

2814 
iå
->
f¥©h
 = fspath;

2815 
iå
->
fs_roÙ
 = fs_root;

2817  
iå
;

2818 
	}
}

2820 
	$ä“_©h
(
šode_fs_·ths
 *
©h
)

2822 ià(!
©h
)

2824 
	`kvä“
(
©h
->
f¥©h
);

2825 
	`kä“
(
©h
);

2826 
	}
}

2828 
bŒfs_back»f_™”
 *
	$bŒfs_back»f_™”_®loc
(
bŒfs_fs_šfo
 *
fs_šfo
)

2830 
bŒfs_back»f_™”
 *
»t
;

2832 
»t
 = 
	`kz®loc
((*»t), 
GFP_NOFS
);

2833 ià(!
»t
)

2834  
NULL
;

2836 
»t
->
·th
 = 
	`bŒfs_®loc_·th
();

2837 ià(!
»t
->
·th
) {

2838 
	`kä“
(
»t
);

2839  
NULL
;

2843 
»t
->
·th
->
£¬ch_comm™_roÙ
 = 1;

2844 
»t
->
·th
->
sk_lockšg
 = 1;

2845 
»t
->
fs_šfo
 = fs_info;

2847  
»t
;

2848 
	}
}

2850 
	$bŒfs_back»f_™”_¡¬t
(
bŒfs_back»f_™”
 *
™”
, 
u64
 
by‹Ä
)

2852 
bŒfs_fs_šfo
 *
fs_šfo
 = 
™”
->fs_info;

2853 
bŒfs_roÙ
 *
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 
by‹Ä
);

2854 
bŒfs_·th
 *
·th
 = 
™”
->path;

2855 
bŒfs_ex‹Á_™em
 *
ei
;

2856 
bŒfs_key
 
key
;

2857 
»t
;

2859 
key
.
objeùid
 = 
by‹Ä
;

2860 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

2861 
key
.
off£t
 = (
u64
)-1;

2862 
™”
->
by‹Ä
 = bytenr;

2864 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
ex‹Á_roÙ
, &
key
, 
·th
, 0, 0);

2865 ià(
»t
 < 0)

2866  
»t
;

2867 ià(
»t
 == 0) {

2868 
»t
 = -
EUCLEAN
;

2869 
»Ëa£
;

2871 ià(
·th
->
¦Ùs
[0] == 0) {

2872 
	`WARN_ON
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
));

2873 
»t
 = -
EUCLEAN
;

2874 
»Ëa£
;

2876 
·th
->
¦Ùs
[0]--;

2878 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

2879 ià((
key
.
ty³
 !ğ
BTRFS_EXTENT_ITEM_KEY
 &&

2880 
key
.
ty³
 !ğ
BTRFS_METADATA_ITEM_KEY
è|| key.
objeùid
 !ğ
by‹Ä
) {

2881 
»t
 = -
ENOENT
;

2882 
»Ëa£
;

2884 
	`memıy
(&
™”
->
cur_key
, &
key
, (key));

2885 
™”
->
™em_±r
 = (
u32
)
	`bŒfs_™em_±r_off£t
(
·th
->
nodes
[0],

2886 
·th
->
¦Ùs
[0]);

2887 
™”
->
’d_±r
 = (
u32
)(™”->
™em_±r
 +

2888 
	`bŒfs_™em_size
(
·th
->
nodes
[0],…©h->
¦Ùs
[0]));

2889 
ei
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

2890 
bŒfs_ex‹Á_™em
);

2899 ià(
	`bŒfs_ex‹Á_æags
(
·th
->
nodes
[0], 
ei
è& 
BTRFS_EXTENT_FLAG_DATA
) {

2900 
»t
 = -
ENOTSUPP
;

2901 
»Ëa£
;

2903 
™”
->
cur_±r
 = (
u32
)(™”->
™em_±r
 + (*
ei
));

2906 ià(
™”
->
cur_±r
 >ğ™”->
’d_±r
) {

2907 
»t
 = 
	`bŒfs_Ãxt_™em
(
ex‹Á_roÙ
, 
·th
);

2910 ià(
»t
 > 0) {

2911 
»t
 = -
ENOENT
;

2912 
»Ëa£
;

2914 ià(
»t
 < 0)

2915 
»Ëa£
;

2917 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
™”
->
cur_key
,

2918 
·th
->
¦Ùs
[0]);

2919 ià(
™”
->
cur_key
.
objeùid
 !ğ
by‹Ä
 ||

2920 (
™”
->
cur_key
.
ty³
 !ğ
BTRFS_SHARED_BLOCK_REF_KEY
 &&

2921 
™”
->
cur_key
.
ty³
 !ğ
BTRFS_TREE_BLOCK_REF_KEY
)) {

2922 
»t
 = -
ENOENT
;

2923 
»Ëa£
;

2925 
™”
->
cur_±r
 = (
u32
)
	`bŒfs_™em_±r_off£t
(
·th
->
nodes
[0],

2926 
·th
->
¦Ùs
[0]);

2927 
™”
->
™em_±r
 = i‹r->
cur_±r
;

2928 
™”
->
’d_±r
 = (
u32
)(™”->
™em_±r
 + 
	`bŒfs_™em_size
(

2929 
·th
->
nodes
[0],…©h->
¦Ùs
[0]));

2933 
»Ëa£
:

2934 
	`bŒfs_back»f_™”_»Ëa£
(
™”
);

2935  
»t
;

2936 
	}
}

2948 
	$bŒfs_back»f_™”_Ãxt
(
bŒfs_back»f_™”
 *
™”
)

2950 
ex‹Á_bufãr
 *
eb
 = 
	`bŒfs_back»f_g‘_eb
(
™”
);

2951 
bŒfs_roÙ
 *
ex‹Á_roÙ
;

2952 
bŒfs_·th
 *
·th
 = 
™”
->path;

2953 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

2954 
»t
;

2955 
u32
 
size
;

2957 ià(
	`bŒfs_back»f_™”_is_šlše_»f
(
™”
)) {

2959 
	`ASSERT
(
™”
->
cur_±r
 < i‹r->
’d_±r
);

2961 ià(
	`bŒfs_back»f_has_Œ“_block_šfo
(
™”
)) {

2963 
size
 = (
bŒfs_Œ“_block_šfo
);

2966 
ty³
;

2968 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)

2969 (()
™”
->
cur_±r
);

2970 
ty³
 = 
	`bŒfs_ex‹Á_šlše_»f_ty³
(
eb
, 
œef
);

2972 
size
 = 
	`bŒfs_ex‹Á_šlše_»f_size
(
ty³
);

2974 
™”
->
cur_±r
 +ğ
size
;

2975 ià(
™”
->
cur_±r
 < i‹r->
’d_±r
)

2982 
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
™”
->
fs_šfo
, i‹r->
by‹Ä
);

2983 
»t
 = 
	`bŒfs_Ãxt_™em
(
ex‹Á_roÙ
, 
™”
->
·th
);

2984 ià(
»t
)

2985  
»t
;

2987 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
™”
->
cur_key
,…©h->
¦Ùs
[0]);

2988 ià(
™”
->
cur_key
.
objeùid
 !ğ™”->
by‹Ä
 ||

2989 (
™”
->
cur_key
.
ty³
 !ğ
BTRFS_TREE_BLOCK_REF_KEY
 &&

2990 
™”
->
cur_key
.
ty³
 !ğ
BTRFS_SHARED_BLOCK_REF_KEY
))

2992 
™”
->
™em_±r
 = (
u32
)
	`bŒfs_™em_±r_off£t
(
·th
->
nodes
[0],

2993 
·th
->
¦Ùs
[0]);

2994 
™”
->
cur_±r
 = i‹r->
™em_±r
;

2995 
™”
->
’d_±r
 = i‹r->
™em_±r
 + (
u32
)
	`bŒfs_™em_size
(
·th
->
nodes
[0],

2996 
·th
->
¦Ùs
[0]);

2998 
	}
}

3000 
	$bŒfs_back»f_š™_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
,

3001 
bŒfs_back»f_ÿche
 *
ÿche
, 
is_»loc
)

3003 
i
;

3005 
ÿche
->
rb_roÙ
 = 
RB_ROOT
;

3006 
i
 = 0; i < 
BTRFS_MAX_LEVEL
; i++)

3007 
	`INIT_LIST_HEAD
(&
ÿche
->
³ndšg
[
i
]);

3008 
	`INIT_LIST_HEAD
(&
ÿche
->
chªged
);

3009 
	`INIT_LIST_HEAD
(&
ÿche
->
d‘ached
);

3010 
	`INIT_LIST_HEAD
(&
ÿche
->
Ëaves
);

3011 
	`INIT_LIST_HEAD
(&
ÿche
->
³ndšg_edge
);

3012 
	`INIT_LIST_HEAD
(&
ÿche
->
u£Ëss_node
);

3013 
ÿche
->
fs_šfo
 = fs_info;

3014 
ÿche
->
is_»loc
 = is_reloc;

3015 
	}
}

3017 
bŒfs_back»f_node
 *
	$bŒfs_back»f_®loc_node
(

3018 
bŒfs_back»f_ÿche
 *
ÿche
, 
u64
 
by‹Ä
, 
Ëv–
)

3020 
bŒfs_back»f_node
 *
node
;

3022 
	`ASSERT
(
Ëv–
 >ğ0 &&†ev– < 
BTRFS_MAX_LEVEL
);

3023 
node
 = 
	`kz®loc
((*node), 
GFP_NOFS
);

3024 ià(!
node
)

3025  
node
;

3027 
	`INIT_LIST_HEAD
(&
node
->
li¡
);

3028 
	`INIT_LIST_HEAD
(&
node
->
uµ”
);

3029 
	`INIT_LIST_HEAD
(&
node
->
low”
);

3030 
	`RB_CLEAR_NODE
(&
node
->
rb_node
);

3031 
ÿche
->
Ä_nodes
++;

3032 
node
->
Ëv–
 =†evel;

3033 
node
->
by‹Ä
 = bytenr;

3035  
node
;

3036 
	}
}

3038 
bŒfs_back»f_edge
 *
	$bŒfs_back»f_®loc_edge
(

3039 
bŒfs_back»f_ÿche
 *
ÿche
)

3041 
bŒfs_back»f_edge
 *
edge
;

3043 
edge
 = 
	`kz®loc
((*edge), 
GFP_NOFS
);

3044 ià(
edge
)

3045 
ÿche
->
Ä_edges
++;

3046  
edge
;

3047 
	}
}

3056 
	$bŒfs_back»f_ş—nup_node
(
bŒfs_back»f_ÿche
 *
ÿche
,

3057 
bŒfs_back»f_node
 *
node
)

3059 
bŒfs_back»f_node
 *
uµ”
;

3060 
bŒfs_back»f_edge
 *
edge
;

3062 ià(!
node
)

3065 
	`BUG_ON
(!
node
->
lowe¡
 && !node->
d‘ached
);

3066 !
	`li¡_em±y
(&
node
->
uµ”
)) {

3067 
edge
 = 
	`li¡_’Œy
(
node
->
uµ”
.
Ãxt
, 
bŒfs_back»f_edge
,

3068 
li¡
[
LOWER
]);

3069 
uµ”
 = 
edge
->
node
[
UPPER
];

3070 
	`li¡_d–
(&
edge
->
li¡
[
LOWER
]);

3071 
	`li¡_d–
(&
edge
->
li¡
[
UPPER
]);

3072 
	`bŒfs_back»f_ä“_edge
(
ÿche
, 
edge
);

3078 ià(
	`li¡_em±y
(&
uµ”
->
low”
)) {

3079 
	`li¡_add_
(&
uµ”
->
low”
, &
ÿche
->
Ëaves
);

3080 
uµ”
->
lowe¡
 = 1;

3084 
	`bŒfs_back»f_drİ_node
(
ÿche
, 
node
);

3085 
	}
}

3090 
	$bŒfs_back»f_»Ëa£_ÿche
(
bŒfs_back»f_ÿche
 *
ÿche
)

3092 
bŒfs_back»f_node
 *
node
;

3093 
i
;

3095 !
	`li¡_em±y
(&
ÿche
->
d‘ached
)) {

3096 
node
 = 
	`li¡_’Œy
(
ÿche
->
d‘ached
.
Ãxt
,

3097 
bŒfs_back»f_node
, 
li¡
);

3098 
	`bŒfs_back»f_ş—nup_node
(
ÿche
, 
node
);

3101 !
	`li¡_em±y
(&
ÿche
->
Ëaves
)) {

3102 
node
 = 
	`li¡_’Œy
(
ÿche
->
Ëaves
.
Ãxt
,

3103 
bŒfs_back»f_node
, 
low”
);

3104 
	`bŒfs_back»f_ş—nup_node
(
ÿche
, 
node
);

3107 
ÿche
->
Ï¡_Œªs
 = 0;

3109 
i
 = 0; i < 
BTRFS_MAX_LEVEL
; i++)

3110 
	`ASSERT
(
	`li¡_em±y
(&
ÿche
->
³ndšg
[
i
]));

3111 
	`ASSERT
(
	`li¡_em±y
(&
ÿche
->
³ndšg_edge
));

3112 
	`ASSERT
(
	`li¡_em±y
(&
ÿche
->
u£Ëss_node
));

3113 
	`ASSERT
(
	`li¡_em±y
(&
ÿche
->
chªged
));

3114 
	`ASSERT
(
	`li¡_em±y
(&
ÿche
->
d‘ached
));

3115 
	`ASSERT
(
	`RB_EMPTY_ROOT
(&
ÿche
->
rb_roÙ
));

3116 
	`ASSERT
(!
ÿche
->
Ä_nodes
);

3117 
	`ASSERT
(!
ÿche
->
Ä_edges
);

3118 
	}
}

3132 
	$hªdË_dœeù_Œ“_back»f
(
bŒfs_back»f_ÿche
 *
ÿche
,

3133 
bŒfs_key
 *
»f_key
,

3134 
bŒfs_back»f_node
 *
cur
)

3136 
bŒfs_back»f_edge
 *
edge
;

3137 
bŒfs_back»f_node
 *
uµ”
;

3138 
rb_node
 *rb_node;

3140 
	`ASSERT
(
»f_key
->
ty³
 =ğ
BTRFS_SHARED_BLOCK_REF_KEY
);

3143 ià(
»f_key
->
objeùid
 =ğ»f_key->
off£t
) {

3144 
bŒfs_roÙ
 *
roÙ
;

3146 
cur
->
is_»loc_roÙ
 = 1;

3148 ià(
ÿche
->
is_»loc
) {

3149 
roÙ
 = 
	`fšd_»loc_roÙ
(
ÿche
->
fs_šfo
, 
cur
->
by‹Ä
);

3150 ià(!
roÙ
)

3151  -
ENOENT
;

3152 
cur
->
roÙ
 =„oot;

3158 
	`li¡_add
(&
cur
->
li¡
, &
ÿche
->
u£Ëss_node
);

3163 
edge
 = 
	`bŒfs_back»f_®loc_edge
(
ÿche
);

3164 ià(!
edge
)

3165  -
ENOMEM
;

3167 
rb_node
 = 
	`rb_sim¶e_£¬ch
(&
ÿche
->
rb_roÙ
, 
»f_key
->
off£t
);

3168 ià(!
rb_node
) {

3170 
uµ”
 = 
	`bŒfs_back»f_®loc_node
(
ÿche
, 
»f_key
->
off£t
,

3171 
cur
->
Ëv–
 + 1);

3172 ià(!
uµ”
) {

3173 
	`bŒfs_back»f_ä“_edge
(
ÿche
, 
edge
);

3174  -
ENOMEM
;

3181 
	`li¡_add_
(&
edge
->
li¡
[
UPPER
], &
ÿche
->
³ndšg_edge
);

3184 
uµ”
 = 
	`rb_’Œy
(
rb_node
, 
bŒfs_back»f_node
,„b_node);

3185 
	`ASSERT
(
uµ”
->
checked
);

3186 
	`INIT_LIST_HEAD
(&
edge
->
li¡
[
UPPER
]);

3188 
	`bŒfs_back»f_lšk_edge
(
edge
, 
cur
, 
uµ”
, 
LINK_LOWER
);

3190 
	}
}

3205 
	$hªdË_šdœeù_Œ“_back»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3206 
bŒfs_back»f_ÿche
 *
ÿche
,

3207 
bŒfs_·th
 *
·th
,

3208 
bŒfs_key
 *
»f_key
,

3209 
bŒfs_key
 *
Œ“_key
,

3210 
bŒfs_back»f_node
 *
cur
)

3212 
bŒfs_fs_šfo
 *
fs_šfo
 = 
ÿche
->fs_info;

3213 
bŒfs_back»f_node
 *
uµ”
;

3214 
bŒfs_back»f_node
 *
low”
;

3215 
bŒfs_back»f_edge
 *
edge
;

3216 
ex‹Á_bufãr
 *
eb
;

3217 
bŒfs_roÙ
 *
roÙ
;

3218 
rb_node
 *rb_node;

3219 
Ëv–
;

3220 
boŞ
 
Ãed_check
 = 
Œue
;

3221 
»t
;

3223 
roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
»f_key
->
off£t
, 
çl£
);

3224 ià(
	`IS_ERR
(
roÙ
))

3225  
	`PTR_ERR
(
roÙ
);

3226 ià(!
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
))

3227 
cur
->
cowÚly
 = 1;

3229 ià(
	`bŒfs_roÙ_Ëv–
(&
roÙ
->
roÙ_™em
è=ğ
cur
->
Ëv–
) {

3231 
	`ASSERT
(
	`bŒfs_roÙ_by‹Ä
(&
roÙ
->
roÙ_™em
è=ğ
cur
->
by‹Ä
);

3242 ià(
	`bŒfs_should_ignÜe_»loc_roÙ
(
roÙ
è&& 
ÿche
->
is_»loc
) {

3243 
	`bŒfs_put_roÙ
(
roÙ
);

3244 
	`li¡_add
(&
cur
->
li¡
, &
ÿche
->
u£Ëss_node
);

3246 
cur
->
roÙ
 =„oot;

3251 
Ëv–
 = 
cur
->level + 1;

3254 
·th
->
£¬ch_comm™_roÙ
 = 1;

3255 
·th
->
sk_lockšg
 = 1;

3256 
·th
->
lowe¡_Ëv–
 = 
Ëv–
;

3257 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, 
Œ“_key
, 
·th
, 0, 0);

3258 
·th
->
lowe¡_Ëv–
 = 0;

3259 ià(
»t
 < 0) {

3260 
	`bŒfs_put_roÙ
(
roÙ
);

3261  
»t
;

3263 ià(
»t
 > 0 && 
·th
->
¦Ùs
[
Ëv–
] > 0)

3264 
·th
->
¦Ùs
[
Ëv–
]--;

3266 
eb
 = 
·th
->
nodes
[
Ëv–
];

3267 ià(
	`bŒfs_node_block±r
(
eb
, 
·th
->
¦Ùs
[
Ëv–
]è!ğ
cur
->
by‹Ä
) {

3268 
	`bŒfs_”r
(
fs_šfo
,

3270 
cur
->
by‹Ä
, 
Ëv–
 - 1, 
roÙ
->
roÙ_key
.
objeùid
,

3271 
Œ“_key
->
objeùid
,»e_key->
ty³
,»e_key->
off£t
);

3272 
	`bŒfs_put_roÙ
(
roÙ
);

3273 
»t
 = -
ENOENT
;

3274 
out
;

3276 
low”
 = 
cur
;

3279 ; 
Ëv–
 < 
BTRFS_MAX_LEVEL
;†evel++) {

3280 ià(!
·th
->
nodes
[
Ëv–
]) {

3281 
	`ASSERT
(
	`bŒfs_roÙ_by‹Ä
(&
roÙ
->
roÙ_™em
) ==

3282 
low”
->
by‹Ä
);

3284 ià(
	`bŒfs_should_ignÜe_»loc_roÙ
(
roÙ
) &&

3285 
ÿche
->
is_»loc
) {

3286 
	`bŒfs_put_roÙ
(
roÙ
);

3287 
	`li¡_add
(&
low”
->
li¡
, &
ÿche
->
u£Ëss_node
);

3289 
low”
->
roÙ
 =„oot;

3294 
edge
 = 
	`bŒfs_back»f_®loc_edge
(
ÿche
);

3295 ià(!
edge
) {

3296 
	`bŒfs_put_roÙ
(
roÙ
);

3297 
»t
 = -
ENOMEM
;

3298 
out
;

3301 
eb
 = 
·th
->
nodes
[
Ëv–
];

3302 
rb_node
 = 
	`rb_sim¶e_£¬ch
(&
ÿche
->
rb_roÙ
, 
eb
->
¡¬t
);

3303 ià(!
rb_node
) {

3304 
uµ”
 = 
	`bŒfs_back»f_®loc_node
(
ÿche
, 
eb
->
¡¬t
,

3305 
low”
->
Ëv–
 + 1);

3306 ià(!
uµ”
) {

3307 
	`bŒfs_put_roÙ
(
roÙ
);

3308 
	`bŒfs_back»f_ä“_edge
(
ÿche
, 
edge
);

3309 
»t
 = -
ENOMEM
;

3310 
out
;

3312 
uµ”
->
owÃr
 = 
	`bŒfs_h—d”_owÃr
(
eb
);

3313 ià(!
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
))

3314 
uµ”
->
cowÚly
 = 1;

3320 ià(
	`bŒfs_block_ÿn_be_sh¬ed
(
Œªs
, 
roÙ
, 
eb
))

3321 
uµ”
->
checked
 = 0;

3323 
uµ”
->
checked
 = 1;

3330 ià(!
uµ”
->
checked
 && 
Ãed_check
) {

3331 
Ãed_check
 = 
çl£
;

3332 
	`li¡_add_
(&
edge
->
li¡
[
UPPER
],

3333 &
ÿche
->
³ndšg_edge
);

3335 ià(
uµ”
->
checked
)

3336 
Ãed_check
 = 
Œue
;

3337 
	`INIT_LIST_HEAD
(&
edge
->
li¡
[
UPPER
]);

3340 
uµ”
 = 
	`rb_’Œy
(
rb_node
, 
bŒfs_back»f_node
,

3341 
rb_node
);

3342 
	`ASSERT
(
uµ”
->
checked
);

3343 
	`INIT_LIST_HEAD
(&
edge
->
li¡
[
UPPER
]);

3344 ià(!
uµ”
->
owÃr
)

3345 
uµ”
->
owÃr
 = 
	`bŒfs_h—d”_owÃr
(
eb
);

3347 
	`bŒfs_back»f_lšk_edge
(
edge
, 
low”
, 
uµ”
, 
LINK_LOWER
);

3349 ià(
rb_node
) {

3350 
	`bŒfs_put_roÙ
(
roÙ
);

3353 
low”
 = 
uµ”
;

3354 
uµ”
 = 
NULL
;

3356 
out
:

3357 
	`bŒfs_»Ëa£_·th
(
·th
);

3358  
»t
;

3359 
	}
}

3373 
	$bŒfs_back»f_add_Œ“_node
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3374 
bŒfs_back»f_ÿche
 *
ÿche
,

3375 
bŒfs_·th
 *
·th
,

3376 
bŒfs_back»f_™”
 *
™”
,

3377 
bŒfs_key
 *
node_key
,

3378 
bŒfs_back»f_node
 *
cur
)

3380 
bŒfs_back»f_edge
 *
edge
;

3381 
bŒfs_back»f_node
 *
exi¡
;

3382 
»t
;

3384 
»t
 = 
	`bŒfs_back»f_™”_¡¬t
(
™”
, 
cur
->
by‹Ä
);

3385 ià(
»t
 < 0)

3386  
»t
;

3391 ià(
	`bŒfs_back»f_has_Œ“_block_šfo
(
™”
)) {

3392 
»t
 = 
	`bŒfs_back»f_™”_Ãxt
(
™”
);

3393 ià(
»t
 < 0)

3394 
out
;

3396 ià(
»t
 > 0) {

3397 
»t
 = -
EUCLEAN
;

3398 
out
;

3401 
	`WARN_ON
(
cur
->
checked
);

3402 ià(!
	`li¡_em±y
(&
cur
->
uµ”
)) {

3407 
	`ASSERT
(
	`li¡_is_sšguÏr
(&
cur
->
uµ”
));

3408 
edge
 = 
	`li¡_’Œy
(
cur
->
uµ”
.
Ãxt
, 
bŒfs_back»f_edge
,

3409 
li¡
[
LOWER
]);

3410 
	`ASSERT
(
	`li¡_em±y
(&
edge
->
li¡
[
UPPER
]));

3411 
exi¡
 = 
edge
->
node
[
UPPER
];

3416 ià(!
exi¡
->
checked
)

3417 
	`li¡_add_
(&
edge
->
li¡
[
UPPER
], &
ÿche
->
³ndšg_edge
);

3419 
exi¡
 = 
NULL
;

3422 ; 
»t
 =ğ0;„‘ = 
	`bŒfs_back»f_™”_Ãxt
(
™”
)) {

3423 
ex‹Á_bufãr
 *
eb
;

3424 
bŒfs_key
 
key
;

3425 
ty³
;

3427 
	`cÚd_»sched
();

3428 
eb
 = 
	`bŒfs_back»f_g‘_eb
(
™”
);

3430 
key
.
objeùid
 = 
™”
->
by‹Ä
;

3431 ià(
	`bŒfs_back»f_™”_is_šlše_»f
(
™”
)) {

3432 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

3435 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)

3436 (()
™”
->
cur_±r
);

3437 
ty³
 = 
	`bŒfs_g‘_ex‹Á_šlše_»f_ty³
(
eb
, 
œef
,

3438 
BTRFS_REF_TYPE_BLOCK
);

3439 ià(
ty³
 =ğ
BTRFS_REF_TYPE_INVALID
) {

3440 
»t
 = -
EUCLEAN
;

3441 
out
;

3443 
key
.
ty³
 =ype;

3444 
key
.
off£t
 = 
	`bŒfs_ex‹Á_šlše_»f_off£t
(
eb
, 
œef
);

3446 
key
.
ty³
 = 
™”
->
cur_key
.type;

3447 
key
.
off£t
 = 
™”
->
cur_key
.offset;

3454 ià(
exi¡
 &&

3455 ((
key
.
ty³
 =ğ
BTRFS_TREE_BLOCK_REF_KEY
 &&

3456 
exi¡
->
owÃr
 =ğ
key
.
off£t
) ||

3457 (
key
.
ty³
 =ğ
BTRFS_SHARED_BLOCK_REF_KEY
 &&

3458 
exi¡
->
by‹Ä
 =ğ
key
.
off£t
))) {

3459 
exi¡
 = 
NULL
;

3464 ià(
key
.
ty³
 =ğ
BTRFS_SHARED_BLOCK_REF_KEY
) {

3465 
»t
 = 
	`hªdË_dœeù_Œ“_back»f
(
ÿche
, &
key
, 
cur
);

3466 ià(
»t
 < 0)

3467 
out
;

3468 } ià(
key
.
ty³
 =ğ
BTRFS_TREE_BLOCK_REF_KEY
) {

3474 
»t
 = 
	`hªdË_šdœeù_Œ“_back»f
(
Œªs
, 
ÿche
, 
·th
,

3475 &
key
, 
node_key
, 
cur
);

3476 ià(
»t
 < 0)

3477 
out
;

3484 
»t
 = 0;

3485 
cur
->
checked
 = 1;

3486 
	`WARN_ON
(
exi¡
);

3487 
out
:

3488 
	`bŒfs_back»f_™”_»Ëa£
(
™”
);

3489  
»t
;

3490 
	}
}

3495 
	$bŒfs_back»f_fšish_uµ”_lšks
(
bŒfs_back»f_ÿche
 *
ÿche
,

3496 
bŒfs_back»f_node
 *
¡¬t
)

3498 
li¡_h—d
 *
u£Ëss_node
 = &
ÿche
->useless_node;

3499 
bŒfs_back»f_edge
 *
edge
;

3500 
rb_node
 *rb_node;

3501 
	`LIST_HEAD
(
³ndšg_edge
);

3503 
	`ASSERT
(
¡¬t
->
checked
);

3506 ià(!
¡¬t
->
cowÚly
) {

3507 
rb_node
 = 
	`rb_sim¶e_š£¹
(&
ÿche
->
rb_roÙ
, 
¡¬t
->
by‹Ä
,

3508 &
¡¬t
->
rb_node
);

3509 ià(
rb_node
)

3510 
	`bŒfs_back»f_·nic
(
ÿche
->
fs_šfo
, 
¡¬t
->
by‹Ä
,

3511 -
EEXIST
);

3512 
	`li¡_add_
(&
¡¬t
->
low”
, &
ÿche
->
Ëaves
);

3520 
	`li¡_fÜ_—ch_’Œy
(
edge
, &
¡¬t
->
uµ”
, 
li¡
[
LOWER
])

3521 
	`li¡_add_
(&
edge
->
li¡
[
UPPER
], &
³ndšg_edge
);

3523 !
	`li¡_em±y
(&
³ndšg_edge
)) {

3524 
bŒfs_back»f_node
 *
uµ”
;

3525 
bŒfs_back»f_node
 *
low”
;

3527 
edge
 = 
	`li¡_fœ¡_’Œy
(&
³ndšg_edge
,

3528 
bŒfs_back»f_edge
, 
li¡
[
UPPER
]);

3529 
	`li¡_d–_š™
(&
edge
->
li¡
[
UPPER
]);

3530 
uµ”
 = 
edge
->
node
[
UPPER
];

3531 
low”
 = 
edge
->
node
[
LOWER
];

3534 ià(
uµ”
->
d‘ached
) {

3535 
	`li¡_d–
(&
edge
->
li¡
[
LOWER
]);

3536 
	`bŒfs_back»f_ä“_edge
(
ÿche
, 
edge
);

3539 ià(
	`li¡_em±y
(&
low”
->
uµ”
))

3540 
	`li¡_add
(&
low”
->
li¡
, 
u£Ëss_node
);

3551 ià(!
	`RB_EMPTY_NODE
(&
uµ”
->
rb_node
)) {

3552 ià(
uµ”
->
lowe¡
) {

3553 
	`li¡_d–_š™
(&
uµ”
->
low”
);

3554 
uµ”
->
lowe¡
 = 0;

3557 
	`li¡_add_
(&
edge
->
li¡
[
UPPER
], &
uµ”
->
low”
);

3562 ià(!
uµ”
->
checked
) {

3563 
	`ASSERT
(0);

3564  -
EUCLEAN
;

3568 ià(
¡¬t
->
cowÚly
 !ğ
uµ”
->cowonly) {

3569 
	`ASSERT
(0);

3570  -
EUCLEAN
;

3574 ià(!
uµ”
->
cowÚly
) {

3575 
rb_node
 = 
	`rb_sim¶e_š£¹
(&
ÿche
->
rb_roÙ
, 
uµ”
->
by‹Ä
,

3576 &
uµ”
->
rb_node
);

3577 ià(
rb_node
) {

3578 
	`bŒfs_back»f_·nic
(
ÿche
->
fs_šfo
,

3579 
uµ”
->
by‹Ä
, -
EEXIST
);

3580  -
EUCLEAN
;

3584 
	`li¡_add_
(&
edge
->
li¡
[
UPPER
], &
uµ”
->
low”
);

3590 
	`li¡_fÜ_—ch_’Œy
(
edge
, &
uµ”
->uµ”, 
li¡
[
LOWER
])

3591 
	`li¡_add_
(&
edge
->
li¡
[
UPPER
], &
³ndšg_edge
);

3594 
	}
}

3596 
	$bŒfs_back»f_”rÜ_ş—nup
(
bŒfs_back»f_ÿche
 *
ÿche
,

3597 
bŒfs_back»f_node
 *
node
)

3599 
bŒfs_back»f_node
 *
low”
;

3600 
bŒfs_back»f_node
 *
uµ”
;

3601 
bŒfs_back»f_edge
 *
edge
;

3603 !
	`li¡_em±y
(&
ÿche
->
u£Ëss_node
)) {

3604 
low”
 = 
	`li¡_fœ¡_’Œy
(&
ÿche
->
u£Ëss_node
,

3605 
bŒfs_back»f_node
, 
li¡
);

3606 
	`li¡_d–_š™
(&
low”
->
li¡
);

3608 !
	`li¡_em±y
(&
ÿche
->
³ndšg_edge
)) {

3609 
edge
 = 
	`li¡_fœ¡_’Œy
(&
ÿche
->
³ndšg_edge
,

3610 
bŒfs_back»f_edge
, 
li¡
[
UPPER
]);

3611 
	`li¡_d–
(&
edge
->
li¡
[
UPPER
]);

3612 
	`li¡_d–
(&
edge
->
li¡
[
LOWER
]);

3613 
low”
 = 
edge
->
node
[
LOWER
];

3614 
uµ”
 = 
edge
->
node
[
UPPER
];

3615 
	`bŒfs_back»f_ä“_edge
(
ÿche
, 
edge
);

3621 ià(
	`li¡_em±y
(&
low”
->
uµ”
) &&

3622 
	`RB_EMPTY_NODE
(&
low”
->
rb_node
))

3623 
	`li¡_add
(&
low”
->
li¡
, &
ÿche
->
u£Ëss_node
);

3625 ià(!
	`RB_EMPTY_NODE
(&
uµ”
->
rb_node
))

3629 
	`li¡_fÜ_—ch_’Œy
(
edge
, &
uµ”
->uµ”, 
li¡
[
LOWER
])

3630 
	`li¡_add_
(&
edge
->
li¡
[
UPPER
],

3631 &
ÿche
->
³ndšg_edge
);

3632 ià(
	`li¡_em±y
(&
uµ”
->upper))

3633 
	`li¡_add
(&
uµ”
->
li¡
, &
ÿche
->
u£Ëss_node
);

3636 !
	`li¡_em±y
(&
ÿche
->
u£Ëss_node
)) {

3637 
low”
 = 
	`li¡_fœ¡_’Œy
(&
ÿche
->
u£Ëss_node
,

3638 
bŒfs_back»f_node
, 
li¡
);

3639 
	`li¡_d–_š™
(&
low”
->
li¡
);

3640 ià(
low”
 =ğ
node
)

3641 
node
 = 
NULL
;

3642 
	`bŒfs_back»f_drİ_node
(
ÿche
, 
low”
);

3645 
	`bŒfs_back»f_ş—nup_node
(
ÿche
, 
node
);

3646 
	`ASSERT
(
	`li¡_em±y
(&
ÿche
->
u£Ëss_node
) &&

3647 
	`li¡_em±y
(&
ÿche
->
³ndšg_edge
));

3648 
	}
}

	@backref.h

6 #iâdeà
BTRFS_BACKREF_H


7 
	#BTRFS_BACKREF_H


	)

9 
	~<lšux/bŒfs.h
>

10 
	~"mes§ges.h
"

11 
	~"uli¡.h
"

12 
	~"disk-io.h
"

13 
	~"ex‹Á_io.h
"

23 
	#BTRFS_ITERATE_EXTENT_INODES_STOP
 5

	)

31 (
	t™”©e_ex‹Á_šodes_t
)(
	tu64
 
	tšum
, u64 
	toff£t
, u64 
	tnum_by‹s
,

32 
	tu64
 
	troÙ
, *
	tùx
);

39 
	sbŒfs_back»f_w®k_ùx
 {

46 
u64
 
by‹Ä
;

56 
u64
 
ex‹Á_™em_pos
;

62 
boŞ
 
ignÜe_ex‹Á_™em_pos
;

68 
boŞ
 
sk_šode_»f_li¡
;

70 
bŒfs_Œªs_hªdË
 *
Œªs
;

76 
bŒfs_fs_šfo
 *
fs_šfo
;

85 
u64
 
time_£q
;

90 
uli¡
 *
»fs
;

96 
uli¡
 *
roÙs
;

103 
	`boŞ
 (*
ÿche_lookup
)(
u64
 
Ëaf_by‹Ä
, *
u£r_ùx
,

104 cÚ¡ 
u64
 **
roÙ_ids_»t
, *
roÙ_couÁ_»t
);

105 (*
ÿche_¡Üe
)(
u64
 
Ëaf_by‹Ä
, cÚ¡ 
uli¡
 *
roÙ_ids
,

106 *
u£r_ùx
);

116 
™”©e_ex‹Á_šodes_t
 *
šdœeù_»f_™”©Ü
;

123 (*
check_ex‹Á_™em
)(
u64
 
by‹Ä
, cÚ¡ 
bŒfs_ex‹Á_™em
 *
ei
,

124 cÚ¡ 
ex‹Á_bufãr
 *
Ëaf
, *
u£r_ùx
);

133 
	`boŞ
 (*
sk_d©a_»f
)(
u64
 
roÙ
, u64 
šo
, u64 
off£t
, *
u£r_ùx
);

135 *
u£r_ùx
;

138 
	sšode_fs_·ths
 {

139 
bŒfs_·th
 *btrfs_path;

140 
bŒfs_roÙ
 *
fs_roÙ
;

141 
bŒfs_d©a_cÚš”
 *
f¥©h
;

144 
	sbŒfs_back»f_sh¬ed_ÿche_’Œy
 {

145 
u64
 
by‹Ä
;

146 
u64
 
g’
;

147 
boŞ
 
is_sh¬ed
;

150 
	#BTRFS_BACKREF_CTX_PREV_EXTENTS_SIZE
 8

	)

152 
	sbŒfs_back»f_sh¬e_check_ùx
 {

154 
uli¡
 
»fs
;

161 
u64
 
cu¼_Ëaf_by‹Ä
;

167 
u64
 
´ev_Ëaf_by‹Ä
;

172 
bŒfs_back»f_sh¬ed_ÿche_’Œy
 
·th_ÿche_’Œ›s
[
BTRFS_MAX_LEVEL
];

173 
boŞ
 
u£_·th_ÿche
;

191 
u64
 
by‹Ä
;

192 
boŞ
 
is_sh¬ed
;

193 } 
´ev_ex‹Ás_ÿche
[
BTRFS_BACKREF_CTX_PREV_EXTENTS_SIZE
];

198 
´ev_ex‹Ás_ÿche_¦Ù
;

201 
bŒfs_back»f_sh¬e_check_ùx
 *
	`bŒfs_®loc_back»f_sh¬e_check_ùx
();

202 
	`bŒfs_ä“_back»f_sh¬e_ùx
(
bŒfs_back»f_sh¬e_check_ùx
 *
ùx
);

204 
	`ex‹Á_äom_logiÿl
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
,

205 
bŒfs_·th
 *
·th
, 
bŒfs_key
 *
found_key
,

206 
u64
 *
æags
);

208 
	`Œ“_back»f_fÜ_ex‹Á
(*
±r
, 
ex‹Á_bufãr
 *
eb
,

209 
bŒfs_key
 *
key
, 
bŒfs_ex‹Á_™em
 *
ei
,

210 
u32
 
™em_size
, 
u64
 *
out_roÙ
, 
u8
 *
out_Ëv–
);

212 
	`™”©e_ex‹Á_šodes
(
bŒfs_back»f_w®k_ùx
 *
ùx
,

213 
boŞ
 
£¬ch_comm™_roÙ
,

214 
™”©e_ex‹Á_šodes_t
 *
™”©e
, *
u£r_ùx
);

216 
	`™”©e_šodes_äom_logiÿl
(
u64
 
logiÿl
, 
bŒfs_fs_šfo
 *
fs_šfo
,

217 
bŒfs_·th
 *
·th
, *
ùx
,

218 
boŞ
 
ignÜe_off£t
);

220 
	`·ths_äom_šode
(
u64
 
šum
, 
šode_fs_·ths
 *
©h
);

222 
	`bŒfs_fšd_®l_Ëafs
(
bŒfs_back»f_w®k_ùx
 *
ùx
);

223 
	`bŒfs_fšd_®l_roÙs
(
bŒfs_back»f_w®k_ùx
 *
ùx
,

224 
boŞ
 
sk_comm™_roÙ_£m
);

225 *
	`bŒfs_»f_to_·th
(
bŒfs_roÙ
 *
fs_roÙ
, 
bŒfs_·th
 *
·th
,

226 
u32
 
Çme_Ën
, 
Çme_off
,

227 
ex‹Á_bufãr
 *
eb_š
, 
u64
 
·»Á
,

228 *
de¡
, 
u32
 
size
);

230 
bŒfs_d©a_cÚš”
 *
	`š™_d©a_cÚš”
(
u32
 
tÙ®_by‹s
);

231 
šode_fs_·ths
 *
	`š™_©h
(
s32
 
tÙ®_by‹s
, 
bŒfs_roÙ
 *
fs_roÙ
,

232 
bŒfs_·th
 *
·th
);

233 
	`ä“_©h
(
šode_fs_·ths
 *
©h
);

235 
	`bŒfs_fšd_Úe_exŒef
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
šode_objeùid
,

236 
u64
 
¡¬t_off
, 
bŒfs_·th
 *
·th
,

237 
bŒfs_šode_exŒef
 **
»t_exŒef
,

238 
u64
 *
found_off
);

239 
	`bŒfs_is_d©a_ex‹Á_sh¬ed
(
bŒfs_šode
 *
šode
, 
u64
 
by‹Ä
,

240 
u64
 
ex‹Á_g’
,

241 
bŒfs_back»f_sh¬e_check_ùx
 *
ùx
);

243 
__š™
 
	`bŒfs_´–im_»f_š™
();

244 
__cŞd
 
	`bŒfs_´–im_»f_ex™
();

246 
	s´–im_»f
 {

247 
rb_node
 
rbnode
;

248 
u64
 
roÙ_id
;

249 
bŒfs_key
 
key_fÜ_£¬ch
;

250 
Ëv–
;

251 
couÁ
;

252 
ex‹Á_šode_–em
 *
šode_li¡
;

253 
u64
 
·»Á
;

254 
u64
 
wª‹d_disk_by‹
;

262 
	sbŒfs_back»f_™”
 {

263 
u64
 
by‹Ä
;

264 
bŒfs_·th
 *
·th
;

265 
bŒfs_fs_šfo
 *
fs_šfo
;

266 
bŒfs_key
 
cur_key
;

267 
u32
 
™em_±r
;

268 
u32
 
cur_±r
;

269 
u32
 
’d_±r
;

272 
bŒfs_back»f_™”
 *
	`bŒfs_back»f_™”_®loc
(
bŒfs_fs_šfo
 *
fs_šfo
);

274 
šlše
 
	$bŒfs_back»f_™”_ä“
(
bŒfs_back»f_™”
 *
™”
)

276 ià(!
™”
)

278 
	`bŒfs_ä“_·th
(
™”
->
·th
);

279 
	`kä“
(
™”
);

280 
	}
}

282 
šlše
 
ex‹Á_bufãr
 *
	$bŒfs_back»f_g‘_eb
(

283 
bŒfs_back»f_™”
 *
™”
)

285 ià(!
™”
)

286  
NULL
;

287  
™”
->
·th
->
nodes
[0];

288 
	}
}

296 
šlše
 
boŞ
 
	$bŒfs_back»f_has_Œ“_block_šfo
(

297 
bŒfs_back»f_™”
 *
™”
)

299 ià(
™”
->
cur_key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 &&

300 
™”
->
cur_±r
 - i‹r->
™em_±r
 =ğ(
bŒfs_ex‹Á_™em
))

301  
Œue
;

302  
çl£
;

303 
	}
}

305 
bŒfs_back»f_™”_¡¬t
(
bŒfs_back»f_™”
 *
™”
, 
u64
 
by‹Ä
);

307 
bŒfs_back»f_™”_Ãxt
(
bŒfs_back»f_™”
 *
™”
);

309 
šlše
 
boŞ
 
	$bŒfs_back»f_™”_is_šlše_»f
(

310 
bŒfs_back»f_™”
 *
™”
)

312 ià(
™”
->
cur_key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 ||

313 
™”
->
cur_key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
)

314  
Œue
;

315  
çl£
;

316 
	}
}

318 
šlše
 
	$bŒfs_back»f_™”_»Ëa£
(
bŒfs_back»f_™”
 *
™”
)

320 
™”
->
by‹Ä
 = 0;

321 
™”
->
™em_±r
 = 0;

322 
™”
->
cur_±r
 = 0;

323 
™”
->
’d_±r
 = 0;

324 
	`bŒfs_»Ëa£_·th
(
™”
->
·th
);

325 
	`mem£t
(&
™”
->
cur_key
, 0, (iter->cur_key));

326 
	}
}

338 
	sbŒfs_back»f_node
 {

340 
rb_node
 
	mrb_node
;

341 
u64
 
	mby‹Ä
;

344 
u64
 
	mÃw_by‹Ä
;

346 
u64
 
	mowÃr
;

348 
li¡_h—d
 
	mli¡
;

351 
li¡_h—d
 
	muµ”
;

353 
li¡_h—d
 
	mlow”
;

356 
bŒfs_roÙ
 *
	mroÙ
;

358 
ex‹Á_bufãr
 *
	meb
;

360 
	mËv–
:8;

362 
	mcowÚly
:1;

364 
	mlowe¡
:1;

366 
	mlocked
:1;

368 
	m´oûs£d
:1;

370 
	mchecked
:1;

375 
	m³ndšg
:1;

377 
	md‘ached
:1;

383 
	mis_»loc_roÙ
:1;

386 
	#LOWER
 0

	)

387 
	#UPPER
 1

	)

392 
	sbŒfs_back»f_edge
 {

401 
li¡_h—d
 
	mli¡
[2];

404 
bŒfs_back»f_node
 *
	mnode
[2];

407 
	sbŒfs_back»f_ÿche
 {

409 
rb_roÙ
 
	mrb_roÙ
;

411 
bŒfs_back»f_node
 *
	m·th
[
BTRFS_MAX_LEVEL
];

416 
li¡_h—d
 
	m³ndšg
[
BTRFS_MAX_LEVEL
];

418 
li¡_h—d
 
	mËaves
;

420 
li¡_h—d
 
	mchªged
;

422 
li¡_h—d
 
	md‘ached
;

424 
u64
 
	mÏ¡_Œªs
;

426 
	mÄ_nodes
;

427 
	mÄ_edges
;

430 
li¡_h—d
 
	m³ndšg_edge
;

433 
li¡_h—d
 
	mu£Ëss_node
;

435 
bŒfs_fs_šfo
 *
	mfs_šfo
;

443 
	mis_»loc
;

446 
bŒfs_back»f_š™_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
,

447 
bŒfs_back»f_ÿche
 *
ÿche
, 
is_»loc
);

448 
bŒfs_back»f_node
 *
bŒfs_back»f_®loc_node
(

449 
bŒfs_back»f_ÿche
 *
ÿche
, 
u64
 
by‹Ä
, 
Ëv–
);

450 
bŒfs_back»f_edge
 *
bŒfs_back»f_®loc_edge
(

451 
bŒfs_back»f_ÿche
 *
ÿche
);

453 
	#LINK_LOWER
 (1 << 0)

	)

454 
	#LINK_UPPER
 (1 << 1)

	)

455 
šlše
 
	$bŒfs_back»f_lšk_edge
(
bŒfs_back»f_edge
 *
edge
,

456 
bŒfs_back»f_node
 *
low”
,

457 
bŒfs_back»f_node
 *
uµ”
,

458 
lšk_which
)

460 
	`ASSERT
(
uµ”
 && 
low”
 && uµ”->
Ëv–
 ==†ower->level + 1);

461 
edge
->
node
[
LOWER
] = 
low”
;

462 
edge
->
node
[
UPPER
] = 
uµ”
;

463 ià(
lšk_which
 & 
LINK_LOWER
)

464 
	`li¡_add_
(&
edge
->
li¡
[
LOWER
], &
low”
->
uµ”
);

465 ià(
lšk_which
 & 
LINK_UPPER
)

466 
	`li¡_add_
(&
edge
->
li¡
[
UPPER
], &
uµ”
->
low”
);

467 
	}
}

469 
šlše
 
	$bŒfs_back»f_ä“_node
(
bŒfs_back»f_ÿche
 *
ÿche
,

470 
bŒfs_back»f_node
 *
node
)

472 ià(
node
) {

473 
	`ASSERT
(
	`li¡_em±y
(&
node
->
li¡
));

474 
	`ASSERT
(
	`li¡_em±y
(&
node
->
low”
));

475 
	`ASSERT
(
node
->
eb
 =ğ
NULL
);

476 
ÿche
->
Ä_nodes
--;

477 
	`bŒfs_put_roÙ
(
node
->
roÙ
);

478 
	`kä“
(
node
);

480 
	}
}

482 
šlše
 
	$bŒfs_back»f_ä“_edge
(
bŒfs_back»f_ÿche
 *
ÿche
,

483 
bŒfs_back»f_edge
 *
edge
)

485 ià(
edge
) {

486 
ÿche
->
Ä_edges
--;

487 
	`kä“
(
edge
);

489 
	}
}

491 
šlše
 
	$bŒfs_back»f_uÆock_node_bufãr
(

492 
bŒfs_back»f_node
 *
node
)

494 ià(
node
->
locked
) {

495 
	`bŒfs_Œ“_uÆock
(
node
->
eb
);

496 
node
->
locked
 = 0;

498 
	}
}

500 
šlše
 
	$bŒfs_back»f_drİ_node_bufãr
(

501 
bŒfs_back»f_node
 *
node
)

503 ià(
node
->
eb
) {

504 
	`bŒfs_back»f_uÆock_node_bufãr
(
node
);

505 
	`ä“_ex‹Á_bufãr
(
node
->
eb
);

506 
node
->
eb
 = 
NULL
;

508 
	}
}

517 
šlše
 
	$bŒfs_back»f_drİ_node
(
bŒfs_back»f_ÿche
 *
Œ“
,

518 
bŒfs_back»f_node
 *
node
)

520 
	`ASSERT
(
	`li¡_em±y
(&
node
->
uµ”
));

522 
	`bŒfs_back»f_drİ_node_bufãr
(
node
);

523 
	`li¡_d–_š™
(&
node
->
li¡
);

524 
	`li¡_d–_š™
(&
node
->
low”
);

525 ià(!
	`RB_EMPTY_NODE
(&
node
->
rb_node
))

526 
	`rb_”a£
(&
node
->
rb_node
, &
Œ“
->
rb_roÙ
);

527 
	`bŒfs_back»f_ä“_node
(
Œ“
, 
node
);

528 
	}
}

530 
bŒfs_back»f_ş—nup_node
(
bŒfs_back»f_ÿche
 *
ÿche
,

531 
bŒfs_back»f_node
 *
node
);

533 
bŒfs_back»f_»Ëa£_ÿche
(
bŒfs_back»f_ÿche
 *
ÿche
);

535 
šlše
 
	$bŒfs_back»f_·nic
(
bŒfs_fs_šfo
 *
fs_šfo
,

536 
u64
 
by‹Ä
, 
”ºo
)

538 
	`bŒfs_·nic
(
fs_šfo
, 
”ºo
,

540 
by‹Ä
);

541 
	}
}

543 
bŒfs_back»f_add_Œ“_node
(
bŒfs_Œªs_hªdË
 *
Œªs
,

544 
bŒfs_back»f_ÿche
 *
ÿche
,

545 
bŒfs_·th
 *
·th
,

546 
bŒfs_back»f_™”
 *
™”
,

547 
bŒfs_key
 *
node_key
,

548 
bŒfs_back»f_node
 *
cur
);

550 
bŒfs_back»f_fšish_uµ”_lšks
(
bŒfs_back»f_ÿche
 *
ÿche
,

551 
bŒfs_back»f_node
 *
¡¬t
);

553 
bŒfs_back»f_”rÜ_ş—nup
(
bŒfs_back»f_ÿche
 *
ÿche
,

554 
bŒfs_back»f_node
 *
node
);

	@bio.c

7 
	~<lšux/bio.h
>

8 
	~"bio.h
"

9 
	~"ù»e.h
"

10 
	~"vŞumes.h
"

11 
	~"¿id56.h
"

12 
	~"async-th»ad.h
"

13 
	~"check-š‹gr™y.h
"

14 
	~"dev-»¶aû.h
"

15 
	~"rcu-¡ršg.h
"

16 
	~"zÚed.h
"

17 
	~"fe-™em.h
"

19 
bio_£t
 
	gbŒfs_bio£t
;

20 
bio_£t
 
	gbŒfs_şÚe_bio£t
;

21 
bio_£t
 
	gbŒfs_»·œ_bio£t
;

22 
mempoŞ_t
 
	gbŒfs_çed_bio_poŞ
;

24 
	sbŒfs_çed_bio
 {

25 
bŒfs_bio
 *
	mbbio
;

26 
	mnum_cİ›s
;

27 
©omic_t
 
	m»·œ_couÁ
;

31 
šlše
 
boŞ
 
	$is_d©a_bbio
(
bŒfs_bio
 *
bbio
)

33  
bbio
->
šode
 && 
	`is_d©a_šode
(&bbio->šode->
vfs_šode
);

34 
	}
}

36 
boŞ
 
	$bbio_has_Üd”ed_ex‹Á
(
bŒfs_bio
 *
bbio
)

38  
	`is_d©a_bbio
(
bbio
è&& 
	`bŒfs_İ
(&bbio->
bio
è=ğ
BTRFS_MAP_WRITE
;

39 
	}
}

45 
	$bŒfs_bio_š™
(
bŒfs_bio
 *
bbio
, 
bŒfs_fs_šfo
 *
fs_šfo
,

46 
bŒfs_bio_’d_io_t
 
’d_io
, *
´iv©e
)

48 
	`mem£t
(
bbio
, 0, 
	`off£tof
(
bŒfs_bio
, 
bio
));

49 
bbio
->
fs_šfo
 = fs_info;

50 
bbio
->
’d_io
 =ƒnd_io;

51 
bbio
->
´iv©e
 =…rivate;

52 
	`©omic_£t
(&
bbio
->
³ndšg_ios
, 1);

53 
	}
}

62 
bŒfs_bio
 *
	$bŒfs_bio_®loc
(
Ä_vecs
, 
blk_İf_t
 
İf
,

63 
bŒfs_fs_šfo
 *
fs_šfo
,

64 
bŒfs_bio_’d_io_t
 
’d_io
, *
´iv©e
)

66 
bŒfs_bio
 *
bbio
;

67 
bio
 *bio;

69 
bio
 = 
	`bio_®loc_bio£t
(
NULL
, 
Ä_vecs
, 
İf
, 
GFP_NOFS
, &
bŒfs_bio£t
);

70 
bbio
 = 
	`bŒfs_bio
(
bio
);

71 
	`bŒfs_bio_š™
(
bbio
, 
fs_šfo
, 
’d_io
, 
´iv©e
);

72  
bbio
;

73 
	}
}

75 
bŒfs_bio
 *
	$bŒfs_¥l™_bio
(
bŒfs_fs_šfo
 *
fs_šfo
,

76 
bŒfs_bio
 *
Üig_bbio
,

77 
u64
 
m­_Ëngth
, 
boŞ
 
u£_­³nd
)

79 
bŒfs_bio
 *
bbio
;

80 
bio
 *bio;

82 ià(
u£_­³nd
) {

83 
Ä_£gs
;

85 
bio
 = 
	`bio_¥l™_rw
(&
Üig_bbio
->bio, &
fs_šfo
->
lim™s
, &
Ä_£gs
,

86 &
bŒfs_şÚe_bio£t
, 
m­_Ëngth
);

88 
bio
 = 
	`bio_¥l™
(&
Üig_bbio
->bio, 
m­_Ëngth
 >> 
SECTOR_SHIFT
,

89 
GFP_NOFS
, &
bŒfs_şÚe_bio£t
);

91 
bbio
 = 
	`bŒfs_bio
(
bio
);

92 
	`bŒfs_bio_š™
(
bbio
, 
fs_šfo
, 
NULL
, 
Üig_bbio
);

93 
bbio
->
šode
 = 
Üig_bbio
->inode;

94 
bbio
->
fe_off£t
 = 
Üig_bbio
->file_offset;

95 
Üig_bbio
->
fe_off£t
 +ğ
m­_Ëngth
;

96 ià(
	`bbio_has_Üd”ed_ex‹Á
(
bbio
)) {

97 
	`»fcouÁ_šc
(&
Üig_bbio
->
Üd”ed
->
»fs
);

98 
bbio
->
Üd”ed
 = 
Üig_bbio
->ordered;

100 
	`©omic_šc
(&
Üig_bbio
->
³ndšg_ios
);

101  
bbio
;

102 
	}
}

105 
	$bŒfs_ş—nup_bio
(
bŒfs_bio
 *
bbio
)

107 ià(
	`bbio_has_Üd”ed_ex‹Á
(
bbio
))

108 
	`bŒfs_put_Üd”ed_ex‹Á
(
bbio
->
Üd”ed
);

109 
	`bio_put
(&
bbio
->
bio
);

110 
	}
}

112 
	$__bŒfs_bio_’d_io
(
bŒfs_bio
 *
bbio
)

114 ià(
	`bbio_has_Üd”ed_ex‹Á
(
bbio
)) {

115 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
 = 
bbio
->ordered;

117 
bbio
->
	`’d_io
(bbio);

118 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

120 
bbio
->
	`’d_io
(bbio);

122 
	}
}

124 
	$bŒfs_bio_’d_io
(
bŒfs_bio
 *
bbio
, 
blk_¡©us_t
 
¡©us
)

126 
bbio
->
bio
.
bi_¡©us
 = 
¡©us
;

127 
	`__bŒfs_bio_’d_io
(
bbio
);

128 
	}
}

130 
bŒfs_Üig_wr™e_’d_io
(
bio
 *bio);

132 
	$bŒfs_bbio_´İag©e_”rÜ
(
bŒfs_bio
 *
bbio
,

133 
bŒfs_bio
 *
Üig_bbio
)

141 ià(
bbio
->
bio
.
bi_’d_io
 =ğ&
bŒfs_Üig_wr™e_’d_io
) {

142 
bŒfs_io_¡re
 *
Üig_¡re
 = 
Üig_bbio
->
bio
.
bi_´iv©e
;

143 
bŒfs_io_cÚ‹xt
 *
Üig_bioc
 = 
Üig_¡re
->
bioc
;

145 
	`©omic_add
(
Üig_bioc
->
max_”rÜs
, &Üig_bioc->
”rÜ
);

147 
Üig_bbio
->
bio
.
bi_¡©us
 = 
bbio
->bio.bi_status;

149 
	}
}

151 
	$bŒfs_Üig_bbio_’d_io
(
bŒfs_bio
 *
bbio
)

153 ià(
bbio
->
bio
.
bi_poŞ
 =ğ&
bŒfs_şÚe_bio£t
) {

154 
bŒfs_bio
 *
Üig_bbio
 = 
bbio
->
´iv©e
;

156 ià(
bbio
->
bio
.
bi_¡©us
)

157 
	`bŒfs_bbio_´İag©e_”rÜ
(
bbio
, 
Üig_bbio
);

158 
	`bŒfs_ş—nup_bio
(
bbio
);

159 
bbio
 = 
Üig_bbio
;

162 ià(
	`©omic_dec_ªd_‹¡
(&
bbio
->
³ndšg_ios
))

163 
	`__bŒfs_bio_’d_io
(
bbio
);

164 
	}
}

166 
	$Ãxt_»·œ_mœrÜ
(
bŒfs_çed_bio
 *
fbio
, 
cur_mœrÜ
)

168 ià(
cur_mœrÜ
 =ğ
fbio
->
num_cİ›s
)

169  
cur_mœrÜ
 + 1 - 
fbio
->
num_cİ›s
;

170  
cur_mœrÜ
 + 1;

171 
	}
}

173 
	$´ev_»·œ_mœrÜ
(
bŒfs_çed_bio
 *
fbio
, 
cur_mœrÜ
)

175 ià(
cur_mœrÜ
 == 1)

176  
fbio
->
num_cİ›s
;

177  
cur_mœrÜ
 - 1;

178 
	}
}

180 
	$bŒfs_»·œ_dÚe
(
bŒfs_çed_bio
 *
fbio
)

182 ià(
	`©omic_dec_ªd_‹¡
(&
fbio
->
»·œ_couÁ
)) {

183 
	`bŒfs_Üig_bbio_’d_io
(
fbio
->
bbio
);

184 
	`mempoŞ_ä“
(
fbio
, &
bŒfs_çed_bio_poŞ
);

186 
	}
}

188 
	$bŒfs_’d_»·œ_bio
(
bŒfs_bio
 *
»·œ_bbio
,

189 
bŒfs_deviû
 *
dev
)

191 
bŒfs_çed_bio
 *
fbio
 = 
»·œ_bbio
->
´iv©e
;

192 
bŒfs_šode
 *
šode
 = 
»·œ_bbio
->inode;

193 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

194 
bio_vec
 *
bv
 = 
	`bio_fœ¡_bvec_®l
(&
»·œ_bbio
->
bio
);

195 
mœrÜ
 = 
»·œ_bbio
->
mœrÜ_num
;

197 ià(
»·œ_bbio
->
bio
.
bi_¡©us
 ||

198 !
	`bŒfs_d©a_csum_ok
(
»·œ_bbio
, 
dev
, 0, 
bv
)) {

199 
	`bio_»£t
(&
»·œ_bbio
->
bio
, 
NULL
, 
REQ_OP_READ
);

200 
»·œ_bbio
->
bio
.
bi_™”
 =„•aœ_bbio->
§ved_™”
;

202 
mœrÜ
 = 
	`Ãxt_»·œ_mœrÜ
(
fbio
, mirror);

203 ià(
mœrÜ
 =ğ
fbio
->
bbio
->
mœrÜ_num
) {

204 
	`bŒfs_debug
(
fs_šfo
, "no mirror†eft");

205 
fbio
->
bbio
->
bio
.
bi_¡©us
 = 
BLK_STS_IOERR
;

206 
dÚe
;

209 
	`bŒfs_subm™_bio
(
»·œ_bbio
, 
mœrÜ
);

214 
mœrÜ
 = 
	`´ev_»·œ_mœrÜ
(
fbio
, mirror);

215 
	`bŒfs_»·œ_io_çu»
(
fs_šfo
, 
	`bŒfs_šo
(
šode
),

216 
»·œ_bbio
->
fe_off£t
, 
fs_šfo
->
£ùÜsize
,

217 
»·œ_bbio
->
§ved_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
,

218 
bv
->
bv_·ge
, bv->
bv_off£t
, 
mœrÜ
);

219 } 
mœrÜ
 !ğ
fbio
->
bbio
->
mœrÜ_num
);

221 
dÚe
:

222 
	`bŒfs_»·œ_dÚe
(
fbio
);

223 
	`bio_put
(&
»·œ_bbio
->
bio
);

224 
	}
}

233 
bŒfs_çed_bio
 *
	$»·œ_Úe_£ùÜ
(
bŒfs_bio
 *
çed_bbio
,

234 
u32
 
bio_off£t
,

235 
bio_vec
 *
bv
,

236 
bŒfs_çed_bio
 *
fbio
)

238 
bŒfs_šode
 *
šode
 = 
çed_bbio
->inode;

239 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

240 cÚ¡ 
u32
 
£ùÜsize
 = 
fs_šfo
->sectorsize;

241 cÚ¡ 
u64
 
logiÿl
 = (
çed_bbio
->
§ved_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
);

242 
bŒfs_bio
 *
»·œ_bbio
;

243 
bio
 *
»·œ_bio
;

244 
num_cİ›s
;

245 
mœrÜ
;

247 
	`bŒfs_debug
(
fs_šfo
, "repair„eadƒrror:„eadƒrror‡t %llu",

248 
çed_bbio
->
fe_off£t
 + 
bio_off£t
);

250 
num_cİ›s
 = 
	`bŒfs_num_cİ›s
(
fs_šfo
, 
logiÿl
, 
£ùÜsize
);

251 ià(
num_cİ›s
 == 1) {

252 
	`bŒfs_debug
(
fs_šfo
, "no copyo„epair from");

253 
çed_bbio
->
bio
.
bi_¡©us
 = 
BLK_STS_IOERR
;

254  
fbio
;

257 ià(!
fbio
) {

258 
fbio
 = 
	`mempoŞ_®loc
(&
bŒfs_çed_bio_poŞ
, 
GFP_NOFS
);

259 
fbio
->
bbio
 = 
çed_bbio
;

260 
fbio
->
num_cİ›s
 =‚um_copies;

261 
	`©omic_£t
(&
fbio
->
»·œ_couÁ
, 1);

264 
	`©omic_šc
(&
fbio
->
»·œ_couÁ
);

266 
»·œ_bio
 = 
	`bio_®loc_bio£t
(
NULL
, 1, 
REQ_OP_READ
, 
GFP_NOFS
,

267 &
bŒfs_»·œ_bio£t
);

268 
»·œ_bio
->
bi_™”
.
bi_£ùÜ
 = 
çed_bbio
->
§ved_™”
.bi_sector;

269 
	`__bio_add_·ge
(
»·œ_bio
, 
bv
->
bv_·ge
, bv->
bv_Ën
, bv->
bv_off£t
);

271 
»·œ_bbio
 = 
	`bŒfs_bio
(
»·œ_bio
);

272 
	`bŒfs_bio_š™
(
»·œ_bbio
, 
fs_šfo
, 
NULL
, 
fbio
);

273 
»·œ_bbio
->
šode
 = 
çed_bbio
->inode;

274 
»·œ_bbio
->
fe_off£t
 = 
çed_bbio
->fe_off£ˆ+ 
bio_off£t
;

276 
mœrÜ
 = 
	`Ãxt_»·œ_mœrÜ
(
fbio
, 
çed_bbio
->
mœrÜ_num
);

277 
	`bŒfs_debug
(
fs_šfo
, "subm™tšg„•aœ„—dØmœrÜ %d", 
mœrÜ
);

278 
	`bŒfs_subm™_bio
(
»·œ_bbio
, 
mœrÜ
);

279  
fbio
;

280 
	}
}

282 
	$bŒfs_check_»ad_bio
(
bŒfs_bio
 *
bbio
, 
bŒfs_deviû
 *
dev
)

284 
bŒfs_šode
 *
šode
 = 
bbio
->inode;

285 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

286 
u32
 
£ùÜsize
 = 
fs_šfo
->sectorsize;

287 
bvec_™”
 *
™”
 = &
bbio
->
§ved_™”
;

288 
blk_¡©us_t
 
¡©us
 = 
bbio
->
bio
.
bi_¡©us
;

289 
bŒfs_çed_bio
 *
fbio
 = 
NULL
;

290 
u32
 
off£t
 = 0;

293 
	`ASSERT
(
šode
);

299 ià(
bbio
->
bio
.
bi_poŞ
 =ğ&
bŒfs_»·œ_bio£t
) {

300 
	`bŒfs_’d_»·œ_bio
(
bbio
, 
dev
);

305 
bbio
->
bio
.
bi_¡©us
 = 
BLK_STS_OK
;

307 
™”
->
bi_size
) {

308 
bio_vec
 
bv
 = 
	`bio_™”_iovec
(&
bbio
->
bio
, *
™”
);

310 
bv
.
bv_Ën
 = 
	`mš
(bv.bv_Ën, 
£ùÜsize
);

312 ià(
¡©us
 || !
	`bŒfs_d©a_csum_ok
(
bbio
, 
dev
, 
off£t
, &
bv
))

313 
fbio
 = 
	`»·œ_Úe_£ùÜ
(
bbio
, 
off£t
, &
bv
, fbio);

315 
	`bio_advªû_™”_sšgË
(&
bbio
->
bio
, 
™”
, 
£ùÜsize
);

316 
off£t
 +ğ
£ùÜsize
;

319 ià(
bbio
->
csum
 !ğbbio->
csum_šlše
)

320 
	`kä“
(
bbio
->
csum
);

322 ià(
fbio
)

323 
	`bŒfs_»·œ_dÚe
(
fbio
);

325 
	`bŒfs_Üig_bbio_’d_io
(
bbio
);

326 
	}
}

328 
	$bŒfs_log_dev_io_”rÜ
(
bio
 *bio, 
bŒfs_deviû
 *
dev
)

330 ià(!
dev
 || !dev->
bdev
)

332 ià(
bio
->
bi_¡©us
 !ğ
BLK_STS_IOERR
 && bio->bi_¡©u !ğ
BLK_STS_TARGET
)

335 ià(
	`bŒfs_İ
(
bio
è=ğ
BTRFS_MAP_WRITE
)

336 
	`bŒfs_dev_¡©_šc_ªd_´št
(
dev
, 
BTRFS_DEV_STAT_WRITE_ERRS
);

337 ià(!(
bio
->
bi_İf
 & 
REQ_RAHEAD
))

338 
	`bŒfs_dev_¡©_šc_ªd_´št
(
dev
, 
BTRFS_DEV_STAT_READ_ERRS
);

339 ià(
bio
->
bi_İf
 & 
REQ_PREFLUSH
)

340 
	`bŒfs_dev_¡©_šc_ªd_´št
(
dev
, 
BTRFS_DEV_STAT_FLUSH_ERRS
);

341 
	}
}

343 
wÜkqueue_¡ruù
 *
	$bŒfs_’d_io_wq
(
bŒfs_fs_šfo
 *
fs_šfo
,

344 
bio
 *bio)

346 ià(
bio
->
bi_İf
 & 
REQ_META
)

347  
fs_šfo
->
’dio_m‘a_wÜk”s
;

348  
fs_šfo
->
’dio_wÜk”s
;

349 
	}
}

351 
	$bŒfs_’d_bio_wÜk
(
wÜk_¡ruù
 *
wÜk
)

353 
bŒfs_bio
 *
bbio
 = 
	`cÚš”_of
(
wÜk
, bŒfs_bio, 
’d_io_wÜk
);

356 ià(
	`is_d©a_bbio
(
bbio
)) {

358 
	`bŒfs_check_»ad_bio
(
bbio
, bbio->
bio
.
bi_´iv©e
);

361 
	`bŒfs_Üig_bbio_’d_io
(
bbio
);

363 
	}
}

365 
	$bŒfs_sim¶e_’d_io
(
bio
 *bio)

367 
bŒfs_bio
 *
bbio
 = 
	`bŒfs_bio
(
bio
);

368 
bŒfs_deviû
 *
dev
 = 
bio
->
bi_´iv©e
;

369 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bbio
->fs_info;

371 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

373 ià(
bio
->
bi_¡©us
)

374 
	`bŒfs_log_dev_io_”rÜ
(
bio
, 
dev
);

376 ià(
	`bio_İ
(
bio
è=ğ
REQ_OP_READ
) {

377 
	`INIT_WORK
(&
bbio
->
’d_io_wÜk
, 
bŒfs_’d_bio_wÜk
);

378 
	`queue_wÜk
(
	`bŒfs_’d_io_wq
(
fs_šfo
, 
bio
), &
bbio
->
’d_io_wÜk
);

381 ià(
	`bio_İ
(
bio
è=ğ
REQ_OP_ZONE_APPEND
 && !bio->
bi_¡©us
)

382 
	`bŒfs_»cÜd_physiÿl_zÚed
(
bbio
);

383 
	`bŒfs_Üig_bbio_’d_io
(
bbio
);

385 
	}
}

387 
	$bŒfs_¿id56_’d_io
(
bio
 *bio)

389 
bŒfs_io_cÚ‹xt
 *
bioc
 = 
bio
->
bi_´iv©e
;

390 
bŒfs_bio
 *
bbio
 = 
	`bŒfs_bio
(
bio
);

392 
	`bŒfs_bio_couÁ”_dec
(
bioc
->
fs_šfo
);

393 
bbio
->
mœrÜ_num
 = 
bioc
->mirror_num;

394 ià(
	`bio_İ
(
bio
è=ğ
REQ_OP_READ
 && 
	`is_d©a_bbio
(
bbio
))

395 
	`bŒfs_check_»ad_bio
(
bbio
, 
NULL
);

397 
	`bŒfs_Üig_bbio_’d_io
(
bbio
);

399 
	`bŒfs_put_bioc
(
bioc
);

400 
	}
}

402 
	$bŒfs_Üig_wr™e_’d_io
(
bio
 *bio)

404 
bŒfs_io_¡re
 *
¡re
 = 
bio
->
bi_´iv©e
;

405 
bŒfs_io_cÚ‹xt
 *
bioc
 = 
¡re
->bioc;

406 
bŒfs_bio
 *
bbio
 = 
	`bŒfs_bio
(
bio
);

408 
	`bŒfs_bio_couÁ”_dec
(
bioc
->
fs_šfo
);

410 ià(
bio
->
bi_¡©us
) {

411 
	`©omic_šc
(&
bioc
->
”rÜ
);

412 
	`bŒfs_log_dev_io_”rÜ
(
bio
, 
¡re
->
dev
);

419 ià(
	`©omic_»ad
(&
bioc
->
”rÜ
è> bioc->
max_”rÜs
)

420 
bio
->
bi_¡©us
 = 
BLK_STS_IOERR
;

422 
bio
->
bi_¡©us
 = 
BLK_STS_OK
;

424 
	`bŒfs_Üig_bbio_’d_io
(
bbio
);

425 
	`bŒfs_put_bioc
(
bioc
);

426 
	}
}

428 
	$bŒfs_şÚe_wr™e_’d_io
(
bio
 *bio)

430 
bŒfs_io_¡re
 *
¡re
 = 
bio
->
bi_´iv©e
;

432 ià(
bio
->
bi_¡©us
) {

433 
	`©omic_šc
(&
¡re
->
bioc
->
”rÜ
);

434 
	`bŒfs_log_dev_io_”rÜ
(
bio
, 
¡re
->
dev
);

438 
	`bio_’dio
(
¡re
->
bioc
->
Üig_bio
);

439 
	`bio_put
(
bio
);

440 
	}
}

442 
	$bŒfs_subm™_dev_bio
(
bŒfs_deviû
 *
dev
, 
bio
 *bio)

444 ià(!
dev
 || !dev->
bdev
 ||

445 
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
, &
dev
->
dev_¡©e
) ||

446 (
	`bŒfs_İ
(
bio
è=ğ
BTRFS_MAP_WRITE
 &&

447 !
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
dev
->
dev_¡©e
))) {

448 
	`bio_io_”rÜ
(
bio
);

452 
	`bio_£t_dev
(
bio
, 
dev
->
bdev
);

458 ià(
	`bio_İ
(
bio
è=ğ
REQ_OP_ZONE_APPEND
) {

459 
u64
 
physiÿl
 = 
bio
->
bi_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
;

460 
u64
 
zÚe_¡¬t
 = 
	`round_down
(
physiÿl
, 
dev
->
fs_šfo
->
zÚe_size
);

462 
	`ASSERT
(
	`bŒfs_dev_is_£qu’tŸl
(
dev
, 
physiÿl
));

463 
bio
->
bi_™”
.
bi_£ùÜ
 = 
zÚe_¡¬t
 >> 
SECTOR_SHIFT
;

465 
	`bŒfs_debug_š_rcu
(
dev
->
fs_šfo
,

467 
__func__
, 
	`bio_İ
(
bio
), bio->
bi_İf
, bio->
bi_™”
.
bi_£ùÜ
,

468 ()
dev
->
bdev
->
bd_dev
, 
	`bŒfs_dev_Çme
(dev),

469 
dev
->
devid
, 
bio
->
bi_™”
.
bi_size
);

471 
	`bŒfsic_check_bio
(
bio
);

473 ià(
bio
->
bi_İf
 & 
REQ_BTRFS_CGROUP_PUNT
)

474 
	`blkcg_puÁ_bio_subm™
(
bio
);

476 
	`subm™_bio
(
bio
);

477 
	}
}

479 
	$bŒfs_subm™_mœrÜed_bio
(
bŒfs_io_cÚ‹xt
 *
bioc
, 
dev_Ä
)

481 
bio
 *
Üig_bio
 = 
bioc
->orig_bio, *bio;

483 
	`ASSERT
(
	`bio_İ
(
Üig_bio
è!ğ
REQ_OP_READ
);

486 ià(
dev_Ä
 =ğ
bioc
->
num_¡res
 - 1) {

487 
bio
 = 
Üig_bio
;

488 
bio
->
bi_’d_io
 = 
bŒfs_Üig_wr™e_’d_io
;

490 
bio
 = 
	`bio_®loc_şÚe
(
NULL
, 
Üig_bio
, 
GFP_NOFS
, &
fs_bio_£t
);

491 
	`bio_šc_»maššg
(
Üig_bio
);

492 
bio
->
bi_’d_io
 = 
bŒfs_şÚe_wr™e_’d_io
;

495 
bio
->
bi_´iv©e
 = &
bioc
->
¡res
[
dev_Ä
];

496 
bio
->
bi_™”
.
bi_£ùÜ
 = 
bioc
->
¡res
[
dev_Ä
].
physiÿl
 >> 
SECTOR_SHIFT
;

497 
bioc
->
¡res
[
dev_Ä
].bioc = bioc;

498 
	`bŒfs_subm™_dev_bio
(
bioc
->
¡res
[
dev_Ä
].
dev
, 
bio
);

499 
	}
}

501 
	$__bŒfs_subm™_bio
(
bio
 *bio, 
bŒfs_io_cÚ‹xt
 *
bioc
,

502 
bŒfs_io_¡re
 *
sm­
, 
mœrÜ_num
)

504 ià(!
bioc
) {

506 
	`bŒfs_bio
(
bio
)->
mœrÜ_num
 = mirror_num;

507 
bio
->
bi_™”
.
bi_£ùÜ
 = 
sm­
->
physiÿl
 >> 
SECTOR_SHIFT
;

508 ià(
	`bio_İ
(
bio
è!ğ
REQ_OP_READ
)

509 
	`bŒfs_bio
(
bio
)->
Üig_physiÿl
 = 
sm­
->
physiÿl
;

510 
bio
->
bi_´iv©e
 = 
sm­
->
dev
;

512 
bio
->
bi_’d_io
 = 
bŒfs_sim¶e_’d_io
;

513 
	`bŒfs_subm™_dev_bio
(
sm­
->
dev
, 
bio
);

514 } ià(
bioc
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

516 
bio
->
bi_´iv©e
 = 
bioc
;

517 
bio
->
bi_’d_io
 = 
bŒfs_¿id56_’d_io
;

518 ià(
	`bio_İ
(
bio
è=ğ
REQ_OP_READ
)

519 
	`¿id56_·r™y_»cov”
(
bio
, 
bioc
, 
mœrÜ_num
);

521 
	`¿id56_·r™y_wr™e
(
bio
, 
bioc
);

524 
tÙ®_devs
 = 
bioc
->
num_¡res
;

526 
bioc
->
Üig_bio
 = 
bio
;

527 
dev_Ä
 = 0; dev_Ä < 
tÙ®_devs
; dev_nr++)

528 
	`bŒfs_subm™_mœrÜed_bio
(
bioc
, 
dev_Ä
);

530 
	}
}

532 
blk_¡©us_t
 
	$bŒfs_bio_csum
(
bŒfs_bio
 *
bbio
)

534 ià(
bbio
->
bio
.
bi_İf
 & 
REQ_META
)

535  
	`bŒ“_csum_Úe_bio
(
bbio
);

536  
	`bŒfs_csum_Úe_bio
(
bbio
);

537 
	}
}

543 
	sasync_subm™_bio
 {

544 
bŒfs_bio
 *
	mbbio
;

545 
bŒfs_io_cÚ‹xt
 *
	mbioc
;

546 
bŒfs_io_¡re
 
	msm­
;

547 
	mmœrÜ_num
;

548 
bŒfs_wÜk
 
	mwÜk
;

559 
	$run_Úe_async_¡¬t
(
bŒfs_wÜk
 *
wÜk
)

561 
async_subm™_bio
 *
async
 =

562 
	`cÚš”_of
(
wÜk
, 
async_subm™_bio
, work);

564 
blk_¡©us_t
 
»t
;

568 ià(
»t
)

569 
async
->
bbio
->
bio
.
bi_¡©us
 = 
»t
;

570 
	}
}

580 
	$run_Úe_async_dÚe
(
bŒfs_wÜk
 *
wÜk
)

582 
async_subm™_bio
 *
async
 =

583 
	`cÚš”_of
(
wÜk
, 
async_subm™_bio
, work);

584 
bio
 *biØğ&
async
->
bbio
->bio;

587 ià(
bio
->
bi_¡©us
) {

588 
	`bŒfs_Üig_bbio_’d_io
(
async
->
bbio
);

597 
bio
->
bi_İf
 |ğ
REQ_BTRFS_CGROUP_PUNT
;

598 
	`__bŒfs_subm™_bio
(
bio
, 
async
->
bioc
, &async->
sm­
,‡sync->
mœrÜ_num
);

599 
	}
}

601 
	$run_Úe_async_ä“
(
bŒfs_wÜk
 *
wÜk
)

603 
	`kä“
(
	`cÚš”_of
(
wÜk
, 
async_subm™_bio
, work));

604 
	}
}

606 
boŞ
 
	$should_async_wr™e
(
bŒfs_bio
 *
bbio
)

609 ià(
	`‹¡_b™
(
BTRFS_FS_CSUM_IMPL_FAST
, &
bbio
->
fs_šfo
->
æags
))

610  
çl£
;

616 ià(
	`İ_is_sync
(
bbio
->
bio
.
bi_İf
))

617  
çl£
;

620 ià((
bbio
->
bio
.
bi_İf
 & 
REQ_META
è&& 
	`bŒfs_is_zÚed
(bbio->
fs_šfo
))

621  
çl£
;

623  
Œue
;

624 
	}
}

631 
boŞ
 
	$bŒfs_wq_subm™_bio
(
bŒfs_bio
 *
bbio
,

632 
bŒfs_io_cÚ‹xt
 *
bioc
,

633 
bŒfs_io_¡re
 *
sm­
, 
mœrÜ_num
)

635 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bbio
->fs_info;

636 
async_subm™_bio
 *
async
;

638 
async
 = 
	`km®loc
((*async), 
GFP_NOFS
);

639 ià(!
async
)

640  
çl£
;

642 
async
->
bbio
 = bbio;

643 
async
->
bioc
 = bioc;

644 
async
->
sm­
 = *smap;

645 
async
->
mœrÜ_num
 = mirror_num;

647 
	`bŒfs_š™_wÜk
(&
async
->
wÜk
, 
run_Úe_async_¡¬t
, 
run_Úe_async_dÚe
,

648 
run_Úe_async_ä“
);

649 
	`bŒfs_queue_wÜk
(
fs_šfo
->
wÜk”s
, &
async
->
wÜk
);

650  
Œue
;

651 
	}
}

653 
boŞ
 
	$bŒfs_subm™_chunk
(
bŒfs_bio
 *
bbio
, 
mœrÜ_num
)

655 
bŒfs_šode
 *
šode
 = 
bbio
->inode;

656 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bbio
->fs_info;

657 
bŒfs_bio
 *
Üig_bbio
 = 
bbio
;

658 
bio
 *biØğ&
bbio
->bio;

659 
u64
 
logiÿl
 = 
bio
->
bi_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
;

660 
u64
 
Ëngth
 = 
bio
->
bi_™”
.
bi_size
;

661 
u64
 
m­_Ëngth
 = 
Ëngth
;

662 
boŞ
 
u£_­³nd
 = 
	`bŒfs_u£_zÚe_­³nd
(
bbio
);

663 
bŒfs_io_cÚ‹xt
 *
bioc
 = 
NULL
;

664 
bŒfs_io_¡re
 
sm­
;

665 
blk_¡©us_t
 
»t
;

666 
”rÜ
;

669 
	`bŒfs_bio_couÁ”_šc_blocked
(
fs_šfo
);

670 
”rÜ
 = 
	`bŒfs_m­_block
(
fs_šfo
, 
	`bŒfs_İ
(
bio
), 
logiÿl
, &
m­_Ëngth
,

671 &
bioc
, &
sm­
, &
mœrÜ_num
, 1);

672 ià(
”rÜ
) {

673 
»t
 = 
	`”ºo_to_blk_¡©us
(
”rÜ
);

674 
ç
;

677 
m­_Ëngth
 = 
	`mš
(m­_Ëngth, 
Ëngth
);

678 ià(
u£_­³nd
)

679 
m­_Ëngth
 = 
	`mš
(m­_Ëngth, 
fs_šfo
->
max_zÚe_­³nd_size
);

681 ià(
m­_Ëngth
 < 
Ëngth
) {

682 
bbio
 = 
	`bŒfs_¥l™_bio
(
fs_šfo
, bbio, 
m­_Ëngth
, 
u£_­³nd
);

683 
bio
 = &
bbio
->bio;

690 ià(
	`bio_İ
(
bio
è=ğ
REQ_OP_READ
 && 
	`is_d©a_bbio
(
bbio
)) {

691 
bbio
->
§ved_™”
 = 
bio
->
bi_™”
;

694 ià(
»t
)

695 
ç_put_bio
;

698 ià(
	`bŒfs_İ
(
bio
è=ğ
BTRFS_MAP_WRITE
) {

699 ià(
u£_­³nd
) {

700 
bio
->
bi_İf
 &ğ~
REQ_OP_WRITE
;

701 
bio
->
bi_İf
 |ğ
REQ_OP_ZONE_APPEND
;

708 ià(
šode
 && !(šode->
æags
 & 
BTRFS_INODE_NODATASUM
) &&

709 !
	`‹¡_b™
(
BTRFS_FS_STATE_NO_CSUMS
, &
fs_šfo
->
fs_¡©e
) &&

710 !
	`bŒfs_is_d©a_»loc_roÙ
(
šode
->
roÙ
)) {

711 ià(
	`should_async_wr™e
(
bbio
) &&

712 
	`bŒfs_wq_subm™_bio
(
bbio
, 
bioc
, &
sm­
, 
mœrÜ_num
))

713 
dÚe
;

718 ià(
»t
)

719 
ç_put_bio
;

720 } ià(
u£_­³nd
) {

721 
»t
 = 
	`bŒfs_®loc_dummy_sum
(
bbio
);

722 ià(
»t
)

723 
ç_put_bio
;

728 
	`__bŒfs_subm™_bio
(
bio
, 
bioc
, &
sm­
, 
mœrÜ_num
);

729 
dÚe
:

730  
m­_Ëngth
 =ğ
Ëngth
;

732 
ç_put_bio
:

733 ià(
m­_Ëngth
 < 
Ëngth
)

734 
	`bŒfs_ş—nup_bio
(
bbio
);

735 
ç
:

736 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

737 
	`bŒfs_bio_’d_io
(
Üig_bbio
, 
»t
);

739  
Œue
;

740 
	}
}

742 
	$bŒfs_subm™_bio
(
bŒfs_bio
 *
bbio
, 
mœrÜ_num
)

745 
	`ASSERT
(
bbio
->
šode
 || bbio->
fe_off£t
 == 0);

747 !
	`bŒfs_subm™_chunk
(
bbio
, 
mœrÜ_num
))

749 
	}
}

761 
	$bŒfs_»·œ_io_çu»
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
šo
, u64 
¡¬t
,

762 
u64
 
Ëngth
, u64 
logiÿl
, 
·ge
 *page,

763 
pg_off£t
, 
mœrÜ_num
)

765 
bŒfs_io_¡re
 
sm­
 = { 0 };

766 
bio_vec
 
bvec
;

767 
bio
 bio;

768 
»t
 = 0;

770 
	`ASSERT
(!(
fs_šfo
->
sb
->
s_æags
 & 
SB_RDONLY
));

771 
	`BUG_ON
(!
mœrÜ_num
);

773 ià(
	`bŒfs_»·œ_Úe_zÚe
(
fs_šfo
, 
logiÿl
))

781 
	`bŒfs_bio_couÁ”_šc_blocked
(
fs_šfo
);

782 
»t
 = 
	`bŒfs_m­_»·œ_block
(
fs_šfo
, &
sm­
, 
logiÿl
, 
Ëngth
, 
mœrÜ_num
);

783 ià(
»t
 < 0)

784 
out_couÁ”_dec
;

786 ià(!
sm­
.
dev
->
bdev
 ||

787 !
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
sm­
.
dev
->
dev_¡©e
)) {

788 
»t
 = -
EIO
;

789 
out_couÁ”_dec
;

792 
	`bio_š™
(&
bio
, 
sm­
.
dev
->
bdev
, &
bvec
, 1, 
REQ_OP_WRITE
 | 
REQ_SYNC
);

793 
bio
.
bi_™”
.
bi_£ùÜ
 = 
sm­
.
physiÿl
 >> 
SECTOR_SHIFT
;

794 
	`__bio_add_·ge
(&
bio
, 
·ge
, 
Ëngth
, 
pg_off£t
);

796 
	`bŒfsic_check_bio
(&
bio
);

797 
»t
 = 
	`subm™_bio_wa™
(&
bio
);

798 ià(
»t
) {

800 
	`bŒfs_dev_¡©_šc_ªd_´št
(
sm­
.
dev
, 
BTRFS_DEV_STAT_WRITE_ERRS
);

801 
out_bio_unš™
;

804 
	`bŒfs_šfo_¾_š_rcu
(
fs_šfo
,

806 
šo
, 
¡¬t
, 
	`bŒfs_dev_Çme
(
sm­
.
dev
),

807 
sm­
.
physiÿl
 >> 
SECTOR_SHIFT
);

808 
»t
 = 0;

810 
out_bio_unš™
:

811 
	`bio_unš™
(&
bio
);

812 
out_couÁ”_dec
:

813 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

814  
»t
;

815 
	}
}

822 
	$bŒfs_subm™_»·œ_wr™e
(
bŒfs_bio
 *
bbio
, 
mœrÜ_num
, 
boŞ
 
dev_»¶aû
)

824 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bbio
->fs_info;

825 
u64
 
logiÿl
 = 
bbio
->
bio
.
bi_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
;

826 
u64
 
Ëngth
 = 
bbio
->
bio
.
bi_™”
.
bi_size
;

827 
bŒfs_io_¡re
 
sm­
 = { 0 };

828 
»t
;

830 
	`ASSERT
(
fs_šfo
);

831 
	`ASSERT
(
mœrÜ_num
 > 0);

832 
	`ASSERT
(
	`bŒfs_İ
(&
bbio
->
bio
è=ğ
BTRFS_MAP_WRITE
);

833 
	`ASSERT
(!
bbio
->
šode
);

835 
	`bŒfs_bio_couÁ”_šc_blocked
(
fs_šfo
);

836 
»t
 = 
	`bŒfs_m­_»·œ_block
(
fs_šfo
, &
sm­
, 
logiÿl
, 
Ëngth
, 
mœrÜ_num
);

837 ià(
»t
 < 0)

838 
ç
;

840 ià(
dev_»¶aû
) {

841 
	`ASSERT
(
sm­
.
dev
 =ğ
fs_šfo
->
dev_»¶aû
.
¤cdev
);

842 
sm­
.
dev
 = 
fs_šfo
->
dev_»¶aû
.
tgtdev
;

844 
	`__bŒfs_subm™_bio
(&
bbio
->
bio
, 
NULL
, &
sm­
, 
mœrÜ_num
);

847 
ç
:

848 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

849 
	`bŒfs_bio_’d_io
(
bbio
, 
	`”ºo_to_blk_¡©us
(
»t
));

850 
	}
}

852 
__š™
 
	$bŒfs_bio£t_š™
()

854 ià(
	`bio£t_š™
(&
bŒfs_bio£t
, 
BIO_POOL_SIZE
,

855 
	`off£tof
(
bŒfs_bio
, 
bio
),

856 
BIOSET_NEED_BVECS
))

857  -
ENOMEM
;

858 ià(
	`bio£t_š™
(&
bŒfs_şÚe_bio£t
, 
BIO_POOL_SIZE
,

859 
	`off£tof
(
bŒfs_bio
, 
bio
), 0))

860 
out_ä“_bio£t
;

861 ià(
	`bio£t_š™
(&
bŒfs_»·œ_bio£t
, 
BIO_POOL_SIZE
,

862 
	`off£tof
(
bŒfs_bio
, 
bio
),

863 
BIOSET_NEED_BVECS
))

864 
out_ä“_şÚe_bio£t
;

865 ià(
	`mempoŞ_š™_km®loc_poŞ
(&
bŒfs_çed_bio_poŞ
, 
BIO_POOL_SIZE
,

866 (
bŒfs_çed_bio
)))

867 
out_ä“_»·œ_bio£t
;

870 
out_ä“_»·œ_bio£t
:

871 
	`bio£t_ex™
(&
bŒfs_»·œ_bio£t
);

872 
out_ä“_şÚe_bio£t
:

873 
	`bio£t_ex™
(&
bŒfs_şÚe_bio£t
);

874 
out_ä“_bio£t
:

875 
	`bio£t_ex™
(&
bŒfs_bio£t
);

876  -
ENOMEM
;

877 
	}
}

879 
__cŞd
 
	$bŒfs_bio£t_ex™
()

881 
	`mempoŞ_ex™
(&
bŒfs_çed_bio_poŞ
);

882 
	`bio£t_ex™
(&
bŒfs_»·œ_bio£t
);

883 
	`bio£t_ex™
(&
bŒfs_şÚe_bio£t
);

884 
	`bio£t_ex™
(&
bŒfs_bio£t
);

885 
	}
}

	@bio.h

7 #iâdeà
BTRFS_BIO_H


8 
	#BTRFS_BIO_H


	)

10 
	~<lšux/bio.h
>

11 
	~<lšux/wÜkqueue.h
>

12 
	~"Œ“-check”.h
"

14 
	gbŒfs_bio
;

15 
	gbŒfs_fs_šfo
;

17 
	#BTRFS_BIO_INLINE_CSUM_SIZE
 64

	)

24 
	#BTRFS_MAX_BIO_SECTORS
 (256)

	)

26 (*
	tbŒfs_bio_’d_io_t
)(
	tbŒfs_bio
 *
	tbbio
);

32 
	sbŒfs_bio
 {

37 
bŒfs_šode
 *
šode
;

38 
u64
 
fe_off£t
;

46 
u8
 *
csum
;

47 
u8
 
csum_šlše
[
BTRFS_BIO_INLINE_CSUM_SIZE
];

48 
bvec_™”
 
§ved_™”
;

59 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

60 
bŒfs_Üd”ed_sum
 *
sums
;

61 
u64
 
Üig_physiÿl
;

65 
bŒfs_Œ“_·»Á_check
 
·»Á_check
;

69 
bŒfs_bio_’d_io_t
 
’d_io
;

70 *
´iv©e
;

73 
mœrÜ_num
;

74 
©omic_t
 
³ndšg_ios
;

75 
wÜk_¡ruù
 
’d_io_wÜk
;

78 
bŒfs_fs_šfo
 *
fs_šfo
;

84 
bio
 bio;

87 
šlše
 
bŒfs_bio
 *
	$bŒfs_bio
(
bio
 *bio)

89  
	`cÚš”_of
(
bio
, 
bŒfs_bio
, bio);

90 
	}
}

92 
__š™
 
bŒfs_bio£t_š™
();

93 
__cŞd
 
bŒfs_bio£t_ex™
();

95 
bŒfs_bio_š™
(
bŒfs_bio
 *
bbio
, 
bŒfs_fs_šfo
 *
fs_šfo
,

96 
bŒfs_bio_’d_io_t
 
’d_io
, *
´iv©e
);

97 
bŒfs_bio
 *
bŒfs_bio_®loc
(
Ä_vecs
, 
blk_İf_t
 
İf
,

98 
bŒfs_fs_šfo
 *
fs_šfo
,

99 
bŒfs_bio_’d_io_t
 
’d_io
, *
´iv©e
);

100 
bŒfs_bio_’d_io
(
bŒfs_bio
 *
bbio
, 
blk_¡©us_t
 
¡©us
);

103 
	#REQ_BTRFS_CGROUP_PUNT
 
REQ_FS_PRIVATE


	)

105 
bŒfs_subm™_bio
(
bŒfs_bio
 *
bbio
, 
mœrÜ_num
);

106 
bŒfs_subm™_»·œ_wr™e
(
bŒfs_bio
 *
bbio
, 
mœrÜ_num
, 
boŞ
 
dev_»¶aû
);

107 
bŒfs_»·œ_io_çu»
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
šo
, u64 
¡¬t
,

108 
u64
 
Ëngth
, u64 
logiÿl
, 
·ge
 *page,

109 
pg_off£t
, 
mœrÜ_num
);

	@block-group.c

3 
	~<lšux/sizes.h
>

4 
	~<lšux/li¡_sÜt.h
>

5 
	~"misc.h
"

6 
	~"ù»e.h
"

7 
	~"block-group.h
"

8 
	~"¥aû-šfo.h
"

9 
	~"disk-io.h
"

10 
	~"ä“-¥aû-ÿche.h
"

11 
	~"ä“-¥aû-Œ“.h
"

12 
	~"vŞumes.h
"

13 
	~"Œª§ùiÚ.h
"

14 
	~"»f-v”ify.h
"

15 
	~"sysfs.h
"

16 
	~"Œ“-log.h
"

17 
	~"d–®loc-¥aû.h
"

18 
	~"disÿrd.h
"

19 
	~"¿id56.h
"

20 
	~"zÚed.h
"

21 
	~"fs.h
"

22 
	~"acûssÜs.h
"

23 
	~"ex‹Á-Œ“.h
"

25 #ifdeà
CONFIG_BTRFS_DEBUG


26 
	$bŒfs_should_äagm’t_ä“_¥aû
(
bŒfs_block_group
 *
block_group
)

28 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

30  (
	`bŒfs_‹¡_İt
(
fs_šfo
, 
FRAGMENT_METADATA
) &&

31 
block_group
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
) ||

32 (
	`bŒfs_‹¡_İt
(
fs_šfo
, 
FRAGMENT_DATA
) &&

33 
block_group
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
);

34 
	}
}

43 
u64
 
	$g‘_»¡re_rg‘
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æags
)

45 
bŒfs_b®ªû_cÚŒŞ
 *
bùl
 = 
fs_šfo
->
b®ªû_ùl
;

46 
u64
 
rg‘
 = 0;

48 ià(!
bùl
)

51 ià(
æags
 & 
BTRFS_BLOCK_GROUP_DATA
 &&

52 
bùl
->
d©a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) {

53 
rg‘
 = 
BTRFS_BLOCK_GROUP_DATA
 | 
bùl
->
d©a
.target;

54 } ià(
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
 &&

55 
bùl
->
sys
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) {

56 
rg‘
 = 
BTRFS_BLOCK_GROUP_SYSTEM
 | 
bùl
->
sys
.target;

57 } ià(
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
 &&

58 
bùl
->
m‘a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) {

59 
rg‘
 = 
BTRFS_BLOCK_GROUP_METADATA
 | 
bùl
->
m‘a
.target;

62  
rg‘
;

63 
	}
}

72 
u64
 
	$bŒfs_»duû_®loc_´ofe
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æags
)

74 
u64
 
num_deviûs
 = 
fs_šfo
->
fs_deviûs
->
rw_deviûs
;

75 
u64
 
rg‘
;

76 
u64
 
¿id_ty³
;

77 
u64
 
®lowed
 = 0;

83 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

84 
rg‘
 = 
	`g‘_»¡re_rg‘
(
fs_šfo
, 
æags
);

85 ià(
rg‘
) {

86 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

87  
	`ex‹nded_to_chunk
(
rg‘
);

89 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

92 
¿id_ty³
 = 0;„aid_ty³ < 
BTRFS_NR_RAID_TYPES
;„aid_type++) {

93 ià(
num_deviûs
 >ğ
bŒfs_¿id_¬¿y
[
¿id_ty³
].
devs_mš
)

94 
®lowed
 |ğ
bŒfs_¿id_¬¿y
[
¿id_ty³
].
bg_æag
;

96 
®lowed
 &ğ
æags
;

99 ià(
®lowed
 & 
BTRFS_BLOCK_GROUP_RAID1C4
)

100 
®lowed
 = 
BTRFS_BLOCK_GROUP_RAID1C4
;

101 ià(
®lowed
 & 
BTRFS_BLOCK_GROUP_RAID6
)

102 
®lowed
 = 
BTRFS_BLOCK_GROUP_RAID6
;

103 ià(
®lowed
 & 
BTRFS_BLOCK_GROUP_RAID1C3
)

104 
®lowed
 = 
BTRFS_BLOCK_GROUP_RAID1C3
;

105 ià(
®lowed
 & 
BTRFS_BLOCK_GROUP_RAID5
)

106 
®lowed
 = 
BTRFS_BLOCK_GROUP_RAID5
;

107 ià(
®lowed
 & 
BTRFS_BLOCK_GROUP_RAID10
)

108 
®lowed
 = 
BTRFS_BLOCK_GROUP_RAID10
;

109 ià(
®lowed
 & 
BTRFS_BLOCK_GROUP_RAID1
)

110 
®lowed
 = 
BTRFS_BLOCK_GROUP_RAID1
;

111 ià(
®lowed
 & 
BTRFS_BLOCK_GROUP_DUP
)

112 
®lowed
 = 
BTRFS_BLOCK_GROUP_DUP
;

113 ià(
®lowed
 & 
BTRFS_BLOCK_GROUP_RAID0
)

114 
®lowed
 = 
BTRFS_BLOCK_GROUP_RAID0
;

116 
æags
 &ğ~
BTRFS_BLOCK_GROUP_PROFILE_MASK
;

118  
	`ex‹nded_to_chunk
(
æags
 | 
®lowed
);

119 
	}
}

121 
u64
 
	$bŒfs_g‘_®loc_´ofe
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
Üig_æags
)

123 
£q
;

124 
u64
 
æags
;

127 
æags
 = 
Üig_æags
;

128 
£q
 = 
	`»ad_£qbegš
(&
fs_šfo
->
´ofes_lock
);

130 ià(
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

131 
æags
 |ğ
fs_šfo
->
ava_d©a_®loc_b™s
;

132 ià(
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

133 
æags
 |ğ
fs_šfo
->
ava_sy¡em_®loc_b™s
;

134 ià(
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
)

135 
æags
 |ğ
fs_šfo
->
ava_m‘ad©a_®loc_b™s
;

136 } 
	`»ad_£q»Œy
(&
fs_šfo
->
´ofes_lock
, 
£q
));

138  
	`bŒfs_»duû_®loc_´ofe
(
fs_šfo
, 
æags
);

139 
	}
}

141 
	$bŒfs_g‘_block_group
(
bŒfs_block_group
 *
ÿche
)

143 
	`»fcouÁ_šc
(&
ÿche
->
»fs
);

144 
	}
}

146 
	$bŒfs_put_block_group
(
bŒfs_block_group
 *
ÿche
)

148 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
ÿche
->
»fs
)) {

149 
	`WARN_ON
(
ÿche
->
pšÃd
 > 0);

157 ià(!(
ÿche
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
) ||

158 !
	`BTRFS_FS_LOG_CLEANUP_ERROR
(
ÿche
->
fs_šfo
))

159 
	`WARN_ON
(
ÿche
->
»£rved
 > 0);

166 ià(
	`WARN_ON
(!
	`li¡_em±y
(&
ÿche
->
disÿrd_li¡
)))

167 
	`bŒfs_disÿrd_ÿnûl_wÜk
(&
ÿche
->
fs_šfo
->
disÿrd_ùl
,

168 
ÿche
);

170 
	`kä“
(
ÿche
->
ä“_¥aû_ùl
);

171 
	`kä“
(
ÿche
->
physiÿl_m­
);

172 
	`kä“
(
ÿche
);

174 
	}
}

179 
	$bŒfs_add_block_group_ÿche
(
bŒfs_fs_šfo
 *
šfo
,

180 
bŒfs_block_group
 *
block_group
)

182 
rb_node
 **
p
;

183 
rb_node
 *
·»Á
 = 
NULL
;

184 
bŒfs_block_group
 *
ÿche
;

185 
boŞ
 
Ëámo¡
 = 
Œue
;

187 
	`ASSERT
(
block_group
->
Ëngth
 != 0);

189 
	`wr™e_lock
(&
šfo
->
block_group_ÿche_lock
);

190 
p
 = &
šfo
->
block_group_ÿche_Œ“
.
rb_roÙ
.
rb_node
;

192 *
p
) {

193 
·»Á
 = *
p
;

194 
ÿche
 = 
	`rb_’Œy
(
·»Á
, 
bŒfs_block_group
, 
ÿche_node
);

195 ià(
block_group
->
¡¬t
 < 
ÿche
->start) {

196 
p
 = &(*p)->
rb_Ëá
;

197 } ià(
block_group
->
¡¬t
 > 
ÿche
->start) {

198 
p
 = &(*p)->
rb_right
;

199 
Ëámo¡
 = 
çl£
;

201 
	`wr™e_uÆock
(&
šfo
->
block_group_ÿche_lock
);

202  -
EEXIST
;

206 
	`rb_lšk_node
(&
block_group
->
ÿche_node
, 
·»Á
, 
p
);

207 
	`rb_š£¹_cŞÜ_ÿched
(&
block_group
->
ÿche_node
,

208 &
šfo
->
block_group_ÿche_Œ“
, 
Ëámo¡
);

210 
	`wr™e_uÆock
(&
šfo
->
block_group_ÿche_lock
);

213 
	}
}

219 
bŒfs_block_group
 *
	$block_group_ÿche_Œ“_£¬ch
(

220 
bŒfs_fs_šfo
 *
šfo
, 
u64
 
by‹Ä
, 
cÚšs
)

222 
bŒfs_block_group
 *
ÿche
, *
»t
 = 
NULL
;

223 
rb_node
 *
n
;

224 
u64
 
’d
, 
¡¬t
;

226 
	`»ad_lock
(&
šfo
->
block_group_ÿche_lock
);

227 
n
 = 
šfo
->
block_group_ÿche_Œ“
.
rb_roÙ
.
rb_node
;

229 
n
) {

230 
ÿche
 = 
	`rb_’Œy
(
n
, 
bŒfs_block_group
, 
ÿche_node
);

231 
’d
 = 
ÿche
->
¡¬t
 + cache->
Ëngth
 - 1;

232 
¡¬t
 = 
ÿche
->start;

234 ià(
by‹Ä
 < 
¡¬t
) {

235 ià(!
cÚšs
 && (!
»t
 || 
¡¬t
 <„et->start))

236 
»t
 = 
ÿche
;

237 
n
 =‚->
rb_Ëá
;

238 } ià(
by‹Ä
 > 
¡¬t
) {

239 ià(
cÚšs
 && 
by‹Ä
 <ğ
’d
) {

240 
»t
 = 
ÿche
;

243 
n
 =‚->
rb_right
;

245 
»t
 = 
ÿche
;

249 ià(
»t
)

250 
	`bŒfs_g‘_block_group
(
»t
);

251 
	`»ad_uÆock
(&
šfo
->
block_group_ÿche_lock
);

253  
»t
;

254 
	}
}

259 
bŒfs_block_group
 *
	$bŒfs_lookup_fœ¡_block_group
(

260 
bŒfs_fs_šfo
 *
šfo
, 
u64
 
by‹Ä
)

262  
	`block_group_ÿche_Œ“_£¬ch
(
šfo
, 
by‹Ä
, 0);

263 
	}
}

268 
bŒfs_block_group
 *
	$bŒfs_lookup_block_group
(

269 
bŒfs_fs_šfo
 *
šfo
, 
u64
 
by‹Ä
)

271  
	`block_group_ÿche_Œ“_£¬ch
(
šfo
, 
by‹Ä
, 1);

272 
	}
}

274 
bŒfs_block_group
 *
	$bŒfs_Ãxt_block_group
(

275 
bŒfs_block_group
 *
ÿche
)

277 
bŒfs_fs_šfo
 *
fs_šfo
 = 
ÿche
->fs_info;

278 
rb_node
 *
node
;

280 
	`»ad_lock
(&
fs_šfo
->
block_group_ÿche_lock
);

283 ià(
	`RB_EMPTY_NODE
(&
ÿche
->
ÿche_node
)) {

284 cÚ¡ 
u64
 
Ãxt_by‹Ä
 = 
ÿche
->
¡¬t
 + cache->
Ëngth
;

286 
	`»ad_uÆock
(&
fs_šfo
->
block_group_ÿche_lock
);

287 
	`bŒfs_put_block_group
(
ÿche
);

288  
	`bŒfs_lookup_fœ¡_block_group
(
fs_šfo
, 
Ãxt_by‹Ä
);

290 
node
 = 
	`rb_Ãxt
(&
ÿche
->
ÿche_node
);

291 
	`bŒfs_put_block_group
(
ÿche
);

292 ià(
node
) {

293 
ÿche
 = 
	`rb_’Œy
(
node
, 
bŒfs_block_group
, 
ÿche_node
);

294 
	`bŒfs_g‘_block_group
(
ÿche
);

296 
ÿche
 = 
NULL
;

297 
	`»ad_uÆock
(&
fs_šfo
->
block_group_ÿche_lock
);

298  
ÿche
;

299 
	}
}

316 
bŒfs_block_group
 *
	$bŒfs_šc_nocow_wr™”s
(
bŒfs_fs_šfo
 *
fs_šfo
,

317 
u64
 
by‹Ä
)

319 
bŒfs_block_group
 *
bg
;

320 
boŞ
 
ÿn_nocow
 = 
Œue
;

322 
bg
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
by‹Ä
);

323 ià(!
bg
)

324  
NULL
;

326 
	`¥š_lock
(&
bg
->
lock
);

327 ià(
bg
->
ro
)

328 
ÿn_nocow
 = 
çl£
;

330 
	`©omic_šc
(&
bg
->
nocow_wr™”s
);

331 
	`¥š_uÆock
(&
bg
->
lock
);

333 ià(!
ÿn_nocow
) {

334 
	`bŒfs_put_block_group
(
bg
);

335  
NULL
;

339  
bg
;

340 
	}
}

353 
	$bŒfs_dec_nocow_wr™”s
(
bŒfs_block_group
 *
bg
)

355 ià(
	`©omic_dec_ªd_‹¡
(&
bg
->
nocow_wr™”s
))

356 
	`wake_up_v¬
(&
bg
->
nocow_wr™”s
);

359 
	`bŒfs_put_block_group
(
bg
);

360 
	}
}

362 
	$bŒfs_wa™_nocow_wr™”s
(
bŒfs_block_group
 *
bg
)

364 
	`wa™_v¬_ev’t
(&
bg
->
nocow_wr™”s
, !
	`©omic_»ad
(&bg->nocow_writers));

365 
	}
}

367 
	$bŒfs_dec_block_group_»£rv©iÚs
(
bŒfs_fs_šfo
 *
fs_šfo
,

368 cÚ¡ 
u64
 
¡¬t
)

370 
bŒfs_block_group
 *
bg
;

372 
bg
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
¡¬t
);

373 
	`ASSERT
(
bg
);

374 ià(
	`©omic_dec_ªd_‹¡
(&
bg
->
»£rv©iÚs
))

375 
	`wake_up_v¬
(&
bg
->
»£rv©iÚs
);

376 
	`bŒfs_put_block_group
(
bg
);

377 
	}
}

379 
	$bŒfs_wa™_block_group_»£rv©iÚs
(
bŒfs_block_group
 *
bg
)

381 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
bg
->space_info;

383 
	`ASSERT
(
bg
->
ro
);

385 ià(!(
bg
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
))

398 
	`down_wr™e
(&
¥aû_šfo
->
groups_£m
);

399 
	`up_wr™e
(&
¥aû_šfo
->
groups_£m
);

401 
	`wa™_v¬_ev’t
(&
bg
->
»£rv©iÚs
, !
	`©omic_»ad
(&bg->reservations));

402 
	}
}

404 
bŒfs_ÿchšg_cÚŒŞ
 *
	$bŒfs_g‘_ÿchšg_cÚŒŞ
(

405 
bŒfs_block_group
 *
ÿche
)

407 
bŒfs_ÿchšg_cÚŒŞ
 *
ùl
;

409 
	`¥š_lock
(&
ÿche
->
lock
);

410 ià(!
ÿche
->
ÿchšg_ùl
) {

411 
	`¥š_uÆock
(&
ÿche
->
lock
);

412  
NULL
;

415 
ùl
 = 
ÿche
->
ÿchšg_ùl
;

416 
	`»fcouÁ_šc
(&
ùl
->
couÁ
);

417 
	`¥š_uÆock
(&
ÿche
->
lock
);

418  
ùl
;

419 
	}
}

421 
	$bŒfs_put_ÿchšg_cÚŒŞ
(
bŒfs_ÿchšg_cÚŒŞ
 *
ùl
)

423 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
ùl
->
couÁ
))

424 
	`kä“
(
ùl
);

425 
	}
}

440 
	$bŒfs_wa™_block_group_ÿche_´og»ss
(
bŒfs_block_group
 *
ÿche
,

441 
u64
 
num_by‹s
)

443 
bŒfs_ÿchšg_cÚŒŞ
 *
ÿchšg_ùl
;

444 
´og»ss
;

446 
ÿchšg_ùl
 = 
	`bŒfs_g‘_ÿchšg_cÚŒŞ
(
ÿche
);

447 ià(!
ÿchšg_ùl
)

456 
´og»ss
 = 
	`©omic_»ad
(&
ÿchšg_ùl
->progress);

458 
	`wa™_ev’t
(
ÿchšg_ùl
->
wa™
, 
	`bŒfs_block_group_dÚe
(
ÿche
) ||

459 (
´og»ss
 !ğ
	`©omic_»ad
(&
ÿchšg_ùl
->progress) &&

460 (
ÿche
->
ä“_¥aû_ùl
->
ä“_¥aû
 >ğ
num_by‹s
)));

462 
	`bŒfs_put_ÿchšg_cÚŒŞ
(
ÿchšg_ùl
);

463 
	}
}

465 
	$bŒfs_ÿchšg_ùl_wa™_dÚe
(
bŒfs_block_group
 *
ÿche
,

466 
bŒfs_ÿchšg_cÚŒŞ
 *
ÿchšg_ùl
)

468 
	`wa™_ev’t
(
ÿchšg_ùl
->
wa™
, 
	`bŒfs_block_group_dÚe
(
ÿche
));

469  
ÿche
->
ÿched
 =ğ
BTRFS_CACHE_ERROR
 ? -
EIO
 : 0;

470 
	}
}

472 
	$bŒfs_wa™_block_group_ÿche_dÚe
(
bŒfs_block_group
 *
ÿche
)

474 
bŒfs_ÿchšg_cÚŒŞ
 *
ÿchšg_ùl
;

475 
»t
;

477 
ÿchšg_ùl
 = 
	`bŒfs_g‘_ÿchšg_cÚŒŞ
(
ÿche
);

478 ià(!
ÿchšg_ùl
)

479  (
ÿche
->
ÿched
 =ğ
BTRFS_CACHE_ERROR
è? -
EIO
 : 0;

480 
»t
 = 
	`bŒfs_ÿchšg_ùl_wa™_dÚe
(
ÿche
, 
ÿchšg_ùl
);

481 
	`bŒfs_put_ÿchšg_cÚŒŞ
(
ÿchšg_ùl
);

482  
»t
;

483 
	}
}

485 #ifdeà
CONFIG_BTRFS_DEBUG


486 
	$äagm’t_ä“_¥aû
(
bŒfs_block_group
 *
block_group
)

488 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

489 
u64
 
¡¬t
 = 
block_group
->start;

490 
u64
 
Ën
 = 
block_group
->
Ëngth
;

491 
u64
 
chunk
 = 
block_group
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
 ?

492 
fs_šfo
->
nodesize
 : fs_šfo->
£ùÜsize
;

493 
u64
 
¡•
 = 
chunk
 << 1;

495 
Ën
 > 
chunk
) {

496 
	`bŒfs_»move_ä“_¥aû
(
block_group
, 
¡¬t
, 
chunk
);

497 
¡¬t
 +ğ
¡•
;

498 ià(
Ën
 < 
¡•
)

499 
Ën
 = 0;

501 
Ën
 -ğ
¡•
;

503 
	}
}

519 
	$bŒfs_add_Ãw_ä“_¥aû
(
bŒfs_block_group
 *
block_group
, 
u64
 
¡¬t
,

520 
u64
 
’d
, u64 *
tÙ®_added_»t
)

522 
bŒfs_fs_šfo
 *
šfo
 = 
block_group
->
fs_šfo
;

523 
u64
 
ex‹Á_¡¬t
, 
ex‹Á_’d
, 
size
;

524 
»t
;

526 ià(
tÙ®_added_»t
)

527 *
tÙ®_added_»t
 = 0;

529 
¡¬t
 < 
’d
) {

530 ià(!
	`fšd_fœ¡_ex‹Á_b™
(&
šfo
->
exşuded_ex‹Ás
, 
¡¬t
,

531 &
ex‹Á_¡¬t
, &
ex‹Á_’d
,

532 
EXTENT_DIRTY
 | 
EXTENT_UPTODATE
,

533 
NULL
))

536 ià(
ex‹Á_¡¬t
 <ğ
¡¬t
) {

537 
¡¬t
 = 
ex‹Á_’d
 + 1;

538 } ià(
ex‹Á_¡¬t
 > 
¡¬t
 &&ƒx‹Á_¡¬ˆ< 
’d
) {

539 
size
 = 
ex‹Á_¡¬t
 - 
¡¬t
;

540 
»t
 = 
	`bŒfs_add_ä“_¥aû_async_Œimmed
(
block_group
,

541 
¡¬t
, 
size
);

542 ià(
»t
)

543  
»t
;

544 ià(
tÙ®_added_»t
)

545 *
tÙ®_added_»t
 +ğ
size
;

546 
¡¬t
 = 
ex‹Á_’d
 + 1;

552 ià(
¡¬t
 < 
’d
) {

553 
size
 = 
’d
 - 
¡¬t
;

554 
»t
 = 
	`bŒfs_add_ä“_¥aû_async_Œimmed
(
block_group
, 
¡¬t
,

555 
size
);

556 ià(
»t
)

557  
»t
;

558 ià(
tÙ®_added_»t
)

559 *
tÙ®_added_»t
 +ğ
size
;

563 
	}
}

580 
	$§m¶e_block_group_ex‹Á_™em
(
bŒfs_ÿchšg_cÚŒŞ
 *
ÿchšg_ùl
,

581 
bŒfs_block_group
 *
block_group
,

582 
šdex
, 
max_šdex
,

583 
bŒfs_key
 *
found_key
)

585 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

586 
bŒfs_roÙ
 *
ex‹Á_roÙ
;

587 
u64
 
£¬ch_off£t
;

588 
u64
 
£¬ch_’d
 = 
block_group
->
¡¬t
 + block_group->
Ëngth
;

589 
bŒfs_·th
 *
·th
;

590 
bŒfs_key
 
£¬ch_key
;

591 
»t
 = 0;

593 
	`ASSERT
(
šdex
 >= 0);

594 
	`ASSERT
(
šdex
 <ğ
max_šdex
);

595 
	`ASSERT
(
max_šdex
 > 0);

596 
	`lockd•_as£¹_h–d
(&
ÿchšg_ùl
->
mu‹x
);

597 
	`lockd•_as£¹_h–d_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

599 
·th
 = 
	`bŒfs_®loc_·th
();

600 ià(!
·th
)

601  -
ENOMEM
;

603 
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 
	`max_t
(
u64
, 
block_group
->
¡¬t
,

604 
BTRFS_SUPER_INFO_OFFSET
));

606 
·th
->
sk_lockšg
 = 1;

607 
·th
->
£¬ch_comm™_roÙ
 = 1;

608 
·th
->
»ada
 = 
READA_FORWARD
;

610 
£¬ch_off£t
 = 
šdex
 * 
	`div_u64
(
block_group
->
Ëngth
, 
max_šdex
);

611 
£¬ch_key
.
objeùid
 = 
block_group
->
¡¬t
 + 
£¬ch_off£t
;

612 
£¬ch_key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

613 
£¬ch_key
.
off£t
 = 0;

615 
	`bŒfs_fÜ_—ch_¦Ù
(
ex‹Á_roÙ
, &
£¬ch_key
, 
found_key
, 
·th
, 
»t
) {

617 ià(
found_key
->
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 &&

618 
found_key
->
objeùid
 >ğ
block_group
->
¡¬t
 &&

619 
found_key
->
objeùid
 + found_key->
off£t
 <ğ
£¬ch_’d
)

623 ià(
found_key
->
objeùid
 >ğ
£¬ch_’d
) {

624 
»t
 = 1;

629 
	`lockd•_as£¹_h–d
(&
ÿchšg_ùl
->
mu‹x
);

630 
	`lockd•_as£¹_h–d_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

631 
	`bŒfs_ä“_·th
(
·th
);

632  
»t
;

633 
	}
}

669 
	$lßd_block_group_size_şass
(
bŒfs_ÿchšg_cÚŒŞ
 *
ÿchšg_ùl
,

670 
bŒfs_block_group
 *
block_group
)

672 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

673 
bŒfs_key
 
key
;

674 
i
;

675 
u64
 
mš_size
 = 
block_group
->
Ëngth
;

676 
bŒfs_block_group_size_şass
 
size_şass
 = 
BTRFS_BG_SZ_NONE
;

677 
»t
;

679 ià(!
	`bŒfs_block_group_should_u£_size_şass
(
block_group
))

682 
	`lockd•_as£¹_h–d
(&
ÿchšg_ùl
->
mu‹x
);

683 
	`lockd•_as£¹_h–d_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

684 
i
 = 0; i < 5; ++i) {

685 
»t
 = 
	`§m¶e_block_group_ex‹Á_™em
(
ÿchšg_ùl
, 
block_group
, 
i
, 5, &
key
);

686 ià(
»t
 < 0)

687 
out
;

688 ià(
»t
 > 0)

690 
mš_size
 = 
	`mš_t
(
u64
, mš_size, 
key
.
off£t
);

691 
size_şass
 = 
	`bŒfs_ÿlc_block_group_size_şass
(
mš_size
);

693 ià(
size_şass
 !ğ
BTRFS_BG_SZ_NONE
) {

694 
	`¥š_lock
(&
block_group
->
lock
);

695 
block_group
->
size_şass
 = size_class;

696 
	`¥š_uÆock
(&
block_group
->
lock
);

698 
out
:

699  
»t
;

700 
	}
}

702 
	$lßd_ex‹Á_Œ“_ä“
(
bŒfs_ÿchšg_cÚŒŞ
 *
ÿchšg_ùl
)

704 
bŒfs_block_group
 *
block_group
 = 
ÿchšg_ùl
->block_group;

705 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

706 
bŒfs_roÙ
 *
ex‹Á_roÙ
;

707 
bŒfs_·th
 *
·th
;

708 
ex‹Á_bufãr
 *
Ëaf
;

709 
bŒfs_key
 
key
;

710 
u64
 
tÙ®_found
 = 0;

711 
u64
 
Ï¡
 = 0;

712 
u32
 
Ä™ems
;

713 
»t
;

714 
boŞ
 
wakeup
 = 
Œue
;

716 
·th
 = 
	`bŒfs_®loc_·th
();

717 ià(!
·th
)

718  -
ENOMEM
;

720 
Ï¡
 = 
	`max_t
(
u64
, 
block_group
->
¡¬t
, 
BTRFS_SUPER_INFO_OFFSET
);

721 
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 
Ï¡
);

723 #ifdeà
CONFIG_BTRFS_DEBUG


729 ià(
	`bŒfs_should_äagm’t_ä“_¥aû
(
block_group
))

730 
wakeup
 = 
çl£
;

738 
·th
->
sk_lockšg
 = 1;

739 
·th
->
£¬ch_comm™_roÙ
 = 1;

740 
·th
->
»ada
 = 
READA_FORWARD
;

742 
key
.
objeùid
 = 
Ï¡
;

743 
key
.
off£t
 = 0;

744 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

746 
Ãxt
:

747 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
ex‹Á_roÙ
, &
key
, 
·th
, 0, 0);

748 ià(
»t
 < 0)

749 
out
;

751 
Ëaf
 = 
·th
->
nodes
[0];

752 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

755 ià(
	`bŒfs_fs_şosšg
(
fs_šfo
) > 1) {

756 
Ï¡
 = (
u64
)-1;

760 ià(
·th
->
¦Ùs
[0] < 
Ä™ems
) {

761 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

763 
»t
 = 
	`bŒfs_fšd_Ãxt_key
(
ex‹Á_roÙ
, 
·th
, &
key
, 0, 0);

764 ià(
»t
)

767 ià(
	`Ãed_»sched
() ||

768 
	`rw£m_is_cÚ‹nded
(&
fs_šfo
->
comm™_roÙ_£m
)) {

769 
	`bŒfs_»Ëa£_·th
(
·th
);

770 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

771 
	`mu‹x_uÆock
(&
ÿchšg_ùl
->
mu‹x
);

772 
	`cÚd_»sched
();

773 
	`mu‹x_lock
(&
ÿchšg_ùl
->
mu‹x
);

774 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

775 
Ãxt
;

778 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
ex‹Á_roÙ
, 
·th
);

779 ià(
»t
 < 0)

780 
out
;

781 ià(
»t
)

783 
Ëaf
 = 
·th
->
nodes
[0];

784 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

788 ià(
key
.
objeùid
 < 
Ï¡
) {

789 
key
.
objeùid
 = 
Ï¡
;

790 
key
.
off£t
 = 0;

791 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

792 
	`bŒfs_»Ëa£_·th
(
·th
);

793 
Ãxt
;

796 ià(
key
.
objeùid
 < 
block_group
->
¡¬t
) {

797 
·th
->
¦Ùs
[0]++;

801 ià(
key
.
objeùid
 >ğ
block_group
->
¡¬t
 + block_group->
Ëngth
)

804 ià(
key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 ||

805 
key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
) {

806 
u64
 
¥aû_added
;

808 
»t
 = 
	`bŒfs_add_Ãw_ä“_¥aû
(
block_group
, 
Ï¡
,

809 
key
.
objeùid
, &
¥aû_added
);

810 ià(
»t
)

811 
out
;

812 
tÙ®_found
 +ğ
¥aû_added
;

813 ià(
key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
)

814 
Ï¡
 = 
key
.
objeùid
 +

815 
fs_šfo
->
nodesize
;

817 
Ï¡
 = 
key
.
objeùid
 + key.
off£t
;

819 ià(
tÙ®_found
 > 
CACHING_CTL_WAKE_UP
) {

820 
tÙ®_found
 = 0;

821 ià(
wakeup
) {

822 
	`©omic_šc
(&
ÿchšg_ùl
->
´og»ss
);

823 
	`wake_up
(&
ÿchšg_ùl
->
wa™
);

827 
·th
->
¦Ùs
[0]++;

830 
»t
 = 
	`bŒfs_add_Ãw_ä“_¥aû
(
block_group
, 
Ï¡
,

831 
block_group
->
¡¬t
 + block_group->
Ëngth
,

832 
NULL
);

833 
out
:

834 
	`bŒfs_ä“_·th
(
·th
);

835  
»t
;

836 
	}
}

838 
šlše
 
	$bŒfs_ä“_exşuded_ex‹Ás
(cÚ¡ 
bŒfs_block_group
 *
bg
)

840 
	`ş—r_ex‹Á_b™s
(&
bg
->
fs_šfo
->
exşuded_ex‹Ás
, bg->
¡¬t
,

841 
bg
->
¡¬t
 + bg->
Ëngth
 - 1, 
EXTENT_UPTODATE
);

842 
	}
}

844 
nošlše
 
	$ÿchšg_th»ad
(
bŒfs_wÜk
 *
wÜk
)

846 
bŒfs_block_group
 *
block_group
;

847 
bŒfs_fs_šfo
 *
fs_šfo
;

848 
bŒfs_ÿchšg_cÚŒŞ
 *
ÿchšg_ùl
;

849 
»t
;

851 
ÿchšg_ùl
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_ÿchšg_cÚŒŞ
, work);

852 
block_group
 = 
ÿchšg_ùl
->block_group;

853 
fs_šfo
 = 
block_group
->fs_info;

855 
	`mu‹x_lock
(&
ÿchšg_ùl
->
mu‹x
);

856 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

858 
	`lßd_block_group_size_şass
(
ÿchšg_ùl
, 
block_group
);

859 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
SPACE_CACHE
)) {

860 
»t
 = 
	`lßd_ä“_¥aû_ÿche
(
block_group
);

861 ià(
»t
 == 1) {

862 
»t
 = 0;

863 
dÚe
;

870 
	`¥š_lock
(&
block_group
->
lock
);

871 
block_group
->
ÿched
 = 
BTRFS_CACHE_STARTED
;

872 
	`¥š_uÆock
(&
block_group
->
lock
);

873 
	`wake_up
(&
ÿchšg_ùl
->
wa™
);

883 ià(
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
) &&

884 !(
	`‹¡_b™
(
BTRFS_FS_FREE_SPACE_TREE_UNTRUSTED
, &
fs_šfo
->
æags
)))

885 
»t
 = 
	`lßd_ä“_¥aû_Œ“
(
ÿchšg_ùl
);

887 
»t
 = 
	`lßd_ex‹Á_Œ“_ä“
(
ÿchšg_ùl
);

888 
dÚe
:

889 
	`¥š_lock
(&
block_group
->
lock
);

890 
block_group
->
ÿchšg_ùl
 = 
NULL
;

891 
block_group
->
ÿched
 = 
»t
 ? 
BTRFS_CACHE_ERROR
 : 
BTRFS_CACHE_FINISHED
;

892 
	`¥š_uÆock
(&
block_group
->
lock
);

894 #ifdeà
CONFIG_BTRFS_DEBUG


895 ià(
	`bŒfs_should_äagm’t_ä“_¥aû
(
block_group
)) {

896 
u64
 
by‹s_u£d
;

898 
	`¥š_lock
(&
block_group
->
¥aû_šfo
->
lock
);

899 
	`¥š_lock
(&
block_group
->
lock
);

900 
by‹s_u£d
 = 
block_group
->
Ëngth
 - block_group->
u£d
;

901 
block_group
->
¥aû_šfo
->
by‹s_u£d
 += bytes_used >> 1;

902 
	`¥š_uÆock
(&
block_group
->
lock
);

903 
	`¥š_uÆock
(&
block_group
->
¥aû_šfo
->
lock
);

904 
	`äagm’t_ä“_¥aû
(
block_group
);

908 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

909 
	`bŒfs_ä“_exşuded_ex‹Ás
(
block_group
);

910 
	`mu‹x_uÆock
(&
ÿchšg_ùl
->
mu‹x
);

912 
	`wake_up
(&
ÿchšg_ùl
->
wa™
);

914 
	`bŒfs_put_ÿchšg_cÚŒŞ
(
ÿchšg_ùl
);

915 
	`bŒfs_put_block_group
(
block_group
);

916 
	}
}

918 
	$bŒfs_ÿche_block_group
(
bŒfs_block_group
 *
ÿche
, 
boŞ
 
wa™
)

920 
bŒfs_fs_šfo
 *
fs_šfo
 = 
ÿche
->fs_info;

921 
bŒfs_ÿchšg_cÚŒŞ
 *
ÿchšg_ùl
 = 
NULL
;

922 
»t
 = 0;

925 ià(
	`bŒfs_is_zÚed
(
fs_šfo
))

928 
ÿchšg_ùl
 = 
	`kz®loc
((*ÿchšg_ùl), 
GFP_NOFS
);

929 ià(!
ÿchšg_ùl
)

930  -
ENOMEM
;

932 
	`INIT_LIST_HEAD
(&
ÿchšg_ùl
->
li¡
);

933 
	`mu‹x_š™
(&
ÿchšg_ùl
->
mu‹x
);

934 
	`š™_wa™queue_h—d
(&
ÿchšg_ùl
->
wa™
);

935 
ÿchšg_ùl
->
block_group
 = 
ÿche
;

936 
	`»fcouÁ_£t
(&
ÿchšg_ùl
->
couÁ
, 2);

937 
	`©omic_£t
(&
ÿchšg_ùl
->
´og»ss
, 0);

938 
	`bŒfs_š™_wÜk
(&
ÿchšg_ùl
->
wÜk
, 
ÿchšg_th»ad
, 
NULL
, NULL);

940 
	`¥š_lock
(&
ÿche
->
lock
);

941 ià(
ÿche
->
ÿched
 !ğ
BTRFS_CACHE_NO
) {

942 
	`kä“
(
ÿchšg_ùl
);

944 
ÿchšg_ùl
 = 
ÿche
->caching_ctl;

945 ià(
ÿchšg_ùl
)

946 
	`»fcouÁ_šc
(&
ÿchšg_ùl
->
couÁ
);

947 
	`¥š_uÆock
(&
ÿche
->
lock
);

948 
out
;

950 
	`WARN_ON
(
ÿche
->
ÿchšg_ùl
);

951 
ÿche
->
ÿchšg_ùl
 = caching_ctl;

952 
ÿche
->
ÿched
 = 
BTRFS_CACHE_STARTED
;

953 
	`¥š_uÆock
(&
ÿche
->
lock
);

955 
	`wr™e_lock
(&
fs_šfo
->
block_group_ÿche_lock
);

956 
	`»fcouÁ_šc
(&
ÿchšg_ùl
->
couÁ
);

957 
	`li¡_add_
(&
ÿchšg_ùl
->
li¡
, &
fs_šfo
->
ÿchšg_block_groups
);

958 
	`wr™e_uÆock
(&
fs_šfo
->
block_group_ÿche_lock
);

960 
	`bŒfs_g‘_block_group
(
ÿche
);

962 
	`bŒfs_queue_wÜk
(
fs_šfo
->
ÿchšg_wÜk”s
, &
ÿchšg_ùl
->
wÜk
);

963 
out
:

964 ià(
wa™
 && 
ÿchšg_ùl
)

965 
»t
 = 
	`bŒfs_ÿchšg_ùl_wa™_dÚe
(
ÿche
, 
ÿchšg_ùl
);

966 ià(
ÿchšg_ùl
)

967 
	`bŒfs_put_ÿchšg_cÚŒŞ
(
ÿchšg_ùl
);

969  
»t
;

970 
	}
}

972 
	$ş—r_ava_®loc_b™s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æags
)

974 
u64
 
exŒa_æags
 = 
	`chunk_to_ex‹nded
(
æags
) &

975 
BTRFS_EXTENDED_PROFILE_MASK
;

977 
	`wr™e_£qlock
(&
fs_šfo
->
´ofes_lock
);

978 ià(
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

979 
fs_šfo
->
ava_d©a_®loc_b™s
 &ğ~
exŒa_æags
;

980 ià(
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
)

981 
fs_šfo
->
ava_m‘ad©a_®loc_b™s
 &ğ~
exŒa_æags
;

982 ià(
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

983 
fs_šfo
->
ava_sy¡em_®loc_b™s
 &ğ~
exŒa_æags
;

984 
	`wr™e_£quÆock
(&
fs_šfo
->
´ofes_lock
);

985 
	}
}

995 
	$ş—r_šcom·t_bg_b™s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æags
)

997 
boŞ
 
found_¿id56
 = 
çl£
;

998 
boŞ
 
found_¿id1c34
 = 
çl£
;

1000 ià((
æags
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) ||

1001 (
æags
 & 
BTRFS_BLOCK_GROUP_RAID1C3
) ||

1002 (
æags
 & 
BTRFS_BLOCK_GROUP_RAID1C4
)) {

1003 
li¡_h—d
 *
h—d
 = &
fs_šfo
->
¥aû_šfo
;

1004 
bŒfs_¥aû_šfo
 *
sšfo
;

1006 
	`li¡_fÜ_—ch_’Œy_rcu
(
sšfo
, 
h—d
, 
li¡
) {

1007 
	`down_»ad
(&
sšfo
->
groups_£m
);

1008 ià(!
	`li¡_em±y
(&
sšfo
->
block_groups
[
BTRFS_RAID_RAID5
]))

1009 
found_¿id56
 = 
Œue
;

1010 ià(!
	`li¡_em±y
(&
sšfo
->
block_groups
[
BTRFS_RAID_RAID6
]))

1011 
found_¿id56
 = 
Œue
;

1012 ià(!
	`li¡_em±y
(&
sšfo
->
block_groups
[
BTRFS_RAID_RAID1C3
]))

1013 
found_¿id1c34
 = 
Œue
;

1014 ià(!
	`li¡_em±y
(&
sšfo
->
block_groups
[
BTRFS_RAID_RAID1C4
]))

1015 
found_¿id1c34
 = 
Œue
;

1016 
	`up_»ad
(&
sšfo
->
groups_£m
);

1018 ià(!
found_¿id56
)

1019 
	`bŒfs_ş—r_fs_šcom·t
(
fs_šfo
, 
RAID56
);

1020 ià(!
found_¿id1c34
)

1021 
	`bŒfs_ş—r_fs_šcom·t
(
fs_šfo
, 
RAID1C34
);

1023 
	}
}

1025 
	$»move_block_group_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1026 
bŒfs_·th
 *
·th
,

1027 
bŒfs_block_group
 *
block_group
)

1029 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1030 
bŒfs_roÙ
 *
roÙ
;

1031 
bŒfs_key
 
key
;

1032 
»t
;

1034 
roÙ
 = 
	`bŒfs_block_group_roÙ
(
fs_šfo
);

1035 
key
.
objeùid
 = 
block_group
->
¡¬t
;

1036 
key
.
ty³
 = 
BTRFS_BLOCK_GROUP_ITEM_KEY
;

1037 
key
.
off£t
 = 
block_group
->
Ëngth
;

1039 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1040 ià(
»t
 > 0)

1041 
»t
 = -
ENOENT
;

1042 ià(
»t
 < 0)

1043  
»t
;

1045 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

1046  
»t
;

1047 
	}
}

1049 
	$bŒfs_»move_block_group
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1050 
u64
 
group_¡¬t
, 
ex‹Á_m­
 *
em
)

1052 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1053 
bŒfs_·th
 *
·th
;

1054 
bŒfs_block_group
 *
block_group
;

1055 
bŒfs_ä“_şu¡”
 *
şu¡”
;

1056 
šode
 *inode;

1057 
kobjeù
 *
kobj
 = 
NULL
;

1058 
»t
;

1059 
šdex
;

1060 
çùÜ
;

1061 
bŒfs_ÿchšg_cÚŒŞ
 *
ÿchšg_ùl
 = 
NULL
;

1062 
boŞ
 
»move_em
;

1063 
boŞ
 
»move_rsv
 = 
çl£
;

1065 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
group_¡¬t
);

1066 
	`BUG_ON
(!
block_group
);

1067 
	`BUG_ON
(!
block_group
->
ro
);

1069 
	`Œaû_bŒfs_»move_block_group
(
block_group
);

1074 
	`bŒfs_ä“_exşuded_ex‹Ás
(
block_group
);

1075 
	`bŒfs_ä“_»f_Œ“_¿nge
(
fs_šfo
, 
block_group
->
¡¬t
,

1076 
block_group
->
Ëngth
);

1078 
šdex
 = 
	`bŒfs_bg_æags_to_¿id_šdex
(
block_group
->
æags
);

1079 
çùÜ
 = 
	`bŒfs_bg_ty³_to_çùÜ
(
block_group
->
æags
);

1082 
şu¡”
 = &
fs_šfo
->
d©a_®loc_şu¡”
;

1083 
	`¥š_lock
(&
şu¡”
->
»fl_lock
);

1084 
	`bŒfs_»tuº_şu¡”_to_ä“_¥aû
(
block_group
, 
şu¡”
);

1085 
	`¥š_uÆock
(&
şu¡”
->
»fl_lock
);

1091 
şu¡”
 = &
fs_šfo
->
m‘a_®loc_şu¡”
;

1092 
	`¥š_lock
(&
şu¡”
->
»fl_lock
);

1093 
	`bŒfs_»tuº_şu¡”_to_ä“_¥aû
(
block_group
, 
şu¡”
);

1094 
	`¥š_uÆock
(&
şu¡”
->
»fl_lock
);

1096 
	`bŒfs_ş—r_Œ“log_bg
(
block_group
);

1097 
	`bŒfs_ş—r_d©a_»loc_bg
(
block_group
);

1099 
·th
 = 
	`bŒfs_®loc_·th
();

1100 ià(!
·th
) {

1101 
»t
 = -
ENOMEM
;

1102 
out
;

1109 
šode
 = 
	`lookup_ä“_¥aû_šode
(
block_group
, 
·th
);

1111 
	`mu‹x_lock
(&
Œªs
->
Œª§ùiÚ
->
ÿche_wr™e_mu‹x
);

1116 
	`¥š_lock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

1117 ià(!
	`li¡_em±y
(&
block_group
->
io_li¡
)) {

1118 
	`li¡_d–_š™
(&
block_group
->
io_li¡
);

1120 
	`WARN_ON
(!
	`IS_ERR
(
šode
è&& inod!ğ
block_group
->
io_ùl
.inode);

1122 
	`¥š_uÆock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

1123 
	`bŒfs_wa™_ÿche_io
(
Œªs
, 
block_group
, 
·th
);

1124 
	`bŒfs_put_block_group
(
block_group
);

1125 
	`¥š_lock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

1128 ià(!
	`li¡_em±y
(&
block_group
->
dœty_li¡
)) {

1129 
	`li¡_d–_š™
(&
block_group
->
dœty_li¡
);

1130 
»move_rsv
 = 
Œue
;

1131 
	`bŒfs_put_block_group
(
block_group
);

1133 
	`¥š_uÆock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

1134 
	`mu‹x_uÆock
(&
Œªs
->
Œª§ùiÚ
->
ÿche_wr™e_mu‹x
);

1136 
»t
 = 
	`bŒfs_»move_ä“_¥aû_šode
(
Œªs
, 
šode
, 
block_group
);

1137 ià(
»t
)

1138 
out
;

1140 
	`wr™e_lock
(&
fs_šfo
->
block_group_ÿche_lock
);

1141 
	`rb_”a£_ÿched
(&
block_group
->
ÿche_node
,

1142 &
fs_šfo
->
block_group_ÿche_Œ“
);

1143 
	`RB_CLEAR_NODE
(&
block_group
->
ÿche_node
);

1146 
	`bŒfs_put_block_group
(
block_group
);

1148 
	`wr™e_uÆock
(&
fs_šfo
->
block_group_ÿche_lock
);

1150 
	`down_wr™e
(&
block_group
->
¥aû_šfo
->
groups_£m
);

1155 
	`li¡_d–_š™
(&
block_group
->
li¡
);

1156 ià(
	`li¡_em±y
(&
block_group
->
¥aû_šfo
->
block_groups
[
šdex
])) {

1157 
kobj
 = 
block_group
->
¥aû_šfo
->
block_group_kobjs
[
šdex
];

1158 
block_group
->
¥aû_šfo
->
block_group_kobjs
[
šdex
] = 
NULL
;

1159 
	`ş—r_ava_®loc_b™s
(
fs_šfo
, 
block_group
->
æags
);

1161 
	`up_wr™e
(&
block_group
->
¥aû_šfo
->
groups_£m
);

1162 
	`ş—r_šcom·t_bg_b™s
(
fs_šfo
, 
block_group
->
æags
);

1163 ià(
kobj
) {

1164 
	`kobjeù_d–
(
kobj
);

1165 
	`kobjeù_put
(
kobj
);

1168 ià(
block_group
->
ÿched
 =ğ
BTRFS_CACHE_STARTED
)

1169 
	`bŒfs_wa™_block_group_ÿche_dÚe
(
block_group
);

1171 
	`wr™e_lock
(&
fs_šfo
->
block_group_ÿche_lock
);

1172 
ÿchšg_ùl
 = 
	`bŒfs_g‘_ÿchšg_cÚŒŞ
(
block_group
);

1173 ià(!
ÿchšg_ùl
) {

1174 
bŒfs_ÿchšg_cÚŒŞ
 *
ùl
;

1176 
	`li¡_fÜ_—ch_’Œy
(
ùl
, &
fs_šfo
->
ÿchšg_block_groups
, 
li¡
) {

1177 ià(
ùl
->
block_group
 == block_group) {

1178 
ÿchšg_ùl
 = 
ùl
;

1179 
	`»fcouÁ_šc
(&
ÿchšg_ùl
->
couÁ
);

1184 ià(
ÿchšg_ùl
)

1185 
	`li¡_d–_š™
(&
ÿchšg_ùl
->
li¡
);

1186 
	`wr™e_uÆock
(&
fs_šfo
->
block_group_ÿche_lock
);

1188 ià(
ÿchšg_ùl
) {

1190 
	`bŒfs_put_ÿchšg_cÚŒŞ
(
ÿchšg_ùl
);

1191 
	`bŒfs_put_ÿchšg_cÚŒŞ
(
ÿchšg_ùl
);

1194 
	`¥š_lock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

1195 
	`WARN_ON
(!
	`li¡_em±y
(&
block_group
->
dœty_li¡
));

1196 
	`WARN_ON
(!
	`li¡_em±y
(&
block_group
->
io_li¡
));

1197 
	`¥š_uÆock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

1199 
	`bŒfs_»move_ä“_¥aû_ÿche
(
block_group
);

1201 
	`¥š_lock
(&
block_group
->
¥aû_šfo
->
lock
);

1202 
	`li¡_d–_š™
(&
block_group
->
ro_li¡
);

1204 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
ENOSPC_DEBUG
)) {

1205 
	`WARN_ON
(
block_group
->
¥aû_šfo
->
tÙ®_by‹s


1206 < 
block_group
->
Ëngth
);

1207 
	`WARN_ON
(
block_group
->
¥aû_šfo
->
by‹s_»adÚly


1208 < 
block_group
->
Ëngth
 - block_group->
zÚe_unu§bË
);

1209 
	`WARN_ON
(
block_group
->
¥aû_šfo
->
by‹s_zÚe_unu§bË


1210 < 
block_group
->
zÚe_unu§bË
);

1211 
	`WARN_ON
(
block_group
->
¥aû_šfo
->
disk_tÙ®


1212 < 
block_group
->
Ëngth
 * 
çùÜ
);

1214 
block_group
->
¥aû_šfo
->
tÙ®_by‹s
 -ğblock_group->
Ëngth
;

1215 
block_group
->
¥aû_šfo
->
by‹s_»adÚly
 -=

1216 (
block_group
->
Ëngth
 - block_group->
zÚe_unu§bË
);

1217 
block_group
->
¥aû_šfo
->
by‹s_zÚe_unu§bË
 -=

1218 
block_group
->
zÚe_unu§bË
;

1219 
block_group
->
¥aû_šfo
->
disk_tÙ®
 -ğblock_group->
Ëngth
 * 
çùÜ
;

1221 
	`¥š_uÆock
(&
block_group
->
¥aû_šfo
->
lock
);

1234 
»t
 = 
	`»move_block_group_ä“_¥aû
(
Œªs
, 
block_group
);

1235 ià(
»t
)

1236 
out
;

1238 
»t
 = 
	`»move_block_group_™em
(
Œªs
, 
·th
, 
block_group
);

1239 ià(
»t
 < 0)

1240 
out
;

1242 
	`¥š_lock
(&
block_group
->
lock
);

1243 
	`£t_b™
(
BLOCK_GROUP_FLAG_REMOVED
, &
block_group
->
ruÁime_æags
);

1271 
»move_em
 = (
	`©omic_»ad
(&
block_group
->
äoz’
) == 0);

1272 
	`¥š_uÆock
(&
block_group
->
lock
);

1274 ià(
»move_em
) {

1275 
ex‹Á_m­_Œ“
 *
em_Œ“
;

1277 
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

1278 
	`wr™e_lock
(&
em_Œ“
->
lock
);

1279 
	`»move_ex‹Á_m­pšg
(
em_Œ“
, 
em
);

1280 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

1282 
	`ä“_ex‹Á_m­
(
em
);

1285 
out
:

1287 
	`bŒfs_put_block_group
(
block_group
);

1288 ià(
»move_rsv
)

1289 
	`bŒfs_d–ayed_»fs_rsv_»Ëa£
(
fs_šfo
, 1);

1290 
	`bŒfs_ä“_·th
(
·th
);

1291  
»t
;

1292 
	}
}

1294 
bŒfs_Œªs_hªdË
 *
	$bŒfs_¡¬t_Œªs_»move_block_group
(

1295 
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ 
u64
 
chunk_off£t
)

1297 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_block_group_roÙ
(
fs_šfo
);

1298 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

1299 
ex‹Á_m­
 *
em
;

1300 
m­_lookup
 *
m­
;

1301 
num_™ems
;

1303 
	`»ad_lock
(&
em_Œ“
->
lock
);

1304 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
chunk_off£t
, 1);

1305 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

1306 
	`ASSERT
(
em
 &&ƒm->
¡¬t
 =ğ
chunk_off£t
);

1327 
m­
 = 
em
->
m­_lookup
;

1328 
num_™ems
 = 3 + 
m­
->
num_¡res
;

1329 
	`ä“_ex‹Á_m­
(
em
);

1331  
	`bŒfs_¡¬t_Œª§ùiÚ_çÎback_glob®_rsv
(
roÙ
, 
num_™ems
);

1332 
	}
}

1347 
	$šc_block_group_ro
(
bŒfs_block_group
 *
ÿche
, 
fÜû
)

1349 
bŒfs_¥aû_šfo
 *
sšfo
 = 
ÿche
->
¥aû_šfo
;

1350 
u64
 
num_by‹s
;

1351 
»t
 = -
ENOSPC
;

1353 
	`¥š_lock
(&
sšfo
->
lock
);

1354 
	`¥š_lock
(&
ÿche
->
lock
);

1356 ià(
ÿche
->
sw­_ex‹Ás
) {

1357 
»t
 = -
ETXTBSY
;

1358 
out
;

1361 ià(
ÿche
->
ro
) {

1362 
ÿche
->
ro
++;

1363 
»t
 = 0;

1364 
out
;

1367 
num_by‹s
 = 
ÿche
->
Ëngth
 - cache->
»£rved
 - cache->
pšÃd
 -

1368 
ÿche
->
by‹s_su³r
 - cache->
zÚe_unu§bË
 - cache->
u£d
;

1374 ià(
fÜû
) {

1375 
»t
 = 0;

1376 } ià(
sšfo
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
) {

1377 
u64
 
sšfo_u£d
 = 
	`bŒfs_¥aû_šfo_u£d
(
sšfo
, 
Œue
);

1383 ià(
sšfo_u£d
 + 
num_by‹s
 <ğ
sšfo
->
tÙ®_by‹s
)

1384 
»t
 = 0;

1392 ià(
	`bŒfs_ÿn_ov”comm™
(
ÿche
->
fs_šfo
, 
sšfo
, 
num_by‹s
,

1393 
BTRFS_RESERVE_NO_FLUSH
))

1394 
»t
 = 0;

1397 ià(!
»t
) {

1398 
sšfo
->
by‹s_»adÚly
 +ğ
num_by‹s
;

1399 ià(
	`bŒfs_is_zÚed
(
ÿche
->
fs_šfo
)) {

1401 
sšfo
->
by‹s_»adÚly
 +ğ
ÿche
->
zÚe_unu§bË
;

1402 
sšfo
->
by‹s_zÚe_unu§bË
 -ğ
ÿche
->
zÚe_unu§bË
;

1403 
ÿche
->
zÚe_unu§bË
 = 0;

1405 
ÿche
->
ro
++;

1406 
	`li¡_add_
(&
ÿche
->
ro_li¡
, &
sšfo
->
ro_bgs
);

1408 
out
:

1409 
	`¥š_uÆock
(&
ÿche
->
lock
);

1410 
	`¥š_uÆock
(&
sšfo
->
lock
);

1411 ià(
»t
 =ğ-
ENOSPC
 && 
	`bŒfs_‹¡_İt
(
ÿche
->
fs_šfo
, 
ENOSPC_DEBUG
)) {

1412 
	`bŒfs_šfo
(
ÿche
->
fs_šfo
,

1413 "uÇbËØmakblock grou°%Îu„o", 
ÿche
->
¡¬t
);

1414 
	`bŒfs_dump_¥aû_šfo
(
ÿche
->
fs_šfo
, cache->
¥aû_šfo
, 0, 0);

1416  
»t
;

1417 
	}
}

1419 
boŞ
 
	$ş—n_pšÃd_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1420 
bŒfs_block_group
 *
bg
)

1422 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bg
->fs_info;

1423 
bŒfs_Œª§ùiÚ
 *
´ev_Œªs
 = 
NULL
;

1424 cÚ¡ 
u64
 
¡¬t
 = 
bg
->start;

1425 cÚ¡ 
u64
 
’d
 = 
¡¬t
 + 
bg
->
Ëngth
 - 1;

1426 
»t
;

1428 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

1429 ià(
Œªs
->
Œª§ùiÚ
->
li¡
.
´ev
 !ğ&
fs_šfo
->
Œªs_li¡
) {

1430 
´ev_Œªs
 = 
	`li¡_Ï¡_’Œy
(&
Œªs
->
Œª§ùiÚ
->
li¡
,

1431 
bŒfs_Œª§ùiÚ
, 
li¡
);

1432 
	`»fcouÁ_šc
(&
´ev_Œªs
->
u£_couÁ
);

1434 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1446 
	`mu‹x_lock
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

1447 ià(
´ev_Œªs
) {

1448 
»t
 = 
	`ş—r_ex‹Á_b™s
(&
´ev_Œªs
->
pšÃd_ex‹Ás
, 
¡¬t
, 
’d
,

1449 
EXTENT_DIRTY
);

1450 ià(
»t
)

1451 
out
;

1454 
»t
 = 
	`ş—r_ex‹Á_b™s
(&
Œªs
->
Œª§ùiÚ
->
pšÃd_ex‹Ás
, 
¡¬t
, 
’d
,

1455 
EXTENT_DIRTY
);

1456 
out
:

1457 
	`mu‹x_uÆock
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

1458 ià(
´ev_Œªs
)

1459 
	`bŒfs_put_Œª§ùiÚ
(
´ev_Œªs
);

1461  
»t
 == 0;

1462 
	}
}

1468 
	$bŒfs_d–‘e_unu£d_bgs
(
bŒfs_fs_šfo
 *
fs_šfo
)

1470 
bŒfs_block_group
 *
block_group
;

1471 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

1472 
bŒfs_Œªs_hªdË
 *
Œªs
;

1473 cÚ¡ 
boŞ
 
async_Œim_’abËd
 = 
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DISCARD_ASYNC
);

1474 
»t
 = 0;

1476 ià(!
	`‹¡_b™
(
BTRFS_FS_OPEN
, &
fs_šfo
->
æags
))

1479 ià(
	`bŒfs_fs_şosšg
(
fs_šfo
))

1486 ià(!
	`mu‹x_Œylock
(&
fs_šfo
->
»şaim_bgs_lock
))

1489 
	`¥š_lock
(&
fs_šfo
->
unu£d_bgs_lock
);

1490 !
	`li¡_em±y
(&
fs_šfo
->
unu£d_bgs
)) {

1491 
Œimmšg
;

1493 
block_group
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
unu£d_bgs
,

1494 
bŒfs_block_group
,

1495 
bg_li¡
);

1496 
	`li¡_d–_š™
(&
block_group
->
bg_li¡
);

1498 
¥aû_šfo
 = 
block_group
->space_info;

1500 ià(
»t
 || 
	`bŒfs_mixed_¥aû_šfo
(
¥aû_šfo
)) {

1501 
	`bŒfs_put_block_group
(
block_group
);

1504 
	`¥š_uÆock
(&
fs_šfo
->
unu£d_bgs_lock
);

1506 
	`bŒfs_disÿrd_ÿnûl_wÜk
(&
fs_šfo
->
disÿrd_ùl
, 
block_group
);

1509 
	`down_wr™e
(&
¥aû_šfo
->
groups_£m
);

1516 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DISCARD_ASYNC
) &&

1517 !
	`bŒfs_is_ä“_¥aû_Œimmed
(
block_group
)) {

1518 
	`Œaû_bŒfs_sk_unu£d_block_group
(
block_group
);

1519 
	`up_wr™e
(&
¥aû_šfo
->
groups_£m
);

1521 
	`bŒfs_disÿrd_queue_wÜk
(&
fs_šfo
->
disÿrd_ùl
,

1522 
block_group
);

1523 
Ãxt
;

1526 
	`¥š_lock
(&
block_group
->
lock
);

1527 ià(
block_group
->
»£rved
 || block_group->
pšÃd
 ||

1528 
block_group
->
u£d
 || block_group->
ro
 ||

1529 
	`li¡_is_sšguÏr
(&
block_group
->
li¡
)) {

1536 
	`Œaû_bŒfs_sk_unu£d_block_group
(
block_group
);

1537 
	`¥š_uÆock
(&
block_group
->
lock
);

1538 
	`up_wr™e
(&
¥aû_šfo
->
groups_£m
);

1539 
Ãxt
;

1541 
	`¥š_uÆock
(&
block_group
->
lock
);

1544 
»t
 = 
	`šc_block_group_ro
(
block_group
, 0);

1545 
	`up_wr™e
(&
¥aû_šfo
->
groups_£m
);

1546 ià(
»t
 < 0) {

1547 
»t
 = 0;

1548 
Ãxt
;

1551 
»t
 = 
	`bŒfs_zÚe_fšish
(
block_group
);

1552 ià(
»t
 < 0) {

1553 
	`bŒfs_dec_block_group_ro
(
block_group
);

1554 ià(
»t
 =ğ-
EAGAIN
)

1555 
»t
 = 0;

1556 
Ãxt
;

1563 
Œªs
 = 
	`bŒfs_¡¬t_Œªs_»move_block_group
(
fs_šfo
,

1564 
block_group
->
¡¬t
);

1565 ià(
	`IS_ERR
(
Œªs
)) {

1566 
	`bŒfs_dec_block_group_ro
(
block_group
);

1567 
»t
 = 
	`PTR_ERR
(
Œªs
);

1568 
Ãxt
;

1575 ià(!
	`ş—n_pšÃd_ex‹Ás
(
Œªs
, 
block_group
)) {

1576 
	`bŒfs_dec_block_group_ro
(
block_group
);

1577 
’d_Œªs
;

1587 
	`¥š_lock
(&
fs_šfo
->
disÿrd_ùl
.
lock
);

1588 ià(!
	`li¡_em±y
(&
block_group
->
disÿrd_li¡
)) {

1589 
	`¥š_uÆock
(&
fs_šfo
->
disÿrd_ùl
.
lock
);

1590 
	`bŒfs_dec_block_group_ro
(
block_group
);

1591 
	`bŒfs_disÿrd_queue_wÜk
(&
fs_šfo
->
disÿrd_ùl
,

1592 
block_group
);

1593 
’d_Œªs
;

1595 
	`¥š_uÆock
(&
fs_šfo
->
disÿrd_ùl
.
lock
);

1598 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1599 
	`¥š_lock
(&
block_group
->
lock
);

1601 
	`bŒfs_¥aû_šfo_upd©e_by‹s_pšÃd
(
fs_šfo
, 
¥aû_šfo
,

1602 -
block_group
->
pšÃd
);

1603 
¥aû_šfo
->
by‹s_»adÚly
 +ğ
block_group
->
pšÃd
;

1604 
block_group
->
pšÃd
 = 0;

1606 
	`¥š_uÆock
(&
block_group
->
lock
);

1607 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1616 ià(!
async_Œim_’abËd
 && 
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DISCARD_ASYNC
))

1617 
æ_async
;

1623 
Œimmšg
 = 
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DISCARD_SYNC
) ||

1624 
	`bŒfs_is_zÚed
(
fs_šfo
);

1627 ià(
Œimmšg
)

1628 
	`bŒfs_ä“ze_block_group
(
block_group
);

1634 
»t
 = 
	`bŒfs_»move_chunk
(
Œªs
, 
block_group
->
¡¬t
);

1636 ià(
»t
) {

1637 ià(
Œimmšg
)

1638 
	`bŒfs_unä“ze_block_group
(
block_group
);

1639 
’d_Œªs
;

1647 ià(
Œimmšg
) {

1648 
	`¥š_lock
(&
fs_šfo
->
unu£d_bgs_lock
);

1654 
	`li¡_move
(&
block_group
->
bg_li¡
,

1655 &
Œªs
->
Œª§ùiÚ
->
d–‘ed_bgs
);

1656 
	`¥š_uÆock
(&
fs_šfo
->
unu£d_bgs_lock
);

1657 
	`bŒfs_g‘_block_group
(
block_group
);

1659 
’d_Œªs
:

1660 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1661 
Ãxt
:

1662 
	`bŒfs_put_block_group
(
block_group
);

1663 
	`¥š_lock
(&
fs_šfo
->
unu£d_bgs_lock
);

1665 
	`¥š_uÆock
(&
fs_šfo
->
unu£d_bgs_lock
);

1666 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

1669 
æ_async
:

1670 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1671 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

1672 
	`bŒfs_put_block_group
(
block_group
);

1673 
	`bŒfs_disÿrd_puÁ_unu£d_bgs_li¡
(
fs_šfo
);

1674 
	}
}

1676 
	$bŒfs_m¬k_bg_unu£d
(
bŒfs_block_group
 *
bg
)

1678 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bg
->fs_info;

1680 
	`¥š_lock
(&
fs_šfo
->
unu£d_bgs_lock
);

1681 ià(
	`li¡_em±y
(&
bg
->
bg_li¡
)) {

1682 
	`bŒfs_g‘_block_group
(
bg
);

1683 
	`Œaû_bŒfs_add_unu£d_block_group
(
bg
);

1684 
	`li¡_add_
(&
bg
->
bg_li¡
, &
fs_šfo
->
unu£d_bgs
);

1685 } ià(!
	`‹¡_b™
(
BLOCK_GROUP_FLAG_NEW
, &
bg
->
ruÁime_æags
)) {

1687 
	`Œaû_bŒfs_add_unu£d_block_group
(
bg
);

1688 
	`li¡_move_
(&
bg
->
bg_li¡
, &
fs_šfo
->
unu£d_bgs
);

1690 
	`¥š_uÆock
(&
fs_šfo
->
unu£d_bgs_lock
);

1691 
	}
}

1697 
	$»şaim_bgs_cmp
(*
unu£d
, cÚ¡ 
li¡_h—d
 *
a
,

1698 cÚ¡ 
li¡_h—d
 *
b
)

1700 cÚ¡ 
bŒfs_block_group
 *
bg1
, *
bg2
;

1702 
bg1
 = 
	`li¡_’Œy
(
a
, 
bŒfs_block_group
, 
bg_li¡
);

1703 
bg2
 = 
	`li¡_’Œy
(
b
, 
bŒfs_block_group
, 
bg_li¡
);

1705  
bg1
->
u£d
 > 
bg2
->used;

1706 
	}
}

1708 
šlše
 
boŞ
 
	$bŒfs_should_»şaim
(
bŒfs_fs_šfo
 *
fs_šfo
)

1710 ià(
	`bŒfs_is_zÚed
(
fs_šfo
))

1711  
	`bŒfs_zÚed_should_»şaim
(
fs_šfo
);

1712  
Œue
;

1713 
	}
}

1715 
boŞ
 
	$should_»şaim_block_group
(
bŒfs_block_group
 *
bg
, 
u64
 
by‹s_ä“d
)

1717 cÚ¡ 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
bg
->space_info;

1718 cÚ¡ 
»şaim_th»sh
 = 
	`READ_ONCE
(
¥aû_šfo
->
bg_»şaim_th»shŞd
);

1719 cÚ¡ 
u64
 
Ãw_v®
 = 
bg
->
u£d
;

1720 cÚ¡ 
u64
 
Şd_v®
 = 
Ãw_v®
 + 
by‹s_ä“d
;

1721 
u64
 
th»sh
;

1723 ià(
»şaim_th»sh
 == 0)

1724  
çl£
;

1726 
th»sh
 = 
	`muÉ_³rc
(
bg
->
Ëngth
, 
»şaim_th»sh
);

1732 ià(
Şd_v®
 < 
th»sh
)

1733  
çl£
;

1734 ià(
Ãw_v®
 >ğ
th»sh
)

1735  
çl£
;

1736  
Œue
;

1737 
	}
}

1739 
	$bŒfs_»şaim_bgs_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1741 
bŒfs_fs_šfo
 *
fs_šfo
 =

1742 
	`cÚš”_of
(
wÜk
, 
bŒfs_fs_šfo
, 
»şaim_bgs_wÜk
);

1743 
bŒfs_block_group
 *
bg
;

1744 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

1746 ià(!
	`‹¡_b™
(
BTRFS_FS_OPEN
, &
fs_šfo
->
æags
))

1749 ià(
	`bŒfs_fs_şosšg
(
fs_šfo
))

1752 ià(!
	`bŒfs_should_»şaim
(
fs_šfo
))

1755 
	`sb_¡¬t_wr™e
(
fs_šfo
->
sb
);

1757 ià(!
	`bŒfs_exşİ_¡¬t
(
fs_šfo
, 
BTRFS_EXCLOP_BALANCE
)) {

1758 
	`sb_’d_wr™e
(
fs_šfo
->
sb
);

1766 ià(!
	`mu‹x_Œylock
(&
fs_šfo
->
»şaim_bgs_lock
)) {

1767 
	`bŒfs_exşİ_fšish
(
fs_šfo
);

1768 
	`sb_’d_wr™e
(
fs_šfo
->
sb
);

1772 
	`¥š_lock
(&
fs_šfo
->
unu£d_bgs_lock
);

1778 
	`li¡_sÜt
(
NULL
, &
fs_šfo
->
»şaim_bgs
, 
»şaim_bgs_cmp
);

1779 !
	`li¡_em±y
(&
fs_šfo
->
»şaim_bgs
)) {

1780 
u64
 
zÚe_unu§bË
;

1781 
»t
 = 0;

1783 
bg
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
»şaim_bgs
,

1784 
bŒfs_block_group
,

1785 
bg_li¡
);

1786 
	`li¡_d–_š™
(&
bg
->
bg_li¡
);

1788 
¥aû_šfo
 = 
bg
->space_info;

1789 
	`¥š_uÆock
(&
fs_šfo
->
unu£d_bgs_lock
);

1792 
	`down_wr™e
(&
¥aû_šfo
->
groups_£m
);

1794 
	`¥š_lock
(&
bg
->
lock
);

1795 ià(
bg
->
»£rved
 || bg->
pšÃd
 || bg->
ro
) {

1802 
	`¥š_uÆock
(&
bg
->
lock
);

1803 
	`up_wr™e
(&
¥aû_šfo
->
groups_£m
);

1804 
Ãxt
;

1806 ià(
bg
->
u£d
 == 0) {

1818 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DISCARD_ASYNC
))

1819 
	`bŒfs_m¬k_bg_unu£d
(
bg
);

1820 
	`¥š_uÆock
(&
bg
->
lock
);

1821 
	`up_wr™e
(&
¥aû_šfo
->
groups_£m
);

1822 
Ãxt
;

1835 ià(!
	`should_»şaim_block_group
(
bg
, bg->
Ëngth
)) {

1836 
	`¥š_uÆock
(&
bg
->
lock
);

1837 
	`up_wr™e
(&
¥aû_šfo
->
groups_£m
);

1838 
Ãxt
;

1840 
	`¥š_uÆock
(&
bg
->
lock
);

1850 ià(
	`bŒfs_Ãed_ş—Ãr_¦“p
(
fs_šfo
)) {

1851 
	`up_wr™e
(&
¥aû_šfo
->
groups_£m
);

1852 
Ãxt
;

1861 
zÚe_unu§bË
 = 
bg
->zone_unusable;

1862 
»t
 = 
	`šc_block_group_ro
(
bg
, 0);

1863 
	`up_wr™e
(&
¥aû_šfo
->
groups_£m
);

1864 ià(
»t
 < 0)

1865 
Ãxt
;

1867 
	`bŒfs_šfo
(
fs_šfo
,

1869 
bg
->
¡¬t
,

1870 
	`div64_u64
(
bg
->
u£d
 * 100, bg->
Ëngth
),

1871 
	`div64_u64
(
zÚe_unu§bË
 * 100, 
bg
->
Ëngth
));

1872 
	`Œaû_bŒfs_»şaim_block_group
(
bg
);

1873 
»t
 = 
	`bŒfs_»loÿ‹_chunk
(
fs_šfo
, 
bg
->
¡¬t
);

1874 ià(
»t
) {

1875 
	`bŒfs_dec_block_group_ro
(
bg
);

1876 
	`bŒfs_”r
(
fs_šfo
, "error„elocating chunk %llu",

1877 
bg
->
¡¬t
);

1880 
Ãxt
:

1881 ià(
»t
)

1882 
	`bŒfs_m¬k_bg_to_»şaim
(
bg
);

1883 
	`bŒfs_put_block_group
(
bg
);

1885 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

1890 
	`bŒfs_d–‘e_unu£d_bgs
(
fs_šfo
);

1895 ià(!
	`mu‹x_Œylock
(&
fs_šfo
->
»şaim_bgs_lock
))

1896 
’d
;

1897 
	`¥š_lock
(&
fs_šfo
->
unu£d_bgs_lock
);

1899 
	`¥š_uÆock
(&
fs_šfo
->
unu£d_bgs_lock
);

1900 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

1901 
’d
:

1902 
	`bŒfs_exşİ_fšish
(
fs_šfo
);

1903 
	`sb_’d_wr™e
(
fs_šfo
->
sb
);

1904 
	}
}

1906 
	$bŒfs_»şaim_bgs
(
bŒfs_fs_šfo
 *
fs_šfo
)

1908 
	`¥š_lock
(&
fs_šfo
->
unu£d_bgs_lock
);

1909 ià(!
	`li¡_em±y
(&
fs_šfo
->
»şaim_bgs
))

1910 
	`queue_wÜk
(
sy¡em_unbound_wq
, &
fs_šfo
->
»şaim_bgs_wÜk
);

1911 
	`¥š_uÆock
(&
fs_šfo
->
unu£d_bgs_lock
);

1912 
	}
}

1914 
	$bŒfs_m¬k_bg_to_»şaim
(
bŒfs_block_group
 *
bg
)

1916 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bg
->fs_info;

1918 
	`¥š_lock
(&
fs_šfo
->
unu£d_bgs_lock
);

1919 ià(
	`li¡_em±y
(&
bg
->
bg_li¡
)) {

1920 
	`bŒfs_g‘_block_group
(
bg
);

1921 
	`Œaû_bŒfs_add_»şaim_block_group
(
bg
);

1922 
	`li¡_add_
(&
bg
->
bg_li¡
, &
fs_šfo
->
»şaim_bgs
);

1924 
	`¥š_uÆock
(&
fs_šfo
->
unu£d_bgs_lock
);

1925 
	}
}

1927 
	$»ad_bg_äom_eb
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bŒfs_key
 *
key
,

1928 
bŒfs_·th
 *
·th
)

1930 
ex‹Á_m­_Œ“
 *
em_Œ“
;

1931 
ex‹Á_m­
 *
em
;

1932 
bŒfs_block_group_™em
 
bg
;

1933 
ex‹Á_bufãr
 *
Ëaf
;

1934 
¦Ù
;

1935 
u64
 
æags
;

1936 
»t
 = 0;

1938 
¦Ù
 = 
·th
->
¦Ùs
[0];

1939 
Ëaf
 = 
·th
->
nodes
[0];

1941 
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

1942 
	`»ad_lock
(&
em_Œ“
->
lock
);

1943 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
key
->
objeùid
, key->
off£t
);

1944 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

1945 ià(!
em
) {

1946 
	`bŒfs_”r
(
fs_šfo
,

1948 
key
->
objeùid
, key->
off£t
);

1949  -
ENOENT
;

1952 ià(
em
->
¡¬t
 !ğ
key
->
objeùid
 ||ƒm->
Ën
 !ğkey->
off£t
) {

1953 
	`bŒfs_”r
(
fs_šfo
,

1955 
key
->
objeùid
, key->
off£t
, 
em
->
¡¬t
,ƒm->
Ën
);

1956 
»t
 = -
EUCLEAN
;

1957 
out_ä“_em
;

1960 
	`»ad_ex‹Á_bufãr
(
Ëaf
, &
bg
, 
	`bŒfs_™em_±r_off£t
Ö—f, 
¦Ù
),

1961 (
bg
));

1962 
æags
 = 
	`bŒfs_¡ack_block_group_æags
(&
bg
) &

1963 
BTRFS_BLOCK_GROUP_TYPE_MASK
;

1965 ià(
æags
 !ğ(
em
->
m­_lookup
->
ty³
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
)) {

1966 
	`bŒfs_”r
(
fs_šfo
,

1968 
key
->
objeùid
, key->
off£t
, 
æags
,

1969 (
BTRFS_BLOCK_GROUP_TYPE_MASK
 & 
em
->
m­_lookup
->
ty³
));

1970 
»t
 = -
EUCLEAN
;

1973 
out_ä“_em
:

1974 
	`ä“_ex‹Á_m­
(
em
);

1975  
»t
;

1976 
	}
}

1978 
	$fšd_fœ¡_block_group
(
bŒfs_fs_šfo
 *
fs_šfo
,

1979 
bŒfs_·th
 *
·th
,

1980 
bŒfs_key
 *
key
)

1982 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_block_group_roÙ
(
fs_šfo
);

1983 
»t
;

1984 
bŒfs_key
 
found_key
;

1986 
	`bŒfs_fÜ_—ch_¦Ù
(
roÙ
, 
key
, &
found_key
, 
·th
, 
»t
) {

1987 ià(
found_key
.
objeùid
 >ğ
key
->objectid &&

1988 
found_key
.
ty³
 =ğ
BTRFS_BLOCK_GROUP_ITEM_KEY
) {

1989  
	`»ad_bg_äom_eb
(
fs_šfo
, &
found_key
, 
·th
);

1992  
»t
;

1993 
	}
}

1995 
	$£t_ava_®loc_b™s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æags
)

1997 
u64
 
exŒa_æags
 = 
	`chunk_to_ex‹nded
(
æags
) &

1998 
BTRFS_EXTENDED_PROFILE_MASK
;

2000 
	`wr™e_£qlock
(&
fs_šfo
->
´ofes_lock
);

2001 ià(
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

2002 
fs_šfo
->
ava_d©a_®loc_b™s
 |ğ
exŒa_æags
;

2003 ià(
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
)

2004 
fs_šfo
->
ava_m‘ad©a_®loc_b™s
 |ğ
exŒa_æags
;

2005 ià(
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

2006 
fs_šfo
->
ava_sy¡em_®loc_b™s
 |ğ
exŒa_æags
;

2007 
	`wr™e_£quÆock
(&
fs_šfo
->
´ofes_lock
);

2008 
	}
}

2024 
	$bŒfs_rm­_block
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
chunk_¡¬t
,

2025 
u64
 
physiÿl
, u64 **
logiÿl
, *
Çddrs
, *
¡re_Ën
)

2027 
ex‹Á_m­
 *
em
;

2028 
m­_lookup
 *
m­
;

2029 
u64
 *
buf
;

2030 
u64
 
by‹Ä
;

2031 
u64
 
d©a_¡re_Ëngth
;

2032 
u64
 
io_¡re_size
;

2033 
i
, 
Ä
 = 0;

2034 
»t
 = 0;

2036 
em
 = 
	`bŒfs_g‘_chunk_m­
(
fs_šfo
, 
chunk_¡¬t
, 1);

2037 ià(
	`IS_ERR
(
em
))

2038  -
EIO
;

2040 
m­
 = 
em
->
m­_lookup
;

2041 
d©a_¡re_Ëngth
 = 
em
->
Üig_block_Ën
;

2042 
io_¡re_size
 = 
BTRFS_STRIPE_LEN
;

2043 
chunk_¡¬t
 = 
em
->
¡¬t
;

2046 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
)

2047 
io_¡re_size
 = 
	`bŒfs_¡re_Ä_to_off£t
(
	`Ä_d©a_¡res
(
m­
));

2049 
buf
 = 
	`kÿÎoc
(
m­
->
num_¡res
, (
u64
), 
GFP_NOFS
);

2050 ià(!
buf
) {

2051 
»t
 = -
ENOMEM
;

2052 
out
;

2055 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

2056 
boŞ
 
®»ady_š£¹ed
 = 
çl£
;

2057 
u32
 
¡re_Ä
;

2058 
u32
 
off£t
;

2059 
j
;

2061 ià(!
	`š_¿nge
(
physiÿl
, 
m­
->
¡res
[
i
].physical,

2062 
d©a_¡re_Ëngth
))

2065 
¡re_Ä
 = (
physiÿl
 - 
m­
->
¡res
[
i
].physical) >>

2066 
BTRFS_STRIPE_LEN_SHIFT
;

2067 
off£t
 = (
physiÿl
 - 
m­
->
¡res
[
i
].physical) &

2068 
BTRFS_STRIPE_LEN_MASK
;

2070 ià(
m­
->
ty³
 & (
BTRFS_BLOCK_GROUP_RAID0
 |

2071 
BTRFS_BLOCK_GROUP_RAID10
))

2072 
¡re_Ä
 = 
	`div_u64
(¡re_Ä * 
m­
->
num_¡res
 + 
i
,

2073 
m­
->
sub_¡res
);

2079 
by‹Ä
 = 
chunk_¡¬t
 + 
¡re_Ä
 * 
io_¡re_size
 + 
off£t
;

2082 
j
 = 0; j < 
Ä
; j++) {

2083 ià(
buf
[
j
] =ğ
by‹Ä
) {

2084 
®»ady_š£¹ed
 = 
Œue
;

2089 ià(!
®»ady_š£¹ed
)

2090 
buf
[
Ä
++] = 
by‹Ä
;

2093 *
logiÿl
 = 
buf
;

2094 *
Çddrs
 = 
Ä
;

2095 *
¡re_Ën
 = 
io_¡re_size
;

2096 
out
:

2097 
	`ä“_ex‹Á_m­
(
em
);

2098  
»t
;

2099 
	}
}

2101 
	$exşude_su³r_¡res
(
bŒfs_block_group
 *
ÿche
)

2103 
bŒfs_fs_šfo
 *
fs_šfo
 = 
ÿche
->fs_info;

2104 cÚ¡ 
boŞ
 
zÚed
 = 
	`bŒfs_is_zÚed
(
fs_šfo
);

2105 
u64
 
by‹Ä
;

2106 
u64
 *
logiÿl
;

2107 
¡re_Ën
;

2108 
i
, 
Ä
, 
»t
;

2110 ià(
ÿche
->
¡¬t
 < 
BTRFS_SUPER_INFO_OFFSET
) {

2111 
¡re_Ën
 = 
BTRFS_SUPER_INFO_OFFSET
 - 
ÿche
->
¡¬t
;

2112 
ÿche
->
by‹s_su³r
 +ğ
¡re_Ën
;

2113 
»t
 = 
	`£t_ex‹Á_b™
(&
fs_šfo
->
exşuded_ex‹Ás
, 
ÿche
->
¡¬t
,

2114 
ÿche
->
¡¬t
 + 
¡re_Ën
 - 1,

2115 
EXTENT_UPTODATE
, 
NULL
);

2116 ià(
»t
)

2117  
»t
;

2120 
i
 = 0; i < 
BTRFS_SUPER_MIRROR_MAX
; i++) {

2121 
by‹Ä
 = 
	`bŒfs_sb_off£t
(
i
);

2122 
»t
 = 
	`bŒfs_rm­_block
(
fs_šfo
, 
ÿche
->
¡¬t
,

2123 
by‹Ä
, &
logiÿl
, &
Ä
, &
¡re_Ën
);

2124 ià(
»t
)

2125  
»t
;

2128 ià(
zÚed
 && 
Ä
) {

2129 
	`kä“
(
logiÿl
);

2130 
	`bŒfs_”r
(
fs_šfo
,

2132 
ÿche
->
¡¬t
);

2133  -
EUCLEAN
;

2136 
Ä
--) {

2137 
u64
 
Ën
 = 
	`mš_t
(u64, 
¡re_Ën
,

2138 
ÿche
->
¡¬t
 + cache->
Ëngth
 - 
logiÿl
[
Ä
]);

2140 
ÿche
->
by‹s_su³r
 +ğ
Ën
;

2141 
»t
 = 
	`£t_ex‹Á_b™
(&
fs_šfo
->
exşuded_ex‹Ás
, 
logiÿl
[
Ä
],

2142 
logiÿl
[
Ä
] + 
Ën
 - 1,

2143 
EXTENT_UPTODATE
, 
NULL
);

2144 ià(
»t
) {

2145 
	`kä“
(
logiÿl
);

2146  
»t
;

2150 
	`kä“
(
logiÿl
);

2153 
	}
}

2155 
bŒfs_block_group
 *
	$bŒfs_ü—‹_block_group_ÿche
(

2156 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
)

2158 
bŒfs_block_group
 *
ÿche
;

2160 
ÿche
 = 
	`kz®loc
((*ÿche), 
GFP_NOFS
);

2161 ià(!
ÿche
)

2162  
NULL
;

2164 
ÿche
->
ä“_¥aû_ùl
 = 
	`kz®loc
((*cache->free_space_ctl),

2165 
GFP_NOFS
);

2166 ià(!
ÿche
->
ä“_¥aû_ùl
) {

2167 
	`kä“
(
ÿche
);

2168  
NULL
;

2171 
ÿche
->
¡¬t
 = start;

2173 
ÿche
->
fs_šfo
 = fs_info;

2174 
ÿche
->
fuÎ_¡re_Ën
 = 
	`bŒfs_fuÎ_¡re_Ën
(
fs_šfo
, 
¡¬t
);

2176 
ÿche
->
disÿrd_šdex
 = 
BTRFS_DISCARD_INDEX_UNUSED
;

2178 
	`»fcouÁ_£t
(&
ÿche
->
»fs
, 1);

2179 
	`¥š_lock_š™
(&
ÿche
->
lock
);

2180 
	`š™_rw£m
(&
ÿche
->
d©a_rw£m
);

2181 
	`INIT_LIST_HEAD
(&
ÿche
->
li¡
);

2182 
	`INIT_LIST_HEAD
(&
ÿche
->
şu¡”_li¡
);

2183 
	`INIT_LIST_HEAD
(&
ÿche
->
bg_li¡
);

2184 
	`INIT_LIST_HEAD
(&
ÿche
->
ro_li¡
);

2185 
	`INIT_LIST_HEAD
(&
ÿche
->
disÿrd_li¡
);

2186 
	`INIT_LIST_HEAD
(&
ÿche
->
dœty_li¡
);

2187 
	`INIT_LIST_HEAD
(&
ÿche
->
io_li¡
);

2188 
	`INIT_LIST_HEAD
(&
ÿche
->
aùive_bg_li¡
);

2189 
	`bŒfs_š™_ä“_¥aû_ùl
(
ÿche
, cache->
ä“_¥aû_ùl
);

2190 
	`©omic_£t
(&
ÿche
->
äoz’
, 0);

2191 
	`mu‹x_š™
(&
ÿche
->
ä“_¥aû_lock
);

2193  
ÿche
;

2194 
	}
}

2200 
	$check_chunk_block_group_m­pšgs
(
bŒfs_fs_šfo
 *
fs_šfo
)

2202 
ex‹Á_m­_Œ“
 *
m­_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

2203 
ex‹Á_m­
 *
em
;

2204 
bŒfs_block_group
 *
bg
;

2205 
u64
 
¡¬t
 = 0;

2206 
»t
 = 0;

2209 
	`»ad_lock
(&
m­_Œ“
->
lock
);

2215 
em
 = 
	`lookup_ex‹Á_m­pšg
(
m­_Œ“
, 
¡¬t
, 1);

2216 
	`»ad_uÆock
(&
m­_Œ“
->
lock
);

2217 ià(!
em
)

2220 
bg
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
em
->
¡¬t
);

2221 ià(!
bg
) {

2222 
	`bŒfs_”r
(
fs_šfo
,

2224 
em
->
¡¬t
,ƒm->
Ën
);

2225 
»t
 = -
EUCLEAN
;

2226 
	`ä“_ex‹Á_m­
(
em
);

2229 ià(
bg
->
¡¬t
 !ğ
em
->¡¬ˆ|| bg->
Ëngth
 !ğem->
Ën
 ||

2230 (
bg
->
æags
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
) !=

2231 (
em
->
m­_lookup
->
ty³
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
)) {

2232 
	`bŒfs_”r
(
fs_šfo
,

2234 
em
->
¡¬t
,ƒm->
Ën
,

2235 
em
->
m­_lookup
->
ty³
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
,

2236 
bg
->
¡¬t
, bg->
Ëngth
,

2237 
bg
->
æags
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
);

2238 
»t
 = -
EUCLEAN
;

2239 
	`ä“_ex‹Á_m­
(
em
);

2240 
	`bŒfs_put_block_group
(
bg
);

2243 
¡¬t
 = 
em
->¡¬ˆ+ƒm->
Ën
;

2244 
	`ä“_ex‹Á_m­
(
em
);

2245 
	`bŒfs_put_block_group
(
bg
);

2247  
»t
;

2248 
	}
}

2250 
	$»ad_Úe_block_group
(
bŒfs_fs_šfo
 *
šfo
,

2251 
bŒfs_block_group_™em
 *
bgi
,

2252 cÚ¡ 
bŒfs_key
 *
key
,

2253 
Ãed_ş—r
)

2255 
bŒfs_block_group
 *
ÿche
;

2256 cÚ¡ 
boŞ
 
mixed
 = 
	`bŒfs_fs_šcom·t
(
šfo
, 
MIXED_GROUPS
);

2257 
»t
;

2259 
	`ASSERT
(
key
->
ty³
 =ğ
BTRFS_BLOCK_GROUP_ITEM_KEY
);

2261 
ÿche
 = 
	`bŒfs_ü—‹_block_group_ÿche
(
šfo
, 
key
->
objeùid
);

2262 ià(!
ÿche
)

2263  -
ENOMEM
;

2265 
ÿche
->
Ëngth
 = 
key
->
off£t
;

2266 
ÿche
->
u£d
 = 
	`bŒfs_¡ack_block_group_u£d
(
bgi
);

2267 
ÿche
->
comm™_u£d
 = cache->
u£d
;

2268 
ÿche
->
æags
 = 
	`bŒfs_¡ack_block_group_æags
(
bgi
);

2269 
ÿche
->
glob®_roÙ_id
 = 
	`bŒfs_¡ack_block_group_chunk_objeùid
(
bgi
);

2271 
	`£t_ä“_¥aû_Œ“_th»shŞds
(
ÿche
);

2273 ià(
Ãed_ş—r
) {

2284 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
SPACE_CACHE
))

2285 
ÿche
->
disk_ÿche_¡©e
 = 
BTRFS_DC_CLEAR
;

2287 ià(!
mixed
 && ((
ÿche
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
) &&

2288 (
ÿche
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
))) {

2289 
	`bŒfs_”r
(
šfo
,

2291 
ÿche
->
¡¬t
);

2292 
»t
 = -
EINVAL
;

2293 
”rÜ
;

2296 
»t
 = 
	`bŒfs_lßd_block_group_zÚe_šfo
(
ÿche
, 
çl£
);

2297 ià(
»t
) {

2298 
	`bŒfs_”r
(
šfo
, "zoned: failedo†oad zone info of bg %llu",

2299 
ÿche
->
¡¬t
);

2300 
”rÜ
;

2308 
»t
 = 
	`exşude_su³r_¡res
(
ÿche
);

2309 ià(
»t
) {

2311 
	`bŒfs_ä“_exşuded_ex‹Ás
(
ÿche
);

2312 
”rÜ
;

2327 ià(
	`bŒfs_is_zÚed
(
šfo
)) {

2328 
	`bŒfs_ÿlc_zÚe_unu§bË
(
ÿche
);

2330 
	`bŒfs_ä“_exşuded_ex‹Ás
(
ÿche
);

2331 } ià(
ÿche
->
Ëngth
 =ğÿche->
u£d
) {

2332 
ÿche
->
ÿched
 = 
BTRFS_CACHE_FINISHED
;

2333 
	`bŒfs_ä“_exşuded_ex‹Ás
(
ÿche
);

2334 } ià(
ÿche
->
u£d
 == 0) {

2335 
ÿche
->
ÿched
 = 
BTRFS_CACHE_FINISHED
;

2336 
»t
 = 
	`bŒfs_add_Ãw_ä“_¥aû
(
ÿche
, cache->
¡¬t
,

2337 
ÿche
->
¡¬t
 + cache->
Ëngth
, 
NULL
);

2338 
	`bŒfs_ä“_exşuded_ex‹Ás
(
ÿche
);

2339 ià(
»t
)

2340 
”rÜ
;

2343 
»t
 = 
	`bŒfs_add_block_group_ÿche
(
šfo
, 
ÿche
);

2344 ià(
»t
) {

2345 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

2346 
”rÜ
;

2348 
	`Œaû_bŒfs_add_block_group
(
šfo
, 
ÿche
, 0);

2349 
	`bŒfs_add_bg_to_¥aû_šfo
(
šfo
, 
ÿche
);

2351 
	`£t_ava_®loc_b™s
(
šfo
, 
ÿche
->
æags
);

2352 ià(
	`bŒfs_chunk_wr™—bË
(
šfo
, 
ÿche
->
¡¬t
)) {

2353 ià(
ÿche
->
u£d
 == 0) {

2354 
	`ASSERT
(
	`li¡_em±y
(&
ÿche
->
bg_li¡
));

2355 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
DISCARD_ASYNC
))

2356 
	`bŒfs_disÿrd_queue_wÜk
(&
šfo
->
disÿrd_ùl
, 
ÿche
);

2358 
	`bŒfs_m¬k_bg_unu£d
(
ÿche
);

2361 
	`šc_block_group_ro
(
ÿche
, 1);

2365 
”rÜ
:

2366 
	`bŒfs_put_block_group
(
ÿche
);

2367  
»t
;

2368 
	}
}

2370 
	$fl_dummy_bgs
(
bŒfs_fs_šfo
 *
fs_šfo
)

2372 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

2373 
rb_node
 *
node
;

2374 
»t
 = 0;

2376 
node
 = 
	`rb_fœ¡_ÿched
(&
em_Œ“
->
m­
);‚ode;‚odğ
	`rb_Ãxt
(node)) {

2377 
ex‹Á_m­
 *
em
;

2378 
m­_lookup
 *
m­
;

2379 
bŒfs_block_group
 *
bg
;

2381 
em
 = 
	`rb_’Œy
(
node
, 
ex‹Á_m­
, 
rb_node
);

2382 
m­
 = 
em
->
m­_lookup
;

2383 
bg
 = 
	`bŒfs_ü—‹_block_group_ÿche
(
fs_šfo
, 
em
->
¡¬t
);

2384 ià(!
bg
) {

2385 
»t
 = -
ENOMEM
;

2390 
bg
->
Ëngth
 = 
em
->
Ën
;

2391 
bg
->
æags
 = 
m­
->
ty³
;

2392 
bg
->
ÿched
 = 
BTRFS_CACHE_FINISHED
;

2393 
bg
->
u£d
 = 
em
->
Ën
;

2394 
bg
->
æags
 = 
m­
->
ty³
;

2395 
»t
 = 
	`bŒfs_add_block_group_ÿche
(
fs_šfo
, 
bg
);

2400 ià(
»t
 =ğ-
EEXIST
) {

2401 
»t
 = 0;

2402 
	`bŒfs_put_block_group
(
bg
);

2406 ià(
»t
) {

2407 
	`bŒfs_»move_ä“_¥aû_ÿche
(
bg
);

2408 
	`bŒfs_put_block_group
(
bg
);

2412 
	`bŒfs_add_bg_to_¥aû_šfo
(
fs_šfo
, 
bg
);

2414 
	`£t_ava_®loc_b™s
(
fs_šfo
, 
bg
->
æags
);

2416 ià(!
»t
)

2417 
	`bŒfs_š™_glob®_block_rsv
(
fs_šfo
);

2418  
»t
;

2419 
	}
}

2421 
	$bŒfs_»ad_block_groups
(
bŒfs_fs_šfo
 *
šfo
)

2423 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_block_group_roÙ
(
šfo
);

2424 
bŒfs_·th
 *
·th
;

2425 
»t
;

2426 
bŒfs_block_group
 *
ÿche
;

2427 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

2428 
bŒfs_key
 
key
;

2429 
Ãed_ş—r
 = 0;

2430 
u64
 
ÿche_g’
;

2440 ià(!
roÙ
 || (
	`bŒfs_su³r_com·t_ro_æags
(
šfo
->
su³r_cİy
) &

2441 ~
BTRFS_FEATURE_COMPAT_RO_SUPP
))

2442  
	`fl_dummy_bgs
(
šfo
);

2444 
key
.
objeùid
 = 0;

2445 
key
.
off£t
 = 0;

2446 
key
.
ty³
 = 
BTRFS_BLOCK_GROUP_ITEM_KEY
;

2447 
·th
 = 
	`bŒfs_®loc_·th
();

2448 ià(!
·th
)

2449  -
ENOMEM
;

2451 
ÿche_g’
 = 
	`bŒfs_su³r_ÿche_g’”©iÚ
(
šfo
->
su³r_cİy
);

2452 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
SPACE_CACHE
) &&

2453 
	`bŒfs_su³r_g’”©iÚ
(
šfo
->
su³r_cİy
è!ğ
ÿche_g’
)

2454 
Ãed_ş—r
 = 1;

2455 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
CLEAR_CACHE
))

2456 
Ãed_ş—r
 = 1;

2459 
bŒfs_block_group_™em
 
bgi
;

2460 
ex‹Á_bufãr
 *
Ëaf
;

2461 
¦Ù
;

2463 
»t
 = 
	`fšd_fœ¡_block_group
(
šfo
, 
·th
, &
key
);

2464 ià(
»t
 > 0)

2466 ià(
»t
 != 0)

2467 
”rÜ
;

2469 
Ëaf
 = 
·th
->
nodes
[0];

2470 
¦Ù
 = 
·th
->
¦Ùs
[0];

2472 
	`»ad_ex‹Á_bufãr
(
Ëaf
, &
bgi
, 
	`bŒfs_™em_±r_off£t
Ö—f, 
¦Ù
),

2473 (
bgi
));

2475 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

2476 
	`bŒfs_»Ëa£_·th
(
·th
);

2477 
»t
 = 
	`»ad_Úe_block_group
(
šfo
, &
bgi
, &
key
, 
Ãed_ş—r
);

2478 ià(
»t
 < 0)

2479 
”rÜ
;

2480 
key
.
objeùid
 +ğkey.
off£t
;

2481 
key
.
off£t
 = 0;

2483 
	`bŒfs_»Ëa£_·th
(
·th
);

2485 
	`li¡_fÜ_—ch_’Œy
(
¥aû_šfo
, &
šfo
->¥aû_šfo, 
li¡
) {

2486 
i
;

2488 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; i++) {

2489 ià(
	`li¡_em±y
(&
¥aû_šfo
->
block_groups
[
i
]))

2491 
ÿche
 = 
	`li¡_fœ¡_’Œy
(&
¥aû_šfo
->
block_groups
[
i
],

2492 
bŒfs_block_group
,

2493 
li¡
);

2494 
	`bŒfs_sysfs_add_block_group_ty³
(
ÿche
);

2497 ià(!(
	`bŒfs_g‘_®loc_´ofe
(
šfo
, 
¥aû_šfo
->
æags
) &

2498 (
BTRFS_BLOCK_GROUP_RAID10
 |

2499 
BTRFS_BLOCK_GROUP_RAID1_MASK
 |

2500 
BTRFS_BLOCK_GROUP_RAID56_MASK
 |

2501 
BTRFS_BLOCK_GROUP_DUP
)))

2507 
	`li¡_fÜ_—ch_’Œy
(
ÿche
,

2508 &
¥aû_šfo
->
block_groups
[
BTRFS_RAID_RAID0
],

2509 
li¡
)

2510 
	`šc_block_group_ro
(
ÿche
, 1);

2511 
	`li¡_fÜ_—ch_’Œy
(
ÿche
,

2512 &
¥aû_šfo
->
block_groups
[
BTRFS_RAID_SINGLE
],

2513 
li¡
)

2514 
	`šc_block_group_ro
(
ÿche
, 1);

2517 
	`bŒfs_š™_glob®_block_rsv
(
šfo
);

2518 
»t
 = 
	`check_chunk_block_group_m­pšgs
(
šfo
);

2519 
”rÜ
:

2520 
	`bŒfs_ä“_·th
(
·th
);

2527 ià(
»t
 && 
	`bŒfs_‹¡_İt
(
šfo
, 
IGNOREBADROOTS
))

2528 
»t
 = 
	`fl_dummy_bgs
(
šfo
);

2529  
»t
;

2530 
	}
}

2539 
	$š£¹_block_group_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2540 
bŒfs_block_group
 *
block_group
)

2542 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2543 
bŒfs_block_group_™em
 
bgi
;

2544 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_block_group_roÙ
(
fs_šfo
);

2545 
bŒfs_key
 
key
;

2546 
u64
 
Şd_comm™_u£d
;

2547 
»t
;

2549 
	`¥š_lock
(&
block_group
->
lock
);

2550 
	`bŒfs_£t_¡ack_block_group_u£d
(&
bgi
, 
block_group
->
u£d
);

2551 
	`bŒfs_£t_¡ack_block_group_chunk_objeùid
(&
bgi
,

2552 
block_group
->
glob®_roÙ_id
);

2553 
	`bŒfs_£t_¡ack_block_group_æags
(&
bgi
, 
block_group
->
æags
);

2554 
Şd_comm™_u£d
 = 
block_group
->
comm™_u£d
;

2555 
block_group
->
comm™_u£d
 = block_group->
u£d
;

2556 
key
.
objeùid
 = 
block_group
->
¡¬t
;

2557 
key
.
ty³
 = 
BTRFS_BLOCK_GROUP_ITEM_KEY
;

2558 
key
.
off£t
 = 
block_group
->
Ëngth
;

2559 
	`¥š_uÆock
(&
block_group
->
lock
);

2561 
»t
 = 
	`bŒfs_š£¹_™em
(
Œªs
, 
roÙ
, &
key
, &
bgi
, (bgi));

2562 ià(
»t
 < 0) {

2563 
	`¥š_lock
(&
block_group
->
lock
);

2564 
block_group
->
comm™_u£d
 = 
Şd_comm™_u£d
;

2565 
	`¥š_uÆock
(&
block_group
->
lock
);

2568  
»t
;

2569 
	}
}

2571 
	$š£¹_dev_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2572 
bŒfs_deviû
 *
deviû
, 
u64
 
chunk_off£t
,

2573 
u64
 
¡¬t
, u64 
num_by‹s
)

2575 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

2576 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

2577 
bŒfs_·th
 *
·th
;

2578 
bŒfs_dev_ex‹Á
 *
ex‹Á
;

2579 
ex‹Á_bufãr
 *
Ëaf
;

2580 
bŒfs_key
 
key
;

2581 
»t
;

2583 
	`WARN_ON
(!
	`‹¡_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
deviû
->
dev_¡©e
));

2584 
	`WARN_ON
(
	`‹¡_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
));

2585 
·th
 = 
	`bŒfs_®loc_·th
();

2586 ià(!
·th
)

2587  -
ENOMEM
;

2589 
key
.
objeùid
 = 
deviû
->
devid
;

2590 
key
.
ty³
 = 
BTRFS_DEV_EXTENT_KEY
;

2591 
key
.
off£t
 = 
¡¬t
;

2592 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, (*
ex‹Á
));

2593 ià(
»t
)

2594 
out
;

2596 
Ëaf
 = 
·th
->
nodes
[0];

2597 
ex‹Á
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_dev_ex‹Á
);

2598 
	`bŒfs_£t_dev_ex‹Á_chunk_Œ“
(
Ëaf
, 
ex‹Á
, 
BTRFS_CHUNK_TREE_OBJECTID
);

2599 
	`bŒfs_£t_dev_ex‹Á_chunk_objeùid
(
Ëaf
, 
ex‹Á
,

2600 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
);

2601 
	`bŒfs_£t_dev_ex‹Á_chunk_off£t
(
Ëaf
, 
ex‹Á
, 
chunk_off£t
);

2603 
	`bŒfs_£t_dev_ex‹Á_Ëngth
(
Ëaf
, 
ex‹Á
, 
num_by‹s
);

2604 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

2605 
out
:

2606 
	`bŒfs_ä“_·th
(
·th
);

2607  
»t
;

2608 
	}
}

2616 
	$š£¹_dev_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2617 
u64
 
chunk_off£t
, u64 
chunk_size
)

2619 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2620 
bŒfs_deviû
 *
deviû
;

2621 
ex‹Á_m­
 *
em
;

2622 
m­_lookup
 *
m­
;

2623 
u64
 
dev_off£t
;

2624 
u64
 
¡re_size
;

2625 
i
;

2626 
»t
 = 0;

2628 
em
 = 
	`bŒfs_g‘_chunk_m­
(
fs_šfo
, 
chunk_off£t
, 
chunk_size
);

2629 ià(
	`IS_ERR
(
em
))

2630  
	`PTR_ERR
(
em
);

2632 
m­
 = 
em
->
m­_lookup
;

2633 
¡re_size
 = 
em
->
Üig_block_Ën
;

2644 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2645 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

2646 
deviû
 = 
m­
->
¡res
[
i
].
dev
;

2647 
dev_off£t
 = 
m­
->
¡res
[
i
].
physiÿl
;

2649 
»t
 = 
	`š£¹_dev_ex‹Á
(
Œªs
, 
deviû
, 
chunk_off£t
, 
dev_off£t
,

2650 
¡re_size
);

2651 ià(
»t
)

2654 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2656 
	`ä“_ex‹Á_m­
(
em
);

2657  
»t
;

2658 
	}
}

2667 
	$bŒfs_ü—‹_³ndšg_block_groups
(
bŒfs_Œªs_hªdË
 *
Œªs
)

2669 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2670 
bŒfs_block_group
 *
block_group
;

2671 
»t
 = 0;

2673 !
	`li¡_em±y
(&
Œªs
->
Ãw_bgs
)) {

2674 
šdex
;

2676 
block_group
 = 
	`li¡_fœ¡_’Œy
(&
Œªs
->
Ãw_bgs
,

2677 
bŒfs_block_group
,

2678 
bg_li¡
);

2679 ià(
»t
)

2680 
Ãxt
;

2682 
šdex
 = 
	`bŒfs_bg_æags_to_¿id_šdex
(
block_group
->
æags
);

2684 
»t
 = 
	`š£¹_block_group_™em
(
Œªs
, 
block_group
);

2685 ià(
»t
)

2686 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2687 ià(!
	`‹¡_b™
(
BLOCK_GROUP_FLAG_CHUNK_ITEM_INSERTED
,

2688 &
block_group
->
ruÁime_æags
)) {

2689 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

2690 
»t
 = 
	`bŒfs_chunk_®loc_add_chunk_™em
(
Œªs
, 
block_group
);

2691 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

2692 ià(
»t
)

2693 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2695 
»t
 = 
	`š£¹_dev_ex‹Ás
(
Œªs
, 
block_group
->
¡¬t
,

2696 
block_group
->
Ëngth
);

2697 ià(
»t
)

2698 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2699 
	`add_block_group_ä“_¥aû
(
Œªs
, 
block_group
);

2707 ià(
block_group
->
¥aû_šfo
->
block_group_kobjs
[
šdex
] =ğ
NULL
)

2708 
	`bŒfs_sysfs_add_block_group_ty³
(
block_group
);

2711 
Ãxt
:

2712 
	`bŒfs_d–ayed_»fs_rsv_»Ëa£
(
fs_šfo
, 1);

2713 
	`li¡_d–_š™
(&
block_group
->
bg_li¡
);

2714 
	`ş—r_b™
(
BLOCK_GROUP_FLAG_NEW
, &
block_group
->
ruÁime_æags
);

2716 
	`bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
Œªs
);

2717 
	}
}

2723 
u64
 
	$ÿlcuÏ‹_glob®_roÙ_id
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
off£t
)

2725 
u64
 
div
 = 
SZ_1G
;

2726 
u64
 
šdex
;

2728 ià(!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
EXTENT_TREE_V2
))

2729  
BTRFS_FIRST_CHUNK_TREE_OBJECTID
;

2732 ià(
	`bŒfs_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cİy
è<ğ(
SZ_1G
 * 10ULL))

2733 
div
 = 
SZ_128M
;

2735 
off£t
 = 
	`div64_u64
(off£t, 
div
);

2736 
	`div64_u64_»m
(
off£t
, 
fs_šfo
->
Ä_glob®_roÙs
, &
šdex
);

2737  
šdex
;

2738 
	}
}

2740 
bŒfs_block_group
 *
	$bŒfs_make_block_group
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2741 
u64
 
ty³
,

2742 
u64
 
chunk_off£t
, u64 
size
)

2744 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2745 
bŒfs_block_group
 *
ÿche
;

2746 
»t
;

2748 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

2750 
ÿche
 = 
	`bŒfs_ü—‹_block_group_ÿche
(
fs_šfo
, 
chunk_off£t
);

2751 ià(!
ÿche
)

2752  
	`ERR_PTR
(-
ENOMEM
);

2759 
	`£t_b™
(
BLOCK_GROUP_FLAG_NEW
, &
ÿche
->
ruÁime_æags
);

2761 
ÿche
->
Ëngth
 = 
size
;

2762 
	`£t_ä“_¥aû_Œ“_th»shŞds
(
ÿche
);

2763 
ÿche
->
æags
 = 
ty³
;

2764 
ÿche
->
ÿched
 = 
BTRFS_CACHE_FINISHED
;

2765 
ÿche
->
glob®_roÙ_id
 = 
	`ÿlcuÏ‹_glob®_roÙ_id
(
fs_šfo
, cache->
¡¬t
);

2767 ià(
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
))

2768 
	`£t_b™
(
BLOCK_GROUP_FLAG_NEEDS_FREE_SPACE
, &
ÿche
->
ruÁime_æags
);

2770 
»t
 = 
	`bŒfs_lßd_block_group_zÚe_šfo
(
ÿche
, 
Œue
);

2771 ià(
»t
) {

2772 
	`bŒfs_put_block_group
(
ÿche
);

2773  
	`ERR_PTR
(
»t
);

2776 
»t
 = 
	`exşude_su³r_¡res
(
ÿche
);

2777 ià(
»t
) {

2779 
	`bŒfs_ä“_exşuded_ex‹Ás
(
ÿche
);

2780 
	`bŒfs_put_block_group
(
ÿche
);

2781  
	`ERR_PTR
(
»t
);

2784 
»t
 = 
	`bŒfs_add_Ãw_ä“_¥aû
(
ÿche
, 
chunk_off£t
, chunk_off£ˆ+ 
size
, 
NULL
);

2785 
	`bŒfs_ä“_exşuded_ex‹Ás
(
ÿche
);

2786 ià(
»t
) {

2787 
	`bŒfs_put_block_group
(
ÿche
);

2788  
	`ERR_PTR
(
»t
);

2796 
ÿche
->
¥aû_šfo
 = 
	`bŒfs_fšd_¥aû_šfo
(
fs_šfo
, cache->
æags
);

2797 
	`ASSERT
(
ÿche
->
¥aû_šfo
);

2799 
»t
 = 
	`bŒfs_add_block_group_ÿche
(
fs_šfo
, 
ÿche
);

2800 ià(
»t
) {

2801 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

2802 
	`bŒfs_put_block_group
(
ÿche
);

2803  
	`ERR_PTR
(
»t
);

2810 
	`Œaû_bŒfs_add_block_group
(
fs_šfo
, 
ÿche
, 1);

2811 
	`bŒfs_add_bg_to_¥aû_šfo
(
fs_šfo
, 
ÿche
);

2812 
	`bŒfs_upd©e_glob®_block_rsv
(
fs_šfo
);

2814 #ifdeà
CONFIG_BTRFS_DEBUG


2815 ià(
	`bŒfs_should_äagm’t_ä“_¥aû
(
ÿche
)) {

2816 
ÿche
->
¥aû_šfo
->
by‹s_u£d
 +ğ
size
 >> 1;

2817 
	`äagm’t_ä“_¥aû
(
ÿche
);

2821 
	`li¡_add_
(&
ÿche
->
bg_li¡
, &
Œªs
->
Ãw_bgs
);

2822 
Œªs
->
d–ayed_»f_upd©es
++;

2823 
	`bŒfs_upd©e_d–ayed_»fs_rsv
(
Œªs
);

2825 
	`£t_ava_®loc_b™s
(
fs_šfo
, 
ty³
);

2826  
ÿche
;

2827 
	}
}

2838 
	$bŒfs_šc_block_group_ro
(
bŒfs_block_group
 *
ÿche
,

2839 
boŞ
 
do_chunk_®loc
)

2841 
bŒfs_fs_šfo
 *
fs_šfo
 = 
ÿche
->fs_info;

2842 
bŒfs_Œªs_hªdË
 *
Œªs
;

2843 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_block_group_roÙ
(
fs_šfo
);

2844 
u64
 
®loc_æags
;

2845 
»t
;

2846 
boŞ
 
dœty_bg_ruÂšg
;

2854 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
)) {

2855 
	`mu‹x_lock
(&
fs_šfo
->
ro_block_group_mu‹x
);

2856 
»t
 = 
	`šc_block_group_ro
(
ÿche
, 0);

2857 
	`mu‹x_uÆock
(&
fs_šfo
->
ro_block_group_mu‹x
);

2858  
»t
;

2862 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

2863 ià(
	`IS_ERR
(
Œªs
))

2864  
	`PTR_ERR
(
Œªs
);

2866 
dœty_bg_ruÂšg
 = 
çl£
;

2873 
	`mu‹x_lock
(&
fs_šfo
->
ro_block_group_mu‹x
);

2874 ià(
	`‹¡_b™
(
BTRFS_TRANS_DIRTY_BG_RUN
, &
Œªs
->
Œª§ùiÚ
->
æags
)) {

2875 
u64
 
Œªsid
 = 
Œªs
->transid;

2877 
	`mu‹x_uÆock
(&
fs_šfo
->
ro_block_group_mu‹x
);

2878 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2880 
»t
 = 
	`bŒfs_wa™_fÜ_comm™
(
fs_šfo
, 
Œªsid
);

2881 ià(
»t
)

2882  
»t
;

2883 
dœty_bg_ruÂšg
 = 
Œue
;

2885 } 
dœty_bg_ruÂšg
);

2887 ià(
do_chunk_®loc
) {

2892 
®loc_æags
 = 
	`bŒfs_g‘_®loc_´ofe
(
fs_šfo
, 
ÿche
->
æags
);

2893 ià(
®loc_æags
 !ğ
ÿche
->
æags
) {

2894 
»t
 = 
	`bŒfs_chunk_®loc
(
Œªs
, 
®loc_æags
,

2895 
CHUNK_ALLOC_FORCE
);

2900 ià(
»t
 =ğ-
ENOSPC
)

2901 
»t
 = 0;

2902 ià(
»t
 < 0)

2903 
out
;

2907 
»t
 = 
	`šc_block_group_ro
(
ÿche
, 0);

2908 ià(!
»t
)

2909 
out
;

2910 ià(
»t
 =ğ-
ETXTBSY
)

2911 
uÆock_out
;

2918 ià(!
do_chunk_®loc
 && 
»t
 =ğ-
ENOSPC
 &&

2919 (
ÿche
->
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
))

2920 
uÆock_out
;

2922 
®loc_æags
 = 
	`bŒfs_g‘_®loc_´ofe
(
fs_šfo
, 
ÿche
->
¥aû_šfo
->
æags
);

2923 
»t
 = 
	`bŒfs_chunk_®loc
(
Œªs
, 
®loc_æags
, 
CHUNK_ALLOC_FORCE
);

2924 ià(
»t
 < 0)

2925 
out
;

2930 
»t
 = 
	`bŒfs_zÚed_aùiv©e_Úe_bg
(
fs_šfo
, 
ÿche
->
¥aû_šfo
, 
Œue
);

2931 ià(
»t
 < 0)

2932 
out
;

2934 
»t
 = 
	`šc_block_group_ro
(
ÿche
, 0);

2935 ià(
»t
 =ğ-
ETXTBSY
)

2936 
uÆock_out
;

2937 
out
:

2938 ià(
ÿche
->
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) {

2939 
®loc_æags
 = 
	`bŒfs_g‘_®loc_´ofe
(
fs_šfo
, 
ÿche
->
æags
);

2940 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

2941 
	`check_sy¡em_chunk
(
Œªs
, 
®loc_æags
);

2942 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

2944 
uÆock_out
:

2945 
	`mu‹x_uÆock
(&
fs_šfo
->
ro_block_group_mu‹x
);

2947 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2948  
»t
;

2949 
	}
}

2951 
	$bŒfs_dec_block_group_ro
(
bŒfs_block_group
 *
ÿche
)

2953 
bŒfs_¥aû_šfo
 *
sšfo
 = 
ÿche
->
¥aû_šfo
;

2954 
u64
 
num_by‹s
;

2956 
	`BUG_ON
(!
ÿche
->
ro
);

2958 
	`¥š_lock
(&
sšfo
->
lock
);

2959 
	`¥š_lock
(&
ÿche
->
lock
);

2960 ià(!--
ÿche
->
ro
) {

2961 ià(
	`bŒfs_is_zÚed
(
ÿche
->
fs_šfo
)) {

2963 
ÿche
->
zÚe_unu§bË
 =

2964 (
ÿche
->
®loc_off£t
 - cache->
u£d
) +

2965 (
ÿche
->
Ëngth
 - cache->
zÚe_ÿ·c™y
);

2966 
sšfo
->
by‹s_zÚe_unu§bË
 +ğ
ÿche
->
zÚe_unu§bË
;

2967 
sšfo
->
by‹s_»adÚly
 -ğ
ÿche
->
zÚe_unu§bË
;

2969 
num_by‹s
 = 
ÿche
->
Ëngth
 - cache->
»£rved
 -

2970 
ÿche
->
pšÃd
 - cache->
by‹s_su³r
 -

2971 
ÿche
->
zÚe_unu§bË
 - cache->
u£d
;

2972 
sšfo
->
by‹s_»adÚly
 -ğ
num_by‹s
;

2973 
	`li¡_d–_š™
(&
ÿche
->
ro_li¡
);

2975 
	`¥š_uÆock
(&
ÿche
->
lock
);

2976 
	`¥š_uÆock
(&
sšfo
->
lock
);

2977 
	}
}

2979 
	$upd©e_block_group_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2980 
bŒfs_·th
 *
·th
,

2981 
bŒfs_block_group
 *
ÿche
)

2983 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2984 
»t
;

2985 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_block_group_roÙ
(
fs_šfo
);

2986 
bi
;

2987 
ex‹Á_bufãr
 *
Ëaf
;

2988 
bŒfs_block_group_™em
 
bgi
;

2989 
bŒfs_key
 
key
;

2990 
u64
 
Şd_comm™_u£d
;

2991 
u64
 
u£d
;

2999 
	`¥š_lock
(&
ÿche
->
lock
);

3000 
Şd_comm™_u£d
 = 
ÿche
->
comm™_u£d
;

3001 
u£d
 = 
ÿche
->used;

3003 ià(
ÿche
->
comm™_u£d
 =ğ
u£d
) {

3004 
	`¥š_uÆock
(&
ÿche
->
lock
);

3007 
ÿche
->
comm™_u£d
 = 
u£d
;

3008 
	`¥š_uÆock
(&
ÿche
->
lock
);

3010 
key
.
objeùid
 = 
ÿche
->
¡¬t
;

3011 
key
.
ty³
 = 
BTRFS_BLOCK_GROUP_ITEM_KEY
;

3012 
key
.
off£t
 = 
ÿche
->
Ëngth
;

3014 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

3015 ià(
»t
) {

3016 ià(
»t
 > 0)

3017 
»t
 = -
ENOENT
;

3018 
ç
;

3021 
Ëaf
 = 
·th
->
nodes
[0];

3022 
bi
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

3023 
	`bŒfs_£t_¡ack_block_group_u£d
(&
bgi
, 
u£d
);

3024 
	`bŒfs_£t_¡ack_block_group_chunk_objeùid
(&
bgi
,

3025 
ÿche
->
glob®_roÙ_id
);

3026 
	`bŒfs_£t_¡ack_block_group_æags
(&
bgi
, 
ÿche
->
æags
);

3027 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, &
bgi
, 
bi
, (bgi));

3028 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

3029 
ç
:

3030 
	`bŒfs_»Ëa£_·th
(
·th
);

3040 ià(
»t
 < 0 &&„‘ !ğ-
ENOENT
) {

3041 
	`¥š_lock
(&
ÿche
->
lock
);

3042 
ÿche
->
comm™_u£d
 = 
Şd_comm™_u£d
;

3043 
	`¥š_uÆock
(&
ÿche
->
lock
);

3045  
»t
;

3047 
	}
}

3049 
	$ÿche_§ve_£tup
(
bŒfs_block_group
 *
block_group
,

3050 
bŒfs_Œªs_hªdË
 *
Œªs
,

3051 
bŒfs_·th
 *
·th
)

3053 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

3054 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

3055 
šode
 *šodğ
NULL
;

3056 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

3057 
u64
 
®loc_hšt
 = 0;

3058 
dcs
 = 
BTRFS_DC_ERROR
;

3059 
u64
 
ÿche_size
 = 0;

3060 
»Œ›s
 = 0;

3061 
»t
 = 0;

3063 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
SPACE_CACHE
))

3070 ià(
block_group
->
Ëngth
 < (100 * 
SZ_1M
)) {

3071 
	`¥š_lock
(&
block_group
->
lock
);

3072 
block_group
->
disk_ÿche_¡©e
 = 
BTRFS_DC_WRITTEN
;

3073 
	`¥š_uÆock
(&
block_group
->
lock
);

3077 ià(
	`TRANS_ABORTED
(
Œªs
))

3079 
agaš
:

3080 
šode
 = 
	`lookup_ä“_¥aû_šode
(
block_group
, 
·th
);

3081 ià(
	`IS_ERR
(
šode
è&& 
	`PTR_ERR
(šodeè!ğ-
ENOENT
) {

3082 
»t
 = 
	`PTR_ERR
(
šode
);

3083 
	`bŒfs_»Ëa£_·th
(
·th
);

3084 
out
;

3087 ià(
	`IS_ERR
(
šode
)) {

3088 
	`BUG_ON
(
»Œ›s
);

3089 
»Œ›s
++;

3091 ià(
block_group
->
ro
)

3092 
out_ä“
;

3094 
»t
 = 
	`ü—‹_ä“_¥aû_šode
(
Œªs
, 
block_group
, 
·th
);

3095 ià(
»t
)

3096 
out_ä“
;

3097 
agaš
;

3105 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 0;

3106 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

3107 ià(
»t
) {

3118 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3119 
out_put
;

3121 
	`WARN_ON
(
»t
);

3124 ià(
block_group
->
ÿche_g’”©iÚ
 =ğ
Œªs
->
Œªsid
 &&

3125 
	`i_size_»ad
(
šode
)) {

3126 
dcs
 = 
BTRFS_DC_SETUP
;

3127 
out_put
;

3130 ià(
	`i_size_»ad
(
šode
) > 0) {

3131 
»t
 = 
	`bŒfs_check_Œunc_ÿche_ä“_¥aû
(
fs_šfo
,

3132 &
fs_šfo
->
glob®_block_rsv
);

3133 ià(
»t
)

3134 
out_put
;

3136 
»t
 = 
	`bŒfs_Œunÿ‹_ä“_¥aû_ÿche
(
Œªs
, 
NULL
, 
šode
);

3137 ià(
»t
)

3138 
out_put
;

3141 
	`¥š_lock
(&
block_group
->
lock
);

3142 ià(
block_group
->
ÿched
 !ğ
BTRFS_CACHE_FINISHED
 ||

3143 !
	`bŒfs_‹¡_İt
(
fs_šfo
, 
SPACE_CACHE
)) {

3150 
dcs
 = 
BTRFS_DC_WRITTEN
;

3151 
	`¥š_uÆock
(&
block_group
->
lock
);

3152 
out_put
;

3154 
	`¥š_uÆock
(&
block_group
->
lock
);

3160 ià(
	`‹¡_b™
(
BTRFS_TRANS_CACHE_ENOSPC
, &
Œªs
->
Œª§ùiÚ
->
æags
)) {

3161 
»t
 = -
ENOSPC
;

3162 
out_put
;

3171 
ÿche_size
 = 
	`div_u64
(
block_group
->
Ëngth
, 
SZ_256M
);

3172 ià(!
ÿche_size
)

3173 
ÿche_size
 = 1;

3175 
ÿche_size
 *= 16;

3176 
ÿche_size
 *ğ
fs_šfo
->
£ùÜsize
;

3178 
»t
 = 
	`bŒfs_check_d©a_ä“_¥aû
(
	`BTRFS_I
(
šode
), &
d©a_»£rved
, 0,

3179 
ÿche_size
, 
çl£
);

3180 ià(
»t
)

3181 
out_put
;

3183 
»t
 = 
	`bŒfs_´—Îoc_fe_¿nge_Œªs
(
šode
, 
Œªs
, 0, 0, 
ÿche_size
,

3184 
ÿche_size
, cache_size,

3185 &
®loc_hšt
);

3194 ià(!
»t
)

3195 
dcs
 = 
BTRFS_DC_SETUP
;

3196 ià(
»t
 =ğ-
ENOSPC
)

3197 
	`£t_b™
(
BTRFS_TRANS_CACHE_ENOSPC
, &
Œªs
->
Œª§ùiÚ
->
æags
);

3199 
out_put
:

3200 
	`ut
(
šode
);

3201 
out_ä“
:

3202 
	`bŒfs_»Ëa£_·th
(
·th
);

3203 
out
:

3204 
	`¥š_lock
(&
block_group
->
lock
);

3205 ià(!
»t
 && 
dcs
 =ğ
BTRFS_DC_SETUP
)

3206 
block_group
->
ÿche_g’”©iÚ
 = 
Œªs
->
Œªsid
;

3207 
block_group
->
disk_ÿche_¡©e
 = 
dcs
;

3208 
	`¥š_uÆock
(&
block_group
->
lock
);

3210 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

3211  
»t
;

3212 
	}
}

3214 
	$bŒfs_£tup_¥aû_ÿche
(
bŒfs_Œªs_hªdË
 *
Œªs
)

3216 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

3217 
bŒfs_block_group
 *
ÿche
, *
tmp
;

3218 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

3219 
bŒfs_·th
 *
·th
;

3221 ià(
	`li¡_em±y
(&
cur_Œªs
->
dœty_bgs
) ||

3222 !
	`bŒfs_‹¡_İt
(
fs_šfo
, 
SPACE_CACHE
))

3225 
·th
 = 
	`bŒfs_®loc_·th
();

3226 ià(!
·th
)

3227  -
ENOMEM
;

3230 
	`li¡_fÜ_—ch_’Œy_§ã
(
ÿche
, 
tmp
, &
cur_Œªs
->
dœty_bgs
,

3231 
dœty_li¡
) {

3232 ià(
ÿche
->
disk_ÿche_¡©e
 =ğ
BTRFS_DC_CLEAR
)

3233 
	`ÿche_§ve_£tup
(
ÿche
, 
Œªs
, 
·th
);

3236 
	`bŒfs_ä“_·th
(
·th
);

3238 
	}
}

3252 
	$bŒfs_¡¬t_dœty_block_groups
(
bŒfs_Œªs_hªdË
 *
Œªs
)

3254 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

3255 
bŒfs_block_group
 *
ÿche
;

3256 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

3257 
»t
 = 0;

3258 
should_put
;

3259 
bŒfs_·th
 *
·th
 = 
NULL
;

3260 
	`LIST_HEAD
(
dœty
);

3261 
li¡_h—d
 *
io
 = &
cur_Œªs
->
io_bgs
;

3262 
loİs
 = 0;

3264 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

3265 ià(
	`li¡_em±y
(&
cur_Œªs
->
dœty_bgs
)) {

3266 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3269 
	`li¡_¥liû_š™
(&
cur_Œªs
->
dœty_bgs
, &
dœty
);

3270 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3272 
agaš
:

3274 
	`bŒfs_ü—‹_³ndšg_block_groups
(
Œªs
);

3276 ià(!
·th
) {

3277 
·th
 = 
	`bŒfs_®loc_·th
();

3278 ià(!
·th
) {

3279 
»t
 = -
ENOMEM
;

3280 
out
;

3289 
	`mu‹x_lock
(&
Œªs
->
Œª§ùiÚ
->
ÿche_wr™e_mu‹x
);

3290 !
	`li¡_em±y
(&
dœty
)) {

3291 
boŞ
 
drİ_»£rve
 = 
Œue
;

3293 
ÿche
 = 
	`li¡_fœ¡_’Œy
(&
dœty
, 
bŒfs_block_group
,

3294 
dœty_li¡
);

3300 ià(!
	`li¡_em±y
(&
ÿche
->
io_li¡
)) {

3301 
	`li¡_d–_š™
(&
ÿche
->
io_li¡
);

3302 
	`bŒfs_wa™_ÿche_io
(
Œªs
, 
ÿche
, 
·th
);

3303 
	`bŒfs_put_block_group
(
ÿche
);

3315 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

3316 
	`li¡_d–_š™
(&
ÿche
->
dœty_li¡
);

3317 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3319 
should_put
 = 1;

3321 
	`ÿche_§ve_£tup
(
ÿche
, 
Œªs
, 
·th
);

3323 ià(
ÿche
->
disk_ÿche_¡©e
 =ğ
BTRFS_DC_SETUP
) {

3324 
ÿche
->
io_ùl
.
šode
 = 
NULL
;

3325 
»t
 = 
	`bŒfs_wr™e_out_ÿche
(
Œªs
, 
ÿche
, 
·th
);

3326 ià(
»t
 =ğ0 && 
ÿche
->
io_ùl
.
šode
) {

3327 
should_put
 = 0;

3334 
	`li¡_add_
(&
ÿche
->
io_li¡
, 
io
);

3340 
»t
 = 0;

3343 ià(!
»t
) {

3344 
»t
 = 
	`upd©e_block_group_™em
(
Œªs
, 
·th
, 
ÿche
);

3354 ià(
»t
 =ğ-
ENOENT
) {

3355 
»t
 = 0;

3356 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

3357 ià(
	`li¡_em±y
(&
ÿche
->
dœty_li¡
)) {

3358 
	`li¡_add_
(&
ÿche
->
dœty_li¡
,

3359 &
cur_Œªs
->
dœty_bgs
);

3360 
	`bŒfs_g‘_block_group
(
ÿche
);

3361 
drİ_»£rve
 = 
çl£
;

3363 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3364 } ià(
»t
) {

3365 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3370 ià(
should_put
)

3371 
	`bŒfs_put_block_group
(
ÿche
);

3372 ià(
drİ_»£rve
)

3373 
	`bŒfs_d–ayed_»fs_rsv_»Ëa£
(
fs_šfo
, 1);

3379 
	`mu‹x_uÆock
(&
Œªs
->
Œª§ùiÚ
->
ÿche_wr™e_mu‹x
);

3380 ià(
»t
)

3381 
out
;

3382 
	`mu‹x_lock
(&
Œªs
->
Œª§ùiÚ
->
ÿche_wr™e_mu‹x
);

3384 
	`mu‹x_uÆock
(&
Œªs
->
Œª§ùiÚ
->
ÿche_wr™e_mu‹x
);

3390 ià(!
»t
)

3391 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 0);

3392 ià(!
»t
 && 
loİs
 == 0) {

3393 
loİs
++;

3394 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

3395 
	`li¡_¥liû_š™
(&
cur_Œªs
->
dœty_bgs
, &
dœty
);

3400 ià(!
	`li¡_em±y
(&
dœty
)) {

3401 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3402 
agaš
;

3404 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3406 
out
:

3407 ià(
»t
 < 0) {

3408 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

3409 
	`li¡_¥liû_š™
(&
dœty
, &
cur_Œªs
->
dœty_bgs
);

3410 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3411 
	`bŒfs_ş—nup_dœty_bgs
(
cur_Œªs
, 
fs_šfo
);

3414 
	`bŒfs_ä“_·th
(
·th
);

3415  
»t
;

3416 
	}
}

3418 
	$bŒfs_wr™e_dœty_block_groups
(
bŒfs_Œªs_hªdË
 *
Œªs
)

3420 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

3421 
bŒfs_block_group
 *
ÿche
;

3422 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

3423 
»t
 = 0;

3424 
should_put
;

3425 
bŒfs_·th
 *
·th
;

3426 
li¡_h—d
 *
io
 = &
cur_Œªs
->
io_bgs
;

3428 
·th
 = 
	`bŒfs_®loc_·th
();

3429 ià(!
·th
)

3430  -
ENOMEM
;

3447 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

3448 !
	`li¡_em±y
(&
cur_Œªs
->
dœty_bgs
)) {

3449 
ÿche
 = 
	`li¡_fœ¡_’Œy
(&
cur_Œªs
->
dœty_bgs
,

3450 
bŒfs_block_group
,

3451 
dœty_li¡
);

3458 ià(!
	`li¡_em±y
(&
ÿche
->
io_li¡
)) {

3459 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3460 
	`li¡_d–_š™
(&
ÿche
->
io_li¡
);

3461 
	`bŒfs_wa™_ÿche_io
(
Œªs
, 
ÿche
, 
·th
);

3462 
	`bŒfs_put_block_group
(
ÿche
);

3463 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

3470 
	`li¡_d–_š™
(&
ÿche
->
dœty_li¡
);

3471 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3472 
should_put
 = 1;

3474 
	`ÿche_§ve_£tup
(
ÿche
, 
Œªs
, 
·th
);

3476 ià(!
»t
)

3477 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
,

3480 ià(!
»t
 && 
ÿche
->
disk_ÿche_¡©e
 =ğ
BTRFS_DC_SETUP
) {

3481 
ÿche
->
io_ùl
.
šode
 = 
NULL
;

3482 
»t
 = 
	`bŒfs_wr™e_out_ÿche
(
Œªs
, 
ÿche
, 
·th
);

3483 ià(
»t
 =ğ0 && 
ÿche
->
io_ùl
.
šode
) {

3484 
should_put
 = 0;

3485 
	`li¡_add_
(&
ÿche
->
io_li¡
, 
io
);

3491 
»t
 = 0;

3494 ià(!
»t
) {

3495 
»t
 = 
	`upd©e_block_group_™em
(
Œªs
, 
·th
, 
ÿche
);

3509 ià(
»t
 =ğ-
ENOENT
) {

3510 
	`wa™_ev’t
(
cur_Œªs
->
wr™”_wa™
,

3511 
	`©omic_»ad
(&
cur_Œªs
->
num_wr™”s
) == 1);

3512 
»t
 = 
	`upd©e_block_group_™em
(
Œªs
, 
·th
, 
ÿche
);

3514 ià(
»t
)

3515 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3519 ià(
should_put
)

3520 
	`bŒfs_put_block_group
(
ÿche
);

3521 
	`bŒfs_d–ayed_»fs_rsv_»Ëa£
(
fs_šfo
, 1);

3522 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

3524 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3530 !
	`li¡_em±y
(
io
)) {

3531 
ÿche
 = 
	`li¡_fœ¡_’Œy
(
io
, 
bŒfs_block_group
,

3532 
io_li¡
);

3533 
	`li¡_d–_š™
(&
ÿche
->
io_li¡
);

3534 
	`bŒfs_wa™_ÿche_io
(
Œªs
, 
ÿche
, 
·th
);

3535 
	`bŒfs_put_block_group
(
ÿche
);

3538 
	`bŒfs_ä“_·th
(
·th
);

3539  
»t
;

3540 
	}
}

3542 
	$bŒfs_upd©e_block_group
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3543 
u64
 
by‹Ä
, u64 
num_by‹s
, 
boŞ
 
®loc
)

3545 
bŒfs_fs_šfo
 *
šfo
 = 
Œªs
->
fs_šfo
;

3546 
bŒfs_block_group
 *
ÿche
 = 
NULL
;

3547 
u64
 
tÙ®
 = 
num_by‹s
;

3548 
u64
 
Şd_v®
;

3549 
u64
 
by‹_š_group
;

3550 
çùÜ
;

3551 
»t
 = 0;

3554 
	`¥š_lock
(&
šfo
->
d–®loc_roÙ_lock
);

3555 
Şd_v®
 = 
	`bŒfs_su³r_by‹s_u£d
(
šfo
->
su³r_cİy
);

3556 ià(
®loc
)

3557 
Şd_v®
 +ğ
num_by‹s
;

3559 
Şd_v®
 -ğ
num_by‹s
;

3560 
	`bŒfs_£t_su³r_by‹s_u£d
(
šfo
->
su³r_cİy
, 
Şd_v®
);

3561 
	`¥š_uÆock
(&
šfo
->
d–®loc_roÙ_lock
);

3563 
tÙ®
) {

3564 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

3565 
boŞ
 
»şaim
 = 
çl£
;

3567 
ÿche
 = 
	`bŒfs_lookup_block_group
(
šfo
, 
by‹Ä
);

3568 ià(!
ÿche
) {

3569 
»t
 = -
ENOENT
;

3572 
¥aû_šfo
 = 
ÿche
->space_info;

3573 
çùÜ
 = 
	`bŒfs_bg_ty³_to_çùÜ
(
ÿche
->
æags
);

3581 ià(!
®loc
 && !
	`bŒfs_block_group_dÚe
(
ÿche
))

3582 
	`bŒfs_ÿche_block_group
(
ÿche
, 
Œue
);

3584 
by‹_š_group
 = 
by‹Ä
 - 
ÿche
->
¡¬t
;

3585 
	`WARN_ON
(
by‹_š_group
 > 
ÿche
->
Ëngth
);

3587 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

3588 
	`¥š_lock
(&
ÿche
->
lock
);

3590 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
SPACE_CACHE
) &&

3591 
ÿche
->
disk_ÿche_¡©e
 < 
BTRFS_DC_CLEAR
)

3592 
ÿche
->
disk_ÿche_¡©e
 = 
BTRFS_DC_CLEAR
;

3594 
Şd_v®
 = 
ÿche
->
u£d
;

3595 
num_by‹s
 = 
	`mš
(
tÙ®
, 
ÿche
->
Ëngth
 - 
by‹_š_group
);

3596 ià(
®loc
) {

3597 
Şd_v®
 +ğ
num_by‹s
;

3598 
ÿche
->
u£d
 = 
Şd_v®
;

3599 
ÿche
->
»£rved
 -ğ
num_by‹s
;

3600 
¥aû_šfo
->
by‹s_»£rved
 -ğ
num_by‹s
;

3601 
¥aû_šfo
->
by‹s_u£d
 +ğ
num_by‹s
;

3602 
¥aû_šfo
->
disk_u£d
 +ğ
num_by‹s
 * 
çùÜ
;

3603 
	`¥š_uÆock
(&
ÿche
->
lock
);

3604 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

3606 
Şd_v®
 -ğ
num_by‹s
;

3607 
ÿche
->
u£d
 = 
Şd_v®
;

3608 
ÿche
->
pšÃd
 +ğ
num_by‹s
;

3609 
	`bŒfs_¥aû_šfo_upd©e_by‹s_pšÃd
(
šfo
, 
¥aû_šfo
,

3610 
num_by‹s
);

3611 
¥aû_šfo
->
by‹s_u£d
 -ğ
num_by‹s
;

3612 
¥aû_šfo
->
disk_u£d
 -ğ
num_by‹s
 * 
çùÜ
;

3614 
»şaim
 = 
	`should_»şaim_block_group
(
ÿche
, 
num_by‹s
);

3616 
	`¥š_uÆock
(&
ÿche
->
lock
);

3617 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

3619 
	`£t_ex‹Á_b™
(&
Œªs
->
Œª§ùiÚ
->
pšÃd_ex‹Ás
,

3620 
by‹Ä
, by‹Ä + 
num_by‹s
 - 1,

3621 
EXTENT_DIRTY
, 
NULL
);

3624 
	`¥š_lock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

3625 ià(
	`li¡_em±y
(&
ÿche
->
dœty_li¡
)) {

3626 
	`li¡_add_
(&
ÿche
->
dœty_li¡
,

3627 &
Œªs
->
Œª§ùiÚ
->
dœty_bgs
);

3628 
Œªs
->
d–ayed_»f_upd©es
++;

3629 
	`bŒfs_g‘_block_group
(
ÿche
);

3631 
	`¥š_uÆock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

3639 ià(!
®loc
 && 
Şd_v®
 == 0) {

3640 ià(!
	`bŒfs_‹¡_İt
(
šfo
, 
DISCARD_ASYNC
))

3641 
	`bŒfs_m¬k_bg_unu£d
(
ÿche
);

3642 } ià(!
®loc
 && 
»şaim
) {

3643 
	`bŒfs_m¬k_bg_to_»şaim
(
ÿche
);

3646 
	`bŒfs_put_block_group
(
ÿche
);

3647 
tÙ®
 -ğ
num_by‹s
;

3648 
by‹Ä
 +ğ
num_by‹s
;

3652 
	`bŒfs_upd©e_d–ayed_»fs_rsv
(
Œªs
);

3653  
»t
;

3654 
	}
}

3669 
	$bŒfs_add_»£rved_by‹s
(
bŒfs_block_group
 *
ÿche
,

3670 
u64
 
¿m_by‹s
, u64 
num_by‹s
, 
d–®loc
,

3671 
boŞ
 
fÜû_wrÚg_size_şass
)

3673 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
ÿche
->space_info;

3674 
bŒfs_block_group_size_şass
 
size_şass
;

3675 
»t
 = 0;

3677 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

3678 
	`¥š_lock
(&
ÿche
->
lock
);

3679 ià(
ÿche
->
ro
) {

3680 
»t
 = -
EAGAIN
;

3681 
out
;

3684 ià(
	`bŒfs_block_group_should_u£_size_şass
(
ÿche
)) {

3685 
size_şass
 = 
	`bŒfs_ÿlc_block_group_size_şass
(
num_by‹s
);

3686 
»t
 = 
	`bŒfs_u£_block_group_size_şass
(
ÿche
, 
size_şass
, 
fÜû_wrÚg_size_şass
);

3687 ià(
»t
)

3688 
out
;

3690 
ÿche
->
»£rved
 +ğ
num_by‹s
;

3691 
¥aû_šfo
->
by‹s_»£rved
 +ğ
num_by‹s
;

3692 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
ÿche
->
fs_šfo
, "space_info",

3693 
¥aû_šfo
->
æags
, 
num_by‹s
, 1);

3694 
	`bŒfs_¥aû_šfo_upd©e_by‹s_may_u£
(
ÿche
->
fs_šfo
,

3695 
¥aû_šfo
, -
¿m_by‹s
);

3696 ià(
d–®loc
)

3697 
ÿche
->
d–®loc_by‹s
 +ğ
num_by‹s
;

3703 ià(
num_by‹s
 < 
¿m_by‹s
)

3704 
	`bŒfs_Œy_g¿Ášg_tick‘s
(
ÿche
->
fs_šfo
, 
¥aû_šfo
);

3705 
out
:

3706 
	`¥š_uÆock
(&
ÿche
->
lock
);

3707 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

3708  
»t
;

3709 
	}
}

3723 
	$bŒfs_ä“_»£rved_by‹s
(
bŒfs_block_group
 *
ÿche
,

3724 
u64
 
num_by‹s
, 
d–®loc
)

3726 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
ÿche
->space_info;

3728 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

3729 
	`¥š_lock
(&
ÿche
->
lock
);

3730 ià(
ÿche
->
ro
)

3731 
¥aû_šfo
->
by‹s_»adÚly
 +ğ
num_by‹s
;

3732 
ÿche
->
»£rved
 -ğ
num_by‹s
;

3733 
¥aû_šfo
->
by‹s_»£rved
 -ğ
num_by‹s
;

3734 
¥aû_šfo
->
max_ex‹Á_size
 = 0;

3736 ià(
d–®loc
)

3737 
ÿche
->
d–®loc_by‹s
 -ğ
num_by‹s
;

3738 
	`¥š_uÆock
(&
ÿche
->
lock
);

3740 
	`bŒfs_Œy_g¿Ášg_tick‘s
(
ÿche
->
fs_šfo
, 
¥aû_šfo
);

3741 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

3742 
	}
}

3744 
	$fÜû_m‘ad©a_®loÿtiÚ
(
bŒfs_fs_šfo
 *
šfo
)

3746 
li¡_h—d
 *
h—d
 = &
šfo
->
¥aû_šfo
;

3747 
bŒfs_¥aû_šfo
 *
found
;

3749 
	`li¡_fÜ_—ch_’Œy
(
found
, 
h—d
, 
li¡
) {

3750 ià(
found
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
)

3751 
found
->
fÜû_®loc
 = 
CHUNK_ALLOC_FORCE
;

3753 
	}
}

3755 
	$should_®loc_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
,

3756 
bŒfs_¥aû_šfo
 *
sšfo
, 
fÜû
)

3758 
u64
 
by‹s_u£d
 = 
	`bŒfs_¥aû_šfo_u£d
(
sšfo
, 
çl£
);

3759 
u64
 
th»sh
;

3761 ià(
fÜû
 =ğ
CHUNK_ALLOC_FORCE
)

3768 ià(
fÜû
 =ğ
CHUNK_ALLOC_LIMITED
) {

3769 
th»sh
 = 
	`bŒfs_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cİy
);

3770 
th»sh
 = 
	`max_t
(
u64
, 
SZ_64M
, 
	`muÉ_³rc
(thresh, 1));

3772 ià(
sšfo
->
tÙ®_by‹s
 - 
by‹s_u£d
 < 
th»sh
)

3776 ià(
by‹s_u£d
 + 
SZ_2M
 < 
	`muÉ_³rc
(
sšfo
->
tÙ®_by‹s
, 80))

3779 
	}
}

3781 
	$bŒfs_fÜû_chunk_®loc
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
ty³
)

3783 
u64
 
®loc_æags
 = 
	`bŒfs_g‘_®loc_´ofe
(
Œªs
->
fs_šfo
, 
ty³
);

3785  
	`bŒfs_chunk_®loc
(
Œªs
, 
®loc_æags
, 
CHUNK_ALLOC_FORCE
);

3786 
	}
}

3788 
bŒfs_block_group
 *
	$do_chunk_®loc
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
æags
)

3790 
bŒfs_block_group
 *
bg
;

3791 
»t
;

3799 
	`check_sy¡em_chunk
(
Œªs
, 
æags
);

3801 
bg
 = 
	`bŒfs_ü—‹_chunk
(
Œªs
, 
æags
);

3802 ià(
	`IS_ERR
(
bg
)) {

3803 
»t
 = 
	`PTR_ERR
(
bg
);

3804 
out
;

3807 
»t
 = 
	`bŒfs_chunk_®loc_add_chunk_™em
(
Œªs
, 
bg
);

3846 ià(
»t
 =ğ-
ENOSPC
) {

3847 cÚ¡ 
u64
 
sys_æags
 = 
	`bŒfs_sy¡em_®loc_´ofe
(
Œªs
->
fs_šfo
);

3848 
bŒfs_block_group
 *
sys_bg
;

3850 
sys_bg
 = 
	`bŒfs_ü—‹_chunk
(
Œªs
, 
sys_æags
);

3851 ià(
	`IS_ERR
(
sys_bg
)) {

3852 
»t
 = 
	`PTR_ERR
(
sys_bg
);

3853 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3854 
out
;

3857 
»t
 = 
	`bŒfs_chunk_®loc_add_chunk_™em
(
Œªs
, 
sys_bg
);

3858 ià(
»t
) {

3859 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3860 
out
;

3863 
»t
 = 
	`bŒfs_chunk_®loc_add_chunk_™em
(
Œªs
, 
bg
);

3864 ià(
»t
) {

3865 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3866 
out
;

3868 } ià(
»t
) {

3869 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3870 
out
;

3872 
out
:

3873 
	`bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
Œªs
);

3875 ià(
»t
)

3876  
	`ERR_PTR
(
»t
);

3878 
	`bŒfs_g‘_block_group
(
bg
);

3879  
bg
;

3880 
	}
}

3989 
	$bŒfs_chunk_®loc
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
æags
,

3990 
bŒfs_chunk_®loc_’um
 
fÜû
)

3992 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

3993 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

3994 
bŒfs_block_group
 *
»t_bg
;

3995 
boŞ
 
wa™_fÜ_®loc
 = 
çl£
;

3996 
boŞ
 
should_®loc
 = 
çl£
;

3997 
boŞ
 
äom_ex‹Á_®loÿtiÚ
 = 
çl£
;

3998 
»t
 = 0;

4000 ià(
fÜû
 =ğ
CHUNK_ALLOC_FORCE_FOR_EXTENT
) {

4001 
äom_ex‹Á_®loÿtiÚ
 = 
Œue
;

4002 
fÜû
 = 
CHUNK_ALLOC_FORCE
;

4006 ià(
Œªs
->
®loÿtšg_chunk
)

4007  -
ENOSPC
;

4029 ià(
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

4030  -
ENOSPC
;

4032 
¥aû_šfo
 = 
	`bŒfs_fšd_¥aû_šfo
(
fs_šfo
, 
æags
);

4033 
	`ASSERT
(
¥aû_šfo
);

4036 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

4037 ià(
fÜû
 < 
¥aû_šfo
->
fÜû_®loc
)

4038 
fÜû
 = 
¥aû_šfo
->
fÜû_®loc
;

4039 
should_®loc
 = 
	`should_®loc_chunk
(
fs_šfo
, 
¥aû_šfo
, 
fÜû
);

4040 ià(
¥aû_šfo
->
fuÎ
) {

4042 ià(
should_®loc
)

4043 
»t
 = -
ENOSPC
;

4045 
»t
 = 0;

4046 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

4047  
»t
;

4048 } ià(!
should_®loc
) {

4049 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

4051 } ià(
¥aû_šfo
->
chunk_®loc
) {

4058 
wa™_fÜ_®loc
 = 
Œue
;

4059 
fÜû
 = 
CHUNK_ALLOC_NO_FORCE
;

4060 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

4061 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

4062 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

4065 
¥aû_šfo
->
chunk_®loc
 = 1;

4066 
wa™_fÜ_®loc
 = 
çl£
;

4067 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

4070 
	`cÚd_»sched
();

4071 } 
wa™_fÜ_®loc
);

4073 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

4074 
Œªs
->
®loÿtšg_chunk
 = 
Œue
;

4080 ià(
	`bŒfs_mixed_¥aû_šfo
(
¥aû_šfo
))

4081 
æags
 |ğ(
BTRFS_BLOCK_GROUP_DATA
 | 
BTRFS_BLOCK_GROUP_METADATA
);

4088 ià(
æags
 & 
BTRFS_BLOCK_GROUP_DATA
 && 
fs_šfo
->
m‘ad©a_¿tio
) {

4089 
fs_šfo
->
d©a_chunk_®loÿtiÚs
++;

4090 ià(!(
fs_šfo
->
d©a_chunk_®loÿtiÚs
 %

4091 
fs_šfo
->
m‘ad©a_¿tio
))

4092 
	`fÜû_m‘ad©a_®loÿtiÚ
(
fs_šfo
);

4095 
»t_bg
 = 
	`do_chunk_®loc
(
Œªs
, 
æags
);

4096 
Œªs
->
®loÿtšg_chunk
 = 
çl£
;

4098 ià(
	`IS_ERR
(
»t_bg
)) {

4099 
»t
 = 
	`PTR_ERR
(
»t_bg
);

4100 } ià(
äom_ex‹Á_®loÿtiÚ
 && (
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)) {

4105 
	`bŒfs_zÚe_aùiv©e
(
»t_bg
);

4108 ià(!
»t
)

4109 
	`bŒfs_put_block_group
(
»t_bg
);

4111 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

4112 ià(
»t
 < 0) {

4113 ià(
»t
 =ğ-
ENOSPC
)

4114 
¥aû_šfo
->
fuÎ
 = 1;

4116 
out
;

4118 
»t
 = 1;

4119 
¥aû_šfo
->
max_ex‹Á_size
 = 0;

4122 
¥aû_šfo
->
fÜû_®loc
 = 
CHUNK_ALLOC_NO_FORCE
;

4123 
out
:

4124 
¥aû_šfo
->
chunk_®loc
 = 0;

4125 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

4126 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

4128  
»t
;

4129 
	}
}

4131 
u64
 
	$g‘_´ofe_num_devs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
ty³
)

4133 
u64
 
num_dev
;

4135 
num_dev
 = 
bŒfs_¿id_¬¿y
[
	`bŒfs_bg_æags_to_¿id_šdex
(
ty³
)].
devs_max
;

4136 ià(!
num_dev
)

4137 
num_dev
 = 
fs_šfo
->
fs_deviûs
->
rw_deviûs
;

4139  
num_dev
;

4140 
	}
}

4142 
	$»£rve_chunk_¥aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4143 
u64
 
by‹s
,

4144 
u64
 
ty³
)

4146 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

4147 
bŒfs_¥aû_šfo
 *
šfo
;

4148 
u64
 
Ëá
;

4149 
»t
 = 0;

4155 
	`lockd•_as£¹_h–d
(&
fs_šfo
->
chunk_mu‹x
);

4157 
šfo
 = 
	`bŒfs_fšd_¥aû_šfo
(
fs_šfo
, 
BTRFS_BLOCK_GROUP_SYSTEM
);

4158 
	`¥š_lock
(&
šfo
->
lock
);

4159 
Ëá
 = 
šfo
->
tÙ®_by‹s
 - 
	`bŒfs_¥aû_šfo_u£d
(šfo, 
Œue
);

4160 
	`¥š_uÆock
(&
šfo
->
lock
);

4162 ià(
Ëá
 < 
by‹s
 && 
	`bŒfs_‹¡_İt
(
fs_šfo
, 
ENOSPC_DEBUG
)) {

4163 
	`bŒfs_šfo
(
fs_šfo
, "left=%llu,‚eed=%llu, flags=%llu",

4164 
Ëá
, 
by‹s
, 
ty³
);

4165 
	`bŒfs_dump_¥aû_šfo
(
fs_šfo
, 
šfo
, 0, 0);

4168 ià(
Ëá
 < 
by‹s
) {

4169 
u64
 
æags
 = 
	`bŒfs_sy¡em_®loc_´ofe
(
fs_šfo
);

4170 
bŒfs_block_group
 *
bg
;

4178 
bg
 = 
	`bŒfs_ü—‹_chunk
(
Œªs
, 
æags
);

4179 ià(
	`IS_ERR
(
bg
)) {

4180 
»t
 = 
	`PTR_ERR
(
bg
);

4186 
»t
 = 
	`bŒfs_zÚed_aùiv©e_Úe_bg
(
fs_šfo
, 
šfo
, 
Œue
);

4187 ià(
»t
 < 0)

4200 
	`bŒfs_chunk_®loc_add_chunk_™em
(
Œªs
, 
bg
);

4204 ià(!
»t
) {

4205 
»t
 = 
	`bŒfs_block_rsv_add
(
fs_šfo
,

4206 &
fs_šfo
->
chunk_block_rsv
,

4207 
by‹s
, 
BTRFS_RESERVE_NO_FLUSH
);

4208 ià(!
»t
)

4209 
Œªs
->
chunk_by‹s_»£rved
 +ğ
by‹s
;

4211 
	}
}

4217 
	$check_sy¡em_chunk
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
ty³
)

4219 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

4220 cÚ¡ 
u64
 
num_devs
 = 
	`g‘_´ofe_num_devs
(
fs_šfo
, 
ty³
);

4221 
u64
 
by‹s
;

4224 
by‹s
 = 
	`bŒfs_ÿlc_m‘ad©a_size
(
fs_šfo
, 
num_devs
) +

4225 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
, 1);

4227 
	`»£rve_chunk_¥aû
(
Œªs
, 
by‹s
, 
ty³
);

4228 
	}
}

4246 
	$bŒfs_»£rve_chunk_m‘ad©a
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4247 
boŞ
 
is_™em_š£¹iÚ
)

4249 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

4250 
u64
 
by‹s
;

4252 ià(
is_™em_š£¹iÚ
)

4253 
by‹s
 = 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
, 1);

4255 
by‹s
 = 
	`bŒfs_ÿlc_m‘ad©a_size
(
fs_šfo
, 1);

4257 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

4258 
	`»£rve_chunk_¥aû
(
Œªs
, 
by‹s
, 
BTRFS_BLOCK_GROUP_SYSTEM
);

4259 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

4260 
	}
}

4262 
	$bŒfs_put_block_group_ÿche
(
bŒfs_fs_šfo
 *
šfo
)

4264 
bŒfs_block_group
 *
block_group
;

4266 
block_group
 = 
	`bŒfs_lookup_fœ¡_block_group
(
šfo
, 0);

4267 
block_group
) {

4268 
	`bŒfs_wa™_block_group_ÿche_dÚe
(
block_group
);

4269 
	`¥š_lock
(&
block_group
->
lock
);

4270 ià(
	`‹¡_ªd_ş—r_b™
(
BLOCK_GROUP_FLAG_IREF
,

4271 &
block_group
->
ruÁime_æags
)) {

4272 
šode
 *šodğ
block_group
->inode;

4274 
block_group
->
šode
 = 
NULL
;

4275 
	`¥š_uÆock
(&
block_group
->
lock
);

4277 
	`ASSERT
(
block_group
->
io_ùl
.
šode
 =ğ
NULL
);

4278 
	`ut
(
šode
);

4280 
	`¥š_uÆock
(&
block_group
->
lock
);

4282 
block_group
 = 
	`bŒfs_Ãxt_block_group
(block_group);

4284 
	}
}

4291 
	$bŒfs_ä“_block_groups
(
bŒfs_fs_šfo
 *
šfo
)

4293 
bŒfs_block_group
 *
block_group
;

4294 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

4295 
bŒfs_ÿchšg_cÚŒŞ
 *
ÿchšg_ùl
;

4296 
rb_node
 *
n
;

4298 ià(
	`bŒfs_is_zÚed
(
šfo
)) {

4299 ià(
šfo
->
aùive_m‘a_bg
) {

4300 
	`bŒfs_put_block_group
(
šfo
->
aùive_m‘a_bg
);

4301 
šfo
->
aùive_m‘a_bg
 = 
NULL
;

4303 ià(
šfo
->
aùive_sy¡em_bg
) {

4304 
	`bŒfs_put_block_group
(
šfo
->
aùive_sy¡em_bg
);

4305 
šfo
->
aùive_sy¡em_bg
 = 
NULL
;

4309 
	`wr™e_lock
(&
šfo
->
block_group_ÿche_lock
);

4310 !
	`li¡_em±y
(&
šfo
->
ÿchšg_block_groups
)) {

4311 
ÿchšg_ùl
 = 
	`li¡_’Œy
(
šfo
->
ÿchšg_block_groups
.
Ãxt
,

4312 
bŒfs_ÿchšg_cÚŒŞ
, 
li¡
);

4313 
	`li¡_d–
(&
ÿchšg_ùl
->
li¡
);

4314 
	`bŒfs_put_ÿchšg_cÚŒŞ
(
ÿchšg_ùl
);

4316 
	`wr™e_uÆock
(&
šfo
->
block_group_ÿche_lock
);

4318 
	`¥š_lock
(&
šfo
->
unu£d_bgs_lock
);

4319 !
	`li¡_em±y
(&
šfo
->
unu£d_bgs
)) {

4320 
block_group
 = 
	`li¡_fœ¡_’Œy
(&
šfo
->
unu£d_bgs
,

4321 
bŒfs_block_group
,

4322 
bg_li¡
);

4323 
	`li¡_d–_š™
(&
block_group
->
bg_li¡
);

4324 
	`bŒfs_put_block_group
(
block_group
);

4327 !
	`li¡_em±y
(&
šfo
->
»şaim_bgs
)) {

4328 
block_group
 = 
	`li¡_fœ¡_’Œy
(&
šfo
->
»şaim_bgs
,

4329 
bŒfs_block_group
,

4330 
bg_li¡
);

4331 
	`li¡_d–_š™
(&
block_group
->
bg_li¡
);

4332 
	`bŒfs_put_block_group
(
block_group
);

4334 
	`¥š_uÆock
(&
šfo
->
unu£d_bgs_lock
);

4336 
	`¥š_lock
(&
šfo
->
zÚe_aùive_bgs_lock
);

4337 !
	`li¡_em±y
(&
šfo
->
zÚe_aùive_bgs
)) {

4338 
block_group
 = 
	`li¡_fœ¡_’Œy
(&
šfo
->
zÚe_aùive_bgs
,

4339 
bŒfs_block_group
,

4340 
aùive_bg_li¡
);

4341 
	`li¡_d–_š™
(&
block_group
->
aùive_bg_li¡
);

4342 
	`bŒfs_put_block_group
(
block_group
);

4344 
	`¥š_uÆock
(&
šfo
->
zÚe_aùive_bgs_lock
);

4346 
	`wr™e_lock
(&
šfo
->
block_group_ÿche_lock
);

4347 (
n
 = 
	`rb_Ï¡
(&
šfo
->
block_group_ÿche_Œ“
.
rb_roÙ
)è!ğ
NULL
) {

4348 
block_group
 = 
	`rb_’Œy
(
n
, 
bŒfs_block_group
,

4349 
ÿche_node
);

4350 
	`rb_”a£_ÿched
(&
block_group
->
ÿche_node
,

4351 &
šfo
->
block_group_ÿche_Œ“
);

4352 
	`RB_CLEAR_NODE
(&
block_group
->
ÿche_node
);

4353 
	`wr™e_uÆock
(&
šfo
->
block_group_ÿche_lock
);

4355 
	`down_wr™e
(&
block_group
->
¥aû_šfo
->
groups_£m
);

4356 
	`li¡_d–
(&
block_group
->
li¡
);

4357 
	`up_wr™e
(&
block_group
->
¥aû_šfo
->
groups_£m
);

4363 ià(
block_group
->
ÿched
 =ğ
BTRFS_CACHE_NO
 ||

4364 
block_group
->
ÿched
 =ğ
BTRFS_CACHE_ERROR
)

4365 
	`bŒfs_ä“_exşuded_ex‹Ás
(
block_group
);

4367 
	`bŒfs_»move_ä“_¥aû_ÿche
(
block_group
);

4368 
	`ASSERT
(
block_group
->
ÿched
 !ğ
BTRFS_CACHE_STARTED
);

4369 
	`ASSERT
(
	`li¡_em±y
(&
block_group
->
dœty_li¡
));

4370 
	`ASSERT
(
	`li¡_em±y
(&
block_group
->
io_li¡
));

4371 
	`ASSERT
(
	`li¡_em±y
(&
block_group
->
bg_li¡
));

4372 
	`ASSERT
(
	`»fcouÁ_»ad
(&
block_group
->
»fs
) == 1);

4373 
	`ASSERT
(
block_group
->
sw­_ex‹Ás
 == 0);

4374 
	`bŒfs_put_block_group
(
block_group
);

4376 
	`wr™e_lock
(&
šfo
->
block_group_ÿche_lock
);

4378 
	`wr™e_uÆock
(&
šfo
->
block_group_ÿche_lock
);

4380 
	`bŒfs_»Ëa£_glob®_block_rsv
(
šfo
);

4382 !
	`li¡_em±y
(&
šfo
->
¥aû_šfo
)) {

4383 
¥aû_šfo
 = 
	`li¡_’Œy
(
šfo
->¥aû_šfo.
Ãxt
,

4384 
bŒfs_¥aû_šfo
,

4385 
li¡
);

4391 ià(
	`WARN_ON
(
¥aû_šfo
->
by‹s_pšÃd
 > 0 ||

4392 
¥aû_šfo
->
by‹s_may_u£
 > 0))

4393 
	`bŒfs_dump_¥aû_šfo
(
šfo
, 
¥aû_šfo
, 0, 0);

4402 ià(!(
¥aû_šfo
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
) ||

4403 !
	`BTRFS_FS_LOG_CLEANUP_ERROR
(
šfo
)) {

4404 ià(
	`WARN_ON
(
¥aû_šfo
->
by‹s_»£rved
 > 0))

4405 
	`bŒfs_dump_¥aû_šfo
(
šfo
, 
¥aû_šfo
, 0, 0);

4408 
	`WARN_ON
(
¥aû_šfo
->
»şaim_size
 > 0);

4409 
	`li¡_d–
(&
¥aû_šfo
->
li¡
);

4410 
	`bŒfs_sysfs_»move_¥aû_šfo
(
¥aû_šfo
);

4413 
	}
}

4415 
	$bŒfs_ä“ze_block_group
(
bŒfs_block_group
 *
ÿche
)

4417 
	`©omic_šc
(&
ÿche
->
äoz’
);

4418 
	}
}

4420 
	$bŒfs_unä“ze_block_group
(
bŒfs_block_group
 *
block_group
)

4422 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

4423 
ex‹Á_m­_Œ“
 *
em_Œ“
;

4424 
ex‹Á_m­
 *
em
;

4425 
boŞ
 
ş—nup
;

4427 
	`¥š_lock
(&
block_group
->
lock
);

4428 
ş—nup
 = (
	`©omic_dec_ªd_‹¡
(&
block_group
->
äoz’
) &&

4429 
	`‹¡_b™
(
BLOCK_GROUP_FLAG_REMOVED
, &
block_group
->
ruÁime_æags
));

4430 
	`¥š_uÆock
(&
block_group
->
lock
);

4432 ià(
ş—nup
) {

4433 
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

4434 
	`wr™e_lock
(&
em_Œ“
->
lock
);

4435 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
block_group
->
¡¬t
,

4437 
	`BUG_ON
(!
em
);

4438 
	`»move_ex‹Á_m­pšg
(
em_Œ“
, 
em
);

4439 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

4442 
	`ä“_ex‹Á_m­
(
em
);

4443 
	`ä“_ex‹Á_m­
(
em
);

4450 
	`bŒfs_»move_ä“_¥aû_ÿche
(
block_group
);

4452 
	}
}

4454 
boŞ
 
	$bŒfs_šc_block_group_sw­_ex‹Ás
(
bŒfs_block_group
 *
bg
)

4456 
boŞ
 
»t
 = 
Œue
;

4458 
	`¥š_lock
(&
bg
->
lock
);

4459 ià(
bg
->
ro
)

4460 
»t
 = 
çl£
;

4462 
bg
->
sw­_ex‹Ás
++;

4463 
	`¥š_uÆock
(&
bg
->
lock
);

4465  
»t
;

4466 
	}
}

4468 
	$bŒfs_dec_block_group_sw­_ex‹Ás
(
bŒfs_block_group
 *
bg
, 
amouÁ
)

4470 
	`¥š_lock
(&
bg
->
lock
);

4471 
	`ASSERT
(!
bg
->
ro
);

4472 
	`ASSERT
(
bg
->
sw­_ex‹Ás
 >ğ
amouÁ
);

4473 
bg
->
sw­_ex‹Ás
 -ğ
amouÁ
;

4474 
	`¥š_uÆock
(&
bg
->
lock
);

4475 
	}
}

4477 
bŒfs_block_group_size_şass
 
	$bŒfs_ÿlc_block_group_size_şass
(
u64
 
size
)

4479 ià(
size
 <ğ
SZ_128K
)

4480  
BTRFS_BG_SZ_SMALL
;

4481 ià(
size
 <ğ
SZ_8M
)

4482  
BTRFS_BG_SZ_MEDIUM
;

4483  
BTRFS_BG_SZ_LARGE
;

4484 
	}
}

4505 
	$bŒfs_u£_block_group_size_şass
(
bŒfs_block_group
 *
bg
,

4506 
bŒfs_block_group_size_şass
 
size_şass
,

4507 
boŞ
 
fÜû_wrÚg_size_şass
)

4509 
	`ASSERT
(
size_şass
 !ğ
BTRFS_BG_SZ_NONE
);

4512 ià(
bg
->
size_şass
 == size_class)

4524 ià(
bg
->
size_şass
 !ğ
BTRFS_BG_SZ_NONE
) {

4525 ià(
fÜû_wrÚg_size_şass
)

4527  -
EAGAIN
;

4533 
bg
->
size_şass
 = size_class;

4536 
	}
}

4538 
boŞ
 
	$bŒfs_block_group_should_u£_size_şass
(
bŒfs_block_group
 *
bg
)

4540 ià(
	`bŒfs_is_zÚed
(
bg
->
fs_šfo
))

4541  
çl£
;

4542 ià(!
	`bŒfs_is_block_group_d©a_Úly
(
bg
))

4543  
çl£
;

4544  
Œue
;

4545 
	}
}

	@block-group.h

3 #iâdeà
BTRFS_BLOCK_GROUP_H


4 
	#BTRFS_BLOCK_GROUP_H


	)

6 
	~"ä“-¥aû-ÿche.h
"

8 
	ebŒfs_disk_ÿche_¡©e
 {

9 
	mBTRFS_DC_WRITTEN
,

10 
	mBTRFS_DC_ERROR
,

11 
	mBTRFS_DC_CLEAR
,

12 
	mBTRFS_DC_SETUP
,

15 
	ebŒfs_block_group_size_şass
 {

17 
	mBTRFS_BG_SZ_NONE
,

19 
	mBTRFS_BG_SZ_SMALL
,

21 
	mBTRFS_BG_SZ_MEDIUM
,

23 
	mBTRFS_BG_SZ_LARGE
,

33 
	ebŒfs_disÿrd_¡©e
 {

34 
	mBTRFS_DISCARD_EXTENTS
,

35 
	mBTRFS_DISCARD_BITMAPS
,

36 
	mBTRFS_DISCARD_RESET_CURSOR
,

53 
	ebŒfs_chunk_®loc_’um
 {

54 
	mCHUNK_ALLOC_NO_FORCE
,

55 
	mCHUNK_ALLOC_LIMITED
,

56 
	mCHUNK_ALLOC_FORCE
,

57 
	mCHUNK_ALLOC_FORCE_FOR_EXTENT
,

61 
	ebŒfs_block_group_æags
 {

62 
	mBLOCK_GROUP_FLAG_IREF
,

63 
	mBLOCK_GROUP_FLAG_REMOVED
,

64 
	mBLOCK_GROUP_FLAG_TO_COPY
,

65 
	mBLOCK_GROUP_FLAG_RELOCATING_REPAIR
,

66 
	mBLOCK_GROUP_FLAG_CHUNK_ITEM_INSERTED
,

67 
	mBLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
,

68 
	mBLOCK_GROUP_FLAG_ZONED_DATA_RELOC
,

70 
	mBLOCK_GROUP_FLAG_NEEDS_FREE_SPACE
,

72 
	mBLOCK_GROUP_FLAG_SEQUENTIAL_ZONE
,

77 
	mBLOCK_GROUP_FLAG_NEW
,

80 
	ebŒfs_ÿchšg_ty³
 {

81 
	mBTRFS_CACHE_NO
,

82 
	mBTRFS_CACHE_STARTED
,

83 
	mBTRFS_CACHE_FINISHED
,

84 
	mBTRFS_CACHE_ERROR
,

87 
	sbŒfs_ÿchšg_cÚŒŞ
 {

88 
li¡_h—d
 
	mli¡
;

89 
mu‹x
 
	mmu‹x
;

90 
wa™_queue_h—d_t
 
	mwa™
;

91 
bŒfs_wÜk
 
	mwÜk
;

92 
bŒfs_block_group
 *
	mblock_group
;

94 
©omic_t
 
	m´og»ss
;

95 
»fcouÁ_t
 
	mcouÁ
;

99 
	#CACHING_CTL_WAKE_UP
 
SZ_2M


	)

101 
	sbŒfs_block_group
 {

102 
bŒfs_fs_šfo
 *
	mfs_šfo
;

103 
šode
 *
	mšode
;

104 
¥šlock_t
 
	mlock
;

105 
u64
 
	m¡¬t
;

106 
u64
 
	mËngth
;

107 
u64
 
	mpšÃd
;

108 
u64
 
	m»£rved
;

109 
u64
 
	mu£d
;

110 
u64
 
	md–®loc_by‹s
;

111 
u64
 
	mby‹s_su³r
;

112 
u64
 
	mæags
;

113 
u64
 
	mÿche_g’”©iÚ
;

114 
u64
 
	mglob®_roÙ_id
;

121 
u64
 
	mcomm™_u£d
;

126 
u32
 
	mb™m­_high_th»sh
;

132 
u32
 
	mb™m­_low_th»sh
;

139 
rw_£m­hÜe
 
	md©a_rw£m
;

142 
	mfuÎ_¡re_Ën
;

143 
	mruÁime_æags
;

145 
	mro
;

147 
	mdisk_ÿche_¡©e
;

150 
	mÿched
;

151 
bŒfs_ÿchšg_cÚŒŞ
 *
	mÿchšg_ùl
;

153 
bŒfs_¥aû_šfo
 *
	m¥aû_šfo
;

156 
bŒfs_ä“_¥aû_ùl
 *
	mä“_¥aû_ùl
;

159 
rb_node
 
	mÿche_node
;

162 
li¡_h—d
 
	mli¡
;

164 
»fcouÁ_t
 
	m»fs
;

170 
li¡_h—d
 
	mşu¡”_li¡
;

180 
li¡_h—d
 
	mbg_li¡
;

183 
li¡_h—d
 
	mro_li¡
;

193 
©omic_t
 
	mäoz’
;

196 
li¡_h—d
 
	mdisÿrd_li¡
;

197 
	mdisÿrd_šdex
;

198 
u64
 
	mdisÿrd_–igibË_time
;

199 
u64
 
	mdisÿrd_cursÜ
;

200 
bŒfs_disÿrd_¡©e
 
	mdisÿrd_¡©e
;

203 
li¡_h—d
 
	mdœty_li¡
;

204 
li¡_h—d
 
	mio_li¡
;

206 
bŒfs_io_ùl
 
	mio_ùl
;

217 
©omic_t
 
	m»£rv©iÚs
;

227 
©omic_t
 
	mnocow_wr™”s
;

230 
mu‹x
 
	mä“_¥aû_lock
;

236 
	msw­_ex‹Ás
;

242 
u64
 
	m®loc_off£t
;

243 
u64
 
	mzÚe_unu§bË
;

244 
u64
 
	mzÚe_ÿ·c™y
;

245 
u64
 
	mm‘a_wr™e_poš‹r
;

246 
m­_lookup
 *
	mphysiÿl_m­
;

247 
li¡_h—d
 
	maùive_bg_li¡
;

248 
wÜk_¡ruù
 
	mzÚe_fšish_wÜk
;

249 
ex‹Á_bufãr
 *
	mÏ¡_eb
;

250 
bŒfs_block_group_size_şass
 
	msize_şass
;

253 
šlše
 
u64
 
	$bŒfs_block_group_’d
(
bŒfs_block_group
 *
block_group
)

255  (
block_group
->
¡¬t
 + block_group->
Ëngth
);

256 
	}
}

258 
šlše
 
boŞ
 
	$bŒfs_is_block_group_d©a_Úly
(

259 
bŒfs_block_group
 *
block_group
)

265  (
block_group
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
) &&

266 !(
block_group
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
);

267 
	}
}

269 #ifdeà
CONFIG_BTRFS_DEBUG


270 
bŒfs_should_äagm’t_ä“_¥aû
(
bŒfs_block_group
 *
block_group
);

273 
bŒfs_block_group
 *
bŒfs_lookup_fœ¡_block_group
(

274 
bŒfs_fs_šfo
 *
šfo
, 
u64
 
by‹Ä
);

275 
bŒfs_block_group
 *
bŒfs_lookup_block_group
(

276 
bŒfs_fs_šfo
 *
šfo
, 
u64
 
by‹Ä
);

277 
bŒfs_block_group
 *
bŒfs_Ãxt_block_group
(

278 
bŒfs_block_group
 *
ÿche
);

279 
bŒfs_g‘_block_group
(
bŒfs_block_group
 *
ÿche
);

280 
bŒfs_put_block_group
(
bŒfs_block_group
 *
ÿche
);

281 
bŒfs_dec_block_group_»£rv©iÚs
(
bŒfs_fs_šfo
 *
fs_šfo
,

282 cÚ¡ 
u64
 
¡¬t
);

283 
bŒfs_wa™_block_group_»£rv©iÚs
(
bŒfs_block_group
 *
bg
);

284 
bŒfs_block_group
 *
bŒfs_šc_nocow_wr™”s
(
bŒfs_fs_šfo
 *
fs_šfo
,

285 
u64
 
by‹Ä
);

286 
bŒfs_dec_nocow_wr™”s
(
bŒfs_block_group
 *
bg
);

287 
bŒfs_wa™_nocow_wr™”s
(
bŒfs_block_group
 *
bg
);

288 
bŒfs_wa™_block_group_ÿche_´og»ss
(
bŒfs_block_group
 *
ÿche
,

289 
u64
 
num_by‹s
);

290 
bŒfs_ÿche_block_group
(
bŒfs_block_group
 *
ÿche
, 
boŞ
 
wa™
);

291 
bŒfs_put_ÿchšg_cÚŒŞ
(
bŒfs_ÿchšg_cÚŒŞ
 *
ùl
);

292 
bŒfs_ÿchšg_cÚŒŞ
 *
bŒfs_g‘_ÿchšg_cÚŒŞ
(

293 
bŒfs_block_group
 *
ÿche
);

294 
bŒfs_add_Ãw_ä“_¥aû
(
bŒfs_block_group
 *
block_group
,

295 
u64
 
¡¬t
, u64 
’d
, u64 *
tÙ®_added_»t
);

296 
bŒfs_Œªs_hªdË
 *
bŒfs_¡¬t_Œªs_»move_block_group
(

297 
bŒfs_fs_šfo
 *
fs_šfo
,

298 cÚ¡ 
u64
 
chunk_off£t
);

299 
bŒfs_»move_block_group
(
bŒfs_Œªs_hªdË
 *
Œªs
,

300 
u64
 
group_¡¬t
, 
ex‹Á_m­
 *
em
);

301 
bŒfs_d–‘e_unu£d_bgs
(
bŒfs_fs_šfo
 *
fs_šfo
);

302 
bŒfs_m¬k_bg_unu£d
(
bŒfs_block_group
 *
bg
);

303 
bŒfs_»şaim_bgs_wÜk
(
wÜk_¡ruù
 *
wÜk
);

304 
bŒfs_»şaim_bgs
(
bŒfs_fs_šfo
 *
fs_šfo
);

305 
bŒfs_m¬k_bg_to_»şaim
(
bŒfs_block_group
 *
bg
);

306 
bŒfs_»ad_block_groups
(
bŒfs_fs_šfo
 *
šfo
);

307 
bŒfs_block_group
 *
bŒfs_make_block_group
(
bŒfs_Œªs_hªdË
 *
Œªs
,

308 
u64
 
ty³
,

309 
u64
 
chunk_off£t
, u64 
size
);

310 
bŒfs_ü—‹_³ndšg_block_groups
(
bŒfs_Œªs_hªdË
 *
Œªs
);

311 
bŒfs_šc_block_group_ro
(
bŒfs_block_group
 *
ÿche
,

312 
boŞ
 
do_chunk_®loc
);

313 
bŒfs_dec_block_group_ro
(
bŒfs_block_group
 *
ÿche
);

314 
bŒfs_¡¬t_dœty_block_groups
(
bŒfs_Œªs_hªdË
 *
Œªs
);

315 
bŒfs_wr™e_dœty_block_groups
(
bŒfs_Œªs_hªdË
 *
Œªs
);

316 
bŒfs_£tup_¥aû_ÿche
(
bŒfs_Œªs_hªdË
 *
Œªs
);

317 
bŒfs_upd©e_block_group
(
bŒfs_Œªs_hªdË
 *
Œªs
,

318 
u64
 
by‹Ä
, u64 
num_by‹s
, 
boŞ
 
®loc
);

319 
bŒfs_add_»£rved_by‹s
(
bŒfs_block_group
 *
ÿche
,

320 
u64
 
¿m_by‹s
, u64 
num_by‹s
, 
d–®loc
,

321 
boŞ
 
fÜû_wrÚg_size_şass
);

322 
bŒfs_ä“_»£rved_by‹s
(
bŒfs_block_group
 *
ÿche
,

323 
u64
 
num_by‹s
, 
d–®loc
);

324 
bŒfs_chunk_®loc
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
æags
,

325 
bŒfs_chunk_®loc_’um
 
fÜû
);

326 
bŒfs_fÜû_chunk_®loc
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
ty³
);

327 
check_sy¡em_chunk
(
bŒfs_Œªs_hªdË
 *
Œªs
, cÚ¡ 
u64
 
ty³
);

328 
bŒfs_»£rve_chunk_m‘ad©a
(
bŒfs_Œªs_hªdË
 *
Œªs
,

329 
boŞ
 
is_™em_š£¹iÚ
);

330 
u64
 
bŒfs_g‘_®loc_´ofe
(
bŒfs_fs_šfo
 *
fs_šfo
, u64 
Üig_æags
);

331 
bŒfs_put_block_group_ÿche
(
bŒfs_fs_šfo
 *
šfo
);

332 
bŒfs_ä“_block_groups
(
bŒfs_fs_šfo
 *
šfo
);

333 
bŒfs_rm­_block
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
chunk_¡¬t
,

334 
u64
 
physiÿl
, u64 **
logiÿl
, *
Çddrs
, *
¡re_Ën
);

336 
šlše
 
u64
 
	$bŒfs_d©a_®loc_´ofe
(
bŒfs_fs_šfo
 *
fs_šfo
)

338  
	`bŒfs_g‘_®loc_´ofe
(
fs_šfo
, 
BTRFS_BLOCK_GROUP_DATA
);

339 
	}
}

341 
šlše
 
u64
 
	$bŒfs_m‘ad©a_®loc_´ofe
(
bŒfs_fs_šfo
 *
fs_šfo
)

343  
	`bŒfs_g‘_®loc_´ofe
(
fs_šfo
, 
BTRFS_BLOCK_GROUP_METADATA
);

344 
	}
}

346 
šlše
 
u64
 
	$bŒfs_sy¡em_®loc_´ofe
(
bŒfs_fs_šfo
 *
fs_šfo
)

348  
	`bŒfs_g‘_®loc_´ofe
(
fs_šfo
, 
BTRFS_BLOCK_GROUP_SYSTEM
);

349 
	}
}

351 
šlše
 
	$bŒfs_block_group_dÚe
(
bŒfs_block_group
 *
ÿche
)

353 
	`smp_mb
();

354  
ÿche
->
ÿched
 =ğ
BTRFS_CACHE_FINISHED
 ||

355 
ÿche
->
ÿched
 =ğ
BTRFS_CACHE_ERROR
;

356 
	}
}

358 
bŒfs_ä“ze_block_group
(
bŒfs_block_group
 *
ÿche
);

359 
bŒfs_unä“ze_block_group
(
bŒfs_block_group
 *
ÿche
);

361 
boŞ
 
bŒfs_šc_block_group_sw­_ex‹Ás
(
bŒfs_block_group
 *
bg
);

362 
bŒfs_dec_block_group_sw­_ex‹Ás
(
bŒfs_block_group
 *
bg
, 
amouÁ
);

364 
bŒfs_block_group_size_şass
 
bŒfs_ÿlc_block_group_size_şass
(
u64
 
size
);

365 
bŒfs_u£_block_group_size_şass
(
bŒfs_block_group
 *
bg
,

366 
bŒfs_block_group_size_şass
 
size_şass
,

367 
boŞ
 
fÜû_wrÚg_size_şass
);

368 
boŞ
 
bŒfs_block_group_should_u£_size_şass
(
bŒfs_block_group
 *
bg
);

	@block-rsv.c

3 
	~"misc.h
"

4 
	~"ù»e.h
"

5 
	~"block-rsv.h
"

6 
	~"¥aû-šfo.h
"

7 
	~"Œª§ùiÚ.h
"

8 
	~"block-group.h
"

9 
	~"disk-io.h
"

10 
	~"fs.h
"

11 
	~"acûssÜs.h
"

105 
u64
 
	$block_rsv_»Ëa£_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
,

106 
bŒfs_block_rsv
 *
block_rsv
,

107 
bŒfs_block_rsv
 *
de¡
, 
u64
 
num_by‹s
,

108 
u64
 *
qgroup_to_»Ëa£_»t
)

110 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
block_rsv
->space_info;

111 
u64
 
qgroup_to_»Ëa£
 = 0;

112 
u64
 
»t
;

114 
	`¥š_lock
(&
block_rsv
->
lock
);

115 ià(
num_by‹s
 =ğ(
u64
)-1) {

116 
num_by‹s
 = 
block_rsv
->
size
;

117 
qgroup_to_»Ëa£
 = 
block_rsv
->
qgroup_rsv_size
;

119 
block_rsv
->
size
 -ğ
num_by‹s
;

120 ià(
block_rsv
->
»£rved
 >ğblock_rsv->
size
) {

121 
num_by‹s
 = 
block_rsv
->
»£rved
 - block_rsv->
size
;

122 
block_rsv
->
»£rved
 = block_rsv->
size
;

123 
block_rsv
->
fuÎ
 = 
Œue
;

125 
num_by‹s
 = 0;

127 ià(
qgroup_to_»Ëa£_»t
 &&

128 
block_rsv
->
qgroup_rsv_»£rved
 >ğblock_rsv->
qgroup_rsv_size
) {

129 
qgroup_to_»Ëa£
 = 
block_rsv
->
qgroup_rsv_»£rved
 -

130 
block_rsv
->
qgroup_rsv_size
;

131 
block_rsv
->
qgroup_rsv_»£rved
 = block_rsv->
qgroup_rsv_size
;

133 
qgroup_to_»Ëa£
 = 0;

135 
	`¥š_uÆock
(&
block_rsv
->
lock
);

137 
»t
 = 
num_by‹s
;

138 ià(
num_by‹s
 > 0) {

139 ià(
de¡
) {

140 
	`¥š_lock
(&
de¡
->
lock
);

141 ià(!
de¡
->
fuÎ
) {

142 
u64
 
by‹s_to_add
;

144 
by‹s_to_add
 = 
de¡
->
size
 - de¡->
»£rved
;

145 
by‹s_to_add
 = 
	`mš
(
num_by‹s
, bytes_to_add);

146 
de¡
->
»£rved
 +ğ
by‹s_to_add
;

147 ià(
de¡
->
»£rved
 >ğde¡->
size
)

148 
de¡
->
fuÎ
 = 
Œue
;

149 
num_by‹s
 -ğ
by‹s_to_add
;

151 
	`¥š_uÆock
(&
de¡
->
lock
);

153 ià(
num_by‹s
)

154 
	`bŒfs_¥aû_šfo_ä“_by‹s_may_u£
(
fs_šfo
,

155 
¥aû_šfo
,

156 
num_by‹s
);

158 ià(
qgroup_to_»Ëa£_»t
)

159 *
qgroup_to_»Ëa£_»t
 = 
qgroup_to_»Ëa£
;

160  
»t
;

161 
	}
}

163 
	$bŒfs_block_rsv_mig¿‹
(
bŒfs_block_rsv
 *
¤c
,

164 
bŒfs_block_rsv
 *
d¡
, 
u64
 
num_by‹s
,

165 
boŞ
 
upd©e_size
)

167 
»t
;

169 
»t
 = 
	`bŒfs_block_rsv_u£_by‹s
(
¤c
, 
num_by‹s
);

170 ià(
»t
)

171  
»t
;

173 
	`bŒfs_block_rsv_add_by‹s
(
d¡
, 
num_by‹s
, 
upd©e_size
);

175 
	}
}

177 
	$bŒfs_š™_block_rsv
(
bŒfs_block_rsv
 *
rsv
, 
bŒfs_rsv_ty³
 
ty³
)

179 
	`mem£t
(
rsv
, 0, (*rsv));

180 
	`¥š_lock_š™
(&
rsv
->
lock
);

181 
rsv
->
ty³
 =ype;

182 
	}
}

184 
	$bŒfs_š™_m‘ad©a_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
,

185 
bŒfs_block_rsv
 *
rsv
,

186 
bŒfs_rsv_ty³
 
ty³
)

188 
	`bŒfs_š™_block_rsv
(
rsv
, 
ty³
);

189 
rsv
->
¥aû_šfo
 = 
	`bŒfs_fšd_¥aû_šfo
(
fs_šfo
,

190 
BTRFS_BLOCK_GROUP_METADATA
);

191 
	}
}

193 
bŒfs_block_rsv
 *
	$bŒfs_®loc_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
,

194 
bŒfs_rsv_ty³
 
ty³
)

196 
bŒfs_block_rsv
 *
block_rsv
;

198 
block_rsv
 = 
	`km®loc
((*block_rsv), 
GFP_NOFS
);

199 ià(!
block_rsv
)

200  
NULL
;

202 
	`bŒfs_š™_m‘ad©a_block_rsv
(
fs_šfo
, 
block_rsv
, 
ty³
);

203  
block_rsv
;

204 
	}
}

206 
	$bŒfs_ä“_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
,

207 
bŒfs_block_rsv
 *
rsv
)

209 ià(!
rsv
)

211 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rsv
, (
u64
)-1, 
NULL
);

212 
	`kä“
(
rsv
);

213 
	}
}

215 
	$bŒfs_block_rsv_add
(
bŒfs_fs_šfo
 *
fs_šfo
,

216 
bŒfs_block_rsv
 *
block_rsv
, 
u64
 
num_by‹s
,

217 
bŒfs_»£rve_æush_’um
 
æush
)

219 
»t
;

221 ià(
num_by‹s
 == 0)

224 
»t
 = 
	`bŒfs_»£rve_m‘ad©a_by‹s
(
fs_šfo
, 
block_rsv
, 
num_by‹s
, 
æush
);

225 ià(!
»t
)

226 
	`bŒfs_block_rsv_add_by‹s
(
block_rsv
, 
num_by‹s
, 
Œue
);

228  
»t
;

229 
	}
}

231 
	$bŒfs_block_rsv_check
(
bŒfs_block_rsv
 *
block_rsv
, 
mš_³rûÁ
)

233 
u64
 
num_by‹s
 = 0;

234 
»t
 = -
ENOSPC
;

236 
	`¥š_lock
(&
block_rsv
->
lock
);

237 
num_by‹s
 = 
	`muÉ_³rc
(
block_rsv
->
size
, 
mš_³rûÁ
);

238 ià(
block_rsv
->
»£rved
 >ğ
num_by‹s
)

239 
»t
 = 0;

240 
	`¥š_uÆock
(&
block_rsv
->
lock
);

242  
»t
;

243 
	}
}

245 
	$bŒfs_block_rsv_»fl
(
bŒfs_fs_šfo
 *
fs_šfo
,

246 
bŒfs_block_rsv
 *
block_rsv
, 
u64
 
num_by‹s
,

247 
bŒfs_»£rve_æush_’um
 
æush
)

249 
»t
 = -
ENOSPC
;

251 ià(!
block_rsv
)

254 
	`¥š_lock
(&
block_rsv
->
lock
);

255 ià(
block_rsv
->
»£rved
 >ğ
num_by‹s
)

256 
»t
 = 0;

258 
num_by‹s
 -ğ
block_rsv
->
»£rved
;

259 
	`¥š_uÆock
(&
block_rsv
->
lock
);

261 ià(!
»t
)

264 
»t
 = 
	`bŒfs_»£rve_m‘ad©a_by‹s
(
fs_šfo
, 
block_rsv
, 
num_by‹s
, 
æush
);

265 ià(!
»t
) {

266 
	`bŒfs_block_rsv_add_by‹s
(
block_rsv
, 
num_by‹s
, 
çl£
);

270  
»t
;

271 
	}
}

273 
u64
 
	$bŒfs_block_rsv_»Ëa£
(
bŒfs_fs_šfo
 *
fs_šfo
,

274 
bŒfs_block_rsv
 *
block_rsv
, 
u64
 
num_by‹s
,

275 
u64
 *
qgroup_to_»Ëa£
)

277 
bŒfs_block_rsv
 *
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

278 
bŒfs_block_rsv
 *
d–ayed_rsv
 = &
fs_šfo
->
d–ayed_»fs_rsv
;

279 
bŒfs_block_rsv
 *
rg‘
 = 
NULL
;

285 ià(
block_rsv
 =ğ
d–ayed_rsv
)

286 
rg‘
 = 
glob®_rsv
;

287 ià(
block_rsv
 !ğ
glob®_rsv
 && !
	`bŒfs_block_rsv_fuÎ
(
d–ayed_rsv
))

288 
rg‘
 = 
d–ayed_rsv
;

290 ià(
rg‘
 && 
block_rsv
->
¥aû_šfo
 !=arget->space_info)

291 
rg‘
 = 
NULL
;

293  
	`block_rsv_»Ëa£_by‹s
(
fs_šfo
, 
block_rsv
, 
rg‘
, 
num_by‹s
,

294 
qgroup_to_»Ëa£
);

295 
	}
}

297 
	$bŒfs_block_rsv_u£_by‹s
(
bŒfs_block_rsv
 *
block_rsv
, 
u64
 
num_by‹s
)

299 
»t
 = -
ENOSPC
;

301 
	`¥š_lock
(&
block_rsv
->
lock
);

302 ià(
block_rsv
->
»£rved
 >ğ
num_by‹s
) {

303 
block_rsv
->
»£rved
 -ğ
num_by‹s
;

304 ià(
block_rsv
->
»£rved
 < block_rsv->
size
)

305 
block_rsv
->
fuÎ
 = 
çl£
;

306 
»t
 = 0;

308 
	`¥š_uÆock
(&
block_rsv
->
lock
);

309  
»t
;

310 
	}
}

312 
	$bŒfs_block_rsv_add_by‹s
(
bŒfs_block_rsv
 *
block_rsv
,

313 
u64
 
num_by‹s
, 
boŞ
 
upd©e_size
)

315 
	`¥š_lock
(&
block_rsv
->
lock
);

316 
block_rsv
->
»£rved
 +ğ
num_by‹s
;

317 ià(
upd©e_size
)

318 
block_rsv
->
size
 +ğ
num_by‹s
;

319 ià(
block_rsv
->
»£rved
 >ğblock_rsv->
size
)

320 
block_rsv
->
fuÎ
 = 
Œue
;

321 
	`¥š_uÆock
(&
block_rsv
->
lock
);

322 
	}
}

324 
	$bŒfs_upd©e_glob®_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
)

326 
bŒfs_block_rsv
 *
block_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

327 
bŒfs_¥aû_šfo
 *
sšfo
 = 
block_rsv
->
¥aû_šfo
;

328 
bŒfs_roÙ
 *
roÙ
, *
tmp
;

329 
u64
 
num_by‹s
 = 
	`bŒfs_roÙ_u£d
(&
fs_šfo
->
Œ“_roÙ
->
roÙ_™em
);

330 
mš_™ems
 = 1;

340 
	`»ad_lock
(&
fs_šfo
->
glob®_roÙ_lock
);

341 
	`rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
roÙ
, 
tmp
, &
fs_šfo
->
glob®_roÙ_Œ“
,

342 
rb_node
) {

343 ià(
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_EXTENT_TREE_OBJECTID
 ||

344 
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_CSUM_TREE_OBJECTID
 ||

345 
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_FREE_SPACE_TREE_OBJECTID
) {

346 
num_by‹s
 +ğ
	`bŒfs_roÙ_u£d
(&
roÙ
->
roÙ_™em
);

347 
mš_™ems
++;

350 
	`»ad_uÆock
(&
fs_šfo
->
glob®_roÙ_lock
);

352 ià(
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
BLOCK_GROUP_TREE
)) {

353 
num_by‹s
 +ğ
	`bŒfs_roÙ_u£d
(&
fs_šfo
->
block_group_roÙ
->
roÙ_™em
);

354 
mš_™ems
++;

366 
mš_™ems
 +ğ
BTRFS_UNLINK_METADATA_UNITS
;

368 
num_by‹s
 = 
	`max_t
(
u64
,‚um_bytes,

369 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
, 
mš_™ems
) +

370 
	`bŒfs_ÿlc_d–ayed_»f_by‹s
(
fs_šfo
,

371 
BTRFS_UNLINK_METADATA_UNITS
));

373 
	`¥š_lock
(&
sšfo
->
lock
);

374 
	`¥š_lock
(&
block_rsv
->
lock
);

376 
block_rsv
->
size
 = 
	`mš_t
(
u64
, 
num_by‹s
, 
SZ_512M
);

378 ià(
block_rsv
->
»£rved
 < block_rsv->
size
) {

379 
num_by‹s
 = 
block_rsv
->
size
 - block_rsv->
»£rved
;

380 
	`bŒfs_¥aû_šfo_upd©e_by‹s_may_u£
(
fs_šfo
, 
sšfo
,

381 
num_by‹s
);

382 
block_rsv
->
»£rved
 = block_rsv->
size
;

383 } ià(
block_rsv
->
»£rved
 > block_rsv->
size
) {

384 
num_by‹s
 = 
block_rsv
->
»£rved
 - block_rsv->
size
;

385 
	`bŒfs_¥aû_šfo_upd©e_by‹s_may_u£
(
fs_šfo
, 
sšfo
,

386 -
num_by‹s
);

387 
block_rsv
->
»£rved
 = block_rsv->
size
;

388 
	`bŒfs_Œy_g¿Ášg_tick‘s
(
fs_šfo
, 
sšfo
);

391 
block_rsv
->
fuÎ
 = (block_rsv->
»£rved
 =ğblock_rsv->
size
);

393 ià(
block_rsv
->
size
 >ğ
sšfo
->
tÙ®_by‹s
)

394 
sšfo
->
fÜû_®loc
 = 
CHUNK_ALLOC_FORCE
;

395 
	`¥š_uÆock
(&
block_rsv
->
lock
);

396 
	`¥š_uÆock
(&
sšfo
->
lock
);

397 
	}
}

399 
	$bŒfs_š™_roÙ_block_rsv
(
bŒfs_roÙ
 *
roÙ
)

401 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

403 
roÙ
->
roÙ_key
.
objeùid
) {

404 
BTRFS_CSUM_TREE_OBJECTID
:

405 
BTRFS_EXTENT_TREE_OBJECTID
:

406 
BTRFS_FREE_SPACE_TREE_OBJECTID
:

407 
BTRFS_BLOCK_GROUP_TREE_OBJECTID
:

408 
roÙ
->
block_rsv
 = &
fs_šfo
->
d–ayed_»fs_rsv
;

410 
BTRFS_ROOT_TREE_OBJECTID
:

411 
BTRFS_DEV_TREE_OBJECTID
:

412 
BTRFS_QUOTA_TREE_OBJECTID
:

413 
roÙ
->
block_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

415 
BTRFS_CHUNK_TREE_OBJECTID
:

416 
roÙ
->
block_rsv
 = &
fs_šfo
->
chunk_block_rsv
;

419 
roÙ
->
block_rsv
 = 
NULL
;

422 
	}
}

424 
	$bŒfs_š™_glob®_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
)

426 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

428 
¥aû_šfo
 = 
	`bŒfs_fšd_¥aû_šfo
(
fs_šfo
, 
BTRFS_BLOCK_GROUP_SYSTEM
);

429 
fs_šfo
->
chunk_block_rsv
.
¥aû_šfo
 = space_info;

431 
¥aû_šfo
 = 
	`bŒfs_fšd_¥aû_šfo
(
fs_šfo
, 
BTRFS_BLOCK_GROUP_METADATA
);

432 
fs_šfo
->
glob®_block_rsv
.
¥aû_šfo
 = space_info;

433 
fs_šfo
->
Œªs_block_rsv
.
¥aû_šfo
 = space_info;

434 
fs_šfo
->
em±y_block_rsv
.
¥aû_šfo
 = space_info;

435 
fs_šfo
->
d–ayed_block_rsv
.
¥aû_šfo
 = space_info;

436 
fs_šfo
->
d–ayed_»fs_rsv
.
¥aû_šfo
 = space_info;

438 
	`bŒfs_upd©e_glob®_block_rsv
(
fs_šfo
);

439 
	}
}

441 
	$bŒfs_»Ëa£_glob®_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
)

443 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, &fs_šfo->
glob®_block_rsv
, (
u64
)-1,

444 
NULL
);

445 
	`WARN_ON
(
fs_šfo
->
Œªs_block_rsv
.
size
 > 0);

446 
	`WARN_ON
(
fs_šfo
->
Œªs_block_rsv
.
»£rved
 > 0);

447 
	`WARN_ON
(
fs_šfo
->
chunk_block_rsv
.
size
 > 0);

448 
	`WARN_ON
(
fs_šfo
->
chunk_block_rsv
.
»£rved
 > 0);

449 
	`WARN_ON
(
fs_šfo
->
d–ayed_block_rsv
.
size
 > 0);

450 
	`WARN_ON
(
fs_šfo
->
d–ayed_block_rsv
.
»£rved
 > 0);

451 
	`WARN_ON
(
fs_šfo
->
d–ayed_»fs_rsv
.
»£rved
 > 0);

452 
	`WARN_ON
(
fs_šfo
->
d–ayed_»fs_rsv
.
size
 > 0);

453 
	}
}

455 
bŒfs_block_rsv
 *
	$g‘_block_rsv
(

456 cÚ¡ 
bŒfs_Œªs_hªdË
 *
Œªs
,

457 cÚ¡ 
bŒfs_roÙ
 *
roÙ
)

459 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

460 
bŒfs_block_rsv
 *
block_rsv
 = 
NULL
;

462 ià(
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
) ||

463 (
roÙ
 =ğ
fs_šfo
->
uuid_roÙ
) ||

464 (
Œªs
->
addšg_csums
 &&

465 
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_CSUM_TREE_OBJECTID
))

466 
block_rsv
 = 
Œªs
->block_rsv;

468 ià(!
block_rsv
)

469 
block_rsv
 = 
roÙ
->block_rsv;

471 ià(!
block_rsv
)

472 
block_rsv
 = &
fs_šfo
->
em±y_block_rsv
;

474  
block_rsv
;

475 
	}
}

477 
bŒfs_block_rsv
 *
	$bŒfs_u£_block_rsv
(
bŒfs_Œªs_hªdË
 *
Œªs
,

478 
bŒfs_roÙ
 *
roÙ
,

479 
u32
 
blocksize
)

481 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

482 
bŒfs_block_rsv
 *
block_rsv
;

483 
bŒfs_block_rsv
 *
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

484 
»t
;

485 
boŞ
 
glob®_upd©ed
 = 
çl£
;

487 
block_rsv
 = 
	`g‘_block_rsv
(
Œªs
, 
roÙ
);

489 ià(
	`uÆik–y
(
block_rsv
->
size
 == 0))

490 
Œy_»£rve
;

491 
agaš
:

492 
»t
 = 
	`bŒfs_block_rsv_u£_by‹s
(
block_rsv
, 
blocksize
);

493 ià(!
»t
)

494  
block_rsv
;

496 ià(
block_rsv
->
çç¡
)

497  
	`ERR_PTR
(
»t
);

499 ià(
block_rsv
->
ty³
 =ğ
BTRFS_BLOCK_RSV_GLOBAL
 && !
glob®_upd©ed
) {

500 
glob®_upd©ed
 = 
Œue
;

501 
	`bŒfs_upd©e_glob®_block_rsv
(
fs_šfo
);

502 
agaš
;

509 ià(
block_rsv
->
ty³
 !ğ
BTRFS_BLOCK_RSV_DELREFS
 &&

510 
	`bŒfs_‹¡_İt
(
fs_šfo
, 
ENOSPC_DEBUG
)) {

511 
	`DEFINE_RATELIMIT_STATE
(
_rs
,

512 
DEFAULT_RATELIMIT_INTERVAL
 * 10,

514 ià(
	`__¿‹lim™
(&
_rs
))

515 
	`WARN
(1, 
KERN_DEBUG


517 
block_rsv
->
ty³
, 
»t
);

519 
Œy_»£rve
:

520 
»t
 = 
	`bŒfs_»£rve_m‘ad©a_by‹s
(
fs_šfo
, 
block_rsv
, 
blocksize
,

521 
BTRFS_RESERVE_NO_FLUSH
);

522 ià(!
»t
)

523  
block_rsv
;

529 ià(
block_rsv
->
ty³
 !ğ
BTRFS_BLOCK_RSV_GLOBAL
 &&

530 
block_rsv
->
¥aû_šfo
 =ğ
glob®_rsv
->space_info) {

531 
»t
 = 
	`bŒfs_block_rsv_u£_by‹s
(
glob®_rsv
, 
blocksize
);

532 ià(!
»t
)

533  
glob®_rsv
;

542 
»t
 = 
	`bŒfs_»£rve_m‘ad©a_by‹s
(
fs_šfo
, 
block_rsv
, 
blocksize
,

543 
BTRFS_RESERVE_FLUSH_EMERGENCY
);

544 ià(!
»t
)

545  
block_rsv
;

547  
	`ERR_PTR
(
»t
);

548 
	}
}

550 
	$bŒfs_check_Œunc_ÿche_ä“_¥aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

551 
bŒfs_block_rsv
 *
rsv
)

553 
u64
 
Ãeded_by‹s
;

554 
»t
;

557 
Ãeded_by‹s
 = 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
, 1) +

558 
	`bŒfs_ÿlc_m‘ad©a_size
(
fs_šfo
, 1);

560 
	`¥š_lock
(&
rsv
->
lock
);

561 ià(
rsv
->
»£rved
 < 
Ãeded_by‹s
)

562 
»t
 = -
ENOSPC
;

564 
»t
 = 0;

565 
	`¥š_uÆock
(&
rsv
->
lock
);

566  
»t
;

567 
	}
}

	@block-rsv.h

3 #iâdeà
BTRFS_BLOCK_RSV_H


4 
	#BTRFS_BLOCK_RSV_H


	)

6 
	gbŒfs_Œªs_hªdË
;

7 
	gbŒfs_roÙ
;

8 
	gbŒfs_»£rve_æush_’um
;

13 
	ebŒfs_rsv_ty³
 {

14 
	mBTRFS_BLOCK_RSV_GLOBAL
,

15 
	mBTRFS_BLOCK_RSV_DELALLOC
,

16 
	mBTRFS_BLOCK_RSV_TRANS
,

17 
	mBTRFS_BLOCK_RSV_CHUNK
,

18 
	mBTRFS_BLOCK_RSV_DELOPS
,

19 
	mBTRFS_BLOCK_RSV_DELREFS
,

20 
	mBTRFS_BLOCK_RSV_EMPTY
,

21 
	mBTRFS_BLOCK_RSV_TEMP
,

24 
	sbŒfs_block_rsv
 {

25 
u64
 
	msize
;

26 
u64
 
	m»£rved
;

27 
bŒfs_¥aû_šfo
 *
	m¥aû_šfo
;

28 
¥šlock_t
 
	mlock
;

29 
boŞ
 
	mfuÎ
;

30 
boŞ
 
	mçç¡
;

32 
bŒfs_rsv_ty³
 
	mty³
:8;

50 
u64
 
	mqgroup_rsv_size
;

51 
u64
 
	mqgroup_rsv_»£rved
;

54 
bŒfs_š™_block_rsv
(
bŒfs_block_rsv
 *
rsv
, 
bŒfs_rsv_ty³
 
ty³
);

55 
bŒfs_š™_roÙ_block_rsv
(
bŒfs_roÙ
 *
roÙ
);

56 
bŒfs_block_rsv
 *
bŒfs_®loc_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
,

57 
bŒfs_rsv_ty³
 
ty³
);

58 
bŒfs_š™_m‘ad©a_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
,

59 
bŒfs_block_rsv
 *
rsv
,

60 
bŒfs_rsv_ty³
 
ty³
);

61 
bŒfs_ä“_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
,

62 
bŒfs_block_rsv
 *
rsv
);

63 
bŒfs_block_rsv_add
(
bŒfs_fs_šfo
 *
fs_šfo
,

64 
bŒfs_block_rsv
 *
block_rsv
, 
u64
 
num_by‹s
,

65 
bŒfs_»£rve_æush_’um
 
æush
);

66 
bŒfs_block_rsv_check
(
bŒfs_block_rsv
 *
block_rsv
, 
mš_³rûÁ
);

67 
bŒfs_block_rsv_»fl
(
bŒfs_fs_šfo
 *
fs_šfo
,

68 
bŒfs_block_rsv
 *
block_rsv
, 
u64
 
num_by‹s
,

69 
bŒfs_»£rve_æush_’um
 
æush
);

70 
bŒfs_block_rsv_mig¿‹
(
bŒfs_block_rsv
 *
¤c_rsv
,

71 
bŒfs_block_rsv
 *
d¡_rsv
, 
u64
 
num_by‹s
,

72 
boŞ
 
upd©e_size
);

73 
bŒfs_block_rsv_u£_by‹s
(
bŒfs_block_rsv
 *
block_rsv
, 
u64
 
num_by‹s
);

74 
bŒfs_block_rsv_add_by‹s
(
bŒfs_block_rsv
 *
block_rsv
,

75 
u64
 
num_by‹s
, 
boŞ
 
upd©e_size
);

76 
u64
 
bŒfs_block_rsv_»Ëa£
(
bŒfs_fs_šfo
 *
fs_šfo
,

77 
bŒfs_block_rsv
 *
block_rsv
,

78 
u64
 
num_by‹s
, u64 *
qgroup_to_»Ëa£
);

79 
bŒfs_upd©e_glob®_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
);

80 
bŒfs_š™_glob®_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
);

81 
bŒfs_»Ëa£_glob®_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
);

82 
bŒfs_block_rsv
 *
bŒfs_u£_block_rsv
(
bŒfs_Œªs_hªdË
 *
Œªs
,

83 
bŒfs_roÙ
 *
roÙ
,

84 
u32
 
blocksize
);

85 
bŒfs_check_Œunc_ÿche_ä“_¥aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

86 
bŒfs_block_rsv
 *
rsv
);

87 
šlše
 
	$bŒfs_unu£_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
,

88 
bŒfs_block_rsv
 *
block_rsv
,

89 
u32
 
blocksize
)

91 
	`bŒfs_block_rsv_add_by‹s
(
block_rsv
, 
blocksize
, 
çl£
);

92 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
block_rsv
, 0, 
NULL
);

93 
	}
}

99 
šlše
 
boŞ
 
	$bŒfs_block_rsv_fuÎ
(cÚ¡ 
bŒfs_block_rsv
 *
rsv
)

101  
	`d©a_¿û
(
rsv
->
fuÎ
);

102 
	}
}

	@btrfs.mod.c

1 
	~<lšux/moduË.h
>

2 
	#INCLUDE_VERMAGIC


	)

3 
	~<lšux/bud-§É.h
>

4 
	~<lšux/–âÙe-Éo.h
>

5 
	~<lšux/expÜt-š‹º®.h
>

6 
	~<lšux/v”magic.h
>

7 
	~<lšux/comp”.h
>

9 #ifdeà
CONFIG_UNWINDER_ORC


10 
	~<asm/Üc_h—d”.h
>

11 
	gORC_HEADER
;

14 
	gBUILD_SALT
;

15 
	gBUILD_LTO_INFO
;

17 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

18 
MODULE_INFO
(
Çme
, 
KBUILD_MODNAME
);

20 
__visibË
 
moduË
 
__this_moduË


21 
__£ùiÚ
(".gnu.linkonce.this_module") = {

22 .
Çme
 = 
KBUILD_MODNAME
,

23 .
	gš™
 = 
š™_moduË
,

24 #ifdeà
CONFIG_MODULE_UNLOAD


25 .
	gex™
 = 
ş—nup_moduË
,

27 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

30 #ifdeà
CONFIG_RETPOLINE


31 
MODULE_INFO
(
»Şše
, "Y");

36 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

37 
__u£d
 
__£ùiÚ
("__versions") = {

640 
MODULE_INFO
(
d•’ds
, "xor,raid6_pq,libcrc32c");

643 
MODULE_INFO
(
¤cv”siÚ
, "9C150C4FEEF4E80D67EC478");

	@btrfs_inode.h

6 #iâdeà
BTRFS_INODE_H


7 
	#BTRFS_INODE_H


	)

9 
	~<lšux/hash.h
>

10 
	~<lšux/»fcouÁ.h
>

11 
	~"ex‹Á_m­.h
"

12 
	~"ex‹Á_io.h
"

13 
	~"Üd”ed-d©a.h
"

14 
	~"d–ayed-šode.h
"

21 
	#BTRFS_DIR_START_INDEX
 2

	)

31 
	mBTRFS_INODE_FLUSH_ON_CLOSE
,

32 
	mBTRFS_INODE_DUMMY
,

33 
	mBTRFS_INODE_IN_DEFRAG
,

34 
	mBTRFS_INODE_HAS_ASYNC_EXTENT
,

40 
	mBTRFS_INODE_NEEDS_FULL_SYNC
,

41 
	mBTRFS_INODE_COPY_EVERYTHING
,

42 
	mBTRFS_INODE_IN_DELALLOC_LIST
,

43 
	mBTRFS_INODE_HAS_PROPS
,

44 
	mBTRFS_INODE_SNAPSHOT_FLUSH
,

51 
	mBTRFS_INODE_NO_XATTRS
,

60 
	mBTRFS_INODE_NO_DELALLOC_FLUSH
,

67 
	mBTRFS_INODE_VERITY_IN_PROGRESS
,

69 
	mBTRFS_INODE_FREE_SPACE_INODE
,

73 
	sbŒfs_šode
 {

75 
bŒfs_roÙ
 *
	mroÙ
;

80 
bŒfs_key
 
	mloÿtiÚ
;

88 
¥šlock_t
 
	mlock
;

91 
ex‹Á_m­_Œ“
 
	mex‹Á_Œ“
;

94 
ex‹Á_io_Œ“
 
	mio_Œ“
;

100 
ex‹Á_io_Œ“
 
	mfe_ex‹Á_Œ“
;

103 
mu‹x
 
	mlog_mu‹x
;

106 
bŒfs_Üd”ed_šode_Œ“
 
	mÜd”ed_Œ“
;

112 
li¡_h—d
 
	md–®loc_šodes
;

115 
rb_node
 
	mrb_node
;

117 
	mruÁime_æags
;

122 
u64
 
	mg’”©iÚ
;

127 
u64
 
	mÏ¡_Œªs
;

132 
u64
 
	mlogged_Œªs
;

137 
	mÏ¡_sub_Œªs
;

140 
	mÏ¡_log_comm™
;

148 
u64
 
	md–®loc_by‹s
;

156 
u64
 
	mfœ¡_dœ_šdex_to_log
;

166 
u64
 
	mÃw_d–®loc_by‹s
;

171 
u64
 
	mÏ¡_dœ_šdex_off£t
;

178 
u64
 
	mdeäag_by‹s
;

185 
u64
 
	mdisk_i_size
;

192 
u64
 
	mšdex_út
;

195 
u64
 
	mdœ_šdex
;

202 
u64
 
	mÏ¡_uÆšk_Œªs
;

213 
u64
 
	mÏ¡_»æšk_Œªs
;

219 
u64
 
	mcsum_by‹s
;

222 
u32
 
	mæags
;

224 
u32
 
	mro_æags
;

232 
	mout¡ªdšg_ex‹Ás
;

234 
bŒfs_block_rsv
 
	mblock_rsv
;

239 
	m´İ_com´ess
;

244 
	mdeäag_com´ess
;

246 
bŒfs_d–ayed_node
 *
	md–ayed_node
;

249 
time¥ec64
 
	mi_Ùime
;

252 
li¡_h—d
 
	md–ayed_ut
;

254 
rw_£m­hÜe
 
	mi_mm­_lock
;

255 
šode
 
	mvfs_šode
;

258 
šlše
 
u64
 
	$bŒfs_g‘_fœ¡_dœ_šdex_to_log
(cÚ¡ 
bŒfs_šode
 *
šode
)

260  
	`READ_ONCE
(
šode
->
fœ¡_dœ_šdex_to_log
);

261 
	}
}

263 
šlše
 
	$bŒfs_£t_fœ¡_dœ_šdex_to_log
(
bŒfs_šode
 *
šode
,

264 
u64
 
šdex
)

266 
	`WRITE_ONCE
(
šode
->
fœ¡_dœ_šdex_to_log
, 
šdex
);

267 
	}
}

269 
šlše
 
bŒfs_šode
 *
	$BTRFS_I
(cÚ¡ 
šode
 *inode)

271  
	`cÚš”_of
(
šode
, 
bŒfs_šode
, 
vfs_šode
);

272 
	}
}

274 
šlše
 
	$bŒfs_šode_hash
(
u64
 
objeùid
,

275 cÚ¡ 
bŒfs_roÙ
 *
roÙ
)

277 
u64
 
h
 = 
objeùid
 ^ (
roÙ
->
roÙ_key
.objeùid * 
GOLDEN_RATIO_PRIME
);

279 #ià
BITS_PER_LONG
 == 32

280 
h
 = (h >> 32) ^ (h & 0xffffffff);

283  ()
h
;

284 
	}
}

286 #ià
BITS_PER_LONG
 == 32

292 
šlše
 
u64
 
	$bŒfs_šo
(cÚ¡ 
bŒfs_šode
 *
šode
)

294 
u64
 
šo
 = 
šode
->
loÿtiÚ
.
objeùid
;

297 ià(
šode
->
loÿtiÚ
.
ty³
 =ğ
BTRFS_ROOT_ITEM_KEY
)

298 
šo
 = 
šode
->
vfs_šode
.
i_šo
;

299  
šo
;

300 
	}
}

304 
šlše
 
u64
 
	$bŒfs_šo
(cÚ¡ 
bŒfs_šode
 *
šode
)

306  
šode
->
vfs_šode
.
i_šo
;

307 
	}
}

311 
šlše
 
	$bŒfs_i_size_wr™e
(
bŒfs_šode
 *
šode
, 
u64
 
size
)

313 
	`i_size_wr™e
(&
šode
->
vfs_šode
, 
size
);

314 
šode
->
disk_i_size
 = 
size
;

315 
	}
}

317 
šlše
 
boŞ
 
	$bŒfs_is_ä“_¥aû_šode
(
bŒfs_šode
 *
šode
)

319  
	`‹¡_b™
(
BTRFS_INODE_FREE_SPACE_INODE
, &
šode
->
ruÁime_æags
);

320 
	}
}

322 
šlše
 
boŞ
 
	$is_d©a_šode
(
šode
 *inode)

324  
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)è!ğ
BTRFS_BTREE_INODE_OBJECTID
;

325 
	}
}

327 
šlše
 
	$bŒfs_mod_out¡ªdšg_ex‹Ás
(
bŒfs_šode
 *
šode
,

328 
mod
)

330 
	`lockd•_as£¹_h–d
(&
šode
->
lock
);

331 
šode
->
out¡ªdšg_ex‹Ás
 +ğ
mod
;

332 ià(
	`bŒfs_is_ä“_¥aû_šode
(
šode
))

334 
	`Œaû_bŒfs_šode_mod_out¡ªdšg_ex‹Ás
(
šode
->
roÙ
, 
	`bŒfs_šo
(inode),

335 
mod
, 
šode
->
out¡ªdšg_ex‹Ás
);

336 
	}
}

346 
šlše
 
	$bŒfs_£t_šode_Ï¡_sub_Œªs
(
bŒfs_šode
 *
šode
)

348 
	`¥š_lock
(&
šode
->
lock
);

349 
šode
->
Ï¡_sub_Œªs
 = inode->
roÙ
->
log_Œªsid
;

350 
	`¥š_uÆock
(&
šode
->
lock
);

351 
	}
}

358 
šlše
 
	$bŒfs_£t_šode_fuÎ_sync
(
bŒfs_šode
 *
šode
)

360 
	`£t_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
, &
šode
->
ruÁime_æags
);

377 
	`¥š_lock
(&
šode
->
lock
);

378 ià(
šode
->
Ï¡_»æšk_Œªs
 < inode->
Ï¡_Œªs
)

379 
šode
->
Ï¡_»æšk_Œªs
 = inode->
Ï¡_Œªs
;

380 
	`¥š_uÆock
(&
šode
->
lock
);

381 
	}
}

383 
šlše
 
boŞ
 
	$bŒfs_šode_š_log
(
bŒfs_šode
 *
šode
, 
u64
 
g’”©iÚ
)

385 
boŞ
 
»t
 = 
çl£
;

387 
	`¥š_lock
(&
šode
->
lock
);

388 ià(
šode
->
logged_Œªs
 =ğ
g’”©iÚ
 &&

389 
šode
->
Ï¡_sub_Œªs
 <ğšode->
Ï¡_log_comm™
 &&

390 
šode
->
Ï¡_sub_Œªs
 <ğšode->
roÙ
->
Ï¡_log_comm™
)

391 
»t
 = 
Œue
;

392 
	`¥š_uÆock
(&
šode
->
lock
);

393  
»t
;

394 
	}
}

399 
šlše
 
boŞ
 
	$bŒfs_šode_ÿn_com´ess
(cÚ¡ 
bŒfs_šode
 *
šode
)

401 ià(
šode
->
æags
 & 
BTRFS_INODE_NODATACOW
 ||

402 
šode
->
æags
 & 
BTRFS_INODE_NODATASUM
)

403  
çl£
;

404  
Œue
;

405 
	}
}

408 
	#CSUM_FMT
 "0x%*phN"

	)

409 
	#CSUM_FMT_VALUE
(
size
, 
by‹s
èsize, 
	)
bytes

411 
bŒfs_check_£ùÜ_csum
(
bŒfs_fs_šfo
 *
fs_šfo
, 
·ge
 *page,

412 
u32
 
pgoff
, 
u8
 *
csum
, cÚ¡ u8 * cÚ¡ 
csum_ex³ùed
);

413 
boŞ
 
bŒfs_d©a_csum_ok
(
bŒfs_bio
 *
bbio
, 
bŒfs_deviû
 *
dev
,

414 
u32
 
bio_off£t
, 
bio_vec
 *
bv
);

415 
nošlše
 
ÿn_nocow_ex‹Á
(
šode
 *šode, 
u64
 
off£t
, u64 *
Ën
,

416 
u64
 *
Üig_¡¬t
, u64 *
Üig_block_Ën
,

417 
u64
 *
¿m_by‹s
, 
boŞ
 
nowa™
, boŞ 
¡riù
);

419 
__bŒfs_d–_d–®loc_šode
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_šode
 *
šode
);

420 
šode
 *
bŒfs_lookup_d’Œy
(šod*
dœ
, 
d’Œy
 *dentry);

421 
bŒfs_£t_šode_šdex
(
bŒfs_šode
 *
dœ
, 
u64
 *
šdex
);

422 
bŒfs_uÆšk_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

423 
bŒfs_šode
 *
dœ
, bŒfs_šod*
šode
,

424 cÚ¡ 
fsüy±_¡r
 *
Çme
);

425 
bŒfs_add_lšk
(
bŒfs_Œªs_hªdË
 *
Œªs
,

426 
bŒfs_šode
 *
·»Á_šode
, bŒfs_šod*
šode
,

427 cÚ¡ 
fsüy±_¡r
 *
Çme
, 
add_back»f
, 
u64
 
šdex
);

428 
bŒfs_d–‘e_subvŞume
(
bŒfs_šode
 *
dœ
, 
d’Œy
 *dentry);

429 
bŒfs_Œunÿ‹_block
(
bŒfs_šode
 *
šode
, 
loff_t
 
äom
,†off_ˆ
Ën
,

430 
äÚt
);

432 
bŒfs_¡¬t_d–®loc_¢­shÙ
(
bŒfs_roÙ
 *
roÙ
, 
boŞ
 
š_»şaim_cÚ‹xt
);

433 
bŒfs_¡¬t_d–®loc_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
Ä
,

434 
boŞ
 
š_»şaim_cÚ‹xt
);

435 
bŒfs_£t_ex‹Á_d–®loc
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
,

436 
exŒa_b™s
,

437 
ex‹Á_¡©e
 **
ÿched_¡©e
);

439 
	sbŒfs_Ãw_šode_¬gs
 {

441 
šode
 *
	mdœ
;

443 
	mhas_loÿl_dœ
;

444 
šode
 *
	mloÿl_dœ
;

445 
šode
 *
	mloÿl_šode
;

446 
d’Œy
 *
	md’Œy
;

447 
šode
 *
	mšode
;

448 
boŞ
 
	mÜphª
;

449 
boŞ
 
	msubvŞ
;

452 
posix_aş
 *
	mdeçuÉ_aş
;

453 
posix_aş
 *
	maş
;

454 
fsüy±_Çme
 
	mâame
;

457 
bŒfs_Ãw_šode_´•¬e
(
bŒfs_Ãw_šode_¬gs
 *
¬gs
,

458 *
Œªs_num_™ems
);

459 
bŒfs_ü—‹_Ãw_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

460 
bŒfs_Ãw_šode_¬gs
 *
¬gs
);

461 
bŒfs_Ãw_šode_¬gs_de¡roy
(
bŒfs_Ãw_šode_¬gs
 *
¬gs
);

462 
šode
 *
bŒfs_Ãw_subvŞ_šode
(
mÁ_idm­
 *
idm­
,

463 
šode
 *
dœ
);

464 
bŒfs_£t_d–®loc_ex‹Á
(
bŒfs_šode
 *
šode
, 
ex‹Á_¡©e
 *
¡©e
,

465 
u32
 
b™s
);

466 
bŒfs_ş—r_d–®loc_ex‹Á
(
bŒfs_šode
 *
šode
,

467 
ex‹Á_¡©e
 *
¡©e
, 
u32
 
b™s
);

468 
bŒfs_m”ge_d–®loc_ex‹Á
(
bŒfs_šode
 *
šode
, 
ex‹Á_¡©e
 *
Ãw
,

469 
ex‹Á_¡©e
 *
Ùh”
);

470 
bŒfs_¥l™_d–®loc_ex‹Á
(
bŒfs_šode
 *
šode
,

471 
ex‹Á_¡©e
 *
Üig
, 
u64
 
¥l™
);

472 
bŒfs_£t_¿nge_wr™eback
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
);

473 
vm_çuÉ_t
 
bŒfs_·ge_mkwr™e
(
vm_çuÉ
 *
vmf
);

474 
bŒfs_eviù_šode
(
šode
 *inode);

475 
šode
 *
bŒfs_®loc_šode
(
su³r_block
 *
sb
);

476 
bŒfs_de¡roy_šode
(
šode
 *inode);

477 
bŒfs_ä“_šode
(
šode
 *inode);

478 
bŒfs_drİ_šode
(
šode
 *inode);

479 
__š™
 
bŒfs_š™_ÿch•
();

480 
__cŞd
 
bŒfs_de¡roy_ÿch•
();

481 
šode
 *
bŒfs_ig‘_·th
(
su³r_block
 *
s
, 
u64
 
šo
,

482 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
);

483 
šode
 *
bŒfs_ig‘
(
su³r_block
 *
s
, 
u64
 
šo
, 
bŒfs_roÙ
 *
roÙ
);

484 
ex‹Á_m­
 *
bŒfs_g‘_ex‹Á
(
bŒfs_šode
 *
šode
,

485 
·ge
 *·ge, 
size_t
 
pg_off£t
,

486 
u64
 
¡¬t
, u64 
’d
);

487 
bŒfs_upd©e_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

488 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_šode
 *
šode
);

489 
bŒfs_upd©e_šode_çÎback
(
bŒfs_Œªs_hªdË
 *
Œªs
,

490 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_šode
 *
šode
);

491 
bŒfs_Üphª_add
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_šode
 *
šode
);

492 
bŒfs_Üphª_ş—nup
(
bŒfs_roÙ
 *
roÙ
);

493 
bŒfs_cÚt_ex·nd
(
bŒfs_šode
 *
šode
, 
loff_t
 
Şdsize
,†off_ˆ
size
);

494 
bŒfs_add_d–ayed_ut
(
bŒfs_šode
 *
šode
);

495 
bŒfs_run_d–ayed_uts
(
bŒfs_fs_šfo
 *
fs_šfo
);

496 
bŒfs_wa™_Ú_d–ayed_uts
(
bŒfs_fs_šfo
 *
fs_šfo
);

497 
bŒfs_´—Îoc_fe_¿nge
(
šode
 *šode, 
mode
,

498 
u64
 
¡¬t
, u64 
num_by‹s
, u64 
mš_size
,

499 
loff_t
 
aùu®_Ën
, 
u64
 *
®loc_hšt
);

500 
bŒfs_´—Îoc_fe_¿nge_Œªs
(
šode
 *inode,

501 
bŒfs_Œªs_hªdË
 *
Œªs
, 
mode
,

502 
u64
 
¡¬t
, u64 
num_by‹s
, u64 
mš_size
,

503 
loff_t
 
aùu®_Ën
, 
u64
 *
®loc_hšt
);

504 
bŒfs_run_d–®loc_¿nge
(
bŒfs_šode
 *
šode
, 
·ge
 *
locked_·ge
,

505 
u64
 
¡¬t
, u64 
’d
, 
wr™eback_cÚŒŞ
 *
wbc
);

506 
bŒfs_wr™•age_cow_fixup
(
·ge
 *page);

507 
bŒfs_’coded_io_com´essiÚ_äom_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

508 
com´ess_ty³
);

509 
bŒfs_’coded_»ad_»guÏr_fl_·ges
(
bŒfs_šode
 *
šode
,

510 
u64
 
fe_off£t
, u64 
disk_by‹Ä
,

511 
u64
 
disk_io_size
,

512 
·ge
 **
·ges
);

513 
ssize_t
 
bŒfs_’coded_»ad
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
,

514 
bŒfs_ioùl_’coded_io_¬gs
 *
’coded
);

515 
ssize_t
 
bŒfs_do_’coded_wr™e
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
,

516 cÚ¡ 
bŒfs_ioùl_’coded_io_¬gs
 *
’coded
);

518 
ssize_t
 
bŒfs_dio_»ad
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
,

519 
size_t
 
dÚe_befÜe
);

520 
iom­_dio
 *
bŒfs_dio_wr™e
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
,

521 
size_t
 
dÚe_befÜe
);

523 cÚ¡ 
d’Œy_İ”©iÚs
 
bŒfs_d’Œy_İ”©iÚs
;

526 
	ebŒfs_ock_ty³
 {

527 
ENUM_BIT
(
BTRFS_ILOCK_SHARED
),

528 
ENUM_BIT
(
BTRFS_ILOCK_TRY
),

529 
ENUM_BIT
(
BTRFS_ILOCK_MMAP
),

532 
bŒfs_šode_lock
(
bŒfs_šode
 *
šode
, 
ock_æags
);

533 
bŒfs_šode_uÆock
(
bŒfs_šode
 *
šode
, 
ock_æags
);

534 
bŒfs_upd©e_šode_by‹s
(
bŒfs_šode
 *
šode
, cÚ¡ 
u64
 
add_by‹s
,

535 cÚ¡ 
u64
 
d–_by‹s
);

536 
bŒfs_as£¹_šode_¿nge_ş—n
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
);

	@calclock/calclock.c

5 
	~"ÿlşock.h
"

6 
	~<lšux/¦ab.h
>

8 cÚ¡ *
	$£·¿‹
(*
buf
, 
size_t
 
buf_Ën
)

10 *
»v”£d_buf
;

11 
cur
, 
couÁ”
 = 0, 
rvs_cur
 = 0;

13 
»v”£d_buf
 = 
	`km®loc
(
buf_Ën
, 
GFP_KERNEL
);

14 
cur
 = 
	`¡¾’
(
buf
);

15 --
cur
; cur > -1; cur--) {

16 ià(
couÁ”
 == 3) {

17 
»v”£d_buf
[
rvs_cur
++] = ',';

18 
couÁ”
 = 0;

19 
cur
++;

22 
»v”£d_buf
[
rvs_cur
++] = 
buf
[
cur
];

23 
couÁ”
++;

26 
cur
 = 0;

27 --
rvs_cur
;„vs_cur > -1;„vs_cur--)

28 
buf
[
cur
++] = 
»v”£d_buf
[
rvs_cur
];

30 
	`kä“
(
»v”£d_buf
);

31  
buf
;

32 
	}
}

42 
šlše
 cÚ¡ *
	$£p_num
(cÚ¡ 
ušt64_t
 
num
, *
buf
, 
size_t
 
buf_Ën
)

44 
	`mem£t
(
buf
, 0, 
buf_Ën
);

45 
	`¥rštf
(
buf
, "%Îu", 
num
);

46  
	`£·¿‹
(
buf
, 
buf_Ën
);

47 
	}
}

57 
šlše
 cÚ¡ *
	$£p_n£c
(cÚ¡ 
ktime_t
 
n£c
, *
buf
, 
size_t
 
buf_Ën
)

59 
	`mem£t
(
buf
, 0, 
buf_Ën
);

60 
	`¥rštf
(
buf
, "%Îd", 
n£c
);

61  
	`£·¿‹
(
buf
, 
buf_Ën
);

62 
	}
}

64 
	$__kršt
(
d•th
, *
â_Çme
, 
ktime_t
 
time
,

65 
ušt64_t
 
couÁ
, 
size_t
 
Ä_th»ads
)

67 
buff
[100], 
buff2
[100], 
buff3
[100];

68 
³rûÁage
;

69 
ktime_t
 
tÙ®time
 = 1;

71 ià(
	`ktime_befÜe
(
tÙ®time
, 
time
))

72 
tÙ®time
 = 
time
;

73 
³rûÁage
 = 
time
 * 10000 / 
tÙ®time
;

75 
	`´štk
("%s", "");

76 
d•th
--)

77 
	`´_cÚt
(" ");

78 
	`´_cÚt
("%s is called %simes,‡ndheime interval is %sns "

80 
â_Çme
, 
	`£p_num
(
couÁ
, 
buff
, (buff)),

81 
	`£p_n£c
(
	`ktime_to_ns
(
time
), 
buff2
, (buff2)),

82 
	`£p_n£c
(
	`ktime_to_ns
(
time
è/ (
Ä_th»ads
 ? : 1), 
buff3
, (buff3)),

83 
Ä_th»ads
, 
³rûÁage
 / 100,…ercentage % 100);

84 
	}
}

	@calclock/calclock.h

7 #iâdeà
__CALCLOCK_H


8 
	#__CALCLOCK_H


	)

10 
	~<lšux/ktime.h
>

11 
	~<lšux/³rıu.h
>

13 
	#CONFIG_CALCLOCK


	)

15 
	sÿlşock
 {

16 
ktime_t
 
	mtime
;

17 
	mcouÁ
;

20 
	#KTDEF
(
funúame
) \

21 
	`DEFINE_PER_CPU
(
ÿlşock
, 
funúame
##
_şock
èğ{0, 0}

	)

22 
	#KTDEC
(
funúame
) \

23 
	`DECLARE_PER_CPU
(
ÿlşock
, 
funúame
##
_şock
)

	)

25 #ifdeà
CONFIG_CALCLOCK


27 
šlše
 
	$ktg‘
(
ktime_t
 *
şock
)

29 *
şock
 = 
	`ktime_g‘_¿w
();

30 
	}
}

32 
šlše
 
	$__kut
(
ktime_t
 
loÿlşocks
[], 
ÿlşock
 *
şock
)

34 
ktime_t
 
diff
;

36 
	`WARN_ONCE
(
	`ktime_aá”
(
loÿlşocks
[0],†ocalclocks[1]),

38 
diff
 = 
	`ktime_sub
(
loÿlşocks
[1],†ocalclocks[0]);

39 
şock
->
time
 = 
	`ktime_add_§ã
(şock->time, 
diff
);

40 
şock
->
couÁ
++;

41 
	}
}

43 
	#kut
(
loÿlşocks
, 
funúame
) \

45 
ÿlşock
 *
şock
; \

47 
şock
 = 
	`g‘_ıu_±r
(&(
funúame
##
_şock
)); \

48 
	`__kut
(
loÿlşocks
, 
şock
); \

49 
	`put_ıu_±r
(&(
funúame
##
_şock
)); \

50 } 0)

	)

52 
__kršt
(
d•th
, *
â_Çme
, 
ktime_t
 
time
,

53 
ušt64_t
 
couÁ
, 
size_t
 
Ä_th»ads
);

55 
	#kršt
(
d•th
, 
funúame
) \

57 
ıu
; \

58 
ÿlşock
 *
şock
; \

59 
ktime_t
 
timesum
 = 0; \

60 
ušt64_t
 
couÁsum
 = 0; \

61 
size_t
 
th»ads
 = 0; \

63 
	`fÜ_—ch_Úlše_ıu
(
ıu
) { \

64 
şock
 = 
	`³r_ıu_±r
(&
funúame
##
_şock
, 
ıu
); \

65 
timesum
 +ğ
şock
->
time
; \

66 
couÁsum
 +ğ
şock
->
couÁ
; \

67 
th»ads
 +ğ!!
şock
->
couÁ
; \

69 
	`__kršt
(
d•th
, #funúame, 
timesum
, 
couÁsum
, 
th»ads
);\

70 } 0)

	)

73 
	#ktg‘
(
şock
èdØ{ ()(şock); } 0)

	)

74 
	#kut
(
loÿlşock
, 
funúame
èdØ{ } 0)

	)

75 
	#kršt
(
d•th
, 
funúame
èdØ{ } 0)

	)

	@check-integrity.c

78 
	~<lšux/sched.h
>

79 
	~<lšux/¦ab.h
>

80 
	~<lšux/mu‹x.h
>

81 
	~<lšux/blkdev.h
>

82 
	~<lšux/mm.h
>

83 
	~<lšux/¡ršg.h
>

84 
	~<üy±o/hash.h
>

85 
	~"mes§ges.h
"

86 
	~"ù»e.h
"

87 
	~"disk-io.h
"

88 
	~"Œª§ùiÚ.h
"

89 
	~"ex‹Á_io.h
"

90 
	~"vŞumes.h
"

91 
	~"´št-Œ“.h
"

92 
	~"lockšg.h
"

93 
	~"check-š‹gr™y.h
"

94 
	~"rcu-¡ršg.h
"

95 
	~"com´essiÚ.h
"

96 
	~"acûssÜs.h
"

98 
	#BTRFSIC_BLOCK_HASHTABLE_SIZE
 0x10000

	)

99 
	#BTRFSIC_BLOCK_LINK_HASHTABLE_SIZE
 0x10000

	)

100 
	#BTRFSIC_DEV2STATE_HASHTABLE_SIZE
 0x100

	)

101 
	#BTRFSIC_BLOCK_MAGIC_NUMBER
 0x14491051

	)

102 
	#BTRFSIC_BLOCK_LINK_MAGIC_NUMBER
 0x11070807

	)

103 
	#BTRFSIC_DEV2STATE_MAGIC_NUMBER
 0x20111530

	)

104 
	#BTRFSIC_BLOCK_STACK_FRAME_MAGIC_NUMBER
 20111300

	)

105 
	#BTRFSIC_TREE_DUMP_MAX_INDENT_LEVEL
 (200 - 6è

	)

107 
	#BTRFSIC_GENERATION_UNKNOWN
 ((
u64
)-1)

	)

113 
	#BTRFSIC_PRINT_MASK_SUPERBLOCK_WRITE
 0x00000001

	)

114 
	#BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
 0x00000002

	)

115 
	#BTRFSIC_PRINT_MASK_TREE_AFTER_SB_WRITE
 0x00000004

	)

116 
	#BTRFSIC_PRINT_MASK_TREE_BEFORE_SB_WRITE
 0x00000008

	)

117 
	#BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH
 0x00000010

	)

118 
	#BTRFSIC_PRINT_MASK_END_IO_BIO_BH
 0x00000020

	)

119 
	#BTRFSIC_PRINT_MASK_VERBOSE
 0x00000040

	)

120 
	#BTRFSIC_PRINT_MASK_VERY_VERBOSE
 0x00000080

	)

121 
	#BTRFSIC_PRINT_MASK_INITIAL_TREE
 0x00000100

	)

122 
	#BTRFSIC_PRINT_MASK_INITIAL_ALL_TREES
 0x00000200

	)

123 
	#BTRFSIC_PRINT_MASK_INITIAL_DATABASE
 0x00000400

	)

124 
	#BTRFSIC_PRINT_MASK_NUM_COPIES
 0x00000800

	)

125 
	#BTRFSIC_PRINT_MASK_TREE_WITH_ALL_MIRRORS
 0x00001000

	)

126 
	#BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH_VERBOSE
 0x00002000

	)

128 
	gbŒfsic_dev_¡©e
;

129 
	gbŒfsic_¡©e
;

131 
	sbŒfsic_block
 {

132 
u32
 
	mmagic_num
;

133 
	mis_m‘ad©a
:1;

134 
	mis_su³rblock
:1;

135 
	mis_iodÚe
:1;

136 
	miodÚe_w_”rÜ
:1;

137 
	mÃv”_wr™‹n
:1;

140 
	mmœrÜ_num
;

142 
bŒfsic_dev_¡©e
 *
	mdev_¡©e
;

143 
u64
 
	mdev_by‹Ä
;

144 
u64
 
	mlogiÿl_by‹Ä
;

145 
u64
 
	mg’”©iÚ
;

146 
bŒfs_disk_key
 
	mdisk_key
;

148 
li¡_h—d
 
	mcŞlisiÚ_»sŞvšg_node
;

149 
li¡_h—d
 
	m®l_blocks_node
;

152 
li¡_h—d
 
	m»f_to_li¡
;

153 
li¡_h—d
 
	m»f_äom_li¡
;

154 
bŒfsic_block
 *
	mÃxt_š_§me_bio
;

155 *
	mÜig_bio_´iv©e
;

156 
bio_’d_io_t
 *
	mÜig_bio_’d_io
;

157 
blk_İf_t
 
	msubm™_bio_bh_rw
;

158 
u64
 
	mæush_g’
;

172 
	sbŒfsic_block_lšk
 {

173 
u32
 
	mmagic_num
;

174 
u32
 
	m»f_út
;

175 
li¡_h—d
 
	mnode_»f_to
;

176 
li¡_h—d
 
	mnode_»f_äom
;

177 
li¡_h—d
 
	mcŞlisiÚ_»sŞvšg_node
;

178 
bŒfsic_block
 *
	mblock_»f_to
;

179 
bŒfsic_block
 *
	mblock_»f_äom
;

180 
u64
 
	m·»Á_g’”©iÚ
;

183 
	sbŒfsic_dev_¡©e
 {

184 
u32
 
	mmagic_num
;

185 
block_deviû
 *
	mbdev
;

186 
bŒfsic_¡©e
 *
	m¡©e
;

187 
li¡_h—d
 
	mcŞlisiÚ_»sŞvšg_node
;

188 
bŒfsic_block
 
	mdummy_block_fÜ_bio_bh_æush
;

189 
u64
 
	mÏ¡_æush_g’
;

192 
	sbŒfsic_block_hashbË
 {

193 
li¡_h—d
 
	mbË
[
BTRFSIC_BLOCK_HASHTABLE_SIZE
];

196 
	sbŒfsic_block_lšk_hashbË
 {

197 
li¡_h—d
 
	mbË
[
BTRFSIC_BLOCK_LINK_HASHTABLE_SIZE
];

200 
	sbŒfsic_dev_¡©e_hashbË
 {

201 
li¡_h—d
 
	mbË
[
BTRFSIC_DEV2STATE_HASHTABLE_SIZE
];

204 
	sbŒfsic_block_d©a_ùx
 {

205 
u64
 
	m¡¬t
;

206 
u64
 
	mdev_by‹Ä
;

207 
u32
 
	mËn
;

208 
bŒfsic_dev_¡©e
 *
	mdev
;

209 **
	md©av
;

210 
·ge
 **
	m·gev
;

211 *
	mmem_to_ä“
;

216 
	sbŒfsic_¡ack_äame
 {

217 
u32
 
	mmagic
;

218 
u32
 
	mÄ
;

219 
	m”rÜ
;

220 
	mi
;

221 
	mlim™_Ã¡šg
;

222 
	mnum_cİ›s
;

223 
	mmœrÜ_num
;

224 
bŒfsic_block
 *
	mblock
;

225 
bŒfsic_block_d©a_ùx
 *
	mblock_ùx
;

226 
bŒfsic_block
 *
	mÃxt_block
;

227 
bŒfsic_block_d©a_ùx
 
	mÃxt_block_ùx
;

228 
bŒfs_h—d”
 *
	mhdr
;

229 
bŒfsic_¡ack_äame
 *
	m´ev
;

233 
	sbŒfsic_¡©e
 {

234 
u32
 
	m´št_mask
;

235 
	mšşude_ex‹Á_d©a
;

236 
li¡_h—d
 
	m®l_blocks_li¡
;

237 
bŒfsic_block_hashbË
 
	mblock_hashbË
;

238 
bŒfsic_block_lšk_hashbË
 
	mblock_lšk_hashbË
;

239 
bŒfs_fs_šfo
 *
	mfs_šfo
;

240 
u64
 
	mmax_su³rblock_g’”©iÚ
;

241 
bŒfsic_block
 *
	mÏ‹¡_su³rblock
;

242 
u32
 
	mm‘ablock_size
;

243 
u32
 
	md©ablock_size
;

246 
bŒfsic_´oûss_m‘ablock
(
bŒfsic_¡©e
 *
¡©e
,

247 
bŒfsic_block
 *
block
,

248 
bŒfsic_block_d©a_ùx
 *
block_ùx
,

249 
lim™_Ã¡šg
, 
fÜû_iodÚe_æag
);

250 
bŒfsic_»ad_äom_block_d©a
(

251 
bŒfsic_block_d©a_ùx
 *
block_ùx
,

252 *
d¡
, 
u32
 
off£t
, 
size_t
 
Ën
);

253 
bŒfsic_ü—‹_lšk_to_Ãxt_block
(

254 
bŒfsic_¡©e
 *
¡©e
,

255 
bŒfsic_block
 *
block
,

256 
bŒfsic_block_d©a_ùx


257 *
block_ùx
, 
u64
 
Ãxt_by‹Ä
,

258 
lim™_Ã¡šg
,

259 
bŒfsic_block_d©a_ùx
 *
Ãxt_block_ùx
,

260 
bŒfsic_block
 **
Ãxt_blockp
,

261 
fÜû_iodÚe_æag
,

262 *
num_cİ›¥
, *
mœrÜ_nump
,

263 
bŒfs_disk_key
 *
disk_key
,

264 
u64
 
·»Á_g’”©iÚ
);

265 
bŒfsic_hªdË_ex‹Á_d©a
(
bŒfsic_¡©e
 *
¡©e
,

266 
bŒfsic_block
 *
block
,

267 
bŒfsic_block_d©a_ùx
 *
block_ùx
,

268 
u32
 
™em_off£t
, 
fÜû_iodÚe_æag
);

269 
bŒfsic_m­_block
(
bŒfsic_¡©e
 *
¡©e
, 
u64
 
by‹Ä
, 
u32
 
Ën
,

270 
bŒfsic_block_d©a_ùx
 *
block_ùx_out
,

271 
mœrÜ_num
);

272 
bŒfsic_»Ëa£_block_ùx
(
bŒfsic_block_d©a_ùx
 *
block_ùx
);

273 
bŒfsic_»ad_block
(
bŒfsic_¡©e
 *
¡©e
,

274 
bŒfsic_block_d©a_ùx
 *
block_ùx
);

275 
bŒfsic_´oûss_wr™‹n_su³rblock
(

276 
bŒfsic_¡©e
 *
¡©e
,

277 
bŒfsic_block
 *cÚ¡ 
block
,

278 
bŒfs_su³r_block
 *cÚ¡ 
su³r_hdr
);

279 
bŒfsic_bio_’d_io
(
bio
 *
bp
);

280 
bŒfsic_is_block_»f_by_su³rblock
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

281 cÚ¡ 
bŒfsic_block
 *
block
,

282 
»cursiÚ_Ëv–
);

283 
bŒfsic_check_®l_»f_blocks
(
bŒfsic_¡©e
 *
¡©e
,

284 
bŒfsic_block
 *cÚ¡ 
block
,

285 
»cursiÚ_Ëv–
);

286 
bŒfsic_´št_add_lšk
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

287 cÚ¡ 
bŒfsic_block_lšk
 *
l
);

288 
bŒfsic_´št_»m_lšk
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

289 cÚ¡ 
bŒfsic_block_lšk
 *
l
);

290 
bŒfsic_g‘_block_ty³
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

291 cÚ¡ 
bŒfsic_block
 *
block
);

292 
bŒfsic_dump_Œ“
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
);

293 
bŒfsic_dump_Œ“_sub
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

294 cÚ¡ 
bŒfsic_block
 *
block
,

295 
šd’t_Ëv–
);

296 
bŒfsic_block_lšk
 *
bŒfsic_block_lšk_lookup_Ü_add
(

297 
bŒfsic_¡©e
 *
¡©e
,

298 
bŒfsic_block_d©a_ùx
 *
Ãxt_block_ùx
,

299 
bŒfsic_block
 *
Ãxt_block
,

300 
bŒfsic_block
 *
äom_block
,

301 
u64
 
·»Á_g’”©iÚ
);

302 
bŒfsic_block
 *
bŒfsic_block_lookup_Ü_add
(

303 
bŒfsic_¡©e
 *
¡©e
,

304 
bŒfsic_block_d©a_ùx
 *
block_ùx
,

305 cÚ¡ *
add™iÚ®_¡ršg
,

306 
is_m‘ad©a
,

307 
is_iodÚe
,

308 
Ãv”_wr™‹n
,

309 
mœrÜ_num
,

310 *
was_ü—‹d
);

311 
bŒfsic_´oûss_su³rblock_dev_mœrÜ
(

312 
bŒfsic_¡©e
 *
¡©e
,

313 
bŒfsic_dev_¡©e
 *
dev_¡©e
,

314 
bŒfs_deviû
 *
deviû
,

315 
su³rblock_mœrÜ_num
,

316 
bŒfsic_dev_¡©e
 **
£Ëùed_dev_¡©e
,

317 
bŒfs_su³r_block
 *
£Ëùed_su³r
);

318 
bŒfsic_dev_¡©e
 *
bŒfsic_dev_¡©e_lookup
(
dev_t
 
dev
);

319 
bŒfsic_cmp_log_ªd_dev_by‹Ä
(
bŒfsic_¡©e
 *
¡©e
,

320 
u64
 
by‹Ä
,

321 
bŒfsic_dev_¡©e
 *
dev_¡©e
,

322 
u64
 
dev_by‹Ä
);

324 
mu‹x
 
	gbŒfsic_mu‹x
;

325 
	gbŒfsic_is_š™Ÿlized
;

326 
bŒfsic_dev_¡©e_hashbË
 
	gbŒfsic_dev_¡©e_hashbË
;

329 
	$bŒfsic_block_š™
(
bŒfsic_block
 *
b
)

331 
b
->
magic_num
 = 
BTRFSIC_BLOCK_MAGIC_NUMBER
;

332 
b
->
dev_¡©e
 = 
NULL
;

333 
b
->
dev_by‹Ä
 = 0;

334 
b
->
logiÿl_by‹Ä
 = 0;

335 
b
->
g’”©iÚ
 = 
BTRFSIC_GENERATION_UNKNOWN
;

336 
b
->
disk_key
.
objeùid
 = 0;

337 
b
->
disk_key
.
ty³
 = 0;

338 
b
->
disk_key
.
off£t
 = 0;

339 
b
->
is_m‘ad©a
 = 0;

340 
b
->
is_su³rblock
 = 0;

341 
b
->
is_iodÚe
 = 0;

342 
b
->
iodÚe_w_”rÜ
 = 0;

343 
b
->
Ãv”_wr™‹n
 = 0;

344 
b
->
mœrÜ_num
 = 0;

345 
b
->
Ãxt_š_§me_bio
 = 
NULL
;

346 
b
->
Üig_bio_´iv©e
 = 
NULL
;

347 
b
->
Üig_bio_’d_io
 = 
NULL
;

348 
	`INIT_LIST_HEAD
(&
b
->
cŞlisiÚ_»sŞvšg_node
);

349 
	`INIT_LIST_HEAD
(&
b
->
®l_blocks_node
);

350 
	`INIT_LIST_HEAD
(&
b
->
»f_to_li¡
);

351 
	`INIT_LIST_HEAD
(&
b
->
»f_äom_li¡
);

352 
b
->
subm™_bio_bh_rw
 = 0;

353 
b
->
æush_g’
 = 0;

354 
	}
}

356 
bŒfsic_block
 *
	$bŒfsic_block_®loc
()

358 
bŒfsic_block
 *
b
;

360 
b
 = 
	`kz®loc
((*b), 
GFP_NOFS
);

361 ià(
NULL
 !ğ
b
)

362 
	`bŒfsic_block_š™
(
b
);

364  
b
;

365 
	}
}

367 
	$bŒfsic_block_ä“
(
bŒfsic_block
 *
b
)

369 
	`BUG_ON
(!(
NULL
 =ğ
b
 || 
BTRFSIC_BLOCK_MAGIC_NUMBER
 =ğb->
magic_num
));

370 
	`kä“
(
b
);

371 
	}
}

373 
	$bŒfsic_block_lšk_š™
(
bŒfsic_block_lšk
 *
l
)

375 
l
->
magic_num
 = 
BTRFSIC_BLOCK_LINK_MAGIC_NUMBER
;

376 
l
->
»f_út
 = 1;

377 
	`INIT_LIST_HEAD
(&
l
->
node_»f_to
);

378 
	`INIT_LIST_HEAD
(&
l
->
node_»f_äom
);

379 
	`INIT_LIST_HEAD
(&
l
->
cŞlisiÚ_»sŞvšg_node
);

380 
l
->
block_»f_to
 = 
NULL
;

381 
l
->
block_»f_äom
 = 
NULL
;

382 
	}
}

384 
bŒfsic_block_lšk
 *
	$bŒfsic_block_lšk_®loc
()

386 
bŒfsic_block_lšk
 *
l
;

388 
l
 = 
	`kz®loc
((*l), 
GFP_NOFS
);

389 ià(
NULL
 !ğ
l
)

390 
	`bŒfsic_block_lšk_š™
(
l
);

392  
l
;

393 
	}
}

395 
	$bŒfsic_block_lšk_ä“
(
bŒfsic_block_lšk
 *
l
)

397 
	`BUG_ON
(!(
NULL
 =ğ
l
 || 
BTRFSIC_BLOCK_LINK_MAGIC_NUMBER
 =ğl->
magic_num
));

398 
	`kä“
(
l
);

399 
	}
}

401 
	$bŒfsic_dev_¡©e_š™
(
bŒfsic_dev_¡©e
 *
ds
)

403 
ds
->
magic_num
 = 
BTRFSIC_DEV2STATE_MAGIC_NUMBER
;

404 
ds
->
bdev
 = 
NULL
;

405 
ds
->
¡©e
 = 
NULL
;

406 
	`INIT_LIST_HEAD
(&
ds
->
cŞlisiÚ_»sŞvšg_node
);

407 
ds
->
Ï¡_æush_g’
 = 0;

408 
	`bŒfsic_block_š™
(&
ds
->
dummy_block_fÜ_bio_bh_æush
);

409 
ds
->
dummy_block_fÜ_bio_bh_æush
.
is_iodÚe
 = 1;

410 
ds
->
dummy_block_fÜ_bio_bh_æush
.
dev_¡©e
 = ds;

411 
	}
}

413 
bŒfsic_dev_¡©e
 *
	$bŒfsic_dev_¡©e_®loc
()

415 
bŒfsic_dev_¡©e
 *
ds
;

417 
ds
 = 
	`kz®loc
((*ds), 
GFP_NOFS
);

418 ià(
NULL
 !ğ
ds
)

419 
	`bŒfsic_dev_¡©e_š™
(
ds
);

421  
ds
;

422 
	}
}

424 
	$bŒfsic_dev_¡©e_ä“
(
bŒfsic_dev_¡©e
 *
ds
)

426 
	`BUG_ON
(!(
NULL
 =ğ
ds
 ||

427 
BTRFSIC_DEV2STATE_MAGIC_NUMBER
 =ğ
ds
->
magic_num
));

428 
	`kä“
(
ds
);

429 
	}
}

431 
	$bŒfsic_block_hashbË_š™
(
bŒfsic_block_hashbË
 *
h
)

433 
i
;

435 
i
 = 0; i < 
BTRFSIC_BLOCK_HASHTABLE_SIZE
; i++)

436 
	`INIT_LIST_HEAD
(
h
->
bË
 + 
i
);

437 
	}
}

439 
	$bŒfsic_block_hashbË_add
(
bŒfsic_block
 *
b
,

440 
bŒfsic_block_hashbË
 *
h
)

442 cÚ¡ 
hashv®
 =

443 ((()(
b
->
dev_by‹Ä
 >> 16)) ^

444 (()((
ušŒ_t
)
b
->
dev_¡©e
->
bdev
))) &

445 (
BTRFSIC_BLOCK_HASHTABLE_SIZE
 - 1);

447 
	`li¡_add
(&
b
->
cŞlisiÚ_»sŞvšg_node
, 
h
->
bË
 + 
hashv®
);

448 
	}
}

450 
	$bŒfsic_block_hashbË_»move
(
bŒfsic_block
 *
b
)

452 
	`li¡_d–
(&
b
->
cŞlisiÚ_»sŞvšg_node
);

453 
	}
}

455 
bŒfsic_block
 *
	$bŒfsic_block_hashbË_lookup
(

456 
block_deviû
 *
bdev
,

457 
u64
 
dev_by‹Ä
,

458 
bŒfsic_block_hashbË
 *
h
)

460 cÚ¡ 
hashv®
 =

461 ((()(
dev_by‹Ä
 >> 16)) ^

462 (()((
ušŒ_t
)
bdev
))) &

463 (
BTRFSIC_BLOCK_HASHTABLE_SIZE
 - 1);

464 
bŒfsic_block
 *
b
;

466 
	`li¡_fÜ_—ch_’Œy
(
b
, 
h
->
bË
 + 
hashv®
, 
cŞlisiÚ_»sŞvšg_node
) {

467 ià(
b
->
dev_¡©e
->
bdev
 =ğbdev && b->
dev_by‹Ä
 == dev_bytenr)

468  
b
;

471  
NULL
;

472 
	}
}

474 
	$bŒfsic_block_lšk_hashbË_š™
(

475 
bŒfsic_block_lšk_hashbË
 *
h
)

477 
i
;

479 
i
 = 0; i < 
BTRFSIC_BLOCK_LINK_HASHTABLE_SIZE
; i++)

480 
	`INIT_LIST_HEAD
(
h
->
bË
 + 
i
);

481 
	}
}

483 
	$bŒfsic_block_lšk_hashbË_add
(

484 
bŒfsic_block_lšk
 *
l
,

485 
bŒfsic_block_lšk_hashbË
 *
h
)

487 cÚ¡ 
hashv®
 =

488 ((()(
l
->
block_»f_to
->
dev_by‹Ä
 >> 16)) ^

489 (()(
l
->
block_»f_äom
->
dev_by‹Ä
 >> 16)) ^

490 (()((
ušŒ_t
)
l
->
block_»f_to
->
dev_¡©e
->
bdev
)) ^

491 (()((
ušŒ_t
)
l
->
block_»f_äom
->
dev_¡©e
->
bdev
)))

492 & (
BTRFSIC_BLOCK_LINK_HASHTABLE_SIZE
 - 1);

494 
	`BUG_ON
(
NULL
 =ğ
l
->
block_»f_to
);

495 
	`BUG_ON
(
NULL
 =ğ
l
->
block_»f_äom
);

496 
	`li¡_add
(&
l
->
cŞlisiÚ_»sŞvšg_node
, 
h
->
bË
 + 
hashv®
);

497 
	}
}

499 
	$bŒfsic_block_lšk_hashbË_»move
(
bŒfsic_block_lšk
 *
l
)

501 
	`li¡_d–
(&
l
->
cŞlisiÚ_»sŞvšg_node
);

502 
	}
}

504 
bŒfsic_block_lšk
 *
	$bŒfsic_block_lšk_hashbË_lookup
(

505 
block_deviû
 *
bdev_»f_to
,

506 
u64
 
dev_by‹Ä_»f_to
,

507 
block_deviû
 *
bdev_»f_äom
,

508 
u64
 
dev_by‹Ä_»f_äom
,

509 
bŒfsic_block_lšk_hashbË
 *
h
)

511 cÚ¡ 
hashv®
 =

512 ((()(
dev_by‹Ä_»f_to
 >> 16)) ^

513 (()(
dev_by‹Ä_»f_äom
 >> 16)) ^

514 (()((
ušŒ_t
)
bdev_»f_to
)) ^

515 (()((
ušŒ_t
)
bdev_»f_äom
))) &

516 (
BTRFSIC_BLOCK_LINK_HASHTABLE_SIZE
 - 1);

517 
bŒfsic_block_lšk
 *
l
;

519 
	`li¡_fÜ_—ch_’Œy
(
l
, 
h
->
bË
 + 
hashv®
, 
cŞlisiÚ_»sŞvšg_node
) {

520 
	`BUG_ON
(
NULL
 =ğ
l
->
block_»f_to
);

521 
	`BUG_ON
(
NULL
 =ğ
l
->
block_»f_äom
);

522 ià(
l
->
block_»f_to
->
dev_¡©e
->
bdev
 =ğ
bdev_»f_to
 &&

523 
l
->
block_»f_to
->
dev_by‹Ä
 =ğ
dev_by‹Ä_»f_to
 &&

524 
l
->
block_»f_äom
->
dev_¡©e
->
bdev
 =ğ
bdev_»f_äom
 &&

525 
l
->
block_»f_äom
->
dev_by‹Ä
 =ğ
dev_by‹Ä_»f_äom
)

526  
l
;

529  
NULL
;

530 
	}
}

532 
	$bŒfsic_dev_¡©e_hashbË_š™
(

533 
bŒfsic_dev_¡©e_hashbË
 *
h
)

535 
i
;

537 
i
 = 0; i < 
BTRFSIC_DEV2STATE_HASHTABLE_SIZE
; i++)

538 
	`INIT_LIST_HEAD
(
h
->
bË
 + 
i
);

539 
	}
}

541 
	$bŒfsic_dev_¡©e_hashbË_add
(

542 
bŒfsic_dev_¡©e
 *
ds
,

543 
bŒfsic_dev_¡©e_hashbË
 *
h
)

545 cÚ¡ 
hashv®
 =

546 ((()((
ušŒ_t
)
ds
->
bdev
->
bd_dev
)) &

547 (
BTRFSIC_DEV2STATE_HASHTABLE_SIZE
 - 1));

549 
	`li¡_add
(&
ds
->
cŞlisiÚ_»sŞvšg_node
, 
h
->
bË
 + 
hashv®
);

550 
	}
}

552 
	$bŒfsic_dev_¡©e_hashbË_»move
(
bŒfsic_dev_¡©e
 *
ds
)

554 
	`li¡_d–
(&
ds
->
cŞlisiÚ_»sŞvšg_node
);

555 
	}
}

557 
bŒfsic_dev_¡©e
 *
	$bŒfsic_dev_¡©e_hashbË_lookup
(
dev_t
 
dev
,

558 
bŒfsic_dev_¡©e_hashbË
 *
h
)

560 cÚ¡ 
hashv®
 =

561 
dev
 & (
BTRFSIC_DEV2STATE_HASHTABLE_SIZE
 - 1);

562 
bŒfsic_dev_¡©e
 *
ds
;

564 
	`li¡_fÜ_—ch_’Œy
(
ds
, 
h
->
bË
 + 
hashv®
, 
cŞlisiÚ_»sŞvšg_node
) {

565 ià(
ds
->
bdev
->
bd_dev
 =ğ
dev
)

566  
ds
;

569  
NULL
;

570 
	}
}

572 
	$bŒfsic_´oûss_su³rblock
(
bŒfsic_¡©e
 *
¡©e
,

573 
bŒfs_fs_deviûs
 *
fs_deviûs
)

575 
bŒfs_su³r_block
 *
£Ëùed_su³r
;

576 
li¡_h—d
 *
dev_h—d
 = &
fs_deviûs
->
deviûs
;

577 
bŒfs_deviû
 *
deviû
;

578 
bŒfsic_dev_¡©e
 *
£Ëùed_dev_¡©e
 = 
NULL
;

579 
»t
 = 0;

580 
·ss
;

582 
£Ëùed_su³r
 = 
	`kz®loc
((*£Ëùed_su³r), 
GFP_NOFS
);

583 ià(!
£Ëùed_su³r
)

584  -
ENOMEM
;

586 
	`li¡_fÜ_—ch_’Œy
(
deviû
, 
dev_h—d
, 
dev_li¡
) {

587 
i
;

588 
bŒfsic_dev_¡©e
 *
dev_¡©e
;

590 ià(!
deviû
->
bdev
 || !deviû->
Çme
)

593 
dev_¡©e
 = 
	`bŒfsic_dev_¡©e_lookup
(
deviû
->
bdev
->
bd_dev
);

594 
	`BUG_ON
(
NULL
 =ğ
dev_¡©e
);

595 
i
 = 0; i < 
BTRFS_SUPER_MIRROR_MAX
; i++) {

596 
»t
 = 
	`bŒfsic_´oûss_su³rblock_dev_mœrÜ
(

597 
¡©e
, 
dev_¡©e
, 
deviû
, 
i
,

598 &
£Ëùed_dev_¡©e
, 
£Ëùed_su³r
);

599 ià(0 !ğ
»t
 && 0 =ğ
i
) {

600 
	`kä“
(
£Ëùed_su³r
);

601  
»t
;

606 ià(
NULL
 =ğ
¡©e
->
Ï‹¡_su³rblock
) {

607 
	`´_šfo
("btrfsic:‚o superblock found!\n");

608 
	`kä“
(
£Ëùed_su³r
);

612 
·ss
 = 0;…ass < 3;…ass++) {

613 
num_cİ›s
;

614 
mœrÜ_num
;

615 
u64
 
Ãxt_by‹Ä
;

617 
·ss
) {

619 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_roÙ
(
£Ëùed_su³r
);

620 ià(
¡©e
->
´št_mask
 &

621 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

622 
	`´_šfo
("roÙ@%Îu\n", 
Ãxt_by‹Ä
);

625 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_chunk_roÙ
(
£Ëùed_su³r
);

626 ià(
¡©e
->
´št_mask
 &

627 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

628 
	`´_šfo
("chunk@%Îu\n", 
Ãxt_by‹Ä
);

631 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_log_roÙ
(
£Ëùed_su³r
);

632 ià(0 =ğ
Ãxt_by‹Ä
)

634 ià(
¡©e
->
´št_mask
 &

635 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

636 
	`´_šfo
("log@%Îu\n", 
Ãxt_by‹Ä
);

640 
num_cİ›s
 = 
	`bŒfs_num_cİ›s
(
¡©e
->
fs_šfo
, 
Ãxt_by‹Ä
,

641 
¡©e
->
m‘ablock_size
);

642 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_NUM_COPIES
)

643 
	`´_šfo
("num_copies(log_bytenr=%llu) = %d\n",

644 
Ãxt_by‹Ä
, 
num_cİ›s
);

646 
mœrÜ_num
 = 1; mœrÜ_num <ğ
num_cİ›s
; mirror_num++) {

647 
bŒfsic_block
 *
Ãxt_block
;

648 
bŒfsic_block_d©a_ùx
 
tmp_Ãxt_block_ùx
;

649 
bŒfsic_block_lšk
 *
l
;

651 
»t
 = 
	`bŒfsic_m­_block
(
¡©e
, 
Ãxt_by‹Ä
,

652 
¡©e
->
m‘ablock_size
,

653 &
tmp_Ãxt_block_ùx
,

654 
mœrÜ_num
);

655 ià(
»t
) {

656 
	`´_šfo
("btrfsic: btrfsic_map_block(root @%llu, mirror %d) failed!\n",

657 
Ãxt_by‹Ä
, 
mœrÜ_num
);

658 
	`kä“
(
£Ëùed_su³r
);

662 
Ãxt_block
 = 
	`bŒfsic_block_hashbË_lookup
(

663 
tmp_Ãxt_block_ùx
.
dev
->
bdev
,

664 
tmp_Ãxt_block_ùx
.
dev_by‹Ä
,

665 &
¡©e
->
block_hashbË
);

666 
	`BUG_ON
(
NULL
 =ğ
Ãxt_block
);

668 
l
 = 
	`bŒfsic_block_lšk_hashbË_lookup
(

669 
tmp_Ãxt_block_ùx
.
dev
->
bdev
,

670 
tmp_Ãxt_block_ùx
.
dev_by‹Ä
,

671 
¡©e
->
Ï‹¡_su³rblock
->
dev_¡©e
->

672 
bdev
,

673 
¡©e
->
Ï‹¡_su³rblock
->
dev_by‹Ä
,

674 &
¡©e
->
block_lšk_hashbË
);

675 
	`BUG_ON
(
NULL
 =ğ
l
);

677 
»t
 = 
	`bŒfsic_»ad_block
(
¡©e
, &
tmp_Ãxt_block_ùx
);

678 ià(
»t
 < ()
PAGE_SIZE
) {

679 
	`´_šfo
("btrfsic:„ead @logical %llu failed!\n",

680 
tmp_Ãxt_block_ùx
.
¡¬t
);

681 
	`bŒfsic_»Ëa£_block_ùx
(&
tmp_Ãxt_block_ùx
);

682 
	`kä“
(
£Ëùed_su³r
);

686 
»t
 = 
	`bŒfsic_´oûss_m‘ablock
(
¡©e
,

687 
Ãxt_block
,

688 &
tmp_Ãxt_block_ùx
,

689 
BTRFS_MAX_LEVEL
 + 3, 1);

690 
	`bŒfsic_»Ëa£_block_ùx
(&
tmp_Ãxt_block_ùx
);

694 
	`kä“
(
£Ëùed_su³r
);

695  
»t
;

696 
	}
}

698 
	$bŒfsic_´oûss_su³rblock_dev_mœrÜ
(

699 
bŒfsic_¡©e
 *
¡©e
,

700 
bŒfsic_dev_¡©e
 *
dev_¡©e
,

701 
bŒfs_deviû
 *
deviû
,

702 
su³rblock_mœrÜ_num
,

703 
bŒfsic_dev_¡©e
 **
£Ëùed_dev_¡©e
,

704 
bŒfs_su³r_block
 *
£Ëùed_su³r
)

706 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡©e
->fs_info;

707 
bŒfs_su³r_block
 *
su³r_tmp
;

708 
u64
 
dev_by‹Ä
;

709 
bŒfsic_block
 *
su³rblock_tmp
;

710 
·ss
;

711 
block_deviû
 *cÚ¡ 
su³rblock_bdev
 = 
deviû
->
bdev
;

712 
·ge
 *page;

713 
add»ss_¥aû
 *
m­pšg
 = 
su³rblock_bdev
->
bd_šode
->
i_m­pšg
;

714 
»t
 = 0;

717 
dev_by‹Ä
 = 
	`bŒfs_sb_off£t
(
su³rblock_mœrÜ_num
);

718 ià(
dev_by‹Ä
 + 
BTRFS_SUPER_INFO_SIZE
 > 
deviû
->
comm™_tÙ®_by‹s
)

721 
·ge
 = 
	`»ad_ÿche_·ge_gå
(
m­pšg
, 
dev_by‹Ä
 >> 
PAGE_SHIFT
, 
GFP_NOFS
);

722 ià(
	`IS_ERR
(
·ge
))

725 
su³r_tmp
 = 
	`·ge_add»ss
(
·ge
);

727 ià(
	`bŒfs_su³r_by‹Ä
(
su³r_tmp
è!ğ
dev_by‹Ä
 ||

728 
	`bŒfs_su³r_magic
(
su³r_tmp
è!ğ
BTRFS_MAGIC
 ||

729 
	`memcmp
(
deviû
->
uuid
, 
su³r_tmp
->
dev_™em
.uuid, 
BTRFS_UUID_SIZE
) ||

730 
	`bŒfs_su³r_nodesize
(
su³r_tmp
è!ğ
¡©e
->
m‘ablock_size
 ||

731 
	`bŒfs_su³r_£ùÜsize
(
su³r_tmp
è!ğ
¡©e
->
d©ablock_size
) {

732 
»t
 = 0;

733 
out
;

736 
su³rblock_tmp
 =

737 
	`bŒfsic_block_hashbË_lookup
(
su³rblock_bdev
,

738 
dev_by‹Ä
,

739 &
¡©e
->
block_hashbË
);

740 ià(
NULL
 =ğ
su³rblock_tmp
) {

741 
su³rblock_tmp
 = 
	`bŒfsic_block_®loc
();

742 ià(
NULL
 =ğ
su³rblock_tmp
) {

743 
»t
 = -1;

744 
out
;

747 
su³rblock_tmp
->
dev_by‹Ä
 = dev_bytenr;

748 
su³rblock_tmp
->
dev_¡©e
 = dev_state;

749 
su³rblock_tmp
->
logiÿl_by‹Ä
 = 
dev_by‹Ä
;

750 
su³rblock_tmp
->
g’”©iÚ
 = 
	`bŒfs_su³r_g’”©iÚ
(
su³r_tmp
);

751 
su³rblock_tmp
->
is_m‘ad©a
 = 1;

752 
su³rblock_tmp
->
is_su³rblock
 = 1;

753 
su³rblock_tmp
->
is_iodÚe
 = 1;

754 
su³rblock_tmp
->
Ãv”_wr™‹n
 = 0;

755 
su³rblock_tmp
->
mœrÜ_num
 = 1 + 
su³rblock_mœrÜ_num
;

756 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_SUPERBLOCK_WRITE
)

757 
	`bŒfs_šfo_š_rcu
(
fs_šfo
,

759 
su³rblock_bdev
,

760 
	`bŒfs_dev_Çme
(
deviû
), 
dev_by‹Ä
,

761 
dev_¡©e
->
bdev
, 
dev_by‹Ä
,

762 
su³rblock_mœrÜ_num
);

763 
	`li¡_add
(&
su³rblock_tmp
->
®l_blocks_node
,

764 &
¡©e
->
®l_blocks_li¡
);

765 
	`bŒfsic_block_hashbË_add
(
su³rblock_tmp
,

766 &
¡©e
->
block_hashbË
);

770 ià(
	`bŒfs_su³r_g’”©iÚ
(
su³r_tmp
) >

771 
¡©e
->
max_su³rblock_g’”©iÚ
 ||

772 0 =ğ
¡©e
->
max_su³rblock_g’”©iÚ
) {

773 
	`memıy
(
£Ëùed_su³r
, 
su³r_tmp
, (*selected_super));

774 *
£Ëùed_dev_¡©e
 = 
dev_¡©e
;

775 
¡©e
->
max_su³rblock_g’”©iÚ
 =

776 
	`bŒfs_su³r_g’”©iÚ
(
su³r_tmp
);

777 
¡©e
->
Ï‹¡_su³rblock
 = 
su³rblock_tmp
;

780 
·ss
 = 0;…ass < 3;…ass++) {

781 
u64
 
Ãxt_by‹Ä
;

782 
num_cİ›s
;

783 
mœrÜ_num
;

784 cÚ¡ *
add™iÚ®_¡ršg
 = 
NULL
;

785 
bŒfs_disk_key
 
tmp_disk_key
;

787 
tmp_disk_key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

788 
tmp_disk_key
.
off£t
 = 0;

789 
·ss
) {

791 
	`bŒfs_£t_disk_key_objeùid
(&
tmp_disk_key
,

792 
BTRFS_ROOT_TREE_OBJECTID
);

793 
add™iÚ®_¡ršg
 = "initial„oot ";

794 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_roÙ
(
su³r_tmp
);

797 
	`bŒfs_£t_disk_key_objeùid
(&
tmp_disk_key
,

798 
BTRFS_CHUNK_TREE_OBJECTID
);

799 
add™iÚ®_¡ršg
 = "initial chunk ";

800 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_chunk_roÙ
(
su³r_tmp
);

803 
	`bŒfs_£t_disk_key_objeùid
(&
tmp_disk_key
,

804 
BTRFS_TREE_LOG_OBJECTID
);

805 
add™iÚ®_¡ršg
 = "initial†og ";

806 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_log_roÙ
(
su³r_tmp
);

807 ià(0 =ğ
Ãxt_by‹Ä
)

812 
num_cİ›s
 = 
	`bŒfs_num_cİ›s
(
fs_šfo
, 
Ãxt_by‹Ä
,

813 
¡©e
->
m‘ablock_size
);

814 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_NUM_COPIES
)

815 
	`´_šfo
("num_copies(log_bytenr=%llu) = %d\n",

816 
Ãxt_by‹Ä
, 
num_cİ›s
);

817 
mœrÜ_num
 = 1; mœrÜ_num <ğ
num_cİ›s
; mirror_num++) {

818 
bŒfsic_block
 *
Ãxt_block
;

819 
bŒfsic_block_d©a_ùx
 
tmp_Ãxt_block_ùx
;

820 
bŒfsic_block_lšk
 *
l
;

822 ià(
	`bŒfsic_m­_block
(
¡©e
, 
Ãxt_by‹Ä
,

823 
¡©e
->
m‘ablock_size
,

824 &
tmp_Ãxt_block_ùx
,

825 
mœrÜ_num
)) {

826 
	`´_šfo
("btrfsic: btrfsic_map_block(bytenr @%llu, mirror %d) failed!\n",

827 
Ãxt_by‹Ä
, 
mœrÜ_num
);

828 
»t
 = -1;

829 
out
;

832 
Ãxt_block
 = 
	`bŒfsic_block_lookup_Ü_add
(

833 
¡©e
, &
tmp_Ãxt_block_ùx
,

834 
add™iÚ®_¡ršg
, 1, 1, 0,

835 
mœrÜ_num
, 
NULL
);

836 ià(
NULL
 =ğ
Ãxt_block
) {

837 
	`bŒfsic_»Ëa£_block_ùx
(&
tmp_Ãxt_block_ùx
);

838 
»t
 = -1;

839 
out
;

842 
Ãxt_block
->
disk_key
 = 
tmp_disk_key
;

843 
Ãxt_block
->
g’”©iÚ
 = 
BTRFSIC_GENERATION_UNKNOWN
;

844 
l
 = 
	`bŒfsic_block_lšk_lookup_Ü_add
(

845 
¡©e
, &
tmp_Ãxt_block_ùx
,

846 
Ãxt_block
, 
su³rblock_tmp
,

847 
BTRFSIC_GENERATION_UNKNOWN
);

848 
	`bŒfsic_»Ëa£_block_ùx
(&
tmp_Ãxt_block_ùx
);

849 ià(
NULL
 =ğ
l
) {

850 
»t
 = -1;

851 
out
;

855 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_INITIAL_ALL_TREES
)

856 
	`bŒfsic_dump_Œ“_sub
(
¡©e
, 
su³rblock_tmp
, 0);

858 
out
:

859 
	`put_·ge
(
·ge
);

860  
»t
;

861 
	}
}

863 
bŒfsic_¡ack_äame
 *
	$bŒfsic_¡ack_äame_®loc
()

865 
bŒfsic_¡ack_äame
 *
sf
;

867 
sf
 = 
	`kz®loc
((*sf), 
GFP_NOFS
);

868 ià(
sf
)

869 
sf
->
magic
 = 
BTRFSIC_BLOCK_STACK_FRAME_MAGIC_NUMBER
;

870  
sf
;

871 
	}
}

873 
	$bŒfsic_¡ack_äame_ä“
(
bŒfsic_¡ack_äame
 *
sf
)

875 
	`BUG_ON
(!(
NULL
 =ğ
sf
 ||

876 
BTRFSIC_BLOCK_STACK_FRAME_MAGIC_NUMBER
 =ğ
sf
->
magic
));

877 
	`kä“
(
sf
);

878 
	}
}

880 
nošlše_fÜ_¡ack
 
	$bŒfsic_´oûss_m‘ablock
(

881 
bŒfsic_¡©e
 *
¡©e
,

882 
bŒfsic_block
 *cÚ¡ 
fœ¡_block
,

883 
bŒfsic_block_d©a_ùx
 *cÚ¡ 
fœ¡_block_ùx
,

884 
fœ¡_lim™_Ã¡šg
, 
fÜû_iodÚe_æag
)

886 
bŒfsic_¡ack_äame
 
š™Ÿl_¡ack_äame
 = { 0 };

887 
bŒfsic_¡ack_äame
 *
sf
;

888 
bŒfsic_¡ack_äame
 *
Ãxt_¡ack
;

889 
bŒfs_h—d”
 *cÚ¡ 
fœ¡_hdr
 =

890 (
bŒfs_h—d”
 *)
fœ¡_block_ùx
->
d©av
[0];

892 
	`BUG_ON
(!
fœ¡_hdr
);

893 
sf
 = &
š™Ÿl_¡ack_äame
;

894 
sf
->
”rÜ
 = 0;

895 
sf
->
i
 = -1;

896 
sf
->
lim™_Ã¡šg
 = 
fœ¡_lim™_Ã¡šg
;

897 
sf
->
block
 = 
fœ¡_block
;

898 
sf
->
block_ùx
 = 
fœ¡_block_ùx
;

899 
sf
->
Ãxt_block
 = 
NULL
;

900 
sf
->
hdr
 = 
fœ¡_hdr
;

901 
sf
->
´ev
 = 
NULL
;

903 
cÚtšue_w™h_Ãw_¡ack_äame
:

904 
sf
->
block
->
g’”©iÚ
 = 
	`bŒfs_¡ack_h—d”_g’”©iÚ
(sf->
hdr
);

905 ià(0 =ğ
sf
->
hdr
->
Ëv–
) {

906 
bŒfs_Ëaf
 *cÚ¡ 
Ëafhdr
 =

907 (
bŒfs_Ëaf
 *)
sf
->
hdr
;

909 ià(-1 =ğ
sf
->
i
) {

910 
sf
->
Ä
 = 
	`bŒfs_¡ack_h—d”_Ä™ems
(&
Ëafhdr
->
h—d”
);

912 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

913 
	`´_šfo
("leaf %llu items %d generation %llu owner %llu\n",

914 
sf
->
block_ùx
->
¡¬t
, sf->
Ä
,

915 
	`bŒfs_¡ack_h—d”_g’”©iÚ
(

916 &
Ëafhdr
->
h—d”
),

917 
	`bŒfs_¡ack_h—d”_owÃr
(

918 &
Ëafhdr
->
h—d”
));

921 
cÚtšue_w™h_cu¼’t_Ëaf_¡ack_äame
:

922 ià(0 =ğ
sf
->
num_cİ›s
 || sf->
mœrÜ_num
 > sf->num_copies) {

923 
sf
->
i
++;

924 
sf
->
num_cİ›s
 = 0;

927 ià(
sf
->
i
 < sf->
Ä
) {

928 
bŒfs_™em
 
disk_™em
;

929 
u32
 
disk_™em_off£t
 =

930 (
ušŒ_t
)(
Ëafhdr
->
™ems
 + 
sf
->
i
) -

931 (
ušŒ_t
)
Ëafhdr
;

932 
bŒfs_disk_key
 *
disk_key
;

933 
u8
 
ty³
;

934 
u32
 
™em_off£t
;

935 
u32
 
™em_size
;

937 ià(
disk_™em_off£t
 + (
bŒfs_™em
) >

938 
sf
->
block_ùx
->
Ën
) {

939 
Ëaf_™em_out_of_bounû_”rÜ
:

940 
	`´_šfo
(

942 
sf
->
block_ùx
->
¡¬t
,

943 
sf
->
block_ùx
->
dev
->
bdev
);

944 
Úe_¡ack_äame_backw¬ds
;

946 
	`bŒfsic_»ad_äom_block_d©a
(
sf
->
block_ùx
,

947 &
disk_™em
,

948 
disk_™em_off£t
,

949 (
bŒfs_™em
));

950 
™em_off£t
 = 
	`bŒfs_¡ack_™em_off£t
(&
disk_™em
);

951 
™em_size
 = 
	`bŒfs_¡ack_™em_size
(&
disk_™em
);

952 
disk_key
 = &
disk_™em
.
key
;

953 
ty³
 = 
	`bŒfs_disk_key_ty³
(
disk_key
);

955 ià(
BTRFS_ROOT_ITEM_KEY
 =ğ
ty³
) {

956 
bŒfs_roÙ_™em
 
roÙ_™em
;

957 
u32
 
roÙ_™em_off£t
;

958 
u64
 
Ãxt_by‹Ä
;

960 
roÙ_™em_off£t
 = 
™em_off£t
 +

961 
	`off£tof
(
bŒfs_Ëaf
, 
™ems
);

962 ià(
roÙ_™em_off£t
 + 
™em_size
 >

963 
sf
->
block_ùx
->
Ën
)

964 
Ëaf_™em_out_of_bounû_”rÜ
;

965 
	`bŒfsic_»ad_äom_block_d©a
(

966 
sf
->
block_ùx
, &
roÙ_™em
,

967 
roÙ_™em_off£t
,

968 
™em_size
);

969 
Ãxt_by‹Ä
 = 
	`bŒfs_roÙ_by‹Ä
(&
roÙ_™em
);

971 
sf
->
”rÜ
 =

972 
	`bŒfsic_ü—‹_lšk_to_Ãxt_block
(

973 
¡©e
,

974 
sf
->
block
,

975 
sf
->
block_ùx
,

976 
Ãxt_by‹Ä
,

977 
sf
->
lim™_Ã¡šg
,

978 &
sf
->
Ãxt_block_ùx
,

979 &
sf
->
Ãxt_block
,

980 
fÜû_iodÚe_æag
,

981 &
sf
->
num_cİ›s
,

982 &
sf
->
mœrÜ_num
,

983 
disk_key
,

984 
	`bŒfs_roÙ_g’”©iÚ
(

985 &
roÙ_™em
));

986 ià(
sf
->
”rÜ
)

987 
Úe_¡ack_äame_backw¬ds
;

989 ià(
NULL
 !ğ
sf
->
Ãxt_block
) {

990 
bŒfs_h—d”
 *cÚ¡ 
Ãxt_hdr
 =

991 (
bŒfs_h—d”
 *)

992 
sf
->
Ãxt_block_ùx
.
d©av
[0];

994 
Ãxt_¡ack
 =

995 
	`bŒfsic_¡ack_äame_®loc
();

996 ià(
NULL
 =ğ
Ãxt_¡ack
) {

997 
sf
->
”rÜ
 = -1;

998 
	`bŒfsic_»Ëa£_block_ùx
(

999 &
sf
->

1000 
Ãxt_block_ùx
);

1001 
Úe_¡ack_äame_backw¬ds
;

1004 
Ãxt_¡ack
->
i
 = -1;

1005 
Ãxt_¡ack
->
block
 = 
sf
->
Ãxt_block
;

1006 
Ãxt_¡ack
->
block_ùx
 =

1007 &
sf
->
Ãxt_block_ùx
;

1008 
Ãxt_¡ack
->
Ãxt_block
 = 
NULL
;

1009 
Ãxt_¡ack
->
hdr
 = 
Ãxt_hdr
;

1010 
Ãxt_¡ack
->
lim™_Ã¡šg
 =

1011 
sf
->
lim™_Ã¡šg
 - 1;

1012 
Ãxt_¡ack
->
´ev
 = 
sf
;

1013 
sf
 = 
Ãxt_¡ack
;

1014 
cÚtšue_w™h_Ãw_¡ack_äame
;

1016 } ià(
BTRFS_EXTENT_DATA_KEY
 =ğ
ty³
 &&

1017 
¡©e
->
šşude_ex‹Á_d©a
) {

1018 
sf
->
”rÜ
 = 
	`bŒfsic_hªdË_ex‹Á_d©a
(

1019 
¡©e
,

1020 
sf
->
block
,

1021 
sf
->
block_ùx
,

1022 
™em_off£t
,

1023 
fÜû_iodÚe_æag
);

1024 ià(
sf
->
”rÜ
)

1025 
Úe_¡ack_äame_backw¬ds
;

1028 
cÚtšue_w™h_cu¼’t_Ëaf_¡ack_äame
;

1031 
bŒfs_node
 *cÚ¡ 
nodehdr
 = (bŒfs_nod*)
sf
->
hdr
;

1033 ià(-1 =ğ
sf
->
i
) {

1034 
sf
->
Ä
 = 
	`bŒfs_¡ack_h—d”_Ä™ems
(&
nodehdr
->
h—d”
);

1036 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1037 
	`´_šfo
("node %llu†evel %d items %d generation %llu owner %llu\n",

1038 
sf
->
block_ùx
->
¡¬t
,

1039 
nodehdr
->
h—d”
.
Ëv–
, 
sf
->
Ä
,

1040 
	`bŒfs_¡ack_h—d”_g’”©iÚ
(

1041 &
nodehdr
->
h—d”
),

1042 
	`bŒfs_¡ack_h—d”_owÃr
(

1043 &
nodehdr
->
h—d”
));

1046 
cÚtšue_w™h_cu¼’t_node_¡ack_äame
:

1047 ià(0 =ğ
sf
->
num_cİ›s
 || sf->
mœrÜ_num
 > sf->num_copies) {

1048 
sf
->
i
++;

1049 
sf
->
num_cİ›s
 = 0;

1052 ià(
sf
->
i
 < sf->
Ä
) {

1053 
bŒfs_key_±r
 
key_±r
;

1054 
u32
 
key_±r_off£t
;

1055 
u64
 
Ãxt_by‹Ä
;

1057 
key_±r_off£t
 = (
ušŒ_t
)(
nodehdr
->
±rs
 + 
sf
->
i
) -

1058 (
ušŒ_t
)
nodehdr
;

1059 ià(
key_±r_off£t
 + (
bŒfs_key_±r
) >

1060 
sf
->
block_ùx
->
Ën
) {

1061 
	`´_šfo
(

1063 
sf
->
block_ùx
->
¡¬t
,

1064 
sf
->
block_ùx
->
dev
->
bdev
);

1065 
Úe_¡ack_äame_backw¬ds
;

1067 
	`bŒfsic_»ad_äom_block_d©a
(

1068 
sf
->
block_ùx
, &
key_±r
, 
key_±r_off£t
,

1069 (
bŒfs_key_±r
));

1070 
Ãxt_by‹Ä
 = 
	`bŒfs_¡ack_key_block±r
(&
key_±r
);

1072 
sf
->
”rÜ
 = 
	`bŒfsic_ü—‹_lšk_to_Ãxt_block
(

1073 
¡©e
,

1074 
sf
->
block
,

1075 
sf
->
block_ùx
,

1076 
Ãxt_by‹Ä
,

1077 
sf
->
lim™_Ã¡šg
,

1078 &
sf
->
Ãxt_block_ùx
,

1079 &
sf
->
Ãxt_block
,

1080 
fÜû_iodÚe_æag
,

1081 &
sf
->
num_cİ›s
,

1082 &
sf
->
mœrÜ_num
,

1083 &
key_±r
.
key
,

1084 
	`bŒfs_¡ack_key_g’”©iÚ
(&
key_±r
));

1085 ià(
sf
->
”rÜ
)

1086 
Úe_¡ack_äame_backw¬ds
;

1088 ià(
NULL
 !ğ
sf
->
Ãxt_block
) {

1089 
bŒfs_h—d”
 *cÚ¡ 
Ãxt_hdr
 =

1090 (
bŒfs_h—d”
 *)

1091 
sf
->
Ãxt_block_ùx
.
d©av
[0];

1093 
Ãxt_¡ack
 = 
	`bŒfsic_¡ack_äame_®loc
();

1094 ià(
NULL
 =ğ
Ãxt_¡ack
) {

1095 
sf
->
”rÜ
 = -1;

1096 
Úe_¡ack_äame_backw¬ds
;

1099 
Ãxt_¡ack
->
i
 = -1;

1100 
Ãxt_¡ack
->
block
 = 
sf
->
Ãxt_block
;

1101 
Ãxt_¡ack
->
block_ùx
 = &
sf
->
Ãxt_block_ùx
;

1102 
Ãxt_¡ack
->
Ãxt_block
 = 
NULL
;

1103 
Ãxt_¡ack
->
hdr
 = 
Ãxt_hdr
;

1104 
Ãxt_¡ack
->
lim™_Ã¡šg
 =

1105 
sf
->
lim™_Ã¡šg
 - 1;

1106 
Ãxt_¡ack
->
´ev
 = 
sf
;

1107 
sf
 = 
Ãxt_¡ack
;

1108 
cÚtšue_w™h_Ãw_¡ack_äame
;

1111 
cÚtšue_w™h_cu¼’t_node_¡ack_äame
;

1115 
Úe_¡ack_äame_backw¬ds
:

1116 ià(
NULL
 !ğ
sf
->
´ev
) {

1117 
bŒfsic_¡ack_äame
 *cÚ¡ 
´ev
 = 
sf
->prev;

1120 
	`bŒfsic_»Ëa£_block_ùx
(
sf
->
block_ùx
);

1122 ià(
sf
->
”rÜ
) {

1123 
´ev
->
”rÜ
 = 
sf
->error;

1124 
	`bŒfsic_¡ack_äame_ä“
(
sf
);

1125 
sf
 = 
´ev
;

1126 
Úe_¡ack_äame_backw¬ds
;

1129 
	`bŒfsic_¡ack_äame_ä“
(
sf
);

1130 
sf
 = 
´ev
;

1131 
cÚtšue_w™h_Ãw_¡ack_äame
;

1133 
	`BUG_ON
(&
š™Ÿl_¡ack_äame
 !ğ
sf
);

1136  
sf
->
”rÜ
;

1137 
	}
}

1139 
	$bŒfsic_»ad_äom_block_d©a
(

1140 
bŒfsic_block_d©a_ùx
 *
block_ùx
,

1141 *
d¡v
, 
u32
 
off£t
, 
size_t
 
Ën
)

1143 
size_t
 
cur
;

1144 
size_t
 
pgoff
;

1145 *
kaddr
;

1146 *
d¡
 = (*)
d¡v
;

1147 
size_t
 
¡¬t_off£t
 = 
	`off£t_š_·ge
(
block_ùx
->
¡¬t
);

1148 
i
 = (
¡¬t_off£t
 + 
off£t
è>> 
PAGE_SHIFT
;

1150 
	`WARN_ON
(
off£t
 + 
Ën
 > 
block_ùx
->len);

1151 
pgoff
 = 
	`off£t_š_·ge
(
¡¬t_off£t
 + 
off£t
);

1153 
Ën
 > 0) {

1154 
cur
 = 
	`mš
(
Ën
, ((
size_t
)
PAGE_SIZE
 - 
pgoff
));

1155 
	`BUG_ON
(
i
 >ğ
	`DIV_ROUND_UP
(
block_ùx
->
Ën
, 
PAGE_SIZE
));

1156 
kaddr
 = 
block_ùx
->
d©av
[
i
];

1157 
	`memıy
(
d¡
, 
kaddr
 + 
pgoff
, 
cur
);

1159 
d¡
 +ğ
cur
;

1160 
Ën
 -ğ
cur
;

1161 
pgoff
 = 0;

1162 
i
++;

1164 
	}
}

1166 
	$bŒfsic_ü—‹_lšk_to_Ãxt_block
(

1167 
bŒfsic_¡©e
 *
¡©e
,

1168 
bŒfsic_block
 *
block
,

1169 
bŒfsic_block_d©a_ùx
 *
block_ùx
,

1170 
u64
 
Ãxt_by‹Ä
,

1171 
lim™_Ã¡šg
,

1172 
bŒfsic_block_d©a_ùx
 *
Ãxt_block_ùx
,

1173 
bŒfsic_block
 **
Ãxt_blockp
,

1174 
fÜû_iodÚe_æag
,

1175 *
num_cİ›¥
, *
mœrÜ_nump
,

1176 
bŒfs_disk_key
 *
disk_key
,

1177 
u64
 
·»Á_g’”©iÚ
)

1179 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡©e
->fs_info;

1180 
bŒfsic_block
 *
Ãxt_block
 = 
NULL
;

1181 
»t
;

1182 
bŒfsic_block_lšk
 *
l
;

1183 
did_®loc_block_lšk
;

1184 
block_was_ü—‹d
;

1186 *
Ãxt_blockp
 = 
NULL
;

1187 ià(0 =ğ*
num_cİ›¥
) {

1188 *
num_cİ›¥
 = 
	`bŒfs_num_cİ›s
(
fs_šfo
, 
Ãxt_by‹Ä
,

1189 
¡©e
->
m‘ablock_size
);

1190 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_NUM_COPIES
)

1191 
	`´_šfo
("num_copies(log_bytenr=%llu) = %d\n",

1192 
Ãxt_by‹Ä
, *
num_cİ›¥
);

1193 *
mœrÜ_nump
 = 1;

1196 ià(*
mœrÜ_nump
 > *
num_cİ›¥
)

1199 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1200 
	`´_šfo
("btrfsic_create_link_to_next_block(mirror_num=%d)\n",

1201 *
mœrÜ_nump
);

1202 
»t
 = 
	`bŒfsic_m­_block
(
¡©e
, 
Ãxt_by‹Ä
,

1203 
¡©e
->
m‘ablock_size
,

1204 
Ãxt_block_ùx
, *
mœrÜ_nump
);

1205 ià(
»t
) {

1206 
	`´_šfo
("btrfsic: btrfsic_map_block(@%llu, mirror=%d) failed!\n",

1207 
Ãxt_by‹Ä
, *
mœrÜ_nump
);

1208 
	`bŒfsic_»Ëa£_block_ùx
(
Ãxt_block_ùx
);

1209 *
Ãxt_blockp
 = 
NULL
;

1213 
Ãxt_block
 = 
	`bŒfsic_block_lookup_Ü_add
(
¡©e
,

1214 
Ãxt_block_ùx
, "referenced ",

1215 1, 
fÜû_iodÚe_æag
,

1216 !
fÜû_iodÚe_æag
,

1217 *
mœrÜ_nump
,

1218 &
block_was_ü—‹d
);

1219 ià(
NULL
 =ğ
Ãxt_block
) {

1220 
	`bŒfsic_»Ëa£_block_ùx
(
Ãxt_block_ùx
);

1221 *
Ãxt_blockp
 = 
NULL
;

1224 ià(
block_was_ü—‹d
) {

1225 
l
 = 
NULL
;

1226 
Ãxt_block
->
g’”©iÚ
 = 
BTRFSIC_GENERATION_UNKNOWN
;

1228 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
) {

1229 ià(
Ãxt_block
->
logiÿl_by‹Ä
 !ğ
Ãxt_by‹Ä
 &&

1230 !(!
Ãxt_block
->
is_m‘ad©a
 &&

1231 0 =ğ
Ãxt_block
->
logiÿl_by‹Ä
))

1232 
	`´_šfo
(

1234 
Ãxt_by‹Ä
, 
Ãxt_block_ùx
->
dev
->
bdev
,

1235 
Ãxt_block_ùx
->
dev_by‹Ä
, *
mœrÜ_nump
,

1236 
	`bŒfsic_g‘_block_ty³
(
¡©e
,

1237 
Ãxt_block
),

1238 
Ãxt_block
->
logiÿl_by‹Ä
);

1240 
	`´_šfo
(

1242 
Ãxt_by‹Ä
, 
Ãxt_block_ùx
->
dev
->
bdev
,

1243 
Ãxt_block_ùx
->
dev_by‹Ä
, *
mœrÜ_nump
,

1244 
	`bŒfsic_g‘_block_ty³
(
¡©e
,

1245 
Ãxt_block
));

1247 
Ãxt_block
->
logiÿl_by‹Ä
 = 
Ãxt_by‹Ä
;

1249 
Ãxt_block
->
mœrÜ_num
 = *
mœrÜ_nump
;

1250 
l
 = 
	`bŒfsic_block_lšk_hashbË_lookup
(

1251 
Ãxt_block_ùx
->
dev
->
bdev
,

1252 
Ãxt_block_ùx
->
dev_by‹Ä
,

1253 
block_ùx
->
dev
->
bdev
,

1254 
block_ùx
->
dev_by‹Ä
,

1255 &
¡©e
->
block_lšk_hashbË
);

1258 
Ãxt_block
->
disk_key
 = *disk_key;

1259 ià(
NULL
 =ğ
l
) {

1260 
l
 = 
	`bŒfsic_block_lšk_®loc
();

1261 ià(
NULL
 =ğ
l
) {

1262 
	`bŒfsic_»Ëa£_block_ùx
(
Ãxt_block_ùx
);

1263 *
Ãxt_blockp
 = 
NULL
;

1267 
did_®loc_block_lšk
 = 1;

1268 
l
->
block_»f_to
 = 
Ãxt_block
;

1269 
l
->
block_»f_äom
 = 
block
;

1270 
l
->
»f_út
 = 1;

1271 
l
->
·»Á_g’”©iÚ
 =…arent_generation;

1273 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1274 
	`bŒfsic_´št_add_lšk
(
¡©e
, 
l
);

1276 
	`li¡_add
(&
l
->
node_»f_to
, &
block
->
»f_to_li¡
);

1277 
	`li¡_add
(&
l
->
node_»f_äom
, &
Ãxt_block
->
»f_äom_li¡
);

1279 
	`bŒfsic_block_lšk_hashbË_add
(
l
,

1280 &
¡©e
->
block_lšk_hashbË
);

1282 
did_®loc_block_lšk
 = 0;

1283 ià(0 =ğ
lim™_Ã¡šg
) {

1284 
l
->
»f_út
++;

1285 
l
->
·»Á_g’”©iÚ
 =…arent_generation;

1286 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1287 
	`bŒfsic_´št_add_lšk
(
¡©e
, 
l
);

1291 ià(
lim™_Ã¡šg
 > 0 && 
did_®loc_block_lšk
) {

1292 
»t
 = 
	`bŒfsic_»ad_block
(
¡©e
, 
Ãxt_block_ùx
);

1293 ià(
»t
 < ()
Ãxt_block_ùx
->
Ën
) {

1294 
	`´_šfo
("btrfsic:„ead block @logical %llu failed!\n",

1295 
Ãxt_by‹Ä
);

1296 
	`bŒfsic_»Ëa£_block_ùx
(
Ãxt_block_ùx
);

1297 *
Ãxt_blockp
 = 
NULL
;

1301 *
Ãxt_blockp
 = 
Ãxt_block
;

1303 *
Ãxt_blockp
 = 
NULL
;

1305 (*
mœrÜ_nump
)++;

1308 
	}
}

1310 
	$bŒfsic_hªdË_ex‹Á_d©a
(

1311 
bŒfsic_¡©e
 *
¡©e
,

1312 
bŒfsic_block
 *
block
,

1313 
bŒfsic_block_d©a_ùx
 *
block_ùx
,

1314 
u32
 
™em_off£t
, 
fÜû_iodÚe_æag
)

1316 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡©e
->fs_info;

1317 
bŒfs_fe_ex‹Á_™em
 
fe_ex‹Á_™em
;

1318 
u64
 
fe_ex‹Á_™em_off£t
;

1319 
u64
 
Ãxt_by‹Ä
;

1320 
u64
 
num_by‹s
;

1321 
u64
 
g’”©iÚ
;

1322 
bŒfsic_block_lšk
 *
l
;

1323 
»t
;

1325 
fe_ex‹Á_™em_off£t
 = 
	`off£tof
(
bŒfs_Ëaf
, 
™ems
) +

1326 
™em_off£t
;

1327 ià(
fe_ex‹Á_™em_off£t
 +

1328 
	`off£tof
(
bŒfs_fe_ex‹Á_™em
, 
disk_num_by‹s
) >

1329 
block_ùx
->
Ën
) {

1330 
	`´_šfo
("btrfsic: file item out of bounce‡t†ogical %llu, dev %pg\n",

1331 
block_ùx
->
¡¬t
, block_ùx->
dev
->
bdev
);

1335 
	`bŒfsic_»ad_äom_block_d©a
(
block_ùx
, &
fe_ex‹Á_™em
,

1336 
fe_ex‹Á_™em_off£t
,

1337 
	`off£tof
(
bŒfs_fe_ex‹Á_™em
, 
disk_num_by‹s
));

1338 ià(
BTRFS_FILE_EXTENT_REG
 !ğ
fe_ex‹Á_™em
.
ty³
 ||

1339 
	`bŒfs_¡ack_fe_ex‹Á_disk_by‹Ä
(&
fe_ex‹Á_™em
) == 0) {

1340 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERY_VERBOSE
)

1341 
	`´_šfo
("extent_data:ype %u, disk_bytenr = %llu\n",

1342 
fe_ex‹Á_™em
.
ty³
,

1343 
	`bŒfs_¡ack_fe_ex‹Á_disk_by‹Ä
(

1344 &
fe_ex‹Á_™em
));

1348 ià(
fe_ex‹Á_™em_off£t
 + (
bŒfs_fe_ex‹Á_™em
) >

1349 
block_ùx
->
Ën
) {

1350 
	`´_šfo
("btrfsic: file item out of bounce‡t†ogical %llu, dev %pg\n",

1351 
block_ùx
->
¡¬t
, block_ùx->
dev
->
bdev
);

1354 
	`bŒfsic_»ad_äom_block_d©a
(
block_ùx
, &
fe_ex‹Á_™em
,

1355 
fe_ex‹Á_™em_off£t
,

1356 (
bŒfs_fe_ex‹Á_™em
));

1357 
Ãxt_by‹Ä
 = 
	`bŒfs_¡ack_fe_ex‹Á_disk_by‹Ä
(&
fe_ex‹Á_™em
);

1358 ià(
	`bŒfs_¡ack_fe_ex‹Á_com´essiÚ
(&
fe_ex‹Á_™em
) ==

1359 
BTRFS_COMPRESS_NONE
) {

1360 
Ãxt_by‹Ä
 +ğ
	`bŒfs_¡ack_fe_ex‹Á_off£t
(&
fe_ex‹Á_™em
);

1361 
num_by‹s
 = 
	`bŒfs_¡ack_fe_ex‹Á_num_by‹s
(&
fe_ex‹Á_™em
);

1363 
num_by‹s
 = 
	`bŒfs_¡ack_fe_ex‹Á_disk_num_by‹s
(&
fe_ex‹Á_™em
);

1365 
g’”©iÚ
 = 
	`bŒfs_¡ack_fe_ex‹Á_g’”©iÚ
(&
fe_ex‹Á_™em
);

1367 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERY_VERBOSE
)

1368 
	`´_šfo
("extent_data:ype %u, disk_bytenr = %llu, offset = %llu,‚um_bytes = %llu\n",

1369 
fe_ex‹Á_™em
.
ty³
,

1370 
	`bŒfs_¡ack_fe_ex‹Á_disk_by‹Ä
(&
fe_ex‹Á_™em
),

1371 
	`bŒfs_¡ack_fe_ex‹Á_off£t
(&
fe_ex‹Á_™em
),

1372 
num_by‹s
);

1373 
num_by‹s
 > 0) {

1374 
u32
 
chunk_Ën
;

1375 
num_cİ›s
;

1376 
mœrÜ_num
;

1378 ià(
num_by‹s
 > 
¡©e
->
d©ablock_size
)

1379 
chunk_Ën
 = 
¡©e
->
d©ablock_size
;

1381 
chunk_Ën
 = 
num_by‹s
;

1383 
num_cİ›s
 = 
	`bŒfs_num_cİ›s
(
fs_šfo
, 
Ãxt_by‹Ä
,

1384 
¡©e
->
d©ablock_size
);

1385 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_NUM_COPIES
)

1386 
	`´_šfo
("num_copies(log_bytenr=%llu) = %d\n",

1387 
Ãxt_by‹Ä
, 
num_cİ›s
);

1388 
mœrÜ_num
 = 1; mœrÜ_num <ğ
num_cİ›s
; mirror_num++) {

1389 
bŒfsic_block_d©a_ùx
 
Ãxt_block_ùx
;

1390 
bŒfsic_block
 *
Ãxt_block
;

1391 
block_was_ü—‹d
;

1393 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1394 
	`´_šfo
("btrfsic_handle_extent_data(mirror_num=%d)\n",

1395 
mœrÜ_num
);

1396 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERY_VERBOSE
)

1397 
	`´_šfo
("\tdisk_bytenr = %llu,‚um_bytes %u\n",

1398 
Ãxt_by‹Ä
, 
chunk_Ën
);

1399 
»t
 = 
	`bŒfsic_m­_block
(
¡©e
, 
Ãxt_by‹Ä
,

1400 
chunk_Ën
, &
Ãxt_block_ùx
,

1401 
mœrÜ_num
);

1402 ià(
»t
) {

1403 
	`´_šfo
("btrfsic: btrfsic_map_block(@%llu, mirror=%d) failed!\n",

1404 
Ãxt_by‹Ä
, 
mœrÜ_num
);

1408 
Ãxt_block
 = 
	`bŒfsic_block_lookup_Ü_add
(

1409 
¡©e
,

1410 &
Ãxt_block_ùx
,

1413 
fÜû_iodÚe_æag
,

1414 !
fÜû_iodÚe_æag
,

1415 
mœrÜ_num
,

1416 &
block_was_ü—‹d
);

1417 ià(
NULL
 =ğ
Ãxt_block
) {

1418 
	`bŒfsic_»Ëa£_block_ùx
(&
Ãxt_block_ùx
);

1421 ià(!
block_was_ü—‹d
) {

1422 ià((
¡©e
->
´št_mask
 &

1423 
BTRFSIC_PRINT_MASK_VERBOSE
) &&

1424 
Ãxt_block
->
logiÿl_by‹Ä
 !ğ
Ãxt_by‹Ä
 &&

1425 !(!
Ãxt_block
->
is_m‘ad©a
 &&

1426 0 =ğ
Ãxt_block
->
logiÿl_by‹Ä
)) {

1427 
	`´_šfo
(

1429 
Ãxt_by‹Ä
,

1430 
Ãxt_block_ùx
.
dev
->
bdev
,

1431 
Ãxt_block_ùx
.
dev_by‹Ä
,

1432 
mœrÜ_num
,

1433 
Ãxt_block
->
logiÿl_by‹Ä
);

1435 
Ãxt_block
->
logiÿl_by‹Ä
 = 
Ãxt_by‹Ä
;

1436 
Ãxt_block
->
mœrÜ_num
 = mirror_num;

1439 
l
 = 
	`bŒfsic_block_lšk_lookup_Ü_add
(
¡©e
,

1440 &
Ãxt_block_ùx
,

1441 
Ãxt_block
, 
block
,

1442 
g’”©iÚ
);

1443 
	`bŒfsic_»Ëa£_block_ùx
(&
Ãxt_block_ùx
);

1444 ià(
NULL
 =ğ
l
)

1448 
Ãxt_by‹Ä
 +ğ
chunk_Ën
;

1449 
num_by‹s
 -ğ
chunk_Ën
;

1453 
	}
}

1455 
	$bŒfsic_m­_block
(
bŒfsic_¡©e
 *
¡©e
, 
u64
 
by‹Ä
, 
u32
 
Ën
,

1456 
bŒfsic_block_d©a_ùx
 *
block_ùx_out
,

1457 
mœrÜ_num
)

1459 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡©e
->fs_info;

1460 
»t
;

1461 
u64
 
Ëngth
;

1462 
bŒfs_io_cÚ‹xt
 *
bioc
 = 
NULL
;

1463 
bŒfs_io_¡re
 
sm­
, *
m­
;

1464 
bŒfs_deviû
 *
deviû
;

1466 
Ëngth
 = 
Ën
;

1467 
»t
 = 
	`bŒfs_m­_block
(
fs_šfo
, 
BTRFS_MAP_READ
, 
by‹Ä
, &
Ëngth
, &
bioc
,

1468 
NULL
, &
mœrÜ_num
, 0);

1469 ià(
»t
) {

1470 
block_ùx_out
->
¡¬t
 = 0;

1471 
block_ùx_out
->
dev_by‹Ä
 = 0;

1472 
block_ùx_out
->
Ën
 = 0;

1473 
block_ùx_out
->
dev
 = 
NULL
;

1474 
block_ùx_out
->
d©av
 = 
NULL
;

1475 
block_ùx_out
->
·gev
 = 
NULL
;

1476 
block_ùx_out
->
mem_to_ä“
 = 
NULL
;

1478  
»t
;

1481 ià(
bioc
)

1482 
m­
 = &
bioc
->
¡res
[0];

1484 
m­
 = &
sm­
;

1486 
deviû
 = 
m­
->
dev
;

1487 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
, &
deviû
->
dev_¡©e
) ||

1488 !
deviû
->
bdev
 || !deviû->
Çme
)

1489 
block_ùx_out
->
dev
 = 
NULL
;

1491 
block_ùx_out
->
dev
 = 
	`bŒfsic_dev_¡©e_lookup
(

1492 
deviû
->
bdev
->
bd_dev
);

1493 
block_ùx_out
->
dev_by‹Ä
 = 
m­
->
physiÿl
;

1494 
block_ùx_out
->
¡¬t
 = 
by‹Ä
;

1495 
block_ùx_out
->
Ën
 =†en;

1496 
block_ùx_out
->
d©av
 = 
NULL
;

1497 
block_ùx_out
->
·gev
 = 
NULL
;

1498 
block_ùx_out
->
mem_to_ä“
 = 
NULL
;

1500 
	`kä“
(
bioc
);

1501 ià(
NULL
 =ğ
block_ùx_out
->
dev
) {

1502 
»t
 = -
ENXIO
;

1503 
	`´_šfo
("btrfsic:ƒrror, cannot†ookup dev (#1)!\n");

1506  
»t
;

1507 
	}
}

1509 
	$bŒfsic_»Ëa£_block_ùx
(
bŒfsic_block_d©a_ùx
 *
block_ùx
)

1511 ià(
block_ùx
->
mem_to_ä“
) {

1512 
num_·ges
;

1514 
	`BUG_ON
(!
block_ùx
->
d©av
);

1515 
	`BUG_ON
(!
block_ùx
->
·gev
);

1516 
num_·ges
 = (
block_ùx
->
Ën
 + (
u64
)
PAGE_SIZE
 - 1) >>

1517 
PAGE_SHIFT
;

1519 
num_·ges
 > 0) {

1520 
num_·ges
--;

1521 ià(
block_ùx
->
d©av
[
num_·ges
])

1522 
block_ùx
->
d©av
[
num_·ges
] = 
NULL
;

1523 ià(
block_ùx
->
·gev
[
num_·ges
]) {

1524 
	`__ä“_·ge
(
block_ùx
->
·gev
[
num_·ges
]);

1525 
block_ùx
->
·gev
[
num_·ges
] = 
NULL
;

1529 
	`kä“
(
block_ùx
->
mem_to_ä“
);

1530 
block_ùx
->
mem_to_ä“
 = 
NULL
;

1531 
block_ùx
->
·gev
 = 
NULL
;

1532 
block_ùx
->
d©av
 = 
NULL
;

1534 
	}
}

1536 
	$bŒfsic_»ad_block
(
bŒfsic_¡©e
 *
¡©e
,

1537 
bŒfsic_block_d©a_ùx
 *
block_ùx
)

1539 
num_·ges
;

1540 
i
;

1541 
size_t
 
size
;

1542 
u64
 
dev_by‹Ä
;

1543 
»t
;

1545 
	`BUG_ON
(
block_ùx
->
d©av
);

1546 
	`BUG_ON
(
block_ùx
->
·gev
);

1547 
	`BUG_ON
(
block_ùx
->
mem_to_ä“
);

1548 ià(!
	`PAGE_ALIGNED
(
block_ùx
->
dev_by‹Ä
)) {

1549 
	`´_šfo
("btrfsic:„ead_block() with unaligned bytenr %llu\n",

1550 
block_ùx
->
dev_by‹Ä
);

1554 
num_·ges
 = (
block_ùx
->
Ën
 + (
u64
)
PAGE_SIZE
 - 1) >>

1555 
PAGE_SHIFT
;

1556 
size
 = (*
block_ùx
->
d©av
è+ (*block_ùx->
·gev
);

1557 
block_ùx
->
mem_to_ä“
 = 
	`kÿÎoc
(
num_·ges
, 
size
, 
GFP_NOFS
);

1558 ià(!
block_ùx
->
mem_to_ä“
)

1559  -
ENOMEM
;

1560 
block_ùx
->
d©av
 = block_ùx->
mem_to_ä“
;

1561 
block_ùx
->
·gev
 = (
·ge
 **)(block_ùx->
d©av
 + 
num_·ges
);

1562 
»t
 = 
	`bŒfs_®loc_·ge_¬¿y
(
num_·ges
, 
block_ùx
->
·gev
);

1563 ià(
»t
)

1564  
»t
;

1566 
dev_by‹Ä
 = 
block_ùx
->dev_bytenr;

1567 
i
 = 0; i < 
num_·ges
;) {

1568 
bio
 *bio;

1569 
j
;

1571 
bio
 = 
	`bio_®loc
(
block_ùx
->
dev
->
bdev
, 
num_·ges
 - 
i
,

1572 
REQ_OP_READ
, 
GFP_NOFS
);

1573 
bio
->
bi_™”
.
bi_£ùÜ
 = 
dev_by‹Ä
 >> 
SECTOR_SHIFT
;

1575 
j
 = 
i
; j < 
num_·ges
; j++) {

1576 
»t
 = 
	`bio_add_·ge
(
bio
, 
block_ùx
->
·gev
[
j
],

1577 
PAGE_SIZE
, 0);

1578 ià(
PAGE_SIZE
 !ğ
»t
)

1581 ià(
j
 =ğ
i
) {

1582 
	`´_šfo
("btrfsic:ƒrror, failedo‡dd‡ single…age!\n");

1585 ià(
	`subm™_bio_wa™
(
bio
)) {

1586 
	`´_šfo
("btrfsic:„eadƒrror‡t†ogical %llu dev %pg!\n",

1587 
block_ùx
->
¡¬t
, block_ùx->
dev
->
bdev
);

1588 
	`bio_put
(
bio
);

1591 
	`bio_put
(
bio
);

1592 
dev_by‹Ä
 +ğ(
j
 - 
i
è* 
PAGE_SIZE
;

1593 
i
 = 
j
;

1595 
i
 = 0; i < 
num_·ges
; i++)

1596 
block_ùx
->
d©av
[
i
] = 
	`·ge_add»ss
(block_ùx->
·gev
[i]);

1598  
block_ùx
->
Ën
;

1599 
	}
}

1601 
	$bŒfsic_dump_d©aba£
(
bŒfsic_¡©e
 *
¡©e
)

1603 cÚ¡ 
bŒfsic_block
 *
b_®l
;

1605 
	`BUG_ON
(
NULL
 =ğ
¡©e
);

1607 
	`´_šfo
("all_blocks_list:\n");

1608 
	`li¡_fÜ_—ch_’Œy
(
b_®l
, &
¡©e
->
®l_blocks_li¡
, 
®l_blocks_node
) {

1609 cÚ¡ 
bŒfsic_block_lšk
 *
l
;

1611 
	`´_šfo
("%c-block @%llu (%pg/%llu/%d)\n",

1612 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
b_®l
),

1613 
b_®l
->
logiÿl_by‹Ä
, b_®l->
dev_¡©e
->
bdev
,

1614 
b_®l
->
dev_by‹Ä
, b_®l->
mœrÜ_num
);

1616 
	`li¡_fÜ_—ch_’Œy
(
l
, &
b_®l
->
»f_to_li¡
, 
node_»f_to
) {

1617 
	`´_šfo
(

1619 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
b_®l
),

1620 
b_®l
->
logiÿl_by‹Ä
, b_®l->
dev_¡©e
->
bdev
,

1621 
b_®l
->
dev_by‹Ä
, b_®l->
mœrÜ_num
,

1622 
l
->
»f_út
,

1623 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

1624 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

1625 
l
->
block_»f_to
->
dev_¡©e
->
bdev
,

1626 
l
->
block_»f_to
->
dev_by‹Ä
,

1627 
l
->
block_»f_to
->
mœrÜ_num
);

1630 
	`li¡_fÜ_—ch_’Œy
(
l
, &
b_®l
->
»f_äom_li¡
, 
node_»f_äom
) {

1631 
	`´_šfo
(

1633 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
b_®l
),

1634 
b_®l
->
logiÿl_by‹Ä
, b_®l->
dev_¡©e
->
bdev
,

1635 
b_®l
->
dev_by‹Ä
, b_®l->
mœrÜ_num
,

1636 
l
->
»f_út
,

1637 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_äom
),

1638 
l
->
block_»f_äom
->
logiÿl_by‹Ä
,

1639 
l
->
block_»f_äom
->
dev_¡©e
->
bdev
,

1640 
l
->
block_»f_äom
->
dev_by‹Ä
,

1641 
l
->
block_»f_äom
->
mœrÜ_num
);

1644 
	`´_šfo
("\n");

1646 
	}
}

1652 
nošlše_fÜ_¡ack
 
	$bŒfsic_‹¡_fÜ_m‘ad©a
(

1653 
bŒfsic_¡©e
 *
¡©e
,

1654 **
d©av
, 
num_·ges
)

1656 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡©e
->fs_info;

1657 
	`SHASH_DESC_ON_STACK
(
shash
, 
fs_šfo
->
csum_shash
);

1658 
bŒfs_h—d”
 *
h
;

1659 
u8
 
csum
[
BTRFS_CSUM_SIZE
];

1660 
i
;

1662 ià(
num_·ges
 * 
PAGE_SIZE
 < 
¡©e
->
m‘ablock_size
)

1664 
num_·ges
 = 
¡©e
->
m‘ablock_size
 >> 
PAGE_SHIFT
;

1665 
h
 = (
bŒfs_h—d”
 *)
d©av
[0];

1667 ià(
	`memcmp
(
h
->
fsid
, 
fs_šfo
->
fs_deviûs
->fsid, 
BTRFS_FSID_SIZE
))

1670 
shash
->
tfm
 = 
fs_šfo
->
csum_shash
;

1671 
	`üy±o_shash_š™
(
shash
);

1673 
i
 = 0; i < 
num_·ges
; i++) {

1674 
u8
 *
d©a
 = 
i
 ? 
d©av
[i] : (d©av[i] + 
BTRFS_CSUM_SIZE
);

1675 
size_t
 
subËn
 = 
i
 ? 
PAGE_SIZE
 :

1676 (
PAGE_SIZE
 - 
BTRFS_CSUM_SIZE
);

1678 
	`üy±o_shash_upd©e
(
shash
, 
d©a
, 
subËn
);

1680 
	`üy±o_shash_fš®
(
shash
, 
csum
);

1681 ià(
	`memcmp
(
csum
, 
h
->csum, 
fs_šfo
->
csum_size
))

1685 
	}
}

1687 
	$bŒfsic_´oûss_wr™‹n_block
(
bŒfsic_dev_¡©e
 *
dev_¡©e
,

1688 
u64
 
dev_by‹Ä
, **
m­³d_d©av
,

1689 
num_·ges
,

1690 
bio
 *bio, *
bio_is_·tched
,

1691 
blk_İf_t
 
subm™_bio_bh_rw
)

1693 
is_m‘ad©a
;

1694 
bŒfsic_block
 *
block
;

1695 
bŒfsic_block_d©a_ùx
 
block_ùx
;

1696 
»t
;

1697 
bŒfsic_¡©e
 *
¡©e
 = 
dev_¡©e
->state;

1698 
block_deviû
 *
bdev
 = 
dev_¡©e
->bdev;

1699 
´oûs£d_Ën
;

1701 ià(
NULL
 !ğ
bio_is_·tched
)

1702 *
bio_is_·tched
 = 0;

1704 
agaš
:

1705 ià(
num_·ges
 == 0)

1708 
´oûs£d_Ën
 = 0;

1709 
is_m‘ad©a
 = (0 =ğ
	`bŒfsic_‹¡_fÜ_m‘ad©a
(
¡©e
, 
m­³d_d©av
,

1710 
num_·ges
));

1712 
block
 = 
	`bŒfsic_block_hashbË_lookup
(
bdev
, 
dev_by‹Ä
,

1713 &
¡©e
->
block_hashbË
);

1714 ià(
NULL
 !ğ
block
) {

1715 
u64
 
by‹Ä
 = 0;

1716 
bŒfsic_block_lšk
 *
l
, *
tmp
;

1718 ià(
block
->
is_su³rblock
) {

1719 
by‹Ä
 = 
	`bŒfs_su³r_by‹Ä
((
bŒfs_su³r_block
 *)

1720 
m­³d_d©av
[0]);

1721 ià(
num_·ges
 * 
PAGE_SIZE
 <

1722 
BTRFS_SUPER_INFO_SIZE
) {

1723 
	`´_šfo
("btrfsic: cannot work withoo short bios!\n");

1726 
is_m‘ad©a
 = 1;

1727 
	`BUG_ON
(!
	`PAGE_ALIGNED
(
BTRFS_SUPER_INFO_SIZE
));

1728 
´oûs£d_Ën
 = 
BTRFS_SUPER_INFO_SIZE
;

1729 ià(
¡©e
->
´št_mask
 &

1730 
BTRFSIC_PRINT_MASK_TREE_BEFORE_SB_WRITE
) {

1731 
	`´_šfo
("[before‚ew superblock is written]:\n");

1732 
	`bŒfsic_dump_Œ“_sub
(
¡©e
, 
block
, 0);

1735 ià(
is_m‘ad©a
) {

1736 ià(!
block
->
is_su³rblock
) {

1737 ià(
num_·ges
 * 
PAGE_SIZE
 <

1738 
¡©e
->
m‘ablock_size
) {

1739 
	`´_šfo
("btrfsic: cannot work withoo short bios!\n");

1742 
´oûs£d_Ën
 = 
¡©e
->
m‘ablock_size
;

1743 
by‹Ä
 = 
	`bŒfs_¡ack_h—d”_by‹Ä
(

1744 (
bŒfs_h—d”
 *)

1745 
m­³d_d©av
[0]);

1746 
	`bŒfsic_cmp_log_ªd_dev_by‹Ä
(
¡©e
, 
by‹Ä
,

1747 
dev_¡©e
,

1748 
dev_by‹Ä
);

1750 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
) {

1751 ià(
block
->
logiÿl_by‹Ä
 !ğ
by‹Ä
 &&

1752 !(!
block
->
is_m‘ad©a
 &&

1753 
block
->
logiÿl_by‹Ä
 == 0))

1754 
	`´_šfo
(

1756 
by‹Ä
, 
dev_¡©e
->
bdev
,

1757 
dev_by‹Ä
,

1758 
block
->
mœrÜ_num
,

1759 
	`bŒfsic_g‘_block_ty³
(
¡©e
,

1760 
block
),

1761 
block
->
logiÿl_by‹Ä
);

1763 
	`´_šfo
(

1765 
by‹Ä
, 
dev_¡©e
->
bdev
,

1766 
dev_by‹Ä
, 
block
->
mœrÜ_num
,

1767 
	`bŒfsic_g‘_block_ty³
(
¡©e
,

1768 
block
));

1770 
block
->
logiÿl_by‹Ä
 = 
by‹Ä
;

1772 ià(
num_·ges
 * 
PAGE_SIZE
 <

1773 
¡©e
->
d©ablock_size
) {

1774 
	`´_šfo
("btrfsic: cannot work withoo short bios!\n");

1777 
´oûs£d_Ën
 = 
¡©e
->
d©ablock_size
;

1778 
by‹Ä
 = 
block
->
logiÿl_by‹Ä
;

1779 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1780 
	`´_šfo
(

1782 
by‹Ä
, 
dev_¡©e
->
bdev
, 
dev_by‹Ä
,

1783 
block
->
mœrÜ_num
,

1784 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
block
));

1787 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1788 
	`´_šfo
("ref_to_list: %cE,„ef_from_list: %cE\n",

1789 
	`li¡_em±y
(&
block
->
»f_to_li¡
) ? ' ' : '!',

1790 
	`li¡_em±y
(&
block
->
»f_äom_li¡
) ? ' ' : '!');

1791 ià(
	`bŒfsic_is_block_»f_by_su³rblock
(
¡©e
, 
block
, 0)) {

1792 
	`´_šfo
(

1794 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
block
), 
by‹Ä
,

1795 
dev_¡©e
->
bdev
, 
dev_by‹Ä
, 
block
->
mœrÜ_num
,

1796 
block
->
g’”©iÚ
,

1797 
	`bŒfs_disk_key_objeùid
(&
block
->
disk_key
),

1798 
block
->
disk_key
.
ty³
,

1799 
	`bŒfs_disk_key_off£t
(&
block
->
disk_key
),

1800 
	`bŒfs_¡ack_h—d”_g’”©iÚ
(

1801 (
bŒfs_h—d”
 *è
m­³d_d©av
[0]),

1802 
¡©e
->
max_su³rblock_g’”©iÚ
);

1803 
	`bŒfsic_dump_Œ“
(
¡©e
);

1806 ià(!
block
->
is_iodÚe
 && !block->
Ãv”_wr™‹n
) {

1807 
	`´_šfo
(

1809 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
block
), 
by‹Ä
,

1810 
dev_¡©e
->
bdev
, 
dev_by‹Ä
, 
block
->
mœrÜ_num
,

1811 
block
->
g’”©iÚ
,

1812 
	`bŒfs_¡ack_h—d”_g’”©iÚ
(

1813 (
bŒfs_h—d”
 *)

1814 
m­³d_d©av
[0]));

1816 
	`bŒfsic_dump_Œ“
(
¡©e
);

1817 
cÚtšue_loİ
;

1826 
	`li¡_fÜ_—ch_’Œy_§ã
(
l
, 
tmp
, &
block
->
»f_to_li¡
,

1827 
node_»f_to
) {

1828 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1829 
	`bŒfsic_´št_»m_lšk
(
¡©e
, 
l
);

1830 
l
->
»f_út
--;

1831 ià(0 =ğ
l
->
»f_út
) {

1832 
	`li¡_d–
(&
l
->
node_»f_to
);

1833 
	`li¡_d–
(&
l
->
node_»f_äom
);

1834 
	`bŒfsic_block_lšk_hashbË_»move
(
l
);

1835 
	`bŒfsic_block_lšk_ä“
(
l
);

1839 
block_ùx
.
dev
 = 
dev_¡©e
;

1840 
block_ùx
.
dev_by‹Ä
 = dev_bytenr;

1841 
block_ùx
.
¡¬t
 = 
by‹Ä
;

1842 
block_ùx
.
Ën
 = 
´oûs£d_Ën
;

1843 
block_ùx
.
·gev
 = 
NULL
;

1844 
block_ùx
.
mem_to_ä“
 = 
NULL
;

1845 
block_ùx
.
d©av
 = 
m­³d_d©av
;

1847 ià(
is_m‘ad©a
 || 
¡©e
->
šşude_ex‹Á_d©a
) {

1848 
block
->
Ãv”_wr™‹n
 = 0;

1849 
block
->
iodÚe_w_”rÜ
 = 0;

1850 ià(
NULL
 !ğ
bio
) {

1851 
block
->
is_iodÚe
 = 0;

1852 
	`BUG_ON
(
NULL
 =ğ
bio_is_·tched
);

1853 ià(!*
bio_is_·tched
) {

1854 
block
->
Üig_bio_´iv©e
 =

1855 
bio
->
bi_´iv©e
;

1856 
block
->
Üig_bio_’d_io
 =

1857 
bio
->
bi_’d_io
;

1858 
block
->
Ãxt_š_§me_bio
 = 
NULL
;

1859 
bio
->
bi_´iv©e
 = 
block
;

1860 
bio
->
bi_’d_io
 = 
bŒfsic_bio_’d_io
;

1861 *
bio_is_·tched
 = 1;

1863 
bŒfsic_block
 *
chašed_block
 =

1864 (
bŒfsic_block
 *)

1865 
bio
->
bi_´iv©e
;

1867 
	`BUG_ON
(
NULL
 =ğ
chašed_block
);

1868 
block
->
Üig_bio_´iv©e
 =

1869 
chašed_block
->
Üig_bio_´iv©e
;

1870 
block
->
Üig_bio_’d_io
 =

1871 
chašed_block
->
Üig_bio_’d_io
;

1872 
block
->
Ãxt_š_§me_bio
 = 
chašed_block
;

1873 
bio
->
bi_´iv©e
 = 
block
;

1876 
block
->
is_iodÚe
 = 1;

1877 
block
->
Üig_bio_´iv©e
 = 
NULL
;

1878 
block
->
Üig_bio_’d_io
 = 
NULL
;

1879 
block
->
Ãxt_š_§me_bio
 = 
NULL
;

1883 
block
->
æush_g’
 = 
dev_¡©e
->
Ï¡_æush_g’
 + 1;

1884 
block
->
subm™_bio_bh_rw
 = submit_bio_bh_rw;

1885 ià(
is_m‘ad©a
) {

1886 
block
->
logiÿl_by‹Ä
 = 
by‹Ä
;

1887 
block
->
is_m‘ad©a
 = 1;

1888 ià(
block
->
is_su³rblock
) {

1889 
	`BUG_ON
(
PAGE_SIZE
 !=

1890 
BTRFS_SUPER_INFO_SIZE
);

1891 
»t
 = 
	`bŒfsic_´oûss_wr™‹n_su³rblock
(

1892 
¡©e
,

1893 
block
,

1894 (
bŒfs_su³r_block
 *)

1895 
m­³d_d©av
[0]);

1896 ià(
¡©e
->
´št_mask
 &

1897 
BTRFSIC_PRINT_MASK_TREE_AFTER_SB_WRITE
) {

1898 
	`´_šfo
("[after‚ew superblock is written]:\n");

1899 
	`bŒfsic_dump_Œ“_sub
(
¡©e
, 
block
, 0);

1902 
block
->
mœrÜ_num
 = 0;

1903 
»t
 = 
	`bŒfsic_´oûss_m‘ablock
(

1904 
¡©e
,

1905 
block
,

1906 &
block_ùx
,

1909 ià(
»t
)

1910 
	`´_šfo
("btrfsic: btrfsic_process_metablock(root @%llu) failed!\n",

1911 
dev_by‹Ä
);

1913 
block
->
is_m‘ad©a
 = 0;

1914 
block
->
mœrÜ_num
 = 0;

1915 
block
->
g’”©iÚ
 = 
BTRFSIC_GENERATION_UNKNOWN
;

1916 ià(!
¡©e
->
šşude_ex‹Á_d©a


1917 && 
	`li¡_em±y
(&
block
->
»f_äom_li¡
)) {

1924 
	`bŒfsic_block_hashbË_»move
(
block
);

1925 
	`li¡_d–
(&
block
->
®l_blocks_node
);

1926 
	`bŒfsic_block_ä“
(
block
);

1929 
	`bŒfsic_»Ëa£_block_ùx
(&
block_ùx
);

1932 
u64
 
by‹Ä
;

1934 ià(!
is_m‘ad©a
) {

1935 
´oûs£d_Ën
 = 
¡©e
->
d©ablock_size
;

1936 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1937 
	`´_šfo
(

1939 
dev_¡©e
->
bdev
, 
dev_by‹Ä
);

1940 ià(!
¡©e
->
šşude_ex‹Á_d©a
) {

1942 
cÚtšue_loİ
;

1947 
by‹Ä
 = 0;

1949 
´oûs£d_Ën
 = 
¡©e
->
m‘ablock_size
;

1950 
by‹Ä
 = 
	`bŒfs_¡ack_h—d”_by‹Ä
(

1951 (
bŒfs_h—d”
 *)

1952 
m­³d_d©av
[0]);

1953 
	`bŒfsic_cmp_log_ªd_dev_by‹Ä
(
¡©e
, 
by‹Ä
, 
dev_¡©e
,

1954 
dev_by‹Ä
);

1955 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1956 
	`´_šfo
(

1958 
by‹Ä
, 
dev_¡©e
->
bdev
, 
dev_by‹Ä
);

1961 
block_ùx
.
dev
 = 
dev_¡©e
;

1962 
block_ùx
.
dev_by‹Ä
 = dev_bytenr;

1963 
block_ùx
.
¡¬t
 = 
by‹Ä
;

1964 
block_ùx
.
Ën
 = 
´oûs£d_Ën
;

1965 
block_ùx
.
·gev
 = 
NULL
;

1966 
block_ùx
.
mem_to_ä“
 = 
NULL
;

1967 
block_ùx
.
d©av
 = 
m­³d_d©av
;

1969 
block
 = 
	`bŒfsic_block_®loc
();

1970 ià(
NULL
 =ğ
block
) {

1971 
	`bŒfsic_»Ëa£_block_ùx
(&
block_ùx
);

1972 
cÚtšue_loİ
;

1974 
block
->
dev_¡©e
 = dev_state;

1975 
block
->
dev_by‹Ä
 = dev_bytenr;

1976 
block
->
logiÿl_by‹Ä
 = 
by‹Ä
;

1977 
block
->
is_m‘ad©a
 = is_metadata;

1978 
block
->
Ãv”_wr™‹n
 = 0;

1979 
block
->
iodÚe_w_”rÜ
 = 0;

1980 
block
->
mœrÜ_num
 = 0;

1981 
block
->
æush_g’
 = 
dev_¡©e
->
Ï¡_æush_g’
 + 1;

1982 
block
->
subm™_bio_bh_rw
 = submit_bio_bh_rw;

1983 ià(
NULL
 !ğ
bio
) {

1984 
block
->
is_iodÚe
 = 0;

1985 
	`BUG_ON
(
NULL
 =ğ
bio_is_·tched
);

1986 ià(!*
bio_is_·tched
) {

1987 
block
->
Üig_bio_´iv©e
 = 
bio
->
bi_´iv©e
;

1988 
block
->
Üig_bio_’d_io
 = 
bio
->
bi_’d_io
;

1989 
block
->
Ãxt_š_§me_bio
 = 
NULL
;

1990 
bio
->
bi_´iv©e
 = 
block
;

1991 
bio
->
bi_’d_io
 = 
bŒfsic_bio_’d_io
;

1992 *
bio_is_·tched
 = 1;

1994 
bŒfsic_block
 *
chašed_block
 =

1995 (
bŒfsic_block
 *)

1996 
bio
->
bi_´iv©e
;

1998 
	`BUG_ON
(
NULL
 =ğ
chašed_block
);

1999 
block
->
Üig_bio_´iv©e
 =

2000 
chašed_block
->
Üig_bio_´iv©e
;

2001 
block
->
Üig_bio_’d_io
 =

2002 
chašed_block
->
Üig_bio_’d_io
;

2003 
block
->
Ãxt_š_§me_bio
 = 
chašed_block
;

2004 
bio
->
bi_´iv©e
 = 
block
;

2007 
block
->
is_iodÚe
 = 1;

2008 
block
->
Üig_bio_´iv©e
 = 
NULL
;

2009 
block
->
Üig_bio_’d_io
 = 
NULL
;

2010 
block
->
Ãxt_š_§me_bio
 = 
NULL
;

2012 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2013 
	`´_šfo
("new written %c-block @%llu (%pg/%llu/%d)\n",

2014 
is_m‘ad©a
 ? 'M' : 'D',

2015 
block
->
logiÿl_by‹Ä
, block->
dev_¡©e
->
bdev
,

2016 
block
->
dev_by‹Ä
, block->
mœrÜ_num
);

2017 
	`li¡_add
(&
block
->
®l_blocks_node
, &
¡©e
->
®l_blocks_li¡
);

2018 
	`bŒfsic_block_hashbË_add
(
block
, &
¡©e
->
block_hashbË
);

2020 ià(
is_m‘ad©a
) {

2021 
»t
 = 
	`bŒfsic_´oûss_m‘ablock
(
¡©e
, 
block
,

2022 &
block_ùx
, 0, 0);

2023 ià(
»t
)

2024 
	`´_šfo
("btrfsic:…rocess_metablock(root @%llu) failed!\n",

2025 
dev_by‹Ä
);

2027 
	`bŒfsic_»Ëa£_block_ùx
(&
block_ùx
);

2030 
cÚtšue_loİ
:

2031 
	`BUG_ON
(!
´oûs£d_Ën
);

2032 
dev_by‹Ä
 +ğ
´oûs£d_Ën
;

2033 
m­³d_d©av
 +ğ
´oûs£d_Ën
 >> 
PAGE_SHIFT
;

2034 
num_·ges
 -ğ
´oûs£d_Ën
 >> 
PAGE_SHIFT
;

2035 
agaš
;

2036 
	}
}

2038 
	$bŒfsic_bio_’d_io
(
bio
 *
bp
)

2040 
bŒfsic_block
 *
block
 = 
bp
->
bi_´iv©e
;

2041 
iodÚe_w_”rÜ
;

2045 
iodÚe_w_”rÜ
 = 0;

2046 ià(
bp
->
bi_¡©us
)

2047 
iodÚe_w_”rÜ
 = 1;

2049 
	`BUG_ON
(
NULL
 =ğ
block
);

2050 
bp
->
bi_´iv©e
 = 
block
->
Üig_bio_´iv©e
;

2051 
bp
->
bi_’d_io
 = 
block
->
Üig_bio_’d_io
;

2054 
bŒfsic_block
 *
Ãxt_block
;

2055 
bŒfsic_dev_¡©e
 *cÚ¡ 
dev_¡©e
 = 
block
->dev_state;

2057 ià((
dev_¡©e
->
¡©e
->
´št_mask
 &

2058 
BTRFSIC_PRINT_MASK_END_IO_BIO_BH
))

2059 
	`´_šfo
("bio_end_io(err=%d) for %c @%llu (%pg/%llu/%d)\n",

2060 
bp
->
bi_¡©us
,

2061 
	`bŒfsic_g‘_block_ty³
(
dev_¡©e
->
¡©e
, 
block
),

2062 
block
->
logiÿl_by‹Ä
, 
dev_¡©e
->
bdev
,

2063 
block
->
dev_by‹Ä
, block->
mœrÜ_num
);

2064 
Ãxt_block
 = 
block
->
Ãxt_š_§me_bio
;

2065 
block
->
iodÚe_w_”rÜ
 = iodone_w_error;

2066 ià(
block
->
subm™_bio_bh_rw
 & 
REQ_PREFLUSH
) {

2067 
dev_¡©e
->
Ï¡_æush_g’
++;

2068 ià((
dev_¡©e
->
¡©e
->
´št_mask
 &

2069 
BTRFSIC_PRINT_MASK_END_IO_BIO_BH
))

2070 
	`´_šfo
("bio_end_io()‚ew %pg flush_gen=%llu\n",

2071 
dev_¡©e
->
bdev
,

2072 
dev_¡©e
->
Ï¡_æush_g’
);

2074 ià(
block
->
subm™_bio_bh_rw
 & 
REQ_FUA
)

2075 
block
->
æush_g’
 = 0;

2077 
block
->
is_iodÚe
 = 1;

2078 
block
 = 
Ãxt_block
;

2079 } 
NULL
 !ğ
block
);

2081 
bp
->
	`bi_’d_io
(bp);

2082 
	}
}

2084 
	$bŒfsic_´oûss_wr™‹n_su³rblock
(

2085 
bŒfsic_¡©e
 *
¡©e
,

2086 
bŒfsic_block
 *cÚ¡ 
su³rblock
,

2087 
bŒfs_su³r_block
 *cÚ¡ 
su³r_hdr
)

2089 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡©e
->fs_info;

2090 
·ss
;

2092 
su³rblock
->
g’”©iÚ
 = 
	`bŒfs_su³r_g’”©iÚ
(
su³r_hdr
);

2093 ià(!(
su³rblock
->
g’”©iÚ
 > 
¡©e
->
max_su³rblock_g’”©iÚ
 ||

2094 0 =ğ
¡©e
->
max_su³rblock_g’”©iÚ
)) {

2095 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_SUPERBLOCK_WRITE
)

2096 
	`´_šfo
(

2098 
su³rblock
->
logiÿl_by‹Ä
,

2099 
su³rblock
->
dev_¡©e
->
bdev
,

2100 
su³rblock
->
dev_by‹Ä
, su³rblock->
mœrÜ_num
,

2101 
	`bŒfs_su³r_g’”©iÚ
(
su³r_hdr
),

2102 
¡©e
->
max_su³rblock_g’”©iÚ
);

2104 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_SUPERBLOCK_WRITE
)

2105 
	`´_šfo
(

2107 
su³rblock
->
logiÿl_by‹Ä
,

2108 
su³rblock
->
dev_¡©e
->
bdev
,

2109 
su³rblock
->
dev_by‹Ä
, su³rblock->
mœrÜ_num
,

2110 
	`bŒfs_su³r_g’”©iÚ
(
su³r_hdr
),

2111 
¡©e
->
max_su³rblock_g’”©iÚ
);

2113 
¡©e
->
max_su³rblock_g’”©iÚ
 =

2114 
	`bŒfs_su³r_g’”©iÚ
(
su³r_hdr
);

2115 
¡©e
->
Ï‹¡_su³rblock
 = 
su³rblock
;

2118 
·ss
 = 0;…ass < 3;…ass++) {

2119 
»t
;

2120 
u64
 
Ãxt_by‹Ä
;

2121 
bŒfsic_block
 *
Ãxt_block
;

2122 
bŒfsic_block_d©a_ùx
 
tmp_Ãxt_block_ùx
;

2123 
bŒfsic_block_lšk
 *
l
;

2124 
num_cİ›s
;

2125 
mœrÜ_num
;

2126 cÚ¡ *
add™iÚ®_¡ršg
 = 
NULL
;

2127 
bŒfs_disk_key
 
tmp_disk_key
 = {0};

2129 
	`bŒfs_£t_disk_key_objeùid
(&
tmp_disk_key
,

2130 
BTRFS_ROOT_ITEM_KEY
);

2131 
	`bŒfs_£t_disk_key_objeùid
(&
tmp_disk_key
, 0);

2133 
·ss
) {

2135 
	`bŒfs_£t_disk_key_objeùid
(&
tmp_disk_key
,

2136 
BTRFS_ROOT_TREE_OBJECTID
);

2137 
add™iÚ®_¡ršg
 = "root ";

2138 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_roÙ
(
su³r_hdr
);

2139 ià(
¡©e
->
´št_mask
 &

2140 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

2141 
	`´_šfo
("roÙ@%Îu\n", 
Ãxt_by‹Ä
);

2144 
	`bŒfs_£t_disk_key_objeùid
(&
tmp_disk_key
,

2145 
BTRFS_CHUNK_TREE_OBJECTID
);

2146 
add™iÚ®_¡ršg
 = "chunk ";

2147 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_chunk_roÙ
(
su³r_hdr
);

2148 ià(
¡©e
->
´št_mask
 &

2149 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

2150 
	`´_šfo
("chunk@%Îu\n", 
Ãxt_by‹Ä
);

2153 
	`bŒfs_£t_disk_key_objeùid
(&
tmp_disk_key
,

2154 
BTRFS_TREE_LOG_OBJECTID
);

2155 
add™iÚ®_¡ršg
 = "log ";

2156 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_log_roÙ
(
su³r_hdr
);

2157 ià(0 =ğ
Ãxt_by‹Ä
)

2159 ià(
¡©e
->
´št_mask
 &

2160 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

2161 
	`´_šfo
("log@%Îu\n", 
Ãxt_by‹Ä
);

2165 
num_cİ›s
 = 
	`bŒfs_num_cİ›s
(
fs_šfo
, 
Ãxt_by‹Ä
,

2166 
BTRFS_SUPER_INFO_SIZE
);

2167 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_NUM_COPIES
)

2168 
	`´_šfo
("num_copies(log_bytenr=%llu) = %d\n",

2169 
Ãxt_by‹Ä
, 
num_cİ›s
);

2170 
mœrÜ_num
 = 1; mœrÜ_num <ğ
num_cİ›s
; mirror_num++) {

2171 
was_ü—‹d
;

2173 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2174 
	`´_šfo
("bŒfsic_´oûss_wr™‹n_su³rblock(mœrÜ_num=%d)\n", 
mœrÜ_num
);

2175 
»t
 = 
	`bŒfsic_m­_block
(
¡©e
, 
Ãxt_by‹Ä
,

2176 
BTRFS_SUPER_INFO_SIZE
,

2177 &
tmp_Ãxt_block_ùx
,

2178 
mœrÜ_num
);

2179 ià(
»t
) {

2180 
	`´_šfo
("btrfsic: btrfsic_map_block(@%llu, mirror=%d) failed!\n",

2181 
Ãxt_by‹Ä
, 
mœrÜ_num
);

2185 
Ãxt_block
 = 
	`bŒfsic_block_lookup_Ü_add
(

2186 
¡©e
,

2187 &
tmp_Ãxt_block_ùx
,

2188 
add™iÚ®_¡ršg
,

2190 
mœrÜ_num
,

2191 &
was_ü—‹d
);

2192 ià(
NULL
 =ğ
Ãxt_block
) {

2193 
	`bŒfsic_»Ëa£_block_ùx
(&
tmp_Ãxt_block_ùx
);

2197 
Ãxt_block
->
disk_key
 = 
tmp_disk_key
;

2198 ià(
was_ü—‹d
)

2199 
Ãxt_block
->
g’”©iÚ
 =

2200 
BTRFSIC_GENERATION_UNKNOWN
;

2201 
l
 = 
	`bŒfsic_block_lšk_lookup_Ü_add
(

2202 
¡©e
,

2203 &
tmp_Ãxt_block_ùx
,

2204 
Ãxt_block
,

2205 
su³rblock
,

2206 
BTRFSIC_GENERATION_UNKNOWN
);

2207 
	`bŒfsic_»Ëa£_block_ùx
(&
tmp_Ãxt_block_ùx
);

2208 ià(
NULL
 =ğ
l
)

2213 ià(
	`WARN_ON
(-1 =ğ
	`bŒfsic_check_®l_»f_blocks
(
¡©e
, 
su³rblock
, 0)))

2214 
	`bŒfsic_dump_Œ“
(
¡©e
);

2217 
	}
}

2219 
	$bŒfsic_check_®l_»f_blocks
(
bŒfsic_¡©e
 *
¡©e
,

2220 
bŒfsic_block
 *cÚ¡ 
block
,

2221 
»cursiÚ_Ëv–
)

2223 cÚ¡ 
bŒfsic_block_lšk
 *
l
;

2224 
»t
 = 0;

2226 ià(
»cursiÚ_Ëv–
 >ğ3 + 
BTRFS_MAX_LEVEL
) {

2240 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2241 
	`´_šfo
("btrfsic:‡bort cyclic†inkage (case 1).\n");

2243  
»t
;

2250 
	`li¡_fÜ_—ch_’Œy
(
l
, &
block
->
»f_to_li¡
, 
node_»f_to
) {

2251 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2252 
	`´_šfo
(

2254 
»cursiÚ_Ëv–
,

2255 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
block
),

2256 
block
->
logiÿl_by‹Ä
, block->
dev_¡©e
->
bdev
,

2257 
block
->
dev_by‹Ä
, block->
mœrÜ_num
,

2258 
l
->
»f_út
,

2259 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

2260 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

2261 
l
->
block_»f_to
->
dev_¡©e
->
bdev
,

2262 
l
->
block_»f_to
->
dev_by‹Ä
,

2263 
l
->
block_»f_to
->
mœrÜ_num
);

2264 ià(
l
->
block_»f_to
->
Ãv”_wr™‹n
) {

2265 
	`´_šfo
(

2267 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

2268 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

2269 
l
->
block_»f_to
->
dev_¡©e
->
bdev
,

2270 
l
->
block_»f_to
->
dev_by‹Ä
,

2271 
l
->
block_»f_to
->
mœrÜ_num
);

2272 
»t
 = -1;

2273 } ià(!
l
->
block_»f_to
->
is_iodÚe
) {

2274 
	`´_šfo
(

2276 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

2277 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

2278 
l
->
block_»f_to
->
dev_¡©e
->
bdev
,

2279 
l
->
block_»f_to
->
dev_by‹Ä
,

2280 
l
->
block_»f_to
->
mœrÜ_num
);

2281 
»t
 = -1;

2282 } ià(
l
->
block_»f_to
->
iodÚe_w_”rÜ
) {

2283 
	`´_šfo
(

2285 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

2286 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

2287 
l
->
block_»f_to
->
dev_¡©e
->
bdev
,

2288 
l
->
block_»f_to
->
dev_by‹Ä
,

2289 
l
->
block_»f_to
->
mœrÜ_num
);

2290 
»t
 = -1;

2291 } ià(
l
->
·»Á_g’”©iÚ
 !=

2292 
l
->
block_»f_to
->
g’”©iÚ
 &&

2293 
BTRFSIC_GENERATION_UNKNOWN
 !=

2294 
l
->
·»Á_g’”©iÚ
 &&

2295 
BTRFSIC_GENERATION_UNKNOWN
 !=

2296 
l
->
block_»f_to
->
g’”©iÚ
) {

2297 
	`´_šfo
(

2299 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

2300 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

2301 
l
->
block_»f_to
->
dev_¡©e
->
bdev
,

2302 
l
->
block_»f_to
->
dev_by‹Ä
,

2303 
l
->
block_»f_to
->
mœrÜ_num
,

2304 
l
->
block_»f_to
->
g’”©iÚ
,

2305 
l
->
·»Á_g’”©iÚ
);

2306 
»t
 = -1;

2307 } ià(
l
->
block_»f_to
->
æush_g’
 >

2308 
l
->
block_»f_to
->
dev_¡©e
->
Ï¡_æush_g’
) {

2309 
	`´_šfo
(

2311 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

2312 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

2313 
l
->
block_»f_to
->
dev_¡©e
->
bdev
,

2314 
l
->
block_»f_to
->
dev_by‹Ä
,

2315 
l
->
block_»f_to
->
mœrÜ_num
, 
block
->
æush_g’
,

2316 
l
->
block_»f_to
->
dev_¡©e
->
Ï¡_æush_g’
);

2317 
»t
 = -1;

2318 } ià(-1 =ğ
	`bŒfsic_check_®l_»f_blocks
(
¡©e
,

2319 
l
->
block_»f_to
,

2320 
»cursiÚ_Ëv–
 +

2322 
»t
 = -1;

2326  
»t
;

2327 
	}
}

2329 
	$bŒfsic_is_block_»f_by_su³rblock
(

2330 cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

2331 cÚ¡ 
bŒfsic_block
 *
block
,

2332 
»cursiÚ_Ëv–
)

2334 cÚ¡ 
bŒfsic_block_lšk
 *
l
;

2336 ià(
»cursiÚ_Ëv–
 >ğ3 + 
BTRFS_MAX_LEVEL
) {

2338 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2339 
	`´_šfo
("btrfsic:‡bort cyclic†inkage (case 2).\n");

2348 
	`li¡_fÜ_—ch_’Œy
(
l
, &
block
->
»f_äom_li¡
, 
node_»f_äom
) {

2349 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2350 
	`´_šfo
(

2352 
»cursiÚ_Ëv–
,

2353 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
block
),

2354 
block
->
logiÿl_by‹Ä
, block->
dev_¡©e
->
bdev
,

2355 
block
->
dev_by‹Ä
, block->
mœrÜ_num
,

2356 
l
->
»f_út
,

2357 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_äom
),

2358 
l
->
block_»f_äom
->
logiÿl_by‹Ä
,

2359 
l
->
block_»f_äom
->
dev_¡©e
->
bdev
,

2360 
l
->
block_»f_äom
->
dev_by‹Ä
,

2361 
l
->
block_»f_äom
->
mœrÜ_num
);

2362 ià(
l
->
block_»f_äom
->
is_su³rblock
 &&

2363 
¡©e
->
Ï‹¡_su³rblock
->
dev_by‹Ä
 ==

2364 
l
->
block_»f_äom
->
dev_by‹Ä
 &&

2365 
¡©e
->
Ï‹¡_su³rblock
->
dev_¡©e
->
bdev
 ==

2366 
l
->
block_»f_äom
->
dev_¡©e
->
bdev
)

2368 ià(
	`bŒfsic_is_block_»f_by_su³rblock
(
¡©e
,

2369 
l
->
block_»f_äom
,

2370 
»cursiÚ_Ëv–
 +

2376 
	}
}

2378 
	$bŒfsic_´št_add_lšk
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

2379 cÚ¡ 
bŒfsic_block_lšk
 *
l
)

2381 
	`´_šfo
("add %u*†ink from %c @%llu (%pg/%llu/%d)o %c @%llu (%pg/%llu/%d)\n",

2382 
l
->
»f_út
,

2383 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_äom
),

2384 
l
->
block_»f_äom
->
logiÿl_by‹Ä
,

2385 
l
->
block_»f_äom
->
dev_¡©e
->
bdev
,

2386 
l
->
block_»f_äom
->
dev_by‹Ä
,†->block_»f_äom->
mœrÜ_num
,

2387 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

2388 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

2389 
l
->
block_»f_to
->
dev_¡©e
->
bdev
,†->block_»f_to->
dev_by‹Ä
,

2390 
l
->
block_»f_to
->
mœrÜ_num
);

2391 
	}
}

2393 
	$bŒfsic_´št_»m_lšk
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

2394 cÚ¡ 
bŒfsic_block_lšk
 *
l
)

2396 
	`´_šfo
("rem %u*†ink from %c @%llu (%pg/%llu/%d)o %c @%llu (%pg/%llu/%d)\n",

2397 
l
->
»f_út
,

2398 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_äom
),

2399 
l
->
block_»f_äom
->
logiÿl_by‹Ä
,

2400 
l
->
block_»f_äom
->
dev_¡©e
->
bdev
,

2401 
l
->
block_»f_äom
->
dev_by‹Ä
,†->block_»f_äom->
mœrÜ_num
,

2402 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

2403 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

2404 
l
->
block_»f_to
->
dev_¡©e
->
bdev
,†->block_»f_to->
dev_by‹Ä
,

2405 
l
->
block_»f_to
->
mœrÜ_num
);

2406 
	}
}

2408 
	$bŒfsic_g‘_block_ty³
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

2409 cÚ¡ 
bŒfsic_block
 *
block
)

2411 ià(
block
->
is_su³rblock
 &&

2412 
¡©e
->
Ï‹¡_su³rblock
->
dev_by‹Ä
 =ğ
block
->dev_bytenr &&

2413 
¡©e
->
Ï‹¡_su³rblock
->
dev_¡©e
->
bdev
 =ğ
block
->dev_state->bdev)

2415 ià(
block
->
is_su³rblock
)

2417 ià(
block
->
is_m‘ad©a
)

2421 
	}
}

2423 
	$bŒfsic_dump_Œ“
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
)

2425 
	`bŒfsic_dump_Œ“_sub
(
¡©e
, s‹->
Ï‹¡_su³rblock
, 0);

2426 
	}
}

2428 
	$bŒfsic_dump_Œ“_sub
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

2429 cÚ¡ 
bŒfsic_block
 *
block
,

2430 
šd’t_Ëv–
)

2432 cÚ¡ 
bŒfsic_block_lšk
 *
l
;

2433 
šd’t_add
;

2434 
buf
[80];

2435 
cursÜ_pos™iÚ
;

2446 
šd’t_add
 = 
	`¥rštf
(
buf
, "%c-%llu(%pg/%llu/%u)",

2447 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
block
),

2448 
block
->
logiÿl_by‹Ä
, block->
dev_¡©e
->
bdev
,

2449 
block
->
dev_by‹Ä
, block->
mœrÜ_num
);

2450 ià(
šd’t_Ëv–
 + 
šd’t_add
 > 
BTRFSIC_TREE_DUMP_MAX_INDENT_LEVEL
) {

2451 
	`´štk
("[...]\n");

2454 
	`´štk
(
buf
);

2455 
šd’t_Ëv–
 +ğ
šd’t_add
;

2456 ià(
	`li¡_em±y
(&
block
->
»f_to_li¡
)) {

2457 
	`´štk
("\n");

2460 ià(
block
->
mœrÜ_num
 > 1 &&

2461 !(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_TREE_WITH_ALL_MIRRORS
)) {

2462 
	`´štk
(" [...]\n");

2466 
cursÜ_pos™iÚ
 = 
šd’t_Ëv–
;

2467 
	`li¡_fÜ_—ch_’Œy
(
l
, &
block
->
»f_to_li¡
, 
node_»f_to
) {

2468 
cursÜ_pos™iÚ
 < 
šd’t_Ëv–
) {

2469 
	`´štk
(" ");

2470 
cursÜ_pos™iÚ
++;

2472 ià(
l
->
»f_út
 > 1)

2473 
šd’t_add
 = 
	`¥rštf
(
buf
, " %d*--> ", 
l
->
»f_út
);

2475 
šd’t_add
 = 
	`¥rštf
(
buf
, " --> ");

2476 ià(
šd’t_Ëv–
 + 
šd’t_add
 >

2477 
BTRFSIC_TREE_DUMP_MAX_INDENT_LEVEL
) {

2478 
	`´štk
("[...]\n");

2479 
cursÜ_pos™iÚ
 = 0;

2483 
	`´štk
(
buf
);

2485 
	`bŒfsic_dump_Œ“_sub
(
¡©e
, 
l
->
block_»f_to
,

2486 
šd’t_Ëv–
 + 
šd’t_add
);

2487 
cursÜ_pos™iÚ
 = 0;

2489 
	}
}

2491 
bŒfsic_block_lšk
 *
	$bŒfsic_block_lšk_lookup_Ü_add
(

2492 
bŒfsic_¡©e
 *
¡©e
,

2493 
bŒfsic_block_d©a_ùx
 *
Ãxt_block_ùx
,

2494 
bŒfsic_block
 *
Ãxt_block
,

2495 
bŒfsic_block
 *
äom_block
,

2496 
u64
 
·»Á_g’”©iÚ
)

2498 
bŒfsic_block_lšk
 *
l
;

2500 
l
 = 
	`bŒfsic_block_lšk_hashbË_lookup
(
Ãxt_block_ùx
->
dev
->
bdev
,

2501 
Ãxt_block_ùx
->
dev_by‹Ä
,

2502 
äom_block
->
dev_¡©e
->
bdev
,

2503 
äom_block
->
dev_by‹Ä
,

2504 &
¡©e
->
block_lšk_hashbË
);

2505 ià(
NULL
 =ğ
l
) {

2506 
l
 = 
	`bŒfsic_block_lšk_®loc
();

2507 ià(!
l
)

2508  
NULL
;

2510 
l
->
block_»f_to
 = 
Ãxt_block
;

2511 
l
->
block_»f_äom
 = 
äom_block
;

2512 
l
->
»f_út
 = 1;

2513 
l
->
·»Á_g’”©iÚ
 =…arent_generation;

2515 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2516 
	`bŒfsic_´št_add_lšk
(
¡©e
, 
l
);

2518 
	`li¡_add
(&
l
->
node_»f_to
, &
äom_block
->
»f_to_li¡
);

2519 
	`li¡_add
(&
l
->
node_»f_äom
, &
Ãxt_block
->
»f_äom_li¡
);

2521 
	`bŒfsic_block_lšk_hashbË_add
(
l
,

2522 &
¡©e
->
block_lšk_hashbË
);

2524 
l
->
»f_út
++;

2525 
l
->
·»Á_g’”©iÚ
 =…arent_generation;

2526 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2527 
	`bŒfsic_´št_add_lšk
(
¡©e
, 
l
);

2530  
l
;

2531 
	}
}

2533 
bŒfsic_block
 *
	$bŒfsic_block_lookup_Ü_add
(

2534 
bŒfsic_¡©e
 *
¡©e
,

2535 
bŒfsic_block_d©a_ùx
 *
block_ùx
,

2536 cÚ¡ *
add™iÚ®_¡ršg
,

2537 
is_m‘ad©a
,

2538 
is_iodÚe
,

2539 
Ãv”_wr™‹n
,

2540 
mœrÜ_num
,

2541 *
was_ü—‹d
)

2543 
bŒfsic_block
 *
block
;

2545 
block
 = 
	`bŒfsic_block_hashbË_lookup
(
block_ùx
->
dev
->
bdev
,

2546 
block_ùx
->
dev_by‹Ä
,

2547 &
¡©e
->
block_hashbË
);

2548 ià(
NULL
 =ğ
block
) {

2549 
bŒfsic_dev_¡©e
 *
dev_¡©e
;

2551 
block
 = 
	`bŒfsic_block_®loc
();

2552 ià(!
block
)

2553  
NULL
;

2555 
dev_¡©e
 = 
	`bŒfsic_dev_¡©e_lookup
(
block_ùx
->
dev
->
bdev
->
bd_dev
);

2556 ià(
NULL
 =ğ
dev_¡©e
) {

2557 
	`´_šfo
("btrfsic:ƒrror,†ookup dev_state failed!\n");

2558 
	`bŒfsic_block_ä“
(
block
);

2559  
NULL
;

2561 
block
->
dev_¡©e
 = dev_state;

2562 
block
->
dev_by‹Ä
 = 
block_ùx
->dev_bytenr;

2563 
block
->
logiÿl_by‹Ä
 = 
block_ùx
->
¡¬t
;

2564 
block
->
is_m‘ad©a
 = is_metadata;

2565 
block
->
is_iodÚe
 = is_iodone;

2566 
block
->
Ãv”_wr™‹n
 =‚ever_written;

2567 
block
->
mœrÜ_num
 = mirror_num;

2568 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2569 
	`´_šfo
("New %s%c-block @%llu (%pg/%llu/%d)\n",

2570 
add™iÚ®_¡ršg
,

2571 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
block
),

2572 
block
->
logiÿl_by‹Ä
, 
dev_¡©e
->
bdev
,

2573 
block
->
dev_by‹Ä
, 
mœrÜ_num
);

2574 
	`li¡_add
(&
block
->
®l_blocks_node
, &
¡©e
->
®l_blocks_li¡
);

2575 
	`bŒfsic_block_hashbË_add
(
block
, &
¡©e
->
block_hashbË
);

2576 ià(
NULL
 !ğ
was_ü—‹d
)

2577 *
was_ü—‹d
 = 1;

2579 ià(
NULL
 !ğ
was_ü—‹d
)

2580 *
was_ü—‹d
 = 0;

2583  
block
;

2584 
	}
}

2586 
	$bŒfsic_cmp_log_ªd_dev_by‹Ä
(
bŒfsic_¡©e
 *
¡©e
,

2587 
u64
 
by‹Ä
,

2588 
bŒfsic_dev_¡©e
 *
dev_¡©e
,

2589 
u64
 
dev_by‹Ä
)

2591 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡©e
->fs_info;

2592 
bŒfsic_block_d©a_ùx
 
block_ùx
;

2593 
num_cİ›s
;

2594 
mœrÜ_num
;

2595 
m©ch
 = 0;

2596 
»t
;

2598 
num_cİ›s
 = 
	`bŒfs_num_cİ›s
(
fs_šfo
, 
by‹Ä
, 
¡©e
->
m‘ablock_size
);

2600 
mœrÜ_num
 = 1; mœrÜ_num <ğ
num_cİ›s
; mirror_num++) {

2601 
»t
 = 
	`bŒfsic_m­_block
(
¡©e
, 
by‹Ä
, s‹->
m‘ablock_size
,

2602 &
block_ùx
, 
mœrÜ_num
);

2603 ià(
»t
) {

2604 
	`´_šfo
("btrfsic: btrfsic_map_block(logical @%llu, mirror %d) failed!\n",

2605 
by‹Ä
, 
mœrÜ_num
);

2609 ià(
dev_¡©e
->
bdev
 =ğ
block_ùx
.
dev
->bdev &&

2610 
dev_by‹Ä
 =ğ
block_ùx
.dev_bytenr) {

2611 
m©ch
++;

2612 
	`bŒfsic_»Ëa£_block_ùx
(&
block_ùx
);

2615 
	`bŒfsic_»Ëa£_block_ùx
(&
block_ùx
);

2618 ià(
	`WARN_ON
(!
m©ch
)) {

2619 
	`´_šfo
(

2621 
by‹Ä
, 
dev_¡©e
->
bdev
, 
dev_by‹Ä
);

2622 
mœrÜ_num
 = 1; mœrÜ_num <ğ
num_cİ›s
; mirror_num++) {

2623 
»t
 = 
	`bŒfsic_m­_block
(
¡©e
, 
by‹Ä
,

2624 
¡©e
->
m‘ablock_size
,

2625 &
block_ùx
, 
mœrÜ_num
);

2626 ià(
»t
)

2629 
	`´_šfo
("read†ogical bytenr @%llu mapso (%pg/%llu/%d)\n",

2630 
by‹Ä
, 
block_ùx
.
dev
->
bdev
,

2631 
block_ùx
.
dev_by‹Ä
, 
mœrÜ_num
);

2634 
	}
}

2636 
bŒfsic_dev_¡©e
 *
	$bŒfsic_dev_¡©e_lookup
(
dev_t
 
dev
)

2638  
	`bŒfsic_dev_¡©e_hashbË_lookup
(
dev
,

2639 &
bŒfsic_dev_¡©e_hashbË
);

2640 
	}
}

2642 
	$bŒfsic_check_wr™e_bio
(
bio
 *bio, 
bŒfsic_dev_¡©e
 *
dev_¡©e
)

2644 
£gs
 = 
	`bio_£gm’ts
(
bio
);

2645 
u64
 
dev_by‹Ä
 = 512 * 
bio
->
bi_™”
.
bi_£ùÜ
;

2646 
u64
 
cur_by‹Ä
 = 
dev_by‹Ä
;

2647 
bvec_™”
 
™”
;

2648 
bio_vec
 
bvec
;

2649 **
m­³d_d©av
;

2650 
bio_is_·tched
 = 0;

2651 
i
 = 0;

2653 ià(
dev_¡©e
->
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH
)

2654 
	`´_šfo
(

2656 
	`bio_İ
(
bio
), bio->
bi_İf
, 
£gs
,

2657 
bio
->
bi_™”
.
bi_£ùÜ
, 
dev_by‹Ä
, bio->
bi_bdev
);

2659 
m­³d_d©av
 = 
	`km®loc_¬¿y
(
£gs
, (*m­³d_d©av), 
GFP_NOFS
);

2660 ià(!
m­³d_d©av
)

2663 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
™”
) {

2664 
	`BUG_ON
(
bvec
.
bv_Ën
 !ğ
PAGE_SIZE
);

2665 
m­³d_d©av
[
i
] = 
	`·ge_add»ss
(
bvec
.
bv_·ge
);

2666 
i
++;

2668 ià(
dev_¡©e
->
¡©e
->
´št_mask
 &

2669 
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH_VERBOSE
)

2670 
	`´_šfo
("#%u: bytenr=%llu,†en=%u, offset=%u\n",

2671 
i
, 
cur_by‹Ä
, 
bvec
.
bv_Ën
, bvec.
bv_off£t
);

2672 
cur_by‹Ä
 +ğ
bvec
.
bv_Ën
;

2675 
	`bŒfsic_´oûss_wr™‹n_block
(
dev_¡©e
, 
dev_by‹Ä
, 
m­³d_d©av
, 
£gs
,

2676 
bio
, &
bio_is_·tched
, bio->
bi_İf
);

2677 
	`kä“
(
m­³d_d©av
);

2678 
	}
}

2680 
	$bŒfsic_check_æush_bio
(
bio
 *bio, 
bŒfsic_dev_¡©e
 *
dev_¡©e
)

2682 ià(
dev_¡©e
->
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH
)

2683 
	`´_šfo
("submit_bio(rw=%d,0x%x FLUSH, bdev=%p)\n",

2684 
	`bio_İ
(
bio
), bio->
bi_İf
, bio->
bi_bdev
);

2686 ià(
dev_¡©e
->
dummy_block_fÜ_bio_bh_æush
.
is_iodÚe
) {

2687 
bŒfsic_block
 *cÚ¡ 
block
 =

2688 &
dev_¡©e
->
dummy_block_fÜ_bio_bh_æush
;

2690 
block
->
is_iodÚe
 = 0;

2691 
block
->
Ãv”_wr™‹n
 = 0;

2692 
block
->
iodÚe_w_”rÜ
 = 0;

2693 
block
->
æush_g’
 = 
dev_¡©e
->
Ï¡_æush_g’
 + 1;

2694 
block
->
subm™_bio_bh_rw
 = 
bio
->
bi_İf
;

2695 
block
->
Üig_bio_´iv©e
 = 
bio
->
bi_´iv©e
;

2696 
block
->
Üig_bio_’d_io
 = 
bio
->
bi_’d_io
;

2697 
block
->
Ãxt_š_§me_bio
 = 
NULL
;

2698 
bio
->
bi_´iv©e
 = 
block
;

2699 
bio
->
bi_’d_io
 = 
bŒfsic_bio_’d_io
;

2700 } ià((
dev_¡©e
->
¡©e
->
´št_mask
 &

2701 (
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH
 |

2702 
BTRFSIC_PRINT_MASK_VERBOSE
))) {

2703 
	`´_šfo
(

2705 
dev_¡©e
->
bdev
);

2707 
	}
}

2709 
	$bŒfsic_check_bio
(
bio
 *bio)

2711 
bŒfsic_dev_¡©e
 *
dev_¡©e
;

2713 ià(!
bŒfsic_is_š™Ÿlized
)

2720 
dev_¡©e
 = 
	`bŒfsic_dev_¡©e_lookup
(
bio
->
bi_bdev
->
bd_dev
);

2721 
	`mu‹x_lock
(&
bŒfsic_mu‹x
);

2722 ià(
dev_¡©e
) {

2723 ià(
	`bio_İ
(
bio
è=ğ
REQ_OP_WRITE
 && 
	`bio_has_d©a
(bio))

2724 
	`bŒfsic_check_wr™e_bio
(
bio
, 
dev_¡©e
);

2725 ià(
bio
->
bi_İf
 & 
REQ_PREFLUSH
)

2726 
	`bŒfsic_check_æush_bio
(
bio
, 
dev_¡©e
);

2728 
	`mu‹x_uÆock
(&
bŒfsic_mu‹x
);

2729 
	}
}

2731 
	$bŒfsic_mouÁ
(
bŒfs_fs_šfo
 *
fs_šfo
,

2732 
bŒfs_fs_deviûs
 *
fs_deviûs
,

2733 
šşudšg_ex‹Á_d©a
, 
u32
 
´št_mask
)

2735 
»t
;

2736 
bŒfsic_¡©e
 *
¡©e
;

2737 
li¡_h—d
 *
dev_h—d
 = &
fs_deviûs
->
deviûs
;

2738 
bŒfs_deviû
 *
deviû
;

2740 ià(!
	`PAGE_ALIGNED
(
fs_šfo
->
nodesize
)) {

2741 
	`´_šfo
("btrfsic: cannot handle‚odesize %d‚ot being‡ multiple of PAGE_SIZE %ld!\n",

2742 
fs_šfo
->
nodesize
, 
PAGE_SIZE
);

2745 ià(!
	`PAGE_ALIGNED
(
fs_šfo
->
£ùÜsize
)) {

2746 
	`´_šfo
("btrfsic: cannot handle sectorsize %d‚ot being‡ multiple of PAGE_SIZE %ld!\n",

2747 
fs_šfo
->
£ùÜsize
, 
PAGE_SIZE
);

2750 
¡©e
 = 
	`kvz®loc
((*¡©e), 
GFP_KERNEL
);

2751 ià(!
¡©e
)

2752  -
ENOMEM
;

2754 ià(!
bŒfsic_is_š™Ÿlized
) {

2755 
	`mu‹x_š™
(&
bŒfsic_mu‹x
);

2756 
	`bŒfsic_dev_¡©e_hashbË_š™
(&
bŒfsic_dev_¡©e_hashbË
);

2757 
bŒfsic_is_š™Ÿlized
 = 1;

2759 
	`mu‹x_lock
(&
bŒfsic_mu‹x
);

2760 
¡©e
->
fs_šfo
 = fs_info;

2761 
¡©e
->
´št_mask
 =…rint_mask;

2762 
¡©e
->
šşude_ex‹Á_d©a
 = 
šşudšg_ex‹Á_d©a
;

2763 
¡©e
->
m‘ablock_size
 = 
fs_šfo
->
nodesize
;

2764 
¡©e
->
d©ablock_size
 = 
fs_šfo
->
£ùÜsize
;

2765 
	`INIT_LIST_HEAD
(&
¡©e
->
®l_blocks_li¡
);

2766 
	`bŒfsic_block_hashbË_š™
(&
¡©e
->
block_hashbË
);

2767 
	`bŒfsic_block_lšk_hashbË_š™
(&
¡©e
->
block_lšk_hashbË
);

2768 
¡©e
->
max_su³rblock_g’”©iÚ
 = 0;

2769 
¡©e
->
Ï‹¡_su³rblock
 = 
NULL
;

2771 
	`li¡_fÜ_—ch_’Œy
(
deviû
, 
dev_h—d
, 
dev_li¡
) {

2772 
bŒfsic_dev_¡©e
 *
ds
;

2774 ià(!
deviû
->
bdev
 || !deviû->
Çme
)

2777 
ds
 = 
	`bŒfsic_dev_¡©e_®loc
();

2778 ià(
NULL
 =ğ
ds
) {

2779 
	`mu‹x_uÆock
(&
bŒfsic_mu‹x
);

2780  -
ENOMEM
;

2782 
ds
->
bdev
 = 
deviû
->bdev;

2783 
ds
->
¡©e
 = state;

2784 
	`bŒfsic_dev_¡©e_hashbË_add
(
ds
,

2785 &
bŒfsic_dev_¡©e_hashbË
);

2788 
»t
 = 
	`bŒfsic_´oûss_su³rblock
(
¡©e
, 
fs_deviûs
);

2789 ià(0 !ğ
»t
) {

2790 
	`mu‹x_uÆock
(&
bŒfsic_mu‹x
);

2791 
	`bŒfsic_unmouÁ
(
fs_deviûs
);

2792  
»t
;

2795 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_INITIAL_DATABASE
)

2796 
	`bŒfsic_dump_d©aba£
(
¡©e
);

2797 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_INITIAL_TREE
)

2798 
	`bŒfsic_dump_Œ“
(
¡©e
);

2800 
	`mu‹x_uÆock
(&
bŒfsic_mu‹x
);

2802 
	}
}

2804 
	$bŒfsic_unmouÁ
(
bŒfs_fs_deviûs
 *
fs_deviûs
)

2806 
bŒfsic_block
 *
b_®l
, *
tmp_®l
;

2807 
bŒfsic_¡©e
 *
¡©e
;

2808 
li¡_h—d
 *
dev_h—d
 = &
fs_deviûs
->
deviûs
;

2809 
bŒfs_deviû
 *
deviû
;

2811 ià(!
bŒfsic_is_š™Ÿlized
)

2814 
	`mu‹x_lock
(&
bŒfsic_mu‹x
);

2816 
¡©e
 = 
NULL
;

2817 
	`li¡_fÜ_—ch_’Œy
(
deviû
, 
dev_h—d
, 
dev_li¡
) {

2818 
bŒfsic_dev_¡©e
 *
ds
;

2820 ià(!
deviû
->
bdev
 || !deviû->
Çme
)

2823 
ds
 = 
	`bŒfsic_dev_¡©e_hashbË_lookup
(

2824 
deviû
->
bdev
->
bd_dev
,

2825 &
bŒfsic_dev_¡©e_hashbË
);

2826 ià(
NULL
 !ğ
ds
) {

2827 
¡©e
 = 
ds
->state;

2828 
	`bŒfsic_dev_¡©e_hashbË_»move
(
ds
);

2829 
	`bŒfsic_dev_¡©e_ä“
(
ds
);

2833 ià(
NULL
 =ğ
¡©e
) {

2834 
	`´_šfo
("btrfsic:ƒrror, cannot find state information on umount!\n");

2835 
	`mu‹x_uÆock
(&
bŒfsic_mu‹x
);

2844 
	`li¡_fÜ_—ch_’Œy_§ã
(
b_®l
, 
tmp_®l
, &
¡©e
->
®l_blocks_li¡
,

2845 
®l_blocks_node
) {

2846 
bŒfsic_block_lšk
 *
l
, *
tmp
;

2848 
	`li¡_fÜ_—ch_’Œy_§ã
(
l
, 
tmp
, &
b_®l
->
»f_to_li¡
,

2849 
node_»f_to
) {

2850 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2851 
	`bŒfsic_´št_»m_lšk
(
¡©e
, 
l
);

2853 
l
->
»f_út
--;

2854 ià(0 =ğ
l
->
»f_út
)

2855 
	`bŒfsic_block_lšk_ä“
(
l
);

2858 ià(
b_®l
->
is_iodÚe
 || b_®l->
Ãv”_wr™‹n
)

2859 
	`bŒfsic_block_ä“
(
b_®l
);

2861 
	`´_šfo
(

2863 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
b_®l
),

2864 
b_®l
->
logiÿl_by‹Ä
, b_®l->
dev_¡©e
->
bdev
,

2865 
b_®l
->
dev_by‹Ä
, b_®l->
mœrÜ_num
);

2868 
	`mu‹x_uÆock
(&
bŒfsic_mu‹x
);

2870 
	`kvä“
(
¡©e
);

2871 
	}
}

	@check-integrity.h

6 #iâdeà
BTRFS_CHECK_INTEGRITY_H


7 
	#BTRFS_CHECK_INTEGRITY_H


	)

9 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


10 
bŒfsic_check_bio
(
bio
 *bio);

12 
šlše
 
	$bŒfsic_check_bio
(
bio
 *bioè{ 
	}
}

15 
bŒfsic_mouÁ
(
bŒfs_fs_šfo
 *
fs_šfo
,

16 
bŒfs_fs_deviûs
 *
fs_deviûs
,

17 
šşudšg_ex‹Á_d©a
, 
u32
 
´št_mask
);

18 
bŒfsic_unmouÁ
(
bŒfs_fs_deviûs
 *
fs_deviûs
);

	@compression.c

6 
	~<lšux/k”Ãl.h
>

7 
	~<lšux/bio.h
>

8 
	~<lšux/fe.h
>

9 
	~<lšux/fs.h
>

10 
	~<lšux/·gem­.h
>

11 
	~<lšux/·gevec.h
>

12 
	~<lšux/highmem.h
>

13 
	~<lšux/kth»ad.h
>

14 
	~<lšux/time.h
>

15 
	~<lšux/š™.h
>

16 
	~<lšux/¡ršg.h
>

17 
	~<lšux/backšg-dev.h
>

18 
	~<lšux/wr™eback.h
>

19 
	~<lšux/psi.h
>

20 
	~<lšux/¦ab.h
>

21 
	~<lšux/sched/mm.h
>

22 
	~<lšux/log2.h
>

23 
	~<üy±o/hash.h
>

24 
	~"misc.h
"

25 
	~"ù»e.h
"

26 
	~"fs.h
"

27 
	~"disk-io.h
"

28 
	~"Œª§ùiÚ.h
"

29 
	~"bŒfs_šode.h
"

30 
	~"bio.h
"

31 
	~"Üd”ed-d©a.h
"

32 
	~"com´essiÚ.h
"

33 
	~"ex‹Á_io.h
"

34 
	~"ex‹Á_m­.h
"

35 
	~"sub·ge.h
"

36 
	~"zÚed.h
"

37 
	~"fe-™em.h
"

38 
	~"su³r.h
"

40 
bio_£t
 
	gbŒfs_com´es£d_bio£t
;

42 cÚ¡ * cÚ¡ 
	gbŒfs_com´ess_ty³s
[] = { "", "zlib", "lzo", "zstd" };

44 cÚ¡ * 
	$bŒfs_com´ess_ty³2¡r
(
bŒfs_com´essiÚ_ty³
 
ty³
)

46 
ty³
) {

47 
BTRFS_COMPRESS_ZLIB
:

48 
BTRFS_COMPRESS_LZO
:

49 
BTRFS_COMPRESS_ZSTD
:

50 
BTRFS_COMPRESS_NONE
:

51  
bŒfs_com´ess_ty³s
[
ty³
];

56  
NULL
;

57 
	}
}

59 
šlše
 
com´es£d_bio
 *
	$to_com´es£d_bio
(
bŒfs_bio
 *
bbio
)

61  
	`cÚš”_of
(
bbio
, 
com´es£d_bio
, bbio);

62 
	}
}

64 
com´es£d_bio
 *
	$®loc_com´es£d_bio
(
bŒfs_šode
 *
šode
,

65 
u64
 
¡¬t
, 
blk_İf_t
 
İ
,

66 
bŒfs_bio_’d_io_t
 
’d_io
)

68 
bŒfs_bio
 *
bbio
;

70 
bbio
 = 
	`bŒfs_bio
(
	`bio_®loc_bio£t
(
NULL
, 
BTRFS_MAX_COMPRESSED_PAGES
, 
İ
,

71 
GFP_NOFS
, &
bŒfs_com´es£d_bio£t
));

72 
	`bŒfs_bio_š™
(
bbio
, 
šode
->
roÙ
->
fs_šfo
, 
’d_io
, 
NULL
);

73 
bbio
->
šode
 = inode;

74 
bbio
->
fe_off£t
 = 
¡¬t
;

75  
	`to_com´es£d_bio
(
bbio
);

76 
	}
}

78 
boŞ
 
	$bŒfs_com´ess_is_v®id_ty³
(cÚ¡ *
¡r
, 
size_t
 
Ën
)

80 
i
;

82 
i
 = 1; i < 
	`ARRAY_SIZE
(
bŒfs_com´ess_ty³s
); i++) {

83 
size_t
 
comp_Ën
 = 
	`¡¾’
(
bŒfs_com´ess_ty³s
[
i
]);

85 ià(
Ën
 < 
comp_Ën
)

88 ià(!
	`¡ºcmp
(
bŒfs_com´ess_ty³s
[
i
], 
¡r
, 
comp_Ën
))

89  
Œue
;

91  
çl£
;

92 
	}
}

94 
	$com´essiÚ_com´ess_·ges
(
ty³
, 
li¡_h—d
 *
ws
,

95 
add»ss_¥aû
 *
m­pšg
, 
u64
 
¡¬t
, 
·ge
 **
·ges
,

96 *
out_·ges
, *
tÙ®_š
,

97 *
tÙ®_out
)

99 
ty³
) {

100 
BTRFS_COMPRESS_ZLIB
:

101  
	`zlib_com´ess_·ges
(
ws
, 
m­pšg
, 
¡¬t
, 
·ges
,

102 
out_·ges
, 
tÙ®_š
, 
tÙ®_out
);

103 
BTRFS_COMPRESS_LZO
:

104  
	`lzo_com´ess_·ges
(
ws
, 
m­pšg
, 
¡¬t
, 
·ges
,

105 
out_·ges
, 
tÙ®_š
, 
tÙ®_out
);

106 
BTRFS_COMPRESS_ZSTD
:

107  
	`z¡d_com´ess_·ges
(
ws
, 
m­pšg
, 
¡¬t
, 
·ges
,

108 
out_·ges
, 
tÙ®_š
, 
tÙ®_out
);

109 
BTRFS_COMPRESS_NONE
:

120 *
out_·ges
 = 0;

121  -
E2BIG
;

123 
	}
}

125 
	$com´essiÚ_decom´ess_bio
(
li¡_h—d
 *
ws
,

126 
com´es£d_bio
 *
cb
)

128 
cb
->
com´ess_ty³
) {

129 
BTRFS_COMPRESS_ZLIB
:  
	`zlib_decom´ess_bio
(
ws
, 
cb
);

130 
BTRFS_COMPRESS_LZO
:  
	`lzo_decom´ess_bio
(
ws
, 
cb
);

131 
BTRFS_COMPRESS_ZSTD
:  
	`z¡d_decom´ess_bio
(
ws
, 
cb
);

132 
BTRFS_COMPRESS_NONE
:

138 
	`BUG
();

140 
	}
}

142 
	$com´essiÚ_decom´ess
(
ty³
, 
li¡_h—d
 *
ws
,

143 cÚ¡ 
u8
 *
d©a_š
, 
·ge
 *
de¡_·ge
,

144 
¡¬t_by‹
, 
size_t
 
¤ş’
, size_ˆ
de¡Ën
)

146 
ty³
) {

147 
BTRFS_COMPRESS_ZLIB
:  
	`zlib_decom´ess
(
ws
, 
d©a_š
, 
de¡_·ge
,

148 
¡¬t_by‹
, 
¤ş’
, 
de¡Ën
);

149 
BTRFS_COMPRESS_LZO
:  
	`lzo_decom´ess
(
ws
, 
d©a_š
, 
de¡_·ge
,

150 
¡¬t_by‹
, 
¤ş’
, 
de¡Ën
);

151 
BTRFS_COMPRESS_ZSTD
:  
	`z¡d_decom´ess
(
ws
, 
d©a_š
, 
de¡_·ge
,

152 
¡¬t_by‹
, 
¤ş’
, 
de¡Ën
);

153 
BTRFS_COMPRESS_NONE
:

159 
	`BUG
();

161 
	}
}

163 
	$bŒfs_ä“_com´es£d_·ges
(
com´es£d_bio
 *
cb
)

165 
i
 = 0; i < 
cb
->
Ä_·ges
; i++)

166 
	`put_·ge
(
cb
->
com´es£d_·ges
[
i
]);

167 
	`kä“
(
cb
->
com´es£d_·ges
);

168 
	}
}

170 
bŒfs_decom´ess_bio
(
com´es£d_bio
 *
cb
);

172 
	$’d_com´es£d_bio_»ad
(
bŒfs_bio
 *
bbio
)

174 
com´es£d_bio
 *
cb
 = 
	`to_com´es£d_bio
(
bbio
);

175 
blk_¡©us_t
 
¡©us
 = 
bbio
->
bio
.
bi_¡©us
;

177 ià(!
¡©us
)

178 
¡©us
 = 
	`”ºo_to_blk_¡©us
(
	`bŒfs_decom´ess_bio
(
cb
));

180 
	`bŒfs_ä“_com´es£d_·ges
(
cb
);

181 
	`bŒfs_bio_’d_io
(
cb
->
Üig_bbio
, 
¡©us
);

182 
	`bio_put
(&
bbio
->
bio
);

183 
	}
}

189 
nošlše
 
	$’d_com´es£d_wr™eback
(cÚ¡ 
com´es£d_bio
 *
cb
)

191 
šode
 *šodğ&
cb
->
bbio
.šode->
vfs_šode
;

192 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

193 
šdex
 = 
cb
->
¡¬t
 >> 
PAGE_SHIFT
;

194 
’d_šdex
 = (
cb
->
¡¬t
 + cb->
Ën
 - 1è>> 
PAGE_SHIFT
;

195 
fŞio_b©ch
 
fb©ch
;

196 cÚ¡ 
”ºo
 = 
	`blk_¡©us_to_”ºo
(
cb
->
bbio
.
bio
.
bi_¡©us
);

197 
i
;

198 
»t
;

200 ià(
”ºo
)

201 
	`m­pšg_£t_”rÜ
(
šode
->
i_m­pšg
, 
”ºo
);

203 
	`fŞio_b©ch_š™
(&
fb©ch
);

204 
šdex
 <ğ
’d_šdex
) {

205 
»t
 = 
	`fem­_g‘_fŞios
(
šode
->
i_m­pšg
, &
šdex
, 
’d_šdex
,

206 &
fb©ch
);

208 ià(
»t
 == 0)

211 
i
 = 0; i < 
»t
; i++) {

212 
fŞio
 *fŞiØğ
fb©ch
.
fŞios
[
i
];

214 
	`bŒfs_·ge_şamp_ş—r_wr™eback
(
fs_šfo
, &
fŞio
->
·ge
,

215 
cb
->
¡¬t
, cb->
Ën
);

217 
	`fŞio_b©ch_»Ëa£
(&
fb©ch
);

220 
	}
}

222 
	$bŒfs_fšish_com´es£d_wr™e_wÜk
(
wÜk_¡ruù
 *
wÜk
)

224 
com´es£d_bio
 *
cb
 =

225 
	`cÚš”_of
(
wÜk
, 
com´es£d_bio
, 
wr™e_’d_wÜk
);

227 
	`bŒfs_fšish_Üd”ed_ex‹Á
(
cb
->
bbio
.
Üd”ed
, 
NULL
, cb->
¡¬t
, cb->
Ën
,

228 
cb
->
bbio
.
bio
.
bi_¡©us
 =ğ
BLK_STS_OK
);

230 ià(
cb
->
wr™eback
)

231 
	`’d_com´es£d_wr™eback
(
cb
);

234 
	`bŒfs_ä“_com´es£d_·ges
(
cb
);

235 
	`bio_put
(&
cb
->
bbio
.
bio
);

236 
	}
}

245 
	$’d_com´es£d_bio_wr™e
(
bŒfs_bio
 *
bbio
)

247 
com´es£d_bio
 *
cb
 = 
	`to_com´es£d_bio
(
bbio
);

248 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bbio
->
šode
->
roÙ
->fs_info;

250 
	`queue_wÜk
(
fs_šfo
->
com´es£d_wr™e_wÜk”s
, &
cb
->
wr™e_’d_wÜk
);

251 
	}
}

253 
	$bŒfs_add_com´es£d_bio_·ges
(
com´es£d_bio
 *
cb
)

255 
bio
 *biØğ&
cb
->
bbio
.bio;

256 
u32
 
off£t
 = 0;

258 
off£t
 < 
cb
->
com´es£d_Ën
) {

259 
u32
 
Ën
 = 
	`mš_t
(u32, 
cb
->
com´es£d_Ën
 - 
off£t
, 
PAGE_SIZE
);

262 
	`__bio_add_·ge
(
bio
, 
cb
->
com´es£d_·ges
[
off£t
 >> 
PAGE_SHIFT
],

263 
Ën
, 0);

264 
off£t
 +ğ
Ën
;

266 
	}
}

277 
	$bŒfs_subm™_com´es£d_wr™e
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
,

278 
·ge
 **
com´es£d_·ges
,

279 
Ä_·ges
,

280 
blk_İf_t
 
wr™e_æags
,

281 
boŞ
 
wr™eback
)

283 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
Üd”ed
->inode);

284 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

285 
com´es£d_bio
 *
cb
;

287 
	`ASSERT
(
	`IS_ALIGNED
(
Üd”ed
->
fe_off£t
, 
fs_šfo
->
£ùÜsize
));

288 
	`ASSERT
(
	`IS_ALIGNED
(
Üd”ed
->
num_by‹s
, 
fs_šfo
->
£ùÜsize
));

290 
cb
 = 
	`®loc_com´es£d_bio
(
šode
, 
Üd”ed
->
fe_off£t
,

291 
REQ_OP_WRITE
 | 
wr™e_æags
,

292 
’d_com´es£d_bio_wr™e
);

293 
cb
->
¡¬t
 = 
Üd”ed
->
fe_off£t
;

294 
cb
->
Ën
 = 
Üd”ed
->
num_by‹s
;

295 
cb
->
com´es£d_·ges
 = compressed_pages;

296 
cb
->
com´es£d_Ën
 = 
Üd”ed
->
disk_num_by‹s
;

297 
cb
->
wr™eback
 = writeback;

298 
	`INIT_WORK
(&
cb
->
wr™e_’d_wÜk
, 
bŒfs_fšish_com´es£d_wr™e_wÜk
);

299 
cb
->
Ä_·ges
 =‚r_pages;

300 
cb
->
bbio
.
bio
.
bi_™”
.
bi_£ùÜ
 = 
Üd”ed
->
disk_by‹Ä
 >> 
SECTOR_SHIFT
;

301 
cb
->
bbio
.
Üd”ed
 = ordered;

302 
	`bŒfs_add_com´es£d_bio_·ges
(
cb
);

304 
	`bŒfs_subm™_bio
(&
cb
->
bbio
, 0);

305 
	}
}

318 
nošlše
 
	$add_¿_bio_·ges
(
šode
 *inode,

319 
u64
 
com´es£d_’d
,

320 
com´es£d_bio
 *
cb
,

321 *
mem¡®l
, *
pæags
)

323 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

324 
’d_šdex
;

325 
bio
 *
Üig_bio
 = &
cb
->
Üig_bbio
->bio;

326 
u64
 
cur
 = 
cb
->
Üig_bbio
->
fe_off£t
 + 
Üig_bio
->
bi_™”
.
bi_size
;

327 
u64
 
isize
 = 
	`i_size_»ad
(
šode
);

328 
»t
;

329 
·ge
 *page;

330 
ex‹Á_m­
 *
em
;

331 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

332 
ex‹Á_m­_Œ“
 *
em_Œ“
;

333 
ex‹Á_io_Œ“
 *
Œ“
;

334 
£ùÜs_mis£d
 = 0;

336 
em_Œ“
 = &
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
;

337 
Œ“
 = &
	`BTRFS_I
(
šode
)->
io_Œ“
;

339 ià(
isize
 == 0)

349 ià(
	`bŒfs_sb
(
šode
->
i_sb
)->
£ùÜsize
 < 
PAGE_SIZE
)

352 
’d_šdex
 = (
	`i_size_»ad
(
šode
è- 1è>> 
PAGE_SHIFT
;

354 
cur
 < 
com´es£d_’d
) {

355 
u64
 
·ge_’d
;

356 
u64
 
pg_šdex
 = 
cur
 >> 
PAGE_SHIFT
;

357 
u32
 
add_size
;

359 ià(
pg_šdex
 > 
’d_šdex
)

362 
·ge
 = 
	`xa_lßd
(&
m­pšg
->
i_·ges
, 
pg_šdex
);

363 ià(
·ge
 && !
	`xa_is_v®ue
(page)) {

364 
£ùÜs_mis£d
 +ğ(
PAGE_SIZE
 - 
	`off£t_š_·ge
(
cur
)) >>

365 
fs_šfo
->
£ùÜsize_b™s
;

368 ià(
£ùÜs_mis£d
 > 4)

375 
cur
 = (
pg_šdex
 << 
PAGE_SHIFT
è+ 
PAGE_SIZE
;

379 
·ge
 = 
	`__·ge_ÿche_®loc
(
	`m­pšg_gå_cÚ¡¿št
(
m­pšg
,

380 ~
__GFP_FS
));

381 ià(!
·ge
)

384 ià(
	`add_to_·ge_ÿche_Ìu
(
·ge
, 
m­pšg
, 
pg_šdex
, 
GFP_NOFS
)) {

385 
	`put_·ge
(
·ge
);

387 
cur
 = (
pg_šdex
 << 
PAGE_SHIFT
è+ 
PAGE_SIZE
;

391 ià(!*
mem¡®l
 && 
	`PageWÜkšg£t
(
·ge
)) {

392 
	`psi_mem¡®l_’‹r
(
pæags
);

393 *
mem¡®l
 = 1;

396 
»t
 = 
	`£t_·ge_ex‹Á_m­³d
(
·ge
);

397 ià(
»t
 < 0) {

398 
	`uÆock_·ge
(
·ge
);

399 
	`put_·ge
(
·ge
);

403 
·ge_’d
 = (
pg_šdex
 << 
PAGE_SHIFT
è+ 
PAGE_SIZE
 - 1;

404 
	`lock_ex‹Á
(
Œ“
, 
cur
, 
·ge_’d
, 
NULL
);

405 
	`»ad_lock
(&
em_Œ“
->
lock
);

406 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
cur
, 
·ge_’d
 + 1 - cur);

407 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

414 ià(!
em
 || 
cur
 <ƒm->
¡¬t
 ||

415 (
cur
 + 
fs_šfo
->
£ùÜsize
 > 
	`ex‹Á_m­_’d
(
em
)) ||

416 (
em
->
block_¡¬t
 >> 
SECTOR_SHIFT
è!ğ
Üig_bio
->
bi_™”
.
bi_£ùÜ
) {

417 
	`ä“_ex‹Á_m­
(
em
);

418 
	`uÆock_ex‹Á
(
Œ“
, 
cur
, 
·ge_’d
, 
NULL
);

419 
	`uÆock_·ge
(
·ge
);

420 
	`put_·ge
(
·ge
);

423 
	`ä“_ex‹Á_m­
(
em
);

425 ià(
·ge
->
šdex
 =ğ
’d_šdex
) {

426 
size_t
 
z”o_off£t
 = 
	`off£t_š_·ge
(
isize
);

428 ià(
z”o_off£t
) {

429 
z”os
;

430 
z”os
 = 
PAGE_SIZE
 - 
z”o_off£t
;

431 
	`memz”o_·ge
(
·ge
, 
z”o_off£t
, 
z”os
);

435 
add_size
 = 
	`mš
(
em
->
¡¬t
 +ƒm->
Ën
, 
·ge_’d
 + 1è- 
cur
;

436 
»t
 = 
	`bio_add_·ge
(
Üig_bio
, 
·ge
, 
add_size
, 
	`off£t_š_·ge
(
cur
));

437 ià(
»t
 !ğ
add_size
) {

438 
	`uÆock_ex‹Á
(
Œ“
, 
cur
, 
·ge_’d
, 
NULL
);

439 
	`uÆock_·ge
(
·ge
);

440 
	`put_·ge
(
·ge
);

448 ià(
fs_šfo
->
£ùÜsize
 < 
PAGE_SIZE
)

449 
	`bŒfs_sub·ge_¡¬t_»ad”
(
fs_šfo
, 
·ge
, 
cur
, 
add_size
);

450 
	`put_·ge
(
·ge
);

451 
cur
 +ğ
add_size
;

454 
	}
}

467 
	$bŒfs_subm™_com´es£d_»ad
(
bŒfs_bio
 *
bbio
)

469 
bŒfs_šode
 *
šode
 = 
bbio
->inode;

470 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

471 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
šode
->
ex‹Á_Œ“
;

472 
com´es£d_bio
 *
cb
;

473 
com´es£d_Ën
;

474 
u64
 
fe_off£t
 = 
bbio
->file_offset;

475 
u64
 
em_Ën
;

476 
u64
 
em_¡¬t
;

477 
ex‹Á_m­
 *
em
;

478 
pæags
;

479 
mem¡®l
 = 0;

480 
blk_¡©us_t
 
»t
;

481 
»t2
;

484 
	`»ad_lock
(&
em_Œ“
->
lock
);

485 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
fe_off£t
, 
fs_šfo
->
£ùÜsize
);

486 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

487 ià(!
em
) {

488 
»t
 = 
BLK_STS_IOERR
;

489 
out
;

492 
	`ASSERT
(
em
->
com´ess_ty³
 !ğ
BTRFS_COMPRESS_NONE
);

493 
com´es£d_Ën
 = 
em
->
block_Ën
;

495 
cb
 = 
	`®loc_com´es£d_bio
(
šode
, 
fe_off£t
, 
REQ_OP_READ
,

496 
’d_com´es£d_bio_»ad
);

498 
cb
->
¡¬t
 = 
em
->
Üig_¡¬t
;

499 
em_Ën
 = 
em
->
Ën
;

500 
em_¡¬t
 = 
em
->
¡¬t
;

502 
cb
->
Ën
 = 
bbio
->
bio
.
bi_™”
.
bi_size
;

503 
cb
->
com´es£d_Ën
 = compressed_len;

504 
cb
->
com´ess_ty³
 = 
em
->compress_type;

505 
cb
->
Üig_bbio
 = 
bbio
;

507 
	`ä“_ex‹Á_m­
(
em
);

509 
cb
->
Ä_·ges
 = 
	`DIV_ROUND_UP
(
com´es£d_Ën
, 
PAGE_SIZE
);

510 
cb
->
com´es£d_·ges
 = 
	`kÿÎoc
(cb->
Ä_·ges
, (
·ge
 *), 
GFP_NOFS
);

511 ià(!
cb
->
com´es£d_·ges
) {

512 
»t
 = 
BLK_STS_RESOURCE
;

513 
out_ä“_bio
;

516 
»t2
 = 
	`bŒfs_®loc_·ge_¬¿y
(
cb
->
Ä_·ges
, cb->
com´es£d_·ges
);

517 ià(
»t2
) {

518 
»t
 = 
BLK_STS_RESOURCE
;

519 
out_ä“_com´es£d_·ges
;

522 
	`add_¿_bio_·ges
(&
šode
->
vfs_šode
, 
em_¡¬t
 + 
em_Ën
, 
cb
, &
mem¡®l
,

523 &
pæags
);

526 
cb
->
Ën
 = 
bbio
->
bio
.
bi_™”
.
bi_size
;

527 
cb
->
bbio
.
bio
.
bi_™”
.
bi_£ùÜ
 = bbio->bio.bi_iter.bi_sector;

528 
	`bŒfs_add_com´es£d_bio_·ges
(
cb
);

530 ià(
mem¡®l
)

531 
	`psi_mem¡®l_Ëave
(&
pæags
);

533 
	`bŒfs_subm™_bio
(&
cb
->
bbio
, 0);

536 
out_ä“_com´es£d_·ges
:

537 
	`kä“
(
cb
->
com´es£d_·ges
);

538 
out_ä“_bio
:

539 
	`bio_put
(&
cb
->
bbio
.
bio
);

540 
out
:

541 
	`bŒfs_bio_’d_io
(
bbio
, 
»t
);

542 
	}
}

551 
	#SAMPLING_READ_SIZE
 (16)

	)

552 
	#SAMPLING_INTERVAL
 (256)

	)

559 
	#BUCKET_SIZE
 (256)

	)

573 
	#MAX_SAMPLE_SIZE
 (
BTRFS_MAX_UNCOMPRESSED
 * \

574 
SAMPLING_READ_SIZE
 / 
SAMPLING_INTERVAL
)

	)

576 
	sbuck‘_™em
 {

577 
u32
 
	mcouÁ
;

580 
	sheuri¡ic_ws
 {

582 
u8
 *
	m§m¶e
;

583 
u32
 
	m§m¶e_size
;

585 
buck‘_™em
 *
	mbuck‘
;

587 
buck‘_™em
 *
	mbuck‘_b
;

588 
li¡_h—d
 
	mli¡
;

591 
wÜk¥aû_mªag”
 
	gheuri¡ic_wsm
;

593 
	$ä“_heuri¡ic_ws
(
li¡_h—d
 *
ws
)

595 
heuri¡ic_ws
 *
wÜk¥aû
;

597 
wÜk¥aû
 = 
	`li¡_’Œy
(
ws
, 
heuri¡ic_ws
, 
li¡
);

599 
	`kvä“
(
wÜk¥aû
->
§m¶e
);

600 
	`kä“
(
wÜk¥aû
->
buck‘
);

601 
	`kä“
(
wÜk¥aû
->
buck‘_b
);

602 
	`kä“
(
wÜk¥aû
);

603 
	}
}

605 
li¡_h—d
 *
	$®loc_heuri¡ic_ws
(
Ëv–
)

607 
heuri¡ic_ws
 *
ws
;

609 
ws
 = 
	`kz®loc
((*ws), 
GFP_KERNEL
);

610 ià(!
ws
)

611  
	`ERR_PTR
(-
ENOMEM
);

613 
ws
->
§m¶e
 = 
	`kvm®loc
(
MAX_SAMPLE_SIZE
, 
GFP_KERNEL
);

614 ià(!
ws
->
§m¶e
)

615 
ç
;

617 
ws
->
buck‘
 = 
	`kÿÎoc
(
BUCKET_SIZE
, (*ws->buck‘), 
GFP_KERNEL
);

618 ià(!
ws
->
buck‘
)

619 
ç
;

621 
ws
->
buck‘_b
 = 
	`kÿÎoc
(
BUCKET_SIZE
, (*ws->buck‘_b), 
GFP_KERNEL
);

622 ià(!
ws
->
buck‘_b
)

623 
ç
;

625 
	`INIT_LIST_HEAD
(&
ws
->
li¡
);

626  &
ws
->
li¡
;

627 
ç
:

628 
	`ä“_heuri¡ic_ws
(&
ws
->
li¡
);

629  
	`ERR_PTR
(-
ENOMEM
);

630 
	}
}

632 cÚ¡ 
bŒfs_com´ess_İ
 
	gbŒfs_heuri¡ic_com´ess
 = {

633 .
wÜk¥aû_mªag”
 = &
heuri¡ic_wsm
,

636 cÚ¡ 
bŒfs_com´ess_İ
 * cÚ¡ 
	gbŒfs_com´ess_İ
[] = {

638 &
bŒfs_heuri¡ic_com´ess
,

639 &
bŒfs_zlib_com´ess
,

640 &
bŒfs_lzo_com´ess
,

641 &
bŒfs_z¡d_com´ess
,

644 
li¡_h—d
 *
	$®loc_wÜk¥aû
(
ty³
, 
Ëv–
)

646 
ty³
) {

647 
BTRFS_COMPRESS_NONE
:  
	`®loc_heuri¡ic_ws
(
Ëv–
);

648 
BTRFS_COMPRESS_ZLIB
:  
	`zlib_®loc_wÜk¥aû
(
Ëv–
);

649 
BTRFS_COMPRESS_LZO
:  
	`lzo_®loc_wÜk¥aû
(
Ëv–
);

650 
BTRFS_COMPRESS_ZSTD
:  
	`z¡d_®loc_wÜk¥aû
(
Ëv–
);

656 
	`BUG
();

658 
	}
}

660 
	$ä“_wÜk¥aû
(
ty³
, 
li¡_h—d
 *
ws
)

662 
ty³
) {

663 
BTRFS_COMPRESS_NONE
:  
	`ä“_heuri¡ic_ws
(
ws
);

664 
BTRFS_COMPRESS_ZLIB
:  
	`zlib_ä“_wÜk¥aû
(
ws
);

665 
BTRFS_COMPRESS_LZO
:  
	`lzo_ä“_wÜk¥aû
(
ws
);

666 
BTRFS_COMPRESS_ZSTD
:  
	`z¡d_ä“_wÜk¥aû
(
ws
);

672 
	`BUG
();

674 
	}
}

676 
	$bŒfs_š™_wÜk¥aû_mªag”
(
ty³
)

678 
wÜk¥aû_mªag”
 *
wsm
;

679 
li¡_h—d
 *
wÜk¥aû
;

681 
wsm
 = 
bŒfs_com´ess_İ
[
ty³
]->
wÜk¥aû_mªag”
;

682 
	`INIT_LIST_HEAD
(&
wsm
->
idË_ws
);

683 
	`¥š_lock_š™
(&
wsm
->
ws_lock
);

684 
	`©omic_£t
(&
wsm
->
tÙ®_ws
, 0);

685 
	`š™_wa™queue_h—d
(&
wsm
->
ws_wa™
);

691 
wÜk¥aû
 = 
	`®loc_wÜk¥aû
(
ty³
, 0);

692 ià(
	`IS_ERR
(
wÜk¥aû
)) {

693 
	`´_w¬n
(

696 
	`©omic_£t
(&
wsm
->
tÙ®_ws
, 1);

697 
wsm
->
ä“_ws
 = 1;

698 
	`li¡_add
(
wÜk¥aû
, &
wsm
->
idË_ws
);

700 
	}
}

702 
	$bŒfs_ş—nup_wÜk¥aû_mªag”
(
ty³
)

704 
wÜk¥aû_mªag”
 *
wsmª
;

705 
li¡_h—d
 *
ws
;

707 
wsmª
 = 
bŒfs_com´ess_İ
[
ty³
]->
wÜk¥aû_mªag”
;

708 !
	`li¡_em±y
(&
wsmª
->
idË_ws
)) {

709 
ws
 = 
wsmª
->
idË_ws
.
Ãxt
;

710 
	`li¡_d–
(
ws
);

711 
	`ä“_wÜk¥aû
(
ty³
, 
ws
);

712 
	`©omic_dec
(&
wsmª
->
tÙ®_ws
);

714 
	}
}

722 
li¡_h—d
 *
	$bŒfs_g‘_wÜk¥aû
(
ty³
, 
Ëv–
)

724 
wÜk¥aû_mªag”
 *
wsm
;

725 
li¡_h—d
 *
wÜk¥aû
;

726 
ıus
 = 
	`num_Úlše_ıus
();

727 
nofs_æag
;

728 
li¡_h—d
 *
idË_ws
;

729 
¥šlock_t
 *
ws_lock
;

730 
©omic_t
 *
tÙ®_ws
;

731 
wa™_queue_h—d_t
 *
ws_wa™
;

732 *
ä“_ws
;

734 
wsm
 = 
bŒfs_com´ess_İ
[
ty³
]->
wÜk¥aû_mªag”
;

735 
idË_ws
 = &
wsm
->idle_ws;

736 
ws_lock
 = &
wsm
->ws_lock;

737 
tÙ®_ws
 = &
wsm
->total_ws;

738 
ws_wa™
 = &
wsm
->ws_wait;

739 
ä“_ws
 = &
wsm
->free_ws;

741 
agaš
:

742 
	`¥š_lock
(
ws_lock
);

743 ià(!
	`li¡_em±y
(
idË_ws
)) {

744 
wÜk¥aû
 = 
idË_ws
->
Ãxt
;

745 
	`li¡_d–
(
wÜk¥aû
);

746 (*
ä“_ws
)--;

747 
	`¥š_uÆock
(
ws_lock
);

748  
wÜk¥aû
;

751 ià(
	`©omic_»ad
(
tÙ®_ws
è> 
ıus
) {

752 
	`DEFINE_WAIT
(
wa™
);

754 
	`¥š_uÆock
(
ws_lock
);

755 
	`´•¬e_to_wa™
(
ws_wa™
, &
wa™
, 
TASK_UNINTERRUPTIBLE
);

756 ià(
	`©omic_»ad
(
tÙ®_ws
è> 
ıus
 && !*
ä“_ws
)

757 
	`scheduË
();

758 
	`fšish_wa™
(
ws_wa™
, &
wa™
);

759 
agaš
;

761 
	`©omic_šc
(
tÙ®_ws
);

762 
	`¥š_uÆock
(
ws_lock
);

769 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

770 
wÜk¥aû
 = 
	`®loc_wÜk¥aû
(
ty³
, 
Ëv–
);

771 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

773 ià(
	`IS_ERR
(
wÜk¥aû
)) {

774 
	`©omic_dec
(
tÙ®_ws
);

775 
	`wake_up
(
ws_wa™
);

787 ià(
	`©omic_»ad
(
tÙ®_ws
) == 0) {

788 
	`DEFINE_RATELIMIT_STATE
(
_rs
,

789  60 * 
HZ
,

792 ià(
	`__¿‹lim™
(&
_rs
)) {

793 
	`´_w¬n
("BTRFS:‚o compression workspaces,†ow memory,„etrying\n");

796 
agaš
;

798  
wÜk¥aû
;

799 
	}
}

801 
li¡_h—d
 *
	$g‘_wÜk¥aû
(
ty³
, 
Ëv–
)

803 
ty³
) {

804 
BTRFS_COMPRESS_NONE
:  
	`bŒfs_g‘_wÜk¥aû
(
ty³
, 
Ëv–
);

805 
BTRFS_COMPRESS_ZLIB
:  
	`zlib_g‘_wÜk¥aû
(
Ëv–
);

806 
BTRFS_COMPRESS_LZO
:  
	`bŒfs_g‘_wÜk¥aû
(
ty³
, 
Ëv–
);

807 
BTRFS_COMPRESS_ZSTD
:  
	`z¡d_g‘_wÜk¥aû
(
Ëv–
);

813 
	`BUG
();

815 
	}
}

821 
	$bŒfs_put_wÜk¥aû
(
ty³
, 
li¡_h—d
 *
ws
)

823 
wÜk¥aû_mªag”
 *
wsm
;

824 
li¡_h—d
 *
idË_ws
;

825 
¥šlock_t
 *
ws_lock
;

826 
©omic_t
 *
tÙ®_ws
;

827 
wa™_queue_h—d_t
 *
ws_wa™
;

828 *
ä“_ws
;

830 
wsm
 = 
bŒfs_com´ess_İ
[
ty³
]->
wÜk¥aû_mªag”
;

831 
idË_ws
 = &
wsm
->idle_ws;

832 
ws_lock
 = &
wsm
->ws_lock;

833 
tÙ®_ws
 = &
wsm
->total_ws;

834 
ws_wa™
 = &
wsm
->ws_wait;

835 
ä“_ws
 = &
wsm
->free_ws;

837 
	`¥š_lock
(
ws_lock
);

838 ià(*
ä“_ws
 <ğ
	`num_Úlše_ıus
()) {

839 
	`li¡_add
(
ws
, 
idË_ws
);

840 (*
ä“_ws
)++;

841 
	`¥š_uÆock
(
ws_lock
);

842 
wake
;

844 
	`¥š_uÆock
(
ws_lock
);

846 
	`ä“_wÜk¥aû
(
ty³
, 
ws
);

847 
	`©omic_dec
(
tÙ®_ws
);

848 
wake
:

849 
	`cÚd_wake_up
(
ws_wa™
);

850 
	}
}

852 
	$put_wÜk¥aû
(
ty³
, 
li¡_h—d
 *
ws
)

854 
ty³
) {

855 
BTRFS_COMPRESS_NONE
:  
	`bŒfs_put_wÜk¥aû
(
ty³
, 
ws
);

856 
BTRFS_COMPRESS_ZLIB
:  
	`bŒfs_put_wÜk¥aû
(
ty³
, 
ws
);

857 
BTRFS_COMPRESS_LZO
:  
	`bŒfs_put_wÜk¥aû
(
ty³
, 
ws
);

858 
BTRFS_COMPRESS_ZSTD
:  
	`z¡d_put_wÜk¥aû
(
ws
);

864 
	`BUG
();

866 
	}
}

872 
	$bŒfs_com´ess_£t_Ëv–
(
ty³
, 
Ëv–
)

874 cÚ¡ 
bŒfs_com´ess_İ
 *
İs
 = bŒfs_com´ess_İ[
ty³
];

876 ià(
Ëv–
 == 0)

877 
Ëv–
 = 
İs
->
deçuÉ_Ëv–
;

879 
Ëv–
 = 
	`mš
Öev–, 
İs
->
max_Ëv–
);

881  
Ëv–
;

882 
	}
}

904 
	$bŒfs_com´ess_·ges
(
ty³_Ëv–
, 
add»ss_¥aû
 *
m­pšg
,

905 
u64
 
¡¬t
, 
·ge
 **
·ges
,

906 *
out_·ges
,

907 *
tÙ®_š
,

908 *
tÙ®_out
)

910 
ty³
 = 
	`bŒfs_com´ess_ty³
(
ty³_Ëv–
);

911 
Ëv–
 = 
	`bŒfs_com´ess_Ëv–
(
ty³_Ëv–
);

912 
li¡_h—d
 *
wÜk¥aû
;

913 
»t
;

915 
Ëv–
 = 
	`bŒfs_com´ess_£t_Ëv–
(
ty³
,†evel);

916 
wÜk¥aû
 = 
	`g‘_wÜk¥aû
(
ty³
, 
Ëv–
);

917 
»t
 = 
	`com´essiÚ_com´ess_·ges
(
ty³
, 
wÜk¥aû
, 
m­pšg
, 
¡¬t
, 
·ges
,

918 
out_·ges
, 
tÙ®_š
, 
tÙ®_out
);

919 
	`put_wÜk¥aû
(
ty³
, 
wÜk¥aû
);

920  
»t
;

921 
	}
}

923 
	$bŒfs_decom´ess_bio
(
com´es£d_bio
 *
cb
)

925 
li¡_h—d
 *
wÜk¥aû
;

926 
»t
;

927 
ty³
 = 
cb
->
com´ess_ty³
;

929 
wÜk¥aû
 = 
	`g‘_wÜk¥aû
(
ty³
, 0);

930 
»t
 = 
	`com´essiÚ_decom´ess_bio
(
wÜk¥aû
, 
cb
);

931 
	`put_wÜk¥aû
(
ty³
, 
wÜk¥aû
);

933 ià(!
»t
)

934 
	`z”o_fl_bio
(&
cb
->
Üig_bbio
->
bio
);

935  
»t
;

936 
	}
}

943 
	$bŒfs_decom´ess
(
ty³
, cÚ¡ 
u8
 *
d©a_š
, 
·ge
 *
de¡_·ge
,

944 
¡¬t_by‹
, 
size_t
 
¤ş’
, size_ˆ
de¡Ën
)

946 
li¡_h—d
 *
wÜk¥aû
;

947 
»t
;

949 
wÜk¥aû
 = 
	`g‘_wÜk¥aû
(
ty³
, 0);

950 
»t
 = 
	`com´essiÚ_decom´ess
(
ty³
, 
wÜk¥aû
, 
d©a_š
, 
de¡_·ge
,

951 
¡¬t_by‹
, 
¤ş’
, 
de¡Ën
);

952 
	`put_wÜk¥aû
(
ty³
, 
wÜk¥aû
);

954  
»t
;

955 
	}
}

957 
__š™
 
	$bŒfs_š™_com´ess
()

959 ià(
	`bio£t_š™
(&
bŒfs_com´es£d_bio£t
, 
BIO_POOL_SIZE
,

960 
	`off£tof
(
com´es£d_bio
, 
bbio
.
bio
),

961 
BIOSET_NEED_BVECS
))

962  -
ENOMEM
;

963 
	`bŒfs_š™_wÜk¥aû_mªag”
(
BTRFS_COMPRESS_NONE
);

964 
	`bŒfs_š™_wÜk¥aû_mªag”
(
BTRFS_COMPRESS_ZLIB
);

965 
	`bŒfs_š™_wÜk¥aû_mªag”
(
BTRFS_COMPRESS_LZO
);

966 
	`z¡d_š™_wÜk¥aû_mªag”
();

968 
	}
}

970 
__cŞd
 
	$bŒfs_ex™_com´ess
()

972 
	`bŒfs_ş—nup_wÜk¥aû_mªag”
(
BTRFS_COMPRESS_NONE
);

973 
	`bŒfs_ş—nup_wÜk¥aû_mªag”
(
BTRFS_COMPRESS_ZLIB
);

974 
	`bŒfs_ş—nup_wÜk¥aû_mªag”
(
BTRFS_COMPRESS_LZO
);

975 
	`z¡d_ş—nup_wÜk¥aû_mªag”
();

976 
	`bio£t_ex™
(&
bŒfs_com´es£d_bio£t
);

977 
	}
}

1009 
	$bŒfs_decom´ess_buf2·ge
(cÚ¡ *
buf
, 
u32
 
buf_Ën
,

1010 
com´es£d_bio
 *
cb
, 
u32
 
decom´es£d
)

1012 
bio
 *
Üig_bio
 = &
cb
->
Üig_bbio
->bio;

1014 
u32
 
cur_off£t
;

1016 
cur_off£t
 = 
decom´es£d
;

1018 
cur_off£t
 < 
decom´es£d
 + 
buf_Ën
) {

1019 
bio_vec
 
bvec
;

1020 
size_t
 
cİy_Ën
;

1021 
u32
 
cİy_¡¬t
;

1023 
u32
 
bvec_off£t
;

1025 
bvec
 = 
	`bio_™”_iovec
(
Üig_bio
, orig_bio->
bi_™”
);

1030 
bvec_off£t
 = 
	`·ge_off£t
(
bvec
.
bv_·ge
è+ bvec.
bv_off£t
 - 
cb
->
¡¬t
;

1033 ià(
decom´es£d
 + 
buf_Ën
 <ğ
bvec_off£t
)

1036 
cİy_¡¬t
 = 
	`max
(
cur_off£t
, 
bvec_off£t
);

1037 
cİy_Ën
 = 
	`mš
(
bvec_off£t
 + 
bvec
.
bv_Ën
,

1038 
decom´es£d
 + 
buf_Ën
è- 
cİy_¡¬t
;

1039 
	`ASSERT
(
cİy_Ën
);

1045 
	`ASSERT
(
cİy_¡¬t
 - 
decom´es£d
 < 
buf_Ën
);

1046 
	`memıy_to_·ge
(
bvec
.
bv_·ge
, bvec.
bv_off£t
,

1047 
buf
 + 
cİy_¡¬t
 - 
decom´es£d
, 
cİy_Ën
);

1048 
cur_off£t
 +ğ
cİy_Ën
;

1050 
	`bio_advªû
(
Üig_bio
, 
cİy_Ën
);

1052 ià(!
Üig_bio
->
bi_™”
.
bi_size
)

1056 
	}
}

1075 
	#ENTROPY_LVL_ACEPTABLE
 (65)

	)

1076 
	#ENTROPY_LVL_HIGH
 (80)

	)

1088 
šlše
 
u32
 
	$og2_w
(
u64
 
n
)

1090  
	`og2
(
n
 *‚ *‚ *‚);

1091 
	}
}

1093 
u32
 
	$shªnÚ_’Œİy
(
heuri¡ic_ws
 *
ws
)

1095 cÚ¡ 
u32
 
’Œİy_max
 = 8 * 
	`og2_w
(2);

1096 
u32
 
’Œİy_sum
 = 0;

1097 
u32
 
p
, 
p_ba£
, 
sz_ba£
;

1098 
u32
 
i
;

1100 
sz_ba£
 = 
	`og2_w
(
ws
->
§m¶e_size
);

1101 
i
 = 0; i < 
BUCKET_SIZE
 && 
ws
->
buck‘
[i].
couÁ
 > 0; i++) {

1102 
p
 = 
ws
->
buck‘
[
i
].
couÁ
;

1103 
p_ba£
 = 
	`og2_w
(
p
);

1104 
’Œİy_sum
 +ğ
p
 * (
sz_ba£
 - 
p_ba£
);

1107 
’Œİy_sum
 /ğ
ws
->
§m¶e_size
;

1108  
’Œİy_sum
 * 100 / 
’Œİy_max
;

1109 
	}
}

1111 
	#RADIX_BASE
 4U

	)

1112 
	#COUNTERS_SIZE
 (1U << 
RADIX_BASE
)

	)

1114 
u8
 
	$g‘4b™s
(
u64
 
num
, 
shiá
) {

1115 
u8
 
low4b™s
;

1117 
num
 >>ğ
shiá
;

1119 
low4b™s
 = (
COUNTERS_SIZE
 - 1è- (
num
 % COUNTERS_SIZE);

1120  
low4b™s
;

1121 
	}
}

1132 
	$¿dix_sÜt
(
buck‘_™em
 *
¬¿y
, buck‘_™em *
¬¿y_buf
,

1133 
num
)

1135 
u64
 
max_num
;

1136 
u64
 
buf_num
;

1137 
u32
 
couÁ”s
[
COUNTERS_SIZE
];

1138 
u32
 
Ãw_addr
;

1139 
u32
 
addr
;

1140 
b™Ën
;

1141 
shiá
;

1142 
i
;

1148 
max_num
 = 
¬¿y
[0].
couÁ
;

1149 
i
 = 1; i < 
num
; i++) {

1150 
buf_num
 = 
¬¿y
[
i
].
couÁ
;

1151 ià(
buf_num
 > 
max_num
)

1152 
max_num
 = 
buf_num
;

1155 
buf_num
 = 
	`og2
(
max_num
);

1156 
b™Ën
 = 
	`ALIGN
(
buf_num
, 
RADIX_BASE
 * 2);

1158 
shiá
 = 0;

1159 
shiá
 < 
b™Ën
) {

1160 
	`mem£t
(
couÁ”s
, 0, (counters));

1162 
i
 = 0; i < 
num
; i++) {

1163 
buf_num
 = 
¬¿y
[
i
].
couÁ
;

1164 
addr
 = 
	`g‘4b™s
(
buf_num
, 
shiá
);

1165 
couÁ”s
[
addr
]++;

1168 
i
 = 1; i < 
COUNTERS_SIZE
; i++)

1169 
couÁ”s
[
i
] += counters[i - 1];

1171 
i
 = 
num
 - 1; i >= 0; i--) {

1172 
buf_num
 = 
¬¿y
[
i
].
couÁ
;

1173 
addr
 = 
	`g‘4b™s
(
buf_num
, 
shiá
);

1174 
couÁ”s
[
addr
]--;

1175 
Ãw_addr
 = 
couÁ”s
[
addr
];

1176 
¬¿y_buf
[
Ãw_addr
] = 
¬¿y
[
i
];

1179 
shiá
 +ğ
RADIX_BASE
;

1187 
	`mem£t
(
couÁ”s
, 0, (counters));

1189 
i
 = 0; i < 
num
; i ++) {

1190 
buf_num
 = 
¬¿y_buf
[
i
].
couÁ
;

1191 
addr
 = 
	`g‘4b™s
(
buf_num
, 
shiá
);

1192 
couÁ”s
[
addr
]++;

1195 
i
 = 1; i < 
COUNTERS_SIZE
; i++)

1196 
couÁ”s
[
i
] += counters[i - 1];

1198 
i
 = 
num
 - 1; i >= 0; i--) {

1199 
buf_num
 = 
¬¿y_buf
[
i
].
couÁ
;

1200 
addr
 = 
	`g‘4b™s
(
buf_num
, 
shiá
);

1201 
couÁ”s
[
addr
]--;

1202 
Ãw_addr
 = 
couÁ”s
[
addr
];

1203 
¬¿y
[
Ãw_addr
] = 
¬¿y_buf
[
i
];

1206 
shiá
 +ğ
RADIX_BASE
;

1208 
	}
}

1226 
	#BYTE_CORE_SET_LOW
 (64)

	)

1227 
	#BYTE_CORE_SET_HIGH
 (200)

	)

1229 
	$by‹_cÜe_£t_size
(
heuri¡ic_ws
 *
ws
)

1231 
u32
 
i
;

1232 
u32
 
cÜe£t_sum
 = 0;

1233 cÚ¡ 
u32
 
cÜe_£t_th»shŞd
 = 
ws
->
§m¶e_size
 * 90 / 100;

1234 
buck‘_™em
 *
buck‘
 = 
ws
->bucket;

1237 
	`¿dix_sÜt
(
ws
->
buck‘
, ws->
buck‘_b
, 
BUCKET_SIZE
);

1239 
i
 = 0; i < 
BYTE_CORE_SET_LOW
; i++)

1240 
cÜe£t_sum
 +ğ
buck‘
[
i
].
couÁ
;

1242 ià(
cÜe£t_sum
 > 
cÜe_£t_th»shŞd
)

1243  
i
;

1245 ; 
i
 < 
BYTE_CORE_SET_HIGH
 && 
buck‘
[i].
couÁ
 > 0; i++) {

1246 
cÜe£t_sum
 +ğ
buck‘
[
i
].
couÁ
;

1247 ià(
cÜe£t_sum
 > 
cÜe_£t_th»shŞd
)

1251  
i
;

1252 
	}
}

1265 
	#BYTE_SET_THRESHOLD
 (64)

	)

1267 
u32
 
	$by‹_£t_size
(cÚ¡ 
heuri¡ic_ws
 *
ws
)

1269 
u32
 
i
;

1270 
u32
 
by‹_£t_size
 = 0;

1272 
i
 = 0; i < 
BYTE_SET_THRESHOLD
; i++) {

1273 ià(
ws
->
buck‘
[
i
].
couÁ
 > 0)

1274 
by‹_£t_size
++;

1282 ; 
i
 < 
BUCKET_SIZE
; i++) {

1283 ià(
ws
->
buck‘
[
i
].
couÁ
 > 0) {

1284 
by‹_£t_size
++;

1285 ià(
by‹_£t_size
 > 
BYTE_SET_THRESHOLD
)

1286  
by‹_£t_size
;

1290  
by‹_£t_size
;

1291 
	}
}

1293 
boŞ
 
	$§m¶e_»³©ed_·‰”ns
(
heuri¡ic_ws
 *
ws
)

1295 cÚ¡ 
u32
 
h®f_of_§m¶e
 = 
ws
->
§m¶e_size
 / 2;

1296 cÚ¡ 
u8
 *
d©a
 = 
ws
->
§m¶e
;

1298  
	`memcmp
(&
d©a
[0], &d©a[
h®f_of_§m¶e
], half_of_sample) == 0;

1299 
	}
}

1301 
	$heuri¡ic_cŞËù_§m¶e
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
,

1302 
heuri¡ic_ws
 *
ws
)

1304 
·ge
 *page;

1305 
u64
 
šdex
, 
šdex_’d
;

1306 
u32
 
i
, 
cu¼_§m¶e_pos
;

1307 
u8
 *
š_d©a
;

1318 ià(
’d
 - 
¡¬t
 > 
BTRFS_MAX_UNCOMPRESSED
)

1319 
’d
 = 
¡¬t
 + 
BTRFS_MAX_UNCOMPRESSED
;

1321 
šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

1322 
šdex_’d
 = 
’d
 >> 
PAGE_SHIFT
;

1325 ià(!
	`PAGE_ALIGNED
(
’d
))

1326 
šdex_’d
++;

1328 
cu¼_§m¶e_pos
 = 0;

1329 
šdex
 < 
šdex_’d
) {

1330 
·ge
 = 
	`fšd_g‘_·ge
(
šode
->
i_m­pšg
, 
šdex
);

1331 
š_d©a
 = 
	`km­_loÿl_·ge
(
·ge
);

1333 
i
 = 
¡¬t
 % 
PAGE_SIZE
;

1334 
i
 < 
PAGE_SIZE
 - 
SAMPLING_READ_SIZE
) {

1336 ià(
¡¬t
 > 
’d
 - 
SAMPLING_READ_SIZE
)

1338 
	`memıy
(&
ws
->
§m¶e
[
cu¼_§m¶e_pos
], &
š_d©a
[
i
],

1339 
SAMPLING_READ_SIZE
);

1340 
i
 +ğ
SAMPLING_INTERVAL
;

1341 
¡¬t
 +ğ
SAMPLING_INTERVAL
;

1342 
cu¼_§m¶e_pos
 +ğ
SAMPLING_READ_SIZE
;

1344 
	`kunm­_loÿl
(
š_d©a
);

1345 
	`put_·ge
(
·ge
);

1347 
šdex
++;

1350 
ws
->
§m¶e_size
 = 
cu¼_§m¶e_pos
;

1351 
	}
}

1368 
	$bŒfs_com´ess_heuri¡ic
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
)

1370 
li¡_h—d
 *
ws_li¡
 = 
	`g‘_wÜk¥aû
(0, 0);

1371 
heuri¡ic_ws
 *
ws
;

1372 
u32
 
i
;

1373 
u8
 
by‹
;

1374 
»t
 = 0;

1376 
ws
 = 
	`li¡_’Œy
(
ws_li¡
, 
heuri¡ic_ws
, 
li¡
);

1378 
	`heuri¡ic_cŞËù_§m¶e
(
šode
, 
¡¬t
, 
’d
, 
ws
);

1380 ià(
	`§m¶e_»³©ed_·‰”ns
(
ws
)) {

1381 
»t
 = 1;

1382 
out
;

1385 
	`mem£t
(
ws
->
buck‘
, 0, (*ws->buck‘)*
BUCKET_SIZE
);

1387 
i
 = 0; i < 
ws
->
§m¶e_size
; i++) {

1388 
by‹
 = 
ws
->
§m¶e
[
i
];

1389 
ws
->
buck‘
[
by‹
].
couÁ
++;

1392 
i
 = 
	`by‹_£t_size
(
ws
);

1393 ià(
i
 < 
BYTE_SET_THRESHOLD
) {

1394 
»t
 = 2;

1395 
out
;

1398 
i
 = 
	`by‹_cÜe_£t_size
(
ws
);

1399 ià(
i
 <ğ
BYTE_CORE_SET_LOW
) {

1400 
»t
 = 3;

1401 
out
;

1404 ià(
i
 >ğ
BYTE_CORE_SET_HIGH
) {

1405 
»t
 = 0;

1406 
out
;

1409 
i
 = 
	`shªnÚ_’Œİy
(
ws
);

1410 ià(
i
 <ğ
ENTROPY_LVL_ACEPTABLE
) {

1411 
»t
 = 4;

1412 
out
;

1430 ià(
i
 < 
ENTROPY_LVL_HIGH
) {

1431 
»t
 = 5;

1432 
out
;

1434 
»t
 = 0;

1435 
out
;

1438 
out
:

1439 
	`put_wÜk¥aû
(0, 
ws_li¡
);

1440  
»t
;

1441 
	}
}

1447 
	$bŒfs_com´ess_¡r2Ëv–
(
ty³
, cÚ¡ *
¡r
)

1449 
Ëv–
 = 0;

1450 
»t
;

1452 ià(!
ty³
)

1455 ià(
¡r
[0] == ':') {

1456 
»t
 = 
	`k¡¹oušt
(
¡r
 + 1, 10, &
Ëv–
);

1457 ià(
»t
)

1458 
Ëv–
 = 0;

1461 
Ëv–
 = 
	`bŒfs_com´ess_£t_Ëv–
(
ty³
,†evel);

1463  
Ëv–
;

1464 
	}
}

	@compression.h

6 #iâdeà
BTRFS_COMPRESSION_H


7 
	#BTRFS_COMPRESSION_H


	)

9 
	~<lšux/sizes.h
>

10 
	~"bio.h
"

12 
	gbŒfs_šode
;

13 
	gbŒfs_Üd”ed_ex‹Á
;

26 
	#BTRFS_MAX_COMPRESSED
 (
SZ_128K
)

	)

27 
	#BTRFS_MAX_COMPRESSED_PAGES
 (
BTRFS_MAX_COMPRESSED
 / 
PAGE_SIZE
)

	)

28 
¡©ic_as£¹
((
BTRFS_MAX_COMPRESSED
 % 
PAGE_SIZE
) == 0);

31 
	#BTRFS_MAX_UNCOMPRESSED
 (
SZ_128K
)

	)

33 
	#BTRFS_ZLIB_DEFAULT_LEVEL
 3

	)

35 
	scom´es£d_bio
 {

37 
	mÄ_·ges
;

40 
·ge
 **
	mcom´es£d_·ges
;

43 
u64
 
	m¡¬t
;

46 
	mËn
;

49 
	mcom´es£d_Ën
;

52 
u8
 
	mcom´ess_ty³
;

55 
boŞ
 
	mwr™eback
;

59 
bŒfs_bio
 *
	mÜig_bbio
;

60 
wÜk_¡ruù
 
	mwr™e_’d_wÜk
;

64 
bŒfs_bio
 
	mbbio
;

67 
šlše
 
	$bŒfs_com´ess_ty³
(
ty³_Ëv–
)

69  (
ty³_Ëv–
 & 0xF);

70 
	}
}

72 
šlše
 
	$bŒfs_com´ess_Ëv–
(
ty³_Ëv–
)

74  ((
ty³_Ëv–
 & 0xF0) >> 4);

75 
	}
}

77 
__š™
 
bŒfs_š™_com´ess
();

78 
__cŞd
 
bŒfs_ex™_com´ess
();

80 
bŒfs_com´ess_·ges
(
ty³_Ëv–
, 
add»ss_¥aû
 *
m­pšg
,

81 
u64
 
¡¬t
, 
·ge
 **
·ges
,

82 *
out_·ges
,

83 *
tÙ®_š
,

84 *
tÙ®_out
);

85 
bŒfs_decom´ess
(
ty³
, cÚ¡ 
u8
 *
d©a_š
, 
·ge
 *
de¡_·ge
,

86 
¡¬t_by‹
, 
size_t
 
¤ş’
, size_ˆ
de¡Ën
);

87 
bŒfs_decom´ess_buf2·ge
(cÚ¡ *
buf
, 
u32
 
buf_Ën
,

88 
com´es£d_bio
 *
cb
, 
u32
 
decom´es£d
);

90 
bŒfs_subm™_com´es£d_wr™e
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
,

91 
·ge
 **
com´es£d_·ges
,

92 
Ä_·ges
,

93 
blk_İf_t
 
wr™e_æags
,

94 
boŞ
 
wr™eback
);

95 
bŒfs_subm™_com´es£d_»ad
(
bŒfs_bio
 *
bbio
);

97 
bŒfs_com´ess_¡r2Ëv–
(
ty³
, cÚ¡ *
¡r
);

99 
	ebŒfs_com´essiÚ_ty³
 {

100 
	mBTRFS_COMPRESS_NONE
 = 0,

101 
	mBTRFS_COMPRESS_ZLIB
 = 1,

102 
	mBTRFS_COMPRESS_LZO
 = 2,

103 
	mBTRFS_COMPRESS_ZSTD
 = 3,

104 
	mBTRFS_NR_COMPRESS_TYPES
 = 4,

107 
	swÜk¥aû_mªag”
 {

108 
li¡_h—d
 
	midË_ws
;

109 
¥šlock_t
 
	mws_lock
;

111 
	mä“_ws
;

113 
©omic_t
 
	mtÙ®_ws
;

115 
wa™_queue_h—d_t
 
	mws_wa™
;

118 
li¡_h—d
 *
bŒfs_g‘_wÜk¥aû
(
ty³
, 
Ëv–
);

119 
bŒfs_put_wÜk¥aû
(
ty³
, 
li¡_h—d
 *
ws
);

121 
	sbŒfs_com´ess_İ
 {

122 
wÜk¥aû_mªag”
 *
	mwÜk¥aû_mªag”
;

124 
	mmax_Ëv–
;

125 
	mdeçuÉ_Ëv–
;

129 
	#BTRFS_NR_WORKSPACE_MANAGERS
 
BTRFS_NR_COMPRESS_TYPES


	)

131 cÚ¡ 
bŒfs_com´ess_İ
 
bŒfs_heuri¡ic_com´ess
;

132 cÚ¡ 
bŒfs_com´ess_İ
 
bŒfs_zlib_com´ess
;

133 cÚ¡ 
bŒfs_com´ess_İ
 
bŒfs_lzo_com´ess
;

134 cÚ¡ 
bŒfs_com´ess_İ
 
bŒfs_z¡d_com´ess
;

136 cÚ¡ * 
bŒfs_com´ess_ty³2¡r
(
bŒfs_com´essiÚ_ty³
 
ty³
);

137 
boŞ
 
bŒfs_com´ess_is_v®id_ty³
(cÚ¡ *
¡r
, 
size_t
 
Ën
);

139 
bŒfs_com´ess_heuri¡ic
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
);

141 
zlib_com´ess_·ges
(
li¡_h—d
 *
ws
, 
add»ss_¥aû
 *
m­pšg
,

142 
u64
 
¡¬t
, 
·ge
 **
·ges
, *
out_·ges
,

143 *
tÙ®_š
, *
tÙ®_out
);

144 
zlib_decom´ess_bio
(
li¡_h—d
 *
ws
, 
com´es£d_bio
 *
cb
);

145 
zlib_decom´ess
(
li¡_h—d
 *
ws
, cÚ¡ 
u8
 *
d©a_š
,

146 
·ge
 *
de¡_·ge
, 
¡¬t_by‹
, 
size_t
 
¤ş’
,

147 
size_t
 
de¡Ën
);

148 
li¡_h—d
 *
zlib_®loc_wÜk¥aû
(
Ëv–
);

149 
zlib_ä“_wÜk¥aû
(
li¡_h—d
 *
ws
);

150 
li¡_h—d
 *
zlib_g‘_wÜk¥aû
(
Ëv–
);

152 
lzo_com´ess_·ges
(
li¡_h—d
 *
ws
, 
add»ss_¥aû
 *
m­pšg
,

153 
u64
 
¡¬t
, 
·ge
 **
·ges
, *
out_·ges
,

154 *
tÙ®_š
, *
tÙ®_out
);

155 
lzo_decom´ess_bio
(
li¡_h—d
 *
ws
, 
com´es£d_bio
 *
cb
);

156 
lzo_decom´ess
(
li¡_h—d
 *
ws
, cÚ¡ 
u8
 *
d©a_š
,

157 
·ge
 *
de¡_·ge
, 
¡¬t_by‹
, 
size_t
 
¤ş’
,

158 
size_t
 
de¡Ën
);

159 
li¡_h—d
 *
lzo_®loc_wÜk¥aû
(
Ëv–
);

160 
lzo_ä“_wÜk¥aû
(
li¡_h—d
 *
ws
);

162 
z¡d_com´ess_·ges
(
li¡_h—d
 *
ws
, 
add»ss_¥aû
 *
m­pšg
,

163 
u64
 
¡¬t
, 
·ge
 **
·ges
, *
out_·ges
,

164 *
tÙ®_š
, *
tÙ®_out
);

165 
z¡d_decom´ess_bio
(
li¡_h—d
 *
ws
, 
com´es£d_bio
 *
cb
);

166 
z¡d_decom´ess
(
li¡_h—d
 *
ws
, cÚ¡ 
u8
 *
d©a_š
,

167 
·ge
 *
de¡_·ge
, 
¡¬t_by‹
, 
size_t
 
¤ş’
,

168 
size_t
 
de¡Ën
);

169 
z¡d_š™_wÜk¥aû_mªag”
();

170 
z¡d_ş—nup_wÜk¥aû_mªag”
();

171 
li¡_h—d
 *
z¡d_®loc_wÜk¥aû
(
Ëv–
);

172 
z¡d_ä“_wÜk¥aû
(
li¡_h—d
 *
ws
);

173 
li¡_h—d
 *
z¡d_g‘_wÜk¥aû
(
Ëv–
);

174 
z¡d_put_wÜk¥aû
(
li¡_h—d
 *
ws
);

	@ctree.c

6 
	~<lšux/sched.h
>

7 
	~<lšux/¦ab.h
>

8 
	~<lšux/rbŒ“.h
>

9 
	~<lšux/mm.h
>

10 
	~<lšux/”rÜ-šjeùiÚ.h
>

11 
	~"mes§ges.h
"

12 
	~"ù»e.h
"

13 
	~"disk-io.h
"

14 
	~"Œª§ùiÚ.h
"

15 
	~"´št-Œ“.h
"

16 
	~"lockšg.h
"

17 
	~"vŞumes.h
"

18 
	~"qgroup.h
"

19 
	~"Œ“-mod-log.h
"

20 
	~"Œ“-check”.h
"

21 
	~"fs.h
"

22 
	~"acûssÜs.h
"

23 
	~"ex‹Á-Œ“.h
"

24 
	~"»loÿtiÚ.h
"

25 
	~"fe-™em.h
"

27 
kmem_ÿche
 *
	gbŒfs_·th_ÿch•
;

29 
¥l™_node
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ


30 *
roÙ
, 
bŒfs_·th
 *
·th
, 
Ëv–
);

31 
¥l™_Ëaf
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

32 cÚ¡ 
bŒfs_key
 *
šs_key
, 
bŒfs_·th
 *
·th
,

33 
d©a_size
, 
ex‹nd
);

34 
push_node_Ëá
(
bŒfs_Œªs_hªdË
 *
Œªs
,

35 
ex‹Á_bufãr
 *
d¡
,

36 
ex‹Á_bufãr
 *
¤c
, 
em±y
);

37 
b®ªû_node_right
(
bŒfs_Œªs_hªdË
 *
Œªs
,

38 
ex‹Á_bufãr
 *
d¡_buf
,

39 
ex‹Á_bufãr
 *
¤c_buf
);

41 cÚ¡ 
	sbŒfs_csums
 {

42 
u16
 
	msize
;

43 cÚ¡ 
	mÇme
[10];

44 cÚ¡ 
	mdriv”
[12];

45 } 
	gbŒfs_csums
[] = {

46 [
BTRFS_CSUM_TYPE_CRC32
] = { .
size
 = 4, .
	gÇme
 = "crc32c" },

47 [
BTRFS_CSUM_TYPE_XXHASH
] = { .
size
 = 8, .
	gÇme
 = "xxhash64" },

48 [
BTRFS_CSUM_TYPE_SHA256
] = { .
size
 = 32, .
	gÇme
 = "sha256" },

49 [
BTRFS_CSUM_TYPE_BLAKE2
] = { .
size
 = 32, .
	gÇme
 = "blake2b",

50 .
	gdriv”
 = "blake2b-256" },

57 
	$Ëaf_d©a_’d
(cÚ¡ 
ex‹Á_bufãr
 *
Ëaf
)

59 
u32
 
Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

61 ià(
Ä
 == 0)

62  
	`BTRFS_LEAF_DATA_SIZE
(
Ëaf
->
fs_šfo
);

63  
	`bŒfs_™em_off£t
(
Ëaf
, 
Ä
 - 1);

64 
	}
}

79 
šlše
 
	$memmove_Ëaf_d©a
(cÚ¡ 
ex‹Á_bufãr
 *
Ëaf
,

80 
d¡_off£t
,

81 
¤c_off£t
,

82 
Ën
)

84 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
	`bŒfs_™em_Ä_off£t
Ö—f, 0è+ 
d¡_off£t
,

85 
	`bŒfs_™em_Ä_off£t
(
Ëaf
, 0è+ 
¤c_off£t
, 
Ën
);

86 
	}
}

102 
šlše
 
	$cİy_Ëaf_d©a
(cÚ¡ 
ex‹Á_bufãr
 *
d¡
,

103 cÚ¡ 
ex‹Á_bufãr
 *
¤c
,

104 
d¡_off£t
,

105 
¤c_off£t
, 
Ën
)

107 
	`cİy_ex‹Á_bufãr
(
d¡
, 
¤c
, 
	`bŒfs_™em_Ä_off£t
(d¡, 0è+ 
d¡_off£t
,

108 
	`bŒfs_™em_Ä_off£t
(
¤c
, 0è+ 
¤c_off£t
, 
Ën
);

109 
	}
}

122 
šlše
 
	$memmove_Ëaf_™ems
(cÚ¡ 
ex‹Á_bufãr
 *
Ëaf
,

123 
d¡_™em
, 
¤c_™em
, 
Ä_™ems
)

125 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
	`bŒfs_™em_Ä_off£t
Ö—f, 
d¡_™em
),

126 
	`bŒfs_™em_Ä_off£t
(
Ëaf
, 
¤c_™em
),

127 
Ä_™ems
 * (
bŒfs_™em
));

128 
	}
}

142 
šlše
 
	$cİy_Ëaf_™ems
(cÚ¡ 
ex‹Á_bufãr
 *
d¡
,

143 cÚ¡ 
ex‹Á_bufãr
 *
¤c
,

144 
d¡_™em
, 
¤c_™em
, 
Ä_™ems
)

146 
	`cİy_ex‹Á_bufãr
(
d¡
, 
¤c
, 
	`bŒfs_™em_Ä_off£t
(d¡, 
d¡_™em
),

147 
	`bŒfs_™em_Ä_off£t
(
¤c
, 
¤c_™em
),

148 
Ä_™ems
 * (
bŒfs_™em
));

149 
	}
}

152 
u16
 
	$bŒfs_csum_ty³_size
(
u16
 
ty³
)

154  
bŒfs_csums
[
ty³
].
size
;

155 
	}
}

157 
	$bŒfs_su³r_csum_size
(cÚ¡ 
bŒfs_su³r_block
 *
s
)

159 
u16
 
t
 = 
	`bŒfs_su³r_csum_ty³
(
s
);

163  
	`bŒfs_csum_ty³_size
(
t
);

164 
	}
}

166 cÚ¡ *
	$bŒfs_su³r_csum_Çme
(
u16
 
csum_ty³
)

169  
bŒfs_csums
[
csum_ty³
].
Çme
;

170 
	}
}

176 cÚ¡ *
	$bŒfs_su³r_csum_driv”
(
u16
 
csum_ty³
)

179  
bŒfs_csums
[
csum_ty³
].
driv”
[0] ?

180 
bŒfs_csums
[
csum_ty³
].
driv”
 :

181 
bŒfs_csums
[
csum_ty³
].
Çme
;

182 
	}
}

184 
size_t
 
__©Œibu‹_cÚ¡__
 
	$bŒfs_g‘_num_csums
()

186  
	`ARRAY_SIZE
(
bŒfs_csums
);

187 
	}
}

189 
bŒfs_·th
 *
	$bŒfs_®loc_·th
()

191 
	`might_¦“p
();

193  
	`kmem_ÿche_z®loc
(
bŒfs_·th_ÿch•
, 
GFP_NOFS
);

194 
	}
}

197 
	$bŒfs_ä“_·th
(
bŒfs_·th
 *
p
)

199 ià(!
p
)

201 
	`bŒfs_»Ëa£_·th
(
p
);

202 
	`kmem_ÿche_ä“
(
bŒfs_·th_ÿch•
, 
p
);

203 
	}
}

211 
nošlše
 
	$bŒfs_»Ëa£_·th
(
bŒfs_·th
 *
p
)

213 
i
;

215 
i
 = 0; i < 
BTRFS_MAX_LEVEL
; i++) {

216 
p
->
¦Ùs
[
i
] = 0;

217 ià(!
p
->
nodes
[
i
])

219 ià(
p
->
locks
[
i
]) {

220 
	`bŒfs_Œ“_uÆock_rw
(
p
->
nodes
[
i
],…->
locks
[i]);

221 
p
->
locks
[
i
] = 0;

223 
	`ä“_ex‹Á_bufãr
(
p
->
nodes
[
i
]);

224 
p
->
nodes
[
i
] = 
NULL
;

226 
	}
}

233 
boŞ
 
__cŞd
 
	$abÜt_should_´št_¡ack
(
”ºo
)

235 
”ºo
) {

236 -
EIO
:

237 -
EROFS
:

238 -
ENOMEM
:

239  
çl£
;

241  
Œue
;

242 
	}
}

254 
ex‹Á_bufãr
 *
	$bŒfs_roÙ_node
(
bŒfs_roÙ
 *
roÙ
)

256 
ex‹Á_bufãr
 *
eb
;

259 
	`rcu_»ad_lock
();

260 
eb
 = 
	`rcu_d”eã»nû
(
roÙ
->
node
);

268 ià(
	`©omic_šc_nÙ_z”o
(&
eb
->
»fs
)) {

269 
	`rcu_»ad_uÆock
();

272 
	`rcu_»ad_uÆock
();

273 
	`synchrÚize_rcu
();

275  
eb
;

276 
	}
}

283 
	$add_roÙ_to_dœty_li¡
(
bŒfs_roÙ
 *
roÙ
)

285 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

287 ià(
	`‹¡_b™
(
BTRFS_ROOT_DIRTY
, &
roÙ
->
¡©e
) ||

288 !
	`‹¡_b™
(
BTRFS_ROOT_TRACK_DIRTY
, &
roÙ
->
¡©e
))

291 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

292 ià(!
	`‹¡_ªd_£t_b™
(
BTRFS_ROOT_DIRTY
, &
roÙ
->
¡©e
)) {

294 ià(
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_EXTENT_TREE_OBJECTID
)

295 
	`li¡_move_
(&
roÙ
->
dœty_li¡
,

296 &
fs_šfo
->
dœty_cowÚly_roÙs
);

298 
	`li¡_move
(&
roÙ
->
dœty_li¡
,

299 &
fs_šfo
->
dœty_cowÚly_roÙs
);

301 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

302 
	}
}

309 
	$bŒfs_cİy_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

310 
bŒfs_roÙ
 *
roÙ
,

311 
ex‹Á_bufãr
 *
buf
,

312 
ex‹Á_bufãr
 **
cow_»t
, 
u64
 
Ãw_roÙ_objeùid
)

314 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

315 
ex‹Á_bufãr
 *
cow
;

316 
»t
 = 0;

317 
Ëv–
;

318 
bŒfs_disk_key
 
disk_key
;

320 
	`WARN_ON
(
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
) &&

321 
Œªs
->
Œªsid
 !ğ
fs_šfo
->
ruÂšg_Œª§ùiÚ
->transid);

322 
	`WARN_ON
(
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
) &&

323 
Œªs
->
Œªsid
 !ğ
roÙ
->
Ï¡_Œªs
);

325 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
buf
);

326 ià(
Ëv–
 == 0)

327 
	`bŒfs_™em_key
(
buf
, &
disk_key
, 0);

329 
	`bŒfs_node_key
(
buf
, &
disk_key
, 0);

331 
cow
 = 
	`bŒfs_®loc_Œ“_block
(
Œªs
, 
roÙ
, 0, 
Ãw_roÙ_objeùid
,

332 &
disk_key
, 
Ëv–
, 
buf
->
¡¬t
, 0,

333 
BTRFS_NESTING_NEW_ROOT
);

334 ià(
	`IS_ERR
(
cow
))

335  
	`PTR_ERR
(
cow
);

337 
	`cİy_ex‹Á_bufãr_fuÎ
(
cow
, 
buf
);

338 
	`bŒfs_£t_h—d”_by‹Ä
(
cow
, cow->
¡¬t
);

339 
	`bŒfs_£t_h—d”_g’”©iÚ
(
cow
, 
Œªs
->
Œªsid
);

340 
	`bŒfs_£t_h—d”_back»f_»v
(
cow
, 
BTRFS_MIXED_BACKREF_REV
);

341 
	`bŒfs_ş—r_h—d”_æag
(
cow
, 
BTRFS_HEADER_FLAG_WRITTEN
 |

342 
BTRFS_HEADER_FLAG_RELOC
);

343 ià(
Ãw_roÙ_objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
)

344 
	`bŒfs_£t_h—d”_æag
(
cow
, 
BTRFS_HEADER_FLAG_RELOC
);

346 
	`bŒfs_£t_h—d”_owÃr
(
cow
, 
Ãw_roÙ_objeùid
);

348 
	`wr™e_ex‹Á_bufãr_fsid
(
cow
, 
fs_šfo
->
fs_deviûs
->
m‘ad©a_uuid
);

350 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
buf
è> 
Œªs
->
Œªsid
);

351 ià(
Ãw_roÙ_objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
)

352 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
cow
, 1);

354 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
cow
, 0);

355 ià(
»t
) {

356 
	`bŒfs_Œ“_uÆock
(
cow
);

357 
	`ä“_ex‹Á_bufãr
(
cow
);

358 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

359  
»t
;

362 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
cow
);

363 *
cow_»t
 = 
cow
;

365 
	}
}

370 
	$bŒfs_block_ÿn_be_sh¬ed
(
bŒfs_Œªs_hªdË
 *
Œªs
,

371 
bŒfs_roÙ
 *
roÙ
,

372 
ex‹Á_bufãr
 *
buf
)

379 ià(
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
) &&

380 
buf
 !ğ
roÙ
->
node
 &&

381 (
	`bŒfs_h—d”_g’”©iÚ
(
buf
) <=

382 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
) ||

383 
	`bŒfs_h—d”_æag
(
buf
, 
BTRFS_HEADER_FLAG_RELOC
))) {

384 ià(
buf
 !ğ
roÙ
->
comm™_roÙ
)

392 ià(
	`bŒfs_h—d”_g’”©iÚ
(
buf
è=ğ
Œªs
->
Œªsid
)

397 
	}
}

399 
nošlše
 
	$upd©e_»f_fÜ_cow
(
bŒfs_Œªs_hªdË
 *
Œªs
,

400 
bŒfs_roÙ
 *
roÙ
,

401 
ex‹Á_bufãr
 *
buf
,

402 
ex‹Á_bufãr
 *
cow
,

403 *
Ï¡_»f
)

405 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

406 
u64
 
»fs
;

407 
u64
 
owÃr
;

408 
u64
 
æags
;

409 
u64
 
Ãw_æags
 = 0;

410 
»t
;

429 ià(
	`bŒfs_block_ÿn_be_sh¬ed
(
Œªs
, 
roÙ
, 
buf
)) {

430 
»t
 = 
	`bŒfs_lookup_ex‹Á_šfo
(
Œªs
, 
fs_šfo
, 
buf
->
¡¬t
,

431 
	`bŒfs_h—d”_Ëv–
(
buf
), 1,

432 &
»fs
, &
æags
);

433 ià(
»t
)

434  
»t
;

435 ià(
	`uÆik–y
(
»fs
 == 0)) {

436 
	`bŒfs_ü™
(
fs_šfo
,

438 
buf
->
¡¬t
, 
	`bŒfs_h—d”_Ëv–
(buf),

439 
	`bŒfs_roÙ_id
(
roÙ
));

440 
»t
 = -
EUCLEAN
;

441 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

442  
»t
;

445 
»fs
 = 1;

446 ià(
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
 ||

447 
	`bŒfs_h—d”_back»f_»v
(
buf
è< 
BTRFS_MIXED_BACKREF_REV
)

448 
æags
 = 
BTRFS_BLOCK_FLAG_FULL_BACKREF
;

450 
æags
 = 0;

453 
owÃr
 = 
	`bŒfs_h—d”_owÃr
(
buf
);

454 
	`BUG_ON
(
owÃr
 =ğ
BTRFS_TREE_RELOC_OBJECTID
 &&

455 !(
æags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
));

457 ià(
»fs
 > 1) {

458 ià((
owÃr
 =ğ
roÙ
->
roÙ_key
.
objeùid
 ||

459 
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
) &&

460 !(
æags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
)) {

461 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
buf
, 1);

462 ià(
»t
)

463  
»t
;

465 ià(
roÙ
->
roÙ_key
.
objeùid
 ==

466 
BTRFS_TREE_RELOC_OBJECTID
) {

467 
»t
 = 
	`bŒfs_dec_»f
(
Œªs
, 
roÙ
, 
buf
, 0);

468 ià(
»t
)

469  
»t
;

470 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
cow
, 1);

471 ià(
»t
)

472  
»t
;

474 
Ãw_æags
 |ğ
BTRFS_BLOCK_FLAG_FULL_BACKREF
;

477 ià(
roÙ
->
roÙ_key
.
objeùid
 ==

478 
BTRFS_TREE_RELOC_OBJECTID
)

479 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
cow
, 1);

481 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
cow
, 0);

482 ià(
»t
)

483  
»t
;

485 ià(
Ãw_æags
 != 0) {

486 
»t
 = 
	`bŒfs_£t_disk_ex‹Á_æags
(
Œªs
, 
buf
, 
Ãw_æags
);

487 ià(
»t
)

488  
»t
;

491 ià(
æags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
) {

492 ià(
roÙ
->
roÙ_key
.
objeùid
 ==

493 
BTRFS_TREE_RELOC_OBJECTID
)

494 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
cow
, 1);

496 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
cow
, 0);

497 ià(
»t
)

498  
»t
;

499 
»t
 = 
	`bŒfs_dec_»f
(
Œªs
, 
roÙ
, 
buf
, 1);

500 ià(
»t
)

501  
»t
;

503 
	`bŒfs_ş—r_bufãr_dœty
(
Œªs
, 
buf
);

504 *
Ï¡_»f
 = 1;

507 
	}
}

521 
nošlše
 
	$__bŒfs_cow_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

522 
bŒfs_roÙ
 *
roÙ
,

523 
ex‹Á_bufãr
 *
buf
,

524 
ex‹Á_bufãr
 *
·»Á
, 
·»Á_¦Ù
,

525 
ex‹Á_bufãr
 **
cow_»t
,

526 
u64
 
£¬ch_¡¬t
, u64 
em±y_size
,

527 
bŒfs_lock_Ã¡šg
 
Ã¡
)

529 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

530 
bŒfs_disk_key
 
disk_key
;

531 
ex‹Á_bufãr
 *
cow
;

532 
Ëv–
, 
»t
;

533 
Ï¡_»f
 = 0;

534 
uÆock_Üig
 = 0;

535 
u64
 
·»Á_¡¬t
 = 0;

537 ià(*
cow_»t
 =ğ
buf
)

538 
uÆock_Üig
 = 1;

540 
	`bŒfs_as£¹_Œ“_wr™e_locked
(
buf
);

542 
	`WARN_ON
(
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
) &&

543 
Œªs
->
Œªsid
 !ğ
fs_šfo
->
ruÂšg_Œª§ùiÚ
->transid);

544 
	`WARN_ON
(
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
) &&

545 
Œªs
->
Œªsid
 !ğ
roÙ
->
Ï¡_Œªs
);

547 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
buf
);

549 ià(
Ëv–
 == 0)

550 
	`bŒfs_™em_key
(
buf
, &
disk_key
, 0);

552 
	`bŒfs_node_key
(
buf
, &
disk_key
, 0);

554 ià((
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
è&& 
·»Á
)

555 
·»Á_¡¬t
 = 
·»Á
->
¡¬t
;

557 
cow
 = 
	`bŒfs_®loc_Œ“_block
(
Œªs
, 
roÙ
, 
·»Á_¡¬t
,

558 
roÙ
->
roÙ_key
.
objeùid
, &
disk_key
, 
Ëv–
,

559 
£¬ch_¡¬t
, 
em±y_size
, 
Ã¡
);

560 ià(
	`IS_ERR
(
cow
))

561  
	`PTR_ERR
(
cow
);

565 
	`cİy_ex‹Á_bufãr_fuÎ
(
cow
, 
buf
);

566 
	`bŒfs_£t_h—d”_by‹Ä
(
cow
, cow->
¡¬t
);

567 
	`bŒfs_£t_h—d”_g’”©iÚ
(
cow
, 
Œªs
->
Œªsid
);

568 
	`bŒfs_£t_h—d”_back»f_»v
(
cow
, 
BTRFS_MIXED_BACKREF_REV
);

569 
	`bŒfs_ş—r_h—d”_æag
(
cow
, 
BTRFS_HEADER_FLAG_WRITTEN
 |

570 
BTRFS_HEADER_FLAG_RELOC
);

571 ià(
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
)

572 
	`bŒfs_£t_h—d”_æag
(
cow
, 
BTRFS_HEADER_FLAG_RELOC
);

574 
	`bŒfs_£t_h—d”_owÃr
(
cow
, 
roÙ
->
roÙ_key
.
objeùid
);

576 
	`wr™e_ex‹Á_bufãr_fsid
(
cow
, 
fs_šfo
->
fs_deviûs
->
m‘ad©a_uuid
);

578 
»t
 = 
	`upd©e_»f_fÜ_cow
(
Œªs
, 
roÙ
, 
buf
, 
cow
, &
Ï¡_»f
);

579 ià(
»t
) {

580 
	`bŒfs_Œ“_uÆock
(
cow
);

581 
	`ä“_ex‹Á_bufãr
(
cow
);

582 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

583  
»t
;

586 ià(
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
)) {

587 
»t
 = 
	`bŒfs_»loc_cow_block
(
Œªs
, 
roÙ
, 
buf
, 
cow
);

588 ià(
»t
) {

589 
	`bŒfs_Œ“_uÆock
(
cow
);

590 
	`ä“_ex‹Á_bufãr
(
cow
);

591 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

592  
»t
;

596 ià(
buf
 =ğ
roÙ
->
node
) {

597 
	`WARN_ON
(
·»Á
 &&…¬’ˆ!ğ
buf
);

598 ià(
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
 ||

599 
	`bŒfs_h—d”_back»f_»v
(
buf
è< 
BTRFS_MIXED_BACKREF_REV
)

600 
·»Á_¡¬t
 = 
buf
->
¡¬t
;

602 
»t
 = 
	`bŒfs_Œ“_mod_log_š£¹_roÙ
(
roÙ
->
node
, 
cow
, 
Œue
);

603 ià(
»t
 < 0) {

604 
	`bŒfs_Œ“_uÆock
(
cow
);

605 
	`ä“_ex‹Á_bufãr
(
cow
);

606 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

607  
»t
;

609 
	`©omic_šc
(&
cow
->
»fs
);

610 
	`rcu_assign_poš‹r
(
roÙ
->
node
, 
cow
);

612 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
	`bŒfs_roÙ_id
(
roÙ
), 
buf
,

613 
·»Á_¡¬t
, 
Ï¡_»f
);

614 
	`ä“_ex‹Á_bufãr
(
buf
);

615 
	`add_roÙ_to_dœty_li¡
(
roÙ
);

617 
	`WARN_ON
(
Œªs
->
Œªsid
 !ğ
	`bŒfs_h—d”_g’”©iÚ
(
·»Á
));

618 
»t
 = 
	`bŒfs_Œ“_mod_log_š£¹_key
(
·»Á
, 
·»Á_¦Ù
,

619 
BTRFS_MOD_LOG_KEY_REPLACE
);

620 ià(
»t
) {

621 
	`bŒfs_Œ“_uÆock
(
cow
);

622 
	`ä“_ex‹Á_bufãr
(
cow
);

623 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

624  
»t
;

626 
	`bŒfs_£t_node_block±r
(
·»Á
, 
·»Á_¦Ù
,

627 
cow
->
¡¬t
);

628 
	`bŒfs_£t_node_±r_g’”©iÚ
(
·»Á
, 
·»Á_¦Ù
,

629 
Œªs
->
Œªsid
);

630 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·»Á
);

631 ià(
Ï¡_»f
) {

632 
»t
 = 
	`bŒfs_Œ“_mod_log_ä“_eb
(
buf
);

633 ià(
»t
) {

634 
	`bŒfs_Œ“_uÆock
(
cow
);

635 
	`ä“_ex‹Á_bufãr
(
cow
);

636 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

637  
»t
;

640 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
	`bŒfs_roÙ_id
(
roÙ
), 
buf
,

641 
·»Á_¡¬t
, 
Ï¡_»f
);

643 ià(
uÆock_Üig
)

644 
	`bŒfs_Œ“_uÆock
(
buf
);

645 
	`ä“_ex‹Á_bufãr_¡®e
(
buf
);

646 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
cow
);

647 *
cow_»t
 = 
cow
;

649 
	}
}

651 
šlše
 
	$should_cow_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

652 
bŒfs_roÙ
 *
roÙ
,

653 
ex‹Á_bufãr
 *
buf
)

655 ià(
	`bŒfs_is_‹¡šg
(
roÙ
->
fs_šfo
))

659 
	`smp_mb__befÜe_©omic
();

672 ià(
	`bŒfs_h—d”_g’”©iÚ
(
buf
è=ğ
Œªs
->
Œªsid
 &&

673 !
	`bŒfs_h—d”_æag
(
buf
, 
BTRFS_HEADER_FLAG_WRITTEN
) &&

674 !(
roÙ
->
roÙ_key
.
objeùid
 !ğ
BTRFS_TREE_RELOC_OBJECTID
 &&

675 
	`bŒfs_h—d”_æag
(
buf
, 
BTRFS_HEADER_FLAG_RELOC
)) &&

676 !
	`‹¡_b™
(
BTRFS_ROOT_FORCE_COW
, &
roÙ
->
¡©e
))

679 
	}
}

686 
nošlše
 
	$bŒfs_cow_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

687 
bŒfs_roÙ
 *
roÙ
, 
ex‹Á_bufãr
 *
buf
,

688 
ex‹Á_bufãr
 *
·»Á
, 
·»Á_¦Ù
,

689 
ex‹Á_bufãr
 **
cow_»t
,

690 
bŒfs_lock_Ã¡šg
 
Ã¡
)

692 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

693 
u64
 
£¬ch_¡¬t
;

694 
»t
;

696 ià(
	`uÆik–y
(
	`‹¡_b™
(
BTRFS_ROOT_DELETING
, &
roÙ
->
¡©e
))) {

697 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, -
EUCLEAN
);

698 
	`bŒfs_ü™
(
fs_šfo
,

700 
buf
->
¡¬t
, 
	`bŒfs_roÙ_id
(
roÙ
));

701  -
EUCLEAN
;

710 ià(
	`uÆik–y
(
Œªs
->
Œª§ùiÚ
 !ğ
fs_šfo
->
ruÂšg_Œª§ùiÚ
 ||

711 
Œªs
->
Œªsid
 !ğ
fs_šfo
->
g’”©iÚ
)) {

712 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, -
EUCLEAN
);

713 
	`bŒfs_ü™
(
fs_šfo
,

715 
buf
->
¡¬t
, 
	`bŒfs_roÙ_id
(
roÙ
), 
Œªs
->
Œªsid
,

716 
fs_šfo
->
ruÂšg_Œª§ùiÚ
->
Œªsid
,

717 
fs_šfo
->
g’”©iÚ
);

718  -
EUCLEAN
;

721 ià(!
	`should_cow_block
(
Œªs
, 
roÙ
, 
buf
)) {

722 *
cow_»t
 = 
buf
;

726 
£¬ch_¡¬t
 = 
buf
->
¡¬t
 & ~((
u64
)
SZ_1G
 - 1);

734 
	`bŒfs_qgroup_Œaû_subŒ“_aá”_cow
(
Œªs
, 
roÙ
, 
buf
);

735 
»t
 = 
	`__bŒfs_cow_block
(
Œªs
, 
roÙ
, 
buf
, 
·»Á
,

736 
·»Á_¦Ù
, 
cow_»t
, 
£¬ch_¡¬t
, 0, 
Ã¡
);

738 
	`Œaû_bŒfs_cow_block
(
roÙ
, 
buf
, *
cow_»t
);

740  
»t
;

741 
	}
}

742 
ALLOW_ERROR_INJECTION
(
bŒfs_cow_block
, 
ERRNO
);

748 
	$şo£_blocks
(
u64
 
blockÄ
, u64 
Ùh”
, 
u32
 
blocksize
)

750 ià(
blockÄ
 < 
Ùh”
 && oth” - (blockÄ + 
blocksize
) < 32768)

752 ià(
blockÄ
 > 
Ùh”
 && blockÄ - (Ùh” + 
blocksize
) < 32768)

755 
	}
}

757 #ifdeà
__LITTLE_ENDIAN


763 
	$comp_keys
(cÚ¡ 
bŒfs_disk_key
 *
disk_key
,

764 cÚ¡ 
bŒfs_key
 *
k2
)

766 cÚ¡ 
bŒfs_key
 *
k1
 = (cÚ¡ bŒfs_key *)
disk_key
;

768  
	`bŒfs_comp_ıu_keys
(
k1
, 
k2
);

769 
	}
}

776 
	$comp_keys
(cÚ¡ 
bŒfs_disk_key
 *
disk
,

777 cÚ¡ 
bŒfs_key
 *
k2
)

779 
bŒfs_key
 
k1
;

781 
	`bŒfs_disk_key_to_ıu
(&
k1
, 
disk
);

783  
	`bŒfs_comp_ıu_keys
(&
k1
, 
k2
);

784 
	}
}

790 
__pu»
 
	$bŒfs_comp_ıu_keys
(cÚ¡ 
bŒfs_key
 *
k1
, cÚ¡ bŒfs_key *
k2
)

792 ià(
k1
->
objeùid
 > 
k2
->objectid)

794 ià(
k1
->
objeùid
 < 
k2
->objectid)

796 ià(
k1
->
ty³
 > 
k2
->type)

798 ià(
k1
->
ty³
 < 
k2
->type)

800 ià(
k1
->
off£t
 > 
k2
->offset)

802 ià(
k1
->
off£t
 < 
k2
->offset)

805 
	}
}

812 
	$bŒfs_»®loc_node
(
bŒfs_Œªs_hªdË
 *
Œªs
,

813 
bŒfs_roÙ
 *
roÙ
, 
ex‹Á_bufãr
 *
·»Á
,

814 
¡¬t_¦Ù
, 
u64
 *
Ï¡_»t
,

815 
bŒfs_key
 *
´og»ss
)

817 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

818 
ex‹Á_bufãr
 *
cur
;

819 
u64
 
blockÄ
;

820 
u64
 
£¬ch_¡¬t
 = *
Ï¡_»t
;

821 
u64
 
Ï¡_block
 = 0;

822 
u64
 
Ùh”
;

823 
u32
 
·»Á_Ä™ems
;

824 
’d_¦Ù
;

825 
i
;

826 
”r
 = 0;

827 
u32
 
blocksize
;

828 
´og»ss_·s£d
 = 0;

829 
bŒfs_disk_key
 
disk_key
;

837 ià(
	`uÆik–y
(
Œªs
->
Œª§ùiÚ
 !ğ
fs_šfo
->
ruÂšg_Œª§ùiÚ
 ||

838 
Œªs
->
Œªsid
 !ğ
fs_šfo
->
g’”©iÚ
)) {

839 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, -
EUCLEAN
);

840 
	`bŒfs_ü™
(
fs_šfo
,

842 
·»Á
->
¡¬t
, 
	`bŒfs_roÙ_id
(
roÙ
), 
Œªs
->
Œªsid
,

843 
fs_šfo
->
ruÂšg_Œª§ùiÚ
->
Œªsid
,

844 
fs_šfo
->
g’”©iÚ
);

845  -
EUCLEAN
;

848 
·»Á_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·»Á
);

849 
blocksize
 = 
fs_šfo
->
nodesize
;

850 
’d_¦Ù
 = 
·»Á_Ä™ems
 - 1;

852 ià(
·»Á_Ä™ems
 <= 1)

855 
i
 = 
¡¬t_¦Ù
; i <ğ
’d_¦Ù
; i++) {

856 
şo£
 = 1;

858 
	`bŒfs_node_key
(
·»Á
, &
disk_key
, 
i
);

859 ià(!
´og»ss_·s£d
 && 
	`comp_keys
(&
disk_key
, 
´og»ss
) < 0)

862 
´og»ss_·s£d
 = 1;

863 
blockÄ
 = 
	`bŒfs_node_block±r
(
·»Á
, 
i
);

864 ià(
Ï¡_block
 == 0)

865 
Ï¡_block
 = 
blockÄ
;

867 ià(
i
 > 0) {

868 
Ùh”
 = 
	`bŒfs_node_block±r
(
·»Á
, 
i
 - 1);

869 
şo£
 = 
	`şo£_blocks
(
blockÄ
, 
Ùh”
, 
blocksize
);

871 ià(!
şo£
 && 
i
 < 
’d_¦Ù
) {

872 
Ùh”
 = 
	`bŒfs_node_block±r
(
·»Á
, 
i
 + 1);

873 
şo£
 = 
	`şo£_blocks
(
blockÄ
, 
Ùh”
, 
blocksize
);

875 ià(
şo£
) {

876 
Ï¡_block
 = 
blockÄ
;

880 
cur
 = 
	`bŒfs_»ad_node_¦Ù
(
·»Á
, 
i
);

881 ià(
	`IS_ERR
(
cur
))

882  
	`PTR_ERR
(
cur
);

883 ià(
£¬ch_¡¬t
 == 0)

884 
£¬ch_¡¬t
 = 
Ï¡_block
;

886 
	`bŒfs_Œ“_lock
(
cur
);

887 
”r
 = 
	`__bŒfs_cow_block
(
Œªs
, 
roÙ
, 
cur
, 
·»Á
, 
i
,

888 &
cur
, 
£¬ch_¡¬t
,

889 
	`mš
(16 * 
blocksize
,

890 (
’d_¦Ù
 - 
i
è* 
blocksize
),

891 
BTRFS_NESTING_COW
);

892 ià(
”r
) {

893 
	`bŒfs_Œ“_uÆock
(
cur
);

894 
	`ä“_ex‹Á_bufãr
(
cur
);

897 
£¬ch_¡¬t
 = 
cur
->
¡¬t
;

898 
Ï¡_block
 = 
cur
->
¡¬t
;

899 *
Ï¡_»t
 = 
£¬ch_¡¬t
;

900 
	`bŒfs_Œ“_uÆock
(
cur
);

901 
	`ä“_ex‹Á_bufãr
(
cur
);

903  
”r
;

904 
	}
}

920 
	$bŒfs_bš_£¬ch
(
ex‹Á_bufãr
 *
eb
, 
fœ¡_¦Ù
,

921 cÚ¡ 
bŒfs_key
 *
key
, *
¦Ù
)

923 
p
;

924 
™em_size
;

929 
u32
 
low
 = 
fœ¡_¦Ù
;

930 
u32
 
high
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

931 
»t
;

932 cÚ¡ 
key_size
 = (
bŒfs_disk_key
);

934 ià(
	`uÆik–y
(
low
 > 
high
)) {

935 
	`bŒfs_”r
(
eb
->
fs_šfo
,

937 
__func__
, 
low
, 
high
, 
eb
->
¡¬t
,

938 
	`bŒfs_h—d”_owÃr
(
eb
), 
	`bŒfs_h—d”_Ëv–
(eb));

939  -
EINVAL
;

942 ià(
	`bŒfs_h—d”_Ëv–
(
eb
) == 0) {

943 
p
 = 
	`off£tof
(
bŒfs_Ëaf
, 
™ems
);

944 
™em_size
 = (
bŒfs_™em
);

946 
p
 = 
	`off£tof
(
bŒfs_node
, 
±rs
);

947 
™em_size
 = (
bŒfs_key_±r
);

950 
low
 < 
high
) {

951 
o
;

952 
off£t
;

953 
bŒfs_disk_key
 *
tmp
;

954 
bŒfs_disk_key
 
uÇligÃd
;

955 
mid
;

957 
mid
 = (
low
 + 
high
) / 2;

958 
off£t
 = 
p
 + 
mid
 * 
™em_size
;

959 
o
 = 
	`off£t_š_·ge
(
off£t
);

961 ià(
o
 + 
key_size
 <ğ
PAGE_SIZE
) {

962 cÚ¡ 
idx
 = 
	`g‘_eb_·ge_šdex
(
off£t
);

963 *
kaddr
 = 
	`·ge_add»ss
(
eb
->
·ges
[
idx
]);

965 
o
 = 
	`g‘_eb_off£t_š_·ge
(
eb
, 
off£t
);

966 
tmp
 = (
bŒfs_disk_key
 *)(
kaddr
 + 
o
);

968 
	`»ad_ex‹Á_bufãr
(
eb
, &
uÇligÃd
, 
off£t
, 
key_size
);

969 
tmp
 = &
uÇligÃd
;

972 
»t
 = 
	`comp_keys
(
tmp
, 
key
);

974 ià(
»t
 < 0)

975 
low
 = 
mid
 + 1;

976 ià(
»t
 > 0)

977 
high
 = 
mid
;

979 *
¦Ù
 = 
mid
;

983 *
¦Ù
 = 
low
;

985 
	}
}

987 
	$roÙ_add_u£d
(
bŒfs_roÙ
 *
roÙ
, 
u32
 
size
)

989 
	`¥š_lock
(&
roÙ
->
accouÁšg_lock
);

990 
	`bŒfs_£t_roÙ_u£d
(&
roÙ
->
roÙ_™em
,

991 
	`bŒfs_roÙ_u£d
(&
roÙ
->
roÙ_™em
è+ 
size
);

992 
	`¥š_uÆock
(&
roÙ
->
accouÁšg_lock
);

993 
	}
}

995 
	$roÙ_sub_u£d
(
bŒfs_roÙ
 *
roÙ
, 
u32
 
size
)

997 
	`¥š_lock
(&
roÙ
->
accouÁšg_lock
);

998 
	`bŒfs_£t_roÙ_u£d
(&
roÙ
->
roÙ_™em
,

999 
	`bŒfs_roÙ_u£d
(&
roÙ
->
roÙ_™em
è- 
size
);

1000 
	`¥š_uÆock
(&
roÙ
->
accouÁšg_lock
);

1001 
	}
}

1006 
ex‹Á_bufãr
 *
	$bŒfs_»ad_node_¦Ù
(
ex‹Á_bufãr
 *
·»Á
,

1007 
¦Ù
)

1009 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
·»Á
);

1010 
bŒfs_Œ“_·»Á_check
 
check
 = { 0 };

1011 
ex‹Á_bufãr
 *
eb
;

1013 ià(
¦Ù
 < 0 || slÙ >ğ
	`bŒfs_h—d”_Ä™ems
(
·»Á
))

1014  
	`ERR_PTR
(-
ENOENT
);

1016 
	`ASSERT
(
Ëv–
);

1018 
check
.
Ëv–
 =†evel - 1;

1019 
check
.
Œªsid
 = 
	`bŒfs_node_±r_g’”©iÚ
(
·»Á
, 
¦Ù
);

1020 
check
.
owÃr_roÙ
 = 
	`bŒfs_h—d”_owÃr
(
·»Á
);

1021 
check
.
has_fœ¡_key
 = 
Œue
;

1022 
	`bŒfs_node_key_to_ıu
(
·»Á
, &
check
.
fœ¡_key
, 
¦Ù
);

1024 
eb
 = 
	`»ad_Œ“_block
(
·»Á
->
fs_šfo
, 
	`bŒfs_node_block±r
Õ¬’t, 
¦Ù
),

1025 &
check
);

1026 ià(
	`IS_ERR
(
eb
))

1027  
eb
;

1028 ià(!
	`ex‹Á_bufãr_u±od©e
(
eb
)) {

1029 
	`ä“_ex‹Á_bufãr
(
eb
);

1030  
	`ERR_PTR
(-
EIO
);

1033  
eb
;

1034 
	}
}

1041 
nošlše
 
	$b®ªû_Ëv–
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1042 
bŒfs_roÙ
 *
roÙ
,

1043 
bŒfs_·th
 *
·th
, 
Ëv–
)

1045 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1046 
ex‹Á_bufãr
 *
right
 = 
NULL
;

1047 
ex‹Á_bufãr
 *
mid
;

1048 
ex‹Á_bufãr
 *
Ëá
 = 
NULL
;

1049 
ex‹Á_bufãr
 *
·»Á
 = 
NULL
;

1050 
»t
 = 0;

1051 
w»t
;

1052 
p¦Ù
;

1053 
Üig_¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
];

1054 
u64
 
Üig_±r
;

1056 
	`ASSERT
(
Ëv–
 > 0);

1058 
mid
 = 
·th
->
nodes
[
Ëv–
];

1060 
	`WARN_ON
(
·th
->
locks
[
Ëv–
] !ğ
BTRFS_WRITE_LOCK
);

1061 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
mid
è!ğ
Œªs
->
Œªsid
);

1063 
Üig_±r
 = 
	`bŒfs_node_block±r
(
mid
, 
Üig_¦Ù
);

1065 ià(
Ëv–
 < 
BTRFS_MAX_LEVEL
 - 1) {

1066 
·»Á
 = 
·th
->
nodes
[
Ëv–
 + 1];

1067 
p¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
 + 1];

1074 ià(!
·»Á
) {

1075 
ex‹Á_bufãr
 *
chd
;

1077 ià(
	`bŒfs_h—d”_Ä™ems
(
mid
) != 1)

1081 
chd
 = 
	`bŒfs_»ad_node_¦Ù
(
mid
, 0);

1082 ià(
	`IS_ERR
(
chd
)) {

1083 
»t
 = 
	`PTR_ERR
(
chd
);

1084 
out
;

1087 
	`bŒfs_Œ“_lock
(
chd
);

1088 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
chd
, 
mid
, 0, &child,

1089 
BTRFS_NESTING_COW
);

1090 ià(
»t
) {

1091 
	`bŒfs_Œ“_uÆock
(
chd
);

1092 
	`ä“_ex‹Á_bufãr
(
chd
);

1093 
out
;

1096 
»t
 = 
	`bŒfs_Œ“_mod_log_š£¹_roÙ
(
roÙ
->
node
, 
chd
, 
Œue
);

1097 ià(
»t
 < 0) {

1098 
	`bŒfs_Œ“_uÆock
(
chd
);

1099 
	`ä“_ex‹Á_bufãr
(
chd
);

1100 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1101 
out
;

1103 
	`rcu_assign_poš‹r
(
roÙ
->
node
, 
chd
);

1105 
	`add_roÙ_to_dœty_li¡
(
roÙ
);

1106 
	`bŒfs_Œ“_uÆock
(
chd
);

1108 
·th
->
locks
[
Ëv–
] = 0;

1109 
·th
->
nodes
[
Ëv–
] = 
NULL
;

1110 
	`bŒfs_ş—r_bufãr_dœty
(
Œªs
, 
mid
);

1111 
	`bŒfs_Œ“_uÆock
(
mid
);

1113 
	`ä“_ex‹Á_bufãr
(
mid
);

1115 
	`roÙ_sub_u£d
(
roÙ
, 
mid
->
Ën
);

1116 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
	`bŒfs_roÙ_id
(
roÙ
), 
mid
, 0, 1);

1118 
	`ä“_ex‹Á_bufãr_¡®e
(
mid
);

1121 ià(
	`bŒfs_h—d”_Ä™ems
(
mid
) >

1122 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
) / 4)

1125 ià(
p¦Ù
) {

1126 
Ëá
 = 
	`bŒfs_»ad_node_¦Ù
(
·»Á
, 
p¦Ù
 - 1);

1127 ià(
	`IS_ERR
(
Ëá
)) {

1128 
»t
 = 
	`PTR_ERR
(
Ëá
);

1129 
Ëá
 = 
NULL
;

1130 
out
;

1133 
	`__bŒfs_Œ“_lock
(
Ëá
, 
BTRFS_NESTING_LEFT
);

1134 
w»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
Ëá
,

1135 
·»Á
, 
p¦Ù
 - 1, &
Ëá
,

1136 
BTRFS_NESTING_LEFT_COW
);

1137 ià(
w»t
) {

1138 
»t
 = 
w»t
;

1139 
out
;

1143 ià(
p¦Ù
 + 1 < 
	`bŒfs_h—d”_Ä™ems
(
·»Á
)) {

1144 
right
 = 
	`bŒfs_»ad_node_¦Ù
(
·»Á
, 
p¦Ù
 + 1);

1145 ià(
	`IS_ERR
(
right
)) {

1146 
»t
 = 
	`PTR_ERR
(
right
);

1147 
right
 = 
NULL
;

1148 
out
;

1151 
	`__bŒfs_Œ“_lock
(
right
, 
BTRFS_NESTING_RIGHT
);

1152 
w»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
right
,

1153 
·»Á
, 
p¦Ù
 + 1, &
right
,

1154 
BTRFS_NESTING_RIGHT_COW
);

1155 ià(
w»t
) {

1156 
»t
 = 
w»t
;

1157 
out
;

1162 ià(
Ëá
) {

1163 
Üig_¦Ù
 +ğ
	`bŒfs_h—d”_Ä™ems
(
Ëá
);

1164 
w»t
 = 
	`push_node_Ëá
(
Œªs
, 
Ëá
, 
mid
, 1);

1165 ià(
w»t
 < 0)

1166 
»t
 = 
w»t
;

1172 ià(
right
) {

1173 
w»t
 = 
	`push_node_Ëá
(
Œªs
, 
mid
, 
right
, 1);

1174 ià(
w»t
 < 0 && w»ˆ!ğ-
ENOSPC
)

1175 
»t
 = 
w»t
;

1176 ià(
	`bŒfs_h—d”_Ä™ems
(
right
) == 0) {

1177 
	`bŒfs_ş—r_bufãr_dœty
(
Œªs
, 
right
);

1178 
	`bŒfs_Œ“_uÆock
(
right
);

1179 
»t
 = 
	`bŒfs_d–_±r
(
Œªs
, 
roÙ
, 
·th
, 
Ëv–
 + 1, 
p¦Ù
 + 1);

1180 ià(
»t
 < 0) {

1181 
	`ä“_ex‹Á_bufãr_¡®e
(
right
);

1182 
right
 = 
NULL
;

1183 
out
;

1185 
	`roÙ_sub_u£d
(
roÙ
, 
right
->
Ën
);

1186 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
	`bŒfs_roÙ_id
(
roÙ
), 
right
,

1188 
	`ä“_ex‹Á_bufãr_¡®e
(
right
);

1189 
right
 = 
NULL
;

1191 
bŒfs_disk_key
 
right_key
;

1192 
	`bŒfs_node_key
(
right
, &
right_key
, 0);

1193 
»t
 = 
	`bŒfs_Œ“_mod_log_š£¹_key
(
·»Á
, 
p¦Ù
 + 1,

1194 
BTRFS_MOD_LOG_KEY_REPLACE
);

1195 ià(
»t
 < 0) {

1196 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1197 
out
;

1199 
	`bŒfs_£t_node_key
(
·»Á
, &
right_key
, 
p¦Ù
 + 1);

1200 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·»Á
);

1203 ià(
	`bŒfs_h—d”_Ä™ems
(
mid
) == 1) {

1213 ià(
	`uÆik–y
(!
Ëá
)) {

1214 
	`bŒfs_ü™
(
fs_šfo
,

1216 
·»Á
->
¡¬t
, 
	`bŒfs_h—d”_Ëv–
(parent),

1217 
mid
->
¡¬t
, 
	`bŒfs_roÙ_id
(
roÙ
));

1218 
»t
 = -
EUCLEAN
;

1219 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1220 
out
;

1222 
w»t
 = 
	`b®ªû_node_right
(
Œªs
, 
mid
, 
Ëá
);

1223 ià(
w»t
 < 0) {

1224 
»t
 = 
w»t
;

1225 
out
;

1227 ià(
w»t
 == 1) {

1228 
w»t
 = 
	`push_node_Ëá
(
Œªs
, 
Ëá
, 
mid
, 1);

1229 ià(
w»t
 < 0)

1230 
»t
 = 
w»t
;

1232 
	`BUG_ON
(
w»t
 == 1);

1234 ià(
	`bŒfs_h—d”_Ä™ems
(
mid
) == 0) {

1235 
	`bŒfs_ş—r_bufãr_dœty
(
Œªs
, 
mid
);

1236 
	`bŒfs_Œ“_uÆock
(
mid
);

1237 
»t
 = 
	`bŒfs_d–_±r
(
Œªs
, 
roÙ
, 
·th
, 
Ëv–
 + 1, 
p¦Ù
);

1238 ià(
»t
 < 0) {

1239 
	`ä“_ex‹Á_bufãr_¡®e
(
mid
);

1240 
mid
 = 
NULL
;

1241 
out
;

1243 
	`roÙ_sub_u£d
(
roÙ
, 
mid
->
Ën
);

1244 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
	`bŒfs_roÙ_id
(
roÙ
), 
mid
, 0, 1);

1245 
	`ä“_ex‹Á_bufãr_¡®e
(
mid
);

1246 
mid
 = 
NULL
;

1249 
bŒfs_disk_key
 
mid_key
;

1250 
	`bŒfs_node_key
(
mid
, &
mid_key
, 0);

1251 
»t
 = 
	`bŒfs_Œ“_mod_log_š£¹_key
(
·»Á
, 
p¦Ù
,

1252 
BTRFS_MOD_LOG_KEY_REPLACE
);

1253 ià(
»t
 < 0) {

1254 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1255 
out
;

1257 
	`bŒfs_£t_node_key
(
·»Á
, &
mid_key
, 
p¦Ù
);

1258 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·»Á
);

1262 ià(
Ëá
) {

1263 ià(
	`bŒfs_h—d”_Ä™ems
(
Ëá
è> 
Üig_¦Ù
) {

1264 
	`©omic_šc
(&
Ëá
->
»fs
);

1266 
·th
->
nodes
[
Ëv–
] = 
Ëá
;

1267 
·th
->
¦Ùs
[
Ëv–
 + 1] -= 1;

1268 
·th
->
¦Ùs
[
Ëv–
] = 
Üig_¦Ù
;

1269 ià(
mid
) {

1270 
	`bŒfs_Œ“_uÆock
(
mid
);

1271 
	`ä“_ex‹Á_bufãr
(
mid
);

1274 
Üig_¦Ù
 -ğ
	`bŒfs_h—d”_Ä™ems
(
Ëá
);

1275 
·th
->
¦Ùs
[
Ëv–
] = 
Üig_¦Ù
;

1279 ià(
Üig_±r
 !=

1280 
	`bŒfs_node_block±r
(
·th
->
nodes
[
Ëv–
],…©h->
¦Ùs
[level]))

1281 
	`BUG
();

1282 
out
:

1283 ià(
right
) {

1284 
	`bŒfs_Œ“_uÆock
(
right
);

1285 
	`ä“_ex‹Á_bufãr
(
right
);

1287 ià(
Ëá
) {

1288 ià(
·th
->
nodes
[
Ëv–
] !ğ
Ëá
)

1289 
	`bŒfs_Œ“_uÆock
(
Ëá
);

1290 
	`ä“_ex‹Á_bufãr
(
Ëá
);

1292  
»t
;

1293 
	}
}

1299 
nošlše
 
	$push_nodes_fÜ_š£¹
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1300 
bŒfs_roÙ
 *
roÙ
,

1301 
bŒfs_·th
 *
·th
, 
Ëv–
)

1303 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1304 
ex‹Á_bufãr
 *
right
 = 
NULL
;

1305 
ex‹Á_bufãr
 *
mid
;

1306 
ex‹Á_bufãr
 *
Ëá
 = 
NULL
;

1307 
ex‹Á_bufãr
 *
·»Á
 = 
NULL
;

1308 
»t
 = 0;

1309 
w»t
;

1310 
p¦Ù
;

1311 
Üig_¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
];

1313 ià(
Ëv–
 == 0)

1316 
mid
 = 
·th
->
nodes
[
Ëv–
];

1317 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
mid
è!ğ
Œªs
->
Œªsid
);

1319 ià(
Ëv–
 < 
BTRFS_MAX_LEVEL
 - 1) {

1320 
·»Á
 = 
·th
->
nodes
[
Ëv–
 + 1];

1321 
p¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
 + 1];

1324 ià(!
·»Á
)

1328 ià(
p¦Ù
) {

1329 
u32
 
Ëá_Ä
;

1331 
Ëá
 = 
	`bŒfs_»ad_node_¦Ù
(
·»Á
, 
p¦Ù
 - 1);

1332 ià(
	`IS_ERR
(
Ëá
))

1333  
	`PTR_ERR
(
Ëá
);

1335 
	`__bŒfs_Œ“_lock
(
Ëá
, 
BTRFS_NESTING_LEFT
);

1337 
Ëá_Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëá
);

1338 ià(
Ëá_Ä
 >ğ
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
) - 1) {

1339 
w»t
 = 1;

1341 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
Ëá
, 
·»Á
,

1342 
p¦Ù
 - 1, &
Ëá
,

1343 
BTRFS_NESTING_LEFT_COW
);

1344 ià(
»t
)

1345 
w»t
 = 1;

1347 
w»t
 = 
	`push_node_Ëá
(
Œªs
, 
Ëá
, 
mid
, 0);

1350 ià(
w»t
 < 0)

1351 
»t
 = 
w»t
;

1352 ià(
w»t
 == 0) {

1353 
bŒfs_disk_key
 
disk_key
;

1354 
Üig_¦Ù
 +ğ
Ëá_Ä
;

1355 
	`bŒfs_node_key
(
mid
, &
disk_key
, 0);

1356 
»t
 = 
	`bŒfs_Œ“_mod_log_š£¹_key
(
·»Á
, 
p¦Ù
,

1357 
BTRFS_MOD_LOG_KEY_REPLACE
);

1358 ià(
»t
 < 0) {

1359 
	`bŒfs_Œ“_uÆock
(
Ëá
);

1360 
	`ä“_ex‹Á_bufãr
(
Ëá
);

1361 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1362  
»t
;

1364 
	`bŒfs_£t_node_key
(
·»Á
, &
disk_key
, 
p¦Ù
);

1365 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·»Á
);

1366 ià(
	`bŒfs_h—d”_Ä™ems
(
Ëá
è> 
Üig_¦Ù
) {

1367 
·th
->
nodes
[
Ëv–
] = 
Ëá
;

1368 
·th
->
¦Ùs
[
Ëv–
 + 1] -= 1;

1369 
·th
->
¦Ùs
[
Ëv–
] = 
Üig_¦Ù
;

1370 
	`bŒfs_Œ“_uÆock
(
mid
);

1371 
	`ä“_ex‹Á_bufãr
(
mid
);

1373 
Üig_¦Ù
 -=

1374 
	`bŒfs_h—d”_Ä™ems
(
Ëá
);

1375 
·th
->
¦Ùs
[
Ëv–
] = 
Üig_¦Ù
;

1376 
	`bŒfs_Œ“_uÆock
(
Ëá
);

1377 
	`ä“_ex‹Á_bufãr
(
Ëá
);

1381 
	`bŒfs_Œ“_uÆock
(
Ëá
);

1382 
	`ä“_ex‹Á_bufãr
(
Ëá
);

1388 ià(
p¦Ù
 + 1 < 
	`bŒfs_h—d”_Ä™ems
(
·»Á
)) {

1389 
u32
 
right_Ä
;

1391 
right
 = 
	`bŒfs_»ad_node_¦Ù
(
·»Á
, 
p¦Ù
 + 1);

1392 ià(
	`IS_ERR
(
right
))

1393  
	`PTR_ERR
(
right
);

1395 
	`__bŒfs_Œ“_lock
(
right
, 
BTRFS_NESTING_RIGHT
);

1397 
right_Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
right
);

1398 ià(
right_Ä
 >ğ
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
) - 1) {

1399 
w»t
 = 1;

1401 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
right
,

1402 
·»Á
, 
p¦Ù
 + 1,

1403 &
right
, 
BTRFS_NESTING_RIGHT_COW
);

1404 ià(
»t
)

1405 
w»t
 = 1;

1407 
w»t
 = 
	`b®ªû_node_right
(
Œªs
, 
right
, 
mid
);

1410 ià(
w»t
 < 0)

1411 
»t
 = 
w»t
;

1412 ià(
w»t
 == 0) {

1413 
bŒfs_disk_key
 
disk_key
;

1415 
	`bŒfs_node_key
(
right
, &
disk_key
, 0);

1416 
»t
 = 
	`bŒfs_Œ“_mod_log_š£¹_key
(
·»Á
, 
p¦Ù
 + 1,

1417 
BTRFS_MOD_LOG_KEY_REPLACE
);

1418 ià(
»t
 < 0) {

1419 
	`bŒfs_Œ“_uÆock
(
right
);

1420 
	`ä“_ex‹Á_bufãr
(
right
);

1421 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1422  
»t
;

1424 
	`bŒfs_£t_node_key
(
·»Á
, &
disk_key
, 
p¦Ù
 + 1);

1425 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·»Á
);

1427 ià(
	`bŒfs_h—d”_Ä™ems
(
mid
è<ğ
Üig_¦Ù
) {

1428 
·th
->
nodes
[
Ëv–
] = 
right
;

1429 
·th
->
¦Ùs
[
Ëv–
 + 1] += 1;

1430 
·th
->
¦Ùs
[
Ëv–
] = 
Üig_¦Ù
 -

1431 
	`bŒfs_h—d”_Ä™ems
(
mid
);

1432 
	`bŒfs_Œ“_uÆock
(
mid
);

1433 
	`ä“_ex‹Á_bufãr
(
mid
);

1435 
	`bŒfs_Œ“_uÆock
(
right
);

1436 
	`ä“_ex‹Á_bufãr
(
right
);

1440 
	`bŒfs_Œ“_uÆock
(
right
);

1441 
	`ä“_ex‹Á_bufãr
(
right
);

1444 
	}
}

1450 
	$»ada_fÜ_£¬ch
(
bŒfs_fs_šfo
 *
fs_šfo
,

1451 
bŒfs_·th
 *
·th
,

1452 
Ëv–
, 
¦Ù
, 
u64
 
objeùid
)

1454 
ex‹Á_bufãr
 *
node
;

1455 
bŒfs_disk_key
 
disk_key
;

1456 
u32
 
Ä™ems
;

1457 
u64
 
£¬ch
;

1458 
u64
 
rg‘
;

1459 
u64
 
Ä—d
 = 0;

1460 
u64
 
Ä—d_max
;

1461 
u32
 
Ä
;

1462 
u32
 
blocksize
;

1463 
u32
 
nsÿn
 = 0;

1465 ià(
Ëv–
 !ğ1 && 
·th
->
»ada
 !ğ
READA_FORWARD_ALWAYS
)

1468 ià(!
·th
->
nodes
[
Ëv–
])

1471 
node
 = 
·th
->
nodes
[
Ëv–
];

1478 ià(
·th
->
»ada
 =ğ
READA_FORWARD_ALWAYS
) {

1479 ià(
Ëv–
 > 1)

1480 
Ä—d_max
 = 
node
->
fs_šfo
->
nodesize
;

1482 
Ä—d_max
 = 
SZ_128K
;

1484 
Ä—d_max
 = 
SZ_64K
;

1487 
£¬ch
 = 
	`bŒfs_node_block±r
(
node
, 
¦Ù
);

1488 
blocksize
 = 
fs_šfo
->
nodesize
;

1489 ià(
·th
->
»ada
 !ğ
READA_FORWARD_ALWAYS
) {

1490 
ex‹Á_bufãr
 *
eb
;

1492 
eb
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
£¬ch
);

1493 ià(
eb
) {

1494 
	`ä“_ex‹Á_bufãr
(
eb
);

1499 
rg‘
 = 
£¬ch
;

1501 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
node
);

1502 
Ä
 = 
¦Ù
;

1505 ià(
·th
->
»ada
 =ğ
READA_BACK
) {

1506 ià(
Ä
 == 0)

1508 
Ä
--;

1509 } ià(
·th
->
»ada
 =ğ
READA_FORWARD
 ||

1510 
·th
->
»ada
 =ğ
READA_FORWARD_ALWAYS
) {

1511 
Ä
++;

1512 ià(
Ä
 >ğ
Ä™ems
)

1515 ià(
·th
->
»ada
 =ğ
READA_BACK
 && 
objeùid
) {

1516 
	`bŒfs_node_key
(
node
, &
disk_key
, 
Ä
);

1517 ià(
	`bŒfs_disk_key_objeùid
(&
disk_key
è!ğ
objeùid
)

1520 
£¬ch
 = 
	`bŒfs_node_block±r
(
node
, 
Ä
);

1521 ià(
·th
->
»ada
 =ğ
READA_FORWARD_ALWAYS
 ||

1522 (
£¬ch
 <ğ
rg‘
 &&arget - search <= 65536) ||

1523 (
£¬ch
 > 
rg‘
 && search -arget <= 65536)) {

1524 
	`bŒfs_»adah—d_node_chd
(
node
, 
Ä
);

1525 
Ä—d
 +ğ
blocksize
;

1527 
nsÿn
++;

1528 ià(
Ä—d
 > 
Ä—d_max
 || 
nsÿn
 > 32)

1531 
	}
}

1533 
nošlše
 
	$»ada_fÜ_b®ªû
(
bŒfs_·th
 *
·th
, 
Ëv–
)

1535 
ex‹Á_bufãr
 *
·»Á
;

1536 
¦Ù
;

1537 
Ä™ems
;

1539 
·»Á
 = 
·th
->
nodes
[
Ëv–
 + 1];

1540 ià(!
·»Á
)

1543 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·»Á
);

1544 
¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
 + 1];

1546 ià(
¦Ù
 > 0)

1547 
	`bŒfs_»adah—d_node_chd
(
·»Á
, 
¦Ù
 - 1);

1548 ià(
¦Ù
 + 1 < 
Ä™ems
)

1549 
	`bŒfs_»adah—d_node_chd
(
·»Á
, 
¦Ù
 + 1);

1550 
	}
}

1566 
nošlše
 
	$uÆock_up
(
bŒfs_·th
 *
·th
, 
Ëv–
,

1567 
lowe¡_uÆock
, 
mš_wr™e_lock_Ëv–
,

1568 *
wr™e_lock_Ëv–
)

1570 
i
;

1571 
sk_Ëv–
 = 
Ëv–
;

1572 
boŞ
 
check_sk
 = 
Œue
;

1574 
i
 = 
Ëv–
; i < 
BTRFS_MAX_LEVEL
; i++) {

1575 ià(!
·th
->
nodes
[
i
])

1577 ià(!
·th
->
locks
[
i
])

1580 ià(
check_sk
) {

1581 ià(
·th
->
¦Ùs
[
i
] == 0) {

1582 
sk_Ëv–
 = 
i
 + 1;

1586 ià(
·th
->
k“p_locks
) {

1587 
u32
 
Ä™ems
;

1589 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[
i
]);

1590 ià(
Ä™ems
 < 1 || 
·th
->
¦Ùs
[
i
] >=‚ritems - 1) {

1591 
sk_Ëv–
 = 
i
 + 1;

1597 ià(
i
 >ğ
lowe¡_uÆock
 && i > 
sk_Ëv–
) {

1598 
check_sk
 = 
çl£
;

1599 
	`bŒfs_Œ“_uÆock_rw
(
·th
->
nodes
[
i
],…©h->
locks
[i]);

1600 
·th
->
locks
[
i
] = 0;

1601 ià(
wr™e_lock_Ëv–
 &&

1602 
i
 > 
mš_wr™e_lock_Ëv–
 &&

1603 
i
 <ğ*
wr™e_lock_Ëv–
) {

1604 *
wr™e_lock_Ëv–
 = 
i
 - 1;

1608 
	}
}

1620 
	$»ad_block_fÜ_£¬ch
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
p
,

1621 
ex‹Á_bufãr
 **
eb_»t
, 
Ëv–
, 
¦Ù
,

1622 cÚ¡ 
bŒfs_key
 *
key
)

1624 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1625 
bŒfs_Œ“_·»Á_check
 
check
 = { 0 };

1626 
u64
 
blockÄ
;

1627 
u64
 
g’
;

1628 
ex‹Á_bufãr
 *
tmp
;

1629 
»t
;

1630 
·»Á_Ëv–
;

1631 
boŞ
 
uÆock_up
;

1633 
uÆock_up
 = ((
Ëv–
 + 1 < 
BTRFS_MAX_LEVEL
è&& 
p
->
locks
[level + 1]);

1634 
blockÄ
 = 
	`bŒfs_node_block±r
(*
eb_»t
, 
¦Ù
);

1635 
g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(*
eb_»t
, 
¦Ù
);

1636 
·»Á_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(*
eb_»t
);

1637 
	`bŒfs_node_key_to_ıu
(*
eb_»t
, &
check
.
fœ¡_key
, 
¦Ù
);

1638 
check
.
has_fœ¡_key
 = 
Œue
;

1639 
check
.
Ëv–
 = 
·»Á_Ëv–
 - 1;

1640 
check
.
Œªsid
 = 
g’
;

1641 
check
.
owÃr_roÙ
 = 
roÙ
->
roÙ_key
.
objeùid
;

1650 
tmp
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
blockÄ
);

1651 ià(
tmp
) {

1652 ià(
p
->
»ada
 =ğ
READA_FORWARD_ALWAYS
)

1653 
	`»ada_fÜ_£¬ch
(
fs_šfo
, 
p
, 
Ëv–
, 
¦Ù
, 
key
->
objeùid
);

1656 ià(
	`bŒfs_bufãr_u±od©e
(
tmp
, 
g’
, 1) > 0) {

1662 ià(
	`bŒfs_v”ify_Ëv–_key
(
tmp
,

1663 
·»Á_Ëv–
 - 1, &
check
.
fœ¡_key
, 
g’
)) {

1664 
	`ä“_ex‹Á_bufãr
(
tmp
);

1665  -
EUCLEAN
;

1667 *
eb_»t
 = 
tmp
;

1671 ià(
p
->
nowa™
) {

1672 
	`ä“_ex‹Á_bufãr
(
tmp
);

1673  -
EAGAIN
;

1676 ià(
uÆock_up
)

1677 
	`bŒfs_uÆock_up_§ã
(
p
, 
Ëv–
 + 1);

1680 
»t
 = 
	`bŒfs_»ad_ex‹Á_bufãr
(
tmp
, &
check
);

1681 ià(
»t
) {

1682 
	`ä“_ex‹Á_bufãr
(
tmp
);

1683 
	`bŒfs_»Ëa£_·th
(
p
);

1684  -
EIO
;

1686 ià(
	`bŒfs_check_eb_owÃr
(
tmp
, 
roÙ
->
roÙ_key
.
objeùid
)) {

1687 
	`ä“_ex‹Á_bufãr
(
tmp
);

1688 
	`bŒfs_»Ëa£_·th
(
p
);

1689  -
EUCLEAN
;

1692 ià(
uÆock_up
)

1693 
»t
 = -
EAGAIN
;

1695 
out
;

1696 } ià(
p
->
nowa™
) {

1697  -
EAGAIN
;

1700 ià(
uÆock_up
) {

1701 
	`bŒfs_uÆock_up_§ã
(
p
, 
Ëv–
 + 1);

1702 
»t
 = -
EAGAIN
;

1704 
»t
 = 0;

1707 ià(
p
->
»ada
 !ğ
READA_NONE
)

1708 
	`»ada_fÜ_£¬ch
(
fs_šfo
, 
p
, 
Ëv–
, 
¦Ù
, 
key
->
objeùid
);

1710 
tmp
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
blockÄ
, &
check
);

1711 ià(
	`IS_ERR
(
tmp
)) {

1712 
	`bŒfs_»Ëa£_·th
(
p
);

1713  
	`PTR_ERR
(
tmp
);

1721 ià(!
	`ex‹Á_bufãr_u±od©e
(
tmp
))

1722 
»t
 = -
EIO
;

1724 
out
:

1725 ià(
»t
 == 0) {

1726 *
eb_»t
 = 
tmp
;

1728 
	`ä“_ex‹Á_bufãr
(
tmp
);

1729 
	`bŒfs_»Ëa£_·th
(
p
);

1732  
»t
;

1733 
	}
}

1745 
	$£tup_nodes_fÜ_£¬ch
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1746 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
p
,

1747 
ex‹Á_bufãr
 *
b
, 
Ëv–
, 
šs_Ën
,

1748 *
wr™e_lock_Ëv–
)

1750 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1751 
»t
 = 0;

1753 ià((
p
->
£¬ch_fÜ_¥l™
 || 
šs_Ën
 > 0è&& 
	`bŒfs_h—d”_Ä™ems
(
b
) >=

1754 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
) - 3) {

1756 ià(*
wr™e_lock_Ëv–
 < 
Ëv–
 + 1) {

1757 *
wr™e_lock_Ëv–
 = 
Ëv–
 + 1;

1758 
	`bŒfs_»Ëa£_·th
(
p
);

1759  -
EAGAIN
;

1762 
	`»ada_fÜ_b®ªû
(
p
, 
Ëv–
);

1763 
»t
 = 
	`¥l™_node
(
Œªs
, 
roÙ
, 
p
, 
Ëv–
);

1765 
b
 = 
p
->
nodes
[
Ëv–
];

1766 } ià(
šs_Ën
 < 0 && 
	`bŒfs_h—d”_Ä™ems
(
b
) <

1767 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
) / 2) {

1769 ià(*
wr™e_lock_Ëv–
 < 
Ëv–
 + 1) {

1770 *
wr™e_lock_Ëv–
 = 
Ëv–
 + 1;

1771 
	`bŒfs_»Ëa£_·th
(
p
);

1772  -
EAGAIN
;

1775 
	`»ada_fÜ_b®ªû
(
p
, 
Ëv–
);

1776 
»t
 = 
	`b®ªû_Ëv–
(
Œªs
, 
roÙ
, 
p
, 
Ëv–
);

1777 ià(
»t
)

1778  
»t
;

1780 
b
 = 
p
->
nodes
[
Ëv–
];

1781 ià(!
b
) {

1782 
	`bŒfs_»Ëa£_·th
(
p
);

1783  -
EAGAIN
;

1785 
	`BUG_ON
(
	`bŒfs_h—d”_Ä™ems
(
b
) == 1);

1787  
»t
;

1788 
	}
}

1790 
	$bŒfs_fšd_™em
(
bŒfs_roÙ
 *
fs_roÙ
, 
bŒfs_·th
 *
·th
,

1791 
u64
 
iobjeùid
, u64 
ioff
, 
u8
 
key_ty³
,

1792 
bŒfs_key
 *
found_key
)

1794 
»t
;

1795 
bŒfs_key
 
key
;

1796 
ex‹Á_bufãr
 *
eb
;

1798 
	`ASSERT
(
·th
);

1799 
	`ASSERT
(
found_key
);

1801 
key
.
ty³
 = 
key_ty³
;

1802 
key
.
objeùid
 = 
iobjeùid
;

1803 
key
.
off£t
 = 
ioff
;

1805 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_roÙ
, &
key
, 
·th
, 0, 0);

1806 ià(
»t
 < 0)

1807  
»t
;

1809 
eb
 = 
·th
->
nodes
[0];

1810 ià(
»t
 && 
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
(
eb
)) {

1811 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
fs_roÙ
, 
·th
);

1812 ià(
»t
)

1813  
»t
;

1814 
eb
 = 
·th
->
nodes
[0];

1817 
	`bŒfs_™em_key_to_ıu
(
eb
, 
found_key
, 
·th
->
¦Ùs
[0]);

1818 ià(
found_key
->
ty³
 !ğ
key
.type ||

1819 
found_key
->
objeùid
 !ğ
key
.objectid)

1823 
	}
}

1825 
ex‹Á_bufãr
 *
	$bŒfs_£¬ch_¦Ù_g‘_roÙ
(
bŒfs_roÙ
 *
roÙ
,

1826 
bŒfs_·th
 *
p
,

1827 
wr™e_lock_Ëv–
)

1829 
ex‹Á_bufãr
 *
b
;

1830 
roÙ_lock
 = 0;

1831 
Ëv–
 = 0;

1833 ià(
p
->
£¬ch_comm™_roÙ
) {

1834 
b
 = 
roÙ
->
comm™_roÙ
;

1835 
	`©omic_šc
(&
b
->
»fs
);

1836 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

1841 
	`ASSERT
(
p
->
sk_lockšg
 == 1);

1843 
out
;

1846 ià(
p
->
sk_lockšg
) {

1847 
b
 = 
	`bŒfs_roÙ_node
(
roÙ
);

1848 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

1849 
out
;

1853 
roÙ_lock
 = 
BTRFS_READ_LOCK
;

1859 ià(
wr™e_lock_Ëv–
 < 
BTRFS_MAX_LEVEL
) {

1864 ià(
p
->
nowa™
) {

1865 
b
 = 
	`bŒfs_Œy_»ad_lock_roÙ_node
(
roÙ
);

1866 ià(
	`IS_ERR
(
b
))

1867  
b
;

1869 
b
 = 
	`bŒfs_»ad_lock_roÙ_node
(
roÙ
);

1871 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

1872 ià(
Ëv–
 > 
wr™e_lock_Ëv–
)

1873 
out
;

1876 
	`bŒfs_Œ“_»ad_uÆock
(
b
);

1877 
	`ä“_ex‹Á_bufãr
(
b
);

1880 
b
 = 
	`bŒfs_lock_roÙ_node
(
roÙ
);

1881 
roÙ_lock
 = 
BTRFS_WRITE_LOCK
;

1884 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

1886 
out
:

1891 ià(!
	`ex‹Á_bufãr_u±od©e
(
b
)) {

1892 ià(
roÙ_lock
)

1893 
	`bŒfs_Œ“_uÆock_rw
(
b
, 
roÙ_lock
);

1894 
	`ä“_ex‹Á_bufãr
(
b
);

1895  
	`ERR_PTR
(-
EIO
);

1898 
p
->
nodes
[
Ëv–
] = 
b
;

1899 ià(!
p
->
sk_lockšg
)

1900 
p
->
locks
[
Ëv–
] = 
roÙ_lock
;

1904  
b
;

1905 
	}
}

1919 
	$fšish_Ãed_comm™_£m_£¬ch
(
bŒfs_·th
 *
·th
)

1921 cÚ¡ 
i
 = 
·th
->
lowe¡_Ëv–
;

1922 cÚ¡ 
¦Ù
 = 
·th
->
¦Ùs
[
i
];

1923 
ex‹Á_bufãr
 *
lowe¡
 = 
·th
->
nodes
[
i
];

1924 
ex‹Á_bufãr
 *
şÚe
;

1926 
	`ASSERT
(
·th
->
Ãed_comm™_£m
);

1928 ià(!
lowe¡
)

1931 
	`lockd•_as£¹_h–d_»ad
(&
lowe¡
->
fs_šfo
->
comm™_roÙ_£m
);

1933 
şÚe
 = 
	`bŒfs_şÚe_ex‹Á_bufãr
(
lowe¡
);

1934 ià(!
şÚe
)

1935  -
ENOMEM
;

1937 
	`bŒfs_»Ëa£_·th
(
·th
);

1938 
·th
->
nodes
[
i
] = 
şÚe
;

1939 
·th
->
¦Ùs
[
i
] = 
¦Ù
;

1942 
	}
}

1944 
šlše
 
	$£¬ch_fÜ_key_¦Ù
(
ex‹Á_bufãr
 *
eb
,

1945 
£¬ch_low_¦Ù
,

1946 cÚ¡ 
bŒfs_key
 *
key
,

1947 
´ev_cmp
,

1948 *
¦Ù
)

1957 ià(
´ev_cmp
 == 0) {

1958 *
¦Ù
 = 0;

1962  
	`bŒfs_bš_£¬ch
(
eb
, 
£¬ch_low_¦Ù
, 
key
, 
¦Ù
);

1963 
	}
}

1965 
	$£¬ch_Ëaf
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1966 
bŒfs_roÙ
 *
roÙ
,

1967 cÚ¡ 
bŒfs_key
 *
key
,

1968 
bŒfs_·th
 *
·th
,

1969 
šs_Ën
,

1970 
´ev_cmp
)

1972 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

1973 
Ëaf_ä“_¥aû
 = -1;

1974 
£¬ch_low_¦Ù
 = 0;

1975 
»t
;

1976 
boŞ
 
do_bš_£¬ch
 = 
Œue
;

1985 ià(
šs_Ën
 > 0) {

1990 
Ëaf_ä“_¥aû
 = 
	`bŒfs_Ëaf_ä“_¥aû
(
Ëaf
);

1996 ià(
·th
->
locks
[1] && 
Ëaf_ä“_¥aû
 >ğ
šs_Ën
) {

1997 
bŒfs_disk_key
 
fœ¡_key
;

1999 
	`ASSERT
(
	`bŒfs_h—d”_Ä™ems
(
Ëaf
) > 0);

2000 
	`bŒfs_™em_key
(
Ëaf
, &
fœ¡_key
, 0);

2009 
»t
 = 
	`comp_keys
(&
fœ¡_key
, 
key
);

2010 ià(
»t
 < 0) {

2023 
	`bŒfs_uÆock_up_§ã
(
·th
, 1);

2024 
£¬ch_low_¦Ù
 = 1;

2040 ià(
»t
 == 0)

2041 
	`bŒfs_uÆock_up_§ã
(
·th
, 1);

2047 
do_bš_£¬ch
 = 
çl£
;

2048 
·th
->
¦Ùs
[0] = 0;

2053 ià(
do_bš_£¬ch
) {

2054 
»t
 = 
	`£¬ch_fÜ_key_¦Ù
(
Ëaf
, 
£¬ch_low_¦Ù
, 
key
,

2055 
´ev_cmp
, &
·th
->
¦Ùs
[0]);

2056 ià(
»t
 < 0)

2057  
»t
;

2060 ià(
šs_Ën
 > 0) {

2070 ià(
»t
 =ğ0 && !
·th
->
£¬ch_fÜ_ex‹nsiÚ
) {

2071 
	`ASSERT
(
šs_Ën
 >ğ(
bŒfs_™em
));

2072 
šs_Ën
 -ğ(
bŒfs_™em
);

2075 
	`ASSERT
(
Ëaf_ä“_¥aû
 >= 0);

2077 ià(
Ëaf_ä“_¥aû
 < 
šs_Ën
) {

2078 
”r
;

2080 
”r
 = 
	`¥l™_Ëaf
(
Œªs
, 
roÙ
, 
key
, 
·th
, 
šs_Ën
,

2081 (
»t
 == 0));

2082 
	`ASSERT
(
”r
 <= 0);

2083 ià(
	`WARN_ON
(
”r
 > 0))

2084 
”r
 = -
EUCLEAN
;

2085 ià(
”r
)

2086 
»t
 = 
”r
;

2090  
»t
;

2091 
	}
}

2124 
	$bŒfs_£¬ch_¦Ù
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

2125 cÚ¡ 
bŒfs_key
 *
key
, 
bŒfs_·th
 *
p
,

2126 
šs_Ën
, 
cow
)

2128 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2129 
ex‹Á_bufãr
 *
b
;

2130 
¦Ù
;

2131 
»t
;

2132 
”r
;

2133 
Ëv–
;

2134 
lowe¡_uÆock
 = 1;

2136 
wr™e_lock_Ëv–
 = 0;

2137 
u8
 
lowe¡_Ëv–
 = 0;

2138 
mš_wr™e_lock_Ëv–
;

2139 
´ev_cmp
;

2141 
	`might_¦“p
();

2143 
lowe¡_Ëv–
 = 
p
->lowest_level;

2144 
	`WARN_ON
(
lowe¡_Ëv–
 && 
šs_Ën
 > 0);

2145 
	`WARN_ON
(
p
->
nodes
[0] !ğ
NULL
);

2146 
	`BUG_ON
(!
cow
 && 
šs_Ën
);

2153 
	`ASSERT
(!
p
->
nowa™
 || !
cow
);

2155 ià(
šs_Ën
 < 0) {

2156 
lowe¡_uÆock
 = 2;

2162 
wr™e_lock_Ëv–
 = 2;

2163 } ià(
šs_Ën
 > 0) {

2168 
wr™e_lock_Ëv–
 = 1;

2171 ià(!
cow
)

2172 
wr™e_lock_Ëv–
 = -1;

2174 ià(
cow
 && (
p
->
k“p_locks
 ||…->
lowe¡_Ëv–
))

2175 
wr™e_lock_Ëv–
 = 
BTRFS_MAX_LEVEL
;

2177 
mš_wr™e_lock_Ëv–
 = 
wr™e_lock_Ëv–
;

2179 ià(
p
->
Ãed_comm™_£m
) {

2180 
	`ASSERT
(
p
->
£¬ch_comm™_roÙ
);

2181 ià(
p
->
nowa™
) {

2182 ià(!
	`down_»ad_Œylock
(&
fs_šfo
->
comm™_roÙ_£m
))

2183  -
EAGAIN
;

2185 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

2189 
agaš
:

2190 
´ev_cmp
 = -1;

2191 
b
 = 
	`bŒfs_£¬ch_¦Ù_g‘_roÙ
(
roÙ
, 
p
, 
wr™e_lock_Ëv–
);

2192 ià(
	`IS_ERR
(
b
)) {

2193 
»t
 = 
	`PTR_ERR
(
b
);

2194 
dÚe
;

2197 
b
) {

2198 
dec
 = 0;

2200 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

2202 ià(
cow
) {

2203 
boŞ
 
Ï¡_Ëv–
 = (
Ëv–
 =ğ(
BTRFS_MAX_LEVEL
 - 1));

2210 ià(!
	`should_cow_block
(
Œªs
, 
roÙ
, 
b
))

2211 
cow_dÚe
;

2217 ià(
Ëv–
 > 
wr™e_lock_Ëv–
 ||

2218 (
Ëv–
 + 1 > 
wr™e_lock_Ëv–
 &&

2219 
Ëv–
 + 1 < 
BTRFS_MAX_LEVEL
 &&

2220 
p
->
nodes
[
Ëv–
 + 1])) {

2221 
wr™e_lock_Ëv–
 = 
Ëv–
 + 1;

2222 
	`bŒfs_»Ëa£_·th
(
p
);

2223 
agaš
;

2226 ià(
Ï¡_Ëv–
)

2227 
”r
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
b
, 
NULL
, 0,

2228 &
b
,

2229 
BTRFS_NESTING_COW
);

2231 
”r
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
b
,

2232 
p
->
nodes
[
Ëv–
 + 1],

2233 
p
->
¦Ùs
[
Ëv–
 + 1], &
b
,

2234 
BTRFS_NESTING_COW
);

2235 ià(
”r
) {

2236 
»t
 = 
”r
;

2237 
dÚe
;

2240 
cow_dÚe
:

2241 
p
->
nodes
[
Ëv–
] = 
b
;

2254 ià(!
šs_Ën
 && !
p
->
k“p_locks
) {

2255 
u
 = 
Ëv–
 + 1;

2257 ià(
u
 < 
BTRFS_MAX_LEVEL
 && 
p
->
locks
[u]) {

2258 
	`bŒfs_Œ“_uÆock_rw
(
p
->
nodes
[
u
],…->
locks
[u]);

2259 
p
->
locks
[
u
] = 0;

2263 ià(
Ëv–
 == 0) {

2264 ià(
šs_Ën
 > 0)

2265 
	`ASSERT
(
wr™e_lock_Ëv–
 >= 1);

2267 
»t
 = 
	`£¬ch_Ëaf
(
Œªs
, 
roÙ
, 
key
, 
p
, 
šs_Ën
, 
´ev_cmp
);

2268 ià(!
p
->
£¬ch_fÜ_¥l™
)

2269 
	`uÆock_up
(
p
, 
Ëv–
, 
lowe¡_uÆock
,

2270 
mš_wr™e_lock_Ëv–
, 
NULL
);

2271 
dÚe
;

2274 
»t
 = 
	`£¬ch_fÜ_key_¦Ù
(
b
, 0, 
key
, 
´ev_cmp
, &
¦Ù
);

2275 ià(
»t
 < 0)

2276 
dÚe
;

2277 
´ev_cmp
 = 
»t
;

2279 ià(
»t
 && 
¦Ù
 > 0) {

2280 
dec
 = 1;

2281 
¦Ù
--;

2283 
p
->
¦Ùs
[
Ëv–
] = 
¦Ù
;

2284 
”r
 = 
	`£tup_nodes_fÜ_£¬ch
(
Œªs
, 
roÙ
, 
p
, 
b
, 
Ëv–
, 
šs_Ën
,

2285 &
wr™e_lock_Ëv–
);

2286 ià(
”r
 =ğ-
EAGAIN
)

2287 
agaš
;

2288 ià(
”r
) {

2289 
»t
 = 
”r
;

2290 
dÚe
;

2292 
b
 = 
p
->
nodes
[
Ëv–
];

2293 
¦Ù
 = 
p
->
¦Ùs
[
Ëv–
];

2300 ià(
¦Ù
 =ğ0 && 
šs_Ën
 && 
wr™e_lock_Ëv–
 < 
Ëv–
 + 1) {

2301 
wr™e_lock_Ëv–
 = 
Ëv–
 + 1;

2302 
	`bŒfs_»Ëa£_·th
(
p
);

2303 
agaš
;

2306 
	`uÆock_up
(
p
, 
Ëv–
, 
lowe¡_uÆock
, 
mš_wr™e_lock_Ëv–
,

2307 &
wr™e_lock_Ëv–
);

2309 ià(
Ëv–
 =ğ
lowe¡_Ëv–
) {

2310 ià(
dec
)

2311 
p
->
¦Ùs
[
Ëv–
]++;

2312 
dÚe
;

2315 
”r
 = 
	`»ad_block_fÜ_£¬ch
(
roÙ
, 
p
, &
b
, 
Ëv–
, 
¦Ù
, 
key
);

2316 ià(
”r
 =ğ-
EAGAIN
)

2317 
agaš
;

2318 ià(
”r
) {

2319 
»t
 = 
”r
;

2320 
dÚe
;

2323 ià(!
p
->
sk_lockšg
) {

2324 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

2326 
	`bŒfs_maybe_»£t_lockd•_şass
(
roÙ
, 
b
);

2328 ià(
Ëv–
 <ğ
wr™e_lock_Ëv–
) {

2329 
	`bŒfs_Œ“_lock
(
b
);

2330 
p
->
locks
[
Ëv–
] = 
BTRFS_WRITE_LOCK
;

2332 ià(
p
->
nowa™
) {

2333 ià(!
	`bŒfs_Œy_Œ“_»ad_lock
(
b
)) {

2334 
	`ä“_ex‹Á_bufãr
(
b
);

2335 
»t
 = -
EAGAIN
;

2336 
dÚe
;

2339 
	`bŒfs_Œ“_»ad_lock
(
b
);

2341 
p
->
locks
[
Ëv–
] = 
BTRFS_READ_LOCK
;

2343 
p
->
nodes
[
Ëv–
] = 
b
;

2346 
»t
 = 1;

2347 
dÚe
:

2348 ià(
»t
 < 0 && !
p
->
sk_»Ëa£_Ú_”rÜ
)

2349 
	`bŒfs_»Ëa£_·th
(
p
);

2351 ià(
p
->
Ãed_comm™_£m
) {

2352 
»t2
;

2354 
»t2
 = 
	`fšish_Ãed_comm™_£m_£¬ch
(
p
);

2355 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

2356 ià(
»t2
)

2357 
»t
 = 
»t2
;

2360  
»t
;

2361 
	}
}

2362 
ALLOW_ERROR_INJECTION
(
bŒfs_£¬ch_¦Ù
, 
ERRNO
);

2375 
	$bŒfs_£¬ch_Şd_¦Ù
(
bŒfs_roÙ
 *
roÙ
, cÚ¡ 
bŒfs_key
 *
key
,

2376 
bŒfs_·th
 *
p
, 
u64
 
time_£q
)

2378 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2379 
ex‹Á_bufãr
 *
b
;

2380 
¦Ù
;

2381 
»t
;

2382 
”r
;

2383 
Ëv–
;

2384 
lowe¡_uÆock
 = 1;

2385 
u8
 
lowe¡_Ëv–
 = 0;

2387 
lowe¡_Ëv–
 = 
p
->lowest_level;

2388 
	`WARN_ON
(
p
->
nodes
[0] !ğ
NULL
);

2389 
	`ASSERT
(!
p
->
nowa™
);

2391 ià(
p
->
£¬ch_comm™_roÙ
) {

2392 
	`BUG_ON
(
time_£q
);

2393  
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, 
key
, 
p
, 0, 0);

2396 
agaš
:

2397 
b
 = 
	`bŒfs_g‘_Şd_roÙ
(
roÙ
, 
time_£q
);

2398 ià(!
b
) {

2399 
»t
 = -
EIO
;

2400 
dÚe
;

2402 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

2403 
p
->
locks
[
Ëv–
] = 
BTRFS_READ_LOCK
;

2405 
b
) {

2406 
dec
 = 0;

2408 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

2409 
p
->
nodes
[
Ëv–
] = 
b
;

2417 
	`bŒfs_uÆock_up_§ã
(
p
, 
Ëv–
 + 1);

2419 
»t
 = 
	`bŒfs_bš_£¬ch
(
b
, 0, 
key
, &
¦Ù
);

2420 ià(
»t
 < 0)

2421 
dÚe
;

2423 ià(
Ëv–
 == 0) {

2424 
p
->
¦Ùs
[
Ëv–
] = 
¦Ù
;

2425 
	`uÆock_up
(
p
, 
Ëv–
, 
lowe¡_uÆock
, 0, 
NULL
);

2426 
dÚe
;

2429 ià(
»t
 && 
¦Ù
 > 0) {

2430 
dec
 = 1;

2431 
¦Ù
--;

2433 
p
->
¦Ùs
[
Ëv–
] = 
¦Ù
;

2434 
	`uÆock_up
(
p
, 
Ëv–
, 
lowe¡_uÆock
, 0, 
NULL
);

2436 ià(
Ëv–
 =ğ
lowe¡_Ëv–
) {

2437 ià(
dec
)

2438 
p
->
¦Ùs
[
Ëv–
]++;

2439 
dÚe
;

2442 
”r
 = 
	`»ad_block_fÜ_£¬ch
(
roÙ
, 
p
, &
b
, 
Ëv–
, 
¦Ù
, 
key
);

2443 ià(
”r
 =ğ-
EAGAIN
)

2444 
agaš
;

2445 ià(
”r
) {

2446 
»t
 = 
”r
;

2447 
dÚe
;

2450 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

2451 
	`bŒfs_Œ“_»ad_lock
(
b
);

2452 
b
 = 
	`bŒfs_Œ“_mod_log_»wšd
(
fs_šfo
, 
p
, b, 
time_£q
);

2453 ià(!
b
) {

2454 
»t
 = -
ENOMEM
;

2455 
dÚe
;

2457 
p
->
locks
[
Ëv–
] = 
BTRFS_READ_LOCK
;

2458 
p
->
nodes
[
Ëv–
] = 
b
;

2460 
»t
 = 1;

2461 
dÚe
:

2462 ià(
»t
 < 0)

2463 
	`bŒfs_»Ëa£_·th
(
p
);

2465  
»t
;

2466 
	}
}

2477 
	$bŒfs_´ev_Ëaf
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
)

2479 
bŒfs_key
 
key
;

2480 
bŒfs_key
 
Üig_key
;

2481 
bŒfs_disk_key
 
found_key
;

2482 
»t
;

2484 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
, 0);

2485 
Üig_key
 = 
key
;

2487 ià(
key
.
off£t
 > 0) {

2488 
key
.
off£t
--;

2489 } ià(
key
.
ty³
 > 0) {

2490 
key
.
ty³
--;

2491 
key
.
off£t
 = (
u64
)-1;

2492 } ià(
key
.
objeùid
 > 0) {

2493 
key
.
objeùid
--;

2494 
key
.
ty³
 = (
u8
)-1;

2495 
key
.
off£t
 = (
u64
)-1;

2500 
	`bŒfs_»Ëa£_·th
(
·th
);

2501 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

2502 ià(
»t
 <= 0)

2503  
»t
;

2516 ià(
·th
->
¦Ùs
[0] < 
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0])) {

2517 
	`bŒfs_™em_key
(
·th
->
nodes
[0], &
found_key
,…©h->
¦Ùs
[0]);

2518 
»t
 = 
	`comp_keys
(&
found_key
, &
Üig_key
);

2519 ià(
»t
 == 0) {

2520 ià(
·th
->
¦Ùs
[0] > 0) {

2521 
·th
->
¦Ùs
[0]--;

2532 
	`bŒfs_™em_key
(
·th
->
nodes
[0], &
found_key
, 0);

2533 
»t
 = 
	`comp_keys
(&
found_key
, &
key
);

2544 ià(
»t
 <= 0)

2547 
	}
}

2561 
	$bŒfs_£¬ch_¦Ù_fÜ_»ad
(
bŒfs_roÙ
 *
roÙ
,

2562 cÚ¡ 
bŒfs_key
 *
key
,

2563 
bŒfs_·th
 *
p
, 
fšd_high”
,

2564 
»tuº_ªy
)

2566 
»t
;

2567 
ex‹Á_bufãr
 *
Ëaf
;

2569 
agaš
:

2570 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, 
key
, 
p
, 0, 0);

2571 ià(
»t
 <= 0)

2572  
»t
;

2580 
Ëaf
 = 
p
->
nodes
[0];

2582 ià(
fšd_high”
) {

2583 ià(
p
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

2584 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
p
);

2585 ià(
»t
 <= 0)

2586  
»t
;

2587 ià(!
»tuº_ªy
)

2593 
»tuº_ªy
 = 0;

2594 
fšd_high”
 = 0;

2595 
	`bŒfs_»Ëa£_·th
(
p
);

2596 
agaš
;

2599 ià(
p
->
¦Ùs
[0] == 0) {

2600 
»t
 = 
	`bŒfs_´ev_Ëaf
(
roÙ
, 
p
);

2601 ià(
»t
 < 0)

2602  
»t
;

2603 ià(!
»t
) {

2604 
Ëaf
 = 
p
->
nodes
[0];

2605 ià(
p
->
¦Ùs
[0] =ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
))

2606 
p
->
¦Ùs
[0]--;

2609 ià(!
»tuº_ªy
)

2615 
»tuº_ªy
 = 0;

2616 
fšd_high”
 = 1;

2617 
	`bŒfs_»Ëa£_·th
(
p
);

2618 
agaš
;

2620 --
p
->
¦Ùs
[0];

2624 
	}
}

2632 
	$bŒfs_£¬ch_backw¬ds
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_key
 *
key
,

2633 
bŒfs_·th
 *
·th
)

2635 
»t
;

2637 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, 
key
, 
·th
, 0, 0);

2638 ià(
»t
 > 0)

2639 
»t
 = 
	`bŒfs_´evious_™em
(
roÙ
, 
·th
, 
key
->
objeùid
, key->
ty³
);

2641 ià(
»t
 == 0)

2642 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], 
key
,…©h->
¦Ùs
[0]);

2644  
»t
;

2645 
	}
}

2658 
	$bŒfs_g‘_Ãxt_v®id_™em
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_key
 *
key
,

2659 
bŒfs_·th
 *
·th
)

2661 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0])) {

2662 
»t
;

2664 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

2665 ià(
»t
)

2666  
»t
;

2669 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], 
key
,…©h->
¦Ùs
[0]);

2671 
	}
}

2681 
	$fixup_low_keys
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2682 
bŒfs_·th
 *
·th
,

2683 
bŒfs_disk_key
 *
key
, 
Ëv–
)

2685 
i
;

2686 
ex‹Á_bufãr
 *
t
;

2687 
»t
;

2689 
i
 = 
Ëv–
; i < 
BTRFS_MAX_LEVEL
; i++) {

2690 
t¦Ù
 = 
·th
->
¦Ùs
[
i
];

2692 ià(!
·th
->
nodes
[
i
])

2694 
t
 = 
·th
->
nodes
[
i
];

2695 
»t
 = 
	`bŒfs_Œ“_mod_log_š£¹_key
(
t
, 
t¦Ù
,

2696 
BTRFS_MOD_LOG_KEY_REPLACE
);

2697 
	`BUG_ON
(
»t
 < 0);

2698 
	`bŒfs_£t_node_key
(
t
, 
key
, 
t¦Ù
);

2699 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·th
->
nodes
[
i
]);

2700 ià(
t¦Ù
 != 0)

2703 
	}
}

2711 
	$bŒfs_£t_™em_key_§ã
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2712 
bŒfs_·th
 *
·th
,

2713 cÚ¡ 
bŒfs_key
 *
Ãw_key
)

2715 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2716 
bŒfs_disk_key
 
disk_key
;

2717 
ex‹Á_bufãr
 *
eb
;

2718 
¦Ù
;

2720 
eb
 = 
·th
->
nodes
[0];

2721 
¦Ù
 = 
·th
->
¦Ùs
[0];

2722 ià(
¦Ù
 > 0) {

2723 
	`bŒfs_™em_key
(
eb
, &
disk_key
, 
¦Ù
 - 1);

2724 ià(
	`uÆik–y
(
	`comp_keys
(&
disk_key
, 
Ãw_key
) >= 0)) {

2725 
	`bŒfs_´št_Ëaf
(
eb
);

2726 
	`bŒfs_ü™
(
fs_šfo
,

2728 
¦Ù
, 
	`bŒfs_disk_key_objeùid
(&
disk_key
),

2729 
	`bŒfs_disk_key_ty³
(&
disk_key
),

2730 
	`bŒfs_disk_key_off£t
(&
disk_key
),

2731 
Ãw_key
->
objeùid
,‚ew_key->
ty³
,

2732 
Ãw_key
->
off£t
);

2733 
	`BUG
();

2736 ià(
¦Ù
 < 
	`bŒfs_h—d”_Ä™ems
(
eb
) - 1) {

2737 
	`bŒfs_™em_key
(
eb
, &
disk_key
, 
¦Ù
 + 1);

2738 ià(
	`uÆik–y
(
	`comp_keys
(&
disk_key
, 
Ãw_key
) <= 0)) {

2739 
	`bŒfs_´št_Ëaf
(
eb
);

2740 
	`bŒfs_ü™
(
fs_šfo
,

2742 
¦Ù
, 
	`bŒfs_disk_key_objeùid
(&
disk_key
),

2743 
	`bŒfs_disk_key_ty³
(&
disk_key
),

2744 
	`bŒfs_disk_key_off£t
(&
disk_key
),

2745 
Ãw_key
->
objeùid
,‚ew_key->
ty³
,

2746 
Ãw_key
->
off£t
);

2747 
	`BUG
();

2751 
	`bŒfs_ıu_key_to_disk
(&
disk_key
, 
Ãw_key
);

2752 
	`bŒfs_£t_™em_key
(
eb
, &
disk_key
, 
¦Ù
);

2753 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
eb
);

2754 ià(
¦Ù
 == 0)

2755 
	`fixup_low_keys
(
Œªs
, 
·th
, &
disk_key
, 1);

2756 
	}
}

2778 
boŞ
 
	$check_siblšg_keys
(
ex‹Á_bufãr
 *
Ëá
,

2779 
ex‹Á_bufãr
 *
right
)

2781 
bŒfs_key
 
Ëá_Ï¡
;

2782 
bŒfs_key
 
right_fœ¡
;

2783 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
Ëá
);

2784 
Ä_Ëá
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëá
);

2785 
Ä_right
 = 
	`bŒfs_h—d”_Ä™ems
(
right
);

2788 ià(!
Ä_Ëá
 || !
Ä_right
)

2789  
çl£
;

2791 ià(
Ëv–
) {

2792 
	`bŒfs_node_key_to_ıu
(
Ëá
, &
Ëá_Ï¡
, 
Ä_Ëá
 - 1);

2793 
	`bŒfs_node_key_to_ıu
(
right
, &
right_fœ¡
, 0);

2795 
	`bŒfs_™em_key_to_ıu
(
Ëá
, &
Ëá_Ï¡
, 
Ä_Ëá
 - 1);

2796 
	`bŒfs_™em_key_to_ıu
(
right
, &
right_fœ¡
, 0);

2799 ià(
	`uÆik–y
(
	`bŒfs_comp_ıu_keys
(&
Ëá_Ï¡
, &
right_fœ¡
) >= 0)) {

2800 
	`bŒfs_ü™
(
Ëá
->
fs_šfo
, "leftƒxtent buffer:");

2801 
	`bŒfs_´št_Œ“
(
Ëá
, 
çl£
);

2802 
	`bŒfs_ü™
(
Ëá
->
fs_šfo
, "rightƒxtent buffer:");

2803 
	`bŒfs_´št_Œ“
(
right
, 
çl£
);

2804 
	`bŒfs_ü™
(
Ëá
->
fs_šfo
,

2806 
Ëá_Ï¡
.
objeùid
,†eá_Ï¡.
ty³
,

2807 
Ëá_Ï¡
.
off£t
, 
right_fœ¡
.
objeùid
,

2808 
right_fœ¡
.
ty³
,„ight_fœ¡.
off£t
);

2809  
Œue
;

2811  
çl£
;

2812 
	}
}

2821 
	$push_node_Ëá
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2822 
ex‹Á_bufãr
 *
d¡
,

2823 
ex‹Á_bufãr
 *
¤c
, 
em±y
)

2825 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2826 
push_™ems
 = 0;

2827 
¤c_Ä™ems
;

2828 
d¡_Ä™ems
;

2829 
»t
 = 0;

2831 
¤c_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
¤c
);

2832 
d¡_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
d¡
);

2833 
push_™ems
 = 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
è- 
d¡_Ä™ems
;

2834 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
¤c
è!ğ
Œªs
->
Œªsid
);

2835 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
d¡
è!ğ
Œªs
->
Œªsid
);

2837 ià(!
em±y
 && 
¤c_Ä™ems
 <= 8)

2840 ià(
push_™ems
 <= 0)

2843 ià(
em±y
) {

2844 
push_™ems
 = 
	`mš
(
¤c_Ä™ems
,…ush_items);

2845 ià(
push_™ems
 < 
¤c_Ä™ems
) {

2849 ià(
¤c_Ä™ems
 - 
push_™ems
 < 8) {

2850 ià(
push_™ems
 <= 8)

2852 
push_™ems
 -= 8;

2856 
push_™ems
 = 
	`mš
(
¤c_Ä™ems
 - 8,…ush_items);

2859 ià(
	`check_siblšg_keys
(
d¡
, 
¤c
)) {

2860 
»t
 = -
EUCLEAN
;

2861 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2862  
»t
;

2864 
»t
 = 
	`bŒfs_Œ“_mod_log_eb_cİy
(
d¡
, 
¤c
, 
d¡_Ä™ems
, 0, 
push_™ems
);

2865 ià(
»t
) {

2866 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2867  
»t
;

2869 
	`cİy_ex‹Á_bufãr
(
d¡
, 
¤c
,

2870 
	`bŒfs_node_key_±r_off£t
(
d¡
, 
d¡_Ä™ems
),

2871 
	`bŒfs_node_key_±r_off£t
(
¤c
, 0),

2872 
push_™ems
 * (
bŒfs_key_±r
));

2874 ià(
push_™ems
 < 
¤c_Ä™ems
) {

2879 
	`memmove_ex‹Á_bufãr
(
¤c
, 
	`bŒfs_node_key_±r_off£t
(src, 0),

2880 
	`bŒfs_node_key_±r_off£t
(
¤c
, 
push_™ems
),

2881 (
¤c_Ä™ems
 - 
push_™ems
) *

2882 (
bŒfs_key_±r
));

2884 
	`bŒfs_£t_h—d”_Ä™ems
(
¤c
, 
¤c_Ä™ems
 - 
push_™ems
);

2885 
	`bŒfs_£t_h—d”_Ä™ems
(
d¡
, 
d¡_Ä™ems
 + 
push_™ems
);

2886 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
¤c
);

2887 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
d¡
);

2889  
»t
;

2890 
	}
}

2901 
	$b®ªû_node_right
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2902 
ex‹Á_bufãr
 *
d¡
,

2903 
ex‹Á_bufãr
 *
¤c
)

2905 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2906 
push_™ems
 = 0;

2907 
max_push
;

2908 
¤c_Ä™ems
;

2909 
d¡_Ä™ems
;

2910 
»t
 = 0;

2912 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
¤c
è!ğ
Œªs
->
Œªsid
);

2913 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
d¡
è!ğ
Œªs
->
Œªsid
);

2915 
¤c_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
¤c
);

2916 
d¡_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
d¡
);

2917 
push_™ems
 = 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
è- 
d¡_Ä™ems
;

2918 ià(
push_™ems
 <= 0)

2921 ià(
¤c_Ä™ems
 < 4)

2924 
max_push
 = 
¤c_Ä™ems
 / 2 + 1;

2926 ià(
max_push
 >ğ
¤c_Ä™ems
)

2929 ià(
max_push
 < 
push_™ems
)

2930 
push_™ems
 = 
max_push
;

2933 ià(
	`check_siblšg_keys
(
¤c
, 
d¡
)) {

2934 
»t
 = -
EUCLEAN
;

2935 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2936  
»t
;

2943 
	`memmove_ex‹Á_bufãr
(
d¡
, 
	`bŒfs_node_key_±r_off£t
(d¡, 
push_™ems
),

2944 
	`bŒfs_node_key_±r_off£t
(
d¡
, 0),

2945 (
d¡_Ä™ems
) *

2946 (
bŒfs_key_±r
));

2948 
»t
 = 
	`bŒfs_Œ“_mod_log_eb_cİy
(
d¡
, 
¤c
, 0, 
¤c_Ä™ems
 - 
push_™ems
,

2949 
push_™ems
);

2950 ià(
»t
) {

2951 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2952  
»t
;

2954 
	`cİy_ex‹Á_bufãr
(
d¡
, 
¤c
,

2955 
	`bŒfs_node_key_±r_off£t
(
d¡
, 0),

2956 
	`bŒfs_node_key_±r_off£t
(
¤c
, 
¤c_Ä™ems
 - 
push_™ems
),

2957 
push_™ems
 * (
bŒfs_key_±r
));

2959 
	`bŒfs_£t_h—d”_Ä™ems
(
¤c
, 
¤c_Ä™ems
 - 
push_™ems
);

2960 
	`bŒfs_£t_h—d”_Ä™ems
(
d¡
, 
d¡_Ä™ems
 + 
push_™ems
);

2962 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
¤c
);

2963 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
d¡
);

2965  
»t
;

2966 
	}
}

2975 
nošlše
 
	$š£¹_Ãw_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2976 
bŒfs_roÙ
 *
roÙ
,

2977 
bŒfs_·th
 *
·th
, 
Ëv–
)

2979 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2980 
u64
 
low”_g’
;

2981 
ex‹Á_bufãr
 *
low”
;

2982 
ex‹Á_bufãr
 *
c
;

2983 
ex‹Á_bufãr
 *
Şd
;

2984 
bŒfs_disk_key
 
low”_key
;

2985 
»t
;

2987 
	`BUG_ON
(
·th
->
nodes
[
Ëv–
]);

2988 
	`BUG_ON
(
·th
->
nodes
[
Ëv–
-1] !ğ
roÙ
->
node
);

2990 
low”
 = 
·th
->
nodes
[
Ëv–
-1];

2991 ià(
Ëv–
 == 1)

2992 
	`bŒfs_™em_key
(
low”
, &
low”_key
, 0);

2994 
	`bŒfs_node_key
(
low”
, &
low”_key
, 0);

2996 
c
 = 
	`bŒfs_®loc_Œ“_block
(
Œªs
, 
roÙ
, 0,„oÙ->
roÙ_key
.
objeùid
,

2997 &
low”_key
, 
Ëv–
, 
roÙ
->
node
->
¡¬t
, 0,

2998 
BTRFS_NESTING_NEW_ROOT
);

2999 ià(
	`IS_ERR
(
c
))

3000  
	`PTR_ERR
(
c
);

3002 
	`roÙ_add_u£d
(
roÙ
, 
fs_šfo
->
nodesize
);

3004 
	`bŒfs_£t_h—d”_Ä™ems
(
c
, 1);

3005 
	`bŒfs_£t_node_key
(
c
, &
low”_key
, 0);

3006 
	`bŒfs_£t_node_block±r
(
c
, 0, 
low”
->
¡¬t
);

3007 
low”_g’
 = 
	`bŒfs_h—d”_g’”©iÚ
(
low”
);

3008 
	`WARN_ON
(
low”_g’
 !ğ
Œªs
->
Œªsid
);

3010 
	`bŒfs_£t_node_±r_g’”©iÚ
(
c
, 0, 
low”_g’
);

3012 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
c
);

3014 
Şd
 = 
roÙ
->
node
;

3015 
»t
 = 
	`bŒfs_Œ“_mod_log_š£¹_roÙ
(
roÙ
->
node
, 
c
, 
çl£
);

3016 ià(
»t
 < 0) {

3017 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
	`bŒfs_roÙ_id
(
roÙ
), 
c
, 0, 1);

3018 
	`bŒfs_Œ“_uÆock
(
c
);

3019 
	`ä“_ex‹Á_bufãr
(
c
);

3020  
»t
;

3022 
	`rcu_assign_poš‹r
(
roÙ
->
node
, 
c
);

3025 
	`ä“_ex‹Á_bufãr
(
Şd
);

3027 
	`add_roÙ_to_dœty_li¡
(
roÙ
);

3028 
	`©omic_šc
(&
c
->
»fs
);

3029 
·th
->
nodes
[
Ëv–
] = 
c
;

3030 
·th
->
locks
[
Ëv–
] = 
BTRFS_WRITE_LOCK
;

3031 
·th
->
¦Ùs
[
Ëv–
] = 0;

3033 
	}
}

3042 
	$š£¹_±r
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3043 
bŒfs_·th
 *
·th
,

3044 
bŒfs_disk_key
 *
key
, 
u64
 
by‹Ä
,

3045 
¦Ù
, 
Ëv–
)

3047 
ex‹Á_bufãr
 *
low”
;

3048 
Ä™ems
;

3049 
»t
;

3051 
	`BUG_ON
(!
·th
->
nodes
[
Ëv–
]);

3052 
	`bŒfs_as£¹_Œ“_wr™e_locked
(
·th
->
nodes
[
Ëv–
]);

3053 
low”
 = 
·th
->
nodes
[
Ëv–
];

3054 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
low”
);

3055 
	`BUG_ON
(
¦Ù
 > 
Ä™ems
);

3056 
	`BUG_ON
(
Ä™ems
 =ğ
	`BTRFS_NODEPTRS_PER_BLOCK
(
Œªs
->
fs_šfo
));

3057 ià(
¦Ù
 !ğ
Ä™ems
) {

3058 ià(
Ëv–
) {

3059 
»t
 = 
	`bŒfs_Œ“_mod_log_š£¹_move
(
low”
, 
¦Ù
 + 1,

3060 
¦Ù
, 
Ä™ems
 - slot);

3061 ià(
»t
 < 0) {

3062 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3063  
»t
;

3066 
	`memmove_ex‹Á_bufãr
(
low”
,

3067 
	`bŒfs_node_key_±r_off£t
(
low”
, 
¦Ù
 + 1),

3068 
	`bŒfs_node_key_±r_off£t
(
low”
, 
¦Ù
),

3069 (
Ä™ems
 - 
¦Ù
è* (
bŒfs_key_±r
));

3071 ià(
Ëv–
) {

3072 
»t
 = 
	`bŒfs_Œ“_mod_log_š£¹_key
(
low”
, 
¦Ù
,

3073 
BTRFS_MOD_LOG_KEY_ADD
);

3074 ià(
»t
 < 0) {

3075 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3076  
»t
;

3079 
	`bŒfs_£t_node_key
(
low”
, 
key
, 
¦Ù
);

3080 
	`bŒfs_£t_node_block±r
(
low”
, 
¦Ù
, 
by‹Ä
);

3081 
	`WARN_ON
(
Œªs
->
Œªsid
 == 0);

3082 
	`bŒfs_£t_node_±r_g’”©iÚ
(
low”
, 
¦Ù
, 
Œªs
->
Œªsid
);

3083 
	`bŒfs_£t_h—d”_Ä™ems
(
low”
, 
Ä™ems
 + 1);

3084 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
low”
);

3087 
	}
}

3098 
nošlše
 
	$¥l™_node
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3099 
bŒfs_roÙ
 *
roÙ
,

3100 
bŒfs_·th
 *
·th
, 
Ëv–
)

3102 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3103 
ex‹Á_bufãr
 *
c
;

3104 
ex‹Á_bufãr
 *
¥l™
;

3105 
bŒfs_disk_key
 
disk_key
;

3106 
mid
;

3107 
»t
;

3108 
u32
 
c_Ä™ems
;

3110 
c
 = 
·th
->
nodes
[
Ëv–
];

3111 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
c
è!ğ
Œªs
->
Œªsid
);

3112 ià(
c
 =ğ
roÙ
->
node
) {

3123 
»t
 = 
	`š£¹_Ãw_roÙ
(
Œªs
, 
roÙ
, 
·th
, 
Ëv–
 + 1);

3124 ià(
»t
)

3125  
»t
;

3127 
»t
 = 
	`push_nodes_fÜ_š£¹
(
Œªs
, 
roÙ
, 
·th
, 
Ëv–
);

3128 
c
 = 
·th
->
nodes
[
Ëv–
];

3129 ià(!
»t
 && 
	`bŒfs_h—d”_Ä™ems
(
c
) <

3130 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
) - 3)

3132 ià(
»t
 < 0)

3133  
»t
;

3136 
c_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
c
);

3137 
mid
 = (
c_Ä™ems
 + 1) / 2;

3138 
	`bŒfs_node_key
(
c
, &
disk_key
, 
mid
);

3140 
¥l™
 = 
	`bŒfs_®loc_Œ“_block
(
Œªs
, 
roÙ
, 0,„oÙ->
roÙ_key
.
objeùid
,

3141 &
disk_key
, 
Ëv–
, 
c
->
¡¬t
, 0,

3142 
BTRFS_NESTING_SPLIT
);

3143 ià(
	`IS_ERR
(
¥l™
))

3144  
	`PTR_ERR
(
¥l™
);

3146 
	`roÙ_add_u£d
(
roÙ
, 
fs_šfo
->
nodesize
);

3147 
	`ASSERT
(
	`bŒfs_h—d”_Ëv–
(
c
è=ğ
Ëv–
);

3149 
»t
 = 
	`bŒfs_Œ“_mod_log_eb_cİy
(
¥l™
, 
c
, 0, 
mid
, 
c_Ä™ems
 - mid);

3150 ià(
»t
) {

3151 
	`bŒfs_Œ“_uÆock
(
¥l™
);

3152 
	`ä“_ex‹Á_bufãr
(
¥l™
);

3153 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3154  
»t
;

3156 
	`cİy_ex‹Á_bufãr
(
¥l™
, 
c
,

3157 
	`bŒfs_node_key_±r_off£t
(
¥l™
, 0),

3158 
	`bŒfs_node_key_±r_off£t
(
c
, 
mid
),

3159 (
c_Ä™ems
 - 
mid
è* (
bŒfs_key_±r
));

3160 
	`bŒfs_£t_h—d”_Ä™ems
(
¥l™
, 
c_Ä™ems
 - 
mid
);

3161 
	`bŒfs_£t_h—d”_Ä™ems
(
c
, 
mid
);

3163 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
c
);

3164 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
¥l™
);

3166 
»t
 = 
	`š£¹_±r
(
Œªs
, 
·th
, &
disk_key
, 
¥l™
->
¡¬t
,

3167 
·th
->
¦Ùs
[
Ëv–
 + 1] + 1,†evel + 1);

3168 ià(
»t
 < 0) {

3169 
	`bŒfs_Œ“_uÆock
(
¥l™
);

3170 
	`ä“_ex‹Á_bufãr
(
¥l™
);

3171  
»t
;

3174 ià(
·th
->
¦Ùs
[
Ëv–
] >ğ
mid
) {

3175 
·th
->
¦Ùs
[
Ëv–
] -ğ
mid
;

3176 
	`bŒfs_Œ“_uÆock
(
c
);

3177 
	`ä“_ex‹Á_bufãr
(
c
);

3178 
·th
->
nodes
[
Ëv–
] = 
¥l™
;

3179 
·th
->
¦Ùs
[
Ëv–
 + 1] += 1;

3181 
	`bŒfs_Œ“_uÆock
(
¥l™
);

3182 
	`ä“_ex‹Á_bufãr
(
¥l™
);

3185 
	}
}

3192 
	$Ëaf_¥aû_u£d
(cÚ¡ 
ex‹Á_bufãr
 *
l
, 
¡¬t
, 
Ä
)

3194 
d©a_Ën
;

3195 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
l
);

3196 
’d
 = 
	`mš
(
Ä™ems
, 
¡¬t
 + 
Ä
) - 1;

3198 ià(!
Ä
)

3200 
d©a_Ën
 = 
	`bŒfs_™em_off£t
(
l
, 
¡¬t
è+ 
	`bŒfs_™em_size
(l, start);

3201 
d©a_Ën
 = d©a_ËÀ- 
	`bŒfs_™em_off£t
(
l
, 
’d
);

3202 
d©a_Ën
 +ğ(
bŒfs_™em
è* 
Ä
;

3203 
	`WARN_ON
(
d©a_Ën
 < 0);

3204  
d©a_Ën
;

3205 
	}
}

3212 
	$bŒfs_Ëaf_ä“_¥aû
(cÚ¡ 
ex‹Á_bufãr
 *
Ëaf
)

3214 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

3215 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

3216 
»t
;

3218 
»t
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
è- 
	`Ëaf_¥aû_u£d
(
Ëaf
, 0, 
Ä™ems
);

3219 ià(
»t
 < 0) {

3220 
	`bŒfs_ü™
(
fs_šfo
,

3222 
»t
,

3223 (è
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
),

3224 
	`Ëaf_¥aû_u£d
(
Ëaf
, 0, 
Ä™ems
),‚ritems);

3226  
»t
;

3227 
	}
}

3233 
nošlše
 
	$__push_Ëaf_right
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3234 
bŒfs_·th
 *
·th
,

3235 
d©a_size
, 
em±y
,

3236 
ex‹Á_bufãr
 *
right
,

3237 
ä“_¥aû
, 
u32
 
Ëá_Ä™ems
,

3238 
u32
 
mš_¦Ù
)

3240 
bŒfs_fs_šfo
 *
fs_šfo
 = 
right
->fs_info;

3241 
ex‹Á_bufãr
 *
Ëá
 = 
·th
->
nodes
[0];

3242 
ex‹Á_bufãr
 *
uµ”
 = 
·th
->
nodes
[1];

3243 
bŒfs_m­_tok’
 
tok’
;

3244 
bŒfs_disk_key
 
disk_key
;

3245 
¦Ù
;

3246 
u32
 
i
;

3247 
push_¥aû
 = 0;

3248 
push_™ems
 = 0;

3249 
u32
 
Ä
;

3250 
u32
 
right_Ä™ems
;

3251 
u32
 
d©a_’d
;

3252 
u32
 
this_™em_size
;

3254 ià(
em±y
)

3255 
Ä
 = 0;

3257 
Ä
 = 
	`max_t
(
u32
, 1, 
mš_¦Ù
);

3259 ià(
·th
->
¦Ùs
[0] >ğ
Ëá_Ä™ems
)

3260 
push_¥aû
 +ğ
d©a_size
;

3262 
¦Ù
 = 
·th
->
¦Ùs
[1];

3263 
i
 = 
Ëá_Ä™ems
 - 1;

3264 
i
 >ğ
Ä
) {

3265 ià(!
em±y
 && 
push_™ems
 > 0) {

3266 ià(
·th
->
¦Ùs
[0] > 
i
)

3268 ià(
·th
->
¦Ùs
[0] =ğ
i
) {

3269 
¥aû
 = 
	`bŒfs_Ëaf_ä“_¥aû
(
Ëá
);

3271 ià(
¥aû
 + 
push_¥aû
 * 2 > 
ä“_¥aû
)

3276 ià(
·th
->
¦Ùs
[0] =ğ
i
)

3277 
push_¥aû
 +ğ
d©a_size
;

3279 
this_™em_size
 = 
	`bŒfs_™em_size
(
Ëá
, 
i
);

3280 ià(
this_™em_size
 + (
bŒfs_™em
) +

3281 
push_¥aû
 > 
ä“_¥aû
)

3284 
push_™ems
++;

3285 
push_¥aû
 +ğ
this_™em_size
 + (
bŒfs_™em
);

3286 ià(
i
 == 0)

3288 
i
--;

3291 ià(
push_™ems
 == 0)

3292 
out_uÆock
;

3294 
	`WARN_ON
(!
em±y
 && 
push_™ems
 =ğ
Ëá_Ä™ems
);

3297 
right_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
right
);

3299 
push_¥aû
 = 
	`bŒfs_™em_d©a_’d
(
Ëá
, 
Ëá_Ä™ems
 - 
push_™ems
);

3300 
push_¥aû
 -ğ
	`Ëaf_d©a_’d
(
Ëá
);

3303 
d©a_’d
 = 
	`Ëaf_d©a_’d
(
right
);

3304 
	`memmove_Ëaf_d©a
(
right
, 
d©a_’d
 - 
push_¥aû
, data_end,

3305 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
è- 
d©a_’d
);

3308 
	`cİy_Ëaf_d©a
(
right
, 
Ëá
, 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
è- 
push_¥aû
,

3309 
	`Ëaf_d©a_’d
(
Ëá
), 
push_¥aû
);

3311 
	`memmove_Ëaf_™ems
(
right
, 
push_™ems
, 0, 
right_Ä™ems
);

3314 
	`cİy_Ëaf_™ems
(
right
, 
Ëá
, 0, 
Ëá_Ä™ems
 - 
push_™ems
,…ush_items);

3317 
	`bŒfs_š™_m­_tok’
(&
tok’
, 
right
);

3318 
right_Ä™ems
 +ğ
push_™ems
;

3319 
	`bŒfs_£t_h—d”_Ä™ems
(
right
, 
right_Ä™ems
);

3320 
push_¥aû
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
);

3321 
i
 = 0; i < 
right_Ä™ems
; i++) {

3322 
push_¥aû
 -ğ
	`bŒfs_tok’_™em_size
(&
tok’
, 
i
);

3323 
	`bŒfs_£t_tok’_™em_off£t
(&
tok’
, 
i
, 
push_¥aû
);

3326 
Ëá_Ä™ems
 -ğ
push_™ems
;

3327 
	`bŒfs_£t_h—d”_Ä™ems
(
Ëá
, 
Ëá_Ä™ems
);

3329 ià(
Ëá_Ä™ems
)

3330 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëá
);

3332 
	`bŒfs_ş—r_bufãr_dœty
(
Œªs
, 
Ëá
);

3334 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
right
);

3336 
	`bŒfs_™em_key
(
right
, &
disk_key
, 0);

3337 
	`bŒfs_£t_node_key
(
uµ”
, &
disk_key
, 
¦Ù
 + 1);

3338 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
uµ”
);

3341 ià(
·th
->
¦Ùs
[0] >ğ
Ëá_Ä™ems
) {

3342 
·th
->
¦Ùs
[0] -ğ
Ëá_Ä™ems
;

3343 ià(
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]) == 0)

3344 
	`bŒfs_ş—r_bufãr_dœty
(
Œªs
, 
·th
->
nodes
[0]);

3345 
	`bŒfs_Œ“_uÆock
(
·th
->
nodes
[0]);

3346 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[0]);

3347 
·th
->
nodes
[0] = 
right
;

3348 
·th
->
¦Ùs
[1] += 1;

3350 
	`bŒfs_Œ“_uÆock
(
right
);

3351 
	`ä“_ex‹Á_bufãr
(
right
);

3355 
out_uÆock
:

3356 
	`bŒfs_Œ“_uÆock
(
right
);

3357 
	`ä“_ex‹Á_bufãr
(
right
);

3359 
	}
}

3371 
	$push_Ëaf_right
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ


3372 *
roÙ
, 
bŒfs_·th
 *
·th
,

3373 
mš_d©a_size
, 
d©a_size
,

3374 
em±y
, 
u32
 
mš_¦Ù
)

3376 
ex‹Á_bufãr
 *
Ëá
 = 
·th
->
nodes
[0];

3377 
ex‹Á_bufãr
 *
right
;

3378 
ex‹Á_bufãr
 *
uµ”
;

3379 
¦Ù
;

3380 
ä“_¥aû
;

3381 
u32
 
Ëá_Ä™ems
;

3382 
»t
;

3384 ià(!
·th
->
nodes
[1])

3387 
¦Ù
 = 
·th
->
¦Ùs
[1];

3388 
uµ”
 = 
·th
->
nodes
[1];

3389 ià(
¦Ù
 >ğ
	`bŒfs_h—d”_Ä™ems
(
uµ”
) - 1)

3392 
	`bŒfs_as£¹_Œ“_wr™e_locked
(
·th
->
nodes
[1]);

3394 
right
 = 
	`bŒfs_»ad_node_¦Ù
(
uµ”
, 
¦Ù
 + 1);

3395 ià(
	`IS_ERR
(
right
))

3396  
	`PTR_ERR
(
right
);

3398 
	`__bŒfs_Œ“_lock
(
right
, 
BTRFS_NESTING_RIGHT
);

3400 
ä“_¥aû
 = 
	`bŒfs_Ëaf_ä“_¥aû
(
right
);

3401 ià(
ä“_¥aû
 < 
d©a_size
)

3402 
out_uÆock
;

3404 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
right
, 
uµ”
,

3405 
¦Ù
 + 1, &
right
, 
BTRFS_NESTING_RIGHT_COW
);

3406 ià(
»t
)

3407 
out_uÆock
;

3409 
Ëá_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëá
);

3410 ià(
Ëá_Ä™ems
 == 0)

3411 
out_uÆock
;

3413 ià(
	`check_siblšg_keys
(
Ëá
, 
right
)) {

3414 
»t
 = -
EUCLEAN
;

3415 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3416 
	`bŒfs_Œ“_uÆock
(
right
);

3417 
	`ä“_ex‹Á_bufãr
(
right
);

3418  
»t
;

3420 ià(
·th
->
¦Ùs
[0] =ğ
Ëá_Ä™ems
 && !
em±y
) {

3425 
	`bŒfs_Œ“_uÆock
(
Ëá
);

3426 
	`ä“_ex‹Á_bufãr
(
Ëá
);

3427 
·th
->
nodes
[0] = 
right
;

3428 
·th
->
¦Ùs
[0] = 0;

3429 
·th
->
¦Ùs
[1]++;

3433  
	`__push_Ëaf_right
(
Œªs
, 
·th
, 
mš_d©a_size
, 
em±y
, 
right
,

3434 
ä“_¥aû
, 
Ëá_Ä™ems
, 
mš_¦Ù
);

3435 
out_uÆock
:

3436 
	`bŒfs_Œ“_uÆock
(
right
);

3437 
	`ä“_ex‹Á_bufãr
(
right
);

3439 
	}
}

3449 
nošlše
 
	$__push_Ëaf_Ëá
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3450 
bŒfs_·th
 *
·th
, 
d©a_size
,

3451 
em±y
, 
ex‹Á_bufãr
 *
Ëá
,

3452 
ä“_¥aû
, 
u32
 
right_Ä™ems
,

3453 
u32
 
max_¦Ù
)

3455 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëá
->fs_info;

3456 
bŒfs_disk_key
 
disk_key
;

3457 
ex‹Á_bufãr
 *
right
 = 
·th
->
nodes
[0];

3458 
i
;

3459 
push_¥aû
 = 0;

3460 
push_™ems
 = 0;

3461 
u32
 
Şd_Ëá_Ä™ems
;

3462 
u32
 
Ä
;

3463 
»t
 = 0;

3464 
u32
 
this_™em_size
;

3465 
u32
 
Şd_Ëá_™em_size
;

3466 
bŒfs_m­_tok’
 
tok’
;

3468 ià(
em±y
)

3469 
Ä
 = 
	`mš
(
right_Ä™ems
, 
max_¦Ù
);

3471 
Ä
 = 
	`mš
(
right_Ä™ems
 - 1, 
max_¦Ù
);

3473 
i
 = 0; i < 
Ä
; i++) {

3474 ià(!
em±y
 && 
push_™ems
 > 0) {

3475 ià(
·th
->
¦Ùs
[0] < 
i
)

3477 ià(
·th
->
¦Ùs
[0] =ğ
i
) {

3478 
¥aû
 = 
	`bŒfs_Ëaf_ä“_¥aû
(
right
);

3480 ià(
¥aû
 + 
push_¥aû
 * 2 > 
ä“_¥aû
)

3485 ià(
·th
->
¦Ùs
[0] =ğ
i
)

3486 
push_¥aû
 +ğ
d©a_size
;

3488 
this_™em_size
 = 
	`bŒfs_™em_size
(
right
, 
i
);

3489 ià(
this_™em_size
 + (
bŒfs_™em
è+ 
push_¥aû
 >

3490 
ä“_¥aû
)

3493 
push_™ems
++;

3494 
push_¥aû
 +ğ
this_™em_size
 + (
bŒfs_™em
);

3497 ià(
push_™ems
 == 0) {

3498 
»t
 = 1;

3499 
out
;

3501 
	`WARN_ON
(!
em±y
 && 
push_™ems
 =ğ
	`bŒfs_h—d”_Ä™ems
(
right
));

3504 
	`cİy_Ëaf_™ems
(
Ëá
, 
right
, 
	`bŒfs_h—d”_Ä™ems
Öeá), 0, 
push_™ems
);

3506 
push_¥aû
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
) -

3507 
	`bŒfs_™em_off£t
(
right
, 
push_™ems
 - 1);

3509 
	`cİy_Ëaf_d©a
(
Ëá
, 
right
, 
	`Ëaf_d©a_’d
Öeáè- 
push_¥aû
,

3510 
	`bŒfs_™em_off£t
(
right
, 
push_™ems
 - 1), 
push_¥aû
);

3511 
Şd_Ëá_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëá
);

3512 
	`BUG_ON
(
Şd_Ëá_Ä™ems
 <= 0);

3514 
	`bŒfs_š™_m­_tok’
(&
tok’
, 
Ëá
);

3515 
Şd_Ëá_™em_size
 = 
	`bŒfs_™em_off£t
(
Ëá
, 
Şd_Ëá_Ä™ems
 - 1);

3516 
i
 = 
Şd_Ëá_Ä™ems
; i < old_Ëá_Ä™em + 
push_™ems
; i++) {

3517 
u32
 
ioff
;

3519 
ioff
 = 
	`bŒfs_tok’_™em_off£t
(&
tok’
, 
i
);

3520 
	`bŒfs_£t_tok’_™em_off£t
(&
tok’
, 
i
,

3521 
ioff
 - (
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
è- 
Şd_Ëá_™em_size
));

3523 
	`bŒfs_£t_h—d”_Ä™ems
(
Ëá
, 
Şd_Ëá_Ä™ems
 + 
push_™ems
);

3526 ià(
push_™ems
 > 
right_Ä™ems
)

3527 
	`WARN
(1, 
KERN_CRIT
 "push i‹m %d‚¸%u\n", 
push_™ems
,

3528 
right_Ä™ems
);

3530 ià(
push_™ems
 < 
right_Ä™ems
) {

3531 
push_¥aû
 = 
	`bŒfs_™em_off£t
(
right
, 
push_™ems
 - 1) -

3532 
	`Ëaf_d©a_’d
(
right
);

3533 
	`memmove_Ëaf_d©a
(
right
,

3534 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
è- 
push_¥aû
,

3535 
	`Ëaf_d©a_’d
(
right
), 
push_¥aû
);

3537 
	`memmove_Ëaf_™ems
(
right
, 0, 
push_™ems
,

3538 
	`bŒfs_h—d”_Ä™ems
(
right
è- 
push_™ems
);

3541 
	`bŒfs_š™_m­_tok’
(&
tok’
, 
right
);

3542 
right_Ä™ems
 -ğ
push_™ems
;

3543 
	`bŒfs_£t_h—d”_Ä™ems
(
right
, 
right_Ä™ems
);

3544 
push_¥aû
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
);

3545 
i
 = 0; i < 
right_Ä™ems
; i++) {

3546 
push_¥aû
 =…ush_¥aû - 
	`bŒfs_tok’_™em_size
(&
tok’
, 
i
);

3547 
	`bŒfs_£t_tok’_™em_off£t
(&
tok’
, 
i
, 
push_¥aû
);

3550 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëá
);

3551 ià(
right_Ä™ems
)

3552 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
right
);

3554 
	`bŒfs_ş—r_bufãr_dœty
(
Œªs
, 
right
);

3556 
	`bŒfs_™em_key
(
right
, &
disk_key
, 0);

3557 
	`fixup_low_keys
(
Œªs
, 
·th
, &
disk_key
, 1);

3560 ià(
·th
->
¦Ùs
[0] < 
push_™ems
) {

3561 
·th
->
¦Ùs
[0] +ğ
Şd_Ëá_Ä™ems
;

3562 
	`bŒfs_Œ“_uÆock
(
·th
->
nodes
[0]);

3563 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[0]);

3564 
·th
->
nodes
[0] = 
Ëá
;

3565 
·th
->
¦Ùs
[1] -= 1;

3567 
	`bŒfs_Œ“_uÆock
(
Ëá
);

3568 
	`ä“_ex‹Á_bufãr
(
Ëá
);

3569 
·th
->
¦Ùs
[0] -ğ
push_™ems
;

3571 
	`BUG_ON
(
·th
->
¦Ùs
[0] < 0);

3572  
»t
;

3573 
out
:

3574 
	`bŒfs_Œ“_uÆock
(
Ëá
);

3575 
	`ä“_ex‹Á_bufãr
(
Ëá
);

3576  
»t
;

3577 
	}
}

3587 
	$push_Ëaf_Ëá
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ


3588 *
roÙ
, 
bŒfs_·th
 *
·th
, 
mš_d©a_size
,

3589 
d©a_size
, 
em±y
, 
u32
 
max_¦Ù
)

3591 
ex‹Á_bufãr
 *
right
 = 
·th
->
nodes
[0];

3592 
ex‹Á_bufãr
 *
Ëá
;

3593 
¦Ù
;

3594 
ä“_¥aû
;

3595 
u32
 
right_Ä™ems
;

3596 
»t
 = 0;

3598 
¦Ù
 = 
·th
->
¦Ùs
[1];

3599 ià(
¦Ù
 == 0)

3601 ià(!
·th
->
nodes
[1])

3604 
right_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
right
);

3605 ià(
right_Ä™ems
 == 0)

3608 
	`bŒfs_as£¹_Œ“_wr™e_locked
(
·th
->
nodes
[1]);

3610 
Ëá
 = 
	`bŒfs_»ad_node_¦Ù
(
·th
->
nodes
[1], 
¦Ù
 - 1);

3611 ià(
	`IS_ERR
(
Ëá
))

3612  
	`PTR_ERR
(
Ëá
);

3614 
	`__bŒfs_Œ“_lock
(
Ëá
, 
BTRFS_NESTING_LEFT
);

3616 
ä“_¥aû
 = 
	`bŒfs_Ëaf_ä“_¥aû
(
Ëá
);

3617 ià(
ä“_¥aû
 < 
d©a_size
) {

3618 
»t
 = 1;

3619 
out
;

3622 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
Ëá
,

3623 
·th
->
nodes
[1], 
¦Ù
 - 1, &
Ëá
,

3624 
BTRFS_NESTING_LEFT_COW
);

3625 ià(
»t
) {

3627 ià(
»t
 =ğ-
ENOSPC
)

3628 
»t
 = 1;

3629 
out
;

3632 ià(
	`check_siblšg_keys
(
Ëá
, 
right
)) {

3633 
»t
 = -
EUCLEAN
;

3634 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3635 
out
;

3637  
	`__push_Ëaf_Ëá
(
Œªs
, 
·th
, 
mš_d©a_size
, 
em±y
, 
Ëá
,

3638 
ä“_¥aû
, 
right_Ä™ems
, 
max_¦Ù
);

3639 
out
:

3640 
	`bŒfs_Œ“_uÆock
(
Ëá
);

3641 
	`ä“_ex‹Á_bufãr
(
Ëá
);

3642  
»t
;

3643 
	}
}

3649 
nošlše
 
	$cİy_fÜ_¥l™
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3650 
bŒfs_·th
 *
·th
,

3651 
ex‹Á_bufãr
 *
l
,

3652 
ex‹Á_bufãr
 *
right
,

3653 
¦Ù
, 
mid
, 
Ä™ems
)

3655 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

3656 
d©a_cİy_size
;

3657 
¹_d©a_off
;

3658 
i
;

3659 
»t
;

3660 
bŒfs_disk_key
 
disk_key
;

3661 
bŒfs_m­_tok’
 
tok’
;

3663 
Ä™ems
 =‚r™em - 
mid
;

3664 
	`bŒfs_£t_h—d”_Ä™ems
(
right
, 
Ä™ems
);

3665 
d©a_cİy_size
 = 
	`bŒfs_™em_d©a_’d
(
l
, 
mid
è- 
	`Ëaf_d©a_’d
(l);

3667 
	`cİy_Ëaf_™ems
(
right
, 
l
, 0, 
mid
, 
Ä™ems
);

3669 
	`cİy_Ëaf_d©a
(
right
, 
l
, 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
è- 
d©a_cİy_size
,

3670 
	`Ëaf_d©a_’d
(
l
), 
d©a_cİy_size
);

3672 
¹_d©a_off
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
è- 
	`bŒfs_™em_d©a_’d
(
l
, 
mid
);

3674 
	`bŒfs_š™_m­_tok’
(&
tok’
, 
right
);

3675 
i
 = 0; i < 
Ä™ems
; i++) {

3676 
u32
 
ioff
;

3678 
ioff
 = 
	`bŒfs_tok’_™em_off£t
(&
tok’
, 
i
);

3679 
	`bŒfs_£t_tok’_™em_off£t
(&
tok’
, 
i
, 
ioff
 + 
¹_d©a_off
);

3682 
	`bŒfs_£t_h—d”_Ä™ems
(
l
, 
mid
);

3683 
	`bŒfs_™em_key
(
right
, &
disk_key
, 0);

3684 
»t
 = 
	`š£¹_±r
(
Œªs
, 
·th
, &
disk_key
, 
right
->
¡¬t
,…©h->
¦Ùs
[1] + 1, 1);

3685 ià(
»t
 < 0)

3686  
»t
;

3688 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
right
);

3689 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
l
);

3690 
	`BUG_ON
(
·th
->
¦Ùs
[0] !ğ
¦Ù
);

3692 ià(
mid
 <ğ
¦Ù
) {

3693 
	`bŒfs_Œ“_uÆock
(
·th
->
nodes
[0]);

3694 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[0]);

3695 
·th
->
nodes
[0] = 
right
;

3696 
·th
->
¦Ùs
[0] -ğ
mid
;

3697 
·th
->
¦Ùs
[1] += 1;

3699 
	`bŒfs_Œ“_uÆock
(
right
);

3700 
	`ä“_ex‹Á_bufãr
(
right
);

3703 
	`BUG_ON
(
·th
->
¦Ùs
[0] < 0);

3706 
	}
}

3718 
nošlše
 
	$push_fÜ_doubË_¥l™
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3719 
bŒfs_roÙ
 *
roÙ
,

3720 
bŒfs_·th
 *
·th
,

3721 
d©a_size
)

3723 
»t
;

3724 
´og»ss
 = 0;

3725 
¦Ù
;

3726 
u32
 
Ä™ems
;

3727 
¥aû_Ãeded
 = 
d©a_size
;

3729 
¦Ù
 = 
·th
->
¦Ùs
[0];

3730 ià(
¦Ù
 < 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]))

3731 
¥aû_Ãeded
 -ğ
	`bŒfs_Ëaf_ä“_¥aû
(
·th
->
nodes
[0]);

3737 
»t
 = 
	`push_Ëaf_right
(
Œªs
, 
roÙ
, 
·th
, 1, 
¥aû_Ãeded
, 0, 
¦Ù
);

3738 ià(
»t
 < 0)

3739  
»t
;

3741 ià(
»t
 == 0)

3742 
´og»ss
++;

3744 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

3749 ià(
·th
->
¦Ùs
[0] =ğ0 ||…©h->¦Ùs[0] =ğ
Ä™ems
)

3752 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
·th
->
nodes
[0]è>ğ
d©a_size
)

3756 
¦Ù
 = 
·th
->
¦Ùs
[0];

3757 
¥aû_Ãeded
 = 
d©a_size
;

3758 ià(
¦Ù
 > 0)

3759 
¥aû_Ãeded
 -ğ
	`bŒfs_Ëaf_ä“_¥aû
(
·th
->
nodes
[0]);

3760 
»t
 = 
	`push_Ëaf_Ëá
(
Œªs
, 
roÙ
, 
·th
, 1, 
¥aû_Ãeded
, 0, 
¦Ù
);

3761 ià(
»t
 < 0)

3762  
»t
;

3764 ià(
»t
 == 0)

3765 
´og»ss
++;

3767 ià(
´og»ss
)

3770 
	}
}

3778 
nošlše
 
	$¥l™_Ëaf
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3779 
bŒfs_roÙ
 *
roÙ
,

3780 cÚ¡ 
bŒfs_key
 *
šs_key
,

3781 
bŒfs_·th
 *
·th
, 
d©a_size
,

3782 
ex‹nd
)

3784 
bŒfs_disk_key
 
disk_key
;

3785 
ex‹Á_bufãr
 *
l
;

3786 
u32
 
Ä™ems
;

3787 
mid
;

3788 
¦Ù
;

3789 
ex‹Á_bufãr
 *
right
;

3790 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3791 
»t
 = 0;

3792 
w»t
;

3793 
¥l™
;

3794 
num_doubËs
 = 0;

3795 
Œ›d_avoid_doubË
 = 0;

3797 
l
 = 
·th
->
nodes
[0];

3798 
¦Ù
 = 
·th
->
¦Ùs
[0];

3799 ià(
ex‹nd
 && 
d©a_size
 + 
	`bŒfs_™em_size
(
l
, 
¦Ù
) +

3800 (
bŒfs_™em
è> 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
))

3801  -
EOVERFLOW
;

3804 ià(
d©a_size
 && 
·th
->
nodes
[1]) {

3805 
¥aû_Ãeded
 = 
d©a_size
;

3807 ià(
¦Ù
 < 
	`bŒfs_h—d”_Ä™ems
(
l
))

3808 
¥aû_Ãeded
 -ğ
	`bŒfs_Ëaf_ä“_¥aû
(
l
);

3810 
w»t
 = 
	`push_Ëaf_right
(
Œªs
, 
roÙ
, 
·th
, 
¥aû_Ãeded
,

3811 
¥aû_Ãeded
, 0, 0);

3812 ià(
w»t
 < 0)

3813  
w»t
;

3814 ià(
w»t
) {

3815 
¥aû_Ãeded
 = 
d©a_size
;

3816 ià(
¦Ù
 > 0)

3817 
¥aû_Ãeded
 -ğ
	`bŒfs_Ëaf_ä“_¥aû
(
l
);

3818 
w»t
 = 
	`push_Ëaf_Ëá
(
Œªs
, 
roÙ
, 
·th
, 
¥aû_Ãeded
,

3819 
¥aû_Ãeded
, 0, (
u32
)-1);

3820 ià(
w»t
 < 0)

3821  
w»t
;

3823 
l
 = 
·th
->
nodes
[0];

3826 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
l
è>ğ
d©a_size
)

3830 ià(!
·th
->
nodes
[1]) {

3831 
»t
 = 
	`š£¹_Ãw_roÙ
(
Œªs
, 
roÙ
, 
·th
, 1);

3832 ià(
»t
)

3833  
»t
;

3835 
agaš
:

3836 
¥l™
 = 1;

3837 
l
 = 
·th
->
nodes
[0];

3838 
¦Ù
 = 
·th
->
¦Ùs
[0];

3839 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
l
);

3840 
mid
 = (
Ä™ems
 + 1) / 2;

3842 ià(
mid
 <ğ
¦Ù
) {

3843 ià(
Ä™ems
 == 1 ||

3844 
	`Ëaf_¥aû_u£d
(
l
, 
mid
, 
Ä™ems
 - midè+ 
d©a_size
 >

3845 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
)) {

3846 ià(
¦Ù
 >ğ
Ä™ems
) {

3847 
¥l™
 = 0;

3849 
mid
 = 
¦Ù
;

3850 ià(
mid
 !ğ
Ä™ems
 &&

3851 
	`Ëaf_¥aû_u£d
(
l
, 
mid
, 
Ä™ems
 - mid) +

3852 
d©a_size
 > 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
)) {

3853 ià(
d©a_size
 && !
Œ›d_avoid_doubË
)

3854 
push_fÜ_doubË
;

3855 
¥l™
 = 2;

3860 ià(
	`Ëaf_¥aû_u£d
(
l
, 0, 
mid
è+ 
d©a_size
 >

3861 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
)) {

3862 ià(!
ex‹nd
 && 
d©a_size
 && 
¦Ù
 == 0) {

3863 
¥l™
 = 0;

3864 } ià((
ex‹nd
 || !
d©a_size
è&& 
¦Ù
 == 0) {

3865 
mid
 = 1;

3867 
mid
 = 
¦Ù
;

3868 ià(
mid
 !ğ
Ä™ems
 &&

3869 
	`Ëaf_¥aû_u£d
(
l
, 
mid
, 
Ä™ems
 - mid) +

3870 
d©a_size
 > 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
)) {

3871 ià(
d©a_size
 && !
Œ›d_avoid_doubË
)

3872 
push_fÜ_doubË
;

3873 
¥l™
 = 2;

3879 ià(
¥l™
 == 0)

3880 
	`bŒfs_ıu_key_to_disk
(&
disk_key
, 
šs_key
);

3882 
	`bŒfs_™em_key
(
l
, &
disk_key
, 
mid
);

3892 
right
 = 
	`bŒfs_®loc_Œ“_block
(
Œªs
, 
roÙ
, 0,„oÙ->
roÙ_key
.
objeùid
,

3893 &
disk_key
, 0, 
l
->
¡¬t
, 0,

3894 
num_doubËs
 ? 
BTRFS_NESTING_NEW_ROOT
 :

3895 
BTRFS_NESTING_SPLIT
);

3896 ià(
	`IS_ERR
(
right
))

3897  
	`PTR_ERR
(
right
);

3899 
	`roÙ_add_u£d
(
roÙ
, 
fs_šfo
->
nodesize
);

3901 ià(
¥l™
 == 0) {

3902 ià(
mid
 <ğ
¦Ù
) {

3903 
	`bŒfs_£t_h—d”_Ä™ems
(
right
, 0);

3904 
»t
 = 
	`š£¹_±r
(
Œªs
, 
·th
, &
disk_key
,

3905 
right
->
¡¬t
, 
·th
->
¦Ùs
[1] + 1, 1);

3906 ià(
»t
 < 0) {

3907 
	`bŒfs_Œ“_uÆock
(
right
);

3908 
	`ä“_ex‹Á_bufãr
(
right
);

3909  
»t
;

3911 
	`bŒfs_Œ“_uÆock
(
·th
->
nodes
[0]);

3912 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[0]);

3913 
·th
->
nodes
[0] = 
right
;

3914 
·th
->
¦Ùs
[0] = 0;

3915 
·th
->
¦Ùs
[1] += 1;

3917 
	`bŒfs_£t_h—d”_Ä™ems
(
right
, 0);

3918 
»t
 = 
	`š£¹_±r
(
Œªs
, 
·th
, &
disk_key
,

3919 
right
->
¡¬t
, 
·th
->
¦Ùs
[1], 1);

3920 ià(
»t
 < 0) {

3921 
	`bŒfs_Œ“_uÆock
(
right
);

3922 
	`ä“_ex‹Á_bufãr
(
right
);

3923  
»t
;

3925 
	`bŒfs_Œ“_uÆock
(
·th
->
nodes
[0]);

3926 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[0]);

3927 
·th
->
nodes
[0] = 
right
;

3928 
·th
->
¦Ùs
[0] = 0;

3929 ià(
·th
->
¦Ùs
[1] == 0)

3930 
	`fixup_low_keys
(
Œªs
, 
·th
, &
disk_key
, 1);

3937  
»t
;

3940 
»t
 = 
	`cİy_fÜ_¥l™
(
Œªs
, 
·th
, 
l
, 
right
, 
¦Ù
, 
mid
, 
Ä™ems
);

3941 ià(
»t
 < 0) {

3942 
	`bŒfs_Œ“_uÆock
(
right
);

3943 
	`ä“_ex‹Á_bufãr
(
right
);

3944  
»t
;

3947 ià(
¥l™
 == 2) {

3948 
	`BUG_ON
(
num_doubËs
 != 0);

3949 
num_doubËs
++;

3950 
agaš
;

3955 
push_fÜ_doubË
:

3956 
	`push_fÜ_doubË_¥l™
(
Œªs
, 
roÙ
, 
·th
, 
d©a_size
);

3957 
Œ›d_avoid_doubË
 = 1;

3958 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
·th
->
nodes
[0]è>ğ
d©a_size
)

3960 
agaš
;

3961 
	}
}

3963 
nošlše
 
	$£tup_Ëaf_fÜ_¥l™
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3964 
bŒfs_roÙ
 *
roÙ
,

3965 
bŒfs_·th
 *
·th
, 
šs_Ën
)

3967 
bŒfs_key
 
key
;

3968 
ex‹Á_bufãr
 *
Ëaf
;

3969 
bŒfs_fe_ex‹Á_™em
 *
fi
;

3970 
u64
 
ex‹Á_Ën
 = 0;

3971 
u32
 
™em_size
;

3972 
»t
;

3974 
Ëaf
 = 
·th
->
nodes
[0];

3975 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

3977 
	`BUG_ON
(
key
.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
 &&

3978 
key
.
ty³
 !ğ
BTRFS_EXTENT_CSUM_KEY
);

3980 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
Ëaf
è>ğ
šs_Ën
)

3983 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

3984 ià(
key
.
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
) {

3985 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

3986 
bŒfs_fe_ex‹Á_™em
);

3987 
ex‹Á_Ën
 = 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

3989 
	`bŒfs_»Ëa£_·th
(
·th
);

3991 
·th
->
k“p_locks
 = 1;

3992 
·th
->
£¬ch_fÜ_¥l™
 = 1;

3993 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

3994 
·th
->
£¬ch_fÜ_¥l™
 = 0;

3995 ià(
»t
 > 0)

3996 
»t
 = -
EAGAIN
;

3997 ià(
»t
 < 0)

3998 
”r
;

4000 
»t
 = -
EAGAIN
;

4001 
Ëaf
 = 
·th
->
nodes
[0];

4003 ià(
™em_size
 !ğ
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]))

4004 
”r
;

4007 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
·th
->
nodes
[0]è>ğ
šs_Ën
)

4008 
”r
;

4010 ià(
key
.
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
) {

4011 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

4012 
bŒfs_fe_ex‹Á_™em
);

4013 ià(
ex‹Á_Ën
 !ğ
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
))

4014 
”r
;

4017 
»t
 = 
	`¥l™_Ëaf
(
Œªs
, 
roÙ
, &
key
, 
·th
, 
šs_Ën
, 1);

4018 ià(
»t
)

4019 
”r
;

4021 
·th
->
k“p_locks
 = 0;

4022 
	`bŒfs_uÆock_up_§ã
(
·th
, 1);

4024 
”r
:

4025 
·th
->
k“p_locks
 = 0;

4026  
»t
;

4027 
	}
}

4029 
nošlše
 
	$¥l™_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4030 
bŒfs_·th
 *
·th
,

4031 cÚ¡ 
bŒfs_key
 *
Ãw_key
,

4032 
¥l™_off£t
)

4034 
ex‹Á_bufãr
 *
Ëaf
;

4035 
Üig_¦Ù
, 
¦Ù
;

4036 *
buf
;

4037 
u32
 
Ä™ems
;

4038 
u32
 
™em_size
;

4039 
u32
 
Üig_off£t
;

4040 
bŒfs_disk_key
 
disk_key
;

4042 
Ëaf
 = 
·th
->
nodes
[0];

4047 ià(
	`WARN_ON
(
	`bŒfs_Ëaf_ä“_¥aû
(
Ëaf
è< (
bŒfs_™em
)))

4048  -
ENOSPC
;

4050 
Üig_¦Ù
 = 
·th
->
¦Ùs
[0];

4051 
Üig_off£t
 = 
	`bŒfs_™em_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

4052 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

4054 
buf
 = 
	`km®loc
(
™em_size
, 
GFP_NOFS
);

4055 ià(!
buf
)

4056  -
ENOMEM
;

4058 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
buf
, 
	`bŒfs_™em_±r_off£t
(leaf,

4059 
·th
->
¦Ùs
[0]), 
™em_size
);

4061 
¦Ù
 = 
·th
->
¦Ùs
[0] + 1;

4062 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

4063 ià(
¦Ù
 !ğ
Ä™ems
) {

4065 
	`memmove_Ëaf_™ems
(
Ëaf
, 
¦Ù
 + 1, slÙ, 
Ä™ems
 - slot);

4068 
	`bŒfs_ıu_key_to_disk
(&
disk_key
, 
Ãw_key
);

4069 
	`bŒfs_£t_™em_key
(
Ëaf
, &
disk_key
, 
¦Ù
);

4071 
	`bŒfs_£t_™em_off£t
(
Ëaf
, 
¦Ù
, 
Üig_off£t
);

4072 
	`bŒfs_£t_™em_size
(
Ëaf
, 
¦Ù
, 
™em_size
 - 
¥l™_off£t
);

4074 
	`bŒfs_£t_™em_off£t
(
Ëaf
, 
Üig_¦Ù
,

4075 
Üig_off£t
 + 
™em_size
 - 
¥l™_off£t
);

4076 
	`bŒfs_£t_™em_size
(
Ëaf
, 
Üig_¦Ù
, 
¥l™_off£t
);

4078 
	`bŒfs_£t_h—d”_Ä™ems
(
Ëaf
, 
Ä™ems
 + 1);

4081 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
buf
,

4082 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]),

4083 
¥l™_off£t
);

4086 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
buf
 + 
¥l™_off£t
,

4087 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
),

4088 
™em_size
 - 
¥l™_off£t
);

4089 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

4091 
	`BUG_ON
(
	`bŒfs_Ëaf_ä“_¥aû
(
Ëaf
) < 0);

4092 
	`kä“
(
buf
);

4094 
	}
}

4111 
	$bŒfs_¥l™_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4112 
bŒfs_roÙ
 *
roÙ
,

4113 
bŒfs_·th
 *
·th
,

4114 cÚ¡ 
bŒfs_key
 *
Ãw_key
,

4115 
¥l™_off£t
)

4117 
»t
;

4118 
»t
 = 
	`£tup_Ëaf_fÜ_¥l™
(
Œªs
, 
roÙ
, 
·th
,

4119 (
bŒfs_™em
));

4120 ià(
»t
)

4121  
»t
;

4123 
»t
 = 
	`¥l™_™em
(
Œªs
, 
·th
, 
Ãw_key
, 
¥l™_off£t
);

4124  
»t
;

4125 
	}
}

4133 
	$bŒfs_Œunÿ‹_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4134 
bŒfs_·th
 *
·th
, 
u32
 
Ãw_size
, 
äom_’d
)

4136 
¦Ù
;

4137 
ex‹Á_bufãr
 *
Ëaf
;

4138 
u32
 
Ä™ems
;

4139 
d©a_’d
;

4140 
Şd_d©a_¡¬t
;

4141 
Şd_size
;

4142 
size_diff
;

4143 
i
;

4144 
bŒfs_m­_tok’
 
tok’
;

4146 
Ëaf
 = 
·th
->
nodes
[0];

4147 
¦Ù
 = 
·th
->
¦Ùs
[0];

4149 
Şd_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

4150 ià(
Şd_size
 =ğ
Ãw_size
)

4153 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

4154 
d©a_’d
 = 
	`Ëaf_d©a_’d
(
Ëaf
);

4156 
Şd_d©a_¡¬t
 = 
	`bŒfs_™em_off£t
(
Ëaf
, 
¦Ù
);

4158 
size_diff
 = 
Şd_size
 - 
Ãw_size
;

4160 
	`BUG_ON
(
¦Ù
 < 0);

4161 
	`BUG_ON
(
¦Ù
 >ğ
Ä™ems
);

4167 
	`bŒfs_š™_m­_tok’
(&
tok’
, 
Ëaf
);

4168 
i
 = 
¦Ù
; i < 
Ä™ems
; i++) {

4169 
u32
 
ioff
;

4171 
ioff
 = 
	`bŒfs_tok’_™em_off£t
(&
tok’
, 
i
);

4172 
	`bŒfs_£t_tok’_™em_off£t
(&
tok’
, 
i
, 
ioff
 + 
size_diff
);

4176 ià(
äom_’d
) {

4177 
	`memmove_Ëaf_d©a
(
Ëaf
, 
d©a_’d
 + 
size_diff
, data_end,

4178 
Şd_d©a_¡¬t
 + 
Ãw_size
 - 
d©a_’d
);

4180 
bŒfs_disk_key
 
disk_key
;

4181 
u64
 
off£t
;

4183 
	`bŒfs_™em_key
(
Ëaf
, &
disk_key
, 
¦Ù
);

4185 ià(
	`bŒfs_disk_key_ty³
(&
disk_key
è=ğ
BTRFS_EXTENT_DATA_KEY
) {

4186 
±r
;

4187 
bŒfs_fe_ex‹Á_™em
 *
fi
;

4189 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
,

4190 
bŒfs_fe_ex‹Á_™em
);

4191 
fi
 = (
bŒfs_fe_ex‹Á_™em
 *)(

4192 ()
fi
 - 
size_diff
);

4194 ià(
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
fi
) ==

4195 
BTRFS_FILE_EXTENT_INLINE
) {

4196 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
);

4197 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
±r
,

4198 ()
fi
,

4199 
BTRFS_FILE_EXTENT_INLINE_DATA_START
);

4203 
	`memmove_Ëaf_d©a
(
Ëaf
, 
d©a_’d
 + 
size_diff
, data_end,

4204 
Şd_d©a_¡¬t
 - 
d©a_’d
);

4206 
off£t
 = 
	`bŒfs_disk_key_off£t
(&
disk_key
);

4207 
	`bŒfs_£t_disk_key_off£t
(&
disk_key
, 
off£t
 + 
size_diff
);

4208 
	`bŒfs_£t_™em_key
(
Ëaf
, &
disk_key
, 
¦Ù
);

4209 ià(
¦Ù
 == 0)

4210 
	`fixup_low_keys
(
Œªs
, 
·th
, &
disk_key
, 1);

4213 
	`bŒfs_£t_™em_size
(
Ëaf
, 
¦Ù
, 
Ãw_size
);

4214 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

4216 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
Ëaf
) < 0) {

4217 
	`bŒfs_´št_Ëaf
(
Ëaf
);

4218 
	`BUG
();

4220 
	}
}

4225 
	$bŒfs_ex‹nd_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4226 
bŒfs_·th
 *
·th
, 
u32
 
d©a_size
)

4228 
¦Ù
;

4229 
ex‹Á_bufãr
 *
Ëaf
;

4230 
u32
 
Ä™ems
;

4231 
d©a_’d
;

4232 
Şd_d©a
;

4233 
Şd_size
;

4234 
i
;

4235 
bŒfs_m­_tok’
 
tok’
;

4237 
Ëaf
 = 
·th
->
nodes
[0];

4239 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

4240 
d©a_’d
 = 
	`Ëaf_d©a_’d
(
Ëaf
);

4242 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
Ëaf
è< 
d©a_size
) {

4243 
	`bŒfs_´št_Ëaf
(
Ëaf
);

4244 
	`BUG
();

4246 
¦Ù
 = 
·th
->
¦Ùs
[0];

4247 
Şd_d©a
 = 
	`bŒfs_™em_d©a_’d
(
Ëaf
, 
¦Ù
);

4249 
	`BUG_ON
(
¦Ù
 < 0);

4250 ià(
¦Ù
 >ğ
Ä™ems
) {

4251 
	`bŒfs_´št_Ëaf
(
Ëaf
);

4252 
	`bŒfs_ü™
(
Ëaf
->
fs_šfo
, "slot %doo†arge,‚ritems %d",

4253 
¦Ù
, 
Ä™ems
);

4254 
	`BUG
();

4261 
	`bŒfs_š™_m­_tok’
(&
tok’
, 
Ëaf
);

4262 
i
 = 
¦Ù
; i < 
Ä™ems
; i++) {

4263 
u32
 
ioff
;

4265 
ioff
 = 
	`bŒfs_tok’_™em_off£t
(&
tok’
, 
i
);

4266 
	`bŒfs_£t_tok’_™em_off£t
(&
tok’
, 
i
, 
ioff
 - 
d©a_size
);

4270 
	`memmove_Ëaf_d©a
(
Ëaf
, 
d©a_’d
 - 
d©a_size
, data_end,

4271 
Şd_d©a
 - 
d©a_’d
);

4273 
d©a_’d
 = 
Şd_d©a
;

4274 
Şd_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

4275 
	`bŒfs_£t_™em_size
(
Ëaf
, 
¦Ù
, 
Şd_size
 + 
d©a_size
);

4276 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

4278 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
Ëaf
) < 0) {

4279 
	`bŒfs_´št_Ëaf
(
Ëaf
);

4280 
	`BUG
();

4282 
	}
}

4295 
	$£tup_™ems_fÜ_š£¹
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4296 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

4297 cÚ¡ 
bŒfs_™em_b©ch
 *
b©ch
)

4299 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4300 
i
;

4301 
u32
 
Ä™ems
;

4302 
d©a_’d
;

4303 
bŒfs_disk_key
 
disk_key
;

4304 
ex‹Á_bufãr
 *
Ëaf
;

4305 
¦Ù
;

4306 
bŒfs_m­_tok’
 
tok’
;

4307 
u32
 
tÙ®_size
;

4314 ià(
·th
->
¦Ùs
[0] == 0) {

4315 
	`bŒfs_ıu_key_to_disk
(&
disk_key
, &
b©ch
->
keys
[0]);

4316 
	`fixup_low_keys
(
Œªs
, 
·th
, &
disk_key
, 1);

4318 
	`bŒfs_uÆock_up_§ã
(
·th
, 1);

4320 
Ëaf
 = 
·th
->
nodes
[0];

4321 
¦Ù
 = 
·th
->
¦Ùs
[0];

4323 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

4324 
d©a_’d
 = 
	`Ëaf_d©a_’d
(
Ëaf
);

4325 
tÙ®_size
 = 
b©ch
->
tÙ®_d©a_size
 + (b©ch->
Ä
 * (
bŒfs_™em
));

4327 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
Ëaf
è< 
tÙ®_size
) {

4328 
	`bŒfs_´št_Ëaf
(
Ëaf
);

4329 
	`bŒfs_ü™
(
fs_šfo
, "notƒnough freespace‚eed %u have %d",

4330 
tÙ®_size
, 
	`bŒfs_Ëaf_ä“_¥aû
(
Ëaf
));

4331 
	`BUG
();

4334 
	`bŒfs_š™_m­_tok’
(&
tok’
, 
Ëaf
);

4335 ià(
¦Ù
 !ğ
Ä™ems
) {

4336 
Şd_d©a
 = 
	`bŒfs_™em_d©a_’d
(
Ëaf
, 
¦Ù
);

4338 ià(
Şd_d©a
 < 
d©a_’d
) {

4339 
	`bŒfs_´št_Ëaf
(
Ëaf
);

4340 
	`bŒfs_ü™
(
fs_šfo
,

4342 
¦Ù
, 
Şd_d©a
, 
d©a_’d
);

4343 
	`BUG
();

4349 
i
 = 
¦Ù
; i < 
Ä™ems
; i++) {

4350 
u32
 
ioff
;

4352 
ioff
 = 
	`bŒfs_tok’_™em_off£t
(&
tok’
, 
i
);

4353 
	`bŒfs_£t_tok’_™em_off£t
(&
tok’
, 
i
,

4354 
ioff
 - 
b©ch
->
tÙ®_d©a_size
);

4357 
	`memmove_Ëaf_™ems
(
Ëaf
, 
¦Ù
 + 
b©ch
->
Ä
, slÙ, 
Ä™ems
 - slot);

4360 
	`memmove_Ëaf_d©a
(
Ëaf
, 
d©a_’d
 - 
b©ch
->
tÙ®_d©a_size
,

4361 
d©a_’d
, 
Şd_d©a
 - data_end);

4362 
d©a_’d
 = 
Şd_d©a
;

4366 
i
 = 0; i < 
b©ch
->
Ä
; i++) {

4367 
	`bŒfs_ıu_key_to_disk
(&
disk_key
, &
b©ch
->
keys
[
i
]);

4368 
	`bŒfs_£t_™em_key
(
Ëaf
, &
disk_key
, 
¦Ù
 + 
i
);

4369 
d©a_’d
 -ğ
b©ch
->
d©a_sizes
[
i
];

4370 
	`bŒfs_£t_tok’_™em_off£t
(&
tok’
, 
¦Ù
 + 
i
, 
d©a_’d
);

4371 
	`bŒfs_£t_tok’_™em_size
(&
tok’
, 
¦Ù
 + 
i
, 
b©ch
->
d©a_sizes
[i]);

4374 
	`bŒfs_£t_h—d”_Ä™ems
(
Ëaf
, 
Ä™ems
 + 
b©ch
->
Ä
);

4375 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

4377 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
Ëaf
) < 0) {

4378 
	`bŒfs_´št_Ëaf
(
Ëaf
);

4379 
	`BUG
();

4381 
	}
}

4392 
	$bŒfs_£tup_™em_fÜ_š£¹
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4393 
bŒfs_roÙ
 *
roÙ
,

4394 
bŒfs_·th
 *
·th
,

4395 cÚ¡ 
bŒfs_key
 *
key
,

4396 
u32
 
d©a_size
)

4398 
bŒfs_™em_b©ch
 
b©ch
;

4400 
b©ch
.
keys
 = 
key
;

4401 
b©ch
.
d©a_sizes
 = &
d©a_size
;

4402 
b©ch
.
tÙ®_d©a_size
 = 
d©a_size
;

4403 
b©ch
.
Ä
 = 1;

4405 
	`£tup_™ems_fÜ_š£¹
(
Œªs
, 
roÙ
, 
·th
, &
b©ch
);

4406 
	}
}

4412 
	$bŒfs_š£¹_em±y_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4413 
bŒfs_roÙ
 *
roÙ
,

4414 
bŒfs_·th
 *
·th
,

4415 cÚ¡ 
bŒfs_™em_b©ch
 *
b©ch
)

4417 
»t
 = 0;

4418 
¦Ù
;

4419 
u32
 
tÙ®_size
;

4421 
tÙ®_size
 = 
b©ch
->
tÙ®_d©a_size
 + (b©ch->
Ä
 * (
bŒfs_™em
));

4422 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
b©ch
->
keys
[0], 
·th
, 
tÙ®_size
, 1);

4423 ià(
»t
 == 0)

4424  -
EEXIST
;

4425 ià(
»t
 < 0)

4426  
»t
;

4428 
¦Ù
 = 
·th
->
¦Ùs
[0];

4429 
	`BUG_ON
(
¦Ù
 < 0);

4431 
	`£tup_™ems_fÜ_š£¹
(
Œªs
, 
roÙ
, 
·th
, 
b©ch
);

4433 
	}
}

4439 
	$bŒfs_š£¹_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

4440 cÚ¡ 
bŒfs_key
 *
ıu_key
, *
d©a
,

4441 
u32
 
d©a_size
)

4443 
»t
 = 0;

4444 
bŒfs_·th
 *
·th
;

4445 
ex‹Á_bufãr
 *
Ëaf
;

4446 
±r
;

4448 
·th
 = 
	`bŒfs_®loc_·th
();

4449 ià(!
·th
)

4450  -
ENOMEM
;

4451 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, 
ıu_key
, 
d©a_size
);

4452 ià(!
»t
) {

4453 
Ëaf
 = 
·th
->
nodes
[0];

4454 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

4455 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
d©a
, 
±r
, 
d©a_size
);

4456 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

4458 
	`bŒfs_ä“_·th
(
·th
);

4459  
»t
;

4460 
	}
}

4470 
	$bŒfs_du¶iÿ‹_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4471 
bŒfs_roÙ
 *
roÙ
,

4472 
bŒfs_·th
 *
·th
,

4473 cÚ¡ 
bŒfs_key
 *
Ãw_key
)

4475 
ex‹Á_bufãr
 *
Ëaf
;

4476 
»t
;

4477 
u32
 
™em_size
;

4479 
Ëaf
 = 
·th
->
nodes
[0];

4480 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

4481 
»t
 = 
	`£tup_Ëaf_fÜ_¥l™
(
Œªs
, 
roÙ
, 
·th
,

4482 
™em_size
 + (
bŒfs_™em
));

4483 ià(
»t
)

4484  
»t
;

4486 
·th
->
¦Ùs
[0]++;

4487 
	`bŒfs_£tup_™em_fÜ_š£¹
(
Œªs
, 
roÙ
, 
·th
, 
Ãw_key
, 
™em_size
);

4488 
Ëaf
 = 
·th
->
nodes
[0];

4489 
	`memıy_ex‹Á_bufãr
(
Ëaf
,

4490 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]),

4491 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1),

4492 
™em_size
);

4494 
	}
}

4504 
	$bŒfs_d–_±r
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

4505 
bŒfs_·th
 *
·th
, 
Ëv–
, 
¦Ù
)

4507 
ex‹Á_bufãr
 *
·»Á
 = 
·th
->
nodes
[
Ëv–
];

4508 
u32
 
Ä™ems
;

4509 
»t
;

4511 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·»Á
);

4512 ià(
¦Ù
 !ğ
Ä™ems
 - 1) {

4513 ià(
Ëv–
) {

4514 
»t
 = 
	`bŒfs_Œ“_mod_log_š£¹_move
(
·»Á
, 
¦Ù
,

4515 
¦Ù
 + 1, 
Ä™ems
 - slot - 1);

4516 ià(
»t
 < 0) {

4517 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4518  
»t
;

4521 
	`memmove_ex‹Á_bufãr
(
·»Á
,

4522 
	`bŒfs_node_key_±r_off£t
(
·»Á
, 
¦Ù
),

4523 
	`bŒfs_node_key_±r_off£t
(
·»Á
, 
¦Ù
 + 1),

4524 (
bŒfs_key_±r
) *

4525 (
Ä™ems
 - 
¦Ù
 - 1));

4526 } ià(
Ëv–
) {

4527 
»t
 = 
	`bŒfs_Œ“_mod_log_š£¹_key
(
·»Á
, 
¦Ù
,

4528 
BTRFS_MOD_LOG_KEY_REMOVE
);

4529 ià(
»t
 < 0) {

4530 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4531  
»t
;

4535 
Ä™ems
--;

4536 
	`bŒfs_£t_h—d”_Ä™ems
(
·»Á
, 
Ä™ems
);

4537 ià(
Ä™ems
 =ğ0 && 
·»Á
 =ğ
roÙ
->
node
) {

4538 
	`BUG_ON
(
	`bŒfs_h—d”_Ëv–
(
roÙ
->
node
) != 1);

4540 
	`bŒfs_£t_h—d”_Ëv–
(
roÙ
->
node
, 0);

4541 } ià(
¦Ù
 == 0) {

4542 
bŒfs_disk_key
 
disk_key
;

4544 
	`bŒfs_node_key
(
·»Á
, &
disk_key
, 0);

4545 
	`fixup_low_keys
(
Œªs
, 
·th
, &
disk_key
, 
Ëv–
 + 1);

4547 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·»Á
);

4549 
	}
}

4561 
nošlše
 
	$bŒfs_d–_Ëaf
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4562 
bŒfs_roÙ
 *
roÙ
,

4563 
bŒfs_·th
 *
·th
,

4564 
ex‹Á_bufãr
 *
Ëaf
)

4566 
»t
;

4568 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
Ëaf
è!ğ
Œªs
->
Œªsid
);

4569 
»t
 = 
	`bŒfs_d–_±r
(
Œªs
, 
roÙ
, 
·th
, 1,…©h->
¦Ùs
[1]);

4570 ià(
»t
 < 0)

4571  
»t
;

4577 
	`bŒfs_uÆock_up_§ã
(
·th
, 0);

4579 
	`roÙ_sub_u£d
(
roÙ
, 
Ëaf
->
Ën
);

4581 
	`©omic_šc
(&
Ëaf
->
»fs
);

4582 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
	`bŒfs_roÙ_id
(
roÙ
), 
Ëaf
, 0, 1);

4583 
	`ä“_ex‹Á_bufãr_¡®e
(
Ëaf
);

4585 
	}
}

4590 
	$bŒfs_d–_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

4591 
bŒfs_·th
 *
·th
, 
¦Ù
, 
Ä
)

4593 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4594 
ex‹Á_bufãr
 *
Ëaf
;

4595 
»t
 = 0;

4596 
w»t
;

4597 
u32
 
Ä™ems
;

4599 
Ëaf
 = 
·th
->
nodes
[0];

4600 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

4602 ià(
¦Ù
 + 
Ä
 !ğ
Ä™ems
) {

4603 cÚ¡ 
u32
 
Ï¡_off
 = 
	`bŒfs_™em_off£t
(
Ëaf
, 
¦Ù
 + 
Ä
 - 1);

4604 cÚ¡ 
d©a_’d
 = 
	`Ëaf_d©a_’d
(
Ëaf
);

4605 
bŒfs_m­_tok’
 
tok’
;

4606 
u32
 
dsize
 = 0;

4607 
i
;

4609 
i
 = 0; i < 
Ä
; i++)

4610 
dsize
 +ğ
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
 + 
i
);

4612 
	`memmove_Ëaf_d©a
(
Ëaf
, 
d©a_’d
 + 
dsize
, data_end,

4613 
Ï¡_off
 - 
d©a_’d
);

4615 
	`bŒfs_š™_m­_tok’
(&
tok’
, 
Ëaf
);

4616 
i
 = 
¦Ù
 + 
Ä
; i < 
Ä™ems
; i++) {

4617 
u32
 
ioff
;

4619 
ioff
 = 
	`bŒfs_tok’_™em_off£t
(&
tok’
, 
i
);

4620 
	`bŒfs_£t_tok’_™em_off£t
(&
tok’
, 
i
, 
ioff
 + 
dsize
);

4623 
	`memmove_Ëaf_™ems
(
Ëaf
, 
¦Ù
, slÙ + 
Ä
, 
Ä™ems
 - slot -‚r);

4625 
	`bŒfs_£t_h—d”_Ä™ems
(
Ëaf
, 
Ä™ems
 - 
Ä
);

4626 
Ä™ems
 -ğ
Ä
;

4629 ià(
Ä™ems
 == 0) {

4630 ià(
Ëaf
 =ğ
roÙ
->
node
) {

4631 
	`bŒfs_£t_h—d”_Ëv–
(
Ëaf
, 0);

4633 
	`bŒfs_ş—r_bufãr_dœty
(
Œªs
, 
Ëaf
);

4634 
»t
 = 
	`bŒfs_d–_Ëaf
(
Œªs
, 
roÙ
, 
·th
, 
Ëaf
);

4635 ià(
»t
 < 0)

4636  
»t
;

4639 
u£d
 = 
	`Ëaf_¥aû_u£d
(
Ëaf
, 0, 
Ä™ems
);

4640 ià(
¦Ù
 == 0) {

4641 
bŒfs_disk_key
 
disk_key
;

4643 
	`bŒfs_™em_key
(
Ëaf
, &
disk_key
, 0);

4644 
	`fixup_low_keys
(
Œªs
, 
·th
, &
disk_key
, 1);

4655 ià(
u£d
 < 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
) / 3) {

4656 
u32
 
mš_push_¥aû
;

4662 
¦Ù
 = 
·th
->
¦Ùs
[1];

4663 
	`©omic_šc
(&
Ëaf
->
»fs
);

4668 
mš_push_¥aû
 = (
bŒfs_™em
) +

4669 
	`bŒfs_™em_size
(
Ëaf
, 0);

4670 
w»t
 = 
	`push_Ëaf_Ëá
(
Œªs
, 
roÙ
, 
·th
, 0,

4671 
mš_push_¥aû
, 1, (
u32
)-1);

4672 ià(
w»t
 < 0 && w»ˆ!ğ-
ENOSPC
)

4673 
»t
 = 
w»t
;

4675 ià(
·th
->
nodes
[0] =ğ
Ëaf
 &&

4676 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

4687 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

4688 
mš_push_¥aû
 = 
	`Ëaf_¥aû_u£d
(
Ëaf
, 0, 
Ä™ems
);

4689 
w»t
 = 
	`push_Ëaf_right
(
Œªs
, 
roÙ
, 
·th
, 0,

4690 
mš_push_¥aû
, 1, 0);

4691 ià(
w»t
 < 0 && w»ˆ!ğ-
ENOSPC
)

4692 
»t
 = 
w»t
;

4695 ià(
	`bŒfs_h—d”_Ä™ems
(
Ëaf
) == 0) {

4696 
·th
->
¦Ùs
[1] = 
¦Ù
;

4697 
»t
 = 
	`bŒfs_d–_Ëaf
(
Œªs
, 
roÙ
, 
·th
, 
Ëaf
);

4698 ià(
»t
 < 0)

4699  
»t
;

4700 
	`ä“_ex‹Á_bufãr
(
Ëaf
);

4701 
»t
 = 0;

4708 ià(
·th
->
nodes
[0] =ğ
Ëaf
)

4709 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

4710 
	`ä“_ex‹Á_bufãr
(
Ëaf
);

4713 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

4716  
»t
;

4717 
	}
}

4738 
	$bŒfs_£¬ch_fÜw¬d
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_key
 *
mš_key
,

4739 
bŒfs_·th
 *
·th
,

4740 
u64
 
mš_Œªs
)

4742 
ex‹Á_bufãr
 *
cur
;

4743 
bŒfs_key
 
found_key
;

4744 
¦Ù
;

4745 
¤‘
;

4746 
u32
 
Ä™ems
;

4747 
Ëv–
;

4748 
»t
 = 1;

4749 
k“p_locks
 = 
·th
->keep_locks;

4751 
	`ASSERT
(!
·th
->
nowa™
);

4752 
·th
->
k“p_locks
 = 1;

4753 
agaš
:

4754 
cur
 = 
	`bŒfs_»ad_lock_roÙ_node
(
roÙ
);

4755 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
cur
);

4756 
	`WARN_ON
(
·th
->
nodes
[
Ëv–
]);

4757 
·th
->
nodes
[
Ëv–
] = 
cur
;

4758 
·th
->
locks
[
Ëv–
] = 
BTRFS_READ_LOCK
;

4760 ià(
	`bŒfs_h—d”_g’”©iÚ
(
cur
è< 
mš_Œªs
) {

4761 
»t
 = 1;

4762 
out
;

4765 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
cur
);

4766 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
cur
);

4767 
¤‘
 = 
	`bŒfs_bš_£¬ch
(
cur
, 0, 
mš_key
, &
¦Ù
);

4768 ià(
¤‘
 < 0) {

4769 
»t
 = 
¤‘
;

4770 
out
;

4774 ià(
Ëv–
 =ğ
·th
->
lowe¡_Ëv–
) {

4775 ià(
¦Ù
 >ğ
Ä™ems
)

4776 
fšd_Ãxt_key
;

4777 
»t
 = 0;

4778 
·th
->
¦Ùs
[
Ëv–
] = 
¦Ù
;

4779 
	`bŒfs_™em_key_to_ıu
(
cur
, &
found_key
, 
¦Ù
);

4780 
out
;

4782 ià(
¤‘
 && 
¦Ù
 > 0)

4783 
¦Ù
--;

4788 
¦Ù
 < 
Ä™ems
) {

4789 
u64
 
g’
;

4791 
g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
cur
, 
¦Ù
);

4792 ià(
g’
 < 
mš_Œªs
) {

4793 
¦Ù
++;

4798 
fšd_Ãxt_key
:

4803 ià(
¦Ù
 >ğ
Ä™ems
) {

4804 
·th
->
¦Ùs
[
Ëv–
] = 
¦Ù
;

4805 
¤‘
 = 
	`bŒfs_fšd_Ãxt_key
(
roÙ
, 
·th
, 
mš_key
, 
Ëv–
,

4806 
mš_Œªs
);

4807 ià(
¤‘
 == 0) {

4808 
	`bŒfs_»Ëa£_·th
(
·th
);

4809 
agaš
;

4811 
out
;

4815 
	`bŒfs_node_key_to_ıu
(
cur
, &
found_key
, 
¦Ù
);

4816 
·th
->
¦Ùs
[
Ëv–
] = 
¦Ù
;

4817 ià(
Ëv–
 =ğ
·th
->
lowe¡_Ëv–
) {

4818 
»t
 = 0;

4819 
out
;

4821 
cur
 = 
	`bŒfs_»ad_node_¦Ù
(cur, 
¦Ù
);

4822 ià(
	`IS_ERR
(
cur
)) {

4823 
»t
 = 
	`PTR_ERR
(
cur
);

4824 
out
;

4827 
	`bŒfs_Œ“_»ad_lock
(
cur
);

4829 
·th
->
locks
[
Ëv–
 - 1] = 
BTRFS_READ_LOCK
;

4830 
·th
->
nodes
[
Ëv–
 - 1] = 
cur
;

4831 
	`uÆock_up
(
·th
, 
Ëv–
, 1, 0, 
NULL
);

4833 
out
:

4834 
·th
->
k“p_locks
 = keep_locks;

4835 ià(
»t
 == 0) {

4836 
	`bŒfs_uÆock_up_§ã
(
·th
,…©h->
lowe¡_Ëv–
 + 1);

4837 
	`memıy
(
mš_key
, &
found_key
, (found_key));

4839  
»t
;

4840 
	}
}

4853 
	$bŒfs_fšd_Ãxt_key
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

4854 
bŒfs_key
 *
key
, 
Ëv–
, 
u64
 
mš_Œªs
)

4856 
¦Ù
;

4857 
ex‹Á_bufãr
 *
c
;

4859 
	`WARN_ON
(!
·th
->
k“p_locks
 && !·th->
sk_lockšg
);

4860 
Ëv–
 < 
BTRFS_MAX_LEVEL
) {

4861 ià(!
·th
->
nodes
[
Ëv–
])

4864 
¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
] + 1;

4865 
c
 = 
·th
->
nodes
[
Ëv–
];

4866 
Ãxt
:

4867 ià(
¦Ù
 >ğ
	`bŒfs_h—d”_Ä™ems
(
c
)) {

4868 
»t
;

4869 
Üig_lowe¡
;

4870 
bŒfs_key
 
cur_key
;

4871 ià(
Ëv–
 + 1 >ğ
BTRFS_MAX_LEVEL
 ||

4872 !
·th
->
nodes
[
Ëv–
 + 1])

4875 ià(
·th
->
locks
[
Ëv–
 + 1] ||…©h->
sk_lockšg
) {

4876 
Ëv–
++;

4880 
¦Ù
 = 
	`bŒfs_h—d”_Ä™ems
(
c
) - 1;

4881 ià(
Ëv–
 == 0)

4882 
	`bŒfs_™em_key_to_ıu
(
c
, &
cur_key
, 
¦Ù
);

4884 
	`bŒfs_node_key_to_ıu
(
c
, &
cur_key
, 
¦Ù
);

4886 
Üig_lowe¡
 = 
·th
->
lowe¡_Ëv–
;

4887 
	`bŒfs_»Ëa£_·th
(
·th
);

4888 
·th
->
lowe¡_Ëv–
 = 
Ëv–
;

4889 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
cur_key
, 
·th
,

4891 
·th
->
lowe¡_Ëv–
 = 
Üig_lowe¡
;

4892 ià(
»t
 < 0)

4893  
»t
;

4895 
c
 = 
·th
->
nodes
[
Ëv–
];

4896 
¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
];

4897 ià(
»t
 == 0)

4898 
¦Ù
++;

4899 
Ãxt
;

4902 ià(
Ëv–
 == 0)

4903 
	`bŒfs_™em_key_to_ıu
(
c
, 
key
, 
¦Ù
);

4905 
u64
 
g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
c
, 
¦Ù
);

4907 ià(
g’
 < 
mš_Œªs
) {

4908 
¦Ù
++;

4909 
Ãxt
;

4911 
	`bŒfs_node_key_to_ıu
(
c
, 
key
, 
¦Ù
);

4916 
	}
}

4918 
	$bŒfs_Ãxt_Şd_Ëaf
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

4919 
u64
 
time_£q
)

4921 
¦Ù
;

4922 
Ëv–
;

4923 
ex‹Á_bufãr
 *
c
;

4924 
ex‹Á_bufãr
 *
Ãxt
;

4925 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4926 
bŒfs_key
 
key
;

4927 
boŞ
 
Ãed_comm™_£m
 = 
çl£
;

4928 
u32
 
Ä™ems
;

4929 
»t
;

4930 
i
;

4936 ià(
time_£q
)

4937 
	`ASSERT
(!
·th
->
nowa™
);

4939 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

4940 ià(
Ä™ems
 == 0)

4943 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
, 
Ä™ems
 - 1);

4944 
agaš
:

4945 
Ëv–
 = 1;

4946 
Ãxt
 = 
NULL
;

4947 
	`bŒfs_»Ëa£_·th
(
·th
);

4949 
·th
->
k“p_locks
 = 1;

4951 ià(
time_£q
) {

4952 
»t
 = 
	`bŒfs_£¬ch_Şd_¦Ù
(
roÙ
, &
key
, 
·th
, 
time_£q
);

4954 ià(
·th
->
Ãed_comm™_£m
) {

4955 
·th
->
Ãed_comm™_£m
 = 0;

4956 
Ãed_comm™_£m
 = 
Œue
;

4957 ià(
·th
->
nowa™
) {

4958 ià(!
	`down_»ad_Œylock
(&
fs_šfo
->
comm™_roÙ_£m
)) {

4959 
»t
 = -
EAGAIN
;

4960 
dÚe
;

4963 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

4966 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

4968 
·th
->
k“p_locks
 = 0;

4970 ià(
»t
 < 0)

4971 
dÚe
;

4973 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

4980 ià(
Ä™ems
 > 0 && 
·th
->
¦Ùs
[0] <‚ritems - 1) {

4981 ià(
»t
 == 0)

4982 
·th
->
¦Ùs
[0]++;

4983 
»t
 = 0;

4984 
dÚe
;

5000 ià(
Ä™ems
 > 0 && 
»t
 > 0 && 
·th
->
¦Ùs
[0] ==‚ritems - 1) {

5001 
»t
 = 0;

5002 
dÚe
;

5005 
Ëv–
 < 
BTRFS_MAX_LEVEL
) {

5006 ià(!
·th
->
nodes
[
Ëv–
]) {

5007 
»t
 = 1;

5008 
dÚe
;

5011 
¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
] + 1;

5012 
c
 = 
·th
->
nodes
[
Ëv–
];

5013 ià(
¦Ù
 >ğ
	`bŒfs_h—d”_Ä™ems
(
c
)) {

5014 
Ëv–
++;

5015 ià(
Ëv–
 =ğ
BTRFS_MAX_LEVEL
) {

5016 
»t
 = 1;

5017 
dÚe
;

5028 
i
 = 0; i < 
Ëv–
; i++) {

5029 ià(
·th
->
locks
[
Ëv–
]) {

5030 
	`bŒfs_Œ“_»ad_uÆock
(
·th
->
nodes
[
i
]);

5031 
·th
->
locks
[
i
] = 0;

5033 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[
i
]);

5034 
·th
->
nodes
[
i
] = 
NULL
;

5037 
Ãxt
 = 
c
;

5038 
»t
 = 
	`»ad_block_fÜ_£¬ch
(
roÙ
, 
·th
, &
Ãxt
, 
Ëv–
,

5039 
¦Ù
, &
key
);

5040 ià(
»t
 =ğ-
EAGAIN
 && !
·th
->
nowa™
)

5041 
agaš
;

5043 ià(
»t
 < 0) {

5044 
	`bŒfs_»Ëa£_·th
(
·th
);

5045 
dÚe
;

5048 ià(!
·th
->
sk_lockšg
) {

5049 
»t
 = 
	`bŒfs_Œy_Œ“_»ad_lock
(
Ãxt
);

5050 ià(!
»t
 && 
·th
->
nowa™
) {

5051 
»t
 = -
EAGAIN
;

5052 
dÚe
;

5054 ià(!
»t
 && 
time_£q
) {

5062 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

5063 
	`bŒfs_»Ëa£_·th
(
·th
);

5064 
	`cÚd_»sched
();

5065 
agaš
;

5067 ià(!
»t
)

5068 
	`bŒfs_Œ“_»ad_lock
(
Ãxt
);

5072 
·th
->
¦Ùs
[
Ëv–
] = 
¦Ù
;

5074 
Ëv–
--;

5075 
·th
->
nodes
[
Ëv–
] = 
Ãxt
;

5076 
·th
->
¦Ùs
[
Ëv–
] = 0;

5077 ià(!
·th
->
sk_lockšg
)

5078 
·th
->
locks
[
Ëv–
] = 
BTRFS_READ_LOCK
;

5079 ià(!
Ëv–
)

5082 
»t
 = 
	`»ad_block_fÜ_£¬ch
(
roÙ
, 
·th
, &
Ãxt
, 
Ëv–
,

5083 0, &
key
);

5084 ià(
»t
 =ğ-
EAGAIN
 && !
·th
->
nowa™
)

5085 
agaš
;

5087 ià(
»t
 < 0) {

5088 
	`bŒfs_»Ëa£_·th
(
·th
);

5089 
dÚe
;

5092 ià(!
·th
->
sk_lockšg
) {

5093 ià(
·th
->
nowa™
) {

5094 ià(!
	`bŒfs_Œy_Œ“_»ad_lock
(
Ãxt
)) {

5095 
»t
 = -
EAGAIN
;

5096 
dÚe
;

5099 
	`bŒfs_Œ“_»ad_lock
(
Ãxt
);

5103 
»t
 = 0;

5104 
dÚe
:

5105 
	`uÆock_up
(
·th
, 0, 1, 0, 
NULL
);

5106 ià(
Ãed_comm™_£m
) {

5107 
»t2
;

5109 
·th
->
Ãed_comm™_£m
 = 1;

5110 
»t2
 = 
	`fšish_Ãed_comm™_£m_£¬ch
(
·th
);

5111 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

5112 ià(
»t2
)

5113 
»t
 = 
»t2
;

5116  
»t
;

5117 
	}
}

5119 
	$bŒfs_Ãxt_Şd_™em
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
, 
u64
 
time_£q
)

5121 
·th
->
¦Ùs
[0]++;

5122 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0]))

5123  
	`bŒfs_Ãxt_Şd_Ëaf
(
roÙ
, 
·th
, 
time_£q
);

5125 
	}
}

5133 
	$bŒfs_´evious_™em
(
bŒfs_roÙ
 *
roÙ
,

5134 
bŒfs_·th
 *
·th
, 
u64
 
mš_objeùid
,

5135 
ty³
)

5137 
bŒfs_key
 
found_key
;

5138 
ex‹Á_bufãr
 *
Ëaf
;

5139 
u32
 
Ä™ems
;

5140 
»t
;

5143 ià(
·th
->
¦Ùs
[0] == 0) {

5144 
»t
 = 
	`bŒfs_´ev_Ëaf
(
roÙ
, 
·th
);

5145 ià(
»t
 != 0)

5146  
»t
;

5148 
·th
->
¦Ùs
[0]--;

5150 
Ëaf
 = 
·th
->
nodes
[0];

5151 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

5152 ià(
Ä™ems
 == 0)

5154 ià(
·th
->
¦Ùs
[0] =ğ
Ä™ems
)

5155 
·th
->
¦Ùs
[0]--;

5157 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

5158 ià(
found_key
.
objeùid
 < 
mš_objeùid
)

5160 ià(
found_key
.
ty³
 ==ype)

5162 ià(
found_key
.
objeùid
 =ğ
mš_objeùid
 &&

5163 
found_key
.
ty³
 <ype)

5167 
	}
}

5175 
	$bŒfs_´evious_ex‹Á_™em
(
bŒfs_roÙ
 *
roÙ
,

5176 
bŒfs_·th
 *
·th
, 
u64
 
mš_objeùid
)

5178 
bŒfs_key
 
found_key
;

5179 
ex‹Á_bufãr
 *
Ëaf
;

5180 
u32
 
Ä™ems
;

5181 
»t
;

5184 ià(
·th
->
¦Ùs
[0] == 0) {

5185 
»t
 = 
	`bŒfs_´ev_Ëaf
(
roÙ
, 
·th
);

5186 ià(
»t
 != 0)

5187  
»t
;

5189 
·th
->
¦Ùs
[0]--;

5191 
Ëaf
 = 
·th
->
nodes
[0];

5192 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

5193 ià(
Ä™ems
 == 0)

5195 ià(
·th
->
¦Ùs
[0] =ğ
Ä™ems
)

5196 
·th
->
¦Ùs
[0]--;

5198 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

5199 ià(
found_key
.
objeùid
 < 
mš_objeùid
)

5201 ià(
found_key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 ||

5202 
found_key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
)

5204 ià(
found_key
.
objeùid
 =ğ
mš_objeùid
 &&

5205 
found_key
.
ty³
 < 
BTRFS_EXTENT_ITEM_KEY
)

5209 
	}
}

5211 
__š™
 
	$bŒfs_ù»e_š™
()

5213 
bŒfs_·th_ÿch•
 = 
	`kmem_ÿche_ü—‹
("btrfs_path",

5214 (
bŒfs_·th
), 0,

5215 
SLAB_MEM_SPREAD
, 
NULL
);

5216 ià(!
bŒfs_·th_ÿch•
)

5217  -
ENOMEM
;

5219 
	}
}

5221 
__cŞd
 
	$bŒfs_ù»e_ex™
()

5223 
	`kmem_ÿche_de¡roy
(
bŒfs_·th_ÿch•
);

5224 
	}
}

	@ctree.h

6 #iâdeà
BTRFS_CTREE_H


7 
	#BTRFS_CTREE_H


	)

9 
	~<lšux/mm.h
>

10 
	~<lšux/sched/sigÇl.h
>

11 
	~<lšux/highmem.h
>

12 
	~<lšux/fs.h
>

13 
	~<lšux/rw£m.h
>

14 
	~<lšux/£m­hÜe.h
>

15 
	~<lšux/com¶‘iÚ.h
>

16 
	~<lšux/backšg-dev.h
>

17 
	~<lšux/wa™.h
>

18 
	~<lšux/¦ab.h
>

19 
	~<Œaû/ev’ts/bŒfs.h
>

20 
	~<asm/uÇligÃd.h
>

21 
	~<lšux/·gem­.h
>

22 
	~<lšux/bŒfs.h
>

23 
	~<lšux/bŒfs_Œ“.h
>

24 
	~<lšux/wÜkqueue.h
>

25 
	~<lšux/£cur™y.h
>

26 
	~<lšux/sizes.h
>

27 
	~<lšux/dyÇmic_debug.h
>

28 
	~<lšux/»fcouÁ.h
>

29 
	~<lšux/üc32c.h
>

30 
	~<lšux/iom­.h
>

31 
	~<lšux/fsüy±.h
>

32 
	~"ex‹Á-io-Œ“.h
"

33 
	~"ex‹Á_io.h
"

34 
	~"ex‹Á_m­.h
"

35 
	~"async-th»ad.h
"

36 
	~"block-rsv.h
"

37 
	~"lockšg.h
"

38 
	~"misc.h
"

39 
	~"fs.h
"

41 
	gbŒfs_Œªs_hªdË
;

42 
	gbŒfs_Œª§ùiÚ
;

43 
	gbŒfs_³ndšg_¢­shÙ
;

44 
	gbŒfs_d–ayed_»f_roÙ
;

45 
	gbŒfs_¥aû_šfo
;

46 
	gbŒfs_block_group
;

47 
	gbŒfs_Üd”ed_sum
;

48 
	gbŒfs_»f
;

49 
	gbŒfs_bio
;

50 
	gbŒfs_ioùl_’coded_io_¬gs
;

51 
	gbŒfs_deviû
;

52 
	gbŒfs_fs_deviûs
;

53 
	gbŒfs_b®ªû_cÚŒŞ
;

54 
	gbŒfs_d–ayed_roÙ
;

55 
	g»loc_cÚŒŞ
;

59 
	mREADA_NONE
,

60 
	mREADA_BACK
,

61 
	mREADA_FORWARD
,

75 
	mREADA_FORWARD_ALWAYS
,

86 
	sbŒfs_·th
 {

87 
ex‹Á_bufãr
 *
	mnodes
[
BTRFS_MAX_LEVEL
];

88 
	m¦Ùs
[
BTRFS_MAX_LEVEL
];

90 
u8
 
	mlocks
[
BTRFS_MAX_LEVEL
];

91 
u8
 
	m»ada
;

93 
u8
 
	mlowe¡_Ëv–
;

99 
	m£¬ch_fÜ_¥l™
:1;

100 
	mk“p_locks
:1;

101 
	msk_lockšg
:1;

102 
	m£¬ch_comm™_roÙ
:1;

103 
	mÃed_comm™_£m
:1;

104 
	msk_»Ëa£_Ú_”rÜ
:1;

110 
	m£¬ch_fÜ_ex‹nsiÚ
:1;

112 
	mnowa™
:1;

125 
	mBTRFS_ROOT_IN_TRANS_SETUP
,

147 
	mBTRFS_ROOT_SHAREABLE
,

148 
	mBTRFS_ROOT_TRACK_DIRTY
,

149 
	mBTRFS_ROOT_IN_RADIX
,

150 
	mBTRFS_ROOT_ORPHAN_ITEM_INSERTED
,

151 
	mBTRFS_ROOT_DEFRAG_RUNNING
,

152 
	mBTRFS_ROOT_FORCE_COW
,

153 
	mBTRFS_ROOT_MULTI_LOG_TASKS
,

154 
	mBTRFS_ROOT_DIRTY
,

155 
	mBTRFS_ROOT_DELETING
,

162 
	mBTRFS_ROOT_DEAD_RELOC_TREE
,

164 
	mBTRFS_ROOT_DEAD_TREE
,

166 
	mBTRFS_ROOT_HAS_LOG_TREE
,

168 
	mBTRFS_ROOT_QGROUP_FLUSHING
,

170 
	mBTRFS_ROOT_ORPHAN_CLEANUP
,

172 
	mBTRFS_ROOT_UNFINISHED_DROP
,

174 
	mBTRFS_ROOT_RESET_LOCKDEP_CLASS
,

181 
	sbŒfs_qgroup_sw­³d_blocks
 {

182 
¥šlock_t
 
	mlock
;

184 
boŞ
 
	msw­³d
;

185 
rb_roÙ
 
	mblocks
[
BTRFS_MAX_LEVEL
];

192 
	sbŒfs_roÙ
 {

193 
rb_node
 
	mrb_node
;

195 
ex‹Á_bufãr
 *
	mnode
;

197 
ex‹Á_bufãr
 *
	mcomm™_roÙ
;

198 
bŒfs_roÙ
 *
	mlog_roÙ
;

199 
bŒfs_roÙ
 *
	m»loc_roÙ
;

201 
	m¡©e
;

202 
bŒfs_roÙ_™em
 
	mroÙ_™em
;

203 
bŒfs_key
 
	mroÙ_key
;

204 
bŒfs_fs_šfo
 *
	mfs_šfo
;

205 
ex‹Á_io_Œ“
 
	mdœty_log_·ges
;

207 
mu‹x
 
	mobjeùid_mu‹x
;

209 
¥šlock_t
 
	maccouÁšg_lock
;

210 
bŒfs_block_rsv
 *
	mblock_rsv
;

212 
mu‹x
 
	mlog_mu‹x
;

213 
wa™_queue_h—d_t
 
	mlog_wr™”_wa™
;

214 
wa™_queue_h—d_t
 
	mlog_comm™_wa™
[2];

215 
li¡_h—d
 
	mlog_ùxs
[2];

217 
©omic_t
 
	mlog_wr™”s
;

218 
©omic_t
 
	mlog_comm™
[2];

220 
©omic_t
 
	mlog_b©ch
;

221 
	mlog_Œªsid
;

223 
	mlog_Œªsid_comm™‹d
;

225 
	mÏ¡_log_comm™
;

226 
pid_t
 
	mlog_¡¬t_pid
;

228 
u64
 
	mÏ¡_Œªs
;

230 
u32
 
	mty³
;

232 
u64
 
	mä“_objeùid
;

234 
bŒfs_key
 
	mdeäag_´og»ss
;

235 
bŒfs_key
 
	mdeäag_max
;

238 
li¡_h—d
 
	mdœty_li¡
;

240 
li¡_h—d
 
	mroÙ_li¡
;

242 
¥šlock_t
 
	mlog_ex‹Ás_lock
[2];

243 
li¡_h—d
 
	mlogged_li¡
[2];

245 
¥šlock_t
 
	mšode_lock
;

247 
rb_roÙ
 
	mšode_Œ“
;

253 
¿dix_Œ“_roÙ
 
	md–ayed_nodes_Œ“
;

258 
dev_t
 
	mªÚ_dev
;

260 
¥šlock_t
 
	mroÙ_™em_lock
;

261 
»fcouÁ_t
 
	m»fs
;

263 
mu‹x
 
	md–®loc_mu‹x
;

264 
¥šlock_t
 
	md–®loc_lock
;

270 
li¡_h—d
 
	md–®loc_šodes
;

271 
li¡_h—d
 
	md–®loc_roÙ
;

272 
u64
 
	mÄ_d–®loc_šodes
;

274 
mu‹x
 
	mÜd”ed_ex‹Á_mu‹x
;

279 
¥šlock_t
 
	mÜd”ed_ex‹Á_lock
;

286 
li¡_h—d
 
	mÜd”ed_ex‹Ás
;

287 
li¡_h—d
 
	mÜd”ed_roÙ
;

288 
u64
 
	mÄ_Üd”ed_ex‹Ás
;

296 
li¡_h—d
 
	m»loc_dœty_li¡
;

302 
	m£nd_š_´og»ss
;

308 
	mdedu³_š_´og»ss
;

310 
bŒfs_d»w_lock
 
	m¢­shÙ_lock
;

312 
©omic_t
 
	m¢­shÙ_fÜû_cow
;

315 
¥šlock_t
 
	mqgroup_m‘a_rsv_lock
;

316 
u64
 
	mqgroup_m‘a_rsv_³¹¿ns
;

317 
u64
 
	mqgroup_m‘a_rsv_´—Îoc
;

318 
wa™_queue_h—d_t
 
	mqgroup_æush_wa™
;

321 
©omic_t
 
	mÄ_sw­fes
;

324 
bŒfs_qgroup_sw­³d_blocks
 
	msw­³d_blocks
;

327 
ex‹Á_io_Œ“
 
	mlog_csum_¿nge
;

329 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


330 
u64
 
	m®loc_by‹Ä
;

333 #ifdeà
CONFIG_BTRFS_DEBUG


334 
li¡_h—d
 
	mËak_li¡
;

338 
šlše
 
boŞ
 
	$bŒfs_roÙ_»adÚly
(cÚ¡ 
bŒfs_roÙ
 *
roÙ
)

341  (
roÙ
->
roÙ_™em
.
æags
 & 
	`ıu_to_Ë64
(
BTRFS_ROOT_SUBVOL_RDONLY
)) != 0;

342 
	}
}

344 
šlše
 
boŞ
 
	$bŒfs_roÙ_d—d
(cÚ¡ 
bŒfs_roÙ
 *
roÙ
)

347  (
roÙ
->
roÙ_™em
.
æags
 & 
	`ıu_to_Ë64
(
BTRFS_ROOT_SUBVOL_DEAD
)) != 0;

348 
	}
}

350 
šlše
 
u64
 
	$bŒfs_roÙ_id
(cÚ¡ 
bŒfs_roÙ
 *
roÙ
)

352  
roÙ
->
roÙ_key
.
objeùid
;

353 
	}
}

359 
	sbŒfs_»¶aû_ex‹Á_šfo
 {

360 
u64
 
	mdisk_off£t
;

361 
u64
 
	mdisk_Ën
;

362 
u64
 
	md©a_off£t
;

363 
u64
 
	md©a_Ën
;

364 
u64
 
	mfe_off£t
;

366 *
	mex‹Á_buf
;

372 
boŞ
 
	mis_Ãw_ex‹Á
;

374 
boŞ
 
	mupd©e_times
;

376 
	mqgroup_»£rved
;

384 
	mš£¹iÚs
;

388 
	sbŒfs_drİ_ex‹Ás_¬gs
 {

398 
bŒfs_·th
 *
	m·th
;

400 
u64
 
	m¡¬t
;

402 
u64
 
	m’d
;

404 
boŞ
 
	mdrİ_ÿche
;

413 
boŞ
 
	m»¶aû_ex‹Á
;

418 
u32
 
	mex‹Á_™em_size
;

427 
u64
 
	mdrİ_’d
;

432 
u64
 
	mby‹s_found
;

441 
boŞ
 
	mex‹Á_š£¹ed
;

444 
	sbŒfs_fe_´iv©e
 {

445 *
	mfldœ_buf
;

446 
u64
 
	mÏ¡_šdex
;

447 
ex‹Á_¡©e
 *
	mÎ£ek_ÿched_¡©e
;

450 
šlše
 
u32
 
	$BTRFS_LEAF_DATA_SIZE
(cÚ¡ 
bŒfs_fs_šfo
 *
šfo
)

452  
šfo
->
nodesize
 - (
bŒfs_h—d”
);

453 
	}
}

455 
šlše
 
u32
 
	$BTRFS_MAX_ITEM_SIZE
(cÚ¡ 
bŒfs_fs_šfo
 *
šfo
)

457  
	`BTRFS_LEAF_DATA_SIZE
(
šfo
è- (
bŒfs_™em
);

458 
	}
}

460 
šlše
 
u32
 
	$BTRFS_NODEPTRS_PER_BLOCK
(cÚ¡ 
bŒfs_fs_šfo
 *
šfo
)

462  
	`BTRFS_LEAF_DATA_SIZE
(
šfo
è/ (
bŒfs_key_±r
);

463 
	}
}

465 
šlše
 
u32
 
	$BTRFS_MAX_XATTR_SIZE
(cÚ¡ 
bŒfs_fs_šfo
 *
šfo
)

467  
	`BTRFS_MAX_ITEM_SIZE
(
šfo
è- (
bŒfs_dœ_™em
);

468 
	}
}

470 
	#BTRFS_BYTES_TO_BLKS
(
fs_šfo
, 
by‹s
) \

471 ((
by‹s
è>> (
fs_šfo
)->
£ùÜsize_b™s
)

	)

473 
šlše
 
u32
 
	$bŒfs_üc32c
(
u32
 
üc
, cÚ¡ *
add»ss
, 
Ëngth
)

475  
	`üc32c
(
üc
, 
add»ss
, 
Ëngth
);

476 
	}
}

478 
šlše
 
	$bŒfs_üc32c_fš®
(
u32
 
üc
, 
u8
 *
»suÉ
)

480 
	`put_uÇligÃd_Ë32
(~
üc
, 
»suÉ
);

481 
	}
}

483 
šlše
 
u64
 
	$bŒfs_Çme_hash
(cÚ¡ *
Çme
, 
Ën
)

485  
	`üc32c
((
u32
)~1, 
Çme
, 
Ën
);

486 
	}
}

491 
šlše
 
u64
 
	$bŒfs_exŒef_hash
(
u64
 
·»Á_objeùid
, cÚ¡ *
Çme
,

492 
Ën
)

494  (
u64
è
	`üc32c
(
·»Á_objeùid
, 
Çme
, 
Ën
);

495 
	}
}

497 
šlše
 
gå_t
 
	$bŒfs_®loc_wr™e_mask
(
add»ss_¥aû
 *
m­pšg
)

499  
	`m­pšg_gå_cÚ¡¿št
(
m­pšg
, ~
__GFP_FS
);

500 
	}
}

502 
bŒfs_”rÜ_uÅš_ex‹Á_¿nge
(
bŒfs_fs_šfo
 *
fs_šfo
,

503 
u64
 
¡¬t
, u64 
’d
);

504 
bŒfs_disÿrd_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

505 
u64
 
num_by‹s
, u64 *
aùu®_by‹s
);

506 
bŒfs_Œim_fs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
f¡rim_¿nge
 *
¿nge
);

509 
__š™
 
bŒfs_ù»e_š™
();

510 
__cŞd
 
bŒfs_ù»e_ex™
();

512 
bŒfs_bš_£¬ch
(
ex‹Á_bufãr
 *
eb
, 
fœ¡_¦Ù
,

513 cÚ¡ 
bŒfs_key
 *
key
, *
¦Ù
);

515 
__pu»
 
bŒfs_comp_ıu_keys
(cÚ¡ 
bŒfs_key
 *
k1
, cÚ¡ bŒfs_key *
k2
);

516 
bŒfs_´evious_™em
(
bŒfs_roÙ
 *
roÙ
,

517 
bŒfs_·th
 *
·th
, 
u64
 
mš_objeùid
,

518 
ty³
);

519 
bŒfs_´evious_ex‹Á_™em
(
bŒfs_roÙ
 *
roÙ
,

520 
bŒfs_·th
 *
·th
, 
u64
 
mš_objeùid
);

521 
bŒfs_£t_™em_key_§ã
(
bŒfs_Œªs_hªdË
 *
Œªs
,

522 
bŒfs_·th
 *
·th
,

523 cÚ¡ 
bŒfs_key
 *
Ãw_key
);

524 
ex‹Á_bufãr
 *
bŒfs_roÙ_node
(
bŒfs_roÙ
 *
roÙ
);

525 
bŒfs_fšd_Ãxt_key
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

526 
bŒfs_key
 *
key
, 
lowe¡_Ëv–
,

527 
u64
 
mš_Œªs
);

528 
bŒfs_£¬ch_fÜw¬d
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_key
 *
mš_key
,

529 
bŒfs_·th
 *
·th
,

530 
u64
 
mš_Œªs
);

531 
ex‹Á_bufãr
 *
bŒfs_»ad_node_¦Ù
(ex‹Á_bufã¸*
·»Á
,

532 
¦Ù
);

534 
bŒfs_cow_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

535 
bŒfs_roÙ
 *
roÙ
, 
ex‹Á_bufãr
 *
buf
,

536 
ex‹Á_bufãr
 *
·»Á
, 
·»Á_¦Ù
,

537 
ex‹Á_bufãr
 **
cow_»t
,

538 
bŒfs_lock_Ã¡šg
 
Ã¡
);

539 
bŒfs_cİy_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

540 
bŒfs_roÙ
 *
roÙ
,

541 
ex‹Á_bufãr
 *
buf
,

542 
ex‹Á_bufãr
 **
cow_»t
, 
u64
 
Ãw_roÙ_objeùid
);

543 
bŒfs_block_ÿn_be_sh¬ed
(
bŒfs_Œªs_hªdË
 *
Œªs
,

544 
bŒfs_roÙ
 *
roÙ
,

545 
ex‹Á_bufãr
 *
buf
);

546 
bŒfs_d–_±r
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

547 
bŒfs_·th
 *
·th
, 
Ëv–
, 
¦Ù
);

548 
bŒfs_ex‹nd_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

549 
bŒfs_·th
 *
·th
, 
u32
 
d©a_size
);

550 
bŒfs_Œunÿ‹_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

551 
bŒfs_·th
 *
·th
, 
u32
 
Ãw_size
, 
äom_’d
);

552 
bŒfs_¥l™_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

553 
bŒfs_roÙ
 *
roÙ
,

554 
bŒfs_·th
 *
·th
,

555 cÚ¡ 
bŒfs_key
 *
Ãw_key
,

556 
¥l™_off£t
);

557 
bŒfs_du¶iÿ‹_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

558 
bŒfs_roÙ
 *
roÙ
,

559 
bŒfs_·th
 *
·th
,

560 cÚ¡ 
bŒfs_key
 *
Ãw_key
);

561 
bŒfs_fšd_™em
(
bŒfs_roÙ
 *
fs_roÙ
, 
bŒfs_·th
 *
·th
,

562 
u64
 
šum
, u64 
ioff
, 
u8
 
key_ty³
, 
bŒfs_key
 *
found_key
);

563 
bŒfs_£¬ch_¦Ù
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

564 cÚ¡ 
bŒfs_key
 *
key
, 
bŒfs_·th
 *
p
,

565 
šs_Ën
, 
cow
);

566 
bŒfs_£¬ch_Şd_¦Ù
(
bŒfs_roÙ
 *
roÙ
, cÚ¡ 
bŒfs_key
 *
key
,

567 
bŒfs_·th
 *
p
, 
u64
 
time_£q
);

568 
bŒfs_£¬ch_¦Ù_fÜ_»ad
(
bŒfs_roÙ
 *
roÙ
,

569 cÚ¡ 
bŒfs_key
 *
key
,

570 
bŒfs_·th
 *
p
, 
fšd_high”
,

571 
»tuº_ªy
);

572 
bŒfs_»®loc_node
(
bŒfs_Œªs_hªdË
 *
Œªs
,

573 
bŒfs_roÙ
 *
roÙ
, 
ex‹Á_bufãr
 *
·»Á
,

574 
¡¬t_¦Ù
, 
u64
 *
Ï¡_»t
,

575 
bŒfs_key
 *
´og»ss
);

576 
bŒfs_»Ëa£_·th
(
bŒfs_·th
 *
p
);

577 
bŒfs_·th
 *
bŒfs_®loc_·th
();

578 
bŒfs_ä“_·th
(
bŒfs_·th
 *
p
);

580 
bŒfs_d–_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

581 
bŒfs_·th
 *
·th
, 
¦Ù
, 
Ä
);

582 
šlše
 
	$bŒfs_d–_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

583 
bŒfs_roÙ
 *
roÙ
,

584 
bŒfs_·th
 *
·th
)

586  
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
,…©h->
¦Ùs
[0], 1);

587 
	}
}

593 
	sbŒfs_™em_b©ch
 {

598 cÚ¡ 
bŒfs_key
 *
	mkeys
;

600 cÚ¡ 
u32
 *
	md©a_sizes
;

610 
u32
 
	mtÙ®_d©a_size
;

612 
	mÄ
;

615 
bŒfs_£tup_™em_fÜ_š£¹
(
bŒfs_Œªs_hªdË
 *
Œªs
,

616 
bŒfs_roÙ
 *
roÙ
,

617 
bŒfs_·th
 *
·th
,

618 cÚ¡ 
bŒfs_key
 *
key
,

619 
u32
 
d©a_size
);

620 
bŒfs_š£¹_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

621 cÚ¡ 
bŒfs_key
 *
key
, *
d©a
, 
u32
 
d©a_size
);

622 
bŒfs_š£¹_em±y_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

623 
bŒfs_roÙ
 *
roÙ
,

624 
bŒfs_·th
 *
·th
,

625 cÚ¡ 
bŒfs_™em_b©ch
 *
b©ch
);

627 
šlše
 
	$bŒfs_š£¹_em±y_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

628 
bŒfs_roÙ
 *
roÙ
,

629 
bŒfs_·th
 *
·th
,

630 cÚ¡ 
bŒfs_key
 *
key
,

631 
u32
 
d©a_size
)

633 
bŒfs_™em_b©ch
 
b©ch
;

635 
b©ch
.
keys
 = 
key
;

636 
b©ch
.
d©a_sizes
 = &
d©a_size
;

637 
b©ch
.
tÙ®_d©a_size
 = 
d©a_size
;

638 
b©ch
.
Ä
 = 1;

640  
	`bŒfs_š£¹_em±y_™ems
(
Œªs
, 
roÙ
, 
·th
, &
b©ch
);

641 
	}
}

643 
bŒfs_Ãxt_Şd_Ëaf
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

644 
u64
 
time_£q
);

646 
bŒfs_£¬ch_backw¬ds
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_key
 *
key
,

647 
bŒfs_·th
 *
·th
);

649 
bŒfs_g‘_Ãxt_v®id_™em
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_key
 *
key
,

650 
bŒfs_·th
 *
·th
);

671 
	#bŒfs_fÜ_—ch_¦Ù
(
roÙ
, 
key
, 
found_key
, 
·th
, 
™”_»t
) \

672 
™”_»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, (
roÙ
), (
key
), (
·th
), 0, 0); \

673 (
™”_»t
) >= 0 && \

674 (
™”_»t
 = 
	`bŒfs_g‘_Ãxt_v®id_™em
((
roÙ
), (
found_key
), (
·th
))) == 0; \

675 (
·th
)->
¦Ùs
[0]++ \

676 )

	)

678 
bŒfs_Ãxt_Şd_™em
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
, 
u64
 
time_£q
);

686 
šlše
 
	$bŒfs_Ãxt_Ëaf
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
)

688  
	`bŒfs_Ãxt_Şd_Ëaf
(
roÙ
, 
·th
, 0);

689 
	}
}

691 
šlše
 
	$bŒfs_Ãxt_™em
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
p
)

693  
	`bŒfs_Ãxt_Şd_™em
(
roÙ
, 
p
, 0);

694 
	}
}

695 
bŒfs_Ëaf_ä“_¥aû
(cÚ¡ 
ex‹Á_bufãr
 *
Ëaf
);

697 
šlše
 
	$is_f¡»e
(
u64
 
roÙid
)

699 ià(
roÙid
 =ğ
BTRFS_FS_TREE_OBJECTID
 ||

700 ((
s64
)
roÙid
 >ğ(s64)
BTRFS_FIRST_FREE_OBJECTID
 &&

701 !
	`bŒfs_qgroup_Ëv–
(
roÙid
)))

704 
	}
}

706 
šlše
 
boŞ
 
	$bŒfs_is_d©a_»loc_roÙ
(cÚ¡ 
bŒfs_roÙ
 *
roÙ
)

708  
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_DATA_RELOC_TREE_OBJECTID
;

709 
	}
}

711 
u16
 
bŒfs_csum_ty³_size
(u16 
ty³
);

712 
bŒfs_su³r_csum_size
(cÚ¡ 
bŒfs_su³r_block
 *
s
);

713 cÚ¡ *
bŒfs_su³r_csum_Çme
(
u16
 
csum_ty³
);

714 cÚ¡ *
bŒfs_su³r_csum_driv”
(
u16
 
csum_ty³
);

715 
size_t
 
__©Œibu‹_cÚ¡__
 
bŒfs_g‘_num_csums
();

723 
	#PageOrd”ed
(
·ge
è
	`PagePriv©e2
Õage)

	)

724 
	#S‘PageOrd”ed
(
·ge
è
	`S‘PagePriv©e2
Õage)

	)

725 
	#CË¬PageOrd”ed
(
·ge
è
	`CË¬PagePriv©e2
Õage)

	)

726 
	#fŞio_‹¡_Üd”ed
(
fŞio
è
	`fŞio_‹¡_´iv©e_2
(fŞio)

	)

727 
	#fŞio_£t_Üd”ed
(
fŞio
è
	`fŞio_£t_´iv©e_2
(fŞio)

	)

728 
	#fŞio_ş—r_Üd”ed
(
fŞio
è
	`fŞio_ş—r_´iv©e_2
(fŞio)

	)

	@defrag.c

6 
	~<lšux/sched.h
>

7 
	~"ù»e.h
"

8 
	~"disk-io.h
"

9 
	~"´št-Œ“.h
"

10 
	~"Œª§ùiÚ.h
"

11 
	~"lockšg.h
"

12 
	~"acûssÜs.h
"

13 
	~"mes§ges.h
"

14 
	~"d–®loc-¥aû.h
"

15 
	~"sub·ge.h
"

16 
	~"deäag.h
"

17 
	~"fe-™em.h
"

18 
	~"su³r.h
"

20 
kmem_ÿche
 *
	gbŒfs_šode_deäag_ÿch•
;

26 
	sšode_deäag
 {

27 
rb_node
 
	mrb_node
;

29 
u64
 
	mšo
;

34 
u64
 
	mŒªsid
;

37 
u64
 
	mroÙ
;

46 
u32
 
	mex‹Á_th»sh
;

49 
	$__com·»_šode_deäag
(
šode_deäag
 *
deäag1
,

50 
šode_deäag
 *
deäag2
)

52 ià(
deäag1
->
roÙ
 > 
deäag2
->root)

54 ià(
deäag1
->
roÙ
 < 
deäag2
->root)

56 ià(
deäag1
->
šo
 > 
deäag2
->ino)

58 ià(
deäag1
->
šo
 < 
deäag2
->ino)

62 
	}
}

73 
	$__bŒfs_add_šode_deäag
(
bŒfs_šode
 *
šode
,

74 
šode_deäag
 *
deäag
)

76 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

77 
šode_deäag
 *
’Œy
;

78 
rb_node
 **
p
;

79 
rb_node
 *
·»Á
 = 
NULL
;

80 
»t
;

82 
p
 = &
fs_šfo
->
deäag_šodes
.
rb_node
;

83 *
p
) {

84 
·»Á
 = *
p
;

85 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
šode_deäag
, 
rb_node
);

87 
»t
 = 
	`__com·»_šode_deäag
(
deäag
, 
’Œy
);

88 ià(
»t
 < 0)

89 
p
 = &
·»Á
->
rb_Ëá
;

90 ià(
»t
 > 0)

91 
p
 = &
·»Á
->
rb_right
;

98 ià(
deäag
->
Œªsid
 < 
’Œy
->transid)

99 
’Œy
->
Œªsid
 = 
deäag
->transid;

100 
’Œy
->
ex‹Á_th»sh
 = 
	`mš
(
deäag
->extent_thresh,

101 
’Œy
->
ex‹Á_th»sh
);

102  -
EEXIST
;

105 
	`£t_b™
(
BTRFS_INODE_IN_DEFRAG
, &
šode
->
ruÁime_æags
);

106 
	`rb_lšk_node
(&
deäag
->
rb_node
, 
·»Á
, 
p
);

107 
	`rb_š£¹_cŞÜ
(&
deäag
->
rb_node
, &
fs_šfo
->
deäag_šodes
);

109 
	}
}

111 
šlše
 
	$__Ãed_auto_deäag
(
bŒfs_fs_šfo
 *
fs_šfo
)

113 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
AUTO_DEFRAG
))

116 ià(
	`bŒfs_fs_şosšg
(
fs_šfo
))

120 
	}
}

125 
	$bŒfs_add_šode_deäag
(
bŒfs_Œªs_hªdË
 *
Œªs
,

126 
bŒfs_šode
 *
šode
, 
u32
 
ex‹Á_th»sh
)

128 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

129 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

130 
šode_deäag
 *
deäag
;

131 
u64
 
Œªsid
;

132 
»t
;

134 ià(!
	`__Ãed_auto_deäag
(
fs_šfo
))

137 ià(
	`‹¡_b™
(
BTRFS_INODE_IN_DEFRAG
, &
šode
->
ruÁime_æags
))

140 ià(
Œªs
)

141 
Œªsid
 = 
Œªs
->transid;

143 
Œªsid
 = 
šode
->
roÙ
->
Ï¡_Œªs
;

145 
deäag
 = 
	`kmem_ÿche_z®loc
(
bŒfs_šode_deäag_ÿch•
, 
GFP_NOFS
);

146 ià(!
deäag
)

147  -
ENOMEM
;

149 
deäag
->
šo
 = 
	`bŒfs_šo
(
šode
);

150 
deäag
->
Œªsid
 =ransid;

151 
deäag
->
roÙ
 =„oÙ->
roÙ_key
.
objeùid
;

152 
deäag
->
ex‹Á_th»sh
 =ƒxtent_thresh;

154 
	`¥š_lock
(&
fs_šfo
->
deäag_šodes_lock
);

155 ià(!
	`‹¡_b™
(
BTRFS_INODE_IN_DEFRAG
, &
šode
->
ruÁime_æags
)) {

161 
»t
 = 
	`__bŒfs_add_šode_deäag
(
šode
, 
deäag
);

162 ià(
»t
)

163 
	`kmem_ÿche_ä“
(
bŒfs_šode_deäag_ÿch•
, 
deäag
);

165 
	`kmem_ÿche_ä“
(
bŒfs_šode_deäag_ÿch•
, 
deäag
);

167 
	`¥š_uÆock
(&
fs_šfo
->
deäag_šodes_lock
);

169 
	}
}

175 
šode_deäag
 *
	$bŒfs_pick_deäag_šode
(

176 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
roÙ
, u64 
šo
)

178 
šode_deäag
 *
’Œy
 = 
NULL
;

179 
šode_deäag
 
tmp
;

180 
rb_node
 *
p
;

181 
rb_node
 *
·»Á
 = 
NULL
;

182 
»t
;

184 
tmp
.
šo
 = ino;

185 
tmp
.
roÙ
 =„oot;

187 
	`¥š_lock
(&
fs_šfo
->
deäag_šodes_lock
);

188 
p
 = 
fs_šfo
->
deäag_šodes
.
rb_node
;

189 
p
) {

190 
·»Á
 = 
p
;

191 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
šode_deäag
, 
rb_node
);

193 
»t
 = 
	`__com·»_šode_deäag
(&
tmp
, 
’Œy
);

194 ià(
»t
 < 0)

195 
p
 = 
·»Á
->
rb_Ëá
;

196 ià(
»t
 > 0)

197 
p
 = 
·»Á
->
rb_right
;

199 
out
;

202 ià(
·»Á
 && 
	`__com·»_šode_deäag
(&
tmp
, 
’Œy
) > 0) {

203 
·»Á
 = 
	`rb_Ãxt
(parent);

204 ià(
·»Á
)

205 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
šode_deäag
, 
rb_node
);

207 
’Œy
 = 
NULL
;

209 
out
:

210 ià(
’Œy
)

211 
	`rb_”a£
(
·»Á
, &
fs_šfo
->
deäag_šodes
);

212 
	`¥š_uÆock
(&
fs_šfo
->
deäag_šodes_lock
);

213  
’Œy
;

214 
	}
}

216 
	$bŒfs_ş—nup_deäag_šodes
(
bŒfs_fs_šfo
 *
fs_šfo
)

218 
šode_deäag
 *
deäag
;

219 
rb_node
 *
node
;

221 
	`¥š_lock
(&
fs_šfo
->
deäag_šodes_lock
);

222 
node
 = 
	`rb_fœ¡
(&
fs_šfo
->
deäag_šodes
);

223 
node
) {

224 
	`rb_”a£
(
node
, &
fs_šfo
->
deäag_šodes
);

225 
deäag
 = 
	`rb_’Œy
(
node
, 
šode_deäag
, 
rb_node
);

226 
	`kmem_ÿche_ä“
(
bŒfs_šode_deäag_ÿch•
, 
deäag
);

228 
	`cÚd_»sched_lock
(&
fs_šfo
->
deäag_šodes_lock
);

230 
node
 = 
	`rb_fœ¡
(&
fs_šfo
->
deäag_šodes
);

232 
	`¥š_uÆock
(&
fs_šfo
->
deäag_šodes_lock
);

233 
	}
}

235 
	#BTRFS_DEFRAG_BATCH
 1024

	)

237 
	$__bŒfs_run_deäag_šode
(
bŒfs_fs_šfo
 *
fs_šfo
,

238 
šode_deäag
 *
deäag
)

240 
bŒfs_roÙ
 *
šode_roÙ
;

241 
šode
 *inode;

242 
bŒfs_ioùl_deäag_¿nge_¬gs
 
¿nge
;

243 
»t
 = 0;

244 
u64
 
cur
 = 0;

246 
agaš
:

247 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_šfo
->
fs_¡©e
))

248 
ş—nup
;

249 ià(!
	`__Ãed_auto_deäag
(
fs_šfo
))

250 
ş—nup
;

253 
šode_roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
deäag
->
roÙ
, 
Œue
);

254 ià(
	`IS_ERR
(
šode_roÙ
)) {

255 
»t
 = 
	`PTR_ERR
(
šode_roÙ
);

256 
ş—nup
;

259 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
deäag
->
šo
, 
šode_roÙ
);

260 
	`bŒfs_put_roÙ
(
šode_roÙ
);

261 ià(
	`IS_ERR
(
šode
)) {

262 
»t
 = 
	`PTR_ERR
(
šode
);

263 
ş—nup
;

266 ià(
cur
 >ğ
	`i_size_»ad
(
šode
)) {

267 
	`ut
(
šode
);

268 
ş—nup
;

272 
	`ş—r_b™
(
BTRFS_INODE_IN_DEFRAG
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

273 
	`mem£t
(&
¿nge
, 0, (range));

274 
¿nge
.
Ën
 = (
u64
)-1;

275 
¿nge
.
¡¬t
 = 
cur
;

276 
¿nge
.
ex‹Á_th»sh
 = 
deäag
->extent_thresh;

278 
	`sb_¡¬t_wr™e
(
fs_šfo
->
sb
);

279 
»t
 = 
	`bŒfs_deäag_fe
(
šode
, 
NULL
, &
¿nge
, 
deäag
->
Œªsid
,

280 
BTRFS_DEFRAG_BATCH
);

281 
	`sb_’d_wr™e
(
fs_šfo
->
sb
);

282 
	`ut
(
šode
);

284 ià(
»t
 < 0)

285 
ş—nup
;

287 
cur
 = 
	`max
(cu¸+ 
fs_šfo
->
£ùÜsize
, 
¿nge
.
¡¬t
);

288 
agaš
;

290 
ş—nup
:

291 
	`kmem_ÿche_ä“
(
bŒfs_šode_deäag_ÿch•
, 
deäag
);

292  
»t
;

293 
	}
}

298 
	$bŒfs_run_deäag_šodes
(
bŒfs_fs_šfo
 *
fs_šfo
)

300 
šode_deäag
 *
deäag
;

301 
u64
 
fœ¡_šo
 = 0;

302 
u64
 
roÙ_objeùid
 = 0;

304 
	`©omic_šc
(&
fs_šfo
->
deäag_ruÂšg
);

307 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_šfo
->
fs_¡©e
))

310 ià(!
	`__Ãed_auto_deäag
(
fs_šfo
))

314 
deäag
 = 
	`bŒfs_pick_deäag_šode
(
fs_šfo
, 
roÙ_objeùid
, 
fœ¡_šo
);

315 ià(!
deäag
) {

316 ià(
roÙ_objeùid
 || 
fœ¡_šo
) {

317 
roÙ_objeùid
 = 0;

318 
fœ¡_šo
 = 0;

325 
fœ¡_šo
 = 
deäag
->
šo
 + 1;

326 
roÙ_objeùid
 = 
deäag
->
roÙ
;

328 
	`__bŒfs_run_deäag_šode
(
fs_šfo
, 
deäag
);

330 
	`©omic_dec
(&
fs_šfo
->
deäag_ruÂšg
);

336 
	`wake_up
(&
fs_šfo
->
Œª§ùiÚ_wa™
);

338 
	}
}

346 
	$bŒfs_deäag_Ëaves
(
bŒfs_Œªs_hªdË
 *
Œªs
,

347 
bŒfs_roÙ
 *
roÙ
)

349 
bŒfs_·th
 *
·th
 = 
NULL
;

350 
bŒfs_key
 
key
;

351 
»t
 = 0;

352 
w»t
;

353 
Ëv–
;

354 
Ãxt_key_»t
 = 0;

355 
u64
 
Ï¡_»t
 = 0;

357 ià(!
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
))

358 
out
;

360 
·th
 = 
	`bŒfs_®loc_·th
();

361 ià(!
·th
) {

362 
»t
 = -
ENOMEM
;

363 
out
;

366 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
roÙ
->
node
);

368 ià(
Ëv–
 == 0)

369 
out
;

371 ià(
roÙ
->
deäag_´og»ss
.
objeùid
 == 0) {

372 
ex‹Á_bufãr
 *
roÙ_node
;

373 
u32
 
Ä™ems
;

375 
roÙ_node
 = 
	`bŒfs_lock_roÙ_node
(
roÙ
);

376 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
roÙ_node
);

377 
roÙ
->
deäag_max
.
objeùid
 = 0;

379 
	`bŒfs_node_key_to_ıu
(
roÙ_node
, &
roÙ
->
deäag_max
,

380 
Ä™ems
 - 1);

381 
	`bŒfs_Œ“_uÆock
(
roÙ_node
);

382 
	`ä“_ex‹Á_bufãr
(
roÙ_node
);

383 
	`mem£t
(&
key
, 0, (key));

385 
	`memıy
(&
key
, &
roÙ
->
deäag_´og»ss
, (key));

388 
·th
->
k“p_locks
 = 1;

390 
»t
 = 
	`bŒfs_£¬ch_fÜw¬d
(
roÙ
, &
key
, 
·th
, 
BTRFS_OLDEST_GENERATION
);

391 ià(
»t
 < 0)

392 
out
;

393 ià(
»t
 > 0) {

394 
»t
 = 0;

395 
out
;

397 
	`bŒfs_»Ëa£_·th
(
·th
);

403 
·th
->
lowe¡_Ëv–
 = 1;

404 
w»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

406 ià(
w»t
 < 0) {

407 
»t
 = 
w»t
;

408 
out
;

410 ià(!
·th
->
nodes
[1]) {

411 
»t
 = 0;

412 
out
;

419 
	`BUG_ON
(
·th
->
locks
[1] == 0);

420 
»t
 = 
	`bŒfs_»®loc_node
(
Œªs
, 
roÙ
,

421 
·th
->
nodes
[1], 0,

422 &
Ï¡_»t
,

423 &
roÙ
->
deäag_´og»ss
);

424 ià(
»t
) {

425 
	`WARN_ON
(
»t
 =ğ-
EAGAIN
);

426 
out
;

437 
·th
->
¦Ùs
[1] = 
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[1]);

438 
Ãxt_key_»t
 = 
	`bŒfs_fšd_Ãxt_key
(
roÙ
, 
·th
, &
key
, 1,

439 
BTRFS_OLDEST_GENERATION
);

440 ià(
Ãxt_key_»t
 == 0) {

441 
	`memıy
(&
roÙ
->
deäag_´og»ss
, &
key
, (key));

442 
»t
 = -
EAGAIN
;

444 
out
:

445 
	`bŒfs_ä“_·th
(
·th
);

446 ià(
»t
 =ğ-
EAGAIN
) {

447 ià(
roÙ
->
deäag_max
.
objeùid
 >„oÙ->
deäag_´og»ss
.objectid)

448 
dÚe
;

449 ià(
roÙ
->
deäag_max
.
ty³
 >„oÙ->
deäag_´og»ss
.type)

450 
dÚe
;

451 ià(
roÙ
->
deäag_max
.
off£t
 >„oÙ->
deäag_´og»ss
.offset)

452 
dÚe
;

453 
»t
 = 0;

455 
dÚe
:

456 ià(
»t
 !ğ-
EAGAIN
)

457 
	`mem£t
(&
roÙ
->
deäag_´og»ss
, 0,

458 (
roÙ
->
deäag_´og»ss
));

460  
»t
;

461 
	}
}

482 
ex‹Á_m­
 *
	$deäag_g‘_ex‹Á
(
bŒfs_šode
 *
šode
,

483 
u64
 
¡¬t
, u64 
Ãw”_thª
)

485 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

486 
bŒfs_fe_ex‹Á_™em
 *
fi
;

487 
bŒfs_·th
 
·th
 = { 0 };

488 
ex‹Á_m­
 *
em
;

489 
bŒfs_key
 
key
;

490 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

491 
»t
;

493 
em
 = 
	`®loc_ex‹Á_m­
();

494 ià(!
em
) {

495 
»t
 = -
ENOMEM
;

496 
”r
;

499 
key
.
objeùid
 = 
šo
;

500 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

501 
key
.
off£t
 = 
¡¬t
;

503 ià(
Ãw”_thª
) {

504 
»t
 = 
	`bŒfs_£¬ch_fÜw¬d
(
roÙ
, &
key
, &
·th
, 
Ãw”_thª
);

505 ià(
»t
 < 0)

506 
”r
;

508 ià(
»t
 > 0)

509 
nÙ_found
;

511 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, &
·th
, 0, 0);

512 ià(
»t
 < 0)

513 
”r
;

515 ià(
·th
.
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
Õ©h.
nodes
[0])) {

521 
	`ASSERT
(
	`bŒfs_h—d”_Ä™ems
(
·th
.
nodes
[0]));

522 
·th
.
¦Ùs
[0] = 
	`bŒfs_h—d”_Ä™ems
Õ©h.
nodes
[0]) - 1;

524 
	`bŒfs_™em_key_to_ıu
(
·th
.
nodes
[0], &
key
,…©h.
¦Ùs
[0]);

526 ià(
key
.
objeùid
 =ğ
šo
 && key.
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
 &&

527 
key
.
off£t
 =ğ
¡¬t
)

528 
™”©e
;

531 ià(
·th
.
¦Ùs
[0] > 0) {

532 
	`bŒfs_™em_key_to_ıu
(
·th
.
nodes
[0], &
key
,…©h.
¦Ùs
[0]);

533 ià(
key
.
objeùid
 =ğ
šo
 && key.
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
)

534 
·th
.
¦Ùs
[0]--;

537 
™”©e
:

539 
Œue
) {

540 
u64
 
ex‹Á_’d
;

542 ià(
·th
.
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
Õ©h.
nodes
[0]))

543 
Ãxt
;

545 
	`bŒfs_™em_key_to_ıu
(
·th
.
nodes
[0], &
key
,…©h.
¦Ùs
[0]);

552 ià(
	`WARN_ON
(
key
.
objeùid
 < 
šo
è|| key.
ty³
 < 
BTRFS_EXTENT_DATA_KEY
)

553 
Ãxt
;

556 ià(
key
.
objeùid
 > 
šo
 || key.
ty³
 > 
BTRFS_EXTENT_DATA_KEY
)

557 
nÙ_found
;

565 ià(
key
.
off£t
 > 
¡¬t
) {

566 
em
->
¡¬t
 = start;

567 
em
->
Üig_¡¬t
 = 
¡¬t
;

568 
em
->
block_¡¬t
 = 
EXTENT_MAP_HOLE
;

569 
em
->
Ën
 = 
key
.
off£t
 - 
¡¬t
;

573 
fi
 = 
	`bŒfs_™em_±r
(
·th
.
nodes
[0],…©h.
¦Ùs
[0],

574 
bŒfs_fe_ex‹Á_™em
);

575 
ex‹Á_’d
 = 
	`bŒfs_fe_ex‹Á_’d
(&
·th
);

583 ià(
ex‹Á_’d
 <ğ
¡¬t
)

584 
Ãxt
;

587 
	`bŒfs_ex‹Á_™em_to_ex‹Á_m­
(
šode
, &
·th
, 
fi
, 
em
);

589 
Ãxt
:

590 
»t
 = 
	`bŒfs_Ãxt_™em
(
roÙ
, &
·th
);

591 ià(
»t
 < 0)

592 
”r
;

593 ià(
»t
 > 0)

594 
nÙ_found
;

596 
	`bŒfs_»Ëa£_·th
(&
·th
);

597  
em
;

599 
nÙ_found
:

600 
	`bŒfs_»Ëa£_·th
(&
·th
);

601 
	`ä“_ex‹Á_m­
(
em
);

602  
NULL
;

604 
”r
:

605 
	`bŒfs_»Ëa£_·th
(&
·th
);

606 
	`ä“_ex‹Á_m­
(
em
);

607  
	`ERR_PTR
(
»t
);

608 
	}
}

610 
ex‹Á_m­
 *
	$deäag_lookup_ex‹Á
(
šode
 *šode, 
u64
 
¡¬t
,

611 
u64
 
Ãw”_thª
, 
boŞ
 
locked
)

613 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
;

614 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

615 
ex‹Á_m­
 *
em
;

616 cÚ¡ 
u32
 
£ùÜsize
 = 
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
->sectorsize;

622 
	`»ad_lock
(&
em_Œ“
->
lock
);

623 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
¡¬t
, 
£ùÜsize
);

624 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

634 ià(
em
 && 
	`‹¡_b™
(
EXTENT_FLAG_MERGED
, &em->
æags
) &&

635 
Ãw”_thª
 && 
em
->
g’”©iÚ
 >=‚ewer_than) {

636 
	`ä“_ex‹Á_m­
(
em
);

637 
em
 = 
NULL
;

640 ià(!
em
) {

641 
ex‹Á_¡©e
 *
ÿched
 = 
NULL
;

642 
u64
 
’d
 = 
¡¬t
 + 
£ùÜsize
 - 1;

645 ià(!
locked
)

646 
	`lock_ex‹Á
(
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched
);

647 
em
 = 
	`deäag_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
¡¬t
, 
Ãw”_thª
);

648 ià(!
locked
)

649 
	`uÆock_ex‹Á
(
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched
);

651 ià(
	`IS_ERR
(
em
))

652  
NULL
;

655  
em
;

656 
	}
}

658 
u32
 
	$g‘_ex‹Á_max_ÿ·c™y
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

659 cÚ¡ 
ex‹Á_m­
 *
em
)

661 ià(
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
))

662  
BTRFS_MAX_COMPRESSED
;

663  
fs_šfo
->
max_ex‹Á_size
;

664 
	}
}

666 
boŞ
 
	$deäag_check_Ãxt_ex‹Á
(
šode
 *šode, 
ex‹Á_m­
 *
em
,

667 
u32
 
ex‹Á_th»sh
, 
u64
 
Ãw”_thª
, 
boŞ
 
locked
)

669 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

670 
ex‹Á_m­
 *
Ãxt
;

671 
boŞ
 
»t
 = 
çl£
;

674 ià(
em
->
¡¬t
 +ƒm->
Ën
 >ğ
	`i_size_»ad
(
šode
))

675  
çl£
;

683 
Ãxt
 = 
	`deäag_lookup_ex‹Á
(
šode
, 
em
->
¡¬t
 +ƒm->
Ën
, 
Ãw”_thª
, 
locked
);

685 ià(!
Ãxt
 ||‚ext->
block_¡¬t
 >ğ
EXTENT_MAP_LAST_BYTE
)

686 
out
;

687 ià(
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
Ãxt
->
æags
))

688 
out
;

693 ià(
Ãxt
->
Ën
 >ğ
	`g‘_ex‹Á_max_ÿ·c™y
(
fs_šfo
, 
em
))

694 
out
;

696 ià(
Ãxt
->
g’”©iÚ
 < 
Ãw”_thª
)

697 
out
;

699 ià(
Ãxt
->
Ën
 >ğ
ex‹Á_th»sh
)

700 
out
;

702 
»t
 = 
Œue
;

703 
out
:

704 
	`ä“_ex‹Á_m­
(
Ãxt
);

705  
»t
;

706 
	}
}

720 
·ge
 *
	$deäag_´•¬e_Úe_·ge
(
bŒfs_šode
 *
šode
, 
pgoff_t
 
šdex
)

722 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
vfs_šode
.
i_m­pšg
;

723 
gå_t
 
mask
 = 
	`bŒfs_®loc_wr™e_mask
(
m­pšg
);

724 
u64
 
·ge_¡¬t
 = (u64)
šdex
 << 
PAGE_SHIFT
;

725 
u64
 
·ge_’d
 = 
·ge_¡¬t
 + 
PAGE_SIZE
 - 1;

726 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

727 
·ge
 *page;

728 
»t
;

730 
agaš
:

731 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
m­pšg
, 
šdex
, 
mask
);

732 ià(!
·ge
)

733  
	`ERR_PTR
(-
ENOMEM
);

743 ià(
	`PageCompound
(
·ge
)) {

744 
	`uÆock_·ge
(
·ge
);

745 
	`put_·ge
(
·ge
);

746  
	`ERR_PTR
(-
ETXTBSY
);

749 
»t
 = 
	`£t_·ge_ex‹Á_m­³d
(
·ge
);

750 ià(
»t
 < 0) {

751 
	`uÆock_·ge
(
·ge
);

752 
	`put_·ge
(
·ge
);

753  
	`ERR_PTR
(
»t
);

758 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

760 
	`lock_ex‹Á
(&
šode
->
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
, &
ÿched_¡©e
);

761 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
šode
, 
·ge_¡¬t
, 
PAGE_SIZE
);

762 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
,

763 &
ÿched_¡©e
);

764 ià(!
Üd”ed
)

767 
	`uÆock_·ge
(
·ge
);

768 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
Üd”ed
);

769 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

770 
	`lock_·ge
(
·ge
);

775 ià(
·ge
->
m­pšg
 !ğm­pšg || !
	`PagePriv©e
(page)) {

776 
	`uÆock_·ge
(
·ge
);

777 
	`put_·ge
(
·ge
);

778 
agaš
;

786 ià(!
	`PageU±od©e
(
·ge
)) {

787 
	`bŒfs_»ad_fŞio
(
NULL
, 
	`·ge_fŞio
(
·ge
));

788 
	`lock_·ge
(
·ge
);

789 ià(
·ge
->
m­pšg
 !ğm­pšg || !
	`PagePriv©e
(page)) {

790 
	`uÆock_·ge
(
·ge
);

791 
	`put_·ge
(
·ge
);

792 
agaš
;

794 ià(!
	`PageU±od©e
(
·ge
)) {

795 
	`uÆock_·ge
(
·ge
);

796 
	`put_·ge
(
·ge
);

797  
	`ERR_PTR
(-
EIO
);

800  
·ge
;

801 
	}
}

803 
	sdeäag_rg‘_¿nge
 {

804 
li¡_h—d
 
	mli¡
;

805 
u64
 
	m¡¬t
;

806 
u64
 
	mËn
;

823 
	$deäag_cŞËù_rg‘s
(
bŒfs_šode
 *
šode
,

824 
u64
 
¡¬t
, u64 
Ën
, 
u32
 
ex‹Á_th»sh
,

825 
u64
 
Ãw”_thª
, 
boŞ
 
do_com´ess
,

826 
boŞ
 
locked
, 
li¡_h—d
 *
rg‘_li¡
,

827 
u64
 *
Ï¡_sÿÂed_»t
)

829 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

830 
boŞ
 
Ï¡_is_rg‘
 = 
çl£
;

831 
u64
 
cur
 = 
¡¬t
;

832 
»t
 = 0;

834 
cur
 < 
¡¬t
 + 
Ën
) {

835 
ex‹Á_m­
 *
em
;

836 
deäag_rg‘_¿nge
 *
Ãw
;

837 
boŞ
 
Ãxt_m”g—bË
 = 
Œue
;

838 
u64
 
¿nge_Ën
;

840 
Ï¡_is_rg‘
 = 
çl£
;

841 
em
 = 
	`deäag_lookup_ex‹Á
(&
šode
->
vfs_šode
, 
cur
, 
Ãw”_thª
, 
locked
);

842 ià(!
em
)

851 ià(
em
->
block_¡¬t
 =ğ
EXTENT_MAP_INLINE
 &&

852 
em
->
Ën
 <ğ
šode
->
roÙ
->
fs_šfo
->
max_šlše
)

853 
Ãxt
;

856 ià(
em
->
block_¡¬t
 =ğ
EXTENT_MAP_HOLE
 ||

857 
em
->
block_¡¬t
 =ğ
EXTENT_MAP_DELALLOC
 ||

858 
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
))

859 
Ãxt
;

862 ià(
em
->
g’”©iÚ
 < 
Ãw”_thª
)

863 
Ãxt
;

866 ià(
em
->
g’”©iÚ
 =ğ(
u64
)-1)

867 
Ãxt
;

873 
¿nge_Ën
 = 
em
->
Ën
 - (
cur
 -ƒm->
¡¬t
);

894 ià(
	`‹¡_¿nge_b™
(&
šode
->
io_Œ“
, 
cur
, cu¸+ 
¿nge_Ën
 - 1,

895 
EXTENT_DELALLOC
, 0, 
NULL
))

896 
Ãxt
;

902 ià(
do_com´ess
)

903 
add
;

906 ià(
¿nge_Ën
 >ğ
ex‹Á_th»sh
)

907 
Ãxt
;

913 ià(
em
->
Ën
 >ğ
	`g‘_ex‹Á_max_ÿ·c™y
(
fs_šfo
,ƒm))

914 
Ãxt
;

922 ià(
em
->
block_¡¬t
 =ğ
EXTENT_MAP_INLINE
)

923 
add
;

925 
Ãxt_m”g—bË
 = 
	`deäag_check_Ãxt_ex‹Á
(&
šode
->
vfs_šode
, 
em
,

926 
ex‹Á_th»sh
, 
Ãw”_thª
, 
locked
);

927 ià(!
Ãxt_m”g—bË
) {

928 
deäag_rg‘_¿nge
 *
Ï¡
;

931 ià(
	`li¡_em±y
(
rg‘_li¡
))

932 
Ãxt
;

933 
Ï¡
 = 
	`li¡_’Œy
(
rg‘_li¡
->
´ev
,

934 
deäag_rg‘_¿nge
, 
li¡
);

936 ià(
Ï¡
->
¡¬t
 +†a¡->
Ën
 !ğ
cur
)

937 
Ãxt
;

942 
add
:

943 
Ï¡_is_rg‘
 = 
Œue
;

944 
¿nge_Ën
 = 
	`mš
(
	`ex‹Á_m­_’d
(
em
), 
¡¬t
 + 
Ën
è- 
cur
;

949 ià(!
	`li¡_em±y
(
rg‘_li¡
)) {

950 
deäag_rg‘_¿nge
 *
Ï¡
;

952 
Ï¡
 = 
	`li¡_’Œy
(
rg‘_li¡
->
´ev
,

953 
deäag_rg‘_¿nge
, 
li¡
);

954 
	`ASSERT
(
Ï¡
->
¡¬t
 +†a¡->
Ën
 <ğ
cur
);

955 ià(
Ï¡
->
¡¬t
 +†a¡->
Ën
 =ğ
cur
) {

957 
Ï¡
->
Ën
 +ğ
¿nge_Ën
;

958 
Ãxt
;

964 
Ãw
 = 
	`km®loc
((*Ãw), 
GFP_NOFS
);

965 ià(!
Ãw
) {

966 
	`ä“_ex‹Á_m­
(
em
);

967 
»t
 = -
ENOMEM
;

970 
Ãw
->
¡¬t
 = 
cur
;

971 
Ãw
->
Ën
 = 
¿nge_Ën
;

972 
	`li¡_add_
(&
Ãw
->
li¡
, 
rg‘_li¡
);

974 
Ãxt
:

975 
cur
 = 
	`ex‹Á_m­_’d
(
em
);

976 
	`ä“_ex‹Á_m­
(
em
);

978 ià(
»t
 < 0) {

979 
deäag_rg‘_¿nge
 *
’Œy
;

980 
deäag_rg‘_¿nge
 *
tmp
;

982 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
tmp
, 
rg‘_li¡
, 
li¡
) {

983 
	`li¡_d–_š™
(&
’Œy
->
li¡
);

984 
	`kä“
(
’Œy
);

987 ià(!
»t
 && 
Ï¡_sÿÂed_»t
) {

993 ià(!
Ï¡_is_rg‘
)

994 *
Ï¡_sÿÂed_»t
 = 
	`max
(
cur
, *last_scanned_ret);

996 *
Ï¡_sÿÂed_»t
 = 
	`max
(
¡¬t
 + 
Ën
, *last_scanned_ret);

998  
»t
;

999 
	}
}

1001 
	#CLUSTER_SIZE
 (
SZ_256K
)

	)

1002 
¡©ic_as£¹
(
PAGE_ALIGNED
(
CLUSTER_SIZE
));

1020 
	$deäag_Úe_locked_rg‘
(
bŒfs_šode
 *
šode
,

1021 
deäag_rg‘_¿nge
 *
rg‘
,

1022 
·ge
 **
·ges
, 
Ä_·ges
,

1023 
ex‹Á_¡©e
 **
ÿched_¡©e
)

1025 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

1026 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

1027 cÚ¡ 
u64
 
¡¬t
 = 
rg‘
->start;

1028 cÚ¡ 
u64
 
Ën
 = 
rg‘
->len;

1029 
Ï¡_šdex
 = (
¡¬t
 + 
Ën
 - 1è>> 
PAGE_SHIFT
;

1030 
¡¬t_šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

1031 
fœ¡_šdex
 = 
	`·ge_šdex
(
·ges
[0]);

1032 
»t
 = 0;

1033 
i
;

1035 
	`ASSERT
(
Ï¡_šdex
 - 
fœ¡_šdex
 + 1 <ğ
Ä_·ges
);

1037 
»t
 = 
	`bŒfs_d–®loc_»£rve_¥aû
(
šode
, &
d©a_»£rved
, 
¡¬t
, 
Ën
);

1038 ià(
»t
 < 0)

1039  
»t
;

1040 
	`ş—r_ex‹Á_b™
(&
šode
->
io_Œ“
, 
¡¬t
, s¹ + 
Ën
 - 1,

1041 
EXTENT_DELALLOC
 | 
EXTENT_DO_ACCOUNTING
 |

1042 
EXTENT_DEFRAG
, 
ÿched_¡©e
);

1043 
	`£t_ex‹Á_b™
(&
šode
->
io_Œ“
, 
¡¬t
, s¹ + 
Ën
 - 1,

1044 
EXTENT_DELALLOC
 | 
EXTENT_DEFRAG
, 
ÿched_¡©e
);

1047 
i
 = 
¡¬t_šdex
 - 
fœ¡_šdex
; i <ğ
Ï¡_šdex
 - first_index; i++) {

1048 
	`CË¬PageChecked
(
·ges
[
i
]);

1049 
	`bŒfs_·ge_şamp_£t_dœty
(
fs_šfo
, 
·ges
[
i
], 
¡¬t
, 
Ën
);

1051 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
šode
, 
Ën
);

1052 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

1054  
»t
;

1055 
	}
}

1057 
	$deäag_Úe_¿nge
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, 
u32
 
Ën
,

1058 
u32
 
ex‹Á_th»sh
, 
u64
 
Ãw”_thª
, 
boŞ
 
do_com´ess
,

1059 
u64
 *
Ï¡_sÿÂed_»t
)

1061 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

1062 
deäag_rg‘_¿nge
 *
’Œy
;

1063 
deäag_rg‘_¿nge
 *
tmp
;

1064 
	`LIST_HEAD
(
rg‘_li¡
);

1065 
·ge
 **
·ges
;

1066 cÚ¡ 
u32
 
£ùÜsize
 = 
šode
->
roÙ
->
fs_šfo
->sectorsize;

1067 
u64
 
Ï¡_šdex
 = (
¡¬t
 + 
Ën
 - 1è>> 
PAGE_SHIFT
;

1068 
u64
 
¡¬t_šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

1069 
Ä_·ges
 = 
Ï¡_šdex
 - 
¡¬t_šdex
 + 1;

1070 
»t
 = 0;

1071 
i
;

1073 
	`ASSERT
(
Ä_·ges
 <ğ
CLUSTER_SIZE
 / 
PAGE_SIZE
);

1074 
	`ASSERT
(
	`IS_ALIGNED
(
¡¬t
, 
£ùÜsize
è&& IS_ALIGNED(
Ën
, sectorsize));

1076 
·ges
 = 
	`kÿÎoc
(
Ä_·ges
, (
·ge
 *), 
GFP_NOFS
);

1077 ià(!
·ges
)

1078  -
ENOMEM
;

1081 
i
 = 0; i < 
Ä_·ges
; i++) {

1082 
·ges
[
i
] = 
	`deäag_´•¬e_Úe_·ge
(
šode
, 
¡¬t_šdex
 + i);

1083 ià(
	`IS_ERR
(
·ges
[
i
])) {

1084 
»t
 = 
	`PTR_ERR
(
·ges
[
i
]);

1085 
·ges
[
i
] = 
NULL
;

1086 
ä“_·ges
;

1089 
i
 = 0; i < 
Ä_·ges
; i++)

1090 
	`wa™_Ú_·ge_wr™eback
(
·ges
[
i
]);

1093 
	`lock_ex‹Á
(&
šode
->
io_Œ“
, 
¡¬t_šdex
 << 
PAGE_SHIFT
,

1094 (
Ï¡_šdex
 << 
PAGE_SHIFT
è+ 
PAGE_SIZE
 - 1,

1095 &
ÿched_¡©e
);

1103 
»t
 = 
	`deäag_cŞËù_rg‘s
(
šode
, 
¡¬t
, 
Ën
, 
ex‹Á_th»sh
,

1104 
Ãw”_thª
, 
do_com´ess
, 
Œue
,

1105 &
rg‘_li¡
, 
Ï¡_sÿÂed_»t
);

1106 ià(
»t
 < 0)

1107 
uÆock_ex‹Á
;

1109 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, &
rg‘_li¡
, 
li¡
) {

1110 
»t
 = 
	`deäag_Úe_locked_rg‘
(
šode
, 
’Œy
, 
·ges
, 
Ä_·ges
,

1111 &
ÿched_¡©e
);

1112 ià(
»t
 < 0)

1116 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
tmp
, &
rg‘_li¡
, 
li¡
) {

1117 
	`li¡_d–_š™
(&
’Œy
->
li¡
);

1118 
	`kä“
(
’Œy
);

1120 
uÆock_ex‹Á
:

1121 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
¡¬t_šdex
 << 
PAGE_SHIFT
,

1122 (
Ï¡_šdex
 << 
PAGE_SHIFT
è+ 
PAGE_SIZE
 - 1,

1123 &
ÿched_¡©e
);

1124 
ä“_·ges
:

1125 
i
 = 0; i < 
Ä_·ges
; i++) {

1126 ià(
·ges
[
i
]) {

1127 
	`uÆock_·ge
(
·ges
[
i
]);

1128 
	`put_·ge
(
·ges
[
i
]);

1131 
	`kä“
(
·ges
);

1132  
»t
;

1133 
	}
}

1135 
	$deäag_Úe_şu¡”
(
bŒfs_šode
 *
šode
,

1136 
fe_¿_¡©e
 *
¿
,

1137 
u64
 
¡¬t
, 
u32
 
Ën
, u32 
ex‹Á_th»sh
,

1138 
u64
 
Ãw”_thª
, 
boŞ
 
do_com´ess
,

1139 *
£ùÜs_deäagged
,

1140 
max_£ùÜs
,

1141 
u64
 *
Ï¡_sÿÂed_»t
)

1143 cÚ¡ 
u32
 
£ùÜsize
 = 
šode
->
roÙ
->
fs_šfo
->sectorsize;

1144 
deäag_rg‘_¿nge
 *
’Œy
;

1145 
deäag_rg‘_¿nge
 *
tmp
;

1146 
	`LIST_HEAD
(
rg‘_li¡
);

1147 
»t
;

1149 
»t
 = 
	`deäag_cŞËù_rg‘s
(
šode
, 
¡¬t
, 
Ën
, 
ex‹Á_th»sh
,

1150 
Ãw”_thª
, 
do_com´ess
, 
çl£
,

1151 &
rg‘_li¡
, 
NULL
);

1152 ià(
»t
 < 0)

1153 
out
;

1155 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, &
rg‘_li¡
, 
li¡
) {

1156 
u32
 
¿nge_Ën
 = 
’Œy
->
Ën
;

1159 ià(
max_£ùÜs
 && *
£ùÜs_deäagged
 >= max_sectors) {

1160 
»t
 = 1;

1164 ià(
max_£ùÜs
)

1165 
¿nge_Ën
 = 
	`mš_t
(
u32
,„ange_len,

1166 (
max_£ùÜs
 - *
£ùÜs_deäagged
è* 
£ùÜsize
);

1174 ià(
’Œy
->
¡¬t
 + 
¿nge_Ën
 <ğ*
Ï¡_sÿÂed_»t
)

1177 ià(
¿
)

1178 
	`·ge_ÿche_sync_»adah—d
(
šode
->
vfs_šode
.
i_m­pšg
,

1179 
¿
, 
NULL
, 
’Œy
->
¡¬t
 >> 
PAGE_SHIFT
,

1180 ((
’Œy
->
¡¬t
 + 
¿nge_Ën
 - 1è>> 
PAGE_SHIFT
) -

1181 (
’Œy
->
¡¬t
 >> 
PAGE_SHIFT
) + 1);

1188 
»t
 = 
	`deäag_Úe_¿nge
(
šode
, 
’Œy
->
¡¬t
, 
¿nge_Ën
,

1189 
ex‹Á_th»sh
, 
Ãw”_thª
, 
do_com´ess
,

1190 
Ï¡_sÿÂed_»t
);

1191 ià(
»t
 < 0)

1193 *
£ùÜs_deäagged
 +ğ
¿nge_Ën
 >>

1194 
šode
->
roÙ
->
fs_šfo
->
£ùÜsize_b™s
;

1196 
out
:

1197 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
tmp
, &
rg‘_li¡
, 
li¡
) {

1198 
	`li¡_d–_š™
(&
’Œy
->
li¡
);

1199 
	`kä“
(
’Œy
);

1201 ià(
»t
 >= 0)

1202 *
Ï¡_sÿÂed_»t
 = 
	`max
(*Ï¡_sÿÂed_»t, 
¡¬t
 + 
Ën
);

1203  
»t
;

1204 
	}
}

1222 
	$bŒfs_deäag_fe
(
šode
 *šode, 
fe_¿_¡©e
 *
¿
,

1223 
bŒfs_ioùl_deäag_¿nge_¬gs
 *
¿nge
,

1224 
u64
 
Ãw”_thª
, 
max_to_deäag
)

1226 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1227 
£ùÜs_deäagged
 = 0;

1228 
u64
 
isize
 = 
	`i_size_»ad
(
šode
);

1229 
u64
 
cur
;

1230 
u64
 
Ï¡_by‹
;

1231 
boŞ
 
do_com´ess
 = (
¿nge
->
æags
 & 
BTRFS_DEFRAG_RANGE_COMPRESS
);

1232 
boŞ
 
¿_®loÿ‹d
 = 
çl£
;

1233 
com´ess_ty³
 = 
BTRFS_COMPRESS_ZLIB
;

1234 
»t
 = 0;

1235 
u32
 
ex‹Á_th»sh
 = 
¿nge
->extent_thresh;

1236 
pgoff_t
 
¡¬t_šdex
;

1238 ià(
isize
 == 0)

1241 ià(
¿nge
->
¡¬t
 >ğ
isize
)

1242  -
EINVAL
;

1244 ià(
do_com´ess
) {

1245 ià(
¿nge
->
com´ess_ty³
 >ğ
BTRFS_NR_COMPRESS_TYPES
)

1246  -
EINVAL
;

1247 ià(
¿nge
->
com´ess_ty³
)

1248 
com´ess_ty³
 = 
¿nge
->compress_type;

1251 ià(
ex‹Á_th»sh
 == 0)

1252 
ex‹Á_th»sh
 = 
SZ_256K
;

1254 ià(
¿nge
->
¡¬t
 +„ªge->
Ën
 >„ange->start) {

1256 
Ï¡_by‹
 = 
	`mš
(
isize
, 
¿nge
->
¡¬t
 +„ªge->
Ën
);

1259 
Ï¡_by‹
 = 
isize
;

1263 
cur
 = 
	`round_down
(
¿nge
->
¡¬t
, 
fs_šfo
->
£ùÜsize
);

1264 
Ï¡_by‹
 = 
	`round_up
Öa¡_by‹, 
fs_šfo
->
£ùÜsize
) - 1;

1271 ià(!
¿
) {

1272 
¿_®loÿ‹d
 = 
Œue
;

1273 
¿
 = 
	`kz®loc
((*¿), 
GFP_KERNEL
);

1274 ià(
¿
)

1275 
	`fe_¿_¡©e_š™
(
¿
, 
šode
->
i_m­pšg
);

1282 
¡¬t_šdex
 = 
cur
 >> 
PAGE_SHIFT
;

1283 ià(
¡¬t_šdex
 < 
šode
->
i_m­pšg
->
wr™eback_šdex
)

1284 
šode
->
i_m­pšg
->
wr™eback_šdex
 = 
¡¬t_šdex
;

1286 
cur
 < 
Ï¡_by‹
) {

1287 cÚ¡ 
´ev_£ùÜs_deäagged
 = 
£ùÜs_deäagged
;

1288 
u64
 
Ï¡_sÿÂed
 = 
cur
;

1289 
u64
 
şu¡”_’d
;

1291 ià(
	`bŒfs_deäag_ÿnûÎed
(
fs_šfo
)) {

1292 
»t
 = -
EAGAIN
;

1297 
şu¡”_’d
 = (((
cur
 >> 
PAGE_SHIFT
) +

1298 (
SZ_256K
 >> 
PAGE_SHIFT
)) << PAGE_SHIFT) - 1;

1299 
şu¡”_’d
 = 
	`mš
(şu¡”_’d, 
Ï¡_by‹
);

1301 
	`bŒfs_šode_lock
(
	`BTRFS_I
(
šode
), 0);

1302 ià(
	`IS_SWAPFILE
(
šode
)) {

1303 
»t
 = -
ETXTBSY
;

1304 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 0);

1307 ià(!(
šode
->
i_sb
->
s_æags
 & 
SB_ACTIVE
)) {

1308 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 0);

1311 ià(
do_com´ess
)

1312 
	`BTRFS_I
(
šode
)->
deäag_com´ess
 = 
com´ess_ty³
;

1313 
»t
 = 
	`deäag_Úe_şu¡”
(
	`BTRFS_I
(
šode
), 
¿
, 
cur
,

1314 
şu¡”_’d
 + 1 - 
cur
, 
ex‹Á_th»sh
,

1315 
Ãw”_thª
, 
do_com´ess
, &
£ùÜs_deäagged
,

1316 
max_to_deäag
, &
Ï¡_sÿÂed
);

1318 ià(
£ùÜs_deäagged
 > 
´ev_£ùÜs_deäagged
)

1319 
	`b®ªû_dœty_·ges_¿‹lim™ed
(
šode
->
i_m­pšg
);

1321 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 0);

1322 ià(
»t
 < 0)

1324 
cur
 = 
	`max
(
şu¡”_’d
 + 1, 
Ï¡_sÿÂed
);

1325 ià(
»t
 > 0) {

1326 
»t
 = 0;

1329 
	`cÚd_»sched
();

1332 ià(
¿_®loÿ‹d
)

1333 
	`kä“
(
¿
);

1338 
¿nge
->
¡¬t
 = 
cur
;

1339 ià(
£ùÜs_deäagged
) {

1344 ià(
¿nge
->
æags
 & 
BTRFS_DEFRAG_RANGE_START_IO
) {

1345 
	`fem­_æush
(
šode
->
i_m­pšg
);

1346 ià(
	`‹¡_b™
(
BTRFS_INODE_HAS_ASYNC_EXTENT
,

1347 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
))

1348 
	`fem­_æush
(
šode
->
i_m­pšg
);

1350 ià(
¿nge
->
com´ess_ty³
 =ğ
BTRFS_COMPRESS_LZO
)

1351 
	`bŒfs_£t_fs_šcom·t
(
fs_šfo
, 
COMPRESS_LZO
);

1352 ià(
¿nge
->
com´ess_ty³
 =ğ
BTRFS_COMPRESS_ZSTD
)

1353 
	`bŒfs_£t_fs_šcom·t
(
fs_šfo
, 
COMPRESS_ZSTD
);

1354 
»t
 = 
£ùÜs_deäagged
;

1356 ià(
do_com´ess
) {

1357 
	`bŒfs_šode_lock
(
	`BTRFS_I
(
šode
), 0);

1358 
	`BTRFS_I
(
šode
)->
deäag_com´ess
 = 
BTRFS_COMPRESS_NONE
;

1359 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 0);

1361  
»t
;

1362 
	}
}

1364 
__cŞd
 
	$bŒfs_auto_deäag_ex™
()

1366 
	`kmem_ÿche_de¡roy
(
bŒfs_šode_deäag_ÿch•
);

1367 
	}
}

1369 
__š™
 
	$bŒfs_auto_deäag_š™
()

1371 
bŒfs_šode_deäag_ÿch•
 = 
	`kmem_ÿche_ü—‹
("btrfs_inode_defrag",

1372 (
šode_deäag
), 0,

1373 
SLAB_MEM_SPREAD
,

1374 
NULL
);

1375 ià(!
bŒfs_šode_deäag_ÿch•
)

1376  -
ENOMEM
;

1379 
	}
}

	@defrag.h

3 #iâdeà
BTRFS_DEFRAG_H


4 
	#BTRFS_DEFRAG_H


	)

6 
bŒfs_deäag_fe
(
šode
 *šode, 
fe_¿_¡©e
 *
¿
,

7 
bŒfs_ioùl_deäag_¿nge_¬gs
 *
¿nge
,

8 
u64
 
Ãw”_thª
, 
max_to_deäag
);

9 
__š™
 
bŒfs_auto_deäag_š™
();

10 
__cŞd
 
bŒfs_auto_deäag_ex™
();

11 
bŒfs_add_šode_deäag
(
bŒfs_Œªs_hªdË
 *
Œªs
,

12 
bŒfs_šode
 *
šode
, 
u32
 
ex‹Á_th»sh
);

13 
bŒfs_run_deäag_šodes
(
bŒfs_fs_šfo
 *
fs_šfo
);

14 
bŒfs_ş—nup_deäag_šodes
(
bŒfs_fs_šfo
 *
fs_šfo
);

15 
bŒfs_deäag_Ëaves
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
);

17 
šlše
 
	$bŒfs_deäag_ÿnûÎed
(
bŒfs_fs_šfo
 *
fs_šfo
)

19  
	`sigÇl_³ndšg
(
cu¼’t
);

20 
	}
}

	@delalloc-space.c

3 
	~"mes§ges.h
"

4 
	~"ù»e.h
"

5 
	~"d–®loc-¥aû.h
"

6 
	~"block-rsv.h
"

7 
	~"bŒfs_šode.h
"

8 
	~"¥aû-šfo.h
"

9 
	~"Œª§ùiÚ.h
"

10 
	~"qgroup.h
"

11 
	~"block-group.h
"

12 
	~"fs.h
"

116 
	$bŒfs_®loc_d©a_chunk_Údemªd
(
bŒfs_šode
 *
šode
, 
u64
 
by‹s
)

118 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

119 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

120 
bŒfs_»£rve_æush_’um
 
æush
 = 
BTRFS_RESERVE_FLUSH_DATA
;

123 
by‹s
 = 
	`ALIGN
(by‹s, 
fs_šfo
->
£ùÜsize
);

125 ià(
	`bŒfs_is_ä“_¥aû_šode
(
šode
))

126 
æush
 = 
BTRFS_RESERVE_FLUSH_FREE_SPACE_INODE
;

128  
	`bŒfs_»£rve_d©a_by‹s
(
fs_šfo
, 
by‹s
, 
æush
);

129 
	}
}

131 
	$bŒfs_check_d©a_ä“_¥aû
(
bŒfs_šode
 *
šode
,

132 
ex‹Á_chªge£t
 **
»£rved
, 
u64
 
¡¬t
,

133 
u64
 
Ën
, 
boŞ
 
noæush
)

135 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

136 
bŒfs_»£rve_æush_’um
 
æush
 = 
BTRFS_RESERVE_FLUSH_DATA
;

137 
»t
;

140 
Ën
 = 
	`round_up
(
¡¬t
 +†’, 
fs_šfo
->
£ùÜsize
) -

141 
	`round_down
(
¡¬t
, 
fs_šfo
->
£ùÜsize
);

142 
¡¬t
 = 
	`round_down
(¡¬t, 
fs_šfo
->
£ùÜsize
);

144 ià(
noæush
)

145 
æush
 = 
BTRFS_RESERVE_NO_FLUSH
;

146 ià(
	`bŒfs_is_ä“_¥aû_šode
(
šode
))

147 
æush
 = 
BTRFS_RESERVE_FLUSH_FREE_SPACE_INODE
;

149 
»t
 = 
	`bŒfs_»£rve_d©a_by‹s
(
fs_šfo
, 
Ën
, 
æush
);

150 ià(
»t
 < 0)

151  
»t
;

154 
»t
 = 
	`bŒfs_qgroup_»£rve_d©a
(
šode
, 
»£rved
, 
¡¬t
, 
Ën
);

155 ià(
»t
 < 0) {

156 
	`bŒfs_ä“_»£rved_d©a_¥aû_noquÙa
(
fs_šfo
, 
Ën
);

157 
	`ex‹Á_chªge£t_ä“
(*
»£rved
);

158 *
»£rved
 = 
NULL
;

160 
»t
 = 0;

162  
»t
;

163 
	}
}

173 
	$bŒfs_ä“_»£rved_d©a_¥aû_noquÙa
(
bŒfs_fs_šfo
 *
fs_šfo
,

174 
u64
 
Ën
)

176 
bŒfs_¥aû_šfo
 *
d©a_sšfo
;

178 
	`ASSERT
(
	`IS_ALIGNED
(
Ën
, 
fs_šfo
->
£ùÜsize
));

180 
d©a_sšfo
 = 
fs_šfo
->data_sinfo;

181 
	`bŒfs_¥aû_šfo_ä“_by‹s_may_u£
(
fs_šfo
, 
d©a_sšfo
, 
Ën
);

182 
	}
}

191 
	$bŒfs_ä“_»£rved_d©a_¥aû
(
bŒfs_šode
 *
šode
,

192 
ex‹Á_chªge£t
 *
»£rved
, 
u64
 
¡¬t
, u64 
Ën
)

194 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

197 
Ën
 = 
	`round_up
(
¡¬t
 +†’, 
fs_šfo
->
£ùÜsize
) -

198 
	`round_down
(
¡¬t
, 
fs_šfo
->
£ùÜsize
);

199 
¡¬t
 = 
	`round_down
(¡¬t, 
fs_šfo
->
£ùÜsize
);

201 
	`bŒfs_ä“_»£rved_d©a_¥aû_noquÙa
(
fs_šfo
, 
Ën
);

202 
	`bŒfs_qgroup_ä“_d©a
(
šode
, 
»£rved
, 
¡¬t
, 
Ën
, 
NULL
);

203 
	}
}

218 
	$bŒfs_šode_rsv_»Ëa£
(
bŒfs_šode
 *
šode
, 
boŞ
 
qgroup_ä“
)

220 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

221 
bŒfs_block_rsv
 *
block_rsv
 = &
šode
->block_rsv;

222 
u64
 
»Ëa£d
 = 0;

223 
u64
 
qgroup_to_»Ëa£
 = 0;

230 
»Ëa£d
 = 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
block_rsv
, 0,

231 &
qgroup_to_»Ëa£
);

232 ià(
»Ëa£d
 > 0)

233 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "delalloc",

234 
	`bŒfs_šo
(
šode
), 
»Ëa£d
, 0);

235 ià(
qgroup_ä“
)

236 
	`bŒfs_qgroup_ä“_m‘a_´—Îoc
(
šode
->
roÙ
, 
qgroup_to_»Ëa£
);

238 
	`bŒfs_qgroup_cÚv”t_»£rved_m‘a
(
šode
->
roÙ
,

239 
qgroup_to_»Ëa£
);

240 
	}
}

242 
	$bŒfs_ÿlcuÏ‹_šode_block_rsv_size
(
bŒfs_fs_šfo
 *
fs_šfo
,

243 
bŒfs_šode
 *
šode
)

245 
bŒfs_block_rsv
 *
block_rsv
 = &
šode
->block_rsv;

246 
u64
 
»£rve_size
 = 0;

247 
u64
 
qgroup_rsv_size
 = 0;

248 
u64
 
csum_Ëaves
;

249 
out¡ªdšg_ex‹Ás
;

251 
	`lockd•_as£¹_h–d
(&
šode
->
lock
);

252 
out¡ªdšg_ex‹Ás
 = 
šode
->outstanding_extents;

258 ià(
out¡ªdšg_ex‹Ás
) {

259 
»£rve_size
 = 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
,

260 
out¡ªdšg_ex‹Ás
);

261 
»£rve_size
 +ğ
	`bŒfs_ÿlc_m‘ad©a_size
(
fs_šfo
, 1);

263 
csum_Ëaves
 = 
	`bŒfs_csum_by‹s_to_Ëaves
(
fs_šfo
,

264 
šode
->
csum_by‹s
);

265 
»£rve_size
 +ğ
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
,

266 
csum_Ëaves
);

273 
qgroup_rsv_size
 = (
u64
)
out¡ªdšg_ex‹Ás
 * 
fs_šfo
->
nodesize
;

275 
	`¥š_lock
(&
block_rsv
->
lock
);

276 
block_rsv
->
size
 = 
»£rve_size
;

277 
block_rsv
->
qgroup_rsv_size
 = qgroup_rsv_size;

278 
	`¥š_uÆock
(&
block_rsv
->
lock
);

279 
	}
}

281 
	$ÿlc_šode_»£rv©iÚs
(
bŒfs_fs_šfo
 *
fs_šfo
,

282 
u64
 
num_by‹s
, u64 
disk_num_by‹s
,

283 
u64
 *
m‘a_»£rve
, u64 *
qgroup_»£rve
)

285 
u64
 
Ä_ex‹Ás
 = 
	`couÁ_max_ex‹Ás
(
fs_šfo
, 
num_by‹s
);

286 
u64
 
csum_Ëaves
 = 
	`bŒfs_csum_by‹s_to_Ëaves
(
fs_šfo
, 
disk_num_by‹s
);

287 
u64
 
šode_upd©e
 = 
	`bŒfs_ÿlc_m‘ad©a_size
(
fs_šfo
, 1);

289 *
m‘a_»£rve
 = 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
,

290 
Ä_ex‹Ás
 + 
csum_Ëaves
);

296 *
m‘a_»£rve
 +ğ
šode_upd©e
;

297 *
qgroup_»£rve
 = 
Ä_ex‹Ás
 * 
fs_šfo
->
nodesize
;

298 
	}
}

300 
	$bŒfs_d–®loc_»£rve_m‘ad©a
(
bŒfs_šode
 *
šode
, 
u64
 
num_by‹s
,

301 
u64
 
disk_num_by‹s
, 
boŞ
 
noæush
)

303 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

304 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

305 
bŒfs_block_rsv
 *
block_rsv
 = &
šode
->block_rsv;

306 
u64
 
m‘a_»£rve
, 
qgroup_»£rve
;

307 
Ä_ex‹Ás
;

308 
bŒfs_»£rve_æush_’um
 
æush
 = 
BTRFS_RESERVE_FLUSH_ALL
;

309 
»t
 = 0;

320 ià(
noæush
 || 
	`bŒfs_is_ä“_¥aû_šode
(
šode
)) {

321 
æush
 = 
BTRFS_RESERVE_NO_FLUSH
;

323 ià(
cu¼’t
->
jouº®_šfo
)

324 
æush
 = 
BTRFS_RESERVE_FLUSH_LIMIT
;

327 
num_by‹s
 = 
	`ALIGN
Òum_by‹s, 
fs_šfo
->
£ùÜsize
);

328 
disk_num_by‹s
 = 
	`ALIGN
(disk_num_by‹s, 
fs_šfo
->
£ùÜsize
);

340 
	`ÿlc_šode_»£rv©iÚs
(
fs_šfo
, 
num_by‹s
, 
disk_num_by‹s
,

341 &
m‘a_»£rve
, &
qgroup_»£rve
);

342 
»t
 = 
	`bŒfs_qgroup_»£rve_m‘a_´—Îoc
(
roÙ
, 
qgroup_»£rve
, 
Œue
,

343 
noæush
);

344 ià(
»t
)

345  
»t
;

346 
»t
 = 
	`bŒfs_»£rve_m‘ad©a_by‹s
(
fs_šfo
, 
block_rsv
, 
m‘a_»£rve
, 
æush
);

347 ià(
»t
) {

348 
	`bŒfs_qgroup_ä“_m‘a_´—Îoc
(
roÙ
, 
qgroup_»£rve
);

349  
»t
;

358 
Ä_ex‹Ás
 = 
	`couÁ_max_ex‹Ás
(
fs_šfo
, 
num_by‹s
);

359 
	`¥š_lock
(&
šode
->
lock
);

360 
	`bŒfs_mod_out¡ªdšg_ex‹Ás
(
šode
, 
Ä_ex‹Ás
);

361 
šode
->
csum_by‹s
 +ğ
disk_num_by‹s
;

362 
	`bŒfs_ÿlcuÏ‹_šode_block_rsv_size
(
fs_šfo
, 
šode
);

363 
	`¥š_uÆock
(&
šode
->
lock
);

366 
	`bŒfs_block_rsv_add_by‹s
(
block_rsv
, 
m‘a_»£rve
, 
çl£
);

367 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
roÙ
->
fs_šfo
, "delalloc",

368 
	`bŒfs_šo
(
šode
), 
m‘a_»£rve
, 1);

370 
	`¥š_lock
(&
block_rsv
->
lock
);

371 
block_rsv
->
qgroup_rsv_»£rved
 +ğ
qgroup_»£rve
;

372 
	`¥š_uÆock
(&
block_rsv
->
lock
);

375 
	}
}

388 
	$bŒfs_d–®loc_»Ëa£_m‘ad©a
(
bŒfs_šode
 *
šode
, 
u64
 
num_by‹s
,

389 
boŞ
 
qgroup_ä“
)

391 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

393 
num_by‹s
 = 
	`ALIGN
Òum_by‹s, 
fs_šfo
->
£ùÜsize
);

394 
	`¥š_lock
(&
šode
->
lock
);

395 
šode
->
csum_by‹s
 -ğ
num_by‹s
;

396 
	`bŒfs_ÿlcuÏ‹_šode_block_rsv_size
(
fs_šfo
, 
šode
);

397 
	`¥š_uÆock
(&
šode
->
lock
);

399 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
))

402 
	`bŒfs_šode_rsv_»Ëa£
(
šode
, 
qgroup_ä“
);

403 
	}
}

417 
	$bŒfs_d–®loc_»Ëa£_ex‹Ás
(
bŒfs_šode
 *
šode
, 
u64
 
num_by‹s
)

419 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

420 
num_ex‹Ás
;

422 
	`¥š_lock
(&
šode
->
lock
);

423 
num_ex‹Ás
 = 
	`couÁ_max_ex‹Ás
(
fs_šfo
, 
num_by‹s
);

424 
	`bŒfs_mod_out¡ªdšg_ex‹Ás
(
šode
, -
num_ex‹Ás
);

425 
	`bŒfs_ÿlcuÏ‹_šode_block_rsv_size
(
fs_šfo
, 
šode
);

426 
	`¥š_uÆock
(&
šode
->
lock
);

428 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
))

431 
	`bŒfs_šode_rsv_»Ëa£
(
šode
, 
Œue
);

432 
	}
}

459 
	$bŒfs_d–®loc_»£rve_¥aû
(
bŒfs_šode
 *
šode
,

460 
ex‹Á_chªge£t
 **
»£rved
, 
u64
 
¡¬t
, u64 
Ën
)

462 
»t
;

464 
»t
 = 
	`bŒfs_check_d©a_ä“_¥aû
(
šode
, 
»£rved
, 
¡¬t
, 
Ën
, 
çl£
);

465 ià(
»t
 < 0)

466  
»t
;

467 
»t
 = 
	`bŒfs_d–®loc_»£rve_m‘ad©a
(
šode
, 
Ën
,†’, 
çl£
);

468 ià(
»t
 < 0) {

469 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
šode
, *
»£rved
, 
¡¬t
, 
Ën
);

470 
	`ex‹Á_chªge£t_ä“
(*
»£rved
);

471 *
»£rved
 = 
NULL
;

473  
»t
;

474 
	}
}

490 
	$bŒfs_d–®loc_»Ëa£_¥aû
(
bŒfs_šode
 *
šode
,

491 
ex‹Á_chªge£t
 *
»£rved
,

492 
u64
 
¡¬t
, u64 
Ën
, 
boŞ
 
qgroup_ä“
)

494 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
šode
, 
Ën
, 
qgroup_ä“
);

495 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
šode
, 
»£rved
, 
¡¬t
, 
Ën
);

496 
	}
}

	@delalloc-space.h

3 #iâdeà
BTRFS_DELALLOC_SPACE_H


4 
	#BTRFS_DELALLOC_SPACE_H


	)

6 
	gex‹Á_chªge£t
;

8 
bŒfs_®loc_d©a_chunk_Údemªd
(
bŒfs_šode
 *
šode
, 
u64
 
by‹s
);

9 
bŒfs_check_d©a_ä“_¥aû
(
bŒfs_šode
 *
šode
,

10 
ex‹Á_chªge£t
 **
»£rved
, 
u64
 
¡¬t
, u64 
Ën
,

11 
boŞ
 
noæush
);

12 
bŒfs_ä“_»£rved_d©a_¥aû
(
bŒfs_šode
 *
šode
,

13 
ex‹Á_chªge£t
 *
»£rved
, 
u64
 
¡¬t
, u64 
Ën
);

14 
bŒfs_d–®loc_»Ëa£_¥aû
(
bŒfs_šode
 *
šode
,

15 
ex‹Á_chªge£t
 *
»£rved
,

16 
u64
 
¡¬t
, u64 
Ën
, 
boŞ
 
qgroup_ä“
);

17 
bŒfs_ä“_»£rved_d©a_¥aû_noquÙa
(
bŒfs_fs_šfo
 *
fs_šfo
,

18 
u64
 
Ën
);

19 
bŒfs_d–®loc_»Ëa£_m‘ad©a
(
bŒfs_šode
 *
šode
, 
u64
 
num_by‹s
,

20 
boŞ
 
qgroup_ä“
);

21 
bŒfs_d–®loc_»£rve_¥aû
(
bŒfs_šode
 *
šode
,

22 
ex‹Á_chªge£t
 **
»£rved
, 
u64
 
¡¬t
, u64 
Ën
);

23 
bŒfs_d–®loc_»£rve_m‘ad©a
(
bŒfs_šode
 *
šode
, 
u64
 
num_by‹s
,

24 
u64
 
disk_num_by‹s
, 
boŞ
 
noæush
);

25 
bŒfs_d–®loc_»Ëa£_ex‹Ás
(
bŒfs_šode
 *
šode
, 
u64
 
num_by‹s
);

	@delayed-inode.c

7 
	~<lšux/¦ab.h
>

8 
	~<lšux/iv”siÚ.h
>

9 
	~"ù»e.h
"

10 
	~"fs.h
"

11 
	~"mes§ges.h
"

12 
	~"misc.h
"

13 
	~"d–ayed-šode.h
"

14 
	~"disk-io.h
"

15 
	~"Œª§ùiÚ.h
"

16 
	~"qgroup.h
"

17 
	~"lockšg.h
"

18 
	~"šode-™em.h
"

19 
	~"¥aû-šfo.h
"

20 
	~"acûssÜs.h
"

21 
	~"fe-™em.h
"

22 
	~"su³r.h
"

24 
	#BTRFS_DELAYED_WRITEBACK
 512

	)

25 
	#BTRFS_DELAYED_BACKGROUND
 128

	)

26 
	#BTRFS_DELAYED_BATCH
 16

	)

28 
kmem_ÿche
 *
	gd–ayed_node_ÿche
;

30 
__š™
 
	$bŒfs_d–ayed_šode_š™
()

32 
d–ayed_node_ÿche
 = 
	`kmem_ÿche_ü—‹
("btrfs_delayed_node",

33 (
bŒfs_d–ayed_node
),

35 
SLAB_MEM_SPREAD
,

36 
NULL
);

37 ià(!
d–ayed_node_ÿche
)

38  -
ENOMEM
;

40 
	}
}

42 
__cŞd
 
	$bŒfs_d–ayed_šode_ex™
()

44 
	`kmem_ÿche_de¡roy
(
d–ayed_node_ÿche
);

45 
	}
}

47 
šlše
 
	$bŒfs_š™_d–ayed_node
(

48 
bŒfs_d–ayed_node
 *
d–ayed_node
,

49 
bŒfs_roÙ
 *
roÙ
, 
u64
 
šode_id
)

51 
d–ayed_node
->
roÙ
 =„oot;

52 
d–ayed_node
->
šode_id
 = inode_id;

53 
	`»fcouÁ_£t
(&
d–ayed_node
->
»fs
, 0);

54 
d–ayed_node
->
šs_roÙ
 = 
RB_ROOT_CACHED
;

55 
d–ayed_node
->
d–_roÙ
 = 
RB_ROOT_CACHED
;

56 
	`mu‹x_š™
(&
d–ayed_node
->
mu‹x
);

57 
	`INIT_LIST_HEAD
(&
d–ayed_node
->
n_li¡
);

58 
	`INIT_LIST_HEAD
(&
d–ayed_node
->
p_li¡
);

59 
	}
}

61 
bŒfs_d–ayed_node
 *
	$bŒfs_g‘_d–ayed_node
(

62 
bŒfs_šode
 *btrfs_inode)

64 
bŒfs_roÙ
 *
roÙ
 = 
bŒfs_šode
->root;

65 
u64
 
šo
 = 
	`bŒfs_šo
(
bŒfs_šode
);

66 
bŒfs_d–ayed_node
 *
node
;

68 
node
 = 
	`READ_ONCE
(
bŒfs_šode
->
d–ayed_node
);

69 ià(
node
) {

70 
	`»fcouÁ_šc
(&
node
->
»fs
);

71  
node
;

74 
	`¥š_lock
(&
roÙ
->
šode_lock
);

75 
node
 = 
	`¿dix_Œ“_lookup
(&
roÙ
->
d–ayed_nodes_Œ“
, 
šo
);

77 ià(
node
) {

78 ià(
bŒfs_šode
->
d–ayed_node
) {

79 
	`»fcouÁ_šc
(&
node
->
»fs
);

80 
	`BUG_ON
(
bŒfs_šode
->
d–ayed_node
 !ğ
node
);

81 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

82  
node
;

101 ià(
	`»fcouÁ_šc_nÙ_z”o
(&
node
->
»fs
)) {

102 
	`»fcouÁ_šc
(&
node
->
»fs
);

103 
bŒfs_šode
->
d–ayed_node
 = 
node
;

105 
node
 = 
NULL
;

108 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

109  
node
;

111 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

113  
NULL
;

114 
	}
}

117 
bŒfs_d–ayed_node
 *
	$bŒfs_g‘_Ü_ü—‹_d–ayed_node
(

118 
bŒfs_šode
 *btrfs_inode)

120 
bŒfs_d–ayed_node
 *
node
;

121 
bŒfs_roÙ
 *
roÙ
 = 
bŒfs_šode
->root;

122 
u64
 
šo
 = 
	`bŒfs_šo
(
bŒfs_šode
);

123 
»t
;

125 
agaš
:

126 
node
 = 
	`bŒfs_g‘_d–ayed_node
(
bŒfs_šode
);

127 ià(
node
)

128  
node
;

130 
node
 = 
	`kmem_ÿche_z®loc
(
d–ayed_node_ÿche
, 
GFP_NOFS
);

131 ià(!
node
)

132  
	`ERR_PTR
(-
ENOMEM
);

133 
	`bŒfs_š™_d–ayed_node
(
node
, 
roÙ
, 
šo
);

136 
	`»fcouÁ_£t
(&
node
->
»fs
, 2);

138 
»t
 = 
	`¿dix_Œ“_´–ßd
(
GFP_NOFS
);

139 ià(
»t
) {

140 
	`kmem_ÿche_ä“
(
d–ayed_node_ÿche
, 
node
);

141  
	`ERR_PTR
(
»t
);

144 
	`¥š_lock
(&
roÙ
->
šode_lock
);

145 
»t
 = 
	`¿dix_Œ“_š£¹
(&
roÙ
->
d–ayed_nodes_Œ“
, 
šo
, 
node
);

146 ià(
»t
 =ğ-
EEXIST
) {

147 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

148 
	`kmem_ÿche_ä“
(
d–ayed_node_ÿche
, 
node
);

149 
	`¿dix_Œ“_´–ßd_’d
();

150 
agaš
;

152 
bŒfs_šode
->
d–ayed_node
 = 
node
;

153 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

154 
	`¿dix_Œ“_´–ßd_’d
();

156  
node
;

157 
	}
}

164 
	$bŒfs_queue_d–ayed_node
(
bŒfs_d–ayed_roÙ
 *
roÙ
,

165 
bŒfs_d–ayed_node
 *
node
,

166 
mod
)

168 
	`¥š_lock
(&
roÙ
->
lock
);

169 ià(
	`‹¡_b™
(
BTRFS_DELAYED_NODE_IN_LIST
, &
node
->
æags
)) {

170 ià(!
	`li¡_em±y
(&
node
->
p_li¡
))

171 
	`li¡_move_
(&
node
->
p_li¡
, &
roÙ
->
´•¬e_li¡
);

172 ià(
mod
)

173 
	`li¡_add_
(&
node
->
p_li¡
, &
roÙ
->
´•¬e_li¡
);

175 
	`li¡_add_
(&
node
->
n_li¡
, &
roÙ
->
node_li¡
);

176 
	`li¡_add_
(&
node
->
p_li¡
, &
roÙ
->
´•¬e_li¡
);

177 
	`»fcouÁ_šc
(&
node
->
»fs
);

178 
roÙ
->
nodes
++;

179 
	`£t_b™
(
BTRFS_DELAYED_NODE_IN_LIST
, &
node
->
æags
);

181 
	`¥š_uÆock
(&
roÙ
->
lock
);

182 
	}
}

185 
	$bŒfs_dequeue_d–ayed_node
(
bŒfs_d–ayed_roÙ
 *
roÙ
,

186 
bŒfs_d–ayed_node
 *
node
)

188 
	`¥š_lock
(&
roÙ
->
lock
);

189 ià(
	`‹¡_b™
(
BTRFS_DELAYED_NODE_IN_LIST
, &
node
->
æags
)) {

190 
roÙ
->
nodes
--;

191 
	`»fcouÁ_dec
(&
node
->
»fs
);

192 
	`li¡_d–_š™
(&
node
->
n_li¡
);

193 ià(!
	`li¡_em±y
(&
node
->
p_li¡
))

194 
	`li¡_d–_š™
(&
node
->
p_li¡
);

195 
	`ş—r_b™
(
BTRFS_DELAYED_NODE_IN_LIST
, &
node
->
æags
);

197 
	`¥š_uÆock
(&
roÙ
->
lock
);

198 
	}
}

200 
bŒfs_d–ayed_node
 *
	$bŒfs_fœ¡_d–ayed_node
(

201 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
)

203 
li¡_h—d
 *
p
;

204 
bŒfs_d–ayed_node
 *
node
 = 
NULL
;

206 
	`¥š_lock
(&
d–ayed_roÙ
->
lock
);

207 ià(
	`li¡_em±y
(&
d–ayed_roÙ
->
node_li¡
))

208 
out
;

210 
p
 = 
d–ayed_roÙ
->
node_li¡
.
Ãxt
;

211 
node
 = 
	`li¡_’Œy
(
p
, 
bŒfs_d–ayed_node
, 
n_li¡
);

212 
	`»fcouÁ_šc
(&
node
->
»fs
);

213 
out
:

214 
	`¥š_uÆock
(&
d–ayed_roÙ
->
lock
);

216  
node
;

217 
	}
}

219 
bŒfs_d–ayed_node
 *
	$bŒfs_Ãxt_d–ayed_node
(

220 
bŒfs_d–ayed_node
 *
node
)

222 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
;

223 
li¡_h—d
 *
p
;

224 
bŒfs_d–ayed_node
 *
Ãxt
 = 
NULL
;

226 
d–ayed_roÙ
 = 
node
->
roÙ
->
fs_šfo
->delayed_root;

227 
	`¥š_lock
(&
d–ayed_roÙ
->
lock
);

228 ià(!
	`‹¡_b™
(
BTRFS_DELAYED_NODE_IN_LIST
, &
node
->
æags
)) {

230 ià(
	`li¡_em±y
(&
d–ayed_roÙ
->
node_li¡
))

231 
out
;

232 
p
 = 
d–ayed_roÙ
->
node_li¡
.
Ãxt
;

233 } ià(
	`li¡_is_Ï¡
(&
node
->
n_li¡
, &
d–ayed_roÙ
->
node_li¡
))

234 
out
;

236 
p
 = 
node
->
n_li¡
.
Ãxt
;

238 
Ãxt
 = 
	`li¡_’Œy
(
p
, 
bŒfs_d–ayed_node
, 
n_li¡
);

239 
	`»fcouÁ_šc
(&
Ãxt
->
»fs
);

240 
out
:

241 
	`¥š_uÆock
(&
d–ayed_roÙ
->
lock
);

243  
Ãxt
;

244 
	}
}

246 
	$__bŒfs_»Ëa£_d–ayed_node
(

247 
bŒfs_d–ayed_node
 *
d–ayed_node
,

248 
mod
)

250 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
;

252 ià(!
d–ayed_node
)

255 
d–ayed_roÙ
 = 
d–ayed_node
->
roÙ
->
fs_šfo
->delayed_root;

257 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

258 ià(
d–ayed_node
->
couÁ
)

259 
	`bŒfs_queue_d–ayed_node
(
d–ayed_roÙ
, 
d–ayed_node
, 
mod
);

261 
	`bŒfs_dequeue_d–ayed_node
(
d–ayed_roÙ
, 
d–ayed_node
);

262 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

264 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
d–ayed_node
->
»fs
)) {

265 
bŒfs_roÙ
 *
roÙ
 = 
d–ayed_node
->root;

267 
	`¥š_lock
(&
roÙ
->
šode_lock
);

272 
	`ASSERT
(
	`»fcouÁ_»ad
(&
d–ayed_node
->
»fs
) == 0);

273 
	`¿dix_Œ“_d–‘e
(&
roÙ
->
d–ayed_nodes_Œ“
,

274 
d–ayed_node
->
šode_id
);

275 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

276 
	`kmem_ÿche_ä“
(
d–ayed_node_ÿche
, 
d–ayed_node
);

278 
	}
}

280 
šlše
 
	$bŒfs_»Ëa£_d–ayed_node
(
bŒfs_d–ayed_node
 *
node
)

282 
	`__bŒfs_»Ëa£_d–ayed_node
(
node
, 0);

283 
	}
}

285 
bŒfs_d–ayed_node
 *
	$bŒfs_fœ¡_´•¬ed_d–ayed_node
(

286 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
)

288 
li¡_h—d
 *
p
;

289 
bŒfs_d–ayed_node
 *
node
 = 
NULL
;

291 
	`¥š_lock
(&
d–ayed_roÙ
->
lock
);

292 ià(
	`li¡_em±y
(&
d–ayed_roÙ
->
´•¬e_li¡
))

293 
out
;

295 
p
 = 
d–ayed_roÙ
->
´•¬e_li¡
.
Ãxt
;

296 
	`li¡_d–_š™
(
p
);

297 
node
 = 
	`li¡_’Œy
(
p
, 
bŒfs_d–ayed_node
, 
p_li¡
);

298 
	`»fcouÁ_šc
(&
node
->
»fs
);

299 
out
:

300 
	`¥š_uÆock
(&
d–ayed_roÙ
->
lock
);

302  
node
;

303 
	}
}

305 
šlše
 
	$bŒfs_»Ëa£_´•¬ed_d–ayed_node
(

306 
bŒfs_d–ayed_node
 *
node
)

308 
	`__bŒfs_»Ëa£_d–ayed_node
(
node
, 1);

309 
	}
}

311 
bŒfs_d–ayed_™em
 *
	$bŒfs_®loc_d–ayed_™em
(
u16
 
d©a_Ën
,

312 
bŒfs_d–ayed_node
 *
node
,

313 
bŒfs_d–ayed_™em_ty³
 
ty³
)

315 
bŒfs_d–ayed_™em
 *
™em
;

317 
™em
 = 
	`km®loc
(
	`¡ruù_size
(™em, 
d©a
, 
d©a_Ën
), 
GFP_NOFS
);

318 ià(
™em
) {

319 
™em
->
d©a_Ën
 = data_len;

320 
™em
->
ty³
 =ype;

321 
™em
->
by‹s_»£rved
 = 0;

322 
™em
->
d–ayed_node
 = 
node
;

323 
	`RB_CLEAR_NODE
(&
™em
->
rb_node
);

324 
	`INIT_LIST_HEAD
(&
™em
->
log_li¡
);

325 
™em
->
logged
 = 
çl£
;

326 
	`»fcouÁ_£t
(&
™em
->
»fs
, 1);

328  
™em
;

329 
	}
}

339 
bŒfs_d–ayed_™em
 *
	$__bŒfs_lookup_d–ayed_™em
(

340 
rb_roÙ
 *
roÙ
,

341 
u64
 
šdex
)

343 
rb_node
 *
node
 = 
roÙ
->rb_node;

344 
bŒfs_d–ayed_™em
 *
d–ayed_™em
 = 
NULL
;

346 
node
) {

347 
d–ayed_™em
 = 
	`rb_’Œy
(
node
, 
bŒfs_d–ayed_™em
,

348 
rb_node
);

349 ià(
d–ayed_™em
->
šdex
 < index)

350 
node
 =‚ode->
rb_right
;

351 ià(
d–ayed_™em
->
šdex
 > index)

352 
node
 =‚ode->
rb_Ëá
;

354  
d–ayed_™em
;

357  
NULL
;

358 
	}
}

360 
	$__bŒfs_add_d–ayed_™em
(
bŒfs_d–ayed_node
 *
d–ayed_node
,

361 
bŒfs_d–ayed_™em
 *
šs
)

363 
rb_node
 **
p
, *
node
;

364 
rb_node
 *
·»Á_node
 = 
NULL
;

365 
rb_roÙ_ÿched
 *
roÙ
;

366 
bŒfs_d–ayed_™em
 *
™em
;

367 
boŞ
 
Ëámo¡
 = 
Œue
;

369 ià(
šs
->
ty³
 =ğ
BTRFS_DELAYED_INSERTION_ITEM
)

370 
roÙ
 = &
d–ayed_node
->
šs_roÙ
;

372 
roÙ
 = &
d–ayed_node
->
d–_roÙ
;

374 
p
 = &
roÙ
->
rb_roÙ
.
rb_node
;

375 
node
 = &
šs
->
rb_node
;

377 *
p
) {

378 
·»Á_node
 = *
p
;

379 
™em
 = 
	`rb_’Œy
(
·»Á_node
, 
bŒfs_d–ayed_™em
,

380 
rb_node
);

382 ià(
™em
->
šdex
 < 
šs
->index) {

383 
p
 = &(*p)->
rb_right
;

384 
Ëámo¡
 = 
çl£
;

385 } ià(
™em
->
šdex
 > 
šs
->index) {

386 
p
 = &(*p)->
rb_Ëá
;

388  -
EEXIST
;

392 
	`rb_lšk_node
(
node
, 
·»Á_node
, 
p
);

393 
	`rb_š£¹_cŞÜ_ÿched
(
node
, 
roÙ
, 
Ëámo¡
);

395 ià(
šs
->
ty³
 =ğ
BTRFS_DELAYED_INSERTION_ITEM
 &&

396 
šs
->
šdex
 >ğ
d–ayed_node
->
šdex_út
)

397 
d–ayed_node
->
šdex_út
 = 
šs
->
šdex
 + 1;

399 
d–ayed_node
->
couÁ
++;

400 
	`©omic_šc
(&
d–ayed_node
->
roÙ
->
fs_šfo
->
d–ayed_roÙ
->
™ems
);

402 
	}
}

404 
	$fšish_Úe_™em
(
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
)

406 
£q
 = 
	`©omic_šc_»tuº
(&
d–ayed_roÙ
->
™ems_£q
);

409 ià((
	`©omic_dec_»tuº
(&
d–ayed_roÙ
->
™ems
) <

410 
BTRFS_DELAYED_BACKGROUND
 || 
£q
 % 
BTRFS_DELAYED_BATCH
 == 0))

411 
	`cÚd_wake_up_nomb
(&
d–ayed_roÙ
->
wa™
);

412 
	}
}

414 
	$__bŒfs_»move_d–ayed_™em
(
bŒfs_d–ayed_™em
 *
d–ayed_™em
)

416 
bŒfs_d–ayed_node
 *
d–ayed_node
 = 
d–ayed_™em
->delayed_node;

417 
rb_roÙ_ÿched
 *
roÙ
;

418 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
;

421 ià(
	`RB_EMPTY_NODE
(&
d–ayed_™em
->
rb_node
))

425 
	`lockd•_as£¹_h–d
(&
d–ayed_node
->
mu‹x
);

427 
d–ayed_roÙ
 = 
d–ayed_node
->
roÙ
->
fs_šfo
->delayed_root;

429 
	`BUG_ON
(!
d–ayed_roÙ
);

431 ià(
d–ayed_™em
->
ty³
 =ğ
BTRFS_DELAYED_INSERTION_ITEM
)

432 
roÙ
 = &
d–ayed_node
->
šs_roÙ
;

434 
roÙ
 = &
d–ayed_node
->
d–_roÙ
;

436 
	`rb_”a£_ÿched
(&
d–ayed_™em
->
rb_node
, 
roÙ
);

437 
	`RB_CLEAR_NODE
(&
d–ayed_™em
->
rb_node
);

438 
d–ayed_node
->
couÁ
--;

440 
	`fšish_Úe_™em
(
d–ayed_roÙ
);

441 
	}
}

443 
	$bŒfs_»Ëa£_d–ayed_™em
(
bŒfs_d–ayed_™em
 *
™em
)

445 ià(
™em
) {

446 
	`__bŒfs_»move_d–ayed_™em
(
™em
);

447 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
™em
->
»fs
))

448 
	`kä“
(
™em
);

450 
	}
}

452 
bŒfs_d–ayed_™em
 *
	$__bŒfs_fœ¡_d–ayed_š£¹iÚ_™em
(

453 
bŒfs_d–ayed_node
 *
d–ayed_node
)

455 
rb_node
 *
p
;

456 
bŒfs_d–ayed_™em
 *
™em
 = 
NULL
;

458 
p
 = 
	`rb_fœ¡_ÿched
(&
d–ayed_node
->
šs_roÙ
);

459 ià(
p
)

460 
™em
 = 
	`rb_’Œy
(
p
, 
bŒfs_d–ayed_™em
, 
rb_node
);

462  
™em
;

463 
	}
}

465 
bŒfs_d–ayed_™em
 *
	$__bŒfs_fœ¡_d–ayed_d–‘iÚ_™em
(

466 
bŒfs_d–ayed_node
 *
d–ayed_node
)

468 
rb_node
 *
p
;

469 
bŒfs_d–ayed_™em
 *
™em
 = 
NULL
;

471 
p
 = 
	`rb_fœ¡_ÿched
(&
d–ayed_node
->
d–_roÙ
);

472 ià(
p
)

473 
™em
 = 
	`rb_’Œy
(
p
, 
bŒfs_d–ayed_™em
, 
rb_node
);

475  
™em
;

476 
	}
}

478 
bŒfs_d–ayed_™em
 *
	$__bŒfs_Ãxt_d–ayed_™em
(

479 
bŒfs_d–ayed_™em
 *
™em
)

481 
rb_node
 *
p
;

482 
bŒfs_d–ayed_™em
 *
Ãxt
 = 
NULL
;

484 
p
 = 
	`rb_Ãxt
(&
™em
->
rb_node
);

485 ià(
p
)

486 
Ãxt
 = 
	`rb_’Œy
(
p
, 
bŒfs_d–ayed_™em
, 
rb_node
);

488  
Ãxt
;

489 
	}
}

491 
	$bŒfs_d–ayed_™em_»£rve_m‘ad©a
(
bŒfs_Œªs_hªdË
 *
Œªs
,

492 
bŒfs_d–ayed_™em
 *
™em
)

494 
bŒfs_block_rsv
 *
¤c_rsv
;

495 
bŒfs_block_rsv
 *
d¡_rsv
;

496 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

497 
u64
 
num_by‹s
;

498 
»t
;

500 ià(!
Œªs
->
by‹s_»£rved
)

503 
¤c_rsv
 = 
Œªs
->
block_rsv
;

504 
d¡_rsv
 = &
fs_šfo
->
d–ayed_block_rsv
;

506 
num_by‹s
 = 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
, 1);

513 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(
¤c_rsv
, 
d¡_rsv
, 
num_by‹s
, 
Œue
);

514 ià(!
»t
) {

515 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "delayed_item",

516 
™em
->
d–ayed_node
->
šode_id
,

517 
num_by‹s
, 1);

523 ià(
™em
->
ty³
 =ğ
BTRFS_DELAYED_DELETION_ITEM
)

524 
™em
->
by‹s_»£rved
 = 
num_by‹s
;

527  
»t
;

528 
	}
}

530 
	$bŒfs_d–ayed_™em_»Ëa£_m‘ad©a
(
bŒfs_roÙ
 *
roÙ
,

531 
bŒfs_d–ayed_™em
 *
™em
)

533 
bŒfs_block_rsv
 *
rsv
;

534 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

536 ià(!
™em
->
by‹s_»£rved
)

539 
rsv
 = &
fs_šfo
->
d–ayed_block_rsv
;

544 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "delayed_item",

545 
™em
->
d–ayed_node
->
šode_id
,

546 
™em
->
by‹s_»£rved
, 0);

547 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rsv
, 
™em
->
by‹s_»£rved
, 
NULL
);

548 
	}
}

550 
	$bŒfs_d–ayed_™em_»Ëa£_Ëaves
(
bŒfs_d–ayed_node
 *
node
,

551 
num_Ëaves
)

553 
bŒfs_fs_šfo
 *
fs_šfo
 = 
node
->
roÙ
->fs_info;

554 cÚ¡ 
u64
 
by‹s
 = 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
, 
num_Ëaves
);

557 ià(
	`‹¡_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
))

560 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "d–ayed_™em", 
node
->
šode_id
,

561 
by‹s
, 0);

562 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, &fs_šfo->
d–ayed_block_rsv
, 
by‹s
, 
NULL
);

563 
	}
}

565 
	$bŒfs_d–ayed_šode_»£rve_m‘ad©a
(

566 
bŒfs_Œªs_hªdË
 *
Œªs
,

567 
bŒfs_roÙ
 *
roÙ
,

568 
bŒfs_d–ayed_node
 *
node
)

570 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

571 
bŒfs_block_rsv
 *
¤c_rsv
;

572 
bŒfs_block_rsv
 *
d¡_rsv
;

573 
u64
 
num_by‹s
;

574 
»t
;

576 
¤c_rsv
 = 
Œªs
->
block_rsv
;

577 
d¡_rsv
 = &
fs_šfo
->
d–ayed_block_rsv
;

579 
num_by‹s
 = 
	`bŒfs_ÿlc_m‘ad©a_size
(
fs_šfo
, 1);

590 ià(!
¤c_rsv
 || (!
Œªs
->
by‹s_»£rved
 &&

591 
¤c_rsv
->
ty³
 !ğ
BTRFS_BLOCK_RSV_DELALLOC
)) {

592 
»t
 = 
	`bŒfs_qgroup_»£rve_m‘a
(
roÙ
, 
num_by‹s
,

593 
BTRFS_QGROUP_RSV_META_PREALLOC
, 
Œue
);

594 ià(
»t
 < 0)

595  
»t
;

596 
»t
 = 
	`bŒfs_block_rsv_add
(
fs_šfo
, 
d¡_rsv
, 
num_by‹s
,

597 
BTRFS_RESERVE_NO_FLUSH
);

599 
	`ASSERT
(
»t
 =ğ0 ||„‘ =ğ-
ENOSPC
);

600 ià(
»t
)

601 
	`bŒfs_qgroup_ä“_m‘a_´—Îoc
(
roÙ
, 
num_by‹s
);

603 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(
¤c_rsv
, 
d¡_rsv
, 
num_by‹s
, 
Œue
);

606 ià(!
»t
) {

607 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "delayed_inode",

608 
node
->
šode_id
, 
num_by‹s
, 1);

609 
node
->
by‹s_»£rved
 = 
num_by‹s
;

612  
»t
;

613 
	}
}

615 
	$bŒfs_d–ayed_šode_»Ëa£_m‘ad©a
(
bŒfs_fs_šfo
 *
fs_šfo
,

616 
bŒfs_d–ayed_node
 *
node
,

617 
boŞ
 
qgroup_ä“
)

619 
bŒfs_block_rsv
 *
rsv
;

621 ià(!
node
->
by‹s_»£rved
)

624 
rsv
 = &
fs_šfo
->
d–ayed_block_rsv
;

625 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "delayed_inode",

626 
node
->
šode_id
,‚ode->
by‹s_»£rved
, 0);

627 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rsv
, 
node
->
by‹s_»£rved
, 
NULL
);

628 ià(
qgroup_ä“
)

629 
	`bŒfs_qgroup_ä“_m‘a_´—Îoc
(
node
->
roÙ
,

630 
node
->
by‹s_»£rved
);

632 
	`bŒfs_qgroup_cÚv”t_»£rved_m‘a
(
node
->
roÙ
,

633 
node
->
by‹s_»£rved
);

634 
node
->
by‹s_»£rved
 = 0;

635 
	}
}

647 
	$bŒfs_š£¹_d–ayed_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

648 
bŒfs_roÙ
 *
roÙ
,

649 
bŒfs_·th
 *
·th
,

650 
bŒfs_d–ayed_™em
 *
fœ¡_™em
)

652 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

653 
bŒfs_d–ayed_node
 *
node
 = 
fœ¡_™em
->
d–ayed_node
;

654 
	`LIST_HEAD
(
™em_li¡
);

655 
bŒfs_d–ayed_™em
 *
cu¼
;

656 
bŒfs_d–ayed_™em
 *
Ãxt
;

657 cÚ¡ 
max_size
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
);

658 
bŒfs_™em_b©ch
 
b©ch
;

659 
bŒfs_key
 
fœ¡_key
;

660 cÚ¡ 
u32
 
fœ¡_d©a_size
 = 
fœ¡_™em
->
d©a_Ën
;

661 
tÙ®_size
;

662 *
šs_d©a
 = 
NULL
;

663 
»t
;

664 
boŞ
 
cÚtšuous_keys_Úly
 = 
çl£
;

666 
	`lockd•_as£¹_h–d
(&
node
->
mu‹x
);

677 ià(
	`‹¡_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
))

678 
cÚtšuous_keys_Úly
 = 
Œue
;

686 
	`ASSERT
(
fœ¡_™em
->
by‹s_»£rved
 == 0);

688 
	`li¡_add_
(&
fœ¡_™em
->
Œ“_li¡
, &
™em_li¡
);

689 
b©ch
.
tÙ®_d©a_size
 = 
fœ¡_d©a_size
;

690 
b©ch
.
Ä
 = 1;

691 
tÙ®_size
 = 
fœ¡_d©a_size
 + (
bŒfs_™em
);

692 
cu¼
 = 
fœ¡_™em
;

694 
Œue
) {

695 
Ãxt_size
;

697 
Ãxt
 = 
	`__bŒfs_Ãxt_d–ayed_™em
(
cu¼
);

698 ià(!
Ãxt
)

705 ià(
cÚtšuous_keys_Úly
 && (
Ãxt
->
šdex
 !ğ
cu¼
->index + 1))

708 
	`ASSERT
(
Ãxt
->
by‹s_»£rved
 == 0);

710 
Ãxt_size
 = 
Ãxt
->
d©a_Ën
 + (
bŒfs_™em
);

711 ià(
tÙ®_size
 + 
Ãxt_size
 > 
max_size
)

714 
	`li¡_add_
(&
Ãxt
->
Œ“_li¡
, &
™em_li¡
);

715 
b©ch
.
Ä
++;

716 
tÙ®_size
 +ğ
Ãxt_size
;

717 
b©ch
.
tÙ®_d©a_size
 +ğ
Ãxt
->
d©a_Ën
;

718 
cu¼
 = 
Ãxt
;

721 ià(
b©ch
.
Ä
 == 1) {

722 
fœ¡_key
.
objeùid
 = 
node
->
šode_id
;

723 
fœ¡_key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

724 
fœ¡_key
.
off£t
 = 
fœ¡_™em
->
šdex
;

725 
b©ch
.
keys
 = &
fœ¡_key
;

726 
b©ch
.
d©a_sizes
 = &
fœ¡_d©a_size
;

728 
bŒfs_key
 *
šs_keys
;

729 
u32
 *
šs_sizes
;

730 
i
 = 0;

732 
šs_d©a
 = 
	`km®loc
(
b©ch
.
Ä
 * (
u32
) +

733 
b©ch
.
Ä
 * (
bŒfs_key
), 
GFP_NOFS
);

734 ià(!
šs_d©a
) {

735 
»t
 = -
ENOMEM
;

736 
out
;

738 
šs_sizes
 = (
u32
 *)
šs_d©a
;

739 
šs_keys
 = (
bŒfs_key
 *)(
šs_d©a
 + 
b©ch
.
Ä
 * (
u32
));

740 
b©ch
.
keys
 = 
šs_keys
;

741 
b©ch
.
d©a_sizes
 = 
šs_sizes
;

742 
	`li¡_fÜ_—ch_’Œy
(
cu¼
, &
™em_li¡
, 
Œ“_li¡
) {

743 
šs_keys
[
i
].
objeùid
 = 
node
->
šode_id
;

744 
šs_keys
[
i
].
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

745 
šs_keys
[
i
].
off£t
 = 
cu¼
->
šdex
;

746 
šs_sizes
[
i
] = 
cu¼
->
d©a_Ën
;

747 
i
++;

751 
»t
 = 
	`bŒfs_š£¹_em±y_™ems
(
Œªs
, 
roÙ
, 
·th
, &
b©ch
);

752 ià(
»t
)

753 
out
;

755 
	`li¡_fÜ_—ch_’Œy
(
cu¼
, &
™em_li¡
, 
Œ“_li¡
) {

756 *
d©a_±r
;

758 
d©a_±r
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0], );

759 
	`wr™e_ex‹Á_bufãr
(
·th
->
nodes
[0], &
cu¼
->
d©a
,

760 ()
d©a_±r
, 
cu¼
->
d©a_Ën
);

761 
·th
->
¦Ùs
[0]++;

769 
	`bŒfs_»Ëa£_·th
(
·th
);

771 
	`ASSERT
(
node
->
šdex_™em_Ëaves
 > 0);

783 ià(
Ãxt
 && !
cÚtšuous_keys_Úly
) {

790 
	`bŒfs_d–ayed_™em_»Ëa£_Ëaves
(
node
, 1);

791 
node
->
šdex_™em_Ëaves
--;

792 } ià(!
Ãxt
) {

800 
	`bŒfs_d–ayed_™em_»Ëa£_Ëaves
(
node
,‚ode->
šdex_™em_Ëaves
);

801 
node
->
šdex_™em_Ëaves
 = 0;

804 
	`li¡_fÜ_—ch_’Œy_§ã
(
cu¼
, 
Ãxt
, &
™em_li¡
, 
Œ“_li¡
) {

805 
	`li¡_d–
(&
cu¼
->
Œ“_li¡
);

806 
	`bŒfs_»Ëa£_d–ayed_™em
(
cu¼
);

808 
out
:

809 
	`kä“
(
šs_d©a
);

810  
»t
;

811 
	}
}

813 
	$bŒfs_š£¹_d–ayed_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

814 
bŒfs_·th
 *
·th
,

815 
bŒfs_roÙ
 *
roÙ
,

816 
bŒfs_d–ayed_node
 *
node
)

818 
»t
 = 0;

820 
»t
 == 0) {

821 
bŒfs_d–ayed_™em
 *
cu¼
;

823 
	`mu‹x_lock
(&
node
->
mu‹x
);

824 
cu¼
 = 
	`__bŒfs_fœ¡_d–ayed_š£¹iÚ_™em
(
node
);

825 ià(!
cu¼
) {

826 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

829 
»t
 = 
	`bŒfs_š£¹_d–ayed_™em
(
Œªs
, 
roÙ
, 
·th
, 
cu¼
);

830 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

833  
»t
;

834 
	}
}

836 
	$bŒfs_b©ch_d–‘e_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

837 
bŒfs_roÙ
 *
roÙ
,

838 
bŒfs_·th
 *
·th
,

839 
bŒfs_d–ayed_™em
 *
™em
)

841 cÚ¡ 
u64
 
šo
 = 
™em
->
d–ayed_node
->
šode_id
;

842 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

843 
bŒfs_d–ayed_™em
 *
cu¼
, *
Ãxt
;

844 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

845 
	`LIST_HEAD
(
b©ch_li¡
);

846 
n™ems
, 
¦Ù
, 
Ï¡_¦Ù
;

847 
»t
;

848 
u64
 
tÙ®_»£rved_size
 = 
™em
->
by‹s_»£rved
;

850 
	`ASSERT
(
Ëaf
 !ğ
NULL
);

852 
¦Ù
 = 
·th
->
¦Ùs
[0];

853 
Ï¡_¦Ù
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
) - 1;

858 
	`ASSERT
(
¦Ù
 <ğ
Ï¡_¦Ù
);

859 ià(
	`WARN_ON
(
¦Ù
 > 
Ï¡_¦Ù
))

860  -
ENOENT
;

862 
n™ems
 = 1;

863 
cu¼
 = 
™em
;

864 
	`li¡_add_
(&
cu¼
->
Œ“_li¡
, &
b©ch_li¡
);

871 
¦Ù
 < 
Ï¡_¦Ù
) {

872 
bŒfs_key
 
key
;

874 
Ãxt
 = 
	`__bŒfs_Ãxt_d–ayed_™em
(
cu¼
);

875 ià(!
Ãxt
)

878 
¦Ù
++;

879 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

880 ià(
key
.
objeùid
 !ğ
šo
 ||

881 
key
.
ty³
 !ğ
BTRFS_DIR_INDEX_KEY
 ||

882 
key
.
off£t
 !ğ
Ãxt
->
šdex
)

884 
n™ems
++;

885 
cu¼
 = 
Ãxt
;

886 
	`li¡_add_
(&
cu¼
->
Œ“_li¡
, &
b©ch_li¡
);

887 
tÙ®_»£rved_size
 +ğ
cu¼
->
by‹s_»£rved
;

890 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
,…©h->
¦Ùs
[0], 
n™ems
);

891 ià(
»t
)

892  
»t
;

895 ià(
tÙ®_»£rved_size
 > 0) {

900 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "d–ayed_™em", 
šo
,

901 
tÙ®_»£rved_size
, 0);

902 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, &fs_šfo->
d–ayed_block_rsv
,

903 
tÙ®_»£rved_size
, 
NULL
);

906 
	`li¡_fÜ_—ch_’Œy_§ã
(
cu¼
, 
Ãxt
, &
b©ch_li¡
, 
Œ“_li¡
) {

907 
	`li¡_d–
(&
cu¼
->
Œ“_li¡
);

908 
	`bŒfs_»Ëa£_d–ayed_™em
(
cu¼
);

912 
	}
}

914 
	$bŒfs_d–‘e_d–ayed_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

915 
bŒfs_·th
 *
·th
,

916 
bŒfs_roÙ
 *
roÙ
,

917 
bŒfs_d–ayed_node
 *
node
)

919 
bŒfs_key
 
key
;

920 
»t
 = 0;

922 
key
.
objeùid
 = 
node
->
šode_id
;

923 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

925 
»t
 == 0) {

926 
bŒfs_d–ayed_™em
 *
™em
;

928 
	`mu‹x_lock
(&
node
->
mu‹x
);

929 
™em
 = 
	`__bŒfs_fœ¡_d–ayed_d–‘iÚ_™em
(
node
);

930 ià(!
™em
) {

931 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

935 
key
.
off£t
 = 
™em
->
šdex
;

936 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

937 ià(
»t
 > 0) {

952 
	`bŒfs_»Ëa£_·th
(
·th
);

953 
	`bŒfs_»Ëa£_d–ayed_™em
(
™em
);

954 
»t
 = 0;

955 } ià(
»t
 == 0) {

956 
»t
 = 
	`bŒfs_b©ch_d–‘e_™ems
(
Œªs
, 
roÙ
, 
·th
, 
™em
);

957 
	`bŒfs_»Ëa£_·th
(
·th
);

967 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

970  
»t
;

971 
	}
}

973 
	$bŒfs_»Ëa£_d–ayed_šode
(
bŒfs_d–ayed_node
 *
d–ayed_node
)

975 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
;

977 ià(
d–ayed_node
 &&

978 
	`‹¡_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
d–ayed_node
->
æags
)) {

979 
	`BUG_ON
(!
d–ayed_node
->
roÙ
);

980 
	`ş—r_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
d–ayed_node
->
æags
);

981 
d–ayed_node
->
couÁ
--;

983 
d–ayed_roÙ
 = 
d–ayed_node
->
roÙ
->
fs_šfo
->delayed_root;

984 
	`fšish_Úe_™em
(
d–ayed_roÙ
);

986 
	}
}

988 
	$bŒfs_»Ëa£_d–ayed_œef
(
bŒfs_d–ayed_node
 *
d–ayed_node
)

991 ià(
	`‹¡_ªd_ş—r_b™
(
BTRFS_DELAYED_NODE_DEL_IREF
, &
d–ayed_node
->
æags
)) {

992 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
;

994 
	`ASSERT
(
d–ayed_node
->
roÙ
);

995 
d–ayed_node
->
couÁ
--;

997 
d–ayed_roÙ
 = 
d–ayed_node
->
roÙ
->
fs_šfo
->delayed_root;

998 
	`fšish_Úe_™em
(
d–ayed_roÙ
);

1000 
	}
}

1002 
	$__bŒfs_upd©e_d–ayed_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1003 
bŒfs_roÙ
 *
roÙ
,

1004 
bŒfs_·th
 *
·th
,

1005 
bŒfs_d–ayed_node
 *
node
)

1007 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1008 
bŒfs_key
 
key
;

1009 
bŒfs_šode_™em
 *
šode_™em
;

1010 
ex‹Á_bufãr
 *
Ëaf
;

1011 
mod
;

1012 
»t
;

1014 
key
.
objeùid
 = 
node
->
šode_id
;

1015 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

1016 
key
.
off£t
 = 0;

1018 ià(
	`‹¡_b™
(
BTRFS_DELAYED_NODE_DEL_IREF
, &
node
->
æags
))

1019 
mod
 = -1;

1021 
mod
 = 1;

1023 
»t
 = 
	`bŒfs_lookup_šode
(
Œªs
, 
roÙ
, 
·th
, &
key
, 
mod
);

1024 ià(
»t
 > 0)

1025 
»t
 = -
ENOENT
;

1026 ià(
»t
 < 0)

1027 
out
;

1029 
Ëaf
 = 
·th
->
nodes
[0];

1030 
šode_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1031 
bŒfs_šode_™em
);

1032 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, &
node
->
šode_™em
, ()inode_item,

1033 (
bŒfs_šode_™em
));

1034 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

1036 ià(!
	`‹¡_b™
(
BTRFS_DELAYED_NODE_DEL_IREF
, &
node
->
æags
))

1037 
out
;

1039 
·th
->
¦Ùs
[0]++;

1040 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
))

1041 
£¬ch
;

1042 
agaš
:

1043 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

1044 ià(
key
.
objeùid
 !ğ
node
->
šode_id
)

1045 
out
;

1047 ià(
key
.
ty³
 !ğ
BTRFS_INODE_REF_KEY
 &&

1048 
key
.
ty³
 !ğ
BTRFS_INODE_EXTREF_KEY
)

1049 
out
;

1056 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

1057 
out
:

1058 
	`bŒfs_»Ëa£_d–ayed_œef
(
node
);

1059 
	`bŒfs_»Ëa£_·th
(
·th
);

1060 
”r_out
:

1061 
	`bŒfs_d–ayed_šode_»Ëa£_m‘ad©a
(
fs_šfo
, 
node
, (
»t
 < 0));

1062 
	`bŒfs_»Ëa£_d–ayed_šode
(
node
);

1069 ià(
»t
 &&„‘ !ğ-
ENOENT
)

1070 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1072  
»t
;

1074 
£¬ch
:

1075 
	`bŒfs_»Ëa£_·th
(
·th
);

1077 
key
.
ty³
 = 
BTRFS_INODE_EXTREF_KEY
;

1078 
key
.
off£t
 = -1;

1080 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1081 ià(
»t
 < 0)

1082 
”r_out
;

1083 
	`ASSERT
(
»t
);

1085 
»t
 = 0;

1086 
Ëaf
 = 
·th
->
nodes
[0];

1087 
·th
->
¦Ùs
[0]--;

1088 
agaš
;

1089 
	}
}

1091 
šlše
 
	$bŒfs_upd©e_d–ayed_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1092 
bŒfs_roÙ
 *
roÙ
,

1093 
bŒfs_·th
 *
·th
,

1094 
bŒfs_d–ayed_node
 *
node
)

1096 
»t
;

1098 
	`mu‹x_lock
(&
node
->
mu‹x
);

1099 ià(!
	`‹¡_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
node
->
æags
)) {

1100 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

1104 
»t
 = 
	`__bŒfs_upd©e_d–ayed_šode
(
Œªs
, 
roÙ
, 
·th
, 
node
);

1105 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

1106  
»t
;

1107 
	}
}

1109 
šlše
 

1110 
	$__bŒfs_comm™_šode_d–ayed_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1111 
bŒfs_·th
 *
·th
,

1112 
bŒfs_d–ayed_node
 *
node
)

1114 
»t
;

1116 
»t
 = 
	`bŒfs_š£¹_d–ayed_™ems
(
Œªs
, 
·th
, 
node
->
roÙ
,‚ode);

1117 ià(
»t
)

1118  
»t
;

1120 
»t
 = 
	`bŒfs_d–‘e_d–ayed_™ems
(
Œªs
, 
·th
, 
node
->
roÙ
,‚ode);

1121 ià(
»t
)

1122  
»t
;

1124 
»t
 = 
	`bŒfs_upd©e_d–ayed_šode
(
Œªs
, 
node
->
roÙ
, 
·th
,‚ode);

1125  
»t
;

1126 
	}
}

1134 
	$__bŒfs_run_d–ayed_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
Ä
)

1136 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1137 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
;

1138 
bŒfs_d–ayed_node
 *
cu¼_node
, *
´ev_node
;

1139 
bŒfs_·th
 *
·th
;

1140 
bŒfs_block_rsv
 *
block_rsv
;

1141 
»t
 = 0;

1142 
boŞ
 
couÁ
 = (
Ä
 > 0);

1144 ià(
	`TRANS_ABORTED
(
Œªs
))

1145  -
EIO
;

1147 
·th
 = 
	`bŒfs_®loc_·th
();

1148 ià(!
·th
)

1149  -
ENOMEM
;

1151 
block_rsv
 = 
Œªs
->block_rsv;

1152 
Œªs
->
block_rsv
 = &
fs_šfo
->
d–ayed_block_rsv
;

1154 
d–ayed_roÙ
 = 
fs_šfo
->delayed_root;

1156 
cu¼_node
 = 
	`bŒfs_fœ¡_d–ayed_node
(
d–ayed_roÙ
);

1157 
cu¼_node
 && (!
couÁ
 || 
Ä
--)) {

1158 
»t
 = 
	`__bŒfs_comm™_šode_d–ayed_™ems
(
Œªs
, 
·th
,

1159 
cu¼_node
);

1160 ià(
»t
) {

1161 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1165 
´ev_node
 = 
cu¼_node
;

1166 
cu¼_node
 = 
	`bŒfs_Ãxt_d–ayed_node
(curr_node);

1173 
	`ASSERT
(
·th
->
nodes
[0] =ğ
NULL
);

1174 
	`bŒfs_»Ëa£_d–ayed_node
(
´ev_node
);

1184 
	`bŒfs_ä“_·th
(
·th
);

1186 ià(
cu¼_node
)

1187 
	`bŒfs_»Ëa£_d–ayed_node
(
cu¼_node
);

1188 
Œªs
->
block_rsv
 = block_rsv;

1190  
»t
;

1191 
	}
}

1193 
	$bŒfs_run_d–ayed_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
)

1195  
	`__bŒfs_run_d–ayed_™ems
(
Œªs
, -1);

1196 
	}
}

1198 
	$bŒfs_run_d–ayed_™ems_Ä
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
Ä
)

1200  
	`__bŒfs_run_d–ayed_™ems
(
Œªs
, 
Ä
);

1201 
	}
}

1203 
	$bŒfs_comm™_šode_d–ayed_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1204 
bŒfs_šode
 *
šode
)

1206 
bŒfs_d–ayed_node
 *
d–ayed_node
 = 
	`bŒfs_g‘_d–ayed_node
(
šode
);

1207 
bŒfs_·th
 *
·th
;

1208 
bŒfs_block_rsv
 *
block_rsv
;

1209 
»t
;

1211 ià(!
d–ayed_node
)

1214 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

1215 ià(!
d–ayed_node
->
couÁ
) {

1216 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1217 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1220 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1222 
·th
 = 
	`bŒfs_®loc_·th
();

1223 ià(!
·th
) {

1224 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1225  -
ENOMEM
;

1228 
block_rsv
 = 
Œªs
->block_rsv;

1229 
Œªs
->
block_rsv
 = &
d–ayed_node
->
roÙ
->
fs_šfo
->
d–ayed_block_rsv
;

1231 
»t
 = 
	`__bŒfs_comm™_šode_d–ayed_™ems
(
Œªs
, 
·th
, 
d–ayed_node
);

1233 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1234 
	`bŒfs_ä“_·th
(
·th
);

1235 
Œªs
->
block_rsv
 = block_rsv;

1237  
»t
;

1238 
	}
}

1240 
	$bŒfs_comm™_šode_d–ayed_šode
(
bŒfs_šode
 *
šode
)

1242 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

1243 
bŒfs_Œªs_hªdË
 *
Œªs
;

1244 
bŒfs_d–ayed_node
 *
d–ayed_node
 = 
	`bŒfs_g‘_d–ayed_node
(
šode
);

1245 
bŒfs_·th
 *
·th
;

1246 
bŒfs_block_rsv
 *
block_rsv
;

1247 
»t
;

1249 ià(!
d–ayed_node
)

1252 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

1253 ià(!
	`‹¡_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
d–ayed_node
->
æags
)) {

1254 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1255 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1258 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1260 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
d–ayed_node
->
roÙ
);

1261 ià(
	`IS_ERR
(
Œªs
)) {

1262 
»t
 = 
	`PTR_ERR
(
Œªs
);

1263 
out
;

1266 
·th
 = 
	`bŒfs_®loc_·th
();

1267 ià(!
·th
) {

1268 
»t
 = -
ENOMEM
;

1269 
Œªs_out
;

1272 
block_rsv
 = 
Œªs
->block_rsv;

1273 
Œªs
->
block_rsv
 = &
fs_šfo
->
d–ayed_block_rsv
;

1275 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

1276 ià(
	`‹¡_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
d–ayed_node
->
æags
))

1277 
»t
 = 
	`__bŒfs_upd©e_d–ayed_šode
(
Œªs
, 
d–ayed_node
->
roÙ
,

1278 
·th
, 
d–ayed_node
);

1280 
»t
 = 0;

1281 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1283 
	`bŒfs_ä“_·th
(
·th
);

1284 
Œªs
->
block_rsv
 = block_rsv;

1285 
Œªs_out
:

1286 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1287 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

1288 
out
:

1289 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1291  
»t
;

1292 
	}
}

1294 
	$bŒfs_»move_d–ayed_node
(
bŒfs_šode
 *
šode
)

1296 
bŒfs_d–ayed_node
 *
d–ayed_node
;

1298 
d–ayed_node
 = 
	`READ_ONCE
(
šode
->delayed_node);

1299 ià(!
d–ayed_node
)

1302 
šode
->
d–ayed_node
 = 
NULL
;

1303 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1304 
	}
}

1306 
	sbŒfs_async_d–ayed_wÜk
 {

1307 
bŒfs_d–ayed_roÙ
 *
	md–ayed_roÙ
;

1308 
	mÄ
;

1309 
bŒfs_wÜk
 
	mwÜk
;

1312 
	$bŒfs_async_run_d–ayed_roÙ
(
bŒfs_wÜk
 *
wÜk
)

1314 
bŒfs_async_d–ayed_wÜk
 *
async_wÜk
;

1315 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
;

1316 
bŒfs_Œªs_hªdË
 *
Œªs
;

1317 
bŒfs_·th
 *
·th
;

1318 
bŒfs_d–ayed_node
 *
d–ayed_node
 = 
NULL
;

1319 
bŒfs_roÙ
 *
roÙ
;

1320 
bŒfs_block_rsv
 *
block_rsv
;

1321 
tÙ®_dÚe
 = 0;

1323 
async_wÜk
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_async_d–ayed_wÜk
, work);

1324 
d–ayed_roÙ
 = 
async_wÜk
->delayed_root;

1326 
·th
 = 
	`bŒfs_®loc_·th
();

1327 ià(!
·th
)

1328 
out
;

1331 ià(
	`©omic_»ad
(&
d–ayed_roÙ
->
™ems
) <

1332 
BTRFS_DELAYED_BACKGROUND
 / 2)

1335 
d–ayed_node
 = 
	`bŒfs_fœ¡_´•¬ed_d–ayed_node
(
d–ayed_roÙ
);

1336 ià(!
d–ayed_node
)

1339 
roÙ
 = 
d–ayed_node
->root;

1341 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

1342 ià(
	`IS_ERR
(
Œªs
)) {

1343 
	`bŒfs_»Ëa£_·th
(
·th
);

1344 
	`bŒfs_»Ëa£_´•¬ed_d–ayed_node
(
d–ayed_node
);

1345 
tÙ®_dÚe
++;

1349 
block_rsv
 = 
Œªs
->block_rsv;

1350 
Œªs
->
block_rsv
 = &
roÙ
->
fs_šfo
->
d–ayed_block_rsv
;

1352 
	`__bŒfs_comm™_šode_d–ayed_™ems
(
Œªs
, 
·th
, 
d–ayed_node
);

1354 
Œªs
->
block_rsv
 = block_rsv;

1355 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1356 
	`bŒfs_bŒ“_b®ªû_dœty_nod–ay
(
roÙ
->
fs_šfo
);

1358 
	`bŒfs_»Ëa£_·th
(
·th
);

1359 
	`bŒfs_»Ëa£_´•¬ed_d–ayed_node
(
d–ayed_node
);

1360 
tÙ®_dÚe
++;

1362 } (
async_wÜk
->
Ä
 =ğ0 && 
tÙ®_dÚe
 < 
BTRFS_DELAYED_WRITEBACK
)

1363 || 
tÙ®_dÚe
 < 
async_wÜk
->
Ä
);

1365 
	`bŒfs_ä“_·th
(
·th
);

1366 
out
:

1367 
	`wake_up
(&
d–ayed_roÙ
->
wa™
);

1368 
	`kä“
(
async_wÜk
);

1369 
	}
}

1372 
	$bŒfs_wq_run_d–ayed_node
(
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
,

1373 
bŒfs_fs_šfo
 *
fs_šfo
, 
Ä
)

1375 
bŒfs_async_d–ayed_wÜk
 *
async_wÜk
;

1377 
async_wÜk
 = 
	`km®loc
((*async_wÜk), 
GFP_NOFS
);

1378 ià(!
async_wÜk
)

1379  -
ENOMEM
;

1381 
async_wÜk
->
d–ayed_roÙ
 = delayed_root;

1382 
	`bŒfs_š™_wÜk
(&
async_wÜk
->
wÜk
, 
bŒfs_async_run_d–ayed_roÙ
, 
NULL
,

1383 
NULL
);

1384 
async_wÜk
->
Ä
 =‚r;

1386 
	`bŒfs_queue_wÜk
(
fs_šfo
->
d–ayed_wÜk”s
, &
async_wÜk
->
wÜk
);

1388 
	}
}

1390 
	$bŒfs_as£¹_d–ayed_roÙ_em±y
(
bŒfs_fs_šfo
 *
fs_šfo
)

1392 
	`WARN_ON
(
	`bŒfs_fœ¡_d–ayed_node
(
fs_šfo
->
d–ayed_roÙ
));

1393 
	}
}

1395 
	$could_’d_wa™
(
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
, 
£q
)

1397 
v®
 = 
	`©omic_»ad
(&
d–ayed_roÙ
->
™ems_£q
);

1399 ià(
v®
 < 
£q
 || v® >ğ£q + 
BTRFS_DELAYED_BATCH
)

1402 ià(
	`©omic_»ad
(&
d–ayed_roÙ
->
™ems
è< 
BTRFS_DELAYED_BACKGROUND
)

1406 
	}
}

1408 
	$bŒfs_b®ªû_d–ayed_™ems
(
bŒfs_fs_šfo
 *
fs_šfo
)

1410 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
 = 
fs_šfo
->delayed_root;

1412 ià((
	`©omic_»ad
(&
d–ayed_roÙ
->
™ems
è< 
BTRFS_DELAYED_BACKGROUND
) ||

1413 
	`bŒfs_wÜkqueue_nÜm®_cÚge¡ed
(
fs_šfo
->
d–ayed_wÜk”s
))

1416 ià(
	`©omic_»ad
(&
d–ayed_roÙ
->
™ems
è>ğ
BTRFS_DELAYED_WRITEBACK
) {

1417 
£q
;

1418 
»t
;

1420 
£q
 = 
	`©omic_»ad
(&
d–ayed_roÙ
->
™ems_£q
);

1422 
»t
 = 
	`bŒfs_wq_run_d–ayed_node
(
d–ayed_roÙ
, 
fs_šfo
, 0);

1423 ià(
»t
)

1426 
	`wa™_ev’t_š‹¼u±ibË
(
d–ayed_roÙ
->
wa™
,

1427 
	`could_’d_wa™
(
d–ayed_roÙ
, 
£q
));

1431 
	`bŒfs_wq_run_d–ayed_node
(
d–ayed_roÙ
, 
fs_šfo
, 
BTRFS_DELAYED_BATCH
);

1432 
	}
}

1434 
	$bŒfs_»Ëa£_dœ_šdex_™em_¥aû
(
bŒfs_Œªs_hªdË
 *
Œªs
)

1436 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1437 cÚ¡ 
u64
 
by‹s
 = 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
, 1);

1439 ià(
	`‹¡_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
))

1449 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "transaction",

1450 
Œªs
->
Œªsid
, 
by‹s
, 0);

1451 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
Œªs
->
block_rsv
, 
by‹s
, 
NULL
);

1452 
	`ASSERT
(
Œªs
->
by‹s_»£rved
 >ğ
by‹s
);

1453 
Œªs
->
by‹s_»£rved
 -ğ
by‹s
;

1454 
	}
}

1457 
	$bŒfs_š£¹_d–ayed_dœ_šdex
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1458 cÚ¡ *
Çme
, 
Çme_Ën
,

1459 
bŒfs_šode
 *
dœ
,

1460 
bŒfs_disk_key
 *
disk_key
, 
u8
 
æags
,

1461 
u64
 
šdex
)

1463 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1464 cÚ¡ 
Ëaf_d©a_size
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
);

1465 
bŒfs_d–ayed_node
 *
d–ayed_node
;

1466 
bŒfs_d–ayed_™em
 *
d–ayed_™em
;

1467 
bŒfs_dœ_™em
 *
dœ_™em
;

1468 
boŞ
 
»£rve_Ëaf_¥aû
;

1469 
u32
 
d©a_Ën
;

1470 
»t
;

1472 
d–ayed_node
 = 
	`bŒfs_g‘_Ü_ü—‹_d–ayed_node
(
dœ
);

1473 ià(
	`IS_ERR
(
d–ayed_node
))

1474  
	`PTR_ERR
(
d–ayed_node
);

1476 
d–ayed_™em
 = 
	`bŒfs_®loc_d–ayed_™em
((*
dœ_™em
è+ 
Çme_Ën
,

1477 
d–ayed_node
,

1478 
BTRFS_DELAYED_INSERTION_ITEM
);

1479 ià(!
d–ayed_™em
) {

1480 
»t
 = -
ENOMEM
;

1481 
»Ëa£_node
;

1484 
d–ayed_™em
->
šdex
 = index;

1486 
dœ_™em
 = (
bŒfs_dœ_™em
 *)
d–ayed_™em
->
d©a
;

1487 
dœ_™em
->
loÿtiÚ
 = *
disk_key
;

1488 
	`bŒfs_£t_¡ack_dœ_Œªsid
(
dœ_™em
, 
Œªs
->
Œªsid
);

1489 
	`bŒfs_£t_¡ack_dœ_d©a_Ën
(
dœ_™em
, 0);

1490 
	`bŒfs_£t_¡ack_dœ_Çme_Ën
(
dœ_™em
, 
Çme_Ën
);

1491 
	`bŒfs_£t_¡ack_dœ_æags
(
dœ_™em
, 
æags
);

1492 
	`memıy
((*)(
dœ_™em
 + 1), 
Çme
, 
Çme_Ën
);

1494 
d©a_Ën
 = 
d–ayed_™em
->d©a_ËÀ+ (
bŒfs_™em
);

1496 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

1506 
»t
 = 
	`__bŒfs_add_d–ayed_™em
(
d–ayed_node
, 
d–ayed_™em
);

1507 ià(
	`uÆik–y
(
»t
)) {

1508 
	`bŒfs_”r
(
Œªs
->
fs_šfo
,

1510 
Çme_Ën
, 
Çme
, 
šdex
, 
	`bŒfs_roÙ_id
(
d–ayed_node
->
roÙ
),

1511 
d–ayed_node
->
šode_id
, 
dœ
->
šdex_út
,

1512 
d–ayed_node
->
šdex_út
, 
»t
);

1513 
	`bŒfs_»Ëa£_d–ayed_™em
(
d–ayed_™em
);

1514 
	`bŒfs_»Ëa£_dœ_šdex_™em_¥aû
(
Œªs
);

1515 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1516 
»Ëa£_node
;

1519 ià(
d–ayed_node
->
šdex_™em_Ëaves
 == 0 ||

1520 
d–ayed_node
->
cu¼_šdex_b©ch_size
 + 
d©a_Ën
 > 
Ëaf_d©a_size
) {

1521 
d–ayed_node
->
cu¼_šdex_b©ch_size
 = 
d©a_Ën
;

1522 
»£rve_Ëaf_¥aû
 = 
Œue
;

1524 
d–ayed_node
->
cu¼_šdex_b©ch_size
 +ğ
d©a_Ën
;

1525 
»£rve_Ëaf_¥aû
 = 
çl£
;

1528 ià(
»£rve_Ëaf_¥aû
) {

1529 
»t
 = 
	`bŒfs_d–ayed_™em_»£rve_m‘ad©a
(
Œªs
, 
d–ayed_™em
);

1535 ià(
	`WARN_ON
(
»t
)) {

1536 
	`bŒfs_»Ëa£_d–ayed_™em
(
d–ayed_™em
);

1537 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1538 
»Ëa£_node
;

1541 
d–ayed_node
->
šdex_™em_Ëaves
++;

1543 
	`bŒfs_»Ëa£_dœ_šdex_™em_¥aû
(
Œªs
);

1545 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1547 
»Ëa£_node
:

1548 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1549  
»t
;

1550 
	}
}

1552 
	$bŒfs_d–‘e_d–ayed_š£¹iÚ_™em
(
bŒfs_fs_šfo
 *
fs_šfo
,

1553 
bŒfs_d–ayed_node
 *
node
,

1554 
u64
 
šdex
)

1556 
bŒfs_d–ayed_™em
 *
™em
;

1558 
	`mu‹x_lock
(&
node
->
mu‹x
);

1559 
™em
 = 
	`__bŒfs_lookup_d–ayed_™em
(&
node
->
šs_roÙ
.
rb_roÙ
, 
šdex
);

1560 ià(!
™em
) {

1561 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

1571 
	`ASSERT
(
™em
->
by‹s_»£rved
 == 0);

1572 
	`ASSERT
(
node
->
šdex_™em_Ëaves
 > 0);

1581 ià(
node
->
šdex_™em_Ëaves
 == 1) {

1582 cÚ¡ 
u32
 
d©a_Ën
 = 
™em
->d©a_ËÀ+ (
bŒfs_™em
);

1584 
	`ASSERT
(
node
->
cu¼_šdex_b©ch_size
 >ğ
d©a_Ën
);

1585 
node
->
cu¼_šdex_b©ch_size
 -ğ
d©a_Ën
;

1588 
	`bŒfs_»Ëa£_d–ayed_™em
(
™em
);

1591 ià(
	`RB_EMPTY_ROOT
(&
node
->
šs_roÙ
.
rb_roÙ
)) {

1592 
	`bŒfs_d–ayed_™em_»Ëa£_Ëaves
(
node
,‚ode->
šdex_™em_Ëaves
);

1593 
node
->
šdex_™em_Ëaves
 = 0;

1596 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

1598 
	}
}

1600 
	$bŒfs_d–‘e_d–ayed_dœ_šdex
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1601 
bŒfs_šode
 *
dœ
, 
u64
 
šdex
)

1603 
bŒfs_d–ayed_node
 *
node
;

1604 
bŒfs_d–ayed_™em
 *
™em
;

1605 
»t
;

1607 
node
 = 
	`bŒfs_g‘_Ü_ü—‹_d–ayed_node
(
dœ
);

1608 ià(
	`IS_ERR
(
node
))

1609  
	`PTR_ERR
(
node
);

1611 
»t
 = 
	`bŒfs_d–‘e_d–ayed_š£¹iÚ_™em
(
Œªs
->
fs_šfo
, 
node
, 
šdex
);

1612 ià(!
»t
)

1613 
’d
;

1615 
™em
 = 
	`bŒfs_®loc_d–ayed_™em
(0, 
node
, 
BTRFS_DELAYED_DELETION_ITEM
);

1616 ià(!
™em
) {

1617 
»t
 = -
ENOMEM
;

1618 
’d
;

1621 
™em
->
šdex
 = index;

1623 
»t
 = 
	`bŒfs_d–ayed_™em_»£rve_m‘ad©a
(
Œªs
, 
™em
);

1628 ià(
»t
 < 0) {

1629 
	`bŒfs_”r
(
Œªs
->
fs_šfo
,

1631 
	`bŒfs_»Ëa£_d–ayed_™em
(
™em
);

1632 
’d
;

1635 
	`mu‹x_lock
(&
node
->
mu‹x
);

1636 
»t
 = 
	`__bŒfs_add_d–ayed_™em
(
node
, 
™em
);

1637 ià(
	`uÆik–y
(
»t
)) {

1638 
	`bŒfs_”r
(
Œªs
->
fs_šfo
,

1640 
šdex
, 
node
->
roÙ
->
roÙ_key
.
objeùid
,

1641 
node
->
šode_id
, 
»t
);

1642 
	`bŒfs_d–ayed_™em_»Ëa£_m‘ad©a
(
dœ
->
roÙ
, 
™em
);

1643 
	`bŒfs_»Ëa£_d–ayed_™em
(
™em
);

1645 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

1646 
’d
:

1647 
	`bŒfs_»Ëa£_d–ayed_node
(
node
);

1648  
»t
;

1649 
	}
}

1652 
	$bŒfs_šode_d–ayed_dœ_šdex_couÁ
(
bŒfs_šode
 *
šode
)

1655 
šode
 *
cur_šode
 = &šode->
vfs_šode
;

1656 
bŒfs_fs_šfo
 *
cur_fs_šfo
 = 
	`bŒfs_sb
(
cur_šode
->
i_sb
);

1658 
šode
 *
loÿl_šode
;

1659 
bŒfs_šode
 *
b_loÿl_šode
;

1661 
b_loÿl_šode
 = 
šode
;

1663 ià((
cur_šode
->
assocŸ‹d_šode
è&& (cur_šode->
has_»mÙe
 == 0)) {

1665 
loÿl_šode
 = 
cur_šode
->
assocŸ‹d_šode
;

1666 
b_loÿl_šode
 = 
	`BTRFS_I
(
loÿl_šode
);

1668 
b_loÿl_šode
 = 
šode
;

1672 
bŒfs_d–ayed_node
 *
d–ayed_node
 = 
	`bŒfs_g‘_d–ayed_node
(
b_loÿl_šode
);

1676 ià(!
d–ayed_node
) {

1678  -
ENOENT
;

1685 ià(!
d–ayed_node
->
šdex_út
) {

1686 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1687  -
EINVAL
;

1691 
b_loÿl_šode
->
šdex_út
 = 
d–ayed_node
->index_cnt;

1692 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1694 
	}
}

1696 
boŞ
 
	$bŒfs_»addœ_g‘_d–ayed_™ems
(
šode
 *inode,

1697 
u64
 
Ï¡_šdex
,

1698 
li¡_h—d
 *
šs_li¡
,

1699 
li¡_h—d
 *
d–_li¡
)

1701 
bŒfs_d–ayed_node
 *
d–ayed_node
;

1702 
bŒfs_d–ayed_™em
 *
™em
;

1704 
d–ayed_node
 = 
	`bŒfs_g‘_d–ayed_node
(
	`BTRFS_I
(
šode
));

1705 ià(!
d–ayed_node
)

1706  
çl£
;

1712 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
BTRFS_ILOCK_SHARED
);

1713 
	`bŒfs_šode_lock
(
	`BTRFS_I
(
šode
), 0);

1715 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

1716 
™em
 = 
	`__bŒfs_fœ¡_d–ayed_š£¹iÚ_™em
(
d–ayed_node
);

1717 
™em
 && i‹m->
šdex
 <ğ
Ï¡_šdex
) {

1718 
	`»fcouÁ_šc
(&
™em
->
»fs
);

1719 
	`li¡_add_
(&
™em
->
»addœ_li¡
, 
šs_li¡
);

1720 
™em
 = 
	`__bŒfs_Ãxt_d–ayed_™em
(item);

1723 
™em
 = 
	`__bŒfs_fœ¡_d–ayed_d–‘iÚ_™em
(
d–ayed_node
);

1724 
™em
 && i‹m->
šdex
 <ğ
Ï¡_šdex
) {

1725 
	`»fcouÁ_šc
(&
™em
->
»fs
);

1726 
	`li¡_add_
(&
™em
->
»addœ_li¡
, 
d–_li¡
);

1727 
™em
 = 
	`__bŒfs_Ãxt_d–ayed_™em
(item);

1729 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1739 
	`»fcouÁ_dec
(&
d–ayed_node
->
»fs
);

1741  
Œue
;

1742 
	}
}

1744 
	$bŒfs_»addœ_put_d–ayed_™ems
(
šode
 *inode,

1745 
li¡_h—d
 *
šs_li¡
,

1746 
li¡_h—d
 *
d–_li¡
)

1748 
bŒfs_d–ayed_™em
 *
cu¼
, *
Ãxt
;

1750 
	`li¡_fÜ_—ch_’Œy_§ã
(
cu¼
, 
Ãxt
, 
šs_li¡
, 
»addœ_li¡
) {

1751 
	`li¡_d–
(&
cu¼
->
»addœ_li¡
);

1752 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
cu¼
->
»fs
))

1753 
	`kä“
(
cu¼
);

1756 
	`li¡_fÜ_—ch_’Œy_§ã
(
cu¼
, 
Ãxt
, 
d–_li¡
, 
»addœ_li¡
) {

1757 
	`li¡_d–
(&
cu¼
->
»addœ_li¡
);

1758 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
cu¼
->
»fs
))

1759 
	`kä“
(
cu¼
);

1766 
	`downg¿de_wr™e
(&
šode
->
i_rw£m
);

1767 
	}
}

1769 
	$bŒfs_should_d–‘e_dœ_šdex
(
li¡_h—d
 *
d–_li¡
,

1770 
u64
 
šdex
)

1772 
bŒfs_d–ayed_™em
 *
cu¼
;

1773 
»t
 = 0;

1775 
	`li¡_fÜ_—ch_’Œy
(
cu¼
, 
d–_li¡
, 
»addœ_li¡
) {

1776 ià(
cu¼
->
šdex
 > index)

1778 ià(
cu¼
->
šdex
 == index) {

1779 
»t
 = 1;

1783  
»t
;

1784 
	}
}

1790 
	$bŒfs_»addœ_d–ayed_dœ_šdex
(
dœ_cÚ‹xt
 *
ùx
,

1791 
li¡_h—d
 *
šs_li¡
)

1793 
bŒfs_dœ_™em
 *
di
;

1794 
bŒfs_d–ayed_™em
 *
cu¼
, *
Ãxt
;

1795 
bŒfs_key
 
loÿtiÚ
;

1796 *
Çme
;

1797 
Çme_Ën
;

1798 
ov”
 = 0;

1799 
d_ty³
;

1806 
	`li¡_fÜ_—ch_’Œy_§ã
(
cu¼
, 
Ãxt
, 
šs_li¡
, 
»addœ_li¡
) {

1807 
	`li¡_d–
(&
cu¼
->
»addœ_li¡
);

1809 ià(
cu¼
->
šdex
 < 
ùx
->
pos
) {

1810 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
cu¼
->
»fs
))

1811 
	`kä“
(
cu¼
);

1815 
ùx
->
pos
 = 
cu¼
->
šdex
;

1817 
di
 = (
bŒfs_dœ_™em
 *)
cu¼
->
d©a
;

1818 
Çme
 = (*)(
di
 + 1);

1819 
Çme_Ën
 = 
	`bŒfs_¡ack_dœ_Çme_Ën
(
di
);

1821 
d_ty³
 = 
	`fs_áy³_to_dty³
(
	`bŒfs_dœ_æags_to_áy³
(
di
->
ty³
));

1822 
	`bŒfs_disk_key_to_ıu
(&
loÿtiÚ
, &
di
->location);

1824 
ov”
 = !
	`dœ_em™
(
ùx
, 
Çme
, 
Çme_Ën
,

1825 
loÿtiÚ
.
objeùid
, 
d_ty³
);

1827 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
cu¼
->
»fs
))

1828 
	`kä“
(
cu¼
);

1830 ià(
ov”
)

1832 
ùx
->
pos
++;

1835 
	}
}

1837 
	$fl_¡ack_šode_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1838 
bŒfs_šode_™em
 *
šode_™em
,

1839 
šode
 *inode)

1841 
u64
 
æags
;

1843 
	`bŒfs_£t_¡ack_šode_uid
(
šode_™em
, 
	`i_uid_»ad
(
šode
));

1844 
	`bŒfs_£t_¡ack_šode_gid
(
šode_™em
, 
	`i_gid_»ad
(
šode
));

1845 
	`bŒfs_£t_¡ack_šode_size
(
šode_™em
, 
	`BTRFS_I
(
šode
)->
disk_i_size
);

1846 
	`bŒfs_£t_¡ack_šode_mode
(
šode_™em
, 
šode
->
i_mode
);

1847 
	`bŒfs_£t_¡ack_šode_Æšk
(
šode_™em
, 
šode
->
i_Æšk
);

1848 
	`bŒfs_£t_¡ack_šode_nby‹s
(
šode_™em
, 
	`šode_g‘_by‹s
(
šode
));

1849 
	`bŒfs_£t_¡ack_šode_g’”©iÚ
(
šode_™em
,

1850 
	`BTRFS_I
(
šode
)->
g’”©iÚ
);

1851 
	`bŒfs_£t_¡ack_šode_£qu’û
(
šode_™em
,

1852 
	`šode_³ek_iv”siÚ
(
šode
));

1853 
	`bŒfs_£t_¡ack_šode_Œªsid
(
šode_™em
, 
Œªs
->
Œªsid
);

1854 
	`bŒfs_£t_¡ack_šode_rdev
(
šode_™em
, 
šode
->
i_rdev
);

1855 
æags
 = 
	`bŒfs_šode_combše_æags
(
	`BTRFS_I
(
šode
)->flags,

1856 
	`BTRFS_I
(
šode
)->
ro_æags
);

1857 
	`bŒfs_£t_¡ack_šode_æags
(
šode_™em
, 
æags
);

1858 
	`bŒfs_£t_¡ack_šode_block_group
(
šode_™em
, 0);

1860 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
šode_™em
->
©ime
,

1861 
šode
->
i_©ime
.
tv_£c
);

1862 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
šode_™em
->
©ime
,

1863 
šode
->
i_©ime
.
tv_n£c
);

1865 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
šode_™em
->
mtime
,

1866 
šode
->
i_mtime
.
tv_£c
);

1867 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
šode_™em
->
mtime
,

1868 
šode
->
i_mtime
.
tv_n£c
);

1870 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
šode_™em
->
ùime
,

1871 
	`šode_g‘_ùime
(
šode
).
tv_£c
);

1872 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
šode_™em
->
ùime
,

1873 
	`šode_g‘_ùime
(
šode
).
tv_n£c
);

1875 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
šode_™em
->
Ùime
,

1876 
	`BTRFS_I
(
šode
)->
i_Ùime
.
tv_£c
);

1877 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
šode_™em
->
Ùime
,

1878 
	`BTRFS_I
(
šode
)->
i_Ùime
.
tv_n£c
);

1879 
	}
}

1881 
	$bŒfs_fl_šode
(
šode
 *šode, 
u32
 *
rdev
)

1883 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`BTRFS_I
(
šode
)->
roÙ
->fs_info;

1884 
bŒfs_d–ayed_node
 *
d–ayed_node
;

1885 
bŒfs_šode_™em
 *
šode_™em
;

1887 
d–ayed_node
 = 
	`bŒfs_g‘_d–ayed_node
(
	`BTRFS_I
(
šode
));

1888 ià(!
d–ayed_node
)

1889  -
ENOENT
;

1891 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

1892 ià(!
	`‹¡_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
d–ayed_node
->
æags
)) {

1893 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1894 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1895  -
ENOENT
;

1898 
šode_™em
 = &
d–ayed_node
->inode_item;

1900 
	`i_uid_wr™e
(
šode
, 
	`bŒfs_¡ack_šode_uid
(
šode_™em
));

1901 
	`i_gid_wr™e
(
šode
, 
	`bŒfs_¡ack_šode_gid
(
šode_™em
));

1902 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
šode
), 
	`bŒfs_¡ack_šode_size
(
šode_™em
));

1903 
	`bŒfs_šode_£t_fe_ex‹Á_¿nge
(
	`BTRFS_I
(
šode
), 0,

1904 
	`round_up
(
	`i_size_»ad
(
šode
), 
fs_šfo
->
£ùÜsize
));

1905 
šode
->
i_mode
 = 
	`bŒfs_¡ack_šode_mode
(
šode_™em
);

1906 
	`£t_Æšk
(
šode
, 
	`bŒfs_¡ack_šode_Æšk
(
šode_™em
));

1907 
	`šode_£t_by‹s
(
šode
, 
	`bŒfs_¡ack_šode_nby‹s
(
šode_™em
));

1908 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 
	`bŒfs_¡ack_šode_g’”©iÚ
(
šode_™em
);

1909 
	`BTRFS_I
(
šode
)->
Ï¡_Œªs
 = 
	`bŒfs_¡ack_šode_Œªsid
(
šode_™em
);

1911 
	`šode_£t_iv”siÚ_qu”›d
(
šode
,

1912 
	`bŒfs_¡ack_šode_£qu’û
(
šode_™em
));

1913 
šode
->
i_rdev
 = 0;

1914 *
rdev
 = 
	`bŒfs_¡ack_šode_rdev
(
šode_™em
);

1915 
	`bŒfs_šode_¥l™_æags
(
	`bŒfs_¡ack_šode_æags
(
šode_™em
),

1916 &
	`BTRFS_I
(
šode
)->
æags
, &BTRFS_I(šode)->
ro_æags
);

1918 
šode
->
i_©ime
.
tv_£c
 = 
	`bŒfs_¡ack_time¥ec_£c
(&
šode_™em
->
©ime
);

1919 
šode
->
i_©ime
.
tv_n£c
 = 
	`bŒfs_¡ack_time¥ec_n£c
(&
šode_™em
->
©ime
);

1921 
šode
->
i_mtime
.
tv_£c
 = 
	`bŒfs_¡ack_time¥ec_£c
(&
šode_™em
->
mtime
);

1922 
šode
->
i_mtime
.
tv_n£c
 = 
	`bŒfs_¡ack_time¥ec_n£c
(&
šode_™em
->
mtime
);

1924 
	`šode_£t_ùime
(
šode
, 
	`bŒfs_¡ack_time¥ec_£c
(&
šode_™em
->
ùime
),

1925 
	`bŒfs_¡ack_time¥ec_n£c
(&
šode_™em
->
ùime
));

1927 
	`BTRFS_I
(
šode
)->
i_Ùime
.
tv_£c
 =

1928 
	`bŒfs_¡ack_time¥ec_£c
(&
šode_™em
->
Ùime
);

1929 
	`BTRFS_I
(
šode
)->
i_Ùime
.
tv_n£c
 =

1930 
	`bŒfs_¡ack_time¥ec_n£c
(&
šode_™em
->
Ùime
);

1932 
šode
->
i_g’”©iÚ
 = 
	`BTRFS_I
(šode)->
g’”©iÚ
;

1933 
	`BTRFS_I
(
šode
)->
šdex_út
 = (
u64
)-1;

1935 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1936 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1938 
	}
}

1940 
	$bŒfs_d–ayed_upd©e_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1941 
bŒfs_roÙ
 *
roÙ
,

1942 
bŒfs_šode
 *
šode
)

1944 
bŒfs_d–ayed_node
 *
d–ayed_node
;

1945 
»t
 = 0;

1947 
d–ayed_node
 = 
	`bŒfs_g‘_Ü_ü—‹_d–ayed_node
(
šode
);

1948 ià(
	`IS_ERR
(
d–ayed_node
))

1949  
	`PTR_ERR
(
d–ayed_node
);

1951 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

1952 ià(
	`‹¡_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
d–ayed_node
->
æags
)) {

1953 
	`fl_¡ack_šode_™em
(
Œªs
, &
d–ayed_node
->
šode_™em
,

1954 &
šode
->
vfs_šode
);

1955 
»Ëa£_node
;

1958 
»t
 = 
	`bŒfs_d–ayed_šode_»£rve_m‘ad©a
(
Œªs
, 
roÙ
, 
d–ayed_node
);

1959 ià(
»t
)

1960 
»Ëa£_node
;

1962 
	`fl_¡ack_šode_™em
(
Œªs
, &
d–ayed_node
->
šode_™em
, &
šode
->
vfs_šode
);

1963 
	`£t_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
d–ayed_node
->
æags
);

1964 
d–ayed_node
->
couÁ
++;

1965 
	`©omic_šc
(&
roÙ
->
fs_šfo
->
d–ayed_roÙ
->
™ems
);

1966 
»Ëa£_node
:

1967 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1968 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1969  
»t
;

1970 
	}
}

1972 
	$bŒfs_d–ayed_d–‘e_šode_»f
(
bŒfs_šode
 *
šode
)

1974 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

1975 
bŒfs_d–ayed_node
 *
d–ayed_node
;

1982 ià(
	`‹¡_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
))

1983  -
EAGAIN
;

1985 
d–ayed_node
 = 
	`bŒfs_g‘_Ü_ü—‹_d–ayed_node
(
šode
);

1986 ià(
	`IS_ERR
(
d–ayed_node
))

1987  
	`PTR_ERR
(
d–ayed_node
);

2003 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

2004 ià(
	`‹¡_b™
(
BTRFS_DELAYED_NODE_DEL_IREF
, &
d–ayed_node
->
æags
))

2005 
»Ëa£_node
;

2007 
	`£t_b™
(
BTRFS_DELAYED_NODE_DEL_IREF
, &
d–ayed_node
->
æags
);

2008 
d–ayed_node
->
couÁ
++;

2009 
	`©omic_šc
(&
fs_šfo
->
d–ayed_roÙ
->
™ems
);

2010 
»Ëa£_node
:

2011 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

2012 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

2014 
	}
}

2016 
	$__bŒfs_kl_d–ayed_node
(
bŒfs_d–ayed_node
 *
d–ayed_node
)

2018 
bŒfs_roÙ
 *
roÙ
 = 
d–ayed_node
->root;

2019 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2020 
bŒfs_d–ayed_™em
 *
cu¼_™em
, *
´ev_™em
;

2022 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

2023 
cu¼_™em
 = 
	`__bŒfs_fœ¡_d–ayed_š£¹iÚ_™em
(
d–ayed_node
);

2024 
cu¼_™em
) {

2025 
´ev_™em
 = 
cu¼_™em
;

2026 
cu¼_™em
 = 
	`__bŒfs_Ãxt_d–ayed_™em
(
´ev_™em
);

2027 
	`bŒfs_»Ëa£_d–ayed_™em
(
´ev_™em
);

2030 ià(
d–ayed_node
->
šdex_™em_Ëaves
 > 0) {

2031 
	`bŒfs_d–ayed_™em_»Ëa£_Ëaves
(
d–ayed_node
,

2032 
d–ayed_node
->
šdex_™em_Ëaves
);

2033 
d–ayed_node
->
šdex_™em_Ëaves
 = 0;

2036 
cu¼_™em
 = 
	`__bŒfs_fœ¡_d–ayed_d–‘iÚ_™em
(
d–ayed_node
);

2037 
cu¼_™em
) {

2038 
	`bŒfs_d–ayed_™em_»Ëa£_m‘ad©a
(
roÙ
, 
cu¼_™em
);

2039 
´ev_™em
 = 
cu¼_™em
;

2040 
cu¼_™em
 = 
	`__bŒfs_Ãxt_d–ayed_™em
(
´ev_™em
);

2041 
	`bŒfs_»Ëa£_d–ayed_™em
(
´ev_™em
);

2044 
	`bŒfs_»Ëa£_d–ayed_œef
(
d–ayed_node
);

2046 ià(
	`‹¡_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
d–ayed_node
->
æags
)) {

2047 
	`bŒfs_d–ayed_šode_»Ëa£_m‘ad©a
(
fs_šfo
, 
d–ayed_node
, 
çl£
);

2048 
	`bŒfs_»Ëa£_d–ayed_šode
(
d–ayed_node
);

2050 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

2051 
	}
}

2053 
	$bŒfs_kl_d–ayed_šode_™ems
(
bŒfs_šode
 *
šode
)

2055 
bŒfs_d–ayed_node
 *
d–ayed_node
;

2057 
d–ayed_node
 = 
	`bŒfs_g‘_d–ayed_node
(
šode
);

2058 ià(!
d–ayed_node
)

2061 
	`__bŒfs_kl_d–ayed_node
(
d–ayed_node
);

2062 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

2063 
	}
}

2065 
	$bŒfs_kl_®l_d–ayed_nodes
(
bŒfs_roÙ
 *
roÙ
)

2067 
u64
 
šode_id
 = 0;

2068 
bŒfs_d–ayed_node
 *
d–ayed_nodes
[8];

2069 
i
, 
n
;

2072 
	`¥š_lock
(&
roÙ
->
šode_lock
);

2073 
n
 = 
	`¿dix_Œ“_gªg_lookup
(&
roÙ
->
d–ayed_nodes_Œ“
,

2074 (**)
d–ayed_nodes
, 
šode_id
,

2075 
	`ARRAY_SIZE
(
d–ayed_nodes
));

2076 ià(!
n
) {

2077 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

2081 
šode_id
 = 
d–ayed_nodes
[
n
 - 1]->inode_id + 1;

2082 
i
 = 0; i < 
n
; i++) {

2087 ià(!
	`»fcouÁ_šc_nÙ_z”o
(&
d–ayed_nodes
[
i
]->
»fs
))

2088 
d–ayed_nodes
[
i
] = 
NULL
;

2090 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

2092 
i
 = 0; i < 
n
; i++) {

2093 ià(!
d–ayed_nodes
[
i
])

2095 
	`__bŒfs_kl_d–ayed_node
(
d–ayed_nodes
[
i
]);

2096 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_nodes
[
i
]);

2099 
	}
}

2101 
	$bŒfs_de¡roy_d–ayed_šodes
(
bŒfs_fs_šfo
 *
fs_šfo
)

2103 
bŒfs_d–ayed_node
 *
cu¼_node
, *
´ev_node
;

2105 
cu¼_node
 = 
	`bŒfs_fœ¡_d–ayed_node
(
fs_šfo
->
d–ayed_roÙ
);

2106 
cu¼_node
) {

2107 
	`__bŒfs_kl_d–ayed_node
(
cu¼_node
);

2109 
´ev_node
 = 
cu¼_node
;

2110 
cu¼_node
 = 
	`bŒfs_Ãxt_d–ayed_node
(curr_node);

2111 
	`bŒfs_»Ëa£_d–ayed_node
(
´ev_node
);

2113 
	}
}

2115 
	$bŒfs_log_g‘_d–ayed_™ems
(
bŒfs_šode
 *
šode
,

2116 
li¡_h—d
 *
šs_li¡
,

2117 
li¡_h—d
 *
d–_li¡
)

2119 
bŒfs_d–ayed_node
 *
node
;

2120 
bŒfs_d–ayed_™em
 *
™em
;

2122 
node
 = 
	`bŒfs_g‘_d–ayed_node
(
šode
);

2123 ià(!
node
)

2126 
	`mu‹x_lock
(&
node
->
mu‹x
);

2127 
™em
 = 
	`__bŒfs_fœ¡_d–ayed_š£¹iÚ_™em
(
node
);

2128 
™em
) {

2152 ià(!
™em
->
logged
 && 
	`li¡_em±y
(&™em->
log_li¡
)) {

2153 
	`»fcouÁ_šc
(&
™em
->
»fs
);

2154 
	`li¡_add_
(&
™em
->
log_li¡
, 
šs_li¡
);

2156 
™em
 = 
	`__bŒfs_Ãxt_d–ayed_™em
(item);

2159 
™em
 = 
	`__bŒfs_fœ¡_d–ayed_d–‘iÚ_™em
(
node
);

2160 
™em
) {

2162 ià(!
™em
->
logged
 && 
	`li¡_em±y
(&™em->
log_li¡
)) {

2163 
	`»fcouÁ_šc
(&
™em
->
»fs
);

2164 
	`li¡_add_
(&
™em
->
log_li¡
, 
d–_li¡
);

2166 
™em
 = 
	`__bŒfs_Ãxt_d–ayed_™em
(item);

2168 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

2179 
	`ASSERT
(
	`»fcouÁ_»ad
(&
node
->
»fs
) > 1);

2180 
	`»fcouÁ_dec
(&
node
->
»fs
);

2181 
	}
}

2183 
	$bŒfs_log_put_d–ayed_™ems
(
bŒfs_šode
 *
šode
,

2184 
li¡_h—d
 *
šs_li¡
,

2185 
li¡_h—d
 *
d–_li¡
)

2187 
bŒfs_d–ayed_node
 *
node
;

2188 
bŒfs_d–ayed_™em
 *
™em
;

2189 
bŒfs_d–ayed_™em
 *
Ãxt
;

2191 
node
 = 
	`bŒfs_g‘_d–ayed_node
(
šode
);

2192 ià(!
node
)

2195 
	`mu‹x_lock
(&
node
->
mu‹x
);

2197 
	`li¡_fÜ_—ch_’Œy_§ã
(
™em
, 
Ãxt
, 
šs_li¡
, 
log_li¡
) {

2198 
™em
->
logged
 = 
Œue
;

2199 
	`li¡_d–_š™
(&
™em
->
log_li¡
);

2200 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
™em
->
»fs
))

2201 
	`kä“
(
™em
);

2204 
	`li¡_fÜ_—ch_’Œy_§ã
(
™em
, 
Ãxt
, 
d–_li¡
, 
log_li¡
) {

2205 
™em
->
logged
 = 
Œue
;

2206 
	`li¡_d–_š™
(&
™em
->
log_li¡
);

2207 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
™em
->
»fs
))

2208 
	`kä“
(
™em
);

2211 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

2222 
	`ASSERT
(
	`»fcouÁ_»ad
(&
node
->
»fs
) > 1);

2223 
	`»fcouÁ_dec
(&
node
->
»fs
);

2224 
	}
}

	@delayed-inode.h

7 #iâdeà
BTRFS_DELAYED_INODE_H


8 
	#BTRFS_DELAYED_INODE_H


	)

10 
	~<lšux/rbŒ“.h
>

11 
	~<lšux/¥šlock.h
>

12 
	~<lšux/mu‹x.h
>

13 
	~<lšux/li¡.h
>

14 
	~<lšux/wa™.h
>

15 
	~<lšux/©omic.h
>

16 
	~<lšux/»fcouÁ.h
>

17 
	~"ù»e.h
"

19 
	ebŒfs_d–ayed_™em_ty³
 {

20 
	mBTRFS_DELAYED_INSERTION_ITEM
,

21 
	mBTRFS_DELAYED_DELETION_ITEM


24 
	sbŒfs_d–ayed_roÙ
 {

25 
¥šlock_t
 
	mlock
;

26 
li¡_h—d
 
	mnode_li¡
;

32 
li¡_h—d
 
	m´•¬e_li¡
;

33 
©omic_t
 
	m™ems
;

34 
©omic_t
 
	m™ems_£q
;

35 
	mnodes
;

36 
wa™_queue_h—d_t
 
	mwa™
;

39 
	#BTRFS_DELAYED_NODE_IN_LIST
 0

	)

40 
	#BTRFS_DELAYED_NODE_INODE_DIRTY
 1

	)

41 
	#BTRFS_DELAYED_NODE_DEL_IREF
 2

	)

43 
	sbŒfs_d–ayed_node
 {

44 
u64
 
	mšode_id
;

45 
u64
 
	mby‹s_»£rved
;

46 
bŒfs_roÙ
 *
	mroÙ
;

48 
li¡_h—d
 
	mn_li¡
;

53 
li¡_h—d
 
	mp_li¡
;

54 
rb_roÙ_ÿched
 
	mšs_roÙ
;

55 
rb_roÙ_ÿched
 
	md–_roÙ
;

56 
mu‹x
 
	mmu‹x
;

57 
bŒfs_šode_™em
 
	mšode_™em
;

58 
»fcouÁ_t
 
	m»fs
;

59 
u64
 
	mšdex_út
;

60 
	mæags
;

61 
	mcouÁ
;

66 
u32
 
	mcu¼_šdex_b©ch_size
;

72 
u32
 
	mšdex_™em_Ëaves
;

75 
	sbŒfs_d–ayed_™em
 {

76 
rb_node
 
	mrb_node
;

78 
u64
 
	mšdex
;

79 
li¡_h—d
 
	mŒ“_li¡
;

80 
li¡_h—d
 
	m»addœ_li¡
;

86 
li¡_h—d
 
	mlog_li¡
;

87 
u64
 
	mby‹s_»£rved
;

88 
bŒfs_d–ayed_node
 *
	md–ayed_node
;

89 
»fcouÁ_t
 
	m»fs
;

90 
bŒfs_d–ayed_™em_ty³
 
	mty³
:8;

95 
boŞ
 
	mlogged
;

97 
u16
 
	md©a_Ën
;

98 
	md©a
[] 
__couÁed_by
(
d©a_Ën
);

101 
šlše
 
	$bŒfs_š™_d–ayed_roÙ
(

102 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
)

104 
	`©omic_£t
(&
d–ayed_roÙ
->
™ems
, 0);

105 
	`©omic_£t
(&
d–ayed_roÙ
->
™ems_£q
, 0);

106 
d–ayed_roÙ
->
nodes
 = 0;

107 
	`¥š_lock_š™
(&
d–ayed_roÙ
->
lock
);

108 
	`š™_wa™queue_h—d
(&
d–ayed_roÙ
->
wa™
);

109 
	`INIT_LIST_HEAD
(&
d–ayed_roÙ
->
node_li¡
);

110 
	`INIT_LIST_HEAD
(&
d–ayed_roÙ
->
´•¬e_li¡
);

111 
	}
}

113 
bŒfs_š£¹_d–ayed_dœ_šdex
(
bŒfs_Œªs_hªdË
 *
Œªs
,

114 cÚ¡ *
Çme
, 
Çme_Ën
,

115 
bŒfs_šode
 *
dœ
,

116 
bŒfs_disk_key
 *
disk_key
, 
u8
 
æags
,

117 
u64
 
šdex
);

119 
bŒfs_d–‘e_d–ayed_dœ_šdex
(
bŒfs_Œªs_hªdË
 *
Œªs
,

120 
bŒfs_šode
 *
dœ
, 
u64
 
šdex
);

122 
bŒfs_šode_d–ayed_dœ_šdex_couÁ
(
bŒfs_šode
 *
šode
);

124 
bŒfs_run_d–ayed_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
);

125 
bŒfs_run_d–ayed_™ems_Ä
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
Ä
);

127 
bŒfs_b®ªû_d–ayed_™ems
(
bŒfs_fs_šfo
 *
fs_šfo
);

129 
bŒfs_comm™_šode_d–ayed_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

130 
bŒfs_šode
 *
šode
);

132 
bŒfs_»move_d–ayed_node
(
bŒfs_šode
 *
šode
);

133 
bŒfs_kl_d–ayed_šode_™ems
(
bŒfs_šode
 *
šode
);

134 
bŒfs_comm™_šode_d–ayed_šode
(
bŒfs_šode
 *
šode
);

137 
bŒfs_d–ayed_upd©e_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

138 
bŒfs_roÙ
 *
roÙ
,

139 
bŒfs_šode
 *
šode
);

140 
bŒfs_fl_šode
(
šode
 *šode, 
u32
 *
rdev
);

141 
bŒfs_d–ayed_d–‘e_šode_»f
(
bŒfs_šode
 *
šode
);

144 
bŒfs_kl_®l_d–ayed_nodes
(
bŒfs_roÙ
 *
roÙ
);

147 
bŒfs_de¡roy_d–ayed_šodes
(
bŒfs_fs_šfo
 *
fs_šfo
);

150 
boŞ
 
bŒfs_»addœ_g‘_d–ayed_™ems
(
šode
 *inode,

151 
u64
 
Ï¡_šdex
,

152 
li¡_h—d
 *
šs_li¡
,

153 
li¡_h—d
 *
d–_li¡
);

154 
bŒfs_»addœ_put_d–ayed_™ems
(
šode
 *inode,

155 
li¡_h—d
 *
šs_li¡
,

156 
li¡_h—d
 *
d–_li¡
);

157 
bŒfs_should_d–‘e_dœ_šdex
(
li¡_h—d
 *
d–_li¡
,

158 
u64
 
šdex
);

159 
bŒfs_»addœ_d–ayed_dœ_šdex
(
dœ_cÚ‹xt
 *
ùx
,

160 
li¡_h—d
 *
šs_li¡
);

163 
bŒfs_log_g‘_d–ayed_™ems
(
bŒfs_šode
 *
šode
,

164 
li¡_h—d
 *
šs_li¡
,

165 
li¡_h—d
 *
d–_li¡
);

166 
bŒfs_log_put_d–ayed_™ems
(
bŒfs_šode
 *
šode
,

167 
li¡_h—d
 *
šs_li¡
,

168 
li¡_h—d
 *
d–_li¡
);

171 
__š™
 
bŒfs_d–ayed_šode_š™
();

172 
__cŞd
 
bŒfs_d–ayed_šode_ex™
();

175 
bŒfs_as£¹_d–ayed_roÙ_em±y
(
bŒfs_fs_šfo
 *
fs_šfo
);

	@delayed-ref.c

6 
	~<lšux/sched.h
>

7 
	~<lšux/¦ab.h
>

8 
	~<lšux/sÜt.h
>

9 
	~"mes§ges.h
"

10 
	~"ù»e.h
"

11 
	~"d–ayed-»f.h
"

12 
	~"Œª§ùiÚ.h
"

13 
	~"qgroup.h
"

14 
	~"¥aû-šfo.h
"

15 
	~"Œ“-mod-log.h
"

16 
	~"fs.h
"

18 
kmem_ÿche
 *
	gbŒfs_d–ayed_»f_h—d_ÿch•
;

19 
kmem_ÿche
 *
	gbŒfs_d–ayed_Œ“_»f_ÿch•
;

20 
kmem_ÿche
 *
	gbŒfs_d–ayed_d©a_»f_ÿch•
;

21 
kmem_ÿche
 *
	gbŒfs_d–ayed_ex‹Á_İ_ÿch•
;

31 
boŞ
 
	$bŒfs_check_¥aû_fÜ_d–ayed_»fs
(
bŒfs_fs_šfo
 *
fs_šfo
)

33 
bŒfs_block_rsv
 *
d–ayed_»fs_rsv
 = &
fs_šfo
->delayed_refs_rsv;

34 
bŒfs_block_rsv
 *
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

35 
boŞ
 
»t
 = 
çl£
;

36 
u64
 
»£rved
;

38 
	`¥š_lock
(&
glob®_rsv
->
lock
);

39 
»£rved
 = 
glob®_rsv
->reserved;

40 
	`¥š_uÆock
(&
glob®_rsv
->
lock
);

48 
	`¥š_lock
(&
d–ayed_»fs_rsv
->
lock
);

49 
»£rved
 +ğ
d–ayed_»fs_rsv
->reserved;

50 ià(
d–ayed_»fs_rsv
->
size
 >ğ
»£rved
)

51 
»t
 = 
Œue
;

52 
	`¥š_uÆock
(&
d–ayed_»fs_rsv
->
lock
);

53  
»t
;

54 
	}
}

65 
	$bŒfs_d–ayed_»fs_rsv_»Ëa£
(
bŒfs_fs_šfo
 *
fs_šfo
, 
Ä
)

67 
bŒfs_block_rsv
 *
block_rsv
 = &
fs_šfo
->
d–ayed_»fs_rsv
;

68 cÚ¡ 
u64
 
num_by‹s
 = 
	`bŒfs_ÿlc_d–ayed_»f_by‹s
(
fs_šfo
, 
Ä
);

69 
u64
 
»Ëa£d
 = 0;

71 
»Ëa£d
 = 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
block_rsv
, 
num_by‹s
, 
NULL
);

72 ià(
»Ëa£d
)

73 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "delayed_refs_rsv",

74 0, 
»Ëa£d
, 0);

75 
	}
}

83 
	$bŒfs_upd©e_d–ayed_»fs_rsv
(
bŒfs_Œªs_hªdË
 *
Œªs
)

85 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

86 
bŒfs_block_rsv
 *
d–ayed_rsv
 = &
fs_šfo
->
d–ayed_»fs_rsv
;

87 
u64
 
num_by‹s
;

89 ià(!
Œªs
->
d–ayed_»f_upd©es
)

92 
num_by‹s
 = 
	`bŒfs_ÿlc_d–ayed_»f_by‹s
(
fs_šfo
,

93 
Œªs
->
d–ayed_»f_upd©es
);

95 
	`¥š_lock
(&
d–ayed_rsv
->
lock
);

96 
d–ayed_rsv
->
size
 +ğ
num_by‹s
;

97 
d–ayed_rsv
->
fuÎ
 = 
çl£
;

98 
	`¥š_uÆock
(&
d–ayed_rsv
->
lock
);

99 
Œªs
->
d–ayed_»f_upd©es
 = 0;

100 
	}
}

111 
	$bŒfs_mig¿‹_to_d–ayed_»fs_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
,

112 
u64
 
num_by‹s
)

114 
bŒfs_block_rsv
 *
d–ayed_»fs_rsv
 = &
fs_šfo
->delayed_refs_rsv;

115 
u64
 
to_ä“
 = 0;

117 
	`¥š_lock
(&
d–ayed_»fs_rsv
->
lock
);

118 ià(
d–ayed_»fs_rsv
->
size
 > d–ayed_»fs_rsv->
»£rved
) {

119 
u64
 
d–
 = 
d–ayed_»fs_rsv
->
size
 -

120 
d–ayed_»fs_rsv
->
»£rved
;

121 ià(
num_by‹s
 > 
d–
) {

122 
to_ä“
 = 
num_by‹s
 - 
d–
;

123 
num_by‹s
 = 
d–
;

126 
to_ä“
 = 
num_by‹s
;

127 
num_by‹s
 = 0;

130 ià(
num_by‹s
)

131 
d–ayed_»fs_rsv
->
»£rved
 +ğ
num_by‹s
;

132 ià(
d–ayed_»fs_rsv
->
»£rved
 >ğd–ayed_»fs_rsv->
size
)

133 
d–ayed_»fs_rsv
->
fuÎ
 = 
Œue
;

134 
	`¥š_uÆock
(&
d–ayed_»fs_rsv
->
lock
);

136 ià(
num_by‹s
)

137 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "delayed_refs_rsv",

138 0, 
num_by‹s
, 1);

139 ià(
to_ä“
)

140 
	`bŒfs_¥aû_šfo_ä“_by‹s_may_u£
(
fs_šfo
,

141 
d–ayed_»fs_rsv
->
¥aû_šfo
, 
to_ä“
);

142 
	}
}

153 
	$bŒfs_d–ayed_»fs_rsv_»fl
(
bŒfs_fs_šfo
 *
fs_šfo
,

154 
bŒfs_»£rve_æush_’um
 
æush
)

156 
bŒfs_block_rsv
 *
block_rsv
 = &
fs_šfo
->
d–ayed_»fs_rsv
;

157 
u64
 
lim™
 = 
	`bŒfs_ÿlc_d–ayed_»f_by‹s
(
fs_šfo
, 1);

158 
u64
 
num_by‹s
 = 0;

159 
u64
 
»fËd_by‹s
;

160 
u64
 
to_ä“
;

161 
»t
 = -
ENOSPC
;

163 
	`¥š_lock
(&
block_rsv
->
lock
);

164 ià(
block_rsv
->
»£rved
 < block_rsv->
size
) {

165 
num_by‹s
 = 
block_rsv
->
size
 - block_rsv->
»£rved
;

166 
num_by‹s
 = 
	`mš
Òum_by‹s, 
lim™
);

168 
	`¥š_uÆock
(&
block_rsv
->
lock
);

170 ià(!
num_by‹s
)

173 
»t
 = 
	`bŒfs_»£rve_m‘ad©a_by‹s
(
fs_šfo
, 
block_rsv
, 
num_by‹s
, 
æush
);

174 ià(
»t
)

175  
»t
;

181 
	`¥š_lock
(&
block_rsv
->
lock
);

182 ià(
block_rsv
->
»£rved
 < block_rsv->
size
) {

183 
u64
 
Ãeded
 = 
block_rsv
->
size
 - block_rsv->
»£rved
;

185 ià(
num_by‹s
 >ğ
Ãeded
) {

186 
block_rsv
->
»£rved
 +ğ
Ãeded
;

187 
block_rsv
->
fuÎ
 = 
Œue
;

188 
to_ä“
 = 
num_by‹s
 - 
Ãeded
;

189 
»fËd_by‹s
 = 
Ãeded
;

191 
block_rsv
->
»£rved
 +ğ
num_by‹s
;

192 
to_ä“
 = 0;

193 
»fËd_by‹s
 = 
num_by‹s
;

196 
to_ä“
 = 
num_by‹s
;

197 
»fËd_by‹s
 = 0;

199 
	`¥š_uÆock
(&
block_rsv
->
lock
);

201 ià(
to_ä“
 > 0)

202 
	`bŒfs_¥aû_šfo_ä“_by‹s_may_u£
(
fs_šfo
, 
block_rsv
->
¥aû_šfo
,

203 
to_ä“
);

205 ià(
»fËd_by‹s
 > 0)

206 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "delayed_refs_rsv", 0,

207 
»fËd_by‹s
, 1);

209 
	}
}

214 
	$comp_Œ“_»fs
(
bŒfs_d–ayed_Œ“_»f
 *
»f1
,

215 
bŒfs_d–ayed_Œ“_»f
 *
»f2
)

217 ià(
»f1
->
node
.
ty³
 =ğ
BTRFS_TREE_BLOCK_REF_KEY
) {

218 ià(
»f1
->
roÙ
 < 
»f2
->root)

220 ià(
»f1
->
roÙ
 > 
»f2
->root)

223 ià(
»f1
->
·»Á
 < 
»f2
->parent)

225 ià(
»f1
->
·»Á
 > 
»f2
->parent)

229 
	}
}

234 
	$comp_d©a_»fs
(
bŒfs_d–ayed_d©a_»f
 *
»f1
,

235 
bŒfs_d–ayed_d©a_»f
 *
»f2
)

237 ià(
»f1
->
node
.
ty³
 =ğ
BTRFS_EXTENT_DATA_REF_KEY
) {

238 ià(
»f1
->
roÙ
 < 
»f2
->root)

240 ià(
»f1
->
roÙ
 > 
»f2
->root)

242 ià(
»f1
->
objeùid
 < 
»f2
->objectid)

244 ià(
»f1
->
objeùid
 > 
»f2
->objectid)

246 ià(
»f1
->
off£t
 < 
»f2
->offset)

248 ià(
»f1
->
off£t
 > 
»f2
->offset)

251 ià(
»f1
->
·»Á
 < 
»f2
->parent)

253 ià(
»f1
->
·»Á
 > 
»f2
->parent)

257 
	}
}

259 
	$comp_»fs
(
bŒfs_d–ayed_»f_node
 *
»f1
,

260 
bŒfs_d–ayed_»f_node
 *
»f2
,

261 
boŞ
 
check_£q
)

263 
»t
 = 0;

265 ià(
»f1
->
ty³
 < 
»f2
->type)

267 ià(
»f1
->
ty³
 > 
»f2
->type)

269 ià(
»f1
->
ty³
 =ğ
BTRFS_TREE_BLOCK_REF_KEY
 ||

270 
»f1
->
ty³
 =ğ
BTRFS_SHARED_BLOCK_REF_KEY
)

271 
»t
 = 
	`comp_Œ“_»fs
(
	`bŒfs_d–ayed_node_to_Œ“_»f
(
»f1
),

272 
	`bŒfs_d–ayed_node_to_Œ“_»f
(
»f2
));

274 
»t
 = 
	`comp_d©a_»fs
(
	`bŒfs_d–ayed_node_to_d©a_»f
(
»f1
),

275 
	`bŒfs_d–ayed_node_to_d©a_»f
(
»f2
));

276 ià(
»t
)

277  
»t
;

278 ià(
check_£q
) {

279 ià(
»f1
->
£q
 < 
»f2
->seq)

281 ià(
»f1
->
£q
 > 
»f2
->seq)

285 
	}
}

288 
bŒfs_d–ayed_»f_h—d
 *
	$hŒ“_š£¹
(
rb_roÙ_ÿched
 *
roÙ
,

289 
rb_node
 *
node
)

291 
rb_node
 **
p
 = &
roÙ
->
rb_roÙ
.rb_node;

292 
rb_node
 *
·»Á_node
 = 
NULL
;

293 
bŒfs_d–ayed_»f_h—d
 *
’Œy
;

294 
bŒfs_d–ayed_»f_h—d
 *
šs
;

295 
u64
 
by‹Ä
;

296 
boŞ
 
Ëámo¡
 = 
Œue
;

298 
šs
 = 
	`rb_’Œy
(
node
, 
bŒfs_d–ayed_»f_h—d
, 
h»f_node
);

299 
by‹Ä
 = 
šs
->bytenr;

300 *
p
) {

301 
·»Á_node
 = *
p
;

302 
’Œy
 = 
	`rb_’Œy
(
·»Á_node
, 
bŒfs_d–ayed_»f_h—d
,

303 
h»f_node
);

305 ià(
by‹Ä
 < 
’Œy
->bytenr) {

306 
p
 = &(*p)->
rb_Ëá
;

307 } ià(
by‹Ä
 > 
’Œy
->bytenr) {

308 
p
 = &(*p)->
rb_right
;

309 
Ëámo¡
 = 
çl£
;

311  
’Œy
;

315 
	`rb_lšk_node
(
node
, 
·»Á_node
, 
p
);

316 
	`rb_š£¹_cŞÜ_ÿched
(
node
, 
roÙ
, 
Ëámo¡
);

317  
NULL
;

318 
	}
}

320 
bŒfs_d–ayed_»f_node
* 
	$Œ“_š£¹
(
rb_roÙ_ÿched
 *
roÙ
,

321 
bŒfs_d–ayed_»f_node
 *
šs
)

323 
rb_node
 **
p
 = &
roÙ
->
rb_roÙ
.rb_node;

324 
rb_node
 *
node
 = &
šs
->
»f_node
;

325 
rb_node
 *
·»Á_node
 = 
NULL
;

326 
bŒfs_d–ayed_»f_node
 *
’Œy
;

327 
boŞ
 
Ëámo¡
 = 
Œue
;

329 *
p
) {

330 
comp
;

332 
·»Á_node
 = *
p
;

333 
’Œy
 = 
	`rb_’Œy
(
·»Á_node
, 
bŒfs_d–ayed_»f_node
,

334 
»f_node
);

335 
comp
 = 
	`comp_»fs
(
šs
, 
’Œy
, 
Œue
);

336 ià(
comp
 < 0) {

337 
p
 = &(*p)->
rb_Ëá
;

338 } ià(
comp
 > 0) {

339 
p
 = &(*p)->
rb_right
;

340 
Ëámo¡
 = 
çl£
;

342  
’Œy
;

346 
	`rb_lšk_node
(
node
, 
·»Á_node
, 
p
);

347 
	`rb_š£¹_cŞÜ_ÿched
(
node
, 
roÙ
, 
Ëámo¡
);

348  
NULL
;

349 
	}
}

351 
bŒfs_d–ayed_»f_h—d
 *
	$fšd_fœ¡_»f_h—d
(

352 
bŒfs_d–ayed_»f_roÙ
 *
dr
)

354 
rb_node
 *
n
;

355 
bŒfs_d–ayed_»f_h—d
 *
’Œy
;

357 
n
 = 
	`rb_fœ¡_ÿched
(&
dr
->
h»f_roÙ
);

358 ià(!
n
)

359  
NULL
;

361 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_d–ayed_»f_h—d
, 
h»f_node
);

363  
’Œy
;

364 
	}
}

371 
bŒfs_d–ayed_»f_h—d
 *
	$fšd_»f_h—d
(

372 
bŒfs_d–ayed_»f_roÙ
 *
dr
, 
u64
 
by‹Ä
,

373 
boŞ
 
»tuº_bigg”
)

375 
rb_roÙ
 *
roÙ
 = &
dr
->
h»f_roÙ
.rb_root;

376 
rb_node
 *
n
;

377 
bŒfs_d–ayed_»f_h—d
 *
’Œy
;

379 
n
 = 
roÙ
->
rb_node
;

380 
’Œy
 = 
NULL
;

381 
n
) {

382 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_d–ayed_»f_h—d
, 
h»f_node
);

384 ià(
by‹Ä
 < 
’Œy
->bytenr)

385 
n
 =‚->
rb_Ëá
;

386 ià(
by‹Ä
 > 
’Œy
->bytenr)

387 
n
 =‚->
rb_right
;

389  
’Œy
;

391 ià(
’Œy
 && 
»tuº_bigg”
) {

392 ià(
by‹Ä
 > 
’Œy
->bytenr) {

393 
n
 = 
	`rb_Ãxt
(&
’Œy
->
h»f_node
);

394 ià(!
n
)

395  
NULL
;

396 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_d–ayed_»f_h—d
,

397 
h»f_node
);

399  
’Œy
;

401  
NULL
;

402 
	}
}

404 
	$bŒfs_d–ayed_»f_lock
(
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

405 
bŒfs_d–ayed_»f_h—d
 *
h—d
)

407 
	`lockd•_as£¹_h–d
(&
d–ayed_»fs
->
lock
);

408 ià(
	`mu‹x_Œylock
(&
h—d
->
mu‹x
))

411 
	`»fcouÁ_šc
(&
h—d
->
»fs
);

412 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

414 
	`mu‹x_lock
(&
h—d
->
mu‹x
);

415 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

416 ià(
	`RB_EMPTY_NODE
(&
h—d
->
h»f_node
)) {

417 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

418 
	`bŒfs_put_d–ayed_»f_h—d
(
h—d
);

419  -
EAGAIN
;

421 
	`bŒfs_put_d–ayed_»f_h—d
(
h—d
);

423 
	}
}

425 
šlše
 
	$drİ_d–ayed_»f
(
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

426 
bŒfs_d–ayed_»f_h—d
 *
h—d
,

427 
bŒfs_d–ayed_»f_node
 *
»f
)

429 
	`lockd•_as£¹_h–d
(&
h—d
->
lock
);

430 
	`rb_”a£_ÿched
(&
»f
->
»f_node
, &
h—d
->
»f_Œ“
);

431 
	`RB_CLEAR_NODE
(&
»f
->
»f_node
);

432 ià(!
	`li¡_em±y
(&
»f
->
add_li¡
))

433 
	`li¡_d–
(&
»f
->
add_li¡
);

434 
	`bŒfs_put_d–ayed_»f
(
»f
);

435 
	`©omic_dec
(&
d–ayed_»fs
->
num_’Œ›s
);

436 
	}
}

438 
boŞ
 
	$m”ge_»f
(
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

439 
bŒfs_d–ayed_»f_h—d
 *
h—d
,

440 
bŒfs_d–ayed_»f_node
 *
»f
,

441 
u64
 
£q
)

443 
bŒfs_d–ayed_»f_node
 *
Ãxt
;

444 
rb_node
 *
node
 = 
	`rb_Ãxt
(&
»f
->
»f_node
);

445 
boŞ
 
dÚe
 = 
çl£
;

447 !
dÚe
 && 
node
) {

448 
mod
;

450 
Ãxt
 = 
	`rb_’Œy
(
node
, 
bŒfs_d–ayed_»f_node
, 
»f_node
);

451 
node
 = 
	`rb_Ãxt
(node);

452 ià(
£q
 && 
Ãxt
->seq >= seq)

454 ià(
	`comp_»fs
(
»f
, 
Ãxt
, 
çl£
))

457 ià(
»f
->
aùiÚ
 =ğ
Ãxt
->action) {

458 
mod
 = 
Ãxt
->
»f_mod
;

460 ià(
»f
->
»f_mod
 < 
Ãxt
->ref_mod) {

461 
	`sw­
(
»f
, 
Ãxt
);

462 
dÚe
 = 
Œue
;

464 
mod
 = -
Ãxt
->
»f_mod
;

467 
	`drİ_d–ayed_»f
(
d–ayed_»fs
, 
h—d
, 
Ãxt
);

468 
»f
->
»f_mod
 +ğ
mod
;

469 ià(
»f
->
»f_mod
 == 0) {

470 
	`drİ_d–ayed_»f
(
d–ayed_»fs
, 
h—d
, 
»f
);

471 
dÚe
 = 
Œue
;

476 
	`WARN_ON
(
»f
->
ty³
 =ğ
BTRFS_TREE_BLOCK_REF_KEY
 ||

477 
»f
->
ty³
 =ğ
BTRFS_SHARED_BLOCK_REF_KEY
);

481  
dÚe
;

482 
	}
}

484 
	$bŒfs_m”ge_d–ayed_»fs
(
bŒfs_fs_šfo
 *
fs_šfo
,

485 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

486 
bŒfs_d–ayed_»f_h—d
 *
h—d
)

488 
bŒfs_d–ayed_»f_node
 *
»f
;

489 
rb_node
 *
node
;

490 
u64
 
£q
 = 0;

492 
	`lockd•_as£¹_h–d
(&
h—d
->
lock
);

494 ià(
	`RB_EMPTY_ROOT
(&
h—d
->
»f_Œ“
.
rb_roÙ
))

498 ià(
h—d
->
is_d©a
)

501 
£q
 = 
	`bŒfs_Œ“_mod_log_lowe¡_£q
(
fs_šfo
);

502 
agaš
:

503 
node
 = 
	`rb_fœ¡_ÿched
(&
h—d
->
»f_Œ“
);‚ode;

504 
node
 = 
	`rb_Ãxt
(node)) {

505 
»f
 = 
	`rb_’Œy
(
node
, 
bŒfs_d–ayed_»f_node
, 
»f_node
);

506 ià(
£q
 && 
»f
->seq >= seq)

508 ià(
	`m”ge_»f
(
d–ayed_»fs
, 
h—d
, 
»f
, 
£q
))

509 
agaš
;

511 
	}
}

513 
	$bŒfs_check_d–ayed_£q
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
£q
)

515 
»t
 = 0;

516 
u64
 
mš_£q
 = 
	`bŒfs_Œ“_mod_log_lowe¡_£q
(
fs_šfo
);

518 ià(
mš_£q
 !ğ0 && 
£q
 >= min_seq) {

519 
	`bŒfs_debug
(
fs_šfo
,

521 
£q
, 
mš_£q
);

522 
»t
 = 1;

525  
»t
;

526 
	}
}

528 
bŒfs_d–ayed_»f_h—d
 *
	$bŒfs_£Ëù_»f_h—d
(

529 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
)

531 
bŒfs_d–ayed_»f_h—d
 *
h—d
;

533 
	`lockd•_as£¹_h–d
(&
d–ayed_»fs
->
lock
);

534 
agaš
:

535 
h—d
 = 
	`fšd_»f_h—d
(
d–ayed_»fs
, d–ayed_»fs->
run_d–ayed_¡¬t
,

536 
Œue
);

537 ià(!
h—d
 && 
d–ayed_»fs
->
run_d–ayed_¡¬t
 != 0) {

538 
d–ayed_»fs
->
run_d–ayed_¡¬t
 = 0;

539 
h—d
 = 
	`fšd_fœ¡_»f_h—d
(
d–ayed_»fs
);

541 ià(!
h—d
)

542  
NULL
;

544 
h—d
->
´oûssšg
) {

545 
rb_node
 *
node
;

547 
node
 = 
	`rb_Ãxt
(&
h—d
->
h»f_node
);

548 ià(!
node
) {

549 ià(
d–ayed_»fs
->
run_d–ayed_¡¬t
 == 0)

550  
NULL
;

551 
d–ayed_»fs
->
run_d–ayed_¡¬t
 = 0;

552 
agaš
;

554 
h—d
 = 
	`rb_’Œy
(
node
, 
bŒfs_d–ayed_»f_h—d
,

555 
h»f_node
);

558 
h—d
->
´oûssšg
 = 
Œue
;

559 
	`WARN_ON
(
d–ayed_»fs
->
num_h—ds_»ady
 == 0);

560 
d–ayed_»fs
->
num_h—ds_»ady
--;

561 
d–ayed_»fs
->
run_d–ayed_¡¬t
 = 
h—d
->
by‹Ä
 +

562 
h—d
->
num_by‹s
;

563  
h—d
;

564 
	}
}

566 
	$bŒfs_d–‘e_»f_h—d
(
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

567 
bŒfs_d–ayed_»f_h—d
 *
h—d
)

569 
	`lockd•_as£¹_h–d
(&
d–ayed_»fs
->
lock
);

570 
	`lockd•_as£¹_h–d
(&
h—d
->
lock
);

572 
	`rb_”a£_ÿched
(&
h—d
->
h»f_node
, &
d–ayed_»fs
->
h»f_roÙ
);

573 
	`RB_CLEAR_NODE
(&
h—d
->
h»f_node
);

574 
	`©omic_dec
(&
d–ayed_»fs
->
num_’Œ›s
);

575 
d–ayed_»fs
->
num_h—ds
--;

576 ià(!
h—d
->
´oûssšg
)

577 
d–ayed_»fs
->
num_h—ds_»ady
--;

578 
	}
}

587 
boŞ
 
	$š£¹_d–ayed_»f
(
bŒfs_d–ayed_»f_roÙ
 *
roÙ
,

588 
bŒfs_d–ayed_»f_h—d
 *
h»f
,

589 
bŒfs_d–ayed_»f_node
 *
»f
)

591 
bŒfs_d–ayed_»f_node
 *
exi¡
;

592 
mod
;

594 
	`¥š_lock
(&
h»f
->
lock
);

595 
exi¡
 = 
	`Œ“_š£¹
(&
h»f
->
»f_Œ“
, 
»f
);

596 ià(!
exi¡
) {

597 ià(
»f
->
aùiÚ
 =ğ
BTRFS_ADD_DELAYED_REF
)

598 
	`li¡_add_
(&
»f
->
add_li¡
, &
h»f
->
»f_add_li¡
);

599 
	`©omic_šc
(&
roÙ
->
num_’Œ›s
);

600 
	`¥š_uÆock
(&
h»f
->
lock
);

601  
çl£
;

605 ià(
exi¡
->
aùiÚ
 =ğ
»f
->action) {

606 
mod
 = 
»f
->
»f_mod
;

609 ià(
exi¡
->
»f_mod
 < 
»f
->ref_mod) {

610 
exi¡
->
aùiÚ
 = 
»f
->action;

611 
mod
 = -
exi¡
->
»f_mod
;

612 
exi¡
->
»f_mod
 = 
»f
->ref_mod;

613 ià(
»f
->
aùiÚ
 =ğ
BTRFS_ADD_DELAYED_REF
)

614 
	`li¡_add_
(&
exi¡
->
add_li¡
,

615 &
h»f
->
»f_add_li¡
);

616 ià(
»f
->
aùiÚ
 =ğ
BTRFS_DROP_DELAYED_REF
) {

617 
	`ASSERT
(!
	`li¡_em±y
(&
exi¡
->
add_li¡
));

618 
	`li¡_d–
(&
exi¡
->
add_li¡
);

620 
	`ASSERT
(0);

623 
mod
 = -
»f
->
»f_mod
;

625 
exi¡
->
»f_mod
 +ğ
mod
;

628 ià(
exi¡
->
»f_mod
 == 0)

629 
	`drİ_d–ayed_»f
(
roÙ
, 
h»f
, 
exi¡
);

630 
	`¥š_uÆock
(&
h»f
->
lock
);

631  
Œue
;

632 
	}
}

638 
nošlše
 
	$upd©e_exi¡šg_h—d_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

639 
bŒfs_d–ayed_»f_h—d
 *
exi¡šg
,

640 
bŒfs_d–ayed_»f_h—d
 *
upd©e
)

642 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
 =

643 &
Œªs
->
Œª§ùiÚ
->
d–ayed_»fs
;

644 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

645 
Şd_»f_mod
;

647 
	`BUG_ON
(
exi¡šg
->
is_d©a
 !ğ
upd©e
->is_data);

649 
	`¥š_lock
(&
exi¡šg
->
lock
);

650 ià(
upd©e
->
mu¡_š£¹_»£rved
) {

658 
exi¡šg
->
mu¡_š£¹_»£rved
 = 
upd©e
->must_insert_reserved;

664 
exi¡šg
->
num_by‹s
 = 
upd©e
->num_bytes;

668 ià(
upd©e
->
ex‹Á_İ
) {

669 ià(!
exi¡šg
->
ex‹Á_İ
) {

670 
exi¡šg
->
ex‹Á_İ
 = 
upd©e
->extent_op;

672 ià(
upd©e
->
ex‹Á_İ
->
upd©e_key
) {

673 
	`memıy
(&
exi¡šg
->
ex‹Á_İ
->
key
,

674 &
upd©e
->
ex‹Á_İ
->
key
,

675 (
upd©e
->
ex‹Á_İ
->
key
));

676 
exi¡šg
->
ex‹Á_İ
->
upd©e_key
 = 
Œue
;

678 ià(
upd©e
->
ex‹Á_İ
->
upd©e_æags
) {

679 
exi¡šg
->
ex‹Á_İ
->
æags_to_£t
 |=

680 
upd©e
->
ex‹Á_İ
->
æags_to_£t
;

681 
exi¡šg
->
ex‹Á_İ
->
upd©e_æags
 = 
Œue
;

683 
	`bŒfs_ä“_d–ayed_ex‹Á_İ
(
upd©e
->
ex‹Á_İ
);

691 
Şd_»f_mod
 = 
exi¡šg
->
tÙ®_»f_mod
;

692 
exi¡šg
->
»f_mod
 +ğ
upd©e
->ref_mod;

693 
exi¡šg
->
tÙ®_»f_mod
 +ğ
upd©e
->
»f_mod
;

699 ià(
exi¡šg
->
is_d©a
) {

700 
u64
 
csum_Ëaves
 =

701 
	`bŒfs_csum_by‹s_to_Ëaves
(
fs_šfo
,

702 
exi¡šg
->
num_by‹s
);

704 ià(
exi¡šg
->
tÙ®_»f_mod
 >ğ0 && 
Şd_»f_mod
 < 0) {

705 
d–ayed_»fs
->
³ndšg_csums
 -ğ
exi¡šg
->
num_by‹s
;

706 
	`bŒfs_d–ayed_»fs_rsv_»Ëa£
(
fs_šfo
, 
csum_Ëaves
);

708 ià(
exi¡šg
->
tÙ®_»f_mod
 < 0 && 
Şd_»f_mod
 >= 0) {

709 
d–ayed_»fs
->
³ndšg_csums
 +ğ
exi¡šg
->
num_by‹s
;

710 
Œªs
->
d–ayed_»f_upd©es
 +ğ
csum_Ëaves
;

714 
	`¥š_uÆock
(&
exi¡šg
->
lock
);

715 
	}
}

717 
	$š™_d–ayed_»f_h—d
(
bŒfs_d–ayed_»f_h—d
 *
h—d_»f
,

718 
bŒfs_qgroup_ex‹Á_»cÜd
 *
q»cÜd
,

719 
u64
 
by‹Ä
, u64 
num_by‹s
, u64 
»f_roÙ
,

720 
u64
 
»£rved
, 
aùiÚ
, 
boŞ
 
is_d©a
,

721 
boŞ
 
is_sy¡em
)

723 
couÁ_mod
 = 1;

724 
boŞ
 
mu¡_š£¹_»£rved
 = 
çl£
;

727 
	`BUG_ON
(!
is_d©a
 && 
»£rved
);

729 
aùiÚ
) {

730 
BTRFS_UPDATE_DELAYED_HEAD
:

731 
couÁ_mod
 = 0;

733 
BTRFS_DROP_DELAYED_REF
:

738 
couÁ_mod
 = -1;

740 
BTRFS_ADD_DELAYED_EXTENT
:

753 
mu¡_š£¹_»£rved
 = 
Œue
;

757 
	`»fcouÁ_£t
(&
h—d_»f
->
»fs
, 1);

758 
h—d_»f
->
by‹Ä
 = bytenr;

759 
h—d_»f
->
num_by‹s
 =‚um_bytes;

760 
h—d_»f
->
»f_mod
 = 
couÁ_mod
;

761 
h—d_»f
->
mu¡_š£¹_»£rved
 = must_insert_reserved;

762 
h—d_»f
->
is_d©a
 = is_data;

763 
h—d_»f
->
is_sy¡em
 = is_system;

764 
h—d_»f
->
»f_Œ“
 = 
RB_ROOT_CACHED
;

765 
	`INIT_LIST_HEAD
(&
h—d_»f
->
»f_add_li¡
);

766 
	`RB_CLEAR_NODE
(&
h—d_»f
->
h»f_node
);

767 
h—d_»f
->
´oûssšg
 = 
çl£
;

768 
h—d_»f
->
tÙ®_»f_mod
 = 
couÁ_mod
;

769 
	`¥š_lock_š™
(&
h—d_»f
->
lock
);

770 
	`mu‹x_š™
(&
h—d_»f
->
mu‹x
);

772 ià(
q»cÜd
) {

773 ià(
»f_roÙ
 && 
»£rved
) {

774 
q»cÜd
->
d©a_rsv
 = 
»£rved
;

775 
q»cÜd
->
d©a_rsv_»äoÙ
 = 
»f_roÙ
;

777 
q»cÜd
->
by‹Ä
 = bytenr;

778 
q»cÜd
->
num_by‹s
 =‚um_bytes;

779 
q»cÜd
->
Şd_roÙs
 = 
NULL
;

781 
	}
}

788 
nošlše
 
bŒfs_d–ayed_»f_h—d
 *

789 
	$add_d–ayed_»f_h—d
(
bŒfs_Œªs_hªdË
 *
Œªs
,

790 
bŒfs_d–ayed_»f_h—d
 *
h—d_»f
,

791 
bŒfs_qgroup_ex‹Á_»cÜd
 *
q»cÜd
,

792 
aùiÚ
, 
boŞ
 *
q»cÜd_š£¹ed_»t
)

794 
bŒfs_d–ayed_»f_h—d
 *
exi¡šg
;

795 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

796 
boŞ
 
q»cÜd_š£¹ed
 = 
çl£
;

798 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

801 ià(
q»cÜd
) {

802 ià(
	`bŒfs_qgroup_Œaû_ex‹Á_nŞock
(
Œªs
->
fs_šfo
,

803 
d–ayed_»fs
, 
q»cÜd
))

804 
	`kä“
(
q»cÜd
);

806 
q»cÜd_š£¹ed
 = 
Œue
;

809 
	`Œaû_add_d–ayed_»f_h—d
(
Œªs
->
fs_šfo
, 
h—d_»f
, 
aùiÚ
);

811 
exi¡šg
 = 
	`hŒ“_š£¹
(&
d–ayed_»fs
->
h»f_roÙ
,

812 &
h—d_»f
->
h»f_node
);

813 ià(
exi¡šg
) {

814 
	`upd©e_exi¡šg_h—d_»f
(
Œªs
, 
exi¡šg
, 
h—d_»f
);

819 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_»f_h—d_ÿch•
, 
h—d_»f
);

820 
h—d_»f
 = 
exi¡šg
;

822 ià(
h—d_»f
->
is_d©a
 && h—d_»f->
»f_mod
 < 0) {

823 
d–ayed_»fs
->
³ndšg_csums
 +ğ
h—d_»f
->
num_by‹s
;

824 
Œªs
->
d–ayed_»f_upd©es
 +=

825 
	`bŒfs_csum_by‹s_to_Ëaves
(
Œªs
->
fs_šfo
,

826 
h—d_»f
->
num_by‹s
);

828 
d–ayed_»fs
->
num_h—ds
++;

829 
d–ayed_»fs
->
num_h—ds_»ady
++;

830 
	`©omic_šc
(&
d–ayed_»fs
->
num_’Œ›s
);

831 
Œªs
->
d–ayed_»f_upd©es
++;

833 ià(
q»cÜd_š£¹ed_»t
)

834 *
q»cÜd_š£¹ed_»t
 = 
q»cÜd_š£¹ed
;

836  
h—d_»f
;

837 
	}
}

864 
	$š™_d–ayed_»f_commÚ
(
bŒfs_fs_šfo
 *
fs_šfo
,

865 
bŒfs_d–ayed_»f_node
 *
»f
,

866 
u64
 
by‹Ä
, u64 
num_by‹s
, u64 
»f_roÙ
,

867 
aùiÚ
, 
u8
 
»f_ty³
)

869 
u64
 
£q
 = 0;

871 ià(
aùiÚ
 =ğ
BTRFS_ADD_DELAYED_EXTENT
)

872 
aùiÚ
 = 
BTRFS_ADD_DELAYED_REF
;

874 ià(
	`is_f¡»e
(
»f_roÙ
))

875 
£q
 = 
	`©omic64_»ad
(&
fs_šfo
->
Œ“_mod_£q
);

877 
	`»fcouÁ_£t
(&
»f
->
»fs
, 1);

878 
»f
->
by‹Ä
 = bytenr;

879 
»f
->
num_by‹s
 =‚um_bytes;

880 
»f
->
»f_mod
 = 1;

881 
»f
->
aùiÚ
 =‡ction;

882 
»f
->
£q
 = seq;

883 
»f
->
ty³
 = 
»f_ty³
;

884 
	`RB_CLEAR_NODE
(&
»f
->
»f_node
);

885 
	`INIT_LIST_HEAD
(&
»f
->
add_li¡
);

886 
	}
}

893 
	$bŒfs_add_d–ayed_Œ“_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

894 
bŒfs_»f
 *
g’”ic_»f
,

895 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
)

897 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

898 
bŒfs_d–ayed_Œ“_»f
 *
»f
;

899 
bŒfs_d–ayed_»f_h—d
 *
h—d_»f
;

900 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

901 
bŒfs_qgroup_ex‹Á_»cÜd
 *
»cÜd
 = 
NULL
;

902 
boŞ
 
q»cÜd_š£¹ed
;

903 
boŞ
 
is_sy¡em
;

904 
boŞ
 
m”ged
;

905 
aùiÚ
 = 
g’”ic_»f
->action;

906 
Ëv–
 = 
g’”ic_»f
->
Œ“_»f
.level;

907 
u64
 
by‹Ä
 = 
g’”ic_»f
->bytenr;

908 
u64
 
num_by‹s
 = 
g’”ic_»f
->
Ën
;

909 
u64
 
·»Á
 = 
g’”ic_»f
->parent;

910 
u8
 
»f_ty³
;

912 
is_sy¡em
 = (
g’”ic_»f
->
Œ“_»f
.
ownšg_roÙ
 =ğ
BTRFS_CHUNK_TREE_OBJECTID
);

914 
	`ASSERT
(
g’”ic_»f
->
ty³
 =ğ
BTRFS_REF_METADATA
 && g’”ic_»f->
aùiÚ
);

915 
»f
 = 
	`kmem_ÿche_®loc
(
bŒfs_d–ayed_Œ“_»f_ÿch•
, 
GFP_NOFS
);

916 ià(!
»f
)

917  -
ENOMEM
;

919 
h—d_»f
 = 
	`kmem_ÿche_®loc
(
bŒfs_d–ayed_»f_h—d_ÿch•
, 
GFP_NOFS
);

920 ià(!
h—d_»f
) {

921 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_Œ“_»f_ÿch•
, 
»f
);

922  -
ENOMEM
;

925 ià(
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
) &&

926 !
g’”ic_»f
->
sk_qgroup
) {

927 
»cÜd
 = 
	`kz®loc
((*»cÜd), 
GFP_NOFS
);

928 ià(!
»cÜd
) {

929 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_Œ“_»f_ÿch•
, 
»f
);

930 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_»f_h—d_ÿch•
, 
h—d_»f
);

931  -
ENOMEM
;

935 ià(
·»Á
)

936 
»f_ty³
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

938 
»f_ty³
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

940 
	`š™_d–ayed_»f_commÚ
(
fs_šfo
, &
»f
->
node
, 
by‹Ä
, 
num_by‹s
,

941 
g’”ic_»f
->
Œ“_»f
.
ownšg_roÙ
, 
aùiÚ
,

942 
»f_ty³
);

943 
»f
->
roÙ
 = 
g’”ic_»f
->
Œ“_»f
.
ownšg_roÙ
;

944 
»f
->
·»Á
 =…arent;

945 
»f
->
Ëv–
 =†evel;

947 
	`š™_d–ayed_»f_h—d
(
h—d_»f
, 
»cÜd
, 
by‹Ä
, 
num_by‹s
,

948 
g’”ic_»f
->
Œ“_»f
.
ownšg_roÙ
, 0, 
aùiÚ
,

949 
çl£
, 
is_sy¡em
);

950 
h—d_»f
->
ex‹Á_İ
 =ƒxtent_op;

952 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

953 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

959 
h—d_»f
 = 
	`add_d–ayed_»f_h—d
(
Œªs
, h—d_»f, 
»cÜd
,

960 
aùiÚ
, &
q»cÜd_š£¹ed
);

962 
m”ged
 = 
	`š£¹_d–ayed_»f
(
d–ayed_»fs
, 
h—d_»f
, &
»f
->
node
);

963 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

969 
	`bŒfs_upd©e_d–ayed_»fs_rsv
(
Œªs
);

971 
	`Œaû_add_d–ayed_Œ“_»f
(
fs_šfo
, &
»f
->
node
,„ef,

972 
aùiÚ
 =ğ
BTRFS_ADD_DELAYED_EXTENT
 ?

973 
BTRFS_ADD_DELAYED_REF
 : 
aùiÚ
);

974 ià(
m”ged
)

975 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_Œ“_»f_ÿch•
, 
»f
);

977 ià(
q»cÜd_š£¹ed
)

978 
	`bŒfs_qgroup_Œaû_ex‹Á_po¡
(
Œªs
, 
»cÜd
);

981 
	}
}

986 
	$bŒfs_add_d–ayed_d©a_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

987 
bŒfs_»f
 *
g’”ic_»f
,

988 
u64
 
»£rved
)

990 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

991 
bŒfs_d–ayed_d©a_»f
 *
»f
;

992 
bŒfs_d–ayed_»f_h—d
 *
h—d_»f
;

993 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

994 
bŒfs_qgroup_ex‹Á_»cÜd
 *
»cÜd
 = 
NULL
;

995 
boŞ
 
q»cÜd_š£¹ed
;

996 
aùiÚ
 = 
g’”ic_»f
->action;

997 
boŞ
 
m”ged
;

998 
u64
 
by‹Ä
 = 
g’”ic_»f
->bytenr;

999 
u64
 
num_by‹s
 = 
g’”ic_»f
->
Ën
;

1000 
u64
 
·»Á
 = 
g’”ic_»f
->parent;

1001 
u64
 
»f_roÙ
 = 
g’”ic_»f
->
d©a_»f
.
ownšg_roÙ
;

1002 
u64
 
owÃr
 = 
g’”ic_»f
->
d©a_»f
.
šo
;

1003 
u64
 
off£t
 = 
g’”ic_»f
->
d©a_»f
.offset;

1004 
u8
 
»f_ty³
;

1006 
	`ASSERT
(
g’”ic_»f
->
ty³
 =ğ
BTRFS_REF_DATA
 && 
aùiÚ
);

1007 
»f
 = 
	`kmem_ÿche_®loc
(
bŒfs_d–ayed_d©a_»f_ÿch•
, 
GFP_NOFS
);

1008 ià(!
»f
)

1009  -
ENOMEM
;

1011 ià(
·»Á
)

1012 
»f_ty³
 = 
BTRFS_SHARED_DATA_REF_KEY
;

1014 
»f_ty³
 = 
BTRFS_EXTENT_DATA_REF_KEY
;

1015 
	`š™_d–ayed_»f_commÚ
(
fs_šfo
, &
»f
->
node
, 
by‹Ä
, 
num_by‹s
,

1016 
»f_roÙ
, 
aùiÚ
, 
»f_ty³
);

1017 
»f
->
roÙ
 = 
»f_roÙ
;

1018 
»f
->
·»Á
 =…arent;

1019 
»f
->
objeùid
 = 
owÃr
;

1020 
»f
->
off£t
 = offset;

1023 
h—d_»f
 = 
	`kmem_ÿche_®loc
(
bŒfs_d–ayed_»f_h—d_ÿch•
, 
GFP_NOFS
);

1024 ià(!
h—d_»f
) {

1025 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_d©a_»f_ÿch•
, 
»f
);

1026  -
ENOMEM
;

1029 ià(
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
) &&

1030 !
g’”ic_»f
->
sk_qgroup
) {

1031 
»cÜd
 = 
	`kz®loc
((*»cÜd), 
GFP_NOFS
);

1032 ià(!
»cÜd
) {

1033 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_d©a_»f_ÿch•
, 
»f
);

1034 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_»f_h—d_ÿch•
,

1035 
h—d_»f
);

1036  -
ENOMEM
;

1040 
	`š™_d–ayed_»f_h—d
(
h—d_»f
, 
»cÜd
, 
by‹Ä
, 
num_by‹s
, 
»f_roÙ
,

1041 
»£rved
, 
aùiÚ
, 
Œue
, 
çl£
);

1042 
h—d_»f
->
ex‹Á_İ
 = 
NULL
;

1044 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

1045 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

1051 
h—d_»f
 = 
	`add_d–ayed_»f_h—d
(
Œªs
, h—d_»f, 
»cÜd
,

1052 
aùiÚ
, &
q»cÜd_š£¹ed
);

1054 
m”ged
 = 
	`š£¹_d–ayed_»f
(
d–ayed_»fs
, 
h—d_»f
, &
»f
->
node
);

1055 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

1061 
	`bŒfs_upd©e_d–ayed_»fs_rsv
(
Œªs
);

1063 
	`Œaû_add_d–ayed_d©a_»f
(
Œªs
->
fs_šfo
, &
»f
->
node
,„ef,

1064 
aùiÚ
 =ğ
BTRFS_ADD_DELAYED_EXTENT
 ?

1065 
BTRFS_ADD_DELAYED_REF
 : 
aùiÚ
);

1066 ià(
m”ged
)

1067 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_d©a_»f_ÿch•
, 
»f
);

1070 ià(
q»cÜd_š£¹ed
)

1071  
	`bŒfs_qgroup_Œaû_ex‹Á_po¡
(
Œªs
, 
»cÜd
);

1073 
	}
}

1075 
	$bŒfs_add_d–ayed_ex‹Á_İ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1076 
u64
 
by‹Ä
, u64 
num_by‹s
,

1077 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
)

1079 
bŒfs_d–ayed_»f_h—d
 *
h—d_»f
;

1080 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

1082 
h—d_»f
 = 
	`kmem_ÿche_®loc
(
bŒfs_d–ayed_»f_h—d_ÿch•
, 
GFP_NOFS
);

1083 ià(!
h—d_»f
)

1084  -
ENOMEM
;

1086 
	`š™_d–ayed_»f_h—d
(
h—d_»f
, 
NULL
, 
by‹Ä
, 
num_by‹s
, 0, 0,

1087 
BTRFS_UPDATE_DELAYED_HEAD
, 
çl£
, false);

1088 
h—d_»f
->
ex‹Á_İ
 =ƒxtent_op;

1090 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

1091 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

1093 
	`add_d–ayed_»f_h—d
(
Œªs
, 
h—d_»f
, 
NULL
, 
BTRFS_UPDATE_DELAYED_HEAD
,

1094 
NULL
);

1096 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

1102 
	`bŒfs_upd©e_d–ayed_»fs_rsv
(
Œªs
);

1104 
	}
}

1110 
bŒfs_d–ayed_»f_h—d
 *

1111 
	$bŒfs_fšd_d–ayed_»f_h—d
(
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
, 
u64
 
by‹Ä
)

1113 
	`lockd•_as£¹_h–d
(&
d–ayed_»fs
->
lock
);

1115  
	`fšd_»f_h—d
(
d–ayed_»fs
, 
by‹Ä
, 
çl£
);

1116 
	}
}

1118 
__cŞd
 
	$bŒfs_d–ayed_»f_ex™
()

1120 
	`kmem_ÿche_de¡roy
(
bŒfs_d–ayed_»f_h—d_ÿch•
);

1121 
	`kmem_ÿche_de¡roy
(
bŒfs_d–ayed_Œ“_»f_ÿch•
);

1122 
	`kmem_ÿche_de¡roy
(
bŒfs_d–ayed_d©a_»f_ÿch•
);

1123 
	`kmem_ÿche_de¡roy
(
bŒfs_d–ayed_ex‹Á_İ_ÿch•
);

1124 
	}
}

1126 
__š™
 
	$bŒfs_d–ayed_»f_š™
()

1128 
bŒfs_d–ayed_»f_h—d_ÿch•
 = 
	`kmem_ÿche_ü—‹
(

1130 (
bŒfs_d–ayed_»f_h—d
), 0,

1131 
SLAB_MEM_SPREAD
, 
NULL
);

1132 ià(!
bŒfs_d–ayed_»f_h—d_ÿch•
)

1133 
ç
;

1135 
bŒfs_d–ayed_Œ“_»f_ÿch•
 = 
	`kmem_ÿche_ü—‹
(

1137 (
bŒfs_d–ayed_Œ“_»f
), 0,

1138 
SLAB_MEM_SPREAD
, 
NULL
);

1139 ià(!
bŒfs_d–ayed_Œ“_»f_ÿch•
)

1140 
ç
;

1142 
bŒfs_d–ayed_d©a_»f_ÿch•
 = 
	`kmem_ÿche_ü—‹
(

1144 (
bŒfs_d–ayed_d©a_»f
), 0,

1145 
SLAB_MEM_SPREAD
, 
NULL
);

1146 ià(!
bŒfs_d–ayed_d©a_»f_ÿch•
)

1147 
ç
;

1149 
bŒfs_d–ayed_ex‹Á_İ_ÿch•
 = 
	`kmem_ÿche_ü—‹
(

1151 (
bŒfs_d–ayed_ex‹Á_İ
), 0,

1152 
SLAB_MEM_SPREAD
, 
NULL
);

1153 ià(!
bŒfs_d–ayed_ex‹Á_İ_ÿch•
)

1154 
ç
;

1157 
ç
:

1158 
	`bŒfs_d–ayed_»f_ex™
();

1159  -
ENOMEM
;

1160 
	}
}

	@delayed-ref.h

6 #iâdeà
BTRFS_DELAYED_REF_H


7 
	#BTRFS_DELAYED_REF_H


	)

9 
	~<lšux/»fcouÁ.h
>

12 
	#BTRFS_ADD_DELAYED_REF
 1

	)

13 
	#BTRFS_DROP_DELAYED_REF
 2

	)

14 
	#BTRFS_ADD_DELAYED_EXTENT
 3

	)

15 
	#BTRFS_UPDATE_DELAYED_HEAD
 4

	)

17 
	sbŒfs_d–ayed_»f_node
 {

18 
rb_node
 
	m»f_node
;

24 
li¡_h—d
 
	madd_li¡
;

27 
u64
 
	mby‹Ä
;

30 
u64
 
	mnum_by‹s
;

33 
u64
 
	m£q
;

36 
»fcouÁ_t
 
	m»fs
;

47 
	m»f_mod
;

49 
	maùiÚ
:8;

50 
	mty³
:8;

53 
	sbŒfs_d–ayed_ex‹Á_İ
 {

54 
bŒfs_disk_key
 
	mkey
;

55 
u8
 
	mËv–
;

56 
boŞ
 
	mupd©e_key
;

57 
boŞ
 
	mupd©e_æags
;

58 
u64
 
	mæags_to_£t
;

67 
	sbŒfs_d–ayed_»f_h—d
 {

68 
u64
 
	mby‹Ä
;

69 
u64
 
	mnum_by‹s
;

75 
rb_node
 
	mh»f_node
;

80 
mu‹x
 
	mmu‹x
;

82 
»fcouÁ_t
 
	m»fs
;

85 
¥šlock_t
 
	mlock
;

86 
rb_roÙ_ÿched
 
	m»f_Œ“
;

88 
li¡_h—d
 
	m»f_add_li¡
;

90 
bŒfs_d–ayed_ex‹Á_İ
 *
	mex‹Á_İ
;

97 
	mtÙ®_»f_mod
;

105 
	m»f_mod
;

119 
boŞ
 
	mmu¡_š£¹_»£rved
;

120 
boŞ
 
	mis_d©a
;

121 
boŞ
 
	mis_sy¡em
;

122 
boŞ
 
	m´oûssšg
;

125 
	sbŒfs_d–ayed_Œ“_»f
 {

126 
bŒfs_d–ayed_»f_node
 
	mnode
;

127 
u64
 
	mroÙ
;

128 
u64
 
	m·»Á
;

129 
	mËv–
;

132 
	sbŒfs_d–ayed_d©a_»f
 {

133 
bŒfs_d–ayed_»f_node
 
	mnode
;

134 
u64
 
	mroÙ
;

135 
u64
 
	m·»Á
;

136 
u64
 
	mobjeùid
;

137 
u64
 
	moff£t
;

140 
	ebŒfs_d–ayed_»f_æags
 {

142 
	mBTRFS_DELAYED_REFS_FLUSHING
,

145 
	sbŒfs_d–ayed_»f_roÙ
 {

147 
rb_roÙ_ÿched
 
	mh»f_roÙ
;

150 
rb_roÙ
 
	mdœty_ex‹Á_roÙ
;

153 
¥šlock_t
 
	mlock
;

158 
©omic_t
 
	mnum_’Œ›s
;

161 
	mnum_h—ds
;

164 
	mnum_h—ds_»ady
;

166 
u64
 
	m³ndšg_csums
;

168 
	mæags
;

170 
u64
 
	mrun_d–ayed_¡¬t
;

178 
u64
 
	mqgroup_to_sk
;

181 
	ebŒfs_»f_ty³
 {

182 
	mBTRFS_REF_NOT_SET
,

183 
	mBTRFS_REF_DATA
,

184 
	mBTRFS_REF_METADATA
,

185 
	mBTRFS_REF_LAST
,

188 
	sbŒfs_d©a_»f
 {

192 
u64
 
	mownšg_roÙ
;

195 
u64
 
	mšo
;

203 
u64
 
	moff£t
;

206 
	sbŒfs_Œ“_»f
 {

212 
	mËv–
;

219 
u64
 
	mownšg_roÙ
;

224 
	sbŒfs_»f
 {

225 
bŒfs_»f_ty³
 
	mty³
;

226 
	maùiÚ
;

234 
boŞ
 
	msk_qgroup
;

236 #ifdeà
CONFIG_BTRFS_FS_REF_VERIFY


238 
u64
 
	m»®_roÙ
;

240 
u64
 
	mby‹Ä
;

241 
u64
 
	mËn
;

244 
u64
 
	m·»Á
;

246 
bŒfs_d©a_»f
 
	md©a_»f
;

247 
bŒfs_Œ“_»f
 
	mŒ“_»f
;

251 
kmem_ÿche
 *
bŒfs_d–ayed_»f_h—d_ÿch•
;

252 
kmem_ÿche
 *
bŒfs_d–ayed_Œ“_»f_ÿch•
;

253 
kmem_ÿche
 *
bŒfs_d–ayed_d©a_»f_ÿch•
;

254 
kmem_ÿche
 *
bŒfs_d–ayed_ex‹Á_İ_ÿch•
;

256 
__š™
 
bŒfs_d–ayed_»f_š™
();

257 
__cŞd
 
bŒfs_d–ayed_»f_ex™
();

259 
šlše
 
u64
 
	$bŒfs_ÿlc_d–ayed_»f_by‹s
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

260 
num_d–ayed_»fs
)

262 
u64
 
num_by‹s
;

264 
num_by‹s
 = 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
, 
num_d–ayed_»fs
);

274 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
FREE_SPACE_TREE
))

275 
num_by‹s
 *= 2;

277  
num_by‹s
;

278 
	}
}

280 
šlše
 
	$bŒfs_š™_g’”ic_»f
(
bŒfs_»f
 *
g’”ic_»f
,

281 
aùiÚ
, 
u64
 
by‹Ä
, u64 
Ën
, u64 
·»Á
)

283 
g’”ic_»f
->
aùiÚ
 =‡ction;

284 
g’”ic_»f
->
by‹Ä
 = bytenr;

285 
g’”ic_»f
->
Ën
 =†en;

286 
g’”ic_»f
->
·»Á
 =…arent;

287 
	}
}

289 
šlše
 
	$bŒfs_š™_Œ“_»f
(
bŒfs_»f
 *
g’”ic_»f
,

290 
Ëv–
, 
u64
 
roÙ
, u64 
mod_roÙ
, 
boŞ
 
sk_qgroup
)

292 #ifdeà
CONFIG_BTRFS_FS_REF_VERIFY


294 
g’”ic_»f
->
»®_roÙ
 = 
mod_roÙ
 ?: 
roÙ
;

296 
g’”ic_»f
->
Œ“_»f
.
Ëv–
 =†evel;

297 
g’”ic_»f
->
Œ“_»f
.
ownšg_roÙ
 = 
roÙ
;

298 
g’”ic_»f
->
ty³
 = 
BTRFS_REF_METADATA
;

299 ià(
sk_qgroup
 || !(
	`is_f¡»e
(
roÙ
) &&

300 (!
mod_roÙ
 || 
	`is_f¡»e
(mod_root))))

301 
g’”ic_»f
->
sk_qgroup
 = 
Œue
;

303 
g’”ic_»f
->
sk_qgroup
 = 
çl£
;

305 
	}
}

307 
šlše
 
	$bŒfs_š™_d©a_»f
(
bŒfs_»f
 *
g’”ic_»f
,

308 
u64
 
»f_roÙ
, u64 
šo
, u64 
off£t
, u64 
mod_roÙ
,

309 
boŞ
 
sk_qgroup
)

311 #ifdeà
CONFIG_BTRFS_FS_REF_VERIFY


313 
g’”ic_»f
->
»®_roÙ
 = 
mod_roÙ
 ?: 
»f_roÙ
;

315 
g’”ic_»f
->
d©a_»f
.
ownšg_roÙ
 = 
»f_roÙ
;

316 
g’”ic_»f
->
d©a_»f
.
šo
 = ino;

317 
g’”ic_»f
->
d©a_»f
.
off£t
 = offset;

318 
g’”ic_»f
->
ty³
 = 
BTRFS_REF_DATA
;

319 ià(
sk_qgroup
 || !(
	`is_f¡»e
(
»f_roÙ
) &&

320 (!
mod_roÙ
 || 
	`is_f¡»e
(mod_root))))

321 
g’”ic_»f
->
sk_qgroup
 = 
Œue
;

323 
g’”ic_»f
->
sk_qgroup
 = 
çl£
;

324 
	}
}

326 
šlše
 
bŒfs_d–ayed_ex‹Á_İ
 *

327 
	$bŒfs_®loc_d–ayed_ex‹Á_İ
()

329  
	`kmem_ÿche_®loc
(
bŒfs_d–ayed_ex‹Á_İ_ÿch•
, 
GFP_NOFS
);

330 
	}
}

332 
šlše
 

333 
	$bŒfs_ä“_d–ayed_ex‹Á_İ
(
bŒfs_d–ayed_ex‹Á_İ
 *
İ
)

335 ià(
İ
)

336 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_ex‹Á_İ_ÿch•
, 
İ
);

337 
	}
}

339 
šlše
 
	$bŒfs_put_d–ayed_»f
(
bŒfs_d–ayed_»f_node
 *
»f
)

341 
	`WARN_ON
(
	`»fcouÁ_»ad
(&
»f
->
»fs
) == 0);

342 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
»f
->
»fs
)) {

343 
	`WARN_ON
(!
	`RB_EMPTY_NODE
(&
»f
->
»f_node
));

344 
»f
->
ty³
) {

345 
BTRFS_TREE_BLOCK_REF_KEY
:

346 
BTRFS_SHARED_BLOCK_REF_KEY
:

347 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_Œ“_»f_ÿch•
, 
»f
);

349 
BTRFS_EXTENT_DATA_REF_KEY
:

350 
BTRFS_SHARED_DATA_REF_KEY
:

351 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_d©a_»f_ÿch•
, 
»f
);

354 
	`BUG
();

357 
	}
}

359 
šlše
 
u64
 
	$bŒfs_»f_h—d_to_¥aû_æags
(

360 
bŒfs_d–ayed_»f_h—d
 *
h—d_»f
)

362 ià(
h—d_»f
->
is_d©a
)

363  
BTRFS_BLOCK_GROUP_DATA
;

364 ià(
h—d_»f
->
is_sy¡em
)

365  
BTRFS_BLOCK_GROUP_SYSTEM
;

366  
BTRFS_BLOCK_GROUP_METADATA
;

367 
	}
}

369 
šlše
 
	$bŒfs_put_d–ayed_»f_h—d
(
bŒfs_d–ayed_»f_h—d
 *
h—d
)

371 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
h—d
->
»fs
))

372 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_»f_h—d_ÿch•
, 
h—d
);

373 
	}
}

375 
bŒfs_add_d–ayed_Œ“_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

376 
bŒfs_»f
 *
g’”ic_»f
,

377 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
);

378 
bŒfs_add_d–ayed_d©a_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

379 
bŒfs_»f
 *
g’”ic_»f
,

380 
u64
 
»£rved
);

381 
bŒfs_add_d–ayed_ex‹Á_İ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

382 
u64
 
by‹Ä
, u64 
num_by‹s
,

383 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
);

384 
bŒfs_m”ge_d–ayed_»fs
(
bŒfs_fs_šfo
 *
fs_šfo
,

385 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

386 
bŒfs_d–ayed_»f_h—d
 *
h—d
);

388 
bŒfs_d–ayed_»f_h—d
 *

389 
bŒfs_fšd_d–ayed_»f_h—d
(
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

390 
u64
 
by‹Ä
);

391 
bŒfs_d–ayed_»f_lock
(
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

392 
bŒfs_d–ayed_»f_h—d
 *
h—d
);

393 
šlše
 
	$bŒfs_d–ayed_»f_uÆock
(
bŒfs_d–ayed_»f_h—d
 *
h—d
)

395 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

396 
	}
}

397 
bŒfs_d–‘e_»f_h—d
(
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

398 
bŒfs_d–ayed_»f_h—d
 *
h—d
);

400 
bŒfs_d–ayed_»f_h—d
 *
bŒfs_£Ëù_»f_h—d
(

401 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
);

403 
bŒfs_check_d–ayed_£q
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
£q
);

405 
bŒfs_d–ayed_»fs_rsv_»Ëa£
(
bŒfs_fs_šfo
 *
fs_šfo
, 
Ä
);

406 
bŒfs_upd©e_d–ayed_»fs_rsv
(
bŒfs_Œªs_hªdË
 *
Œªs
);

407 
bŒfs_d–ayed_»fs_rsv_»fl
(
bŒfs_fs_šfo
 *
fs_šfo
,

408 
bŒfs_»£rve_æush_’um
 
æush
);

409 
bŒfs_mig¿‹_to_d–ayed_»fs_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
,

410 
u64
 
num_by‹s
);

411 
boŞ
 
bŒfs_check_¥aû_fÜ_d–ayed_»fs
(
bŒfs_fs_šfo
 *
fs_šfo
);

416 
šlše
 
bŒfs_d–ayed_Œ“_»f
 *

417 
	$bŒfs_d–ayed_node_to_Œ“_»f
(
bŒfs_d–ayed_»f_node
 *
node
)

419  
	`cÚš”_of
(
node
, 
bŒfs_d–ayed_Œ“_»f
,‚ode);

420 
	}
}

422 
šlše
 
bŒfs_d–ayed_d©a_»f
 *

423 
	$bŒfs_d–ayed_node_to_d©a_»f
(
bŒfs_d–ayed_»f_node
 *
node
)

425  
	`cÚš”_of
(
node
, 
bŒfs_d–ayed_d©a_»f
,‚ode);

426 
	}
}

	@dev-replace.c

6 
	~<lšux/sched.h
>

7 
	~<lšux/bio.h
>

8 
	~<lšux/¦ab.h
>

9 
	~<lšux/blkdev.h
>

10 
	~<lšux/kth»ad.h
>

11 
	~<lšux/m©h64.h
>

12 
	~"misc.h
"

13 
	~"ù»e.h
"

14 
	~"ex‹Á_m­.h
"

15 
	~"disk-io.h
"

16 
	~"Œª§ùiÚ.h
"

17 
	~"´št-Œ“.h
"

18 
	~"vŞumes.h
"

19 
	~"async-th»ad.h
"

20 
	~"check-š‹gr™y.h
"

21 
	~"dev-»¶aû.h
"

22 
	~"sysfs.h
"

23 
	~"zÚed.h
"

24 
	~"block-group.h
"

25 
	~"fs.h
"

26 
	~"acûssÜs.h
"

27 
	~"süub.h
"

69 
bŒfs_dev_»¶aû_fšishšg
(
bŒfs_fs_šfo
 *
fs_šfo
,

70 
süub_»t
);

71 
bŒfs_dev_»¶aû_kth»ad
(*
d©a
);

73 
	$bŒfs_š™_dev_»¶aû
(
bŒfs_fs_šfo
 *
fs_šfo
)

75 
bŒfs_dev_lookup_¬gs
 
¬gs
 = { .
devid
 = 
BTRFS_DEV_REPLACE_DEVID
 };

76 
bŒfs_key
 
key
;

77 
bŒfs_roÙ
 *
dev_roÙ
 = 
fs_šfo
->dev_root;

78 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

79 
ex‹Á_bufãr
 *
eb
;

80 
¦Ù
;

81 
»t
 = 0;

82 
bŒfs_·th
 *
·th
 = 
NULL
;

83 
™em_size
;

84 
bŒfs_dev_»¶aû_™em
 *
±r
;

85 
u64
 
¤c_devid
;

87 ià(!
dev_roÙ
)

90 
·th
 = 
	`bŒfs_®loc_·th
();

91 ià(!
·th
) {

92 
»t
 = -
ENOMEM
;

93 
out
;

96 
key
.
objeùid
 = 0;

97 
key
.
ty³
 = 
BTRFS_DEV_REPLACE_KEY
;

98 
key
.
off£t
 = 0;

99 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
dev_roÙ
, &
key
, 
·th
, 0, 0);

100 ià(
»t
) {

101 
no_v®id_dev_»¶aû_’Œy_found
:

106 ià(
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, &
¬gs
)) {

107 
	`bŒfs_”r
(
fs_šfo
,

109 
»t
 = -
EUCLEAN
;

110 
out
;

112 
»t
 = 0;

113 
dev_»¶aû
->
»¶aû_¡©e
 =

114 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
;

115 
dev_»¶aû
->
cÚt_»adšg_äom_¤cdev_mode
 =

116 
BTRFS_DEV_REPLACE_ITEM_CONT_READING_FROM_SRCDEV_MODE_ALWAYS
;

117 
dev_»¶aû
->
time_¡¬‹d
 = 0;

118 
dev_»¶aû
->
time_¡İ³d
 = 0;

119 
	`©omic64_£t
(&
dev_»¶aû
->
num_wr™e_”rÜs
, 0);

120 
	`©omic64_£t
(&
dev_»¶aû
->
num_uncÜ»ùabË_»ad_”rÜs
, 0);

121 
dev_»¶aû
->
cursÜ_Ëá
 = 0;

122 
dev_»¶aû
->
comm™‹d_cursÜ_Ëá
 = 0;

123 
dev_»¶aû
->
cursÜ_Ëá_Ï¡_wr™e_of_™em
 = 0;

124 
dev_»¶aû
->
cursÜ_right
 = 0;

125 
dev_»¶aû
->
¤cdev
 = 
NULL
;

126 
dev_»¶aû
->
tgtdev
 = 
NULL
;

127 
dev_»¶aû
->
is_v®id
 = 0;

128 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 0;

129 
out
;

131 
¦Ù
 = 
·th
->
¦Ùs
[0];

132 
eb
 = 
·th
->
nodes
[0];

133 
™em_size
 = 
	`bŒfs_™em_size
(
eb
, 
¦Ù
);

134 
±r
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_dev_»¶aû_™em
);

136 ià(
™em_size
 !ğ(
bŒfs_dev_»¶aû_™em
)) {

137 
	`bŒfs_w¬n
(
fs_šfo
,

139 
no_v®id_dev_»¶aû_’Œy_found
;

142 
¤c_devid
 = 
	`bŒfs_dev_»¶aû_¤c_devid
(
eb
, 
±r
);

143 
dev_»¶aû
->
cÚt_»adšg_äom_¤cdev_mode
 =

144 
	`bŒfs_dev_»¶aû_cÚt_»adšg_äom_¤cdev_mode
(
eb
, 
±r
);

145 
dev_»¶aû
->
»¶aû_¡©e
 = 
	`bŒfs_dev_»¶aû_»¶aû_¡©e
(
eb
, 
±r
);

146 
dev_»¶aû
->
time_¡¬‹d
 = 
	`bŒfs_dev_»¶aû_time_¡¬‹d
(
eb
, 
±r
);

147 
dev_»¶aû
->
time_¡İ³d
 =

148 
	`bŒfs_dev_»¶aû_time_¡İ³d
(
eb
, 
±r
);

149 
	`©omic64_£t
(&
dev_»¶aû
->
num_wr™e_”rÜs
,

150 
	`bŒfs_dev_»¶aû_num_wr™e_”rÜs
(
eb
, 
±r
));

151 
	`©omic64_£t
(&
dev_»¶aû
->
num_uncÜ»ùabË_»ad_”rÜs
,

152 
	`bŒfs_dev_»¶aû_num_uncÜ»ùabË_»ad_”rÜs
(
eb
, 
±r
));

153 
dev_»¶aû
->
cursÜ_Ëá
 = 
	`bŒfs_dev_»¶aû_cursÜ_Ëá
(
eb
, 
±r
);

154 
dev_»¶aû
->
comm™‹d_cursÜ_Ëá
 = dev_»¶aû->
cursÜ_Ëá
;

155 
dev_»¶aû
->
cursÜ_Ëá_Ï¡_wr™e_of_™em
 = dev_»¶aû->
cursÜ_Ëá
;

156 
dev_»¶aû
->
cursÜ_right
 = 
	`bŒfs_dev_»¶aû_cursÜ_right
(
eb
, 
±r
);

157 
dev_»¶aû
->
is_v®id
 = 1;

159 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 0;

160 
dev_»¶aû
->
»¶aû_¡©e
) {

161 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

162 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

163 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

168 ià(
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, &
¬gs
)) {

169 
	`bŒfs_”r
(
fs_šfo
,

171 
»t
 = -
EUCLEAN
;

173 
dev_»¶aû
->
¤cdev
 = 
NULL
;

174 
dev_»¶aû
->
tgtdev
 = 
NULL
;

177 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

178 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

179 
dev_»¶aû
->
tgtdev
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, &
¬gs
);

180 
¬gs
.
devid
 = 
¤c_devid
;

181 
dev_»¶aû
->
¤cdev
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, &
¬gs
);

187 ià(!
dev_»¶aû
->
¤cdev
 &&

188 !
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DEGRADED
)) {

189 
»t
 = -
EIO
;

190 
	`bŒfs_w¬n
(
fs_šfo
,

192 
	`bŒfs_w¬n
(
fs_šfo
,

194 
¤c_devid
);

196 ià(!
dev_»¶aû
->
tgtdev
 &&

197 !
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DEGRADED
)) {

198 
»t
 = -
EIO
;

199 
	`bŒfs_w¬n
(
fs_šfo
,

201 
	`bŒfs_w¬n
(
fs_šfo
,

203 
BTRFS_DEV_REPLACE_DEVID
);

205 ià(
dev_»¶aû
->
tgtdev
) {

206 ià(
dev_»¶aû
->
¤cdev
) {

207 
dev_»¶aû
->
tgtdev
->
tÙ®_by‹s
 =

208 
dev_»¶aû
->
¤cdev
->
tÙ®_by‹s
;

209 
dev_»¶aû
->
tgtdev
->
disk_tÙ®_by‹s
 =

210 
dev_»¶aû
->
¤cdev
->
disk_tÙ®_by‹s
;

211 
dev_»¶aû
->
tgtdev
->
comm™_tÙ®_by‹s
 =

212 
dev_»¶aû
->
¤cdev
->
comm™_tÙ®_by‹s
;

213 
dev_»¶aû
->
tgtdev
->
by‹s_u£d
 =

214 
dev_»¶aû
->
¤cdev
->
by‹s_u£d
;

215 
dev_»¶aû
->
tgtdev
->
comm™_by‹s_u£d
 =

216 
dev_»¶aû
->
¤cdev
->
comm™_by‹s_u£d
;

218 
	`£t_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
,

219 &
dev_»¶aû
->
tgtdev
->
dev_¡©e
);

221 
	`WARN_ON
(
fs_šfo
->
fs_deviûs
->
rw_deviûs
 == 0);

222 
dev_»¶aû
->
tgtdev
->
io_width
 = 
fs_šfo
->
£ùÜsize
;

223 
dev_»¶aû
->
tgtdev
->
io_®ign
 = 
fs_šfo
->
£ùÜsize
;

224 
dev_»¶aû
->
tgtdev
->
£ùÜ_size
 = 
fs_šfo
->
£ùÜsize
;

225 
dev_»¶aû
->
tgtdev
->
fs_šfo
 = fs_info;

226 
	`£t_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
,

227 &
dev_»¶aû
->
tgtdev
->
dev_¡©e
);

232 
out
:

233 
	`bŒfs_ä“_·th
(
·th
);

234  
»t
;

235 
	}
}

243 
	$bŒfs_š™_dev_»¶aû_tgtdev
(
bŒfs_fs_šfo
 *
fs_šfo
,

244 cÚ¡ *
deviû_·th
,

245 
bŒfs_deviû
 *
¤cdev
,

246 
bŒfs_deviû
 **
deviû_out
)

248 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

249 
bŒfs_deviû
 *
deviû
;

250 
block_deviû
 *
bdev
;

251 
u64
 
devid
 = 
BTRFS_DEV_REPLACE_DEVID
;

252 
»t
 = 0;

254 *
deviû_out
 = 
NULL
;

255 ià(
¤cdev
->
fs_deviûs
->
£edšg
) {

256 
	`bŒfs_”r
(
fs_šfo
, "the filesystem is‡ seed filesystem!");

257  -
EINVAL
;

260 
bdev
 = 
	`blkdev_g‘_by_·th
(
deviû_·th
, 
BLK_OPEN_WRITE
,

261 
fs_šfo
->
bdev_hŞd”
, 
NULL
);

262 ià(
	`IS_ERR
(
bdev
)) {

263 
	`bŒfs_”r
(
fs_šfo
, "rg‘ deviû % i šv®id!", 
deviû_·th
);

264  
	`PTR_ERR
(
bdev
);

267 ià(!
	`bŒfs_check_deviû_zÚe_ty³
(
fs_šfo
, 
bdev
)) {

268 
	`bŒfs_”r
(
fs_šfo
,

270 
»t
 = -
EINVAL
;

271 
”rÜ
;

274 
	`sync_blockdev
(
bdev
);

276 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

277 ià(
deviû
->
bdev
 == bdev) {

278 
	`bŒfs_”r
(
fs_šfo
,

280 
»t
 = -
EEXIST
;

281 
”rÜ
;

286 ià(
	`bdev_Ä_by‹s
(
bdev
è< 
	`bŒfs_deviû_g‘_tÙ®_by‹s
(
¤cdev
)) {

287 
	`bŒfs_”r
(
fs_šfo
,

289 
»t
 = -
EINVAL
;

290 
”rÜ
;

294 
deviû
 = 
	`bŒfs_®loc_deviû
(
NULL
, &
devid
, NULL, 
deviû_·th
);

295 ià(
	`IS_ERR
(
deviû
)) {

296 
»t
 = 
	`PTR_ERR
(
deviû
);

297 
”rÜ
;

300 
»t
 = 
	`lookup_bdev
(
deviû_·th
, &
deviû
->
devt
);

301 ià(
»t
)

302 
”rÜ
;

304 
	`£t_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
);

305 
deviû
->
g’”©iÚ
 = 0;

306 
deviû
->
io_width
 = 
fs_šfo
->
£ùÜsize
;

307 
deviû
->
io_®ign
 = 
fs_šfo
->
£ùÜsize
;

308 
deviû
->
£ùÜ_size
 = 
fs_šfo
->
£ùÜsize
;

309 
deviû
->
tÙ®_by‹s
 = 
	`bŒfs_deviû_g‘_tÙ®_by‹s
(
¤cdev
);

310 
deviû
->
disk_tÙ®_by‹s
 = 
	`bŒfs_deviû_g‘_disk_tÙ®_by‹s
(
¤cdev
);

311 
deviû
->
by‹s_u£d
 = 
	`bŒfs_deviû_g‘_by‹s_u£d
(
¤cdev
);

312 
deviû
->
comm™_tÙ®_by‹s
 = 
¤cdev
->commit_total_bytes;

313 
deviû
->
comm™_by‹s_u£d
 = deviû->
by‹s_u£d
;

314 
deviû
->
fs_šfo
 = fs_info;

315 
deviû
->
bdev
 = bdev;

316 
	`£t_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
deviû
->
dev_¡©e
);

317 
	`£t_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
);

318 
deviû
->
hŞd”
 = 
fs_šfo
->
bdev_hŞd”
;

319 
deviû
->
dev_¡©s_v®id
 = 1;

320 
	`£t_blocksize
(
deviû
->
bdev
, 
BTRFS_BDEV_BLOCKSIZE
);

321 
deviû
->
fs_deviûs
 = fs_devices;

323 
»t
 = 
	`bŒfs_g‘_dev_zÚe_šfo
(
deviû
, 
çl£
);

324 ià(
»t
)

325 
”rÜ
;

327 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

328 
	`li¡_add
(&
deviû
->
dev_li¡
, &
fs_deviûs
->
deviûs
);

329 
fs_deviûs
->
num_deviûs
++;

330 
fs_deviûs
->
İ’_deviûs
++;

331 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

333 *
deviû_out
 = 
deviû
;

336 
”rÜ
:

337 
	`blkdev_put
(
bdev
, 
fs_šfo
->
bdev_hŞd”
);

338  
»t
;

339 
	}
}

345 
	$bŒfs_run_dev_»¶aû
(
bŒfs_Œªs_hªdË
 *
Œªs
)

347 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

348 
»t
;

349 
bŒfs_roÙ
 *
dev_roÙ
 = 
fs_šfo
->dev_root;

350 
bŒfs_·th
 *
·th
;

351 
bŒfs_key
 
key
;

352 
ex‹Á_bufãr
 *
eb
;

353 
bŒfs_dev_»¶aû_™em
 *
±r
;

354 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

356 
	`down_»ad
(&
dev_»¶aû
->
rw£m
);

357 ià(!
dev_»¶aû
->
is_v®id
 ||

358 !
dev_»¶aû
->
™em_Ãeds_wr™eback
) {

359 
	`up_»ad
(&
dev_»¶aû
->
rw£m
);

362 
	`up_»ad
(&
dev_»¶aû
->
rw£m
);

364 
key
.
objeùid
 = 0;

365 
key
.
ty³
 = 
BTRFS_DEV_REPLACE_KEY
;

366 
key
.
off£t
 = 0;

368 
·th
 = 
	`bŒfs_®loc_·th
();

369 ià(!
·th
) {

370 
»t
 = -
ENOMEM
;

371 
out
;

373 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
dev_roÙ
, &
key
, 
·th
, -1, 1);

374 ià(
»t
 < 0) {

375 
	`bŒfs_w¬n
(
fs_šfo
,

377 
»t
);

378 
out
;

381 ià(
»t
 == 0 &&

382 
	`bŒfs_™em_size
(
·th
->
nodes
[0],…©h->
¦Ùs
[0]è< (*
±r
)) {

394 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
dev_roÙ
, 
·th
);

395 ià(
»t
 != 0) {

396 
	`bŒfs_w¬n
(
fs_šfo
,

398 
»t
);

399 
out
;

401 
»t
 = 1;

404 ià(
»t
 == 1) {

406 
	`bŒfs_»Ëa£_·th
(
·th
);

407 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
dev_roÙ
, 
·th
,

408 &
key
, (*
±r
));

409 ià(
»t
 < 0) {

410 
	`bŒfs_w¬n
(
fs_šfo
,

411 "š£¹ dev_»¶aû i‹m faed %d!", 
»t
);

412 
out
;

416 
eb
 = 
·th
->
nodes
[0];

417 
±r
 = 
	`bŒfs_™em_±r
(
eb
, 
·th
->
¦Ùs
[0],

418 
bŒfs_dev_»¶aû_™em
);

420 
	`down_wr™e
(&
dev_»¶aû
->
rw£m
);

421 ià(
dev_»¶aû
->
¤cdev
)

422 
	`bŒfs_£t_dev_»¶aû_¤c_devid
(
eb
, 
±r
,

423 
dev_»¶aû
->
¤cdev
->
devid
);

425 
	`bŒfs_£t_dev_»¶aû_¤c_devid
(
eb
, 
±r
, (
u64
)-1);

426 
	`bŒfs_£t_dev_»¶aû_cÚt_»adšg_äom_¤cdev_mode
(
eb
, 
±r
,

427 
dev_»¶aû
->
cÚt_»adšg_äom_¤cdev_mode
);

428 
	`bŒfs_£t_dev_»¶aû_»¶aû_¡©e
(
eb
, 
±r
,

429 
dev_»¶aû
->
»¶aû_¡©e
);

430 
	`bŒfs_£t_dev_»¶aû_time_¡¬‹d
(
eb
, 
±r
, 
dev_»¶aû
->
time_¡¬‹d
);

431 
	`bŒfs_£t_dev_»¶aû_time_¡İ³d
(
eb
, 
±r
, 
dev_»¶aû
->
time_¡İ³d
);

432 
	`bŒfs_£t_dev_»¶aû_num_wr™e_”rÜs
(
eb
, 
±r
,

433 
	`©omic64_»ad
(&
dev_»¶aû
->
num_wr™e_”rÜs
));

434 
	`bŒfs_£t_dev_»¶aû_num_uncÜ»ùabË_»ad_”rÜs
(
eb
, 
±r
,

435 
	`©omic64_»ad
(&
dev_»¶aû
->
num_uncÜ»ùabË_»ad_”rÜs
));

436 
dev_»¶aû
->
cursÜ_Ëá_Ï¡_wr™e_of_™em
 =

437 
dev_»¶aû
->
cursÜ_Ëá
;

438 
	`bŒfs_£t_dev_»¶aû_cursÜ_Ëá
(
eb
, 
±r
,

439 
dev_»¶aû
->
cursÜ_Ëá_Ï¡_wr™e_of_™em
);

440 
	`bŒfs_£t_dev_»¶aû_cursÜ_right
(
eb
, 
±r
,

441 
dev_»¶aû
->
cursÜ_right
);

442 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 0;

443 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

445 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
eb
);

447 
out
:

448 
	`bŒfs_ä“_·th
(
·th
);

450  
»t
;

451 
	}
}

453 
	$m¬k_block_group_to_cİy
(
bŒfs_fs_šfo
 *
fs_šfo
,

454 
bŒfs_deviû
 *
¤c_dev
)

456 
bŒfs_·th
 *
·th
;

457 
bŒfs_key
 
key
;

458 
bŒfs_key
 
found_key
;

459 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

460 
bŒfs_dev_ex‹Á
 *
dev_ex‹Á
 = 
NULL
;

461 
bŒfs_block_group
 *
ÿche
;

462 
bŒfs_Œªs_hªdË
 *
Œªs
;

463 
™”_»t
 = 0;

464 
»t
 = 0;

465 
u64
 
chunk_off£t
;

468 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

471 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

474 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

475 
fs_šfo
->
ruÂšg_Œª§ùiÚ
 &&

476 !
	`li¡_em±y
(&
fs_šfo
->
ruÂšg_Œª§ùiÚ
->
dev_upd©e_li¡
)) {

477 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

478 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

479 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ
(
roÙ
);

480 ià(
	`IS_ERR
(
Œªs
)) {

481 
»t
 = 
	`PTR_ERR
(
Œªs
);

482 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

483 ià(
»t
 =ğ-
ENOENT
) {

484 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

487 
uÆock
;

491 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

492 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

493 ià(
»t
)

494 
uÆock
;

496 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

498 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

500 
·th
 = 
	`bŒfs_®loc_·th
();

501 ià(!
·th
) {

502 
»t
 = -
ENOMEM
;

503 
uÆock
;

506 
·th
->
»ada
 = 
READA_FORWARD
;

507 
·th
->
£¬ch_comm™_roÙ
 = 1;

508 
·th
->
sk_lockšg
 = 1;

510 
key
.
objeùid
 = 
¤c_dev
->
devid
;

511 
key
.
ty³
 = 
BTRFS_DEV_EXTENT_KEY
;

512 
key
.
off£t
 = 0;

514 
	`bŒfs_fÜ_—ch_¦Ù
(
roÙ
, &
key
, &
found_key
, 
·th
, 
™”_»t
) {

515 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

517 ià(
found_key
.
objeùid
 !ğ
¤c_dev
->
devid
)

520 ià(
found_key
.
ty³
 !ğ
BTRFS_DEV_EXTENT_KEY
)

523 ià(
found_key
.
off£t
 < 
key
.offset)

526 
dev_ex‹Á
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_dev_ex‹Á
);

528 
chunk_off£t
 = 
	`bŒfs_dev_ex‹Á_chunk_off£t
(
Ëaf
, 
dev_ex‹Á
);

530 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
chunk_off£t
);

531 ià(!
ÿche
)

534 
	`£t_b™
(
BLOCK_GROUP_FLAG_TO_COPY
, &
ÿche
->
ruÁime_æags
);

535 
	`bŒfs_put_block_group
(
ÿche
);

537 ià(
™”_»t
 < 0)

538 
»t
 = 
™”_»t
;

540 
	`bŒfs_ä“_·th
(
·th
);

541 
uÆock
:

542 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

544  
»t
;

545 
	}
}

547 
boŞ
 
	$bŒfs_fšish_block_group_to_cİy
(
bŒfs_deviû
 *
¤cdev
,

548 
bŒfs_block_group
 *
ÿche
,

549 
u64
 
physiÿl
)

551 
bŒfs_fs_šfo
 *
fs_šfo
 = 
ÿche
->fs_info;

552 
ex‹Á_m­
 *
em
;

553 
m­_lookup
 *
m­
;

554 
u64
 
chunk_off£t
 = 
ÿche
->
¡¬t
;

555 
num_ex‹Ás
, 
cur_ex‹Á
;

556 
i
;

559 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

560  
Œue
;

562 
	`¥š_lock
(&
ÿche
->
lock
);

563 ià(
	`‹¡_b™
(
BLOCK_GROUP_FLAG_REMOVED
, &
ÿche
->
ruÁime_æags
)) {

564 
	`¥š_uÆock
(&
ÿche
->
lock
);

565  
Œue
;

567 
	`¥š_uÆock
(&
ÿche
->
lock
);

569 
em
 = 
	`bŒfs_g‘_chunk_m­
(
fs_šfo
, 
chunk_off£t
, 1);

570 
	`ASSERT
(!
	`IS_ERR
(
em
));

571 
m­
 = 
em
->
m­_lookup
;

573 
num_ex‹Ás
 = 0;

574 
cur_ex‹Á
 = 0;

575 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

577 ià(
¤cdev
 !ğ
m­
->
¡res
[
i
].
dev
)

580 
num_ex‹Ás
++;

581 ià(
physiÿl
 =ğ
m­
->
¡res
[
i
].physical)

582 
cur_ex‹Á
 = 
i
;

585 
	`ä“_ex‹Á_m­
(
em
);

587 ià(
num_ex‹Ás
 > 1 && 
cur_ex‹Á
 <‚um_extents - 1) {

592  
çl£
;

596 
	`ş—r_b™
(
BLOCK_GROUP_FLAG_TO_COPY
, &
ÿche
->
ruÁime_æags
);

598  
Œue
;

599 
	}
}

601 
	$bŒfs_dev_»¶aû_¡¬t
(
bŒfs_fs_šfo
 *
fs_šfo
,

602 cÚ¡ *
tgtdev_Çme
, 
u64
 
¤cdevid
, cÚ¡ *
¤cdev_Çme
,

603 
»ad_¤c
)

605 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

606 
bŒfs_Œªs_hªdË
 *
Œªs
;

607 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

608 
»t
;

609 
bŒfs_deviû
 *
tgt_deviû
 = 
NULL
;

610 
bŒfs_deviû
 *
¤c_deviû
 = 
NULL
;

612 
¤c_deviû
 = 
	`bŒfs_fšd_deviû_by_dev¥ec
(
fs_šfo
, 
¤cdevid
,

613 
¤cdev_Çme
);

614 ià(
	`IS_ERR
(
¤c_deviû
))

615  
	`PTR_ERR
(
¤c_deviû
);

617 ià(
	`bŒfs_pšÃd_by_sw­fe
(
fs_šfo
, 
¤c_deviû
)) {

618 
	`bŒfs_w¬n_š_rcu
(
fs_šfo
,

620 
	`bŒfs_dev_Çme
(
¤c_deviû
), src_deviû->
devid
);

621  -
ETXTBSY
;

628 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ
(
roÙ
);

629 ià(!
	`IS_ERR
(
Œªs
)) {

630 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

631 ià(
»t
)

632  
»t
;

633 } ià(
	`PTR_ERR
(
Œªs
è!ğ-
ENOENT
) {

634  
	`PTR_ERR
(
Œªs
);

637 
»t
 = 
	`bŒfs_š™_dev_»¶aû_tgtdev
(
fs_šfo
, 
tgtdev_Çme
,

638 
¤c_deviû
, &
tgt_deviû
);

639 ià(
»t
)

640  
»t
;

642 
»t
 = 
	`m¬k_block_group_to_cİy
(
fs_šfo
, 
¤c_deviû
);

643 ià(
»t
)

644  
»t
;

646 
	`down_wr™e
(&
dev_»¶aû
->
rw£m
);

647 
dev_»¶aû
->
»¶aû_¡©e
) {

648 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

649 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

650 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

652 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

653 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

654 
	`ASSERT
(0);

655 
»t
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_ALREADY_STARTED
;

656 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

657 
Ëave
;

660 
dev_»¶aû
->
cÚt_»adšg_äom_¤cdev_mode
 = 
»ad_¤c
;

661 
dev_»¶aû
->
¤cdev
 = 
¤c_deviû
;

662 
dev_»¶aû
->
tgtdev
 = 
tgt_deviû
;

664 
	`bŒfs_šfo_š_rcu
(
fs_šfo
,

666 
	`bŒfs_dev_Çme
(
¤c_deviû
),

667 
¤c_deviû
->
devid
,

668 
	`bŒfs_dev_Çme
(
tgt_deviû
));

674 
dev_»¶aû
->
»¶aû_¡©e
 = 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
;

675 
dev_»¶aû
->
time_¡¬‹d
 = 
	`ktime_g‘_»®_£cÚds
();

676 
dev_»¶aû
->
cursÜ_Ëá
 = 0;

677 
dev_»¶aû
->
comm™‹d_cursÜ_Ëá
 = 0;

678 
dev_»¶aû
->
cursÜ_Ëá_Ï¡_wr™e_of_™em
 = 0;

679 
dev_»¶aû
->
cursÜ_right
 = 0;

680 
dev_»¶aû
->
is_v®id
 = 1;

681 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 1;

682 
	`©omic64_£t
(&
dev_»¶aû
->
num_wr™e_”rÜs
, 0);

683 
	`©omic64_£t
(&
dev_»¶aû
->
num_uncÜ»ùabË_»ad_”rÜs
, 0);

684 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

686 
»t
 = 
	`bŒfs_sysfs_add_deviû
(
tgt_deviû
);

687 ià(
»t
)

688 
	`bŒfs_”r
(
fs_šfo
, "kobj‡dd dev faed %d", 
»t
);

690 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
U64_MAX
, 0, (
u64
)-1);

698 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

699 ià(
	`IS_ERR
(
Œªs
)) {

700 
»t
 = 
	`PTR_ERR
(
Œªs
);

701 
	`down_wr™e
(&
dev_»¶aû
->
rw£m
);

702 
dev_»¶aû
->
»¶aû_¡©e
 =

703 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
;

704 
dev_»¶aû
->
¤cdev
 = 
NULL
;

705 
dev_»¶aû
->
tgtdev
 = 
NULL
;

706 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

707 
Ëave
;

710 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

711 
	`WARN_ON
(
»t
);

714 
»t
 = 
	`bŒfs_süub_dev
(
fs_šfo
, 
¤c_deviû
->
devid
, 0,

715 
	`bŒfs_deviû_g‘_tÙ®_by‹s
(
¤c_deviû
),

716 &
dev_»¶aû
->
süub_´og»ss
, 0, 1);

718 
»t
 = 
	`bŒfs_dev_»¶aû_fšishšg
(
fs_šfo
,„et);

719 ià(
»t
 =ğ-
EINPROGRESS
)

720 
»t
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_SCRUB_INPROGRESS
;

722  
»t
;

724 
Ëave
:

725 
	`bŒfs_de¡roy_dev_»¶aû_tgtdev
(
tgt_deviû
);

726  
»t
;

727 
	}
}

729 
	$bŒfs_dev_»¶aû_by_ioùl
(
bŒfs_fs_šfo
 *
fs_šfo
,

730 
bŒfs_ioùl_dev_»¶aû_¬gs
 *
¬gs
)

732 
»t
;

734 
¬gs
->
¡¬t
.
cÚt_»adšg_äom_¤cdev_mode
) {

735 
BTRFS_IOCTL_DEV_REPLACE_CONT_READING_FROM_SRCDEV_MODE_ALWAYS
:

736 
BTRFS_IOCTL_DEV_REPLACE_CONT_READING_FROM_SRCDEV_MODE_AVOID
:

739  -
EINVAL
;

742 ià((
¬gs
->
¡¬t
.
¤cdevid
 =ğ0 &&‡rgs->¡¬t.
¤cdev_Çme
[0] == '\0') ||

743 
¬gs
->
¡¬t
.
tgtdev_Çme
[0] == '\0')

744  -
EINVAL
;

746 
»t
 = 
	`bŒfs_dev_»¶aû_¡¬t
(
fs_šfo
, 
¬gs
->
¡¬t
.
tgtdev_Çme
,

747 
¬gs
->
¡¬t
.
¤cdevid
,

748 
¬gs
->
¡¬t
.
¤cdev_Çme
,

749 
¬gs
->
¡¬t
.
cÚt_»adšg_äom_¤cdev_mode
);

750 
¬gs
->
»suÉ
 = 
»t
;

752 ià(
»t
 =ğ
BTRFS_IOCTL_DEV_REPLACE_RESULT_SCRUB_INPROGRESS
 ||

753 
»t
 =ğ
BTRFS_IOCTL_DEV_REPLACE_RESULT_NO_ERROR
)

756  
»t
;

757 
	}
}

762 
	$bŒfs_rm_dev_»¶aû_blocked
(
bŒfs_fs_šfo
 *
fs_šfo
)

764 
	`£t_b™
(
BTRFS_FS_STATE_DEV_REPLACING
, &
fs_šfo
->
fs_¡©e
);

765 
	`wa™_ev’t
(
fs_šfo
->
dev_»¶aû
.
»¶aû_wa™
, !
	`³rıu_couÁ”_sum
(

766 &
fs_šfo
->
dev_»¶aû
.
bio_couÁ”
));

767 
	}
}

772 
	$bŒfs_rm_dev_»¶aû_unblocked
(
bŒfs_fs_šfo
 *
fs_šfo
)

774 
	`ş—r_b™
(
BTRFS_FS_STATE_DEV_REPLACING
, &
fs_šfo
->
fs_¡©e
);

775 
	`wake_up
(&
fs_šfo
->
dev_»¶aû
.
»¶aû_wa™
);

776 
	}
}

784 
	$bŒfs_£t_rg‘_®loc_¡©e
(
bŒfs_deviû
 *
¤cdev
,

785 
bŒfs_deviû
 *
tgtdev
)

787 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

788 
u64
 
¡¬t
 = 0;

789 
u64
 
found_¡¬t
;

790 
u64
 
found_’d
;

791 
»t
 = 0;

793 
	`lockd•_as£¹_h–d
(&
¤cdev
->
fs_šfo
->
chunk_mu‹x
);

795 
	`fšd_fœ¡_ex‹Á_b™
(&
¤cdev
->
®loc_¡©e
, 
¡¬t
,

796 &
found_¡¬t
, &
found_’d
,

797 
CHUNK_ALLOCATED
, &
ÿched_¡©e
)) {

798 
»t
 = 
	`£t_ex‹Á_b™
(&
tgtdev
->
®loc_¡©e
, 
found_¡¬t
,

799 
found_’d
, 
CHUNK_ALLOCATED
, 
NULL
);

800 ià(
»t
)

802 
¡¬t
 = 
found_’d
 + 1;

805 
	`ä“_ex‹Á_¡©e
(
ÿched_¡©e
);

806  
»t
;

807 
	}
}

809 
	$bŒfs_dev_»¶aû_upd©e_deviû_š_m­pšg_Œ“
(

810 
bŒfs_fs_šfo
 *
fs_šfo
,

811 
bŒfs_deviû
 *
¤cdev
,

812 
bŒfs_deviû
 *
tgtdev
)

814 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

815 
ex‹Á_m­
 *
em
;

816 
m­_lookup
 *
m­
;

817 
u64
 
¡¬t
 = 0;

818 
i
;

820 
	`wr™e_lock
(&
em_Œ“
->
lock
);

822 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
¡¬t
, (
u64
)-1);

823 ià(!
em
)

825 
m­
 = 
em
->
m­_lookup
;

826 
i
 = 0; i < 
m­
->
num_¡res
; i++)

827 ià(
¤cdev
 =ğ
m­
->
¡res
[
i
].
dev
)

828 
m­
->
¡res
[
i
].
dev
 = 
tgtdev
;

829 
¡¬t
 = 
em
->¡¬ˆ+ƒm->
Ën
;

830 
	`ä“_ex‹Á_m­
(
em
);

831 } 
¡¬t
);

832 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

833 
	}
}

835 
	$bŒfs_dev_»¶aû_fšishšg
(
bŒfs_fs_šfo
 *
fs_šfo
,

836 
süub_»t
)

838 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

839 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

840 
bŒfs_deviû
 *
tgt_deviû
;

841 
bŒfs_deviû
 *
¤c_deviû
;

842 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

843 
u8
 
uuid_tmp
[
BTRFS_UUID_SIZE
];

844 
bŒfs_Œªs_hªdË
 *
Œªs
;

845 
»t
 = 0;

848 
	`mu‹x_lock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

850 
	`down_»ad
(&
dev_»¶aû
->
rw£m
);

852 ià(
dev_»¶aû
->
»¶aû_¡©e
 !=

853 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
) {

854 
	`up_»ad
(&
dev_»¶aû
->
rw£m
);

855 
	`mu‹x_uÆock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

859 
tgt_deviû
 = 
dev_»¶aû
->
tgtdev
;

860 
¤c_deviû
 = 
dev_»¶aû
->
¤cdev
;

861 
	`up_»ad
(&
dev_»¶aû
->
rw£m
);

867 
»t
 = 
	`bŒfs_¡¬t_d–®loc_roÙs
(
fs_šfo
, 
LONG_MAX
, 
çl£
);

868 ià(
»t
) {

869 
	`mu‹x_uÆock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

870  
»t
;

872 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
U64_MAX
, 0, (
u64
)-1);

880 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

881 ià(
	`IS_ERR
(
Œªs
)) {

882 
	`mu‹x_uÆock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

883  
	`PTR_ERR
(
Œªs
);

885 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

886 
	`WARN_ON
(
»t
);

889 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

891 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

893 ià(!
	`li¡_em±y
(&
¤c_deviû
->
po¡_comm™_li¡
)) {

894 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

895 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

901 
	`down_wr™e
(&
dev_»¶aû
->
rw£m
);

902 
dev_»¶aû
->
»¶aû_¡©e
 =

903 
süub_»t
 ? 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED


904 : 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
;

905 
dev_»¶aû
->
tgtdev
 = 
NULL
;

906 
dev_»¶aû
->
¤cdev
 = 
NULL
;

907 
dev_»¶aû
->
time_¡İ³d
 = 
	`ktime_g‘_»®_£cÚds
();

908 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 1;

914 ià(!
süub_»t
) {

915 
süub_»t
 = 
	`bŒfs_£t_rg‘_®loc_¡©e
(
¤c_deviû
, 
tgt_deviû
);

916 ià(
süub_»t
)

917 
”rÜ
;

918 
	`bŒfs_dev_»¶aû_upd©e_deviû_š_m­pšg_Œ“
(
fs_šfo
,

919 
¤c_deviû
,

920 
tgt_deviû
);

922 ià(
süub_»t
 !ğ-
ECANCELED
)

923 
	`bŒfs_”r_š_rcu
(
fs_šfo
,

925 
	`bŒfs_dev_Çme
(
¤c_deviû
),

926 
¤c_deviû
->
devid
,

927 
	`bŒfs_dev_Çme
(
tgt_deviû
), 
süub_»t
);

928 
”rÜ
:

929 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

930 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

931 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

932 
	`bŒfs_rm_dev_»¶aû_blocked
(
fs_šfo
);

933 ià(
tgt_deviû
)

934 
	`bŒfs_de¡roy_dev_»¶aû_tgtdev
(
tgt_deviû
);

935 
	`bŒfs_rm_dev_»¶aû_unblocked
(
fs_šfo
);

936 
	`mu‹x_uÆock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

938  
süub_»t
;

941 
	`bŒfs_šfo_š_rcu
(
fs_šfo
,

943 
	`bŒfs_dev_Çme
(
¤c_deviû
),

944 
¤c_deviû
->
devid
,

945 
	`bŒfs_dev_Çme
(
tgt_deviû
));

946 
	`ş—r_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
tgt_deviû
->
dev_¡©e
);

947 
tgt_deviû
->
devid
 = 
¤c_deviû
->devid;

948 
¤c_deviû
->
devid
 = 
BTRFS_DEV_REPLACE_DEVID
;

949 
	`memıy
(
uuid_tmp
, 
tgt_deviû
->
uuid
, (uuid_tmp));

950 
	`memıy
(
tgt_deviû
->
uuid
, 
¤c_deviû
->uuid, (tgt_device->uuid));

951 
	`memıy
(
¤c_deviû
->
uuid
, 
uuid_tmp
, (src_device->uuid));

952 
	`bŒfs_deviû_£t_tÙ®_by‹s
(
tgt_deviû
, 
¤c_deviû
->
tÙ®_by‹s
);

953 
	`bŒfs_deviû_£t_disk_tÙ®_by‹s
(
tgt_deviû
,

954 
¤c_deviû
->
disk_tÙ®_by‹s
);

955 
	`bŒfs_deviû_£t_by‹s_u£d
(
tgt_deviû
, 
¤c_deviû
->
by‹s_u£d
);

956 
tgt_deviû
->
comm™_by‹s_u£d
 = 
¤c_deviû
->
by‹s_u£d
;

958 
	`bŒfs_assign_Ãxt_aùive_deviû
(
¤c_deviû
, 
tgt_deviû
);

960 
	`li¡_add
(&
tgt_deviû
->
dev_®loc_li¡
, &
fs_deviûs
->
®loc_li¡
);

961 
fs_deviûs
->
rw_deviûs
++;

963 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

964 
	`bŒfs_rm_dev_»¶aû_blocked
(
fs_šfo
);

966 
	`bŒfs_rm_dev_»¶aû_»move_¤cdev
(
¤c_deviû
);

968 
	`bŒfs_rm_dev_»¶aû_unblocked
(
fs_šfo
);

974 
	`©omic_šc
(&
tgt_deviû
->
dev_¡©s_cút
);

983 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

984 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

987 
	`bŒfs_sysfs_»move_deviû
(
¤c_deviû
);

988 
	`bŒfs_sysfs_upd©e_devid
(
tgt_deviû
);

989 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
¤c_deviû
->
dev_¡©e
))

990 
	`bŒfs_sü©ch_su³rblocks
(
fs_šfo
, 
¤c_deviû
->
bdev
,

991 
¤c_deviû
->
Çme
->
¡r
);

994 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

995 ià(!
	`IS_ERR
(
Œªs
))

996 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

998 
	`mu‹x_uÆock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

1000 
	`bŒfs_rm_dev_»¶aû_ä“_¤cdev
(
¤c_deviû
);

1003 
	}
}

1010 
u64
 
	$bŒfs_dev_»¶aû_´og»ss
(
bŒfs_fs_šfo
 *
fs_šfo
)

1012 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

1013 
u64
 
»t
 = 0;

1015 
dev_»¶aû
->
»¶aû_¡©e
) {

1016 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

1017 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

1018 
»t
 = 0;

1020 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

1021 
»t
 = 1000;

1023 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

1024 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

1025 
»t
 = 
	`div64_u64
(
dev_»¶aû
->
cursÜ_Ëá
,

1026 
	`div_u64
(
	`bŒfs_deviû_g‘_tÙ®_by‹s
(

1027 
dev_»¶aû
->
¤cdev
), 1000));

1031  
»t
;

1032 
	}
}

1034 
	$bŒfs_dev_»¶aû_¡©us
(
bŒfs_fs_šfo
 *
fs_šfo
,

1035 
bŒfs_ioùl_dev_»¶aû_¬gs
 *
¬gs
)

1037 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

1039 
	`down_»ad
(&
dev_»¶aû
->
rw£m
);

1042 
¬gs
->
»suÉ
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_NO_ERROR
;

1043 
¬gs
->
¡©us
.
»¶aû_¡©e
 = 
dev_»¶aû
->replace_state;

1044 
¬gs
->
¡©us
.
time_¡¬‹d
 = 
dev_»¶aû
->time_started;

1045 
¬gs
->
¡©us
.
time_¡İ³d
 = 
dev_»¶aû
->time_stopped;

1046 
¬gs
->
¡©us
.
num_wr™e_”rÜs
 =

1047 
	`©omic64_»ad
(&
dev_»¶aû
->
num_wr™e_”rÜs
);

1048 
¬gs
->
¡©us
.
num_uncÜ»ùabË_»ad_”rÜs
 =

1049 
	`©omic64_»ad
(&
dev_»¶aû
->
num_uncÜ»ùabË_»ad_”rÜs
);

1050 
¬gs
->
¡©us
.
´og»ss_1000
 = 
	`bŒfs_dev_»¶aû_´og»ss
(
fs_šfo
);

1051 
	`up_»ad
(&
dev_»¶aû
->
rw£m
);

1052 
	}
}

1054 
	$bŒfs_dev_»¶aû_ÿnûl
(
bŒfs_fs_šfo
 *
fs_šfo
)

1056 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

1057 
bŒfs_deviû
 *
tgt_deviû
 = 
NULL
;

1058 
bŒfs_deviû
 *
¤c_deviû
 = 
NULL
;

1059 
bŒfs_Œªs_hªdË
 *
Œªs
;

1060 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

1061 
»suÉ
;

1062 
»t
;

1064 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
))

1065  -
EROFS
;

1067 
	`mu‹x_lock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

1068 
	`down_wr™e
(&
dev_»¶aû
->
rw£m
);

1069 
dev_»¶aû
->
»¶aû_¡©e
) {

1070 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

1071 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

1072 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

1073 
»suÉ
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_NOT_STARTED
;

1074 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

1076 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

1077 
tgt_deviû
 = 
dev_»¶aû
->
tgtdev
;

1078 
¤c_deviû
 = 
dev_»¶aû
->
¤cdev
;

1079 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

1080 
»t
 = 
	`bŒfs_süub_ÿnûl
(
fs_šfo
);

1081 ià(
»t
 < 0) {

1082 
»suÉ
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_NOT_STARTED
;

1084 
»suÉ
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_NO_ERROR
;

1089 
	`bŒfs_šfo_š_rcu
(
fs_šfo
,

1091 
	`bŒfs_dev_Çme
(
¤c_deviû
), src_deviû->
devid
,

1092 
	`bŒfs_dev_Çme
(
tgt_deviû
));

1095 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

1100 
»suÉ
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_NO_ERROR
;

1101 
tgt_deviû
 = 
dev_»¶aû
->
tgtdev
;

1102 
¤c_deviû
 = 
dev_»¶aû
->
¤cdev
;

1103 
dev_»¶aû
->
tgtdev
 = 
NULL
;

1104 
dev_»¶aû
->
¤cdev
 = 
NULL
;

1105 
dev_»¶aû
->
»¶aû_¡©e
 =

1106 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
;

1107 
dev_»¶aû
->
time_¡İ³d
 = 
	`ktime_g‘_»®_£cÚds
();

1108 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 1;

1110 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

1113 
	`bŒfs_süub_ÿnûl
(
fs_šfo
);

1115 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

1116 ià(
	`IS_ERR
(
Œªs
)) {

1117 
	`mu‹x_uÆock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

1118  
	`PTR_ERR
(
Œªs
);

1120 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1121 
	`WARN_ON
(
»t
);

1123 
	`bŒfs_šfo_š_rcu
(
fs_šfo
,

1125 
	`bŒfs_dev_Çme
(
¤c_deviû
), src_deviû->
devid
,

1126 
	`bŒfs_dev_Çme
(
tgt_deviû
));

1128 ià(
tgt_deviû
)

1129 
	`bŒfs_de¡roy_dev_»¶aû_tgtdev
(
tgt_deviû
);

1132 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

1133 
»suÉ
 = -
EINVAL
;

1136 
	`mu‹x_uÆock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

1137  
»suÉ
;

1138 
	}
}

1140 
	$bŒfs_dev_»¶aû_su¥’d_fÜ_unmouÁ
(
bŒfs_fs_šfo
 *
fs_šfo
)

1142 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

1144 
	`mu‹x_lock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

1145 
	`down_wr™e
(&
dev_»¶aû
->
rw£m
);

1147 
dev_»¶aû
->
»¶aû_¡©e
) {

1148 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

1149 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

1150 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

1151 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

1153 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

1154 
dev_»¶aû
->
»¶aû_¡©e
 =

1155 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
;

1156 
dev_»¶aû
->
time_¡İ³d
 = 
	`ktime_g‘_»®_£cÚds
();

1157 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 1;

1158 
	`bŒfs_šfo
(
fs_šfo
, "suspending dev_replace for unmount");

1162 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

1163 
	`mu‹x_uÆock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

1164 
	}
}

1167 
	$bŒfs_»sume_dev_»¶aû_async
(
bŒfs_fs_šfo
 *
fs_šfo
)

1169 
sk_¡ruù
 *
sk
;

1170 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

1172 
	`down_wr™e
(&
dev_»¶aû
->
rw£m
);

1174 
dev_»¶aû
->
»¶aû_¡©e
) {

1175 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

1176 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

1177 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

1178 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

1180 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

1182 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

1183 
dev_»¶aû
->
»¶aû_¡©e
 =

1184 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
;

1187 ià(!
dev_»¶aû
->
tgtdev
 || !dev_»¶aû->tgtdev->
bdev
) {

1188 
	`bŒfs_šfo
(
fs_šfo
,

1190 
	`bŒfs_šfo
(
fs_šfo
,

1192 
dev_»¶aû
->
»¶aû_¡©e
 =

1193 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
;

1194 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

1197 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

1204 ià(!
	`bŒfs_exşİ_¡¬t
(
fs_šfo
, 
BTRFS_EXCLOP_DEV_REPLACE
)) {

1205 
	`down_wr™e
(&
dev_»¶aû
->
rw£m
);

1206 
dev_»¶aû
->
»¶aû_¡©e
 =

1207 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
;

1208 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

1209 
	`bŒfs_šfo
(
fs_šfo
,

1214 
sk
 = 
	`kth»ad_run
(
bŒfs_dev_»¶aû_kth»ad
, 
fs_šfo
, "btrfs-devrepl");

1215  
	`PTR_ERR_OR_ZERO
(
sk
);

1216 
	}
}

1218 
	$bŒfs_dev_»¶aû_kth»ad
(*
d©a
)

1220 
bŒfs_fs_šfo
 *
fs_šfo
 = 
d©a
;

1221 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

1222 
u64
 
´og»ss
;

1223 
»t
;

1225 
´og»ss
 = 
	`bŒfs_dev_»¶aû_´og»ss
(
fs_šfo
);

1226 
´og»ss
 = 
	`div_u64
(progress, 10);

1227 
	`bŒfs_šfo_š_rcu
(
fs_šfo
,

1229 
	`bŒfs_dev_Çme
(
dev_»¶aû
->
¤cdev
),

1230 
dev_»¶aû
->
¤cdev
->
devid
,

1231 
	`bŒfs_dev_Çme
(
dev_»¶aû
->
tgtdev
),

1232 ()
´og»ss
);

1234 
»t
 = 
	`bŒfs_süub_dev
(
fs_šfo
, 
dev_»¶aû
->
¤cdev
->
devid
,

1235 
dev_»¶aû
->
comm™‹d_cursÜ_Ëá
,

1236 
	`bŒfs_deviû_g‘_tÙ®_by‹s
(
dev_»¶aû
->
¤cdev
),

1237 &
dev_»¶aû
->
süub_´og»ss
, 0, 1);

1238 
»t
 = 
	`bŒfs_dev_»¶aû_fšishšg
(
fs_šfo
,„et);

1239 
	`WARN_ON
(
»t
 &&„‘ !ğ-
ECANCELED
);

1241 
	`bŒfs_exşİ_fšish
(
fs_šfo
);

1243 
	}
}

1245 
__pu»
 
	$bŒfs_dev_»¶aû_is_Úgošg
(
bŒfs_dev_»¶aû
 *
dev_»¶aû
)

1247 ià(!
dev_»¶aû
->
is_v®id
)

1250 
dev_»¶aû
->
»¶aû_¡©e
) {

1251 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

1252 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

1253 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

1255 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

1256 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

1270 
	}
}

1272 
	$bŒfs_bio_couÁ”_sub
(
bŒfs_fs_šfo
 *
fs_šfo
, 
s64
 
amouÁ
)

1274 
	`³rıu_couÁ”_sub
(&
fs_šfo
->
dev_»¶aû
.
bio_couÁ”
, 
amouÁ
);

1275 
	`cÚd_wake_up_nomb
(&
fs_šfo
->
dev_»¶aû
.
»¶aû_wa™
);

1276 
	}
}

1278 
	$bŒfs_bio_couÁ”_šc_blocked
(
bŒfs_fs_šfo
 *
fs_šfo
)

1281 
	`³rıu_couÁ”_šc
(&
fs_šfo
->
dev_»¶aû
.
bio_couÁ”
);

1282 ià(
	`lik–y
(!
	`‹¡_b™
(
BTRFS_FS_STATE_DEV_REPLACING
,

1283 &
fs_šfo
->
fs_¡©e
)))

1286 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

1287 
	`wa™_ev’t
(
fs_šfo
->
dev_»¶aû
.
»¶aû_wa™
,

1288 !
	`‹¡_b™
(
BTRFS_FS_STATE_DEV_REPLACING
,

1289 &
fs_šfo
->
fs_¡©e
));

1291 
	}
}

	@dev-replace.h

6 #iâdeà
BTRFS_DEV_REPLACE_H


7 
	#BTRFS_DEV_REPLACE_H


	)

9 
	gbŒfs_ioùl_dev_»¶aû_¬gs
;

10 
	gbŒfs_fs_šfo
;

11 
	gbŒfs_Œªs_hªdË
;

12 
	gbŒfs_dev_»¶aû
;

13 
	gbŒfs_block_group
;

15 
bŒfs_š™_dev_»¶aû
(
bŒfs_fs_šfo
 *
fs_šfo
);

16 
bŒfs_run_dev_»¶aû
(
bŒfs_Œªs_hªdË
 *
Œªs
);

17 
bŒfs_dev_»¶aû_by_ioùl
(
bŒfs_fs_šfo
 *
fs_šfo
,

18 
bŒfs_ioùl_dev_»¶aû_¬gs
 *
¬gs
);

19 
bŒfs_dev_»¶aû_¡©us
(
bŒfs_fs_šfo
 *
fs_šfo
,

20 
bŒfs_ioùl_dev_»¶aû_¬gs
 *
¬gs
);

21 
bŒfs_dev_»¶aû_ÿnûl
(
bŒfs_fs_šfo
 *
fs_šfo
);

22 
bŒfs_dev_»¶aû_su¥’d_fÜ_unmouÁ
(
bŒfs_fs_šfo
 *
fs_šfo
);

23 
bŒfs_»sume_dev_»¶aû_async
(
bŒfs_fs_šfo
 *
fs_šfo
);

24 
__pu»
 
bŒfs_dev_»¶aû_is_Úgošg
(
bŒfs_dev_»¶aû
 *
dev_»¶aû
);

25 
boŞ
 
bŒfs_fšish_block_group_to_cİy
(
bŒfs_deviû
 *
¤cdev
,

26 
bŒfs_block_group
 *
ÿche
,

27 
u64
 
physiÿl
);

28 
bŒfs_bio_couÁ”_šc_blocked
(
bŒfs_fs_šfo
 *
fs_šfo
);

29 
bŒfs_bio_couÁ”_sub
(
bŒfs_fs_šfo
 *
fs_šfo
, 
s64
 
amouÁ
);

31 
šlše
 
	$bŒfs_bio_couÁ”_dec
(
bŒfs_fs_šfo
 *
fs_šfo
)

33 
	`bŒfs_bio_couÁ”_sub
(
fs_šfo
, 1);

34 
	}
}

	@dir-item.c

6 
	~"mes§ges.h
"

7 
	~"ù»e.h
"

8 
	~"disk-io.h
"

9 
	~"Œª§ùiÚ.h
"

10 
	~"acûssÜs.h
"

11 
	~"dœ-™em.h
"

21 
bŒfs_dœ_™em
 *
	$š£¹_w™h_ov”æow
(
bŒfs_Œªs_hªdË


22 *
Œªs
,

23 
bŒfs_roÙ
 *
roÙ
,

24 
bŒfs_·th
 *
·th
,

25 
bŒfs_key
 *
ıu_key
,

26 
u32
 
d©a_size
,

27 cÚ¡ *
Çme
,

28 
Çme_Ën
)

30 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

31 
»t
;

32 *
±r
;

33 
ex‹Á_bufãr
 *
Ëaf
;

35 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, 
ıu_key
, 
d©a_size
);

36 ià(
»t
 =ğ-
EEXIST
) {

37 
bŒfs_dœ_™em
 *
di
;

38 
di
 = 
	`bŒfs_m©ch_dœ_™em_Çme
(
fs_šfo
, 
·th
, 
Çme
, 
Çme_Ën
);

39 ià(
di
)

40  
	`ERR_PTR
(-
EEXIST
);

41 
	`bŒfs_ex‹nd_™em
(
Œªs
, 
·th
, 
d©a_size
);

42 } ià(
»t
 < 0)

43  
	`ERR_PTR
(
»t
);

44 
	`WARN_ON
(
»t
 > 0);

45 
Ëaf
 = 
·th
->
nodes
[0];

46 
±r
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], );

47 
	`ASSERT
(
d©a_size
 <ğ
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]));

48 
±r
 +ğ
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]è- 
d©a_size
;

49  (
bŒfs_dœ_™em
 *)
±r
;

50 
	}
}

56 
	$bŒfs_š£¹_x©Œ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

57 
bŒfs_roÙ
 *
roÙ
,

58 
bŒfs_·th
 *
·th
, 
u64
 
objeùid
,

59 cÚ¡ *
Çme
, 
u16
 
Çme_Ën
,

60 cÚ¡ *
d©a
, 
u16
 
d©a_Ën
)

62 
»t
 = 0;

63 
bŒfs_dœ_™em
 *
dœ_™em
;

64 
Çme_±r
, 
d©a_±r
;

65 
bŒfs_key
 
key
, 
loÿtiÚ
;

66 
bŒfs_disk_key
 
disk_key
;

67 
ex‹Á_bufãr
 *
Ëaf
;

68 
u32
 
d©a_size
;

70 ià(
Çme_Ën
 + 
d©a_Ën
 > 
	`BTRFS_MAX_XATTR_SIZE
(
roÙ
->
fs_šfo
))

71  -
ENOSPC
;

73 
key
.
objeùid
 = objectid;

74 
key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

75 
key
.
off£t
 = 
	`bŒfs_Çme_hash
(
Çme
, 
Çme_Ën
);

77 
d©a_size
 = (*
dœ_™em
è+ 
Çme_Ën
 + 
d©a_Ën
;

78 
dœ_™em
 = 
	`š£¹_w™h_ov”æow
(
Œªs
, 
roÙ
, 
·th
, &
key
, 
d©a_size
,

79 
Çme
, 
Çme_Ën
);

80 ià(
	`IS_ERR
(
dœ_™em
))

81  
	`PTR_ERR
(
dœ_™em
);

82 
	`mem£t
(&
loÿtiÚ
, 0, (location));

84 
Ëaf
 = 
·th
->
nodes
[0];

85 
	`bŒfs_ıu_key_to_disk
(&
disk_key
, &
loÿtiÚ
);

86 
	`bŒfs_£t_dœ_™em_key
(
Ëaf
, 
dœ_™em
, &
disk_key
);

87 
	`bŒfs_£t_dœ_æags
(
Ëaf
, 
dœ_™em
, 
BTRFS_FT_XATTR
);

88 
	`bŒfs_£t_dœ_Çme_Ën
(
Ëaf
, 
dœ_™em
, 
Çme_Ën
);

89 
	`bŒfs_£t_dœ_Œªsid
(
Ëaf
, 
dœ_™em
, 
Œªs
->
Œªsid
);

90 
	`bŒfs_£t_dœ_d©a_Ën
(
Ëaf
, 
dœ_™em
, 
d©a_Ën
);

91 
Çme_±r
 = ()(
dœ_™em
 + 1);

92 
d©a_±r
 = ()((*)
Çme_±r
 + 
Çme_Ën
);

94 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
Çme
, 
Çme_±r
, 
Çme_Ën
);

95 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
d©a
, 
d©a_±r
, 
d©a_Ën
);

96 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·th
->
nodes
[0]);

98  
»t
;

99 
	}
}

109 
	$bŒfs_š£¹_dœ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

110 cÚ¡ 
fsüy±_¡r
 *
Çme
, 
bŒfs_šode
 *
dœ
,

111 
bŒfs_key
 *
loÿtiÚ
, 
u8
 
ty³
, 
u64
 
šdex
)

113 
»t
 = 0;

114 
»t2
 = 0;

115 
bŒfs_roÙ
 *
roÙ
 = 
dœ
->root;

116 
bŒfs_·th
 *
·th
;

117 
bŒfs_dœ_™em
 *
dœ_™em
;

118 
ex‹Á_bufãr
 *
Ëaf
;

119 
Çme_±r
;

120 
bŒfs_key
 
key
;

121 
bŒfs_disk_key
 
disk_key
;

122 
u32
 
d©a_size
;

124 
key
.
objeùid
 = 
	`bŒfs_šo
(
dœ
);

125 
key
.
ty³
 = 
BTRFS_DIR_ITEM_KEY
;

126 
key
.
off£t
 = 
	`bŒfs_Çme_hash
(
Çme
->Çme,‚ame->
Ën
);

128 
·th
 = 
	`bŒfs_®loc_·th
();

129 ià(!
·th
)

130  -
ENOMEM
;

132 
	`bŒfs_ıu_key_to_disk
(&
disk_key
, 
loÿtiÚ
);

134 
d©a_size
 = (*
dœ_™em
è+ 
Çme
->
Ën
;

135 
dœ_™em
 = 
	`š£¹_w™h_ov”æow
(
Œªs
, 
roÙ
, 
·th
, &
key
, 
d©a_size
,

136 
Çme
->Çme,‚ame->
Ën
);

137 ià(
	`IS_ERR
(
dœ_™em
)) {

138 
»t
 = 
	`PTR_ERR
(
dœ_™em
);

139 ià(
»t
 =ğ-
EEXIST
)

140 
£cÚd_š£¹
;

141 
out_ä“
;

144 ià(
	`IS_ENCRYPTED
(&
dœ
->
vfs_šode
))

145 
ty³
 |ğ
BTRFS_FT_ENCRYPTED
;

147 
Ëaf
 = 
·th
->
nodes
[0];

148 
	`bŒfs_£t_dœ_™em_key
(
Ëaf
, 
dœ_™em
, &
disk_key
);

149 
	`bŒfs_£t_dœ_æags
(
Ëaf
, 
dœ_™em
, 
ty³
);

150 
	`bŒfs_£t_dœ_d©a_Ën
(
Ëaf
, 
dœ_™em
, 0);

151 
	`bŒfs_£t_dœ_Çme_Ën
(
Ëaf
, 
dœ_™em
, 
Çme
->
Ën
);

152 
	`bŒfs_£t_dœ_Œªsid
(
Ëaf
, 
dœ_™em
, 
Œªs
->
Œªsid
);

153 
Çme_±r
 = ()(
dœ_™em
 + 1);

155 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
Çme
->Çme, 
Çme_±r
,‚ame->
Ën
);

156 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

158 
£cÚd_š£¹
:

160 ià(
roÙ
 =ğroÙ->
fs_šfo
->
Œ“_roÙ
) {

161 
»t
 = 0;

162 
out_ä“
;

164 
	`bŒfs_»Ëa£_·th
(
·th
);

166 
»t2
 = 
	`bŒfs_š£¹_d–ayed_dœ_šdex
(
Œªs
, 
Çme
->Çme,‚ame->
Ën
, 
dœ
,

167 &
disk_key
, 
ty³
, 
šdex
);

168 
out_ä“
:

169 
	`bŒfs_ä“_·th
(
·th
);

170 ià(
»t
)

171  
»t
;

172 ià(
»t2
)

173  
»t2
;

175 
	}
}

177 
bŒfs_dœ_™em
 *
	$bŒfs_lookup_m©ch_dœ
(

178 
bŒfs_Œªs_hªdË
 *
Œªs
,

179 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

180 
bŒfs_key
 *
key
, cÚ¡ *
Çme
,

181 
Çme_Ën
, 
mod
)

183 cÚ¡ 
šs_Ën
 = (
mod
 < 0 ? -1 : 0);

184 cÚ¡ 
cow
 = (
mod
 != 0);

185 
»t
;

187 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, 
key
, 
·th
, 
šs_Ën
, 
cow
);

188 ià(
»t
 < 0)

189  
	`ERR_PTR
(
»t
);

190 ià(
»t
 > 0)

191  
	`ERR_PTR
(-
ENOENT
);

193  
	`bŒfs_m©ch_dœ_™em_Çme
(
roÙ
->
fs_šfo
, 
·th
, 
Çme
, 
Çme_Ën
);

194 
	}
}

212 
bŒfs_dœ_™em
 *
	$bŒfs_lookup_dœ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

213 
bŒfs_roÙ
 *
roÙ
,

214 
bŒfs_·th
 *
·th
, 
u64
 
dœ
,

215 cÚ¡ 
fsüy±_¡r
 *
Çme
,

216 
mod
)

218 
bŒfs_key
 
key
;

219 
bŒfs_dœ_™em
 *
di
;

221 
key
.
objeùid
 = 
dœ
;

222 
key
.
ty³
 = 
BTRFS_DIR_ITEM_KEY
;

223 
key
.
off£t
 = 
	`bŒfs_Çme_hash
(
Çme
->Çme,‚ame->
Ën
);

225 
di
 = 
	`bŒfs_lookup_m©ch_dœ
(
Œªs
, 
roÙ
, 
·th
, &
key
, 
Çme
->name,

226 
Çme
->
Ën
, 
mod
);

227 ià(
	`IS_ERR
(
di
è&& 
	`PTR_ERR
(diè=ğ-
ENOENT
)

228  
NULL
;

230  
di
;

231 
	}
}

233 
	$bŒfs_check_dœ_™em_cŞlisiÚ
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
dœ
,

234 cÚ¡ 
fsüy±_¡r
 *
Çme
)

236 
»t
;

237 
bŒfs_key
 
key
;

238 
bŒfs_dœ_™em
 *
di
;

239 
d©a_size
;

240 
ex‹Á_bufãr
 *
Ëaf
;

241 
¦Ù
;

242 
bŒfs_·th
 *
·th
;

244 
·th
 = 
	`bŒfs_®loc_·th
();

245 ià(!
·th
)

246  -
ENOMEM
;

248 
key
.
objeùid
 = 
dœ
;

249 
key
.
ty³
 = 
BTRFS_DIR_ITEM_KEY
;

250 
key
.
off£t
 = 
	`bŒfs_Çme_hash
(
Çme
->Çme,‚ame->
Ën
);

252 
di
 = 
	`bŒfs_lookup_m©ch_dœ
(
NULL
, 
roÙ
, 
·th
, &
key
, 
Çme
->name,

253 
Çme
->
Ën
, 0);

254 ià(
	`IS_ERR
(
di
)) {

255 
»t
 = 
	`PTR_ERR
(
di
);

257 ià(
»t
 =ğ-
ENOENT
) {

258 
»t
 = 0;

259 
out
;

262 ià(
»t
 < 0)

263 
out
;

267 ià(
di
) {

269 
»t
 = -
EEXIST
;

270 
out
;

274 
d©a_size
 = (*
di
è+ 
Çme
->
Ën
;

275 
Ëaf
 = 
·th
->
nodes
[0];

276 
¦Ù
 = 
·th
->
¦Ùs
[0];

277 ià(
d©a_size
 + 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
) +

278 (
bŒfs_™em
è> 
	`BTRFS_LEAF_DATA_SIZE
(
roÙ
->
fs_šfo
)) {

279 
»t
 = -
EOVERFLOW
;

282 
»t
 = 0;

284 
out
:

285 
	`bŒfs_ä“_·th
(
·th
);

286  
»t
;

287 
	}
}

307 
bŒfs_dœ_™em
 *

308 
	$bŒfs_lookup_dœ_šdex_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

309 
bŒfs_roÙ
 *
roÙ
,

310 
bŒfs_·th
 *
·th
, 
u64
 
dœ
,

311 
u64
 
šdex
, cÚ¡ 
fsüy±_¡r
 *
Çme
, 
mod
)

313 
bŒfs_dœ_™em
 *
di
;

314 
bŒfs_key
 
key
;

316 
key
.
objeùid
 = 
dœ
;

317 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

318 
key
.
off£t
 = 
šdex
;

320 
di
 = 
	`bŒfs_lookup_m©ch_dœ
(
Œªs
, 
roÙ
, 
·th
, &
key
, 
Çme
->name,

321 
Çme
->
Ën
, 
mod
);

322 ià(
di
 =ğ
	`ERR_PTR
(-
ENOENT
))

323  
NULL
;

325  
di
;

326 
	}
}

328 
bŒfs_dœ_™em
 *

329 
	$bŒfs_£¬ch_dœ_šdex_™em
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

330 
u64
 
dœid
, cÚ¡ 
fsüy±_¡r
 *
Çme
)

332 
bŒfs_dœ_™em
 *
di
;

333 
bŒfs_key
 
key
;

334 
»t
;

336 
key
.
objeùid
 = 
dœid
;

337 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

338 
key
.
off£t
 = 0;

340 
	`bŒfs_fÜ_—ch_¦Ù
(
roÙ
, &
key
, &key, 
·th
, 
»t
) {

341 ià(
key
.
objeùid
 !ğ
dœid
 || key.
ty³
 !ğ
BTRFS_DIR_INDEX_KEY
)

344 
di
 = 
	`bŒfs_m©ch_dœ_™em_Çme
(
roÙ
->
fs_šfo
, 
·th
,

345 
Çme
->Çme,‚ame->
Ën
);

346 ià(
di
)

347  
di
;

350 ià(
»t
 > 0)

351 
»t
 = 0;

353  
	`ERR_PTR
(
»t
);

354 
	}
}

356 
bŒfs_dœ_™em
 *
	$bŒfs_lookup_x©Œ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

357 
bŒfs_roÙ
 *
roÙ
,

358 
bŒfs_·th
 *
·th
, 
u64
 
dœ
,

359 cÚ¡ *
Çme
, 
u16
 
Çme_Ën
,

360 
mod
)

362 
bŒfs_key
 
key
;

363 
bŒfs_dœ_™em
 *
di
;

365 
key
.
objeùid
 = 
dœ
;

366 
key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

367 
key
.
off£t
 = 
	`bŒfs_Çme_hash
(
Çme
, 
Çme_Ën
);

369 
di
 = 
	`bŒfs_lookup_m©ch_dœ
(
Œªs
, 
roÙ
, 
·th
, &
key
, 
Çme
, 
Çme_Ën
, 
mod
);

370 ià(
	`IS_ERR
(
di
è&& 
	`PTR_ERR
(diè=ğ-
ENOENT
)

371  
NULL
;

373  
di
;

374 
	}
}

381 
bŒfs_dœ_™em
 *
	$bŒfs_m©ch_dœ_™em_Çme
(
bŒfs_fs_šfo
 *
fs_šfo
,

382 
bŒfs_·th
 *
·th
,

383 cÚ¡ *
Çme
, 
Çme_Ën
)

385 
bŒfs_dœ_™em
 *
dœ_™em
;

386 
Çme_±r
;

387 
u32
 
tÙ®_Ën
;

388 
u32
 
cur
 = 0;

389 
u32
 
this_Ën
;

390 
ex‹Á_bufãr
 *
Ëaf
;

392 
Ëaf
 = 
·th
->
nodes
[0];

393 
dœ_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_dœ_™em
);

395 
tÙ®_Ën
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

396 
cur
 < 
tÙ®_Ën
) {

397 
this_Ën
 = (*
dœ_™em
) +

398 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
dœ_™em
) +

399 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
dœ_™em
);

400 
Çme_±r
 = ()(
dœ_™em
 + 1);

402 ià(
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
dœ_™em
è=ğ
Çme_Ën
 &&

403 
	`memcmp_ex‹Á_bufãr
(
Ëaf
, 
Çme
, 
Çme_±r
, 
Çme_Ën
) == 0)

404  
dœ_™em
;

406 
cur
 +ğ
this_Ën
;

407 
dœ_™em
 = (
bŒfs_dœ_™em
 *)((*)dir_item +

408 
this_Ën
);

410  
NULL
;

411 
	}
}

417 
	$bŒfs_d–‘e_Úe_dœ_Çme
(
bŒfs_Œªs_hªdË
 *
Œªs
,

418 
bŒfs_roÙ
 *
roÙ
,

419 
bŒfs_·th
 *
·th
,

420 
bŒfs_dœ_™em
 *
di
)

423 
ex‹Á_bufãr
 *
Ëaf
;

424 
u32
 
sub_™em_Ën
;

425 
u32
 
™em_Ën
;

426 
»t
 = 0;

428 
Ëaf
 = 
·th
->
nodes
[0];

429 
sub_™em_Ën
 = (*
di
è+ 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, di) +

430 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
);

431 
™em_Ën
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

432 ià(
sub_™em_Ën
 =ğ
™em_Ën
) {

433 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

436 
±r
 = ()
di
;

437 
¡¬t
;

439 
¡¬t
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

440 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
±r
,…Œ + 
sub_™em_Ën
,

441 
™em_Ën
 - (
±r
 + 
sub_™em_Ën
 - 
¡¬t
));

442 
	`bŒfs_Œunÿ‹_™em
(
Œªs
, 
·th
, 
™em_Ën
 - 
sub_™em_Ën
, 1);

444  
»t
;

445 
	}
}

	@dir-item.h

3 #iâdeà
BTRFS_DIR_ITEM_H


4 
	#BTRFS_DIR_ITEM_H


	)

6 
bŒfs_check_dœ_™em_cŞlisiÚ
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
dœ
,

7 cÚ¡ 
fsüy±_¡r
 *
Çme
);

8 
bŒfs_š£¹_dœ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

9 cÚ¡ 
fsüy±_¡r
 *
Çme
, 
bŒfs_šode
 *
dœ
,

10 
bŒfs_key
 *
loÿtiÚ
, 
u8
 
ty³
, 
u64
 
šdex
);

11 
bŒfs_dœ_™em
 *
bŒfs_lookup_dœ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

12 
bŒfs_roÙ
 *
roÙ
,

13 
bŒfs_·th
 *
·th
, 
u64
 
dœ
,

14 cÚ¡ 
fsüy±_¡r
 *
Çme
, 
mod
);

15 
bŒfs_dœ_™em
 *
bŒfs_lookup_dœ_šdex_™em
(

16 
bŒfs_Œªs_hªdË
 *
Œªs
,

17 
bŒfs_roÙ
 *
roÙ
,

18 
bŒfs_·th
 *
·th
, 
u64
 
dœ
,

19 
u64
 
šdex
, cÚ¡ 
fsüy±_¡r
 *
Çme
, 
mod
);

20 
bŒfs_dœ_™em
 *
bŒfs_£¬ch_dœ_šdex_™em
(
bŒfs_roÙ
 *
roÙ
,

21 
bŒfs_·th
 *
·th
, 
u64
 
dœid
,

22 cÚ¡ 
fsüy±_¡r
 *
Çme
);

23 
bŒfs_d–‘e_Úe_dœ_Çme
(
bŒfs_Œªs_hªdË
 *
Œªs
,

24 
bŒfs_roÙ
 *
roÙ
,

25 
bŒfs_·th
 *
·th
,

26 
bŒfs_dœ_™em
 *
di
);

27 
bŒfs_š£¹_x©Œ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

28 
bŒfs_roÙ
 *
roÙ
,

29 
bŒfs_·th
 *
·th
, 
u64
 
objeùid
,

30 cÚ¡ *
Çme
, 
u16
 
Çme_Ën
,

31 cÚ¡ *
d©a
, 
u16
 
d©a_Ën
);

32 
bŒfs_dœ_™em
 *
bŒfs_lookup_x©Œ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

33 
bŒfs_roÙ
 *
roÙ
,

34 
bŒfs_·th
 *
·th
, 
u64
 
dœ
,

35 cÚ¡ *
Çme
, 
u16
 
Çme_Ën
,

36 
mod
);

37 
bŒfs_dœ_™em
 *
bŒfs_m©ch_dœ_™em_Çme
(
bŒfs_fs_šfo
 *
fs_šfo
,

38 
bŒfs_·th
 *
·th
,

39 cÚ¡ *
Çme
,

40 
Çme_Ën
);

	@discard.c

3 
	~<lšux/jiff›s.h
>

4 
	~<lšux/k”Ãl.h
>

5 
	~<lšux/ktime.h
>

6 
	~<lšux/li¡.h
>

7 
	~<lšux/m©h64.h
>

8 
	~<lšux/sizes.h
>

9 
	~<lšux/wÜkqueue.h
>

10 
	~"ù»e.h
"

11 
	~"block-group.h
"

12 
	~"disÿrd.h
"

13 
	~"ä“-¥aû-ÿche.h
"

14 
	~"fs.h
"

56 
	#BTRFS_DISCARD_DELAY
 (120ULL * 
NSEC_PER_SEC
)

	)

57 
	#BTRFS_DISCARD_UNUSED_DELAY
 (10ULL * 
NSEC_PER_SEC
)

	)

59 
	#BTRFS_DISCARD_MIN_DELAY_MSEC
 (1UL)

	)

60 
	#BTRFS_DISCARD_MAX_DELAY_MSEC
 (1000UL)

	)

61 
	#BTRFS_DISCARD_MAX_IOPS
 (1000U)

	)

64 
	gdisÿrd_mšËn
[
BTRFS_NR_DISCARD_LISTS
] = {

66 
BTRFS_ASYNC_DISCARD_MAX_FILTER
,

67 
BTRFS_ASYNC_DISCARD_MIN_FILTER


70 
li¡_h—d
 *
	$g‘_disÿrd_li¡
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
,

71 
bŒfs_block_group
 *
block_group
)

73  &
disÿrd_ùl
->
disÿrd_li¡
[
block_group
->
disÿrd_šdex
];

74 
	}
}

83 
boŞ
 
	$bŒfs_run_disÿrd_wÜk
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
)

85 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`cÚš”_of
(
disÿrd_ùl
,

86 
bŒfs_fs_šfo
,

87 
disÿrd_ùl
);

89  (!(
fs_šfo
->
sb
->
s_æags
 & 
SB_RDONLY
) &&

90 
	`‹¡_b™
(
BTRFS_FS_DISCARD_RUNNING
, &
fs_šfo
->
æags
));

91 
	}
}

93 
	$__add_to_disÿrd_li¡
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
,

94 
bŒfs_block_group
 *
block_group
)

96 
	`lockd•_as£¹_h–d
(&
disÿrd_ùl
->
lock
);

97 ià(!
	`bŒfs_run_disÿrd_wÜk
(
disÿrd_ùl
))

100 ià(
	`li¡_em±y
(&
block_group
->
disÿrd_li¡
) ||

101 
block_group
->
disÿrd_šdex
 =ğ
BTRFS_DISCARD_INDEX_UNUSED
) {

102 ià(
block_group
->
disÿrd_šdex
 =ğ
BTRFS_DISCARD_INDEX_UNUSED
)

103 
block_group
->
disÿrd_šdex
 = 
BTRFS_DISCARD_INDEX_START
;

104 
block_group
->
disÿrd_–igibË_time
 = (
	`ktime_g‘_ns
() +

105 
BTRFS_DISCARD_DELAY
);

106 
block_group
->
disÿrd_¡©e
 = 
BTRFS_DISCARD_RESET_CURSOR
;

108 ià(
	`li¡_em±y
(&
block_group
->
disÿrd_li¡
))

109 
	`bŒfs_g‘_block_group
(
block_group
);

111 
	`li¡_move_
(&
block_group
->
disÿrd_li¡
,

112 
	`g‘_disÿrd_li¡
(
disÿrd_ùl
, 
block_group
));

113 
	}
}

115 
	$add_to_disÿrd_li¡
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
,

116 
bŒfs_block_group
 *
block_group
)

118 ià(!
	`bŒfs_is_block_group_d©a_Úly
(
block_group
))

121 
	`¥š_lock
(&
disÿrd_ùl
->
lock
);

122 
	`__add_to_disÿrd_li¡
(
disÿrd_ùl
, 
block_group
);

123 
	`¥š_uÆock
(&
disÿrd_ùl
->
lock
);

124 
	}
}

126 
	$add_to_disÿrd_unu£d_li¡
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
,

127 
bŒfs_block_group
 *
block_group
)

129 
boŞ
 
queued
;

131 
	`¥š_lock
(&
disÿrd_ùl
->
lock
);

133 
queued
 = !
	`li¡_em±y
(&
block_group
->
disÿrd_li¡
);

135 ià(!
	`bŒfs_run_disÿrd_wÜk
(
disÿrd_ùl
)) {

136 
	`¥š_uÆock
(&
disÿrd_ùl
->
lock
);

140 
	`li¡_d–_š™
(&
block_group
->
disÿrd_li¡
);

142 
block_group
->
disÿrd_šdex
 = 
BTRFS_DISCARD_INDEX_UNUSED
;

143 
block_group
->
disÿrd_–igibË_time
 = (
	`ktime_g‘_ns
() +

144 
BTRFS_DISCARD_UNUSED_DELAY
);

145 
block_group
->
disÿrd_¡©e
 = 
BTRFS_DISCARD_RESET_CURSOR
;

146 ià(!
queued
)

147 
	`bŒfs_g‘_block_group
(
block_group
);

148 
	`li¡_add_
(&
block_group
->
disÿrd_li¡
,

149 &
disÿrd_ùl
->
disÿrd_li¡
[
BTRFS_DISCARD_INDEX_UNUSED
]);

151 
	`¥š_uÆock
(&
disÿrd_ùl
->
lock
);

152 
	}
}

154 
boŞ
 
	$»move_äom_disÿrd_li¡
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
,

155 
bŒfs_block_group
 *
block_group
)

157 
boŞ
 
ruÂšg
 = 
çl£
;

158 
boŞ
 
queued
 = 
çl£
;

160 
	`¥š_lock
(&
disÿrd_ùl
->
lock
);

162 ià(
block_group
 =ğ
disÿrd_ùl
->block_group) {

163 
ruÂšg
 = 
Œue
;

164 
disÿrd_ùl
->
block_group
 = 
NULL
;

167 
block_group
->
disÿrd_–igibË_time
 = 0;

168 
queued
 = !
	`li¡_em±y
(&
block_group
->
disÿrd_li¡
);

169 
	`li¡_d–_š™
(&
block_group
->
disÿrd_li¡
);

176 ià(
queued
 && !
ruÂšg
)

177 
	`bŒfs_put_block_group
(
block_group
);

179 
	`¥š_uÆock
(&
disÿrd_ùl
->
lock
);

181  
ruÂšg
;

182 
	}
}

193 
bŒfs_block_group
 *
	$fšd_Ãxt_block_group
(

194 
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
,

195 
u64
 
now
)

197 
bŒfs_block_group
 *
»t_block_group
 = 
NULL
, *
block_group
;

198 
i
;

200 
i
 = 0; i < 
BTRFS_NR_DISCARD_LISTS
; i++) {

201 
li¡_h—d
 *
disÿrd_li¡
 = &
disÿrd_ùl
->disÿrd_li¡[
i
];

203 ià(!
	`li¡_em±y
(
disÿrd_li¡
)) {

204 
block_group
 = 
	`li¡_fœ¡_’Œy
(
disÿrd_li¡
,

205 
bŒfs_block_group
,

206 
disÿrd_li¡
);

208 ià(!
»t_block_group
)

209 
»t_block_group
 = 
block_group
;

211 ià(
»t_block_group
->
disÿrd_–igibË_time
 < 
now
)

214 ià(
»t_block_group
->
disÿrd_–igibË_time
 >

215 
block_group
->
disÿrd_–igibË_time
)

216 
»t_block_group
 = 
block_group
;

220  
»t_block_group
;

221 
	}
}

237 
bŒfs_block_group
 *
	$³ek_disÿrd_li¡
(

238 
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
,

239 
bŒfs_disÿrd_¡©e
 *
disÿrd_¡©e
,

240 *
disÿrd_šdex
, 
u64
 
now
)

242 
bŒfs_block_group
 *
block_group
;

244 
	`¥š_lock
(&
disÿrd_ùl
->
lock
);

245 
agaš
:

246 
block_group
 = 
	`fšd_Ãxt_block_group
(
disÿrd_ùl
, 
now
);

248 ià(
block_group
 && 
now
 >ğblock_group->
disÿrd_–igibË_time
) {

249 ià(
block_group
->
disÿrd_šdex
 =ğ
BTRFS_DISCARD_INDEX_UNUSED
 &&

250 
block_group
->
u£d
 != 0) {

251 ià(
	`bŒfs_is_block_group_d©a_Úly
(
block_group
)) {

252 
	`__add_to_disÿrd_li¡
(
disÿrd_ùl
, 
block_group
);

254 
	`li¡_d–_š™
(&
block_group
->
disÿrd_li¡
);

255 
	`bŒfs_put_block_group
(
block_group
);

257 
agaš
;

259 ià(
block_group
->
disÿrd_¡©e
 =ğ
BTRFS_DISCARD_RESET_CURSOR
) {

260 
block_group
->
disÿrd_cursÜ
 = block_group->
¡¬t
;

261 
block_group
->
disÿrd_¡©e
 = 
BTRFS_DISCARD_EXTENTS
;

263 
disÿrd_ùl
->
block_group
 = block_group;

265 ià(
block_group
) {

266 *
disÿrd_¡©e
 = 
block_group
->discard_state;

267 *
disÿrd_šdex
 = 
block_group
->discard_index;

269 
	`¥š_uÆock
(&
disÿrd_ùl
->
lock
);

271  
block_group
;

272 
	}
}

285 
	$bŒfs_disÿrd_check_f‹r
(
bŒfs_block_group
 *
block_group
,

286 
u64
 
by‹s
)

288 
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
;

290 ià(!
block_group
 ||

291 !
	`bŒfs_‹¡_İt
(
block_group
->
fs_šfo
, 
DISCARD_ASYNC
))

294 
disÿrd_ùl
 = &
block_group
->
fs_šfo
->discard_ctl;

296 ià(
block_group
->
disÿrd_šdex
 > 
BTRFS_DISCARD_INDEX_START
 &&

297 
by‹s
 >ğ
disÿrd_mšËn
[
block_group
->
disÿrd_šdex
 - 1]) {

298 
i
;

300 
	`»move_äom_disÿrd_li¡
(
disÿrd_ùl
, 
block_group
);

302 
i
 = 
BTRFS_DISCARD_INDEX_START
; i < 
BTRFS_NR_DISCARD_LISTS
;

303 
i
++) {

304 ià(
by‹s
 >ğ
disÿrd_mšËn
[
i
]) {

305 
block_group
->
disÿrd_šdex
 = 
i
;

306 
	`add_to_disÿrd_li¡
(
disÿrd_ùl
, 
block_group
);

311 
	}
}

322 
	$bŒfs_upd©e_disÿrd_šdex
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
,

323 
bŒfs_block_group
 *
block_group
)

325 
block_group
->
disÿrd_šdex
++;

326 ià(
block_group
->
disÿrd_šdex
 =ğ
BTRFS_NR_DISCARD_LISTS
) {

327 
block_group
->
disÿrd_šdex
 = 1;

331 
	`add_to_disÿrd_li¡
(
disÿrd_ùl
, 
block_group
);

332 
	}
}

343 
	$bŒfs_disÿrd_ÿnûl_wÜk
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
,

344 
bŒfs_block_group
 *
block_group
)

346 ià(
	`»move_äom_disÿrd_li¡
(
disÿrd_ùl
, 
block_group
)) {

347 
	`ÿnûl_d–ayed_wÜk_sync
(&
disÿrd_ùl
->
wÜk
);

348 
	`bŒfs_disÿrd_scheduË_wÜk
(
disÿrd_ùl
, 
Œue
);

350 
	}
}

360 
	$bŒfs_disÿrd_queue_wÜk
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
,

361 
bŒfs_block_group
 *
block_group
)

363 ià(!
block_group
 || !
	`bŒfs_‹¡_İt
(block_group->
fs_šfo
, 
DISCARD_ASYNC
))

366 ià(
block_group
->
u£d
 == 0)

367 
	`add_to_disÿrd_unu£d_li¡
(
disÿrd_ùl
, 
block_group
);

369 
	`add_to_disÿrd_li¡
(
disÿrd_ùl
, 
block_group
);

371 ià(!
	`d–ayed_wÜk_³ndšg
(&
disÿrd_ùl
->
wÜk
))

372 
	`bŒfs_disÿrd_scheduË_wÜk
(
disÿrd_ùl
, 
çl£
);

373 
	}
}

375 
	$__bŒfs_disÿrd_scheduË_wÜk
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
,

376 
u64
 
now
, 
boŞ
 
ov”ride
)

378 
bŒfs_block_group
 *
block_group
;

380 ià(!
	`bŒfs_run_disÿrd_wÜk
(
disÿrd_ùl
))

382 ià(!
ov”ride
 && 
	`d–ayed_wÜk_³ndšg
(&
disÿrd_ùl
->
wÜk
))

385 
block_group
 = 
	`fšd_Ãxt_block_group
(
disÿrd_ùl
, 
now
);

386 ià(
block_group
) {

387 
u64
 
d–ay
 = 
disÿrd_ùl
->
d–ay_ms
 * 
NSEC_PER_MSEC
;

388 
u32
 
kbps_lim™
 = 
	`READ_ONCE
(
disÿrd_ùl
->kbps_limit);

395 ià(
kbps_lim™
 && 
disÿrd_ùl
->
´ev_disÿrd
) {

396 
u64
 
bps_lim™
 = ((u64)
kbps_lim™
è* 
SZ_1K
;

397 
u64
 
bps_d–ay
 = 
	`div64_u64
(
disÿrd_ùl
->
´ev_disÿrd
 *

398 
NSEC_PER_SEC
, 
bps_lim™
);

400 
d–ay
 = 
	`max
(d–ay, 
bps_d–ay
);

407 ià(
now
 < 
block_group
->
disÿrd_–igibË_time
) {

408 
u64
 
bg_timeout
 = 
block_group
->
disÿrd_–igibË_time
 - 
now
;

410 
d–ay
 = 
	`max
(d–ay, 
bg_timeout
);

413 ià(
ov”ride
 && 
disÿrd_ùl
->
´ev_disÿrd
) {

414 
u64
 
–­£d
 = 
now
 - 
disÿrd_ùl
->
´ev_disÿrd_time
;

416 ià(
d–ay
 > 
–­£d
)

417 
d–ay
 -ğ
–­£d
;

419 
d–ay
 = 0;

422 
	`mod_d–ayed_wÜk
(
disÿrd_ùl
->
disÿrd_wÜk”s
,

423 &
disÿrd_ùl
->
wÜk
, 
	`n£cs_to_jiff›s
(
d–ay
));

425 
	}
}

437 
	$bŒfs_disÿrd_scheduË_wÜk
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
,

438 
boŞ
 
ov”ride
)

440 cÚ¡ 
u64
 
now
 = 
	`ktime_g‘_ns
();

442 
	`¥š_lock
(&
disÿrd_ùl
->
lock
);

443 
	`__bŒfs_disÿrd_scheduË_wÜk
(
disÿrd_ùl
, 
now
, 
ov”ride
);

444 
	`¥š_uÆock
(&
disÿrd_ùl
->
lock
);

445 
	}
}

458 
	$bŒfs_fšish_disÿrd_·ss
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
,

459 
bŒfs_block_group
 *
block_group
)

461 
	`»move_äom_disÿrd_li¡
(
disÿrd_ùl
, 
block_group
);

463 ià(
block_group
->
u£d
 == 0) {

464 ià(
	`bŒfs_is_ä“_¥aû_Œimmed
(
block_group
))

465 
	`bŒfs_m¬k_bg_unu£d
(
block_group
);

467 
	`add_to_disÿrd_unu£d_li¡
(
disÿrd_ùl
, 
block_group
);

469 
	`bŒfs_upd©e_disÿrd_šdex
(
disÿrd_ùl
, 
block_group
);

471 
	}
}

482 
	$bŒfs_disÿrd_wÜkâ
(
wÜk_¡ruù
 *
wÜk
)

484 
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
;

485 
bŒfs_block_group
 *
block_group
;

486 
bŒfs_disÿrd_¡©e
 
disÿrd_¡©e
;

487 
disÿrd_šdex
 = 0;

488 
u64
 
Œimmed
 = 0;

489 
u64
 
mšËn
 = 0;

490 
u64
 
now
 = 
	`ktime_g‘_ns
();

492 
disÿrd_ùl
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_disÿrd_ùl
, work.work);

494 
block_group
 = 
	`³ek_disÿrd_li¡
(
disÿrd_ùl
, &
disÿrd_¡©e
,

495 &
disÿrd_šdex
, 
now
);

496 ià(!
block_group
 || !
	`bŒfs_run_disÿrd_wÜk
(
disÿrd_ùl
))

498 ià(
now
 < 
block_group
->
disÿrd_–igibË_time
) {

499 
	`bŒfs_disÿrd_scheduË_wÜk
(
disÿrd_ùl
, 
çl£
);

504 
mšËn
 = 
disÿrd_mšËn
[
disÿrd_šdex
];

506 ià(
disÿrd_¡©e
 =ğ
BTRFS_DISCARD_BITMAPS
) {

507 
u64
 
maxËn
 = 0;

515 ià(
disÿrd_šdex
 !ğ
BTRFS_DISCARD_INDEX_UNUSED
)

516 
maxËn
 = 
disÿrd_mšËn
[
disÿrd_šdex
 - 1];

518 
	`bŒfs_Œim_block_group_b™m­s
(
block_group
, &
Œimmed
,

519 
block_group
->
disÿrd_cursÜ
,

520 
	`bŒfs_block_group_’d
(
block_group
),

521 
mšËn
, 
maxËn
, 
Œue
);

522 
disÿrd_ùl
->
disÿrd_b™m­_by‹s
 +ğ
Œimmed
;

524 
	`bŒfs_Œim_block_group_ex‹Ás
(
block_group
, &
Œimmed
,

525 
block_group
->
disÿrd_cursÜ
,

526 
	`bŒfs_block_group_’d
(
block_group
),

527 
mšËn
, 
Œue
);

528 
disÿrd_ùl
->
disÿrd_ex‹Á_by‹s
 +ğ
Œimmed
;

532 ià(
block_group
->
disÿrd_cursÜ
 >ğ
	`bŒfs_block_group_’d
(block_group)) {

533 ià(
disÿrd_¡©e
 =ğ
BTRFS_DISCARD_BITMAPS
) {

534 
	`bŒfs_fšish_disÿrd_·ss
(
disÿrd_ùl
, 
block_group
);

536 
block_group
->
disÿrd_cursÜ
 = block_group->
¡¬t
;

537 
	`¥š_lock
(&
disÿrd_ùl
->
lock
);

538 ià(
block_group
->
disÿrd_¡©e
 !=

539 
BTRFS_DISCARD_RESET_CURSOR
)

540 
block_group
->
disÿrd_¡©e
 =

541 
BTRFS_DISCARD_BITMAPS
;

542 
	`¥š_uÆock
(&
disÿrd_ùl
->
lock
);

546 
now
 = 
	`ktime_g‘_ns
();

547 
	`¥š_lock
(&
disÿrd_ùl
->
lock
);

548 
disÿrd_ùl
->
´ev_disÿrd
 = 
Œimmed
;

549 
disÿrd_ùl
->
´ev_disÿrd_time
 = 
now
;

557 ià(
disÿrd_ùl
->
block_group
 =ğ
NULL
)

558 
	`bŒfs_put_block_group
(
block_group
);

559 
disÿrd_ùl
->
block_group
 = 
NULL
;

560 
	`__bŒfs_disÿrd_scheduË_wÜk
(
disÿrd_ùl
, 
now
, 
çl£
);

561 
	`¥š_uÆock
(&
disÿrd_ùl
->
lock
);

562 
	}
}

573 
	$bŒfs_disÿrd_ÿlc_d–ay
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
)

575 
s32
 
disÿrdabË_ex‹Ás
;

576 
s64
 
disÿrdabË_by‹s
;

577 
u32
 
iİs_lim™
;

578 
mš_d–ay
 = 
BTRFS_DISCARD_MIN_DELAY_MSEC
;

579 
d–ay
;

581 
disÿrdabË_ex‹Ás
 = 
	`©omic_»ad
(&
disÿrd_ùl
->discardable_extents);

582 ià(!
disÿrdabË_ex‹Ás
)

585 
	`¥š_lock
(&
disÿrd_ùl
->
lock
);

594 ià(
disÿrdabË_ex‹Ás
 < 0)

595 
	`©omic_add
(-
disÿrdabË_ex‹Ás
,

596 &
disÿrd_ùl
->
disÿrdabË_ex‹Ás
);

598 
disÿrdabË_by‹s
 = 
	`©omic64_»ad
(&
disÿrd_ùl
->discardable_bytes);

599 ià(
disÿrdabË_by‹s
 < 0)

600 
	`©omic64_add
(-
disÿrdabË_by‹s
,

601 &
disÿrd_ùl
->
disÿrdabË_by‹s
);

603 ià(
disÿrdabË_ex‹Ás
 <= 0) {

604 
	`¥š_uÆock
(&
disÿrd_ùl
->
lock
);

608 
iİs_lim™
 = 
	`READ_ONCE
(
disÿrd_ùl
->iops_limit);

610 ià(
iİs_lim™
) {

611 
d–ay
 = 
MSEC_PER_SEC
 / 
iİs_lim™
;

617 
d–ay
 = 0;

618 
mš_d–ay
 = 0;

621 
d–ay
 = 
	`şamp
(d–ay, 
mš_d–ay
, 
BTRFS_DISCARD_MAX_DELAY_MSEC
);

622 
disÿrd_ùl
->
d–ay_ms
 = 
d–ay
;

624 
	`¥š_uÆock
(&
disÿrd_ùl
->
lock
);

625 
	}
}

636 
	$bŒfs_disÿrd_upd©e_disÿrdabË
(
bŒfs_block_group
 *
block_group
)

638 
bŒfs_ä“_¥aû_ùl
 *
ùl
;

639 
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
;

640 
s32
 
ex‹Ás_d–
;

641 
s64
 
by‹s_d–
;

643 ià(!
block_group
 ||

644 !
	`bŒfs_‹¡_İt
(
block_group
->
fs_šfo
, 
DISCARD_ASYNC
) ||

645 !
	`bŒfs_is_block_group_d©a_Úly
(
block_group
))

648 
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

649 
disÿrd_ùl
 = &
block_group
->
fs_šfo
->discard_ctl;

651 
	`lockd•_as£¹_h–d
(&
ùl
->
Œ“_lock
);

652 
ex‹Ás_d–
 = 
ùl
->
disÿrdabË_ex‹Ás
[
BTRFS_STAT_CURR
] -

653 
ùl
->
disÿrdabË_ex‹Ás
[
BTRFS_STAT_PREV
];

654 ià(
ex‹Ás_d–
) {

655 
	`©omic_add
(
ex‹Ás_d–
, &
disÿrd_ùl
->
disÿrdabË_ex‹Ás
);

656 
ùl
->
disÿrdabË_ex‹Ás
[
BTRFS_STAT_PREV
] =

657 
ùl
->
disÿrdabË_ex‹Ás
[
BTRFS_STAT_CURR
];

660 
by‹s_d–
 = 
ùl
->
disÿrdabË_by‹s
[
BTRFS_STAT_CURR
] -

661 
ùl
->
disÿrdabË_by‹s
[
BTRFS_STAT_PREV
];

662 ià(
by‹s_d–
) {

663 
	`©omic64_add
(
by‹s_d–
, &
disÿrd_ùl
->
disÿrdabË_by‹s
);

664 
ùl
->
disÿrdabË_by‹s
[
BTRFS_STAT_PREV
] =

665 
ùl
->
disÿrdabË_by‹s
[
BTRFS_STAT_CURR
];

667 
	}
}

680 
	$bŒfs_disÿrd_puÁ_unu£d_bgs_li¡
(
bŒfs_fs_šfo
 *
fs_šfo
)

682 
bŒfs_block_group
 *
block_group
, *
Ãxt
;

684 
	`¥š_lock
(&
fs_šfo
->
unu£d_bgs_lock
);

686 
	`li¡_fÜ_—ch_’Œy_§ã
(
block_group
, 
Ãxt
, &
fs_šfo
->
unu£d_bgs
,

687 
bg_li¡
) {

688 
	`li¡_d–_š™
(&
block_group
->
bg_li¡
);

689 
	`bŒfs_disÿrd_queue_wÜk
(&
fs_šfo
->
disÿrd_ùl
, 
block_group
);

694 
	`bŒfs_put_block_group
(
block_group
);

696 
	`¥š_uÆock
(&
fs_šfo
->
unu£d_bgs_lock
);

697 
	}
}

710 
	$bŒfs_disÿrd_purge_li¡
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
)

712 
bŒfs_block_group
 *
block_group
, *
Ãxt
;

713 
i
;

715 
	`¥š_lock
(&
disÿrd_ùl
->
lock
);

716 
i
 = 0; i < 
BTRFS_NR_DISCARD_LISTS
; i++) {

717 
	`li¡_fÜ_—ch_’Œy_§ã
(
block_group
, 
Ãxt
,

718 &
disÿrd_ùl
->
disÿrd_li¡
[
i
],

719 
disÿrd_li¡
) {

720 
	`li¡_d–_š™
(&
block_group
->
disÿrd_li¡
);

721 
	`¥š_uÆock
(&
disÿrd_ùl
->
lock
);

722 ià(
block_group
->
u£d
 == 0)

723 
	`bŒfs_m¬k_bg_unu£d
(
block_group
);

724 
	`¥š_lock
(&
disÿrd_ùl
->
lock
);

725 
	`bŒfs_put_block_group
(
block_group
);

728 
	`¥š_uÆock
(&
disÿrd_ùl
->
lock
);

729 
	}
}

731 
	$bŒfs_disÿrd_»sume
(
bŒfs_fs_šfo
 *
fs_šfo
)

733 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DISCARD_ASYNC
)) {

734 
	`bŒfs_disÿrd_ş—nup
(
fs_šfo
);

738 
	`bŒfs_disÿrd_puÁ_unu£d_bgs_li¡
(
fs_šfo
);

740 
	`£t_b™
(
BTRFS_FS_DISCARD_RUNNING
, &
fs_šfo
->
æags
);

741 
	}
}

743 
	$bŒfs_disÿrd_¡İ
(
bŒfs_fs_šfo
 *
fs_šfo
)

745 
	`ş—r_b™
(
BTRFS_FS_DISCARD_RUNNING
, &
fs_šfo
->
æags
);

746 
	}
}

748 
	$bŒfs_disÿrd_š™
(
bŒfs_fs_šfo
 *
fs_šfo
)

750 
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
 = &
fs_šfo
->discard_ctl;

751 
i
;

753 
	`¥š_lock_š™
(&
disÿrd_ùl
->
lock
);

754 
	`INIT_DELAYED_WORK
(&
disÿrd_ùl
->
wÜk
, 
bŒfs_disÿrd_wÜkâ
);

756 
i
 = 0; i < 
BTRFS_NR_DISCARD_LISTS
; i++)

757 
	`INIT_LIST_HEAD
(&
disÿrd_ùl
->
disÿrd_li¡
[
i
]);

759 
disÿrd_ùl
->
´ev_disÿrd
 = 0;

760 
disÿrd_ùl
->
´ev_disÿrd_time
 = 0;

761 
	`©omic_£t
(&
disÿrd_ùl
->
disÿrdabË_ex‹Ás
, 0);

762 
	`©omic64_£t
(&
disÿrd_ùl
->
disÿrdabË_by‹s
, 0);

763 
disÿrd_ùl
->
max_disÿrd_size
 = 
BTRFS_ASYNC_DISCARD_DEFAULT_MAX_SIZE
;

764 
disÿrd_ùl
->
d–ay_ms
 = 
BTRFS_DISCARD_MAX_DELAY_MSEC
;

765 
disÿrd_ùl
->
iİs_lim™
 = 
BTRFS_DISCARD_MAX_IOPS
;

766 
disÿrd_ùl
->
kbps_lim™
 = 0;

767 
disÿrd_ùl
->
disÿrd_ex‹Á_by‹s
 = 0;

768 
disÿrd_ùl
->
disÿrd_b™m­_by‹s
 = 0;

769 
	`©omic64_£t
(&
disÿrd_ùl
->
disÿrd_by‹s_§ved
, 0);

770 
	}
}

772 
	$bŒfs_disÿrd_ş—nup
(
bŒfs_fs_šfo
 *
fs_šfo
)

774 
	`bŒfs_disÿrd_¡İ
(
fs_šfo
);

775 
	`ÿnûl_d–ayed_wÜk_sync
(&
fs_šfo
->
disÿrd_ùl
.
wÜk
);

776 
	`bŒfs_disÿrd_purge_li¡
(&
fs_šfo
->
disÿrd_ùl
);

777 
	}
}

	@discard.h

3 #iâdeà
BTRFS_DISCARD_H


4 
	#BTRFS_DISCARD_H


	)

6 
	~<lšux/sizes.h
>

8 
	gbŒfs_fs_šfo
;

9 
	gbŒfs_disÿrd_ùl
;

10 
	gbŒfs_block_group
;

13 
	#BTRFS_ASYNC_DISCARD_DEFAULT_MAX_SIZE
 (
SZ_64M
)

	)

14 
	#BTRFS_ASYNC_DISCARD_MAX_FILTER
 (
SZ_1M
)

	)

15 
	#BTRFS_ASYNC_DISCARD_MIN_FILTER
 (
SZ_32K
)

	)

18 
bŒfs_disÿrd_check_f‹r
(
bŒfs_block_group
 *
block_group
, 
u64
 
by‹s
);

21 
bŒfs_disÿrd_ÿnûl_wÜk
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
,

22 
bŒfs_block_group
 *
block_group
);

23 
bŒfs_disÿrd_queue_wÜk
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
,

24 
bŒfs_block_group
 *
block_group
);

25 
bŒfs_disÿrd_scheduË_wÜk
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
,

26 
boŞ
 
ov”ride
);

29 
bŒfs_disÿrd_ÿlc_d–ay
(
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
);

30 
bŒfs_disÿrd_upd©e_disÿrdabË
(
bŒfs_block_group
 *
block_group
);

33 
bŒfs_disÿrd_puÁ_unu£d_bgs_li¡
(
bŒfs_fs_šfo
 *
fs_šfo
);

34 
bŒfs_disÿrd_»sume
(
bŒfs_fs_šfo
 *
fs_šfo
);

35 
bŒfs_disÿrd_¡İ
(
bŒfs_fs_šfo
 *
fs_šfo
);

36 
bŒfs_disÿrd_š™
(
bŒfs_fs_šfo
 *
fs_šfo
);

37 
bŒfs_disÿrd_ş—nup
(
bŒfs_fs_šfo
 *
fs_šfo
);

	@disk-io.c

6 
	~<lšux/fs.h
>

7 
	~<lšux/blkdev.h
>

8 
	~<lšux/¿dix-Œ“.h
>

9 
	~<lšux/wr™eback.h
>

10 
	~<lšux/wÜkqueue.h
>

11 
	~<lšux/kth»ad.h
>

12 
	~<lšux/¦ab.h
>

13 
	~<lšux/mig¿‹.h
>

14 
	~<lšux/¿‹lim™.h
>

15 
	~<lšux/uuid.h
>

16 
	~<lšux/£m­hÜe.h
>

17 
	~<lšux/”rÜ-šjeùiÚ.h
>

18 
	~<lšux/üc32c.h
>

19 
	~<lšux/sched/mm.h
>

20 
	~<asm/uÇligÃd.h
>

21 
	~<üy±o/hash.h
>

22 
	~"ù»e.h
"

23 
	~"disk-io.h
"

24 
	~"Œª§ùiÚ.h
"

25 
	~"bŒfs_šode.h
"

26 
	~"bio.h
"

27 
	~"´št-Œ“.h
"

28 
	~"lockšg.h
"

29 
	~"Œ“-log.h
"

30 
	~"ä“-¥aû-ÿche.h
"

31 
	~"ä“-¥aû-Œ“.h
"

32 
	~"check-š‹gr™y.h
"

33 
	~"rcu-¡ršg.h
"

34 
	~"dev-»¶aû.h
"

35 
	~"¿id56.h
"

36 
	~"sysfs.h
"

37 
	~"qgroup.h
"

38 
	~"com´essiÚ.h
"

39 
	~"Œ“-check”.h
"

40 
	~"»f-v”ify.h
"

41 
	~"block-group.h
"

42 
	~"disÿrd.h
"

43 
	~"¥aû-šfo.h
"

44 
	~"zÚed.h
"

45 
	~"sub·ge.h
"

46 
	~"fs.h
"

47 
	~"acûssÜs.h
"

48 
	~"ex‹Á-Œ“.h
"

49 
	~"roÙ-Œ“.h
"

50 
	~"deäag.h
"

51 
	~"uuid-Œ“.h
"

52 
	~"»loÿtiÚ.h
"

53 
	~"süub.h
"

54 
	~"su³r.h
"

56 
	#BTRFS_SUPER_FLAG_SUPP
 (
BTRFS_HEADER_FLAG_WRITTEN
 |\

57 
BTRFS_HEADER_FLAG_RELOC
 |\

58 
BTRFS_SUPER_FLAG_ERROR
 |\

59 
BTRFS_SUPER_FLAG_SEEDING
 |\

60 
BTRFS_SUPER_FLAG_METADUMP
 |\

61 
BTRFS_SUPER_FLAG_METADUMP_V2
)

	)

63 
bŒfs_ş—nup_Œª§ùiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
);

64 
bŒfs_”rÜ_comm™_su³r
(
bŒfs_fs_šfo
 *
fs_šfo
);

66 
	$bŒfs_ä“_csum_hash
(
bŒfs_fs_šfo
 *
fs_šfo
)

68 ià(
fs_šfo
->
csum_shash
)

69 
	`üy±o_ä“_shash
(
fs_šfo
->
csum_shash
);

70 
	}
}

75 
	$csum_Œ“_block
(
ex‹Á_bufãr
 *
buf
, 
u8
 *
»suÉ
)

77 
bŒfs_fs_šfo
 *
fs_šfo
 = 
buf
->fs_info;

78 cÚ¡ 
num_·ges
 = 
	`num_ex‹Á_·ges
(
buf
);

79 cÚ¡ 
fœ¡_·ge_·¹
 = 
	`mš_t
(
u32
, 
PAGE_SIZE
, 
fs_šfo
->
nodesize
);

80 
	`SHASH_DESC_ON_STACK
(
shash
, 
fs_šfo
->
csum_shash
);

81 *
kaddr
;

82 
i
;

84 
shash
->
tfm
 = 
fs_šfo
->
csum_shash
;

85 
	`üy±o_shash_š™
(
shash
);

86 
kaddr
 = 
	`·ge_add»ss
(
buf
->
·ges
[0]è+ 
	`off£t_š_·ge
(buf->
¡¬t
);

87 
	`üy±o_shash_upd©e
(
shash
, 
kaddr
 + 
BTRFS_CSUM_SIZE
,

88 
fœ¡_·ge_·¹
 - 
BTRFS_CSUM_SIZE
);

90 
i
 = 1; i < 
num_·ges
 && 
INLINE_EXTENT_BUFFER_PAGES
 > 1; i++) {

91 
kaddr
 = 
	`·ge_add»ss
(
buf
->
·ges
[
i
]);

92 
	`üy±o_shash_upd©e
(
shash
, 
kaddr
, 
PAGE_SIZE
);

94 
	`mem£t
(
»suÉ
, 0, 
BTRFS_CSUM_SIZE
);

95 
	`üy±o_shash_fš®
(
shash
, 
»suÉ
);

96 
	}
}

104 
	$bŒfs_bufãr_u±od©e
(
ex‹Á_bufãr
 *
eb
, 
u64
 
·»Á_Œªsid
, 
©omic
)

106 ià(!
	`ex‹Á_bufãr_u±od©e
(
eb
))

109 ià(!
·»Á_Œªsid
 || 
	`bŒfs_h—d”_g’”©iÚ
(
eb
) ==…arent_transid)

112 ià(
©omic
)

113  -
EAGAIN
;

115 ià(!
	`ex‹Á_bufãr_u±od©e
(
eb
) ||

116 
	`bŒfs_h—d”_g’”©iÚ
(
eb
è!ğ
·»Á_Œªsid
) {

117 
	`bŒfs_”r_¾
(
eb
->
fs_šfo
,

119 
eb
->
¡¬t
,ƒb->
»ad_mœrÜ
,

120 
·»Á_Œªsid
, 
	`bŒfs_h—d”_g’”©iÚ
(
eb
));

121 
	`ş—r_ex‹Á_bufãr_u±od©e
(
eb
);

125 
	}
}

127 
boŞ
 
	$bŒfs_suµÜ‹d_su³r_csum
(
u16
 
csum_ty³
)

129 
csum_ty³
) {

130 
BTRFS_CSUM_TYPE_CRC32
:

131 
BTRFS_CSUM_TYPE_XXHASH
:

132 
BTRFS_CSUM_TYPE_SHA256
:

133 
BTRFS_CSUM_TYPE_BLAKE2
:

134  
Œue
;

136  
çl£
;

138 
	}
}

144 
	$bŒfs_check_su³r_csum
(
bŒfs_fs_šfo
 *
fs_šfo
,

145 cÚ¡ 
bŒfs_su³r_block
 *
disk_sb
)

147 
»suÉ
[
BTRFS_CSUM_SIZE
];

148 
	`SHASH_DESC_ON_STACK
(
shash
, 
fs_šfo
->
csum_shash
);

150 
shash
->
tfm
 = 
fs_šfo
->
csum_shash
;

157 
	`üy±o_shash_dige¡
(
shash
, (cÚ¡ 
u8
 *)
disk_sb
 + 
BTRFS_CSUM_SIZE
,

158 
BTRFS_SUPER_INFO_SIZE
 - 
BTRFS_CSUM_SIZE
, 
»suÉ
);

160 ià(
	`memcmp
(
disk_sb
->
csum
, 
»suÉ
, 
fs_šfo
->
csum_size
))

164 
	}
}

166 
	$bŒfs_»·œ_eb_io_çu»
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

167 
mœrÜ_num
)

169 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

170 
i
, 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
);

171 
»t
 = 0;

173 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
))

174  -
EROFS
;

176 
i
 = 0; i < 
num_·ges
; i++) {

177 
·ge
 *
p
 = 
eb
->
·ges
[
i
];

178 
u64
 
¡¬t
 = 
	`max_t
(u64, 
eb
->¡¬t, 
	`·ge_off£t
(
p
));

179 
u64
 
’d
 = 
	`mš_t
(u64, 
eb
->
¡¬t
 +ƒb->
Ën
, 
	`·ge_off£t
(
p
è+ 
PAGE_SIZE
);

180 
u32
 
Ën
 = 
’d
 - 
¡¬t
;

182 
»t
 = 
	`bŒfs_»·œ_io_çu»
(
fs_šfo
, 0, 
¡¬t
, 
Ën
,

183 
¡¬t
, 
p
, 
	`off£t_š_·ge
(¡¬t), 
mœrÜ_num
);

184 ià(
»t
)

188  
»t
;

189 
	}
}

198 
	$bŒfs_»ad_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
,

199 
bŒfs_Œ“_·»Á_check
 *
check
)

201 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

202 
çed
 = 0;

203 
»t
;

204 
num_cİ›s
 = 0;

205 
mœrÜ_num
 = 0;

206 
çed_mœrÜ
 = 0;

208 
	`ASSERT
(
check
);

211 
	`ş—r_b™
(
EXTENT_BUFFER_CORRUPT
, &
eb
->
bæags
);

212 
»t
 = 
	`»ad_ex‹Á_bufãr_·ges
(
eb
, 
WAIT_COMPLETE
, 
mœrÜ_num
, 
check
);

213 ià(!
»t
)

216 
num_cİ›s
 = 
	`bŒfs_num_cİ›s
(
fs_šfo
,

217 
eb
->
¡¬t
,ƒb->
Ën
);

218 ià(
num_cİ›s
 == 1)

221 ià(!
çed_mœrÜ
) {

222 
çed
 = 1;

223 
çed_mœrÜ
 = 
eb
->
»ad_mœrÜ
;

226 
mœrÜ_num
++;

227 ià(
mœrÜ_num
 =ğ
çed_mœrÜ
)

228 
mœrÜ_num
++;

230 ià(
mœrÜ_num
 > 
num_cİ›s
)

234 ià(
çed
 && !
»t
 && 
çed_mœrÜ
)

235 
	`bŒfs_»·œ_eb_io_çu»
(
eb
, 
çed_mœrÜ
);

237  
»t
;

238 
	}
}

243 
blk_¡©us_t
 
	$bŒ“_csum_Úe_bio
(
bŒfs_bio
 *
bbio
)

245 
ex‹Á_bufãr
 *
eb
 = 
bbio
->
´iv©e
;

246 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

247 
u64
 
found_¡¬t
 = 
	`bŒfs_h—d”_by‹Ä
(
eb
);

248 
u8
 
»suÉ
[
BTRFS_CSUM_SIZE
];

249 
»t
;

252 ià(
	`WARN_ON_ONCE
(
bbio
->
fe_off£t
 !ğ
eb
->
¡¬t
))

253  
BLK_STS_IOERR
;

254 ià(
	`WARN_ON_ONCE
(
bbio
->
bio
.
bi_™”
.
bi_size
 !ğ
eb
->
Ën
))

255  
BLK_STS_IOERR
;

257 ià(
	`‹¡_b™
(
EXTENT_BUFFER_NO_CHECK
, &
eb
->
bæags
)) {

258 
	`WARN_ON_ONCE
(
found_¡¬t
 != 0);

259  
BLK_STS_OK
;

262 ià(
	`WARN_ON_ONCE
(
found_¡¬t
 !ğ
eb
->
¡¬t
))

263  
BLK_STS_IOERR
;

264 ià(
	`WARN_ON
(!
	`bŒfs_·ge_‹¡_u±od©e
(
fs_šfo
, 
eb
->
·ges
[0],ƒb->
¡¬t
,

265 
eb
->
Ën
)))

266  
BLK_STS_IOERR
;

268 
	`ASSERT
(
	`memcmp_ex‹Á_bufãr
(
eb
, 
fs_šfo
->
fs_deviûs
->
m‘ad©a_uuid
,

269 
	`off£tof
(
bŒfs_h—d”
, 
fsid
),

270 
BTRFS_FSID_SIZE
) == 0);

271 
	`csum_Œ“_block
(
eb
, 
»suÉ
);

273 ià(
	`bŒfs_h—d”_Ëv–
(
eb
))

274 
»t
 = 
	`bŒfs_check_node
(
eb
);

276 
»t
 = 
	`bŒfs_check_Ëaf
(
eb
);

278 ià(
»t
 < 0)

279 
”rÜ
;

285 ià(
	`uÆik–y
(
	`bŒfs_h—d”_g’”©iÚ
(
eb
è<ğ
fs_šfo
->
Ï¡_Œªs_comm™‹d
)) {

286 
»t
 = -
EUCLEAN
;

287 
	`bŒfs_”r
(
fs_šfo
,

289 
eb
->
¡¬t
, 
	`bŒfs_h—d”_g’”©iÚ
(eb),

290 
fs_šfo
->
Ï¡_Œªs_comm™‹d
);

291 
”rÜ
;

293 
	`wr™e_ex‹Á_bufãr
(
eb
, 
»suÉ
, 0, 
fs_šfo
->
csum_size
);

294  
BLK_STS_OK
;

296 
”rÜ
:

297 
	`bŒfs_´št_Œ“
(
eb
, 0);

298 
	`bŒfs_”r
(
fs_šfo
, "block=%llu writeimeree block corruption detected",

299 
eb
->
¡¬t
);

306 
	`WARN_ON
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
) ||

307 
	`bŒfs_h—d”_owÃr
(
eb
è=ğ
BTRFS_TREE_LOG_OBJECTID
);

308  
	`”ºo_to_blk_¡©us
(
»t
);

309 
	}
}

311 
boŞ
 
	$check_Œ“_block_fsid
(
ex‹Á_bufãr
 *
eb
)

313 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

314 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_deviûs, *
£ed_devs
;

315 
u8
 
fsid
[
BTRFS_FSID_SIZE
];

317 
	`»ad_ex‹Á_bufãr
(
eb
, 
fsid
, 
	`off£tof
(
bŒfs_h—d”
, fsid),

318 
BTRFS_FSID_SIZE
);

325 ià(
	`memcmp
(
fsid
, 
fs_šfo
->
fs_deviûs
->
m‘ad©a_uuid
, 
BTRFS_FSID_SIZE
) == 0)

326  
çl£
;

328 
	`li¡_fÜ_—ch_’Œy
(
£ed_devs
, &
fs_deviûs
->
£ed_li¡
, seed_list)

329 ià(!
	`memcmp
(
fsid
, 
£ed_devs
->fsid, 
BTRFS_FSID_SIZE
))

330  
çl£
;

332  
Œue
;

333 
	}
}

336 
	$bŒfs_v®id©e_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
,

337 
bŒfs_Œ“_·»Á_check
 *
check
)

339 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

340 
u64
 
found_¡¬t
;

341 cÚ¡ 
u32
 
csum_size
 = 
fs_šfo
->csum_size;

342 
u8
 
found_Ëv–
;

343 
u8
 
»suÉ
[
BTRFS_CSUM_SIZE
];

344 cÚ¡ 
u8
 *
h—d”_csum
;

345 
»t
 = 0;

347 
	`ASSERT
(
check
);

349 
found_¡¬t
 = 
	`bŒfs_h—d”_by‹Ä
(
eb
);

350 ià(
found_¡¬t
 !ğ
eb
->
¡¬t
) {

351 
	`bŒfs_”r_¾
(
fs_šfo
,

353 
eb
->
»ad_mœrÜ
,ƒb->
¡¬t
, 
found_¡¬t
);

354 
»t
 = -
EIO
;

355 
out
;

357 ià(
	`check_Œ“_block_fsid
(
eb
)) {

358 
	`bŒfs_”r_¾
(
fs_šfo
, "bad fsid on†ogical %llu mirror %u",

359 
eb
->
¡¬t
,ƒb->
»ad_mœrÜ
);

360 
»t
 = -
EIO
;

361 
out
;

363 
found_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
eb
);

364 ià(
found_Ëv–
 >ğ
BTRFS_MAX_LEVEL
) {

365 
	`bŒfs_”r
(
fs_šfo
,

367 
eb
->
»ad_mœrÜ
, 
	`bŒfs_h—d”_Ëv–
Ób),ƒb->
¡¬t
);

368 
»t
 = -
EIO
;

369 
out
;

372 
	`csum_Œ“_block
(
eb
, 
»suÉ
);

373 
h—d”_csum
 = 
	`·ge_add»ss
(
eb
->
·ges
[0]) +

374 
	`g‘_eb_off£t_š_·ge
(
eb
, 
	`off£tof
(
bŒfs_h—d”
, 
csum
));

376 ià(
	`memcmp
(
»suÉ
, 
h—d”_csum
, 
csum_size
) != 0) {

377 
	`bŒfs_w¬n_¾
(
fs_šfo
,

378 "checksum v”ify faed oÀlogiÿÈ%Îu mœrÜ %u wª‹d " 
CSUM_FMT
 " found " CSUM_FMT "†evel %d",

379 
eb
->
¡¬t
,ƒb->
»ad_mœrÜ
,

380 
	`CSUM_FMT_VALUE
(
csum_size
, 
h—d”_csum
),

381 
	`CSUM_FMT_VALUE
(
csum_size
, 
»suÉ
),

382 
	`bŒfs_h—d”_Ëv–
(
eb
));

383 
»t
 = -
EUCLEAN
;

384 
out
;

387 ià(
found_Ëv–
 !ğ
check
->
Ëv–
) {

388 
	`bŒfs_”r
(
fs_šfo
,

390 
eb
->
¡¬t
,ƒb->
»ad_mœrÜ
, 
check
->
Ëv–
, 
found_Ëv–
);

391 
»t
 = -
EIO
;

392 
out
;

394 ià(
	`uÆik–y
(
check
->
Œªsid
 &&

395 
	`bŒfs_h—d”_g’”©iÚ
(
eb
è!ğ
check
->
Œªsid
)) {

396 
	`bŒfs_”r_¾
(
eb
->
fs_šfo
,

398 
eb
->
¡¬t
,ƒb->
»ad_mœrÜ
, 
check
->
Œªsid
,

399 
	`bŒfs_h—d”_g’”©iÚ
(
eb
));

400 
»t
 = -
EIO
;

401 
out
;

403 ià(
check
->
has_fœ¡_key
) {

404 
bŒfs_key
 *
ex³ù_key
 = &
check
->
fœ¡_key
;

405 
bŒfs_key
 
found_key
;

407 ià(
found_Ëv–
)

408 
	`bŒfs_node_key_to_ıu
(
eb
, &
found_key
, 0);

410 
	`bŒfs_™em_key_to_ıu
(
eb
, &
found_key
, 0);

411 ià(
	`uÆik–y
(
	`bŒfs_comp_ıu_keys
(
ex³ù_key
, &
found_key
))) {

412 
	`bŒfs_”r
(
fs_šfo
,

414 
eb
->
¡¬t
, 
check
->
Œªsid
,

415 
ex³ù_key
->
objeùid
,

416 
ex³ù_key
->
ty³
,ƒx³ù_key->
off£t
,

417 
found_key
.
objeùid
, found_key.
ty³
,

418 
found_key
.
off£t
);

419 
»t
 = -
EUCLEAN
;

420 
out
;

423 ià(
check
->
owÃr_roÙ
) {

424 
»t
 = 
	`bŒfs_check_eb_owÃr
(
eb
, 
check
->
owÃr_roÙ
);

425 ià(
»t
 < 0)

426 
out
;

434 ià(
found_Ëv–
 =ğ0 && 
	`bŒfs_check_Ëaf
(
eb
)) {

435 
	`£t_b™
(
EXTENT_BUFFER_CORRUPT
, &
eb
->
bæags
);

436 
»t
 = -
EIO
;

439 ià(
found_Ëv–
 > 0 && 
	`bŒfs_check_node
(
eb
))

440 
»t
 = -
EIO
;

442 ià(
»t
)

443 
	`bŒfs_”r
(
fs_šfo
,

445 
eb
->
¡¬t
,ƒb->
»ad_mœrÜ
);

446 
out
:

447  
»t
;

448 
	}
}

450 #ifdeà
CONFIG_MIGRATION


451 
	$bŒ“_mig¿‹_fŞio
(
add»ss_¥aû
 *
m­pšg
,

452 
fŞio
 *
d¡
, fŞiØ*
¤c
, 
mig¿‹_mode
 
mode
)

458 ià(
	`fŞio_‹¡_dœty
(
¤c
))

459  -
EAGAIN
;

464 ià(
	`fŞio_g‘_´iv©e
(
¤c
) &&

465 !
	`fem­_»Ëa£_fŞio
(
¤c
, 
GFP_KERNEL
))

466  -
EAGAIN
;

467  
	`mig¿‹_fŞio
(
m­pšg
, 
d¡
, 
¤c
, 
mode
);

468 
	}
}

470 
	#bŒ“_mig¿‹_fŞio
 
NULL


	)

473 
	$bŒ“_wr™•ages
(
add»ss_¥aû
 *
m­pšg
,

474 
wr™eback_cÚŒŞ
 *
wbc
)

476 
bŒfs_fs_šfo
 *
fs_šfo
;

477 
»t
;

479 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
) {

481 ià(
wbc
->
fÜ_kupd©e
)

484 
fs_šfo
 = 
	`BTRFS_I
(
m­pšg
->
ho¡
)->
roÙ
->fs_info;

486 
»t
 = 
	`__³rıu_couÁ”_com·»
(&
fs_šfo
->
dœty_m‘ad©a_by‹s
,

487 
BTRFS_DIRTY_METADATA_THRESH
,

488 
fs_šfo
->
dœty_m‘ad©a_b©ch
);

489 ià(
»t
 < 0)

492  
	`bŒ“_wr™e_ÿche_·ges
(
m­pšg
, 
wbc
);

493 
	}
}

495 
boŞ
 
	$bŒ“_»Ëa£_fŞio
(
fŞio
 *fŞio, 
gå_t
 
gå_æags
)

497 ià(
	`fŞio_‹¡_wr™eback
(
fŞio
è|| 
	`fŞio_‹¡_dœty
(folio))

498  
çl£
;

500  
	`Œy_»Ëa£_ex‹Á_bufãr
(&
fŞio
->
·ge
);

501 
	}
}

503 
	$bŒ“_šv®id©e_fŞio
(
fŞio
 *fŞio, 
size_t
 
off£t
,

504 
size_t
 
Ëngth
)

506 
ex‹Á_io_Œ“
 *
Œ“
;

507 
Œ“
 = &
	`BTRFS_I
(
fŞio
->
m­pšg
->
ho¡
)->
io_Œ“
;

508 
	`ex‹Á_šv®id©e_fŞio
(
Œ“
, 
fŞio
, 
off£t
);

509 
	`bŒ“_»Ëa£_fŞio
(
fŞio
, 
GFP_NOFS
);

510 ià(
	`fŞio_g‘_´iv©e
(
fŞio
)) {

511 
	`bŒfs_w¬n
(
	`BTRFS_I
(
fŞio
->
m­pšg
->
ho¡
)->
roÙ
->
fs_šfo
,

513 ()
	`fŞio_pos
(
fŞio
));

514 
	`fŞio_d‘ach_´iv©e
(
fŞio
);

516 
	}
}

518 #ifdeà
DEBUG


519 
boŞ
 
	$bŒ“_dœty_fŞio
(
add»ss_¥aû
 *
m­pšg
,

520 
fŞio
 *folio)

522 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
m­pšg
->
ho¡
->
i_sb
);

523 
bŒfs_sub·ge_šfo
 *
¥i
 = 
fs_šfo
->
sub·ge_šfo
;

524 
bŒfs_sub·ge
 *
sub·ge
;

525 
ex‹Á_bufãr
 *
eb
;

526 
cur_b™
 = 0;

527 
u64
 
·ge_¡¬t
 = 
	`fŞio_pos
(
fŞio
);

529 ià(
fs_šfo
->
£ùÜsize
 =ğ
PAGE_SIZE
) {

530 
eb
 = 
	`fŞio_g‘_´iv©e
(
fŞio
);

531 
	`BUG_ON
(!
eb
);

532 
	`BUG_ON
(!
	`‹¡_b™
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bæags
));

533 
	`BUG_ON
(!
	`©omic_»ad
(&
eb
->
»fs
));

534 
	`bŒfs_as£¹_Œ“_wr™e_locked
(
eb
);

535  
	`fem­_dœty_fŞio
(
m­pšg
, 
fŞio
);

538 
	`ASSERT
(
¥i
);

539 
sub·ge
 = 
	`fŞio_g‘_´iv©e
(
fŞio
);

541 
cur_b™
 = 
¥i
->
dœty_off£t
;

542 
cur_b™
 < 
¥i
->
dœty_off£t
 + spi->
b™m­_Ä_b™s
;

543 
cur_b™
++) {

544 
æags
;

545 
u64
 
cur
;

547 
	`¥š_lock_œq§ve
(&
sub·ge
->
lock
, 
æags
);

548 ià(!
	`‹¡_b™
(
cur_b™
, 
sub·ge
->
b™m­s
)) {

549 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
);

552 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
);

553 
cur
 = 
·ge_¡¬t
 + 
cur_b™
 * 
fs_šfo
->
£ùÜsize
;

555 
eb
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
cur
);

556 
	`ASSERT
(
eb
);

557 
	`ASSERT
(
	`‹¡_b™
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bæags
));

558 
	`ASSERT
(
	`©omic_»ad
(&
eb
->
»fs
));

559 
	`bŒfs_as£¹_Œ“_wr™e_locked
(
eb
);

560 
	`ä“_ex‹Á_bufãr
(
eb
);

562 
cur_b™
 +ğ(
fs_šfo
->
nodesize
 >> fs_šfo->
£ùÜsize_b™s
) - 1;

564  
	`fem­_dœty_fŞio
(
m­pšg
, 
fŞio
);

565 
	}
}

567 
	#bŒ“_dœty_fŞio
 
fem­_dœty_fŞio


	)

570 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gbŒ“_aİs
 = {

571 .
wr™•ages
 = 
bŒ“_wr™•ages
,

572 .
	g»Ëa£_fŞio
 = 
bŒ“_»Ëa£_fŞio
,

573 .
	gšv®id©e_fŞio
 = 
bŒ“_šv®id©e_fŞio
,

574 .
	gmig¿‹_fŞio
 = 
bŒ“_mig¿‹_fŞio
,

575 .
	gdœty_fŞio
 = 
bŒ“_dœty_fŞio
,

578 
ex‹Á_bufãr
 *
	$bŒfs_fšd_ü—‹_Œ“_block
(

579 
bŒfs_fs_šfo
 *
fs_šfo
,

580 
u64
 
by‹Ä
, u64 
owÃr_roÙ
,

581 
Ëv–
)

583 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
))

584  
	`®loc_‹¡_ex‹Á_bufãr
(
fs_šfo
, 
by‹Ä
);

585  
	`®loc_ex‹Á_bufãr
(
fs_šfo
, 
by‹Ä
, 
owÃr_roÙ
, 
Ëv–
);

586 
	}
}

595 
ex‹Á_bufãr
 *
	$»ad_Œ“_block
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

596 
bŒfs_Œ“_·»Á_check
 *
check
)

598 
ex‹Á_bufãr
 *
buf
 = 
NULL
;

599 
»t
;

601 
	`ASSERT
(
check
);

603 
buf
 = 
	`bŒfs_fšd_ü—‹_Œ“_block
(
fs_šfo
, 
by‹Ä
, 
check
->
owÃr_roÙ
,

604 
check
->
Ëv–
);

605 ià(
	`IS_ERR
(
buf
))

606  
buf
;

608 
»t
 = 
	`bŒfs_»ad_ex‹Á_bufãr
(
buf
, 
check
);

609 ià(
»t
) {

610 
	`ä“_ex‹Á_bufãr_¡®e
(
buf
);

611  
	`ERR_PTR
(
»t
);

613 ià(
	`bŒfs_check_eb_owÃr
(
buf
, 
check
->
owÃr_roÙ
)) {

614 
	`ä“_ex‹Á_bufãr_¡®e
(
buf
);

615  
	`ERR_PTR
(-
EUCLEAN
);

617  
buf
;

619 
	}
}

621 
	$__£tup_roÙ
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_fs_šfo
 *
fs_šfo
,

622 
u64
 
objeùid
)

624 
boŞ
 
dummy
 = 
	`‹¡_b™
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_šfo
->
fs_¡©e
);

626 
	`mem£t
(&
roÙ
->
roÙ_key
, 0, (root->root_key));

627 
	`mem£t
(&
roÙ
->
roÙ_™em
, 0, (root->root_item));

628 
	`mem£t
(&
roÙ
->
deäag_´og»ss
, 0, (root->defrag_progress));

629 
roÙ
->
fs_šfo
 = fs_info;

630 
roÙ
->
roÙ_key
.
objeùid
 = objectid;

631 
roÙ
->
node
 = 
NULL
;

632 
roÙ
->
comm™_roÙ
 = 
NULL
;

633 
roÙ
->
¡©e
 = 0;

634 
	`RB_CLEAR_NODE
(&
roÙ
->
rb_node
);

636 
roÙ
->
Ï¡_Œªs
 = 0;

637 
roÙ
->
ä“_objeùid
 = 0;

638 
roÙ
->
Ä_d–®loc_šodes
 = 0;

639 
roÙ
->
Ä_Üd”ed_ex‹Ás
 = 0;

640 
roÙ
->
šode_Œ“
 = 
RB_ROOT
;

641 
	`INIT_RADIX_TREE
(&
roÙ
->
d–ayed_nodes_Œ“
, 
GFP_ATOMIC
);

643 
	`bŒfs_š™_roÙ_block_rsv
(
roÙ
);

645 
	`INIT_LIST_HEAD
(&
roÙ
->
dœty_li¡
);

646 
	`INIT_LIST_HEAD
(&
roÙ
->
roÙ_li¡
);

647 
	`INIT_LIST_HEAD
(&
roÙ
->
d–®loc_šodes
);

648 
	`INIT_LIST_HEAD
(&
roÙ
->
d–®loc_roÙ
);

649 
	`INIT_LIST_HEAD
(&
roÙ
->
Üd”ed_ex‹Ás
);

650 
	`INIT_LIST_HEAD
(&
roÙ
->
Üd”ed_roÙ
);

651 
	`INIT_LIST_HEAD
(&
roÙ
->
»loc_dœty_li¡
);

652 
	`INIT_LIST_HEAD
(&
roÙ
->
logged_li¡
[0]);

653 
	`INIT_LIST_HEAD
(&
roÙ
->
logged_li¡
[1]);

654 
	`¥š_lock_š™
(&
roÙ
->
šode_lock
);

655 
	`¥š_lock_š™
(&
roÙ
->
d–®loc_lock
);

656 
	`¥š_lock_š™
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

657 
	`¥š_lock_š™
(&
roÙ
->
accouÁšg_lock
);

658 
	`¥š_lock_š™
(&
roÙ
->
log_ex‹Ás_lock
[0]);

659 
	`¥š_lock_š™
(&
roÙ
->
log_ex‹Ás_lock
[1]);

660 
	`¥š_lock_š™
(&
roÙ
->
qgroup_m‘a_rsv_lock
);

661 
	`mu‹x_š™
(&
roÙ
->
objeùid_mu‹x
);

662 
	`mu‹x_š™
(&
roÙ
->
log_mu‹x
);

663 
	`mu‹x_š™
(&
roÙ
->
Üd”ed_ex‹Á_mu‹x
);

664 
	`mu‹x_š™
(&
roÙ
->
d–®loc_mu‹x
);

665 
	`š™_wa™queue_h—d
(&
roÙ
->
qgroup_æush_wa™
);

666 
	`š™_wa™queue_h—d
(&
roÙ
->
log_wr™”_wa™
);

667 
	`š™_wa™queue_h—d
(&
roÙ
->
log_comm™_wa™
[0]);

668 
	`š™_wa™queue_h—d
(&
roÙ
->
log_comm™_wa™
[1]);

669 
	`INIT_LIST_HEAD
(&
roÙ
->
log_ùxs
[0]);

670 
	`INIT_LIST_HEAD
(&
roÙ
->
log_ùxs
[1]);

671 
	`©omic_£t
(&
roÙ
->
log_comm™
[0], 0);

672 
	`©omic_£t
(&
roÙ
->
log_comm™
[1], 0);

673 
	`©omic_£t
(&
roÙ
->
log_wr™”s
, 0);

674 
	`©omic_£t
(&
roÙ
->
log_b©ch
, 0);

675 
	`»fcouÁ_£t
(&
roÙ
->
»fs
, 1);

676 
	`©omic_£t
(&
roÙ
->
¢­shÙ_fÜû_cow
, 0);

677 
	`©omic_£t
(&
roÙ
->
Ä_sw­fes
, 0);

678 
roÙ
->
log_Œªsid
 = 0;

679 
roÙ
->
log_Œªsid_comm™‹d
 = -1;

680 
roÙ
->
Ï¡_log_comm™
 = 0;

681 
roÙ
->
ªÚ_dev
 = 0;

682 ià(!
dummy
) {

683 
	`ex‹Á_io_Œ“_š™
(
fs_šfo
, &
roÙ
->
dœty_log_·ges
,

684 
IO_TREE_ROOT_DIRTY_LOG_PAGES
);

685 
	`ex‹Á_io_Œ“_š™
(
fs_šfo
, &
roÙ
->
log_csum_¿nge
,

686 
IO_TREE_LOG_CSUM_RANGE
);

689 
	`¥š_lock_š™
(&
roÙ
->
roÙ_™em_lock
);

690 
	`bŒfs_qgroup_š™_sw­³d_blocks
(&
roÙ
->
sw­³d_blocks
);

691 #ifdeà
CONFIG_BTRFS_DEBUG


692 
	`INIT_LIST_HEAD
(&
roÙ
->
Ëak_li¡
);

693 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

694 
	`li¡_add_
(&
roÙ
->
Ëak_li¡
, &
fs_šfo
->
®loÿ‹d_roÙs
);

695 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

697 
	}
}

699 
bŒfs_roÙ
 *
	$bŒfs_®loc_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

700 
u64
 
objeùid
, 
gå_t
 
æags
)

702 
bŒfs_roÙ
 *
roÙ
 = 
	`kz®loc
((*roÙ), 
æags
);

703 ià(
roÙ
)

704 
	`__£tup_roÙ
(
roÙ
, 
fs_šfo
, 
objeùid
);

705  
roÙ
;

706 
	}
}

708 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


710 
bŒfs_roÙ
 *
	$bŒfs_®loc_dummy_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
)

712 
bŒfs_roÙ
 *
roÙ
;

714 ià(!
fs_šfo
)

715  
	`ERR_PTR
(-
EINVAL
);

717 
roÙ
 = 
	`bŒfs_®loc_roÙ
(
fs_šfo
, 
BTRFS_ROOT_TREE_OBJECTID
, 
GFP_KERNEL
);

718 ià(!
roÙ
)

719  
	`ERR_PTR
(-
ENOMEM
);

722 
roÙ
->
®loc_by‹Ä
 = 0;

724  
roÙ
;

725 
	}
}

728 
	$glob®_roÙ_cmp
(
rb_node
 *
a_node
, cÚ¡ rb_nod*
b_node
)

730 cÚ¡ 
bŒfs_roÙ
 *
a
 = 
	`rb_’Œy
(
a_node
, bŒfs_roÙ, 
rb_node
);

731 cÚ¡ 
bŒfs_roÙ
 *
b
 = 
	`rb_’Œy
(
b_node
, bŒfs_roÙ, 
rb_node
);

733  
	`bŒfs_comp_ıu_keys
(&
a
->
roÙ_key
, &
b
->root_key);

734 
	}
}

736 
	$glob®_roÙ_key_cmp
(cÚ¡ *
k
, cÚ¡ 
rb_node
 *
node
)

738 cÚ¡ 
bŒfs_key
 *
key
 = 
k
;

739 cÚ¡ 
bŒfs_roÙ
 *
roÙ
 = 
	`rb_’Œy
(
node
, bŒfs_roÙ, 
rb_node
);

741  
	`bŒfs_comp_ıu_keys
(
key
, &
roÙ
->
roÙ_key
);

742 
	}
}

744 
	$bŒfs_glob®_roÙ_š£¹
(
bŒfs_roÙ
 *
roÙ
)

746 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

747 
rb_node
 *
tmp
;

748 
»t
 = 0;

750 
	`wr™e_lock
(&
fs_šfo
->
glob®_roÙ_lock
);

751 
tmp
 = 
	`rb_fšd_add
(&
roÙ
->
rb_node
, &
fs_šfo
->
glob®_roÙ_Œ“
, 
glob®_roÙ_cmp
);

752 
	`wr™e_uÆock
(&
fs_šfo
->
glob®_roÙ_lock
);

754 ià(
tmp
) {

755 
»t
 = -
EEXIST
;

756 
	`bŒfs_w¬n
(
fs_šfo
, "global„oot %llu %llu‡lreadyƒxists",

757 
roÙ
->
roÙ_key
.
objeùid
,„oÙ->roÙ_key.
off£t
);

759  
»t
;

760 
	}
}

762 
	$bŒfs_glob®_roÙ_d–‘e
(
bŒfs_roÙ
 *
roÙ
)

764 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

766 
	`wr™e_lock
(&
fs_šfo
->
glob®_roÙ_lock
);

767 
	`rb_”a£
(&
roÙ
->
rb_node
, &
fs_šfo
->
glob®_roÙ_Œ“
);

768 
	`wr™e_uÆock
(&
fs_šfo
->
glob®_roÙ_lock
);

769 
	}
}

771 
bŒfs_roÙ
 *
	$bŒfs_glob®_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

772 
bŒfs_key
 *
key
)

774 
rb_node
 *
node
;

775 
bŒfs_roÙ
 *
roÙ
 = 
NULL
;

777 
	`»ad_lock
(&
fs_šfo
->
glob®_roÙ_lock
);

778 
node
 = 
	`rb_fšd
(
key
, &
fs_šfo
->
glob®_roÙ_Œ“
, 
glob®_roÙ_key_cmp
);

779 ià(
node
)

780 
roÙ
 = 
	`cÚš”_of
(
node
, 
bŒfs_roÙ
, 
rb_node
);

781 
	`»ad_uÆock
(&
fs_šfo
->
glob®_roÙ_lock
);

783  
roÙ
;

784 
	}
}

786 
u64
 
	$bŒfs_glob®_roÙ_id
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
)

788 
bŒfs_block_group
 *
block_group
;

789 
u64
 
»t
;

791 ià(!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
EXTENT_TREE_V2
))

794 ià(
by‹Ä
)

795 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
by‹Ä
);

797 
block_group
 = 
	`bŒfs_lookup_fœ¡_block_group
(
fs_šfo
, 
by‹Ä
);

798 
	`ASSERT
(
block_group
);

799 ià(!
block_group
)

801 
»t
 = 
block_group
->
glob®_roÙ_id
;

802 
	`bŒfs_put_block_group
(
block_group
);

804  
»t
;

805 
	}
}

807 
bŒfs_roÙ
 *
	$bŒfs_csum_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
)

809 
bŒfs_key
 
key
 = {

810 .
objeùid
 = 
BTRFS_CSUM_TREE_OBJECTID
,

811 .
ty³
 = 
BTRFS_ROOT_ITEM_KEY
,

812 .
off£t
 = 
	`bŒfs_glob®_roÙ_id
(
fs_šfo
, 
by‹Ä
),

815  
	`bŒfs_glob®_roÙ
(
fs_šfo
, &
key
);

816 
	}
}

818 
bŒfs_roÙ
 *
	$bŒfs_ex‹Á_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
)

820 
bŒfs_key
 
key
 = {

821 .
objeùid
 = 
BTRFS_EXTENT_TREE_OBJECTID
,

822 .
ty³
 = 
BTRFS_ROOT_ITEM_KEY
,

823 .
off£t
 = 
	`bŒfs_glob®_roÙ_id
(
fs_šfo
, 
by‹Ä
),

826  
	`bŒfs_glob®_roÙ
(
fs_šfo
, &
key
);

827 
	}
}

829 
bŒfs_roÙ
 *
	$bŒfs_block_group_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
)

831 ià(
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
BLOCK_GROUP_TREE
))

832  
fs_šfo
->
block_group_roÙ
;

833  
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 0);

834 
	}
}

836 
bŒfs_roÙ
 *
	$bŒfs_ü—‹_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

837 
u64
 
objeùid
)

839 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

840 
ex‹Á_bufãr
 *
Ëaf
;

841 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

842 
bŒfs_roÙ
 *
roÙ
;

843 
bŒfs_key
 
key
;

844 
nofs_æag
;

845 
»t
 = 0;

851 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

852 
roÙ
 = 
	`bŒfs_®loc_roÙ
(
fs_šfo
, 
objeùid
, 
GFP_KERNEL
);

853 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

854 ià(!
roÙ
)

855  
	`ERR_PTR
(-
ENOMEM
);

857 
roÙ
->
roÙ_key
.
objeùid
 = objectid;

858 
roÙ
->
roÙ_key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

859 
roÙ
->
roÙ_key
.
off£t
 = 0;

861 
Ëaf
 = 
	`bŒfs_®loc_Œ“_block
(
Œªs
, 
roÙ
, 0, 
objeùid
, 
NULL
, 0, 0, 0,

862 
BTRFS_NESTING_NORMAL
);

863 ià(
	`IS_ERR
(
Ëaf
)) {

864 
»t
 = 
	`PTR_ERR
(
Ëaf
);

865 
Ëaf
 = 
NULL
;

866 
ç
;

869 
roÙ
->
node
 = 
Ëaf
;

870 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

872 
roÙ
->
comm™_roÙ
 = 
	`bŒfs_roÙ_node
(root);

873 
	`£t_b™
(
BTRFS_ROOT_TRACK_DIRTY
, &
roÙ
->
¡©e
);

875 
	`bŒfs_£t_roÙ_æags
(&
roÙ
->
roÙ_™em
, 0);

876 
	`bŒfs_£t_roÙ_lim™
(&
roÙ
->
roÙ_™em
, 0);

877 
	`bŒfs_£t_roÙ_by‹Ä
(&
roÙ
->
roÙ_™em
, 
Ëaf
->
¡¬t
);

878 
	`bŒfs_£t_roÙ_g’”©iÚ
(&
roÙ
->
roÙ_™em
, 
Œªs
->
Œªsid
);

879 
	`bŒfs_£t_roÙ_Ëv–
(&
roÙ
->
roÙ_™em
, 0);

880 
	`bŒfs_£t_roÙ_»fs
(&
roÙ
->
roÙ_™em
, 1);

881 
	`bŒfs_£t_roÙ_u£d
(&
roÙ
->
roÙ_™em
, 
Ëaf
->
Ën
);

882 
	`bŒfs_£t_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
, 0);

883 
	`bŒfs_£t_roÙ_dœid
(&
roÙ
->
roÙ_™em
, 0);

884 ià(
	`is_f¡»e
(
objeùid
))

885 
	`g’”©e_¿ndom_guid
(
roÙ
->
roÙ_™em
.
uuid
);

887 
	`expÜt_guid
(
roÙ
->
roÙ_™em
.
uuid
, &
guid_nuÎ
);

888 
	`bŒfs_£t_roÙ_drİ_Ëv–
(&
roÙ
->
roÙ_™em
, 0);

890 
	`bŒfs_Œ“_uÆock
(
Ëaf
);

892 
key
.
objeùid
 = objectid;

893 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

894 
key
.
off£t
 = 0;

895 
»t
 = 
	`bŒfs_š£¹_roÙ
(
Œªs
, 
Œ“_roÙ
, &
key
, &
roÙ
->
roÙ_™em
);

896 ià(
»t
)

897 
ç
;

899  
roÙ
;

901 
ç
:

902 
	`bŒfs_put_roÙ
(
roÙ
);

904  
	`ERR_PTR
(
»t
);

905 
	}
}

907 
bŒfs_roÙ
 *
	$®loc_log_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

908 
bŒfs_fs_šfo
 *
fs_šfo
)

910 
bŒfs_roÙ
 *
roÙ
;

912 
roÙ
 = 
	`bŒfs_®loc_roÙ
(
fs_šfo
, 
BTRFS_TREE_LOG_OBJECTID
, 
GFP_NOFS
);

913 ià(!
roÙ
)

914  
	`ERR_PTR
(-
ENOMEM
);

916 
roÙ
->
roÙ_key
.
objeùid
 = 
BTRFS_TREE_LOG_OBJECTID
;

917 
roÙ
->
roÙ_key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

918 
roÙ
->
roÙ_key
.
off£t
 = 
BTRFS_TREE_LOG_OBJECTID
;

920  
roÙ
;

921 
	}
}

923 
	$bŒfs_®loc_log_Œ“_node
(
bŒfs_Œªs_hªdË
 *
Œªs
,

924 
bŒfs_roÙ
 *
roÙ
)

926 
ex‹Á_bufãr
 *
Ëaf
;

938 
Ëaf
 = 
	`bŒfs_®loc_Œ“_block
(
Œªs
, 
roÙ
, 0, 
BTRFS_TREE_LOG_OBJECTID
,

939 
NULL
, 0, 0, 0, 
BTRFS_NESTING_NORMAL
);

940 ià(
	`IS_ERR
(
Ëaf
))

941  
	`PTR_ERR
(
Ëaf
);

943 
roÙ
->
node
 = 
Ëaf
;

945 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
roÙ
->
node
);

946 
	`bŒfs_Œ“_uÆock
(
roÙ
->
node
);

949 
	}
}

951 
	$bŒfs_š™_log_roÙ_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

952 
bŒfs_fs_šfo
 *
fs_šfo
)

954 
bŒfs_roÙ
 *
log_roÙ
;

956 
log_roÙ
 = 
	`®loc_log_Œ“
(
Œªs
, 
fs_šfo
);

957 ià(
	`IS_ERR
(
log_roÙ
))

958  
	`PTR_ERR
(
log_roÙ
);

960 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
)) {

961 
»t
 = 
	`bŒfs_®loc_log_Œ“_node
(
Œªs
, 
log_roÙ
);

963 ià(
»t
) {

964 
	`bŒfs_put_roÙ
(
log_roÙ
);

965  
»t
;

969 
	`WARN_ON
(
fs_šfo
->
log_roÙ_Œ“
);

970 
fs_šfo
->
log_roÙ_Œ“
 = 
log_roÙ
;

972 
	}
}

974 
	$bŒfs_add_log_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

975 
bŒfs_roÙ
 *
roÙ
)

977 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

978 
bŒfs_roÙ
 *
log_roÙ
;

979 
bŒfs_šode_™em
 *
šode_™em
;

980 
»t
;

982 
log_roÙ
 = 
	`®loc_log_Œ“
(
Œªs
, 
fs_šfo
);

983 ià(
	`IS_ERR
(
log_roÙ
))

984  
	`PTR_ERR
(
log_roÙ
);

986 
»t
 = 
	`bŒfs_®loc_log_Œ“_node
(
Œªs
, 
log_roÙ
);

987 ià(
»t
) {

988 
	`bŒfs_put_roÙ
(
log_roÙ
);

989  
»t
;

992 
log_roÙ
->
Ï¡_Œªs
 = 
Œªs
->
Œªsid
;

993 
log_roÙ
->
roÙ_key
.
off£t
 = 
roÙ
->roÙ_key.
objeùid
;

995 
šode_™em
 = &
log_roÙ
->
roÙ_™em
.
šode
;

996 
	`bŒfs_£t_¡ack_šode_g’”©iÚ
(
šode_™em
, 1);

997 
	`bŒfs_£t_¡ack_šode_size
(
šode_™em
, 3);

998 
	`bŒfs_£t_¡ack_šode_Æšk
(
šode_™em
, 1);

999 
	`bŒfs_£t_¡ack_šode_nby‹s
(
šode_™em
,

1000 
fs_šfo
->
nodesize
);

1001 
	`bŒfs_£t_¡ack_šode_mode
(
šode_™em
, 
S_IFDIR
 | 0755);

1003 
	`bŒfs_£t_roÙ_node
(&
log_roÙ
->
roÙ_™em
,†og_roÙ->
node
);

1005 
	`WARN_ON
(
roÙ
->
log_roÙ
);

1006 
roÙ
->
log_roÙ
 =†og_root;

1007 
roÙ
->
log_Œªsid
 = 0;

1008 
roÙ
->
log_Œªsid_comm™‹d
 = -1;

1009 
roÙ
->
Ï¡_log_comm™
 = 0;

1011 
	}
}

1013 
bŒfs_roÙ
 *
	$»ad_Œ“_roÙ_·th
(
bŒfs_roÙ
 *
Œ“_roÙ
,

1014 
bŒfs_·th
 *
·th
,

1015 
bŒfs_key
 *
key
)

1017 
bŒfs_roÙ
 *
roÙ
;

1018 
bŒfs_Œ“_·»Á_check
 
check
 = { 0 };

1019 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œ“_roÙ
->fs_info;

1020 
u64
 
g’”©iÚ
;

1021 
»t
;

1022 
Ëv–
;

1024 
roÙ
 = 
	`bŒfs_®loc_roÙ
(
fs_šfo
, 
key
->
objeùid
, 
GFP_NOFS
);

1025 ià(!
roÙ
)

1026  
	`ERR_PTR
(-
ENOMEM
);

1028 
»t
 = 
	`bŒfs_fšd_roÙ
(
Œ“_roÙ
, 
key
, 
·th
,

1029 &
roÙ
->
roÙ_™em
, &roÙ->
roÙ_key
);

1030 ià(
»t
) {

1031 ià(
»t
 > 0)

1032 
»t
 = -
ENOENT
;

1033 
ç
;

1036 
g’”©iÚ
 = 
	`bŒfs_roÙ_g’”©iÚ
(&
roÙ
->
roÙ_™em
);

1037 
Ëv–
 = 
	`bŒfs_roÙ_Ëv–
(&
roÙ
->
roÙ_™em
);

1038 
check
.
Ëv–
 =†evel;

1039 
check
.
Œªsid
 = 
g’”©iÚ
;

1040 
check
.
owÃr_roÙ
 = 
key
->
objeùid
;

1041 
roÙ
->
node
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
	`bŒfs_roÙ_by‹Ä
(&roÙ->
roÙ_™em
),

1042 &
check
);

1043 ià(
	`IS_ERR
(
roÙ
->
node
)) {

1044 
»t
 = 
	`PTR_ERR
(
roÙ
->
node
);

1045 
roÙ
->
node
 = 
NULL
;

1046 
ç
;

1048 ià(!
	`bŒfs_bufãr_u±od©e
(
roÙ
->
node
, 
g’”©iÚ
, 0)) {

1049 
»t
 = -
EIO
;

1050 
ç
;

1057 ià(!
	`‹¡_b™
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_šfo
->
fs_¡©e
) &&

1058 
roÙ
->
roÙ_key
.
objeùid
 !ğ
BTRFS_TREE_LOG_OBJECTID
 &&

1059 
roÙ
->
roÙ_key
.
objeùid
 !ğ
BTRFS_TREE_RELOC_OBJECTID
 &&

1060 
roÙ
->
roÙ_key
.
objeùid
 !ğ
	`bŒfs_h—d”_owÃr
ÔoÙ->
node
)) {

1061 
	`bŒfs_ü™
(
fs_šfo
,

1063 
roÙ
->
roÙ_key
.
objeùid
,„oÙ->
node
->
¡¬t
,

1064 
	`bŒfs_h—d”_owÃr
(
roÙ
->
node
),

1065 
roÙ
->
roÙ_key
.
objeùid
);

1066 
»t
 = -
EUCLEAN
;

1067 
ç
;

1069 
roÙ
->
comm™_roÙ
 = 
	`bŒfs_roÙ_node
(root);

1070  
roÙ
;

1071 
ç
:

1072 
	`bŒfs_put_roÙ
(
roÙ
);

1073  
	`ERR_PTR
(
»t
);

1074 
	}
}

1076 
bŒfs_roÙ
 *
	$bŒfs_»ad_Œ“_roÙ
(
bŒfs_roÙ
 *
Œ“_roÙ
,

1077 
bŒfs_key
 *
key
)

1079 
bŒfs_roÙ
 *
roÙ
;

1080 
bŒfs_·th
 *
·th
;

1082 
·th
 = 
	`bŒfs_®loc_·th
();

1083 ià(!
·th
)

1084  
	`ERR_PTR
(-
ENOMEM
);

1085 
roÙ
 = 
	`»ad_Œ“_roÙ_·th
(
Œ“_roÙ
, 
·th
, 
key
);

1086 
	`bŒfs_ä“_·th
(
·th
);

1088  
roÙ
;

1089 
	}
}

1096 
	$bŒfs_š™_fs_roÙ
(
bŒfs_roÙ
 *
roÙ
, 
dev_t
 
ªÚ_dev
)

1098 
»t
;

1100 
	`bŒfs_d»w_lock_š™
(&
roÙ
->
¢­shÙ_lock
);

1102 ià(
roÙ
->
roÙ_key
.
objeùid
 !ğ
BTRFS_TREE_LOG_OBJECTID
 &&

1103 !
	`bŒfs_is_d©a_»loc_roÙ
(
roÙ
) &&

1104 
	`is_f¡»e
(
roÙ
->
roÙ_key
.
objeùid
)) {

1105 
	`£t_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
);

1106 
	`bŒfs_check_ªd_š™_roÙ_™em
(&
roÙ
->
roÙ_™em
);

1113 ià(
	`is_f¡»e
(
roÙ
->
roÙ_key
.
objeùid
) &&

1114 
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) > 0) {

1115 ià(!
ªÚ_dev
) {

1116 
»t
 = 
	`g‘_ªÚ_bdev
(&
roÙ
->
ªÚ_dev
);

1117 ià(
»t
)

1118 
ç
;

1120 
roÙ
->
ªÚ_dev
 =‡non_dev;

1124 
	`mu‹x_lock
(&
roÙ
->
objeùid_mu‹x
);

1125 
»t
 = 
	`bŒfs_š™_roÙ_ä“_objeùid
(
roÙ
);

1126 ià(
»t
) {

1127 
	`mu‹x_uÆock
(&
roÙ
->
objeùid_mu‹x
);

1128 
ç
;

1131 
	`ASSERT
(
roÙ
->
ä“_objeùid
 <ğ
BTRFS_LAST_FREE_OBJECTID
);

1133 
	`mu‹x_uÆock
(&
roÙ
->
objeùid_mu‹x
);

1136 
ç
:

1138  
»t
;

1139 
	}
}

1141 
bŒfs_roÙ
 *
	$bŒfs_lookup_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

1142 
u64
 
roÙ_id
)

1144 
bŒfs_roÙ
 *
roÙ
;

1146 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

1147 
roÙ
 = 
	`¿dix_Œ“_lookup
(&
fs_šfo
->
fs_roÙs_¿dix
,

1148 ()
roÙ_id
);

1149 
roÙ
 = 
	`bŒfs_g¿b_roÙ
(root);

1150 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

1151  
roÙ
;

1152 
	}
}

1154 
bŒfs_roÙ
 *
	$bŒfs_g‘_glob®_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

1155 
u64
 
objeùid
)

1157 
bŒfs_key
 
key
 = {

1158 .
objeùid
 = objectid,

1159 .
ty³
 = 
BTRFS_ROOT_ITEM_KEY
,

1160 .
off£t
 = 0,

1163 
objeùid
) {

1164 
BTRFS_ROOT_TREE_OBJECTID
:

1165  
	`bŒfs_g¿b_roÙ
(
fs_šfo
->
Œ“_roÙ
);

1166 
BTRFS_EXTENT_TREE_OBJECTID
:

1167  
	`bŒfs_g¿b_roÙ
(
	`bŒfs_glob®_roÙ
(
fs_šfo
, &
key
));

1168 
BTRFS_CHUNK_TREE_OBJECTID
:

1169  
	`bŒfs_g¿b_roÙ
(
fs_šfo
->
chunk_roÙ
);

1170 
BTRFS_DEV_TREE_OBJECTID
:

1171  
	`bŒfs_g¿b_roÙ
(
fs_šfo
->
dev_roÙ
);

1172 
BTRFS_CSUM_TREE_OBJECTID
:

1173  
	`bŒfs_g¿b_roÙ
(
	`bŒfs_glob®_roÙ
(
fs_šfo
, &
key
));

1174 
BTRFS_QUOTA_TREE_OBJECTID
:

1175  
	`bŒfs_g¿b_roÙ
(
fs_šfo
->
quÙa_roÙ
);

1176 
BTRFS_UUID_TREE_OBJECTID
:

1177  
	`bŒfs_g¿b_roÙ
(
fs_šfo
->
uuid_roÙ
);

1178 
BTRFS_BLOCK_GROUP_TREE_OBJECTID
:

1179  
	`bŒfs_g¿b_roÙ
(
fs_šfo
->
block_group_roÙ
);

1180 
BTRFS_FREE_SPACE_TREE_OBJECTID
:

1181  
	`bŒfs_g¿b_roÙ
(
	`bŒfs_glob®_roÙ
(
fs_šfo
, &
key
));

1183  
NULL
;

1185 
	}
}

1187 
	$bŒfs_š£¹_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

1188 
bŒfs_roÙ
 *
roÙ
)

1190 
»t
;

1192 
»t
 = 
	`¿dix_Œ“_´–ßd
(
GFP_NOFS
);

1193 ià(
»t
)

1194  
»t
;

1196 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

1197 
»t
 = 
	`¿dix_Œ“_š£¹
(&
fs_šfo
->
fs_roÙs_¿dix
,

1198 ()
roÙ
->
roÙ_key
.
objeùid
,

1199 
roÙ
);

1200 ià(
»t
 == 0) {

1201 
	`bŒfs_g¿b_roÙ
(
roÙ
);

1202 
	`£t_b™
(
BTRFS_ROOT_IN_RADIX
, &
roÙ
->
¡©e
);

1204 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

1205 
	`¿dix_Œ“_´–ßd_’d
();

1207  
»t
;

1208 
	}
}

1210 
	$bŒfs_check_Ëaked_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
)

1212 #ifdeà
CONFIG_BTRFS_DEBUG


1213 
bŒfs_roÙ
 *
roÙ
;

1215 !
	`li¡_em±y
(&
fs_šfo
->
®loÿ‹d_roÙs
)) {

1216 
buf
[
BTRFS_ROOT_NAME_BUF_LEN
];

1218 
roÙ
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
®loÿ‹d_roÙs
,

1219 
bŒfs_roÙ
, 
Ëak_li¡
);

1220 
	`bŒfs_”r
(
fs_šfo
, "leaked„oot %s„efcount %d",

1221 
	`bŒfs_roÙ_Çme
(&
roÙ
->
roÙ_key
, 
buf
),

1222 
	`»fcouÁ_»ad
(&
roÙ
->
»fs
));

1223 
	`»fcouÁ_»ad
(&
roÙ
->
»fs
) > 1)

1224 
	`bŒfs_put_roÙ
(
roÙ
);

1225 
	`bŒfs_put_roÙ
(
roÙ
);

1228 
	}
}

1230 
	$ä“_glob®_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
)

1232 
bŒfs_roÙ
 *
roÙ
;

1233 
rb_node
 *
node
;

1235 (
node
 = 
	`rb_fœ¡_po¡Üd”
(&
fs_šfo
->
glob®_roÙ_Œ“
)è!ğ
NULL
) {

1236 
roÙ
 = 
	`rb_’Œy
(
node
, 
bŒfs_roÙ
, 
rb_node
);

1237 
	`rb_”a£
(&
roÙ
->
rb_node
, &
fs_šfo
->
glob®_roÙ_Œ“
);

1238 
	`bŒfs_put_roÙ
(
roÙ
);

1240 
	}
}

1242 
	$bŒfs_ä“_fs_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
)

1244 
	`³rıu_couÁ”_de¡roy
(&
fs_šfo
->
dœty_m‘ad©a_by‹s
);

1245 
	`³rıu_couÁ”_de¡roy
(&
fs_šfo
->
d–®loc_by‹s
);

1246 
	`³rıu_couÁ”_de¡roy
(&
fs_šfo
->
Üd”ed_by‹s
);

1247 
	`³rıu_couÁ”_de¡roy
(&
fs_šfo
->
dev_»¶aû
.
bio_couÁ”
);

1248 
	`bŒfs_ä“_csum_hash
(
fs_šfo
);

1249 
	`bŒfs_ä“_¡re_hash_bË
(
fs_šfo
);

1250 
	`bŒfs_ä“_»f_ÿche
(
fs_šfo
);

1251 
	`kä“
(
fs_šfo
->
b®ªû_ùl
);

1252 
	`kä“
(
fs_šfo
->
d–ayed_roÙ
);

1253 
	`ä“_glob®_roÙs
(
fs_šfo
);

1254 
	`bŒfs_put_roÙ
(
fs_šfo
->
Œ“_roÙ
);

1255 
	`bŒfs_put_roÙ
(
fs_šfo
->
chunk_roÙ
);

1256 
	`bŒfs_put_roÙ
(
fs_šfo
->
dev_roÙ
);

1257 
	`bŒfs_put_roÙ
(
fs_šfo
->
quÙa_roÙ
);

1258 
	`bŒfs_put_roÙ
(
fs_šfo
->
uuid_roÙ
);

1259 
	`bŒfs_put_roÙ
(
fs_šfo
->
fs_roÙ
);

1260 
	`bŒfs_put_roÙ
(
fs_šfo
->
d©a_»loc_roÙ
);

1261 
	`bŒfs_put_roÙ
(
fs_šfo
->
block_group_roÙ
);

1262 
	`bŒfs_check_Ëaked_roÙs
(
fs_šfo
);

1263 
	`bŒfs_ex‹Á_bufãr_Ëak_debug_check
(
fs_šfo
);

1264 
	`kä“
(
fs_šfo
->
su³r_cİy
);

1265 
	`kä“
(
fs_šfo
->
su³r_fÜ_comm™
);

1266 
	`kä“
(
fs_šfo
->
sub·ge_šfo
);

1267 
	`kvä“
(
fs_šfo
);

1268 
	}
}

1289 
bŒfs_roÙ
 *
	$bŒfs_g‘_roÙ_»f
(
bŒfs_fs_šfo
 *
fs_šfo
,

1290 
u64
 
objeùid
, 
dev_t
 
ªÚ_dev
,

1291 
boŞ
 
check_»f
)

1293 
bŒfs_roÙ
 *
roÙ
;

1294 
bŒfs_·th
 *
·th
;

1295 
bŒfs_key
 
key
;

1296 
»t
;

1298 
roÙ
 = 
	`bŒfs_g‘_glob®_roÙ
(
fs_šfo
, 
objeùid
);

1299 ià(
roÙ
)

1300  
roÙ
;

1309 ià(!
	`is_f¡»e
(
objeùid
è&& objeùid !ğ
BTRFS_DATA_RELOC_TREE_OBJECTID
)

1310  
	`ERR_PTR
(-
ENOENT
);

1311 
agaš
:

1312 
roÙ
 = 
	`bŒfs_lookup_fs_roÙ
(
fs_šfo
, 
objeùid
);

1313 ià(
roÙ
) {

1315 
	`ASSERT
(!
ªÚ_dev
);

1316 ià(
check_»f
 && 
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0) {

1317 
	`bŒfs_put_roÙ
(
roÙ
);

1318  
	`ERR_PTR
(-
ENOENT
);

1320  
roÙ
;

1323 
key
.
objeùid
 = objectid;

1324 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

1325 
key
.
off£t
 = (
u64
)-1;

1326 
roÙ
 = 
	`bŒfs_»ad_Œ“_roÙ
(
fs_šfo
->
Œ“_roÙ
, &
key
);

1327 ià(
	`IS_ERR
(
roÙ
))

1328  
roÙ
;

1330 ià(
check_»f
 && 
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0) {

1331 
»t
 = -
ENOENT
;

1332 
ç
;

1335 
»t
 = 
	`bŒfs_š™_fs_roÙ
(
roÙ
, 
ªÚ_dev
);

1336 ià(
»t
)

1337 
ç
;

1339 
·th
 = 
	`bŒfs_®loc_·th
();

1340 ià(!
·th
) {

1341 
»t
 = -
ENOMEM
;

1342 
ç
;

1344 
key
.
objeùid
 = 
BTRFS_ORPHAN_OBJECTID
;

1345 
key
.
ty³
 = 
BTRFS_ORPHAN_ITEM_KEY
;

1346 
key
.
off£t
 = 
objeùid
;

1348 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_šfo
->
Œ“_roÙ
, &
key
, 
·th
, 0, 0);

1349 
	`bŒfs_ä“_·th
(
·th
);

1350 ià(
»t
 < 0)

1351 
ç
;

1352 ià(
»t
 == 0)

1353 
	`£t_b™
(
BTRFS_ROOT_ORPHAN_ITEM_INSERTED
, &
roÙ
->
¡©e
);

1355 
»t
 = 
	`bŒfs_š£¹_fs_roÙ
(
fs_šfo
, 
roÙ
);

1356 ià(
»t
) {

1357 ià(
»t
 =ğ-
EEXIST
) {

1358 
	`bŒfs_put_roÙ
(
roÙ
);

1359 
agaš
;

1361 
ç
;

1363  
roÙ
;

1364 
ç
:

1371 ià(
ªÚ_dev
)

1372 
roÙ
->
ªÚ_dev
 = 0;

1373 
	`bŒfs_put_roÙ
(
roÙ
);

1374  
	`ERR_PTR
(
»t
);

1375 
	}
}

1384 
bŒfs_roÙ
 *
	$bŒfs_g‘_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

1385 
u64
 
objeùid
, 
boŞ
 
check_»f
)

1387  
	`bŒfs_g‘_roÙ_»f
(
fs_šfo
, 
objeùid
, 0, 
check_»f
);

1388 
	}
}

1398 
bŒfs_roÙ
 *
	$bŒfs_g‘_Ãw_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

1399 
u64
 
objeùid
, 
dev_t
 
ªÚ_dev
)

1401  
	`bŒfs_g‘_roÙ_»f
(
fs_šfo
, 
objeùid
, 
ªÚ_dev
, 
Œue
);

1402 
	}
}

1418 
bŒfs_roÙ
 *
	$bŒfs_g‘_fs_roÙ_comm™_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

1419 
bŒfs_·th
 *
·th
,

1420 
u64
 
objeùid
)

1422 
bŒfs_roÙ
 *
roÙ
;

1423 
bŒfs_key
 
key
;

1425 
	`ASSERT
(
·th
->
£¬ch_comm™_roÙ
 &&…©h->
sk_lockšg
);

1433 
roÙ
 = 
	`bŒfs_g‘_glob®_roÙ
(
fs_šfo
, 
objeùid
);

1434 ià(
roÙ
)

1435  
roÙ
;

1437 
roÙ
 = 
	`bŒfs_lookup_fs_roÙ
(
fs_šfo
, 
objeùid
);

1438 ià(
roÙ
)

1439  
roÙ
;

1441 
key
.
objeùid
 = objectid;

1442 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

1443 
key
.
off£t
 = (
u64
)-1;

1444 
roÙ
 = 
	`»ad_Œ“_roÙ_·th
(
fs_šfo
->
Œ“_roÙ
, 
·th
, &
key
);

1445 
	`bŒfs_»Ëa£_·th
(
·th
);

1447  
roÙ
;

1448 
	}
}

1450 
	$ş—Ãr_kth»ad
(*
¬g
)

1452 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¬g
;

1453 
agaš
;

1456 
agaš
 = 0;

1458 
	`£t_b™
(
BTRFS_FS_CLEANER_RUNNING
, &
fs_šfo
->
æags
);

1461 ià(
	`bŒfs_Ãed_ş—Ãr_¦“p
(
fs_šfo
))

1462 
¦“p
;

1468 ià(!
	`‹¡_b™
(
BTRFS_FS_OPEN
, &
fs_šfo
->
æags
))

1469 
¦“p
;

1471 ià(!
	`mu‹x_Œylock
(&
fs_šfo
->
ş—Ãr_mu‹x
))

1472 
¦“p
;

1478 ià(
	`bŒfs_Ãed_ş—Ãr_¦“p
(
fs_šfo
)) {

1479 
	`mu‹x_uÆock
(&
fs_šfo
->
ş—Ãr_mu‹x
);

1480 
¦“p
;

1483 ià(
	`‹¡_ªd_ş—r_b™
(
BTRFS_FS_FEATURE_CHANGED
, &
fs_šfo
->
æags
))

1484 
	`bŒfs_sysfs_ã©u»_upd©e
(
fs_šfo
);

1486 
	`bŒfs_run_d–ayed_uts
(
fs_šfo
);

1488 
agaš
 = 
	`bŒfs_ş—n_Úe_d–‘ed_¢­shÙ
(
fs_šfo
);

1489 
	`mu‹x_uÆock
(&
fs_šfo
->
ş—Ãr_mu‹x
);

1495 
	`bŒfs_run_deäag_šodes
(
fs_šfo
);

1505 
	`bŒfs_d–‘e_unu£d_bgs
(
fs_šfo
);

1512 
	`bŒfs_»şaim_bgs
(
fs_šfo
);

1513 
¦“p
:

1514 
	`ş—r_ªd_wake_up_b™
(
BTRFS_FS_CLEANER_RUNNING
, &
fs_šfo
->
æags
);

1515 ià(
	`kth»ad_should_·rk
())

1516 
	`kth»ad_·rkme
();

1517 ià(
	`kth»ad_should_¡İ
())

1519 ià(!
agaš
) {

1520 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

1521 
	`scheduË
();

1522 
	`__£t_cu¼’t_¡©e
(
TASK_RUNNING
);

1525 
	}
}

1527 
	$Œª§ùiÚ_kth»ad
(*
¬g
)

1529 
bŒfs_roÙ
 *
roÙ
 = 
¬g
;

1530 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1531 
bŒfs_Œªs_hªdË
 *
Œªs
;

1532 
bŒfs_Œª§ùiÚ
 *
cur
;

1533 
u64
 
Œªsid
;

1534 
time64_t
 
d–
;

1535 
d–ay
;

1536 
boŞ
 
ÿÂÙ_comm™
;

1539 
ÿÂÙ_comm™
 = 
çl£
;

1540 
d–ay
 = 
	`m£cs_to_jiff›s
(
fs_šfo
->
comm™_š‹rv®
 * 1000);

1541 
	`mu‹x_lock
(&
fs_šfo
->
Œª§ùiÚ_kth»ad_mu‹x
);

1543 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

1544 
cur
 = 
fs_šfo
->
ruÂšg_Œª§ùiÚ
;

1545 ià(!
cur
) {

1546 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1547 
¦“p
;

1550 
d–
 = 
	`ktime_g‘_£cÚds
(è- 
cur
->
¡¬t_time
;

1551 ià(!
	`‹¡_ªd_ş—r_b™
(
BTRFS_FS_COMMIT_TRANS
, &
fs_šfo
->
æags
) &&

1552 
cur
->
¡©e
 < 
TRANS_STATE_COMMIT_PREP
 &&

1553 
d–
 < 
fs_šfo
->
comm™_š‹rv®
) {

1554 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1555 
d–ay
 -ğ
	`m£cs_to_jiff›s
((
d–
 - 1) * 1000);

1556 
d–ay
 = 
	`mš
(delay,

1557 
	`m£cs_to_jiff›s
(
fs_šfo
->
comm™_š‹rv®
 * 1000));

1558 
¦“p
;

1560 
Œªsid
 = 
cur
->transid;

1561 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1564 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ
(
roÙ
);

1565 ià(
	`IS_ERR
(
Œªs
)) {

1566 ià(
	`PTR_ERR
(
Œªs
è!ğ-
ENOENT
)

1567 
ÿÂÙ_comm™
 = 
Œue
;

1568 
¦“p
;

1570 ià(
Œªsid
 =ğ
Œªs
->transid) {

1571 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1573 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1575 
¦“p
:

1576 
	`wake_up_´oûss
(
fs_šfo
->
ş—Ãr_kth»ad
);

1577 
	`mu‹x_uÆock
(&
fs_šfo
->
Œª§ùiÚ_kth»ad_mu‹x
);

1579 ià(
	`BTRFS_FS_ERROR
(
fs_šfo
))

1580 
	`bŒfs_ş—nup_Œª§ùiÚ
(
fs_šfo
);

1581 ià(!
	`kth»ad_should_¡İ
() &&

1582 (!
	`bŒfs_Œª§ùiÚ_blocked
(
fs_šfo
) ||

1583 
ÿÂÙ_comm™
))

1584 
	`scheduË_timeout_š‹¼u±ibË
(
d–ay
);

1585 } !
	`kth»ad_should_¡İ
());

1587 
	}
}

1598 
	$fšd_Ãwe¡_su³r_backup
(
bŒfs_fs_šfo
 *
šfo
)

1600 cÚ¡ 
u64
 
Ãwe¡_g’
 = 
	`bŒfs_su³r_g’”©iÚ
(
šfo
->
su³r_cİy
);

1601 
u64
 
cur
;

1602 
bŒfs_roÙ_backup
 *
roÙ_backup
;

1603 
i
;

1605 
i
 = 0; i < 
BTRFS_NUM_BACKUP_ROOTS
; i++) {

1606 
roÙ_backup
 = 
šfo
->
su³r_cİy
->
su³r_roÙs
 + 
i
;

1607 
cur
 = 
	`bŒfs_backup_Œ“_roÙ_g’
(
roÙ_backup
);

1608 ià(
cur
 =ğ
Ãwe¡_g’
)

1609  
i
;

1612  -
EINVAL
;

1613 
	}
}

1620 
	$backup_su³r_roÙs
(
bŒfs_fs_šfo
 *
šfo
)

1622 cÚ¡ 
Ãxt_backup
 = 
šfo
->
backup_roÙ_šdex
;

1623 
bŒfs_roÙ_backup
 *
roÙ_backup
;

1625 
roÙ_backup
 = 
šfo
->
su³r_fÜ_comm™
->
su³r_roÙs
 + 
Ãxt_backup
;

1631 
	`mem£t
(
roÙ_backup
, 0, (*root_backup));

1633 
šfo
->
backup_roÙ_šdex
 = (
Ãxt_backup
 + 1è% 
BTRFS_NUM_BACKUP_ROOTS
;

1635 
	`bŒfs_£t_backup_Œ“_roÙ
(
roÙ_backup
, 
šfo
->
Œ“_roÙ
->
node
->
¡¬t
);

1636 
	`bŒfs_£t_backup_Œ“_roÙ_g’
(
roÙ_backup
,

1637 
	`bŒfs_h—d”_g’”©iÚ
(
šfo
->
Œ“_roÙ
->
node
));

1639 
	`bŒfs_£t_backup_Œ“_roÙ_Ëv–
(
roÙ_backup
,

1640 
	`bŒfs_h—d”_Ëv–
(
šfo
->
Œ“_roÙ
->
node
));

1642 
	`bŒfs_£t_backup_chunk_roÙ
(
roÙ_backup
, 
šfo
->
chunk_roÙ
->
node
->
¡¬t
);

1643 
	`bŒfs_£t_backup_chunk_roÙ_g’
(
roÙ_backup
,

1644 
	`bŒfs_h—d”_g’”©iÚ
(
šfo
->
chunk_roÙ
->
node
));

1645 
	`bŒfs_£t_backup_chunk_roÙ_Ëv–
(
roÙ_backup
,

1646 
	`bŒfs_h—d”_Ëv–
(
šfo
->
chunk_roÙ
->
node
));

1648 ià(!
	`bŒfs_fs_com·t_ro
(
šfo
, 
BLOCK_GROUP_TREE
)) {

1649 
bŒfs_roÙ
 *
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
šfo
, 0);

1650 
bŒfs_roÙ
 *
csum_roÙ
 = 
	`bŒfs_csum_roÙ
(
šfo
, 0);

1652 
	`bŒfs_£t_backup_ex‹Á_roÙ
(
roÙ_backup
,

1653 
ex‹Á_roÙ
->
node
->
¡¬t
);

1654 
	`bŒfs_£t_backup_ex‹Á_roÙ_g’
(
roÙ_backup
,

1655 
	`bŒfs_h—d”_g’”©iÚ
(
ex‹Á_roÙ
->
node
));

1656 
	`bŒfs_£t_backup_ex‹Á_roÙ_Ëv–
(
roÙ_backup
,

1657 
	`bŒfs_h—d”_Ëv–
(
ex‹Á_roÙ
->
node
));

1659 
	`bŒfs_£t_backup_csum_roÙ
(
roÙ_backup
, 
csum_roÙ
->
node
->
¡¬t
);

1660 
	`bŒfs_£t_backup_csum_roÙ_g’
(
roÙ_backup
,

1661 
	`bŒfs_h—d”_g’”©iÚ
(
csum_roÙ
->
node
));

1662 
	`bŒfs_£t_backup_csum_roÙ_Ëv–
(
roÙ_backup
,

1663 
	`bŒfs_h—d”_Ëv–
(
csum_roÙ
->
node
));

1670 ià(
šfo
->
fs_roÙ
 && info->fs_roÙ->
node
) {

1671 
	`bŒfs_£t_backup_fs_roÙ
(
roÙ_backup
,

1672 
šfo
->
fs_roÙ
->
node
->
¡¬t
);

1673 
	`bŒfs_£t_backup_fs_roÙ_g’
(
roÙ_backup
,

1674 
	`bŒfs_h—d”_g’”©iÚ
(
šfo
->
fs_roÙ
->
node
));

1675 
	`bŒfs_£t_backup_fs_roÙ_Ëv–
(
roÙ_backup
,

1676 
	`bŒfs_h—d”_Ëv–
(
šfo
->
fs_roÙ
->
node
));

1679 
	`bŒfs_£t_backup_dev_roÙ
(
roÙ_backup
, 
šfo
->
dev_roÙ
->
node
->
¡¬t
);

1680 
	`bŒfs_£t_backup_dev_roÙ_g’
(
roÙ_backup
,

1681 
	`bŒfs_h—d”_g’”©iÚ
(
šfo
->
dev_roÙ
->
node
));

1682 
	`bŒfs_£t_backup_dev_roÙ_Ëv–
(
roÙ_backup
,

1683 
	`bŒfs_h—d”_Ëv–
(
šfo
->
dev_roÙ
->
node
));

1685 
	`bŒfs_£t_backup_tÙ®_by‹s
(
roÙ_backup
,

1686 
	`bŒfs_su³r_tÙ®_by‹s
(
šfo
->
su³r_cİy
));

1687 
	`bŒfs_£t_backup_by‹s_u£d
(
roÙ_backup
,

1688 
	`bŒfs_su³r_by‹s_u£d
(
šfo
->
su³r_cİy
));

1689 
	`bŒfs_£t_backup_num_deviûs
(
roÙ_backup
,

1690 
	`bŒfs_su³r_num_deviûs
(
šfo
->
su³r_cİy
));

1696 
	`memıy
(&
šfo
->
su³r_cİy
->
su³r_roÙs
,

1697 &
šfo
->
su³r_fÜ_comm™
->
su³r_roÙs
,

1698 (*
roÙ_backup
è* 
BTRFS_NUM_BACKUP_ROOTS
);

1699 
	}
}

1710 
	$»ad_backup_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u8
 
´iÜ™y
)

1712 
backup_šdex
 = 
	`fšd_Ãwe¡_su³r_backup
(
fs_šfo
);

1713 
bŒfs_su³r_block
 *
su³r
 = 
fs_šfo
->
su³r_cİy
;

1714 
bŒfs_roÙ_backup
 *
roÙ_backup
;

1716 ià(
´iÜ™y
 < 
BTRFS_NUM_BACKUP_ROOTS
 && 
backup_šdex
 >= 0) {

1717 ià(
´iÜ™y
 == 0)

1718  
backup_šdex
;

1720 
backup_šdex
 = backup_šdex + 
BTRFS_NUM_BACKUP_ROOTS
 - 
´iÜ™y
;

1721 
backup_šdex
 %ğ
BTRFS_NUM_BACKUP_ROOTS
;

1723  -
EINVAL
;

1726 
roÙ_backup
 = 
su³r
->
su³r_roÙs
 + 
backup_šdex
;

1728 
	`bŒfs_£t_su³r_g’”©iÚ
(
su³r
,

1729 
	`bŒfs_backup_Œ“_roÙ_g’
(
roÙ_backup
));

1730 
	`bŒfs_£t_su³r_roÙ
(
su³r
, 
	`bŒfs_backup_Œ“_roÙ
(
roÙ_backup
));

1731 
	`bŒfs_£t_su³r_roÙ_Ëv–
(
su³r
,

1732 
	`bŒfs_backup_Œ“_roÙ_Ëv–
(
roÙ_backup
));

1733 
	`bŒfs_£t_su³r_by‹s_u£d
(
su³r
, 
	`bŒfs_backup_by‹s_u£d
(
roÙ_backup
));

1739 
	`bŒfs_£t_su³r_tÙ®_by‹s
(
su³r
, 
	`bŒfs_backup_tÙ®_by‹s
(
roÙ_backup
));

1740 
	`bŒfs_£t_su³r_num_deviûs
(
su³r
, 
	`bŒfs_backup_num_deviûs
(
roÙ_backup
));

1742  
backup_šdex
;

1743 
	}
}

1746 
	$bŒfs_¡İ_®l_wÜk”s
(
bŒfs_fs_šfo
 *
fs_šfo
)

1748 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
fixup_wÜk”s
);

1749 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
d–®loc_wÜk”s
);

1750 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
wÜk”s
);

1751 ià(
fs_šfo
->
’dio_wÜk”s
)

1752 
	`de¡roy_wÜkqueue
(
fs_šfo
->
’dio_wÜk”s
);

1753 ià(
fs_šfo
->
rmw_wÜk”s
)

1754 
	`de¡roy_wÜkqueue
(
fs_šfo
->
rmw_wÜk”s
);

1755 ià(
fs_šfo
->
com´es£d_wr™e_wÜk”s
)

1756 
	`de¡roy_wÜkqueue
(
fs_šfo
->
com´es£d_wr™e_wÜk”s
);

1757 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
’dio_wr™e_wÜk”s
);

1758 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
’dio_ä“¥aû_wÜk”
);

1759 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
d–ayed_wÜk”s
);

1760 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
ÿchšg_wÜk”s
);

1761 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
æush_wÜk”s
);

1762 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
qgroup_»sÿn_wÜk”s
);

1763 ià(
fs_šfo
->
disÿrd_ùl
.
disÿrd_wÜk”s
)

1764 
	`de¡roy_wÜkqueue
(
fs_šfo
->
disÿrd_ùl
.
disÿrd_wÜk”s
);

1770 ià(
fs_šfo
->
’dio_m‘a_wÜk”s
)

1771 
	`de¡roy_wÜkqueue
(
fs_šfo
->
’dio_m‘a_wÜk”s
);

1772 
	}
}

1774 
	$ä“_roÙ_ex‹Á_bufãrs
(
bŒfs_roÙ
 *
roÙ
)

1776 ià(
roÙ
) {

1777 
	`ä“_ex‹Á_bufãr
(
roÙ
->
node
);

1778 
	`ä“_ex‹Á_bufãr
(
roÙ
->
comm™_roÙ
);

1779 
roÙ
->
node
 = 
NULL
;

1780 
roÙ
->
comm™_roÙ
 = 
NULL
;

1782 
	}
}

1784 
	$ä“_glob®_roÙ_poš‹rs
(
bŒfs_fs_šfo
 *
fs_šfo
)

1786 
bŒfs_roÙ
 *
roÙ
, *
tmp
;

1788 
	`rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
roÙ
, 
tmp
,

1789 &
fs_šfo
->
glob®_roÙ_Œ“
,

1790 
rb_node
)

1791 
	`ä“_roÙ_ex‹Á_bufãrs
(
roÙ
);

1792 
	}
}

1795 
	$ä“_roÙ_poš‹rs
(
bŒfs_fs_šfo
 *
šfo
, 
boŞ
 
ä“_chunk_roÙ
)

1797 
	`ä“_roÙ_ex‹Á_bufãrs
(
šfo
->
Œ“_roÙ
);

1799 
	`ä“_glob®_roÙ_poš‹rs
(
šfo
);

1800 
	`ä“_roÙ_ex‹Á_bufãrs
(
šfo
->
dev_roÙ
);

1801 
	`ä“_roÙ_ex‹Á_bufãrs
(
šfo
->
quÙa_roÙ
);

1802 
	`ä“_roÙ_ex‹Á_bufãrs
(
šfo
->
uuid_roÙ
);

1803 
	`ä“_roÙ_ex‹Á_bufãrs
(
šfo
->
fs_roÙ
);

1804 
	`ä“_roÙ_ex‹Á_bufãrs
(
šfo
->
d©a_»loc_roÙ
);

1805 
	`ä“_roÙ_ex‹Á_bufãrs
(
šfo
->
block_group_roÙ
);

1806 ià(
ä“_chunk_roÙ
)

1807 
	`ä“_roÙ_ex‹Á_bufãrs
(
šfo
->
chunk_roÙ
);

1808 
	}
}

1810 
	$bŒfs_put_roÙ
(
bŒfs_roÙ
 *
roÙ
)

1812 ià(!
roÙ
)

1815 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
roÙ
->
»fs
)) {

1816 
	`WARN_ON
(!
	`RB_EMPTY_ROOT
(&
roÙ
->
šode_Œ“
));

1817 
	`WARN_ON
(
	`‹¡_b™
(
BTRFS_ROOT_DEAD_RELOC_TREE
, &
roÙ
->
¡©e
));

1818 ià(
roÙ
->
ªÚ_dev
)

1819 
	`ä“_ªÚ_bdev
(
roÙ
->
ªÚ_dev
);

1820 
	`ä“_roÙ_ex‹Á_bufãrs
(
roÙ
);

1821 #ifdeà
CONFIG_BTRFS_DEBUG


1822 
	`¥š_lock
(&
roÙ
->
fs_šfo
->
fs_roÙs_¿dix_lock
);

1823 
	`li¡_d–_š™
(&
roÙ
->
Ëak_li¡
);

1824 
	`¥š_uÆock
(&
roÙ
->
fs_šfo
->
fs_roÙs_¿dix_lock
);

1826 
	`kä“
(
roÙ
);

1828 
	}
}

1830 
	$bŒfs_ä“_fs_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
)

1832 
»t
;

1833 
bŒfs_roÙ
 *
gªg
[8];

1834 
i
;

1836 !
	`li¡_em±y
(&
fs_šfo
->
d—d_roÙs
)) {

1837 
gªg
[0] = 
	`li¡_’Œy
(
fs_šfo
->
d—d_roÙs
.
Ãxt
,

1838 
bŒfs_roÙ
, 
roÙ_li¡
);

1839 
	`li¡_d–
(&
gªg
[0]->
roÙ_li¡
);

1841 ià(
	`‹¡_b™
(
BTRFS_ROOT_IN_RADIX
, &
gªg
[0]->
¡©e
))

1842 
	`bŒfs_drİ_ªd_ä“_fs_roÙ
(
fs_šfo
, 
gªg
[0]);

1843 
	`bŒfs_put_roÙ
(
gªg
[0]);

1847 
»t
 = 
	`¿dix_Œ“_gªg_lookup
(&
fs_šfo
->
fs_roÙs_¿dix
,

1848 (**)
gªg
, 0,

1849 
	`ARRAY_SIZE
(
gªg
));

1850 ià(!
»t
)

1852 
i
 = 0; i < 
»t
; i++)

1853 
	`bŒfs_drİ_ªd_ä“_fs_roÙ
(
fs_šfo
, 
gªg
[
i
]);

1855 
	}
}

1857 
	$bŒfs_š™_süub
(
bŒfs_fs_šfo
 *
fs_šfo
)

1859 
	`mu‹x_š™
(&
fs_šfo
->
süub_lock
);

1860 
	`©omic_£t
(&
fs_šfo
->
süubs_ruÂšg
, 0);

1861 
	`©omic_£t
(&
fs_šfo
->
süub_·u£_»q
, 0);

1862 
	`©omic_£t
(&
fs_šfo
->
süubs_·u£d
, 0);

1863 
	`©omic_£t
(&
fs_šfo
->
süub_ÿnûl_»q
, 0);

1864 
	`š™_wa™queue_h—d
(&
fs_šfo
->
süub_·u£_wa™
);

1865 
	`»fcouÁ_£t
(&
fs_šfo
->
süub_wÜk”s_»fút
, 0);

1866 
	}
}

1868 
	$bŒfs_š™_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
)

1870 
	`¥š_lock_š™
(&
fs_šfo
->
b®ªû_lock
);

1871 
	`mu‹x_š™
(&
fs_šfo
->
b®ªû_mu‹x
);

1872 
	`©omic_£t
(&
fs_šfo
->
b®ªû_·u£_»q
, 0);

1873 
	`©omic_£t
(&
fs_šfo
->
b®ªû_ÿnûl_»q
, 0);

1874 
fs_šfo
->
b®ªû_ùl
 = 
NULL
;

1875 
	`š™_wa™queue_h—d
(&
fs_šfo
->
b®ªû_wa™_q
);

1876 
	`©omic_£t
(&
fs_šfo
->
»loc_ÿnûl_»q
, 0);

1877 
	}
}

1879 
	$bŒfs_š™_bŒ“_šode
(
su³r_block
 *
sb
)

1881 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

1882 
hash
 = 
	`bŒfs_šode_hash
(
BTRFS_BTREE_INODE_OBJECTID
,

1883 
fs_šfo
->
Œ“_roÙ
);

1884 
šode
 *inode;

1886 
šode
 = 
	`Ãw_šode
(
sb
);

1887 ià(!
šode
)

1888  -
ENOMEM
;

1890 
šode
->
i_šo
 = 
BTRFS_BTREE_INODE_OBJECTID
;

1891 
	`£t_Æšk
(
šode
, 1);

1897 
šode
->
i_size
 = 
OFFSET_MAX
;

1898 
šode
->
i_m­pšg
->
a_İs
 = &
bŒ“_aİs
;

1899 
	`m­pšg_£t_gå_mask
(
šode
->
i_m­pšg
, 
GFP_NOFS
);

1901 
	`RB_CLEAR_NODE
(&
	`BTRFS_I
(
šode
)->
rb_node
);

1902 
	`ex‹Á_io_Œ“_š™
(
fs_šfo
, &
	`BTRFS_I
(
šode
)->
io_Œ“
,

1903 
IO_TREE_BTREE_INODE_IO
);

1904 
	`ex‹Á_m­_Œ“_š™
(&
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
);

1906 
	`BTRFS_I
(
šode
)->
roÙ
 = 
	`bŒfs_g¿b_roÙ
(
fs_šfo
->
Œ“_roÙ
);

1907 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
objeùid
 = 
BTRFS_BTREE_INODE_OBJECTID
;

1908 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
ty³
 = 0;

1909 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
off£t
 = 0;

1910 
	`£t_b™
(
BTRFS_INODE_DUMMY
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

1911 
	`__š£¹_šode_hash
(
šode
, 
hash
);

1912 
fs_šfo
->
bŒ“_šode
 = 
šode
;

1915 
	}
}

1917 
	$bŒfs_š™_dev_»¶aû_locks
(
bŒfs_fs_šfo
 *
fs_šfo
)

1919 
	`mu‹x_š™
(&
fs_šfo
->
dev_»¶aû
.
lock_fšishšg_ÿnûl_unmouÁ
);

1920 
	`š™_rw£m
(&
fs_šfo
->
dev_»¶aû
.
rw£m
);

1921 
	`š™_wa™queue_h—d
(&
fs_šfo
->
dev_»¶aû
.
»¶aû_wa™
);

1922 
	}
}

1924 
	$bŒfs_š™_qgroup
(
bŒfs_fs_šfo
 *
fs_šfo
)

1926 
	`¥š_lock_š™
(&
fs_šfo
->
qgroup_lock
);

1927 
	`mu‹x_š™
(&
fs_šfo
->
qgroup_ioùl_lock
);

1928 
fs_šfo
->
qgroup_Œ“
 = 
RB_ROOT
;

1929 
	`INIT_LIST_HEAD
(&
fs_šfo
->
dœty_qgroups
);

1930 
fs_šfo
->
qgroup_£q
 = 1;

1931 
fs_šfo
->
qgroup_uli¡
 = 
NULL
;

1932 
fs_šfo
->
qgroup_»sÿn_ruÂšg
 = 
çl£
;

1933 
fs_šfo
->
qgroup_drİ_subŒ“_th»s
 = 
BTRFS_MAX_LEVEL
;

1934 
	`mu‹x_š™
(&
fs_šfo
->
qgroup_»sÿn_lock
);

1935 
	}
}

1937 
	$bŒfs_š™_wÜkqueues
(
bŒfs_fs_šfo
 *
fs_šfo
)

1939 
u32
 
max_aùive
 = 
fs_šfo
->
th»ad_poŞ_size
;

1940 
æags
 = 
WQ_MEM_RECLAIM
 | 
WQ_FREEZABLE
 | 
WQ_UNBOUND
;

1941 
Üd”ed_æags
 = 
WQ_MEM_RECLAIM
 | 
WQ_FREEZABLE
;

1943 
fs_šfo
->
wÜk”s
 =

1944 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "wÜk”", 
æags
, 
max_aùive
, 16);

1946 
fs_šfo
->
d–®loc_wÜk”s
 =

1947 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "delalloc",

1948 
æags
, 
max_aùive
, 2);

1950 
fs_šfo
->
æush_wÜk”s
 =

1951 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "flush_delalloc",

1952 
æags
, 
max_aùive
, 0);

1954 
fs_šfo
->
ÿchšg_wÜk”s
 =

1955 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "ÿche", 
æags
, 
max_aùive
, 0);

1957 
fs_šfo
->
fixup_wÜk”s
 =

1958 
	`bŒfs_®loc_Üd”ed_wÜkqueue
(
fs_šfo
, "fixup", 
Üd”ed_æags
);

1960 
fs_šfo
->
’dio_wÜk”s
 =

1961 
	`®loc_wÜkqueue
("bŒfs-’dio", 
æags
, 
max_aùive
);

1962 
fs_šfo
->
’dio_m‘a_wÜk”s
 =

1963 
	`®loc_wÜkqueue
("bŒfs-’dio-m‘a", 
æags
, 
max_aùive
);

1964 
fs_šfo
->
rmw_wÜk”s
 = 
	`®loc_wÜkqueue
("bŒfs-rmw", 
æags
, 
max_aùive
);

1965 
fs_šfo
->
’dio_wr™e_wÜk”s
 =

1966 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "’dio-wr™e", 
æags
,

1967 
max_aùive
, 2);

1968 
fs_šfo
->
com´es£d_wr™e_wÜk”s
 =

1969 
	`®loc_wÜkqueue
("bŒfs-com´es£d-wr™e", 
æags
, 
max_aùive
);

1970 
fs_šfo
->
’dio_ä“¥aû_wÜk”
 =

1971 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "ä“¥aû-wr™e", 
æags
,

1972 
max_aùive
, 0);

1973 
fs_šfo
->
d–ayed_wÜk”s
 =

1974 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "d–ayed-m‘a", 
æags
,

1975 
max_aùive
, 0);

1976 
fs_šfo
->
qgroup_»sÿn_wÜk”s
 =

1977 
	`bŒfs_®loc_Üd”ed_wÜkqueue
(
fs_šfo
, "qgroup-rescan",

1978 
Üd”ed_æags
);

1979 
fs_šfo
->
disÿrd_ùl
.
disÿrd_wÜk”s
 =

1980 
	`®loc_Üd”ed_wÜkqueue
("bŒfs_disÿrd", 
WQ_FREEZABLE
);

1982 ià(!(
fs_šfo
->
wÜk”s
 &&

1983 
fs_šfo
->
d–®loc_wÜk”s
 && fs_šfo->
æush_wÜk”s
 &&

1984 
fs_šfo
->
’dio_wÜk”s
 && fs_šfo->
’dio_m‘a_wÜk”s
 &&

1985 
fs_šfo
->
com´es£d_wr™e_wÜk”s
 &&

1986 
fs_šfo
->
’dio_wr™e_wÜk”s
 &&

1987 
fs_šfo
->
’dio_ä“¥aû_wÜk”
 && fs_šfo->
rmw_wÜk”s
 &&

1988 
fs_šfo
->
ÿchšg_wÜk”s
 && fs_šfo->
fixup_wÜk”s
 &&

1989 
fs_šfo
->
d–ayed_wÜk”s
 && fs_šfo->
qgroup_»sÿn_wÜk”s
 &&

1990 
fs_šfo
->
disÿrd_ùl
.
disÿrd_wÜk”s
)) {

1991  -
ENOMEM
;

1995 
	}
}

1997 
	$bŒfs_š™_csum_hash
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u16
 
csum_ty³
)

1999 
üy±o_shash
 *
csum_shash
;

2000 cÚ¡ *
csum_driv”
 = 
	`bŒfs_su³r_csum_driv”
(
csum_ty³
);

2002 
csum_shash
 = 
	`üy±o_®loc_shash
(
csum_driv”
, 0, 0);

2004 ià(
	`IS_ERR
(
csum_shash
)) {

2005 
	`bŒfs_”r
(
fs_šfo
, "error‡llocating %s hash for checksum",

2006 
csum_driv”
);

2007  
	`PTR_ERR
(
csum_shash
);

2010 
fs_šfo
->
csum_shash
 = csum_shash;

2017 
csum_ty³
) {

2018 
BTRFS_CSUM_TYPE_CRC32
:

2019 ià(!
	`¡r¡r
(
	`üy±o_shash_driv”_Çme
(
csum_shash
), "generic"))

2020 
	`£t_b™
(
BTRFS_FS_CSUM_IMPL_FAST
, &
fs_šfo
->
æags
);

2022 
BTRFS_CSUM_TYPE_XXHASH
:

2023 
	`£t_b™
(
BTRFS_FS_CSUM_IMPL_FAST
, &
fs_šfo
->
æags
);

2029 
	`bŒfs_šfo
(
fs_šfo
, "using %s (%s) checksum‡lgorithm",

2030 
	`bŒfs_su³r_csum_Çme
(
csum_ty³
),

2031 
	`üy±o_shash_driv”_Çme
(
csum_shash
));

2033 
	}
}

2035 
	$bŒfs_»¶ay_log
(
bŒfs_fs_šfo
 *
fs_šfo
,

2036 
bŒfs_fs_deviûs
 *
fs_deviûs
)

2038 
»t
;

2039 
bŒfs_Œ“_·»Á_check
 
check
 = { 0 };

2040 
bŒfs_roÙ
 *
log_Œ“_roÙ
;

2041 
bŒfs_su³r_block
 *
disk_su³r
 = 
fs_šfo
->
su³r_cİy
;

2042 
u64
 
by‹Ä
 = 
	`bŒfs_su³r_log_roÙ
(
disk_su³r
);

2043 
Ëv–
 = 
	`bŒfs_su³r_log_roÙ_Ëv–
(
disk_su³r
);

2045 ià(
fs_deviûs
->
rw_deviûs
 == 0) {

2046 
	`bŒfs_w¬n
(
fs_šfo
, "log„eplay„equired on RO media");

2047  -
EIO
;

2050 
log_Œ“_roÙ
 = 
	`bŒfs_®loc_roÙ
(
fs_šfo
, 
BTRFS_TREE_LOG_OBJECTID
,

2051 
GFP_KERNEL
);

2052 ià(!
log_Œ“_roÙ
)

2053  -
ENOMEM
;

2055 
check
.
Ëv–
 =†evel;

2056 
check
.
Œªsid
 = 
fs_šfo
->
g’”©iÚ
 + 1;

2057 
check
.
owÃr_roÙ
 = 
BTRFS_TREE_LOG_OBJECTID
;

2058 
log_Œ“_roÙ
->
node
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
by‹Ä
, &
check
);

2059 ià(
	`IS_ERR
(
log_Œ“_roÙ
->
node
)) {

2060 
	`bŒfs_w¬n
(
fs_šfo
, "failedo„ead†ogree");

2061 
»t
 = 
	`PTR_ERR
(
log_Œ“_roÙ
->
node
);

2062 
log_Œ“_roÙ
->
node
 = 
NULL
;

2063 
	`bŒfs_put_roÙ
(
log_Œ“_roÙ
);

2064  
»t
;

2066 ià(!
	`ex‹Á_bufãr_u±od©e
(
log_Œ“_roÙ
->
node
)) {

2067 
	`bŒfs_”r
(
fs_šfo
, "failedo„ead†ogree");

2068 
	`bŒfs_put_roÙ
(
log_Œ“_roÙ
);

2069  -
EIO
;

2073 
»t
 = 
	`bŒfs_»cov”_log_Œ“s
(
log_Œ“_roÙ
);

2074 ià(
»t
) {

2075 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

2077 
	`bŒfs_put_roÙ
(
log_Œ“_roÙ
);

2078  
»t
;

2081 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
)) {

2082 
»t
 = 
	`bŒfs_comm™_su³r
(
fs_šfo
);

2083 ià(
»t
)

2084  
»t
;

2088 
	}
}

2090 
	$lßd_glob®_roÙs_objeùid
(
bŒfs_roÙ
 *
Œ“_roÙ
,

2091 
bŒfs_·th
 *
·th
, 
u64
 
objeùid
,

2092 cÚ¡ *
Çme
)

2094 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œ“_roÙ
->fs_info;

2095 
bŒfs_roÙ
 *
roÙ
;

2096 
u64
 
max_glob®_id
 = 0;

2097 
»t
;

2098 
bŒfs_key
 
key
 = {

2099 .
objeùid
 = objectid,

2100 .
ty³
 = 
BTRFS_ROOT_ITEM_KEY
,

2101 .
off£t
 = 0,

2103 
boŞ
 
found
 = 
çl£
;

2106 ià(
objeùid
 =ğ
BTRFS_CSUM_TREE_OBJECTID
 &&

2107 
	`bŒfs_‹¡_İt
(
fs_šfo
, 
IGNOREDATACSUMS
)) {

2108 
	`£t_b™
(
BTRFS_FS_STATE_NO_CSUMS
, &
fs_šfo
->
fs_¡©e
);

2113 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
Œ“_roÙ
, &
key
, 
·th
, 0, 0);

2114 ià(
»t
 < 0)

2117 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0])) {

2118 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
Œ“_roÙ
, 
·th
);

2119 ià(
»t
) {

2120 ià(
»t
 > 0)

2121 
»t
 = 0;

2125 
»t
 = 0;

2127 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

2128 ià(
key
.
objeùid
 != objectid)

2130 
	`bŒfs_»Ëa£_·th
(
·th
);

2136 ià(
objeùid
 =ğ
BTRFS_EXTENT_TREE_OBJECTID
)

2137 
max_glob®_id
 = 
	`max
(max_glob®_id, 
key
.
off£t
);

2139 
found
 = 
Œue
;

2140 
roÙ
 = 
	`»ad_Œ“_roÙ_·th
(
Œ“_roÙ
, 
·th
, &
key
);

2141 ià(
	`IS_ERR
(
roÙ
)) {

2142 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
IGNOREBADROOTS
))

2143 
»t
 = 
	`PTR_ERR
(
roÙ
);

2146 
	`£t_b™
(
BTRFS_ROOT_TRACK_DIRTY
, &
roÙ
->
¡©e
);

2147 
»t
 = 
	`bŒfs_glob®_roÙ_š£¹
(
roÙ
);

2148 ià(
»t
) {

2149 
	`bŒfs_put_roÙ
(
roÙ
);

2152 
key
.
off£t
++;

2154 
	`bŒfs_»Ëa£_·th
(
·th
);

2156 ià(
objeùid
 =ğ
BTRFS_EXTENT_TREE_OBJECTID
)

2157 
fs_šfo
->
Ä_glob®_roÙs
 = 
max_glob®_id
 + 1;

2159 ià(!
found
 || 
»t
) {

2160 ià(
objeùid
 =ğ
BTRFS_CSUM_TREE_OBJECTID
)

2161 
	`£t_b™
(
BTRFS_FS_STATE_NO_CSUMS
, &
fs_šfo
->
fs_¡©e
);

2163 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
IGNOREBADROOTS
))

2164 
»t
 =„‘ ?„‘ : -
ENOENT
;

2166 
»t
 = 0;

2167 
	`bŒfs_”r
(
fs_šfo
, "çedØlßd„oÙ %s", 
Çme
);

2169  
»t
;

2170 
	}
}

2172 
	$lßd_glob®_roÙs
(
bŒfs_roÙ
 *
Œ“_roÙ
)

2174 
bŒfs_·th
 *
·th
;

2175 
»t
 = 0;

2177 
·th
 = 
	`bŒfs_®loc_·th
();

2178 ià(!
·th
)

2179  -
ENOMEM
;

2181 
»t
 = 
	`lßd_glob®_roÙs_objeùid
(
Œ“_roÙ
, 
·th
,

2182 
BTRFS_EXTENT_TREE_OBJECTID
, "extent");

2183 ià(
»t
)

2184 
out
;

2185 
»t
 = 
	`lßd_glob®_roÙs_objeùid
(
Œ“_roÙ
, 
·th
,

2186 
BTRFS_CSUM_TREE_OBJECTID
, "csum");

2187 ià(
»t
)

2188 
out
;

2189 ià(!
	`bŒfs_fs_com·t_ro
(
Œ“_roÙ
->
fs_šfo
, 
FREE_SPACE_TREE
))

2190 
out
;

2191 
»t
 = 
	`lßd_glob®_roÙs_objeùid
(
Œ“_roÙ
, 
·th
,

2192 
BTRFS_FREE_SPACE_TREE_OBJECTID
,

2194 
out
:

2195 
	`bŒfs_ä“_·th
(
·th
);

2196  
»t
;

2197 
	}
}

2199 
	$bŒfs_»ad_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
)

2201 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

2202 
bŒfs_roÙ
 *
roÙ
;

2203 
bŒfs_key
 
loÿtiÚ
;

2204 
»t
;

2206 
	`BUG_ON
(!
fs_šfo
->
Œ“_roÙ
);

2208 
»t
 = 
	`lßd_glob®_roÙs
(
Œ“_roÙ
);

2209 ià(
»t
)

2210  
»t
;

2212 
loÿtiÚ
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

2213 
loÿtiÚ
.
off£t
 = 0;

2215 ià(
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
BLOCK_GROUP_TREE
)) {

2216 
loÿtiÚ
.
objeùid
 = 
BTRFS_BLOCK_GROUP_TREE_OBJECTID
;

2217 
roÙ
 = 
	`bŒfs_»ad_Œ“_roÙ
(
Œ“_roÙ
, &
loÿtiÚ
);

2218 ià(
	`IS_ERR
(
roÙ
)) {

2219 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
IGNOREBADROOTS
)) {

2220 
»t
 = 
	`PTR_ERR
(
roÙ
);

2221 
out
;

2224 
	`£t_b™
(
BTRFS_ROOT_TRACK_DIRTY
, &
roÙ
->
¡©e
);

2225 
fs_šfo
->
block_group_roÙ
 = 
roÙ
;

2229 
loÿtiÚ
.
objeùid
 = 
BTRFS_DEV_TREE_OBJECTID
;

2230 
roÙ
 = 
	`bŒfs_»ad_Œ“_roÙ
(
Œ“_roÙ
, &
loÿtiÚ
);

2231 ià(
	`IS_ERR
(
roÙ
)) {

2232 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
IGNOREBADROOTS
)) {

2233 
»t
 = 
	`PTR_ERR
(
roÙ
);

2234 
out
;

2237 
	`£t_b™
(
BTRFS_ROOT_TRACK_DIRTY
, &
roÙ
->
¡©e
);

2238 
fs_šfo
->
dev_roÙ
 = 
roÙ
;

2241 
»t
 = 
	`bŒfs_š™_deviûs_Ï‹
(
fs_šfo
);

2242 ià(
»t
)

2243 
out
;

2249 
roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
Œ“_roÙ
->
fs_šfo
,

2250 
BTRFS_DATA_RELOC_TREE_OBJECTID
, 
Œue
);

2251 ià(
	`IS_ERR
(
roÙ
)) {

2252 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
IGNOREBADROOTS
)) {

2253 
»t
 = 
	`PTR_ERR
(
roÙ
);

2254 
out
;

2257 
	`£t_b™
(
BTRFS_ROOT_TRACK_DIRTY
, &
roÙ
->
¡©e
);

2258 
fs_šfo
->
d©a_»loc_roÙ
 = 
roÙ
;

2261 
loÿtiÚ
.
objeùid
 = 
BTRFS_QUOTA_TREE_OBJECTID
;

2262 
roÙ
 = 
	`bŒfs_»ad_Œ“_roÙ
(
Œ“_roÙ
, &
loÿtiÚ
);

2263 ià(!
	`IS_ERR
(
roÙ
)) {

2264 
	`£t_b™
(
BTRFS_ROOT_TRACK_DIRTY
, &
roÙ
->
¡©e
);

2265 
	`£t_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
);

2266 
fs_šfo
->
quÙa_roÙ
 = 
roÙ
;

2269 
loÿtiÚ
.
objeùid
 = 
BTRFS_UUID_TREE_OBJECTID
;

2270 
roÙ
 = 
	`bŒfs_»ad_Œ“_roÙ
(
Œ“_roÙ
, &
loÿtiÚ
);

2271 ià(
	`IS_ERR
(
roÙ
)) {

2272 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
IGNOREBADROOTS
)) {

2273 
»t
 = 
	`PTR_ERR
(
roÙ
);

2274 ià(
»t
 !ğ-
ENOENT
)

2275 
out
;

2278 
	`£t_b™
(
BTRFS_ROOT_TRACK_DIRTY
, &
roÙ
->
¡©e
);

2279 
fs_šfo
->
uuid_roÙ
 = 
roÙ
;

2283 
out
:

2284 
	`bŒfs_w¬n
(
fs_šfo
, "failedo„ead„oot (objectid=%llu): %d",

2285 
loÿtiÚ
.
objeùid
, 
»t
);

2286  
»t
;

2287 
	}
}

2299 
	$bŒfs_v®id©e_su³r
(
bŒfs_fs_šfo
 *
fs_šfo
,

2300 
bŒfs_su³r_block
 *
sb
, 
mœrÜ_num
)

2302 
u64
 
nodesize
 = 
	`bŒfs_su³r_nodesize
(
sb
);

2303 
u64
 
£ùÜsize
 = 
	`bŒfs_su³r_£ùÜsize
(
sb
);

2304 
»t
 = 0;

2306 ià(
	`bŒfs_su³r_magic
(
sb
è!ğ
BTRFS_MAGIC
) {

2307 
	`bŒfs_”r
(
fs_šfo
, "no valid FS found");

2308 
»t
 = -
EINVAL
;

2310 ià(
	`bŒfs_su³r_æags
(
sb
è& ~
BTRFS_SUPER_FLAG_SUPP
) {

2311 
	`bŒfs_”r
(
fs_šfo
, "unrecognized or unsupported super flag: %llu",

2312 
	`bŒfs_su³r_æags
(
sb
è& ~
BTRFS_SUPER_FLAG_SUPP
);

2313 
»t
 = -
EINVAL
;

2315 ià(
	`bŒfs_su³r_roÙ_Ëv–
(
sb
è>ğ
BTRFS_MAX_LEVEL
) {

2316 
	`bŒfs_”r
(
fs_šfo
, "tree_root†eveloo big: %d >= %d",

2317 
	`bŒfs_su³r_roÙ_Ëv–
(
sb
), 
BTRFS_MAX_LEVEL
);

2318 
»t
 = -
EINVAL
;

2320 ià(
	`bŒfs_su³r_chunk_roÙ_Ëv–
(
sb
è>ğ
BTRFS_MAX_LEVEL
) {

2321 
	`bŒfs_”r
(
fs_šfo
, "chunk_root†eveloo big: %d >= %d",

2322 
	`bŒfs_su³r_chunk_roÙ_Ëv–
(
sb
), 
BTRFS_MAX_LEVEL
);

2323 
»t
 = -
EINVAL
;

2325 ià(
	`bŒfs_su³r_log_roÙ_Ëv–
(
sb
è>ğ
BTRFS_MAX_LEVEL
) {

2326 
	`bŒfs_”r
(
fs_šfo
, "log_root†eveloo big: %d >= %d",

2327 
	`bŒfs_su³r_log_roÙ_Ëv–
(
sb
), 
BTRFS_MAX_LEVEL
);

2328 
»t
 = -
EINVAL
;

2335 ià(!
	`is_pow”_of_2
(
£ùÜsize
) || sectorsize < 4096 ||

2336 
£ùÜsize
 > 
BTRFS_MAX_METADATA_BLOCKSIZE
) {

2337 
	`bŒfs_”r
(
fs_šfo
, "šv®id seùÜsiz%Îu", 
£ùÜsize
);

2338 
»t
 = -
EINVAL
;

2349 ià(
£ùÜsize
 > 
PAGE_SIZE
 || (£ùÜsiz!ğ
SZ_4K
 && sectorsize != PAGE_SIZE)) {

2350 
	`bŒfs_”r
(
fs_šfo
,

2352 
£ùÜsize
, 
PAGE_SIZE
);

2353 
»t
 = -
EINVAL
;

2356 ià(!
	`is_pow”_of_2
(
nodesize
è||‚odesiz< 
£ùÜsize
 ||

2357 
nodesize
 > 
BTRFS_MAX_METADATA_BLOCKSIZE
) {

2358 
	`bŒfs_”r
(
fs_šfo
, "šv®id‚odesiz%Îu", 
nodesize
);

2359 
»t
 = -
EINVAL
;

2361 ià(
nodesize
 !ğ
	`Ë32_to_ıu
(
sb
->
__unu£d_Ëafsize
)) {

2362 
	`bŒfs_”r
(
fs_šfo
, "invalid†eafsize %u, should be %llu",

2363 
	`Ë32_to_ıu
(
sb
->
__unu£d_Ëafsize
), 
nodesize
);

2364 
»t
 = -
EINVAL
;

2368 ià(!
	`IS_ALIGNED
(
	`bŒfs_su³r_roÙ
(
sb
), 
£ùÜsize
)) {

2369 
	`bŒfs_w¬n
(
fs_šfo
, "tree_root block unaligned: %llu",

2370 
	`bŒfs_su³r_roÙ
(
sb
));

2371 
»t
 = -
EINVAL
;

2373 ià(!
	`IS_ALIGNED
(
	`bŒfs_su³r_chunk_roÙ
(
sb
), 
£ùÜsize
)) {

2374 
	`bŒfs_w¬n
(
fs_šfo
, "chunk_root block unaligned: %llu",

2375 
	`bŒfs_su³r_chunk_roÙ
(
sb
));

2376 
»t
 = -
EINVAL
;

2378 ià(!
	`IS_ALIGNED
(
	`bŒfs_su³r_log_roÙ
(
sb
), 
£ùÜsize
)) {

2379 
	`bŒfs_w¬n
(
fs_šfo
, "log_root block unaligned: %llu",

2380 
	`bŒfs_su³r_log_roÙ
(
sb
));

2381 
»t
 = -
EINVAL
;

2384 ià(
	`memcmp
(
fs_šfo
->
fs_deviûs
->
fsid
, 
sb
->fsid, 
BTRFS_FSID_SIZE
) != 0) {

2385 
	`bŒfs_”r
(
fs_šfo
,

2387 
sb
->
fsid
, 
fs_šfo
->
fs_deviûs
->fsid);

2388 
»t
 = -
EINVAL
;

2391 ià(
	`memcmp
(
fs_šfo
->
fs_deviûs
->
m‘ad©a_uuid
, 
	`bŒfs_sb_fsid_±r
(
sb
),

2392 
BTRFS_FSID_SIZE
) != 0) {

2393 
	`bŒfs_”r
(
fs_šfo
,

2395 
	`bŒfs_sb_fsid_±r
(
sb
), 
fs_šfo
->
fs_deviûs
->
m‘ad©a_uuid
);

2396 
»t
 = -
EINVAL
;

2399 ià(
	`memcmp
(
fs_šfo
->
fs_deviûs
->
m‘ad©a_uuid
, 
sb
->
dev_™em
.
fsid
,

2400 
BTRFS_FSID_SIZE
) != 0) {

2401 
	`bŒfs_”r
(
fs_šfo
,

2403 
fs_šfo
->
fs_deviûs
->
m‘ad©a_uuid
, 
sb
->
dev_™em
.
fsid
);

2404 
»t
 = -
EINVAL
;

2411 ià(
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
BLOCK_GROUP_TREE
) &&

2412 (!
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE_VALID
) ||

2413 !
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
NO_HOLES
))) {

2414 
	`bŒfs_”r
(
fs_šfo
,

2416 
»t
 = -
EINVAL
;

2423 ià(
	`bŒfs_su³r_by‹s_u£d
(
sb
è< 6 * 
	`bŒfs_su³r_nodesize
(sb)) {

2424 
	`bŒfs_”r
(
fs_šfo
, "bytes_used isoo small %llu",

2425 
	`bŒfs_su³r_by‹s_u£d
(
sb
));

2426 
»t
 = -
EINVAL
;

2428 ià(!
	`is_pow”_of_2
(
	`bŒfs_su³r_¡resize
(
sb
))) {

2429 
	`bŒfs_”r
(
fs_šfo
, "invalid stripesize %u",

2430 
	`bŒfs_su³r_¡resize
(
sb
));

2431 
»t
 = -
EINVAL
;

2433 ià(
	`bŒfs_su³r_num_deviûs
(
sb
) > (1UL << 31))

2434 
	`bŒfs_w¬n
(
fs_šfo
, "suspicious‚umber of devices: %llu",

2435 
	`bŒfs_su³r_num_deviûs
(
sb
));

2436 ià(
	`bŒfs_su³r_num_deviûs
(
sb
) == 0) {

2437 
	`bŒfs_”r
(
fs_šfo
, "number of devices is 0");

2438 
»t
 = -
EINVAL
;

2441 ià(
mœrÜ_num
 >= 0 &&

2442 
	`bŒfs_su³r_by‹Ä
(
sb
è!ğ
	`bŒfs_sb_off£t
(
mœrÜ_num
)) {

2443 
	`bŒfs_”r
(
fs_šfo
, "super offset mismatch %llu != %u",

2444 
	`bŒfs_su³r_by‹Ä
(
sb
), 
BTRFS_SUPER_INFO_OFFSET
);

2445 
»t
 = -
EINVAL
;

2452 ià(
	`bŒfs_su³r_sys_¬¿y_size
(
sb
è> 
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
) {

2453 
	`bŒfs_”r
(
fs_šfo
, "system chunk‡rrayoo big %u > %u",

2454 
	`bŒfs_su³r_sys_¬¿y_size
(
sb
),

2455 
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
);

2456 
»t
 = -
EINVAL
;

2458 ià(
	`bŒfs_su³r_sys_¬¿y_size
(
sb
è< (
bŒfs_disk_key
)

2459 + (
bŒfs_chunk
)) {

2460 
	`bŒfs_”r
(
fs_šfo
, "system chunk‡rrayoo small %u < %zu",

2461 
	`bŒfs_su³r_sys_¬¿y_size
(
sb
),

2462 (
bŒfs_disk_key
)

2463 + (
bŒfs_chunk
));

2464 
»t
 = -
EINVAL
;

2471 ià(
	`bŒfs_su³r_g’”©iÚ
(
sb
è< 
	`bŒfs_su³r_chunk_roÙ_g’”©iÚ
(sb))

2472 
	`bŒfs_w¬n
(
fs_šfo
,

2474 
	`bŒfs_su³r_g’”©iÚ
(
sb
),

2475 
	`bŒfs_su³r_chunk_roÙ_g’”©iÚ
(
sb
));

2476 ià(
	`bŒfs_su³r_g’”©iÚ
(
sb
è< 
	`bŒfs_su³r_ÿche_g’”©iÚ
(sb)

2477 && 
	`bŒfs_su³r_ÿche_g’”©iÚ
(
sb
è!ğ(
u64
)-1)

2478 
	`bŒfs_w¬n
(
fs_šfo
,

2480 
	`bŒfs_su³r_g’”©iÚ
(
sb
),

2481 
	`bŒfs_su³r_ÿche_g’”©iÚ
(
sb
));

2483  
»t
;

2484 
	}
}

2487 
	$bŒfs_v®id©e_su³r_·¹™iÚ
(
bŒfs_fs_šfo
 *
fs_šfo
,

2488 
bŒfs_su³r_block
 *
sb
, 
mœrÜ_num
, 
·¹™iÚ_Üd”
)

2490 
u64
 
nodesize
 = 
	`bŒfs_su³r_nodesize
(
sb
);

2491 
u64
 
£ùÜsize
 = 
	`bŒfs_su³r_£ùÜsize
(
sb
);

2492 
»t
 = 0;

2494 ià(
	`bŒfs_su³r_magic
(
sb
è!ğ
BTRFS_MAGIC
) {

2495 
	`bŒfs_”r
(
fs_šfo
, "no valid FS found");

2496 
»t
 = -
EINVAL
;

2498 ià(
	`bŒfs_su³r_æags
(
sb
è& ~
BTRFS_SUPER_FLAG_SUPP
) {

2499 
	`bŒfs_”r
(
fs_šfo
, "unrecognized or unsupported super flag: %llu",

2500 
	`bŒfs_su³r_æags
(
sb
è& ~
BTRFS_SUPER_FLAG_SUPP
);

2501 
»t
 = -
EINVAL
;

2503 ià(
	`bŒfs_su³r_roÙ_Ëv–
(
sb
è>ğ
BTRFS_MAX_LEVEL
) {

2504 
	`bŒfs_”r
(
fs_šfo
, "tree_root†eveloo big: %d >= %d",

2505 
	`bŒfs_su³r_roÙ_Ëv–
(
sb
), 
BTRFS_MAX_LEVEL
);

2506 
»t
 = -
EINVAL
;

2508 ià(
	`bŒfs_su³r_chunk_roÙ_Ëv–
(
sb
è>ğ
BTRFS_MAX_LEVEL
) {

2509 
	`bŒfs_”r
(
fs_šfo
, "chunk_root†eveloo big: %d >= %d",

2510 
	`bŒfs_su³r_chunk_roÙ_Ëv–
(
sb
), 
BTRFS_MAX_LEVEL
);

2511 
»t
 = -
EINVAL
;

2513 ià(
	`bŒfs_su³r_log_roÙ_Ëv–
(
sb
è>ğ
BTRFS_MAX_LEVEL
) {

2514 
	`bŒfs_”r
(
fs_šfo
, "log_root†eveloo big: %d >= %d",

2515 
	`bŒfs_su³r_log_roÙ_Ëv–
(
sb
), 
BTRFS_MAX_LEVEL
);

2516 
»t
 = -
EINVAL
;

2523 ià(!
	`is_pow”_of_2
(
£ùÜsize
) || sectorsize < 4096 ||

2524 
£ùÜsize
 > 
BTRFS_MAX_METADATA_BLOCKSIZE
) {

2525 
	`bŒfs_”r
(
fs_šfo
, "šv®id seùÜsiz%Îu", 
£ùÜsize
);

2526 
»t
 = -
EINVAL
;

2537 ià(
£ùÜsize
 > 
PAGE_SIZE
 || (£ùÜsiz!ğ
SZ_4K
 && sectorsize != PAGE_SIZE)) {

2538 
	`bŒfs_”r
(
fs_šfo
,

2540 
£ùÜsize
, 
PAGE_SIZE
);

2541 
»t
 = -
EINVAL
;

2544 ià(!
	`is_pow”_of_2
(
nodesize
è||‚odesiz< 
£ùÜsize
 ||

2545 
nodesize
 > 
BTRFS_MAX_METADATA_BLOCKSIZE
) {

2546 
	`bŒfs_”r
(
fs_šfo
, "šv®id‚odesiz%Îu", 
nodesize
);

2547 
»t
 = -
EINVAL
;

2549 ià(
nodesize
 !ğ
	`Ë32_to_ıu
(
sb
->
__unu£d_Ëafsize
)) {

2550 
	`bŒfs_”r
(
fs_šfo
, "invalid†eafsize %u, should be %llu",

2551 
	`Ë32_to_ıu
(
sb
->
__unu£d_Ëafsize
), 
nodesize
);

2552 
»t
 = -
EINVAL
;

2556 ià(!
	`IS_ALIGNED
(
	`bŒfs_su³r_roÙ
(
sb
), 
£ùÜsize
)) {

2557 
	`bŒfs_w¬n
(
fs_šfo
, "tree_root block unaligned: %llu",

2558 
	`bŒfs_su³r_roÙ
(
sb
));

2559 
»t
 = -
EINVAL
;

2561 ià(!
	`IS_ALIGNED
(
	`bŒfs_su³r_chunk_roÙ
(
sb
), 
£ùÜsize
)) {

2562 
	`bŒfs_w¬n
(
fs_šfo
, "chunk_root block unaligned: %llu",

2563 
	`bŒfs_su³r_chunk_roÙ
(
sb
));

2564 
»t
 = -
EINVAL
;

2566 ià(!
	`IS_ALIGNED
(
	`bŒfs_su³r_log_roÙ
(
sb
), 
£ùÜsize
)) {

2567 
	`bŒfs_w¬n
(
fs_šfo
, "log_root block unaligned: %llu",

2568 
	`bŒfs_su³r_log_roÙ
(
sb
));

2569 
»t
 = -
EINVAL
;

2572 ià(
	`memcmp
(
fs_šfo
->
fs_deviûs
->
fsid
, 
sb
->fsid, 
BTRFS_FSID_SIZE
) != 0) {

2573 
	`bŒfs_”r
(
fs_šfo
,

2575 
sb
->
fsid
, 
fs_šfo
->
fs_deviûs
->fsid);

2576 
»t
 = -
EINVAL
;

2579 ià(
	`memcmp
(
fs_šfo
->
fs_deviûs
->
m‘ad©a_uuid
, 
	`bŒfs_sb_fsid_±r
(
sb
),

2580 
BTRFS_FSID_SIZE
) != 0) {

2581 
	`bŒfs_”r
(
fs_šfo
,

2583 
	`bŒfs_sb_fsid_±r
(
sb
), 
fs_šfo
->
fs_deviûs
->
m‘ad©a_uuid
);

2584 
»t
 = -
EINVAL
;

2587 ià(
	`memcmp
(
fs_šfo
->
fs_deviûs
->
m‘ad©a_uuid
, 
sb
->
dev_™em
.
fsid
,

2588 
BTRFS_FSID_SIZE
) != 0) {

2589 
	`bŒfs_”r
(
fs_šfo
,

2591 
fs_šfo
->
fs_deviûs
->
m‘ad©a_uuid
, 
sb
->
dev_™em
.
fsid
);

2592 
»t
 = -
EINVAL
;

2599 ià(
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
BLOCK_GROUP_TREE
) &&

2600 (!
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE_VALID
) ||

2601 !
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
NO_HOLES
))) {

2602 
	`bŒfs_”r
(
fs_šfo
,

2604 
»t
 = -
EINVAL
;

2611 ià(
	`bŒfs_su³r_by‹s_u£d
(
sb
è< 6 * 
	`bŒfs_su³r_nodesize
(sb)) {

2612 
	`bŒfs_”r
(
fs_šfo
, "bytes_used isoo small %llu",

2613 
	`bŒfs_su³r_by‹s_u£d
(
sb
));

2614 
»t
 = -
EINVAL
;

2616 ià(!
	`is_pow”_of_2
(
	`bŒfs_su³r_¡resize
(
sb
))) {

2617 
	`bŒfs_”r
(
fs_šfo
, "invalid stripesize %u",

2618 
	`bŒfs_su³r_¡resize
(
sb
));

2619 
»t
 = -
EINVAL
;

2621 ià(
	`bŒfs_su³r_num_deviûs
(
sb
) > (1UL << 31))

2622 
	`bŒfs_w¬n
(
fs_šfo
, "suspicious‚umber of devices: %llu",

2623 
	`bŒfs_su³r_num_deviûs
(
sb
));

2624 ià(
	`bŒfs_su³r_num_deviûs
(
sb
) == 0) {

2625 
	`bŒfs_”r
(
fs_šfo
, "number of devices is 0");

2626 
»t
 = -
EINVAL
;

2629 
u64
 
sb_off£t
 = 
BTRFS_SUPER_INFO_SIZE
 * 
·¹™iÚ_Üd”
;

2630 ià(
mœrÜ_num
 >= 0 &&

2631 
	`bŒfs_su³r_by‹Ä
(
sb
è!ğ
	`bŒfs_sb_off£t_·¹™iÚ
(
mœrÜ_num
, 
sb_off£t
)) {

2632 
	`bŒfs_”r
(
fs_šfo
, "super offset mismatch %llu != %u",

2633 
	`bŒfs_su³r_by‹Ä
(
sb
), 
BTRFS_SUPER_INFO_OFFSET
);

2634 
»t
 = -
EINVAL
;

2641 ià(
	`bŒfs_su³r_sys_¬¿y_size
(
sb
è> 
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
) {

2642 
	`bŒfs_”r
(
fs_šfo
, "system chunk‡rrayoo big %u > %u",

2643 
	`bŒfs_su³r_sys_¬¿y_size
(
sb
),

2644 
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
);

2645 
»t
 = -
EINVAL
;

2647 ià(
	`bŒfs_su³r_sys_¬¿y_size
(
sb
è< (
bŒfs_disk_key
)

2648 + (
bŒfs_chunk
)) {

2649 
	`bŒfs_”r
(
fs_šfo
, "system chunk‡rrayoo small %u < %zu",

2650 
	`bŒfs_su³r_sys_¬¿y_size
(
sb
),

2651 (
bŒfs_disk_key
)

2652 + (
bŒfs_chunk
));

2653 
»t
 = -
EINVAL
;

2660 ià(
	`bŒfs_su³r_g’”©iÚ
(
sb
è< 
	`bŒfs_su³r_chunk_roÙ_g’”©iÚ
(sb))

2661 
	`bŒfs_w¬n
(
fs_šfo
,

2663 
	`bŒfs_su³r_g’”©iÚ
(
sb
),

2664 
	`bŒfs_su³r_chunk_roÙ_g’”©iÚ
(
sb
));

2665 ià(
	`bŒfs_su³r_g’”©iÚ
(
sb
è< 
	`bŒfs_su³r_ÿche_g’”©iÚ
(sb)

2666 && 
	`bŒfs_su³r_ÿche_g’”©iÚ
(
sb
è!ğ(
u64
)-1)

2667 
	`bŒfs_w¬n
(
fs_šfo
,

2669 
	`bŒfs_su³r_g’”©iÚ
(
sb
),

2670 
	`bŒfs_su³r_ÿche_g’”©iÚ
(
sb
));

2672  
»t
;

2673 
	}
}

2680 
	$bŒfs_v®id©e_mouÁ_su³r
(
bŒfs_fs_šfo
 *
fs_šfo
)

2682  
	`bŒfs_v®id©e_su³r
(
fs_šfo
, fs_šfo->
su³r_cİy
, 0);

2683 
	}
}

2686 
	$bŒfs_v®id©e_mouÁ_su³r_·¹™iÚ
(
bŒfs_fs_šfo
 *
fs_šfo
, 
·¹™iÚ_Üd”
)

2688  
	`bŒfs_v®id©e_su³r_·¹™iÚ
(
fs_šfo
, fs_šfo->
su³r_cİy
, 0, 
·¹™iÚ_Üd”
);

2689 
	}
}

2697 
	$bŒfs_v®id©e_wr™e_su³r
(
bŒfs_fs_šfo
 *
fs_šfo
,

2698 
bŒfs_su³r_block
 *
sb
)

2700 
»t
;

2702 
»t
 = 
	`bŒfs_v®id©e_su³r
(
fs_šfo
, 
sb
, -1);

2703 ià(
»t
 < 0)

2704 
out
;

2705 ià(!
	`bŒfs_suµÜ‹d_su³r_csum
(
	`bŒfs_su³r_csum_ty³
(
sb
))) {

2706 
»t
 = -
EUCLEAN
;

2707 
	`bŒfs_”r
(
fs_šfo
, "invalid csumype, has %u want %u",

2708 
	`bŒfs_su³r_csum_ty³
(
sb
), 
BTRFS_CSUM_TYPE_CRC32
);

2709 
out
;

2711 ià(
	`bŒfs_su³r_šcom·t_æags
(
sb
è& ~
BTRFS_FEATURE_INCOMPAT_SUPP
) {

2712 
»t
 = -
EUCLEAN
;

2713 
	`bŒfs_”r
(
fs_šfo
,

2715 
	`bŒfs_su³r_šcom·t_æags
(
sb
),

2716 ()
BTRFS_FEATURE_INCOMPAT_SUPP
);

2717 
out
;

2719 
out
:

2720 ià(
»t
 < 0)

2721 
	`bŒfs_”r
(
fs_šfo
,

2723  
»t
;

2724 
	}
}

2726 
	$lßd_su³r_roÙ
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
by‹Ä
, u64 
g’
, 
Ëv–
)

2728 
bŒfs_Œ“_·»Á_check
 
check
 = {

2729 .
Ëv–
 =†evel,

2730 .
Œªsid
 = 
g’
,

2731 .
owÃr_roÙ
 = 
roÙ
->
roÙ_key
.
objeùid


2733 
»t
 = 0;

2735 
roÙ
->
node
 = 
	`»ad_Œ“_block
ÔoÙ->
fs_šfo
, 
by‹Ä
, &
check
);

2736 ià(
	`IS_ERR
(
roÙ
->
node
)) {

2737 
»t
 = 
	`PTR_ERR
(
roÙ
->
node
);

2738 
roÙ
->
node
 = 
NULL
;

2739  
»t
;

2741 ià(!
	`ex‹Á_bufãr_u±od©e
(
roÙ
->
node
)) {

2742 
	`ä“_ex‹Á_bufãr
(
roÙ
->
node
);

2743 
roÙ
->
node
 = 
NULL
;

2744  -
EIO
;

2747 
	`bŒfs_£t_roÙ_node
(&
roÙ
->
roÙ_™em
,„oÙ->
node
);

2748 
roÙ
->
comm™_roÙ
 = 
	`bŒfs_roÙ_node
(root);

2749 
	`bŒfs_£t_roÙ_»fs
(&
roÙ
->
roÙ_™em
, 1);

2750  
»t
;

2751 
	}
}

2753 
	$lßd_impÜÁ_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
)

2755 
bŒfs_su³r_block
 *
sb
 = 
fs_šfo
->
su³r_cİy
;

2756 
u64
 
g’
, 
by‹Ä
;

2757 
Ëv–
, 
»t
;

2759 
by‹Ä
 = 
	`bŒfs_su³r_roÙ
(
sb
);

2760 
g’
 = 
	`bŒfs_su³r_g’”©iÚ
(
sb
);

2761 
Ëv–
 = 
	`bŒfs_su³r_roÙ_Ëv–
(
sb
);

2762 
»t
 = 
	`lßd_su³r_roÙ
(
fs_šfo
->
Œ“_roÙ
, 
by‹Ä
, 
g’
, 
Ëv–
);

2763 ià(
»t
) {

2764 
	`bŒfs_w¬n
(
fs_šfo
, "couldn't„eadree„oot");

2765  
»t
;

2768 
	}
}

2770 
__cŞd
 
	$š™_Œ“_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
)

2772 
backup_šdex
 = 
	`fšd_Ãwe¡_su³r_backup
(
fs_šfo
);

2773 
bŒfs_su³r_block
 *
sb
 = 
fs_šfo
->
su³r_cİy
;

2774 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

2775 
boŞ
 
hªdË_”rÜ
 = 
çl£
;

2776 
»t
 = 0;

2777 
i
;

2779 
i
 = 0; i < 
BTRFS_NUM_BACKUP_ROOTS
; i++) {

2780 ià(
hªdË_”rÜ
) {

2781 ià(!
	`IS_ERR
(
Œ“_roÙ
->
node
))

2782 
	`ä“_ex‹Á_bufãr
(
Œ“_roÙ
->
node
);

2783 
Œ“_roÙ
->
node
 = 
NULL
;

2785 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
USEBACKUPROOT
))

2788 
	`ä“_roÙ_poš‹rs
(
fs_šfo
, 0);

2794 
	`bŒfs_£t_su³r_log_roÙ
(
sb
, 0);

2797 
	`bŒfs_£t_İt
(
fs_šfo
->
mouÁ_İt
, 
CLEAR_CACHE
);

2799 
	`bŒfs_w¬n
(
fs_šfo
, "ŒyØlßd backu°roÙ ¦Ù %d", 
i
);

2800 
»t
 = 
	`»ad_backup_roÙ
(
fs_šfo
, 
i
);

2801 
backup_šdex
 = 
»t
;

2802 ià(
»t
 < 0)

2803  
»t
;

2806 
»t
 = 
	`lßd_impÜÁ_roÙs
(
fs_šfo
);

2807 ià(
»t
) {

2808 
hªdË_”rÜ
 = 
Œue
;

2816 
»t
 = 
	`bŒfs_š™_roÙ_ä“_objeùid
(
Œ“_roÙ
);

2817 ià(
»t
 < 0) {

2818 
hªdË_”rÜ
 = 
Œue
;

2822 
	`ASSERT
(
Œ“_roÙ
->
ä“_objeùid
 <ğ
BTRFS_LAST_FREE_OBJECTID
);

2824 
»t
 = 
	`bŒfs_»ad_roÙs
(
fs_šfo
);

2825 ià(
»t
 < 0) {

2826 
hªdË_”rÜ
 = 
Œue
;

2831 
fs_šfo
->
g’”©iÚ
 = 
	`bŒfs_h—d”_g’”©iÚ
(
Œ“_roÙ
->
node
);

2832 
fs_šfo
->
Ï¡_Œªs_comm™‹d
 = fs_šfo->
g’”©iÚ
;

2833 
fs_šfo
->
Ï¡_»loc_Œªs
 = 0;

2836 ià(
backup_šdex
 < 0) {

2837 
fs_šfo
->
backup_roÙ_šdex
 = 0;

2839 
fs_šfo
->
backup_roÙ_šdex
 = 
backup_šdex
 + 1;

2840 
fs_šfo
->
backup_roÙ_šdex
 %ğ
BTRFS_NUM_BACKUP_ROOTS
;

2845  
»t
;

2846 
	}
}

2848 
	$bŒfs_š™_fs_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
)

2850 
	`INIT_RADIX_TREE
(&
fs_šfo
->
fs_roÙs_¿dix
, 
GFP_ATOMIC
);

2851 
	`INIT_RADIX_TREE
(&
fs_šfo
->
bufãr_¿dix
, 
GFP_ATOMIC
);

2852 
	`INIT_LIST_HEAD
(&
fs_šfo
->
Œªs_li¡
);

2853 
	`INIT_LIST_HEAD
(&
fs_šfo
->
d—d_roÙs
);

2854 
	`INIT_LIST_HEAD
(&
fs_šfo
->
d–ayed_uts
);

2855 
	`INIT_LIST_HEAD
(&
fs_šfo
->
d–®loc_roÙs
);

2856 
	`INIT_LIST_HEAD
(&
fs_šfo
->
ÿchšg_block_groups
);

2857 
	`¥š_lock_š™
(&
fs_šfo
->
d–®loc_roÙ_lock
);

2858 
	`¥š_lock_š™
(&
fs_šfo
->
Œªs_lock
);

2859 
	`¥š_lock_š™
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

2860 
	`¥š_lock_š™
(&
fs_šfo
->
d–ayed_ut_lock
);

2861 
	`¥š_lock_š™
(&
fs_šfo
->
deäag_šodes_lock
);

2862 
	`¥š_lock_š™
(&
fs_šfo
->
su³r_lock
);

2863 
	`¥š_lock_š™
(&
fs_šfo
->
bufãr_lock
);

2864 
	`¥š_lock_š™
(&
fs_šfo
->
unu£d_bgs_lock
);

2865 
	`¥š_lock_š™
(&
fs_šfo
->
Œ“log_bg_lock
);

2866 
	`¥š_lock_š™
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

2867 
	`¥š_lock_š™
(&
fs_šfo
->
»loÿtiÚ_bg_lock
);

2868 
	`rwlock_š™
(&
fs_šfo
->
Œ“_mod_log_lock
);

2869 
	`rwlock_š™
(&
fs_šfo
->
glob®_roÙ_lock
);

2870 
	`mu‹x_š™
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

2871 
	`mu‹x_š™
(&
fs_šfo
->
»şaim_bgs_lock
);

2872 
	`mu‹x_š™
(&
fs_šfo
->
»loc_mu‹x
);

2873 
	`mu‹x_š™
(&
fs_šfo
->
d–®loc_roÙ_mu‹x
);

2874 
	`mu‹x_š™
(&
fs_šfo
->
zÚed_m‘a_io_lock
);

2875 
	`mu‹x_š™
(&
fs_šfo
->
zÚed_d©a_»loc_io_lock
);

2876 
	`£qlock_š™
(&
fs_šfo
->
´ofes_lock
);

2878 
	`bŒfs_lockd•_š™_m­
(
fs_šfo
, 
bŒfs_Œªs_num_wr™”s
);

2879 
	`bŒfs_lockd•_š™_m­
(
fs_šfo
, 
bŒfs_Œªs_num_extwr™”s
);

2880 
	`bŒfs_lockd•_š™_m­
(
fs_šfo
, 
bŒfs_Œªs_³ndšg_Üd”ed
);

2881 
	`bŒfs_lockd•_š™_m­
(
fs_šfo
, 
bŒfs_Üd”ed_ex‹Á
);

2882 
	`bŒfs_¡©e_lockd•_š™_m­
(
fs_šfo
, 
bŒfs_Œªs_comm™_´•
,

2883 
BTRFS_LOCKDEP_TRANS_COMMIT_PREP
);

2884 
	`bŒfs_¡©e_lockd•_š™_m­
(
fs_šfo
, 
bŒfs_Œªs_unblocked
,

2885 
BTRFS_LOCKDEP_TRANS_UNBLOCKED
);

2886 
	`bŒfs_¡©e_lockd•_š™_m­
(
fs_šfo
, 
bŒfs_Œªs_su³r_comm™‹d
,

2887 
BTRFS_LOCKDEP_TRANS_SUPER_COMMITTED
);

2888 
	`bŒfs_¡©e_lockd•_š™_m­
(
fs_šfo
, 
bŒfs_Œªs_com¶‘ed
,

2889 
BTRFS_LOCKDEP_TRANS_COMPLETED
);

2891 
	`INIT_LIST_HEAD
(&
fs_šfo
->
dœty_cowÚly_roÙs
);

2892 
	`INIT_LIST_HEAD
(&
fs_šfo
->
¥aû_šfo
);

2893 
	`INIT_LIST_HEAD
(&
fs_šfo
->
Œ“_mod_£q_li¡
);

2894 
	`INIT_LIST_HEAD
(&
fs_šfo
->
unu£d_bgs
);

2895 
	`INIT_LIST_HEAD
(&
fs_šfo
->
»şaim_bgs
);

2896 
	`INIT_LIST_HEAD
(&
fs_šfo
->
zÚe_aùive_bgs
);

2897 #ifdeà
CONFIG_BTRFS_DEBUG


2898 
	`INIT_LIST_HEAD
(&
fs_šfo
->
®loÿ‹d_roÙs
);

2899 
	`INIT_LIST_HEAD
(&
fs_šfo
->
®loÿ‹d_ebs
);

2900 
	`¥š_lock_š™
(&
fs_šfo
->
eb_Ëak_lock
);

2902 
	`ex‹Á_m­_Œ“_š™
(&
fs_šfo
->
m­pšg_Œ“
);

2903 
	`bŒfs_š™_block_rsv
(&
fs_šfo
->
glob®_block_rsv
,

2904 
BTRFS_BLOCK_RSV_GLOBAL
);

2905 
	`bŒfs_š™_block_rsv
(&
fs_šfo
->
Œªs_block_rsv
, 
BTRFS_BLOCK_RSV_TRANS
);

2906 
	`bŒfs_š™_block_rsv
(&
fs_šfo
->
chunk_block_rsv
, 
BTRFS_BLOCK_RSV_CHUNK
);

2907 
	`bŒfs_š™_block_rsv
(&
fs_šfo
->
em±y_block_rsv
, 
BTRFS_BLOCK_RSV_EMPTY
);

2908 
	`bŒfs_š™_block_rsv
(&
fs_šfo
->
d–ayed_block_rsv
,

2909 
BTRFS_BLOCK_RSV_DELOPS
);

2910 
	`bŒfs_š™_block_rsv
(&
fs_šfo
->
d–ayed_»fs_rsv
,

2911 
BTRFS_BLOCK_RSV_DELREFS
);

2913 
	`©omic_£t
(&
fs_šfo
->
async_d–®loc_·ges
, 0);

2914 
	`©omic_£t
(&
fs_šfo
->
deäag_ruÂšg
, 0);

2915 
	`©omic_£t
(&
fs_šfo
->
Ä_d–ayed_uts
, 0);

2916 
	`©omic64_£t
(&
fs_šfo
->
Œ“_mod_£q
, 0);

2917 
fs_šfo
->
glob®_roÙ_Œ“
 = 
RB_ROOT
;

2918 
fs_šfo
->
max_šlše
 = 
BTRFS_DEFAULT_MAX_INLINE
;

2919 
fs_šfo
->
m‘ad©a_¿tio
 = 0;

2920 
fs_šfo
->
deäag_šodes
 = 
RB_ROOT
;

2921 
	`©omic64_£t
(&
fs_šfo
->
ä“_chunk_¥aû
, 0);

2922 
fs_šfo
->
Œ“_mod_log
 = 
RB_ROOT
;

2923 
fs_šfo
->
comm™_š‹rv®
 = 
BTRFS_DEFAULT_COMMIT_INTERVAL
;

2924 
	`bŒfs_š™_»f_v”ify
(
fs_šfo
);

2926 
fs_šfo
->
th»ad_poŞ_size
 = 
	`mš_t
(,

2927 
	`num_Úlše_ıus
() + 2, 8);

2929 
	`INIT_LIST_HEAD
(&
fs_šfo
->
Üd”ed_roÙs
);

2930 
	`¥š_lock_š™
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

2932 
	`bŒfs_š™_süub
(
fs_šfo
);

2933 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


2934 
fs_šfo
->
check_š‹gr™y_´št_mask
 = 0;

2936 
	`bŒfs_š™_b®ªû
(
fs_šfo
);

2937 
	`bŒfs_š™_async_»şaim_wÜk
(
fs_šfo
);

2939 
	`rwlock_š™
(&
fs_šfo
->
block_group_ÿche_lock
);

2940 
fs_šfo
->
block_group_ÿche_Œ“
 = 
RB_ROOT_CACHED
;

2942 
	`ex‹Á_io_Œ“_š™
(
fs_šfo
, &fs_šfo->
exşuded_ex‹Ás
,

2943 
IO_TREE_FS_EXCLUDED_EXTENTS
);

2945 
	`mu‹x_š™
(&
fs_šfo
->
Üd”ed_İ”©iÚs_mu‹x
);

2946 
	`mu‹x_š™
(&
fs_šfo
->
Œ“_log_mu‹x
);

2947 
	`mu‹x_š™
(&
fs_šfo
->
chunk_mu‹x
);

2948 
	`mu‹x_š™
(&
fs_šfo
->
Œª§ùiÚ_kth»ad_mu‹x
);

2949 
	`mu‹x_š™
(&
fs_šfo
->
ş—Ãr_mu‹x
);

2950 
	`mu‹x_š™
(&
fs_šfo
->
ro_block_group_mu‹x
);

2951 
	`š™_rw£m
(&
fs_šfo
->
comm™_roÙ_£m
);

2952 
	`š™_rw£m
(&
fs_šfo
->
ş—nup_wÜk_£m
);

2953 
	`š™_rw£m
(&
fs_šfo
->
subvŞ_£m
);

2954 
	`£ma_š™
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
, 1);

2956 
	`bŒfs_š™_dev_»¶aû_locks
(
fs_šfo
);

2957 
	`bŒfs_š™_qgroup
(
fs_šfo
);

2958 
	`bŒfs_disÿrd_š™
(
fs_šfo
);

2960 
	`bŒfs_š™_ä“_şu¡”
(&
fs_šfo
->
m‘a_®loc_şu¡”
);

2961 
	`bŒfs_š™_ä“_şu¡”
(&
fs_šfo
->
d©a_®loc_şu¡”
);

2963 
	`š™_wa™queue_h—d
(&
fs_šfo
->
Œª§ùiÚ_thrÙe
);

2964 
	`š™_wa™queue_h—d
(&
fs_šfo
->
Œª§ùiÚ_wa™
);

2965 
	`š™_wa™queue_h—d
(&
fs_šfo
->
Œª§ùiÚ_blocked_wa™
);

2966 
	`š™_wa™queue_h—d
(&
fs_šfo
->
async_subm™_wa™
);

2967 
	`š™_wa™queue_h—d
(&
fs_šfo
->
d–ayed_uts_wa™
);

2970 
fs_šfo
->
nodesize
 = 4096;

2971 
fs_šfo
->
£ùÜsize
 = 4096;

2972 
fs_šfo
->
£ùÜsize_b™s
 = 
	`og2
(4096);

2973 
fs_šfo
->
¡resize
 = 4096;

2975 
fs_šfo
->
max_ex‹Á_size
 = 
BTRFS_MAX_EXTENT_SIZE
;

2977 
	`¥š_lock_š™
(&
fs_šfo
->
sw­fe_pšs_lock
);

2978 
fs_šfo
->
sw­fe_pšs
 = 
RB_ROOT
;

2980 
fs_šfo
->
bg_»şaim_th»shŞd
 = 
BTRFS_DEFAULT_RECLAIM_THRESH
;

2981 
	`INIT_WORK
(&
fs_šfo
->
»şaim_bgs_wÜk
, 
bŒfs_»şaim_bgs_wÜk
);

2982 
	}
}

2984 
	$š™_mouÁ_fs_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
, 
su³r_block
 *
sb
)

2986 
»t
;

2988 
fs_šfo
->
sb
 = sb;

2989 
sb
->
s_blocksize
 = 
BTRFS_BDEV_BLOCKSIZE
;

2990 
sb
->
s_blocksize_b™s
 = 
	`blksize_b™s
(
BTRFS_BDEV_BLOCKSIZE
);

2992 
»t
 = 
	`³rıu_couÁ”_š™
(&
fs_šfo
->
Üd”ed_by‹s
, 0, 
GFP_KERNEL
);

2993 ià(
»t
)

2994  
»t
;

2996 
»t
 = 
	`³rıu_couÁ”_š™
(&
fs_šfo
->
dœty_m‘ad©a_by‹s
, 0, 
GFP_KERNEL
);

2997 ià(
»t
)

2998  
»t
;

3000 
fs_šfo
->
dœty_m‘ad©a_b©ch
 = 
PAGE_SIZE
 *

3001 (1 + 
	`og2
(
Ä_ıu_ids
));

3003 
»t
 = 
	`³rıu_couÁ”_š™
(&
fs_šfo
->
d–®loc_by‹s
, 0, 
GFP_KERNEL
);

3004 ià(
»t
)

3005  
»t
;

3007 
»t
 = 
	`³rıu_couÁ”_š™
(&
fs_šfo
->
dev_»¶aû
.
bio_couÁ”
, 0,

3008 
GFP_KERNEL
);

3009 ià(
»t
)

3010  
»t
;

3012 
fs_šfo
->
d–ayed_roÙ
 = 
	`km®loc
((
bŒfs_d–ayed_roÙ
),

3013 
GFP_KERNEL
);

3014 ià(!
fs_šfo
->
d–ayed_roÙ
)

3015  -
ENOMEM
;

3016 
	`bŒfs_š™_d–ayed_roÙ
(
fs_šfo
->
d–ayed_roÙ
);

3018 ià(
	`sb_rdÚly
(
sb
))

3019 
	`£t_b™
(
BTRFS_FS_STATE_RO
, &
fs_šfo
->
fs_¡©e
);

3021  
	`bŒfs_®loc_¡re_hash_bË
(
fs_šfo
);

3022 
	}
}

3024 
	$bŒfs_uuid_»sÿn_kth»ad
(*
d©a
)

3026 
bŒfs_fs_šfo
 *
fs_šfo
 = 
d©a
;

3027 
»t
;

3034 
»t
 = 
	`bŒfs_uuid_Œ“_™”©e
(
fs_šfo
);

3035 ià(
»t
 < 0) {

3036 ià(
»t
 !ğ-
EINTR
)

3037 
	`bŒfs_w¬n
(
fs_šfo
, "iterating uuid_tree failed %d",

3038 
»t
);

3039 
	`up
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

3040  
»t
;

3042  
	`bŒfs_uuid_sÿn_kth»ad
(
d©a
);

3043 
	}
}

3045 
	$bŒfs_check_uuid_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
)

3047 
sk_¡ruù
 *
sk
;

3049 
	`down
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

3050 
sk
 = 
	`kth»ad_run
(
bŒfs_uuid_»sÿn_kth»ad
, 
fs_šfo
, "btrfs-uuid");

3051 ià(
	`IS_ERR
(
sk
)) {

3053 
	`bŒfs_w¬n
(
fs_šfo
, "failedo start uuid_rescanask");

3054 
	`up
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

3055  
	`PTR_ERR
(
sk
);

3059 
	}
}

3061 
	$bŒfs_ş—nup_fs_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
)

3063 
u64
 
roÙ_objeùid
 = 0;

3064 
bŒfs_roÙ
 *
gªg
[8];

3065 
i
 = 0;

3066 
”r
 = 0;

3067 
»t
 = 0;

3070 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

3071 
»t
 = 
	`¿dix_Œ“_gªg_lookup
(&
fs_šfo
->
fs_roÙs_¿dix
,

3072 (**)
gªg
, 
roÙ_objeùid
,

3073 
	`ARRAY_SIZE
(
gªg
));

3074 ià(!
»t
) {

3075 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

3078 
roÙ_objeùid
 = 
gªg
[
»t
 - 1]->
roÙ_key
.
objeùid
 + 1;

3080 
i
 = 0; i < 
»t
; i++) {

3082 ià(
	`bŒfs_roÙ_»fs
(&
gªg
[
i
]->
roÙ_™em
) == 0) {

3083 
gªg
[
i
] = 
NULL
;

3087 
gªg
[
i
] = 
	`bŒfs_g¿b_roÙ
(gang[i]);

3089 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

3091 
i
 = 0; i < 
»t
; i++) {

3092 ià(!
gªg
[
i
])

3094 
roÙ_objeùid
 = 
gªg
[
i
]->
roÙ_key
.
objeùid
;

3095 
”r
 = 
	`bŒfs_Üphª_ş—nup
(
gªg
[
i
]);

3096 ià(
”r
)

3097 
out
;

3098 
	`bŒfs_put_roÙ
(
gªg
[
i
]);

3100 
roÙ_objeùid
++;

3102 
out
:

3104 ; 
i
 < 
»t
; i++) {

3105 ià(
gªg
[
i
])

3106 
	`bŒfs_put_roÙ
(
gªg
[
i
]);

3108  
”r
;

3109 
	}
}

3116 
	$bŒfs_ş—r_ÚeshÙ_İtiÚs
(
bŒfs_fs_šfo
 *
fs_šfo
)

3118 
	`bŒfs_ş—r_İt
(
fs_šfo
->
mouÁ_İt
, 
USEBACKUPROOT
);

3119 
	`bŒfs_ş—r_İt
(
fs_šfo
->
mouÁ_İt
, 
CLEAR_CACHE
);

3120 
	}
}

3126 
	$bŒfs_¡¬t_´e_rw_mouÁ
(
bŒfs_fs_šfo
 *
fs_šfo
)

3128 
»t
;

3129 cÚ¡ 
boŞ
 
ÿche_İt
 = 
	`bŒfs_‹¡_İt
(
fs_šfo
, 
SPACE_CACHE
);

3130 
boŞ
 
»bud_ä“_¥aû_Œ“
 = 
çl£
;

3132 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
CLEAR_CACHE
) &&

3133 
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
)) {

3134 
»bud_ä“_¥aû_Œ“
 = 
Œue
;

3135 } ià(
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
) &&

3136 !
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE_VALID
)) {

3137 
	`bŒfs_w¬n
(
fs_šfo
, "free spaceree is invalid");

3138 
»bud_ä“_¥aû_Œ“
 = 
Œue
;

3141 ià(
»bud_ä“_¥aû_Œ“
) {

3142 
	`bŒfs_šfo
(
fs_šfo
, "rebuilding free spaceree");

3143 
»t
 = 
	`bŒfs_»bud_ä“_¥aû_Œ“
(
fs_šfo
);

3144 ià(
»t
) {

3145 
	`bŒfs_w¬n
(
fs_šfo
,

3146 "çedØ»bud f»¥aû»e: %d", 
»t
);

3147 
out
;

3151 ià(
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
) &&

3152 !
	`bŒfs_‹¡_İt
(
fs_šfo
, 
FREE_SPACE_TREE
)) {

3153 
	`bŒfs_šfo
(
fs_šfo
, "disabling free spaceree");

3154 
»t
 = 
	`bŒfs_d–‘e_ä“_¥aû_Œ“
(
fs_šfo
);

3155 ià(
»t
) {

3156 
	`bŒfs_w¬n
(
fs_šfo
,

3157 "çedØdi§bË f»¥aû»e: %d", 
»t
);

3158 
out
;

3173 
»t
 = 
	`bŒfs_fšd_Üphª_roÙs
(
fs_šfo
);

3174 ià(
»t
)

3175 
out
;

3177 
»t
 = 
	`bŒfs_ş—nup_fs_roÙs
(
fs_šfo
);

3178 ià(
»t
)

3179 
out
;

3181 
	`down_»ad
(&
fs_šfo
->
ş—nup_wÜk_£m
);

3182 ià((
»t
 = 
	`bŒfs_Üphª_ş—nup
(
fs_šfo
->
fs_roÙ
)) ||

3183 (
»t
 = 
	`bŒfs_Üphª_ş—nup
(
fs_šfo
->
Œ“_roÙ
))) {

3184 
	`up_»ad
(&
fs_šfo
->
ş—nup_wÜk_£m
);

3185 
out
;

3187 
	`up_»ad
(&
fs_šfo
->
ş—nup_wÜk_£m
);

3189 
	`mu‹x_lock
(&
fs_šfo
->
ş—Ãr_mu‹x
);

3190 
»t
 = 
	`bŒfs_»cov”_»loÿtiÚ
(
fs_šfo
);

3191 
	`mu‹x_uÆock
(&
fs_šfo
->
ş—Ãr_mu‹x
);

3192 ià(
»t
 < 0) {

3193 
	`bŒfs_w¬n
(
fs_šfo
, "çedØ»cov”„–oÿtiÚ: %d", 
»t
);

3194 
out
;

3197 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
FREE_SPACE_TREE
) &&

3198 !
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
)) {

3199 
	`bŒfs_šfo
(
fs_šfo
, "creating free spaceree");

3200 
»t
 = 
	`bŒfs_ü—‹_ä“_¥aû_Œ“
(
fs_šfo
);

3201 ià(
»t
) {

3202 
	`bŒfs_w¬n
(
fs_šfo
,

3203 "çedØü—‹ f»¥aû»e: %d", 
»t
);

3204 
out
;

3208 ià(
ÿche_İt
 !ğ
	`bŒfs_ä“_¥aû_ÿche_v1_aùive
(
fs_šfo
)) {

3209 
»t
 = 
	`bŒfs_£t_ä“_¥aû_ÿche_v1_aùive
(
fs_šfo
, 
ÿche_İt
);

3210 ià(
»t
)

3211 
out
;

3214 
»t
 = 
	`bŒfs_»sume_b®ªû_async
(
fs_šfo
);

3215 ià(
»t
)

3216 
out
;

3218 
»t
 = 
	`bŒfs_»sume_dev_»¶aû_async
(
fs_šfo
);

3219 ià(
»t
) {

3220 
	`bŒfs_w¬n
(
fs_šfo
, "failedo„esume dev_replace");

3221 
out
;

3224 
	`bŒfs_qgroup_»sÿn_»sume
(
fs_šfo
);

3226 ià(!
fs_šfo
->
uuid_roÙ
) {

3227 
	`bŒfs_šfo
(
fs_šfo
, "creating UUIDree");

3228 
»t
 = 
	`bŒfs_ü—‹_uuid_Œ“
(
fs_šfo
);

3229 ià(
»t
) {

3230 
	`bŒfs_w¬n
(
fs_šfo
,

3231 "çedØü—‹hUUID»%d", 
»t
);

3232 
out
;

3236 
out
:

3237  
»t
;

3238 
	}
}

3255 
	$bŒfs_check_ã©u»s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
boŞ
 
is_rw_mouÁ
)

3257 
bŒfs_su³r_block
 *
disk_su³r
 = 
fs_šfo
->
su³r_cİy
;

3258 
u64
 
šcom·t
 = 
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
);

3259 cÚ¡ 
u64
 
com·t_ro
 = 
	`bŒfs_su³r_com·t_ro_æags
(
disk_su³r
);

3260 cÚ¡ 
u64
 
com·t_ro_unsuµ
 = (
com·t_ro
 & ~
BTRFS_FEATURE_COMPAT_RO_SUPP
);

3262 ià(
šcom·t
 & ~
BTRFS_FEATURE_INCOMPAT_SUPP
) {

3263 
	`bŒfs_”r
(
fs_šfo
,

3265 
šcom·t
);

3266  -
EINVAL
;

3270 ià((
šcom·t
 & 
BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
) &&

3271 (
fs_šfo
->
£ùÜsize
 !ğfs_šfo->
nodesize
)) {

3272 
	`bŒfs_”r
(
fs_šfo
,

3274 
fs_šfo
->
nodesize
, fs_šfo->
£ùÜsize
);

3275  -
EINVAL
;

3279 
šcom·t
 |ğ
BTRFS_FEATURE_INCOMPAT_MIXED_BACKREF
;

3282 ià(
fs_šfo
->
com´ess_ty³
 =ğ
BTRFS_COMPRESS_LZO
)

3283 
šcom·t
 |ğ
BTRFS_FEATURE_INCOMPAT_COMPRESS_LZO
;

3284 ià(
fs_šfo
->
com´ess_ty³
 =ğ
BTRFS_COMPRESS_ZSTD
)

3285 
šcom·t
 |ğ
BTRFS_FEATURE_INCOMPAT_COMPRESS_ZSTD
;

3291 ià(
	`bŒfs_su³r_nodesize
(
disk_su³r
è> 
PAGE_SIZE
)

3292 
šcom·t
 |ğ
BTRFS_FEATURE_INCOMPAT_BIG_METADATA
;

3294 ià(
com·t_ro_unsuµ
 && 
is_rw_mouÁ
) {

3295 
	`bŒfs_”r
(
fs_šfo
,

3297 
com·t_ro
);

3298  -
EINVAL
;

3306 ià(
com·t_ro_unsuµ
 && 
	`bŒfs_su³r_log_roÙ
(
disk_su³r
) &&

3307 !
	`bŒfs_‹¡_İt
(
fs_šfo
, 
NOLOGREPLAY
)) {

3308 
	`bŒfs_”r
(
fs_šfo
,

3310 
com·t_ro
);

3311  -
EINVAL
;

3318 ià(
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
BLOCK_GROUP_TREE
) &&

3319 (!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
NO_HOLES
) ||

3320 !
	`bŒfs_‹¡_İt
(
fs_šfo
, 
FREE_SPACE_TREE
))) {

3321 
	`bŒfs_”r
(
fs_šfo
,

3323  -
EINVAL
;

3333 ià(
fs_šfo
->
£ùÜsize
 < 
PAGE_SIZE
 && 
	`bŒfs_‹¡_İt
(fs_šfo, 
SPACE_CACHE
)) {

3334 
	`bŒfs_w¬n
(
fs_šfo
,

3336 
PAGE_SIZE
, 
fs_šfo
->
£ùÜsize
);

3337  -
EINVAL
;

3341 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

3342 
	`bŒfs_£t_su³r_šcom·t_æags
(
disk_su³r
, 
šcom·t
);

3343 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

3346 
	}
}

3348 
__cŞd
 
	$İ’_ù»e
(
su³r_block
 *
sb
, 
bŒfs_fs_deviûs
 *
fs_deviûs
,

3349 *
İtiÚs
)

3351 
u32
 
£ùÜsize
;

3352 
u32
 
nodesize
;

3353 
u32
 
¡resize
;

3354 
u64
 
g’”©iÚ
;

3355 
u64
 
ã©u»s
;

3356 
u16
 
csum_ty³
;

3357 
bŒfs_su³r_block
 *
disk_su³r
;

3358 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

3359 
bŒfs_roÙ
 *
Œ“_roÙ
;

3360 
bŒfs_roÙ
 *
chunk_roÙ
;

3361 
»t
;

3362 
Ëv–
;

3364 
»t
 = 
	`š™_mouÁ_fs_šfo
(
fs_šfo
, 
sb
);

3365 ià(
»t
)

3366 
ç
;

3369 
Œ“_roÙ
 = 
	`bŒfs_®loc_roÙ
(
fs_šfo
, 
BTRFS_ROOT_TREE_OBJECTID
,

3370 
GFP_KERNEL
);

3371 
fs_šfo
->
Œ“_roÙ
 =ree_root;

3372 
chunk_roÙ
 = 
	`bŒfs_®loc_roÙ
(
fs_šfo
, 
BTRFS_CHUNK_TREE_OBJECTID
,

3373 
GFP_KERNEL
);

3374 
fs_šfo
->
chunk_roÙ
 = chunk_root;

3375 ià(!
Œ“_roÙ
 || !
chunk_roÙ
) {

3376 
»t
 = -
ENOMEM
;

3377 
ç
;

3380 
»t
 = 
	`bŒfs_š™_bŒ“_šode
(
sb
);

3381 ià(
»t
)

3382 
ç
;

3384 
	`šv®id©e_bdev
(
fs_deviûs
->
Ï‹¡_dev
->
bdev
);

3389 
disk_su³r
 = 
	`bŒfs_»ad_dev_su³r
(
fs_deviûs
->
Ï‹¡_dev
->
bdev
);

3390 ià(
	`IS_ERR
(
disk_su³r
)) {

3391 
»t
 = 
	`PTR_ERR
(
disk_su³r
);

3392 
ç_®loc
;

3395 
	`bŒfs_šfo
(
fs_šfo
, "fœ¡ mouÁ oàfesy¡em %pU", 
disk_su³r
->
fsid
);

3400 
csum_ty³
 = 
	`bŒfs_su³r_csum_ty³
(
disk_su³r
);

3401 ià(!
	`bŒfs_suµÜ‹d_su³r_csum
(
csum_ty³
)) {

3402 
	`bŒfs_”r
(
fs_šfo
, "unsupported checksum‡lgorithm: %u",

3403 
csum_ty³
);

3404 
»t
 = -
EINVAL
;

3405 
	`bŒfs_»Ëa£_disk_su³r
(
disk_su³r
);

3406 
ç_®loc
;

3409 
fs_šfo
->
csum_size
 = 
	`bŒfs_su³r_csum_size
(
disk_su³r
);

3411 
»t
 = 
	`bŒfs_š™_csum_hash
(
fs_šfo
, 
csum_ty³
);

3412 ià(
»t
) {

3413 
	`bŒfs_»Ëa£_disk_su³r
(
disk_su³r
);

3414 
ç_®loc
;

3421 ià(
	`bŒfs_check_su³r_csum
(
fs_šfo
, 
disk_su³r
)) {

3422 
	`bŒfs_”r
(
fs_šfo
, "superblock checksum mismatch");

3423 
»t
 = -
EINVAL
;

3424 
	`bŒfs_»Ëa£_disk_su³r
(
disk_su³r
);

3425 
ç_®loc
;

3433 
	`memıy
(
fs_šfo
->
su³r_cİy
, 
disk_su³r
, (*fs_info->super_copy));

3434 
	`bŒfs_»Ëa£_disk_su³r
(
disk_su³r
);

3436 
disk_su³r
 = 
fs_šfo
->
su³r_cİy
;

3439 
ã©u»s
 = 
	`bŒfs_su³r_æags
(
disk_su³r
);

3440 ià(
ã©u»s
 & 
BTRFS_SUPER_FLAG_CHANGING_FSID_V2
) {

3441 
ã©u»s
 &ğ~
BTRFS_SUPER_FLAG_CHANGING_FSID_V2
;

3442 
	`bŒfs_£t_su³r_æags
(
disk_su³r
, 
ã©u»s
);

3443 
	`bŒfs_šfo
(
fs_šfo
,

3447 
	`memıy
(
fs_šfo
->
su³r_fÜ_comm™
, fs_šfo->
su³r_cİy
,

3448 (*
fs_šfo
->
su³r_fÜ_comm™
));

3450 
»t
 = 
	`bŒfs_v®id©e_mouÁ_su³r
(
fs_šfo
);

3451 ià(
»t
) {

3452 
	`bŒfs_”r
(
fs_šfo
, "superblock contains fatalƒrrors");

3453 
»t
 = -
EINVAL
;

3454 
ç_®loc
;

3457 ià(!
	`bŒfs_su³r_roÙ
(
disk_su³r
)) {

3458 
	`bŒfs_”r
(
fs_šfo
, "invalid superblockree„oot bytenr");

3459 
»t
 = -
EINVAL
;

3460 
ç_®loc
;

3464 ià(
	`bŒfs_su³r_æags
(
disk_su³r
è& 
BTRFS_SUPER_FLAG_ERROR
)

3465 
	`WRITE_ONCE
(
fs_šfo
->
fs_”rÜ
, -
EUCLEAN
);

3471 
fs_šfo
->
com´ess_ty³
 = 
BTRFS_COMPRESS_ZLIB
;

3475 
nodesize
 = 
	`bŒfs_su³r_nodesize
(
disk_su³r
);

3476 
£ùÜsize
 = 
	`bŒfs_su³r_£ùÜsize
(
disk_su³r
);

3477 
¡resize
 = 
£ùÜsize
;

3478 
fs_šfo
->
dœty_m‘ad©a_b©ch
 = 
nodesize
 * (1 + 
	`og2
(
Ä_ıu_ids
));

3479 
fs_šfo
->
d–®loc_b©ch
 = 
£ùÜsize
 * 512 * (1 + 
	`og2
(
Ä_ıu_ids
));

3481 
fs_šfo
->
nodesize
 =‚odesize;

3482 
fs_šfo
->
£ùÜsize
 = sectorsize;

3483 
fs_šfo
->
£ùÜsize_b™s
 = 
	`og2
(
£ùÜsize
);

3484 
fs_šfo
->
csums_³r_Ëaf
 = 
	`BTRFS_MAX_ITEM_SIZE
(fs_šfoè/ fs_šfo->
csum_size
;

3485 
fs_šfo
->
¡resize
 = stripesize;

3487 
»t
 = 
	`bŒfs_·r£_İtiÚs
(
fs_šfo
, 
İtiÚs
, 
sb
->
s_æags
);

3488 ià(
»t
)

3489 
ç_®loc
;

3491 
»t
 = 
	`bŒfs_check_ã©u»s
(
fs_šfo
, !
	`sb_rdÚly
(
sb
));

3492 ià(
»t
 < 0)

3493 
ç_®loc
;

3495 ià(
£ùÜsize
 < 
PAGE_SIZE
) {

3496 
bŒfs_sub·ge_šfo
 *
sub·ge_šfo
;

3504 
	`bŒfs_ş—r_İt
(
fs_šfo
->
mouÁ_İt
, 
SPACE_CACHE
);

3505 
	`bŒfs_£t_ªd_šfo
(
fs_šfo
, 
FREE_SPACE_TREE
,

3507 
£ùÜsize
, 
PAGE_SIZE
);

3509 
	`bŒfs_w¬n
(
fs_šfo
,

3511 
£ùÜsize
, 
PAGE_SIZE
);

3512 
sub·ge_šfo
 = 
	`kz®loc
((*sub·ge_šfo), 
GFP_KERNEL
);

3513 ià(!
sub·ge_šfo
) {

3514 
»t
 = -
ENOMEM
;

3515 
ç_®loc
;

3517 
	`bŒfs_š™_sub·ge_šfo
(
sub·ge_šfo
, 
£ùÜsize
);

3518 
fs_šfo
->
sub·ge_šfo
 = subpage_info;

3521 
»t
 = 
	`bŒfs_š™_wÜkqueues
(
fs_šfo
);

3522 ià(
»t
)

3523 
ç_sb_bufãr
;

3525 
sb
->
s_bdi
->
¿_·ges
 *ğ
	`bŒfs_su³r_num_deviûs
(
disk_su³r
);

3526 
sb
->
s_bdi
->
¿_·ges
 = 
	`max
(sb->s_bdi->¿_·ges, 
SZ_4M
 / 
PAGE_SIZE
);

3528 
sb
->
s_blocksize
 = 
£ùÜsize
;

3529 
sb
->
s_blocksize_b™s
 = 
	`blksize_b™s
(
£ùÜsize
);

3530 
	`memıy
(&
sb
->
s_uuid
, 
fs_šfo
->
fs_deviûs
->
fsid
, 
BTRFS_FSID_SIZE
);

3532 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

3533 
»t
 = 
	`bŒfs_»ad_sys_¬¿y
(
fs_šfo
);

3534 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

3535 ià(
»t
) {

3536 
	`bŒfs_”r
(
fs_šfo
, "çedØ»adhsy¡em‡¼ay: %d", 
»t
);

3537 
ç_sb_bufãr
;

3540 
g’”©iÚ
 = 
	`bŒfs_su³r_chunk_roÙ_g’”©iÚ
(
disk_su³r
);

3541 
Ëv–
 = 
	`bŒfs_su³r_chunk_roÙ_Ëv–
(
disk_su³r
);

3542 
»t
 = 
	`lßd_su³r_roÙ
(
chunk_roÙ
, 
	`bŒfs_su³r_chunk_roÙ
(
disk_su³r
),

3543 
g’”©iÚ
, 
Ëv–
);

3544 ià(
»t
) {

3545 
	`bŒfs_”r
(
fs_šfo
, "failedo„ead chunk„oot");

3546 
ç_Œ“_roÙs
;

3549 
	`»ad_ex‹Á_bufãr
(
chunk_roÙ
->
node
, 
fs_šfo
->
chunk_Œ“_uuid
,

3550 
	`off£tof
(
bŒfs_h—d”
, 
chunk_Œ“_uuid
),

3551 
BTRFS_UUID_SIZE
);

3553 
»t
 = 
	`bŒfs_»ad_chunk_Œ“
(
fs_šfo
);

3554 ià(
»t
) {

3555 
	`bŒfs_”r
(
fs_šfo
, "çedØ»ad chunk»e: %d", 
»t
);

3556 
ç_Œ“_roÙs
;

3566 
	`bŒfs_ä“_exŒa_devids
(
fs_deviûs
);

3567 ià(!
fs_deviûs
->
Ï‹¡_dev
->
bdev
) {

3568 
	`bŒfs_”r
(
fs_šfo
, "failedo„ead devices");

3569 
»t
 = -
EIO
;

3570 
ç_Œ“_roÙs
;

3573 
»t
 = 
	`š™_Œ“_roÙs
(
fs_šfo
);

3574 ià(
»t
)

3575 
ç_Œ“_roÙs
;

3582 
»t
 = 
	`bŒfs_g‘_dev_zÚe_šfo_®l_deviûs
(
fs_šfo
);

3583 ià(
»t
) {

3584 
	`bŒfs_”r
(
fs_šfo
,

3585 "zÚed: faedØ»ad deviû zÚšfo: %d", 
»t
);

3586 
ç_block_groups
;

3597 ià(
fs_šfo
->
uuid_roÙ
 && !
	`bŒfs_‹¡_İt
(fs_šfo, 
RESCAN_UUID_TREE
) &&

3598 
fs_šfo
->
g’”©iÚ
 =ğ
	`bŒfs_su³r_uuid_Œ“_g’”©iÚ
(
disk_su³r
))

3599 
	`£t_b™
(
BTRFS_FS_UPDATE_UUID_TREE_GEN
, &
fs_šfo
->
æags
);

3601 
»t
 = 
	`bŒfs_v”ify_dev_ex‹Ás
(
fs_šfo
);

3602 ià(
»t
) {

3603 
	`bŒfs_”r
(
fs_šfo
,

3605 
»t
);

3606 
ç_block_groups
;

3608 
»t
 = 
	`bŒfs_»cov”_b®ªû
(
fs_šfo
);

3609 ià(
»t
) {

3610 
	`bŒfs_”r
(
fs_šfo
, "çedØ»cov” b®ªû: %d", 
»t
);

3611 
ç_block_groups
;

3614 
»t
 = 
	`bŒfs_š™_dev_¡©s
(
fs_šfo
);

3615 ià(
»t
) {

3616 
	`bŒfs_”r
(
fs_šfo
, "çedØš™ dev_¡©s: %d", 
»t
);

3617 
ç_block_groups
;

3620 
»t
 = 
	`bŒfs_š™_dev_»¶aû
(
fs_šfo
);

3621 ià(
»t
) {

3622 
	`bŒfs_”r
(
fs_šfo
, "çedØš™ dev_»¶aû: %d", 
»t
);

3623 
ç_block_groups
;

3626 
»t
 = 
	`bŒfs_check_zÚed_mode
(
fs_šfo
);

3627 ià(
»t
) {

3628 
	`bŒfs_”r
(
fs_šfo
, "failedo initialize zoned mode: %d",

3629 
»t
);

3630 
ç_block_groups
;

3633 
»t
 = 
	`bŒfs_sysfs_add_fsid
(
fs_deviûs
);

3634 ià(
»t
) {

3635 
	`bŒfs_”r
(
fs_šfo
, "failedo init sysfs fsid interface: %d",

3636 
»t
);

3637 
ç_block_groups
;

3640 
»t
 = 
	`bŒfs_sysfs_add_mouÁed
(
fs_šfo
);

3641 ià(
»t
) {

3642 
	`bŒfs_”r
(
fs_šfo
, "çedØš™ sysf š‹rçû: %d", 
»t
);

3643 
ç_fsdev_sysfs
;

3646 
»t
 = 
	`bŒfs_š™_¥aû_šfo
(
fs_šfo
);

3647 ià(
»t
) {

3648 
	`bŒfs_”r
(
fs_šfo
, "çedØš™Ÿliz¥aû info: %d", 
»t
);

3649 
ç_sysfs
;

3652 
»t
 = 
	`bŒfs_»ad_block_groups
(
fs_šfo
);

3653 ià(
»t
) {

3654 
	`bŒfs_”r
(
fs_šfo
, "çedØ»ad block groups: %d", 
»t
);

3655 
ç_sysfs
;

3658 
	`bŒfs_ä“_zÚe_ÿche
(
fs_šfo
);

3660 
	`bŒfs_check_aùive_zÚe_»£rv©iÚ
(
fs_šfo
);

3662 ià(!
	`sb_rdÚly
(
sb
è&& 
fs_šfo
->
fs_deviûs
->
missšg_deviûs
 &&

3663 !
	`bŒfs_check_rw_deg¿dabË
(
fs_šfo
, 
NULL
)) {

3664 
	`bŒfs_w¬n
(
fs_šfo
,

3666 
»t
 = -
EINVAL
;

3667 
ç_sysfs
;

3670 
fs_šfo
->
ş—Ãr_kth»ad
 = 
	`kth»ad_run
(cleaner_kthread, fs_info,

3672 ià(
	`IS_ERR
(
fs_šfo
->
ş—Ãr_kth»ad
)) {

3673 
»t
 = 
	`PTR_ERR
(
fs_šfo
->
ş—Ãr_kth»ad
);

3674 
ç_sysfs
;

3677 
fs_šfo
->
Œª§ùiÚ_kth»ad
 = 
	`kth»ad_run
(transaction_kthread,

3678 
Œ“_roÙ
,

3680 ià(
	`IS_ERR
(
fs_šfo
->
Œª§ùiÚ_kth»ad
)) {

3681 
»t
 = 
	`PTR_ERR
(
fs_šfo
->
Œª§ùiÚ_kth»ad
);

3682 
ç_ş—Ãr
;

3685 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
NOSSD
) &&

3686 !
fs_šfo
->
fs_deviûs
->
rÙ©šg
) {

3687 
	`bŒfs_£t_ªd_šfo
(
fs_šfo
, 
SSD
, "enabling ssd optimizations");

3699 ià(!(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DISCARD_SYNC
) ||

3700 
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DISCARD_ASYNC
) ||

3701 
	`bŒfs_‹¡_İt
(
fs_šfo
, 
NODISCARD
)) &&

3702 
fs_šfo
->
fs_deviûs
->
disÿrdabË
 &&

3703 !
	`bŒfs_is_zÚed
(
fs_šfo
)) {

3704 
	`bŒfs_£t_ªd_šfo
(
fs_šfo
, 
DISCARD_ASYNC
,

3708 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


3709 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
CHECK_INTEGRITY
)) {

3710 
»t
 = 
	`bŒfsic_mouÁ
(
fs_šfo
, 
fs_deviûs
,

3711 
	`bŒfs_‹¡_İt
(
fs_šfo
,

3712 
CHECK_INTEGRITY_DATA
) ? 1 : 0,

3713 
fs_šfo
->
check_š‹gr™y_´št_mask
);

3714 ià(
»t
)

3715 
	`bŒfs_w¬n
(
fs_šfo
,

3717 
»t
);

3720 
»t
 = 
	`bŒfs_»ad_qgroup_cÚfig
(
fs_šfo
);

3721 ià(
»t
)

3722 
ç_Œªs_kth»ad
;

3724 ià(
	`bŒfs_bud_»f_Œ“
(
fs_šfo
))

3725 
	`bŒfs_”r
(
fs_šfo
, "couldn't build„efree");

3728 ià(
	`bŒfs_su³r_log_roÙ
(
disk_su³r
) != 0 &&

3729 !
	`bŒfs_‹¡_İt
(
fs_šfo
, 
NOLOGREPLAY
)) {

3730 
	`bŒfs_šfo
(
fs_šfo
, "startree-log„eplay");

3731 
»t
 = 
	`bŒfs_»¶ay_log
(
fs_šfo
, 
fs_deviûs
);

3732 ià(
»t
)

3733 
ç_qgroup
;

3736 
fs_šfo
->
fs_roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(fs_šfo, 
BTRFS_FS_TREE_OBJECTID
, 
Œue
);

3737 ià(
	`IS_ERR
(
fs_šfo
->
fs_roÙ
)) {

3738 
»t
 = 
	`PTR_ERR
(
fs_šfo
->
fs_roÙ
);

3739 
	`bŒfs_w¬n
(
fs_šfo
, "çedØ»ad f Œ“: %d", 
»t
);

3740 
fs_šfo
->
fs_roÙ
 = 
NULL
;

3741 
ç_qgroup
;

3744 ià(
	`sb_rdÚly
(
sb
))

3745 
ş—r_ÚeshÙ
;

3747 
»t
 = 
	`bŒfs_¡¬t_´e_rw_mouÁ
(
fs_šfo
);

3748 ià(
»t
) {

3749 
	`şo£_ù»e
(
fs_šfo
);

3750  
»t
;

3752 
	`bŒfs_disÿrd_»sume
(
fs_šfo
);

3754 ià(
fs_šfo
->
uuid_roÙ
 &&

3755 (
	`bŒfs_‹¡_İt
(
fs_šfo
, 
RESCAN_UUID_TREE
) ||

3756 
fs_šfo
->
g’”©iÚ
 !ğ
	`bŒfs_su³r_uuid_Œ“_g’”©iÚ
(
disk_su³r
))) {

3757 
	`bŒfs_šfo
(
fs_šfo
, "checking UUIDree");

3758 
»t
 = 
	`bŒfs_check_uuid_Œ“
(
fs_šfo
);

3759 ià(
»t
) {

3760 
	`bŒfs_w¬n
(
fs_šfo
,

3761 "çedØcheckhUUID»e: %d", 
»t
);

3762 
	`şo£_ù»e
(
fs_šfo
);

3763  
»t
;

3767 
	`£t_b™
(
BTRFS_FS_OPEN
, &
fs_šfo
->
æags
);

3770 ià(
	`‹¡_b™
(
BTRFS_FS_UNFINISHED_DROPS
, &
fs_šfo
->
æags
))

3771 
	`wake_up_´oûss
(
fs_šfo
->
ş—Ãr_kth»ad
);

3773 
ş—r_ÚeshÙ
:

3774 
	`bŒfs_ş—r_ÚeshÙ_İtiÚs
(
fs_šfo
);

3777 
ç_qgroup
:

3778 
	`bŒfs_ä“_qgroup_cÚfig
(
fs_šfo
);

3779 
ç_Œªs_kth»ad
:

3780 
	`kth»ad_¡İ
(
fs_šfo
->
Œª§ùiÚ_kth»ad
);

3781 
	`bŒfs_ş—nup_Œª§ùiÚ
(
fs_šfo
);

3782 
	`bŒfs_ä“_fs_roÙs
(
fs_šfo
);

3783 
ç_ş—Ãr
:

3784 
	`kth»ad_¡İ
(
fs_šfo
->
ş—Ãr_kth»ad
);

3790 
	`fem­_wr™e_ªd_wa™
(
fs_šfo
->
bŒ“_šode
->
i_m­pšg
);

3792 
ç_sysfs
:

3793 
	`bŒfs_sysfs_»move_mouÁed
(
fs_šfo
);

3795 
ç_fsdev_sysfs
:

3796 
	`bŒfs_sysfs_»move_fsid
(
fs_šfo
->
fs_deviûs
);

3798 
ç_block_groups
:

3799 
	`bŒfs_put_block_group_ÿche
(
fs_šfo
);

3801 
ç_Œ“_roÙs
:

3802 ià(
fs_šfo
->
d©a_»loc_roÙ
)

3803 
	`bŒfs_drİ_ªd_ä“_fs_roÙ
(
fs_šfo
, fs_šfo->
d©a_»loc_roÙ
);

3804 
	`ä“_roÙ_poš‹rs
(
fs_šfo
, 
Œue
);

3805 
	`šv®id©e_šode_·ges2
(
fs_šfo
->
bŒ“_šode
->
i_m­pšg
);

3807 
ç_sb_bufãr
:

3808 
	`bŒfs_¡İ_®l_wÜk”s
(
fs_šfo
);

3809 
	`bŒfs_ä“_block_groups
(
fs_šfo
);

3810 
ç_®loc
:

3811 
	`bŒfs_m­pšg_Œ“_ä“
(&
fs_šfo
->
m­pšg_Œ“
);

3813 
	`ut
(
fs_šfo
->
bŒ“_šode
);

3814 
ç
:

3815 
	`bŒfs_şo£_deviûs
(
fs_šfo
->
fs_deviûs
);

3816 
	`ASSERT
(
»t
 < 0);

3817  
»t
;

3818 
	}
}

3819 
ALLOW_ERROR_INJECTION
(
İ’_ù»e
, 
ERRNO
);

3822 
__cŞd
 
	$İ’_ù»e_·¹™iÚ
(
su³r_block
 *
sb
, 
bŒfs_fs_deviûs
 *
fs_deviûs
,

3823 *
İtiÚs
, 
·¹™iÚ_Üd”
)

3825 
u32
 
£ùÜsize
;

3826 
u32
 
nodesize
;

3827 
u32
 
¡resize
;

3828 
u64
 
g’”©iÚ
;

3829 
u64
 
ã©u»s
;

3830 
u16
 
csum_ty³
;

3831 
bŒfs_su³r_block
 *
disk_su³r
;

3832 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

3833 
bŒfs_roÙ
 *
Œ“_roÙ
;

3834 
bŒfs_roÙ
 *
chunk_roÙ
;

3835 
»t
;

3836 
Ëv–
;

3838 
»t
 = 
	`š™_mouÁ_fs_šfo
(
fs_šfo
, 
sb
);

3839 ià(
»t
)

3840 
ç
;

3843 
Œ“_roÙ
 = 
	`bŒfs_®loc_roÙ
(
fs_šfo
, 
BTRFS_ROOT_TREE_OBJECTID
,

3844 
GFP_KERNEL
);

3845 
fs_šfo
->
Œ“_roÙ
 =ree_root;

3846 
chunk_roÙ
 = 
	`bŒfs_®loc_roÙ
(
fs_šfo
, 
BTRFS_CHUNK_TREE_OBJECTID
,

3847 
GFP_KERNEL
);

3848 
fs_šfo
->
chunk_roÙ
 = chunk_root;

3849 ià(!
Œ“_roÙ
 || !
chunk_roÙ
) {

3850 
»t
 = -
ENOMEM
;

3851 
ç
;

3854 
»t
 = 
	`bŒfs_š™_bŒ“_šode
(
sb
);

3855 ià(
»t
)

3856 
ç
;

3858 
	`šv®id©e_bdev
(
fs_deviûs
->
Ï‹¡_dev
->
bdev
);

3863 
disk_su³r
 = 
	`bŒfs_»ad_dev_su³r_·¹™iÚ
(
fs_deviûs
->
Ï‹¡_dev
->
bdev
, 
·¹™iÚ_Üd”
);

3864 ià(
	`IS_ERR
(
disk_su³r
)) {

3865 
»t
 = 
	`PTR_ERR
(
disk_su³r
);

3866 
ç_®loc
;

3869 
	`bŒfs_šfo
(
fs_šfo
, "fœ¡ mouÁ oàfesy¡em %pU", 
disk_su³r
->
fsid
);

3874 
csum_ty³
 = 
	`bŒfs_su³r_csum_ty³
(
disk_su³r
);

3875 ià(!
	`bŒfs_suµÜ‹d_su³r_csum
(
csum_ty³
)) {

3876 
	`bŒfs_”r
(
fs_šfo
, "unsupported checksum‡lgorithm: %u",

3877 
csum_ty³
);

3878 
»t
 = -
EINVAL
;

3879 
	`bŒfs_»Ëa£_disk_su³r
(
disk_su³r
);

3880 
ç_®loc
;

3883 
fs_šfo
->
csum_size
 = 
	`bŒfs_su³r_csum_size
(
disk_su³r
);

3885 
»t
 = 
	`bŒfs_š™_csum_hash
(
fs_šfo
, 
csum_ty³
);

3886 ià(
»t
) {

3887 
	`bŒfs_»Ëa£_disk_su³r
(
disk_su³r
);

3888 
ç_®loc
;

3895 ià(
	`bŒfs_check_su³r_csum
(
fs_šfo
, 
disk_su³r
)) {

3896 
	`bŒfs_”r
(
fs_šfo
, "superblock checksum mismatch");

3897 
»t
 = -
EINVAL
;

3898 
	`bŒfs_»Ëa£_disk_su³r
(
disk_su³r
);

3899 
ç_®loc
;

3907 
	`memıy
(
fs_šfo
->
su³r_cİy
, 
disk_su³r
, (*fs_info->super_copy));

3908 
	`bŒfs_»Ëa£_disk_su³r
(
disk_su³r
);

3910 
disk_su³r
 = 
fs_šfo
->
su³r_cİy
;

3913 
ã©u»s
 = 
	`bŒfs_su³r_æags
(
disk_su³r
);

3914 ià(
ã©u»s
 & 
BTRFS_SUPER_FLAG_CHANGING_FSID_V2
) {

3915 
ã©u»s
 &ğ~
BTRFS_SUPER_FLAG_CHANGING_FSID_V2
;

3916 
	`bŒfs_£t_su³r_æags
(
disk_su³r
, 
ã©u»s
);

3917 
	`bŒfs_šfo
(
fs_šfo
,

3921 
	`memıy
(
fs_šfo
->
su³r_fÜ_comm™
, fs_šfo->
su³r_cİy
,

3922 (*
fs_šfo
->
su³r_fÜ_comm™
));

3924 
»t
 = 
	`bŒfs_v®id©e_mouÁ_su³r_·¹™iÚ
(
fs_šfo
, 
·¹™iÚ_Üd”
);

3925 ià(
»t
) {

3926 
	`bŒfs_”r
(
fs_šfo
, "superblock contains fatalƒrrors");

3927 
»t
 = -
EINVAL
;

3928 
ç_®loc
;

3931 ià(!
	`bŒfs_su³r_roÙ
(
disk_su³r
)) {

3932 
	`bŒfs_”r
(
fs_šfo
, "invalid superblockree„oot bytenr");

3933 
»t
 = -
EINVAL
;

3934 
ç_®loc
;

3938 ià(
	`bŒfs_su³r_æags
(
disk_su³r
è& 
BTRFS_SUPER_FLAG_ERROR
)

3939 
	`WRITE_ONCE
(
fs_šfo
->
fs_”rÜ
, -
EUCLEAN
);

3945 
fs_šfo
->
com´ess_ty³
 = 
BTRFS_COMPRESS_ZLIB
;

3949 
nodesize
 = 
	`bŒfs_su³r_nodesize
(
disk_su³r
);

3950 
£ùÜsize
 = 
	`bŒfs_su³r_£ùÜsize
(
disk_su³r
);

3951 
¡resize
 = 
£ùÜsize
;

3952 
fs_šfo
->
dœty_m‘ad©a_b©ch
 = 
nodesize
 * (1 + 
	`og2
(
Ä_ıu_ids
));

3953 
fs_šfo
->
d–®loc_b©ch
 = 
£ùÜsize
 * 512 * (1 + 
	`og2
(
Ä_ıu_ids
));

3955 
fs_šfo
->
nodesize
 =‚odesize;

3956 
fs_šfo
->
£ùÜsize
 = sectorsize;

3957 
fs_šfo
->
£ùÜsize_b™s
 = 
	`og2
(
£ùÜsize
);

3958 
fs_šfo
->
csums_³r_Ëaf
 = 
	`BTRFS_MAX_ITEM_SIZE
(fs_šfoè/ fs_šfo->
csum_size
;

3959 
fs_šfo
->
¡resize
 = stripesize;

3961 
»t
 = 
	`bŒfs_·r£_İtiÚs
(
fs_šfo
, 
İtiÚs
, 
sb
->
s_æags
);

3962 ià(
»t
)

3963 
ç_®loc
;

3965 
»t
 = 
	`bŒfs_check_ã©u»s
(
fs_šfo
, !
	`sb_rdÚly
(
sb
));

3966 ià(
»t
 < 0)

3967 
ç_®loc
;

3969 ià(
£ùÜsize
 < 
PAGE_SIZE
) {

3970 
bŒfs_sub·ge_šfo
 *
sub·ge_šfo
;

3978 
	`bŒfs_ş—r_İt
(
fs_šfo
->
mouÁ_İt
, 
SPACE_CACHE
);

3979 
	`bŒfs_£t_ªd_šfo
(
fs_šfo
, 
FREE_SPACE_TREE
,

3981 
£ùÜsize
, 
PAGE_SIZE
);

3983 
	`bŒfs_w¬n
(
fs_šfo
,

3985 
£ùÜsize
, 
PAGE_SIZE
);

3986 
sub·ge_šfo
 = 
	`kz®loc
((*sub·ge_šfo), 
GFP_KERNEL
);

3987 ià(!
sub·ge_šfo
) {

3988 
»t
 = -
ENOMEM
;

3989 
ç_®loc
;

3991 
	`bŒfs_š™_sub·ge_šfo
(
sub·ge_šfo
, 
£ùÜsize
);

3992 
fs_šfo
->
sub·ge_šfo
 = subpage_info;

3995 
»t
 = 
	`bŒfs_š™_wÜkqueues
(
fs_šfo
);

3996 ià(
»t
)

3997 
ç_sb_bufãr
;

3999 
sb
->
s_bdi
->
¿_·ges
 *ğ
	`bŒfs_su³r_num_deviûs
(
disk_su³r
);

4000 
sb
->
s_bdi
->
¿_·ges
 = 
	`max
(sb->s_bdi->¿_·ges, 
SZ_4M
 / 
PAGE_SIZE
);

4002 
sb
->
s_blocksize
 = 
£ùÜsize
;

4003 
sb
->
s_blocksize_b™s
 = 
	`blksize_b™s
(
£ùÜsize
);

4004 
	`memıy
(&
sb
->
s_uuid
, 
fs_šfo
->
fs_deviûs
->
fsid
, 
BTRFS_FSID_SIZE
);

4006 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

4007 
»t
 = 
	`bŒfs_»ad_sys_¬¿y
(
fs_šfo
);

4008 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

4009 ià(
»t
) {

4010 
	`bŒfs_”r
(
fs_šfo
, "çedØ»adhsy¡em‡¼ay: %d", 
»t
);

4011 
ç_sb_bufãr
;

4014 
g’”©iÚ
 = 
	`bŒfs_su³r_chunk_roÙ_g’”©iÚ
(
disk_su³r
);

4015 
Ëv–
 = 
	`bŒfs_su³r_chunk_roÙ_Ëv–
(
disk_su³r
);

4016 
»t
 = 
	`lßd_su³r_roÙ
(
chunk_roÙ
, 
	`bŒfs_su³r_chunk_roÙ
(
disk_su³r
),

4017 
g’”©iÚ
, 
Ëv–
);

4018 ià(
»t
) {

4019 
	`bŒfs_”r
(
fs_šfo
, "failedo„ead chunk„oot");

4020 
ç_Œ“_roÙs
;

4023 
	`»ad_ex‹Á_bufãr
(
chunk_roÙ
->
node
, 
fs_šfo
->
chunk_Œ“_uuid
,

4024 
	`off£tof
(
bŒfs_h—d”
, 
chunk_Œ“_uuid
),

4025 
BTRFS_UUID_SIZE
);

4027 
»t
 = 
	`bŒfs_»ad_chunk_Œ“_·¹™iÚ
(
fs_šfo
, 
·¹™iÚ_Üd”
);

4028 ià(
»t
) {

4029 
	`bŒfs_”r
(
fs_šfo
, "çedØ»ad chunk»e: %d", 
»t
);

4030 
ç_Œ“_roÙs
;

4040 
	`bŒfs_ä“_exŒa_devids
(
fs_deviûs
);

4041 ià(!
fs_deviûs
->
Ï‹¡_dev
->
bdev
) {

4042 
	`bŒfs_”r
(
fs_šfo
, "failedo„ead devices");

4043 
»t
 = -
EIO
;

4044 
ç_Œ“_roÙs
;

4047 
»t
 = 
	`š™_Œ“_roÙs
(
fs_šfo
);

4048 ià(
»t
)

4049 
ç_Œ“_roÙs
;

4056 
»t
 = 
	`bŒfs_g‘_dev_zÚe_šfo_®l_deviûs
(
fs_šfo
);

4057 ià(
»t
) {

4058 
	`bŒfs_”r
(
fs_šfo
,

4059 "zÚed: faedØ»ad deviû zÚšfo: %d", 
»t
);

4060 
ç_block_groups
;

4071 ià(
fs_šfo
->
uuid_roÙ
 && !
	`bŒfs_‹¡_İt
(fs_šfo, 
RESCAN_UUID_TREE
) &&

4072 
fs_šfo
->
g’”©iÚ
 =ğ
	`bŒfs_su³r_uuid_Œ“_g’”©iÚ
(
disk_su³r
))

4073 
	`£t_b™
(
BTRFS_FS_UPDATE_UUID_TREE_GEN
, &
fs_šfo
->
æags
);

4075 
»t
 = 
	`bŒfs_v”ify_dev_ex‹Ás
(
fs_šfo
);

4076 ià(
»t
) {

4077 
	`bŒfs_”r
(
fs_šfo
,

4079 
»t
);

4080 
ç_block_groups
;

4082 
»t
 = 
	`bŒfs_»cov”_b®ªû
(
fs_šfo
);

4083 ià(
»t
) {

4084 
	`bŒfs_”r
(
fs_šfo
, "çedØ»cov” b®ªû: %d", 
»t
);

4085 
ç_block_groups
;

4088 
»t
 = 
	`bŒfs_š™_dev_¡©s
(
fs_šfo
);

4089 ià(
»t
) {

4090 
	`bŒfs_”r
(
fs_šfo
, "çedØš™ dev_¡©s: %d", 
»t
);

4091 
ç_block_groups
;

4094 
»t
 = 
	`bŒfs_š™_dev_»¶aû
(
fs_šfo
);

4095 ià(
»t
) {

4096 
	`bŒfs_”r
(
fs_šfo
, "çedØš™ dev_»¶aû: %d", 
»t
);

4097 
ç_block_groups
;

4100 
»t
 = 
	`bŒfs_check_zÚed_mode
(
fs_šfo
);

4101 ià(
»t
) {

4102 
	`bŒfs_”r
(
fs_šfo
, "failedo initialize zoned mode: %d",

4103 
»t
);

4104 
ç_block_groups
;

4107 
»t
 = 
	`bŒfs_sysfs_add_fsid
(
fs_deviûs
);

4108 ià(
»t
) {

4109 
	`bŒfs_”r
(
fs_šfo
, "failedo init sysfs fsid interface: %d",

4110 
»t
);

4111 
ç_block_groups
;

4114 
»t
 = 
	`bŒfs_sysfs_add_mouÁed
(
fs_šfo
);

4115 ià(
»t
) {

4116 
	`bŒfs_”r
(
fs_šfo
, "çedØš™ sysf š‹rçû: %d", 
»t
);

4117 
ç_fsdev_sysfs
;

4120 
»t
 = 
	`bŒfs_š™_¥aû_šfo
(
fs_šfo
);

4121 ià(
»t
) {

4122 
	`bŒfs_”r
(
fs_šfo
, "çedØš™Ÿliz¥aû info: %d", 
»t
);

4123 
ç_sysfs
;

4126 
»t
 = 
	`bŒfs_»ad_block_groups
(
fs_šfo
);

4127 ià(
»t
) {

4128 
	`bŒfs_”r
(
fs_šfo
, "çedØ»ad block groups: %d", 
»t
);

4129 
ç_sysfs
;

4132 
	`bŒfs_ä“_zÚe_ÿche
(
fs_šfo
);

4134 
	`bŒfs_check_aùive_zÚe_»£rv©iÚ
(
fs_šfo
);

4136 ià(!
	`sb_rdÚly
(
sb
è&& 
fs_šfo
->
fs_deviûs
->
missšg_deviûs
 &&

4137 !
	`bŒfs_check_rw_deg¿dabË
(
fs_šfo
, 
NULL
)) {

4138 
	`bŒfs_w¬n
(
fs_šfo
,

4140 
»t
 = -
EINVAL
;

4141 
ç_sysfs
;

4144 
fs_šfo
->
ş—Ãr_kth»ad
 = 
	`kth»ad_run
(cleaner_kthread, fs_info,

4146 ià(
	`IS_ERR
(
fs_šfo
->
ş—Ãr_kth»ad
)) {

4147 
»t
 = 
	`PTR_ERR
(
fs_šfo
->
ş—Ãr_kth»ad
);

4148 
ç_sysfs
;

4151 
fs_šfo
->
Œª§ùiÚ_kth»ad
 = 
	`kth»ad_run
(transaction_kthread,

4152 
Œ“_roÙ
,

4154 ià(
	`IS_ERR
(
fs_šfo
->
Œª§ùiÚ_kth»ad
)) {

4155 
»t
 = 
	`PTR_ERR
(
fs_šfo
->
Œª§ùiÚ_kth»ad
);

4156 
ç_ş—Ãr
;

4159 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
NOSSD
) &&

4160 !
fs_šfo
->
fs_deviûs
->
rÙ©šg
) {

4161 
	`bŒfs_£t_ªd_šfo
(
fs_šfo
, 
SSD
, "enabling ssd optimizations");

4173 ià(!(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DISCARD_SYNC
) ||

4174 
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DISCARD_ASYNC
) ||

4175 
	`bŒfs_‹¡_İt
(
fs_šfo
, 
NODISCARD
)) &&

4176 
fs_šfo
->
fs_deviûs
->
disÿrdabË
 &&

4177 !
	`bŒfs_is_zÚed
(
fs_šfo
)) {

4178 
	`bŒfs_£t_ªd_šfo
(
fs_šfo
, 
DISCARD_ASYNC
,

4182 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


4183 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
CHECK_INTEGRITY
)) {

4184 
»t
 = 
	`bŒfsic_mouÁ
(
fs_šfo
, 
fs_deviûs
,

4185 
	`bŒfs_‹¡_İt
(
fs_šfo
,

4186 
CHECK_INTEGRITY_DATA
) ? 1 : 0,

4187 
fs_šfo
->
check_š‹gr™y_´št_mask
);

4188 ià(
»t
)

4189 
	`bŒfs_w¬n
(
fs_šfo
,

4191 
»t
);

4194 
»t
 = 
	`bŒfs_»ad_qgroup_cÚfig
(
fs_šfo
);

4195 ià(
»t
)

4196 
ç_Œªs_kth»ad
;

4198 ià(
	`bŒfs_bud_»f_Œ“
(
fs_šfo
))

4199 
	`bŒfs_”r
(
fs_šfo
, "couldn't build„efree");

4202 ià(
	`bŒfs_su³r_log_roÙ
(
disk_su³r
) != 0 &&

4203 !
	`bŒfs_‹¡_İt
(
fs_šfo
, 
NOLOGREPLAY
)) {

4204 
	`bŒfs_šfo
(
fs_šfo
, "startree-log„eplay");

4205 
»t
 = 
	`bŒfs_»¶ay_log
(
fs_šfo
, 
fs_deviûs
);

4206 ià(
»t
)

4207 
ç_qgroup
;

4210 
fs_šfo
->
fs_roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(fs_šfo, 
BTRFS_FS_TREE_OBJECTID
, 
Œue
);

4211 ià(
	`IS_ERR
(
fs_šfo
->
fs_roÙ
)) {

4212 
»t
 = 
	`PTR_ERR
(
fs_šfo
->
fs_roÙ
);

4213 
	`bŒfs_w¬n
(
fs_šfo
, "çedØ»ad f Œ“: %d", 
»t
);

4214 
fs_šfo
->
fs_roÙ
 = 
NULL
;

4215 
ç_qgroup
;

4218 ià(
	`sb_rdÚly
(
sb
))

4219 
ş—r_ÚeshÙ
;

4221 
»t
 = 
	`bŒfs_¡¬t_´e_rw_mouÁ
(
fs_šfo
);

4222 ià(
»t
) {

4223 
	`şo£_ù»e
(
fs_šfo
);

4224  
»t
;

4226 
	`bŒfs_disÿrd_»sume
(
fs_šfo
);

4228 ià(
fs_šfo
->
uuid_roÙ
 &&

4229 (
	`bŒfs_‹¡_İt
(
fs_šfo
, 
RESCAN_UUID_TREE
) ||

4230 
fs_šfo
->
g’”©iÚ
 !ğ
	`bŒfs_su³r_uuid_Œ“_g’”©iÚ
(
disk_su³r
))) {

4231 
	`bŒfs_šfo
(
fs_šfo
, "checking UUIDree");

4232 
»t
 = 
	`bŒfs_check_uuid_Œ“
(
fs_šfo
);

4233 ià(
»t
) {

4234 
	`bŒfs_w¬n
(
fs_šfo
,

4235 "çedØcheckhUUID»e: %d", 
»t
);

4236 
	`şo£_ù»e
(
fs_šfo
);

4237  
»t
;

4241 
	`£t_b™
(
BTRFS_FS_OPEN
, &
fs_šfo
->
æags
);

4244 ià(
	`‹¡_b™
(
BTRFS_FS_UNFINISHED_DROPS
, &
fs_šfo
->
æags
))

4245 
	`wake_up_´oûss
(
fs_šfo
->
ş—Ãr_kth»ad
);

4247 
ş—r_ÚeshÙ
:

4248 
	`bŒfs_ş—r_ÚeshÙ_İtiÚs
(
fs_šfo
);

4251 
ç_qgroup
:

4252 
	`bŒfs_ä“_qgroup_cÚfig
(
fs_šfo
);

4253 
ç_Œªs_kth»ad
:

4254 
	`kth»ad_¡İ
(
fs_šfo
->
Œª§ùiÚ_kth»ad
);

4255 
	`bŒfs_ş—nup_Œª§ùiÚ
(
fs_šfo
);

4256 
	`bŒfs_ä“_fs_roÙs
(
fs_šfo
);

4257 
ç_ş—Ãr
:

4258 
	`kth»ad_¡İ
(
fs_šfo
->
ş—Ãr_kth»ad
);

4264 
	`fem­_wr™e_ªd_wa™
(
fs_šfo
->
bŒ“_šode
->
i_m­pšg
);

4266 
ç_sysfs
:

4267 
	`bŒfs_sysfs_»move_mouÁed
(
fs_šfo
);

4269 
ç_fsdev_sysfs
:

4270 
	`bŒfs_sysfs_»move_fsid
(
fs_šfo
->
fs_deviûs
);

4272 
ç_block_groups
:

4273 
	`bŒfs_put_block_group_ÿche
(
fs_šfo
);

4275 
ç_Œ“_roÙs
:

4276 ià(
fs_šfo
->
d©a_»loc_roÙ
)

4277 
	`bŒfs_drİ_ªd_ä“_fs_roÙ
(
fs_šfo
, fs_šfo->
d©a_»loc_roÙ
);

4278 
	`ä“_roÙ_poš‹rs
(
fs_šfo
, 
Œue
);

4279 
	`šv®id©e_šode_·ges2
(
fs_šfo
->
bŒ“_šode
->
i_m­pšg
);

4281 
ç_sb_bufãr
:

4282 
	`bŒfs_¡İ_®l_wÜk”s
(
fs_šfo
);

4283 
	`bŒfs_ä“_block_groups
(
fs_šfo
);

4284 
ç_®loc
:

4285 
	`bŒfs_m­pšg_Œ“_ä“
(&
fs_šfo
->
m­pšg_Œ“
);

4287 
	`ut
(
fs_šfo
->
bŒ“_šode
);

4288 
ç
:

4289 
	`bŒfs_şo£_deviûs
(
fs_šfo
->
fs_deviûs
);

4290 
	`ASSERT
(
»t
 < 0);

4291  
»t
;

4292 
	}
}

4293 
ALLOW_ERROR_INJECTION
(
İ’_ù»e_·¹™iÚ
, 
ERRNO
);

4296 
	$bŒfs_’d_su³r_wr™e
(
bio
 *bio)

4298 
bŒfs_deviû
 *
deviû
 = 
bio
->
bi_´iv©e
;

4299 
bio_vec
 *
bvec
;

4300 
bvec_™”_®l
 
™”_®l
;

4301 
·ge
 *page;

4303 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
™”_®l
) {

4304 
·ge
 = 
bvec
->
bv_·ge
;

4306 ià(
bio
->
bi_¡©us
) {

4307 
	`bŒfs_w¬n_¾_š_rcu
(
deviû
->
fs_šfo
,

4309 
	`bŒfs_dev_Çme
(
deviû
),

4310 
	`blk_¡©us_to_”ºo
(
bio
->
bi_¡©us
));

4311 
	`CË¬PageU±od©e
(
·ge
);

4312 
	`S‘PageE¼Ü
(
·ge
);

4313 
	`bŒfs_dev_¡©_šc_ªd_´št
(
deviû
,

4314 
BTRFS_DEV_STAT_WRITE_ERRS
);

4316 
	`S‘PageU±od©e
(
·ge
);

4319 
	`put_·ge
(
·ge
);

4320 
	`uÆock_·ge
(
·ge
);

4323 
	`bio_put
(
bio
);

4324 
	}
}

4326 
bŒfs_su³r_block
 *
	$bŒfs_»ad_dev_Úe_su³r
(
block_deviû
 *
bdev
,

4327 
cİy_num
, 
boŞ
 
drİ_ÿche
)

4329 
bŒfs_su³r_block
 *
su³r
;

4330 
·ge
 *page;

4331 
u64
 
by‹Ä
, 
by‹Ä_Üig
;

4332 
add»ss_¥aû
 *
m­pšg
 = 
bdev
->
bd_šode
->
i_m­pšg
;

4333 
»t
;

4335 
by‹Ä_Üig
 = 
	`bŒfs_sb_off£t
(
cİy_num
);

4336 
»t
 = 
	`bŒfs_sb_log_loÿtiÚ_bdev
(
bdev
, 
cİy_num
, 
READ
, &
by‹Ä
);

4337 ià(
»t
 =ğ-
ENOENT
)

4338  
	`ERR_PTR
(-
EINVAL
);

4339 ià(
»t
)

4340  
	`ERR_PTR
(
»t
);

4342 ià(
by‹Ä
 + 
BTRFS_SUPER_INFO_SIZE
 >ğ
	`bdev_Ä_by‹s
(
bdev
))

4343  
	`ERR_PTR
(-
EINVAL
);

4345 ià(
drİ_ÿche
) {

4347 
	`ASSERT
(
cİy_num
 == 0);

4353 
	`šv®id©e_šode_·ges2_¿nge
(
m­pšg
,

4354 
by‹Ä
 >> 
PAGE_SHIFT
,

4355 (
by‹Ä
 + 
BTRFS_SUPER_INFO_SIZE
è>> 
PAGE_SHIFT
);

4358 
·ge
 = 
	`»ad_ÿche_·ge_gå
(
m­pšg
, 
by‹Ä
 >> 
PAGE_SHIFT
, 
GFP_NOFS
);

4359 ià(
	`IS_ERR
(
·ge
))

4360  
	`ERR_CAST
(
·ge
);

4362 
su³r
 = 
	`·ge_add»ss
(
·ge
);

4363 ià(
	`bŒfs_su³r_magic
(
su³r
è!ğ
BTRFS_MAGIC
) {

4364 
	`bŒfs_»Ëa£_disk_su³r
(
su³r
);

4365  
	`ERR_PTR
(-
ENODATA
);

4368 ià(
	`bŒfs_su³r_by‹Ä
(
su³r
è!ğ
by‹Ä_Üig
) {

4369 
	`bŒfs_»Ëa£_disk_su³r
(
su³r
);

4370  
	`ERR_PTR
(-
EINVAL
);

4373  
su³r
;

4374 
	}
}

4377 
bŒfs_su³r_block
 *
	$bŒfs_»ad_dev_Úe_su³r_·¹™iÚ
(
block_deviû
 *
bdev
,

4378 
cİy_num
, 
boŞ
 
drİ_ÿche
, 
·¹™iÚ_Üd”
)

4380 
bŒfs_su³r_block
 *
su³r
;

4381 
·ge
 *page;

4382 
u64
 
by‹Ä
, 
by‹Ä_Üig
;

4383 
add»ss_¥aû
 *
m­pšg
 = 
bdev
->
bd_šode
->
i_m­pšg
;

4384 
»t
;

4385 
u64
 
sb_off£t
 = 
BTRFS_SUPER_INFO_SIZE
 * 
·¹™iÚ_Üd”
;

4386 
by‹Ä_Üig
 = 
	`bŒfs_sb_off£t_·¹™iÚ
(
cİy_num
, 
sb_off£t
);

4388 
»t
 = 
	`bŒfs_sb_log_loÿtiÚ_bdev_·¹™iÚ
(
bdev
, 
cİy_num
, 
READ
, &
by‹Ä
, 
sb_off£t
);

4391 ià(
»t
 =ğ-
ENOENT
)

4392  
	`ERR_PTR
(-
EINVAL
);

4393 ià(
»t
)

4394  
	`ERR_PTR
(
»t
);

4396 ià(
by‹Ä
 + 
BTRFS_SUPER_INFO_SIZE
 >ğ
	`bdev_Ä_by‹s
(
bdev
))

4397  
	`ERR_PTR
(-
EINVAL
);

4399 ià(
drİ_ÿche
) {

4401 
	`ASSERT
(
cİy_num
 == 0);

4407 
	`šv®id©e_šode_·ges2_¿nge
(
m­pšg
,

4408 
by‹Ä
 >> 
PAGE_SHIFT
,

4409 (
by‹Ä
 + 
BTRFS_SUPER_INFO_SIZE
è>> 
PAGE_SHIFT
);

4412 
·ge
 = 
	`»ad_ÿche_·ge_gå
(
m­pšg
, 
by‹Ä
 >> 
PAGE_SHIFT
, 
GFP_NOFS
);

4413 ià(
	`IS_ERR
(
·ge
))

4414  
	`ERR_CAST
(
·ge
);

4416 
su³r
 = 
	`·ge_add»ss
(
·ge
);

4417 ià(
	`bŒfs_su³r_magic
(
su³r
è!ğ
BTRFS_MAGIC
) {

4418 
	`bŒfs_»Ëa£_disk_su³r
(
su³r
);

4419  
	`ERR_PTR
(-
ENODATA
);

4422 ià(
	`bŒfs_su³r_by‹Ä
(
su³r
è!ğ
by‹Ä_Üig
) {

4423 
	`bŒfs_»Ëa£_disk_su³r
(
su³r
);

4424  
	`ERR_PTR
(-
EINVAL
);

4427  
su³r
;

4428 
	}
}

4431 
bŒfs_su³r_block
 *
	$bŒfs_»ad_dev_su³r
(
block_deviû
 *
bdev
)

4433 
bŒfs_su³r_block
 *
su³r
, *
Ï‹¡
 = 
NULL
;

4434 
i
;

4435 
u64
 
Œªsid
 = 0;

4442 
i
 = 0; i < 1; i++) {

4443 
su³r
 = 
	`bŒfs_»ad_dev_Úe_su³r
(
bdev
, 
i
, 
çl£
);

4444 ià(
	`IS_ERR
(
su³r
))

4447 ià(!
Ï‹¡
 || 
	`bŒfs_su³r_g’”©iÚ
(
su³r
è> 
Œªsid
) {

4448 ià(
Ï‹¡
)

4449 
	`bŒfs_»Ëa£_disk_su³r
(
su³r
);

4451 
Ï‹¡
 = 
su³r
;

4452 
Œªsid
 = 
	`bŒfs_su³r_g’”©iÚ
(
su³r
);

4456  
su³r
;

4457 
	}
}

4460 
bŒfs_su³r_block
 *
	$bŒfs_»ad_dev_su³r_·¹™iÚ
(
block_deviû
 *
bdev
, 
·¹™iÚ_Üd”
)

4462 
bŒfs_su³r_block
 *
su³r
, *
Ï‹¡
 = 
NULL
;

4463 
i
;

4464 
u64
 
Œªsid
 = 0;

4471 
i
 = 0; i < 1; i++) {

4472 
su³r
 = 
	`bŒfs_»ad_dev_Úe_su³r_·¹™iÚ
(
bdev
, 
i
, 
çl£
, 
·¹™iÚ_Üd”
);

4473 ià(
	`IS_ERR
(
su³r
))

4476 ià(!
Ï‹¡
 || 
	`bŒfs_su³r_g’”©iÚ
(
su³r
è> 
Œªsid
) {

4477 ià(
Ï‹¡
)

4478 
	`bŒfs_»Ëa£_disk_su³r
(
su³r
);

4480 
Ï‹¡
 = 
su³r
;

4481 
Œªsid
 = 
	`bŒfs_su³r_g’”©iÚ
(
su³r
);

4484 ià(
	`IS_ERR
(
su³r
))

4485 
	`´štk
(
KERN_ERR
 "btrfs_read_dev_super_partition: super isƒrror\n");

4486  
su³r
;

4487 
	}
}

4500 
	$wr™e_dev_su³rs
(
bŒfs_deviû
 *
deviû
,

4501 
bŒfs_su³r_block
 *
sb
, 
max_mœrÜs
)

4503 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

4504 
add»ss_¥aû
 *
m­pšg
 = 
deviû
->
bdev
->
bd_šode
->
i_m­pšg
;

4505 
	`SHASH_DESC_ON_STACK
(
shash
, 
fs_šfo
->
csum_shash
);

4506 
i
;

4507 
”rÜs
 = 0;

4508 
»t
;

4509 
u64
 
by‹Ä
, 
by‹Ä_Üig
;

4511 ià(
max_mœrÜs
 == 0)

4512 
max_mœrÜs
 = 
BTRFS_SUPER_MIRROR_MAX
;

4514 
shash
->
tfm
 = 
fs_šfo
->
csum_shash
;

4516 
u64
 
sb_by‹Ä_äom_fs_šfo
 = 
fs_šfo
->
su³r_cİy
->
by‹Ä
;

4518 
u64
 
sb_off£t
 = 0;

4519 ià(
sb_by‹Ä_äom_fs_šfo
 < 
BTRFS_SUPER_INFO_OFFSET_1
)

4520 
sb_off£t
 = 
sb_by‹Ä_äom_fs_šfo
 - 
BTRFS_SUPER_INFO_OFFSET
;

4521 ià(
sb_by‹Ä_äom_fs_šfo
 < 
BTRFS_SUPER_INFO_OFFSET_2
)

4522 
sb_off£t
 = 
sb_by‹Ä_äom_fs_šfo
 - 
BTRFS_SUPER_INFO_OFFSET_1
;

4524 
sb_off£t
 = 
sb_by‹Ä_äom_fs_šfo
 - 
BTRFS_SUPER_INFO_OFFSET_2
;

4526 
i
 = 0; i < 
max_mœrÜs
; i++) {

4527 
·ge
 *page;

4528 
bio
 *bio;

4529 
bŒfs_su³r_block
 *
disk_su³r
;

4533 
by‹Ä_Üig
 = 
	`bŒfs_sb_off£t_·¹™iÚ
(
i
, 
sb_off£t
);

4534 
»t
 = 
	`bŒfs_sb_log_loÿtiÚ_·¹™iÚ
(
deviû
, 
i
, 
WRITE
, &
by‹Ä
, 
sb_off£t
);

4535 ià(
»t
 =ğ-
ENOENT
) {

4537 } ià(
»t
 < 0) {

4538 
	`bŒfs_”r
(
deviû
->
fs_šfo
,

4540 
i
);

4541 
”rÜs
++;

4544 ià(
by‹Ä
 + 
BTRFS_SUPER_INFO_SIZE
 >=

4545 
deviû
->
·¹™iÚ_’d
)

4548 
	`bŒfs_£t_su³r_by‹Ä
(
sb
, 
by‹Ä_Üig
);

4550 
	`üy±o_shash_dige¡
(
shash
, (cÚ¡ *)
sb
 + 
BTRFS_CSUM_SIZE
,

4551 
BTRFS_SUPER_INFO_SIZE
 - 
BTRFS_CSUM_SIZE
,

4552 
sb
->
csum
);

4554 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
m­pšg
, 
by‹Ä
 >> 
PAGE_SHIFT
,

4555 
GFP_NOFS
);

4556 ià(!
·ge
) {

4557 
	`bŒfs_”r
(
deviû
->
fs_šfo
,

4559 
by‹Ä
);

4560 
”rÜs
++;

4565 
	`g‘_·ge
(
·ge
);

4567 
disk_su³r
 = 
	`·ge_add»ss
(
·ge
);

4568 
	`memıy
(
disk_su³r
, 
sb
, 
BTRFS_SUPER_INFO_SIZE
);

4575 
bio
 = 
	`bio_®loc
(
deviû
->
bdev
, 1,

4576 
REQ_OP_WRITE
 | 
REQ_SYNC
 | 
REQ_META
 | 
REQ_PRIO
,

4577 
GFP_NOFS
);

4578 
bio
->
bi_™”
.
bi_£ùÜ
 = 
by‹Ä
 >> 
SECTOR_SHIFT
;

4579 
bio
->
bi_´iv©e
 = 
deviû
;

4580 
bio
->
bi_’d_io
 = 
bŒfs_’d_su³r_wr™e
;

4581 
	`__bio_add_·ge
(
bio
, 
·ge
, 
BTRFS_SUPER_INFO_SIZE
,

4582 
	`off£t_š_·ge
(
by‹Ä
));

4589 ià(
i
 =ğ0 && !
	`bŒfs_‹¡_İt
(
deviû
->
fs_šfo
, 
NOBARRIER
))

4590 
bio
->
bi_İf
 |ğ
REQ_FUA
;

4592 
	`bŒfsic_check_bio
(
bio
);

4593 
	`subm™_bio
(
bio
);

4595 ià(
	`bŒfs_advªû_sb_log
(
deviû
, 
i
))

4596 
”rÜs
++;

4598  
”rÜs
 < 
i
 ? 0 : -1;

4599 
	}
}

4608 
	$wa™_dev_su³rs
(
bŒfs_deviû
 *
deviû
, 
max_mœrÜs
)

4610 
i
;

4611 
”rÜs
 = 0;

4612 
boŞ
 
´im¬y_çed
 = 
çl£
;

4613 
»t
;

4614 
u64
 
by‹Ä
;

4616 ià(
max_mœrÜs
 == 0)

4617 
max_mœrÜs
 = 
BTRFS_SUPER_MIRROR_MAX
;

4619 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

4620 
u64
 
sb_by‹Ä_äom_fs_šfo
 = 
fs_šfo
->
su³r_cİy
->
by‹Ä
;

4622 
u64
 
sb_off£t
 = 0;

4623 ià(
sb_by‹Ä_äom_fs_šfo
 < 
BTRFS_SUPER_INFO_OFFSET_1
)

4624 
sb_off£t
 = 
sb_by‹Ä_äom_fs_šfo
 - 
BTRFS_SUPER_INFO_OFFSET
;

4625 ià(
sb_by‹Ä_äom_fs_šfo
 < 
BTRFS_SUPER_INFO_OFFSET_2
)

4626 
sb_off£t
 = 
sb_by‹Ä_äom_fs_šfo
 - 
BTRFS_SUPER_INFO_OFFSET_1
;

4628 
sb_off£t
 = 
sb_by‹Ä_äom_fs_šfo
 - 
BTRFS_SUPER_INFO_OFFSET_2
;

4631 
i
 = 0; i < 
max_mœrÜs
; i++) {

4632 
·ge
 *page;

4634 
»t
 = 
	`bŒfs_sb_log_loÿtiÚ_·¹™iÚ
(
deviû
, 
i
, 
WRITE
, &
by‹Ä
, 
sb_off£t
);

4635 ià(
»t
 =ğ-
ENOENT
) {

4637 } ià(
»t
 < 0) {

4638 
”rÜs
++;

4639 ià(
i
 == 0)

4640 
´im¬y_çed
 = 
Œue
;

4643 ià(
by‹Ä
 + 
BTRFS_SUPER_INFO_SIZE
 >=

4644 
deviû
->
comm™_tÙ®_by‹s
)

4647 
·ge
 = 
	`fšd_g‘_·ge
(
deviû
->
bdev
->
bd_šode
->
i_m­pšg
,

4648 
by‹Ä
 >> 
PAGE_SHIFT
);

4649 ià(!
·ge
) {

4650 
”rÜs
++;

4651 ià(
i
 == 0)

4652 
´im¬y_çed
 = 
Œue
;

4656 
	`wa™_Ú_·ge_locked
(
·ge
);

4657 ià(
	`PageE¼Ü
(
·ge
)) {

4658 
”rÜs
++;

4659 ià(
i
 == 0)

4660 
´im¬y_çed
 = 
Œue
;

4664 
	`put_·ge
(
·ge
);

4667 
	`put_·ge
(
·ge
);

4671 ià(
´im¬y_çed
) {

4672 
	`bŒfs_”r
(
deviû
->
fs_šfo
, "error writing…rimary super blocko device %llu",

4673 
deviû
->
devid
);

4677  
”rÜs
 < 
i
 ? 0 : -1;

4678 
	}
}

4684 
	$bŒfs_’d_em±y_b¬r›r
(
bio
 *bio)

4686 
	`bio_unš™
(
bio
);

4687 
	`com¶‘e
(
bio
->
bi_´iv©e
);

4688 
	}
}

4694 
	$wr™e_dev_æush
(
bŒfs_deviû
 *
deviû
)

4696 
bio
 *biØğ&
deviû
->
æush_bio
;

4698 
deviû
->
Ï¡_æush_”rÜ
 = 
BLK_STS_OK
;

4700 #iâdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


4711 ià(!
	`bdev_wr™e_ÿche
(
deviû
->
bdev
))

4715 
	`bio_š™
(
bio
, 
deviû
->
bdev
, 
NULL
, 0,

4716 
REQ_OP_WRITE
 | 
REQ_SYNC
 | 
REQ_PREFLUSH
);

4717 
bio
->
bi_’d_io
 = 
bŒfs_’d_em±y_b¬r›r
;

4718 
	`š™_com¶‘iÚ
(&
deviû
->
æush_wa™
);

4719 
bio
->
bi_´iv©e
 = &
deviû
->
æush_wa™
;

4721 
	`bŒfsic_check_bio
(
bio
);

4722 
	`subm™_bio
(
bio
);

4723 
	`£t_b™
(
BTRFS_DEV_STATE_FLUSH_SENT
, &
deviû
->
dev_¡©e
);

4724 
	}
}

4730 
boŞ
 
	$wa™_dev_æush
(
bŒfs_deviû
 *
deviû
)

4732 
bio
 *biØğ&
deviû
->
æush_bio
;

4734 ià(!
	`‹¡_ªd_ş—r_b™
(
BTRFS_DEV_STATE_FLUSH_SENT
, &
deviû
->
dev_¡©e
))

4735  
çl£
;

4737 
	`wa™_fÜ_com¶‘iÚ_io
(&
deviû
->
æush_wa™
);

4739 ià(
bio
->
bi_¡©us
) {

4740 
deviû
->
Ï¡_æush_”rÜ
 = 
bio
->
bi_¡©us
;

4741 
	`bŒfs_dev_¡©_šc_ªd_´št
(
deviû
, 
BTRFS_DEV_STAT_FLUSH_ERRS
);

4742  
Œue
;

4745  
çl£
;

4746 
	}
}

4752 
	$b¬r›r_®l_deviûs
(
bŒfs_fs_šfo
 *
šfo
)

4754 
li¡_h—d
 *
h—d
;

4755 
bŒfs_deviû
 *
dev
;

4756 
”rÜs_wa™
 = 0;

4758 
	`lockd•_as£¹_h–d
(&
šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4760 
h—d
 = &
šfo
->
fs_deviûs
->
deviûs
;

4761 
	`li¡_fÜ_—ch_’Œy
(
dev
, 
h—d
, 
dev_li¡
) {

4762 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
, &
dev
->
dev_¡©e
))

4764 ià(!
dev
->
bdev
)

4766 ià(!
	`‹¡_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
dev
->
dev_¡©e
) ||

4767 !
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
dev
->
dev_¡©e
))

4770 
	`wr™e_dev_æush
(
dev
);

4774 
	`li¡_fÜ_—ch_’Œy
(
dev
, 
h—d
, 
dev_li¡
) {

4775 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
, &
dev
->
dev_¡©e
))

4777 ià(!
dev
->
bdev
) {

4778 
”rÜs_wa™
++;

4781 ià(!
	`‹¡_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
dev
->
dev_¡©e
) ||

4782 !
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
dev
->
dev_¡©e
))

4785 ià(
	`wa™_dev_æush
(
dev
))

4786 
”rÜs_wa™
++;

4793 ià(
”rÜs_wa™
 && !
	`bŒfs_check_rw_deg¿dabË
(
šfo
, 
NULL
))

4794  -
EIO
;

4797 
	}
}

4799 
	$bŒfs_g‘_num_tŞ”©ed_disk_b¬r›r_çu»s
(
u64
 
æags
)

4801 
¿id_ty³
;

4802 
mš_tŞ”©ed
 = 
INT_MAX
;

4804 ià((
æags
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) == 0 ||

4805 (
æags
 & 
BTRFS_AVAIL_ALLOC_BIT_SINGLE
))

4806 
mš_tŞ”©ed
 = 
	`mš_t
(, min_tolerated,

4807 
bŒfs_¿id_¬¿y
[
BTRFS_RAID_SINGLE
].

4808 
tŞ”©ed_çu»s
);

4810 
¿id_ty³
 = 0;„aid_ty³ < 
BTRFS_NR_RAID_TYPES
;„aid_type++) {

4811 ià(
¿id_ty³
 =ğ
BTRFS_RAID_SINGLE
)

4813 ià(!(
æags
 & 
bŒfs_¿id_¬¿y
[
¿id_ty³
].
bg_æag
))

4815 
mš_tŞ”©ed
 = 
	`mš_t
(, min_tolerated,

4816 
bŒfs_¿id_¬¿y
[
¿id_ty³
].

4817 
tŞ”©ed_çu»s
);

4820 ià(
mš_tŞ”©ed
 =ğ
INT_MAX
) {

4821 
	`´_w¬n
("BTRFS: unknowÀ¿id fÏg: %Îu", 
æags
);

4822 
mš_tŞ”©ed
 = 0;

4825  
mš_tŞ”©ed
;

4826 
	}
}

4828 
	$wr™e_®l_su³rs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
max_mœrÜs
)

4830 
li¡_h—d
 *
h—d
;

4831 
bŒfs_deviû
 *
dev
;

4832 
bŒfs_su³r_block
 *
sb
;

4833 
bŒfs_dev_™em
 *
dev_™em
;

4834 
»t
;

4835 
do_b¬r›rs
;

4836 
max_”rÜs
;

4837 
tÙ®_”rÜs
 = 0;

4838 
u64
 
æags
;

4840 
do_b¬r›rs
 = !
	`bŒfs_‹¡_İt
(
fs_šfo
, 
NOBARRIER
);

4847 ià(
max_mœrÜs
 == 0)

4848 
	`backup_su³r_roÙs
(
fs_šfo
);

4850 
sb
 = 
fs_šfo
->
su³r_fÜ_comm™
;

4851 
dev_™em
 = &
sb
->dev_item;

4853 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4854 
h—d
 = &
fs_šfo
->
fs_deviûs
->
deviûs
;

4855 
max_”rÜs
 = 
	`bŒfs_su³r_num_deviûs
(
fs_šfo
->
su³r_cİy
) - 1;

4857 ià(
do_b¬r›rs
) {

4858 
»t
 = 
	`b¬r›r_®l_deviûs
(
fs_šfo
);

4859 ià(
»t
) {

4860 
	`mu‹x_uÆock
(

4861 &
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4862 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

4864  
»t
;

4868 
	`li¡_fÜ_—ch_’Œy
(
dev
, 
h—d
, 
dev_li¡
) {

4869 ià(!
dev
->
bdev
) {

4870 
tÙ®_”rÜs
++;

4873 ià(!
	`‹¡_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
dev
->
dev_¡©e
) ||

4874 !
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
dev
->
dev_¡©e
))

4877 
	`bŒfs_£t_¡ack_deviû_g’”©iÚ
(
dev_™em
, 0);

4878 
	`bŒfs_£t_¡ack_deviû_ty³
(
dev_™em
, 
dev
->
ty³
);

4879 
	`bŒfs_£t_¡ack_deviû_id
(
dev_™em
, 
dev
->
devid
);

4880 
	`bŒfs_£t_¡ack_deviû_tÙ®_by‹s
(
dev_™em
,

4881 
dev
->
comm™_tÙ®_by‹s
);

4882 
	`bŒfs_£t_¡ack_deviû_by‹s_u£d
(
dev_™em
,

4883 
dev
->
comm™_by‹s_u£d
);

4884 
	`bŒfs_£t_¡ack_deviû_io_®ign
(
dev_™em
, 
dev
->
io_®ign
);

4885 
	`bŒfs_£t_¡ack_deviû_io_width
(
dev_™em
, 
dev
->
io_width
);

4886 
	`bŒfs_£t_¡ack_deviû_£ùÜ_size
(
dev_™em
, 
dev
->
£ùÜ_size
);

4887 
	`memıy
(
dev_™em
->
uuid
, 
dev
->uuid, 
BTRFS_UUID_SIZE
);

4888 
	`memıy
(
dev_™em
->
fsid
, 
dev
->
fs_deviûs
->
m‘ad©a_uuid
,

4889 
BTRFS_FSID_SIZE
);

4891 
æags
 = 
	`bŒfs_su³r_æags
(
sb
);

4892 
	`bŒfs_£t_su³r_æags
(
sb
, 
æags
 | 
BTRFS_HEADER_FLAG_WRITTEN
);

4894 
»t
 = 
	`bŒfs_v®id©e_wr™e_su³r
(
fs_šfo
, 
sb
);

4895 ià(
»t
 < 0) {

4896 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4897 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, -
EUCLEAN
,

4899  -
EUCLEAN
;

4902 
»t
 = 
	`wr™e_dev_su³rs
(
dev
, 
sb
, 
max_mœrÜs
);

4903 ià(
»t
)

4904 
tÙ®_”rÜs
++;

4906 ià(
tÙ®_”rÜs
 > 
max_”rÜs
) {

4907 
	`bŒfs_”r
(
fs_šfo
, "%dƒrrors while writing supers",

4908 
tÙ®_”rÜs
);

4909 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4912 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, -
EIO
,

4914 
tÙ®_”rÜs
);

4915  -
EIO
;

4918 
tÙ®_”rÜs
 = 0;

4919 
	`li¡_fÜ_—ch_’Œy
(
dev
, 
h—d
, 
dev_li¡
) {

4920 ià(!
dev
->
bdev
)

4922 ià(!
	`‹¡_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
dev
->
dev_¡©e
) ||

4923 !
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
dev
->
dev_¡©e
))

4926 
»t
 = 
	`wa™_dev_su³rs
(
dev
, 
max_mœrÜs
);

4927 ià(
»t
)

4928 
tÙ®_”rÜs
++;

4930 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4931 ià(
tÙ®_”rÜs
 > 
max_”rÜs
) {

4932 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, -
EIO
,

4934 
tÙ®_”rÜs
);

4935  -
EIO
;

4938 
	}
}

4941 
	$bŒfs_drİ_ªd_ä“_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

4942 
bŒfs_roÙ
 *
roÙ
)

4944 
boŞ
 
drİ_»f
 = 
çl£
;

4946 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

4947 
	`¿dix_Œ“_d–‘e
(&
fs_šfo
->
fs_roÙs_¿dix
,

4948 ()
roÙ
->
roÙ_key
.
objeùid
);

4949 ià(
	`‹¡_ªd_ş—r_b™
(
BTRFS_ROOT_IN_RADIX
, &
roÙ
->
¡©e
))

4950 
drİ_»f
 = 
Œue
;

4951 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

4953 ià(
	`BTRFS_FS_ERROR
(
fs_šfo
)) {

4954 
	`ASSERT
(
roÙ
->
log_roÙ
 =ğ
NULL
);

4955 ià(
roÙ
->
»loc_roÙ
) {

4956 
	`bŒfs_put_roÙ
(
roÙ
->
»loc_roÙ
);

4957 
roÙ
->
»loc_roÙ
 = 
NULL
;

4961 ià(
drİ_»f
)

4962 
	`bŒfs_put_roÙ
(
roÙ
);

4963 
	}
}

4965 
	$bŒfs_comm™_su³r
(
bŒfs_fs_šfo
 *
fs_šfo
)

4967 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

4968 
bŒfs_Œªs_hªdË
 *
Œªs
;

4970 
	`mu‹x_lock
(&
fs_šfo
->
ş—Ãr_mu‹x
);

4971 
	`bŒfs_run_d–ayed_uts
(
fs_šfo
);

4972 
	`mu‹x_uÆock
(&
fs_šfo
->
ş—Ãr_mu‹x
);

4973 
	`wake_up_´oûss
(
fs_šfo
->
ş—Ãr_kth»ad
);

4976 
	`down_wr™e
(&
fs_šfo
->
ş—nup_wÜk_£m
);

4977 
	`up_wr™e
(&
fs_šfo
->
ş—nup_wÜk_£m
);

4979 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

4980 ià(
	`IS_ERR
(
Œªs
))

4981  
	`PTR_ERR
(
Œªs
);

4982  
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

4983 
	}
}

4985 
	$w¬n_about_uncomm™‹d_Œªs
(
bŒfs_fs_šfo
 *
fs_šfo
)

4987 
bŒfs_Œª§ùiÚ
 *
Œªs
;

4988 
bŒfs_Œª§ùiÚ
 *
tmp
;

4989 
boŞ
 
found
 = 
çl£
;

4991 ià(
	`li¡_em±y
(&
fs_šfo
->
Œªs_li¡
))

4998 
	`ASSERT
(
	`‹¡_b™
(
BTRFS_FS_CLOSING_DONE
, &
fs_šfo
->
æags
));

4999 
	`li¡_fÜ_—ch_’Œy_§ã
(
Œªs
, 
tmp
, &
fs_šfo
->
Œªs_li¡
, 
li¡
) {

5000 
ex‹Á_¡©e
 *
ÿched
 = 
NULL
;

5001 
u64
 
dœty_by‹s
 = 0;

5002 
u64
 
cur
 = 0;

5003 
u64
 
found_¡¬t
;

5004 
u64
 
found_’d
;

5006 
found
 = 
Œue
;

5007 
	`fšd_fœ¡_ex‹Á_b™
(&
Œªs
->
dœty_·ges
, 
cur
,

5008 &
found_¡¬t
, &
found_’d
, 
EXTENT_DIRTY
, &
ÿched
)) {

5009 
dœty_by‹s
 +ğ
found_’d
 + 1 - 
found_¡¬t
;

5010 
cur
 = 
found_’d
 + 1;

5012 
	`bŒfs_w¬n
(
fs_šfo
,

5014 
Œªs
->
Œªsid
, 
dœty_by‹s
);

5015 
	`bŒfs_ş—nup_Úe_Œª§ùiÚ
(
Œªs
, 
fs_šfo
);

5017 ià(
Œªs
 =ğ
fs_šfo
->
ruÂšg_Œª§ùiÚ
)

5018 
fs_šfo
->
ruÂšg_Œª§ùiÚ
 = 
NULL
;

5019 
	`li¡_d–_š™
(&
Œªs
->
li¡
);

5021 
	`bŒfs_put_Œª§ùiÚ
(
Œªs
);

5022 
	`Œaû_bŒfs_Œª§ùiÚ_comm™
(
fs_šfo
);

5024 
	`ASSERT
(!
found
);

5025 
	}
}

5027 
__cŞd
 
	$şo£_ù»e
(
bŒfs_fs_šfo
 *
fs_šfo
)

5029 
»t
;

5031 
	`£t_b™
(
BTRFS_FS_CLOSING_START
, &
fs_šfo
->
æags
);

5042 
	`bŒfs_wake_unfšished_drİ
(
fs_šfo
);

5053 
	`ÿnûl_wÜk_sync
(&
fs_šfo
->
»şaim_bgs_wÜk
);

5060 
	`kth»ad_·rk
(
fs_šfo
->
ş—Ãr_kth»ad
);

5063 
	`bŒfs_qgroup_wa™_fÜ_com¶‘iÚ
(
fs_šfo
, 
çl£
);

5066 
	`down
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

5068 
	`up
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

5071 
	`bŒfs_·u£_b®ªû
(
fs_šfo
);

5073 
	`bŒfs_dev_»¶aû_su¥’d_fÜ_unmouÁ
(
fs_šfo
);

5075 
	`bŒfs_süub_ÿnûl
(
fs_šfo
);

5078 
	`wa™_ev’t
(
fs_šfo
->
Œª§ùiÚ_wa™
,

5079 (
	`©omic_»ad
(&
fs_šfo
->
deäag_ruÂšg
) == 0));

5082 
	`bŒfs_ş—nup_deäag_šodes
(
fs_šfo
);

5104 
	`bŒfs_æush_wÜkqueue
(
fs_šfo
->
’dio_wr™e_wÜk”s
);

5106 
	`bŒfs_æush_wÜkqueue
(
fs_šfo
->
’dio_ä“¥aû_wÜk”
);

5107 
	`bŒfs_run_d–ayed_uts
(
fs_šfo
);

5109 
	`ÿnûl_wÜk_sync
(&
fs_šfo
->
async_»şaim_wÜk
);

5110 
	`ÿnûl_wÜk_sync
(&
fs_šfo
->
async_d©a_»şaim_wÜk
);

5111 
	`ÿnûl_wÜk_sync
(&
fs_šfo
->
´“m±_»şaim_wÜk
);

5114 
	`bŒfs_disÿrd_ş—nup
(
fs_šfo
);

5116 ià(!
	`sb_rdÚly
(
fs_šfo
->
sb
)) {

5121 
	`bŒfs_d–‘e_unu£d_bgs
(
fs_šfo
);

5134 
	`bŒfs_æush_wÜkqueue
(
fs_šfo
->
d–ayed_wÜk”s
);

5136 
»t
 = 
	`bŒfs_comm™_su³r
(
fs_šfo
);

5137 ià(
»t
)

5138 
	`bŒfs_”r
(
fs_šfo
, "comm™ su³¸»ˆ%d", 
»t
);

5141 ià(
	`BTRFS_FS_ERROR
(
fs_šfo
))

5142 
	`bŒfs_”rÜ_comm™_su³r
(
fs_šfo
);

5144 
	`kth»ad_¡İ
(
fs_šfo
->
Œª§ùiÚ_kth»ad
);

5145 
	`kth»ad_¡İ
(
fs_šfo
->
ş—Ãr_kth»ad
);

5147 
	`ASSERT
(
	`li¡_em±y
(&
fs_šfo
->
d–ayed_uts
));

5148 
	`£t_b™
(
BTRFS_FS_CLOSING_DONE
, &
fs_šfo
->
æags
);

5150 ià(
	`bŒfs_check_quÙa_Ëak
(
fs_šfo
)) {

5151 
	`WARN_ON
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
));

5152 
	`bŒfs_”r
(
fs_šfo
, "qgroup„eserved space†eaked");

5155 
	`bŒfs_ä“_qgroup_cÚfig
(
fs_šfo
);

5156 
	`ASSERT
(
	`li¡_em±y
(&
fs_šfo
->
d–®loc_roÙs
));

5158 ià(
	`³rıu_couÁ”_sum
(&
fs_šfo
->
d–®loc_by‹s
)) {

5159 
	`bŒfs_šfo
(
fs_šfo
, "at unmount delalloc count %lld",

5160 
	`³rıu_couÁ”_sum
(&
fs_šfo
->
d–®loc_by‹s
));

5163 ià(
	`³rıu_couÁ”_sum
(&
fs_šfo
->
Üd”ed_by‹s
))

5164 
	`bŒfs_šfo
(
fs_šfo
, "at unmount dio bytes count %lld",

5165 
	`³rıu_couÁ”_sum
(&
fs_šfo
->
Üd”ed_by‹s
));

5167 
	`bŒfs_sysfs_»move_mouÁed
(
fs_šfo
);

5168 
	`bŒfs_sysfs_»move_fsid
(
fs_šfo
->
fs_deviûs
);

5170 
	`bŒfs_put_block_group_ÿche
(
fs_šfo
);

5176 
	`šv®id©e_šode_·ges2
(
fs_šfo
->
bŒ“_šode
->
i_m­pšg
);

5177 
	`bŒfs_¡İ_®l_wÜk”s
(
fs_šfo
);

5180 
	`w¬n_about_uncomm™‹d_Œªs
(
fs_šfo
);

5182 
	`ş—r_b™
(
BTRFS_FS_OPEN
, &
fs_šfo
->
æags
);

5183 
	`ä“_roÙ_poš‹rs
(
fs_šfo
, 
Œue
);

5184 
	`bŒfs_ä“_fs_roÙs
(
fs_šfo
);

5193 
	`bŒfs_ä“_block_groups
(
fs_šfo
);

5195 
	`ut
(
fs_šfo
->
bŒ“_šode
);

5197 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


5198 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
CHECK_INTEGRITY
))

5199 
	`bŒfsic_unmouÁ
(
fs_šfo
->
fs_deviûs
);

5202 
	`bŒfs_m­pšg_Œ“_ä“
(&
fs_šfo
->
m­pšg_Œ“
);

5203 
	`bŒfs_şo£_deviûs
(
fs_šfo
->
fs_deviûs
);

5204 
	}
}

5206 
	$bŒfs_m¬k_bufãr_dœty
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5207 
ex‹Á_bufãr
 *
buf
)

5209 
bŒfs_fs_šfo
 *
fs_šfo
 = 
buf
->fs_info;

5210 
u64
 
Œªsid
 = 
	`bŒfs_h—d”_g’”©iÚ
(
buf
);

5212 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


5218 ià(
	`uÆik–y
(
	`‹¡_b™
(
EXTENT_BUFFER_UNMAPPED
, &
buf
->
bæags
)))

5222 
	`ASSERT
(
Œªs
->
Œªsid
 =ğ
fs_šfo
->
g’”©iÚ
);

5223 
	`bŒfs_as£¹_Œ“_wr™e_locked
(
buf
);

5224 ià(
Œªsid
 !ğ
fs_šfo
->
g’”©iÚ
) {

5225 
	`WARN
(1, 
KERN_CRIT
 "btrfsransid mismatch buffer %llu, found %llu„unning %llu\n",

5226 
buf
->
¡¬t
, 
Œªsid
, 
fs_šfo
->
g’”©iÚ
);

5227 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, -
EUCLEAN
);

5229 
	`£t_ex‹Á_bufãr_dœty
(
buf
);

5230 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


5235 ià(
	`bŒfs_h—d”_Ëv–
(
buf
è=ğ0 && 
	`bŒfs_check_Ëaf
(buf)) {

5236 
	`bŒfs_´št_Ëaf
(
buf
);

5237 
	`ASSERT
(0);

5240 
	}
}

5242 
	$__bŒfs_bŒ“_b®ªû_dœty
(
bŒfs_fs_šfo
 *
fs_šfo
,

5243 
æush_d–ayed
)

5249 
»t
;

5251 ià(
cu¼’t
->
æags
 & 
PF_MEMALLOC
)

5254 ià(
æush_d–ayed
)

5255 
	`bŒfs_b®ªû_d–ayed_™ems
(
fs_šfo
);

5257 
»t
 = 
	`__³rıu_couÁ”_com·»
(&
fs_šfo
->
dœty_m‘ad©a_by‹s
,

5258 
BTRFS_DIRTY_METADATA_THRESH
,

5259 
fs_šfo
->
dœty_m‘ad©a_b©ch
);

5260 ià(
»t
 > 0) {

5261 
	`b®ªû_dœty_·ges_¿‹lim™ed
(
fs_šfo
->
bŒ“_šode
->
i_m­pšg
);

5263 
	}
}

5265 
	$bŒfs_bŒ“_b®ªû_dœty
(
bŒfs_fs_šfo
 *
fs_šfo
)

5267 
	`__bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
, 1);

5268 
	}
}

5270 
	$bŒfs_bŒ“_b®ªû_dœty_nod–ay
(
bŒfs_fs_šfo
 *
fs_šfo
)

5272 
	`__bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
, 0);

5273 
	}
}

5275 
	$bŒfs_”rÜ_comm™_su³r
(
bŒfs_fs_šfo
 *
fs_šfo
)

5278 
	`bŒfs_ş—nup_Œª§ùiÚ
(
fs_šfo
);

5280 
	`mu‹x_lock
(&
fs_šfo
->
ş—Ãr_mu‹x
);

5281 
	`bŒfs_run_d–ayed_uts
(
fs_šfo
);

5282 
	`mu‹x_uÆock
(&
fs_šfo
->
ş—Ãr_mu‹x
);

5284 
	`down_wr™e
(&
fs_šfo
->
ş—nup_wÜk_£m
);

5285 
	`up_wr™e
(&
fs_šfo
->
ş—nup_wÜk_£m
);

5286 
	}
}

5288 
	$bŒfs_drİ_®l_logs
(
bŒfs_fs_šfo
 *
fs_šfo
)

5290 
bŒfs_roÙ
 *
gªg
[8];

5291 
u64
 
roÙ_objeùid
 = 0;

5292 
»t
;

5294 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

5295 (
»t
 = 
	`¿dix_Œ“_gªg_lookup
(&
fs_šfo
->
fs_roÙs_¿dix
,

5296 (**)
gªg
, 
roÙ_objeùid
,

5297 
	`ARRAY_SIZE
(
gªg
))) != 0) {

5298 
i
;

5300 
i
 = 0; i < 
»t
; i++)

5301 
gªg
[
i
] = 
	`bŒfs_g¿b_roÙ
(gang[i]);

5302 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

5304 
i
 = 0; i < 
»t
; i++) {

5305 ià(!
gªg
[
i
])

5307 
roÙ_objeùid
 = 
gªg
[
i
]->
roÙ_key
.
objeùid
;

5308 
	`bŒfs_ä“_log
(
NULL
, 
gªg
[
i
]);

5309 
	`bŒfs_put_roÙ
(
gªg
[
i
]);

5311 
roÙ_objeùid
++;

5312 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

5314 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

5315 
	`bŒfs_ä“_log_roÙ_Œ“
(
NULL
, 
fs_šfo
);

5316 
	}
}

5318 
	$bŒfs_de¡roy_Üd”ed_ex‹Ás
(
bŒfs_roÙ
 *
roÙ
)

5320 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

5322 
	`¥š_lock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

5327 
	`li¡_fÜ_—ch_’Œy
(
Üd”ed
, &
roÙ
->
Üd”ed_ex‹Ás
,

5328 
roÙ_ex‹Á_li¡
)

5329 
	`£t_b™
(
BTRFS_ORDERED_IOERR
, &
Üd”ed
->
æags
);

5330 
	`¥š_uÆock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

5331 
	}
}

5333 
	$bŒfs_de¡roy_®l_Üd”ed_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
)

5335 
bŒfs_roÙ
 *
roÙ
;

5336 
	`LIST_HEAD
(
¥liû
);

5338 
	`¥š_lock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

5339 
	`li¡_¥liû_š™
(&
fs_šfo
->
Üd”ed_roÙs
, &
¥liû
);

5340 !
	`li¡_em±y
(&
¥liû
)) {

5341 
roÙ
 = 
	`li¡_fœ¡_’Œy
(&
¥liû
, 
bŒfs_roÙ
,

5342 
Üd”ed_roÙ
);

5343 
	`li¡_move_
(&
roÙ
->
Üd”ed_roÙ
,

5344 &
fs_šfo
->
Üd”ed_roÙs
);

5346 
	`¥š_uÆock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

5347 
	`bŒfs_de¡roy_Üd”ed_ex‹Ás
(
roÙ
);

5349 
	`cÚd_»sched
();

5350 
	`¥š_lock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

5352 
	`¥š_uÆock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

5360 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
U64_MAX
, 0, (
u64
)-1);

5361 
	}
}

5363 
	$bŒfs_de¡roy_d–ayed_»fs
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

5364 
bŒfs_fs_šfo
 *
fs_šfo
)

5366 
rb_node
 *
node
;

5367 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

5368 
bŒfs_d–ayed_»f_node
 *
»f
;

5370 
d–ayed_»fs
 = &
Œªs
->delayed_refs;

5372 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

5373 ià(
	`©omic_»ad
(&
d–ayed_»fs
->
num_’Œ›s
) == 0) {

5374 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

5375 
	`bŒfs_debug
(
fs_šfo
, "delayed_refs has NOƒntry");

5379 (
node
 = 
	`rb_fœ¡_ÿched
(&
d–ayed_»fs
->
h»f_roÙ
)è!ğ
NULL
) {

5380 
bŒfs_d–ayed_»f_h—d
 *
h—d
;

5381 
rb_node
 *
n
;

5382 
boŞ
 
pš_by‹s
 = 
çl£
;

5384 
h—d
 = 
	`rb_’Œy
(
node
, 
bŒfs_d–ayed_»f_h—d
,

5385 
h»f_node
);

5386 ià(
	`bŒfs_d–ayed_»f_lock
(
d–ayed_»fs
, 
h—d
))

5389 
	`¥š_lock
(&
h—d
->
lock
);

5390 (
n
 = 
	`rb_fœ¡_ÿched
(&
h—d
->
»f_Œ“
)è!ğ
NULL
) {

5391 
»f
 = 
	`rb_’Œy
(
n
, 
bŒfs_d–ayed_»f_node
,

5392 
»f_node
);

5393 
	`rb_”a£_ÿched
(&
»f
->
»f_node
, &
h—d
->
»f_Œ“
);

5394 
	`RB_CLEAR_NODE
(&
»f
->
»f_node
);

5395 ià(!
	`li¡_em±y
(&
»f
->
add_li¡
))

5396 
	`li¡_d–
(&
»f
->
add_li¡
);

5397 
	`©omic_dec
(&
d–ayed_»fs
->
num_’Œ›s
);

5398 
	`bŒfs_put_d–ayed_»f
(
»f
);

5400 ià(
h—d
->
mu¡_š£¹_»£rved
)

5401 
pš_by‹s
 = 
Œue
;

5402 
	`bŒfs_ä“_d–ayed_ex‹Á_İ
(
h—d
->
ex‹Á_İ
);

5403 
	`bŒfs_d–‘e_»f_h—d
(
d–ayed_»fs
, 
h—d
);

5404 
	`¥š_uÆock
(&
h—d
->
lock
);

5405 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

5406 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

5408 ià(
pš_by‹s
) {

5409 
bŒfs_block_group
 *
ÿche
;

5411 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
h—d
->
by‹Ä
);

5412 
	`BUG_ON
(!
ÿche
);

5414 
	`¥š_lock
(&
ÿche
->
¥aû_šfo
->
lock
);

5415 
	`¥š_lock
(&
ÿche
->
lock
);

5416 
ÿche
->
pšÃd
 +ğ
h—d
->
num_by‹s
;

5417 
	`bŒfs_¥aû_šfo_upd©e_by‹s_pšÃd
(
fs_šfo
,

5418 
ÿche
->
¥aû_šfo
, 
h—d
->
num_by‹s
);

5419 
ÿche
->
»£rved
 -ğ
h—d
->
num_by‹s
;

5420 
ÿche
->
¥aû_šfo
->
by‹s_»£rved
 -ğ
h—d
->
num_by‹s
;

5421 
	`¥š_uÆock
(&
ÿche
->
lock
);

5422 
	`¥š_uÆock
(&
ÿche
->
¥aû_šfo
->
lock
);

5424 
	`bŒfs_put_block_group
(
ÿche
);

5426 
	`bŒfs_”rÜ_uÅš_ex‹Á_¿nge
(
fs_šfo
, 
h—d
->
by‹Ä
,

5427 
h—d
->
by‹Ä
 + h—d->
num_by‹s
 - 1);

5429 
	`bŒfs_ş—nup_»f_h—d_accouÁšg
(
fs_šfo
, 
d–ayed_»fs
, 
h—d
);

5430 
	`bŒfs_put_d–ayed_»f_h—d
(
h—d
);

5431 
	`cÚd_»sched
();

5432 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

5434 
	`bŒfs_qgroup_de¡roy_ex‹Á_»cÜds
(
Œªs
);

5436 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

5437 
	}
}

5439 
	$bŒfs_de¡roy_d–®loc_šodes
(
bŒfs_roÙ
 *
roÙ
)

5441 
bŒfs_šode
 *btrfs_inode;

5442 
	`LIST_HEAD
(
¥liû
);

5444 
	`¥š_lock
(&
roÙ
->
d–®loc_lock
);

5445 
	`li¡_¥liû_š™
(&
roÙ
->
d–®loc_šodes
, &
¥liû
);

5447 !
	`li¡_em±y
(&
¥liû
)) {

5448 
šode
 *šodğ
NULL
;

5449 
bŒfs_šode
 = 
	`li¡_fœ¡_’Œy
(&
¥liû
, btrfs_inode,

5450 
d–®loc_šodes
);

5451 
	`__bŒfs_d–_d–®loc_šode
(
roÙ
, 
bŒfs_šode
);

5452 
	`¥š_uÆock
(&
roÙ
->
d–®loc_lock
);

5458 
šode
 = 
	`ig¿b
(&
bŒfs_šode
->
vfs_šode
);

5459 ià(
šode
) {

5460 
nofs_æag
;

5462 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

5463 
	`šv®id©e_šode_·ges2
(
šode
->
i_m­pšg
);

5464 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

5465 
	`ut
(
šode
);

5467 
	`¥š_lock
(&
roÙ
->
d–®loc_lock
);

5469 
	`¥š_uÆock
(&
roÙ
->
d–®loc_lock
);

5470 
	}
}

5472 
	$bŒfs_de¡roy_®l_d–®loc_šodes
(
bŒfs_fs_šfo
 *
fs_šfo
)

5474 
bŒfs_roÙ
 *
roÙ
;

5475 
	`LIST_HEAD
(
¥liû
);

5477 
	`¥š_lock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

5478 
	`li¡_¥liû_š™
(&
fs_šfo
->
d–®loc_roÙs
, &
¥liû
);

5479 !
	`li¡_em±y
(&
¥liû
)) {

5480 
roÙ
 = 
	`li¡_fœ¡_’Œy
(&
¥liû
, 
bŒfs_roÙ
,

5481 
d–®loc_roÙ
);

5482 
roÙ
 = 
	`bŒfs_g¿b_roÙ
(root);

5483 
	`BUG_ON
(!
roÙ
);

5484 
	`¥š_uÆock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

5486 
	`bŒfs_de¡roy_d–®loc_šodes
(
roÙ
);

5487 
	`bŒfs_put_roÙ
(
roÙ
);

5489 
	`¥š_lock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

5491 
	`¥š_uÆock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

5492 
	}
}

5494 
	$bŒfs_de¡roy_m¬ked_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
,

5495 
ex‹Á_io_Œ“
 *
dœty_·ges
,

5496 
m¬k
)

5498 
ex‹Á_bufãr
 *
eb
;

5499 
u64
 
¡¬t
 = 0;

5500 
u64
 
’d
;

5502 
	`fšd_fœ¡_ex‹Á_b™
(
dœty_·ges
, 
¡¬t
, &¡¬t, &
’d
,

5503 
m¬k
, 
NULL
)) {

5504 
	`ş—r_ex‹Á_b™s
(
dœty_·ges
, 
¡¬t
, 
’d
, 
m¬k
);

5505 
¡¬t
 <ğ
’d
) {

5506 
eb
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
);

5507 
¡¬t
 +ğ
fs_šfo
->
nodesize
;

5508 ià(!
eb
)

5511 
	`bŒfs_Œ“_lock
(
eb
);

5512 
	`wa™_Ú_ex‹Á_bufãr_wr™eback
(
eb
);

5513 
	`bŒfs_ş—r_bufãr_dœty
(
NULL
, 
eb
);

5514 
	`bŒfs_Œ“_uÆock
(
eb
);

5516 
	`ä“_ex‹Á_bufãr_¡®e
(
eb
);

5519 
	}
}

5521 
	$bŒfs_de¡roy_pšÃd_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

5522 
ex‹Á_io_Œ“
 *
uÅš
)

5524 
u64
 
¡¬t
;

5525 
u64
 
’d
;

5528 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

5536 
	`mu‹x_lock
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

5537 ià(!
	`fšd_fœ¡_ex‹Á_b™
(
uÅš
, 0, &
¡¬t
, &
’d
,

5538 
EXTENT_DIRTY
, &
ÿched_¡©e
)) {

5539 
	`mu‹x_uÆock
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

5543 
	`ş—r_ex‹Á_dœty
(
uÅš
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

5544 
	`ä“_ex‹Á_¡©e
(
ÿched_¡©e
);

5545 
	`bŒfs_”rÜ_uÅš_ex‹Á_¿nge
(
fs_šfo
, 
¡¬t
, 
’d
);

5546 
	`mu‹x_uÆock
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

5547 
	`cÚd_»sched
();

5549 
	}
}

5551 
	$bŒfs_ş—nup_bg_io
(
bŒfs_block_group
 *
ÿche
)

5553 
šode
 *inode;

5555 
šode
 = 
ÿche
->
io_ùl
.inode;

5556 ià(
šode
) {

5557 
nofs_æag
;

5559 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

5560 
	`šv®id©e_šode_·ges2
(
šode
->
i_m­pšg
);

5561 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

5563 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 0;

5564 
ÿche
->
io_ùl
.
šode
 = 
NULL
;

5565 
	`ut
(
šode
);

5567 
	`ASSERT
(
ÿche
->
io_ùl
.
·ges
 =ğ
NULL
);

5568 
	`bŒfs_put_block_group
(
ÿche
);

5569 
	}
}

5571 
	$bŒfs_ş—nup_dœty_bgs
(
bŒfs_Œª§ùiÚ
 *
cur_Œªs
,

5572 
bŒfs_fs_šfo
 *
fs_šfo
)

5574 
bŒfs_block_group
 *
ÿche
;

5576 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

5577 !
	`li¡_em±y
(&
cur_Œªs
->
dœty_bgs
)) {

5578 
ÿche
 = 
	`li¡_fœ¡_’Œy
(&
cur_Œªs
->
dœty_bgs
,

5579 
bŒfs_block_group
,

5580 
dœty_li¡
);

5582 ià(!
	`li¡_em±y
(&
ÿche
->
io_li¡
)) {

5583 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

5584 
	`li¡_d–_š™
(&
ÿche
->
io_li¡
);

5585 
	`bŒfs_ş—nup_bg_io
(
ÿche
);

5586 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

5589 
	`li¡_d–_š™
(&
ÿche
->
dœty_li¡
);

5590 
	`¥š_lock
(&
ÿche
->
lock
);

5591 
ÿche
->
disk_ÿche_¡©e
 = 
BTRFS_DC_ERROR
;

5592 
	`¥š_uÆock
(&
ÿche
->
lock
);

5594 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

5595 
	`bŒfs_put_block_group
(
ÿche
);

5596 
	`bŒfs_d–ayed_»fs_rsv_»Ëa£
(
fs_šfo
, 1);

5597 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

5599 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

5605 !
	`li¡_em±y
(&
cur_Œªs
->
io_bgs
)) {

5606 
ÿche
 = 
	`li¡_fœ¡_’Œy
(&
cur_Œªs
->
io_bgs
,

5607 
bŒfs_block_group
,

5608 
io_li¡
);

5610 
	`li¡_d–_š™
(&
ÿche
->
io_li¡
);

5611 
	`¥š_lock
(&
ÿche
->
lock
);

5612 
ÿche
->
disk_ÿche_¡©e
 = 
BTRFS_DC_ERROR
;

5613 
	`¥š_uÆock
(&
ÿche
->
lock
);

5614 
	`bŒfs_ş—nup_bg_io
(
ÿche
);

5616 
	}
}

5618 
	$bŒfs_ş—nup_Úe_Œª§ùiÚ
(
bŒfs_Œª§ùiÚ
 *
cur_Œªs
,

5619 
bŒfs_fs_šfo
 *
fs_šfo
)

5621 
bŒfs_deviû
 *
dev
, *
tmp
;

5623 
	`bŒfs_ş—nup_dœty_bgs
(
cur_Œªs
, 
fs_šfo
);

5624 
	`ASSERT
(
	`li¡_em±y
(&
cur_Œªs
->
dœty_bgs
));

5625 
	`ASSERT
(
	`li¡_em±y
(&
cur_Œªs
->
io_bgs
));

5627 
	`li¡_fÜ_—ch_’Œy_§ã
(
dev
, 
tmp
, &
cur_Œªs
->
dev_upd©e_li¡
,

5628 
po¡_comm™_li¡
) {

5629 
	`li¡_d–_š™
(&
dev
->
po¡_comm™_li¡
);

5632 
	`bŒfs_de¡roy_d–ayed_»fs
(
cur_Œªs
, 
fs_šfo
);

5634 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_COMMIT_START
;

5635 
	`wake_up
(&
fs_šfo
->
Œª§ùiÚ_blocked_wa™
);

5637 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_UNBLOCKED
;

5638 
	`wake_up
(&
fs_šfo
->
Œª§ùiÚ_wa™
);

5640 
	`bŒfs_de¡roy_d–ayed_šodes
(
fs_šfo
);

5642 
	`bŒfs_de¡roy_m¬ked_ex‹Ás
(
fs_šfo
, &
cur_Œªs
->
dœty_·ges
,

5643 
EXTENT_DIRTY
);

5644 
	`bŒfs_de¡roy_pšÃd_ex‹Á
(
fs_šfo
, &
cur_Œªs
->
pšÃd_ex‹Ás
);

5646 
cur_Œªs
->
¡©e
 =
TRANS_STATE_COMPLETED
;

5647 
	`wake_up
(&
cur_Œªs
->
comm™_wa™
);

5648 
	}
}

5650 
	$bŒfs_ş—nup_Œª§ùiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
)

5652 
bŒfs_Œª§ùiÚ
 *
t
;

5654 
	`mu‹x_lock
(&
fs_šfo
->
Œª§ùiÚ_kth»ad_mu‹x
);

5656 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

5657 !
	`li¡_em±y
(&
fs_šfo
->
Œªs_li¡
)) {

5658 
t
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
Œªs_li¡
,

5659 
bŒfs_Œª§ùiÚ
, 
li¡
);

5660 ià(
t
->
¡©e
 >ğ
TRANS_STATE_COMMIT_PREP
) {

5661 
	`»fcouÁ_šc
(&
t
->
u£_couÁ
);

5662 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

5663 
	`bŒfs_wa™_fÜ_comm™
(
fs_šfo
, 
t
->
Œªsid
);

5664 
	`bŒfs_put_Œª§ùiÚ
(
t
);

5665 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

5668 ià(
t
 =ğ
fs_šfo
->
ruÂšg_Œª§ùiÚ
) {

5669 
t
->
¡©e
 = 
TRANS_STATE_COMMIT_DOING
;

5670 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

5675 
	`wa™_ev’t
(
t
->
wr™”_wa™
,

5676 
	`©omic_»ad
(&
t
->
num_wr™”s
) == 0);

5678 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

5680 
	`bŒfs_ş—nup_Úe_Œª§ùiÚ
(
t
, 
fs_šfo
);

5682 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

5683 ià(
t
 =ğ
fs_šfo
->
ruÂšg_Œª§ùiÚ
)

5684 
fs_šfo
->
ruÂšg_Œª§ùiÚ
 = 
NULL
;

5685 
	`li¡_d–_š™
(&
t
->
li¡
);

5686 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

5688 
	`bŒfs_put_Œª§ùiÚ
(
t
);

5689 
	`Œaû_bŒfs_Œª§ùiÚ_comm™
(
fs_šfo
);

5690 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

5692 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

5693 
	`bŒfs_de¡roy_®l_Üd”ed_ex‹Ás
(
fs_šfo
);

5694 
	`bŒfs_de¡roy_d–ayed_šodes
(
fs_šfo
);

5695 
	`bŒfs_as£¹_d–ayed_roÙ_em±y
(
fs_šfo
);

5696 
	`bŒfs_de¡roy_®l_d–®loc_šodes
(
fs_šfo
);

5697 
	`bŒfs_drİ_®l_logs
(
fs_šfo
);

5698 
	`mu‹x_uÆock
(&
fs_šfo
->
Œª§ùiÚ_kth»ad_mu‹x
);

5701 
	}
}

5703 
	$bŒfs_š™_roÙ_ä“_objeùid
(
bŒfs_roÙ
 *
roÙ
)

5705 
bŒfs_·th
 *
·th
;

5706 
»t
;

5707 
ex‹Á_bufãr
 *
l
;

5708 
bŒfs_key
 
£¬ch_key
;

5709 
bŒfs_key
 
found_key
;

5710 
¦Ù
;

5712 
·th
 = 
	`bŒfs_®loc_·th
();

5713 ià(!
·th
)

5714  -
ENOMEM
;

5716 
£¬ch_key
.
objeùid
 = 
BTRFS_LAST_FREE_OBJECTID
;

5717 
£¬ch_key
.
ty³
 = -1;

5718 
£¬ch_key
.
off£t
 = (
u64
)-1;

5719 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
£¬ch_key
, 
·th
, 0, 0);

5720 ià(
»t
 < 0)

5721 
”rÜ
;

5722 
	`BUG_ON
(
»t
 == 0);

5723 ià(
·th
->
¦Ùs
[0] > 0) {

5724 
¦Ù
 = 
·th
->
¦Ùs
[0] - 1;

5725 
l
 = 
·th
->
nodes
[0];

5726 
	`bŒfs_™em_key_to_ıu
(
l
, &
found_key
, 
¦Ù
);

5727 
roÙ
->
ä“_objeùid
 = 
	`max_t
(
u64
, 
found_key
.
objeùid
 + 1,

5728 
BTRFS_FIRST_FREE_OBJECTID
);

5730 
roÙ
->
ä“_objeùid
 = 
BTRFS_FIRST_FREE_OBJECTID
;

5732 
»t
 = 0;

5733 
”rÜ
:

5734 
	`bŒfs_ä“_·th
(
·th
);

5735  
»t
;

5736 
	}
}

5738 
	$bŒfs_g‘_ä“_objeùid
(
bŒfs_roÙ
 *
roÙ
, 
u64
 *
objeùid
)

5740 
»t
;

5741 
	`mu‹x_lock
(&
roÙ
->
objeùid_mu‹x
);

5743 ià(
	`uÆik–y
(
roÙ
->
ä“_objeùid
 >ğ
BTRFS_LAST_FREE_OBJECTID
)) {

5744 
	`bŒfs_w¬n
(
roÙ
->
fs_šfo
,

5746 
roÙ
->
roÙ_key
.
objeùid
);

5747 
»t
 = -
ENOSPC
;

5748 
out
;

5751 *
objeùid
 = 
roÙ
->
ä“_objeùid
++;

5752 
»t
 = 0;

5753 
out
:

5754 
	`mu‹x_uÆock
(&
roÙ
->
objeùid_mu‹x
);

5755  
»t
;

5756 
	}
}

	@disk-io.h

6 #iâdeà
BTRFS_DISK_IO_H


7 
	#BTRFS_DISK_IO_H


	)

9 
	#BTRFS_SUPER_MIRROR_MAX
 3

	)

10 
	#BTRFS_SUPER_MIRROR_SHIFT
 12

	)

18 
	#BTRFS_BDEV_BLOCKSIZE
 (4096)

	)

20 
šlše
 
u64
 
	$bŒfs_sb_off£t
(
mœrÜ
)

22 
u64
 
¡¬t
 = 
SZ_16K
;

23 ià(
mœrÜ
)

24  
¡¬t
 << (
BTRFS_SUPER_MIRROR_SHIFT
 * 
mœrÜ
);

25  
BTRFS_SUPER_INFO_OFFSET
;

26 
	}
}

29 
šlše
 
u64
 
	$bŒfs_sb_off£t_·¹™iÚ
(
mœrÜ
, 
u64
 
sb_off£t
)

31 iàĞ
mœrÜ
 == 1 )

32  
BTRFS_SUPER_INFO_OFFSET_1
 + 
sb_off£t
;

33 iàĞ
mœrÜ
 == 2 )

34  
BTRFS_SUPER_INFO_OFFSET_2
 + 
sb_off£t
;

35  
BTRFS_SUPER_INFO_OFFSET
 + 
sb_off£t
;

36 
	}
}

38 
	gbŒfs_deviû
;

39 
	gbŒfs_fs_deviûs
;

40 
	gbŒfs_Œ“_·»Á_check
;

42 
bŒfs_check_Ëaked_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
);

43 
bŒfs_š™_fs_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
);

44 
ex‹Á_bufãr
 *
»ad_Œ“_block
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

45 
bŒfs_Œ“_·»Á_check
 *
check
);

46 
ex‹Á_bufãr
 *
bŒfs_fšd_ü—‹_Œ“_block
(

47 
bŒfs_fs_šfo
 *
fs_šfo
,

48 
u64
 
by‹Ä
, u64 
owÃr_roÙ
,

49 
Ëv–
);

50 
bŒfs_ş—r_bufãr_dœty
(
bŒfs_Œªs_hªdË
 *
Œªs
,

51 
ex‹Á_bufãr
 *
buf
);

52 
bŒfs_ş—r_ÚeshÙ_İtiÚs
(
bŒfs_fs_šfo
 *
fs_šfo
);

53 
bŒfs_¡¬t_´e_rw_mouÁ
(
bŒfs_fs_šfo
 *
fs_šfo
);

54 
bŒfs_check_su³r_csum
(
bŒfs_fs_šfo
 *
fs_šfo
,

55 cÚ¡ 
bŒfs_su³r_block
 *
disk_sb
);

56 
__cŞd
 
İ’_ù»e
(
su³r_block
 *
sb
,

57 
bŒfs_fs_deviûs
 *
fs_deviûs
,

58 *
İtiÚs
);

59 
__cŞd
 
İ’_ù»e_·¹™iÚ
(
su³r_block
 *
sb
, 
bŒfs_fs_deviûs
 *
fs_deviûs
,

60 *
İtiÚs
, 
·¹™iÚ_Üd”
);

61 
__cŞd
 
şo£_ù»e
(
bŒfs_fs_šfo
 *
fs_šfo
);

62 
bŒfs_v®id©e_su³r
(
bŒfs_fs_šfo
 *
fs_šfo
,

63 
bŒfs_su³r_block
 *
sb
, 
mœrÜ_num
);

64 
bŒfs_check_ã©u»s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
boŞ
 
is_rw_mouÁ
);

65 
wr™e_®l_su³rs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
max_mœrÜs
);

66 
bŒfs_su³r_block
 *
bŒfs_»ad_dev_su³r
(
block_deviû
 *
bdev
);

67 
bŒfs_su³r_block
 *
bŒfs_»ad_dev_su³r_·¹™iÚ
(
block_deviû
 *
bdev
, 
·¹™iÚ_Üd”
);

68 
bŒfs_su³r_block
 *
bŒfs_»ad_dev_Úe_su³r
(
block_deviû
 *
bdev
,

69 
cİy_num
, 
boŞ
 
drİ_ÿche
);

70 
bŒfs_su³r_block
 *
bŒfs_»ad_dev_Úe_su³r_·¹™iÚ
(
block_deviû
 *
bdev
,

71 
cİy_num
, 
boŞ
 
drİ_ÿche
, 
·¹™iÚ_Üd”
);

72 
bŒfs_comm™_su³r
(
bŒfs_fs_šfo
 *
fs_šfo
);

73 
bŒfs_roÙ
 *
bŒfs_»ad_Œ“_roÙ
(bŒfs_roÙ *
Œ“_roÙ
,

74 
bŒfs_key
 *
key
);

75 
bŒfs_š£¹_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

76 
bŒfs_roÙ
 *
roÙ
);

77 
bŒfs_ä“_fs_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
);

79 
bŒfs_roÙ
 *
bŒfs_g‘_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

80 
u64
 
objeùid
, 
boŞ
 
check_»f
);

81 
bŒfs_roÙ
 *
bŒfs_g‘_Ãw_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

82 
u64
 
objeùid
, 
dev_t
 
ªÚ_dev
);

83 
bŒfs_roÙ
 *
bŒfs_g‘_fs_roÙ_comm™_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

84 
bŒfs_·th
 *
·th
,

85 
u64
 
objeùid
);

86 
bŒfs_glob®_roÙ_š£¹
(
bŒfs_roÙ
 *
roÙ
);

87 
bŒfs_glob®_roÙ_d–‘e
(
bŒfs_roÙ
 *
roÙ
);

88 
bŒfs_roÙ
 *
bŒfs_glob®_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

89 
bŒfs_key
 *
key
);

90 
bŒfs_roÙ
 *
bŒfs_csum_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
);

91 
bŒfs_roÙ
 *
bŒfs_ex‹Á_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
);

92 
bŒfs_roÙ
 *
bŒfs_block_group_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
);

94 
bŒfs_ä“_fs_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
);

95 
bŒfs_bŒ“_b®ªû_dœty
(
bŒfs_fs_šfo
 *
fs_šfo
);

96 
bŒfs_bŒ“_b®ªû_dœty_nod–ay
(
bŒfs_fs_šfo
 *
fs_šfo
);

97 
bŒfs_drİ_ªd_ä“_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

98 
bŒfs_roÙ
 *
roÙ
);

99 
bŒfs_v®id©e_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
,

100 
bŒfs_Œ“_·»Á_check
 *
check
);

101 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


102 
bŒfs_roÙ
 *
bŒfs_®loc_dummy_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
);

112 
šlše
 
bŒfs_roÙ
 *
	$bŒfs_g¿b_roÙ
(
bŒfs_roÙ
 *
roÙ
)

114 ià(!
roÙ
)

115  
NULL
;

116 ià(
	`»fcouÁ_šc_nÙ_z”o
(&
roÙ
->
»fs
))

117  
roÙ
;

118  
NULL
;

119 
	}
}

121 
bŒfs_put_roÙ
(
bŒfs_roÙ
 *
roÙ
);

122 
bŒfs_m¬k_bufãr_dœty
(
bŒfs_Œªs_hªdË
 *
Œªs
,

123 
ex‹Á_bufãr
 *
buf
);

124 
bŒfs_bufãr_u±od©e
(
ex‹Á_bufãr
 *
buf
, 
u64
 
·»Á_Œªsid
,

125 
©omic
);

126 
bŒfs_»ad_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
buf
,

127 
bŒfs_Œ“_·»Á_check
 *
check
);

129 
blk_¡©us_t
 
bŒ“_csum_Úe_bio
(
bŒfs_bio
 *
bbio
);

130 
bŒfs_®loc_log_Œ“_node
(
bŒfs_Œªs_hªdË
 *
Œªs
,

131 
bŒfs_roÙ
 *
roÙ
);

132 
bŒfs_š™_log_roÙ_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

133 
bŒfs_fs_šfo
 *
fs_šfo
);

134 
bŒfs_add_log_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

135 
bŒfs_roÙ
 *
roÙ
);

136 
bŒfs_ş—nup_dœty_bgs
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

137 
bŒfs_fs_šfo
 *
fs_šfo
);

138 
bŒfs_ş—nup_Úe_Œª§ùiÚ
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

139 
bŒfs_fs_šfo
 *
fs_šfo
);

140 
bŒfs_roÙ
 *
bŒfs_ü—‹_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

141 
u64
 
objeùid
);

142 
bŒfs_g‘_num_tŞ”©ed_disk_b¬r›r_çu»s
(
u64
 
æags
);

143 
bŒfs_g‘_ä“_objeùid
(
bŒfs_roÙ
 *
roÙ
, 
u64
 *
objeùid
);

144 
bŒfs_š™_roÙ_ä“_objeùid
(
bŒfs_roÙ
 *
roÙ
);

	@export.c

3 
	~<lšux/fs.h
>

4 
	~<lšux/ty³s.h
>

5 
	~"ù»e.h
"

6 
	~"disk-io.h
"

7 
	~"bŒfs_šode.h
"

8 
	~"´št-Œ“.h
"

9 
	~"expÜt.h
"

10 
	~"acûssÜs.h
"

11 
	~"su³r.h
"

13 
	#BTRFS_FID_SIZE_NON_CONNECTABLE
 (
	`off£tof
(
bŒfs_fid
, \

14 
·»Á_objeùid
è/ 4)

	)

15 
	#BTRFS_FID_SIZE_CONNECTABLE
 (
	`off£tof
(
bŒfs_fid
, \

16 
·»Á_roÙ_objeùid
è/ 4)

	)

17 
	#BTRFS_FID_SIZE_CONNECTABLE_ROOT
 ((
bŒfs_fid
è/ 4)

	)

19 
	$bŒfs_’code_fh
(
šode
 *šode, 
u32
 *
fh
, *
max_Ën
,

20 
šode
 *
·»Á
)

22 
bŒfs_fid
 *
fid
 = (bŒfs_fid *)
fh
;

23 
Ën
 = *
max_Ën
;

24 
ty³
;

26 ià(
·»Á
 && (
Ën
 < 
BTRFS_FID_SIZE_CONNECTABLE
)) {

27 *
max_Ën
 = 
BTRFS_FID_SIZE_CONNECTABLE
;

28  
FILEID_INVALID
;

29 } ià(
Ën
 < 
BTRFS_FID_SIZE_NON_CONNECTABLE
) {

30 *
max_Ën
 = 
BTRFS_FID_SIZE_NON_CONNECTABLE
;

31  
FILEID_INVALID
;

34 
Ën
 = 
BTRFS_FID_SIZE_NON_CONNECTABLE
;

35 
ty³
 = 
FILEID_BTRFS_WITHOUT_PARENT
;

37 
fid
->
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

38 
fid
->
roÙ_objeùid
 = 
	`BTRFS_I
(
šode
)->
roÙ
->
roÙ_key
.
objeùid
;

39 
fid
->
g’
 = 
šode
->
i_g’”©iÚ
;

41 ià(
·»Á
) {

42 
u64
 
·»Á_roÙ_id
;

44 
fid
->
·»Á_objeùid
 = 
	`BTRFS_I
(
·»Á
)->
loÿtiÚ
.
objeùid
;

45 
fid
->
·»Á_g’
 = 
·»Á
->
i_g’”©iÚ
;

46 
·»Á_roÙ_id
 = 
	`BTRFS_I
(
·»Á
)->
roÙ
->
roÙ_key
.
objeùid
;

48 ià(
·»Á_roÙ_id
 !ğ
fid
->
roÙ_objeùid
) {

49 
fid
->
·»Á_roÙ_objeùid
 = 
·»Á_roÙ_id
;

50 
Ën
 = 
BTRFS_FID_SIZE_CONNECTABLE_ROOT
;

51 
ty³
 = 
FILEID_BTRFS_WITH_PARENT_ROOT
;

53 
Ën
 = 
BTRFS_FID_SIZE_CONNECTABLE
;

54 
ty³
 = 
FILEID_BTRFS_WITH_PARENT
;

58 *
max_Ën
 = 
Ën
;

59  
ty³
;

60 
	}
}

74 
d’Œy
 *
	$bŒfs_g‘_d’Œy
(
su³r_block
 *
sb
, 
u64
 
objeùid
,

75 
u64
 
roÙ_objeùid
, u64 
g’”©iÚ
)

77 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

78 
bŒfs_roÙ
 *
roÙ
;

79 
šode
 *inode;

81 ià(
objeùid
 < 
BTRFS_FIRST_FREE_OBJECTID
)

82  
	`ERR_PTR
(-
ESTALE
);

84 
roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
roÙ_objeùid
, 
Œue
);

85 ià(
	`IS_ERR
(
roÙ
))

86  
	`ERR_CAST
(
roÙ
);

88 
šode
 = 
	`bŒfs_ig‘
(
sb
, 
objeùid
, 
roÙ
);

89 
	`bŒfs_put_roÙ
(
roÙ
);

90 ià(
	`IS_ERR
(
šode
))

91  
	`ERR_CAST
(
šode
);

93 ià(
g’”©iÚ
 !ğ0 && g’”©iÚ !ğ
šode
->
i_g’”©iÚ
) {

94 
	`ut
(
šode
);

95  
	`ERR_PTR
(-
ESTALE
);

98  
	`d_obš_®Ÿs
(
šode
);

99 
	}
}

101 
d’Œy
 *
	$bŒfs_fh_to_·»Á
(
su³r_block
 *
sb
, 
fid
 *
fh
,

102 
fh_Ën
, 
fh_ty³
)

104 
bŒfs_fid
 *
fid
 = (bŒfs_fid *è
fh
;

105 
u64
 
objeùid
, 
roÙ_objeùid
;

106 
u32
 
g’”©iÚ
;

108 ià(
fh_ty³
 =ğ
FILEID_BTRFS_WITH_PARENT
) {

109 ià(
fh_Ën
 < 
BTRFS_FID_SIZE_CONNECTABLE
)

110  
NULL
;

111 
roÙ_objeùid
 = 
fid
->root_objectid;

112 } ià(
fh_ty³
 =ğ
FILEID_BTRFS_WITH_PARENT_ROOT
) {

113 ià(
fh_Ën
 < 
BTRFS_FID_SIZE_CONNECTABLE_ROOT
)

114  
NULL
;

115 
roÙ_objeùid
 = 
fid
->
·»Á_roÙ_objeùid
;

117  
NULL
;

119 
objeùid
 = 
fid
->
·»Á_objeùid
;

120 
g’”©iÚ
 = 
fid
->
·»Á_g’
;

122  
	`bŒfs_g‘_d’Œy
(
sb
, 
objeùid
, 
roÙ_objeùid
, 
g’”©iÚ
);

123 
	}
}

125 
d’Œy
 *
	$bŒfs_fh_to_d’Œy
(
su³r_block
 *
sb
, 
fid
 *
fh
,

126 
fh_Ën
, 
fh_ty³
)

128 
bŒfs_fid
 *
fid
 = (bŒfs_fid *è
fh
;

129 
u64
 
objeùid
, 
roÙ_objeùid
;

130 
u32
 
g’”©iÚ
;

132 ià((
fh_ty³
 !ğ
FILEID_BTRFS_WITH_PARENT
 ||

133 
fh_Ën
 < 
BTRFS_FID_SIZE_CONNECTABLE
) &&

134 (
fh_ty³
 !ğ
FILEID_BTRFS_WITH_PARENT_ROOT
 ||

135 
fh_Ën
 < 
BTRFS_FID_SIZE_CONNECTABLE_ROOT
) &&

136 (
fh_ty³
 !ğ
FILEID_BTRFS_WITHOUT_PARENT
 ||

137 
fh_Ën
 < 
BTRFS_FID_SIZE_NON_CONNECTABLE
))

138  
NULL
;

140 
objeùid
 = 
fid
->objectid;

141 
roÙ_objeùid
 = 
fid
->root_objectid;

142 
g’”©iÚ
 = 
fid
->
g’
;

144  
	`bŒfs_g‘_d’Œy
(
sb
, 
objeùid
, 
roÙ_objeùid
, 
g’”©iÚ
);

145 
	}
}

147 
d’Œy
 *
	$bŒfs_g‘_·»Á
(
d’Œy
 *
chd
)

149 
šode
 *
dœ
 = 
	`d_šode
(
chd
);

150 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

151 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

152 
bŒfs_·th
 *
·th
;

153 
ex‹Á_bufãr
 *
Ëaf
;

154 
bŒfs_roÙ_»f
 *
»f
;

155 
bŒfs_key
 
key
;

156 
bŒfs_key
 
found_key
;

157 
»t
;

159 
·th
 = 
	`bŒfs_®loc_·th
();

160 ià(!
·th
)

161  
	`ERR_PTR
(-
ENOMEM
);

163 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
)è=ğ
BTRFS_FIRST_FREE_OBJECTID
) {

164 
key
.
objeùid
 = 
roÙ
->
roÙ_key
.objectid;

165 
key
.
ty³
 = 
BTRFS_ROOT_BACKREF_KEY
;

166 
key
.
off£t
 = (
u64
)-1;

167 
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

169 
key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
));

170 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

171 
key
.
off£t
 = (
u64
)-1;

174 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

175 ià(
»t
 < 0)

176 
ç
;

178 
	`BUG_ON
(
»t
 == 0);

179 ià(
·th
->
¦Ùs
[0] == 0) {

180 
»t
 = -
ENOENT
;

181 
ç
;

184 
·th
->
¦Ùs
[0]--;

185 
Ëaf
 = 
·th
->
nodes
[0];

187 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

188 ià(
found_key
.
objeùid
 !ğ
key
.objeùid || found_key.
ty³
 != key.type) {

189 
»t
 = -
ENOENT
;

190 
ç
;

193 ià(
found_key
.
ty³
 =ğ
BTRFS_ROOT_BACKREF_KEY
) {

194 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

195 
bŒfs_roÙ_»f
);

196 
key
.
objeùid
 = 
	`bŒfs_roÙ_»f_dœid
(
Ëaf
, 
»f
);

198 
key
.
objeùid
 = 
found_key
.
off£t
;

200 
	`bŒfs_ä“_·th
(
·th
);

202 ià(
found_key
.
ty³
 =ğ
BTRFS_ROOT_BACKREF_KEY
) {

203  
	`bŒfs_g‘_d’Œy
(
fs_šfo
->
sb
, 
key
.
objeùid
,

204 
found_key
.
off£t
, 0);

207  
	`d_obš_®Ÿs
(
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
key
.
objeùid
, 
roÙ
));

208 
ç
:

209 
	`bŒfs_ä“_·th
(
·th
);

210  
	`ERR_PTR
(
»t
);

211 
	}
}

213 
	$bŒfs_g‘_Çme
(
d’Œy
 *
·»Á
, *
Çme
,

214 
d’Œy
 *
chd
)

216 
šode
 *šodğ
	`d_šode
(
chd
);

217 
šode
 *
dœ
 = 
	`d_šode
(
·»Á
);

218 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

219 
bŒfs_·th
 *
·th
;

220 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

221 
bŒfs_šode_»f
 *
œef
;

222 
bŒfs_roÙ_»f
 *
¼ef
;

223 
ex‹Á_bufãr
 *
Ëaf
;

224 
Çme_±r
;

225 
bŒfs_key
 
key
;

226 
Çme_Ën
;

227 
»t
;

228 
u64
 
šo
;

230 ià(!
	`S_ISDIR
(
dœ
->
i_mode
))

231  -
EINVAL
;

233 
šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

235 
·th
 = 
	`bŒfs_®loc_·th
();

236 ià(!
·th
)

237  -
ENOMEM
;

239 ià(
šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
) {

240 
key
.
objeùid
 = 
	`BTRFS_I
(
šode
)->
roÙ
->
roÙ_key
.objectid;

241 
key
.
ty³
 = 
BTRFS_ROOT_BACKREF_KEY
;

242 
key
.
off£t
 = (
u64
)-1;

243 
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

245 
key
.
objeùid
 = 
šo
;

246 
key
.
off£t
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
));

247 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

250 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

251 ià(
»t
 < 0) {

252 
	`bŒfs_ä“_·th
(
·th
);

253  
»t
;

254 } ià(
»t
 > 0) {

255 ià(
šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
) {

256 
·th
->
¦Ùs
[0]--;

258 
	`bŒfs_ä“_·th
(
·th
);

259  -
ENOENT
;

262 
Ëaf
 = 
·th
->
nodes
[0];

264 ià(
šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
) {

265 
¼ef
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

266 
bŒfs_roÙ_»f
);

267 
Çme_±r
 = ()(
¼ef
 + 1);

268 
Çme_Ën
 = 
	`bŒfs_roÙ_»f_Çme_Ën
(
Ëaf
, 
¼ef
);

270 
œef
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

271 
bŒfs_šode_»f
);

272 
Çme_±r
 = ()(
œef
 + 1);

273 
Çme_Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
Ëaf
, 
œef
);

276 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
Çme
, 
Çme_±r
, 
Çme_Ën
);

277 
	`bŒfs_ä“_·th
(
·th
);

283 
Çme
[
Çme_Ën
] = '\0';

286 
	}
}

288 cÚ¡ 
expÜt_İ”©iÚs
 
	gbŒfs_expÜt_İs
 = {

289 .
’code_fh
 = 
bŒfs_’code_fh
,

290 .
	gfh_to_d’Œy
 = 
bŒfs_fh_to_d’Œy
,

291 .
	gfh_to_·»Á
 = 
bŒfs_fh_to_·»Á
,

292 .
	gg‘_·»Á
 = 
bŒfs_g‘_·»Á
,

293 .
	gg‘_Çme
 = 
bŒfs_g‘_Çme
,

	@export.h

3 #iâdeà
BTRFS_EXPORT_H


4 
	#BTRFS_EXPORT_H


	)

6 
	~<lšux/expÜtfs.h
>

8 cÚ¡ 
expÜt_İ”©iÚs
 
bŒfs_expÜt_İs
;

10 
	sbŒfs_fid
 {

11 
u64
 
	mobjeùid
;

12 
u64
 
	mroÙ_objeùid
;

13 
u32
 
	mg’
;

15 
u64
 
	m·»Á_objeùid
;

16 
u32
 
	m·»Á_g’
;

18 
u64
 
	m·»Á_roÙ_objeùid
;

19 } 
__©Œibu‹__
 ((
·cked
));

21 
d’Œy
 *
bŒfs_g‘_d’Œy
(
su³r_block
 *
sb
, 
u64
 
objeùid
,

22 
u64
 
roÙ_objeùid
, u64 
g’”©iÚ
);

23 
d’Œy
 *
bŒfs_g‘_·»Á
(d’Œy *
chd
);

	@extent-io-tree.c

3 
	~<lšux/¦ab.h
>

4 
	~<Œaû/ev’ts/bŒfs.h
>

5 
	~"mes§ges.h
"

6 
	~"ù»e.h
"

7 
	~"ex‹Á-io-Œ“.h
"

8 
	~"bŒfs_šode.h
"

9 
	~"misc.h
"

11 
kmem_ÿche
 *
	gex‹Á_¡©e_ÿche
;

13 
šlše
 
boŞ
 
	$ex‹Á_¡©e_š_Œ“
(cÚ¡ 
ex‹Á_¡©e
 *
¡©e
)

15  !
	`RB_EMPTY_NODE
(&
¡©e
->
rb_node
);

16 
	}
}

18 #ifdeà
CONFIG_BTRFS_DEBUG


19 
LIST_HEAD
(
¡©es
);

20 
DEFINE_SPINLOCK
(
Ëak_lock
);

22 
šlše
 
	$bŒfs_Ëak_debug_add_¡©e
(
ex‹Á_¡©e
 *
¡©e
)

24 
æags
;

26 
	`¥š_lock_œq§ve
(&
Ëak_lock
, 
æags
);

27 
	`li¡_add
(&
¡©e
->
Ëak_li¡
, &
¡©es
);

28 
	`¥š_uÆock_œq»¡Üe
(&
Ëak_lock
, 
æags
);

29 
	}
}

31 
šlše
 
	$bŒfs_Ëak_debug_d–_¡©e
(
ex‹Á_¡©e
 *
¡©e
)

33 
æags
;

35 
	`¥š_lock_œq§ve
(&
Ëak_lock
, 
æags
);

36 
	`li¡_d–
(&
¡©e
->
Ëak_li¡
);

37 
	`¥š_uÆock_œq»¡Üe
(&
Ëak_lock
, 
æags
);

38 
	}
}

40 
šlše
 
	$bŒfs_ex‹Á_¡©e_Ëak_debug_check
()

42 
ex‹Á_¡©e
 *
¡©e
;

44 !
	`li¡_em±y
(&
¡©es
)) {

45 
¡©e
 = 
	`li¡_’Œy
(
¡©es
.
Ãxt
, 
ex‹Á_¡©e
, 
Ëak_li¡
);

46 
	`´_”r
("BTRFS: state†eak: start %lluƒnd %llu state %u inree %d„efs %d\n",

47 
¡©e
->
¡¬t
, s‹->
’d
, state->state,

48 
	`ex‹Á_¡©e_š_Œ“
(
¡©e
),

49 
	`»fcouÁ_»ad
(&
¡©e
->
»fs
));

50 
	`li¡_d–
(&
¡©e
->
Ëak_li¡
);

51 
	`kmem_ÿche_ä“
(
ex‹Á_¡©e_ÿche
, 
¡©e
);

53 
	}
}

55 
	#bŒfs_debug_check_ex‹Á_io_¿nge
(
Œ“
, 
¡¬t
, 
’d
) \

56 
	`__bŒfs_debug_check_ex‹Á_io_¿nge
(
__func__
, (
Œ“
), (
¡¬t
), (
’d
))

	)

57 
šlše
 
	$__bŒfs_debug_check_ex‹Á_io_¿nge
(cÚ¡ *
ÿÎ”
,

58 
ex‹Á_io_Œ“
 *
Œ“
,

59 
u64
 
¡¬t
, u64 
’d
)

61 
bŒfs_šode
 *
šode
 = 
Œ“
->inode;

62 
u64
 
isize
;

64 ià(!
šode
)

67 
isize
 = 
	`i_size_»ad
(&
šode
->
vfs_šode
);

68 ià(
’d
 >ğ
PAGE_SIZE
 && (’d % 2è=ğ0 &&ƒnd !ğ
isize
 - 1) {

69 
	`bŒfs_debug_¾
(
šode
->
roÙ
->
fs_šfo
,

71 
ÿÎ”
, 
	`bŒfs_šo
(
šode
), 
isize
, 
¡¬t
, 
’d
);

73 
	}
}

75 
	#bŒfs_Ëak_debug_add_¡©e
(
¡©e
èdØ{} 0)

	)

76 
	#bŒfs_Ëak_debug_d–_¡©e
(
¡©e
èdØ{} 0)

	)

77 
	#bŒfs_ex‹Á_¡©e_Ëak_debug_check
(èdØ{} 0)

	)

78 
	#bŒfs_debug_check_ex‹Á_io_¿nge
(
c
, 
s
, 
e
èdØ{} 0)

	)

88 
lock_şass_key
 
	gfe_ex‹Á_Œ“_şass
;

90 
	sŒ“_’Œy
 {

91 
u64
 
	m¡¬t
;

92 
u64
 
	m’d
;

93 
rb_node
 
	mrb_node
;

96 
	$ex‹Á_io_Œ“_š™
(
bŒfs_fs_šfo
 *
fs_šfo
,

97 
ex‹Á_io_Œ“
 *
Œ“
, 
owÃr
)

99 
Œ“
->
fs_šfo
 = fs_info;

100 
Œ“
->
¡©e
 = 
RB_ROOT
;

101 
	`¥š_lock_š™
(&
Œ“
->
lock
);

102 
Œ“
->
šode
 = 
NULL
;

103 
Œ“
->
owÃr
 = owner;

104 ià(
owÃr
 =ğ
IO_TREE_INODE_FILE_EXTENT
)

105 
	`lockd•_£t_şass
(&
Œ“
->
lock
, &
fe_ex‹Á_Œ“_şass
);

106 
	}
}

108 
	$ex‹Á_io_Œ“_»Ëa£
(
ex‹Á_io_Œ“
 *
Œ“
)

110 
	`¥š_lock
(&
Œ“
->
lock
);

116 
	`smp_mb
();

117 !
	`RB_EMPTY_ROOT
(&
Œ“
->
¡©e
)) {

118 
rb_node
 *
node
;

119 
ex‹Á_¡©e
 *
¡©e
;

121 
node
 = 
	`rb_fœ¡
(&
Œ“
->
¡©e
);

122 
¡©e
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©e
, 
rb_node
);

123 
	`rb_”a£
(&
¡©e
->
rb_node
, &
Œ“
->state);

124 
	`RB_CLEAR_NODE
(&
¡©e
->
rb_node
);

129 
	`ASSERT
(!
	`wa™queue_aùive
(&
¡©e
->
wq
));

130 
	`ä“_ex‹Á_¡©e
(
¡©e
);

132 
	`cÚd_»sched_lock
(&
Œ“
->
lock
);

134 
	`¥š_uÆock
(&
Œ“
->
lock
);

135 
	}
}

137 
ex‹Á_¡©e
 *
	$®loc_ex‹Á_¡©e
(
gå_t
 
mask
)

139 
ex‹Á_¡©e
 *
¡©e
;

145 
mask
 &ğ~(
__GFP_DMA32
|
__GFP_HIGHMEM
);

146 
¡©e
 = 
	`kmem_ÿche_®loc
(
ex‹Á_¡©e_ÿche
, 
mask
);

147 ià(!
¡©e
)

148  
¡©e
;

149 
¡©e
->state = 0;

150 
	`RB_CLEAR_NODE
(&
¡©e
->
rb_node
);

151 
	`bŒfs_Ëak_debug_add_¡©e
(
¡©e
);

152 
	`»fcouÁ_£t
(&
¡©e
->
»fs
, 1);

153 
	`š™_wa™queue_h—d
(&
¡©e
->
wq
);

154 
	`Œaû_®loc_ex‹Á_¡©e
(
¡©e
, 
mask
, 
_RET_IP_
);

155  
¡©e
;

156 
	}
}

158 
ex‹Á_¡©e
 *
	$®loc_ex‹Á_¡©e_©omic
(
ex‹Á_¡©e
 *
´—Îoc
)

160 ià(!
´—Îoc
)

161 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e
(
GFP_ATOMIC
);

163  
´—Îoc
;

164 
	}
}

166 
	$ä“_ex‹Á_¡©e
(
ex‹Á_¡©e
 *
¡©e
)

168 ià(!
¡©e
)

170 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
¡©e
->
»fs
)) {

171 
	`WARN_ON
(
	`ex‹Á_¡©e_š_Œ“
(
¡©e
));

172 
	`bŒfs_Ëak_debug_d–_¡©e
(
¡©e
);

173 
	`Œaû_ä“_ex‹Á_¡©e
(
¡©e
, 
_RET_IP_
);

174 
	`kmem_ÿche_ä“
(
ex‹Á_¡©e_ÿche
, 
¡©e
);

176 
	}
}

178 
	$add_ex‹Á_chªge£t
(
ex‹Á_¡©e
 *
¡©e
, 
u32
 
b™s
,

179 
ex‹Á_chªge£t
 *
chªge£t
,

180 
£t
)

182 
»t
;

184 ià(!
chªge£t
)

186 ià(
£t
 && (
¡©e
->¡©& 
b™s
) == bits)

188 ià(!
£t
 && (
¡©e
->¡©& 
b™s
) == 0)

190 
chªge£t
->
by‹s_chªged
 +ğ
¡©e
->
’d
 - s‹->
¡¬t
 + 1;

191 
»t
 = 
	`uli¡_add
(&
chªge£t
->
¿nge_chªged
, 
¡©e
->
¡¬t
, s‹->
’d
,

192 
GFP_ATOMIC
);

193  
»t
;

194 
	}
}

196 
šlše
 
ex‹Á_¡©e
 *
	$Ãxt_¡©e
(
ex‹Á_¡©e
 *
¡©e
)

198 
rb_node
 *
Ãxt
 = 
	`rb_Ãxt
(&
¡©e
->rb_node);

200 ià(
Ãxt
)

201  
	`rb_’Œy
(
Ãxt
, 
ex‹Á_¡©e
, 
rb_node
);

203  
NULL
;

204 
	}
}

206 
šlše
 
ex‹Á_¡©e
 *
	$´ev_¡©e
(
ex‹Á_¡©e
 *
¡©e
)

208 
rb_node
 *
Ãxt
 = 
	`rb_´ev
(&
¡©e
->rb_node);

210 ià(
Ãxt
)

211  
	`rb_’Œy
(
Ãxt
, 
ex‹Á_¡©e
, 
rb_node
);

213  
NULL
;

214 
	}
}

233 
šlše
 
ex‹Á_¡©e
 *
	$Œ“_£¬ch_fÜ_š£¹
(
ex‹Á_io_Œ“
 *
Œ“
,

234 
u64
 
off£t
,

235 
rb_node
 ***
node_»t
,

236 
rb_node
 **
·»Á_»t
)

238 
rb_roÙ
 *
roÙ
 = &
Œ“
->
¡©e
;

239 
rb_node
 **
node
 = &
roÙ
->rb_node;

240 
rb_node
 *
´ev
 = 
NULL
;

241 
ex‹Á_¡©e
 *
’Œy
 = 
NULL
;

243 *
node
) {

244 
´ev
 = *
node
;

245 
’Œy
 = 
	`rb_’Œy
(
´ev
, 
ex‹Á_¡©e
, 
rb_node
);

247 ià(
off£t
 < 
’Œy
->
¡¬t
)

248 
node
 = &(*node)->
rb_Ëá
;

249 ià(
off£t
 > 
’Œy
->
’d
)

250 
node
 = &(*node)->
rb_right
;

252  
’Œy
;

255 ià(
node_»t
)

256 *
node_»t
 = 
node
;

257 ià(
·»Á_»t
)

258 *
·»Á_»t
 = 
´ev
;

261 
’Œy
 && 
off£t
 >ƒÁry->
’d
)

262 
’Œy
 = 
	`Ãxt_¡©e
(entry);

264  
’Œy
;

265 
	}
}

279 
ex‹Á_¡©e
 *
	$Œ“_£¬ch_´ev_Ãxt
(
ex‹Á_io_Œ“
 *
Œ“
,

280 
u64
 
off£t
,

281 
ex‹Á_¡©e
 **
´ev_»t
,

282 
ex‹Á_¡©e
 **
Ãxt_»t
)

284 
rb_roÙ
 *
roÙ
 = &
Œ“
->
¡©e
;

285 
rb_node
 **
node
 = &
roÙ
->rb_node;

286 
ex‹Á_¡©e
 *
Üig_´ev
;

287 
ex‹Á_¡©e
 *
’Œy
 = 
NULL
;

289 
	`ASSERT
(
´ev_»t
);

290 
	`ASSERT
(
Ãxt_»t
);

292 *
node
) {

293 
’Œy
 = 
	`rb_’Œy
(*
node
, 
ex‹Á_¡©e
, 
rb_node
);

295 ià(
off£t
 < 
’Œy
->
¡¬t
)

296 
node
 = &(*node)->
rb_Ëá
;

297 ià(
off£t
 > 
’Œy
->
’d
)

298 
node
 = &(*node)->
rb_right
;

300  
’Œy
;

303 
Üig_´ev
 = 
’Œy
;

304 
’Œy
 && 
off£t
 >ƒÁry->
’d
)

305 
’Œy
 = 
	`Ãxt_¡©e
(entry);

306 *
Ãxt_»t
 = 
’Œy
;

307 
’Œy
 = 
Üig_´ev
;

309 
’Œy
 && 
off£t
 <ƒÁry->
¡¬t
)

310 
’Œy
 = 
	`´ev_¡©e
(entry);

311 *
´ev_»t
 = 
’Œy
;

313  
NULL
;

314 
	}
}

319 
šlše
 
ex‹Á_¡©e
 *
	$Œ“_£¬ch
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
off£t
)

321  
	`Œ“_£¬ch_fÜ_š£¹
(
Œ“
, 
off£t
, 
NULL
, NULL);

322 
	}
}

324 
	$ex‹Á_io_Œ“_·nic
(
ex‹Á_io_Œ“
 *
Œ“
, 
”r
)

326 
	`bŒfs_·nic
(
Œ“
->
fs_šfo
, 
”r
,

328 
	}
}

339 
	$m”ge_¡©e
(
ex‹Á_io_Œ“
 *
Œ“
, 
ex‹Á_¡©e
 *
¡©e
)

341 
ex‹Á_¡©e
 *
Ùh”
;

343 ià(
¡©e
->¡©& (
EXTENT_LOCKED
 | 
EXTENT_BOUNDARY
))

346 
Ùh”
 = 
	`´ev_¡©e
(
¡©e
);

347 ià(
Ùh”
 && oth”->
’d
 =ğ
¡©e
->
¡¬t
 - 1 &&

348 
Ùh”
->
¡©e
 == state->state) {

349 ià(
Œ“
->
šode
)

350 
	`bŒfs_m”ge_d–®loc_ex‹Á
(
Œ“
->
šode
, 
¡©e
, 
Ùh”
);

351 
¡©e
->
¡¬t
 = 
Ùh”
->start;

352 
	`rb_”a£
(&
Ùh”
->
rb_node
, &
Œ“
->
¡©e
);

353 
	`RB_CLEAR_NODE
(&
Ùh”
->
rb_node
);

354 
	`ä“_ex‹Á_¡©e
(
Ùh”
);

356 
Ùh”
 = 
	`Ãxt_¡©e
(
¡©e
);

357 ià(
Ùh”
 && oth”->
¡¬t
 =ğ
¡©e
->
’d
 + 1 &&

358 
Ùh”
->
¡©e
 == state->state) {

359 ià(
Œ“
->
šode
)

360 
	`bŒfs_m”ge_d–®loc_ex‹Á
(
Œ“
->
šode
, 
¡©e
, 
Ùh”
);

361 
¡©e
->
’d
 = 
Ùh”
->end;

362 
	`rb_”a£
(&
Ùh”
->
rb_node
, &
Œ“
->
¡©e
);

363 
	`RB_CLEAR_NODE
(&
Ùh”
->
rb_node
);

364 
	`ä“_ex‹Á_¡©e
(
Ùh”
);

366 
	}
}

368 
	$£t_¡©e_b™s
(
ex‹Á_io_Œ“
 *
Œ“
,

369 
ex‹Á_¡©e
 *
¡©e
,

370 
u32
 
b™s
, 
ex‹Á_chªge£t
 *
chªge£t
)

372 
u32
 
b™s_to_£t
 = 
b™s
 & ~
EXTENT_CTLBITS
;

373 
»t
;

375 ià(
Œ“
->
šode
)

376 
	`bŒfs_£t_d–®loc_ex‹Á
(
Œ“
->
šode
, 
¡©e
, 
b™s
);

378 
»t
 = 
	`add_ex‹Á_chªge£t
(
¡©e
, 
b™s_to_£t
, 
chªge£t
, 1);

379 
	`BUG_ON
(
»t
 < 0);

380 
¡©e
->¡©|ğ
b™s_to_£t
;

381 
	}
}

393 
	$š£¹_¡©e
(
ex‹Á_io_Œ“
 *
Œ“
,

394 
ex‹Á_¡©e
 *
¡©e
,

395 
u32
 
b™s
, 
ex‹Á_chªge£t
 *
chªge£t
)

397 
rb_node
 **
node
;

398 
rb_node
 *
·»Á
 = 
NULL
;

399 cÚ¡ 
u64
 
’d
 = 
¡©e
->end;

401 
	`£t_¡©e_b™s
(
Œ“
, 
¡©e
, 
b™s
, 
chªge£t
);

403 
node
 = &
Œ“
->
¡©e
.
rb_node
;

404 *
node
) {

405 
ex‹Á_¡©e
 *
’Œy
;

407 
·»Á
 = *
node
;

408 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
ex‹Á_¡©e
, 
rb_node
);

410 ià(
’d
 < 
’Œy
->
¡¬t
) {

411 
node
 = &(*node)->
rb_Ëá
;

412 } ià(
’d
 > 
’Œy
->end) {

413 
node
 = &(*node)->
rb_right
;

415 
	`bŒfs_”r
(
Œ“
->
fs_šfo
,

417 
’Œy
->
¡¬t
,ƒÁry->
’d
, 
¡©e
->start,ƒnd);

418  -
EEXIST
;

422 
	`rb_lšk_node
(&
¡©e
->
rb_node
, 
·»Á
, 
node
);

423 
	`rb_š£¹_cŞÜ
(&
¡©e
->
rb_node
, &
Œ“
->state);

425 
	`m”ge_¡©e
(
Œ“
, 
¡©e
);

427 
	}
}

432 
	$š£¹_¡©e_ç¡
(
ex‹Á_io_Œ“
 *
Œ“
,

433 
ex‹Á_¡©e
 *
¡©e
, 
rb_node
 **
node
,

434 
rb_node
 *
·»Á
, 
b™s
,

435 
ex‹Á_chªge£t
 *
chªge£t
)

437 
	`£t_¡©e_b™s
(
Œ“
, 
¡©e
, 
b™s
, 
chªge£t
);

438 
	`rb_lšk_node
(&
¡©e
->
rb_node
, 
·»Á
, 
node
);

439 
	`rb_š£¹_cŞÜ
(&
¡©e
->
rb_node
, &
Œ“
->state);

440 
	`m”ge_¡©e
(
Œ“
, 
¡©e
);

441 
	}
}

457 
	$¥l™_¡©e
(
ex‹Á_io_Œ“
 *
Œ“
, 
ex‹Á_¡©e
 *
Üig
,

458 
ex‹Á_¡©e
 *
´—Îoc
, 
u64
 
¥l™
)

460 
rb_node
 *
·»Á
 = 
NULL
;

461 
rb_node
 **
node
;

463 ià(
Œ“
->
šode
)

464 
	`bŒfs_¥l™_d–®loc_ex‹Á
(
Œ“
->
šode
, 
Üig
, 
¥l™
);

466 
´—Îoc
->
¡¬t
 = 
Üig
->start;

467 
´—Îoc
->
’d
 = 
¥l™
 - 1;

468 
´—Îoc
->
¡©e
 = 
Üig
->state;

469 
Üig
->
¡¬t
 = 
¥l™
;

471 
·»Á
 = &
Üig
->
rb_node
;

472 
node
 = &
·»Á
;

473 *
node
) {

474 
ex‹Á_¡©e
 *
’Œy
;

476 
·»Á
 = *
node
;

477 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
ex‹Á_¡©e
, 
rb_node
);

479 ià(
´—Îoc
->
’d
 < 
’Œy
->
¡¬t
) {

480 
node
 = &(*node)->
rb_Ëá
;

481 } ià(
´—Îoc
->
’d
 > 
’Œy
->end) {

482 
node
 = &(*node)->
rb_right
;

484 
	`ä“_ex‹Á_¡©e
(
´—Îoc
);

485  -
EEXIST
;

489 
	`rb_lšk_node
(&
´—Îoc
->
rb_node
, 
·»Á
, 
node
);

490 
	`rb_š£¹_cŞÜ
(&
´—Îoc
->
rb_node
, &
Œ“
->
¡©e
);

493 
	}
}

502 
ex‹Á_¡©e
 *
	$ş—r_¡©e_b™
(
ex‹Á_io_Œ“
 *
Œ“
,

503 
ex‹Á_¡©e
 *
¡©e
,

504 
u32
 
b™s
, 
wake
,

505 
ex‹Á_chªge£t
 *
chªge£t
)

507 
ex‹Á_¡©e
 *
Ãxt
;

508 
u32
 
b™s_to_ş—r
 = 
b™s
 & ~
EXTENT_CTLBITS
;

509 
»t
;

511 ià(
Œ“
->
šode
)

512 
	`bŒfs_ş—r_d–®loc_ex‹Á
(
Œ“
->
šode
, 
¡©e
, 
b™s
);

514 
»t
 = 
	`add_ex‹Á_chªge£t
(
¡©e
, 
b™s_to_ş—r
, 
chªge£t
, 0);

515 
	`BUG_ON
(
»t
 < 0);

516 
¡©e
->¡©&ğ~
b™s_to_ş—r
;

517 ià(
wake
)

518 
	`wake_up
(&
¡©e
->
wq
);

519 ià(
¡©e
->state == 0) {

520 
Ãxt
 = 
	`Ãxt_¡©e
(
¡©e
);

521 ià(
	`ex‹Á_¡©e_š_Œ“
(
¡©e
)) {

522 
	`rb_”a£
(&
¡©e
->
rb_node
, &
Œ“
->state);

523 
	`RB_CLEAR_NODE
(&
¡©e
->
rb_node
);

524 
	`ä“_ex‹Á_¡©e
(
¡©e
);

526 
	`WARN_ON
(1);

529 
	`m”ge_¡©e
(
Œ“
, 
¡©e
);

530 
Ãxt
 = 
	`Ãxt_¡©e
(
¡©e
);

532  
Ãxt
;

533 
	}
}

539 
	$£t_gå_mask_äom_b™s
(
u32
 *
b™s
, 
gå_t
 *
mask
)

541 *
mask
 = (*
b™s
 & 
EXTENT_NOWAIT
 ? 
GFP_NOWAIT
 : 
GFP_NOFS
);

542 *
b™s
 &ğ
EXTENT_NOWAIT
 - 1;

543 
	}
}

557 
	$__ş—r_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

558 
u32
 
b™s
, 
ex‹Á_¡©e
 **
ÿched_¡©e
,

559 
ex‹Á_chªge£t
 *
chªge£t
)

561 
ex‹Á_¡©e
 *
¡©e
;

562 
ex‹Á_¡©e
 *
ÿched
;

563 
ex‹Á_¡©e
 *
´—Îoc
 = 
NULL
;

564 
u64
 
Ï¡_’d
;

565 
”r
;

566 
ş—r
 = 0;

567 
wake
;

568 
d–‘e
 = (
b™s
 & 
EXTENT_CLEAR_ALL_BITS
);

569 
gå_t
 
mask
;

571 
	`£t_gå_mask_äom_b™s
(&
b™s
, &
mask
);

572 
	`bŒfs_debug_check_ex‹Á_io_¿nge
(
Œ“
, 
¡¬t
, 
’d
);

573 
	`Œaû_bŒfs_ş—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
 - s¹ + 1, 
b™s
);

575 ià(
d–‘e
)

576 
b™s
 |ğ~
EXTENT_CTLBITS
;

578 ià(
b™s
 & 
EXTENT_DELALLOC
)

579 
b™s
 |ğ
EXTENT_NORESERVE
;

581 
wake
 = (
b™s
 & 
EXTENT_LOCKED
) ? 1 : 0;

582 ià(
b™s
 & (
EXTENT_LOCKED
 | 
EXTENT_BOUNDARY
))

583 
ş—r
 = 1;

584 
agaš
:

585 ià(!
´—Îoc
) {

593 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e
(
mask
);

596 
	`¥š_lock
(&
Œ“
->
lock
);

597 ià(
ÿched_¡©e
) {

598 
ÿched
 = *
ÿched_¡©e
;

600 ià(
ş—r
) {

601 *
ÿched_¡©e
 = 
NULL
;

602 
ÿched_¡©e
 = 
NULL
;

605 ià(
ÿched
 && 
	`ex‹Á_¡©e_š_Œ“
(cached) &&

606 
ÿched
->
¡¬t
 <ğ¡¬ˆ&& cached->
’d
 > start) {

607 ià(
ş—r
)

608 
	`»fcouÁ_dec
(&
ÿched
->
»fs
);

609 
¡©e
 = 
ÿched
;

610 
h™_Ãxt
;

612 ià(
ş—r
)

613 
	`ä“_ex‹Á_¡©e
(
ÿched
);

617 
¡©e
 = 
	`Œ“_£¬ch
(
Œ“
, 
¡¬t
);

618 ià(!
¡©e
)

619 
out
;

620 
h™_Ãxt
:

621 ià(
¡©e
->
¡¬t
 > 
’d
)

622 
out
;

623 
	`WARN_ON
(
¡©e
->
’d
 < 
¡¬t
);

624 
Ï¡_’d
 = 
¡©e
->
’d
;

627 ià(!(
¡©e
->¡©& 
b™s
)) {

628 
¡©e
 = 
	`Ãxt_¡©e
(state);

629 
Ãxt
;

647 ià(
¡©e
->
¡¬t
 < start) {

648 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

649 ià(!
´—Îoc
)

650 
£¬ch_agaš
;

651 
”r
 = 
	`¥l™_¡©e
(
Œ“
, 
¡©e
, 
´—Îoc
, 
¡¬t
);

652 ià(
”r
)

653 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

655 
´—Îoc
 = 
NULL
;

656 ià(
”r
)

657 
out
;

658 ià(
¡©e
->
’d
 <=ƒnd) {

659 
¡©e
 = 
	`ş—r_¡©e_b™
(
Œ“
, s‹, 
b™s
, 
wake
, 
chªge£t
);

660 
Ãxt
;

662 
£¬ch_agaš
;

669 ià(
¡©e
->
¡¬t
 <ğ
’d
 && state->end >ƒnd) {

670 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

671 ià(!
´—Îoc
)

672 
£¬ch_agaš
;

673 
”r
 = 
	`¥l™_¡©e
(
Œ“
, 
¡©e
, 
´—Îoc
, 
’d
 + 1);

674 ià(
”r
)

675 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

677 ià(
wake
)

678 
	`wake_up
(&
¡©e
->
wq
);

680 
	`ş—r_¡©e_b™
(
Œ“
, 
´—Îoc
, 
b™s
, 
wake
, 
chªge£t
);

682 
´—Îoc
 = 
NULL
;

683 
out
;

686 
¡©e
 = 
	`ş—r_¡©e_b™
(
Œ“
, s‹, 
b™s
, 
wake
, 
chªge£t
);

687 
Ãxt
:

688 ià(
Ï¡_’d
 =ğ(
u64
)-1)

689 
out
;

690 
¡¬t
 = 
Ï¡_’d
 + 1;

691 ià(
¡¬t
 <ğ
’d
 && 
¡©e
 && !
	`Ãed_»sched
())

692 
h™_Ãxt
;

694 
£¬ch_agaš
:

695 ià(
¡¬t
 > 
’d
)

696 
out
;

697 
	`¥š_uÆock
(&
Œ“
->
lock
);

698 ià(
	`gåæags_®low_blockšg
(
mask
))

699 
	`cÚd_»sched
();

700 
agaš
;

702 
out
:

703 
	`¥š_uÆock
(&
Œ“
->
lock
);

704 ià(
´—Îoc
)

705 
	`ä“_ex‹Á_¡©e
(
´—Îoc
);

709 
	}
}

711 
	$wa™_Ú_¡©e
(
ex‹Á_io_Œ“
 *
Œ“
,

712 
ex‹Á_¡©e
 *
¡©e
)

713 
	`__»Ëa£s
(
Œ“
->
lock
)

714 
	`__acquœes
(
Œ“
->
lock
)

716 
	`DEFINE_WAIT
(
wa™
);

717 
	`´•¬e_to_wa™
(&
¡©e
->
wq
, &
wa™
, 
TASK_UNINTERRUPTIBLE
);

718 
	`¥š_uÆock
(&
Œ“
->
lock
);

719 
	`scheduË
();

720 
	`¥š_lock
(&
Œ“
->
lock
);

721 
	`fšish_wa™
(&
¡©e
->
wq
, &
wa™
);

722 
	}
}

729 
	$wa™_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
, 
u32
 
b™s
,

730 
ex‹Á_¡©e
 **
ÿched_¡©e
)

732 
ex‹Á_¡©e
 *
¡©e
;

734 
	`bŒfs_debug_check_ex‹Á_io_¿nge
(
Œ“
, 
¡¬t
, 
’d
);

736 
	`¥š_lock
(&
Œ“
->
lock
);

737 
agaš
:

742 ià(
ÿched_¡©e
 && *cached_state) {

743 
¡©e
 = *
ÿched_¡©e
;

744 ià(
	`ex‹Á_¡©e_š_Œ“
(
¡©e
) &&

745 
¡©e
->
¡¬t
 <ğ¡¬ˆ&& s¹ < s‹->
’d
)

746 
´oûss_node
;

753 
¡©e
 = 
	`Œ“_£¬ch
(
Œ“
, 
¡¬t
);

754 
´oûss_node
:

755 ià(!
¡©e
)

757 ià(
¡©e
->
¡¬t
 > 
’d
)

758 
out
;

760 ià(
¡©e
->¡©& 
b™s
) {

761 
¡¬t
 = 
¡©e
->start;

762 
	`»fcouÁ_šc
(&
¡©e
->
»fs
);

763 
	`wa™_Ú_¡©e
(
Œ“
, 
¡©e
);

764 
	`ä“_ex‹Á_¡©e
(
¡©e
);

765 
agaš
;

767 
¡¬t
 = 
¡©e
->
’d
 + 1;

769 ià(
¡¬t
 > 
’d
)

772 ià(!
	`cÚd_»sched_lock
(&
Œ“
->
lock
)) {

773 
¡©e
 = 
	`Ãxt_¡©e
(state);

774 
´oûss_node
;

777 
out
:

779 ià(
ÿched_¡©e
 && *cached_state) {

780 
¡©e
 = *
ÿched_¡©e
;

781 *
ÿched_¡©e
 = 
NULL
;

782 
	`ä“_ex‹Á_¡©e
(
¡©e
);

784 
	`¥š_uÆock
(&
Œ“
->
lock
);

785 
	}
}

787 
	$ÿche_¡©e_if_æags
(
ex‹Á_¡©e
 *
¡©e
,

788 
ex‹Á_¡©e
 **
ÿched_±r
,

789 
æags
)

791 ià(
ÿched_±r
 && !(*cached_ptr)) {

792 ià(!
æags
 || (
¡©e
->state & flags)) {

793 *
ÿched_±r
 = 
¡©e
;

794 
	`»fcouÁ_šc
(&
¡©e
->
»fs
);

797 
	}
}

799 
	$ÿche_¡©e
(
ex‹Á_¡©e
 *
¡©e
,

800 
ex‹Á_¡©e
 **
ÿched_±r
)

802  
	`ÿche_¡©e_if_æags
(
¡©e
, 
ÿched_±r
,

803 
EXTENT_LOCKED
 | 
EXTENT_BOUNDARY
);

804 
	}
}

811 
ex‹Á_¡©e
 *
	$fšd_fœ¡_ex‹Á_b™_¡©e
(
ex‹Á_io_Œ“
 *
Œ“
,

812 
u64
 
¡¬t
, 
u32
 
b™s
)

814 
ex‹Á_¡©e
 *
¡©e
;

820 
¡©e
 = 
	`Œ“_£¬ch
(
Œ“
, 
¡¬t
);

821 
¡©e
) {

822 ià(
¡©e
->
’d
 >ğ
¡¬t
 && (¡©e->¡©& 
b™s
))

823  
¡©e
;

824 
¡©e
 = 
	`Ãxt_¡©e
(state);

826  
NULL
;

827 
	}
}

837 
boŞ
 
	$fšd_fœ¡_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

838 
u64
 *
¡¬t_»t
, u64 *
’d_»t
, 
u32
 
b™s
,

839 
ex‹Á_¡©e
 **
ÿched_¡©e
)

841 
ex‹Á_¡©e
 *
¡©e
;

842 
boŞ
 
»t
 = 
çl£
;

844 
	`¥š_lock
(&
Œ“
->
lock
);

845 ià(
ÿched_¡©e
 && *cached_state) {

846 
¡©e
 = *
ÿched_¡©e
;

847 ià(
¡©e
->
’d
 =ğ
¡¬t
 - 1 && 
	`ex‹Á_¡©e_š_Œ“
(state)) {

848 (
¡©e
 = 
	`Ãxt_¡©e
(¡©e)è!ğ
NULL
) {

849 ià(
¡©e
->¡©& 
b™s
)

850 
gÙ_™
;

852 
	`ä“_ex‹Á_¡©e
(*
ÿched_¡©e
);

853 *
ÿched_¡©e
 = 
NULL
;

854 
out
;

856 
	`ä“_ex‹Á_¡©e
(*
ÿched_¡©e
);

857 *
ÿched_¡©e
 = 
NULL
;

860 
¡©e
 = 
	`fšd_fœ¡_ex‹Á_b™_¡©e
(
Œ“
, 
¡¬t
, 
b™s
);

861 
gÙ_™
:

862 ià(
¡©e
) {

863 
	`ÿche_¡©e_if_æags
(
¡©e
, 
ÿched_¡©e
, 0);

864 *
¡¬t_»t
 = 
¡©e
->
¡¬t
;

865 *
’d_»t
 = 
¡©e
->
’d
;

866 
»t
 = 
Œue
;

868 
out
:

869 
	`¥š_uÆock
(&
Œ“
->
lock
);

870  
»t
;

871 
	}
}

889 
	$fšd_cÚtiguous_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

890 
u64
 *
¡¬t_»t
, u64 *
’d_»t
, 
u32
 
b™s
)

892 
ex‹Á_¡©e
 *
¡©e
;

893 
»t
 = 1;

895 
	`¥š_lock
(&
Œ“
->
lock
);

896 
¡©e
 = 
	`fšd_fœ¡_ex‹Á_b™_¡©e
(
Œ“
, 
¡¬t
, 
b™s
);

897 ià(
¡©e
) {

898 *
¡¬t_»t
 = 
¡©e
->
¡¬t
;

899 *
’d_»t
 = 
¡©e
->
’d
;

900 (
¡©e
 = 
	`Ãxt_¡©e
(¡©e)è!ğ
NULL
) {

901 ià(
¡©e
->
¡¬t
 > (*
’d_»t
 + 1))

903 *
’d_»t
 = 
¡©e
->
’d
;

905 
»t
 = 0;

907 
	`¥š_uÆock
(&
Œ“
->
lock
);

908  
»t
;

909 
	}
}

917 
boŞ
 
	$bŒfs_fšd_d–®loc_¿nge
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 *
¡¬t
,

918 
u64
 *
’d
, u64 
max_by‹s
,

919 
ex‹Á_¡©e
 **
ÿched_¡©e
)

921 
ex‹Á_¡©e
 *
¡©e
;

922 
u64
 
cur_¡¬t
 = *
¡¬t
;

923 
boŞ
 
found
 = 
çl£
;

924 
u64
 
tÙ®_by‹s
 = 0;

926 
	`¥š_lock
(&
Œ“
->
lock
);

932 
¡©e
 = 
	`Œ“_£¬ch
(
Œ“
, 
cur_¡¬t
);

933 ià(!
¡©e
) {

934 *
’d
 = (
u64
)-1;

935 
out
;

938 
¡©e
) {

939 ià(
found
 && (
¡©e
->
¡¬t
 !ğ
cur_¡¬t
 ||

940 (
¡©e
->¡©& 
EXTENT_BOUNDARY
))) {

941 
out
;

943 ià(!(
¡©e
->¡©& 
EXTENT_DELALLOC
)) {

944 ià(!
found
)

945 *
’d
 = 
¡©e
->end;

946 
out
;

948 ià(!
found
) {

949 *
¡¬t
 = 
¡©e
->start;

950 *
ÿched_¡©e
 = 
¡©e
;

951 
	`»fcouÁ_šc
(&
¡©e
->
»fs
);

953 
found
 = 
Œue
;

954 *
’d
 = 
¡©e
->end;

955 
cur_¡¬t
 = 
¡©e
->
’d
 + 1;

956 
tÙ®_by‹s
 +ğ
¡©e
->
’d
 - s‹->
¡¬t
 + 1;

957 ià(
tÙ®_by‹s
 >ğ
max_by‹s
)

959 
¡©e
 = 
	`Ãxt_¡©e
(state);

961 
out
:

962 
	`¥š_uÆock
(&
Œ“
->
lock
);

963  
found
;

964 
	}
}

980 
	$__£t_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

981 
u32
 
b™s
, 
u64
 *
çed_¡¬t
,

982 
ex‹Á_¡©e
 **
çed_¡©e
,

983 
ex‹Á_¡©e
 **
ÿched_¡©e
,

984 
ex‹Á_chªge£t
 *
chªge£t
)

986 
ex‹Á_¡©e
 *
¡©e
;

987 
ex‹Á_¡©e
 *
´—Îoc
 = 
NULL
;

988 
rb_node
 **
p
 = 
NULL
;

989 
rb_node
 *
·»Á
 = 
NULL
;

990 
”r
 = 0;

991 
u64
 
Ï¡_¡¬t
;

992 
u64
 
Ï¡_’d
;

993 
u32
 
exşusive_b™s
 = (
b™s
 & 
EXTENT_LOCKED
);

994 
gå_t
 
mask
;

996 
	`£t_gå_mask_äom_b™s
(&
b™s
, &
mask
);

997 
	`bŒfs_debug_check_ex‹Á_io_¿nge
(
Œ“
, 
¡¬t
, 
’d
);

998 
	`Œaû_bŒfs_£t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
 - s¹ + 1, 
b™s
);

1000 ià(
exşusive_b™s
)

1001 
	`ASSERT
(
çed_¡¬t
);

1003 
	`ASSERT
(
çed_¡¬t
 =ğ
NULL
 && 
çed_¡©e
 == NULL);

1004 
agaš
:

1005 ià(!
´—Îoc
) {

1013 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e
(
mask
);

1016 
	`¥š_lock
(&
Œ“
->
lock
);

1017 ià(
ÿched_¡©e
 && *cached_state) {

1018 
¡©e
 = *
ÿched_¡©e
;

1019 ià(
¡©e
->
¡¬t
 <ğ¡¬ˆ&& s‹->
’d
 > start &&

1020 
	`ex‹Á_¡©e_š_Œ“
(
¡©e
))

1021 
h™_Ãxt
;

1027 
¡©e
 = 
	`Œ“_£¬ch_fÜ_š£¹
(
Œ“
, 
¡¬t
, &
p
, &
·»Á
);

1028 ià(!
¡©e
) {

1029 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

1030 ià(!
´—Îoc
)

1031 
£¬ch_agaš
;

1032 
´—Îoc
->
¡¬t
 = start;

1033 
´—Îoc
->
’d
 =ƒnd;

1034 
	`š£¹_¡©e_ç¡
(
Œ“
, 
´—Îoc
, 
p
, 
·»Á
, 
b™s
, 
chªge£t
);

1035 
	`ÿche_¡©e
(
´—Îoc
, 
ÿched_¡©e
);

1036 
´—Îoc
 = 
NULL
;

1037 
out
;

1039 
h™_Ãxt
:

1040 
Ï¡_¡¬t
 = 
¡©e
->
¡¬t
;

1041 
Ï¡_’d
 = 
¡©e
->
’d
;

1049 ià(
¡©e
->
¡¬t
 =ğ¡¬ˆ&& s‹->
’d
 <=ƒnd) {

1050 ià(
¡©e
->¡©& 
exşusive_b™s
) {

1051 *
çed_¡¬t
 = 
¡©e
->
¡¬t
;

1052 
	`ÿche_¡©e
(
¡©e
, 
çed_¡©e
);

1053 
”r
 = -
EEXIST
;

1054 
out
;

1057 
	`£t_¡©e_b™s
(
Œ“
, 
¡©e
, 
b™s
, 
chªge£t
);

1058 
	`ÿche_¡©e
(
¡©e
, 
ÿched_¡©e
);

1059 
	`m”ge_¡©e
(
Œ“
, 
¡©e
);

1060 ià(
Ï¡_’d
 =ğ(
u64
)-1)

1061 
out
;

1062 
¡¬t
 = 
Ï¡_’d
 + 1;

1063 
¡©e
 = 
	`Ãxt_¡©e
(state);

1064 ià(
¡¬t
 < 
’d
 && 
¡©e
 && state->start == start &&

1065 !
	`Ãed_»sched
())

1066 
h™_Ãxt
;

1067 
£¬ch_agaš
;

1085 ià(
¡©e
->
¡¬t
 < start) {

1086 ià(
¡©e
->¡©& 
exşusive_b™s
) {

1087 *
çed_¡¬t
 = 
¡¬t
;

1088 
	`ÿche_¡©e
(
¡©e
, 
çed_¡©e
);

1089 
”r
 = -
EEXIST
;

1090 
out
;

1097 ià((
¡©e
->¡©& 
b™s
) == bits) {

1098 
¡¬t
 = 
¡©e
->
’d
 + 1;

1099 
	`ÿche_¡©e
(
¡©e
, 
ÿched_¡©e
);

1100 
£¬ch_agaš
;

1103 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

1104 ià(!
´—Îoc
)

1105 
£¬ch_agaš
;

1106 
”r
 = 
	`¥l™_¡©e
(
Œ“
, 
¡©e
, 
´—Îoc
, 
¡¬t
);

1107 ià(
”r
)

1108 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

1110 
´—Îoc
 = 
NULL
;

1111 ià(
”r
)

1112 
out
;

1113 ià(
¡©e
->
’d
 <=ƒnd) {

1114 
	`£t_¡©e_b™s
(
Œ“
, 
¡©e
, 
b™s
, 
chªge£t
);

1115 
	`ÿche_¡©e
(
¡©e
, 
ÿched_¡©e
);

1116 
	`m”ge_¡©e
(
Œ“
, 
¡©e
);

1117 ià(
Ï¡_’d
 =ğ(
u64
)-1)

1118 
out
;

1119 
¡¬t
 = 
Ï¡_’d
 + 1;

1120 
¡©e
 = 
	`Ãxt_¡©e
(state);

1121 ià(
¡¬t
 < 
’d
 && 
¡©e
 && state->start == start &&

1122 !
	`Ãed_»sched
())

1123 
h™_Ãxt
;

1125 
£¬ch_agaš
;

1134 ià(
¡©e
->
¡¬t
 > start) {

1135 
u64
 
this_’d
;

1136 ià(
’d
 < 
Ï¡_¡¬t
)

1137 
this_’d
 = 
’d
;

1139 
this_’d
 = 
Ï¡_¡¬t
 - 1;

1141 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

1142 ià(!
´—Îoc
)

1143 
£¬ch_agaš
;

1149 
´—Îoc
->
¡¬t
 = start;

1150 
´—Îoc
->
’d
 = 
this_’d
;

1151 
”r
 = 
	`š£¹_¡©e
(
Œ“
, 
´—Îoc
, 
b™s
, 
chªge£t
);

1152 ià(
”r
)

1153 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

1155 
	`ÿche_¡©e
(
´—Îoc
, 
ÿched_¡©e
);

1156 
´—Îoc
 = 
NULL
;

1157 
¡¬t
 = 
this_’d
 + 1;

1158 
£¬ch_agaš
;

1166 ià(
¡©e
->
¡¬t
 <ğ
’d
 && state->end >ƒnd) {

1167 ià(
¡©e
->¡©& 
exşusive_b™s
) {

1168 *
çed_¡¬t
 = 
¡¬t
;

1169 
	`ÿche_¡©e
(
¡©e
, 
çed_¡©e
);

1170 
”r
 = -
EEXIST
;

1171 
out
;

1174 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

1175 ià(!
´—Îoc
)

1176 
£¬ch_agaš
;

1177 
”r
 = 
	`¥l™_¡©e
(
Œ“
, 
¡©e
, 
´—Îoc
, 
’d
 + 1);

1178 ià(
”r
)

1179 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

1181 
	`£t_¡©e_b™s
(
Œ“
, 
´—Îoc
, 
b™s
, 
chªge£t
);

1182 
	`ÿche_¡©e
(
´—Îoc
, 
ÿched_¡©e
);

1183 
	`m”ge_¡©e
(
Œ“
, 
´—Îoc
);

1184 
´—Îoc
 = 
NULL
;

1185 
out
;

1188 
£¬ch_agaš
:

1189 ià(
¡¬t
 > 
’d
)

1190 
out
;

1191 
	`¥š_uÆock
(&
Œ“
->
lock
);

1192 ià(
	`gåæags_®low_blockšg
(
mask
))

1193 
	`cÚd_»sched
();

1194 
agaš
;

1196 
out
:

1197 
	`¥š_uÆock
(&
Œ“
->
lock
);

1198 ià(
´—Îoc
)

1199 
	`ä“_ex‹Á_¡©e
(
´—Îoc
);

1201  
”r
;

1203 
	}
}

1205 
	$£t_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

1206 
u32
 
b™s
, 
ex‹Á_¡©e
 **
ÿched_¡©e
)

1208  
	`__£t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
b™s
, 
NULL
, NULL,

1209 
ÿched_¡©e
, 
NULL
);

1210 
	}
}

1230 
	$cÚv”t_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

1231 
u32
 
b™s
, u32 
ş—r_b™s
,

1232 
ex‹Á_¡©e
 **
ÿched_¡©e
)

1234 
ex‹Á_¡©e
 *
¡©e
;

1235 
ex‹Á_¡©e
 *
´—Îoc
 = 
NULL
;

1236 
rb_node
 **
p
 = 
NULL
;

1237 
rb_node
 *
·»Á
 = 
NULL
;

1238 
”r
 = 0;

1239 
u64
 
Ï¡_¡¬t
;

1240 
u64
 
Ï¡_’d
;

1241 
boŞ
 
fœ¡_™”©iÚ
 = 
Œue
;

1243 
	`bŒfs_debug_check_ex‹Á_io_¿nge
(
Œ“
, 
¡¬t
, 
’d
);

1244 
	`Œaû_bŒfs_cÚv”t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
 - s¹ + 1, 
b™s
,

1245 
ş—r_b™s
);

1247 
agaš
:

1248 ià(!
´—Îoc
) {

1256 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e
(
GFP_NOFS
);

1257 ià(!
´—Îoc
 && !
fœ¡_™”©iÚ
)

1258  -
ENOMEM
;

1261 
	`¥š_lock
(&
Œ“
->
lock
);

1262 ià(
ÿched_¡©e
 && *cached_state) {

1263 
¡©e
 = *
ÿched_¡©e
;

1264 ià(
¡©e
->
¡¬t
 <ğ¡¬ˆ&& s‹->
’d
 > start &&

1265 
	`ex‹Á_¡©e_š_Œ“
(
¡©e
))

1266 
h™_Ãxt
;

1273 
¡©e
 = 
	`Œ“_£¬ch_fÜ_š£¹
(
Œ“
, 
¡¬t
, &
p
, &
·»Á
);

1274 ià(!
¡©e
) {

1275 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

1276 ià(!
´—Îoc
) {

1277 
”r
 = -
ENOMEM
;

1278 
out
;

1280 
´—Îoc
->
¡¬t
 = start;

1281 
´—Îoc
->
’d
 =ƒnd;

1282 
	`š£¹_¡©e_ç¡
(
Œ“
, 
´—Îoc
, 
p
, 
·»Á
, 
b™s
, 
NULL
);

1283 
	`ÿche_¡©e
(
´—Îoc
, 
ÿched_¡©e
);

1284 
´—Îoc
 = 
NULL
;

1285 
out
;

1287 
h™_Ãxt
:

1288 
Ï¡_¡¬t
 = 
¡©e
->
¡¬t
;

1289 
Ï¡_’d
 = 
¡©e
->
’d
;

1297 ià(
¡©e
->
¡¬t
 =ğ¡¬ˆ&& s‹->
’d
 <=ƒnd) {

1298 
	`£t_¡©e_b™s
(
Œ“
, 
¡©e
, 
b™s
, 
NULL
);

1299 
	`ÿche_¡©e
(
¡©e
, 
ÿched_¡©e
);

1300 
¡©e
 = 
	`ş—r_¡©e_b™
(
Œ“
, s‹, 
ş—r_b™s
, 0, 
NULL
);

1301 ià(
Ï¡_’d
 =ğ(
u64
)-1)

1302 
out
;

1303 
¡¬t
 = 
Ï¡_’d
 + 1;

1304 ià(
¡¬t
 < 
’d
 && 
¡©e
 && state->start == start &&

1305 !
	`Ãed_»sched
())

1306 
h™_Ãxt
;

1307 
£¬ch_agaš
;

1325 ià(
¡©e
->
¡¬t
 < start) {

1326 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

1327 ià(!
´—Îoc
) {

1328 
”r
 = -
ENOMEM
;

1329 
out
;

1331 
”r
 = 
	`¥l™_¡©e
(
Œ“
, 
¡©e
, 
´—Îoc
, 
¡¬t
);

1332 ià(
”r
)

1333 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

1334 
´—Îoc
 = 
NULL
;

1335 ià(
”r
)

1336 
out
;

1337 ià(
¡©e
->
’d
 <=ƒnd) {

1338 
	`£t_¡©e_b™s
(
Œ“
, 
¡©e
, 
b™s
, 
NULL
);

1339 
	`ÿche_¡©e
(
¡©e
, 
ÿched_¡©e
);

1340 
¡©e
 = 
	`ş—r_¡©e_b™
(
Œ“
, s‹, 
ş—r_b™s
, 0, 
NULL
);

1341 ià(
Ï¡_’d
 =ğ(
u64
)-1)

1342 
out
;

1343 
¡¬t
 = 
Ï¡_’d
 + 1;

1344 ià(
¡¬t
 < 
’d
 && 
¡©e
 && state->start == start &&

1345 !
	`Ãed_»sched
())

1346 
h™_Ãxt
;

1348 
£¬ch_agaš
;

1357 ià(
¡©e
->
¡¬t
 > start) {

1358 
u64
 
this_’d
;

1359 ià(
’d
 < 
Ï¡_¡¬t
)

1360 
this_’d
 = 
’d
;

1362 
this_’d
 = 
Ï¡_¡¬t
 - 1;

1364 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

1365 ià(!
´—Îoc
) {

1366 
”r
 = -
ENOMEM
;

1367 
out
;

1374 
´—Îoc
->
¡¬t
 = start;

1375 
´—Îoc
->
’d
 = 
this_’d
;

1376 
”r
 = 
	`š£¹_¡©e
(
Œ“
, 
´—Îoc
, 
b™s
, 
NULL
);

1377 ià(
”r
)

1378 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

1379 
	`ÿche_¡©e
(
´—Îoc
, 
ÿched_¡©e
);

1380 
´—Îoc
 = 
NULL
;

1381 
¡¬t
 = 
this_’d
 + 1;

1382 
£¬ch_agaš
;

1390 ià(
¡©e
->
¡¬t
 <ğ
’d
 && state->end >ƒnd) {

1391 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

1392 ià(!
´—Îoc
) {

1393 
”r
 = -
ENOMEM
;

1394 
out
;

1397 
”r
 = 
	`¥l™_¡©e
(
Œ“
, 
¡©e
, 
´—Îoc
, 
’d
 + 1);

1398 ià(
”r
)

1399 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

1401 
	`£t_¡©e_b™s
(
Œ“
, 
´—Îoc
, 
b™s
, 
NULL
);

1402 
	`ÿche_¡©e
(
´—Îoc
, 
ÿched_¡©e
);

1403 
	`ş—r_¡©e_b™
(
Œ“
, 
´—Îoc
, 
ş—r_b™s
, 0, 
NULL
);

1404 
´—Îoc
 = 
NULL
;

1405 
out
;

1408 
£¬ch_agaš
:

1409 ià(
¡¬t
 > 
’d
)

1410 
out
;

1411 
	`¥š_uÆock
(&
Œ“
->
lock
);

1412 
	`cÚd_»sched
();

1413 
fœ¡_™”©iÚ
 = 
çl£
;

1414 
agaš
;

1416 
out
:

1417 
	`¥š_uÆock
(&
Œ“
->
lock
);

1418 ià(
´—Îoc
)

1419 
	`ä“_ex‹Á_¡©e
(
´—Îoc
);

1421  
”r
;

1422 
	}
}

1439 
	$fšd_fœ¡_ş—r_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

1440 
u64
 *
¡¬t_»t
, u64 *
’d_»t
, 
u32
 
b™s
)

1442 
ex‹Á_¡©e
 *
¡©e
;

1443 
ex‹Á_¡©e
 *
´ev
 = 
NULL
, *
Ãxt
 = NULL;

1445 
	`¥š_lock
(&
Œ“
->
lock
);

1449 
¡©e
 = 
	`Œ“_£¬ch_´ev_Ãxt
(
Œ“
, 
¡¬t
, &
´ev
, &
Ãxt
);

1450 ià(!
¡©e
 && !
Ãxt
 && !
´ev
) {

1455 *
¡¬t_»t
 = 0;

1456 *
’d_»t
 = -1;

1457 
out
;

1458 } ià(!
¡©e
 && !
Ãxt
) {

1463 *
¡¬t_»t
 = 
´ev
->
’d
 + 1;

1464 *
’d_»t
 = -1;

1465 
out
;

1466 } ià(!
¡©e
) {

1467 
¡©e
 = 
Ãxt
;

1474 ià(
	`š_¿nge
(
¡¬t
, 
¡©e
->¡¬t, s‹->
’d
 - state->start + 1)) {

1475 ià(
¡©e
->¡©& 
b™s
) {

1481 
¡¬t
 = 
¡©e
->
’d
 + 1;

1492 *
¡¬t_»t
 = 
¡©e
->
¡¬t
;

1507 ià(
´ev
)

1508 *
¡¬t_»t
 = 
´ev
->
’d
 + 1;

1510 *
¡¬t_»t
 = 0;

1519 
¡©e
) {

1520 ià(
¡©e
->
’d
 >ğ
¡¬t
 && !(¡©e->¡©& 
b™s
)) {

1521 *
’d_»t
 = 
¡©e
->
’d
;

1523 *
’d_»t
 = 
¡©e
->
¡¬t
 - 1;

1526 
¡©e
 = 
	`Ãxt_¡©e
(state);

1528 
out
:

1529 
	`¥š_uÆock
(&
Œ“
->
lock
);

1530 
	}
}

1557 
u64
 
	$couÁ_¿nge_b™s
(
ex‹Á_io_Œ“
 *
Œ“
,

1558 
u64
 *
¡¬t
, u64 
£¬ch_’d
, u64 
max_by‹s
,

1559 
u32
 
b™s
, 
cÚtig
,

1560 
ex‹Á_¡©e
 **
ÿched_¡©e
)

1562 
ex‹Á_¡©e
 *
¡©e
 = 
NULL
;

1563 
ex‹Á_¡©e
 *
ÿched
;

1564 
u64
 
cur_¡¬t
 = *
¡¬t
;

1565 
u64
 
tÙ®_by‹s
 = 0;

1566 
u64
 
Ï¡
 = 0;

1567 
found
 = 0;

1569 ià(
	`WARN_ON
(
£¬ch_’d
 < 
cur_¡¬t
))

1572 
	`¥š_lock
(&
Œ“
->
lock
);

1574 ià(!
ÿched_¡©e
 || !*cached_state)

1575 
£¬ch
;

1577 
ÿched
 = *
ÿched_¡©e
;

1579 ià(!
	`ex‹Á_¡©e_š_Œ“
(
ÿched
))

1580 
£¬ch
;

1582 ià(
ÿched
->
¡¬t
 <ğ
cur_¡¬t
 && cur_¡¬ˆ<ğÿched->
’d
) {

1583 
¡©e
 = 
ÿched
;

1584 } ià(
ÿched
->
¡¬t
 > 
cur_¡¬t
) {

1585 
ex‹Á_¡©e
 *
´ev
;

1594 
´ev
 = 
	`´ev_¡©e
(
ÿched
);

1595 ià(!
´ev
)

1596 
¡©e
 = 
ÿched
;

1597 ià(
´ev
->
¡¬t
 <ğ
cur_¡¬t
 && cur_¡¬ˆ<ğ´ev->
’d
)

1598 
¡©e
 = 
´ev
;

1605 
£¬ch
:

1606 ià(!
¡©e
)

1607 
¡©e
 = 
	`Œ“_£¬ch
(
Œ“
, 
cur_¡¬t
);

1609 
¡©e
) {

1610 ià(
¡©e
->
¡¬t
 > 
£¬ch_’d
)

1612 ià(
cÚtig
 && 
found
 && 
¡©e
->
¡¬t
 > 
Ï¡
 + 1)

1614 ià(
¡©e
->
’d
 >ğ
cur_¡¬t
 && (¡©e->¡©& 
b™s
) == bits) {

1615 
tÙ®_by‹s
 +ğ
	`mš
(
£¬ch_’d
, 
¡©e
->
’d
) + 1 -

1616 
	`max
(
cur_¡¬t
, 
¡©e
->
¡¬t
);

1617 ià(
tÙ®_by‹s
 >ğ
max_by‹s
)

1619 ià(!
found
) {

1620 *
¡¬t
 = 
	`max
(
cur_¡¬t
, 
¡©e
->start);

1621 
found
 = 1;

1623 
Ï¡
 = 
¡©e
->
’d
;

1624 } ià(
cÚtig
 && 
found
) {

1627 
¡©e
 = 
	`Ãxt_¡©e
(state);

1630 ià(
ÿched_¡©e
) {

1631 
	`ä“_ex‹Á_¡©e
(*
ÿched_¡©e
);

1632 *
ÿched_¡©e
 = 
¡©e
;

1633 ià(
¡©e
)

1634 
	`»fcouÁ_šc
(&
¡©e
->
»fs
);

1637 
	`¥š_uÆock
(&
Œ“
->
lock
);

1639  
tÙ®_by‹s
;

1640 
	}
}

1647 
	$‹¡_¿nge_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

1648 
u32
 
b™s
, 
fËd
, 
ex‹Á_¡©e
 *
ÿched
)

1650 
ex‹Á_¡©e
 *
¡©e
 = 
NULL
;

1651 
b™£t
 = 0;

1653 
	`¥š_lock
(&
Œ“
->
lock
);

1654 ià(
ÿched
 && 
	`ex‹Á_¡©e_š_Œ“
(ÿchedè&& cached->
¡¬t
 <= start &&

1655 
ÿched
->
’d
 > 
¡¬t
)

1656 
¡©e
 = 
ÿched
;

1658 
¡©e
 = 
	`Œ“_£¬ch
(
Œ“
, 
¡¬t
);

1659 
¡©e
 && 
¡¬t
 <ğ
’d
) {

1660 ià(
fËd
 && 
¡©e
->
¡¬t
 > start) {

1661 
b™£t
 = 0;

1665 ià(
¡©e
->
¡¬t
 > 
’d
)

1668 ià(
¡©e
->¡©& 
b™s
) {

1669 
b™£t
 = 1;

1670 ià(!
fËd
)

1672 } ià(
fËd
) {

1673 
b™£t
 = 0;

1677 ià(
¡©e
->
’d
 =ğ(
u64
)-1)

1680 
¡¬t
 = 
¡©e
->
’d
 + 1;

1681 ià(
¡¬t
 > 
’d
)

1683 
¡©e
 = 
	`Ãxt_¡©e
(state);

1687 ià(
fËd
 && !
¡©e
)

1688 
b™£t
 = 0;

1689 
	`¥š_uÆock
(&
Œ“
->
lock
);

1690  
b™£t
;

1691 
	}
}

1694 
	$£t_»cÜd_ex‹Á_b™s
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

1695 
u32
 
b™s
, 
ex‹Á_chªge£t
 *
chªge£t
)

1703 
	`ASSERT
(!(
b™s
 & 
EXTENT_LOCKED
));

1705  
	`__£t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
b™s
, 
NULL
, NULL, NULL, 
chªge£t
);

1706 
	}
}

1708 
	$ş—r_»cÜd_ex‹Á_b™s
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

1709 
u32
 
b™s
, 
ex‹Á_chªge£t
 *
chªge£t
)

1715 
	`ASSERT
(!(
b™s
 & 
EXTENT_LOCKED
));

1717  
	`__ş—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
b™s
, 
NULL
, 
chªge£t
);

1718 
	}
}

1720 
	$Œy_lock_ex‹Á
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

1721 
ex‹Á_¡©e
 **
ÿched
)

1723 
”r
;

1724 
u64
 
çed_¡¬t
;

1726 
”r
 = 
	`__£t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
EXTENT_LOCKED
, &
çed_¡¬t
,

1727 
NULL
, 
ÿched
, NULL);

1728 ià(
”r
 =ğ-
EEXIST
) {

1729 ià(
çed_¡¬t
 > 
¡¬t
)

1730 
	`ş—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
çed_¡¬t
 - 1,

1731 
EXTENT_LOCKED
, 
ÿched
);

1735 
	}
}

1741 
	$lock_ex‹Á
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

1742 
ex‹Á_¡©e
 **
ÿched_¡©e
)

1744 
ex‹Á_¡©e
 *
çed_¡©e
 = 
NULL
;

1745 
”r
;

1746 
u64
 
çed_¡¬t
;

1748 
”r
 = 
	`__£t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
EXTENT_LOCKED
, &
çed_¡¬t
,

1749 &
çed_¡©e
, 
ÿched_¡©e
, 
NULL
);

1750 
”r
 =ğ-
EEXIST
) {

1751 ià(
çed_¡¬t
 !ğ
¡¬t
)

1752 
	`ş—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
çed_¡¬t
 - 1,

1753 
EXTENT_LOCKED
, 
ÿched_¡©e
);

1755 
	`wa™_ex‹Á_b™
(
Œ“
, 
çed_¡¬t
, 
’d
, 
EXTENT_LOCKED
,

1756 &
çed_¡©e
);

1757 
”r
 = 
	`__£t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
EXTENT_LOCKED
,

1758 &
çed_¡¬t
, &
çed_¡©e
,

1759 
ÿched_¡©e
, 
NULL
);

1761  
”r
;

1762 
	}
}

1764 
__cŞd
 
	$ex‹Á_¡©e_ä“_ÿch•
()

1766 
	`bŒfs_ex‹Á_¡©e_Ëak_debug_check
();

1767 
	`kmem_ÿche_de¡roy
(
ex‹Á_¡©e_ÿche
);

1768 
	}
}

1770 
__š™
 
	$ex‹Á_¡©e_š™_ÿch•
()

1772 
ex‹Á_¡©e_ÿche
 = 
	`kmem_ÿche_ü—‹
("btrfs_extent_state",

1773 (
ex‹Á_¡©e
), 0,

1774 
SLAB_MEM_SPREAD
, 
NULL
);

1775 ià(!
ex‹Á_¡©e_ÿche
)

1776  -
ENOMEM
;

1779 
	}
}

	@extent-io-tree.h

3 #iâdeà
BTRFS_EXTENT_IO_TREE_H


4 
	#BTRFS_EXTENT_IO_TREE_H


	)

6 
	~"misc.h
"

8 
	gex‹Á_chªge£t
;

12 
ENUM_BIT
(
EXTENT_DIRTY
),

13 
ENUM_BIT
(
EXTENT_UPTODATE
),

14 
ENUM_BIT
(
EXTENT_LOCKED
),

15 
ENUM_BIT
(
EXTENT_NEW
),

16 
ENUM_BIT
(
EXTENT_DELALLOC
),

17 
ENUM_BIT
(
EXTENT_DEFRAG
),

18 
ENUM_BIT
(
EXTENT_BOUNDARY
),

19 
ENUM_BIT
(
EXTENT_NODATASUM
),

20 
ENUM_BIT
(
EXTENT_CLEAR_META_RESV
),

21 
ENUM_BIT
(
EXTENT_NEED_WAIT
),

22 
ENUM_BIT
(
EXTENT_NORESERVE
),

23 
ENUM_BIT
(
EXTENT_QGROUP_RESERVED
),

24 
ENUM_BIT
(
EXTENT_CLEAR_DATA_RESV
),

32 
ENUM_BIT
(
EXTENT_DELALLOC_NEW
),

40 
ENUM_BIT
(
EXTENT_ADD_INODE_BYTES
),

45 
ENUM_BIT
(
EXTENT_CLEAR_ALL_BITS
),

54 
ENUM_BIT
(
EXTENT_NOWAIT
)

57 
	#EXTENT_DO_ACCOUNTING
 (
EXTENT_CLEAR_META_RESV
 | \

58 
EXTENT_CLEAR_DATA_RESV
)

	)

59 
	#EXTENT_CTLBITS
 (
EXTENT_DO_ACCOUNTING
 | \

60 
EXTENT_ADD_INODE_BYTES
 | \

61 
EXTENT_CLEAR_ALL_BITS
)

	)

69 
	#CHUNK_ALLOCATED
 
EXTENT_DIRTY


	)

70 
	#CHUNK_TRIMMED
 
EXTENT_DEFRAG


	)

71 
	#CHUNK_STATE_MASK
 (
CHUNK_ALLOCATED
 | \

72 
CHUNK_TRIMMED
)

	)

75 
	mIO_TREE_FS_PINNED_EXTENTS
,

76 
	mIO_TREE_FS_EXCLUDED_EXTENTS
,

77 
	mIO_TREE_BTREE_INODE_IO
,

78 
	mIO_TREE_INODE_IO
,

79 
	mIO_TREE_RELOC_BLOCKS
,

80 
	mIO_TREE_TRANS_DIRTY_PAGES
,

81 
	mIO_TREE_ROOT_DIRTY_LOG_PAGES
,

82 
	mIO_TREE_INODE_FILE_EXTENT
,

83 
	mIO_TREE_LOG_CSUM_RANGE
,

84 
	mIO_TREE_SELFTEST
,

85 
	mIO_TREE_DEVICE_ALLOC_STATE
,

88 
	sex‹Á_io_Œ“
 {

89 
rb_roÙ
 
	m¡©e
;

90 
bŒfs_fs_šfo
 *
	mfs_šfo
;

92 
bŒfs_šode
 *
	mšode
;

95 
u8
 
	mowÃr
;

97 
¥šlock_t
 
	mlock
;

100 
	sex‹Á_¡©e
 {

101 
u64
 
	m¡¬t
;

102 
u64
 
	m’d
;

103 
rb_node
 
	mrb_node
;

106 
wa™_queue_h—d_t
 
	mwq
;

107 
»fcouÁ_t
 
	m»fs
;

108 
u32
 
	m¡©e
;

110 #ifdeà
CONFIG_BTRFS_DEBUG


111 
li¡_h—d
 
	mËak_li¡
;

115 
ex‹Á_io_Œ“_š™
(
bŒfs_fs_šfo
 *
fs_šfo
,

116 
ex‹Á_io_Œ“
 *
Œ“
, 
owÃr
);

117 
ex‹Á_io_Œ“_»Ëa£
(
ex‹Á_io_Œ“
 *
Œ“
);

119 
lock_ex‹Á
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

120 
ex‹Á_¡©e
 **
ÿched
);

122 
Œy_lock_ex‹Á
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

123 
ex‹Á_¡©e
 **
ÿched
);

125 
__š™
 
ex‹Á_¡©e_š™_ÿch•
();

126 
__cŞd
 
ex‹Á_¡©e_ä“_ÿch•
();

128 
u64
 
couÁ_¿nge_b™s
(
ex‹Á_io_Œ“
 *
Œ“
,

129 
u64
 *
¡¬t
, u64 
£¬ch_’d
,

130 
u64
 
max_by‹s
, 
u32
 
b™s
, 
cÚtig
,

131 
ex‹Á_¡©e
 **
ÿched_¡©e
);

133 
ä“_ex‹Á_¡©e
(
ex‹Á_¡©e
 *
¡©e
);

134 
‹¡_¿nge_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

135 
u32
 
b™s
, 
fËd
, 
ex‹Á_¡©e
 *
ÿched_¡©e
);

136 
ş—r_»cÜd_ex‹Á_b™s
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

137 
u32
 
b™s
, 
ex‹Á_chªge£t
 *
chªge£t
);

138 
__ş—r_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

139 
u32
 
b™s
, 
ex‹Á_¡©e
 **
ÿched
,

140 
ex‹Á_chªge£t
 *
chªge£t
);

142 
šlše
 
	$ş—r_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

143 
u64
 
’d
, 
u32
 
b™s
,

144 
ex‹Á_¡©e
 **
ÿched
)

146  
	`__ş—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
b™s
, 
ÿched
, 
NULL
);

147 
	}
}

149 
šlše
 
	$uÆock_ex‹Á
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

150 
ex‹Á_¡©e
 **
ÿched
)

152  
	`__ş—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
EXTENT_LOCKED
, 
ÿched
, 
NULL
);

153 
	}
}

155 
šlše
 
	$ş—r_ex‹Á_b™s
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

156 
u64
 
’d
, 
u32
 
b™s
)

158  
	`ş—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
b™s
, 
NULL
);

159 
	}
}

161 
£t_»cÜd_ex‹Á_b™s
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

162 
u32
 
b™s
, 
ex‹Á_chªge£t
 *
chªge£t
);

163 
£t_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

164 
u32
 
b™s
, 
ex‹Á_¡©e
 **
ÿched_¡©e
);

166 
šlše
 
	$ş—r_ex‹Á_u±od©e
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

167 
u64
 
’d
, 
ex‹Á_¡©e
 **
ÿched_¡©e
)

169  
	`__ş—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
EXTENT_UPTODATE
,

170 
ÿched_¡©e
, 
NULL
);

171 
	}
}

173 
šlše
 
	$ş—r_ex‹Á_dœty
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

174 
u64
 
’d
, 
ex‹Á_¡©e
 **
ÿched
)

176  
	`ş—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
,

177 
EXTENT_DIRTY
 | 
EXTENT_DELALLOC
 |

178 
EXTENT_DO_ACCOUNTING
, 
ÿched
);

179 
	}
}

181 
cÚv”t_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

182 
u32
 
b™s
, u32 
ş—r_b™s
,

183 
ex‹Á_¡©e
 **
ÿched_¡©e
);

185 
boŞ
 
fšd_fœ¡_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

186 
u64
 *
¡¬t_»t
, u64 *
’d_»t
, 
u32
 
b™s
,

187 
ex‹Á_¡©e
 **
ÿched_¡©e
);

188 
fšd_fœ¡_ş—r_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

189 
u64
 *
¡¬t_»t
, u64 *
’d_»t
, 
u32
 
b™s
);

190 
fšd_cÚtiguous_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

191 
u64
 *
¡¬t_»t
, u64 *
’d_»t
, 
u32
 
b™s
);

192 
boŞ
 
bŒfs_fšd_d–®loc_¿nge
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 *
¡¬t
,

193 
u64
 *
’d
, u64 
max_by‹s
,

194 
ex‹Á_¡©e
 **
ÿched_¡©e
);

195 
wa™_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
, 
u32
 
b™s
,

196 
ex‹Á_¡©e
 **
ÿched_¡©e
);

	@extent-tree.c

6 
	~<lšux/sched.h
>

7 
	~<lšux/sched/sigÇl.h
>

8 
	~<lšux/·gem­.h
>

9 
	~<lšux/wr™eback.h
>

10 
	~<lšux/blkdev.h
>

11 
	~<lšux/sÜt.h
>

12 
	~<lšux/rcupd©e.h
>

13 
	~<lšux/kth»ad.h
>

14 
	~<lšux/¦ab.h
>

15 
	~<lšux/¿‹lim™.h
>

16 
	~<lšux/³rıu_couÁ”.h
>

17 
	~<lšux/lockd•.h
>

18 
	~<lšux/üc32c.h
>

19 
	~"ù»e.h
"

20 
	~"ex‹Á-Œ“.h
"

21 
	~"Œ“-log.h
"

22 
	~"disk-io.h
"

23 
	~"´št-Œ“.h
"

24 
	~"vŞumes.h
"

25 
	~"¿id56.h
"

26 
	~"lockšg.h
"

27 
	~"ä“-¥aû-ÿche.h
"

28 
	~"ä“-¥aû-Œ“.h
"

29 
	~"sysfs.h
"

30 
	~"qgroup.h
"

31 
	~"»f-v”ify.h
"

32 
	~"¥aû-šfo.h
"

33 
	~"block-rsv.h
"

34 
	~"d–®loc-¥aû.h
"

35 
	~"disÿrd.h
"

36 
	~"rcu-¡ršg.h
"

37 
	~"zÚed.h
"

38 
	~"dev-»¶aû.h
"

39 
	~"fs.h
"

40 
	~"acûssÜs.h
"

41 
	~"roÙ-Œ“.h
"

42 
	~"fe-™em.h
"

43 
	~"Üphª.h
"

44 
	~"Œ“-check”.h
"

46 #undeà
SCRAMBLE_DELAYED_REFS


49 
__bŒfs_ä“_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

50 
bŒfs_d–ayed_»f_node
 *
node
, 
u64
 
·»Á
,

51 
u64
 
roÙ_objeùid
, u64 
owÃr_objeùid
,

52 
u64
 
owÃr_off£t
, 
»fs_to_drİ
,

53 
bŒfs_d–ayed_ex‹Á_İ
 *
exŒa_İ
);

54 
__run_d–ayed_ex‹Á_İ
(
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
,

55 
ex‹Á_bufãr
 *
Ëaf
,

56 
bŒfs_ex‹Á_™em
 *
ei
);

57 
®loc_»£rved_fe_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

58 
u64
 
·»Á
, u64 
roÙ_objeùid
,

59 
u64
 
æags
, u64 
owÃr
, u64 
off£t
,

60 
bŒfs_key
 *
šs
, 
»f_mod
);

61 
®loc_»£rved_Œ“_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

62 
bŒfs_d–ayed_»f_node
 *
node
,

63 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
);

64 
fšd_Ãxt_key
(
bŒfs_·th
 *
·th
, 
Ëv–
,

65 
bŒfs_key
 *
key
);

67 
	$block_group_b™s
(
bŒfs_block_group
 *
ÿche
, 
u64
 
b™s
)

69  (
ÿche
->
æags
 & 
b™s
) == bits;

70 
	}
}

73 
	$bŒfs_lookup_d©a_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
, u64 
Ën
)

75 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 
¡¬t
);

76 
»t
;

77 
bŒfs_key
 
key
;

78 
bŒfs_·th
 *
·th
;

80 
·th
 = 
	`bŒfs_®loc_·th
();

81 ià(!
·th
)

82  -
ENOMEM
;

84 
key
.
objeùid
 = 
¡¬t
;

85 
key
.
off£t
 = 
Ën
;

86 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

87 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

88 
	`bŒfs_ä“_·th
(
·th
);

89  
»t
;

90 
	}
}

101 
	$bŒfs_lookup_ex‹Á_šfo
(
bŒfs_Œªs_hªdË
 *
Œªs
,

102 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

103 
u64
 
off£t
, 
m‘ad©a
, u64 *
»fs
, u64 *
æags
)

105 
bŒfs_roÙ
 *
ex‹Á_roÙ
;

106 
bŒfs_d–ayed_»f_h—d
 *
h—d
;

107 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

108 
bŒfs_·th
 *
·th
;

109 
bŒfs_ex‹Á_™em
 *
ei
;

110 
ex‹Á_bufãr
 *
Ëaf
;

111 
bŒfs_key
 
key
;

112 
u32
 
™em_size
;

113 
u64
 
num_»fs
;

114 
u64
 
ex‹Á_æags
;

115 
»t
;

121 ià(
m‘ad©a
 && !
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
)) {

122 
off£t
 = 
fs_šfo
->
nodesize
;

123 
m‘ad©a
 = 0;

126 
·th
 = 
	`bŒfs_®loc_·th
();

127 ià(!
·th
)

128  -
ENOMEM
;

130 ià(!
Œªs
) {

131 
·th
->
sk_lockšg
 = 1;

132 
·th
->
£¬ch_comm™_roÙ
 = 1;

135 
£¬ch_agaš
:

136 
key
.
objeùid
 = 
by‹Ä
;

137 
key
.
off£t
 = offset;

138 ià(
m‘ad©a
)

139 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

141 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

143 
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 
by‹Ä
);

144 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
ex‹Á_roÙ
, &
key
, 
·th
, 0, 0);

145 ià(
»t
 < 0)

146 
out_ä“
;

148 ià(
»t
 > 0 && 
m‘ad©a
 && 
key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
) {

149 ià(
·th
->
¦Ùs
[0]) {

150 
·th
->
¦Ùs
[0]--;

151 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,

152 
·th
->
¦Ùs
[0]);

153 ià(
key
.
objeùid
 =ğ
by‹Ä
 &&

154 
key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 &&

155 
key
.
off£t
 =ğ
fs_šfo
->
nodesize
)

156 
»t
 = 0;

160 ià(
»t
 == 0) {

161 
Ëaf
 = 
·th
->
nodes
[0];

162 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

163 ià(
™em_size
 >ğ(*
ei
)) {

164 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

165 
bŒfs_ex‹Á_™em
);

166 
num_»fs
 = 
	`bŒfs_ex‹Á_»fs
(
Ëaf
, 
ei
);

167 
ex‹Á_æags
 = 
	`bŒfs_ex‹Á_æags
(
Ëaf
, 
ei
);

169 
»t
 = -
EUCLEAN
;

170 
	`bŒfs_”r
(
fs_šfo
,

172 
™em_size
, (*
ei
));

173 ià(
Œªs
)

174 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

176 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
, 
NULL
);

178 
out_ä“
;

181 
	`BUG_ON
(
num_»fs
 == 0);

183 
num_»fs
 = 0;

184 
ex‹Á_æags
 = 0;

185 
»t
 = 0;

188 ià(!
Œªs
)

189 
out
;

191 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

192 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

193 
h—d
 = 
	`bŒfs_fšd_d–ayed_»f_h—d
(
d–ayed_»fs
, 
by‹Ä
);

194 ià(
h—d
) {

195 ià(!
	`mu‹x_Œylock
(&
h—d
->
mu‹x
)) {

196 
	`»fcouÁ_šc
(&
h—d
->
»fs
);

197 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

199 
	`bŒfs_»Ëa£_·th
(
·th
);

205 
	`mu‹x_lock
(&
h—d
->
mu‹x
);

206 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

207 
	`bŒfs_put_d–ayed_»f_h—d
(
h—d
);

208 
£¬ch_agaš
;

210 
	`¥š_lock
(&
h—d
->
lock
);

211 ià(
h—d
->
ex‹Á_İ
 && h—d->ex‹Á_İ->
upd©e_æags
)

212 
ex‹Á_æags
 |ğ
h—d
->
ex‹Á_İ
->
æags_to_£t
;

214 
	`BUG_ON
(
num_»fs
 == 0);

216 
num_»fs
 +ğ
h—d
->
»f_mod
;

217 
	`¥š_uÆock
(&
h—d
->
lock
);

218 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

220 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

221 
out
:

222 
	`WARN_ON
(
num_»fs
 == 0);

223 ià(
»fs
)

224 *
»fs
 = 
num_»fs
;

225 ià(
æags
)

226 *
æags
 = 
ex‹Á_æags
;

227 
out_ä“
:

228 
	`bŒfs_ä“_·th
(
·th
);

229  
»t
;

230 
	}
}

343 
	$bŒfs_g‘_ex‹Á_šlše_»f_ty³
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

344 
bŒfs_ex‹Á_šlše_»f
 *
œef
,

345 
bŒfs_šlše_»f_ty³
 
is_d©a
)

347 
ty³
 = 
	`bŒfs_ex‹Á_šlše_»f_ty³
(
eb
, 
œef
);

348 
u64
 
off£t
 = 
	`bŒfs_ex‹Á_šlše_»f_off£t
(
eb
, 
œef
);

350 ià(
ty³
 =ğ
BTRFS_TREE_BLOCK_REF_KEY
 ||

351 
ty³
 =ğ
BTRFS_SHARED_BLOCK_REF_KEY
 ||

352 
ty³
 =ğ
BTRFS_SHARED_DATA_REF_KEY
 ||

353 
ty³
 =ğ
BTRFS_EXTENT_DATA_REF_KEY
) {

354 ià(
is_d©a
 =ğ
BTRFS_REF_TYPE_BLOCK
) {

355 ià(
ty³
 =ğ
BTRFS_TREE_BLOCK_REF_KEY
)

356  
ty³
;

357 ià(
ty³
 =ğ
BTRFS_SHARED_BLOCK_REF_KEY
) {

358 
	`ASSERT
(
eb
->
fs_šfo
);

363 ià(
off£t
 &&

364 
	`IS_ALIGNED
(
off£t
, 
eb
->
fs_šfo
->
£ùÜsize
))

365  
ty³
;

367 } ià(
is_d©a
 =ğ
BTRFS_REF_TYPE_DATA
) {

368 ià(
ty³
 =ğ
BTRFS_EXTENT_DATA_REF_KEY
)

369  
ty³
;

370 ià(
ty³
 =ğ
BTRFS_SHARED_DATA_REF_KEY
) {

371 
	`ASSERT
(
eb
->
fs_šfo
);

376 ià(
off£t
 &&

377 
	`IS_ALIGNED
(
off£t
, 
eb
->
fs_šfo
->
£ùÜsize
))

378  
ty³
;

381 
	`ASSERT
(
is_d©a
 =ğ
BTRFS_REF_TYPE_ANY
);

382  
ty³
;

386 
	`WARN_ON
(1);

387 
	`bŒfs_´št_Ëaf
(
eb
);

388 
	`bŒfs_”r
(
eb
->
fs_šfo
,

390 
eb
->
¡¬t
, ()
œef
, 
ty³
);

392  
BTRFS_REF_TYPE_INVALID
;

393 
	}
}

395 
u64
 
	$hash_ex‹Á_d©a_»f
(
u64
 
roÙ_objeùid
, u64 
owÃr
, u64 
off£t
)

397 
u32
 
high_üc
 = ~(u32)0;

398 
u32
 
low_üc
 = ~(u32)0;

399 
__Ë64
 
Ënum
;

401 
Ënum
 = 
	`ıu_to_Ë64
(
roÙ_objeùid
);

402 
high_üc
 = 
	`bŒfs_üc32c
(high_üc, &
Ënum
, (lenum));

403 
Ënum
 = 
	`ıu_to_Ë64
(
owÃr
);

404 
low_üc
 = 
	`bŒfs_üc32c
Öow_üc, &
Ënum
, (lenum));

405 
Ënum
 = 
	`ıu_to_Ë64
(
off£t
);

406 
low_üc
 = 
	`bŒfs_üc32c
Öow_üc, &
Ënum
, (lenum));

408  ((
u64
)
high_üc
 << 31è^ (u64)
low_üc
;

409 
	}
}

411 
u64
 
	$hash_ex‹Á_d©a_»f_™em
(
ex‹Á_bufãr
 *
Ëaf
,

412 
bŒfs_ex‹Á_d©a_»f
 *
»f
)

414  
	`hash_ex‹Á_d©a_»f
(
	`bŒfs_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
»f
),

415 
	`bŒfs_ex‹Á_d©a_»f_objeùid
(
Ëaf
, 
»f
),

416 
	`bŒfs_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
»f
));

417 
	}
}

419 
	$m©ch_ex‹Á_d©a_»f
(
ex‹Á_bufãr
 *
Ëaf
,

420 
bŒfs_ex‹Á_d©a_»f
 *
»f
,

421 
u64
 
roÙ_objeùid
, u64 
owÃr
, u64 
off£t
)

423 ià(
	`bŒfs_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
»f
è!ğ
roÙ_objeùid
 ||

424 
	`bŒfs_ex‹Á_d©a_»f_objeùid
(
Ëaf
, 
»f
è!ğ
owÃr
 ||

425 
	`bŒfs_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
»f
è!ğ
off£t
)

428 
	}
}

430 
nošlše
 
	$lookup_ex‹Á_d©a_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

431 
bŒfs_·th
 *
·th
,

432 
u64
 
by‹Ä
, u64 
·»Á
,

433 
u64
 
roÙ_objeùid
,

434 
u64
 
owÃr
, u64 
off£t
)

436 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
Œªs
->
fs_šfo
, 
by‹Ä
);

437 
bŒfs_key
 
key
;

438 
bŒfs_ex‹Á_d©a_»f
 *
»f
;

439 
ex‹Á_bufãr
 *
Ëaf
;

440 
u32
 
Ä™ems
;

441 
»t
;

442 
»cow
;

443 
”r
 = -
ENOENT
;

445 
key
.
objeùid
 = 
by‹Ä
;

446 ià(
·»Á
) {

447 
key
.
ty³
 = 
BTRFS_SHARED_DATA_REF_KEY
;

448 
key
.
off£t
 = 
·»Á
;

450 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_REF_KEY
;

451 
key
.
off£t
 = 
	`hash_ex‹Á_d©a_»f
(
roÙ_objeùid
,

452 
owÃr
, 
off£t
);

454 
agaš
:

455 
»cow
 = 0;

456 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

457 ià(
»t
 < 0) {

458 
”r
 = 
»t
;

459 
ç
;

462 ià(
·»Á
) {

463 ià(!
»t
)

465 
ç
;

468 
Ëaf
 = 
·th
->
nodes
[0];

469 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

471 ià(
·th
->
¦Ùs
[0] >ğ
Ä™ems
) {

472 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

473 ià(
»t
 < 0)

474 
”r
 = 
»t
;

475 ià(
»t
)

476 
ç
;

478 
Ëaf
 = 
·th
->
nodes
[0];

479 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

480 
»cow
 = 1;

483 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

484 ià(
key
.
objeùid
 !ğ
by‹Ä
 ||

485 
key
.
ty³
 !ğ
BTRFS_EXTENT_DATA_REF_KEY
)

486 
ç
;

488 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

489 
bŒfs_ex‹Á_d©a_»f
);

491 ià(
	`m©ch_ex‹Á_d©a_»f
(
Ëaf
, 
»f
, 
roÙ_objeùid
,

492 
owÃr
, 
off£t
)) {

493 ià(
»cow
) {

494 
	`bŒfs_»Ëa£_·th
(
·th
);

495 
agaš
;

497 
”r
 = 0;

500 
·th
->
¦Ùs
[0]++;

502 
ç
:

503  
”r
;

504 
	}
}

506 
nošlše
 
	$š£¹_ex‹Á_d©a_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

507 
bŒfs_·th
 *
·th
,

508 
u64
 
by‹Ä
, u64 
·»Á
,

509 
u64
 
roÙ_objeùid
, u64 
owÃr
,

510 
u64
 
off£t
, 
»fs_to_add
)

512 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
Œªs
->
fs_šfo
, 
by‹Ä
);

513 
bŒfs_key
 
key
;

514 
ex‹Á_bufãr
 *
Ëaf
;

515 
u32
 
size
;

516 
u32
 
num_»fs
;

517 
»t
;

519 
key
.
objeùid
 = 
by‹Ä
;

520 ià(
·»Á
) {

521 
key
.
ty³
 = 
BTRFS_SHARED_DATA_REF_KEY
;

522 
key
.
off£t
 = 
·»Á
;

523 
size
 = (
bŒfs_sh¬ed_d©a_»f
);

525 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_REF_KEY
;

526 
key
.
off£t
 = 
	`hash_ex‹Á_d©a_»f
(
roÙ_objeùid
,

527 
owÃr
, 
off£t
);

528 
size
 = (
bŒfs_ex‹Á_d©a_»f
);

531 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 
size
);

532 ià(
»t
 &&„‘ !ğ-
EEXIST
)

533 
ç
;

535 
Ëaf
 = 
·th
->
nodes
[0];

536 ià(
·»Á
) {

537 
bŒfs_sh¬ed_d©a_»f
 *
»f
;

538 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

539 
bŒfs_sh¬ed_d©a_»f
);

540 ià(
»t
 == 0) {

541 
	`bŒfs_£t_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
»f
, 
»fs_to_add
);

543 
num_»fs
 = 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
»f
);

544 
num_»fs
 +ğ
»fs_to_add
;

545 
	`bŒfs_£t_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
»f
, 
num_»fs
);

548 
bŒfs_ex‹Á_d©a_»f
 *
»f
;

549 
»t
 =ğ-
EEXIST
) {

550 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

551 
bŒfs_ex‹Á_d©a_»f
);

552 ià(
	`m©ch_ex‹Á_d©a_»f
(
Ëaf
, 
»f
, 
roÙ_objeùid
,

553 
owÃr
, 
off£t
))

555 
	`bŒfs_»Ëa£_·th
(
·th
);

556 
key
.
off£t
++;

557 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

558 
size
);

559 ià(
»t
 &&„‘ !ğ-
EEXIST
)

560 
ç
;

562 
Ëaf
 = 
·th
->
nodes
[0];

564 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

565 
bŒfs_ex‹Á_d©a_»f
);

566 ià(
»t
 == 0) {

567 
	`bŒfs_£t_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
»f
,

568 
roÙ_objeùid
);

569 
	`bŒfs_£t_ex‹Á_d©a_»f_objeùid
(
Ëaf
, 
»f
, 
owÃr
);

570 
	`bŒfs_£t_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
»f
, 
off£t
);

571 
	`bŒfs_£t_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f
, 
»fs_to_add
);

573 
num_»fs
 = 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f
);

574 
num_»fs
 +ğ
»fs_to_add
;

575 
	`bŒfs_£t_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f
, 
num_»fs
);

578 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

579 
»t
 = 0;

580 
ç
:

581 
	`bŒfs_»Ëa£_·th
(
·th
);

582  
»t
;

583 
	}
}

585 
nošlše
 
	$»move_ex‹Á_d©a_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

586 
bŒfs_roÙ
 *
roÙ
,

587 
bŒfs_·th
 *
·th
,

588 
»fs_to_drİ
)

590 
bŒfs_key
 
key
;

591 
bŒfs_ex‹Á_d©a_»f
 *
»f1
 = 
NULL
;

592 
bŒfs_sh¬ed_d©a_»f
 *
»f2
 = 
NULL
;

593 
ex‹Á_bufãr
 *
Ëaf
;

594 
u32
 
num_»fs
 = 0;

595 
»t
 = 0;

597 
Ëaf
 = 
·th
->
nodes
[0];

598 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

600 ià(
key
.
ty³
 =ğ
BTRFS_EXTENT_DATA_REF_KEY
) {

601 
»f1
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

602 
bŒfs_ex‹Á_d©a_»f
);

603 
num_»fs
 = 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f1
);

604 } ià(
key
.
ty³
 =ğ
BTRFS_SHARED_DATA_REF_KEY
) {

605 
»f2
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

606 
bŒfs_sh¬ed_d©a_»f
);

607 
num_»fs
 = 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
»f2
);

609 
	`bŒfs_”r
(
Œªs
->
fs_šfo
,

611 
key
.
objeùid
, key.
ty³
, key.
off£t
);

612 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, -
EUCLEAN
);

613  -
EUCLEAN
;

616 
	`BUG_ON
(
num_»fs
 < 
»fs_to_drİ
);

617 
num_»fs
 -ğ
»fs_to_drİ
;

619 ià(
num_»fs
 == 0) {

620 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

622 ià(
key
.
ty³
 =ğ
BTRFS_EXTENT_DATA_REF_KEY
)

623 
	`bŒfs_£t_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f1
, 
num_»fs
);

624 ià(
key
.
ty³
 =ğ
BTRFS_SHARED_DATA_REF_KEY
)

625 
	`bŒfs_£t_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
»f2
, 
num_»fs
);

626 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

628  
»t
;

629 
	}
}

631 
nošlše
 
u32
 
	$ex‹Á_d©a_»f_couÁ
(
bŒfs_·th
 *
·th
,

632 
bŒfs_ex‹Á_šlše_»f
 *
œef
)

634 
bŒfs_key
 
key
;

635 
ex‹Á_bufãr
 *
Ëaf
;

636 
bŒfs_ex‹Á_d©a_»f
 *
»f1
;

637 
bŒfs_sh¬ed_d©a_»f
 *
»f2
;

638 
u32
 
num_»fs
 = 0;

639 
ty³
;

641 
Ëaf
 = 
·th
->
nodes
[0];

642 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

644 ià(
œef
) {

649 
ty³
 = 
	`bŒfs_g‘_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
, 
BTRFS_REF_TYPE_DATA
);

650 
	`ASSERT
(
ty³
 !ğ
BTRFS_REF_TYPE_INVALID
);

651 ià(
ty³
 =ğ
BTRFS_EXTENT_DATA_REF_KEY
) {

652 
»f1
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

653 
num_»fs
 = 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f1
);

655 
»f2
 = (
bŒfs_sh¬ed_d©a_»f
 *)(
œef
 + 1);

656 
num_»fs
 = 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
»f2
);

658 } ià(
key
.
ty³
 =ğ
BTRFS_EXTENT_DATA_REF_KEY
) {

659 
»f1
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

660 
bŒfs_ex‹Á_d©a_»f
);

661 
num_»fs
 = 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f1
);

662 } ià(
key
.
ty³
 =ğ
BTRFS_SHARED_DATA_REF_KEY
) {

663 
»f2
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

664 
bŒfs_sh¬ed_d©a_»f
);

665 
num_»fs
 = 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
»f2
);

667 
	`WARN_ON
(1);

669  
num_»fs
;

670 
	}
}

672 
nošlše
 
	$lookup_Œ“_block_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

673 
bŒfs_·th
 *
·th
,

674 
u64
 
by‹Ä
, u64 
·»Á
,

675 
u64
 
roÙ_objeùid
)

677 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
Œªs
->
fs_šfo
, 
by‹Ä
);

678 
bŒfs_key
 
key
;

679 
»t
;

681 
key
.
objeùid
 = 
by‹Ä
;

682 ià(
·»Á
) {

683 
key
.
ty³
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

684 
key
.
off£t
 = 
·»Á
;

686 
key
.
ty³
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

687 
key
.
off£t
 = 
roÙ_objeùid
;

690 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

691 ià(
»t
 > 0)

692 
»t
 = -
ENOENT
;

693  
»t
;

694 
	}
}

696 
nošlše
 
	$š£¹_Œ“_block_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

697 
bŒfs_·th
 *
·th
,

698 
u64
 
by‹Ä
, u64 
·»Á
,

699 
u64
 
roÙ_objeùid
)

701 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
Œªs
->
fs_šfo
, 
by‹Ä
);

702 
bŒfs_key
 
key
;

703 
»t
;

705 
key
.
objeùid
 = 
by‹Ä
;

706 ià(
·»Á
) {

707 
key
.
ty³
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

708 
key
.
off£t
 = 
·»Á
;

710 
key
.
ty³
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

711 
key
.
off£t
 = 
roÙ_objeùid
;

714 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 0);

715 
	`bŒfs_»Ëa£_·th
(
·th
);

716  
»t
;

717 
	}
}

719 
šlše
 
	$ex‹Á_»f_ty³
(
u64
 
·»Á
, u64 
owÃr
)

721 
ty³
;

722 ià(
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

723 ià(
·»Á
 > 0)

724 
ty³
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

726 
ty³
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

728 ià(
·»Á
 > 0)

729 
ty³
 = 
BTRFS_SHARED_DATA_REF_KEY
;

731 
ty³
 = 
BTRFS_EXTENT_DATA_REF_KEY
;

733  
ty³
;

734 
	}
}

736 
	$fšd_Ãxt_key
(
bŒfs_·th
 *
·th
, 
Ëv–
,

737 
bŒfs_key
 *
key
)

740 ; 
Ëv–
 < 
BTRFS_MAX_LEVEL
;†evel++) {

741 ià(!
·th
->
nodes
[
Ëv–
])

743 ià(
·th
->
¦Ùs
[
Ëv–
] + 1 >=

744 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[
Ëv–
]))

746 ià(
Ëv–
 == 0)

747 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[
Ëv–
], 
key
,

748 
·th
->
¦Ùs
[
Ëv–
] + 1);

750 
	`bŒfs_node_key_to_ıu
(
·th
->
nodes
[
Ëv–
], 
key
,

751 
·th
->
¦Ùs
[
Ëv–
] + 1);

755 
	}
}

770 
nošlše_fÜ_¡ack


771 
	$lookup_šlše_ex‹Á_back»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

772 
bŒfs_·th
 *
·th
,

773 
bŒfs_ex‹Á_šlše_»f
 **
»f_»t
,

774 
u64
 
by‹Ä
, u64 
num_by‹s
,

775 
u64
 
·»Á
, u64 
roÙ_objeùid
,

776 
u64
 
owÃr
, u64 
off£t
, 
š£¹
)

778 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

779 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 
by‹Ä
);

780 
bŒfs_key
 
key
;

781 
ex‹Á_bufãr
 *
Ëaf
;

782 
bŒfs_ex‹Á_™em
 *
ei
;

783 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

784 
u64
 
æags
;

785 
u64
 
™em_size
;

786 
±r
;

787 
’d
;

788 
exŒa_size
;

789 
ty³
;

790 
wªt
;

791 
»t
;

792 
”r
 = 0;

793 
boŞ
 
skšny_m‘ad©a
 = 
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
);

794 
Ãeded
;

796 
key
.
objeùid
 = 
by‹Ä
;

797 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

798 
key
.
off£t
 = 
num_by‹s
;

800 
wªt
 = 
	`ex‹Á_»f_ty³
(
·»Á
, 
owÃr
);

801 ià(
š£¹
) {

802 
exŒa_size
 = 
	`bŒfs_ex‹Á_šlše_»f_size
(
wªt
);

803 
·th
->
£¬ch_fÜ_ex‹nsiÚ
 = 1;

804 
·th
->
k“p_locks
 = 1;

806 
exŒa_size
 = -1;

812 ià(
skšny_m‘ad©a
 && 
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

813 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

814 
key
.
off£t
 = 
owÃr
;

817 
agaš
:

818 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 
exŒa_size
, 1);

819 ià(
»t
 < 0) {

820 
”r
 = 
»t
;

821 
out
;

828 ià(
»t
 > 0 && 
skšny_m‘ad©a
) {

829 
skšny_m‘ad©a
 = 
çl£
;

830 ià(
·th
->
¦Ùs
[0]) {

831 
·th
->
¦Ùs
[0]--;

832 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,

833 
·th
->
¦Ùs
[0]);

834 ià(
key
.
objeùid
 =ğ
by‹Ä
 &&

835 
key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 &&

836 
key
.
off£t
 =ğ
num_by‹s
)

837 
»t
 = 0;

839 ià(
»t
) {

840 
key
.
objeùid
 = 
by‹Ä
;

841 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

842 
key
.
off£t
 = 
num_by‹s
;

843 
	`bŒfs_»Ëa£_·th
(
·th
);

844 
agaš
;

848 ià(
»t
 && !
š£¹
) {

849 
”r
 = -
ENOENT
;

850 
out
;

851 } ià(
	`WARN_ON
(
»t
)) {

852 
	`bŒfs_´št_Ëaf
(
·th
->
nodes
[0]);

853 
	`bŒfs_”r
(
fs_šfo
,

855 
by‹Ä
, 
num_by‹s
, 
·»Á
, 
roÙ_objeùid
, 
owÃr
,

856 
off£t
);

857 
”r
 = -
EIO
;

858 
out
;

861 
Ëaf
 = 
·th
->
nodes
[0];

862 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

863 ià(
	`uÆik–y
(
™em_size
 < (*
ei
))) {

864 
”r
 = -
EUCLEAN
;

865 
	`bŒfs_”r
(
fs_šfo
,

867 
™em_size
, (*
ei
));

868 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
”r
);

869 
out
;

872 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

873 
æags
 = 
	`bŒfs_ex‹Á_æags
(
Ëaf
, 
ei
);

875 
±r
 = ()(
ei
 + 1);

876 
’d
 = ()
ei
 + 
™em_size
;

878 ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
 && !
skšny_m‘ad©a
) {

879 
±r
 +ğ(
bŒfs_Œ“_block_šfo
);

880 
	`BUG_ON
(
±r
 > 
’d
);

883 ià(
owÃr
 >ğ
BTRFS_FIRST_FREE_OBJECTID
)

884 
Ãeded
 = 
BTRFS_REF_TYPE_DATA
;

886 
Ãeded
 = 
BTRFS_REF_TYPE_BLOCK
;

888 
”r
 = -
ENOENT
;

890 ià(
±r
 >ğ
’d
) {

891 ià(
±r
 > 
’d
) {

892 
”r
 = -
EUCLEAN
;

893 
	`bŒfs_´št_Ëaf
(
·th
->
nodes
[0]);

894 
	`bŒfs_ü™
(
fs_šfo
,

896 
·th
->
¦Ùs
[0], 
roÙ_objeùid
, 
owÃr
, 
off£t
, 
·»Á
);

900 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)
±r
;

901 
ty³
 = 
	`bŒfs_g‘_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
, 
Ãeded
);

902 ià(
ty³
 =ğ
BTRFS_REF_TYPE_INVALID
) {

903 
”r
 = -
EUCLEAN
;

904 
out
;

907 ià(
wªt
 < 
ty³
)

909 ià(
wªt
 > 
ty³
) {

910 
±r
 +ğ
	`bŒfs_ex‹Á_šlše_»f_size
(
ty³
);

914 ià(
ty³
 =ğ
BTRFS_EXTENT_DATA_REF_KEY
) {

915 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

916 
d»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

917 ià(
	`m©ch_ex‹Á_d©a_»f
(
Ëaf
, 
d»f
, 
roÙ_objeùid
,

918 
owÃr
, 
off£t
)) {

919 
”r
 = 0;

922 ià(
	`hash_ex‹Á_d©a_»f_™em
(
Ëaf
, 
d»f
) <

923 
	`hash_ex‹Á_d©a_»f
(
roÙ_objeùid
, 
owÃr
, 
off£t
))

926 
u64
 
»f_off£t
;

927 
»f_off£t
 = 
	`bŒfs_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
);

928 ià(
·»Á
 > 0) {

929 ià(
·»Á
 =ğ
»f_off£t
) {

930 
”r
 = 0;

933 ià(
»f_off£t
 < 
·»Á
)

936 ià(
roÙ_objeùid
 =ğ
»f_off£t
) {

937 
”r
 = 0;

940 ià(
»f_off£t
 < 
roÙ_objeùid
)

944 
±r
 +ğ
	`bŒfs_ex‹Á_šlše_»f_size
(
ty³
);

946 ià(
”r
 =ğ-
ENOENT
 && 
š£¹
) {

947 ià(
™em_size
 + 
exŒa_size
 >=

948 
	`BTRFS_MAX_EXTENT_ITEM_SIZE
(
roÙ
)) {

949 
”r
 = -
EAGAIN
;

950 
out
;

958 ià(
	`fšd_Ãxt_key
(
·th
, 0, &
key
) == 0 &&

959 
key
.
objeùid
 =ğ
by‹Ä
 &&

960 
key
.
ty³
 < 
BTRFS_BLOCK_GROUP_ITEM_KEY
) {

961 
”r
 = -
EAGAIN
;

962 
out
;

965 *
»f_»t
 = (
bŒfs_ex‹Á_šlše_»f
 *)
±r
;

966 
out
:

967 ià(
š£¹
) {

968 
·th
->
k“p_locks
 = 0;

969 
·th
->
£¬ch_fÜ_ex‹nsiÚ
 = 0;

970 
	`bŒfs_uÆock_up_§ã
(
·th
, 1);

972  
”r
;

973 
	}
}

978 
nošlše_fÜ_¡ack


979 
	$£tup_šlše_ex‹Á_back»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

980 
bŒfs_·th
 *
·th
,

981 
bŒfs_ex‹Á_šlše_»f
 *
œef
,

982 
u64
 
·»Á
, u64 
roÙ_objeùid
,

983 
u64
 
owÃr
, u64 
off£t
, 
»fs_to_add
,

984 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
)

986 
ex‹Á_bufãr
 *
Ëaf
;

987 
bŒfs_ex‹Á_™em
 *
ei
;

988 
±r
;

989 
’d
;

990 
™em_off£t
;

991 
u64
 
»fs
;

992 
size
;

993 
ty³
;

995 
Ëaf
 = 
·th
->
nodes
[0];

996 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

997 
™em_off£t
 = ()
œef
 - ()
ei
;

999 
ty³
 = 
	`ex‹Á_»f_ty³
(
·»Á
, 
owÃr
);

1000 
size
 = 
	`bŒfs_ex‹Á_šlše_»f_size
(
ty³
);

1002 
	`bŒfs_ex‹nd_™em
(
Œªs
, 
·th
, 
size
);

1004 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

1005 
»fs
 = 
	`bŒfs_ex‹Á_»fs
(
Ëaf
, 
ei
);

1006 
»fs
 +ğ
»fs_to_add
;

1007 
	`bŒfs_£t_ex‹Á_»fs
(
Ëaf
, 
ei
, 
»fs
);

1008 ià(
ex‹Á_İ
)

1009 
	`__run_d–ayed_ex‹Á_İ
(
ex‹Á_İ
, 
Ëaf
, 
ei
);

1011 
±r
 = ()
ei
 + 
™em_off£t
;

1012 
’d
 = ()
ei
 + 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1013 ià(
±r
 < 
’d
 - 
size
)

1014 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
±r
 + 
size
,…tr,

1015 
’d
 - 
size
 - 
±r
);

1017 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)
±r
;

1018 
	`bŒfs_£t_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
, 
ty³
);

1019 ià(
ty³
 =ğ
BTRFS_EXTENT_DATA_REF_KEY
) {

1020 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

1021 
d»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

1022 
	`bŒfs_£t_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
d»f
, 
roÙ_objeùid
);

1023 
	`bŒfs_£t_ex‹Á_d©a_»f_objeùid
(
Ëaf
, 
d»f
, 
owÃr
);

1024 
	`bŒfs_£t_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
d»f
, 
off£t
);

1025 
	`bŒfs_£t_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
d»f
, 
»fs_to_add
);

1026 } ià(
ty³
 =ğ
BTRFS_SHARED_DATA_REF_KEY
) {

1027 
bŒfs_sh¬ed_d©a_»f
 *
¤ef
;

1028 
¤ef
 = (
bŒfs_sh¬ed_d©a_»f
 *)(
œef
 + 1);

1029 
	`bŒfs_£t_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
¤ef
, 
»fs_to_add
);

1030 
	`bŒfs_£t_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
, 
·»Á
);

1031 } ià(
ty³
 =ğ
BTRFS_SHARED_BLOCK_REF_KEY
) {

1032 
	`bŒfs_£t_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
, 
·»Á
);

1034 
	`bŒfs_£t_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
, 
roÙ_objeùid
);

1036 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

1037 
	}
}

1039 
	$lookup_ex‹Á_back»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1040 
bŒfs_·th
 *
·th
,

1041 
bŒfs_ex‹Á_šlše_»f
 **
»f_»t
,

1042 
u64
 
by‹Ä
, u64 
num_by‹s
, u64 
·»Á
,

1043 
u64
 
roÙ_objeùid
, u64 
owÃr
, u64 
off£t
)

1045 
»t
;

1047 
»t
 = 
	`lookup_šlše_ex‹Á_back»f
(
Œªs
, 
·th
, 
»f_»t
, 
by‹Ä
,

1048 
num_by‹s
, 
·»Á
, 
roÙ_objeùid
,

1049 
owÃr
, 
off£t
, 0);

1050 ià(
»t
 !ğ-
ENOENT
)

1051  
»t
;

1053 
	`bŒfs_»Ëa£_·th
(
·th
);

1054 *
»f_»t
 = 
NULL
;

1056 ià(
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

1057 
»t
 = 
	`lookup_Œ“_block_»f
(
Œªs
, 
·th
, 
by‹Ä
, 
·»Á
,

1058 
roÙ_objeùid
);

1060 
»t
 = 
	`lookup_ex‹Á_d©a_»f
(
Œªs
, 
·th
, 
by‹Ä
, 
·»Á
,

1061 
roÙ_objeùid
, 
owÃr
, 
off£t
);

1063  
»t
;

1064 
	}
}

1069 
nošlše_fÜ_¡ack
 
	$upd©e_šlše_ex‹Á_back»f
(

1070 
bŒfs_Œªs_hªdË
 *
Œªs
,

1071 
bŒfs_·th
 *
·th
,

1072 
bŒfs_ex‹Á_šlše_»f
 *
œef
,

1073 
»fs_to_mod
,

1074 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
)

1076 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

1077 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

1078 
bŒfs_ex‹Á_™em
 *
ei
;

1079 
bŒfs_ex‹Á_d©a_»f
 *
d»f
 = 
NULL
;

1080 
bŒfs_sh¬ed_d©a_»f
 *
¤ef
 = 
NULL
;

1081 
±r
;

1082 
’d
;

1083 
u32
 
™em_size
;

1084 
size
;

1085 
ty³
;

1086 
u64
 
»fs
;

1088 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

1089 
»fs
 = 
	`bŒfs_ex‹Á_»fs
(
Ëaf
, 
ei
);

1090 ià(
	`uÆik–y
(
»fs_to_mod
 < 0 && 
»fs
 +„efs_to_mod <= 0)) {

1091 
bŒfs_key
 
key
;

1092 
u32
 
ex‹Á_size
;

1094 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

1095 ià(
key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
)

1096 
ex‹Á_size
 = 
fs_šfo
->
nodesize
;

1098 
ex‹Á_size
 = 
key
.
off£t
;

1099 
	`bŒfs_´št_Ëaf
(
Ëaf
);

1100 
	`bŒfs_”r
(
fs_šfo
,

1102 
key
.
objeùid
, 
ex‹Á_size
, 
»fs_to_mod
, 
»fs
);

1103  -
EUCLEAN
;

1105 
»fs
 +ğ
»fs_to_mod
;

1106 
	`bŒfs_£t_ex‹Á_»fs
(
Ëaf
, 
ei
, 
»fs
);

1107 ià(
ex‹Á_İ
)

1108 
	`__run_d–ayed_ex‹Á_İ
(
ex‹Á_İ
, 
Ëaf
, 
ei
);

1110 
ty³
 = 
	`bŒfs_g‘_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
, 
BTRFS_REF_TYPE_ANY
);

1115 ià(
	`uÆik–y
(
ty³
 =ğ
BTRFS_REF_TYPE_INVALID
))

1116  -
EUCLEAN
;

1118 ià(
ty³
 =ğ
BTRFS_EXTENT_DATA_REF_KEY
) {

1119 
d»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

1120 
»fs
 = 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
d»f
);

1121 } ià(
ty³
 =ğ
BTRFS_SHARED_DATA_REF_KEY
) {

1122 
¤ef
 = (
bŒfs_sh¬ed_d©a_»f
 *)(
œef
 + 1);

1123 
»fs
 = 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
¤ef
);

1125 
»fs
 = 1;

1134 ià(
	`uÆik–y
(
»fs_to_mod
 != -1)) {

1135 
bŒfs_key
 
key
;

1137 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

1139 
	`bŒfs_´št_Ëaf
(
Ëaf
);

1140 
	`bŒfs_”r
(
fs_šfo
,

1142 
key
.
objeùid
, 
»fs_to_mod
);

1143  -
EUCLEAN
;

1147 ià(
	`uÆik–y
(
»fs_to_mod
 < 0 && 
»fs
 < -refs_to_mod)) {

1148 
bŒfs_key
 
key
;

1149 
u32
 
ex‹Á_size
;

1151 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

1152 ià(
key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
)

1153 
ex‹Á_size
 = 
fs_šfo
->
nodesize
;

1155 
ex‹Á_size
 = 
key
.
off£t
;

1156 
	`bŒfs_´št_Ëaf
(
Ëaf
);

1157 
	`bŒfs_”r
(
fs_šfo
,

1159 ()
œef
, 
key
.
objeùid
, 
ex‹Á_size
,

1160 
»fs_to_mod
, 
»fs
);

1161  -
EUCLEAN
;

1163 
»fs
 +ğ
»fs_to_mod
;

1165 ià(
»fs
 > 0) {

1166 ià(
ty³
 =ğ
BTRFS_EXTENT_DATA_REF_KEY
)

1167 
	`bŒfs_£t_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
d»f
, 
»fs
);

1169 
	`bŒfs_£t_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
¤ef
, 
»fs
);

1171 
size
 = 
	`bŒfs_ex‹Á_šlše_»f_size
(
ty³
);

1172 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1173 
±r
 = ()
œef
;

1174 
’d
 = ()
ei
 + 
™em_size
;

1175 ià(
±r
 + 
size
 < 
’d
)

1176 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
±r
,…Œ + 
size
,

1177 
’d
 - 
±r
 - 
size
);

1178 
™em_size
 -ğ
size
;

1179 
	`bŒfs_Œunÿ‹_™em
(
Œªs
, 
·th
, 
™em_size
, 1);

1181 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

1183 
	}
}

1185 
nošlše_fÜ_¡ack


1186 
	$š£¹_šlše_ex‹Á_back»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1187 
bŒfs_·th
 *
·th
,

1188 
u64
 
by‹Ä
, u64 
num_by‹s
, u64 
·»Á
,

1189 
u64
 
roÙ_objeùid
, u64 
owÃr
,

1190 
u64
 
off£t
, 
»fs_to_add
,

1191 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
)

1193 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

1194 
»t
;

1196 
»t
 = 
	`lookup_šlše_ex‹Á_back»f
(
Œªs
, 
·th
, &
œef
, 
by‹Ä
,

1197 
num_by‹s
, 
·»Á
, 
roÙ_objeùid
,

1198 
owÃr
, 
off£t
, 1);

1199 ià(
»t
 == 0) {

1204 ià(
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

1205 
	`bŒfs_´št_Ëaf
(
·th
->
nodes
[0]);

1206 
	`bŒfs_ü™
(
Œªs
->
fs_šfo
,

1208 
by‹Ä
, 
num_by‹s
, 
roÙ_objeùid
, 
·th
->
¦Ùs
[0]);

1209  -
EUCLEAN
;

1211 
»t
 = 
	`upd©e_šlše_ex‹Á_back»f
(
Œªs
, 
·th
, 
œef
,

1212 
»fs_to_add
, 
ex‹Á_İ
);

1213 } ià(
»t
 =ğ-
ENOENT
) {

1214 
	`£tup_šlše_ex‹Á_back»f
(
Œªs
, 
·th
, 
œef
, 
·»Á
,

1215 
roÙ_objeùid
, 
owÃr
, 
off£t
,

1216 
»fs_to_add
, 
ex‹Á_İ
);

1217 
»t
 = 0;

1219  
»t
;

1220 
	}
}

1222 
	$»move_ex‹Á_back»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1223 
bŒfs_roÙ
 *
roÙ
,

1224 
bŒfs_·th
 *
·th
,

1225 
bŒfs_ex‹Á_šlše_»f
 *
œef
,

1226 
»fs_to_drİ
, 
is_d©a
)

1228 
»t
 = 0;

1230 
	`BUG_ON
(!
is_d©a
 && 
»fs_to_drİ
 != 1);

1231 ià(
œef
)

1232 
»t
 = 
	`upd©e_šlše_ex‹Á_back»f
(
Œªs
, 
·th
, 
œef
,

1233 -
»fs_to_drİ
, 
NULL
);

1234 ià(
is_d©a
)

1235 
»t
 = 
	`»move_ex‹Á_d©a_»f
(
Œªs
, 
roÙ
, 
·th
, 
»fs_to_drİ
);

1237 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

1238  
»t
;

1239 
	}
}

1241 
	$bŒfs_issue_disÿrd
(
block_deviû
 *
bdev
, 
u64
 
¡¬t
, u64 
Ën
,

1242 
u64
 *
disÿrded_by‹s
)

1244 
j
, 
»t
 = 0;

1245 
u64
 
by‹s_Ëá
, 
’d
;

1246 
u64
 
®igÃd_¡¬t
 = 
	`ALIGN
(
¡¬t
, 1 << 
SECTOR_SHIFT
);

1248 ià(
	`WARN_ON
(
¡¬t
 !ğ
®igÃd_¡¬t
)) {

1249 
Ën
 -ğ
®igÃd_¡¬t
 - 
¡¬t
;

1250 
Ën
 = 
	`round_down
Ö’, 1 << 
SECTOR_SHIFT
);

1251 
¡¬t
 = 
®igÃd_¡¬t
;

1254 *
disÿrded_by‹s
 = 0;

1256 ià(!
Ën
)

1259 
’d
 = 
¡¬t
 + 
Ën
;

1260 
by‹s_Ëá
 = 
Ën
;

1263 
j
 = 0; j < 
BTRFS_SUPER_MIRROR_MAX
; j++) {

1264 
u64
 
sb_¡¬t
 = 
	`bŒfs_sb_off£t
(
j
);

1265 
u64
 
sb_’d
 = 
sb_¡¬t
 + 
BTRFS_SUPER_INFO_SIZE
;

1266 
u64
 
size
 = 
sb_¡¬t
 - 
¡¬t
;

1268 ià(!
	`š_¿nge
(
sb_¡¬t
, 
¡¬t
, 
by‹s_Ëá
) &&

1269 !
	`š_¿nge
(
sb_’d
, 
¡¬t
, 
by‹s_Ëá
) &&

1270 !
	`š_¿nge
(
¡¬t
, 
sb_¡¬t
, 
BTRFS_SUPER_INFO_SIZE
))

1277 ià(
sb_¡¬t
 <ğ
¡¬t
) {

1278 
¡¬t
 +ğ
sb_’d
 - start;

1279 ià(
¡¬t
 > 
’d
) {

1280 
by‹s_Ëá
 = 0;

1283 
by‹s_Ëá
 = 
’d
 - 
¡¬t
;

1287 ià(
size
) {

1288 
»t
 = 
	`blkdev_issue_disÿrd
(
bdev
, 
¡¬t
 >> 
SECTOR_SHIFT
,

1289 
size
 >> 
SECTOR_SHIFT
,

1290 
GFP_NOFS
);

1291 ià(!
»t
)

1292 *
disÿrded_by‹s
 +ğ
size
;

1293 ià(
»t
 !ğ-
EOPNOTSUPP
)

1294  
»t
;

1297 
¡¬t
 = 
sb_’d
;

1298 ià(
¡¬t
 > 
’d
) {

1299 
by‹s_Ëá
 = 0;

1302 
by‹s_Ëá
 = 
’d
 - 
¡¬t
;

1305 ià(
by‹s_Ëá
) {

1306 
»t
 = 
	`blkdev_issue_disÿrd
(
bdev
, 
¡¬t
 >> 
SECTOR_SHIFT
,

1307 
by‹s_Ëá
 >> 
SECTOR_SHIFT
,

1308 
GFP_NOFS
);

1309 ià(!
»t
)

1310 *
disÿrded_by‹s
 +ğ
by‹s_Ëá
;

1312  
»t
;

1313 
	}
}

1315 
	$do_disÿrd_ex‹Á
(
bŒfs_disÿrd_¡re
 *
¡re
, 
u64
 *
by‹s
)

1317 
bŒfs_deviû
 *
dev
 = 
¡re
->dev;

1318 
bŒfs_fs_šfo
 *
fs_šfo
 = 
dev
->fs_info;

1319 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

1320 
u64
 
phys
 = 
¡re
->
physiÿl
;

1321 
u64
 
Ën
 = 
¡re
->
Ëngth
;

1322 
u64
 
disÿrded
 = 0;

1323 
»t
 = 0;

1326 ià(
	`bŒfs_ÿn_zÚe_»£t
(
dev
, 
phys
, 
Ën
)) {

1327 
u64
 
¤c_disc
;

1329 
»t
 = 
	`bŒfs_»£t_deviû_zÚe
(
dev
, 
phys
, 
Ën
, &
disÿrded
);

1330 ià(
»t
)

1331 
out
;

1333 ià(!
	`bŒfs_dev_»¶aû_is_Úgošg
(
dev_»¶aû
) ||

1334 
dev
 !ğ
dev_»¶aû
->
¤cdev
)

1335 
out
;

1337 
¤c_disc
 = 
disÿrded
;

1340 
»t
 = 
	`bŒfs_»£t_deviû_zÚe
(
dev_»¶aû
->
tgtdev
, 
phys
, 
Ën
,

1341 &
disÿrded
);

1342 
disÿrded
 +ğ
¤c_disc
;

1343 } ià(
	`bdev_max_disÿrd_£ùÜs
(
¡re
->
dev
->
bdev
)) {

1344 
»t
 = 
	`bŒfs_issue_disÿrd
(
dev
->
bdev
, 
phys
, 
Ën
, &
disÿrded
);

1346 
»t
 = 0;

1347 *
by‹s
 = 0;

1350 
out
:

1351 *
by‹s
 = 
disÿrded
;

1352  
»t
;

1353 
	}
}

1355 
	$bŒfs_disÿrd_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

1356 
u64
 
num_by‹s
, u64 *
aùu®_by‹s
)

1358 
»t
 = 0;

1359 
u64
 
disÿrded_by‹s
 = 0;

1360 
u64
 
’d
 = 
by‹Ä
 + 
num_by‹s
;

1361 
u64
 
cur
 = 
by‹Ä
;

1367 
	`bŒfs_bio_couÁ”_šc_blocked
(
fs_šfo
);

1368 
cur
 < 
’d
) {

1369 
bŒfs_disÿrd_¡re
 *
¡res
;

1370 
num_¡res
;

1371 
i
;

1373 
num_by‹s
 = 
’d
 - 
cur
;

1374 
¡res
 = 
	`bŒfs_m­_disÿrd
(
fs_šfo
, 
cur
, &
num_by‹s
, &
num_¡res
);

1375 ià(
	`IS_ERR
(
¡res
)) {

1376 
»t
 = 
	`PTR_ERR
(
¡res
);

1377 ià(
»t
 =ğ-
EOPNOTSUPP
)

1378 
»t
 = 0;

1382 
i
 = 0; i < 
num_¡res
; i++) {

1383 
bŒfs_disÿrd_¡re
 *
¡re
 = 
¡res
 + 
i
;

1384 
u64
 
by‹s
;

1386 ià(!
¡re
->
dev
->
bdev
) {

1387 
	`ASSERT
(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DEGRADED
));

1391 ià(!
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
,

1392 &
¡re
->
dev
->
dev_¡©e
))

1395 
»t
 = 
	`do_disÿrd_ex‹Á
(
¡re
, &
by‹s
);

1396 ià(
»t
) {

1401 ià(
»t
 !ğ-
EOPNOTSUPP
)

1403 
»t
 = 0;

1405 
disÿrded_by‹s
 +ğ
by‹s
;

1408 
	`kä“
(
¡res
);

1409 ià(
»t
)

1411 
cur
 +ğ
num_by‹s
;

1413 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

1414 ià(
aùu®_by‹s
)

1415 *
aùu®_by‹s
 = 
disÿrded_by‹s
;

1416  
»t
;

1417 
	}
}

1420 
	$bŒfs_šc_ex‹Á_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1421 
bŒfs_»f
 *
g’”ic_»f
)

1423 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1424 
»t
;

1426 
	`ASSERT
(
g’”ic_»f
->
ty³
 !ğ
BTRFS_REF_NOT_SET
 &&

1427 
g’”ic_»f
->
aùiÚ
);

1428 
	`BUG_ON
(
g’”ic_»f
->
ty³
 =ğ
BTRFS_REF_METADATA
 &&

1429 
g’”ic_»f
->
Œ“_»f
.
ownšg_roÙ
 =ğ
BTRFS_TREE_LOG_OBJECTID
);

1431 ià(
g’”ic_»f
->
ty³
 =ğ
BTRFS_REF_METADATA
)

1432 
»t
 = 
	`bŒfs_add_d–ayed_Œ“_»f
(
Œªs
, 
g’”ic_»f
, 
NULL
);

1434 
»t
 = 
	`bŒfs_add_d–ayed_d©a_»f
(
Œªs
, 
g’”ic_»f
, 0);

1436 
	`bŒfs_»f_Œ“_mod
(
fs_šfo
, 
g’”ic_»f
);

1438  
»t
;

1439 
	}
}

1478 
	$__bŒfs_šc_ex‹Á_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1479 
bŒfs_d–ayed_»f_node
 *
node
,

1480 
u64
 
·»Á
, u64 
roÙ_objeùid
,

1481 
u64
 
owÃr
, u64 
off£t
, 
»fs_to_add
,

1482 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
)

1484 
bŒfs_·th
 *
·th
;

1485 
ex‹Á_bufãr
 *
Ëaf
;

1486 
bŒfs_ex‹Á_™em
 *
™em
;

1487 
bŒfs_key
 
key
;

1488 
u64
 
by‹Ä
 = 
node
->bytenr;

1489 
u64
 
num_by‹s
 = 
node
->num_bytes;

1490 
u64
 
»fs
;

1491 
»t
;

1493 
·th
 = 
	`bŒfs_®loc_·th
();

1494 ià(!
·th
)

1495  -
ENOMEM
;

1498 
»t
 = 
	`š£¹_šlše_ex‹Á_back»f
(
Œªs
, 
·th
, 
by‹Ä
, 
num_by‹s
,

1499 
·»Á
, 
roÙ_objeùid
, 
owÃr
,

1500 
off£t
, 
»fs_to_add
, 
ex‹Á_İ
);

1501 ià((
»t
 < 0 &&„‘ !ğ-
EAGAIN
) || !ret)

1502 
out
;

1509 
Ëaf
 = 
·th
->
nodes
[0];

1510 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

1511 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

1512 
»fs
 = 
	`bŒfs_ex‹Á_»fs
(
Ëaf
, 
™em
);

1513 
	`bŒfs_£t_ex‹Á_»fs
(
Ëaf
, 
™em
, 
»fs
 + 
»fs_to_add
);

1514 ià(
ex‹Á_İ
)

1515 
	`__run_d–ayed_ex‹Á_İ
(
ex‹Á_İ
, 
Ëaf
, 
™em
);

1517 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

1518 
	`bŒfs_»Ëa£_·th
(
·th
);

1521 ià(
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
)

1522 
»t
 = 
	`š£¹_Œ“_block_»f
(
Œªs
, 
·th
, 
by‹Ä
, 
·»Á
,

1523 
roÙ_objeùid
);

1525 
»t
 = 
	`š£¹_ex‹Á_d©a_»f
(
Œªs
, 
·th
, 
by‹Ä
, 
·»Á
,

1526 
roÙ_objeùid
, 
owÃr
, 
off£t
,

1527 
»fs_to_add
);

1529 ià(
»t
)

1530 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1531 
out
:

1532 
	`bŒfs_ä“_·th
(
·th
);

1533  
»t
;

1534 
	}
}

1536 
	$run_d–ayed_d©a_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1537 
bŒfs_d–ayed_»f_node
 *
node
,

1538 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
,

1539 
boŞ
 
š£¹_»£rved
)

1541 
»t
 = 0;

1542 
bŒfs_d–ayed_d©a_»f
 *
»f
;

1543 
bŒfs_key
 
šs
;

1544 
u64
 
·»Á
 = 0;

1545 
u64
 
»f_roÙ
 = 0;

1546 
u64
 
æags
 = 0;

1548 
šs
.
objeùid
 = 
node
->
by‹Ä
;

1549 
šs
.
off£t
 = 
node
->
num_by‹s
;

1550 
šs
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

1552 
»f
 = 
	`bŒfs_d–ayed_node_to_d©a_»f
(
node
);

1553 
	`Œaû_run_d–ayed_d©a_»f
(
Œªs
->
fs_šfo
, 
node
, 
»f
,‚ode->
aùiÚ
);

1555 ià(
node
->
ty³
 =ğ
BTRFS_SHARED_DATA_REF_KEY
)

1556 
·»Á
 = 
»f
->parent;

1557 
»f_roÙ
 = 
»f
->
roÙ
;

1559 ià(
node
->
aùiÚ
 =ğ
BTRFS_ADD_DELAYED_REF
 && 
š£¹_»£rved
) {

1560 ià(
ex‹Á_İ
)

1561 
æags
 |ğ
ex‹Á_İ
->
æags_to_£t
;

1562 
»t
 = 
	`®loc_»£rved_fe_ex‹Á
(
Œªs
, 
·»Á
, 
»f_roÙ
,

1563 
æags
, 
»f
->
objeùid
,

1564 
»f
->
off£t
, &
šs
,

1565 
node
->
»f_mod
);

1566 } ià(
node
->
aùiÚ
 =ğ
BTRFS_ADD_DELAYED_REF
) {

1567 
»t
 = 
	`__bŒfs_šc_ex‹Á_»f
(
Œªs
, 
node
, 
·»Á
, 
»f_roÙ
,

1568 
»f
->
objeùid
,„ef->
off£t
,

1569 
node
->
»f_mod
, 
ex‹Á_İ
);

1570 } ià(
node
->
aùiÚ
 =ğ
BTRFS_DROP_DELAYED_REF
) {

1571 
»t
 = 
	`__bŒfs_ä“_ex‹Á
(
Œªs
, 
node
, 
·»Á
,

1572 
»f_roÙ
, 
»f
->
objeùid
,

1573 
»f
->
off£t
, 
node
->
»f_mod
,

1574 
ex‹Á_İ
);

1576 
	`BUG
();

1578  
»t
;

1579 
	}
}

1581 
	$__run_d–ayed_ex‹Á_İ
(
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
,

1582 
ex‹Á_bufãr
 *
Ëaf
,

1583 
bŒfs_ex‹Á_™em
 *
ei
)

1585 
u64
 
æags
 = 
	`bŒfs_ex‹Á_æags
(
Ëaf
, 
ei
);

1586 ià(
ex‹Á_İ
->
upd©e_æags
) {

1587 
æags
 |ğ
ex‹Á_İ
->
æags_to_£t
;

1588 
	`bŒfs_£t_ex‹Á_æags
(
Ëaf
, 
ei
, 
æags
);

1591 ià(
ex‹Á_İ
->
upd©e_key
) {

1592 
bŒfs_Œ“_block_šfo
 *
bi
;

1593 
	`BUG_ON
(!(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
));

1594 
bi
 = (
bŒfs_Œ“_block_šfo
 *)(
ei
 + 1);

1595 
	`bŒfs_£t_Œ“_block_key
(
Ëaf
, 
bi
, &
ex‹Á_İ
->
key
);

1597 
	}
}

1599 
	$run_d–ayed_ex‹Á_İ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1600 
bŒfs_d–ayed_»f_h—d
 *
h—d
,

1601 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
)

1603 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1604 
bŒfs_roÙ
 *
roÙ
;

1605 
bŒfs_key
 
key
;

1606 
bŒfs_·th
 *
·th
;

1607 
bŒfs_ex‹Á_™em
 *
ei
;

1608 
ex‹Á_bufãr
 *
Ëaf
;

1609 
u32
 
™em_size
;

1610 
»t
;

1611 
”r
 = 0;

1612 
m‘ad©a
 = 1;

1614 ià(
	`TRANS_ABORTED
(
Œªs
))

1617 ià(!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
))

1618 
m‘ad©a
 = 0;

1620 
·th
 = 
	`bŒfs_®loc_·th
();

1621 ià(!
·th
)

1622  -
ENOMEM
;

1624 
key
.
objeùid
 = 
h—d
->
by‹Ä
;

1626 ià(
m‘ad©a
) {

1627 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

1628 
key
.
off£t
 = 
ex‹Á_İ
->
Ëv–
;

1630 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

1631 
key
.
off£t
 = 
h—d
->
num_by‹s
;

1634 
roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 
key
.
objeùid
);

1635 
agaš
:

1636 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

1637 ià(
»t
 < 0) {

1638 
”r
 = 
»t
;

1639 
out
;

1641 ià(
»t
 > 0) {

1642 ià(
m‘ad©a
) {

1643 ià(
·th
->
¦Ùs
[0] > 0) {

1644 
·th
->
¦Ùs
[0]--;

1645 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,

1646 
·th
->
¦Ùs
[0]);

1647 ià(
key
.
objeùid
 =ğ
h—d
->
by‹Ä
 &&

1648 
key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 &&

1649 
key
.
off£t
 =ğ
h—d
->
num_by‹s
)

1650 
»t
 = 0;

1652 ià(
»t
 > 0) {

1653 
	`bŒfs_»Ëa£_·th
(
·th
);

1654 
m‘ad©a
 = 0;

1656 
key
.
objeùid
 = 
h—d
->
by‹Ä
;

1657 
key
.
off£t
 = 
h—d
->
num_by‹s
;

1658 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

1659 
agaš
;

1662 
”r
 = -
EUCLEAN
;

1663 
	`bŒfs_”r
(
fs_šfo
,

1665 
h—d
->
by‹Ä
, h—d->
num_by‹s
, 
ex‹Á_İ
->
Ëv–
);

1666 
out
;

1670 
Ëaf
 = 
·th
->
nodes
[0];

1671 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1673 ià(
	`uÆik–y
(
™em_size
 < (*
ei
))) {

1674 
”r
 = -
EUCLEAN
;

1675 
	`bŒfs_”r
(
fs_šfo
,

1677 
™em_size
, (*
ei
));

1678 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
”r
);

1679 
out
;

1682 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

1683 
	`__run_d–ayed_ex‹Á_İ
(
ex‹Á_İ
, 
Ëaf
, 
ei
);

1685 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

1686 
out
:

1687 
	`bŒfs_ä“_·th
(
·th
);

1688  
”r
;

1689 
	}
}

1691 
	$run_d–ayed_Œ“_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1692 
bŒfs_d–ayed_»f_node
 *
node
,

1693 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
,

1694 
boŞ
 
š£¹_»£rved
)

1696 
»t
 = 0;

1697 
bŒfs_d–ayed_Œ“_»f
 *
»f
;

1698 
u64
 
·»Á
 = 0;

1699 
u64
 
»f_roÙ
 = 0;

1701 
»f
 = 
	`bŒfs_d–ayed_node_to_Œ“_»f
(
node
);

1702 
	`Œaû_run_d–ayed_Œ“_»f
(
Œªs
->
fs_šfo
, 
node
, 
»f
,‚ode->
aùiÚ
);

1704 ià(
node
->
ty³
 =ğ
BTRFS_SHARED_BLOCK_REF_KEY
)

1705 
·»Á
 = 
»f
->parent;

1706 
»f_roÙ
 = 
»f
->
roÙ
;

1708 ià(
	`uÆik–y
(
node
->
»f_mod
 != 1)) {

1709 
	`bŒfs_”r
(
Œªs
->
fs_šfo
,

1711 
node
->
by‹Ä
,‚ode->
»f_mod
,‚ode->
aùiÚ
, 
»f_roÙ
,

1712 
·»Á
);

1713  -
EUCLEAN
;

1715 ià(
node
->
aùiÚ
 =ğ
BTRFS_ADD_DELAYED_REF
 && 
š£¹_»£rved
) {

1716 
	`BUG_ON
(!
ex‹Á_İ
 || !ex‹Á_İ->
upd©e_æags
);

1717 
»t
 = 
	`®loc_»£rved_Œ“_block
(
Œªs
, 
node
, 
ex‹Á_İ
);

1718 } ià(
node
->
aùiÚ
 =ğ
BTRFS_ADD_DELAYED_REF
) {

1719 
»t
 = 
	`__bŒfs_šc_ex‹Á_»f
(
Œªs
, 
node
, 
·»Á
, 
»f_roÙ
,

1720 
»f
->
Ëv–
, 0, 1, 
ex‹Á_İ
);

1721 } ià(
node
->
aùiÚ
 =ğ
BTRFS_DROP_DELAYED_REF
) {

1722 
»t
 = 
	`__bŒfs_ä“_ex‹Á
(
Œªs
, 
node
, 
·»Á
, 
»f_roÙ
,

1723 
»f
->
Ëv–
, 0, 1, 
ex‹Á_İ
);

1725 
	`BUG
();

1727  
»t
;

1728 
	}
}

1731 
	$run_Úe_d–ayed_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1732 
bŒfs_d–ayed_»f_node
 *
node
,

1733 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
,

1734 
boŞ
 
š£¹_»£rved
)

1736 
»t
 = 0;

1738 ià(
	`TRANS_ABORTED
(
Œªs
)) {

1739 ià(
š£¹_»£rved
)

1740 
	`bŒfs_pš_ex‹Á
(
Œªs
, 
node
->
by‹Ä
,‚ode->
num_by‹s
, 1);

1744 ià(
node
->
ty³
 =ğ
BTRFS_TREE_BLOCK_REF_KEY
 ||

1745 
node
->
ty³
 =ğ
BTRFS_SHARED_BLOCK_REF_KEY
)

1746 
»t
 = 
	`run_d–ayed_Œ“_»f
(
Œªs
, 
node
, 
ex‹Á_İ
,

1747 
š£¹_»£rved
);

1748 ià(
node
->
ty³
 =ğ
BTRFS_EXTENT_DATA_REF_KEY
 ||

1749 
node
->
ty³
 =ğ
BTRFS_SHARED_DATA_REF_KEY
)

1750 
»t
 = 
	`run_d–ayed_d©a_»f
(
Œªs
, 
node
, 
ex‹Á_İ
,

1751 
š£¹_»£rved
);

1753 
	`BUG
();

1754 ià(
»t
 && 
š£¹_»£rved
)

1755 
	`bŒfs_pš_ex‹Á
(
Œªs
, 
node
->
by‹Ä
,‚ode->
num_by‹s
, 1);

1756 ià(
»t
 < 0)

1757 
	`bŒfs_”r
(
Œªs
->
fs_šfo
,

1759 
node
->
by‹Ä
,‚ode->
num_by‹s
,‚ode->
ty³
,

1760 
node
->
aùiÚ
,‚ode->
»f_mod
, 
»t
);

1761  
»t
;

1762 
	}
}

1764 
šlše
 
bŒfs_d–ayed_»f_node
 *

1765 
	$£Ëù_d–ayed_»f
(
bŒfs_d–ayed_»f_h—d
 *
h—d
)

1767 
bŒfs_d–ayed_»f_node
 *
»f
;

1769 ià(
	`RB_EMPTY_ROOT
(&
h—d
->
»f_Œ“
.
rb_roÙ
))

1770  
NULL
;

1778 ià(!
	`li¡_em±y
(&
h—d
->
»f_add_li¡
))

1779  
	`li¡_fœ¡_’Œy
(&
h—d
->
»f_add_li¡
,

1780 
bŒfs_d–ayed_»f_node
, 
add_li¡
);

1782 
»f
 = 
	`rb_’Œy
(
	`rb_fœ¡_ÿched
(&
h—d
->
»f_Œ“
),

1783 
bŒfs_d–ayed_»f_node
, 
»f_node
);

1784 
	`ASSERT
(
	`li¡_em±y
(&
»f
->
add_li¡
));

1785  
»f
;

1786 
	}
}

1788 
	$un£Ëù_d–ayed_»f_h—d
(
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

1789 
bŒfs_d–ayed_»f_h—d
 *
h—d
)

1791 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

1792 
h—d
->
´oûssšg
 = 
çl£
;

1793 
d–ayed_»fs
->
num_h—ds_»ady
++;

1794 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

1795 
	`bŒfs_d–ayed_»f_uÆock
(
h—d
);

1796 
	}
}

1798 
bŒfs_d–ayed_ex‹Á_İ
 *
	$ş—nup_ex‹Á_İ
(

1799 
bŒfs_d–ayed_»f_h—d
 *
h—d
)

1801 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
 = 
h—d
->extent_op;

1803 ià(!
ex‹Á_İ
)

1804  
NULL
;

1806 ià(
h—d
->
mu¡_š£¹_»£rved
) {

1807 
h—d
->
ex‹Á_İ
 = 
NULL
;

1808 
	`bŒfs_ä“_d–ayed_ex‹Á_İ
(
ex‹Á_İ
);

1809  
NULL
;

1811  
ex‹Á_İ
;

1812 
	}
}

1814 
	$run_ªd_ş—nup_ex‹Á_İ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1815 
bŒfs_d–ayed_»f_h—d
 *
h—d
)

1817 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
;

1818 
»t
;

1820 
ex‹Á_İ
 = 
	`ş—nup_ex‹Á_İ
(
h—d
);

1821 ià(!
ex‹Á_İ
)

1823 
h—d
->
ex‹Á_İ
 = 
NULL
;

1824 
	`¥š_uÆock
(&
h—d
->
lock
);

1825 
»t
 = 
	`run_d–ayed_ex‹Á_İ
(
Œªs
, 
h—d
, 
ex‹Á_İ
);

1826 
	`bŒfs_ä“_d–ayed_ex‹Á_İ
(
ex‹Á_İ
);

1827  
»t
 ?„et : 1;

1828 
	}
}

1830 
	$bŒfs_ş—nup_»f_h—d_accouÁšg
(
bŒfs_fs_šfo
 *
fs_šfo
,

1831 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

1832 
bŒfs_d–ayed_»f_h—d
 *
h—d
)

1834 
Ä_™ems
 = 1;

1840 ià(
h—d
->
tÙ®_»f_mod
 < 0 && h—d->
is_d©a
) {

1841 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

1842 
d–ayed_»fs
->
³ndšg_csums
 -ğ
h—d
->
num_by‹s
;

1843 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

1844 
Ä_™ems
 +ğ
	`bŒfs_csum_by‹s_to_Ëaves
(
fs_šfo
, 
h—d
->
num_by‹s
);

1847 
	`bŒfs_d–ayed_»fs_rsv_»Ëa£
(
fs_šfo
, 
Ä_™ems
);

1848 
	}
}

1850 
	$ş—nup_»f_h—d
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1851 
bŒfs_d–ayed_»f_h—d
 *
h—d
)

1854 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1855 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

1856 
»t
;

1858 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

1860 
»t
 = 
	`run_ªd_ş—nup_ex‹Á_İ
(
Œªs
, 
h—d
);

1861 ià(
»t
 < 0) {

1862 
	`un£Ëù_d–ayed_»f_h—d
(
d–ayed_»fs
, 
h—d
);

1863 
	`bŒfs_debug
(
fs_šfo
, "run_d–ayed_ex‹Á_İ„‘uºed %d", 
»t
);

1864  
»t
;

1865 } ià(
»t
) {

1866  
»t
;

1873 
	`¥š_uÆock
(&
h—d
->
lock
);

1874 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

1875 
	`¥š_lock
(&
h—d
->
lock
);

1876 ià(!
	`RB_EMPTY_ROOT
(&
h—d
->
»f_Œ“
.
rb_roÙ
è|| h—d->
ex‹Á_İ
) {

1877 
	`¥š_uÆock
(&
h—d
->
lock
);

1878 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

1881 
	`bŒfs_d–‘e_»f_h—d
(
d–ayed_»fs
, 
h—d
);

1882 
	`¥š_uÆock
(&
h—d
->
lock
);

1883 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

1885 ià(
h—d
->
mu¡_š£¹_»£rved
) {

1886 
	`bŒfs_pš_ex‹Á
(
Œªs
, 
h—d
->
by‹Ä
, h—d->
num_by‹s
, 1);

1887 ià(
h—d
->
is_d©a
) {

1888 
bŒfs_roÙ
 *
csum_roÙ
;

1890 
csum_roÙ
 = 
	`bŒfs_csum_roÙ
(
fs_šfo
, 
h—d
->
by‹Ä
);

1891 
»t
 = 
	`bŒfs_d–_csums
(
Œªs
, 
csum_roÙ
, 
h—d
->
by‹Ä
,

1892 
h—d
->
num_by‹s
);

1896 
	`bŒfs_ş—nup_»f_h—d_accouÁšg
(
fs_šfo
, 
d–ayed_»fs
, 
h—d
);

1898 
	`Œaû_run_d–ayed_»f_h—d
(
fs_šfo
, 
h—d
, 0);

1899 
	`bŒfs_d–ayed_»f_uÆock
(
h—d
);

1900 
	`bŒfs_put_d–ayed_»f_h—d
(
h—d
);

1901  
»t
;

1902 
	}
}

1904 
bŒfs_d–ayed_»f_h—d
 *
	$bŒfs_obš_»f_h—d
(

1905 
bŒfs_Œªs_hªdË
 *
Œªs
)

1907 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
 =

1908 &
Œªs
->
Œª§ùiÚ
->
d–ayed_»fs
;

1909 
bŒfs_d–ayed_»f_h—d
 *
h—d
 = 
NULL
;

1910 
»t
;

1912 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

1913 
h—d
 = 
	`bŒfs_£Ëù_»f_h—d
(
d–ayed_»fs
);

1914 ià(!
h—d
) {

1915 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

1916  
h—d
;

1923 
»t
 = 
	`bŒfs_d–ayed_»f_lock
(
d–ayed_»fs
, 
h—d
);

1924 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

1931 ià(
»t
 =ğ-
EAGAIN
)

1932 
h—d
 = 
	`ERR_PTR
(-
EAGAIN
);

1934  
h—d
;

1935 
	}
}

1937 
	$bŒfs_run_d–ayed_»fs_fÜ_h—d
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1938 
bŒfs_d–ayed_»f_h—d
 *
locked_»f
)

1940 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1941 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

1942 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
;

1943 
bŒfs_d–ayed_»f_node
 *
»f
;

1944 
boŞ
 
mu¡_š£¹_»£rved
;

1945 
»t
;

1947 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

1949 
	`lockd•_as£¹_h–d
(&
locked_»f
->
mu‹x
);

1950 
	`lockd•_as£¹_h–d
(&
locked_»f
->
lock
);

1952 (
»f
 = 
	`£Ëù_d–ayed_»f
(
locked_»f
))) {

1953 ià(
»f
->
£q
 &&

1954 
	`bŒfs_check_d–ayed_£q
(
fs_šfo
, 
»f
->
£q
)) {

1955 
	`¥š_uÆock
(&
locked_»f
->
lock
);

1956 
	`un£Ëù_d–ayed_»f_h—d
(
d–ayed_»fs
, 
locked_»f
);

1957  -
EAGAIN
;

1960 
	`rb_”a£_ÿched
(&
»f
->
»f_node
, &
locked_»f
->
»f_Œ“
);

1961 
	`RB_CLEAR_NODE
(&
»f
->
»f_node
);

1962 ià(!
	`li¡_em±y
(&
»f
->
add_li¡
))

1963 
	`li¡_d–
(&
»f
->
add_li¡
);

1968 
»f
->
aùiÚ
) {

1969 
BTRFS_ADD_DELAYED_REF
:

1970 
BTRFS_ADD_DELAYED_EXTENT
:

1971 
locked_»f
->
»f_mod
 -ğ
»f
->ref_mod;

1973 
BTRFS_DROP_DELAYED_REF
:

1974 
locked_»f
->
»f_mod
 +ğ
»f
->ref_mod;

1977 
	`WARN_ON
(1);

1979 
	`©omic_dec
(&
d–ayed_»fs
->
num_’Œ›s
);

1985 
mu¡_š£¹_»£rved
 = 
locked_»f
->must_insert_reserved;

1986 
locked_»f
->
mu¡_š£¹_»£rved
 = 
çl£
;

1988 
ex‹Á_İ
 = 
locked_»f
->extent_op;

1989 
locked_»f
->
ex‹Á_İ
 = 
NULL
;

1990 
	`¥š_uÆock
(&
locked_»f
->
lock
);

1992 
»t
 = 
	`run_Úe_d–ayed_»f
(
Œªs
, 
»f
, 
ex‹Á_İ
,

1993 
mu¡_š£¹_»£rved
);

1995 
	`bŒfs_ä“_d–ayed_ex‹Á_İ
(
ex‹Á_İ
);

1996 ià(
»t
) {

1997 
	`un£Ëù_d–ayed_»f_h—d
(
d–ayed_»fs
, 
locked_»f
);

1998 
	`bŒfs_put_d–ayed_»f
(
»f
);

1999  
»t
;

2002 
	`bŒfs_put_d–ayed_»f
(
»f
);

2003 
	`cÚd_»sched
();

2005 
	`¥š_lock
(&
locked_»f
->
lock
);

2006 
	`bŒfs_m”ge_d–ayed_»fs
(
fs_šfo
, 
d–ayed_»fs
, 
locked_»f
);

2010 
	}
}

2016 
nošlše
 
	$__bŒfs_run_d–ayed_»fs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2017 
Ä
)

2019 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2020 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

2021 
bŒfs_d–ayed_»f_h—d
 *
locked_»f
 = 
NULL
;

2022 
»t
;

2023 
couÁ
 = 0;

2025 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

2027 ià(!
locked_»f
) {

2028 
locked_»f
 = 
	`bŒfs_obš_»f_h—d
(
Œªs
);

2029 ià(
	`IS_ERR_OR_NULL
(
locked_»f
)) {

2030 ià(
	`PTR_ERR
(
locked_»f
è=ğ-
EAGAIN
) {

2036 
couÁ
++;

2050 
	`¥š_lock
(&
locked_»f
->
lock
);

2051 
	`bŒfs_m”ge_d–ayed_»fs
(
fs_šfo
, 
d–ayed_»fs
, 
locked_»f
);

2053 
»t
 = 
	`bŒfs_run_d–ayed_»fs_fÜ_h—d
(
Œªs
, 
locked_»f
);

2054 ià(
»t
 < 0 &&„‘ !ğ-
EAGAIN
) {

2059  
»t
;

2060 } ià(!
»t
) {

2065 
»t
 = 
	`ş—nup_»f_h—d
(
Œªs
, 
locked_»f
);

2066 ià(
»t
 > 0 ) {

2068 
»t
 = 0;

2070 } ià(
»t
) {

2071  
»t
;

2080 
locked_»f
 = 
NULL
;

2081 
	`cÚd_»sched
();

2082 } (
Ä
 !ğ-1 && 
couÁ
 <‚rè|| 
locked_»f
);

2085 
	}
}

2087 #ifdeà
SCRAMBLE_DELAYED_REFS


2093 
u64
 
	$fšd_middË
(
rb_roÙ
 *
roÙ
)

2095 
rb_node
 *
n
 = 
roÙ
->rb_node;

2096 
bŒfs_d–ayed_»f_node
 *
’Œy
;

2097 
®t
 = 1;

2098 
u64
 
middË
;

2099 
u64
 
fœ¡
 = 0, 
Ï¡
 = 0;

2101 
n
 = 
	`rb_fœ¡
(
roÙ
);

2102 ià(
n
) {

2103 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_d–ayed_»f_node
, 
rb_node
);

2104 
fœ¡
 = 
’Œy
->
by‹Ä
;

2106 
n
 = 
	`rb_Ï¡
(
roÙ
);

2107 ià(
n
) {

2108 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_d–ayed_»f_node
, 
rb_node
);

2109 
Ï¡
 = 
’Œy
->
by‹Ä
;

2111 
n
 = 
roÙ
->
rb_node
;

2113 
n
) {

2114 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_d–ayed_»f_node
, 
rb_node
);

2115 
	`WARN_ON
(!
’Œy
->
š_Œ“
);

2117 
middË
 = 
’Œy
->
by‹Ä
;

2119 ià(
®t
)

2120 
n
 =‚->
rb_Ëá
;

2122 
n
 =‚->
rb_right
;

2124 
®t
 = 1 -‡lt;

2126  
middË
;

2127 
	}
}

2140 
	$bŒfs_run_d–ayed_»fs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2141 
couÁ
)

2143 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2144 
rb_node
 *
node
;

2145 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

2146 
bŒfs_d–ayed_»f_h—d
 *
h—d
;

2147 
»t
;

2148 
run_®l
 = 
couÁ
 == ()-1;

2151 ià(
	`TRANS_ABORTED
(
Œªs
))

2154 ià(
	`‹¡_b™
(
BTRFS_FS_CREATING_FREE_SPACE_TREE
, &
fs_šfo
->
æags
))

2157 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

2158 ià(
couÁ
 == 0)

2159 
couÁ
 = 
d–ayed_»fs
->
num_h—ds_»ady
;

2161 
agaš
:

2162 #ifdeà
SCRAMBLE_DELAYED_REFS


2163 
d–ayed_»fs
->
run_d–ayed_¡¬t
 = 
	`fšd_middË
(&d–ayed_»fs->
roÙ
);

2165 
»t
 = 
	`__bŒfs_run_d–ayed_»fs
(
Œªs
, 
couÁ
);

2166 ià(
»t
 < 0) {

2167 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2168  
»t
;

2171 ià(
run_®l
) {

2172 
	`bŒfs_ü—‹_³ndšg_block_groups
(
Œªs
);

2174 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

2175 
node
 = 
	`rb_fœ¡_ÿched
(&
d–ayed_»fs
->
h»f_roÙ
);

2176 ià(!
node
) {

2177 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

2178 
out
;

2180 
h—d
 = 
	`rb_’Œy
(
node
, 
bŒfs_d–ayed_»f_h—d
,

2181 
h»f_node
);

2182 
	`»fcouÁ_šc
(&
h—d
->
»fs
);

2183 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

2186 
	`mu‹x_lock
(&
h—d
->
mu‹x
);

2187 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

2189 
	`bŒfs_put_d–ayed_»f_h—d
(
h—d
);

2190 
	`cÚd_»sched
();

2191 
agaš
;

2193 
out
:

2195 
	}
}

2197 
	$bŒfs_£t_disk_ex‹Á_æags
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2198 
ex‹Á_bufãr
 *
eb
, 
u64
 
æags
)

2200 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
;

2201 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
eb
);

2202 
»t
;

2204 
ex‹Á_İ
 = 
	`bŒfs_®loc_d–ayed_ex‹Á_İ
();

2205 ià(!
ex‹Á_İ
)

2206  -
ENOMEM
;

2208 
ex‹Á_İ
->
æags_to_£t
 = 
æags
;

2209 
ex‹Á_İ
->
upd©e_æags
 = 
Œue
;

2210 
ex‹Á_İ
->
upd©e_key
 = 
çl£
;

2211 
ex‹Á_İ
->
Ëv–
 =†evel;

2213 
»t
 = 
	`bŒfs_add_d–ayed_ex‹Á_İ
(
Œªs
, 
eb
->
¡¬t
,ƒb->
Ën
, 
ex‹Á_İ
);

2214 ià(
»t
)

2215 
	`bŒfs_ä“_d–ayed_ex‹Á_İ
(
ex‹Á_İ
);

2216  
»t
;

2217 
	}
}

2219 
nošlše
 
	$check_d–ayed_»f
(
bŒfs_roÙ
 *
roÙ
,

2220 
bŒfs_·th
 *
·th
,

2221 
u64
 
objeùid
, u64 
off£t
, u64 
by‹Ä
)

2223 
bŒfs_d–ayed_»f_h—d
 *
h—d
;

2224 
bŒfs_d–ayed_»f_node
 *
»f
;

2225 
bŒfs_d–ayed_d©a_»f
 *
d©a_»f
;

2226 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

2227 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
;

2228 
rb_node
 *
node
;

2229 
»t
 = 0;

2231 
	`¥š_lock
(&
roÙ
->
fs_šfo
->
Œªs_lock
);

2232 
cur_Œªs
 = 
roÙ
->
fs_šfo
->
ruÂšg_Œª§ùiÚ
;

2233 ià(
cur_Œªs
)

2234 
	`»fcouÁ_šc
(&
cur_Œªs
->
u£_couÁ
);

2235 
	`¥š_uÆock
(&
roÙ
->
fs_šfo
->
Œªs_lock
);

2236 ià(!
cur_Œªs
)

2239 
d–ayed_»fs
 = &
cur_Œªs
->delayed_refs;

2240 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

2241 
h—d
 = 
	`bŒfs_fšd_d–ayed_»f_h—d
(
d–ayed_»fs
, 
by‹Ä
);

2242 ià(!
h—d
) {

2243 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

2244 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

2248 ià(!
	`mu‹x_Œylock
(&
h—d
->
mu‹x
)) {

2249 ià(
·th
->
nowa™
) {

2250 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

2251 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

2252  -
EAGAIN
;

2255 
	`»fcouÁ_šc
(&
h—d
->
»fs
);

2256 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

2258 
	`bŒfs_»Ëa£_·th
(
·th
);

2264 
	`mu‹x_lock
(&
h—d
->
mu‹x
);

2265 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

2266 
	`bŒfs_put_d–ayed_»f_h—d
(
h—d
);

2267 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

2268  -
EAGAIN
;

2270 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

2272 
	`¥š_lock
(&
h—d
->
lock
);

2277 
node
 = 
	`rb_fœ¡_ÿched
(&
h—d
->
»f_Œ“
);‚ode;

2278 
node
 = 
	`rb_Ãxt
(node)) {

2279 
»f
 = 
	`rb_’Œy
(
node
, 
bŒfs_d–ayed_»f_node
, 
»f_node
);

2281 ià(
»f
->
ty³
 !ğ
BTRFS_EXTENT_DATA_REF_KEY
) {

2282 
»t
 = 1;

2286 
d©a_»f
 = 
	`bŒfs_d–ayed_node_to_d©a_»f
(
»f
);

2292 ià(
d©a_»f
->
roÙ
 !ğroÙ->
roÙ_key
.
objeùid
 ||

2293 
d©a_»f
->
objeùid
 != objectid ||

2294 
d©a_»f
->
off£t
 != offset) {

2295 
»t
 = 1;

2299 
	`¥š_uÆock
(&
h—d
->
lock
);

2300 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

2301 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

2302  
»t
;

2303 
	}
}

2305 
nošlše
 
	$check_comm™‹d_»f
(
bŒfs_roÙ
 *
roÙ
,

2306 
bŒfs_·th
 *
·th
,

2307 
u64
 
objeùid
, u64 
off£t
, u64 
by‹Ä
,

2308 
boŞ
 
¡riù
)

2310 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2311 
bŒfs_roÙ
 *
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 
by‹Ä
);

2312 
ex‹Á_bufãr
 *
Ëaf
;

2313 
bŒfs_ex‹Á_d©a_»f
 *
»f
;

2314 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

2315 
bŒfs_ex‹Á_™em
 *
ei
;

2316 
bŒfs_key
 
key
;

2317 
u32
 
™em_size
;

2318 
ty³
;

2319 
»t
;

2321 
key
.
objeùid
 = 
by‹Ä
;

2322 
key
.
off£t
 = (
u64
)-1;

2323 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

2325 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
ex‹Á_roÙ
, &
key
, 
·th
, 0, 0);

2326 ià(
»t
 < 0)

2327 
out
;

2328 
	`BUG_ON
(
»t
 == 0);

2330 
»t
 = -
ENOENT
;

2331 ià(
·th
->
¦Ùs
[0] == 0)

2332 
out
;

2334 
·th
->
¦Ùs
[0]--;

2335 
Ëaf
 = 
·th
->
nodes
[0];

2336 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

2338 ià(
key
.
objeùid
 !ğ
by‹Ä
 || key.
ty³
 !ğ
BTRFS_EXTENT_ITEM_KEY
)

2339 
out
;

2341 
»t
 = 1;

2342 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

2343 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

2346 ià(
™em_size
 !ğ(*
ei
) +

2347 
	`bŒfs_ex‹Á_šlše_»f_size
(
BTRFS_EXTENT_DATA_REF_KEY
))

2348 
out
;

2354 ià(!
¡riù
 &&

2355 (
	`bŒfs_ex‹Á_g’”©iÚ
(
Ëaf
, 
ei
) <=

2356 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
)))

2357 
out
;

2359 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
ei
 + 1);

2362 
ty³
 = 
	`bŒfs_g‘_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
, 
BTRFS_REF_TYPE_DATA
);

2363 ià(
ty³
 !ğ
BTRFS_EXTENT_DATA_REF_KEY
)

2364 
out
;

2366 
»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

2367 ià(
	`bŒfs_ex‹Á_»fs
(
Ëaf
, 
ei
) !=

2368 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f
) ||

2369 
	`bŒfs_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
»f
) !=

2370 
roÙ
->
roÙ_key
.
objeùid
 ||

2371 
	`bŒfs_ex‹Á_d©a_»f_objeùid
(
Ëaf
, 
»f
è!ğ
objeùid
 ||

2372 
	`bŒfs_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
»f
è!ğ
off£t
)

2373 
out
;

2375 
»t
 = 0;

2376 
out
:

2377  
»t
;

2378 
	}
}

2380 
	$bŒfs_üoss_»f_exi¡
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
objeùid
, u64 
off£t
,

2381 
u64
 
by‹Ä
, 
boŞ
 
¡riù
, 
bŒfs_·th
 *
·th
)

2383 
»t
;

2386 
»t
 = 
	`check_comm™‹d_»f
(
roÙ
, 
·th
, 
objeùid
,

2387 
off£t
, 
by‹Ä
, 
¡riù
);

2388 ià(
»t
 &&„‘ !ğ-
ENOENT
)

2389 
out
;

2391 
»t
 = 
	`check_d–ayed_»f
(
roÙ
, 
·th
, 
objeùid
, 
off£t
, 
by‹Ä
);

2392 } 
»t
 =ğ-
EAGAIN
);

2394 
out
:

2395 
	`bŒfs_»Ëa£_·th
(
·th
);

2396 ià(
	`bŒfs_is_d©a_»loc_roÙ
(
roÙ
))

2397 
	`WARN_ON
(
»t
 > 0);

2398  
»t
;

2399 
	}
}

2401 
	$__bŒfs_mod_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2402 
bŒfs_roÙ
 *
roÙ
,

2403 
ex‹Á_bufãr
 *
buf
,

2404 
fuÎ_back»f
, 
šc
)

2406 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2407 
u64
 
by‹Ä
;

2408 
u64
 
num_by‹s
;

2409 
u64
 
·»Á
;

2410 
u64
 
»f_roÙ
;

2411 
u32
 
Ä™ems
;

2412 
bŒfs_key
 
key
;

2413 
bŒfs_fe_ex‹Á_™em
 *
fi
;

2414 
bŒfs_»f
 
g’”ic_»f
 = { 0 };

2415 
boŞ
 
fÜ_»loc
 = 
	`bŒfs_h—d”_æag
(
buf
, 
BTRFS_HEADER_FLAG_RELOC
);

2416 
i
;

2417 
aùiÚ
;

2418 
Ëv–
;

2419 
»t
 = 0;

2421 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
))

2424 
»f_roÙ
 = 
	`bŒfs_h—d”_owÃr
(
buf
);

2425 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
buf
);

2426 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
buf
);

2428 ià(!
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
è&& 
Ëv–
 == 0)

2431 ià(
fuÎ_back»f
)

2432 
·»Á
 = 
buf
->
¡¬t
;

2434 
·»Á
 = 0;

2435 ià(
šc
)

2436 
aùiÚ
 = 
BTRFS_ADD_DELAYED_REF
;

2438 
aùiÚ
 = 
BTRFS_DROP_DELAYED_REF
;

2440 
i
 = 0; i < 
Ä™ems
; i++) {

2441 ià(
Ëv–
 == 0) {

2442 
	`bŒfs_™em_key_to_ıu
(
buf
, &
key
, 
i
);

2443 ià(
key
.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

2445 
fi
 = 
	`bŒfs_™em_±r
(
buf
, 
i
,

2446 
bŒfs_fe_ex‹Á_™em
);

2447 ià(
	`bŒfs_fe_ex‹Á_ty³
(
buf
, 
fi
) ==

2448 
BTRFS_FILE_EXTENT_INLINE
)

2450 
by‹Ä
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
buf
, 
fi
);

2451 ià(
by‹Ä
 == 0)

2454 
num_by‹s
 = 
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
buf
, 
fi
);

2455 
key
.
off£t
 -ğ
	`bŒfs_fe_ex‹Á_off£t
(
buf
, 
fi
);

2456 
	`bŒfs_š™_g’”ic_»f
(&
g’”ic_»f
, 
aùiÚ
, 
by‹Ä
,

2457 
num_by‹s
, 
·»Á
);

2458 
	`bŒfs_š™_d©a_»f
(&
g’”ic_»f
, 
»f_roÙ
, 
key
.
objeùid
,

2459 
key
.
off£t
, 
roÙ
->
roÙ_key
.
objeùid
,

2460 
fÜ_»loc
);

2461 ià(
šc
)

2462 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, &
g’”ic_»f
);

2464 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, &
g’”ic_»f
);

2465 ià(
»t
)

2466 
ç
;

2468 
by‹Ä
 = 
	`bŒfs_node_block±r
(
buf
, 
i
);

2469 
num_by‹s
 = 
fs_šfo
->
nodesize
;

2470 
	`bŒfs_š™_g’”ic_»f
(&
g’”ic_»f
, 
aùiÚ
, 
by‹Ä
,

2471 
num_by‹s
, 
·»Á
);

2472 
	`bŒfs_š™_Œ“_»f
(&
g’”ic_»f
, 
Ëv–
 - 1, 
»f_roÙ
,

2473 
roÙ
->
roÙ_key
.
objeùid
, 
fÜ_»loc
);

2474 ià(
šc
)

2475 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, &
g’”ic_»f
);

2477 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, &
g’”ic_»f
);

2478 ià(
»t
)

2479 
ç
;

2483 
ç
:

2484  
»t
;

2485 
	}
}

2487 
	$bŒfs_šc_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

2488 
ex‹Á_bufãr
 *
buf
, 
fuÎ_back»f
)

2490  
	`__bŒfs_mod_»f
(
Œªs
, 
roÙ
, 
buf
, 
fuÎ_back»f
, 1);

2491 
	}
}

2493 
	$bŒfs_dec_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

2494 
ex‹Á_bufãr
 *
buf
, 
fuÎ_back»f
)

2496  
	`__bŒfs_mod_»f
(
Œªs
, 
roÙ
, 
buf
, 
fuÎ_back»f
, 0);

2497 
	}
}

2499 
u64
 
	$g‘_®loc_´ofe_by_roÙ
(
bŒfs_roÙ
 *
roÙ
, 
d©a
)

2501 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2502 
u64
 
æags
;

2503 
u64
 
»t
;

2505 ià(
d©a
)

2506 
æags
 = 
BTRFS_BLOCK_GROUP_DATA
;

2507 ià(
roÙ
 =ğ
fs_šfo
->
chunk_roÙ
)

2508 
æags
 = 
BTRFS_BLOCK_GROUP_SYSTEM
;

2510 
æags
 = 
BTRFS_BLOCK_GROUP_METADATA
;

2512 
»t
 = 
	`bŒfs_g‘_®loc_´ofe
(
fs_šfo
, 
æags
);

2513  
»t
;

2514 
	}
}

2516 
u64
 
	$fœ¡_logiÿl_by‹
(
bŒfs_fs_šfo
 *
fs_šfo
)

2518 
rb_node
 *
Ëámo¡
;

2519 
u64
 
by‹Ä
 = 0;

2521 
	`»ad_lock
(&
fs_šfo
->
block_group_ÿche_lock
);

2523 
Ëámo¡
 = 
	`rb_fœ¡_ÿched
(&
fs_šfo
->
block_group_ÿche_Œ“
);

2524 ià(
Ëámo¡
) {

2525 
bŒfs_block_group
 *
bg
;

2527 
bg
 = 
	`rb_’Œy
(
Ëámo¡
, 
bŒfs_block_group
, 
ÿche_node
);

2528 
by‹Ä
 = 
bg
->
¡¬t
;

2530 
	`»ad_uÆock
(&
fs_šfo
->
block_group_ÿche_lock
);

2532  
by‹Ä
;

2533 
	}
}

2535 
	$pš_down_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2536 
bŒfs_block_group
 *
ÿche
,

2537 
u64
 
by‹Ä
, u64 
num_by‹s
, 
»£rved
)

2539 
bŒfs_fs_šfo
 *
fs_šfo
 = 
ÿche
->fs_info;

2541 
	`¥š_lock
(&
ÿche
->
¥aû_šfo
->
lock
);

2542 
	`¥š_lock
(&
ÿche
->
lock
);

2543 
ÿche
->
pšÃd
 +ğ
num_by‹s
;

2544 
	`bŒfs_¥aû_šfo_upd©e_by‹s_pšÃd
(
fs_šfo
, 
ÿche
->
¥aû_šfo
,

2545 
num_by‹s
);

2546 ià(
»£rved
) {

2547 
ÿche
->
»£rved
 -ğ
num_by‹s
;

2548 
ÿche
->
¥aû_šfo
->
by‹s_»£rved
 -ğ
num_by‹s
;

2550 
	`¥š_uÆock
(&
ÿche
->
lock
);

2551 
	`¥š_uÆock
(&
ÿche
->
¥aû_šfo
->
lock
);

2553 
	`£t_ex‹Á_b™
(&
Œªs
->
Œª§ùiÚ
->
pšÃd_ex‹Ás
, 
by‹Ä
,

2554 
by‹Ä
 + 
num_by‹s
 - 1, 
EXTENT_DIRTY
, 
NULL
);

2556 
	}
}

2558 
	$bŒfs_pš_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2559 
u64
 
by‹Ä
, u64 
num_by‹s
, 
»£rved
)

2561 
bŒfs_block_group
 *
ÿche
;

2563 
ÿche
 = 
	`bŒfs_lookup_block_group
(
Œªs
->
fs_šfo
, 
by‹Ä
);

2564 
	`BUG_ON
(!
ÿche
);

2566 
	`pš_down_ex‹Á
(
Œªs
, 
ÿche
, 
by‹Ä
, 
num_by‹s
, 
»£rved
);

2568 
	`bŒfs_put_block_group
(
ÿche
);

2570 
	}
}

2575 
	$bŒfs_pš_ex‹Á_fÜ_log_»¶ay
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2576 
u64
 
by‹Ä
, u64 
num_by‹s
)

2578 
bŒfs_block_group
 *
ÿche
;

2579 
»t
;

2581 
ÿche
 = 
	`bŒfs_lookup_block_group
(
Œªs
->
fs_šfo
, 
by‹Ä
);

2582 ià(!
ÿche
)

2583  -
EINVAL
;

2589 
»t
 = 
	`bŒfs_ÿche_block_group
(
ÿche
, 
Œue
);

2590 ià(
»t
)

2591 
out
;

2593 
	`pš_down_ex‹Á
(
Œªs
, 
ÿche
, 
by‹Ä
, 
num_by‹s
, 0);

2596 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 
by‹Ä
, 
num_by‹s
);

2597 
out
:

2598 
	`bŒfs_put_block_group
(
ÿche
);

2599  
»t
;

2600 
	}
}

2602 
	$__exşude_logged_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

2603 
u64
 
¡¬t
, u64 
num_by‹s
)

2605 
»t
;

2606 
bŒfs_block_group
 *
block_group
;

2608 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
¡¬t
);

2609 ià(!
block_group
)

2610  -
EINVAL
;

2612 
»t
 = 
	`bŒfs_ÿche_block_group
(
block_group
, 
Œue
);

2613 ià(
»t
)

2614 
out
;

2616 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
block_group
, 
¡¬t
, 
num_by‹s
);

2617 
out
:

2618 
	`bŒfs_put_block_group
(
block_group
);

2619  
»t
;

2620 
	}
}

2622 
	$bŒfs_exşude_logged_ex‹Ás
(
ex‹Á_bufãr
 *
eb
)

2624 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

2625 
bŒfs_fe_ex‹Á_™em
 *
™em
;

2626 
bŒfs_key
 
key
;

2627 
found_ty³
;

2628 
i
;

2629 
»t
 = 0;

2631 ià(!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
MIXED_GROUPS
))

2634 
i
 = 0; i < 
	`bŒfs_h—d”_Ä™ems
(
eb
); i++) {

2635 
	`bŒfs_™em_key_to_ıu
(
eb
, &
key
, 
i
);

2636 ià(
key
.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

2638 
™em
 = 
	`bŒfs_™em_±r
(
eb
, 
i
, 
bŒfs_fe_ex‹Á_™em
);

2639 
found_ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
eb
, 
™em
);

2640 ià(
found_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
)

2642 ià(
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
eb
, 
™em
) == 0)

2644 
key
.
objeùid
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
eb
, 
™em
);

2645 
key
.
off£t
 = 
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
eb
, 
™em
);

2646 
»t
 = 
	`__exşude_logged_ex‹Á
(
fs_šfo
, 
key
.
objeùid
, key.
off£t
);

2647 ià(
»t
)

2651  
»t
;

2652 
	}
}

2655 
	$bŒfs_šc_block_group_»£rv©iÚs
(
bŒfs_block_group
 *
bg
)

2657 
	`©omic_šc
(&
bg
->
»£rv©iÚs
);

2658 
	}
}

2664 
bŒfs_ä“_şu¡”
 *

2665 
	$ãtch_şu¡”_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
,

2666 
bŒfs_¥aû_šfo
 *
¥aû_šfo
, 
u64
 *
em±y_şu¡”
)

2668 
bŒfs_ä“_şu¡”
 *
»t
 = 
NULL
;

2670 *
em±y_şu¡”
 = 0;

2671 ià(
	`bŒfs_mixed_¥aû_šfo
(
¥aû_šfo
))

2672  
»t
;

2674 ià(
¥aû_šfo
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
) {

2675 
»t
 = &
fs_šfo
->
m‘a_®loc_şu¡”
;

2676 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
SSD
))

2677 *
em±y_şu¡”
 = 
SZ_2M
;

2679 *
em±y_şu¡”
 = 
SZ_64K
;

2680 } ià((
¥aû_šfo
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
) &&

2681 
	`bŒfs_‹¡_İt
(
fs_šfo
, 
SSD_SPREAD
)) {

2682 *
em±y_şu¡”
 = 
SZ_2M
;

2683 
»t
 = &
fs_šfo
->
d©a_®loc_şu¡”
;

2686  
»t
;

2687 
	}
}

2689 
	$uÅš_ex‹Á_¿nge
(
bŒfs_fs_šfo
 *
fs_šfo
,

2690 
u64
 
¡¬t
, u64 
’d
,

2691 cÚ¡ 
boŞ
 
»tuº_ä“_¥aû
)

2693 
bŒfs_block_group
 *
ÿche
 = 
NULL
;

2694 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

2695 
bŒfs_block_rsv
 *
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

2696 
bŒfs_ä“_şu¡”
 *
şu¡”
 = 
NULL
;

2697 
u64
 
Ën
;

2698 
u64
 
tÙ®_uÅšÃd
 = 0;

2699 
u64
 
em±y_şu¡”
 = 0;

2700 
boŞ
 
»adÚly
;

2702 
¡¬t
 <ğ
’d
) {

2703 
»adÚly
 = 
çl£
;

2704 ià(!
ÿche
 ||

2705 
¡¬t
 >ğ
ÿche
->¡¬ˆ+ cache->
Ëngth
) {

2706 ià(
ÿche
)

2707 
	`bŒfs_put_block_group
(
ÿche
);

2708 
tÙ®_uÅšÃd
 = 0;

2709 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
¡¬t
);

2710 
	`BUG_ON
(!
ÿche
);

2712 
şu¡”
 = 
	`ãtch_şu¡”_šfo
(
fs_šfo
,

2713 
ÿche
->
¥aû_šfo
,

2714 &
em±y_şu¡”
);

2715 
em±y_şu¡”
 <<= 1;

2718 
Ën
 = 
ÿche
->
¡¬t
 + cache->
Ëngth
 - start;

2719 
Ën
 = 
	`mš
Ö’, 
’d
 + 1 - 
¡¬t
);

2721 ià(
»tuº_ä“_¥aû
)

2722 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
¡¬t
, 
Ën
);

2724 
¡¬t
 +ğ
Ën
;

2725 
tÙ®_uÅšÃd
 +ğ
Ën
;

2726 
¥aû_šfo
 = 
ÿche
->space_info;

2734 ià(
şu¡”
 && clu¡”->
äagm’‹d
 &&

2735 
tÙ®_uÅšÃd
 > 
em±y_şu¡”
) {

2736 
	`¥š_lock
(&
şu¡”
->
lock
);

2737 
şu¡”
->
äagm’‹d
 = 0;

2738 
	`¥š_uÆock
(&
şu¡”
->
lock
);

2741 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

2742 
	`¥š_lock
(&
ÿche
->
lock
);

2743 
ÿche
->
pšÃd
 -ğ
Ën
;

2744 
	`bŒfs_¥aû_šfo_upd©e_by‹s_pšÃd
(
fs_šfo
, 
¥aû_šfo
, -
Ën
);

2745 
¥aû_šfo
->
max_ex‹Á_size
 = 0;

2746 ià(
ÿche
->
ro
) {

2747 
¥aû_šfo
->
by‹s_»adÚly
 +ğ
Ën
;

2748 
»adÚly
 = 
Œue
;

2749 } ià(
	`bŒfs_is_zÚed
(
fs_šfo
)) {

2751 
¥aû_šfo
->
by‹s_zÚe_unu§bË
 +ğ
Ën
;

2752 
»adÚly
 = 
Œue
;

2754 
	`¥š_uÆock
(&
ÿche
->
lock
);

2755 ià(!
»adÚly
 && 
»tuº_ä“_¥aû
 &&

2756 
glob®_rsv
->
¥aû_šfo
 == space_info) {

2757 
	`¥š_lock
(&
glob®_rsv
->
lock
);

2758 ià(!
glob®_rsv
->
fuÎ
) {

2759 
u64
 
to_add
 = 
	`mš
(
Ën
, 
glob®_rsv
->
size
 -

2760 
glob®_rsv
->
»£rved
);

2762 
glob®_rsv
->
»£rved
 +ğ
to_add
;

2763 
	`bŒfs_¥aû_šfo_upd©e_by‹s_may_u£
(
fs_šfo
,

2764 
¥aû_šfo
, 
to_add
);

2765 ià(
glob®_rsv
->
»£rved
 >ğglob®_rsv->
size
)

2766 
glob®_rsv
->
fuÎ
 = 1;

2767 
Ën
 -ğ
to_add
;

2769 
	`¥š_uÆock
(&
glob®_rsv
->
lock
);

2772 ià(!
»adÚly
 && 
»tuº_ä“_¥aû
 && 
Ën
)

2773 
	`bŒfs_Œy_g¿Ášg_tick‘s
(
fs_šfo
, 
¥aû_šfo
);

2774 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

2777 ià(
ÿche
)

2778 
	`bŒfs_put_block_group
(
ÿche
);

2780 
	}
}

2782 
	$bŒfs_fšish_ex‹Á_comm™
(
bŒfs_Œªs_hªdË
 *
Œªs
)

2784 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2785 
bŒfs_block_group
 *
block_group
, *
tmp
;

2786 
li¡_h—d
 *
d–‘ed_bgs
;

2787 
ex‹Á_io_Œ“
 *
uÅš
;

2788 
u64
 
¡¬t
;

2789 
u64
 
’d
;

2790 
»t
;

2792 
uÅš
 = &
Œªs
->
Œª§ùiÚ
->
pšÃd_ex‹Ás
;

2794 !
	`TRANS_ABORTED
(
Œªs
)) {

2795 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

2797 
	`mu‹x_lock
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

2798 ià(!
	`fšd_fœ¡_ex‹Á_b™
(
uÅš
, 0, &
¡¬t
, &
’d
,

2799 
EXTENT_DIRTY
, &
ÿched_¡©e
)) {

2800 
	`mu‹x_uÆock
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

2804 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DISCARD_SYNC
))

2805 
»t
 = 
	`bŒfs_disÿrd_ex‹Á
(
fs_šfo
, 
¡¬t
,

2806 
’d
 + 1 - 
¡¬t
, 
NULL
);

2808 
	`ş—r_ex‹Á_dœty
(
uÅš
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

2809 
	`uÅš_ex‹Á_¿nge
(
fs_šfo
, 
¡¬t
, 
’d
, 
Œue
);

2810 
	`mu‹x_uÆock
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

2811 
	`ä“_ex‹Á_¡©e
(
ÿched_¡©e
);

2812 
	`cÚd_»sched
();

2815 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DISCARD_ASYNC
)) {

2816 
	`bŒfs_disÿrd_ÿlc_d–ay
(&
fs_šfo
->
disÿrd_ùl
);

2817 
	`bŒfs_disÿrd_scheduË_wÜk
(&
fs_šfo
->
disÿrd_ùl
, 
Œue
);

2825 
d–‘ed_bgs
 = &
Œªs
->
Œª§ùiÚ
->deleted_bgs;

2826 
	`li¡_fÜ_—ch_’Œy_§ã
(
block_group
, 
tmp
, 
d–‘ed_bgs
, 
bg_li¡
) {

2827 
u64
 
Œimmed
 = 0;

2829 
»t
 = -
EROFS
;

2830 ià(!
	`TRANS_ABORTED
(
Œªs
))

2831 
»t
 = 
	`bŒfs_disÿrd_ex‹Á
(
fs_šfo
,

2832 
block_group
->
¡¬t
,

2833 
block_group
->
Ëngth
,

2834 &
Œimmed
);

2836 
	`li¡_d–_š™
(&
block_group
->
bg_li¡
);

2837 
	`bŒfs_unä“ze_block_group
(
block_group
);

2838 
	`bŒfs_put_block_group
(
block_group
);

2840 ià(
»t
) {

2841 cÚ¡ *
”r¡r
 = 
	`bŒfs_decode_”rÜ
(
»t
);

2842 
	`bŒfs_w¬n
(
fs_šfo
,

2844 
»t
, 
”r¡r
);

2849 
	}
}

2851 
	$do_ä“_ex‹Á_accouÁšg
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2852 
u64
 
by‹Ä
, u64 
num_by‹s
, 
boŞ
 
is_d©a
)

2854 
»t
;

2856 ià(
is_d©a
) {

2857 
bŒfs_roÙ
 *
csum_roÙ
;

2859 
csum_roÙ
 = 
	`bŒfs_csum_roÙ
(
Œªs
->
fs_šfo
, 
by‹Ä
);

2860 
»t
 = 
	`bŒfs_d–_csums
(
Œªs
, 
csum_roÙ
, 
by‹Ä
, 
num_by‹s
);

2861 ià(
»t
) {

2862 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2863  
»t
;

2867 
»t
 = 
	`add_to_ä“_¥aû_Œ“
(
Œªs
, 
by‹Ä
, 
num_by‹s
);

2868 ià(
»t
) {

2869 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2870  
»t
;

2873 
»t
 = 
	`bŒfs_upd©e_block_group
(
Œªs
, 
by‹Ä
, 
num_by‹s
, 
çl£
);

2874 ià(
»t
)

2875 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2877  
»t
;

2878 
	}
}

2880 
	#abÜt_ªd_dump
(
Œªs
, 
·th
, 
fmt
, 
¬gs
...) \

2882 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, -
EUCLEAN
); \

2883 
	`bŒfs_´št_Ëaf
(
·th
->
nodes
[0]); \

2884 
	`bŒfs_ü™
(
Œªs
->
fs_šfo
, 
fmt
, ##
¬gs
); \

2885 })

	)

2946 
	$__bŒfs_ä“_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2947 
bŒfs_d–ayed_»f_node
 *
node
, 
u64
 
·»Á
,

2948 
u64
 
roÙ_objeùid
, u64 
owÃr_objeùid
,

2949 
u64
 
owÃr_off£t
, 
»fs_to_drİ
,

2950 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
)

2952 
bŒfs_fs_šfo
 *
šfo
 = 
Œªs
->
fs_šfo
;

2953 
bŒfs_key
 
key
;

2954 
bŒfs_·th
 *
·th
;

2955 
bŒfs_roÙ
 *
ex‹Á_roÙ
;

2956 
ex‹Á_bufãr
 *
Ëaf
;

2957 
bŒfs_ex‹Á_™em
 *
ei
;

2958 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

2959 
»t
;

2960 
is_d©a
;

2961 
ex‹Á_¦Ù
 = 0;

2962 
found_ex‹Á
 = 0;

2963 
num_to_d–
 = 1;

2964 
u32
 
™em_size
;

2965 
u64
 
»fs
;

2966 
u64
 
by‹Ä
 = 
node
->bytenr;

2967 
u64
 
num_by‹s
 = 
node
->num_bytes;

2968 
boŞ
 
skšny_m‘ad©a
 = 
	`bŒfs_fs_šcom·t
(
šfo
, 
SKINNY_METADATA
);

2970 
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
šfo
, 
by‹Ä
);

2971 
	`ASSERT
(
ex‹Á_roÙ
);

2973 
·th
 = 
	`bŒfs_®loc_·th
();

2974 ià(!
·th
)

2975  -
ENOMEM
;

2977 
is_d©a
 = 
owÃr_objeùid
 >ğ
BTRFS_FIRST_FREE_OBJECTID
;

2979 ià(!
is_d©a
 && 
»fs_to_drİ
 != 1) {

2980 
	`bŒfs_ü™
(
šfo
,

2982 
node
->
by‹Ä
, 
»fs_to_drİ
);

2983 
»t
 = -
EINVAL
;

2984 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2985 
out
;

2988 ià(
is_d©a
)

2989 
skšny_m‘ad©a
 = 
çl£
;

2991 
»t
 = 
	`lookup_ex‹Á_back»f
(
Œªs
, 
·th
, &
œef
, 
by‹Ä
, 
num_by‹s
,

2992 
·»Á
, 
roÙ_objeùid
, 
owÃr_objeùid
,

2993 
owÃr_off£t
);

2994 ià(
»t
 == 0) {

3002 
ex‹Á_¦Ù
 = 
·th
->
¦Ùs
[0];

3003 
ex‹Á_¦Ù
 >= 0) {

3004 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,

3005 
ex‹Á_¦Ù
);

3006 ià(
key
.
objeùid
 !ğ
by‹Ä
)

3008 ià(
key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 &&

3009 
key
.
off£t
 =ğ
num_by‹s
) {

3010 
found_ex‹Á
 = 1;

3013 ià(
key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
 &&

3014 
key
.
off£t
 =ğ
owÃr_objeùid
) {

3015 
found_ex‹Á
 = 1;

3020 ià(
·th
->
¦Ùs
[0] - 
ex‹Á_¦Ù
 > 5)

3022 
ex‹Á_¦Ù
--;

3025 ià(!
found_ex‹Á
) {

3026 ià(
œef
) {

3027 
	`abÜt_ªd_dump
(
Œªs
, 
·th
,

3029 
·th
->
¦Ùs
[0]);

3030 
»t
 = -
EUCLEAN
;

3031 
out
;

3034 
»t
 = 
	`»move_ex‹Á_back»f
(
Œªs
, 
ex‹Á_roÙ
, 
·th
,

3035 
NULL
, 
»fs_to_drİ
, 
is_d©a
);

3036 ià(
»t
) {

3037 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3038 
out
;

3040 
	`bŒfs_»Ëa£_·th
(
·th
);

3043 
key
.
objeùid
 = 
by‹Ä
;

3044 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

3045 
key
.
off£t
 = 
num_by‹s
;

3047 ià(!
is_d©a
 && 
skšny_m‘ad©a
) {

3048 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

3049 
key
.
off£t
 = 
owÃr_objeùid
;

3052 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
ex‹Á_roÙ
,

3053 &
key
, 
·th
, -1, 1);

3054 ià(
»t
 > 0 && 
skšny_m‘ad©a
 && 
·th
->
¦Ùs
[0]) {

3059 
·th
->
¦Ùs
[0]--;

3060 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,

3061 
·th
->
¦Ùs
[0]);

3062 ià(
key
.
objeùid
 =ğ
by‹Ä
 &&

3063 
key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 &&

3064 
key
.
off£t
 =ğ
num_by‹s
)

3065 
»t
 = 0;

3068 ià(
»t
 > 0 && 
skšny_m‘ad©a
) {

3069 
skšny_m‘ad©a
 = 
çl£
;

3070 
key
.
objeùid
 = 
by‹Ä
;

3071 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

3072 
key
.
off£t
 = 
num_by‹s
;

3073 
	`bŒfs_»Ëa£_·th
(
·th
);

3074 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
ex‹Á_roÙ
,

3075 &
key
, 
·th
, -1, 1);

3078 ià(
»t
) {

3079 ià(
»t
 > 0)

3080 
	`bŒfs_´št_Ëaf
(
·th
->
nodes
[0]);

3081 
	`bŒfs_”r
(
šfo
,

3083 
»t
, 
by‹Ä
, 
·th
->
¦Ùs
[0]);

3085 ià(
»t
 < 0) {

3086 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3087 
out
;

3089 
ex‹Á_¦Ù
 = 
·th
->
¦Ùs
[0];

3091 } ià(
	`WARN_ON
(
»t
 =ğ-
ENOENT
)) {

3092 
	`abÜt_ªd_dump
(
Œªs
, 
·th
,

3094 
by‹Ä
, 
·»Á
, 
roÙ_objeùid
, 
owÃr_objeùid
,

3095 
owÃr_off£t
, 
·th
->
¦Ùs
[0]);

3096 
out
;

3098 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3099 
out
;

3102 
Ëaf
 = 
·th
->
nodes
[0];

3103 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
ex‹Á_¦Ù
);

3104 ià(
	`uÆik–y
(
™em_size
 < (*
ei
))) {

3105 
»t
 = -
EUCLEAN
;

3106 
	`bŒfs_”r
(
Œªs
->
fs_šfo
,

3108 
™em_size
, (*
ei
));

3109 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3110 
out
;

3112 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
ex‹Á_¦Ù
,

3113 
bŒfs_ex‹Á_™em
);

3114 ià(
owÃr_objeùid
 < 
BTRFS_FIRST_FREE_OBJECTID
 &&

3115 
key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
) {

3116 
bŒfs_Œ“_block_šfo
 *
bi
;

3118 ià(
™em_size
 < (*
ei
è+ (*
bi
)) {

3119 
	`abÜt_ªd_dump
(
Œªs
, 
·th
,

3121 
key
.
objeùid
, key.
ty³
, key.
off£t
,

3122 
·th
->
¦Ùs
[0], 
owÃr_objeùid
, 
™em_size
,

3123 (*
ei
è+ (*
bi
));

3124 
»t
 = -
EUCLEAN
;

3125 
out
;

3127 
bi
 = (
bŒfs_Œ“_block_šfo
 *)(
ei
 + 1);

3128 
	`WARN_ON
(
owÃr_objeùid
 !ğ
	`bŒfs_Œ“_block_Ëv–
(
Ëaf
, 
bi
));

3131 
»fs
 = 
	`bŒfs_ex‹Á_»fs
(
Ëaf
, 
ei
);

3132 ià(
»fs
 < 
»fs_to_drİ
) {

3133 
	`abÜt_ªd_dump
(
Œªs
, 
·th
,

3135 
»fs_to_drİ
, 
»fs
, 
by‹Ä
, 
·th
->
¦Ùs
[0]);

3136 
»t
 = -
EUCLEAN
;

3137 
out
;

3139 
»fs
 -ğ
»fs_to_drİ
;

3141 ià(
»fs
 > 0) {

3142 ià(
ex‹Á_İ
)

3143 
	`__run_d–ayed_ex‹Á_İ
(
ex‹Á_İ
, 
Ëaf
, 
ei
);

3148 ià(
œef
) {

3149 ià(!
found_ex‹Á
) {

3150 
	`abÜt_ªd_dump
(
Œªs
, 
·th
,

3152 
·th
->
¦Ùs
[0]);

3153 
»t
 = -
EUCLEAN
;

3154 
out
;

3157 
	`bŒfs_£t_ex‹Á_»fs
(
Ëaf
, 
ei
, 
»fs
);

3158 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

3160 ià(
found_ex‹Á
) {

3161 
»t
 = 
	`»move_ex‹Á_back»f
(
Œªs
, 
ex‹Á_roÙ
, 
·th
,

3162 
œef
, 
»fs_to_drİ
, 
is_d©a
);

3163 ià(
»t
) {

3164 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3165 
out
;

3170 ià(
found_ex‹Á
) {

3171 ià(
is_d©a
 && 
»fs_to_drİ
 !=

3172 
	`ex‹Á_d©a_»f_couÁ
(
·th
, 
œef
)) {

3173 
	`abÜt_ªd_dump
(
Œªs
, 
·th
,

3175 
	`ex‹Á_d©a_»f_couÁ
(
·th
, 
œef
),

3176 
»fs_to_drİ
, 
·th
->
¦Ùs
[0]);

3177 
»t
 = -
EUCLEAN
;

3178 
out
;

3180 ià(
œef
) {

3181 ià(
·th
->
¦Ùs
[0] !ğ
ex‹Á_¦Ù
) {

3182 
	`abÜt_ªd_dump
(
Œªs
, 
·th
,

3184 
key
.
objeùid
, key.
ty³
,

3185 
key
.
off£t
, 
·th
->
¦Ùs
[0]);

3186 
»t
 = -
EUCLEAN
;

3187 
out
;

3196 ià(
·th
->
¦Ùs
[0] !ğ
ex‹Á_¦Ù
 + 1) {

3197 
	`abÜt_ªd_dump
(
Œªs
, 
·th
,

3199 
·th
->
¦Ùs
[0]);

3200 
»t
 = -
EUCLEAN
;

3201 
out
;

3203 
·th
->
¦Ùs
[0] = 
ex‹Á_¦Ù
;

3204 
num_to_d–
 = 2;

3208 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
ex‹Á_roÙ
, 
·th
,…©h->
¦Ùs
[0],

3209 
num_to_d–
);

3210 ià(
»t
) {

3211 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3212 
out
;

3214 
	`bŒfs_»Ëa£_·th
(
·th
);

3216 
»t
 = 
	`do_ä“_ex‹Á_accouÁšg
(
Œªs
, 
by‹Ä
, 
num_by‹s
, 
is_d©a
);

3218 
	`bŒfs_»Ëa£_·th
(
·th
);

3220 
out
:

3221 
	`bŒfs_ä“_·th
(
·th
);

3222  
»t
;

3223 
	}
}

3231 
nošlše
 
	$check_»f_ş—nup
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3232 
u64
 
by‹Ä
)

3234 
bŒfs_d–ayed_»f_h—d
 *
h—d
;

3235 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

3236 
»t
 = 0;

3238 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

3239 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

3240 
h—d
 = 
	`bŒfs_fšd_d–ayed_»f_h—d
(
d–ayed_»fs
, 
by‹Ä
);

3241 ià(!
h—d
)

3242 
out_d–ayed_uÆock
;

3244 
	`¥š_lock
(&
h—d
->
lock
);

3245 ià(!
	`RB_EMPTY_ROOT
(&
h—d
->
»f_Œ“
.
rb_roÙ
))

3246 
out
;

3248 ià(
	`ş—nup_ex‹Á_İ
(
h—d
è!ğ
NULL
)

3249 
out
;

3255 ià(!
	`mu‹x_Œylock
(&
h—d
->
mu‹x
))

3256 
out
;

3258 
	`bŒfs_d–‘e_»f_h—d
(
d–ayed_»fs
, 
h—d
);

3259 
h—d
->
´oûssšg
 = 
çl£
;

3261 
	`¥š_uÆock
(&
h—d
->
lock
);

3262 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

3264 
	`BUG_ON
(
h—d
->
ex‹Á_İ
);

3265 ià(
h—d
->
mu¡_š£¹_»£rved
)

3266 
»t
 = 1;

3268 
	`bŒfs_ş—nup_»f_h—d_accouÁšg
(
Œªs
->
fs_šfo
, 
d–ayed_»fs
, 
h—d
);

3269 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

3270 
	`bŒfs_put_d–ayed_»f_h—d
(
h—d
);

3271  
»t
;

3272 
out
:

3273 
	`¥š_uÆock
(&
h—d
->
lock
);

3275 
out_d–ayed_uÆock
:

3276 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

3278 
	}
}

3280 
	$bŒfs_ä“_Œ“_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3281 
u64
 
roÙ_id
,

3282 
ex‹Á_bufãr
 *
buf
,

3283 
u64
 
·»Á
, 
Ï¡_»f
)

3285 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

3286 
bŒfs_»f
 
g’”ic_»f
 = { 0 };

3287 
»t
;

3289 
	`bŒfs_š™_g’”ic_»f
(&
g’”ic_»f
, 
BTRFS_DROP_DELAYED_REF
,

3290 
buf
->
¡¬t
, buf->
Ën
, 
·»Á
);

3291 
	`bŒfs_š™_Œ“_»f
(&
g’”ic_»f
, 
	`bŒfs_h—d”_Ëv–
(
buf
),

3292 
roÙ_id
, 0, 
çl£
);

3294 ià(
roÙ_id
 !ğ
BTRFS_TREE_LOG_OBJECTID
) {

3295 
	`bŒfs_»f_Œ“_mod
(
fs_šfo
, &
g’”ic_»f
);

3296 
»t
 = 
	`bŒfs_add_d–ayed_Œ“_»f
(
Œªs
, &
g’”ic_»f
, 
NULL
);

3297 
	`BUG_ON
(
»t
);

3300 ià(
Ï¡_»f
 && 
	`bŒfs_h—d”_g’”©iÚ
(
buf
è=ğ
Œªs
->
Œªsid
) {

3301 
bŒfs_block_group
 *
ÿche
;

3302 
boŞ
 
mu¡_pš
 = 
çl£
;

3304 ià(
roÙ_id
 !ğ
BTRFS_TREE_LOG_OBJECTID
) {

3305 
»t
 = 
	`check_»f_ş—nup
(
Œªs
, 
buf
->
¡¬t
);

3306 ià(!
»t
) {

3307 
	`bŒfs_»dœty_li¡_add
(
Œªs
->
Œª§ùiÚ
, 
buf
);

3308 
out
;

3312 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
buf
->
¡¬t
);

3314 ià(
	`bŒfs_h—d”_æag
(
buf
, 
BTRFS_HEADER_FLAG_WRITTEN
)) {

3315 
	`pš_down_ex‹Á
(
Œªs
, 
ÿche
, 
buf
->
¡¬t
, buf->
Ën
, 1);

3316 
	`bŒfs_put_block_group
(
ÿche
);

3317 
out
;

3336 ià(
	`‹¡_b™
(
BTRFS_FS_TREE_MOD_LOG_USERS
, &
fs_šfo
->
æags
))

3337 
mu¡_pš
 = 
Œue
;

3339 ià(
mu¡_pš
 || 
	`bŒfs_is_zÚed
(
fs_šfo
)) {

3340 
	`bŒfs_»dœty_li¡_add
(
Œªs
->
Œª§ùiÚ
, 
buf
);

3341 
	`pš_down_ex‹Á
(
Œªs
, 
ÿche
, 
buf
->
¡¬t
, buf->
Ën
, 1);

3342 
	`bŒfs_put_block_group
(
ÿche
);

3343 
out
;

3346 
	`WARN_ON
(
	`‹¡_b™
(
EXTENT_BUFFER_DIRTY
, &
buf
->
bæags
));

3348 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
buf
->
¡¬t
, buf->
Ën
);

3349 
	`bŒfs_ä“_»£rved_by‹s
(
ÿche
, 
buf
->
Ën
, 0);

3350 
	`bŒfs_put_block_group
(
ÿche
);

3351 
	`Œaû_bŒfs_»£rved_ex‹Á_ä“
(
fs_šfo
, 
buf
->
¡¬t
, buf->
Ën
);

3353 
out
:

3354 ià(
Ï¡_»f
) {

3359 
	`ş—r_b™
(
EXTENT_BUFFER_CORRUPT
, &
buf
->
bæags
);

3361 
	}
}

3364 
	$bŒfs_ä“_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_»f
 *
»f
)

3366 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

3367 
»t
;

3369 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
))

3376 ià((
»f
->
ty³
 =ğ
BTRFS_REF_METADATA
 &&

3377 
»f
->
Œ“_»f
.
ownšg_roÙ
 =ğ
BTRFS_TREE_LOG_OBJECTID
) ||

3378 (
»f
->
ty³
 =ğ
BTRFS_REF_DATA
 &&

3379 
»f
->
d©a_»f
.
ownšg_roÙ
 =ğ
BTRFS_TREE_LOG_OBJECTID
)) {

3381 
	`bŒfs_pš_ex‹Á
(
Œªs
, 
»f
->
by‹Ä
,„ef->
Ën
, 1);

3382 
»t
 = 0;

3383 } ià(
»f
->
ty³
 =ğ
BTRFS_REF_METADATA
) {

3384 
»t
 = 
	`bŒfs_add_d–ayed_Œ“_»f
(
Œªs
, 
»f
, 
NULL
);

3386 
»t
 = 
	`bŒfs_add_d–ayed_d©a_»f
(
Œªs
, 
»f
, 0);

3389 ià(!((
»f
->
ty³
 =ğ
BTRFS_REF_METADATA
 &&

3390 
»f
->
Œ“_»f
.
ownšg_roÙ
 =ğ
BTRFS_TREE_LOG_OBJECTID
) ||

3391 (
»f
->
ty³
 =ğ
BTRFS_REF_DATA
 &&

3392 
»f
->
d©a_»f
.
ownšg_roÙ
 =ğ
BTRFS_TREE_LOG_OBJECTID
)))

3393 
	`bŒfs_»f_Œ“_mod
(
fs_šfo
, 
»f
);

3395  
»t
;

3396 
	}
}

3398 
	ebŒfs_loİ_ty³
 {

3403 
	mLOOP_CACHING_NOWAIT
,

3409 
	mLOOP_CACHING_WAIT
,

3415 
	mLOOP_UNSET_SIZE_CLASS
,

3420 
	mLOOP_ALLOC_CHUNK
,

3425 
	mLOOP_WRONG_SIZE_CLASS
,

3431 
	mLOOP_NO_EMPTY_SIZE
,

3434 
šlše
 

3435 
	$bŒfs_lock_block_group
(
bŒfs_block_group
 *
ÿche
,

3436 
d–®loc
)

3438 ià(
d–®loc
)

3439 
	`down_»ad
(&
ÿche
->
d©a_rw£m
);

3440 
	}
}

3442 
šlše
 
	$bŒfs_g¿b_block_group
(
bŒfs_block_group
 *
ÿche
,

3443 
d–®loc
)

3445 
	`bŒfs_g‘_block_group
(
ÿche
);

3446 ià(
d–®loc
)

3447 
	`down_»ad
(&
ÿche
->
d©a_rw£m
);

3448 
	}
}

3450 
bŒfs_block_group
 *
	$bŒfs_lock_şu¡”
(

3451 
bŒfs_block_group
 *
block_group
,

3452 
bŒfs_ä“_şu¡”
 *
şu¡”
,

3453 
d–®loc
)

3454 
	`__acquœes
(&
şu¡”
->
»fl_lock
)

3456 
bŒfs_block_group
 *
u£d_bg
 = 
NULL
;

3458 
	`¥š_lock
(&
şu¡”
->
»fl_lock
);

3460 
u£d_bg
 = 
şu¡”
->
block_group
;

3461 ià(!
u£d_bg
)

3462  
NULL
;

3464 ià(
u£d_bg
 =ğ
block_group
)

3465  
u£d_bg
;

3467 
	`bŒfs_g‘_block_group
(
u£d_bg
);

3469 ià(!
d–®loc
)

3470  
u£d_bg
;

3472 ià(
	`down_»ad_Œylock
(&
u£d_bg
->
d©a_rw£m
))

3473  
u£d_bg
;

3475 
	`¥š_uÆock
(&
şu¡”
->
»fl_lock
);

3478 
	`down_»ad_Ã¡ed
(&
u£d_bg
->
d©a_rw£m
, 
SINGLE_DEPTH_NESTING
);

3480 
	`¥š_lock
(&
şu¡”
->
»fl_lock
);

3481 ià(
u£d_bg
 =ğ
şu¡”
->
block_group
)

3482  
u£d_bg
;

3484 
	`up_»ad
(&
u£d_bg
->
d©a_rw£m
);

3485 
	`bŒfs_put_block_group
(
u£d_bg
);

3487 
	}
}

3489 
šlše
 

3490 
	$bŒfs_»Ëa£_block_group
(
bŒfs_block_group
 *
ÿche
,

3491 
d–®loc
)

3493 ià(
d–®loc
)

3494 
	`up_»ad
(&
ÿche
->
d©a_rw£m
);

3495 
	`bŒfs_put_block_group
(
ÿche
);

3496 
	}
}

3505 
	$fšd_ä“_ex‹Á_şu¡”ed
(
bŒfs_block_group
 *
bg
,

3506 
fšd_ä“_ex‹Á_ùl
 *
fã_ùl
,

3507 
bŒfs_block_group
 **
şu¡”_bg_»t
)

3509 
bŒfs_block_group
 *
şu¡”_bg
;

3510 
bŒfs_ä“_şu¡”
 *
Ï¡_±r
 = 
fã_ùl
->last_ptr;

3511 
u64
 
®igÃd_şu¡”
;

3512 
u64
 
off£t
;

3513 
»t
;

3515 
şu¡”_bg
 = 
	`bŒfs_lock_şu¡”
(
bg
, 
Ï¡_±r
, 
fã_ùl
->
d–®loc
);

3516 ià(!
şu¡”_bg
)

3517 
»fl_şu¡”
;

3518 ià(
şu¡”_bg
 !ğ
bg
 && (şu¡”_bg->
ro
 ||

3519 !
	`block_group_b™s
(
şu¡”_bg
, 
fã_ùl
->
æags
)))

3520 
»Ëa£_şu¡”
;

3522 
off£t
 = 
	`bŒfs_®loc_äom_şu¡”
(
şu¡”_bg
, 
Ï¡_±r
,

3523 
fã_ùl
->
num_by‹s
, 
şu¡”_bg
->
¡¬t
,

3524 &
fã_ùl
->
max_ex‹Á_size
);

3525 ià(
off£t
) {

3527 
	`¥š_uÆock
(&
Ï¡_±r
->
»fl_lock
);

3528 
	`Œaû_bŒfs_»£rve_ex‹Á_şu¡”
(
şu¡”_bg
, 
fã_ùl
);

3529 *
şu¡”_bg_»t
 = 
şu¡”_bg
;

3530 
fã_ùl
->
found_off£t
 = 
off£t
;

3533 
	`WARN_ON
(
Ï¡_±r
->
block_group
 !ğ
şu¡”_bg
);

3535 
»Ëa£_şu¡”
:

3547 ià(
fã_ùl
->
loİ
 >ğ
LOOP_NO_EMPTY_SIZE
 && 
şu¡”_bg
 !ğ
bg
) {

3548 
	`¥š_uÆock
(&
Ï¡_±r
->
»fl_lock
);

3549 
	`bŒfs_»Ëa£_block_group
(
şu¡”_bg
, 
fã_ùl
->
d–®loc
);

3550  -
ENOENT
;

3554 
	`bŒfs_»tuº_şu¡”_to_ä“_¥aû
(
NULL
, 
Ï¡_±r
);

3556 ià(
şu¡”_bg
 !ğ
bg
)

3557 
	`bŒfs_»Ëa£_block_group
(
şu¡”_bg
, 
fã_ùl
->
d–®loc
);

3559 
»fl_şu¡”
:

3560 ià(
fã_ùl
->
loİ
 >ğ
LOOP_NO_EMPTY_SIZE
) {

3561 
	`¥š_uÆock
(&
Ï¡_±r
->
»fl_lock
);

3562  -
ENOENT
;

3565 
®igÃd_şu¡”
 = 
	`max_t
(
u64
,

3566 
fã_ùl
->
em±y_şu¡”
 + fã_ùl->
em±y_size
,

3567 
bg
->
fuÎ_¡re_Ën
);

3568 
»t
 = 
	`bŒfs_fšd_¥aû_şu¡”
(
bg
, 
Ï¡_±r
, 
fã_ùl
->
£¬ch_¡¬t
,

3569 
fã_ùl
->
num_by‹s
, 
®igÃd_şu¡”
);

3570 ià(
»t
 == 0) {

3572 
off£t
 = 
	`bŒfs_®loc_äom_şu¡”
(
bg
, 
Ï¡_±r
,

3573 
fã_ùl
->
num_by‹s
, fã_ùl->
£¬ch_¡¬t
,

3574 &
fã_ùl
->
max_ex‹Á_size
);

3575 ià(
off£t
) {

3577 
	`¥š_uÆock
(&
Ï¡_±r
->
»fl_lock
);

3578 
fã_ùl
->
found_off£t
 = 
off£t
;

3579 
	`Œaû_bŒfs_»£rve_ex‹Á_şu¡”
(
bg
, 
fã_ùl
);

3588 
	`bŒfs_»tuº_şu¡”_to_ä“_¥aû
(
NULL
, 
Ï¡_±r
);

3589 
	`¥š_uÆock
(&
Ï¡_±r
->
»fl_lock
);

3591 
	}
}

3597 
	$fšd_ä“_ex‹Á_unşu¡”ed
(
bŒfs_block_group
 *
bg
,

3598 
fšd_ä“_ex‹Á_ùl
 *
fã_ùl
)

3600 
bŒfs_ä“_şu¡”
 *
Ï¡_±r
 = 
fã_ùl
->last_ptr;

3601 
u64
 
off£t
;

3608 ià(
	`uÆik–y
(
Ï¡_±r
)) {

3609 
	`¥š_lock
(&
Ï¡_±r
->
lock
);

3610 
Ï¡_±r
->
äagm’‹d
 = 1;

3611 
	`¥š_uÆock
(&
Ï¡_±r
->
lock
);

3613 ià(
fã_ùl
->
ÿched
) {

3614 
bŒfs_ä“_¥aû_ùl
 *
ä“_¥aû_ùl
;

3616 
ä“_¥aû_ùl
 = 
bg
->free_space_ctl;

3617 
	`¥š_lock
(&
ä“_¥aû_ùl
->
Œ“_lock
);

3618 ià(
ä“_¥aû_ùl
->
ä“_¥aû
 <

3619 
fã_ùl
->
num_by‹s
 + fã_ùl->
em±y_şu¡”
 +

3620 
fã_ùl
->
em±y_size
) {

3621 
fã_ùl
->
tÙ®_ä“_¥aû
 = 
	`max_t
(
u64
,

3622 
fã_ùl
->
tÙ®_ä“_¥aû
,

3623 
ä“_¥aû_ùl
->
ä“_¥aû
);

3624 
	`¥š_uÆock
(&
ä“_¥aû_ùl
->
Œ“_lock
);

3627 
	`¥š_uÆock
(&
ä“_¥aû_ùl
->
Œ“_lock
);

3630 
off£t
 = 
	`bŒfs_fšd_¥aû_fÜ_®loc
(
bg
, 
fã_ùl
->
£¬ch_¡¬t
,

3631 
fã_ùl
->
num_by‹s
, fã_ùl->
em±y_size
,

3632 &
fã_ùl
->
max_ex‹Á_size
);

3633 ià(!
off£t
)

3635 
fã_ùl
->
found_off£t
 = 
off£t
;

3637 
	}
}

3639 
	$do_®loÿtiÚ_şu¡”ed
(
bŒfs_block_group
 *
block_group
,

3640 
fšd_ä“_ex‹Á_ùl
 *
fã_ùl
,

3641 
bŒfs_block_group
 **
bg_»t
)

3643 
»t
;

3646 ià(
fã_ùl
->
Ï¡_±r
 && fã_ùl->
u£_şu¡”
) {

3647 
»t
 = 
	`fšd_ä“_ex‹Á_şu¡”ed
(
block_group
, 
fã_ùl
, 
bg_»t
);

3648 ià(
»t
 >= 0)

3649  
»t
;

3653  
	`fšd_ä“_ex‹Á_unşu¡”ed
(
block_group
, 
fã_ùl
);

3654 
	}
}

3677 
	$do_®loÿtiÚ_zÚed
(
bŒfs_block_group
 *
block_group
,

3678 
fšd_ä“_ex‹Á_ùl
 *
fã_ùl
,

3679 
bŒfs_block_group
 **
bg_»t
)

3681 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

3682 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
block_group
->space_info;

3683 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3684 
u64
 
¡¬t
 = 
block_group
->start;

3685 
u64
 
num_by‹s
 = 
fã_ùl
->num_bytes;

3686 
u64
 
ava
;

3687 
u64
 
by‹Ä
 = 
block_group
->
¡¬t
;

3688 
u64
 
log_by‹Ä
;

3689 
u64
 
d©a_»loc_by‹Ä
;

3690 
»t
 = 0;

3691 
boŞ
 
sk
 = 
çl£
;

3693 
	`ASSERT
(
	`bŒfs_is_zÚed
(
block_group
->
fs_šfo
));

3699 
	`¥š_lock
(&
fs_šfo
->
Œ“log_bg_lock
);

3700 
log_by‹Ä
 = 
fs_šfo
->
Œ“log_bg
;

3701 ià(
log_by‹Ä
 && ((
fã_ùl
->
fÜ_Œ“log
 && 
by‹Ä
 !=†og_bytenr) ||

3702 (!
fã_ùl
->
fÜ_Œ“log
 && 
by‹Ä
 =ğ
log_by‹Ä
)))

3703 
sk
 = 
Œue
;

3704 
	`¥š_uÆock
(&
fs_šfo
->
Œ“log_bg_lock
);

3705 ià(
sk
)

3712 
	`¥š_lock
(&
fs_šfo
->
»loÿtiÚ_bg_lock
);

3713 
d©a_»loc_by‹Ä
 = 
fs_šfo
->
d©a_»loc_bg
;

3714 ià(
d©a_»loc_by‹Ä
 &&

3715 ((
fã_ùl
->
fÜ_d©a_»loc
 && 
by‹Ä
 !ğ
d©a_»loc_by‹Ä
) ||

3716 (!
fã_ùl
->
fÜ_d©a_»loc
 && 
by‹Ä
 =ğ
d©a_»loc_by‹Ä
)))

3717 
sk
 = 
Œue
;

3718 
	`¥š_uÆock
(&
fs_šfo
->
»loÿtiÚ_bg_lock
);

3719 ià(
sk
)

3723 
	`¥š_lock
(&
block_group
->
lock
);

3724 ià(
block_group
->
ro
 || 
	`bŒfs_zÚed_bg_is_fuÎ
(block_group)) {

3725 
»t
 = 1;

3731 
	`¥š_uÆock
(&
block_group
->
lock
);

3734 ià(!
»t
 && (
block_group
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
) &&

3735 !
	`bŒfs_zÚe_aùiv©e
(
block_group
)) {

3736 
»t
 = 1;

3743 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

3744 
	`¥š_lock
(&
block_group
->
lock
);

3745 
	`¥š_lock
(&
fs_šfo
->
Œ“log_bg_lock
);

3746 
	`¥š_lock
(&
fs_šfo
->
»loÿtiÚ_bg_lock
);

3748 ià(
»t
)

3749 
out
;

3751 
	`ASSERT
(!
fã_ùl
->
fÜ_Œ“log
 ||

3752 
block_group
->
¡¬t
 =ğ
fs_šfo
->
Œ“log_bg
 ||

3753 
fs_šfo
->
Œ“log_bg
 == 0);

3754 
	`ASSERT
(!
fã_ùl
->
fÜ_d©a_»loc
 ||

3755 
block_group
->
¡¬t
 =ğ
fs_šfo
->
d©a_»loc_bg
 ||

3756 
fs_šfo
->
d©a_»loc_bg
 == 0);

3758 ià(
block_group
->
ro
 ||

3759 (!
fã_ùl
->
fÜ_d©a_»loc
 &&

3760 
	`‹¡_b™
(
BLOCK_GROUP_FLAG_ZONED_DATA_RELOC
, &
block_group
->
ruÁime_æags
))) {

3761 
»t
 = 1;

3762 
out
;

3769 ià(
fã_ùl
->
fÜ_Œ“log
 && !
fs_šfo
->
Œ“log_bg
 &&

3770 (
block_group
->
u£d
 || block_group->
»£rved
)) {

3771 
»t
 = 1;

3772 
out
;

3779 ià(
fã_ùl
->
fÜ_d©a_»loc
 && !
fs_šfo
->
d©a_»loc_bg
 &&

3780 (
block_group
->
u£d
 || block_group->
»£rved
)) {

3781 
»t
 = 1;

3782 
out
;

3785 
	`WARN_ON_ONCE
(
block_group
->
®loc_off£t
 > block_group->
zÚe_ÿ·c™y
);

3786 
ava
 = 
block_group
->
zÚe_ÿ·c™y
 - block_group->
®loc_off£t
;

3787 ià(
ava
 < 
num_by‹s
) {

3788 ià(
fã_ùl
->
max_ex‹Á_size
 < 
ava
) {

3793 
fã_ùl
->
max_ex‹Á_size
 = 
ava
;

3794 
fã_ùl
->
tÙ®_ä“_¥aû
 = 
ava
;

3796 
»t
 = 1;

3797 
out
;

3800 ià(
fã_ùl
->
fÜ_Œ“log
 && !
fs_šfo
->
Œ“log_bg
)

3801 
fs_šfo
->
Œ“log_bg
 = 
block_group
->
¡¬t
;

3803 ià(
fã_ùl
->
fÜ_d©a_»loc
) {

3804 ià(!
fs_šfo
->
d©a_»loc_bg
)

3805 
fs_šfo
->
d©a_»loc_bg
 = 
block_group
->
¡¬t
;

3821 
	`£t_b™
(
BLOCK_GROUP_FLAG_ZONED_DATA_RELOC
, &
block_group
->
ruÁime_æags
);

3824 
fã_ùl
->
found_off£t
 = 
¡¬t
 + 
block_group
->
®loc_off£t
;

3825 
block_group
->
®loc_off£t
 +ğ
num_by‹s
;

3826 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3827 
ùl
->
ä“_¥aû
 -ğ
num_by‹s
;

3828 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3835 
fã_ùl
->
£¬ch_¡¬t
 = fã_ùl->
found_off£t
;

3837 
out
:

3838 ià(
»t
 && 
fã_ùl
->
fÜ_Œ“log
)

3839 
fs_šfo
->
Œ“log_bg
 = 0;

3840 ià(
»t
 && 
fã_ùl
->
fÜ_d©a_»loc
)

3841 
fs_šfo
->
d©a_»loc_bg
 = 0;

3842 
	`¥š_uÆock
(&
fs_šfo
->
»loÿtiÚ_bg_lock
);

3843 
	`¥š_uÆock
(&
fs_šfo
->
Œ“log_bg_lock
);

3844 
	`¥š_uÆock
(&
block_group
->
lock
);

3845 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

3846  
»t
;

3847 
	}
}

3849 
	$do_®loÿtiÚ
(
bŒfs_block_group
 *
block_group
,

3850 
fšd_ä“_ex‹Á_ùl
 *
fã_ùl
,

3851 
bŒfs_block_group
 **
bg_»t
)

3853 
fã_ùl
->
pŞicy
) {

3854 
BTRFS_EXTENT_ALLOC_CLUSTERED
:

3855  
	`do_®loÿtiÚ_şu¡”ed
(
block_group
, 
fã_ùl
, 
bg_»t
);

3856 
BTRFS_EXTENT_ALLOC_ZONED
:

3857  
	`do_®loÿtiÚ_zÚed
(
block_group
, 
fã_ùl
, 
bg_»t
);

3859 
	`BUG
();

3861 
	}
}

3863 
	$»Ëa£_block_group
(
bŒfs_block_group
 *
block_group
,

3864 
fšd_ä“_ex‹Á_ùl
 *
fã_ùl
,

3865 
d–®loc
)

3867 
fã_ùl
->
pŞicy
) {

3868 
BTRFS_EXTENT_ALLOC_CLUSTERED
:

3869 
fã_ùl
->
»Œy_unÿched
 = 
çl£
;

3871 
BTRFS_EXTENT_ALLOC_ZONED
:

3875 
	`BUG
();

3878 
	`BUG_ON
(
	`bŒfs_bg_æags_to_¿id_šdex
(
block_group
->
æags
) !=

3879 
fã_ùl
->
šdex
);

3880 
	`bŒfs_»Ëa£_block_group
(
block_group
, 
d–®loc
);

3881 
	}
}

3883 
	$found_ex‹Á_şu¡”ed
(
fšd_ä“_ex‹Á_ùl
 *
fã_ùl
,

3884 
bŒfs_key
 *
šs
)

3886 
bŒfs_ä“_şu¡”
 *
Ï¡_±r
 = 
fã_ùl
->last_ptr;

3888 ià(!
fã_ùl
->
u£_şu¡”
 && 
Ï¡_±r
) {

3889 
	`¥š_lock
(&
Ï¡_±r
->
lock
);

3890 
Ï¡_±r
->
wšdow_¡¬t
 = 
šs
->
objeùid
;

3891 
	`¥š_uÆock
(&
Ï¡_±r
->
lock
);

3893 
	}
}

3895 
	$found_ex‹Á
(
fšd_ä“_ex‹Á_ùl
 *
fã_ùl
,

3896 
bŒfs_key
 *
šs
)

3898 
fã_ùl
->
pŞicy
) {

3899 
BTRFS_EXTENT_ALLOC_CLUSTERED
:

3900 
	`found_ex‹Á_şu¡”ed
(
fã_ùl
, 
šs
);

3902 
BTRFS_EXTENT_ALLOC_ZONED
:

3906 
	`BUG
();

3908 
	}
}

3910 
	$ÿn_®loÿ‹_chunk_zÚed
(
bŒfs_fs_šfo
 *
fs_šfo
,

3911 
fšd_ä“_ex‹Á_ùl
 *
fã_ùl
)

3914 ià(!(
fã_ùl
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
))

3918 ià(
	`bŒfs_ÿn_aùiv©e_zÚe
(
fs_šfo
->
fs_deviûs
, 
fã_ùl
->
æags
))

3928 ià(
fã_ùl
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
) {

3929 
»t
 = 
	`bŒfs_zÚe_fšish_Úe_bg
(
fs_šfo
);

3931 ià(
»t
 == 1)

3933 ià(
»t
 < 0)

3934  
»t
;

3942 ià(
fã_ùl
->
max_ex‹Á_size
 >ğfã_ùl->
mš_®loc_size
)

3943  -
ENOSPC
;

3952 ià(
fã_ùl
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

3953  -
EAGAIN
;

3961 
	}
}

3963 
	$ÿn_®loÿ‹_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
,

3964 
fšd_ä“_ex‹Á_ùl
 *
fã_ùl
)

3966 
fã_ùl
->
pŞicy
) {

3967 
BTRFS_EXTENT_ALLOC_CLUSTERED
:

3969 
BTRFS_EXTENT_ALLOC_ZONED
:

3970  
	`ÿn_®loÿ‹_chunk_zÚed
(
fs_šfo
, 
fã_ùl
);

3972 
	`BUG
();

3974 
	}
}

3981 
	$fšd_ä“_ex‹Á_upd©e_loİ
(
bŒfs_fs_šfo
 *
fs_šfo
,

3982 
bŒfs_key
 *
šs
,

3983 
fšd_ä“_ex‹Á_ùl
 *
fã_ùl
,

3984 
boŞ
 
fuÎ_£¬ch
)

3986 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
chunk_roÙ
;

3987 
»t
;

3989 ià((
fã_ùl
->
loİ
 =ğ
LOOP_CACHING_NOWAIT
) &&

3990 
fã_ùl
->
have_ÿchšg_bg
 && !fã_ùl->
Üig_have_ÿchšg_bg
)

3991 
fã_ùl
->
Üig_have_ÿchšg_bg
 = 
Œue
;

3993 ià(
šs
->
objeùid
) {

3994 
	`found_ex‹Á
(
fã_ùl
, 
šs
);

3998 ià(
fã_ùl
->
loİ
 >ğ
LOOP_CACHING_WAIT
 && fã_ùl->
have_ÿchšg_bg
)

4001 
fã_ùl
->
šdex
++;

4002 ià(
fã_ùl
->
šdex
 < 
BTRFS_NR_RAID_TYPES
)

4006 ià(
fã_ùl
->
loİ
 < 
LOOP_NO_EMPTY_SIZE
) {

4007 
fã_ùl
->
šdex
 = 0;

4013 ià(
fã_ùl
->
loİ
 =ğ
LOOP_CACHING_NOWAIT
 &&

4014 (!
fã_ùl
->
Üig_have_ÿchšg_bg
 && 
fuÎ_£¬ch
))

4015 
fã_ùl
->
loİ
++;

4016 
fã_ùl
->
loİ
++;

4018 ià(
fã_ùl
->
loİ
 =ğ
LOOP_ALLOC_CHUNK
) {

4019 
bŒfs_Œªs_hªdË
 *
Œªs
;

4020 
exi¡
 = 0;

4023 
»t
 = 
	`ÿn_®loÿ‹_chunk
(
fs_šfo
, 
fã_ùl
);

4024 ià(
»t
)

4025  
»t
;

4027 
Œªs
 = 
cu¼’t
->
jouº®_šfo
;

4028 ià(
Œªs
)

4029 
exi¡
 = 1;

4031 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

4033 ià(
	`IS_ERR
(
Œªs
)) {

4034 
»t
 = 
	`PTR_ERR
(
Œªs
);

4035  
»t
;

4038 
»t
 = 
	`bŒfs_chunk_®loc
(
Œªs
, 
fã_ùl
->
æags
,

4039 
CHUNK_ALLOC_FORCE_FOR_EXTENT
);

4042 ià(
»t
 =ğ-
ENOSPC
) {

4043 
»t
 = 0;

4044 
fã_ùl
->
loİ
++;

4046 ià(
»t
 < 0)

4047 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4049 
»t
 = 0;

4050 ià(!
exi¡
)

4051 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4052 ià(
»t
)

4053  
»t
;

4056 ià(
fã_ùl
->
loİ
 =ğ
LOOP_NO_EMPTY_SIZE
) {

4057 ià(
fã_ùl
->
pŞicy
 !ğ
BTRFS_EXTENT_ALLOC_CLUSTERED
)

4058  -
ENOSPC
;

4064 ià(
fã_ùl
->
em±y_size
 == 0 &&

4065 
fã_ùl
->
em±y_şu¡”
 == 0)

4066  -
ENOSPC
;

4067 
fã_ùl
->
em±y_size
 = 0;

4068 
fã_ùl
->
em±y_şu¡”
 = 0;

4072  -
ENOSPC
;

4073 
	}
}

4075 
boŞ
 
	$fšd_ä“_ex‹Á_check_size_şass
(
fšd_ä“_ex‹Á_ùl
 *
fã_ùl
,

4076 
bŒfs_block_group
 *
bg
)

4078 ià(
fã_ùl
->
pŞicy
 =ğ
BTRFS_EXTENT_ALLOC_ZONED
)

4079  
Œue
;

4080 ià(!
	`bŒfs_block_group_should_u£_size_şass
(
bg
))

4081  
Œue
;

4082 ià(
fã_ùl
->
loİ
 >ğ
LOOP_WRONG_SIZE_CLASS
)

4083  
Œue
;

4084 ià(
fã_ùl
->
loİ
 >ğ
LOOP_UNSET_SIZE_CLASS
 &&

4085 
bg
->
size_şass
 =ğ
BTRFS_BG_SZ_NONE
)

4086  
Œue
;

4087  
fã_ùl
->
size_şass
 =ğ
bg
->size_class;

4088 
	}
}

4090 
	$´•¬e_®loÿtiÚ_şu¡”ed
(
bŒfs_fs_šfo
 *
fs_šfo
,

4091 
fšd_ä“_ex‹Á_ùl
 *
fã_ùl
,

4092 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

4093 
bŒfs_key
 *
šs
)

4105 ià(
¥aû_šfo
->
max_ex‹Á_size
) {

4106 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

4107 ià(
¥aû_šfo
->
max_ex‹Á_size
 &&

4108 
fã_ùl
->
num_by‹s
 > 
¥aû_šfo
->
max_ex‹Á_size
) {

4109 
šs
->
off£t
 = 
¥aû_šfo
->
max_ex‹Á_size
;

4110 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

4111  -
ENOSPC
;

4112 } ià(
¥aû_šfo
->
max_ex‹Á_size
) {

4113 
fã_ùl
->
u£_şu¡”
 = 
çl£
;

4115 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

4118 
fã_ùl
->
Ï¡_±r
 = 
	`ãtch_şu¡”_šfo
(
fs_šfo
, 
¥aû_šfo
,

4119 &
fã_ùl
->
em±y_şu¡”
);

4120 ià(
fã_ùl
->
Ï¡_±r
) {

4121 
bŒfs_ä“_şu¡”
 *
Ï¡_±r
 = 
fã_ùl
->last_ptr;

4123 
	`¥š_lock
(&
Ï¡_±r
->
lock
);

4124 ià(
Ï¡_±r
->
block_group
)

4125 
fã_ùl
->
hšt_by‹
 = 
Ï¡_±r
->
wšdow_¡¬t
;

4126 ià(
Ï¡_±r
->
äagm’‹d
) {

4132 
fã_ùl
->
hšt_by‹
 = 
Ï¡_±r
->
wšdow_¡¬t
;

4133 
fã_ùl
->
u£_şu¡”
 = 
çl£
;

4135 
	`¥š_uÆock
(&
Ï¡_±r
->
lock
);

4139 
	}
}

4141 
	$´•¬e_®loÿtiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
,

4142 
fšd_ä“_ex‹Á_ùl
 *
fã_ùl
,

4143 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

4144 
bŒfs_key
 *
šs
)

4146 
fã_ùl
->
pŞicy
) {

4147 
BTRFS_EXTENT_ALLOC_CLUSTERED
:

4148  
	`´•¬e_®loÿtiÚ_şu¡”ed
(
fs_šfo
, 
fã_ùl
,

4149 
¥aû_šfo
, 
šs
);

4150 
BTRFS_EXTENT_ALLOC_ZONED
:

4151 ià(
fã_ùl
->
fÜ_Œ“log
) {

4152 
	`¥š_lock
(&
fs_šfo
->
Œ“log_bg_lock
);

4153 ià(
fs_šfo
->
Œ“log_bg
)

4154 
fã_ùl
->
hšt_by‹
 = 
fs_šfo
->
Œ“log_bg
;

4155 
	`¥š_uÆock
(&
fs_šfo
->
Œ“log_bg_lock
);

4157 ià(
fã_ùl
->
fÜ_d©a_»loc
) {

4158 
	`¥š_lock
(&
fs_šfo
->
»loÿtiÚ_bg_lock
);

4159 ià(
fs_šfo
->
d©a_»loc_bg
)

4160 
fã_ùl
->
hšt_by‹
 = 
fs_šfo
->
d©a_»loc_bg
;

4161 
	`¥š_uÆock
(&
fs_šfo
->
»loÿtiÚ_bg_lock
);

4165 
	`BUG
();

4167 
	}
}

4194 
nošlše
 
	$fšd_ä“_ex‹Á
(
bŒfs_roÙ
 *
roÙ
,

4195 
bŒfs_key
 *
šs
,

4196 
fšd_ä“_ex‹Á_ùl
 *
fã_ùl
)

4198 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4199 
»t
 = 0;

4200 
ÿche_block_group_”rÜ
 = 0;

4201 
bŒfs_block_group
 *
block_group
 = 
NULL
;

4202 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

4203 
boŞ
 
fuÎ_£¬ch
 = 
çl£
;

4205 
	`WARN_ON
(
fã_ùl
->
num_by‹s
 < 
fs_šfo
->
£ùÜsize
);

4207 
fã_ùl
->
£¬ch_¡¬t
 = 0;

4209 
fã_ùl
->
em±y_şu¡”
 = 0;

4210 
fã_ùl
->
Ï¡_±r
 = 
NULL
;

4211 
fã_ùl
->
u£_şu¡”
 = 
Œue
;

4212 
fã_ùl
->
have_ÿchšg_bg
 = 
çl£
;

4213 
fã_ùl
->
Üig_have_ÿchšg_bg
 = 
çl£
;

4214 
fã_ùl
->
šdex
 = 
	`bŒfs_bg_æags_to_¿id_šdex
(fã_ùl->
æags
);

4215 
fã_ùl
->
loİ
 = 0;

4216 
fã_ùl
->
»Œy_unÿched
 = 
çl£
;

4217 
fã_ùl
->
ÿched
 = 0;

4218 
fã_ùl
->
max_ex‹Á_size
 = 0;

4219 
fã_ùl
->
tÙ®_ä“_¥aû
 = 0;

4220 
fã_ùl
->
found_off£t
 = 0;

4221 
fã_ùl
->
pŞicy
 = 
BTRFS_EXTENT_ALLOC_CLUSTERED
;

4222 
fã_ùl
->
size_şass
 = 
	`bŒfs_ÿlc_block_group_size_şass
(fã_ùl->
num_by‹s
);

4224 ià(
	`bŒfs_is_zÚed
(
fs_šfo
))

4225 
fã_ùl
->
pŞicy
 = 
BTRFS_EXTENT_ALLOC_ZONED
;

4227 
šs
->
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

4228 
šs
->
objeùid
 = 0;

4229 
šs
->
off£t
 = 0;

4231 
	`Œaû_fšd_ä“_ex‹Á
(
roÙ
, 
fã_ùl
);

4233 
¥aû_šfo
 = 
	`bŒfs_fšd_¥aû_šfo
(
fs_šfo
, 
fã_ùl
->
æags
);

4234 ià(!
¥aû_šfo
) {

4235 
	`bŒfs_”r
(
fs_šfo
, "NØ¥aû infØfÜ %Îu", 
fã_ùl
->
æags
);

4236  -
ENOSPC
;

4239 
»t
 = 
	`´•¬e_®loÿtiÚ
(
fs_šfo
, 
fã_ùl
, 
¥aû_šfo
, 
šs
);

4240 ià(
»t
 < 0)

4241  
»t
;

4243 
fã_ùl
->
£¬ch_¡¬t
 = 
	`max
(ffe_ctl->search_start,

4244 
	`fœ¡_logiÿl_by‹
(
fs_šfo
));

4245 
fã_ùl
->
£¬ch_¡¬t
 = 
	`max
(fã_ùl->£¬ch_¡¬t, fã_ùl->
hšt_by‹
);

4246 ià(
fã_ùl
->
£¬ch_¡¬t
 =ğfã_ùl->
hšt_by‹
) {

4247 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
,

4248 
fã_ùl
->
£¬ch_¡¬t
);

4256 ià(
block_group
 && 
	`block_group_b™s
(block_group, 
fã_ùl
->
æags
) &&

4257 
block_group
->
ÿched
 !ğ
BTRFS_CACHE_NO
) {

4258 
	`down_»ad
(&
¥aû_šfo
->
groups_£m
);

4259 ià(
	`li¡_em±y
(&
block_group
->
li¡
) ||

4260 
block_group
->
ro
) {

4267 
	`bŒfs_put_block_group
(
block_group
);

4268 
	`up_»ad
(&
¥aû_šfo
->
groups_£m
);

4270 
fã_ùl
->
šdex
 = 
	`bŒfs_bg_æags_to_¿id_šdex
(

4271 
block_group
->
æags
);

4272 
	`bŒfs_lock_block_group
(
block_group
,

4273 
fã_ùl
->
d–®loc
);

4274 
fã_ùl
->
hš‹d
 = 
Œue
;

4275 
have_block_group
;

4277 } ià(
block_group
) {

4278 
	`bŒfs_put_block_group
(
block_group
);

4281 
£¬ch
:

4282 
	`Œaû_fšd_ä“_ex‹Á_£¬ch_loİ
(
roÙ
, 
fã_ùl
);

4283 
fã_ùl
->
have_ÿchšg_bg
 = 
çl£
;

4284 ià(
fã_ùl
->
šdex
 =ğ
	`bŒfs_bg_æags_to_¿id_šdex
(fã_ùl->
æags
) ||

4285 
fã_ùl
->
šdex
 == 0)

4286 
fuÎ_£¬ch
 = 
Œue
;

4287 
	`down_»ad
(&
¥aû_šfo
->
groups_£m
);

4288 
	`li¡_fÜ_—ch_’Œy
(
block_group
,

4289 &
¥aû_šfo
->
block_groups
[
fã_ùl
->
šdex
], 
li¡
) {

4290 
bŒfs_block_group
 *
bg_»t
;

4292 
fã_ùl
->
hš‹d
 = 
çl£
;

4294 ià(
	`uÆik–y
(
block_group
->
ro
)) {

4295 ià(
fã_ùl
->
fÜ_Œ“log
)

4296 
	`bŒfs_ş—r_Œ“log_bg
(
block_group
);

4297 ià(
fã_ùl
->
fÜ_d©a_»loc
)

4298 
	`bŒfs_ş—r_d©a_»loc_bg
(
block_group
);

4302 
	`bŒfs_g¿b_block_group
(
block_group
, 
fã_ùl
->
d–®loc
);

4303 
fã_ùl
->
£¬ch_¡¬t
 = 
block_group
->
¡¬t
;

4310 ià(!
	`block_group_b™s
(
block_group
, 
fã_ùl
->
æags
)) {

4311 
u64
 
exŒa
 = 
BTRFS_BLOCK_GROUP_DUP
 |

4312 
BTRFS_BLOCK_GROUP_RAID1_MASK
 |

4313 
BTRFS_BLOCK_GROUP_RAID56_MASK
 |

4314 
BTRFS_BLOCK_GROUP_RAID10
;

4321 ià((
fã_ùl
->
æags
 & 
exŒa
è&& !(
block_group
->flags &ƒxtra))

4322 
loİ
;

4329 
	`bŒfs_»Ëa£_block_group
(
block_group
, 
fã_ùl
->
d–®loc
);

4333 
have_block_group
:

4334 
	`Œaû_fšd_ä“_ex‹Á_have_block_group
(
roÙ
, 
fã_ùl
, 
block_group
);

4335 
fã_ùl
->
ÿched
 = 
	`bŒfs_block_group_dÚe
(
block_group
);

4336 ià(
	`uÆik–y
(!
fã_ùl
->
ÿched
)) {

4337 
fã_ùl
->
have_ÿchšg_bg
 = 
Œue
;

4338 
»t
 = 
	`bŒfs_ÿche_block_group
(
block_group
, 
çl£
);

4347 ià(
»t
 < 0) {

4348 ià(!
ÿche_block_group_”rÜ
)

4349 
ÿche_block_group_”rÜ
 = 
»t
;

4350 
»t
 = 0;

4351 
loİ
;

4353 
»t
 = 0;

4356 ià(
	`uÆik–y
(
block_group
->
ÿched
 =ğ
BTRFS_CACHE_ERROR
)) {

4357 ià(!
ÿche_block_group_”rÜ
)

4358 
ÿche_block_group_”rÜ
 = -
EIO
;

4359 
loİ
;

4362 ià(!
	`fšd_ä“_ex‹Á_check_size_şass
(
fã_ùl
, 
block_group
))

4363 
loİ
;

4365 
bg_»t
 = 
NULL
;

4366 
»t
 = 
	`do_®loÿtiÚ
(
block_group
, 
fã_ùl
, &
bg_»t
);

4367 ià(
»t
 > 0)

4368 
loİ
;

4370 ià(
bg_»t
 && bg_»ˆ!ğ
block_group
) {

4371 
	`bŒfs_»Ëa£_block_group
(
block_group
, 
fã_ùl
->
d–®loc
);

4372 
block_group
 = 
bg_»t
;

4376 
fã_ùl
->
£¬ch_¡¬t
 = 
	`round_up
(fã_ùl->
found_off£t
,

4377 
fs_šfo
->
¡resize
);

4380 ià(
fã_ùl
->
£¬ch_¡¬t
 + fã_ùl->
num_by‹s
 >

4381 
block_group
->
¡¬t
 + block_group->
Ëngth
) {

4382 
	`bŒfs_add_ä“_¥aû_unu£d
(
block_group
,

4383 
fã_ùl
->
found_off£t
,

4384 
fã_ùl
->
num_by‹s
);

4385 
loİ
;

4388 ià(
fã_ùl
->
found_off£t
 < fã_ùl->
£¬ch_¡¬t
)

4389 
	`bŒfs_add_ä“_¥aû_unu£d
(
block_group
,

4390 
fã_ùl
->
found_off£t
,

4391 
fã_ùl
->
£¬ch_¡¬t
 - fã_ùl->
found_off£t
);

4393 
»t
 = 
	`bŒfs_add_»£rved_by‹s
(
block_group
, 
fã_ùl
->
¿m_by‹s
,

4394 
fã_ùl
->
num_by‹s
,

4395 
fã_ùl
->
d–®loc
,

4396 
fã_ùl
->
loİ
 >ğ
LOOP_WRONG_SIZE_CLASS
);

4397 ià(
»t
 =ğ-
EAGAIN
) {

4398 
	`bŒfs_add_ä“_¥aû_unu£d
(
block_group
,

4399 
fã_ùl
->
found_off£t
,

4400 
fã_ùl
->
num_by‹s
);

4401 
loİ
;

4403 
	`bŒfs_šc_block_group_»£rv©iÚs
(
block_group
);

4406 
šs
->
objeùid
 = 
fã_ùl
->
£¬ch_¡¬t
;

4407 
šs
->
off£t
 = 
fã_ùl
->
num_by‹s
;

4409 
	`Œaû_bŒfs_»£rve_ex‹Á
(
block_group
, 
fã_ùl
);

4410 
	`bŒfs_»Ëa£_block_group
(
block_group
, 
fã_ùl
->
d–®loc
);

4412 
loİ
:

4413 ià(!
fã_ùl
->
ÿched
 && fã_ùl->
loİ
 > 
LOOP_CACHING_NOWAIT
 &&

4414 !
fã_ùl
->
»Œy_unÿched
) {

4415 
fã_ùl
->
»Œy_unÿched
 = 
Œue
;

4416 
	`bŒfs_wa™_block_group_ÿche_´og»ss
(
block_group
,

4417 
fã_ùl
->
num_by‹s
 +

4418 
fã_ùl
->
em±y_şu¡”
 +

4419 
fã_ùl
->
em±y_size
);

4420 
have_block_group
;

4422 
	`»Ëa£_block_group
(
block_group
, 
fã_ùl
, fã_ùl->
d–®loc
);

4423 
	`cÚd_»sched
();

4425 
	`up_»ad
(&
¥aû_šfo
->
groups_£m
);

4427 
»t
 = 
	`fšd_ä“_ex‹Á_upd©e_loİ
(
fs_šfo
, 
šs
, 
fã_ùl
, 
fuÎ_£¬ch
);

4428 ià(
»t
 > 0)

4429 
£¬ch
;

4431 ià(
»t
 =ğ-
ENOSPC
 && !
ÿche_block_group_”rÜ
) {

4436 ià(!
fã_ùl
->
max_ex‹Á_size
)

4437 
fã_ùl
->
max_ex‹Á_size
 = fã_ùl->
tÙ®_ä“_¥aû
;

4438 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

4439 
¥aû_šfo
->
max_ex‹Á_size
 = 
fã_ùl
->max_extent_size;

4440 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

4441 
šs
->
off£t
 = 
fã_ùl
->
max_ex‹Á_size
;

4442 } ià(
»t
 =ğ-
ENOSPC
) {

4443 
»t
 = 
ÿche_block_group_”rÜ
;

4445  
»t
;

4446 
	}
}

4493 
	$bŒfs_»£rve_ex‹Á
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
¿m_by‹s
,

4494 
u64
 
num_by‹s
, u64 
mš_®loc_size
,

4495 
u64
 
em±y_size
, u64 
hšt_by‹
,

4496 
bŒfs_key
 *
šs
, 
is_d©a
, 
d–®loc
)

4498 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4499 
fšd_ä“_ex‹Á_ùl
 
fã_ùl
 = {};

4500 
boŞ
 
fš®_Œ›d
 = 
num_by‹s
 =ğ
mš_®loc_size
;

4501 
u64
 
æags
;

4502 
»t
;

4503 
boŞ
 
fÜ_Œ“log
 = (
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_LOG_OBJECTID
);

4504 
boŞ
 
fÜ_d©a_»loc
 = (
	`bŒfs_is_d©a_»loc_roÙ
(
roÙ
è&& 
is_d©a
);

4506 
æags
 = 
	`g‘_®loc_´ofe_by_roÙ
(
roÙ
, 
is_d©a
);

4507 
agaš
:

4508 
	`WARN_ON
(
num_by‹s
 < 
fs_šfo
->
£ùÜsize
);

4510 
fã_ùl
.
¿m_by‹s
 =„am_bytes;

4511 
fã_ùl
.
num_by‹s
 =‚um_bytes;

4512 
fã_ùl
.
mš_®loc_size
 = min_alloc_size;

4513 
fã_ùl
.
em±y_size
 =ƒmpty_size;

4514 
fã_ùl
.
æags
 = flags;

4515 
fã_ùl
.
d–®loc
 = delalloc;

4516 
fã_ùl
.
hšt_by‹
 = hint_byte;

4517 
fã_ùl
.
fÜ_Œ“log
 = for_treelog;

4518 
fã_ùl
.
fÜ_d©a_»loc
 = for_data_reloc;

4520 
»t
 = 
	`fšd_ä“_ex‹Á
(
roÙ
, 
šs
, &
fã_ùl
);

4521 ià(!
»t
 && !
is_d©a
) {

4522 
	`bŒfs_dec_block_group_»£rv©iÚs
(
fs_šfo
, 
šs
->
objeùid
);

4523 } ià(
»t
 =ğ-
ENOSPC
) {

4524 ià(!
fš®_Œ›d
 && 
šs
->
off£t
) {

4525 
num_by‹s
 = 
	`mš
Òum_by‹ >> 1, 
šs
->
off£t
);

4526 
num_by‹s
 = 
	`round_down
(num_bytes,

4527 
fs_šfo
->
£ùÜsize
);

4528 
num_by‹s
 = 
	`max
Òum_by‹s, 
mš_®loc_size
);

4529 
¿m_by‹s
 = 
num_by‹s
;

4530 ià(
num_by‹s
 =ğ
mš_®loc_size
)

4531 
fš®_Œ›d
 = 
Œue
;

4532 
agaš
;

4533 } ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
ENOSPC_DEBUG
)) {

4534 
bŒfs_¥aû_šfo
 *
sšfo
;

4536 
sšfo
 = 
	`bŒfs_fšd_¥aû_šfo
(
fs_šfo
, 
æags
);

4537 
	`bŒfs_”r
(
fs_šfo
,

4539 
æags
, 
num_by‹s
, 
fÜ_Œ“log
, 
fÜ_d©a_»loc
);

4540 ià(
sšfo
)

4541 
	`bŒfs_dump_¥aû_šfo
(
fs_šfo
, 
sšfo
,

4542 
num_by‹s
, 1);

4546  
»t
;

4547 
	}
}

4549 
	$bŒfs_ä“_»£rved_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

4550 
u64
 
¡¬t
, u64 
Ën
, 
d–®loc
)

4552 
bŒfs_block_group
 *
ÿche
;

4554 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
¡¬t
);

4555 ià(!
ÿche
) {

4556 
	`bŒfs_”r
(
fs_šfo
, "Unableo find block group for %llu",

4557 
¡¬t
);

4558  -
ENOSPC
;

4561 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
¡¬t
, 
Ën
);

4562 
	`bŒfs_ä“_»£rved_by‹s
(
ÿche
, 
Ën
, 
d–®loc
);

4563 
	`Œaû_bŒfs_»£rved_ex‹Á_ä“
(
fs_šfo
, 
¡¬t
, 
Ën
);

4565 
	`bŒfs_put_block_group
(
ÿche
);

4567 
	}
}

4569 
	$bŒfs_pš_»£rved_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
¡¬t
,

4570 
u64
 
Ën
)

4572 
bŒfs_block_group
 *
ÿche
;

4573 
»t
 = 0;

4575 
ÿche
 = 
	`bŒfs_lookup_block_group
(
Œªs
->
fs_šfo
, 
¡¬t
);

4576 ià(!
ÿche
) {

4577 
	`bŒfs_”r
(
Œªs
->
fs_šfo
, "unableo find block group for %llu",

4578 
¡¬t
);

4579  -
ENOSPC
;

4582 
»t
 = 
	`pš_down_ex‹Á
(
Œªs
, 
ÿche
, 
¡¬t
, 
Ën
, 1);

4583 
	`bŒfs_put_block_group
(
ÿche
);

4584  
»t
;

4585 
	}
}

4587 
	$®loc_»£rved_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
by‹Ä
,

4588 
u64
 
num_by‹s
)

4590 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

4591 
»t
;

4593 
»t
 = 
	`»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
by‹Ä
, 
num_by‹s
);

4594 ià(
»t
)

4595  
»t
;

4597 
»t
 = 
	`bŒfs_upd©e_block_group
(
Œªs
, 
by‹Ä
, 
num_by‹s
, 
Œue
);

4598 ià(
»t
) {

4599 
	`ASSERT
(!
»t
);

4600 
	`bŒfs_”r
(
fs_šfo
, "update block group failed for %llu %llu",

4601 
by‹Ä
, 
num_by‹s
);

4602  
»t
;

4605 
	`Œaû_bŒfs_»£rved_ex‹Á_®loc
(
fs_šfo
, 
by‹Ä
, 
num_by‹s
);

4607 
	}
}

4609 
	$®loc_»£rved_fe_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4610 
u64
 
·»Á
, u64 
roÙ_objeùid
,

4611 
u64
 
æags
, u64 
owÃr
, u64 
off£t
,

4612 
bŒfs_key
 *
šs
, 
»f_mod
)

4614 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

4615 
bŒfs_roÙ
 *
ex‹Á_roÙ
;

4616 
»t
;

4617 
bŒfs_ex‹Á_™em
 *
ex‹Á_™em
;

4618 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

4619 
bŒfs_·th
 *
·th
;

4620 
ex‹Á_bufãr
 *
Ëaf
;

4621 
ty³
;

4622 
u32
 
size
;

4624 ià(
·»Á
 > 0)

4625 
ty³
 = 
BTRFS_SHARED_DATA_REF_KEY
;

4627 
ty³
 = 
BTRFS_EXTENT_DATA_REF_KEY
;

4629 
size
 = (*
ex‹Á_™em
è+ 
	`bŒfs_ex‹Á_šlše_»f_size
(
ty³
);

4631 
·th
 = 
	`bŒfs_®loc_·th
();

4632 ià(!
·th
)

4633  -
ENOMEM
;

4635 
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 
šs
->
objeùid
);

4636 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
ex‹Á_roÙ
, 
·th
, 
šs
, 
size
);

4637 ià(
»t
) {

4638 
	`bŒfs_ä“_·th
(
·th
);

4639  
»t
;

4642 
Ëaf
 = 
·th
->
nodes
[0];

4643 
ex‹Á_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

4644 
bŒfs_ex‹Á_™em
);

4645 
	`bŒfs_£t_ex‹Á_»fs
(
Ëaf
, 
ex‹Á_™em
, 
»f_mod
);

4646 
	`bŒfs_£t_ex‹Á_g’”©iÚ
(
Ëaf
, 
ex‹Á_™em
, 
Œªs
->
Œªsid
);

4647 
	`bŒfs_£t_ex‹Á_æags
(
Ëaf
, 
ex‹Á_™em
,

4648 
æags
 | 
BTRFS_EXTENT_FLAG_DATA
);

4650 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
ex‹Á_™em
 + 1);

4651 
	`bŒfs_£t_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
, 
ty³
);

4652 ià(
·»Á
 > 0) {

4653 
bŒfs_sh¬ed_d©a_»f
 *
»f
;

4654 
»f
 = (
bŒfs_sh¬ed_d©a_»f
 *)(
œef
 + 1);

4655 
	`bŒfs_£t_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
, 
·»Á
);

4656 
	`bŒfs_£t_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
»f
, 
»f_mod
);

4658 
bŒfs_ex‹Á_d©a_»f
 *
»f
;

4659 
»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

4660 
	`bŒfs_£t_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
»f
, 
roÙ_objeùid
);

4661 
	`bŒfs_£t_ex‹Á_d©a_»f_objeùid
(
Ëaf
, 
»f
, 
owÃr
);

4662 
	`bŒfs_£t_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
»f
, 
off£t
);

4663 
	`bŒfs_£t_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f
, 
»f_mod
);

4666 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·th
->
nodes
[0]);

4667 
	`bŒfs_ä“_·th
(
·th
);

4669  
	`®loc_»£rved_ex‹Á
(
Œªs
, 
šs
->
objeùid
, ins->
off£t
);

4670 
	}
}

4672 
	$®loc_»£rved_Œ“_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4673 
bŒfs_d–ayed_»f_node
 *
node
,

4674 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
)

4676 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

4677 
bŒfs_roÙ
 *
ex‹Á_roÙ
;

4678 
»t
;

4679 
bŒfs_ex‹Á_™em
 *
ex‹Á_™em
;

4680 
bŒfs_key
 
ex‹Á_key
;

4681 
bŒfs_Œ“_block_šfo
 *
block_šfo
;

4682 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

4683 
bŒfs_·th
 *
·th
;

4684 
ex‹Á_bufãr
 *
Ëaf
;

4685 
bŒfs_d–ayed_Œ“_»f
 *
»f
;

4686 
u32
 
size
 = (*
ex‹Á_™em
è+ (*
œef
);

4687 
u64
 
æags
 = 
ex‹Á_İ
->
æags_to_£t
;

4688 
boŞ
 
skšny_m‘ad©a
 = 
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
);

4690 
»f
 = 
	`bŒfs_d–ayed_node_to_Œ“_»f
(
node
);

4692 
ex‹Á_key
.
objeùid
 = 
node
->
by‹Ä
;

4693 ià(
skšny_m‘ad©a
) {

4694 
ex‹Á_key
.
off£t
 = 
»f
->
Ëv–
;

4695 
ex‹Á_key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

4697 
ex‹Á_key
.
off£t
 = 
node
->
num_by‹s
;

4698 
ex‹Á_key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

4699 
size
 +ğ(*
block_šfo
);

4702 
·th
 = 
	`bŒfs_®loc_·th
();

4703 ià(!
·th
)

4704  -
ENOMEM
;

4706 
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 
ex‹Á_key
.
objeùid
);

4707 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
ex‹Á_roÙ
, 
·th
, &
ex‹Á_key
,

4708 
size
);

4709 ià(
»t
) {

4710 
	`bŒfs_ä“_·th
(
·th
);

4711  
»t
;

4714 
Ëaf
 = 
·th
->
nodes
[0];

4715 
ex‹Á_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

4716 
bŒfs_ex‹Á_™em
);

4717 
	`bŒfs_£t_ex‹Á_»fs
(
Ëaf
, 
ex‹Á_™em
, 1);

4718 
	`bŒfs_£t_ex‹Á_g’”©iÚ
(
Ëaf
, 
ex‹Á_™em
, 
Œªs
->
Œªsid
);

4719 
	`bŒfs_£t_ex‹Á_æags
(
Ëaf
, 
ex‹Á_™em
,

4720 
æags
 | 
BTRFS_EXTENT_FLAG_TREE_BLOCK
);

4722 ià(
skšny_m‘ad©a
) {

4723 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
ex‹Á_™em
 + 1);

4725 
block_šfo
 = (
bŒfs_Œ“_block_šfo
 *)(
ex‹Á_™em
 + 1);

4726 
	`bŒfs_£t_Œ“_block_key
(
Ëaf
, 
block_šfo
, &
ex‹Á_İ
->
key
);

4727 
	`bŒfs_£t_Œ“_block_Ëv–
(
Ëaf
, 
block_šfo
, 
»f
->
Ëv–
);

4728 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
block_šfo
 + 1);

4731 ià(
node
->
ty³
 =ğ
BTRFS_SHARED_BLOCK_REF_KEY
) {

4732 
	`bŒfs_£t_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
,

4733 
BTRFS_SHARED_BLOCK_REF_KEY
);

4734 
	`bŒfs_£t_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
, 
»f
->
·»Á
);

4736 
	`bŒfs_£t_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
,

4737 
BTRFS_TREE_BLOCK_REF_KEY
);

4738 
	`bŒfs_£t_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
, 
»f
->
roÙ
);

4741 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

4742 
	`bŒfs_ä“_·th
(
·th
);

4744  
	`®loc_»£rved_ex‹Á
(
Œªs
, 
node
->
by‹Ä
, 
fs_šfo
->
nodesize
);

4745 
	}
}

4747 
	$bŒfs_®loc_»£rved_fe_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4748 
bŒfs_roÙ
 *
roÙ
, 
u64
 
owÃr
,

4749 
u64
 
off£t
, u64 
¿m_by‹s
,

4750 
bŒfs_key
 *
šs
)

4752 
bŒfs_»f
 
g’”ic_»f
 = { 0 };

4754 
	`BUG_ON
(
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_LOG_OBJECTID
);

4756 
	`bŒfs_š™_g’”ic_»f
(&
g’”ic_»f
, 
BTRFS_ADD_DELAYED_EXTENT
,

4757 
šs
->
objeùid
, ins->
off£t
, 0);

4758 
	`bŒfs_š™_d©a_»f
(&
g’”ic_»f
, 
roÙ
->
roÙ_key
.
objeùid
, 
owÃr
,

4759 
off£t
, 0, 
çl£
);

4760 
	`bŒfs_»f_Œ“_mod
(
roÙ
->
fs_šfo
, &
g’”ic_»f
);

4762  
	`bŒfs_add_d–ayed_d©a_»f
(
Œªs
, &
g’”ic_»f
, 
¿m_by‹s
);

4763 
	}
}

4770 
	$bŒfs_®loc_logged_fe_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4771 
u64
 
roÙ_objeùid
, u64 
owÃr
, u64 
off£t
,

4772 
bŒfs_key
 *
šs
)

4774 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

4775 
»t
;

4776 
bŒfs_block_group
 *
block_group
;

4777 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

4783 ià(!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
MIXED_GROUPS
)) {

4784 
»t
 = 
	`__exşude_logged_ex‹Á
(
fs_šfo
, 
šs
->
objeùid
,

4785 
šs
->
off£t
);

4786 ià(
»t
)

4787  
»t
;

4790 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
šs
->
objeùid
);

4791 ià(!
block_group
)

4792  -
EINVAL
;

4794 
¥aû_šfo
 = 
block_group
->space_info;

4795 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

4796 
	`¥š_lock
(&
block_group
->
lock
);

4797 
¥aû_šfo
->
by‹s_»£rved
 +ğ
šs
->
off£t
;

4798 
block_group
->
»£rved
 +ğ
šs
->
off£t
;

4799 
	`¥š_uÆock
(&
block_group
->
lock
);

4800 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

4802 
»t
 = 
	`®loc_»£rved_fe_ex‹Á
(
Œªs
, 0, 
roÙ_objeùid
, 0, 
owÃr
,

4803 
off£t
, 
šs
, 1);

4804 ià(
»t
)

4805 
	`bŒfs_pš_ex‹Á
(
Œªs
, 
šs
->
objeùid
, ins->
off£t
, 1);

4806 
	`bŒfs_put_block_group
(
block_group
);

4807  
»t
;

4808 
	}
}

4810 
ex‹Á_bufãr
 *

4811 
	$bŒfs_š™_Ãw_bufãr
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

4812 
u64
 
by‹Ä
, 
Ëv–
, u64 
owÃr
,

4813 
bŒfs_lock_Ã¡šg
 
Ã¡
)

4815 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4816 
ex‹Á_bufãr
 *
buf
;

4817 
u64
 
lockd•_owÃr
 = 
owÃr
;

4819 
buf
 = 
	`bŒfs_fšd_ü—‹_Œ“_block
(
fs_šfo
, 
by‹Ä
, 
owÃr
, 
Ëv–
);

4820 ià(
	`IS_ERR
(
buf
))

4821  
buf
;

4828 ià(
buf
->
lock_owÃr
 =ğ
cu¼’t
->
pid
) {

4829 
	`bŒfs_”r_¾
(
fs_šfo
,

4831 
buf
->
¡¬t
, 
	`bŒfs_h—d”_owÃr
(buf), 
cu¼’t
->
pid
);

4832 
	`ä“_ex‹Á_bufãr
(
buf
);

4833  
	`ERR_PTR
(-
EUCLEAN
);

4846 ià(
lockd•_owÃr
 =ğ
BTRFS_TREE_RELOC_OBJECTID
 &&

4847 !
	`‹¡_b™
(
BTRFS_ROOT_RESET_LOCKDEP_CLASS
, &
roÙ
->
¡©e
))

4848 
lockd•_owÃr
 = 
BTRFS_FS_TREE_OBJECTID
;

4851 
	`bŒfs_£t_h—d”_g’”©iÚ
(
buf
, 
Œªs
->
Œªsid
);

4858 
	`bŒfs_£t_bufãr_lockd•_şass
(
lockd•_owÃr
, 
buf
, 
Ëv–
);

4860 
	`__bŒfs_Œ“_lock
(
buf
, 
Ã¡
);

4861 
	`bŒfs_ş—r_bufãr_dœty
(
Œªs
, 
buf
);

4862 
	`ş—r_b™
(
EXTENT_BUFFER_STALE
, &
buf
->
bæags
);

4863 
	`ş—r_b™
(
EXTENT_BUFFER_NO_CHECK
, &
buf
->
bæags
);

4865 
	`£t_ex‹Á_bufãr_u±od©e
(
buf
);

4867 
	`memz”o_ex‹Á_bufãr
(
buf
, 0, (
bŒfs_h—d”
));

4868 
	`bŒfs_£t_h—d”_Ëv–
(
buf
, 
Ëv–
);

4869 
	`bŒfs_£t_h—d”_by‹Ä
(
buf
, buf->
¡¬t
);

4870 
	`bŒfs_£t_h—d”_g’”©iÚ
(
buf
, 
Œªs
->
Œªsid
);

4871 
	`bŒfs_£t_h—d”_back»f_»v
(
buf
, 
BTRFS_MIXED_BACKREF_REV
);

4872 
	`bŒfs_£t_h—d”_owÃr
(
buf
, 
owÃr
);

4873 
	`wr™e_ex‹Á_bufãr_fsid
(
buf
, 
fs_šfo
->
fs_deviûs
->
m‘ad©a_uuid
);

4874 
	`wr™e_ex‹Á_bufãr_chunk_Œ“_uuid
(
buf
, 
fs_šfo
->
chunk_Œ“_uuid
);

4875 ià(
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_LOG_OBJECTID
) {

4876 
buf
->
log_šdex
 = 
roÙ
->
log_Œªsid
 % 2;

4881 ià(
buf
->
log_šdex
 == 0)

4882 
	`£t_ex‹Á_b™
(&
roÙ
->
dœty_log_·ges
, 
buf
->
¡¬t
,

4883 
buf
->
¡¬t
 + buf->
Ën
 - 1,

4884 
EXTENT_DIRTY
, 
NULL
);

4886 
	`£t_ex‹Á_b™
(&
roÙ
->
dœty_log_·ges
, 
buf
->
¡¬t
,

4887 
buf
->
¡¬t
 + buf->
Ën
 - 1,

4888 
EXTENT_NEW
, 
NULL
);

4890 
buf
->
log_šdex
 = -1;

4891 
	`£t_ex‹Á_b™
(&
Œªs
->
Œª§ùiÚ
->
dœty_·ges
, 
buf
->
¡¬t
,

4892 
buf
->
¡¬t
 + buf->
Ën
 - 1, 
EXTENT_DIRTY
, 
NULL
);

4895  
buf
;

4896 
	}
}

4902 
ex‹Á_bufãr
 *
	$bŒfs_®loc_Œ“_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4903 
bŒfs_roÙ
 *
roÙ
,

4904 
u64
 
·»Á
, u64 
roÙ_objeùid
,

4905 cÚ¡ 
bŒfs_disk_key
 *
key
,

4906 
Ëv–
, 
u64
 
hšt
,

4907 
u64
 
em±y_size
,

4908 
bŒfs_lock_Ã¡šg
 
Ã¡
)

4910 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4911 
bŒfs_key
 
šs
;

4912 
bŒfs_block_rsv
 *
block_rsv
;

4913 
ex‹Á_bufãr
 *
buf
;

4914 
bŒfs_d–ayed_ex‹Á_İ
 *
ex‹Á_İ
;

4915 
bŒfs_»f
 
g’”ic_»f
 = { 0 };

4916 
u64
 
æags
 = 0;

4917 
»t
;

4918 
u32
 
blocksize
 = 
fs_šfo
->
nodesize
;

4919 
boŞ
 
skšny_m‘ad©a
 = 
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
);

4921 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


4922 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
)) {

4923 
buf
 = 
	`bŒfs_š™_Ãw_bufãr
(
Œªs
, 
roÙ
,„oÙ->
®loc_by‹Ä
,

4924 
Ëv–
, 
roÙ_objeùid
, 
Ã¡
);

4925 ià(!
	`IS_ERR
(
buf
))

4926 
roÙ
->
®loc_by‹Ä
 +ğ
blocksize
;

4927  
buf
;

4931 
block_rsv
 = 
	`bŒfs_u£_block_rsv
(
Œªs
, 
roÙ
, 
blocksize
);

4932 ià(
	`IS_ERR
(
block_rsv
))

4933  
	`ERR_CAST
(
block_rsv
);

4935 
»t
 = 
	`bŒfs_»£rve_ex‹Á
(
roÙ
, 
blocksize
, blocksize, blocksize,

4936 
em±y_size
, 
hšt
, &
šs
, 0, 0);

4937 ià(
»t
)

4938 
out_unu£
;

4940 
buf
 = 
	`bŒfs_š™_Ãw_bufãr
(
Œªs
, 
roÙ
, 
šs
.
objeùid
, 
Ëv–
,

4941 
roÙ_objeùid
, 
Ã¡
);

4942 ià(
	`IS_ERR
(
buf
)) {

4943 
»t
 = 
	`PTR_ERR
(
buf
);

4944 
out_ä“_»£rved
;

4947 ià(
roÙ_objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
) {

4948 ià(
·»Á
 == 0)

4949 
·»Á
 = 
šs
.
objeùid
;

4950 
æags
 |ğ
BTRFS_BLOCK_FLAG_FULL_BACKREF
;

4952 
	`BUG_ON
(
·»Á
 > 0);

4954 ià(
roÙ_objeùid
 !ğ
BTRFS_TREE_LOG_OBJECTID
) {

4955 
ex‹Á_İ
 = 
	`bŒfs_®loc_d–ayed_ex‹Á_İ
();

4956 ià(!
ex‹Á_İ
) {

4957 
»t
 = -
ENOMEM
;

4958 
out_ä“_buf
;

4960 ià(
key
)

4961 
	`memıy
(&
ex‹Á_İ
->
key
, key, (extent_op->key));

4963 
	`mem£t
(&
ex‹Á_İ
->
key
, 0, (extent_op->key));

4964 
ex‹Á_İ
->
æags_to_£t
 = 
æags
;

4965 
ex‹Á_İ
->
upd©e_key
 = 
skšny_m‘ad©a
 ? 
çl£
 : 
Œue
;

4966 
ex‹Á_İ
->
upd©e_æags
 = 
Œue
;

4967 
ex‹Á_İ
->
Ëv–
 =†evel;

4969 
	`bŒfs_š™_g’”ic_»f
(&
g’”ic_»f
, 
BTRFS_ADD_DELAYED_EXTENT
,

4970 
šs
.
objeùid
, ins.
off£t
, 
·»Á
);

4971 
	`bŒfs_š™_Œ“_»f
(&
g’”ic_»f
, 
Ëv–
, 
roÙ_objeùid
,

4972 
roÙ
->
roÙ_key
.
objeùid
, 
çl£
);

4973 
	`bŒfs_»f_Œ“_mod
(
fs_šfo
, &
g’”ic_»f
);

4974 
»t
 = 
	`bŒfs_add_d–ayed_Œ“_»f
(
Œªs
, &
g’”ic_»f
, 
ex‹Á_İ
);

4975 ià(
»t
)

4976 
out_ä“_d–ayed
;

4978  
buf
;

4980 
out_ä“_d–ayed
:

4981 
	`bŒfs_ä“_d–ayed_ex‹Á_İ
(
ex‹Á_İ
);

4982 
out_ä“_buf
:

4983 
	`bŒfs_Œ“_uÆock
(
buf
);

4984 
	`ä“_ex‹Á_bufãr
(
buf
);

4985 
out_ä“_»£rved
:

4986 
	`bŒfs_ä“_»£rved_ex‹Á
(
fs_šfo
, 
šs
.
objeùid
, ins.
off£t
, 0);

4987 
out_unu£
:

4988 
	`bŒfs_unu£_block_rsv
(
fs_šfo
, 
block_rsv
, 
blocksize
);

4989  
	`ERR_PTR
(
»t
);

4990 
	}
}

4992 
	sw®k_cÚŒŞ
 {

4993 
u64
 
	m»fs
[
BTRFS_MAX_LEVEL
];

4994 
u64
 
	mæags
[
BTRFS_MAX_LEVEL
];

4995 
bŒfs_key
 
	mupd©e_´og»ss
;

4996 
bŒfs_key
 
	mdrİ_´og»ss
;

4997 
	mdrİ_Ëv–
;

4998 
	m¡age
;

4999 
	mËv–
;

5000 
	msh¬ed_Ëv–
;

5001 
	mupd©e_»f
;

5002 
	mk“p_locks
;

5003 
	m»ada_¦Ù
;

5004 
	m»ada_couÁ
;

5005 
	m»¡¬‹d
;

5008 
	#DROP_REFERENCE
 1

	)

5009 
	#UPDATE_BACKREF
 2

	)

5011 
nošlše
 
	$»ada_w®k_down
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5012 
bŒfs_roÙ
 *
roÙ
,

5013 
w®k_cÚŒŞ
 *
wc
,

5014 
bŒfs_·th
 *
·th
)

5016 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5017 
u64
 
by‹Ä
;

5018 
u64
 
g’”©iÚ
;

5019 
u64
 
»fs
;

5020 
u64
 
æags
;

5021 
u32
 
Ä™ems
;

5022 
bŒfs_key
 
key
;

5023 
ex‹Á_bufãr
 *
eb
;

5024 
»t
;

5025 
¦Ù
;

5026 
Ä—d
 = 0;

5028 ià(
·th
->
¦Ùs
[
wc
->
Ëv–
] < wc->
»ada_¦Ù
) {

5029 
wc
->
»ada_couÁ
 = wc->reada_count * 2 / 3;

5030 
wc
->
»ada_couÁ
 = 
	`max
(wc->reada_count, 2);

5032 
wc
->
»ada_couÁ
 = wc->reada_count * 3 / 2;

5033 
wc
->
»ada_couÁ
 = 
	`mš_t
(, wc->reada_count,

5034 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
));

5037 
eb
 = 
·th
->
nodes
[
wc
->
Ëv–
];

5038 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

5040 
¦Ù
 = 
·th
->
¦Ùs
[
wc
->
Ëv–
]; slÙ < 
Ä™ems
; slot++) {

5041 ià(
Ä—d
 >ğ
wc
->
»ada_couÁ
)

5044 
	`cÚd_»sched
();

5045 
by‹Ä
 = 
	`bŒfs_node_block±r
(
eb
, 
¦Ù
);

5046 
g’”©iÚ
 = 
	`bŒfs_node_±r_g’”©iÚ
(
eb
, 
¦Ù
);

5048 ià(
¦Ù
 =ğ
·th
->
¦Ùs
[
wc
->
Ëv–
])

5049 
»ada
;

5051 ià(
wc
->
¡age
 =ğ
UPDATE_BACKREF
 &&

5052 
g’”©iÚ
 <ğ
roÙ
->
roÙ_key
.
off£t
)

5056 
»t
 = 
	`bŒfs_lookup_ex‹Á_šfo
(
Œªs
, 
fs_šfo
, 
by‹Ä
,

5057 
wc
->
Ëv–
 - 1, 1, &
»fs
,

5058 &
æags
);

5060 ià(
»t
 < 0)

5062 
	`BUG_ON
(
»fs
 == 0);

5064 ià(
wc
->
¡age
 =ğ
DROP_REFERENCE
) {

5065 ià(
»fs
 == 1)

5066 
»ada
;

5068 ià(
wc
->
Ëv–
 == 1 &&

5069 (
æags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
))

5071 ià(!
wc
->
upd©e_»f
 ||

5072 
g’”©iÚ
 <ğ
roÙ
->
roÙ_key
.
off£t
)

5074 
	`bŒfs_node_key_to_ıu
(
eb
, &
key
, 
¦Ù
);

5075 
»t
 = 
	`bŒfs_comp_ıu_keys
(&
key
,

5076 &
wc
->
upd©e_´og»ss
);

5077 ià(
»t
 < 0)

5080 ià(
wc
->
Ëv–
 == 1 &&

5081 (
æags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
))

5084 
»ada
:

5085 
	`bŒfs_»adah—d_node_chd
(
eb
, 
¦Ù
);

5086 
Ä—d
++;

5088 
wc
->
»ada_¦Ù
 = 
¦Ù
;

5089 
	}
}

5099 
nošlše
 
	$w®k_down_´oc
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5100 
bŒfs_roÙ
 *
roÙ
,

5101 
bŒfs_·th
 *
·th
,

5102 
w®k_cÚŒŞ
 *
wc
, 
lookup_šfo
)

5104 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5105 
Ëv–
 = 
wc
->level;

5106 
ex‹Á_bufãr
 *
eb
 = 
·th
->
nodes
[
Ëv–
];

5107 
u64
 
æag
 = 
BTRFS_BLOCK_FLAG_FULL_BACKREF
;

5108 
»t
;

5110 ià(
wc
->
¡age
 =ğ
UPDATE_BACKREF
 &&

5111 
	`bŒfs_h—d”_owÃr
(
eb
è!ğ
roÙ
->
roÙ_key
.
objeùid
)

5118 ià(
lookup_šfo
 &&

5119 ((
wc
->
¡age
 =ğ
DROP_REFERENCE
 && wc->
»fs
[
Ëv–
] != 1) ||

5120 (
wc
->
¡age
 =ğ
UPDATE_BACKREF
 && !(wc->
æags
[
Ëv–
] & 
æag
)))) {

5121 
	`BUG_ON
(!
·th
->
locks
[
Ëv–
]);

5122 
»t
 = 
	`bŒfs_lookup_ex‹Á_šfo
(
Œªs
, 
fs_šfo
,

5123 
eb
->
¡¬t
, 
Ëv–
, 1,

5124 &
wc
->
»fs
[
Ëv–
],

5125 &
wc
->
æags
[
Ëv–
]);

5126 
	`BUG_ON
(
»t
 =ğ-
ENOMEM
);

5127 ià(
»t
)

5128  
»t
;

5129 
	`BUG_ON
(
wc
->
»fs
[
Ëv–
] == 0);

5132 ià(
wc
->
¡age
 =ğ
DROP_REFERENCE
) {

5133 ià(
wc
->
»fs
[
Ëv–
] > 1)

5136 ià(
·th
->
locks
[
Ëv–
] && !
wc
->
k“p_locks
) {

5137 
	`bŒfs_Œ“_uÆock_rw
(
eb
, 
·th
->
locks
[
Ëv–
]);

5138 
·th
->
locks
[
Ëv–
] = 0;

5144 ià(!(
wc
->
æags
[
Ëv–
] & 
æag
)) {

5145 
	`BUG_ON
(!
·th
->
locks
[
Ëv–
]);

5146 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
eb
, 1);

5147 
	`BUG_ON
(
»t
);

5148 
»t
 = 
	`bŒfs_dec_»f
(
Œªs
, 
roÙ
, 
eb
, 0);

5149 
	`BUG_ON
(
»t
);

5150 
»t
 = 
	`bŒfs_£t_disk_ex‹Á_æags
(
Œªs
, 
eb
, 
æag
);

5151 
	`BUG_ON
(
»t
);

5152 
wc
->
æags
[
Ëv–
] |ğ
æag
;

5159 ià(
·th
->
locks
[
Ëv–
] &&†evel > 0) {

5160 
	`bŒfs_Œ“_uÆock_rw
(
eb
, 
·th
->
locks
[
Ëv–
]);

5161 
·th
->
locks
[
Ëv–
] = 0;

5164 
	}
}

5170 
	$check_»f_exi¡s
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5171 
bŒfs_roÙ
 *
roÙ
, 
u64
 
by‹Ä
, u64 
·»Á
,

5172 
Ëv–
)

5174 
bŒfs_·th
 *
·th
;

5175 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

5176 
»t
;

5178 
·th
 = 
	`bŒfs_®loc_·th
();

5179 ià(!
·th
)

5180  -
ENOMEM
;

5182 
»t
 = 
	`lookup_ex‹Á_back»f
(
Œªs
, 
·th
, &
œef
, 
by‹Ä
,

5183 
roÙ
->
fs_šfo
->
nodesize
, 
·»Á
,

5184 
roÙ
->
roÙ_key
.
objeùid
, 
Ëv–
, 0);

5185 
	`bŒfs_ä“_·th
(
·th
);

5186 ià(
»t
 =ğ-
ENOENT
)

5188 ià(
»t
 < 0)

5189  
»t
;

5191 
	}
}

5206 
nošlše
 
	$do_w®k_down
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5207 
bŒfs_roÙ
 *
roÙ
,

5208 
bŒfs_·th
 *
·th
,

5209 
w®k_cÚŒŞ
 *
wc
, *
lookup_šfo
)

5211 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5212 
u64
 
by‹Ä
;

5213 
u64
 
g’”©iÚ
;

5214 
u64
 
·»Á
;

5215 
bŒfs_Œ“_·»Á_check
 
check
 = { 0 };

5216 
bŒfs_key
 
key
;

5217 
bŒfs_»f
 
»f
 = { 0 };

5218 
ex‹Á_bufãr
 *
Ãxt
;

5219 
Ëv–
 = 
wc
->level;

5220 
»ada
 = 0;

5221 
»t
 = 0;

5222 
boŞ
 
Ãed_accouÁ
 = 
çl£
;

5224 
g’”©iÚ
 = 
	`bŒfs_node_±r_g’”©iÚ
(
·th
->
nodes
[
Ëv–
],

5225 
·th
->
¦Ùs
[
Ëv–
]);

5231 ià(
wc
->
¡age
 =ğ
UPDATE_BACKREF
 &&

5232 
g’”©iÚ
 <ğ
roÙ
->
roÙ_key
.
off£t
) {

5233 *
lookup_šfo
 = 1;

5237 
by‹Ä
 = 
	`bŒfs_node_block±r
(
·th
->
nodes
[
Ëv–
],…©h->
¦Ùs
[level]);

5239 
check
.
Ëv–
 =†evel - 1;

5240 
check
.
Œªsid
 = 
g’”©iÚ
;

5241 
check
.
owÃr_roÙ
 = 
roÙ
->
roÙ_key
.
objeùid
;

5242 
check
.
has_fœ¡_key
 = 
Œue
;

5243 
	`bŒfs_node_key_to_ıu
(
·th
->
nodes
[
Ëv–
], &
check
.
fœ¡_key
,

5244 
·th
->
¦Ùs
[
Ëv–
]);

5246 
Ãxt
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
by‹Ä
);

5247 ià(!
Ãxt
) {

5248 
Ãxt
 = 
	`bŒfs_fšd_ü—‹_Œ“_block
(
fs_šfo
, 
by‹Ä
,

5249 
roÙ
->
roÙ_key
.
objeùid
, 
Ëv–
 - 1);

5250 ià(
	`IS_ERR
(
Ãxt
))

5251  
	`PTR_ERR
(
Ãxt
);

5252 
»ada
 = 1;

5254 
	`bŒfs_Œ“_lock
(
Ãxt
);

5256 
»t
 = 
	`bŒfs_lookup_ex‹Á_šfo
(
Œªs
, 
fs_šfo
, 
by‹Ä
, 
Ëv–
 - 1, 1,

5257 &
wc
->
»fs
[
Ëv–
 - 1],

5258 &
wc
->
æags
[
Ëv–
 - 1]);

5259 ià(
»t
 < 0)

5260 
out_uÆock
;

5262 ià(
	`uÆik–y
(
wc
->
»fs
[
Ëv–
 - 1] == 0)) {

5263 
	`bŒfs_”r
(
fs_šfo
, "Missing„eferences.");

5264 
»t
 = -
EIO
;

5265 
out_uÆock
;

5267 *
lookup_šfo
 = 0;

5269 ià(
wc
->
¡age
 =ğ
DROP_REFERENCE
) {

5270 ià(
wc
->
»fs
[
Ëv–
 - 1] > 1) {

5271 
Ãed_accouÁ
 = 
Œue
;

5272 ià(
Ëv–
 == 1 &&

5273 (
wc
->
æags
[0] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
))

5274 
sk
;

5276 ià(!
wc
->
upd©e_»f
 ||

5277 
g’”©iÚ
 <ğ
roÙ
->
roÙ_key
.
off£t
)

5278 
sk
;

5280 
	`bŒfs_node_key_to_ıu
(
·th
->
nodes
[
Ëv–
], &
key
,

5281 
·th
->
¦Ùs
[
Ëv–
]);

5282 
»t
 = 
	`bŒfs_comp_ıu_keys
(&
key
, &
wc
->
upd©e_´og»ss
);

5283 ià(
»t
 < 0)

5284 
sk
;

5286 
wc
->
¡age
 = 
UPDATE_BACKREF
;

5287 
wc
->
sh¬ed_Ëv–
 = 
Ëv–
 - 1;

5290 ià(
Ëv–
 == 1 &&

5291 (
wc
->
æags
[0] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
))

5292 
sk
;

5295 ià(!
	`bŒfs_bufãr_u±od©e
(
Ãxt
, 
g’”©iÚ
, 0)) {

5296 
	`bŒfs_Œ“_uÆock
(
Ãxt
);

5297 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

5298 
Ãxt
 = 
NULL
;

5299 *
lookup_šfo
 = 1;

5302 ià(!
Ãxt
) {

5303 ià(
»ada
 && 
Ëv–
 == 1)

5304 
	`»ada_w®k_down
(
Œªs
, 
roÙ
, 
wc
, 
·th
);

5305 
Ãxt
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
by‹Ä
, &
check
);

5306 ià(
	`IS_ERR
(
Ãxt
)) {

5307  
	`PTR_ERR
(
Ãxt
);

5308 } ià(!
	`ex‹Á_bufãr_u±od©e
(
Ãxt
)) {

5309 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

5310  -
EIO
;

5312 
	`bŒfs_Œ“_lock
(
Ãxt
);

5315 
Ëv–
--;

5316 
	`ASSERT
(
Ëv–
 =ğ
	`bŒfs_h—d”_Ëv–
(
Ãxt
));

5317 ià(
Ëv–
 !ğ
	`bŒfs_h—d”_Ëv–
(
Ãxt
)) {

5318 
	`bŒfs_”r
(
roÙ
->
fs_šfo
, "mismatched†evel");

5319 
»t
 = -
EIO
;

5320 
out_uÆock
;

5322 
·th
->
nodes
[
Ëv–
] = 
Ãxt
;

5323 
·th
->
¦Ùs
[
Ëv–
] = 0;

5324 
·th
->
locks
[
Ëv–
] = 
BTRFS_WRITE_LOCK
;

5325 
wc
->
Ëv–
 =†evel;

5326 ià(
wc
->
Ëv–
 == 1)

5327 
wc
->
»ada_¦Ù
 = 0;

5329 
sk
:

5330 
wc
->
»fs
[
Ëv–
 - 1] = 0;

5331 
wc
->
æags
[
Ëv–
 - 1] = 0;

5332 ià(
wc
->
¡age
 =ğ
DROP_REFERENCE
) {

5333 ià(
wc
->
æags
[
Ëv–
] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
) {

5334 
·»Á
 = 
·th
->
nodes
[
Ëv–
]->
¡¬t
;

5336 
	`ASSERT
(
roÙ
->
roÙ_key
.
objeùid
 ==

5337 
	`bŒfs_h—d”_owÃr
(
·th
->
nodes
[
Ëv–
]));

5338 ià(
roÙ
->
roÙ_key
.
objeùid
 !=

5339 
	`bŒfs_h—d”_owÃr
(
·th
->
nodes
[
Ëv–
])) {

5340 
	`bŒfs_”r
(
roÙ
->
fs_šfo
,

5342 
»t
 = -
EIO
;

5343 
out_uÆock
;

5345 
·»Á
 = 0;

5354 ià(
wc
->
»¡¬‹d
) {

5355 
»t
 = 
	`check_»f_exi¡s
(
Œªs
, 
roÙ
, 
by‹Ä
, 
·»Á
,

5356 
Ëv–
 - 1);

5357 ià(
»t
 < 0)

5358 
out_uÆock
;

5359 ià(
»t
 == 0)

5360 
no_d–‘e
;

5361 
»t
 = 0;

5362 
wc
->
»¡¬‹d
 = 0;

5370 ià(
roÙ
->
roÙ_key
.
objeùid
 !ğ
BTRFS_TREE_RELOC_OBJECTID
 &&

5371 
Ãed_accouÁ
) {

5372 
»t
 = 
	`bŒfs_qgroup_Œaû_subŒ“
(
Œªs
, 
Ãxt
,

5373 
g’”©iÚ
, 
Ëv–
 - 1);

5374 ià(
»t
) {

5375 
	`bŒfs_”r_¾
(
fs_šfo
,

5377 
»t
);

5387 
wc
->
drİ_Ëv–
 = 
Ëv–
;

5388 
	`fšd_Ãxt_key
(
·th
, 
Ëv–
, &
wc
->
drİ_´og»ss
);

5390 
	`bŒfs_š™_g’”ic_»f
(&
»f
, 
BTRFS_DROP_DELAYED_REF
, 
by‹Ä
,

5391 
fs_šfo
->
nodesize
, 
·»Á
);

5392 
	`bŒfs_š™_Œ“_»f
(&
»f
, 
Ëv–
 - 1, 
roÙ
->
roÙ_key
.
objeùid
,

5393 0, 
çl£
);

5394 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, &
»f
);

5395 ià(
»t
)

5396 
out_uÆock
;

5398 
no_d–‘e
:

5399 *
lookup_šfo
 = 1;

5400 
»t
 = 1;

5402 
out_uÆock
:

5403 
	`bŒfs_Œ“_uÆock
(
Ãxt
);

5404 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

5406  
»t
;

5407 
	}
}

5421 
nošlše
 
	$w®k_up_´oc
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5422 
bŒfs_roÙ
 *
roÙ
,

5423 
bŒfs_·th
 *
·th
,

5424 
w®k_cÚŒŞ
 *
wc
)

5426 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5427 
»t
;

5428 
Ëv–
 = 
wc
->level;

5429 
ex‹Á_bufãr
 *
eb
 = 
·th
->
nodes
[
Ëv–
];

5430 
u64
 
·»Á
 = 0;

5432 ià(
wc
->
¡age
 =ğ
UPDATE_BACKREF
) {

5433 
	`BUG_ON
(
wc
->
sh¬ed_Ëv–
 < 
Ëv–
);

5434 ià(
Ëv–
 < 
wc
->
sh¬ed_Ëv–
)

5435 
out
;

5437 
»t
 = 
	`fšd_Ãxt_key
(
·th
, 
Ëv–
 + 1, &
wc
->
upd©e_´og»ss
);

5438 ià(
»t
 > 0)

5439 
wc
->
upd©e_»f
 = 0;

5441 
wc
->
¡age
 = 
DROP_REFERENCE
;

5442 
wc
->
sh¬ed_Ëv–
 = -1;

5443 
·th
->
¦Ùs
[
Ëv–
] = 0;

5450 ià(!
·th
->
locks
[
Ëv–
]) {

5451 
	`BUG_ON
(
Ëv–
 == 0);

5452 
	`bŒfs_Œ“_lock
(
eb
);

5453 
·th
->
locks
[
Ëv–
] = 
BTRFS_WRITE_LOCK
;

5455 
»t
 = 
	`bŒfs_lookup_ex‹Á_šfo
(
Œªs
, 
fs_šfo
,

5456 
eb
->
¡¬t
, 
Ëv–
, 1,

5457 &
wc
->
»fs
[
Ëv–
],

5458 &
wc
->
æags
[
Ëv–
]);

5459 ià(
»t
 < 0) {

5460 
	`bŒfs_Œ“_uÆock_rw
(
eb
, 
·th
->
locks
[
Ëv–
]);

5461 
·th
->
locks
[
Ëv–
] = 0;

5462  
»t
;

5464 
	`BUG_ON
(
wc
->
»fs
[
Ëv–
] == 0);

5465 ià(
wc
->
»fs
[
Ëv–
] == 1) {

5466 
	`bŒfs_Œ“_uÆock_rw
(
eb
, 
·th
->
locks
[
Ëv–
]);

5467 
·th
->
locks
[
Ëv–
] = 0;

5474 
	`BUG_ON
(
wc
->
»fs
[
Ëv–
] > 1 && !
·th
->
locks
[level]);

5476 ià(
wc
->
»fs
[
Ëv–
] == 1) {

5477 ià(
Ëv–
 == 0) {

5478 ià(
wc
->
æags
[
Ëv–
] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
)

5479 
»t
 = 
	`bŒfs_dec_»f
(
Œªs
, 
roÙ
, 
eb
, 1);

5481 
»t
 = 
	`bŒfs_dec_»f
(
Œªs
, 
roÙ
, 
eb
, 0);

5482 
	`BUG_ON
(
»t
);

5483 ià(
	`is_f¡»e
(
roÙ
->
roÙ_key
.
objeùid
)) {

5484 
»t
 = 
	`bŒfs_qgroup_Œaû_Ëaf_™ems
(
Œªs
, 
eb
);

5485 ià(
»t
) {

5486 
	`bŒfs_”r_¾
(
fs_šfo
,

5488 
»t
);

5493 ià(!
·th
->
locks
[
Ëv–
]) {

5494 
	`bŒfs_Œ“_lock
(
eb
);

5495 
·th
->
locks
[
Ëv–
] = 
BTRFS_WRITE_LOCK
;

5497 
	`bŒfs_ş—r_bufãr_dœty
(
Œªs
, 
eb
);

5500 ià(
eb
 =ğ
roÙ
->
node
) {

5501 ià(
wc
->
æags
[
Ëv–
] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
)

5502 
·»Á
 = 
eb
->
¡¬t
;

5503 ià(
roÙ
->
roÙ_key
.
objeùid
 !ğ
	`bŒfs_h—d”_owÃr
(
eb
))

5504 
owÃr_mism©ch
;

5506 ià(
wc
->
æags
[
Ëv–
 + 1] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
)

5507 
·»Á
 = 
·th
->
nodes
[
Ëv–
 + 1]->
¡¬t
;

5508 ià(
roÙ
->
roÙ_key
.
objeùid
 !=

5509 
	`bŒfs_h—d”_owÃr
(
·th
->
nodes
[
Ëv–
 + 1]))

5510 
owÃr_mism©ch
;

5513 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
	`bŒfs_roÙ_id
(
roÙ
), 
eb
, 
·»Á
,

5514 
wc
->
»fs
[
Ëv–
] == 1);

5515 
out
:

5516 
wc
->
»fs
[
Ëv–
] = 0;

5517 
wc
->
æags
[
Ëv–
] = 0;

5520 
owÃr_mism©ch
:

5521 
	`bŒfs_”r_¾
(
fs_šfo
, "unexpectedree owner, have %lluƒxpect %llu",

5522 
	`bŒfs_h—d”_owÃr
(
eb
), 
roÙ
->
roÙ_key
.
objeùid
);

5523  -
EUCLEAN
;

5524 
	}
}

5526 
nošlše
 
	$w®k_down_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5527 
bŒfs_roÙ
 *
roÙ
,

5528 
bŒfs_·th
 *
·th
,

5529 
w®k_cÚŒŞ
 *
wc
)

5531 
Ëv–
 = 
wc
->level;

5532 
lookup_šfo
 = 1;

5533 
»t
 = 0;

5535 
Ëv–
 >= 0) {

5536 
»t
 = 
	`w®k_down_´oc
(
Œªs
, 
roÙ
, 
·th
, 
wc
, 
lookup_šfo
);

5537 ià(
»t
)

5540 ià(
Ëv–
 == 0)

5543 ià(
·th
->
¦Ùs
[
Ëv–
] >=

5544 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[
Ëv–
]))

5547 
»t
 = 
	`do_w®k_down
(
Œªs
, 
roÙ
, 
·th
, 
wc
, &
lookup_šfo
);

5548 ià(
»t
 > 0) {

5549 
·th
->
¦Ùs
[
Ëv–
]++;

5551 } ià(
»t
 < 0)

5553 
Ëv–
 = 
wc
->level;

5555  (
»t
 == 1) ? 0 :„et;

5556 
	}
}

5558 
nošlše
 
	$w®k_up_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5559 
bŒfs_roÙ
 *
roÙ
,

5560 
bŒfs_·th
 *
·th
,

5561 
w®k_cÚŒŞ
 *
wc
, 
max_Ëv–
)

5563 
Ëv–
 = 
wc
->level;

5564 
»t
;

5566 
·th
->
¦Ùs
[
Ëv–
] = 
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[level]);

5567 
Ëv–
 < 
max_Ëv–
 && 
·th
->
nodes
[level]) {

5568 
wc
->
Ëv–
 =†evel;

5569 ià(
·th
->
¦Ùs
[
Ëv–
] + 1 <

5570 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[
Ëv–
])) {

5571 
·th
->
¦Ùs
[
Ëv–
]++;

5574 
»t
 = 
	`w®k_up_´oc
(
Œªs
, 
roÙ
, 
·th
, 
wc
);

5575 ià(
»t
 > 0)

5577 ià(
»t
 < 0)

5578  
»t
;

5580 ià(
·th
->
locks
[
Ëv–
]) {

5581 
	`bŒfs_Œ“_uÆock_rw
(
·th
->
nodes
[
Ëv–
],

5582 
·th
->
locks
[
Ëv–
]);

5583 
·th
->
locks
[
Ëv–
] = 0;

5585 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[
Ëv–
]);

5586 
·th
->
nodes
[
Ëv–
] = 
NULL
;

5587 
Ëv–
++;

5591 
	}
}

5606 
	$bŒfs_drİ_¢­shÙ
(
bŒfs_roÙ
 *
roÙ
, 
upd©e_»f
, 
fÜ_»loc
)

5608 cÚ¡ 
boŞ
 
is_»loc_roÙ
 = (
roÙ
->
roÙ_key
.
objeùid
 ==

5609 
BTRFS_TREE_RELOC_OBJECTID
);

5610 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5611 
bŒfs_·th
 *
·th
;

5612 
bŒfs_Œªs_hªdË
 *
Œªs
;

5613 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

5614 
bŒfs_roÙ_™em
 *
roÙ_™em
 = &
roÙ
->root_item;

5615 
w®k_cÚŒŞ
 *
wc
;

5616 
bŒfs_key
 
key
;

5617 
”r
 = 0;

5618 
»t
;

5619 
Ëv–
;

5620 
boŞ
 
roÙ_drİ³d
 = 
çl£
;

5621 
boŞ
 
unfšished_drİ
 = 
çl£
;

5623 
	`bŒfs_debug
(
fs_šfo
, "Drİ subvŞum%Îu", 
roÙ
->
roÙ_key
.
objeùid
);

5625 
·th
 = 
	`bŒfs_®loc_·th
();

5626 ià(!
·th
) {

5627 
”r
 = -
ENOMEM
;

5628 
out
;

5631 
wc
 = 
	`kz®loc
((*wc), 
GFP_NOFS
);

5632 ià(!
wc
) {

5633 
	`bŒfs_ä“_·th
(
·th
);

5634 
”r
 = -
ENOMEM
;

5635 
out
;

5642 ià(
fÜ_»loc
)

5643 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
Œ“_roÙ
);

5645 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
Œ“_roÙ
, 0);

5646 ià(
	`IS_ERR
(
Œªs
)) {

5647 
”r
 = 
	`PTR_ERR
(
Œªs
);

5648 
out_ä“
;

5651 
”r
 = 
	`bŒfs_run_d–ayed_™ems
(
Œªs
);

5652 ià(
”r
)

5653 
out_’d_Œªs
;

5663 
	`£t_b™
(
BTRFS_ROOT_DELETING
, &
roÙ
->
¡©e
);

5664 
unfšished_drİ
 = 
	`‹¡_b™
(
BTRFS_ROOT_UNFINISHED_DROP
, &
roÙ
->
¡©e
);

5666 ià(
	`bŒfs_disk_key_objeùid
(&
roÙ_™em
->
drİ_´og»ss
) == 0) {

5667 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
roÙ
->
node
);

5668 
·th
->
nodes
[
Ëv–
] = 
	`bŒfs_lock_roÙ_node
(
roÙ
);

5669 
·th
->
¦Ùs
[
Ëv–
] = 0;

5670 
·th
->
locks
[
Ëv–
] = 
BTRFS_WRITE_LOCK
;

5671 
	`mem£t
(&
wc
->
upd©e_´og»ss
, 0,

5672 (
wc
->
upd©e_´og»ss
));

5674 
	`bŒfs_disk_key_to_ıu
(&
key
, &
roÙ_™em
->
drİ_´og»ss
);

5675 
	`memıy
(&
wc
->
upd©e_´og»ss
, &
key
,

5676 (
wc
->
upd©e_´og»ss
));

5678 
Ëv–
 = 
	`bŒfs_roÙ_drİ_Ëv–
(
roÙ_™em
);

5679 
	`BUG_ON
(
Ëv–
 == 0);

5680 
·th
->
lowe¡_Ëv–
 = 
Ëv–
;

5681 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

5682 
·th
->
lowe¡_Ëv–
 = 0;

5683 ià(
»t
 < 0) {

5684 
”r
 = 
»t
;

5685 
out_’d_Œªs
;

5687 
	`WARN_ON
(
»t
 > 0);

5693 
	`bŒfs_uÆock_up_§ã
(
·th
, 0);

5695 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
roÙ
->
node
);

5697 
	`bŒfs_Œ“_lock
(
·th
->
nodes
[
Ëv–
]);

5698 
·th
->
locks
[
Ëv–
] = 
BTRFS_WRITE_LOCK
;

5700 
»t
 = 
	`bŒfs_lookup_ex‹Á_šfo
(
Œªs
, 
fs_šfo
,

5701 
·th
->
nodes
[
Ëv–
]->
¡¬t
,

5702 
Ëv–
, 1, &
wc
->
»fs
[level],

5703 &
wc
->
æags
[
Ëv–
]);

5704 ià(
»t
 < 0) {

5705 
”r
 = 
»t
;

5706 
out_’d_Œªs
;

5708 
	`BUG_ON
(
wc
->
»fs
[
Ëv–
] == 0);

5710 ià(
Ëv–
 =ğ
	`bŒfs_roÙ_drİ_Ëv–
(
roÙ_™em
))

5713 
	`bŒfs_Œ“_uÆock
(
·th
->
nodes
[
Ëv–
]);

5714 
·th
->
locks
[
Ëv–
] = 0;

5715 
	`WARN_ON
(
wc
->
»fs
[
Ëv–
] != 1);

5716 
Ëv–
--;

5720 
wc
->
»¡¬‹d
 = 
	`‹¡_b™
(
BTRFS_ROOT_DEAD_TREE
, &
roÙ
->
¡©e
);

5721 
wc
->
Ëv–
 =†evel;

5722 
wc
->
sh¬ed_Ëv–
 = -1;

5723 
wc
->
¡age
 = 
DROP_REFERENCE
;

5724 
wc
->
upd©e_»f
 = update_ref;

5725 
wc
->
k“p_locks
 = 0;

5726 
wc
->
»ada_couÁ
 = 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
);

5730 
»t
 = 
	`w®k_down_Œ“
(
Œªs
, 
roÙ
, 
·th
, 
wc
);

5731 ià(
»t
 < 0) {

5732 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

5733 
”r
 = 
»t
;

5737 
»t
 = 
	`w®k_up_Œ“
(
Œªs
, 
roÙ
, 
·th
, 
wc
, 
BTRFS_MAX_LEVEL
);

5738 ià(
»t
 < 0) {

5739 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

5740 
”r
 = 
»t
;

5744 ià(
»t
 > 0) {

5745 
	`BUG_ON
(
wc
->
¡age
 !ğ
DROP_REFERENCE
);

5749 ià(
wc
->
¡age
 =ğ
DROP_REFERENCE
) {

5750 
wc
->
drİ_Ëv–
 = wc->
Ëv–
;

5751 
	`bŒfs_node_key_to_ıu
(
·th
->
nodes
[
wc
->
drİ_Ëv–
],

5752 &
wc
->
drİ_´og»ss
,

5753 
·th
->
¦Ùs
[
wc
->
drİ_Ëv–
]);

5755 
	`bŒfs_ıu_key_to_disk
(&
roÙ_™em
->
drİ_´og»ss
,

5756 &
wc
->
drİ_´og»ss
);

5757 
	`bŒfs_£t_roÙ_drİ_Ëv–
(
roÙ_™em
, 
wc
->
drİ_Ëv–
);

5759 
	`BUG_ON
(
wc
->
Ëv–
 == 0);

5760 ià(
	`bŒfs_should_’d_Œª§ùiÚ
(
Œªs
) ||

5761 (!
fÜ_»loc
 && 
	`bŒfs_Ãed_ş—Ãr_¦“p
(
fs_šfo
))) {

5762 
»t
 = 
	`bŒfs_upd©e_roÙ
(
Œªs
, 
Œ“_roÙ
,

5763 &
roÙ
->
roÙ_key
,

5764 
roÙ_™em
);

5765 ià(
»t
) {

5766 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

5767 
”r
 = 
»t
;

5768 
out_’d_Œªs
;

5771 ià(!
is_»loc_roÙ
)

5772 
	`bŒfs_£t_Ï¡_roÙ_drİ_g’
(
fs_šfo
, 
Œªs
->
Œªsid
);

5774 
	`bŒfs_’d_Œª§ùiÚ_thrÙe
(
Œªs
);

5775 ià(!
fÜ_»loc
 && 
	`bŒfs_Ãed_ş—Ãr_¦“p
(
fs_šfo
)) {

5776 
	`bŒfs_debug
(
fs_šfo
,

5778 
”r
 = -
EAGAIN
;

5779 
out_ä“
;

5787 ià(
fÜ_»loc
)

5788 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
Œ“_roÙ
);

5790 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
Œ“_roÙ
, 0);

5791 ià(
	`IS_ERR
(
Œªs
)) {

5792 
”r
 = 
	`PTR_ERR
(
Œªs
);

5793 
out_ä“
;

5797 
	`bŒfs_»Ëa£_·th
(
·th
);

5798 ià(
”r
)

5799 
out_’d_Œªs
;

5801 
»t
 = 
	`bŒfs_d–_roÙ
(
Œªs
, &
roÙ
->
roÙ_key
);

5802 ià(
»t
) {

5803 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

5804 
”r
 = 
»t
;

5805 
out_’d_Œªs
;

5808 ià(!
is_»loc_roÙ
) {

5809 
»t
 = 
	`bŒfs_fšd_roÙ
(
Œ“_roÙ
, &
roÙ
->
roÙ_key
, 
·th
,

5810 
NULL
, NULL);

5811 ià(
»t
 < 0) {

5812 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

5813 
”r
 = 
»t
;

5814 
out_’d_Œªs
;

5815 } ià(
»t
 > 0) {

5821 
	`bŒfs_d–_Üphª_™em
(
Œªs
, 
Œ“_roÙ
,

5822 
roÙ
->
roÙ_key
.
objeùid
);

5831 
	`bŒfs_qgroup_cÚv”t_»£rved_m‘a
(
roÙ
, 
INT_MAX
);

5832 
	`bŒfs_qgroup_ä“_m‘a_®l_³¹¿ns
(
roÙ
);

5834 ià(
	`‹¡_b™
(
BTRFS_ROOT_IN_RADIX
, &
roÙ
->
¡©e
))

5835 
	`bŒfs_add_drİ³d_roÙ
(
Œªs
, 
roÙ
);

5837 
	`bŒfs_put_roÙ
(
roÙ
);

5838 
roÙ_drİ³d
 = 
Œue
;

5839 
out_’d_Œªs
:

5840 ià(!
is_»loc_roÙ
)

5841 
	`bŒfs_£t_Ï¡_roÙ_drİ_g’
(
fs_šfo
, 
Œªs
->
Œªsid
);

5843 
	`bŒfs_’d_Œª§ùiÚ_thrÙe
(
Œªs
);

5844 
out_ä“
:

5845 
	`kä“
(
wc
);

5846 
	`bŒfs_ä“_·th
(
·th
);

5847 
out
:

5852 ià(!
”r
 && 
unfšished_drİ
)

5853 
	`bŒfs_maybe_wake_unfšished_drİ
(
fs_šfo
);

5862 ià(!
fÜ_»loc
 && !
roÙ_drİ³d
)

5863 
	`bŒfs_add_d—d_roÙ
(
roÙ
);

5864  
”r
;

5865 
	}
}

5873 
	$bŒfs_drİ_subŒ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5874 
bŒfs_roÙ
 *
roÙ
,

5875 
ex‹Á_bufãr
 *
node
,

5876 
ex‹Á_bufãr
 *
·»Á
)

5878 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5879 
bŒfs_·th
 *
·th
;

5880 
w®k_cÚŒŞ
 *
wc
;

5881 
Ëv–
;

5882 
·»Á_Ëv–
;

5883 
»t
 = 0;

5884 
w»t
;

5886 
	`BUG_ON
(
roÙ
->
roÙ_key
.
objeùid
 !ğ
BTRFS_TREE_RELOC_OBJECTID
);

5888 
·th
 = 
	`bŒfs_®loc_·th
();

5889 ià(!
·th
)

5890  -
ENOMEM
;

5892 
wc
 = 
	`kz®loc
((*wc), 
GFP_NOFS
);

5893 ià(!
wc
) {

5894 
	`bŒfs_ä“_·th
(
·th
);

5895  -
ENOMEM
;

5898 
	`bŒfs_as£¹_Œ“_wr™e_locked
(
·»Á
);

5899 
·»Á_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
·»Á
);

5900 
	`©omic_šc
(&
·»Á
->
»fs
);

5901 
·th
->
nodes
[
·»Á_Ëv–
] = 
·»Á
;

5902 
·th
->
¦Ùs
[
·»Á_Ëv–
] = 
	`bŒfs_h—d”_Ä™ems
(
·»Á
);

5904 
	`bŒfs_as£¹_Œ“_wr™e_locked
(
node
);

5905 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
node
);

5906 
·th
->
nodes
[
Ëv–
] = 
node
;

5907 
·th
->
¦Ùs
[
Ëv–
] = 0;

5908 
·th
->
locks
[
Ëv–
] = 
BTRFS_WRITE_LOCK
;

5910 
wc
->
»fs
[
·»Á_Ëv–
] = 1;

5911 
wc
->
æags
[
·»Á_Ëv–
] = 
BTRFS_BLOCK_FLAG_FULL_BACKREF
;

5912 
wc
->
Ëv–
 =†evel;

5913 
wc
->
sh¬ed_Ëv–
 = -1;

5914 
wc
->
¡age
 = 
DROP_REFERENCE
;

5915 
wc
->
upd©e_»f
 = 0;

5916 
wc
->
k“p_locks
 = 1;

5917 
wc
->
»ada_couÁ
 = 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
);

5920 
w»t
 = 
	`w®k_down_Œ“
(
Œªs
, 
roÙ
, 
·th
, 
wc
);

5921 ià(
w»t
 < 0) {

5922 
»t
 = 
w»t
;

5926 
w»t
 = 
	`w®k_up_Œ“
(
Œªs
, 
roÙ
, 
·th
, 
wc
, 
·»Á_Ëv–
);

5927 ià(
w»t
 < 0)

5928 
»t
 = 
w»t
;

5929 ià(
w»t
 != 0)

5933 
	`kä“
(
wc
);

5934 
	`bŒfs_ä“_·th
(
·th
);

5935  
»t
;

5936 
	}
}

5938 
	$bŒfs_”rÜ_uÅš_ex‹Á_¿nge
(
bŒfs_fs_šfo
 *
fs_šfo
,

5939 
u64
 
¡¬t
, u64 
’d
)

5941  
	`uÅš_ex‹Á_¿nge
(
fs_šfo
, 
¡¬t
, 
’d
, 
çl£
);

5942 
	}
}

5964 
	$bŒfs_Œim_ä“_ex‹Ás
(
bŒfs_deviû
 *
deviû
, 
u64
 *
Œimmed
)

5966 
u64
 
¡¬t
 = 
BTRFS_DEVICE_RANGE_RESERVED
, 
Ën
 = 0, 
’d
 = 0;

5967 
»t
;

5969 *
Œimmed
 = 0;

5972 ià(!
	`bdev_max_disÿrd_£ùÜs
(
deviû
->
bdev
))

5976 ià(!
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
))

5980 ià(
deviû
->
tÙ®_by‹s
 <ğdeviû->
by‹s_u£d
)

5983 
»t
 = 0;

5986 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

5987 
u64
 
by‹s
;

5989 
»t
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
fs_šfo
->
chunk_mu‹x
);

5990 ià(
»t
)

5993 
	`fšd_fœ¡_ş—r_ex‹Á_b™
(&
deviû
->
®loc_¡©e
, 
¡¬t
,

5994 &
¡¬t
, &
’d
,

5995 
CHUNK_TRIMMED
 | 
CHUNK_ALLOCATED
);

5998 ià(
¡¬t
 > 
deviû
->
tÙ®_by‹s
) {

5999 
	`WARN_ON
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
));

6000 
	`bŒfs_w¬n_š_rcu
(
fs_šfo
,

6002 
¡¬t
, 
’d
 - start + 1,

6003 
	`bŒfs_dev_Çme
(
deviû
),

6004 
deviû
->
tÙ®_by‹s
);

6005 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

6006 
»t
 = 0;

6011 
¡¬t
 = 
	`max_t
(
u64
, s¹, 
BTRFS_DEVICE_RANGE_RESERVED
);

6018 
’d
 = 
	`mš
Ónd, 
deviû
->
tÙ®_by‹s
 - 1);

6020 
Ën
 = 
’d
 - 
¡¬t
 + 1;

6023 ià(!
Ën
) {

6024 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

6025 
»t
 = 0;

6029 
»t
 = 
	`bŒfs_issue_disÿrd
(
deviû
->
bdev
, 
¡¬t
, 
Ën
,

6030 &
by‹s
);

6031 ià(!
»t
)

6032 
	`£t_ex‹Á_b™
(&
deviû
->
®loc_¡©e
, 
¡¬t
,

6033 
¡¬t
 + 
by‹s
 - 1, 
CHUNK_TRIMMED
, 
NULL
);

6034 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

6036 ià(
»t
)

6039 
¡¬t
 +ğ
Ën
;

6040 *
Œimmed
 +ğ
by‹s
;

6042 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

6043 
»t
 = -
ERESTARTSYS
;

6047 
	`cÚd_»sched
();

6050  
»t
;

6051 
	}
}

6062 
	$bŒfs_Œim_fs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
f¡rim_¿nge
 *
¿nge
)

6064 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

6065 
bŒfs_block_group
 *
ÿche
 = 
NULL
;

6066 
bŒfs_deviû
 *
deviû
;

6067 
u64
 
group_Œimmed
;

6068 
u64
 
¿nge_’d
 = 
U64_MAX
;

6069 
u64
 
¡¬t
;

6070 
u64
 
’d
;

6071 
u64
 
Œimmed
 = 0;

6072 
u64
 
bg_çed
 = 0;

6073 
u64
 
dev_çed
 = 0;

6074 
bg_»t
 = 0;

6075 
dev_»t
 = 0;

6076 
»t
 = 0;

6078 ià(
¿nge
->
¡¬t
 =ğ
U64_MAX
)

6079  -
EINVAL
;

6085 ià(
¿nge
->
Ën
 !ğ
U64_MAX
 &&

6086 
	`check_add_ov”æow
(
¿nge
->
¡¬t
,„ªge->
Ën
, &
¿nge_’d
))

6087  -
EINVAL
;

6089 
ÿche
 = 
	`bŒfs_lookup_fœ¡_block_group
(
fs_šfo
, 
¿nge
->
¡¬t
);

6090 ; 
ÿche
; cachğ
	`bŒfs_Ãxt_block_group
(cache)) {

6091 ià(
ÿche
->
¡¬t
 >ğ
¿nge_’d
) {

6092 
	`bŒfs_put_block_group
(
ÿche
);

6096 
¡¬t
 = 
	`max
(
¿nge
->¡¬t, 
ÿche
->start);

6097 
’d
 = 
	`mš
(
¿nge_’d
, 
ÿche
->
¡¬t
 + cache->
Ëngth
);

6099 ià(
’d
 - 
¡¬t
 >ğ
¿nge
->
mšËn
) {

6100 ià(!
	`bŒfs_block_group_dÚe
(
ÿche
)) {

6101 
»t
 = 
	`bŒfs_ÿche_block_group
(
ÿche
, 
Œue
);

6102 ià(
»t
) {

6103 
bg_çed
++;

6104 
bg_»t
 = 
»t
;

6108 
»t
 = 
	`bŒfs_Œim_block_group
(
ÿche
,

6109 &
group_Œimmed
,

6110 
¡¬t
,

6111 
’d
,

6112 
¿nge
->
mšËn
);

6114 
Œimmed
 +ğ
group_Œimmed
;

6115 ià(
»t
) {

6116 
bg_çed
++;

6117 
bg_»t
 = 
»t
;

6123 ià(
bg_çed
)

6124 
	`bŒfs_w¬n
(
fs_šfo
,

6126 
bg_çed
, 
bg_»t
);

6128 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

6129 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

6130 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
, &
deviû
->
dev_¡©e
))

6133 
»t
 = 
	`bŒfs_Œim_ä“_ex‹Ás
(
deviû
, &
group_Œimmed
);

6134 ià(
»t
) {

6135 
dev_çed
++;

6136 
dev_»t
 = 
»t
;

6140 
Œimmed
 +ğ
group_Œimmed
;

6142 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

6144 ià(
dev_çed
)

6145 
	`bŒfs_w¬n
(
fs_šfo
,

6147 
dev_çed
, 
dev_»t
);

6148 
¿nge
->
Ën
 = 
Œimmed
;

6149 ià(
bg_»t
)

6150  
bg_»t
;

6151  
dev_»t
;

6152 
	}
}

	@extent-tree.h

3 #iâdeà
BTRFS_EXTENT_TREE_H


4 
	#BTRFS_EXTENT_TREE_H


	)

6 
	~"misc.h
"

7 
	~"block-group.h
"

9 
	gbŒfs_ä“_şu¡”
;

11 
	ebŒfs_ex‹Á_®loÿtiÚ_pŞicy
 {

12 
	mBTRFS_EXTENT_ALLOC_CLUSTERED
,

13 
	mBTRFS_EXTENT_ALLOC_ZONED
,

16 
	sfšd_ä“_ex‹Á_ùl
 {

18 
u64
 
	m¿m_by‹s
;

19 
u64
 
	mnum_by‹s
;

20 
u64
 
	mmš_®loc_size
;

21 
u64
 
	mem±y_size
;

22 
u64
 
	mæags
;

23 
	md–®loc
;

26 
u64
 
	m£¬ch_¡¬t
;

29 
u64
 
	mem±y_şu¡”
;

30 
bŒfs_ä“_şu¡”
 *
	mÏ¡_±r
;

31 
boŞ
 
	mu£_şu¡”
;

33 
boŞ
 
	mhave_ÿchšg_bg
;

34 
boŞ
 
	mÜig_have_ÿchšg_bg
;

37 
boŞ
 
	mfÜ_Œ“log
;

40 
boŞ
 
	mfÜ_d©a_»loc
;

43 
	mšdex
;

48 
	mloİ
;

55 
boŞ
 
	m»Œy_unÿched
;

58 
	mÿched
;

61 
u64
 
	mmax_ex‹Á_size
;

64 
u64
 
	mtÙ®_ä“_¥aû
;

67 
u64
 
	mfound_off£t
;

70 
u64
 
	mhšt_by‹
;

73 
bŒfs_ex‹Á_®loÿtiÚ_pŞicy
 
	mpŞicy
;

76 
boŞ
 
	mhš‹d
;

79 
bŒfs_block_group_size_şass
 
	msize_şass
;

82 
	ebŒfs_šlše_»f_ty³
 {

83 
	mBTRFS_REF_TYPE_INVALID
,

84 
	mBTRFS_REF_TYPE_BLOCK
,

85 
	mBTRFS_REF_TYPE_DATA
,

86 
	mBTRFS_REF_TYPE_ANY
,

89 
bŒfs_g‘_ex‹Á_šlše_»f_ty³
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

90 
bŒfs_ex‹Á_šlše_»f
 *
œef
,

91 
bŒfs_šlše_»f_ty³
 
is_d©a
);

92 
u64
 
hash_ex‹Á_d©a_»f
(u64 
roÙ_objeùid
, u64 
owÃr
, u64 
off£t
);

94 
bŒfs_run_d–ayed_»fs
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
couÁ
);

95 
bŒfs_ş—nup_»f_h—d_accouÁšg
(
bŒfs_fs_šfo
 *
fs_šfo
,

96 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

97 
bŒfs_d–ayed_»f_h—d
 *
h—d
);

98 
bŒfs_lookup_d©a_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
, u64 
Ën
);

99 
bŒfs_lookup_ex‹Á_šfo
(
bŒfs_Œªs_hªdË
 *
Œªs
,

100 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

101 
u64
 
off£t
, 
m‘ad©a
, u64 *
»fs
, u64 *
æags
);

102 
bŒfs_pš_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
by‹Ä
, u64 
num
,

103 
»£rved
);

104 
bŒfs_pš_ex‹Á_fÜ_log_»¶ay
(
bŒfs_Œªs_hªdË
 *
Œªs
,

105 
u64
 
by‹Ä
, u64 
num_by‹s
);

106 
bŒfs_exşude_logged_ex‹Ás
(
ex‹Á_bufãr
 *
eb
);

107 
bŒfs_üoss_»f_exi¡
(
bŒfs_roÙ
 *
roÙ
,

108 
u64
 
objeùid
, u64 
off£t
, u64 
by‹Ä
, 
boŞ
 
¡riù
,

109 
bŒfs_·th
 *
·th
);

110 
ex‹Á_bufãr
 *
bŒfs_®loc_Œ“_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

111 
bŒfs_roÙ
 *
roÙ
,

112 
u64
 
·»Á
, u64 
roÙ_objeùid
,

113 cÚ¡ 
bŒfs_disk_key
 *
key
,

114 
Ëv–
, 
u64
 
hšt
,

115 
u64
 
em±y_size
,

116 
bŒfs_lock_Ã¡šg
 
Ã¡
);

117 
bŒfs_ä“_Œ“_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

118 
u64
 
roÙ_id
,

119 
ex‹Á_bufãr
 *
buf
,

120 
u64
 
·»Á
, 
Ï¡_»f
);

121 
bŒfs_®loc_»£rved_fe_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

122 
bŒfs_roÙ
 *
roÙ
, 
u64
 
owÃr
,

123 
u64
 
off£t
, u64 
¿m_by‹s
,

124 
bŒfs_key
 *
šs
);

125 
bŒfs_®loc_logged_fe_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

126 
u64
 
roÙ_objeùid
, u64 
owÃr
, u64 
off£t
,

127 
bŒfs_key
 *
šs
);

128 
bŒfs_»£rve_ex‹Á
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
¿m_by‹s
, u64 
num_by‹s
,

129 
u64
 
mš_®loc_size
, u64 
em±y_size
, u64 
hšt_by‹
,

130 
bŒfs_key
 *
šs
, 
is_d©a
, 
d–®loc
);

131 
bŒfs_šc_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

132 
ex‹Á_bufãr
 *
buf
, 
fuÎ_back»f
);

133 
bŒfs_dec_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

134 
ex‹Á_bufãr
 *
buf
, 
fuÎ_back»f
);

135 
bŒfs_£t_disk_ex‹Á_æags
(
bŒfs_Œªs_hªdË
 *
Œªs
,

136 
ex‹Á_bufãr
 *
eb
, 
u64
 
æags
);

137 
bŒfs_ä“_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_»f
 *
»f
);

139 
bŒfs_ä“_»£rved_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

140 
u64
 
¡¬t
, u64 
Ën
, 
d–®loc
);

141 
bŒfs_pš_»£rved_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
¡¬t
, u64 
Ën
);

142 
bŒfs_fšish_ex‹Á_comm™
(
bŒfs_Œªs_hªdË
 *
Œªs
);

143 
bŒfs_šc_ex‹Á_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_»f
 *
g’”ic_»f
);

144 
__mu¡_check
 
bŒfs_drİ_¢­shÙ
(
bŒfs_roÙ
 *
roÙ
, 
upd©e_»f
,

145 
fÜ_»loc
);

146 
bŒfs_drİ_subŒ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

147 
bŒfs_roÙ
 *
roÙ
,

148 
ex‹Á_bufãr
 *
node
,

149 
ex‹Á_bufãr
 *
·»Á
);

	@extent_io.c

3 
	~<lšux/b™İs.h
>

4 
	~<lšux/¦ab.h
>

5 
	~<lšux/bio.h
>

6 
	~<lšux/mm.h
>

7 
	~<lšux/·gem­.h
>

8 
	~<lšux/·ge-æags.h
>

9 
	~<lšux/sched/mm.h
>

10 
	~<lšux/¥šlock.h
>

11 
	~<lšux/blkdev.h
>

12 
	~<lšux/sw­.h
>

13 
	~<lšux/wr™eback.h
>

14 
	~<lšux/·gevec.h
>

15 
	~<lšux/´eãtch.h
>

16 
	~<lšux/fsv”™y.h
>

17 
	~"misc.h
"

18 
	~"ex‹Á_io.h
"

19 
	~"ex‹Á-io-Œ“.h
"

20 
	~"ex‹Á_m­.h
"

21 
	~"ù»e.h
"

22 
	~"bŒfs_šode.h
"

23 
	~"bio.h
"

24 
	~"check-š‹gr™y.h
"

25 
	~"lockšg.h
"

26 
	~"rcu-¡ršg.h
"

27 
	~"back»f.h
"

28 
	~"disk-io.h
"

29 
	~"sub·ge.h
"

30 
	~"zÚed.h
"

31 
	~"block-group.h
"

32 
	~"com´essiÚ.h
"

33 
	~"fs.h
"

34 
	~"acûssÜs.h
"

35 
	~"fe-™em.h
"

36 
	~"fe.h
"

37 
	~"dev-»¶aû.h
"

38 
	~"su³r.h
"

39 
	~"Œª§ùiÚ.h
"

41 
kmem_ÿche
 *
	gex‹Á_bufãr_ÿche
;

43 #ifdeà
CONFIG_BTRFS_DEBUG


44 
šlše
 
	$bŒfs_Ëak_debug_add_eb
(
ex‹Á_bufãr
 *
eb
)

46 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

47 
æags
;

49 
	`¥š_lock_œq§ve
(&
fs_šfo
->
eb_Ëak_lock
, 
æags
);

50 
	`li¡_add
(&
eb
->
Ëak_li¡
, &
fs_šfo
->
®loÿ‹d_ebs
);

51 
	`¥š_uÆock_œq»¡Üe
(&
fs_šfo
->
eb_Ëak_lock
, 
æags
);

52 
	}
}

54 
šlše
 
	$bŒfs_Ëak_debug_d–_eb
(
ex‹Á_bufãr
 *
eb
)

56 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

57 
æags
;

59 
	`¥š_lock_œq§ve
(&
fs_šfo
->
eb_Ëak_lock
, 
æags
);

60 
	`li¡_d–
(&
eb
->
Ëak_li¡
);

61 
	`¥š_uÆock_œq»¡Üe
(&
fs_šfo
->
eb_Ëak_lock
, 
æags
);

62 
	}
}

64 
	$bŒfs_ex‹Á_bufãr_Ëak_debug_check
(
bŒfs_fs_šfo
 *
fs_šfo
)

66 
ex‹Á_bufãr
 *
eb
;

67 
æags
;

73 ià(!
fs_šfo
->
®loÿ‹d_ebs
.
Ãxt
)

76 
	`WARN_ON
(!
	`li¡_em±y
(&
fs_šfo
->
®loÿ‹d_ebs
));

77 
	`¥š_lock_œq§ve
(&
fs_šfo
->
eb_Ëak_lock
, 
æags
);

78 !
	`li¡_em±y
(&
fs_šfo
->
®loÿ‹d_ebs
)) {

79 
eb
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
®loÿ‹d_ebs
,

80 
ex‹Á_bufãr
, 
Ëak_li¡
);

81 
	`´_”r
(

83 
eb
->
¡¬t
,ƒb->
Ën
, 
	`©omic_»ad
(&eb->
»fs
),ƒb->
bæags
,

84 
	`bŒfs_h—d”_owÃr
(
eb
));

85 
	`li¡_d–
(&
eb
->
Ëak_li¡
);

86 
	`kmem_ÿche_ä“
(
ex‹Á_bufãr_ÿche
, 
eb
);

88 
	`¥š_uÆock_œq»¡Üe
(&
fs_šfo
->
eb_Ëak_lock
, 
æags
);

89 
	}
}

91 
	#bŒfs_Ëak_debug_add_eb
(
eb
èdØ{} 0)

	)

92 
	#bŒfs_Ëak_debug_d–_eb
(
eb
èdØ{} 0)

	)

99 
	sbŒfs_bio_ù¾
 {

100 
bŒfs_bio
 *
	mbbio
;

101 
bŒfs_com´essiÚ_ty³
 
	mcom´ess_ty³
;

102 
u32
 
	mËn_to_Û_bound¬y
;

103 
blk_İf_t
 
	mİf
;

104 
bŒfs_bio_’d_io_t
 
	m’d_io_func
;

105 
wr™eback_cÚŒŞ
 *
	mwbc
;

108 
	$subm™_Úe_bio
(
bŒfs_bio_ù¾
 *
bio_ù¾
)

110 
bŒfs_bio
 *
bbio
 = 
bio_ù¾
->bbio;

112 ià(!
bbio
)

116 
	`ASSERT
(
bbio
->
bio
.
bi_™”
.
bi_size
);

118 ià(
	`bŒfs_İ
(&
bbio
->
bio
è=ğ
BTRFS_MAP_READ
 &&

119 
bio_ù¾
->
com´ess_ty³
 !ğ
BTRFS_COMPRESS_NONE
)

120 
	`bŒfs_subm™_com´es£d_»ad
(
bbio
);

122 
	`bŒfs_subm™_bio
(
bbio
, 0);

125 
bio_ù¾
->
bbio
 = 
NULL
;

126 
	}
}

131 
	$subm™_wr™e_bio
(
bŒfs_bio_ù¾
 *
bio_ù¾
, 
»t
)

133 
bŒfs_bio
 *
bbio
 = 
bio_ù¾
->bbio;

135 ià(!
bbio
)

138 ià(
»t
) {

139 
	`ASSERT
(
»t
 < 0);

140 
	`bŒfs_bio_’d_io
(
bbio
, 
	`”ºo_to_blk_¡©us
(
»t
));

142 
bio_ù¾
->
bbio
 = 
NULL
;

144 
	`subm™_Úe_bio
(
bio_ù¾
);

146 
	}
}

148 
__š™
 
	$ex‹Á_bufãr_š™_ÿch•
()

150 
ex‹Á_bufãr_ÿche
 = 
	`kmem_ÿche_ü—‹
("btrfs_extent_buffer",

151 (
ex‹Á_bufãr
), 0,

152 
SLAB_MEM_SPREAD
, 
NULL
);

153 ià(!
ex‹Á_bufãr_ÿche
)

154  -
ENOMEM
;

157 
	}
}

159 
__cŞd
 
	$ex‹Á_bufãr_ä“_ÿch•
()

165 
	`rcu_b¬r›r
();

166 
	`kmem_ÿche_de¡roy
(
ex‹Á_bufãr_ÿche
);

167 
	}
}

169 
	$ex‹Á_¿nge_ş—r_dœty_fÜ_io
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
)

171 
šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

172 
’d_šdex
 = 
’d
 >> 
PAGE_SHIFT
;

173 
·ge
 *page;

175 
šdex
 <ğ
’d_šdex
) {

176 
·ge
 = 
	`fšd_g‘_·ge
(
šode
->
i_m­pšg
, 
šdex
);

177 
	`BUG_ON
(!
·ge
);

178 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

179 
	`put_·ge
(
·ge
);

180 
šdex
++;

182 
	}
}

184 
	$´oûss_Úe_·ge
(
bŒfs_fs_šfo
 *
fs_šfo
,

185 
·ge
 *·ge, ·g*
locked_·ge
,

186 
·ge_İs
, 
u64
 
¡¬t
, u64 
’d
)

188 
u32
 
Ën
;

190 
	`ASSERT
(
’d
 + 1 - 
¡¬t
 !ğ0 &&ƒnd + 1 - s¹ < 
U32_MAX
);

191 
Ën
 = 
’d
 + 1 - 
¡¬t
;

193 ià(
·ge_İs
 & 
PAGE_SET_ORDERED
)

194 
	`bŒfs_·ge_şamp_£t_Üd”ed
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

195 ià(
·ge_İs
 & 
PAGE_START_WRITEBACK
) {

196 
	`bŒfs_·ge_şamp_ş—r_dœty
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

197 
	`bŒfs_·ge_şamp_£t_wr™eback
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

199 ià(
·ge_İs
 & 
PAGE_END_WRITEBACK
)

200 
	`bŒfs_·ge_şamp_ş—r_wr™eback
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

202 ià(
·ge
 !ğ
locked_·ge
 && (
·ge_İs
 & 
PAGE_UNLOCK
))

203 
	`bŒfs_·ge_’d_wr™”_lock
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

204 
	}
}

206 
	$__´oûss_·ges_cÚtig
(
add»ss_¥aû
 *
m­pšg
,

207 
·ge
 *
locked_·ge
, 
u64
 
¡¬t
, u64 
’d
,

208 
·ge_İs
)

210 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
m­pšg
->
ho¡
->
i_sb
);

211 
pgoff_t
 
¡¬t_šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

212 
pgoff_t
 
’d_šdex
 = 
’d
 >> 
PAGE_SHIFT
;

213 
pgoff_t
 
šdex
 = 
¡¬t_šdex
;

214 
fŞio_b©ch
 
fb©ch
;

215 
i
;

217 
	`fŞio_b©ch_š™
(&
fb©ch
);

218 
šdex
 <ğ
’d_šdex
) {

219 
found_fŞios
;

221 
found_fŞios
 = 
	`fem­_g‘_fŞios_cÚtig
(
m­pšg
, &
šdex
,

222 
’d_šdex
, &
fb©ch
);

223 
i
 = 0; i < 
found_fŞios
; i++) {

224 
fŞio
 *fŞiØğ
fb©ch
.
fŞios
[
i
];

226 
	`´oûss_Úe_·ge
(
fs_šfo
, &
fŞio
->
·ge
, 
locked_·ge
,

227 
·ge_İs
, 
¡¬t
, 
’d
);

229 
	`fŞio_b©ch_»Ëa£
(&
fb©ch
);

230 
	`cÚd_»sched
();

232 
	}
}

234 
nošlše
 
	$__uÆock_fÜ_d–®loc
(
šode
 *inode,

235 
·ge
 *
locked_·ge
,

236 
u64
 
¡¬t
, u64 
’d
)

238 
šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

239 
’d_šdex
 = 
’d
 >> 
PAGE_SHIFT
;

241 
	`ASSERT
(
locked_·ge
);

242 ià(
šdex
 =ğ
locked_·ge
->šdex && 
’d_šdex
 == index)

245 
	`__´oûss_·ges_cÚtig
(
šode
->
i_m­pšg
, 
locked_·ge
, 
¡¬t
, 
’d
,

246 
PAGE_UNLOCK
);

247 
	}
}

249 
nošlše
 
	$lock_d–®loc_·ges
(
šode
 *inode,

250 
·ge
 *
locked_·ge
,

251 
u64
 
¡¬t
,

252 
u64
 
’d
)

254 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

255 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

256 
pgoff_t
 
¡¬t_šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

257 
pgoff_t
 
’d_šdex
 = 
’d
 >> 
PAGE_SHIFT
;

258 
pgoff_t
 
šdex
 = 
¡¬t_šdex
;

259 
u64
 
´oûs£d_’d
 = 
¡¬t
;

260 
fŞio_b©ch
 
fb©ch
;

262 ià(
šdex
 =ğ
locked_·ge
->šdex && index =ğ
’d_šdex
)

265 
	`fŞio_b©ch_š™
(&
fb©ch
);

266 
šdex
 <ğ
’d_šdex
) {

267 
found_fŞios
, 
i
;

269 
found_fŞios
 = 
	`fem­_g‘_fŞios_cÚtig
(
m­pšg
, &
šdex
,

270 
’d_šdex
, &
fb©ch
);

271 ià(
found_fŞios
 == 0)

272 
out
;

274 
i
 = 0; i < 
found_fŞios
; i++) {

275 
·ge
 *·gğ&
fb©ch
.
fŞios
[
i
]->page;

276 
u32
 
Ën
 = 
’d
 + 1 - 
¡¬t
;

278 ià(
·ge
 =ğ
locked_·ge
)

281 ià(
	`bŒfs_·ge_¡¬t_wr™”_lock
(
fs_šfo
, 
·ge
, 
¡¬t
,

282 
Ën
))

283 
out
;

285 ià(!
	`PageDœty
(
·ge
è||…age->
m­pšg
 != mapping) {

286 
	`bŒfs_·ge_’d_wr™”_lock
(
fs_šfo
, 
·ge
, 
¡¬t
,

287 
Ën
);

288 
out
;

291 
´oûs£d_’d
 = 
	`·ge_off£t
(
·ge
è+ 
PAGE_SIZE
 - 1;

293 
	`fŞio_b©ch_»Ëa£
(&
fb©ch
);

294 
	`cÚd_»sched
();

298 
out
:

299 
	`fŞio_b©ch_»Ëa£
(&
fb©ch
);

300 ià(
´oûs£d_’d
 > 
¡¬t
)

301 
	`__uÆock_fÜ_d–®loc
(
šode
, 
locked_·ge
, 
¡¬t
, 
´oûs£d_’d
);

302  -
EAGAIN
;

303 
	}
}

320 
EXPORT_FOR_TESTS


321 
nošlše_fÜ_¡ack
 
boŞ
 
	$fšd_lock_d–®loc_¿nge
(
šode
 *inode,

322 
·ge
 *
locked_·ge
, 
u64
 *
¡¬t
,

323 
u64
 *
’d
)

325 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

326 
ex‹Á_io_Œ“
 *
Œ“
 = &
	`BTRFS_I
(
šode
)->
io_Œ“
;

327 cÚ¡ 
u64
 
Üig_¡¬t
 = *
¡¬t
;

328 cÚ¡ 
u64
 
Üig_’d
 = *
’d
;

330 
u64
 
max_by‹s
 = 
fs_šfo
 ? fs_šfo->
max_ex‹Á_size
 : 
BTRFS_MAX_EXTENT_SIZE
;

331 
u64
 
d–®loc_¡¬t
;

332 
u64
 
d–®loc_’d
;

333 
boŞ
 
found
;

334 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

335 
»t
;

336 
loİs
 = 0;

339 
	`ASSERT
(
Üig_’d
 > 
Üig_¡¬t
);

342 
	`ASSERT
(!(
Üig_¡¬t
 >ğ
	`·ge_off£t
(
locked_·ge
è+ 
PAGE_SIZE
 ||

343 
Üig_’d
 <ğ
	`·ge_off£t
(
locked_·ge
)));

344 
agaš
:

346 
d–®loc_¡¬t
 = *
¡¬t
;

347 
d–®loc_’d
 = 0;

348 
found
 = 
	`bŒfs_fšd_d–®loc_¿nge
(
Œ“
, &
d–®loc_¡¬t
, &
d–®loc_’d
,

349 
max_by‹s
, &
ÿched_¡©e
);

350 ià(!
found
 || 
d–®loc_’d
 <ğ*
¡¬t
 || 
d–®loc_¡¬t
 > 
Üig_’d
) {

351 *
¡¬t
 = 
d–®loc_¡¬t
;

354 *
’d
 = 
	`mš
(
d–®loc_’d
, 
Üig_’d
);

355 
	`ä“_ex‹Á_¡©e
(
ÿched_¡©e
);

356  
çl£
;

364 ià(
d–®loc_¡¬t
 < *
¡¬t
)

365 
d–®loc_¡¬t
 = *
¡¬t
;

370 ià(
d–®loc_’d
 + 1 - 
d–®loc_¡¬t
 > 
max_by‹s
)

371 
d–®loc_’d
 = 
d–®loc_¡¬t
 + 
max_by‹s
 - 1;

374 
»t
 = 
	`lock_d–®loc_·ges
(
šode
, 
locked_·ge
,

375 
d–®loc_¡¬t
, 
d–®loc_’d
);

376 
	`ASSERT
(!
»t
 ||„‘ =ğ-
EAGAIN
);

377 ià(
»t
 =ğ-
EAGAIN
) {

381 
	`ä“_ex‹Á_¡©e
(
ÿched_¡©e
);

382 
ÿched_¡©e
 = 
NULL
;

383 ià(!
loİs
) {

384 
max_by‹s
 = 
PAGE_SIZE
;

385 
loİs
 = 1;

386 
agaš
;

388 
found
 = 
çl£
;

389 
out_çed
;

394 
	`lock_ex‹Á
(
Œ“
, 
d–®loc_¡¬t
, 
d–®loc_’d
, &
ÿched_¡©e
);

397 
»t
 = 
	`‹¡_¿nge_b™
(
Œ“
, 
d–®loc_¡¬t
, 
d–®loc_’d
,

398 
EXTENT_DELALLOC
, 1, 
ÿched_¡©e
);

399 ià(!
»t
) {

400 
	`uÆock_ex‹Á
(
Œ“
, 
d–®loc_¡¬t
, 
d–®loc_’d
,

401 &
ÿched_¡©e
);

402 
	`__uÆock_fÜ_d–®loc
(
šode
, 
locked_·ge
,

403 
d–®loc_¡¬t
, 
d–®loc_’d
);

404 
	`cÚd_»sched
();

405 
agaš
;

407 
	`ä“_ex‹Á_¡©e
(
ÿched_¡©e
);

408 *
¡¬t
 = 
d–®loc_¡¬t
;

409 *
’d
 = 
d–®loc_’d
;

410 
out_çed
:

411  
found
;

412 
	}
}

414 
	$ex‹Á_ş—r_uÆock_d–®loc
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
,

415 
·ge
 *
locked_·ge
,

416 
u32
 
ş—r_b™s
, 
·ge_İs
)

418 
	`ş—r_ex‹Á_b™
(&
šode
->
io_Œ“
, 
¡¬t
, 
’d
, 
ş—r_b™s
, 
NULL
);

420 
	`__´oûss_·ges_cÚtig
(
šode
->
vfs_šode
.
i_m­pšg
, 
locked_·ge
,

421 
¡¬t
, 
’d
, 
·ge_İs
);

422 
	}
}

424 
boŞ
 
	$bŒfs_v”ify_·ge
(
·ge
 *·ge, 
u64
 
¡¬t
)

426 ià(!
	`fsv”™y_aùive
(
·ge
->
m­pšg
->
ho¡
) ||

427 
	`PageU±od©e
(
·ge
) ||

428 
¡¬t
 >ğ
	`i_size_»ad
(
·ge
->
m­pšg
->
ho¡
))

429  
Œue
;

430  
	`fsv”™y_v”ify_·ge
(
·ge
);

431 
	}
}

433 
	$’d_·ge_»ad
(
·ge
 *·ge, 
boŞ
 
u±od©e
, 
u64
 
¡¬t
, 
u32
 
Ën
)

435 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
·ge
->
m­pšg
->
ho¡
->
i_sb
);

437 
	`ASSERT
(
	`·ge_off£t
(
·ge
è<ğ
¡¬t
 &&

438 
¡¬t
 + 
Ën
 <ğ
	`·ge_off£t
(
·ge
è+ 
PAGE_SIZE
);

440 ià(
u±od©e
 && 
	`bŒfs_v”ify_·ge
(
·ge
, 
¡¬t
))

441 
	`bŒfs_·ge_£t_u±od©e
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

443 
	`bŒfs_·ge_ş—r_u±od©e
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

445 ià(!
	`bŒfs_is_sub·ge
(
fs_šfo
, 
·ge
))

446 
	`uÆock_·ge
(
·ge
);

448 
	`bŒfs_sub·ge_’d_»ad”
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

449 
	}
}

460 
	$’d_bio_ex‹Á_wr™•age
(
bŒfs_bio
 *
bbio
)

462 
bio
 *biØğ&
bbio
->bio;

463 
”rÜ
 = 
	`blk_¡©us_to_”ºo
(
bio
->
bi_¡©us
);

464 
bio_vec
 *
bvec
;

465 
bvec_™”_®l
 
™”_®l
;

467 
	`ASSERT
(!
	`bio_æagged
(
bio
, 
BIO_CLONED
));

468 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
™”_®l
) {

469 
·ge
 *·gğ
bvec
->
bv_·ge
;

470 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

471 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

472 cÚ¡ 
u32
 
£ùÜsize
 = 
fs_šfo
->sectorsize;

473 
u64
 
¡¬t
 = 
	`·ge_off£t
(
·ge
è+ 
bvec
->
bv_off£t
;

474 
u32
 
Ën
 = 
bvec
->
bv_Ën
;

477 ià(!
	`IS_ALIGNED
(
bvec
->
bv_off£t
, 
£ùÜsize
))

478 
	`bŒfs_”r
(
fs_šfo
,

480 
bvec
->
bv_off£t
, bvec->
bv_Ën
);

481 ià(!
	`IS_ALIGNED
(
bvec
->
bv_Ën
, 
£ùÜsize
))

482 
	`bŒfs_šfo
(
fs_šfo
,

484 
bvec
->
bv_off£t
, bvec->
bv_Ën
);

486 
	`bŒfs_fšish_Üd”ed_ex‹Á
(
bbio
->
Üd”ed
, 
·ge
, 
¡¬t
, 
Ën
, !
”rÜ
);

487 ià(
”rÜ
)

488 
	`m­pšg_£t_”rÜ
(
·ge
->
m­pšg
, 
”rÜ
);

489 
	`bŒfs_·ge_ş—r_wr™eback
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

492 
	`bio_put
(
bio
);

493 
	}
}

501 
	s´oûs£d_ex‹Á
 {

502 
bŒfs_šode
 *
	mšode
;

504 
u64
 
	m¡¬t
;

506 
u64
 
	m’d
;

507 
boŞ
 
	mu±od©e
;

521 
	$’dio_»ad·ge_»Ëa£_ex‹Á
(
´oûs£d_ex‹Á
 *
´oûs£d
,

522 
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
,

523 
boŞ
 
u±od©e
)

525 
ex‹Á_¡©e
 *
ÿched
 = 
NULL
;

526 
ex‹Á_io_Œ“
 *
Œ“
;

529 ià(!
´oûs£d
->
šode
)

530 
upd©e
;

543 ià(
´oûs£d
->
šode
 =ğšod&&…roûs£d->
u±od©e
 == uptodate &&

544 
´oûs£d
->
’d
 + 1 >ğ
¡¬t
 &&ƒnd >=…rocessed->end) {

545 
´oûs£d
->
’d
 =ƒnd;

549 
Œ“
 = &
´oûs£d
->
šode
->
io_Œ“
;

554 
	`uÆock_ex‹Á
(
Œ“
, 
´oûs£d
->
¡¬t
,…roûs£d->
’d
, &
ÿched
);

556 
upd©e
:

558 
´oûs£d
->
šode
 = inode;

559 
´oûs£d
->
¡¬t
 = start;

560 
´oûs£d
->
’d
 =ƒnd;

561 
´oûs£d
->
u±od©e
 = uptodate;

562 
	}
}

564 
	$begš_·ge_»ad
(
bŒfs_fs_šfo
 *
fs_šfo
, 
·ge
 *page)

566 
	`ASSERT
(
	`PageLocked
(
·ge
));

567 ià(!
	`bŒfs_is_sub·ge
(
fs_šfo
, 
·ge
))

570 
	`ASSERT
(
	`PagePriv©e
(
·ge
));

571 
	`bŒfs_sub·ge_¡¬t_»ad”
(
fs_šfo
, 
·ge
, 
	`·ge_off£t
Õage), 
PAGE_SIZE
);

572 
	}
}

585 
	$’d_bio_ex‹Á_»ad·ge
(
bŒfs_bio
 *
bbio
)

587 
bio
 *biØğ&
bbio
->bio;

588 
bio_vec
 *
bvec
;

589 
´oûs£d_ex‹Á
 
´oûs£d
 = { 0 };

594 
u32
 
bio_off£t
 = 0;

595 
bvec_™”_®l
 
™”_®l
;

597 
	`ASSERT
(!
	`bio_æagged
(
bio
, 
BIO_CLONED
));

598 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
™”_®l
) {

599 
boŞ
 
u±od©e
 = !
bio
->
bi_¡©us
;

600 
·ge
 *·gğ
bvec
->
bv_·ge
;

601 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

602 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

603 cÚ¡ 
u32
 
£ùÜsize
 = 
fs_šfo
->sectorsize;

604 
u64
 
¡¬t
;

605 
u64
 
’d
;

606 
u32
 
Ën
;

608 
	`bŒfs_debug
(
fs_šfo
,

610 
bio
->
bi_™”
.
bi_£ùÜ
, bio->
bi_¡©us
,

611 
bbio
->
mœrÜ_num
);

620 ià(!
	`IS_ALIGNED
(
bvec
->
bv_off£t
, 
£ùÜsize
))

621 
	`bŒfs_”r
(
fs_šfo
,

623 
bvec
->
bv_off£t
, bvec->
bv_Ën
);

624 ià(!
	`IS_ALIGNED
(
bvec
->
bv_off£t
 + bvec->
bv_Ën
,

625 
£ùÜsize
))

626 
	`bŒfs_šfo
(
fs_šfo
,

628 
bvec
->
bv_off£t
, bvec->
bv_Ën
);

630 
¡¬t
 = 
	`·ge_off£t
(
·ge
è+ 
bvec
->
bv_off£t
;

631 
’d
 = 
¡¬t
 + 
bvec
->
bv_Ën
 - 1;

632 
Ën
 = 
bvec
->
bv_Ën
;

634 ià(
	`lik–y
(
u±od©e
)) {

635 
loff_t
 
i_size
 = 
	`i_size_»ad
(
šode
);

636 
pgoff_t
 
’d_šdex
 = 
i_size
 >> 
PAGE_SHIFT
;

647 ià(
·ge
->
šdex
 =ğ
’d_šdex
 && 
i_size
 <ğ
’d
) {

648 
u32
 
z”o_¡¬t
 = 
	`max
(
	`off£t_š_·ge
(
i_size
),

649 
	`off£t_š_·ge
(
¡¬t
));

651 
	`z”o_u£r_£gm’t
(
·ge
, 
z”o_¡¬t
,

652 
	`off£t_š_·ge
(
’d
) + 1);

657 
	`’d_·ge_»ad
(
·ge
, 
u±od©e
, 
¡¬t
, 
Ën
);

658 
	`’dio_»ad·ge_»Ëa£_ex‹Á
(&
´oûs£d
, 
	`BTRFS_I
(
šode
),

659 
¡¬t
, 
’d
, 
u±od©e
);

661 
	`ASSERT
(
bio_off£t
 + 
Ën
 > bio_offset);

662 
bio_off£t
 +ğ
Ën
;

666 
	`’dio_»ad·ge_»Ëa£_ex‹Á
(&
´oûs£d
, 
NULL
, 0, 0, 
çl£
);

667 
	`bio_put
(
bio
);

668 
	}
}

681 
	$bŒfs_®loc_·ge_¬¿y
(
Ä_·ges
, 
·ge
 **
·ge_¬¿y
)

683 
®loÿ‹d
;

685 
®loÿ‹d
 = 0;‡Îoÿ‹d < 
Ä_·ges
;) {

686 
Ï¡
 = 
®loÿ‹d
;

688 
®loÿ‹d
 = 
	`®loc_·ges_bulk_¬¿y
(
GFP_NOFS
, 
Ä_·ges
, 
·ge_¬¿y
);

690 ià(
®loÿ‹d
 =ğ
Ä_·ges
)

698 ià(
®loÿ‹d
 =ğ
Ï¡
) {

699 
i
 = 0; i < 
®loÿ‹d
; i++) {

700 
	`__ä“_·ge
(
·ge_¬¿y
[
i
]);

701 
·ge_¬¿y
[
i
] = 
NULL
;

703  -
ENOMEM
;

706 
	`mem®loc_»Œy_wa™
(
GFP_NOFS
);

709 
	}
}

711 
boŞ
 
	$bŒfs_bio_is_cÚtig
(
bŒfs_bio_ù¾
 *
bio_ù¾
,

712 
·ge
 *·ge, 
u64
 
disk_by‹Ä
,

713 
pg_off£t
)

715 
bio
 *biØğ&
bio_ù¾
->
bbio
->bio;

716 
bio_vec
 *
bvec
 = 
	`bio_Ï¡_bvec_®l
(
bio
);

717 cÚ¡ 
£ùÜ_t
 
£ùÜ
 = 
disk_by‹Ä
 >> 
SECTOR_SHIFT
;

719 ià(
bio_ù¾
->
com´ess_ty³
 !ğ
BTRFS_COMPRESS_NONE
) {

724  
bio
->
bi_™”
.
bi_£ùÜ
 =ğ
£ùÜ
;

738  
	`bio_’d_£ùÜ
(
bio
è=ğ
£ùÜ
 &&

739 
	`·ge_off£t
(
bvec
->
bv_·ge
è+ bvec->
bv_off£t
 + bvec->
bv_Ën
 ==

740 
	`·ge_off£t
(
·ge
è+ 
pg_off£t
;

741 
	}
}

743 
	$®loc_Ãw_bio
(
bŒfs_šode
 *
šode
,

744 
bŒfs_bio_ù¾
 *
bio_ù¾
,

745 
u64
 
disk_by‹Ä
, u64 
fe_off£t
)

747 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

748 
bŒfs_bio
 *
bbio
;

750 
bbio
 = 
	`bŒfs_bio_®loc
(
BIO_MAX_VECS
, 
bio_ù¾
->
İf
, 
fs_šfo
,

751 
bio_ù¾
->
’d_io_func
, 
NULL
);

752 
bbio
->
bio
.
bi_™”
.
bi_£ùÜ
 = 
disk_by‹Ä
 >> 
SECTOR_SHIFT
;

753 
bbio
->
šode
 = inode;

754 
bbio
->
fe_off£t
 = file_offset;

755 
bio_ù¾
->
bbio
 = bbio;

756 
bio_ù¾
->
Ën_to_Û_bound¬y
 = 
U32_MAX
;

759 ià(
bio_ù¾
->
wbc
) {

760 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

762 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_ex‹Á
(
šode
, 
fe_off£t
);

763 ià(
Üd”ed
) {

764 
bio_ù¾
->
Ën_to_Û_bound¬y
 = 
	`mš_t
(
u32
, 
U32_MAX
,

765 
Üd”ed
->
fe_off£t
 +

766 
Üd”ed
->
disk_num_by‹s
 - 
fe_off£t
);

767 
bbio
->
Üd”ed
 = ordered;

776 
	`bio_£t_dev
(&
bbio
->
bio
, 
fs_šfo
->
fs_deviûs
->
Ï‹¡_dev
->
bdev
);

777 
	`wbc_š™_bio
(
bio_ù¾
->
wbc
, &
bbio
->
bio
);

779 
	}
}

793 
	$subm™_ex‹Á_·ge
(
bŒfs_bio_ù¾
 *
bio_ù¾
,

794 
u64
 
disk_by‹Ä
, 
·ge
 *page,

795 
size_t
 
size
, 
pg_off£t
)

797 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
·ge
->
m­pšg
->
ho¡
);

799 
	`ASSERT
(
pg_off£t
 + 
size
 <ğ
PAGE_SIZE
);

800 
	`ASSERT
(
bio_ù¾
->
’d_io_func
);

802 ià(
bio_ù¾
->
bbio
 &&

803 !
	`bŒfs_bio_is_cÚtig
(
bio_ù¾
, 
·ge
, 
disk_by‹Ä
, 
pg_off£t
))

804 
	`subm™_Úe_bio
(
bio_ù¾
);

807 
u32
 
Ën
 = 
size
;

810 ià(!
bio_ù¾
->
bbio
) {

811 
	`®loc_Ãw_bio
(
šode
, 
bio_ù¾
, 
disk_by‹Ä
,

812 
	`·ge_off£t
(
·ge
è+ 
pg_off£t
);

816 ià(
Ën
 > 
bio_ù¾
->
Ën_to_Û_bound¬y
) {

817 
	`ASSERT
(
bio_ù¾
->
com´ess_ty³
 =ğ
BTRFS_COMPRESS_NONE
);

818 
	`ASSERT
(
	`is_d©a_šode
(&
šode
->
vfs_šode
));

819 
Ën
 = 
bio_ù¾
->
Ën_to_Û_bound¬y
;

822 ià(
	`bio_add_·ge
(&
bio_ù¾
->
bbio
->
bio
, 
·ge
, 
Ën
, 
pg_off£t
) !=†en) {

824 
	`subm™_Úe_bio
(
bio_ù¾
);

828 ià(
bio_ù¾
->
wbc
)

829 
	`wbc_accouÁ_cgroup_owÃr
(
bio_ù¾
->
wbc
, 
·ge
, 
Ën
);

831 
size
 -ğ
Ën
;

832 
pg_off£t
 +ğ
Ën
;

833 
disk_by‹Ä
 +ğ
Ën
;

856 ià(
bio_ù¾
->
Ën_to_Û_bound¬y
 !ğ
U32_MAX
)

857 
bio_ù¾
->
Ën_to_Û_bound¬y
 -ğ
Ën
;

860 ià(
bio_ù¾
->
Ën_to_Û_bound¬y
 == 0)

861 
	`subm™_Úe_bio
(
bio_ù¾
);

862 } 
size
);

863 
	}
}

865 
	$©ch_ex‹Á_bufãr_·ge
(
ex‹Á_bufãr
 *
eb
,

866 
·ge
 *page,

867 
bŒfs_sub·ge
 *
´—Îoc
)

869 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

870 
»t
 = 0;

878 ià(
·ge
->
m­pšg
)

879 
	`lockd•_as£¹_h–d
(&
·ge
->
m­pšg
->
´iv©e_lock
);

881 ià(
fs_šfo
->
nodesize
 >ğ
PAGE_SIZE
) {

882 ià(!
	`PagePriv©e
(
·ge
))

883 
	`©ch_·ge_´iv©e
(
·ge
, 
eb
);

885 
	`WARN_ON
(
·ge
->
´iv©e
 !ğ()
eb
);

890 ià(
	`PagePriv©e
(
·ge
)) {

891 
	`bŒfs_ä“_sub·ge
(
´—Îoc
);

895 ià(
´—Îoc
)

897 
	`©ch_·ge_´iv©e
(
·ge
, 
´—Îoc
);

900 
»t
 = 
	`bŒfs_©ch_sub·ge
(
fs_šfo
, 
·ge
,

901 
BTRFS_SUBPAGE_METADATA
);

902  
»t
;

903 
	}
}

905 
	$£t_·ge_ex‹Á_m­³d
(
·ge
 *page)

907 
bŒfs_fs_šfo
 *
fs_šfo
;

909 
	`ASSERT
(
·ge
->
m­pšg
);

911 ià(
	`PagePriv©e
(
·ge
))

914 
fs_šfo
 = 
	`bŒfs_sb
(
·ge
->
m­pšg
->
ho¡
->
i_sb
);

916 ià(
	`bŒfs_is_sub·ge
(
fs_šfo
, 
·ge
))

917  
	`bŒfs_©ch_sub·ge
(
fs_šfo
, 
·ge
, 
BTRFS_SUBPAGE_DATA
);

919 
	`©ch_·ge_´iv©e
(
·ge
, (*)
EXTENT_PAGE_PRIVATE
);

921 
	}
}

923 
	$ş—r_·ge_ex‹Á_m­³d
(
·ge
 *page)

925 
bŒfs_fs_šfo
 *
fs_šfo
;

927 
	`ASSERT
(
·ge
->
m­pšg
);

929 ià(!
	`PagePriv©e
(
·ge
))

932 
fs_šfo
 = 
	`bŒfs_sb
(
·ge
->
m­pšg
->
ho¡
->
i_sb
);

933 ià(
	`bŒfs_is_sub·ge
(
fs_šfo
, 
·ge
))

934  
	`bŒfs_d‘ach_sub·ge
(
fs_šfo
, 
·ge
);

936 
	`d‘ach_·ge_´iv©e
(
·ge
);

937 
	}
}

939 
ex‹Á_m­
 *

940 
	$__g‘_ex‹Á_m­
(
šode
 *šode, 
·ge
 *·ge, 
size_t
 
pg_off£t
,

941 
u64
 
¡¬t
, u64 
Ën
, 
ex‹Á_m­
 **
em_ÿched
)

943 
ex‹Á_m­
 *
em
;

945 ià(
em_ÿched
 && *em_cached) {

946 
em
 = *
em_ÿched
;

947 ià(
	`ex‹Á_m­_š_Œ“
(
em
è&& 
¡¬t
 >=ƒm->start &&

948 
¡¬t
 < 
	`ex‹Á_m­_’d
(
em
)) {

949 
	`»fcouÁ_šc
(&
em
->
»fs
);

950  
em
;

953 
	`ä“_ex‹Á_m­
(
em
);

954 *
em_ÿched
 = 
NULL
;

957 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
·ge
, 
pg_off£t
, 
¡¬t
, 
Ën
);

958 ià(
em_ÿched
 && !
	`IS_ERR
(
em
)) {

959 
	`BUG_ON
(*
em_ÿched
);

960 
	`»fcouÁ_šc
(&
em
->
»fs
);

961 *
em_ÿched
 = 
em
;

963  
em
;

964 
	}
}

972 
	$bŒfs_do_»ad·ge
(
·ge
 *·ge, 
ex‹Á_m­
 **
em_ÿched
,

973 
bŒfs_bio_ù¾
 *
bio_ù¾
, 
u64
 *
´ev_em_¡¬t
)

975 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

976 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

977 
u64
 
¡¬t
 = 
	`·ge_off£t
(
·ge
);

978 cÚ¡ 
u64
 
’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

979 
u64
 
cur
 = 
¡¬t
;

980 
u64
 
ex‹Á_off£t
;

981 
u64
 
Ï¡_by‹
 = 
	`i_size_»ad
(
šode
);

982 
u64
 
block_¡¬t
;

983 
ex‹Á_m­
 *
em
;

984 
»t
 = 0;

985 
size_t
 
pg_off£t
 = 0;

986 
size_t
 
iosize
;

987 
size_t
 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

988 
ex‹Á_io_Œ“
 *
Œ“
 = &
	`BTRFS_I
(
šode
)->
io_Œ“
;

990 
»t
 = 
	`£t_·ge_ex‹Á_m­³d
(
·ge
);

991 ià(
»t
 < 0) {

992 
	`uÆock_ex‹Á
(
Œ“
, 
¡¬t
, 
’d
, 
NULL
);

993 
	`uÆock_·ge
(
·ge
);

994  
»t
;

997 ià(
·ge
->
šdex
 =ğ
Ï¡_by‹
 >> 
PAGE_SHIFT
) {

998 
size_t
 
z”o_off£t
 = 
	`off£t_š_·ge
(
Ï¡_by‹
);

1000 ià(
z”o_off£t
) {

1001 
iosize
 = 
PAGE_SIZE
 - 
z”o_off£t
;

1002 
	`memz”o_·ge
(
·ge
, 
z”o_off£t
, 
iosize
);

1005 
bio_ù¾
->
’d_io_func
 = 
’d_bio_ex‹Á_»ad·ge
;

1006 
	`begš_·ge_»ad
(
fs_šfo
, 
·ge
);

1007 
cur
 <ğ
’d
) {

1008 
bŒfs_com´essiÚ_ty³
 
com´ess_ty³
 = 
BTRFS_COMPRESS_NONE
;

1009 
boŞ
 
fÜû_bio_subm™
 = 
çl£
;

1010 
u64
 
disk_by‹Ä
;

1012 
	`ASSERT
(
	`IS_ALIGNED
(
cur
, 
fs_šfo
->
£ùÜsize
));

1013 ià(
cur
 >ğ
Ï¡_by‹
) {

1014 
iosize
 = 
PAGE_SIZE
 - 
pg_off£t
;

1015 
	`memz”o_·ge
(
·ge
, 
pg_off£t
, 
iosize
);

1016 
	`uÆock_ex‹Á
(
Œ“
, 
cur
, cu¸+ 
iosize
 - 1, 
NULL
);

1017 
	`’d_·ge_»ad
(
·ge
, 
Œue
, 
cur
, 
iosize
);

1020 
em
 = 
	`__g‘_ex‹Á_m­
(
šode
, 
·ge
, 
pg_off£t
, 
cur
,

1021 
’d
 - 
cur
 + 1, 
em_ÿched
);

1022 ià(
	`IS_ERR
(
em
)) {

1023 
	`uÆock_ex‹Á
(
Œ“
, 
cur
, 
’d
, 
NULL
);

1024 
	`’d_·ge_»ad
(
·ge
, 
çl£
, 
cur
, 
’d
 + 1 - cur);

1025  
	`PTR_ERR
(
em
);

1027 
ex‹Á_off£t
 = 
cur
 - 
em
->
¡¬t
;

1028 
	`BUG_ON
(
	`ex‹Á_m­_’d
(
em
è<ğ
cur
);

1029 
	`BUG_ON
(
’d
 < 
cur
);

1031 ià(
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
))

1032 
com´ess_ty³
 = 
em
->compress_type;

1034 
iosize
 = 
	`mš
(
	`ex‹Á_m­_’d
(
em
è- 
cur
, 
’d
 - cur + 1);

1035 
iosize
 = 
	`ALIGN
(iosize, 
blocksize
);

1036 ià(
com´ess_ty³
 !ğ
BTRFS_COMPRESS_NONE
)

1037 
disk_by‹Ä
 = 
em
->
block_¡¬t
;

1039 
disk_by‹Ä
 = 
em
->
block_¡¬t
 + 
ex‹Á_off£t
;

1040 
block_¡¬t
 = 
em
->block_start;

1041 ià(
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
))

1042 
block_¡¬t
 = 
EXTENT_MAP_HOLE
;

1078 ià(
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
) &&

1079 
´ev_em_¡¬t
 && *´ev_em_¡¬ˆ!ğ(
u64
)-1 &&

1080 *
´ev_em_¡¬t
 !ğ
em
->
¡¬t
)

1081 
fÜû_bio_subm™
 = 
Œue
;

1083 ià(
´ev_em_¡¬t
)

1084 *
´ev_em_¡¬t
 = 
em
->
¡¬t
;

1086 
	`ä“_ex‹Á_m­
(
em
);

1087 
em
 = 
NULL
;

1090 ià(
block_¡¬t
 =ğ
EXTENT_MAP_HOLE
) {

1091 
	`memz”o_·ge
(
·ge
, 
pg_off£t
, 
iosize
);

1093 
	`uÆock_ex‹Á
(
Œ“
, 
cur
, cu¸+ 
iosize
 - 1, 
NULL
);

1094 
	`’d_·ge_»ad
(
·ge
, 
Œue
, 
cur
, 
iosize
);

1095 
cur
 = cu¸+ 
iosize
;

1096 
pg_off£t
 +ğ
iosize
;

1100 ià(
block_¡¬t
 =ğ
EXTENT_MAP_INLINE
) {

1101 
	`uÆock_ex‹Á
(
Œ“
, 
cur
, cu¸+ 
iosize
 - 1, 
NULL
);

1102 
	`’d_·ge_»ad
(
·ge
, 
Œue
, 
cur
, 
iosize
);

1103 
cur
 = cu¸+ 
iosize
;

1104 
pg_off£t
 +ğ
iosize
;

1108 ià(
bio_ù¾
->
com´ess_ty³
 != compress_type) {

1109 
	`subm™_Úe_bio
(
bio_ù¾
);

1110 
bio_ù¾
->
com´ess_ty³
 = compress_type;

1113 ià(
fÜû_bio_subm™
)

1114 
	`subm™_Úe_bio
(
bio_ù¾
);

1115 
	`subm™_ex‹Á_·ge
(
bio_ù¾
, 
disk_by‹Ä
, 
·ge
, 
iosize
,

1116 
pg_off£t
);

1117 
cur
 = cu¸+ 
iosize
;

1118 
pg_off£t
 +ğ
iosize
;

1122 
	}
}

1124 
	$bŒfs_»ad_fŞio
(
fe
 *fe, 
fŞio
 *folio)

1126 
·ge
 *·gğ&
fŞio
->page;

1127 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
·ge
->
m­pšg
->
ho¡
);

1128 
u64
 
¡¬t
 = 
	`·ge_off£t
(
·ge
);

1129 
u64
 
’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

1130 
bŒfs_bio_ù¾
 
bio_ù¾
 = { .
İf
 = 
REQ_OP_READ
 };

1131 
»t
;

1133 
	`bŒfs_lock_ªd_æush_Üd”ed_¿nge
(
šode
, 
¡¬t
, 
’d
, 
NULL
);

1135 
»t
 = 
	`bŒfs_do_»ad·ge
(
·ge
, 
NULL
, &
bio_ù¾
, NULL);

1140 
	`subm™_Úe_bio
(&
bio_ù¾
);

1141  
»t
;

1142 
	}
}

1144 
šlše
 
	$cÚtiguous_»ad·ges
(
·ge
 *
·ges
[], 
Ä_·ges
,

1145 
u64
 
¡¬t
, u64 
’d
,

1146 
ex‹Á_m­
 **
em_ÿched
,

1147 
bŒfs_bio_ù¾
 *
bio_ù¾
,

1148 
u64
 *
´ev_em_¡¬t
)

1150 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
·ges
[0]->
m­pšg
->
ho¡
);

1151 
šdex
;

1153 
	`bŒfs_lock_ªd_æush_Üd”ed_¿nge
(
šode
, 
¡¬t
, 
’d
, 
NULL
);

1155 
šdex
 = 0; index < 
Ä_·ges
; index++) {

1156 
	`bŒfs_do_»ad·ge
(
·ges
[
šdex
], 
em_ÿched
, 
bio_ù¾
,

1157 
´ev_em_¡¬t
);

1158 
	`put_·ge
(
·ges
[
šdex
]);

1160 
	}
}

1172 
nošlše_fÜ_¡ack
 
	$wr™•age_d–®loc
(
bŒfs_šode
 *
šode
,

1173 
·ge
 *·ge, 
wr™eback_cÚŒŞ
 *
wbc
)

1175 cÚ¡ 
u64
 
·ge_¡¬t
 = 
	`·ge_off£t
(
·ge
);

1176 cÚ¡ 
u64
 
·ge_’d
 = 
·ge_¡¬t
 + 
PAGE_SIZE
 - 1;

1177 
u64
 
d–®loc_¡¬t
 = 
·ge_¡¬t
;

1178 
u64
 
d–®loc_’d
 = 
·ge_’d
;

1179 
u64
 
d–®loc_to_wr™e
 = 0;

1180 
»t
 = 0;

1182 
d–®loc_¡¬t
 < 
·ge_’d
) {

1183 
d–®loc_’d
 = 
·ge_’d
;

1184 ià(!
	`fšd_lock_d–®loc_¿nge
(&
šode
->
vfs_šode
, 
·ge
,

1185 &
d–®loc_¡¬t
, &
d–®loc_’d
)) {

1186 
d–®loc_¡¬t
 = 
d–®loc_’d
 + 1;

1190 
»t
 = 
	`bŒfs_run_d–®loc_¿nge
(
šode
, 
·ge
, 
d–®loc_¡¬t
,

1191 
d–®loc_’d
, 
wbc
);

1192 ià(
»t
 < 0)

1193  
»t
;

1195 
d–®loc_¡¬t
 = 
d–®loc_’d
 + 1;

1202 
d–®loc_to_wr™e
 +=

1203 
	`DIV_ROUND_UP
(
d–®loc_’d
 + 1 - 
·ge_¡¬t
, 
PAGE_SIZE
);

1209 ià(
»t
 == 1) {

1210 
wbc
->
Ä_to_wr™e
 -ğ
d–®loc_to_wr™e
;

1214 ià(
wbc
->
Ä_to_wr™e
 < 
d–®loc_to_wr™e
) {

1215 
th»sh
 = 8192;

1217 ià(
d–®loc_to_wr™e
 < 
th»sh
 * 2)

1218 
th»sh
 = 
d–®loc_to_wr™e
;

1219 
wbc
->
Ä_to_wr™e
 = 
	`mš_t
(
u64
, 
d–®loc_to_wr™e
,

1220 
th»sh
);

1224 
	}
}

1241 
	$fšd_Ãxt_dœty_by‹
(
bŒfs_fs_šfo
 *
fs_šfo
,

1242 
·ge
 *·ge, 
u64
 *
¡¬t
, u64 *
’d
)

1244 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

1245 
bŒfs_sub·ge_šfo
 *
¥i
 = 
fs_šfo
->
sub·ge_šfo
;

1246 
u64
 
Üig_¡¬t
 = *
¡¬t
;

1248 
æags
;

1249 
¿nge_¡¬t_b™
;

1250 
¿nge_’d_b™
;

1256 ià(!
	`bŒfs_is_sub·ge
(
fs_šfo
, 
·ge
)) {

1257 *
¡¬t
 = 
	`·ge_off£t
(
·ge
);

1258 *
’d
 = 
	`·ge_off£t
(
·ge
è+ 
PAGE_SIZE
;

1262 
¿nge_¡¬t_b™
 = 
¥i
->
dœty_off£t
 +

1263 (
	`off£t_š_·ge
(
Üig_¡¬t
è>> 
fs_šfo
->
£ùÜsize_b™s
);

1266 
	`¥š_lock_œq§ve
(&
sub·ge
->
lock
, 
æags
);

1267 
	`b™m­_Ãxt_£t_»giÚ
(
sub·ge
->
b™m­s
, &
¿nge_¡¬t_b™
, &
¿nge_’d_b™
,

1268 
¥i
->
dœty_off£t
 + spi->
b™m­_Ä_b™s
);

1269 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
);

1271 
¿nge_¡¬t_b™
 -ğ
¥i
->
dœty_off£t
;

1272 
¿nge_’d_b™
 -ğ
¥i
->
dœty_off£t
;

1274 *
¡¬t
 = 
	`·ge_off£t
(
·ge
è+ 
¿nge_¡¬t_b™
 * 
fs_šfo
->
£ùÜsize
;

1275 *
’d
 = 
	`·ge_off£t
(
·ge
è+ 
¿nge_’d_b™
 * 
fs_šfo
->
£ùÜsize
;

1276 
	}
}

1286 
nošlše_fÜ_¡ack
 
	$__ex‹Á_wr™•age_io
(
bŒfs_šode
 *
šode
,

1287 
·ge
 *page,

1288 
bŒfs_bio_ù¾
 *
bio_ù¾
,

1289 
loff_t
 
i_size
,

1290 *
Ä_»t
)

1292 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

1293 
u64
 
cur
 = 
	`·ge_off£t
(
·ge
);

1294 
u64
 
’d
 = 
cur
 + 
PAGE_SIZE
 - 1;

1295 
u64
 
ex‹Á_off£t
;

1296 
u64
 
block_¡¬t
;

1297 
ex‹Á_m­
 *
em
;

1298 
»t
 = 0;

1299 
Ä
 = 0;

1301 
»t
 = 
	`bŒfs_wr™•age_cow_fixup
(
·ge
);

1302 ià(
»t
) {

1304 
	`»dœty_·ge_fÜ_wr™•age
(
bio_ù¾
->
wbc
, 
·ge
);

1305 
	`uÆock_·ge
(
·ge
);

1309 
bio_ù¾
->
’d_io_func
 = 
’d_bio_ex‹Á_wr™•age
;

1310 
cur
 <ğ
’d
) {

1311 
u32
 
Ën
 = 
’d
 - 
cur
 + 1;

1312 
u64
 
disk_by‹Ä
;

1313 
u64
 
em_’d
;

1314 
u64
 
dœty_¿nge_¡¬t
 = 
cur
;

1315 
u64
 
dœty_¿nge_’d
;

1316 
u32
 
iosize
;

1318 ià(
cur
 >ğ
i_size
) {

1319 
	`bŒfs_m¬k_Üd”ed_io_fšished
(
šode
, 
·ge
, 
cur
, 
Ën
,

1320 
Œue
);

1329 
	`bŒfs_·ge_ş—r_dœty
(
fs_šfo
, 
·ge
, 
cur
, 
Ën
);

1333 
	`fšd_Ãxt_dœty_by‹
(
fs_šfo
, 
·ge
, &
dœty_¿nge_¡¬t
,

1334 &
dœty_¿nge_’d
);

1335 ià(
cur
 < 
dœty_¿nge_¡¬t
) {

1336 
cur
 = 
dœty_¿nge_¡¬t
;

1340 
em
 = 
	`bŒfs_g‘_ex‹Á
(
šode
, 
NULL
, 0, 
cur
, 
Ën
);

1341 ià(
	`IS_ERR
(
em
)) {

1342 
»t
 = 
	`PTR_ERR_OR_ZERO
(
em
);

1343 
out_”rÜ
;

1346 
ex‹Á_off£t
 = 
cur
 - 
em
->
¡¬t
;

1347 
em_’d
 = 
	`ex‹Á_m­_’d
(
em
);

1348 
	`ASSERT
(
cur
 <ğ
em_’d
);

1349 
	`ASSERT
(
cur
 < 
’d
);

1350 
	`ASSERT
(
	`IS_ALIGNED
(
em
->
¡¬t
, 
fs_šfo
->
£ùÜsize
));

1351 
	`ASSERT
(
	`IS_ALIGNED
(
em
->
Ën
, 
fs_šfo
->
£ùÜsize
));

1353 
block_¡¬t
 = 
em
->block_start;

1354 
disk_by‹Ä
 = 
em
->
block_¡¬t
 + 
ex‹Á_off£t
;

1356 
	`ASSERT
(!
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
));

1357 
	`ASSERT
(
block_¡¬t
 !ğ
EXTENT_MAP_HOLE
);

1358 
	`ASSERT
(
block_¡¬t
 !ğ
EXTENT_MAP_INLINE
);

1364 
iosize
 = 
	`mš
(mš(
em_’d
, 
’d
 + 1), 
dœty_¿nge_’d
è- 
cur
;

1365 
	`ä“_ex‹Á_m­
(
em
);

1366 
em
 = 
NULL
;

1368 
	`bŒfs_£t_¿nge_wr™eback
(
šode
, 
cur
, cu¸+ 
iosize
 - 1);

1369 ià(!
	`PageWr™eback
(
·ge
)) {

1370 
	`bŒfs_”r
(
šode
->
roÙ
->
fs_šfo
,

1372 
·ge
->
šdex
, 
cur
, 
’d
);

1381 
	`bŒfs_·ge_ş—r_dœty
(
fs_šfo
, 
·ge
, 
cur
, 
iosize
);

1383 
	`subm™_ex‹Á_·ge
(
bio_ù¾
, 
disk_by‹Ä
, 
·ge
, 
iosize
,

1384 
cur
 - 
	`·ge_off£t
(
·ge
));

1385 
cur
 +ğ
iosize
;

1386 
Ä
++;

1389 
	`bŒfs_·ge_as£¹_nÙ_dœty
(
fs_šfo
, 
·ge
);

1390 *
Ä_»t
 = 
Ä
;

1393 
out_”rÜ
:

1398 *
Ä_»t
 = 
Ä
;

1399  
»t
;

1400 
	}
}

1411 
	$__ex‹Á_wr™•age
(
·ge
 *·ge, 
bŒfs_bio_ù¾
 *
bio_ù¾
)

1413 
fŞio
 *fŞiØğ
	`·ge_fŞio
(
·ge
);

1414 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

1415 cÚ¡ 
u64
 
·ge_¡¬t
 = 
	`·ge_off£t
(
·ge
);

1416 
»t
;

1417 
Ä
 = 0;

1418 
size_t
 
pg_off£t
;

1419 
loff_t
 
i_size
 = 
	`i_size_»ad
(
šode
);

1420 
’d_šdex
 = 
i_size
 >> 
PAGE_SHIFT
;

1422 
	`Œaû___ex‹Á_wr™•age
(
·ge
, 
šode
, 
bio_ù¾
->
wbc
);

1424 
	`WARN_ON
(!
	`PageLocked
(
·ge
));

1426 
pg_off£t
 = 
	`off£t_š_·ge
(
i_size
);

1427 ià(
·ge
->
šdex
 > 
’d_šdex
 ||

1428 (
·ge
->
šdex
 =ğ
’d_šdex
 && !
pg_off£t
)) {

1429 
	`fŞio_šv®id©e
(
fŞio
, 0, 
	`fŞio_size
(folio));

1430 
	`fŞio_uÆock
(
fŞio
);

1434 ià(
·ge
->
šdex
 =ğ
’d_šdex
)

1435 
	`memz”o_·ge
(
·ge
, 
pg_off£t
, 
PAGE_SIZE
 -…g_offset);

1437 
»t
 = 
	`£t_·ge_ex‹Á_m­³d
(
·ge
);

1438 ià(
»t
 < 0)

1439 
dÚe
;

1441 
»t
 = 
	`wr™•age_d–®loc
(
	`BTRFS_I
(
šode
), 
·ge
, 
bio_ù¾
->
wbc
);

1442 ià(
»t
 == 1)

1444 ià(
»t
)

1445 
dÚe
;

1447 
»t
 = 
	`__ex‹Á_wr™•age_io
(
	`BTRFS_I
(
šode
), 
·ge
, 
bio_ù¾
, 
i_size
, &
Ä
);

1448 ià(
»t
 == 1)

1451 
bio_ù¾
->
wbc
->
Ä_to_wr™e
--;

1453 
dÚe
:

1454 ià(
Ä
 == 0) {

1456 
	`£t_·ge_wr™eback
(
·ge
);

1457 
	`’d_·ge_wr™eback
(
·ge
);

1459 ià(
»t
) {

1460 
	`bŒfs_m¬k_Üd”ed_io_fšished
(
	`BTRFS_I
(
šode
), 
·ge
, 
·ge_¡¬t
,

1461 
PAGE_SIZE
, !
»t
);

1462 
	`m­pšg_£t_”rÜ
(
·ge
->
m­pšg
, 
»t
);

1464 
	`uÆock_·ge
(
·ge
);

1465 
	`ASSERT
(
»t
 <= 0);

1466  
»t
;

1467 
	}
}

1469 
	$wa™_Ú_ex‹Á_bufãr_wr™eback
(
ex‹Á_bufãr
 *
eb
)

1471 
	`wa™_Ú_b™_io
(&
eb
->
bæags
, 
EXTENT_BUFFER_WRITEBACK
,

1472 
TASK_UNINTERRUPTIBLE
);

1473 
	}
}

1482 
nošlše_fÜ_¡ack
 
boŞ
 
	$lock_ex‹Á_bufãr_fÜ_io
(
ex‹Á_bufãr
 *
eb
,

1483 
wr™eback_cÚŒŞ
 *
wbc
)

1485 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

1486 
boŞ
 
»t
 = 
çl£
;

1488 
	`bŒfs_Œ“_lock
(
eb
);

1489 
	`‹¡_b™
(
EXTENT_BUFFER_WRITEBACK
, &
eb
->
bæags
)) {

1490 
	`bŒfs_Œ“_uÆock
(
eb
);

1491 ià(
wbc
->
sync_mode
 !ğ
WB_SYNC_ALL
)

1492  
çl£
;

1493 
	`wa™_Ú_ex‹Á_bufãr_wr™eback
(
eb
);

1494 
	`bŒfs_Œ“_lock
(
eb
);

1502 
	`¥š_lock
(&
eb
->
»fs_lock
);

1503 ià(
	`‹¡_ªd_ş—r_b™
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bæags
)) {

1504 
	`£t_b™
(
EXTENT_BUFFER_WRITEBACK
, &
eb
->
bæags
);

1505 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

1506 
	`bŒfs_£t_h—d”_æag
(
eb
, 
BTRFS_HEADER_FLAG_WRITTEN
);

1507 
	`³rıu_couÁ”_add_b©ch
(&
fs_šfo
->
dœty_m‘ad©a_by‹s
,

1508 -
eb
->
Ën
,

1509 
fs_šfo
->
dœty_m‘ad©a_b©ch
);

1510 
»t
 = 
Œue
;

1512 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

1514 
	`bŒfs_Œ“_uÆock
(
eb
);

1515  
»t
;

1516 
	}
}

1518 
	$£t_bŒ“_iÛ¼
(
ex‹Á_bufãr
 *
eb
)

1520 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

1522 
	`£t_b™
(
EXTENT_BUFFER_WRITE_ERR
, &
eb
->
bæags
);

1528 
	`ş—r_b™
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bæags
);

1536 
	`m­pšg_£t_”rÜ
(
eb
->
fs_šfo
->
bŒ“_šode
->
i_m­pšg
, -
EIO
);

1576 
eb
->
log_šdex
) {

1578 
	`£t_b™
(
BTRFS_FS_BTREE_ERR
, &
fs_šfo
->
æags
);

1581 
	`£t_b™
(
BTRFS_FS_LOG1_ERR
, &
fs_šfo
->
æags
);

1584 
	`£t_b™
(
BTRFS_FS_LOG2_ERR
, &
fs_šfo
->
æags
);

1587 
	`BUG
();

1589 
	}
}

1595 
ex‹Á_bufãr
 *
	$fšd_ex‹Á_bufãr_nŞock
(

1596 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
)

1598 
ex‹Á_bufãr
 *
eb
;

1600 
	`rcu_»ad_lock
();

1601 
eb
 = 
	`¿dix_Œ“_lookup
(&
fs_šfo
->
bufãr_¿dix
,

1602 
¡¬t
 >> 
fs_šfo
->
£ùÜsize_b™s
);

1603 ià(
eb
 && 
	`©omic_šc_nÙ_z”o
(&eb->
»fs
)) {

1604 
	`rcu_»ad_uÆock
();

1605  
eb
;

1607 
	`rcu_»ad_uÆock
();

1608  
NULL
;

1609 
	}
}

1611 
	$ex‹Á_bufãr_wr™e_’d_io
(
bŒfs_bio
 *
bbio
)

1613 
ex‹Á_bufãr
 *
eb
 = 
bbio
->
´iv©e
;

1614 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

1615 
boŞ
 
u±od©e
 = !
bbio
->
bio
.
bi_¡©us
;

1616 
bvec_™”_®l
 
™”_®l
;

1617 
bio_vec
 *
bvec
;

1618 
u32
 
bio_off£t
 = 0;

1620 ià(!
u±od©e
)

1621 
	`£t_bŒ“_iÛ¼
(
eb
);

1623 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, &
bbio
->
bio
, 
™”_®l
) {

1624 
u64
 
¡¬t
 = 
eb
->¡¬ˆ+ 
bio_off£t
;

1625 
·ge
 *·gğ
bvec
->
bv_·ge
;

1626 
u32
 
Ën
 = 
bvec
->
bv_Ën
;

1628 
	`bŒfs_·ge_ş—r_wr™eback
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

1629 
bio_off£t
 +ğ
Ën
;

1632 
	`ş—r_b™
(
EXTENT_BUFFER_WRITEBACK
, &
eb
->
bæags
);

1633 
	`smp_mb__aá”_©omic
();

1634 
	`wake_up_b™
(&
eb
->
bæags
, 
EXTENT_BUFFER_WRITEBACK
);

1636 
	`bio_put
(&
bbio
->
bio
);

1637 
	}
}

1639 
	$´•¬e_eb_wr™e
(
ex‹Á_bufãr
 *
eb
)

1641 
u32
 
Ä™ems
;

1642 
¡¬t
;

1643 
’d
;

1645 
	`ş—r_b™
(
EXTENT_BUFFER_WRITE_ERR
, &
eb
->
bæags
);

1648 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

1649 ià(
	`bŒfs_h—d”_Ëv–
(
eb
) > 0) {

1650 
’d
 = 
	`bŒfs_node_key_±r_off£t
(
eb
, 
Ä™ems
);

1651 
	`memz”o_ex‹Á_bufãr
(
eb
, 
’d
,ƒb->
Ën
 -ƒnd);

1657 
¡¬t
 = 
	`bŒfs_™em_Ä_off£t
(
eb
, 
Ä™ems
);

1658 
’d
 = 
	`bŒfs_™em_Ä_off£t
(
eb
, 0);

1659 ià(
Ä™ems
 == 0)

1660 
’d
 +ğ
	`BTRFS_LEAF_DATA_SIZE
(
eb
->
fs_šfo
);

1662 
’d
 +ğ
	`bŒfs_™em_off£t
(
eb
, 
Ä™ems
 - 1);

1663 
	`memz”o_ex‹Á_bufãr
(
eb
, 
¡¬t
, 
’d
 - start);

1665 
	}
}

1667 
nošlše_fÜ_¡ack
 
	$wr™e_Úe_eb
(
ex‹Á_bufãr
 *
eb
,

1668 
wr™eback_cÚŒŞ
 *
wbc
)

1670 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

1671 
bŒfs_bio
 *
bbio
;

1673 
	`´•¬e_eb_wr™e
(
eb
);

1675 
bbio
 = 
	`bŒfs_bio_®loc
(
INLINE_EXTENT_BUFFER_PAGES
,

1676 
REQ_OP_WRITE
 | 
REQ_META
 | 
	`wbc_to_wr™e_æags
(
wbc
),

1677 
eb
->
fs_šfo
, 
ex‹Á_bufãr_wr™e_’d_io
,ƒb);

1678 
bbio
->
bio
.
bi_™”
.
bi_£ùÜ
 = 
eb
->
¡¬t
 >> 
SECTOR_SHIFT
;

1679 
	`bio_£t_dev
(&
bbio
->
bio
, 
fs_šfo
->
fs_deviûs
->
Ï‹¡_dev
->
bdev
);

1680 
	`wbc_š™_bio
(
wbc
, &
bbio
->
bio
);

1681 
bbio
->
šode
 = 
	`BTRFS_I
(
eb
->
fs_šfo
->
bŒ“_šode
);

1682 
bbio
->
fe_off£t
 = 
eb
->
¡¬t
;

1683 ià(
fs_šfo
->
nodesize
 < 
PAGE_SIZE
) {

1684 
·ge
 *
p
 = 
eb
->
·ges
[0];

1686 
	`lock_·ge
(
p
);

1687 
	`bŒfs_sub·ge_£t_wr™eback
(
fs_šfo
, 
p
, 
eb
->
¡¬t
,ƒb->
Ën
);

1688 ià(
	`bŒfs_sub·ge_ş—r_ªd_‹¡_dœty
(
fs_šfo
, 
p
, 
eb
->
¡¬t
,

1689 
eb
->
Ën
)) {

1690 
	`ş—r_·ge_dœty_fÜ_io
(
p
);

1691 
wbc
->
Ä_to_wr™e
--;

1693 
	`__bio_add_·ge
(&
bbio
->
bio
, 
p
, 
eb
->
Ën
,ƒb->
¡¬t
 - 
	`·ge_off£t
(p));

1694 
	`wbc_accouÁ_cgroup_owÃr
(
wbc
, 
p
, 
eb
->
Ën
);

1695 
	`uÆock_·ge
(
p
);

1697 
i
 = 0; i < 
	`num_ex‹Á_·ges
(
eb
); i++) {

1698 
·ge
 *
p
 = 
eb
->
·ges
[
i
];

1700 
	`lock_·ge
(
p
);

1701 
	`ş—r_·ge_dœty_fÜ_io
(
p
);

1702 
	`£t_·ge_wr™eback
(
p
);

1703 
	`__bio_add_·ge
(&
bbio
->
bio
, 
p
, 
PAGE_SIZE
, 0);

1704 
	`wbc_accouÁ_cgroup_owÃr
(
wbc
, 
p
, 
PAGE_SIZE
);

1705 
wbc
->
Ä_to_wr™e
--;

1706 
	`uÆock_·ge
(
p
);

1709 
	`bŒfs_subm™_bio
(
bbio
, 0);

1710 
	}
}

1726 
	$subm™_eb_sub·ge
(
·ge
 *·ge, 
wr™eback_cÚŒŞ
 *
wbc
)

1728 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
·ge
->
m­pšg
->
ho¡
->
i_sb
);

1729 
subm™‹d
 = 0;

1730 
u64
 
·ge_¡¬t
 = 
	`·ge_off£t
(
·ge
);

1731 
b™_¡¬t
 = 0;

1732 
£ùÜs_³r_node
 = 
fs_šfo
->
nodesize
 >> fs_šfo->
£ùÜsize_b™s
;

1735 
b™_¡¬t
 < 
fs_šfo
->
sub·ge_šfo
->
b™m­_Ä_b™s
) {

1736 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

1737 
ex‹Á_bufãr
 *
eb
;

1738 
æags
;

1739 
u64
 
¡¬t
;

1745 
	`¥š_lock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

1746 ià(!
	`PagePriv©e
(
·ge
)) {

1747 
	`¥š_uÆock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

1750 
	`¥š_lock_œq§ve
(&
sub·ge
->
lock
, 
æags
);

1751 ià(!
	`‹¡_b™
(
b™_¡¬t
 + 
fs_šfo
->
sub·ge_šfo
->
dœty_off£t
,

1752 
sub·ge
->
b™m­s
)) {

1753 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
);

1754 
	`¥š_uÆock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

1755 
b™_¡¬t
++;

1759 
¡¬t
 = 
·ge_¡¬t
 + 
b™_¡¬t
 * 
fs_šfo
->
£ùÜsize
;

1760 
b™_¡¬t
 +ğ
£ùÜs_³r_node
;

1766 
eb
 = 
	`fšd_ex‹Á_bufãr_nŞock
(
fs_šfo
, 
¡¬t
);

1767 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
);

1768 
	`¥š_uÆock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

1775 ià(!
eb
)

1778 ià(
	`lock_ex‹Á_bufãr_fÜ_io
(
eb
, 
wbc
)) {

1779 
	`wr™e_Úe_eb
(
eb
, 
wbc
);

1780 
subm™‹d
++;

1782 
	`ä“_ex‹Á_bufãr
(
eb
);

1784  
subm™‹d
;

1785 
	}
}

1807 
	$subm™_eb_·ge
(
·ge
 *·ge, 
bŒfs_eb_wr™e_cÚ‹xt
 *
ùx
)

1809 
wr™eback_cÚŒŞ
 *
wbc
 = 
ùx
->wbc;

1810 
add»ss_¥aû
 *
m­pšg
 = 
·ge
->mapping;

1811 
ex‹Á_bufãr
 *
eb
;

1812 
»t
;

1814 ià(!
	`PagePriv©e
(
·ge
))

1817 ià(
	`bŒfs_sb
(
·ge
->
m­pšg
->
ho¡
->
i_sb
)->
nodesize
 < 
PAGE_SIZE
)

1818  
	`subm™_eb_sub·ge
(
·ge
, 
wbc
);

1820 
	`¥š_lock
(&
m­pšg
->
´iv©e_lock
);

1821 ià(!
	`PagePriv©e
(
·ge
)) {

1822 
	`¥š_uÆock
(&
m­pšg
->
´iv©e_lock
);

1826 
eb
 = (
ex‹Á_bufãr
 *)
·ge
->
´iv©e
;

1832 ià(
	`WARN_ON
(!
eb
)) {

1833 
	`¥š_uÆock
(&
m­pšg
->
´iv©e_lock
);

1837 ià(
eb
 =ğ
ùx
->eb) {

1838 
	`¥š_uÆock
(&
m­pšg
->
´iv©e_lock
);

1841 
»t
 = 
	`©omic_šc_nÙ_z”o
(&
eb
->
»fs
);

1842 
	`¥š_uÆock
(&
m­pšg
->
´iv©e_lock
);

1843 ià(!
»t
)

1846 
ùx
->
eb
 =ƒb;

1848 
»t
 = 
	`bŒfs_check_m‘a_wr™e_poš‹r
(
eb
->
fs_šfo
, 
ùx
);

1849 ià(
»t
) {

1850 ià(
»t
 =ğ-
EBUSY
)

1851 
»t
 = 0;

1852 
	`ä“_ex‹Á_bufãr
(
eb
);

1853  
»t
;

1856 ià(!
	`lock_ex‹Á_bufãr_fÜ_io
(
eb
, 
wbc
)) {

1857 
	`ä“_ex‹Á_bufãr
(
eb
);

1861 ià(
ùx
->
zÚed_bg
) {

1863 
	`bŒfs_scheduË_zÚe_fšish_bg
(
ùx
->
zÚed_bg
, 
eb
);

1864 
ùx
->
zÚed_bg
->
m‘a_wr™e_poš‹r
 +ğ
eb
->
Ën
;

1866 
	`wr™e_Úe_eb
(
eb
, 
wbc
);

1867 
	`ä“_ex‹Á_bufãr
(
eb
);

1869 
	}
}

1871 
	$bŒ“_wr™e_ÿche_·ges
(
add»ss_¥aû
 *
m­pšg
,

1872 
wr™eback_cÚŒŞ
 *
wbc
)

1874 
bŒfs_eb_wr™e_cÚ‹xt
 
ùx
 = { .
wbc
 = wbc };

1875 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`BTRFS_I
(
m­pšg
->
ho¡
)->
roÙ
->fs_info;

1876 
»t
 = 0;

1877 
dÚe
 = 0;

1878 
Ä_to_wr™e_dÚe
 = 0;

1879 
fŞio_b©ch
 
fb©ch
;

1880 
Ä_fŞios
;

1881 
pgoff_t
 
šdex
;

1882 
pgoff_t
 
’d
;

1883 
sÿÂed
 = 0;

1884 
xa_m¬k_t
 
g
;

1886 
	`fŞio_b©ch_š™
(&
fb©ch
);

1887 ià(
wbc
->
¿nge_cyşic
) {

1888 
šdex
 = 
m­pšg
->
wr™eback_šdex
;

1889 
’d
 = -1;

1894 
sÿÂed
 = (
šdex
 == 0);

1896 
šdex
 = 
wbc
->
¿nge_¡¬t
 >> 
PAGE_SHIFT
;

1897 
’d
 = 
wbc
->
¿nge_’d
 >> 
PAGE_SHIFT
;

1898 
sÿÂed
 = 1;

1900 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
)

1901 
g
 = 
PAGECACHE_TAG_TOWRITE
;

1903 
g
 = 
PAGECACHE_TAG_DIRTY
;

1904 
	`bŒfs_zÚed_m‘a_io_lock
(
fs_šfo
);

1905 
»Œy
:

1906 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
)

1907 
	`g_·ges_fÜ_wr™eback
(
m­pšg
, 
šdex
, 
’d
);

1908 !
dÚe
 && !
Ä_to_wr™e_dÚe
 && (
šdex
 <ğ
’d
) &&

1909 (
Ä_fŞios
 = 
	`fem­_g‘_fŞios_g
(
m­pšg
, &
šdex
, 
’d
,

1910 
g
, &
fb©ch
))) {

1911 
i
;

1913 
i
 = 0; i < 
Ä_fŞios
; i++) {

1914 
fŞio
 *fŞiØğ
fb©ch
.
fŞios
[
i
];

1916 
»t
 = 
	`subm™_eb_·ge
(&
fŞio
->
·ge
, &
ùx
);

1917 ià(
»t
 == 0)

1919 ià(
»t
 < 0) {

1920 
dÚe
 = 1;

1929 
Ä_to_wr™e_dÚe
 = 
wbc
->
Ä_to_wr™e
 <= 0;

1931 
	`fŞio_b©ch_»Ëa£
(&
fb©ch
);

1932 
	`cÚd_»sched
();

1934 ià(!
sÿÂed
 && !
dÚe
) {

1939 
sÿÂed
 = 1;

1940 
šdex
 = 0;

1941 
»Œy
;

1973 ià(
»t
 > 0)

1974 
»t
 = 0;

1975 ià(!
»t
 && 
	`BTRFS_FS_ERROR
(
fs_šfo
))

1976 
»t
 = -
EROFS
;

1978 ià(
ùx
.
zÚed_bg
)

1979 
	`bŒfs_put_block_group
(
ùx
.
zÚed_bg
);

1980 
	`bŒfs_zÚed_m‘a_io_uÆock
(
fs_šfo
);

1981  
»t
;

1982 
	}
}

1999 
	$ex‹Á_wr™e_ÿche_·ges
(
add»ss_¥aû
 *
m­pšg
,

2000 
bŒfs_bio_ù¾
 *
bio_ù¾
)

2002 
wr™eback_cÚŒŞ
 *
wbc
 = 
bio_ù¾
->wbc;

2003 
šode
 *šodğ
m­pšg
->
ho¡
;

2004 
»t
 = 0;

2005 
dÚe
 = 0;

2006 
Ä_to_wr™e_dÚe
 = 0;

2007 
fŞio_b©ch
 
fb©ch
;

2008 
Ä_fŞios
;

2009 
pgoff_t
 
šdex
;

2010 
pgoff_t
 
’d
;

2011 
pgoff_t
 
dÚe_šdex
;

2012 
¿nge_whŞe
 = 0;

2013 
sÿÂed
 = 0;

2014 
xa_m¬k_t
 
g
;

2025 ià(!
	`ig¿b
(
šode
))

2028 
	`fŞio_b©ch_š™
(&
fb©ch
);

2029 ià(
wbc
->
¿nge_cyşic
) {

2030 
šdex
 = 
m­pšg
->
wr™eback_šdex
;

2031 
’d
 = -1;

2036 
sÿÂed
 = (
šdex
 == 0);

2038 
šdex
 = 
wbc
->
¿nge_¡¬t
 >> 
PAGE_SHIFT
;

2039 
’d
 = 
wbc
->
¿nge_’d
 >> 
PAGE_SHIFT
;

2040 ià(
wbc
->
¿nge_¡¬t
 =ğ0 && wbc->
¿nge_’d
 =ğ
LLONG_MAX
)

2041 
¿nge_whŞe
 = 1;

2042 
sÿÂed
 = 1;

2052 ià(
¿nge_whŞe
 && 
wbc
->
Ä_to_wr™e
 =ğ
LONG_MAX
 &&

2053 
	`‹¡_ªd_ş—r_b™
(
BTRFS_INODE_SNAPSHOT_FLUSH
,

2054 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
))

2055 
wbc
->
gged_wr™•ages
 = 1;

2057 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
 || wbc->
gged_wr™•ages
)

2058 
g
 = 
PAGECACHE_TAG_TOWRITE
;

2060 
g
 = 
PAGECACHE_TAG_DIRTY
;

2061 
»Œy
:

2062 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
 || wbc->
gged_wr™•ages
)

2063 
	`g_·ges_fÜ_wr™eback
(
m­pšg
, 
šdex
, 
’d
);

2064 
dÚe_šdex
 = 
šdex
;

2065 !
dÚe
 && !
Ä_to_wr™e_dÚe
 && (
šdex
 <ğ
’d
) &&

2066 (
Ä_fŞios
 = 
	`fem­_g‘_fŞios_g
(
m­pšg
, &
šdex
,

2067 
’d
, 
g
, &
fb©ch
))) {

2068 
i
;

2070 
i
 = 0; i < 
Ä_fŞios
; i++) {

2071 
fŞio
 *fŞiØğ
fb©ch
.
fŞios
[
i
];

2073 
dÚe_šdex
 = 
	`fŞio_Ãxt_šdex
(
fŞio
);

2081 ià(!
	`fŞio_Œylock
(
fŞio
)) {

2082 
	`subm™_wr™e_bio
(
bio_ù¾
, 0);

2083 
	`fŞio_lock
(
fŞio
);

2086 ià(
	`uÆik–y
(
fŞio
->
m­pšg
 != mapping)) {

2087 
	`fŞio_uÆock
(
fŞio
);

2091 ià(!
	`fŞio_‹¡_dœty
(
fŞio
)) {

2093 
	`fŞio_uÆock
(
fŞio
);

2097 ià(
wbc
->
sync_mode
 !ğ
WB_SYNC_NONE
) {

2098 ià(
	`fŞio_‹¡_wr™eback
(
fŞio
))

2099 
	`subm™_wr™e_bio
(
bio_ù¾
, 0);

2100 
	`fŞio_wa™_wr™eback
(
fŞio
);

2103 ià(
	`fŞio_‹¡_wr™eback
(
fŞio
) ||

2104 !
	`fŞio_ş—r_dœty_fÜ_io
(
fŞio
)) {

2105 
	`fŞio_uÆock
(
fŞio
);

2109 
»t
 = 
	`__ex‹Á_wr™•age
(&
fŞio
->
·ge
, 
bio_ù¾
);

2110 ià(
»t
 < 0) {

2111 
dÚe
 = 1;

2120 
Ä_to_wr™e_dÚe
 = (
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
 &&

2121 
wbc
->
Ä_to_wr™e
 <= 0);

2123 
	`fŞio_b©ch_»Ëa£
(&
fb©ch
);

2124 
	`cÚd_»sched
();

2126 ià(!
sÿÂed
 && !
dÚe
) {

2131 
sÿÂed
 = 1;

2132 
šdex
 = 0;

2140 
	`subm™_wr™e_bio
(
bio_ù¾
, 0);

2141 
»Œy
;

2144 ià(
wbc
->
¿nge_cyşic
 || (wbc->
Ä_to_wr™e
 > 0 && 
¿nge_whŞe
))

2145 
m­pšg
->
wr™eback_šdex
 = 
dÚe_šdex
;

2147 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
šode
));

2148  
»t
;

2149 
	}
}

2156 
	$ex‹Á_wr™e_locked_¿nge
(
šode
 *šode, 
·ge
 *
locked_·ge
,

2157 
u64
 
¡¬t
, u64 
’d
, 
wr™eback_cÚŒŞ
 *
wbc
,

2158 
boŞ
 
·ges_dœty
)

2160 
boŞ
 
found_”rÜ
 = 
çl£
;

2161 
»t
 = 0;

2162 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

2163 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2164 cÚ¡ 
u32
 
£ùÜsize
 = 
fs_šfo
->sectorsize;

2165 
loff_t
 
i_size
 = 
	`i_size_»ad
(
šode
);

2166 
u64
 
cur
 = 
¡¬t
;

2167 
bŒfs_bio_ù¾
 
bio_ù¾
 = {

2168 .
wbc
 = wbc,

2169 .
İf
 = 
REQ_OP_WRITE
 | 
	`wbc_to_wr™e_æags
(
wbc
),

2172 ià(
wbc
->
no_cgroup_owÃr
)

2173 
bio_ù¾
.
İf
 |ğ
REQ_BTRFS_CGROUP_PUNT
;

2175 
	`ASSERT
(
	`IS_ALIGNED
(
¡¬t
, 
£ùÜsize
è&& IS_ALIGNED(
’d
 + 1, sectorsize));

2177 
cur
 <ğ
’d
) {

2178 
u64
 
cur_’d
 = 
	`mš
(
	`round_down
(
cur
, 
PAGE_SIZE
è+ PAGE_SIZE - 1, 
’d
);

2179 
u32
 
cur_Ën
 = 
cur_’d
 + 1 - 
cur
;

2180 
·ge
 *page;

2181 
Ä
 = 0;

2183 
·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
, 
cur
 >> 
PAGE_SHIFT
);

2184 
	`ASSERT
(
	`PageLocked
(
·ge
));

2185 ià(
·ges_dœty
 && 
·ge
 !ğ
locked_·ge
) {

2186 
	`ASSERT
(
	`PageDœty
(
·ge
));

2187 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

2190 
»t
 = 
	`__ex‹Á_wr™•age_io
(
	`BTRFS_I
(
šode
), 
·ge
, &
bio_ù¾
,

2191 
i_size
, &
Ä
);

2192 ià(
»t
 == 1)

2193 
Ãxt_·ge
;

2196 ià(
Ä
 == 0) {

2197 
	`£t_·ge_wr™eback
(
·ge
);

2198 
	`’d_·ge_wr™eback
(
·ge
);

2200 ià(
»t
) {

2201 
	`bŒfs_m¬k_Üd”ed_io_fšished
(
	`BTRFS_I
(
šode
), 
·ge
,

2202 
cur
, 
cur_Ën
, !
»t
);

2203 
	`m­pšg_£t_”rÜ
(
·ge
->
m­pšg
, 
»t
);

2205 
	`bŒfs_·ge_uÆock_wr™”
(
fs_šfo
, 
·ge
, 
cur
, 
cur_Ën
);

2206 ià(
»t
 < 0)

2207 
found_”rÜ
 = 
Œue
;

2208 
Ãxt_·ge
:

2209 
	`put_·ge
(
·ge
);

2210 
cur
 = 
cur_’d
 + 1;

2213 
	`subm™_wr™e_bio
(&
bio_ù¾
, 
found_”rÜ
 ? 
»t
 : 0);

2214 
	}
}

2216 
	$ex‹Á_wr™•ages
(
add»ss_¥aû
 *
m­pšg
,

2217 
wr™eback_cÚŒŞ
 *
wbc
)

2219 
šode
 *šodğ
m­pšg
->
ho¡
;

2220 
»t
 = 0;

2221 
bŒfs_bio_ù¾
 
bio_ù¾
 = {

2222 .
wbc
 = wbc,

2223 .
İf
 = 
REQ_OP_WRITE
 | 
	`wbc_to_wr™e_æags
(
wbc
),

2230 
	`bŒfs_zÚed_d©a_»loc_lock
(
	`BTRFS_I
(
šode
));

2231 
»t
 = 
	`ex‹Á_wr™e_ÿche_·ges
(
m­pšg
, &
bio_ù¾
);

2232 
	`subm™_wr™e_bio
(&
bio_ù¾
, 
»t
);

2233 
	`bŒfs_zÚed_d©a_»loc_uÆock
(
	`BTRFS_I
(
šode
));

2234  
»t
;

2235 
	}
}

2237 
	$ex‹Á_»adah—d
(
»adah—d_cÚŒŞ
 *
¿c
)

2239 
bŒfs_bio_ù¾
 
bio_ù¾
 = { .
İf
 = 
REQ_OP_READ
 | 
REQ_RAHEAD
 };

2240 
·ge
 *
·g•oŞ
[16];

2241 
ex‹Á_m­
 *
em_ÿched
 = 
NULL
;

2242 
u64
 
´ev_em_¡¬t
 = (u64)-1;

2243 
Ä
;

2245 (
Ä
 = 
	`»adah—d_·ge_b©ch
(
¿c
, 
·g•oŞ
))) {

2246 
u64
 
cÚtig_¡¬t
 = 
	`»adah—d_pos
(
¿c
);

2247 
u64
 
cÚtig_’d
 = 
cÚtig_¡¬t
 + 
	`»adah—d_b©ch_Ëngth
(
¿c
) - 1;

2249 
	`cÚtiguous_»ad·ges
(
·g•oŞ
, 
Ä
, 
cÚtig_¡¬t
, 
cÚtig_’d
,

2250 &
em_ÿched
, &
bio_ù¾
, &
´ev_em_¡¬t
);

2253 ià(
em_ÿched
)

2254 
	`ä“_ex‹Á_m­
(
em_ÿched
);

2255 
	`subm™_Úe_bio
(&
bio_ù¾
);

2256 
	}
}

2263 
	$ex‹Á_šv®id©e_fŞio
(
ex‹Á_io_Œ“
 *
Œ“
,

2264 
fŞio
 *fŞio, 
size_t
 
off£t
)

2266 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

2267 
u64
 
¡¬t
 = 
	`fŞio_pos
(
fŞio
);

2268 
u64
 
’d
 = 
¡¬t
 + 
	`fŞio_size
(
fŞio
) - 1;

2269 
size_t
 
blocksize
 = 
fŞio
->
m­pšg
->
ho¡
->
i_sb
->
s_blocksize
;

2272 
	`ASSERT
(
Œ“
->
owÃr
 =ğ
IO_TREE_BTREE_INODE_IO
);

2274 
¡¬t
 +ğ
	`ALIGN
(
off£t
, 
blocksize
);

2275 ià(
¡¬t
 > 
’d
)

2278 
	`lock_ex‹Á
(
Œ“
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

2279 
	`fŞio_wa™_wr™eback
(
fŞio
);

2286 
	`uÆock_ex‹Á
(
Œ“
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

2288 
	}
}

2295 
	$Œy_»Ëa£_ex‹Á_¡©e
(
ex‹Á_io_Œ“
 *
Œ“
,

2296 
·ge
 *·ge, 
gå_t
 
mask
)

2298 
u64
 
¡¬t
 = 
	`·ge_off£t
(
·ge
);

2299 
u64
 
’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

2300 
»t
 = 1;

2302 ià(
	`‹¡_¿nge_b™
(
Œ“
, 
¡¬t
, 
’d
, 
EXTENT_LOCKED
, 0, 
NULL
)) {

2303 
»t
 = 0;

2305 
u32
 
ş—r_b™s
 = ~(
EXTENT_LOCKED
 | 
EXTENT_NODATASUM
 |

2306 
EXTENT_DELALLOC_NEW
 | 
EXTENT_CTLBITS
 |

2307 
EXTENT_QGROUP_RESERVED
);

2315 
»t
 = 
	`__ş—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
ş—r_b™s
, 
NULL
, NULL);

2320 ià(
»t
 < 0)

2321 
»t
 = 0;

2323 
»t
 = 1;

2325  
»t
;

2326 
	}
}

2333 
	$Œy_»Ëa£_ex‹Á_m­pšg
(
·ge
 *·ge, 
gå_t
 
mask
)

2335 
ex‹Á_m­
 *
em
;

2336 
u64
 
¡¬t
 = 
	`·ge_off£t
(
·ge
);

2337 
u64
 
’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

2338 
bŒfs_šode
 *bŒfs_šodğ
	`BTRFS_I
(
·ge
->
m­pšg
->
ho¡
);

2339 
ex‹Á_io_Œ“
 *
Œ“
 = &
bŒfs_šode
->
io_Œ“
;

2340 
ex‹Á_m­_Œ“
 *
m­
 = &
bŒfs_šode
->
ex‹Á_Œ“
;

2342 ià(
	`gåæags_®low_blockšg
(
mask
) &&

2343 
·ge
->
m­pšg
->
ho¡
->
i_size
 > 
SZ_16M
) {

2344 
u64
 
Ën
;

2345 
¡¬t
 <ğ
’d
) {

2346 
bŒfs_fs_šfo
 *
fs_šfo
;

2347 
u64
 
cur_g’
;

2349 
Ën
 = 
’d
 - 
¡¬t
 + 1;

2350 
	`wr™e_lock
(&
m­
->
lock
);

2351 
em
 = 
	`lookup_ex‹Á_m­pšg
(
m­
, 
¡¬t
, 
Ën
);

2352 ià(!
em
) {

2353 
	`wr™e_uÆock
(&
m­
->
lock
);

2356 ià(
	`‹¡_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
) ||

2357 
em
->
¡¬t
 != start) {

2358 
	`wr™e_uÆock
(&
m­
->
lock
);

2359 
	`ä“_ex‹Á_m­
(
em
);

2362 ià(
	`‹¡_¿nge_b™
(
Œ“
, 
em
->
¡¬t
,

2363 
	`ex‹Á_m­_’d
(
em
) - 1,

2364 
EXTENT_LOCKED
, 0, 
NULL
))

2365 
Ãxt
;

2372 ià(
	`li¡_em±y
(&
em
->
li¡
) ||

2373 
	`‹¡_b™
(
EXTENT_FLAG_LOGGING
, &
em
->
æags
))

2374 
»move_em
;

2382 
fs_šfo
 = 
bŒfs_šode
->
roÙ
->fs_info;

2383 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

2384 
cur_g’
 = 
fs_šfo
->
g’”©iÚ
;

2385 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2386 ià(
em
->
g’”©iÚ
 >ğ
cur_g’
)

2387 
Ãxt
;

2388 
»move_em
:

2397 
	`»move_ex‹Á_m­pšg
(
m­
, 
em
);

2399 
	`ä“_ex‹Á_m­
(
em
);

2400 
Ãxt
:

2401 
¡¬t
 = 
	`ex‹Á_m­_’d
(
em
);

2402 
	`wr™e_uÆock
(&
m­
->
lock
);

2405 
	`ä“_ex‹Á_m­
(
em
);

2407 
	`cÚd_»sched
();

2410  
	`Œy_»Ëa£_ex‹Á_¡©e
(
Œ“
, 
·ge
, 
mask
);

2411 
	}
}

2418 
	sf›m­_ÿche
 {

2419 
u64
 
	moff£t
;

2420 
u64
 
	mphys
;

2421 
u64
 
	mËn
;

2422 
u32
 
	mæags
;

2423 
boŞ
 
	mÿched
;

2436 
	$em™_f›m­_ex‹Á
(
f›m­_ex‹Á_šfo
 *
f›šfo
,

2437 
f›m­_ÿche
 *
ÿche
,

2438 
u64
 
off£t
, u64 
phys
, u64 
Ën
, 
u32
 
æags
)

2440 
»t
 = 0;

2443 
	`ASSERT
((
æags
 & 
FIEMAP_EXTENT_LAST
) == 0);

2445 ià(!
ÿche
->
ÿched
)

2446 
assign
;

2455 ià(
ÿche
->
off£t
 + cache->
Ën
 > offset) {

2456 
	`WARN_ON
(1);

2457  -
EINVAL
;

2470 ià(
ÿche
->
off£t
 + cache->
Ën
 == offset &&

2471 
ÿche
->
phys
 + cache->
Ën
 ==…hys &&

2472 
ÿche
->
æags
 == flags) {

2473 
ÿche
->
Ën
 +=†en;

2478 
»t
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
, 
ÿche
->
off£t
, cache->
phys
,

2479 
ÿche
->
Ën
, cache->
æags
);

2480 
ÿche
->
ÿched
 = 
çl£
;

2481 ià(
»t
)

2482  
»t
;

2483 
assign
:

2484 
ÿche
->
ÿched
 = 
Œue
;

2485 
ÿche
->
off£t
 = offset;

2486 
ÿche
->
phys
 =…hys;

2487 
ÿche
->
Ën
 =†en;

2488 
ÿche
->
æags
 = flags;

2491 
	}
}

2504 
	$em™_Ï¡_f›m­_ÿche
(
f›m­_ex‹Á_šfo
 *
f›šfo
,

2505 
f›m­_ÿche
 *
ÿche
)

2507 
»t
;

2509 ià(!
ÿche
->
ÿched
)

2512 
»t
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
, 
ÿche
->
off£t
, cache->
phys
,

2513 
ÿche
->
Ën
, cache->
æags
);

2514 
ÿche
->
ÿched
 = 
çl£
;

2515 ià(
»t
 > 0)

2516 
»t
 = 0;

2517  
»t
;

2518 
	}
}

2520 
	$f›m­_Ãxt_Ëaf_™em
(
bŒfs_šode
 *
šode
, 
bŒfs_·th
 *
·th
)

2522 
ex‹Á_bufãr
 *
şÚe
;

2523 
bŒfs_key
 
key
;

2524 
¦Ù
;

2525 
»t
;

2527 
·th
->
¦Ùs
[0]++;

2528 ià(
·th
->
¦Ùs
[0] < 
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0]))

2531 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
šode
->
roÙ
, 
·th
);

2532 ià(
»t
 != 0)

2533  
»t
;

2539 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

2540 ià(
key
.
objeùid
 !ğ
	`bŒfs_šo
(
šode
è|| key.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

2544 
şÚe
 = 
	`bŒfs_şÚe_ex‹Á_bufãr
(
·th
->
nodes
[0]);

2545 ià(!
şÚe
)

2546  -
ENOMEM
;

2548 
¦Ù
 = 
·th
->
¦Ùs
[0];

2549 
	`bŒfs_»Ëa£_·th
(
·th
);

2550 
·th
->
nodes
[0] = 
şÚe
;

2551 
·th
->
¦Ùs
[0] = 
¦Ù
;

2554 
	}
}

2561 
	$f›m­_£¬ch_¦Ù
(
bŒfs_šode
 *
šode
, 
bŒfs_·th
 *
·th
,

2562 
u64
 
fe_off£t
)

2564 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

2565 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

2566 
ex‹Á_bufãr
 *
şÚe
;

2567 
bŒfs_key
 
key
;

2568 
¦Ù
;

2569 
»t
;

2571 
key
.
objeùid
 = 
šo
;

2572 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

2573 
key
.
off£t
 = 
fe_off£t
;

2575 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

2576 ià(
»t
 < 0)

2577  
»t
;

2579 ià(
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0) {

2580 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0] - 1);

2581 ià(
key
.
objeùid
 =ğ
šo
 && key.
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
)

2582 
·th
->
¦Ùs
[0]--;

2585 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0])) {

2586 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

2587 ià(
»t
 != 0)

2588  
»t
;

2590 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

2591 ià(
key
.
objeùid
 !ğ
šo
 || key.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

2611 
şÚe
 = 
	`bŒfs_şÚe_ex‹Á_bufãr
(
·th
->
nodes
[0]);

2612 ià(!
şÚe
)

2613  -
ENOMEM
;

2615 
¦Ù
 = 
·th
->
¦Ùs
[0];

2616 
	`bŒfs_»Ëa£_·th
(
·th
);

2617 
·th
->
nodes
[0] = 
şÚe
;

2618 
·th
->
¦Ùs
[0] = 
¦Ù
;

2621 
	}
}

2628 
	$f›m­_´oûss_hŞe
(
bŒfs_šode
 *
šode
,

2629 
f›m­_ex‹Á_šfo
 *
f›šfo
,

2630 
f›m­_ÿche
 *
ÿche
,

2631 
ex‹Á_¡©e
 **
d–®loc_ÿched_¡©e
,

2632 
bŒfs_back»f_sh¬e_check_ùx
 *
back»f_ùx
,

2633 
u64
 
disk_by‹Ä
, u64 
ex‹Á_off£t
,

2634 
u64
 
ex‹Á_g’
,

2635 
u64
 
¡¬t
, u64 
’d
)

2637 cÚ¡ 
u64
 
i_size
 = 
	`i_size_»ad
(&
šode
->
vfs_šode
);

2638 
u64
 
cur_off£t
 = 
¡¬t
;

2639 
u64
 
Ï¡_d–®loc_’d
 = 0;

2640 
u32
 
´—Îoc_æags
 = 
FIEMAP_EXTENT_UNWRITTEN
;

2641 
boŞ
 
checked_ex‹Á_sh¬ed
 = 
çl£
;

2642 
»t
;

2648 
cur_off£t
 < 
’d
 && cur_off£ˆ< 
i_size
) {

2649 
u64
 
d–®loc_¡¬t
;

2650 
u64
 
d–®loc_’d
;

2651 
u64
 
´—Îoc_¡¬t
;

2652 
u64
 
´—Îoc_Ën
 = 0;

2653 
boŞ
 
d–®loc
;

2655 
d–®loc
 = 
	`bŒfs_fšd_d–®loc_š_¿nge
(
šode
, 
cur_off£t
, 
’d
,

2656 
d–®loc_ÿched_¡©e
,

2657 &
d–®loc_¡¬t
,

2658 &
d–®loc_’d
);

2659 ià(!
d–®loc
)

2666 ià(
disk_by‹Ä
 != 0) {

2667 ià(
Ï¡_d–®loc_’d
 == 0) {

2668 
´—Îoc_¡¬t
 = 
¡¬t
;

2669 
´—Îoc_Ën
 = 
d–®loc_¡¬t
 - 
¡¬t
;

2671 
´—Îoc_¡¬t
 = 
Ï¡_d–®loc_’d
 + 1;

2672 
´—Îoc_Ën
 = 
d–®loc_¡¬t
 - 
´—Îoc_¡¬t
;

2676 ià(
´—Îoc_Ën
 > 0) {

2677 ià(!
checked_ex‹Á_sh¬ed
 && 
f›šfo
->
fi_ex‹Ás_max
) {

2678 
»t
 = 
	`bŒfs_is_d©a_ex‹Á_sh¬ed
(
šode
,

2679 
disk_by‹Ä
,

2680 
ex‹Á_g’
,

2681 
back»f_ùx
);

2682 ià(
»t
 < 0)

2683  
»t
;

2684 ià(
»t
 > 0)

2685 
´—Îoc_æags
 |ğ
FIEMAP_EXTENT_SHARED
;

2687 
checked_ex‹Á_sh¬ed
 = 
Œue
;

2689 
»t
 = 
	`em™_f›m­_ex‹Á
(
f›šfo
, 
ÿche
, 
´—Îoc_¡¬t
,

2690 
disk_by‹Ä
 + 
ex‹Á_off£t
,

2691 
´—Îoc_Ën
, 
´—Îoc_æags
);

2692 ià(
»t
)

2693  
»t
;

2694 
ex‹Á_off£t
 +ğ
´—Îoc_Ën
;

2697 
»t
 = 
	`em™_f›m­_ex‹Á
(
f›šfo
, 
ÿche
, 
d–®loc_¡¬t
, 0,

2698 
d–®loc_’d
 + 1 - 
d–®loc_¡¬t
,

2699 
FIEMAP_EXTENT_DELALLOC
 |

2700 
FIEMAP_EXTENT_UNKNOWN
);

2701 ià(
»t
)

2702  
»t
;

2704 
Ï¡_d–®loc_’d
 = 
d–®loc_’d
;

2705 
cur_off£t
 = 
d–®loc_’d
 + 1;

2706 
ex‹Á_off£t
 +ğ
cur_off£t
 - 
d–®loc_¡¬t
;

2707 
	`cÚd_»sched
();

2714 ià(
disk_by‹Ä
 !ğ0 && 
Ï¡_d–®loc_’d
 < 
’d
) {

2715 
u64
 
´—Îoc_¡¬t
;

2716 
u64
 
´—Îoc_Ën
;

2718 ià(
Ï¡_d–®loc_’d
 == 0) {

2719 
´—Îoc_¡¬t
 = 
¡¬t
;

2720 
´—Îoc_Ën
 = 
’d
 + 1 - 
¡¬t
;

2722 
´—Îoc_¡¬t
 = 
Ï¡_d–®loc_’d
 + 1;

2723 
´—Îoc_Ën
 = 
’d
 + 1 - 
´—Îoc_¡¬t
;

2726 ià(!
checked_ex‹Á_sh¬ed
 && 
f›šfo
->
fi_ex‹Ás_max
) {

2727 
»t
 = 
	`bŒfs_is_d©a_ex‹Á_sh¬ed
(
šode
,

2728 
disk_by‹Ä
,

2729 
ex‹Á_g’
,

2730 
back»f_ùx
);

2731 ià(
»t
 < 0)

2732  
»t
;

2733 ià(
»t
 > 0)

2734 
´—Îoc_æags
 |ğ
FIEMAP_EXTENT_SHARED
;

2736 
»t
 = 
	`em™_f›m­_ex‹Á
(
f›šfo
, 
ÿche
, 
´—Îoc_¡¬t
,

2737 
disk_by‹Ä
 + 
ex‹Á_off£t
,

2738 
´—Îoc_Ën
, 
´—Îoc_æags
);

2739 ià(
»t
)

2740  
»t
;

2744 
	}
}

2746 
	$f›m­_fšd_Ï¡_ex‹Á_off£t
(
bŒfs_šode
 *
šode
,

2747 
bŒfs_·th
 *
·th
,

2748 
u64
 *
Ï¡_ex‹Á_’d_»t
)

2750 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

2751 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

2752 
ex‹Á_bufãr
 *
Ëaf
;

2753 
bŒfs_fe_ex‹Á_™em
 *
ei
;

2754 
bŒfs_key
 
key
;

2755 
u64
 
disk_by‹Ä
;

2756 
»t
;

2762 
»t
 = 
	`bŒfs_lookup_fe_ex‹Á
(
NULL
, 
roÙ
, 
·th
, 
šo
, (
u64
)-1, 0);

2764 
	`ASSERT
(
»t
 != 0);

2765 ià(
»t
 < 0)

2766  
»t
;

2774 
	`ASSERT
(
·th
->
¦Ùs
[0] > 0);

2775 
·th
->
¦Ùs
[0]--;

2776 
Ëaf
 = 
·th
->
nodes
[0];

2777 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

2778 ià(
key
.
objeùid
 !ğ
šo
 || key.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
) {

2780 *
Ï¡_ex‹Á_’d_»t
 = 0;

2789 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_fe_ex‹Á_™em
);

2790 ià(
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
ei
è=ğ
BTRFS_FILE_EXTENT_INLINE
) {

2791 *
Ï¡_ex‹Á_’d_»t
 = 
	`bŒfs_fe_ex‹Á_’d
(
·th
);

2802 
disk_by‹Ä
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
ei
);

2803 
disk_by‹Ä
 == 0) {

2804 
»t
 = 
	`bŒfs_´evious_™em
(
roÙ
, 
·th
, 
šo
, 
BTRFS_EXTENT_DATA_KEY
);

2805 ià(
»t
 < 0) {

2806  
»t
;

2807 } ià(
»t
 > 0) {

2809 *
Ï¡_ex‹Á_’d_»t
 = 0;

2812 
Ëaf
 = 
·th
->
nodes
[0];

2813 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

2814 
bŒfs_fe_ex‹Á_™em
);

2815 
disk_by‹Ä
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
ei
);

2818 *
Ï¡_ex‹Á_’d_»t
 = 
	`bŒfs_fe_ex‹Á_’d
(
·th
);

2820 
	}
}

2822 
	$ex‹Á_f›m­
(
bŒfs_šode
 *
šode
, 
f›m­_ex‹Á_šfo
 *
f›šfo
,

2823 
u64
 
¡¬t
, u64 
Ën
)

2825 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

2826 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

2827 
ex‹Á_¡©e
 *
d–®loc_ÿched_¡©e
 = 
NULL
;

2828 
bŒfs_·th
 *
·th
;

2829 
f›m­_ÿche
 
ÿche
 = { 0 };

2830 
bŒfs_back»f_sh¬e_check_ùx
 *
back»f_ùx
;

2831 
u64
 
Ï¡_ex‹Á_’d
;

2832 
u64
 
´ev_ex‹Á_’d
;

2833 
u64
 
lock¡¬t
;

2834 
u64
 
lock’d
;

2835 
boŞ
 
¡İ³d
 = 
çl£
;

2836 
»t
;

2838 
back»f_ùx
 = 
	`bŒfs_®loc_back»f_sh¬e_check_ùx
();

2839 
·th
 = 
	`bŒfs_®loc_·th
();

2840 ià(!
back»f_ùx
 || !
·th
) {

2841 
»t
 = -
ENOMEM
;

2842 
out
;

2845 
lock¡¬t
 = 
	`round_down
(
¡¬t
, 
šode
->
roÙ
->
fs_šfo
->
£ùÜsize
);

2846 
lock’d
 = 
	`round_up
(
¡¬t
 + 
Ën
, 
šode
->
roÙ
->
fs_šfo
->
£ùÜsize
);

2847 
´ev_ex‹Á_’d
 = 
lock¡¬t
;

2849 
	`bŒfs_šode_lock
(
šode
, 
BTRFS_ILOCK_SHARED
);

2850 
	`lock_ex‹Á
(&
šode
->
io_Œ“
, 
lock¡¬t
, 
lock’d
, &
ÿched_¡©e
);

2852 
»t
 = 
	`f›m­_fšd_Ï¡_ex‹Á_off£t
(
šode
, 
·th
, &
Ï¡_ex‹Á_’d
);

2853 ià(
»t
 < 0)

2854 
out_uÆock
;

2855 
	`bŒfs_»Ëa£_·th
(
·th
);

2857 
·th
->
»ada
 = 
READA_FORWARD
;

2858 
»t
 = 
	`f›m­_£¬ch_¦Ù
(
šode
, 
·th
, 
lock¡¬t
);

2859 ià(
»t
 < 0) {

2860 
out_uÆock
;

2861 } ià(
»t
 > 0) {

2866 
»t
 = 0;

2867 
check_eof_d–®loc
;

2870 
´ev_ex‹Á_’d
 < 
lock’d
) {

2871 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

2872 
bŒfs_fe_ex‹Á_™em
 *
ei
;

2873 
bŒfs_key
 
key
;

2874 
u64
 
ex‹Á_’d
;

2875 
u64
 
ex‹Á_Ën
;

2876 
u64
 
ex‹Á_off£t
 = 0;

2877 
u64
 
ex‹Á_g’
;

2878 
u64
 
disk_by‹Ä
 = 0;

2879 
u64
 
æags
 = 0;

2880 
ex‹Á_ty³
;

2881 
u8
 
com´essiÚ
;

2883 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

2884 ià(
key
.
objeùid
 !ğ
šo
 || key.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

2887 
ex‹Á_’d
 = 
	`bŒfs_fe_ex‹Á_’d
(
·th
);

2893 ià(
ex‹Á_’d
 <ğ
lock¡¬t
)

2894 
Ãxt_™em
;

2896 
back»f_ùx
->
cu¼_Ëaf_by‹Ä
 = 
Ëaf
->
¡¬t
;

2899 ià(
´ev_ex‹Á_’d
 < 
key
.
off£t
) {

2900 cÚ¡ 
u64
 
¿nge_’d
 = 
	`mš
(
key
.
off£t
, 
lock’d
) - 1;

2902 
»t
 = 
	`f›m­_´oûss_hŞe
(
šode
, 
f›šfo
, &
ÿche
,

2903 &
d–®loc_ÿched_¡©e
,

2904 
back»f_ùx
, 0, 0, 0,

2905 
´ev_ex‹Á_’d
, 
¿nge_’d
);

2906 ià(
»t
 < 0) {

2907 
out_uÆock
;

2908 } ià(
»t
 > 0) {

2910 
¡İ³d
 = 
Œue
;

2915 ià(
key
.
off£t
 >ğ
lock’d
) {

2916 
¡İ³d
 = 
Œue
;

2921 
ex‹Á_Ën
 = 
ex‹Á_’d
 - 
key
.
off£t
;

2922 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

2923 
bŒfs_fe_ex‹Á_™em
);

2924 
com´essiÚ
 = 
	`bŒfs_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
ei
);

2925 
ex‹Á_ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
ei
);

2926 
ex‹Á_g’
 = 
	`bŒfs_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
ei
);

2928 ià(
ex‹Á_ty³
 !ğ
BTRFS_FILE_EXTENT_INLINE
) {

2929 
disk_by‹Ä
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
ei
);

2930 ià(
com´essiÚ
 =ğ
BTRFS_COMPRESS_NONE
)

2931 
ex‹Á_off£t
 = 
	`bŒfs_fe_ex‹Á_off£t
(
Ëaf
, 
ei
);

2934 ià(
com´essiÚ
 !ğ
BTRFS_COMPRESS_NONE
)

2935 
æags
 |ğ
FIEMAP_EXTENT_ENCODED
;

2937 ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
) {

2938 
æags
 |ğ
FIEMAP_EXTENT_DATA_INLINE
;

2939 
æags
 |ğ
FIEMAP_EXTENT_NOT_ALIGNED
;

2940 
»t
 = 
	`em™_f›m­_ex‹Á
(
f›šfo
, &
ÿche
, 
key
.
off£t
, 0,

2941 
ex‹Á_Ën
, 
æags
);

2942 } ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
) {

2943 
»t
 = 
	`f›m­_´oûss_hŞe
(
šode
, 
f›šfo
, &
ÿche
,

2944 &
d–®loc_ÿched_¡©e
,

2945 
back»f_ùx
,

2946 
disk_by‹Ä
, 
ex‹Á_off£t
,

2947 
ex‹Á_g’
, 
key
.
off£t
,

2948 
ex‹Á_’d
 - 1);

2949 } ià(
disk_by‹Ä
 == 0) {

2951 
»t
 = 
	`f›m­_´oûss_hŞe
(
šode
, 
f›šfo
, &
ÿche
,

2952 &
d–®loc_ÿched_¡©e
,

2953 
back»f_ùx
, 0, 0, 0,

2954 
key
.
off£t
, 
ex‹Á_’d
 - 1);

2957 ià(
f›šfo
->
fi_ex‹Ás_max
) {

2958 
»t
 = 
	`bŒfs_is_d©a_ex‹Á_sh¬ed
(
šode
,

2959 
disk_by‹Ä
,

2960 
ex‹Á_g’
,

2961 
back»f_ùx
);

2962 ià(
»t
 < 0)

2963 
out_uÆock
;

2964 ià(
»t
 > 0)

2965 
æags
 |ğ
FIEMAP_EXTENT_SHARED
;

2968 
»t
 = 
	`em™_f›m­_ex‹Á
(
f›šfo
, &
ÿche
, 
key
.
off£t
,

2969 
disk_by‹Ä
 + 
ex‹Á_off£t
,

2970 
ex‹Á_Ën
, 
æags
);

2973 ià(
»t
 < 0) {

2974 
out_uÆock
;

2975 } ià(
»t
 > 0) {

2977 
¡İ³d
 = 
Œue
;

2981 
´ev_ex‹Á_’d
 = 
ex‹Á_’d
;

2982 
Ãxt_™em
:

2983 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

2984 
»t
 = -
EINTR
;

2985 
out_uÆock
;

2988 
»t
 = 
	`f›m­_Ãxt_Ëaf_™em
(
šode
, 
·th
);

2989 ià(
»t
 < 0) {

2990 
out_uÆock
;

2991 } ià(
»t
 > 0) {

2995 
	`cÚd_»sched
();

2998 
check_eof_d–®loc
:

3006 
	`bŒfs_ä“_·th
(
·th
);

3007 
·th
 = 
NULL
;

3009 ià(!
¡İ³d
 && 
´ev_ex‹Á_’d
 < 
lock’d
) {

3010 
»t
 = 
	`f›m­_´oûss_hŞe
(
šode
, 
f›šfo
, &
ÿche
,

3011 &
d–®loc_ÿched_¡©e
, 
back»f_ùx
,

3012 0, 0, 0, 
´ev_ex‹Á_’d
, 
lock’d
 - 1);

3013 ià(
»t
 < 0)

3014 
out_uÆock
;

3015 
´ev_ex‹Á_’d
 = 
lock’d
;

3018 ià(
ÿche
.
ÿched
 && cache.
off£t
 + cache.
Ën
 >ğ
Ï¡_ex‹Á_’d
) {

3019 cÚ¡ 
u64
 
i_size
 = 
	`i_size_»ad
(&
šode
->
vfs_šode
);

3021 ià(
´ev_ex‹Á_’d
 < 
i_size
) {

3022 
u64
 
d–®loc_¡¬t
;

3023 
u64
 
d–®loc_’d
;

3024 
boŞ
 
d–®loc
;

3026 
d–®loc
 = 
	`bŒfs_fšd_d–®loc_š_¿nge
(
šode
,

3027 
´ev_ex‹Á_’d
,

3028 
i_size
 - 1,

3029 &
d–®loc_ÿched_¡©e
,

3030 &
d–®loc_¡¬t
,

3031 &
d–®loc_’d
);

3032 ià(!
d–®loc
)

3033 
ÿche
.
æags
 |ğ
FIEMAP_EXTENT_LAST
;

3035 
ÿche
.
æags
 |ğ
FIEMAP_EXTENT_LAST
;

3039 
»t
 = 
	`em™_Ï¡_f›m­_ÿche
(
f›šfo
, &
ÿche
);

3041 
out_uÆock
:

3042 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
lock¡¬t
, 
lock’d
, &
ÿched_¡©e
);

3043 
	`bŒfs_šode_uÆock
(
šode
, 
BTRFS_ILOCK_SHARED
);

3044 
out
:

3045 
	`ä“_ex‹Á_¡©e
(
d–®loc_ÿched_¡©e
);

3046 
	`bŒfs_ä“_back»f_sh¬e_ùx
(
back»f_ùx
);

3047 
	`bŒfs_ä“_·th
(
·th
);

3048  
»t
;

3049 
	}
}

3051 
	$__ä“_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
)

3053 
	`kmem_ÿche_ä“
(
ex‹Á_bufãr_ÿche
, 
eb
);

3054 
	}
}

3056 
	$ex‹Á_bufãr_und”_io
(cÚ¡ 
ex‹Á_bufãr
 *
eb
)

3058  (
	`‹¡_b™
(
EXTENT_BUFFER_WRITEBACK
, &
eb
->
bæags
) ||

3059 
	`‹¡_b™
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bæags
));

3060 
	}
}

3062 
boŞ
 
	$·ge_¿nge_has_eb
(
bŒfs_fs_šfo
 *
fs_šfo
, 
·ge
 *page)

3064 
bŒfs_sub·ge
 *
sub·ge
;

3066 
	`lockd•_as£¹_h–d
(&
·ge
->
m­pšg
->
´iv©e_lock
);

3068 ià(
	`PagePriv©e
(
·ge
)) {

3069 
sub·ge
 = (
bŒfs_sub·ge
 *)
·ge
->
´iv©e
;

3070 ià(
	`©omic_»ad
(&
sub·ge
->
eb_»fs
))

3071  
Œue
;

3076 ià(
	`©omic_»ad
(&
sub·ge
->
»ad”s
))

3077  
Œue
;

3079  
çl£
;

3080 
	}
}

3082 
	$d‘ach_ex‹Á_bufãr_·ge
(
ex‹Á_bufãr
 *
eb
, 
·ge
 *page)

3084 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

3085 cÚ¡ 
boŞ
 
m­³d
 = !
	`‹¡_b™
(
EXTENT_BUFFER_UNMAPPED
, &
eb
->
bæags
);

3091 ià(
m­³d
)

3092 
	`¥š_lock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

3094 ià(!
	`PagePriv©e
(
·ge
)) {

3095 ià(
m­³d
)

3096 
	`¥š_uÆock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

3100 ià(
fs_šfo
->
nodesize
 >ğ
PAGE_SIZE
) {

3108 ià(
	`PagePriv©e
(
·ge
) &&

3109 
·ge
->
´iv©e
 =ğ()
eb
) {

3110 
	`BUG_ON
(
	`‹¡_b™
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bæags
));

3111 
	`BUG_ON
(
	`PageDœty
(
·ge
));

3112 
	`BUG_ON
(
	`PageWr™eback
(
·ge
));

3117 
	`d‘ach_·ge_´iv©e
(
·ge
);

3119 ià(
m­³d
)

3120 
	`¥š_uÆock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

3129 ià(!
m­³d
) {

3130 
	`bŒfs_d‘ach_sub·ge
(
fs_šfo
, 
·ge
);

3134 
	`bŒfs_·ge_dec_eb_»fs
(
fs_šfo
, 
·ge
);

3140 ià(!
	`·ge_¿nge_has_eb
(
fs_šfo
, 
·ge
))

3141 
	`bŒfs_d‘ach_sub·ge
(
fs_šfo
, 
·ge
);

3143 
	`¥š_uÆock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

3144 
	}
}

3147 
	$bŒfs_»Ëa£_ex‹Á_bufãr_·ges
(
ex‹Á_bufãr
 *
eb
)

3149 
i
;

3150 
num_·ges
;

3152 
	`ASSERT
(!
	`ex‹Á_bufãr_und”_io
(
eb
));

3154 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
);

3155 
i
 = 0; i < 
num_·ges
; i++) {

3156 
·ge
 *·gğ
eb
->
·ges
[
i
];

3158 ià(!
·ge
)

3161 
	`d‘ach_ex‹Á_bufãr_·ge
(
eb
, 
·ge
);

3164 
	`put_·ge
(
·ge
);

3166 
	}
}

3171 
šlše
 
	$bŒfs_»Ëa£_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
)

3173 
	`bŒfs_»Ëa£_ex‹Á_bufãr_·ges
(
eb
);

3174 
	`bŒfs_Ëak_debug_d–_eb
(
eb
);

3175 
	`__ä“_ex‹Á_bufãr
(
eb
);

3176 
	}
}

3178 
ex‹Á_bufãr
 *

3179 
	$__®loc_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
,

3180 
Ën
)

3182 
ex‹Á_bufãr
 *
eb
 = 
NULL
;

3184 
eb
 = 
	`kmem_ÿche_z®loc
(
ex‹Á_bufãr_ÿche
, 
GFP_NOFS
|
__GFP_NOFAIL
);

3185 
eb
->
¡¬t
 = start;

3186 
eb
->
Ën
 =†en;

3187 
eb
->
fs_šfo
 = fs_info;

3188 
	`š™_rw£m
(&
eb
->
lock
);

3190 
	`bŒfs_Ëak_debug_add_eb
(
eb
);

3192 
	`¥š_lock_š™
(&
eb
->
»fs_lock
);

3193 
	`©omic_£t
(&
eb
->
»fs
, 1);

3195 
	`ASSERT
(
Ën
 <ğ
BTRFS_MAX_METADATA_BLOCKSIZE
);

3197  
eb
;

3198 
	}
}

3200 
ex‹Á_bufãr
 *
	$bŒfs_şÚe_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
¤c
)

3202 
i
;

3203 
ex‹Á_bufãr
 *
Ãw
;

3204 
num_·ges
 = 
	`num_ex‹Á_·ges
(
¤c
);

3205 
»t
;

3207 
Ãw
 = 
	`__®loc_ex‹Á_bufãr
(
¤c
->
fs_šfo
, src->
¡¬t
, src->
Ën
);

3208 ià(
Ãw
 =ğ
NULL
)

3209  
NULL
;

3216 
	`£t_b™
(
EXTENT_BUFFER_UNMAPPED
, &
Ãw
->
bæags
);

3218 
»t
 = 
	`bŒfs_®loc_·ge_¬¿y
(
num_·ges
, 
Ãw
->
·ges
);

3219 ià(
»t
) {

3220 
	`bŒfs_»Ëa£_ex‹Á_bufãr
(
Ãw
);

3221  
NULL
;

3224 
i
 = 0; i < 
num_·ges
; i++) {

3225 
»t
;

3226 
·ge
 *
p
 = 
Ãw
->
·ges
[
i
];

3228 
»t
 = 
	`©ch_ex‹Á_bufãr_·ge
(
Ãw
, 
p
, 
NULL
);

3229 ià(
»t
 < 0) {

3230 
	`bŒfs_»Ëa£_ex‹Á_bufãr
(
Ãw
);

3231  
NULL
;

3233 
	`WARN_ON
(
	`PageDœty
(
p
));

3235 
	`cİy_ex‹Á_bufãr_fuÎ
(
Ãw
, 
¤c
);

3236 
	`£t_ex‹Á_bufãr_u±od©e
(
Ãw
);

3238  
Ãw
;

3239 
	}
}

3241 
ex‹Á_bufãr
 *
	$__®loc_dummy_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

3242 
u64
 
¡¬t
, 
Ën
)

3244 
ex‹Á_bufãr
 *
eb
;

3245 
num_·ges
;

3246 
i
;

3247 
»t
;

3249 
eb
 = 
	`__®loc_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
, 
Ën
);

3250 ià(!
eb
)

3251  
NULL
;

3253 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
);

3254 
»t
 = 
	`bŒfs_®loc_·ge_¬¿y
(
num_·ges
, 
eb
->
·ges
);

3255 ià(
»t
)

3256 
”r
;

3258 
i
 = 0; i < 
num_·ges
; i++) {

3259 
·ge
 *
p
 = 
eb
->
·ges
[
i
];

3261 
»t
 = 
	`©ch_ex‹Á_bufãr_·ge
(
eb
, 
p
, 
NULL
);

3262 ià(
»t
 < 0)

3263 
”r
;

3266 
	`£t_ex‹Á_bufãr_u±od©e
(
eb
);

3267 
	`bŒfs_£t_h—d”_Ä™ems
(
eb
, 0);

3268 
	`£t_b™
(
EXTENT_BUFFER_UNMAPPED
, &
eb
->
bæags
);

3270  
eb
;

3271 
”r
:

3272 
i
 = 0; i < 
num_·ges
; i++) {

3273 ià(
eb
->
·ges
[
i
]) {

3274 
	`d‘ach_ex‹Á_bufãr_·ge
(
eb
,ƒb->
·ges
[
i
]);

3275 
	`__ä“_·ge
(
eb
->
·ges
[
i
]);

3278 
	`__ä“_ex‹Á_bufãr
(
eb
);

3279  
NULL
;

3280 
	}
}

3282 
ex‹Á_bufãr
 *
	$®loc_dummy_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

3283 
u64
 
¡¬t
)

3285  
	`__®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
, fs_šfo->
nodesize
);

3286 
	}
}

3288 
	$check_bufãr_Œ“_»f
(
ex‹Á_bufãr
 *
eb
)

3290 
»fs
;

3314 
»fs
 = 
	`©omic_»ad
(&
eb
->refs);

3315 ià(
»fs
 >ğ2 && 
	`‹¡_b™
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bæags
))

3318 
	`¥š_lock
(&
eb
->
»fs_lock
);

3319 ià(!
	`‹¡_ªd_£t_b™
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bæags
))

3320 
	`©omic_šc
(&
eb
->
»fs
);

3321 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

3322 
	}
}

3324 
	$m¬k_ex‹Á_bufãr_acûs£d
(
ex‹Á_bufãr
 *
eb
,

3325 
·ge
 *
acûs£d
)

3327 
num_·ges
, 
i
;

3329 
	`check_bufãr_Œ“_»f
(
eb
);

3331 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
);

3332 
i
 = 0; i < 
num_·ges
; i++) {

3333 
·ge
 *
p
 = 
eb
->
·ges
[
i
];

3335 ià(
p
 !ğ
acûs£d
)

3336 
	`m¬k_·ge_acûs£d
(
p
);

3338 
	}
}

3340 
ex‹Á_bufãr
 *
	$fšd_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

3341 
u64
 
¡¬t
)

3343 
ex‹Á_bufãr
 *
eb
;

3345 
eb
 = 
	`fšd_ex‹Á_bufãr_nŞock
(
fs_šfo
, 
¡¬t
);

3346 ià(!
eb
)

3347  
NULL
;

3361 ià(
	`‹¡_b™
(
EXTENT_BUFFER_STALE
, &
eb
->
bæags
)) {

3362 
	`¥š_lock
(&
eb
->
»fs_lock
);

3363 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

3365 
	`m¬k_ex‹Á_bufãr_acûs£d
(
eb
, 
NULL
);

3366  
eb
;

3367 
	}
}

3369 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


3370 
ex‹Á_bufãr
 *
	$®loc_‹¡_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

3371 
u64
 
¡¬t
)

3373 
ex‹Á_bufãr
 *
eb
, *
exi¡s
 = 
NULL
;

3374 
»t
;

3376 
eb
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
);

3377 ià(
eb
)

3378  
eb
;

3379 
eb
 = 
	`®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
);

3380 ià(!
eb
)

3381  
	`ERR_PTR
(-
ENOMEM
);

3382 
eb
->
fs_šfo
 = fs_info;

3383 
agaš
:

3384 
»t
 = 
	`¿dix_Œ“_´–ßd
(
GFP_NOFS
);

3385 ià(
»t
) {

3386 
exi¡s
 = 
	`ERR_PTR
(
»t
);

3387 
ä“_eb
;

3389 
	`¥š_lock
(&
fs_šfo
->
bufãr_lock
);

3390 
»t
 = 
	`¿dix_Œ“_š£¹
(&
fs_šfo
->
bufãr_¿dix
,

3391 
¡¬t
 >> 
fs_šfo
->
£ùÜsize_b™s
, 
eb
);

3392 
	`¥š_uÆock
(&
fs_šfo
->
bufãr_lock
);

3393 
	`¿dix_Œ“_´–ßd_’d
();

3394 ià(
»t
 =ğ-
EEXIST
) {

3395 
exi¡s
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
);

3396 ià(
exi¡s
)

3397 
ä“_eb
;

3399 
agaš
;

3401 
	`check_bufãr_Œ“_»f
(
eb
);

3402 
	`£t_b™
(
EXTENT_BUFFER_IN_TREE
, &
eb
->
bæags
);

3404  
eb
;

3405 
ä“_eb
:

3406 
	`bŒfs_»Ëa£_ex‹Á_bufãr
(
eb
);

3407  
exi¡s
;

3408 
	}
}

3411 
ex‹Á_bufãr
 *
	$g¿b_ex‹Á_bufãr
(

3412 
bŒfs_fs_šfo
 *
fs_šfo
, 
·ge
 *page)

3414 
ex‹Á_bufãr
 *
exi¡s
;

3421 ià(
fs_šfo
->
nodesize
 < 
PAGE_SIZE
)

3422  
NULL
;

3425 ià(!
	`PagePriv©e
(
·ge
))

3426  
NULL
;

3434 
exi¡s
 = (
ex‹Á_bufãr
 *)
·ge
->
´iv©e
;

3435 ià(
	`©omic_šc_nÙ_z”o
(&
exi¡s
->
»fs
))

3436  
exi¡s
;

3438 
	`WARN_ON
(
	`PageDœty
(
·ge
));

3439 
	`d‘ach_·ge_´iv©e
(
·ge
);

3440  
NULL
;

3441 
	}
}

3443 
	$check_eb_®ignm’t
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
)

3445 ià(!
	`IS_ALIGNED
(
¡¬t
, 
fs_šfo
->
£ùÜsize
)) {

3446 
	`bŒfs_”r
(
fs_šfo
, "bad»block s¹ %Îu", 
¡¬t
);

3447  -
EINVAL
;

3450 ià(
fs_šfo
->
nodesize
 < 
PAGE_SIZE
 &&

3451 
	`off£t_š_·ge
(
¡¬t
è+ 
fs_šfo
->
nodesize
 > 
PAGE_SIZE
) {

3452 
	`bŒfs_”r
(
fs_šfo
,

3454 
¡¬t
, 
fs_šfo
->
nodesize
);

3455  -
EINVAL
;

3457 ià(
fs_šfo
->
nodesize
 >ğ
PAGE_SIZE
 &&

3458 !
	`PAGE_ALIGNED
(
¡¬t
)) {

3459 
	`bŒfs_”r
(
fs_šfo
,

3461 
¡¬t
, 
fs_šfo
->
nodesize
);

3462  -
EINVAL
;

3465 
	}
}

3467 
ex‹Á_bufãr
 *
	$®loc_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

3468 
u64
 
¡¬t
, u64 
owÃr_roÙ
, 
Ëv–
)

3470 
Ën
 = 
fs_šfo
->
nodesize
;

3471 
num_·ges
;

3472 
i
;

3473 
šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

3474 
ex‹Á_bufãr
 *
eb
;

3475 
ex‹Á_bufãr
 *
exi¡s
 = 
NULL
;

3476 
·ge
 *
p
;

3477 
add»ss_¥aû
 *
m­pšg
 = 
fs_šfo
->
bŒ“_šode
->
i_m­pšg
;

3478 
bŒfs_sub·ge
 *
´—Îoc
 = 
NULL
;

3479 
u64
 
lockd•_owÃr
 = 
owÃr_roÙ
;

3480 
u±od©e
 = 1;

3481 
»t
;

3483 ià(
	`check_eb_®ignm’t
(
fs_šfo
, 
¡¬t
))

3484  
	`ERR_PTR
(-
EINVAL
);

3486 #ià
BITS_PER_LONG
 == 32

3487 ià(
¡¬t
 >ğ
MAX_LFS_FILESIZE
) {

3488 
	`bŒfs_”r_¾
(
fs_šfo
,

3489 "ex‹Á bufã¸%Îu i beyÚd 32b™…agÿchlim™", 
¡¬t
);

3490 
	`bŒfs_”r_32b™_lim™
(
fs_šfo
);

3491  
	`ERR_PTR
(-
EOVERFLOW
);

3493 ià(
¡¬t
 >ğ
BTRFS_32BIT_EARLY_WARN_THRESHOLD
)

3494 
	`bŒfs_w¬n_32b™_lim™
(
fs_šfo
);

3497 
eb
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
);

3498 ià(
eb
)

3499  
eb
;

3501 
eb
 = 
	`__®loc_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
, 
Ën
);

3502 ià(!
eb
)

3503  
	`ERR_PTR
(-
ENOMEM
);

3509 ià(
lockd•_owÃr
 =ğ
BTRFS_TREE_RELOC_OBJECTID
)

3510 
lockd•_owÃr
 = 
BTRFS_FS_TREE_OBJECTID
;

3512 
	`bŒfs_£t_bufãr_lockd•_şass
(
lockd•_owÃr
, 
eb
, 
Ëv–
);

3514 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
);

3523 ià(
fs_šfo
->
nodesize
 < 
PAGE_SIZE
) {

3524 
´—Îoc
 = 
	`bŒfs_®loc_sub·ge
(
fs_šfo
, 
BTRFS_SUBPAGE_METADATA
);

3525 ià(
	`IS_ERR
(
´—Îoc
)) {

3526 
exi¡s
 = 
	`ERR_CAST
(
´—Îoc
);

3527 
ä“_eb
;

3531 
i
 = 0; i < 
num_·ges
; i++, 
šdex
++) {

3532 
p
 = 
	`fšd_Ü_ü—‹_·ge
(
m­pšg
, 
šdex
, 
GFP_NOFS
|
__GFP_NOFAIL
);

3533 ià(!
p
) {

3534 
exi¡s
 = 
	`ERR_PTR
(-
ENOMEM
);

3535 
	`bŒfs_ä“_sub·ge
(
´—Îoc
);

3536 
ä“_eb
;

3539 
	`¥š_lock
(&
m­pšg
->
´iv©e_lock
);

3540 
exi¡s
 = 
	`g¿b_ex‹Á_bufãr
(
fs_šfo
, 
p
);

3541 ià(
exi¡s
) {

3542 
	`¥š_uÆock
(&
m­pšg
->
´iv©e_lock
);

3543 
	`uÆock_·ge
(
p
);

3544 
	`put_·ge
(
p
);

3545 
	`m¬k_ex‹Á_bufãr_acûs£d
(
exi¡s
, 
p
);

3546 
	`bŒfs_ä“_sub·ge
(
´—Îoc
);

3547 
ä“_eb
;

3550 
»t
 = 
	`©ch_ex‹Á_bufãr_·ge
(
eb
, 
p
, 
´—Îoc
);

3551 
	`ASSERT
(!
»t
);

3561 
	`bŒfs_·ge_šc_eb_»fs
(
fs_šfo
, 
p
);

3562 
	`¥š_uÆock
(&
m­pšg
->
´iv©e_lock
);

3564 
	`WARN_ON
(
	`bŒfs_·ge_‹¡_dœty
(
fs_šfo
, 
p
, 
eb
->
¡¬t
,ƒb->
Ën
));

3565 
eb
->
·ges
[
i
] = 
p
;

3566 ià(!
	`bŒfs_·ge_‹¡_u±od©e
(
fs_šfo
, 
p
, 
eb
->
¡¬t
,ƒb->
Ën
))

3567 
u±od©e
 = 0;

3577 ià(
u±od©e
)

3578 
	`£t_b™
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bæags
);

3579 
agaš
:

3580 
»t
 = 
	`¿dix_Œ“_´–ßd
(
GFP_NOFS
);

3581 ià(
»t
) {

3582 
exi¡s
 = 
	`ERR_PTR
(
»t
);

3583 
ä“_eb
;

3586 
	`¥š_lock
(&
fs_šfo
->
bufãr_lock
);

3587 
»t
 = 
	`¿dix_Œ“_š£¹
(&
fs_šfo
->
bufãr_¿dix
,

3588 
¡¬t
 >> 
fs_šfo
->
£ùÜsize_b™s
, 
eb
);

3589 
	`¥š_uÆock
(&
fs_šfo
->
bufãr_lock
);

3590 
	`¿dix_Œ“_´–ßd_’d
();

3591 ià(
»t
 =ğ-
EEXIST
) {

3592 
exi¡s
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
);

3593 ià(
exi¡s
)

3594 
ä“_eb
;

3596 
agaš
;

3599 
	`check_bufãr_Œ“_»f
(
eb
);

3600 
	`£t_b™
(
EXTENT_BUFFER_IN_TREE
, &
eb
->
bæags
);

3607 
i
 = 0; i < 
num_·ges
; i++)

3608 
	`uÆock_·ge
(
eb
->
·ges
[
i
]);

3609  
eb
;

3611 
ä“_eb
:

3612 
	`WARN_ON
(!
	`©omic_dec_ªd_‹¡
(&
eb
->
»fs
));

3613 
i
 = 0; i < 
num_·ges
; i++) {

3614 ià(
eb
->
·ges
[
i
])

3615 
	`uÆock_·ge
(
eb
->
·ges
[
i
]);

3618 
	`bŒfs_»Ëa£_ex‹Á_bufãr
(
eb
);

3619  
exi¡s
;

3620 
	}
}

3622 
šlše
 
	$bŒfs_»Ëa£_ex‹Á_bufãr_rcu
(
rcu_h—d
 *
h—d
)

3624 
ex‹Á_bufãr
 *
eb
 =

3625 
	`cÚš”_of
(
h—d
, 
ex‹Á_bufãr
, 
rcu_h—d
);

3627 
	`__ä“_ex‹Á_bufãr
(
eb
);

3628 
	}
}

3630 
	$»Ëa£_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
)

3631 
	`__»Ëa£s
(&
eb
->
»fs_lock
)

3633 
	`lockd•_as£¹_h–d
(&
eb
->
»fs_lock
);

3635 
	`WARN_ON
(
	`©omic_»ad
(&
eb
->
»fs
) == 0);

3636 ià(
	`©omic_dec_ªd_‹¡
(&
eb
->
»fs
)) {

3637 ià(
	`‹¡_ªd_ş—r_b™
(
EXTENT_BUFFER_IN_TREE
, &
eb
->
bæags
)) {

3638 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

3640 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

3642 
	`¥š_lock
(&
fs_šfo
->
bufãr_lock
);

3643 
	`¿dix_Œ“_d–‘e
(&
fs_šfo
->
bufãr_¿dix
,

3644 
eb
->
¡¬t
 >> 
fs_šfo
->
£ùÜsize_b™s
);

3645 
	`¥š_uÆock
(&
fs_šfo
->
bufãr_lock
);

3647 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

3650 
	`bŒfs_Ëak_debug_d–_eb
(
eb
);

3652 
	`bŒfs_»Ëa£_ex‹Á_bufãr_·ges
(
eb
);

3653 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


3654 ià(
	`uÆik–y
(
	`‹¡_b™
(
EXTENT_BUFFER_UNMAPPED
, &
eb
->
bæags
))) {

3655 
	`__ä“_ex‹Á_bufãr
(
eb
);

3659 
	`ÿÎ_rcu
(&
eb
->
rcu_h—d
, 
bŒfs_»Ëa£_ex‹Á_bufãr_rcu
);

3662 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

3665 
	}
}

3667 
	$ä“_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
)

3669 
»fs
;

3670 ià(!
eb
)

3673 
»fs
 = 
	`©omic_»ad
(&
eb
->refs);

3675 ià((!
	`‹¡_b™
(
EXTENT_BUFFER_UNMAPPED
, &
eb
->
bæags
è&& 
»fs
 <= 3)

3676 || (
	`‹¡_b™
(
EXTENT_BUFFER_UNMAPPED
, &
eb
->
bæags
) &&

3677 
»fs
 == 1))

3679 ià(
	`©omic_Œy_cmpxchg
(&
eb
->
»fs
, &refs,„efs - 1))

3683 
	`¥š_lock
(&
eb
->
»fs_lock
);

3684 ià(
	`©omic_»ad
(&
eb
->
»fs
) == 2 &&

3685 
	`‹¡_b™
(
EXTENT_BUFFER_STALE
, &
eb
->
bæags
) &&

3686 !
	`ex‹Á_bufãr_und”_io
(
eb
) &&

3687 
	`‹¡_ªd_ş—r_b™
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bæags
))

3688 
	`©omic_dec
(&
eb
->
»fs
);

3694 
	`»Ëa£_ex‹Á_bufãr
(
eb
);

3695 
	}
}

3697 
	$ä“_ex‹Á_bufãr_¡®e
(
ex‹Á_bufãr
 *
eb
)

3699 ià(!
eb
)

3702 
	`¥š_lock
(&
eb
->
»fs_lock
);

3703 
	`£t_b™
(
EXTENT_BUFFER_STALE
, &
eb
->
bæags
);

3705 ià(
	`©omic_»ad
(&
eb
->
»fs
è=ğ2 && !
	`ex‹Á_bufãr_und”_io
(eb) &&

3706 
	`‹¡_ªd_ş—r_b™
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bæags
))

3707 
	`©omic_dec
(&
eb
->
»fs
);

3708 
	`»Ëa£_ex‹Á_bufãr
(
eb
);

3709 
	}
}

3711 
	$bŒ“_ş—r_·ge_dœty
(
·ge
 *page)

3713 
	`ASSERT
(
	`PageDœty
(
·ge
));

3714 
	`ASSERT
(
	`PageLocked
(
·ge
));

3715 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

3716 
	`xa_lock_œq
(&
·ge
->
m­pšg
->
i_·ges
);

3717 ià(!
	`PageDœty
(
·ge
))

3718 
	`__xa_ş—r_m¬k
(&
·ge
->
m­pšg
->
i_·ges
,

3719 
	`·ge_šdex
(
·ge
), 
PAGECACHE_TAG_DIRTY
);

3720 
	`xa_uÆock_œq
(&
·ge
->
m­pšg
->
i_·ges
);

3721 
	}
}

3723 
	$ş—r_sub·ge_ex‹Á_bufãr_dœty
(cÚ¡ 
ex‹Á_bufãr
 *
eb
)

3725 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

3726 
·ge
 *·gğ
eb
->
·ges
[0];

3727 
boŞ
 
Ï¡
;

3730 
	`lock_·ge
(
·ge
);

3731 
Ï¡
 = 
	`bŒfs_sub·ge_ş—r_ªd_‹¡_dœty
(
fs_šfo
, 
·ge
, 
eb
->
¡¬t
,

3732 
eb
->
Ën
);

3733 ià(
Ï¡
)

3734 
	`bŒ“_ş—r_·ge_dœty
(
·ge
);

3735 
	`uÆock_·ge
(
·ge
);

3736 
	`WARN_ON
(
	`©omic_»ad
(&
eb
->
»fs
) == 0);

3737 
	}
}

3739 
	$bŒfs_ş—r_bufãr_dœty
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3740 
ex‹Á_bufãr
 *
eb
)

3742 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

3743 
i
;

3744 
num_·ges
;

3745 
·ge
 *page;

3747 
	`bŒfs_as£¹_Œ“_wr™e_locked
(
eb
);

3749 ià(
Œªs
 && 
	`bŒfs_h—d”_g’”©iÚ
(
eb
è!ğŒªs->
Œªsid
)

3752 ià(!
	`‹¡_ªd_ş—r_b™
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bæags
))

3755 
	`³rıu_couÁ”_add_b©ch
(&
fs_šfo
->
dœty_m‘ad©a_by‹s
, -
eb
->
Ën
,

3756 
fs_šfo
->
dœty_m‘ad©a_b©ch
);

3758 ià(
eb
->
fs_šfo
->
nodesize
 < 
PAGE_SIZE
)

3759  
	`ş—r_sub·ge_ex‹Á_bufãr_dœty
(
eb
);

3761 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
);

3763 
i
 = 0; i < 
num_·ges
; i++) {

3764 
·ge
 = 
eb
->
·ges
[
i
];

3765 ià(!
	`PageDœty
(
·ge
))

3767 
	`lock_·ge
(
·ge
);

3768 
	`bŒ“_ş—r_·ge_dœty
(
·ge
);

3769 
	`uÆock_·ge
(
·ge
);

3771 
	`WARN_ON
(
	`©omic_»ad
(&
eb
->
»fs
) == 0);

3772 
	}
}

3774 
	$£t_ex‹Á_bufãr_dœty
(
ex‹Á_bufãr
 *
eb
)

3776 
i
;

3777 
num_·ges
;

3778 
boŞ
 
was_dœty
;

3780 
	`check_bufãr_Œ“_»f
(
eb
);

3782 
was_dœty
 = 
	`‹¡_ªd_£t_b™
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bæags
);

3784 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
);

3785 
	`WARN_ON
(
	`©omic_»ad
(&
eb
->
»fs
) == 0);

3786 
	`WARN_ON
(!
	`‹¡_b™
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bæags
));

3788 ià(!
was_dœty
) {

3789 
boŞ
 
sub·ge
 = 
eb
->
fs_šfo
->
nodesize
 < 
PAGE_SIZE
;

3802 ià(
sub·ge
)

3803 
	`lock_·ge
(
eb
->
·ges
[0]);

3804 
i
 = 0; i < 
num_·ges
; i++)

3805 
	`bŒfs_·ge_£t_dœty
(
eb
->
fs_šfo
,ƒb->
·ges
[
i
],

3806 
eb
->
¡¬t
,ƒb->
Ën
);

3807 ià(
sub·ge
)

3808 
	`uÆock_·ge
(
eb
->
·ges
[0]);

3809 
	`³rıu_couÁ”_add_b©ch
(&
eb
->
fs_šfo
->
dœty_m‘ad©a_by‹s
,

3810 
eb
->
Ën
,

3811 
eb
->
fs_šfo
->
dœty_m‘ad©a_b©ch
);

3813 #ifdeà
CONFIG_BTRFS_DEBUG


3814 
i
 = 0; i < 
num_·ges
; i++)

3815 
	`ASSERT
(
	`PageDœty
(
eb
->
·ges
[
i
]));

3817 
	}
}

3819 
	$ş—r_ex‹Á_bufãr_u±od©e
(
ex‹Á_bufãr
 *
eb
)

3821 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

3822 
·ge
 *page;

3823 
num_·ges
;

3824 
i
;

3826 
	`ş—r_b™
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bæags
);

3827 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
);

3828 
i
 = 0; i < 
num_·ges
; i++) {

3829 
·ge
 = 
eb
->
·ges
[
i
];

3830 ià(!
·ge
)

3837 ià(
fs_šfo
->
nodesize
 >ğ
PAGE_SIZE
)

3838 
	`CË¬PageU±od©e
(
·ge
);

3840 
	`bŒfs_sub·ge_ş—r_u±od©e
(
fs_šfo
, 
·ge
, 
eb
->
¡¬t
,

3841 
eb
->
Ën
);

3843 
	}
}

3845 
	$£t_ex‹Á_bufãr_u±od©e
(
ex‹Á_bufãr
 *
eb
)

3847 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

3848 
·ge
 *page;

3849 
num_·ges
;

3850 
i
;

3852 
	`£t_b™
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bæags
);

3853 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
);

3854 
i
 = 0; i < 
num_·ges
; i++) {

3855 
·ge
 = 
eb
->
·ges
[
i
];

3861 ià(
fs_šfo
->
nodesize
 >ğ
PAGE_SIZE
)

3862 
	`S‘PageU±od©e
(
·ge
);

3864 
	`bŒfs_sub·ge_£t_u±od©e
(
fs_šfo
, 
·ge
, 
eb
->
¡¬t
,

3865 
eb
->
Ën
);

3867 
	}
}

3869 
	$ex‹Á_bufãr_»ad_’d_io
(
bŒfs_bio
 *
bbio
)

3871 
ex‹Á_bufãr
 *
eb
 = 
bbio
->
´iv©e
;

3872 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

3873 
boŞ
 
u±od©e
 = !
bbio
->
bio
.
bi_¡©us
;

3874 
bvec_™”_®l
 
™”_®l
;

3875 
bio_vec
 *
bvec
;

3876 
u32
 
bio_off£t
 = 0;

3878 
eb
->
»ad_mœrÜ
 = 
bbio
->
mœrÜ_num
;

3880 ià(
u±od©e
 &&

3881 
	`bŒfs_v®id©e_ex‹Á_bufãr
(
eb
, &
bbio
->
·»Á_check
) < 0)

3882 
u±od©e
 = 
çl£
;

3884 ià(
u±od©e
) {

3885 
	`£t_ex‹Á_bufãr_u±od©e
(
eb
);

3887 
	`ş—r_ex‹Á_bufãr_u±od©e
(
eb
);

3888 
	`£t_b™
(
EXTENT_BUFFER_READ_ERR
, &
eb
->
bæags
);

3891 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, &
bbio
->
bio
, 
™”_®l
) {

3892 
u64
 
¡¬t
 = 
eb
->¡¬ˆ+ 
bio_off£t
;

3893 
·ge
 *·gğ
bvec
->
bv_·ge
;

3894 
u32
 
Ën
 = 
bvec
->
bv_Ën
;

3896 ià(
u±od©e
)

3897 
	`bŒfs_·ge_£t_u±od©e
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

3899 
	`bŒfs_·ge_ş—r_u±od©e
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

3901 
bio_off£t
 +ğ
Ën
;

3904 
	`ş—r_b™
(
EXTENT_BUFFER_READING
, &
eb
->
bæags
);

3905 
	`smp_mb__aá”_©omic
();

3906 
	`wake_up_b™
(&
eb
->
bæags
, 
EXTENT_BUFFER_READING
);

3907 
	`ä“_ex‹Á_bufãr
(
eb
);

3909 
	`bio_put
(&
bbio
->
bio
);

3910 
	}
}

3912 
	$»ad_ex‹Á_bufãr_·ges
(
ex‹Á_bufãr
 *
eb
, 
wa™
, 
mœrÜ_num
,

3913 
bŒfs_Œ“_·»Á_check
 *
check
)

3915 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
), 
i
;

3916 
bŒfs_bio
 *
bbio
;

3918 ià(
	`‹¡_b™
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bæags
))

3926 ià(
	`uÆik–y
(
	`‹¡_b™
(
EXTENT_BUFFER_WRITE_ERR
, &
eb
->
bæags
)))

3927  -
EIO
;

3930 ià(
	`‹¡_ªd_£t_b™
(
EXTENT_BUFFER_READING
, &
eb
->
bæags
))

3931 
dÚe
;

3933 
	`ş—r_b™
(
EXTENT_BUFFER_READ_ERR
, &
eb
->
bæags
);

3934 
eb
->
»ad_mœrÜ
 = 0;

3935 
	`check_bufãr_Œ“_»f
(
eb
);

3936 
	`©omic_šc
(&
eb
->
»fs
);

3938 
bbio
 = 
	`bŒfs_bio_®loc
(
INLINE_EXTENT_BUFFER_PAGES
,

3939 
REQ_OP_READ
 | 
REQ_META
, 
eb
->
fs_šfo
,

3940 
ex‹Á_bufãr_»ad_’d_io
, 
eb
);

3941 
bbio
->
bio
.
bi_™”
.
bi_£ùÜ
 = 
eb
->
¡¬t
 >> 
SECTOR_SHIFT
;

3942 
bbio
->
šode
 = 
	`BTRFS_I
(
eb
->
fs_šfo
->
bŒ“_šode
);

3943 
bbio
->
fe_off£t
 = 
eb
->
¡¬t
;

3944 
	`memıy
(&
bbio
->
·»Á_check
, 
check
, (*check));

3945 ià(
eb
->
fs_šfo
->
nodesize
 < 
PAGE_SIZE
) {

3946 
	`__bio_add_·ge
(&
bbio
->
bio
, 
eb
->
·ges
[0],ƒb->
Ën
,

3947 
eb
->
¡¬t
 - 
	`·ge_off£t
Ób->
·ges
[0]));

3949 
i
 = 0; i < 
num_·ges
; i++)

3950 
	`__bio_add_·ge
(&
bbio
->
bio
, 
eb
->
·ges
[
i
], 
PAGE_SIZE
, 0);

3952 
	`bŒfs_subm™_bio
(
bbio
, 
mœrÜ_num
);

3954 
dÚe
:

3955 ià(
wa™
 =ğ
WAIT_COMPLETE
) {

3956 
	`wa™_Ú_b™_io
(&
eb
->
bæags
, 
EXTENT_BUFFER_READING
, 
TASK_UNINTERRUPTIBLE
);

3957 ià(!
	`‹¡_b™
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bæags
))

3958  -
EIO
;

3962 
	}
}

3964 
boŞ
 
	$»pÜt_eb_¿nge
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
¡¬t
,

3965 
Ën
)

3967 
	`bŒfs_w¬n
(
eb
->
fs_šfo
,

3969 
eb
->
¡¬t
,ƒb->
Ën
, start,†en);

3970 
	`WARN_ON
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
));

3972  
Œue
;

3973 
	}
}

3982 
šlše
 
	$check_eb_¿nge
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

3983 
¡¬t
, 
Ën
)

3985 
off£t
;

3988 ià(
	`uÆik–y
(
	`check_add_ov”æow
(
¡¬t
, 
Ën
, &
off£t
è|| off£ˆ> 
eb
->len))

3989  
	`»pÜt_eb_¿nge
(
eb
, 
¡¬t
, 
Ën
);

3991  
çl£
;

3992 
	}
}

3994 
	$»ad_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, *
d¡v
,

3995 
¡¬t
, 
Ën
)

3997 
size_t
 
cur
;

3998 
size_t
 
off£t
;

3999 
·ge
 *page;

4000 *
kaddr
;

4001 *
d¡
 = (*)
d¡v
;

4002 
i
 = 
	`g‘_eb_·ge_šdex
(
¡¬t
);

4004 ià(
	`check_eb_¿nge
(
eb
, 
¡¬t
, 
Ën
)) {

4009 
	`mem£t
(
d¡v
, 0, 
Ën
);

4013 
off£t
 = 
	`g‘_eb_off£t_š_·ge
(
eb
, 
¡¬t
);

4015 
Ën
 > 0) {

4016 
·ge
 = 
eb
->
·ges
[
i
];

4018 
cur
 = 
	`mš
(
Ën
, (
PAGE_SIZE
 - 
off£t
));

4019 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

4020 
	`memıy
(
d¡
, 
kaddr
 + 
off£t
, 
cur
);

4022 
d¡
 +ğ
cur
;

4023 
Ën
 -ğ
cur
;

4024 
off£t
 = 0;

4025 
i
++;

4027 
	}
}

4029 
	$»ad_ex‹Á_bufãr_to_u£r_noçuÉ
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

4030 
__u£r
 *
d¡v
,

4031 
¡¬t
, 
Ën
)

4033 
size_t
 
cur
;

4034 
size_t
 
off£t
;

4035 
·ge
 *page;

4036 *
kaddr
;

4037 
__u£r
 *
d¡
 = (__u£¸*)
d¡v
;

4038 
i
 = 
	`g‘_eb_·ge_šdex
(
¡¬t
);

4039 
»t
 = 0;

4041 
	`WARN_ON
(
¡¬t
 > 
eb
->
Ën
);

4042 
	`WARN_ON
(
¡¬t
 + 
Ën
 > 
eb
->start +ƒb->len);

4044 
off£t
 = 
	`g‘_eb_off£t_š_·ge
(
eb
, 
¡¬t
);

4046 
Ën
 > 0) {

4047 
·ge
 = 
eb
->
·ges
[
i
];

4049 
cur
 = 
	`mš
(
Ën
, (
PAGE_SIZE
 - 
off£t
));

4050 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

4051 ià(
	`cİy_to_u£r_noçuÉ
(
d¡
, 
kaddr
 + 
off£t
, 
cur
)) {

4052 
»t
 = -
EFAULT
;

4056 
d¡
 +ğ
cur
;

4057 
Ën
 -ğ
cur
;

4058 
off£t
 = 0;

4059 
i
++;

4062  
»t
;

4063 
	}
}

4065 
	$memcmp_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, cÚ¡ *
±rv
,

4066 
¡¬t
, 
Ën
)

4068 
size_t
 
cur
;

4069 
size_t
 
off£t
;

4070 
·ge
 *page;

4071 *
kaddr
;

4072 *
±r
 = (*)
±rv
;

4073 
i
 = 
	`g‘_eb_·ge_šdex
(
¡¬t
);

4074 
»t
 = 0;

4076 ià(
	`check_eb_¿nge
(
eb
, 
¡¬t
, 
Ën
))

4077  -
EINVAL
;

4079 
off£t
 = 
	`g‘_eb_off£t_š_·ge
(
eb
, 
¡¬t
);

4081 
Ën
 > 0) {

4082 
·ge
 = 
eb
->
·ges
[
i
];

4084 
cur
 = 
	`mš
(
Ën
, (
PAGE_SIZE
 - 
off£t
));

4086 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

4087 
»t
 = 
	`memcmp
(
±r
, 
kaddr
 + 
off£t
, 
cur
);

4088 ià(
»t
)

4091 
±r
 +ğ
cur
;

4092 
Ën
 -ğ
cur
;

4093 
off£t
 = 0;

4094 
i
++;

4096  
»t
;

4097 
	}
}

4105 
	$as£¹_eb_·ge_u±od©e
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

4106 
·ge
 *page)

4108 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

4118 ià(
	`‹¡_b™
(
EXTENT_BUFFER_WRITE_ERR
, &
eb
->
bæags
))

4121 ià(
fs_šfo
->
nodesize
 < 
PAGE_SIZE
) {

4122 ià(
	`WARN_ON
(!
	`bŒfs_sub·ge_‹¡_u±od©e
(
fs_šfo
, 
·ge
,

4123 
eb
->
¡¬t
,ƒb->
Ën
)))

4124 
	`bŒfs_sub·ge_dump_b™m­
(
fs_šfo
, 
·ge
, 
eb
->
¡¬t
,ƒb->
Ën
);

4126 
	`WARN_ON
(!
	`PageU±od©e
(
·ge
));

4128 
	}
}

4130 
	$__wr™e_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

4131 cÚ¡ *
¤cv
, 
¡¬t
,

4132 
Ën
, 
boŞ
 
u£_memmove
)

4134 
size_t
 
cur
;

4135 
size_t
 
off£t
;

4136 
·ge
 *page;

4137 *
kaddr
;

4138 *
¤c
 = (*)
¤cv
;

4139 
i
 = 
	`g‘_eb_·ge_šdex
(
¡¬t
);

4141 cÚ¡ 
boŞ
 
check_u±od©e
 = !
	`‹¡_b™
(
EXTENT_BUFFER_UNMAPPED
, &
eb
->
bæags
);

4143 
	`WARN_ON
(
	`‹¡_b™
(
EXTENT_BUFFER_NO_CHECK
, &
eb
->
bæags
));

4145 ià(
	`check_eb_¿nge
(
eb
, 
¡¬t
, 
Ën
))

4148 
off£t
 = 
	`g‘_eb_off£t_š_·ge
(
eb
, 
¡¬t
);

4150 
Ën
 > 0) {

4151 
·ge
 = 
eb
->
·ges
[
i
];

4152 ià(
check_u±od©e
)

4153 
	`as£¹_eb_·ge_u±od©e
(
eb
, 
·ge
);

4155 
cur
 = 
	`mš
(
Ën
, 
PAGE_SIZE
 - 
off£t
);

4156 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

4157 ià(
u£_memmove
)

4158 
	`memmove
(
kaddr
 + 
off£t
, 
¤c
, 
cur
);

4160 
	`memıy
(
kaddr
 + 
off£t
, 
¤c
, 
cur
);

4162 
¤c
 +ğ
cur
;

4163 
Ën
 -ğ
cur
;

4164 
off£t
 = 0;

4165 
i
++;

4167 
	}
}

4169 
	$wr™e_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, cÚ¡ *
¤cv
,

4170 
¡¬t
, 
Ën
)

4172  
	`__wr™e_ex‹Á_bufãr
(
eb
, 
¤cv
, 
¡¬t
, 
Ën
, 
çl£
);

4173 
	}
}

4175 
	$mem£t_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
c
,

4176 
¡¬t
, 
Ën
)

4178 
cur
 = 
¡¬t
;

4180 
cur
 < 
¡¬t
 + 
Ën
) {

4181 
šdex
 = 
	`g‘_eb_·ge_šdex
(
cur
);

4182 
off£t
 = 
	`g‘_eb_off£t_š_·ge
(
eb
, 
cur
);

4183 
cur_Ën
 = 
	`mš
(
¡¬t
 + 
Ën
 - 
cur
, 
PAGE_SIZE
 - 
off£t
);

4184 
·ge
 *·gğ
eb
->
·ges
[
šdex
];

4186 
	`as£¹_eb_·ge_u±od©e
(
eb
, 
·ge
);

4187 
	`mem£t
(
	`·ge_add»ss
(
·ge
è+ 
off£t
, 
c
, 
cur_Ën
);

4189 
cur
 +ğ
cur_Ën
;

4191 
	}
}

4193 
	$memz”o_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
¡¬t
,

4194 
Ën
)

4196 ià(
	`check_eb_¿nge
(
eb
, 
¡¬t
, 
Ën
))

4198  
	`mem£t_ex‹Á_bufãr
(
eb
, 0, 
¡¬t
, 
Ën
);

4199 
	}
}

4201 
	$cİy_ex‹Á_bufãr_fuÎ
(cÚ¡ 
ex‹Á_bufãr
 *
d¡
,

4202 cÚ¡ 
ex‹Á_bufãr
 *
¤c
)

4204 
cur
 = 0;

4206 
	`ASSERT
(
d¡
->
Ën
 =ğ
¤c
->len);

4208 
cur
 < 
¤c
->
Ën
) {

4209 
šdex
 = 
	`g‘_eb_·ge_šdex
(
cur
);

4210 
off£t
 = 
	`g‘_eb_off£t_š_·ge
(
¤c
, 
cur
);

4211 
cur_Ën
 = 
	`mš
(
¤c
->
Ën
, 
PAGE_SIZE
 - 
off£t
);

4212 *
addr
 = 
	`·ge_add»ss
(
¤c
->
·ges
[
šdex
]è+ 
off£t
;

4214 
	`wr™e_ex‹Á_bufãr
(
d¡
, 
addr
, 
cur
, 
cur_Ën
);

4216 
cur
 +ğ
cur_Ën
;

4218 
	}
}

4220 
	$cİy_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
d¡
,

4221 cÚ¡ 
ex‹Á_bufãr
 *
¤c
,

4222 
d¡_off£t
, 
¤c_off£t
,

4223 
Ën
)

4225 
u64
 
d¡_Ën
 = 
d¡
->
Ën
;

4226 
size_t
 
cur
;

4227 
size_t
 
off£t
;

4228 
·ge
 *page;

4229 *
kaddr
;

4230 
i
 = 
	`g‘_eb_·ge_šdex
(
d¡_off£t
);

4232 ià(
	`check_eb_¿nge
(
d¡
, 
d¡_off£t
, 
Ën
) ||

4233 
	`check_eb_¿nge
(
¤c
, 
¤c_off£t
, 
Ën
))

4236 
	`WARN_ON
(
¤c
->
Ën
 !ğ
d¡_Ën
);

4238 
off£t
 = 
	`g‘_eb_off£t_š_·ge
(
d¡
, 
d¡_off£t
);

4240 
Ën
 > 0) {

4241 
·ge
 = 
d¡
->
·ges
[
i
];

4242 
	`as£¹_eb_·ge_u±od©e
(
d¡
, 
·ge
);

4244 
cur
 = 
	`mš
(
Ën
, ()(
PAGE_SIZE
 - 
off£t
));

4246 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

4247 
	`»ad_ex‹Á_bufãr
(
¤c
, 
kaddr
 + 
off£t
, 
¤c_off£t
, 
cur
);

4249 
¤c_off£t
 +ğ
cur
;

4250 
Ën
 -ğ
cur
;

4251 
off£t
 = 0;

4252 
i
++;

4254 
	}
}

4269 
šlše
 
	$eb_b™m­_off£t
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

4270 
¡¬t
, 
Ä
,

4271 *
·ge_šdex
,

4272 
size_t
 *
·ge_off£t
)

4274 
size_t
 
by‹_off£t
 = 
	`BIT_BYTE
(
Ä
);

4275 
size_t
 
off£t
;

4282 
off£t
 = 
¡¬t
 + 
	`off£t_š_·ge
(
eb
->¡¬tè+ 
by‹_off£t
;

4284 *
·ge_šdex
 = 
off£t
 >> 
PAGE_SHIFT
;

4285 *
·ge_off£t
 = 
	`off£t_š_·ge
(
off£t
);

4286 
	}
}

4295 
	$ex‹Á_bufãr_‹¡_b™
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
¡¬t
,

4296 
Ä
)

4298 
u8
 *
kaddr
;

4299 
·ge
 *page;

4300 
i
;

4301 
size_t
 
off£t
;

4303 
	`eb_b™m­_off£t
(
eb
, 
¡¬t
, 
Ä
, &
i
, &
off£t
);

4304 
·ge
 = 
eb
->
·ges
[
i
];

4305 
	`as£¹_eb_·ge_u±od©e
(
eb
, 
·ge
);

4306 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

4307  1U & (
kaddr
[
off£t
] >> (
Ä
 & (
BITS_PER_BYTE
 - 1)));

4308 
	}
}

4310 
u8
 *
	$ex‹Á_bufãr_g‘_by‹
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
by‹Ä
)

4312 
šdex
 = 
	`g‘_eb_·ge_šdex
(
by‹Ä
);

4314 ià(
	`check_eb_¿nge
(
eb
, 
by‹Ä
, 1))

4315  
NULL
;

4316  
	`·ge_add»ss
(
eb
->
·ges
[
šdex
]è+ 
	`g‘_eb_off£t_š_·ge
Ób, 
by‹Ä
);

4317 
	}
}

4327 
	$ex‹Á_bufãr_b™m­_£t
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
¡¬t
,

4328 
pos
, 
Ën
)

4330 
fœ¡_by‹
 = 
¡¬t
 + 
	`BIT_BYTE
(
pos
);

4331 
Ï¡_by‹
 = 
¡¬t
 + 
	`BIT_BYTE
(
pos
 + 
Ën
 - 1);

4332 cÚ¡ 
boŞ
 
§me_by‹
 = (
fœ¡_by‹
 =ğ
Ï¡_by‹
);

4333 
u8
 
mask
 = 
	`BITMAP_FIRST_BYTE_MASK
(
pos
);

4334 
u8
 *
kaddr
;

4336 ià(
§me_by‹
)

4337 
mask
 &ğ
	`BITMAP_LAST_BYTE_MASK
(
pos
 + 
Ën
);

4340 
kaddr
 = 
	`ex‹Á_bufãr_g‘_by‹
(
eb
, 
fœ¡_by‹
);

4341 *
kaddr
 |ğ
mask
;

4342 ià(
§me_by‹
)

4346 
	`ASSERT
(
fœ¡_by‹
 + 1 <ğ
Ï¡_by‹
);

4347 
	`mem£t_ex‹Á_bufãr
(
eb
, 0xff, 
fœ¡_by‹
 + 1, 
Ï¡_by‹
 - first_byte - 1);

4350 
kaddr
 = 
	`ex‹Á_bufãr_g‘_by‹
(
eb
, 
Ï¡_by‹
);

4351 *
kaddr
 |ğ
	`BITMAP_LAST_BYTE_MASK
(
pos
 + 
Ën
);

4352 
	}
}

4363 
	$ex‹Á_bufãr_b™m­_ş—r
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

4364 
¡¬t
, 
pos
,

4365 
Ën
)

4367 
fœ¡_by‹
 = 
¡¬t
 + 
	`BIT_BYTE
(
pos
);

4368 
Ï¡_by‹
 = 
¡¬t
 + 
	`BIT_BYTE
(
pos
 + 
Ën
 - 1);

4369 cÚ¡ 
boŞ
 
§me_by‹
 = (
fœ¡_by‹
 =ğ
Ï¡_by‹
);

4370 
u8
 
mask
 = 
	`BITMAP_FIRST_BYTE_MASK
(
pos
);

4371 
u8
 *
kaddr
;

4373 ià(
§me_by‹
)

4374 
mask
 &ğ
	`BITMAP_LAST_BYTE_MASK
(
pos
 + 
Ën
);

4377 
kaddr
 = 
	`ex‹Á_bufãr_g‘_by‹
(
eb
, 
fœ¡_by‹
);

4378 *
kaddr
 &ğ~
mask
;

4379 ià(
§me_by‹
)

4383 
	`ASSERT
(
fœ¡_by‹
 + 1 <ğ
Ï¡_by‹
);

4384 
	`mem£t_ex‹Á_bufãr
(
eb
, 0, 
fœ¡_by‹
 + 1, 
Ï¡_by‹
 - first_byte - 1);

4387 
kaddr
 = 
	`ex‹Á_bufãr_g‘_by‹
(
eb
, 
Ï¡_by‹
);

4388 *
kaddr
 &ğ~
	`BITMAP_LAST_BYTE_MASK
(
pos
 + 
Ën
);

4389 
	}
}

4391 
šlše
 
boŞ
 
	$¬—s_ov”Ïp
(
¤c
, 
d¡
, 
Ën
)

4393 
di¡ªû
 = (
¤c
 > 
d¡
) ? src - dst : dst - src;

4394  
di¡ªû
 < 
Ën
;

4395 
	}
}

4397 
	$memıy_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
d¡
,

4398 
d¡_off£t
, 
¤c_off£t
,

4399 
Ën
)

4401 
cur_off
 = 0;

4403 ià(
	`check_eb_¿nge
(
d¡
, 
d¡_off£t
, 
Ën
) ||

4404 
	`check_eb_¿nge
(
d¡
, 
¤c_off£t
, 
Ën
))

4407 
cur_off
 < 
Ën
) {

4408 
cur_¤c
 = 
cur_off
 + 
¤c_off£t
;

4409 
pg_šdex
 = 
	`g‘_eb_·ge_šdex
(
cur_¤c
);

4410 
pg_off
 = 
	`g‘_eb_off£t_š_·ge
(
d¡
, 
cur_¤c
);

4411 
cur_Ën
 = 
	`mš
(
¤c_off£t
 + 
Ën
 - 
cur_¤c
,

4412 
PAGE_SIZE
 - 
pg_off
);

4413 *
¤c_addr
 = 
	`·ge_add»ss
(
d¡
->
·ges
[
pg_šdex
]è+ 
pg_off
;

4414 cÚ¡ 
boŞ
 
u£_memmove
 = 
	`¬—s_ov”Ïp
(
¤c_off£t
 + 
cur_off
,

4415 
d¡_off£t
 + 
cur_off
, 
cur_Ën
);

4417 
	`__wr™e_ex‹Á_bufãr
(
d¡
, 
¤c_addr
, 
d¡_off£t
 + 
cur_off
, 
cur_Ën
,

4418 
u£_memmove
);

4419 
cur_off
 +ğ
cur_Ën
;

4421 
	}
}

4423 
	$memmove_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
d¡
,

4424 
d¡_off£t
, 
¤c_off£t
,

4425 
Ën
)

4427 
d¡_’d
 = 
d¡_off£t
 + 
Ën
 - 1;

4428 
¤c_’d
 = 
¤c_off£t
 + 
Ën
 - 1;

4430 ià(
	`check_eb_¿nge
(
d¡
, 
d¡_off£t
, 
Ën
) ||

4431 
	`check_eb_¿nge
(
d¡
, 
¤c_off£t
, 
Ën
))

4434 ià(
d¡_off£t
 < 
¤c_off£t
) {

4435 
	`memıy_ex‹Á_bufãr
(
d¡
, 
d¡_off£t
, 
¤c_off£t
, 
Ën
);

4439 
Ën
 > 0) {

4440 
¤c_i
;

4441 
size_t
 
cur
;

4442 
size_t
 
d¡_off_š_·ge
;

4443 
size_t
 
¤c_off_š_·ge
;

4444 *
¤c_addr
;

4445 
boŞ
 
u£_memmove
;

4447 
¤c_i
 = 
	`g‘_eb_·ge_šdex
(
¤c_’d
);

4449 
d¡_off_š_·ge
 = 
	`g‘_eb_off£t_š_·ge
(
d¡
, 
d¡_’d
);

4450 
¤c_off_š_·ge
 = 
	`g‘_eb_off£t_š_·ge
(
d¡
, 
¤c_’d
);

4452 
cur
 = 
	`mš_t
(, 
Ën
, 
¤c_off_š_·ge
 + 1);

4453 
cur
 = 
	`mš
(cur, 
d¡_off_š_·ge
 + 1);

4455 
¤c_addr
 = 
	`·ge_add»ss
(
d¡
->
·ges
[
¤c_i
]è+ 
¤c_off_š_·ge
 -

4456 
cur
 + 1;

4457 
u£_memmove
 = 
	`¬—s_ov”Ïp
(
¤c_’d
 - 
cur
 + 1, 
d¡_’d
 - cur + 1,

4458 
cur
);

4460 
	`__wr™e_ex‹Á_bufãr
(
d¡
, 
¤c_addr
, 
d¡_’d
 - 
cur
 + 1, cur,

4461 
u£_memmove
);

4463 
d¡_’d
 -ğ
cur
;

4464 
¤c_’d
 -ğ
cur
;

4465 
Ën
 -ğ
cur
;

4467 
	}
}

4469 
	#GANG_LOOKUP_SIZE
 16

	)

4470 
ex‹Á_bufãr
 *
	$g‘_Ãxt_ex‹Á_bufãr
(

4471 
bŒfs_fs_šfo
 *
fs_šfo
, 
·ge
 *·ge, 
u64
 
by‹Ä
)

4473 
ex‹Á_bufãr
 *
gªg
[
GANG_LOOKUP_SIZE
];

4474 
ex‹Á_bufãr
 *
found
 = 
NULL
;

4475 
u64
 
·ge_¡¬t
 = 
	`·ge_off£t
(
·ge
);

4476 
u64
 
cur
 = 
·ge_¡¬t
;

4478 
	`ASSERT
(
	`š_¿nge
(
by‹Ä
, 
·ge_¡¬t
, 
PAGE_SIZE
));

4479 
	`lockd•_as£¹_h–d
(&
fs_šfo
->
bufãr_lock
);

4481 
cur
 < 
·ge_¡¬t
 + 
PAGE_SIZE
) {

4482 
»t
;

4483 
i
;

4485 
»t
 = 
	`¿dix_Œ“_gªg_lookup
(&
fs_šfo
->
bufãr_¿dix
,

4486 (**)
gªg
, 
cur
 >> 
fs_šfo
->
£ùÜsize_b™s
,

4487 
	`mš_t
(, 
GANG_LOOKUP_SIZE
,

4488 
PAGE_SIZE
 / 
fs_šfo
->
nodesize
));

4489 ià(
»t
 == 0)

4490 
out
;

4491 
i
 = 0; i < 
»t
; i++) {

4493 ià(
gªg
[
i
]->
¡¬t
 >ğ
·ge_¡¬t
 + 
PAGE_SIZE
)

4494 
out
;

4496 ià(
gªg
[
i
]->
¡¬t
 >ğ
by‹Ä
) {

4497 
found
 = 
gªg
[
i
];

4498 
out
;

4501 
cur
 = 
gªg
[
»t
 - 1]->
¡¬t
 + gªg[»ˆ- 1]->
Ën
;

4503 
out
:

4504  
found
;

4505 
	}
}

4507 
	$Œy_»Ëa£_sub·ge_ex‹Á_bufãr
(
·ge
 *page)

4509 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
·ge
->
m­pšg
->
ho¡
->
i_sb
);

4510 
u64
 
cur
 = 
	`·ge_off£t
(
·ge
);

4511 cÚ¡ 
u64
 
’d
 = 
	`·ge_off£t
(
·ge
è+ 
PAGE_SIZE
;

4512 
»t
;

4514 
cur
 < 
’d
) {

4515 
ex‹Á_bufãr
 *
eb
 = 
NULL
;

4525 
	`¥š_lock
(&
fs_šfo
->
bufãr_lock
);

4526 
eb
 = 
	`g‘_Ãxt_ex‹Á_bufãr
(
fs_šfo
, 
·ge
, 
cur
);

4527 ià(!
eb
) {

4529 
	`¥š_uÆock
(&
fs_šfo
->
bufãr_lock
);

4532 
cur
 = 
eb
->
¡¬t
 +ƒb->
Ën
;

4538 
	`¥š_lock
(&
eb
->
»fs_lock
);

4539 ià(
	`©omic_»ad
(&
eb
->
»fs
è!ğ1 || 
	`ex‹Á_bufãr_und”_io
(eb)) {

4540 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

4541 
	`¥š_uÆock
(&
fs_šfo
->
bufãr_lock
);

4544 
	`¥š_uÆock
(&
fs_šfo
->
bufãr_lock
);

4551 ià(!
	`‹¡_ªd_ş—r_b™
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bæags
)) {

4552 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

4561 
	`»Ëa£_ex‹Á_bufãr
(
eb
);

4567 
	`¥š_lock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

4568 ià(!
	`PagePriv©e
(
·ge
))

4569 
»t
 = 1;

4571 
»t
 = 0;

4572 
	`¥š_uÆock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

4573  
»t
;

4575 
	}
}

4577 
	$Œy_»Ëa£_ex‹Á_bufãr
(
·ge
 *page)

4579 
ex‹Á_bufãr
 *
eb
;

4581 ià(
	`bŒfs_sb
(
·ge
->
m­pšg
->
ho¡
->
i_sb
)->
nodesize
 < 
PAGE_SIZE
)

4582  
	`Œy_»Ëa£_sub·ge_ex‹Á_bufãr
(
·ge
);

4588 
	`¥š_lock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

4589 ià(!
	`PagePriv©e
(
·ge
)) {

4590 
	`¥š_uÆock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

4594 
eb
 = (
ex‹Á_bufãr
 *)
·ge
->
´iv©e
;

4595 
	`BUG_ON
(!
eb
);

4602 
	`¥š_lock
(&
eb
->
»fs_lock
);

4603 ià(
	`©omic_»ad
(&
eb
->
»fs
è!ğ1 || 
	`ex‹Á_bufãr_und”_io
(eb)) {

4604 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

4605 
	`¥š_uÆock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

4608 
	`¥š_uÆock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

4614 ià(!
	`‹¡_ªd_ş—r_b™
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bæags
)) {

4615 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

4619  
	`»Ëa£_ex‹Á_bufãr
(
eb
);

4620 
	}
}

4634 
	$bŒfs_»adah—d_Œ“_block
(
bŒfs_fs_šfo
 *
fs_šfo
,

4635 
u64
 
by‹Ä
, u64 
owÃr_roÙ
, u64 
g’
, 
Ëv–
)

4637 
bŒfs_Œ“_·»Á_check
 
check
 = {

4638 .
has_fœ¡_key
 = 0,

4639 .
Ëv–
 =†evel,

4640 .
Œªsid
 = 
g’


4642 
ex‹Á_bufãr
 *
eb
;

4643 
»t
;

4645 
eb
 = 
	`bŒfs_fšd_ü—‹_Œ“_block
(
fs_šfo
, 
by‹Ä
, 
owÃr_roÙ
, 
Ëv–
);

4646 ià(
	`IS_ERR
(
eb
))

4649 ià(
	`bŒfs_bufãr_u±od©e
(
eb
, 
g’
, 1)) {

4650 
	`ä“_ex‹Á_bufãr
(
eb
);

4654 
»t
 = 
	`»ad_ex‹Á_bufãr_·ges
(
eb
, 
WAIT_NONE
, 0, &
check
);

4655 ià(
»t
 < 0)

4656 
	`ä“_ex‹Á_bufãr_¡®e
(
eb
);

4658 
	`ä“_ex‹Á_bufãr
(
eb
);

4659 
	}
}

4669 
	$bŒfs_»adah—d_node_chd
(
ex‹Á_bufãr
 *
node
, 
¦Ù
)

4671 
	`bŒfs_»adah—d_Œ“_block
(
node
->
fs_šfo
,

4672 
	`bŒfs_node_block±r
(
node
, 
¦Ù
),

4673 
	`bŒfs_h—d”_owÃr
(
node
),

4674 
	`bŒfs_node_±r_g’”©iÚ
(
node
, 
¦Ù
),

4675 
	`bŒfs_h—d”_Ëv–
(
node
) - 1);

4676 
	}
}

	@extent_io.h

3 #iâdeà
BTRFS_EXTENT_IO_H


4 
	#BTRFS_EXTENT_IO_H


	)

6 
	~<lšux/rbŒ“.h
>

7 
	~<lšux/»fcouÁ.h
>

8 
	~<lšux/f›m­.h
>

9 
	~<lšux/bŒfs_Œ“.h
>

10 
	~"com´essiÚ.h
"

11 
	~"uli¡.h
"

12 
	~"misc.h
"

14 
	gbŒfs_Œªs_hªdË
;

17 
	mEXTENT_BUFFER_UPTODATE
,

18 
	mEXTENT_BUFFER_DIRTY
,

19 
	mEXTENT_BUFFER_CORRUPT
,

21 
	mEXTENT_BUFFER_READAHEAD
,

22 
	mEXTENT_BUFFER_TREE_REF
,

23 
	mEXTENT_BUFFER_STALE
,

24 
	mEXTENT_BUFFER_WRITEBACK
,

26 
	mEXTENT_BUFFER_READ_ERR
,

27 
	mEXTENT_BUFFER_UNMAPPED
,

28 
	mEXTENT_BUFFER_IN_TREE
,

30 
	mEXTENT_BUFFER_WRITE_ERR
,

31 
	mEXTENT_BUFFER_NO_CHECK
,

33 
	mEXTENT_BUFFER_READING
,

38 
ENUM_BIT
(
PAGE_UNLOCK
),

40 
ENUM_BIT
(
PAGE_START_WRITEBACK
),

41 
ENUM_BIT
(
PAGE_END_WRITEBACK
),

42 
ENUM_BIT
(
PAGE_SET_ORDERED
),

49 
	#EXTENT_PAGE_PRIVATE
 1

	)

58 
	#BIT_BYTE
(
Ä
è(Òrè/ 
BITS_PER_BYTE
)

	)

59 
	#BYTE_MASK
 ((1 << 
BITS_PER_BYTE
è- 1)

	)

60 
	#BITMAP_FIRST_BYTE_MASK
(
¡¬t
) \

61 ((
BYTE_MASK
 << ((
¡¬t
è& (
BITS_PER_BYTE
 - 1))è& BYTE_MASK)

	)

62 
	#BITMAP_LAST_BYTE_MASK
(
nb™s
) \

63 (
BYTE_MASK
 >> (-(
nb™s
è& (
BITS_PER_BYTE
 - 1)))

	)

65 
	gbŒfs_roÙ
;

66 
	gbŒfs_šode
;

67 
	gbŒfs_fs_šfo
;

68 
	gex‹Á_io_Œ“
;

69 
	gbŒfs_Œ“_·»Á_check
;

71 
__š™
 
ex‹Á_bufãr_š™_ÿch•
();

72 
__cŞd
 
ex‹Á_bufãr_ä“_ÿch•
();

74 
	#INLINE_EXTENT_BUFFER_PAGES
 (
BTRFS_MAX_METADATA_BLOCKSIZE
 / 
PAGE_SIZE
)

	)

75 
	sex‹Á_bufãr
 {

76 
u64
 
	m¡¬t
;

77 
	mËn
;

78 
	mbæags
;

79 
bŒfs_fs_šfo
 *
	mfs_šfo
;

80 
¥šlock_t
 
	m»fs_lock
;

81 
©omic_t
 
	m»fs
;

82 
	m»ad_mœrÜ
;

83 
rcu_h—d
 
	mrcu_h—d
;

84 
pid_t
 
	mlock_owÃr
;

86 
s8
 
	mlog_šdex
;

88 
rw_£m­hÜe
 
	mlock
;

90 
·ge
 *
	m·ges
[
INLINE_EXTENT_BUFFER_PAGES
];

91 #ifdeà
CONFIG_BTRFS_DEBUG


92 
li¡_h—d
 
	mËak_li¡
;

96 
	sbŒfs_eb_wr™e_cÚ‹xt
 {

97 
wr™eback_cÚŒŞ
 *
	mwbc
;

98 
ex‹Á_bufãr
 *
	meb
;

100 
bŒfs_block_group
 *
	mzÚed_bg
;

111 
šlše
 
size_t
 
	$g‘_eb_off£t_š_·ge
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

112 
off£t
)

121  
	`off£t_š_·ge
(
off£t
 + 
eb
->
¡¬t
);

122 
	}
}

124 
šlše
 
	$g‘_eb_·ge_šdex
(
off£t
)

133  
off£t
 >> 
PAGE_SHIFT
;

134 
	}
}

139 
	sex‹Á_chªge£t
 {

141 
u64
 
	mby‹s_chªged
;

144 
uli¡
 
	m¿nge_chªged
;

147 
šlše
 
	$ex‹Á_chªge£t_š™
(
ex‹Á_chªge£t
 *
chªge£t
)

149 
chªge£t
->
by‹s_chªged
 = 0;

150 
	`uli¡_š™
(&
chªge£t
->
¿nge_chªged
);

151 
	}
}

153 
šlše
 
ex‹Á_chªge£t
 *
	$ex‹Á_chªge£t_®loc
()

155 
ex‹Á_chªge£t
 *
»t
;

157 
»t
 = 
	`km®loc
((*»t), 
GFP_KERNEL
);

158 ià(!
»t
)

159  
NULL
;

161 
	`ex‹Á_chªge£t_š™
(
»t
);

162  
»t
;

163 
	}
}

165 
šlše
 
	$ex‹Á_chªge£t_»Ëa£
(
ex‹Á_chªge£t
 *
chªge£t
)

167 ià(!
chªge£t
)

169 
chªge£t
->
by‹s_chªged
 = 0;

170 
	`uli¡_»Ëa£
(&
chªge£t
->
¿nge_chªged
);

171 
	}
}

173 
šlše
 
	$ex‹Á_chªge£t_ä“
(
ex‹Á_chªge£t
 *
chªge£t
)

175 ià(!
chªge£t
)

177 
	`ex‹Á_chªge£t_»Ëa£
(
chªge£t
);

178 
	`kä“
(
chªge£t
);

179 
	}
}

181 
	gex‹Á_m­_Œ“
;

183 
Œy_»Ëa£_ex‹Á_m­pšg
(
·ge
 *·ge, 
gå_t
 
mask
);

184 
Œy_»Ëa£_ex‹Á_bufãr
(
·ge
 *page);

186 
bŒfs_»ad_fŞio
(
fe
 *fe, 
fŞio
 *folio);

187 
ex‹Á_wr™e_locked_¿nge
(
šode
 *šode, 
·ge
 *
locked_·ge
,

188 
u64
 
¡¬t
, u64 
’d
, 
wr™eback_cÚŒŞ
 *
wbc
,

189 
boŞ
 
·ges_dœty
);

190 
ex‹Á_wr™•ages
(
add»ss_¥aû
 *
m­pšg
,

191 
wr™eback_cÚŒŞ
 *
wbc
);

192 
bŒ“_wr™e_ÿche_·ges
(
add»ss_¥aû
 *
m­pšg
,

193 
wr™eback_cÚŒŞ
 *
wbc
);

194 
ex‹Á_»adah—d
(
»adah—d_cÚŒŞ
 *
¿c
);

195 
ex‹Á_f›m­
(
bŒfs_šode
 *
šode
, 
f›m­_ex‹Á_šfo
 *
f›šfo
,

196 
u64
 
¡¬t
, u64 
Ën
);

197 
£t_·ge_ex‹Á_m­³d
(
·ge
 *page);

198 
ş—r_·ge_ex‹Á_m­³d
(
·ge
 *page);

200 
ex‹Á_bufãr
 *
®loc_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

201 
u64
 
¡¬t
, u64 
owÃr_roÙ
, 
Ëv–
);

202 
ex‹Á_bufãr
 *
__®loc_dummy_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

203 
u64
 
¡¬t
, 
Ën
);

204 
ex‹Á_bufãr
 *
®loc_dummy_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

205 
u64
 
¡¬t
);

206 
ex‹Á_bufãr
 *
bŒfs_şÚe_ex‹Á_bufãr
(cÚ¡ ex‹Á_bufã¸*
¤c
);

207 
ex‹Á_bufãr
 *
fšd_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

208 
u64
 
¡¬t
);

209 
ä“_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
);

210 
ä“_ex‹Á_bufãr_¡®e
(
ex‹Á_bufãr
 *
eb
);

211 
	#WAIT_NONE
 0

	)

212 
	#WAIT_COMPLETE
 1

	)

213 
	#WAIT_PAGE_LOCK
 2

	)

214 
»ad_ex‹Á_bufãr_·ges
(
ex‹Á_bufãr
 *
eb
, 
wa™
, 
mœrÜ_num
,

215 
bŒfs_Œ“_·»Á_check
 *
·»Á_check
);

216 
wa™_Ú_ex‹Á_bufãr_wr™eback
(
ex‹Á_bufãr
 *
eb
);

217 
bŒfs_»adah—d_Œ“_block
(
bŒfs_fs_šfo
 *
fs_šfo
,

218 
u64
 
by‹Ä
, u64 
owÃr_roÙ
, u64 
g’
, 
Ëv–
);

219 
bŒfs_»adah—d_node_chd
(
ex‹Á_bufãr
 *
node
, 
¦Ù
);

221 
šlše
 
	$num_ex‹Á_·ges
(cÚ¡ 
ex‹Á_bufãr
 *
eb
)

230  (
eb
->
Ën
 >> 
PAGE_SHIFT
) ?: 1;

231 
	}
}

233 
šlše
 
	$ex‹Á_bufãr_u±od©e
(cÚ¡ 
ex‹Á_bufãr
 *
eb
)

235  
	`‹¡_b™
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bæags
);

236 
	}
}

238 
memcmp_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, cÚ¡ *
±rv
,

239 
¡¬t
, 
Ën
);

240 
»ad_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, *
d¡
,

241 
¡¬t
,

242 
Ën
);

243 
»ad_ex‹Á_bufãr_to_u£r_noçuÉ
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

244 
__u£r
 *
d¡
, 
¡¬t
,

245 
Ën
);

246 
wr™e_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, cÚ¡ *
¤c
,

247 
¡¬t
, 
Ën
);

249 
šlše
 
	$wr™e_ex‹Á_bufãr_chunk_Œ“_uuid
(

250 cÚ¡ 
ex‹Á_bufãr
 *
eb
, cÚ¡ *
chunk_Œ“_uuid
)

252 
	`wr™e_ex‹Á_bufãr
(
eb
, 
chunk_Œ“_uuid
,

253 
	`off£tof
(
bŒfs_h—d”
, 
chunk_Œ“_uuid
),

254 
BTRFS_FSID_SIZE
);

255 
	}
}

257 
šlše
 
	$wr™e_ex‹Á_bufãr_fsid
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

258 cÚ¡ *
fsid
)

260 
	`wr™e_ex‹Á_bufãr
(
eb
, 
fsid
, 
	`off£tof
(
bŒfs_h—d”
, fsid),

261 
BTRFS_FSID_SIZE
);

262 
	}
}

264 
cİy_ex‹Á_bufãr_fuÎ
(cÚ¡ 
ex‹Á_bufãr
 *
d¡
,

265 cÚ¡ 
ex‹Á_bufãr
 *
¤c
);

266 
cİy_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
d¡
,

267 cÚ¡ 
ex‹Á_bufãr
 *
¤c
,

268 
d¡_off£t
, 
¤c_off£t
,

269 
Ën
);

270 
memıy_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
d¡
,

271 
d¡_off£t
, 
¤c_off£t
,

272 
Ën
);

273 
memmove_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
d¡
,

274 
d¡_off£t
, 
¤c_off£t
,

275 
Ën
);

276 
memz”o_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
¡¬t
,

277 
Ën
);

278 
ex‹Á_bufãr_‹¡_b™
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
¡¬t
,

279 
pos
);

280 
ex‹Á_bufãr_b™m­_£t
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
¡¬t
,

281 
pos
, 
Ën
);

282 
ex‹Á_bufãr_b™m­_ş—r
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

283 
¡¬t
, 
pos
,

284 
Ën
);

285 
£t_ex‹Á_bufãr_dœty
(
ex‹Á_bufãr
 *
eb
);

286 
£t_ex‹Á_bufãr_u±od©e
(
ex‹Á_bufãr
 *
eb
);

287 
ş—r_ex‹Á_bufãr_u±od©e
(
ex‹Á_bufãr
 *
eb
);

288 
ex‹Á_¿nge_ş—r_dœty_fÜ_io
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
);

289 
ex‹Á_ş—r_uÆock_d–®loc
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
,

290 
·ge
 *
locked_·ge
,

291 
u32
 
b™s_to_ş—r
, 
·ge_İs
);

292 
ex‹Á_šv®id©e_fŞio
(
ex‹Á_io_Œ“
 *
Œ“
,

293 
fŞio
 *fŞio, 
size_t
 
off£t
);

294 
bŒfs_ş—r_bufãr_dœty
(
bŒfs_Œªs_hªdË
 *
Œªs
,

295 
ex‹Á_bufãr
 *
buf
);

297 
bŒfs_®loc_·ge_¬¿y
(
Ä_·ges
, 
·ge
 **
·ge_¬¿y
);

299 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


300 
boŞ
 
fšd_lock_d–®loc_¿nge
(
šode
 *inode,

301 
·ge
 *
locked_·ge
, 
u64
 *
¡¬t
,

302 
u64
 *
’d
);

304 
ex‹Á_bufãr
 *
®loc_‹¡_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

305 
u64
 
¡¬t
);

307 #ifdeà
CONFIG_BTRFS_DEBUG


308 
bŒfs_ex‹Á_bufãr_Ëak_debug_check
(
bŒfs_fs_šfo
 *
fs_šfo
);

310 
	#bŒfs_ex‹Á_bufãr_Ëak_debug_check
(
fs_šfo
èdØ{} 0)

	)

	@extent_map.c

3 
	~<lšux/”r.h
>

4 
	~<lšux/¦ab.h
>

5 
	~<lšux/¥šlock.h
>

6 
	~"mes§ges.h
"

7 
	~"ù»e.h
"

8 
	~"vŞumes.h
"

9 
	~"ex‹Á_m­.h
"

10 
	~"com´essiÚ.h
"

11 
	~"bŒfs_šode.h
"

14 
kmem_ÿche
 *
	gex‹Á_m­_ÿche
;

16 
__š™
 
	$ex‹Á_m­_š™
()

18 
ex‹Á_m­_ÿche
 = 
	`kmem_ÿche_ü—‹
("btrfs_extent_map",

19 (
ex‹Á_m­
), 0,

20 
SLAB_MEM_SPREAD
, 
NULL
);

21 ià(!
ex‹Á_m­_ÿche
)

22  -
ENOMEM
;

24 
	}
}

26 
__cŞd
 
	$ex‹Á_m­_ex™
()

28 
	`kmem_ÿche_de¡roy
(
ex‹Á_m­_ÿche
);

29 
	}
}

35 
	$ex‹Á_m­_Œ“_š™
(
ex‹Á_m­_Œ“
 *
Œ“
)

37 
Œ“
->
m­
 = 
RB_ROOT_CACHED
;

38 
	`INIT_LIST_HEAD
(&
Œ“
->
modif›d_ex‹Ás
);

39 
	`rwlock_š™
(&
Œ“
->
lock
);

40 
	}
}

46 
ex‹Á_m­
 *
	$®loc_ex‹Á_m­
()

48 
ex‹Á_m­
 *
em
;

49 
em
 = 
	`kmem_ÿche_z®loc
(
ex‹Á_m­_ÿche
, 
GFP_NOFS
);

50 ià(!
em
)

51  
NULL
;

52 
	`RB_CLEAR_NODE
(&
em
->
rb_node
);

53 
em
->
com´ess_ty³
 = 
BTRFS_COMPRESS_NONE
;

54 
	`»fcouÁ_£t
(&
em
->
»fs
, 1);

55 
	`INIT_LIST_HEAD
(&
em
->
li¡
);

56  
em
;

57 
	}
}

63 
	$ä“_ex‹Á_m­
(
ex‹Á_m­
 *
em
)

65 ià(!
em
)

67 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
em
->
»fs
)) {

68 
	`WARN_ON
(
	`ex‹Á_m­_š_Œ“
(
em
));

69 
	`WARN_ON
(!
	`li¡_em±y
(&
em
->
li¡
));

70 ià(
	`‹¡_b™
(
EXTENT_FLAG_FS_MAPPING
, &
em
->
æags
))

71 
	`kä“
(
em
->
m­_lookup
);

72 
	`kmem_ÿche_ä“
(
ex‹Á_m­_ÿche
, 
em
);

74 
	}
}

77 
u64
 
	$¿nge_’d
(
u64
 
¡¬t
, u64 
Ën
)

79 ià(
¡¬t
 + 
Ën
 < start)

80  (
u64
)-1;

81  
¡¬t
 + 
Ën
;

82 
	}
}

84 
	$Œ“_š£¹
(
rb_roÙ_ÿched
 *
roÙ
, 
ex‹Á_m­
 *
em
)

86 
rb_node
 **
p
 = &
roÙ
->
rb_roÙ
.rb_node;

87 
rb_node
 *
·»Á
 = 
NULL
;

88 
ex‹Á_m­
 *
’Œy
 = 
NULL
;

89 
rb_node
 *
Üig_·»Á
 = 
NULL
;

90 
u64
 
’d
 = 
	`¿nge_’d
(
em
->
¡¬t
,ƒm->
Ën
);

91 
boŞ
 
Ëámo¡
 = 
Œue
;

93 *
p
) {

94 
·»Á
 = *
p
;

95 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
ex‹Á_m­
, 
rb_node
);

97 ià(
em
->
¡¬t
 < 
’Œy
->start) {

98 
p
 = &(*p)->
rb_Ëá
;

99 } ià(
em
->
¡¬t
 >ğ
	`ex‹Á_m­_’d
(
’Œy
)) {

100 
p
 = &(*p)->
rb_right
;

101 
Ëámo¡
 = 
çl£
;

103  -
EEXIST
;

107 
Üig_·»Á
 = 
·»Á
;

108 
·»Á
 && 
em
->
¡¬t
 >ğ
	`ex‹Á_m­_’d
(
’Œy
)) {

109 
·»Á
 = 
	`rb_Ãxt
(parent);

110 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
ex‹Á_m­
, 
rb_node
);

112 ià(
·»Á
)

113 ià(
’d
 > 
’Œy
->
¡¬t
 && 
em
->¡¬ˆ< 
	`ex‹Á_m­_’d
(entry))

114  -
EEXIST
;

116 
·»Á
 = 
Üig_·»Á
;

117 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
ex‹Á_m­
, 
rb_node
);

118 
·»Á
 && 
em
->
¡¬t
 < 
’Œy
->start) {

119 
·»Á
 = 
	`rb_´ev
(parent);

120 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
ex‹Á_m­
, 
rb_node
);

122 ià(
·»Á
)

123 ià(
’d
 > 
’Œy
->
¡¬t
 && 
em
->¡¬ˆ< 
	`ex‹Á_m­_’d
(entry))

124  -
EEXIST
;

126 
	`rb_lšk_node
(&
em
->
rb_node
, 
Üig_·»Á
, 
p
);

127 
	`rb_š£¹_cŞÜ_ÿched
(&
em
->
rb_node
, 
roÙ
, 
Ëámo¡
);

129 
	}
}

135 
rb_node
 *
	$__Œ“_£¬ch
(
rb_roÙ
 *
roÙ
, 
u64
 
off£t
,

136 
rb_node
 **
´ev_Ü_Ãxt_»t
)

138 
rb_node
 *
n
 = 
roÙ
->rb_node;

139 
rb_node
 *
´ev
 = 
NULL
;

140 
rb_node
 *
Üig_´ev
 = 
NULL
;

141 
ex‹Á_m­
 *
’Œy
;

142 
ex‹Á_m­
 *
´ev_’Œy
 = 
NULL
;

144 
	`ASSERT
(
´ev_Ü_Ãxt_»t
);

146 
n
) {

147 
’Œy
 = 
	`rb_’Œy
(
n
, 
ex‹Á_m­
, 
rb_node
);

148 
´ev
 = 
n
;

149 
´ev_’Œy
 = 
’Œy
;

151 ià(
off£t
 < 
’Œy
->
¡¬t
)

152 
n
 =‚->
rb_Ëá
;

153 ià(
off£t
 >ğ
	`ex‹Á_m­_’d
(
’Œy
))

154 
n
 =‚->
rb_right
;

156  
n
;

159 
Üig_´ev
 = 
´ev
;

160 
´ev
 && 
off£t
 >ğ
	`ex‹Á_m­_’d
(
´ev_’Œy
)) {

161 
´ev
 = 
	`rb_Ãxt
(prev);

162 
´ev_’Œy
 = 
	`rb_’Œy
(
´ev
, 
ex‹Á_m­
, 
rb_node
);

169 ià(
´ev
) {

170 *
´ev_Ü_Ãxt_»t
 = 
´ev
;

171  
NULL
;

174 
´ev
 = 
Üig_´ev
;

175 
´ev_’Œy
 = 
	`rb_’Œy
(
´ev
, 
ex‹Á_m­
, 
rb_node
);

176 
´ev
 && 
off£t
 < 
´ev_’Œy
->
¡¬t
) {

177 
´ev
 = 
	`rb_´ev
(prev);

178 
´ev_’Œy
 = 
	`rb_’Œy
(
´ev
, 
ex‹Á_m­
, 
rb_node
);

180 *
´ev_Ü_Ãxt_»t
 = 
´ev
;

182  
NULL
;

183 
	}
}

186 
	$m”gabË_m­s
(
ex‹Á_m­
 *
´ev
, ex‹Á_m­ *
Ãxt
)

188 ià(
	`‹¡_b™
(
EXTENT_FLAG_PINNED
, &
´ev
->
æags
))

195 ià(
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
´ev
->
æags
))

198 ià(
	`‹¡_b™
(
EXTENT_FLAG_LOGGING
, &
´ev
->
æags
) ||

199 
	`‹¡_b™
(
EXTENT_FLAG_LOGGING
, &
Ãxt
->
æags
))

207 ià(!
	`li¡_em±y
(&
´ev
->
li¡
è|| !li¡_em±y(&
Ãxt
->list))

210 
	`ASSERT
(
Ãxt
->
block_¡¬t
 !ğ
EXTENT_MAP_DELALLOC
 &&

211 
´ev
->
block_¡¬t
 !ğ
EXTENT_MAP_DELALLOC
);

213 ià(
´ev
->
m­_lookup
 || 
Ãxt
->map_lookup)

214 
	`ASSERT
(
	`‹¡_b™
(
EXTENT_FLAG_FS_MAPPING
, &
´ev
->
æags
) &&

215 
	`‹¡_b™
(
EXTENT_FLAG_FS_MAPPING
, &
Ãxt
->
æags
));

217 ià(
	`ex‹Á_m­_’d
(
´ev
è=ğ
Ãxt
->
¡¬t
 &&

218 
´ev
->
æags
 =ğ
Ãxt
->flags &&

219 
´ev
->
m­_lookup
 =ğ
Ãxt
->map_lookup &&

220 ((
Ãxt
->
block_¡¬t
 =ğ
EXTENT_MAP_HOLE
 &&

221 
´ev
->
block_¡¬t
 =ğ
EXTENT_MAP_HOLE
) ||

222 (
Ãxt
->
block_¡¬t
 =ğ
EXTENT_MAP_INLINE
 &&

223 
´ev
->
block_¡¬t
 =ğ
EXTENT_MAP_INLINE
) ||

224 (
Ãxt
->
block_¡¬t
 < 
EXTENT_MAP_LAST_BYTE
 - 1 &&

225 
Ãxt
->
block_¡¬t
 =ğ
	`ex‹Á_m­_block_’d
(
´ev
)))) {

229 
	}
}

231 
	$Œy_m”ge_m­
(
ex‹Á_m­_Œ“
 *
Œ“
, 
ex‹Á_m­
 *
em
)

233 
ex‹Á_m­
 *
m”ge
 = 
NULL
;

234 
rb_node
 *
rb
;

244 ià(
	`»fcouÁ_»ad
(&
em
->
»fs
) > 2)

247 ià(
em
->
¡¬t
 != 0) {

248 
rb
 = 
	`rb_´ev
(&
em
->
rb_node
);

249 ià(
rb
)

250 
m”ge
 = 
	`rb_’Œy
(
rb
, 
ex‹Á_m­
, 
rb_node
);

251 ià(
rb
 && 
	`m”gabË_m­s
(
m”ge
, 
em
)) {

252 
em
->
¡¬t
 = 
m”ge
->start;

253 
em
->
Üig_¡¬t
 = 
m”ge
->orig_start;

254 
em
->
Ën
 +ğ
m”ge
->len;

255 
em
->
block_Ën
 +ğ
m”ge
->block_len;

256 
em
->
block_¡¬t
 = 
m”ge
->block_start;

257 
em
->
mod_Ën
 = (em->mod_ËÀ+ƒm->
mod_¡¬t
è- 
m”ge
->mod_start;

258 
em
->
mod_¡¬t
 = 
m”ge
->mod_start;

259 
em
->
g’”©iÚ
 = 
	`max
Óm->g’”©iÚ, 
m”ge
->generation);

260 
	`£t_b™
(
EXTENT_FLAG_MERGED
, &
em
->
æags
);

262 
	`rb_”a£_ÿched
(&
m”ge
->
rb_node
, &
Œ“
->
m­
);

263 
	`RB_CLEAR_NODE
(&
m”ge
->
rb_node
);

264 
	`ä“_ex‹Á_m­
(
m”ge
);

268 
rb
 = 
	`rb_Ãxt
(&
em
->
rb_node
);

269 ià(
rb
)

270 
m”ge
 = 
	`rb_’Œy
(
rb
, 
ex‹Á_m­
, 
rb_node
);

271 ià(
rb
 && 
	`m”gabË_m­s
(
em
, 
m”ge
)) {

272 
em
->
Ën
 +ğ
m”ge
->len;

273 
em
->
block_Ën
 +ğ
m”ge
->block_len;

274 
	`rb_”a£_ÿched
(&
m”ge
->
rb_node
, &
Œ“
->
m­
);

275 
	`RB_CLEAR_NODE
(&
m”ge
->
rb_node
);

276 
em
->
mod_Ën
 = (
m”ge
->
mod_¡¬t
 + merge->mod_len) -ƒm->mod_start;

277 
em
->
g’”©iÚ
 = 
	`max
Óm->g’”©iÚ, 
m”ge
->generation);

278 
	`£t_b™
(
EXTENT_FLAG_MERGED
, &
em
->
æags
);

279 
	`ä“_ex‹Á_m­
(
m”ge
);

281 
	}
}

295 
	$uÅš_ex‹Á_ÿche
(
ex‹Á_m­_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
Ën
,

296 
u64
 
g’
)

298 
»t
 = 0;

299 
ex‹Á_m­
 *
em
;

300 
boŞ
 
´—Îoc
 = 
çl£
;

302 
	`wr™e_lock
(&
Œ“
->
lock
);

303 
em
 = 
	`lookup_ex‹Á_m­pšg
(
Œ“
, 
¡¬t
, 
Ën
);

305 
	`WARN_ON
(!
em
 ||ƒm->
¡¬t
 != start);

307 ià(!
em
)

308 
out
;

310 
em
->
g’”©iÚ
 = 
g’
;

311 
	`ş—r_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
);

312 
em
->
mod_¡¬t
 =ƒm->
¡¬t
;

313 
em
->
mod_Ën
 =ƒm->
Ën
;

315 ià(
	`‹¡_b™
(
EXTENT_FLAG_FILLING
, &
em
->
æags
)) {

316 
´—Îoc
 = 
Œue
;

317 
	`ş—r_b™
(
EXTENT_FLAG_FILLING
, &
em
->
æags
);

320 
	`Œy_m”ge_m­
(
Œ“
, 
em
);

322 ià(
´—Îoc
) {

323 
em
->
mod_¡¬t
 =ƒm->
¡¬t
;

324 
em
->
mod_Ën
 =ƒm->
Ën
;

327 
	`ä“_ex‹Á_m­
(
em
);

328 
out
:

329 
	`wr™e_uÆock
(&
Œ“
->
lock
);

330  
»t
;

332 
	}
}

334 
	$ş—r_em_loggšg
(
ex‹Á_m­_Œ“
 *
Œ“
, 
ex‹Á_m­
 *
em
)

336 
	`lockd•_as£¹_h–d_wr™e
(&
Œ“
->
lock
);

338 
	`ş—r_b™
(
EXTENT_FLAG_LOGGING
, &
em
->
æags
);

339 ià(
	`ex‹Á_m­_š_Œ“
(
em
))

340 
	`Œy_m”ge_m­
(
Œ“
, 
em
);

341 
	}
}

343 
šlše
 
	$£tup_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

344 
ex‹Á_m­
 *
em
,

345 
modif›d
)

347 
	`»fcouÁ_šc
(&
em
->
»fs
);

348 
em
->
mod_¡¬t
 =ƒm->
¡¬t
;

349 
em
->
mod_Ën
 =ƒm->
Ën
;

351 ià(
modif›d
)

352 
	`li¡_move
(&
em
->
li¡
, &
Œ“
->
modif›d_ex‹Ás
);

354 
	`Œy_m”ge_m­
(
Œ“
, 
em
);

355 
	}
}

357 
	$ex‹Á_m­_deviû_£t_b™s
(
ex‹Á_m­
 *
em
, 
b™s
)

359 
m­_lookup
 *
m­
 = 
em
->map_lookup;

360 
u64
 
¡re_size
 = 
em
->
Üig_block_Ën
;

361 
i
;

363 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

364 
bŒfs_io_¡re
 *
¡re
 = &
m­
->
¡res
[
i
];

365 
bŒfs_deviû
 *
deviû
 = 
¡re
->
dev
;

367 
	`£t_ex‹Á_b™
(&
deviû
->
®loc_¡©e
, 
¡re
->
physiÿl
,

368 
¡re
->
physiÿl
 + 
¡re_size
 - 1,

369 
b™s
 | 
EXTENT_NOWAIT
, 
NULL
);

371 
	}
}

373 
	$ex‹Á_m­_deviû_ş—r_b™s
(
ex‹Á_m­
 *
em
, 
b™s
)

375 
m­_lookup
 *
m­
 = 
em
->map_lookup;

376 
u64
 
¡re_size
 = 
em
->
Üig_block_Ën
;

377 
i
;

379 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

380 
bŒfs_io_¡re
 *
¡re
 = &
m­
->
¡res
[
i
];

381 
bŒfs_deviû
 *
deviû
 = 
¡re
->
dev
;

383 
	`__ş—r_ex‹Á_b™
(&
deviû
->
®loc_¡©e
, 
¡re
->
physiÿl
,

384 
¡re
->
physiÿl
 + 
¡re_size
 - 1,

385 
b™s
 | 
EXTENT_NOWAIT
,

386 
NULL
, NULL);

388 
	}
}

403 
	$add_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

404 
ex‹Á_m­
 *
em
, 
modif›d
)

406 
»t
 = 0;

408 
	`lockd•_as£¹_h–d_wr™e
(&
Œ“
->
lock
);

410 
»t
 = 
	`Œ“_š£¹
(&
Œ“
->
m­
, 
em
);

411 ià(
»t
)

412 
out
;

414 
	`£tup_ex‹Á_m­pšg
(
Œ“
, 
em
, 
modif›d
);

415 ià(
	`‹¡_b™
(
EXTENT_FLAG_FS_MAPPING
, &
em
->
æags
)) {

416 
	`ex‹Á_m­_deviû_£t_b™s
(
em
, 
CHUNK_ALLOCATED
);

417 
	`ex‹Á_m­_deviû_ş—r_b™s
(
em
, 
CHUNK_TRIMMED
);

419 
out
:

420  
»t
;

421 
	}
}

423 
ex‹Á_m­
 *

424 
	$__lookup_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

425 
u64
 
¡¬t
, u64 
Ën
, 
¡riù
)

427 
ex‹Á_m­
 *
em
;

428 
rb_node
 *rb_node;

429 
rb_node
 *
´ev_Ü_Ãxt
 = 
NULL
;

430 
u64
 
’d
 = 
	`¿nge_’d
(
¡¬t
, 
Ën
);

432 
rb_node
 = 
	`__Œ“_£¬ch
(&
Œ“
->
m­
.
rb_roÙ
, 
¡¬t
, &
´ev_Ü_Ãxt
);

433 ià(!
rb_node
) {

434 ià(
´ev_Ü_Ãxt
)

435 
rb_node
 = 
´ev_Ü_Ãxt
;

437  
NULL
;

440 
em
 = 
	`rb_’Œy
(
rb_node
, 
ex‹Á_m­
,„b_node);

442 ià(
¡riù
 && !(
’d
 > 
em
->
¡¬t
 && s¹ < 
	`ex‹Á_m­_’d
(em)))

443  
NULL
;

445 
	`»fcouÁ_šc
(&
em
->
»fs
);

446  
em
;

447 
	}
}

461 
ex‹Á_m­
 *
	$lookup_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

462 
u64
 
¡¬t
, u64 
Ën
)

464  
	`__lookup_ex‹Á_m­pšg
(
Œ“
, 
¡¬t
, 
Ën
, 1);

465 
	}
}

479 
ex‹Á_m­
 *
	$£¬ch_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

480 
u64
 
¡¬t
, u64 
Ën
)

482  
	`__lookup_ex‹Á_m­pšg
(
Œ“
, 
¡¬t
, 
Ën
, 0);

483 
	}
}

494 
	$»move_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
, 
ex‹Á_m­
 *
em
)

496 
	`lockd•_as£¹_h–d_wr™e
(&
Œ“
->
lock
);

498 
	`WARN_ON
(
	`‹¡_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
));

499 
	`rb_”a£_ÿched
(&
em
->
rb_node
, &
Œ“
->
m­
);

500 ià(!
	`‹¡_b™
(
EXTENT_FLAG_LOGGING
, &
em
->
æags
))

501 
	`li¡_d–_š™
(&
em
->
li¡
);

502 ià(
	`‹¡_b™
(
EXTENT_FLAG_FS_MAPPING
, &
em
->
æags
))

503 
	`ex‹Á_m­_deviû_ş—r_b™s
(
em
, 
CHUNK_ALLOCATED
);

504 
	`RB_CLEAR_NODE
(&
em
->
rb_node
);

505 
	}
}

507 
	$»¶aû_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

508 
ex‹Á_m­
 *
cur
,

509 
ex‹Á_m­
 *
Ãw
,

510 
modif›d
)

512 
	`lockd•_as£¹_h–d_wr™e
(&
Œ“
->
lock
);

514 
	`WARN_ON
(
	`‹¡_b™
(
EXTENT_FLAG_PINNED
, &
cur
->
æags
));

515 
	`ASSERT
(
	`ex‹Á_m­_š_Œ“
(
cur
));

516 ià(!
	`‹¡_b™
(
EXTENT_FLAG_LOGGING
, &
cur
->
æags
))

517 
	`li¡_d–_š™
(&
cur
->
li¡
);

518 
	`rb_»¶aû_node_ÿched
(&
cur
->
rb_node
, &
Ãw
->rb_node, &
Œ“
->
m­
);

519 
	`RB_CLEAR_NODE
(&
cur
->
rb_node
);

521 
	`£tup_ex‹Á_m­pšg
(
Œ“
, 
Ãw
, 
modif›d
);

522 
	}
}

524 
ex‹Á_m­
 *
	$Ãxt_ex‹Á_m­
(cÚ¡ 
ex‹Á_m­
 *
em
)

526 
rb_node
 *
Ãxt
;

528 
Ãxt
 = 
	`rb_Ãxt
(&
em
->
rb_node
);

529 ià(!
Ãxt
)

530  
NULL
;

531  
	`cÚš”_of
(
Ãxt
, 
ex‹Á_m­
, 
rb_node
);

532 
	}
}

534 
ex‹Á_m­
 *
	$´ev_ex‹Á_m­
(
ex‹Á_m­
 *
em
)

536 
rb_node
 *
´ev
;

538 
´ev
 = 
	`rb_´ev
(&
em
->
rb_node
);

539 ià(!
´ev
)

540  
NULL
;

541  
	`cÚš”_of
(
´ev
, 
ex‹Á_m­
, 
rb_node
);

542 
	}
}

550 
nošlše
 
	$m”ge_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
em_Œ“
,

551 
ex‹Á_m­
 *
exi¡šg
,

552 
ex‹Á_m­
 *
em
,

553 
u64
 
m­_¡¬t
)

555 
ex‹Á_m­
 *
´ev
;

556 
ex‹Á_m­
 *
Ãxt
;

557 
u64
 
¡¬t
;

558 
u64
 
’d
;

559 
u64
 
¡¬t_diff
;

561 
	`BUG_ON
(
m­_¡¬t
 < 
em
->
¡¬t
 || m­_¡¬ˆ>ğ
	`ex‹Á_m­_’d
(em));

563 ià(
exi¡šg
->
¡¬t
 > 
m­_¡¬t
) {

564 
Ãxt
 = 
exi¡šg
;

565 
´ev
 = 
	`´ev_ex‹Á_m­
(
Ãxt
);

567 
´ev
 = 
exi¡šg
;

568 
Ãxt
 = 
	`Ãxt_ex‹Á_m­
(
´ev
);

571 
¡¬t
 = 
´ev
 ? 
	`ex‹Á_m­_’d
Õ»vè: 
em
->start;

572 
¡¬t
 = 
	`max_t
(
u64
, s¹, 
em
->start);

573 
’d
 = 
Ãxt
 ?‚ext->
¡¬t
 : 
	`ex‹Á_m­_’d
(
em
);

574 
’d
 = 
	`mš_t
(
u64
,ƒnd, 
	`ex‹Á_m­_’d
(
em
));

575 
¡¬t_diff
 = 
¡¬t
 - 
em
->start;

576 
em
->
¡¬t
 = start;

577 
em
->
Ën
 = 
’d
 - 
¡¬t
;

578 ià(
em
->
block_¡¬t
 < 
EXTENT_MAP_LAST_BYTE
 &&

579 !
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
)) {

580 
em
->
block_¡¬t
 +ğ
¡¬t_diff
;

581 
em
->
block_Ën
 =ƒm->
Ën
;

583  
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

584 
	}
}

607 
	$bŒfs_add_ex‹Á_m­pšg
(
bŒfs_fs_šfo
 *
fs_šfo
,

608 
ex‹Á_m­_Œ“
 *
em_Œ“
,

609 
ex‹Á_m­
 **
em_š
, 
u64
 
¡¬t
, u64 
Ën
)

611 
»t
;

612 
ex‹Á_m­
 *
em
 = *
em_š
;

618 ià(
em
->
block_¡¬t
 =ğ
EXTENT_MAP_INLINE
)

619 
	`ASSERT
(
em
->
¡¬t
 == 0);

621 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

626 ià(
»t
 =ğ-
EEXIST
) {

627 
ex‹Á_m­
 *
exi¡šg
;

629 
»t
 = 0;

631 
exi¡šg
 = 
	`£¬ch_ex‹Á_m­pšg
(
em_Œ“
, 
¡¬t
, 
Ën
);

633 
	`Œaû_bŒfs_hªdË_em_exi¡
(
fs_šfo
, 
exi¡šg
, 
em
, 
¡¬t
, 
Ën
);

639 ià(
¡¬t
 >ğ
exi¡šg
->start &&

640 
¡¬t
 < 
	`ex‹Á_m­_’d
(
exi¡šg
)) {

641 
	`ä“_ex‹Á_m­
(
em
);

642 *
em_š
 = 
exi¡šg
;

643 
»t
 = 0;

645 
u64
 
Üig_¡¬t
 = 
em
->
¡¬t
;

646 
u64
 
Üig_Ën
 = 
em
->
Ën
;

652 
»t
 = 
	`m”ge_ex‹Á_m­pšg
(
em_Œ“
, 
exi¡šg
,

653 
em
, 
¡¬t
);

654 ià(
»t
) {

655 
	`ä“_ex‹Á_m­
(
em
);

656 *
em_š
 = 
NULL
;

657 
	`WARN_ONCE
(
»t
,

659 
»t
, 
exi¡šg
->
¡¬t
,ƒxi¡šg->
Ën
,

660 
Üig_¡¬t
, 
Üig_Ën
);

662 
	`ä“_ex‹Á_m­
(
exi¡šg
);

666 
	`ASSERT
(
»t
 =ğ0 ||„‘ =ğ-
EEXIST
);

667  
»t
;

668 
	}
}

675 
	$drİ_®l_ex‹Á_m­s_ç¡
(
ex‹Á_m­_Œ“
 *
Œ“
)

677 
	`wr™e_lock
(&
Œ“
->
lock
);

678 !
	`RB_EMPTY_ROOT
(&
Œ“
->
m­
.
rb_roÙ
)) {

679 
ex‹Á_m­
 *
em
;

680 
rb_node
 *
node
;

682 
node
 = 
	`rb_fœ¡_ÿched
(&
Œ“
->
m­
);

683 
em
 = 
	`rb_’Œy
(
node
, 
ex‹Á_m­
, 
rb_node
);

684 
	`ş—r_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
);

685 
	`ş—r_b™
(
EXTENT_FLAG_LOGGING
, &
em
->
æags
);

686 
	`»move_ex‹Á_m­pšg
(
Œ“
, 
em
);

687 
	`ä“_ex‹Á_m­
(
em
);

688 
	`cÚd_»sched_rwlock_wr™e
(&
Œ“
->
lock
);

690 
	`wr™e_uÆock
(&
Œ“
->
lock
);

691 
	}
}

707 
	$bŒfs_drİ_ex‹Á_m­_¿nge
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
,

708 
boŞ
 
sk_pšÃd
)

710 
ex‹Á_m­
 *
¥l™
;

711 
ex‹Á_m­
 *
¥l™2
;

712 
ex‹Á_m­
 *
em
;

713 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
šode
->
ex‹Á_Œ“
;

714 
u64
 
Ën
 = 
’d
 - 
¡¬t
 + 1;

716 
	`WARN_ON
(
’d
 < 
¡¬t
);

717 ià(
’d
 =ğ(
u64
)-1) {

718 ià(
¡¬t
 =ğ0 && !
sk_pšÃd
) {

719 
	`drİ_®l_ex‹Á_m­s_ç¡
(
em_Œ“
);

722 
Ën
 = (
u64
)-1;

725 
’d
++;

736 
¥l™
 = 
	`®loc_ex‹Á_m­
();

737 
¥l™2
 = 
	`®loc_ex‹Á_m­
();

739 
	`wr™e_lock
(&
em_Œ“
->
lock
);

740 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
¡¬t
, 
Ën
);

742 
em
) {

744 cÚ¡ 
u64
 
em_’d
 = 
	`ex‹Á_m­_’d
(
em
);

745 
ex‹Á_m­
 *
Ãxt_em
 = 
NULL
;

746 
u64
 
g’
;

747 
æags
;

748 
boŞ
 
modif›d
;

749 
boŞ
 
com´es£d
;

751 ià(
em_’d
 < 
’d
) {

752 
Ãxt_em
 = 
	`Ãxt_ex‹Á_m­
(
em
);

753 ià(
Ãxt_em
) {

754 ià(
Ãxt_em
->
¡¬t
 < 
’d
)

755 
	`»fcouÁ_šc
(&
Ãxt_em
->
»fs
);

757 
Ãxt_em
 = 
NULL
;

761 ià(
sk_pšÃd
 && 
	`‹¡_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
)) {

762 
¡¬t
 = 
em_’d
;

763 
Ãxt
;

766 
æags
 = 
em
->flags;

767 
	`ş—r_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
);

773 
	`ş—r_b™
(
EXTENT_FLAG_LOGGING
, &
æags
);

774 
modif›d
 = !
	`li¡_em±y
(&
em
->
li¡
);

780 ià(
em
->
¡¬t
 >ğ¡¬ˆ&& 
em_’d
 <ğ
’d
)

781 
»move_em
;

783 
g’
 = 
em
->
g’”©iÚ
;

784 
com´es£d
 = 
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
);

786 ià(
em
->
¡¬t
 < start) {

787 ià(!
¥l™
) {

788 
¥l™
 = 
¥l™2
;

789 
¥l™2
 = 
NULL
;

790 ià(!
¥l™
)

791 
»move_em
;

793 
¥l™
->
¡¬t
 = 
em
->start;

794 
¥l™
->
Ën
 = 
¡¬t
 - 
em
->start;

796 ià(
em
->
block_¡¬t
 < 
EXTENT_MAP_LAST_BYTE
) {

797 
¥l™
->
Üig_¡¬t
 = 
em
->orig_start;

798 
¥l™
->
block_¡¬t
 = 
em
->block_start;

800 ià(
com´es£d
)

801 
¥l™
->
block_Ën
 = 
em
->block_len;

803 
¥l™
->
block_Ën
 = s¶™->
Ën
;

804 
¥l™
->
Üig_block_Ën
 = 
	`max
(¥l™->
block_Ën
,

805 
em
->
Üig_block_Ën
);

806 
¥l™
->
¿m_by‹s
 = 
em
->ram_bytes;

808 
¥l™
->
Üig_¡¬t
 = s¶™->
¡¬t
;

809 
¥l™
->
block_Ën
 = 0;

810 
¥l™
->
block_¡¬t
 = 
em
->block_start;

811 
¥l™
->
Üig_block_Ën
 = 0;

812 
¥l™
->
¿m_by‹s
 = s¶™->
Ën
;

815 
¥l™
->
g’”©iÚ
 = 
g’
;

816 
¥l™
->
æags
 = flags;

817 
¥l™
->
com´ess_ty³
 = 
em
->compress_type;

818 
	`»¶aû_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 
¥l™
, 
modif›d
);

819 
	`ä“_ex‹Á_m­
(
¥l™
);

820 
¥l™
 = 
¥l™2
;

821 
¥l™2
 = 
NULL
;

823 ià(
em_’d
 > 
’d
) {

824 ià(!
¥l™
) {

825 
¥l™
 = 
¥l™2
;

826 
¥l™2
 = 
NULL
;

827 ià(!
¥l™
)

828 
»move_em
;

830 
¥l™
->
¡¬t
 = 
’d
;

831 
¥l™
->
Ën
 = 
em_’d
 - 
’d
;

832 
¥l™
->
block_¡¬t
 = 
em
->block_start;

833 
¥l™
->
æags
 = flags;

834 
¥l™
->
com´ess_ty³
 = 
em
->compress_type;

835 
¥l™
->
g’”©iÚ
 = 
g’
;

837 ià(
em
->
block_¡¬t
 < 
EXTENT_MAP_LAST_BYTE
) {

838 
¥l™
->
Üig_block_Ën
 = 
	`max
(
em
->
block_Ën
,

839 
em
->
Üig_block_Ën
);

841 
¥l™
->
¿m_by‹s
 = 
em
->ram_bytes;

842 ià(
com´es£d
) {

843 
¥l™
->
block_Ën
 = 
em
->block_len;

844 
¥l™
->
Üig_¡¬t
 = 
em
->orig_start;

846 cÚ¡ 
u64
 
diff
 = 
¡¬t
 + 
Ën
 - 
em
->start;

848 
¥l™
->
block_Ën
 = s¶™->
Ën
;

849 
¥l™
->
block_¡¬t
 +ğ
diff
;

850 
¥l™
->
Üig_¡¬t
 = 
em
->orig_start;

853 
¥l™
->
¿m_by‹s
 = s¶™->
Ën
;

854 
¥l™
->
Üig_¡¬t
 = s¶™->
¡¬t
;

855 
¥l™
->
block_Ën
 = 0;

856 
¥l™
->
Üig_block_Ën
 = 0;

859 ià(
	`ex‹Á_m­_š_Œ“
(
em
)) {

860 
	`»¶aû_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 
¥l™
,

861 
modif›d
);

863 
»t
;

865 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
¥l™
,

866 
modif›d
);

868 
	`ASSERT
(
»t
 == 0);

869 ià(
	`WARN_ON
(
»t
 !ğ0è&& 
modif›d
)

870 
	`bŒfs_£t_šode_fuÎ_sync
(
šode
);

872 
	`ä“_ex‹Á_m­
(
¥l™
);

873 
¥l™
 = 
NULL
;

875 
»move_em
:

876 ià(
	`ex‹Á_m­_š_Œ“
(
em
)) {

897 ià((
em
->
¡¬t
 < s¹ || 
em_’d
 > 
’d
è&& 
modif›d
) {

898 
	`ASSERT
(!
¥l™
);

899 
	`bŒfs_£t_šode_fuÎ_sync
(
šode
);

901 
	`»move_ex‹Á_m­pšg
(
em_Œ“
, 
em
);

908 
	`ä“_ex‹Á_m­
(
em
);

909 
Ãxt
:

911 
	`ä“_ex‹Á_m­
(
em
);

913 
em
 = 
Ãxt_em
;

916 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

918 
	`ä“_ex‹Á_m­
(
¥l™
);

919 
	`ä“_ex‹Á_m­
(
¥l™2
);

920 
	}
}

935 
	$bŒfs_»¶aû_ex‹Á_m­_¿nge
(
bŒfs_šode
 *
šode
,

936 
ex‹Á_m­
 *
Ãw_em
,

937 
boŞ
 
modif›d
)

939 cÚ¡ 
u64
 
’d
 = 
Ãw_em
->
¡¬t
 +‚ew_em->
Ën
 - 1;

940 
ex‹Á_m­_Œ“
 *
Œ“
 = &
šode
->
ex‹Á_Œ“
;

941 
»t
;

943 
	`ASSERT
(!
	`ex‹Á_m­_š_Œ“
(
Ãw_em
));

954 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
šode
, 
Ãw_em
->
¡¬t
, 
’d
, 
çl£
);

955 
	`wr™e_lock
(&
Œ“
->
lock
);

956 
»t
 = 
	`add_ex‹Á_m­pšg
(
Œ“
, 
Ãw_em
, 
modif›d
);

957 
	`wr™e_uÆock
(&
Œ“
->
lock
);

958 } 
»t
 =ğ-
EEXIST
);

960  
»t
;

961 
	}
}

969 
	$¥l™_ex‹Á_m­
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
Ën
, u64 
´e
,

970 
u64
 
Ãw_logiÿl
)

972 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
šode
->
ex‹Á_Œ“
;

973 
ex‹Á_m­
 *
em
;

974 
ex‹Á_m­
 *
¥l™_´e
 = 
NULL
;

975 
ex‹Á_m­
 *
¥l™_mid
 = 
NULL
;

976 
»t
 = 0;

977 
æags
;

979 
	`ASSERT
(
´e
 != 0);

980 
	`ASSERT
(
´e
 < 
Ën
);

982 
¥l™_´e
 = 
	`®loc_ex‹Á_m­
();

983 ià(!
¥l™_´e
)

984  -
ENOMEM
;

985 
¥l™_mid
 = 
	`®loc_ex‹Á_m­
();

986 ià(!
¥l™_mid
) {

987 
»t
 = -
ENOMEM
;

988 
out_ä“_´e
;

991 
	`lock_ex‹Á
(&
šode
->
io_Œ“
, 
¡¬t
, s¹ + 
Ën
 - 1, 
NULL
);

992 
	`wr™e_lock
(&
em_Œ“
->
lock
);

993 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
¡¬t
, 
Ën
);

994 ià(!
em
) {

995 
»t
 = -
EIO
;

996 
out_uÆock
;

999 
	`ASSERT
(
em
->
Ën
 ==†en);

1000 
	`ASSERT
(!
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
));

1001 
	`ASSERT
(
em
->
block_¡¬t
 < 
EXTENT_MAP_LAST_BYTE
);

1002 
	`ASSERT
(
	`‹¡_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
));

1003 
	`ASSERT
(!
	`‹¡_b™
(
EXTENT_FLAG_LOGGING
, &
em
->
æags
));

1004 
	`ASSERT
(!
	`li¡_em±y
(&
em
->
li¡
));

1006 
æags
 = 
em
->flags;

1007 
	`ş—r_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
);

1010 
¥l™_´e
->
¡¬t
 = 
em
->start;

1011 
¥l™_´e
->
Ën
 = 
´e
;

1012 
¥l™_´e
->
Üig_¡¬t
 = s¶™_´e->
¡¬t
;

1013 
¥l™_´e
->
block_¡¬t
 = 
Ãw_logiÿl
;

1014 
¥l™_´e
->
block_Ën
 = s¶™_´e->
Ën
;

1015 
¥l™_´e
->
Üig_block_Ën
 = s¶™_´e->
block_Ën
;

1016 
¥l™_´e
->
¿m_by‹s
 = s¶™_´e->
Ën
;

1017 
¥l™_´e
->
æags
 = flags;

1018 
¥l™_´e
->
com´ess_ty³
 = 
em
->compress_type;

1019 
¥l™_´e
->
g’”©iÚ
 = 
em
->generation;

1021 
	`»¶aû_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 
¥l™_´e
, 1);

1029 
¥l™_mid
->
¡¬t
 = 
em
->¡¬ˆ+ 
´e
;

1030 
¥l™_mid
->
Ën
 = 
em
->ËÀ- 
´e
;

1031 
¥l™_mid
->
Üig_¡¬t
 = s¶™_mid->
¡¬t
;

1032 
¥l™_mid
->
block_¡¬t
 = 
em
->block_¡¬ˆ+ 
´e
;

1033 
¥l™_mid
->
block_Ën
 = s¶™_mid->
Ën
;

1034 
¥l™_mid
->
Üig_block_Ën
 = s¶™_mid->
block_Ën
;

1035 
¥l™_mid
->
¿m_by‹s
 = s¶™_mid->
Ën
;

1036 
¥l™_mid
->
æags
 = flags;

1037 
¥l™_mid
->
com´ess_ty³
 = 
em
->compress_type;

1038 
¥l™_mid
->
g’”©iÚ
 = 
em
->generation;

1039 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
¥l™_mid
, 1);

1042 
	`ä“_ex‹Á_m­
(
em
);

1044 
	`ä“_ex‹Á_m­
(
em
);

1046 
out_uÆock
:

1047 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

1048 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
¡¬t
, s¹ + 
Ën
 - 1, 
NULL
);

1049 
	`ä“_ex‹Á_m­
(
¥l™_mid
);

1050 
out_ä“_´e
:

1051 
	`ä“_ex‹Á_m­
(
¥l™_´e
);

1052  
»t
;

1053 
	}
}

	@extent_map.h

3 #iâdeà
BTRFS_EXTENT_MAP_H


4 
	#BTRFS_EXTENT_MAP_H


	)

6 
	~<lšux/rbŒ“.h
>

7 
	~<lšux/»fcouÁ.h
>

9 
	#EXTENT_MAP_LAST_BYTE
 ((
u64
)-4)

	)

10 
	#EXTENT_MAP_HOLE
 ((
u64
)-3)

	)

11 
	#EXTENT_MAP_INLINE
 ((
u64
)-2)

	)

13 
	#EXTENT_MAP_DELALLOC
 ((
u64
)-1)

	)

18 
	mEXTENT_FLAG_PINNED
,

19 
	mEXTENT_FLAG_COMPRESSED
,

21 
	mEXTENT_FLAG_PREALLOC
,

23 
	mEXTENT_FLAG_LOGGING
,

25 
	mEXTENT_FLAG_FILLING
,

27 
	mEXTENT_FLAG_FS_MAPPING
,

29 
	mEXTENT_FLAG_MERGED
,

32 
	sex‹Á_m­
 {

33 
rb_node
 
	mrb_node
;

36 
u64
 
	m¡¬t
;

37 
u64
 
	mËn
;

38 
u64
 
	mmod_¡¬t
;

39 
u64
 
	mmod_Ën
;

40 
u64
 
	mÜig_¡¬t
;

41 
u64
 
	mÜig_block_Ën
;

42 
u64
 
	m¿m_by‹s
;

43 
u64
 
	mblock_¡¬t
;

44 
u64
 
	mblock_Ën
;

51 
u64
 
	mg’”©iÚ
;

52 
	mæags
;

54 
m­_lookup
 *
	mm­_lookup
;

55 
»fcouÁ_t
 
	m»fs
;

56 
	mcom´ess_ty³
;

57 
li¡_h—d
 
	mli¡
;

60 
	sex‹Á_m­_Œ“
 {

61 
rb_roÙ_ÿched
 
	mm­
;

62 
li¡_h—d
 
	mmodif›d_ex‹Ás
;

63 
rwlock_t
 
	mlock
;

66 
	gbŒfs_šode
;

68 
šlše
 
	$ex‹Á_m­_š_Œ“
(cÚ¡ 
ex‹Á_m­
 *
em
)

70  !
	`RB_EMPTY_NODE
(&
em
->
rb_node
);

71 
	}
}

73 
šlše
 
u64
 
	$ex‹Á_m­_’d
(
ex‹Á_m­
 *
em
)

75 ià(
em
->
¡¬t
 +ƒm->
Ën
 <ƒm->start)

76  (
u64
)-1;

77  
em
->
¡¬t
 +ƒm->
Ën
;

78 
	}
}

80 
šlše
 
u64
 
	$ex‹Á_m­_block_’d
(
ex‹Á_m­
 *
em
)

82 ià(
em
->
block_¡¬t
 +ƒm->
block_Ën
 <ƒm->block_start)

83  (
u64
)-1;

84  
em
->
block_¡¬t
 +ƒm->
block_Ën
;

85 
	}
}

87 
ex‹Á_m­_Œ“_š™
(
ex‹Á_m­_Œ“
 *
Œ“
);

88 
ex‹Á_m­
 *
lookup_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

89 
u64
 
¡¬t
, u64 
Ën
);

90 
add_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

91 
ex‹Á_m­
 *
em
, 
modif›d
);

92 
»move_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
, 
ex‹Á_m­
 *
em
);

93 
¥l™_ex‹Á_m­
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
Ën
, u64 
´e
,

94 
u64
 
Ãw_logiÿl
);

96 
ex‹Á_m­
 *
®loc_ex‹Á_m­
();

97 
ä“_ex‹Á_m­
(
ex‹Á_m­
 *
em
);

98 
__š™
 
ex‹Á_m­_š™
();

99 
__cŞd
 
ex‹Á_m­_ex™
();

100 
uÅš_ex‹Á_ÿche
(
ex‹Á_m­_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
Ën
, u64 
g’
);

101 
ş—r_em_loggšg
(
ex‹Á_m­_Œ“
 *
Œ“
, 
ex‹Á_m­
 *
em
);

102 
ex‹Á_m­
 *
£¬ch_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

103 
u64
 
¡¬t
, u64 
Ën
);

104 
bŒfs_add_ex‹Á_m­pšg
(
bŒfs_fs_šfo
 *
fs_šfo
,

105 
ex‹Á_m­_Œ“
 *
em_Œ“
,

106 
ex‹Á_m­
 **
em_š
, 
u64
 
¡¬t
, u64 
Ën
);

107 
bŒfs_drİ_ex‹Á_m­_¿nge
(
bŒfs_šode
 *
šode
,

108 
u64
 
¡¬t
, u64 
’d
,

109 
boŞ
 
sk_pšÃd
);

110 
bŒfs_»¶aû_ex‹Á_m­_¿nge
(
bŒfs_šode
 *
šode
,

111 
ex‹Á_m­
 *
Ãw_em
,

112 
boŞ
 
modif›d
);

	@file-item.c

6 
	~<lšux/bio.h
>

7 
	~<lšux/¦ab.h
>

8 
	~<lšux/·gem­.h
>

9 
	~<lšux/highmem.h
>

10 
	~<lšux/sched/mm.h
>

11 
	~<üy±o/hash.h
>

12 
	~"mes§ges.h
"

13 
	~"misc.h
"

14 
	~"ù»e.h
"

15 
	~"disk-io.h
"

16 
	~"Œª§ùiÚ.h
"

17 
	~"bio.h
"

18 
	~"´št-Œ“.h
"

19 
	~"com´essiÚ.h
"

20 
	~"fs.h
"

21 
	~"acûssÜs.h
"

22 
	~"fe-™em.h
"

23 
	~"su³r.h
"

25 
	#__MAX_CSUM_ITEMS
(
r
, 
size
è(()(((
	`BTRFS_LEAF_DATA_SIZE
(r) - \

26 (
bŒfs_™em
) * 2) / \

27 
size
è- 1))

	)

29 
	#MAX_CSUM_ITEMS
(
r
, 
size
è(
	`mš_t
(
u32
, 
	`__MAX_CSUM_ITEMS
(r, size), \

30 
PAGE_SIZE
))

	)

49 
	$bŒfs_šode_§ã_disk_i_size_wr™e
(
bŒfs_šode
 *
šode
, 
u64
 
Ãw_i_size
)

51 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

52 
u64
 
¡¬t
, 
’d
, 
i_size
;

53 
»t
;

55 
	`¥š_lock
(&
šode
->
lock
);

56 
i_size
 = 
Ãw_i_size
 ?: 
	`i_size_»ad
(&
šode
->
vfs_šode
);

57 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
NO_HOLES
)) {

58 
šode
->
disk_i_size
 = 
i_size
;

59 
out_uÆock
;

62 
»t
 = 
	`fšd_cÚtiguous_ex‹Á_b™
(&
šode
->
fe_ex‹Á_Œ“
, 0, &
¡¬t
,

63 &
’d
, 
EXTENT_DIRTY
);

64 ià(!
»t
 && 
¡¬t
 == 0)

65 
i_size
 = 
	`mš
(i_size, 
’d
 + 1);

67 
i_size
 = 0;

68 
šode
->
disk_i_size
 = 
i_size
;

69 
out_uÆock
:

70 
	`¥š_uÆock
(&
šode
->
lock
);

71 
	}
}

87 
	$bŒfs_šode_£t_fe_ex‹Á_¿nge
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
,

88 
u64
 
Ën
)

90 ià(
Ën
 == 0)

93 
	`ASSERT
(
	`IS_ALIGNED
(
¡¬t
 + 
Ën
, 
šode
->
roÙ
->
fs_šfo
->
£ùÜsize
));

95 ià(
	`bŒfs_fs_šcom·t
(
šode
->
roÙ
->
fs_šfo
, 
NO_HOLES
))

97  
	`£t_ex‹Á_b™
(&
šode
->
fe_ex‹Á_Œ“
, 
¡¬t
, s¹ + 
Ën
 - 1,

98 
EXTENT_DIRTY
, 
NULL
);

99 
	}
}

115 
	$bŒfs_šode_ş—r_fe_ex‹Á_¿nge
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
,

116 
u64
 
Ën
)

118 ià(
Ën
 == 0)

121 
	`ASSERT
(
	`IS_ALIGNED
(
¡¬t
 + 
Ën
, 
šode
->
roÙ
->
fs_šfo
->
£ùÜsize
) ||

122 
Ën
 =ğ(
u64
)-1);

124 ià(
	`bŒfs_fs_šcom·t
(
šode
->
roÙ
->
fs_šfo
, 
NO_HOLES
))

126  
	`ş—r_ex‹Á_b™
(&
šode
->
fe_ex‹Á_Œ“
, 
¡¬t
,

127 
¡¬t
 + 
Ën
 - 1, 
EXTENT_DIRTY
, 
NULL
);

128 
	}
}

130 
size_t
 
	$by‹s_to_csum_size
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, 
u32
 
by‹s
)

132 
	`ASSERT
(
	`IS_ALIGNED
(
by‹s
, 
fs_šfo
->
£ùÜsize
));

134  (
by‹s
 >> 
fs_šfo
->
£ùÜsize_b™s
è* fs_šfo->
csum_size
;

135 
	}
}

137 
size_t
 
	$csum_size_to_by‹s
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, 
u32
 
csum_size
)

139 
	`ASSERT
(
	`IS_ALIGNED
(
csum_size
, 
fs_šfo
->csum_size));

141  (
csum_size
 / 
fs_šfo
->csum_sizeè<< fs_šfo->
£ùÜsize_b™s
;

142 
	}
}

144 
šlše
 
u32
 
	$max_Üd”ed_sum_by‹s
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
)

146 
u32
 
max_csum_size
 = 
	`round_down
(
PAGE_SIZE
 - (
bŒfs_Üd”ed_sum
),

147 
fs_šfo
->
csum_size
);

149  
	`csum_size_to_by‹s
(
fs_šfo
, 
max_csum_size
);

150 
	}
}

156 
	$bŒfs_Üd”ed_sum_size
(
bŒfs_fs_šfo
 *
fs_šfo
, 
by‹s
)

158  (
bŒfs_Üd”ed_sum
è+ 
	`by‹s_to_csum_size
(
fs_šfo
, 
by‹s
);

159 
	}
}

161 
	$bŒfs_š£¹_hŞe_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

162 
bŒfs_roÙ
 *
roÙ
,

163 
u64
 
objeùid
, u64 
pos
, u64 
num_by‹s
)

165 
»t
 = 0;

166 
bŒfs_fe_ex‹Á_™em
 *
™em
;

167 
bŒfs_key
 
fe_key
;

168 
bŒfs_·th
 *
·th
;

169 
ex‹Á_bufãr
 *
Ëaf
;

171 
·th
 = 
	`bŒfs_®loc_·th
();

172 ià(!
·th
)

173  -
ENOMEM
;

174 
fe_key
.
objeùid
 = objectid;

175 
fe_key
.
off£t
 = 
pos
;

176 
fe_key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

178 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
fe_key
,

179 (*
™em
));

180 ià(
»t
 < 0)

181 
out
;

182 
	`BUG_ON
(
»t
);

183 
Ëaf
 = 
·th
->
nodes
[0];

184 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

185 
bŒfs_fe_ex‹Á_™em
);

186 
	`bŒfs_£t_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
™em
, 0);

187 
	`bŒfs_£t_fe_ex‹Á_disk_num_by‹s
(
Ëaf
, 
™em
, 0);

188 
	`bŒfs_£t_fe_ex‹Á_off£t
(
Ëaf
, 
™em
, 0);

189 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
™em
, 
num_by‹s
);

190 
	`bŒfs_£t_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
™em
, 
num_by‹s
);

191 
	`bŒfs_£t_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
™em
, 
Œªs
->
Œªsid
);

192 
	`bŒfs_£t_fe_ex‹Á_ty³
(
Ëaf
, 
™em
, 
BTRFS_FILE_EXTENT_REG
);

193 
	`bŒfs_£t_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
™em
, 0);

194 
	`bŒfs_£t_fe_ex‹Á_’üy±iÚ
(
Ëaf
, 
™em
, 0);

195 
	`bŒfs_£t_fe_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
™em
, 0);

197 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

198 
out
:

199 
	`bŒfs_ä“_·th
(
·th
);

200  
»t
;

201 
	}
}

203 
bŒfs_csum_™em
 *

204 
	$bŒfs_lookup_csum
(
bŒfs_Œªs_hªdË
 *
Œªs
,

205 
bŒfs_roÙ
 *
roÙ
,

206 
bŒfs_·th
 *
·th
,

207 
u64
 
by‹Ä
, 
cow
)

209 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

210 
»t
;

211 
bŒfs_key
 
fe_key
;

212 
bŒfs_key
 
found_key
;

213 
bŒfs_csum_™em
 *
™em
;

214 
ex‹Á_bufãr
 *
Ëaf
;

215 
u64
 
csum_off£t
 = 0;

216 cÚ¡ 
u32
 
csum_size
 = 
fs_šfo
->csum_size;

217 
csums_š_™em
;

219 
fe_key
.
objeùid
 = 
BTRFS_EXTENT_CSUM_OBJECTID
;

220 
fe_key
.
off£t
 = 
by‹Ä
;

221 
fe_key
.
ty³
 = 
BTRFS_EXTENT_CSUM_KEY
;

222 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
fe_key
, 
·th
, 0, 
cow
);

223 ià(
»t
 < 0)

224 
ç
;

225 
Ëaf
 = 
·th
->
nodes
[0];

226 ià(
»t
 > 0) {

227 
»t
 = 1;

228 ià(
·th
->
¦Ùs
[0] == 0)

229 
ç
;

230 
·th
->
¦Ùs
[0]--;

231 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

232 ià(
found_key
.
ty³
 !ğ
BTRFS_EXTENT_CSUM_KEY
)

233 
ç
;

235 
csum_off£t
 = (
by‹Ä
 - 
found_key
.
off£t
) >>

236 
fs_šfo
->
£ùÜsize_b™s
;

237 
csums_š_™em
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

238 
csums_š_™em
 /ğ
csum_size
;

240 ià(
csum_off£t
 =ğ
csums_š_™em
) {

241 
»t
 = -
EFBIG
;

242 
ç
;

243 } ià(
csum_off£t
 > 
csums_š_™em
) {

244 
ç
;

247 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_csum_™em
);

248 
™em
 = (
bŒfs_csum_™em
 *)((*)item +

249 
csum_off£t
 * 
csum_size
);

250  
™em
;

251 
ç
:

252 ià(
»t
 > 0)

253 
»t
 = -
ENOENT
;

254  
	`ERR_PTR
(
»t
);

255 
	}
}

257 
	$bŒfs_lookup_fe_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

258 
bŒfs_roÙ
 *
roÙ
,

259 
bŒfs_·th
 *
·th
, 
u64
 
objeùid
,

260 
u64
 
off£t
, 
mod
)

262 
bŒfs_key
 
fe_key
;

263 
šs_Ën
 = 
mod
 < 0 ? -1 : 0;

264 
cow
 = 
mod
 != 0;

266 
fe_key
.
objeùid
 = objectid;

267 
fe_key
.
off£t
 = offset;

268 
fe_key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

270  
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
fe_key
, 
·th
, 
šs_Ën
, 
cow
);

271 
	}
}

282 
	$£¬ch_csum_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
,

283 
bŒfs_·th
 *
·th
, 
u64
 
disk_by‹Ä
,

284 
u64
 
Ën
, 
u8
 *
d¡
)

286 
bŒfs_roÙ
 *
csum_roÙ
;

287 
bŒfs_csum_™em
 *
™em
 = 
NULL
;

288 
bŒfs_key
 
key
;

289 cÚ¡ 
u32
 
£ùÜsize
 = 
fs_šfo
->sectorsize;

290 cÚ¡ 
u32
 
csum_size
 = 
fs_šfo
->csum_size;

291 
u32
 
™emsize
;

292 
»t
;

293 
u64
 
csum_¡¬t
;

294 
u64
 
csum_Ën
;

296 
	`ASSERT
(
	`IS_ALIGNED
(
disk_by‹Ä
, 
£ùÜsize
) &&

297 
	`IS_ALIGNED
(
Ën
, 
£ùÜsize
));

300 ià(
·th
->
nodes
[0]) {

301 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

302 
bŒfs_csum_™em
);

303 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

304 
™emsize
 = 
	`bŒfs_™em_size
(
·th
->
nodes
[0],…©h->
¦Ùs
[0]);

306 
csum_¡¬t
 = 
key
.
off£t
;

307 
csum_Ën
 = (
™emsize
 / 
csum_size
è* 
£ùÜsize
;

309 ià(
	`š_¿nge
(
disk_by‹Ä
, 
csum_¡¬t
, 
csum_Ën
))

310 
found
;

314 
	`bŒfs_»Ëa£_·th
(
·th
);

315 
csum_roÙ
 = 
	`bŒfs_csum_roÙ
(
fs_šfo
, 
disk_by‹Ä
);

316 
™em
 = 
	`bŒfs_lookup_csum
(
NULL
, 
csum_roÙ
, 
·th
, 
disk_by‹Ä
, 0);

317 ià(
	`IS_ERR
(
™em
)) {

318 
»t
 = 
	`PTR_ERR
(
™em
);

319 
out
;

321 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

322 
™emsize
 = 
	`bŒfs_™em_size
(
·th
->
nodes
[0],…©h->
¦Ùs
[0]);

324 
csum_¡¬t
 = 
key
.
off£t
;

325 
csum_Ën
 = (
™emsize
 / 
csum_size
è* 
£ùÜsize
;

326 
	`ASSERT
(
	`š_¿nge
(
disk_by‹Ä
, 
csum_¡¬t
, 
csum_Ën
));

328 
found
:

329 
»t
 = (
	`mš
(
csum_¡¬t
 + 
csum_Ën
, 
disk_by‹Ä
 + 
Ën
) -

330 
disk_by‹Ä
è>> 
fs_šfo
->
£ùÜsize_b™s
;

331 
	`»ad_ex‹Á_bufãr
(
·th
->
nodes
[0], 
d¡
, ()
™em
,

332 
»t
 * 
csum_size
);

333 
out
:

334 ià(
»t
 =ğ-
ENOENT
 ||„‘ =ğ-
EFBIG
)

335 
»t
 = 0;

336  
»t
;

337 
	}
}

344 
blk_¡©us_t
 
	$bŒfs_lookup_bio_sums
(
bŒfs_bio
 *
bbio
)

346 
bŒfs_šode
 *
šode
 = 
bbio
->inode;

347 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

348 
bio
 *biØğ&
bbio
->bio;

349 
bŒfs_·th
 *
·th
;

350 cÚ¡ 
u32
 
£ùÜsize
 = 
fs_šfo
->sectorsize;

351 cÚ¡ 
u32
 
csum_size
 = 
fs_šfo
->csum_size;

352 
u32
 
Üig_Ën
 = 
bio
->
bi_™”
.
bi_size
;

353 
u64
 
Üig_disk_by‹Ä
 = 
bio
->
bi_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
;

354 cÚ¡ 
nblocks
 = 
Üig_Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
;

355 
blk_¡©us_t
 
»t
 = 
BLK_STS_OK
;

356 
u32
 
bio_off£t
 = 0;

358 ià((
šode
->
æags
 & 
BTRFS_INODE_NODATASUM
) ||

359 
	`‹¡_b™
(
BTRFS_FS_STATE_NO_CSUMS
, &
fs_šfo
->
fs_¡©e
))

360  
BLK_STS_OK
;

374 
	`ASSERT
(
	`bio_İ
(
bio
è=ğ
REQ_OP_READ
);

375 
·th
 = 
	`bŒfs_®loc_·th
();

376 ià(!
·th
)

377  
BLK_STS_RESOURCE
;

379 ià(
nblocks
 * 
csum_size
 > 
BTRFS_BIO_INLINE_CSUM_SIZE
) {

380 
bbio
->
csum
 = 
	`km®loc_¬¿y
(
nblocks
, 
csum_size
, 
GFP_NOFS
);

381 ià(!
bbio
->
csum
) {

382 
	`bŒfs_ä“_·th
(
·th
);

383  
BLK_STS_RESOURCE
;

386 
bbio
->
csum
 = bbio->
csum_šlše
;

393 ià(
nblocks
 > 
fs_šfo
->
csums_³r_Ëaf
)

394 
·th
->
»ada
 = 
READA_FORWARD
;

402 ià(
	`bŒfs_is_ä“_¥aû_šode
(
šode
)) {

403 
·th
->
£¬ch_comm™_roÙ
 = 1;

404 
·th
->
sk_lockšg
 = 1;

407 
bio_off£t
 < 
Üig_Ën
) {

408 
couÁ
;

409 
u64
 
cur_disk_by‹Ä
 = 
Üig_disk_by‹Ä
 + 
bio_off£t
;

410 
u8
 *
csum_d¡
 = 
bbio
->
csum
 +

411 (
bio_off£t
 >> 
fs_šfo
->
£ùÜsize_b™s
è* 
csum_size
;

413 
couÁ
 = 
	`£¬ch_csum_Œ“
(
fs_šfo
, 
·th
, 
cur_disk_by‹Ä
,

414 
Üig_Ën
 - 
bio_off£t
, 
csum_d¡
);

415 ià(
couÁ
 < 0) {

416 
»t
 = 
	`”ºo_to_blk_¡©us
(
couÁ
);

417 ià(
bbio
->
csum
 !ğbbio->
csum_šlše
)

418 
	`kä“
(
bbio
->
csum
);

419 
bbio
->
csum
 = 
NULL
;

433 ià(
couÁ
 == 0) {

434 
	`mem£t
(
csum_d¡
, 0, 
csum_size
);

435 
couÁ
 = 1;

437 ià(
šode
->
roÙ
->
roÙ_key
.
objeùid
 ==

438 
BTRFS_DATA_RELOC_TREE_OBJECTID
) {

439 
u64
 
fe_off£t
 = 
bbio
->fe_off£ˆ+ 
bio_off£t
;

441 
	`£t_ex‹Á_b™
(&
šode
->
io_Œ“
, 
fe_off£t
,

442 
fe_off£t
 + 
£ùÜsize
 - 1,

443 
EXTENT_NODATASUM
, 
NULL
);

445 
	`bŒfs_w¬n_¾
(
fs_šfo
,

447 
cur_disk_by‹Ä
, cur_disk_by‹Ä + 
£ùÜsize
);

450 
bio_off£t
 +ğ
couÁ
 * 
£ùÜsize
;

453 
	`bŒfs_ä“_·th
(
·th
);

454  
»t
;

455 
	}
}

457 
	$bŒfs_lookup_csums_li¡
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
¡¬t
, u64 
’d
,

458 
li¡_h—d
 *
li¡
, 
£¬ch_comm™
,

459 
boŞ
 
nowa™
)

461 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

462 
bŒfs_key
 
key
;

463 
bŒfs_·th
 *
·th
;

464 
ex‹Á_bufãr
 *
Ëaf
;

465 
bŒfs_Üd”ed_sum
 *
sums
;

466 
bŒfs_csum_™em
 *
™em
;

467 
	`LIST_HEAD
(
tm¶i¡
);

468 
»t
;

470 
	`ASSERT
(
	`IS_ALIGNED
(
¡¬t
, 
fs_šfo
->
£ùÜsize
) &&

471 
	`IS_ALIGNED
(
’d
 + 1, 
fs_šfo
->
£ùÜsize
));

473 
·th
 = 
	`bŒfs_®loc_·th
();

474 ià(!
·th
)

475  -
ENOMEM
;

477 
·th
->
nowa™
 =‚owait;

478 ià(
£¬ch_comm™
) {

479 
·th
->
sk_lockšg
 = 1;

480 
·th
->
»ada
 = 
READA_FORWARD
;

481 
·th
->
£¬ch_comm™_roÙ
 = 1;

484 
key
.
objeùid
 = 
BTRFS_EXTENT_CSUM_OBJECTID
;

485 
key
.
off£t
 = 
¡¬t
;

486 
key
.
ty³
 = 
BTRFS_EXTENT_CSUM_KEY
;

488 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

489 ià(
»t
 < 0)

490 
ç
;

491 ià(
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0) {

492 
Ëaf
 = 
·th
->
nodes
[0];

493 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0] - 1);

510 ià(
key
.
objeùid
 =ğ
BTRFS_EXTENT_CSUM_OBJECTID
 &&

511 
key
.
ty³
 =ğ
BTRFS_EXTENT_CSUM_KEY
) {

512 ià(
	`by‹s_to_csum_size
(
fs_šfo
, 
¡¬t
 - 
key
.
off£t
) <

513 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1))

514 
·th
->
¦Ùs
[0]--;

518 
¡¬t
 <ğ
’d
) {

519 
u64
 
csum_’d
;

521 
Ëaf
 = 
·th
->
nodes
[0];

522 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

523 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

524 ià(
»t
 < 0)

525 
ç
;

526 ià(
»t
 > 0)

528 
Ëaf
 = 
·th
->
nodes
[0];

531 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

532 ià(
key
.
objeùid
 !ğ
BTRFS_EXTENT_CSUM_OBJECTID
 ||

533 
key
.
ty³
 !ğ
BTRFS_EXTENT_CSUM_KEY
 ||

534 
key
.
off£t
 > 
’d
)

537 ià(
key
.
off£t
 > 
¡¬t
)

538 
¡¬t
 = 
key
.
off£t
;

540 
csum_’d
 = 
key
.
off£t
 + 
	`csum_size_to_by‹s
(
fs_šfo
,

541 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]));

542 ià(
csum_’d
 <ğ
¡¬t
) {

543 
·th
->
¦Ùs
[0]++;

547 
csum_’d
 = 
	`mš
(csum_’d, 
’d
 + 1);

548 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

549 
bŒfs_csum_™em
);

550 
¡¬t
 < 
csum_’d
) {

551 
off£t
;

552 
size_t
 
size
;

554 
size
 = 
	`mš_t
(
size_t
, 
csum_’d
 - 
¡¬t
,

555 
	`max_Üd”ed_sum_by‹s
(
fs_šfo
));

556 
sums
 = 
	`kz®loc
(
	`bŒfs_Üd”ed_sum_size
(
fs_šfo
, 
size
),

557 
GFP_NOFS
);

558 ià(!
sums
) {

559 
»t
 = -
ENOMEM
;

560 
ç
;

563 
sums
->
logiÿl
 = 
¡¬t
;

564 
sums
->
Ën
 = 
size
;

566 
off£t
 = 
	`by‹s_to_csum_size
(
fs_šfo
, 
¡¬t
 - 
key
.offset);

568 
	`»ad_ex‹Á_bufãr
(
·th
->
nodes
[0],

569 
sums
->sums,

570 (()
™em
è+ 
off£t
,

571 
	`by‹s_to_csum_size
(
fs_šfo
, 
size
));

573 
¡¬t
 +ğ
size
;

574 
	`li¡_add_
(&
sums
->
li¡
, &
tm¶i¡
);

576 
·th
->
¦Ùs
[0]++;

578 
»t
 = 0;

579 
ç
:

580 
»t
 < 0 && !
	`li¡_em±y
(&
tm¶i¡
)) {

581 
sums
 = 
	`li¡_’Œy
(
tm¶i¡
.
Ãxt
, 
bŒfs_Üd”ed_sum
, 
li¡
);

582 
	`li¡_d–
(&
sums
->
li¡
);

583 
	`kä“
(
sums
);

585 
	`li¡_¥liû_
(&
tm¶i¡
, 
li¡
);

587 
	`bŒfs_ä“_·th
(
·th
);

588  
»t
;

589 
	}
}

600 
	$bŒfs_lookup_csums_b™m­
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

601 
u64
 
¡¬t
, u64 
’d
, 
u8
 *
csum_buf
,

602 *
csum_b™m­
)

604 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

605 
bŒfs_key
 
key
;

606 
ex‹Á_bufãr
 *
Ëaf
;

607 
bŒfs_csum_™em
 *
™em
;

608 cÚ¡ 
u64
 
Üig_¡¬t
 = 
¡¬t
;

609 
boŞ
 
ä“_·th
 = 
çl£
;

610 
»t
;

612 
	`ASSERT
(
	`IS_ALIGNED
(
¡¬t
, 
fs_šfo
->
£ùÜsize
) &&

613 
	`IS_ALIGNED
(
’d
 + 1, 
fs_šfo
->
£ùÜsize
));

615 ià(!
·th
) {

616 
·th
 = 
	`bŒfs_®loc_·th
();

617 ià(!
·th
)

618  -
ENOMEM
;

619 
ä“_·th
 = 
Œue
;

623 ià(
·th
->
nodes
[0]) {

624 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

626 ià(
key
.
objeùid
 =ğ
BTRFS_EXTENT_CSUM_OBJECTID
 &&

627 
key
.
ty³
 =ğ
BTRFS_EXTENT_CSUM_KEY
 &&

628 
key
.
off£t
 <ğ
¡¬t
)

629 
£¬ch_fÜw¬d
;

630 
	`bŒfs_»Ëa£_·th
(
·th
);

633 
key
.
objeùid
 = 
BTRFS_EXTENT_CSUM_OBJECTID
;

634 
key
.
ty³
 = 
BTRFS_EXTENT_CSUM_KEY
;

635 
key
.
off£t
 = 
¡¬t
;

637 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

638 ià(
»t
 < 0)

639 
ç
;

640 ià(
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0) {

641 
Ëaf
 = 
·th
->
nodes
[0];

642 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0] - 1);

659 ià(
key
.
objeùid
 =ğ
BTRFS_EXTENT_CSUM_OBJECTID
 &&

660 
key
.
ty³
 =ğ
BTRFS_EXTENT_CSUM_KEY
) {

661 ià(
	`by‹s_to_csum_size
(
fs_šfo
, 
¡¬t
 - 
key
.
off£t
) <

662 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1))

663 
·th
->
¦Ùs
[0]--;

667 
£¬ch_fÜw¬d
:

668 
¡¬t
 <ğ
’d
) {

669 
u64
 
csum_’d
;

671 
Ëaf
 = 
·th
->
nodes
[0];

672 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

673 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

674 ià(
»t
 < 0)

675 
ç
;

676 ià(
»t
 > 0)

678 
Ëaf
 = 
·th
->
nodes
[0];

681 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

682 ià(
key
.
objeùid
 !ğ
BTRFS_EXTENT_CSUM_OBJECTID
 ||

683 
key
.
ty³
 !ğ
BTRFS_EXTENT_CSUM_KEY
 ||

684 
key
.
off£t
 > 
’d
)

687 ià(
key
.
off£t
 > 
¡¬t
)

688 
¡¬t
 = 
key
.
off£t
;

690 
csum_’d
 = 
key
.
off£t
 + 
	`csum_size_to_by‹s
(
fs_šfo
,

691 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]));

692 ià(
csum_’d
 <ğ
¡¬t
) {

693 
·th
->
¦Ùs
[0]++;

697 
csum_’d
 = 
	`mš
(csum_’d, 
’d
 + 1);

698 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

699 
bŒfs_csum_™em
);

700 
¡¬t
 < 
csum_’d
) {

701 
off£t
;

702 
size_t
 
size
;

703 
u8
 *
csum_de¡
 = 
csum_buf
 + 
	`by‹s_to_csum_size
(
fs_šfo
,

704 
¡¬t
 - 
Üig_¡¬t
);

706 
size
 = 
	`mš_t
(
size_t
, 
csum_’d
 - 
¡¬t
, 
’d
 + 1 - start);

708 
off£t
 = 
	`by‹s_to_csum_size
(
fs_šfo
, 
¡¬t
 - 
key
.offset);

710 
	`»ad_ex‹Á_bufãr
(
·th
->
nodes
[0], 
csum_de¡
,

711 (()
™em
è+ 
off£t
,

712 
	`by‹s_to_csum_size
(
fs_šfo
, 
size
));

714 
	`b™m­_£t
(
csum_b™m­
,

715 (
¡¬t
 - 
Üig_¡¬t
è>> 
fs_šfo
->
£ùÜsize_b™s
,

716 
size
 >> 
fs_šfo
->
£ùÜsize_b™s
);

718 
¡¬t
 +ğ
size
;

720 
·th
->
¦Ùs
[0]++;

722 
»t
 = 0;

723 
ç
:

724 ià(
ä“_·th
)

725 
	`bŒfs_ä“_·th
(
·th
);

726  
»t
;

727 
	}
}

732 
blk_¡©us_t
 
	$bŒfs_csum_Úe_bio
(
bŒfs_bio
 *
bbio
)

734 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
 = 
bbio
->ordered;

735 
bŒfs_šode
 *
šode
 = 
bbio
->inode;

736 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

737 
	`SHASH_DESC_ON_STACK
(
shash
, 
fs_šfo
->
csum_shash
);

738 
bio
 *biØğ&
bbio
->bio;

739 
bŒfs_Üd”ed_sum
 *
sums
;

740 *
d©a
;

741 
bvec_™”
 
™”
;

742 
bio_vec
 
bvec
;

743 
šdex
;

744 
blockcouÁ
;

745 
i
;

746 
nofs_æag
;

748 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

749 
sums
 = 
	`kvz®loc
(
	`bŒfs_Üd”ed_sum_size
(
fs_šfo
, 
bio
->
bi_™”
.
bi_size
),

750 
GFP_KERNEL
);

751 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

753 ià(!
sums
)

754  
BLK_STS_RESOURCE
;

756 
sums
->
Ën
 = 
bio
->
bi_™”
.
bi_size
;

757 
	`INIT_LIST_HEAD
(&
sums
->
li¡
);

759 
sums
->
logiÿl
 = 
bio
->
bi_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
;

760 
šdex
 = 0;

762 
shash
->
tfm
 = 
fs_šfo
->
csum_shash
;

764 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
™”
) {

765 
blockcouÁ
 = 
	`BTRFS_BYTES_TO_BLKS
(
fs_šfo
,

766 
bvec
.
bv_Ën
 + 
fs_šfo
->
£ùÜsize


769 
i
 = 0; i < 
blockcouÁ
; i++) {

770 
d©a
 = 
	`bvec_km­_loÿl
(&
bvec
);

771 
	`üy±o_shash_dige¡
(
shash
,

772 
d©a
 + (
i
 * 
fs_šfo
->
£ùÜsize
),

773 
fs_šfo
->
£ùÜsize
,

774 
sums
->sum + 
šdex
);

775 
	`kunm­_loÿl
(
d©a
);

776 
šdex
 +ğ
fs_šfo
->
csum_size
;

781 
bbio
->
sums
 = sums;

782 
	`bŒfs_add_Üd”ed_sum
(
Üd”ed
, 
sums
);

784 
	}
}

791 
blk_¡©us_t
 
	$bŒfs_®loc_dummy_sum
(
bŒfs_bio
 *
bbio
)

793 
bbio
->
sums
 = 
	`km®loc
((*bbio->sums), 
GFP_NOFS
);

794 ià(!
bbio
->
sums
)

795  
BLK_STS_RESOURCE
;

796 
bbio
->
sums
->
Ën
 = bbio->
bio
.
bi_™”
.
bi_size
;

797 
bbio
->
sums
->
logiÿl
 = bbio->
bio
.
bi_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
;

798 
	`bŒfs_add_Üd”ed_sum
(
bbio
->
Üd”ed
, bbio->
sums
);

800 
	}
}

814 
nošlše
 
	$Œunÿ‹_Úe_csum
(
bŒfs_Œªs_hªdË
 *
Œªs
,

815 
bŒfs_·th
 *
·th
,

816 
bŒfs_key
 *
key
,

817 
u64
 
by‹Ä
, u64 
Ën
)

819 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

820 
ex‹Á_bufãr
 *
Ëaf
;

821 cÚ¡ 
u32
 
csum_size
 = 
fs_šfo
->csum_size;

822 
u64
 
csum_’d
;

823 
u64
 
’d_by‹
 = 
by‹Ä
 + 
Ën
;

824 
u32
 
blocksize_b™s
 = 
fs_šfo
->
£ùÜsize_b™s
;

826 
Ëaf
 = 
·th
->
nodes
[0];

827 
csum_’d
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]è/ 
csum_size
;

828 
csum_’d
 <<ğ
blocksize_b™s
;

829 
csum_’d
 +ğ
key
->
off£t
;

831 ià(
key
->
off£t
 < 
by‹Ä
 && 
csum_’d
 <ğ
’d_by‹
) {

838 
u32
 
Ãw_size
 = (
by‹Ä
 - 
key
->
off£t
è>> 
blocksize_b™s
;

839 
Ãw_size
 *ğ
csum_size
;

840 
	`bŒfs_Œunÿ‹_™em
(
Œªs
, 
·th
, 
Ãw_size
, 1);

841 } ià(
key
->
off£t
 >ğ
by‹Ä
 && 
csum_’d
 > 
’d_by‹
 &&

842 
’d_by‹
 > 
key
->
off£t
) {

849 
u32
 
Ãw_size
 = (
csum_’d
 - 
’d_by‹
è>> 
blocksize_b™s
;

850 
Ãw_size
 *ğ
csum_size
;

852 
	`bŒfs_Œunÿ‹_™em
(
Œªs
, 
·th
, 
Ãw_size
, 0);

854 
key
->
off£t
 = 
’d_by‹
;

855 
	`bŒfs_£t_™em_key_§ã
(
Œªs
, 
·th
, 
key
);

857 
	`BUG
();

859 
	}
}

864 
	$bŒfs_d–_csums
(
bŒfs_Œªs_hªdË
 *
Œªs
,

865 
bŒfs_roÙ
 *
roÙ
, 
u64
 
by‹Ä
, u64 
Ën
)

867 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

868 
bŒfs_·th
 *
·th
;

869 
bŒfs_key
 
key
;

870 
u64
 
’d_by‹
 = 
by‹Ä
 + 
Ën
;

871 
u64
 
csum_’d
;

872 
ex‹Á_bufãr
 *
Ëaf
;

873 
»t
 = 0;

874 cÚ¡ 
u32
 
csum_size
 = 
fs_šfo
->csum_size;

875 
u32
 
blocksize_b™s
 = 
fs_šfo
->
£ùÜsize_b™s
;

877 
	`ASSERT
(
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_CSUM_TREE_OBJECTID
 ||

878 
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_LOG_OBJECTID
);

880 
·th
 = 
	`bŒfs_®loc_·th
();

881 ià(!
·th
)

882  -
ENOMEM
;

885 
key
.
objeùid
 = 
BTRFS_EXTENT_CSUM_OBJECTID
;

886 
key
.
off£t
 = 
’d_by‹
 - 1;

887 
key
.
ty³
 = 
BTRFS_EXTENT_CSUM_KEY
;

889 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

890 ià(
»t
 > 0) {

891 
»t
 = 0;

892 ià(
·th
->
¦Ùs
[0] == 0)

894 
·th
->
¦Ùs
[0]--;

895 } ià(
»t
 < 0) {

899 
Ëaf
 = 
·th
->
nodes
[0];

900 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

902 ià(
key
.
objeùid
 !ğ
BTRFS_EXTENT_CSUM_OBJECTID
 ||

903 
key
.
ty³
 !ğ
BTRFS_EXTENT_CSUM_KEY
) {

907 ià(
key
.
off£t
 >ğ
’d_by‹
)

910 
csum_’d
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]è/ 
csum_size
;

911 
csum_’d
 <<ğ
blocksize_b™s
;

912 
csum_’d
 +ğ
key
.
off£t
;

915 ià(
csum_’d
 <ğ
by‹Ä
)

919 ià(
key
.
off£t
 >ğ
by‹Ä
 && 
csum_’d
 <ğ
’d_by‹
) {

920 
d–_Ä
 = 1;

927 ià(
key
.
off£t
 > 
by‹Ä
 && 
·th
->
¦Ùs
[0] > 0) {

928 
¦Ù
 = 
·th
->
¦Ùs
[0] - 1;

930 
¦Ù
 >= 0) {

931 
bŒfs_key
 
pk
;

933 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
pk
, 
¦Ù
);

934 ià(
pk
.
off£t
 < 
by‹Ä
 ||

935 
pk
.
ty³
 !ğ
BTRFS_EXTENT_CSUM_KEY
 ||

936 
pk
.
objeùid
 !=

937 
BTRFS_EXTENT_CSUM_OBJECTID
)

939 
·th
->
¦Ùs
[0] = 
¦Ù
;

940 
d–_Ä
++;

941 
key
.
off£t
 = 
pk
.offset;

942 
¦Ù
--;

945 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
,

946 
·th
->
¦Ùs
[0], 
d–_Ä
);

947 ià(
»t
)

949 ià(
key
.
off£t
 =ğ
by‹Ä
)

951 } ià(
key
.
off£t
 < 
by‹Ä
 && 
csum_’d
 > 
’d_by‹
) {

952 
off£t
;

953 
shiá_Ën
;

954 
™em_off£t
;

973 
off£t
 = (
by‹Ä
 - 
key
.off£tè>> 
blocksize_b™s
;

974 
off£t
 *ğ
csum_size
;

976 
shiá_Ën
 = (
Ën
 >> 
blocksize_b™s
è* 
csum_size
;

978 
™em_off£t
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
,

979 
·th
->
¦Ùs
[0]);

981 
	`memz”o_ex‹Á_bufãr
(
Ëaf
, 
™em_off£t
 + 
off£t
,

982 
shiá_Ën
);

983 
key
.
off£t
 = 
by‹Ä
;

989 
»t
 = 
	`bŒfs_¥l™_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 
off£t
);

990 ià(
»t
 &&„‘ !ğ-
EAGAIN
) {

991 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

994 
»t
 = 0;

996 
key
.
off£t
 = 
’d_by‹
 - 1;

998 
	`Œunÿ‹_Úe_csum
(
Œªs
, 
·th
, &
key
, 
by‹Ä
, 
Ën
);

999 ià(
key
.
off£t
 < 
by‹Ä
)

1002 
	`bŒfs_»Ëa£_·th
(
·th
);

1004 
	`bŒfs_ä“_·th
(
·th
);

1005  
»t
;

1006 
	}
}

1008 
	$fšd_Ãxt_csum_off£t
(
bŒfs_roÙ
 *
roÙ
,

1009 
bŒfs_·th
 *
·th
,

1010 
u64
 *
Ãxt_off£t
)

1012 cÚ¡ 
u32
 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

1013 
bŒfs_key
 
found_key
;

1014 
¦Ù
 = 
·th
->
¦Ùs
[0] + 1;

1015 
»t
;

1017 ià(
Ä™ems
 =ğ0 || 
¦Ù
 >=‚ritems) {

1018 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

1019 ià(
»t
 < 0) {

1020  
»t
;

1021 } ià(
»t
 > 0) {

1022 *
Ãxt_off£t
 = (
u64
)-1;

1025 
¦Ù
 = 
·th
->
¦Ùs
[0];

1028 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
found_key
, 
¦Ù
);

1030 ià(
found_key
.
objeùid
 !ğ
BTRFS_EXTENT_CSUM_OBJECTID
 ||

1031 
found_key
.
ty³
 !ğ
BTRFS_EXTENT_CSUM_KEY
)

1032 *
Ãxt_off£t
 = (
u64
)-1;

1034 *
Ãxt_off£t
 = 
found_key
.
off£t
;

1037 
	}
}

1039 
	$bŒfs_csum_fe_blocks
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1040 
bŒfs_roÙ
 *
roÙ
,

1041 
bŒfs_Üd”ed_sum
 *
sums
)

1043 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1044 
bŒfs_key
 
fe_key
;

1045 
bŒfs_key
 
found_key
;

1046 
bŒfs_·th
 *
·th
;

1047 
bŒfs_csum_™em
 *
™em
;

1048 
bŒfs_csum_™em
 *
™em_’d
;

1049 
ex‹Á_bufãr
 *
Ëaf
 = 
NULL
;

1050 
u64
 
Ãxt_off£t
;

1051 
u64
 
tÙ®_by‹s
 = 0;

1052 
u64
 
csum_off£t
;

1053 
u64
 
by‹Ä
;

1054 
u32
 
šs_size
;

1055 
šdex
 = 0;

1056 
found_Ãxt
;

1057 
»t
;

1058 cÚ¡ 
u32
 
csum_size
 = 
fs_šfo
->csum_size;

1060 
·th
 = 
	`bŒfs_®loc_·th
();

1061 ià(!
·th
)

1062  -
ENOMEM
;

1063 
agaš
:

1064 
Ãxt_off£t
 = (
u64
)-1;

1065 
found_Ãxt
 = 0;

1066 
by‹Ä
 = 
sums
->
logiÿl
 + 
tÙ®_by‹s
;

1067 
fe_key
.
objeùid
 = 
BTRFS_EXTENT_CSUM_OBJECTID
;

1068 
fe_key
.
off£t
 = 
by‹Ä
;

1069 
fe_key
.
ty³
 = 
BTRFS_EXTENT_CSUM_KEY
;

1071 
™em
 = 
	`bŒfs_lookup_csum
(
Œªs
, 
roÙ
, 
·th
, 
by‹Ä
, 1);

1072 ià(!
	`IS_ERR
(
™em
)) {

1073 
»t
 = 0;

1074 
Ëaf
 = 
·th
->
nodes
[0];

1075 
™em_’d
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1076 
bŒfs_csum_™em
);

1077 
™em_’d
 = (
bŒfs_csum_™em
 *)((*)item_end +

1078 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]));

1079 
found
;

1081 
»t
 = 
	`PTR_ERR
(
™em
);

1082 ià(
»t
 !ğ-
EFBIG
 &&„‘ !ğ-
ENOENT
)

1083 
out
;

1085 ià(
»t
 =ğ-
EFBIG
) {

1086 
u32
 
™em_size
;

1088 
Ëaf
 = 
·th
->
nodes
[0];

1089 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1090 ià((
™em_size
 / 
csum_size
) >=

1091 
	`MAX_CSUM_ITEMS
(
fs_šfo
, 
csum_size
)) {

1093 
š£¹
;

1097 
»t
 = 
	`fšd_Ãxt_csum_off£t
(
roÙ
, 
·th
, &
Ãxt_off£t
);

1098 ià(
»t
 < 0)

1099 
out
;

1100 
found_Ãxt
 = 1;

1101 
š£¹
;

1114 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
Ëaf
è>ğ
csum_size
) {

1115 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

1116 
csum_off£t
 = (
by‹Ä
 - 
found_key
.
off£t
) >>

1117 
fs_šfo
->
£ùÜsize_b™s
;

1118 
ex‹nd_csum
;

1121 
	`bŒfs_»Ëa£_·th
(
·th
);

1122 
·th
->
£¬ch_fÜ_ex‹nsiÚ
 = 1;

1123 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
fe_key
, 
·th
,

1124 
csum_size
, 1);

1125 
·th
->
£¬ch_fÜ_ex‹nsiÚ
 = 0;

1126 ià(
»t
 < 0)

1127 
out
;

1129 ià(
»t
 > 0) {

1130 ià(
·th
->
¦Ùs
[0] == 0)

1131 
š£¹
;

1132 
·th
->
¦Ùs
[0]--;

1135 
Ëaf
 = 
·th
->
nodes
[0];

1136 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

1137 
csum_off£t
 = (
by‹Ä
 - 
found_key
.
off£t
è>> 
fs_šfo
->
£ùÜsize_b™s
;

1139 ià(
found_key
.
ty³
 !ğ
BTRFS_EXTENT_CSUM_KEY
 ||

1140 
found_key
.
objeùid
 !ğ
BTRFS_EXTENT_CSUM_OBJECTID
 ||

1141 
csum_off£t
 >ğ
	`MAX_CSUM_ITEMS
(
fs_šfo
, 
csum_size
)) {

1142 
š£¹
;

1145 
ex‹nd_csum
:

1146 ià(
csum_off£t
 =ğ
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]) /

1147 
csum_size
) {

1148 
ex‹nd_Ä
;

1149 
u64
 
tmp
;

1150 
u32
 
diff
;

1152 
tmp
 = 
sums
->
Ën
 - 
tÙ®_by‹s
;

1153 
tmp
 >>ğ
fs_šfo
->
£ùÜsize_b™s
;

1154 
	`WARN_ON
(
tmp
 < 1);

1155 
ex‹nd_Ä
 = 
	`max_t
(, 1, 
tmp
);

1178 ià(
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_LOG_OBJECTID
) {

1179 ià(
·th
->
¦Ùs
[0] + 1 >=

1180 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0])) {

1181 
»t
 = 
	`fšd_Ãxt_csum_off£t
(
roÙ
, 
·th
, &
Ãxt_off£t
);

1182 ià(
»t
 < 0)

1183 
out
;

1184 
found_Ãxt
 = 1;

1185 
š£¹
;

1188 
»t
 = 
	`fšd_Ãxt_csum_off£t
(
roÙ
, 
·th
, &
Ãxt_off£t
);

1189 ià(
»t
 < 0)

1190 
out
;

1192 
tmp
 = (
Ãxt_off£t
 - 
by‹Ä
è>> 
fs_šfo
->
£ùÜsize_b™s
;

1193 ià(
tmp
 <ğ
INT_MAX
)

1194 
ex‹nd_Ä
 = 
	`mš_t
(,ƒx‹nd_Ä, 
tmp
);

1197 
diff
 = (
csum_off£t
 + 
ex‹nd_Ä
è* 
csum_size
;

1198 
diff
 = 
	`mš
(diff,

1199 
	`MAX_CSUM_ITEMS
(
fs_šfo
, 
csum_size
) * csum_size);

1201 
diff
 = difà- 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1202 
diff
 = 
	`mš_t
(
u32
, 
	`bŒfs_Ëaf_ä“_¥aû
(
Ëaf
), diff);

1203 
diff
 /ğ
csum_size
;

1204 
diff
 *ğ
csum_size
;

1206 
	`bŒfs_ex‹nd_™em
(
Œªs
, 
·th
, 
diff
);

1207 
»t
 = 0;

1208 
csum
;

1211 
š£¹
:

1212 
	`bŒfs_»Ëa£_·th
(
·th
);

1213 
csum_off£t
 = 0;

1214 ià(
found_Ãxt
) {

1215 
u64
 
tmp
;

1217 
tmp
 = 
sums
->
Ën
 - 
tÙ®_by‹s
;

1218 
tmp
 >>ğ
fs_šfo
->
£ùÜsize_b™s
;

1219 
tmp
 = 
	`mš
Ñmp, (
Ãxt_off£t
 - 
fe_key
.
off£t
) >>

1220 
fs_šfo
->
£ùÜsize_b™s
);

1222 
tmp
 = 
	`max_t
(
u64
, 1,mp);

1223 
tmp
 = 
	`mš_t
(
u64
,mp, 
	`MAX_CSUM_ITEMS
(
fs_šfo
, 
csum_size
));

1224 
šs_size
 = 
csum_size
 * 
tmp
;

1226 
šs_size
 = 
csum_size
;

1228 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
fe_key
,

1229 
šs_size
);

1230 ià(
»t
 < 0)

1231 
out
;

1232 ià(
	`WARN_ON
(
»t
 != 0))

1233 
out
;

1234 
Ëaf
 = 
·th
->
nodes
[0];

1235 
csum
:

1236 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_csum_™em
);

1237 
™em_’d
 = (
bŒfs_csum_™em
 *)((*)
™em
 +

1238 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]));

1239 
™em
 = (
bŒfs_csum_™em
 *)((*)item +

1240 
csum_off£t
 * 
csum_size
);

1241 
found
:

1242 
šs_size
 = (
u32
)(
sums
->
Ën
 - 
tÙ®_by‹s
è>> 
fs_šfo
->
£ùÜsize_b™s
;

1243 
šs_size
 *ğ
csum_size
;

1244 
šs_size
 = 
	`mš_t
(
u32
, ()
™em_’d
 - ()
™em
,

1245 
šs_size
);

1246 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
sums
->sum + 
šdex
, ()
™em
,

1247 
šs_size
);

1249 
šdex
 +ğ
šs_size
;

1250 
šs_size
 /ğ
csum_size
;

1251 
tÙ®_by‹s
 +ğ
šs_size
 * 
fs_šfo
->
£ùÜsize
;

1253 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·th
->
nodes
[0]);

1254 ià(
tÙ®_by‹s
 < 
sums
->
Ën
) {

1255 
	`bŒfs_»Ëa£_·th
(
·th
);

1256 
	`cÚd_»sched
();

1257 
agaš
;

1259 
out
:

1260 
	`bŒfs_ä“_·th
(
·th
);

1261  
»t
;

1262 
	}
}

1264 
	$bŒfs_ex‹Á_™em_to_ex‹Á_m­
(
bŒfs_šode
 *
šode
,

1265 cÚ¡ 
bŒfs_·th
 *
·th
,

1266 
bŒfs_fe_ex‹Á_™em
 *
fi
,

1267 
ex‹Á_m­
 *
em
)

1269 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

1270 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

1271 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

1272 cÚ¡ 
¦Ù
 = 
·th
->
¦Ùs
[0];

1273 
bŒfs_key
 
key
;

1274 
u64
 
ex‹Á_¡¬t
, 
ex‹Á_’d
;

1275 
u64
 
by‹Ä
;

1276 
u8
 
ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
fi
);

1277 
com´ess_ty³
 = 
	`bŒfs_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
);

1279 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

1280 
ex‹Á_¡¬t
 = 
key
.
off£t
;

1281 
ex‹Á_’d
 = 
	`bŒfs_fe_ex‹Á_’d
(
·th
);

1282 
em
->
¿m_by‹s
 = 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
);

1283 
em
->
g’”©iÚ
 = 
	`bŒfs_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
);

1284 ià(
ty³
 =ğ
BTRFS_FILE_EXTENT_REG
 ||

1285 
ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
) {

1286 
em
->
¡¬t
 = 
ex‹Á_¡¬t
;

1287 
em
->
Ën
 = 
ex‹Á_’d
 - 
ex‹Á_¡¬t
;

1288 
em
->
Üig_¡¬t
 = 
ex‹Á_¡¬t
 -

1289 
	`bŒfs_fe_ex‹Á_off£t
(
Ëaf
, 
fi
);

1290 
em
->
Üig_block_Ën
 = 
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
);

1291 
by‹Ä
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
);

1292 ià(
by‹Ä
 == 0) {

1293 
em
->
block_¡¬t
 = 
EXTENT_MAP_HOLE
;

1296 ià(
com´ess_ty³
 !ğ
BTRFS_COMPRESS_NONE
) {

1297 
	`£t_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
);

1298 
em
->
com´ess_ty³
 = compress_type;

1299 
em
->
block_¡¬t
 = 
by‹Ä
;

1300 
em
->
block_Ën
 =ƒm->
Üig_block_Ën
;

1302 
by‹Ä
 +ğ
	`bŒfs_fe_ex‹Á_off£t
(
Ëaf
, 
fi
);

1303 
em
->
block_¡¬t
 = 
by‹Ä
;

1304 
em
->
block_Ën
 =ƒm->
Ën
;

1305 ià(
ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
)

1306 
	`£t_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
);

1308 } ià(
ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
) {

1309 
em
->
block_¡¬t
 = 
EXTENT_MAP_INLINE
;

1310 
em
->
¡¬t
 = 
ex‹Á_¡¬t
;

1311 
em
->
Ën
 = 
ex‹Á_’d
 - 
ex‹Á_¡¬t
;

1316 
em
->
Üig_¡¬t
 = 
EXTENT_MAP_HOLE
;

1317 
em
->
block_Ën
 = (
u64
)-1;

1318 
em
->
com´ess_ty³
 = compress_type;

1319 ià(
com´ess_ty³
 !ğ
BTRFS_COMPRESS_NONE
)

1320 
	`£t_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
);

1322 
	`bŒfs_”r
(
fs_šfo
,

1324 "roÙ %Îu", 
ty³
, 
	`bŒfs_šo
(
šode
), 
ex‹Á_¡¬t
,

1325 
roÙ
->
roÙ_key
.
objeùid
);

1327 
	}
}

1334 
u64
 
	$bŒfs_fe_ex‹Á_’d
(cÚ¡ 
bŒfs_·th
 *
·th
)

1336 cÚ¡ 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

1337 cÚ¡ 
¦Ù
 = 
·th
->
¦Ùs
[0];

1338 
bŒfs_fe_ex‹Á_™em
 *
fi
;

1339 
bŒfs_key
 
key
;

1340 
u64
 
’d
;

1342 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

1343 
	`ASSERT
(
key
.
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
);

1344 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_fe_ex‹Á_™em
);

1346 ià(
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
fi
è=ğ
BTRFS_FILE_EXTENT_INLINE
) {

1347 
’d
 = 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
);

1348 
’d
 = 
	`ALIGN
(
key
.
off£t
 +ƒnd, 
Ëaf
->
fs_šfo
->
£ùÜsize
);

1350 
’d
 = 
key
.
off£t
 + 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

1353  
’d
;

1354 
	}
}

	@file-item.h

3 #iâdeà
BTRFS_FILE_ITEM_H


4 
	#BTRFS_FILE_ITEM_H


	)

6 
	~"acûssÜs.h
"

8 
	#BTRFS_FILE_EXTENT_INLINE_DATA_START
 \

9 (
	`off£tof
(
bŒfs_fe_ex‹Á_™em
, 
disk_by‹Ä
))

	)

11 
šlše
 
u32
 
	$BTRFS_MAX_INLINE_DATA_SIZE
(cÚ¡ 
bŒfs_fs_šfo
 *
šfo
)

13  
	`BTRFS_MAX_ITEM_SIZE
(
šfo
è- 
BTRFS_FILE_EXTENT_INLINE_DATA_START
;

14 
	}
}

21 
šlše
 
u32
 
	$bŒfs_fe_ex‹Á_šlše_™em_Ën
(

22 cÚ¡ 
ex‹Á_bufãr
 *
eb
,

23 
Ä
)

25  
	`bŒfs_™em_size
(
eb
, 
Ä
è- 
BTRFS_FILE_EXTENT_INLINE_DATA_START
;

26 
	}
}

28 
šlše
 
	$bŒfs_fe_ex‹Á_šlše_¡¬t
(

29 cÚ¡ 
bŒfs_fe_ex‹Á_™em
 *
e
)

31  ()
e
 + 
BTRFS_FILE_EXTENT_INLINE_DATA_START
;

32 
	}
}

34 
šlše
 
u32
 
	$bŒfs_fe_ex‹Á_ÿlc_šlše_size
(
u32
 
d©asize
)

36  
BTRFS_FILE_EXTENT_INLINE_DATA_START
 + 
d©asize
;

37 
	}
}

39 
bŒfs_d–_csums
(
bŒfs_Œªs_hªdË
 *
Œªs
,

40 
bŒfs_roÙ
 *
roÙ
, 
u64
 
by‹Ä
, u64 
Ën
);

41 
blk_¡©us_t
 
bŒfs_lookup_bio_sums
(
bŒfs_bio
 *
bbio
);

42 
bŒfs_š£¹_hŞe_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

43 
bŒfs_roÙ
 *
roÙ
, 
u64
 
objeùid
, u64 
pos
,

44 
u64
 
num_by‹s
);

45 
bŒfs_lookup_fe_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

46 
bŒfs_roÙ
 *
roÙ
,

47 
bŒfs_·th
 *
·th
, 
u64
 
objeùid
,

48 
u64
 
by‹Ä
, 
mod
);

49 
bŒfs_csum_fe_blocks
(
bŒfs_Œªs_hªdË
 *
Œªs
,

50 
bŒfs_roÙ
 *
roÙ
,

51 
bŒfs_Üd”ed_sum
 *
sums
);

52 
blk_¡©us_t
 
bŒfs_csum_Úe_bio
(
bŒfs_bio
 *
bbio
);

53 
blk_¡©us_t
 
bŒfs_®loc_dummy_sum
(
bŒfs_bio
 *
bbio
);

54 
bŒfs_lookup_csums_¿nge
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
¡¬t
, u64 
’d
,

55 
li¡_h—d
 *
li¡
, 
£¬ch_comm™
,

56 
boŞ
 
nowa™
);

57 
bŒfs_lookup_csums_li¡
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
¡¬t
, u64 
’d
,

58 
li¡_h—d
 *
li¡
, 
£¬ch_comm™
,

59 
boŞ
 
nowa™
);

60 
bŒfs_lookup_csums_b™m­
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

61 
u64
 
¡¬t
, u64 
’d
, 
u8
 *
csum_buf
,

62 *
csum_b™m­
);

63 
bŒfs_ex‹Á_™em_to_ex‹Á_m­
(
bŒfs_šode
 *
šode
,

64 cÚ¡ 
bŒfs_·th
 *
·th
,

65 
bŒfs_fe_ex‹Á_™em
 *
fi
,

66 
ex‹Á_m­
 *
em
);

67 
bŒfs_šode_ş—r_fe_ex‹Á_¿nge
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
,

68 
u64
 
Ën
);

69 
bŒfs_šode_£t_fe_ex‹Á_¿nge
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
Ën
);

70 
bŒfs_šode_§ã_disk_i_size_wr™e
(
bŒfs_šode
 *
šode
, 
u64
 
Ãw_i_size
);

71 
u64
 
bŒfs_fe_ex‹Á_’d
(cÚ¡ 
bŒfs_·th
 *
·th
);

	@file.c

6 
	~<lšux/fs.h
>

7 
	~<lšux/·gem­.h
>

8 
	~<lšux/time.h
>

9 
	~<lšux/š™.h
>

10 
	~<lšux/¡ršg.h
>

11 
	~<lšux/backšg-dev.h
>

12 
	~<lšux/çÎoc.h
>

13 
	~<lšux/wr™eback.h
>

14 
	~<lšux/com·t.h
>

15 
	~<lšux/¦ab.h
>

16 
	~<lšux/bŒfs.h
>

17 
	~<lšux/uio.h
>

18 
	~<lšux/iv”siÚ.h
>

19 
	~<lšux/fsv”™y.h
>

20 
	~"ù»e.h
"

21 
	~"disk-io.h
"

22 
	~"Œª§ùiÚ.h
"

23 
	~"bŒfs_šode.h
"

24 
	~"´št-Œ“.h
"

25 
	~"Œ“-log.h
"

26 
	~"lockšg.h
"

27 
	~"vŞumes.h
"

28 
	~"qgroup.h
"

29 
	~"com´essiÚ.h
"

30 
	~"d–®loc-¥aû.h
"

31 
	~"»æšk.h
"

32 
	~"sub·ge.h
"

33 
	~"fs.h
"

34 
	~"acûssÜs.h
"

35 
	~"ex‹Á-Œ“.h
"

36 
	~"fe-™em.h
"

37 
	~"ioùl.h
"

38 
	~"fe.h
"

39 
	~"su³r.h
"

40 
	~"mm/fem­.h
"

44 
nošlše
 
	$bŒfs_cİy_äom_u£r
(
loff_t
 
pos
, 
size_t
 
wr™e_by‹s
,

45 
·ge
 **
´•¬ed_·ges
,

46 
iov_™”
 *
i
)

48 
size_t
 
cİ›d
 = 0;

49 
size_t
 
tÙ®_cİ›d
 = 0;

50 
pg
 = 0;

51 
off£t
 = 
	`off£t_š_·ge
(
pos
);

53 
wr™e_by‹s
 > 0) {

54 
size_t
 
couÁ
 = 
	`mš_t
(size_t,

55 
PAGE_SIZE
 - 
off£t
, 
wr™e_by‹s
);

56 
·ge
 *·gğ
´•¬ed_·ges
[
pg
];

60 
cİ›d
 = 
	`cİy_·ge_äom_™”_©omic
(
·ge
, 
off£t
, 
couÁ
, 
i
);

63 
	`æush_dÿche_·ge
(
·ge
);

74 ià(
	`uÆik–y
(
cİ›d
 < 
couÁ
)) {

75 ià(!
	`PageU±od©e
(
·ge
)) {

76 
	`iov_™”_»v”t
(
i
, 
cİ›d
);

77 
cİ›d
 = 0;

79 ià(!
cİ›d
)

83 
wr™e_by‹s
 -ğ
cİ›d
;

84 
tÙ®_cİ›d
 +ğ
cİ›d
;

85 
off£t
 +ğ
cİ›d
;

86 ià(
off£t
 =ğ
PAGE_SIZE
) {

87 
pg
++;

88 
off£t
 = 0;

91  
tÙ®_cİ›d
;

92 
	}
}

97 
	$bŒfs_drİ_·ges
(
bŒfs_fs_šfo
 *
fs_šfo
,

98 
·ge
 **
·ges
, 
size_t
 
num_·ges
,

99 
u64
 
pos
, u64 
cİ›d
)

101 
size_t
 
i
;

102 
u64
 
block_¡¬t
 = 
	`round_down
(
pos
, 
fs_šfo
->
£ùÜsize
);

103 
u64
 
block_Ën
 = 
	`round_up
(
pos
 + 
cİ›d
, 
fs_šfo
->
£ùÜsize
è- 
block_¡¬t
;

105 
	`ASSERT
(
block_Ën
 <ğ
U32_MAX
);

106 
i
 = 0; i < 
num_·ges
; i++) {

113 
	`bŒfs_·ge_şamp_ş—r_checked
(
fs_šfo
, 
·ges
[
i
], 
block_¡¬t
,

114 
block_Ën
);

115 
	`uÆock_·ge
(
·ges
[
i
]);

116 
	`put_·ge
(
·ges
[
i
]);

118 
	}
}

127 
	$bŒfs_dœty_·ges
(
bŒfs_šode
 *
šode
, 
·ge
 **
·ges
,

128 
size_t
 
num_·ges
, 
loff_t
 
pos
, size_ˆ
wr™e_by‹s
,

129 
ex‹Á_¡©e
 **
ÿched
, 
boŞ
 
nÜe£rve
)

131 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

132 
”r
 = 0;

133 
i
;

134 
u64
 
num_by‹s
;

135 
u64
 
¡¬t_pos
;

136 
u64
 
’d_of_Ï¡_block
;

137 
u64
 
’d_pos
 = 
pos
 + 
wr™e_by‹s
;

138 
loff_t
 
isize
 = 
	`i_size_»ad
(&
šode
->
vfs_šode
);

139 
exŒa_b™s
 = 0;

141 ià(
wr™e_by‹s
 == 0)

144 ià(
nÜe£rve
)

145 
exŒa_b™s
 |ğ
EXTENT_NORESERVE
;

147 
¡¬t_pos
 = 
	`round_down
(
pos
, 
fs_šfo
->
£ùÜsize
);

148 
num_by‹s
 = 
	`round_up
(
wr™e_by‹s
 + 
pos
 - 
¡¬t_pos
,

149 
fs_šfo
->
£ùÜsize
);

150 
	`ASSERT
(
num_by‹s
 <ğ
U32_MAX
);

152 
’d_of_Ï¡_block
 = 
¡¬t_pos
 + 
num_by‹s
 - 1;

158 
	`ş—r_ex‹Á_b™
(&
šode
->
io_Œ“
, 
¡¬t_pos
, 
’d_of_Ï¡_block
,

159 
EXTENT_DELALLOC
 | 
EXTENT_DO_ACCOUNTING
 | 
EXTENT_DEFRAG
,

160 
ÿched
);

162 
”r
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
šode
, 
¡¬t_pos
, 
’d_of_Ï¡_block
,

163 
exŒa_b™s
, 
ÿched
);

164 ià(
”r
)

165  
”r
;

167 
i
 = 0; i < 
num_·ges
; i++) {

168 
·ge
 *
p
 = 
·ges
[
i
];

170 
	`bŒfs_·ge_şamp_£t_u±od©e
(
fs_šfo
, 
p
, 
¡¬t_pos
, 
num_by‹s
);

171 
	`bŒfs_·ge_şamp_ş—r_checked
(
fs_šfo
, 
p
, 
¡¬t_pos
, 
num_by‹s
);

172 
	`bŒfs_·ge_şamp_£t_dœty
(
fs_šfo
, 
p
, 
¡¬t_pos
, 
num_by‹s
);

180 ià(
’d_pos
 > 
isize
)

181 
	`i_size_wr™e
(&
šode
->
vfs_šode
, 
’d_pos
);

183 
	}
}

200 
	$bŒfs_drİ_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

201 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_šode
 *
šode
,

202 
bŒfs_drİ_ex‹Ás_¬gs
 *
¬gs
)

204 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

205 
ex‹Á_bufãr
 *
Ëaf
;

206 
bŒfs_fe_ex‹Á_™em
 *
fi
;

207 
bŒfs_»f
 
»f
 = { 0 };

208 
bŒfs_key
 
key
;

209 
bŒfs_key
 
Ãw_key
;

210 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

211 
u64
 
£¬ch_¡¬t
 = 
¬gs
->
¡¬t
;

212 
u64
 
disk_by‹Ä
 = 0;

213 
u64
 
num_by‹s
 = 0;

214 
u64
 
ex‹Á_off£t
 = 0;

215 
u64
 
ex‹Á_’d
 = 0;

216 
u64
 
Ï¡_’d
 = 
¬gs
->
¡¬t
;

217 
d–_Ä
 = 0;

218 
d–_¦Ù
 = 0;

219 
ex‹Á_ty³
;

220 
»cow
;

221 
»t
;

222 
modify_Œ“
 = -1;

223 
upd©e_»fs
;

224 
found
 = 0;

225 
bŒfs_·th
 *
·th
 = 
¬gs
->path;

227 
¬gs
->
by‹s_found
 = 0;

228 
¬gs
->
ex‹Á_š£¹ed
 = 
çl£
;

231 
	`ASSERT
(!(
¬gs
->
»¶aû_ex‹Á
 && !¬gs->
·th
));

233 ià(!
·th
) {

234 
·th
 = 
	`bŒfs_®loc_·th
();

235 ià(!
·th
) {

236 
»t
 = -
ENOMEM
;

237 
out
;

241 ià(
¬gs
->
drİ_ÿche
)

242 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
šode
, 
¬gs
->
¡¬t
,‡rgs->
’d
 - 1, 
çl£
);

244 ià(
¬gs
->
¡¬t
 >ğ
šode
->
disk_i_size
 && !¬gs->
»¶aû_ex‹Á
)

245 
modify_Œ“
 = 0;

247 
upd©e_»fs
 = (
roÙ
->
roÙ_key
.
objeùid
 !ğ
BTRFS_TREE_LOG_OBJECTID
);

249 
»cow
 = 0;

250 
»t
 = 
	`bŒfs_lookup_fe_ex‹Á
(
Œªs
, 
roÙ
, 
·th
, 
šo
,

251 
£¬ch_¡¬t
, 
modify_Œ“
);

252 ià(
»t
 < 0)

254 ià(
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0 && 
£¬ch_¡¬t
 =ğ
¬gs
->
¡¬t
) {

255 
Ëaf
 = 
·th
->
nodes
[0];

256 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0] - 1);

257 ià(
key
.
objeùid
 =ğ
šo
 &&

258 
key
.
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
)

259 
·th
->
¦Ùs
[0]--;

261 
»t
 = 0;

262 
Ãxt_¦Ù
:

263 
Ëaf
 = 
·th
->
nodes
[0];

264 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

265 
	`BUG_ON
(
d–_Ä
 > 0);

266 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

267 ià(
»t
 < 0)

269 ià(
»t
 > 0) {

270 
»t
 = 0;

273 
Ëaf
 = 
·th
->
nodes
[0];

274 
»cow
 = 1;

277 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

279 ià(
key
.
objeùid
 > 
šo
)

281 ià(
	`WARN_ON_ONCE
(
key
.
objeùid
 < 
šo
) ||

282 
key
.
ty³
 < 
BTRFS_EXTENT_DATA_KEY
) {

283 
	`ASSERT
(
d–_Ä
 == 0);

284 
·th
->
¦Ùs
[0]++;

285 
Ãxt_¦Ù
;

287 ià(
key
.
ty³
 > 
BTRFS_EXTENT_DATA_KEY
 || key.
off£t
 >ğ
¬gs
->
’d
)

290 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

291 
bŒfs_fe_ex‹Á_™em
);

292 
ex‹Á_ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
fi
);

294 ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_REG
 ||

295 
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
) {

296 
disk_by‹Ä
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
);

297 
num_by‹s
 = 
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
);

298 
ex‹Á_off£t
 = 
	`bŒfs_fe_ex‹Á_off£t
(
Ëaf
, 
fi
);

299 
ex‹Á_’d
 = 
key
.
off£t
 +

300 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

301 } ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
) {

302 
ex‹Á_’d
 = 
key
.
off£t
 +

303 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
);

306 
	`BUG
();

318 ià(
ex‹Á_’d
 =ğ
key
.
off£t
 &&ƒx‹Á_’d >ğ
£¬ch_¡¬t
) {

319 
Ï¡_’d
 = 
ex‹Á_’d
;

320 
d–‘e_ex‹Á_™em
;

323 ià(
ex‹Á_’d
 <ğ
£¬ch_¡¬t
) {

324 
·th
->
¦Ùs
[0]++;

325 
Ãxt_¦Ù
;

328 
found
 = 1;

329 
£¬ch_¡¬t
 = 
	`max
(
key
.
off£t
, 
¬gs
->
¡¬t
);

330 ià(
»cow
 || !
modify_Œ“
) {

331 
modify_Œ“
 = -1;

332 
	`bŒfs_»Ëa£_·th
(
·th
);

340 ià(
¬gs
->
¡¬t
 > 
key
.
off£t
 &&‡rgs->
’d
 < 
ex‹Á_’d
) {

341 
	`BUG_ON
(
d–_Ä
 > 0);

342 ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
) {

343 
»t
 = -
EOPNOTSUPP
;

347 
	`memıy
(&
Ãw_key
, &
key
, (new_key));

348 
Ãw_key
.
off£t
 = 
¬gs
->
¡¬t
;

349 
»t
 = 
	`bŒfs_du¶iÿ‹_™em
(
Œªs
, 
roÙ
, 
·th
,

350 &
Ãw_key
);

351 ià(
»t
 =ğ-
EAGAIN
) {

352 
	`bŒfs_»Ëa£_·th
(
·th
);

355 ià(
»t
 < 0)

358 
Ëaf
 = 
·th
->
nodes
[0];

359 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1,

360 
bŒfs_fe_ex‹Á_™em
);

361 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

362 
¬gs
->
¡¬t
 - 
key
.
off£t
);

364 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

365 
bŒfs_fe_ex‹Á_™em
);

367 
ex‹Á_off£t
 +ğ
¬gs
->
¡¬t
 - 
key
.
off£t
;

368 
	`bŒfs_£t_fe_ex‹Á_off£t
(
Ëaf
, 
fi
, 
ex‹Á_off£t
);

369 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

370 
ex‹Á_’d
 - 
¬gs
->
¡¬t
);

371 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

373 ià(
upd©e_»fs
 && 
disk_by‹Ä
 > 0) {

374 
	`bŒfs_š™_g’”ic_»f
(&
»f
,

375 
BTRFS_ADD_DELAYED_REF
,

376 
disk_by‹Ä
, 
num_by‹s
, 0);

377 
	`bŒfs_š™_d©a_»f
(&
»f
,

378 
roÙ
->
roÙ_key
.
objeùid
,

379 
Ãw_key
.
objeùid
,

380 
¬gs
->
¡¬t
 - 
ex‹Á_off£t
,

381 0, 
çl£
);

382 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, &
»f
);

383 ià(
»t
) {

384 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

388 
key
.
off£t
 = 
¬gs
->
¡¬t
;

394 
Ï¡_’d
 = 
ex‹Á_’d
;

400 ià(
¬gs
->
¡¬t
 <ğ
key
.
off£t
 &&‡rgs->
’d
 < 
ex‹Á_’d
) {

401 ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
) {

402 
»t
 = -
EOPNOTSUPP
;

406 
	`memıy
(&
Ãw_key
, &
key
, (new_key));

407 
Ãw_key
.
off£t
 = 
¬gs
->
’d
;

408 
	`bŒfs_£t_™em_key_§ã
(
Œªs
, 
·th
, &
Ãw_key
);

410 
ex‹Á_off£t
 +ğ
¬gs
->
’d
 - 
key
.
off£t
;

411 
	`bŒfs_£t_fe_ex‹Á_off£t
(
Ëaf
, 
fi
, 
ex‹Á_off£t
);

412 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

413 
ex‹Á_’d
 - 
¬gs
->
’d
);

414 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

415 ià(
upd©e_»fs
 && 
disk_by‹Ä
 > 0)

416 
¬gs
->
by‹s_found
 +ğ¬gs->
’d
 - 
key
.
off£t
;

420 
£¬ch_¡¬t
 = 
ex‹Á_’d
;

425 ià(
¬gs
->
¡¬t
 > 
key
.
off£t
 &&‡rgs->
’d
 >ğ
ex‹Á_’d
) {

426 
	`BUG_ON
(
d–_Ä
 > 0);

427 ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
) {

428 
»t
 = -
EOPNOTSUPP
;

432 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

433 
¬gs
->
¡¬t
 - 
key
.
off£t
);

434 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

435 ià(
upd©e_»fs
 && 
disk_by‹Ä
 > 0)

436 
¬gs
->
by‹s_found
 +ğ
ex‹Á_’d
 -‡rgs->
¡¬t
;

437 ià(
¬gs
->
’d
 =ğ
ex‹Á_’d
)

440 
·th
->
¦Ùs
[0]++;

441 
Ãxt_¦Ù
;

448 ià(
¬gs
->
¡¬t
 <ğ
key
.
off£t
 &&‡rgs->
’d
 >ğ
ex‹Á_’d
) {

449 
d–‘e_ex‹Á_™em
:

450 ià(
d–_Ä
 == 0) {

451 
d–_¦Ù
 = 
·th
->
¦Ùs
[0];

452 
d–_Ä
 = 1;

454 
	`BUG_ON
(
d–_¦Ù
 + 
d–_Ä
 !ğ
·th
->
¦Ùs
[0]);

455 
d–_Ä
++;

458 ià(
upd©e_»fs
 &&

459 
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
) {

460 
¬gs
->
by‹s_found
 +ğ
ex‹Á_’d
 - 
key
.
off£t
;

461 
ex‹Á_’d
 = 
	`ALIGN
(extent_end,

462 
fs_šfo
->
£ùÜsize
);

463 } ià(
upd©e_»fs
 && 
disk_by‹Ä
 > 0) {

464 
	`bŒfs_š™_g’”ic_»f
(&
»f
,

465 
BTRFS_DROP_DELAYED_REF
,

466 
disk_by‹Ä
, 
num_by‹s
, 0);

467 
	`bŒfs_š™_d©a_»f
(&
»f
,

468 
roÙ
->
roÙ_key
.
objeùid
,

469 
key
.
objeùid
,

470 
key
.
off£t
 - 
ex‹Á_off£t
, 0,

471 
çl£
);

472 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, &
»f
);

473 ià(
»t
) {

474 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

477 
¬gs
->
by‹s_found
 +ğ
ex‹Á_’d
 - 
key
.
off£t
;

480 ià(
¬gs
->
’d
 =ğ
ex‹Á_’d
)

483 ià(
·th
->
¦Ùs
[0] + 1 < 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

484 
·th
->
¦Ùs
[0]++;

485 
Ãxt_¦Ù
;

488 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
, 
d–_¦Ù
,

489 
d–_Ä
);

490 ià(
»t
) {

491 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

495 
d–_Ä
 = 0;

496 
d–_¦Ù
 = 0;

498 
	`bŒfs_»Ëa£_·th
(
·th
);

502 
	`BUG
();

505 ià(!
»t
 && 
d–_Ä
 > 0) {

512 
·th
->
¦Ùs
[0] = 
d–_¦Ù
;

513 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
, 
d–_¦Ù
, 
d–_Ä
);

514 ià(
»t
)

515 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

518 
Ëaf
 = 
·th
->
nodes
[0];

524 ià(!
»t
 && 
¬gs
->
»¶aû_ex‹Á
 &&

525 
·th
->
locks
[0] =ğ
BTRFS_WRITE_LOCK
 &&

526 
	`bŒfs_Ëaf_ä“_¥aû
(
Ëaf
) >=

527 (
bŒfs_™em
è+ 
¬gs
->
ex‹Á_™em_size
) {

529 
key
.
objeùid
 = 
šo
;

530 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

531 
key
.
off£t
 = 
¬gs
->
¡¬t
;

532 ià(!
d–_Ä
 && 
·th
->
¦Ùs
[0] < 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

533 
bŒfs_key
 
¦Ù_key
;

535 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
¦Ù_key
, 
·th
->
¦Ùs
[0]);

536 ià(
	`bŒfs_comp_ıu_keys
(&
key
, &
¦Ù_key
) > 0)

537 
·th
->
¦Ùs
[0]++;

539 
	`bŒfs_£tup_™em_fÜ_š£¹
(
Œªs
, 
roÙ
, 
·th
, &
key
,

540 
¬gs
->
ex‹Á_™em_size
);

541 
¬gs
->
ex‹Á_š£¹ed
 = 
Œue
;

544 ià(!
¬gs
->
·th
)

545 
	`bŒfs_ä“_·th
(
·th
);

546 ià(!
¬gs
->
ex‹Á_š£¹ed
)

547 
	`bŒfs_»Ëa£_·th
(
·th
);

548 
out
:

549 
¬gs
->
drİ_’d
 = 
found
 ? 
	`mš
×rgs->
’d
, 
Ï¡_’d
) :‡rgs->end;

551  
»t
;

552 
	}
}

554 
	$ex‹Á_m”g—bË
(
ex‹Á_bufãr
 *
Ëaf
, 
¦Ù
,

555 
u64
 
objeùid
, u64 
by‹Ä
, u64 
Üig_off£t
,

556 
u64
 *
¡¬t
, u64 *
’d
)

558 
bŒfs_fe_ex‹Á_™em
 *
fi
;

559 
bŒfs_key
 
key
;

560 
u64
 
ex‹Á_’d
;

562 ià(
¦Ù
 < 0 || slÙ >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
))

565 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

566 ià(
key
.
objeùid
 !ğobjeùid || key.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

569 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_fe_ex‹Á_™em
);

570 ià(
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
fi
è!ğ
BTRFS_FILE_EXTENT_REG
 ||

571 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
è!ğ
by‹Ä
 ||

572 
	`bŒfs_fe_ex‹Á_off£t
(
Ëaf
, 
fi
è!ğ
key
.
off£t
 - 
Üig_off£t
 ||

573 
	`bŒfs_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
) ||

574 
	`bŒfs_fe_ex‹Á_’üy±iÚ
(
Ëaf
, 
fi
) ||

575 
	`bŒfs_fe_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
fi
))

578 
ex‹Á_’d
 = 
key
.
off£t
 + 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

579 ià((*
¡¬t
 && *¡¬ˆ!ğ
key
.
off£t
è|| (*
’d
 && *’d !ğ
ex‹Á_’d
))

582 *
¡¬t
 = 
key
.
off£t
;

583 *
’d
 = 
ex‹Á_’d
;

585 
	}
}

594 
	$bŒfs_m¬k_ex‹Á_wr™‹n
(
bŒfs_Œªs_hªdË
 *
Œªs
,

595 
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
)

597 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

598 
ex‹Á_bufãr
 *
Ëaf
;

599 
bŒfs_·th
 *
·th
;

600 
bŒfs_fe_ex‹Á_™em
 *
fi
;

601 
bŒfs_»f
 
»f
 = { 0 };

602 
bŒfs_key
 
key
;

603 
bŒfs_key
 
Ãw_key
;

604 
u64
 
by‹Ä
;

605 
u64
 
num_by‹s
;

606 
u64
 
ex‹Á_’d
;

607 
u64
 
Üig_off£t
;

608 
u64
 
Ùh”_¡¬t
;

609 
u64
 
Ùh”_’d
;

610 
u64
 
¥l™
;

611 
d–_Ä
 = 0;

612 
d–_¦Ù
 = 0;

613 
»cow
;

614 
»t
 = 0;

615 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

617 
·th
 = 
	`bŒfs_®loc_·th
();

618 ià(!
·th
)

619  -
ENOMEM
;

620 
agaš
:

621 
»cow
 = 0;

622 
¥l™
 = 
¡¬t
;

623 
key
.
objeùid
 = 
šo
;

624 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

625 
key
.
off£t
 = 
¥l™
;

627 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

628 ià(
»t
 < 0)

629 
out
;

630 ià(
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0)

631 
·th
->
¦Ùs
[0]--;

633 
Ëaf
 = 
·th
->
nodes
[0];

634 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

635 ià(
key
.
objeùid
 !ğ
šo
 ||

636 
key
.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
) {

637 
»t
 = -
EINVAL
;

638 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

639 
out
;

641 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

642 
bŒfs_fe_ex‹Á_™em
);

643 ià(
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
fi
è!ğ
BTRFS_FILE_EXTENT_PREALLOC
) {

644 
»t
 = -
EINVAL
;

645 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

646 
out
;

648 
ex‹Á_’d
 = 
key
.
off£t
 + 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

649 ià(
key
.
off£t
 > 
¡¬t
 || 
ex‹Á_’d
 < 
’d
) {

650 
»t
 = -
EINVAL
;

651 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

652 
out
;

655 
by‹Ä
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
);

656 
num_by‹s
 = 
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
);

657 
Üig_off£t
 = 
key
.
off£t
 - 
	`bŒfs_fe_ex‹Á_off£t
(
Ëaf
, 
fi
);

658 
	`memıy
(&
Ãw_key
, &
key
, (new_key));

660 ià(
¡¬t
 =ğ
key
.
off£t
 && 
’d
 < 
ex‹Á_’d
) {

661 
Ùh”_¡¬t
 = 0;

662 
Ùh”_’d
 = 
¡¬t
;

663 ià(
	`ex‹Á_m”g—bË
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1,

664 
šo
, 
by‹Ä
, 
Üig_off£t
,

665 &
Ùh”_¡¬t
, &
Ùh”_’d
)) {

666 
Ãw_key
.
off£t
 = 
’d
;

667 
	`bŒfs_£t_™em_key_§ã
(
Œªs
, 
·th
, &
Ãw_key
);

668 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

669 
bŒfs_fe_ex‹Á_™em
);

670 
	`bŒfs_£t_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
,

671 
Œªs
->
Œªsid
);

672 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

673 
ex‹Á_’d
 - 
’d
);

674 
	`bŒfs_£t_fe_ex‹Á_off£t
(
Ëaf
, 
fi
,

675 
’d
 - 
Üig_off£t
);

676 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1,

677 
bŒfs_fe_ex‹Á_™em
);

678 
	`bŒfs_£t_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
,

679 
Œªs
->
Œªsid
);

680 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

681 
’d
 - 
Ùh”_¡¬t
);

682 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

683 
out
;

687 ià(
¡¬t
 > 
key
.
off£t
 && 
’d
 =ğ
ex‹Á_’d
) {

688 
Ùh”_¡¬t
 = 
’d
;

689 
Ùh”_’d
 = 0;

690 ià(
	`ex‹Á_m”g—bË
(
Ëaf
, 
·th
->
¦Ùs
[0] + 1,

691 
šo
, 
by‹Ä
, 
Üig_off£t
,

692 &
Ùh”_¡¬t
, &
Ùh”_’d
)) {

693 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

694 
bŒfs_fe_ex‹Á_™em
);

695 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

696 
¡¬t
 - 
key
.
off£t
);

697 
	`bŒfs_£t_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
,

698 
Œªs
->
Œªsid
);

699 
·th
->
¦Ùs
[0]++;

700 
Ãw_key
.
off£t
 = 
¡¬t
;

701 
	`bŒfs_£t_™em_key_§ã
(
Œªs
, 
·th
, &
Ãw_key
);

703 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

704 
bŒfs_fe_ex‹Á_™em
);

705 
	`bŒfs_£t_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
,

706 
Œªs
->
Œªsid
);

707 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

708 
Ùh”_’d
 - 
¡¬t
);

709 
	`bŒfs_£t_fe_ex‹Á_off£t
(
Ëaf
, 
fi
,

710 
¡¬t
 - 
Üig_off£t
);

711 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

712 
out
;

716 
¡¬t
 > 
key
.
off£t
 || 
’d
 < 
ex‹Á_’d
) {

717 ià(
key
.
off£t
 =ğ
¡¬t
)

718 
¥l™
 = 
’d
;

720 
Ãw_key
.
off£t
 = 
¥l™
;

721 
»t
 = 
	`bŒfs_du¶iÿ‹_™em
(
Œªs
, 
roÙ
, 
·th
, &
Ãw_key
);

722 ià(
»t
 =ğ-
EAGAIN
) {

723 
	`bŒfs_»Ëa£_·th
(
·th
);

724 
agaš
;

726 ià(
»t
 < 0) {

727 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

728 
out
;

731 
Ëaf
 = 
·th
->
nodes
[0];

732 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1,

733 
bŒfs_fe_ex‹Á_™em
);

734 
	`bŒfs_£t_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
, 
Œªs
->
Œªsid
);

735 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

736 
¥l™
 - 
key
.
off£t
);

738 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

739 
bŒfs_fe_ex‹Á_™em
);

741 
	`bŒfs_£t_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
, 
Œªs
->
Œªsid
);

742 
	`bŒfs_£t_fe_ex‹Á_off£t
(
Ëaf
, 
fi
, 
¥l™
 - 
Üig_off£t
);

743 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

744 
ex‹Á_’d
 - 
¥l™
);

745 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

747 
	`bŒfs_š™_g’”ic_»f
(&
»f
, 
BTRFS_ADD_DELAYED_REF
, 
by‹Ä
,

748 
num_by‹s
, 0);

749 
	`bŒfs_š™_d©a_»f
(&
»f
, 
roÙ
->
roÙ_key
.
objeùid
, 
šo
,

750 
Üig_off£t
, 0, 
çl£
);

751 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, &
»f
);

752 ià(
»t
) {

753 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

754 
out
;

757 ià(
¥l™
 =ğ
¡¬t
) {

758 
key
.
off£t
 = 
¡¬t
;

760 ià(
¡¬t
 !ğ
key
.
off£t
) {

761 
»t
 = -
EINVAL
;

762 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

763 
out
;

765 
·th
->
¦Ùs
[0]--;

766 
ex‹Á_’d
 = 
’d
;

768 
»cow
 = 1;

771 
Ùh”_¡¬t
 = 
’d
;

772 
Ùh”_’d
 = 0;

773 
	`bŒfs_š™_g’”ic_»f
(&
»f
, 
BTRFS_DROP_DELAYED_REF
, 
by‹Ä
,

774 
num_by‹s
, 0);

775 
	`bŒfs_š™_d©a_»f
(&
»f
, 
roÙ
->
roÙ_key
.
objeùid
, 
šo
, 
Üig_off£t
,

776 0, 
çl£
);

777 ià(
	`ex‹Á_m”g—bË
(
Ëaf
, 
·th
->
¦Ùs
[0] + 1,

778 
šo
, 
by‹Ä
, 
Üig_off£t
,

779 &
Ùh”_¡¬t
, &
Ùh”_’d
)) {

780 ià(
»cow
) {

781 
	`bŒfs_»Ëa£_·th
(
·th
);

782 
agaš
;

784 
ex‹Á_’d
 = 
Ùh”_’d
;

785 
d–_¦Ù
 = 
·th
->
¦Ùs
[0] + 1;

786 
d–_Ä
++;

787 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, &
»f
);

788 ià(
»t
) {

789 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

790 
out
;

793 
Ùh”_¡¬t
 = 0;

794 
Ùh”_’d
 = 
¡¬t
;

795 ià(
	`ex‹Á_m”g—bË
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1,

796 
šo
, 
by‹Ä
, 
Üig_off£t
,

797 &
Ùh”_¡¬t
, &
Ùh”_’d
)) {

798 ià(
»cow
) {

799 
	`bŒfs_»Ëa£_·th
(
·th
);

800 
agaš
;

802 
key
.
off£t
 = 
Ùh”_¡¬t
;

803 
d–_¦Ù
 = 
·th
->
¦Ùs
[0];

804 
d–_Ä
++;

805 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, &
»f
);

806 ià(
»t
) {

807 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

808 
out
;

811 ià(
d–_Ä
 == 0) {

812 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

813 
bŒfs_fe_ex‹Á_™em
);

814 
	`bŒfs_£t_fe_ex‹Á_ty³
(
Ëaf
, 
fi
,

815 
BTRFS_FILE_EXTENT_REG
);

816 
	`bŒfs_£t_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
, 
Œªs
->
Œªsid
);

817 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

819 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
d–_¦Ù
 - 1,

820 
bŒfs_fe_ex‹Á_™em
);

821 
	`bŒfs_£t_fe_ex‹Á_ty³
(
Ëaf
, 
fi
,

822 
BTRFS_FILE_EXTENT_REG
);

823 
	`bŒfs_£t_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
, 
Œªs
->
Œªsid
);

824 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

825 
ex‹Á_’d
 - 
key
.
off£t
);

826 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

828 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
, 
d–_¦Ù
, 
d–_Ä
);

829 ià(
»t
 < 0) {

830 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

831 
out
;

834 
out
:

835 
	`bŒfs_ä“_·th
(
·th
);

836  
»t
;

837 
	}
}

843 
	$´•¬e_u±od©e_·ge
(
šode
 *inode,

844 
·ge
 *·ge, 
u64
 
pos
,

845 
boŞ
 
fÜû_u±od©e
)

847 
fŞio
 *fŞiØğ
	`·ge_fŞio
(
·ge
);

848 
»t
 = 0;

850 ià(((
pos
 & (
PAGE_SIZE
 - 1)è|| 
fÜû_u±od©e
) &&

851 !
	`PageU±od©e
(
·ge
)) {

852 
»t
 = 
	`bŒfs_»ad_fŞio
(
NULL
, 
fŞio
);

853 ià(
»t
)

854  
»t
;

855 
	`lock_·ge
(
·ge
);

856 ià(!
	`PageU±od©e
(
·ge
)) {

857 
	`uÆock_·ge
(
·ge
);

858  -
EIO
;

871 ià(
·ge
->
m­pšg
 !ğ
šode
->
i_m­pšg
 || !
	`PagePriv©e
(page)) {

872 
	`uÆock_·ge
(
·ge
);

873  -
EAGAIN
;

877 
	}
}

879 
fgf_t
 
	$g‘_´•¬e_fgp_æags
(
boŞ
 
nowa™
)

881 
fgf_t
 
fgp_æags
 = 
FGP_LOCK
 | 
FGP_ACCESSED
 | 
FGP_CREAT
;

883 ià(
nowa™
)

884 
fgp_æags
 |ğ
FGP_NOWAIT
;

886  
fgp_æags
;

887 
	}
}

889 
gå_t
 
	$g‘_´•¬e_gå_æags
(
šode
 *šode, 
boŞ
 
nowa™
)

891 
gå_t
 
gå
;

893 
gå
 = 
	`bŒfs_®loc_wr™e_mask
(
šode
->
i_m­pšg
);

894 ià(
nowa™
) {

895 
gå
 &ğ~
__GFP_DIRECT_RECLAIM
;

896 
gå
 |ğ
GFP_NOWAIT
;

899  
gå
;

900 
	}
}

905 
nošlše
 
	$´•¬e_·ges
(
šode
 *šode, 
·ge
 **
·ges
,

906 
size_t
 
num_·ges
, 
loff_t
 
pos
,

907 
size_t
 
wr™e_by‹s
, 
boŞ
 
fÜû_u±od©e
,

908 
boŞ
 
nowa™
)

910 
i
;

911 
šdex
 = 
pos
 >> 
PAGE_SHIFT
;

912 
gå_t
 
mask
 = 
	`g‘_´•¬e_gå_æags
(
šode
, 
nowa™
);

913 
fgf_t
 
fgp_æags
 = 
	`g‘_´•¬e_fgp_æags
(
nowa™
);

914 
”r
 = 0;

915 
çi
;

917 
i
 = 0; i < 
num_·ges
; i++) {

918 
agaš
:

919 
·ges
[
i
] = 
	`·geÿche_g‘_·ge
(
šode
->
i_m­pšg
, 
šdex
 + i,

920 
fgp_æags
, 
mask
 | 
__GFP_WRITE
);

921 ià(!
·ges
[
i
]) {

922 
çi
 = 
i
 - 1;

923 ià(
nowa™
)

924 
”r
 = -
EAGAIN
;

926 
”r
 = -
ENOMEM
;

927 
ç
;

930 
”r
 = 
	`£t_·ge_ex‹Á_m­³d
(
·ges
[
i
]);

931 ià(
”r
 < 0) {

932 
çi
 = 
i
;

933 
ç
;

936 ià(
i
 == 0)

937 
”r
 = 
	`´•¬e_u±od©e_·ge
(
šode
, 
·ges
[
i
], 
pos
,

938 
fÜû_u±od©e
);

939 ià(!
”r
 && 
i
 =ğ
num_·ges
 - 1)

940 
”r
 = 
	`´•¬e_u±od©e_·ge
(
šode
, 
·ges
[
i
],

941 
pos
 + 
wr™e_by‹s
, 
çl£
);

942 ià(
”r
) {

943 
	`put_·ge
(
·ges
[
i
]);

944 ià(!
nowa™
 && 
”r
 =ğ-
EAGAIN
) {

945 
”r
 = 0;

946 
agaš
;

948 
çi
 = 
i
 - 1;

949 
ç
;

951 
	`wa™_Ú_·ge_wr™eback
(
·ges
[
i
]);

955 
ç
:

956 
çi
 >= 0) {

957 
	`uÆock_·ge
(
·ges
[
çi
]);

958 
	`put_·ge
(
·ges
[
çi
]);

959 
çi
--;

961  
”r
;

963 
	}
}

975 
nošlše
 

976 
	$lock_ªd_ş—nup_ex‹Á_if_Ãed
(
bŒfs_šode
 *
šode
, 
·ge
 **
·ges
,

977 
size_t
 
num_·ges
, 
loff_t
 
pos
,

978 
size_t
 
wr™e_by‹s
,

979 
u64
 *
lock¡¬t
, u64 *
lock’d
, 
boŞ
 
nowa™
,

980 
ex‹Á_¡©e
 **
ÿched_¡©e
)

982 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

983 
u64
 
¡¬t_pos
;

984 
u64
 
Ï¡_pos
;

985 
i
;

986 
»t
 = 0;

988 
¡¬t_pos
 = 
	`round_down
(
pos
, 
fs_šfo
->
£ùÜsize
);

989 
Ï¡_pos
 = 
	`round_up
(
pos
 + 
wr™e_by‹s
, 
fs_šfo
->
£ùÜsize
) - 1;

991 ià(
¡¬t_pos
 < 
šode
->
vfs_šode
.
i_size
) {

992 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

994 ià(
nowa™
) {

995 ià(!
	`Œy_lock_ex‹Á
(&
šode
->
io_Œ“
, 
¡¬t_pos
, 
Ï¡_pos
,

996 
ÿched_¡©e
)) {

997 
i
 = 0; i < 
num_·ges
; i++) {

998 
	`uÆock_·ge
(
·ges
[
i
]);

999 
	`put_·ge
(
·ges
[
i
]);

1000 
·ges
[
i
] = 
NULL
;

1003  -
EAGAIN
;

1006 
	`lock_ex‹Á
(&
šode
->
io_Œ“
, 
¡¬t_pos
, 
Ï¡_pos
, 
ÿched_¡©e
);

1009 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
šode
, 
¡¬t_pos
,

1010 
Ï¡_pos
 - 
¡¬t_pos
 + 1);

1011 ià(
Üd”ed
 &&

1012 
Üd”ed
->
fe_off£t
 + ord”ed->
num_by‹s
 > 
¡¬t_pos
 &&

1013 
Üd”ed
->
fe_off£t
 <ğ
Ï¡_pos
) {

1014 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
¡¬t_pos
, 
Ï¡_pos
,

1015 
ÿched_¡©e
);

1016 
i
 = 0; i < 
num_·ges
; i++) {

1017 
	`uÆock_·ge
(
·ges
[
i
]);

1018 
	`put_·ge
(
·ges
[
i
]);

1020 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
Üd”ed
);

1021 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

1022  -
EAGAIN
;

1024 ià(
Üd”ed
)

1025 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

1027 *
lock¡¬t
 = 
¡¬t_pos
;

1028 *
lock’d
 = 
Ï¡_pos
;

1029 
»t
 = 1;

1036 
i
 = 0; i < 
num_·ges
; i++)

1037 
	`WARN_ON
(!
	`PageLocked
(
·ges
[
i
]));

1039  
»t
;

1040 
	}
}

1061 
	$bŒfs_check_nocow_lock
(
bŒfs_šode
 *
šode
, 
loff_t
 
pos
,

1062 
size_t
 *
wr™e_by‹s
, 
boŞ
 
nowa™
)

1064 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

1065 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

1066 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

1067 
u64
 
lock¡¬t
, 
lock’d
;

1068 
u64
 
num_by‹s
;

1069 
»t
;

1071 ià(!(
šode
->
æags
 & (
BTRFS_INODE_NODATACOW
 | 
BTRFS_INODE_PREALLOC
)))

1074 ià(!
	`bŒfs_d»w_Œy_wr™e_lock
(&
roÙ
->
¢­shÙ_lock
))

1075  -
EAGAIN
;

1077 
lock¡¬t
 = 
	`round_down
(
pos
, 
fs_šfo
->
£ùÜsize
);

1078 
lock’d
 = 
	`round_up
(
pos
 + *
wr™e_by‹s
,

1079 
fs_šfo
->
£ùÜsize
) - 1;

1080 
num_by‹s
 = 
lock’d
 - 
lock¡¬t
 + 1;

1082 ià(
nowa™
) {

1083 ià(!
	`bŒfs_Œy_lock_Üd”ed_¿nge
(
šode
, 
lock¡¬t
, 
lock’d
,

1084 &
ÿched_¡©e
)) {

1085 
	`bŒfs_d»w_wr™e_uÆock
(&
roÙ
->
¢­shÙ_lock
);

1086  -
EAGAIN
;

1089 
	`bŒfs_lock_ªd_æush_Üd”ed_¿nge
(
šode
, 
lock¡¬t
, 
lock’d
,

1090 &
ÿched_¡©e
);

1092 
»t
 = 
	`ÿn_nocow_ex‹Á
(&
šode
->
vfs_šode
, 
lock¡¬t
, &
num_by‹s
,

1093 
NULL
, NULL, NULL, 
nowa™
, 
çl£
);

1094 ià(
»t
 <= 0)

1095 
	`bŒfs_d»w_wr™e_uÆock
(&
roÙ
->
¢­shÙ_lock
);

1097 *
wr™e_by‹s
 = 
	`mš_t
(
size_t
, *write_bytes ,

1098 
num_by‹s
 - 
pos
 + 
lock¡¬t
);

1099 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
lock¡¬t
, 
lock’d
, &
ÿched_¡©e
);

1101  
»t
;

1102 
	}
}

1104 
	$bŒfs_check_nocow_uÆock
(
bŒfs_šode
 *
šode
)

1106 
	`bŒfs_d»w_wr™e_uÆock
(&
šode
->
roÙ
->
¢­shÙ_lock
);

1107 
	}
}

1109 
	$upd©e_time_fÜ_wr™e
(
šode
 *inode)

1111 
time¥ec64
 
now
, 
ùime
;

1113 ià(
	`IS_NOCMTIME
(
šode
))

1116 
now
 = 
	`cu¼’t_time
(
šode
);

1117 ià(!
	`time¥ec64_equ®
(&
šode
->
i_mtime
, &
now
))

1118 
šode
->
i_mtime
 = 
now
;

1120 
ùime
 = 
	`šode_g‘_ùime
(
šode
);

1121 ià(!
	`time¥ec64_equ®
(&
ùime
, &
now
))

1122 
	`šode_£t_ùime_to_ts
(
šode
, 
now
);

1124 ià(
	`IS_I_VERSION
(
šode
))

1125 
	`šode_šc_iv”siÚ
(
šode
);

1126 
	}
}

1128 
	$bŒfs_wr™e_check
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
,

1129 
size_t
 
couÁ
)

1131 
fe
 *fğ
iocb
->
ki_fp
;

1132 
šode
 *šodğ
	`fe_šode
(
fe
);

1133 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1134 
loff_t
 
pos
 = 
iocb
->
ki_pos
;

1135 
»t
;

1136 
loff_t
 
Şdsize
;

1137 
loff_t
 
¡¬t_pos
;

1145 ià((
iocb
->
ki_æags
 & 
IOCB_NOWAIT
) &&

1146 !(
	`BTRFS_I
(
šode
)->
æags
 & (
BTRFS_INODE_NODATACOW
 | 
BTRFS_INODE_PREALLOC
)))

1147  -
EAGAIN
;

1149 
»t
 = 
	`fe_»move_´ivs
(
fe
);

1150 ià(
»t
)

1151  
»t
;

1159 
	`upd©e_time_fÜ_wr™e
(
šode
);

1161 
¡¬t_pos
 = 
	`round_down
(
pos
, 
fs_šfo
->
£ùÜsize
);

1162 
Şdsize
 = 
	`i_size_»ad
(
šode
);

1163 ià(
¡¬t_pos
 > 
Şdsize
) {

1165 
loff_t
 
’d_pos
 = 
	`round_up
(
pos
 + 
couÁ
, 
fs_šfo
->
£ùÜsize
);

1167 
»t
 = 
	`bŒfs_cÚt_ex·nd
(
	`BTRFS_I
(
šode
), 
Şdsize
, 
’d_pos
);

1168 ià(
»t
)

1169  
»t
;

1173 
	}
}

1175 
nošlše
 
ssize_t
 
	$bŒfs_bufã»d_wr™e
(
kiocb
 *
iocb
,

1176 
iov_™”
 *
i
)

1178 
fe
 *fğ
iocb
->
ki_fp
;

1179 
loff_t
 
pos
;

1180 
šode
 *šodğ
	`fe_šode
(
fe
);

1181 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1182 
·ge
 **
·ges
 = 
NULL
;

1183 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

1184 
u64
 
»Ëa£_by‹s
 = 0;

1185 
u64
 
lock¡¬t
;

1186 
u64
 
lock’d
;

1187 
size_t
 
num_wr™‹n
 = 0;

1188 
Ä±rs
;

1189 
ssize_t
 
»t
;

1190 
boŞ
 
Úly_»Ëa£_m‘ad©a
 = 
çl£
;

1191 
boŞ
 
fÜû_·ge_u±od©e
 = 
çl£
;

1192 
loff_t
 
Şd_isize
 = 
	`i_size_»ad
(
šode
);

1193 
ock_æags
 = 0;

1194 cÚ¡ 
boŞ
 
nowa™
 = (
iocb
->
ki_æags
 & 
IOCB_NOWAIT
);

1195 
bdp_æags
 = (
nowa™
 ? 
BDP_ASYNC
 : 0);

1197 ià(
nowa™
)

1198 
ock_æags
 |ğ
BTRFS_ILOCK_TRY
;

1201 
»t
 = 
	`bŒfs_šode_lock
(
	`BTRFS_I
(
šode
), 
ock_æags
);

1202 ià(
»t
 < 0)

1203  
»t
;

1213 
»t
 = 
	`g’”ic_wr™e_checks
(
iocb
, 
i
);

1214 ià(
»t
 <= 0)

1215 
out
;

1217 
»t
 = 
	`bŒfs_wr™e_check
(
iocb
, 
i
,„et);

1218 ià(
»t
 < 0)

1219 
out
;

1221 
pos
 = 
iocb
->
ki_pos
;

1222 
Ä±rs
 = 
	`mš
(
	`DIV_ROUND_UP
(
	`iov_™”_couÁ
(
i
), 
PAGE_SIZE
),

1223 
PAGE_SIZE
 / ((
·ge
 *)));

1224 
Ä±rs
 = 
	`mš
Ò½Œs, 
cu¼’t
->
Ä_dœt›d_·u£
 - cu¼’t->
Ä_dœt›d
);

1225 
Ä±rs
 = 
	`max
(nrptrs, 8);

1226 
·ges
 = 
	`km®loc_¬¿y
(
Ä±rs
, (
·ge
 *), 
GFP_KERNEL
);

1227 ià(!
·ges
) {

1228 
»t
 = -
ENOMEM
;

1229 
out
;

1232 
	`iov_™”_couÁ
(
i
) > 0) {

1233 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

1234 
size_t
 
off£t
 = 
	`off£t_š_·ge
(
pos
);

1235 
size_t
 
£ùÜ_off£t
;

1236 
size_t
 
wr™e_by‹s
 = 
	`mš
(
	`iov_™”_couÁ
(
i
),

1237 
Ä±rs
 * (
size_t
)
PAGE_SIZE
 -

1238 
off£t
);

1239 
size_t
 
num_·ges
;

1240 
size_t
 
»£rve_by‹s
;

1241 
size_t
 
dœty_·ges
;

1242 
size_t
 
cİ›d
;

1243 
size_t
 
dœty_£ùÜs
;

1244 
size_t
 
num_£ùÜs
;

1245 
ex‹Ás_locked
;

1251 ià(
	`uÆik–y
(
	`çuÉ_š_iov_™”_»adabË
(
i
, 
wr™e_by‹s
))) {

1252 
»t
 = -
EFAULT
;

1256 
Úly_»Ëa£_m‘ad©a
 = 
çl£
;

1257 
£ùÜ_off£t
 = 
pos
 & (
fs_šfo
->
£ùÜsize
 - 1);

1259 
	`ex‹Á_chªge£t_»Ëa£
(
d©a_»£rved
);

1260 
»t
 = 
	`bŒfs_check_d©a_ä“_¥aû
(
	`BTRFS_I
(
šode
),

1261 &
d©a_»£rved
, 
pos
,

1262 
wr™e_by‹s
, 
nowa™
);

1263 ià(
»t
 < 0) {

1264 
ÿn_nocow
;

1266 ià(
nowa™
 && (
»t
 =ğ-
ENOSPC
 ||„‘ =ğ-
EAGAIN
)) {

1267 
»t
 = -
EAGAIN
;

1276 
ÿn_nocow
 = 
	`bŒfs_check_nocow_lock
(
	`BTRFS_I
(
šode
), 
pos
,

1277 &
wr™e_by‹s
, 
nowa™
);

1278 ià(
ÿn_nocow
 < 0)

1279 
»t
 = 
ÿn_nocow
;

1280 ià(
ÿn_nocow
 > 0)

1281 
»t
 = 0;

1282 ià(
»t
)

1284 
Úly_»Ëa£_m‘ad©a
 = 
Œue
;

1287 
num_·ges
 = 
	`DIV_ROUND_UP
(
wr™e_by‹s
 + 
off£t
, 
PAGE_SIZE
);

1288 
	`WARN_ON
(
num_·ges
 > 
Ä±rs
);

1289 
»£rve_by‹s
 = 
	`round_up
(
wr™e_by‹s
 + 
£ùÜ_off£t
,

1290 
fs_šfo
->
£ùÜsize
);

1291 
	`WARN_ON
(
»£rve_by‹s
 == 0);

1292 
»t
 = 
	`bŒfs_d–®loc_»£rve_m‘ad©a
(
	`BTRFS_I
(
šode
),

1293 
»£rve_by‹s
,

1294 
»£rve_by‹s
, 
nowa™
);

1295 ià(
»t
) {

1296 ià(!
Úly_»Ëa£_m‘ad©a
)

1297 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
	`BTRFS_I
(
šode
),

1298 
d©a_»£rved
, 
pos
,

1299 
wr™e_by‹s
);

1301 
	`bŒfs_check_nocow_uÆock
(
	`BTRFS_I
(
šode
));

1303 ià(
nowa™
 && 
»t
 =ğ-
ENOSPC
)

1304 
»t
 = -
EAGAIN
;

1308 
»Ëa£_by‹s
 = 
»£rve_by‹s
;

1309 
agaš
:

1310 
»t
 = 
	`b®ªû_dœty_·ges_¿‹lim™ed_æags
(
šode
->
i_m­pšg
, 
bdp_æags
);

1311 ià(
»t
) {

1312 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
	`BTRFS_I
(
šode
), 
»£rve_by‹s
);

1321 
»t
 = 
	`´•¬e_·ges
(
šode
, 
·ges
, 
num_·ges
,

1322 
pos
, 
wr™e_by‹s
, 
fÜû_·ge_u±od©e
, 
çl£
);

1323 ià(
»t
) {

1324 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
	`BTRFS_I
(
šode
),

1325 
»£rve_by‹s
);

1329 
ex‹Ás_locked
 = 
	`lock_ªd_ş—nup_ex‹Á_if_Ãed
(

1330 
	`BTRFS_I
(
šode
), 
·ges
,

1331 
num_·ges
, 
pos
, 
wr™e_by‹s
, &
lock¡¬t
,

1332 &
lock’d
, 
nowa™
, &
ÿched_¡©e
);

1333 ià(
ex‹Ás_locked
 < 0) {

1334 ià(!
nowa™
 && 
ex‹Ás_locked
 =ğ-
EAGAIN
)

1335 
agaš
;

1337 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
	`BTRFS_I
(
šode
),

1338 
»£rve_by‹s
);

1339 
»t
 = 
ex‹Ás_locked
;

1343 
cİ›d
 = 
	`bŒfs_cİy_äom_u£r
(
pos
, 
wr™e_by‹s
, 
·ges
, 
i
);

1345 
num_£ùÜs
 = 
	`BTRFS_BYTES_TO_BLKS
(
fs_šfo
, 
»£rve_by‹s
);

1346 
dœty_£ùÜs
 = 
	`round_up
(
cİ›d
 + 
£ùÜ_off£t
,

1347 
fs_šfo
->
£ùÜsize
);

1348 
dœty_£ùÜs
 = 
	`BTRFS_BYTES_TO_BLKS
(
fs_šfo
, dirty_sectors);

1354 ià(
cİ›d
 < 
wr™e_by‹s
)

1355 
Ä±rs
 = 1;

1357 ià(
cİ›d
 == 0) {

1358 
fÜû_·ge_u±od©e
 = 
Œue
;

1359 
dœty_£ùÜs
 = 0;

1360 
dœty_·ges
 = 0;

1362 
fÜû_·ge_u±od©e
 = 
çl£
;

1363 
dœty_·ges
 = 
	`DIV_ROUND_UP
(
cİ›d
 + 
off£t
,

1364 
PAGE_SIZE
);

1367 ià(
num_£ùÜs
 > 
dœty_£ùÜs
) {

1369 
»Ëa£_by‹s
 -ğ
dœty_£ùÜs
 << 
fs_šfo
->
£ùÜsize_b™s
;

1370 ià(
Úly_»Ëa£_m‘ad©a
) {

1371 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
	`BTRFS_I
(
šode
),

1372 
»Ëa£_by‹s
, 
Œue
);

1374 
u64
 
__pos
;

1376 
__pos
 = 
	`round_down
(
pos
,

1377 
fs_šfo
->
£ùÜsize
) +

1378 (
dœty_·ges
 << 
PAGE_SHIFT
);

1379 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
	`BTRFS_I
(
šode
),

1380 
d©a_»£rved
, 
__pos
,

1381 
»Ëa£_by‹s
, 
Œue
);

1385 
»Ëa£_by‹s
 = 
	`round_up
(
cİ›d
 + 
£ùÜ_off£t
,

1386 
fs_šfo
->
£ùÜsize
);

1388 
»t
 = 
	`bŒfs_dœty_·ges
(
	`BTRFS_I
(
šode
), 
·ges
,

1389 
dœty_·ges
, 
pos
, 
cİ›d
,

1390 &
ÿched_¡©e
, 
Úly_»Ëa£_m‘ad©a
);

1399 ià(
ex‹Ás_locked
)

1400 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
,

1401 
lock’d
, &
ÿched_¡©e
);

1403 
	`ä“_ex‹Á_¡©e
(
ÿched_¡©e
);

1405 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
	`BTRFS_I
(
šode
), 
»£rve_by‹s
);

1406 ià(
»t
) {

1407 
	`bŒfs_drİ_·ges
(
fs_šfo
, 
·ges
, 
num_·ges
, 
pos
, 
cİ›d
);

1411 
»Ëa£_by‹s
 = 0;

1412 ià(
Úly_»Ëa£_m‘ad©a
)

1413 
	`bŒfs_check_nocow_uÆock
(
	`BTRFS_I
(
šode
));

1415 
	`bŒfs_drİ_·ges
(
fs_šfo
, 
·ges
, 
num_·ges
, 
pos
, 
cİ›d
);

1417 
	`cÚd_»sched
();

1419 
pos
 +ğ
cİ›d
;

1420 
num_wr™‹n
 +ğ
cİ›d
;

1423 
	`kä“
(
·ges
);

1425 ià(
»Ëa£_by‹s
) {

1426 ià(
Úly_»Ëa£_m‘ad©a
) {

1427 
	`bŒfs_check_nocow_uÆock
(
	`BTRFS_I
(
šode
));

1428 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
	`BTRFS_I
(
šode
),

1429 
»Ëa£_by‹s
, 
Œue
);

1431 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
	`BTRFS_I
(
šode
),

1432 
d©a_»£rved
,

1433 
	`round_down
(
pos
, 
fs_šfo
->
£ùÜsize
),

1434 
»Ëa£_by‹s
, 
Œue
);

1438 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

1439 ià(
num_wr™‹n
 > 0) {

1440 
	`·geÿche_isize_ex‹nded
(
šode
, 
Şd_isize
, 
iocb
->
ki_pos
);

1441 
iocb
->
ki_pos
 +ğ
num_wr™‹n
;

1443 
out
:

1444 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
ock_æags
);

1446  
num_wr™‹n
 ?‚um_wr™‹À: 
»t
;

1447 
	}
}

1449 
ssize_t
 
	$check_dœeù_IO
(
bŒfs_fs_šfo
 *
fs_šfo
,

1450 cÚ¡ 
iov_™”
 *
™”
, 
loff_t
 
off£t
)

1452 cÚ¡ 
u32
 
blocksize_mask
 = 
fs_šfo
->
£ùÜsize
 - 1;

1454 ià(
off£t
 & 
blocksize_mask
)

1455  -
EINVAL
;

1457 ià(
	`iov_™”_®ignm’t
(
™”
è& 
blocksize_mask
)

1458  -
EINVAL
;

1461 
	}
}

1463 
ssize_t
 
	$bŒfs_dœeù_wr™e
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
)

1465 
fe
 *fğ
iocb
->
ki_fp
;

1466 
šode
 *šodğ
	`fe_šode
(
fe
);

1467 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1468 
loff_t
 
pos
;

1469 
ssize_t
 
wr™‹n
 = 0;

1470 
ssize_t
 
wr™‹n_bufã»d
;

1471 
size_t
 
´ev_Ëá
 = 0;

1472 
loff_t
 
’dby‹
;

1473 
ssize_t
 
”r
;

1474 
ock_æags
 = 0;

1475 
iom­_dio
 *
dio
;

1477 ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
)

1478 
ock_æags
 |ğ
BTRFS_ILOCK_TRY
;

1486 ià(
iocb
->
ki_pos
 + 
	`iov_™”_couÁ
(
äom
è<ğ
	`i_size_»ad
(
šode
è&& 
	`IS_NOSEC
(inode))

1487 
ock_æags
 |ğ
BTRFS_ILOCK_SHARED
;

1489 
»lock
:

1490 
”r
 = 
	`bŒfs_šode_lock
(
	`BTRFS_I
(
šode
), 
ock_æags
);

1491 ià(
”r
 < 0)

1492  
”r
;

1495 ià((
ock_æags
 & 
BTRFS_ILOCK_SHARED
è&& !
	`IS_NOSEC
(
šode
)) {

1496 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
ock_æags
);

1497 
ock_æags
 &ğ~
BTRFS_ILOCK_SHARED
;

1498 
»lock
;

1501 
”r
 = 
	`g’”ic_wr™e_checks
(
iocb
, 
äom
);

1502 ià(
”r
 <= 0) {

1503 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
ock_æags
);

1504  
”r
;

1507 
”r
 = 
	`bŒfs_wr™e_check
(
iocb
, 
äom
,ƒrr);

1508 ià(
”r
 < 0) {

1509 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
ock_æags
);

1510 
out
;

1513 
pos
 = 
iocb
->
ki_pos
;

1518 ià((
ock_æags
 & 
BTRFS_ILOCK_SHARED
) &&

1519 
pos
 + 
	`iov_™”_couÁ
(
äom
è> 
	`i_size_»ad
(
šode
)) {

1520 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
ock_æags
);

1521 
ock_æags
 &ğ~
BTRFS_ILOCK_SHARED
;

1522 
»lock
;

1525 ià(
	`check_dœeù_IO
(
fs_šfo
, 
äom
, 
pos
)) {

1526 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
ock_æags
);

1527 
bufã»d
;

1548 
äom
->
noçuÉ
 = 
Œue
;

1549 
dio
 = 
	`bŒfs_dio_wr™e
(
iocb
, 
äom
, 
wr™‹n
);

1550 
äom
->
noçuÉ
 = 
çl£
;

1557 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
ock_æags
);

1559 ià(
	`IS_ERR_OR_NULL
(
dio
))

1560 
”r
 = 
	`PTR_ERR_OR_ZERO
(
dio
);

1562 
”r
 = 
	`iom­_dio_com¶‘e
(
dio
);

1565 ià(
”r
 > 0)

1566 
wr™‹n
 = 
”r
;

1568 ià(
	`iov_™”_couÁ
(
äom
è> 0 && (
”r
 =ğ-
EFAULT
 ||ƒrr > 0)) {

1569 cÚ¡ 
size_t
 
Ëá
 = 
	`iov_™”_couÁ
(
äom
);

1584 ià(
Ëá
 =ğ
´ev_Ëá
) {

1585 
”r
 = -
ENOTBLK
;

1587 
	`çuÉ_š_iov_™”_»adabË
(
äom
, 
Ëá
);

1588 
´ev_Ëá
 = 
Ëá
;

1589 
»lock
;

1597 ià((
”r
 < 0 &&ƒ¼ !ğ-
ENOTBLK
è|| !
	`iov_™”_couÁ
(
äom
))

1598 
out
;

1600 
bufã»d
:

1607 ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
) {

1608 
”r
 = -
EAGAIN
;

1609 
out
;

1612 
pos
 = 
iocb
->
ki_pos
;

1613 
wr™‹n_bufã»d
 = 
	`bŒfs_bufã»d_wr™e
(
iocb
, 
äom
);

1614 ià(
wr™‹n_bufã»d
 < 0) {

1615 
”r
 = 
wr™‹n_bufã»d
;

1616 
out
;

1622 
’dby‹
 = 
pos
 + 
wr™‹n_bufã»d
 - 1;

1623 
”r
 = 
	`bŒfs_fd©awr™e_¿nge
(
šode
, 
pos
, 
’dby‹
);

1624 ià(
”r
)

1625 
out
;

1626 
”r
 = 
	`fem­_fd©awa™_¿nge
(
šode
->
i_m­pšg
, 
pos
, 
’dby‹
);

1627 ià(
”r
)

1628 
out
;

1629 
wr™‹n
 +ğ
wr™‹n_bufã»d
;

1630 
iocb
->
ki_pos
 = 
pos
 + 
wr™‹n_bufã»d
;

1631 
	`šv®id©e_m­pšg_·ges
(
fe
->
f_m­pšg
, 
pos
 >> 
PAGE_SHIFT
,

1632 
’dby‹
 >> 
PAGE_SHIFT
);

1633 
out
:

1634  
”r
 < 0 ?ƒ¼ : 
wr™‹n
;

1635 
	}
}

1637 
ssize_t
 
	$bŒfs_’coded_wr™e
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
,

1638 cÚ¡ 
bŒfs_ioùl_’coded_io_¬gs
 *
’coded
)

1640 
fe
 *fğ
iocb
->
ki_fp
;

1641 
šode
 *šodğ
	`fe_šode
(
fe
);

1642 
loff_t
 
couÁ
;

1643 
ssize_t
 
»t
;

1645 
	`bŒfs_šode_lock
(
	`BTRFS_I
(
šode
), 0);

1646 
couÁ
 = 
’coded
->
Ën
;

1647 
»t
 = 
	`g’”ic_wr™e_checks_couÁ
(
iocb
, &
couÁ
);

1648 ià(
»t
 =ğ0 && 
couÁ
 !ğ
’coded
->
Ën
) {

1653 
»t
 = -
EFBIG
;

1655 ià(
»t
 || 
’coded
->
Ën
 == 0)

1656 
out
;

1658 
»t
 = 
	`bŒfs_wr™e_check
(
iocb
, 
äom
, 
’coded
->
Ën
);

1659 ià(
»t
 < 0)

1660 
out
;

1662 
»t
 = 
	`bŒfs_do_’coded_wr™e
(
iocb
, 
äom
, 
’coded
);

1663 
out
:

1664 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 0);

1665  
»t
;

1666 
	}
}

1668 
ssize_t
 
	$bŒfs_do_wr™e_™”
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
,

1669 cÚ¡ 
bŒfs_ioùl_’coded_io_¬gs
 *
’coded
)

1671 
fe
 *fğ
iocb
->
ki_fp
;

1672 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
	`fe_šode
(
fe
));

1673 
ssize_t
 
num_wr™‹n
, 
num_sync
;

1680 ià(
	`BTRFS_FS_ERROR
(
šode
->
roÙ
->
fs_šfo
))

1681  -
EROFS
;

1683 ià(
’coded
 && (
iocb
->
ki_æags
 & 
IOCB_NOWAIT
))

1684  -
EOPNOTSUPP
;

1686 ià(
’coded
) {

1687 
num_wr™‹n
 = 
	`bŒfs_’coded_wr™e
(
iocb
, 
äom
, 
’coded
);

1688 
num_sync
 = 
’coded
->
Ën
;

1689 } ià(
iocb
->
ki_æags
 & 
IOCB_DIRECT
) {

1690 
num_wr™‹n
 = 
	`bŒfs_dœeù_wr™e
(
iocb
, 
äom
);

1691 
num_sync
 = 
num_wr™‹n
;

1693 
num_wr™‹n
 = 
	`bŒfs_bufã»d_wr™e
(
iocb
, 
äom
);

1694 
num_sync
 = 
num_wr™‹n
;

1697 
	`bŒfs_£t_šode_Ï¡_sub_Œªs
(
šode
);

1699 ià(
num_sync
 > 0) {

1700 
num_sync
 = 
	`g’”ic_wr™e_sync
(
iocb
,‚um_sync);

1701 ià(
num_sync
 < 0)

1702 
num_wr™‹n
 = 
num_sync
;

1705  
num_wr™‹n
;

1706 
	}
}

1708 
ssize_t
 
	$bŒfs_fe_wr™e_™”
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
)

1710  
	`bŒfs_do_wr™e_™”
(
iocb
, 
äom
, 
NULL
);

1711 
	}
}

1713 
	$bŒfs_»Ëa£_fe
(
šode
 *šode, 
fe
 *
fp
)

1715 
bŒfs_fe_´iv©e
 *
´iv©e
 = 
fp
->
´iv©e_d©a
;

1717 
šode
 *
f_šode
 = 
	`fe_šode
(
fp
);

1720 ià(
´iv©e
) {

1721 
	`kä“
(
´iv©e
->
fldœ_buf
);

1722 
	`ä“_ex‹Á_¡©e
(
´iv©e
->
Î£ek_ÿched_¡©e
);

1723 
	`kä“
(
´iv©e
);

1724 
fp
->
´iv©e_d©a
 = 
NULL
;

1738 ià(
	`‹¡_ªd_ş—r_b™
(
BTRFS_INODE_FLUSH_ON_CLOSE
,

1739 &
	`BTRFS_I
(
f_šode
)->
ruÁime_æags
))

1740 
	`fem­_æush
(
f_šode
->
i_m­pšg
);

1742 
	}
}

1744 
	$¡¬t_Üd”ed_İs
(
šode
 *šode, 
loff_t
 
¡¬t
,†off_ˆ
’d
)

1746 
»t
;

1747 
blk_¶ug
 
¶ug
;

1755 
	`blk_¡¬t_¶ug
(&
¶ug
);

1756 
»t
 = 
	`bŒfs_fd©awr™e_¿nge
(
šode
, 
¡¬t
, 
’d
);

1757 
	`blk_fšish_¶ug
(&
¶ug
);

1759  
»t
;

1760 
	}
}

1762 
šlše
 
boŞ
 
	$sk_šode_loggšg
(cÚ¡ 
bŒfs_log_ùx
 *
ùx
)

1764 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
ùx
->inode);

1765 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

1767 ià(
	`bŒfs_šode_š_log
(
šode
, 
fs_šfo
->
g’”©iÚ
) &&

1768 
	`li¡_em±y
(&
ùx
->
Üd”ed_ex‹Ás
))

1769  
Œue
;

1778 ià(
šode
->
Ï¡_Œªs
 <ğ
fs_šfo
->
Ï¡_Œªs_comm™‹d
 &&

1779 (
	`‹¡_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
, &
šode
->
ruÁime_æags
) ||

1780 
	`li¡_em±y
(&
ùx
->
Üd”ed_ex‹Ás
)))

1781  
Œue
;

1783  
çl£
;

1784 
	}
}

1797 
	$bŒfs_sync_fe
(
fe
 *fe, 
loff_t
 
¡¬t
,†off_ˆ
’d
, 
d©async
)

1799 
d’Œy
 *d’Œy = 
	`fe_d’Œy
(
fe
);

1800 
šode
 *šodğ
	`d_šode
(
d’Œy
);

1801 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1802 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

1803 
bŒfs_Œªs_hªdË
 *
Œªs
;

1804 
bŒfs_log_ùx
 
ùx
;

1805 
»t
 = 0, 
”r
;

1806 
u64
 
Ën
;

1807 
boŞ
 
fuÎ_sync
;

1809 
	`Œaû_bŒfs_sync_fe
(
fe
, 
d©async
);

1811 
	`bŒfs_š™_log_ùx
(&
ùx
, 
šode
);

1821 
¡¬t
 = 0;

1822 
’d
 = 
LLONG_MAX
;

1823 
Ën
 = (
u64
)
LLONG_MAX
 + 1;

1831 
»t
 = 
	`¡¬t_Üd”ed_İs
(
šode
, 
¡¬t
, 
’d
);

1832 ià(
»t
)

1833 
out
;

1835 
	`bŒfs_šode_lock
(
	`BTRFS_I
(
šode
), 
BTRFS_ILOCK_MMAP
);

1837 
	`©omic_šc
(&
roÙ
->
log_b©ch
);

1857 
»t
 = 
	`¡¬t_Üd”ed_İs
(
šode
, 
¡¬t
, 
’d
);

1858 ià(
»t
) {

1859 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
BTRFS_ILOCK_MMAP
);

1860 
out
;

1871 
fuÎ_sync
 = 
	`‹¡_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

1872 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

1889 ià(
fuÎ_sync
 || 
	`bŒfs_is_zÚed
(
fs_šfo
)) {

1890 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 
¡¬t
, 
Ën
);

1897 
	`bŒfs_g‘_Üd”ed_ex‹Ás_fÜ_loggšg
(
	`BTRFS_I
(
šode
),

1898 &
ùx
.
Üd”ed_ex‹Ás
);

1899 
»t
 = 
	`fem­_fd©awa™_¿nge
(
šode
->
i_m­pšg
, 
¡¬t
, 
’d
);

1902 ià(
»t
)

1903 
out_»Ëa£_ex‹Ás
;

1905 
	`©omic_šc
(&
roÙ
->
log_b©ch
);

1907 
	`smp_mb
();

1908 ià(
	`sk_šode_loggšg
(&
ùx
)) {

1914 
	`ş—r_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

1915 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

1923 
»t
 = 
	`fem­_check_wb_”r
(
šode
->
i_m­pšg
, 
fe
->
f_wb_”r
);

1924 
out_»Ëa£_ex‹Ás
;

1938 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

1939 ià(
	`IS_ERR
(
Œªs
)) {

1940 
»t
 = 
	`PTR_ERR
(
Œªs
);

1941 
out_»Ëa£_ex‹Ás
;

1943 
Œªs
->
š_fsync
 = 
Œue
;

1945 
»t
 = 
	`bŒfs_log_d’Œy_§ã
(
Œªs
, 
d’Œy
, &
ùx
);

1946 
	`bŒfs_»Ëa£_log_ùx_ex‹Ás
(&
ùx
);

1947 ià(
»t
 < 0) {

1949 
»t
 = 
BTRFS_LOG_FORCE_COMMIT
;

1962 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
BTRFS_ILOCK_MMAP
);

1964 ià(
»t
 =ğ
BTRFS_NO_LOG_SYNC
) {

1965 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1966 
out
;

1970 ià(!
»t
) {

1971 
»t
 = 
	`bŒfs_sync_log
(
Œªs
, 
roÙ
, &
ùx
);

1972 ià(!
»t
) {

1973 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1974 
out
;

1990 ià(!
fuÎ_sync
) {

1991 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1992 ià(
»t
)

1993 
out
;

1994 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 
¡¬t
, 
Ën
);

1995 ià(
»t
)

1996 
out
;

2004 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ_b¬r›r
(
roÙ
);

2005 ià(
	`IS_ERR
(
Œªs
)) {

2006 
»t
 = 
	`PTR_ERR
(
Œªs
);

2013 ià(
»t
 =ğ-
ENOENT
)

2014 
»t
 = 0;

2015 
out
;

2019 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

2020 
out
:

2021 
	`ASSERT
(
	`li¡_em±y
(&
ùx
.
li¡
));

2022 
	`ASSERT
(
	`li¡_em±y
(&
ùx
.
cÚæiù_šodes
));

2023 
”r
 = 
	`fe_check_ªd_advªû_wb_”r
(
fe
);

2024 ià(!
»t
)

2025 
»t
 = 
”r
;

2026  
»t
 > 0 ? -
EIO
 :„et;

2028 
out_»Ëa£_ex‹Ás
:

2029 
	`bŒfs_»Ëa£_log_ùx_ex‹Ás
(&
ùx
);

2030 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
BTRFS_ILOCK_MMAP
);

2031 
out
;

2032 
	}
}

2034 cÚ¡ 
vm_İ”©iÚs_¡ruù
 
	gbŒfs_fe_vm_İs
 = {

2035 .
çuÉ
 = 
fem­_çuÉ
,

2036 .
	gm­_·ges
 = 
fem­_m­_·ges
,

2037 .
	g·ge_mkwr™e
 = 
bŒfs_·ge_mkwr™e
,

2040 
	$bŒfs_fe_mm­
(
fe
 *
fp
, 
vm_¬—_¡ruù
 *
vma
)

2042 
add»ss_¥aû
 *
m­pšg
 = 
fp
->
f_m­pšg
;

2044 
šode
 *
f_šode
;

2045 
f_šode
 = 
	`fe_šode
(
fp
);

2048 
m­pšg
 = 
f_šode
->
i_m­pšg
;

2052 ià(!
m­pšg
->
a_İs
->
»ad_fŞio
)

2053  -
ENOEXEC
;

2055 
	`fe_acûs£d
(
fp
);

2056 
vma
->
vm_İs
 = &
bŒfs_fe_vm_İs
;

2059 
	}
}

2061 
	$hŞe_m”g—bË
(
bŒfs_šode
 *
šode
, 
ex‹Á_bufãr
 *
Ëaf
,

2062 
¦Ù
, 
u64
 
¡¬t
, u64 
’d
)

2064 
bŒfs_fe_ex‹Á_™em
 *
fi
;

2065 
bŒfs_key
 
key
;

2067 ià(
¦Ù
 < 0 || slÙ >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
))

2070 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

2071 ià(
key
.
objeùid
 !ğ
	`bŒfs_šo
(
šode
) ||

2072 
key
.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

2075 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_fe_ex‹Á_™em
);

2077 ià(
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
fi
è!ğ
BTRFS_FILE_EXTENT_REG
)

2080 ià(
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
))

2083 ià(
key
.
off£t
 =ğ
’d
)

2085 ià(
key
.
off£t
 + 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
è=ğ
¡¬t
)

2088 
	}
}

2090 
	$fl_hŞes
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2091 
bŒfs_šode
 *
šode
,

2092 
bŒfs_·th
 *
·th
, 
u64
 
off£t
, u64 
’d
)

2094 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2095 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

2096 
ex‹Á_bufãr
 *
Ëaf
;

2097 
bŒfs_fe_ex‹Á_™em
 *
fi
;

2098 
ex‹Á_m­
 *
hŞe_em
;

2099 
bŒfs_key
 
key
;

2100 
»t
;

2102 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
NO_HOLES
))

2103 
out
;

2105 
key
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

2106 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

2107 
key
.
off£t
 = offset;

2109 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

2110 ià(
»t
 <= 0) {

2115 ià(
»t
 == 0)

2116 
»t
 = -
EINVAL
;

2117  
»t
;

2120 
Ëaf
 = 
·th
->
nodes
[0];

2121 ià(
	`hŞe_m”g—bË
(
šode
, 
Ëaf
, 
·th
->
¦Ùs
[0] - 1, 
off£t
, 
’d
)) {

2122 
u64
 
num_by‹s
;

2124 
·th
->
¦Ùs
[0]--;

2125 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

2126 
bŒfs_fe_ex‹Á_™em
);

2127 
num_by‹s
 = 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
) +

2128 
’d
 - 
off£t
;

2129 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
, 
num_by‹s
);

2130 
	`bŒfs_£t_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
, 
num_by‹s
);

2131 
	`bŒfs_£t_fe_ex‹Á_off£t
(
Ëaf
, 
fi
, 0);

2132 
	`bŒfs_£t_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
, 
Œªs
->
Œªsid
);

2133 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

2134 
out
;

2137 ià(
	`hŞe_m”g—bË
(
šode
, 
Ëaf
, 
·th
->
¦Ùs
[0], 
off£t
, 
’d
)) {

2138 
u64
 
num_by‹s
;

2140 
key
.
off£t
 = offset;

2141 
	`bŒfs_£t_™em_key_§ã
(
Œªs
, 
·th
, &
key
);

2142 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

2143 
bŒfs_fe_ex‹Á_™em
);

2144 
num_by‹s
 = 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
è+ 
’d
 -

2145 
off£t
;

2146 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
, 
num_by‹s
);

2147 
	`bŒfs_£t_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
, 
num_by‹s
);

2148 
	`bŒfs_£t_fe_ex‹Á_off£t
(
Ëaf
, 
fi
, 0);

2149 
	`bŒfs_£t_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
, 
Œªs
->
Œªsid
);

2150 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

2151 
out
;

2153 
	`bŒfs_»Ëa£_·th
(
·th
);

2155 
»t
 = 
	`bŒfs_š£¹_hŞe_ex‹Á
(
Œªs
, 
roÙ
, 
	`bŒfs_šo
(
šode
), 
off£t
,

2156 
’d
 - 
off£t
);

2157 ià(
»t
)

2158  
»t
;

2160 
out
:

2161 
	`bŒfs_»Ëa£_·th
(
·th
);

2163 
hŞe_em
 = 
	`®loc_ex‹Á_m­
();

2164 ià(!
hŞe_em
) {

2165 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
šode
, 
off£t
, 
’d
 - 1, 
çl£
);

2166 
	`bŒfs_£t_šode_fuÎ_sync
(
šode
);

2168 
hŞe_em
->
¡¬t
 = 
off£t
;

2169 
hŞe_em
->
Ën
 = 
’d
 - 
off£t
;

2170 
hŞe_em
->
¿m_by‹s
 = hŞe_em->
Ën
;

2171 
hŞe_em
->
Üig_¡¬t
 = 
off£t
;

2173 
hŞe_em
->
block_¡¬t
 = 
EXTENT_MAP_HOLE
;

2174 
hŞe_em
->
block_Ën
 = 0;

2175 
hŞe_em
->
Üig_block_Ën
 = 0;

2176 
hŞe_em
->
com´ess_ty³
 = 
BTRFS_COMPRESS_NONE
;

2177 
hŞe_em
->
g’”©iÚ
 = 
Œªs
->
Œªsid
;

2179 
»t
 = 
	`bŒfs_»¶aû_ex‹Á_m­_¿nge
(
šode
, 
hŞe_em
, 
Œue
);

2180 
	`ä“_ex‹Á_m­
(
hŞe_em
);

2181 ià(
»t
)

2182 
	`bŒfs_£t_šode_fuÎ_sync
(
šode
);

2186 
	}
}

2194 
	$fšd_fœ¡_nÚ_hŞe
(
bŒfs_šode
 *
šode
, 
u64
 *
¡¬t
, u64 *
Ën
)

2196 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

2197 
ex‹Á_m­
 *
em
;

2198 
»t
 = 0;

2200 
em
 = 
	`bŒfs_g‘_ex‹Á
(
šode
, 
NULL
, 0,

2201 
	`round_down
(*
¡¬t
, 
fs_šfo
->
£ùÜsize
),

2202 
	`round_up
(*
Ën
, 
fs_šfo
->
£ùÜsize
));

2203 ià(
	`IS_ERR
(
em
))

2204  
	`PTR_ERR
(
em
);

2207 ià(
em
->
block_¡¬t
 =ğ
EXTENT_MAP_HOLE
) {

2208 
»t
 = 1;

2209 *
Ën
 = 
em
->
¡¬t
 +ƒm->len > *start + *len ?

2210 0 : *
¡¬t
 + *
Ën
 - 
em
->start -ƒm->len;

2211 *
¡¬t
 = 
em
->¡¬ˆ+ƒm->
Ën
;

2213 
	`ä“_ex‹Á_m­
(
em
);

2214  
»t
;

2215 
	}
}

2217 
	$bŒfs_punch_hŞe_lock_¿nge
(
šode
 *inode,

2218 cÚ¡ 
u64
 
lock¡¬t
,

2219 cÚ¡ 
u64
 
lock’d
,

2220 
ex‹Á_¡©e
 **
ÿched_¡©e
)

2230 cÚ¡ 
u64
 
·ge_lock¡¬t
 = 
	`round_up
(
lock¡¬t
, 
PAGE_SIZE
);

2231 cÚ¡ 
u64
 
·ge_lock’d
 = 
	`round_down
(
lock’d
 + 1, 
PAGE_SIZE
) - 1;

2234 
	`Œunÿ‹_·geÿche_¿nge
(
šode
, 
lock¡¬t
, 
lock’d
);

2236 
	`lock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
, 
lock’d
,

2237 
ÿched_¡©e
);

2248 ià(!
	`fem­_¿nge_has_·ge
(
šode
->
i_m­pšg
, 
·ge_lock¡¬t
,

2249 
·ge_lock’d
))

2252 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
, 
lock’d
,

2253 
ÿched_¡©e
);

2256 
	`bŒfs_as£¹_šode_¿nge_ş—n
(
	`BTRFS_I
(
šode
), 
lock¡¬t
, 
lock’d
);

2257 
	}
}

2259 
	$bŒfs_š£¹_»¶aû_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2260 
bŒfs_šode
 *
šode
,

2261 
bŒfs_·th
 *
·th
,

2262 
bŒfs_»¶aû_ex‹Á_šfo
 *
ex‹Á_šfo
,

2263 cÚ¡ 
u64
 
»¶aû_Ën
,

2264 cÚ¡ 
u64
 
by‹s_to_drİ
)

2266 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2267 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

2268 
bŒfs_fe_ex‹Á_™em
 *
ex‹Á
;

2269 
ex‹Á_bufãr
 *
Ëaf
;

2270 
bŒfs_key
 
key
;

2271 
¦Ù
;

2272 
bŒfs_»f
 
»f
 = { 0 };

2273 
»t
;

2275 ià(
»¶aû_Ën
 == 0)

2278 ià(
ex‹Á_šfo
->
disk_off£t
 == 0 &&

2279 
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
NO_HOLES
)) {

2280 
	`bŒfs_upd©e_šode_by‹s
(
šode
, 0, 
by‹s_to_drİ
);

2284 
key
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

2285 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

2286 
key
.
off£t
 = 
ex‹Á_šfo
->
fe_off£t
;

2287 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

2288 (
bŒfs_fe_ex‹Á_™em
));

2289 ià(
»t
)

2290  
»t
;

2291 
Ëaf
 = 
·th
->
nodes
[0];

2292 
¦Ù
 = 
·th
->
¦Ùs
[0];

2293 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
ex‹Á_šfo
->
ex‹Á_buf
,

2294 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
),

2295 (
bŒfs_fe_ex‹Á_™em
));

2296 
ex‹Á
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_fe_ex‹Á_™em
);

2297 
	`ASSERT
(
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
ex‹Á
è!ğ
BTRFS_FILE_EXTENT_INLINE
);

2298 
	`bŒfs_£t_fe_ex‹Á_off£t
(
Ëaf
, 
ex‹Á
, 
ex‹Á_šfo
->
d©a_off£t
);

2299 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
ex‹Á
, 
»¶aû_Ën
);

2300 ià(
ex‹Á_šfo
->
is_Ãw_ex‹Á
)

2301 
	`bŒfs_£t_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
ex‹Á
, 
Œªs
->
Œªsid
);

2302 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

2303 
	`bŒfs_»Ëa£_·th
(
·th
);

2305 
»t
 = 
	`bŒfs_šode_£t_fe_ex‹Á_¿nge
(
šode
, 
ex‹Á_šfo
->
fe_off£t
,

2306 
»¶aû_Ën
);

2307 ià(
»t
)

2308  
»t
;

2311 ià(
ex‹Á_šfo
->
disk_off£t
 == 0) {

2312 
	`bŒfs_upd©e_šode_by‹s
(
šode
, 0, 
by‹s_to_drİ
);

2316 
	`bŒfs_upd©e_šode_by‹s
(
šode
, 
»¶aû_Ën
, 
by‹s_to_drİ
);

2318 ià(
ex‹Á_šfo
->
is_Ãw_ex‹Á
 &&ƒx‹Á_šfo->
š£¹iÚs
 == 0) {

2319 
key
.
objeùid
 = 
ex‹Á_šfo
->
disk_off£t
;

2320 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

2321 
key
.
off£t
 = 
ex‹Á_šfo
->
disk_Ën
;

2322 
»t
 = 
	`bŒfs_®loc_»£rved_fe_ex‹Á
(
Œªs
, 
roÙ
,

2323 
	`bŒfs_šo
(
šode
),

2324 
ex‹Á_šfo
->
fe_off£t
,

2325 
ex‹Á_šfo
->
qgroup_»£rved
,

2326 &
key
);

2328 
u64
 
»f_off£t
;

2330 
	`bŒfs_š™_g’”ic_»f
(&
»f
, 
BTRFS_ADD_DELAYED_REF
,

2331 
ex‹Á_šfo
->
disk_off£t
,

2332 
ex‹Á_šfo
->
disk_Ën
, 0);

2333 
»f_off£t
 = 
ex‹Á_šfo
->
fe_off£t
 -ƒx‹Á_šfo->
d©a_off£t
;

2334 
	`bŒfs_š™_d©a_»f
(&
»f
, 
roÙ
->
roÙ_key
.
objeùid
,

2335 
	`bŒfs_šo
(
šode
), 
»f_off£t
, 0, 
çl£
);

2336 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, &
»f
);

2339 
ex‹Á_šfo
->
š£¹iÚs
++;

2341  
»t
;

2342 
	}
}

2353 
	$bŒfs_»¶aû_fe_ex‹Ás
(
bŒfs_šode
 *
šode
,

2354 
bŒfs_·th
 *
·th
, cÚ¡ 
u64
 
¡¬t
,

2355 cÚ¡ 
u64
 
’d
,

2356 
bŒfs_»¶aû_ex‹Á_šfo
 *
ex‹Á_šfo
,

2357 
bŒfs_Œªs_hªdË
 **
Œªs_out
)

2359 
bŒfs_drİ_ex‹Ás_¬gs
 
drİ_¬gs
 = { 0 };

2360 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

2361 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2362 
u64
 
mš_size
 = 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
, 1);

2363 
u64
 
šo_size
 = 
	`round_up
(
šode
->
vfs_šode
.
i_size
, 
fs_šfo
->
£ùÜsize
);

2364 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

2365 
bŒfs_block_rsv
 *
rsv
;

2366 
rsv_couÁ
;

2367 
u64
 
cur_off£t
;

2368 
u64
 
Ën
 = 
’d
 - 
¡¬t
;

2369 
»t
 = 0;

2371 ià(
’d
 <ğ
¡¬t
)

2372  -
EINVAL
;

2374 
rsv
 = 
	`bŒfs_®loc_block_rsv
(
fs_šfo
, 
BTRFS_BLOCK_RSV_TEMP
);

2375 ià(!
rsv
) {

2376 
»t
 = -
ENOMEM
;

2377 
out
;

2379 
rsv
->
size
 = 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
, 1);

2380 
rsv
->
çç¡
 = 
Œue
;

2388 ià(!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
NO_HOLES
è|| 
ex‹Á_šfo
)

2389 
rsv_couÁ
 = 3;

2391 
rsv_couÁ
 = 2;

2393 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 
rsv_couÁ
);

2394 ià(
	`IS_ERR
(
Œªs
)) {

2395 
»t
 = 
	`PTR_ERR
(
Œªs
);

2396 
Œªs
 = 
NULL
;

2397 
out_ä“
;

2400 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(&
fs_šfo
->
Œªs_block_rsv
, 
rsv
,

2401 
mš_size
, 
çl£
);

2402 ià(
	`WARN_ON
(
»t
))

2403 
out_Œªs
;

2404 
Œªs
->
block_rsv
 = 
rsv
;

2406 
cur_off£t
 = 
¡¬t
;

2407 
drİ_¬gs
.
·th
 =…ath;

2408 
drİ_¬gs
.
’d
 =ƒnd + 1;

2409 
drİ_¬gs
.
drİ_ÿche
 = 
Œue
;

2410 
cur_off£t
 < 
’d
) {

2411 
drİ_¬gs
.
¡¬t
 = 
cur_off£t
;

2412 
»t
 = 
	`bŒfs_drİ_ex‹Ás
(
Œªs
, 
roÙ
, 
šode
, &
drİ_¬gs
);

2414 ià(!
ex‹Á_šfo
)

2415 
	`bŒfs_upd©e_šode_by‹s
(
šode
, 0,

2416 
drİ_¬gs
.
by‹s_found
);

2417 ià(
»t
 !ğ-
ENOSPC
) {

2426 ià(
»t
 &&

2427 (
»t
 !ğ-
EOPNOTSUPP
 ||

2428 (
ex‹Á_šfo
 &&ƒx‹Á_šfo->
is_Ãw_ex‹Á
)))

2429 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2433 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

2435 ià(!
ex‹Á_šfo
 && 
cur_off£t
 < 
drİ_¬gs
.
drİ_’d
 &&

2436 
cur_off£t
 < 
šo_size
) {

2437 
»t
 = 
	`fl_hŞes
(
Œªs
, 
šode
, 
·th
, 
cur_off£t
,

2438 
drİ_¬gs
.
drİ_’d
);

2439 ià(
»t
) {

2446 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2449 } ià(!
ex‹Á_šfo
 && 
cur_off£t
 < 
drİ_¬gs
.
drİ_’d
) {

2456 
»t
 = 
	`bŒfs_šode_ş—r_fe_ex‹Á_¿nge
(
šode
,

2457 
cur_off£t
,

2458 
drİ_¬gs
.
drİ_’d
 - 
cur_off£t
);

2459 ià(
»t
) {

2465 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2470 ià(
ex‹Á_šfo
 &&

2471 
drİ_¬gs
.
drİ_’d
 > 
ex‹Á_šfo
->
fe_off£t
) {

2472 
u64
 
»¶aû_Ën
 = 
drİ_¬gs
.
drİ_’d
 -

2473 
ex‹Á_šfo
->
fe_off£t
;

2475 
»t
 = 
	`bŒfs_š£¹_»¶aû_ex‹Á
(
Œªs
, 
šode
, 
·th
,

2476 
ex‹Á_šfo
, 
»¶aû_Ën
,

2477 
drİ_¬gs
.
by‹s_found
);

2478 ià(
»t
) {

2479 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2482 
ex‹Á_šfo
->
d©a_Ën
 -ğ
»¶aû_Ën
;

2483 
ex‹Á_šfo
->
d©a_off£t
 +ğ
»¶aû_Ën
;

2484 
ex‹Á_šfo
->
fe_off£t
 +ğ
»¶aû_Ën
;

2499 
	`šode_šc_iv”siÚ
(&
šode
->
vfs_šode
);

2501 ià(!
ex‹Á_šfo
 ||ƒx‹Á_šfo->
upd©e_times
)

2502 
šode
->
vfs_šode
.
i_mtime
 = 
	`šode_£t_ùime_cu¼’t
(&inode->vfs_inode);

2504 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

2505 ià(
»t
)

2508 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2509 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

2511 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 
rsv_couÁ
);

2512 ià(
	`IS_ERR
(
Œªs
)) {

2513 
»t
 = 
	`PTR_ERR
(
Œªs
);

2514 
Œªs
 = 
NULL
;

2518 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(&
fs_šfo
->
Œªs_block_rsv
,

2519 
rsv
, 
mš_size
, 
çl£
);

2520 ià(
	`WARN_ON
(
»t
))

2522 
Œªs
->
block_rsv
 = 
rsv
;

2524 
cur_off£t
 = 
drİ_¬gs
.
drİ_’d
;

2525 
Ën
 = 
’d
 - 
cur_off£t
;

2526 ià(!
ex‹Á_šfo
 && 
Ën
) {

2527 
»t
 = 
	`fšd_fœ¡_nÚ_hŞe
(
šode
, &
cur_off£t
, &
Ën
);

2528 ià(
	`uÆik–y
(
»t
 < 0))

2530 ià(
»t
 && !
Ën
) {

2531 
»t
 = 0;

2543 ià(
ex‹Á_šfo
 && !ex‹Á_šfo->
is_Ãw_ex‹Á
)

2544 
	`bŒfs_£t_šode_fuÎ_sync
(
šode
);

2546 ià(
»t
)

2547 
out_Œªs
;

2549 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

2561 ià(
drİ_¬gs
.
drİ_’d
 <ğ
’d
)

2562 
drİ_¬gs
.
drİ_’d
 = 
’d
 + 1;

2568 ià(!
ex‹Á_šfo
 && 
cur_off£t
 < 
šo_size
 &&

2569 
cur_off£t
 < 
drİ_¬gs
.
drİ_’d
) {

2570 
»t
 = 
	`fl_hŞes
(
Œªs
, 
šode
, 
·th
, 
cur_off£t
,

2571 
drİ_¬gs
.
drİ_’d
);

2572 ià(
»t
) {

2574 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2575 
out_Œªs
;

2577 } ià(!
ex‹Á_šfo
 && 
cur_off£t
 < 
drİ_¬gs
.
drİ_’d
) {

2579 
»t
 = 
	`bŒfs_šode_ş—r_fe_ex‹Á_¿nge
(
šode
, 
cur_off£t
,

2580 
drİ_¬gs
.
drİ_’d
 - 
cur_off£t
);

2581 ià(
»t
) {

2582 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2583 
out_Œªs
;

2587 ià(
ex‹Á_šfo
) {

2588 
»t
 = 
	`bŒfs_š£¹_»¶aû_ex‹Á
(
Œªs
, 
šode
, 
·th
,

2589 
ex‹Á_šfo
,ƒx‹Á_šfo->
d©a_Ën
,

2590 
drİ_¬gs
.
by‹s_found
);

2591 ià(
»t
) {

2592 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2593 
out_Œªs
;

2597 
out_Œªs
:

2598 ià(!
Œªs
)

2599 
out_ä“
;

2601 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

2602 ià(
»t
)

2603 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2605 *
Œªs_out
 = 
Œªs
;

2606 
out_ä“
:

2607 
	`bŒfs_ä“_block_rsv
(
fs_šfo
, 
rsv
);

2608 
out
:

2609  
»t
;

2610 
	}
}

2612 
	$bŒfs_punch_hŞe
(
fe
 *fe, 
loff_t
 
off£t
,†off_ˆ
Ën
)

2614 
šode
 *šodğ
	`fe_šode
(
fe
);

2615 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2616 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

2617 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

2618 
bŒfs_·th
 *
·th
;

2619 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

2620 
u64
 
lock¡¬t
;

2621 
u64
 
lock’d
;

2622 
u64
 
_¡¬t
;

2623 
u64
 
_Ën
;

2624 
u64
 
Üig_¡¬t
 = 
off£t
;

2625 
»t
 = 0;

2626 
boŞ
 
§me_block
;

2627 
u64
 
šo_size
;

2628 
boŞ
 
Œunÿ‹d_block
 = 
çl£
;

2629 
boŞ
 
upd©ed_šode
 = 
çl£
;

2631 
	`bŒfs_šode_lock
(
	`BTRFS_I
(
šode
), 
BTRFS_ILOCK_MMAP
);

2633 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 
off£t
, 
Ën
);

2634 ià(
»t
)

2635 
out_Úly_mu‹x
;

2637 
šo_size
 = 
	`round_up
(
šode
->
i_size
, 
fs_šfo
->
£ùÜsize
);

2638 
»t
 = 
	`fšd_fœ¡_nÚ_hŞe
(
	`BTRFS_I
(
šode
), &
off£t
, &
Ën
);

2639 ià(
»t
 < 0)

2640 
out_Úly_mu‹x
;

2641 ià(
»t
 && !
Ën
) {

2643 
»t
 = 0;

2644 
out_Úly_mu‹x
;

2647 
»t
 = 
	`fe_modif›d
(
fe
);

2648 ià(
»t
)

2649 
out_Úly_mu‹x
;

2651 
lock¡¬t
 = 
	`round_up
(
off£t
, 
fs_šfo
->
£ùÜsize
);

2652 
lock’d
 = 
	`round_down
(
off£t
 + 
Ën
, 
fs_šfo
->
£ùÜsize
) - 1;

2653 
§me_block
 = (
	`BTRFS_BYTES_TO_BLKS
(
fs_šfo
, 
off£t
))

2654 =ğ(
	`BTRFS_BYTES_TO_BLKS
(
fs_šfo
, 
off£t
 + 
Ën
 - 1));

2663 ià(
§me_block
 && 
Ën
 < 
fs_šfo
->
£ùÜsize
) {

2664 ià(
off£t
 < 
šo_size
) {

2665 
Œunÿ‹d_block
 = 
Œue
;

2666 
»t
 = 
	`bŒfs_Œunÿ‹_block
(
	`BTRFS_I
(
šode
), 
off£t
, 
Ën
,

2669 
»t
 = 0;

2671 
out_Úly_mu‹x
;

2675 ià(
off£t
 < 
šo_size
) {

2676 
Œunÿ‹d_block
 = 
Œue
;

2677 
»t
 = 
	`bŒfs_Œunÿ‹_block
(
	`BTRFS_I
(
šode
), 
off£t
, 0, 0);

2678 ià(
»t
) {

2679 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
BTRFS_ILOCK_MMAP
);

2680  
»t
;

2688 ià(
off£t
 =ğ
Üig_¡¬t
) {

2690 
Ën
 = 
off£t
 +†’ - 
lock¡¬t
;

2691 
off£t
 = 
lock¡¬t
;

2692 
»t
 = 
	`fšd_fœ¡_nÚ_hŞe
(
	`BTRFS_I
(
šode
), &
off£t
, &
Ën
);

2693 ià(
»t
 < 0)

2694 
out_Úly_mu‹x
;

2695 ià(
»t
 && !
Ën
) {

2696 
»t
 = 0;

2697 
out_Úly_mu‹x
;

2699 
lock¡¬t
 = 
off£t
;

2703 
_¡¬t
 = 
lock’d
 + 1;

2704 
_Ën
 = 
off£t
 + 
Ën
 - 
_¡¬t
;

2705 ià(
_Ën
) {

2706 
»t
 = 
	`fšd_fœ¡_nÚ_hŞe
(
	`BTRFS_I
(
šode
), &
_¡¬t
, &
_Ën
);

2707 ià(
	`uÆik–y
(
»t
 < 0))

2708 
out_Úly_mu‹x
;

2709 ià(!
»t
) {

2711 ià(
_¡¬t
 + 
_Ën
 < 
šo_size
) {

2712 
Œunÿ‹d_block
 = 
Œue
;

2713 
»t
 = 
	`bŒfs_Œunÿ‹_block
(
	`BTRFS_I
(
šode
),

2714 
_¡¬t
 + 
_Ën
,

2716 ià(
»t
)

2717 
out_Úly_mu‹x
;

2722 ià(
lock’d
 < 
lock¡¬t
) {

2723 
»t
 = 0;

2724 
out_Úly_mu‹x
;

2727 
	`bŒfs_punch_hŞe_lock_¿nge
(
šode
, 
lock¡¬t
, 
lock’d
, &
ÿched_¡©e
);

2729 
·th
 = 
	`bŒfs_®loc_·th
();

2730 ià(!
·th
) {

2731 
»t
 = -
ENOMEM
;

2732 
out
;

2735 
»t
 = 
	`bŒfs_»¶aû_fe_ex‹Ás
(
	`BTRFS_I
(
šode
), 
·th
, 
lock¡¬t
,

2736 
lock’d
, 
NULL
, &
Œªs
);

2737 
	`bŒfs_ä“_·th
(
·th
);

2738 ià(
»t
)

2739 
out
;

2741 
	`ASSERT
(
Œªs
 !ğ
NULL
);

2742 
	`šode_šc_iv”siÚ
(
šode
);

2743 
šode
->
i_mtime
 = 
	`šode_£t_ùime_cu¼’t
(inode);

2744 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

2745 
upd©ed_šode
 = 
Œue
;

2746 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2747 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

2748 
out
:

2749 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
, 
lock’d
,

2750 &
ÿched_¡©e
);

2751 
out_Úly_mu‹x
:

2752 ià(!
upd©ed_šode
 && 
Œunÿ‹d_block
 && !
»t
) {

2760 
time¥ec64
 
now
 = 
	`šode_£t_ùime_cu¼’t
(
šode
);

2762 
	`šode_šc_iv”siÚ
(
šode
);

2763 
šode
->
i_mtime
 = 
now
;

2764 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

2765 ià(
	`IS_ERR
(
Œªs
)) {

2766 
»t
 = 
	`PTR_ERR
(
Œªs
);

2768 
»t2
;

2770 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

2771 
»t2
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2772 ià(!
»t
)

2773 
»t
 = 
»t2
;

2776 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
BTRFS_ILOCK_MMAP
);

2777  
»t
;

2778 
	}
}

2781 
	sçÎoc_¿nge
 {

2782 
li¡_h—d
 
	mli¡
;

2783 
u64
 
	m¡¬t
;

2784 
u64
 
	mËn
;

2793 
	$add_çÎoc_¿nge
(
li¡_h—d
 *
h—d
, 
u64
 
¡¬t
, u64 
Ën
)

2795 
çÎoc_¿nge
 *
¿nge
 = 
NULL
;

2797 ià(!
	`li¡_em±y
(
h—d
)) {

2802 
¿nge
 = 
	`li¡_Ï¡_’Œy
(
h—d
, 
çÎoc_¿nge
, 
li¡
);

2803 ià(
¿nge
->
¡¬t
 +„ªge->
Ën
 == start) {

2804 
¿nge
->
Ën
 +=†en;

2809 
¿nge
 = 
	`km®loc
((*¿nge), 
GFP_KERNEL
);

2810 ià(!
¿nge
)

2811  -
ENOMEM
;

2812 
¿nge
->
¡¬t
 = start;

2813 
¿nge
->
Ën
 =†en;

2814 
	`li¡_add_
(&
¿nge
->
li¡
, 
h—d
);

2816 
	}
}

2818 
	$bŒfs_çÎoÿ‹_upd©e_isize
(
šode
 *inode,

2819 cÚ¡ 
u64
 
’d
,

2820 cÚ¡ 
mode
)

2822 
bŒfs_Œªs_hªdË
 *
Œªs
;

2823 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

2824 
»t
;

2825 
»t2
;

2827 ià(
mode
 & 
FALLOC_FL_KEEP_SIZE
 || 
’d
 <ğ
	`i_size_»ad
(
šode
))

2830 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

2831 ià(
	`IS_ERR
(
Œªs
))

2832  
	`PTR_ERR
(
Œªs
);

2834 
	`šode_£t_ùime_cu¼’t
(
šode
);

2835 
	`i_size_wr™e
(
šode
, 
’d
);

2836 
	`bŒfs_šode_§ã_disk_i_size_wr™e
(
	`BTRFS_I
(
šode
), 0);

2837 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

2838 
»t2
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2840  
»t
 ?„‘ : 
»t2
;

2841 
	}
}

2844 
	mRANGE_BOUNDARY_WRITTEN_EXTENT
,

2845 
	mRANGE_BOUNDARY_PREALLOC_EXTENT
,

2846 
	mRANGE_BOUNDARY_HOLE
,

2849 
	$bŒfs_z”o_¿nge_check_¿nge_bound¬y
(
bŒfs_šode
 *
šode
,

2850 
u64
 
off£t
)

2852 cÚ¡ 
u64
 
£ùÜsize
 = 
šode
->
roÙ
->
fs_šfo
->sectorsize;

2853 
ex‹Á_m­
 *
em
;

2854 
»t
;

2856 
off£t
 = 
	`round_down
(off£t, 
£ùÜsize
);

2857 
em
 = 
	`bŒfs_g‘_ex‹Á
(
šode
, 
NULL
, 0, 
off£t
, 
£ùÜsize
);

2858 ià(
	`IS_ERR
(
em
))

2859  
	`PTR_ERR
(
em
);

2861 ià(
em
->
block_¡¬t
 =ğ
EXTENT_MAP_HOLE
)

2862 
»t
 = 
RANGE_BOUNDARY_HOLE
;

2863 ià(
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
))

2864 
»t
 = 
RANGE_BOUNDARY_PREALLOC_EXTENT
;

2866 
»t
 = 
RANGE_BOUNDARY_WRITTEN_EXTENT
;

2868 
	`ä“_ex‹Á_m­
(
em
);

2869  
»t
;

2870 
	}
}

2872 
	$bŒfs_z”o_¿nge
(
šode
 *inode,

2873 
loff_t
 
off£t
,

2874 
loff_t
 
Ën
,

2875 cÚ¡ 
mode
)

2877 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`BTRFS_I
(
šode
)->
roÙ
->fs_info;

2878 
ex‹Á_m­
 *
em
;

2879 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

2880 
»t
;

2881 
u64
 
®loc_hšt
 = 0;

2882 cÚ¡ 
u64
 
£ùÜsize
 = 
fs_šfo
->sectorsize;

2883 
u64
 
®loc_¡¬t
 = 
	`round_down
(
off£t
, 
£ùÜsize
);

2884 
u64
 
®loc_’d
 = 
	`round_up
(
off£t
 + 
Ën
, 
£ùÜsize
);

2885 
u64
 
by‹s_to_»£rve
 = 0;

2886 
boŞ
 
¥aû_»£rved
 = 
çl£
;

2888 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
®loc_¡¬t
,

2889 
®loc_’d
 - 
®loc_¡¬t
);

2890 ià(
	`IS_ERR
(
em
)) {

2891 
»t
 = 
	`PTR_ERR
(
em
);

2892 
out
;

2903 ià(
em
->
¡¬t
 <ğ
®loc_¡¬t
 &&

2904 
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
)) {

2905 cÚ¡ 
u64
 
em_’d
 = 
em
->
¡¬t
 +ƒm->
Ën
;

2907 ià(
em_’d
 >ğ
off£t
 + 
Ën
) {

2913 
	`ä“_ex‹Á_m­
(
em
);

2914 
»t
 = 
	`bŒfs_çÎoÿ‹_upd©e_isize
(
šode
, 
off£t
 + 
Ën
,

2915 
mode
);

2916 
out
;

2922 
®loc_¡¬t
 = 
em_’d
;

2923 
	`ASSERT
(
	`IS_ALIGNED
(
®loc_¡¬t
, 
£ùÜsize
));

2924 
Ën
 = 
off£t
 +†’ - 
®loc_¡¬t
;

2925 
off£t
 = 
®loc_¡¬t
;

2926 
®loc_hšt
 = 
em
->
block_¡¬t
 +ƒm->
Ën
;

2928 
	`ä“_ex‹Á_m­
(
em
);

2930 ià(
	`BTRFS_BYTES_TO_BLKS
(
fs_šfo
, 
off£t
) ==

2931 
	`BTRFS_BYTES_TO_BLKS
(
fs_šfo
, 
off£t
 + 
Ën
 - 1)) {

2932 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
®loc_¡¬t
,

2933 
£ùÜsize
);

2934 ià(
	`IS_ERR
(
em
)) {

2935 
»t
 = 
	`PTR_ERR
(
em
);

2936 
out
;

2939 ià(
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
)) {

2940 
	`ä“_ex‹Á_m­
(
em
);

2941 
»t
 = 
	`bŒfs_çÎoÿ‹_upd©e_isize
(
šode
, 
off£t
 + 
Ën
,

2942 
mode
);

2943 
out
;

2945 ià(
Ën
 < 
£ùÜsize
 && 
em
->
block_¡¬t
 !ğ
EXTENT_MAP_HOLE
) {

2946 
	`ä“_ex‹Á_m­
(
em
);

2947 
»t
 = 
	`bŒfs_Œunÿ‹_block
(
	`BTRFS_I
(
šode
), 
off£t
, 
Ën
,

2949 ià(!
»t
)

2950 
»t
 = 
	`bŒfs_çÎoÿ‹_upd©e_isize
(
šode
,

2951 
off£t
 + 
Ën
,

2952 
mode
);

2953  
»t
;

2955 
	`ä“_ex‹Á_m­
(
em
);

2956 
®loc_¡¬t
 = 
	`round_down
(
off£t
, 
£ùÜsize
);

2957 
®loc_’d
 = 
®loc_¡¬t
 + 
£ùÜsize
;

2958 
»£rve_¥aû
;

2961 
®loc_¡¬t
 = 
	`round_up
(
off£t
, 
£ùÜsize
);

2962 
®loc_’d
 = 
	`round_down
(
off£t
 + 
Ën
, 
£ùÜsize
);

2970 ià(!
	`IS_ALIGNED
(
off£t
, 
£ùÜsize
)) {

2971 
»t
 = 
	`bŒfs_z”o_¿nge_check_¿nge_bound¬y
(
	`BTRFS_I
(
šode
),

2972 
off£t
);

2973 ià(
»t
 < 0)

2974 
out
;

2975 ià(
»t
 =ğ
RANGE_BOUNDARY_HOLE
) {

2976 
®loc_¡¬t
 = 
	`round_down
(
off£t
, 
£ùÜsize
);

2977 
»t
 = 0;

2978 } ià(
»t
 =ğ
RANGE_BOUNDARY_WRITTEN_EXTENT
) {

2979 
»t
 = 
	`bŒfs_Œunÿ‹_block
(
	`BTRFS_I
(
šode
), 
off£t
, 0, 0);

2980 ià(
»t
)

2981 
out
;

2983 
»t
 = 0;

2987 ià(!
	`IS_ALIGNED
(
off£t
 + 
Ën
, 
£ùÜsize
)) {

2988 
»t
 = 
	`bŒfs_z”o_¿nge_check_¿nge_bound¬y
(
	`BTRFS_I
(
šode
),

2989 
off£t
 + 
Ën
);

2990 ià(
»t
 < 0)

2991 
out
;

2992 ià(
»t
 =ğ
RANGE_BOUNDARY_HOLE
) {

2993 
®loc_’d
 = 
	`round_up
(
off£t
 + 
Ën
, 
£ùÜsize
);

2994 
»t
 = 0;

2995 } ià(
»t
 =ğ
RANGE_BOUNDARY_WRITTEN_EXTENT
) {

2996 
»t
 = 
	`bŒfs_Œunÿ‹_block
(
	`BTRFS_I
(
šode
), 
off£t
 + 
Ën
,

2998 ià(
»t
)

2999 
out
;

3001 
»t
 = 0;

3005 
»£rve_¥aû
:

3006 ià(
®loc_¡¬t
 < 
®loc_’d
) {

3007 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

3008 cÚ¡ 
u64
 
lock¡¬t
 = 
®loc_¡¬t
;

3009 cÚ¡ 
u64
 
lock’d
 = 
®loc_’d
 - 1;

3011 
by‹s_to_»£rve
 = 
®loc_’d
 - 
®loc_¡¬t
;

3012 
»t
 = 
	`bŒfs_®loc_d©a_chunk_Údemªd
(
	`BTRFS_I
(
šode
),

3013 
by‹s_to_»£rve
);

3014 ià(
»t
 < 0)

3015 
out
;

3016 
¥aû_»£rved
 = 
Œue
;

3017 
	`bŒfs_punch_hŞe_lock_¿nge
(
šode
, 
lock¡¬t
, 
lock’d
,

3018 &
ÿched_¡©e
);

3019 
»t
 = 
	`bŒfs_qgroup_»£rve_d©a
(
	`BTRFS_I
(
šode
), &
d©a_»£rved
,

3020 
®loc_¡¬t
, 
by‹s_to_»£rve
);

3021 ià(
»t
) {

3022 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
,

3023 
lock’d
, &
ÿched_¡©e
);

3024 
out
;

3026 
»t
 = 
	`bŒfs_´—Îoc_fe_¿nge
(
šode
, 
mode
, 
®loc_¡¬t
,

3027 
®loc_’d
 - 
®loc_¡¬t
,

3028 
	`i_blocksize
(
šode
),

3029 
off£t
 + 
Ën
, &
®loc_hšt
);

3030 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
, 
lock’d
,

3031 &
ÿched_¡©e
);

3033 ià(
»t
) {

3034 
¥aû_»£rved
 = 
çl£
;

3035 
out
;

3038 
»t
 = 
	`bŒfs_çÎoÿ‹_upd©e_isize
(
šode
, 
off£t
 + 
Ën
, 
mode
);

3039 
out
:

3040 ià(
»t
 && 
¥aû_»£rved
)

3041 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
	`BTRFS_I
(
šode
), 
d©a_»£rved
,

3042 
®loc_¡¬t
, 
by‹s_to_»£rve
);

3043 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

3045  
»t
;

3046 
	}
}

3048 
	$bŒfs_çÎoÿ‹
(
fe
 *fe, 
mode
,

3049 
loff_t
 
off£t
,†off_ˆ
Ën
)

3051 
šode
 *šodğ
	`fe_šode
(
fe
);

3052 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

3053 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

3054 
çÎoc_¿nge
 *
¿nge
;

3055 
çÎoc_¿nge
 *
tmp
;

3056 
	`LIST_HEAD
(
»£rve_li¡
);

3057 
u64
 
cur_off£t
;

3058 
u64
 
Ï¡_by‹
;

3059 
u64
 
®loc_¡¬t
;

3060 
u64
 
®loc_’d
;

3061 
u64
 
®loc_hšt
 = 0;

3062 
u64
 
locked_’d
;

3063 
u64
 
aùu®_’d
 = 0;

3064 
u64
 
d©a_¥aû_Ãeded
 = 0;

3065 
u64
 
d©a_¥aû_»£rved
 = 0;

3066 
u64
 
qgroup_»£rved
 = 0;

3067 
ex‹Á_m­
 *
em
;

3068 
blocksize
 = 
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
->
£ùÜsize
;

3069 
»t
;

3072 ià(
	`bŒfs_is_zÚed
(
	`bŒfs_sb
(
šode
->
i_sb
)))

3073  -
EOPNOTSUPP
;

3075 
®loc_¡¬t
 = 
	`round_down
(
off£t
, 
blocksize
);

3076 
®loc_’d
 = 
	`round_up
(
off£t
 + 
Ën
, 
blocksize
);

3077 
cur_off£t
 = 
®loc_¡¬t
;

3080 ià(
mode
 & ~(
FALLOC_FL_KEEP_SIZE
 | 
FALLOC_FL_PUNCH_HOLE
 |

3081 
FALLOC_FL_ZERO_RANGE
))

3082  -
EOPNOTSUPP
;

3084 ià(
mode
 & 
FALLOC_FL_PUNCH_HOLE
)

3085  
	`bŒfs_punch_hŞe
(
fe
, 
off£t
, 
Ën
);

3087 
	`bŒfs_šode_lock
(
	`BTRFS_I
(
šode
), 
BTRFS_ILOCK_MMAP
);

3089 ià(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
è&& 
off£t
 + 
Ën
 > 
šode
->
i_size
) {

3090 
»t
 = 
	`šode_Ãwsize_ok
(
šode
, 
off£t
 + 
Ën
);

3091 ià(
»t
)

3092 
out
;

3095 
»t
 = 
	`fe_modif›d
(
fe
);

3096 ià(
»t
)

3097 
out
;

3106 ià(
®loc_¡¬t
 > 
šode
->
i_size
) {

3107 
»t
 = 
	`bŒfs_cÚt_ex·nd
(
	`BTRFS_I
(
šode
), 
	`i_size_»ad
(inode),

3108 
®loc_¡¬t
);

3109 ià(
»t
)

3110 
out
;

3111 } ià(
off£t
 + 
Ën
 > 
šode
->
i_size
) {

3117 
»t
 = 
	`bŒfs_Œunÿ‹_block
(
	`BTRFS_I
(
šode
), inode->
i_size
, 0, 0);

3118 ià(
»t
)

3119 
out
;

3130 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 
®loc_¡¬t
,

3131 
®loc_’d
 - 
®loc_¡¬t
);

3132 ià(
»t
)

3133 
out
;

3135 ià(
mode
 & 
FALLOC_FL_ZERO_RANGE
) {

3136 
»t
 = 
	`bŒfs_z”o_¿nge
(
šode
, 
off£t
, 
Ën
, 
mode
);

3137 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
BTRFS_ILOCK_MMAP
);

3138  
»t
;

3141 
locked_’d
 = 
®loc_’d
 - 1;

3142 
	`lock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
®loc_¡¬t
, 
locked_’d
,

3143 &
ÿched_¡©e
);

3145 
	`bŒfs_as£¹_šode_¿nge_ş—n
(
	`BTRFS_I
(
šode
), 
®loc_¡¬t
, 
locked_’d
);

3148 
cur_off£t
 < 
®loc_’d
) {

3149 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
cur_off£t
,

3150 
®loc_’d
 - 
cur_off£t
);

3151 ià(
	`IS_ERR
(
em
)) {

3152 
»t
 = 
	`PTR_ERR
(
em
);

3155 
Ï¡_by‹
 = 
	`mš
(
	`ex‹Á_m­_’d
(
em
), 
®loc_’d
);

3156 
aùu®_’d
 = 
	`mš_t
(
u64
, 
	`ex‹Á_m­_’d
(
em
), 
off£t
 + 
Ën
);

3157 
Ï¡_by‹
 = 
	`ALIGN
Öa¡_by‹, 
blocksize
);

3158 ià(
em
->
block_¡¬t
 =ğ
EXTENT_MAP_HOLE
 ||

3159 (
cur_off£t
 >ğ
šode
->
i_size
 &&

3160 !
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
))) {

3161 cÚ¡ 
u64
 
¿nge_Ën
 = 
Ï¡_by‹
 - 
cur_off£t
;

3163 
»t
 = 
	`add_çÎoc_¿nge
(&
»£rve_li¡
, 
cur_off£t
, 
¿nge_Ën
);

3164 ià(
»t
 < 0) {

3165 
	`ä“_ex‹Á_m­
(
em
);

3168 
»t
 = 
	`bŒfs_qgroup_»£rve_d©a
(
	`BTRFS_I
(
šode
),

3169 &
d©a_»£rved
, 
cur_off£t
, 
¿nge_Ën
);

3170 ià(
»t
 < 0) {

3171 
	`ä“_ex‹Á_m­
(
em
);

3174 
qgroup_»£rved
 +ğ
¿nge_Ën
;

3175 
d©a_¥aû_Ãeded
 +ğ
¿nge_Ën
;

3177 
	`ä“_ex‹Á_m­
(
em
);

3178 
cur_off£t
 = 
Ï¡_by‹
;

3181 ià(!
»t
 && 
d©a_¥aû_Ãeded
 > 0) {

3186 
»t
 = 
	`bŒfs_®loc_d©a_chunk_Údemªd
(
	`BTRFS_I
(
šode
),

3187 
d©a_¥aû_Ãeded
);

3188 ià(!
»t
)

3189 
d©a_¥aû_»£rved
 = 
d©a_¥aû_Ãeded
;

3196 
	`li¡_fÜ_—ch_’Œy_§ã
(
¿nge
, 
tmp
, &
»£rve_li¡
, 
li¡
) {

3197 ià(!
»t
) {

3198 
»t
 = 
	`bŒfs_´—Îoc_fe_¿nge
(
šode
, 
mode
,

3199 
¿nge
->
¡¬t
,

3200 
¿nge
->
Ën
, 
	`i_blocksize
(
šode
),

3201 
off£t
 + 
Ën
, &
®loc_hšt
);

3206 
d©a_¥aû_»£rved
 -ğ
¿nge
->
Ën
;

3207 
qgroup_»£rved
 -ğ
¿nge
->
Ën
;

3208 } ià(
d©a_¥aû_»£rved
 > 0) {

3209 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
	`BTRFS_I
(
šode
),

3210 
d©a_»£rved
, 
¿nge
->
¡¬t
,

3211 
¿nge
->
Ën
);

3212 
d©a_¥aû_»£rved
 -ğ
¿nge
->
Ën
;

3213 
qgroup_»£rved
 -ğ
¿nge
->
Ën
;

3214 } ià(
qgroup_»£rved
 > 0) {

3215 
	`bŒfs_qgroup_ä“_d©a
(
	`BTRFS_I
(
šode
), 
d©a_»£rved
,

3216 
¿nge
->
¡¬t
,„ªge->
Ën
, 
NULL
);

3217 
qgroup_»£rved
 -ğ
¿nge
->
Ën
;

3219 
	`li¡_d–
(&
¿nge
->
li¡
);

3220 
	`kä“
(
¿nge
);

3222 ià(
»t
 < 0)

3223 
out_uÆock
;

3229 
»t
 = 
	`bŒfs_çÎoÿ‹_upd©e_isize
(
šode
, 
aùu®_’d
, 
mode
);

3230 
out_uÆock
:

3231 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
®loc_¡¬t
, 
locked_’d
,

3232 &
ÿched_¡©e
);

3233 
out
:

3234 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
BTRFS_ILOCK_MMAP
);

3235 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

3236  
»t
;

3237 
	}
}

3245 
boŞ
 
	$fšd_d–®loc_sub¿nge
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
,

3246 
ex‹Á_¡©e
 **
ÿched_¡©e
,

3247 
boŞ
 *
£¬ch_io_Œ“
,

3248 
u64
 *
d–®loc_¡¬t_»t
, u64 *
d–®loc_’d_»t
)

3250 
u64
 
Ën
 = 
’d
 + 1 - 
¡¬t
;

3251 
u64
 
d–®loc_Ën
 = 0;

3252 
bŒfs_Üd”ed_ex‹Á
 *
Û
;

3253 
u64
 
Û_¡¬t
;

3254 
u64
 
Û_’d
;

3261 ià(*
£¬ch_io_Œ“
) {

3262 
	`¥š_lock
(&
šode
->
lock
);

3263 ià(
šode
->
d–®loc_by‹s
 > 0) {

3264 
	`¥š_uÆock
(&
šode
->
lock
);

3265 *
d–®loc_¡¬t_»t
 = 
¡¬t
;

3266 
d–®loc_Ën
 = 
	`couÁ_¿nge_b™s
(&
šode
->
io_Œ“
,

3267 
d–®loc_¡¬t_»t
, 
’d
,

3268 
Ën
, 
EXTENT_DELALLOC
, 1,

3269 
ÿched_¡©e
);

3271 
	`¥š_uÆock
(&
šode
->
lock
);

3275 ià(
d–®loc_Ën
 > 0) {

3280 *
d–®loc_’d_»t
 = *
d–®loc_¡¬t_»t
 + 
d–®loc_Ën
 - 1;

3282 ià(*
d–®loc_¡¬t_»t
 =ğ
¡¬t
) {

3284 ià(*
d–®loc_’d_»t
 =ğ
’d
)

3285  
Œue
;

3287 
¡¬t
 = *
d–®loc_’d_»t
 + 1;

3288 
Ën
 = 
’d
 + 1 - 
¡¬t
;

3292 *
£¬ch_io_Œ“
 = 
çl£
;

3316 
Û
 = 
	`bŒfs_lookup_fœ¡_Üd”ed_¿nge
(
šode
, 
¡¬t
, 
Ën
);

3317 ià(!
Û
)

3318  (
d–®loc_Ën
 > 0);

3321 
Û_¡¬t
 = 
	`max
(
Û
->
fe_off£t
, 
¡¬t
);

3322 
Û_’d
 = 
	`mš
(
Û
->
fe_off£t
 + oe->
num_by‹s
 - 1, 
’d
);

3324 
	`bŒfs_put_Üd”ed_ex‹Á
(
Û
);

3327 ià(
d–®loc_Ën
 == 0) {

3328 *
d–®loc_¡¬t_»t
 = 
Û_¡¬t
;

3329 *
d–®loc_’d_»t
 = 
Û_’d
;

3330  
Œue
;

3338 ià(
Û_¡¬t
 < *
d–®loc_¡¬t_»t
) {

3339 ià(
Û_’d
 < *
d–®loc_¡¬t_»t
)

3340 *
d–®loc_’d_»t
 = 
Û_’d
;

3341 *
d–®loc_¡¬t_»t
 = 
Û_¡¬t
;

3342 } ià(*
d–®loc_’d_»t
 + 1 =ğ
Û_¡¬t
) {

3343 *
d–®loc_’d_»t
 = 
Û_’d
;

3346  
Œue
;

3347 
	}
}

3369 
boŞ
 
	$bŒfs_fšd_d–®loc_š_¿nge
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
,

3370 
ex‹Á_¡©e
 **
ÿched_¡©e
,

3371 
u64
 *
d–®loc_¡¬t_»t
, u64 *
d–®loc_’d_»t
)

3373 
u64
 
cur_off£t
 = 
	`round_down
(
¡¬t
, 
šode
->
roÙ
->
fs_šfo
->
£ùÜsize
);

3374 
u64
 
´ev_d–®loc_’d
 = 0;

3375 
boŞ
 
£¬ch_io_Œ“
 = 
Œue
;

3376 
boŞ
 
»t
 = 
çl£
;

3378 
cur_off£t
 <ğ
’d
) {

3379 
u64
 
d–®loc_¡¬t
;

3380 
u64
 
d–®loc_’d
;

3381 
boŞ
 
d–®loc
;

3383 
d–®loc
 = 
	`fšd_d–®loc_sub¿nge
(
šode
, 
cur_off£t
, 
’d
,

3384 
ÿched_¡©e
, &
£¬ch_io_Œ“
,

3385 &
d–®loc_¡¬t
,

3386 &
d–®loc_’d
);

3387 ià(!
d–®loc
)

3390 ià(
´ev_d–®loc_’d
 == 0) {

3392 *
d–®loc_¡¬t_»t
 = 
	`max
(
d–®loc_¡¬t
, 
¡¬t
);

3393 *
d–®loc_’d_»t
 = 
d–®loc_’d
;

3394 
»t
 = 
Œue
;

3395 } ià(
d–®loc_¡¬t
 =ğ
´ev_d–®loc_’d
 + 1) {

3397 *
d–®loc_’d_»t
 = 
d–®loc_’d
;

3403 
´ev_d–®loc_’d
 = 
d–®loc_’d
;

3404 
cur_off£t
 = 
d–®loc_’d
 + 1;

3405 
	`cÚd_»sched
();

3408  
»t
;

3409 
	}
}

3429 
boŞ
 
	$fšd_desœed_ex‹Á_š_hŞe
(
bŒfs_šode
 *
šode
, 
wh’û
,

3430 
ex‹Á_¡©e
 **
ÿched_¡©e
,

3431 
u64
 
¡¬t
, u64 
’d
, u64 *
¡¬t_»t
)

3433 
u64
 
d–®loc_¡¬t
;

3434 
u64
 
d–®loc_’d
;

3435 
boŞ
 
d–®loc
;

3437 
d–®loc
 = 
	`bŒfs_fšd_d–®loc_š_¿nge
(
šode
, 
¡¬t
, 
’d
, 
ÿched_¡©e
,

3438 &
d–®loc_¡¬t
, &
d–®loc_’d
);

3439 ià(
d–®loc
 && 
wh’û
 =ğ
SEEK_DATA
) {

3440 *
¡¬t_»t
 = 
d–®loc_¡¬t
;

3441  
Œue
;

3444 ià(
d–®loc
 && 
wh’û
 =ğ
SEEK_HOLE
) {

3449 ià(
¡¬t
 < 
d–®loc_¡¬t
) {

3450 *
¡¬t_»t
 = 
¡¬t
;

3451  
Œue
;

3459 ià(
d–®loc_’d
 < 
’d
) {

3460 *
¡¬t_»t
 = 
d–®loc_’d
 + 1;

3461  
Œue
;

3465  
çl£
;

3468 ià(!
d–®loc
 && 
wh’û
 =ğ
SEEK_HOLE
) {

3469 *
¡¬t_»t
 = 
¡¬t
;

3470  
Œue
;

3477  
çl£
;

3478 
	}
}

3480 
loff_t
 
	$fšd_desœed_ex‹Á
(
fe
 *fe, 
loff_t
 
off£t
, 
wh’û
)

3482 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
fe
->
f_m­pšg
->
ho¡
);

3483 
bŒfs_fe_´iv©e
 *
´iv©e
 = 
fe
->
´iv©e_d©a
;

3484 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

3485 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

3486 
ex‹Á_¡©e
 **
d–®loc_ÿched_¡©e
;

3487 cÚ¡ 
loff_t
 
i_size
 = 
	`i_size_»ad
(&
šode
->
vfs_šode
);

3488 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

3489 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

3490 
bŒfs_·th
 *
·th
;

3491 
bŒfs_key
 
key
;

3492 
u64
 
Ï¡_ex‹Á_’d
;

3493 
u64
 
lock¡¬t
;

3494 
u64
 
lock’d
;

3495 
u64
 
¡¬t
;

3496 
»t
;

3497 
boŞ
 
found
 = 
çl£
;

3499 ià(
i_size
 =ğ0 || 
off£t
 >= i_size)

3500  -
ENXIO
;

3506 ià(
wh’û
 =ğ
SEEK_HOLE
 &&

3507 !(
šode
->
æags
 & 
BTRFS_INODE_PREALLOC
) &&

3508 
	`šode_g‘_by‹s
(&
šode
->
vfs_šode
è=ğ
i_size
)

3509  
i_size
;

3511 ià(!
´iv©e
) {

3512 
´iv©e
 = 
	`kz®loc
((*´iv©e), 
GFP_KERNEL
);

3519 
fe
->
´iv©e_d©a
 = 
´iv©e
;

3522 ià(
´iv©e
)

3523 
d–®loc_ÿched_¡©e
 = &
´iv©e
->
Î£ek_ÿched_¡©e
;

3525 
d–®loc_ÿched_¡©e
 = 
NULL
;

3531 
¡¬t
 = 
	`max_t
(
loff_t
, 0, 
off£t
);

3533 
lock¡¬t
 = 
	`round_down
(
¡¬t
, 
fs_šfo
->
£ùÜsize
);

3534 
lock’d
 = 
	`round_up
(
i_size
, 
fs_šfo
->
£ùÜsize
);

3535 ià(
lock’d
 <ğ
lock¡¬t
)

3536 
lock’d
 = 
lock¡¬t
 + 
fs_šfo
->
£ùÜsize
;

3537 
lock’d
--;

3539 
·th
 = 
	`bŒfs_®loc_·th
();

3540 ià(!
·th
)

3541  -
ENOMEM
;

3542 
·th
->
»ada
 = 
READA_FORWARD
;

3544 
key
.
objeùid
 = 
šo
;

3545 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

3546 
key
.
off£t
 = 
¡¬t
;

3548 
Ï¡_ex‹Á_’d
 = 
lock¡¬t
;

3550 
	`lock_ex‹Á
(&
šode
->
io_Œ“
, 
lock¡¬t
, 
lock’d
, &
ÿched_¡©e
);

3552 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

3553 ià(
»t
 < 0) {

3554 
out
;

3555 } ià(
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0) {

3556 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0] - 1);

3557 ià(
key
.
objeùid
 =ğ
šo
 && key.
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
)

3558 
·th
->
¦Ùs
[0]--;

3561 
¡¬t
 < 
i_size
) {

3562 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

3563 
bŒfs_fe_ex‹Á_™em
 *
ex‹Á
;

3564 
u64
 
ex‹Á_’d
;

3565 
u8
 
ty³
;

3567 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

3568 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

3569 ià(
»t
 < 0)

3570 
out
;

3571 ià(
»t
 > 0)

3574 
Ëaf
 = 
·th
->
nodes
[0];

3577 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

3578 ià(
key
.
objeùid
 !ğ
šo
 || key.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

3581 
ex‹Á_’d
 = 
	`bŒfs_fe_ex‹Á_’d
(
·th
);

3587 ià(
ex‹Á_’d
 <ğ
¡¬t
) {

3588 
·th
->
¦Ùs
[0]++;

3593 ià(
Ï¡_ex‹Á_’d
 < 
key
.
off£t
) {

3594 
u64
 
£¬ch_¡¬t
 = 
Ï¡_ex‹Á_’d
;

3595 
u64
 
found_¡¬t
;

3601 ià(
¡¬t
 =ğ
off£t
)

3602 
£¬ch_¡¬t
 = 
off£t
;

3604 
found
 = 
	`fšd_desœed_ex‹Á_š_hŞe
(
šode
, 
wh’û
,

3605 
d–®loc_ÿched_¡©e
,

3606 
£¬ch_¡¬t
,

3607 
key
.
off£t
 - 1,

3608 &
found_¡¬t
);

3609 ià(
found
) {

3610 
¡¬t
 = 
found_¡¬t
;

3619 
ex‹Á
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

3620 
bŒfs_fe_ex‹Á_™em
);

3621 
ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
ex‹Á
);

3628 ià(
ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
 ||

3629 (
ty³
 =ğ
BTRFS_FILE_EXTENT_REG
 &&

3630 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
ex‹Á
) == 0)) {

3635 
u64
 
£¬ch_¡¬t
 = 
key
.
off£t
;

3636 
u64
 
found_¡¬t
;

3642 ià(
¡¬t
 =ğ
off£t
)

3643 
£¬ch_¡¬t
 = 
off£t
;

3645 
found
 = 
	`fšd_desœed_ex‹Á_š_hŞe
(
šode
, 
wh’û
,

3646 
d–®loc_ÿched_¡©e
,

3647 
£¬ch_¡¬t
,

3648 
ex‹Á_’d
 - 1,

3649 &
found_¡¬t
);

3650 ià(
found
) {

3651 
¡¬t
 = 
found_¡¬t
;

3665 ià(
wh’û
 =ğ
SEEK_DATA
) {

3666 
¡¬t
 = 
	`max_t
(
u64
, 
key
.
off£t
, offset);

3667 
found
 = 
Œue
;

3676 
¡¬t
 = 
ex‹Á_’d
;

3677 
Ï¡_ex‹Á_’d
 = 
ex‹Á_’d
;

3678 
·th
->
¦Ùs
[0]++;

3679 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

3680 
»t
 = -
EINTR
;

3681 
out
;

3683 
	`cÚd_»sched
();

3687 ià(!
found
 && 
¡¬t
 < 
i_size
) {

3688 
found
 = 
	`fšd_desœed_ex‹Á_š_hŞe
(
šode
, 
wh’û
,

3689 
d–®loc_ÿched_¡©e
, 
¡¬t
,

3690 
i_size
 - 1, &
¡¬t
);

3691 ià(!
found
)

3692 
¡¬t
 = 
i_size
;

3695 
out
:

3696 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
lock¡¬t
, 
lock’d
, &
ÿched_¡©e
);

3697 
	`bŒfs_ä“_·th
(
·th
);

3699 ià(
»t
 < 0)

3700  
»t
;

3702 ià(
wh’û
 =ğ
SEEK_DATA
 && 
¡¬t
 >ğ
i_size
)

3703  -
ENXIO
;

3705  
	`mš_t
(
loff_t
, 
¡¬t
, 
i_size
);

3706 
	}
}

3708 
loff_t
 
	$bŒfs_fe_Î£ek
(
fe
 *fe, 
loff_t
 
off£t
, 
wh’û
)

3710 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

3711 
šode
 *
f_šode
;

3727 
wh’û
) {

3729  
	`g’”ic_fe_Î£ek
(
fe
, 
off£t
, 
wh’û
);

3730 
SEEK_DATA
:

3731 
SEEK_HOLE
:

3732 
	`bŒfs_šode_lock
(
	`BTRFS_I
(
šode
), 
BTRFS_ILOCK_SHARED
);

3734 
off£t
 = 
	`fšd_desœed_ex‹Á
(
fe
, off£t, 
wh’û
);

3735 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
BTRFS_ILOCK_SHARED
);

3739 ià(
off£t
 < 0)

3740  
off£t
;

3742  
	`vfs_£os
(
fe
, 
off£t
, 
šode
->
i_sb
->
s_maxby‹s
);

3743 
	}
}

3745 
	$bŒfs_fe_İ’
(
šode
 *šode, 
fe
 *
fp
)

3747 
»t
;

3798 
fp
->
f_mode
 |ğ
FMODE_NOWAIT
 | 
FMODE_BUF_RASYNC
 | 
FMODE_BUF_WASYNC
 |

3799 
FMODE_CAN_ODIRECT
;

3801 
»t
 = 
	`fsv”™y_fe_İ’
(
šode
, 
fp
);

3802 ià(
»t
) {

3804  
»t
;

3807  
	`g’”ic_fe_İ’
(
šode
, 
fp
);

3808 
	}
}

3810 
	$check_dœeù_»ad
(
bŒfs_fs_šfo
 *
fs_šfo
,

3811 cÚ¡ 
iov_™”
 *
™”
, 
loff_t
 
off£t
)

3813 
»t
;

3814 
i
, 
£g
;

3816 
»t
 = 
	`check_dœeù_IO
(
fs_šfo
, 
™”
, 
off£t
);

3817 ià(
»t
 < 0)

3818  
»t
;

3820 ià(!
	`™”_is_iovec
(
™”
))

3823 
£g
 = 0; seg < 
™”
->
Ä_£gs
; seg++) {

3824 
i
 = 
£g
 + 1; i < 
™”
->
Ä_£gs
; i++) {

3825 cÚ¡ 
iovec
 *
iov1
 = 
	`™”_iov
(
™”
è+ 
£g
;

3826 cÚ¡ 
iovec
 *
iov2
 = 
	`™”_iov
(
™”
è+ 
i
;

3828 ià(
iov1
->
iov_ba£
 =ğ
iov2
->iov_base)

3829  -
EINVAL
;

3833 
	}
}

3835 
ssize_t
 
	$bŒfs_dœeù_»ad
(
kiocb
 *
iocb
, 
iov_™”
 *
to
)

3837 
šode
 *šodğ
	`fe_šode
(
iocb
->
ki_fp
);

3838 
size_t
 
´ev_Ëá
 = 0;

3839 
ssize_t
 
»ad
 = 0;

3840 
ssize_t
 
»t
;

3842 ià(
	`fsv”™y_aùive
(
šode
))

3845 ià(
	`check_dœeù_»ad
(
	`bŒfs_sb
(
šode
->
i_sb
), 
to
, 
iocb
->
ki_pos
))

3848 
	`bŒfs_šode_lock
(
	`BTRFS_I
(
šode
), 
BTRFS_ILOCK_SHARED
);

3849 
agaš
:

3865 
	`·geçuÉ_di§bË
();

3866 
to
->
noçuÉ
 = 
Œue
;

3867 
»t
 = 
	`bŒfs_dio_»ad
(
iocb
, 
to
, 
»ad
);

3868 
to
->
noçuÉ
 = 
çl£
;

3869 
	`·geçuÉ_’abË
();

3872 ià(
»t
 > 0)

3873 
»ad
 = 
»t
;

3875 ià(
	`iov_™”_couÁ
(
to
è> 0 && (
»t
 =ğ-
EFAULT
 ||„et > 0)) {

3876 cÚ¡ 
size_t
 
Ëá
 = 
	`iov_™”_couÁ
(
to
);

3878 ià(
Ëá
 =ğ
´ev_Ëá
) {

3885 
»t
 = 
»ad
;

3892 
	`çuÉ_š_iov_™”_wr™—bË
(
to
, 
Ëá
);

3893 
´ev_Ëá
 = 
Ëá
;

3894 
agaš
;

3897 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 
BTRFS_ILOCK_SHARED
);

3898  
»t
 < 0 ?„‘ : 
»ad
;

3899 
	}
}

3901 
ssize_t
 
	$bŒfs_fe_»ad_™”
(
kiocb
 *
iocb
, 
iov_™”
 *
to
)

3903 
ssize_t
 
»t
 = 0;

3906 
fe
 *fğ
iocb
->
ki_fp
;

3907 
add»ss_¥aû
 *
m­pšg
 = 
fe
->
f_m­pšg
;

3908 
šode
 *
f_šode
 = 
fe
->f_inode;

3909 
»mÙe
 = 
f_šode
->
has_»mÙe
;

3939 ià(
iocb
->
ki_æags
 & 
IOCB_DIRECT
) {

3940 
»t
 = 
	`bŒfs_dœeù_»ad
(
iocb
, 
to
);

3941 ià(
»t
 < 0 || !
	`iov_™”_couÁ
(
to
) ||

3942 
iocb
->
ki_pos
 >ğ
	`i_size_»ad
(
	`fe_šode
(iocb->
ki_fp
)))

3944  
»t
;

3948  
	`bŒfs_fem­_»ad
(
iocb
, 
to
, 
»t
);

3949 
	}
}

3951 cÚ¡ 
fe_İ”©iÚs
 
	gbŒfs_fe_İ”©iÚs
 = {

3952 .
Î£ek
 = 
bŒfs_fe_Î£ek
,

3953 .
	g»ad_™”
 = 
bŒfs_fe_»ad_™”
,

3954 .
	g¥liû_»ad
 = 
fem­_¥liû_»ad
,

3955 .
	gwr™e_™”
 = 
bŒfs_fe_wr™e_™”
,

3956 .
	g¥liû_wr™e
 = 
™”_fe_¥liû_wr™e
,

3957 .
	gmm­
 = 
bŒfs_fe_mm­
,

3958 .
	gİ’
 = 
bŒfs_fe_İ’
,

3959 .
	g»Ëa£
 = 
bŒfs_»Ëa£_fe
,

3960 .
	gg‘_unm­³d_¬—
 = 
thp_g‘_unm­³d_¬—
,

3961 .
	gfsync
 = 
bŒfs_sync_fe
,

3962 .
	gçÎoÿ‹
 = 
bŒfs_çÎoÿ‹
,

3963 .
	guÆocked_ioùl
 = 
bŒfs_ioùl
,

3964 #ifdeà
CONFIG_COMPAT


3965 .
	gcom·t_ioùl
 = 
bŒfs_com·t_ioùl
,

3967 .
	g»m­_fe_¿nge
 = 
bŒfs_»m­_fe_¿nge
,

3970 
	$bŒfs_fd©awr™e_¿nge
(
šode
 *šode, 
loff_t
 
¡¬t
,†off_ˆ
’d
)

3972 
»t
;

3988 
»t
 = 
	`fem­_fd©awr™e_¿nge
(
šode
->
i_m­pšg
, 
¡¬t
, 
’d
);

3989 ià(!
»t
 && 
	`‹¡_b™
(
BTRFS_INODE_HAS_ASYNC_EXTENT
,

3990 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
))

3991 
»t
 = 
	`fem­_fd©awr™e_¿nge
(
šode
->
i_m­pšg
, 
¡¬t
, 
’d
);

3993  
»t
;

3994 
	}
}

	@file.h

3 #iâdeà
BTRFS_FILE_H


4 
	#BTRFS_FILE_H


	)

6 cÚ¡ 
fe_İ”©iÚs
 
bŒfs_fe_İ”©iÚs
;

8 
bŒfs_sync_fe
(
fe
 *fe, 
loff_t
 
¡¬t
,†off_ˆ
’d
, 
d©async
);

9 
bŒfs_drİ_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

10 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_šode
 *
šode
,

11 
bŒfs_drİ_ex‹Ás_¬gs
 *
¬gs
);

12 
bŒfs_»¶aû_fe_ex‹Ás
(
bŒfs_šode
 *
šode
,

13 
bŒfs_·th
 *
·th
, cÚ¡ 
u64
 
¡¬t
,

14 cÚ¡ 
u64
 
’d
,

15 
bŒfs_»¶aû_ex‹Á_šfo
 *
ex‹Á_šfo
,

16 
bŒfs_Œªs_hªdË
 **
Œªs_out
);

17 
bŒfs_m¬k_ex‹Á_wr™‹n
(
bŒfs_Œªs_hªdË
 *
Œªs
,

18 
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
);

19 
ssize_t
 
bŒfs_do_wr™e_™”
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
,

20 cÚ¡ 
bŒfs_ioùl_’coded_io_¬gs
 *
’coded
);

21 
bŒfs_»Ëa£_fe
(
šode
 *šode, 
fe
 *file);

22 
bŒfs_dœty_·ges
(
bŒfs_šode
 *
šode
, 
·ge
 **
·ges
,

23 
size_t
 
num_·ges
, 
loff_t
 
pos
, size_ˆ
wr™e_by‹s
,

24 
ex‹Á_¡©e
 **
ÿched
, 
boŞ
 
nÜe£rve
);

25 
bŒfs_fd©awr™e_¿nge
(
šode
 *šode, 
loff_t
 
¡¬t
,†off_ˆ
’d
);

26 
bŒfs_check_nocow_lock
(
bŒfs_šode
 *
šode
, 
loff_t
 
pos
,

27 
size_t
 *
wr™e_by‹s
, 
boŞ
 
nowa™
);

28 
bŒfs_check_nocow_uÆock
(
bŒfs_šode
 *
šode
);

29 
boŞ
 
bŒfs_fšd_d–®loc_š_¿nge
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
,

30 
ex‹Á_¡©e
 **
ÿched_¡©e
,

31 
u64
 *
d–®loc_¡¬t_»t
, u64 *
d–®loc_’d_»t
);

	@free-space-cache.c

6 
	~<lšux/·gem­.h
>

7 
	~<lšux/sched.h
>

8 
	~<lšux/sched/sigÇl.h
>

9 
	~<lšux/¦ab.h
>

10 
	~<lšux/m©h64.h
>

11 
	~<lšux/¿‹lim™.h
>

12 
	~<lšux/”rÜ-šjeùiÚ.h
>

13 
	~<lšux/sched/mm.h
>

14 
	~"ù»e.h
"

15 
	~"fs.h
"

16 
	~"mes§ges.h
"

17 
	~"misc.h
"

18 
	~"ä“-¥aû-ÿche.h
"

19 
	~"Œª§ùiÚ.h
"

20 
	~"disk-io.h
"

21 
	~"ex‹Á_io.h
"

22 
	~"vŞumes.h
"

23 
	~"¥aû-šfo.h
"

24 
	~"d–®loc-¥aû.h
"

25 
	~"block-group.h
"

26 
	~"disÿrd.h
"

27 
	~"sub·ge.h
"

28 
	~"šode-™em.h
"

29 
	~"acûssÜs.h
"

30 
	~"fe-™em.h
"

31 
	~"fe.h
"

32 
	~"su³r.h
"

34 
	#BITS_PER_BITMAP
 (
PAGE_SIZE
 * 8UL)

	)

35 
	#MAX_CACHE_BYTES_PER_GIG
 
SZ_64K


	)

36 
	#FORCE_EXTENT_THRESHOLD
 
SZ_1M


	)

38 
kmem_ÿche
 *
	gbŒfs_ä“_¥aû_ÿch•
;

39 
kmem_ÿche
 *
	gbŒfs_ä“_¥aû_b™m­_ÿch•
;

41 
	sbŒfs_Œim_¿nge
 {

42 
u64
 
	m¡¬t
;

43 
u64
 
	mby‹s
;

44 
li¡_h—d
 
	mli¡
;

47 
lšk_ä“_¥aû
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

48 
bŒfs_ä“_¥aû
 *
šfo
);

49 
uÆšk_ä“_¥aû
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

50 
bŒfs_ä“_¥aû
 *
šfo
, 
boŞ
 
upd©e_¡©
);

51 
£¬ch_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

52 
bŒfs_ä“_¥aû
 *
b™m­_šfo
, 
u64
 *
off£t
,

53 
u64
 *
by‹s
, 
boŞ
 
fÜ_®loc
);

54 
ä“_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

55 
bŒfs_ä“_¥aû
 *
b™m­_šfo
);

56 
b™m­_ş—r_b™s
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

57 
bŒfs_ä“_¥aû
 *
šfo
, 
u64
 
off£t
,

58 
u64
 
by‹s
, 
boŞ
 
upd©e_¡©s
);

60 
	$__bŒfs_»move_ä“_¥aû_ÿche
(
bŒfs_ä“_¥aû_ùl
 *
ùl
)

62 
bŒfs_ä“_¥aû
 *
šfo
;

63 
rb_node
 *
node
;

65 (
node
 = 
	`rb_Ï¡
(&
ùl
->
ä“_¥aû_off£t
)è!ğ
NULL
) {

66 
šfo
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

67 ià(!
šfo
->
b™m­
) {

68 
	`uÆšk_ä“_¥aû
(
ùl
, 
šfo
, 
Œue
);

69 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
šfo
);

71 
	`ä“_b™m­
(
ùl
, 
šfo
);

74 
	`cÚd_»sched_lock
(&
ùl
->
Œ“_lock
);

76 
	}
}

78 
šode
 *
	$__lookup_ä“_¥aû_šode
(
bŒfs_roÙ
 *
roÙ
,

79 
bŒfs_·th
 *
·th
,

80 
u64
 
off£t
)

82 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

83 
bŒfs_key
 
key
;

84 
bŒfs_key
 
loÿtiÚ
;

85 
bŒfs_disk_key
 
disk_key
;

86 
bŒfs_ä“_¥aû_h—d”
 *
h—d”
;

87 
ex‹Á_bufãr
 *
Ëaf
;

88 
šode
 *šodğ
NULL
;

89 
nofs_æag
;

90 
»t
;

92 
key
.
objeùid
 = 
BTRFS_FREE_SPACE_OBJECTID
;

93 
key
.
off£t
 = offset;

94 
key
.
ty³
 = 0;

96 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

97 ià(
»t
 < 0)

98  
	`ERR_PTR
(
»t
);

99 ià(
»t
 > 0) {

100 
	`bŒfs_»Ëa£_·th
(
·th
);

101  
	`ERR_PTR
(-
ENOENT
);

104 
Ëaf
 = 
·th
->
nodes
[0];

105 
h—d”
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

106 
bŒfs_ä“_¥aû_h—d”
);

107 
	`bŒfs_ä“_¥aû_key
(
Ëaf
, 
h—d”
, &
disk_key
);

108 
	`bŒfs_disk_key_to_ıu
(&
loÿtiÚ
, &
disk_key
);

109 
	`bŒfs_»Ëa£_·th
(
·th
);

115 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

116 
šode
 = 
	`bŒfs_ig‘_·th
(
fs_šfo
->
sb
, 
loÿtiÚ
.
objeùid
, 
roÙ
, 
·th
);

117 
	`bŒfs_»Ëa£_·th
(
·th
);

118 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

119 ià(
	`IS_ERR
(
šode
))

120  
šode
;

122 
	`m­pšg_£t_gå_mask
(
šode
->
i_m­pšg
,

123 
	`m­pšg_gå_cÚ¡¿št
(
šode
->
i_m­pšg
,

124 ~(
__GFP_FS
 | 
__GFP_HIGHMEM
)));

126  
šode
;

127 
	}
}

129 
šode
 *
	$lookup_ä“_¥aû_šode
(
bŒfs_block_group
 *
block_group
,

130 
bŒfs_·th
 *
·th
)

132 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

133 
šode
 *šodğ
NULL
;

134 
u32
 
æags
 = 
BTRFS_INODE_NODATASUM
 | 
BTRFS_INODE_NODATACOW
;

136 
	`¥š_lock
(&
block_group
->
lock
);

137 ià(
block_group
->
šode
)

138 
šode
 = 
	`ig¿b
(
block_group
->inode);

139 
	`¥š_uÆock
(&
block_group
->
lock
);

140 ià(
šode
)

141  
šode
;

143 
šode
 = 
	`__lookup_ä“_¥aû_šode
(
fs_šfo
->
Œ“_roÙ
, 
·th
,

144 
block_group
->
¡¬t
);

145 ià(
	`IS_ERR
(
šode
))

146  
šode
;

148 
	`¥š_lock
(&
block_group
->
lock
);

149 ià(!((
	`BTRFS_I
(
šode
)->
æags
 & flags) == flags)) {

150 
	`bŒfs_šfo
(
fs_šfo
, "Old style space inode found, converting.");

151 
	`BTRFS_I
(
šode
)->
æags
 |ğ
BTRFS_INODE_NODATASUM
 |

152 
BTRFS_INODE_NODATACOW
;

153 
block_group
->
disk_ÿche_¡©e
 = 
BTRFS_DC_CLEAR
;

156 ià(!
	`‹¡_ªd_£t_b™
(
BLOCK_GROUP_FLAG_IREF
, &
block_group
->
ruÁime_æags
))

157 
block_group
->
šode
 = 
	`ig¿b
(inode);

158 
	`¥š_uÆock
(&
block_group
->
lock
);

160  
šode
;

161 
	}
}

163 
	$__ü—‹_ä“_¥aû_šode
(
bŒfs_roÙ
 *
roÙ
,

164 
bŒfs_Œªs_hªdË
 *
Œªs
,

165 
bŒfs_·th
 *
·th
,

166 
u64
 
šo
, u64 
off£t
)

168 
bŒfs_key
 
key
;

169 
bŒfs_disk_key
 
disk_key
;

170 
bŒfs_ä“_¥aû_h—d”
 *
h—d”
;

171 
bŒfs_šode_™em
 *
šode_™em
;

172 
ex‹Á_bufãr
 *
Ëaf
;

174 cÚ¡ 
u64
 
æags
 = 
BTRFS_INODE_NOCOMPRESS
 | 
BTRFS_INODE_PREALLOC
 |

175 
BTRFS_INODE_NODATASUM
 | 
BTRFS_INODE_NODATACOW
;

176 
»t
;

178 
»t
 = 
	`bŒfs_š£¹_em±y_šode
(
Œªs
, 
roÙ
, 
·th
, 
šo
);

179 ià(
»t
)

180  
»t
;

182 
Ëaf
 = 
·th
->
nodes
[0];

183 
šode_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

184 
bŒfs_šode_™em
);

185 
	`bŒfs_™em_key
(
Ëaf
, &
disk_key
, 
·th
->
¦Ùs
[0]);

186 
	`memz”o_ex‹Á_bufãr
(
Ëaf
, ()
šode_™em
,

187 (*
šode_™em
));

188 
	`bŒfs_£t_šode_g’”©iÚ
(
Ëaf
, 
šode_™em
, 
Œªs
->
Œªsid
);

189 
	`bŒfs_£t_šode_size
(
Ëaf
, 
šode_™em
, 0);

190 
	`bŒfs_£t_šode_nby‹s
(
Ëaf
, 
šode_™em
, 0);

191 
	`bŒfs_£t_šode_uid
(
Ëaf
, 
šode_™em
, 0);

192 
	`bŒfs_£t_šode_gid
(
Ëaf
, 
šode_™em
, 0);

193 
	`bŒfs_£t_šode_mode
(
Ëaf
, 
šode_™em
, 
S_IFREG
 | 0600);

194 
	`bŒfs_£t_šode_æags
(
Ëaf
, 
šode_™em
, 
æags
);

195 
	`bŒfs_£t_šode_Æšk
(
Ëaf
, 
šode_™em
, 1);

196 
	`bŒfs_£t_šode_Œªsid
(
Ëaf
, 
šode_™em
, 
Œªs
->
Œªsid
);

197 
	`bŒfs_£t_šode_block_group
(
Ëaf
, 
šode_™em
, 
off£t
);

198 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

199 
	`bŒfs_»Ëa£_·th
(
·th
);

201 
key
.
objeùid
 = 
BTRFS_FREE_SPACE_OBJECTID
;

202 
key
.
off£t
 = offset;

203 
key
.
ty³
 = 0;

204 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

205 (
bŒfs_ä“_¥aû_h—d”
));

206 ià(
»t
 < 0) {

207 
	`bŒfs_»Ëa£_·th
(
·th
);

208  
»t
;

211 
Ëaf
 = 
·th
->
nodes
[0];

212 
h—d”
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

213 
bŒfs_ä“_¥aû_h—d”
);

214 
	`memz”o_ex‹Á_bufãr
(
Ëaf
, ()
h—d”
, (*header));

215 
	`bŒfs_£t_ä“_¥aû_key
(
Ëaf
, 
h—d”
, &
disk_key
);

216 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

217 
	`bŒfs_»Ëa£_·th
(
·th
);

220 
	}
}

222 
	$ü—‹_ä“_¥aû_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

223 
bŒfs_block_group
 *
block_group
,

224 
bŒfs_·th
 *
·th
)

226 
»t
;

227 
u64
 
šo
;

229 
»t
 = 
	`bŒfs_g‘_ä“_objeùid
(
Œªs
->
fs_šfo
->
Œ“_roÙ
, &
šo
);

230 ià(
»t
 < 0)

231  
»t
;

233  
	`__ü—‹_ä“_¥aû_šode
(
Œªs
->
fs_šfo
->
Œ“_roÙ
,¿ns, 
·th
,

234 
šo
, 
block_group
->
¡¬t
);

235 
	}
}

242 
	$bŒfs_»move_ä“_¥aû_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

243 
šode
 *inode,

244 
bŒfs_block_group
 *
block_group
)

246 
bŒfs_·th
 *
·th
;

247 
bŒfs_key
 
key
;

248 
»t
 = 0;

250 
·th
 = 
	`bŒfs_®loc_·th
();

251 ià(!
·th
)

252  -
ENOMEM
;

254 ià(!
šode
)

255 
šode
 = 
	`lookup_ä“_¥aû_šode
(
block_group
, 
·th
);

256 ià(
	`IS_ERR
(
šode
)) {

257 ià(
	`PTR_ERR
(
šode
è!ğ-
ENOENT
)

258 
»t
 = 
	`PTR_ERR
(
šode
);

259 
out
;

261 
»t
 = 
	`bŒfs_Üphª_add
(
Œªs
, 
	`BTRFS_I
(
šode
));

262 ià(
»t
) {

263 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
šode
));

264 
out
;

266 
	`ş—r_Æšk
(
šode
);

268 
	`¥š_lock
(&
block_group
->
lock
);

269 ià(
	`‹¡_ªd_ş—r_b™
(
BLOCK_GROUP_FLAG_IREF
, &
block_group
->
ruÁime_æags
)) {

270 
block_group
->
šode
 = 
NULL
;

271 
	`¥š_uÆock
(&
block_group
->
lock
);

272 
	`ut
(
šode
);

274 
	`¥š_uÆock
(&
block_group
->
lock
);

277 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
šode
));

279 
key
.
objeùid
 = 
BTRFS_FREE_SPACE_OBJECTID
;

280 
key
.
ty³
 = 0;

281 
key
.
off£t
 = 
block_group
->
¡¬t
;

282 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
,¿ns->
fs_šfo
->
Œ“_roÙ
, &
key
, 
·th
,

284 ià(
»t
) {

285 ià(
»t
 > 0)

286 
»t
 = 0;

287 
out
;

289 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
,¿ns->
fs_šfo
->
Œ“_roÙ
, 
·th
);

290 
out
:

291 
	`bŒfs_ä“_·th
(
·th
);

292  
»t
;

293 
	}
}

295 
	$bŒfs_Œunÿ‹_ä“_¥aû_ÿche
(
bŒfs_Œªs_hªdË
 *
Œªs
,

296 
bŒfs_block_group
 *
block_group
,

297 
šode
 *
vfs_šode
)

299 
bŒfs_Œunÿ‹_cÚŒŞ
 
cÚŒŞ
 = {

300 .
šode
 = 
	`BTRFS_I
(
vfs_šode
),

301 .
Ãw_size
 = 0,

302 .
šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
vfs_šode
)),

303 .
mš_ty³
 = 
BTRFS_EXTENT_DATA_KEY
,

304 .
ş—r_ex‹Á_¿nge
 = 
Œue
,

306 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
vfs_šode
);

307 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

308 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

309 
»t
 = 0;

310 
boŞ
 
locked
 = 
çl£
;

312 ià(
block_group
) {

313 
bŒfs_·th
 *
·th
 = 
	`bŒfs_®loc_·th
();

315 ià(!
·th
) {

316 
»t
 = -
ENOMEM
;

317 
ç
;

319 
locked
 = 
Œue
;

320 
	`mu‹x_lock
(&
Œªs
->
Œª§ùiÚ
->
ÿche_wr™e_mu‹x
);

321 ià(!
	`li¡_em±y
(&
block_group
->
io_li¡
)) {

322 
	`li¡_d–_š™
(&
block_group
->
io_li¡
);

324 
	`bŒfs_wa™_ÿche_io
(
Œªs
, 
block_group
, 
·th
);

325 
	`bŒfs_put_block_group
(
block_group
);

332 
	`¥š_lock
(&
block_group
->
lock
);

333 
block_group
->
disk_ÿche_¡©e
 = 
BTRFS_DC_CLEAR
;

334 
	`¥š_uÆock
(&
block_group
->
lock
);

335 
	`bŒfs_ä“_·th
(
·th
);

338 
	`bŒfs_i_size_wr™e
(
šode
, 0);

339 
	`Œunÿ‹_·geÿche
(
vfs_šode
, 0);

341 
	`lock_ex‹Á
(&
šode
->
io_Œ“
, 0, (
u64
)-1, &
ÿched_¡©e
);

342 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
šode
, 0, (
u64
)-1, 
çl£
);

348 
»t
 = 
	`bŒfs_Œunÿ‹_šode_™ems
(
Œªs
, 
roÙ
, &
cÚŒŞ
);

350 
	`šode_sub_by‹s
(&
šode
->
vfs_šode
, 
cÚŒŞ
.
sub_by‹s
);

351 
	`bŒfs_šode_§ã_disk_i_size_wr™e
(
šode
, 
cÚŒŞ
.
Ï¡_size
);

353 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 0, (
u64
)-1, &
ÿched_¡©e
);

354 ià(
»t
)

355 
ç
;

357 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

359 
ç
:

360 ià(
locked
)

361 
	`mu‹x_uÆock
(&
Œªs
->
Œª§ùiÚ
->
ÿche_wr™e_mu‹x
);

362 ià(
»t
)

363 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

365  
»t
;

366 
	}
}

368 
	$»adah—d_ÿche
(
šode
 *inode)

370 
fe_¿_¡©e
 
¿
;

371 
Ï¡_šdex
;

373 
	`fe_¿_¡©e_š™
(&
¿
, 
šode
->
i_m­pšg
);

374 
Ï¡_šdex
 = (
	`i_size_»ad
(
šode
è- 1è>> 
PAGE_SHIFT
;

376 
	`·ge_ÿche_sync_»adah—d
(
šode
->
i_m­pšg
, &
¿
, 
NULL
, 0, 
Ï¡_šdex
);

377 
	}
}

379 
	$io_ùl_š™
(
bŒfs_io_ùl
 *
io_ùl
, 
šode
 *inode,

380 
wr™e
)

382 
num_·ges
;

384 
num_·ges
 = 
	`DIV_ROUND_UP
(
	`i_size_»ad
(
šode
), 
PAGE_SIZE
);

387 ià(
wr™e
 && (
num_·ges
 * (
u32
è+ (
u64
)è> 
PAGE_SIZE
)

388  -
ENOSPC
;

390 
	`mem£t
(
io_ùl
, 0, (
bŒfs_io_ùl
));

392 
io_ùl
->
·ges
 = 
	`kÿÎoc
(
num_·ges
, (
·ge
 *), 
GFP_NOFS
);

393 ià(!
io_ùl
->
·ges
)

394  -
ENOMEM
;

396 
io_ùl
->
num_·ges
 =‚um_pages;

397 
io_ùl
->
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

398 
io_ùl
->
šode
 = inode;

401 
	}
}

402 
ALLOW_ERROR_INJECTION
(
io_ùl_š™
, 
ERRNO
);

404 
	$io_ùl_ä“
(
bŒfs_io_ùl
 *
io_ùl
)

406 
	`kä“
(
io_ùl
->
·ges
);

407 
io_ùl
->
·ges
 = 
NULL
;

408 
	}
}

410 
	$io_ùl_unm­_·ge
(
bŒfs_io_ùl
 *
io_ùl
)

412 ià(
io_ùl
->
cur
) {

413 
io_ùl
->
cur
 = 
NULL
;

414 
io_ùl
->
Üig
 = 
NULL
;

416 
	}
}

418 
	$io_ùl_m­_·ge
(
bŒfs_io_ùl
 *
io_ùl
, 
ş—r
)

420 
	`ASSERT
(
io_ùl
->
šdex
 < io_ùl->
num_·ges
);

421 
io_ùl
->
·ge
 = io_ùl->
·ges
[io_ùl->
šdex
++];

422 
io_ùl
->
cur
 = 
	`·ge_add»ss
(io_ùl->
·ge
);

423 
io_ùl
->
Üig
 = io_ùl->
cur
;

424 
io_ùl
->
size
 = 
PAGE_SIZE
;

425 ià(
ş—r
)

426 
	`ş—r_·ge
(
io_ùl
->
cur
);

427 
	}
}

429 
	$io_ùl_drİ_·ges
(
bŒfs_io_ùl
 *
io_ùl
)

431 
i
;

433 
	`io_ùl_unm­_·ge
(
io_ùl
);

435 
i
 = 0; i < 
io_ùl
->
num_·ges
; i++) {

436 ià(
io_ùl
->
·ges
[
i
]) {

437 
	`bŒfs_·ge_ş—r_checked
(
io_ùl
->
fs_šfo
,

438 
io_ùl
->
·ges
[
i
],

439 
	`·ge_off£t
(
io_ùl
->
·ges
[
i
]),

440 
PAGE_SIZE
);

441 
	`uÆock_·ge
(
io_ùl
->
·ges
[
i
]);

442 
	`put_·ge
(
io_ùl
->
·ges
[
i
]);

445 
	}
}

447 
	$io_ùl_´•¬e_·ges
(
bŒfs_io_ùl
 *
io_ùl
, 
boŞ
 
u±od©e
)

449 
·ge
 *page;

450 
šode
 *šodğ
io_ùl
->inode;

451 
gå_t
 
mask
 = 
	`bŒfs_®loc_wr™e_mask
(
šode
->
i_m­pšg
);

452 
i
;

454 
i
 = 0; i < 
io_ùl
->
num_·ges
; i++) {

455 
»t
;

457 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
i
, 
mask
);

458 ià(!
·ge
) {

459 
	`io_ùl_drİ_·ges
(
io_ùl
);

460  -
ENOMEM
;

463 
»t
 = 
	`£t_·ge_ex‹Á_m­³d
(
·ge
);

464 ià(
»t
 < 0) {

465 
	`uÆock_·ge
(
·ge
);

466 
	`put_·ge
(
·ge
);

467 
	`io_ùl_drİ_·ges
(
io_ùl
);

468  
»t
;

471 
io_ùl
->
·ges
[
i
] = 
·ge
;

472 ià(
u±od©e
 && !
	`PageU±od©e
(
·ge
)) {

473 
	`bŒfs_»ad_fŞio
(
NULL
, 
	`·ge_fŞio
(
·ge
));

474 
	`lock_·ge
(
·ge
);

475 ià(
·ge
->
m­pšg
 !ğ
šode
->
i_m­pšg
) {

476 
	`bŒfs_”r
(
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
,

478 
	`io_ùl_drİ_·ges
(
io_ùl
);

479  -
EIO
;

481 ià(!
	`PageU±od©e
(
·ge
)) {

482 
	`bŒfs_”r
(
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
,

484 
	`io_ùl_drİ_·ges
(
io_ùl
);

485  -
EIO
;

490 
i
 = 0; i < 
io_ùl
->
num_·ges
; i++)

491 
	`ş—r_·ge_dœty_fÜ_io
(
io_ùl
->
·ges
[
i
]);

494 
	}
}

496 
	$io_ùl_£t_g’”©iÚ
(
bŒfs_io_ùl
 *
io_ùl
, 
u64
 
g’”©iÚ
)

498 
	`io_ùl_m­_·ge
(
io_ùl
, 1);

504 
io_ùl
->
cur
 +ğ((
u32
è* io_ùl->
num_·ges
);

505 
io_ùl
->
size
 -ğ(
u64
è+ ((
u32
è* io_ùl->
num_·ges
);

507 
	`put_uÇligÃd_Ë64
(
g’”©iÚ
, 
io_ùl
->
cur
);

508 
io_ùl
->
cur
 +ğ(
u64
);

509 
	}
}

511 
	$io_ùl_check_g’”©iÚ
(
bŒfs_io_ùl
 *
io_ùl
, 
u64
 
g’”©iÚ
)

513 
u64
 
ÿche_g’
;

519 
io_ùl
->
cur
 +ğ(
u32
è* io_ùl->
num_·ges
;

520 
io_ùl
->
size
 -ğ(
u64
è+ ((
u32
è* io_ùl->
num_·ges
);

522 
ÿche_g’
 = 
	`g‘_uÇligÃd_Ë64
(
io_ùl
->
cur
);

523 ià(
ÿche_g’
 !ğ
g’”©iÚ
) {

524 
	`bŒfs_”r_¾
(
io_ùl
->
fs_šfo
,

526 
ÿche_g’
, 
g’”©iÚ
);

527 
	`io_ùl_unm­_·ge
(
io_ùl
);

528  -
EIO
;

530 
io_ùl
->
cur
 +ğ(
u64
);

532 
	}
}

534 
	$io_ùl_£t_üc
(
bŒfs_io_ùl
 *
io_ùl
, 
šdex
)

536 
u32
 *
tmp
;

537 
u32
 
üc
 = ~(u32)0;

538 
off£t
 = 0;

540 ià(
šdex
 == 0)

541 
off£t
 = (
u32
è* 
io_ùl
->
num_·ges
;

543 
üc
 = 
	`bŒfs_üc32c
(üc, 
io_ùl
->
Üig
 + 
off£t
, 
PAGE_SIZE
 - offset);

544 
	`bŒfs_üc32c_fš®
(
üc
, (
u8
 *)&crc);

545 
	`io_ùl_unm­_·ge
(
io_ùl
);

546 
tmp
 = 
	`·ge_add»ss
(
io_ùl
->
·ges
[0]);

547 
tmp
 +ğ
šdex
;

548 *
tmp
 = 
üc
;

549 
	}
}

551 
	$io_ùl_check_üc
(
bŒfs_io_ùl
 *
io_ùl
, 
šdex
)

553 
u32
 *
tmp
, 
v®
;

554 
u32
 
üc
 = ~(u32)0;

555 
off£t
 = 0;

557 ià(
šdex
 == 0)

558 
off£t
 = (
u32
è* 
io_ùl
->
num_·ges
;

560 
tmp
 = 
	`·ge_add»ss
(
io_ùl
->
·ges
[0]);

561 
tmp
 +ğ
šdex
;

562 
v®
 = *
tmp
;

564 
	`io_ùl_m­_·ge
(
io_ùl
, 0);

565 
üc
 = 
	`bŒfs_üc32c
(üc, 
io_ùl
->
Üig
 + 
off£t
, 
PAGE_SIZE
 - offset);

566 
	`bŒfs_üc32c_fš®
(
üc
, (
u8
 *)&crc);

567 ià(
v®
 !ğ
üc
) {

568 
	`bŒfs_”r_¾
(
io_ùl
->
fs_šfo
,

570 
	`io_ùl_unm­_·ge
(
io_ùl
);

571  -
EIO
;

575 
	}
}

577 
	$io_ùl_add_’Œy
(
bŒfs_io_ùl
 *
io_ùl
, 
u64
 
off£t
, u64 
by‹s
,

578 *
b™m­
)

580 
bŒfs_ä“_¥aû_’Œy
 *
’Œy
;

582 ià(!
io_ùl
->
cur
)

583  -
ENOSPC
;

585 
’Œy
 = 
io_ùl
->
cur
;

586 
	`put_uÇligÃd_Ë64
(
off£t
, &
’Œy
->offset);

587 
	`put_uÇligÃd_Ë64
(
by‹s
, &
’Œy
->bytes);

588 
’Œy
->
ty³
 = (
b™m­
è? 
BTRFS_FREE_SPACE_BITMAP
 :

589 
BTRFS_FREE_SPACE_EXTENT
;

590 
io_ùl
->
cur
 +ğ(
bŒfs_ä“_¥aû_’Œy
);

591 
io_ùl
->
size
 -ğ(
bŒfs_ä“_¥aû_’Œy
);

593 ià(
io_ùl
->
size
 >ğ(
bŒfs_ä“_¥aû_’Œy
))

596 
	`io_ùl_£t_üc
(
io_ùl
, io_ùl->
šdex
 - 1);

599 ià(
io_ùl
->
šdex
 >ğio_ùl->
num_·ges
)

603 
	`io_ùl_m­_·ge
(
io_ùl
, 1);

605 
	}
}

607 
	$io_ùl_add_b™m­
(
bŒfs_io_ùl
 *
io_ùl
, *
b™m­
)

609 ià(!
io_ùl
->
cur
)

610  -
ENOSPC
;

616 ià(
io_ùl
->
cur
 !ğio_ùl->
Üig
) {

617 
	`io_ùl_£t_üc
(
io_ùl
, io_ùl->
šdex
 - 1);

618 ià(
io_ùl
->
šdex
 >ğio_ùl->
num_·ges
)

619  -
ENOSPC
;

620 
	`io_ùl_m­_·ge
(
io_ùl
, 0);

623 
	`cİy_·ge
(
io_ùl
->
cur
, 
b™m­
);

624 
	`io_ùl_£t_üc
(
io_ùl
, io_ùl->
šdex
 - 1);

625 ià(
io_ùl
->
šdex
 < io_ùl->
num_·ges
)

626 
	`io_ùl_m­_·ge
(
io_ùl
, 0);

628 
	}
}

630 
	$io_ùl_z”o_»maššg_·ges
(
bŒfs_io_ùl
 *
io_ùl
)

636 ià(
io_ùl
->
cur
 !ğio_ùl->
Üig
)

637 
	`io_ùl_£t_üc
(
io_ùl
, io_ùl->
šdex
 - 1);

639 
	`io_ùl_unm­_·ge
(
io_ùl
);

641 
io_ùl
->
šdex
 < io_ùl->
num_·ges
) {

642 
	`io_ùl_m­_·ge
(
io_ùl
, 1);

643 
	`io_ùl_£t_üc
(
io_ùl
, io_ùl->
šdex
 - 1);

645 
	}
}

647 
	$io_ùl_»ad_’Œy
(
bŒfs_io_ùl
 *
io_ùl
,

648 
bŒfs_ä“_¥aû
 *
’Œy
, 
u8
 *
ty³
)

650 
bŒfs_ä“_¥aû_’Œy
 *
e
;

651 
»t
;

653 ià(!
io_ùl
->
cur
) {

654 
»t
 = 
	`io_ùl_check_üc
(
io_ùl
, io_ùl->
šdex
);

655 ià(
»t
)

656  
»t
;

659 
e
 = 
io_ùl
->
cur
;

660 
’Œy
->
off£t
 = 
	`g‘_uÇligÃd_Ë64
(&
e
->offset);

661 
’Œy
->
by‹s
 = 
	`g‘_uÇligÃd_Ë64
(&
e
->bytes);

662 *
ty³
 = 
e
->type;

663 
io_ùl
->
cur
 +ğ(
bŒfs_ä“_¥aû_’Œy
);

664 
io_ùl
->
size
 -ğ(
bŒfs_ä“_¥aû_’Œy
);

666 ià(
io_ùl
->
size
 >ğ(
bŒfs_ä“_¥aû_’Œy
))

669 
	`io_ùl_unm­_·ge
(
io_ùl
);

672 
	}
}

674 
	$io_ùl_»ad_b™m­
(
bŒfs_io_ùl
 *
io_ùl
,

675 
bŒfs_ä“_¥aû
 *
’Œy
)

677 
»t
;

679 
»t
 = 
	`io_ùl_check_üc
(
io_ùl
, io_ùl->
šdex
);

680 ià(
»t
)

681  
»t
;

683 
	`cİy_·ge
(
’Œy
->
b™m­
, 
io_ùl
->
cur
);

684 
	`io_ùl_unm­_·ge
(
io_ùl
);

687 
	}
}

689 
	$»ÿlcuÏ‹_th»shŞds
(
bŒfs_ä“_¥aû_ùl
 *
ùl
)

691 
bŒfs_block_group
 *
block_group
 = 
ùl
->block_group;

692 
u64
 
max_by‹s
;

693 
u64
 
b™m­_by‹s
;

694 
u64
 
ex‹Á_by‹s
;

695 
u64
 
size
 = 
block_group
->
Ëngth
;

696 
u64
 
by‹s_³r_bg
 = 
BITS_PER_BITMAP
 * 
ùl
->
un™
;

697 
u64
 
max_b™m­s
 = 
	`div64_u64
(
size
 + 
by‹s_³r_bg
 - 1, bytes_per_bg);

699 
max_b™m­s
 = 
	`max_t
(
u64
, max_bitmaps, 1);

701 ià(
ùl
->
tÙ®_b™m­s
 > 
max_b™m­s
)

702 
	`bŒfs_”r
(
block_group
->
fs_šfo
,

704 
block_group
->
¡¬t
, block_group->
Ëngth
,

705 
ùl
->
tÙ®_b™m­s
, c->
un™
, 
max_b™m­s
,

706 
by‹s_³r_bg
);

707 
	`ASSERT
(
ùl
->
tÙ®_b™m­s
 <ğ
max_b™m­s
);

715 ià(
size
 < 
SZ_1G
)

716 
max_by‹s
 = 
MAX_CACHE_BYTES_PER_GIG
;

718 
max_by‹s
 = 
MAX_CACHE_BYTES_PER_GIG
 * 
	`div_u64
(
size
, 
SZ_1G
);

720 
b™m­_by‹s
 = 
ùl
->
tÙ®_b™m­s
 * c->
un™
;

726 
ex‹Á_by‹s
 = 
max_by‹s
 - 
b™m­_by‹s
;

727 
ex‹Á_by‹s
 = 
	`mš_t
(
u64
,ƒx‹Á_by‹s, 
max_by‹s
 >> 1);

729 
ùl
->
ex‹Ás_th»sh
 =

730 
	`div_u64
(
ex‹Á_by‹s
, (
bŒfs_ä“_¥aû
));

731 
	}
}

733 
	$__lßd_ä“_¥aû_ÿche
(
bŒfs_roÙ
 *
roÙ
, 
šode
 *inode,

734 
bŒfs_ä“_¥aû_ùl
 *
ùl
,

735 
bŒfs_·th
 *
·th
, 
u64
 
off£t
)

737 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

738 
bŒfs_ä“_¥aû_h—d”
 *
h—d”
;

739 
ex‹Á_bufãr
 *
Ëaf
;

740 
bŒfs_io_ùl
 
io_ùl
;

741 
bŒfs_key
 
key
;

742 
bŒfs_ä“_¥aû
 *
e
, *
n
;

743 
	`LIST_HEAD
(
b™m­s
);

744 
u64
 
num_’Œ›s
;

745 
u64
 
num_b™m­s
;

746 
u64
 
g’”©iÚ
;

747 
u8
 
ty³
;

748 
»t
 = 0;

751 ià(!
	`i_size_»ad
(
šode
))

754 
key
.
objeùid
 = 
BTRFS_FREE_SPACE_OBJECTID
;

755 
key
.
off£t
 = offset;

756 
key
.
ty³
 = 0;

758 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

759 ià(
»t
 < 0)

761 ià(
»t
 > 0) {

762 
	`bŒfs_»Ëa£_·th
(
·th
);

766 
»t
 = -1;

768 
Ëaf
 = 
·th
->
nodes
[0];

769 
h—d”
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

770 
bŒfs_ä“_¥aû_h—d”
);

771 
num_’Œ›s
 = 
	`bŒfs_ä“_¥aû_’Œ›s
(
Ëaf
, 
h—d”
);

772 
num_b™m­s
 = 
	`bŒfs_ä“_¥aû_b™m­s
(
Ëaf
, 
h—d”
);

773 
g’”©iÚ
 = 
	`bŒfs_ä“_¥aû_g’”©iÚ
(
Ëaf
, 
h—d”
);

774 
	`bŒfs_»Ëa£_·th
(
·th
);

776 ià(!
	`BTRFS_I
(
šode
)->
g’”©iÚ
) {

777 
	`bŒfs_šfo
(
fs_šfo
,

779 
off£t
);

783 ià(
	`BTRFS_I
(
šode
)->
g’”©iÚ
 != generation) {

784 
	`bŒfs_”r
(
fs_šfo
,

786 
	`BTRFS_I
(
šode
)->
g’”©iÚ
, generation);

790 ià(!
num_’Œ›s
)

793 
»t
 = 
	`io_ùl_š™
(&
io_ùl
, 
šode
, 0);

794 ià(
»t
)

795  
»t
;

797 
	`»adah—d_ÿche
(
šode
);

799 
»t
 = 
	`io_ùl_´•¬e_·ges
(&
io_ùl
, 
Œue
);

800 ià(
»t
)

801 
out
;

803 
»t
 = 
	`io_ùl_check_üc
(&
io_ùl
, 0);

804 ià(
»t
)

805 
ä“_ÿche
;

807 
»t
 = 
	`io_ùl_check_g’”©iÚ
(&
io_ùl
, 
g’”©iÚ
);

808 ià(
»t
)

809 
ä“_ÿche
;

811 
num_’Œ›s
) {

812 
e
 = 
	`kmem_ÿche_z®loc
(
bŒfs_ä“_¥aû_ÿch•
,

813 
GFP_NOFS
);

814 ià(!
e
) {

815 
»t
 = -
ENOMEM
;

816 
ä“_ÿche
;

819 
»t
 = 
	`io_ùl_»ad_’Œy
(&
io_ùl
, 
e
, &
ty³
);

820 ià(
»t
) {

821 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
e
);

822 
ä“_ÿche
;

825 ià(!
e
->
by‹s
) {

826 
»t
 = -1;

827 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
e
);

828 
ä“_ÿche
;

831 ià(
ty³
 =ğ
BTRFS_FREE_SPACE_EXTENT
) {

832 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

833 
»t
 = 
	`lšk_ä“_¥aû
(
ùl
, 
e
);

834 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

835 ià(
»t
) {

836 
	`bŒfs_”r
(
fs_šfo
,

838 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
e
);

839 
ä“_ÿche
;

842 
	`ASSERT
(
num_b™m­s
);

843 
num_b™m­s
--;

844 
e
->
b™m­
 = 
	`kmem_ÿche_z®loc
(

845 
bŒfs_ä“_¥aû_b™m­_ÿch•
, 
GFP_NOFS
);

846 ià(!
e
->
b™m­
) {

847 
»t
 = -
ENOMEM
;

848 
	`kmem_ÿche_ä“
(

849 
bŒfs_ä“_¥aû_ÿch•
, 
e
);

850 
ä“_ÿche
;

852 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

853 
»t
 = 
	`lšk_ä“_¥aû
(
ùl
, 
e
);

854 ià(
»t
) {

855 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

856 
	`bŒfs_”r
(
fs_šfo
,

858 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
e
);

859 
ä“_ÿche
;

861 
ùl
->
tÙ®_b™m­s
++;

862 
	`»ÿlcuÏ‹_th»shŞds
(
ùl
);

863 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

864 
	`li¡_add_
(&
e
->
li¡
, &
b™m­s
);

867 
num_’Œ›s
--;

870 
	`io_ùl_unm­_·ge
(&
io_ùl
);

876 
	`li¡_fÜ_—ch_’Œy_§ã
(
e
, 
n
, &
b™m­s
, 
li¡
) {

877 
	`li¡_d–_š™
(&
e
->
li¡
);

878 
»t
 = 
	`io_ùl_»ad_b™m­
(&
io_ùl
, 
e
);

879 ià(
»t
)

880 
ä“_ÿche
;

883 
	`io_ùl_drİ_·ges
(&
io_ùl
);

884 
»t
 = 1;

885 
out
:

886 
	`io_ùl_ä“
(&
io_ùl
);

887  
»t
;

888 
ä“_ÿche
:

889 
	`io_ùl_drİ_·ges
(&
io_ùl
);

891 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

892 
	`__bŒfs_»move_ä“_¥aû_ÿche
(
ùl
);

893 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

894 
out
;

895 
	}
}

897 
	$cİy_ä“_¥aû_ÿche
(
bŒfs_block_group
 *
block_group
,

898 
bŒfs_ä“_¥aû_ùl
 *
ùl
)

900 
bŒfs_ä“_¥aû
 *
šfo
;

901 
rb_node
 *
n
;

902 
»t
 = 0;

904 !
»t
 && (
n
 = 
	`rb_fœ¡
(&
ùl
->
ä“_¥aû_off£t
)è!ğ
NULL
) {

905 
šfo
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

906 ià(!
šfo
->
b™m­
) {

907 cÚ¡ 
u64
 
off£t
 = 
šfo
->offset;

908 cÚ¡ 
u64
 
by‹s
 = 
šfo
->bytes;

910 
	`uÆšk_ä“_¥aû
(
ùl
, 
šfo
, 
Œue
);

911 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

912 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
šfo
);

913 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
block_group
, 
off£t
, 
by‹s
);

914 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

916 
u64
 
off£t
 = 
šfo
->offset;

917 
u64
 
by‹s
 = 
ùl
->
un™
;

919 
»t
 = 
	`£¬ch_b™m­
(
ùl
, 
šfo
, &
off£t
, &
by‹s
, 
çl£
);

920 ià(
»t
 == 0) {

921 
	`b™m­_ş—r_b™s
(
ùl
, 
šfo
, 
off£t
, 
by‹s
, 
Œue
);

922 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

923 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
block_group
, 
off£t
,

924 
by‹s
);

925 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

927 
	`ä“_b™m­
(
ùl
, 
šfo
);

928 
»t
 = 0;

931 
	`cÚd_»sched_lock
(&
ùl
->
Œ“_lock
);

933  
»t
;

934 
	}
}

936 
lock_şass_key
 
	gbŒfs_ä“_¥aû_šode_key
;

938 
	$lßd_ä“_¥aû_ÿche
(
bŒfs_block_group
 *
block_group
)

940 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

941 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

942 
bŒfs_ä“_¥aû_ùl
 
tmp_ùl
 = {};

943 
šode
 *inode;

944 
bŒfs_·th
 *
·th
;

945 
»t
 = 0;

946 
boŞ
 
m©ched
;

947 
u64
 
u£d
 = 
block_group
->used;

954 
	`bŒfs_š™_ä“_¥aû_ùl
(
block_group
, &
tmp_ùl
);

960 
	`¥š_lock
(&
block_group
->
lock
);

961 ià(
block_group
->
disk_ÿche_¡©e
 !ğ
BTRFS_DC_WRITTEN
) {

962 
	`¥š_uÆock
(&
block_group
->
lock
);

965 
	`¥š_uÆock
(&
block_group
->
lock
);

967 
·th
 = 
	`bŒfs_®loc_·th
();

968 ià(!
·th
)

970 
·th
->
£¬ch_comm™_roÙ
 = 1;

971 
·th
->
sk_lockšg
 = 1;

992 
šode
 = 
	`lookup_ä“_¥aû_šode
(
block_group
, 
·th
);

993 ià(
	`IS_ERR
(
šode
)) {

994 
	`bŒfs_ä“_·th
(
·th
);

999 
	`¥š_lock
(&
block_group
->
lock
);

1000 ià(
block_group
->
disk_ÿche_¡©e
 !ğ
BTRFS_DC_WRITTEN
) {

1001 
	`¥š_uÆock
(&
block_group
->
lock
);

1002 
	`bŒfs_ä“_·th
(
·th
);

1003 
out
;

1005 
	`¥š_uÆock
(&
block_group
->
lock
);

1012 
	`lockd•_£t_şass
(&(&
šode
->
i_d©a
)->
šv®id©e_lock
,

1013 &
bŒfs_ä“_¥aû_šode_key
);

1015 
»t
 = 
	`__lßd_ä“_¥aû_ÿche
(
fs_šfo
->
Œ“_roÙ
, 
šode
, &
tmp_ùl
,

1016 
·th
, 
block_group
->
¡¬t
);

1017 
	`bŒfs_ä“_·th
(
·th
);

1018 ià(
»t
 <= 0)

1019 
out
;

1021 
m©ched
 = (
tmp_ùl
.
ä“_¥aû
 =ğ(
block_group
->
Ëngth
 - 
u£d
 -

1022 
block_group
->
by‹s_su³r
));

1024 ià(
m©ched
) {

1025 
	`¥š_lock
(&
tmp_ùl
.
Œ“_lock
);

1026 
»t
 = 
	`cİy_ä“_¥aû_ÿche
(
block_group
, &
tmp_ùl
);

1027 
	`¥š_uÆock
(&
tmp_ùl
.
Œ“_lock
);

1032 ià(
»t
 == 0)

1033 
»t
 = 1;

1039 
	`¥š_lock
(&
tmp_ùl
.
Œ“_lock
);

1040 
	`__bŒfs_»move_ä“_¥aû_ÿche
(&
tmp_ùl
);

1041 
	`¥š_uÆock
(&
tmp_ùl
.
Œ“_lock
);

1042 
	`bŒfs_w¬n
(
fs_šfo
,

1044 
block_group
->
¡¬t
);

1045 
»t
 = -1;

1047 
out
:

1048 ià(
»t
 < 0) {

1050 
	`¥š_lock
(&
block_group
->
lock
);

1051 
block_group
->
disk_ÿche_¡©e
 = 
BTRFS_DC_CLEAR
;

1052 
	`¥š_uÆock
(&
block_group
->
lock
);

1053 
»t
 = 0;

1055 
	`bŒfs_w¬n
(
fs_šfo
,

1057 
block_group
->
¡¬t
);

1060 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

1061 
	`bŒfs_disÿrd_upd©e_disÿrdabË
(
block_group
);

1062 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

1063 
	`ut
(
šode
);

1064  
»t
;

1065 
	}
}

1067 
nošlše_fÜ_¡ack


1068 
	$wr™e_ÿche_ex‹Á_’Œ›s
(
bŒfs_io_ùl
 *
io_ùl
,

1069 
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1070 
bŒfs_block_group
 *
block_group
,

1071 *
’Œ›s
, *
b™m­s
,

1072 
li¡_h—d
 *
b™m­_li¡
)

1074 
»t
;

1075 
bŒfs_ä“_şu¡”
 *
şu¡”
 = 
NULL
;

1076 
bŒfs_ä“_şu¡”
 *
şu¡”_locked
 = 
NULL
;

1077 
rb_node
 *
node
 = 
	`rb_fœ¡
(&
ùl
->
ä“_¥aû_off£t
);

1078 
bŒfs_Œim_¿nge
 *
Œim_’Œy
;

1081 ià(
block_group
 && !
	`li¡_em±y
(&block_group->
şu¡”_li¡
)) {

1082 
şu¡”
 = 
	`li¡_’Œy
(
block_group
->
şu¡”_li¡
.
Ãxt
,

1083 
bŒfs_ä“_şu¡”
,

1084 
block_group_li¡
);

1087 ià(!
node
 && 
şu¡”
) {

1088 
şu¡”_locked
 = 
şu¡”
;

1089 
	`¥š_lock
(&
şu¡”_locked
->
lock
);

1090 
node
 = 
	`rb_fœ¡
(&
şu¡”
->
roÙ
);

1091 
şu¡”
 = 
NULL
;

1095 
node
) {

1096 
bŒfs_ä“_¥aû
 *
e
;

1098 
e
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

1099 *
’Œ›s
 += 1;

1101 
»t
 = 
	`io_ùl_add_’Œy
(
io_ùl
, 
e
->
off£t
,ƒ->
by‹s
,

1102 
e
->
b™m­
);

1103 ià(
»t
)

1104 
ç
;

1106 ià(
e
->
b™m­
) {

1107 
	`li¡_add_
(&
e
->
li¡
, 
b™m­_li¡
);

1108 *
b™m­s
 += 1;

1110 
node
 = 
	`rb_Ãxt
(node);

1111 ià(!
node
 && 
şu¡”
) {

1112 
node
 = 
	`rb_fœ¡
(&
şu¡”
->
roÙ
);

1113 
şu¡”_locked
 = 
şu¡”
;

1114 
	`¥š_lock
(&
şu¡”_locked
->
lock
);

1115 
şu¡”
 = 
NULL
;

1118 ià(
şu¡”_locked
) {

1119 
	`¥š_uÆock
(&
şu¡”_locked
->
lock
);

1120 
şu¡”_locked
 = 
NULL
;

1129 
	`li¡_fÜ_—ch_’Œy
(
Œim_’Œy
, &
ùl
->
Œimmšg_¿nges
, 
li¡
) {

1130 
»t
 = 
	`io_ùl_add_’Œy
(
io_ùl
, 
Œim_’Œy
->
¡¬t
,

1131 
Œim_’Œy
->
by‹s
, 
NULL
);

1132 ià(
»t
)

1133 
ç
;

1134 *
’Œ›s
 += 1;

1138 
ç
:

1139 ià(
şu¡”_locked
)

1140 
	`¥š_uÆock
(&
şu¡”_locked
->
lock
);

1141  -
ENOSPC
;

1142 
	}
}

1144 
nošlše_fÜ_¡ack
 

1145 
	$upd©e_ÿche_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1146 
bŒfs_roÙ
 *
roÙ
,

1147 
šode
 *inode,

1148 
bŒfs_·th
 *
·th
, 
u64
 
off£t
,

1149 
’Œ›s
, 
b™m­s
)

1151 
bŒfs_key
 
key
;

1152 
bŒfs_ä“_¥aû_h—d”
 *
h—d”
;

1153 
ex‹Á_bufãr
 *
Ëaf
;

1154 
»t
;

1156 
key
.
objeùid
 = 
BTRFS_FREE_SPACE_OBJECTID
;

1157 
key
.
off£t
 = offset;

1158 
key
.
ty³
 = 0;

1160 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

1161 ià(
»t
 < 0) {

1162 
	`ş—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0, inode->
i_size
 - 1,

1163 
EXTENT_DELALLOC
, 
NULL
);

1164 
ç
;

1166 
Ëaf
 = 
·th
->
nodes
[0];

1167 ià(
»t
 > 0) {

1168 
bŒfs_key
 
found_key
;

1169 
	`ASSERT
(
·th
->
¦Ùs
[0]);

1170 
·th
->
¦Ùs
[0]--;

1171 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

1172 ià(
found_key
.
objeùid
 !ğ
BTRFS_FREE_SPACE_OBJECTID
 ||

1173 
found_key
.
off£t
 != offset) {

1174 
	`ş—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0,

1175 
šode
->
i_size
 - 1, 
EXTENT_DELALLOC
,

1176 
NULL
);

1177 
	`bŒfs_»Ëa£_·th
(
·th
);

1178 
ç
;

1182 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 
Œªs
->
Œªsid
;

1183 
h—d”
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1184 
bŒfs_ä“_¥aû_h—d”
);

1185 
	`bŒfs_£t_ä“_¥aû_’Œ›s
(
Ëaf
, 
h—d”
, 
’Œ›s
);

1186 
	`bŒfs_£t_ä“_¥aû_b™m­s
(
Ëaf
, 
h—d”
, 
b™m­s
);

1187 
	`bŒfs_£t_ä“_¥aû_g’”©iÚ
(
Ëaf
, 
h—d”
, 
Œªs
->
Œªsid
);

1188 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

1189 
	`bŒfs_»Ëa£_·th
(
·th
);

1193 
ç
:

1195 
	}
}

1197 
nošlše_fÜ_¡ack
 
	$wr™e_pšÃd_ex‹Á_’Œ›s
(

1198 
bŒfs_Œªs_hªdË
 *
Œªs
,

1199 
bŒfs_block_group
 *
block_group
,

1200 
bŒfs_io_ùl
 *
io_ùl
,

1201 *
’Œ›s
)

1203 
u64
 
¡¬t
, 
ex‹Á_¡¬t
, 
ex‹Á_’d
, 
Ën
;

1204 
ex‹Á_io_Œ“
 *
uÅš
 = 
NULL
;

1205 
»t
;

1207 ià(!
block_group
)

1217 
uÅš
 = &
Œªs
->
Œª§ùiÚ
->
pšÃd_ex‹Ás
;

1219 
¡¬t
 = 
block_group
->start;

1221 
¡¬t
 < 
block_group
->¡¬ˆ+ block_group->
Ëngth
) {

1222 ià(!
	`fšd_fœ¡_ex‹Á_b™
(
uÅš
, 
¡¬t
,

1223 &
ex‹Á_¡¬t
, &
ex‹Á_’d
,

1224 
EXTENT_DIRTY
, 
NULL
))

1228 ià(
ex‹Á_¡¬t
 >ğ
block_group
->
¡¬t
 + block_group->
Ëngth
)

1231 
ex‹Á_¡¬t
 = 
	`max
Óx‹Á_¡¬t, 
¡¬t
);

1232 
ex‹Á_’d
 = 
	`mš
(
block_group
->
¡¬t
 + block_group->
Ëngth
,

1233 
ex‹Á_’d
 + 1);

1234 
Ën
 = 
ex‹Á_’d
 - 
ex‹Á_¡¬t
;

1236 *
’Œ›s
 += 1;

1237 
»t
 = 
	`io_ùl_add_’Œy
(
io_ùl
, 
ex‹Á_¡¬t
, 
Ën
, 
NULL
);

1238 ià(
»t
)

1239  -
ENOSPC
;

1241 
¡¬t
 = 
ex‹Á_’d
;

1245 
	}
}

1247 
nošlše_fÜ_¡ack
 

1248 
	$wr™e_b™m­_’Œ›s
(
bŒfs_io_ùl
 *
io_ùl
, 
li¡_h—d
 *
b™m­_li¡
)

1250 
bŒfs_ä“_¥aû
 *
’Œy
, *
Ãxt
;

1251 
»t
;

1254 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
Ãxt
, 
b™m­_li¡
, 
li¡
) {

1255 
»t
 = 
	`io_ùl_add_b™m­
(
io_ùl
, 
’Œy
->
b™m­
);

1256 ià(
»t
)

1257  -
ENOSPC
;

1258 
	`li¡_d–_š™
(&
’Œy
->
li¡
);

1262 
	}
}

1264 
	$æush_dœty_ÿche
(
šode
 *inode)

1266 
»t
;

1268 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 0, (
u64
)-1);

1269 ià(
»t
)

1270 
	`ş—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0, inode->
i_size
 - 1,

1271 
EXTENT_DELALLOC
, 
NULL
);

1273  
»t
;

1274 
	}
}

1276 
nošlše_fÜ_¡ack


1277 
	$ş—nup_b™m­_li¡
(
li¡_h—d
 *
b™m­_li¡
)

1279 
bŒfs_ä“_¥aû
 *
’Œy
, *
Ãxt
;

1281 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
Ãxt
, 
b™m­_li¡
, 
li¡
)

1282 
	`li¡_d–_š™
(&
’Œy
->
li¡
);

1283 
	}
}

1285 
nošlše_fÜ_¡ack


1286 
	$ş—nup_wr™e_ÿche_’o¥c
(
šode
 *inode,

1287 
bŒfs_io_ùl
 *
io_ùl
,

1288 
ex‹Á_¡©e
 **
ÿched_¡©e
)

1290 
	`io_ùl_drİ_·ges
(
io_ùl
);

1291 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0, 
	`i_size_»ad
(inode) - 1,

1292 
ÿched_¡©e
);

1293 
	}
}

1295 
	$__bŒfs_wa™_ÿche_io
(
bŒfs_roÙ
 *
roÙ
,

1296 
bŒfs_Œªs_hªdË
 *
Œªs
,

1297 
bŒfs_block_group
 *
block_group
,

1298 
bŒfs_io_ùl
 *
io_ùl
,

1299 
bŒfs_·th
 *
·th
, 
u64
 
off£t
)

1301 
»t
;

1302 
šode
 *šodğ
io_ùl
->inode;

1304 ià(!
šode
)

1308 
»t
 = 
	`æush_dœty_ÿche
(
šode
);

1309 ià(
»t
)

1310 
out
;

1313 
»t
 = 
	`upd©e_ÿche_™em
(
Œªs
, 
roÙ
, 
šode
, 
·th
, 
off£t
,

1314 
io_ùl
->
’Œ›s
, io_ùl->
b™m­s
);

1315 
out
:

1316 ià(
»t
) {

1317 
	`šv®id©e_šode_·ges2
(
šode
->
i_m­pšg
);

1318 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 0;

1319 ià(
block_group
)

1320 
	`bŒfs_debug
(
roÙ
->
fs_šfo
,

1322 
block_group
->
¡¬t
, 
»t
);

1324 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

1326 ià(
block_group
) {

1328 
	`¥š_lock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

1331 
	`¥š_lock
(&
block_group
->
lock
);

1338 ià(!
»t
 && 
	`li¡_em±y
(&
block_group
->
dœty_li¡
))

1339 
block_group
->
disk_ÿche_¡©e
 = 
BTRFS_DC_WRITTEN
;

1340 ià(
»t
)

1341 
block_group
->
disk_ÿche_¡©e
 = 
BTRFS_DC_ERROR
;

1343 
	`¥š_uÆock
(&
block_group
->
lock
);

1344 
	`¥š_uÆock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

1345 
io_ùl
->
šode
 = 
NULL
;

1346 
	`ut
(
šode
);

1349  
»t
;

1351 
	}
}

1353 
	$bŒfs_wa™_ÿche_io
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1354 
bŒfs_block_group
 *
block_group
,

1355 
bŒfs_·th
 *
·th
)

1357  
	`__bŒfs_wa™_ÿche_io
(
block_group
->
fs_šfo
->
Œ“_roÙ
, 
Œªs
,

1358 
block_group
, &block_group->
io_ùl
,

1359 
·th
, 
block_group
->
¡¬t
);

1360 
	}
}

1376 
	$__bŒfs_wr™e_out_ÿche
(
bŒfs_roÙ
 *
roÙ
, 
šode
 *inode,

1377 
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1378 
bŒfs_block_group
 *
block_group
,

1379 
bŒfs_io_ùl
 *
io_ùl
,

1380 
bŒfs_Œªs_hªdË
 *
Œªs
)

1382 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

1383 
	`LIST_HEAD
(
b™m­_li¡
);

1384 
’Œ›s
 = 0;

1385 
b™m­s
 = 0;

1386 
»t
;

1387 
mu¡_ut
 = 0;

1389 ià(!
	`i_size_»ad
(
šode
))

1390  -
EIO
;

1392 
	`WARN_ON
(
io_ùl
->
·ges
);

1393 
»t
 = 
	`io_ùl_š™
(
io_ùl
, 
šode
, 1);

1394 ià(
»t
)

1395  
»t
;

1397 ià(
block_group
 && (block_group->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)) {

1398 
	`down_wr™e
(&
block_group
->
d©a_rw£m
);

1399 
	`¥š_lock
(&
block_group
->
lock
);

1400 ià(
block_group
->
d–®loc_by‹s
) {

1401 
block_group
->
disk_ÿche_¡©e
 = 
BTRFS_DC_WRITTEN
;

1402 
	`¥š_uÆock
(&
block_group
->
lock
);

1403 
	`up_wr™e
(&
block_group
->
d©a_rw£m
);

1404 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 0;

1405 
»t
 = 0;

1406 
mu¡_ut
 = 1;

1407 
out
;

1409 
	`¥š_uÆock
(&
block_group
->
lock
);

1413 
»t
 = 
	`io_ùl_´•¬e_·ges
(
io_ùl
, 
çl£
);

1414 ià(
»t
)

1415 
out_uÆock
;

1417 
	`lock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0, 
	`i_size_»ad
(inode) - 1,

1418 &
ÿched_¡©e
);

1420 
	`io_ùl_£t_g’”©iÚ
(
io_ùl
, 
Œªs
->
Œªsid
);

1422 
	`mu‹x_lock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

1424 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

1425 
»t
 = 
	`wr™e_ÿche_ex‹Á_’Œ›s
(
io_ùl
, 
ùl
,

1426 
block_group
, &
’Œ›s
, &
b™m­s
,

1427 &
b™m­_li¡
);

1428 ià(
»t
)

1429 
out_no¥c_locked
;

1439 
»t
 = 
	`wr™e_pšÃd_ex‹Á_’Œ›s
(
Œªs
, 
block_group
, 
io_ùl
, &
’Œ›s
);

1440 ià(
»t
)

1441 
out_no¥c_locked
;

1448 
»t
 = 
	`wr™e_b™m­_’Œ›s
(
io_ùl
, &
b™m­_li¡
);

1449 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

1450 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

1451 ià(
»t
)

1452 
out_no¥c
;

1455 
	`io_ùl_z”o_»maššg_·ges
(
io_ùl
);

1458 
»t
 = 
	`bŒfs_dœty_·ges
(
	`BTRFS_I
(
šode
), 
io_ùl
->
·ges
,

1459 
io_ùl
->
num_·ges
, 0, 
	`i_size_»ad
(
šode
),

1460 &
ÿched_¡©e
, 
çl£
);

1461 ià(
»t
)

1462 
out_no¥c
;

1464 ià(
block_group
 && (block_group->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
))

1465 
	`up_wr™e
(&
block_group
->
d©a_rw£m
);

1470 
	`io_ùl_drİ_·ges
(
io_ùl
);

1471 
	`io_ùl_ä“
(
io_ùl
);

1473 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0, 
	`i_size_»ad
(inode) - 1,

1474 &
ÿched_¡©e
);

1481 
io_ùl
->
’Œ›s
 =ƒntries;

1482 
io_ùl
->
b™m­s
 = bitmaps;

1484 
»t
 = 
	`bŒfs_fd©awr™e_¿nge
(
šode
, 0, (
u64
)-1);

1485 ià(
»t
)

1486 
out
;

1490 
out_no¥c_locked
:

1491 
	`ş—nup_b™m­_li¡
(&
b™m­_li¡
);

1492 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

1493 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

1495 
out_no¥c
:

1496 
	`ş—nup_wr™e_ÿche_’o¥c
(
šode
, 
io_ùl
, &
ÿched_¡©e
);

1498 
out_uÆock
:

1499 ià(
block_group
 && (block_group->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
))

1500 
	`up_wr™e
(&
block_group
->
d©a_rw£m
);

1502 
out
:

1503 
io_ùl
->
šode
 = 
NULL
;

1504 
	`io_ùl_ä“
(
io_ùl
);

1505 ià(
»t
) {

1506 
	`šv®id©e_šode_·ges2
(
šode
->
i_m­pšg
);

1507 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 0;

1509 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

1510 ià(
mu¡_ut
)

1511 
	`ut
(
šode
);

1512  
»t
;

1513 
	}
}

1515 
	$bŒfs_wr™e_out_ÿche
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1516 
bŒfs_block_group
 *
block_group
,

1517 
bŒfs_·th
 *
·th
)

1519 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1520 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

1521 
šode
 *inode;

1522 
»t
 = 0;

1524 
	`¥š_lock
(&
block_group
->
lock
);

1525 ià(
block_group
->
disk_ÿche_¡©e
 < 
BTRFS_DC_SETUP
) {

1526 
	`¥š_uÆock
(&
block_group
->
lock
);

1529 
	`¥š_uÆock
(&
block_group
->
lock
);

1531 
šode
 = 
	`lookup_ä“_¥aû_šode
(
block_group
, 
·th
);

1532 ià(
	`IS_ERR
(
šode
))

1535 
»t
 = 
	`__bŒfs_wr™e_out_ÿche
(
fs_šfo
->
Œ“_roÙ
, 
šode
, 
ùl
,

1536 
block_group
, &block_group->
io_ùl
, 
Œªs
);

1537 ià(
»t
) {

1538 
	`bŒfs_debug
(
fs_šfo
,

1540 
block_group
->
¡¬t
, 
»t
);

1541 
	`¥š_lock
(&
block_group
->
lock
);

1542 
block_group
->
disk_ÿche_¡©e
 = 
BTRFS_DC_ERROR
;

1543 
	`¥š_uÆock
(&
block_group
->
lock
);

1545 
block_group
->
io_ùl
.
šode
 = 
NULL
;

1546 
	`ut
(
šode
);

1554  
»t
;

1555 
	}
}

1557 
šlše
 
	$off£t_to_b™
(
u64
 
b™m­_¡¬t
, 
u32
 
un™
,

1558 
u64
 
off£t
)

1560 
	`ASSERT
(
off£t
 >ğ
b™m­_¡¬t
);

1561 
off£t
 -ğ
b™m­_¡¬t
;

1562  ()(
	`div_u64
(
off£t
, 
un™
));

1563 
	}
}

1565 
šlše
 
	$by‹s_to_b™s
(
u64
 
by‹s
, 
u32
 
un™
)

1567  ()(
	`div_u64
(
by‹s
, 
un™
));

1568 
	}
}

1570 
šlše
 
u64
 
	$off£t_to_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1571 
u64
 
off£t
)

1573 
u64
 
b™m­_¡¬t
;

1574 
u64
 
by‹s_³r_b™m­
;

1576 
by‹s_³r_b™m­
 = 
BITS_PER_BITMAP
 * 
ùl
->
un™
;

1577 
b™m­_¡¬t
 = 
off£t
 - 
ùl
->
¡¬t
;

1578 
b™m­_¡¬t
 = 
	`div64_u64
(b™m­_¡¬t, 
by‹s_³r_b™m­
);

1579 
b™m­_¡¬t
 *ğ
by‹s_³r_b™m­
;

1580 
b™m­_¡¬t
 +ğ
ùl
->
¡¬t
;

1582  
b™m­_¡¬t
;

1583 
	}
}

1585 
	$Œ“_š£¹_off£t
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1586 
bŒfs_ä“_şu¡”
 *
şu¡”
,

1587 
bŒfs_ä“_¥aû
 *
Ãw_’Œy
)

1589 
rb_roÙ
 *
roÙ
;

1590 
rb_node
 **
p
;

1591 
rb_node
 *
·»Á
 = 
NULL
;

1593 
	`lockd•_as£¹_h–d
(&
ùl
->
Œ“_lock
);

1595 ià(
şu¡”
) {

1596 
	`lockd•_as£¹_h–d
(&
şu¡”
->
lock
);

1597 
roÙ
 = &
şu¡”
->root;

1599 
roÙ
 = &
ùl
->
ä“_¥aû_off£t
;

1602 
p
 = &
roÙ
->
rb_node
;

1604 *
p
) {

1605 
bŒfs_ä“_¥aû
 *
šfo
;

1607 
·»Á
 = *
p
;

1608 
šfo
 = 
	`rb_’Œy
(
·»Á
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

1610 ià(
Ãw_’Œy
->
off£t
 < 
šfo
->offset) {

1611 
p
 = &(*p)->
rb_Ëá
;

1612 } ià(
Ãw_’Œy
->
off£t
 > 
šfo
->offset) {

1613 
p
 = &(*p)->
rb_right
;

1628 ià(
Ãw_’Œy
->
b™m­
) {

1629 ià(
šfo
->
b™m­
) {

1630 
	`WARN_ON_ONCE
(1);

1631  -
EEXIST
;

1633 
p
 = &(*p)->
rb_right
;

1635 ià(!
šfo
->
b™m­
) {

1636 
	`WARN_ON_ONCE
(1);

1637  -
EEXIST
;

1639 
p
 = &(*p)->
rb_Ëá
;

1644 
	`rb_lšk_node
(&
Ãw_’Œy
->
off£t_šdex
, 
·»Á
, 
p
);

1645 
	`rb_š£¹_cŞÜ
(&
Ãw_’Œy
->
off£t_šdex
, 
roÙ
);

1648 
	}
}

1674 
šlše
 
u64
 
	$g‘_max_ex‹Á_size
(cÚ¡ 
bŒfs_ä“_¥aû
 *
’Œy
)

1676 ià(
’Œy
->
b™m­
 &&ƒÁry->
max_ex‹Á_size
)

1677  
’Œy
->
max_ex‹Á_size
;

1678  
’Œy
->
by‹s
;

1679 
	}
}

1685 
boŞ
 
	$’Œy_Ëss
(
rb_node
 *
node
, cÚ¡ rb_nod*
·»Á
)

1687 cÚ¡ 
bŒfs_ä“_¥aû
 *
’Œy
, *
exi¡
;

1689 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
by‹s_šdex
);

1690 
exi¡
 = 
	`rb_’Œy
(
·»Á
, 
bŒfs_ä“_¥aû
, 
by‹s_šdex
);

1691  
	`g‘_max_ex‹Á_size
(
exi¡
è< g‘_max_ex‹Á_size(
’Œy
);

1692 
	}
}

1701 
bŒfs_ä“_¥aû
 *

1702 
	$Œ“_£¬ch_off£t
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1703 
u64
 
off£t
, 
b™m­_Úly
, 
fuzzy
)

1705 
rb_node
 *
n
 = 
ùl
->
ä“_¥aû_off£t
.rb_node;

1706 
bŒfs_ä“_¥aû
 *
’Œy
 = 
NULL
, *
´ev
 = NULL;

1708 
	`lockd•_as£¹_h–d
(&
ùl
->
Œ“_lock
);

1711 
n
) {

1712 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

1713 
´ev
 = 
’Œy
;

1715 ià(
off£t
 < 
’Œy
->offset)

1716 
n
 =‚->
rb_Ëá
;

1717 ià(
off£t
 > 
’Œy
->offset)

1718 
n
 =‚->
rb_right
;

1722 
’Œy
 = 
NULL
;

1725 ià(
b™m­_Úly
) {

1726 ià(!
’Œy
)

1727  
NULL
;

1728 ià(
’Œy
->
b™m­
)

1729  
’Œy
;

1735 
n
 = 
	`rb_Ãxt
(n);

1736 ià(!
n
)

1737  
NULL
;

1738 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

1739 ià(
’Œy
->
off£t
 != offset)

1740  
NULL
;

1742 
	`WARN_ON
(!
’Œy
->
b™m­
);

1743  
’Œy
;

1744 } ià(
’Œy
) {

1745 ià(
’Œy
->
b™m­
) {

1750 
n
 = 
	`rb_´ev
(&
’Œy
->
off£t_šdex
);

1751 ià(
n
) {

1752 
´ev
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
,

1753 
off£t_šdex
);

1754 ià(!
´ev
->
b™m­
 &&

1755 
´ev
->
off£t
 +…»v->
by‹s
 > offset)

1756 
’Œy
 = 
´ev
;

1759  
’Œy
;

1762 ià(!
´ev
)

1763  
NULL
;

1766 
’Œy
 = 
´ev
;

1767 ià(
’Œy
->
off£t
 > offset) {

1768 
n
 = 
	`rb_´ev
(&
’Œy
->
off£t_šdex
);

1769 ià(
n
) {

1770 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
,

1771 
off£t_šdex
);

1772 
	`ASSERT
(
’Œy
->
off£t
 <= offset);

1774 ià(
fuzzy
)

1775  
’Œy
;

1777  
NULL
;

1781 ià(
’Œy
->
b™m­
) {

1782 
n
 = 
	`rb_´ev
(&
’Œy
->
off£t_šdex
);

1783 ià(
n
) {

1784 
´ev
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
,

1785 
off£t_šdex
);

1786 ià(!
´ev
->
b™m­
 &&

1787 
´ev
->
off£t
 +…»v->
by‹s
 > offset)

1788  
´ev
;

1790 ià(
’Œy
->
off£t
 + 
BITS_PER_BITMAP
 * 
ùl
->
un™
 > offset)

1791  
’Œy
;

1792 } ià(
’Œy
->
off£t
 +ƒÁry->
by‹s
 > offset)

1793  
’Œy
;

1795 ià(!
fuzzy
)

1796  
NULL
;

1799 
n
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
);

1800 ià(!
n
)

1801  
NULL
;

1802 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

1803 ià(
’Œy
->
b™m­
) {

1804 ià(
’Œy
->
off£t
 + 
BITS_PER_BITMAP
 *

1805 
ùl
->
un™
 > 
off£t
)

1808 ià(
’Œy
->
off£t
 +ƒÁry->
by‹s
 > offset)

1812  
’Œy
;

1813 
	}
}

1815 
šlše
 
	$uÆšk_ä“_¥aû
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1816 
bŒfs_ä“_¥aû
 *
šfo
,

1817 
boŞ
 
upd©e_¡©
)

1819 
	`lockd•_as£¹_h–d
(&
ùl
->
Œ“_lock
);

1821 
	`rb_”a£
(&
šfo
->
off£t_šdex
, &
ùl
->
ä“_¥aû_off£t
);

1822 
	`rb_”a£_ÿched
(&
šfo
->
by‹s_šdex
, &
ùl
->
ä“_¥aû_by‹s
);

1823 
ùl
->
ä“_ex‹Ás
--;

1825 ià(!
šfo
->
b™m­
 && !
	`bŒfs_ä“_¥aû_Œimmed
(info)) {

1826 
ùl
->
disÿrdabË_ex‹Ás
[
BTRFS_STAT_CURR
]--;

1827 
ùl
->
disÿrdabË_by‹s
[
BTRFS_STAT_CURR
] -ğ
šfo
->
by‹s
;

1830 ià(
upd©e_¡©
)

1831 
ùl
->
ä“_¥aû
 -ğ
šfo
->
by‹s
;

1832 
	}
}

1834 
	$lšk_ä“_¥aû
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1835 
bŒfs_ä“_¥aû
 *
šfo
)

1837 
»t
 = 0;

1839 
	`lockd•_as£¹_h–d
(&
ùl
->
Œ“_lock
);

1841 
	`ASSERT
(
šfo
->
by‹s
 || info->
b™m­
);

1842 
»t
 = 
	`Œ“_š£¹_off£t
(
ùl
, 
NULL
, 
šfo
);

1843 ià(
»t
)

1844  
»t
;

1846 
	`rb_add_ÿched
(&
šfo
->
by‹s_šdex
, &
ùl
->
ä“_¥aû_by‹s
, 
’Œy_Ëss
);

1848 ià(!
šfo
->
b™m­
 && !
	`bŒfs_ä“_¥aû_Œimmed
(info)) {

1849 
ùl
->
disÿrdabË_ex‹Ás
[
BTRFS_STAT_CURR
]++;

1850 
ùl
->
disÿrdabË_by‹s
[
BTRFS_STAT_CURR
] +ğ
šfo
->
by‹s
;

1853 
ùl
->
ä“_¥aû
 +ğ
šfo
->
by‹s
;

1854 
ùl
->
ä“_ex‹Ás
++;

1855  
»t
;

1856 
	}
}

1858 
	$»lšk_b™m­_’Œy
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1859 
bŒfs_ä“_¥aû
 *
šfo
)

1861 
	`ASSERT
(
šfo
->
b™m­
);

1867 ià(
	`RB_EMPTY_NODE
(&
šfo
->
by‹s_šdex
))

1870 
	`lockd•_as£¹_h–d
(&
ùl
->
Œ“_lock
);

1872 
	`rb_”a£_ÿched
(&
šfo
->
by‹s_šdex
, &
ùl
->
ä“_¥aû_by‹s
);

1873 
	`rb_add_ÿched
(&
šfo
->
by‹s_šdex
, &
ùl
->
ä“_¥aû_by‹s
, 
’Œy_Ëss
);

1874 
	}
}

1876 
šlše
 
	$b™m­_ş—r_b™s
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1877 
bŒfs_ä“_¥aû
 *
šfo
,

1878 
u64
 
off£t
, u64 
by‹s
, 
boŞ
 
upd©e_¡©
)

1880 
¡¬t
, 
couÁ
, 
’d
;

1881 
ex‹Á_d–
 = -1;

1883 
¡¬t
 = 
	`off£t_to_b™
(
šfo
->
off£t
, 
ùl
->
un™
, offset);

1884 
couÁ
 = 
	`by‹s_to_b™s
(
by‹s
, 
ùl
->
un™
);

1885 
’d
 = 
¡¬t
 + 
couÁ
;

1886 
	`ASSERT
(
’d
 <ğ
BITS_PER_BITMAP
);

1888 
	`b™m­_ş—r
(
šfo
->
b™m­
, 
¡¬t
, 
couÁ
);

1890 
šfo
->
by‹s
 -= bytes;

1891 ià(
šfo
->
max_ex‹Á_size
 > 
ùl
->
un™
)

1892 
šfo
->
max_ex‹Á_size
 = 0;

1894 
	`»lšk_b™m­_’Œy
(
ùl
, 
šfo
);

1896 ià(
¡¬t
 && 
	`‹¡_b™
(¡¬ˆ- 1, 
šfo
->
b™m­
))

1897 
ex‹Á_d–
++;

1899 ià(
’d
 < 
BITS_PER_BITMAP
 && 
	`‹¡_b™
Ónd, 
šfo
->
b™m­
))

1900 
ex‹Á_d–
++;

1902 
šfo
->
b™m­_ex‹Ás
 +ğ
ex‹Á_d–
;

1903 ià(!
	`bŒfs_ä“_¥aû_Œimmed
(
šfo
)) {

1904 
ùl
->
disÿrdabË_ex‹Ás
[
BTRFS_STAT_CURR
] +ğ
ex‹Á_d–
;

1905 
ùl
->
disÿrdabË_by‹s
[
BTRFS_STAT_CURR
] -ğ
by‹s
;

1908 ià(
upd©e_¡©
)

1909 
ùl
->
ä“_¥aû
 -ğ
by‹s
;

1910 
	}
}

1912 
	$b™m­_£t_b™s
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1913 
bŒfs_ä“_¥aû
 *
šfo
, 
u64
 
off£t
,

1914 
u64
 
by‹s
)

1916 
¡¬t
, 
couÁ
, 
’d
;

1917 
ex‹Á_d–
 = 1;

1919 
¡¬t
 = 
	`off£t_to_b™
(
šfo
->
off£t
, 
ùl
->
un™
, offset);

1920 
couÁ
 = 
	`by‹s_to_b™s
(
by‹s
, 
ùl
->
un™
);

1921 
’d
 = 
¡¬t
 + 
couÁ
;

1922 
	`ASSERT
(
’d
 <ğ
BITS_PER_BITMAP
);

1924 
	`b™m­_£t
(
šfo
->
b™m­
, 
¡¬t
, 
couÁ
);

1930 
šfo
->
max_ex‹Á_size
 = 0;

1931 
šfo
->
by‹s
 += bytes;

1932 
ùl
->
ä“_¥aû
 +ğ
by‹s
;

1934 
	`»lšk_b™m­_’Œy
(
ùl
, 
šfo
);

1936 ià(
¡¬t
 && 
	`‹¡_b™
(¡¬ˆ- 1, 
šfo
->
b™m­
))

1937 
ex‹Á_d–
--;

1939 ià(
’d
 < 
BITS_PER_BITMAP
 && 
	`‹¡_b™
Ónd, 
šfo
->
b™m­
))

1940 
ex‹Á_d–
--;

1942 
šfo
->
b™m­_ex‹Ás
 +ğ
ex‹Á_d–
;

1943 ià(!
	`bŒfs_ä“_¥aû_Œimmed
(
šfo
)) {

1944 
ùl
->
disÿrdabË_ex‹Ás
[
BTRFS_STAT_CURR
] +ğ
ex‹Á_d–
;

1945 
ùl
->
disÿrdabË_by‹s
[
BTRFS_STAT_CURR
] +ğ
by‹s
;

1947 
	}
}

1953 
	$£¬ch_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1954 
bŒfs_ä“_¥aû
 *
b™m­_šfo
, 
u64
 *
off£t
,

1955 
u64
 *
by‹s
, 
boŞ
 
fÜ_®loc
)

1957 
found_b™s
 = 0;

1958 
max_b™s
 = 0;

1959 
b™s
, 
i
;

1960 
Ãxt_z”o
;

1961 
ex‹Á_b™s
;

1967 ià(
fÜ_®loc
 &&

1968 
b™m­_šfo
->
max_ex‹Á_size
 &&

1969 
b™m­_šfo
->
max_ex‹Á_size
 < *
by‹s
) {

1970 *
by‹s
 = 
b™m­_šfo
->
max_ex‹Á_size
;

1974 
i
 = 
	`off£t_to_b™
(
b™m­_šfo
->
off£t
, 
ùl
->
un™
,

1975 
	`max_t
(
u64
, *
off£t
, 
b™m­_šfo
->offset));

1976 
b™s
 = 
	`by‹s_to_b™s
(*
by‹s
, 
ùl
->
un™
);

1978 
	`fÜ_—ch_£t_b™_äom
(
i
, 
b™m­_šfo
->
b™m­
, 
BITS_PER_BITMAP
) {

1979 ià(
fÜ_®loc
 && 
b™s
 == 1) {

1980 
found_b™s
 = 1;

1983 
Ãxt_z”o
 = 
	`fšd_Ãxt_z”o_b™
(
b™m­_šfo
->
b™m­
,

1984 
BITS_PER_BITMAP
, 
i
);

1985 
ex‹Á_b™s
 = 
Ãxt_z”o
 - 
i
;

1986 ià(
ex‹Á_b™s
 >ğ
b™s
) {

1987 
found_b™s
 = 
ex‹Á_b™s
;

1989 } ià(
ex‹Á_b™s
 > 
max_b™s
) {

1990 
max_b™s
 = 
ex‹Á_b™s
;

1992 
i
 = 
Ãxt_z”o
;

1995 ià(
found_b™s
) {

1996 *
off£t
 = (
u64
)(
i
 * 
ùl
->
un™
è+ 
b™m­_šfo
->offset;

1997 *
by‹s
 = (
u64
)(
found_b™s
è* 
ùl
->
un™
;

2001 *
by‹s
 = (
u64
)(
max_b™s
è* 
ùl
->
un™
;

2002 
b™m­_šfo
->
max_ex‹Á_size
 = *
by‹s
;

2003 
	`»lšk_b™m­_’Œy
(
ùl
, 
b™m­_šfo
);

2005 
	}
}

2008 
bŒfs_ä“_¥aû
 *

2009 
	$fšd_ä“_¥aû
(
bŒfs_ä“_¥aû_ùl
 *
ùl
, 
u64
 *
off£t
, u64 *
by‹s
,

2010 
®ign
, 
u64
 *
max_ex‹Á_size
, 
boŞ
 
u£_by‹s_šdex
)

2012 
bŒfs_ä“_¥aû
 *
’Œy
;

2013 
rb_node
 *
node
;

2014 
u64
 
tmp
;

2015 
u64
 
®ign_off
;

2016 
»t
;

2018 ià(!
ùl
->
ä“_¥aû_off£t
.
rb_node
)

2019 
out
;

2020 
agaš
:

2021 ià(
u£_by‹s_šdex
) {

2022 
node
 = 
	`rb_fœ¡_ÿched
(&
ùl
->
ä“_¥aû_by‹s
);

2024 
’Œy
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
	`off£t_to_b™m­
(ùl, *
off£t
),

2026 ià(!
’Œy
)

2027 
out
;

2028 
node
 = &
’Œy
->
off£t_šdex
;

2031 ; 
node
;‚odğ
	`rb_Ãxt
(node)) {

2032 ià(
u£_by‹s_šdex
)

2033 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
,

2034 
by‹s_šdex
);

2036 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
,

2037 
off£t_šdex
);

2047 ià(
’Œy
->
by‹s
 < *bytes) {

2048 *
max_ex‹Á_size
 = 
	`max
(
	`g‘_max_ex‹Á_size
(
’Œy
),

2049 *
max_ex‹Á_size
);

2050 ià(
u£_by‹s_šdex
)

2058 ià(*
by‹s
 >ğ
®ign
) {

2059 
tmp
 = 
’Œy
->
off£t
 - 
ùl
->
¡¬t
 + 
®ign
 - 1;

2060 
tmp
 = 
	`div64_u64
Ñmp, 
®ign
);

2061 
tmp
 =m°* 
®ign
 + 
ùl
->
¡¬t
;

2062 
®ign_off
 = 
tmp
 - 
’Œy
->
off£t
;

2064 
®ign_off
 = 0;

2065 
tmp
 = 
’Œy
->
off£t
;

2075 ià(
’Œy
->
by‹s
 < *by‹ + 
®ign_off
) {

2076 *
max_ex‹Á_size
 = 
	`max
(
	`g‘_max_ex‹Á_size
(
’Œy
),

2077 *
max_ex‹Á_size
);

2081 ià(
’Œy
->
b™m­
) {

2082 
rb_node
 *
Şd_Ãxt
 = 
	`rb_Ãxt
(
node
);

2083 
u64
 
size
 = *
by‹s
;

2085 
»t
 = 
	`£¬ch_b™m­
(
ùl
, 
’Œy
, &
tmp
, &
size
, 
Œue
);

2086 ià(!
»t
) {

2087 *
off£t
 = 
tmp
;

2088 *
by‹s
 = 
size
;

2089  
’Œy
;

2091 *
max_ex‹Á_size
 =

2092 
	`max
(
	`g‘_max_ex‹Á_size
(
’Œy
),

2093 *
max_ex‹Á_size
);

2102 ià(
u£_by‹s_šdex
 && 
Şd_Ãxt
 !ğ
	`rb_Ãxt
(
node
))

2103 
agaš
;

2107 *
off£t
 = 
tmp
;

2108 *
by‹s
 = 
’Œy
->by‹ - 
®ign_off
;

2109  
’Œy
;

2111 
out
:

2112  
NULL
;

2113 
	}
}

2115 
	$add_Ãw_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

2116 
bŒfs_ä“_¥aû
 *
šfo
, 
u64
 
off£t
)

2118 
šfo
->
off£t
 = 
	`off£t_to_b™m­
(
ùl
, offset);

2119 
šfo
->
by‹s
 = 0;

2120 
šfo
->
b™m­_ex‹Ás
 = 0;

2121 
	`INIT_LIST_HEAD
(&
šfo
->
li¡
);

2122 
	`lšk_ä“_¥aû
(
ùl
, 
šfo
);

2123 
ùl
->
tÙ®_b™m­s
++;

2124 
	`»ÿlcuÏ‹_th»shŞds
(
ùl
);

2125 
	}
}

2127 
	$ä“_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

2128 
bŒfs_ä“_¥aû
 *
b™m­_šfo
)

2136 ià(
b™m­_šfo
->
by‹s
 && !
	`bŒfs_ä“_¥aû_Œimmed
(bitmap_info)) {

2137 
ùl
->
disÿrdabË_ex‹Ás
[
BTRFS_STAT_CURR
] -=

2138 
b™m­_šfo
->
b™m­_ex‹Ás
;

2139 
ùl
->
disÿrdabË_by‹s
[
BTRFS_STAT_CURR
] -ğ
b™m­_šfo
->
by‹s
;

2142 
	`uÆšk_ä“_¥aû
(
ùl
, 
b™m­_šfo
, 
Œue
);

2143 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_b™m­_ÿch•
, 
b™m­_šfo
->
b™m­
);

2144 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
b™m­_šfo
);

2145 
ùl
->
tÙ®_b™m­s
--;

2146 
	`»ÿlcuÏ‹_th»shŞds
(
ùl
);

2147 
	}
}

2149 
nošlše
 
	$»move_äom_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

2150 
bŒfs_ä“_¥aû
 *
b™m­_šfo
,

2151 
u64
 *
off£t
, u64 *
by‹s
)

2153 
u64
 
’d
;

2154 
u64
 
£¬ch_¡¬t
, 
£¬ch_by‹s
;

2155 
»t
;

2157 
agaš
:

2158 
’d
 = 
b™m­_šfo
->
off£t
 + (
u64
)(
BITS_PER_BITMAP
 * 
ùl
->
un™
) - 1;

2166 
£¬ch_¡¬t
 = *
off£t
;

2167 
£¬ch_by‹s
 = 
ùl
->
un™
;

2168 
£¬ch_by‹s
 = 
	`mš
(£¬ch_by‹s, 
’d
 - 
£¬ch_¡¬t
 + 1);

2169 
»t
 = 
	`£¬ch_b™m­
(
ùl
, 
b™m­_šfo
, &
£¬ch_¡¬t
, &
£¬ch_by‹s
,

2170 
çl£
);

2171 ià(
»t
 < 0 || 
£¬ch_¡¬t
 !ğ*
off£t
)

2172  -
EINVAL
;

2175 
£¬ch_by‹s
 = 
	`mš
(£¬ch_by‹s, *
by‹s
);

2178 
£¬ch_by‹s
 = 
	`mš
(£¬ch_by‹s, 
’d
 - 
£¬ch_¡¬t
 + 1);

2180 
	`b™m­_ş—r_b™s
(
ùl
, 
b™m­_šfo
, 
£¬ch_¡¬t
, 
£¬ch_by‹s
, 
Œue
);

2181 *
off£t
 +ğ
£¬ch_by‹s
;

2182 *
by‹s
 -ğ
£¬ch_by‹s
;

2184 ià(*
by‹s
) {

2185 
rb_node
 *
Ãxt
 = 
	`rb_Ãxt
(&
b™m­_šfo
->
off£t_šdex
);

2186 ià(!
b™m­_šfo
->
by‹s
)

2187 
	`ä“_b™m­
(
ùl
, 
b™m­_šfo
);

2193 ià(!
Ãxt
)

2194  -
EINVAL
;

2196 
b™m­_šfo
 = 
	`rb_’Œy
(
Ãxt
, 
bŒfs_ä“_¥aû
,

2197 
off£t_šdex
);

2203 ià(!
b™m­_šfo
->
b™m­
)

2204  -
EAGAIN
;

2212 
£¬ch_¡¬t
 = *
off£t
;

2213 
£¬ch_by‹s
 = 
ùl
->
un™
;

2214 
»t
 = 
	`£¬ch_b™m­
(
ùl
, 
b™m­_šfo
, &
£¬ch_¡¬t
,

2215 &
£¬ch_by‹s
, 
çl£
);

2216 ià(
»t
 < 0 || 
£¬ch_¡¬t
 !ğ*
off£t
)

2217  -
EAGAIN
;

2219 
agaš
;

2220 } ià(!
b™m­_šfo
->
by‹s
)

2221 
	`ä“_b™m­
(
ùl
, 
b™m­_šfo
);

2224 
	}
}

2226 
u64
 
	$add_by‹s_to_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

2227 
bŒfs_ä“_¥aû
 *
šfo
, 
u64
 
off£t
,

2228 
u64
 
by‹s
, 
bŒfs_Œim_¡©e
 
Œim_¡©e
)

2230 
u64
 
by‹s_to_£t
 = 0;

2231 
u64
 
’d
;

2237 ià(
Œim_¡©e
 =ğ
BTRFS_TRIM_STATE_UNTRIMMED
) {

2238 ià(
	`bŒfs_ä“_¥aû_Œimmed
(
šfo
)) {

2239 
ùl
->
disÿrdabË_ex‹Ás
[
BTRFS_STAT_CURR
] +=

2240 
šfo
->
b™m­_ex‹Ás
;

2241 
ùl
->
disÿrdabË_by‹s
[
BTRFS_STAT_CURR
] +ğ
šfo
->
by‹s
;

2243 
šfo
->
Œim_¡©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

2246 
’d
 = 
šfo
->
off£t
 + (
u64
)(
BITS_PER_BITMAP
 * 
ùl
->
un™
);

2248 
by‹s_to_£t
 = 
	`mš
(
’d
 - 
off£t
, 
by‹s
);

2250 
	`b™m­_£t_b™s
(
ùl
, 
šfo
, 
off£t
, 
by‹s_to_£t
);

2252  
by‹s_to_£t
;

2254 
	}
}

2256 
boŞ
 
	$u£_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

2257 
bŒfs_ä“_¥aû
 *
šfo
)

2259 
bŒfs_block_group
 *
block_group
 = 
ùl
->block_group;

2260 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

2261 
boŞ
 
fÜûd
 = 
çl£
;

2263 #ifdeà
CONFIG_BTRFS_DEBUG


2264 ià(
	`bŒfs_should_äagm’t_ä“_¥aû
(
block_group
))

2265 
fÜûd
 = 
Œue
;

2269 ià(!
fÜûd
 && 
šfo
->
by‹s
 >ğ
FORCE_EXTENT_THRESHOLD
)

2270  
çl£
;

2276 ià(!
fÜûd
 && 
ùl
->
ä“_ex‹Ás
 < c->
ex‹Ás_th»sh
) {

2284 ià(
šfo
->
by‹s
 <ğ
fs_šfo
->
£ùÜsize
 * 8) {

2285 ià(
ùl
->
ä“_ex‹Ás
 * 3 <ğùl->
ex‹Ás_th»sh
)

2286  
çl£
;

2288  
çl£
;

2300 ià(((
BITS_PER_BITMAP
 * 
ùl
->
un™
è>> 1è> 
block_group
->
Ëngth
)

2301  
çl£
;

2303  
Œue
;

2304 
	}
}

2306 cÚ¡ 
bŒfs_ä“_¥aû_İ
 
	gä“_¥aû_İ
 = {

2307 .
u£_b™m­
 = use_bitmap,

2310 
	$š£¹_što_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

2311 
bŒfs_ä“_¥aû
 *
šfo
)

2313 
bŒfs_ä“_¥aû
 *
b™m­_šfo
;

2314 
bŒfs_block_group
 *
block_group
 = 
NULL
;

2315 
added
 = 0;

2316 
u64
 
by‹s
, 
off£t
, 
by‹s_added
;

2317 
bŒfs_Œim_¡©e
 
Œim_¡©e
;

2318 
»t
;

2320 
by‹s
 = 
šfo
->bytes;

2321 
off£t
 = 
šfo
->offset;

2322 
Œim_¡©e
 = 
šfo
->trim_state;

2324 ià(!
ùl
->
İ
->
	`u£_b™m­
(ùl, 
šfo
))

2327 ià(
ùl
->
İ
 =ğ&
ä“_¥aû_İ
)

2328 
block_group
 = 
ùl
->block_group;

2329 
agaš
:

2335 ià(
block_group
 && !
	`li¡_em±y
(&block_group->
şu¡”_li¡
)) {

2336 
bŒfs_ä“_şu¡”
 *
şu¡”
;

2337 
rb_node
 *
node
;

2338 
bŒfs_ä“_¥aû
 *
’Œy
;

2340 
şu¡”
 = 
	`li¡_’Œy
(
block_group
->
şu¡”_li¡
.
Ãxt
,

2341 
bŒfs_ä“_şu¡”
,

2342 
block_group_li¡
);

2343 
	`¥š_lock
(&
şu¡”
->
lock
);

2344 
node
 = 
	`rb_fœ¡
(&
şu¡”
->
roÙ
);

2345 ià(!
node
) {

2346 
	`¥š_uÆock
(&
şu¡”
->
lock
);

2347 
no_şu¡”_b™m­
;

2350 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

2351 ià(!
’Œy
->
b™m­
) {

2352 
	`¥š_uÆock
(&
şu¡”
->
lock
);

2353 
no_şu¡”_b™m­
;

2356 ià(
’Œy
->
off£t
 =ğ
	`off£t_to_b™m­
(
ùl
, offset)) {

2357 
by‹s_added
 = 
	`add_by‹s_to_b™m­
(
ùl
, 
’Œy
, 
off£t
,

2358 
by‹s
, 
Œim_¡©e
);

2359 
by‹s
 -ğ
by‹s_added
;

2360 
off£t
 +ğ
by‹s_added
;

2362 
	`¥š_uÆock
(&
şu¡”
->
lock
);

2363 ià(!
by‹s
) {

2364 
»t
 = 1;

2365 
out
;

2369 
no_şu¡”_b™m­
:

2370 
b™m­_šfo
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
	`off£t_to_b™m­
(ùl, 
off£t
),

2372 ià(!
b™m­_šfo
) {

2373 
	`ASSERT
(
added
 == 0);

2374 
Ãw_b™m­
;

2377 
by‹s_added
 = 
	`add_by‹s_to_b™m­
(
ùl
, 
b™m­_šfo
, 
off£t
, 
by‹s
,

2378 
Œim_¡©e
);

2379 
by‹s
 -ğ
by‹s_added
;

2380 
off£t
 +ğ
by‹s_added
;

2381 
added
 = 0;

2383 ià(!
by‹s
) {

2384 
»t
 = 1;

2385 
out
;

2387 
agaš
;

2389 
Ãw_b™m­
:

2390 ià(
šfo
 && info->
b™m­
) {

2391 
	`add_Ãw_b™m­
(
ùl
, 
šfo
, 
off£t
);

2392 
added
 = 1;

2393 
šfo
 = 
NULL
;

2394 
agaš
;

2396 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

2399 ià(!
šfo
) {

2400 
šfo
 = 
	`kmem_ÿche_z®loc
(
bŒfs_ä“_¥aû_ÿch•
,

2401 
GFP_NOFS
);

2402 ià(!
šfo
) {

2403 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

2404 
»t
 = -
ENOMEM
;

2405 
out
;

2410 
šfo
->
b™m­
 = 
	`kmem_ÿche_z®loc
(
bŒfs_ä“_¥aû_b™m­_ÿch•
,

2411 
GFP_NOFS
);

2412 
šfo
->
Œim_¡©e
 = 
BTRFS_TRIM_STATE_TRIMMED
;

2413 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

2414 ià(!
šfo
->
b™m­
) {

2415 
»t
 = -
ENOMEM
;

2416 
out
;

2418 
agaš
;

2421 
out
:

2422 ià(
šfo
) {

2423 ià(
šfo
->
b™m­
)

2424 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_b™m­_ÿch•
,

2425 
šfo
->
b™m­
);

2426 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
šfo
);

2429  
»t
;

2430 
	}
}

2448 
boŞ
 
	$Œy_m”ge_ä“_¥aû
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

2449 
bŒfs_ä“_¥aû
 *
šfo
, 
boŞ
 
upd©e_¡©
)

2451 
bŒfs_ä“_¥aû
 *
Ëá_šfo
 = 
NULL
;

2452 
bŒfs_ä“_¥aû
 *
right_šfo
;

2453 
boŞ
 
m”ged
 = 
çl£
;

2454 
u64
 
off£t
 = 
šfo
->offset;

2455 
u64
 
by‹s
 = 
šfo
->bytes;

2456 cÚ¡ 
boŞ
 
is_Œimmed
 = 
	`bŒfs_ä“_¥aû_Œimmed
(
šfo
);

2457 
rb_node
 *
right_´ev
 = 
NULL
;

2464 
right_šfo
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
off£t
 + 
by‹s
, 0, 0);

2465 ià(
right_šfo
)

2466 
right_´ev
 = 
	`rb_´ev
(&
right_šfo
->
off£t_šdex
);

2468 ià(
right_´ev
)

2469 
Ëá_šfo
 = 
	`rb_’Œy
(
right_´ev
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

2470 ià(!
right_šfo
)

2471 
Ëá_šfo
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
off£t
 - 1, 0, 0);

2474 ià(
right_šfo
 && !right_šfo->
b™m­
 &&

2475 (!
is_Œimmed
 || 
	`bŒfs_ä“_¥aû_Œimmed
(
right_šfo
))) {

2476 
	`uÆšk_ä“_¥aû
(
ùl
, 
right_šfo
, 
upd©e_¡©
);

2477 
šfo
->
by‹s
 +ğ
right_šfo
->bytes;

2478 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
right_šfo
);

2479 
m”ged
 = 
Œue
;

2483 ià(
Ëá_šfo
 && !Ëá_šfo->
b™m­
 &&

2484 
Ëá_šfo
->
off£t
 +†eá_šfo->
by‹s
 == offset &&

2485 (!
is_Œimmed
 || 
	`bŒfs_ä“_¥aû_Œimmed
(
Ëá_šfo
))) {

2486 
	`uÆšk_ä“_¥aû
(
ùl
, 
Ëá_šfo
, 
upd©e_¡©
);

2487 
šfo
->
off£t
 = 
Ëá_šfo
->offset;

2488 
šfo
->
by‹s
 +ğ
Ëá_šfo
->bytes;

2489 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
Ëá_šfo
);

2490 
m”ged
 = 
Œue
;

2493  
m”ged
;

2494 
	}
}

2496 
boŞ
 
	$¡—l_äom_b™m­_to_’d
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

2497 
bŒfs_ä“_¥aû
 *
šfo
,

2498 
boŞ
 
upd©e_¡©
)

2500 
bŒfs_ä“_¥aû
 *
b™m­
;

2501 
i
;

2502 
j
;

2503 cÚ¡ 
u64
 
’d
 = 
šfo
->
off£t
 + info->
by‹s
;

2504 cÚ¡ 
u64
 
b™m­_off£t
 = 
	`off£t_to_b™m­
(
ùl
, 
’d
);

2505 
u64
 
by‹s
;

2507 
b™m­
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
b™m­_off£t
, 1, 0);

2508 ià(!
b™m­
)

2509  
çl£
;

2511 
i
 = 
	`off£t_to_b™
(
b™m­
->
off£t
, 
ùl
->
un™
, 
’d
);

2512 
j
 = 
	`fšd_Ãxt_z”o_b™
(
b™m­
->b™m­, 
BITS_PER_BITMAP
, 
i
);

2513 ià(
j
 =ğ
i
)

2514  
çl£
;

2515 
by‹s
 = (
j
 - 
i
è* 
ùl
->
un™
;

2516 
šfo
->
by‹s
 += bytes;

2519 ià(!
	`bŒfs_ä“_¥aû_Œimmed
(
b™m­
))

2520 
šfo
->
Œim_¡©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

2522 
	`b™m­_ş—r_b™s
(
ùl
, 
b™m­
, 
’d
, 
by‹s
, 
upd©e_¡©
);

2524 ià(!
b™m­
->
by‹s
)

2525 
	`ä“_b™m­
(
ùl
, 
b™m­
);

2527  
Œue
;

2528 
	}
}

2530 
boŞ
 
	$¡—l_äom_b™m­_to_äÚt
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

2531 
bŒfs_ä“_¥aû
 *
šfo
,

2532 
boŞ
 
upd©e_¡©
)

2534 
bŒfs_ä“_¥aû
 *
b™m­
;

2535 
u64
 
b™m­_off£t
;

2536 
i
;

2537 
j
;

2538 
´ev_j
;

2539 
u64
 
by‹s
;

2541 
b™m­_off£t
 = 
	`off£t_to_b™m­
(
ùl
, 
šfo
->
off£t
);

2543 ià(
b™m­_off£t
 =ğ
šfo
->
off£t
) {

2544 ià(
šfo
->
off£t
 == 0)

2545  
çl£
;

2546 
b™m­_off£t
 = 
	`off£t_to_b™m­
(
ùl
, 
šfo
->
off£t
 - 1);

2549 
b™m­
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
b™m­_off£t
, 1, 0);

2550 ià(!
b™m­
)

2551  
çl£
;

2553 
i
 = 
	`off£t_to_b™
(
b™m­
->
off£t
, 
ùl
->
un™
, 
šfo
->offset) - 1;

2554 
j
 = 0;

2555 
´ev_j
 = ()-1;

2556 
	`fÜ_—ch_ş—r_b™_äom
(
j
, 
b™m­
->b™m­, 
BITS_PER_BITMAP
) {

2557 ià(
j
 > 
i
)

2559 
´ev_j
 = 
j
;

2561 ià(
´ev_j
 =ğ
i
)

2562  
çl£
;

2564 ià(
´ev_j
 == ()-1)

2565 
by‹s
 = (
i
 + 1è* 
ùl
->
un™
;

2567 
by‹s
 = (
i
 - 
´ev_j
è* 
ùl
->
un™
;

2569 
šfo
->
off£t
 -ğ
by‹s
;

2570 
šfo
->
by‹s
 += bytes;

2573 ià(!
	`bŒfs_ä“_¥aû_Œimmed
(
b™m­
))

2574 
šfo
->
Œim_¡©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

2576 
	`b™m­_ş—r_b™s
(
ùl
, 
b™m­
, 
šfo
->
off£t
, 
by‹s
, 
upd©e_¡©
);

2578 ià(!
b™m­
->
by‹s
)

2579 
	`ä“_b™m­
(
ùl
, 
b™m­
);

2581  
Œue
;

2582 
	}
}

2595 
	$¡—l_äom_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

2596 
bŒfs_ä“_¥aû
 *
šfo
,

2597 
boŞ
 
upd©e_¡©
)

2603 
	`ASSERT
(!
šfo
->
b™m­
);

2604 
	`ASSERT
(
	`RB_EMPTY_NODE
(&
šfo
->
off£t_šdex
));

2606 ià(
ùl
->
tÙ®_b™m­s
 > 0) {

2607 
boŞ
 
¡Şe_’d
;

2608 
boŞ
 
¡Şe_äÚt
 = 
çl£
;

2610 
¡Şe_’d
 = 
	`¡—l_äom_b™m­_to_’d
(
ùl
, 
šfo
, 
upd©e_¡©
);

2611 ià(
ùl
->
tÙ®_b™m­s
 > 0)

2612 
¡Şe_äÚt
 = 
	`¡—l_äom_b™m­_to_äÚt
(
ùl
, 
šfo
,

2613 
upd©e_¡©
);

2615 ià(
¡Şe_’d
 || 
¡Şe_äÚt
)

2616 
	`Œy_m”ge_ä“_¥aû
(
ùl
, 
šfo
, 
upd©e_¡©
);

2618 
	}
}

2620 
	$__bŒfs_add_ä“_¥aû
(
bŒfs_block_group
 *
block_group
,

2621 
u64
 
off£t
, u64 
by‹s
,

2622 
bŒfs_Œim_¡©e
 
Œim_¡©e
)

2624 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

2625 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2626 
bŒfs_ä“_¥aû
 *
šfo
;

2627 
»t
 = 0;

2628 
u64
 
f‹r_by‹s
 = 
by‹s
;

2630 
	`ASSERT
(!
	`bŒfs_is_zÚed
(
fs_šfo
));

2632 
šfo
 = 
	`kmem_ÿche_z®loc
(
bŒfs_ä“_¥aû_ÿch•
, 
GFP_NOFS
);

2633 ià(!
šfo
)

2634  -
ENOMEM
;

2636 
šfo
->
off£t
 = offset;

2637 
šfo
->
by‹s
 = bytes;

2638 
šfo
->
Œim_¡©e
 =rim_state;

2639 
	`RB_CLEAR_NODE
(&
šfo
->
off£t_šdex
);

2640 
	`RB_CLEAR_NODE
(&
šfo
->
by‹s_šdex
);

2642 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

2644 ià(
	`Œy_m”ge_ä“_¥aû
(
ùl
, 
šfo
, 
Œue
))

2645 
lšk
;

2652 
»t
 = 
	`š£¹_što_b™m­
(
ùl
, 
šfo
);

2653 ià(
»t
 < 0) {

2654 
out
;

2655 } ià(
»t
) {

2656 
»t
 = 0;

2657 
out
;

2659 
lšk
:

2666 
	`¡—l_äom_b™m­
(
ùl
, 
šfo
, 
Œue
);

2668 
f‹r_by‹s
 = 
	`max
(f‹r_by‹s, 
šfo
->
by‹s
);

2670 
»t
 = 
	`lšk_ä“_¥aû
(
ùl
, 
šfo
);

2671 ià(
»t
)

2672 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
šfo
);

2673 
out
:

2674 
	`bŒfs_disÿrd_upd©e_disÿrdabË
(
block_group
);

2675 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

2677 ià(
»t
) {

2678 
	`bŒfs_ü™
(
fs_šfo
, "uÇbËØadd f»¥aû :%d", 
»t
);

2679 
	`ASSERT
(
»t
 !ğ-
EEXIST
);

2682 ià(
Œim_¡©e
 !ğ
BTRFS_TRIM_STATE_TRIMMED
) {

2683 
	`bŒfs_disÿrd_check_f‹r
(
block_group
, 
f‹r_by‹s
);

2684 
	`bŒfs_disÿrd_queue_wÜk
(&
fs_šfo
->
disÿrd_ùl
, 
block_group
);

2687  
»t
;

2688 
	}
}

2690 
	$__bŒfs_add_ä“_¥aû_zÚed
(
bŒfs_block_group
 *
block_group
,

2691 
u64
 
by‹Ä
, u64 
size
, 
boŞ
 
u£d
)

2693 
bŒfs_¥aû_šfo
 *
sšfo
 = 
block_group
->
¥aû_šfo
;

2694 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2695 
u64
 
off£t
 = 
by‹Ä
 - 
block_group
->
¡¬t
;

2696 
u64
 
to_ä“
, 
to_unu§bË
;

2697 
bg_»şaim_th»shŞd
 = 0;

2698 
boŞ
 
š™Ÿl
 = (
size
 =ğ
block_group
->
Ëngth
);

2699 
u64
 
»şaimabË_unu§bË
;

2701 
	`WARN_ON
(!
š™Ÿl
 && 
off£t
 + 
size
 > 
block_group
->
zÚe_ÿ·c™y
);

2703 ià(!
š™Ÿl
)

2704 
bg_»şaim_th»shŞd
 = 
	`READ_ONCE
(
sšfo
->bg_reclaim_threshold);

2706 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

2707 ià(!
u£d
)

2708 
to_ä“
 = 
size
;

2709 ià(
š™Ÿl
)

2710 
to_ä“
 = 
block_group
->
zÚe_ÿ·c™y
;

2711 ià(
off£t
 >ğ
block_group
->
®loc_off£t
)

2712 
to_ä“
 = 
size
;

2713 ià(
off£t
 + 
size
 <ğ
block_group
->
®loc_off£t
)

2714 
to_ä“
 = 0;

2716 
to_ä“
 = 
off£t
 + 
size
 - 
block_group
->
®loc_off£t
;

2717 
to_unu§bË
 = 
size
 - 
to_ä“
;

2719 
ùl
->
ä“_¥aû
 +ğ
to_ä“
;

2724 ià(!
block_group
->
ro
)

2725 
block_group
->
zÚe_unu§bË
 +ğ
to_unu§bË
;

2726 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

2727 ià(!
u£d
) {

2728 
	`¥š_lock
(&
block_group
->
lock
);

2729 
block_group
->
®loc_off£t
 -ğ
size
;

2730 
	`¥š_uÆock
(&
block_group
->
lock
);

2733 
»şaimabË_unu§bË
 = 
block_group
->
zÚe_unu§bË
 -

2734 (
block_group
->
Ëngth
 - block_group->
zÚe_ÿ·c™y
);

2736 ià(
block_group
->
zÚe_unu§bË
 =ğblock_group->
Ëngth
) {

2737 
	`bŒfs_m¬k_bg_unu£d
(
block_group
);

2738 } ià(
bg_»şaim_th»shŞd
 &&

2739 
»şaimabË_unu§bË
 >=

2740 
	`muÉ_³rc
(
block_group
->
zÚe_ÿ·c™y
, 
bg_»şaim_th»shŞd
)) {

2741 
	`bŒfs_m¬k_bg_to_»şaim
(
block_group
);

2745 
	}
}

2747 
	$bŒfs_add_ä“_¥aû
(
bŒfs_block_group
 *
block_group
,

2748 
u64
 
by‹Ä
, u64 
size
)

2750 
bŒfs_Œim_¡©e
 
Œim_¡©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

2752 ià(
	`bŒfs_is_zÚed
(
block_group
->
fs_šfo
))

2753  
	`__bŒfs_add_ä“_¥aû_zÚed
(
block_group
, 
by‹Ä
, 
size
,

2754 
Œue
);

2756 ià(
	`bŒfs_‹¡_İt
(
block_group
->
fs_šfo
, 
DISCARD_SYNC
))

2757 
Œim_¡©e
 = 
BTRFS_TRIM_STATE_TRIMMED
;

2759  
	`__bŒfs_add_ä“_¥aû
(
block_group
, 
by‹Ä
, 
size
, 
Œim_¡©e
);

2760 
	}
}

2762 
	$bŒfs_add_ä“_¥aû_unu£d
(
bŒfs_block_group
 *
block_group
,

2763 
u64
 
by‹Ä
, u64 
size
)

2765 ià(
	`bŒfs_is_zÚed
(
block_group
->
fs_šfo
))

2766  
	`__bŒfs_add_ä“_¥aû_zÚed
(
block_group
, 
by‹Ä
, 
size
,

2767 
çl£
);

2769  
	`bŒfs_add_ä“_¥aû
(
block_group
, 
by‹Ä
, 
size
);

2770 
	}
}

2777 
	$bŒfs_add_ä“_¥aû_async_Œimmed
(
bŒfs_block_group
 *
block_group
,

2778 
u64
 
by‹Ä
, u64 
size
)

2780 
bŒfs_Œim_¡©e
 
Œim_¡©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

2782 ià(
	`bŒfs_is_zÚed
(
block_group
->
fs_šfo
))

2783  
	`__bŒfs_add_ä“_¥aû_zÚed
(
block_group
, 
by‹Ä
, 
size
,

2784 
Œue
);

2786 ià(
	`bŒfs_‹¡_İt
(
block_group
->
fs_šfo
, 
DISCARD_SYNC
) ||

2787 
	`bŒfs_‹¡_İt
(
block_group
->
fs_šfo
, 
DISCARD_ASYNC
))

2788 
Œim_¡©e
 = 
BTRFS_TRIM_STATE_TRIMMED
;

2790  
	`__bŒfs_add_ä“_¥aû
(
block_group
, 
by‹Ä
, 
size
, 
Œim_¡©e
);

2791 
	}
}

2793 
	$bŒfs_»move_ä“_¥aû
(
bŒfs_block_group
 *
block_group
,

2794 
u64
 
off£t
, u64 
by‹s
)

2796 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2797 
bŒfs_ä“_¥aû
 *
šfo
;

2798 
»t
;

2799 
boŞ
 
»_£¬ch
 = 
çl£
;

2801 ià(
	`bŒfs_is_zÚed
(
block_group
->
fs_šfo
)) {

2813 ià(
block_group
->
¡¬t
 + block_group->
®loc_off£t
 <

2814 
off£t
 + 
by‹s
) {

2815 
block_group
->
®loc_off£t
 =

2816 
off£t
 + 
by‹s
 - 
block_group
->
¡¬t
;

2821 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

2823 
agaš
:

2824 
»t
 = 0;

2825 ià(!
by‹s
)

2826 
out_lock
;

2828 
šfo
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
off£t
, 0, 0);

2829 ià(!
šfo
) {

2834 
šfo
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
	`off£t_to_b™m­
(ùl, 
off£t
),

2836 ià(!
šfo
) {

2842 
	`WARN_ON
(
»_£¬ch
);

2843 
out_lock
;

2847 
»_£¬ch
 = 
çl£
;

2848 ià(!
šfo
->
b™m­
) {

2849 
	`uÆšk_ä“_¥aû
(
ùl
, 
šfo
, 
Œue
);

2850 ià(
off£t
 =ğ
šfo
->offset) {

2851 
u64
 
to_ä“
 = 
	`mš
(
by‹s
, 
šfo
->bytes);

2853 
šfo
->
by‹s
 -ğ
to_ä“
;

2854 
šfo
->
off£t
 +ğ
to_ä“
;

2855 ià(
šfo
->
by‹s
) {

2856 
»t
 = 
	`lšk_ä“_¥aû
(
ùl
, 
šfo
);

2857 
	`WARN_ON
(
»t
);

2859 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
šfo
);

2862 
off£t
 +ğ
to_ä“
;

2863 
by‹s
 -ğ
to_ä“
;

2864 
agaš
;

2866 
u64
 
Şd_’d
 = 
šfo
->
by‹s
 + info->
off£t
;

2868 
šfo
->
by‹s
 = 
off£t
 - info->offset;

2869 
»t
 = 
	`lšk_ä“_¥aû
(
ùl
, 
šfo
);

2870 
	`WARN_ON
(
»t
);

2871 ià(
»t
)

2872 
out_lock
;

2875 ià(
Şd_’d
 < 
off£t
 + 
by‹s
) {

2876 
by‹s
 -ğ
Şd_’d
 - 
off£t
;

2877 
off£t
 = 
Şd_’d
;

2878 
agaš
;

2879 } ià(
Şd_’d
 =ğ
off£t
 + 
by‹s
) {

2881 
out_lock
;

2883 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

2885 
»t
 = 
	`__bŒfs_add_ä“_¥aû
(
block_group
,

2886 
off£t
 + 
by‹s
,

2887 
Şd_’d
 - (
off£t
 + 
by‹s
),

2888 
šfo
->
Œim_¡©e
);

2889 
	`WARN_ON
(
»t
);

2890 
out
;

2894 
»t
 = 
	`»move_äom_b™m­
(
ùl
, 
šfo
, &
off£t
, &
by‹s
);

2895 ià(
»t
 =ğ-
EAGAIN
) {

2896 
»_£¬ch
 = 
Œue
;

2897 
agaš
;

2899 
out_lock
:

2900 
	`bŒfs_disÿrd_upd©e_disÿrdabË
(
block_group
);

2901 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

2902 
out
:

2903  
»t
;

2904 
	}
}

2906 
	$bŒfs_dump_ä“_¥aû
(
bŒfs_block_group
 *
block_group
,

2907 
u64
 
by‹s
)

2909 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

2910 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2911 
bŒfs_ä“_¥aû
 *
šfo
;

2912 
rb_node
 *
n
;

2913 
couÁ
 = 0;

2919 ià(
	`bŒfs_is_zÚed
(
fs_šfo
)) {

2920 
	`bŒfs_šfo
(
fs_šfo
, "free space %llu‡ctive %d",

2921 
block_group
->
zÚe_ÿ·c™y
 - block_group->
®loc_off£t
,

2922 
	`‹¡_b™
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
,

2923 &
block_group
->
ruÁime_æags
));

2927 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

2928 
n
 = 
	`rb_fœ¡
(&
ùl
->
ä“_¥aû_off£t
);‚;‚ = 
	`rb_Ãxt
(n)) {

2929 
šfo
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

2930 ià(
šfo
->
by‹s
 >ğby‹ && !
block_group
->
ro
)

2931 
couÁ
++;

2932 
	`bŒfs_ü™
(
fs_šfo
, "entry offset %llu, bytes %llu, bitmap %s",

2933 
šfo
->
off£t
, info->
by‹s
,

2934 (
šfo
->
b™m­
) ? "yes" : "no");

2936 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

2937 
	`bŒfs_šfo
(
fs_šfo
, "block group has cluster?: %s",

2938 
	`li¡_em±y
(&
block_group
->
şu¡”_li¡
) ? "no" : "yes");

2939 
	`bŒfs_šfo
(
fs_šfo
,

2941 
couÁ
, 
by‹s
);

2942 
	}
}

2944 
	$bŒfs_š™_ä“_¥aû_ùl
(
bŒfs_block_group
 *
block_group
,

2945 
bŒfs_ä“_¥aû_ùl
 *
ùl
)

2947 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

2949 
	`¥š_lock_š™
(&
ùl
->
Œ“_lock
);

2950 
ùl
->
un™
 = 
fs_šfo
->
£ùÜsize
;

2951 
ùl
->
¡¬t
 = 
block_group
->start;

2952 
ùl
->
block_group
 = block_group;

2953 
ùl
->
İ
 = &
ä“_¥aû_İ
;

2954 
ùl
->
ä“_¥aû_by‹s
 = 
RB_ROOT_CACHED
;

2955 
	`INIT_LIST_HEAD
(&
ùl
->
Œimmšg_¿nges
);

2956 
	`mu‹x_š™
(&
ùl
->
ÿche_wr™eout_mu‹x
);

2963 
ùl
->
ex‹Ás_th»sh
 = (
SZ_32K
 / 2è/ (
bŒfs_ä“_¥aû
);

2964 
	}
}

2972 
	$__bŒfs_»tuº_şu¡”_to_ä“_¥aû
(

2973 
bŒfs_block_group
 *
block_group
,

2974 
bŒfs_ä“_şu¡”
 *
şu¡”
)

2976 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2977 
rb_node
 *
node
;

2979 
	`lockd•_as£¹_h–d
(&
ùl
->
Œ“_lock
);

2981 
	`¥š_lock
(&
şu¡”
->
lock
);

2982 ià(
şu¡”
->
block_group
 != block_group) {

2983 
	`¥š_uÆock
(&
şu¡”
->
lock
);

2987 
şu¡”
->
block_group
 = 
NULL
;

2988 
şu¡”
->
wšdow_¡¬t
 = 0;

2989 
	`li¡_d–_š™
(&
şu¡”
->
block_group_li¡
);

2991 
node
 = 
	`rb_fœ¡
(&
şu¡”
->
roÙ
);

2992 
node
) {

2993 
bŒfs_ä“_¥aû
 *
’Œy
;

2995 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

2996 
node
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
);

2997 
	`rb_”a£
(&
’Œy
->
off£t_šdex
, &
şu¡”
->
roÙ
);

2998 
	`RB_CLEAR_NODE
(&
’Œy
->
off£t_šdex
);

3000 ià(!
’Œy
->
b™m­
) {

3002 ià(!
	`bŒfs_ä“_¥aû_Œimmed
(
’Œy
)) {

3003 
ùl
->
disÿrdabË_ex‹Ás
[
BTRFS_STAT_CURR
]--;

3004 
ùl
->
disÿrdabË_by‹s
[
BTRFS_STAT_CURR
] -=

3005 
’Œy
->
by‹s
;

3008 
	`Œy_m”ge_ä“_¥aû
(
ùl
, 
’Œy
, 
çl£
);

3009 
	`¡—l_äom_b™m­
(
ùl
, 
’Œy
, 
çl£
);

3012 ià(!
	`bŒfs_ä“_¥aû_Œimmed
(
’Œy
)) {

3013 
ùl
->
disÿrdabË_ex‹Ás
[
BTRFS_STAT_CURR
]++;

3014 
ùl
->
disÿrdabË_by‹s
[
BTRFS_STAT_CURR
] +=

3015 
’Œy
->
by‹s
;

3018 
	`Œ“_š£¹_off£t
(
ùl
, 
NULL
, 
’Œy
);

3019 
	`rb_add_ÿched
(&
’Œy
->
by‹s_šdex
, &
ùl
->
ä“_¥aû_by‹s
,

3020 
’Œy_Ëss
);

3022 
şu¡”
->
roÙ
 = 
RB_ROOT
;

3023 
	`¥š_uÆock
(&
şu¡”
->
lock
);

3024 
	`bŒfs_put_block_group
(
block_group
);

3025 
	}
}

3027 
	$bŒfs_»move_ä“_¥aû_ÿche
(
bŒfs_block_group
 *
block_group
)

3029 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3030 
bŒfs_ä“_şu¡”
 *
şu¡”
;

3031 
li¡_h—d
 *
h—d
;

3033 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3034 (
h—d
 = 
block_group
->
şu¡”_li¡
.
Ãxt
) !=

3035 &
block_group
->
şu¡”_li¡
) {

3036 
şu¡”
 = 
	`li¡_’Œy
(
h—d
, 
bŒfs_ä“_şu¡”
,

3037 
block_group_li¡
);

3039 
	`WARN_ON
(
şu¡”
->
block_group
 != block_group);

3040 
	`__bŒfs_»tuº_şu¡”_to_ä“_¥aû
(
block_group
, 
şu¡”
);

3042 
	`cÚd_»sched_lock
(&
ùl
->
Œ“_lock
);

3044 
	`__bŒfs_»move_ä“_¥aû_ÿche
(
ùl
);

3045 
	`bŒfs_disÿrd_upd©e_disÿrdabË
(
block_group
);

3046 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3048 
	}
}

3053 
boŞ
 
	$bŒfs_is_ä“_¥aû_Œimmed
(
bŒfs_block_group
 *
block_group
)

3055 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3056 
bŒfs_ä“_¥aû
 *
šfo
;

3057 
rb_node
 *
node
;

3058 
boŞ
 
»t
 = 
Œue
;

3060 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3061 
node
 = 
	`rb_fœ¡
(&
ùl
->
ä“_¥aû_off£t
);

3063 
node
) {

3064 
šfo
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

3066 ià(!
	`bŒfs_ä“_¥aû_Œimmed
(
šfo
)) {

3067 
»t
 = 
çl£
;

3071 
node
 = 
	`rb_Ãxt
(node);

3074 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3075  
»t
;

3076 
	}
}

3078 
u64
 
	$bŒfs_fšd_¥aû_fÜ_®loc
(
bŒfs_block_group
 *
block_group
,

3079 
u64
 
off£t
, u64 
by‹s
, u64 
em±y_size
,

3080 
u64
 *
max_ex‹Á_size
)

3082 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3083 
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
 =

3084 &
block_group
->
fs_šfo
->
disÿrd_ùl
;

3085 
bŒfs_ä“_¥aû
 *
’Œy
 = 
NULL
;

3086 
u64
 
by‹s_£¬ch
 = 
by‹s
 + 
em±y_size
;

3087 
u64
 
»t
 = 0;

3088 
u64
 
®ign_g­
 = 0;

3089 
u64
 
®ign_g­_Ën
 = 0;

3090 
bŒfs_Œim_¡©e
 
®ign_g­_Œim_¡©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

3091 
boŞ
 
u£_by‹s_šdex
 = (
off£t
 =ğ
block_group
->
¡¬t
);

3093 
	`ASSERT
(!
	`bŒfs_is_zÚed
(
block_group
->
fs_šfo
));

3095 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3096 
’Œy
 = 
	`fšd_ä“_¥aû
(
ùl
, &
off£t
, &
by‹s_£¬ch
,

3097 
block_group
->
fuÎ_¡re_Ën
, 
max_ex‹Á_size
,

3098 
u£_by‹s_šdex
);

3099 ià(!
’Œy
)

3100 
out
;

3102 
»t
 = 
off£t
;

3103 ià(
’Œy
->
b™m­
) {

3104 
	`b™m­_ş—r_b™s
(
ùl
, 
’Œy
, 
off£t
, 
by‹s
, 
Œue
);

3106 ià(!
	`bŒfs_ä“_¥aû_Œimmed
(
’Œy
))

3107 
	`©omic64_add
(
by‹s
, &
disÿrd_ùl
->
disÿrd_by‹s_§ved
);

3109 ià(!
’Œy
->
by‹s
)

3110 
	`ä“_b™m­
(
ùl
, 
’Œy
);

3112 
	`uÆšk_ä“_¥aû
(
ùl
, 
’Œy
, 
Œue
);

3113 
®ign_g­_Ën
 = 
off£t
 - 
’Œy
->offset;

3114 
®ign_g­
 = 
’Œy
->
off£t
;

3115 
®ign_g­_Œim_¡©e
 = 
’Œy
->
Œim_¡©e
;

3117 ià(!
	`bŒfs_ä“_¥aû_Œimmed
(
’Œy
))

3118 
	`©omic64_add
(
by‹s
, &
disÿrd_ùl
->
disÿrd_by‹s_§ved
);

3120 
’Œy
->
off£t
 = off£ˆ+ 
by‹s
;

3121 
	`WARN_ON
(
’Œy
->
by‹s
 < by‹ + 
®ign_g­_Ën
);

3123 
’Œy
->
by‹s
 -ğby‹ + 
®ign_g­_Ën
;

3124 ià(!
’Œy
->
by‹s
)

3125 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
’Œy
);

3127 
	`lšk_ä“_¥aû
(
ùl
, 
’Œy
);

3129 
out
:

3130 
	`bŒfs_disÿrd_upd©e_disÿrdabË
(
block_group
);

3131 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3133 ià(
®ign_g­_Ën
)

3134 
	`__bŒfs_add_ä“_¥aû
(
block_group
, 
®ign_g­
, 
®ign_g­_Ën
,

3135 
®ign_g­_Œim_¡©e
);

3136  
»t
;

3137 
	}
}

3147 
	$bŒfs_»tuº_şu¡”_to_ä“_¥aû
(

3148 
bŒfs_block_group
 *
block_group
,

3149 
bŒfs_ä“_şu¡”
 *
şu¡”
)

3151 
bŒfs_ä“_¥aû_ùl
 *
ùl
;

3154 
	`¥š_lock
(&
şu¡”
->
lock
);

3155 ià(!
block_group
) {

3156 
block_group
 = 
şu¡”
->block_group;

3157 ià(!
block_group
) {

3158 
	`¥š_uÆock
(&
şu¡”
->
lock
);

3161 } ià(
şu¡”
->
block_group
 != block_group) {

3163 
	`¥š_uÆock
(&
şu¡”
->
lock
);

3166 
	`bŒfs_g‘_block_group
(
block_group
);

3167 
	`¥š_uÆock
(&
şu¡”
->
lock
);

3169 
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3172 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3173 
	`__bŒfs_»tuº_şu¡”_to_ä“_¥aû
(
block_group
, 
şu¡”
);

3174 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3176 
	`bŒfs_disÿrd_queue_wÜk
(&
block_group
->
fs_šfo
->
disÿrd_ùl
, block_group);

3179 
	`bŒfs_put_block_group
(
block_group
);

3180 
	}
}

3182 
u64
 
	$bŒfs_®loc_äom_b™m­
(
bŒfs_block_group
 *
block_group
,

3183 
bŒfs_ä“_şu¡”
 *
şu¡”
,

3184 
bŒfs_ä“_¥aû
 *
’Œy
,

3185 
u64
 
by‹s
, u64 
mš_¡¬t
,

3186 
u64
 *
max_ex‹Á_size
)

3188 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3189 
”r
;

3190 
u64
 
£¬ch_¡¬t
 = 
şu¡”
->
wšdow_¡¬t
;

3191 
u64
 
£¬ch_by‹s
 = 
by‹s
;

3192 
u64
 
»t
 = 0;

3194 
£¬ch_¡¬t
 = 
mš_¡¬t
;

3195 
£¬ch_by‹s
 = 
by‹s
;

3197 
”r
 = 
	`£¬ch_b™m­
(
ùl
, 
’Œy
, &
£¬ch_¡¬t
, &
£¬ch_by‹s
, 
Œue
);

3198 ià(
”r
) {

3199 *
max_ex‹Á_size
 = 
	`max
(
	`g‘_max_ex‹Á_size
(
’Œy
),

3200 *
max_ex‹Á_size
);

3204 
»t
 = 
£¬ch_¡¬t
;

3205 
	`b™m­_ş—r_b™s
(
ùl
, 
’Œy
, 
»t
, 
by‹s
, 
çl£
);

3207  
»t
;

3208 
	}
}

3215 
u64
 
	$bŒfs_®loc_äom_şu¡”
(
bŒfs_block_group
 *
block_group
,

3216 
bŒfs_ä“_şu¡”
 *
şu¡”
, 
u64
 
by‹s
,

3217 
u64
 
mš_¡¬t
, u64 *
max_ex‹Á_size
)

3219 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3220 
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
 =

3221 &
block_group
->
fs_šfo
->
disÿrd_ùl
;

3222 
bŒfs_ä“_¥aû
 *
’Œy
 = 
NULL
;

3223 
rb_node
 *
node
;

3224 
u64
 
»t
 = 0;

3226 
	`ASSERT
(!
	`bŒfs_is_zÚed
(
block_group
->
fs_šfo
));

3228 
	`¥š_lock
(&
şu¡”
->
lock
);

3229 ià(
by‹s
 > 
şu¡”
->
max_size
)

3230 
out
;

3232 ià(
şu¡”
->
block_group
 != block_group)

3233 
out
;

3235 
node
 = 
	`rb_fœ¡
(&
şu¡”
->
roÙ
);

3236 ià(!
node
)

3237 
out
;

3239 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

3241 ià(
’Œy
->
by‹s
 < bytes)

3242 *
max_ex‹Á_size
 = 
	`max
(
	`g‘_max_ex‹Á_size
(
’Œy
),

3243 *
max_ex‹Á_size
);

3245 ià(
’Œy
->
by‹s
 < bytes ||

3246 (!
’Œy
->
b™m­
 &&ƒÁry->
off£t
 < 
mš_¡¬t
)) {

3247 
node
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
);

3248 ià(!
node
)

3250 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
,

3251 
off£t_šdex
);

3255 ià(
’Œy
->
b™m­
) {

3256 
»t
 = 
	`bŒfs_®loc_äom_b™m­
(
block_group
,

3257 
şu¡”
, 
’Œy
, 
by‹s
,

3258 
şu¡”
->
wšdow_¡¬t
,

3259 
max_ex‹Á_size
);

3260 ià(
»t
 == 0) {

3261 
node
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
);

3262 ià(!
node
)

3264 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
,

3265 
off£t_šdex
);

3268 
şu¡”
->
wšdow_¡¬t
 +ğ
by‹s
;

3270 
»t
 = 
’Œy
->
off£t
;

3272 
’Œy
->
off£t
 +ğ
by‹s
;

3273 
’Œy
->
by‹s
 -= bytes;

3278 
out
:

3279 
	`¥š_uÆock
(&
şu¡”
->
lock
);

3281 ià(!
»t
)

3284 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3286 ià(!
	`bŒfs_ä“_¥aû_Œimmed
(
’Œy
))

3287 
	`©omic64_add
(
by‹s
, &
disÿrd_ùl
->
disÿrd_by‹s_§ved
);

3289 
ùl
->
ä“_¥aû
 -ğ
by‹s
;

3290 ià(!
’Œy
->
b™m­
 && !
	`bŒfs_ä“_¥aû_Œimmed
(entry))

3291 
ùl
->
disÿrdabË_by‹s
[
BTRFS_STAT_CURR
] -ğ
by‹s
;

3293 
	`¥š_lock
(&
şu¡”
->
lock
);

3294 ià(
’Œy
->
by‹s
 == 0) {

3295 
	`rb_”a£
(&
’Œy
->
off£t_šdex
, &
şu¡”
->
roÙ
);

3296 
ùl
->
ä“_ex‹Ás
--;

3297 ià(
’Œy
->
b™m­
) {

3298 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_b™m­_ÿch•
,

3299 
’Œy
->
b™m­
);

3300 
ùl
->
tÙ®_b™m­s
--;

3301 
	`»ÿlcuÏ‹_th»shŞds
(
ùl
);

3302 } ià(!
	`bŒfs_ä“_¥aû_Œimmed
(
’Œy
)) {

3303 
ùl
->
disÿrdabË_ex‹Ás
[
BTRFS_STAT_CURR
]--;

3305 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
’Œy
);

3308 
	`¥š_uÆock
(&
şu¡”
->
lock
);

3309 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3311  
»t
;

3312 
	}
}

3314 
	$bŒfs_b™m­_şu¡”
(
bŒfs_block_group
 *
block_group
,

3315 
bŒfs_ä“_¥aû
 *
’Œy
,

3316 
bŒfs_ä“_şu¡”
 *
şu¡”
,

3317 
u64
 
off£t
, u64 
by‹s
,

3318 
u64
 
cÚt1_by‹s
, u64 
mš_by‹s
)

3320 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3321 
Ãxt_z”o
;

3322 
i
;

3323 
wªt_b™s
;

3324 
mš_b™s
;

3325 
found_b™s
;

3326 
max_b™s
 = 0;

3327 
¡¬t
 = 0;

3328 
tÙ®_found
 = 0;

3329 
»t
;

3331 
	`lockd•_as£¹_h–d
(&
ùl
->
Œ“_lock
);

3333 
i
 = 
	`off£t_to_b™
(
’Œy
->
off£t
, 
ùl
->
un™
,

3334 
	`max_t
(
u64
, 
off£t
, 
’Œy
->offset));

3335 
wªt_b™s
 = 
	`by‹s_to_b™s
(
by‹s
, 
ùl
->
un™
);

3336 
mš_b™s
 = 
	`by‹s_to_b™s
(
mš_by‹s
, 
ùl
->
un™
);

3342 ià(
’Œy
->
max_ex‹Á_size
 &&

3343 
’Œy
->
max_ex‹Á_size
 < 
cÚt1_by‹s
)

3344  -
ENOSPC
;

3345 
agaš
:

3346 
found_b™s
 = 0;

3347 
	`fÜ_—ch_£t_b™_äom
(
i
, 
’Œy
->
b™m­
, 
BITS_PER_BITMAP
) {

3348 
Ãxt_z”o
 = 
	`fšd_Ãxt_z”o_b™
(
’Œy
->
b™m­
,

3349 
BITS_PER_BITMAP
, 
i
);

3350 ià(
Ãxt_z”o
 - 
i
 >ğ
mš_b™s
) {

3351 
found_b™s
 = 
Ãxt_z”o
 - 
i
;

3352 ià(
found_b™s
 > 
max_b™s
)

3353 
max_b™s
 = 
found_b™s
;

3356 ià(
Ãxt_z”o
 - 
i
 > 
max_b™s
)

3357 
max_b™s
 = 
Ãxt_z”o
 - 
i
;

3358 
i
 = 
Ãxt_z”o
;

3361 ià(!
found_b™s
) {

3362 
’Œy
->
max_ex‹Á_size
 = (
u64
)
max_b™s
 * 
ùl
->
un™
;

3363  -
ENOSPC
;

3366 ià(!
tÙ®_found
) {

3367 
¡¬t
 = 
i
;

3368 
şu¡”
->
max_size
 = 0;

3371 
tÙ®_found
 +ğ
found_b™s
;

3373 ià(
şu¡”
->
max_size
 < 
found_b™s
 * 
ùl
->
un™
)

3374 
şu¡”
->
max_size
 = 
found_b™s
 * 
ùl
->
un™
;

3376 ià(
tÙ®_found
 < 
wªt_b™s
 || 
şu¡”
->
max_size
 < 
cÚt1_by‹s
) {

3377 
i
 = 
Ãxt_z”o
 + 1;

3378 
agaš
;

3381 
şu¡”
->
wšdow_¡¬t
 = 
¡¬t
 * 
ùl
->
un™
 + 
’Œy
->
off£t
;

3382 
	`rb_”a£
(&
’Œy
->
off£t_šdex
, &
ùl
->
ä“_¥aû_off£t
);

3383 
	`rb_”a£_ÿched
(&
’Œy
->
by‹s_šdex
, &
ùl
->
ä“_¥aû_by‹s
);

3392 
	`RB_CLEAR_NODE
(&
’Œy
->
by‹s_šdex
);

3394 
»t
 = 
	`Œ“_š£¹_off£t
(
ùl
, 
şu¡”
, 
’Œy
);

3395 
	`ASSERT
(!
»t
);

3397 
	`Œaû_bŒfs_£tup_şu¡”
(
block_group
, 
şu¡”
,

3398 
tÙ®_found
 * 
ùl
->
un™
, 1);

3400 
	}
}

3407 
nošlše
 

3408 
	$£tup_şu¡”_no_b™m­
(
bŒfs_block_group
 *
block_group
,

3409 
bŒfs_ä“_şu¡”
 *
şu¡”
,

3410 
li¡_h—d
 *
b™m­s
, 
u64
 
off£t
, u64 
by‹s
,

3411 
u64
 
cÚt1_by‹s
, u64 
mš_by‹s
)

3413 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3414 
bŒfs_ä“_¥aû
 *
fœ¡
 = 
NULL
;

3415 
bŒfs_ä“_¥aû
 *
’Œy
 = 
NULL
;

3416 
bŒfs_ä“_¥aû
 *
Ï¡
;

3417 
rb_node
 *
node
;

3418 
u64
 
wšdow_ä“
;

3419 
u64
 
max_ex‹Á
;

3420 
u64
 
tÙ®_size
 = 0;

3422 
	`lockd•_as£¹_h–d
(&
ùl
->
Œ“_lock
);

3424 
’Œy
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
off£t
, 0, 1);

3425 ià(!
’Œy
)

3426  -
ENOSPC
;

3432 
’Œy
->
b™m­
 ||ƒÁry->
by‹s
 < 
mš_by‹s
) {

3433 ià(
’Œy
->
b™m­
 && 
	`li¡_em±y
(&’Œy->
li¡
))

3434 
	`li¡_add_
(&
’Œy
->
li¡
, 
b™m­s
);

3435 
node
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
);

3436 ià(!
node
)

3437  -
ENOSPC
;

3438 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

3441 
wšdow_ä“
 = 
’Œy
->
by‹s
;

3442 
max_ex‹Á
 = 
’Œy
->
by‹s
;

3443 
fœ¡
 = 
’Œy
;

3444 
Ï¡
 = 
’Œy
;

3446 
node
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
);‚ode;

3447 
node
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
)) {

3448 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

3450 ià(
’Œy
->
b™m­
) {

3451 ià(
	`li¡_em±y
(&
’Œy
->
li¡
))

3452 
	`li¡_add_
(&
’Œy
->
li¡
, 
b™m­s
);

3456 ià(
’Œy
->
by‹s
 < 
mš_by‹s
)

3459 
Ï¡
 = 
’Œy
;

3460 
wšdow_ä“
 +ğ
’Œy
->
by‹s
;

3461 ià(
’Œy
->
by‹s
 > 
max_ex‹Á
)

3462 
max_ex‹Á
 = 
’Œy
->
by‹s
;

3465 ià(
wšdow_ä“
 < 
by‹s
 || 
max_ex‹Á
 < 
cÚt1_by‹s
)

3466  -
ENOSPC
;

3468 
şu¡”
->
wšdow_¡¬t
 = 
fœ¡
->
off£t
;

3470 
node
 = &
fœ¡
->
off£t_šdex
;

3477 
»t
;

3479 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

3480 
node
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
);

3481 ià(
’Œy
->
b™m­
 ||ƒÁry->
by‹s
 < 
mš_by‹s
)

3484 
	`rb_”a£
(&
’Œy
->
off£t_šdex
, &
ùl
->
ä“_¥aû_off£t
);

3485 
	`rb_”a£_ÿched
(&
’Œy
->
by‹s_šdex
, &
ùl
->
ä“_¥aû_by‹s
);

3486 
»t
 = 
	`Œ“_š£¹_off£t
(
ùl
, 
şu¡”
, 
’Œy
);

3487 
tÙ®_size
 +ğ
’Œy
->
by‹s
;

3488 
	`ASSERT
(!
»t
);

3489 } 
node
 && 
’Œy
 !ğ
Ï¡
);

3491 
şu¡”
->
max_size
 = 
max_ex‹Á
;

3492 
	`Œaû_bŒfs_£tup_şu¡”
(
block_group
, 
şu¡”
, 
tÙ®_size
, 0);

3494 
	}
}

3500 
nošlše
 

3501 
	$£tup_şu¡”_b™m­
(
bŒfs_block_group
 *
block_group
,

3502 
bŒfs_ä“_şu¡”
 *
şu¡”
,

3503 
li¡_h—d
 *
b™m­s
, 
u64
 
off£t
, u64 
by‹s
,

3504 
u64
 
cÚt1_by‹s
, u64 
mš_by‹s
)

3506 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3507 
bŒfs_ä“_¥aû
 *
’Œy
 = 
NULL
;

3508 
»t
 = -
ENOSPC
;

3509 
u64
 
b™m­_off£t
 = 
	`off£t_to_b™m­
(
ùl
, 
off£t
);

3511 ià(
ùl
->
tÙ®_b™m­s
 == 0)

3512  -
ENOSPC
;

3518 ià(!
	`li¡_em±y
(
b™m­s
))

3519 
’Œy
 = 
	`li¡_fœ¡_’Œy
(
b™m­s
, 
bŒfs_ä“_¥aû
, 
li¡
);

3521 ià(!
’Œy
 ||ƒÁry->
off£t
 !ğ
b™m­_off£t
) {

3522 
’Œy
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
b™m­_off£t
, 1, 0);

3523 ià(
’Œy
 && 
	`li¡_em±y
(&’Œy->
li¡
))

3524 
	`li¡_add
(&
’Œy
->
li¡
, 
b™m­s
);

3527 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, 
b™m­s
, 
li¡
) {

3528 ià(
’Œy
->
by‹s
 < bytes)

3530 
»t
 = 
	`bŒfs_b™m­_şu¡”
(
block_group
, 
’Œy
, 
şu¡”
, 
off£t
,

3531 
by‹s
, 
cÚt1_by‹s
, 
mš_by‹s
);

3532 ià(!
»t
)

3540  -
ENOSPC
;

3541 
	}
}

3551 
	$bŒfs_fšd_¥aû_şu¡”
(
bŒfs_block_group
 *
block_group
,

3552 
bŒfs_ä“_şu¡”
 *
şu¡”
,

3553 
u64
 
off£t
, u64 
by‹s
, u64 
em±y_size
)

3555 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

3556 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3557 
bŒfs_ä“_¥aû
 *
’Œy
, *
tmp
;

3558 
	`LIST_HEAD
(
b™m­s
);

3559 
u64
 
mš_by‹s
;

3560 
u64
 
cÚt1_by‹s
;

3561 
»t
;

3569 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
SSD_SPREAD
)) {

3570 
cÚt1_by‹s
 = 
by‹s
 + 
em±y_size
;

3571 
mš_by‹s
 = 
cÚt1_by‹s
;

3572 } ià(
block_group
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
) {

3573 
cÚt1_by‹s
 = 
by‹s
;

3574 
mš_by‹s
 = 
fs_šfo
->
£ùÜsize
;

3576 
cÚt1_by‹s
 = 
	`max
(
by‹s
, (by‹ + 
em±y_size
) >> 2);

3577 
mš_by‹s
 = 
fs_šfo
->
£ùÜsize
;

3580 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3586 ià(
ùl
->
ä“_¥aû
 < 
by‹s
) {

3587 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3588  -
ENOSPC
;

3591 
	`¥š_lock
(&
şu¡”
->
lock
);

3594 ià(
şu¡”
->
block_group
) {

3595 
»t
 = 0;

3596 
out
;

3599 
	`Œaû_bŒfs_fšd_şu¡”
(
block_group
, 
off£t
, 
by‹s
, 
em±y_size
,

3600 
mš_by‹s
);

3602 
»t
 = 
	`£tup_şu¡”_no_b™m­
(
block_group
, 
şu¡”
, &
b™m­s
, 
off£t
,

3603 
by‹s
 + 
em±y_size
,

3604 
cÚt1_by‹s
, 
mš_by‹s
);

3605 ià(
»t
)

3606 
»t
 = 
	`£tup_şu¡”_b™m­
(
block_group
, 
şu¡”
, &
b™m­s
,

3607 
off£t
, 
by‹s
 + 
em±y_size
,

3608 
cÚt1_by‹s
, 
mš_by‹s
);

3611 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
tmp
, &
b™m­s
, 
li¡
)

3612 
	`li¡_d–_š™
(&
’Œy
->
li¡
);

3614 ià(!
»t
) {

3615 
	`bŒfs_g‘_block_group
(
block_group
);

3616 
	`li¡_add_
(&
şu¡”
->
block_group_li¡
,

3617 &
block_group
->
şu¡”_li¡
);

3618 
şu¡”
->
block_group
 = block_group;

3620 
	`Œaû_bŒfs_çed_şu¡”_£tup
(
block_group
);

3622 
out
:

3623 
	`¥š_uÆock
(&
şu¡”
->
lock
);

3624 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3626  
»t
;

3627 
	}
}

3632 
	$bŒfs_š™_ä“_şu¡”
(
bŒfs_ä“_şu¡”
 *
şu¡”
)

3634 
	`¥š_lock_š™
(&
şu¡”
->
lock
);

3635 
	`¥š_lock_š™
(&
şu¡”
->
»fl_lock
);

3636 
şu¡”
->
roÙ
 = 
RB_ROOT
;

3637 
şu¡”
->
max_size
 = 0;

3638 
şu¡”
->
äagm’‹d
 = 
çl£
;

3639 
	`INIT_LIST_HEAD
(&
şu¡”
->
block_group_li¡
);

3640 
şu¡”
->
block_group
 = 
NULL
;

3641 
	}
}

3643 
	$do_Œimmšg
(
bŒfs_block_group
 *
block_group
,

3644 
u64
 *
tÙ®_Œimmed
, u64 
¡¬t
, u64 
by‹s
,

3645 
u64
 
»£rved_¡¬t
, u64 
»£rved_by‹s
,

3646 
bŒfs_Œim_¡©e
 
»£rved_Œim_¡©e
,

3647 
bŒfs_Œim_¿nge
 *
Œim_’Œy
)

3649 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
block_group
->space_info;

3650 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

3651 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3652 
»t
;

3653 
upd©e
 = 0;

3654 cÚ¡ 
u64
 
’d
 = 
¡¬t
 + 
by‹s
;

3655 cÚ¡ 
u64
 
»£rved_’d
 = 
»£rved_¡¬t
 + 
»£rved_by‹s
;

3656 
bŒfs_Œim_¡©e
 
Œim_¡©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

3657 
u64
 
Œimmed
 = 0;

3659 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

3660 
	`¥š_lock
(&
block_group
->
lock
);

3661 ià(!
block_group
->
ro
) {

3662 
block_group
->
»£rved
 +ğ
»£rved_by‹s
;

3663 
¥aû_šfo
->
by‹s_»£rved
 +ğ
»£rved_by‹s
;

3664 
upd©e
 = 1;

3666 
	`¥š_uÆock
(&
block_group
->
lock
);

3667 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

3669 
»t
 = 
	`bŒfs_disÿrd_ex‹Á
(
fs_šfo
, 
¡¬t
, 
by‹s
, &
Œimmed
);

3670 ià(!
»t
) {

3671 *
tÙ®_Œimmed
 +ğ
Œimmed
;

3672 
Œim_¡©e
 = 
BTRFS_TRIM_STATE_TRIMMED
;

3675 
	`mu‹x_lock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3676 ià(
»£rved_¡¬t
 < 
¡¬t
)

3677 
	`__bŒfs_add_ä“_¥aû
(
block_group
, 
»£rved_¡¬t
,

3678 
¡¬t
 - 
»£rved_¡¬t
,

3679 
»£rved_Œim_¡©e
);

3680 ià(
’d
 < 
»£rved_’d
)

3681 
	`__bŒfs_add_ä“_¥aû
(
block_group
, 
’d
, 
»£rved_’d
 -ƒnd,

3682 
»£rved_Œim_¡©e
);

3683 
	`__bŒfs_add_ä“_¥aû
(
block_group
, 
¡¬t
, 
by‹s
, 
Œim_¡©e
);

3684 
	`li¡_d–
(&
Œim_’Œy
->
li¡
);

3685 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3687 ià(
upd©e
) {

3688 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

3689 
	`¥š_lock
(&
block_group
->
lock
);

3690 ià(
block_group
->
ro
)

3691 
¥aû_šfo
->
by‹s_»adÚly
 +ğ
»£rved_by‹s
;

3692 
block_group
->
»£rved
 -ğ
»£rved_by‹s
;

3693 
¥aû_šfo
->
by‹s_»£rved
 -ğ
»£rved_by‹s
;

3694 
	`¥š_uÆock
(&
block_group
->
lock
);

3695 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

3698  
»t
;

3699 
	}
}

3704 
	$Œim_no_b™m­
(
bŒfs_block_group
 *
block_group
,

3705 
u64
 *
tÙ®_Œimmed
, u64 
¡¬t
, u64 
’d
, u64 
mšËn
,

3706 
boŞ
 
async
)

3708 
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
 =

3709 &
block_group
->
fs_šfo
->
disÿrd_ùl
;

3710 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3711 
bŒfs_ä“_¥aû
 *
’Œy
;

3712 
rb_node
 *
node
;

3713 
»t
 = 0;

3714 
u64
 
ex‹Á_¡¬t
;

3715 
u64
 
ex‹Á_by‹s
;

3716 
bŒfs_Œim_¡©e
 
ex‹Á_Œim_¡©e
;

3717 
u64
 
by‹s
;

3718 cÚ¡ 
u64
 
max_disÿrd_size
 = 
	`READ_ONCE
(
disÿrd_ùl
->max_discard_size);

3720 
¡¬t
 < 
’d
) {

3721 
bŒfs_Œim_¿nge
 
Œim_’Œy
;

3723 
	`mu‹x_lock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3724 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3726 ià(
ùl
->
ä“_¥aû
 < 
mšËn
)

3727 
out_uÆock
;

3729 
’Œy
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
¡¬t
, 0, 1);

3730 ià(!
’Œy
)

3731 
out_uÆock
;

3734 
’Œy
->
b™m­
 ||

3735 (
async
 && 
	`bŒfs_ä“_¥aû_Œimmed
(
’Œy
))) {

3736 
node
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
);

3737 ià(!
node
)

3738 
out_uÆock
;

3739 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
,

3740 
off£t_šdex
);

3743 ià(
’Œy
->
off£t
 >ğ
’d
)

3744 
out_uÆock
;

3746 
ex‹Á_¡¬t
 = 
’Œy
->
off£t
;

3747 
ex‹Á_by‹s
 = 
’Œy
->
by‹s
;

3748 
ex‹Á_Œim_¡©e
 = 
’Œy
->
Œim_¡©e
;

3749 ià(
async
) {

3750 
¡¬t
 = 
’Œy
->
off£t
;

3751 
by‹s
 = 
’Œy
->bytes;

3752 ià(
by‹s
 < 
mšËn
) {

3753 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3754 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3755 
Ãxt
;

3757 
	`uÆšk_ä“_¥aû
(
ùl
, 
’Œy
, 
Œue
);

3763 ià(
max_disÿrd_size
 &&

3764 
by‹s
 >ğ(
max_disÿrd_size
 +

3765 
BTRFS_ASYNC_DISCARD_MIN_FILTER
)) {

3766 
by‹s
 = 
max_disÿrd_size
;

3767 
ex‹Á_by‹s
 = 
max_disÿrd_size
;

3768 
’Œy
->
off£t
 +ğ
max_disÿrd_size
;

3769 
’Œy
->
by‹s
 -ğ
max_disÿrd_size
;

3770 
	`lšk_ä“_¥aû
(
ùl
, 
’Œy
);

3772 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
’Œy
);

3775 
¡¬t
 = 
	`max
(¡¬t, 
ex‹Á_¡¬t
);

3776 
by‹s
 = 
	`mš
(
ex‹Á_¡¬t
 + 
ex‹Á_by‹s
, 
’d
è- 
¡¬t
;

3777 ià(
by‹s
 < 
mšËn
) {

3778 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3779 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3780 
Ãxt
;

3783 
	`uÆšk_ä“_¥aû
(
ùl
, 
’Œy
, 
Œue
);

3784 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
’Œy
);

3787 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3788 
Œim_’Œy
.
¡¬t
 = 
ex‹Á_¡¬t
;

3789 
Œim_’Œy
.
by‹s
 = 
ex‹Á_by‹s
;

3790 
	`li¡_add_
(&
Œim_’Œy
.
li¡
, &
ùl
->
Œimmšg_¿nges
);

3791 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3793 
»t
 = 
	`do_Œimmšg
(
block_group
, 
tÙ®_Œimmed
, 
¡¬t
, 
by‹s
,

3794 
ex‹Á_¡¬t
, 
ex‹Á_by‹s
, 
ex‹Á_Œim_¡©e
,

3795 &
Œim_’Œy
);

3796 ià(
»t
) {

3797 
block_group
->
disÿrd_cursÜ
 = 
¡¬t
 + 
by‹s
;

3800 
Ãxt
:

3801 
¡¬t
 +ğ
by‹s
;

3802 
block_group
->
disÿrd_cursÜ
 = 
¡¬t
;

3803 ià(
async
 && *
tÙ®_Œimmed
)

3806 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

3807 
»t
 = -
ERESTARTSYS
;

3811 
	`cÚd_»sched
();

3814  
»t
;

3816 
out_uÆock
:

3817 
block_group
->
disÿrd_cursÜ
 = 
	`bŒfs_block_group_’d
(block_group);

3818 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3819 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3821  
»t
;

3822 
	}
}

3838 
	$»£t_Œimmšg_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
, 
u64
 
off£t
)

3840 
bŒfs_ä“_¥aû
 *
’Œy
;

3842 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3843 
’Œy
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
off£t
, 1, 0);

3844 ià(
’Œy
) {

3845 ià(
	`bŒfs_ä“_¥aû_Œimmed
(
’Œy
)) {

3846 
ùl
->
disÿrdabË_ex‹Ás
[
BTRFS_STAT_CURR
] +=

3847 
’Œy
->
b™m­_ex‹Ás
;

3848 
ùl
->
disÿrdabË_by‹s
[
BTRFS_STAT_CURR
] +ğ
’Œy
->
by‹s
;

3850 
’Œy
->
Œim_¡©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

3853 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3854 
	}
}

3856 
	$’d_Œimmšg_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

3857 
bŒfs_ä“_¥aû
 *
’Œy
)

3859 ià(
	`bŒfs_ä“_¥aû_Œimmšg_b™m­
(
’Œy
)) {

3860 
’Œy
->
Œim_¡©e
 = 
BTRFS_TRIM_STATE_TRIMMED
;

3861 
ùl
->
disÿrdabË_ex‹Ás
[
BTRFS_STAT_CURR
] -=

3862 
’Œy
->
b™m­_ex‹Ás
;

3863 
ùl
->
disÿrdabË_by‹s
[
BTRFS_STAT_CURR
] -ğ
’Œy
->
by‹s
;

3865 
	}
}

3870 
	$Œim_b™m­s
(
bŒfs_block_group
 *
block_group
,

3871 
u64
 *
tÙ®_Œimmed
, u64 
¡¬t
, u64 
’d
, u64 
mšËn
,

3872 
u64
 
maxËn
, 
boŞ
 
async
)

3874 
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
 =

3875 &
block_group
->
fs_šfo
->
disÿrd_ùl
;

3876 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3877 
bŒfs_ä“_¥aû
 *
’Œy
;

3878 
»t
 = 0;

3879 
»t2
;

3880 
u64
 
by‹s
;

3881 
u64
 
off£t
 = 
	`off£t_to_b™m­
(
ùl
, 
¡¬t
);

3882 cÚ¡ 
u64
 
max_disÿrd_size
 = 
	`READ_ONCE
(
disÿrd_ùl
->max_discard_size);

3884 
off£t
 < 
’d
) {

3885 
boŞ
 
Ãxt_b™m­
 = 
çl£
;

3886 
bŒfs_Œim_¿nge
 
Œim_’Œy
;

3888 
	`mu‹x_lock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3889 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3891 ià(
ùl
->
ä“_¥aû
 < 
mšËn
) {

3892 
block_group
->
disÿrd_cursÜ
 =

3893 
	`bŒfs_block_group_’d
(
block_group
);

3894 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3895 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3899 
’Œy
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
off£t
, 1, 0);

3908 ià(!
’Œy
 || (
async
 && 
mšËn
 && 
¡¬t
 =ğ
off£t
 &&

3909 
	`bŒfs_ä“_¥aû_Œimmed
(
’Œy
))) {

3910 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3911 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3912 
Ãxt_b™m­
 = 
Œue
;

3913 
Ãxt
;

3922 ià(
¡¬t
 =ğ
off£t
)

3923 
’Œy
->
Œim_¡©e
 = 
BTRFS_TRIM_STATE_TRIMMING
;

3925 
by‹s
 = 
mšËn
;

3926 
»t2
 = 
	`£¬ch_b™m­
(
ùl
, 
’Œy
, &
¡¬t
, &
by‹s
, 
çl£
);

3927 ià(
»t2
 || 
¡¬t
 >ğ
’d
) {

3932 ià(
»t2
 && 
mšËn
 <ğ
BTRFS_ASYNC_DISCARD_MIN_FILTER
)

3933 
	`’d_Œimmšg_b™m­
(
ùl
, 
’Œy
);

3935 
’Œy
->
Œim_¡©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

3936 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3937 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3938 
Ãxt_b™m­
 = 
Œue
;

3939 
Ãxt
;

3946 ià(
async
 && *
tÙ®_Œimmed
) {

3947 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3948 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3949 
out
;

3952 
by‹s
 = 
	`mš
(by‹s, 
’d
 - 
¡¬t
);

3953 ià(
by‹s
 < 
mšËn
 || (
async
 && 
maxËn
 && bytes > maxlen)) {

3954 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3955 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3956 
Ãxt
;

3965 ià(
async
 &&

3966 
max_disÿrd_size
 &&

3967 
by‹s
 > (
max_disÿrd_size
 + 
mšËn
))

3968 
by‹s
 = 
max_disÿrd_size
;

3970 
	`b™m­_ş—r_b™s
(
ùl
, 
’Œy
, 
¡¬t
, 
by‹s
, 
Œue
);

3971 ià(
’Œy
->
by‹s
 == 0)

3972 
	`ä“_b™m­
(
ùl
, 
’Œy
);

3974 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3975 
Œim_’Œy
.
¡¬t
 = start;

3976 
Œim_’Œy
.
by‹s
 = bytes;

3977 
	`li¡_add_
(&
Œim_’Œy
.
li¡
, &
ùl
->
Œimmšg_¿nges
);

3978 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3980 
»t
 = 
	`do_Œimmšg
(
block_group
, 
tÙ®_Œimmed
, 
¡¬t
, 
by‹s
,

3981 
¡¬t
, 
by‹s
, 0, &
Œim_’Œy
);

3982 ià(
»t
) {

3983 
	`»£t_Œimmšg_b™m­
(
ùl
, 
off£t
);

3984 
block_group
->
disÿrd_cursÜ
 =

3985 
	`bŒfs_block_group_’d
(
block_group
);

3988 
Ãxt
:

3989 ià(
Ãxt_b™m­
) {

3990 
off£t
 +ğ
BITS_PER_BITMAP
 * 
ùl
->
un™
;

3991 
¡¬t
 = 
off£t
;

3993 
¡¬t
 +ğ
by‹s
;

3995 
block_group
->
disÿrd_cursÜ
 = 
¡¬t
;

3997 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

3998 ià(
¡¬t
 !ğ
off£t
)

3999 
	`»£t_Œimmšg_b™m­
(
ùl
, 
off£t
);

4000 
»t
 = -
ERESTARTSYS
;

4004 
	`cÚd_»sched
();

4007 ià(
off£t
 >ğ
’d
)

4008 
block_group
->
disÿrd_cursÜ
 = 
’d
;

4010 
out
:

4011  
»t
;

4012 
	}
}

4014 
	$bŒfs_Œim_block_group
(
bŒfs_block_group
 *
block_group
,

4015 
u64
 *
Œimmed
, u64 
¡¬t
, u64 
’d
, u64 
mšËn
)

4017 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

4018 
»t
;

4019 
u64
 
»m
 = 0;

4021 
	`ASSERT
(!
	`bŒfs_is_zÚed
(
block_group
->
fs_šfo
));

4023 *
Œimmed
 = 0;

4025 
	`¥š_lock
(&
block_group
->
lock
);

4026 ià(
	`‹¡_b™
(
BLOCK_GROUP_FLAG_REMOVED
, &
block_group
->
ruÁime_æags
)) {

4027 
	`¥š_uÆock
(&
block_group
->
lock
);

4030 
	`bŒfs_ä“ze_block_group
(
block_group
);

4031 
	`¥š_uÆock
(&
block_group
->
lock
);

4033 
»t
 = 
	`Œim_no_b™m­
(
block_group
, 
Œimmed
, 
¡¬t
, 
’d
, 
mšËn
, 
çl£
);

4034 ià(
»t
)

4035 
out
;

4037 
»t
 = 
	`Œim_b™m­s
(
block_group
, 
Œimmed
, 
¡¬t
, 
’d
, 
mšËn
, 0, 
çl£
);

4038 
	`div64_u64_»m
(
’d
, 
BITS_PER_BITMAP
 * 
ùl
->
un™
, &
»m
);

4040 ià(
»m
)

4041 
	`»£t_Œimmšg_b™m­
(
ùl
, 
	`off£t_to_b™m­
(ùl, 
’d
));

4042 
out
:

4043 
	`bŒfs_unä“ze_block_group
(
block_group
);

4044  
»t
;

4045 
	}
}

4047 
	$bŒfs_Œim_block_group_ex‹Ás
(
bŒfs_block_group
 *
block_group
,

4048 
u64
 *
Œimmed
, u64 
¡¬t
, u64 
’d
, u64 
mšËn
,

4049 
boŞ
 
async
)

4051 
»t
;

4053 *
Œimmed
 = 0;

4055 
	`¥š_lock
(&
block_group
->
lock
);

4056 ià(
	`‹¡_b™
(
BLOCK_GROUP_FLAG_REMOVED
, &
block_group
->
ruÁime_æags
)) {

4057 
	`¥š_uÆock
(&
block_group
->
lock
);

4060 
	`bŒfs_ä“ze_block_group
(
block_group
);

4061 
	`¥š_uÆock
(&
block_group
->
lock
);

4063 
»t
 = 
	`Œim_no_b™m­
(
block_group
, 
Œimmed
, 
¡¬t
, 
’d
, 
mšËn
, 
async
);

4064 
	`bŒfs_unä“ze_block_group
(
block_group
);

4066  
»t
;

4067 
	}
}

4069 
	$bŒfs_Œim_block_group_b™m­s
(
bŒfs_block_group
 *
block_group
,

4070 
u64
 *
Œimmed
, u64 
¡¬t
, u64 
’d
, u64 
mšËn
,

4071 
u64
 
maxËn
, 
boŞ
 
async
)

4073 
»t
;

4075 *
Œimmed
 = 0;

4077 
	`¥š_lock
(&
block_group
->
lock
);

4078 ià(
	`‹¡_b™
(
BLOCK_GROUP_FLAG_REMOVED
, &
block_group
->
ruÁime_æags
)) {

4079 
	`¥š_uÆock
(&
block_group
->
lock
);

4082 
	`bŒfs_ä“ze_block_group
(
block_group
);

4083 
	`¥š_uÆock
(&
block_group
->
lock
);

4085 
»t
 = 
	`Œim_b™m­s
(
block_group
, 
Œimmed
, 
¡¬t
, 
’d
, 
mšËn
, 
maxËn
,

4086 
async
);

4088 
	`bŒfs_unä“ze_block_group
(
block_group
);

4090  
»t
;

4091 
	}
}

4093 
boŞ
 
	$bŒfs_ä“_¥aû_ÿche_v1_aùive
(
bŒfs_fs_šfo
 *
fs_šfo
)

4095  
	`bŒfs_su³r_ÿche_g’”©iÚ
(
fs_šfo
->
su³r_cİy
);

4096 
	}
}

4098 
	$ş—nup_ä“_¥aû_ÿche_v1
(
bŒfs_fs_šfo
 *
fs_šfo
,

4099 
bŒfs_Œªs_hªdË
 *
Œªs
)

4101 
bŒfs_block_group
 *
block_group
;

4102 
rb_node
 *
node
;

4103 
»t
 = 0;

4105 
	`bŒfs_šfo
(
fs_šfo
, "cleaning free space cache v1");

4107 
node
 = 
	`rb_fœ¡_ÿched
(&
fs_šfo
->
block_group_ÿche_Œ“
);

4108 
node
) {

4109 
block_group
 = 
	`rb_’Œy
(
node
, 
bŒfs_block_group
, 
ÿche_node
);

4110 
»t
 = 
	`bŒfs_»move_ä“_¥aû_šode
(
Œªs
, 
NULL
, 
block_group
);

4111 ià(
»t
)

4112 
out
;

4113 
node
 = 
	`rb_Ãxt
(node);

4115 
out
:

4116  
»t
;

4117 
	}
}

4119 
	$bŒfs_£t_ä“_¥aû_ÿche_v1_aùive
(
bŒfs_fs_šfo
 *
fs_šfo
, 
boŞ
 
aùive
)

4121 
bŒfs_Œªs_hªdË
 *
Œªs
;

4122 
»t
;

4132 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
fs_šfo
->
Œ“_roÙ
, 0);

4133 ià(
	`IS_ERR
(
Œªs
))

4134  
	`PTR_ERR
(
Œªs
);

4136 ià(!
aùive
) {

4137 
	`£t_b™
(
BTRFS_FS_CLEANUP_SPACE_CACHE_V1
, &
fs_šfo
->
æags
);

4138 
»t
 = 
	`ş—nup_ä“_¥aû_ÿche_v1
(
fs_šfo
, 
Œªs
);

4139 ià(
»t
) {

4140 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4141 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4142 
out
;

4146 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

4147 
out
:

4148 
	`ş—r_b™
(
BTRFS_FS_CLEANUP_SPACE_CACHE_V1
, &
fs_šfo
->
æags
);

4150  
»t
;

4151 
	}
}

4153 
__š™
 
	$bŒfs_ä“_¥aû_š™
()

4155 
bŒfs_ä“_¥aû_ÿch•
 = 
	`kmem_ÿche_ü—‹
("btrfs_free_space",

4156 (
bŒfs_ä“_¥aû
), 0,

4157 
SLAB_MEM_SPREAD
, 
NULL
);

4158 ià(!
bŒfs_ä“_¥aû_ÿch•
)

4159  -
ENOMEM
;

4161 
bŒfs_ä“_¥aû_b™m­_ÿch•
 = 
	`kmem_ÿche_ü—‹
("btrfs_free_space_bitmap",

4162 
PAGE_SIZE
, PAGE_SIZE,

4163 
SLAB_MEM_SPREAD
, 
NULL
);

4164 ià(!
bŒfs_ä“_¥aû_b™m­_ÿch•
) {

4165 
	`kmem_ÿche_de¡roy
(
bŒfs_ä“_¥aû_ÿch•
);

4166  -
ENOMEM
;

4170 
	}
}

4172 
__cŞd
 
	$bŒfs_ä“_¥aû_ex™
()

4174 
	`kmem_ÿche_de¡roy
(
bŒfs_ä“_¥aû_ÿch•
);

4175 
	`kmem_ÿche_de¡roy
(
bŒfs_ä“_¥aû_b™m­_ÿch•
);

4176 
	}
}

4178 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


4185 
	$‹¡_add_ä“_¥aû_’Œy
(
bŒfs_block_group
 *
ÿche
,

4186 
u64
 
off£t
, u64 
by‹s
, 
boŞ
 
b™m­
)

4188 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
ÿche
->
ä“_¥aû_ùl
;

4189 
bŒfs_ä“_¥aû
 *
šfo
 = 
NULL
, *
b™m­_šfo
;

4190 *
m­
 = 
NULL
;

4191 
bŒfs_Œim_¡©e
 
Œim_¡©e
 = 
BTRFS_TRIM_STATE_TRIMMED
;

4192 
u64
 
by‹s_added
;

4193 
»t
;

4195 
agaš
:

4196 ià(!
šfo
) {

4197 
šfo
 = 
	`kmem_ÿche_z®loc
(
bŒfs_ä“_¥aû_ÿch•
, 
GFP_NOFS
);

4198 ià(!
šfo
)

4199  -
ENOMEM
;

4202 ià(!
b™m­
) {

4203 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

4204 
šfo
->
off£t
 = offset;

4205 
šfo
->
by‹s
 = bytes;

4206 
šfo
->
max_ex‹Á_size
 = 0;

4207 
»t
 = 
	`lšk_ä“_¥aû
(
ùl
, 
šfo
);

4208 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

4209 ià(
»t
)

4210 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
šfo
);

4211  
»t
;

4214 ià(!
m­
) {

4215 
m­
 = 
	`kmem_ÿche_z®loc
(
bŒfs_ä“_¥aû_b™m­_ÿch•
, 
GFP_NOFS
);

4216 ià(!
m­
) {

4217 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
šfo
);

4218  -
ENOMEM
;

4222 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

4223 
b™m­_šfo
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
	`off£t_to_b™m­
(ùl, 
off£t
),

4225 ià(!
b™m­_šfo
) {

4226 
šfo
->
b™m­
 = 
m­
;

4227 
m­
 = 
NULL
;

4228 
	`add_Ãw_b™m­
(
ùl
, 
šfo
, 
off£t
);

4229 
b™m­_šfo
 = 
šfo
;

4230 
šfo
 = 
NULL
;

4233 
by‹s_added
 = 
	`add_by‹s_to_b™m­
(
ùl
, 
b™m­_šfo
, 
off£t
, 
by‹s
,

4234 
Œim_¡©e
);

4236 
by‹s
 -ğ
by‹s_added
;

4237 
off£t
 +ğ
by‹s_added
;

4238 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

4240 ià(
by‹s
)

4241 
agaš
;

4243 ià(
šfo
)

4244 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
šfo
);

4245 ià(
m­
)

4246 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_b™m­_ÿch•
, 
m­
);

4248 
	}
}

4255 
	$‹¡_check_exi¡s
(
bŒfs_block_group
 *
ÿche
,

4256 
u64
 
off£t
, u64 
by‹s
)

4258 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
ÿche
->
ä“_¥aû_ùl
;

4259 
bŒfs_ä“_¥aû
 *
šfo
;

4260 
»t
 = 0;

4262 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

4263 
šfo
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
off£t
, 0, 0);

4264 ià(!
šfo
) {

4265 
šfo
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
	`off£t_to_b™m­
(ùl, 
off£t
),

4267 ià(!
šfo
)

4268 
out
;

4271 
have_šfo
:

4272 ià(
šfo
->
b™m­
) {

4273 
u64
 
b™_off
, 
b™_by‹s
;

4274 
rb_node
 *
n
;

4275 
bŒfs_ä“_¥aû
 *
tmp
;

4277 
b™_off
 = 
off£t
;

4278 
b™_by‹s
 = 
ùl
->
un™
;

4279 
»t
 = 
	`£¬ch_b™m­
(
ùl
, 
šfo
, &
b™_off
, &
b™_by‹s
, 
çl£
);

4280 ià(!
»t
) {

4281 ià(
b™_off
 =ğ
off£t
) {

4282 
»t
 = 1;

4283 
out
;

4284 } ià(
b™_off
 > 
off£t
 &&

4285 
off£t
 + 
by‹s
 > 
b™_off
) {

4286 
»t
 = 1;

4287 
out
;

4291 
n
 = 
	`rb_´ev
(&
šfo
->
off£t_šdex
);

4292 
n
) {

4293 
tmp
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
,

4294 
off£t_šdex
);

4295 ià(
tmp
->
off£t
 +mp->
by‹s
 < offset)

4297 ià(
off£t
 + 
by‹s
 < 
tmp
->offset) {

4298 
n
 = 
	`rb_´ev
(&
tmp
->
off£t_šdex
);

4301 
šfo
 = 
tmp
;

4302 
have_šfo
;

4305 
n
 = 
	`rb_Ãxt
(&
šfo
->
off£t_šdex
);

4306 
n
) {

4307 
tmp
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
,

4308 
off£t_šdex
);

4309 ià(
off£t
 + 
by‹s
 < 
tmp
->offset)

4311 ià(
tmp
->
off£t
 +mp->
by‹s
 < offset) {

4312 
n
 = 
	`rb_Ãxt
(&
tmp
->
off£t_šdex
);

4315 
šfo
 = 
tmp
;

4316 
have_šfo
;

4319 
»t
 = 0;

4320 
out
;

4323 ià(
šfo
->
off£t
 == offset) {

4324 
»t
 = 1;

4325 
out
;

4328 ià(
off£t
 > 
šfo
->off£ˆ&& off£ˆ< info->off£ˆ+ info->
by‹s
)

4329 
»t
 = 1;

4330 
out
:

4331 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

4332  
»t
;

4333 
	}
}

	@free-space-cache.h

6 #iâdeà
BTRFS_FREE_SPACE_CACHE_H


7 
	#BTRFS_FREE_SPACE_CACHE_H


	)

17 
	ebŒfs_Œim_¡©e
 {

18 
	mBTRFS_TRIM_STATE_UNTRIMMED
,

19 
	mBTRFS_TRIM_STATE_TRIMMED
,

20 
	mBTRFS_TRIM_STATE_TRIMMING
,

23 
	sbŒfs_ä“_¥aû
 {

24 
rb_node
 
	moff£t_šdex
;

25 
rb_node
 
	mby‹s_šdex
;

26 
u64
 
	moff£t
;

27 
u64
 
	mby‹s
;

28 
u64
 
	mmax_ex‹Á_size
;

29 *
	mb™m­
;

30 
li¡_h—d
 
	mli¡
;

31 
bŒfs_Œim_¡©e
 
	mŒim_¡©e
;

32 
s32
 
	mb™m­_ex‹Ás
;

35 
šlše
 
boŞ
 
	$bŒfs_ä“_¥aû_Œimmed
(
bŒfs_ä“_¥aû
 *
šfo
)

37  (
šfo
->
Œim_¡©e
 =ğ
BTRFS_TRIM_STATE_TRIMMED
);

38 
	}
}

40 
šlše
 
boŞ
 
	$bŒfs_ä“_¥aû_Œimmšg_b™m­
(

41 
bŒfs_ä“_¥aû
 *
šfo
)

43  (
šfo
->
Œim_¡©e
 =ğ
BTRFS_TRIM_STATE_TRIMMING
);

44 
	}
}

52 
	mBTRFS_STAT_CURR
,

53 
	mBTRFS_STAT_PREV
,

54 
	mBTRFS_STAT_NR_ENTRIES
,

57 
	sbŒfs_ä“_¥aû_ùl
 {

58 
¥šlock_t
 
	mŒ“_lock
;

59 
rb_roÙ
 
	mä“_¥aû_off£t
;

60 
rb_roÙ_ÿched
 
	mä“_¥aû_by‹s
;

61 
u64
 
	mä“_¥aû
;

62 
	mex‹Ás_th»sh
;

63 
	mä“_ex‹Ás
;

64 
	mtÙ®_b™m­s
;

65 
	mun™
;

66 
u64
 
	m¡¬t
;

67 
s32
 
	mdisÿrdabË_ex‹Ás
[
BTRFS_STAT_NR_ENTRIES
];

68 
s64
 
	mdisÿrdabË_by‹s
[
BTRFS_STAT_NR_ENTRIES
];

69 cÚ¡ 
bŒfs_ä“_¥aû_İ
 *
	mİ
;

70 
bŒfs_block_group
 *
	mblock_group
;

71 
mu‹x
 
	mÿche_wr™eout_mu‹x
;

72 
li¡_h—d
 
	mŒimmšg_¿nges
;

75 
	sbŒfs_ä“_¥aû_İ
 {

76 
boŞ
 (*
u£_b™m­
)(
bŒfs_ä“_¥aû_ùl
 *
	mùl
,

77 
bŒfs_ä“_¥aû
 *
	mšfo
);

80 
	sbŒfs_io_ùl
 {

81 *
	mcur
, *
	mÜig
;

82 
·ge
 *
	m·ge
;

83 
·ge
 **
	m·ges
;

84 
bŒfs_fs_šfo
 *
	mfs_šfo
;

85 
šode
 *
	mšode
;

86 
	msize
;

87 
	mšdex
;

88 
	mnum_·ges
;

89 
	m’Œ›s
;

90 
	mb™m­s
;

93 
__š™
 
bŒfs_ä“_¥aû_š™
();

94 
__cŞd
 
bŒfs_ä“_¥aû_ex™
();

95 
šode
 *
lookup_ä“_¥aû_šode
(
bŒfs_block_group
 *
block_group
,

96 
bŒfs_·th
 *
·th
);

97 
ü—‹_ä“_¥aû_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

98 
bŒfs_block_group
 *
block_group
,

99 
bŒfs_·th
 *
·th
);

100 
bŒfs_»move_ä“_¥aû_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

101 
šode
 *inode,

102 
bŒfs_block_group
 *
block_group
);

104 
bŒfs_Œunÿ‹_ä“_¥aû_ÿche
(
bŒfs_Œªs_hªdË
 *
Œªs
,

105 
bŒfs_block_group
 *
block_group
,

106 
šode
 *inode);

107 
lßd_ä“_¥aû_ÿche
(
bŒfs_block_group
 *
block_group
);

108 
bŒfs_wa™_ÿche_io
(
bŒfs_Œªs_hªdË
 *
Œªs
,

109 
bŒfs_block_group
 *
block_group
,

110 
bŒfs_·th
 *
·th
);

111 
bŒfs_wr™e_out_ÿche
(
bŒfs_Œªs_hªdË
 *
Œªs
,

112 
bŒfs_block_group
 *
block_group
,

113 
bŒfs_·th
 *
·th
);

115 
bŒfs_š™_ä“_¥aû_ùl
(
bŒfs_block_group
 *
block_group
,

116 
bŒfs_ä“_¥aû_ùl
 *
ùl
);

117 
__bŒfs_add_ä“_¥aû
(
bŒfs_block_group
 *
block_group
, 
u64
 
by‹Ä
,

118 
u64
 
size
, 
bŒfs_Œim_¡©e
 
Œim_¡©e
);

119 
bŒfs_add_ä“_¥aû
(
bŒfs_block_group
 *
block_group
,

120 
u64
 
by‹Ä
, u64 
size
);

121 
bŒfs_add_ä“_¥aû_unu£d
(
bŒfs_block_group
 *
block_group
,

122 
u64
 
by‹Ä
, u64 
size
);

123 
bŒfs_add_ä“_¥aû_async_Œimmed
(
bŒfs_block_group
 *
block_group
,

124 
u64
 
by‹Ä
, u64 
size
);

125 
bŒfs_»move_ä“_¥aû
(
bŒfs_block_group
 *
block_group
,

126 
u64
 
by‹Ä
, u64 
size
);

127 
bŒfs_»move_ä“_¥aû_ÿche
(
bŒfs_block_group
 *
block_group
);

128 
boŞ
 
bŒfs_is_ä“_¥aû_Œimmed
(
bŒfs_block_group
 *
block_group
);

129 
u64
 
bŒfs_fšd_¥aû_fÜ_®loc
(
bŒfs_block_group
 *
block_group
,

130 
u64
 
off£t
, u64 
by‹s
, u64 
em±y_size
,

131 
u64
 *
max_ex‹Á_size
);

132 
bŒfs_dump_ä“_¥aû
(
bŒfs_block_group
 *
block_group
,

133 
u64
 
by‹s
);

134 
bŒfs_fšd_¥aû_şu¡”
(
bŒfs_block_group
 *
block_group
,

135 
bŒfs_ä“_şu¡”
 *
şu¡”
,

136 
u64
 
off£t
, u64 
by‹s
, u64 
em±y_size
);

137 
bŒfs_š™_ä“_şu¡”
(
bŒfs_ä“_şu¡”
 *
şu¡”
);

138 
u64
 
bŒfs_®loc_äom_şu¡”
(
bŒfs_block_group
 *
block_group
,

139 
bŒfs_ä“_şu¡”
 *
şu¡”
, 
u64
 
by‹s
,

140 
u64
 
mš_¡¬t
, u64 *
max_ex‹Á_size
);

141 
bŒfs_»tuº_şu¡”_to_ä“_¥aû
(

142 
bŒfs_block_group
 *
block_group
,

143 
bŒfs_ä“_şu¡”
 *
şu¡”
);

144 
bŒfs_Œim_block_group
(
bŒfs_block_group
 *
block_group
,

145 
u64
 *
Œimmed
, u64 
¡¬t
, u64 
’d
, u64 
mšËn
);

146 
bŒfs_Œim_block_group_ex‹Ás
(
bŒfs_block_group
 *
block_group
,

147 
u64
 *
Œimmed
, u64 
¡¬t
, u64 
’d
, u64 
mšËn
,

148 
boŞ
 
async
);

149 
bŒfs_Œim_block_group_b™m­s
(
bŒfs_block_group
 *
block_group
,

150 
u64
 *
Œimmed
, u64 
¡¬t
, u64 
’d
, u64 
mšËn
,

151 
u64
 
maxËn
, 
boŞ
 
async
);

153 
boŞ
 
bŒfs_ä“_¥aû_ÿche_v1_aùive
(
bŒfs_fs_šfo
 *
fs_šfo
);

154 
bŒfs_£t_ä“_¥aû_ÿche_v1_aùive
(
bŒfs_fs_šfo
 *
fs_šfo
, 
boŞ
 
aùive
);

156 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


157 
‹¡_add_ä“_¥aû_’Œy
(
bŒfs_block_group
 *
ÿche
,

158 
u64
 
off£t
, u64 
by‹s
, 
boŞ
 
b™m­
);

159 
‹¡_check_exi¡s
(
bŒfs_block_group
 *
ÿche
, 
u64
 
off£t
, u64 
by‹s
);

	@free-space-tree.c

6 
	~<lšux/k”Ãl.h
>

7 
	~<lšux/sched/mm.h
>

8 
	~"mes§ges.h
"

9 
	~"ù»e.h
"

10 
	~"disk-io.h
"

11 
	~"lockšg.h
"

12 
	~"ä“-¥aû-Œ“.h
"

13 
	~"Œª§ùiÚ.h
"

14 
	~"block-group.h
"

15 
	~"fs.h
"

16 
	~"acûssÜs.h
"

17 
	~"ex‹Á-Œ“.h
"

18 
	~"roÙ-Œ“.h
"

20 
__add_block_group_ä“_¥aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

21 
bŒfs_block_group
 *
block_group
,

22 
bŒfs_·th
 *
·th
);

24 
bŒfs_roÙ
 *
	$bŒfs_ä“_¥aû_roÙ
(

25 
bŒfs_block_group
 *
block_group
)

27 
bŒfs_key
 
key
 = {

28 .
objeùid
 = 
BTRFS_FREE_SPACE_TREE_OBJECTID
,

29 .
ty³
 = 
BTRFS_ROOT_ITEM_KEY
,

30 .
off£t
 = 0,

33 ià(
	`bŒfs_fs_šcom·t
(
block_group
->
fs_šfo
, 
EXTENT_TREE_V2
))

34 
key
.
off£t
 = 
block_group
->
glob®_roÙ_id
;

35  
	`bŒfs_glob®_roÙ
(
block_group
->
fs_šfo
, &
key
);

36 
	}
}

38 
	$£t_ä“_¥aû_Œ“_th»shŞds
(
bŒfs_block_group
 *
ÿche
)

40 
u32
 
b™m­_¿nge
;

41 
size_t
 
b™m­_size
;

42 
u64
 
num_b™m­s
, 
tÙ®_b™m­_size
;

44 ià(
	`WARN_ON
(
ÿche
->
Ëngth
 == 0))

45 
	`bŒfs_w¬n
(
ÿche
->
fs_šfo
, "block group %llu†ength is zero",

46 
ÿche
->
¡¬t
);

52 
b™m­_¿nge
 = 
ÿche
->
fs_šfo
->
£ùÜsize
 * 
BTRFS_FREE_SPACE_BITMAP_BITS
;

53 
num_b™m­s
 = 
	`div_u64
(
ÿche
->
Ëngth
 + 
b™m­_¿nge
 - 1, bitmap_range);

54 
b™m­_size
 = (
bŒfs_™em
è+ 
BTRFS_FREE_SPACE_BITMAP_SIZE
;

55 
tÙ®_b™m­_size
 = 
num_b™m­s
 * 
b™m­_size
;

56 
ÿche
->
b™m­_high_th»sh
 = 
	`div_u64
(
tÙ®_b™m­_size
,

57 (
bŒfs_™em
));

63 ià(
ÿche
->
b™m­_high_th»sh
 > 100)

64 
ÿche
->
b™m­_low_th»sh
 = cache->
b™m­_high_th»sh
 - 100;

66 
ÿche
->
b™m­_low_th»sh
 = 0;

67 
	}
}

69 
	$add_Ãw_ä“_¥aû_šfo
(
bŒfs_Œªs_hªdË
 *
Œªs
,

70 
bŒfs_block_group
 *
block_group
,

71 
bŒfs_·th
 *
·th
)

73 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_ä“_¥aû_roÙ
(
block_group
);

74 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

75 
bŒfs_key
 
key
;

76 
ex‹Á_bufãr
 *
Ëaf
;

77 
»t
;

79 
key
.
objeùid
 = 
block_group
->
¡¬t
;

80 
key
.
ty³
 = 
BTRFS_FREE_SPACE_INFO_KEY
;

81 
key
.
off£t
 = 
block_group
->
Ëngth
;

83 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, (*
šfo
));

84 ià(
»t
)

85 
out
;

87 
Ëaf
 = 
·th
->
nodes
[0];

88 
šfo
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

89 
bŒfs_ä“_¥aû_šfo
);

90 
	`bŒfs_£t_ä“_¥aû_ex‹Á_couÁ
(
Ëaf
, 
šfo
, 0);

91 
	`bŒfs_£t_ä“_¥aû_æags
(
Ëaf
, 
šfo
, 0);

92 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

94 
»t
 = 0;

95 
out
:

96 
	`bŒfs_»Ëa£_·th
(
·th
);

97  
»t
;

98 
	}
}

100 
EXPORT_FOR_TESTS


101 
bŒfs_ä“_¥aû_šfo
 *
	$£¬ch_ä“_¥aû_šfo
(

102 
bŒfs_Œªs_hªdË
 *
Œªs
,

103 
bŒfs_block_group
 *
block_group
,

104 
bŒfs_·th
 *
·th
, 
cow
)

106 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

107 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_ä“_¥aû_roÙ
(
block_group
);

108 
bŒfs_key
 
key
;

109 
»t
;

111 
key
.
objeùid
 = 
block_group
->
¡¬t
;

112 
key
.
ty³
 = 
BTRFS_FREE_SPACE_INFO_KEY
;

113 
key
.
off£t
 = 
block_group
->
Ëngth
;

115 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 
cow
);

116 ià(
»t
 < 0)

117  
	`ERR_PTR
(
»t
);

118 ià(
»t
 != 0) {

119 
	`bŒfs_w¬n
(
fs_šfo
, "missing free space info for %llu",

120 
block_group
->
¡¬t
);

121 
	`ASSERT
(0);

122  
	`ERR_PTR
(-
ENOENT
);

125  
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

126 
bŒfs_ä“_¥aû_šfo
);

127 
	}
}

133 
	$bŒfs_£¬ch_´ev_¦Ù
(
bŒfs_Œªs_hªdË
 *
Œªs
,

134 
bŒfs_roÙ
 *
roÙ
,

135 
bŒfs_key
 *
key
, 
bŒfs_·th
 *
p
,

136 
šs_Ën
, 
cow
)

138 
»t
;

140 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, 
key
, 
p
, 
šs_Ën
, 
cow
);

141 ià(
»t
 < 0)

142  
»t
;

144 ià(
»t
 == 0) {

145 
	`ASSERT
(0);

146  -
EIO
;

149 ià(
p
->
¦Ùs
[0] == 0) {

150 
	`ASSERT
(0);

151  -
EIO
;

153 
p
->
¦Ùs
[0]--;

156 
	}
}

158 
šlše
 
u32
 
	$ä“_¥aû_b™m­_size
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

159 
u64
 
size
)

161  
	`DIV_ROUND_UP
(
size
 >> 
fs_šfo
->
£ùÜsize_b™s
, 
BITS_PER_BYTE
);

162 
	}
}

164 *
	$®loc_b™m­
(
u32
 
b™m­_size
)

166 *
»t
;

167 
nofs_æag
;

168 
u32
 
b™m­_rounded_size
 = 
	`round_up
(
b™m­_size
, ());

178 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

179 
»t
 = 
	`kvz®loc
(
b™m­_rounded_size
, 
GFP_KERNEL
);

180 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

181  
»t
;

182 
	}
}

184 
	$Ë_b™m­_£t
(*
m­
, 
¡¬t
, 
Ën
)

186 
u8
 *
p
 = ((u8 *)
m­
è+ 
	`BIT_BYTE
(
¡¬t
);

187 cÚ¡ 
size
 = 
¡¬t
 + 
Ën
;

188 
b™s_to_£t
 = 
BITS_PER_BYTE
 - (
¡¬t
 % BITS_PER_BYTE);

189 
u8
 
mask_to_£t
 = 
	`BITMAP_FIRST_BYTE_MASK
(
¡¬t
);

191 
Ën
 - 
b™s_to_£t
 >= 0) {

192 *
p
 |ğ
mask_to_£t
;

193 
Ën
 -ğ
b™s_to_£t
;

194 
b™s_to_£t
 = 
BITS_PER_BYTE
;

195 
mask_to_£t
 = ~0;

196 
p
++;

198 ià(
Ën
) {

199 
mask_to_£t
 &ğ
	`BITMAP_LAST_BYTE_MASK
(
size
);

200 *
p
 |ğ
mask_to_£t
;

202 
	}
}

204 
EXPORT_FOR_TESTS


205 
	$cÚv”t_ä“_¥aû_to_b™m­s
(
bŒfs_Œªs_hªdË
 *
Œªs
,

206 
bŒfs_block_group
 *
block_group
,

207 
bŒfs_·th
 *
·th
)

209 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

210 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_ä“_¥aû_roÙ
(
block_group
);

211 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

212 
bŒfs_key
 
key
, 
found_key
;

213 
ex‹Á_bufãr
 *
Ëaf
;

214 *
b™m­
;

215 *
b™m­_cursÜ
;

216 
u64
 
¡¬t
, 
’d
;

217 
u64
 
b™m­_¿nge
, 
i
;

218 
u32
 
b™m­_size
, 
æags
, 
ex³ùed_ex‹Á_couÁ
;

219 
u32
 
ex‹Á_couÁ
 = 0;

220 
dÚe
 = 0, 
Ä
;

221 
»t
;

223 
b™m­_size
 = 
	`ä“_¥aû_b™m­_size
(
fs_šfo
, 
block_group
->
Ëngth
);

224 
b™m­
 = 
	`®loc_b™m­
(
b™m­_size
);

225 ià(!
b™m­
) {

226 
»t
 = -
ENOMEM
;

227 
out
;

230 
¡¬t
 = 
block_group
->start;

231 
’d
 = 
block_group
->
¡¬t
 + block_group->
Ëngth
;

233 
key
.
objeùid
 = 
’d
 - 1;

234 
key
.
ty³
 = (
u8
)-1;

235 
key
.
off£t
 = (
u64
)-1;

237 !
dÚe
) {

238 
»t
 = 
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

239 ià(
»t
)

240 
out
;

242 
Ëaf
 = 
·th
->
nodes
[0];

243 
Ä
 = 0;

244 
·th
->
¦Ùs
[0]++;

245 
·th
->
¦Ùs
[0] > 0) {

246 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0] - 1);

248 ià(
found_key
.
ty³
 =ğ
BTRFS_FREE_SPACE_INFO_KEY
) {

249 
	`ASSERT
(
found_key
.
objeùid
 =ğ
block_group
->
¡¬t
);

250 
	`ASSERT
(
found_key
.
off£t
 =ğ
block_group
->
Ëngth
);

251 
dÚe
 = 1;

253 } ià(
found_key
.
ty³
 =ğ
BTRFS_FREE_SPACE_EXTENT_KEY
) {

254 
u64
 
fœ¡
, 
Ï¡
;

256 
	`ASSERT
(
found_key
.
objeùid
 >ğ
¡¬t
);

257 
	`ASSERT
(
found_key
.
objeùid
 < 
’d
);

258 
	`ASSERT
(
found_key
.
objeùid
 + found_key.
off£t
 <ğ
’d
);

260 
fœ¡
 = 
	`div_u64
(
found_key
.
objeùid
 - 
¡¬t
,

261 
fs_šfo
->
£ùÜsize
);

262 
Ï¡
 = 
	`div_u64
(
found_key
.
objeùid
 + found_key.
off£t
 - 
¡¬t
,

263 
fs_šfo
->
£ùÜsize
);

264 
	`Ë_b™m­_£t
(
b™m­
, 
fœ¡
, 
Ï¡
 - first);

266 
ex‹Á_couÁ
++;

267 
Ä
++;

268 
·th
->
¦Ùs
[0]--;

270 
	`ASSERT
(0);

274 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
,…©h->
¦Ùs
[0], 
Ä
);

275 ià(
»t
)

276 
out
;

277 
	`bŒfs_»Ëa£_·th
(
·th
);

280 
šfo
 = 
	`£¬ch_ä“_¥aû_šfo
(
Œªs
, 
block_group
, 
·th
, 1);

281 ià(
	`IS_ERR
(
šfo
)) {

282 
»t
 = 
	`PTR_ERR
(
šfo
);

283 
out
;

285 
Ëaf
 = 
·th
->
nodes
[0];

286 
æags
 = 
	`bŒfs_ä“_¥aû_æags
(
Ëaf
, 
šfo
);

287 
æags
 |ğ
BTRFS_FREE_SPACE_USING_BITMAPS
;

288 
	`bŒfs_£t_ä“_¥aû_æags
(
Ëaf
, 
šfo
, 
æags
);

289 
ex³ùed_ex‹Á_couÁ
 = 
	`bŒfs_ä“_¥aû_ex‹Á_couÁ
(
Ëaf
, 
šfo
);

290 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

291 
	`bŒfs_»Ëa£_·th
(
·th
);

293 ià(
ex‹Á_couÁ
 !ğ
ex³ùed_ex‹Á_couÁ
) {

294 
	`bŒfs_”r
(
fs_šfo
,

296 
block_group
->
¡¬t
, 
ex‹Á_couÁ
,

297 
ex³ùed_ex‹Á_couÁ
);

298 
	`ASSERT
(0);

299 
»t
 = -
EIO
;

300 
out
;

303 
b™m­_cursÜ
 = (*)
b™m­
;

304 
b™m­_¿nge
 = 
fs_šfo
->
£ùÜsize
 * 
BTRFS_FREE_SPACE_BITMAP_BITS
;

305 
i
 = 
¡¬t
;

306 
i
 < 
’d
) {

307 
±r
;

308 
u64
 
ex‹Á_size
;

309 
u32
 
d©a_size
;

311 
ex‹Á_size
 = 
	`mš
(
’d
 - 
i
, 
b™m­_¿nge
);

312 
d©a_size
 = 
	`ä“_¥aû_b™m­_size
(
fs_šfo
, 
ex‹Á_size
);

314 
key
.
objeùid
 = 
i
;

315 
key
.
ty³
 = 
BTRFS_FREE_SPACE_BITMAP_KEY
;

316 
key
.
off£t
 = 
ex‹Á_size
;

318 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

319 
d©a_size
);

320 ià(
»t
)

321 
out
;

323 
Ëaf
 = 
·th
->
nodes
[0];

324 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

325 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
b™m­_cursÜ
, 
±r
,

326 
d©a_size
);

327 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

328 
	`bŒfs_»Ëa£_·th
(
·th
);

330 
i
 +ğ
ex‹Á_size
;

331 
b™m­_cursÜ
 +ğ
d©a_size
;

334 
»t
 = 0;

335 
out
:

336 
	`kvä“
(
b™m­
);

337 ià(
»t
)

338 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

339  
»t
;

340 
	}
}

342 
EXPORT_FOR_TESTS


343 
	$cÚv”t_ä“_¥aû_to_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

344 
bŒfs_block_group
 *
block_group
,

345 
bŒfs_·th
 *
·th
)

347 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

348 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_ä“_¥aû_roÙ
(
block_group
);

349 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

350 
bŒfs_key
 
key
, 
found_key
;

351 
ex‹Á_bufãr
 *
Ëaf
;

352 *
b™m­
;

353 
u64
 
¡¬t
, 
’d
;

354 
u32
 
b™m­_size
, 
æags
, 
ex³ùed_ex‹Á_couÁ
;

355 
Äb™s
, 
¡¬t_b™
, 
’d_b™
;

356 
u32
 
ex‹Á_couÁ
 = 0;

357 
dÚe
 = 0, 
Ä
;

358 
»t
;

360 
b™m­_size
 = 
	`ä“_¥aû_b™m­_size
(
fs_šfo
, 
block_group
->
Ëngth
);

361 
b™m­
 = 
	`®loc_b™m­
(
b™m­_size
);

362 ià(!
b™m­
) {

363 
»t
 = -
ENOMEM
;

364 
out
;

367 
¡¬t
 = 
block_group
->start;

368 
’d
 = 
block_group
->
¡¬t
 + block_group->
Ëngth
;

370 
key
.
objeùid
 = 
’d
 - 1;

371 
key
.
ty³
 = (
u8
)-1;

372 
key
.
off£t
 = (
u64
)-1;

374 !
dÚe
) {

375 
»t
 = 
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

376 ià(
»t
)

377 
out
;

379 
Ëaf
 = 
·th
->
nodes
[0];

380 
Ä
 = 0;

381 
·th
->
¦Ùs
[0]++;

382 
·th
->
¦Ùs
[0] > 0) {

383 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0] - 1);

385 ià(
found_key
.
ty³
 =ğ
BTRFS_FREE_SPACE_INFO_KEY
) {

386 
	`ASSERT
(
found_key
.
objeùid
 =ğ
block_group
->
¡¬t
);

387 
	`ASSERT
(
found_key
.
off£t
 =ğ
block_group
->
Ëngth
);

388 
dÚe
 = 1;

390 } ià(
found_key
.
ty³
 =ğ
BTRFS_FREE_SPACE_BITMAP_KEY
) {

391 
±r
;

392 *
b™m­_cursÜ
;

393 
u32
 
b™m­_pos
, 
d©a_size
;

395 
	`ASSERT
(
found_key
.
objeùid
 >ğ
¡¬t
);

396 
	`ASSERT
(
found_key
.
objeùid
 < 
’d
);

397 
	`ASSERT
(
found_key
.
objeùid
 + found_key.
off£t
 <ğ
’d
);

399 
b™m­_pos
 = 
	`div_u64
(
found_key
.
objeùid
 - 
¡¬t
,

400 
fs_šfo
->
£ùÜsize
 *

401 
BITS_PER_BYTE
);

402 
b™m­_cursÜ
 = ((*)
b™m­
è+ 
b™m­_pos
;

403 
d©a_size
 = 
	`ä“_¥aû_b™m­_size
(
fs_šfo
,

404 
found_key
.
off£t
);

406 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1);

407 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
b™m­_cursÜ
, 
±r
,

408 
d©a_size
);

410 
Ä
++;

411 
·th
->
¦Ùs
[0]--;

413 
	`ASSERT
(0);

417 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
,…©h->
¦Ùs
[0], 
Ä
);

418 ià(
»t
)

419 
out
;

420 
	`bŒfs_»Ëa£_·th
(
·th
);

423 
šfo
 = 
	`£¬ch_ä“_¥aû_šfo
(
Œªs
, 
block_group
, 
·th
, 1);

424 ià(
	`IS_ERR
(
šfo
)) {

425 
»t
 = 
	`PTR_ERR
(
šfo
);

426 
out
;

428 
Ëaf
 = 
·th
->
nodes
[0];

429 
æags
 = 
	`bŒfs_ä“_¥aû_æags
(
Ëaf
, 
šfo
);

430 
æags
 &ğ~
BTRFS_FREE_SPACE_USING_BITMAPS
;

431 
	`bŒfs_£t_ä“_¥aû_æags
(
Ëaf
, 
šfo
, 
æags
);

432 
ex³ùed_ex‹Á_couÁ
 = 
	`bŒfs_ä“_¥aû_ex‹Á_couÁ
(
Ëaf
, 
šfo
);

433 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

434 
	`bŒfs_»Ëa£_·th
(
·th
);

436 
Äb™s
 = 
block_group
->
Ëngth
 >> block_group->
fs_šfo
->
£ùÜsize_b™s
;

437 
¡¬t_b™
 = 
	`fšd_Ãxt_b™_Ë
(
b™m­
, 
Äb™s
, 0);

439 
¡¬t_b™
 < 
Äb™s
) {

440 
’d_b™
 = 
	`fšd_Ãxt_z”o_b™_Ë
(
b™m­
, 
Äb™s
, 
¡¬t_b™
);

441 
	`ASSERT
(
¡¬t_b™
 < 
’d_b™
);

443 
key
.
objeùid
 = 
¡¬t
 + 
¡¬t_b™
 * 
block_group
->
fs_šfo
->
£ùÜsize
;

444 
key
.
ty³
 = 
BTRFS_FREE_SPACE_EXTENT_KEY
;

445 
key
.
off£t
 = (
’d_b™
 - 
¡¬t_b™
è* 
block_group
->
fs_šfo
->
£ùÜsize
;

447 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 0);

448 ià(
»t
)

449 
out
;

450 
	`bŒfs_»Ëa£_·th
(
·th
);

452 
ex‹Á_couÁ
++;

454 
¡¬t_b™
 = 
	`fšd_Ãxt_b™_Ë
(
b™m­
, 
Äb™s
, 
’d_b™
);

457 ià(
ex‹Á_couÁ
 !ğ
ex³ùed_ex‹Á_couÁ
) {

458 
	`bŒfs_”r
(
fs_šfo
,

460 
block_group
->
¡¬t
, 
ex‹Á_couÁ
,

461 
ex³ùed_ex‹Á_couÁ
);

462 
	`ASSERT
(0);

463 
»t
 = -
EIO
;

464 
out
;

467 
»t
 = 0;

468 
out
:

469 
	`kvä“
(
b™m­
);

470 ià(
»t
)

471 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

472  
»t
;

473 
	}
}

475 
	$upd©e_ä“_¥aû_ex‹Á_couÁ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

476 
bŒfs_block_group
 *
block_group
,

477 
bŒfs_·th
 *
·th
,

478 
Ãw_ex‹Ás
)

480 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

481 
u32
 
æags
;

482 
u32
 
ex‹Á_couÁ
;

483 
»t
 = 0;

485 ià(
Ãw_ex‹Ás
 == 0)

488 
šfo
 = 
	`£¬ch_ä“_¥aû_šfo
(
Œªs
, 
block_group
, 
·th
, 1);

489 ià(
	`IS_ERR
(
šfo
)) {

490 
»t
 = 
	`PTR_ERR
(
šfo
);

491 
out
;

493 
æags
 = 
	`bŒfs_ä“_¥aû_æags
(
·th
->
nodes
[0], 
šfo
);

494 
ex‹Á_couÁ
 = 
	`bŒfs_ä“_¥aû_ex‹Á_couÁ
(
·th
->
nodes
[0], 
šfo
);

496 
ex‹Á_couÁ
 +ğ
Ãw_ex‹Ás
;

497 
	`bŒfs_£t_ä“_¥aû_ex‹Á_couÁ
(
·th
->
nodes
[0], 
šfo
, 
ex‹Á_couÁ
);

498 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·th
->
nodes
[0]);

499 
	`bŒfs_»Ëa£_·th
(
·th
);

501 ià(!(
æags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) &&

502 
ex‹Á_couÁ
 > 
block_group
->
b™m­_high_th»sh
) {

503 
»t
 = 
	`cÚv”t_ä“_¥aû_to_b™m­s
(
Œªs
, 
block_group
, 
·th
);

504 } ià((
æags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) &&

505 
ex‹Á_couÁ
 < 
block_group
->
b™m­_low_th»sh
) {

506 
»t
 = 
	`cÚv”t_ä“_¥aû_to_ex‹Ás
(
Œªs
, 
block_group
, 
·th
);

509 
out
:

510  
»t
;

511 
	}
}

513 
EXPORT_FOR_TESTS


514 
	$ä“_¥aû_‹¡_b™
(
bŒfs_block_group
 *
block_group
,

515 
bŒfs_·th
 *
·th
, 
u64
 
off£t
)

517 
ex‹Á_bufãr
 *
Ëaf
;

518 
bŒfs_key
 
key
;

519 
u64
 
found_¡¬t
, 
found_’d
;

520 
±r
, 
i
;

522 
Ëaf
 = 
·th
->
nodes
[0];

523 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

524 
	`ASSERT
(
key
.
ty³
 =ğ
BTRFS_FREE_SPACE_BITMAP_KEY
);

526 
found_¡¬t
 = 
key
.
objeùid
;

527 
found_’d
 = 
key
.
objeùid
 + key.
off£t
;

528 
	`ASSERT
(
off£t
 >ğ
found_¡¬t
 && off£ˆ< 
found_’d
);

530 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

531 
i
 = 
	`div_u64
(
off£t
 - 
found_¡¬t
,

532 
block_group
->
fs_šfo
->
£ùÜsize
);

533  !!
	`ex‹Á_bufãr_‹¡_b™
(
Ëaf
, 
±r
, 
i
);

534 
	}
}

536 
	$ä“_¥aû_£t_b™s
(
bŒfs_Œªs_hªdË
 *
Œªs
,

537 
bŒfs_block_group
 *
block_group
,

538 
bŒfs_·th
 *
·th
, 
u64
 *
¡¬t
, u64 *
size
,

539 
b™
)

541 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

542 
ex‹Á_bufãr
 *
Ëaf
;

543 
bŒfs_key
 
key
;

544 
u64
 
’d
 = *
¡¬t
 + *
size
;

545 
u64
 
found_¡¬t
, 
found_’d
;

546 
±r
, 
fœ¡
, 
Ï¡
;

548 
Ëaf
 = 
·th
->
nodes
[0];

549 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

550 
	`ASSERT
(
key
.
ty³
 =ğ
BTRFS_FREE_SPACE_BITMAP_KEY
);

552 
found_¡¬t
 = 
key
.
objeùid
;

553 
found_’d
 = 
key
.
objeùid
 + key.
off£t
;

554 
	`ASSERT
(*
¡¬t
 >ğ
found_¡¬t
 && *¡¬ˆ< 
found_’d
);

555 
	`ASSERT
(
’d
 > 
found_¡¬t
);

557 ià(
’d
 > 
found_’d
)

558 
’d
 = 
found_’d
;

560 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

561 
fœ¡
 = (*
¡¬t
 - 
found_¡¬t
è>> 
fs_šfo
->
£ùÜsize_b™s
;

562 
Ï¡
 = (
’d
 - 
found_¡¬t
è>> 
fs_šfo
->
£ùÜsize_b™s
;

563 ià(
b™
)

564 
	`ex‹Á_bufãr_b™m­_£t
(
Ëaf
, 
±r
, 
fœ¡
, 
Ï¡
 - first);

566 
	`ex‹Á_bufãr_b™m­_ş—r
(
Ëaf
, 
±r
, 
fœ¡
, 
Ï¡
 - first);

567 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

569 *
size
 -ğ
’d
 - *
¡¬t
;

570 *
¡¬t
 = 
’d
;

571 
	}
}

579 
	$ä“_¥aû_Ãxt_b™m­
(
bŒfs_Œªs_hªdË
 *
Œªs
,

580 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
p
)

582 
bŒfs_key
 
key
;

584 ià(
p
->
¦Ùs
[0] + 1 < 
	`bŒfs_h—d”_Ä™ems
Õ->
nodes
[0])) {

585 
p
->
¦Ùs
[0]++;

589 
	`bŒfs_™em_key_to_ıu
(
p
->
nodes
[0], &
key
,…->
¦Ùs
[0]);

590 
	`bŒfs_»Ëa£_·th
(
p
);

592 
key
.
objeùid
 +ğkey.
off£t
;

593 
key
.
ty³
 = (
u8
)-1;

594 
key
.
off£t
 = (
u64
)-1;

596  
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
p
, 0, 1);

597 
	}
}

604 
	$modify_ä“_¥aû_b™m­
(
bŒfs_Œªs_hªdË
 *
Œªs
,

605 
bŒfs_block_group
 *
block_group
,

606 
bŒfs_·th
 *
·th
,

607 
u64
 
¡¬t
, u64 
size
, 
»move
)

609 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_ä“_¥aû_roÙ
(
block_group
);

610 
bŒfs_key
 
key
;

611 
u64
 
’d
 = 
¡¬t
 + 
size
;

612 
u64
 
cur_¡¬t
, 
cur_size
;

613 
´ev_b™
, 
Ãxt_b™
;

614 
Ãw_ex‹Ás
;

615 
»t
;

621 ià(
¡¬t
 > 
block_group
->start) {

622 
u64
 
´ev_block
 = 
¡¬t
 - 
block_group
->
fs_šfo
->
£ùÜsize
;

624 
key
.
objeùid
 = 
´ev_block
;

625 
key
.
ty³
 = (
u8
)-1;

626 
key
.
off£t
 = (
u64
)-1;

628 
»t
 = 
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

629 ià(
»t
)

630 
out
;

632 
´ev_b™
 = 
	`ä“_¥aû_‹¡_b™
(
block_group
, 
·th
, 
´ev_block
);

635 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

636 ià(
¡¬t
 >ğ
key
.
objeùid
 + key.
off£t
) {

637 
»t
 = 
	`ä“_¥aû_Ãxt_b™m­
(
Œªs
, 
roÙ
, 
·th
);

638 ià(
»t
)

639 
out
;

642 
key
.
objeùid
 = 
¡¬t
;

643 
key
.
ty³
 = (
u8
)-1;

644 
key
.
off£t
 = (
u64
)-1;

646 
»t
 = 
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

647 ià(
»t
)

648 
out
;

650 
´ev_b™
 = -1;

657 
cur_¡¬t
 = 
¡¬t
;

658 
cur_size
 = 
size
;

660 
	`ä“_¥aû_£t_b™s
(
Œªs
, 
block_group
, 
·th
, &
cur_¡¬t
, &
cur_size
,

661 !
»move
);

662 ià(
cur_size
 == 0)

664 
»t
 = 
	`ä“_¥aû_Ãxt_b™m­
(
Œªs
, 
roÙ
, 
·th
);

665 ià(
»t
)

666 
out
;

673 ià(
’d
 < 
block_group
->
¡¬t
 + block_group->
Ëngth
) {

675 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

676 ià(
’d
 >ğ
key
.
objeùid
 + key.
off£t
) {

677 
»t
 = 
	`ä“_¥aû_Ãxt_b™m­
(
Œªs
, 
roÙ
, 
·th
);

678 ià(
»t
)

679 
out
;

682 
Ãxt_b™
 = 
	`ä“_¥aû_‹¡_b™
(
block_group
, 
·th
, 
’d
);

684 
Ãxt_b™
 = -1;

687 ià(
»move
) {

688 
Ãw_ex‹Ás
 = -1;

689 ià(
´ev_b™
 == 1) {

691 
Ãw_ex‹Ás
++;

693 ià(
Ãxt_b™
 == 1) {

695 
Ãw_ex‹Ás
++;

698 
Ãw_ex‹Ás
 = 1;

699 ià(
´ev_b™
 == 1) {

701 
Ãw_ex‹Ás
--;

703 ià(
Ãxt_b™
 == 1) {

705 
Ãw_ex‹Ás
--;

709 
	`bŒfs_»Ëa£_·th
(
·th
);

710 
»t
 = 
	`upd©e_ä“_¥aû_ex‹Á_couÁ
(
Œªs
, 
block_group
, 
·th
,

711 
Ãw_ex‹Ás
);

713 
out
:

714  
»t
;

715 
	}
}

717 
	$»move_ä“_¥aû_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

718 
bŒfs_block_group
 *
block_group
,

719 
bŒfs_·th
 *
·th
,

720 
u64
 
¡¬t
, u64 
size
)

722 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_ä“_¥aû_roÙ
(
block_group
);

723 
bŒfs_key
 
key
;

724 
u64
 
found_¡¬t
, 
found_’d
;

725 
u64
 
’d
 = 
¡¬t
 + 
size
;

726 
Ãw_ex‹Ás
 = -1;

727 
»t
;

729 
key
.
objeùid
 = 
¡¬t
;

730 
key
.
ty³
 = (
u8
)-1;

731 
key
.
off£t
 = (
u64
)-1;

733 
»t
 = 
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

734 ià(
»t
)

735 
out
;

737 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

739 
	`ASSERT
(
key
.
ty³
 =ğ
BTRFS_FREE_SPACE_EXTENT_KEY
);

741 
found_¡¬t
 = 
key
.
objeùid
;

742 
found_’d
 = 
key
.
objeùid
 + key.
off£t
;

743 
	`ASSERT
(
¡¬t
 >ğ
found_¡¬t
 && 
’d
 <ğ
found_’d
);

765 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

766 ià(
»t
)

767 
out
;

770 ià(
¡¬t
 > 
found_¡¬t
) {

771 
key
.
objeùid
 = 
found_¡¬t
;

772 
key
.
ty³
 = 
BTRFS_FREE_SPACE_EXTENT_KEY
;

773 
key
.
off£t
 = 
¡¬t
 - 
found_¡¬t
;

775 
	`bŒfs_»Ëa£_·th
(
·th
);

776 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 0);

777 ià(
»t
)

778 
out
;

779 
Ãw_ex‹Ás
++;

783 ià(
’d
 < 
found_’d
) {

784 
key
.
objeùid
 = 
’d
;

785 
key
.
ty³
 = 
BTRFS_FREE_SPACE_EXTENT_KEY
;

786 
key
.
off£t
 = 
found_’d
 - 
’d
;

788 
	`bŒfs_»Ëa£_·th
(
·th
);

789 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 0);

790 ià(
»t
)

791 
out
;

792 
Ãw_ex‹Ás
++;

795 
	`bŒfs_»Ëa£_·th
(
·th
);

796 
»t
 = 
	`upd©e_ä“_¥aû_ex‹Á_couÁ
(
Œªs
, 
block_group
, 
·th
,

797 
Ãw_ex‹Ás
);

799 
out
:

800  
»t
;

801 
	}
}

803 
EXPORT_FOR_TESTS


804 
	$__»move_äom_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

805 
bŒfs_block_group
 *
block_group
,

806 
bŒfs_·th
 *
·th
, 
u64
 
¡¬t
, u64 
size
)

808 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

809 
u32
 
æags
;

810 
»t
;

812 ià(
	`‹¡_b™
(
BLOCK_GROUP_FLAG_NEEDS_FREE_SPACE
, &
block_group
->
ruÁime_æags
)) {

813 
»t
 = 
	`__add_block_group_ä“_¥aû
(
Œªs
, 
block_group
, 
·th
);

814 ià(
»t
)

815  
»t
;

818 
šfo
 = 
	`£¬ch_ä“_¥aû_šfo
(
NULL
, 
block_group
, 
·th
, 0);

819 ià(
	`IS_ERR
(
šfo
))

820  
	`PTR_ERR
(
šfo
);

821 
æags
 = 
	`bŒfs_ä“_¥aû_æags
(
·th
->
nodes
[0], 
šfo
);

822 
	`bŒfs_»Ëa£_·th
(
·th
);

824 ià(
æags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) {

825  
	`modify_ä“_¥aû_b™m­
(
Œªs
, 
block_group
, 
·th
,

826 
¡¬t
, 
size
, 1);

828  
	`»move_ä“_¥aû_ex‹Á
(
Œªs
, 
block_group
, 
·th
,

829 
¡¬t
, 
size
);

831 
	}
}

833 
	$»move_äom_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

834 
u64
 
¡¬t
, u64 
size
)

836 
bŒfs_block_group
 *
block_group
;

837 
bŒfs_·th
 *
·th
;

838 
»t
;

840 ià(!
	`bŒfs_fs_com·t_ro
(
Œªs
->
fs_šfo
, 
FREE_SPACE_TREE
))

843 
·th
 = 
	`bŒfs_®loc_·th
();

844 ià(!
·th
) {

845 
»t
 = -
ENOMEM
;

846 
out
;

849 
block_group
 = 
	`bŒfs_lookup_block_group
(
Œªs
->
fs_šfo
, 
¡¬t
);

850 ià(!
block_group
) {

851 
	`ASSERT
(0);

852 
»t
 = -
ENOENT
;

853 
out
;

856 
	`mu‹x_lock
(&
block_group
->
ä“_¥aû_lock
);

857 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
block_group
, 
·th
, 
¡¬t
,

858 
size
);

859 
	`mu‹x_uÆock
(&
block_group
->
ä“_¥aû_lock
);

861 
	`bŒfs_put_block_group
(
block_group
);

862 
out
:

863 
	`bŒfs_ä“_·th
(
·th
);

864 ià(
»t
)

865 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

866  
»t
;

867 
	}
}

869 
	$add_ä“_¥aû_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

870 
bŒfs_block_group
 *
block_group
,

871 
bŒfs_·th
 *
·th
,

872 
u64
 
¡¬t
, u64 
size
)

874 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_ä“_¥aû_roÙ
(
block_group
);

875 
bŒfs_key
 
key
, 
Ãw_key
;

876 
u64
 
found_¡¬t
, 
found_’d
;

877 
u64
 
’d
 = 
¡¬t
 + 
size
;

878 
Ãw_ex‹Ás
 = 1;

879 
»t
;

899 
Ãw_key
.
objeùid
 = 
¡¬t
;

900 
Ãw_key
.
ty³
 = 
BTRFS_FREE_SPACE_EXTENT_KEY
;

901 
Ãw_key
.
off£t
 = 
size
;

904 ià(
¡¬t
 =ğ
block_group
->start)

905 
right
;

906 
key
.
objeùid
 = 
¡¬t
 - 1;

907 
key
.
ty³
 = (
u8
)-1;

908 
key
.
off£t
 = (
u64
)-1;

910 
»t
 = 
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

911 ià(
»t
)

912 
out
;

914 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

916 ià(
key
.
ty³
 !ğ
BTRFS_FREE_SPACE_EXTENT_KEY
) {

917 
	`ASSERT
(
key
.
ty³
 =ğ
BTRFS_FREE_SPACE_INFO_KEY
);

918 
	`bŒfs_»Ëa£_·th
(
·th
);

919 
right
;

922 
found_¡¬t
 = 
key
.
objeùid
;

923 
found_’d
 = 
key
.
objeùid
 + key.
off£t
;

924 
	`ASSERT
(
found_¡¬t
 >ğ
block_group
->
¡¬t
 &&

925 
found_’d
 > 
block_group
->
¡¬t
);

926 
	`ASSERT
(
found_¡¬t
 < 
¡¬t
 && 
found_’d
 <= start);

932 ià(
found_’d
 =ğ
¡¬t
) {

933 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

934 ià(
»t
)

935 
out
;

936 
Ãw_key
.
objeùid
 = 
found_¡¬t
;

937 
Ãw_key
.
off£t
 +ğ
key
.offset;

938 
Ãw_ex‹Ás
--;

940 
	`bŒfs_»Ëa£_·th
(
·th
);

942 
right
:

944 ià(
’d
 =ğ
block_group
->
¡¬t
 + block_group->
Ëngth
)

945 
š£¹
;

946 
key
.
objeùid
 = 
’d
;

947 
key
.
ty³
 = (
u8
)-1;

948 
key
.
off£t
 = (
u64
)-1;

950 
»t
 = 
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

951 ià(
»t
)

952 
out
;

954 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

956 ià(
key
.
ty³
 !ğ
BTRFS_FREE_SPACE_EXTENT_KEY
) {

957 
	`ASSERT
(
key
.
ty³
 =ğ
BTRFS_FREE_SPACE_INFO_KEY
);

958 
	`bŒfs_»Ëa£_·th
(
·th
);

959 
š£¹
;

962 
found_¡¬t
 = 
key
.
objeùid
;

963 
found_’d
 = 
key
.
objeùid
 + key.
off£t
;

964 
	`ASSERT
(
found_¡¬t
 >ğ
block_group
->
¡¬t
 &&

965 
found_’d
 > 
block_group
->
¡¬t
);

966 
	`ASSERT
((
found_¡¬t
 < 
¡¬t
 && 
found_’d
 <= start) ||

967 (
found_¡¬t
 >ğ
’d
 && 
found_’d
 >ƒnd));

973 ià(
found_¡¬t
 =ğ
’d
) {

974 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

975 ià(
»t
)

976 
out
;

977 
Ãw_key
.
off£t
 +ğ
key
.offset;

978 
Ãw_ex‹Ás
--;

980 
	`bŒfs_»Ëa£_·th
(
·th
);

982 
š£¹
:

984 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
Ãw_key
, 0);

985 ià(
»t
)

986 
out
;

988 
	`bŒfs_»Ëa£_·th
(
·th
);

989 
»t
 = 
	`upd©e_ä“_¥aû_ex‹Á_couÁ
(
Œªs
, 
block_group
, 
·th
,

990 
Ãw_ex‹Ás
);

992 
out
:

993  
»t
;

994 
	}
}

996 
EXPORT_FOR_TESTS


997 
	$__add_to_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

998 
bŒfs_block_group
 *
block_group
,

999 
bŒfs_·th
 *
·th
, 
u64
 
¡¬t
, u64 
size
)

1001 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

1002 
u32
 
æags
;

1003 
»t
;

1005 ià(
	`‹¡_b™
(
BLOCK_GROUP_FLAG_NEEDS_FREE_SPACE
, &
block_group
->
ruÁime_æags
)) {

1006 
»t
 = 
	`__add_block_group_ä“_¥aû
(
Œªs
, 
block_group
, 
·th
);

1007 ià(
»t
)

1008  
»t
;

1011 
šfo
 = 
	`£¬ch_ä“_¥aû_šfo
(
NULL
, 
block_group
, 
·th
, 0);

1012 ià(
	`IS_ERR
(
šfo
))

1013  
	`PTR_ERR
(
šfo
);

1014 
æags
 = 
	`bŒfs_ä“_¥aû_æags
(
·th
->
nodes
[0], 
šfo
);

1015 
	`bŒfs_»Ëa£_·th
(
·th
);

1017 ià(
æags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) {

1018  
	`modify_ä“_¥aû_b™m­
(
Œªs
, 
block_group
, 
·th
,

1019 
¡¬t
, 
size
, 0);

1021  
	`add_ä“_¥aû_ex‹Á
(
Œªs
, 
block_group
, 
·th
, 
¡¬t
,

1022 
size
);

1024 
	}
}

1026 
	$add_to_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1027 
u64
 
¡¬t
, u64 
size
)

1029 
bŒfs_block_group
 *
block_group
;

1030 
bŒfs_·th
 *
·th
;

1031 
»t
;

1033 ià(!
	`bŒfs_fs_com·t_ro
(
Œªs
->
fs_šfo
, 
FREE_SPACE_TREE
))

1036 
·th
 = 
	`bŒfs_®loc_·th
();

1037 ià(!
·th
) {

1038 
»t
 = -
ENOMEM
;

1039 
out
;

1042 
block_group
 = 
	`bŒfs_lookup_block_group
(
Œªs
->
fs_šfo
, 
¡¬t
);

1043 ià(!
block_group
) {

1044 
	`ASSERT
(0);

1045 
»t
 = -
ENOENT
;

1046 
out
;

1049 
	`mu‹x_lock
(&
block_group
->
ä“_¥aû_lock
);

1050 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
block_group
, 
·th
, 
¡¬t
, 
size
);

1051 
	`mu‹x_uÆock
(&
block_group
->
ä“_¥aû_lock
);

1053 
	`bŒfs_put_block_group
(
block_group
);

1054 
out
:

1055 
	`bŒfs_ä“_·th
(
·th
);

1056 ià(
»t
)

1057 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1058  
»t
;

1059 
	}
}

1066 
	$pİuÏ‹_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1067 
bŒfs_block_group
 *
block_group
)

1069 
bŒfs_roÙ
 *
ex‹Á_roÙ
;

1070 
bŒfs_·th
 *
·th
, *
·th2
;

1071 
bŒfs_key
 
key
;

1072 
u64
 
¡¬t
, 
’d
;

1073 
»t
;

1075 
·th
 = 
	`bŒfs_®loc_·th
();

1076 ià(!
·th
)

1077  -
ENOMEM
;

1078 
·th
->
»ada
 = 
READA_FORWARD
;

1080 
·th2
 = 
	`bŒfs_®loc_·th
();

1081 ià(!
·th2
) {

1082 
	`bŒfs_ä“_·th
(
·th
);

1083  -
ENOMEM
;

1086 
»t
 = 
	`add_Ãw_ä“_¥aû_šfo
(
Œªs
, 
block_group
, 
·th2
);

1087 ià(
»t
)

1088 
out
;

1090 
	`mu‹x_lock
(&
block_group
->
ä“_¥aû_lock
);

1099 
key
.
objeùid
 = 
block_group
->
¡¬t
;

1100 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

1101 
key
.
off£t
 = 0;

1103 
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
Œªs
->
fs_šfo
, 
key
.
objeùid
);

1104 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
ex‹Á_roÙ
, &
key
, 
·th
, 1, 0);

1105 ià(
»t
 < 0)

1106 
out_locked
;

1107 
	`ASSERT
(
»t
 == 0);

1109 
¡¬t
 = 
block_group
->start;

1110 
’d
 = 
block_group
->
¡¬t
 + block_group->
Ëngth
;

1112 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

1114 ià(
key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 ||

1115 
key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
) {

1116 ià(
key
.
objeùid
 >ğ
’d
)

1119 ià(
¡¬t
 < 
key
.
objeùid
) {

1120 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
,

1121 
block_group
,

1122 
·th2
, 
¡¬t
,

1123 
key
.
objeùid
 -

1124 
¡¬t
);

1125 ià(
»t
)

1126 
out_locked
;

1128 
¡¬t
 = 
key
.
objeùid
;

1129 ià(
key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
)

1130 
¡¬t
 +ğ
Œªs
->
fs_šfo
->
nodesize
;

1132 
¡¬t
 +ğ
key
.
off£t
;

1133 } ià(
key
.
ty³
 =ğ
BTRFS_BLOCK_GROUP_ITEM_KEY
) {

1134 ià(
key
.
objeùid
 !ğ
block_group
->
¡¬t
)

1138 
»t
 = 
	`bŒfs_Ãxt_™em
(
ex‹Á_roÙ
, 
·th
);

1139 ià(
»t
 < 0)

1140 
out_locked
;

1141 ià(
»t
)

1144 ià(
¡¬t
 < 
’d
) {

1145 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
block_group
, 
·th2
,

1146 
¡¬t
, 
’d
 - start);

1147 ià(
»t
)

1148 
out_locked
;

1151 
»t
 = 0;

1152 
out_locked
:

1153 
	`mu‹x_uÆock
(&
block_group
->
ä“_¥aû_lock
);

1154 
out
:

1155 
	`bŒfs_ä“_·th
(
·th2
);

1156 
	`bŒfs_ä“_·th
(
·th
);

1157  
»t
;

1158 
	}
}

1160 
	$bŒfs_ü—‹_ä“_¥aû_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
)

1162 
bŒfs_Œªs_hªdË
 *
Œªs
;

1163 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

1164 
bŒfs_roÙ
 *
ä“_¥aû_roÙ
;

1165 
bŒfs_block_group
 *
block_group
;

1166 
rb_node
 *
node
;

1167 
»t
;

1169 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
Œ“_roÙ
, 0);

1170 ià(
	`IS_ERR
(
Œªs
))

1171  
	`PTR_ERR
(
Œªs
);

1173 
	`£t_b™
(
BTRFS_FS_CREATING_FREE_SPACE_TREE
, &
fs_šfo
->
æags
);

1174 
	`£t_b™
(
BTRFS_FS_FREE_SPACE_TREE_UNTRUSTED
, &
fs_šfo
->
æags
);

1175 
ä“_¥aû_roÙ
 = 
	`bŒfs_ü—‹_Œ“
(
Œªs
,

1176 
BTRFS_FREE_SPACE_TREE_OBJECTID
);

1177 ià(
	`IS_ERR
(
ä“_¥aû_roÙ
)) {

1178 
»t
 = 
	`PTR_ERR
(
ä“_¥aû_roÙ
);

1179 
abÜt
;

1181 
»t
 = 
	`bŒfs_glob®_roÙ_š£¹
(
ä“_¥aû_roÙ
);

1182 ià(
»t
) {

1183 
	`bŒfs_put_roÙ
(
ä“_¥aû_roÙ
);

1184 
abÜt
;

1187 
node
 = 
	`rb_fœ¡_ÿched
(&
fs_šfo
->
block_group_ÿche_Œ“
);

1188 
node
) {

1189 
block_group
 = 
	`rb_’Œy
(
node
, 
bŒfs_block_group
,

1190 
ÿche_node
);

1191 
»t
 = 
	`pİuÏ‹_ä“_¥aû_Œ“
(
Œªs
, 
block_group
);

1192 ià(
»t
)

1193 
abÜt
;

1194 
node
 = 
	`rb_Ãxt
(node);

1197 
	`bŒfs_£t_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
);

1198 
	`bŒfs_£t_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE_VALID
);

1199 
	`ş—r_b™
(
BTRFS_FS_CREATING_FREE_SPACE_TREE
, &
fs_šfo
->
æags
);

1200 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1206 
	`ş—r_b™
(
BTRFS_FS_FREE_SPACE_TREE_UNTRUSTED
, &
fs_šfo
->
æags
);

1207  
»t
;

1209 
abÜt
:

1210 
	`ş—r_b™
(
BTRFS_FS_CREATING_FREE_SPACE_TREE
, &
fs_šfo
->
æags
);

1211 
	`ş—r_b™
(
BTRFS_FS_FREE_SPACE_TREE_UNTRUSTED
, &
fs_šfo
->
æags
);

1212 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1213 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1214  
»t
;

1215 
	}
}

1217 
	$ş—r_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1218 
bŒfs_roÙ
 *
roÙ
)

1220 
bŒfs_·th
 *
·th
;

1221 
bŒfs_key
 
key
;

1222 
Ä
;

1223 
»t
;

1225 
·th
 = 
	`bŒfs_®loc_·th
();

1226 ià(!
·th
)

1227  -
ENOMEM
;

1229 
key
.
objeùid
 = 0;

1230 
key
.
ty³
 = 0;

1231 
key
.
off£t
 = 0;

1234 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1235 ià(
»t
 < 0)

1236 
out
;

1238 
Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

1239 ià(!
Ä
)

1242 
·th
->
¦Ùs
[0] = 0;

1243 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
, 0, 
Ä
);

1244 ià(
»t
)

1245 
out
;

1247 
	`bŒfs_»Ëa£_·th
(
·th
);

1250 
»t
 = 0;

1251 
out
:

1252 
	`bŒfs_ä“_·th
(
·th
);

1253  
»t
;

1254 
	}
}

1256 
	$bŒfs_d–‘e_ä“_¥aû_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
)

1258 
bŒfs_Œªs_hªdË
 *
Œªs
;

1259 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

1260 
bŒfs_key
 
key
 = {

1261 .
objeùid
 = 
BTRFS_FREE_SPACE_TREE_OBJECTID
,

1262 .
ty³
 = 
BTRFS_ROOT_ITEM_KEY
,

1263 .
off£t
 = 0,

1265 
bŒfs_roÙ
 *
ä“_¥aû_roÙ
 = 
	`bŒfs_glob®_roÙ
(
fs_šfo
, &
key
);

1266 
»t
;

1268 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
Œ“_roÙ
, 0);

1269 ià(
	`IS_ERR
(
Œªs
))

1270  
	`PTR_ERR
(
Œªs
);

1272 
	`bŒfs_ş—r_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
);

1273 
	`bŒfs_ş—r_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE_VALID
);

1275 
»t
 = 
	`ş—r_ä“_¥aû_Œ“
(
Œªs
, 
ä“_¥aû_roÙ
);

1276 ià(
»t
)

1277 
abÜt
;

1279 
»t
 = 
	`bŒfs_d–_roÙ
(
Œªs
, &
ä“_¥aû_roÙ
->
roÙ_key
);

1280 ià(
»t
)

1281 
abÜt
;

1283 
	`bŒfs_glob®_roÙ_d–‘e
(
ä“_¥aû_roÙ
);

1285 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

1286 
	`li¡_d–
(&
ä“_¥aû_roÙ
->
dœty_li¡
);

1287 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1289 
	`bŒfs_Œ“_lock
(
ä“_¥aû_roÙ
->
node
);

1290 
	`bŒfs_ş—r_bufãr_dœty
(
Œªs
, 
ä“_¥aû_roÙ
->
node
);

1291 
	`bŒfs_Œ“_uÆock
(
ä“_¥aû_roÙ
->
node
);

1292 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
	`bŒfs_roÙ_id
(
ä“_¥aû_roÙ
),

1293 
ä“_¥aû_roÙ
->
node
, 0, 1);

1295 
	`bŒfs_put_roÙ
(
ä“_¥aû_roÙ
);

1297  
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1299 
abÜt
:

1300 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1301 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1302  
»t
;

1303 
	}
}

1305 
	$bŒfs_»bud_ä“_¥aû_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
)

1307 
bŒfs_Œªs_hªdË
 *
Œªs
;

1308 
bŒfs_key
 
key
 = {

1309 .
objeùid
 = 
BTRFS_FREE_SPACE_TREE_OBJECTID
,

1310 .
ty³
 = 
BTRFS_ROOT_ITEM_KEY
,

1311 .
off£t
 = 0,

1313 
bŒfs_roÙ
 *
ä“_¥aû_roÙ
 = 
	`bŒfs_glob®_roÙ
(
fs_šfo
, &
key
);

1314 
rb_node
 *
node
;

1315 
»t
;

1317 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
ä“_¥aû_roÙ
, 1);

1318 ià(
	`IS_ERR
(
Œªs
))

1319  
	`PTR_ERR
(
Œªs
);

1321 
	`£t_b™
(
BTRFS_FS_CREATING_FREE_SPACE_TREE
, &
fs_šfo
->
æags
);

1322 
	`£t_b™
(
BTRFS_FS_FREE_SPACE_TREE_UNTRUSTED
, &
fs_šfo
->
æags
);

1324 
»t
 = 
	`ş—r_ä“_¥aû_Œ“
(
Œªs
, 
ä“_¥aû_roÙ
);

1325 ià(
»t
)

1326 
abÜt
;

1328 
node
 = 
	`rb_fœ¡_ÿched
(&
fs_šfo
->
block_group_ÿche_Œ“
);

1329 
node
) {

1330 
bŒfs_block_group
 *
block_group
;

1332 
block_group
 = 
	`rb_’Œy
(
node
, 
bŒfs_block_group
,

1333 
ÿche_node
);

1334 
»t
 = 
	`pİuÏ‹_ä“_¥aû_Œ“
(
Œªs
, 
block_group
);

1335 ià(
»t
)

1336 
abÜt
;

1337 
node
 = 
	`rb_Ãxt
(node);

1340 
	`bŒfs_£t_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
);

1341 
	`bŒfs_£t_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE_VALID
);

1342 
	`ş—r_b™
(
BTRFS_FS_CREATING_FREE_SPACE_TREE
, &
fs_šfo
->
æags
);

1344 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1345 
	`ş—r_b™
(
BTRFS_FS_FREE_SPACE_TREE_UNTRUSTED
, &
fs_šfo
->
æags
);

1346  
»t
;

1347 
abÜt
:

1348 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1349 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1350  
»t
;

1351 
	}
}

1353 
	$__add_block_group_ä“_¥aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1354 
bŒfs_block_group
 *
block_group
,

1355 
bŒfs_·th
 *
·th
)

1357 
»t
;

1359 
	`ş—r_b™
(
BLOCK_GROUP_FLAG_NEEDS_FREE_SPACE
, &
block_group
->
ruÁime_æags
);

1361 
»t
 = 
	`add_Ãw_ä“_¥aû_šfo
(
Œªs
, 
block_group
, 
·th
);

1362 ià(
»t
)

1363  
»t
;

1365  
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
block_group
, 
·th
,

1366 
block_group
->
¡¬t
,

1367 
block_group
->
Ëngth
);

1368 
	}
}

1370 
	$add_block_group_ä“_¥aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1371 
bŒfs_block_group
 *
block_group
)

1373 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1374 
bŒfs_·th
 *
·th
 = 
NULL
;

1375 
»t
 = 0;

1377 ià(!
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
))

1380 
	`mu‹x_lock
(&
block_group
->
ä“_¥aû_lock
);

1381 ià(!
	`‹¡_b™
(
BLOCK_GROUP_FLAG_NEEDS_FREE_SPACE
, &
block_group
->
ruÁime_æags
))

1382 
out
;

1384 
·th
 = 
	`bŒfs_®loc_·th
();

1385 ià(!
·th
) {

1386 
»t
 = -
ENOMEM
;

1387 
out
;

1390 
»t
 = 
	`__add_block_group_ä“_¥aû
(
Œªs
, 
block_group
, 
·th
);

1392 
out
:

1393 
	`bŒfs_ä“_·th
(
·th
);

1394 
	`mu‹x_uÆock
(&
block_group
->
ä“_¥aû_lock
);

1395 ià(
»t
)

1396 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1397  
»t
;

1398 
	}
}

1400 
	$»move_block_group_ä“_¥aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1401 
bŒfs_block_group
 *
block_group
)

1403 
bŒfs_roÙ
 *
roÙ
 = 
	`bŒfs_ä“_¥aû_roÙ
(
block_group
);

1404 
bŒfs_·th
 *
·th
;

1405 
bŒfs_key
 
key
, 
found_key
;

1406 
ex‹Á_bufãr
 *
Ëaf
;

1407 
u64
 
¡¬t
, 
’d
;

1408 
dÚe
 = 0, 
Ä
;

1409 
»t
;

1411 ià(!
	`bŒfs_fs_com·t_ro
(
Œªs
->
fs_šfo
, 
FREE_SPACE_TREE
))

1414 ià(
	`‹¡_b™
(
BLOCK_GROUP_FLAG_NEEDS_FREE_SPACE
, &
block_group
->
ruÁime_æags
)) {

1419 
·th
 = 
	`bŒfs_®loc_·th
();

1420 ià(!
·th
) {

1421 
»t
 = -
ENOMEM
;

1422 
out
;

1425 
¡¬t
 = 
block_group
->start;

1426 
’d
 = 
block_group
->
¡¬t
 + block_group->
Ëngth
;

1428 
key
.
objeùid
 = 
’d
 - 1;

1429 
key
.
ty³
 = (
u8
)-1;

1430 
key
.
off£t
 = (
u64
)-1;

1432 !
dÚe
) {

1433 
»t
 = 
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1434 ià(
»t
)

1435 
out
;

1437 
Ëaf
 = 
·th
->
nodes
[0];

1438 
Ä
 = 0;

1439 
·th
->
¦Ùs
[0]++;

1440 
·th
->
¦Ùs
[0] > 0) {

1441 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0] - 1);

1443 ià(
found_key
.
ty³
 =ğ
BTRFS_FREE_SPACE_INFO_KEY
) {

1444 
	`ASSERT
(
found_key
.
objeùid
 =ğ
block_group
->
¡¬t
);

1445 
	`ASSERT
(
found_key
.
off£t
 =ğ
block_group
->
Ëngth
);

1446 
dÚe
 = 1;

1447 
Ä
++;

1448 
·th
->
¦Ùs
[0]--;

1450 } ià(
found_key
.
ty³
 =ğ
BTRFS_FREE_SPACE_EXTENT_KEY
 ||

1451 
found_key
.
ty³
 =ğ
BTRFS_FREE_SPACE_BITMAP_KEY
) {

1452 
	`ASSERT
(
found_key
.
objeùid
 >ğ
¡¬t
);

1453 
	`ASSERT
(
found_key
.
objeùid
 < 
’d
);

1454 
	`ASSERT
(
found_key
.
objeùid
 + found_key.
off£t
 <ğ
’d
);

1455 
Ä
++;

1456 
·th
->
¦Ùs
[0]--;

1458 
	`ASSERT
(0);

1462 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
,…©h->
¦Ùs
[0], 
Ä
);

1463 ià(
»t
)

1464 
out
;

1465 
	`bŒfs_»Ëa£_·th
(
·th
);

1468 
»t
 = 0;

1469 
out
:

1470 
	`bŒfs_ä“_·th
(
·th
);

1471 ià(
»t
)

1472 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1473  
»t
;

1474 
	}
}

1476 
	$lßd_ä“_¥aû_b™m­s
(
bŒfs_ÿchšg_cÚŒŞ
 *
ÿchšg_ùl
,

1477 
bŒfs_·th
 *
·th
,

1478 
u32
 
ex³ùed_ex‹Á_couÁ
)

1480 
bŒfs_block_group
 *
block_group
;

1481 
bŒfs_fs_šfo
 *
fs_šfo
;

1482 
bŒfs_roÙ
 *
roÙ
;

1483 
bŒfs_key
 
key
;

1484 
´ev_b™
 = 0, 
b™
;

1486 
u64
 
ex‹Á_¡¬t
 = 0;

1487 
u64
 
’d
, 
off£t
;

1488 
u64
 
tÙ®_found
 = 0;

1489 
u32
 
ex‹Á_couÁ
 = 0;

1490 
»t
;

1492 
block_group
 = 
ÿchšg_ùl
->block_group;

1493 
fs_šfo
 = 
block_group
->fs_info;

1494 
roÙ
 = 
	`bŒfs_ä“_¥aû_roÙ
(
block_group
);

1496 
’d
 = 
block_group
->
¡¬t
 + block_group->
Ëngth
;

1499 
»t
 = 
	`bŒfs_Ãxt_™em
(
roÙ
, 
·th
);

1500 ià(
»t
 < 0)

1501 
out
;

1502 ià(
»t
)

1505 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

1507 ià(
key
.
ty³
 =ğ
BTRFS_FREE_SPACE_INFO_KEY
)

1510 
	`ASSERT
(
key
.
ty³
 =ğ
BTRFS_FREE_SPACE_BITMAP_KEY
);

1511 
	`ASSERT
(
key
.
objeùid
 < 
’d
 && key.objeùid + key.
off£t
 <=ƒnd);

1513 
off£t
 = 
key
.
objeùid
;

1514 
off£t
 < 
key
.
objeùid
 + key.offset) {

1515 
b™
 = 
	`ä“_¥aû_‹¡_b™
(
block_group
, 
·th
, 
off£t
);

1516 ià(
´ev_b™
 =ğ0 && 
b™
 == 1) {

1517 
ex‹Á_¡¬t
 = 
off£t
;

1518 } ià(
´ev_b™
 =ğ1 && 
b™
 == 0) {

1519 
u64
 
¥aû_added
;

1521 
»t
 = 
	`bŒfs_add_Ãw_ä“_¥aû
(
block_group
,

1522 
ex‹Á_¡¬t
,

1523 
off£t
,

1524 &
¥aû_added
);

1525 ià(
»t
)

1526 
out
;

1527 
tÙ®_found
 +ğ
¥aû_added
;

1528 ià(
tÙ®_found
 > 
CACHING_CTL_WAKE_UP
) {

1529 
tÙ®_found
 = 0;

1530 
	`wake_up
(&
ÿchšg_ùl
->
wa™
);

1532 
ex‹Á_couÁ
++;

1534 
´ev_b™
 = 
b™
;

1535 
off£t
 +ğ
fs_šfo
->
£ùÜsize
;

1538 ià(
´ev_b™
 == 1) {

1539 
»t
 = 
	`bŒfs_add_Ãw_ä“_¥aû
(
block_group
, 
ex‹Á_¡¬t
, 
’d
, 
NULL
);

1540 ià(
»t
)

1541 
out
;

1542 
ex‹Á_couÁ
++;

1545 ià(
ex‹Á_couÁ
 !ğ
ex³ùed_ex‹Á_couÁ
) {

1546 
	`bŒfs_”r
(
fs_šfo
,

1548 
block_group
->
¡¬t
, 
ex‹Á_couÁ
,

1549 
ex³ùed_ex‹Á_couÁ
);

1550 
	`ASSERT
(0);

1551 
»t
 = -
EIO
;

1552 
out
;

1555 
»t
 = 0;

1556 
out
:

1557  
»t
;

1558 
	}
}

1560 
	$lßd_ä“_¥aû_ex‹Ás
(
bŒfs_ÿchšg_cÚŒŞ
 *
ÿchšg_ùl
,

1561 
bŒfs_·th
 *
·th
,

1562 
u32
 
ex³ùed_ex‹Á_couÁ
)

1564 
bŒfs_block_group
 *
block_group
;

1565 
bŒfs_fs_šfo
 *
fs_šfo
;

1566 
bŒfs_roÙ
 *
roÙ
;

1567 
bŒfs_key
 
key
;

1568 
u64
 
’d
;

1569 
u64
 
tÙ®_found
 = 0;

1570 
u32
 
ex‹Á_couÁ
 = 0;

1571 
»t
;

1573 
block_group
 = 
ÿchšg_ùl
->block_group;

1574 
fs_šfo
 = 
block_group
->fs_info;

1575 
roÙ
 = 
	`bŒfs_ä“_¥aû_roÙ
(
block_group
);

1577 
’d
 = 
block_group
->
¡¬t
 + block_group->
Ëngth
;

1580 
u64
 
¥aû_added
;

1582 
»t
 = 
	`bŒfs_Ãxt_™em
(
roÙ
, 
·th
);

1583 ià(
»t
 < 0)

1584 
out
;

1585 ià(
»t
)

1588 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

1590 ià(
key
.
ty³
 =ğ
BTRFS_FREE_SPACE_INFO_KEY
)

1593 
	`ASSERT
(
key
.
ty³
 =ğ
BTRFS_FREE_SPACE_EXTENT_KEY
);

1594 
	`ASSERT
(
key
.
objeùid
 < 
’d
 && key.objeùid + key.
off£t
 <=ƒnd);

1596 
»t
 = 
	`bŒfs_add_Ãw_ä“_¥aû
(
block_group
, 
key
.
objeùid
,

1597 
key
.
objeùid
 + key.
off£t
,

1598 &
¥aû_added
);

1599 ià(
»t
)

1600 
out
;

1601 
tÙ®_found
 +ğ
¥aû_added
;

1602 ià(
tÙ®_found
 > 
CACHING_CTL_WAKE_UP
) {

1603 
tÙ®_found
 = 0;

1604 
	`wake_up
(&
ÿchšg_ùl
->
wa™
);

1606 
ex‹Á_couÁ
++;

1609 ià(
ex‹Á_couÁ
 !ğ
ex³ùed_ex‹Á_couÁ
) {

1610 
	`bŒfs_”r
(
fs_šfo
,

1612 
block_group
->
¡¬t
, 
ex‹Á_couÁ
,

1613 
ex³ùed_ex‹Á_couÁ
);

1614 
	`ASSERT
(0);

1615 
»t
 = -
EIO
;

1616 
out
;

1619 
»t
 = 0;

1620 
out
:

1621  
»t
;

1622 
	}
}

1624 
	$lßd_ä“_¥aû_Œ“
(
bŒfs_ÿchšg_cÚŒŞ
 *
ÿchšg_ùl
)

1626 
bŒfs_block_group
 *
block_group
;

1627 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

1628 
bŒfs_·th
 *
·th
;

1629 
u32
 
ex‹Á_couÁ
, 
æags
;

1630 
»t
;

1632 
block_group
 = 
ÿchšg_ùl
->block_group;

1634 
·th
 = 
	`bŒfs_®loc_·th
();

1635 ià(!
·th
)

1636  -
ENOMEM
;

1642 
·th
->
sk_lockšg
 = 1;

1643 
·th
->
£¬ch_comm™_roÙ
 = 1;

1644 
·th
->
»ada
 = 
READA_FORWARD
;

1646 
šfo
 = 
	`£¬ch_ä“_¥aû_šfo
(
NULL
, 
block_group
, 
·th
, 0);

1647 ià(
	`IS_ERR
(
šfo
)) {

1648 
»t
 = 
	`PTR_ERR
(
šfo
);

1649 
out
;

1651 
ex‹Á_couÁ
 = 
	`bŒfs_ä“_¥aû_ex‹Á_couÁ
(
·th
->
nodes
[0], 
šfo
);

1652 
æags
 = 
	`bŒfs_ä“_¥aû_æags
(
·th
->
nodes
[0], 
šfo
);

1659 ià(
æags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
)

1660 
»t
 = 
	`lßd_ä“_¥aû_b™m­s
(
ÿchšg_ùl
, 
·th
, 
ex‹Á_couÁ
);

1662 
»t
 = 
	`lßd_ä“_¥aû_ex‹Ás
(
ÿchšg_ùl
, 
·th
, 
ex‹Á_couÁ
);

1664 
out
:

1665 
	`bŒfs_ä“_·th
(
·th
);

1666  
»t
;

1667 
	}
}

	@free-space-tree.h

6 #iâdeà
BTRFS_FREE_SPACE_TREE_H


7 
	#BTRFS_FREE_SPACE_TREE_H


	)

9 
	gbŒfs_ÿchšg_cÚŒŞ
;

16 
	#BTRFS_FREE_SPACE_BITMAP_SIZE
 256

	)

17 
	#BTRFS_FREE_SPACE_BITMAP_BITS
 (
BTRFS_FREE_SPACE_BITMAP_SIZE
 * 
BITS_PER_BYTE
)

	)

19 
£t_ä“_¥aû_Œ“_th»shŞds
(
bŒfs_block_group
 *
block_group
);

20 
bŒfs_ü—‹_ä“_¥aû_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
);

21 
bŒfs_d–‘e_ä“_¥aû_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
);

22 
bŒfs_»bud_ä“_¥aû_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
);

23 
lßd_ä“_¥aû_Œ“
(
bŒfs_ÿchšg_cÚŒŞ
 *
ÿchšg_ùl
);

24 
add_block_group_ä“_¥aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

25 
bŒfs_block_group
 *
block_group
);

26 
»move_block_group_ä“_¥aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

27 
bŒfs_block_group
 *
block_group
);

28 
add_to_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

29 
u64
 
¡¬t
, u64 
size
);

30 
»move_äom_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

31 
u64
 
¡¬t
, u64 
size
);

33 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


34 
bŒfs_ä“_¥aû_šfo
 *

35 
£¬ch_ä“_¥aû_šfo
(
bŒfs_Œªs_hªdË
 *
Œªs
,

36 
bŒfs_block_group
 *
block_group
,

37 
bŒfs_·th
 *
·th
, 
cow
);

38 
__add_to_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

39 
bŒfs_block_group
 *
block_group
,

40 
bŒfs_·th
 *
·th
, 
u64
 
¡¬t
, u64 
size
);

41 
__»move_äom_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

42 
bŒfs_block_group
 *
block_group
,

43 
bŒfs_·th
 *
·th
, 
u64
 
¡¬t
, u64 
size
);

44 
cÚv”t_ä“_¥aû_to_b™m­s
(
bŒfs_Œªs_hªdË
 *
Œªs
,

45 
bŒfs_block_group
 *
block_group
,

46 
bŒfs_·th
 *
·th
);

47 
cÚv”t_ä“_¥aû_to_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

48 
bŒfs_block_group
 *
block_group
,

49 
bŒfs_·th
 *
·th
);

50 
ä“_¥aû_‹¡_b™
(
bŒfs_block_group
 *
block_group
,

51 
bŒfs_·th
 *
·th
, 
u64
 
off£t
);

	@fs.c

3 
	~"mes§ges.h
"

4 
	~"ù»e.h
"

5 
	~"fs.h
"

6 
	~"acûssÜs.h
"

8 
	$__bŒfs_£t_fs_šcom·t
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æag
,

9 cÚ¡ *
Çme
)

11 
bŒfs_su³r_block
 *
disk_su³r
;

12 
u64
 
ã©u»s
;

14 
disk_su³r
 = 
fs_šfo
->
su³r_cİy
;

15 
ã©u»s
 = 
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
);

16 ià(!(
ã©u»s
 & 
æag
)) {

17 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

18 
ã©u»s
 = 
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
);

19 ià(!(
ã©u»s
 & 
æag
)) {

20 
ã©u»s
 |ğ
æag
;

21 
	`bŒfs_£t_su³r_šcom·t_æags
(
disk_su³r
, 
ã©u»s
);

22 
	`bŒfs_šfo
(
fs_šfo
,

24 
Çme
, 
æag
);

26 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

27 
	`£t_b™
(
BTRFS_FS_FEATURE_CHANGED
, &
fs_šfo
->
æags
);

29 
	}
}

31 
	$__bŒfs_ş—r_fs_šcom·t
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æag
,

32 cÚ¡ *
Çme
)

34 
bŒfs_su³r_block
 *
disk_su³r
;

35 
u64
 
ã©u»s
;

37 
disk_su³r
 = 
fs_šfo
->
su³r_cİy
;

38 
ã©u»s
 = 
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
);

39 ià(
ã©u»s
 & 
æag
) {

40 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

41 
ã©u»s
 = 
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
);

42 ià(
ã©u»s
 & 
æag
) {

43 
ã©u»s
 &ğ~
æag
;

44 
	`bŒfs_£t_su³r_šcom·t_æags
(
disk_su³r
, 
ã©u»s
);

45 
	`bŒfs_šfo
(
fs_šfo
,

47 
Çme
, 
æag
);

49 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

50 
	`£t_b™
(
BTRFS_FS_FEATURE_CHANGED
, &
fs_šfo
->
æags
);

52 
	}
}

54 
	$__bŒfs_£t_fs_com·t_ro
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æag
,

55 cÚ¡ *
Çme
)

57 
bŒfs_su³r_block
 *
disk_su³r
;

58 
u64
 
ã©u»s
;

60 
disk_su³r
 = 
fs_šfo
->
su³r_cİy
;

61 
ã©u»s
 = 
	`bŒfs_su³r_com·t_ro_æags
(
disk_su³r
);

62 ià(!(
ã©u»s
 & 
æag
)) {

63 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

64 
ã©u»s
 = 
	`bŒfs_su³r_com·t_ro_æags
(
disk_su³r
);

65 ià(!(
ã©u»s
 & 
æag
)) {

66 
ã©u»s
 |ğ
æag
;

67 
	`bŒfs_£t_su³r_com·t_ro_æags
(
disk_su³r
, 
ã©u»s
);

68 
	`bŒfs_šfo
(
fs_šfo
,

70 
Çme
, 
æag
);

72 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

73 
	`£t_b™
(
BTRFS_FS_FEATURE_CHANGED
, &
fs_šfo
->
æags
);

75 
	}
}

77 
	$__bŒfs_ş—r_fs_com·t_ro
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æag
,

78 cÚ¡ *
Çme
)

80 
bŒfs_su³r_block
 *
disk_su³r
;

81 
u64
 
ã©u»s
;

83 
disk_su³r
 = 
fs_šfo
->
su³r_cİy
;

84 
ã©u»s
 = 
	`bŒfs_su³r_com·t_ro_æags
(
disk_su³r
);

85 ià(
ã©u»s
 & 
æag
) {

86 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

87 
ã©u»s
 = 
	`bŒfs_su³r_com·t_ro_æags
(
disk_su³r
);

88 ià(
ã©u»s
 & 
æag
) {

89 
ã©u»s
 &ğ~
æag
;

90 
	`bŒfs_£t_su³r_com·t_ro_æags
(
disk_su³r
, 
ã©u»s
);

91 
	`bŒfs_šfo
(
fs_šfo
,

93 
Çme
, 
æag
);

95 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

96 
	`£t_b™
(
BTRFS_FS_FEATURE_CHANGED
, &
fs_šfo
->
æags
);

98 
	}
}

	@fs.h

3 #iâdeà
BTRFS_FS_H


4 
	#BTRFS_FS_H


	)

6 
	~<lšux/blkdev.h
>

7 
	~<lšux/fs.h
>

8 
	~<lšux/bŒfs_Œ“.h
>

9 
	~<lšux/sizes.h
>

10 
	~"ex‹Á-io-Œ“.h
"

11 
	~"ex‹Á_m­.h
"

12 
	~"async-th»ad.h
"

13 
	~"block-rsv.h
"

15 
	#BTRFS_MAX_EXTENT_SIZE
 
SZ_128M


	)

17 
	#BTRFS_OLDEST_GENERATION
 0ULL

	)

19 
	#BTRFS_EMPTY_DIR_SIZE
 0

	)

21 
	#BTRFS_DIRTY_METADATA_THRESH
 
SZ_32M


	)

23 
	#BTRFS_SUPER_INFO_OFFSET
 
SZ_64K


	)

24 
	#BTRFS_SUPER_INFO_SIZE
 4096

	)

25 
¡©ic_as£¹
((
bŒfs_su³r_block
è=ğ
BTRFS_SUPER_INFO_SIZE
);

28 
	#BTRFS_SUPER_INFO_OFFSET_1
 (339968)

	)

29 
	#BTRFS_SUPER_INFO_OFFSET_2
 (679936)

	)

30 
	#BTRFS_SUPER_INFO_COUNT
 64

	)

42 
	#BTRFS_UNLINK_METADATA_UNITS
 6

	)

49 
	#BTRFS_DEVICE_RANGE_RESERVED
 (
SZ_1M
)

	)

58 
	mBTRFS_FS_STATE_REMOUNTING
,

60 
	mBTRFS_FS_STATE_RO
,

62 
	mBTRFS_FS_STATE_TRANS_ABORTED
,

67 
	mBTRFS_FS_STATE_DEV_REPLACING
,

69 
	mBTRFS_FS_STATE_DUMMY_FS_INFO
,

71 
	mBTRFS_FS_STATE_NO_CSUMS
,

74 
	mBTRFS_FS_STATE_LOG_CLEANUP_ERROR
,

76 
	mBTRFS_FS_STATE_COUNT


80 
	mBTRFS_FS_CLOSING_START
,

81 
	mBTRFS_FS_CLOSING_DONE
,

82 
	mBTRFS_FS_LOG_RECOVERING
,

83 
	mBTRFS_FS_OPEN
,

84 
	mBTRFS_FS_QUOTA_ENABLED
,

85 
	mBTRFS_FS_UPDATE_UUID_TREE_GEN
,

86 
	mBTRFS_FS_CREATING_FREE_SPACE_TREE
,

87 
	mBTRFS_FS_BTREE_ERR
,

88 
	mBTRFS_FS_LOG1_ERR
,

89 
	mBTRFS_FS_LOG2_ERR
,

90 
	mBTRFS_FS_QUOTA_OVERRIDE
,

92 
	mBTRFS_FS_FROZEN
,

97 
	mBTRFS_FS_BALANCE_RUNNING
,

103 
	mBTRFS_FS_RELOC_RUNNING
,

106 
	mBTRFS_FS_CLEANER_RUNNING
,

112 
	mBTRFS_FS_CSUM_IMPL_FAST
,

115 
	mBTRFS_FS_DISCARD_RUNNING
,

118 
	mBTRFS_FS_CLEANUP_SPACE_CACHE_V1
,

121 
	mBTRFS_FS_FREE_SPACE_TREE_UNTRUSTED
,

124 
	mBTRFS_FS_TREE_MOD_LOG_USERS
,

127 
	mBTRFS_FS_COMMIT_TRANS
,

130 
	mBTRFS_FS_UNFINISHED_DROPS
,

133 
	mBTRFS_FS_NEED_ZONE_FINISH
,

136 
	mBTRFS_FS_NEED_TRANS_COMMIT
,

139 
	mBTRFS_FS_ACTIVE_ZONE_TRACKING
,

145 
	mBTRFS_FS_FEATURE_CHANGED
,

147 #ià
BITS_PER_LONG
 == 32

149 
	mBTRFS_FS_32BIT_ERROR
,

150 
	mBTRFS_FS_32BIT_WARN
,

160 
	mBTRFS_MOUNT_NODATASUM
 = (1UL << 0),

161 
	mBTRFS_MOUNT_NODATACOW
 = (1UL << 1),

162 
	mBTRFS_MOUNT_NOBARRIER
 = (1UL << 2),

163 
	mBTRFS_MOUNT_SSD
 = (1UL << 3),

164 
	mBTRFS_MOUNT_DEGRADED
 = (1UL << 4),

165 
	mBTRFS_MOUNT_COMPRESS
 = (1UL << 5),

166 
	mBTRFS_MOUNT_NOTREELOG
 = (1UL << 6),

167 
	mBTRFS_MOUNT_FLUSHONCOMMIT
 = (1UL << 7),

168 
	mBTRFS_MOUNT_SSD_SPREAD
 = (1UL << 8),

169 
	mBTRFS_MOUNT_NOSSD
 = (1UL << 9),

170 
	mBTRFS_MOUNT_DISCARD_SYNC
 = (1UL << 10),

171 
	mBTRFS_MOUNT_FORCE_COMPRESS
 = (1UL << 11),

172 
	mBTRFS_MOUNT_SPACE_CACHE
 = (1UL << 12),

173 
	mBTRFS_MOUNT_CLEAR_CACHE
 = (1UL << 13),

174 
	mBTRFS_MOUNT_USER_SUBVOL_RM_ALLOWED
 = (1UL << 14),

175 
	mBTRFS_MOUNT_ENOSPC_DEBUG
 = (1UL << 15),

176 
	mBTRFS_MOUNT_AUTO_DEFRAG
 = (1UL << 16),

177 
	mBTRFS_MOUNT_USEBACKUPROOT
 = (1UL << 17),

178 
	mBTRFS_MOUNT_SKIP_BALANCE
 = (1UL << 18),

179 
	mBTRFS_MOUNT_CHECK_INTEGRITY
 = (1UL << 19),

180 
	mBTRFS_MOUNT_CHECK_INTEGRITY_DATA
 = (1UL << 20),

181 
	mBTRFS_MOUNT_PANIC_ON_FATAL_ERROR
 = (1UL << 21),

182 
	mBTRFS_MOUNT_RESCAN_UUID_TREE
 = (1UL << 22),

183 
	mBTRFS_MOUNT_FRAGMENT_DATA
 = (1UL << 23),

184 
	mBTRFS_MOUNT_FRAGMENT_METADATA
 = (1UL << 24),

185 
	mBTRFS_MOUNT_FREE_SPACE_TREE
 = (1UL << 25),

186 
	mBTRFS_MOUNT_NOLOGREPLAY
 = (1UL << 26),

187 
	mBTRFS_MOUNT_REF_VERIFY
 = (1UL << 27),

188 
	mBTRFS_MOUNT_DISCARD_ASYNC
 = (1UL << 28),

189 
	mBTRFS_MOUNT_IGNOREBADROOTS
 = (1UL << 29),

190 
	mBTRFS_MOUNT_IGNOREDATACSUMS
 = (1UL << 30),

191 
	mBTRFS_MOUNT_NODISCARD
 = (1UL << 31),

198 
	#BTRFS_FEATURE_COMPAT_SUPP
 0ULL

	)

199 
	#BTRFS_FEATURE_COMPAT_SAFE_SET
 0ULL

	)

200 
	#BTRFS_FEATURE_COMPAT_SAFE_CLEAR
 0ULL

	)

202 
	#BTRFS_FEATURE_COMPAT_RO_SUPP
 \

203 (
BTRFS_FEATURE_COMPAT_RO_FREE_SPACE_TREE
 | \

204 
BTRFS_FEATURE_COMPAT_RO_FREE_SPACE_TREE_VALID
 | \

205 
BTRFS_FEATURE_COMPAT_RO_VERITY
 | \

206 
BTRFS_FEATURE_COMPAT_RO_BLOCK_GROUP_TREE
)

	)

208 
	#BTRFS_FEATURE_COMPAT_RO_SAFE_SET
 0ULL

	)

209 
	#BTRFS_FEATURE_COMPAT_RO_SAFE_CLEAR
 0ULL

	)

211 
	#BTRFS_FEATURE_INCOMPAT_SUPP_STABLE
 \

212 (
BTRFS_FEATURE_INCOMPAT_MIXED_BACKREF
 | \

213 
BTRFS_FEATURE_INCOMPAT_DEFAULT_SUBVOL
 | \

214 
BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
 | \

215 
BTRFS_FEATURE_INCOMPAT_BIG_METADATA
 | \

216 
BTRFS_FEATURE_INCOMPAT_COMPRESS_LZO
 | \

217 
BTRFS_FEATURE_INCOMPAT_COMPRESS_ZSTD
 | \

218 
BTRFS_FEATURE_INCOMPAT_RAID56
 | \

219 
BTRFS_FEATURE_INCOMPAT_EXTENDED_IREF
 | \

220 
BTRFS_FEATURE_INCOMPAT_SKINNY_METADATA
 | \

221 
BTRFS_FEATURE_INCOMPAT_NO_HOLES
 | \

222 
BTRFS_FEATURE_INCOMPAT_METADATA_UUID
 | \

223 
BTRFS_FEATURE_INCOMPAT_RAID1C34
 | \

224 
BTRFS_FEATURE_INCOMPAT_ZONED
)

	)

226 #ifdeà
CONFIG_BTRFS_DEBUG


231 
	#BTRFS_FEATURE_INCOMPAT_SUPP
 \

232 (
BTRFS_FEATURE_INCOMPAT_SUPP_STABLE
 | \

233 
BTRFS_FEATURE_INCOMPAT_EXTENT_TREE_V2
)

	)

237 
	#BTRFS_FEATURE_INCOMPAT_SUPP
 \

238 (
BTRFS_FEATURE_INCOMPAT_SUPP_STABLE
)

	)

242 
	#BTRFS_FEATURE_INCOMPAT_SAFE_SET
 \

243 (
BTRFS_FEATURE_INCOMPAT_EXTENDED_IREF
)

	)

244 
	#BTRFS_FEATURE_INCOMPAT_SAFE_CLEAR
 0ULL

	)

246 
	#BTRFS_DEFAULT_COMMIT_INTERVAL
 (30)

	)

247 
	#BTRFS_DEFAULT_MAX_INLINE
 (2048)

	)

249 
	sbŒfs_dev_»¶aû
 {

251 
u64
 
	m»¶aû_¡©e
;

253 
time64_t
 
	mtime_¡¬‹d
;

255 
time64_t
 
	mtime_¡İ³d
;

256 
©omic64_t
 
	mnum_wr™e_”rÜs
;

257 
©omic64_t
 
	mnum_uncÜ»ùabË_»ad_”rÜs
;

259 
u64
 
	mcursÜ_Ëá
;

260 
u64
 
	mcomm™‹d_cursÜ_Ëá
;

261 
u64
 
	mcursÜ_Ëá_Ï¡_wr™e_of_™em
;

262 
u64
 
	mcursÜ_right
;

265 
u64
 
	mcÚt_»adšg_äom_¤cdev_mode
;

267 
	mis_v®id
;

268 
	m™em_Ãeds_wr™eback
;

269 
bŒfs_deviû
 *
	m¤cdev
;

270 
bŒfs_deviû
 *
	mtgtdev
;

272 
mu‹x
 
	mlock_fšishšg_ÿnûl_unmouÁ
;

273 
rw_£m­hÜe
 
	mrw£m
;

275 
bŒfs_süub_´og»ss
 
	msüub_´og»ss
;

277 
³rıu_couÁ”
 
	mbio_couÁ”
;

278 
wa™_queue_h—d_t
 
	m»¶aû_wa™
;

286 
	sbŒfs_ä“_şu¡”
 {

287 
¥šlock_t
 
	mlock
;

288 
¥šlock_t
 
	m»fl_lock
;

289 
rb_roÙ
 
	mroÙ
;

292 
u64
 
	mmax_size
;

295 
u64
 
	mwšdow_¡¬t
;

298 
boŞ
 
	mäagm’‹d
;

300 
bŒfs_block_group
 *
	mblock_group
;

306 
li¡_h—d
 
	mblock_group_li¡
;

317 
	#BTRFS_NR_DISCARD_LISTS
 3

	)

318 
	#BTRFS_DISCARD_INDEX_UNUSED
 0

	)

319 
	#BTRFS_DISCARD_INDEX_START
 1

	)

321 
	sbŒfs_disÿrd_ùl
 {

322 
wÜkqueue_¡ruù
 *
	mdisÿrd_wÜk”s
;

323 
d–ayed_wÜk
 
	mwÜk
;

324 
¥šlock_t
 
	mlock
;

325 
bŒfs_block_group
 *
	mblock_group
;

326 
li¡_h—d
 
	mdisÿrd_li¡
[
BTRFS_NR_DISCARD_LISTS
];

327 
u64
 
	m´ev_disÿrd
;

328 
u64
 
	m´ev_disÿrd_time
;

329 
©omic_t
 
	mdisÿrdabË_ex‹Ás
;

330 
©omic64_t
 
	mdisÿrdabË_by‹s
;

331 
u64
 
	mmax_disÿrd_size
;

332 
u64
 
	md–ay_ms
;

333 
u32
 
	miİs_lim™
;

334 
u32
 
	mkbps_lim™
;

335 
u64
 
	mdisÿrd_ex‹Á_by‹s
;

336 
u64
 
	mdisÿrd_b™m­_by‹s
;

337 
©omic64_t
 
	mdisÿrd_by‹s_§ved
;

343 
	ebŒfs_exşusive_İ”©iÚ
 {

344 
	mBTRFS_EXCLOP_NONE
,

345 
	mBTRFS_EXCLOP_BALANCE_PAUSED
,

346 
	mBTRFS_EXCLOP_BALANCE
,

347 
	mBTRFS_EXCLOP_DEV_ADD
,

348 
	mBTRFS_EXCLOP_DEV_REMOVE
,

349 
	mBTRFS_EXCLOP_DEV_REPLACE
,

350 
	mBTRFS_EXCLOP_RESIZE
,

351 
	mBTRFS_EXCLOP_SWAP_ACTIVATE
,

355 
	sbŒfs_comm™_¡©s
 {

357 
u64
 
	mcomm™_couÁ
;

359 
u64
 
	mmax_comm™_dur
;

361 
u64
 
	mÏ¡_comm™_dur
;

363 
u64
 
	mtÙ®_comm™_dur
;

367 
	sbŒfs_fs_šfo
 {

369 
	mid
;

370 
bŒfs_fs_šfo
 *
	mfs_šfo_¬¿y
[
BTRFS_SUPER_INFO_COUNT
];

371 
u8
 
	mchunk_Œ“_uuid
[
BTRFS_UUID_SIZE
];

372 
	mæags
;

373 
bŒfs_roÙ
 *
	mŒ“_roÙ
;

374 
bŒfs_roÙ
 *
	mchunk_roÙ
;

375 
bŒfs_roÙ
 *
	mdev_roÙ
;

376 
bŒfs_roÙ
 *
	mfs_roÙ
;

377 
bŒfs_roÙ
 *
	mquÙa_roÙ
;

378 
bŒfs_roÙ
 *
	muuid_roÙ
;

379 
bŒfs_roÙ
 *
	md©a_»loc_roÙ
;

380 
bŒfs_roÙ
 *
	mblock_group_roÙ
;

383 
bŒfs_roÙ
 *
	mlog_roÙ_Œ“
;

386 
rwlock_t
 
	mglob®_roÙ_lock
;

387 
rb_roÙ
 
	mglob®_roÙ_Œ“
;

389 
¥šlock_t
 
	mfs_roÙs_¿dix_lock
;

390 
¿dix_Œ“_roÙ
 
	mfs_roÙs_¿dix
;

393 
rwlock_t
 
	mblock_group_ÿche_lock
;

394 
rb_roÙ_ÿched
 
	mblock_group_ÿche_Œ“
;

397 
©omic64_t
 
	mä“_chunk_¥aû
;

400 
ex‹Á_io_Œ“
 
	mexşuded_ex‹Ás
;

403 
ex‹Á_m­_Œ“
 
	mm­pšg_Œ“
;

409 
bŒfs_block_rsv
 
	mglob®_block_rsv
;

411 
bŒfs_block_rsv
 
	mŒªs_block_rsv
;

413 
bŒfs_block_rsv
 
	mchunk_block_rsv
;

415 
bŒfs_block_rsv
 
	md–ayed_block_rsv
;

417 
bŒfs_block_rsv
 
	md–ayed_»fs_rsv
;

419 
bŒfs_block_rsv
 
	mem±y_block_rsv
;

421 
u64
 
	mg’”©iÚ
;

422 
u64
 
	mÏ¡_Œªs_comm™‹d
;

428 
u64
 
	mÏ¡_»loc_Œªs
;

434 
u64
 
	mÏ¡_Œªs_log_fuÎ_comm™
;

435 
	mmouÁ_İt
;

437 
	mcom´ess_ty³
:4;

438 
	mcom´ess_Ëv–
;

439 
u32
 
	mcomm™_š‹rv®
;

446 
u64
 
	mmax_šlše
;

448 
bŒfs_Œª§ùiÚ
 *
	mruÂšg_Œª§ùiÚ
;

449 
wa™_queue_h—d_t
 
	mŒª§ùiÚ_thrÙe
;

450 
wa™_queue_h—d_t
 
	mŒª§ùiÚ_wa™
;

451 
wa™_queue_h—d_t
 
	mŒª§ùiÚ_blocked_wa™
;

452 
wa™_queue_h—d_t
 
	masync_subm™_wa™
;

464 
¥šlock_t
 
	msu³r_lock
;

465 
bŒfs_su³r_block
 *
	msu³r_cİy
;

466 
bŒfs_su³r_block
 *
	msu³r_fÜ_comm™
;

467 
su³r_block
 *
	msb
;

468 
šode
 *
	mbŒ“_šode
;

469 
mu‹x
 
	mŒ“_log_mu‹x
;

470 
mu‹x
 
	mŒª§ùiÚ_kth»ad_mu‹x
;

471 
mu‹x
 
	mş—Ãr_mu‹x
;

472 
mu‹x
 
	mchunk_mu‹x
;

478 
mu‹x
 
	mro_block_group_mu‹x
;

484 
bŒfs_¡re_hash_bË
 *
	m¡re_hash_bË
;

493 
mu‹x
 
	mÜd”ed_İ”©iÚs_mu‹x
;

495 
rw_£m­hÜe
 
	mcomm™_roÙ_£m
;

497 
rw_£m­hÜe
 
	mş—nup_wÜk_£m
;

499 
rw_£m­hÜe
 
	msubvŞ_£m
;

501 
¥šlock_t
 
	mŒªs_lock
;

506 
mu‹x
 
	m»loc_mu‹x
;

508 
li¡_h—d
 
	mŒªs_li¡
;

509 
li¡_h—d
 
	md—d_roÙs
;

510 
li¡_h—d
 
	mÿchšg_block_groups
;

512 
¥šlock_t
 
	md–ayed_ut_lock
;

513 
li¡_h—d
 
	md–ayed_uts
;

514 
©omic_t
 
	mÄ_d–ayed_uts
;

515 
wa™_queue_h—d_t
 
	md–ayed_uts_wa™
;

517 
©omic64_t
 
	mŒ“_mod_£q
;

520 
rwlock_t
 
	mŒ“_mod_log_lock
;

521 
rb_roÙ
 
	mŒ“_mod_log
;

522 
li¡_h—d
 
	mŒ“_mod_£q_li¡
;

524 
©omic_t
 
	masync_d–®loc_·ges
;

527 
¥šlock_t
 
	mÜd”ed_roÙ_lock
;

536 
li¡_h—d
 
	mÜd”ed_roÙs
;

538 
mu‹x
 
	md–®loc_roÙ_mu‹x
;

539 
¥šlock_t
 
	md–®loc_roÙ_lock
;

541 
li¡_h—d
 
	md–®loc_roÙs
;

552 
bŒfs_wÜkqueue
 *
	mwÜk”s
;

553 
bŒfs_wÜkqueue
 *
	md–®loc_wÜk”s
;

554 
bŒfs_wÜkqueue
 *
	mæush_wÜk”s
;

555 
wÜkqueue_¡ruù
 *
	m’dio_wÜk”s
;

556 
wÜkqueue_¡ruù
 *
	m’dio_m‘a_wÜk”s
;

557 
wÜkqueue_¡ruù
 *
	mrmw_wÜk”s
;

558 
wÜkqueue_¡ruù
 *
	mcom´es£d_wr™e_wÜk”s
;

559 
bŒfs_wÜkqueue
 *
	m’dio_wr™e_wÜk”s
;

560 
bŒfs_wÜkqueue
 *
	m’dio_ä“¥aû_wÜk”
;

561 
bŒfs_wÜkqueue
 *
	mÿchšg_wÜk”s
;

568 
bŒfs_wÜkqueue
 *
	mfixup_wÜk”s
;

569 
bŒfs_wÜkqueue
 *
	md–ayed_wÜk”s
;

571 
sk_¡ruù
 *
	mŒª§ùiÚ_kth»ad
;

572 
sk_¡ruù
 *
	mş—Ãr_kth»ad
;

573 
u32
 
	mth»ad_poŞ_size
;

575 
kobjeù
 *
	m¥aû_šfo_kobj
;

576 
kobjeù
 *
	mqgroups_kobj
;

577 
kobjeù
 *
	mdisÿrd_kobj
;

580 
³rıu_couÁ”
 
	mdœty_m‘ad©a_by‹s
;

581 
³rıu_couÁ”
 
	md–®loc_by‹s
;

582 
³rıu_couÁ”
 
	mÜd”ed_by‹s
;

583 
s32
 
	mdœty_m‘ad©a_b©ch
;

584 
s32
 
	md–®loc_b©ch
;

587 
li¡_h—d
 
	mdœty_cowÚly_roÙs
;

589 
bŒfs_fs_deviûs
 *
	mfs_deviûs
;

596 
li¡_h—d
 
	m¥aû_šfo
;

598 
bŒfs_¥aû_šfo
 *
	md©a_sšfo
;

600 
»loc_cÚŒŞ
 *
	m»loc_ùl
;

603 
bŒfs_ä“_şu¡”
 
	md©a_®loc_şu¡”
;

606 
bŒfs_ä“_şu¡”
 
	mm‘a_®loc_şu¡”
;

609 
¥šlock_t
 
	mdeäag_šodes_lock
;

610 
rb_roÙ
 
	mdeäag_šodes
;

611 
©omic_t
 
	mdeäag_ruÂšg
;

614 
£qlock_t
 
	m´ofes_lock
;

620 
u64
 
	mava_d©a_®loc_b™s
;

621 
u64
 
	mava_m‘ad©a_®loc_b™s
;

622 
u64
 
	mava_sy¡em_®loc_b™s
;

625 
¥šlock_t
 
	mb®ªû_lock
;

626 
mu‹x
 
	mb®ªû_mu‹x
;

627 
©omic_t
 
	mb®ªû_·u£_»q
;

628 
©omic_t
 
	mb®ªû_ÿnûl_»q
;

629 
bŒfs_b®ªû_cÚŒŞ
 *
	mb®ªû_ùl
;

630 
wa™_queue_h—d_t
 
	mb®ªû_wa™_q
;

633 
©omic_t
 
	m»loc_ÿnûl_»q
;

635 
u32
 
	md©a_chunk_®loÿtiÚs
;

636 
u32
 
	mm‘ad©a_¿tio
;

638 *
	mbdev_hŞd”
;

641 
mu‹x
 
	msüub_lock
;

642 
©omic_t
 
	msüubs_ruÂšg
;

643 
©omic_t
 
	msüub_·u£_»q
;

644 
©omic_t
 
	msüubs_·u£d
;

645 
©omic_t
 
	msüub_ÿnûl_»q
;

646 
wa™_queue_h—d_t
 
	msüub_·u£_wa™
;

651 
»fcouÁ_t
 
	msüub_wÜk”s_»fút
;

652 
wÜkqueue_¡ruù
 *
	msüub_wÜk”s
;

653 
bŒfs_sub·ge_šfo
 *
	msub·ge_šfo
;

655 
bŒfs_disÿrd_ùl
 
	mdisÿrd_ùl
;

657 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


658 
u32
 
	mcheck_š‹gr™y_´št_mask
;

661 
u64
 
	mqgroup_æags
;

664 
rb_roÙ
 
	mqgroup_Œ“
;

665 
¥šlock_t
 
	mqgroup_lock
;

671 
uli¡
 *
	mqgroup_uli¡
;

677 
mu‹x
 
	mqgroup_ioùl_lock
;

680 
li¡_h—d
 
	mdœty_qgroups
;

683 
u64
 
	mqgroup_£q
;

687 
mu‹x
 
	mqgroup_»sÿn_lock
;

688 
bŒfs_key
 
	mqgroup_»sÿn_´og»ss
;

689 
bŒfs_wÜkqueue
 *
	mqgroup_»sÿn_wÜk”s
;

690 
com¶‘iÚ
 
	mqgroup_»sÿn_com¶‘iÚ
;

691 
bŒfs_wÜk
 
	mqgroup_»sÿn_wÜk
;

693 
boŞ
 
	mqgroup_»sÿn_ruÂšg
;

694 
u8
 
	mqgroup_drİ_subŒ“_th»s
;

700 
	mfs_”rÜ
;

703 
	mfs_¡©e
;

705 
bŒfs_d–ayed_roÙ
 *
	md–ayed_roÙ
;

708 
¥šlock_t
 
	mbufãr_lock
;

710 
¿dix_Œ“_roÙ
 
	mbufãr_¿dix
;

713 
	mbackup_roÙ_šdex
;

716 
bŒfs_dev_»¶aû
 
	mdev_»¶aû
;

718 
£m­hÜe
 
	muuid_Œ“_»sÿn_£m
;

721 
wÜk_¡ruù
 
	masync_»şaim_wÜk
;

722 
wÜk_¡ruù
 
	masync_d©a_»şaim_wÜk
;

723 
wÜk_¡ruù
 
	m´“m±_»şaim_wÜk
;

726 
wÜk_¡ruù
 
	m»şaim_bgs_wÜk
;

727 
li¡_h—d
 
	m»şaim_bgs
;

728 
	mbg_»şaim_th»shŞd
;

730 
¥šlock_t
 
	munu£d_bgs_lock
;

731 
li¡_h—d
 
	munu£d_bgs
;

732 
mu‹x
 
	munu£d_bg_uÅš_mu‹x
;

734 
mu‹x
 
	m»şaim_bgs_lock
;

737 
u32
 
	mnodesize
;

738 
u32
 
	m£ùÜsize
;

740 
u32
 
	m£ùÜsize_b™s
;

741 
u32
 
	mcsum_size
;

742 
u32
 
	mcsums_³r_Ëaf
;

743 
u32
 
	m¡resize
;

749 
u64
 
	mmax_ex‹Á_size
;

752 
¥šlock_t
 
	msw­fe_pšs_lock
;

753 
rb_roÙ
 
	msw­fe_pšs
;

755 
üy±o_shash
 *
	mcsum_shash
;

758 
bŒfs_exşusive_İ”©iÚ
 
	mexşusive_İ”©iÚ
;

764 
u64
 
	mzÚe_size
;

767 
queue_lim™s
 
	mlim™s
;

768 
u64
 
	mmax_zÚe_­³nd_size
;

770 
mu‹x
 
	mzÚed_m‘a_io_lock
;

771 
¥šlock_t
 
	mŒ“log_bg_lock
;

772 
u64
 
	mŒ“log_bg
;

778 
¥šlock_t
 
	m»loÿtiÚ_bg_lock
;

779 
u64
 
	md©a_»loc_bg
;

780 
mu‹x
 
	mzÚed_d©a_»loc_io_lock
;

782 
bŒfs_block_group
 *
	maùive_m‘a_bg
;

783 
bŒfs_block_group
 *
	maùive_sy¡em_bg
;

785 
u64
 
	mÄ_glob®_roÙs
;

787 
¥šlock_t
 
	mzÚe_aùive_bgs_lock
;

788 
li¡_h—d
 
	mzÚe_aùive_bgs
;

791 
bŒfs_comm™_¡©s
 
	mcomm™_¡©s
;

798 
u64
 
	mÏ¡_roÙ_drİ_g’
;

804 
lockd•_m­
 
	mbŒfs_Œªs_num_wr™”s_m­
;

805 
lockd•_m­
 
	mbŒfs_Œªs_num_extwr™”s_m­
;

806 
lockd•_m­
 
	mbŒfs_¡©e_chªge_m­
[4];

807 
lockd•_m­
 
	mbŒfs_Œªs_³ndšg_Üd”ed_m­
;

808 
lockd•_m­
 
	mbŒfs_Üd”ed_ex‹Á_m­
;

810 #ifdeà
CONFIG_BTRFS_FS_REF_VERIFY


811 
¥šlock_t
 
	m»f_v”ify_lock
;

812 
rb_roÙ
 
	mblock_Œ“
;

815 #ifdeà
CONFIG_BTRFS_DEBUG


816 
kobjeù
 *
	mdebug_kobj
;

817 
li¡_h—d
 
	m®loÿ‹d_roÙs
;

819 
¥šlock_t
 
	meb_Ëak_lock
;

820 
li¡_h—d
 
	m®loÿ‹d_ebs
;

824 
šlše
 
	$bŒfs_£t_Ï¡_roÙ_drİ_g’
(
bŒfs_fs_šfo
 *
fs_šfo
,

825 
u64
 
g’
)

827 
	`WRITE_ONCE
(
fs_šfo
->
Ï¡_roÙ_drİ_g’
, 
g’
);

828 
	}
}

830 
šlše
 
u64
 
	$bŒfs_g‘_Ï¡_roÙ_drİ_g’
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
)

832  
	`READ_ONCE
(
fs_šfo
->
Ï¡_roÙ_drİ_g’
);

833 
	}
}

839 
šlše
 
u64
 
	$bŒfs_csum_by‹s_to_Ëaves
(

840 cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
csum_by‹s
)

842 cÚ¡ 
u64
 
num_csums
 = 
csum_by‹s
 >> 
fs_šfo
->
£ùÜsize_b™s
;

844  
	`DIV_ROUND_UP_ULL
(
num_csums
, 
fs_šfo
->
csums_³r_Ëaf
);

845 
	}
}

851 
šlše
 
u64
 
	$bŒfs_ÿlc_š£¹_m‘ad©a_size
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

852 
num_™ems
)

854  (
u64
)
fs_šfo
->
nodesize
 * 
BTRFS_MAX_LEVEL
 * 2 * 
num_™ems
;

855 
	}
}

861 
šlše
 
u64
 
	$bŒfs_ÿlc_m‘ad©a_size
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

862 
num_™ems
)

864  (
u64
)
fs_šfo
->
nodesize
 * 
BTRFS_MAX_LEVEL
 * 
num_™ems
;

865 
	}
}

867 
	#BTRFS_MAX_EXTENT_ITEM_SIZE
(
r
è((
	`BTRFS_LEAF_DATA_SIZE
Ô->
fs_šfo
) >> 4) - \

868 (
bŒfs_™em
))

	)

870 
šlše
 
boŞ
 
	$bŒfs_is_zÚed
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
)

872  
	`IS_ENABLED
(
CONFIG_BLK_DEV_ZONED
è&& 
fs_šfo
->
zÚe_size
 > 0;

873 
	}
}

878 
šlše
 
u32
 
	$couÁ_max_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
size
)

880 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


881 ià(!
fs_šfo
)

882  
	`div_u64
(
size
 + 
BTRFS_MAX_EXTENT_SIZE
 - 1, BTRFS_MAX_EXTENT_SIZE);

885  
	`div_u64
(
size
 + 
fs_šfo
->
max_ex‹Á_size
 - 1, fs_info->max_extent_size);

886 
	}
}

888 
boŞ
 
bŒfs_exşİ_¡¬t
(
bŒfs_fs_šfo
 *
fs_šfo
,

889 
bŒfs_exşusive_İ”©iÚ
 
ty³
);

890 
boŞ
 
bŒfs_exşİ_¡¬t_Œy_lock
(
bŒfs_fs_šfo
 *
fs_šfo
,

891 
bŒfs_exşusive_İ”©iÚ
 
ty³
);

892 
bŒfs_exşİ_¡¬t_uÆock
(
bŒfs_fs_šfo
 *
fs_šfo
);

893 
bŒfs_exşİ_fšish
(
bŒfs_fs_šfo
 *
fs_šfo
);

894 
bŒfs_exşİ_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
,

895 
bŒfs_exşusive_İ”©iÚ
 
İ
);

898 
__bŒfs_£t_fs_šcom·t
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æag
,

899 cÚ¡ *
Çme
);

900 
__bŒfs_ş—r_fs_šcom·t
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æag
,

901 cÚ¡ *
Çme
);

902 
__bŒfs_£t_fs_com·t_ro
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æag
,

903 cÚ¡ *
Çme
);

904 
__bŒfs_ş—r_fs_com·t_ro
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æag
,

905 cÚ¡ *
Çme
);

907 
	#__bŒfs_fs_šcom·t
(
fs_šfo
, 
æags
) \

908 (!!(
	`bŒfs_su³r_šcom·t_æags
((
fs_šfo
)->
su³r_cİy
è& (
æags
)))

	)

910 
	#__bŒfs_fs_com·t_ro
(
fs_šfo
, 
æags
) \

911 (!!(
	`bŒfs_su³r_com·t_ro_æags
((
fs_šfo
)->
su³r_cİy
è& (
æags
)))

	)

913 
	#bŒfs_£t_fs_šcom·t
(
__fs_šfo
, 
İt
) \

914 
	`__bŒfs_£t_fs_šcom·t
((
__fs_šfo
), 
BTRFS_FEATURE_INCOMPAT_
##
İt
, #İt)

	)

916 
	#bŒfs_ş—r_fs_šcom·t
(
__fs_šfo
, 
İt
) \

917 
	`__bŒfs_ş—r_fs_šcom·t
((
__fs_šfo
), 
BTRFS_FEATURE_INCOMPAT_
##
İt
, #İt)

	)

919 
	#bŒfs_fs_šcom·t
(
fs_šfo
, 
İt
) \

920 
	`__bŒfs_fs_šcom·t
((
fs_šfo
), 
BTRFS_FEATURE_INCOMPAT_
##
İt
)

	)

922 
	#bŒfs_£t_fs_com·t_ro
(
__fs_šfo
, 
İt
) \

923 
	`__bŒfs_£t_fs_com·t_ro
((
__fs_šfo
), 
BTRFS_FEATURE_COMPAT_RO_
##
İt
, #İt)

	)

925 
	#bŒfs_ş—r_fs_com·t_ro
(
__fs_šfo
, 
İt
) \

926 
	`__bŒfs_ş—r_fs_com·t_ro
((
__fs_šfo
), 
BTRFS_FEATURE_COMPAT_RO_
##
İt
, #İt)

	)

928 
	#bŒfs_fs_com·t_ro
(
fs_šfo
, 
İt
) \

929 
	`__bŒfs_fs_com·t_ro
((
fs_šfo
), 
BTRFS_FEATURE_COMPAT_RO_
##
İt
)

	)

931 
	#bŒfs_ş—r_İt
(
o
, 
İt
è((oè&ğ~
BTRFS_MOUNT_
##İt)

	)

932 
	#bŒfs_£t_İt
(
o
, 
İt
è((oè|ğ
BTRFS_MOUNT_
##İt)

	)

933 
	#bŒfs_¿w_‹¡_İt
(
o
, 
İt
è((oè& 
BTRFS_MOUNT_
##İt)

	)

934 
	#bŒfs_‹¡_İt
(
fs_šfo
, 
İt
è((fs_šfo)->
mouÁ_İt
 & \

935 
BTRFS_MOUNT_
##
İt
)

	)

937 
	#bŒfs_£t_ªd_šfo
(
fs_šfo
, 
İt
, 
fmt
, 
¬gs
...) \

939 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
İt
)) \

940 
	`bŒfs_šfo
(
fs_šfo
, 
fmt
, ##
¬gs
); \

941 
	`bŒfs_£t_İt
(
fs_šfo
->
mouÁ_İt
, 
İt
); \

942 } 0)

	)

944 
	#bŒfs_ş—r_ªd_šfo
(
fs_šfo
, 
İt
, 
fmt
, 
¬gs
...) \

946 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
İt
)) \

947 
	`bŒfs_šfo
(
fs_šfo
, 
fmt
, ##
¬gs
); \

948 
	`bŒfs_ş—r_İt
(
fs_šfo
->
mouÁ_İt
, 
İt
); \

949 } 0)

	)

951 
šlše
 
	$bŒfs_fs_şosšg
(
bŒfs_fs_šfo
 *
fs_šfo
)

954 ià(
	`‹¡_b™
(
BTRFS_FS_CLOSING_START
, &
fs_šfo
->
æags
)) {

955 ià(
	`‹¡_b™
(
BTRFS_FS_CLOSING_DONE
, &
fs_šfo
->
æags
))

960 
	}
}

970 
šlše
 
	$bŒfs_Ãed_ş—Ãr_¦“p
(
bŒfs_fs_šfo
 *
fs_šfo
)

972  
	`‹¡_b™
(
BTRFS_FS_STATE_RO
, &
fs_šfo
->
fs_¡©e
) ||

973 
	`bŒfs_fs_şosšg
(
fs_šfo
);

974 
	}
}

976 
šlše
 
	$bŒfs_wake_unfšished_drİ
(
bŒfs_fs_šfo
 *
fs_šfo
)

978 
	`ş—r_ªd_wake_up_b™
(
BTRFS_FS_UNFINISHED_DROPS
, &
fs_šfo
->
æags
);

979 
	}
}

981 
	#BTRFS_FS_ERROR
(
fs_šfo
è(
	`READ_ONCE
((fs_šfo)->
fs_”rÜ
))

	)

983 
	#BTRFS_FS_LOG_CLEANUP_ERROR
(
fs_šfo
) \

984 (
	`uÆik–y
(
	`‹¡_b™
(
BTRFS_FS_STATE_LOG_CLEANUP_ERROR
, \

985 &(
fs_šfo
)->
fs_¡©e
)))

	)

987 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


989 
	#EXPORT_FOR_TESTS


	)

991 
šlše
 
	$bŒfs_is_‹¡šg
(
bŒfs_fs_šfo
 *
fs_šfo
)

993  
	`‹¡_b™
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_šfo
->
fs_¡©e
);

994 
	}
}

996 
bŒfs_‹¡_de¡roy_šode
(
šode
 *inode);

1000 
	#EXPORT_FOR_TESTS
 

	)

1002 
šlše
 
	$bŒfs_is_‹¡šg
(
bŒfs_fs_šfo
 *
fs_šfo
)

1005 
	}
}

	@inode-item.c

6 
	~"ù»e.h
"

7 
	~"fs.h
"

8 
	~"mes§ges.h
"

9 
	~"šode-™em.h
"

10 
	~"disk-io.h
"

11 
	~"Œª§ùiÚ.h
"

12 
	~"´št-Œ“.h
"

13 
	~"¥aû-šfo.h
"

14 
	~"acûssÜs.h
"

15 
	~"ex‹Á-Œ“.h
"

16 
	~"fe-™em.h
"

18 
bŒfs_šode_»f
 *
	$bŒfs_fšd_Çme_š_back»f
(
ex‹Á_bufãr
 *
Ëaf
,

19 
¦Ù
,

20 cÚ¡ 
fsüy±_¡r
 *
Çme
)

22 
bŒfs_šode_»f
 *
»f
;

23 
±r
;

24 
Çme_±r
;

25 
u32
 
™em_size
;

26 
u32
 
cur_off£t
 = 0;

27 
Ën
;

29 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

30 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
);

31 
cur_off£t
 < 
™em_size
) {

32 
»f
 = (
bŒfs_šode_»f
 *)(
±r
 + 
cur_off£t
);

33 
Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
Ëaf
, 
»f
);

34 
Çme_±r
 = ()(
»f
 + 1);

35 
cur_off£t
 +ğ
Ën
 + (*
»f
);

36 ià(
Ën
 !ğ
Çme
->len)

38 ià(
	`memcmp_ex‹Á_bufãr
(
Ëaf
, 
Çme
->Çme, 
Çme_±r
,

39 
Çme
->
Ën
) == 0)

40  
»f
;

42  
NULL
;

43 
	}
}

45 
bŒfs_šode_exŒef
 *
	$bŒfs_fšd_Çme_š_ext_back»f
(

46 
ex‹Á_bufãr
 *
Ëaf
, 
¦Ù
, 
u64
 
»f_objeùid
,

47 cÚ¡ 
fsüy±_¡r
 *
Çme
)

49 
bŒfs_šode_exŒef
 *
exŒef
;

50 
±r
;

51 
Çme_±r
;

52 
u32
 
™em_size
;

53 
u32
 
cur_off£t
 = 0;

54 
»f_Çme_Ën
;

56 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

57 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
);

65 
cur_off£t
 < 
™em_size
) {

66 
exŒef
 = (
bŒfs_šode_exŒef
 *è(
±r
 + 
cur_off£t
);

67 
Çme_±r
 = ()(&
exŒef
->
Çme
);

68 
»f_Çme_Ën
 = 
	`bŒfs_šode_exŒef_Çme_Ën
(
Ëaf
, 
exŒef
);

70 ià(
»f_Çme_Ën
 =ğ
Çme
->
Ën
 &&

71 
	`bŒfs_šode_exŒef_·»Á
(
Ëaf
, 
exŒef
è=ğ
»f_objeùid
 &&

72 (
	`memcmp_ex‹Á_bufãr
(
Ëaf
, 
Çme
->Çme, 
Çme_±r
,

73 
Çme
->
Ën
) == 0))

74  
exŒef
;

76 
cur_off£t
 +ğ
»f_Çme_Ën
 + (*
exŒef
);

78  
NULL
;

79 
	}
}

82 
bŒfs_šode_exŒef
 *

83 
	$bŒfs_lookup_šode_exŒef
(
bŒfs_Œªs_hªdË
 *
Œªs
,

84 
bŒfs_roÙ
 *
roÙ
,

85 
bŒfs_·th
 *
·th
,

86 cÚ¡ 
fsüy±_¡r
 *
Çme
,

87 
u64
 
šode_objeùid
, u64 
»f_objeùid
, 
šs_Ën
,

88 
cow
)

90 
»t
;

91 
bŒfs_key
 
key
;

93 
key
.
objeùid
 = 
šode_objeùid
;

94 
key
.
ty³
 = 
BTRFS_INODE_EXTREF_KEY
;

95 
key
.
off£t
 = 
	`bŒfs_exŒef_hash
(
»f_objeùid
, 
Çme
->Çme,‚ame->
Ën
);

97 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 
šs_Ën
, 
cow
);

98 ià(
»t
 < 0)

99  
	`ERR_PTR
(
»t
);

100 ià(
»t
 > 0)

101  
NULL
;

102  
	`bŒfs_fšd_Çme_š_ext_back»f
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

103 
»f_objeùid
, 
Çme
);

105 
	}
}

107 
	$bŒfs_d–_šode_exŒef
(
bŒfs_Œªs_hªdË
 *
Œªs
,

108 
bŒfs_roÙ
 *
roÙ
,

109 cÚ¡ 
fsüy±_¡r
 *
Çme
,

110 
u64
 
šode_objeùid
, u64 
»f_objeùid
,

111 
u64
 *
šdex
)

113 
bŒfs_·th
 *
·th
;

114 
bŒfs_key
 
key
;

115 
bŒfs_šode_exŒef
 *
exŒef
;

116 
ex‹Á_bufãr
 *
Ëaf
;

117 
»t
;

118 
d–_Ën
 = 
Çme
->
Ën
 + (*
exŒef
);

119 
±r
;

120 
™em_¡¬t
;

121 
u32
 
™em_size
;

123 
key
.
objeùid
 = 
šode_objeùid
;

124 
key
.
ty³
 = 
BTRFS_INODE_EXTREF_KEY
;

125 
key
.
off£t
 = 
	`bŒfs_exŒef_hash
(
»f_objeùid
, 
Çme
->Çme,‚ame->
Ën
);

127 
·th
 = 
	`bŒfs_®loc_·th
();

128 ià(!
·th
)

129  -
ENOMEM
;

131 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

132 ià(
»t
 > 0)

133 
»t
 = -
ENOENT
;

134 ià(
»t
 < 0)

135 
out
;

142 
exŒef
 = 
	`bŒfs_fšd_Çme_š_ext_back»f
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

143 
»f_objeùid
, 
Çme
);

144 ià(!
exŒef
) {

145 
	`bŒfs_hªdË_fs_”rÜ
(
roÙ
->
fs_šfo
, -
ENOENT
, 
NULL
);

146 
»t
 = -
EROFS
;

147 
out
;

150 
Ëaf
 = 
·th
->
nodes
[0];

151 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

152 ià(
šdex
)

153 *
šdex
 = 
	`bŒfs_šode_exŒef_šdex
(
Ëaf
, 
exŒef
);

155 ià(
d–_Ën
 =ğ
™em_size
) {

160 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

161 
out
;

164 
±r
 = ()
exŒef
;

165 
™em_¡¬t
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

167 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
±r
,…Œ + 
d–_Ën
,

168 
™em_size
 - (
±r
 + 
d–_Ën
 - 
™em_¡¬t
));

170 
	`bŒfs_Œunÿ‹_™em
(
Œªs
, 
·th
, 
™em_size
 - 
d–_Ën
, 1);

172 
out
:

173 
	`bŒfs_ä“_·th
(
·th
);

175  
»t
;

176 
	}
}

178 
	$bŒfs_d–_šode_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

179 
bŒfs_roÙ
 *
roÙ
, cÚ¡ 
fsüy±_¡r
 *
Çme
,

180 
u64
 
šode_objeùid
, u64 
»f_objeùid
, u64 *
šdex
)

182 
bŒfs_·th
 *
·th
;

183 
bŒfs_key
 
key
;

184 
bŒfs_šode_»f
 *
»f
;

185 
ex‹Á_bufãr
 *
Ëaf
;

186 
±r
;

187 
™em_¡¬t
;

188 
u32
 
™em_size
;

189 
u32
 
sub_™em_Ën
;

190 
»t
;

191 
£¬ch_ext_»fs
 = 0;

192 
d–_Ën
 = 
Çme
->
Ën
 + (*
»f
);

194 
key
.
objeùid
 = 
šode_objeùid
;

195 
key
.
off£t
 = 
»f_objeùid
;

196 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

198 
·th
 = 
	`bŒfs_®loc_·th
();

199 ià(!
·th
)

200  -
ENOMEM
;

202 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

203 ià(
»t
 > 0) {

204 
»t
 = -
ENOENT
;

205 
£¬ch_ext_»fs
 = 1;

206 
out
;

207 } ià(
»t
 < 0) {

208 
out
;

211 
»f
 = 
	`bŒfs_fšd_Çme_š_back»f
(
·th
->
nodes
[0],…©h->
¦Ùs
[0], 
Çme
);

212 ià(!
»f
) {

213 
»t
 = -
ENOENT
;

214 
£¬ch_ext_»fs
 = 1;

215 
out
;

217 
Ëaf
 = 
·th
->
nodes
[0];

218 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

220 ià(
šdex
)

221 *
šdex
 = 
	`bŒfs_šode_»f_šdex
(
Ëaf
, 
»f
);

223 ià(
d–_Ën
 =ğ
™em_size
) {

224 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

225 
out
;

227 
±r
 = ()
»f
;

228 
sub_™em_Ën
 = 
Çme
->
Ën
 + (*
»f
);

229 
™em_¡¬t
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

230 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
±r
,…Œ + 
sub_™em_Ën
,

231 
™em_size
 - (
±r
 + 
sub_™em_Ën
 - 
™em_¡¬t
));

232 
	`bŒfs_Œunÿ‹_™em
(
Œªs
, 
·th
, 
™em_size
 - 
sub_™em_Ën
, 1);

233 
out
:

234 
	`bŒfs_ä“_·th
(
·th
);

236 ià(
£¬ch_ext_»fs
) {

242  
	`bŒfs_d–_šode_exŒef
(
Œªs
, 
roÙ
, 
Çme
,

243 
šode_objeùid
, 
»f_objeùid
, 
šdex
);

246  
»t
;

247 
	}
}

254 
	$bŒfs_š£¹_šode_exŒef
(
bŒfs_Œªs_hªdË
 *
Œªs
,

255 
bŒfs_roÙ
 *
roÙ
,

256 cÚ¡ 
fsüy±_¡r
 *
Çme
,

257 
u64
 
šode_objeùid
, u64 
»f_objeùid
,

258 
u64
 
šdex
)

260 
bŒfs_šode_exŒef
 *
exŒef
;

261 
»t
;

262 
šs_Ën
 = 
Çme
->
Ën
 + (*
exŒef
);

263 
±r
;

264 
bŒfs_·th
 *
·th
;

265 
bŒfs_key
 
key
;

266 
ex‹Á_bufãr
 *
Ëaf
;

268 
key
.
objeùid
 = 
šode_objeùid
;

269 
key
.
ty³
 = 
BTRFS_INODE_EXTREF_KEY
;

270 
key
.
off£t
 = 
	`bŒfs_exŒef_hash
(
»f_objeùid
, 
Çme
->Çme,‚ame->
Ën
);

272 
·th
 = 
	`bŒfs_®loc_·th
();

273 ià(!
·th
)

274  -
ENOMEM
;

276 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

277 
šs_Ën
);

278 ià(
»t
 =ğ-
EEXIST
) {

279 ià(
	`bŒfs_fšd_Çme_š_ext_back»f
(
·th
->
nodes
[0],

280 
·th
->
¦Ùs
[0],

281 
»f_objeùid
,

282 
Çme
))

283 
out
;

285 
	`bŒfs_ex‹nd_™em
(
Œªs
, 
·th
, 
šs_Ën
);

286 
»t
 = 0;

288 ià(
»t
 < 0)

289 
out
;

291 
Ëaf
 = 
·th
->
nodes
[0];

292 
±r
 = ()
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], );

293 
±r
 +ğ
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]è- 
šs_Ën
;

294 
exŒef
 = (
bŒfs_šode_exŒef
 *)
±r
;

296 
	`bŒfs_£t_šode_exŒef_Çme_Ën
(
·th
->
nodes
[0], 
exŒef
, 
Çme
->
Ën
);

297 
	`bŒfs_£t_šode_exŒef_šdex
(
·th
->
nodes
[0], 
exŒef
, 
šdex
);

298 
	`bŒfs_£t_šode_exŒef_·»Á
(
·th
->
nodes
[0], 
exŒef
, 
»f_objeùid
);

300 
±r
 = ()&
exŒef
->
Çme
;

301 
	`wr™e_ex‹Á_bufãr
(
·th
->
nodes
[0], 
Çme
->Çme, 
±r
,‚ame->
Ën
);

302 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·th
->
nodes
[0]);

304 
out
:

305 
	`bŒfs_ä“_·th
(
·th
);

306  
»t
;

307 
	}
}

310 
	$bŒfs_š£¹_šode_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

311 
bŒfs_roÙ
 *
roÙ
, cÚ¡ 
fsüy±_¡r
 *
Çme
,

312 
u64
 
šode_objeùid
, u64 
»f_objeùid
, u64 
šdex
)

314 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

315 
bŒfs_·th
 *
·th
;

316 
bŒfs_key
 
key
;

317 
bŒfs_šode_»f
 *
»f
;

318 
±r
;

319 
»t
;

320 
šs_Ën
 = 
Çme
->
Ën
 + (*
»f
);

322 
key
.
objeùid
 = 
šode_objeùid
;

323 
key
.
off£t
 = 
»f_objeùid
;

324 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

326 
·th
 = 
	`bŒfs_®loc_·th
();

327 ià(!
·th
)

328  -
ENOMEM
;

330 
·th
->
sk_»Ëa£_Ú_”rÜ
 = 1;

331 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

332 
šs_Ën
);

333 ià(
»t
 =ğ-
EEXIST
) {

334 
u32
 
Şd_size
;

335 
»f
 = 
	`bŒfs_fšd_Çme_š_back»f
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

336 
Çme
);

337 ià(
»f
)

338 
out
;

340 
Şd_size
 = 
	`bŒfs_™em_size
(
·th
->
nodes
[0],…©h->
¦Ùs
[0]);

341 
	`bŒfs_ex‹nd_™em
(
Œªs
, 
·th
, 
šs_Ën
);

342 
»f
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

343 
bŒfs_šode_»f
);

344 
»f
 = (
bŒfs_šode_»f
 *)((ìeà+ 
Şd_size
);

345 
	`bŒfs_£t_šode_»f_Çme_Ën
(
·th
->
nodes
[0], 
»f
, 
Çme
->
Ën
);

346 
	`bŒfs_£t_šode_»f_šdex
(
·th
->
nodes
[0], 
»f
, 
šdex
);

347 
±r
 = ()(
»f
 + 1);

348 
»t
 = 0;

349 } ià(
»t
 < 0) {

350 ià(
»t
 =ğ-
EOVERFLOW
) {

351 ià(
	`bŒfs_fšd_Çme_š_back»f
(
·th
->
nodes
[0],

352 
·th
->
¦Ùs
[0],

353 
Çme
))

354 
»t
 = -
EEXIST
;

356 
»t
 = -
EMLINK
;

358 
out
;

360 
»f
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

361 
bŒfs_šode_»f
);

362 
	`bŒfs_£t_šode_»f_Çme_Ën
(
·th
->
nodes
[0], 
»f
, 
Çme
->
Ën
);

363 
	`bŒfs_£t_šode_»f_šdex
(
·th
->
nodes
[0], 
»f
, 
šdex
);

364 
±r
 = ()(
»f
 + 1);

366 
	`wr™e_ex‹Á_bufãr
(
·th
->
nodes
[0], 
Çme
->Çme, 
±r
,‚ame->
Ën
);

367 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·th
->
nodes
[0]);

369 
out
:

370 
	`bŒfs_ä“_·th
(
·th
);

372 ià(
»t
 =ğ-
EMLINK
) {

373 
bŒfs_su³r_block
 *
disk_su³r
 = 
fs_šfo
->
su³r_cİy
;

376 ià(
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
)

377 & 
BTRFS_FEATURE_INCOMPAT_EXTENDED_IREF
)

378 
»t
 = 
	`bŒfs_š£¹_šode_exŒef
(
Œªs
, 
roÙ
, 
Çme
,

379 
šode_objeùid
,

380 
»f_objeùid
, 
šdex
);

383  
»t
;

384 
	}
}

386 
	$bŒfs_š£¹_em±y_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

387 
bŒfs_roÙ
 *
roÙ
,

388 
bŒfs_·th
 *
·th
, 
u64
 
objeùid
)

390 
bŒfs_key
 
key
;

391 
»t
;

392 
key
.
objeùid
 = objectid;

393 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

394 
key
.
off£t
 = 0;

396 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

397 (
bŒfs_šode_™em
));

398  
»t
;

399 
	}
}

401 
	$bŒfs_lookup_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ


402 *
roÙ
, 
bŒfs_·th
 *
·th
,

403 
bŒfs_key
 *
loÿtiÚ
, 
mod
)

405 
šs_Ën
 = 
mod
 < 0 ? -1 : 0;

406 
cow
 = 
mod
 != 0;

407 
»t
;

408 
¦Ù
;

409 
ex‹Á_bufãr
 *
Ëaf
;

410 
bŒfs_key
 
found_key
;

412 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, 
loÿtiÚ
, 
·th
, 
šs_Ën
, 
cow
);

413 ià(
»t
 > 0 && 
loÿtiÚ
->
ty³
 =ğ
BTRFS_ROOT_ITEM_KEY
 &&

414 
loÿtiÚ
->
off£t
 =ğ(
u64
)-1 && 
·th
->
¦Ùs
[0] != 0) {

415 
¦Ù
 = 
·th
->
¦Ùs
[0] - 1;

416 
Ëaf
 = 
·th
->
nodes
[0];

417 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
¦Ù
);

418 ià(
found_key
.
objeùid
 =ğ
loÿtiÚ
->objectid &&

419 
found_key
.
ty³
 =ğ
loÿtiÚ
->type) {

420 
·th
->
¦Ùs
[0]--;

424  
»t
;

425 
	}
}

427 
šlše
 
	$bŒfs_Œaû_Œunÿ‹
(
bŒfs_šode
 *
šode
,

428 
ex‹Á_bufãr
 *
Ëaf
,

429 
bŒfs_fe_ex‹Á_™em
 *
fi
,

430 
u64
 
off£t
, 
ex‹Á_ty³
, 
¦Ù
)

432 ià(!
šode
)

434 ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
)

435 
	`Œaû_bŒfs_Œunÿ‹_show_fi_šlše
(
šode
, 
Ëaf
, 
fi
, 
¦Ù
,

436 
off£t
);

438 
	`Œaû_bŒfs_Œunÿ‹_show_fi_»guÏr
(
šode
, 
Ëaf
, 
fi
, 
off£t
);

439 
	}
}

459 
	$bŒfs_Œunÿ‹_šode_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

460 
bŒfs_roÙ
 *
roÙ
,

461 
bŒfs_Œunÿ‹_cÚŒŞ
 *
cÚŒŞ
)

463 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

464 
bŒfs_·th
 *
·th
;

465 
ex‹Á_bufãr
 *
Ëaf
;

466 
bŒfs_fe_ex‹Á_™em
 *
fi
;

467 
bŒfs_key
 
key
;

468 
bŒfs_key
 
found_key
;

469 
u64
 
Ãw_size
 = 
cÚŒŞ
->new_size;

470 
u64
 
ex‹Á_num_by‹s
 = 0;

471 
u64
 
ex‹Á_off£t
 = 0;

472 
u64
 
™em_’d
 = 0;

473 
u32
 
found_ty³
 = (
u8
)-1;

474 
d–_™em
;

475 
³ndšg_d–_Ä
 = 0;

476 
³ndšg_d–_¦Ù
 = 0;

477 
ex‹Á_ty³
 = -1;

478 
»t
;

479 
u64
 
by‹s_d–‘ed
 = 0;

480 
boŞ
 
be_niû
 = 
çl£
;

482 
	`ASSERT
(
cÚŒŞ
->
šode
 || !cÚŒŞ->
ş—r_ex‹Á_¿nge
);

483 
	`ASSERT
(
Ãw_size
 =ğ0 || 
cÚŒŞ
->
mš_ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
);

485 
cÚŒŞ
->
Ï¡_size
 = 
Ãw_size
;

486 
cÚŒŞ
->
sub_by‹s
 = 0;

492 ià(
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
))

493 
be_niû
 = 
Œue
;

495 
·th
 = 
	`bŒfs_®loc_·th
();

496 ià(!
·th
)

497  -
ENOMEM
;

498 
·th
->
»ada
 = 
READA_BACK
;

500 
key
.
objeùid
 = 
cÚŒŞ
->
šo
;

501 
key
.
off£t
 = (
u64
)-1;

502 
key
.
ty³
 = (
u8
)-1;

504 
£¬ch_agaš
:

510 ià(
be_niû
 && 
by‹s_d–‘ed
 > 
SZ_32M
 &&

511 
	`bŒfs_should_’d_Œª§ùiÚ
(
Œªs
)) {

512 
»t
 = -
EAGAIN
;

513 
out
;

516 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

517 ià(
»t
 < 0)

518 
out
;

520 ià(
»t
 > 0) {

521 
»t
 = 0;

523 ià(
·th
->
¦Ùs
[0] == 0)

524 
out
;

525 
·th
->
¦Ùs
[0]--;

529 
u64
 
ş—r_¡¬t
 = 0, 
ş—r_Ën
 = 0, 
ex‹Á_¡¬t
 = 0;

530 
boŞ
 
»fl_d–ayed_»fs_rsv
 = 
çl£
;

532 
fi
 = 
NULL
;

533 
Ëaf
 = 
·th
->
nodes
[0];

534 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

535 
found_ty³
 = 
found_key
.
ty³
;

537 ià(
found_key
.
objeùid
 !ğ
cÚŒŞ
->
šo
)

540 ià(
found_ty³
 < 
cÚŒŞ
->
mš_ty³
)

543 
™em_’d
 = 
found_key
.
off£t
;

544 ià(
found_ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
) {

545 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

546 
bŒfs_fe_ex‹Á_™em
);

547 
ex‹Á_ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
fi
);

548 ià(
ex‹Á_ty³
 !ğ
BTRFS_FILE_EXTENT_INLINE
)

549 
™em_’d
 +=

550 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

551 ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
)

552 
™em_’d
 +ğ
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
);

554 
	`bŒfs_Œaû_Œunÿ‹
(
cÚŒŞ
->
šode
, 
Ëaf
, 
fi
,

555 
found_key
.
off£t
, 
ex‹Á_ty³
,

556 
·th
->
¦Ùs
[0]);

557 
™em_’d
--;

559 ià(
found_ty³
 > 
cÚŒŞ
->
mš_ty³
) {

560 
d–_™em
 = 1;

562 ià(
™em_’d
 < 
Ãw_size
)

564 ià(
found_key
.
off£t
 >ğ
Ãw_size
)

565 
d–_™em
 = 1;

567 
d–_™em
 = 0;

571 ià(
found_ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

572 
d–‘e
;

574 
cÚŒŞ
->
ex‹Ás_found
++;

576 ià(
ex‹Á_ty³
 !ğ
BTRFS_FILE_EXTENT_INLINE
) {

577 
u64
 
num_dec
;

579 
ş—r_¡¬t
 = 
found_key
.
off£t
;

580 
ex‹Á_¡¬t
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
);

581 ià(!
d–_™em
) {

582 
u64
 
Üig_num_by‹s
 =

583 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

584 
ex‹Á_num_by‹s
 = 
	`ALIGN
(
Ãw_size
 -

585 
found_key
.
off£t
,

586 
fs_šfo
->
£ùÜsize
);

587 
ş—r_¡¬t
 = 
	`ALIGN
(
Ãw_size
, 
fs_šfo
->
£ùÜsize
);

589 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

590 
ex‹Á_num_by‹s
);

591 
num_dec
 = (
Üig_num_by‹s
 - 
ex‹Á_num_by‹s
);

592 ià(
ex‹Á_¡¬t
 != 0)

593 
cÚŒŞ
->
sub_by‹s
 +ğ
num_dec
;

594 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

596 
ex‹Á_num_by‹s
 =

597 
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
);

598 
ex‹Á_off£t
 = 
found_key
.
off£t
 -

599 
	`bŒfs_fe_ex‹Á_off£t
(
Ëaf
, 
fi
);

602 
num_dec
 = 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

603 ià(
ex‹Á_¡¬t
 != 0)

604 
cÚŒŞ
->
sub_by‹s
 +ğ
num_dec
;

606 
ş—r_Ën
 = 
num_dec
;

607 } ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
) {

612 ià(!
d–_™em
 &&

613 
	`bŒfs_fe_ex‹Á_’üy±iÚ
(
Ëaf
, 
fi
) == 0 &&

614 
	`bŒfs_fe_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
fi
) == 0 &&

615 
	`bŒfs_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
) == 0) {

616 
u32
 
size
 = (u32)(
Ãw_size
 - 
found_key
.
off£t
);

618 
	`bŒfs_£t_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
, 
size
);

619 
size
 = 
	`bŒfs_fe_ex‹Á_ÿlc_šlše_size
(size);

620 
	`bŒfs_Œunÿ‹_™em
(
Œªs
, 
·th
, 
size
, 1);

621 } ià(!
d–_™em
) {

626 
»t
 = 
BTRFS_NEED_TRUNCATE_BLOCK
;

634 
ş—r_Ën
 = 
fs_šfo
->
£ùÜsize
;

637 
cÚŒŞ
->
sub_by‹s
 +ğ
™em_’d
 + 1 - 
Ãw_size
;

639 
d–‘e
:

645 ià(
cÚŒŞ
->
ş—r_ex‹Á_¿nge
) {

646 
»t
 = 
	`bŒfs_šode_ş—r_fe_ex‹Á_¿nge
(
cÚŒŞ
->
šode
,

647 
ş—r_¡¬t
, 
ş—r_Ën
);

648 ià(
»t
) {

649 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

654 ià(
d–_™em
) {

655 
	`ASSERT
(!
³ndšg_d–_Ä
 ||

656 ((
·th
->
¦Ùs
[0] + 1è=ğ
³ndšg_d–_¦Ù
));

658 
cÚŒŞ
->
Ï¡_size
 = 
found_key
.
off£t
;

659 ià(!
³ndšg_d–_Ä
) {

661 
³ndšg_d–_¦Ù
 = 
·th
->
¦Ùs
[0];

662 
³ndšg_d–_Ä
 = 1;

663 } ià(
·th
->
¦Ùs
[0] + 1 =ğ
³ndšg_d–_¦Ù
) {

665 
³ndšg_d–_Ä
++;

666 
³ndšg_d–_¦Ù
 = 
·th
->
¦Ùs
[0];

669 
cÚŒŞ
->
Ï¡_size
 = 
Ãw_size
;

673 ià(
d–_™em
 && 
ex‹Á_¡¬t
 !ğ0 && !
cÚŒŞ
->
sk_»f_upd©es
) {

674 
bŒfs_»f
 
»f
 = { 0 };

676 
by‹s_d–‘ed
 +ğ
ex‹Á_num_by‹s
;

678 
	`bŒfs_š™_g’”ic_»f
(&
»f
, 
BTRFS_DROP_DELAYED_REF
,

679 
ex‹Á_¡¬t
, 
ex‹Á_num_by‹s
, 0);

680 
	`bŒfs_š™_d©a_»f
(&
»f
, 
	`bŒfs_h—d”_owÃr
(
Ëaf
),

681 
cÚŒŞ
->
šo
, 
ex‹Á_off£t
,

682 
roÙ
->
roÙ_key
.
objeùid
, 
çl£
);

683 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, &
»f
);

684 ià(
»t
) {

685 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

688 ià(
be_niû
 && 
	`bŒfs_check_¥aû_fÜ_d–ayed_»fs
(
fs_šfo
))

689 
»fl_d–ayed_»fs_rsv
 = 
Œue
;

692 ià(
found_ty³
 =ğ
BTRFS_INODE_ITEM_KEY
)

695 ià(
·th
->
¦Ùs
[0] == 0 ||

696 
·th
->
¦Ùs
[0] !ğ
³ndšg_d–_¦Ù
 ||

697 
»fl_d–ayed_»fs_rsv
) {

698 ià(
³ndšg_d–_Ä
) {

699 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
,

700 
³ndšg_d–_¦Ù
,

701 
³ndšg_d–_Ä
);

702 ià(
»t
) {

703 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

706 
³ndšg_d–_Ä
 = 0;

708 
	`bŒfs_»Ëa£_·th
(
·th
);

720 ià(
»fl_d–ayed_»fs_rsv
) {

721 
»t
 = 
	`bŒfs_d–ayed_»fs_rsv_»fl
(
fs_šfo
,

722 
BTRFS_RESERVE_NO_FLUSH
);

723 ià(
»t
) {

724 
»t
 = -
EAGAIN
;

728 
£¬ch_agaš
;

730 
·th
->
¦Ùs
[0]--;

733 
out
:

734 ià(
»t
 >ğ0 && 
³ndšg_d–_Ä
) {

735 
”r
;

737 
”r
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
, 
³ndšg_d–_¦Ù
,

738 
³ndšg_d–_Ä
);

739 ià(
”r
) {

740 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
”r
);

741 
»t
 = 
”r
;

745 
	`ASSERT
(
cÚŒŞ
->
Ï¡_size
 >ğ
Ãw_size
);

746 ià(!
»t
 && 
cÚŒŞ
->
Ï¡_size
 > 
Ãw_size
)

747 
cÚŒŞ
->
Ï¡_size
 = 
Ãw_size
;

749 
	`bŒfs_ä“_·th
(
·th
);

750  
»t
;

751 
	}
}

	@inode-item.h

3 #iâdeà
BTRFS_INODE_ITEM_H


4 
	#BTRFS_INODE_ITEM_H


	)

6 
	~<lšux/ty³s.h
>

8 
	gbŒfs_Œªs_hªdË
;

9 
	gbŒfs_roÙ
;

10 
	gbŒfs_·th
;

11 
	gbŒfs_key
;

12 
	gbŒfs_šode_exŒef
;

13 
	gbŒfs_šode
;

14 
	gex‹Á_bufãr
;

20 
	#BTRFS_NEED_TRUNCATE_BLOCK
 1

	)

22 
	sbŒfs_Œunÿ‹_cÚŒŞ
 {

27 
bŒfs_šode
 *
	mšode
;

30 
u64
 
	mÃw_size
;

33 
u64
 
	mex‹Ás_found
;

36 
u64
 
	mÏ¡_size
;

39 
u64
 
	msub_by‹s
;

42 
u64
 
	mšo
;

48 
u32
 
	mmš_ty³
;

54 
boŞ
 
	msk_»f_upd©es
;

60 
boŞ
 
	mş—r_ex‹Á_¿nge
;

67 
šlše
 
u64
 
	$bŒfs_šode_combše_æags
(
u32
 
æags
, u32 
ro_æags
)

69  (
æags
 | ((
u64
)
ro_æags
 << 32));

70 
	}
}

72 
šlše
 
	$bŒfs_šode_¥l™_æags
(
u64
 
šode_™em_æags
,

73 
u32
 *
æags
, u32 *
ro_æags
)

75 *
æags
 = (
u32
)
šode_™em_æags
;

76 *
ro_æags
 = (
u32
)(
šode_™em_æags
 >> 32);

77 
	}
}

79 
bŒfs_Œunÿ‹_šode_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

80 
bŒfs_roÙ
 *
roÙ
,

81 
bŒfs_Œunÿ‹_cÚŒŞ
 *
cÚŒŞ
);

82 
bŒfs_š£¹_šode_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

83 
bŒfs_roÙ
 *
roÙ
, cÚ¡ 
fsüy±_¡r
 *
Çme
,

84 
u64
 
šode_objeùid
, u64 
»f_objeùid
, u64 
šdex
);

85 
bŒfs_d–_šode_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

86 
bŒfs_roÙ
 *
roÙ
, cÚ¡ 
fsüy±_¡r
 *
Çme
,

87 
u64
 
šode_objeùid
, u64 
»f_objeùid
, u64 *
šdex
);

88 
bŒfs_š£¹_em±y_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

89 
bŒfs_roÙ
 *
roÙ
,

90 
bŒfs_·th
 *
·th
, 
u64
 
objeùid
);

91 
bŒfs_lookup_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

92 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

93 
bŒfs_key
 *
loÿtiÚ
, 
mod
);

95 
bŒfs_šode_exŒef
 *
bŒfs_lookup_šode_exŒef
(

96 
bŒfs_Œªs_hªdË
 *
Œªs
,

97 
bŒfs_roÙ
 *
roÙ
,

98 
bŒfs_·th
 *
·th
,

99 cÚ¡ 
fsüy±_¡r
 *
Çme
,

100 
u64
 
šode_objeùid
, u64 
»f_objeùid
, 
šs_Ën
,

101 
cow
);

103 
bŒfs_šode_»f
 *
bŒfs_fšd_Çme_š_back»f
(
ex‹Á_bufãr
 *
Ëaf
,

104 
¦Ù
,

105 cÚ¡ 
fsüy±_¡r
 *
Çme
);

106 
bŒfs_šode_exŒef
 *
bŒfs_fšd_Çme_š_ext_back»f
(

107 
ex‹Á_bufãr
 *
Ëaf
, 
¦Ù
, 
u64
 
»f_objeùid
,

108 cÚ¡ 
fsüy±_¡r
 *
Çme
);

	@inode.c

6 
	~<üy±o/hash.h
>

7 
	~<lšux/k”Ãl.h
>

8 
	~<lšux/bio.h
>

9 
	~<lšux/blk-cgroup.h
>

10 
	~<lšux/fe.h
>

11 
	~<lšux/fs.h
>

12 
	~<lšux/·gem­.h
>

13 
	~<lšux/highmem.h
>

14 
	~<lšux/time.h
>

15 
	~<lšux/š™.h
>

16 
	~<lšux/¡ršg.h
>

17 
	~<lšux/backšg-dev.h
>

18 
	~<lšux/wr™eback.h
>

19 
	~<lšux/com·t.h
>

20 
	~<lšux/x©Œ.h
>

21 
	~<lšux/posix_aş.h
>

22 
	~<lšux/çÎoc.h
>

23 
	~<lšux/¦ab.h
>

24 
	~<lšux/¿‹lim™.h
>

25 
	~<lšux/bŒfs.h
>

26 
	~<lšux/blkdev.h
>

27 
	~<lšux/posix_aş_x©Œ.h
>

28 
	~<lšux/uio.h
>

29 
	~<lšux/magic.h
>

30 
	~<lšux/iv”siÚ.h
>

31 
	~<lšux/sw­.h
>

32 
	~<lšux/mig¿‹.h
>

33 
	~<lšux/sched/mm.h
>

34 
	~<lšux/iom­.h
>

35 
	~<asm/uÇligÃd.h
>

36 
	~<lšux/fsv”™y.h
>

37 
	~<lšux/Çmei.h
>

38 
	~"misc.h
"

39 
	~"ù»e.h
"

40 
	~"disk-io.h
"

41 
	~"Œª§ùiÚ.h
"

42 
	~"bŒfs_šode.h
"

43 
	~"´št-Œ“.h
"

44 
	~"Üd”ed-d©a.h
"

45 
	~"x©Œ.h
"

46 
	~"Œ“-log.h
"

47 
	~"bio.h
"

48 
	~"com´essiÚ.h
"

49 
	~"lockšg.h
"

50 
	~"ä“-¥aû-ÿche.h
"

51 
	~"´İs.h
"

52 
	~"qgroup.h
"

53 
	~"d–®loc-¥aû.h
"

54 
	~"block-group.h
"

55 
	~"¥aû-šfo.h
"

56 
	~"zÚed.h
"

57 
	~"sub·ge.h
"

58 
	~"šode-™em.h
"

59 
	~"fs.h
"

60 
	~"acûssÜs.h
"

61 
	~"ex‹Á-Œ“.h
"

62 
	~"roÙ-Œ“.h
"

63 
	~"deäag.h
"

64 
	~"dœ-™em.h
"

65 
	~"fe-™em.h
"

66 
	~"uuid-Œ“.h
"

67 
	~"ioùl.h
"

68 
	~"fe.h
"

69 
	~"aş.h
"

70 
	~"»loÿtiÚ.h
"

71 
	~"v”™y.h
"

72 
	~"su³r.h
"

73 
	~"Üphª.h
"

74 
	~"back»f.h
"

75 
	~<lšux/ty³s.h
>

77 
bŒfs_fs_šfo
 *
glob®_fs_šfo_li¡
[
BTRFS_SUPER_INFO_COUNT
];

78 
©omic_t
 
	gglob®_ü—‹_couÁ
 = 
ATOMIC_INIT
(0);

80 
	sbŒfs_ig‘_¬gs
 {

81 
u64
 
	mšo
;

82 
bŒfs_roÙ
 *
	mroÙ
;

85 
	sbŒfs_dio_d©a
 {

86 
ssize_t
 
	msubm™‹d
;

87 
ex‹Á_chªge£t
 *
	md©a_»£rved
;

88 
bŒfs_Üd”ed_ex‹Á
 *
	mÜd”ed
;

89 
boŞ
 
	md©a_¥aû_»£rved
;

90 
boŞ
 
	mnocow_dÚe
;

93 
	sbŒfs_dio_´iv©e
 {

95 
u64
 
	mfe_off£t
;

96 
u32
 
	mby‹s
;

99 
bŒfs_bio
 
	mbbio
;

102 
bio_£t
 
	gbŒfs_dio_bio£t
;

104 
	sbŒfs_»Çme_ùx
 {

106 
u64
 
	mšdex
;

113 
	sd©a_»loc_w¬n
 {

114 
bŒfs_·th
 
	m·th
;

115 
bŒfs_fs_šfo
 *
	mfs_šfo
;

116 
u64
 
	mex‹Á_™em_size
;

117 
u64
 
	mlogiÿl
;

118 
	mmœrÜ_num
;

121 cÚ¡ 
šode_İ”©iÚs
 
	gbŒfs_dœ_šode_İ”©iÚs
;

122 cÚ¡ 
šode_İ”©iÚs
 
	gbŒfs_symlšk_šode_İ”©iÚs
;

123 cÚ¡ 
šode_İ”©iÚs
 
	gbŒfs_¥ecŸl_šode_İ”©iÚs
;

124 cÚ¡ 
šode_İ”©iÚs
 
	gbŒfs_fe_šode_İ”©iÚs
;

125 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gbŒfs_aİs
;

126 cÚ¡ 
fe_İ”©iÚs
 
	gbŒfs_dœ_fe_İ”©iÚs
;

128 
kmem_ÿche
 *
	gbŒfs_šode_ÿch•
;

130 
bŒfs_£tsize
(
šode
 *šode, 
Ÿ‰r
 *
©Œ
);

131 
bŒfs_Œunÿ‹
(
bŒfs_šode
 *
šode
, 
boŞ
 
sk_wr™eback
);

133 
nošlše
 
run_d–®loc_cow
(
bŒfs_šode
 *
šode
,

134 
·ge
 *
locked_·ge
, 
u64
 
¡¬t
,

135 
u64
 
’d
, 
wr™eback_cÚŒŞ
 *
wbc
,

136 
boŞ
 
·ges_dœty
);

137 
ex‹Á_m­
 *
ü—‹_io_em
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
,

138 
u64
 
Ën
, u64 
Üig_¡¬t
, u64 
block_¡¬t
,

139 
u64
 
block_Ën
, u64 
Üig_block_Ën
,

140 
u64
 
¿m_by‹s
, 
com´ess_ty³
,

141 
ty³
);

143 
	$d©a_»loc_´št_w¬nšg_šode
(
u64
 
šum
, u64 
off£t
, u64 
num_by‹s
,

144 
u64
 
roÙ
, *
w¬n_ùx
)

146 
d©a_»loc_w¬n
 *
w¬n
 = 
w¬n_ùx
;

147 
bŒfs_fs_šfo
 *
fs_šfo
 = 
w¬n
->fs_info;

148 
ex‹Á_bufãr
 *
eb
;

149 
bŒfs_šode_™em
 *
šode_™em
;

150 
šode_fs_·ths
 *
©h
 = 
NULL
;

151 
bŒfs_roÙ
 *
loÿl_roÙ
;

152 
bŒfs_key
 
key
;

153 
nofs_æag
;

154 
u32
 
Æšk
;

155 
»t
;

157 
loÿl_roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
roÙ
, 
Œue
);

158 ià(
	`IS_ERR
(
loÿl_roÙ
)) {

159 
»t
 = 
	`PTR_ERR
(
loÿl_roÙ
);

160 
”r
;

164 
key
.
objeùid
 = 
šum
;

165 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

166 
key
.
off£t
 = 0;

168 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
loÿl_roÙ
, &
key
, &
w¬n
->
·th
, 0, 0);

169 ià(
»t
) {

170 
	`bŒfs_put_roÙ
(
loÿl_roÙ
);

171 
	`bŒfs_»Ëa£_·th
(&
w¬n
->
·th
);

172 
”r
;

175 
eb
 = 
w¬n
->
·th
.
nodes
[0];

176 
šode_™em
 = 
	`bŒfs_™em_±r
(
eb
, 
w¬n
->
·th
.
¦Ùs
[0], 
bŒfs_šode_™em
);

177 
Æšk
 = 
	`bŒfs_šode_Æšk
(
eb
, 
šode_™em
);

178 
	`bŒfs_»Ëa£_·th
(&
w¬n
->
·th
);

180 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

181 
©h
 = 
	`š™_©h
(4096, 
loÿl_roÙ
, &
w¬n
->
·th
);

182 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

183 ià(
	`IS_ERR
(
©h
)) {

184 
	`bŒfs_put_roÙ
(
loÿl_roÙ
);

185 
»t
 = 
	`PTR_ERR
(
©h
);

186 
©h
 = 
NULL
;

191 
	`bŒfs_w¬n
(
fs_šfo
,

193 
w¬n
->
logiÿl
, w¬n->
mœrÜ_num
, 
roÙ
, 
šum
, 
off£t
);

194  
»t
;

196 
»t
 = 
	`·ths_äom_šode
(
šum
, 
©h
);

197 ià(
»t
 < 0)

198 
”r
;

204 
i
 = 0; i < 
©h
->
f¥©h
->
–em_út
; i++) {

205 
	`bŒfs_w¬n
(
fs_šfo
,

207 
w¬n
->
logiÿl
, w¬n->
mœrÜ_num
, 
roÙ
, 
šum
, 
off£t
,

208 
fs_šfo
->
£ùÜsize
, 
Æšk
,

209 (*)()
©h
->
f¥©h
->
v®
[
i
]);

212 
	`bŒfs_put_roÙ
(
loÿl_roÙ
);

213 
	`ä“_©h
(
©h
);

216 
”r
:

217 
	`bŒfs_w¬n
(
fs_šfo
,

219 
w¬n
->
logiÿl
, w¬n->
mœrÜ_num
, 
roÙ
, 
šum
, 
off£t
, 
»t
);

221 
	`ä“_©h
(
©h
);

222  
»t
;

223 
	}
}

231 
	$´št_d©a_»loc_”rÜ
(cÚ¡ 
bŒfs_šode
 *
šode
, 
u64
 
fe_off
,

232 cÚ¡ 
u8
 *
csum
, cÚ¡ u8 *
csum_ex³ùed
,

233 
mœrÜ_num
)

235 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

236 
bŒfs_·th
 
·th
 = { 0 };

237 
bŒfs_key
 
found_key
 = { 0 };

238 
ex‹Á_bufãr
 *
eb
;

239 
bŒfs_ex‹Á_™em
 *
ei
;

240 cÚ¡ 
u32
 
csum_size
 = 
fs_šfo
->csum_size;

241 
u64
 
logiÿl
;

242 
u64
 
æags
;

243 
u32
 
™em_size
;

244 
»t
;

246 
	`mu‹x_lock
(&
fs_šfo
->
»loc_mu‹x
);

247 
logiÿl
 = 
	`bŒfs_g‘_»loc_bg_by‹Ä
(
fs_šfo
);

248 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

250 ià(
logiÿl
 =ğ
U64_MAX
) {

251 
	`bŒfs_w¬n_¾
(
fs_šfo
, "has data„elocree but‚o„unning„elocation");

252 
	`bŒfs_w¬n_¾
(
fs_šfo
,

253 "csum faed„oÙ %Îd inØ%Îu ofà%Îu csum " 
CSUM_FMT
 "ƒxpected csum " CSUM_FMT " mirror %d",

254 
šode
->
roÙ
->
roÙ_key
.
objeùid
, 
	`bŒfs_šo
(šode), 
fe_off
,

255 
	`CSUM_FMT_VALUE
(
csum_size
, 
csum
),

256 
	`CSUM_FMT_VALUE
(
csum_size
, 
csum_ex³ùed
),

257 
mœrÜ_num
);

261 
logiÿl
 +ğ
fe_off
;

262 
	`bŒfs_w¬n_¾
(
fs_šfo
,

263 "csum faed„oÙ %Îd inØ%Îu ofà%Îu†ogiÿÈ%Îu csum " 
CSUM_FMT
 "ƒxpected csum " CSUM_FMT " mirror %d",

264 
šode
->
roÙ
->
roÙ_key
.
objeùid
,

265 
	`bŒfs_šo
(
šode
), 
fe_off
, 
logiÿl
,

266 
	`CSUM_FMT_VALUE
(
csum_size
, 
csum
),

267 
	`CSUM_FMT_VALUE
(
csum_size
, 
csum_ex³ùed
),

268 
mœrÜ_num
);

270 
»t
 = 
	`ex‹Á_äom_logiÿl
(
fs_šfo
, 
logiÿl
, &
·th
, &
found_key
, &
æags
);

271 ià(
»t
 < 0) {

272 
	`bŒfs_”r_¾
(
fs_šfo
, "failedo†ookupƒxtent item for†ogical %llu: %d",

273 
logiÿl
, 
»t
);

276 
eb
 = 
·th
.
nodes
[0];

277 
ei
 = 
	`bŒfs_™em_±r
(
eb
, 
·th
.
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

278 
™em_size
 = 
	`bŒfs_™em_size
(
eb
, 
·th
.
¦Ùs
[0]);

279 ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

280 
±r
 = 0;

281 
u64
 
»f_roÙ
;

282 
u8
 
»f_Ëv–
;

284 
Œue
) {

285 
»t
 = 
	`Œ“_back»f_fÜ_ex‹Á
(&
±r
, 
eb
, &
found_key
, 
ei
,

286 
™em_size
, &
»f_roÙ
,

287 &
»f_Ëv–
);

288 ià(
»t
 < 0) {

289 
	`bŒfs_w¬n_¾
(
fs_šfo
,

291 
logiÿl
, 
»t
);

294 ià(
»t
 > 0)

297 
	`bŒfs_w¬n_¾
(
fs_šfo
,

299 
logiÿl
, 
mœrÜ_num
,

300 (
»f_Ëv–
 ? "node" : "leaf"),

301 
»f_Ëv–
, 
»f_roÙ
);

303 
	`bŒfs_»Ëa£_·th
(&
·th
);

305 
bŒfs_back»f_w®k_ùx
 
ùx
 = { 0 };

306 
d©a_»loc_w¬n
 
»loc_w¬n
 = { 0 };

308 
	`bŒfs_»Ëa£_·th
(&
·th
);

310 
ùx
.
by‹Ä
 = 
found_key
.
objeùid
;

311 
ùx
.
ex‹Á_™em_pos
 = 
logiÿl
 - 
found_key
.
objeùid
;

312 
ùx
.
fs_šfo
 = fs_info;

314 
»loc_w¬n
.
logiÿl
 =†ogical;

315 
»loc_w¬n
.
ex‹Á_™em_size
 = 
found_key
.
off£t
;

316 
»loc_w¬n
.
mœrÜ_num
 = mirror_num;

317 
»loc_w¬n
.
fs_šfo
 = fs_info;

319 
	`™”©e_ex‹Á_šodes
(&
ùx
, 
Œue
,

320 
d©a_»loc_´št_w¬nšg_šode
, &
»loc_w¬n
);

322 
	}
}

324 
__cŞd
 
	$bŒfs_´št_d©a_csum_”rÜ
(
bŒfs_šode
 *
šode
,

325 
u64
 
logiÿl_¡¬t
, 
u8
 *
csum
, u8 *
csum_ex³ùed
, 
mœrÜ_num
)

327 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

328 cÚ¡ 
u32
 
csum_size
 = 
roÙ
->
fs_šfo
->csum_size;

331 ià(
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_DATA_RELOC_TREE_OBJECTID
)

332  
	`´št_d©a_»loc_”rÜ
(
šode
, 
logiÿl_¡¬t
, 
csum
,

333 
csum_ex³ùed
, 
mœrÜ_num
);

355 
	}
}

367 
	$bŒfs_šode_lock
(
bŒfs_šode
 *
šode
, 
ock_æags
)

369 ià(
ock_æags
 & 
BTRFS_ILOCK_SHARED
) {

370 ià(
ock_æags
 & 
BTRFS_ILOCK_TRY
) {

371 ià(!
	`šode_Œylock_sh¬ed
(&
šode
->
vfs_šode
))

372  -
EAGAIN
;

376 
	`šode_lock_sh¬ed
(&
šode
->
vfs_šode
);

378 ià(
ock_æags
 & 
BTRFS_ILOCK_TRY
) {

379 ià(!
	`šode_Œylock
(&
šode
->
vfs_šode
))

380  -
EAGAIN
;

384 
	`šode_lock
(&
šode
->
vfs_šode
);

386 ià(
ock_æags
 & 
BTRFS_ILOCK_MMAP
)

387 
	`down_wr™e
(&
šode
->
i_mm­_lock
);

389 
	}
}

397 
	$bŒfs_šode_uÆock
(
bŒfs_šode
 *
šode
, 
ock_æags
)

399 ià(
ock_æags
 & 
BTRFS_ILOCK_MMAP
)

400 
	`up_wr™e
(&
šode
->
i_mm­_lock
);

401 ià(
ock_æags
 & 
BTRFS_ILOCK_SHARED
)

402 
	`šode_uÆock_sh¬ed
(&
šode
->
vfs_šode
);

404 
	`šode_uÆock
(&
šode
->
vfs_šode
);

405 
	}
}

417 
šlše
 
	$bŒfs_ş—nup_Üd”ed_ex‹Ás
(
bŒfs_šode
 *
šode
,

418 
·ge
 *
locked_·ge
,

419 
u64
 
off£t
, u64 
by‹s
)

421 
šdex
 = 
off£t
 >> 
PAGE_SHIFT
;

422 
’d_šdex
 = (
off£t
 + 
by‹s
 - 1è>> 
PAGE_SHIFT
;

423 
u64
 
·ge_¡¬t
 = 0, 
·ge_’d
 = 0;

424 
·ge
 *page;

426 ià(
locked_·ge
) {

427 
·ge_¡¬t
 = 
	`·ge_off£t
(
locked_·ge
);

428 
·ge_’d
 = 
·ge_¡¬t
 + 
PAGE_SIZE
 - 1;

431 
šdex
 <ğ
’d_šdex
) {

442 ià(
locked_·ge
 && 
šdex
 =ğ(
·ge_¡¬t
 >> 
PAGE_SHIFT
)) {

443 
šdex
++;

446 
·ge
 = 
	`fšd_g‘_·ge
(
šode
->
vfs_šode
.
i_m­pšg
, 
šdex
);

447 
šdex
++;

448 ià(!
·ge
)

456 
	`bŒfs_·ge_şamp_ş—r_Üd”ed
(
šode
->
roÙ
->
fs_šfo
, 
·ge
,

457 
off£t
, 
by‹s
);

458 
	`put_·ge
(
·ge
);

461 ià(
locked_·ge
) {

463 ià(
by‹s
 + 
off£t
 <ğ
·ge_¡¬t
 + 
PAGE_SIZE
)

471 ià(
·ge_¡¬t
 >ğ
off£t
 && 
·ge_’d
 <ğ(off£ˆ+ 
by‹s
 - 1)) {

472 
by‹s
 = 
off£t
 + by‹ - 
	`·ge_off£t
(
locked_·ge
è- 
PAGE_SIZE
;

473 
off£t
 = 
	`·ge_off£t
(
locked_·ge
è+ 
PAGE_SIZE
;

477  
	`bŒfs_m¬k_Üd”ed_io_fšished
(
šode
, 
NULL
, 
off£t
, 
by‹s
, 
çl£
);

478 
	}
}

480 
bŒfs_dœty_šode
(
bŒfs_šode
 *
šode
);

482 
	$bŒfs_š™_šode_£cur™y
(
bŒfs_Œªs_hªdË
 *
Œªs
,

483 
bŒfs_Ãw_šode_¬gs
 *
¬gs
)

485 
”r
;

487 ià(
¬gs
->
deçuÉ_aş
) {

488 
”r
 = 
	`__bŒfs_£t_aş
(
Œªs
, 
¬gs
->
šode
,‡rgs->
deçuÉ_aş
,

489 
ACL_TYPE_DEFAULT
);

490 ià(
”r
)

491  
”r
;

493 ià(
¬gs
->
aş
) {

494 
”r
 = 
	`__bŒfs_£t_aş
(
Œªs
, 
¬gs
->
šode
,‡rgs->
aş
, 
ACL_TYPE_ACCESS
);

495 ià(
”r
)

496  
”r
;

498 ià(!
¬gs
->
deçuÉ_aş
 && !¬gs->
aş
)

499 
	`ÿche_no_aş
(
¬gs
->
šode
);

500  
	`bŒfs_x©Œ_£cur™y_š™
(
Œªs
, 
¬gs
->
šode
,‡rgs->
dœ
,

501 &
¬gs
->
d’Œy
->
d_Çme
);

502 
	}
}

509 
	$š£¹_šlše_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

510 
bŒfs_·th
 *
·th
,

511 
bŒfs_šode
 *
šode
, 
boŞ
 
ex‹Á_š£¹ed
,

512 
size_t
 
size
, size_ˆ
com´es£d_size
,

513 
com´ess_ty³
,

514 
·ge
 **
com´es£d_·ges
,

515 
boŞ
 
upd©e_i_size
)

517 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

518 
ex‹Á_bufãr
 *
Ëaf
;

519 
·ge
 *·gğ
NULL
;

520 *
kaddr
;

521 
±r
;

522 
bŒfs_fe_ex‹Á_™em
 *
ei
;

523 
»t
;

524 
size_t
 
cur_size
 = 
size
;

525 
u64
 
i_size
;

527 
	`ASSERT
((
com´es£d_size
 > 0 && 
com´es£d_·ges
) ||

528 (
com´es£d_size
 =ğ0 && !
com´es£d_·ges
));

530 ià(
com´es£d_size
 && 
com´es£d_·ges
)

531 
cur_size
 = 
com´es£d_size
;

533 ià(!
ex‹Á_š£¹ed
) {

534 
bŒfs_key
 
key
;

535 
size_t
 
d©asize
;

537 
key
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

538 
key
.
off£t
 = 0;

539 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

541 
d©asize
 = 
	`bŒfs_fe_ex‹Á_ÿlc_šlše_size
(
cur_size
);

542 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

543 
d©asize
);

544 ià(
»t
)

545 
ç
;

547 
Ëaf
 = 
·th
->
nodes
[0];

548 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

549 
bŒfs_fe_ex‹Á_™em
);

550 
	`bŒfs_£t_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
ei
, 
Œªs
->
Œªsid
);

551 
	`bŒfs_£t_fe_ex‹Á_ty³
(
Ëaf
, 
ei
, 
BTRFS_FILE_EXTENT_INLINE
);

552 
	`bŒfs_£t_fe_ex‹Á_’üy±iÚ
(
Ëaf
, 
ei
, 0);

553 
	`bŒfs_£t_fe_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
ei
, 0);

554 
	`bŒfs_£t_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
ei
, 
size
);

555 
±r
 = 
	`bŒfs_fe_ex‹Á_šlše_¡¬t
(
ei
);

557 ià(
com´ess_ty³
 !ğ
BTRFS_COMPRESS_NONE
) {

558 
·ge
 *
ıage
;

559 
i
 = 0;

560 
com´es£d_size
 > 0) {

561 
ıage
 = 
com´es£d_·ges
[
i
];

562 
cur_size
 = 
	`mš_t
(, 
com´es£d_size
,

563 
PAGE_SIZE
);

565 
kaddr
 = 
	`km­_loÿl_·ge
(
ıage
);

566 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
kaddr
, 
±r
, 
cur_size
);

567 
	`kunm­_loÿl
(
kaddr
);

569 
i
++;

570 
±r
 +ğ
cur_size
;

571 
com´es£d_size
 -ğ
cur_size
;

573 
	`bŒfs_£t_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
ei
,

574 
com´ess_ty³
);

576 
·ge
 = 
	`fšd_g‘_·ge
(
šode
->
vfs_šode
.
i_m­pšg
, 0);

577 
	`bŒfs_£t_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
ei
, 0);

578 
kaddr
 = 
	`km­_loÿl_·ge
(
·ge
);

579 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
kaddr
, 
±r
, 
size
);

580 
	`kunm­_loÿl
(
kaddr
);

581 
	`put_·ge
(
·ge
);

583 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

584 
	`bŒfs_»Ëa£_·th
(
·th
);

590 
»t
 = 
	`bŒfs_šode_£t_fe_ex‹Á_¿nge
(
šode
, 0,

591 
	`ALIGN
(
size
, 
roÙ
->
fs_šfo
->
£ùÜsize
));

592 ià(
»t
)

593 
ç
;

602 
i_size
 = 
	`i_size_»ad
(&
šode
->
vfs_šode
);

603 ià(
upd©e_i_size
 && 
size
 > 
i_size
) {

604 
	`i_size_wr™e
(&
šode
->
vfs_šode
, 
size
);

605 
i_size
 = 
size
;

607 
šode
->
disk_i_size
 = 
i_size
;

609 
ç
:

610  
»t
;

611 
	}
}

619 
nošlše
 
	$cow_fe_¿nge_šlše
(
bŒfs_šode
 *
šode
, 
u64
 
size
,

620 
size_t
 
com´es£d_size
,

621 
com´ess_ty³
,

622 
·ge
 **
com´es£d_·ges
,

623 
boŞ
 
upd©e_i_size
)

625 
bŒfs_drİ_ex‹Ás_¬gs
 
drİ_¬gs
 = { 0 };

626 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

627 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

628 
bŒfs_Œªs_hªdË
 *
Œªs
;

629 
u64
 
d©a_Ën
 = (
com´es£d_size
 ?: 
size
);

630 
»t
;

631 
bŒfs_·th
 *
·th
;

639 ià(
size
 < 
	`i_size_»ad
(&
šode
->
vfs_šode
) ||

640 
size
 > 
fs_šfo
->
£ùÜsize
 ||

641 
d©a_Ën
 > 
	`BTRFS_MAX_INLINE_DATA_SIZE
(
fs_šfo
) ||

642 
d©a_Ën
 > 
fs_šfo
->
max_šlše
)

645 
·th
 = 
	`bŒfs_®loc_·th
();

646 ià(!
·th
)

647  -
ENOMEM
;

649 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

650 ià(
	`IS_ERR
(
Œªs
)) {

651 
	`bŒfs_ä“_·th
(
·th
);

652  
	`PTR_ERR
(
Œªs
);

654 
Œªs
->
block_rsv
 = &
šode
->block_rsv;

656 
drİ_¬gs
.
·th
 =…ath;

657 
drİ_¬gs
.
¡¬t
 = 0;

658 
drİ_¬gs
.
’d
 = 
fs_šfo
->
£ùÜsize
;

659 
drİ_¬gs
.
drİ_ÿche
 = 
Œue
;

660 
drİ_¬gs
.
»¶aû_ex‹Á
 = 
Œue
;

661 
drİ_¬gs
.
ex‹Á_™em_size
 = 
	`bŒfs_fe_ex‹Á_ÿlc_šlše_size
(
d©a_Ën
);

662 
»t
 = 
	`bŒfs_drİ_ex‹Ás
(
Œªs
, 
roÙ
, 
šode
, &
drİ_¬gs
);

663 ià(
»t
) {

664 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

665 
out
;

668 
»t
 = 
	`š£¹_šlše_ex‹Á
(
Œªs
, 
·th
, 
šode
, 
drİ_¬gs
.
ex‹Á_š£¹ed
,

669 
size
, 
com´es£d_size
, 
com´ess_ty³
,

670 
com´es£d_·ges
, 
upd©e_i_size
);

671 ià(
»t
 &&„‘ !ğ-
ENOSPC
) {

672 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

673 
out
;

674 } ià(
»t
 =ğ-
ENOSPC
) {

675 
»t
 = 1;

676 
out
;

679 
	`bŒfs_upd©e_šode_by‹s
(
šode
, 
size
, 
drİ_¬gs
.
by‹s_found
);

680 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

681 ià(
»t
 &&„‘ !ğ-
ENOSPC
) {

682 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

683 
out
;

684 } ià(
»t
 =ğ-
ENOSPC
) {

685 
»t
 = 1;

686 
out
;

689 
	`bŒfs_£t_šode_fuÎ_sync
(
šode
);

690 
out
:

697 
	`bŒfs_qgroup_ä“_d©a
(
šode
, 
NULL
, 0, 
PAGE_SIZE
, NULL);

698 
	`bŒfs_ä“_·th
(
·th
);

699 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

700  
»t
;

701 
	}
}

703 
	sasync_ex‹Á
 {

704 
u64
 
	m¡¬t
;

705 
u64
 
	m¿m_size
;

706 
u64
 
	mcom´es£d_size
;

707 
·ge
 **
	m·ges
;

708 
	mÄ_·ges
;

709 
	mcom´ess_ty³
;

710 
li¡_h—d
 
	mli¡
;

713 
	sasync_chunk
 {

714 
bŒfs_šode
 *
	mšode
;

715 
·ge
 *
	mlocked_·ge
;

716 
u64
 
	m¡¬t
;

717 
u64
 
	m’d
;

718 
blk_İf_t
 
	mwr™e_æags
;

719 
li¡_h—d
 
	mex‹Ás
;

720 
cgroup_subsys_¡©e
 *
	mblkcg_css
;

721 
bŒfs_wÜk
 
	mwÜk
;

722 
async_cow
 *
	masync_cow
;

725 
	sasync_cow
 {

726 
©omic_t
 
	mnum_chunks
;

727 
async_chunk
 
	mchunks
[];

730 
nošlše
 
	$add_async_ex‹Á
(
async_chunk
 *
cow
,

731 
u64
 
¡¬t
, u64 
¿m_size
,

732 
u64
 
com´es£d_size
,

733 
·ge
 **
·ges
,

734 
Ä_·ges
,

735 
com´ess_ty³
)

737 
async_ex‹Á
 *async_extent;

739 
async_ex‹Á
 = 
	`km®loc
((*async_ex‹Á), 
GFP_NOFS
);

740 
	`BUG_ON
(!
async_ex‹Á
);

741 
async_ex‹Á
->
¡¬t
 = start;

742 
async_ex‹Á
->
¿m_size
 =„am_size;

743 
async_ex‹Á
->
com´es£d_size
 = compressed_size;

744 
async_ex‹Á
->
·ges
 =…ages;

745 
async_ex‹Á
->
Ä_·ges
 =‚r_pages;

746 
async_ex‹Á
->
com´ess_ty³
 = compress_type;

747 
	`li¡_add_
(&
async_ex‹Á
->
li¡
, &
cow
->
ex‹Ás
);

749 
	}
}

755 
šlše
 
	$šode_Ãed_com´ess
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
,

756 
u64
 
’d
)

758 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

760 ià(!
	`bŒfs_šode_ÿn_com´ess
(
šode
)) {

761 
	`WARN
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
),

762 
KERN_ERR
 "BTRFS: unexpected compression for ino %llu\n",

763 
	`bŒfs_šo
(
šode
));

792 ià(
fs_šfo
->
£ùÜsize
 < 
PAGE_SIZE
) {

793 ià(!
	`PAGE_ALIGNED
(
¡¬t
) ||

794 !
	`PAGE_ALIGNED
(
’d
 + 1))

799 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
FORCE_COMPRESS
))

802 ià(
šode
->
deäag_com´ess
)

805 ià(
šode
->
æags
 & 
BTRFS_INODE_NOCOMPRESS
)

807 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
COMPRESS
) ||

808 
šode
->
æags
 & 
BTRFS_INODE_COMPRESS
 ||

809 
šode
->
´İ_com´ess
)

810  
	`bŒfs_com´ess_heuri¡ic
(&
šode
->
vfs_šode
, 
¡¬t
, 
’d
);

812 
	}
}

814 
šlše
 
	$šode_should_deäag
(
bŒfs_šode
 *
šode
,

815 
u64
 
¡¬t
, u64 
’d
, u64 
num_by‹s
, 
u32
 
sm®l_wr™e
)

818 ià(
num_by‹s
 < 
sm®l_wr™e
 &&

819 (
¡¬t
 > 0 || 
’d
 + 1 < 
šode
->
disk_i_size
))

820 
	`bŒfs_add_šode_deäag
(
NULL
, 
šode
, 
sm®l_wr™e
);

821 
	}
}

836 
	$com´ess_fe_¿nge
(
bŒfs_wÜk
 *
wÜk
)

838 
async_chunk
 *async_chunk =

839 
	`cÚš”_of
(
wÜk
, 
async_chunk
, work);

840 
bŒfs_šode
 *
šode
 = 
async_chunk
->inode;

841 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

842 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
vfs_šode
.
i_m­pšg
;

843 
u64
 
blocksize
 = 
fs_šfo
->
£ùÜsize
;

844 
u64
 
¡¬t
 = 
async_chunk
->start;

845 
u64
 
’d
 = 
async_chunk
->end;

846 
u64
 
aùu®_’d
;

847 
u64
 
i_size
;

848 
»t
 = 0;

849 
·ge
 **
·ges
;

850 
Ä_·ges
;

851 
tÙ®_com´es£d
 = 0;

852 
tÙ®_š
 = 0;

853 
poff
;

854 
i
;

855 
com´ess_ty³
 = 
fs_šfo
->compress_type;

857 
	`šode_should_deäag
(
šode
, 
¡¬t
, 
’d
,ƒnd - s¹ + 1, 
SZ_16K
);

864 
	`ex‹Á_¿nge_ş—r_dœty_fÜ_io
(&
šode
->
vfs_šode
, 
¡¬t
, 
’d
);

875 
	`b¬r›r
();

876 
i_size
 = 
	`i_size_»ad
(&
šode
->
vfs_šode
);

877 
	`b¬r›r
();

878 
aùu®_’d
 = 
	`mš_t
(
u64
, 
i_size
, 
’d
 + 1);

879 
agaš
:

880 
·ges
 = 
NULL
;

881 
Ä_·ges
 = (
’d
 >> 
PAGE_SHIFT
è- (
¡¬t
 >> PAGE_SHIFT) + 1;

882 
Ä_·ges
 = 
	`mš_t
(,‚r_·ges, 
BTRFS_MAX_COMPRESSED_PAGES
);

894 ià(
aùu®_’d
 <ğ
¡¬t
)

895 
ş—nup_ªd_ba_uncom´es£d
;

897 
tÙ®_com´es£d
 = 
aùu®_’d
 - 
¡¬t
;

903 ià(
tÙ®_com´es£d
 <ğ
blocksize
 &&

904 (
¡¬t
 > 0 || 
’d
 + 1 < 
šode
->
disk_i_size
))

905 
ş—nup_ªd_ba_uncom´es£d
;

912 ià(
blocksize
 < 
PAGE_SIZE
) {

913 ià(!
	`PAGE_ALIGNED
(
¡¬t
) ||

914 !
	`PAGE_ALIGNED
(
	`round_up
(
aùu®_’d
, 
blocksize
)))

915 
ş—nup_ªd_ba_uncom´es£d
;

918 
tÙ®_com´es£d
 = 
	`mš_t
(,otal_compressed,

919 
BTRFS_MAX_UNCOMPRESSED
);

920 
tÙ®_š
 = 0;

921 
»t
 = 0;

928 ià(!
	`šode_Ãed_com´ess
(
šode
, 
¡¬t
, 
’d
))

929 
ş—nup_ªd_ba_uncom´es£d
;

931 
·ges
 = 
	`kÿÎoc
(
Ä_·ges
, (
·ge
 *), 
GFP_NOFS
);

932 ià(!
·ges
) {

937 
ş—nup_ªd_ba_uncom´es£d
;

940 ià(
šode
->
deäag_com´ess
)

941 
com´ess_ty³
 = 
šode
->
deäag_com´ess
;

942 ià(
šode
->
´İ_com´ess
)

943 
com´ess_ty³
 = 
šode
->
´İ_com´ess
;

946 
»t
 = 
	`bŒfs_com´ess_·ges
(
com´ess_ty³
 | (
fs_šfo
->
com´ess_Ëv–
 << 4),

947 
m­pšg
, 
¡¬t
, 
·ges
, &
Ä_·ges
, &
tÙ®_š
,

948 &
tÙ®_com´es£d
);

949 ià(
»t
)

950 
m¬k_šcom´essibË
;

956 
poff
 = 
	`off£t_š_·ge
(
tÙ®_com´es£d
);

957 ià(
poff
)

958 
	`memz”o_·ge
(
·ges
[
Ä_·ges
 - 1], 
poff
, 
PAGE_SIZE
 -…off);

969 ià(
¡¬t
 =ğ0 && 
fs_šfo
->
£ùÜsize
 =ğ
PAGE_SIZE
) {

970 ià(
tÙ®_š
 < 
aùu®_’d
) {

971 
»t
 = 
	`cow_fe_¿nge_šlše
(
šode
, 
aùu®_’d
, 0,

972 
BTRFS_COMPRESS_NONE
, 
NULL
,

973 
çl£
);

975 
»t
 = 
	`cow_fe_¿nge_šlše
(
šode
, 
aùu®_’d
,

976 
tÙ®_com´es£d
,

977 
com´ess_ty³
, 
·ges
,

978 
çl£
);

980 ià(
»t
 <= 0) {

981 
ş—r_æags
 = 
EXTENT_DELALLOC
 |

982 
EXTENT_DELALLOC_NEW
 | 
EXTENT_DEFRAG
 |

983 
EXTENT_DO_ACCOUNTING
;

985 ià(
»t
 < 0)

986 
	`m­pšg_£t_”rÜ
(
m­pšg
, -
EIO
);

998 
	`ex‹Á_ş—r_uÆock_d–®loc
(
šode
, 
¡¬t
, 
’d
,

999 
NULL
,

1000 
ş—r_æags
,

1001 
PAGE_UNLOCK
 |

1002 
PAGE_START_WRITEBACK
 |

1003 
PAGE_END_WRITEBACK
);

1004 
ä“_·ges
;

1012 
tÙ®_com´es£d
 = 
	`ALIGN
ÑÙ®_com´es£d, 
blocksize
);

1019 
tÙ®_š
 = 
	`round_up
ÑÙ®_š, 
fs_šfo
->
£ùÜsize
);

1020 ià(
tÙ®_com´es£d
 + 
blocksize
 > 
tÙ®_š
)

1021 
m¬k_šcom´essibË
;

1027 
	`add_async_ex‹Á
(
async_chunk
, 
¡¬t
, 
tÙ®_š
, 
tÙ®_com´es£d
, 
·ges
,

1028 
Ä_·ges
, 
com´ess_ty³
);

1029 ià(
¡¬t
 + 
tÙ®_š
 < 
’d
) {

1030 
¡¬t
 +ğ
tÙ®_š
;

1031 
	`cÚd_»sched
();

1032 
agaš
;

1036 
m¬k_šcom´essibË
:

1037 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
FORCE_COMPRESS
è&& !
šode
->
´İ_com´ess
)

1038 
šode
->
æags
 |ğ
BTRFS_INODE_NOCOMPRESS
;

1039 
ş—nup_ªd_ba_uncom´es£d
:

1040 
	`add_async_ex‹Á
(
async_chunk
, 
¡¬t
, 
’d
 - s¹ + 1, 0, 
NULL
, 0,

1041 
BTRFS_COMPRESS_NONE
);

1042 
ä“_·ges
:

1043 ià(
·ges
) {

1044 
i
 = 0; i < 
Ä_·ges
; i++) {

1045 
	`WARN_ON
(
·ges
[
i
]->
m­pšg
);

1046 
	`put_·ge
(
·ges
[
i
]);

1048 
	`kä“
(
·ges
);

1050 
	}
}

1052 
	$ä“_async_ex‹Á_·ges
(
async_ex‹Á
 *async_extent)

1054 
i
;

1056 ià(!
async_ex‹Á
->
·ges
)

1059 
i
 = 0; i < 
async_ex‹Á
->
Ä_·ges
; i++) {

1060 
	`WARN_ON
(
async_ex‹Á
->
·ges
[
i
]->
m­pšg
);

1061 
	`put_·ge
(
async_ex‹Á
->
·ges
[
i
]);

1063 
	`kä“
(
async_ex‹Á
->
·ges
);

1064 
async_ex‹Á
->
Ä_·ges
 = 0;

1065 
async_ex‹Á
->
·ges
 = 
NULL
;

1066 
	}
}

1068 
	$subm™_uncom´es£d_¿nge
(
bŒfs_šode
 *
šode
,

1069 
async_ex‹Á
 *async_extent,

1070 
·ge
 *
locked_·ge
)

1072 
u64
 
¡¬t
 = 
async_ex‹Á
->start;

1073 
u64
 
’d
 = 
async_ex‹Á
->
¡¬t
 +‡sync_ex‹Á->
¿m_size
 - 1;

1074 
»t
;

1075 
wr™eback_cÚŒŞ
 
wbc
 = {

1076 .
sync_mode
 = 
WB_SYNC_ALL
,

1077 .
¿nge_¡¬t
 = 
¡¬t
,

1078 .
¿nge_’d
 = 
’d
,

1079 .
no_cgroup_owÃr
 = 1,

1082 
	`wbc_©ch_fd©awr™e_šode
(&
wbc
, &
šode
->
vfs_šode
);

1083 
»t
 = 
	`run_d–®loc_cow
(
šode
, 
locked_·ge
, 
¡¬t
, 
’d
, &
wbc
, 
çl£
);

1084 
	`wbc_d‘ach_šode
(&
wbc
);

1085 ià(
»t
 < 0) {

1086 
	`bŒfs_ş—nup_Üd”ed_ex‹Ás
(
šode
, 
locked_·ge
, 
¡¬t
, 
’d
 - start + 1);

1087 ià(
locked_·ge
) {

1088 cÚ¡ 
u64
 
·ge_¡¬t
 = 
	`·ge_off£t
(
locked_·ge
);

1090 
	`£t_·ge_wr™eback
(
locked_·ge
);

1091 
	`’d_·ge_wr™eback
(
locked_·ge
);

1092 
	`bŒfs_m¬k_Üd”ed_io_fšished
(
šode
, 
locked_·ge
,

1093 
·ge_¡¬t
, 
PAGE_SIZE
,

1094 !
»t
);

1095 
	`m­pšg_£t_”rÜ
(
locked_·ge
->
m­pšg
, 
»t
);

1096 
	`uÆock_·ge
(
locked_·ge
);

1099 
	}
}

1101 
	$subm™_Úe_async_ex‹Á
(
async_chunk
 *async_chunk,

1102 
async_ex‹Á
 *async_extent,

1103 
u64
 *
®loc_hšt
)

1105 
bŒfs_šode
 *
šode
 = 
async_chunk
->inode;

1106 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
šode
->io_tree;

1107 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

1108 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1109 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

1110 
bŒfs_key
 
šs
;

1111 
·ge
 *
locked_·ge
 = 
NULL
;

1112 
ex‹Á_m­
 *
em
;

1113 
»t
 = 0;

1114 
u64
 
¡¬t
 = 
async_ex‹Á
->start;

1115 
u64
 
’d
 = 
async_ex‹Á
->
¡¬t
 +‡sync_ex‹Á->
¿m_size
 - 1;

1117 ià(
async_chunk
->
blkcg_css
)

1118 
	`kth»ad_assocŸ‹_blkcg
(
async_chunk
->
blkcg_css
);

1124 ià(
async_chunk
->
locked_·ge
) {

1125 
u64
 
locked_·ge_¡¬t
 = 
	`·ge_off£t
(
async_chunk
->
locked_·ge
);

1126 
u64
 
locked_·ge_’d
 = 
locked_·ge_¡¬t
 + 
PAGE_SIZE
 - 1;

1128 ià(!(
¡¬t
 >ğ
locked_·ge_’d
 || 
’d
 <ğ
locked_·ge_¡¬t
))

1129 
locked_·ge
 = 
async_chunk
->locked_page;

1131 
	`lock_ex‹Á
(
io_Œ“
, 
¡¬t
, 
’d
, 
NULL
);

1133 ià(
async_ex‹Á
->
com´ess_ty³
 =ğ
BTRFS_COMPRESS_NONE
) {

1134 
	`subm™_uncom´es£d_¿nge
(
šode
, 
async_ex‹Á
, 
locked_·ge
);

1135 
dÚe
;

1138 
»t
 = 
	`bŒfs_»£rve_ex‹Á
(
roÙ
, 
async_ex‹Á
->
¿m_size
,

1139 
async_ex‹Á
->
com´es£d_size
,

1140 
async_ex‹Á
->
com´es£d_size
,

1141 0, *
®loc_hšt
, &
šs
, 1, 1);

1142 ià(
»t
) {

1150 
out_ä“
;

1154 
em
 = 
	`ü—‹_io_em
(
šode
, 
¡¬t
,

1155 
async_ex‹Á
->
¿m_size
,

1156 
¡¬t
,

1157 
šs
.
objeùid
,

1158 
šs
.
off£t
,

1159 
šs
.
off£t
,

1160 
async_ex‹Á
->
¿m_size
,

1161 
async_ex‹Á
->
com´ess_ty³
,

1162 
BTRFS_ORDERED_COMPRESSED
);

1163 ià(
	`IS_ERR
(
em
)) {

1164 
»t
 = 
	`PTR_ERR
(
em
);

1165 
out_ä“_»£rve
;

1167 
	`ä“_ex‹Á_m­
(
em
);

1169 
Üd”ed
 = 
	`bŒfs_®loc_Üd”ed_ex‹Á
(
šode
, 
¡¬t
,

1170 
async_ex‹Á
->
¿m_size
,

1171 
async_ex‹Á
->
¿m_size
,

1172 
šs
.
objeùid
,

1173 
šs
.
off£t
,

1175 1 << 
BTRFS_ORDERED_COMPRESSED
,

1176 
async_ex‹Á
->
com´ess_ty³
);

1177 ià(
	`IS_ERR
(
Üd”ed
)) {

1178 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
šode
, 
¡¬t
, 
’d
, 
çl£
);

1179 
»t
 = 
	`PTR_ERR
(
Üd”ed
);

1180 
out_ä“_»£rve
;

1182 
	`bŒfs_dec_block_group_»£rv©iÚs
(
fs_šfo
, 
šs
.
objeùid
);

1185 
	`ex‹Á_ş—r_uÆock_d–®loc
(
šode
, 
¡¬t
, 
’d
,

1186 
NULL
, 
EXTENT_LOCKED
 | 
EXTENT_DELALLOC
,

1187 
PAGE_UNLOCK
 | 
PAGE_START_WRITEBACK
);

1188 
	`bŒfs_subm™_com´es£d_wr™e
(
Üd”ed
,

1189 
async_ex‹Á
->
·ges
,

1190 
async_ex‹Á
->
Ä_·ges
,

1191 
async_chunk
->
wr™e_æags
, 
Œue
);

1192 *
®loc_hšt
 = 
šs
.
objeùid
 + ins.
off£t
;

1193 
dÚe
:

1194 ià(
async_chunk
->
blkcg_css
)

1195 
	`kth»ad_assocŸ‹_blkcg
(
NULL
);

1196 
	`kä“
(
async_ex‹Á
);

1199 
out_ä“_»£rve
:

1200 
	`bŒfs_dec_block_group_»£rv©iÚs
(
fs_šfo
, 
šs
.
objeùid
);

1201 
	`bŒfs_ä“_»£rved_ex‹Á
(
fs_šfo
, 
šs
.
objeùid
, ins.
off£t
, 1);

1202 
out_ä“
:

1203 
	`m­pšg_£t_”rÜ
(
šode
->
vfs_šode
.
i_m­pšg
, -
EIO
);

1204 
	`ex‹Á_ş—r_uÆock_d–®loc
(
šode
, 
¡¬t
, 
’d
,

1205 
NULL
, 
EXTENT_LOCKED
 | 
EXTENT_DELALLOC
 |

1206 
EXTENT_DELALLOC_NEW
 |

1207 
EXTENT_DEFRAG
 | 
EXTENT_DO_ACCOUNTING
,

1208 
PAGE_UNLOCK
 | 
PAGE_START_WRITEBACK
 |

1209 
PAGE_END_WRITEBACK
);

1210 
	`ä“_async_ex‹Á_·ges
(
async_ex‹Á
);

1211 ià(
async_chunk
->
blkcg_css
)

1212 
	`kth»ad_assocŸ‹_blkcg
(
NULL
);

1213 
	`bŒfs_debug
(
fs_šfo
,

1215 
roÙ
->
roÙ_key
.
objeùid
, 
	`bŒfs_šo
(
šode
), 
¡¬t
,

1216 
async_ex‹Á
->
¿m_size
, 
»t
);

1217 
	`kä“
(
async_ex‹Á
);

1218 
	}
}

1220 
u64
 
	$g‘_ex‹Á_®loÿtiÚ_hšt
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
,

1221 
u64
 
num_by‹s
)

1223 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
šode
->
ex‹Á_Œ“
;

1224 
ex‹Á_m­
 *
em
;

1225 
u64
 
®loc_hšt
 = 0;

1227 
	`»ad_lock
(&
em_Œ“
->
lock
);

1228 
em
 = 
	`£¬ch_ex‹Á_m­pšg
(
em_Œ“
, 
¡¬t
, 
num_by‹s
);

1229 ià(
em
) {

1235 ià(
em
->
block_¡¬t
 >ğ
EXTENT_MAP_LAST_BYTE
) {

1236 
	`ä“_ex‹Á_m­
(
em
);

1237 
em
 = 
	`£¬ch_ex‹Á_m­pšg
(
em_Œ“
, 0, 0);

1238 ià(
em
 &&ƒm->
block_¡¬t
 < 
EXTENT_MAP_LAST_BYTE
)

1239 
®loc_hšt
 = 
em
->
block_¡¬t
;

1240 ià(
em
)

1241 
	`ä“_ex‹Á_m­
(
em
);

1243 
®loc_hšt
 = 
em
->
block_¡¬t
;

1244 
	`ä“_ex‹Á_m­
(
em
);

1247 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

1249  
®loc_hšt
;

1250 
	}
}

1280 
nošlše
 
	$cow_fe_¿nge
(
bŒfs_šode
 *
šode
,

1281 
·ge
 *
locked_·ge
, 
u64
 
¡¬t
, u64 
’d
,

1282 
u64
 *
dÚe_off£t
,

1283 
boŞ
 
k“p_locked
, boŞ 
no_šlše
)

1285 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

1286 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1287 
u64
 
®loc_hšt
 = 0;

1288 
u64
 
Üig_¡¬t
 = 
¡¬t
;

1289 
u64
 
num_by‹s
;

1290 
¿m_size
;

1291 
u64
 
cur_®loc_size
 = 0;

1292 
u64
 
mš_®loc_size
;

1293 
u64
 
blocksize
 = 
fs_šfo
->
£ùÜsize
;

1294 
bŒfs_key
 
šs
;

1295 
ex‹Á_m­
 *
em
;

1296 
ş—r_b™s
;

1297 
·ge_İs
;

1298 
boŞ
 
ex‹Á_»£rved
 = 
çl£
;

1299 
»t
 = 0;

1301 ià(
	`bŒfs_is_ä“_¥aû_šode
(
šode
)) {

1302 
»t
 = -
EINVAL
;

1303 
out_uÆock
;

1306 
num_by‹s
 = 
	`ALIGN
(
’d
 - 
¡¬t
 + 1, 
blocksize
);

1307 
num_by‹s
 = 
	`max
(
blocksize
,‚um_bytes);

1308 
	`ASSERT
(
num_by‹s
 <ğ
	`bŒfs_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cİy
));

1310 
	`šode_should_deäag
(
šode
, 
¡¬t
, 
’d
, 
num_by‹s
, 
SZ_64K
);

1322 ià(
¡¬t
 =ğ0 && 
fs_šfo
->
£ùÜsize
 =ğ
PAGE_SIZE
 && !
no_šlše
) {

1323 
u64
 
aùu®_’d
 = 
	`mš_t
(u64, 
	`i_size_»ad
(&
šode
->
vfs_šode
),

1324 
’d
 + 1);

1327 
»t
 = 
	`cow_fe_¿nge_šlše
(
šode
, 
aùu®_’d
, 0,

1328 
BTRFS_COMPRESS_NONE
, 
NULL
, 
çl£
);

1329 ià(
»t
 == 0) {

1336 
	`ex‹Á_ş—r_uÆock_d–®loc
(
šode
, 
¡¬t
, 
’d
,

1337 
locked_·ge
,

1338 
EXTENT_LOCKED
 | 
EXTENT_DELALLOC
 |

1339 
EXTENT_DELALLOC_NEW
 | 
EXTENT_DEFRAG
 |

1340 
EXTENT_DO_ACCOUNTING
, 
PAGE_UNLOCK
 |

1341 
PAGE_START_WRITEBACK
 | 
PAGE_END_WRITEBACK
);

1354 
	`uÆock_·ge
(
locked_·ge
);

1355 
»t
 = 1;

1356 
dÚe
;

1357 } ià(
»t
 < 0) {

1358 
out_uÆock
;

1362 
®loc_hšt
 = 
	`g‘_ex‹Á_®loÿtiÚ_hšt
(
šode
, 
¡¬t
, 
num_by‹s
);

1375 ià(
	`bŒfs_is_d©a_»loc_roÙ
(
roÙ
))

1376 
mš_®loc_size
 = 
num_by‹s
;

1378 
mš_®loc_size
 = 
fs_šfo
->
£ùÜsize
;

1380 
num_by‹s
 > 0) {

1381 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

1383 
cur_®loc_size
 = 
num_by‹s
;

1384 
»t
 = 
	`bŒfs_»£rve_ex‹Á
(
roÙ
, 
cur_®loc_size
, cur_alloc_size,

1385 
mš_®loc_size
, 0, 
®loc_hšt
,

1386 &
šs
, 1, 1);

1387 ià(
»t
 =ğ-
EAGAIN
) {

1399 
	`ASSERT
(
	`bŒfs_is_zÚed
(
fs_šfo
));

1400 ià(
¡¬t
 =ğ
Üig_¡¬t
) {

1401 
	`wa™_Ú_b™_io
(&
šode
->
roÙ
->
fs_šfo
->
æags
,

1402 
BTRFS_FS_NEED_ZONE_FINISH
,

1403 
TASK_UNINTERRUPTIBLE
);

1406 ià(
dÚe_off£t
) {

1407 *
dÚe_off£t
 = 
¡¬t
 - 1;

1410 
»t
 = -
ENOSPC
;

1412 ià(
»t
 < 0)

1413 
out_uÆock
;

1414 
cur_®loc_size
 = 
šs
.
off£t
;

1415 
ex‹Á_»£rved
 = 
Œue
;

1417 
¿m_size
 = 
šs
.
off£t
;

1420 
em
 = 
	`ü—‹_io_em
(
šode
, 
¡¬t
, 
šs
.
off£t
,

1421 
¡¬t
,

1422 
šs
.
objeùid
,

1423 
šs
.
off£t
,

1424 
šs
.
off£t
,

1425 
¿m_size
,

1426 
BTRFS_COMPRESS_NONE
,

1427 
BTRFS_ORDERED_REGULAR
 );

1428 ià(
	`IS_ERR
(
em
)) {

1429 
»t
 = 
	`PTR_ERR
(
em
);

1430 
out_»£rve
;

1432 
	`ä“_ex‹Á_m­
(
em
);

1434 
Üd”ed
 = 
	`bŒfs_®loc_Üd”ed_ex‹Á
(
šode
, 
¡¬t
, 
¿m_size
,

1435 
¿m_size
, 
šs
.
objeùid
, 
cur_®loc_size
,

1436 0, 1 << 
BTRFS_ORDERED_REGULAR
,

1437 
BTRFS_COMPRESS_NONE
);

1438 ià(
	`IS_ERR
(
Üd”ed
)) {

1439 
»t
 = 
	`PTR_ERR
(
Üd”ed
);

1440 
out_drİ_ex‹Á_ÿche
;

1443 ià(
	`bŒfs_is_d©a_»loc_roÙ
(
roÙ
)) {

1444 
»t
 = 
	`bŒfs_»loc_şÚe_csums
(
Üd”ed
);

1457 ià(
»t
)

1458 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
šode
, 
¡¬t
,

1459 
¡¬t
 + 
¿m_size
 - 1,

1460 
çl£
);

1462 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

1464 
	`bŒfs_dec_block_group_»£rv©iÚs
(
fs_šfo
, 
šs
.
objeùid
);

1474 
·ge_İs
 = (
k“p_locked
 ? 0 : 
PAGE_UNLOCK
);

1475 
·ge_İs
 |ğ
PAGE_SET_ORDERED
;

1477 
	`ex‹Á_ş—r_uÆock_d–®loc
(
šode
, 
¡¬t
, s¹ + 
¿m_size
 - 1,

1478 
locked_·ge
,

1479 
EXTENT_LOCKED
 | 
EXTENT_DELALLOC
,

1480 
·ge_İs
);

1481 ià(
num_by‹s
 < 
cur_®loc_size
)

1482 
num_by‹s
 = 0;

1484 
num_by‹s
 -ğ
cur_®loc_size
;

1485 
®loc_hšt
 = 
šs
.
objeùid
 + ins.
off£t
;

1486 
¡¬t
 +ğ
cur_®loc_size
;

1487 
ex‹Á_»£rved
 = 
çl£
;

1494 ià(
»t
)

1495 
out_uÆock
;

1497 
dÚe
:

1498 ià(
dÚe_off£t
)

1499 *
dÚe_off£t
 = 
’d
;

1500  
»t
;

1502 
out_drİ_ex‹Á_ÿche
:

1503 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
šode
, 
¡¬t
, s¹ + 
¿m_size
 - 1, 
çl£
);

1504 
out_»£rve
:

1505 
	`bŒfs_dec_block_group_»£rv©iÚs
(
fs_šfo
, 
šs
.
objeùid
);

1506 
	`bŒfs_ä“_»£rved_ex‹Á
(
fs_šfo
, 
šs
.
objeùid
, ins.
off£t
, 1);

1507 
out_uÆock
:

1517 
ş—r_b™s
 = 
EXTENT_LOCKED
 | 
EXTENT_DELALLOC
 | 
EXTENT_DELALLOC_NEW
 |

1518 
EXTENT_DEFRAG
 | 
EXTENT_CLEAR_META_RESV
;

1519 
·ge_İs
 = 
PAGE_UNLOCK
 | 
PAGE_START_WRITEBACK
 | 
PAGE_END_WRITEBACK
;

1533 ià(
k“p_locked
 && 
Üig_¡¬t
 < 
¡¬t
) {

1534 ià(!
locked_·ge
)

1535 
	`m­pšg_£t_”rÜ
(
šode
->
vfs_šode
.
i_m­pšg
, 
»t
);

1536 
	`ex‹Á_ş—r_uÆock_d–®loc
(
šode
, 
Üig_¡¬t
, 
¡¬t
 - 1,

1537 
locked_·ge
, 0, 
·ge_İs
);

1550 ià(
ex‹Á_»£rved
) {

1551 
	`ex‹Á_ş—r_uÆock_d–®loc
(
šode
, 
¡¬t
,

1552 
¡¬t
 + 
cur_®loc_size
 - 1,

1553 
locked_·ge
,

1554 
ş—r_b™s
,

1555 
·ge_İs
);

1556 
¡¬t
 +ğ
cur_®loc_size
;

1565 ià(
¡¬t
 < 
’d
) {

1566 
ş—r_b™s
 |ğ
EXTENT_CLEAR_DATA_RESV
;

1567 
	`ex‹Á_ş—r_uÆock_d–®loc
(
šode
, 
¡¬t
, 
’d
, 
locked_·ge
,

1568 
ş—r_b™s
, 
·ge_İs
);

1570  
»t
;

1571 
	}
}

1578 
nošlše
 
	$subm™_com´es£d_ex‹Ás
(
bŒfs_wÜk
 *
wÜk
)

1580 
async_chunk
 *async_chunk = 
	`cÚš”_of
(
wÜk
, async_chunk,

1581 
wÜk
);

1582 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_wÜk_owÃr
(
wÜk
);

1583 
async_ex‹Á
 *async_extent;

1584 
Ä_·ges
;

1585 
u64
 
®loc_hšt
 = 0;

1587 
Ä_·ges
 = (
async_chunk
->
’d
 -‡sync_chunk->
¡¬t
 + 
PAGE_SIZE
) >>

1588 
PAGE_SHIFT
;

1590 !
	`li¡_em±y
(&
async_chunk
->
ex‹Ás
)) {

1591 
async_ex‹Á
 = 
	`li¡_’Œy
(
async_chunk
->
ex‹Ás
.
Ãxt
,

1592 
async_ex‹Á
, 
li¡
);

1593 
	`li¡_d–
(&
async_ex‹Á
->
li¡
);

1594 
	`subm™_Úe_async_ex‹Á
(
async_chunk
, 
async_ex‹Á
, &
®loc_hšt
);

1598 ià(
	`©omic_sub_»tuº
(
Ä_·ges
, &
fs_šfo
->
async_d–®loc_·ges
) <

1599 5 * 
SZ_1M
)

1600 
	`cÚd_wake_up_nomb
(&
fs_šfo
->
async_subm™_wa™
);

1601 
	}
}

1603 
nošlše
 
	$async_cow_ä“
(
bŒfs_wÜk
 *
wÜk
)

1605 
async_chunk
 *async_chunk;

1606 
async_cow
 *async_cow;

1608 
async_chunk
 = 
	`cÚš”_of
(
wÜk
, async_chunk, work);

1609 
	`bŒfs_add_d–ayed_ut
(
async_chunk
->
šode
);

1610 ià(
async_chunk
->
blkcg_css
)

1611 
	`css_put
(
async_chunk
->
blkcg_css
);

1613 
async_cow
 = 
async_chunk
->async_cow;

1614 ià(
	`©omic_dec_ªd_‹¡
(&
async_cow
->
num_chunks
))

1615 
	`kvä“
(
async_cow
);

1616 
	}
}

1618 
boŞ
 
	$run_d–®loc_com´es£d
(
bŒfs_šode
 *
šode
,

1619 
·ge
 *
locked_·ge
, 
u64
 
¡¬t
,

1620 
u64
 
’d
, 
wr™eback_cÚŒŞ
 *
wbc
)

1622 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

1623 
cgroup_subsys_¡©e
 *
blkcg_css
 = 
	`wbc_blkcg_css
(
wbc
);

1624 
async_cow
 *
ùx
;

1625 
async_chunk
 *async_chunk;

1626 
Ä_·ges
;

1627 
u64
 
num_chunks
 = 
	`DIV_ROUND_UP
(
’d
 - 
¡¬t
, 
SZ_512K
);

1628 
i
;

1629 
nofs_æag
;

1630 cÚ¡ 
blk_İf_t
 
wr™e_æags
 = 
	`wbc_to_wr™e_æags
(
wbc
);

1632 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

1633 
ùx
 = 
	`kvm®loc
(
	`¡ruù_size
(ùx, 
chunks
, 
num_chunks
), 
GFP_KERNEL
);

1634 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

1635 ià(!
ùx
)

1636  
çl£
;

1638 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
¡¬t
, 
’d
, 
NULL
);

1639 
	`£t_b™
(
BTRFS_INODE_HAS_ASYNC_EXTENT
, &
šode
->
ruÁime_æags
);

1641 
async_chunk
 = 
ùx
->
chunks
;

1642 
	`©omic_£t
(&
ùx
->
num_chunks
,‚um_chunks);

1644 
i
 = 0; i < 
num_chunks
; i++) {

1645 
u64
 
cur_’d
 = 
	`mš
(
’d
, 
¡¬t
 + 
SZ_512K
 - 1);

1651 
	`ihŞd
(&
šode
->
vfs_šode
);

1652 
async_chunk
[
i
].
async_cow
 = 
ùx
;

1653 
async_chunk
[
i
].
šode
 = inode;

1654 
async_chunk
[
i
].
¡¬t
 = start;

1655 
async_chunk
[
i
].
’d
 = 
cur_’d
;

1656 
async_chunk
[
i
].
wr™e_æags
 = write_flags;

1657 
	`INIT_LIST_HEAD
(&
async_chunk
[
i
].
ex‹Ás
);

1668 ià(
locked_·ge
) {

1678 
	`wbc_accouÁ_cgroup_owÃr
(
wbc
, 
locked_·ge
,

1679 
cur_’d
 - 
¡¬t
);

1680 
async_chunk
[
i
].
locked_·ge
 =†ocked_page;

1681 
locked_·ge
 = 
NULL
;

1683 
async_chunk
[
i
].
locked_·ge
 = 
NULL
;

1686 ià(
blkcg_css
 !ğ
blkcg_roÙ_css
) {

1687 
	`css_g‘
(
blkcg_css
);

1688 
async_chunk
[
i
].
blkcg_css
 = blkcg_css;

1689 
async_chunk
[
i
].
wr™e_æags
 |ğ
REQ_BTRFS_CGROUP_PUNT
;

1691 
async_chunk
[
i
].
blkcg_css
 = 
NULL
;

1694 
	`bŒfs_š™_wÜk
(&
async_chunk
[
i
].
wÜk
, 
com´ess_fe_¿nge
,

1695 
subm™_com´es£d_ex‹Ás
, 
async_cow_ä“
);

1697 
Ä_·ges
 = 
	`DIV_ROUND_UP
(
cur_’d
 - 
¡¬t
, 
PAGE_SIZE
);

1698 
	`©omic_add
(
Ä_·ges
, &
fs_šfo
->
async_d–®loc_·ges
);

1700 
	`bŒfs_queue_wÜk
(
fs_šfo
->
d–®loc_wÜk”s
, &
async_chunk
[
i
].
wÜk
);

1702 
¡¬t
 = 
cur_’d
 + 1;

1704  
Œue
;

1705 
	}
}

1711 
nošlše
 
	$run_d–®loc_cow
(
bŒfs_šode
 *
šode
,

1712 
·ge
 *
locked_·ge
, 
u64
 
¡¬t
,

1713 
u64
 
’d
, 
wr™eback_cÚŒŞ
 *
wbc
,

1714 
boŞ
 
·ges_dœty
)

1716 
u64
 
dÚe_off£t
 = 
’d
;

1717 
»t
;

1719 
¡¬t
 <ğ
’d
) {

1720 
»t
 = 
	`cow_fe_¿nge
(
šode
, 
locked_·ge
, 
¡¬t
, 
’d
, &
dÚe_off£t
,

1721 
Œue
, 
çl£
);

1722 ià(
»t
)

1723  
»t
;

1724 
	`ex‹Á_wr™e_locked_¿nge
(&
šode
->
vfs_šode
, 
locked_·ge
, 
¡¬t
,

1725 
dÚe_off£t
, 
wbc
, 
·ges_dœty
);

1726 
¡¬t
 = 
dÚe_off£t
 + 1;

1730 
	}
}

1732 
nošlše
 
	$csum_exi¡_š_¿nge
(
bŒfs_fs_šfo
 *
fs_šfo
,

1733 
u64
 
by‹Ä
, u64 
num_by‹s
, 
boŞ
 
nowa™
)

1735 
bŒfs_roÙ
 *
csum_roÙ
 = 
	`bŒfs_csum_roÙ
(
fs_šfo
, 
by‹Ä
);

1736 
bŒfs_Üd”ed_sum
 *
sums
;

1737 
»t
;

1738 
	`LIST_HEAD
(
li¡
);

1740 
»t
 = 
	`bŒfs_lookup_csums_li¡
(
csum_roÙ
, 
by‹Ä
, by‹Ä + 
num_by‹s
 - 1,

1741 &
li¡
, 0, 
nowa™
);

1742 ià(
»t
 =ğ0 && 
	`li¡_em±y
(&
li¡
))

1745 !
	`li¡_em±y
(&
li¡
)) {

1746 
sums
 = 
	`li¡_’Œy
(
li¡
.
Ãxt
, 
bŒfs_Üd”ed_sum
,†ist);

1747 
	`li¡_d–
(&
sums
->
li¡
);

1748 
	`kä“
(
sums
);

1750 ià(
»t
 < 0)

1751  
»t
;

1753 
	}
}

1755 
	$çÎback_to_cow
(
bŒfs_šode
 *
šode
, 
·ge
 *
locked_·ge
,

1756 cÚ¡ 
u64
 
¡¬t
, cÚ¡ u64 
’d
)

1758 cÚ¡ 
boŞ
 
is_¥aû_šo
 = 
	`bŒfs_is_ä“_¥aû_šode
(
šode
);

1759 cÚ¡ 
boŞ
 
is_»loc_šo
 = 
	`bŒfs_is_d©a_»loc_roÙ
(
šode
->
roÙ
);

1760 cÚ¡ 
u64
 
¿nge_by‹s
 = 
’d
 + 1 - 
¡¬t
;

1761 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
šode
->io_tree;

1762 
u64
 
¿nge_¡¬t
 = 
¡¬t
;

1763 
u64
 
couÁ
;

1764 
»t
;

1798 
couÁ
 = 
	`couÁ_¿nge_b™s
(
io_Œ“
, &
¿nge_¡¬t
, 
’d
, 
¿nge_by‹s
,

1799 
EXTENT_NORESERVE
, 0, 
NULL
);

1800 ià(
couÁ
 > 0 || 
is_¥aû_šo
 || 
is_»loc_šo
) {

1801 
u64
 
by‹s
 = 
couÁ
;

1802 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

1803 
bŒfs_¥aû_šfo
 *
sšfo
 = 
fs_šfo
->
d©a_sšfo
;

1805 ià(
is_¥aû_šo
 || 
is_»loc_šo
)

1806 
by‹s
 = 
¿nge_by‹s
;

1808 
	`¥š_lock
(&
sšfo
->
lock
);

1809 
	`bŒfs_¥aû_šfo_upd©e_by‹s_may_u£
(
fs_šfo
, 
sšfo
, 
by‹s
);

1810 
	`¥š_uÆock
(&
sšfo
->
lock
);

1812 ià(
couÁ
 > 0)

1813 
	`ş—r_ex‹Á_b™
(
io_Œ“
, 
¡¬t
, 
’d
, 
EXTENT_NORESERVE
,

1814 
NULL
);

1822 
»t
 = 
	`cow_fe_¿nge
(
šode
, 
locked_·ge
, 
¡¬t
, 
’d
, 
NULL
, 
çl£
, 
Œue
);

1823 
	`ASSERT
(
»t
 != 1);

1824  
»t
;

1825 
	}
}

1827 
	sÿn_nocow_fe_ex‹Á_¬gs
 {

1831 
u64
 
	m¡¬t
;

1833 
u64
 
	m’d
;

1834 
boŞ
 
	mwr™eback_·th
;

1835 
boŞ
 
	m¡riù
;

1840 
boŞ
 
	mä“_·th
;

1844 
u64
 
	mdisk_by‹Ä
;

1845 
u64
 
	mdisk_num_by‹s
;

1846 
u64
 
	mex‹Á_off£t
;

1848 
u64
 
	mnum_by‹s
;

1860 
	$ÿn_nocow_fe_ex‹Á
(
bŒfs_·th
 *
·th
,

1861 
bŒfs_key
 *
key
,

1862 
bŒfs_šode
 *
šode
,

1863 
ÿn_nocow_fe_ex‹Á_¬gs
 *
¬gs
)

1865 cÚ¡ 
boŞ
 
is_ä“¥aû_šode
 = 
	`bŒfs_is_ä“_¥aû_šode
(
šode
);

1866 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

1867 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

1868 
bŒfs_fe_ex‹Á_™em
 *
fi
;

1869 
u64
 
ex‹Á_’d
;

1870 
u8
 
ex‹Á_ty³
;

1871 
ÿn_nocow
 = 0;

1872 
»t
 = 0;

1873 
boŞ
 
nowa™
 = 
·th
->nowait;

1875 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_fe_ex‹Á_™em
);

1876 
ex‹Á_ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
fi
);

1878 ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
)

1879 
out
;

1882 
¬gs
->
disk_by‹Ä
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
);

1883 
¬gs
->
disk_num_by‹s
 = 
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
);

1884 
¬gs
->
ex‹Á_off£t
 = 
	`bŒfs_fe_ex‹Á_off£t
(
Ëaf
, 
fi
);

1886 ià(!(
šode
->
æags
 & 
BTRFS_INODE_NODATACOW
) &&

1887 
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_REG
)

1888 
out
;

1895 ià(!
¬gs
->
¡riù
 &&

1896 
	`bŒfs_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
) <=

1897 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
))

1898 
out
;

1901 ià(
¬gs
->
disk_by‹Ä
 == 0)

1902 
out
;

1905 ià(
	`bŒfs_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
) ||

1906 
	`bŒfs_fe_ex‹Á_’üy±iÚ
(
Ëaf
, 
fi
) ||

1907 
	`bŒfs_fe_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
fi
))

1908 
out
;

1910 
ex‹Á_’d
 = 
	`bŒfs_fe_ex‹Á_’d
(
·th
);

1917 
	`bŒfs_»Ëa£_·th
(
·th
);

1919 
»t
 = 
	`bŒfs_üoss_»f_exi¡
(
roÙ
, 
	`bŒfs_šo
(
šode
),

1920 
key
->
off£t
 - 
¬gs
->
ex‹Á_off£t
,

1921 
¬gs
->
disk_by‹Ä
,‡rgs->
¡riù
, 
·th
);

1922 
	`WARN_ON_ONCE
(
»t
 > 0 && 
is_ä“¥aû_šode
);

1923 ià(
»t
 != 0)

1924 
out
;

1926 ià(
¬gs
->
ä“_·th
) {

1933 
	`bŒfs_ä“_·th
(
·th
);

1934 
·th
 = 
NULL
;

1938 ià(
¬gs
->
wr™eback_·th
 && !
is_ä“¥aû_šode
 &&

1939 
	`©omic_»ad
(&
roÙ
->
¢­shÙ_fÜû_cow
))

1940 
out
;

1942 
¬gs
->
disk_by‹Ä
 +ğ¬gs->
ex‹Á_off£t
;

1943 
¬gs
->
disk_by‹Ä
 +ğ¬gs->
¡¬t
 - 
key
->
off£t
;

1944 
¬gs
->
num_by‹s
 = 
	`mš
×rgs->
’d
 + 1, 
ex‹Á_’d
è-‡rgs->
¡¬t
;

1950 
»t
 = 
	`csum_exi¡_š_¿nge
(
roÙ
->
fs_šfo
, 
¬gs
->
disk_by‹Ä
,‡rgs->
num_by‹s
,

1951 
nowa™
);

1952 
	`WARN_ON_ONCE
(
»t
 > 0 && 
is_ä“¥aû_šode
);

1953 ià(
»t
 != 0)

1954 
out
;

1956 
ÿn_nocow
 = 1;

1957 
out
:

1958 ià(
¬gs
->
ä“_·th
 && 
·th
)

1959 
	`bŒfs_ä“_·th
(
·th
);

1961  
»t
 < 0 ?„‘ : 
ÿn_nocow
;

1962 
	}
}

1971 
nošlše
 
	$run_d–®loc_nocow
(
bŒfs_šode
 *
šode
,

1972 
·ge
 *
locked_·ge
,

1973 cÚ¡ 
u64
 
¡¬t
, cÚ¡ u64 
’d
)

1975 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

1976 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

1977 
bŒfs_·th
 *
·th
;

1978 
u64
 
cow_¡¬t
 = (u64)-1;

1979 
u64
 
cur_off£t
 = 
¡¬t
;

1980 
»t
;

1981 
boŞ
 
check_´ev
 = 
Œue
;

1982 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

1983 
ÿn_nocow_fe_ex‹Á_¬gs
 
nocow_¬gs
 = { 0 };

1990 
	`ASSERT
(!
	`bŒfs_is_zÚed
(
fs_šfo
è|| 
	`bŒfs_is_d©a_»loc_roÙ
(
roÙ
));

1992 
·th
 = 
	`bŒfs_®loc_·th
();

1993 ià(!
·th
) {

1994 
»t
 = -
ENOMEM
;

1995 
”rÜ
;

1998 
nocow_¬gs
.
’d
 =ƒnd;

1999 
nocow_¬gs
.
wr™eback_·th
 = 
Œue
;

2002 
bŒfs_block_group
 *
nocow_bg
 = 
NULL
;

2003 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

2004 
bŒfs_key
 
found_key
;

2005 
bŒfs_fe_ex‹Á_™em
 *
fi
;

2006 
ex‹Á_bufãr
 *
Ëaf
;

2007 
u64
 
ex‹Á_’d
;

2008 
u64
 
¿m_by‹s
;

2009 
u64
 
nocow_’d
;

2010 
ex‹Á_ty³
;

2011 
boŞ
 
is_´—Îoc
;

2013 
»t
 = 
	`bŒfs_lookup_fe_ex‹Á
(
NULL
, 
roÙ
, 
·th
, 
šo
,

2014 
cur_off£t
, 0);

2015 ià(
»t
 < 0)

2016 
”rÜ
;

2023 ià(
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0 && 
check_´ev
) {

2024 
Ëaf
 = 
·th
->
nodes
[0];

2025 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
,

2026 
·th
->
¦Ùs
[0] - 1);

2027 ià(
found_key
.
objeùid
 =ğ
šo
 &&

2028 
found_key
.
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
)

2029 
·th
->
¦Ùs
[0]--;

2031 
check_´ev
 = 
çl£
;

2032 
Ãxt_¦Ù
:

2034 
Ëaf
 = 
·th
->
nodes
[0];

2035 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

2036 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

2037 ià(
»t
 < 0)

2038 
”rÜ
;

2039 ià(
»t
 > 0)

2041 
Ëaf
 = 
·th
->
nodes
[0];

2044 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

2047 ià(
found_key
.
objeùid
 > 
šo
)

2053 ià(
	`WARN_ON_ONCE
(
found_key
.
objeùid
 < 
šo
) ||

2054 
found_key
.
ty³
 < 
BTRFS_EXTENT_DATA_KEY
) {

2055 
·th
->
¦Ùs
[0]++;

2056 
Ãxt_¦Ù
;

2060 ià(
found_key
.
ty³
 > 
BTRFS_EXTENT_DATA_KEY
 ||

2061 
found_key
.
off£t
 > 
’d
)

2068 ià(
found_key
.
off£t
 > 
cur_off£t
) {

2069 
ex‹Á_’d
 = 
found_key
.
off£t
;

2070 
ex‹Á_ty³
 = 0;

2071 
mu¡_cow
;

2078 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

2079 
bŒfs_fe_ex‹Á_™em
);

2080 
ex‹Á_ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
fi
);

2082 
	`ASSERT
(
ex‹Á_ty³
 < 
BTRFS_NR_FILE_EXTENT_TYPES
);

2083 ià(
	`WARN_ON
(
ex‹Á_ty³
 >ğ
BTRFS_NR_FILE_EXTENT_TYPES
)) {

2084 
»t
 = -
EUCLEAN
;

2085 
”rÜ
;

2087 
¿m_by‹s
 = 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
);

2088 
ex‹Á_’d
 = 
	`bŒfs_fe_ex‹Á_’d
(
·th
);

2094 ià(
ex‹Á_’d
 <ğ
cur_off£t
) {

2095 
·th
->
¦Ùs
[0]++;

2096 
Ãxt_¦Ù
;

2099 
nocow_¬gs
.
¡¬t
 = 
cur_off£t
;

2100 
»t
 = 
	`ÿn_nocow_fe_ex‹Á
(
·th
, &
found_key
, 
šode
, &
nocow_¬gs
);

2101 ià(
»t
 < 0)

2102 
”rÜ
;

2103 ià(
»t
 == 0)

2104 
mu¡_cow
;

2106 
»t
 = 0;

2107 
nocow_bg
 = 
	`bŒfs_šc_nocow_wr™”s
(
fs_šfo
, 
nocow_¬gs
.
disk_by‹Ä
);

2108 ià(!
nocow_bg
) {

2109 
mu¡_cow
:

2117 ià(
cow_¡¬t
 =ğ(
u64
)-1)

2118 
cow_¡¬t
 = 
cur_off£t
;

2119 
cur_off£t
 = 
ex‹Á_’d
;

2120 ià(
cur_off£t
 > 
’d
)

2122 ià(!
·th
->
nodes
[0])

2124 
·th
->
¦Ùs
[0]++;

2125 
Ãxt_¦Ù
;

2133 ià(
cow_¡¬t
 !ğ(
u64
)-1) {

2134 
»t
 = 
	`çÎback_to_cow
(
šode
, 
locked_·ge
,

2135 
cow_¡¬t
, 
found_key
.
off£t
 - 1);

2136 
cow_¡¬t
 = (
u64
)-1;

2137 ià(
»t
) {

2138 
	`bŒfs_dec_nocow_wr™”s
(
nocow_bg
);

2139 
”rÜ
;

2143 
nocow_’d
 = 
cur_off£t
 + 
nocow_¬gs
.
num_by‹s
 - 1;

2144 
is_´—Îoc
 = 
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
;

2145 ià(
is_´—Îoc
) {

2146 
u64
 
Üig_¡¬t
 = 
found_key
.
off£t
 - 
nocow_¬gs
.
ex‹Á_off£t
;

2147 
ex‹Á_m­
 *
em
;

2149 
em
 = 
	`ü—‹_io_em
(
šode
, 
cur_off£t
, 
nocow_¬gs
.
num_by‹s
,

2150 
Üig_¡¬t
,

2151 
nocow_¬gs
.
disk_by‹Ä
,

2152 
nocow_¬gs
.
num_by‹s
,

2153 
nocow_¬gs
.
disk_num_by‹s
,

2154 
¿m_by‹s
, 
BTRFS_COMPRESS_NONE
,

2155 
BTRFS_ORDERED_PREALLOC
);

2156 ià(
	`IS_ERR
(
em
)) {

2157 
	`bŒfs_dec_nocow_wr™”s
(
nocow_bg
);

2158 
»t
 = 
	`PTR_ERR
(
em
);

2159 
”rÜ
;

2161 
	`ä“_ex‹Á_m­
(
em
);

2164 
Üd”ed
 = 
	`bŒfs_®loc_Üd”ed_ex‹Á
(
šode
, 
cur_off£t
,

2165 
nocow_¬gs
.
num_by‹s
,‚ocow_args.num_bytes,

2166 
nocow_¬gs
.
disk_by‹Ä
,‚ocow_¬gs.
num_by‹s
, 0,

2167 
is_´—Îoc


2168 ? (1 << 
BTRFS_ORDERED_PREALLOC
)

2169 : (1 << 
BTRFS_ORDERED_NOCOW
),

2170 
BTRFS_COMPRESS_NONE
);

2171 
	`bŒfs_dec_nocow_wr™”s
(
nocow_bg
);

2172 ià(
	`IS_ERR
(
Üd”ed
)) {

2173 ià(
is_´—Îoc
) {

2174 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
šode
, 
cur_off£t
,

2175 
nocow_’d
, 
çl£
);

2177 
»t
 = 
	`PTR_ERR
(
Üd”ed
);

2178 
”rÜ
;

2181 ià(
	`bŒfs_is_d©a_»loc_roÙ
(
roÙ
))

2187 
»t
 = 
	`bŒfs_»loc_şÚe_csums
(
Üd”ed
);

2188 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

2190 
	`ex‹Á_ş—r_uÆock_d–®loc
(
šode
, 
cur_off£t
, 
nocow_’d
,

2191 
locked_·ge
, 
EXTENT_LOCKED
 |

2192 
EXTENT_DELALLOC
 |

2193 
EXTENT_CLEAR_DATA_RESV
,

2194 
PAGE_UNLOCK
 | 
PAGE_SET_ORDERED
);

2196 
cur_off£t
 = 
ex‹Á_’d
;

2203 ià(
»t
)

2204 
”rÜ
;

2205 ià(
cur_off£t
 > 
’d
)

2208 
	`bŒfs_»Ëa£_·th
(
·th
);

2210 ià(
cur_off£t
 <ğ
’d
 && 
cow_¡¬t
 =ğ(
u64
)-1)

2211 
cow_¡¬t
 = 
cur_off£t
;

2213 ià(
cow_¡¬t
 !ğ(
u64
)-1) {

2214 
cur_off£t
 = 
’d
;

2215 
»t
 = 
	`çÎback_to_cow
(
šode
, 
locked_·ge
, 
cow_¡¬t
, 
’d
);

2216 
cow_¡¬t
 = (
u64
)-1;

2217 ià(
»t
)

2218 
”rÜ
;

2221 
	`bŒfs_ä“_·th
(
·th
);

2224 
”rÜ
:

2230 ià(
cow_¡¬t
 !ğ(
u64
)-1)

2231 
cur_off£t
 = 
cow_¡¬t
;

2232 ià(
cur_off£t
 < 
’d
)

2233 
	`ex‹Á_ş—r_uÆock_d–®loc
(
šode
, 
cur_off£t
, 
’d
,

2234 
locked_·ge
, 
EXTENT_LOCKED
 |

2235 
EXTENT_DELALLOC
 | 
EXTENT_DEFRAG
 |

2236 
EXTENT_DO_ACCOUNTING
, 
PAGE_UNLOCK
 |

2237 
PAGE_START_WRITEBACK
 |

2238 
PAGE_END_WRITEBACK
);

2239 
	`bŒfs_ä“_·th
(
·th
);

2240  
»t
;

2241 
	}
}

2243 
boŞ
 
	$should_nocow
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
)

2245 ià(
šode
->
æags
 & (
BTRFS_INODE_NODATACOW
 | 
BTRFS_INODE_PREALLOC
)) {

2246 ià(
šode
->
deäag_by‹s
 &&

2247 
	`‹¡_¿nge_b™
(&
šode
->
io_Œ“
, 
¡¬t
, 
’d
, 
EXTENT_DEFRAG
,

2248 0, 
NULL
))

2249  
çl£
;

2250  
Œue
;

2252  
çl£
;

2253 
	}
}

2259 
	$bŒfs_run_d–®loc_¿nge
(
bŒfs_šode
 *
šode
, 
·ge
 *
locked_·ge
,

2260 
u64
 
¡¬t
, u64 
’d
, 
wr™eback_cÚŒŞ
 *
wbc
)

2262 cÚ¡ 
boŞ
 
zÚed
 = 
	`bŒfs_is_zÚed
(
šode
->
roÙ
->
fs_šfo
);

2263 
»t
;

2269 
	`ASSERT
(!(
’d
 <ğ
	`·ge_off£t
(
locked_·ge
) ||

2270 
¡¬t
 >ğ
	`·ge_off£t
(
locked_·ge
è+ 
PAGE_SIZE
));

2272 ià(
	`should_nocow
(
šode
, 
¡¬t
, 
’d
)) {

2273 
»t
 = 
	`run_d–®loc_nocow
(
šode
, 
locked_·ge
, 
¡¬t
, 
’d
);

2274 
out
;

2277 ià(
	`bŒfs_šode_ÿn_com´ess
(
šode
) &&

2278 
	`šode_Ãed_com´ess
(
šode
, 
¡¬t
, 
’d
) &&

2279 
	`run_d–®loc_com´es£d
(
šode
, 
locked_·ge
, 
¡¬t
, 
’d
, 
wbc
))

2282 ià(
zÚed
)

2283 
»t
 = 
	`run_d–®loc_cow
(
šode
, 
locked_·ge
, 
¡¬t
, 
’d
, 
wbc
,

2284 
Œue
);

2286 
»t
 = 
	`cow_fe_¿nge
(
šode
, 
locked_·ge
, 
¡¬t
, 
’d
, 
NULL
,

2287 
çl£
, false);

2289 
out
:

2290 ià(
»t
 < 0)

2291 
	`bŒfs_ş—nup_Üd”ed_ex‹Ás
(
šode
, 
locked_·ge
, 
¡¬t
,

2292 
’d
 - 
¡¬t
 + 1);

2293  
»t
;

2294 
	}
}

2296 
	$bŒfs_¥l™_d–®loc_ex‹Á
(
bŒfs_šode
 *
šode
,

2297 
ex‹Á_¡©e
 *
Üig
, 
u64
 
¥l™
)

2299 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

2300 
u64
 
size
;

2303 ià(!(
Üig
->
¡©e
 & 
EXTENT_DELALLOC
))

2306 
size
 = 
Üig
->
’d
 - orig->
¡¬t
 + 1;

2307 ià(
size
 > 
fs_šfo
->
max_ex‹Á_size
) {

2308 
u32
 
num_ex‹Ás
;

2309 
u64
 
Ãw_size
;

2315 
Ãw_size
 = 
Üig
->
’d
 - 
¥l™
 + 1;

2316 
num_ex‹Ás
 = 
	`couÁ_max_ex‹Ás
(
fs_šfo
, 
Ãw_size
);

2317 
Ãw_size
 = 
¥l™
 - 
Üig
->
¡¬t
;

2318 
num_ex‹Ás
 +ğ
	`couÁ_max_ex‹Ás
(
fs_šfo
, 
Ãw_size
);

2319 ià(
	`couÁ_max_ex‹Ás
(
fs_šfo
, 
size
è>ğ
num_ex‹Ás
)

2323 
	`¥š_lock
(&
šode
->
lock
);

2324 
	`bŒfs_mod_out¡ªdšg_ex‹Ás
(
šode
, 1);

2325 
	`¥š_uÆock
(&
šode
->
lock
);

2326 
	}
}

2333 
	$bŒfs_m”ge_d–®loc_ex‹Á
(
bŒfs_šode
 *
šode
, 
ex‹Á_¡©e
 *
Ãw
,

2334 
ex‹Á_¡©e
 *
Ùh”
)

2336 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

2337 
u64
 
Ãw_size
, 
Şd_size
;

2338 
u32
 
num_ex‹Ás
;

2341 ià(!(
Ùh”
->
¡©e
 & 
EXTENT_DELALLOC
))

2344 ià(
Ãw
->
¡¬t
 > 
Ùh”
->start)

2345 
Ãw_size
 = 
Ãw
->
’d
 - 
Ùh”
->
¡¬t
 + 1;

2347 
Ãw_size
 = 
Ùh”
->
’d
 - 
Ãw
->
¡¬t
 + 1;

2350 ià(
Ãw_size
 <ğ
fs_šfo
->
max_ex‹Á_size
) {

2351 
	`¥š_lock
(&
šode
->
lock
);

2352 
	`bŒfs_mod_out¡ªdšg_ex‹Ás
(
šode
, -1);

2353 
	`¥š_uÆock
(&
šode
->
lock
);

2375 
Şd_size
 = 
Ùh”
->
’d
 - oth”->
¡¬t
 + 1;

2376 
num_ex‹Ás
 = 
	`couÁ_max_ex‹Ás
(
fs_šfo
, 
Şd_size
);

2377 
Şd_size
 = 
Ãw
->
’d
 -‚ew->
¡¬t
 + 1;

2378 
num_ex‹Ás
 +ğ
	`couÁ_max_ex‹Ás
(
fs_šfo
, 
Şd_size
);

2379 ià(
	`couÁ_max_ex‹Ás
(
fs_šfo
, 
Ãw_size
è>ğ
num_ex‹Ás
)

2382 
	`¥š_lock
(&
šode
->
lock
);

2383 
	`bŒfs_mod_out¡ªdšg_ex‹Ás
(
šode
, -1);

2384 
	`¥š_uÆock
(&
šode
->
lock
);

2385 
	}
}

2387 
	$bŒfs_add_d–®loc_šodes
(
bŒfs_roÙ
 *
roÙ
,

2388 
bŒfs_šode
 *
šode
)

2390 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

2392 
	`¥š_lock
(&
roÙ
->
d–®loc_lock
);

2393 ià(
	`li¡_em±y
(&
šode
->
d–®loc_šodes
)) {

2394 
	`li¡_add_
(&
šode
->
d–®loc_šodes
, &
roÙ
->delalloc_inodes);

2395 
	`£t_b™
(
BTRFS_INODE_IN_DELALLOC_LIST
, &
šode
->
ruÁime_æags
);

2396 
roÙ
->
Ä_d–®loc_šodes
++;

2397 ià(
roÙ
->
Ä_d–®loc_šodes
 == 1) {

2398 
	`¥š_lock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

2399 
	`BUG_ON
(!
	`li¡_em±y
(&
roÙ
->
d–®loc_roÙ
));

2400 
	`li¡_add_
(&
roÙ
->
d–®loc_roÙ
,

2401 &
fs_šfo
->
d–®loc_roÙs
);

2402 
	`¥š_uÆock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

2405 
	`¥š_uÆock
(&
roÙ
->
d–®loc_lock
);

2406 
	}
}

2408 
	$__bŒfs_d–_d–®loc_šode
(
bŒfs_roÙ
 *
roÙ
,

2409 
bŒfs_šode
 *
šode
)

2411 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2413 ià(!
	`li¡_em±y
(&
šode
->
d–®loc_šodes
)) {

2414 
	`li¡_d–_š™
(&
šode
->
d–®loc_šodes
);

2415 
	`ş—r_b™
(
BTRFS_INODE_IN_DELALLOC_LIST
,

2416 &
šode
->
ruÁime_æags
);

2417 
roÙ
->
Ä_d–®loc_šodes
--;

2418 ià(!
roÙ
->
Ä_d–®loc_šodes
) {

2419 
	`ASSERT
(
	`li¡_em±y
(&
roÙ
->
d–®loc_šodes
));

2420 
	`¥š_lock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

2421 
	`BUG_ON
(
	`li¡_em±y
(&
roÙ
->
d–®loc_roÙ
));

2422 
	`li¡_d–_š™
(&
roÙ
->
d–®loc_roÙ
);

2423 
	`¥š_uÆock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

2426 
	}
}

2428 
	$bŒfs_d–_d–®loc_šode
(
bŒfs_roÙ
 *
roÙ
,

2429 
bŒfs_šode
 *
šode
)

2431 
	`¥š_lock
(&
roÙ
->
d–®loc_lock
);

2432 
	`__bŒfs_d–_d–®loc_šode
(
roÙ
, 
šode
);

2433 
	`¥š_uÆock
(&
roÙ
->
d–®loc_lock
);

2434 
	}
}

2440 
	$bŒfs_£t_d–®loc_ex‹Á
(
bŒfs_šode
 *
šode
, 
ex‹Á_¡©e
 *
¡©e
,

2441 
u32
 
b™s
)

2443 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

2445 ià((
b™s
 & 
EXTENT_DEFRAG
è&& !(b™ & 
EXTENT_DELALLOC
))

2446 
	`WARN_ON
(1);

2452 ià(!(
¡©e
->¡©& 
EXTENT_DELALLOC
è&& (
b™s
 & EXTENT_DELALLOC)) {

2453 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

2454 
u64
 
Ën
 = 
¡©e
->
’d
 + 1 - s‹->
¡¬t
;

2455 
u32
 
num_ex‹Ás
 = 
	`couÁ_max_ex‹Ás
(
fs_šfo
, 
Ën
);

2456 
boŞ
 
do_li¡
 = !
	`bŒfs_is_ä“_¥aû_šode
(
šode
);

2458 
	`¥š_lock
(&
šode
->
lock
);

2459 
	`bŒfs_mod_out¡ªdšg_ex‹Ás
(
šode
, 
num_ex‹Ás
);

2460 
	`¥š_uÆock
(&
šode
->
lock
);

2463 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
))

2466 
	`³rıu_couÁ”_add_b©ch
(&
fs_šfo
->
d–®loc_by‹s
, 
Ën
,

2467 
fs_šfo
->
d–®loc_b©ch
);

2468 
	`¥š_lock
(&
šode
->
lock
);

2469 
šode
->
d–®loc_by‹s
 +ğ
Ën
;

2470 ià(
b™s
 & 
EXTENT_DEFRAG
)

2471 
šode
->
deäag_by‹s
 +ğ
Ën
;

2472 ià(
do_li¡
 && !
	`‹¡_b™
(
BTRFS_INODE_IN_DELALLOC_LIST
,

2473 &
šode
->
ruÁime_æags
))

2474 
	`bŒfs_add_d–®loc_šodes
(
roÙ
, 
šode
);

2475 
	`¥š_uÆock
(&
šode
->
lock
);

2478 ià(!(
¡©e
->¡©& 
EXTENT_DELALLOC_NEW
) &&

2479 (
b™s
 & 
EXTENT_DELALLOC_NEW
)) {

2480 
	`¥š_lock
(&
šode
->
lock
);

2481 
šode
->
Ãw_d–®loc_by‹s
 +ğ
¡©e
->
’d
 + 1 - s‹->
¡¬t
;

2482 
	`¥š_uÆock
(&
šode
->
lock
);

2484 
	}
}

2490 
	$bŒfs_ş—r_d–®loc_ex‹Á
(
bŒfs_šode
 *
šode
,

2491 
ex‹Á_¡©e
 *
¡©e
, 
u32
 
b™s
)

2493 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

2494 
u64
 
Ën
 = 
¡©e
->
’d
 + 1 - s‹->
¡¬t
;

2495 
u32
 
num_ex‹Ás
 = 
	`couÁ_max_ex‹Ás
(
fs_šfo
, 
Ën
);

2497 ià((
¡©e
->¡©& 
EXTENT_DEFRAG
è&& (
b™s
 & EXTENT_DEFRAG)) {

2498 
	`¥š_lock
(&
šode
->
lock
);

2499 
šode
->
deäag_by‹s
 -ğ
Ën
;

2500 
	`¥š_uÆock
(&
šode
->
lock
);

2508 ià((
¡©e
->¡©& 
EXTENT_DELALLOC
è&& (
b™s
 & EXTENT_DELALLOC)) {

2509 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

2510 
boŞ
 
do_li¡
 = !
	`bŒfs_is_ä“_¥aû_šode
(
šode
);

2512 
	`¥š_lock
(&
šode
->
lock
);

2513 
	`bŒfs_mod_out¡ªdšg_ex‹Ás
(
šode
, -
num_ex‹Ás
);

2514 
	`¥š_uÆock
(&
šode
->
lock
);

2521 ià(
b™s
 & 
EXTENT_CLEAR_META_RESV
 &&

2522 
roÙ
 !ğ
fs_šfo
->
Œ“_roÙ
)

2523 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
šode
, 
Ën
, 
çl£
);

2526 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
))

2529 ià(!
	`bŒfs_is_d©a_»loc_roÙ
(
roÙ
) &&

2530 
do_li¡
 && !(
¡©e
->¡©& 
EXTENT_NORESERVE
) &&

2531 (
b™s
 & 
EXTENT_CLEAR_DATA_RESV
))

2532 
	`bŒfs_ä“_»£rved_d©a_¥aû_noquÙa
(
fs_šfo
, 
Ën
);

2534 
	`³rıu_couÁ”_add_b©ch
(&
fs_šfo
->
d–®loc_by‹s
, -
Ën
,

2535 
fs_šfo
->
d–®loc_b©ch
);

2536 
	`¥š_lock
(&
šode
->
lock
);

2537 
šode
->
d–®loc_by‹s
 -ğ
Ën
;

2538 ià(
do_li¡
 && 
šode
->
d–®loc_by‹s
 == 0 &&

2539 
	`‹¡_b™
(
BTRFS_INODE_IN_DELALLOC_LIST
,

2540 &
šode
->
ruÁime_æags
))

2541 
	`bŒfs_d–_d–®loc_šode
(
roÙ
, 
šode
);

2542 
	`¥š_uÆock
(&
šode
->
lock
);

2545 ià((
¡©e
->¡©& 
EXTENT_DELALLOC_NEW
) &&

2546 (
b™s
 & 
EXTENT_DELALLOC_NEW
)) {

2547 
	`¥š_lock
(&
šode
->
lock
);

2548 
	`ASSERT
(
šode
->
Ãw_d–®loc_by‹s
 >ğ
Ën
);

2549 
šode
->
Ãw_d–®loc_by‹s
 -ğ
Ën
;

2550 ià(
b™s
 & 
EXTENT_ADD_INODE_BYTES
)

2551 
	`šode_add_by‹s
(&
šode
->
vfs_šode
, 
Ën
);

2552 
	`¥š_uÆock
(&
šode
->
lock
);

2554 
	}
}

2556 
	$bŒfs_exŒaù_Üd”ed_ex‹Á
(
bŒfs_bio
 *
bbio
,

2557 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
)

2559 
u64
 
¡¬t
 = (u64)
bbio
->
bio
.
bi_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
;

2560 
u64
 
Ën
 = 
bbio
->
bio
.
bi_™”
.
bi_size
;

2561 
bŒfs_Üd”ed_ex‹Á
 *
Ãw
;

2562 
»t
;

2565 ià(
	`WARN_ON_ONCE
(
¡¬t
 !ğ
Üd”ed
->
disk_by‹Ä
))

2566  -
EINVAL
;

2569 ià(
Üd”ed
->
disk_num_by‹s
 =ğ
Ën
) {

2570 
	`»fcouÁ_šc
(&
Üd”ed
->
»fs
);

2571 
bbio
->
Üd”ed
 = ordered;

2579 ià(!
	`‹¡_b™
(
BTRFS_ORDERED_NOCOW
, &
Üd”ed
->
æags
)) {

2580 
»t
 = 
	`¥l™_ex‹Á_m­
(
bbio
->
šode
, bbio->
fe_off£t
,

2581 
Üd”ed
->
num_by‹s
, 
Ën
,

2582 
Üd”ed
->
disk_by‹Ä
);

2583 ià(
»t
)

2584  
»t
;

2587 
Ãw
 = 
	`bŒfs_¥l™_Üd”ed_ex‹Á
(
Üd”ed
, 
Ën
);

2588 ià(
	`IS_ERR
(
Ãw
))

2589  
	`PTR_ERR
(
Ãw
);

2590 
bbio
->
Üd”ed
 = 
Ãw
;

2592 
	}
}

2598 
	$add_³ndšg_csums
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2599 
li¡_h—d
 *
li¡
)

2601 
bŒfs_Üd”ed_sum
 *
sum
;

2602 
bŒfs_roÙ
 *
csum_roÙ
 = 
NULL
;

2603 
»t
;

2605 
	`li¡_fÜ_—ch_’Œy
(
sum
, 
li¡
,†ist) {

2606 
Œªs
->
addšg_csums
 = 
Œue
;

2607 ià(!
csum_roÙ
)

2608 
csum_roÙ
 = 
	`bŒfs_csum_roÙ
(
Œªs
->
fs_šfo
,

2609 
sum
->
logiÿl
);

2610 
»t
 = 
	`bŒfs_csum_fe_blocks
(
Œªs
, 
csum_roÙ
, 
sum
);

2611 
Œªs
->
addšg_csums
 = 
çl£
;

2612 ià(
»t
)

2613  
»t
;

2616 
	}
}

2618 
	$bŒfs_fšd_Ãw_d–®loc_by‹s
(
bŒfs_šode
 *
šode
,

2619 cÚ¡ 
u64
 
¡¬t
,

2620 cÚ¡ 
u64
 
Ën
,

2621 
ex‹Á_¡©e
 **
ÿched_¡©e
)

2623 
u64
 
£¬ch_¡¬t
 = 
¡¬t
;

2624 cÚ¡ 
u64
 
’d
 = 
¡¬t
 + 
Ën
 - 1;

2626 
£¬ch_¡¬t
 < 
’d
) {

2627 cÚ¡ 
u64
 
£¬ch_Ën
 = 
’d
 - 
£¬ch_¡¬t
 + 1;

2628 
ex‹Á_m­
 *
em
;

2629 
u64
 
em_Ën
;

2630 
»t
 = 0;

2632 
em
 = 
	`bŒfs_g‘_ex‹Á
(
šode
, 
NULL
, 0, 
£¬ch_¡¬t
, 
£¬ch_Ën
);

2633 ià(
	`IS_ERR
(
em
))

2634  
	`PTR_ERR
(
em
);

2636 ià(
em
->
block_¡¬t
 !ğ
EXTENT_MAP_HOLE
)

2637 
Ãxt
;

2639 
em_Ën
 = 
em
->
Ën
;

2640 ià(
em
->
¡¬t
 < 
£¬ch_¡¬t
)

2641 
em_Ën
 -ğ
£¬ch_¡¬t
 - 
em
->
¡¬t
;

2642 ià(
em_Ën
 > 
£¬ch_Ën
)

2643 
em_Ën
 = 
£¬ch_Ën
;

2645 
»t
 = 
	`£t_ex‹Á_b™
(&
šode
->
io_Œ“
, 
£¬ch_¡¬t
,

2646 
£¬ch_¡¬t
 + 
em_Ën
 - 1,

2647 
EXTENT_DELALLOC_NEW
, 
ÿched_¡©e
);

2648 
Ãxt
:

2649 
£¬ch_¡¬t
 = 
	`ex‹Á_m­_’d
(
em
);

2650 
	`ä“_ex‹Á_m­
(
em
);

2651 ià(
»t
)

2652  
»t
;

2655 
	}
}

2657 
	$bŒfs_£t_ex‹Á_d–®loc
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
,

2658 
exŒa_b™s
,

2659 
ex‹Á_¡©e
 **
ÿched_¡©e
)

2661 
	`WARN_ON
(
	`PAGE_ALIGNED
(
’d
));

2663 ià(
¡¬t
 >ğ
	`i_size_»ad
(&
šode
->
vfs_šode
) &&

2664 !(
šode
->
æags
 & 
BTRFS_INODE_PREALLOC
)) {

2669 
exŒa_b™s
 |ğ
EXTENT_DELALLOC_NEW
;

2671 
»t
;

2673 
»t
 = 
	`bŒfs_fšd_Ãw_d–®loc_by‹s
(
šode
, 
¡¬t
,

2674 
’d
 + 1 - 
¡¬t
,

2675 
ÿched_¡©e
);

2676 ià(
»t
)

2677  
»t
;

2680  
	`£t_ex‹Á_b™
(&
šode
->
io_Œ“
, 
¡¬t
, 
’d
,

2681 
EXTENT_DELALLOC
 | 
exŒa_b™s
, 
ÿched_¡©e
);

2682 
	}
}

2685 
	sbŒfs_wr™•age_fixup
 {

2686 
·ge
 *
	m·ge
;

2687 
bŒfs_šode
 *
	mšode
;

2688 
bŒfs_wÜk
 
	mwÜk
;

2691 
	$bŒfs_wr™•age_fixup_wÜk”
(
bŒfs_wÜk
 *
wÜk
)

2693 
bŒfs_wr™•age_fixup
 *
fixup
 =

2694 
	`cÚš”_of
(
wÜk
, 
bŒfs_wr™•age_fixup
, work);

2695 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

2696 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

2697 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

2698 
·ge
 *·gğ
fixup
->page;

2699 
bŒfs_šode
 *
šode
 = 
fixup
->inode;

2700 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

2701 
u64
 
·ge_¡¬t
 = 
	`·ge_off£t
(
·ge
);

2702 
u64
 
·ge_’d
 = 
	`·ge_off£t
(
·ge
è+ 
PAGE_SIZE
 - 1;

2703 
»t
 = 0;

2704 
boŞ
 
ä“_d–®loc_¥aû
 = 
Œue
;

2710 
»t
 = 
	`bŒfs_d–®loc_»£rve_¥aû
(
šode
, &
d©a_»£rved
, 
·ge_¡¬t
,

2711 
PAGE_SIZE
);

2712 
agaš
:

2713 
	`lock_·ge
(
·ge
);

2720 ià(!
·ge
->
m­pšg
 || !
	`PageDœty
Õageè|| !
	`PageChecked
(page)) {

2738 ià(!
»t
) {

2739 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
šode
, 
PAGE_SIZE
);

2740 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
šode
, 
d©a_»£rved
,

2741 
·ge_¡¬t
, 
PAGE_SIZE
,

2742 
Œue
);

2744 
»t
 = 0;

2745 
out_·ge
;

2752 ià(
»t
)

2753 
out_·ge
;

2755 
	`lock_ex‹Á
(&
šode
->
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
, &
ÿched_¡©e
);

2758 ià(
	`PageOrd”ed
(
·ge
))

2759 
out_»£rved
;

2761 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
šode
, 
·ge_¡¬t
, 
PAGE_SIZE
);

2762 ià(
Üd”ed
) {

2763 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
,

2764 &
ÿched_¡©e
);

2765 
	`uÆock_·ge
(
·ge
);

2766 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
Üd”ed
);

2767 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

2768 
agaš
;

2771 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
šode
, 
·ge_¡¬t
, 
·ge_’d
, 0,

2772 &
ÿched_¡©e
);

2773 ià(
»t
)

2774 
out_»£rved
;

2783 
	`BUG_ON
(!
	`PageDœty
(
·ge
));

2784 
ä“_d–®loc_¥aû
 = 
çl£
;

2785 
out_»£rved
:

2786 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
šode
, 
PAGE_SIZE
);

2787 ià(
ä“_d–®loc_¥aû
)

2788 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
šode
, 
d©a_»£rved
, 
·ge_¡¬t
,

2789 
PAGE_SIZE
, 
Œue
);

2790 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
, &
ÿched_¡©e
);

2791 
out_·ge
:

2792 ià(
»t
) {

2797 
	`m­pšg_£t_”rÜ
(
·ge
->
m­pšg
, 
»t
);

2798 
	`bŒfs_m¬k_Üd”ed_io_fšished
(
šode
, 
·ge
, 
·ge_¡¬t
,

2799 
PAGE_SIZE
, !
»t
);

2800 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

2802 
	`bŒfs_·ge_ş—r_checked
(
fs_šfo
, 
·ge
, 
·ge_¡¬t
, 
PAGE_SIZE
);

2803 
	`uÆock_·ge
(
·ge
);

2804 
	`put_·ge
(
·ge
);

2805 
	`kä“
(
fixup
);

2806 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

2812 
	`bŒfs_add_d–ayed_ut
(
šode
);

2813 
	}
}

2826 
	$bŒfs_wr™•age_cow_fixup
(
·ge
 *page)

2828 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

2829 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2830 
bŒfs_wr™•age_fixup
 *
fixup
;

2833 ià(
	`PageOrd”ed
(
·ge
))

2843 ià(
	`PageChecked
(
·ge
))

2844  -
EAGAIN
;

2846 
fixup
 = 
	`kz®loc
((*fixup), 
GFP_NOFS
);

2847 ià(!
fixup
)

2848  -
EAGAIN
;

2856 
	`ihŞd
(
šode
);

2857 
	`bŒfs_·ge_£t_checked
(
fs_šfo
, 
·ge
, 
	`·ge_off£t
Õage), 
PAGE_SIZE
);

2858 
	`g‘_·ge
(
·ge
);

2859 
	`bŒfs_š™_wÜk
(&
fixup
->
wÜk
, 
bŒfs_wr™•age_fixup_wÜk”
, 
NULL
, NULL);

2860 
fixup
->
·ge
 =…age;

2861 
fixup
->
šode
 = 
	`BTRFS_I
(inode);

2862 
	`bŒfs_queue_wÜk
(
fs_šfo
->
fixup_wÜk”s
, &
fixup
->
wÜk
);

2864  -
EAGAIN
;

2865 
	}
}

2867 
	$š£¹_»£rved_fe_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2868 
bŒfs_šode
 *
šode
, 
u64
 
fe_pos
,

2869 
bŒfs_fe_ex‹Á_™em
 *
¡ack_fi
,

2870 cÚ¡ 
boŞ
 
upd©e_šode_by‹s
,

2871 
u64
 
qgroup_»£rved
)

2873 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

2874 cÚ¡ 
u64
 
£ùÜsize
 = 
roÙ
->
fs_šfo
->sectorsize;

2875 
bŒfs_·th
 *
·th
;

2876 
ex‹Á_bufãr
 *
Ëaf
;

2877 
bŒfs_key
 
šs
;

2878 
u64
 
disk_num_by‹s
 = 
	`bŒfs_¡ack_fe_ex‹Á_disk_num_by‹s
(
¡ack_fi
);

2879 
u64
 
disk_by‹Ä
 = 
	`bŒfs_¡ack_fe_ex‹Á_disk_by‹Ä
(
¡ack_fi
);

2880 
u64
 
off£t
 = 
	`bŒfs_¡ack_fe_ex‹Á_off£t
(
¡ack_fi
);

2881 
u64
 
num_by‹s
 = 
	`bŒfs_¡ack_fe_ex‹Á_num_by‹s
(
¡ack_fi
);

2882 
u64
 
¿m_by‹s
 = 
	`bŒfs_¡ack_fe_ex‹Á_¿m_by‹s
(
¡ack_fi
);

2883 
bŒfs_drİ_ex‹Ás_¬gs
 
drİ_¬gs
 = { 0 };

2884 
»t
;

2886 
·th
 = 
	`bŒfs_®loc_·th
();

2887 ià(!
·th
)

2888  -
ENOMEM
;

2899 
drİ_¬gs
.
·th
 =…ath;

2900 
drİ_¬gs
.
¡¬t
 = 
fe_pos
;

2901 
drİ_¬gs
.
’d
 = 
fe_pos
 + 
num_by‹s
;

2902 
drİ_¬gs
.
»¶aû_ex‹Á
 = 
Œue
;

2903 
drİ_¬gs
.
ex‹Á_™em_size
 = (*
¡ack_fi
);

2904 
»t
 = 
	`bŒfs_drİ_ex‹Ás
(
Œªs
, 
roÙ
, 
šode
, &
drİ_¬gs
);

2905 ià(
»t
)

2906 
out
;

2908 ià(!
drİ_¬gs
.
ex‹Á_š£¹ed
) {

2909 
šs
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

2910 
šs
.
off£t
 = 
fe_pos
;

2911 
šs
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

2913 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
šs
,

2914 (*
¡ack_fi
));

2915 ià(
»t
)

2916 
out
;

2918 
Ëaf
 = 
·th
->
nodes
[0];

2919 
	`bŒfs_£t_¡ack_fe_ex‹Á_g’”©iÚ
(
¡ack_fi
, 
Œªs
->
Œªsid
);

2920 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
¡ack_fi
,

2921 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]),

2922 (
bŒfs_fe_ex‹Á_™em
));

2924 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

2925 
	`bŒfs_»Ëa£_·th
(
·th
);

2934 ià(
fe_pos
 =ğ0 && !
	`IS_ALIGNED
(
drİ_¬gs
.
by‹s_found
, 
£ùÜsize
)) {

2935 
u64
 
šlše_size
 = 
	`round_down
(
drİ_¬gs
.
by‹s_found
, 
£ùÜsize
);

2937 
šlše_size
 = 
drİ_¬gs
.
by‹s_found
 - inline_size;

2938 
	`bŒfs_upd©e_šode_by‹s
(
šode
, 
£ùÜsize
, 
šlše_size
);

2939 
drİ_¬gs
.
by‹s_found
 -ğ
šlše_size
;

2940 
num_by‹s
 -ğ
£ùÜsize
;

2943 ià(
upd©e_šode_by‹s
)

2944 
	`bŒfs_upd©e_šode_by‹s
(
šode
, 
num_by‹s
, 
drİ_¬gs
.
by‹s_found
);

2946 
šs
.
objeùid
 = 
disk_by‹Ä
;

2947 
šs
.
off£t
 = 
disk_num_by‹s
;

2948 
šs
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

2950 
»t
 = 
	`bŒfs_šode_£t_fe_ex‹Á_¿nge
(
šode
, 
fe_pos
, 
¿m_by‹s
);

2951 ià(
»t
)

2952 
out
;

2954 
»t
 = 
	`bŒfs_®loc_»£rved_fe_ex‹Á
(
Œªs
, 
roÙ
, 
	`bŒfs_šo
(
šode
),

2955 
fe_pos
 - 
off£t
,

2956 
qgroup_»£rved
, &
šs
);

2957 
out
:

2958 
	`bŒfs_ä“_·th
(
·th
);

2960  
»t
;

2961 
	}
}

2963 
	$bŒfs_»Ëa£_d–®loc_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
,

2964 
u64
 
¡¬t
, u64 
Ën
)

2966 
bŒfs_block_group
 *
ÿche
;

2968 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
¡¬t
);

2969 
	`ASSERT
(
ÿche
);

2971 
	`¥š_lock
(&
ÿche
->
lock
);

2972 
ÿche
->
d–®loc_by‹s
 -ğ
Ën
;

2973 
	`¥š_uÆock
(&
ÿche
->
lock
);

2975 
	`bŒfs_put_block_group
(
ÿche
);

2976 
	}
}

2978 
	$š£¹_Üd”ed_ex‹Á_fe_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2979 
bŒfs_Üd”ed_ex‹Á
 *
Û
)

2981 
bŒfs_fe_ex‹Á_™em
 
¡ack_fi
;

2982 
boŞ
 
upd©e_šode_by‹s
;

2983 
u64
 
num_by‹s
 = 
Û
->num_bytes;

2984 
u64
 
¿m_by‹s
 = 
Û
->ram_bytes;

2986 
	`mem£t
(&
¡ack_fi
, 0, (stack_fi));

2987 
	`bŒfs_£t_¡ack_fe_ex‹Á_ty³
(&
¡ack_fi
, 
BTRFS_FILE_EXTENT_REG
);

2988 
	`bŒfs_£t_¡ack_fe_ex‹Á_disk_by‹Ä
(&
¡ack_fi
, 
Û
->
disk_by‹Ä
);

2989 
	`bŒfs_£t_¡ack_fe_ex‹Á_disk_num_by‹s
(&
¡ack_fi
,

2990 
Û
->
disk_num_by‹s
);

2991 
	`bŒfs_£t_¡ack_fe_ex‹Á_off£t
(&
¡ack_fi
, 
Û
->
off£t
);

2992 ià(
	`‹¡_b™
(
BTRFS_ORDERED_TRUNCATED
, &
Û
->
æags
)) {

2993 
num_by‹s
 = 
Û
->
Œunÿ‹d_Ën
;

2994 
¿m_by‹s
 = 
num_by‹s
;

2996 
	`bŒfs_£t_¡ack_fe_ex‹Á_num_by‹s
(&
¡ack_fi
, 
num_by‹s
);

2997 
	`bŒfs_£t_¡ack_fe_ex‹Á_¿m_by‹s
(&
¡ack_fi
, 
¿m_by‹s
);

2998 
	`bŒfs_£t_¡ack_fe_ex‹Á_com´essiÚ
(&
¡ack_fi
, 
Û
->
com´ess_ty³
);

3007 
upd©e_šode_by‹s
 = 
	`‹¡_b™
(
BTRFS_ORDERED_DIRECT
, &
Û
->
æags
) ||

3008 
	`‹¡_b™
(
BTRFS_ORDERED_ENCODED
, &
Û
->
æags
) ||

3009 
	`‹¡_b™
(
BTRFS_ORDERED_TRUNCATED
, &
Û
->
æags
);

3011  
	`š£¹_»£rved_fe_ex‹Á
(
Œªs
, 
	`BTRFS_I
(
Û
->
šode
),

3012 
Û
->
fe_off£t
, &
¡ack_fi
,

3013 
upd©e_šode_by‹s
, 
Û
->
qgroup_rsv
);

3014 
	}
}

3021 
	$bŒfs_fšish_Úe_Üd”ed
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed_ex‹Á
)

3023 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
Üd”ed_ex‹Á
->inode);

3024 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

3025 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3026 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

3027 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
šode
->io_tree;

3028 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

3029 
u64
 
¡¬t
, 
’d
;

3030 
com´ess_ty³
 = 0;

3031 
»t
 = 0;

3032 
u64
 
logiÿl_Ën
 = 
Üd”ed_ex‹Á
->
num_by‹s
;

3033 
boŞ
 
ä“¥aû_šode
;

3034 
boŞ
 
Œunÿ‹d
 = 
çl£
;

3035 
boŞ
 
ş—r_»£rved_ex‹Á
 = 
Œue
;

3036 
ş—r_b™s
 = 
EXTENT_DEFRAG
;

3038 
¡¬t
 = 
Üd”ed_ex‹Á
->
fe_off£t
;

3039 
’d
 = 
¡¬t
 + 
Üd”ed_ex‹Á
->
num_by‹s
 - 1;

3041 ià(!
	`‹¡_b™
(
BTRFS_ORDERED_NOCOW
, &
Üd”ed_ex‹Á
->
æags
) &&

3042 !
	`‹¡_b™
(
BTRFS_ORDERED_PREALLOC
, &
Üd”ed_ex‹Á
->
æags
) &&

3043 !
	`‹¡_b™
(
BTRFS_ORDERED_DIRECT
, &
Üd”ed_ex‹Á
->
æags
) &&

3044 !
	`‹¡_b™
(
BTRFS_ORDERED_ENCODED
, &
Üd”ed_ex‹Á
->
æags
))

3045 
ş—r_b™s
 |ğ
EXTENT_DELALLOC_NEW
;

3047 
ä“¥aû_šode
 = 
	`bŒfs_is_ä“_¥aû_šode
(
šode
);

3048 ià(!
ä“¥aû_šode
)

3049 
	`bŒfs_lockd•_acquœe
(
fs_šfo
, 
bŒfs_Üd”ed_ex‹Á
);

3051 ià(
	`‹¡_b™
(
BTRFS_ORDERED_IOERR
, &
Üd”ed_ex‹Á
->
æags
)) {

3052 
»t
 = -
EIO
;

3053 
out
;

3056 ià(
	`bŒfs_is_zÚed
(
fs_šfo
))

3057 
	`bŒfs_zÚe_fšish_’dio
(
fs_šfo
, 
Üd”ed_ex‹Á
->
disk_by‹Ä
,

3058 
Üd”ed_ex‹Á
->
disk_num_by‹s
);

3060 ià(
	`‹¡_b™
(
BTRFS_ORDERED_TRUNCATED
, &
Üd”ed_ex‹Á
->
æags
)) {

3061 
Œunÿ‹d
 = 
Œue
;

3062 
logiÿl_Ën
 = 
Üd”ed_ex‹Á
->
Œunÿ‹d_Ën
;

3064 ià(!
logiÿl_Ën
)

3065 
out
;

3068 ià(
	`‹¡_b™
(
BTRFS_ORDERED_NOCOW
, &
Üd”ed_ex‹Á
->
æags
)) {

3069 
	`BUG_ON
(!
	`li¡_em±y
(&
Üd”ed_ex‹Á
->
li¡
));

3071 
	`bŒfs_šode_§ã_disk_i_size_wr™e
(
šode
, 0);

3072 ià(
ä“¥aû_šode
)

3073 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ_¥aûÿche
(
roÙ
);

3075 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

3076 ià(
	`IS_ERR
(
Œªs
)) {

3077 
»t
 = 
	`PTR_ERR
(
Œªs
);

3078 
Œªs
 = 
NULL
;

3079 
out
;

3081 
Œªs
->
block_rsv
 = &
šode
->block_rsv;

3082 
»t
 = 
	`bŒfs_upd©e_šode_çÎback
(
Œªs
, 
roÙ
, 
šode
);

3083 ià(
»t
)

3084 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3085 
out
;

3088 
ş—r_b™s
 |ğ
EXTENT_LOCKED
;

3089 
	`lock_ex‹Á
(
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

3091 ià(
ä“¥aû_šode
)

3092 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ_¥aûÿche
(
roÙ
);

3094 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

3095 ià(
	`IS_ERR
(
Œªs
)) {

3096 
»t
 = 
	`PTR_ERR
(
Œªs
);

3097 
Œªs
 = 
NULL
;

3098 
out
;

3101 
Œªs
->
block_rsv
 = &
šode
->block_rsv;

3103 ià(
	`‹¡_b™
(
BTRFS_ORDERED_COMPRESSED
, &
Üd”ed_ex‹Á
->
æags
))

3104 
com´ess_ty³
 = 
Üd”ed_ex‹Á
->compress_type;

3105 ià(
	`‹¡_b™
(
BTRFS_ORDERED_PREALLOC
, &
Üd”ed_ex‹Á
->
æags
)) {

3106 
	`BUG_ON
(
com´ess_ty³
);

3107 
»t
 = 
	`bŒfs_m¬k_ex‹Á_wr™‹n
(
Œªs
, 
šode
,

3108 
Üd”ed_ex‹Á
->
fe_off£t
,

3109 
Üd”ed_ex‹Á
->
fe_off£t
 +

3110 
logiÿl_Ën
);

3111 
	`bŒfs_zÚed_»Ëa£_d©a_»loc_bg
(
fs_šfo
, 
Üd”ed_ex‹Á
->
disk_by‹Ä
,

3112 
Üd”ed_ex‹Á
->
disk_num_by‹s
);

3114 
	`BUG_ON
(
roÙ
 =ğ
fs_šfo
->
Œ“_roÙ
);

3115 
»t
 = 
	`š£¹_Üd”ed_ex‹Á_fe_ex‹Á
(
Œªs
, 
Üd”ed_ex‹Á
);

3116 ià(!
»t
) {

3117 
ş—r_»£rved_ex‹Á
 = 
çl£
;

3118 
	`bŒfs_»Ëa£_d–®loc_by‹s
(
fs_šfo
,

3119 
Üd”ed_ex‹Á
->
disk_by‹Ä
,

3120 
Üd”ed_ex‹Á
->
disk_num_by‹s
);

3123 
	`uÅš_ex‹Á_ÿche
(&
šode
->
ex‹Á_Œ“
, 
Üd”ed_ex‹Á
->
fe_off£t
,

3124 
Üd”ed_ex‹Á
->
num_by‹s
, 
Œªs
->
Œªsid
);

3125 ià(
»t
 < 0) {

3126 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3127 
out
;

3130 
»t
 = 
	`add_³ndšg_csums
(
Œªs
, &
Üd”ed_ex‹Á
->
li¡
);

3131 ià(
»t
) {

3132 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3133 
out
;

3141 ià((
ş—r_b™s
 & 
EXTENT_DELALLOC_NEW
) &&

3142 !
	`‹¡_b™
(
BTRFS_ORDERED_TRUNCATED
, &
Üd”ed_ex‹Á
->
æags
))

3143 
	`ş—r_ex‹Á_b™
(&
šode
->
io_Œ“
, 
¡¬t
, 
’d
,

3144 
EXTENT_DELALLOC_NEW
 | 
EXTENT_ADD_INODE_BYTES
,

3145 &
ÿched_¡©e
);

3147 
	`bŒfs_šode_§ã_disk_i_size_wr™e
(
šode
, 0);

3148 
»t
 = 
	`bŒfs_upd©e_šode_çÎback
(
Œªs
, 
roÙ
, 
šode
);

3149 ià(
»t
) {

3150 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3151 
out
;

3153 
»t
 = 0;

3154 
out
:

3155 
	`ş—r_ex‹Á_b™
(&
šode
->
io_Œ“
, 
¡¬t
, 
’d
, 
ş—r_b™s
,

3156 &
ÿched_¡©e
);

3158 ià(
Œªs
)

3159 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3161 ià(
»t
 || 
Œunÿ‹d
) {

3162 
u64
 
unwr™‹n_¡¬t
 = 
¡¬t
;

3172 ià(
»t
 && !
	`‹¡_ªd_£t_b™
(
BTRFS_ORDERED_IOERR
,

3173 &
Üd”ed_ex‹Á
->
æags
))

3174 
	`m­pšg_£t_”rÜ
(
Üd”ed_ex‹Á
->
šode
->
i_m­pšg
, -
EIO
);

3176 ià(
Œunÿ‹d
)

3177 
unwr™‹n_¡¬t
 +ğ
logiÿl_Ën
;

3178 
	`ş—r_ex‹Á_u±od©e
(
io_Œ“
, 
unwr™‹n_¡¬t
, 
’d
, 
NULL
);

3181 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
šode
, 
unwr™‹n_¡¬t
, 
’d
, 
çl£
);

3193 ià((
»t
 || !
logiÿl_Ën
) &&

3194 
ş—r_»£rved_ex‹Á
 &&

3195 !
	`‹¡_b™
(
BTRFS_ORDERED_NOCOW
, &
Üd”ed_ex‹Á
->
æags
) &&

3196 !
	`‹¡_b™
(
BTRFS_ORDERED_PREALLOC
, &
Üd”ed_ex‹Á
->
æags
)) {

3201 ià(
»t
 && 
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DISCARD_SYNC
))

3202 
	`bŒfs_disÿrd_ex‹Á
(
fs_šfo
,

3203 
Üd”ed_ex‹Á
->
disk_by‹Ä
,

3204 
Üd”ed_ex‹Á
->
disk_num_by‹s
,

3205 
NULL
);

3206 
	`bŒfs_ä“_»£rved_ex‹Á
(
fs_šfo
,

3207 
Üd”ed_ex‹Á
->
disk_by‹Ä
,

3208 
Üd”ed_ex‹Á
->
disk_num_by‹s
, 1);

3213 
	`bŒfs_qgroup_ä“_»äoÙ
(
fs_šfo
, 
šode
->
roÙ
->
roÙ_key
.
objeùid
,

3214 
Üd”ed_ex‹Á
->
qgroup_rsv
,

3215 
BTRFS_QGROUP_RSV_DATA
);

3223 
	`bŒfs_»move_Üd”ed_ex‹Á
(
šode
, 
Üd”ed_ex‹Á
);

3226 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed_ex‹Á
);

3228 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed_ex‹Á
);

3230  
»t
;

3231 
	}
}

3233 
	$bŒfs_fšish_Üd”ed_io
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
)

3235 ià(
	`bŒfs_is_zÚed
(
	`bŒfs_sb
(
Üd”ed
->
šode
->
i_sb
)) &&

3236 !
	`‹¡_b™
(
BTRFS_ORDERED_IOERR
, &
Üd”ed
->
æags
))

3237 
	`bŒfs_fšish_Üd”ed_zÚed
(
Üd”ed
);

3238  
	`bŒfs_fšish_Úe_Üd”ed
(
Üd”ed
);

3239 
	}
}

3245 
	$bŒfs_check_£ùÜ_csum
(
bŒfs_fs_šfo
 *
fs_šfo
, 
·ge
 *page,

3246 
u32
 
pgoff
, 
u8
 *
csum
, cÚ¡ u8 * cÚ¡ 
csum_ex³ùed
)

3248 
	`SHASH_DESC_ON_STACK
(
shash
, 
fs_šfo
->
csum_shash
);

3249 *
kaddr
;

3251 
	`ASSERT
(
pgoff
 + 
fs_šfo
->
£ùÜsize
 <ğ
PAGE_SIZE
);

3253 
shash
->
tfm
 = 
fs_šfo
->
csum_shash
;

3255 
kaddr
 = 
	`km­_loÿl_·ge
(
·ge
è+ 
pgoff
;

3256 
	`üy±o_shash_dige¡
(
shash
, 
kaddr
, 
fs_šfo
->
£ùÜsize
, 
csum
);

3257 
	`kunm­_loÿl
(
kaddr
);

3259 ià(
	`memcmp
(
csum
, 
csum_ex³ùed
, 
fs_šfo
->
csum_size
)) {

3261  -
EIO
;

3264 
	}
}

3279 
boŞ
 
	$bŒfs_d©a_csum_ok
(
bŒfs_bio
 *
bbio
, 
bŒfs_deviû
 *
dev
,

3280 
u32
 
bio_off£t
, 
bio_vec
 *
bv
)

3282 
bŒfs_šode
 *
šode
 = 
bbio
->inode;

3283 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

3284 
u64
 
fe_off£t
 = 
bbio
->fe_off£ˆ+ 
bio_off£t
;

3285 
u64
 
’d
 = 
fe_off£t
 + 
bv
->
bv_Ën
 - 1;

3286 
u8
 *
csum_ex³ùed
;

3287 
u8
 
csum
[
BTRFS_CSUM_SIZE
];

3289 
	`ASSERT
(
bv
->
bv_Ën
 =ğ
fs_šfo
->
£ùÜsize
);

3291 ià(!
bbio
->
csum
)

3292  
Œue
;

3294 ià(
	`bŒfs_is_d©a_»loc_roÙ
(
šode
->
roÙ
) &&

3295 
	`‹¡_¿nge_b™
(&
šode
->
io_Œ“
, 
fe_off£t
, 
’d
, 
EXTENT_NODATASUM
,

3296 1, 
NULL
)) {

3298 
	`ş—r_ex‹Á_b™s
(&
šode
->
io_Œ“
, 
fe_off£t
, 
’d
,

3299 
EXTENT_NODATASUM
);

3300  
Œue
;

3304 
csum_ex³ùed
 = 
bbio
->
csum
 + (
bio_off£t
 >> 
fs_šfo
->
£ùÜsize_b™s
) *

3305 
fs_šfo
->
csum_size
;

3306 ià(
	`bŒfs_check_£ùÜ_csum
(
fs_šfo
, 
bv
->
bv_·ge
, bv->
bv_off£t
, 
csum
,

3307 
csum_ex³ùed
)) {

3309 
z”o™
;

3312  
Œue
;

3314 
z”o™
:

3315 
	`bŒfs_´št_d©a_csum_”rÜ
(
šode
, 
fe_off£t
, 
csum
, 
csum_ex³ùed
,

3316 
bbio
->
mœrÜ_num
);

3317 ià(
dev
)

3318 
	`bŒfs_dev_¡©_šc_ªd_´št
(
dev
, 
BTRFS_DEV_STAT_CORRUPTION_ERRS
);

3319 
	`memz”o_bvec
(
bv
);

3320  
çl£
;

3321 
	}
}

3333 
	$bŒfs_add_d–ayed_ut
(
bŒfs_šode
 *
šode
)

3335 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

3336 
æags
;

3338 ià(
	`©omic_add_uÆess
(&
šode
->
vfs_šode
.
i_couÁ
, -1, 1))

3341 
	`©omic_šc
(&
fs_šfo
->
Ä_d–ayed_uts
);

3347 
	`¥š_lock_œq§ve
(&
fs_šfo
->
d–ayed_ut_lock
, 
æags
);

3348 
	`ASSERT
(
	`li¡_em±y
(&
šode
->
d–ayed_ut
));

3349 
	`li¡_add_
(&
šode
->
d–ayed_ut
, &
fs_šfo
->
d–ayed_uts
);

3350 
	`¥š_uÆock_œq»¡Üe
(&
fs_šfo
->
d–ayed_ut_lock
, 
æags
);

3351 ià(!
	`‹¡_b™
(
BTRFS_FS_CLEANER_RUNNING
, &
fs_šfo
->
æags
))

3352 
	`wake_up_´oûss
(
fs_šfo
->
ş—Ãr_kth»ad
);

3353 
	}
}

3355 
	$run_d–ayed_ut_locked
(
bŒfs_fs_šfo
 *
fs_šfo
,

3356 
bŒfs_šode
 *
šode
)

3358 
	`li¡_d–_š™
(&
šode
->
d–ayed_ut
);

3359 
	`¥š_uÆock_œq
(&
fs_šfo
->
d–ayed_ut_lock
);

3360 
	`ut
(&
šode
->
vfs_šode
);

3361 ià(
	`©omic_dec_ªd_‹¡
(&
fs_šfo
->
Ä_d–ayed_uts
))

3362 
	`wake_up
(&
fs_šfo
->
d–ayed_uts_wa™
);

3363 
	`¥š_lock_œq
(&
fs_šfo
->
d–ayed_ut_lock
);

3364 
	}
}

3366 
	$bŒfs_run_d–ayed_ut
(
bŒfs_fs_šfo
 *
fs_šfo
,

3367 
bŒfs_šode
 *
šode
)

3369 ià(!
	`li¡_em±y
(&
šode
->
d–ayed_ut
)) {

3370 
	`¥š_lock_œq
(&
fs_šfo
->
d–ayed_ut_lock
);

3371 ià(!
	`li¡_em±y
(&
šode
->
d–ayed_ut
))

3372 
	`run_d–ayed_ut_locked
(
fs_šfo
, 
šode
);

3373 
	`¥š_uÆock_œq
(&
fs_šfo
->
d–ayed_ut_lock
);

3375 
	}
}

3377 
	$bŒfs_run_d–ayed_uts
(
bŒfs_fs_šfo
 *
fs_šfo
)

3385 
	`¥š_lock_œq
(&
fs_šfo
->
d–ayed_ut_lock
);

3386 !
	`li¡_em±y
(&
fs_šfo
->
d–ayed_uts
)) {

3387 
bŒfs_šode
 *
šode
;

3389 
šode
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
d–ayed_uts
,

3390 
bŒfs_šode
, 
d–ayed_ut
);

3391 
	`run_d–ayed_ut_locked
(
fs_šfo
, 
šode
);

3392 ià(
	`Ãed_»sched
()) {

3393 
	`¥š_uÆock_œq
(&
fs_šfo
->
d–ayed_ut_lock
);

3394 
	`cÚd_»sched
();

3395 
	`¥š_lock_œq
(&
fs_šfo
->
d–ayed_ut_lock
);

3398 
	`¥š_uÆock_œq
(&
fs_šfo
->
d–ayed_ut_lock
);

3399 
	}
}

3413 
	$bŒfs_wa™_Ú_d–ayed_uts
(
bŒfs_fs_šfo
 *
fs_šfo
)

3415 
»t
 = 
	`wa™_ev’t_kÏbË
(
fs_šfo
->
d–ayed_uts_wa™
,

3416 
	`©omic_»ad
(&
fs_šfo
->
Ä_d–ayed_uts
) == 0);

3417 ià(
»t
)

3418  -
EINTR
;

3420 
	}
}

3426 
	$bŒfs_Üphª_add
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3427 
bŒfs_šode
 *
šode
)

3429 
»t
;

3431 
»t
 = 
	`bŒfs_š£¹_Üphª_™em
(
Œªs
, 
šode
->
roÙ
, 
	`bŒfs_šo
(inode));

3432 ià(
»t
 &&„‘ !ğ-
EEXIST
) {

3433 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3434  
»t
;

3438 
	}
}

3444 
	$bŒfs_Üphª_d–
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3445 
bŒfs_šode
 *
šode
)

3447  
	`bŒfs_d–_Üphª_™em
(
Œªs
, 
šode
->
roÙ
, 
	`bŒfs_šo
(inode));

3448 
	}
}

3454 
	$bŒfs_Üphª_ş—nup
(
bŒfs_roÙ
 *
roÙ
)

3456 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3457 
bŒfs_·th
 *
·th
;

3458 
ex‹Á_bufãr
 *
Ëaf
;

3459 
bŒfs_key
 
key
, 
found_key
;

3460 
bŒfs_Œªs_hªdË
 *
Œªs
;

3461 
šode
 *inode;

3462 
u64
 
Ï¡_objeùid
 = 0;

3463 
»t
 = 0, 
Ä_uÆšk
 = 0;

3465 ià(
	`‹¡_ªd_£t_b™
(
BTRFS_ROOT_ORPHAN_CLEANUP
, &
roÙ
->
¡©e
))

3468 
·th
 = 
	`bŒfs_®loc_·th
();

3469 ià(!
·th
) {

3470 
»t
 = -
ENOMEM
;

3471 
out
;

3473 
·th
->
»ada
 = 
READA_BACK
;

3475 
key
.
objeùid
 = 
BTRFS_ORPHAN_OBJECTID
;

3476 
key
.
ty³
 = 
BTRFS_ORPHAN_ITEM_KEY
;

3477 
key
.
off£t
 = (
u64
)-1;

3480 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

3481 ià(
»t
 < 0)

3482 
out
;

3489 ià(
»t
 > 0) {

3490 
»t
 = 0;

3491 ià(
·th
->
¦Ùs
[0] == 0)

3493 
·th
->
¦Ùs
[0]--;

3497 
Ëaf
 = 
·th
->
nodes
[0];

3498 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

3501 ià(
found_key
.
objeùid
 !ğ
BTRFS_ORPHAN_OBJECTID
)

3503 ià(
found_key
.
ty³
 !ğ
BTRFS_ORPHAN_ITEM_KEY
)

3507 
	`bŒfs_»Ëa£_·th
(
·th
);

3515 ià(
found_key
.
off£t
 =ğ
Ï¡_objeùid
) {

3523 
	`bŒfs_”r
(
fs_šfo
,

3525 
»t
 = 
	`BTRFS_FS_ERROR
(
fs_šfo
è?: -
EINVAL
;

3526 
out
;

3529 
Ï¡_objeùid
 = 
found_key
.
off£t
;

3531 
found_key
.
objeùid
 = found_key.
off£t
;

3532 
found_key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

3533 
found_key
.
off£t
 = 0;

3534 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
Ï¡_objeùid
, 
roÙ
);

3535 ià(
	`IS_ERR
(
šode
)) {

3536 
»t
 = 
	`PTR_ERR
(
šode
);

3537 
šode
 = 
NULL
;

3538 ià(
»t
 !ğ-
ENOENT
)

3539 
out
;

3542 ià(!
šode
 && 
roÙ
 =ğ
fs_šfo
->
Œ“_roÙ
) {

3543 
bŒfs_roÙ
 *
d—d_roÙ
;

3544 
is_d—d_roÙ
 = 0;

3562 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

3563 
d—d_roÙ
 = 
	`¿dix_Œ“_lookup
(&
fs_šfo
->
fs_roÙs_¿dix
,

3564 ()
found_key
.
objeùid
);

3565 ià(
d—d_roÙ
 && 
	`bŒfs_roÙ_»fs
(&d—d_roÙ->
roÙ_™em
) == 0)

3566 
is_d—d_roÙ
 = 1;

3567 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

3569 ià(
is_d—d_roÙ
) {

3571 
key
.
off£t
 = 
found_key
.
objeùid
 - 1;

3603 ià(!
šode
 || inode->
i_Æšk
) {

3604 ià(
šode
) {

3605 
»t
 = 
	`bŒfs_drİ_v”™y_™ems
(
	`BTRFS_I
(
šode
));

3606 
	`ut
(
šode
);

3607 
šode
 = 
NULL
;

3608 ià(
»t
)

3609 
out
;

3611 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

3612 ià(
	`IS_ERR
(
Œªs
)) {

3613 
»t
 = 
	`PTR_ERR
(
Œªs
);

3614 
out
;

3616 
	`bŒfs_debug
(
fs_šfo
, "auto deleting %Lu",

3617 
found_key
.
objeùid
);

3618 
»t
 = 
	`bŒfs_d–_Üphª_™em
(
Œªs
, 
roÙ
,

3619 
found_key
.
objeùid
);

3620 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3621 ià(
»t
)

3622 
out
;

3626 
Ä_uÆšk
++;

3629 
	`ut
(
šode
);

3632 
	`bŒfs_»Ëa£_·th
(
·th
);

3634 ià(
	`‹¡_b™
(
BTRFS_ROOT_ORPHAN_ITEM_INSERTED
, &
roÙ
->
¡©e
)) {

3635 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

3636 ià(!
	`IS_ERR
(
Œªs
))

3637 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3640 ià(
Ä_uÆšk
)

3641 
	`bŒfs_debug
(
fs_šfo
, "uÆšked %d o½hªs", 
Ä_uÆšk
);

3643 
out
:

3644 ià(
»t
)

3645 
	`bŒfs_”r
(
fs_šfo
, "could‚Ù dØÜphª cËªu°%d", 
»t
);

3646 
	`bŒfs_ä“_·th
(
·th
);

3647  
»t
;

3648 
	}
}

3656 
nošlše
 
	$aşs_aá”_šode_™em
(
ex‹Á_bufãr
 *
Ëaf
,

3657 
¦Ù
, 
u64
 
objeùid
,

3658 *
fœ¡_x©Œ_¦Ù
)

3660 
u32
 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

3661 
bŒfs_key
 
found_key
;

3662 
u64
 
x©Œ_acûss
 = 0;

3663 
u64
 
x©Œ_deçuÉ
 = 0;

3664 
sÿÂed
 = 0;

3666 ià(!
x©Œ_acûss
) {

3667 
x©Œ_acûss
 = 
	`bŒfs_Çme_hash
(
XATTR_NAME_POSIX_ACL_ACCESS
,

3668 
	`¡¾’
(
XATTR_NAME_POSIX_ACL_ACCESS
));

3669 
x©Œ_deçuÉ
 = 
	`bŒfs_Çme_hash
(
XATTR_NAME_POSIX_ACL_DEFAULT
,

3670 
	`¡¾’
(
XATTR_NAME_POSIX_ACL_DEFAULT
));

3673 
¦Ù
++;

3674 *
fœ¡_x©Œ_¦Ù
 = -1;

3675 
¦Ù
 < 
Ä™ems
) {

3676 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
¦Ù
);

3679 ià(
found_key
.
objeùid
 != objectid)

3683 ià(
found_key
.
ty³
 =ğ
BTRFS_XATTR_ITEM_KEY
) {

3684 ià(*
fœ¡_x©Œ_¦Ù
 == -1)

3685 *
fœ¡_x©Œ_¦Ù
 = 
¦Ù
;

3686 ià(
found_key
.
off£t
 =ğ
x©Œ_acûss
 ||

3687 
found_key
.
off£t
 =ğ
x©Œ_deçuÉ
)

3695 ià(
found_key
.
ty³
 > 
BTRFS_XATTR_ITEM_KEY
)

3698 
¦Ù
++;

3699 
sÿÂed
++;

3707 ià(
sÿÂed
 >= 8)

3714 ià(*
fœ¡_x©Œ_¦Ù
 == -1)

3715 *
fœ¡_x©Œ_¦Ù
 = 
¦Ù
;

3717 
	}
}

3722 
	$bŒfs_»ad_locked_šode
(
šode
 *inode,

3723 
bŒfs_·th
 *
š_·th
)

3725 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

3726 
bŒfs_·th
 *
·th
 = 
š_·th
;

3727 
ex‹Á_bufãr
 *
Ëaf
;

3728 
bŒfs_šode_™em
 *
šode_™em
;

3729 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

3730 
bŒfs_key
 
loÿtiÚ
;

3731 
±r
;

3732 
maybe_aşs
;

3733 
u32
 
rdev
;

3734 
»t
;

3735 
boŞ
 
fËd
 = 
çl£
;

3736 
fœ¡_x©Œ_¦Ù
;

3738 
»t
 = 
	`bŒfs_fl_šode
(
šode
, &
rdev
);

3739 ià(!
»t
)

3740 
fËd
 = 
Œue
;

3742 ià(!
·th
) {

3743 
·th
 = 
	`bŒfs_®loc_·th
();

3744 ià(!
·th
)

3745  -
ENOMEM
;

3748 
	`memıy
(&
loÿtiÚ
, &
	`BTRFS_I
(
šode
)->location, (location));

3750 
»t
 = 
	`bŒfs_lookup_šode
(
NULL
, 
roÙ
, 
·th
, &
loÿtiÚ
, 0);

3751 ià(
»t
) {

3752 ià(
·th
 !ğ
š_·th
)

3753 
	`bŒfs_ä“_·th
(
·th
);

3754  
»t
;

3757 
Ëaf
 = 
·th
->
nodes
[0];

3759 ià(
fËd
)

3760 
ÿche_šdex
;

3762 
šode_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

3763 
bŒfs_šode_™em
);

3764 
šode
->
i_mode
 = 
	`bŒfs_šode_mode
(
Ëaf
, 
šode_™em
);

3765 
	`£t_Æšk
(
šode
, 
	`bŒfs_šode_Æšk
(
Ëaf
, 
šode_™em
));

3766 
	`i_uid_wr™e
(
šode
, 
	`bŒfs_šode_uid
(
Ëaf
, 
šode_™em
));

3767 
	`i_gid_wr™e
(
šode
, 
	`bŒfs_šode_gid
(
Ëaf
, 
šode_™em
));

3768 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
šode
), 
	`bŒfs_šode_size
(
Ëaf
, 
šode_™em
));

3769 
	`bŒfs_šode_£t_fe_ex‹Á_¿nge
(
	`BTRFS_I
(
šode
), 0,

3770 
	`round_up
(
	`i_size_»ad
(
šode
), 
fs_šfo
->
£ùÜsize
));

3772 
šode
->
i_©ime
.
tv_£c
 = 
	`bŒfs_time¥ec_£c
(
Ëaf
, &
šode_™em
->
©ime
);

3773 
šode
->
i_©ime
.
tv_n£c
 = 
	`bŒfs_time¥ec_n£c
(
Ëaf
, &
šode_™em
->
©ime
);

3775 
šode
->
i_mtime
.
tv_£c
 = 
	`bŒfs_time¥ec_£c
(
Ëaf
, &
šode_™em
->
mtime
);

3776 
šode
->
i_mtime
.
tv_n£c
 = 
	`bŒfs_time¥ec_n£c
(
Ëaf
, &
šode_™em
->
mtime
);

3778 
	`šode_£t_ùime
(
šode
, 
	`bŒfs_time¥ec_£c
(
Ëaf
, &
šode_™em
->
ùime
),

3779 
	`bŒfs_time¥ec_n£c
(
Ëaf
, &
šode_™em
->
ùime
));

3781 
	`BTRFS_I
(
šode
)->
i_Ùime
.
tv_£c
 =

3782 
	`bŒfs_time¥ec_£c
(
Ëaf
, &
šode_™em
->
Ùime
);

3783 
	`BTRFS_I
(
šode
)->
i_Ùime
.
tv_n£c
 =

3784 
	`bŒfs_time¥ec_n£c
(
Ëaf
, &
šode_™em
->
Ùime
);

3786 
	`šode_£t_by‹s
(
šode
, 
	`bŒfs_šode_nby‹s
(
Ëaf
, 
šode_™em
));

3787 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 
	`bŒfs_šode_g’”©iÚ
(
Ëaf
, 
šode_™em
);

3788 
	`BTRFS_I
(
šode
)->
Ï¡_Œªs
 = 
	`bŒfs_šode_Œªsid
(
Ëaf
, 
šode_™em
);

3790 
	`šode_£t_iv”siÚ_qu”›d
(
šode
,

3791 
	`bŒfs_šode_£qu’û
(
Ëaf
, 
šode_™em
));

3792 
šode
->
i_g’”©iÚ
 = 
	`BTRFS_I
(šode)->
g’”©iÚ
;

3793 
šode
->
i_rdev
 = 0;

3794 
rdev
 = 
	`bŒfs_šode_rdev
(
Ëaf
, 
šode_™em
);

3796 
	`BTRFS_I
(
šode
)->
šdex_út
 = (
u64
)-1;

3797 
	`bŒfs_šode_¥l™_æags
(
	`bŒfs_šode_æags
(
Ëaf
, 
šode_™em
),

3798 &
	`BTRFS_I
(
šode
)->
æags
, &BTRFS_I(šode)->
ro_æags
);

3800 
ÿche_šdex
:

3810 ià(
	`BTRFS_I
(
šode
)->
Ï¡_Œªs
 =ğ
fs_šfo
->
g’”©iÚ
)

3811 
	`£t_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

3812 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

3841 
	`BTRFS_I
(
šode
)->
Ï¡_uÆšk_Œªs
 = BTRFS_I(šode)->
Ï¡_Œªs
;

3849 
	`BTRFS_I
(
šode
)->
Ï¡_»æšk_Œªs
 = BTRFS_I(šode)->
Ï¡_Œªs
;

3851 
·th
->
¦Ùs
[0]++;

3852 ià(
šode
->
i_Æšk
 != 1 ||

3853 
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
))

3854 
ÿche_aş
;

3856 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
loÿtiÚ
, 
·th
->
¦Ùs
[0]);

3857 ià(
loÿtiÚ
.
objeùid
 !ğ
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)))

3858 
ÿche_aş
;

3860 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

3861 ià(
loÿtiÚ
.
ty³
 =ğ
BTRFS_INODE_REF_KEY
) {

3862 
bŒfs_šode_»f
 *
»f
;

3864 
»f
 = (
bŒfs_šode_»f
 *)
±r
;

3865 
	`BTRFS_I
(
šode
)->
dœ_šdex
 = 
	`bŒfs_šode_»f_šdex
(
Ëaf
, 
»f
);

3866 } ià(
loÿtiÚ
.
ty³
 =ğ
BTRFS_INODE_EXTREF_KEY
) {

3867 
bŒfs_šode_exŒef
 *
exŒef
;

3869 
exŒef
 = (
bŒfs_šode_exŒef
 *)
±r
;

3870 
	`BTRFS_I
(
šode
)->
dœ_šdex
 = 
	`bŒfs_šode_exŒef_šdex
(
Ëaf
,

3871 
exŒef
);

3873 
ÿche_aş
:

3878 
maybe_aşs
 = 
	`aşs_aá”_šode_™em
(
Ëaf
, 
·th
->
¦Ùs
[0],

3879 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), &
fœ¡_x©Œ_¦Ù
);

3880 ià(
fœ¡_x©Œ_¦Ù
 != -1) {

3881 
·th
->
¦Ùs
[0] = 
fœ¡_x©Œ_¦Ù
;

3882 
»t
 = 
	`bŒfs_lßd_šode_´İs
(
šode
, 
·th
);

3883 ià(
»t
)

3884 
	`bŒfs_”r
(
fs_šfo
,

3886 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)),

3887 
roÙ
->
roÙ_key
.
objeùid
, 
»t
);

3889 ià(
·th
 !ğ
š_·th
)

3890 
	`bŒfs_ä“_·th
(
·th
);

3892 ià(!
maybe_aşs
)

3893 
	`ÿche_no_aş
(
šode
);

3895 
šode
->
i_mode
 & 
S_IFMT
) {

3896 
S_IFREG
:

3897 
šode
->
i_m­pšg
->
a_İs
 = &
bŒfs_aİs
;

3898 
šode
->
i_fİ
 = &
bŒfs_fe_İ”©iÚs
;

3899 
šode
->
i_İ
 = &
bŒfs_fe_šode_İ”©iÚs
;

3901 
S_IFDIR
:

3902 
šode
->
i_fİ
 = &
bŒfs_dœ_fe_İ”©iÚs
;

3903 
šode
->
i_İ
 = &
bŒfs_dœ_šode_İ”©iÚs
;

3905 
S_IFLNK
:

3906 
šode
->
i_İ
 = &
bŒfs_symlšk_šode_İ”©iÚs
;

3907 
	`šode_nohighmem
(
šode
);

3908 
šode
->
i_m­pšg
->
a_İs
 = &
bŒfs_aİs
;

3911 
šode
->
i_İ
 = &
bŒfs_¥ecŸl_šode_İ”©iÚs
;

3912 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
, 
rdev
);

3916 
	`bŒfs_sync_šode_æags_to_i_æags
(
šode
);

3918 
	}
}

3923 
	$fl_šode_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3924 
ex‹Á_bufãr
 *
Ëaf
,

3925 
bŒfs_šode_™em
 *
™em
,

3926 
šode
 *inode)

3928 
bŒfs_m­_tok’
 
tok’
;

3929 
u64
 
æags
;

3931 
	`bŒfs_š™_m­_tok’
(&
tok’
, 
Ëaf
);

3933 
	`bŒfs_£t_tok’_šode_uid
(&
tok’
, 
™em
, 
	`i_uid_»ad
(
šode
));

3934 
	`bŒfs_£t_tok’_šode_gid
(&
tok’
, 
™em
, 
	`i_gid_»ad
(
šode
));

3935 
	`bŒfs_£t_tok’_šode_size
(&
tok’
, 
™em
, 
	`BTRFS_I
(
šode
)->
disk_i_size
);

3936 
	`bŒfs_£t_tok’_šode_mode
(&
tok’
, 
™em
, 
šode
->
i_mode
);

3937 
	`bŒfs_£t_tok’_šode_Æšk
(&
tok’
, 
™em
, 
šode
->
i_Æšk
);

3939 
	`bŒfs_£t_tok’_time¥ec_£c
(&
tok’
, &
™em
->
©ime
,

3940 
šode
->
i_©ime
.
tv_£c
);

3941 
	`bŒfs_£t_tok’_time¥ec_n£c
(&
tok’
, &
™em
->
©ime
,

3942 
šode
->
i_©ime
.
tv_n£c
);

3944 
	`bŒfs_£t_tok’_time¥ec_£c
(&
tok’
, &
™em
->
mtime
,

3945 
šode
->
i_mtime
.
tv_£c
);

3946 
	`bŒfs_£t_tok’_time¥ec_n£c
(&
tok’
, &
™em
->
mtime
,

3947 
šode
->
i_mtime
.
tv_n£c
);

3949 
	`bŒfs_£t_tok’_time¥ec_£c
(&
tok’
, &
™em
->
ùime
,

3950 
	`šode_g‘_ùime
(
šode
).
tv_£c
);

3951 
	`bŒfs_£t_tok’_time¥ec_n£c
(&
tok’
, &
™em
->
ùime
,

3952 
	`šode_g‘_ùime
(
šode
).
tv_n£c
);

3954 
	`bŒfs_£t_tok’_time¥ec_£c
(&
tok’
, &
™em
->
Ùime
,

3955 
	`BTRFS_I
(
šode
)->
i_Ùime
.
tv_£c
);

3956 
	`bŒfs_£t_tok’_time¥ec_n£c
(&
tok’
, &
™em
->
Ùime
,

3957 
	`BTRFS_I
(
šode
)->
i_Ùime
.
tv_n£c
);

3959 
	`bŒfs_£t_tok’_šode_nby‹s
(&
tok’
, 
™em
, 
	`šode_g‘_by‹s
(
šode
));

3960 
	`bŒfs_£t_tok’_šode_g’”©iÚ
(&
tok’
, 
™em
,

3961 
	`BTRFS_I
(
šode
)->
g’”©iÚ
);

3962 
	`bŒfs_£t_tok’_šode_£qu’û
(&
tok’
, 
™em
, 
	`šode_³ek_iv”siÚ
(
šode
));

3963 
	`bŒfs_£t_tok’_šode_Œªsid
(&
tok’
, 
™em
, 
Œªs
->
Œªsid
);

3964 
	`bŒfs_£t_tok’_šode_rdev
(&
tok’
, 
™em
, 
šode
->
i_rdev
);

3965 
æags
 = 
	`bŒfs_šode_combše_æags
(
	`BTRFS_I
(
šode
)->flags,

3966 
	`BTRFS_I
(
šode
)->
ro_æags
);

3967 
	`bŒfs_£t_tok’_šode_æags
(&
tok’
, 
™em
, 
æags
);

3968 
	`bŒfs_£t_tok’_šode_block_group
(&
tok’
, 
™em
, 0);

3969 
	}
}

3974 
nošlše
 
	$bŒfs_upd©e_šode_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3975 
bŒfs_roÙ
 *
roÙ
,

3976 
bŒfs_šode
 *
šode
)

3978 
bŒfs_šode_™em
 *
šode_™em
;

3979 
bŒfs_·th
 *
·th
;

3980 
ex‹Á_bufãr
 *
Ëaf
;

3981 
»t
;

3983 
·th
 = 
	`bŒfs_®loc_·th
();

3984 ià(!
·th
)

3985  -
ENOMEM
;

3987 
»t
 = 
	`bŒfs_lookup_šode
(
Œªs
, 
roÙ
, 
·th
, &
šode
->
loÿtiÚ
, 1);

3988 ià(
»t
) {

3989 ià(
»t
 > 0)

3990 
»t
 = -
ENOENT
;

3991 
çed
;

3994 
Ëaf
 = 
·th
->
nodes
[0];

3995 
šode_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

3996 
bŒfs_šode_™em
);

3998 
	`fl_šode_™em
(
Œªs
, 
Ëaf
, 
šode_™em
, &
šode
->
vfs_šode
);

3999 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

4000 
	`bŒfs_£t_šode_Ï¡_Œªs
(
Œªs
, 
šode
);

4001 
»t
 = 0;

4002 
çed
:

4003 
	`bŒfs_ä“_·th
(
·th
);

4004  
»t
;

4005 
	}
}

4010 
nošlše
 
	$bŒfs_upd©e_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4011 
bŒfs_roÙ
 *
roÙ
,

4012 
bŒfs_šode
 *
šode
)

4014 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4015 
»t
;

4024 ià(!
	`bŒfs_is_ä“_¥aû_šode
(
šode
)

4025 && !
	`bŒfs_is_d©a_»loc_roÙ
(
roÙ
)

4026 && !
	`‹¡_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
)) {

4027 
	`bŒfs_upd©e_roÙ_times
(
Œªs
, 
roÙ
);

4029 
»t
 = 
	`bŒfs_d–ayed_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

4030 ià(!
»t
)

4031 
	`bŒfs_£t_šode_Ï¡_Œªs
(
Œªs
, 
šode
);

4032  
»t
;

4035  
	`bŒfs_upd©e_šode_™em
(
Œªs
, 
roÙ
, 
šode
);

4036 
	}
}

4038 
	$bŒfs_upd©e_šode_çÎback
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4039 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_šode
 *
šode
)

4041 
»t
;

4043 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

4044 ià(
»t
 =ğ-
ENOSPC
)

4045  
	`bŒfs_upd©e_šode_™em
(
Œªs
, 
roÙ
, 
šode
);

4046  
»t
;

4047 
	}
}

4055 
	$__bŒfs_uÆšk_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4056 
bŒfs_šode
 *
dœ
,

4057 
bŒfs_šode
 *
šode
,

4058 cÚ¡ 
fsüy±_¡r
 *
Çme
,

4059 
bŒfs_»Çme_ùx
 *
»Çme_ùx
)

4061 
bŒfs_roÙ
 *
roÙ
 = 
dœ
->root;

4062 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4063 
bŒfs_·th
 *
·th
;

4064 
»t
 = 0;

4065 
bŒfs_dœ_™em
 *
di
;

4066 
u64
 
šdex
;

4068 
u64
 
dœ_šo
 = 
	`bŒfs_šo
(
dœ
);

4070 
bŒfs_šode
 *
loÿl_šode
;

4071 
šode
 *
v_šode
 = &šode->
vfs_šode
;

4072 
bŒfs_fs_šfo
 *
fs_šfo_šode
 = 
	`bŒfs_sb
(
v_šode
->
i_sb
);

4073 ià((
v_šode
->
assocŸ‹d_šode
è&& (v_šode->
has_»mÙe
 == 0)) {

4075 
loÿl_šode
 = 
	`BTRFS_I
(
v_šode
->
assocŸ‹d_šode
);

4077 
loÿl_šode
 = 
šode
;

4079 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

4084 
·th
 = 
	`bŒfs_®loc_·th
();

4085 ià(!
·th
) {

4086 
»t
 = -
ENOMEM
;

4087 
out
;

4090 
di
 = 
	`bŒfs_lookup_dœ_™em
(
Œªs
, 
roÙ
, 
·th
, 
dœ_šo
, 
Çme
, -1);

4091 ià(
	`IS_ERR_OR_NULL
(
di
)) {

4092 
»t
 = 
di
 ? 
	`PTR_ERR
(diè: -
ENOENT
;

4093 
”r
;

4095 
»t
 = 
	`bŒfs_d–‘e_Úe_dœ_Çme
(
Œªs
, 
roÙ
, 
·th
, 
di
);

4096 ià(
»t
)

4097 
”r
;

4098 
	`bŒfs_»Ëa£_·th
(
·th
);

4111 ià(
loÿl_šode
->
dœ_šdex
) {

4112 
»t
 = 
	`bŒfs_d–ayed_d–‘e_šode_»f
(
loÿl_šode
);

4113 ià(!
»t
) {

4114 
šdex
 = 
loÿl_šode
->
dœ_šdex
;

4115 
sk_back»f
;

4119 
»t
 = 
	`bŒfs_d–_šode_»f
(
Œªs
, 
roÙ
, 
Çme
, 
šo
, 
dœ_šo
, &
šdex
);

4120 ià(
»t
) {

4121 
	`bŒfs_šfo
(
fs_šfo
,

4123 
Çme
->
Ën
,‚ame->Çme, 
šo
, 
dœ_šo
);

4124 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4125 
”r
;

4127 
sk_back»f
:

4128 ià(
»Çme_ùx
)

4129 
»Çme_ùx
->
šdex
 = index;

4131 
»t
 = 
	`bŒfs_d–‘e_d–ayed_dœ_šdex
(
Œªs
, 
dœ
, 
šdex
);

4132 ià(
»t
) {

4133 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4134 
”r
;

4143 ià(!
»Çme_ùx
) {

4145 
	`bŒfs_d–_šode_»f_š_log
(
Œªs
, 
roÙ
, 
Çme
, 
loÿl_šode
, 
dœ_šo
);

4146 
	`bŒfs_d–_dœ_’Œ›s_š_log
(
Œªs
, 
roÙ
, 
Çme
, 
dœ
, 
šdex
);

4159 
	`bŒfs_run_d–ayed_ut
(
fs_šfo
, 
loÿl_šode
);

4160 
”r
:

4161 
	`bŒfs_ä“_·th
(
·th
);

4162 ià(
»t
)

4163 
out
;

4165 
	`bŒfs_i_size_wr™e
(
dœ
, dœ->
vfs_šode
.
i_size
 - 
Çme
->
Ën
 * 2);

4167 
	`šode_šc_iv”siÚ
(&
loÿl_šode
->
vfs_šode
);

4168 
	`šode_šc_iv”siÚ
(&
dœ
->
vfs_šode
);

4170 
	`šode_£t_ùime_cu¼’t
(&
loÿl_šode
->
vfs_šode
);

4171 
dœ
->
vfs_šode
.
i_mtime
 = 
	`šode_£t_ùime_cu¼’t
(&dir->vfs_inode);

4172 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
dœ
);

4173 
out
:

4174  
»t
;

4175 
	}
}

4177 
	$bŒfs_uÆšk_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4178 
bŒfs_šode
 *
dœ
, bŒfs_šod*
šode
,

4179 cÚ¡ 
fsüy±_¡r
 *
Çme
)

4181 
»t
;

4183 
»t
 = 
	`__bŒfs_uÆšk_šode
(
Œªs
, 
dœ
, 
šode
, 
Çme
, 
NULL
);

4184 ià(!
»t
) {

4185 
	`drİ_Æšk
(&
šode
->
vfs_šode
);

4186 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
šode
->
roÙ
, inode);

4188  
»t
;

4189 
	}
}

4199 
bŒfs_Œªs_hªdË
 *
	$__uÆšk_¡¬t_Œªs
(
bŒfs_šode
 *
dœ
)

4201 
bŒfs_roÙ
 *
roÙ
 = 
dœ
->root;

4203  
	`bŒfs_¡¬t_Œª§ùiÚ_çÎback_glob®_rsv
(
roÙ
,

4204 
BTRFS_UNLINK_METADATA_UNITS
);

4205 
	}
}

4208 
	$bŒfs_uÆšk
(
šode
 *
dœ
, 
d’Œy
 *dentry)

4210 
bŒfs_Œªs_hªdË
 *
Œªs
;

4211 
šode
 *šodğ
	`d_šode
(
d’Œy
);

4217 
šode
 *
loÿl_šode
;

4218 ià((
šode
->
assocŸ‹d_šode
è&& (šode->
has_»mÙe
 == 0))

4219 
loÿl_šode
 = 
šode
->
assocŸ‹d_šode
;

4220 ià(
loÿl_šode
)

4221 
šode
 = 
loÿl_šode
;

4225 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

4226 
fs_id
 = 
fs_šfo
->
id
;

4228 
	`´štk
(
KERN_INFO
 "bŒfs_uÆšk: Inodoàf %d, d’Œy->šodoàf %d", 
dœ
->
fs_id
, 
šode
->fs_id);

4229 
»t
;

4230 
fsüy±_Çme
 
âame
;

4232 
»t
 = 
	`fsüy±_£tup_f’ame
(
dœ
, &
d’Œy
->
d_Çme
, 1, &
âame
);

4233 ià(
»t
)

4234  
»t
;

4238 
Œªs
 = 
	`__uÆšk_¡¬t_Œªs
(
	`BTRFS_I
(
dœ
));

4239 ià(
	`IS_ERR
(
Œªs
)) {

4240 
»t
 = 
	`PTR_ERR
(
Œªs
);

4241 
fsüy±_ä“
;

4245 
	`bŒfs_»cÜd_uÆšk_dœ
(
Œªs
, 
	`BTRFS_I
(
dœ
), BTRFS_I(
šode
),

4246 
çl£
);

4249 
»t
 = 
	`bŒfs_uÆšk_šode
(
Œªs
, 
	`BTRFS_I
(
dœ
), BTRFS_I(
šode
),

4250 &
âame
.
disk_Çme
);

4252 ià(
»t
)

4253 
’d_Œªs
;

4255 ià(
šode
->
i_Æšk
 == 0) {

4256 
»t
 = 
	`bŒfs_Üphª_add
(
Œªs
, 
	`BTRFS_I
(
šode
));

4257 ià(
»t
)

4258 
’d_Œªs
;

4261 
’d_Œªs
:

4262 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4263 
	`bŒfs_bŒ“_b®ªû_dœty
(
	`BTRFS_I
(
dœ
)->
roÙ
->
fs_šfo
);

4264 
fsüy±_ä“
:

4265 
	`fsüy±_ä“_f’ame
(&
âame
);

4266  
»t
;

4267 
	}
}

4269 
	$bŒfs_uÆšk_subvŞ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4270 
bŒfs_šode
 *
dœ
, 
d’Œy
 *dentry)

4272 
bŒfs_roÙ
 *
roÙ
 = 
dœ
->root;

4273 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
	`d_šode
(
d’Œy
));

4274 
bŒfs_·th
 *
·th
;

4275 
ex‹Á_bufãr
 *
Ëaf
;

4276 
bŒfs_dœ_™em
 *
di
;

4277 
bŒfs_key
 
key
;

4278 
u64
 
šdex
;

4279 
»t
;

4280 
u64
 
objeùid
;

4281 
u64
 
dœ_šo
 = 
	`bŒfs_šo
(
dœ
);

4282 
fsüy±_Çme
 
âame
;

4284 
»t
 = 
	`fsüy±_£tup_f’ame
(&
dœ
->
vfs_šode
, &
d’Œy
->
d_Çme
, 1, &
âame
);

4285 ià(
»t
)

4286  
»t
;

4290 ià(
	`bŒfs_šo
(
šode
è=ğ
BTRFS_FIRST_FREE_OBJECTID
) {

4291 
objeùid
 = 
šode
->
roÙ
->
roÙ_key
.objectid;

4292 } ià(
	`bŒfs_šo
(
šode
è=ğ
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
) {

4293 
objeùid
 = 
šode
->
loÿtiÚ
.objectid;

4295 
	`WARN_ON
(1);

4296 
	`fsüy±_ä“_f’ame
(&
âame
);

4297  -
EINVAL
;

4300 
·th
 = 
	`bŒfs_®loc_·th
();

4301 ià(!
·th
) {

4302 
»t
 = -
ENOMEM
;

4303 
out
;

4306 
di
 = 
	`bŒfs_lookup_dœ_™em
(
Œªs
, 
roÙ
, 
·th
, 
dœ_šo
,

4307 &
âame
.
disk_Çme
, -1);

4308 ià(
	`IS_ERR_OR_NULL
(
di
)) {

4309 
»t
 = 
di
 ? 
	`PTR_ERR
(diè: -
ENOENT
;

4310 
out
;

4313 
Ëaf
 = 
·th
->
nodes
[0];

4314 
	`bŒfs_dœ_™em_key_to_ıu
(
Ëaf
, 
di
, &
key
);

4315 
	`WARN_ON
(
key
.
ty³
 !ğ
BTRFS_ROOT_ITEM_KEY
 || key.
objeùid
 != objectid);

4316 
»t
 = 
	`bŒfs_d–‘e_Úe_dœ_Çme
(
Œªs
, 
roÙ
, 
·th
, 
di
);

4317 ià(
»t
) {

4318 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4319 
out
;

4321 
	`bŒfs_»Ëa£_·th
(
·th
);

4332 ià(
	`bŒfs_šo
(
šode
è=ğ
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
) {

4333 
di
 = 
	`bŒfs_£¬ch_dœ_šdex_™em
(
roÙ
, 
·th
, 
dœ_šo
, &
âame
.
disk_Çme
);

4334 ià(
	`IS_ERR_OR_NULL
(
di
)) {

4335 ià(!
di
)

4336 
»t
 = -
ENOENT
;

4338 
»t
 = 
	`PTR_ERR
(
di
);

4339 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4340 
out
;

4343 
Ëaf
 = 
·th
->
nodes
[0];

4344 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

4345 
šdex
 = 
key
.
off£t
;

4346 
	`bŒfs_»Ëa£_·th
(
·th
);

4348 
»t
 = 
	`bŒfs_d–_roÙ_»f
(
Œªs
, 
objeùid
,

4349 
roÙ
->
roÙ_key
.
objeùid
, 
dœ_šo
,

4350 &
šdex
, &
âame
.
disk_Çme
);

4351 ià(
»t
) {

4352 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4353 
out
;

4357 
»t
 = 
	`bŒfs_d–‘e_d–ayed_dœ_šdex
(
Œªs
, 
dœ
, 
šdex
);

4358 ià(
»t
) {

4359 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4360 
out
;

4363 
	`bŒfs_i_size_wr™e
(
dœ
, dœ->
vfs_šode
.
i_size
 - 
âame
.
disk_Çme
.
Ën
 * 2);

4364 
	`šode_šc_iv”siÚ
(&
dœ
->
vfs_šode
);

4365 
dœ
->
vfs_šode
.
i_mtime
 = 
	`šode_£t_ùime_cu¼’t
(&dir->vfs_inode);

4366 
»t
 = 
	`bŒfs_upd©e_šode_çÎback
(
Œªs
, 
roÙ
, 
dœ
);

4367 ià(
»t
)

4368 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4369 
out
:

4370 
	`bŒfs_ä“_·th
(
·th
);

4371 
	`fsüy±_ä“_f’ame
(&
âame
);

4372  
»t
;

4373 
	}
}

4379 
nošlše
 
	$may_de¡roy_subvŞ
(
bŒfs_roÙ
 *
roÙ
)

4381 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4382 
bŒfs_·th
 *
·th
;

4383 
bŒfs_dœ_™em
 *
di
;

4384 
bŒfs_key
 
key
;

4385 
fsüy±_¡r
 
Çme
 = 
	`FSTR_INIT
("default", 7);

4386 
u64
 
dœ_id
;

4387 
»t
;

4389 
·th
 = 
	`bŒfs_®loc_·th
();

4390 ià(!
·th
)

4391  -
ENOMEM
;

4394 
dœ_id
 = 
	`bŒfs_su³r_roÙ_dœ
(
fs_šfo
->
su³r_cİy
);

4395 
di
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
fs_šfo
->
Œ“_roÙ
, 
·th
,

4396 
dœ_id
, &
Çme
, 0);

4397 ià(
di
 && !
	`IS_ERR
(di)) {

4398 
	`bŒfs_dœ_™em_key_to_ıu
(
·th
->
nodes
[0], 
di
, &
key
);

4399 ià(
key
.
objeùid
 =ğ
roÙ
->
roÙ_key
.objectid) {

4400 
»t
 = -
EPERM
;

4401 
	`bŒfs_”r
(
fs_šfo
,

4403 
key
.
objeùid
);

4404 
out
;

4406 
	`bŒfs_»Ëa£_·th
(
·th
);

4409 
key
.
objeùid
 = 
roÙ
->
roÙ_key
.objectid;

4410 
key
.
ty³
 = 
BTRFS_ROOT_REF_KEY
;

4411 
key
.
off£t
 = (
u64
)-1;

4413 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_šfo
->
Œ“_roÙ
, &
key
, 
·th
, 0, 0);

4414 ià(
»t
 < 0)

4415 
out
;

4416 
	`BUG_ON
(
»t
 == 0);

4418 
»t
 = 0;

4419 ià(
·th
->
¦Ùs
[0] > 0) {

4420 
·th
->
¦Ùs
[0]--;

4421 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

4422 ià(
key
.
objeùid
 =ğ
roÙ
->
roÙ_key
.objectid &&

4423 
key
.
ty³
 =ğ
BTRFS_ROOT_REF_KEY
)

4424 
»t
 = -
ENOTEMPTY
;

4426 
out
:

4427 
	`bŒfs_ä“_·th
(
·th
);

4428  
»t
;

4429 
	}
}

4432 
	$bŒfs_´uÃ_d’Œ›s
(
bŒfs_roÙ
 *
roÙ
)

4434 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4435 
rb_node
 *
node
;

4436 
rb_node
 *
´ev
;

4437 
bŒfs_šode
 *
’Œy
;

4438 
šode
 *inode;

4439 
u64
 
objeùid
 = 0;

4441 ià(!
	`BTRFS_FS_ERROR
(
fs_šfo
))

4442 
	`WARN_ON
(
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) != 0);

4444 
	`¥š_lock
(&
roÙ
->
šode_lock
);

4445 
agaš
:

4446 
node
 = 
roÙ
->
šode_Œ“
.
rb_node
;

4447 
´ev
 = 
NULL
;

4448 
node
) {

4449 
´ev
 = 
node
;

4450 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_šode
, 
rb_node
);

4452 ià(
objeùid
 < 
	`bŒfs_šo
(
’Œy
))

4453 
node
 =‚ode->
rb_Ëá
;

4454 ià(
objeùid
 > 
	`bŒfs_šo
(
’Œy
))

4455 
node
 =‚ode->
rb_right
;

4459 ià(!
node
) {

4460 
´ev
) {

4461 
’Œy
 = 
	`rb_’Œy
(
´ev
, 
bŒfs_šode
, 
rb_node
);

4462 ià(
objeùid
 <ğ
	`bŒfs_šo
(
’Œy
)) {

4463 
node
 = 
´ev
;

4466 
´ev
 = 
	`rb_Ãxt
(prev);

4469 
node
) {

4470 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_šode
, 
rb_node
);

4471 
objeùid
 = 
	`bŒfs_šo
(
’Œy
) + 1;

4472 
šode
 = 
	`ig¿b
(&
’Œy
->
vfs_šode
);

4473 ià(
šode
) {

4474 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

4475 ià(
	`©omic_»ad
(&
šode
->
i_couÁ
) > 1)

4476 
	`d_´uÃ_®Ÿ£s
(
šode
);

4481 
	`ut
(
šode
);

4482 
	`cÚd_»sched
();

4483 
	`¥š_lock
(&
roÙ
->
šode_lock
);

4484 
agaš
;

4487 ià(
	`cÚd_»sched_lock
(&
roÙ
->
šode_lock
))

4488 
agaš
;

4490 
node
 = 
	`rb_Ãxt
(node);

4492 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

4493 
	}
}

4495 
	$bŒfs_d–‘e_subvŞume
(
bŒfs_šode
 *
dœ
, 
d’Œy
 *dentry)

4497 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
d’Œy
->
d_sb
);

4498 
bŒfs_roÙ
 *
roÙ
 = 
dœ
->root;

4499 
šode
 *šodğ
	`d_šode
(
d’Œy
);

4500 
bŒfs_roÙ
 *
de¡
 = 
	`BTRFS_I
(
šode
)->
roÙ
;

4501 
bŒfs_Œªs_hªdË
 *
Œªs
;

4502 
bŒfs_block_rsv
 
block_rsv
;

4503 
u64
 
roÙ_æags
;

4504 
»t
;

4511 
	`¥š_lock
(&
de¡
->
roÙ_™em_lock
);

4512 ià(
de¡
->
£nd_š_´og»ss
) {

4513 
	`¥š_uÆock
(&
de¡
->
roÙ_™em_lock
);

4514 
	`bŒfs_w¬n
(
fs_šfo
,

4516 
de¡
->
roÙ_key
.
objeùid
);

4517  -
EPERM
;

4519 ià(
	`©omic_»ad
(&
de¡
->
Ä_sw­fes
)) {

4520 
	`¥š_uÆock
(&
de¡
->
roÙ_™em_lock
);

4521 
	`bŒfs_w¬n
(
fs_šfo
,

4523 
roÙ
->
roÙ_key
.
objeùid
);

4524  -
EPERM
;

4526 
roÙ_æags
 = 
	`bŒfs_roÙ_æags
(&
de¡
->
roÙ_™em
);

4527 
	`bŒfs_£t_roÙ_æags
(&
de¡
->
roÙ_™em
,

4528 
roÙ_æags
 | 
BTRFS_ROOT_SUBVOL_DEAD
);

4529 
	`¥š_uÆock
(&
de¡
->
roÙ_™em_lock
);

4531 
	`down_wr™e
(&
fs_šfo
->
subvŞ_£m
);

4533 
»t
 = 
	`may_de¡roy_subvŞ
(
de¡
);

4534 ià(
»t
)

4535 
out_up_wr™e
;

4537 
	`bŒfs_š™_block_rsv
(&
block_rsv
, 
BTRFS_BLOCK_RSV_TEMP
);

4543 
»t
 = 
	`bŒfs_subvŞume_»£rve_m‘ad©a
(
roÙ
, &
block_rsv
, 5, 
Œue
);

4544 ià(
»t
)

4545 
out_up_wr™e
;

4547 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

4548 ià(
	`IS_ERR
(
Œªs
)) {

4549 
»t
 = 
	`PTR_ERR
(
Œªs
);

4550 
out_»Ëa£
;

4552 
Œªs
->
block_rsv
 = &block_rsv;

4553 
Œªs
->
by‹s_»£rved
 = 
block_rsv
.
size
;

4555 
	`bŒfs_»cÜd_¢­shÙ_de¡roy
(
Œªs
, 
dœ
);

4557 
»t
 = 
	`bŒfs_uÆšk_subvŞ
(
Œªs
, 
dœ
, 
d’Œy
);

4558 ià(
»t
) {

4559 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4560 
out_’d_Œªs
;

4563 
»t
 = 
	`bŒfs_»cÜd_roÙ_š_Œªs
(
Œªs
, 
de¡
);

4564 ià(
»t
) {

4565 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4566 
out_’d_Œªs
;

4569 
	`mem£t
(&
de¡
->
roÙ_™em
.
drİ_´og»ss
, 0,

4570 (
de¡
->
roÙ_™em
.
drİ_´og»ss
));

4571 
	`bŒfs_£t_roÙ_drİ_Ëv–
(&
de¡
->
roÙ_™em
, 0);

4572 
	`bŒfs_£t_roÙ_»fs
(&
de¡
->
roÙ_™em
, 0);

4574 ià(!
	`‹¡_ªd_£t_b™
(
BTRFS_ROOT_ORPHAN_ITEM_INSERTED
, &
de¡
->
¡©e
)) {

4575 
»t
 = 
	`bŒfs_š£¹_Üphª_™em
(
Œªs
,

4576 
fs_šfo
->
Œ“_roÙ
,

4577 
de¡
->
roÙ_key
.
objeùid
);

4578 ià(
»t
) {

4579 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4580 
out_’d_Œªs
;

4584 
»t
 = 
	`bŒfs_uuid_Œ“_»move
(
Œªs
, 
de¡
->
roÙ_™em
.
uuid
,

4585 
BTRFS_UUID_KEY_SUBVOL
,

4586 
de¡
->
roÙ_key
.
objeùid
);

4587 ià(
»t
 &&„‘ !ğ-
ENOENT
) {

4588 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4589 
out_’d_Œªs
;

4591 ià(!
	`bŒfs_is_em±y_uuid
(
de¡
->
roÙ_™em
.
»ûived_uuid
)) {

4592 
»t
 = 
	`bŒfs_uuid_Œ“_»move
(
Œªs
,

4593 
de¡
->
roÙ_™em
.
»ûived_uuid
,

4594 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
,

4595 
de¡
->
roÙ_key
.
objeùid
);

4596 ià(
»t
 &&„‘ !ğ-
ENOENT
) {

4597 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4598 
out_’d_Œªs
;

4602 
	`ä“_ªÚ_bdev
(
de¡
->
ªÚ_dev
);

4603 
de¡
->
ªÚ_dev
 = 0;

4604 
out_’d_Œªs
:

4605 
Œªs
->
block_rsv
 = 
NULL
;

4606 
Œªs
->
by‹s_»£rved
 = 0;

4607 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4608 
šode
->
i_æags
 |ğ
S_DEAD
;

4609 
out_»Ëa£
:

4610 
	`bŒfs_subvŞume_»Ëa£_m‘ad©a
(
roÙ
, &
block_rsv
);

4611 
out_up_wr™e
:

4612 
	`up_wr™e
(&
fs_šfo
->
subvŞ_£m
);

4613 ià(
»t
) {

4614 
	`¥š_lock
(&
de¡
->
roÙ_™em_lock
);

4615 
roÙ_æags
 = 
	`bŒfs_roÙ_æags
(&
de¡
->
roÙ_™em
);

4616 
	`bŒfs_£t_roÙ_æags
(&
de¡
->
roÙ_™em
,

4617 
roÙ_æags
 & ~
BTRFS_ROOT_SUBVOL_DEAD
);

4618 
	`¥š_uÆock
(&
de¡
->
roÙ_™em_lock
);

4620 
	`d_šv®id©e
(
d’Œy
);

4621 
	`bŒfs_´uÃ_d’Œ›s
(
de¡
);

4622 
	`ASSERT
(
de¡
->
£nd_š_´og»ss
 == 0);

4625  
»t
;

4626 
	}
}

4628 
	$bŒfs_rmdœ
(
šode
 *
dœ
, 
d’Œy
 *dentry)

4630 
šode
 *šodğ
	`d_šode
(
d’Œy
);

4631 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`BTRFS_I
(
šode
)->
roÙ
->fs_info;

4632 
”r
 = 0;

4633 
bŒfs_Œªs_hªdË
 *
Œªs
;

4634 
u64
 
Ï¡_uÆšk_Œªs
;

4635 
fsüy±_Çme
 
âame
;

4637 ià(
šode
->
i_size
 > 
BTRFS_EMPTY_DIR_SIZE
)

4638  -
ENOTEMPTY
;

4639 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)è=ğ
BTRFS_FIRST_FREE_OBJECTID
) {

4640 ià(
	`uÆik–y
(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
EXTENT_TREE_V2
))) {

4641 
	`bŒfs_”r
(
fs_šfo
,

4643  -
EOPNOTSUPP
;

4645  
	`bŒfs_d–‘e_subvŞume
(
	`BTRFS_I
(
dœ
), 
d’Œy
);

4648 
”r
 = 
	`fsüy±_£tup_f’ame
(
dœ
, &
d’Œy
->
d_Çme
, 1, &
âame
);

4649 ià(
”r
)

4650  
”r
;

4654 
Œªs
 = 
	`__uÆšk_¡¬t_Œªs
(
	`BTRFS_I
(
dœ
));

4655 ià(
	`IS_ERR
(
Œªs
)) {

4656 
”r
 = 
	`PTR_ERR
(
Œªs
);

4657 
out_nÙ¿ns
;

4660 ià(
	`uÆik–y
(
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)è=ğ
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
)) {

4661 
”r
 = 
	`bŒfs_uÆšk_subvŞ
(
Œªs
, 
	`BTRFS_I
(
dœ
), 
d’Œy
);

4662 
out
;

4665 
”r
 = 
	`bŒfs_Üphª_add
(
Œªs
, 
	`BTRFS_I
(
šode
));

4666 ià(
”r
)

4667 
out
;

4669 
Ï¡_uÆšk_Œªs
 = 
	`BTRFS_I
(
šode
)->last_unlink_trans;

4672 
”r
 = 
	`bŒfs_uÆšk_šode
(
Œªs
, 
	`BTRFS_I
(
dœ
), BTRFS_I(
	`d_šode
(
d’Œy
)),

4673 &
âame
.
disk_Çme
);

4674 ià(!
”r
) {

4675 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
šode
), 0);

4687 ià(
Ï¡_uÆšk_Œªs
 >ğ
Œªs
->
Œªsid
)

4688 
	`BTRFS_I
(
dœ
)->
Ï¡_uÆšk_Œªs
 =†ast_unlink_trans;

4690 
out
:

4691 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4692 
out_nÙ¿ns
:

4693 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

4694 
	`fsüy±_ä“_f’ame
(&
âame
);

4696  
”r
;

4697 
	}
}

4710 
	$bŒfs_Œunÿ‹_block
(
bŒfs_šode
 *
šode
, 
loff_t
 
äom
,†off_ˆ
Ën
,

4711 
äÚt
)

4713 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

4714 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
vfs_šode
.
i_m­pšg
;

4715 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
šode
->io_tree;

4716 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

4717 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

4718 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

4719 
boŞ
 
Úly_»Ëa£_m‘ad©a
 = 
çl£
;

4720 
u32
 
blocksize
 = 
fs_šfo
->
£ùÜsize
;

4721 
pgoff_t
 
šdex
 = 
äom
 >> 
PAGE_SHIFT
;

4722 
off£t
 = 
äom
 & (
blocksize
 - 1);

4723 
·ge
 *page;

4724 
gå_t
 
mask
 = 
	`bŒfs_®loc_wr™e_mask
(
m­pšg
);

4725 
size_t
 
wr™e_by‹s
 = 
blocksize
;

4726 
»t
 = 0;

4727 
u64
 
block_¡¬t
;

4728 
u64
 
block_’d
;

4730 ià(
	`IS_ALIGNED
(
off£t
, 
blocksize
) &&

4731 (!
Ën
 || 
	`IS_ALIGNED
Ö’, 
blocksize
)))

4732 
out
;

4734 
block_¡¬t
 = 
	`round_down
(
äom
, 
blocksize
);

4735 
block_’d
 = 
block_¡¬t
 + 
blocksize
 - 1;

4737 
»t
 = 
	`bŒfs_check_d©a_ä“_¥aû
(
šode
, &
d©a_»£rved
, 
block_¡¬t
,

4738 
blocksize
, 
çl£
);

4739 ià(
»t
 < 0) {

4740 ià(
	`bŒfs_check_nocow_lock
(
šode
, 
block_¡¬t
, &
wr™e_by‹s
, 
çl£
) > 0) {

4742 
Úly_»Ëa£_m‘ad©a
 = 
Œue
;

4744 
out
;

4747 
»t
 = 
	`bŒfs_d–®loc_»£rve_m‘ad©a
(
šode
, 
blocksize
, blocksize, 
çl£
);

4748 ià(
»t
 < 0) {

4749 ià(!
Úly_»Ëa£_m‘ad©a
)

4750 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
šode
, 
d©a_»£rved
,

4751 
block_¡¬t
, 
blocksize
);

4752 
out
;

4754 
agaš
:

4755 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
m­pšg
, 
šdex
, 
mask
);

4756 ià(!
·ge
) {

4757 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
šode
, 
d©a_»£rved
, 
block_¡¬t
,

4758 
blocksize
, 
Œue
);

4759 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
šode
, 
blocksize
);

4760 
»t
 = -
ENOMEM
;

4761 
out
;

4764 ià(!
	`PageU±od©e
(
·ge
)) {

4765 
»t
 = 
	`bŒfs_»ad_fŞio
(
NULL
, 
	`·ge_fŞio
(
·ge
));

4766 
	`lock_·ge
(
·ge
);

4767 ià(
·ge
->
m­pšg
 != mapping) {

4768 
	`uÆock_·ge
(
·ge
);

4769 
	`put_·ge
(
·ge
);

4770 
agaš
;

4772 ià(!
	`PageU±od©e
(
·ge
)) {

4773 
»t
 = -
EIO
;

4774 
out_uÆock
;

4784 
»t
 = 
	`£t_·ge_ex‹Á_m­³d
(
·ge
);

4785 ià(
»t
 < 0)

4786 
out_uÆock
;

4788 
	`wa™_Ú_·ge_wr™eback
(
·ge
);

4790 
	`lock_ex‹Á
(
io_Œ“
, 
block_¡¬t
, 
block_’d
, &
ÿched_¡©e
);

4792 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_ex‹Á
(
šode
, 
block_¡¬t
);

4793 ià(
Üd”ed
) {

4794 
	`uÆock_ex‹Á
(
io_Œ“
, 
block_¡¬t
, 
block_’d
, &
ÿched_¡©e
);

4795 
	`uÆock_·ge
(
·ge
);

4796 
	`put_·ge
(
·ge
);

4797 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
Üd”ed
);

4798 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

4799 
agaš
;

4802 
	`ş—r_ex‹Á_b™
(&
šode
->
io_Œ“
, 
block_¡¬t
, 
block_’d
,

4803 
EXTENT_DELALLOC
 | 
EXTENT_DO_ACCOUNTING
 | 
EXTENT_DEFRAG
,

4804 &
ÿched_¡©e
);

4806 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
šode
, 
block_¡¬t
, 
block_’d
, 0,

4807 &
ÿched_¡©e
);

4808 ià(
»t
) {

4809 
	`uÆock_ex‹Á
(
io_Œ“
, 
block_¡¬t
, 
block_’d
, &
ÿched_¡©e
);

4810 
out_uÆock
;

4813 ià(
off£t
 !ğ
blocksize
) {

4814 ià(!
Ën
)

4815 
Ën
 = 
blocksize
 - 
off£t
;

4816 ià(
äÚt
)

4817 
	`memz”o_·ge
(
·ge
, (
block_¡¬t
 - 
	`·ge_off£t
(page)),

4818 
off£t
);

4820 
	`memz”o_·ge
(
·ge
, (
block_¡¬t
 - 
	`·ge_off£t
Õage)è+ 
off£t
,

4821 
Ën
);

4823 
	`bŒfs_·ge_ş—r_checked
(
fs_šfo
, 
·ge
, 
block_¡¬t
,

4824 
block_’d
 + 1 - 
block_¡¬t
);

4825 
	`bŒfs_·ge_£t_dœty
(
fs_šfo
, 
·ge
, 
block_¡¬t
, 
block_’d
 + 1 - block_start);

4826 
	`uÆock_ex‹Á
(
io_Œ“
, 
block_¡¬t
, 
block_’d
, &
ÿched_¡©e
);

4828 ià(
Úly_»Ëa£_m‘ad©a
)

4829 
	`£t_ex‹Á_b™
(&
šode
->
io_Œ“
, 
block_¡¬t
, 
block_’d
,

4830 
EXTENT_NORESERVE
, 
NULL
);

4832 
out_uÆock
:

4833 ià(
»t
) {

4834 ià(
Úly_»Ëa£_m‘ad©a
)

4835 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
šode
, 
blocksize
, 
Œue
);

4837 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
šode
, 
d©a_»£rved
,

4838 
block_¡¬t
, 
blocksize
, 
Œue
);

4840 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
šode
, 
blocksize
);

4841 
	`uÆock_·ge
(
·ge
);

4842 
	`put_·ge
(
·ge
);

4843 
out
:

4844 ià(
Úly_»Ëa£_m‘ad©a
)

4845 
	`bŒfs_check_nocow_uÆock
(
šode
);

4846 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

4847  
»t
;

4848 
	}
}

4850 
	$maybe_š£¹_hŞe
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_šode
 *
šode
,

4851 
u64
 
off£t
, u64 
Ën
)

4853 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4854 
bŒfs_Œªs_hªdË
 *
Œªs
;

4855 
bŒfs_drİ_ex‹Ás_¬gs
 
drİ_¬gs
 = { 0 };

4856 
»t
;

4864 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
NO_HOLES
))

4872 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 3);

4873 ià(
	`IS_ERR
(
Œªs
))

4874  
	`PTR_ERR
(
Œªs
);

4876 
drİ_¬gs
.
¡¬t
 = 
off£t
;

4877 
drİ_¬gs
.
’d
 = 
off£t
 + 
Ën
;

4878 
drİ_¬gs
.
drİ_ÿche
 = 
Œue
;

4880 
»t
 = 
	`bŒfs_drİ_ex‹Ás
(
Œªs
, 
roÙ
, 
šode
, &
drİ_¬gs
);

4881 ià(
»t
) {

4882 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4883 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4884  
»t
;

4887 
»t
 = 
	`bŒfs_š£¹_hŞe_ex‹Á
(
Œªs
, 
roÙ
, 
	`bŒfs_šo
(
šode
), 
off£t
, 
Ën
);

4888 ià(
»t
) {

4889 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4891 
	`bŒfs_upd©e_šode_by‹s
(
šode
, 0, 
drİ_¬gs
.
by‹s_found
);

4892 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

4894 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4895  
»t
;

4896 
	}
}

4904 
	$bŒfs_cÚt_ex·nd
(
bŒfs_šode
 *
šode
, 
loff_t
 
Şdsize
,†off_ˆ
size
)

4906 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

4907 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4908 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
šode
->io_tree;

4909 
ex‹Á_m­
 *
em
 = 
NULL
;

4910 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

4911 
u64
 
hŞe_¡¬t
 = 
	`ALIGN
(
Şdsize
, 
fs_šfo
->
£ùÜsize
);

4912 
u64
 
block_’d
 = 
	`ALIGN
(
size
, 
fs_šfo
->
£ùÜsize
);

4913 
u64
 
Ï¡_by‹
;

4914 
u64
 
cur_off£t
;

4915 
u64
 
hŞe_size
;

4916 
”r
 = 0;

4923 
”r
 = 
	`bŒfs_Œunÿ‹_block
(
šode
, 
Şdsize
, 0, 0);

4924 ià(
”r
)

4925  
”r
;

4927 ià(
size
 <ğ
hŞe_¡¬t
)

4930 
	`bŒfs_lock_ªd_æush_Üd”ed_¿nge
(
šode
, 
hŞe_¡¬t
, 
block_’d
 - 1,

4931 &
ÿched_¡©e
);

4932 
cur_off£t
 = 
hŞe_¡¬t
;

4934 
em
 = 
	`bŒfs_g‘_ex‹Á
(
šode
, 
NULL
, 0, 
cur_off£t
,

4935 
block_’d
 - 
cur_off£t
);

4936 ià(
	`IS_ERR
(
em
)) {

4937 
”r
 = 
	`PTR_ERR
(
em
);

4938 
em
 = 
NULL
;

4941 
Ï¡_by‹
 = 
	`mš
(
	`ex‹Á_m­_’d
(
em
), 
block_’d
);

4942 
Ï¡_by‹
 = 
	`ALIGN
Öa¡_by‹, 
fs_šfo
->
£ùÜsize
);

4943 
hŞe_size
 = 
Ï¡_by‹
 - 
cur_off£t
;

4945 ià(!
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
)) {

4946 
ex‹Á_m­
 *
hŞe_em
;

4948 
”r
 = 
	`maybe_š£¹_hŞe
(
roÙ
, 
šode
, 
cur_off£t
,

4949 
hŞe_size
);

4950 ià(
”r
)

4953 
”r
 = 
	`bŒfs_šode_£t_fe_ex‹Á_¿nge
(
šode
,

4954 
cur_off£t
, 
hŞe_size
);

4955 ià(
”r
)

4958 
hŞe_em
 = 
	`®loc_ex‹Á_m­
();

4959 ià(!
hŞe_em
) {

4960 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
šode
, 
cur_off£t
,

4961 
cur_off£t
 + 
hŞe_size
 - 1,

4962 
çl£
);

4963 
	`bŒfs_£t_šode_fuÎ_sync
(
šode
);

4964 
Ãxt
;

4966 
hŞe_em
->
¡¬t
 = 
cur_off£t
;

4967 
hŞe_em
->
Ën
 = 
hŞe_size
;

4968 
hŞe_em
->
Üig_¡¬t
 = 
cur_off£t
;

4970 
hŞe_em
->
block_¡¬t
 = 
EXTENT_MAP_HOLE
;

4971 
hŞe_em
->
block_Ën
 = 0;

4972 
hŞe_em
->
Üig_block_Ën
 = 0;

4973 
hŞe_em
->
¿m_by‹s
 = 
hŞe_size
;

4974 
hŞe_em
->
com´ess_ty³
 = 
BTRFS_COMPRESS_NONE
;

4975 
hŞe_em
->
g’”©iÚ
 = 
fs_šfo
->generation;

4977 
”r
 = 
	`bŒfs_»¶aû_ex‹Á_m­_¿nge
(
šode
, 
hŞe_em
, 
Œue
);

4978 
	`ä“_ex‹Á_m­
(
hŞe_em
);

4980 
”r
 = 
	`bŒfs_šode_£t_fe_ex‹Á_¿nge
(
šode
,

4981 
cur_off£t
, 
hŞe_size
);

4982 ià(
”r
)

4985 
Ãxt
:

4986 
	`ä“_ex‹Á_m­
(
em
);

4987 
em
 = 
NULL
;

4988 
cur_off£t
 = 
Ï¡_by‹
;

4989 ià(
cur_off£t
 >ğ
block_’d
)

4992 
	`ä“_ex‹Á_m­
(
em
);

4993 
	`uÆock_ex‹Á
(
io_Œ“
, 
hŞe_¡¬t
, 
block_’d
 - 1, &
ÿched_¡©e
);

4994  
”r
;

4995 
	}
}

4997 
	$bŒfs_£tsize
(
šode
 *šode, 
Ÿ‰r
 *
©Œ
)

4999 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

5000 
bŒfs_Œªs_hªdË
 *
Œªs
;

5001 
loff_t
 
Şdsize
 = 
	`i_size_»ad
(
šode
);

5002 
loff_t
 
Ãwsize
 = 
©Œ
->
Ÿ_size
;

5003 
mask
 = 
©Œ
->
Ÿ_v®id
;

5004 
»t
;

5012 ià(
Ãwsize
 !ğ
Şdsize
) {

5013 
	`šode_šc_iv”siÚ
(
šode
);

5014 ià(!(
mask
 & (
ATTR_CTIME
 | 
ATTR_MTIME
))) {

5015 
šode
->
i_mtime
 = 
	`šode_£t_ùime_cu¼’t
(inode);

5019 ià(
Ãwsize
 > 
Şdsize
) {

5027 
	`bŒfs_d»w_wr™e_lock
(&
roÙ
->
¢­shÙ_lock
);

5028 
»t
 = 
	`bŒfs_cÚt_ex·nd
(
	`BTRFS_I
(
šode
), 
Şdsize
, 
Ãwsize
);

5029 ià(
»t
) {

5030 
	`bŒfs_d»w_wr™e_uÆock
(&
roÙ
->
¢­shÙ_lock
);

5031  
»t
;

5034 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

5035 ià(
	`IS_ERR
(
Œªs
)) {

5036 
	`bŒfs_d»w_wr™e_uÆock
(&
roÙ
->
¢­shÙ_lock
);

5037  
	`PTR_ERR
(
Œªs
);

5040 
	`i_size_wr™e
(
šode
, 
Ãwsize
);

5041 
	`bŒfs_šode_§ã_disk_i_size_wr™e
(
	`BTRFS_I
(
šode
), 0);

5042 
	`·geÿche_isize_ex‹nded
(
šode
, 
Şdsize
, 
Ãwsize
);

5043 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

5044 
	`bŒfs_d»w_wr™e_uÆock
(&
roÙ
->
¢­shÙ_lock
);

5045 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

5047 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

5049 ià(
	`bŒfs_is_zÚed
(
fs_šfo
)) {

5050 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
,

5051 
	`ALIGN
(
Ãwsize
, 
fs_šfo
->
£ùÜsize
),

5052 (
u64
)-1);

5053 ià(
»t
)

5054  
»t
;

5062 ià(
Ãwsize
 == 0)

5063 
	`£t_b™
(
BTRFS_INODE_FLUSH_ON_CLOSE
,

5064 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

5066 
	`Œunÿ‹_£tsize
(
šode
, 
Ãwsize
);

5068 
	`šode_dio_wa™
(
šode
);

5070 
»t
 = 
	`bŒfs_Œunÿ‹
(
	`BTRFS_I
(
šode
), 
Ãwsize
 =ğ
Şdsize
);

5071 ià(
»t
 && 
šode
->
i_Æšk
) {

5072 
”r
;

5080 
”r
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 0, (
u64
)-1);

5081 ià(
”r
)

5082  
”r
;

5083 
	`i_size_wr™e
(
šode
, 
	`BTRFS_I
(šode)->
disk_i_size
);

5087  
»t
;

5088 
	}
}

5090 
	$bŒfs_£‰r
(
mÁ_idm­
 *
idm­
, 
d’Œy
 *dentry,

5091 
Ÿ‰r
 *
©Œ
)

5093 
	`´štk
(
KERN_INFO
 "btrfs_setattr: Called...\n");

5094 
šode
 *šodğ
	`d_šode
(
d’Œy
);

5095 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

5096 
”r
;

5098 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
))

5099  -
EROFS
;

5101 
”r
 = 
	`£‰r_´•¬e
(
idm­
, 
d’Œy
, 
©Œ
);

5102 ià(
”r
)

5103  
”r
;

5105 ià(
	`S_ISREG
(
šode
->
i_mode
è&& (
©Œ
->
Ÿ_v®id
 & 
ATTR_SIZE
)) {

5106 
”r
 = 
	`bŒfs_£tsize
(
šode
, 
©Œ
);

5107 ià(
”r
)

5108  
”r
;

5111 ià(
©Œ
->
Ÿ_v®id
) {

5112 
	`£‰r_cİy
(
idm­
, 
šode
, 
©Œ
);

5113 
	`šode_šc_iv”siÚ
(
šode
);

5114 
”r
 = 
	`bŒfs_dœty_šode
(
	`BTRFS_I
(
šode
));

5116 ià(!
”r
 && 
©Œ
->
Ÿ_v®id
 & 
ATTR_MODE
)

5117 
”r
 = 
	`posix_aş_chmod
(
idm­
, 
d’Œy
, 
šode
->
i_mode
);

5120  
”r
;

5121 
	}
}

5136 
	$eviù_šode_Œunÿ‹_·ges
(
šode
 *inode)

5138 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

5139 
rb_node
 *
node
;

5141 
	`ASSERT
(
šode
->
i_¡©e
 & 
I_FREEING
);

5142 
	`Œunÿ‹_šode_·ges_fš®
(&
šode
->
i_d©a
);

5144 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
	`BTRFS_I
(
šode
), 0, (
u64
)-1, 
çl£
);

5162 
	`¥š_lock
(&
io_Œ“
->
lock
);

5163 !
	`RB_EMPTY_ROOT
(&
io_Œ“
->
¡©e
)) {

5164 
ex‹Á_¡©e
 *
¡©e
;

5165 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

5166 
u64
 
¡¬t
;

5167 
u64
 
’d
;

5168 
¡©e_æags
;

5170 
node
 = 
	`rb_fœ¡
(&
io_Œ“
->
¡©e
);

5171 
¡©e
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©e
, 
rb_node
);

5172 
¡¬t
 = 
¡©e
->start;

5173 
’d
 = 
¡©e
->end;

5174 
¡©e_æags
 = 
¡©e
->state;

5175 
	`¥š_uÆock
(&
io_Œ“
->
lock
);

5177 
	`lock_ex‹Á
(
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

5187 ià(
¡©e_æags
 & 
EXTENT_DELALLOC
)

5188 
	`bŒfs_qgroup_ä“_d©a
(
	`BTRFS_I
(
šode
), 
NULL
, 
¡¬t
,

5189 
’d
 - 
¡¬t
 + 1, 
NULL
);

5191 
	`ş—r_ex‹Á_b™
(
io_Œ“
, 
¡¬t
, 
’d
,

5192 
EXTENT_CLEAR_ALL_BITS
 | 
EXTENT_DO_ACCOUNTING
,

5193 &
ÿched_¡©e
);

5195 
	`cÚd_»sched
();

5196 
	`¥š_lock
(&
io_Œ“
->
lock
);

5198 
	`¥š_uÆock
(&
io_Œ“
->
lock
);

5199 
	}
}

5201 
bŒfs_Œªs_hªdË
 *
	$eviù_»fl_ªd_još
(
bŒfs_roÙ
 *
roÙ
,

5202 
bŒfs_block_rsv
 *
rsv
)

5204 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5205 
bŒfs_Œªs_hªdË
 *
Œªs
;

5206 
u64
 
d–ayed_»fs_exŒa
 = 
	`bŒfs_ÿlc_d–ayed_»f_by‹s
(
fs_šfo
, 1);

5207 
»t
;

5223 
»t
 = 
	`bŒfs_block_rsv_»fl
(
fs_šfo
, 
rsv
,„sv->
size
 + 
d–ayed_»fs_exŒa
,

5224 
BTRFS_RESERVE_FLUSH_EVICT
);

5225 ià(
»t
) {

5226 
»t
 = 
	`bŒfs_block_rsv_»fl
(
fs_šfo
, 
rsv
,„sv->
size
,

5227 
BTRFS_RESERVE_FLUSH_EVICT
);

5228 ià(
»t
) {

5229 
	`bŒfs_w¬n
(
fs_šfo
,

5231  
	`ERR_PTR
(-
ENOSPC
);

5233 
d–ayed_»fs_exŒa
 = 0;

5236 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

5237 ià(
	`IS_ERR
(
Œªs
))

5238  
Œªs
;

5240 ià(
d–ayed_»fs_exŒa
) {

5241 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

5242 
Œªs
->
by‹s_»£rved
 = 
d–ayed_»fs_exŒa
;

5243 
	`bŒfs_block_rsv_mig¿‹
(
rsv
, 
Œªs
->
block_rsv
,

5244 
d–ayed_»fs_exŒa
, 
Œue
);

5246  
Œªs
;

5247 
	}
}

5249 
	$bŒfs_eviù_šode
(
šode
 *inode)

5251 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

5252 
bŒfs_Œªs_hªdË
 *
Œªs
;

5253 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

5254 
bŒfs_block_rsv
 *
rsv
 = 
NULL
;

5255 
»t
;

5257 
	`Œaû_bŒfs_šode_eviù
(
šode
);

5259 ià(!
roÙ
) {

5260 
	`fsv”™y_ş—nup_šode
(
šode
);

5261 
	`ş—r_šode
(
šode
);

5265 
	`eviù_šode_Œunÿ‹_·ges
(
šode
);

5267 ià(
šode
->
i_Æšk
 &&

5268 ((
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) != 0 &&

5269 
roÙ
->
roÙ_key
.
objeùid
 !ğ
BTRFS_ROOT_TREE_OBJECTID
) ||

5270 
	`bŒfs_is_ä“_¥aû_šode
(
	`BTRFS_I
(
šode
))))

5271 
out
;

5273 ià(
	`is_bad_šode
(
šode
))

5274 
out
;

5276 ià(
	`‹¡_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
))

5277 
out
;

5279 ià(
šode
->
i_Æšk
 > 0) {

5280 
	`BUG_ON
(
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) != 0 &&

5281 
roÙ
->
roÙ_key
.
objeùid
 !ğ
BTRFS_ROOT_TREE_OBJECTID
);

5282 
out
;

5289 
»t
 = 
	`bŒfs_comm™_šode_d–ayed_šode
(
	`BTRFS_I
(
šode
));

5290 ià(
»t
)

5291 
out
;

5299 
	`bŒfs_kl_d–ayed_šode_™ems
(
	`BTRFS_I
(
šode
));

5301 
rsv
 = 
	`bŒfs_®loc_block_rsv
(
fs_šfo
, 
BTRFS_BLOCK_RSV_TEMP
);

5302 ià(!
rsv
)

5303 
out
;

5304 
rsv
->
size
 = 
	`bŒfs_ÿlc_m‘ad©a_size
(
fs_šfo
, 1);

5305 
rsv
->
çç¡
 = 
Œue
;

5307 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
šode
), 0);

5310 
bŒfs_Œunÿ‹_cÚŒŞ
 
cÚŒŞ
 = {

5311 .
šode
 = 
	`BTRFS_I
(inode),

5312 .
šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)),

5313 .
Ãw_size
 = 0,

5314 .
mš_ty³
 = 0,

5317 
Œªs
 = 
	`eviù_»fl_ªd_još
(
roÙ
, 
rsv
);

5318 ià(
	`IS_ERR
(
Œªs
))

5319 
out
;

5321 
Œªs
->
block_rsv
 = 
rsv
;

5323 
»t
 = 
	`bŒfs_Œunÿ‹_šode_™ems
(
Œªs
, 
roÙ
, &
cÚŒŞ
);

5324 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

5325 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

5331 
	`bŒfs_bŒ“_b®ªû_dœty_nod–ay
(
fs_šfo
);

5332 ià(
»t
 &&„‘ !ğ-
ENOSPC
 &&„‘ !ğ-
EAGAIN
)

5333 
out
;

5334 ià(!
»t
)

5347 
Œªs
 = 
	`eviù_»fl_ªd_još
(
roÙ
, 
rsv
);

5348 ià(!
	`IS_ERR
(
Œªs
)) {

5349 
Œªs
->
block_rsv
 = 
rsv
;

5350 
	`bŒfs_Üphª_d–
(
Œªs
, 
	`BTRFS_I
(
šode
));

5351 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

5352 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

5355 
out
:

5356 
	`bŒfs_ä“_block_rsv
(
fs_šfo
, 
rsv
);

5362 
	`bŒfs_»move_d–ayed_node
(
	`BTRFS_I
(
šode
));

5363 
	`fsv”™y_ş—nup_šode
(
šode
);

5364 
	`ş—r_šode
(
šode
);

5365 
	}
}

5374 
	$bŒfs_šode_by_Çme
(
bŒfs_šode
 *
dœ
, 
d’Œy
 *dentry,

5375 
bŒfs_key
 *
loÿtiÚ
, 
u8
 *
ty³
)

5377 
bŒfs_dœ_™em
 *
di
;

5378 
bŒfs_·th
 *
·th
;

5379 
bŒfs_roÙ
 *
roÙ
 = 
dœ
->root;

5380 
»t
 = 0;

5381 
fsüy±_Çme
 
âame
;

5384 
šode
 *
dœ_šode
 = &
dœ
->
vfs_šode
;

5385 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ_šode
->
i_sb
);

5389 
·th
 = 
	`bŒfs_®loc_·th
();

5390 ià(!
·th
)

5391  -
ENOMEM
;

5393 
»t
 = 
	`fsüy±_£tup_f’ame
(&
dœ
->
vfs_šode
, &
d’Œy
->
d_Çme
, 1, &
âame
);

5394 ià(
»t
 < 0)

5395 
out
;

5400 
	`ASSERT
(
»t
 == 0);

5404 
di
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
roÙ
, 
·th
, 
	`bŒfs_šo
(
dœ
),

5405 &
âame
.
disk_Çme
, 0);

5406 ià(
	`IS_ERR_OR_NULL
(
di
)) {

5407 
»t
 = 
di
 ? 
	`PTR_ERR
(diè: -
ENOENT
;

5408 
out
;

5411 
	`bŒfs_dœ_™em_key_to_ıu
(
·th
->
nodes
[0], 
di
, 
loÿtiÚ
);

5412 ià(
loÿtiÚ
->
ty³
 !ğ
BTRFS_INODE_ITEM_KEY
 &&

5413 
loÿtiÚ
->
ty³
 !ğ
BTRFS_ROOT_ITEM_KEY
) {

5414 
»t
 = -
EUCLEAN
;

5415 
	`bŒfs_w¬n
(
roÙ
->
fs_šfo
,

5417 
__func__
, 
âame
.
disk_Çme
.
Çme
, 
	`bŒfs_šo
(
dœ
),

5418 
loÿtiÚ
->
objeùid
,†oÿtiÚ->
ty³
,†oÿtiÚ->
off£t
);

5420 ià(!
»t
)

5421 *
ty³
 = 
	`bŒfs_dœ_áy³
(
·th
->
nodes
[0], 
di
);

5422 
out
:

5423 
	`fsüy±_ä“_f’ame
(&
âame
);

5424 
	`bŒfs_ä“_·th
(
·th
);

5425  
»t
;

5426 
	}
}

5433 
	$fixup_Œ“_roÙ_loÿtiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
,

5434 
bŒfs_šode
 *
dœ
,

5435 
d’Œy
 *dentry,

5436 
bŒfs_key
 *
loÿtiÚ
,

5437 
bŒfs_roÙ
 **
sub_roÙ
)

5439 
bŒfs_·th
 *
·th
;

5440 
bŒfs_roÙ
 *
Ãw_roÙ
;

5441 
bŒfs_roÙ_»f
 *
»f
;

5442 
ex‹Á_bufãr
 *
Ëaf
;

5443 
bŒfs_key
 
key
;

5444 
»t
;

5445 
”r
 = 0;

5446 
fsüy±_Çme
 
âame
;

5448 
»t
 = 
	`fsüy±_£tup_f’ame
(&
dœ
->
vfs_šode
, &
d’Œy
->
d_Çme
, 0, &
âame
);

5449 ià(
»t
)

5450  
»t
;

5452 
·th
 = 
	`bŒfs_®loc_·th
();

5453 ià(!
·th
) {

5454 
”r
 = -
ENOMEM
;

5455 
out
;

5458 
”r
 = -
ENOENT
;

5459 
key
.
objeùid
 = 
dœ
->
roÙ
->
roÙ_key
.objectid;

5460 
key
.
ty³
 = 
BTRFS_ROOT_REF_KEY
;

5461 
key
.
off£t
 = 
loÿtiÚ
->
objeùid
;

5463 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_šfo
->
Œ“_roÙ
, &
key
, 
·th
, 0, 0);

5464 ià(
»t
) {

5465 ià(
»t
 < 0)

5466 
”r
 = 
»t
;

5467 
out
;

5470 
Ëaf
 = 
·th
->
nodes
[0];

5471 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_roÙ_»f
);

5472 ià(
	`bŒfs_roÙ_»f_dœid
(
Ëaf
, 
»f
è!ğ
	`bŒfs_šo
(
dœ
) ||

5473 
	`bŒfs_roÙ_»f_Çme_Ën
(
Ëaf
, 
»f
è!ğ
âame
.
disk_Çme
.
Ën
)

5474 
out
;

5476 
»t
 = 
	`memcmp_ex‹Á_bufãr
(
Ëaf
, 
âame
.
disk_Çme
.
Çme
,

5477 ()(
»f
 + 1), 
âame
.
disk_Çme
.
Ën
);

5478 ià(
»t
)

5479 
out
;

5481 
	`bŒfs_»Ëa£_·th
(
·th
);

5483 
Ãw_roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
loÿtiÚ
->
objeùid
, 
Œue
);

5484 ià(
	`IS_ERR
(
Ãw_roÙ
)) {

5485 
”r
 = 
	`PTR_ERR
(
Ãw_roÙ
);

5486 
out
;

5489 *
sub_roÙ
 = 
Ãw_roÙ
;

5490 
loÿtiÚ
->
objeùid
 = 
	`bŒfs_roÙ_dœid
(&
Ãw_roÙ
->
roÙ_™em
);

5491 
loÿtiÚ
->
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

5492 
loÿtiÚ
->
off£t
 = 0;

5493 
”r
 = 0;

5494 
out
:

5495 
	`bŒfs_ä“_·th
(
·th
);

5496 
	`fsüy±_ä“_f’ame
(&
âame
);

5497  
”r
;

5498 
	}
}

5500 
	$šode_Œ“_add
(
bŒfs_šode
 *
šode
)

5502 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

5503 
bŒfs_šode
 *
’Œy
;

5504 
rb_node
 **
p
;

5505 
rb_node
 *
·»Á
;

5506 
rb_node
 *
Ãw
 = &
šode
->rb_node;

5507 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

5509 ià(
	`šode_unhashed
(&
šode
->
vfs_šode
))

5511 
·»Á
 = 
NULL
;

5512 
	`¥š_lock
(&
roÙ
->
šode_lock
);

5513 
p
 = &
roÙ
->
šode_Œ“
.
rb_node
;

5514 *
p
) {

5515 
·»Á
 = *
p
;

5516 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
bŒfs_šode
, 
rb_node
);

5518 ià(
šo
 < 
	`bŒfs_šo
(
’Œy
))

5519 
p
 = &
·»Á
->
rb_Ëá
;

5520 ià(
šo
 > 
	`bŒfs_šo
(
’Œy
))

5521 
p
 = &
·»Á
->
rb_right
;

5523 
	`WARN_ON
(!(
’Œy
->
vfs_šode
.
i_¡©e
 &

5524 (
I_WILL_FREE
 | 
I_FREEING
)));

5525 
	`rb_»¶aû_node
(
·»Á
, 
Ãw
, &
roÙ
->
šode_Œ“
);

5526 
	`RB_CLEAR_NODE
(
·»Á
);

5527 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

5531 
	`rb_lšk_node
(
Ãw
, 
·»Á
, 
p
);

5532 
	`rb_š£¹_cŞÜ
(
Ãw
, &
roÙ
->
šode_Œ“
);

5533 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

5534 
	}
}

5536 
	$šode_Œ“_d–
(
bŒfs_šode
 *
šode
)

5538 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

5539 
em±y
 = 0;

5541 
	`¥š_lock
(&
roÙ
->
šode_lock
);

5542 ià(!
	`RB_EMPTY_NODE
(&
šode
->
rb_node
)) {

5543 
	`rb_”a£
(&
šode
->
rb_node
, &
roÙ
->
šode_Œ“
);

5544 
	`RB_CLEAR_NODE
(&
šode
->
rb_node
);

5545 
em±y
 = 
	`RB_EMPTY_ROOT
(&
roÙ
->
šode_Œ“
);

5547 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

5549 ià(
em±y
 && 
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0) {

5550 
	`¥š_lock
(&
roÙ
->
šode_lock
);

5551 
em±y
 = 
	`RB_EMPTY_ROOT
(&
roÙ
->
šode_Œ“
);

5552 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

5553 ià(
em±y
)

5554 
	`bŒfs_add_d—d_roÙ
(
roÙ
);

5556 
	}
}

5559 
	$bŒfs_š™_locked_šode
(
šode
 *šode, *
p
)

5561 
bŒfs_ig‘_¬gs
 *
¬gs
 = 
p
;

5563 
šode
->
i_šo
 = 
¬gs
->
šo
;

5564 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
objeùid
 = 
¬gs
->
šo
;

5565 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

5566 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
off£t
 = 0;

5567 
	`BTRFS_I
(
šode
)->
roÙ
 = 
	`bŒfs_g¿b_roÙ
(
¬gs
->root);

5568 
	`BUG_ON
(
¬gs
->
roÙ
 && !
	`BTRFS_I
(
šode
)->root);

5570 ià(
¬gs
->
roÙ
 &&‡rgs->roÙ =ğ¬gs->roÙ->
fs_šfo
->
Œ“_roÙ
 &&

5571 
¬gs
->
šo
 !ğ
BTRFS_BTREE_INODE_OBJECTID
)

5572 
	`£t_b™
(
BTRFS_INODE_FREE_SPACE_INODE
,

5573 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

5575 
	}
}

5577 
	$bŒfs_fšd_aùÜ
(
šode
 *šode, *
İaque
)

5579 
bŒfs_ig‘_¬gs
 *
¬gs
 = 
İaque
;

5581  
¬gs
->
šo
 =ğ
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
objeùid
 &&

5582 
¬gs
->
roÙ
 =ğ
	`BTRFS_I
(
šode
)->root;

5583 
	}
}

5585 
šode
 *
	$bŒfs_ig‘_locked
(
su³r_block
 *
s
, 
u64
 
šo
,

5586 
bŒfs_roÙ
 *
roÙ
)

5588 
šode
 *inode;

5589 
bŒfs_ig‘_¬gs
 
¬gs
;

5590 
hashv®
 = 
	`bŒfs_šode_hash
(
šo
, 
roÙ
);

5592 
¬gs
.
šo
 = ino;

5593 
¬gs
.
roÙ
 =„oot;

5595 
šode
 = 
	`ig‘5_locked
(
s
, 
hashv®
, 
bŒfs_fšd_aùÜ
,

5596 
bŒfs_š™_locked_šode
,

5597 (*)&
¬gs
);

5598  
šode
;

5599 
	}
}

5607 
šode
 *
	$bŒfs_ig‘_·th
(
su³r_block
 *
s
, 
u64
 
šo
,

5608 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
)

5610 
šode
 *inode;

5612 
šode
 = 
	`bŒfs_ig‘_locked
(
s
, 
šo
, 
roÙ
);

5613 ià(!
šode
)

5614  
	`ERR_PTR
(-
ENOMEM
);

5616 ià(
šode
->
i_¡©e
 & 
I_NEW
) {

5617 
»t
;

5619 
»t
 = 
	`bŒfs_»ad_locked_šode
(
šode
, 
·th
);

5620 ià(!
»t
) {

5621 
	`šode_Œ“_add
(
	`BTRFS_I
(
šode
));

5622 
	`uÆock_Ãw_šode
(
šode
);

5624 
	`ig‘_çed
(
šode
);

5630 ià(
»t
 > 0)

5631 
»t
 = -
ENOENT
;

5632 
šode
 = 
	`ERR_PTR
(
»t
);

5636  
šode
;

5637 
	}
}

5639 
šode
 *
	$bŒfs_ig‘
(
su³r_block
 *
s
, 
u64
 
šo
, 
bŒfs_roÙ
 *
roÙ
)

5641  
	`bŒfs_ig‘_·th
(
s
, 
šo
, 
roÙ
, 
NULL
);

5642 
	}
}

5644 
šode
 *
	$Ãw_sim¶e_dœ
(
šode
 *
dœ
,

5645 
bŒfs_key
 *
key
,

5646 
bŒfs_roÙ
 *
roÙ
)

5648 
šode
 *šodğ
	`Ãw_šode
(
dœ
->
i_sb
);

5650 ià(!
šode
)

5651  
	`ERR_PTR
(-
ENOMEM
);

5653 
	`BTRFS_I
(
šode
)->
roÙ
 = 
	`bŒfs_g¿b_roÙ
(root);

5654 
	`memıy
(&
	`BTRFS_I
(
šode
)->
loÿtiÚ
, 
key
, (*key));

5655 
	`£t_b™
(
BTRFS_INODE_DUMMY
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

5657 
šode
->
i_šo
 = 
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
;

5662 
šode
->
i_İ
 = &
sim¶e_dœ_šode_İ”©iÚs
;

5663 
šode
->
i_İæags
 &ğ~
IOP_XATTR
;

5664 
šode
->
i_fİ
 = &
sim¶e_dœ_İ”©iÚs
;

5665 
šode
->
i_mode
 = 
S_IFDIR
 | 
S_IRUGO
 | 
S_IWUSR
 | 
S_IXUGO
;

5666 
šode
->
i_mtime
 = 
	`šode_£t_ùime_cu¼’t
(inode);

5667 
šode
->
i_©ime
 = 
dœ
->i_atime;

5668 
	`BTRFS_I
(
šode
)->
i_Ùime
 = inode->
i_mtime
;

5669 
šode
->
i_uid
 = 
dœ
->i_uid;

5670 
šode
->
i_gid
 = 
dœ
->i_gid;

5672  
šode
;

5673 
	}
}

5675 
¡©ic_as£¹
(
BTRFS_FT_UNKNOWN
 =ğ
FT_UNKNOWN
);

5676 
¡©ic_as£¹
(
BTRFS_FT_REG_FILE
 =ğ
FT_REG_FILE
);

5677 
¡©ic_as£¹
(
BTRFS_FT_DIR
 =ğ
FT_DIR
);

5678 
¡©ic_as£¹
(
BTRFS_FT_CHRDEV
 =ğ
FT_CHRDEV
);

5679 
¡©ic_as£¹
(
BTRFS_FT_BLKDEV
 =ğ
FT_BLKDEV
);

5680 
¡©ic_as£¹
(
BTRFS_FT_FIFO
 =ğ
FT_FIFO
);

5681 
¡©ic_as£¹
(
BTRFS_FT_SOCK
 =ğ
FT_SOCK
);

5682 
¡©ic_as£¹
(
BTRFS_FT_SYMLINK
 =ğ
FT_SYMLINK
);

5684 
šlše
 
u8
 
	$bŒfs_šode_ty³
(
šode
 *inode)

5686  
	`fs_umode_to_áy³
(
šode
->
i_mode
);

5687 
	}
}

5689 
šode
 *
	$bŒfs_lookup_d’Œy
(
šode
 *
dœ
, 
d’Œy
 *dentry)

5691 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

5692 
šode
 *inode;

5693 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

5694 
bŒfs_roÙ
 *
sub_roÙ
 = 
roÙ
;

5695 
bŒfs_key
 
loÿtiÚ
;

5696 
u8
 
di_ty³
 = 0;

5697 
»t
 = 0;

5699 ià(
d’Œy
->
d_Çme
.
Ën
 > 
BTRFS_NAME_LEN
)

5700  
	`ERR_PTR
(-
ENAMETOOLONG
);

5702 
»t
 = 
	`bŒfs_šode_by_Çme
(
	`BTRFS_I
(
dœ
), 
d’Œy
, &
loÿtiÚ
, &
di_ty³
);

5703 ià(
»t
 < 0)

5704  
	`ERR_PTR
(
»t
);

5706 ià(
loÿtiÚ
.
ty³
 =ğ
BTRFS_INODE_ITEM_KEY
) {

5707 
šode
 = 
	`bŒfs_ig‘
(
dœ
->
i_sb
, 
loÿtiÚ
.
objeùid
, 
roÙ
);

5708 ià(
	`IS_ERR
(
šode
))

5709  
šode
;

5712 ià(
	`bŒfs_šode_ty³
(
šode
è!ğ
di_ty³
) {

5713 
	`bŒfs_ü™
(
fs_šfo
,

5715 
šode
->
i_mode
, 
	`bŒfs_šode_ty³
(inode),

5716 
di_ty³
);

5717 
	`ut
(
šode
);

5718  
	`ERR_PTR
(-
EUCLEAN
);

5720  
šode
;

5723 
»t
 = 
	`fixup_Œ“_roÙ_loÿtiÚ
(
fs_šfo
, 
	`BTRFS_I
(
dœ
), 
d’Œy
,

5724 &
loÿtiÚ
, &
sub_roÙ
);

5725 ià(
»t
 < 0) {

5726 ià(
»t
 !ğ-
ENOENT
)

5727 
šode
 = 
	`ERR_PTR
(
»t
);

5729 
šode
 = 
	`Ãw_sim¶e_dœ
(
dœ
, &
loÿtiÚ
, 
roÙ
);

5731 
šode
 = 
	`bŒfs_ig‘
(
dœ
->
i_sb
, 
loÿtiÚ
.
objeùid
, 
sub_roÙ
);

5732 
	`bŒfs_put_roÙ
(
sub_roÙ
);

5734 ià(
	`IS_ERR
(
šode
))

5735  
šode
;

5737 
	`down_»ad
(&
fs_šfo
->
ş—nup_wÜk_£m
);

5738 ià(!
	`sb_rdÚly
(
šode
->
i_sb
))

5739 
»t
 = 
	`bŒfs_Üphª_ş—nup
(
sub_roÙ
);

5740 
	`up_»ad
(&
fs_šfo
->
ş—nup_wÜk_£m
);

5741 ià(
»t
) {

5742 
	`ut
(
šode
);

5743 
šode
 = 
	`ERR_PTR
(
»t
);

5747  
šode
;

5748 
	}
}

5750 
šode
 *
	$bŒfs_lookup_d’Œy_mfs
(
šode
 *
dœ
, 
d’Œy
 *dentry)

5753 
šode
 *
»mÙe_dœ
;

5770 
šode
 *
Üig_dœ
 = 
dœ
;

5771 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
Üig_dœ
->
i_sb
);

5774 
šode
 *inode;

5775 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
Üig_dœ
)->root;

5776 
bŒfs_roÙ
 *
sub_roÙ
 = 
roÙ
;

5777 
bŒfs_key
 
loÿtiÚ
;

5778 
u8
 
di_ty³
 = 0;

5779 
»t
 = 0;

5781 
šode
 *
mfs_dœ
 = 
dœ
;

5782 
d’Œy
 *
mfs_d’Œy
;

5784 
mfs_d’Œy
 = 
d’Œy
;

5817 ià(
d’Œy
->
d_Çme
.
Ën
 > 
BTRFS_NAME_LEN
)

5818  
	`ERR_PTR
(-
ENAMETOOLONG
);

5820 
»t
 = 
	`bŒfs_šode_by_Çme
(
	`BTRFS_I
(
Üig_dœ
), 
mfs_d’Œy
, &
loÿtiÚ
, &
di_ty³
);

5821 ià(
»t
 < 0) {

5823  
	`ERR_PTR
(
»t
);

5825 
	`´štk
(
KERN_INFO
 "btrfs_lookup_dentry_mfs: Pass btrfs_inode_by_name\n");

5827 ià(
loÿtiÚ
.
ty³
 =ğ
BTRFS_INODE_ITEM_KEY
) {

5828 
šode
 = 
	`bŒfs_ig‘
(
Üig_dœ
->
i_sb
, 
loÿtiÚ
.
objeùid
, 
roÙ
);

5829 ià(
	`IS_ERR
(
šode
))

5830  
šode
;

5833 ià(
	`bŒfs_šode_ty³
(
šode
è!ğ
di_ty³
) {

5834 
	`bŒfs_ü™
(
fs_šfo
,

5836 
šode
->
i_mode
, 
	`bŒfs_šode_ty³
(inode),

5837 
di_ty³
);

5838 
	`ut
(
šode
);

5839  
	`ERR_PTR
(-
EUCLEAN
);

5842  
šode
;

5845 
»t
 = 
	`fixup_Œ“_roÙ_loÿtiÚ
(
fs_šfo
, 
	`BTRFS_I
(
Üig_dœ
), 
mfs_d’Œy
,

5846 &
loÿtiÚ
, &
sub_roÙ
);

5847 ià(
»t
 < 0) {

5848 ià(
»t
 !ğ-
ENOENT
) {

5850 
šode
 = 
	`ERR_PTR
(
»t
);

5853 
šode
 = 
	`Ãw_sim¶e_dœ
(
Üig_dœ
, &
loÿtiÚ
, 
roÙ
);

5855 
šode
 = 
	`bŒfs_ig‘
(
Üig_dœ
->
i_sb
, 
loÿtiÚ
.
objeùid
, 
sub_roÙ
);

5856 
	`bŒfs_put_roÙ
(
sub_roÙ
);

5858 ià(
	`IS_ERR
(
šode
))

5859  
šode
;

5861 
	`down_»ad
(&
fs_šfo
->
ş—nup_wÜk_£m
);

5862 ià(!
	`sb_rdÚly
(
šode
->
i_sb
))

5863 
»t
 = 
	`bŒfs_Üphª_ş—nup
(
sub_roÙ
);

5864 
	`up_»ad
(&
fs_šfo
->
ş—nup_wÜk_£m
);

5865 ià(
»t
) {

5866 
	`ut
(
šode
);

5867 
šode
 = 
	`ERR_PTR
(
»t
);

5871  
šode
;

5872 
	}
}

5874 
	$bŒfs_d’Œy_d–‘e
(cÚ¡ 
d’Œy
 *dentry)

5876 
bŒfs_roÙ
 *
roÙ
;

5877 
šode
 *šodğ
	`d_šode
(
d’Œy
);

5879 ià(!
šode
 && !
	`IS_ROOT
(
d’Œy
))

5880 
šode
 = 
	`d_šode
(
d’Œy
->
d_·»Á
);

5882 ià(
šode
) {

5883 
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

5884 ià(
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0)

5887 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)è=ğ
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
)

5891 
	}
}

5894 
bŒfs_fs_šfo
 *
	$bŒfs_fs_¶aûm’t_round_robš
(
šode
 *
Üig_dœ
, 
couÁ_šdex
) {

5895 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
Üig_dœ
->
i_sb
);

5896 
loÿl_id
 = 
fs_šfo
->
id
;

5897 
bŒfs_fs_šfo
 *
assigÃd_fs_šfo
;

5899 
¼_šdex
 = 
couÁ_šdex
 % 
BTRFS_SUPER_INFO_COUNT
;

5901 
assigÃd_fs_šfo
 = 
glob®_fs_šfo_li¡
[
¼_šdex
];

5903  
assigÃd_fs_šfo
;

5904 
	}
}

5908 
bŒfs_fs_šfo
 *
	$bŒfs_fs_¶aûm’t
(
šode
 *
Üig_dœ
) {

5909 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
Üig_dœ
->
i_sb
);

5910 
loÿl_id
 = 
fs_šfo
->
id
;

5911 
bŒfs_fs_šfo
 *
assigÃd_fs_šfo
;

5914 
ıu_id
 = 
	`smp_´oûssÜ_id
();

5915 ià(
ıu_id
 !ğ
loÿl_id
)

5916 
assigÃd_fs_šfo
 = 
glob®_fs_šfo_li¡
[
ıu_id
];

5918 
assigÃd_fs_šfo
 = 
fs_šfo
;

5923  
assigÃd_fs_šfo
;

5924 
	}
}

5927 
šode
 *
	$bŒfs_m­_mfsdœ
(
bŒfs_fs_šfo
 *
fs_šfo
) {

5928 
su³r_block
 *
sb
 = 
fs_šfo
->sb;

5929 
d’Œy
 *
mfs_roÙ
 = 
sb
->
s_roÙ
;

5930 
šode
 *
mfs_šode
 = 
mfs_roÙ
->
d_šode
;

5932  
mfs_šode
;

5933 
	}
}

5936 
	$bŒfs_g‘_deviû_id
(
šode
 *
cur_šode
) {

5937 
»t
;

5938 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
cur_šode
->
i_sb
);

5939 
»t
 = 
fs_šfo
->
id
;

5941  
»t
;

5942 
	}
}

5944 
d’Œy
 *
	$bŒfs_lookup
(
šode
 *
dœ
, 
d’Œy
 *dentry,

5945 
æags
)

5947 
	`´štk
(
KERN_INFO
 "btrfs_lookup: Called...\n");

5948 
šode
 *šodğ
	`bŒfs_lookup_d’Œy
(
dœ
, 
d’Œy
);

5950 ià(
šode
 =ğ
	`ERR_PTR
(-
ENOENT
))

5951 
šode
 = 
NULL
;

5952  
	`d_¥liû_®Ÿs
(
šode
, 
d’Œy
);

5953 
	}
}

5956 
d’Œy
 *
	$bŒfs_lookup_mfs
(
šode
 *
dœ
, 
d’Œy
 *dentry,

5957 
æags
)

5959 
	`´štk
(
KERN_INFO
 "bŒfs_lookup_mfs: C®Ëd w™h dœ inodäom fs_id %d‡nd d’Œy from fs_id %d...\n", 
dœ
->
fs_id
, 
d’Œy
->fs_id);

5960 
šode
 *šodğ
	`bŒfs_lookup_d’Œy_mfs
(
dœ
, 
d’Œy
);

5987 ià(
šode
 =ğ
	`ERR_PTR
(-
ENOENT
))

5988 
šode
 = 
NULL
;

5989  
	`d_¥liû_®Ÿs
(
šode
, 
d’Œy
);

5990 
	}
}

5996 
	$bŒfs_£t_šode_šdex_couÁ
(
bŒfs_šode
 *
šode
)

5998 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

5999 
bŒfs_key
 
key
, 
found_key
;

6000 
bŒfs_·th
 *
·th
;

6001 
ex‹Á_bufãr
 *
Ëaf
;

6002 
»t
;

6004 
key
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

6005 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

6006 
key
.
off£t
 = (
u64
)-1;

6008 
·th
 = 
	`bŒfs_®loc_·th
();

6009 ià(!
·th
)

6010  -
ENOMEM
;

6012 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

6013 ià(
»t
 < 0)

6014 
out
;

6016 ià(
»t
 == 0)

6017 
out
;

6018 
»t
 = 0;

6020 ià(
·th
->
¦Ùs
[0] == 0) {

6021 
šode
->
šdex_út
 = 
BTRFS_DIR_START_INDEX
;

6022 
out
;

6025 
·th
->
¦Ùs
[0]--;

6027 
Ëaf
 = 
·th
->
nodes
[0];

6028 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

6030 ià(
found_key
.
objeùid
 !ğ
	`bŒfs_šo
(
šode
) ||

6031 
found_key
.
ty³
 !ğ
BTRFS_DIR_INDEX_KEY
) {

6032 
šode
->
šdex_út
 = 
BTRFS_DIR_START_INDEX
;

6033 
out
;

6036 
šode
->
šdex_út
 = 
found_key
.
off£t
 + 1;

6037 
out
:

6038 
	`bŒfs_ä“_·th
(
·th
);

6039  
»t
;

6040 
	}
}

6042 
	$bŒfs_g‘_dœ_Ï¡_šdex
(
bŒfs_šode
 *
dœ
, 
u64
 *
šdex
)

6044 
»t
 = 0;

6046 
	`bŒfs_šode_lock
(
dœ
, 0);

6047 ià(
dœ
->
šdex_út
 =ğ(
u64
)-1) {

6048 
»t
 = 
	`bŒfs_šode_d–ayed_dœ_šdex_couÁ
(
dœ
);

6049 ià(
»t
) {

6050 
»t
 = 
	`bŒfs_£t_šode_šdex_couÁ
(
dœ
);

6051 ià(
»t
) {

6052 
	`´štk
(
KERN_INFO
 "btrfs_get_dir_last_index: Done…ath\n");

6053 
out
;

6059 *
šdex
 = 
dœ
->
šdex_út
 - 1;

6060 
out
:

6061 
	`bŒfs_šode_uÆock
(
dœ
, 0);

6063  
»t
;

6064 
	}
}

6075 
	$bŒfs_İ’dœ
(
šode
 *šode, 
fe
 *file)

6077 
bŒfs_fe_´iv©e
 *
´iv©e
;

6078 
u64
 
Ï¡_šdex
;

6079 
»t
;

6081 
šode
 *
f_šode
 = 
fe
->f_inode;

6090 
	`´štk
(
KERN_INFO
 "btrfs_opendir: called‡nd got f_inode from file...\n");

6100 
»t
 = 
	`bŒfs_g‘_dœ_Ï¡_šdex
(
	`BTRFS_I
(
f_šode
), &
Ï¡_šdex
);

6101 ià(
»t
)

6102  
»t
;

6104 
´iv©e
 = 
	`kz®loc
((
bŒfs_fe_´iv©e
), 
GFP_KERNEL
);

6105 ià(!
´iv©e
)

6106  -
ENOMEM
;

6107 
´iv©e
->
Ï¡_šdex
 =†ast_index;

6108 
´iv©e
->
fldœ_buf
 = 
	`kz®loc
(
PAGE_SIZE
, 
GFP_KERNEL
);

6109 ià(!
´iv©e
->
fldœ_buf
) {

6110 
	`kä“
(
´iv©e
);

6111  -
ENOMEM
;

6113 
fe
->
´iv©e_d©a
 = 
´iv©e
;

6115 
	}
}

6117 
	$bŒfs_İ’dœ_mfs
(
šode
 *šode, 
fe
 *file)

6119 
bŒfs_fe_´iv©e
 *
´iv©e
;

6120 
u64
 
Ï¡_šdex
;

6121 
»t
;

6141 
is_loÿl_dœ
 = 
šode
->is_local_dir;

6142 
	`´štk
(
KERN_INFO
 "bŒfs_İ’dœ_mfs: C®Ëd o³Àthi šodw™h†oÿl_dœ = %d\n", 
is_loÿl_dœ
);

6144 
»t
 = 
	`bŒfs_g‘_dœ_Ï¡_šdex
(
	`BTRFS_I
(
šode
), &
Ï¡_šdex
);

6146 ià(
»t
)

6147  
»t
;

6149 
´iv©e
 = 
	`kz®loc
((
bŒfs_fe_´iv©e
), 
GFP_KERNEL
);

6150 ià(!
´iv©e
)

6151  -
ENOMEM
;

6152 
´iv©e
->
Ï¡_šdex
 =†ast_index;

6153 
´iv©e
->
fldœ_buf
 = 
	`kz®loc
(
PAGE_SIZE
, 
GFP_KERNEL
);

6154 ià(!
´iv©e
->
fldœ_buf
) {

6155 
	`kä“
(
´iv©e
);

6156  -
ENOMEM
;

6158 
fe
->
´iv©e_d©a
 = 
´iv©e
;

6160 
	}
}

6162 
loff_t
 
	$bŒfs_dœ_Î£ek
(
fe
 *fe, 
loff_t
 
off£t
, 
wh’û
)

6164 
	`´štk
(
KERN_INFO
 "btrfs_dir_llseek: Called...\n");

6165 
bŒfs_fe_´iv©e
 *
´iv©e
 = 
fe
->
´iv©e_d©a
;

6166 
»t
;

6168 
»t
 = 
	`bŒfs_g‘_dœ_Ï¡_šdex
(
	`BTRFS_I
(
	`fe_šode
(
fe
)),

6169 &
´iv©e
->
Ï¡_šdex
);

6170 ià(
»t
)

6171  
»t
;

6173  
	`g’”ic_fe_Î£ek
(
fe
, 
off£t
, 
wh’û
);

6174 
	}
}

6176 
	sdœ_’Œy
 {

6177 
u64
 
	mšo
;

6178 
u64
 
	moff£t
;

6179 
	mty³
;

6180 
	mÇme_Ën
;

6183 
	$bŒfs_fldœ
(*
addr
, 
’Œ›s
, 
dœ_cÚ‹xt
 *
ùx
)

6185 
’Œ›s
--) {

6186 
dœ_’Œy
 *
’Œy
 = 
addr
;

6187 *
Çme
 = (*)(
’Œy
 + 1);

6189 
ùx
->
pos
 = 
	`g‘_uÇligÃd
(&
’Œy
->
off£t
);

6190 ià(!
	`dœ_em™
(
ùx
, 
Çme
, 
	`g‘_uÇligÃd
(&
’Œy
->
Çme_Ën
),

6191 
	`g‘_uÇligÃd
(&
’Œy
->
šo
),

6192 
	`g‘_uÇligÃd
(&
’Œy
->
ty³
)))

6194 
addr
 +ğ(
dœ_’Œy
) +

6195 
	`g‘_uÇligÃd
(&
’Œy
->
Çme_Ën
);

6196 
ùx
->
pos
++;

6199 
	}
}

6201 
	$bŒfs_»®_»addœ
(
fe
 *fe, 
dœ_cÚ‹xt
 *
ùx
)

6203 
	`´štk
(
KERN_INFO
 "btrfs_real_readdir: Called...\n");

6205 
šode
 *šodğ
	`fe_šode
(
fe
);

6206 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

6207 
bŒfs_fe_´iv©e
 *
´iv©e
 = 
fe
->
´iv©e_d©a
;

6208 
bŒfs_dœ_™em
 *
di
;

6209 
bŒfs_key
 
key
;

6210 
bŒfs_key
 
found_key
;

6211 
bŒfs_·th
 *
·th
;

6212 *
addr
;

6213 
	`LIST_HEAD
(
šs_li¡
);

6214 
	`LIST_HEAD
(
d–_li¡
);

6215 
»t
;

6216 *
Çme_±r
;

6217 
Çme_Ën
;

6218 
’Œ›s
 = 0;

6219 
tÙ®_Ën
 = 0;

6220 
boŞ
 
put
 = 
çl£
;

6221 
bŒfs_key
 
loÿtiÚ
;

6223 ià(!
	`dœ_em™_dÙs
(
fe
, 
ùx
))

6226 
·th
 = 
	`bŒfs_®loc_·th
();

6227 ià(!
·th
)

6228  -
ENOMEM
;

6230 
addr
 = 
´iv©e
->
fldœ_buf
;

6231 
·th
->
»ada
 = 
READA_FORWARD
;

6233 
put
 = 
	`bŒfs_»addœ_g‘_d–ayed_™ems
(
šode
, 
´iv©e
->
Ï¡_šdex
,

6234 &
šs_li¡
, &
d–_li¡
);

6236 
agaš
:

6237 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

6238 
key
.
off£t
 = 
ùx
->
pos
;

6239 
key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

6241 
	`bŒfs_fÜ_—ch_¦Ù
(
roÙ
, &
key
, &
found_key
, 
·th
, 
»t
) {

6242 
dœ_’Œy
 *
’Œy
;

6243 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

6244 
u8
 
áy³
;

6246 ià(
found_key
.
objeùid
 !ğ
key
.objectid)

6248 ià(
found_key
.
ty³
 !ğ
BTRFS_DIR_INDEX_KEY
)

6250 ià(
found_key
.
off£t
 < 
ùx
->
pos
)

6252 ià(
found_key
.
off£t
 > 
´iv©e
->
Ï¡_šdex
)

6254 ià(
	`bŒfs_should_d–‘e_dœ_šdex
(&
d–_li¡
, 
found_key
.
off£t
))

6256 
di
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_dœ_™em
);

6257 
Çme_Ën
 = 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
di
);

6258 ià((
tÙ®_Ën
 + (
dœ_’Œy
è+ 
Çme_Ën
) >=

6259 
PAGE_SIZE
) {

6260 
	`bŒfs_»Ëa£_·th
(
·th
);

6261 
»t
 = 
	`bŒfs_fldœ
(
´iv©e
->
fldœ_buf
, 
’Œ›s
, 
ùx
);

6262 ià(
»t
)

6263 
nİos
;

6264 
addr
 = 
´iv©e
->
fldœ_buf
;

6265 
’Œ›s
 = 0;

6266 
tÙ®_Ën
 = 0;

6267 
agaš
;

6270 
áy³
 = 
	`bŒfs_dœ_æags_to_áy³
(
	`bŒfs_dœ_æags
(
Ëaf
, 
di
));

6271 
’Œy
 = 
addr
;

6272 
Çme_±r
 = (*)(
’Œy
 + 1);

6273 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
Çme_±r
,

6274 ()(
di
 + 1), 
Çme_Ën
);

6275 
	`put_uÇligÃd
(
Çme_Ën
, &
’Œy
->name_len);

6276 
	`put_uÇligÃd
(
	`fs_áy³_to_dty³
(
áy³
), &
’Œy
->
ty³
);

6277 
	`bŒfs_dœ_™em_key_to_ıu
(
Ëaf
, 
di
, &
loÿtiÚ
);

6278 
	`put_uÇligÃd
(
loÿtiÚ
.
objeùid
, &
’Œy
->
šo
);

6279 
	`put_uÇligÃd
(
found_key
.
off£t
, &
’Œy
->offset);

6280 
’Œ›s
++;

6281 
addr
 +ğ(
dœ_’Œy
è+ 
Çme_Ën
;

6282 
tÙ®_Ën
 +ğ(
dœ_’Œy
è+ 
Çme_Ën
;

6285 ià(
»t
 < 0)

6286 
”r
;

6288 
	`bŒfs_»Ëa£_·th
(
·th
);

6290 
»t
 = 
	`bŒfs_fldœ
(
´iv©e
->
fldœ_buf
, 
’Œ›s
, 
ùx
);

6291 ià(
»t
)

6292 
nİos
;

6294 
»t
 = 
	`bŒfs_»addœ_d–ayed_dœ_šdex
(
ùx
, &
šs_li¡
);

6295 ià(
»t
)

6296 
nİos
;

6315 ià(
ùx
->
pos
 >ğ
INT_MAX
)

6316 
ùx
->
pos
 = 
LLONG_MAX
;

6318 
ùx
->
pos
 = 
INT_MAX
;

6319 
nİos
:

6320 
»t
 = 0;

6321 
”r
:

6322 ià(
put
)

6323 
	`bŒfs_»addœ_put_d–ayed_™ems
(
šode
, &
šs_li¡
, &
d–_li¡
);

6324 
	`bŒfs_ä“_·th
(
·th
);

6325  
»t
;

6326 
	}
}

6334 
	$bŒfs_dœty_šode
(
bŒfs_šode
 *
šode
)

6336 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

6337 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

6338 
bŒfs_Œªs_hªdË
 *
Œªs
;

6339 
»t
;

6341 ià(
	`‹¡_b™
(
BTRFS_INODE_DUMMY
, &
šode
->
ruÁime_æags
))

6344 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

6345 ià(
	`IS_ERR
(
Œªs
))

6346  
	`PTR_ERR
(
Œªs
);

6348 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

6349 ià(
»t
 && (»ˆ=ğ-
ENOSPC
 ||„‘ =ğ-
EDQUOT
)) {

6351 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

6352 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

6353 ià(
	`IS_ERR
(
Œªs
))

6354  
	`PTR_ERR
(
Œªs
);

6356 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

6358 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

6359 ià(
šode
->
d–ayed_node
)

6360 
	`bŒfs_b®ªû_d–ayed_™ems
(
fs_šfo
);

6362  
»t
;

6363 
	}
}

6369 
	$bŒfs_upd©e_time
(
šode
 *šode, 
æags
)

6371 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

6372 
boŞ
 
dœty
 = 
æags
 & ~
S_VERSION
;

6374 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
))

6375  -
EROFS
;

6377 
dœty
 = 
	`šode_upd©e_time¡amps
(
šode
, 
æags
);

6378  
dœty
 ? 
	`bŒfs_dœty_šode
(
	`BTRFS_I
(
šode
)) : 0;

6379 
	}
}

6385 
	$bŒfs_£t_šode_šdex
(
bŒfs_šode
 *
dœ
, 
u64
 *
šdex
)

6387 
»t
 = 0;

6389 ià(
dœ
->
šdex_út
 =ğ(
u64
)-1) {

6390 
»t
 = 
	`bŒfs_šode_d–ayed_dœ_šdex_couÁ
(
dœ
);

6391 ià(
»t
) {

6392 
»t
 = 
	`bŒfs_£t_šode_šdex_couÁ
(
dœ
);

6393 ià(
»t
)

6394  
»t
;

6398 *
šdex
 = 
dœ
->
šdex_út
;

6399 
dœ
->
šdex_út
++;

6401  
»t
;

6402 
	}
}

6404 
	$bŒfs_£t_šode_šdex_mfs
(
bŒfs_šode
 *
dœ
, bŒfs_šod*
loÿl_dœ
, 
u64
 *
šdex
, u64 *
loÿl_šdex
)

6406 
»t
 = 0;

6409 ià(
loÿl_dœ
->
šdex_út
 =ğ(
u64
)-1) {

6410 
»t
 = 
	`bŒfs_šode_d–ayed_dœ_šdex_couÁ
(
loÿl_dœ
);

6411 ià(
»t
) {

6413 
»t
 = 
	`bŒfs_£t_šode_šdex_couÁ
(
dœ
);

6414 ià(
»t
)

6415  
»t
;

6419 *
šdex
 = 
dœ
->
šdex_út
;

6420 *
loÿl_šdex
 = 
loÿl_dœ
->
šdex_út
;

6421 
loÿl_dœ
->
šdex_út
++;

6422 
dœ
->
šdex_út
++;

6424  
»t
;

6425 
	}
}

6427 
	$bŒfs_š£¹_šode_locked
(
šode
 *inode)

6429 
bŒfs_ig‘_¬gs
 
¬gs
;

6431 
¬gs
.
šo
 = 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
objeùid
;

6432 
¬gs
.
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

6434  
	`š£¹_šode_locked4
(
šode
,

6435 
	`bŒfs_šode_hash
(
šode
->
i_šo
, 
	`BTRFS_I
(šode)->
roÙ
),

6436 
bŒfs_fšd_aùÜ
, &
¬gs
);

6437 
	}
}

6439 
	$bŒfs_Ãw_šode_´•¬e
(
bŒfs_Ãw_šode_¬gs
 *
¬gs
,

6440 *
Œªs_num_™ems
)

6442 
šode
 *
dœ
 = 
¬gs
->dir;

6443 
šode
 *šodğ
¬gs
->inode;

6444 
»t
;

6446 ià(!
¬gs
->
Üphª
) {

6447 
»t
 = 
	`fsüy±_£tup_f’ame
(
dœ
, &
¬gs
->
d’Œy
->
d_Çme
, 0,

6448 &
¬gs
->
âame
);

6449 ià(
»t
)

6450  
»t
;

6453 
»t
 = 
	`posix_aş_ü—‹
(
dœ
, &
šode
->
i_mode
, &
¬gs
->
deçuÉ_aş
, &¬gs->
aş
);

6454 ià(
»t
) {

6455 
	`fsüy±_ä“_f’ame
(&
¬gs
->
âame
);

6456  
»t
;

6460 *
Œªs_num_™ems
 = 1;

6462 ià(
	`BTRFS_I
(
dœ
)->
´İ_com´ess
)

6463 (*
Œªs_num_™ems
)++;

6465 ià(
¬gs
->
deçuÉ_aş
)

6466 (*
Œªs_num_™ems
)++;

6468 ià(
¬gs
->
aş
)

6469 (*
Œªs_num_™ems
)++;

6470 #ifdeà
CONFIG_SECURITY


6472 ià(
dœ
->
i_£cur™y
)

6473 (*
Œªs_num_™ems
)++;

6475 ià(
¬gs
->
Üphª
) {

6477 (*
Œªs_num_™ems
)++;

6488 *
Œªs_num_™ems
 += 3;

6491 
	}
}

6493 
	$bŒfs_Ãw_šode_¬gs_de¡roy
(
bŒfs_Ãw_šode_¬gs
 *
¬gs
)

6495 
	`posix_aş_»Ëa£
(
¬gs
->
aş
);

6496 
	`posix_aş_»Ëa£
(
¬gs
->
deçuÉ_aş
);

6497 
	`fsüy±_ä“_f’ame
(&
¬gs
->
âame
);

6498 
	}
}

6505 
	$bŒfs_šh”™_iæags
(
bŒfs_šode
 *
šode
, bŒfs_šod*
dœ
)

6507 
æags
;

6509 
æags
 = 
dœ
->flags;

6511 ià(
æags
 & 
BTRFS_INODE_NOCOMPRESS
) {

6512 
šode
->
æags
 &ğ~
BTRFS_INODE_COMPRESS
;

6513 
šode
->
æags
 |ğ
BTRFS_INODE_NOCOMPRESS
;

6514 } ià(
æags
 & 
BTRFS_INODE_COMPRESS
) {

6515 
šode
->
æags
 &ğ~
BTRFS_INODE_NOCOMPRESS
;

6516 
šode
->
æags
 |ğ
BTRFS_INODE_COMPRESS
;

6519 ià(
æags
 & 
BTRFS_INODE_NODATACOW
) {

6520 
šode
->
æags
 |ğ
BTRFS_INODE_NODATACOW
;

6521 ià(
	`S_ISREG
(
šode
->
vfs_šode
.
i_mode
))

6522 
šode
->
æags
 |ğ
BTRFS_INODE_NODATASUM
;

6525 
	`bŒfs_sync_šode_æags_to_i_æags
(&
šode
->
vfs_šode
);

6526 
	}
}

6528 
	$bŒfs_ü—‹_Ãw_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6529 
bŒfs_Ãw_šode_¬gs
 *
¬gs
)

6531 
šode
 *
dœ
 = 
¬gs
->dir;

6532 
šode
 *šodğ
¬gs
->inode;

6533 cÚ¡ 
fsüy±_¡r
 *
Çme
 = 
¬gs
->
Üphª
 ? 
NULL
 : &¬gs->
âame
.
disk_Çme
;

6534 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

6535 
bŒfs_roÙ
 *
roÙ
;

6536 
bŒfs_šode_™em
 *
šode_™em
;

6537 
bŒfs_key
 *
loÿtiÚ
;

6538 
bŒfs_·th
 *
·th
;

6539 
u64
 
objeùid
;

6540 
bŒfs_šode_»f
 *
»f
;

6541 
bŒfs_key
 
key
[2];

6542 
u32
 
sizes
[2];

6543 
bŒfs_™em_b©ch
 
b©ch
;

6544 
±r
;

6545 
»t
;

6548 
·th
 = 
	`bŒfs_®loc_·th
();

6549 ià(!
·th
)

6550  -
ENOMEM
;

6552 ià(!
¬gs
->
subvŞ
)

6553 
	`BTRFS_I
(
šode
)->
roÙ
 = 
	`bŒfs_g¿b_roÙ
(BTRFS_I(
dœ
)->root);

6554 
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

6556 
»t
 = 
	`bŒfs_g‘_ä“_objeùid
(
roÙ
, &
objeùid
);

6557 ià(
»t
)

6558 
out
;

6559 
šode
->
i_šo
 = 
objeùid
;

6561 ià(
¬gs
->
Üphª
) {

6566 
	`£t_Æšk
(
šode
, 0);

6568 
	`Œaû_bŒfs_šode_»que¡
(
dœ
);

6570 
»t
 = 
	`bŒfs_£t_šode_šdex
(
	`BTRFS_I
(
dœ
), &BTRFS_I(
šode
)->
dœ_šdex
);

6571 ià(
»t
)

6572 
out
;

6575 
	`BTRFS_I
(
šode
)->
šdex_út
 = 
BTRFS_DIR_START_INDEX
;

6576 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 
Œªs
->
Œªsid
;

6577 
šode
->
i_g’”©iÚ
 = 
	`BTRFS_I
(šode)->
g’”©iÚ
;

6584 ià(!
¬gs
->
subvŞ
)

6585 
	`bŒfs_šh”™_iæags
(
	`BTRFS_I
(
šode
), BTRFS_I(
dœ
));

6587 ià(
	`S_ISREG
(
šode
->
i_mode
)) {

6588 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
NODATASUM
))

6589 
	`BTRFS_I
(
šode
)->
æags
 |ğ
BTRFS_INODE_NODATASUM
;

6590 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
NODATACOW
))

6591 
	`BTRFS_I
(
šode
)->
æags
 |ğ
BTRFS_INODE_NODATACOW
 |

6592 
BTRFS_INODE_NODATASUM
;

6595 
loÿtiÚ
 = &
	`BTRFS_I
(
šode
)->location;

6596 
loÿtiÚ
->
objeùid
 = objectid;

6597 
loÿtiÚ
->
off£t
 = 0;

6598 
loÿtiÚ
->
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

6600 
»t
 = 
	`bŒfs_š£¹_šode_locked
(
šode
);

6601 ià(
»t
 < 0) {

6602 ià(!
¬gs
->
Üphª
)

6603 
	`BTRFS_I
(
dœ
)->
šdex_út
--;

6604 
out
;

6613 
	`bŒfs_£t_šode_fuÎ_sync
(
	`BTRFS_I
(
šode
));

6615 
key
[0].
objeùid
 = objectid;

6616 
key
[0].
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

6617 
key
[0].
off£t
 = 0;

6619 
sizes
[0] = (
bŒfs_šode_™em
);

6621 ià(!
¬gs
->
Üphª
) {

6628 
key
[1].
objeùid
 = objectid;

6629 
key
[1].
ty³
 = 
BTRFS_INODE_REF_KEY
;

6630 ià(
¬gs
->
subvŞ
) {

6631 
key
[1].
off£t
 = 
objeùid
;

6632 
sizes
[1] = 2 + (*
»f
);

6634 
key
[1].
off£t
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
));

6635 
sizes
[1] = 
Çme
->
Ën
 + (*
»f
);

6639 
b©ch
.
keys
 = &
key
[0];

6640 
b©ch
.
d©a_sizes
 = &
sizes
[0];

6641 
b©ch
.
tÙ®_d©a_size
 = 
sizes
[0] + (
¬gs
->
Üphª
 ? 0 : sizes[1]);

6642 
b©ch
.
Ä
 = 
¬gs
->
Üphª
 ? 1 : 2;

6643 
»t
 = 
	`bŒfs_š£¹_em±y_™ems
(
Œªs
, 
roÙ
, 
·th
, &
b©ch
);

6644 ià(
»t
 != 0) {

6645 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

6646 
disÿrd
;

6649 
šode
->
i_mtime
 = 
	`šode_£t_ùime_cu¼’t
(inode);

6650 
šode
->
i_©ime
 = inode->
i_mtime
;

6651 
	`BTRFS_I
(
šode
)->
i_Ùime
 = inode->
i_mtime
;

6658 
šode_™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

6659 
bŒfs_šode_™em
);

6660 
	`memz”o_ex‹Á_bufãr
(
·th
->
nodes
[0], ()
šode_™em
,

6661 (*
šode_™em
));

6662 
	`fl_šode_™em
(
Œªs
, 
·th
->
nodes
[0], 
šode_™em
, 
šode
);

6664 ià(!
¬gs
->
Üphª
) {

6665 
»f
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0] + 1,

6666 
bŒfs_šode_»f
);

6667 
±r
 = ()(
»f
 + 1);

6668 ià(
¬gs
->
subvŞ
) {

6669 
	`bŒfs_£t_šode_»f_Çme_Ën
(
·th
->
nodes
[0], 
»f
, 2);

6670 
	`bŒfs_£t_šode_»f_šdex
(
·th
->
nodes
[0], 
»f
, 0);

6671 
	`wr™e_ex‹Á_bufãr
(
·th
->
nodes
[0], "..", 
±r
, 2);

6673 
	`bŒfs_£t_šode_»f_Çme_Ën
(
·th
->
nodes
[0], 
»f
,

6674 
Çme
->
Ën
);

6675 
	`bŒfs_£t_šode_»f_šdex
(
·th
->
nodes
[0], 
»f
,

6676 
	`BTRFS_I
(
šode
)->
dœ_šdex
);

6677 
	`wr™e_ex‹Á_bufãr
(
·th
->
nodes
[0], 
Çme
->Çme, 
±r
,

6678 
Çme
->
Ën
);

6682 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·th
->
nodes
[0]);

6688 
	`bŒfs_ä“_·th
(
·th
);

6689 
·th
 = 
NULL
;

6691 ià(
¬gs
->
subvŞ
) {

6692 
šode
 *
·»Á
;

6698 
·»Á
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
BTRFS_FIRST_FREE_OBJECTID
,

6699 
	`BTRFS_I
(
dœ
)->
roÙ
);

6700 ià(
	`IS_ERR
(
·»Á
)) {

6701 
»t
 = 
	`PTR_ERR
(
·»Á
);

6703 
»t
 = 
	`bŒfs_šode_šh”™_´İs
(
Œªs
, 
šode
, 
·»Á
);

6704 
	`ut
(
·»Á
);

6707 
»t
 = 
	`bŒfs_šode_šh”™_´İs
(
Œªs
, 
šode
, 
dœ
);

6709 ià(
»t
) {

6710 
	`bŒfs_”r
(
fs_šfo
,

6712 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 
roÙ
->
roÙ_key
.
objeùid
,

6713 
»t
);

6720 ià(!
¬gs
->
subvŞ
) {

6721 
»t
 = 
	`bŒfs_š™_šode_£cur™y
(
Œªs
, 
¬gs
);

6722 ià(
»t
) {

6723 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

6724 
disÿrd
;

6728 
	`šode_Œ“_add
(
	`BTRFS_I
(
šode
));

6730 
	`Œaû_bŒfs_šode_Ãw
(
šode
);

6731 
	`bŒfs_£t_šode_Ï¡_Œªs
(
Œªs
, 
	`BTRFS_I
(
šode
));

6733 
	`bŒfs_upd©e_roÙ_times
(
Œªs
, 
roÙ
);

6735 ià(
¬gs
->
Üphª
) {

6736 
»t
 = 
	`bŒfs_Üphª_add
(
Œªs
, 
	`BTRFS_I
(
šode
));

6738 
»t
 = 
	`bŒfs_add_lšk
(
Œªs
, 
	`BTRFS_I
(
dœ
), BTRFS_I(
šode
), 
Çme
,

6739 0, 
	`BTRFS_I
(
šode
)->
dœ_šdex
);

6741 ià(
»t
) {

6742 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

6743 
disÿrd
;

6748 
disÿrd
:

6753 
	`ihŞd
(
šode
);

6754 
	`disÿrd_Ãw_šode
(
šode
);

6755 
out
:

6756 
	`bŒfs_ä“_·th
(
·th
);

6757  
»t
;

6758 
	}
}

6760 
	$bŒfs_ü—‹_Ãw_šode_mfs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6761 
bŒfs_Ãw_šode_¬gs
 *
¬gs
)

6763 
šode
 *
dœ
 = 
¬gs
->dir;

6764 
šode
 *
loÿl_dœ
 = 
¬gs
->local_dir;

6765 
šode
 *šodğ
¬gs
->inode;

6766 
šode
 *
loÿl_šode
 = 
¬gs
->local_inode;

6768 cÚ¡ 
fsüy±_¡r
 *
Çme
 = 
¬gs
->
Üphª
 ? 
NULL
 : &¬gs->
âame
.
disk_Çme
;

6769 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

6770 
bŒfs_roÙ
 *
roÙ
;

6771 
bŒfs_šode_™em
 *
šode_™em
;

6772 
bŒfs_key
 *
loÿtiÚ
;

6773 
bŒfs_·th
 *
·th
;

6774 
u64
 
objeùid
;

6775 
bŒfs_šode_»f
 *
»f
;

6776 
bŒfs_key
 
key
[2];

6777 
u32
 
sizes
[2];

6778 
bŒfs_™em_b©ch
 
b©ch
;

6779 
±r
;

6780 
»t
;

6782 
·th
 = 
	`bŒfs_®loc_·th
();

6783 ià(!
·th
)

6784  -
ENOMEM
;

6786 ià(!
¬gs
->
subvŞ
)

6787 
	`BTRFS_I
(
šode
)->
roÙ
 = 
	`bŒfs_g¿b_roÙ
(BTRFS_I(
dœ
)->root);

6788 
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

6790 
»t
 = 
	`bŒfs_g‘_ä“_objeùid
(
roÙ
, &
objeùid
);

6791 ià(
»t
)

6792 
out
;

6793 
šode
->
i_šo
 = 
objeùid
;

6795 ià(
¬gs
->
Üphª
) {

6800 
	`£t_Æšk
(
šode
, 0);

6802 
	`Œaû_bŒfs_šode_»que¡
(
dœ
);

6804 
»t
 = 
	`bŒfs_£t_šode_šdex_mfs
(
	`BTRFS_I
(
dœ
), BTRFS_I(
loÿl_dœ
), &BTRFS_I(
šode
)->
dœ_šdex
, &BTRFS_I(
loÿl_šode
)->dir_index);

6805 ià(
»t
)

6806 
out
;

6809 
	`BTRFS_I
(
šode
)->
šdex_út
 = 
BTRFS_DIR_START_INDEX
;

6810 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 
Œªs
->
Œªsid
;

6811 
šode
->
i_g’”©iÚ
 = 
	`BTRFS_I
(šode)->
g’”©iÚ
;

6818 ià(!
¬gs
->
subvŞ
)

6819 
	`bŒfs_šh”™_iæags
(
	`BTRFS_I
(
šode
), BTRFS_I(
dœ
));

6821 ià(
	`S_ISREG
(
šode
->
i_mode
)) {

6822 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
NODATASUM
))

6823 
	`BTRFS_I
(
šode
)->
æags
 |ğ
BTRFS_INODE_NODATASUM
;

6824 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
NODATACOW
))

6825 
	`BTRFS_I
(
šode
)->
æags
 |ğ
BTRFS_INODE_NODATACOW
 |

6826 
BTRFS_INODE_NODATASUM
;

6829 
loÿtiÚ
 = &
	`BTRFS_I
(
šode
)->location;

6830 
loÿtiÚ
->
objeùid
 = objectid;

6831 
loÿtiÚ
->
off£t
 = 0;

6832 
loÿtiÚ
->
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

6834 
»t
 = 
	`bŒfs_š£¹_šode_locked
(
šode
);

6835 ià(
»t
 < 0) {

6836 ià(!
¬gs
->
Üphª
)

6837 
	`BTRFS_I
(
dœ
)->
šdex_út
--;

6838 
out
;

6847 
	`bŒfs_£t_šode_fuÎ_sync
(
	`BTRFS_I
(
šode
));

6849 
key
[0].
objeùid
 = objectid;

6850 
key
[0].
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

6851 
key
[0].
off£t
 = 0;

6853 
sizes
[0] = (
bŒfs_šode_™em
);

6855 ià(!
¬gs
->
Üphª
) {

6862 
key
[1].
objeùid
 = objectid;

6863 
key
[1].
ty³
 = 
BTRFS_INODE_REF_KEY
;

6864 ià(
¬gs
->
subvŞ
) {

6865 
key
[1].
off£t
 = 
objeùid
;

6866 
sizes
[1] = 2 + (*
»f
);

6868 
key
[1].
off£t
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
));

6869 
sizes
[1] = 
Çme
->
Ën
 + (*
»f
);

6873 
b©ch
.
keys
 = &
key
[0];

6874 
b©ch
.
d©a_sizes
 = &
sizes
[0];

6875 
b©ch
.
tÙ®_d©a_size
 = 
sizes
[0] + (
¬gs
->
Üphª
 ? 0 : sizes[1]);

6876 
b©ch
.
Ä
 = 
¬gs
->
Üphª
 ? 1 : 2;

6877 
»t
 = 
	`bŒfs_š£¹_em±y_™ems
(
Œªs
, 
roÙ
, 
·th
, &
b©ch
);

6878 ià(
»t
 != 0) {

6879 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

6880 
disÿrd
;

6883 
šode
->
i_mtime
 = 
	`šode_£t_ùime_cu¼’t
(inode);

6884 
šode
->
i_©ime
 = inode->
i_mtime
;

6885 
	`BTRFS_I
(
šode
)->
i_Ùime
 = inode->
i_mtime
;

6892 
šode_™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

6893 
bŒfs_šode_™em
);

6894 
	`memz”o_ex‹Á_bufãr
(
·th
->
nodes
[0], ()
šode_™em
,

6895 (*
šode_™em
));

6896 
	`fl_šode_™em
(
Œªs
, 
·th
->
nodes
[0], 
šode_™em
, 
šode
);

6898 ià(!
¬gs
->
Üphª
) {

6899 
»f
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0] + 1,

6900 
bŒfs_šode_»f
);

6901 
±r
 = ()(
»f
 + 1);

6902 ià(
¬gs
->
subvŞ
) {

6903 
	`bŒfs_£t_šode_»f_Çme_Ën
(
·th
->
nodes
[0], 
»f
, 2);

6904 
	`bŒfs_£t_šode_»f_šdex
(
·th
->
nodes
[0], 
»f
, 0);

6905 
	`wr™e_ex‹Á_bufãr
(
·th
->
nodes
[0], "..", 
±r
, 2);

6907 
	`bŒfs_£t_šode_»f_Çme_Ën
(
·th
->
nodes
[0], 
»f
,

6908 
Çme
->
Ën
);

6909 
	`bŒfs_£t_šode_»f_šdex
(
·th
->
nodes
[0], 
»f
,

6910 
	`BTRFS_I
(
šode
)->
dœ_šdex
);

6911 
	`wr™e_ex‹Á_bufãr
(
·th
->
nodes
[0], 
Çme
->Çme, 
±r
,

6912 
Çme
->
Ën
);

6916 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·th
->
nodes
[0]);

6922 
	`bŒfs_ä“_·th
(
·th
);

6923 
·th
 = 
NULL
;

6925 ià(
¬gs
->
subvŞ
) {

6926 
šode
 *
·»Á
;

6932 
·»Á
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
BTRFS_FIRST_FREE_OBJECTID
,

6933 
	`BTRFS_I
(
dœ
)->
roÙ
);

6934 ià(
	`IS_ERR
(
·»Á
)) {

6935 
»t
 = 
	`PTR_ERR
(
·»Á
);

6937 
»t
 = 
	`bŒfs_šode_šh”™_´İs
(
Œªs
, 
šode
, 
·»Á
);

6938 
	`ut
(
·»Á
);

6941 
»t
 = 
	`bŒfs_šode_šh”™_´İs
(
Œªs
, 
šode
, 
dœ
);

6943 ià(
»t
) {

6944 
	`bŒfs_”r
(
fs_šfo
,

6946 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 
roÙ
->
roÙ_key
.
objeùid
,

6947 
»t
);

6954 ià(!
¬gs
->
subvŞ
) {

6955 
»t
 = 
	`bŒfs_š™_šode_£cur™y
(
Œªs
, 
¬gs
);

6956 ià(
»t
) {

6957 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

6958 
disÿrd
;

6962 
	`šode_Œ“_add
(
	`BTRFS_I
(
šode
));

6964 
	`Œaû_bŒfs_šode_Ãw
(
šode
);

6965 
	`bŒfs_£t_šode_Ï¡_Œªs
(
Œªs
, 
	`BTRFS_I
(
šode
));

6967 
	`bŒfs_upd©e_roÙ_times
(
Œªs
, 
roÙ
);

6969 ià(
¬gs
->
Üphª
) {

6970 
»t
 = 
	`bŒfs_Üphª_add
(
Œªs
, 
	`BTRFS_I
(
šode
));

6972 
»t
 = 
	`bŒfs_add_lšk
(
Œªs
, 
	`BTRFS_I
(
dœ
), BTRFS_I(
šode
), 
Çme
,

6973 0, 
	`BTRFS_I
(
šode
)->
dœ_šdex
);

6975 ià(
»t
) {

6976 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

6977 
disÿrd
;

6982 
disÿrd
:

6987 
	`ihŞd
(
šode
);

6988 
	`disÿrd_Ãw_šode
(
šode
);

6989 
out
:

6990 
	`bŒfs_ä“_·th
(
·th
);

6991  
»t
;

6992 
	}
}

7000 
	$bŒfs_add_lšk
(
bŒfs_Œªs_hªdË
 *
Œªs
,

7001 
bŒfs_šode
 *
·»Á_šode
, bŒfs_šod*
šode
,

7002 cÚ¡ 
fsüy±_¡r
 *
Çme
, 
add_back»f
, 
u64
 
šdex
)

7004 
»t
 = 0;

7005 
bŒfs_key
 
key
;

7006 
bŒfs_roÙ
 *
roÙ
 = 
·»Á_šode
->root;

7007 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

7008 
u64
 
·»Á_šo
 = 
	`bŒfs_šo
(
·»Á_šode
);

7010 ià(
	`uÆik–y
(
šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
)) {

7011 
	`memıy
(&
key
, &
šode
->
roÙ
->
roÙ_key
, (key));

7013 
key
.
objeùid
 = 
šo
;

7014 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

7015 
key
.
off£t
 = 0;

7018 ià(
	`uÆik–y
(
šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
)) {

7019 
»t
 = 
	`bŒfs_add_roÙ_»f
(
Œªs
, 
key
.
objeùid
,

7020 
roÙ
->
roÙ_key
.
objeùid
, 
·»Á_šo
,

7021 
šdex
, 
Çme
);

7022 } ià(
add_back»f
) {

7023 
»t
 = 
	`bŒfs_š£¹_šode_»f
(
Œªs
, 
roÙ
, 
Çme
,

7024 
šo
, 
·»Á_šo
, 
šdex
);

7028 ià(
»t
)

7029  
»t
;

7031 
»t
 = 
	`bŒfs_š£¹_dœ_™em
(
Œªs
, 
Çme
, 
·»Á_šode
, &
key
,

7032 
	`bŒfs_šode_ty³
(&
šode
->
vfs_šode
), 
šdex
);

7033 ià(
»t
 =ğ-
EEXIST
 ||„‘ =ğ-
EOVERFLOW
)

7034 
ç_dœ_™em
;

7035 ià(
»t
) {

7036 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7037  
»t
;

7040 
	`bŒfs_i_size_wr™e
(
·»Á_šode
,…¬’t_šode->
vfs_šode
.
i_size
 +

7041 
Çme
->
Ën
 * 2);

7042 
	`šode_šc_iv”siÚ
(&
·»Á_šode
->
vfs_šode
);

7049 ià(!
	`‹¡_b™
(
BTRFS_FS_LOG_RECOVERING
, &
roÙ
->
fs_šfo
->
æags
))

7050 
·»Á_šode
->
vfs_šode
.
i_mtime
 =

7051 
	`šode_£t_ùime_cu¼’t
(&
·»Á_šode
->
vfs_šode
);

7053 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
·»Á_šode
);

7054 ià(
»t
)

7055 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7056  
»t
;

7058 
ç_dœ_™em
:

7059 ià(
	`uÆik–y
(
šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
)) {

7060 
u64
 
loÿl_šdex
;

7061 
”r
;

7062 
”r
 = 
	`bŒfs_d–_roÙ_»f
(
Œªs
, 
key
.
objeùid
,

7063 
roÙ
->
roÙ_key
.
objeùid
, 
·»Á_šo
,

7064 &
loÿl_šdex
, 
Çme
);

7065 ià(
”r
)

7066 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
”r
);

7067 } ià(
add_back»f
) {

7068 
u64
 
loÿl_šdex
;

7069 
”r
;

7071 
”r
 = 
	`bŒfs_d–_šode_»f
(
Œªs
, 
roÙ
, 
Çme
, 
šo
, 
·»Á_šo
,

7072 &
loÿl_šdex
);

7073 ià(
”r
)

7074 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
”r
);

7078  
»t
;

7079 
	}
}

7081 
	$bŒfs_ü—‹_commÚ
(
šode
 *
dœ
, 
d’Œy
 *dentry,

7082 
šode
 *inode)

7084 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

7085 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

7086 
bŒfs_Ãw_šode_¬gs
 
Ãw_šode_¬gs
 = {

7087 .
dœ
 = dir,

7088 .
d’Œy
 = dentry,

7089 .
šode
 = inode,

7091 
Œªs_num_™ems
;

7092 
bŒfs_Œªs_hªdË
 *
Œªs
;

7093 
”r
;

7095 
”r
 = 
	`bŒfs_Ãw_šode_´•¬e
(&
Ãw_šode_¬gs
, &
Œªs_num_™ems
);

7096 ià(
”r
)

7097 
out_šode
;

7100 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 
Œªs_num_™ems
);

7101 ià(
	`IS_ERR
(
Œªs
)) {

7102 
”r
 = 
	`PTR_ERR
(
Œªs
);

7103 
out_Ãw_šode_¬gs
;

7106 
”r
 = 
	`bŒfs_ü—‹_Ãw_šode
(
Œªs
, &
Ãw_šode_¬gs
);

7107 ià(!
”r
)

7108 
	`d_š¡ªtŸ‹_Ãw
(
d’Œy
, 
šode
);

7110 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

7111 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

7112 
out_Ãw_šode_¬gs
:

7113 
	`bŒfs_Ãw_šode_¬gs_de¡roy
(&
Ãw_šode_¬gs
);

7114 
out_šode
:

7115 ià(
”r
)

7116 
	`ut
(
šode
);

7117  
”r
;

7118 
	}
}

7121 
	$bŒfs_ü—‹_commÚ_mfs
(
šode
 *
dœ
, šod*
loÿl_dœ
, 
d’Œy
 *dentry,

7122 
šode
 *šode, šod*
loÿl_šode
)

7124 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

7125 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

7126 
bŒfs_Ãw_šode_¬gs
 
Ãw_šode_¬gs
 = {

7127 .
dœ
 = dir,

7128 .
has_loÿl_dœ
 = 1,

7129 .
loÿl_dœ
 =†ocal_dir,

7130 .
d’Œy
 = dentry,

7131 .
šode
 = inode,

7132 .
loÿl_šode
 =†ocal_inode,

7134 
Œªs_num_™ems
;

7135 
bŒfs_Œªs_hªdË
 *
Œªs
;

7136 
”r
;

7138 
”r
 = 
	`bŒfs_Ãw_šode_´•¬e
(&
Ãw_šode_¬gs
, &
Œªs_num_™ems
);

7139 ià(
”r
)

7140 
out_šode
;

7142 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 
Œªs_num_™ems
);

7143 ià(
	`IS_ERR
(
Œªs
)) {

7144 
”r
 = 
	`PTR_ERR
(
Œªs
);

7145 
out_Ãw_šode_¬gs
;

7148 
”r
 = 
	`bŒfs_ü—‹_Ãw_šode_mfs
(
Œªs
, &
Ãw_šode_¬gs
);

7149 ià(!
”r
)

7150 
	`d_š¡ªtŸ‹_Ãw
(
d’Œy
, 
šode
);

7152 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

7153 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

7154 
out_Ãw_šode_¬gs
:

7155 
	`bŒfs_Ãw_šode_¬gs_de¡roy
(&
Ãw_šode_¬gs
);

7156 
out_šode
:

7157 ià(
”r
)

7158 
	`ut
(
šode
);

7159  
”r
;

7160 
	}
}

7162 
	$bŒfs_mknod
(
mÁ_idm­
 *
idm­
, 
šode
 *
dœ
,

7163 
d’Œy
 *d’Œy, 
umode_t
 
mode
, 
dev_t
 
rdev
)

7165 
šode
 *inode;

7166 
	`´štk
(
KERN_INFO
 "btrfs_mknod: Called...\n");

7168 
šode
 = 
	`Ãw_šode
(
dœ
->
i_sb
);

7169 ià(!
šode
)

7170  -
ENOMEM
;

7171 
	`šode_š™_owÃr
(
idm­
, 
šode
, 
dœ
, 
mode
);

7172 
šode
->
i_İ
 = &
bŒfs_¥ecŸl_šode_İ”©iÚs
;

7173 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
, 
rdev
);

7174  
	`bŒfs_ü—‹_commÚ
(
dœ
, 
d’Œy
, 
šode
);

7175 
	}
}

7177 
	$bŒfs_ü—‹
(
mÁ_idm­
 *
idm­
, 
šode
 *
dœ
,

7178 
d’Œy
 *d’Œy, 
umode_t
 
mode
, 
boŞ
 
exş
)

7180 
šode
 *inode;

7182 
šode
 = 
	`Ãw_šode
(
dœ
->
i_sb
);

7183 ià(!
šode
)

7184  -
ENOMEM
;

7185 
	`šode_š™_owÃr
(
idm­
, 
šode
, 
dœ
, 
mode
);

7186 
šode
->
i_fİ
 = &
bŒfs_fe_İ”©iÚs
;

7187 
šode
->
i_İ
 = &
bŒfs_fe_šode_İ”©iÚs
;

7188 
šode
->
i_m­pšg
->
a_İs
 = &
bŒfs_aİs
;

7189  
	`bŒfs_ü—‹_commÚ
(
dœ
, 
d’Œy
, 
šode
);

7190 
	}
}

7193 
	$bŒfs_ü—‹_mfs
(
mÁ_idm­
 *
idm­
, 
šode
 *
Üig_dœ
,

7194 
d’Œy
 *d’Œy, 
umode_t
 
mode
, 
boŞ
 
exş
)

7196 
šode
 *šode, *
mfs_dœ
, *
dœ
;

7197 
d’Œy
 *
»mÙe_d’Œy
;

7198 
·th
 
»mÙe_·th
;

7199 
mÁ_idm­
 *
»mÙe_idm­
;

7200 
»t
;

7201 
loÿl_deviû
, 
»mÙe_deviû
;

7207 
q¡r
 *
dÇme
 = &
d’Œy
->
d_Çme
;

7208 *
Çme
 = 
dÇme
->name;

7211 ià(
d’Œy
->
»mÙe
 == 1) {

7216 ià(
d’Œy
->
assocŸ‹d_d’Œy
) {

7222 
	`©omic_šc
(&
glob®_ü—‹_couÁ
);

7223 
couÁ_šdex
 = 
	`©omic_»ad
(&
glob®_ü—‹_couÁ
);

7225 
bŒfs_fs_šfo
 *
assigÃd_fs
 = 
	`bŒfs_fs_¶aûm’t_round_robš
(
Üig_dœ
, 
couÁ_šdex
);

7227 
mfs_dœ
 = 
	`bŒfs_m­_mfsdœ
(
assigÃd_fs
);

7228 
loÿl_deviû
 = 
	`bŒfs_g‘_deviû_id
(
Üig_dœ
);

7229 
»mÙe_deviû
 = 
assigÃd_fs
->
id
;

7232 ià(
»mÙe_deviû
 =ğ
loÿl_deviû
) {

7233 
šode
 = 
	`Ãw_šode
(
Üig_dœ
->
i_sb
);

7234 ià(!
šode
)

7235  -
ENOMEM
;

7236 
	`šode_š™_owÃr
(
idm­
, 
šode
, 
Üig_dœ
, 
mode
);

7237 
šode
->
i_fİ
 = &
bŒfs_fe_İ”©iÚs
;

7238 
šode
->
i_İ
 = &
bŒfs_fe_šode_İ”©iÚs
;

7239 
šode
->
i_m­pšg
->
a_İs
 = &
bŒfs_aİs
;

7240 
»t
 = 
	`bŒfs_ü—‹_commÚ
(
Üig_dœ
, 
d’Œy
, 
šode
);

7241 
šode
->
has_»mÙe
 = 2;

7245 
»mÙe_d’Œy
 = 
	`k”n_·th_ü—‹
(
AT_FDCWD
, 
Çme
, &
»mÙe_·th
, 0);

7246 ià(
	`IS_ERR
(
»mÙe_d’Œy
))

7247 
»t
 = 
	`PTR_ERR
(
»mÙe_d’Œy
);

7248 
»mÙe_d’Œy
->
»mÙe
 = 1;

7249 
»mÙe_d’Œy
->
d_Çme
 = 
d’Œy
->d_name;

7250 
»mÙe_idm­
 = 
	`mÁ_idm­
(
»mÙe_·th
.
mÁ
);

7251 
»mÙe_d’Œy
->
ÿÎed_äom_FS
 = 1;

7252 
šode
 = 
	`Ãw_šode
(
mfs_dœ
->
i_sb
);

7253 ià(!
šode
)

7254  -
ENOMEM
;

7255 
mfs_dœ
->
has_loÿl_dœ
 = 1;

7256 
mfs_dœ
->
assocŸ‹d_dœ_šode
 = 
Üig_dœ
;

7257 
	`šode_š™_owÃr
(
»mÙe_idm­
, 
šode
, 
mfs_dœ
, 
mode
);

7258 
šode
->
i_fİ
 = &
bŒfs_fe_İ”©iÚs
;

7259 
šode
->
i_İ
 = &
bŒfs_fe_šode_İ”©iÚs
;

7260 
šode
->
i_m­pšg
->
a_İs
 = &
bŒfs_aİs
;

7261 
šode
->
fs_id
 = 
»mÙe_deviû
;

7264 
šode
 *
loÿl_šode
 = 
	`Ãw_šode
(
Üig_dœ
->
i_sb
);

7265 ià(!
loÿl_šode
)

7266  -
ENOMEM
;

7267 
	`šode_š™_owÃr
(
idm­
, 
loÿl_šode
, 
Üig_dœ
, 
mode
);

7268 
loÿl_šode
->
i_fİ
 = &
bŒfs_fe_İ”©iÚs
;

7269 
loÿl_šode
->
i_İ
 = &
bŒfs_fe_šode_İ”©iÚs
;

7270 
loÿl_šode
->
i_m­pšg
->
a_İs
 = &
bŒfs_aİs
;

7271 
loÿl_šode
->
assocŸ‹d_fs_id
 = 
»mÙe_deviû
;

7272 
»t
 = 
	`bŒfs_ü—‹_commÚ
(
Üig_dœ
, 
d’Œy
, 
loÿl_šode
);

7273 
loÿl_šode
->
has_»mÙe
 = 1;

7274 
loÿl_šode
->
assocŸ‹d_šode
 = 
šode
;

7275 
šode
->
assocŸ‹d_šode
 = 
loÿl_šode
;

7276 
d’Œy
->
»mÙe
 = 0;

7277 
šode
->
has_»mÙe
 = 0;

7279 
»t
 = 
	`bŒfs_ü—‹_commÚ_mfs
(
mfs_dœ
, 
Üig_dœ
, 
»mÙe_d’Œy
, 
šode
, 
loÿl_šode
);

7283 
	`dÚe_·th_ü—‹
(&
»mÙe_·th
, 
»mÙe_d’Œy
);

7284 
šode
->
assocŸ‹d_dœ_šode
 = 
Üig_dœ
;

7287 
d’Œy
->
assocŸ‹d_d’Œy
 = 
»mÙe_d’Œy
;

7288 
d’Œy
->
assocŸ‹d_·th
 = &
»mÙe_·th
;

7289 
»mÙe_d’Œy
->
assocŸ‹d_d’Œy
 = 
d’Œy
;

7300  
»t
;

7301 
	}
}

7305 
	$bŒfs_lšk
(
d’Œy
 *
Şd_d’Œy
, 
šode
 *
dœ
,

7306 
d’Œy
 *dentry)

7308 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

7309 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

7310 
šode
 *šodğ
	`d_šode
(
Şd_d’Œy
);

7311 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

7312 
fsüy±_Çme
 
âame
;

7313 
u64
 
šdex
;

7314 
”r
;

7315 
drİ_šode
 = 0;

7317 
	`´štk
(
KERN_INFO
 "btrfs_linked: Called...\n");

7319 ià(
roÙ
->
roÙ_key
.
objeùid
 !ğ
	`BTRFS_I
(
šode
)->root->root_key.objectid)

7320  -
EXDEV
;

7322 ià(
šode
->
i_Æšk
 >ğ
BTRFS_LINK_MAX
)

7323  -
EMLINK
;

7325 
”r
 = 
	`fsüy±_£tup_f’ame
(
dœ
, &
d’Œy
->
d_Çme
, 0, &
âame
);

7326 ià(
”r
)

7327 
ç
;

7329 
”r
 = 
	`bŒfs_£t_šode_šdex
(
	`BTRFS_I
(
dœ
), &
šdex
);

7330 ià(
”r
)

7331 
ç
;

7339 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 
šode
->
i_Æšk
 ? 5 : 6);

7340 ià(
	`IS_ERR
(
Œªs
)) {

7341 
”r
 = 
	`PTR_ERR
(
Œªs
);

7342 
Œªs
 = 
NULL
;

7343 
ç
;

7347 
	`BTRFS_I
(
šode
)->
dœ_šdex
 = 0ULL;

7348 
	`šc_Æšk
(
šode
);

7349 
	`šode_šc_iv”siÚ
(
šode
);

7350 
	`šode_£t_ùime_cu¼’t
(
šode
);

7351 
	`ihŞd
(
šode
);

7352 
	`£t_b™
(
BTRFS_INODE_COPY_EVERYTHING
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

7354 
”r
 = 
	`bŒfs_add_lšk
(
Œªs
, 
	`BTRFS_I
(
dœ
), BTRFS_I(
šode
),

7355 &
âame
.
disk_Çme
, 1, 
šdex
);

7357 ià(
”r
) {

7358 
drİ_šode
 = 1;

7360 
d’Œy
 *
·»Á
 = d’Œy->
d_·»Á
;

7362 
”r
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

7363 ià(
”r
)

7364 
ç
;

7365 ià(
šode
->
i_Æšk
 == 1) {

7370 
”r
 = 
	`bŒfs_Üphª_d–
(
Œªs
, 
	`BTRFS_I
(
šode
));

7371 ià(
”r
)

7372 
ç
;

7374 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

7375 
	`bŒfs_log_Ãw_Çme
(
Œªs
, 
Şd_d’Œy
, 
NULL
, 0, 
·»Á
);

7378 
ç
:

7379 
	`fsüy±_ä“_f’ame
(&
âame
);

7380 ià(
Œªs
)

7381 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

7382 ià(
drİ_šode
) {

7383 
	`šode_dec_lšk_couÁ
(
šode
);

7384 
	`ut
(
šode
);

7386 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

7387  
”r
;

7388 
	}
}

7390 
	$bŒfs_mkdœ
(
mÁ_idm­
 *
idm­
, 
šode
 *
dœ
,

7391 
d’Œy
 *d’Œy, 
umode_t
 
mode
)

7393 
šode
 *inode;

7394 
	`´štk
(
KERN_INFO
 "btrfs_mkdir: Called...\n");

7396 
šode
 = 
	`Ãw_šode
(
dœ
->
i_sb
);

7397 ià(!
šode
)

7398  -
ENOMEM
;

7399 
	`šode_š™_owÃr
(
idm­
, 
šode
, 
dœ
, 
S_IFDIR
 | 
mode
);

7400 
šode
->
i_İ
 = &
bŒfs_dœ_šode_İ”©iÚs
;

7401 
šode
->
i_fİ
 = &
bŒfs_dœ_fe_İ”©iÚs
;

7402  
	`bŒfs_ü—‹_commÚ
(
dœ
, 
d’Œy
, 
šode
);

7403 
	}
}

7405 
	$bŒfs_mkdœ_mfs
(
mÁ_idm­
 *
idm­
, 
šode
 *
dœ
,

7406 
d’Œy
 *d’Œy, 
umode_t
 
mode
)

7408 
šode
 *inode;

7410 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

7411 
fs_id
 = 
fs_šfo
->
id
;

7412 
	`´štk
(
KERN_INFO
 "btrfs_mkdir_mfs did create‡†ocal directory...\n ");

7414 
šode
 = 
	`Ãw_šode
(
dœ
->
i_sb
);

7415 ià(!
šode
)

7416  -
ENOMEM
;

7417 
	`šode_š™_owÃr
(
idm­
, 
šode
, 
dœ
, 
S_IFDIR
 | 
mode
);

7418 
šode
->
i_İ
 = &
bŒfs_dœ_šode_İ”©iÚs
;

7419 
šode
->
i_fİ
 = &
bŒfs_dœ_fe_İ”©iÚs
;

7421 
šode
->
is_loÿl_dœ
 = 1;

7422 
šode
->
has_»mÙe
 = 2;

7423 
d’Œy
->
is_dœ
 = 1;

7424  
	`bŒfs_ü—‹_commÚ
(
dœ
, 
d’Œy
, 
šode
);

7425 
	}
}

7427 
nošlše
 
	$uncom´ess_šlše
(
bŒfs_·th
 *
·th
,

7428 
·ge
 *page,

7429 
bŒfs_fe_ex‹Á_™em
 *
™em
)

7431 
»t
;

7432 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

7433 *
tmp
;

7434 
size_t
 
max_size
;

7435 
šlše_size
;

7436 
±r
;

7437 
com´ess_ty³
;

7439 
com´ess_ty³
 = 
	`bŒfs_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
™em
);

7440 
max_size
 = 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
™em
);

7441 
šlše_size
 = 
	`bŒfs_fe_ex‹Á_šlše_™em_Ën
(
Ëaf
, 
·th
->
¦Ùs
[0]);

7442 
tmp
 = 
	`km®loc
(
šlše_size
, 
GFP_NOFS
);

7443 ià(!
tmp
)

7444  -
ENOMEM
;

7445 
±r
 = 
	`bŒfs_fe_ex‹Á_šlše_¡¬t
(
™em
);

7447 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
tmp
, 
±r
, 
šlše_size
);

7449 
max_size
 = 
	`mš_t
(, 
PAGE_SIZE
, max_size);

7450 
»t
 = 
	`bŒfs_decom´ess
(
com´ess_ty³
, 
tmp
, 
·ge
, 0, 
šlše_size
, 
max_size
);

7460 ià(
max_size
 < 
PAGE_SIZE
)

7461 
	`memz”o_·ge
(
·ge
, 
max_size
, 
PAGE_SIZE
 - max_size);

7462 
	`kä“
(
tmp
);

7463  
»t
;

7464 
	}
}

7466 
	$»ad_šlše_ex‹Á
(
bŒfs_šode
 *
šode
, 
bŒfs_·th
 *
·th
,

7467 
·ge
 *page)

7469 
bŒfs_fe_ex‹Á_™em
 *
fi
;

7470 *
kaddr
;

7471 
size_t
 
cİy_size
;

7473 ià(!
·ge
 || 
	`PageU±od©e
(page))

7476 
	`ASSERT
(
	`·ge_off£t
(
·ge
) == 0);

7478 
fi
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

7479 
bŒfs_fe_ex‹Á_™em
);

7480 ià(
	`bŒfs_fe_ex‹Á_com´essiÚ
(
·th
->
nodes
[0], 
fi
è!ğ
BTRFS_COMPRESS_NONE
)

7481  
	`uncom´ess_šlše
(
·th
, 
·ge
, 
fi
);

7483 
cİy_size
 = 
	`mš_t
(
u64
, 
PAGE_SIZE
,

7484 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
·th
->
nodes
[0], 
fi
));

7485 
kaddr
 = 
	`km­_loÿl_·ge
(
·ge
);

7486 
	`»ad_ex‹Á_bufãr
(
·th
->
nodes
[0], 
kaddr
,

7487 
	`bŒfs_fe_ex‹Á_šlše_¡¬t
(
fi
), 
cİy_size
);

7488 
	`kunm­_loÿl
(
kaddr
);

7489 ià(
cİy_size
 < 
PAGE_SIZE
)

7490 
	`memz”o_·ge
(
·ge
, 
cİy_size
, 
PAGE_SIZE
 - copy_size);

7492 
	}
}

7512 
ex‹Á_m­
 *
	$bŒfs_g‘_ex‹Á
(
bŒfs_šode
 *
šode
,

7513 
·ge
 *·ge, 
size_t
 
pg_off£t
,

7514 
u64
 
¡¬t
, u64 
Ën
)

7516 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

7517 
»t
 = 0;

7518 
u64
 
ex‹Á_¡¬t
 = 0;

7519 
u64
 
ex‹Á_’d
 = 0;

7520 
u64
 
objeùid
 = 
	`bŒfs_šo
(
šode
);

7521 
ex‹Á_ty³
 = -1;

7522 
bŒfs_·th
 *
·th
 = 
NULL
;

7523 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

7524 
bŒfs_fe_ex‹Á_™em
 *
™em
;

7525 
ex‹Á_bufãr
 *
Ëaf
;

7526 
bŒfs_key
 
found_key
;

7527 
ex‹Á_m­
 *
em
 = 
NULL
;

7528 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
šode
->
ex‹Á_Œ“
;

7530 
	`»ad_lock
(&
em_Œ“
->
lock
);

7531 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
¡¬t
, 
Ën
);

7532 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

7534 ià(
em
) {

7535 ià(
em
->
¡¬t
 > s¹ ||ƒm->¡¬ˆ+ƒm->
Ën
 <= start)

7536 
	`ä“_ex‹Á_m­
(
em
);

7537 ià(
em
->
block_¡¬t
 =ğ
EXTENT_MAP_INLINE
 && 
·ge
)

7538 
	`ä“_ex‹Á_m­
(
em
);

7540 
out
;

7542 
em
 = 
	`®loc_ex‹Á_m­
();

7543 ià(!
em
) {

7544 
»t
 = -
ENOMEM
;

7545 
out
;

7547 
em
->
¡¬t
 = 
EXTENT_MAP_HOLE
;

7548 
em
->
Üig_¡¬t
 = 
EXTENT_MAP_HOLE
;

7549 
em
->
Ën
 = (
u64
)-1;

7550 
em
->
block_Ën
 = (
u64
)-1;

7552 
·th
 = 
	`bŒfs_®loc_·th
();

7553 ià(!
·th
) {

7554 
»t
 = -
ENOMEM
;

7555 
out
;

7559 
·th
->
»ada
 = 
READA_FORWARD
;

7566 ià(
	`bŒfs_is_ä“_¥aû_šode
(
šode
)) {

7567 
·th
->
£¬ch_comm™_roÙ
 = 1;

7568 
·th
->
sk_lockšg
 = 1;

7571 
»t
 = 
	`bŒfs_lookup_fe_ex‹Á
(
NULL
, 
roÙ
, 
·th
, 
objeùid
, 
¡¬t
, 0);

7572 ià(
»t
 < 0) {

7573 
out
;

7574 } ià(
»t
 > 0) {

7575 ià(
·th
->
¦Ùs
[0] == 0)

7576 
nÙ_found
;

7577 
·th
->
¦Ùs
[0]--;

7578 
»t
 = 0;

7581 
Ëaf
 = 
·th
->
nodes
[0];

7582 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

7583 
bŒfs_fe_ex‹Á_™em
);

7584 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

7585 ià(
found_key
.
objeùid
 != objectid ||

7586 
found_key
.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
) {

7593 
ex‹Á_’d
 = 
¡¬t
;

7594 
Ãxt
;

7597 
ex‹Á_ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
™em
);

7598 
ex‹Á_¡¬t
 = 
found_key
.
off£t
;

7599 
ex‹Á_’d
 = 
	`bŒfs_fe_ex‹Á_’d
(
·th
);

7600 ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_REG
 ||

7601 
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
) {

7603 ià(!
	`S_ISREG
(
šode
->
vfs_šode
.
i_mode
)) {

7604 
»t
 = -
EUCLEAN
;

7605 
	`bŒfs_ü™
(
fs_šfo
,

7607 
	`bŒfs_šo
(
šode
));

7608 
out
;

7610 
	`Œaû_bŒfs_g‘_ex‹Á_show_fi_»guÏr
(
šode
, 
Ëaf
, 
™em
,

7611 
ex‹Á_¡¬t
);

7612 } ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
) {

7613 
	`Œaû_bŒfs_g‘_ex‹Á_show_fi_šlše
(
šode
, 
Ëaf
, 
™em
,

7614 
·th
->
¦Ùs
[0],

7615 
ex‹Á_¡¬t
);

7617 
Ãxt
:

7618 ià(
¡¬t
 >ğ
ex‹Á_’d
) {

7619 
·th
->
¦Ùs
[0]++;

7620 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

7621 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

7622 ià(
»t
 < 0)

7623 
out
;

7624 ià(
»t
 > 0)

7625 
nÙ_found
;

7627 
Ëaf
 = 
·th
->
nodes
[0];

7629 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

7630 ià(
found_key
.
objeùid
 != objectid ||

7631 
found_key
.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

7632 
nÙ_found
;

7633 ià(
¡¬t
 + 
Ën
 <ğ
found_key
.
off£t
)

7634 
nÙ_found
;

7635 ià(
¡¬t
 > 
found_key
.
off£t
)

7636 
Ãxt
;

7639 
em
->
¡¬t
 = start;

7640 
em
->
Üig_¡¬t
 = 
¡¬t
;

7641 
em
->
Ën
 = 
found_key
.
off£t
 - 
¡¬t
;

7642 
em
->
block_¡¬t
 = 
EXTENT_MAP_HOLE
;

7643 
š£¹
;

7646 
	`bŒfs_ex‹Á_™em_to_ex‹Á_m­
(
šode
, 
·th
, 
™em
, 
em
);

7648 ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_REG
 ||

7649 
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
) {

7650 
š£¹
;

7651 } ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
) {

7657 
	`ASSERT
(
pg_off£t
 == 0);

7658 
	`ASSERT
(
ex‹Á_¡¬t
 == 0);

7659 
	`ASSERT
(
em
->
¡¬t
 == 0);

7667 
	`ASSERT
(
em
->
block_¡¬t
 =ğ
EXTENT_MAP_INLINE
);

7668 
	`ASSERT
(
em
->
Ën
 =ğ
fs_šfo
->
£ùÜsize
);

7670 
»t
 = 
	`»ad_šlše_ex‹Á
(
šode
, 
·th
, 
·ge
);

7671 ià(
»t
 < 0)

7672 
out
;

7673 
š£¹
;

7675 
nÙ_found
:

7676 
em
->
¡¬t
 = start;

7677 
em
->
Üig_¡¬t
 = 
¡¬t
;

7678 
em
->
Ën
 =†en;

7679 
em
->
block_¡¬t
 = 
EXTENT_MAP_HOLE
;

7680 
š£¹
:

7681 
»t
 = 0;

7682 
	`bŒfs_»Ëa£_·th
(
·th
);

7683 ià(
em
->
¡¬t
 > s¹ || 
	`ex‹Á_m­_’d
(em) <= start) {

7684 
	`bŒfs_”r
(
fs_šfo
,

7686 
em
->
¡¬t
,ƒm->
Ën
, start,†en);

7687 
»t
 = -
EIO
;

7688 
out
;

7691 
	`wr™e_lock
(&
em_Œ“
->
lock
);

7692 
»t
 = 
	`bŒfs_add_ex‹Á_m­pšg
(
fs_šfo
, 
em_Œ“
, &
em
, 
¡¬t
, 
Ën
);

7693 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

7694 
out
:

7695 
	`bŒfs_ä“_·th
(
·th
);

7697 
	`Œaû_bŒfs_g‘_ex‹Á
(
roÙ
, 
šode
, 
em
);

7699 ià(
»t
) {

7700 
	`ä“_ex‹Á_m­
(
em
);

7701  
	`ERR_PTR
(
»t
);

7703  
em
;

7704 
	}
}

7706 
ex‹Á_m­
 *
	$bŒfs_ü—‹_dio_ex‹Á
(
bŒfs_šode
 *
šode
,

7707 
bŒfs_dio_d©a
 *
dio_d©a
,

7708 cÚ¡ 
u64
 
¡¬t
,

7709 cÚ¡ 
u64
 
Ën
,

7710 cÚ¡ 
u64
 
Üig_¡¬t
,

7711 cÚ¡ 
u64
 
block_¡¬t
,

7712 cÚ¡ 
u64
 
block_Ën
,

7713 cÚ¡ 
u64
 
Üig_block_Ën
,

7714 cÚ¡ 
u64
 
¿m_by‹s
,

7715 cÚ¡ 
ty³
)

7717 
ex‹Á_m­
 *
em
 = 
NULL
;

7718 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

7720 ià(
ty³
 !ğ
BTRFS_ORDERED_NOCOW
) {

7721 
em
 = 
	`ü—‹_io_em
(
šode
, 
¡¬t
, 
Ën
, 
Üig_¡¬t
, 
block_¡¬t
,

7722 
block_Ën
, 
Üig_block_Ën
, 
¿m_by‹s
,

7723 
BTRFS_COMPRESS_NONE
,

7724 
ty³
);

7725 ià(
	`IS_ERR
(
em
))

7726 
out
;

7728 
Üd”ed
 = 
	`bŒfs_®loc_Üd”ed_ex‹Á
(
šode
, 
¡¬t
, 
Ën
,†en,

7729 
block_¡¬t
, 
block_Ën
, 0,

7730 (1 << 
ty³
) |

7731 (1 << 
BTRFS_ORDERED_DIRECT
),

7732 
BTRFS_COMPRESS_NONE
);

7733 ià(
	`IS_ERR
(
Üd”ed
)) {

7734 ià(
em
) {

7735 
	`ä“_ex‹Á_m­
(
em
);

7736 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
šode
, 
¡¬t
,

7737 
¡¬t
 + 
Ën
 - 1, 
çl£
);

7739 
em
 = 
	`ERR_CAST
(
Üd”ed
);

7741 
	`ASSERT
(!
dio_d©a
->
Üd”ed
);

7742 
dio_d©a
->
Üd”ed
 = ordered;

7744 
out
:

7746  
em
;

7747 
	}
}

7749 
ex‹Á_m­
 *
	$bŒfs_Ãw_ex‹Á_dœeù
(
bŒfs_šode
 *
šode
,

7750 
bŒfs_dio_d©a
 *
dio_d©a
,

7751 
u64
 
¡¬t
, u64 
Ën
)

7753 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

7754 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

7755 
ex‹Á_m­
 *
em
;

7756 
bŒfs_key
 
šs
;

7757 
u64
 
®loc_hšt
;

7758 
»t
;

7760 
®loc_hšt
 = 
	`g‘_ex‹Á_®loÿtiÚ_hšt
(
šode
, 
¡¬t
, 
Ën
);

7761 
agaš
:

7762 
»t
 = 
	`bŒfs_»£rve_ex‹Á
(
roÙ
, 
Ën
,†’, 
fs_šfo
->
£ùÜsize
,

7763 0, 
®loc_hšt
, &
šs
, 1, 1);

7764 ià(
»t
 =ğ-
EAGAIN
) {

7765 
	`ASSERT
(
	`bŒfs_is_zÚed
(
fs_šfo
));

7766 
	`wa™_Ú_b™_io
(&
šode
->
roÙ
->
fs_šfo
->
æags
, 
BTRFS_FS_NEED_ZONE_FINISH
,

7767 
TASK_UNINTERRUPTIBLE
);

7768 
agaš
;

7770 ià(
»t
)

7771  
	`ERR_PTR
(
»t
);

7773 
em
 = 
	`bŒfs_ü—‹_dio_ex‹Á
(
šode
, 
dio_d©a
, 
¡¬t
, 
šs
.
off£t
, start,

7774 
šs
.
objeùid
, ins.
off£t
, ins.offset,

7775 
šs
.
off£t
, 
BTRFS_ORDERED_REGULAR
);

7776 
	`bŒfs_dec_block_group_»£rv©iÚs
(
fs_šfo
, 
šs
.
objeùid
);

7777 ià(
	`IS_ERR
(
em
))

7778 
	`bŒfs_ä“_»£rved_ex‹Á
(
fs_šfo
, 
šs
.
objeùid
, ins.
off£t
,

7781  
em
;

7782 
	}
}

7784 
boŞ
 
	$bŒfs_ex‹Á_»adÚly
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
)

7786 
bŒfs_block_group
 *
block_group
;

7787 
boŞ
 
»adÚly
 = 
çl£
;

7789 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
by‹Ä
);

7790 ià(!
block_group
 || block_group->
ro
)

7791 
»adÚly
 = 
Œue
;

7792 ià(
block_group
)

7793 
	`bŒfs_put_block_group
(
block_group
);

7794  
»adÚly
;

7795 
	}
}

7817 
nošlše
 
	$ÿn_nocow_ex‹Á
(
šode
 *šode, 
u64
 
off£t
, u64 *
Ën
,

7818 
u64
 *
Üig_¡¬t
, u64 *
Üig_block_Ën
,

7819 
u64
 *
¿m_by‹s
, 
boŞ
 
nowa™
, boŞ 
¡riù
)

7821 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

7822 
ÿn_nocow_fe_ex‹Á_¬gs
 
nocow_¬gs
 = { 0 };

7823 
bŒfs_·th
 *
·th
;

7824 
»t
;

7825 
ex‹Á_bufãr
 *
Ëaf
;

7826 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

7827 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

7828 
bŒfs_fe_ex‹Á_™em
 *
fi
;

7829 
bŒfs_key
 
key
;

7830 
found_ty³
;

7832 
·th
 = 
	`bŒfs_®loc_·th
();

7833 ià(!
·th
)

7834  -
ENOMEM
;

7835 
·th
->
nowa™
 =‚owait;

7837 
»t
 = 
	`bŒfs_lookup_fe_ex‹Á
(
NULL
, 
roÙ
, 
·th
,

7838 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 
off£t
, 0);

7839 ià(
»t
 < 0)

7840 
out
;

7842 ià(
»t
 == 1) {

7843 ià(
·th
->
¦Ùs
[0] == 0) {

7845 
»t
 = 0;

7846 
out
;

7848 
·th
->
¦Ùs
[0]--;

7850 
»t
 = 0;

7851 
Ëaf
 = 
·th
->
nodes
[0];

7852 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

7853 ià(
key
.
objeùid
 !ğ
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)) ||

7854 
key
.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
) {

7856 
out
;

7859 ià(
key
.
off£t
 > offset) {

7861 
out
;

7864 ià(
	`bŒfs_fe_ex‹Á_’d
(
·th
è<ğ
off£t
)

7865 
out
;

7867 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_fe_ex‹Á_™em
);

7868 
found_ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
fi
);

7869 ià(
¿m_by‹s
)

7870 *
¿m_by‹s
 = 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
);

7872 
nocow_¬gs
.
¡¬t
 = 
off£t
;

7873 
nocow_¬gs
.
’d
 = 
off£t
 + *
Ën
 - 1;

7874 
nocow_¬gs
.
¡riù
 = strict;

7875 
nocow_¬gs
.
ä“_·th
 = 
Œue
;

7877 
»t
 = 
	`ÿn_nocow_fe_ex‹Á
(
·th
, &
key
, 
	`BTRFS_I
(
šode
), &
nocow_¬gs
);

7879 
·th
 = 
NULL
;

7881 ià(
»t
 != 1) {

7883 
»t
 = 0;

7884 
out
;

7887 
»t
 = 0;

7888 ià(
	`bŒfs_ex‹Á_»adÚly
(
fs_šfo
, 
nocow_¬gs
.
disk_by‹Ä
))

7889 
out
;

7891 ià(!(
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATACOW
) &&

7892 
found_ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
) {

7893 
u64
 
¿nge_’d
;

7895 
¿nge_’d
 = 
	`round_up
(
off£t
 + 
nocow_¬gs
.
num_by‹s
,

7896 
roÙ
->
fs_šfo
->
£ùÜsize
) - 1;

7897 
»t
 = 
	`‹¡_¿nge_b™
(
io_Œ“
, 
off£t
, 
¿nge_’d
,

7898 
EXTENT_DELALLOC
, 0, 
NULL
);

7899 ià(
»t
) {

7900 
»t
 = -
EAGAIN
;

7901 
out
;

7905 ià(
Üig_¡¬t
)

7906 *
Üig_¡¬t
 = 
key
.
off£t
 - 
nocow_¬gs
.
ex‹Á_off£t
;

7907 ià(
Üig_block_Ën
)

7908 *
Üig_block_Ën
 = 
nocow_¬gs
.
disk_num_by‹s
;

7910 *
Ën
 = 
nocow_¬gs
.
num_by‹s
;

7911 
»t
 = 1;

7912 
out
:

7913 
	`bŒfs_ä“_·th
(
·th
);

7914  
»t
;

7915 
	}
}

7917 
	$lock_ex‹Á_dœeù
(
šode
 *šode, 
u64
 
lock¡¬t
, u64 
lock’d
,

7918 
ex‹Á_¡©e
 **
ÿched_¡©e
,

7919 
iom­_æags
)

7921 cÚ¡ 
boŞ
 
wr™šg
 = (
iom­_æags
 & 
IOMAP_WRITE
);

7922 cÚ¡ 
boŞ
 
nowa™
 = (
iom­_æags
 & 
IOMAP_NOWAIT
);

7923 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

7924 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

7925 
»t
 = 0;

7928 ià(
nowa™
) {

7929 ià(!
	`Œy_lock_ex‹Á
(
io_Œ“
, 
lock¡¬t
, 
lock’d
,

7930 
ÿched_¡©e
))

7931  -
EAGAIN
;

7933 
	`lock_ex‹Á
(
io_Œ“
, 
lock¡¬t
, 
lock’d
, 
ÿched_¡©e
);

7940 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
	`BTRFS_I
(
šode
), 
lock¡¬t
,

7941 
lock’d
 - 
lock¡¬t
 + 1);

7950 ià(!
Üd”ed
 &&

7951 (!
wr™šg
 || !
	`fem­_¿nge_has_·ge
(
šode
->
i_m­pšg
,

7952 
lock¡¬t
, 
lock’d
)))

7955 
	`uÆock_ex‹Á
(
io_Œ“
, 
lock¡¬t
, 
lock’d
, 
ÿched_¡©e
);

7957 ià(
Üd”ed
) {

7958 ià(
nowa™
) {

7959 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

7960 
»t
 = -
EAGAIN
;

7978 ià(
wr™šg
 ||

7979 
	`‹¡_b™
(
BTRFS_ORDERED_DIRECT
, &
Üd”ed
->
æags
))

7980 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
Üd”ed
);

7982 
»t
 = 
nowa™
 ? -
EAGAIN
 : -
ENOTBLK
;

7983 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

7998 
»t
 = 
nowa™
 ? -
EAGAIN
 : -
ENOTBLK
;

8001 ià(
»t
)

8004 
	`cÚd_»sched
();

8007  
»t
;

8008 
	}
}

8011 
ex‹Á_m­
 *
	$ü—‹_io_em
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
,

8012 
u64
 
Ën
, u64 
Üig_¡¬t
, u64 
block_¡¬t
,

8013 
u64
 
block_Ën
, u64 
Üig_block_Ën
,

8014 
u64
 
¿m_by‹s
, 
com´ess_ty³
,

8015 
ty³
)

8017 
ex‹Á_m­
 *
em
;

8018 
»t
;

8020 
	`ASSERT
(
ty³
 =ğ
BTRFS_ORDERED_PREALLOC
 ||

8021 
ty³
 =ğ
BTRFS_ORDERED_COMPRESSED
 ||

8022 
ty³
 =ğ
BTRFS_ORDERED_NOCOW
 ||

8023 
ty³
 =ğ
BTRFS_ORDERED_REGULAR
);

8025 
em
 = 
	`®loc_ex‹Á_m­
();

8026 ià(!
em
)

8027  
	`ERR_PTR
(-
ENOMEM
);

8029 
em
->
¡¬t
 = start;

8030 
em
->
Üig_¡¬t
 = orig_start;

8031 
em
->
Ën
 =†en;

8032 
em
->
block_Ën
 = block_len;

8033 
em
->
block_¡¬t
 = block_start;

8034 
em
->
Üig_block_Ën
 = orig_block_len;

8035 
em
->
¿m_by‹s
 =„am_bytes;

8036 
em
->
g’”©iÚ
 = -1;

8037 
	`£t_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
);

8038 ià(
ty³
 =ğ
BTRFS_ORDERED_PREALLOC
) {

8039 
	`£t_b™
(
EXTENT_FLAG_FILLING
, &
em
->
æags
);

8040 } ià(
ty³
 =ğ
BTRFS_ORDERED_COMPRESSED
) {

8041 
	`£t_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
);

8042 
em
->
com´ess_ty³
 = compress_type;

8045 
»t
 = 
	`bŒfs_»¶aû_ex‹Á_m­_¿nge
(
šode
, 
em
, 
Œue
);

8046 ià(
»t
) {

8047 
	`ä“_ex‹Á_m­
(
em
);

8048  
	`ERR_PTR
(
»t
);

8052  
em
;

8053 
	}
}

8056 
	$bŒfs_g‘_blocks_dœeù_wr™e
(
ex‹Á_m­
 **
m­
,

8057 
šode
 *inode,

8058 
bŒfs_dio_d©a
 *
dio_d©a
,

8059 
u64
 
¡¬t
, u64 *
ËÅ
,

8060 
iom­_æags
)

8062 cÚ¡ 
boŞ
 
nowa™
 = (
iom­_æags
 & 
IOMAP_NOWAIT
);

8063 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

8064 
ex‹Á_m­
 *
em
 = *
m­
;

8065 
ty³
;

8066 
u64
 
block_¡¬t
, 
Üig_¡¬t
, 
Üig_block_Ën
, 
¿m_by‹s
;

8067 
bŒfs_block_group
 *
bg
;

8068 
boŞ
 
ÿn_nocow
 = 
çl£
;

8069 
boŞ
 
¥aû_»£rved
 = 
çl£
;

8070 
u64
 
Ën
 = *
ËÅ
;

8071 
u64
 
´ev_Ën
;

8072 
»t
 = 0;

8083 ià(
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
) ||

8084 ((
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATACOW
) &&

8085 
em
->
block_¡¬t
 !ğ
EXTENT_MAP_HOLE
)) {

8086 ià(
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
))

8087 
ty³
 = 
BTRFS_ORDERED_PREALLOC
;

8089 
ty³
 = 
BTRFS_ORDERED_NOCOW
;

8090 
Ën
 = 
	`mš
Ö’, 
em
->ËÀ- (
¡¬t
 -ƒm->start));

8091 
block_¡¬t
 = 
em
->block_¡¬ˆ+ (
¡¬t
 -ƒm->start);

8093 ià(
	`ÿn_nocow_ex‹Á
(
šode
, 
¡¬t
, &
Ën
, &
Üig_¡¬t
,

8094 &
Üig_block_Ën
, &
¿m_by‹s
, 
çl£
, false) == 1) {

8095 
bg
 = 
	`bŒfs_šc_nocow_wr™”s
(
fs_šfo
, 
block_¡¬t
);

8096 ià(
bg
)

8097 
ÿn_nocow
 = 
Œue
;

8101 
´ev_Ën
 = 
Ën
;

8102 ià(
ÿn_nocow
) {

8103 
ex‹Á_m­
 *
em2
;

8106 
»t
 = 
	`bŒfs_d–®loc_»£rve_m‘ad©a
(
	`BTRFS_I
(
šode
), 
Ën
,†en,

8107 
nowa™
);

8108 ià(
»t
 < 0) {

8110 
	`ä“_ex‹Á_m­
(
em
);

8111 *
m­
 = 
NULL
;

8112 
	`bŒfs_dec_nocow_wr™”s
(
bg
);

8113 ià(
nowa™
 && (
»t
 =ğ-
ENOSPC
 ||„‘ =ğ-
EDQUOT
))

8114 
»t
 = -
EAGAIN
;

8115 
out
;

8117 
¥aû_»£rved
 = 
Œue
;

8119 
em2
 = 
	`bŒfs_ü—‹_dio_ex‹Á
(
	`BTRFS_I
(
šode
), 
dio_d©a
, 
¡¬t
, 
Ën
,

8120 
Üig_¡¬t
, 
block_¡¬t
,

8121 
Ën
, 
Üig_block_Ën
,

8122 
¿m_by‹s
, 
ty³
);

8123 
	`bŒfs_dec_nocow_wr™”s
(
bg
);

8124 ià(
ty³
 =ğ
BTRFS_ORDERED_PREALLOC
) {

8125 
	`ä“_ex‹Á_m­
(
em
);

8126 *
m­
 = 
em2
;

8127 
em
 = 
em2
;

8130 ià(
	`IS_ERR
(
em2
)) {

8131 
»t
 = 
	`PTR_ERR
(
em2
);

8132 
out
;

8135 
dio_d©a
->
nocow_dÚe
 = 
Œue
;

8138 
	`ä“_ex‹Á_m­
(
em
);

8139 *
m­
 = 
NULL
;

8141 ià(
nowa™
) {

8142 
»t
 = -
EAGAIN
;

8143 
out
;

8150 ià(!
dio_d©a
->
d©a_¥aû_»£rved
) {

8151 
»t
 = -
ENOSPC
;

8152 
out
;

8159 
»t
 = 
	`bŒfs_d–®loc_»£rve_m‘ad©a
(
	`BTRFS_I
(
šode
), 
Ën
,†en,

8160 
çl£
);

8161 ià(
»t
 < 0)

8162 
out
;

8163 
¥aû_»£rved
 = 
Œue
;

8165 
em
 = 
	`bŒfs_Ãw_ex‹Á_dœeù
(
	`BTRFS_I
(
šode
), 
dio_d©a
, 
¡¬t
, 
Ën
);

8166 ià(
	`IS_ERR
(
em
)) {

8167 
»t
 = 
	`PTR_ERR
(
em
);

8168 
out
;

8170 *
m­
 = 
em
;

8171 
Ën
 = 
	`mš
Ö’, 
em
->ËÀ- (
¡¬t
 -ƒm->start));

8172 ià(
Ën
 < 
´ev_Ën
)

8173 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
	`BTRFS_I
(
šode
),

8174 
´ev_Ën
 - 
Ën
, 
Œue
);

8181 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
	`BTRFS_I
(
šode
), 
´ev_Ën
);

8187 ià(
¡¬t
 + 
Ën
 > 
	`i_size_»ad
(
šode
))

8188 
	`i_size_wr™e
(
šode
, 
¡¬t
 + 
Ën
);

8189 
out
:

8190 ià(
»t
 && 
¥aû_»£rved
) {

8191 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
	`BTRFS_I
(
šode
), 
Ën
);

8192 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
	`BTRFS_I
(
šode
), 
Ën
, 
Œue
);

8194 *
ËÅ
 = 
Ën
;

8195  
»t
;

8196 
	}
}

8198 
	$bŒfs_dio_iom­_begš
(
šode
 *šode, 
loff_t
 
¡¬t
,

8199 
loff_t
 
Ëngth
, 
æags
, 
iom­
 *iomap,

8200 
iom­
 *
¤cm­
)

8202 
iom­_™”
 *
™”
 = 
	`cÚš”_of
(
iom­
, iomap_iter, iomap);

8203 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

8204 
ex‹Á_m­
 *
em
;

8205 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

8206 
bŒfs_dio_d©a
 *
dio_d©a
 = 
™”
->
´iv©e
;

8207 
u64
 
lock¡¬t
, 
lock’d
;

8208 cÚ¡ 
boŞ
 
wr™e
 = !!(
æags
 & 
IOMAP_WRITE
);

8209 
»t
 = 0;

8210 
u64
 
Ën
 = 
Ëngth
;

8211 cÚ¡ 
u64
 
d©a_®loc_Ën
 = 
Ëngth
;

8212 
boŞ
 
uÆock_ex‹Ás
 = 
çl£
;

8225 ià(!
wr™e
 && (
æags
 & 
IOMAP_NOWAIT
è&& 
Ëngth
 > 
PAGE_SIZE
)

8226  -
EAGAIN
;

8232 ià(!
wr™e
)

8233 
Ën
 = 
	`mš_t
(
u64
,†’, 
fs_šfo
->
£ùÜsize
 * 
BTRFS_MAX_BIO_SECTORS
);

8235 
lock¡¬t
 = 
¡¬t
;

8236 
lock’d
 = 
¡¬t
 + 
Ën
 - 1;

8256 ià(
	`‹¡_b™
(
BTRFS_INODE_HAS_ASYNC_EXTENT
,

8257 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
)) {

8258 ià(
æags
 & 
IOMAP_NOWAIT
) {

8259 ià(
	`fem­_¿nge_Ãeds_wr™eback
(
šode
->
i_m­pšg
,

8260 
lock¡¬t
, 
lock’d
))

8261  -
EAGAIN
;

8263 
»t
 = 
	`fem­_fd©awr™e_¿nge
(
šode
->
i_m­pšg
, 
¡¬t
,

8264 
¡¬t
 + 
Ëngth
 - 1);

8265 ià(
»t
)

8266  
»t
;

8270 
	`mem£t
(
dio_d©a
, 0, (*dio_data));

8281 ià(
wr™e
 && !(
æags
 & 
IOMAP_NOWAIT
)) {

8282 
»t
 = 
	`bŒfs_check_d©a_ä“_¥aû
(
	`BTRFS_I
(
šode
),

8283 &
dio_d©a
->
d©a_»£rved
,

8284 
¡¬t
, 
d©a_®loc_Ën
, 
çl£
);

8285 ià(!
»t
)

8286 
dio_d©a
->
d©a_¥aû_»£rved
 = 
Œue
;

8287 ià(
»t
 && !(
	`BTRFS_I
(
šode
)->
æags
 &

8288 (
BTRFS_INODE_NODATACOW
 | 
BTRFS_INODE_PREALLOC
)))

8289 
”r
;

8297 
»t
 = 
	`lock_ex‹Á_dœeù
(
šode
, 
lock¡¬t
, 
lock’d
, &
ÿched_¡©e
, 
æags
);

8298 ià(
»t
 < 0)

8299 
”r
;

8301 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
¡¬t
, 
Ën
);

8302 ià(
	`IS_ERR
(
em
)) {

8303 
»t
 = 
	`PTR_ERR
(
em
);

8304 
uÆock_”r
;

8321 ià(
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
) ||

8322 
em
->
block_¡¬t
 =ğ
EXTENT_MAP_INLINE
) {

8323 
	`ä“_ex‹Á_m­
(
em
);

8336 
»t
 = (
æags
 & 
IOMAP_NOWAIT
è? -
EAGAIN
 : -
ENOTBLK
;

8337 
uÆock_”r
;

8340 
Ën
 = 
	`mš
Ö’, 
em
->ËÀ- (
¡¬t
 -ƒm->start));

8363 ià((
æags
 & 
IOMAP_NOWAIT
è&& 
Ën
 < 
Ëngth
) {

8364 
	`ä“_ex‹Á_m­
(
em
);

8365 
»t
 = -
EAGAIN
;

8366 
uÆock_”r
;

8369 ià(
wr™e
) {

8370 
»t
 = 
	`bŒfs_g‘_blocks_dœeù_wr™e
(&
em
, 
šode
, 
dio_d©a
,

8371 
¡¬t
, &
Ën
, 
æags
);

8372 ià(
»t
 < 0)

8373 
uÆock_”r
;

8374 
uÆock_ex‹Ás
 = 
Œue
;

8376 
Ën
 = 
	`mš
Ö’, 
em
->ËÀ- (
¡¬t
 -ƒm->start));

8377 ià(
dio_d©a
->
d©a_¥aû_»£rved
) {

8378 
u64
 
»Ëa£_off£t
;

8379 
u64
 
»Ëa£_Ën
 = 0;

8381 ià(
dio_d©a
->
nocow_dÚe
) {

8382 
»Ëa£_off£t
 = 
¡¬t
;

8383 
»Ëa£_Ën
 = 
d©a_®loc_Ën
;

8384 } ià(
Ën
 < 
d©a_®loc_Ën
) {

8385 
»Ëa£_off£t
 = 
¡¬t
 + 
Ën
;

8386 
»Ëa£_Ën
 = 
d©a_®loc_Ën
 - 
Ën
;

8389 ià(
»Ëa£_Ën
 > 0)

8390 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
	`BTRFS_I
(
šode
),

8391 
dio_d©a
->
d©a_»£rved
,

8392 
»Ëa£_off£t
,

8393 
»Ëa£_Ën
);

8400 
lock¡¬t
 = 
¡¬t
 + 
Ën
;

8401 ià(
lock¡¬t
 < 
lock’d
)

8402 
uÆock_ex‹Ás
 = 
Œue
;

8405 ià(
uÆock_ex‹Ás
)

8406 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
, 
lock’d
,

8407 &
ÿched_¡©e
);

8409 
	`ä“_ex‹Á_¡©e
(
ÿched_¡©e
);

8416 ià((
em
->
block_¡¬t
 =ğ
EXTENT_MAP_HOLE
) ||

8417 (
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
è&& !
wr™e
)) {

8418 
iom­
->
addr
 = 
IOMAP_NULL_ADDR
;

8419 
iom­
->
ty³
 = 
IOMAP_HOLE
;

8421 
iom­
->
addr
 = 
em
->
block_¡¬t
 + (
¡¬t
 -ƒm->start);

8422 
iom­
->
ty³
 = 
IOMAP_MAPPED
;

8424 
iom­
->
off£t
 = 
¡¬t
;

8425 
iom­
->
bdev
 = 
fs_šfo
->
fs_deviûs
->
Ï‹¡_dev
->bdev;

8426 
iom­
->
Ëngth
 = 
Ën
;

8427 
	`ä“_ex‹Á_m­
(
em
);

8431 
uÆock_”r
:

8432 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
, 
lock’d
,

8433 &
ÿched_¡©e
);

8434 
”r
:

8435 ià(
dio_d©a
->
d©a_¥aû_»£rved
) {

8436 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
	`BTRFS_I
(
šode
),

8437 
dio_d©a
->
d©a_»£rved
,

8438 
¡¬t
, 
d©a_®loc_Ën
);

8439 
	`ex‹Á_chªge£t_ä“
(
dio_d©a
->
d©a_»£rved
);

8442  
»t
;

8443 
	}
}

8445 
	$bŒfs_dio_iom­_’d
(
šode
 *šode, 
loff_t
 
pos
,†off_ˆ
Ëngth
,

8446 
ssize_t
 
wr™‹n
, 
æags
, 
iom­
 *iomap)

8448 
iom­_™”
 *
™”
 = 
	`cÚš”_of
(
iom­
, iomap_iter, iomap);

8449 
bŒfs_dio_d©a
 *
dio_d©a
 = 
™”
->
´iv©e
;

8450 
size_t
 
subm™‹d
 = 
dio_d©a
->submitted;

8451 cÚ¡ 
boŞ
 
wr™e
 = !!(
æags
 & 
IOMAP_WRITE
);

8452 
»t
 = 0;

8454 ià(!
wr™e
 && (
iom­
->
ty³
 =ğ
IOMAP_HOLE
)) {

8456 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
pos
,…o + 
Ëngth
 - 1,

8457 
NULL
);

8461 ià(
subm™‹d
 < 
Ëngth
) {

8462 
pos
 +ğ
subm™‹d
;

8463 
Ëngth
 -ğ
subm™‹d
;

8464 ià(
wr™e
)

8465 
	`bŒfs_fšish_Üd”ed_ex‹Á
(
dio_d©a
->
Üd”ed
, 
NULL
,

8466 
pos
, 
Ëngth
, 
çl£
);

8468 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
pos
,

8469 
pos
 + 
Ëngth
 - 1, 
NULL
);

8470 
»t
 = -
ENOTBLK
;

8472 ià(
wr™e
) {

8473 
	`bŒfs_put_Üd”ed_ex‹Á
(
dio_d©a
->
Üd”ed
);

8474 
dio_d©a
->
Üd”ed
 = 
NULL
;

8477 ià(
wr™e
)

8478 
	`ex‹Á_chªge£t_ä“
(
dio_d©a
->
d©a_»£rved
);

8479  
»t
;

8480 
	}
}

8482 
	$bŒfs_dio_’d_io
(
bŒfs_bio
 *
bbio
)

8484 
bŒfs_dio_´iv©e
 *
d
 =

8485 
	`cÚš”_of
(
bbio
, 
bŒfs_dio_´iv©e
, bbio);

8486 
bŒfs_šode
 *
šode
 = 
bbio
->inode;

8487 
bio
 *biØğ&
bbio
->bio;

8489 ià(
bio
->
bi_¡©us
) {

8490 
	`bŒfs_w¬n
(
šode
->
roÙ
->
fs_šfo
,

8492 
	`bŒfs_šo
(
šode
), 
bio
->
bi_İf
,

8493 
d
->
fe_off£t
, d->
by‹s
, 
bio
->
bi_¡©us
);

8496 ià(
	`bŒfs_İ
(
bio
è=ğ
BTRFS_MAP_WRITE
) {

8497 
	`bŒfs_fšish_Üd”ed_ex‹Á
(
bbio
->
Üd”ed
, 
NULL
,

8498 
d
->
fe_off£t
, d->
by‹s
,

8499 !
bio
->
bi_¡©us
);

8501 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
d
->
fe_off£t
,

8502 
d
->
fe_off£t
 + d->
by‹s
 - 1, 
NULL
);

8505 
bbio
->
bio
.
bi_´iv©e
 = bbio->
´iv©e
;

8506 
	`iom­_dio_bio_’d_io
(
bio
);

8507 
	}
}

8509 
	$bŒfs_dio_subm™_io
(cÚ¡ 
iom­_™”
 *
™”
, 
bio
 *bio,

8510 
loff_t
 
fe_off£t
)

8512 
bŒfs_bio
 *
bbio
 = 
	`bŒfs_bio
(
bio
);

8513 
bŒfs_dio_´iv©e
 *
d
 =

8514 
	`cÚš”_of
(
bbio
, 
bŒfs_dio_´iv©e
, bbio);

8515 
bŒfs_dio_d©a
 *
dio_d©a
 = 
™”
->
´iv©e
;

8517 
	`bŒfs_bio_š™
(
bbio
, 
	`BTRFS_I
(
™”
->
šode
)->
roÙ
->
fs_šfo
,

8518 
bŒfs_dio_’d_io
, 
bio
->
bi_´iv©e
);

8519 
bbio
->
šode
 = 
	`BTRFS_I
(
™”
->inode);

8520 
bbio
->
fe_off£t
 = file_offset;

8522 
d
->
fe_off£t
 = file_offset;

8523 
d
->
by‹s
 = 
bio
->
bi_™”
.
bi_size
;

8525 
dio_d©a
->
subm™‹d
 +ğ
bio
->
bi_™”
.
bi_size
;

8534 ià(
™”
->
æags
 & 
IOMAP_WRITE
) {

8535 
»t
;

8537 
»t
 = 
	`bŒfs_exŒaù_Üd”ed_ex‹Á
(
bbio
, 
dio_d©a
->
Üd”ed
);

8538 ià(
»t
) {

8539 
	`bŒfs_fšish_Üd”ed_ex‹Á
(
dio_d©a
->
Üd”ed
, 
NULL
,

8540 
fe_off£t
, 
d
->
by‹s
,

8541 !
»t
);

8542 
bio
->
bi_¡©us
 = 
	`”ºo_to_blk_¡©us
(
»t
);

8543 
	`iom­_dio_bio_’d_io
(
bio
);

8548 
	`bŒfs_subm™_bio
(
bbio
, 0);

8549 
	}
}

8551 cÚ¡ 
iom­_İs
 
	gbŒfs_dio_iom­_İs
 = {

8552 .
iom­_begš
 = 
bŒfs_dio_iom­_begš
,

8553 .
	giom­_’d
 = 
bŒfs_dio_iom­_’d
,

8556 cÚ¡ 
iom­_dio_İs
 
	gbŒfs_dio_İs
 = {

8557 .
subm™_io
 = 
bŒfs_dio_subm™_io
,

8558 .
	gbio_£t
 = &
bŒfs_dio_bio£t
,

8561 
ssize_t
 
	$bŒfs_dio_»ad
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
, 
size_t
 
dÚe_befÜe
)

8563 
bŒfs_dio_d©a
 
d©a
 = { 0 };

8565  
	`iom­_dio_rw
(
iocb
, 
™”
, &
bŒfs_dio_iom­_İs
, &
bŒfs_dio_İs
,

8566 
IOMAP_DIO_PARTIAL
, &
d©a
, 
dÚe_befÜe
);

8567 
	}
}

8569 
iom­_dio
 *
	$bŒfs_dio_wr™e
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
,

8570 
size_t
 
dÚe_befÜe
)

8572 
bŒfs_dio_d©a
 
d©a
 = { 0 };

8574  
	`__iom­_dio_rw
(
iocb
, 
™”
, &
bŒfs_dio_iom­_İs
, &
bŒfs_dio_İs
,

8575 
IOMAP_DIO_PARTIAL
, &
d©a
, 
dÚe_befÜe
);

8576 
	}
}

8578 
	$bŒfs_f›m­
(
šode
 *šode, 
f›m­_ex‹Á_šfo
 *
f›šfo
,

8579 
u64
 
¡¬t
, u64 
Ën
)

8581 
»t
;

8583 
»t
 = 
	`f›m­_´•
(
šode
, 
f›šfo
, 
¡¬t
, &
Ën
, 0);

8584 ià(
»t
)

8585  
»t
;

8600 ià(
f›šfo
->
fi_æags
 & 
FIEMAP_FLAG_SYNC
) {

8601 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 0, 
LLONG_MAX
);

8602 ià(
»t
)

8603  
»t
;

8606  
	`ex‹Á_f›m­
(
	`BTRFS_I
(
šode
), 
f›šfo
, 
¡¬t
, 
Ën
);

8607 
	}
}

8609 
	$bŒfs_wr™•ages
(
add»ss_¥aû
 *
m­pšg
,

8610 
wr™eback_cÚŒŞ
 *
wbc
)

8612  
	`ex‹Á_wr™•ages
(
m­pšg
, 
wbc
);

8613 
	}
}

8615 
	$bŒfs_»adah—d
(
»adah—d_cÚŒŞ
 *
¿c
)

8617 
	`´štk
(
KERN_INFO
 "btrfs_readahead: Starto„ead from„ead_ahead...\n");

8618 
	`ex‹Á_»adah—d
(
¿c
);

8619 
	}
}

8628 
	$wa™_sub·ge_¥šlock
(
·ge
 *page)

8630 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
·ge
->
m­pšg
->
ho¡
->
i_sb
);

8631 
bŒfs_sub·ge
 *
sub·ge
;

8633 ià(!
	`bŒfs_is_sub·ge
(
fs_šfo
, 
·ge
))

8636 
	`ASSERT
(
	`PagePriv©e
(
·ge
è&&…age->
´iv©e
);

8637 
sub·ge
 = (
bŒfs_sub·ge
 *)
·ge
->
´iv©e
;

8650 
	`¥š_lock_œq
(&
sub·ge
->
lock
);

8651 
	`¥š_uÆock_œq
(&
sub·ge
->
lock
);

8652 
	}
}

8654 
boŞ
 
	$__bŒfs_»Ëa£_fŞio
(
fŞio
 *fŞio, 
gå_t
 
gå_æags
)

8656 
»t
 = 
	`Œy_»Ëa£_ex‹Á_m­pšg
(&
fŞio
->
·ge
, 
gå_æags
);

8658 ià(
»t
 == 1) {

8659 
	`wa™_sub·ge_¥šlock
(&
fŞio
->
·ge
);

8660 
	`ş—r_·ge_ex‹Á_m­³d
(&
fŞio
->
·ge
);

8662  
»t
;

8663 
	}
}

8665 
boŞ
 
	$bŒfs_»Ëa£_fŞio
(
fŞio
 *fŞio, 
gå_t
 
gå_æags
)

8667 ià(
	`fŞio_‹¡_wr™eback
(
fŞio
è|| 
	`fŞio_‹¡_dœty
(folio))

8668  
çl£
;

8669  
	`__bŒfs_»Ëa£_fŞio
(
fŞio
, 
gå_æags
);

8670 
	}
}

8672 #ifdeà
CONFIG_MIGRATION


8673 
	$bŒfs_mig¿‹_fŞio
(
add»ss_¥aû
 *
m­pšg
,

8674 
fŞio
 *
d¡
, fŞiØ*
¤c
,

8675 
mig¿‹_mode
 
mode
)

8677 
»t
 = 
	`fem­_mig¿‹_fŞio
(
m­pšg
, 
d¡
, 
¤c
, 
mode
);

8679 ià(
»t
 !ğ
MIGRATEPAGE_SUCCESS
)

8680  
»t
;

8682 ià(
	`fŞio_‹¡_Üd”ed
(
¤c
)) {

8683 
	`fŞio_ş—r_Üd”ed
(
¤c
);

8684 
	`fŞio_£t_Üd”ed
(
d¡
);

8687  
MIGRATEPAGE_SUCCESS
;

8688 
	}
}

8690 
	#bŒfs_mig¿‹_fŞio
 
NULL


	)

8693 
	$bŒfs_šv®id©e_fŞio
(
fŞio
 *fŞio, 
size_t
 
off£t
,

8694 
size_t
 
Ëngth
)

8696 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
fŞio
->
m­pšg
->
ho¡
);

8697 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

8698 
ex‹Á_io_Œ“
 *
Œ“
 = &
šode
->
io_Œ“
;

8699 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

8700 
u64
 
·ge_¡¬t
 = 
	`fŞio_pos
(
fŞio
);

8701 
u64
 
·ge_’d
 = 
·ge_¡¬t
 + 
	`fŞio_size
(
fŞio
) - 1;

8702 
u64
 
cur
;

8703 
šode_eviùšg
 = 
šode
->
vfs_šode
.
i_¡©e
 & 
I_FREEING
;

8718 
	`fŞio_wa™_wr™eback
(
fŞio
);

8719 
	`wa™_sub·ge_¥šlock
(&
fŞio
->
·ge
);

8733 ià(!(
off£t
 =ğ0 && 
Ëngth
 =ğ
	`fŞio_size
(
fŞio
))) {

8734 
	`bŒfs_»Ëa£_fŞio
(
fŞio
, 
GFP_NOFS
);

8738 ià(!
šode_eviùšg
)

8739 
	`lock_ex‹Á
(
Œ“
, 
·ge_¡¬t
, 
·ge_’d
, &
ÿched_¡©e
);

8741 
cur
 = 
·ge_¡¬t
;

8742 
cur
 < 
·ge_’d
) {

8743 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

8744 
u64
 
¿nge_’d
;

8745 
u32
 
¿nge_Ën
;

8746 
u32
 
exŒa_æags
 = 0;

8748 
Üd”ed
 = 
	`bŒfs_lookup_fœ¡_Üd”ed_¿nge
(
šode
, 
cur
,

8749 
·ge_’d
 + 1 - 
cur
);

8750 ià(!
Üd”ed
) {

8751 
¿nge_’d
 = 
·ge_’d
;

8756 
exŒa_æags
 = 
EXTENT_CLEAR_ALL_BITS
;

8757 
Ãxt
;

8759 ià(
Üd”ed
->
fe_off£t
 > 
cur
) {

8766 
¿nge_’d
 = 
Üd”ed
->
fe_off£t
 - 1;

8767 
exŒa_æags
 = 
EXTENT_CLEAR_ALL_BITS
;

8768 
Ãxt
;

8771 
¿nge_’d
 = 
	`mš
(
Üd”ed
->
fe_off£t
 + ord”ed->
num_by‹s
 - 1,

8772 
·ge_’d
);

8773 
	`ASSERT
(
¿nge_’d
 + 1 - 
cur
 < 
U32_MAX
);

8774 
¿nge_Ën
 = 
¿nge_’d
 + 1 - 
cur
;

8775 ià(!
	`bŒfs_·ge_‹¡_Üd”ed
(
fs_šfo
, &
fŞio
->
·ge
, 
cur
, 
¿nge_Ën
)) {

8782 
Ãxt
;

8784 
	`bŒfs_·ge_ş—r_Üd”ed
(
fs_šfo
, &
fŞio
->
·ge
, 
cur
, 
¿nge_Ën
);

8794 ià(!
šode_eviùšg
)

8795 
	`ş—r_ex‹Á_b™
(
Œ“
, 
cur
, 
¿nge_’d
,

8796 
EXTENT_DELALLOC
 |

8797 
EXTENT_LOCKED
 | 
EXTENT_DO_ACCOUNTING
 |

8798 
EXTENT_DEFRAG
, &
ÿched_¡©e
);

8800 
	`¥š_lock_œq
(&
šode
->
Üd”ed_Œ“
.
lock
);

8801 
	`£t_b™
(
BTRFS_ORDERED_TRUNCATED
, &
Üd”ed
->
æags
);

8802 
Üd”ed
->
Œunÿ‹d_Ën
 = 
	`mš
(ordered->truncated_len,

8803 
cur
 - 
Üd”ed
->
fe_off£t
);

8804 
	`¥š_uÆock_œq
(&
šode
->
Üd”ed_Œ“
.
lock
);

8812 ià(
	`bŒfs_dec_‹¡_Üd”ed_³ndšg
(
šode
, &
Üd”ed
,

8813 
cur
, 
¿nge_’d
 + 1 - cur)) {

8814 
	`bŒfs_fšish_Üd”ed_io
(
Üd”ed
);

8819 
exŒa_æags
 = 
EXTENT_CLEAR_ALL_BITS
;

8821 
Ãxt
:

8822 ià(
Üd”ed
)

8823 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

8839 
	`bŒfs_qgroup_ä“_d©a
(
šode
, 
NULL
, 
cur
, 
¿nge_’d
 + 1 - cur, NULL);

8840 ià(!
šode_eviùšg
) {

8841 
	`ş—r_ex‹Á_b™
(
Œ“
, 
cur
, 
¿nge_’d
, 
EXTENT_LOCKED
 |

8842 
EXTENT_DELALLOC
 | 
EXTENT_UPTODATE
 |

8843 
EXTENT_DO_ACCOUNTING
 | 
EXTENT_DEFRAG
 |

8844 
exŒa_æags
, &
ÿched_¡©e
);

8846 
cur
 = 
¿nge_’d
 + 1;

8853 
	`ASSERT
(!
	`fŞio_‹¡_Üd”ed
(
fŞio
));

8854 
	`bŒfs_·ge_ş—r_checked
(
fs_šfo
, &
fŞio
->
·ge
, 
	`fŞio_pos
(fŞio), 
	`fŞio_size
(folio));

8855 ià(!
šode_eviùšg
)

8856 
	`__bŒfs_»Ëa£_fŞio
(
fŞio
, 
GFP_NOFS
);

8857 
	`ş—r_·ge_ex‹Á_m­³d
(&
fŞio
->
·ge
);

8858 
	}
}

8875 
vm_çuÉ_t
 
	$bŒfs_·ge_mkwr™e
(
vm_çuÉ
 *
vmf
)

8877 
·ge
 *·gğ
vmf
->page;

8878 
šode
 *šodğ
	`fe_šode
(
vmf
->
vma
->
vm_fe
);

8879 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

8880 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

8881 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

8882 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

8883 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

8884 
z”o_¡¬t
;

8885 
loff_t
 
size
;

8886 
vm_çuÉ_t
 
»t
;

8887 
»t2
;

8888 
»£rved
 = 0;

8889 
u64
 
»£rved_¥aû
;

8890 
u64
 
·ge_¡¬t
;

8891 
u64
 
·ge_’d
;

8892 
u64
 
’d
;

8894 
»£rved_¥aû
 = 
PAGE_SIZE
;

8896 
	`sb_¡¬t_·geçuÉ
(
šode
->
i_sb
);

8897 
·ge_¡¬t
 = 
	`·ge_off£t
(
·ge
);

8898 
·ge_’d
 = 
·ge_¡¬t
 + 
PAGE_SIZE
 - 1;

8899 
’d
 = 
·ge_’d
;

8909 
»t2
 = 
	`bŒfs_d–®loc_»£rve_¥aû
(
	`BTRFS_I
(
šode
), &
d©a_»£rved
,

8910 
·ge_¡¬t
, 
»£rved_¥aû
);

8911 ià(!
»t2
) {

8912 
»t2
 = 
	`fe_upd©e_time
(
vmf
->
vma
->
vm_fe
);

8913 
»£rved
 = 1;

8915 ià(
»t2
) {

8916 
»t
 = 
	`vmf_”rÜ
(
»t2
);

8917 ià(
»£rved
)

8918 
out
;

8919 
out_nÜe£rve
;

8922 
»t
 = 
VM_FAULT_NOPAGE
;

8923 
agaš
:

8924 
	`down_»ad
(&
	`BTRFS_I
(
šode
)->
i_mm­_lock
);

8925 
	`lock_·ge
(
·ge
);

8926 
size
 = 
	`i_size_»ad
(
šode
);

8928 ià((
·ge
->
m­pšg
 !ğ
šode
->
i_m­pšg
) ||

8929 (
·ge_¡¬t
 >ğ
size
)) {

8931 
out_uÆock
;

8933 
	`wa™_Ú_·ge_wr™eback
(
·ge
);

8935 
	`lock_ex‹Á
(
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
, &
ÿched_¡©e
);

8936 
»t2
 = 
	`£t_·ge_ex‹Á_m­³d
(
·ge
);

8937 ià(
»t2
 < 0) {

8938 
»t
 = 
	`vmf_”rÜ
(
»t2
);

8939 
	`uÆock_ex‹Á
(
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
, &
ÿched_¡©e
);

8940 
out_uÆock
;

8947 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
	`BTRFS_I
(
šode
), 
·ge_¡¬t
,

8948 
PAGE_SIZE
);

8949 ià(
Üd”ed
) {

8950 
	`uÆock_ex‹Á
(
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
, &
ÿched_¡©e
);

8951 
	`uÆock_·ge
(
·ge
);

8952 
	`up_»ad
(&
	`BTRFS_I
(
šode
)->
i_mm­_lock
);

8953 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
Üd”ed
);

8954 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

8955 
agaš
;

8958 ià(
·ge
->
šdex
 =ğ((
size
 - 1è>> 
PAGE_SHIFT
)) {

8959 
»£rved_¥aû
 = 
	`round_up
(
size
 - 
·ge_¡¬t
,

8960 
fs_šfo
->
£ùÜsize
);

8961 ià(
»£rved_¥aû
 < 
PAGE_SIZE
) {

8962 
’d
 = 
·ge_¡¬t
 + 
»£rved_¥aû
 - 1;

8963 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
	`BTRFS_I
(
šode
),

8964 
d©a_»£rved
, 
·ge_¡¬t
,

8965 
PAGE_SIZE
 - 
»£rved_¥aû
, 
Œue
);

8976 
	`ş—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
·ge_¡¬t
, 
’d
,

8977 
EXTENT_DELALLOC
 | 
EXTENT_DO_ACCOUNTING
 |

8978 
EXTENT_DEFRAG
, &
ÿched_¡©e
);

8980 
»t2
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
	`BTRFS_I
(
šode
), 
·ge_¡¬t
, 
’d
, 0,

8981 &
ÿched_¡©e
);

8982 ià(
»t2
) {

8983 
	`uÆock_ex‹Á
(
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
, &
ÿched_¡©e
);

8984 
»t
 = 
VM_FAULT_SIGBUS
;

8985 
out_uÆock
;

8989 ià(
·ge_¡¬t
 + 
PAGE_SIZE
 > 
size
)

8990 
z”o_¡¬t
 = 
	`off£t_š_·ge
(
size
);

8992 
z”o_¡¬t
 = 
PAGE_SIZE
;

8994 ià(
z”o_¡¬t
 !ğ
PAGE_SIZE
)

8995 
	`memz”o_·ge
(
·ge
, 
z”o_¡¬t
, 
PAGE_SIZE
 - zero_start);

8997 
	`bŒfs_·ge_ş—r_checked
(
fs_šfo
, 
·ge
, 
·ge_¡¬t
, 
PAGE_SIZE
);

8998 
	`bŒfs_·ge_£t_dœty
(
fs_šfo
, 
·ge
, 
·ge_¡¬t
, 
’d
 + 1 -…age_start);

8999 
	`bŒfs_·ge_£t_u±od©e
(
fs_šfo
, 
·ge
, 
·ge_¡¬t
, 
’d
 + 1 -…age_start);

9001 
	`bŒfs_£t_šode_Ï¡_sub_Œªs
(
	`BTRFS_I
(
šode
));

9003 
	`uÆock_ex‹Á
(
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
, &
ÿched_¡©e
);

9004 
	`up_»ad
(&
	`BTRFS_I
(
šode
)->
i_mm­_lock
);

9006 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
	`BTRFS_I
(
šode
), 
PAGE_SIZE
);

9007 
	`sb_’d_·geçuÉ
(
šode
->
i_sb
);

9008 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

9009  
VM_FAULT_LOCKED
;

9011 
out_uÆock
:

9012 
	`uÆock_·ge
(
·ge
);

9013 
	`up_»ad
(&
	`BTRFS_I
(
šode
)->
i_mm­_lock
);

9014 
out
:

9015 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
	`BTRFS_I
(
šode
), 
PAGE_SIZE
);

9016 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
	`BTRFS_I
(
šode
), 
d©a_»£rved
, 
·ge_¡¬t
,

9017 
»£rved_¥aû
, (
»t
 != 0));

9018 
out_nÜe£rve
:

9019 
	`sb_’d_·geçuÉ
(
šode
->
i_sb
);

9020 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

9021  
»t
;

9022 
	}
}

9024 
	$bŒfs_Œunÿ‹
(
bŒfs_šode
 *
šode
, 
boŞ
 
sk_wr™eback
)

9026 
bŒfs_Œunÿ‹_cÚŒŞ
 
cÚŒŞ
 = {

9027 .
šode
 = inode,

9028 .
šo
 = 
	`bŒfs_šo
(
šode
),

9029 .
mš_ty³
 = 
BTRFS_EXTENT_DATA_KEY
,

9030 .
ş—r_ex‹Á_¿nge
 = 
Œue
,

9032 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

9033 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

9034 
bŒfs_block_rsv
 *
rsv
;

9035 
»t
;

9036 
bŒfs_Œªs_hªdË
 *
Œªs
;

9037 
u64
 
mask
 = 
fs_šfo
->
£ùÜsize
 - 1;

9038 cÚ¡ 
u64
 
mš_size
 = 
	`bŒfs_ÿlc_m‘ad©a_size
(
fs_šfo
, 1);

9040 ià(!
sk_wr™eback
) {

9041 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(&
šode
->
vfs_šode
,

9042 
šode
->
vfs_šode
.
i_size
 & (~
mask
),

9043 (
u64
)-1);

9044 ià(
»t
)

9045  
»t
;

9076 
rsv
 = 
	`bŒfs_®loc_block_rsv
(
fs_šfo
, 
BTRFS_BLOCK_RSV_TEMP
);

9077 ià(!
rsv
)

9078  -
ENOMEM
;

9079 
rsv
->
size
 = 
mš_size
;

9080 
rsv
->
çç¡
 = 
Œue
;

9086 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 2);

9087 ià(
	`IS_ERR
(
Œªs
)) {

9088 
»t
 = 
	`PTR_ERR
(
Œªs
);

9089 
out
;

9093 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(&
fs_šfo
->
Œªs_block_rsv
, 
rsv
,

9094 
mš_size
, 
çl£
);

9100 ià(
	`WARN_ON
(
»t
)) {

9101 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

9102 
out
;

9105 
Œªs
->
block_rsv
 = 
rsv
;

9108 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

9109 cÚ¡ 
u64
 
Ãw_size
 = 
šode
->
vfs_šode
.
i_size
;

9110 cÚ¡ 
u64
 
lock_¡¬t
 = 
	`ALIGN_DOWN
(
Ãw_size
, 
fs_šfo
->
£ùÜsize
);

9112 
cÚŒŞ
.
Ãw_size
 =‚ew_size;

9113 
	`lock_ex‹Á
(&
šode
->
io_Œ“
, 
lock_¡¬t
, (
u64
)-1, &
ÿched_¡©e
);

9119 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
šode
,

9120 
	`ALIGN
(
Ãw_size
, 
fs_šfo
->
£ùÜsize
),

9121 (
u64
)-1, 
çl£
);

9123 
»t
 = 
	`bŒfs_Œunÿ‹_šode_™ems
(
Œªs
, 
roÙ
, &
cÚŒŞ
);

9125 
	`šode_sub_by‹s
(&
šode
->
vfs_šode
, 
cÚŒŞ
.
sub_by‹s
);

9126 
	`bŒfs_šode_§ã_disk_i_size_wr™e
(
šode
, 
cÚŒŞ
.
Ï¡_size
);

9128 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
lock_¡¬t
, (
u64
)-1, &
ÿched_¡©e
);

9130 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

9131 ià(
»t
 !ğ-
ENOSPC
 &&„‘ !ğ-
EAGAIN
)

9134 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

9135 ià(
»t
)

9138 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

9139 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

9141 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 2);

9142 ià(
	`IS_ERR
(
Œªs
)) {

9143 
»t
 = 
	`PTR_ERR
(
Œªs
);

9144 
Œªs
 = 
NULL
;

9148 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rsv
, -1, 
NULL
);

9149 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(&
fs_šfo
->
Œªs_block_rsv
,

9150 
rsv
, 
mš_size
, 
çl£
);

9156 ià(
	`WARN_ON
(
»t
))

9159 
Œªs
->
block_rsv
 = 
rsv
;

9168 ià(
»t
 =ğ
BTRFS_NEED_TRUNCATE_BLOCK
) {

9169 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

9170 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

9172 
»t
 = 
	`bŒfs_Œunÿ‹_block
(
šode
, inode->
vfs_šode
.
i_size
, 0, 0);

9173 ià(
»t
)

9174 
out
;

9175 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

9176 ià(
	`IS_ERR
(
Œªs
)) {

9177 
»t
 = 
	`PTR_ERR
(
Œªs
);

9178 
out
;

9180 
	`bŒfs_šode_§ã_disk_i_size_wr™e
(
šode
, 0);

9183 ià(
Œªs
) {

9184 
»t2
;

9186 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

9187 
»t2
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

9188 ià(
»t2
 && !
»t
)

9189 
»t
 = 
»t2
;

9191 
»t2
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

9192 ià(
»t2
 && !
»t
)

9193 
»t
 = 
»t2
;

9194 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

9196 
out
:

9197 
	`bŒfs_ä“_block_rsv
(
fs_šfo
, 
rsv
);

9212 ià(
cÚŒŞ
.
ex‹Ás_found
 > 0)

9213 
	`bŒfs_£t_šode_fuÎ_sync
(
šode
);

9215  
»t
;

9216 
	}
}

9218 
šode
 *
	$bŒfs_Ãw_subvŞ_šode
(
mÁ_idm­
 *
idm­
,

9219 
šode
 *
dœ
)

9221 
šode
 *inode;

9223 
šode
 = 
	`Ãw_šode
(
dœ
->
i_sb
);

9224 ià(
šode
) {

9229 
	`šode_š™_owÃr
(
idm­
, 
šode
, 
NULL
,

9230 
S_IFDIR
 | (~
	`cu¼’t_umask
(è& 
S_IRWXUGO
));

9231 
šode
->
i_İ
 = &
bŒfs_dœ_šode_İ”©iÚs
;

9232 
šode
->
i_fİ
 = &
bŒfs_dœ_fe_İ”©iÚs
;

9234  
šode
;

9235 
	}
}

9237 
šode
 *
	$bŒfs_®loc_šode
(
su³r_block
 *
sb
)

9239 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

9240 
bŒfs_šode
 *
ei
;

9241 
šode
 *inode;

9243 
ei
 = 
	`®loc_šode_sb
(
sb
, 
bŒfs_šode_ÿch•
, 
GFP_KERNEL
);

9244 ià(!
ei
)

9245  
NULL
;

9247 
ei
->
roÙ
 = 
NULL
;

9248 
ei
->
g’”©iÚ
 = 0;

9249 
ei
->
Ï¡_Œªs
 = 0;

9250 
ei
->
Ï¡_sub_Œªs
 = 0;

9251 
ei
->
logged_Œªs
 = 0;

9252 
ei
->
d–®loc_by‹s
 = 0;

9253 
ei
->
Ãw_d–®loc_by‹s
 = 0;

9254 
ei
->
deäag_by‹s
 = 0;

9255 
ei
->
disk_i_size
 = 0;

9256 
ei
->
æags
 = 0;

9257 
ei
->
ro_æags
 = 0;

9258 
ei
->
csum_by‹s
 = 0;

9259 
ei
->
šdex_út
 = (
u64
)-1;

9260 
ei
->
dœ_šdex
 = 0;

9261 
ei
->
Ï¡_uÆšk_Œªs
 = 0;

9262 
ei
->
Ï¡_»æšk_Œªs
 = 0;

9263 
ei
->
Ï¡_log_comm™
 = 0;

9265 
	`¥š_lock_š™
(&
ei
->
lock
);

9266 
ei
->
out¡ªdšg_ex‹Ás
 = 0;

9267 ià(
sb
->
s_magic
 !ğ
BTRFS_TEST_MAGIC
)

9268 
	`bŒfs_š™_m‘ad©a_block_rsv
(
fs_šfo
, &
ei
->
block_rsv
,

9269 
BTRFS_BLOCK_RSV_DELALLOC
);

9270 
ei
->
ruÁime_æags
 = 0;

9271 
ei
->
´İ_com´ess
 = 
BTRFS_COMPRESS_NONE
;

9272 
ei
->
deäag_com´ess
 = 
BTRFS_COMPRESS_NONE
;

9274 
ei
->
d–ayed_node
 = 
NULL
;

9276 
ei
->
i_Ùime
.
tv_£c
 = 0;

9277 
ei
->
i_Ùime
.
tv_n£c
 = 0;

9279 
šode
 = &
ei
->
vfs_šode
;

9280 
	`ex‹Á_m­_Œ“_š™
(&
ei
->
ex‹Á_Œ“
);

9281 
	`ex‹Á_io_Œ“_š™
(
fs_šfo
, &
ei
->
io_Œ“
, 
IO_TREE_INODE_IO
);

9282 
ei
->
io_Œ“
.
šode
 =ƒi;

9283 
	`ex‹Á_io_Œ“_š™
(
fs_šfo
, &
ei
->
fe_ex‹Á_Œ“
,

9284 
IO_TREE_INODE_FILE_EXTENT
);

9285 
	`mu‹x_š™
(&
ei
->
log_mu‹x
);

9286 
	`bŒfs_Üd”ed_šode_Œ“_š™
(&
ei
->
Üd”ed_Œ“
);

9287 
	`INIT_LIST_HEAD
(&
ei
->
d–®loc_šodes
);

9288 
	`INIT_LIST_HEAD
(&
ei
->
d–ayed_ut
);

9289 
	`RB_CLEAR_NODE
(&
ei
->
rb_node
);

9290 
	`š™_rw£m
(&
ei
->
i_mm­_lock
);

9292  
šode
;

9293 
	}
}

9295 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


9296 
	$bŒfs_‹¡_de¡roy_šode
(
šode
 *inode)

9298 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
	`BTRFS_I
(
šode
), 0, (
u64
)-1, 
çl£
);

9299 
	`kmem_ÿche_ä“
(
bŒfs_šode_ÿch•
, 
	`BTRFS_I
(
šode
));

9300 
	}
}

9303 
	$bŒfs_ä“_šode
(
šode
 *inode)

9305 
	`kmem_ÿche_ä“
(
bŒfs_šode_ÿch•
, 
	`BTRFS_I
(
šode
));

9306 
	}
}

9308 
	$bŒfs_de¡roy_šode
(
šode
 *
vfs_šode
)

9310 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

9311 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
vfs_šode
);

9312 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

9313 
boŞ
 
ä“¥aû_šode
;

9315 
	`WARN_ON
(!
	`hli¡_em±y
(&
vfs_šode
->
i_d’Œy
));

9316 
	`WARN_ON
(
vfs_šode
->
i_d©a
.
Ä·ges
);

9317 
	`WARN_ON
(
šode
->
block_rsv
.
»£rved
);

9318 
	`WARN_ON
(
šode
->
block_rsv
.
size
);

9319 
	`WARN_ON
(
šode
->
out¡ªdšg_ex‹Ás
);

9320 ià(!
	`S_ISDIR
(
vfs_šode
->
i_mode
)) {

9321 
	`WARN_ON
(
šode
->
d–®loc_by‹s
);

9322 
	`WARN_ON
(
šode
->
Ãw_d–®loc_by‹s
);

9324 
	`WARN_ON
(
šode
->
csum_by‹s
);

9325 
	`WARN_ON
(
šode
->
deäag_by‹s
);

9332 ià(!
roÙ
)

9339 
ä“¥aû_šode
 = 
	`bŒfs_is_ä“_¥aû_šode
(
šode
);

9342 
Üd”ed
 = 
	`bŒfs_lookup_fœ¡_Üd”ed_ex‹Á
(
šode
, (
u64
)-1);

9343 ià(!
Üd”ed
)

9346 
	`bŒfs_”r
(
roÙ
->
fs_šfo
,

9348 
Üd”ed
->
fe_off£t
, ord”ed->
num_by‹s
);

9350 ià(!
ä“¥aû_šode
)

9351 
	`bŒfs_lockd•_acquœe
(
roÙ
->
fs_šfo
, 
bŒfs_Üd”ed_ex‹Á
);

9353 
	`bŒfs_»move_Üd”ed_ex‹Á
(
šode
, 
Üd”ed
);

9354 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

9355 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

9358 
	`bŒfs_qgroup_check_»£rved_Ëak
(
šode
);

9359 
	`šode_Œ“_d–
(
šode
);

9360 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
šode
, 0, (
u64
)-1, 
çl£
);

9361 
	`bŒfs_šode_ş—r_fe_ex‹Á_¿nge
(
šode
, 0, (
u64
)-1);

9362 
	`bŒfs_put_roÙ
(
šode
->
roÙ
);

9363 
	}
}

9365 
	$bŒfs_drİ_šode
(
šode
 *inode)

9367 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

9369 ià(
roÙ
 =ğ
NULL
)

9373 ià(
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0)

9376  
	`g’”ic_drİ_šode
(
šode
);

9377 
	}
}

9379 
	$š™_Úû
(*
foo
)

9381 
bŒfs_šode
 *
ei
 = 
foo
;

9383 
	`šode_š™_Úû
(&
ei
->
vfs_šode
);

9384 
	}
}

9386 
__cŞd
 
	$bŒfs_de¡roy_ÿch•
()

9392 
	`rcu_b¬r›r
();

9393 
	`bio£t_ex™
(&
bŒfs_dio_bio£t
);

9394 
	`kmem_ÿche_de¡roy
(
bŒfs_šode_ÿch•
);

9395 
	}
}

9397 
__š™
 
	$bŒfs_š™_ÿch•
()

9399 
bŒfs_šode_ÿch•
 = 
	`kmem_ÿche_ü—‹
("btrfs_inode",

9400 (
bŒfs_šode
), 0,

9401 
SLAB_RECLAIM_ACCOUNT
 | 
SLAB_MEM_SPREAD
 | 
SLAB_ACCOUNT
,

9402 
š™_Úû
);

9403 ià(!
bŒfs_šode_ÿch•
)

9404 
ç
;

9406 ià(
	`bio£t_š™
(&
bŒfs_dio_bio£t
, 
BIO_POOL_SIZE
,

9407 
	`off£tof
(
bŒfs_dio_´iv©e
, 
bbio
.
bio
),

9408 
BIOSET_NEED_BVECS
))

9409 
ç
;

9412 
ç
:

9413 
	`bŒfs_de¡roy_ÿch•
();

9414  -
ENOMEM
;

9415 
	}
}

9417 
	$bŒfs_g‘©Œ
(
mÁ_idm­
 *
idm­
,

9418 cÚ¡ 
·th
 *·th, 
k¡©
 *
¡©
,

9419 
u32
 
»que¡_mask
, 
æags
)

9422 
u64
 
d–®loc_by‹s
;

9423 
u64
 
šode_by‹s
;

9425 
šode
 *šodğ
	`d_šode
(
·th
->
d’Œy
);

9426 
u32
 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

9429 
	`´štk
(
KERN_INFO
 "bŒfs_g‘©Œ: C®Ëd w™h inodoàfs_id %d...\n", 
šode
->
fs_id
);

9431 
u32
 
bi_æags
 = 
	`BTRFS_I
(
šode
)->
æags
;

9432 
u32
 
bi_ro_æags
 = 
	`BTRFS_I
(
šode
)->
ro_æags
;

9434 
¡©
->
»suÉ_mask
 |ğ
STATX_BTIME
;

9435 
¡©
->
btime
.
tv_£c
 = 
	`BTRFS_I
(
šode
)->
i_Ùime
.tv_sec;

9436 
¡©
->
btime
.
tv_n£c
 = 
	`BTRFS_I
(
šode
)->
i_Ùime
.tv_nsec;

9437 ià(
bi_æags
 & 
BTRFS_INODE_APPEND
)

9438 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_APPEND
;

9439 ià(
bi_æags
 & 
BTRFS_INODE_COMPRESS
)

9440 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_COMPRESSED
;

9441 ià(
bi_æags
 & 
BTRFS_INODE_IMMUTABLE
)

9442 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_IMMUTABLE
;

9443 ià(
bi_æags
 & 
BTRFS_INODE_NODUMP
)

9444 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_NODUMP
;

9445 ià(
bi_ro_æags
 & 
BTRFS_INODE_RO_VERITY
)

9446 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_VERITY
;

9448 
¡©
->
©Œibu‹s_mask
 |ğ(
STATX_ATTR_APPEND
 |

9449 
STATX_ATTR_COMPRESSED
 |

9450 
STATX_ATTR_IMMUTABLE
 |

9451 
STATX_ATTR_NODUMP
);

9453 
	`g’”ic_fÏ‰r
(
idm­
, 
»que¡_mask
, 
šode
, 
¡©
);

9454 
¡©
->
dev
 = 
	`BTRFS_I
(
šode
)->
roÙ
->
ªÚ_dev
;

9456 
	`¥š_lock
(&
	`BTRFS_I
(
šode
)->
lock
);

9457 
d–®loc_by‹s
 = 
	`BTRFS_I
(
šode
)->
Ãw_d–®loc_by‹s
;

9458 
šode_by‹s
 = 
	`šode_g‘_by‹s
(
šode
);

9459 
	`¥š_uÆock
(&
	`BTRFS_I
(
šode
)->
lock
);

9460 
¡©
->
blocks
 = (
	`ALIGN
(
šode_by‹s
, 
blocksize
) +

9461 
	`ALIGN
(
d–®loc_by‹s
, 
blocksize
)è>> 
SECTOR_SHIFT
;

9463 
	}
}

9465 
	$bŒfs_»Çme_exchªge
(
šode
 *
Şd_dœ
,

9466 
d’Œy
 *
Şd_d’Œy
,

9467 
šode
 *
Ãw_dœ
,

9468 
d’Œy
 *
Ãw_d’Œy
)

9470 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
Şd_dœ
->
i_sb
);

9471 
bŒfs_Œªs_hªdË
 *
Œªs
;

9472 
Œªs_num_™ems
;

9473 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
Şd_dœ
)->root;

9474 
bŒfs_roÙ
 *
de¡
 = 
	`BTRFS_I
(
Ãw_dœ
)->
roÙ
;

9475 
šode
 *
Ãw_šode
 = 
Ãw_d’Œy
->
d_šode
;

9476 
šode
 *
Şd_šode
 = 
Şd_d’Œy
->
d_šode
;

9477 
bŒfs_»Çme_ùx
 
Şd_»Çme_ùx
;

9478 
bŒfs_»Çme_ùx
 
Ãw_»Çme_ùx
;

9479 
u64
 
Şd_šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
Şd_šode
));

9480 
u64
 
Ãw_šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
Ãw_šode
));

9481 
u64
 
Şd_idx
 = 0;

9482 
u64
 
Ãw_idx
 = 0;

9483 
»t
;

9484 
»t2
;

9485 
boŞ
 
Ãed_abÜt
 = 
çl£
;

9486 
fsüy±_Çme
 
Şd_âame
, 
Ãw_âame
;

9487 
fsüy±_¡r
 *
Şd_Çme
, *
Ãw_Çme
;

9494 ià(
roÙ
 !ğ
de¡
 &&

9495 (
Şd_šo
 !ğ
BTRFS_FIRST_FREE_OBJECTID
 ||

9496 
Ãw_šo
 !ğ
BTRFS_FIRST_FREE_OBJECTID
))

9497  -
EXDEV
;

9499 
»t
 = 
	`fsüy±_£tup_f’ame
(
Şd_dœ
, &
Şd_d’Œy
->
d_Çme
, 0, &
Şd_âame
);

9500 ià(
»t
)

9501  
»t
;

9503 
»t
 = 
	`fsüy±_£tup_f’ame
(
Ãw_dœ
, &
Ãw_d’Œy
->
d_Çme
, 0, &
Ãw_âame
);

9504 ià(
»t
) {

9505 
	`fsüy±_ä“_f’ame
(&
Şd_âame
);

9506  
»t
;

9509 
Şd_Çme
 = &
Şd_âame
.
disk_Çme
;

9510 
Ãw_Çme
 = &
Ãw_âame
.
disk_Çme
;

9513 ià(
Şd_šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
 ||

9514 
Ãw_šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
)

9515 
	`down_»ad
(&
fs_šfo
->
subvŞ_£m
);

9527 
Œªs_num_™ems
 = (
Şd_dœ
 =ğ
Ãw_dœ
 ? 9 : 10);

9528 ià(
Şd_šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
) {

9535 
Œªs_num_™ems
 += 4;

9542 
Œªs_num_™ems
 += 3;

9544 ià(
Ãw_šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
)

9545 
Œªs_num_™ems
 += 4;

9547 
Œªs_num_™ems
 += 3;

9548 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 
Œªs_num_™ems
);

9549 ià(
	`IS_ERR
(
Œªs
)) {

9550 
»t
 = 
	`PTR_ERR
(
Œªs
);

9551 
out_nÙ¿ns
;

9554 ià(
de¡
 !ğ
roÙ
) {

9555 
»t
 = 
	`bŒfs_»cÜd_roÙ_š_Œªs
(
Œªs
, 
de¡
);

9556 ià(
»t
)

9557 
out_ç
;

9564 
»t
 = 
	`bŒfs_£t_šode_šdex
(
	`BTRFS_I
(
Ãw_dœ
), &
Şd_idx
);

9565 ià(
»t
)

9566 
out_ç
;

9567 
»t
 = 
	`bŒfs_£t_šode_šdex
(
	`BTRFS_I
(
Şd_dœ
), &
Ãw_idx
);

9568 ià(
»t
)

9569 
out_ç
;

9571 
	`BTRFS_I
(
Şd_šode
)->
dœ_šdex
 = 0ULL;

9572 
	`BTRFS_I
(
Ãw_šode
)->
dœ_šdex
 = 0ULL;

9575 ià(
Şd_šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
) {

9577 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

9579 
»t
 = 
	`bŒfs_š£¹_šode_»f
(
Œªs
, 
de¡
, 
Ãw_Çme
, 
Şd_šo
,

9580 
	`bŒfs_šo
(
	`BTRFS_I
(
Ãw_dœ
)),

9581 
Şd_idx
);

9582 ià(
»t
)

9583 
out_ç
;

9584 
Ãed_abÜt
 = 
Œue
;

9588 ià(
Ãw_šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
) {

9590 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

9592 
»t
 = 
	`bŒfs_š£¹_šode_»f
(
Œªs
, 
roÙ
, 
Şd_Çme
, 
Ãw_šo
,

9593 
	`bŒfs_šo
(
	`BTRFS_I
(
Şd_dœ
)),

9594 
Ãw_idx
);

9595 ià(
»t
) {

9596 ià(
Ãed_abÜt
)

9597 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

9598 
out_ç
;

9603 
	`šode_šc_iv”siÚ
(
Şd_dœ
);

9604 
	`šode_šc_iv”siÚ
(
Ãw_dœ
);

9605 
	`šode_šc_iv”siÚ
(
Şd_šode
);

9606 
	`šode_šc_iv”siÚ
(
Ãw_šode
);

9607 
	`sim¶e_»Çme_time¡amp
(
Şd_dœ
, 
Şd_d’Œy
, 
Ãw_dœ
, 
Ãw_d’Œy
);

9609 ià(
Şd_d’Œy
->
d_·»Á
 !ğ
Ãw_d’Œy
->d_parent) {

9610 
	`bŒfs_»cÜd_uÆšk_dœ
(
Œªs
, 
	`BTRFS_I
(
Şd_dœ
),

9611 
	`BTRFS_I
(
Şd_šode
), 
Œue
);

9612 
	`bŒfs_»cÜd_uÆšk_dœ
(
Œªs
, 
	`BTRFS_I
(
Ãw_dœ
),

9613 
	`BTRFS_I
(
Ãw_šode
), 
Œue
);

9617 ià(
Şd_šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
) {

9618 
»t
 = 
	`bŒfs_uÆšk_subvŞ
(
Œªs
, 
	`BTRFS_I
(
Şd_dœ
), 
Şd_d’Œy
);

9620 
»t
 = 
	`__bŒfs_uÆšk_šode
(
Œªs
, 
	`BTRFS_I
(
Şd_dœ
),

9621 
	`BTRFS_I
(
Şd_d’Œy
->
d_šode
),

9622 
Şd_Çme
, &
Şd_»Çme_ùx
);

9623 ià(!
»t
)

9624 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
Şd_šode
));

9626 ià(
»t
) {

9627 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

9628 
out_ç
;

9632 ià(
Ãw_šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
) {

9633 
»t
 = 
	`bŒfs_uÆšk_subvŞ
(
Œªs
, 
	`BTRFS_I
(
Ãw_dœ
), 
Ãw_d’Œy
);

9635 
»t
 = 
	`__bŒfs_uÆšk_šode
(
Œªs
, 
	`BTRFS_I
(
Ãw_dœ
),

9636 
	`BTRFS_I
(
Ãw_d’Œy
->
d_šode
),

9637 
Ãw_Çme
, &
Ãw_»Çme_ùx
);

9638 ià(!
»t
)

9639 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
de¡
, 
	`BTRFS_I
(
Ãw_šode
));

9641 ià(
»t
) {

9642 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

9643 
out_ç
;

9646 
»t
 = 
	`bŒfs_add_lšk
(
Œªs
, 
	`BTRFS_I
(
Ãw_dœ
), BTRFS_I(
Şd_šode
),

9647 
Ãw_Çme
, 0, 
Şd_idx
);

9648 ià(
»t
) {

9649 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

9650 
out_ç
;

9653 
»t
 = 
	`bŒfs_add_lšk
(
Œªs
, 
	`BTRFS_I
(
Şd_dœ
), BTRFS_I(
Ãw_šode
),

9654 
Şd_Çme
, 0, 
Ãw_idx
);

9655 ià(
»t
) {

9656 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

9657 
out_ç
;

9660 ià(
Şd_šode
->
i_Æšk
 == 1)

9661 
	`BTRFS_I
(
Şd_šode
)->
dœ_šdex
 = 
Şd_idx
;

9662 ià(
Ãw_šode
->
i_Æšk
 == 1)

9663 
	`BTRFS_I
(
Ãw_šode
)->
dœ_šdex
 = 
Ãw_idx
;

9671 ià(
Şd_šo
 !ğ
BTRFS_FIRST_FREE_OBJECTID
)

9672 
	`bŒfs_pš_log_Œªs
(
roÙ
);

9673 ià(
Ãw_šo
 !ğ
BTRFS_FIRST_FREE_OBJECTID
)

9674 
	`bŒfs_pš_log_Œªs
(
de¡
);

9677 ià(
Şd_šo
 !ğ
BTRFS_FIRST_FREE_OBJECTID
)

9678 
	`bŒfs_log_Ãw_Çme
(
Œªs
, 
Şd_d’Œy
, 
	`BTRFS_I
(
Şd_dœ
),

9679 
Şd_»Çme_ùx
.
šdex
, 
Ãw_d’Œy
->
d_·»Á
);

9680 ià(
Ãw_šo
 !ğ
BTRFS_FIRST_FREE_OBJECTID
)

9681 
	`bŒfs_log_Ãw_Çme
(
Œªs
, 
Ãw_d’Œy
, 
	`BTRFS_I
(
Ãw_dœ
),

9682 
Ãw_»Çme_ùx
.
šdex
, 
Şd_d’Œy
->
d_·»Á
);

9685 ià(
Şd_šo
 !ğ
BTRFS_FIRST_FREE_OBJECTID
)

9686 
	`bŒfs_’d_log_Œªs
(
roÙ
);

9687 ià(
Ãw_šo
 !ğ
BTRFS_FIRST_FREE_OBJECTID
)

9688 
	`bŒfs_’d_log_Œªs
(
de¡
);

9689 
out_ç
:

9690 
»t2
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

9691 
»t
 =„‘ ?„‘ : 
»t2
;

9692 
out_nÙ¿ns
:

9693 ià(
Ãw_šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
 ||

9694 
Şd_šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
)

9695 
	`up_»ad
(&
fs_šfo
->
subvŞ_£m
);

9697 
	`fsüy±_ä“_f’ame
(&
Ãw_âame
);

9698 
	`fsüy±_ä“_f’ame
(&
Şd_âame
);

9699  
»t
;

9700 
	}
}

9702 
šode
 *
	$Ãw_wh™eout_šode
(
mÁ_idm­
 *
idm­
,

9703 
šode
 *
dœ
)

9705 
šode
 *inode;

9707 
šode
 = 
	`Ãw_šode
(
dœ
->
i_sb
);

9708 ià(
šode
) {

9709 
	`šode_š™_owÃr
(
idm­
, 
šode
, 
dœ
,

9710 
S_IFCHR
 | 
WHITEOUT_MODE
);

9711 
šode
->
i_İ
 = &
bŒfs_¥ecŸl_šode_İ”©iÚs
;

9712 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
, 
WHITEOUT_DEV
);

9714  
šode
;

9715 
	}
}

9717 
	$bŒfs_»Çme
(
mÁ_idm­
 *
idm­
,

9718 
šode
 *
Şd_dœ
, 
d’Œy
 *
Şd_d’Œy
,

9719 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
,

9720 
æags
)

9722 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
Şd_dœ
->
i_sb
);

9723 
bŒfs_Ãw_šode_¬gs
 
wh™eout_¬gs
 = {

9724 .
dœ
 = 
Şd_dœ
,

9725 .
d’Œy
 = 
Şd_d’Œy
,

9727 
bŒfs_Œªs_hªdË
 *
Œªs
;

9728 
Œªs_num_™ems
;

9729 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
Şd_dœ
)->root;

9730 
bŒfs_roÙ
 *
de¡
 = 
	`BTRFS_I
(
Ãw_dœ
)->
roÙ
;

9731 
šode
 *
Ãw_šode
 = 
	`d_šode
(
Ãw_d’Œy
);

9732 
šode
 *
Şd_šode
 = 
	`d_šode
(
Şd_d’Œy
);

9733 
bŒfs_»Çme_ùx
 
»Çme_ùx
;

9734 
u64
 
šdex
 = 0;

9735 
»t
;

9736 
»t2
;

9737 
u64
 
Şd_šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
Şd_šode
));

9738 
fsüy±_Çme
 
Şd_âame
, 
Ãw_âame
;

9740 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
Ãw_dœ
)è=ğ
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
)

9741  -
EPERM
;

9744 ià(
Şd_šo
 !ğ
BTRFS_FIRST_FREE_OBJECTID
 && 
roÙ
 !ğ
de¡
)

9745  -
EXDEV
;

9747 ià(
Şd_šo
 =ğ
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
 ||

9748 (
Ãw_šode
 && 
	`bŒfs_šo
(
	`BTRFS_I
Òew_šode)è=ğ
BTRFS_FIRST_FREE_OBJECTID
))

9749  -
ENOTEMPTY
;

9751 ià(
	`S_ISDIR
(
Şd_šode
->
i_mode
è&& 
Ãw_šode
 &&

9752 
Ãw_šode
->
i_size
 > 
BTRFS_EMPTY_DIR_SIZE
)

9753  -
ENOTEMPTY
;

9755 
»t
 = 
	`fsüy±_£tup_f’ame
(
Şd_dœ
, &
Şd_d’Œy
->
d_Çme
, 0, &
Şd_âame
);

9756 ià(
»t
)

9757  
»t
;

9759 
»t
 = 
	`fsüy±_£tup_f’ame
(
Ãw_dœ
, &
Ãw_d’Œy
->
d_Çme
, 0, &
Ãw_âame
);

9760 ià(
»t
) {

9761 
	`fsüy±_ä“_f’ame
(&
Şd_âame
);

9762  
»t
;

9766 
»t
 = 
	`bŒfs_check_dœ_™em_cŞlisiÚ
(
de¡
, 
Ãw_dœ
->
i_šo
, &
Ãw_âame
.
disk_Çme
);

9767 ià(
»t
) {

9768 ià(
»t
 =ğ-
EEXIST
) {

9771 ià(
	`WARN_ON
(!
Ãw_šode
)) {

9772 
out_fsüy±_Çmes
;

9776 
out_fsüy±_Çmes
;

9779 
»t
 = 0;

9785 ià(
Ãw_šode
 && 
	`S_ISREG
(
Şd_šode
->
i_mode
è&&‚ew_šode->
i_size
)

9786 
	`fem­_æush
(
Şd_šode
->
i_m­pšg
);

9788 ià(
æags
 & 
RENAME_WHITEOUT
) {

9789 
wh™eout_¬gs
.
šode
 = 
	`Ãw_wh™eout_šode
(
idm­
, 
Şd_dœ
);

9790 ià(!
wh™eout_¬gs
.
šode
) {

9791 
»t
 = -
ENOMEM
;

9792 
out_fsüy±_Çmes
;

9794 
»t
 = 
	`bŒfs_Ãw_šode_´•¬e
(&
wh™eout_¬gs
, &
Œªs_num_™ems
);

9795 ià(
»t
)

9796 
out_wh™eout_šode
;

9799 
Œªs_num_™ems
 = 1;

9802 ià(
Şd_šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
) {

9804 
	`down_»ad
(&
fs_šfo
->
subvŞ_£m
);

9811 
Œªs_num_™ems
 += 4;

9818 
Œªs_num_™ems
 += 3;

9826 
Œªs_num_™ems
 += 4;

9828 ià(
Ãw_dœ
 !ğ
Şd_dœ
)

9829 
Œªs_num_™ems
++;

9830 ià(
Ãw_šode
) {

9838 
Œªs_num_™ems
 += 5;

9840 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 
Œªs_num_™ems
);

9841 ià(
	`IS_ERR
(
Œªs
)) {

9842 
»t
 = 
	`PTR_ERR
(
Œªs
);

9843 
out_nÙ¿ns
;

9846 ià(
de¡
 !ğ
roÙ
) {

9847 
»t
 = 
	`bŒfs_»cÜd_roÙ_š_Œªs
(
Œªs
, 
de¡
);

9848 ià(
»t
)

9849 
out_ç
;

9852 
»t
 = 
	`bŒfs_£t_šode_šdex
(
	`BTRFS_I
(
Ãw_dœ
), &
šdex
);

9853 ià(
»t
)

9854 
out_ç
;

9856 
	`BTRFS_I
(
Şd_šode
)->
dœ_šdex
 = 0ULL;

9857 ià(
	`uÆik–y
(
Şd_šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
)) {

9859 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

9861 
»t
 = 
	`bŒfs_š£¹_šode_»f
(
Œªs
, 
de¡
, &
Ãw_âame
.
disk_Çme
,

9862 
Şd_šo
, 
	`bŒfs_šo
(
	`BTRFS_I
(
Ãw_dœ
)),

9863 
šdex
);

9864 ià(
»t
)

9865 
out_ç
;

9868 
	`šode_šc_iv”siÚ
(
Şd_dœ
);

9869 
	`šode_šc_iv”siÚ
(
Ãw_dœ
);

9870 
	`šode_šc_iv”siÚ
(
Şd_šode
);

9871 
	`sim¶e_»Çme_time¡amp
(
Şd_dœ
, 
Şd_d’Œy
, 
Ãw_dœ
, 
Ãw_d’Œy
);

9873 ià(
Şd_d’Œy
->
d_·»Á
 !ğ
Ãw_d’Œy
->d_parent)

9874 
	`bŒfs_»cÜd_uÆšk_dœ
(
Œªs
, 
	`BTRFS_I
(
Şd_dœ
),

9875 
	`BTRFS_I
(
Şd_šode
), 
Œue
);

9877 ià(
	`uÆik–y
(
Şd_šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
)) {

9878 
»t
 = 
	`bŒfs_uÆšk_subvŞ
(
Œªs
, 
	`BTRFS_I
(
Şd_dœ
), 
Şd_d’Œy
);

9880 
»t
 = 
	`__bŒfs_uÆšk_šode
(
Œªs
, 
	`BTRFS_I
(
Şd_dœ
),

9881 
	`BTRFS_I
(
	`d_šode
(
Şd_d’Œy
)),

9882 &
Şd_âame
.
disk_Çme
, &
»Çme_ùx
);

9883 ià(!
»t
)

9884 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
Şd_šode
));

9886 ià(
»t
) {

9887 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

9888 
out_ç
;

9891 ià(
Ãw_šode
) {

9892 
	`šode_šc_iv”siÚ
(
Ãw_šode
);

9893 ià(
	`uÆik–y
(
	`bŒfs_šo
(
	`BTRFS_I
(
Ãw_šode
)) ==

9894 
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
)) {

9895 
»t
 = 
	`bŒfs_uÆšk_subvŞ
(
Œªs
, 
	`BTRFS_I
(
Ãw_dœ
), 
Ãw_d’Œy
);

9896 
	`BUG_ON
(
Ãw_šode
->
i_Æšk
 == 0);

9898 
»t
 = 
	`bŒfs_uÆšk_šode
(
Œªs
, 
	`BTRFS_I
(
Ãw_dœ
),

9899 
	`BTRFS_I
(
	`d_šode
(
Ãw_d’Œy
)),

9900 &
Ãw_âame
.
disk_Çme
);

9902 ià(!
»t
 && 
Ãw_šode
->
i_Æšk
 == 0)

9903 
»t
 = 
	`bŒfs_Üphª_add
(
Œªs
,

9904 
	`BTRFS_I
(
	`d_šode
(
Ãw_d’Œy
)));

9905 ià(
»t
) {

9906 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

9907 
out_ç
;

9911 
»t
 = 
	`bŒfs_add_lšk
(
Œªs
, 
	`BTRFS_I
(
Ãw_dœ
), BTRFS_I(
Şd_šode
),

9912 &
Ãw_âame
.
disk_Çme
, 0, 
šdex
);

9913 ià(
»t
) {

9914 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

9915 
out_ç
;

9918 ià(
Şd_šode
->
i_Æšk
 == 1)

9919 
	`BTRFS_I
(
Şd_šode
)->
dœ_šdex
 = 
šdex
;

9921 ià(
Şd_šo
 !ğ
BTRFS_FIRST_FREE_OBJECTID
)

9922 
	`bŒfs_log_Ãw_Çme
(
Œªs
, 
Şd_d’Œy
, 
	`BTRFS_I
(
Şd_dœ
),

9923 
»Çme_ùx
.
šdex
, 
Ãw_d’Œy
->
d_·»Á
);

9925 ià(
æags
 & 
RENAME_WHITEOUT
) {

9926 
»t
 = 
	`bŒfs_ü—‹_Ãw_šode
(
Œªs
, &
wh™eout_¬gs
);

9927 ià(
»t
) {

9928 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

9929 
out_ç
;

9931 
	`uÆock_Ãw_šode
(
wh™eout_¬gs
.
šode
);

9932 
	`ut
(
wh™eout_¬gs
.
šode
);

9933 
wh™eout_¬gs
.
šode
 = 
NULL
;

9936 
out_ç
:

9937 
»t2
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

9938 
»t
 =„‘ ?„‘ : 
»t2
;

9939 
out_nÙ¿ns
:

9940 ià(
Şd_šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
)

9941 
	`up_»ad
(&
fs_šfo
->
subvŞ_£m
);

9942 ià(
æags
 & 
RENAME_WHITEOUT
)

9943 
	`bŒfs_Ãw_šode_¬gs_de¡roy
(&
wh™eout_¬gs
);

9944 
out_wh™eout_šode
:

9945 ià(
æags
 & 
RENAME_WHITEOUT
)

9946 
	`ut
(
wh™eout_¬gs
.
šode
);

9947 
out_fsüy±_Çmes
:

9948 
	`fsüy±_ä“_f’ame
(&
Şd_âame
);

9949 
	`fsüy±_ä“_f’ame
(&
Ãw_âame
);

9950  
»t
;

9951 
	}
}

9953 
	$bŒfs_»Çme2
(
mÁ_idm­
 *
idm­
, 
šode
 *
Şd_dœ
,

9954 
d’Œy
 *
Şd_d’Œy
, 
šode
 *
Ãw_dœ
,

9955 
d’Œy
 *
Ãw_d’Œy
, 
æags
)

9957 
»t
;

9959 ià(
æags
 & ~(
RENAME_NOREPLACE
 | 
RENAME_EXCHANGE
 | 
RENAME_WHITEOUT
))

9960  -
EINVAL
;

9962 ià(
æags
 & 
RENAME_EXCHANGE
)

9963 
»t
 = 
	`bŒfs_»Çme_exchªge
(
Şd_dœ
, 
Şd_d’Œy
, 
Ãw_dœ
,

9964 
Ãw_d’Œy
);

9966 
»t
 = 
	`bŒfs_»Çme
(
idm­
, 
Şd_dœ
, 
Şd_d’Œy
, 
Ãw_dœ
,

9967 
Ãw_d’Œy
, 
æags
);

9969 
	`bŒfs_bŒ“_b®ªû_dœty
(
	`BTRFS_I
(
Ãw_dœ
)->
roÙ
->
fs_šfo
);

9971  
»t
;

9972 
	}
}

9974 
	sbŒfs_d–®loc_wÜk
 {

9975 
šode
 *
	mšode
;

9976 
com¶‘iÚ
 
	mcom¶‘iÚ
;

9977 
li¡_h—d
 
	mli¡
;

9978 
bŒfs_wÜk
 
	mwÜk
;

9981 
	$bŒfs_run_d–®loc_wÜk
(
bŒfs_wÜk
 *
wÜk
)

9983 
bŒfs_d–®loc_wÜk
 *
d–®loc_wÜk
;

9984 
šode
 *inode;

9986 
d–®loc_wÜk
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_d–®loc_wÜk
,

9987 
wÜk
);

9988 
šode
 = 
d–®loc_wÜk
->inode;

9989 
	`fem­_æush
(
šode
->
i_m­pšg
);

9990 ià(
	`‹¡_b™
(
BTRFS_INODE_HAS_ASYNC_EXTENT
,

9991 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
))

9992 
	`fem­_æush
(
šode
->
i_m­pšg
);

9994 
	`ut
(
šode
);

9995 
	`com¶‘e
(&
d–®loc_wÜk
->
com¶‘iÚ
);

9996 
	}
}

9998 
bŒfs_d–®loc_wÜk
 *
	$bŒfs_®loc_d–®loc_wÜk
(
šode
 *inode)

10000 
bŒfs_d–®loc_wÜk
 *
wÜk
;

10002 
wÜk
 = 
	`km®loc
((*wÜk), 
GFP_NOFS
);

10003 ià(!
wÜk
)

10004  
NULL
;

10006 
	`š™_com¶‘iÚ
(&
wÜk
->
com¶‘iÚ
);

10007 
	`INIT_LIST_HEAD
(&
wÜk
->
li¡
);

10008 
wÜk
->
šode
 = inode;

10009 
	`bŒfs_š™_wÜk
(&
wÜk
->wÜk, 
bŒfs_run_d–®loc_wÜk
, 
NULL
, NULL);

10011  
wÜk
;

10012 
	}
}

10018 
	$¡¬t_d–®loc_šodes
(
bŒfs_roÙ
 *
roÙ
,

10019 
wr™eback_cÚŒŞ
 *
wbc
, 
boŞ
 
¢­shÙ
,

10020 
boŞ
 
š_»şaim_cÚ‹xt
)

10022 
bŒfs_šode
 *
bšode
;

10023 
šode
 *inode;

10024 
bŒfs_d–®loc_wÜk
 *
wÜk
, *
Ãxt
;

10025 
	`LIST_HEAD
(
wÜks
);

10026 
	`LIST_HEAD
(
¥liû
);

10027 
»t
 = 0;

10028 
boŞ
 
fuÎ_æush
 = 
wbc
->
Ä_to_wr™e
 =ğ
LONG_MAX
;

10030 
	`mu‹x_lock
(&
roÙ
->
d–®loc_mu‹x
);

10031 
	`¥š_lock
(&
roÙ
->
d–®loc_lock
);

10032 
	`li¡_¥liû_š™
(&
roÙ
->
d–®loc_šodes
, &
¥liû
);

10033 !
	`li¡_em±y
(&
¥liû
)) {

10034 
bšode
 = 
	`li¡_’Œy
(
¥liû
.
Ãxt
, 
bŒfs_šode
,

10035 
d–®loc_šodes
);

10037 
	`li¡_move_
(&
bšode
->
d–®loc_šodes
,

10038 &
roÙ
->
d–®loc_šodes
);

10040 ià(
š_»şaim_cÚ‹xt
 &&

10041 
	`‹¡_b™
(
BTRFS_INODE_NO_DELALLOC_FLUSH
, &
bšode
->
ruÁime_æags
))

10044 
šode
 = 
	`ig¿b
(&
bšode
->
vfs_šode
);

10045 ià(!
šode
) {

10046 
	`cÚd_»sched_lock
(&
roÙ
->
d–®loc_lock
);

10049 
	`¥š_uÆock
(&
roÙ
->
d–®loc_lock
);

10051 ià(
¢­shÙ
)

10052 
	`£t_b™
(
BTRFS_INODE_SNAPSHOT_FLUSH
,

10053 &
bšode
->
ruÁime_æags
);

10054 ià(
fuÎ_æush
) {

10055 
wÜk
 = 
	`bŒfs_®loc_d–®loc_wÜk
(
šode
);

10056 ià(!
wÜk
) {

10057 
	`ut
(
šode
);

10058 
»t
 = -
ENOMEM
;

10059 
out
;

10061 
	`li¡_add_
(&
wÜk
->
li¡
, &
wÜks
);

10062 
	`bŒfs_queue_wÜk
(
roÙ
->
fs_šfo
->
æush_wÜk”s
,

10063 &
wÜk
->work);

10065 
»t
 = 
	`fem­_fd©awr™e_wbc
(
šode
->
i_m­pšg
, 
wbc
);

10066 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
šode
));

10067 ià(
»t
 || 
wbc
->
Ä_to_wr™e
 <= 0)

10068 
out
;

10070 
	`cÚd_»sched
();

10071 
	`¥š_lock
(&
roÙ
->
d–®loc_lock
);

10073 
	`¥š_uÆock
(&
roÙ
->
d–®loc_lock
);

10075 
out
:

10076 
	`li¡_fÜ_—ch_’Œy_§ã
(
wÜk
, 
Ãxt
, &
wÜks
, 
li¡
) {

10077 
	`li¡_d–_š™
(&
wÜk
->
li¡
);

10078 
	`wa™_fÜ_com¶‘iÚ
(&
wÜk
->
com¶‘iÚ
);

10079 
	`kä“
(
wÜk
);

10082 ià(!
	`li¡_em±y
(&
¥liû
)) {

10083 
	`¥š_lock
(&
roÙ
->
d–®loc_lock
);

10084 
	`li¡_¥liû_
(&
¥liû
, &
roÙ
->
d–®loc_šodes
);

10085 
	`¥š_uÆock
(&
roÙ
->
d–®loc_lock
);

10087 
	`mu‹x_uÆock
(&
roÙ
->
d–®loc_mu‹x
);

10088  
»t
;

10089 
	}
}

10091 
	$bŒfs_¡¬t_d–®loc_¢­shÙ
(
bŒfs_roÙ
 *
roÙ
, 
boŞ
 
š_»şaim_cÚ‹xt
)

10093 
wr™eback_cÚŒŞ
 
wbc
 = {

10094 .
Ä_to_wr™e
 = 
LONG_MAX
,

10095 .
sync_mode
 = 
WB_SYNC_NONE
,

10096 .
¿nge_¡¬t
 = 0,

10097 .
¿nge_’d
 = 
LLONG_MAX
,

10099 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

10101 ià(
	`BTRFS_FS_ERROR
(
fs_šfo
))

10102  -
EROFS
;

10104  
	`¡¬t_d–®loc_šodes
(
roÙ
, &
wbc
, 
Œue
, 
š_»şaim_cÚ‹xt
);

10105 
	}
}

10107 
	$bŒfs_¡¬t_d–®loc_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
Ä
,

10108 
boŞ
 
š_»şaim_cÚ‹xt
)

10110 
wr™eback_cÚŒŞ
 
wbc
 = {

10111 .
Ä_to_wr™e
 = 
Ä
,

10112 .
sync_mode
 = 
WB_SYNC_NONE
,

10113 .
¿nge_¡¬t
 = 0,

10114 .
¿nge_’d
 = 
LLONG_MAX
,

10116 
bŒfs_roÙ
 *
roÙ
;

10117 
	`LIST_HEAD
(
¥liû
);

10118 
»t
;

10120 ià(
	`BTRFS_FS_ERROR
(
fs_šfo
))

10121  -
EROFS
;

10123 
	`mu‹x_lock
(&
fs_šfo
->
d–®loc_roÙ_mu‹x
);

10124 
	`¥š_lock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

10125 
	`li¡_¥liû_š™
(&
fs_šfo
->
d–®loc_roÙs
, &
¥liû
);

10126 !
	`li¡_em±y
(&
¥liû
)) {

10131 ià(
Ä
 =ğ
LONG_MAX
)

10132 
wbc
.
Ä_to_wr™e
 = 
LONG_MAX
;

10134 
roÙ
 = 
	`li¡_fœ¡_’Œy
(&
¥liû
, 
bŒfs_roÙ
,

10135 
d–®loc_roÙ
);

10136 
roÙ
 = 
	`bŒfs_g¿b_roÙ
(root);

10137 
	`BUG_ON
(!
roÙ
);

10138 
	`li¡_move_
(&
roÙ
->
d–®loc_roÙ
,

10139 &
fs_šfo
->
d–®loc_roÙs
);

10140 
	`¥š_uÆock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

10142 
»t
 = 
	`¡¬t_d–®loc_šodes
(
roÙ
, &
wbc
, 
çl£
, 
š_»şaim_cÚ‹xt
);

10143 
	`bŒfs_put_roÙ
(
roÙ
);

10144 ià(
»t
 < 0 || 
wbc
.
Ä_to_wr™e
 <= 0)

10145 
out
;

10146 
	`¥š_lock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

10148 
	`¥š_uÆock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

10150 
»t
 = 0;

10151 
out
:

10152 ià(!
	`li¡_em±y
(&
¥liû
)) {

10153 
	`¥š_lock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

10154 
	`li¡_¥liû_
(&
¥liû
, &
fs_šfo
->
d–®loc_roÙs
);

10155 
	`¥š_uÆock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

10157 
	`mu‹x_uÆock
(&
fs_šfo
->
d–®loc_roÙ_mu‹x
);

10158  
»t
;

10159 
	}
}

10161 
	$bŒfs_symlšk
(
mÁ_idm­
 *
idm­
, 
šode
 *
dœ
,

10162 
d’Œy
 *d’Œy, cÚ¡ *
symÇme
)

10164 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

10165 
bŒfs_Œªs_hªdË
 *
Œªs
;

10166 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

10167 
bŒfs_·th
 *
·th
;

10168 
bŒfs_key
 
key
;

10169 
šode
 *inode;

10170 
bŒfs_Ãw_šode_¬gs
 
Ãw_šode_¬gs
 = {

10171 .
dœ
 = dir,

10172 .
d’Œy
 = dentry,

10174 
Œªs_num_™ems
;

10175 
”r
;

10176 
Çme_Ën
;

10177 
d©asize
;

10178 
±r
;

10179 
bŒfs_fe_ex‹Á_™em
 *
ei
;

10180 
ex‹Á_bufãr
 *
Ëaf
;

10182 
Çme_Ën
 = 
	`¡¾’
(
symÇme
);

10183 ià(
Çme_Ën
 > 
	`BTRFS_MAX_INLINE_DATA_SIZE
(
fs_šfo
))

10184  -
ENAMETOOLONG
;

10186 
šode
 = 
	`Ãw_šode
(
dœ
->
i_sb
);

10187 ià(!
šode
)

10188  -
ENOMEM
;

10189 
	`šode_š™_owÃr
(
idm­
, 
šode
, 
dœ
, 
S_IFLNK
 | 
S_IRWXUGO
);

10190 
šode
->
i_İ
 = &
bŒfs_symlšk_šode_İ”©iÚs
;

10191 
	`šode_nohighmem
(
šode
);

10192 
šode
->
i_m­pšg
->
a_İs
 = &
bŒfs_aİs
;

10193 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
šode
), 
Çme_Ën
);

10194 
	`šode_£t_by‹s
(
šode
, 
Çme_Ën
);

10196 
Ãw_šode_¬gs
.
šode
 = inode;

10197 
”r
 = 
	`bŒfs_Ãw_šode_´•¬e
(&
Ãw_šode_¬gs
, &
Œªs_num_™ems
);

10198 ià(
”r
)

10199 
out_šode
;

10201 
Œªs_num_™ems
++;

10203 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 
Œªs_num_™ems
);

10204 ià(
	`IS_ERR
(
Œªs
)) {

10205 
”r
 = 
	`PTR_ERR
(
Œªs
);

10206 
out_Ãw_šode_¬gs
;

10209 
”r
 = 
	`bŒfs_ü—‹_Ãw_šode
(
Œªs
, &
Ãw_šode_¬gs
);

10210 ià(
”r
)

10211 
out
;

10213 
·th
 = 
	`bŒfs_®loc_·th
();

10214 ià(!
·th
) {

10215 
”r
 = -
ENOMEM
;

10216 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
”r
);

10217 
	`disÿrd_Ãw_šode
(
šode
);

10218 
šode
 = 
NULL
;

10219 
out
;

10221 
key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

10222 
key
.
off£t
 = 0;

10223 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

10224 
d©asize
 = 
	`bŒfs_fe_ex‹Á_ÿlc_šlše_size
(
Çme_Ën
);

10225 
”r
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

10226 
d©asize
);

10227 ià(
”r
) {

10228 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
”r
);

10229 
	`bŒfs_ä“_·th
(
·th
);

10230 
	`disÿrd_Ãw_šode
(
šode
);

10231 
šode
 = 
NULL
;

10232 
out
;

10234 
Ëaf
 = 
·th
->
nodes
[0];

10235 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

10236 
bŒfs_fe_ex‹Á_™em
);

10237 
	`bŒfs_£t_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
ei
, 
Œªs
->
Œªsid
);

10238 
	`bŒfs_£t_fe_ex‹Á_ty³
(
Ëaf
, 
ei
,

10239 
BTRFS_FILE_EXTENT_INLINE
);

10240 
	`bŒfs_£t_fe_ex‹Á_’üy±iÚ
(
Ëaf
, 
ei
, 0);

10241 
	`bŒfs_£t_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
ei
, 0);

10242 
	`bŒfs_£t_fe_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
ei
, 0);

10243 
	`bŒfs_£t_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
ei
, 
Çme_Ën
);

10245 
±r
 = 
	`bŒfs_fe_ex‹Á_šlše_¡¬t
(
ei
);

10246 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
symÇme
, 
±r
, 
Çme_Ën
);

10247 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

10248 
	`bŒfs_ä“_·th
(
·th
);

10250 
	`d_š¡ªtŸ‹_Ãw
(
d’Œy
, 
šode
);

10251 
”r
 = 0;

10252 
out
:

10253 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

10254 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

10255 
out_Ãw_šode_¬gs
:

10256 
	`bŒfs_Ãw_šode_¬gs_de¡roy
(&
Ãw_šode_¬gs
);

10257 
out_šode
:

10258 ià(
”r
)

10259 
	`ut
(
šode
);

10260  
”r
;

10261 
	}
}

10263 
bŒfs_Œªs_hªdË
 *
	$š£¹_´—Îoc_fe_ex‹Á
(

10264 
bŒfs_Œªs_hªdË
 *
Œªs_š
,

10265 
bŒfs_šode
 *
šode
,

10266 
bŒfs_key
 *
šs
,

10267 
u64
 
fe_off£t
)

10269 
bŒfs_fe_ex‹Á_™em
 
¡ack_fi
;

10270 
bŒfs_»¶aû_ex‹Á_šfo
 
ex‹Á_šfo
;

10271 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
Œªs_š
;

10272 
bŒfs_·th
 *
·th
;

10273 
u64
 
¡¬t
 = 
šs
->
objeùid
;

10274 
u64
 
Ën
 = 
šs
->
off£t
;

10275 
u64
 
qgroup_»Ëa£d
 = 0;

10276 
»t
;

10278 
	`mem£t
(&
¡ack_fi
, 0, (stack_fi));

10280 
	`bŒfs_£t_¡ack_fe_ex‹Á_ty³
(&
¡ack_fi
, 
BTRFS_FILE_EXTENT_PREALLOC
);

10281 
	`bŒfs_£t_¡ack_fe_ex‹Á_disk_by‹Ä
(&
¡ack_fi
, 
¡¬t
);

10282 
	`bŒfs_£t_¡ack_fe_ex‹Á_disk_num_by‹s
(&
¡ack_fi
, 
Ën
);

10283 
	`bŒfs_£t_¡ack_fe_ex‹Á_num_by‹s
(&
¡ack_fi
, 
Ën
);

10284 
	`bŒfs_£t_¡ack_fe_ex‹Á_¿m_by‹s
(&
¡ack_fi
, 
Ën
);

10285 
	`bŒfs_£t_¡ack_fe_ex‹Á_com´essiÚ
(&
¡ack_fi
, 
BTRFS_COMPRESS_NONE
);

10288 
»t
 = 
	`bŒfs_qgroup_»Ëa£_d©a
(
šode
, 
fe_off£t
, 
Ën
, &
qgroup_»Ëa£d
);

10289 ià(
»t
 < 0)

10290  
	`ERR_PTR
(
»t
);

10292 ià(
Œªs
) {

10293 
»t
 = 
	`š£¹_»£rved_fe_ex‹Á
(
Œªs
, 
šode
,

10294 
fe_off£t
, &
¡ack_fi
,

10295 
Œue
, 
qgroup_»Ëa£d
);

10296 ià(
»t
)

10297 
ä“_qgroup
;

10298  
Œªs
;

10301 
ex‹Á_šfo
.
disk_off£t
 = 
¡¬t
;

10302 
ex‹Á_šfo
.
disk_Ën
 = 
Ën
;

10303 
ex‹Á_šfo
.
d©a_off£t
 = 0;

10304 
ex‹Á_šfo
.
d©a_Ën
 = 
Ën
;

10305 
ex‹Á_šfo
.
fe_off£t
 = file_offset;

10306 
ex‹Á_šfo
.
ex‹Á_buf
 = (*)&
¡ack_fi
;

10307 
ex‹Á_šfo
.
is_Ãw_ex‹Á
 = 
Œue
;

10308 
ex‹Á_šfo
.
upd©e_times
 = 
Œue
;

10309 
ex‹Á_šfo
.
qgroup_»£rved
 = 
qgroup_»Ëa£d
;

10310 
ex‹Á_šfo
.
š£¹iÚs
 = 0;

10312 
·th
 = 
	`bŒfs_®loc_·th
();

10313 ià(!
·th
) {

10314 
»t
 = -
ENOMEM
;

10315 
ä“_qgroup
;

10318 
»t
 = 
	`bŒfs_»¶aû_fe_ex‹Ás
(
šode
, 
·th
, 
fe_off£t
,

10319 
fe_off£t
 + 
Ën
 - 1, &
ex‹Á_šfo
,

10320 &
Œªs
);

10321 
	`bŒfs_ä“_·th
(
·th
);

10322 ià(
»t
)

10323 
ä“_qgroup
;

10324  
Œªs
;

10326 
ä“_qgroup
:

10334 
	`bŒfs_qgroup_ä“_»äoÙ
(
šode
->
roÙ
->
fs_šfo
,

10335 
šode
->
roÙ
->
roÙ_key
.
objeùid
, 
qgroup_»Ëa£d
,

10336 
BTRFS_QGROUP_RSV_DATA
);

10337  
	`ERR_PTR
(
»t
);

10338 
	}
}

10340 
	$__bŒfs_´—Îoc_fe_¿nge
(
šode
 *šode, 
mode
,

10341 
u64
 
¡¬t
, u64 
num_by‹s
, u64 
mš_size
,

10342 
loff_t
 
aùu®_Ën
, 
u64
 *
®loc_hšt
,

10343 
bŒfs_Œªs_hªdË
 *
Œªs
)

10345 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

10346 
ex‹Á_m­
 *
em
;

10347 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

10348 
bŒfs_key
 
šs
;

10349 
u64
 
cur_off£t
 = 
¡¬t
;

10350 
u64
 
ş—r_off£t
 = 
¡¬t
;

10351 
u64
 
i_size
;

10352 
u64
 
cur_by‹s
;

10353 
u64
 
Ï¡_®loc
 = (u64)-1;

10354 
»t
 = 0;

10355 
boŞ
 
own_Œªs
 = 
Œue
;

10356 
u64
 
’d
 = 
¡¬t
 + 
num_by‹s
 - 1;

10358 ià(
Œªs
)

10359 
own_Œªs
 = 
çl£
;

10360 
num_by‹s
 > 0) {

10361 
cur_by‹s
 = 
	`mš_t
(
u64
, 
num_by‹s
, 
SZ_256M
);

10362 
cur_by‹s
 = 
	`max
(cur_by‹s, 
mš_size
);

10369 
cur_by‹s
 = 
	`mš
(cur_by‹s, 
Ï¡_®loc
);

10370 
»t
 = 
	`bŒfs_»£rve_ex‹Á
(
roÙ
, 
cur_by‹s
, cur_bytes,

10371 
mš_size
, 0, *
®loc_hšt
, &
šs
, 1, 0);

10372 ià(
»t
)

10382 
ş—r_off£t
 +ğ
šs
.
off£t
;

10384 
Ï¡_®loc
 = 
šs
.
off£t
;

10385 
Œªs
 = 
	`š£¹_´—Îoc_fe_ex‹Á
Ñ¿ns, 
	`BTRFS_I
(
šode
),

10386 &
šs
, 
cur_off£t
);

10393 
	`bŒfs_dec_block_group_»£rv©iÚs
(
fs_šfo
, 
šs
.
objeùid
);

10394 ià(
	`IS_ERR
(
Œªs
)) {

10395 
»t
 = 
	`PTR_ERR
(
Œªs
);

10396 
	`bŒfs_ä“_»£rved_ex‹Á
(
fs_šfo
, 
šs
.
objeùid
,

10397 
šs
.
off£t
, 0);

10401 
em
 = 
	`®loc_ex‹Á_m­
();

10402 ià(!
em
) {

10403 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
	`BTRFS_I
(
šode
), 
cur_off£t
,

10404 
cur_off£t
 + 
šs
.
off£t
 - 1, 
çl£
);

10405 
	`bŒfs_£t_šode_fuÎ_sync
(
	`BTRFS_I
(
šode
));

10406 
Ãxt
;

10409 
em
->
¡¬t
 = 
cur_off£t
;

10410 
em
->
Üig_¡¬t
 = 
cur_off£t
;

10411 
em
->
Ën
 = 
šs
.
off£t
;

10412 
em
->
block_¡¬t
 = 
šs
.
objeùid
;

10413 
em
->
block_Ën
 = 
šs
.
off£t
;

10414 
em
->
Üig_block_Ën
 = 
šs
.
off£t
;

10415 
em
->
¿m_by‹s
 = 
šs
.
off£t
;

10416 
	`£t_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
);

10417 
em
->
g’”©iÚ
 = 
Œªs
->
Œªsid
;

10419 
»t
 = 
	`bŒfs_»¶aû_ex‹Á_m­_¿nge
(
	`BTRFS_I
(
šode
), 
em
, 
Œue
);

10420 
	`ä“_ex‹Á_m­
(
em
);

10421 
Ãxt
:

10422 
num_by‹s
 -ğ
šs
.
off£t
;

10423 
cur_off£t
 +ğ
šs
.
off£t
;

10424 *
®loc_hšt
 = 
šs
.
objeùid
 + ins.
off£t
;

10426 
	`šode_šc_iv”siÚ
(
šode
);

10427 
	`šode_£t_ùime_cu¼’t
(
šode
);

10428 
	`BTRFS_I
(
šode
)->
æags
 |ğ
BTRFS_INODE_PREALLOC
;

10429 ià(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

10430 (
aùu®_Ën
 > 
šode
->
i_size
) &&

10431 (
cur_off£t
 > 
šode
->
i_size
)) {

10432 ià(
cur_off£t
 > 
aùu®_Ën
)

10433 
i_size
 = 
aùu®_Ën
;

10435 
i_size
 = 
cur_off£t
;

10436 
	`i_size_wr™e
(
šode
, 
i_size
);

10437 
	`bŒfs_šode_§ã_disk_i_size_wr™e
(
	`BTRFS_I
(
šode
), 0);

10440 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

10442 ià(
»t
) {

10443 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

10444 ià(
own_Œªs
)

10445 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

10449 ià(
own_Œªs
) {

10450 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

10451 
Œªs
 = 
NULL
;

10454 ià(
ş—r_off£t
 < 
’d
)

10455 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
	`BTRFS_I
(
šode
), 
NULL
, 
ş—r_off£t
,

10456 
’d
 - 
ş—r_off£t
 + 1);

10457  
»t
;

10458 
	}
}

10460 
	$bŒfs_´—Îoc_fe_¿nge
(
šode
 *šode, 
mode
,

10461 
u64
 
¡¬t
, u64 
num_by‹s
, u64 
mš_size
,

10462 
loff_t
 
aùu®_Ën
, 
u64
 *
®loc_hšt
)

10464  
	`__bŒfs_´—Îoc_fe_¿nge
(
šode
, 
mode
, 
¡¬t
, 
num_by‹s
,

10465 
mš_size
, 
aùu®_Ën
, 
®loc_hšt
,

10466 
NULL
);

10467 
	}
}

10469 
	$bŒfs_´—Îoc_fe_¿nge_Œªs
(
šode
 *inode,

10470 
bŒfs_Œªs_hªdË
 *
Œªs
, 
mode
,

10471 
u64
 
¡¬t
, u64 
num_by‹s
, u64 
mš_size
,

10472 
loff_t
 
aùu®_Ën
, 
u64
 *
®loc_hšt
)

10474  
	`__bŒfs_´—Îoc_fe_¿nge
(
šode
, 
mode
, 
¡¬t
, 
num_by‹s
,

10475 
mš_size
, 
aùu®_Ën
, 
®loc_hšt
, 
Œªs
);

10476 
	}
}

10478 
	$bŒfs_³rmissiÚ
(
mÁ_idm­
 *
idm­
,

10479 
šode
 *šode, 
mask
)

10481 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

10482 
umode_t
 
mode
 = 
šode
->
i_mode
;

10484 ià(
mask
 & 
MAY_WRITE
 &&

10485 (
	`S_ISREG
(
mode
è|| 
	`S_ISDIR
(modeè|| 
	`S_ISLNK
(mode))) {

10486 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
))

10487  -
EROFS
;

10488 ià(
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_READONLY
)

10489  -
EACCES
;

10491  
	`g’”ic_³rmissiÚ
(
idm­
, 
šode
, 
mask
);

10492 
	}
}

10494 
	$bŒfs_tmpfe
(
mÁ_idm­
 *
idm­
, 
šode
 *
dœ
,

10495 
fe
 *fe, 
umode_t
 
mode
)

10497 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

10498 
bŒfs_Œªs_hªdË
 *
Œªs
;

10499 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

10500 
šode
 *inode;

10501 
bŒfs_Ãw_šode_¬gs
 
Ãw_šode_¬gs
 = {

10502 .
dœ
 = dir,

10503 .
d’Œy
 = 
fe
->
f_·th
.dentry,

10504 .
Üphª
 = 
Œue
,

10506 
Œªs_num_™ems
;

10507 
»t
;

10509 
šode
 = 
	`Ãw_šode
(
dœ
->
i_sb
);

10510 ià(!
šode
)

10511  -
ENOMEM
;

10512 
	`šode_š™_owÃr
(
idm­
, 
šode
, 
dœ
, 
mode
);

10513 
šode
->
i_fİ
 = &
bŒfs_fe_İ”©iÚs
;

10514 
šode
->
i_İ
 = &
bŒfs_fe_šode_İ”©iÚs
;

10515 
šode
->
i_m­pšg
->
a_İs
 = &
bŒfs_aİs
;

10517 
Ãw_šode_¬gs
.
šode
 = inode;

10518 
»t
 = 
	`bŒfs_Ãw_šode_´•¬e
(&
Ãw_šode_¬gs
, &
Œªs_num_™ems
);

10519 ià(
»t
)

10520 
out_šode
;

10522 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 
Œªs_num_™ems
);

10523 ià(
	`IS_ERR
(
Œªs
)) {

10524 
»t
 = 
	`PTR_ERR
(
Œªs
);

10525 
out_Ãw_šode_¬gs
;

10528 
»t
 = 
	`bŒfs_ü—‹_Ãw_šode
(
Œªs
, &
Ãw_šode_¬gs
);

10537 
	`£t_Æšk
(
šode
, 1);

10539 ià(!
»t
) {

10540 
	`d_tmpfe
(
fe
, 
šode
);

10541 
	`uÆock_Ãw_šode
(
šode
);

10542 
	`m¬k_šode_dœty
(
šode
);

10545 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

10546 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

10547 
out_Ãw_šode_¬gs
:

10548 
	`bŒfs_Ãw_šode_¬gs_de¡roy
(&
Ãw_šode_¬gs
);

10549 
out_šode
:

10550 ià(
»t
)

10551 
	`ut
(
šode
);

10552  
	`fšish_İ’_sim¶e
(
fe
, 
»t
);

10553 
	}
}

10555 
	$bŒfs_£t_¿nge_wr™eback
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
)

10557 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

10558 
šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

10559 
’d_šdex
 = 
’d
 >> 
PAGE_SHIFT
;

10560 
·ge
 *page;

10561 
u32
 
Ën
;

10563 
	`ASSERT
(
’d
 + 1 - 
¡¬t
 <ğ
U32_MAX
);

10564 
Ën
 = 
’d
 + 1 - 
¡¬t
;

10565 
šdex
 <ğ
’d_šdex
) {

10566 
·ge
 = 
	`fšd_g‘_·ge
(
šode
->
vfs_šode
.
i_m­pšg
, 
šdex
);

10567 
	`ASSERT
(
·ge
);

10569 
	`bŒfs_·ge_£t_wr™eback
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

10570 
	`put_·ge
(
·ge
);

10571 
šdex
++;

10573 
	}
}

10575 
	$bŒfs_’coded_io_com´essiÚ_äom_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

10576 
com´ess_ty³
)

10578 
com´ess_ty³
) {

10579 
BTRFS_COMPRESS_NONE
:

10580  
BTRFS_ENCODED_IO_COMPRESSION_NONE
;

10581 
BTRFS_COMPRESS_ZLIB
:

10582  
BTRFS_ENCODED_IO_COMPRESSION_ZLIB
;

10583 
BTRFS_COMPRESS_LZO
:

10588 ià(
fs_šfo
->
£ùÜsize
 < 
SZ_4K
 || fs_šfo->£ùÜsiz> 
SZ_64K
)

10589  -
EINVAL
;

10590  
BTRFS_ENCODED_IO_COMPRESSION_LZO_4K
 +

10591 (
fs_šfo
->
£ùÜsize_b™s
 - 12);

10592 
BTRFS_COMPRESS_ZSTD
:

10593  
BTRFS_ENCODED_IO_COMPRESSION_ZSTD
;

10595  -
EUCLEAN
;

10597 
	}
}

10599 
ssize_t
 
	$bŒfs_’coded_»ad_šlše
(

10600 
kiocb
 *
iocb
,

10601 
iov_™”
 *
™”
, 
u64
 
¡¬t
,

10602 
u64
 
lock’d
,

10603 
ex‹Á_¡©e
 **
ÿched_¡©e
,

10604 
u64
 
ex‹Á_¡¬t
, 
size_t
 
couÁ
,

10605 
bŒfs_ioùl_’coded_io_¬gs
 *
’coded
,

10606 
boŞ
 *
uÆocked
)

10608 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
	`fe_šode
(
iocb
->
ki_fp
));

10609 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

10610 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

10611 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
šode
->io_tree;

10612 
bŒfs_·th
 *
·th
;

10613 
ex‹Á_bufãr
 *
Ëaf
;

10614 
bŒfs_fe_ex‹Á_™em
 *
™em
;

10615 
u64
 
¿m_by‹s
;

10616 
±r
;

10617 *
tmp
;

10618 
ssize_t
 
»t
;

10620 
·th
 = 
	`bŒfs_®loc_·th
();

10621 ià(!
·th
) {

10622 
»t
 = -
ENOMEM
;

10623 
out
;

10625 
»t
 = 
	`bŒfs_lookup_fe_ex‹Á
(
NULL
, 
roÙ
, 
·th
, 
	`bŒfs_šo
(
šode
),

10626 
ex‹Á_¡¬t
, 0);

10627 ià(
»t
) {

10628 ià(
»t
 > 0) {

10630 
»t
 = -
EIO
;

10632 
out
;

10634 
Ëaf
 = 
·th
->
nodes
[0];

10635 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_fe_ex‹Á_™em
);

10637 
¿m_by‹s
 = 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
™em
);

10638 
±r
 = 
	`bŒfs_fe_ex‹Á_šlše_¡¬t
(
™em
);

10640 
’coded
->
Ën
 = 
	`mš_t
(
u64
, 
ex‹Á_¡¬t
 + 
¿m_by‹s
,

10641 
šode
->
vfs_šode
.
i_size
è- 
iocb
->
ki_pos
;

10642 
»t
 = 
	`bŒfs_’coded_io_com´essiÚ_äom_ex‹Á
(
fs_šfo
,

10643 
	`bŒfs_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
™em
));

10644 ià(
»t
 < 0)

10645 
out
;

10646 
’coded
->
com´essiÚ
 = 
»t
;

10647 ià(
’coded
->
com´essiÚ
) {

10648 
size_t
 
šlše_size
;

10650 
šlše_size
 = 
	`bŒfs_fe_ex‹Á_šlše_™em_Ën
(
Ëaf
,

10651 
·th
->
¦Ùs
[0]);

10652 ià(
šlše_size
 > 
couÁ
) {

10653 
»t
 = -
ENOBUFS
;

10654 
out
;

10656 
couÁ
 = 
šlše_size
;

10657 
’coded
->
uÃncoded_Ën
 = 
¿m_by‹s
;

10658 
’coded
->
uÃncoded_off£t
 = 
iocb
->
ki_pos
 - 
ex‹Á_¡¬t
;

10660 
couÁ
 = 
	`mš_t
(
u64
, couÁ, 
’coded
->
Ën
);

10661 
’coded
->
Ën
 = 
couÁ
;

10662 
’coded
->
uÃncoded_Ën
 = 
couÁ
;

10663 
±r
 +ğ
iocb
->
ki_pos
 - 
ex‹Á_¡¬t
;

10666 
tmp
 = 
	`km®loc
(
couÁ
, 
GFP_NOFS
);

10667 ià(!
tmp
) {

10668 
»t
 = -
ENOMEM
;

10669 
out
;

10671 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
tmp
, 
±r
, 
couÁ
);

10672 
	`bŒfs_»Ëa£_·th
(
·th
);

10673 
	`uÆock_ex‹Á
(
io_Œ“
, 
¡¬t
, 
lock’d
, 
ÿched_¡©e
);

10674 
	`bŒfs_šode_uÆock
(
šode
, 
BTRFS_ILOCK_SHARED
);

10675 *
uÆocked
 = 
Œue
;

10677 
»t
 = 
	`cİy_to_™”
(
tmp
, 
couÁ
, 
™”
);

10678 ià(
»t
 !ğ
couÁ
)

10679 
»t
 = -
EFAULT
;

10680 
	`kä“
(
tmp
);

10681 
out
:

10682 
	`bŒfs_ä“_·th
(
·th
);

10683  
»t
;

10684 
	}
}

10686 
	sbŒfs_’coded_»ad_´iv©e
 {

10687 
wa™_queue_h—d_t
 
	mwa™
;

10688 
©omic_t
 
	m³ndšg
;

10689 
blk_¡©us_t
 
	m¡©us
;

10692 
	$bŒfs_’coded_»ad_’dio
(
bŒfs_bio
 *
bbio
)

10694 
bŒfs_’coded_»ad_´iv©e
 *
´iv
 = 
bbio
->
´iv©e
;

10696 ià(
bbio
->
bio
.
bi_¡©us
) {

10705 
	`WRITE_ONCE
(
´iv
->
¡©us
, 
bbio
->
bio
.
bi_¡©us
);

10707 ià(!
	`©omic_dec_»tuº
(&
´iv
->
³ndšg
))

10708 
	`wake_up
(&
´iv
->
wa™
);

10709 
	`bio_put
(&
bbio
->
bio
);

10710 
	}
}

10712 
	$bŒfs_’coded_»ad_»guÏr_fl_·ges
(
bŒfs_šode
 *
šode
,

10713 
u64
 
fe_off£t
, u64 
disk_by‹Ä
,

10714 
u64
 
disk_io_size
, 
·ge
 **
·ges
)

10716 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

10717 
bŒfs_’coded_»ad_´iv©e
 
´iv
 = {

10718 .
³ndšg
 = 
	`ATOMIC_INIT
(1),

10720 
i
 = 0;

10721 
bŒfs_bio
 *
bbio
;

10723 
	`š™_wa™queue_h—d
(&
´iv
.
wa™
);

10725 
bbio
 = 
	`bŒfs_bio_®loc
(
BIO_MAX_VECS
, 
REQ_OP_READ
, 
fs_šfo
,

10726 
bŒfs_’coded_»ad_’dio
, &
´iv
);

10727 
bbio
->
bio
.
bi_™”
.
bi_£ùÜ
 = 
disk_by‹Ä
 >> 
SECTOR_SHIFT
;

10728 
bbio
->
šode
 = inode;

10731 
size_t
 
by‹s
 = 
	`mš_t
(
u64
, 
disk_io_size
, 
PAGE_SIZE
);

10733 ià(
	`bio_add_·ge
(&
bbio
->
bio
, 
·ges
[
i
], 
by‹s
, 0) < bytes) {

10734 
	`©omic_šc
(&
´iv
.
³ndšg
);

10735 
	`bŒfs_subm™_bio
(
bbio
, 0);

10737 
bbio
 = 
	`bŒfs_bio_®loc
(
BIO_MAX_VECS
, 
REQ_OP_READ
, 
fs_šfo
,

10738 
bŒfs_’coded_»ad_’dio
, &
´iv
);

10739 
bbio
->
bio
.
bi_™”
.
bi_£ùÜ
 = 
disk_by‹Ä
 >> 
SECTOR_SHIFT
;

10740 
bbio
->
šode
 = inode;

10744 
i
++;

10745 
disk_by‹Ä
 +ğ
by‹s
;

10746 
disk_io_size
 -ğ
by‹s
;

10747 } 
disk_io_size
);

10749 
	`©omic_šc
(&
´iv
.
³ndšg
);

10750 
	`bŒfs_subm™_bio
(
bbio
, 0);

10752 ià(
	`©omic_dec_»tuº
(&
´iv
.
³ndšg
))

10753 
	`io_wa™_ev’t
(
´iv
.
wa™
, !
	`©omic_»ad
(&´iv.
³ndšg
));

10755  
	`blk_¡©us_to_”ºo
(
	`READ_ONCE
(
´iv
.
¡©us
));

10756 
	}
}

10758 
ssize_t
 
	$bŒfs_’coded_»ad_»guÏr
(
kiocb
 *
iocb
,

10759 
iov_™”
 *
™”
,

10760 
u64
 
¡¬t
, u64 
lock’d
,

10761 
ex‹Á_¡©e
 **
ÿched_¡©e
,

10762 
u64
 
disk_by‹Ä
, u64 
disk_io_size
,

10763 
size_t
 
couÁ
, 
boŞ
 
com´es£d
,

10764 
boŞ
 *
uÆocked
)

10766 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
	`fe_šode
(
iocb
->
ki_fp
));

10767 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
šode
->io_tree;

10768 
·ge
 **
·ges
;

10769 
Ä_·ges
, 
i
;

10770 
u64
 
cur
;

10771 
size_t
 
·ge_off£t
;

10772 
ssize_t
 
»t
;

10774 
Ä_·ges
 = 
	`DIV_ROUND_UP
(
disk_io_size
, 
PAGE_SIZE
);

10775 
·ges
 = 
	`kÿÎoc
(
Ä_·ges
, (
·ge
 *), 
GFP_NOFS
);

10776 ià(!
·ges
)

10777  -
ENOMEM
;

10778 
»t
 = 
	`bŒfs_®loc_·ge_¬¿y
(
Ä_·ges
, 
·ges
);

10779 ià(
»t
) {

10780 
»t
 = -
ENOMEM
;

10781 
out
;

10784 
»t
 = 
	`bŒfs_’coded_»ad_»guÏr_fl_·ges
(
šode
, 
¡¬t
, 
disk_by‹Ä
,

10785 
disk_io_size
, 
·ges
);

10786 ià(
»t
)

10787 
out
;

10789 
	`uÆock_ex‹Á
(
io_Œ“
, 
¡¬t
, 
lock’d
, 
ÿched_¡©e
);

10790 
	`bŒfs_šode_uÆock
(
šode
, 
BTRFS_ILOCK_SHARED
);

10791 *
uÆocked
 = 
Œue
;

10793 ià(
com´es£d
) {

10794 
i
 = 0;

10795 
·ge_off£t
 = 0;

10797 
i
 = (
iocb
->
ki_pos
 - 
¡¬t
è>> 
PAGE_SHIFT
;

10798 
·ge_off£t
 = (
iocb
->
ki_pos
 - 
¡¬t
è& (
PAGE_SIZE
 - 1);

10800 
cur
 = 0;

10801 
cur
 < 
couÁ
) {

10802 
size_t
 
by‹s
 = 
	`mš_t
(size_t, 
couÁ
 - 
cur
,

10803 
PAGE_SIZE
 - 
·ge_off£t
);

10805 ià(
	`cİy_·ge_to_™”
(
·ges
[
i
], 
·ge_off£t
, 
by‹s
,

10806 
™”
è!ğ
by‹s
) {

10807 
»t
 = -
EFAULT
;

10808 
out
;

10810 
i
++;

10811 
cur
 +ğ
by‹s
;

10812 
·ge_off£t
 = 0;

10814 
»t
 = 
couÁ
;

10815 
out
:

10816 
i
 = 0; i < 
Ä_·ges
; i++) {

10817 ià(
·ges
[
i
])

10818 
	`__ä“_·ge
(
·ges
[
i
]);

10820 
	`kä“
(
·ges
);

10821  
»t
;

10822 
	}
}

10824 
ssize_t
 
	$bŒfs_’coded_»ad
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
,

10825 
bŒfs_ioùl_’coded_io_¬gs
 *
’coded
)

10827 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
	`fe_šode
(
iocb
->
ki_fp
));

10828 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

10829 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
šode
->io_tree;

10830 
ssize_t
 
»t
;

10831 
size_t
 
couÁ
 = 
	`iov_™”_couÁ
(
™”
);

10832 
u64
 
¡¬t
, 
lock’d
, 
disk_by‹Ä
, 
disk_io_size
;

10833 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

10834 
ex‹Á_m­
 *
em
;

10835 
boŞ
 
uÆocked
 = 
çl£
;

10837 
	`fe_acûs£d
(
iocb
->
ki_fp
);

10839 
	`bŒfs_šode_lock
(
šode
, 
BTRFS_ILOCK_SHARED
);

10841 ià(
iocb
->
ki_pos
 >ğ
šode
->
vfs_šode
.
i_size
) {

10842 
	`bŒfs_šode_uÆock
(
šode
, 
BTRFS_ILOCK_SHARED
);

10845 
¡¬t
 = 
	`ALIGN_DOWN
(
iocb
->
ki_pos
, 
fs_šfo
->
£ùÜsize
);

10850 
lock’d
 = 
¡¬t
 + 
BTRFS_MAX_UNCOMPRESSED
 - 1;

10853 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

10855 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(&
šode
->
vfs_šode
, 
¡¬t
,

10856 
lock’d
 - 
¡¬t
 + 1);

10857 ià(
»t
)

10858 
out_uÆock_šode
;

10859 
	`lock_ex‹Á
(
io_Œ“
, 
¡¬t
, 
lock’d
, &
ÿched_¡©e
);

10860 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
šode
, 
¡¬t
,

10861 
lock’d
 - 
¡¬t
 + 1);

10862 ià(!
Üd”ed
)

10864 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

10865 
	`uÆock_ex‹Á
(
io_Œ“
, 
¡¬t
, 
lock’d
, &
ÿched_¡©e
);

10866 
	`cÚd_»sched
();

10869 
em
 = 
	`bŒfs_g‘_ex‹Á
(
šode
, 
NULL
, 0, 
¡¬t
, 
lock’d
 - start + 1);

10870 ià(
	`IS_ERR
(
em
)) {

10871 
»t
 = 
	`PTR_ERR
(
em
);

10872 
out_uÆock_ex‹Á
;

10875 ià(
em
->
block_¡¬t
 =ğ
EXTENT_MAP_INLINE
) {

10876 
u64
 
ex‹Á_¡¬t
 = 
em
->
¡¬t
;

10882 
	`ä“_ex‹Á_m­
(
em
);

10883 
em
 = 
NULL
;

10884 
»t
 = 
	`bŒfs_’coded_»ad_šlše
(
iocb
, 
™”
, 
¡¬t
, 
lock’d
,

10885 &
ÿched_¡©e
, 
ex‹Á_¡¬t
,

10886 
couÁ
, 
’coded
, &
uÆocked
);

10887 
out
;

10894 
’coded
->
Ën
 = 
	`mš_t
(
u64
, 
	`ex‹Á_m­_’d
(
em
),

10895 
šode
->
vfs_šode
.
i_size
è- 
iocb
->
ki_pos
;

10896 ià(
em
->
block_¡¬t
 =ğ
EXTENT_MAP_HOLE
 ||

10897 
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
)) {

10898 
disk_by‹Ä
 = 
EXTENT_MAP_HOLE
;

10899 
couÁ
 = 
	`mš_t
(
u64
, couÁ, 
’coded
->
Ën
);

10900 
’coded
->
Ën
 = 
couÁ
;

10901 
’coded
->
uÃncoded_Ën
 = 
couÁ
;

10902 } ià(
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
)) {

10903 
disk_by‹Ä
 = 
em
->
block_¡¬t
;

10908 ià(
em
->
block_Ën
 > 
couÁ
) {

10909 
»t
 = -
ENOBUFS
;

10910 
out_em
;

10912 
disk_io_size
 = 
em
->
block_Ën
;

10913 
couÁ
 = 
em
->
block_Ën
;

10914 
’coded
->
uÃncoded_Ën
 = 
em
->
¿m_by‹s
;

10915 
’coded
->
uÃncoded_off£t
 = 
iocb
->
ki_pos
 - 
em
->
Üig_¡¬t
;

10916 
»t
 = 
	`bŒfs_’coded_io_com´essiÚ_äom_ex‹Á
(
fs_šfo
,

10917 
em
->
com´ess_ty³
);

10918 ià(
»t
 < 0)

10919 
out_em
;

10920 
’coded
->
com´essiÚ
 = 
»t
;

10922 
disk_by‹Ä
 = 
em
->
block_¡¬t
 + (
¡¬t
 -ƒm->start);

10923 ià(
’coded
->
Ën
 > 
couÁ
)

10924 
’coded
->
Ën
 = 
couÁ
;

10929 
disk_io_size
 = 
	`mš
(
lock’d
 + 1, 
iocb
->
ki_pos
 + 
’coded
->
Ën
è- 
¡¬t
;

10930 
couÁ
 = 
¡¬t
 + 
disk_io_size
 - 
iocb
->
ki_pos
;

10931 
’coded
->
Ën
 = 
couÁ
;

10932 
’coded
->
uÃncoded_Ën
 = 
couÁ
;

10933 
disk_io_size
 = 
	`ALIGN
(disk_io_size, 
fs_šfo
->
£ùÜsize
);

10935 
	`ä“_ex‹Á_m­
(
em
);

10936 
em
 = 
NULL
;

10938 ià(
disk_by‹Ä
 =ğ
EXTENT_MAP_HOLE
) {

10939 
	`uÆock_ex‹Á
(
io_Œ“
, 
¡¬t
, 
lock’d
, &
ÿched_¡©e
);

10940 
	`bŒfs_šode_uÆock
(
šode
, 
BTRFS_ILOCK_SHARED
);

10941 
uÆocked
 = 
Œue
;

10942 
»t
 = 
	`iov_™”_z”o
(
couÁ
, 
™”
);

10943 ià(
»t
 !ğ
couÁ
)

10944 
»t
 = -
EFAULT
;

10946 
»t
 = 
	`bŒfs_’coded_»ad_»guÏr
(
iocb
, 
™”
, 
¡¬t
, 
lock’d
,

10947 &
ÿched_¡©e
, 
disk_by‹Ä
,

10948 
disk_io_size
, 
couÁ
,

10949 
’coded
->
com´essiÚ
,

10950 &
uÆocked
);

10953 
out
:

10954 ià(
»t
 >= 0)

10955 
iocb
->
ki_pos
 +ğ
’coded
->
Ën
;

10956 
out_em
:

10957 
	`ä“_ex‹Á_m­
(
em
);

10958 
out_uÆock_ex‹Á
:

10959 ià(!
uÆocked
)

10960 
	`uÆock_ex‹Á
(
io_Œ“
, 
¡¬t
, 
lock’d
, &
ÿched_¡©e
);

10961 
out_uÆock_šode
:

10962 ià(!
uÆocked
)

10963 
	`bŒfs_šode_uÆock
(
šode
, 
BTRFS_ILOCK_SHARED
);

10964  
»t
;

10965 
	}
}

10967 
ssize_t
 
	$bŒfs_do_’coded_wr™e
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
,

10968 cÚ¡ 
bŒfs_ioùl_’coded_io_¬gs
 *
’coded
)

10970 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
	`fe_šode
(
iocb
->
ki_fp
));

10971 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

10972 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

10973 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
šode
->io_tree;

10974 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

10975 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

10976 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

10977 
com´essiÚ
;

10978 
size_t
 
Üig_couÁ
;

10979 
u64
 
¡¬t
, 
’d
;

10980 
u64
 
num_by‹s
, 
¿m_by‹s
, 
disk_num_by‹s
;

10981 
Ä_·ges
, 
i
;

10982 
·ge
 **
·ges
;

10983 
bŒfs_key
 
šs
;

10984 
boŞ
 
ex‹Á_»£rved
 = 
çl£
;

10985 
ex‹Á_m­
 *
em
;

10986 
ssize_t
 
»t
;

10988 
’coded
->
com´essiÚ
) {

10989 
BTRFS_ENCODED_IO_COMPRESSION_ZLIB
:

10990 
com´essiÚ
 = 
BTRFS_COMPRESS_ZLIB
;

10992 
BTRFS_ENCODED_IO_COMPRESSION_ZSTD
:

10993 
com´essiÚ
 = 
BTRFS_COMPRESS_ZSTD
;

10995 
BTRFS_ENCODED_IO_COMPRESSION_LZO_4K
:

10996 
BTRFS_ENCODED_IO_COMPRESSION_LZO_8K
:

10997 
BTRFS_ENCODED_IO_COMPRESSION_LZO_16K
:

10998 
BTRFS_ENCODED_IO_COMPRESSION_LZO_32K
:

10999 
BTRFS_ENCODED_IO_COMPRESSION_LZO_64K
:

11001 ià(
’coded
->
com´essiÚ
 -

11002 
BTRFS_ENCODED_IO_COMPRESSION_LZO_4K
 + 12 !=

11003 
fs_šfo
->
£ùÜsize_b™s
)

11004  -
EINVAL
;

11005 
com´essiÚ
 = 
BTRFS_COMPRESS_LZO
;

11008  -
EINVAL
;

11010 ià(
’coded
->
’üy±iÚ
 !ğ
BTRFS_ENCODED_IO_ENCRYPTION_NONE
)

11011  -
EINVAL
;

11013 
Üig_couÁ
 = 
	`iov_™”_couÁ
(
äom
);

11016 ià(
’coded
->
uÃncoded_Ën
 > 
BTRFS_MAX_UNCOMPRESSED
 ||

11017 
Üig_couÁ
 > 
BTRFS_MAX_COMPRESSED
 || orig_count == 0)

11018  -
EINVAL
;

11033 ià(
Üig_couÁ
 >ğ
’coded
->
uÃncoded_Ën
)

11034  -
EINVAL
;

11037 
¡¬t
 = 
iocb
->
ki_pos
;

11038 ià(!
	`IS_ALIGNED
(
¡¬t
, 
fs_šfo
->
£ùÜsize
))

11039  -
EINVAL
;

11046 ià(
¡¬t
 + 
’coded
->
Ën
 < 
šode
->
vfs_šode
.
i_size
 &&

11047 !
	`IS_ALIGNED
(
¡¬t
 + 
’coded
->
Ën
, 
fs_šfo
->
£ùÜsize
))

11048  -
EINVAL
;

11051 ià(!
	`IS_ALIGNED
(
’coded
->
uÃncoded_off£t
, 
fs_šfo
->
£ùÜsize
))

11052  -
EINVAL
;

11054 
num_by‹s
 = 
	`ALIGN
(
’coded
->
Ën
, 
fs_šfo
->
£ùÜsize
);

11055 
¿m_by‹s
 = 
	`ALIGN
(
’coded
->
uÃncoded_Ën
, 
fs_šfo
->
£ùÜsize
);

11056 
’d
 = 
¡¬t
 + 
num_by‹s
 - 1;

11063 
disk_num_by‹s
 = 
	`ALIGN
(
Üig_couÁ
, 
fs_šfo
->
£ùÜsize
);

11064 
Ä_·ges
 = 
	`DIV_ROUND_UP
(
disk_num_by‹s
, 
PAGE_SIZE
);

11065 
·ges
 = 
	`kvÿÎoc
(
Ä_·ges
, (
·ge
 *), 
GFP_KERNEL_ACCOUNT
);

11066 ià(!
·ges
)

11067  -
ENOMEM
;

11068 
i
 = 0; i < 
Ä_·ges
; i++) {

11069 
size_t
 
by‹s
 = 
	`mš_t
(size_t, 
PAGE_SIZE
, 
	`iov_™”_couÁ
(
äom
));

11070 *
kaddr
;

11072 
·ges
[
i
] = 
	`®loc_·ge
(
GFP_KERNEL_ACCOUNT
);

11073 ià(!
·ges
[
i
]) {

11074 
»t
 = -
ENOMEM
;

11075 
out_·ges
;

11077 
kaddr
 = 
	`km­_loÿl_·ge
(
·ges
[
i
]);

11078 ià(
	`cİy_äom_™”
(
kaddr
, 
by‹s
, 
äom
) != bytes) {

11079 
	`kunm­_loÿl
(
kaddr
);

11080 
»t
 = -
EFAULT
;

11081 
out_·ges
;

11083 ià(
by‹s
 < 
PAGE_SIZE
)

11084 
	`mem£t
(
kaddr
 + 
by‹s
, 0, 
PAGE_SIZE
 - bytes);

11085 
	`kunm­_loÿl
(
kaddr
);

11089 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

11091 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(&
šode
->
vfs_šode
, 
¡¬t
, 
num_by‹s
);

11092 ià(
»t
)

11093 
out_·ges
;

11094 
»t
 = 
	`šv®id©e_šode_·ges2_¿nge
(
šode
->
vfs_šode
.
i_m­pšg
,

11095 
¡¬t
 >> 
PAGE_SHIFT
,

11096 
’d
 >> 
PAGE_SHIFT
);

11097 ià(
»t
)

11098 
out_·ges
;

11099 
	`lock_ex‹Á
(
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

11100 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
šode
, 
¡¬t
, 
num_by‹s
);

11101 ià(!
Üd”ed
 &&

11102 !
	`fem­_¿nge_has_·ge
(
šode
->
vfs_šode
.
i_m­pšg
, 
¡¬t
, 
’d
))

11104 ià(
Üd”ed
)

11105 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

11106 
	`uÆock_ex‹Á
(
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

11107 
	`cÚd_»sched
();

11114 
»t
 = 
	`bŒfs_®loc_d©a_chunk_Údemªd
(
šode
, 
disk_num_by‹s
);

11115 ià(
»t
)

11116 
out_uÆock
;

11117 
»t
 = 
	`bŒfs_qgroup_»£rve_d©a
(
šode
, &
d©a_»£rved
, 
¡¬t
, 
num_by‹s
);

11118 ià(
»t
)

11119 
out_ä“_d©a_¥aû
;

11120 
»t
 = 
	`bŒfs_d–®loc_»£rve_m‘ad©a
(
šode
, 
num_by‹s
, 
disk_num_by‹s
,

11121 
çl£
);

11122 ià(
»t
)

11123 
out_qgroup_ä“_d©a
;

11126 ià(
¡¬t
 =ğ0 && 
’coded
->
uÃncoded_Ën
 =ğ’coded->
Ën
 &&

11127 
’coded
->
uÃncoded_off£t
 == 0) {

11128 
»t
 = 
	`cow_fe_¿nge_šlše
(
šode
, 
’coded
->
Ën
, 
Üig_couÁ
,

11129 
com´essiÚ
, 
·ges
, 
Œue
);

11130 ià(
»t
 <= 0) {

11131 ià(
»t
 == 0)

11132 
»t
 = 
Üig_couÁ
;

11133 
out_d–®loc_»Ëa£
;

11137 
»t
 = 
	`bŒfs_»£rve_ex‹Á
(
roÙ
, 
disk_num_by‹s
, disk_num_bytes,

11138 
disk_num_by‹s
, 0, 0, &
šs
, 1, 1);

11139 ià(
»t
)

11140 
out_d–®loc_»Ëa£
;

11141 
ex‹Á_»£rved
 = 
Œue
;

11143 
em
 = 
	`ü—‹_io_em
(
šode
, 
¡¬t
, 
num_by‹s
,

11144 
¡¬t
 - 
’coded
->
uÃncoded_off£t
, 
šs
.
objeùid
,

11145 
šs
.
off£t
, ins.off£t, 
¿m_by‹s
, 
com´essiÚ
,

11146 
BTRFS_ORDERED_COMPRESSED
);

11147 ià(
	`IS_ERR
(
em
)) {

11148 
»t
 = 
	`PTR_ERR
(
em
);

11149 
out_ä“_»£rved
;

11151 
	`ä“_ex‹Á_m­
(
em
);

11153 
Üd”ed
 = 
	`bŒfs_®loc_Üd”ed_ex‹Á
(
šode
, 
¡¬t
, 
num_by‹s
, 
¿m_by‹s
,

11154 
šs
.
objeùid
, ins.
off£t
,

11155 
’coded
->
uÃncoded_off£t
,

11156 (1 << 
BTRFS_ORDERED_ENCODED
) |

11157 (1 << 
BTRFS_ORDERED_COMPRESSED
),

11158 
com´essiÚ
);

11159 ià(
	`IS_ERR
(
Üd”ed
)) {

11160 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
šode
, 
¡¬t
, 
’d
, 
çl£
);

11161 
»t
 = 
	`PTR_ERR
(
Üd”ed
);

11162 
out_ä“_»£rved
;

11164 
	`bŒfs_dec_block_group_»£rv©iÚs
(
fs_šfo
, 
šs
.
objeùid
);

11166 ià(
¡¬t
 + 
’coded
->
Ën
 > 
šode
->
vfs_šode
.
i_size
)

11167 
	`i_size_wr™e
(&
šode
->
vfs_šode
, 
¡¬t
 + 
’coded
->
Ën
);

11169 
	`uÆock_ex‹Á
(
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

11171 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
šode
, 
num_by‹s
);

11173 
	`bŒfs_subm™_com´es£d_wr™e
(
Üd”ed
, 
·ges
, 
Ä_·ges
, 0, 
çl£
);

11174 
»t
 = 
Üig_couÁ
;

11175 
out
;

11177 
out_ä“_»£rved
:

11178 
	`bŒfs_dec_block_group_»£rv©iÚs
(
fs_šfo
, 
šs
.
objeùid
);

11179 
	`bŒfs_ä“_»£rved_ex‹Á
(
fs_šfo
, 
šs
.
objeùid
, ins.
off£t
, 1);

11180 
out_d–®loc_»Ëa£
:

11181 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
šode
, 
num_by‹s
);

11182 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
šode
, 
disk_num_by‹s
, 
»t
 < 0);

11183 
out_qgroup_ä“_d©a
:

11184 ià(
»t
 < 0)

11185 
	`bŒfs_qgroup_ä“_d©a
(
šode
, 
d©a_»£rved
, 
¡¬t
, 
num_by‹s
, 
NULL
);

11186 
out_ä“_d©a_¥aû
:

11191 ià(!
ex‹Á_»£rved
)

11192 
	`bŒfs_ä“_»£rved_d©a_¥aû_noquÙa
(
fs_šfo
, 
disk_num_by‹s
);

11193 
out_uÆock
:

11194 
	`uÆock_ex‹Á
(
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

11195 
out_·ges
:

11196 
i
 = 0; i < 
Ä_·ges
; i++) {

11197 ià(
·ges
[
i
])

11198 
	`__ä“_·ge
(
·ges
[
i
]);

11200 
	`kvä“
(
·ges
);

11201 
out
:

11202 ià(
»t
 >= 0)

11203 
iocb
->
ki_pos
 +ğ
’coded
->
Ën
;

11204  
»t
;

11205 
	}
}

11207 #ifdeà
CONFIG_SWAP


11213 
	$bŒfs_add_sw­fe_pš
(
šode
 *šode, *
±r
,

11214 
boŞ
 
is_block_group
)

11216 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`BTRFS_I
(
šode
)->
roÙ
->fs_info;

11217 
bŒfs_sw­fe_pš
 *
¥
, *
’Œy
;

11218 
rb_node
 **
p
;

11219 
rb_node
 *
·»Á
 = 
NULL
;

11221 
¥
 = 
	`km®loc
((*¥), 
GFP_NOFS
);

11222 ià(!
¥
)

11223  -
ENOMEM
;

11224 
¥
->
±r
 =…tr;

11225 
¥
->
šode
 = inode;

11226 
¥
->
is_block_group
 = is_block_group;

11227 
¥
->
bg_ex‹Á_couÁ
 = 1;

11229 
	`¥š_lock
(&
fs_šfo
->
sw­fe_pšs_lock
);

11230 
p
 = &
fs_šfo
->
sw­fe_pšs
.
rb_node
;

11231 *
p
) {

11232 
·»Á
 = *
p
;

11233 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
bŒfs_sw­fe_pš
, 
node
);

11234 ià(
¥
->
±r
 < 
’Œy
->ptr ||

11235 (
¥
->
±r
 =ğ
’Œy
->±¸&& sp->
šode
 <ƒntry->inode)) {

11236 
p
 = &(*p)->
rb_Ëá
;

11237 } ià(
¥
->
±r
 > 
’Œy
->ptr ||

11238 (
¥
->
±r
 =ğ
’Œy
->±¸&& sp->
šode
 >ƒntry->inode)) {

11239 
p
 = &(*p)->
rb_right
;

11241 ià(
is_block_group
)

11242 
’Œy
->
bg_ex‹Á_couÁ
++;

11243 
	`¥š_uÆock
(&
fs_šfo
->
sw­fe_pšs_lock
);

11244 
	`kä“
(
¥
);

11248 
	`rb_lšk_node
(&
¥
->
node
, 
·»Á
, 
p
);

11249 
	`rb_š£¹_cŞÜ
(&
¥
->
node
, &
fs_šfo
->
sw­fe_pšs
);

11250 
	`¥š_uÆock
(&
fs_šfo
->
sw­fe_pšs_lock
);

11252 
	}
}

11255 
	$bŒfs_ä“_sw­fe_pšs
(
šode
 *inode)

11257 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`BTRFS_I
(
šode
)->
roÙ
->fs_info;

11258 
bŒfs_sw­fe_pš
 *
¥
;

11259 
rb_node
 *
node
, *
Ãxt
;

11261 
	`¥š_lock
(&
fs_šfo
->
sw­fe_pšs_lock
);

11262 
node
 = 
	`rb_fœ¡
(&
fs_šfo
->
sw­fe_pšs
);

11263 
node
) {

11264 
Ãxt
 = 
	`rb_Ãxt
(
node
);

11265 
¥
 = 
	`rb_’Œy
(
node
, 
bŒfs_sw­fe_pš
,‚ode);

11266 ià(
¥
->
šode
 == inode) {

11267 
	`rb_”a£
(&
¥
->
node
, &
fs_šfo
->
sw­fe_pšs
);

11268 ià(
¥
->
is_block_group
) {

11269 
	`bŒfs_dec_block_group_sw­_ex‹Ás
(
¥
->
±r
,

11270 
¥
->
bg_ex‹Á_couÁ
);

11271 
	`bŒfs_put_block_group
(
¥
->
±r
);

11273 
	`kä“
(
¥
);

11275 
node
 = 
Ãxt
;

11277 
	`¥š_uÆock
(&
fs_šfo
->
sw­fe_pšs_lock
);

11278 
	}
}

11280 
	sbŒfs_sw­_šfo
 {

11281 
u64
 
	m¡¬t
;

11282 
u64
 
	mblock_¡¬t
;

11283 
u64
 
	mblock_Ën
;

11284 
u64
 
	mlowe¡_µage
;

11285 
u64
 
	mhighe¡_µage
;

11286 
	mÄ_·ges
;

11287 
	mÄ_ex‹Ás
;

11290 
	$bŒfs_add_sw­_ex‹Á
(
sw­_šfo_¡ruù
 *
sis
,

11291 
bŒfs_sw­_šfo
 *
bsi
)

11293 
Ä_·ges
;

11294 
max_·ges
;

11295 
u64
 
fœ¡_µage
, 
fœ¡_µage_»pÜ‹d
, 
Ãxt_µage
;

11296 
»t
;

11303 ià(
bsi
->
Ä_·ges
 >ğ
sis
->
max
)

11306 
max_·ges
 = 
sis
->
max
 - 
bsi
->
Ä_·ges
;

11307 
fœ¡_µage
 = 
	`PAGE_ALIGN
(
bsi
->
block_¡¬t
è>> 
PAGE_SHIFT
;

11308 
Ãxt_µage
 = 
	`PAGE_ALIGN_DOWN
(
bsi
->
block_¡¬t
 + bsi->
block_Ën
è>> 
PAGE_SHIFT
;

11310 ià(
fœ¡_µage
 >ğ
Ãxt_µage
)

11312 
Ä_·ges
 = 
Ãxt_µage
 - 
fœ¡_µage
;

11313 
Ä_·ges
 = 
	`mš
Òr_·ges, 
max_·ges
);

11315 
fœ¡_µage_»pÜ‹d
 = 
fœ¡_µage
;

11316 ià(
bsi
->
¡¬t
 == 0)

11317 
fœ¡_µage_»pÜ‹d
++;

11318 ià(
bsi
->
lowe¡_µage
 > 
fœ¡_µage_»pÜ‹d
)

11319 
bsi
->
lowe¡_µage
 = 
fœ¡_µage_»pÜ‹d
;

11320 ià(
bsi
->
highe¡_µage
 < (
Ãxt_µage
 - 1))

11321 
bsi
->
highe¡_µage
 = 
Ãxt_µage
 - 1;

11323 
»t
 = 
	`add_sw­_ex‹Á
(
sis
, 
bsi
->
Ä_·ges
,‚r_·ges, 
fœ¡_µage
);

11324 ià(
»t
 < 0)

11325  
»t
;

11326 
bsi
->
Ä_ex‹Ás
 +ğ
»t
;

11327 
bsi
->
Ä_·ges
 +=‚r_pages;

11329 
	}
}

11331 
	$bŒfs_sw­_d—ùiv©e
(
fe
 *file)

11333 
šode
 *šodğ
	`fe_šode
(
fe
);

11335 
	`bŒfs_ä“_sw­fe_pšs
(
šode
);

11336 
	`©omic_dec
(&
	`BTRFS_I
(
šode
)->
roÙ
->
Ä_sw­fes
);

11337 
	}
}

11339 
	$bŒfs_sw­_aùiv©e
(
sw­_šfo_¡ruù
 *
sis
, 
fe
 *file,

11340 
£ùÜ_t
 *
¥ª
)

11342 
šode
 *šodğ
	`fe_šode
(
fe
);

11343 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

11344 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

11345 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

11346 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

11347 
ex‹Á_m­
 *
em
 = 
NULL
;

11348 
bŒfs_deviû
 *
deviû
 = 
NULL
;

11349 
bŒfs_sw­_šfo
 
bsi
 = {

11350 .
lowe¡_µage
 = (
£ùÜ_t
)-1ULL,

11352 
»t
 = 0;

11353 
u64
 
isize
;

11354 
u64
 
¡¬t
;

11361 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 0, (
u64
)-1);

11362 ià(
»t
)

11363  
»t
;

11368 ià(
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_COMPRESS
) {

11369 
	`bŒfs_w¬n
(
fs_šfo
, "swapfile must‚ot be compressed");

11370  -
EINVAL
;

11372 ià(!(
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATACOW
)) {

11373 
	`bŒfs_w¬n
(
fs_šfo
, "swapfile must‚ot be copy-on-write");

11374  -
EINVAL
;

11376 ià(!(
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATASUM
)) {

11377 
	`bŒfs_w¬n
(
fs_šfo
, "swapfile must‚ot be checksummed");

11378  -
EINVAL
;

11390 ià(!
	`bŒfs_exşİ_¡¬t
(
fs_šfo
, 
BTRFS_EXCLOP_SWAP_ACTIVATE
)) {

11391 
	`bŒfs_w¬n
(
fs_šfo
,

11393  -
EBUSY
;

11403 ià(!
	`bŒfs_d»w_Œy_wr™e_lock
(&
roÙ
->
¢­shÙ_lock
)) {

11404 
	`bŒfs_exşİ_fšish
(
fs_šfo
);

11405 
	`bŒfs_w¬n
(
fs_šfo
,

11407  -
EINVAL
;

11419 
	`¥š_lock
(&
roÙ
->
roÙ_™em_lock
);

11420 ià(
	`bŒfs_roÙ_d—d
(
roÙ
)) {

11421 
	`¥š_uÆock
(&
roÙ
->
roÙ_™em_lock
);

11423 
	`bŒfs_exşİ_fšish
(
fs_šfo
);

11424 
	`bŒfs_w¬n
(
fs_šfo
,

11426 
roÙ
->
roÙ_key
.
objeùid
);

11427  -
EPERM
;

11429 
	`©omic_šc
(&
roÙ
->
Ä_sw­fes
);

11430 
	`¥š_uÆock
(&
roÙ
->
roÙ_™em_lock
);

11432 
isize
 = 
	`ALIGN_DOWN
(
šode
->
i_size
, 
fs_šfo
->
£ùÜsize
);

11434 
	`lock_ex‹Á
(
io_Œ“
, 0, 
isize
 - 1, &
ÿched_¡©e
);

11435 
¡¬t
 = 0;

11436 
¡¬t
 < 
isize
) {

11437 
u64
 
logiÿl_block_¡¬t
, 
physiÿl_block_¡¬t
;

11438 
bŒfs_block_group
 *
bg
;

11439 
u64
 
Ën
 = 
isize
 - 
¡¬t
;

11441 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
¡¬t
, 
Ën
);

11442 ià(
	`IS_ERR
(
em
)) {

11443 
»t
 = 
	`PTR_ERR
(
em
);

11444 
out
;

11447 ià(
em
->
block_¡¬t
 =ğ
EXTENT_MAP_HOLE
) {

11448 
	`bŒfs_w¬n
(
fs_šfo
, "swapfile must‚ot have holes");

11449 
»t
 = -
EINVAL
;

11450 
out
;

11452 ià(
em
->
block_¡¬t
 =ğ
EXTENT_MAP_INLINE
) {

11460 
	`bŒfs_w¬n
(
fs_šfo
, "swapfile must‚ot be inline");

11461 
»t
 = -
EINVAL
;

11462 
out
;

11464 ià(
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
)) {

11465 
	`bŒfs_w¬n
(
fs_šfo
, "swapfile must‚ot be compressed");

11466 
»t
 = -
EINVAL
;

11467 
out
;

11470 
logiÿl_block_¡¬t
 = 
em
->
block_¡¬t
 + (
¡¬t
 -ƒm->start);

11471 
Ën
 = 
	`mš
Ö’, 
em
->ËÀ- (
¡¬t
 -ƒm->start));

11472 
	`ä“_ex‹Á_m­
(
em
);

11473 
em
 = 
NULL
;

11475 
»t
 = 
	`ÿn_nocow_ex‹Á
(
šode
, 
¡¬t
, &
Ën
, 
NULL
, NULL, NULL, 
çl£
, 
Œue
);

11476 ià(
»t
 < 0) {

11477 
out
;

11478 } ià(
»t
) {

11479 
»t
 = 0;

11481 
	`bŒfs_w¬n
(
fs_šfo
,

11483 
»t
 = -
EINVAL
;

11484 
out
;

11487 
em
 = 
	`bŒfs_g‘_chunk_m­
(
fs_šfo
, 
logiÿl_block_¡¬t
, 
Ën
);

11488 ià(
	`IS_ERR
(
em
)) {

11489 
»t
 = 
	`PTR_ERR
(
em
);

11490 
out
;

11493 ià(
em
->
m­_lookup
->
ty³
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) {

11494 
	`bŒfs_w¬n
(
fs_šfo
,

11496 
»t
 = -
EINVAL
;

11497 
out
;

11500 ià(
deviû
 =ğ
NULL
) {

11501 
deviû
 = 
em
->
m­_lookup
->
¡res
[0].
dev
;

11502 
»t
 = 
	`bŒfs_add_sw­fe_pš
(
šode
, 
deviû
, 
çl£
);

11503 ià(
»t
 == 1)

11504 
»t
 = 0;

11505 ià(
»t
)

11506 
out
;

11507 } ià(
deviû
 !ğ
em
->
m­_lookup
->
¡res
[0].
dev
) {

11508 
	`bŒfs_w¬n
(
fs_šfo
, "swapfile must be on one device");

11509 
»t
 = -
EINVAL
;

11510 
out
;

11513 
physiÿl_block_¡¬t
 = (
em
->
m­_lookup
->
¡res
[0].
physiÿl
 +

11514 (
logiÿl_block_¡¬t
 - 
em
->
¡¬t
));

11515 
Ën
 = 
	`mš
Ö’, 
em
->ËÀ- (
logiÿl_block_¡¬t
 -ƒm->
¡¬t
));

11516 
	`ä“_ex‹Á_m­
(
em
);

11517 
em
 = 
NULL
;

11519 
bg
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
logiÿl_block_¡¬t
);

11520 ià(!
bg
) {

11521 
	`bŒfs_w¬n
(
fs_šfo
,

11523 
»t
 = -
EINVAL
;

11524 
out
;

11527 ià(!
	`bŒfs_šc_block_group_sw­_ex‹Ás
(
bg
)) {

11528 
	`bŒfs_w¬n
(
fs_šfo
,

11530 
bg
->
¡¬t
,

11531 
	`©omic_»ad
(&
fs_šfo
->
süubs_ruÂšg
) ?

11533 
	`bŒfs_put_block_group
(
bg
);

11534 
»t
 = -
EINVAL
;

11535 
out
;

11538 
»t
 = 
	`bŒfs_add_sw­fe_pš
(
šode
, 
bg
, 
Œue
);

11539 ià(
»t
) {

11540 
	`bŒfs_put_block_group
(
bg
);

11541 ià(
»t
 == 1)

11542 
»t
 = 0;

11544 
out
;

11547 ià(
bsi
.
block_Ën
 &&

11548 
bsi
.
block_¡¬t
 + bsi.
block_Ën
 =ğ
physiÿl_block_¡¬t
) {

11549 
bsi
.
block_Ën
 +ğ
Ën
;

11551 ià(
bsi
.
block_Ën
) {

11552 
»t
 = 
	`bŒfs_add_sw­_ex‹Á
(
sis
, &
bsi
);

11553 ià(
»t
)

11554 
out
;

11556 
bsi
.
¡¬t
 = start;

11557 
bsi
.
block_¡¬t
 = 
physiÿl_block_¡¬t
;

11558 
bsi
.
block_Ën
 = 
Ën
;

11561 
¡¬t
 +ğ
Ën
;

11564 ià(
bsi
.
block_Ën
)

11565 
»t
 = 
	`bŒfs_add_sw­_ex‹Á
(
sis
, &
bsi
);

11567 
out
:

11568 ià(!
	`IS_ERR_OR_NULL
(
em
))

11569 
	`ä“_ex‹Á_m­
(
em
);

11571 
	`uÆock_ex‹Á
(
io_Œ“
, 0, 
isize
 - 1, &
ÿched_¡©e
);

11573 ià(
»t
)

11574 
	`bŒfs_sw­_d—ùiv©e
(
fe
);

11576 
	`bŒfs_d»w_wr™e_uÆock
(&
roÙ
->
¢­shÙ_lock
);

11578 
	`bŒfs_exşİ_fšish
(
fs_šfo
);

11580 ià(
»t
)

11581  
»t
;

11583 ià(
deviû
)

11584 
sis
->
bdev
 = 
deviû
->bdev;

11585 *
¥ª
 = 
bsi
.
highe¡_µage
 - bsi.
lowe¡_µage
 + 1;

11586 
sis
->
max
 = 
bsi
.
Ä_·ges
;

11587 
sis
->
·ges
 = 
bsi
.
Ä_·ges
 - 1;

11588 
sis
->
highe¡_b™
 = 
bsi
.
Ä_·ges
 - 1;

11589  
bsi
.
Ä_ex‹Ás
;

11590 
	}
}

11592 
	$bŒfs_sw­_d—ùiv©e
(
fe
 *file)

11594 
	}
}

11596 
	$bŒfs_sw­_aùiv©e
(
sw­_šfo_¡ruù
 *
sis
, 
fe
 *file,

11597 
£ùÜ_t
 *
¥ª
)

11599  -
EOPNOTSUPP
;

11600 
	}
}

11609 
	$bŒfs_upd©e_šode_by‹s
(
bŒfs_šode
 *
šode
,

11610 cÚ¡ 
u64
 
add_by‹s
,

11611 cÚ¡ 
u64
 
d–_by‹s
)

11613 ià(
add_by‹s
 =ğ
d–_by‹s
)

11616 
	`¥š_lock
(&
šode
->
lock
);

11617 ià(
d–_by‹s
 > 0)

11618 
	`šode_sub_by‹s
(&
šode
->
vfs_šode
, 
d–_by‹s
);

11619 ià(
add_by‹s
 > 0)

11620 
	`šode_add_by‹s
(&
šode
->
vfs_šode
, 
add_by‹s
);

11621 
	`¥š_uÆock
(&
šode
->
lock
);

11622 
	}
}

11638 
	$bŒfs_as£¹_šode_¿nge_ş—n
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
)

11640 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

11641 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

11643 ià(!
	`IS_ENABLED
(
CONFIG_BTRFS_ASSERT
))

11646 
Üd”ed
 = 
	`bŒfs_lookup_fœ¡_Üd”ed_¿nge
(
šode
, 
¡¬t
, 
’d
 + 1 - start);

11647 ià(
Üd”ed
) {

11648 
	`bŒfs_”r
(
roÙ
->
fs_šfo
,

11650 
¡¬t
, 
’d
, 
	`bŒfs_šo
(
šode
), 
roÙ
->
roÙ_key
.
objeùid
,

11651 
Üd”ed
->
fe_off£t
,

11652 
Üd”ed
->
fe_off£t
 + ord”ed->
num_by‹s
 - 1);

11653 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

11656 
	`ASSERT
(
Üd”ed
 =ğ
NULL
);

11657 
	}
}

11659 cÚ¡ 
šode_İ”©iÚs
 
	gbŒfs_dœ_šode_İ”©iÚs
 = {

11660 .
g‘©Œ
 = 
bŒfs_g‘©Œ
,

11661 .
	glookup
 = 
bŒfs_lookup_mfs
,

11662 .
	gü—‹
 = 
bŒfs_ü—‹_mfs
,

11663 .
	guÆšk
 = 
bŒfs_uÆšk
,

11664 .
	glšk
 = 
bŒfs_lšk
,

11665 .
	gmkdœ
 = 
bŒfs_mkdœ_mfs
,

11666 .
	grmdœ
 = 
bŒfs_rmdœ
,

11667 .
	g»Çme
 = 
bŒfs_»Çme2
,

11668 .
	gsymlšk
 = 
bŒfs_symlšk
,

11669 .
	g£‰r
 = 
bŒfs_£‰r
,

11670 .
	gmknod
 = 
bŒfs_mknod
,

11671 .
	gli¡x©Œ
 = 
bŒfs_li¡x©Œ
,

11672 .
	g³rmissiÚ
 = 
bŒfs_³rmissiÚ
,

11673 .
	gg‘_šode_aş
 = 
bŒfs_g‘_aş
,

11674 .
	g£t_aş
 = 
bŒfs_£t_aş
,

11675 .
	gupd©e_time
 = 
bŒfs_upd©e_time
,

11676 .
	gtmpfe
 = 
bŒfs_tmpfe
,

11677 .
	gf—‰r_g‘
 = 
bŒfs_f—‰r_g‘
,

11678 .
	gf—‰r_£t
 = 
bŒfs_f—‰r_£t
,

11681 cÚ¡ 
fe_İ”©iÚs
 
	gbŒfs_dœ_fe_İ”©iÚs
 = {

11682 .
Î£ek
 = 
bŒfs_dœ_Î£ek
,

11683 .
	g»ad
 = 
g’”ic_»ad_dœ
,

11684 .
	g™”©e_sh¬ed
 = 
bŒfs_»®_»addœ
,

11685 .
	gİ’
 = 
bŒfs_İ’dœ_mfs
,

11686 .
	guÆocked_ioùl
 = 
bŒfs_ioùl
,

11687 #ifdeà
CONFIG_COMPAT


11688 .
	gcom·t_ioùl
 = 
bŒfs_com·t_ioùl
,

11690 .
	g»Ëa£
 = 
bŒfs_»Ëa£_fe
,

11691 .
	gfsync
 = 
bŒfs_sync_fe
,

11706 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gbŒfs_aİs
 = {

11707 .
»ad_fŞio
 = 
bŒfs_»ad_fŞio
,

11708 .
	gwr™•ages
 = 
bŒfs_wr™•ages
,

11709 .
	g»adah—d
 = 
bŒfs_»adah—d
,

11710 .
	gšv®id©e_fŞio
 = 
bŒfs_šv®id©e_fŞio
,

11711 .
	g»Ëa£_fŞio
 = 
bŒfs_»Ëa£_fŞio
,

11712 .
	gmig¿‹_fŞio
 = 
bŒfs_mig¿‹_fŞio
,

11713 .
	gdœty_fŞio
 = 
fem­_dœty_fŞio
,

11714 .
	g”rÜ_»move_·ge
 = 
g’”ic_”rÜ_»move_·ge
,

11715 .
	gsw­_aùiv©e
 = 
bŒfs_sw­_aùiv©e
,

11716 .
	gsw­_d—ùiv©e
 = 
bŒfs_sw­_d—ùiv©e
,

11719 cÚ¡ 
šode_İ”©iÚs
 
	gbŒfs_fe_šode_İ”©iÚs
 = {

11720 .
g‘©Œ
 = 
bŒfs_g‘©Œ
,

11721 .
	g£‰r
 = 
bŒfs_£‰r
,

11722 .
	gli¡x©Œ
 = 
bŒfs_li¡x©Œ
,

11723 .
	g³rmissiÚ
 = 
bŒfs_³rmissiÚ
,

11724 .
	gf›m­
 = 
bŒfs_f›m­
,

11725 .
	gg‘_šode_aş
 = 
bŒfs_g‘_aş
,

11726 .
	g£t_aş
 = 
bŒfs_£t_aş
,

11727 .
	gupd©e_time
 = 
bŒfs_upd©e_time
,

11728 .
	gf—‰r_g‘
 = 
bŒfs_f—‰r_g‘
,

11729 .
	gf—‰r_£t
 = 
bŒfs_f—‰r_£t
,

11731 cÚ¡ 
šode_İ”©iÚs
 
	gbŒfs_¥ecŸl_šode_İ”©iÚs
 = {

11732 .
g‘©Œ
 = 
bŒfs_g‘©Œ
,

11733 .
	g£‰r
 = 
bŒfs_£‰r
,

11734 .
	g³rmissiÚ
 = 
bŒfs_³rmissiÚ
,

11735 .
	gli¡x©Œ
 = 
bŒfs_li¡x©Œ
,

11736 .
	gg‘_šode_aş
 = 
bŒfs_g‘_aş
,

11737 .
	g£t_aş
 = 
bŒfs_£t_aş
,

11738 .
	gupd©e_time
 = 
bŒfs_upd©e_time
,

11740 cÚ¡ 
šode_İ”©iÚs
 
	gbŒfs_symlšk_šode_İ”©iÚs
 = {

11741 .
g‘_lšk
 = 
·ge_g‘_lšk
,

11742 .
	gg‘©Œ
 = 
bŒfs_g‘©Œ
,

11743 .
	g£‰r
 = 
bŒfs_£‰r
,

11744 .
	g³rmissiÚ
 = 
bŒfs_³rmissiÚ
,

11745 .
	gli¡x©Œ
 = 
bŒfs_li¡x©Œ
,

11746 .
	gupd©e_time
 = 
bŒfs_upd©e_time
,

11749 cÚ¡ 
d’Œy_İ”©iÚs
 
	gbŒfs_d’Œy_İ”©iÚs
 = {

11750 .
d_d–‘e
 = 
bŒfs_d’Œy_d–‘e
,

	@ioctl.c

6 
	~<lšux/k”Ãl.h
>

7 
	~<lšux/bio.h
>

8 
	~<lšux/fe.h
>

9 
	~<lšux/fs.h
>

10 
	~<lšux/f¢Ùify.h
>

11 
	~<lšux/·gem­.h
>

12 
	~<lšux/highmem.h
>

13 
	~<lšux/time.h
>

14 
	~<lšux/¡ršg.h
>

15 
	~<lšux/backšg-dev.h
>

16 
	~<lšux/mouÁ.h
>

17 
	~<lšux/Çmei.h
>

18 
	~<lšux/wr™eback.h
>

19 
	~<lšux/com·t.h
>

20 
	~<lšux/£cur™y.h
>

21 
	~<lšux/x©Œ.h
>

22 
	~<lšux/mm.h
>

23 
	~<lšux/¦ab.h
>

24 
	~<lšux/blkdev.h
>

25 
	~<lšux/uuid.h
>

26 
	~<lšux/bŒfs.h
>

27 
	~<lšux/uacûss.h
>

28 
	~<lšux/iv”siÚ.h
>

29 
	~<lšux/f—‰r.h
>

30 
	~<lšux/fsv”™y.h
>

31 
	~<lšux/sched/xacù.h
>

32 
	~"ù»e.h
"

33 
	~"disk-io.h
"

34 
	~"expÜt.h
"

35 
	~"Œª§ùiÚ.h
"

36 
	~"bŒfs_šode.h
"

37 
	~"´št-Œ“.h
"

38 
	~"vŞumes.h
"

39 
	~"lockšg.h
"

40 
	~"back»f.h
"

41 
	~"rcu-¡ršg.h
"

42 
	~"£nd.h
"

43 
	~"dev-»¶aû.h
"

44 
	~"´İs.h
"

45 
	~"sysfs.h
"

46 
	~"qgroup.h
"

47 
	~"Œ“-log.h
"

48 
	~"com´essiÚ.h
"

49 
	~"¥aû-šfo.h
"

50 
	~"d–®loc-¥aû.h
"

51 
	~"block-group.h
"

52 
	~"sub·ge.h
"

53 
	~"fs.h
"

54 
	~"acûssÜs.h
"

55 
	~"ex‹Á-Œ“.h
"

56 
	~"roÙ-Œ“.h
"

57 
	~"deäag.h
"

58 
	~"dœ-™em.h
"

59 
	~"uuid-Œ“.h
"

60 
	~"ioùl.h
"

61 
	~"fe.h
"

62 
	~"süub.h
"

63 
	~"su³r.h
"

65 #ifdeà
CONFIG_64BIT


71 
	sbŒfs_ioùl_time¥ec_32
 {

72 
__u64
 
	m£c
;

73 
__u32
 
	mn£c
;

74 } 
__©Œibu‹__
 ((
__·cked__
));

76 
	sbŒfs_ioùl_»ûived_subvŞ_¬gs_32
 {

77 
	muuid
[
BTRFS_UUID_SIZE
];

78 
__u64
 
	m¡¿nsid
;

79 
__u64
 
	m¹¿nsid
;

80 
bŒfs_ioùl_time¥ec_32
 
	m¡ime
;

81 
bŒfs_ioùl_time¥ec_32
 
	m¹ime
;

82 
__u64
 
	mæags
;

83 
__u64
 
	m»£rved
[16];

84 } 
__©Œibu‹__
 ((
__·cked__
));

86 
	#BTRFS_IOC_SET_RECEIVED_SUBVOL_32
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 37, \

87 
bŒfs_ioùl_»ûived_subvŞ_¬gs_32
)

	)

90 #ià
defšed
(
CONFIG_64BIT
è&& defšed(
CONFIG_COMPAT
)

91 
	sbŒfs_ioùl_£nd_¬gs_32
 {

92 
__s64
 
	m£nd_fd
;

93 
__u64
 
	mşÚe_sourûs_couÁ
;

94 
com·t_u±r_t
 
	mşÚe_sourûs
;

95 
__u64
 
	m·»Á_roÙ
;

96 
__u64
 
	mæags
;

97 
__u32
 
	mv”siÚ
;

98 
__u8
 
	m»£rved
[28];

99 } 
__©Œibu‹__
 ((
__·cked__
));

101 
	#BTRFS_IOC_SEND_32
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 38, \

102 
bŒfs_ioùl_£nd_¬gs_32
)

	)

104 
	sbŒfs_ioùl_’coded_io_¬gs_32
 {

105 
com·t_u±r_t
 
	miov
;

106 
com·t_ulÚg_t
 
	miovút
;

107 
__s64
 
	moff£t
;

108 
__u64
 
	mæags
;

109 
__u64
 
	mËn
;

110 
__u64
 
	muÃncoded_Ën
;

111 
__u64
 
	muÃncoded_off£t
;

112 
__u32
 
	mcom´essiÚ
;

113 
__u32
 
	m’üy±iÚ
;

114 
__u8
 
	m»£rved
[64];

117 
	#BTRFS_IOC_ENCODED_READ_32
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 64, \

118 
bŒfs_ioùl_’coded_io_¬gs_32
)

	)

119 
	#BTRFS_IOC_ENCODED_WRITE_32
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 64, \

120 
bŒfs_ioùl_’coded_io_¬gs_32
)

	)

124 
	$bŒfs_mask_fsæags_fÜ_ty³
(
šode
 *inode,

125 
æags
)

127 ià(
	`S_ISDIR
(
šode
->
i_mode
))

128  
æags
;

129 ià(
	`S_ISREG
(
šode
->
i_mode
))

130  
æags
 & ~
FS_DIRSYNC_FL
;

132  
æags
 & (
FS_NODUMP_FL
 | 
FS_NOATIME_FL
);

133 
	}
}

139 
	$bŒfs_šode_æags_to_fsæags
(
bŒfs_šode
 *
bšode
)

141 
iæags
 = 0;

142 
u32
 
æags
 = 
bšode
->flags;

143 
u32
 
ro_æags
 = 
bšode
->ro_flags;

145 ià(
æags
 & 
BTRFS_INODE_SYNC
)

146 
iæags
 |ğ
FS_SYNC_FL
;

147 ià(
æags
 & 
BTRFS_INODE_IMMUTABLE
)

148 
iæags
 |ğ
FS_IMMUTABLE_FL
;

149 ià(
æags
 & 
BTRFS_INODE_APPEND
)

150 
iæags
 |ğ
FS_APPEND_FL
;

151 ià(
æags
 & 
BTRFS_INODE_NODUMP
)

152 
iæags
 |ğ
FS_NODUMP_FL
;

153 ià(
æags
 & 
BTRFS_INODE_NOATIME
)

154 
iæags
 |ğ
FS_NOATIME_FL
;

155 ià(
æags
 & 
BTRFS_INODE_DIRSYNC
)

156 
iæags
 |ğ
FS_DIRSYNC_FL
;

157 ià(
æags
 & 
BTRFS_INODE_NODATACOW
)

158 
iæags
 |ğ
FS_NOCOW_FL
;

159 ià(
ro_æags
 & 
BTRFS_INODE_RO_VERITY
)

160 
iæags
 |ğ
FS_VERITY_FL
;

162 ià(
æags
 & 
BTRFS_INODE_NOCOMPRESS
)

163 
iæags
 |ğ
FS_NOCOMP_FL
;

164 ià(
æags
 & 
BTRFS_INODE_COMPRESS
)

165 
iæags
 |ğ
FS_COMPR_FL
;

167  
iæags
;

168 
	}
}

173 
	$bŒfs_sync_šode_æags_to_i_æags
(
šode
 *inode)

175 
bŒfs_šode
 *
bšode
 = 
	`BTRFS_I
(
šode
);

176 
Ãw_æ
 = 0;

178 ià(
bšode
->
æags
 & 
BTRFS_INODE_SYNC
)

179 
Ãw_æ
 |ğ
S_SYNC
;

180 ià(
bšode
->
æags
 & 
BTRFS_INODE_IMMUTABLE
)

181 
Ãw_æ
 |ğ
S_IMMUTABLE
;

182 ià(
bšode
->
æags
 & 
BTRFS_INODE_APPEND
)

183 
Ãw_æ
 |ğ
S_APPEND
;

184 ià(
bšode
->
æags
 & 
BTRFS_INODE_NOATIME
)

185 
Ãw_æ
 |ğ
S_NOATIME
;

186 ià(
bšode
->
æags
 & 
BTRFS_INODE_DIRSYNC
)

187 
Ãw_æ
 |ğ
S_DIRSYNC
;

188 ià(
bšode
->
ro_æags
 & 
BTRFS_INODE_RO_VERITY
)

189 
Ãw_æ
 |ğ
S_VERITY
;

191 
	`£t_mask_b™s
(&
šode
->
i_æags
,

192 
S_SYNC
 | 
S_APPEND
 | 
S_IMMUTABLE
 | 
S_NOATIME
 | 
S_DIRSYNC
 |

193 
S_VERITY
, 
Ãw_æ
);

194 
	}
}

200 
	$check_fsæags
(
Şd_æags
, 
æags
)

202 ià(
æags
 & ~(
FS_IMMUTABLE_FL
 | 
FS_APPEND_FL
 | \

203 
FS_NOATIME_FL
 | 
FS_NODUMP_FL
 | \

204 
FS_SYNC_FL
 | 
FS_DIRSYNC_FL
 | \

205 
FS_NOCOMP_FL
 | 
FS_COMPR_FL
 |

206 
FS_NOCOW_FL
))

207  -
EOPNOTSUPP
;

210 ià((
æags
 & 
FS_NOCOMP_FL
è&& (æag & 
FS_COMPR_FL
))

211  -
EINVAL
;

213 ià((
æags
 & 
FS_COMPR_FL
è&& (æag & 
FS_NOCOW_FL
))

214  -
EINVAL
;

217 ià((
Şd_æags
 & 
FS_NOCOW_FL
è&& (
æags
 & (
FS_COMPR_FL
 | 
FS_NOCOMP_FL
)))

218  -
EINVAL
;

219 ià((
æags
 & 
FS_NOCOW_FL
è&& (
Şd_æags
 & (
FS_COMPR_FL
 | 
FS_NOCOMP_FL
)))

220  -
EINVAL
;

223 
	}
}

225 
	$check_fsæags_com·tibË
(
bŒfs_fs_šfo
 *
fs_šfo
,

226 
æags
)

228 ià(
	`bŒfs_is_zÚed
(
fs_šfo
è&& (
æags
 & 
FS_NOCOW_FL
))

229  -
EPERM
;

232 
	}
}

238 
	$bŒfs_f—‰r_g‘
(
d’Œy
 *d’Œy, 
f—‰r
 *
ç
)

240 
	`´štk
(
KERN_INFO
 "btrfs_fileattr_get: Called...\n");

241 
bŒfs_šode
 *
bšode
 = 
	`BTRFS_I
(
	`d_šode
(
d’Œy
));

243 
	`f—‰r_fl_æags
(
ç
, 
	`bŒfs_šode_æags_to_fsæags
(
bšode
));

245 
	}
}

247 
	$bŒfs_f—‰r_£t
(
mÁ_idm­
 *
idm­
,

248 
d’Œy
 *d’Œy, 
f—‰r
 *
ç
)

250 
	`´štk
(
KERN_INFO
 "btrfs_fileattr_set: Called...\n");

251 
šode
 *šodğ
	`d_šode
(
d’Œy
);

252 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

253 
bŒfs_šode
 *
bšode
 = 
	`BTRFS_I
(
šode
);

254 
bŒfs_roÙ
 *
roÙ
 = 
bšode
->root;

255 
bŒfs_Œªs_hªdË
 *
Œªs
;

256 
fsæags
, 
Şd_fsæags
;

257 
»t
;

258 cÚ¡ *
comp
 = 
NULL
;

259 
u32
 
bšode_æags
;

261 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
))

262  -
EROFS
;

264 ià(
	`f—‰r_has_fsx
(
ç
))

265  -
EOPNOTSUPP
;

267 
fsæags
 = 
	`bŒfs_mask_fsæags_fÜ_ty³
(
šode
, 
ç
->
æags
);

268 
Şd_fsæags
 = 
	`bŒfs_šode_æags_to_fsæags
(
bšode
);

269 
»t
 = 
	`check_fsæags
(
Şd_fsæags
, 
fsæags
);

270 ià(
»t
)

271  
»t
;

273 
»t
 = 
	`check_fsæags_com·tibË
(
fs_šfo
, 
fsæags
);

274 ià(
»t
)

275  
»t
;

277 
bšode_æags
 = 
bšode
->
æags
;

278 ià(
fsæags
 & 
FS_SYNC_FL
)

279 
bšode_æags
 |ğ
BTRFS_INODE_SYNC
;

281 
bšode_æags
 &ğ~
BTRFS_INODE_SYNC
;

282 ià(
fsæags
 & 
FS_IMMUTABLE_FL
)

283 
bšode_æags
 |ğ
BTRFS_INODE_IMMUTABLE
;

285 
bšode_æags
 &ğ~
BTRFS_INODE_IMMUTABLE
;

286 ià(
fsæags
 & 
FS_APPEND_FL
)

287 
bšode_æags
 |ğ
BTRFS_INODE_APPEND
;

289 
bšode_æags
 &ğ~
BTRFS_INODE_APPEND
;

290 ià(
fsæags
 & 
FS_NODUMP_FL
)

291 
bšode_æags
 |ğ
BTRFS_INODE_NODUMP
;

293 
bšode_æags
 &ğ~
BTRFS_INODE_NODUMP
;

294 ià(
fsæags
 & 
FS_NOATIME_FL
)

295 
bšode_æags
 |ğ
BTRFS_INODE_NOATIME
;

297 
bšode_æags
 &ğ~
BTRFS_INODE_NOATIME
;

300 ià(!
ç
->
æags_v®id
) {

302 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

303 ià(
	`IS_ERR
(
Œªs
))

304  
	`PTR_ERR
(
Œªs
);

305 
upd©e_æags
;

308 ià(
fsæags
 & 
FS_DIRSYNC_FL
)

309 
bšode_æags
 |ğ
BTRFS_INODE_DIRSYNC
;

311 
bšode_æags
 &ğ~
BTRFS_INODE_DIRSYNC
;

312 ià(
fsæags
 & 
FS_NOCOW_FL
) {

313 ià(
	`S_ISREG
(
šode
->
i_mode
)) {

319 ià(
šode
->
i_size
 == 0)

320 
bšode_æags
 |ğ
BTRFS_INODE_NODATACOW
 |

321 
BTRFS_INODE_NODATASUM
;

323 
bšode_æags
 |ğ
BTRFS_INODE_NODATACOW
;

329 ià(
	`S_ISREG
(
šode
->
i_mode
)) {

330 ià(
šode
->
i_size
 == 0)

331 
bšode_æags
 &ğ~(
BTRFS_INODE_NODATACOW
 |

332 
BTRFS_INODE_NODATASUM
);

334 
bšode_æags
 &ğ~
BTRFS_INODE_NODATACOW
;

343 ià(
fsæags
 & 
FS_NOCOMP_FL
) {

344 
bšode_æags
 &ğ~
BTRFS_INODE_COMPRESS
;

345 
bšode_æags
 |ğ
BTRFS_INODE_NOCOMPRESS
;

346 } ià(
fsæags
 & 
FS_COMPR_FL
) {

348 ià(
	`IS_SWAPFILE
(
šode
))

349  -
ETXTBSY
;

351 
bšode_æags
 |ğ
BTRFS_INODE_COMPRESS
;

352 
bšode_æags
 &ğ~
BTRFS_INODE_NOCOMPRESS
;

354 
comp
 = 
	`bŒfs_com´ess_ty³2¡r
(
fs_šfo
->
com´ess_ty³
);

355 ià(!
comp
 || comp[0] == 0)

356 
comp
 = 
	`bŒfs_com´ess_ty³2¡r
(
BTRFS_COMPRESS_ZLIB
);

358 
bšode_æags
 &ğ~(
BTRFS_INODE_COMPRESS
 | 
BTRFS_INODE_NOCOMPRESS
);

365 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 3);

366 ià(
	`IS_ERR
(
Œªs
))

367  
	`PTR_ERR
(
Œªs
);

369 ià(
comp
) {

370 
»t
 = 
	`bŒfs_£t_´İ
(
Œªs
, 
šode
, "bŒfs.com´essiÚ", 
comp
,

371 
	`¡¾’
(
comp
), 0);

372 ià(
»t
) {

373 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

374 
out_’d_Œªs
;

377 
»t
 = 
	`bŒfs_£t_´İ
(
Œªs
, 
šode
, "bŒfs.com´essiÚ", 
NULL
,

379 ià(
»t
 &&„‘ !ğ-
ENODATA
) {

380 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

381 
out_’d_Œªs
;

385 
upd©e_æags
:

386 
bšode
->
æags
 = 
bšode_æags
;

387 
	`bŒfs_sync_šode_æags_to_i_æags
(
šode
);

388 
	`šode_šc_iv”siÚ
(
šode
);

389 
	`šode_£t_ùime_cu¼’t
(
šode
);

390 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

392 
out_’d_Œªs
:

393 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

394  
»t
;

395 
	}
}

400 
boŞ
 
	$bŒfs_exşİ_¡¬t
(
bŒfs_fs_šfo
 *
fs_šfo
,

401 
bŒfs_exşusive_İ”©iÚ
 
ty³
)

403 
boŞ
 
»t
 = 
çl£
;

405 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

406 ià(
fs_šfo
->
exşusive_İ”©iÚ
 =ğ
BTRFS_EXCLOP_NONE
) {

407 
fs_šfo
->
exşusive_İ”©iÚ
 = 
ty³
;

408 
»t
 = 
Œue
;

410 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

412  
»t
;

413 
	}
}

426 
boŞ
 
	$bŒfs_exşİ_¡¬t_Œy_lock
(
bŒfs_fs_šfo
 *
fs_šfo
,

427 
bŒfs_exşusive_İ”©iÚ
 
ty³
)

429 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

430 ià(
fs_šfo
->
exşusive_İ”©iÚ
 =ğ
ty³
 ||

431 (
fs_šfo
->
exşusive_İ”©iÚ
 =ğ
BTRFS_EXCLOP_BALANCE_PAUSED
 &&

432 
ty³
 =ğ
BTRFS_EXCLOP_DEV_ADD
))

433  
Œue
;

435 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

436  
çl£
;

437 
	}
}

439 
	$bŒfs_exşİ_¡¬t_uÆock
(
bŒfs_fs_šfo
 *
fs_šfo
)

441 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

442 
	}
}

444 
	$bŒfs_exşİ_fšish
(
bŒfs_fs_šfo
 *
fs_šfo
)

446 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

447 
	`WRITE_ONCE
(
fs_šfo
->
exşusive_İ”©iÚ
, 
BTRFS_EXCLOP_NONE
);

448 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

449 
	`sysfs_nÙify
(&
fs_šfo
->
fs_deviûs
->
fsid_kobj
, 
NULL
, "exclusive_operation");

450 
	}
}

452 
	$bŒfs_exşİ_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
,

453 
bŒfs_exşusive_İ”©iÚ
 
İ
)

455 
İ
) {

456 
BTRFS_EXCLOP_BALANCE_PAUSED
:

457 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

458 
	`ASSERT
(
fs_šfo
->
exşusive_İ”©iÚ
 =ğ
BTRFS_EXCLOP_BALANCE
 ||

459 
fs_šfo
->
exşusive_İ”©iÚ
 =ğ
BTRFS_EXCLOP_DEV_ADD
 ||

460 
fs_šfo
->
exşusive_İ”©iÚ
 =ğ
BTRFS_EXCLOP_NONE
 ||

461 
fs_šfo
->
exşusive_İ”©iÚ
 =ğ
BTRFS_EXCLOP_BALANCE_PAUSED
);

462 
fs_šfo
->
exşusive_İ”©iÚ
 = 
BTRFS_EXCLOP_BALANCE_PAUSED
;

463 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

465 
BTRFS_EXCLOP_BALANCE
:

466 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

467 
	`ASSERT
(
fs_šfo
->
exşusive_İ”©iÚ
 =ğ
BTRFS_EXCLOP_BALANCE_PAUSED
);

468 
fs_šfo
->
exşusive_İ”©iÚ
 = 
BTRFS_EXCLOP_BALANCE
;

469 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

472 
	`bŒfs_w¬n
(
fs_šfo
,

473 "šv®idƒxşİ b®ªû o³¿tiÚ %d„eque¡ed", 
İ
);

475 
	}
}

477 
	$bŒfs_ioùl_g‘v”siÚ
(
šode
 *šode, 
__u£r
 *
¬g
)

479  
	`put_u£r
(
šode
->
i_g’”©iÚ
, 
¬g
);

480 
	}
}

482 
nošlše
 
	$bŒfs_ioùl_f™rim
(
bŒfs_fs_šfo
 *
fs_šfo
,

483 
__u£r
 *
¬g
)

485 
bŒfs_deviû
 *
deviû
;

486 
f¡rim_¿nge
 
¿nge
;

487 
u64
 
mšËn
 = 
ULLONG_MAX
;

488 
u64
 
num_deviûs
 = 0;

489 
»t
;

491 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

492  -
EPERM
;

499 ià(
	`bŒfs_is_zÚed
(
fs_šfo
))

500  -
EOPNOTSUPP
;

509 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
NOLOGREPLAY
))

510  -
EROFS
;

512 
	`rcu_»ad_lock
();

513 
	`li¡_fÜ_—ch_’Œy_rcu
(
deviû
, &
fs_šfo
->
fs_deviûs
->
deviûs
,

514 
dev_li¡
) {

515 ià(!
deviû
->
bdev
 || !
	`bdev_max_disÿrd_£ùÜs
(device->bdev))

517 
num_deviûs
++;

518 
mšËn
 = 
	`mš_t
(
u64
, 
	`bdev_disÿrd_g¿nuÏr™y
(
deviû
->
bdev
),

519 
mšËn
);

521 
	`rcu_»ad_uÆock
();

523 ià(!
num_deviûs
)

524  -
EOPNOTSUPP
;

525 ià(
	`cİy_äom_u£r
(&
¿nge
, 
¬g
, (range)))

526  -
EFAULT
;

533 ià(
¿nge
.
Ën
 < 
fs_šfo
->
sb
->
s_blocksize
)

534  -
EINVAL
;

536 
¿nge
.
mšËn
 = 
	`max
(range.minlen, minlen);

537 
»t
 = 
	`bŒfs_Œim_fs
(
fs_šfo
, &
¿nge
);

538 ià(
»t
 < 0)

539  
»t
;

541 ià(
	`cİy_to_u£r
(
¬g
, &
¿nge
, (range)))

542  -
EFAULT
;

545 
	}
}

547 
__pu»
 
	$bŒfs_is_em±y_uuid
(
u8
 *
uuid
)

549 
i
;

551 
i
 = 0; i < 
BTRFS_UUID_SIZE
; i++) {

552 ià(
uuid
[
i
])

556 
	}
}

562 
	$ü—‹_subvŞ_num_™ems
(
bŒfs_qgroup_šh”™
 *
šh”™
)

576 
num_™ems
 = 7;

578 ià(
šh”™
) {

580 
num_™ems
 +ğ2 * 
šh”™
->
num_qgroups
;

582  
num_™ems
;

583 
	}
}

585 
nošlše
 
	$ü—‹_subvŞ
(
mÁ_idm­
 *
idm­
,

586 
šode
 *
dœ
, 
d’Œy
 *dentry,

587 
bŒfs_qgroup_šh”™
 *
šh”™
)

589 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

590 
bŒfs_Œªs_hªdË
 *
Œªs
;

591 
bŒfs_key
 
key
;

592 
bŒfs_roÙ_™em
 *
roÙ_™em
;

593 
bŒfs_šode_™em
 *
šode_™em
;

594 
ex‹Á_bufãr
 *
Ëaf
;

595 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

596 
bŒfs_roÙ
 *
Ãw_roÙ
;

597 
bŒfs_block_rsv
 
block_rsv
;

598 
time¥ec64
 
cur_time
 = 
	`cu¼’t_time
(
dœ
);

599 
bŒfs_Ãw_šode_¬gs
 
Ãw_šode_¬gs
 = {

600 .
dœ
 = dir,

601 .
d’Œy
 = dentry,

602 .
subvŞ
 = 
Œue
,

604 
Œªs_num_™ems
;

605 
»t
;

606 
dev_t
 
ªÚ_dev
;

607 
u64
 
objeùid
;

609 
roÙ_™em
 = 
	`kz®loc
((*roÙ_™em), 
GFP_KERNEL
);

610 ià(!
roÙ_™em
)

611  -
ENOMEM
;

613 
»t
 = 
	`bŒfs_g‘_ä“_objeùid
(
fs_šfo
->
Œ“_roÙ
, &
objeùid
);

614 ià(
»t
)

615 
out_roÙ_™em
;

621 ià(
	`bŒfs_qgroup_Ëv–
(
objeùid
)) {

622 
»t
 = -
ENOSPC
;

623 
out_roÙ_™em
;

626 
»t
 = 
	`g‘_ªÚ_bdev
(&
ªÚ_dev
);

627 ià(
»t
 < 0)

628 
out_roÙ_™em
;

630 
Ãw_šode_¬gs
.
šode
 = 
	`bŒfs_Ãw_subvŞ_šode
(
idm­
, 
dœ
);

631 ià(!
Ãw_šode_¬gs
.
šode
) {

632 
»t
 = -
ENOMEM
;

633 
out_ªÚ_dev
;

635 
»t
 = 
	`bŒfs_Ãw_šode_´•¬e
(&
Ãw_šode_¬gs
, &
Œªs_num_™ems
);

636 ià(
»t
)

637 
out_šode
;

638 
Œªs_num_™ems
 +ğ
	`ü—‹_subvŞ_num_™ems
(
šh”™
);

640 
	`bŒfs_š™_block_rsv
(&
block_rsv
, 
BTRFS_BLOCK_RSV_TEMP
);

641 
»t
 = 
	`bŒfs_subvŞume_»£rve_m‘ad©a
(
roÙ
, &
block_rsv
,

642 
Œªs_num_™ems
, 
çl£
);

643 ià(
»t
)

644 
out_Ãw_šode_¬gs
;

646 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

647 ià(
	`IS_ERR
(
Œªs
)) {

648 
»t
 = 
	`PTR_ERR
(
Œªs
);

649 
	`bŒfs_subvŞume_»Ëa£_m‘ad©a
(
roÙ
, &
block_rsv
);

650 
out_Ãw_šode_¬gs
;

652 
Œªs
->
block_rsv
 = &block_rsv;

653 
Œªs
->
by‹s_»£rved
 = 
block_rsv
.
size
;

655 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

657 
»t
 = 
	`bŒfs_qgroup_šh”™
(
Œªs
, 0, 
objeùid
, 
šh”™
);

658 ià(
»t
)

659 
out
;

661 
Ëaf
 = 
	`bŒfs_®loc_Œ“_block
(
Œªs
, 
roÙ
, 0, 
objeùid
, 
NULL
, 0, 0, 0,

662 
BTRFS_NESTING_NORMAL
);

663 ià(
	`IS_ERR
(
Ëaf
)) {

664 
»t
 = 
	`PTR_ERR
(
Ëaf
);

665 
out
;

668 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

670 
šode_™em
 = &
roÙ_™em
->
šode
;

671 
	`bŒfs_£t_¡ack_šode_g’”©iÚ
(
šode_™em
, 1);

672 
	`bŒfs_£t_¡ack_šode_size
(
šode_™em
, 3);

673 
	`bŒfs_£t_¡ack_šode_Æšk
(
šode_™em
, 1);

674 
	`bŒfs_£t_¡ack_šode_nby‹s
(
šode_™em
,

675 
fs_šfo
->
nodesize
);

676 
	`bŒfs_£t_¡ack_šode_mode
(
šode_™em
, 
S_IFDIR
 | 0755);

678 
	`bŒfs_£t_roÙ_æags
(
roÙ_™em
, 0);

679 
	`bŒfs_£t_roÙ_lim™
(
roÙ_™em
, 0);

680 
	`bŒfs_£t_¡ack_šode_æags
(
šode_™em
, 
BTRFS_INODE_ROOT_ITEM_INIT
);

682 
	`bŒfs_£t_roÙ_by‹Ä
(
roÙ_™em
, 
Ëaf
->
¡¬t
);

683 
	`bŒfs_£t_roÙ_g’”©iÚ
(
roÙ_™em
, 
Œªs
->
Œªsid
);

684 
	`bŒfs_£t_roÙ_Ëv–
(
roÙ_™em
, 0);

685 
	`bŒfs_£t_roÙ_»fs
(
roÙ_™em
, 1);

686 
	`bŒfs_£t_roÙ_u£d
(
roÙ_™em
, 
Ëaf
->
Ën
);

687 
	`bŒfs_£t_roÙ_Ï¡_¢­shÙ
(
roÙ_™em
, 0);

689 
	`bŒfs_£t_roÙ_g’”©iÚ_v2
(
roÙ_™em
,

690 
	`bŒfs_roÙ_g’”©iÚ
(
roÙ_™em
));

691 
	`g’”©e_¿ndom_guid
(
roÙ_™em
->
uuid
);

692 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
roÙ_™em
->
Ùime
, 
cur_time
.
tv_£c
);

693 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
roÙ_™em
->
Ùime
, 
cur_time
.
tv_n£c
);

694 
roÙ_™em
->
ùime
 =„oÙ_™em->
Ùime
;

695 
	`bŒfs_£t_roÙ_ù¿nsid
(
roÙ_™em
, 
Œªs
->
Œªsid
);

696 
	`bŒfs_£t_roÙ_Ù¿nsid
(
roÙ_™em
, 
Œªs
->
Œªsid
);

698 
	`bŒfs_Œ“_uÆock
(
Ëaf
);

700 
	`bŒfs_£t_roÙ_dœid
(
roÙ_™em
, 
BTRFS_FIRST_FREE_OBJECTID
);

702 
key
.
objeùid
 = objectid;

703 
key
.
off£t
 = 0;

704 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

705 
»t
 = 
	`bŒfs_š£¹_roÙ
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
, &
key
,

706 
roÙ_™em
);

707 ià(
»t
) {

715 
	`bŒfs_Œ“_lock
(
Ëaf
);

716 
	`bŒfs_ş—r_bufãr_dœty
(
Œªs
, 
Ëaf
);

717 
	`bŒfs_Œ“_uÆock
(
Ëaf
);

718 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
objeùid
, 
Ëaf
, 0, 1);

719 
	`ä“_ex‹Á_bufãr
(
Ëaf
);

720 
out
;

723 
	`ä“_ex‹Á_bufãr
(
Ëaf
);

724 
Ëaf
 = 
NULL
;

726 
Ãw_roÙ
 = 
	`bŒfs_g‘_Ãw_fs_roÙ
(
fs_šfo
, 
objeùid
, 
ªÚ_dev
);

727 ià(
	`IS_ERR
(
Ãw_roÙ
)) {

728 
»t
 = 
	`PTR_ERR
(
Ãw_roÙ
);

729 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

730 
out
;

733 
ªÚ_dev
 = 0;

734 
	`BTRFS_I
(
Ãw_šode_¬gs
.
šode
)->
roÙ
 = 
Ãw_roÙ
;

737 
»t
 = 
	`bŒfs_»cÜd_roÙ_š_Œªs
(
Œªs
, 
Ãw_roÙ
);

738 ià(
»t
) {

739 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

740 
out
;

743 
»t
 = 
	`bŒfs_uuid_Œ“_add
(
Œªs
, 
roÙ_™em
->
uuid
,

744 
BTRFS_UUID_KEY_SUBVOL
, 
objeùid
);

745 ià(
»t
) {

746 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

747 
out
;

750 
»t
 = 
	`bŒfs_ü—‹_Ãw_šode
(
Œªs
, &
Ãw_šode_¬gs
);

751 ià(
»t
) {

752 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

753 
out
;

756 
	`d_š¡ªtŸ‹_Ãw
(
d’Œy
, 
Ãw_šode_¬gs
.
šode
);

757 
Ãw_šode_¬gs
.
šode
 = 
NULL
;

759 
out
:

760 
Œªs
->
block_rsv
 = 
NULL
;

761 
Œªs
->
by‹s_»£rved
 = 0;

762 
	`bŒfs_subvŞume_»Ëa£_m‘ad©a
(
roÙ
, &
block_rsv
);

764 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

765 
out_Ãw_šode_¬gs
:

766 
	`bŒfs_Ãw_šode_¬gs_de¡roy
(&
Ãw_šode_¬gs
);

767 
out_šode
:

768 
	`ut
(
Ãw_šode_¬gs
.
šode
);

769 
out_ªÚ_dev
:

770 ià(
ªÚ_dev
)

771 
	`ä“_ªÚ_bdev
(
ªÚ_dev
);

772 
out_roÙ_™em
:

773 
	`kä“
(
roÙ_™em
);

774  
»t
;

775 
	}
}

777 
	$ü—‹_¢­shÙ
(
bŒfs_roÙ
 *
roÙ
, 
šode
 *
dœ
,

778 
d’Œy
 *d’Œy, 
boŞ
 
»adÚly
,

779 
bŒfs_qgroup_šh”™
 *
šh”™
)

781 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

782 
šode
 *inode;

783 
bŒfs_³ndšg_¢­shÙ
 *
³ndšg_¢­shÙ
;

784 
Œªs_num_™ems
;

785 
bŒfs_Œªs_hªdË
 *
Œªs
;

786 
»t
;

789 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
EXTENT_TREE_V2
)) {

790 
	`bŒfs_w¬n
(
fs_šfo
,

792  -
EOPNOTSUPP
;

795 ià(!
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
))

796  -
EINVAL
;

798 ià(
	`©omic_»ad
(&
roÙ
->
Ä_sw­fes
)) {

799 
	`bŒfs_w¬n
(
fs_šfo
,

801  -
ETXTBSY
;

804 
³ndšg_¢­shÙ
 = 
	`kz®loc
((*³ndšg_¢­shÙ), 
GFP_KERNEL
);

805 ià(!
³ndšg_¢­shÙ
)

806  -
ENOMEM
;

808 
»t
 = 
	`g‘_ªÚ_bdev
(&
³ndšg_¢­shÙ
->
ªÚ_dev
);

809 ià(
»t
 < 0)

810 
ä“_³ndšg
;

811 
³ndšg_¢­shÙ
->
roÙ_™em
 = 
	`kz®loc
((
bŒfs_roÙ_™em
),

812 
GFP_KERNEL
);

813 
³ndšg_¢­shÙ
->
·th
 = 
	`bŒfs_®loc_·th
();

814 ià(!
³ndšg_¢­shÙ
->
roÙ_™em
 || !³ndšg_¢­shÙ->
·th
) {

815 
»t
 = -
ENOMEM
;

816 
ä“_³ndšg
;

819 
	`bŒfs_š™_block_rsv
(&
³ndšg_¢­shÙ
->
block_rsv
,

820 
BTRFS_BLOCK_RSV_TEMP
);

826 
Œªs_num_™ems
 = 
	`ü—‹_subvŞ_num_™ems
(
šh”™
) + 3;

827 
»t
 = 
	`bŒfs_subvŞume_»£rve_m‘ad©a
(
	`BTRFS_I
(
dœ
)->
roÙ
,

828 &
³ndšg_¢­shÙ
->
block_rsv
,

829 
Œªs_num_™ems
, 
çl£
);

830 ià(
»t
)

831 
ä“_³ndšg
;

833 
³ndšg_¢­shÙ
->
d’Œy
 = dentry;

834 
³ndšg_¢­shÙ
->
roÙ
 =„oot;

835 
³ndšg_¢­shÙ
->
»adÚly
 =„eadonly;

836 
³ndšg_¢­shÙ
->
dœ
 = dir;

837 
³ndšg_¢­shÙ
->
šh”™
 = inherit;

839 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

840 ià(
	`IS_ERR
(
Œªs
)) {

841 
»t
 = 
	`PTR_ERR
(
Œªs
);

842 
ç
;

845 
Œªs
->
³ndšg_¢­shÙ
 =…ending_snapshot;

847 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

848 ià(
»t
)

849 
ç
;

851 
»t
 = 
³ndšg_¢­shÙ
->
”rÜ
;

852 ià(
»t
)

853 
ç
;

855 
»t
 = 
	`bŒfs_Üphª_ş—nup
(
³ndšg_¢­shÙ
->
¢­
);

856 ià(
»t
)

857 
ç
;

859 
šode
 = 
	`bŒfs_lookup_d’Œy
(
	`d_šode
(
d’Œy
->
d_·»Á
), dentry);

860 ià(
	`IS_ERR
(
šode
)) {

861 
»t
 = 
	`PTR_ERR
(
šode
);

862 
ç
;

865 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

866 
»t
 = 0;

867 
³ndšg_¢­shÙ
->
ªÚ_dev
 = 0;

868 
ç
:

870 ià(
»t
 && 
³ndšg_¢­shÙ
->
¢­
)

871 
³ndšg_¢­shÙ
->
¢­
->
ªÚ_dev
 = 0;

872 
	`bŒfs_put_roÙ
(
³ndšg_¢­shÙ
->
¢­
);

873 
	`bŒfs_subvŞume_»Ëa£_m‘ad©a
(
roÙ
, &
³ndšg_¢­shÙ
->
block_rsv
);

874 
ä“_³ndšg
:

875 ià(
³ndšg_¢­shÙ
->
ªÚ_dev
)

876 
	`ä“_ªÚ_bdev
(
³ndšg_¢­shÙ
->
ªÚ_dev
);

877 
	`kä“
(
³ndšg_¢­shÙ
->
roÙ_™em
);

878 
	`bŒfs_ä“_·th
(
³ndšg_¢­shÙ
->
·th
);

879 
	`kä“
(
³ndšg_¢­shÙ
);

881  
»t
;

882 
	}
}

904 
	$bŒfs_may_d–‘e
(
mÁ_idm­
 *
idm­
,

905 
šode
 *
dœ
, 
d’Œy
 *
viùim
, 
isdœ
)

907 
”rÜ
;

909 ià(
	`d_»®ly_is_Ãg©ive
(
viùim
))

910  -
ENOENT
;

912 
	`BUG_ON
(
	`d_šode
(
viùim
->
d_·»Á
è!ğ
dœ
);

913 
	`aud™_šode_chd
(
dœ
, 
viùim
, 
AUDIT_TYPE_CHILD_DELETE
);

915 
”rÜ
 = 
	`šode_³rmissiÚ
(
idm­
, 
dœ
, 
MAY_WRITE
 | 
MAY_EXEC
);

916 ià(
”rÜ
)

917  
”rÜ
;

918 ià(
	`IS_APPEND
(
dœ
))

919  -
EPERM
;

920 ià(
	`check_¡icky
(
idm­
, 
dœ
, 
	`d_šode
(
viùim
)) ||

921 
	`IS_APPEND
(
	`d_šode
(
viùim
)è|| 
	`IS_IMMUTABLE
(d_inode(victim)) ||

922 
	`IS_SWAPFILE
(
	`d_šode
(
viùim
)))

923  -
EPERM
;

924 ià(
isdœ
) {

925 ià(!
	`d_is_dœ
(
viùim
))

926  -
ENOTDIR
;

927 ià(
	`IS_ROOT
(
viùim
))

928  -
EBUSY
;

929 } ià(
	`d_is_dœ
(
viùim
))

930  -
EISDIR
;

931 ià(
	`IS_DEADDIR
(
dœ
))

932  -
ENOENT
;

933 ià(
viùim
->
d_æags
 & 
DCACHE_NFSFS_RENAMED
)

934  -
EBUSY
;

936 
	}
}

939 
šlše
 
	$bŒfs_may_ü—‹
(
mÁ_idm­
 *
idm­
,

940 
šode
 *
dœ
, 
d’Œy
 *
chd
)

942 ià(
	`d_»®ly_is_pos™ive
(
chd
))

943  -
EEXIST
;

944 ià(
	`IS_DEADDIR
(
dœ
))

945  -
ENOENT
;

946 ià(!
	`fsuidgid_has_m­pšg
(
dœ
->
i_sb
, 
idm­
))

947  -
EOVERFLOW
;

948  
	`šode_³rmissiÚ
(
idm­
, 
dœ
, 
MAY_WRITE
 | 
MAY_EXEC
);

949 
	}
}

956 
nošlše
 
	$bŒfs_mksubvŞ
(cÚ¡ 
·th
 *
·»Á
,

957 
mÁ_idm­
 *
idm­
,

958 cÚ¡ *
Çme
, 
Çm–’
,

959 
bŒfs_roÙ
 *
¢­_¤c
,

960 
boŞ
 
»adÚly
,

961 
bŒfs_qgroup_šh”™
 *
šh”™
)

963 
šode
 *
dœ
 = 
	`d_šode
(
·»Á
->
d’Œy
);

964 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

965 
d’Œy
 *dentry;

966 
fsüy±_¡r
 
Çme_¡r
 = 
	`FSTR_INIT
((*)
Çme
, 
Çm–’
);

967 
”rÜ
;

969 
”rÜ
 = 
	`down_wr™e_kÏbË_Ã¡ed
(&
dœ
->
i_rw£m
, 
I_MUTEX_PARENT
);

970 ià(
”rÜ
 =ğ-
EINTR
)

971  
”rÜ
;

973 
d’Œy
 = 
	`lookup_Úe
(
idm­
, 
Çme
, 
·»Á
->d’Œy, 
Çm–’
);

974 
”rÜ
 = 
	`PTR_ERR
(
d’Œy
);

975 ià(
	`IS_ERR
(
d’Œy
))

976 
out_uÆock
;

978 
”rÜ
 = 
	`bŒfs_may_ü—‹
(
idm­
, 
dœ
, 
d’Œy
);

979 ià(
”rÜ
)

980 
out_dput
;

986 
”rÜ
 = 
	`bŒfs_check_dœ_™em_cŞlisiÚ
(
	`BTRFS_I
(
dœ
)->
roÙ
,

987 
dœ
->
i_šo
, &
Çme_¡r
);

988 ià(
”rÜ
)

989 
out_dput
;

991 
	`down_»ad
(&
fs_šfo
->
subvŞ_£m
);

993 ià(
	`bŒfs_roÙ_»fs
(&
	`BTRFS_I
(
dœ
)->
roÙ
->
roÙ_™em
) == 0)

994 
out_up_»ad
;

996 ià(
¢­_¤c
)

997 
”rÜ
 = 
	`ü—‹_¢­shÙ
(
¢­_¤c
, 
dœ
, 
d’Œy
, 
»adÚly
, 
šh”™
);

999 
”rÜ
 = 
	`ü—‹_subvŞ
(
idm­
, 
dœ
, 
d’Œy
, 
šh”™
);

1001 ià(!
”rÜ
)

1002 
	`f¢Ùify_mkdœ
(
dœ
, 
d’Œy
);

1003 
out_up_»ad
:

1004 
	`up_»ad
(&
fs_šfo
->
subvŞ_£m
);

1005 
out_dput
:

1006 
	`dput
(
d’Œy
);

1007 
out_uÆock
:

1008 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
dœ
), 0);

1009  
”rÜ
;

1010 
	}
}

1012 
nošlše
 
	$bŒfs_mk¢­shÙ
(cÚ¡ 
·th
 *
·»Á
,

1013 
mÁ_idm­
 *
idm­
,

1014 cÚ¡ *
Çme
, 
Çm–’
,

1015 
bŒfs_roÙ
 *
roÙ
,

1016 
boŞ
 
»adÚly
,

1017 
bŒfs_qgroup_šh”™
 *
šh”™
)

1019 
»t
;

1020 
boŞ
 
¢­shÙ_fÜû_cow
 = 
çl£
;

1027 
	`bŒfs_d»w_»ad_lock
(&
roÙ
->
¢­shÙ_lock
);

1029 
»t
 = 
	`bŒfs_¡¬t_d–®loc_¢­shÙ
(
roÙ
, 
çl£
);

1030 ià(
»t
)

1031 
out
;

1038 
	`©omic_šc
(&
roÙ
->
¢­shÙ_fÜû_cow
);

1039 
¢­shÙ_fÜû_cow
 = 
Œue
;

1041 
	`bŒfs_wa™_Üd”ed_ex‹Ás
(
roÙ
, 
U64_MAX
, 0, (
u64
)-1);

1043 
»t
 = 
	`bŒfs_mksubvŞ
(
·»Á
, 
idm­
, 
Çme
, 
Çm–’
,

1044 
roÙ
, 
»adÚly
, 
šh”™
);

1045 
out
:

1046 ià(
¢­shÙ_fÜû_cow
)

1047 
	`©omic_dec
(&
roÙ
->
¢­shÙ_fÜû_cow
);

1048 
	`bŒfs_d»w_»ad_uÆock
(&
roÙ
->
¢­shÙ_lock
);

1049  
»t
;

1050 
	}
}

1062 
	$exşİ_¡¬t_Ü_ÿnûl_»loc
(
bŒfs_fs_šfo
 *
fs_šfo
,

1063 
bŒfs_exşusive_İ”©iÚ
 
ty³
, 
boŞ
 
ÿnûl
)

1065 ià(!
ÿnûl
) {

1067 ià(!
	`bŒfs_exşİ_¡¬t
(
fs_šfo
, 
ty³
))

1068  
BTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
;

1074 ià(
	`bŒfs_exşİ_¡¬t_Œy_lock
(
fs_šfo
, 
ty³
)) {

1080 
	`©omic_šc
(&
fs_šfo
->
»loc_ÿnûl_»q
);

1081 
	`bŒfs_exşİ_¡¬t_uÆock
(
fs_šfo
);

1083 ià(
	`‹¡_b™
(
BTRFS_FS_RELOC_RUNNING
, &
fs_šfo
->
æags
))

1084 
	`wa™_Ú_b™
(&
fs_šfo
->
æags
, 
BTRFS_FS_RELOC_RUNNING
,

1085 
TASK_INTERRUPTIBLE
);

1087  -
ECANCELED
;

1091  -
ENOTCONN
;

1092 
	}
}

1094 
nošlše
 
	$bŒfs_ioùl_»size
(
fe
 *file,

1095 
__u£r
 *
¬g
)

1097 
	`BTRFS_DEV_LOOKUP_ARGS
(
¬gs
);

1098 
šode
 *šodğ
	`fe_šode
(
fe
);

1099 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1100 
u64
 
Ãw_size
;

1101 
u64
 
Şd_size
;

1102 
u64
 
devid
 = 1;

1103 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

1104 
bŒfs_ioùl_vŞ_¬gs
 *
vŞ_¬gs
;

1105 
bŒfs_Œªs_hªdË
 *
Œªs
;

1106 
bŒfs_deviû
 *
deviû
 = 
NULL
;

1107 *
size¡r
;

1108 *
»Œ
;

1109 *
dev¡r
 = 
NULL
;

1110 
»t
 = 0;

1111 
mod
 = 0;

1112 
boŞ
 
ÿnûl
;

1114 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1115  -
EPERM
;

1117 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

1118 ià(
»t
)

1119  
»t
;

1125 
vŞ_¬gs
 = 
	`memdup_u£r
(
¬g
, (*vol_args));

1126 ià(
	`IS_ERR
(
vŞ_¬gs
)) {

1127 
»t
 = 
	`PTR_ERR
(
vŞ_¬gs
);

1128 
out_drİ
;

1130 
vŞ_¬gs
->
Çme
[
BTRFS_PATH_NAME_MAX
] = '\0';

1131 
size¡r
 = 
vŞ_¬gs
->
Çme
;

1132 
ÿnûl
 = (
	`¡rcmp
("ÿnûl", 
size¡r
) == 0);

1133 
»t
 = 
	`exşİ_¡¬t_Ü_ÿnûl_»loc
(
fs_šfo
, 
BTRFS_EXCLOP_RESIZE
, 
ÿnûl
);

1134 ià(
»t
)

1135 
out_ä“
;

1138 
dev¡r
 = 
	`¡rchr
(
size¡r
, ':');

1139 ià(
dev¡r
) {

1140 
size¡r
 = 
dev¡r
 + 1;

1141 *
dev¡r
 = '\0';

1142 
dev¡r
 = 
vŞ_¬gs
->
Çme
;

1143 
»t
 = 
	`k¡¹ouÎ
(
dev¡r
, 10, &
devid
);

1144 ià(
»t
)

1145 
out_fšish
;

1146 ià(!
devid
) {

1147 
»t
 = -
EINVAL
;

1148 
out_fšish
;

1150 
	`bŒfs_šfo
(
fs_šfo
, "»sizšg devid %Îu", 
devid
);

1153 
¬gs
.
devid
 = devid;

1154 
deviû
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, &
¬gs
);

1155 ià(!
deviû
) {

1156 
	`bŒfs_šfo
(
fs_šfo
, "resizer unableo find device %llu",

1157 
devid
);

1158 
»t
 = -
ENODEV
;

1159 
out_fšish
;

1162 ià(!
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
)) {

1163 
	`bŒfs_šfo
(
fs_šfo
,

1165 
devid
);

1166 
»t
 = -
EPERM
;

1167 
out_fšish
;

1170 ià(!
	`¡rcmp
(
size¡r
, "max"))

1171 
Ãw_size
 = 
	`bdev_Ä_by‹s
(
deviû
->
bdev
);

1173 ià(
size¡r
[0] == '-') {

1174 
mod
 = -1;

1175 
size¡r
++;

1176 } ià(
size¡r
[0] == '+') {

1177 
mod
 = 1;

1178 
size¡r
++;

1180 
Ãw_size
 = 
	`mem·r£
(
size¡r
, &
»Œ
);

1181 ià(*
»Œ
 !ğ'\0' || 
Ãw_size
 == 0) {

1182 
»t
 = -
EINVAL
;

1183 
out_fšish
;

1187 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
)) {

1188 
»t
 = -
EPERM
;

1189 
out_fšish
;

1192 
Şd_size
 = 
	`bŒfs_deviû_g‘_tÙ®_by‹s
(
deviû
);

1194 ià(
mod
 < 0) {

1195 ià(
Ãw_size
 > 
Şd_size
) {

1196 
»t
 = -
EINVAL
;

1197 
out_fšish
;

1199 
Ãw_size
 = 
Şd_size
 -‚ew_size;

1200 } ià(
mod
 > 0) {

1201 ià(
Ãw_size
 > 
ULLONG_MAX
 - 
Şd_size
) {

1202 
»t
 = -
ERANGE
;

1203 
out_fšish
;

1205 
Ãw_size
 = 
Şd_size
 +‚ew_size;

1208 ià(
Ãw_size
 < 
SZ_256M
) {

1209 
»t
 = -
EINVAL
;

1210 
out_fšish
;

1212 ià(
Ãw_size
 > 
	`bdev_Ä_by‹s
(
deviû
->
bdev
)) {

1213 
»t
 = -
EFBIG
;

1214 
out_fšish
;

1217 
Ãw_size
 = 
	`round_down
Òew_size, 
fs_šfo
->
£ùÜsize
);

1219 ià(
Ãw_size
 > 
Şd_size
) {

1220 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

1221 ià(
	`IS_ERR
(
Œªs
)) {

1222 
»t
 = 
	`PTR_ERR
(
Œªs
);

1223 
out_fšish
;

1225 
»t
 = 
	`bŒfs_grow_deviû
(
Œªs
, 
deviû
, 
Ãw_size
);

1226 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1227 } ià(
Ãw_size
 < 
Şd_size
) {

1228 
»t
 = 
	`bŒfs_shršk_deviû
(
deviû
, 
Ãw_size
);

1231 ià(
»t
 =ğ0 && 
Ãw_size
 !ğ
Şd_size
)

1232 
	`bŒfs_šfo_š_rcu
(
fs_šfo
,

1234 
	`bŒfs_dev_Çme
(
deviû
), deviû->
devid
,

1235 
Şd_size
, 
Ãw_size
);

1236 
out_fšish
:

1237 
	`bŒfs_exşİ_fšish
(
fs_šfo
);

1238 
out_ä“
:

1239 
	`kä“
(
vŞ_¬gs
);

1240 
out_drİ
:

1241 
	`mÁ_drİ_wr™e_fe
(
fe
);

1242  
»t
;

1243 
	}
}

1245 
nošlše
 
	$__bŒfs_ioùl_¢­_ü—‹
(
fe
 *file,

1246 
mÁ_idm­
 *
idm­
,

1247 cÚ¡ *
Çme
, 
fd
, 
subvŞ
,

1248 
boŞ
 
»adÚly
,

1249 
bŒfs_qgroup_šh”™
 *
šh”™
)

1251 
Çm–’
;

1252 
»t
 = 0;

1254 ià(!
	`S_ISDIR
(
	`fe_šode
(
fe
)->
i_mode
))

1255  -
ENOTDIR
;

1257 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

1258 ià(
»t
)

1259 
out
;

1261 
Çm–’
 = 
	`¡¾’
(
Çme
);

1262 ià(
	`¡rchr
(
Çme
, '/')) {

1263 
»t
 = -
EINVAL
;

1264 
out_drİ_wr™e
;

1267 ià(
Çme
[0] == '.' &&

1268 (
Çm–’
 =ğ1 || (
Çme
[1] == '.' &&‚amelen == 2))) {

1269 
»t
 = -
EEXIST
;

1270 
out_drİ_wr™e
;

1273 ià(
subvŞ
) {

1274 
»t
 = 
	`bŒfs_mksubvŞ
(&
fe
->
f_·th
, 
idm­
, 
Çme
,

1275 
Çm–’
, 
NULL
, 
»adÚly
, 
šh”™
);

1277 
fd
 
¤c
 = 
	`fdg‘
(fd);

1278 
šode
 *
¤c_šode
;

1279 ià(!
¤c
.
fe
) {

1280 
»t
 = -
EINVAL
;

1281 
out_drİ_wr™e
;

1284 
¤c_šode
 = 
	`fe_šode
(
¤c
.
fe
);

1285 ià(
¤c_šode
->
i_sb
 !ğ
	`fe_šode
(
fe
)->i_sb) {

1286 
	`bŒfs_šfo
(
	`BTRFS_I
(
	`fe_šode
(
fe
))->
roÙ
->
fs_šfo
,

1288 
»t
 = -
EXDEV
;

1289 } ià(!
	`šode_owÃr_Ü_ÿ·bË
(
idm­
, 
¤c_šode
)) {

1294 
»t
 = -
EPERM
;

1295 } ià(
	`bŒfs_šo
(
	`BTRFS_I
(
¤c_šode
)è!ğ
BTRFS_FIRST_FREE_OBJECTID
) {

1303 
»t
 = -
EINVAL
;

1305 
»t
 = 
	`bŒfs_mk¢­shÙ
(&
fe
->
f_·th
, 
idm­
,

1306 
Çme
, 
Çm–’
,

1307 
	`BTRFS_I
(
¤c_šode
)->
roÙ
,

1308 
»adÚly
, 
šh”™
);

1310 
	`fdput
(
¤c
);

1312 
out_drİ_wr™e
:

1313 
	`mÁ_drİ_wr™e_fe
(
fe
);

1314 
out
:

1315  
»t
;

1316 
	}
}

1318 
nošlše
 
	$bŒfs_ioùl_¢­_ü—‹
(
fe
 *file,

1319 
__u£r
 *
¬g
, 
subvŞ
)

1321 
bŒfs_ioùl_vŞ_¬gs
 *
vŞ_¬gs
;

1322 
»t
;

1324 ià(!
	`S_ISDIR
(
	`fe_šode
(
fe
)->
i_mode
))

1325  -
ENOTDIR
;

1327 
vŞ_¬gs
 = 
	`memdup_u£r
(
¬g
, (*vol_args));

1328 ià(
	`IS_ERR
(
vŞ_¬gs
))

1329  
	`PTR_ERR
(
vŞ_¬gs
);

1330 
vŞ_¬gs
->
Çme
[
BTRFS_PATH_NAME_MAX
] = '\0';

1332 
»t
 = 
	`__bŒfs_ioùl_¢­_ü—‹
(
fe
, 
	`fe_mÁ_idm­
(file),

1333 
vŞ_¬gs
->
Çme
, vŞ_¬gs->
fd
, 
subvŞ
,

1334 
çl£
, 
NULL
);

1336 
	`kä“
(
vŞ_¬gs
);

1337  
»t
;

1338 
	}
}

1340 
nošlše
 
	$bŒfs_ioùl_¢­_ü—‹_v2
(
fe
 *file,

1341 
__u£r
 *
¬g
, 
subvŞ
)

1343 
bŒfs_ioùl_vŞ_¬gs_v2
 *
vŞ_¬gs
;

1344 
»t
;

1345 
boŞ
 
»adÚly
 = 
çl£
;

1346 
bŒfs_qgroup_šh”™
 *
šh”™
 = 
NULL
;

1348 ià(!
	`S_ISDIR
(
	`fe_šode
(
fe
)->
i_mode
))

1349  -
ENOTDIR
;

1351 
vŞ_¬gs
 = 
	`memdup_u£r
(
¬g
, (*vol_args));

1352 ià(
	`IS_ERR
(
vŞ_¬gs
))

1353  
	`PTR_ERR
(
vŞ_¬gs
);

1354 
vŞ_¬gs
->
Çme
[
BTRFS_SUBVOL_NAME_MAX
] = '\0';

1356 ià(
vŞ_¬gs
->
æags
 & ~
BTRFS_SUBVOL_CREATE_ARGS_MASK
) {

1357 
»t
 = -
EOPNOTSUPP
;

1358 
ä“_¬gs
;

1361 ià(
vŞ_¬gs
->
æags
 & 
BTRFS_SUBVOL_RDONLY
)

1362 
»adÚly
 = 
Œue
;

1363 ià(
vŞ_¬gs
->
æags
 & 
BTRFS_SUBVOL_QGROUP_INHERIT
) {

1364 
u64
 
nums
;

1366 ià(
vŞ_¬gs
->
size
 < (*
šh”™
) ||

1367 
vŞ_¬gs
->
size
 > 
PAGE_SIZE
) {

1368 
»t
 = -
EINVAL
;

1369 
ä“_¬gs
;

1371 
šh”™
 = 
	`memdup_u£r
(
vŞ_¬gs
->
qgroup_šh”™
, vŞ_¬gs->
size
);

1372 ià(
	`IS_ERR
(
šh”™
)) {

1373 
»t
 = 
	`PTR_ERR
(
šh”™
);

1374 
ä“_¬gs
;

1377 ià(
šh”™
->
num_qgroups
 > 
PAGE_SIZE
 ||

1378 
šh”™
->
num_»f_cİ›s
 > 
PAGE_SIZE
 ||

1379 
šh”™
->
num_exş_cİ›s
 > 
PAGE_SIZE
) {

1380 
»t
 = -
EINVAL
;

1381 
ä“_šh”™
;

1384 
nums
 = 
šh”™
->
num_qgroups
 + 2 * inh”™->
num_»f_cİ›s
 +

1385 2 * 
šh”™
->
num_exş_cİ›s
;

1386 ià(
vŞ_¬gs
->
size
 !ğ
	`¡ruù_size
(
šh”™
, 
qgroups
, 
nums
)) {

1387 
»t
 = -
EINVAL
;

1388 
ä“_šh”™
;

1392 
»t
 = 
	`__bŒfs_ioùl_¢­_ü—‹
(
fe
, 
	`fe_mÁ_idm­
(file),

1393 
vŞ_¬gs
->
Çme
, vŞ_¬gs->
fd
, 
subvŞ
,

1394 
»adÚly
, 
šh”™
);

1395 ià(
»t
)

1396 
ä“_šh”™
;

1397 
ä“_šh”™
:

1398 
	`kä“
(
šh”™
);

1399 
ä“_¬gs
:

1400 
	`kä“
(
vŞ_¬gs
);

1401  
»t
;

1402 
	}
}

1404 
nošlše
 
	$bŒfs_ioùl_subvŞ_g‘æags
(
šode
 *inode,

1405 
__u£r
 *
¬g
)

1407 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1408 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

1409 
»t
 = 0;

1410 
u64
 
æags
 = 0;

1412 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)è!ğ
BTRFS_FIRST_FREE_OBJECTID
)

1413  -
EINVAL
;

1415 
	`down_»ad
(&
fs_šfo
->
subvŞ_£m
);

1416 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
))

1417 
æags
 |ğ
BTRFS_SUBVOL_RDONLY
;

1418 
	`up_»ad
(&
fs_šfo
->
subvŞ_£m
);

1420 ià(
	`cİy_to_u£r
(
¬g
, &
æags
, (flags)))

1421 
»t
 = -
EFAULT
;

1423  
»t
;

1424 
	}
}

1426 
nošlše
 
	$bŒfs_ioùl_subvŞ_£tæags
(
fe
 *file,

1427 
__u£r
 *
¬g
)

1429 
šode
 *šodğ
	`fe_šode
(
fe
);

1430 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1431 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

1432 
bŒfs_Œªs_hªdË
 *
Œªs
;

1433 
u64
 
roÙ_æags
;

1434 
u64
 
æags
;

1435 
»t
 = 0;

1437 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
	`fe_mÁ_idm­
(
fe
), 
šode
))

1438  -
EPERM
;

1440 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

1441 ià(
»t
)

1442 
out
;

1444 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)è!ğ
BTRFS_FIRST_FREE_OBJECTID
) {

1445 
»t
 = -
EINVAL
;

1446 
out_drİ_wr™e
;

1449 ià(
	`cİy_äom_u£r
(&
æags
, 
¬g
, (flags))) {

1450 
»t
 = -
EFAULT
;

1451 
out_drİ_wr™e
;

1454 ià(
æags
 & ~
BTRFS_SUBVOL_RDONLY
) {

1455 
»t
 = -
EOPNOTSUPP
;

1456 
out_drİ_wr™e
;

1459 
	`down_wr™e
(&
fs_šfo
->
subvŞ_£m
);

1462 ià(!!(
æags
 & 
BTRFS_SUBVOL_RDONLY
è=ğ
	`bŒfs_roÙ_»adÚly
(
roÙ
))

1463 
out_drİ_£m
;

1465 
roÙ_æags
 = 
	`bŒfs_roÙ_æags
(&
roÙ
->
roÙ_™em
);

1466 ià(
æags
 & 
BTRFS_SUBVOL_RDONLY
) {

1467 
	`bŒfs_£t_roÙ_æags
(&
roÙ
->
roÙ_™em
,

1468 
roÙ_æags
 | 
BTRFS_ROOT_SUBVOL_RDONLY
);

1474 
	`¥š_lock
(&
roÙ
->
roÙ_™em_lock
);

1475 ià(
roÙ
->
£nd_š_´og»ss
 == 0) {

1476 
	`bŒfs_£t_roÙ_æags
(&
roÙ
->
roÙ_™em
,

1477 
roÙ_æags
 & ~
BTRFS_ROOT_SUBVOL_RDONLY
);

1478 
	`¥š_uÆock
(&
roÙ
->
roÙ_™em_lock
);

1480 
	`¥š_uÆock
(&
roÙ
->
roÙ_™em_lock
);

1481 
	`bŒfs_w¬n
(
fs_šfo
,

1483 
roÙ
->
roÙ_key
.
objeùid
);

1484 
»t
 = -
EPERM
;

1485 
out_drİ_£m
;

1489 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

1490 ià(
	`IS_ERR
(
Œªs
)) {

1491 
»t
 = 
	`PTR_ERR
(
Œªs
);

1492 
out_»£t
;

1495 
»t
 = 
	`bŒfs_upd©e_roÙ
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
,

1496 &
roÙ
->
roÙ_key
, &roÙ->
roÙ_™em
);

1497 ià(
»t
 < 0) {

1498 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1499 
out_»£t
;

1502 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1504 
out_»£t
:

1505 ià(
»t
)

1506 
	`bŒfs_£t_roÙ_æags
(&
roÙ
->
roÙ_™em
, 
roÙ_æags
);

1507 
out_drİ_£m
:

1508 
	`up_wr™e
(&
fs_šfo
->
subvŞ_£m
);

1509 
out_drİ_wr™e
:

1510 
	`mÁ_drİ_wr™e_fe
(
fe
);

1511 
out
:

1512  
»t
;

1513 
	}
}

1515 
nošlše
 
	$key_š_sk
(
bŒfs_key
 *
key
,

1516 
bŒfs_ioùl_£¬ch_key
 *
sk
)

1518 
bŒfs_key
 
‹¡
;

1519 
»t
;

1521 
‹¡
.
objeùid
 = 
sk
->
mš_objeùid
;

1522 
‹¡
.
ty³
 = 
sk
->
mš_ty³
;

1523 
‹¡
.
off£t
 = 
sk
->
mš_off£t
;

1525 
»t
 = 
	`bŒfs_comp_ıu_keys
(
key
, &
‹¡
);

1526 ià(
»t
 < 0)

1529 
‹¡
.
objeùid
 = 
sk
->
max_objeùid
;

1530 
‹¡
.
ty³
 = 
sk
->
max_ty³
;

1531 
‹¡
.
off£t
 = 
sk
->
max_off£t
;

1533 
»t
 = 
	`bŒfs_comp_ıu_keys
(
key
, &
‹¡
);

1534 ià(
»t
 > 0)

1537 
	}
}

1539 
nošlše
 
	$cİy_to_sk
(
bŒfs_·th
 *
·th
,

1540 
bŒfs_key
 *
key
,

1541 
bŒfs_ioùl_£¬ch_key
 *
sk
,

1542 
u64
 *
buf_size
,

1543 
__u£r
 *
ubuf
,

1544 *
sk_off£t
,

1545 *
num_found
)

1547 
u64
 
found_Œªsid
;

1548 
ex‹Á_bufãr
 *
Ëaf
;

1549 
bŒfs_ioùl_£¬ch_h—d”
 
sh
;

1550 
bŒfs_key
 
‹¡
;

1551 
™em_off
;

1552 
™em_Ën
;

1553 
Ä™ems
;

1554 
i
;

1555 
¦Ù
;

1556 
»t
 = 0;

1558 
Ëaf
 = 
·th
->
nodes
[0];

1559 
¦Ù
 = 
·th
->
¦Ùs
[0];

1560 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

1562 ià(
	`bŒfs_h—d”_g’”©iÚ
(
Ëaf
è> 
sk
->
max_Œªsid
) {

1563 
i
 = 
Ä™ems
;

1564 
advªû_key
;

1566 
found_Œªsid
 = 
	`bŒfs_h—d”_g’”©iÚ
(
Ëaf
);

1568 
i
 = 
¦Ù
; i < 
Ä™ems
; i++) {

1569 
™em_off
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
i
);

1570 
™em_Ën
 = 
	`bŒfs_™em_size
(
Ëaf
, 
i
);

1572 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, 
key
, 
i
);

1573 ià(!
	`key_š_sk
(
key
, 
sk
))

1576 ià((
sh
è+ 
™em_Ën
 > *
buf_size
) {

1577 ià(*
num_found
) {

1578 
»t
 = 1;

1579 
out
;

1587 *
buf_size
 = (
sh
è+ 
™em_Ën
;

1588 
™em_Ën
 = 0;

1589 
»t
 = -
EOVERFLOW
;

1592 ià((
sh
è+ 
™em_Ën
 + *
sk_off£t
 > *
buf_size
) {

1593 
»t
 = 1;

1594 
out
;

1597 
sh
.
objeùid
 = 
key
->objectid;

1598 
sh
.
off£t
 = 
key
->offset;

1599 
sh
.
ty³
 = 
key
->type;

1600 
sh
.
Ën
 = 
™em_Ën
;

1601 
sh
.
Œªsid
 = 
found_Œªsid
;

1609 ià(
	`cİy_to_u£r_noçuÉ
(
ubuf
 + *
sk_off£t
, &
sh
, (sh))) {

1610 
»t
 = 0;

1611 
out
;

1614 *
sk_off£t
 +ğ(
sh
);

1616 ià(
™em_Ën
) {

1617 
__u£r
 *
up
 = 
ubuf
 + *
sk_off£t
;

1622 ià(
	`»ad_ex‹Á_bufãr_to_u£r_noçuÉ
(
Ëaf
, 
up
,

1623 
™em_off
, 
™em_Ën
)) {

1624 
»t
 = 0;

1625 *
sk_off£t
 -ğ(
sh
);

1626 
out
;

1629 *
sk_off£t
 +ğ
™em_Ën
;

1631 (*
num_found
)++;

1633 ià(
»t
)

1634 
out
;

1636 ià(*
num_found
 >ğ
sk
->
Ä_™ems
) {

1637 
»t
 = 1;

1638 
out
;

1641 
advªû_key
:

1642 
»t
 = 0;

1643 
‹¡
.
objeùid
 = 
sk
->
max_objeùid
;

1644 
‹¡
.
ty³
 = 
sk
->
max_ty³
;

1645 
‹¡
.
off£t
 = 
sk
->
max_off£t
;

1646 ià(
	`bŒfs_comp_ıu_keys
(
key
, &
‹¡
) >= 0)

1647 
»t
 = 1;

1648 ià(
key
->
off£t
 < (
u64
)-1)

1649 
key
->
off£t
++;

1650 ià(
key
->
ty³
 < (
u8
)-1) {

1651 
key
->
off£t
 = 0;

1652 
key
->
ty³
++;

1653 } ià(
key
->
objeùid
 < (
u64
)-1) {

1654 
key
->
off£t
 = 0;

1655 
key
->
ty³
 = 0;

1656 
key
->
objeùid
++;

1658 
»t
 = 1;

1659 
out
:

1669  
»t
;

1670 
	}
}

1672 
nošlše
 
	$£¬ch_ioùl
(
šode
 *inode,

1673 
bŒfs_ioùl_£¬ch_key
 *
sk
,

1674 
u64
 *
buf_size
,

1675 
__u£r
 *
ubuf
)

1677 
bŒfs_fs_šfo
 *
šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1678 
bŒfs_roÙ
 *
roÙ
;

1679 
bŒfs_key
 
key
;

1680 
bŒfs_·th
 *
·th
;

1681 
»t
;

1682 
num_found
 = 0;

1683 
sk_off£t
 = 0;

1685 ià(*
buf_size
 < (
bŒfs_ioùl_£¬ch_h—d”
)) {

1686 *
buf_size
 = (
bŒfs_ioùl_£¬ch_h—d”
);

1687  -
EOVERFLOW
;

1690 
·th
 = 
	`bŒfs_®loc_·th
();

1691 ià(!
·th
)

1692  -
ENOMEM
;

1694 ià(
sk
->
Œ“_id
 == 0) {

1696 
roÙ
 = 
	`bŒfs_g¿b_roÙ
(
	`BTRFS_I
(
šode
)->root);

1698 
roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
šfo
, 
sk
->
Œ“_id
, 
Œue
);

1699 ià(
	`IS_ERR
(
roÙ
)) {

1700 
	`bŒfs_ä“_·th
(
·th
);

1701  
	`PTR_ERR
(
roÙ
);

1705 
key
.
objeùid
 = 
sk
->
mš_objeùid
;

1706 
key
.
ty³
 = 
sk
->
mš_ty³
;

1707 
key
.
off£t
 = 
sk
->
mš_off£t
;

1710 
»t
 = -
EFAULT
;

1715 ià(
	`çuÉ_š_sub·ge_wr™—bË
(
ubuf
 + 
sk_off£t
,

1716 *
buf_size
 - 
sk_off£t
))

1719 
»t
 = 
	`bŒfs_£¬ch_fÜw¬d
(
roÙ
, &
key
, 
·th
, 
sk
->
mš_Œªsid
);

1720 ià(
»t
 != 0) {

1721 ià(
»t
 > 0)

1722 
»t
 = 0;

1723 
”r
;

1725 
»t
 = 
	`cİy_to_sk
(
·th
, &
key
, 
sk
, 
buf_size
, 
ubuf
,

1726 &
sk_off£t
, &
num_found
);

1727 
	`bŒfs_»Ëa£_·th
(
·th
);

1728 ià(
»t
)

1732 ià(
»t
 > 0)

1733 
»t
 = 0;

1734 
”r
:

1735 
sk
->
Ä_™ems
 = 
num_found
;

1736 
	`bŒfs_put_roÙ
(
roÙ
);

1737 
	`bŒfs_ä“_·th
(
·th
);

1738  
»t
;

1739 
	}
}

1741 
nošlše
 
	$bŒfs_ioùl_Œ“_£¬ch
(
šode
 *inode,

1742 
__u£r
 *
¬gp
)

1744 
bŒfs_ioùl_£¬ch_¬gs
 
__u£r
 *
u¬gs
 = 
¬gp
;

1745 
bŒfs_ioùl_£¬ch_key
 
sk
;

1746 
»t
;

1747 
u64
 
buf_size
;

1749 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1750  -
EPERM
;

1752 ià(
	`cİy_äom_u£r
(&
sk
, &
u¬gs
->
key
, (sk)))

1753  -
EFAULT
;

1755 
buf_size
 = (
u¬gs
->
buf
);

1757 
»t
 = 
	`£¬ch_ioùl
(
šode
, &
sk
, &
buf_size
, 
u¬gs
->
buf
);

1763 ià(
»t
 =ğ-
EOVERFLOW
)

1764 
»t
 = 0;

1766 ià(
»t
 =ğ0 && 
	`cİy_to_u£r
(&
u¬gs
->
key
, &
sk
, (sk)))

1767 
»t
 = -
EFAULT
;

1768  
»t
;

1769 
	}
}

1771 
nošlše
 
	$bŒfs_ioùl_Œ“_£¬ch_v2
(
šode
 *inode,

1772 
__u£r
 *
¬gp
)

1774 
bŒfs_ioùl_£¬ch_¬gs_v2
 
__u£r
 *
u¬g
 = 
¬gp
;

1775 
bŒfs_ioùl_£¬ch_¬gs_v2
 
¬gs
;

1776 
»t
;

1777 
u64
 
buf_size
;

1778 cÚ¡ 
u64
 
buf_lim™
 = 
SZ_16M
;

1780 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1781  -
EPERM
;

1784 ià(
	`cİy_äom_u£r
(&
¬gs
, 
u¬g
, (args)))

1785  -
EFAULT
;

1787 
buf_size
 = 
¬gs
.buf_size;

1790 ià(
buf_size
 > 
buf_lim™
)

1791 
buf_size
 = 
buf_lim™
;

1793 
»t
 = 
	`£¬ch_ioùl
(
šode
, &
¬gs
.
key
, &
buf_size
,

1794 (
__u£r
 *)(&
u¬g
->
buf
[0]));

1795 ià(
»t
 =ğ0 && 
	`cİy_to_u£r
(&
u¬g
->
key
, &
¬gs
.key, (args.key)))

1796 
»t
 = -
EFAULT
;

1797 ià(
»t
 =ğ-
EOVERFLOW
 &&

1798 
	`cİy_to_u£r
(&
u¬g
->
buf_size
, &buf_size, (buf_size)))

1799 
»t
 = -
EFAULT
;

1801  
»t
;

1802 
	}
}

1808 
nošlše
 
	$bŒfs_£¬ch_·th_š_Œ“
(
bŒfs_fs_šfo
 *
šfo
,

1809 
u64
 
Œ“_id
, u64 
dœid
, *
Çme
)

1811 
bŒfs_roÙ
 *
roÙ
;

1812 
bŒfs_key
 
key
;

1813 *
±r
;

1814 
»t
 = -1;

1815 
¦Ù
;

1816 
Ën
;

1817 
tÙ®_Ën
 = 0;

1818 
bŒfs_šode_»f
 *
œef
;

1819 
ex‹Á_bufãr
 *
l
;

1820 
bŒfs_·th
 *
·th
;

1822 ià(
dœid
 =ğ
BTRFS_FIRST_FREE_OBJECTID
) {

1823 
Çme
[0]='\0';

1827 
·th
 = 
	`bŒfs_®loc_·th
();

1828 ià(!
·th
)

1829  -
ENOMEM
;

1831 
±r
 = &
Çme
[
BTRFS_INO_LOOKUP_PATH_MAX
 - 1];

1833 
roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
šfo
, 
Œ“_id
, 
Œue
);

1834 ià(
	`IS_ERR
(
roÙ
)) {

1835 
»t
 = 
	`PTR_ERR
(
roÙ
);

1836 
roÙ
 = 
NULL
;

1837 
out
;

1840 
key
.
objeùid
 = 
dœid
;

1841 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

1842 
key
.
off£t
 = (
u64
)-1;

1845 
»t
 = 
	`bŒfs_£¬ch_backw¬ds
(
roÙ
, &
key
, 
·th
);

1846 ià(
»t
 < 0)

1847 
out
;

1848 ià(
»t
 > 0) {

1849 
»t
 = -
ENOENT
;

1850 
out
;

1853 
l
 = 
·th
->
nodes
[0];

1854 
¦Ù
 = 
·th
->
¦Ùs
[0];

1856 
œef
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
, 
bŒfs_šode_»f
);

1857 
Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
l
, 
œef
);

1858 
±r
 -ğ
Ën
 + 1;

1859 
tÙ®_Ën
 +ğ
Ën
 + 1;

1860 ià(
±r
 < 
Çme
) {

1861 
»t
 = -
ENAMETOOLONG
;

1862 
out
;

1865 *(
±r
 + 
Ën
) = '/';

1866 
	`»ad_ex‹Á_bufãr
(
l
, 
±r
, ()(
œef
 + 1), 
Ën
);

1868 ià(
key
.
off£t
 =ğ
BTRFS_FIRST_FREE_OBJECTID
)

1871 
	`bŒfs_»Ëa£_·th
(
·th
);

1872 
key
.
objeùid
 = key.
off£t
;

1873 
key
.
off£t
 = (
u64
)-1;

1874 
dœid
 = 
key
.
objeùid
;

1876 
	`memmove
(
Çme
, 
±r
, 
tÙ®_Ën
);

1877 
Çme
[
tÙ®_Ën
] = '\0';

1878 
»t
 = 0;

1879 
out
:

1880 
	`bŒfs_put_roÙ
(
roÙ
);

1881 
	`bŒfs_ä“_·th
(
·th
);

1882  
»t
;

1883 
	}
}

1885 
	$bŒfs_£¬ch_·th_š_Œ“_u£r
(
mÁ_idm­
 *
idm­
,

1886 
šode
 *inode,

1887 
bŒfs_ioùl_šo_lookup_u£r_¬gs
 *
¬gs
)

1889 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`BTRFS_I
(
šode
)->
roÙ
->fs_info;

1890 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

1891 
bŒfs_key
 
uµ”_lim™
 = 
	`BTRFS_I
(
šode
)->
loÿtiÚ
;

1892 
u64
 
Œ“id
 = 
	`BTRFS_I
(
šode
)->
roÙ
->
roÙ_key
.
objeùid
;

1893 
u64
 
dœid
 = 
¬gs
->dirid;

1894 
™em_off
;

1895 
™em_Ën
;

1896 
bŒfs_šode_»f
 *
œef
;

1897 
bŒfs_roÙ_»f
 *
¼ef
;

1898 
bŒfs_roÙ
 *
roÙ
 = 
NULL
;

1899 
bŒfs_·th
 *
·th
;

1900 
bŒfs_key
 
key
, 
key2
;

1901 
ex‹Á_bufãr
 *
Ëaf
;

1902 
šode
 *
‹mp_šode
;

1903 *
±r
;

1904 
¦Ù
;

1905 
Ën
;

1906 
tÙ®_Ën
 = 0;

1907 
»t
;

1909 
·th
 = 
	`bŒfs_®loc_·th
();

1910 ià(!
·th
)

1911  -
ENOMEM
;

1917 ià(
dœid
 !ğ
uµ”_lim™
.
objeùid
) {

1918 
±r
 = &
¬gs
->
·th
[
BTRFS_INO_LOOKUP_USER_PATH_MAX
 - 1];

1920 
roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
Œ“id
, 
Œue
);

1921 ià(
	`IS_ERR
(
roÙ
)) {

1922 
»t
 = 
	`PTR_ERR
(
roÙ
);

1923 
out
;

1926 
key
.
objeùid
 = 
dœid
;

1927 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

1928 
key
.
off£t
 = (
u64
)-1;

1930 
»t
 = 
	`bŒfs_£¬ch_backw¬ds
(
roÙ
, &
key
, 
·th
);

1931 ià(
»t
 < 0)

1932 
out_put
;

1933 ià(
»t
 > 0) {

1934 
»t
 = -
ENOENT
;

1935 
out_put
;

1938 
Ëaf
 = 
·th
->
nodes
[0];

1939 
¦Ù
 = 
·th
->
¦Ùs
[0];

1941 
œef
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_šode_»f
);

1942 
Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
Ëaf
, 
œef
);

1943 
±r
 -ğ
Ën
 + 1;

1944 
tÙ®_Ën
 +ğ
Ën
 + 1;

1945 ià(
±r
 < 
¬gs
->
·th
) {

1946 
»t
 = -
ENAMETOOLONG
;

1947 
out_put
;

1950 *(
±r
 + 
Ën
) = '/';

1951 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
±r
,

1952 ()(
œef
 + 1), 
Ën
);

1955 
»t
 = 
	`bŒfs_´evious_™em
(
roÙ
, 
·th
, 
dœid
,

1956 
BTRFS_INODE_ITEM_KEY
);

1957 ià(
»t
 < 0) {

1958 
out_put
;

1959 } ià(
»t
 > 0) {

1960 
»t
 = -
ENOENT
;

1961 
out_put
;

1964 
Ëaf
 = 
·th
->
nodes
[0];

1965 
¦Ù
 = 
·th
->
¦Ùs
[0];

1966 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key2
, 
¦Ù
);

1967 ià(
key2
.
objeùid
 !ğ
dœid
) {

1968 
»t
 = -
ENOENT
;

1969 
out_put
;

1978 
	`bŒfs_»Ëa£_·th
(
·th
);

1979 
‹mp_šode
 = 
	`bŒfs_ig‘
(
sb
, 
key2
.
objeùid
, 
roÙ
);

1980 ià(
	`IS_ERR
(
‹mp_šode
)) {

1981 
»t
 = 
	`PTR_ERR
(
‹mp_šode
);

1982 
out_put
;

1984 
»t
 = 
	`šode_³rmissiÚ
(
idm­
, 
‹mp_šode
,

1985 
MAY_READ
 | 
MAY_EXEC
);

1986 
	`ut
(
‹mp_šode
);

1987 ià(
»t
) {

1988 
»t
 = -
EACCES
;

1989 
out_put
;

1992 ià(
key
.
off£t
 =ğ
uµ”_lim™
.
objeùid
)

1994 ià(
key
.
objeùid
 =ğ
BTRFS_FIRST_FREE_OBJECTID
) {

1995 
»t
 = -
EACCES
;

1996 
out_put
;

1999 
key
.
objeùid
 = key.
off£t
;

2000 
key
.
off£t
 = (
u64
)-1;

2001 
dœid
 = 
key
.
objeùid
;

2004 
	`memmove
(
¬gs
->
·th
, 
±r
, 
tÙ®_Ën
);

2005 
¬gs
->
·th
[
tÙ®_Ën
] = '\0';

2006 
	`bŒfs_put_roÙ
(
roÙ
);

2007 
roÙ
 = 
NULL
;

2008 
	`bŒfs_»Ëa£_·th
(
·th
);

2012 
key
.
objeùid
 = 
Œ“id
;

2013 
key
.
ty³
 = 
BTRFS_ROOT_REF_KEY
;

2014 
key
.
off£t
 = 
¬gs
->
Œ“id
;

2015 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_šfo
->
Œ“_roÙ
, &
key
, 
·th
, 0, 0);

2016 ià(
»t
 < 0) {

2017 
out
;

2018 } ià(
»t
 > 0) {

2019 
»t
 = -
ENOENT
;

2020 
out
;

2023 
Ëaf
 = 
·th
->
nodes
[0];

2024 
¦Ù
 = 
·th
->
¦Ùs
[0];

2025 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

2027 
™em_off
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
);

2028 
™em_Ën
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

2030 
¼ef
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_roÙ_»f
);

2031 ià(
¬gs
->
dœid
 !ğ
	`bŒfs_roÙ_»f_dœid
(
Ëaf
, 
¼ef
)) {

2032 
»t
 = -
EINVAL
;

2033 
out
;

2037 
™em_off
 +ğ(
bŒfs_roÙ_»f
);

2038 
™em_Ën
 -ğ(
bŒfs_roÙ_»f
);

2039 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
¬gs
->
Çme
, 
™em_off
, 
™em_Ën
);

2040 
¬gs
->
Çme
[
™em_Ën
] = 0;

2042 
out_put
:

2043 
	`bŒfs_put_roÙ
(
roÙ
);

2044 
out
:

2045 
	`bŒfs_ä“_·th
(
·th
);

2046  
»t
;

2047 
	}
}

2049 
nošlše
 
	$bŒfs_ioùl_šo_lookup
(
bŒfs_roÙ
 *
roÙ
,

2050 
__u£r
 *
¬gp
)

2052 
bŒfs_ioùl_šo_lookup_¬gs
 *
¬gs
;

2053 
»t
 = 0;

2055 
¬gs
 = 
	`memdup_u£r
(
¬gp
, (*args));

2056 ià(
	`IS_ERR
(
¬gs
))

2057  
	`PTR_ERR
(
¬gs
);

2063 ià(
¬gs
->
Œ“id
 == 0)

2064 
¬gs
->
Œ“id
 = 
roÙ
->
roÙ_key
.
objeùid
;

2066 ià(
¬gs
->
objeùid
 =ğ
BTRFS_FIRST_FREE_OBJECTID
) {

2067 
¬gs
->
Çme
[0] = 0;

2068 
out
;

2071 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
)) {

2072 
»t
 = -
EPERM
;

2073 
out
;

2076 
»t
 = 
	`bŒfs_£¬ch_·th_š_Œ“
(
roÙ
->
fs_šfo
,

2077 
¬gs
->
Œ“id
,‡rgs->
objeùid
,

2078 
¬gs
->
Çme
);

2080 
out
:

2081 ià(
»t
 =ğ0 && 
	`cİy_to_u£r
(
¬gp
, 
¬gs
, (*args)))

2082 
»t
 = -
EFAULT
;

2084 
	`kä“
(
¬gs
);

2085  
»t
;

2086 
	}
}

2100 
	$bŒfs_ioùl_šo_lookup_u£r
(
fe
 *fe, 
__u£r
 *
¬gp
)

2102 
bŒfs_ioùl_šo_lookup_u£r_¬gs
 *
¬gs
;

2103 
šode
 *inode;

2104 
»t
;

2106 
¬gs
 = 
	`memdup_u£r
(
¬gp
, (*args));

2107 ià(
	`IS_ERR
(
¬gs
))

2108  
	`PTR_ERR
(
¬gs
);

2110 
šode
 = 
	`fe_šode
(
fe
);

2112 ià(
¬gs
->
dœid
 =ğ
BTRFS_FIRST_FREE_OBJECTID
 &&

2113 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
objeùid
 !ğ
BTRFS_FIRST_FREE_OBJECTID
) {

2118 
	`kä“
(
¬gs
);

2119  -
EACCES
;

2122 
»t
 = 
	`bŒfs_£¬ch_·th_š_Œ“_u£r
(
	`fe_mÁ_idm­
(
fe
), 
šode
, 
¬gs
);

2124 ià(
»t
 =ğ0 && 
	`cİy_to_u£r
(
¬gp
, 
¬gs
, (*args)))

2125 
»t
 = -
EFAULT
;

2127 
	`kä“
(
¬gs
);

2128  
»t
;

2129 
	}
}

2132 
	$bŒfs_ioùl_g‘_subvŞ_šfo
(
šode
 *šode, 
__u£r
 *
¬gp
)

2134 
bŒfs_ioùl_g‘_subvŞ_šfo_¬gs
 *
subvŞ_šfo
;

2135 
bŒfs_fs_šfo
 *
fs_šfo
;

2136 
bŒfs_roÙ
 *
roÙ
;

2137 
bŒfs_·th
 *
·th
;

2138 
bŒfs_key
 
key
;

2139 
bŒfs_roÙ_™em
 *
roÙ_™em
;

2140 
bŒfs_roÙ_»f
 *
¼ef
;

2141 
ex‹Á_bufãr
 *
Ëaf
;

2142 
™em_off
;

2143 
™em_Ën
;

2144 
¦Ù
;

2145 
»t
 = 0;

2147 
·th
 = 
	`bŒfs_®loc_·th
();

2148 ià(!
·th
)

2149  -
ENOMEM
;

2151 
subvŞ_šfo
 = 
	`kz®loc
((*subvŞ_šfo), 
GFP_KERNEL
);

2152 ià(!
subvŞ_šfo
) {

2153 
	`bŒfs_ä“_·th
(
·th
);

2154  -
ENOMEM
;

2157 
fs_šfo
 = 
	`BTRFS_I
(
šode
)->
roÙ
->fs_info;

2160 
key
.
objeùid
 = 
	`BTRFS_I
(
šode
)->
roÙ
->
roÙ_key
.objectid;

2161 
roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
key
.
objeùid
, 
Œue
);

2162 ià(
	`IS_ERR
(
roÙ
)) {

2163 
»t
 = 
	`PTR_ERR
(
roÙ
);

2164 
out_ä“
;

2166 
roÙ_™em
 = &
roÙ
->root_item;

2168 
subvŞ_šfo
->
Œ“id
 = 
key
.
objeùid
;

2170 
subvŞ_šfo
->
g’”©iÚ
 = 
	`bŒfs_roÙ_g’”©iÚ
(
roÙ_™em
);

2171 
subvŞ_šfo
->
æags
 = 
	`bŒfs_roÙ_æags
(
roÙ_™em
);

2173 
	`memıy
(
subvŞ_šfo
->
uuid
, 
roÙ_™em
->uuid, 
BTRFS_UUID_SIZE
);

2174 
	`memıy
(
subvŞ_šfo
->
·»Á_uuid
, 
roÙ_™em
->parent_uuid,

2175 
BTRFS_UUID_SIZE
);

2176 
	`memıy
(
subvŞ_šfo
->
»ûived_uuid
, 
roÙ_™em
->received_uuid,

2177 
BTRFS_UUID_SIZE
);

2179 
subvŞ_šfo
->
ù¿nsid
 = 
	`bŒfs_roÙ_ù¿nsid
(
roÙ_™em
);

2180 
subvŞ_šfo
->
ùime
.
£c
 = 
	`bŒfs_¡ack_time¥ec_£c
(&
roÙ_™em
->ctime);

2181 
subvŞ_šfo
->
ùime
.
n£c
 = 
	`bŒfs_¡ack_time¥ec_n£c
(&
roÙ_™em
->ctime);

2183 
subvŞ_šfo
->
Ù¿nsid
 = 
	`bŒfs_roÙ_Ù¿nsid
(
roÙ_™em
);

2184 
subvŞ_šfo
->
Ùime
.
£c
 = 
	`bŒfs_¡ack_time¥ec_£c
(&
roÙ_™em
->otime);

2185 
subvŞ_šfo
->
Ùime
.
n£c
 = 
	`bŒfs_¡ack_time¥ec_n£c
(&
roÙ_™em
->otime);

2187 
subvŞ_šfo
->
¡¿nsid
 = 
	`bŒfs_roÙ_¡¿nsid
(
roÙ_™em
);

2188 
subvŞ_šfo
->
¡ime
.
£c
 = 
	`bŒfs_¡ack_time¥ec_£c
(&
roÙ_™em
->stime);

2189 
subvŞ_šfo
->
¡ime
.
n£c
 = 
	`bŒfs_¡ack_time¥ec_n£c
(&
roÙ_™em
->stime);

2191 
subvŞ_šfo
->
¹¿nsid
 = 
	`bŒfs_roÙ_¹¿nsid
(
roÙ_™em
);

2192 
subvŞ_šfo
->
¹ime
.
£c
 = 
	`bŒfs_¡ack_time¥ec_£c
(&
roÙ_™em
->rtime);

2193 
subvŞ_šfo
->
¹ime
.
n£c
 = 
	`bŒfs_¡ack_time¥ec_n£c
(&
roÙ_™em
->rtime);

2195 ià(
key
.
objeùid
 !ğ
BTRFS_FS_TREE_OBJECTID
) {

2197 
key
.
ty³
 = 
BTRFS_ROOT_BACKREF_KEY
;

2198 
key
.
off£t
 = 0;

2199 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_šfo
->
Œ“_roÙ
, &
key
, 
·th
, 0, 0);

2200 ià(
»t
 < 0) {

2201 
out
;

2202 } ià(
·th
->
¦Ùs
[0] >=

2203 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0])) {

2204 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
fs_šfo
->
Œ“_roÙ
, 
·th
);

2205 ià(
»t
 < 0) {

2206 
out
;

2207 } ià(
»t
 > 0) {

2208 
»t
 = -
EUCLEAN
;

2209 
out
;

2213 
Ëaf
 = 
·th
->
nodes
[0];

2214 
¦Ù
 = 
·th
->
¦Ùs
[0];

2215 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

2216 ià(
key
.
objeùid
 =ğ
subvŞ_šfo
->
Œ“id
 &&

2217 
key
.
ty³
 =ğ
BTRFS_ROOT_BACKREF_KEY
) {

2218 
subvŞ_šfo
->
·»Á_id
 = 
key
.
off£t
;

2220 
¼ef
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_roÙ_»f
);

2221 
subvŞ_šfo
->
dœid
 = 
	`bŒfs_roÙ_»f_dœid
(
Ëaf
, 
¼ef
);

2223 
™em_off
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
)

2224 + (
bŒfs_roÙ_»f
);

2225 
™em_Ën
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
)

2226 - (
bŒfs_roÙ_»f
);

2227 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
subvŞ_šfo
->
Çme
,

2228 
™em_off
, 
™em_Ën
);

2230 
»t
 = -
ENOENT
;

2231 
out
;

2235 
	`bŒfs_ä“_·th
(
·th
);

2236 
·th
 = 
NULL
;

2237 ià(
	`cİy_to_u£r
(
¬gp
, 
subvŞ_šfo
, (*subvol_info)))

2238 
»t
 = -
EFAULT
;

2240 
out
:

2241 
	`bŒfs_put_roÙ
(
roÙ
);

2242 
out_ä“
:

2243 
	`bŒfs_ä“_·th
(
·th
);

2244 
	`kä“
(
subvŞ_šfo
);

2245  
»t
;

2246 
	}
}

2252 
	$bŒfs_ioùl_g‘_subvŞ_roÙ»f
(
bŒfs_roÙ
 *
roÙ
,

2253 
__u£r
 *
¬gp
)

2255 
bŒfs_ioùl_g‘_subvŞ_roÙ»f_¬gs
 *
roÙ»fs
;

2256 
bŒfs_roÙ_»f
 *
¼ef
;

2257 
bŒfs_·th
 *
·th
;

2258 
bŒfs_key
 
key
;

2259 
ex‹Á_bufãr
 *
Ëaf
;

2260 
u64
 
objeùid
;

2261 
¦Ù
;

2262 
»t
;

2263 
u8
 
found
;

2265 
·th
 = 
	`bŒfs_®loc_·th
();

2266 ià(!
·th
)

2267  -
ENOMEM
;

2269 
roÙ»fs
 = 
	`memdup_u£r
(
¬gp
, (*rootrefs));

2270 ià(
	`IS_ERR
(
roÙ»fs
)) {

2271 
	`bŒfs_ä“_·th
(
·th
);

2272  
	`PTR_ERR
(
roÙ»fs
);

2275 
objeùid
 = 
roÙ
->
roÙ_key
.objectid;

2276 
key
.
objeùid
 = objectid;

2277 
key
.
ty³
 = 
BTRFS_ROOT_REF_KEY
;

2278 
key
.
off£t
 = 
roÙ»fs
->
mš_Œ“id
;

2279 
found
 = 0;

2281 
roÙ
 =„oÙ->
fs_šfo
->
Œ“_roÙ
;

2282 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

2283 ià(
»t
 < 0) {

2284 
out
;

2285 } ià(
·th
->
¦Ùs
[0] >=

2286 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0])) {

2287 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

2288 ià(
»t
 < 0) {

2289 
out
;

2290 } ià(
»t
 > 0) {

2291 
»t
 = -
EUCLEAN
;

2292 
out
;

2296 
Ëaf
 = 
·th
->
nodes
[0];

2297 
¦Ù
 = 
·th
->
¦Ùs
[0];

2299 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

2300 ià(
key
.
objeùid
 !ğobjeùid || key.
ty³
 !ğ
BTRFS_ROOT_REF_KEY
) {

2301 
»t
 = 0;

2302 
out
;

2305 ià(
found
 =ğ
BTRFS_MAX_ROOTREF_BUFFER_NUM
) {

2306 
»t
 = -
EOVERFLOW
;

2307 
out
;

2310 
¼ef
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_roÙ_»f
);

2311 
roÙ»fs
->
roÙ»f
[
found
].
Œ“id
 = 
key
.
off£t
;

2312 
roÙ»fs
->
roÙ»f
[
found
].
dœid
 =

2313 
	`bŒfs_roÙ_»f_dœid
(
Ëaf
, 
¼ef
);

2314 
found
++;

2316 
»t
 = 
	`bŒfs_Ãxt_™em
(
roÙ
, 
·th
);

2317 ià(
»t
 < 0) {

2318 
out
;

2319 } ià(
»t
 > 0) {

2320 
»t
 = -
EUCLEAN
;

2321 
out
;

2325 
out
:

2326 
	`bŒfs_ä“_·th
(
·th
);

2328 ià(!
»t
 ||„‘ =ğ-
EOVERFLOW
) {

2329 
roÙ»fs
->
num_™ems
 = 
found
;

2331 ià(
found
)

2332 
roÙ»fs
->
mš_Œ“id
 =

2333 
roÙ»fs
->
roÙ»f
[
found
 - 1].
Œ“id
 + 1;

2334 ià(
	`cİy_to_u£r
(
¬gp
, 
roÙ»fs
, (*rootrefs)))

2335 
»t
 = -
EFAULT
;

2338 
	`kä“
(
roÙ»fs
);

2340  
»t
;

2341 
	}
}

2343 
nošlše
 
	$bŒfs_ioùl_¢­_de¡roy
(
fe
 *file,

2344 
__u£r
 *
¬g
,

2345 
boŞ
 
de¡roy_v2
)

2347 
d’Œy
 *
·»Á
 = 
fe
->
f_·th
.dentry;

2348 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
·»Á
->
d_sb
);

2349 
d’Œy
 *dentry;

2350 
šode
 *
dœ
 = 
	`d_šode
(
·»Á
);

2351 
šode
 *inode;

2352 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

2353 
bŒfs_roÙ
 *
de¡
 = 
NULL
;

2354 
bŒfs_ioùl_vŞ_¬gs
 *
vŞ_¬gs
 = 
NULL
;

2355 
bŒfs_ioùl_vŞ_¬gs_v2
 *
vŞ_¬gs2
 = 
NULL
;

2356 
mÁ_idm­
 *
idm­
 = 
	`fe_mÁ_idm­
(
fe
);

2357 *
subvŞ_Çme
, *
subvŞ_Çme_±r
 = 
NULL
;

2358 
subvŞ_Çm–’
;

2359 
”r
 = 0;

2360 
boŞ
 
de¡roy_·»Á
 = 
çl£
;

2363 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
EXTENT_TREE_V2
)) {

2364 
	`bŒfs_”r
(
fs_šfo
,

2366  -
EOPNOTSUPP
;

2369 ià(
de¡roy_v2
) {

2370 
vŞ_¬gs2
 = 
	`memdup_u£r
(
¬g
, (*vol_args2));

2371 ià(
	`IS_ERR
(
vŞ_¬gs2
))

2372  
	`PTR_ERR
(
vŞ_¬gs2
);

2374 ià(
vŞ_¬gs2
->
æags
 & ~
BTRFS_SUBVOL_DELETE_ARGS_MASK
) {

2375 
”r
 = -
EOPNOTSUPP
;

2376 
out
;

2383 ià(!(
vŞ_¬gs2
->
æags
 & 
BTRFS_SUBVOL_SPEC_BY_ID
)) {

2384 
vŞ_¬gs2
->
Çme
[
BTRFS_SUBVOL_NAME_MAX
] = 0;

2385 
subvŞ_Çme
 = 
vŞ_¬gs2
->
Çme
;

2387 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

2388 ià(
”r
)

2389 
out
;

2391 
šode
 *
Şd_dœ
;

2393 ià(
vŞ_¬gs2
->
subvŞid
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

2394 
”r
 = -
EINVAL
;

2395 
out
;

2398 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

2399 ià(
”r
)

2400 
out
;

2402 
d’Œy
 = 
	`bŒfs_g‘_d’Œy
(
fs_šfo
->
sb
,

2403 
BTRFS_FIRST_FREE_OBJECTID
,

2404 
vŞ_¬gs2
->
subvŞid
, 0);

2405 ià(
	`IS_ERR
(
d’Œy
)) {

2406 
”r
 = 
	`PTR_ERR
(
d’Œy
);

2407 
out_drİ_wr™e
;

2414 
·»Á
 = 
	`bŒfs_g‘_·»Á
(
d’Œy
);

2424 
	`dput
(
d’Œy
);

2425 ià(
	`IS_ERR
(
·»Á
)) {

2426 
”r
 = 
	`PTR_ERR
(
·»Á
);

2427 
out_drİ_wr™e
;

2429 
Şd_dœ
 = 
dœ
;

2430 
dœ
 = 
	`d_šode
(
·»Á
);

2438 
de¡roy_·»Á
 = 
Œue
;

2449 ià(
Şd_dœ
 !ğ
dœ
 && 
idm­
 !ğ&
nİ_mÁ_idm­
) {

2450 
”r
 = -
EOPNOTSUPP
;

2451 
ä“_·»Á
;

2454 
subvŞ_Çme_±r
 = 
	`bŒfs_g‘_subvŞ_Çme_äom_objeùid
(

2455 
fs_šfo
, 
vŞ_¬gs2
->
subvŞid
);

2456 ià(
	`IS_ERR
(
subvŞ_Çme_±r
)) {

2457 
”r
 = 
	`PTR_ERR
(
subvŞ_Çme_±r
);

2458 
ä“_·»Á
;

2461 
subvŞ_Çme
 = (*)
	`kba£Çme
(
subvŞ_Çme_±r
);

2464 
vŞ_¬gs
 = 
	`memdup_u£r
(
¬g
, (*vol_args));

2465 ià(
	`IS_ERR
(
vŞ_¬gs
))

2466  
	`PTR_ERR
(
vŞ_¬gs
);

2468 
vŞ_¬gs
->
Çme
[
BTRFS_PATH_NAME_MAX
] = 0;

2469 
subvŞ_Çme
 = 
vŞ_¬gs
->
Çme
;

2471 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

2472 ià(
”r
)

2473 
out
;

2476 
subvŞ_Çm–’
 = 
	`¡¾’
(
subvŞ_Çme
);

2478 ià(
	`¡rchr
(
subvŞ_Çme
, '/') ||

2479 
	`¡ºcmp
(
subvŞ_Çme
, "..", 
subvŞ_Çm–’
) == 0) {

2480 
”r
 = -
EINVAL
;

2481 
ä“_subvŞ_Çme
;

2484 ià(!
	`S_ISDIR
(
dœ
->
i_mode
)) {

2485 
”r
 = -
ENOTDIR
;

2486 
ä“_subvŞ_Çme
;

2489 
”r
 = 
	`down_wr™e_kÏbË_Ã¡ed
(&
dœ
->
i_rw£m
, 
I_MUTEX_PARENT
);

2490 ià(
”r
 =ğ-
EINTR
)

2491 
ä“_subvŞ_Çme
;

2492 
d’Œy
 = 
	`lookup_Úe
(
idm­
, 
subvŞ_Çme
, 
·»Á
, 
subvŞ_Çm–’
);

2493 ià(
	`IS_ERR
(
d’Œy
)) {

2494 
”r
 = 
	`PTR_ERR
(
d’Œy
);

2495 
out_uÆock_dœ
;

2498 ià(
	`d_»®ly_is_Ãg©ive
(
d’Œy
)) {

2499 
”r
 = -
ENOENT
;

2500 
out_dput
;

2503 
šode
 = 
	`d_šode
(
d’Œy
);

2504 
de¡
 = 
	`BTRFS_I
(
šode
)->
roÙ
;

2505 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
)) {

2519 
”r
 = -
EPERM
;

2520 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
USER_SUBVOL_RM_ALLOWED
))

2521 
out_dput
;

2530 
”r
 = -
EINVAL
;

2531 ià(
roÙ
 =ğ
de¡
)

2532 
out_dput
;

2534 
”r
 = 
	`šode_³rmissiÚ
(
idm­
, 
šode
, 
MAY_WRITE
 | 
MAY_EXEC
);

2535 ià(
”r
)

2536 
out_dput
;

2540 
”r
 = 
	`bŒfs_may_d–‘e
(
idm­
, 
dœ
, 
d’Œy
, 1);

2541 ià(
”r
)

2542 
out_dput
;

2544 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)è!ğ
BTRFS_FIRST_FREE_OBJECTID
) {

2545 
”r
 = -
EINVAL
;

2546 
out_dput
;

2549 
	`bŒfs_šode_lock
(
	`BTRFS_I
(
šode
), 0);

2550 
”r
 = 
	`bŒfs_d–‘e_subvŞume
(
	`BTRFS_I
(
dœ
), 
d’Œy
);

2551 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
šode
), 0);

2552 ià(!
”r
)

2553 
	`d_d–‘e_nÙify
(
dœ
, 
d’Œy
);

2555 
out_dput
:

2556 
	`dput
(
d’Œy
);

2557 
out_uÆock_dœ
:

2558 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
dœ
), 0);

2559 
ä“_subvŞ_Çme
:

2560 
	`kä“
(
subvŞ_Çme_±r
);

2561 
ä“_·»Á
:

2562 ià(
de¡roy_·»Á
)

2563 
	`dput
(
·»Á
);

2564 
out_drİ_wr™e
:

2565 
	`mÁ_drİ_wr™e_fe
(
fe
);

2566 
out
:

2567 
	`kä“
(
vŞ_¬gs2
);

2568 
	`kä“
(
vŞ_¬gs
);

2569  
”r
;

2570 
	}
}

2572 
	$bŒfs_ioùl_deäag
(
fe
 *fe, 
__u£r
 *
¬gp
)

2574 
šode
 *šodğ
	`fe_šode
(
fe
);

2575 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

2576 
bŒfs_ioùl_deäag_¿nge_¬gs
 
¿nge
 = {0};

2577 
»t
;

2579 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

2580 ià(
»t
)

2581  
»t
;

2583 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
)) {

2584 
»t
 = -
EROFS
;

2585 
out
;

2588 
šode
->
i_mode
 & 
S_IFMT
) {

2589 
S_IFDIR
:

2590 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
)) {

2591 
»t
 = -
EPERM
;

2592 
out
;

2594 
»t
 = 
	`bŒfs_deäag_roÙ
(
roÙ
);

2596 
S_IFREG
:

2602 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
) &&

2603 
	`šode_³rmissiÚ
(&
nİ_mÁ_idm­
, 
šode
, 
MAY_WRITE
)) {

2604 
»t
 = -
EPERM
;

2605 
out
;

2608 ià(
¬gp
) {

2609 ià(
	`cİy_äom_u£r
(&
¿nge
, 
¬gp
, (range))) {

2610 
»t
 = -
EFAULT
;

2611 
out
;

2614 ià((
¿nge
.
æags
 & 
BTRFS_DEFRAG_RANGE_COMPRESS
)) {

2615 
¿nge
.
æags
 |ğ
BTRFS_DEFRAG_RANGE_START_IO
;

2616 
¿nge
.
ex‹Á_th»sh
 = (
u32
)-1;

2620 
¿nge
.
Ën
 = (
u64
)-1;

2622 
»t
 = 
	`bŒfs_deäag_fe
(
	`fe_šode
(
fe
), &fe->
f_¿
,

2623 &
¿nge
, 
BTRFS_OLDEST_GENERATION
, 0);

2624 ià(
»t
 > 0)

2625 
»t
 = 0;

2628 
»t
 = -
EINVAL
;

2630 
out
:

2631 
	`mÁ_drİ_wr™e_fe
(
fe
);

2632  
»t
;

2633 
	}
}

2635 
	$bŒfs_ioùl_add_dev
(
bŒfs_fs_šfo
 *
fs_šfo
, 
__u£r
 *
¬g
)

2637 
bŒfs_ioùl_vŞ_¬gs
 *
vŞ_¬gs
;

2638 
boŞ
 
»¡Üe_İ
 = 
çl£
;

2639 
»t
;

2641 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2642  -
EPERM
;

2644 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
EXTENT_TREE_V2
)) {

2645 
	`bŒfs_”r
(
fs_šfo
, "device‡dd‚ot supported onƒxtentree v2 yet");

2646  -
EINVAL
;

2649 ià(!
	`bŒfs_exşİ_¡¬t
(
fs_šfo
, 
BTRFS_EXCLOP_DEV_ADD
)) {

2650 ià(!
	`bŒfs_exşİ_¡¬t_Œy_lock
(
fs_šfo
, 
BTRFS_EXCLOP_DEV_ADD
))

2651  
BTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
;

2658 
fs_šfo
->
exşusive_İ”©iÚ
 = 
BTRFS_EXCLOP_DEV_ADD
;

2659 
	`bŒfs_exşİ_¡¬t_uÆock
(
fs_šfo
);

2660 
»¡Üe_İ
 = 
Œue
;

2663 
vŞ_¬gs
 = 
	`memdup_u£r
(
¬g
, (*vol_args));

2664 ià(
	`IS_ERR
(
vŞ_¬gs
)) {

2665 
»t
 = 
	`PTR_ERR
(
vŞ_¬gs
);

2666 
out
;

2669 
vŞ_¬gs
->
Çme
[
BTRFS_PATH_NAME_MAX
] = '\0';

2670 
»t
 = 
	`bŒfs_š™_Ãw_deviû
(
fs_šfo
, 
vŞ_¬gs
->
Çme
);

2672 ià(!
»t
)

2673 
	`bŒfs_šfo
(
fs_šfo
, "disk‡dded %s", 
vŞ_¬gs
->
Çme
);

2675 
	`kä“
(
vŞ_¬gs
);

2676 
out
:

2677 ià(
»¡Üe_İ
)

2678 
	`bŒfs_exşİ_b®ªû
(
fs_šfo
, 
BTRFS_EXCLOP_BALANCE_PAUSED
);

2680 
	`bŒfs_exşİ_fšish
(
fs_šfo
);

2681  
»t
;

2682 
	}
}

2684 
	$bŒfs_ioùl_rm_dev_v2
(
fe
 *fe, 
__u£r
 *
¬g
)

2686 
	`BTRFS_DEV_LOOKUP_ARGS
(
¬gs
);

2687 
šode
 *šodğ
	`fe_šode
(
fe
);

2688 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2689 
bŒfs_ioùl_vŞ_¬gs_v2
 *
vŞ_¬gs
;

2690 
block_deviû
 *
bdev
 = 
NULL
;

2691 *
hŞd”
;

2692 
»t
;

2693 
boŞ
 
ÿnûl
 = 
çl£
;

2695 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2696  -
EPERM
;

2698 
vŞ_¬gs
 = 
	`memdup_u£r
(
¬g
, (*vol_args));

2699 ià(
	`IS_ERR
(
vŞ_¬gs
))

2700  
	`PTR_ERR
(
vŞ_¬gs
);

2702 ià(
vŞ_¬gs
->
æags
 & ~
BTRFS_DEVICE_REMOVE_ARGS_MASK
) {

2703 
»t
 = -
EOPNOTSUPP
;

2704 
out
;

2707 
vŞ_¬gs
->
Çme
[
BTRFS_SUBVOL_NAME_MAX
] = '\0';

2708 ià(
vŞ_¬gs
->
æags
 & 
BTRFS_DEVICE_SPEC_BY_ID
) {

2709 
¬gs
.
devid
 = 
vŞ_¬gs
->devid;

2710 } ià(!
	`¡rcmp
("ÿnûl", 
vŞ_¬gs
->
Çme
)) {

2711 
ÿnûl
 = 
Œue
;

2713 
»t
 = 
	`bŒfs_g‘_dev_¬gs_äom_·th
(
fs_šfo
, &
¬gs
, 
vŞ_¬gs
->
Çme
);

2714 ià(
»t
)

2715 
out
;

2718 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

2719 ià(
»t
)

2720 
out
;

2722 
»t
 = 
	`exşİ_¡¬t_Ü_ÿnûl_»loc
(
fs_šfo
, 
BTRFS_EXCLOP_DEV_REMOVE
,

2723 
ÿnûl
);

2724 ià(
»t
)

2725 
”r_drİ
;

2728 
»t
 = 
	`bŒfs_rm_deviû
(
fs_šfo
, &
¬gs
, &
bdev
, &
hŞd”
);

2730 
	`bŒfs_exşİ_fšish
(
fs_šfo
);

2732 ià(!
»t
) {

2733 ià(
vŞ_¬gs
->
æags
 & 
BTRFS_DEVICE_SPEC_BY_ID
)

2734 
	`bŒfs_šfo
(
fs_šfo
, "device deleted: id %llu",

2735 
vŞ_¬gs
->
devid
);

2737 
	`bŒfs_šfo
(
fs_šfo
, "device deleted: %s",

2738 
vŞ_¬gs
->
Çme
);

2740 
”r_drİ
:

2741 
	`mÁ_drİ_wr™e_fe
(
fe
);

2742 ià(
bdev
)

2743 
	`blkdev_put
(
bdev
, 
hŞd”
);

2744 
out
:

2745 
	`bŒfs_put_dev_¬gs_äom_·th
(&
¬gs
);

2746 
	`kä“
(
vŞ_¬gs
);

2747  
»t
;

2748 
	}
}

2750 
	$bŒfs_ioùl_rm_dev
(
fe
 *fe, 
__u£r
 *
¬g
)

2752 
	`BTRFS_DEV_LOOKUP_ARGS
(
¬gs
);

2753 
šode
 *šodğ
	`fe_šode
(
fe
);

2754 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2755 
bŒfs_ioùl_vŞ_¬gs
 *
vŞ_¬gs
;

2756 
block_deviû
 *
bdev
 = 
NULL
;

2757 *
hŞd”
;

2758 
»t
;

2759 
boŞ
 
ÿnûl
 = 
çl£
;

2761 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2762  -
EPERM
;

2764 
vŞ_¬gs
 = 
	`memdup_u£r
(
¬g
, (*vol_args));

2765 ià(
	`IS_ERR
(
vŞ_¬gs
))

2766  
	`PTR_ERR
(
vŞ_¬gs
);

2768 
vŞ_¬gs
->
Çme
[
BTRFS_PATH_NAME_MAX
] = '\0';

2769 ià(!
	`¡rcmp
("ÿnûl", 
vŞ_¬gs
->
Çme
)) {

2770 
ÿnûl
 = 
Œue
;

2772 
»t
 = 
	`bŒfs_g‘_dev_¬gs_äom_·th
(
fs_šfo
, &
¬gs
, 
vŞ_¬gs
->
Çme
);

2773 ià(
»t
)

2774 
out
;

2777 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

2778 ià(
»t
)

2779 
out
;

2781 
»t
 = 
	`exşİ_¡¬t_Ü_ÿnûl_»loc
(
fs_šfo
, 
BTRFS_EXCLOP_DEV_REMOVE
,

2782 
ÿnûl
);

2783 ià(
»t
 == 0) {

2784 
»t
 = 
	`bŒfs_rm_deviû
(
fs_šfo
, &
¬gs
, &
bdev
, &
hŞd”
);

2785 ià(!
»t
)

2786 
	`bŒfs_šfo
(
fs_šfo
, "disk d–‘ed %s", 
vŞ_¬gs
->
Çme
);

2787 
	`bŒfs_exşİ_fšish
(
fs_šfo
);

2790 
	`mÁ_drİ_wr™e_fe
(
fe
);

2791 ià(
bdev
)

2792 
	`blkdev_put
(
bdev
, 
hŞd”
);

2793 
out
:

2794 
	`bŒfs_put_dev_¬gs_äom_·th
(&
¬gs
);

2795 
	`kä“
(
vŞ_¬gs
);

2796  
»t
;

2797 
	}
}

2799 
	$bŒfs_ioùl_fs_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
,

2800 
__u£r
 *
¬g
)

2802 
bŒfs_ioùl_fs_šfo_¬gs
 *
fi_¬gs
;

2803 
bŒfs_deviû
 *
deviû
;

2804 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

2805 
u64
 
æags_š
;

2806 
»t
 = 0;

2808 
fi_¬gs
 = 
	`memdup_u£r
(
¬g
, (*fi_args));

2809 ià(
	`IS_ERR
(
fi_¬gs
))

2810  
	`PTR_ERR
(
fi_¬gs
);

2812 
æags_š
 = 
fi_¬gs
->
æags
;

2813 
	`mem£t
(
fi_¬gs
, 0, (*fi_args));

2815 
	`rcu_»ad_lock
();

2816 
fi_¬gs
->
num_deviûs
 = 
fs_deviûs
->num_devices;

2818 
	`li¡_fÜ_—ch_’Œy_rcu
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

2819 ià(
deviû
->
devid
 > 
fi_¬gs
->
max_id
)

2820 
fi_¬gs
->
max_id
 = 
deviû
->
devid
;

2822 
	`rcu_»ad_uÆock
();

2824 
	`memıy
(&
fi_¬gs
->
fsid
, 
fs_deviûs
->fsid, (fi_args->fsid));

2825 
fi_¬gs
->
nodesize
 = 
fs_šfo
->nodesize;

2826 
fi_¬gs
->
£ùÜsize
 = 
fs_šfo
->sectorsize;

2827 
fi_¬gs
->
şÚe_®ignm’t
 = 
fs_šfo
->
£ùÜsize
;

2829 ià(
æags_š
 & 
BTRFS_FS_INFO_FLAG_CSUM_INFO
) {

2830 
fi_¬gs
->
csum_ty³
 = 
	`bŒfs_su³r_csum_ty³
(
fs_šfo
->
su³r_cİy
);

2831 
fi_¬gs
->
csum_size
 = 
	`bŒfs_su³r_csum_size
(
fs_šfo
->
su³r_cİy
);

2832 
fi_¬gs
->
æags
 |ğ
BTRFS_FS_INFO_FLAG_CSUM_INFO
;

2835 ià(
æags_š
 & 
BTRFS_FS_INFO_FLAG_GENERATION
) {

2836 
fi_¬gs
->
g’”©iÚ
 = 
fs_šfo
->generation;

2837 
fi_¬gs
->
æags
 |ğ
BTRFS_FS_INFO_FLAG_GENERATION
;

2840 ià(
æags_š
 & 
BTRFS_FS_INFO_FLAG_METADATA_UUID
) {

2841 
	`memıy
(&
fi_¬gs
->
m‘ad©a_uuid
, 
fs_deviûs
->metadata_uuid,

2842 (
fi_¬gs
->
m‘ad©a_uuid
));

2843 
fi_¬gs
->
æags
 |ğ
BTRFS_FS_INFO_FLAG_METADATA_UUID
;

2846 ià(
	`cİy_to_u£r
(
¬g
, 
fi_¬gs
, (*fi_args)))

2847 
»t
 = -
EFAULT
;

2849 
	`kä“
(
fi_¬gs
);

2850  
»t
;

2851 
	}
}

2853 
	$bŒfs_ioùl_dev_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
,

2854 
__u£r
 *
¬g
)

2856 
	`BTRFS_DEV_LOOKUP_ARGS
(
¬gs
);

2857 
bŒfs_ioùl_dev_šfo_¬gs
 *
di_¬gs
;

2858 
bŒfs_deviû
 *
dev
;

2859 
»t
 = 0;

2861 
di_¬gs
 = 
	`memdup_u£r
(
¬g
, (*di_args));

2862 ià(
	`IS_ERR
(
di_¬gs
))

2863  
	`PTR_ERR
(
di_¬gs
);

2865 
¬gs
.
devid
 = 
di_¬gs
->devid;

2866 ià(!
	`bŒfs_is_em±y_uuid
(
di_¬gs
->
uuid
))

2867 
¬gs
.
uuid
 = 
di_¬gs
->uuid;

2869 
	`rcu_»ad_lock
();

2870 
dev
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, &
¬gs
);

2871 ià(!
dev
) {

2872 
»t
 = -
ENODEV
;

2873 
out
;

2876 
di_¬gs
->
devid
 = 
dev
->devid;

2877 
di_¬gs
->
by‹s_u£d
 = 
	`bŒfs_deviû_g‘_by‹s_u£d
(
dev
);

2878 
di_¬gs
->
tÙ®_by‹s
 = 
	`bŒfs_deviû_g‘_tÙ®_by‹s
(
dev
);

2879 
	`memıy
(
di_¬gs
->
uuid
, 
dev
->uuid, (di_args->uuid));

2880 
	`memıy
(
di_¬gs
->
fsid
, 
dev
->
fs_deviûs
->fsid, 
BTRFS_UUID_SIZE
);

2881 ià(
dev
->
Çme
)

2882 
	`¡rsıy
(
di_¬gs
->
·th
, 
	`bŒfs_dev_Çme
(
dev
), (di_args->path));

2884 
di_¬gs
->
·th
[0] = '\0';

2886 
out
:

2887 
	`rcu_»ad_uÆock
();

2888 ià(
»t
 =ğ0 && 
	`cİy_to_u£r
(
¬g
, 
di_¬gs
, (*di_args)))

2889 
»t
 = -
EFAULT
;

2891 
	`kä“
(
di_¬gs
);

2892  
»t
;

2893 
	}
}

2895 
	$bŒfs_ioùl_deçuÉ_subvŞ
(
fe
 *fe, 
__u£r
 *
¬gp
)

2897 
šode
 *šodğ
	`fe_šode
(
fe
);

2898 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2899 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

2900 
bŒfs_roÙ
 *
Ãw_roÙ
;

2901 
bŒfs_dœ_™em
 *
di
;

2902 
bŒfs_Œªs_hªdË
 *
Œªs
;

2903 
bŒfs_·th
 *
·th
 = 
NULL
;

2904 
bŒfs_disk_key
 
disk_key
;

2905 
fsüy±_¡r
 
Çme
 = 
	`FSTR_INIT
("default", 7);

2906 
u64
 
objeùid
 = 0;

2907 
u64
 
dœ_id
;

2908 
»t
;

2910 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2911  -
EPERM
;

2913 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

2914 ià(
»t
)

2915  
»t
;

2917 ià(
	`cİy_äom_u£r
(&
objeùid
, 
¬gp
, (objectid))) {

2918 
»t
 = -
EFAULT
;

2919 
out
;

2922 ià(!
objeùid
)

2923 
objeùid
 = 
BTRFS_FS_TREE_OBJECTID
;

2925 
Ãw_roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
objeùid
, 
Œue
);

2926 ià(
	`IS_ERR
(
Ãw_roÙ
)) {

2927 
»t
 = 
	`PTR_ERR
(
Ãw_roÙ
);

2928 
out
;

2930 ià(!
	`is_f¡»e
(
Ãw_roÙ
->
roÙ_key
.
objeùid
)) {

2931 
»t
 = -
ENOENT
;

2932 
out_ä“
;

2935 
·th
 = 
	`bŒfs_®loc_·th
();

2936 ià(!
·th
) {

2937 
»t
 = -
ENOMEM
;

2938 
out_ä“
;

2941 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

2942 ià(
	`IS_ERR
(
Œªs
)) {

2943 
»t
 = 
	`PTR_ERR
(
Œªs
);

2944 
out_ä“
;

2947 
dœ_id
 = 
	`bŒfs_su³r_roÙ_dœ
(
fs_šfo
->
su³r_cİy
);

2948 
di
 = 
	`bŒfs_lookup_dœ_™em
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
, 
·th
,

2949 
dœ_id
, &
Çme
, 1);

2950 ià(
	`IS_ERR_OR_NULL
(
di
)) {

2951 
	`bŒfs_»Ëa£_·th
(
·th
);

2952 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2953 
	`bŒfs_”r
(
fs_šfo
,

2955 
»t
 = -
ENOENT
;

2956 
out_ä“
;

2959 
	`bŒfs_ıu_key_to_disk
(&
disk_key
, &
Ãw_roÙ
->
roÙ_key
);

2960 
	`bŒfs_£t_dœ_™em_key
(
·th
->
nodes
[0], 
di
, &
disk_key
);

2961 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·th
->
nodes
[0]);

2962 
	`bŒfs_»Ëa£_·th
(
·th
);

2964 
	`bŒfs_£t_fs_šcom·t
(
fs_šfo
, 
DEFAULT_SUBVOL
);

2965 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2966 
out_ä“
:

2967 
	`bŒfs_put_roÙ
(
Ãw_roÙ
);

2968 
	`bŒfs_ä“_·th
(
·th
);

2969 
out
:

2970 
	`mÁ_drİ_wr™e_fe
(
fe
);

2971  
»t
;

2972 
	}
}

2974 
	$g‘_block_group_šfo
(
li¡_h—d
 *
groups_li¡
,

2975 
bŒfs_ioùl_¥aû_šfo
 *
¥aû
)

2977 
bŒfs_block_group
 *
block_group
;

2979 
¥aû
->
tÙ®_by‹s
 = 0;

2980 
¥aû
->
u£d_by‹s
 = 0;

2981 
¥aû
->
æags
 = 0;

2982 
	`li¡_fÜ_—ch_’Œy
(
block_group
, 
groups_li¡
, 
li¡
) {

2983 
¥aû
->
æags
 = 
block_group
->flags;

2984 
¥aû
->
tÙ®_by‹s
 +ğ
block_group
->
Ëngth
;

2985 
¥aû
->
u£d_by‹s
 +ğ
block_group
->
u£d
;

2987 
	}
}

2989 
	$bŒfs_ioùl_¥aû_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
,

2990 
__u£r
 *
¬g
)

2992 
bŒfs_ioùl_¥aû_¬gs
 
¥aû_¬gs
 = { 0 };

2993 
bŒfs_ioùl_¥aû_šfo
 
¥aû
;

2994 
bŒfs_ioùl_¥aû_šfo
 *
de¡
;

2995 
bŒfs_ioùl_¥aû_šfo
 *
de¡_Üig
;

2996 
bŒfs_ioùl_¥aû_šfo
 
__u£r
 *
u£r_de¡
;

2997 
bŒfs_¥aû_šfo
 *
šfo
;

2998 cÚ¡ 
u64
 
ty³s
[] = {

2999 
BTRFS_BLOCK_GROUP_DATA
,

3000 
BTRFS_BLOCK_GROUP_SYSTEM
,

3001 
BTRFS_BLOCK_GROUP_METADATA
,

3002 
BTRFS_BLOCK_GROUP_DATA
 | 
BTRFS_BLOCK_GROUP_METADATA


3004 
num_ty³s
 = 4;

3005 
®loc_size
;

3006 
»t
 = 0;

3007 
u64
 
¦Ù_couÁ
 = 0;

3008 
i
, 
c
;

3010 ià(
	`cİy_äom_u£r
(&
¥aû_¬gs
,

3011 (
bŒfs_ioùl_¥aû_¬gs
 
__u£r
 *)
¬g
,

3012 (
¥aû_¬gs
)))

3013  -
EFAULT
;

3015 
i
 = 0; i < 
num_ty³s
; i++) {

3016 
bŒfs_¥aû_šfo
 *
tmp
;

3018 
šfo
 = 
NULL
;

3019 
	`li¡_fÜ_—ch_’Œy
(
tmp
, &
fs_šfo
->
¥aû_šfo
, 
li¡
) {

3020 ià(
tmp
->
æags
 =ğ
ty³s
[
i
]) {

3021 
šfo
 = 
tmp
;

3026 ià(!
šfo
)

3029 
	`down_»ad
(&
šfo
->
groups_£m
);

3030 
c
 = 0; c < 
BTRFS_NR_RAID_TYPES
; c++) {

3031 ià(!
	`li¡_em±y
(&
šfo
->
block_groups
[
c
]))

3032 
¦Ù_couÁ
++;

3034 
	`up_»ad
(&
šfo
->
groups_£m
);

3040 
¦Ù_couÁ
++;

3043 ià(
¥aû_¬gs
.
¥aû_¦Ùs
 == 0) {

3044 
¥aû_¬gs
.
tÙ®_¥aûs
 = 
¦Ù_couÁ
;

3045 
out
;

3048 
¦Ù_couÁ
 = 
	`mš_t
(
u64
, 
¥aû_¬gs
.
¥aû_¦Ùs
, slot_count);

3050 
®loc_size
 = (*
de¡
è* 
¦Ù_couÁ
;

3055 ià(
®loc_size
 > 
PAGE_SIZE
)

3056  -
ENOMEM
;

3058 
¥aû_¬gs
.
tÙ®_¥aûs
 = 0;

3059 
de¡
 = 
	`km®loc
(
®loc_size
, 
GFP_KERNEL
);

3060 ià(!
de¡
)

3061  -
ENOMEM
;

3062 
de¡_Üig
 = 
de¡
;

3065 
i
 = 0; i < 
num_ty³s
; i++) {

3066 
bŒfs_¥aû_šfo
 *
tmp
;

3068 ià(!
¦Ù_couÁ
)

3071 
šfo
 = 
NULL
;

3072 
	`li¡_fÜ_—ch_’Œy
(
tmp
, &
fs_šfo
->
¥aû_šfo
, 
li¡
) {

3073 ià(
tmp
->
æags
 =ğ
ty³s
[
i
]) {

3074 
šfo
 = 
tmp
;

3079 ià(!
šfo
)

3081 
	`down_»ad
(&
šfo
->
groups_£m
);

3082 
c
 = 0; c < 
BTRFS_NR_RAID_TYPES
; c++) {

3083 ià(!
	`li¡_em±y
(&
šfo
->
block_groups
[
c
])) {

3084 
	`g‘_block_group_šfo
(&
šfo
->
block_groups
[
c
],

3085 &
¥aû
);

3086 
	`memıy
(
de¡
, &
¥aû
, (space));

3087 
de¡
++;

3088 
¥aû_¬gs
.
tÙ®_¥aûs
++;

3089 
¦Ù_couÁ
--;

3091 ià(!
¦Ù_couÁ
)

3094 
	`up_»ad
(&
šfo
->
groups_£m
);

3100 ià(
¦Ù_couÁ
) {

3101 
bŒfs_block_rsv
 *
block_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

3103 
	`¥š_lock
(&
block_rsv
->
lock
);

3104 
¥aû
.
tÙ®_by‹s
 = 
block_rsv
->
size
;

3105 
¥aû
.
u£d_by‹s
 = 
block_rsv
->
size
 - block_rsv->
»£rved
;

3106 
	`¥š_uÆock
(&
block_rsv
->
lock
);

3107 
¥aû
.
æags
 = 
BTRFS_SPACE_INFO_GLOBAL_RSV
;

3108 
	`memıy
(
de¡
, &
¥aû
, (space));

3109 
¥aû_¬gs
.
tÙ®_¥aûs
++;

3112 
u£r_de¡
 = (
bŒfs_ioùl_¥aû_šfo
 
__u£r
 *)

3113 (
¬g
 + (
bŒfs_ioùl_¥aû_¬gs
));

3115 ià(
	`cİy_to_u£r
(
u£r_de¡
, 
de¡_Üig
, 
®loc_size
))

3116 
»t
 = -
EFAULT
;

3118 
	`kä“
(
de¡_Üig
);

3119 
out
:

3120 ià(
»t
 =ğ0 && 
	`cİy_to_u£r
(
¬g
, &
¥aû_¬gs
, (space_args)))

3121 
»t
 = -
EFAULT
;

3123  
»t
;

3124 
	}
}

3126 
nošlše
 
	$bŒfs_ioùl_¡¬t_sync
(
bŒfs_roÙ
 *
roÙ
,

3127 
__u£r
 *
¬gp
)

3129 
bŒfs_Œªs_hªdË
 *
Œªs
;

3130 
u64
 
Œªsid
;

3137 
	`bŒfs_Üphª_ş—nup
(
roÙ
);

3139 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ_b¬r›r
(
roÙ
);

3140 ià(
	`IS_ERR
(
Œªs
)) {

3141 ià(
	`PTR_ERR
(
Œªs
è!ğ-
ENOENT
)

3142  
	`PTR_ERR
(
Œªs
);

3145 
Œªsid
 = 
roÙ
->
fs_šfo
->
Ï¡_Œªs_comm™‹d
;

3146 
out
;

3148 
Œªsid
 = 
Œªs
->transid;

3149 
	`bŒfs_comm™_Œª§ùiÚ_async
(
Œªs
);

3150 
out
:

3151 ià(
¬gp
)

3152 ià(
	`cİy_to_u£r
(
¬gp
, &
Œªsid
, (transid)))

3153  -
EFAULT
;

3155 
	}
}

3157 
nošlše
 
	$bŒfs_ioùl_wa™_sync
(
bŒfs_fs_šfo
 *
fs_šfo
,

3158 
__u£r
 *
¬gp
)

3161 
u64
 
Œªsid
 = 0;

3163 ià(
¬gp
)

3164 ià(
	`cİy_äom_u£r
(&
Œªsid
, 
¬gp
, (transid)))

3165  -
EFAULT
;

3167  
	`bŒfs_wa™_fÜ_comm™
(
fs_šfo
, 
Œªsid
);

3168 
	}
}

3170 
	$bŒfs_ioùl_süub
(
fe
 *fe, 
__u£r
 *
¬g
)

3172 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
	`fe_šode
(
fe
)->
i_sb
);

3173 
bŒfs_ioùl_süub_¬gs
 *
§
;

3174 
»t
;

3176 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3177  -
EPERM
;

3179 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
EXTENT_TREE_V2
)) {

3180 
	`bŒfs_”r
(
fs_šfo
, "scrub is‚ot supported onƒxtentree v2 yet");

3181  -
EINVAL
;

3184 
§
 = 
	`memdup_u£r
(
¬g
, (*sa));

3185 ià(
	`IS_ERR
(
§
))

3186  
	`PTR_ERR
(
§
);

3188 ià(
§
->
æags
 & ~
BTRFS_SCRUB_SUPPORTED_FLAGS
) {

3189 
»t
 = -
EOPNOTSUPP
;

3190 
out
;

3193 ià(!(
§
->
æags
 & 
BTRFS_SCRUB_READONLY
)) {

3194 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

3195 ià(
»t
)

3196 
out
;

3199 
»t
 = 
	`bŒfs_süub_dev
(
fs_šfo
, 
§
->
devid
, sa->
¡¬t
, sa->
’d
,

3200 &
§
->
´og»ss
, sa->
æags
 & 
BTRFS_SCRUB_READONLY
,

3215 ià(
	`cİy_to_u£r
(
¬g
, 
§
, (*sa)))

3216 
»t
 = -
EFAULT
;

3218 ià(!(
§
->
æags
 & 
BTRFS_SCRUB_READONLY
))

3219 
	`mÁ_drİ_wr™e_fe
(
fe
);

3220 
out
:

3221 
	`kä“
(
§
);

3222  
»t
;

3223 
	}
}

3225 
	$bŒfs_ioùl_süub_ÿnûl
(
bŒfs_fs_šfo
 *
fs_šfo
)

3227 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3228  -
EPERM
;

3230  
	`bŒfs_süub_ÿnûl
(
fs_šfo
);

3231 
	}
}

3233 
	$bŒfs_ioùl_süub_´og»ss
(
bŒfs_fs_šfo
 *
fs_šfo
,

3234 
__u£r
 *
¬g
)

3236 
bŒfs_ioùl_süub_¬gs
 *
§
;

3237 
»t
;

3239 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3240  -
EPERM
;

3242 
§
 = 
	`memdup_u£r
(
¬g
, (*sa));

3243 ià(
	`IS_ERR
(
§
))

3244  
	`PTR_ERR
(
§
);

3246 
»t
 = 
	`bŒfs_süub_´og»ss
(
fs_šfo
, 
§
->
devid
, &§->
´og»ss
);

3248 ià(
»t
 =ğ0 && 
	`cİy_to_u£r
(
¬g
, 
§
, (*sa)))

3249 
»t
 = -
EFAULT
;

3251 
	`kä“
(
§
);

3252  
»t
;

3253 
	}
}

3255 
	$bŒfs_ioùl_g‘_dev_¡©s
(
bŒfs_fs_šfo
 *
fs_šfo
,

3256 
__u£r
 *
¬g
)

3258 
bŒfs_ioùl_g‘_dev_¡©s
 *
§
;

3259 
»t
;

3261 
§
 = 
	`memdup_u£r
(
¬g
, (*sa));

3262 ià(
	`IS_ERR
(
§
))

3263  
	`PTR_ERR
(
§
);

3265 ià((
§
->
æags
 & 
BTRFS_DEV_STATS_RESET
è&& !
	`ÿ·bË
(
CAP_SYS_ADMIN
)) {

3266 
	`kä“
(
§
);

3267  -
EPERM
;

3270 
»t
 = 
	`bŒfs_g‘_dev_¡©s
(
fs_šfo
, 
§
);

3272 ià(
»t
 =ğ0 && 
	`cİy_to_u£r
(
¬g
, 
§
, (*sa)))

3273 
»t
 = -
EFAULT
;

3275 
	`kä“
(
§
);

3276  
»t
;

3277 
	}
}

3279 
	$bŒfs_ioùl_dev_»¶aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

3280 
__u£r
 *
¬g
)

3282 
bŒfs_ioùl_dev_»¶aû_¬gs
 *
p
;

3283 
»t
;

3285 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3286  -
EPERM
;

3288 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
EXTENT_TREE_V2
)) {

3289 
	`bŒfs_”r
(
fs_šfo
, "device„eplace‚ot supported onƒxtentree v2 yet");

3290  -
EINVAL
;

3293 
p
 = 
	`memdup_u£r
(
¬g
, (*p));

3294 ià(
	`IS_ERR
(
p
))

3295  
	`PTR_ERR
(
p
);

3297 
p
->
cmd
) {

3298 
BTRFS_IOCTL_DEV_REPLACE_CMD_START
:

3299 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
)) {

3300 
»t
 = -
EROFS
;

3301 
out
;

3303 ià(!
	`bŒfs_exşİ_¡¬t
(
fs_šfo
, 
BTRFS_EXCLOP_DEV_REPLACE
)) {

3304 
»t
 = 
BTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
;

3306 
»t
 = 
	`bŒfs_dev_»¶aû_by_ioùl
(
fs_šfo
, 
p
);

3307 
	`bŒfs_exşİ_fšish
(
fs_šfo
);

3310 
BTRFS_IOCTL_DEV_REPLACE_CMD_STATUS
:

3311 
	`bŒfs_dev_»¶aû_¡©us
(
fs_šfo
, 
p
);

3312 
»t
 = 0;

3314 
BTRFS_IOCTL_DEV_REPLACE_CMD_CANCEL
:

3315 
p
->
»suÉ
 = 
	`bŒfs_dev_»¶aû_ÿnûl
(
fs_šfo
);

3316 
»t
 = 0;

3319 
»t
 = -
EINVAL
;

3323 ià((
»t
 =ğ0 ||„‘ =ğ-
ECANCELED
è&& 
	`cİy_to_u£r
(
¬g
, 
p
, (*p)))

3324 
»t
 = -
EFAULT
;

3325 
out
:

3326 
	`kä“
(
p
);

3327  
»t
;

3328 
	}
}

3330 
	$bŒfs_ioùl_šo_to_·th
(
bŒfs_roÙ
 *
roÙ
, 
__u£r
 *
¬g
)

3332 
»t
 = 0;

3333 
i
;

3334 
u64
 
»l_±r
;

3335 
size
;

3336 
bŒfs_ioùl_šo_·th_¬gs
 *
a
 = 
NULL
;

3337 
šode_fs_·ths
 *
©h
 = 
NULL
;

3338 
bŒfs_·th
 *
·th
;

3340 ià(!
	`ÿ·bË
(
CAP_DAC_READ_SEARCH
))

3341  -
EPERM
;

3343 
·th
 = 
	`bŒfs_®loc_·th
();

3344 ià(!
·th
) {

3345 
»t
 = -
ENOMEM
;

3346 
out
;

3349 
a
 = 
	`memdup_u£r
(
¬g
, (*ipa));

3350 ià(
	`IS_ERR
(
a
)) {

3351 
»t
 = 
	`PTR_ERR
(
a
);

3352 
a
 = 
NULL
;

3353 
out
;

3356 
size
 = 
	`mš_t
(
u32
, 
a
->size, 4096);

3357 
©h
 = 
	`š™_©h
(
size
, 
roÙ
, 
·th
);

3358 ià(
	`IS_ERR
(
©h
)) {

3359 
»t
 = 
	`PTR_ERR
(
©h
);

3360 
©h
 = 
NULL
;

3361 
out
;

3364 
»t
 = 
	`·ths_äom_šode
(
a
->
šum
, 
©h
);

3365 ià(
»t
 < 0)

3366 
out
;

3368 
i
 = 0; i < 
©h
->
f¥©h
->
–em_út
; ++i) {

3369 
»l_±r
 = 
©h
->
f¥©h
->
v®
[
i
] -

3370 (
u64
)()
©h
->
f¥©h
->
v®
;

3371 
©h
->
f¥©h
->
v®
[
i
] = 
»l_±r
;

3374 
	`bŒfs_ä“_·th
(
·th
);

3375 
·th
 = 
NULL
;

3376 
»t
 = 
	`cİy_to_u£r
((
__u£r
 *)()
a
->
f¥©h
,

3377 
©h
->
f¥©h
, 
size
);

3378 ià(
»t
) {

3379 
»t
 = -
EFAULT
;

3380 
out
;

3383 
out
:

3384 
	`bŒfs_ä“_·th
(
·th
);

3385 
	`ä“_©h
(
©h
);

3386 
	`kä“
(
a
);

3388  
»t
;

3389 
	}
}

3391 
	$bŒfs_ioùl_logiÿl_to_šo
(
bŒfs_fs_šfo
 *
fs_šfo
,

3392 
__u£r
 *
¬g
, 
v”siÚ
)

3394 
»t
 = 0;

3395 
size
;

3396 
bŒfs_ioùl_logiÿl_šo_¬gs
 *
loi
;

3397 
bŒfs_d©a_cÚš”
 *
šodes
 = 
NULL
;

3398 
bŒfs_·th
 *
·th
 = 
NULL
;

3399 
boŞ
 
ignÜe_off£t
;

3401 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3402  -
EPERM
;

3404 
loi
 = 
	`memdup_u£r
(
¬g
, (*loi));

3405 ià(
	`IS_ERR
(
loi
))

3406  
	`PTR_ERR
(
loi
);

3408 ià(
v”siÚ
 == 1) {

3409 
ignÜe_off£t
 = 
çl£
;

3410 
size
 = 
	`mš_t
(
u32
, 
loi
->size, 
SZ_64K
);

3413 ià(
	`memchr_šv
(
loi
->
»£rved
, 0, (loi->reserved))) {

3414 
»t
 = -
EINVAL
;

3415 
out_loi
;

3418 ià(
loi
->
æags
 & ~(
BTRFS_LOGICAL_INO_ARGS_IGNORE_OFFSET
)) {

3419 
»t
 = -
EINVAL
;

3420 
out_loi
;

3422 
ignÜe_off£t
 = 
loi
->
æags
 & 
BTRFS_LOGICAL_INO_ARGS_IGNORE_OFFSET
;

3423 
size
 = 
	`mš_t
(
u32
, 
loi
->size, 
SZ_16M
);

3426 
šodes
 = 
	`š™_d©a_cÚš”
(
size
);

3427 ià(
	`IS_ERR
(
šodes
)) {

3428 
»t
 = 
	`PTR_ERR
(
šodes
);

3429 
out_loi
;

3432 
·th
 = 
	`bŒfs_®loc_·th
();

3433 ià(!
·th
) {

3434 
»t
 = -
ENOMEM
;

3435 
out
;

3437 
»t
 = 
	`™”©e_šodes_äom_logiÿl
(
loi
->
logiÿl
, 
fs_šfo
, 
·th
,

3438 
šodes
, 
ignÜe_off£t
);

3439 
	`bŒfs_ä“_·th
(
·th
);

3440 ià(
»t
 =ğ-
EINVAL
)

3441 
»t
 = -
ENOENT
;

3442 ià(
»t
 < 0)

3443 
out
;

3445 
»t
 = 
	`cİy_to_u£r
((
__u£r
 *)()
loi
->
šodes
, inodes,

3446 
size
);

3447 ià(
»t
)

3448 
»t
 = -
EFAULT
;

3450 
out
:

3451 
	`kvä“
(
šodes
);

3452 
out_loi
:

3453 
	`kä“
(
loi
);

3455  
»t
;

3456 
	}
}

3458 
	$bŒfs_upd©e_ioùl_b®ªû_¬gs
(
bŒfs_fs_šfo
 *
fs_šfo
,

3459 
bŒfs_ioùl_b®ªû_¬gs
 *
b¬gs
)

3461 
bŒfs_b®ªû_cÚŒŞ
 *
bùl
 = 
fs_šfo
->
b®ªû_ùl
;

3463 
b¬gs
->
æags
 = 
bùl
->flags;

3465 ià(
	`‹¡_b™
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_šfo
->
æags
))

3466 
b¬gs
->
¡©e
 |ğ
BTRFS_BALANCE_STATE_RUNNING
;

3467 ià(
	`©omic_»ad
(&
fs_šfo
->
b®ªû_·u£_»q
))

3468 
b¬gs
->
¡©e
 |ğ
BTRFS_BALANCE_STATE_PAUSE_REQ
;

3469 ià(
	`©omic_»ad
(&
fs_šfo
->
b®ªû_ÿnûl_»q
))

3470 
b¬gs
->
¡©e
 |ğ
BTRFS_BALANCE_STATE_CANCEL_REQ
;

3472 
	`memıy
(&
b¬gs
->
d©a
, &
bùl
->data, (bargs->data));

3473 
	`memıy
(&
b¬gs
->
m‘a
, &
bùl
->meta, (bargs->meta));

3474 
	`memıy
(&
b¬gs
->
sys
, &
bùl
->sys, (bargs->sys));

3476 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

3477 
	`memıy
(&
b¬gs
->
¡©
, &
bùl
->stat, (bargs->stat));

3478 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

3479 
	}
}

3492 
	$bŒfs_Œy_lock_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
, 
boŞ
 *
exş_acquœed
)

3494 
»t
;

3503 ià(
	`bŒfs_exşİ_¡¬t
(
fs_šfo
, 
BTRFS_EXCLOP_BALANCE
)) {

3504 *
exş_acquœed
 = 
Œue
;

3505 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

3509 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

3510 ià(
fs_šfo
->
b®ªû_ùl
) {

3512 ià(
	`‹¡_b™
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_šfo
->
æags
)) {

3514 
»t
 = -
EINPROGRESS
;

3515 
out_çu»
;

3518 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

3523 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

3525 ià(
fs_šfo
->
b®ªû_ùl
 &&

3526 !
	`‹¡_b™
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_šfo
->
æags
)) {

3528 *
exş_acquœed
 = 
çl£
;

3534 
»t
 = 
BTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
;

3535 
out_çu»
;

3538 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

3541 
out_çu»
:

3542 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

3543 *
exş_acquœed
 = 
çl£
;

3544  
»t
;

3545 
	}
}

3547 
	$bŒfs_ioùl_b®ªû
(
fe
 *fe, 
__u£r
 *
¬g
)

3549 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
	`fe_šode
(
fe
))->root;

3550 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3551 
bŒfs_ioùl_b®ªû_¬gs
 *
b¬gs
;

3552 
bŒfs_b®ªû_cÚŒŞ
 *
bùl
;

3553 
boŞ
 
Ãed_uÆock
 = 
Œue
;

3554 
»t
;

3556 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3557  -
EPERM
;

3559 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

3560 ià(
»t
)

3561  
»t
;

3563 
b¬gs
 = 
	`memdup_u£r
(
¬g
, (*bargs));

3564 ià(
	`IS_ERR
(
b¬gs
)) {

3565 
»t
 = 
	`PTR_ERR
(
b¬gs
);

3566 
b¬gs
 = 
NULL
;

3567 
out
;

3570 
»t
 = 
	`bŒfs_Œy_lock_b®ªû
(
fs_šfo
, &
Ãed_uÆock
);

3571 ià(
»t
)

3572 
out
;

3574 
	`lockd•_as£¹_h–d
(&
fs_šfo
->
b®ªû_mu‹x
);

3576 ià(
b¬gs
->
æags
 & 
BTRFS_BALANCE_RESUME
) {

3577 ià(!
fs_šfo
->
b®ªû_ùl
) {

3578 
»t
 = -
ENOTCONN
;

3579 
out_uÆock
;

3582 
bùl
 = 
fs_šfo
->
b®ªû_ùl
;

3583 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

3584 
bùl
->
æags
 |ğ
BTRFS_BALANCE_RESUME
;

3585 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

3586 
	`bŒfs_exşİ_b®ªû
(
fs_šfo
, 
BTRFS_EXCLOP_BALANCE
);

3588 
do_b®ªû
;

3591 ià(
b¬gs
->
æags
 & ~(
BTRFS_BALANCE_ARGS_MASK
 | 
BTRFS_BALANCE_TYPE_MASK
)) {

3592 
»t
 = -
EINVAL
;

3593 
out_uÆock
;

3596 ià(
fs_šfo
->
b®ªû_ùl
) {

3597 
»t
 = -
EINPROGRESS
;

3598 
out_uÆock
;

3601 
bùl
 = 
	`kz®loc
((*bùl), 
GFP_KERNEL
);

3602 ià(!
bùl
) {

3603 
»t
 = -
ENOMEM
;

3604 
out_uÆock
;

3607 
	`memıy
(&
bùl
->
d©a
, &
b¬gs
->data, (bctl->data));

3608 
	`memıy
(&
bùl
->
m‘a
, &
b¬gs
->meta, (bctl->meta));

3609 
	`memıy
(&
bùl
->
sys
, &
b¬gs
->sys, (bctl->sys));

3611 
bùl
->
æags
 = 
b¬gs
->flags;

3612 
do_b®ªû
:

3619 
Ãed_uÆock
 = 
çl£
;

3621 
»t
 = 
	`bŒfs_b®ªû
(
fs_šfo
, 
bùl
, 
b¬gs
);

3622 
bùl
 = 
NULL
;

3624 ià(
»t
 =ğ0 ||„‘ =ğ-
ECANCELED
) {

3625 ià(
	`cİy_to_u£r
(
¬g
, 
b¬gs
, (*bargs)))

3626 
»t
 = -
EFAULT
;

3629 
	`kä“
(
bùl
);

3630 
out_uÆock
:

3631 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

3632 ià(
Ãed_uÆock
)

3633 
	`bŒfs_exşİ_fšish
(
fs_šfo
);

3634 
out
:

3635 
	`mÁ_drİ_wr™e_fe
(
fe
);

3636 
	`kä“
(
b¬gs
);

3637  
»t
;

3638 
	}
}

3640 
	$bŒfs_ioùl_b®ªû_ùl
(
bŒfs_fs_šfo
 *
fs_šfo
, 
cmd
)

3642 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3643  -
EPERM
;

3645 
cmd
) {

3646 
BTRFS_BALANCE_CTL_PAUSE
:

3647  
	`bŒfs_·u£_b®ªû
(
fs_šfo
);

3648 
BTRFS_BALANCE_CTL_CANCEL
:

3649  
	`bŒfs_ÿnûl_b®ªû
(
fs_šfo
);

3652  -
EINVAL
;

3653 
	}
}

3655 
	$bŒfs_ioùl_b®ªû_´og»ss
(
bŒfs_fs_šfo
 *
fs_šfo
,

3656 
__u£r
 *
¬g
)

3658 
bŒfs_ioùl_b®ªû_¬gs
 *
b¬gs
;

3659 
»t
 = 0;

3661 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3662  -
EPERM
;

3664 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

3665 ià(!
fs_šfo
->
b®ªû_ùl
) {

3666 
»t
 = -
ENOTCONN
;

3667 
out
;

3670 
b¬gs
 = 
	`kz®loc
((*b¬gs), 
GFP_KERNEL
);

3671 ià(!
b¬gs
) {

3672 
»t
 = -
ENOMEM
;

3673 
out
;

3676 
	`bŒfs_upd©e_ioùl_b®ªû_¬gs
(
fs_šfo
, 
b¬gs
);

3678 ià(
	`cİy_to_u£r
(
¬g
, 
b¬gs
, (*bargs)))

3679 
»t
 = -
EFAULT
;

3681 
	`kä“
(
b¬gs
);

3682 
out
:

3683 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

3684  
»t
;

3685 
	}
}

3687 
	$bŒfs_ioùl_quÙa_ùl
(
fe
 *fe, 
__u£r
 *
¬g
)

3689 
šode
 *šodğ
	`fe_šode
(
fe
);

3690 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

3691 
bŒfs_ioùl_quÙa_ùl_¬gs
 *
§
;

3692 
»t
;

3694 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3695  -
EPERM
;

3697 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

3698 ià(
»t
)

3699  
»t
;

3701 
§
 = 
	`memdup_u£r
(
¬g
, (*sa));

3702 ià(
	`IS_ERR
(
§
)) {

3703 
»t
 = 
	`PTR_ERR
(
§
);

3704 
drİ_wr™e
;

3707 
	`down_wr™e
(&
fs_šfo
->
subvŞ_£m
);

3709 
§
->
cmd
) {

3710 
BTRFS_QUOTA_CTL_ENABLE
:

3711 
»t
 = 
	`bŒfs_quÙa_’abË
(
fs_šfo
);

3713 
BTRFS_QUOTA_CTL_DISABLE
:

3714 
»t
 = 
	`bŒfs_quÙa_di§bË
(
fs_šfo
);

3717 
»t
 = -
EINVAL
;

3721 
	`kä“
(
§
);

3722 
	`up_wr™e
(&
fs_šfo
->
subvŞ_£m
);

3723 
drİ_wr™e
:

3724 
	`mÁ_drİ_wr™e_fe
(
fe
);

3725  
»t
;

3726 
	}
}

3728 
	$bŒfs_ioùl_qgroup_assign
(
fe
 *fe, 
__u£r
 *
¬g
)

3730 
šode
 *šodğ
	`fe_šode
(
fe
);

3731 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

3732 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

3733 
bŒfs_ioùl_qgroup_assign_¬gs
 *
§
;

3734 
bŒfs_Œªs_hªdË
 *
Œªs
;

3735 
»t
;

3736 
”r
;

3738 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3739  -
EPERM
;

3741 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

3742 ià(
»t
)

3743  
»t
;

3745 
§
 = 
	`memdup_u£r
(
¬g
, (*sa));

3746 ià(
	`IS_ERR
(
§
)) {

3747 
»t
 = 
	`PTR_ERR
(
§
);

3748 
drİ_wr™e
;

3751 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

3752 ià(
	`IS_ERR
(
Œªs
)) {

3753 
»t
 = 
	`PTR_ERR
(
Œªs
);

3754 
out
;

3757 ià(
§
->
assign
) {

3758 
»t
 = 
	`bŒfs_add_qgroup_»ÏtiÚ
(
Œªs
, 
§
->
¤c
, sa->
d¡
);

3760 
»t
 = 
	`bŒfs_d–_qgroup_»ÏtiÚ
(
Œªs
, 
§
->
¤c
, sa->
d¡
);

3764 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

3765 
”r
 = 
	`bŒfs_run_qgroups
(
Œªs
);

3766 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

3767 ià(
”r
 < 0)

3768 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
”r
,

3770 
”r
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3771 ià(
”r
 && !
»t
)

3772 
»t
 = 
”r
;

3774 
out
:

3775 
	`kä“
(
§
);

3776 
drİ_wr™e
:

3777 
	`mÁ_drİ_wr™e_fe
(
fe
);

3778  
»t
;

3779 
	}
}

3781 
	$bŒfs_ioùl_qgroup_ü—‹
(
fe
 *fe, 
__u£r
 *
¬g
)

3783 
šode
 *šodğ
	`fe_šode
(
fe
);

3784 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

3785 
bŒfs_ioùl_qgroup_ü—‹_¬gs
 *
§
;

3786 
bŒfs_Œªs_hªdË
 *
Œªs
;

3787 
»t
;

3788 
”r
;

3790 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3791  -
EPERM
;

3793 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

3794 ià(
»t
)

3795  
»t
;

3797 
§
 = 
	`memdup_u£r
(
¬g
, (*sa));

3798 ià(
	`IS_ERR
(
§
)) {

3799 
»t
 = 
	`PTR_ERR
(
§
);

3800 
drİ_wr™e
;

3803 ià(!
§
->
qgroupid
) {

3804 
»t
 = -
EINVAL
;

3805 
out
;

3808 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

3809 ià(
	`IS_ERR
(
Œªs
)) {

3810 
»t
 = 
	`PTR_ERR
(
Œªs
);

3811 
out
;

3814 ià(
§
->
ü—‹
) {

3815 
»t
 = 
	`bŒfs_ü—‹_qgroup
(
Œªs
, 
§
->
qgroupid
);

3817 
»t
 = 
	`bŒfs_»move_qgroup
(
Œªs
, 
§
->
qgroupid
);

3820 
”r
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3821 ià(
”r
 && !
»t
)

3822 
»t
 = 
”r
;

3824 
out
:

3825 
	`kä“
(
§
);

3826 
drİ_wr™e
:

3827 
	`mÁ_drİ_wr™e_fe
(
fe
);

3828  
»t
;

3829 
	}
}

3831 
	$bŒfs_ioùl_qgroup_lim™
(
fe
 *fe, 
__u£r
 *
¬g
)

3833 
šode
 *šodğ
	`fe_šode
(
fe
);

3834 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

3835 
bŒfs_ioùl_qgroup_lim™_¬gs
 *
§
;

3836 
bŒfs_Œªs_hªdË
 *
Œªs
;

3837 
»t
;

3838 
”r
;

3839 
u64
 
qgroupid
;

3841 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3842  -
EPERM
;

3844 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

3845 ià(
»t
)

3846  
»t
;

3848 
§
 = 
	`memdup_u£r
(
¬g
, (*sa));

3849 ià(
	`IS_ERR
(
§
)) {

3850 
»t
 = 
	`PTR_ERR
(
§
);

3851 
drİ_wr™e
;

3854 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

3855 ià(
	`IS_ERR
(
Œªs
)) {

3856 
»t
 = 
	`PTR_ERR
(
Œªs
);

3857 
out
;

3860 
qgroupid
 = 
§
->qgroupid;

3861 ià(!
qgroupid
) {

3863 
qgroupid
 = 
roÙ
->
roÙ_key
.
objeùid
;

3866 
»t
 = 
	`bŒfs_lim™_qgroup
(
Œªs
, 
qgroupid
, &
§
->
lim
);

3868 
”r
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3869 ià(
”r
 && !
»t
)

3870 
»t
 = 
”r
;

3872 
out
:

3873 
	`kä“
(
§
);

3874 
drİ_wr™e
:

3875 
	`mÁ_drİ_wr™e_fe
(
fe
);

3876  
»t
;

3877 
	}
}

3879 
	$bŒfs_ioùl_quÙa_»sÿn
(
fe
 *fe, 
__u£r
 *
¬g
)

3881 
šode
 *šodğ
	`fe_šode
(
fe
);

3882 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

3883 
bŒfs_ioùl_quÙa_»sÿn_¬gs
 *
q§
;

3884 
»t
;

3886 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3887  -
EPERM
;

3889 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

3890 ià(
»t
)

3891  
»t
;

3893 
q§
 = 
	`memdup_u£r
(
¬g
, (*qsa));

3894 ià(
	`IS_ERR
(
q§
)) {

3895 
»t
 = 
	`PTR_ERR
(
q§
);

3896 
drİ_wr™e
;

3899 ià(
q§
->
æags
) {

3900 
»t
 = -
EINVAL
;

3901 
out
;

3904 
»t
 = 
	`bŒfs_qgroup_»sÿn
(
fs_šfo
);

3906 
out
:

3907 
	`kä“
(
q§
);

3908 
drİ_wr™e
:

3909 
	`mÁ_drİ_wr™e_fe
(
fe
);

3910  
»t
;

3911 
	}
}

3913 
	$bŒfs_ioùl_quÙa_»sÿn_¡©us
(
bŒfs_fs_šfo
 *
fs_šfo
,

3914 
__u£r
 *
¬g
)

3916 
bŒfs_ioùl_quÙa_»sÿn_¬gs
 
q§
 = {0};

3918 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3919  -
EPERM
;

3921 ià(
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
) {

3922 
q§
.
æags
 = 1;

3923 
q§
.
´og»ss
 = 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
objeùid
;

3926 ià(
	`cİy_to_u£r
(
¬g
, &
q§
, (qsa)))

3927  -
EFAULT
;

3930 
	}
}

3932 
	$bŒfs_ioùl_quÙa_»sÿn_wa™
(
bŒfs_fs_šfo
 *
fs_šfo
,

3933 
__u£r
 *
¬g
)

3935 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3936  -
EPERM
;

3938  
	`bŒfs_qgroup_wa™_fÜ_com¶‘iÚ
(
fs_šfo
, 
Œue
);

3939 
	}
}

3941 
	$_bŒfs_ioùl_£t_»ûived_subvŞ
(
fe
 *file,

3942 
mÁ_idm­
 *
idm­
,

3943 
bŒfs_ioùl_»ûived_subvŞ_¬gs
 *
§
)

3945 
šode
 *šodğ
	`fe_šode
(
fe
);

3946 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

3947 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

3948 
bŒfs_roÙ_™em
 *
roÙ_™em
 = &
roÙ
->root_item;

3949 
bŒfs_Œªs_hªdË
 *
Œªs
;

3950 
time¥ec64
 
ù
 = 
	`cu¼’t_time
(
šode
);

3951 
»t
 = 0;

3952 
»ûived_uuid_chªged
;

3954 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
idm­
, 
šode
))

3955  -
EPERM
;

3957 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

3958 ià(
»t
 < 0)

3959  
»t
;

3961 
	`down_wr™e
(&
fs_šfo
->
subvŞ_£m
);

3963 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)è!ğ
BTRFS_FIRST_FREE_OBJECTID
) {

3964 
»t
 = -
EINVAL
;

3965 
out
;

3968 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
)) {

3969 
»t
 = -
EROFS
;

3970 
out
;

3977 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 3);

3978 ià(
	`IS_ERR
(
Œªs
)) {

3979 
»t
 = 
	`PTR_ERR
(
Œªs
);

3980 
Œªs
 = 
NULL
;

3981 
out
;

3984 
§
->
¹¿nsid
 = 
Œªs
->
Œªsid
;

3985 
§
->
¹ime
.
£c
 = 
ù
.
tv_£c
;

3986 
§
->
¹ime
.
n£c
 = 
ù
.
tv_n£c
;

3988 
»ûived_uuid_chªged
 = 
	`memcmp
(
roÙ_™em
->
»ûived_uuid
, 
§
->
uuid
,

3989 
BTRFS_UUID_SIZE
);

3990 ià(
»ûived_uuid_chªged
 &&

3991 !
	`bŒfs_is_em±y_uuid
(
roÙ_™em
->
»ûived_uuid
)) {

3992 
»t
 = 
	`bŒfs_uuid_Œ“_»move
(
Œªs
, 
roÙ_™em
->
»ûived_uuid
,

3993 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
,

3994 
roÙ
->
roÙ_key
.
objeùid
);

3995 ià(
»t
 &&„‘ !ğ-
ENOENT
) {

3996 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3997 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3998 
out
;

4001 
	`memıy
(
roÙ_™em
->
»ûived_uuid
, 
§
->
uuid
, 
BTRFS_UUID_SIZE
);

4002 
	`bŒfs_£t_roÙ_¡¿nsid
(
roÙ_™em
, 
§
->
¡¿nsid
);

4003 
	`bŒfs_£t_roÙ_¹¿nsid
(
roÙ_™em
, 
§
->
¹¿nsid
);

4004 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
roÙ_™em
->
¡ime
, 
§
->¡ime.
£c
);

4005 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
roÙ_™em
->
¡ime
, 
§
->¡ime.
n£c
);

4006 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
roÙ_™em
->
¹ime
, 
§
->¹ime.
£c
);

4007 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
roÙ_™em
->
¹ime
, 
§
->¹ime.
n£c
);

4009 
»t
 = 
	`bŒfs_upd©e_roÙ
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
,

4010 &
roÙ
->
roÙ_key
, &roÙ->
roÙ_™em
);

4011 ià(
»t
 < 0) {

4012 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4013 
out
;

4015 ià(
»ûived_uuid_chªged
 && !
	`bŒfs_is_em±y_uuid
(
§
->
uuid
)) {

4016 
»t
 = 
	`bŒfs_uuid_Œ“_add
(
Œªs
, 
§
->
uuid
,

4017 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
,

4018 
roÙ
->
roÙ_key
.
objeùid
);

4019 ià(
»t
 < 0 &&„‘ !ğ-
EEXIST
) {

4020 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4021 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4022 
out
;

4025 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

4026 
out
:

4027 
	`up_wr™e
(&
fs_šfo
->
subvŞ_£m
);

4028 
	`mÁ_drİ_wr™e_fe
(
fe
);

4029  
»t
;

4030 
	}
}

4032 #ifdeà
CONFIG_64BIT


4033 
	$bŒfs_ioùl_£t_»ûived_subvŞ_32
(
fe
 *file,

4034 
__u£r
 *
¬g
)

4036 
bŒfs_ioùl_»ûived_subvŞ_¬gs_32
 *
¬gs32
 = 
NULL
;

4037 
bŒfs_ioùl_»ûived_subvŞ_¬gs
 *
¬gs64
 = 
NULL
;

4038 
»t
 = 0;

4040 
¬gs32
 = 
	`memdup_u£r
(
¬g
, (*args32));

4041 ià(
	`IS_ERR
(
¬gs32
))

4042  
	`PTR_ERR
(
¬gs32
);

4044 
¬gs64
 = 
	`km®loc
((*¬gs64), 
GFP_KERNEL
);

4045 ià(!
¬gs64
) {

4046 
»t
 = -
ENOMEM
;

4047 
out
;

4050 
	`memıy
(
¬gs64
->
uuid
, 
¬gs32
->uuid, 
BTRFS_UUID_SIZE
);

4051 
¬gs64
->
¡¿nsid
 = 
¬gs32
->stransid;

4052 
¬gs64
->
¹¿nsid
 = 
¬gs32
->rtransid;

4053 
¬gs64
->
¡ime
.
£c
 = 
¬gs32
->stime.sec;

4054 
¬gs64
->
¡ime
.
n£c
 = 
¬gs32
->stime.nsec;

4055 
¬gs64
->
¹ime
.
£c
 = 
¬gs32
->rtime.sec;

4056 
¬gs64
->
¹ime
.
n£c
 = 
¬gs32
->rtime.nsec;

4057 
¬gs64
->
æags
 = 
¬gs32
->flags;

4059 
»t
 = 
	`_bŒfs_ioùl_£t_»ûived_subvŞ
(
fe
, 
	`fe_mÁ_idm­
(fe), 
¬gs64
);

4060 ià(
»t
)

4061 
out
;

4063 
	`memıy
(
¬gs32
->
uuid
, 
¬gs64
->uuid, 
BTRFS_UUID_SIZE
);

4064 
¬gs32
->
¡¿nsid
 = 
¬gs64
->stransid;

4065 
¬gs32
->
¹¿nsid
 = 
¬gs64
->rtransid;

4066 
¬gs32
->
¡ime
.
£c
 = 
¬gs64
->stime.sec;

4067 
¬gs32
->
¡ime
.
n£c
 = 
¬gs64
->stime.nsec;

4068 
¬gs32
->
¹ime
.
£c
 = 
¬gs64
->rtime.sec;

4069 
¬gs32
->
¹ime
.
n£c
 = 
¬gs64
->rtime.nsec;

4070 
¬gs32
->
æags
 = 
¬gs64
->flags;

4072 
»t
 = 
	`cİy_to_u£r
(
¬g
, 
¬gs32
, (*args32));

4073 ià(
»t
)

4074 
»t
 = -
EFAULT
;

4076 
out
:

4077 
	`kä“
(
¬gs32
);

4078 
	`kä“
(
¬gs64
);

4079  
»t
;

4080 
	}
}

4083 
	$bŒfs_ioùl_£t_»ûived_subvŞ
(
fe
 *file,

4084 
__u£r
 *
¬g
)

4086 
bŒfs_ioùl_»ûived_subvŞ_¬gs
 *
§
 = 
NULL
;

4087 
»t
 = 0;

4089 
§
 = 
	`memdup_u£r
(
¬g
, (*sa));

4090 ià(
	`IS_ERR
(
§
))

4091  
	`PTR_ERR
(
§
);

4093 
»t
 = 
	`_bŒfs_ioùl_£t_»ûived_subvŞ
(
fe
, 
	`fe_mÁ_idm­
(fe), 
§
);

4095 ià(
»t
)

4096 
out
;

4098 
»t
 = 
	`cİy_to_u£r
(
¬g
, 
§
, (*sa));

4099 ià(
»t
)

4100 
»t
 = -
EFAULT
;

4102 
out
:

4103 
	`kä“
(
§
);

4104  
»t
;

4105 
	}
}

4107 
	$bŒfs_ioùl_g‘_f¦ab–
(
bŒfs_fs_šfo
 *
fs_šfo
,

4108 
__u£r
 *
¬g
)

4110 
size_t
 
Ën
;

4111 
»t
;

4112 
Ïb–
[
BTRFS_LABEL_SIZE
];

4114 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

4115 
	`memıy
(
Ïb–
, 
fs_šfo
->
su³r_cİy
->Ïb–, 
BTRFS_LABEL_SIZE
);

4116 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

4118 
Ën
 = 
	`¡ºËn
(
Ïb–
, 
BTRFS_LABEL_SIZE
);

4120 ià(
Ën
 =ğ
BTRFS_LABEL_SIZE
) {

4121 
	`bŒfs_w¬n
(
fs_šfo
,

4123 --
Ën
);

4126 
»t
 = 
	`cİy_to_u£r
(
¬g
, 
Ïb–
, 
Ën
);

4128  
»t
 ? -
EFAULT
 : 0;

4129 
	}
}

4131 
	$bŒfs_ioùl_£t_f¦ab–
(
fe
 *fe, 
__u£r
 *
¬g
)

4133 
šode
 *šodğ
	`fe_šode
(
fe
);

4134 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

4135 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

4136 
bŒfs_su³r_block
 *
su³r_block
 = 
fs_šfo
->
su³r_cİy
;

4137 
bŒfs_Œªs_hªdË
 *
Œªs
;

4138 
Ïb–
[
BTRFS_LABEL_SIZE
];

4139 
»t
;

4141 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

4142  -
EPERM
;

4144 ià(
	`cİy_äom_u£r
(
Ïb–
, 
¬g
, (label)))

4145  -
EFAULT
;

4147 ià(
	`¡ºËn
(
Ïb–
, 
BTRFS_LABEL_SIZE
) == BTRFS_LABEL_SIZE) {

4148 
	`bŒfs_”r
(
fs_šfo
,

4150 
BTRFS_LABEL_SIZE
 - 1);

4151  -
EINVAL
;

4154 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

4155 ià(
»t
)

4156  
»t
;

4158 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

4159 ià(
	`IS_ERR
(
Œªs
)) {

4160 
»t
 = 
	`PTR_ERR
(
Œªs
);

4161 
out_uÆock
;

4164 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

4165 
	`¡rıy
(
su³r_block
->
Ïb–
,†abel);

4166 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

4167 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

4169 
out_uÆock
:

4170 
	`mÁ_drİ_wr™e_fe
(
fe
);

4171  
»t
;

4172 
	}
}

4174 
	#INIT_FEATURE_FLAGS
(
suffix
) \

4175 { .
com·t_æags
 = 
BTRFS_FEATURE_COMPAT_
##
suffix
, \

4176 .
com·t_ro_æags
 = 
BTRFS_FEATURE_COMPAT_RO_
##
suffix
, \

4177 .
šcom·t_æags
 = 
BTRFS_FEATURE_INCOMPAT_
##
suffix
 }

	)

4179 
	$bŒfs_ioùl_g‘_suµÜ‹d_ã©u»s
(
__u£r
 *
¬g
)

4181 cÚ¡ 
bŒfs_ioùl_ã©u»_æags
 
ã©u»s
[3] = {

4182 
	`INIT_FEATURE_FLAGS
(
SUPP
),

4183 
	`INIT_FEATURE_FLAGS
(
SAFE_SET
),

4184 
	`INIT_FEATURE_FLAGS
(
SAFE_CLEAR
)

4187 ià(
	`cİy_to_u£r
(
¬g
, &
ã©u»s
, (features)))

4188  -
EFAULT
;

4191 
	}
}

4193 
	$bŒfs_ioùl_g‘_ã©u»s
(
bŒfs_fs_šfo
 *
fs_šfo
,

4194 
__u£r
 *
¬g
)

4196 
bŒfs_su³r_block
 *
su³r_block
 = 
fs_šfo
->
su³r_cİy
;

4197 
bŒfs_ioùl_ã©u»_æags
 
ã©u»s
;

4199 
ã©u»s
.
com·t_æags
 = 
	`bŒfs_su³r_com·t_æags
(
su³r_block
);

4200 
ã©u»s
.
com·t_ro_æags
 = 
	`bŒfs_su³r_com·t_ro_æags
(
su³r_block
);

4201 
ã©u»s
.
šcom·t_æags
 = 
	`bŒfs_su³r_šcom·t_æags
(
su³r_block
);

4203 ià(
	`cİy_to_u£r
(
¬g
, &
ã©u»s
, (features)))

4204  -
EFAULT
;

4207 
	}
}

4209 
	$check_ã©u»_b™s
(
bŒfs_fs_šfo
 *
fs_šfo
,

4210 
bŒfs_ã©u»_£t
 
£t
,

4211 
u64
 
chªge_mask
, u64 
æags
, u64 
suµÜ‹d_æags
,

4212 
u64
 
§ã_£t
, u64 
§ã_ş—r
)

4214 cÚ¡ *
ty³
 = 
	`bŒfs_ã©u»_£t_Çme
(
£t
);

4215 *
Çmes
;

4216 
u64
 
di§Îowed
, 
unsuµÜ‹d
;

4217 
u64
 
£t_mask
 = 
æags
 & 
chªge_mask
;

4218 
u64
 
ş—r_mask
 = ~
æags
 & 
chªge_mask
;

4220 
unsuµÜ‹d
 = 
£t_mask
 & ~
suµÜ‹d_æags
;

4221 ià(
unsuµÜ‹d
) {

4222 
Çmes
 = 
	`bŒfs_´šbË_ã©u»s
(
£t
, 
unsuµÜ‹d
);

4223 ià(
Çmes
) {

4224 
	`bŒfs_w¬n
(
fs_šfo
,

4226 
Çmes
, 
	`¡rchr
(names, ',') ? "s" : "");

4227 
	`kä“
(
Çmes
);

4229 
	`bŒfs_w¬n
(
fs_šfo
,

4231 
ty³
, 
unsuµÜ‹d
);

4232  -
EOPNOTSUPP
;

4235 
di§Îowed
 = 
£t_mask
 & ~
§ã_£t
;

4236 ià(
di§Îowed
) {

4237 
Çmes
 = 
	`bŒfs_´šbË_ã©u»s
(
£t
, 
di§Îowed
);

4238 ià(
Çmes
) {

4239 
	`bŒfs_w¬n
(
fs_šfo
,

4241 
Çmes
, 
	`¡rchr
(names, ',') ? "s" : "");

4242 
	`kä“
(
Çmes
);

4244 
	`bŒfs_w¬n
(
fs_šfo
,

4246 
ty³
, 
di§Îowed
);

4247  -
EPERM
;

4250 
di§Îowed
 = 
ş—r_mask
 & ~
§ã_ş—r
;

4251 ià(
di§Îowed
) {

4252 
Çmes
 = 
	`bŒfs_´šbË_ã©u»s
(
£t
, 
di§Îowed
);

4253 ià(
Çmes
) {

4254 
	`bŒfs_w¬n
(
fs_šfo
,

4256 
Çmes
, 
	`¡rchr
(names, ',') ? "s" : "");

4257 
	`kä“
(
Çmes
);

4259 
	`bŒfs_w¬n
(
fs_šfo
,

4261 
ty³
, 
di§Îowed
);

4262  -
EPERM
;

4266 
	}
}

4268 
	#check_ã©u»
(
fs_šfo
, 
chªge_mask
, 
æags
, 
mask_ba£
) \

4269 
	`check_ã©u»_b™s
(
fs_šfo
, 
FEAT_
##
mask_ba£
, 
chªge_mask
, 
æags
, \

4270 
BTRFS_FEATURE_
 ## 
mask_ba£
 ## 
_SUPP
, \

4271 
BTRFS_FEATURE_
 ## 
mask_ba£
 ## 
_SAFE_SET
, \

4272 
BTRFS_FEATURE_
 ## 
mask_ba£
 ## 
_SAFE_CLEAR
)

	)

4274 
	$bŒfs_ioùl_£t_ã©u»s
(
fe
 *fe, 
__u£r
 *
¬g
)

4276 
šode
 *šodğ
	`fe_šode
(
fe
);

4277 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

4278 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

4279 
bŒfs_su³r_block
 *
su³r_block
 = 
fs_šfo
->
su³r_cİy
;

4280 
bŒfs_ioùl_ã©u»_æags
 
æags
[2];

4281 
bŒfs_Œªs_hªdË
 *
Œªs
;

4282 
u64
 
Ãwæags
;

4283 
»t
;

4285 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

4286  -
EPERM
;

4288 ià(
	`cİy_äom_u£r
(
æags
, 
¬g
, (flags)))

4289  -
EFAULT
;

4292 ià(!
æags
[0].
com·t_æags
 && !æags[0].
com·t_ro_æags
 &&

4293 !
æags
[0].
šcom·t_æags
)

4296 
»t
 = 
	`check_ã©u»
(
fs_šfo
, 
æags
[0].
com·t_æags
,

4297 
æags
[1].
com·t_æags
, 
COMPAT
);

4298 ià(
»t
)

4299  
»t
;

4301 
»t
 = 
	`check_ã©u»
(
fs_šfo
, 
æags
[0].
com·t_ro_æags
,

4302 
æags
[1].
com·t_ro_æags
, 
COMPAT_RO
);

4303 ià(
»t
)

4304  
»t
;

4306 
»t
 = 
	`check_ã©u»
(
fs_šfo
, 
æags
[0].
šcom·t_æags
,

4307 
æags
[1].
šcom·t_æags
, 
INCOMPAT
);

4308 ià(
»t
)

4309  
»t
;

4311 
»t
 = 
	`mÁ_wªt_wr™e_fe
(
fe
);

4312 ià(
»t
)

4313  
»t
;

4315 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

4316 ià(
	`IS_ERR
(
Œªs
)) {

4317 
»t
 = 
	`PTR_ERR
(
Œªs
);

4318 
out_drİ_wr™e
;

4321 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

4322 
Ãwæags
 = 
	`bŒfs_su³r_com·t_æags
(
su³r_block
);

4323 
Ãwæags
 |ğ
æags
[0].
com·t_æags
 & flags[1].compat_flags;

4324 
Ãwæags
 &ğ~(
æags
[0].
com·t_æags
 & ~flags[1].compat_flags);

4325 
	`bŒfs_£t_su³r_com·t_æags
(
su³r_block
, 
Ãwæags
);

4327 
Ãwæags
 = 
	`bŒfs_su³r_com·t_ro_æags
(
su³r_block
);

4328 
Ãwæags
 |ğ
æags
[0].
com·t_ro_æags
 & flags[1].compat_ro_flags;

4329 
Ãwæags
 &ğ~(
æags
[0].
com·t_ro_æags
 & ~flags[1].compat_ro_flags);

4330 
	`bŒfs_£t_su³r_com·t_ro_æags
(
su³r_block
, 
Ãwæags
);

4332 
Ãwæags
 = 
	`bŒfs_su³r_šcom·t_æags
(
su³r_block
);

4333 
Ãwæags
 |ğ
æags
[0].
šcom·t_æags
 & flags[1].incompat_flags;

4334 
Ãwæags
 &ğ~(
æags
[0].
šcom·t_æags
 & ~flags[1].incompat_flags);

4335 
	`bŒfs_£t_su³r_šcom·t_æags
(
su³r_block
, 
Ãwæags
);

4336 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

4338 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

4339 
out_drİ_wr™e
:

4340 
	`mÁ_drİ_wr™e_fe
(
fe
);

4342  
»t
;

4343 
	}
}

4345 
	$_bŒfs_ioùl_£nd
(
šode
 *šode, 
__u£r
 *
¬gp
, 
boŞ
 
com·t
)

4347 
bŒfs_ioùl_£nd_¬gs
 *
¬g
;

4348 
»t
;

4350 ià(
com·t
) {

4351 #ià
	`defšed
(
CONFIG_64BIT
è&& defšed(
CONFIG_COMPAT
)

4352 
bŒfs_ioùl_£nd_¬gs_32
 
¬gs32
 = { 0 };

4354 
»t
 = 
	`cİy_äom_u£r
(&
¬gs32
, 
¬gp
, (args32));

4355 ià(
»t
)

4356  -
EFAULT
;

4357 
¬g
 = 
	`kz®loc
((*¬g), 
GFP_KERNEL
);

4358 ià(!
¬g
)

4359  -
ENOMEM
;

4360 
¬g
->
£nd_fd
 = 
¬gs32
.send_fd;

4361 
¬g
->
şÚe_sourûs_couÁ
 = 
¬gs32
.clone_sources_count;

4362 
¬g
->
şÚe_sourûs
 = 
	`com·t_±r
(
¬gs32
.clone_sources);

4363 
¬g
->
·»Á_roÙ
 = 
¬gs32
.parent_root;

4364 
¬g
->
æags
 = 
¬gs32
.flags;

4365 
¬g
->
v”siÚ
 = 
¬gs32
.version;

4366 
	`memıy
(
¬g
->
»£rved
, 
¬gs32
.reserved,

4367 (
¬gs32
.
»£rved
));

4369  -
ENOTTY
;

4372 
¬g
 = 
	`memdup_u£r
(
¬gp
, (*arg));

4373 ià(
	`IS_ERR
(
¬g
))

4374  
	`PTR_ERR
(
¬g
);

4376 
»t
 = 
	`bŒfs_ioùl_£nd
(
šode
, 
¬g
);

4377 
	`kä“
(
¬g
);

4378  
»t
;

4379 
	}
}

4381 
	$bŒfs_ioùl_’coded_»ad
(
fe
 *fe, 
__u£r
 *
¬gp
,

4382 
boŞ
 
com·t
)

4384 
bŒfs_ioùl_’coded_io_¬gs
 
¬gs
 = { 0 };

4385 
size_t
 
cİy_’d_k”Ãl
 = 
	`off£toãnd
(
bŒfs_ioùl_’coded_io_¬gs
,

4386 
æags
);

4387 
size_t
 
cİy_’d
;

4388 
iovec
 
iov¡ack
[
UIO_FASTIOV
];

4389 
iovec
 *
iov
 = 
iov¡ack
;

4390 
iov_™”
 
™”
;

4391 
loff_t
 
pos
;

4392 
kiocb
 kiocb;

4393 
ssize_t
 
»t
;

4395 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
)) {

4396 
»t
 = -
EPERM
;

4397 
out_acù
;

4400 ià(
com·t
) {

4401 #ià
	`defšed
(
CONFIG_64BIT
è&& defšed(
CONFIG_COMPAT
)

4402 
bŒfs_ioùl_’coded_io_¬gs_32
 
¬gs32
;

4404 
cİy_’d
 = 
	`off£toãnd
(
bŒfs_ioùl_’coded_io_¬gs_32
,

4405 
æags
);

4406 ià(
	`cİy_äom_u£r
(&
¬gs32
, 
¬gp
, 
cİy_’d
)) {

4407 
»t
 = -
EFAULT
;

4408 
out_acù
;

4410 
¬gs
.
iov
 = 
	`com·t_±r
(
¬gs32
.iov);

4411 
¬gs
.
iovút
 = 
¬gs32
.iovcnt;

4412 
¬gs
.
off£t
 = 
¬gs32
.offset;

4413 
¬gs
.
æags
 = 
¬gs32
.flags;

4415  -
ENOTTY
;

4418 
cİy_’d
 = 
cİy_’d_k”Ãl
;

4419 ià(
	`cİy_äom_u£r
(&
¬gs
, 
¬gp
, 
cİy_’d
)) {

4420 
»t
 = -
EFAULT
;

4421 
out_acù
;

4424 ià(
¬gs
.
æags
 != 0) {

4425 
»t
 = -
EINVAL
;

4426 
out_acù
;

4429 
»t
 = 
	`impÜt_iovec
(
ITER_DEST
, 
¬gs
.
iov
,‡rgs.
iovút
, 
	`ARRAY_SIZE
(
iov¡ack
),

4430 &
iov
, &
™”
);

4431 ià(
»t
 < 0)

4432 
out_acù
;

4434 ià(
	`iov_™”_couÁ
(&
™”
) == 0) {

4435 
»t
 = 0;

4436 
out_iov
;

4438 
pos
 = 
¬gs
.
off£t
;

4439 
»t
 = 
	`rw_v”ify_¬—
(
READ
, 
fe
, &
pos
, 
¬gs
.
Ën
);

4440 ià(
»t
 < 0)

4441 
out_iov
;

4443 
	`š™_sync_kiocb
(&
kiocb
, 
fe
);

4444 
kiocb
.
ki_pos
 = 
pos
;

4446 
»t
 = 
	`bŒfs_’coded_»ad
(&
kiocb
, &
™”
, &
¬gs
);

4447 ià(
»t
 >= 0) {

4448 
	`f¢Ùify_acûss
(
fe
);

4449 ià(
	`cİy_to_u£r
(
¬gp
 + 
cİy_’d
,

4450 (*)&
¬gs
 + 
cİy_’d_k”Ãl
,

4451 (
¬gs
è- 
cİy_’d_k”Ãl
))

4452 
»t
 = -
EFAULT
;

4455 
out_iov
:

4456 
	`kä“
(
iov
);

4457 
out_acù
:

4458 ià(
»t
 > 0)

4459 
	`add_rch¬
(
cu¼’t
, 
»t
);

4460 
	`šc_sysü
(
cu¼’t
);

4461  
»t
;

4462 
	}
}

4464 
	$bŒfs_ioùl_’coded_wr™e
(
fe
 *fe, 
__u£r
 *
¬gp
, 
boŞ
 
com·t
)

4466 
bŒfs_ioùl_’coded_io_¬gs
 
¬gs
;

4467 
iovec
 
iov¡ack
[
UIO_FASTIOV
];

4468 
iovec
 *
iov
 = 
iov¡ack
;

4469 
iov_™”
 
™”
;

4470 
loff_t
 
pos
;

4471 
kiocb
 kiocb;

4472 
ssize_t
 
»t
;

4474 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
)) {

4475 
»t
 = -
EPERM
;

4476 
out_acù
;

4479 ià(!(
fe
->
f_mode
 & 
FMODE_WRITE
)) {

4480 
»t
 = -
EBADF
;

4481 
out_acù
;

4484 ià(
com·t
) {

4485 #ià
	`defšed
(
CONFIG_64BIT
è&& defšed(
CONFIG_COMPAT
)

4486 
bŒfs_ioùl_’coded_io_¬gs_32
 
¬gs32
;

4488 ià(
	`cİy_äom_u£r
(&
¬gs32
, 
¬gp
, (args32))) {

4489 
»t
 = -
EFAULT
;

4490 
out_acù
;

4492 
¬gs
.
iov
 = 
	`com·t_±r
(
¬gs32
.iov);

4493 
¬gs
.
iovút
 = 
¬gs32
.iovcnt;

4494 
¬gs
.
off£t
 = 
¬gs32
.offset;

4495 
¬gs
.
æags
 = 
¬gs32
.flags;

4496 
¬gs
.
Ën
 = 
¬gs32
.len;

4497 
¬gs
.
uÃncoded_Ën
 = 
¬gs32
.unencoded_len;

4498 
¬gs
.
uÃncoded_off£t
 = 
¬gs32
.unencoded_offset;

4499 
¬gs
.
com´essiÚ
 = 
¬gs32
.compression;

4500 
¬gs
.
’üy±iÚ
 = 
¬gs32
.encryption;

4501 
	`memıy
(
¬gs
.
»£rved
, 
¬gs32
.reserved, (args.reserved));

4503  -
ENOTTY
;

4506 ià(
	`cİy_äom_u£r
(&
¬gs
, 
¬gp
, (args))) {

4507 
»t
 = -
EFAULT
;

4508 
out_acù
;

4512 
»t
 = -
EINVAL
;

4513 ià(
¬gs
.
æags
 != 0)

4514 
out_acù
;

4515 ià(
	`memchr_šv
(
¬gs
.
»£rved
, 0, (args.reserved)))

4516 
out_acù
;

4517 ià(
¬gs
.
com´essiÚ
 =ğ
BTRFS_ENCODED_IO_COMPRESSION_NONE
 &&

4518 
¬gs
.
’üy±iÚ
 =ğ
BTRFS_ENCODED_IO_ENCRYPTION_NONE
)

4519 
out_acù
;

4520 ià(
¬gs
.
com´essiÚ
 >ğ
BTRFS_ENCODED_IO_COMPRESSION_TYPES
 ||

4521 
¬gs
.
’üy±iÚ
 >ğ
BTRFS_ENCODED_IO_ENCRYPTION_TYPES
)

4522 
out_acù
;

4523 ià(
¬gs
.
uÃncoded_off£t
 >‡rgs.
uÃncoded_Ën
)

4524 
out_acù
;

4525 ià(
¬gs
.
Ën
 >‡rgs.
uÃncoded_Ën
 -‡rgs.
uÃncoded_off£t
)

4526 
out_acù
;

4528 
»t
 = 
	`impÜt_iovec
(
ITER_SOURCE
, 
¬gs
.
iov
,‡rgs.
iovút
, 
	`ARRAY_SIZE
(
iov¡ack
),

4529 &
iov
, &
™”
);

4530 ià(
»t
 < 0)

4531 
out_acù
;

4533 
	`fe_¡¬t_wr™e
(
fe
);

4535 ià(
	`iov_™”_couÁ
(&
™”
) == 0) {

4536 
»t
 = 0;

4537 
out_’d_wr™e
;

4539 
pos
 = 
¬gs
.
off£t
;

4540 
»t
 = 
	`rw_v”ify_¬—
(
WRITE
, 
fe
, &
pos
, 
¬gs
.
Ën
);

4541 ià(
»t
 < 0)

4542 
out_’d_wr™e
;

4544 
	`š™_sync_kiocb
(&
kiocb
, 
fe
);

4545 
»t
 = 
	`kiocb_£t_rw_æags
(&
kiocb
, 0);

4546 ià(
»t
)

4547 
out_’d_wr™e
;

4548 
kiocb
.
ki_pos
 = 
pos
;

4550 
»t
 = 
	`bŒfs_do_wr™e_™”
(&
kiocb
, &
™”
, &
¬gs
);

4551 ià(
»t
 > 0)

4552 
	`f¢Ùify_modify
(
fe
);

4554 
out_’d_wr™e
:

4555 
	`fe_’d_wr™e
(
fe
);

4556 
	`kä“
(
iov
);

4557 
out_acù
:

4558 ià(
»t
 > 0)

4559 
	`add_wch¬
(
cu¼’t
, 
»t
);

4560 
	`šc_syscw
(
cu¼’t
);

4561  
»t
;

4562 
	}
}

4564 
	$bŒfs_ioùl
(
fe
 *file, 

4565 
cmd
, 
¬g
)

4567 
šode
 *šodğ
	`fe_šode
(
fe
);

4568 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

4569 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

4570 
__u£r
 *
¬gp
 = (__u£¸*)
¬g
;

4572 
cmd
) {

4573 
FS_IOC_GETVERSION
:

4574  
	`bŒfs_ioùl_g‘v”siÚ
(
šode
, 
¬gp
);

4575 
FS_IOC_GETFSLABEL
:

4576  
	`bŒfs_ioùl_g‘_f¦ab–
(
fs_šfo
, 
¬gp
);

4577 
FS_IOC_SETFSLABEL
:

4578  
	`bŒfs_ioùl_£t_f¦ab–
(
fe
, 
¬gp
);

4579 
FITRIM
:

4580  
	`bŒfs_ioùl_f™rim
(
fs_šfo
, 
¬gp
);

4581 
BTRFS_IOC_SNAP_CREATE
:

4582  
	`bŒfs_ioùl_¢­_ü—‹
(
fe
, 
¬gp
, 0);

4583 
BTRFS_IOC_SNAP_CREATE_V2
:

4584  
	`bŒfs_ioùl_¢­_ü—‹_v2
(
fe
, 
¬gp
, 0);

4585 
BTRFS_IOC_SUBVOL_CREATE
:

4586  
	`bŒfs_ioùl_¢­_ü—‹
(
fe
, 
¬gp
, 1);

4587 
BTRFS_IOC_SUBVOL_CREATE_V2
:

4588  
	`bŒfs_ioùl_¢­_ü—‹_v2
(
fe
, 
¬gp
, 1);

4589 
BTRFS_IOC_SNAP_DESTROY
:

4590  
	`bŒfs_ioùl_¢­_de¡roy
(
fe
, 
¬gp
, 
çl£
);

4591 
BTRFS_IOC_SNAP_DESTROY_V2
:

4592  
	`bŒfs_ioùl_¢­_de¡roy
(
fe
, 
¬gp
, 
Œue
);

4593 
BTRFS_IOC_SUBVOL_GETFLAGS
:

4594  
	`bŒfs_ioùl_subvŞ_g‘æags
(
šode
, 
¬gp
);

4595 
BTRFS_IOC_SUBVOL_SETFLAGS
:

4596  
	`bŒfs_ioùl_subvŞ_£tæags
(
fe
, 
¬gp
);

4597 
BTRFS_IOC_DEFAULT_SUBVOL
:

4598  
	`bŒfs_ioùl_deçuÉ_subvŞ
(
fe
, 
¬gp
);

4599 
BTRFS_IOC_DEFRAG
:

4600  
	`bŒfs_ioùl_deäag
(
fe
, 
NULL
);

4601 
BTRFS_IOC_DEFRAG_RANGE
:

4602  
	`bŒfs_ioùl_deäag
(
fe
, 
¬gp
);

4603 
BTRFS_IOC_RESIZE
:

4604  
	`bŒfs_ioùl_»size
(
fe
, 
¬gp
);

4605 
BTRFS_IOC_ADD_DEV
:

4606  
	`bŒfs_ioùl_add_dev
(
fs_šfo
, 
¬gp
);

4607 
BTRFS_IOC_RM_DEV
:

4608  
	`bŒfs_ioùl_rm_dev
(
fe
, 
¬gp
);

4609 
BTRFS_IOC_RM_DEV_V2
:

4610  
	`bŒfs_ioùl_rm_dev_v2
(
fe
, 
¬gp
);

4611 
BTRFS_IOC_FS_INFO
:

4612  
	`bŒfs_ioùl_fs_šfo
(
fs_šfo
, 
¬gp
);

4613 
BTRFS_IOC_DEV_INFO
:

4614  
	`bŒfs_ioùl_dev_šfo
(
fs_šfo
, 
¬gp
);

4615 
BTRFS_IOC_TREE_SEARCH
:

4616  
	`bŒfs_ioùl_Œ“_£¬ch
(
šode
, 
¬gp
);

4617 
BTRFS_IOC_TREE_SEARCH_V2
:

4618  
	`bŒfs_ioùl_Œ“_£¬ch_v2
(
šode
, 
¬gp
);

4619 
BTRFS_IOC_INO_LOOKUP
:

4620  
	`bŒfs_ioùl_šo_lookup
(
roÙ
, 
¬gp
);

4621 
BTRFS_IOC_INO_PATHS
:

4622  
	`bŒfs_ioùl_šo_to_·th
(
roÙ
, 
¬gp
);

4623 
BTRFS_IOC_LOGICAL_INO
:

4624  
	`bŒfs_ioùl_logiÿl_to_šo
(
fs_šfo
, 
¬gp
, 1);

4625 
BTRFS_IOC_LOGICAL_INO_V2
:

4626  
	`bŒfs_ioùl_logiÿl_to_šo
(
fs_šfo
, 
¬gp
, 2);

4627 
BTRFS_IOC_SPACE_INFO
:

4628  
	`bŒfs_ioùl_¥aû_šfo
(
fs_šfo
, 
¬gp
);

4629 
BTRFS_IOC_SYNC
: {

4630 
»t
;

4632 
»t
 = 
	`bŒfs_¡¬t_d–®loc_roÙs
(
fs_šfo
, 
LONG_MAX
, 
çl£
);

4633 ià(
»t
)

4634  
»t
;

4635 
»t
 = 
	`bŒfs_sync_fs
(
šode
->
i_sb
, 1);

4641 
	`wake_up_´oûss
(
fs_šfo
->
Œª§ùiÚ_kth»ad
);

4642  
»t
;

4644 
BTRFS_IOC_START_SYNC
:

4645  
	`bŒfs_ioùl_¡¬t_sync
(
roÙ
, 
¬gp
);

4646 
BTRFS_IOC_WAIT_SYNC
:

4647  
	`bŒfs_ioùl_wa™_sync
(
fs_šfo
, 
¬gp
);

4648 
BTRFS_IOC_SCRUB
:

4649  
	`bŒfs_ioùl_süub
(
fe
, 
¬gp
);

4650 
BTRFS_IOC_SCRUB_CANCEL
:

4651  
	`bŒfs_ioùl_süub_ÿnûl
(
fs_šfo
);

4652 
BTRFS_IOC_SCRUB_PROGRESS
:

4653  
	`bŒfs_ioùl_süub_´og»ss
(
fs_šfo
, 
¬gp
);

4654 
BTRFS_IOC_BALANCE_V2
:

4655  
	`bŒfs_ioùl_b®ªû
(
fe
, 
¬gp
);

4656 
BTRFS_IOC_BALANCE_CTL
:

4657  
	`bŒfs_ioùl_b®ªû_ùl
(
fs_šfo
, 
¬g
);

4658 
BTRFS_IOC_BALANCE_PROGRESS
:

4659  
	`bŒfs_ioùl_b®ªû_´og»ss
(
fs_šfo
, 
¬gp
);

4660 
BTRFS_IOC_SET_RECEIVED_SUBVOL
:

4661  
	`bŒfs_ioùl_£t_»ûived_subvŞ
(
fe
, 
¬gp
);

4662 #ifdeà
CONFIG_64BIT


4663 
BTRFS_IOC_SET_RECEIVED_SUBVOL_32
:

4664  
	`bŒfs_ioùl_£t_»ûived_subvŞ_32
(
fe
, 
¬gp
);

4666 
BTRFS_IOC_SEND
:

4667  
	`_bŒfs_ioùl_£nd
(
šode
, 
¬gp
, 
çl£
);

4668 #ià
	`defšed
(
CONFIG_64BIT
è&& defšed(
CONFIG_COMPAT
)

4669 
BTRFS_IOC_SEND_32
:

4670  
	`_bŒfs_ioùl_£nd
(
šode
, 
¬gp
, 
Œue
);

4672 
BTRFS_IOC_GET_DEV_STATS
:

4673  
	`bŒfs_ioùl_g‘_dev_¡©s
(
fs_šfo
, 
¬gp
);

4674 
BTRFS_IOC_QUOTA_CTL
:

4675  
	`bŒfs_ioùl_quÙa_ùl
(
fe
, 
¬gp
);

4676 
BTRFS_IOC_QGROUP_ASSIGN
:

4677  
	`bŒfs_ioùl_qgroup_assign
(
fe
, 
¬gp
);

4678 
BTRFS_IOC_QGROUP_CREATE
:

4679  
	`bŒfs_ioùl_qgroup_ü—‹
(
fe
, 
¬gp
);

4680 
BTRFS_IOC_QGROUP_LIMIT
:

4681  
	`bŒfs_ioùl_qgroup_lim™
(
fe
, 
¬gp
);

4682 
BTRFS_IOC_QUOTA_RESCAN
:

4683  
	`bŒfs_ioùl_quÙa_»sÿn
(
fe
, 
¬gp
);

4684 
BTRFS_IOC_QUOTA_RESCAN_STATUS
:

4685  
	`bŒfs_ioùl_quÙa_»sÿn_¡©us
(
fs_šfo
, 
¬gp
);

4686 
BTRFS_IOC_QUOTA_RESCAN_WAIT
:

4687  
	`bŒfs_ioùl_quÙa_»sÿn_wa™
(
fs_šfo
, 
¬gp
);

4688 
BTRFS_IOC_DEV_REPLACE
:

4689  
	`bŒfs_ioùl_dev_»¶aû
(
fs_šfo
, 
¬gp
);

4690 
BTRFS_IOC_GET_SUPPORTED_FEATURES
:

4691  
	`bŒfs_ioùl_g‘_suµÜ‹d_ã©u»s
(
¬gp
);

4692 
BTRFS_IOC_GET_FEATURES
:

4693  
	`bŒfs_ioùl_g‘_ã©u»s
(
fs_šfo
, 
¬gp
);

4694 
BTRFS_IOC_SET_FEATURES
:

4695  
	`bŒfs_ioùl_£t_ã©u»s
(
fe
, 
¬gp
);

4696 
BTRFS_IOC_GET_SUBVOL_INFO
:

4697  
	`bŒfs_ioùl_g‘_subvŞ_šfo
(
šode
, 
¬gp
);

4698 
BTRFS_IOC_GET_SUBVOL_ROOTREF
:

4699  
	`bŒfs_ioùl_g‘_subvŞ_roÙ»f
(
roÙ
, 
¬gp
);

4700 
BTRFS_IOC_INO_LOOKUP_USER
:

4701  
	`bŒfs_ioùl_šo_lookup_u£r
(
fe
, 
¬gp
);

4702 
FS_IOC_ENABLE_VERITY
:

4703  
	`fsv”™y_ioùl_’abË
(
fe
, (cÚ¡ 
__u£r
 *)
¬gp
);

4704 
FS_IOC_MEASURE_VERITY
:

4705  
	`fsv”™y_ioùl_m—su»
(
fe
, 
¬gp
);

4706 
BTRFS_IOC_ENCODED_READ
:

4707  
	`bŒfs_ioùl_’coded_»ad
(
fe
, 
¬gp
, 
çl£
);

4708 
BTRFS_IOC_ENCODED_WRITE
:

4709  
	`bŒfs_ioùl_’coded_wr™e
(
fe
, 
¬gp
, 
çl£
);

4710 #ià
	`defšed
(
CONFIG_64BIT
è&& defšed(
CONFIG_COMPAT
)

4711 
BTRFS_IOC_ENCODED_READ_32
:

4712  
	`bŒfs_ioùl_’coded_»ad
(
fe
, 
¬gp
, 
Œue
);

4713 
BTRFS_IOC_ENCODED_WRITE_32
:

4714  
	`bŒfs_ioùl_’coded_wr™e
(
fe
, 
¬gp
, 
Œue
);

4718  -
ENOTTY
;

4719 
	}
}

4721 #ifdeà
CONFIG_COMPAT


4722 
	$bŒfs_com·t_ioùl
(
fe
 *fe, 
cmd
, 
¬g
)

4728 
cmd
) {

4729 
FS_IOC32_GETVERSION
:

4730 
cmd
 = 
FS_IOC_GETVERSION
;

4734  
	`bŒfs_ioùl
(
fe
, 
cmd
, (è
	`com·t_±r
(
¬g
));

4735 
	}
}

	@ioctl.h

3 #iâdeà
BTRFS_IOCTL_H


4 
	#BTRFS_IOCTL_H


	)

6 
bŒfs_ioùl
(
fe
 *fe, 
cmd
, 
¬g
);

7 
bŒfs_com·t_ioùl
(
fe
 *fe, 
cmd
, 
¬g
);

8 
bŒfs_f—‰r_g‘
(
d’Œy
 *d’Œy, 
f—‰r
 *
ç
);

9 
bŒfs_f—‰r_£t
(
mÁ_idm­
 *
idm­
,

10 
d’Œy
 *d’Œy, 
f—‰r
 *
ç
);

11 
bŒfs_ioùl_g‘_suµÜ‹d_ã©u»s
(
__u£r
 *
¬g
);

12 
bŒfs_sync_šode_æags_to_i_æags
(
šode
 *inode);

13 
__pu»
 
bŒfs_is_em±y_uuid
(
u8
 *
uuid
);

14 
bŒfs_upd©e_ioùl_b®ªû_¬gs
(
bŒfs_fs_šfo
 *
fs_šfo
,

15 
bŒfs_ioùl_b®ªû_¬gs
 *
b¬gs
);

	@locking.c

6 
	~<lšux/sched.h
>

7 
	~<lšux/·gem­.h
>

8 
	~<lšux/¥šlock.h
>

9 
	~<lšux/·ge-æags.h
>

10 
	~<asm/bug.h
>

11 
	~"misc.h
"

12 
	~"ù»e.h
"

13 
	~"ex‹Á_io.h
"

14 
	~"lockšg.h
"

15 
	~"acûssÜs.h
"

40 #ifdeà
CONFIG_DEBUG_LOCK_ALLOC


41 #ià
BTRFS_MAX_LEVEL
 != 8

45 
	#DEFINE_LEVEL
(
¡em
, 
Ëv–
) \

46 .
Çmes
[
Ëv–
] = "bŒfs-" 
¡em
 "-0" #Ëv–,

	)

48 
	#DEFINE_NAME
(
¡em
) \

49 
	`DEFINE_LEVEL
(
¡em
, 0) \

50 
	`DEFINE_LEVEL
(
¡em
, 1) \

51 
	`DEFINE_LEVEL
(
¡em
, 2) \

52 
	`DEFINE_LEVEL
(
¡em
, 3) \

53 
	`DEFINE_LEVEL
(
¡em
, 4) \

54 
	`DEFINE_LEVEL
(
¡em
, 5) \

55 
	`DEFINE_LEVEL
(
¡em
, 6) \

56 
	`DEFINE_LEVEL
(
¡em
, 7)

	)

58 
	sbŒfs_lockd•_key£t
 {

59 
u64
 
	mid
;

61 
	mÇmes
[
BTRFS_MAX_LEVEL
][24];

62 
lock_şass_key
 
	mkeys
[
BTRFS_MAX_LEVEL
];

63 } 
	gbŒfs_lockd•_key£ts
[] = {

64 { .
id
 = 
BTRFS_ROOT_TREE_OBJECTID
, 
DEFINE_NAME
("root") },

65 { .
	gid
 = 
BTRFS_EXTENT_TREE_OBJECTID
, 
DEFINE_NAME
("extent") },

66 { .
	gid
 = 
BTRFS_CHUNK_TREE_OBJECTID
, 
DEFINE_NAME
("chunk") },

67 { .
	gid
 = 
BTRFS_DEV_TREE_OBJECTID
, 
DEFINE_NAME
("dev") },

68 { .
	gid
 = 
BTRFS_CSUM_TREE_OBJECTID
, 
DEFINE_NAME
("csum") },

69 { .
	gid
 = 
BTRFS_QUOTA_TREE_OBJECTID
, 
DEFINE_NAME
("quota") },

70 { .
	gid
 = 
BTRFS_TREE_LOG_OBJECTID
, 
DEFINE_NAME
("log") },

71 { .
	gid
 = 
BTRFS_TREE_RELOC_OBJECTID
, 
DEFINE_NAME
("treloc") },

72 { .
	gid
 = 
BTRFS_DATA_RELOC_TREE_OBJECTID
, 
DEFINE_NAME
("dreloc") },

73 { .
	gid
 = 
BTRFS_UUID_TREE_OBJECTID
, 
DEFINE_NAME
("uuid") },

74 { .
	gid
 = 
BTRFS_FREE_SPACE_TREE_OBJECTID
, 
DEFINE_NAME
("free-space") },

75 { .
	gid
 = 
BTRFS_BLOCK_GROUP_TREE_OBJECTID
, 
DEFINE_NAME
("block-group") },

76 { .
	gid
 = 0, 
DEFINE_NAME
("tree") },

79 #undeà
DEFINE_LEVEL


80 #undeà
DEFINE_NAME


82 
	$bŒfs_£t_bufãr_lockd•_şass
(
u64
 
objeùid
, 
ex‹Á_bufãr
 *
eb
, 
Ëv–
)

84 
bŒfs_lockd•_key£t
 *
ks
;

86 
	`BUG_ON
(
Ëv–
 >ğ
	`ARRAY_SIZE
(
ks
->
keys
));

89 
ks
 = 
bŒfs_lockd•_key£ts
; ks->
id
; ks++)

90 ià(
ks
->
id
 =ğ
objeùid
)

93 
	`lockd•_£t_şass_ªd_Çme
(&
eb
->
lock
, &
ks
->
keys
[
Ëv–
], ks->
Çmes
[level]);

94 
	}
}

96 
	$bŒfs_maybe_»£t_lockd•_şass
(
bŒfs_roÙ
 *
roÙ
, 
ex‹Á_bufãr
 *
eb
)

98 ià(
	`‹¡_b™
(
BTRFS_ROOT_RESET_LOCKDEP_CLASS
, &
roÙ
->
¡©e
))

99 
	`bŒfs_£t_bufãr_lockd•_şass
(
roÙ
->
roÙ_key
.
objeùid
,

100 
eb
, 
	`bŒfs_h—d”_Ëv–
(eb));

101 
	}
}

129 
	$__bŒfs_Œ“_»ad_lock
(
ex‹Á_bufãr
 *
eb
, 
bŒfs_lock_Ã¡šg
 
Ã¡
)

131 
u64
 
¡¬t_ns
 = 0;

133 ià(
	`Œaû_bŒfs_Œ“_»ad_lock_’abËd
())

134 
¡¬t_ns
 = 
	`ktime_g‘_ns
();

136 
	`down_»ad_Ã¡ed
(&
eb
->
lock
, 
Ã¡
);

137 
	`Œaû_bŒfs_Œ“_»ad_lock
(
eb
, 
¡¬t_ns
);

138 
	}
}

140 
	$bŒfs_Œ“_»ad_lock
(
ex‹Á_bufãr
 *
eb
)

142 
	`__bŒfs_Œ“_»ad_lock
(
eb
, 
BTRFS_NESTING_NORMAL
);

143 
	}
}

150 
	$bŒfs_Œy_Œ“_»ad_lock
(
ex‹Á_bufãr
 *
eb
)

152 ià(
	`down_»ad_Œylock
(&
eb
->
lock
)) {

153 
	`Œaû_bŒfs_Œy_Œ“_»ad_lock
(
eb
);

157 
	}
}

164 
	$bŒfs_Œy_Œ“_wr™e_lock
(
ex‹Á_bufãr
 *
eb
)

166 ià(
	`down_wr™e_Œylock
(&
eb
->
lock
)) {

167 
eb
->
lock_owÃr
 = 
cu¼’t
->
pid
;

168 
	`Œaû_bŒfs_Œy_Œ“_wr™e_lock
(
eb
);

172 
	}
}

177 
	$bŒfs_Œ“_»ad_uÆock
(
ex‹Á_bufãr
 *
eb
)

179 
	`Œaû_bŒfs_Œ“_»ad_uÆock
(
eb
);

180 
	`up_»ad
(&
eb
->
lock
);

181 
	}
}

190 
	$__bŒfs_Œ“_lock
(
ex‹Á_bufãr
 *
eb
, 
bŒfs_lock_Ã¡šg
 
Ã¡
)

191 
	`__acquœes
(&
eb
->
lock
)

193 
u64
 
¡¬t_ns
 = 0;

195 ià(
	`Œaû_bŒfs_Œ“_lock_’abËd
())

196 
¡¬t_ns
 = 
	`ktime_g‘_ns
();

198 
	`down_wr™e_Ã¡ed
(&
eb
->
lock
, 
Ã¡
);

199 
eb
->
lock_owÃr
 = 
cu¼’t
->
pid
;

200 
	`Œaû_bŒfs_Œ“_lock
(
eb
, 
¡¬t_ns
);

201 
	}
}

203 
	$bŒfs_Œ“_lock
(
ex‹Á_bufãr
 *
eb
)

205 
	`__bŒfs_Œ“_lock
(
eb
, 
BTRFS_NESTING_NORMAL
);

206 
	}
}

211 
	$bŒfs_Œ“_uÆock
(
ex‹Á_bufãr
 *
eb
)

213 
	`Œaû_bŒfs_Œ“_uÆock
(
eb
);

214 
eb
->
lock_owÃr
 = 0;

215 
	`up_wr™e
(&
eb
->
lock
);

216 
	}
}

227 
	$bŒfs_uÆock_up_§ã
(
bŒfs_·th
 *
·th
, 
Ëv–
)

229 
i
;

231 ià(
·th
->
k“p_locks
)

234 
i
 = 
Ëv–
; i < 
BTRFS_MAX_LEVEL
; i++) {

235 ià(!
·th
->
nodes
[
i
])

237 ià(!
·th
->
locks
[
i
])

239 
	`bŒfs_Œ“_uÆock_rw
(
·th
->
nodes
[
i
],…©h->
locks
[i]);

240 
·th
->
locks
[
i
] = 0;

242 
	}
}

250 
ex‹Á_bufãr
 *
	$bŒfs_lock_roÙ_node
(
bŒfs_roÙ
 *
roÙ
)

252 
ex‹Á_bufãr
 *
eb
;

255 
eb
 = 
	`bŒfs_roÙ_node
(
roÙ
);

257 
	`bŒfs_maybe_»£t_lockd•_şass
(
roÙ
, 
eb
);

258 
	`bŒfs_Œ“_lock
(
eb
);

259 ià(
eb
 =ğ
roÙ
->
node
)

261 
	`bŒfs_Œ“_uÆock
(
eb
);

262 
	`ä“_ex‹Á_bufãr
(
eb
);

264  
eb
;

265 
	}
}

273 
ex‹Á_bufãr
 *
	$bŒfs_»ad_lock_roÙ_node
(
bŒfs_roÙ
 *
roÙ
)

275 
ex‹Á_bufãr
 *
eb
;

278 
eb
 = 
	`bŒfs_roÙ_node
(
roÙ
);

280 
	`bŒfs_maybe_»£t_lockd•_şass
(
roÙ
, 
eb
);

281 
	`bŒfs_Œ“_»ad_lock
(
eb
);

282 ià(
eb
 =ğ
roÙ
->
node
)

284 
	`bŒfs_Œ“_»ad_uÆock
(
eb
);

285 
	`ä“_ex‹Á_bufãr
(
eb
);

287  
eb
;

288 
	}
}

297 
ex‹Á_bufãr
 *
	$bŒfs_Œy_»ad_lock_roÙ_node
(
bŒfs_roÙ
 *
roÙ
)

299 
ex‹Á_bufãr
 *
eb
;

302 
eb
 = 
	`bŒfs_roÙ_node
(
roÙ
);

303 ià(!
	`bŒfs_Œy_Œ“_»ad_lock
(
eb
)) {

304 
	`ä“_ex‹Á_bufãr
(
eb
);

305  
	`ERR_PTR
(-
EAGAIN
);

307 ià(
eb
 =ğ
roÙ
->
node
)

309 
	`bŒfs_Œ“_»ad_uÆock
(
eb
);

310 
	`ä“_ex‹Á_bufãr
(
eb
);

312  
eb
;

313 
	}
}

329 
	$bŒfs_d»w_lock_š™
(
bŒfs_d»w_lock
 *
lock
)

331 
	`©omic_£t
(&
lock
->
»ad”s
, 0);

332 
	`©omic_£t
(&
lock
->
wr™”s
, 0);

333 
	`š™_wa™queue_h—d
(&
lock
->
³ndšg_»ad”s
);

334 
	`š™_wa™queue_h—d
(&
lock
->
³ndšg_wr™”s
);

335 
	}
}

338 
boŞ
 
	$bŒfs_d»w_Œy_wr™e_lock
(
bŒfs_d»w_lock
 *
lock
)

340 ià(
	`©omic_»ad
(&
lock
->
»ad”s
))

341  
çl£
;

343 
	`©omic_šc
(&
lock
->
wr™”s
);

346 
	`smp_mb__aá”_©omic
();

347 ià(
	`©omic_»ad
(&
lock
->
»ad”s
)) {

348 
	`bŒfs_d»w_wr™e_uÆock
(
lock
);

349  
çl£
;

352  
Œue
;

353 
	}
}

355 
	$bŒfs_d»w_wr™e_lock
(
bŒfs_d»w_lock
 *
lock
)

357 
Œue
) {

358 ià(
	`bŒfs_d»w_Œy_wr™e_lock
(
lock
))

360 
	`wa™_ev’t
(
lock
->
³ndšg_wr™”s
, !
	`©omic_»ad
(&lock->
»ad”s
));

362 
	}
}

364 
	$bŒfs_d»w_wr™e_uÆock
(
bŒfs_d»w_lock
 *
lock
)

366 
	`©omic_dec
(&
lock
->
wr™”s
);

367 
	`cÚd_wake_up
(&
lock
->
³ndšg_»ad”s
);

368 
	}
}

370 
	$bŒfs_d»w_»ad_lock
(
bŒfs_d»w_lock
 *
lock
)

372 
	`©omic_šc
(&
lock
->
»ad”s
);

380 
	`smp_mb__aá”_©omic
();

382 
	`wa™_ev’t
(
lock
->
³ndšg_»ad”s
, 
	`©omic_»ad
(&lock->
wr™”s
) == 0);

383 
	}
}

385 
	$bŒfs_d»w_»ad_uÆock
(
bŒfs_d»w_lock
 *
lock
)

391 ià(
	`©omic_dec_ªd_‹¡
(&
lock
->
»ad”s
))

392 
	`wake_up
(&
lock
->
³ndšg_wr™”s
);

393 
	}
}

	@locking.h

6 #iâdeà
BTRFS_LOCKING_H


7 
	#BTRFS_LOCKING_H


	)

9 
	~<lšux/©omic.h
>

10 
	~<lšux/wa™.h
>

11 
	~<lšux/³rıu_couÁ”.h
>

12 
	~"ex‹Á_io.h
"

14 
	#BTRFS_WRITE_LOCK
 1

	)

15 
	#BTRFS_READ_LOCK
 2

	)

22 
	ebŒfs_lock_Ã¡šg
 {

23 
	mBTRFS_NESTING_NORMAL
,

31 
	mBTRFS_NESTING_COW
,

42 
	mBTRFS_NESTING_LEFT
,

43 
	mBTRFS_NESTING_RIGHT
,

50 
	mBTRFS_NESTING_LEFT_COW
,

51 
	mBTRFS_NESTING_RIGHT_COW
,

60 
	mBTRFS_NESTING_SPLIT
,

69 
	mBTRFS_NESTING_NEW_ROOT
,

78 
	mBTRFS_NESTING_MAX
,

81 
	ebŒfs_lockd•_Œªs_¡©es
 {

82 
	mBTRFS_LOCKDEP_TRANS_COMMIT_PREP
,

83 
	mBTRFS_LOCKDEP_TRANS_UNBLOCKED
,

84 
	mBTRFS_LOCKDEP_TRANS_SUPER_COMMITTED
,

85 
	mBTRFS_LOCKDEP_TRANS_COMPLETED
,

99 
	#bŒfs_might_wa™_fÜ_ev’t
(
owÃr
, 
lock
) \

101 
	`rw£m_acquœe
(&
owÃr
->
lock
##
_m­
, 0, 0, 
_THIS_IP_
); \

102 
	`rw£m_»Ëa£
(&
owÃr
->
lock
##
_m­
, 
_THIS_IP_
); \

103 } 0)

	)

116 
	#bŒfs_lockd•_acquœe
(
owÃr
, 
lock
) \

117 
	`rw£m_acquœe_»ad
(&
owÃr
->
lock
##
_m­
, 0, 0, 
_THIS_IP_
)

	)

123 
	#bŒfs_lockd•_»Ëa£
(
owÃr
, 
lock
) \

124 
	`rw£m_»Ëa£
(&
owÃr
->
lock
##
_m­
, 
_THIS_IP_
)

	)

130 
	#bŒfs_might_wa™_fÜ_¡©e
(
owÃr
, 
i
) \

132 
	`rw£m_acquœe
(&
owÃr
->
bŒfs_¡©e_chªge_m­
[
i
], 0, 0, 
_THIS_IP_
); \

133 
	`rw£m_»Ëa£
(&
owÃr
->
bŒfs_¡©e_chªge_m­
[
i
], 
_THIS_IP_
); \

134 } 0)

	)

136 
	#bŒfs_Œªs_¡©e_lockd•_acquœe
(
owÃr
, 
i
) \

137 
	`rw£m_acquœe_»ad
(&
owÃr
->
bŒfs_¡©e_chªge_m­
[
i
], 0, 0, 
_THIS_IP_
)

	)

139 
	#bŒfs_Œªs_¡©e_lockd•_»Ëa£
(
owÃr
, 
i
) \

140 
	`rw£m_»Ëa£
(&
owÃr
->
bŒfs_¡©e_chªge_m­
[
i
], 
_THIS_IP_
)

	)

143 
	#bŒfs_lockd•_š™_m­
(
owÃr
, 
lock
) \

145 
lock_şass_key
 
lock
##
_key
; \

146 
	`lockd•_š™_m­
(&
owÃr
->
lock
##
_m­
, #lock, &lock##
_key
, 0); \

147 } 0)

	)

150 
	#bŒfs_¡©e_lockd•_š™_m­
(
owÃr
, 
lock
, 
¡©e
) \

152 
lock_şass_key
 
lock
##
_key
; \

153 
	`lockd•_š™_m­
(&
owÃr
->
bŒfs_¡©e_chªge_m­
[
¡©e
], #lock, \

154 &
lock
##
_key
, 0); \

155 } 0)

	)

157 
¡©ic_as£¹
(
BTRFS_NESTING_MAX
 <ğ
MAX_LOCKDEP_SUBCLASSES
,

160 
	gbŒfs_·th
;

162 
__bŒfs_Œ“_lock
(
ex‹Á_bufãr
 *
eb
, 
bŒfs_lock_Ã¡šg
 
Ã¡
);

163 
bŒfs_Œ“_lock
(
ex‹Á_bufãr
 *
eb
);

164 
bŒfs_Œ“_uÆock
(
ex‹Á_bufãr
 *
eb
);

166 
__bŒfs_Œ“_»ad_lock
(
ex‹Á_bufãr
 *
eb
, 
bŒfs_lock_Ã¡šg
 
Ã¡
);

167 
bŒfs_Œ“_»ad_lock
(
ex‹Á_bufãr
 *
eb
);

168 
bŒfs_Œ“_»ad_uÆock
(
ex‹Á_bufãr
 *
eb
);

169 
bŒfs_Œy_Œ“_»ad_lock
(
ex‹Á_bufãr
 *
eb
);

170 
bŒfs_Œy_Œ“_wr™e_lock
(
ex‹Á_bufãr
 *
eb
);

171 
ex‹Á_bufãr
 *
bŒfs_lock_roÙ_node
(
bŒfs_roÙ
 *
roÙ
);

172 
ex‹Á_bufãr
 *
bŒfs_»ad_lock_roÙ_node
(
bŒfs_roÙ
 *
roÙ
);

173 
ex‹Á_bufãr
 *
bŒfs_Œy_»ad_lock_roÙ_node
(
bŒfs_roÙ
 *
roÙ
);

175 #ifdeà
CONFIG_BTRFS_DEBUG


176 
šlše
 
	$bŒfs_as£¹_Œ“_wr™e_locked
(
ex‹Á_bufãr
 *
eb
)

178 
	`lockd•_as£¹_h–d_wr™e
(&
eb
->
lock
);

179 
	}
}

181 
šlše
 
	$bŒfs_as£¹_Œ“_wr™e_locked
(
ex‹Á_bufãr
 *
eb
è{ 
	}
}

184 
bŒfs_uÆock_up_§ã
(
bŒfs_·th
 *
·th
, 
Ëv–
);

186 
šlše
 
	$bŒfs_Œ“_uÆock_rw
(
ex‹Á_bufãr
 *
eb
, 
rw
)

188 ià(
rw
 =ğ
BTRFS_WRITE_LOCK
)

189 
	`bŒfs_Œ“_uÆock
(
eb
);

190 ià(
rw
 =ğ
BTRFS_READ_LOCK
)

191 
	`bŒfs_Œ“_»ad_uÆock
(
eb
);

193 
	`BUG
();

194 
	}
}

196 
	sbŒfs_d»w_lock
 {

197 
©omic_t
 
	m»ad”s
;

198 
©omic_t
 
	mwr™”s
;

199 
wa™_queue_h—d_t
 
	m³ndšg_wr™”s
;

200 
wa™_queue_h—d_t
 
	m³ndšg_»ad”s
;

203 
bŒfs_d»w_lock_š™
(
bŒfs_d»w_lock
 *
lock
);

204 
bŒfs_d»w_wr™e_lock
(
bŒfs_d»w_lock
 *
lock
);

205 
boŞ
 
bŒfs_d»w_Œy_wr™e_lock
(
bŒfs_d»w_lock
 *
lock
);

206 
bŒfs_d»w_wr™e_uÆock
(
bŒfs_d»w_lock
 *
lock
);

207 
bŒfs_d»w_»ad_lock
(
bŒfs_d»w_lock
 *
lock
);

208 
bŒfs_d»w_»ad_uÆock
(
bŒfs_d»w_lock
 *
lock
);

210 #ifdeà
CONFIG_DEBUG_LOCK_ALLOC


211 
bŒfs_£t_bufãr_lockd•_şass
(
u64
 
objeùid
, 
ex‹Á_bufãr
 *
eb
, 
Ëv–
);

212 
bŒfs_maybe_»£t_lockd•_şass
(
bŒfs_roÙ
 *
roÙ
, 
ex‹Á_bufãr
 *
eb
);

214 
šlše
 
	$bŒfs_£t_bufãr_lockd•_şass
(
u64
 
objeùid
,

215 
ex‹Á_bufãr
 *
eb
, 
Ëv–
)

217 
	}
}

218 
šlše
 
	$bŒfs_maybe_»£t_lockd•_şass
(
bŒfs_roÙ
 *
roÙ
,

219 
ex‹Á_bufãr
 *
eb
)

221 
	}
}

	@lru_cache.c

3 
	~<lšux/mm.h
>

4 
	~"Ìu_ÿche.h
"

5 
	~"mes§ges.h
"

15 
	$bŒfs_Ìu_ÿche_š™
(
bŒfs_Ìu_ÿche
 *
ÿche
, 
max_size
)

17 
	`INIT_LIST_HEAD
(&
ÿche
->
Ìu_li¡
);

18 
	`mt_š™
(&
ÿche
->
’Œ›s
);

19 
ÿche
->
size
 = 0;

20 
ÿche
->
max_size
 = max_size;

21 
	}
}

23 
bŒfs_Ìu_ÿche_’Œy
 *
	$m©ch_’Œy
(
li¡_h—d
 *
h—d
, 
u64
 
key
,

24 
u64
 
g’
)

26 
bŒfs_Ìu_ÿche_’Œy
 *
’Œy
;

28 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, 
h—d
, 
li¡
) {

29 ià(
’Œy
->
key
 =ğkey &&ƒÁry->
g’
 == gen)

30  
’Œy
;

33  
NULL
;

34 
	}
}

45 
bŒfs_Ìu_ÿche_’Œy
 *
	$bŒfs_Ìu_ÿche_lookup
(
bŒfs_Ìu_ÿche
 *
ÿche
,

46 
u64
 
key
, u64 
g’
)

48 
li¡_h—d
 *
h—d
;

49 
bŒfs_Ìu_ÿche_’Œy
 *
’Œy
;

51 
h—d
 = 
	`mŒ“_lßd
(&
ÿche
->
’Œ›s
, 
key
);

52 ià(!
h—d
)

53  
NULL
;

55 
’Œy
 = 
	`m©ch_’Œy
(
h—d
, 
key
, 
g’
);

56 ià(
’Œy
)

57 
	`li¡_move_
(&
’Œy
->
Ìu_li¡
, &
ÿche
->lru_list);

59  
’Œy
;

60 
	}
}

70 
	$bŒfs_Ìu_ÿche_»move
(
bŒfs_Ìu_ÿche
 *
ÿche
,

71 
bŒfs_Ìu_ÿche_’Œy
 *
’Œy
)

73 
li¡_h—d
 *
´ev
 = 
’Œy
->
li¡
.prev;

75 
	`ASSERT
(
ÿche
->
size
 > 0);

76 
	`ASSERT
(!
	`mŒ“_em±y
(&
ÿche
->
’Œ›s
));

78 
	`li¡_d–
(&
’Œy
->
li¡
);

79 
	`li¡_d–
(&
’Œy
->
Ìu_li¡
);

81 ià(
	`li¡_em±y
(
´ev
)) {

82 
li¡_h—d
 *
h—d
;

89 
h—d
 = 
	`mŒ“_”a£
(&
ÿche
->
’Œ›s
, 
’Œy
->
key
);

90 
	`ASSERT
(
h—d
 =ğ
´ev
);

91 
	`kä“
(
h—d
);

94 
	`kä“
(
’Œy
);

95 
ÿche
->
size
--;

96 
	}
}

106 
	$bŒfs_Ìu_ÿche_¡Üe
(
bŒfs_Ìu_ÿche
 *
ÿche
,

107 
bŒfs_Ìu_ÿche_’Œy
 *
Ãw_’Œy
,

108 
gå_t
 
gå
)

110 cÚ¡ 
u64
 
key
 = 
Ãw_’Œy
->key;

111 
li¡_h—d
 *
h—d
;

112 
»t
;

114 
h—d
 = 
	`km®loc
((*h—d), 
gå
);

115 ià(!
h—d
)

116  -
ENOMEM
;

118 
»t
 = 
	`mŒ“_š£¹
(&
ÿche
->
’Œ›s
, 
key
, 
h—d
, 
gå
);

119 ià(
»t
 == 0) {

120 
	`INIT_LIST_HEAD
(
h—d
);

121 
	`li¡_add_
(&
Ãw_’Œy
->
li¡
, 
h—d
);

122 } ià(
»t
 =ğ-
EEXIST
) {

123 
	`kä“
(
h—d
);

124 
h—d
 = 
	`mŒ“_lßd
(&
ÿche
->
’Œ›s
, 
key
);

125 
	`ASSERT
(
h—d
 !ğ
NULL
);

126 ià(
	`m©ch_’Œy
(
h—d
, 
key
, 
Ãw_’Œy
->
g’
è!ğ
NULL
)

127  -
EEXIST
;

128 
	`li¡_add_
(&
Ãw_’Œy
->
li¡
, 
h—d
);

129 } ià(
»t
 < 0) {

130 
	`kä“
(
h—d
);

131  
»t
;

134 ià(
ÿche
->
max_size
 > 0 && cache->
size
 == cache->max_size) {

135 
bŒfs_Ìu_ÿche_’Œy
 *
Ìu_’Œy
;

137 
Ìu_’Œy
 = 
	`li¡_fœ¡_’Œy
(&
ÿche
->
Ìu_li¡
,

138 
bŒfs_Ìu_ÿche_’Œy
,

139 
Ìu_li¡
);

140 
	`bŒfs_Ìu_ÿche_»move
(
ÿche
, 
Ìu_’Œy
);

143 
	`li¡_add_
(&
Ãw_’Œy
->
Ìu_li¡
, &
ÿche
->lru_list);

144 
ÿche
->
size
++;

147 
	}
}

156 
	$bŒfs_Ìu_ÿche_ş—r
(
bŒfs_Ìu_ÿche
 *
ÿche
)

158 
bŒfs_Ìu_ÿche_’Œy
 *
’Œy
;

159 
bŒfs_Ìu_ÿche_’Œy
 *
tmp
;

161 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
tmp
, &
ÿche
->
Ìu_li¡
,†ru_list)

162 
	`bŒfs_Ìu_ÿche_»move
(
ÿche
, 
’Œy
);

164 
	`ASSERT
(
ÿche
->
size
 == 0);

165 
	`ASSERT
(
	`mŒ“_em±y
(&
ÿche
->
’Œ›s
));

166 
	}
}

	@lru_cache.h

3 #iâdeà
BTRFS_LRU_CACHE_H


4 
	#BTRFS_LRU_CACHE_H


	)

6 
	~<lšux/m­Ë_Œ“.h
>

7 
	~<lšux/li¡.h
>

17 
	sbŒfs_Ìu_ÿche_’Œy
 {

18 
li¡_h—d
 
	mÌu_li¡
;

19 
u64
 
	mkey
;

26 
u64
 
	mg’
;

38 
li¡_h—d
 
	mli¡
;

41 
	sbŒfs_Ìu_ÿche
 {

42 
li¡_h—d
 
	mÌu_li¡
;

43 
m­Ë_Œ“
 
	m’Œ›s
;

45 
	msize
;

47 
	mmax_size
;

50 
	#bŒfs_Ìu_ÿche_fÜ_—ch_’Œy_§ã
(
ÿche
, 
’Œy
, 
tmp
) \

51 
	`li¡_fÜ_—ch_’Œy_§ã_»v”£
((
’Œy
), (
tmp
), &(
ÿche
)->
Ìu_li¡
,†ru_li¡)

	)

53 
šlše
 
	$bŒfs_Ìu_ÿche_size
(cÚ¡ 
bŒfs_Ìu_ÿche
 *
ÿche
)

55  
ÿche
->
size
;

56 
	}
}

58 
šlše
 
bŒfs_Ìu_ÿche_’Œy
 *
	$bŒfs_Ìu_ÿche_Ìu_’Œy
(

59 
bŒfs_Ìu_ÿche
 *
ÿche
)

61  
	`li¡_fœ¡_’Œy_Ü_nuÎ
(&
ÿche
->
Ìu_li¡
,

62 
bŒfs_Ìu_ÿche_’Œy
, 
Ìu_li¡
);

63 
	}
}

65 
bŒfs_Ìu_ÿche_š™
(
bŒfs_Ìu_ÿche
 *
ÿche
, 
max_size
);

66 
bŒfs_Ìu_ÿche_’Œy
 *
bŒfs_Ìu_ÿche_lookup
(
bŒfs_Ìu_ÿche
 *
ÿche
,

67 
u64
 
key
, u64 
g’
);

68 
bŒfs_Ìu_ÿche_¡Üe
(
bŒfs_Ìu_ÿche
 *
ÿche
,

69 
bŒfs_Ìu_ÿche_’Œy
 *
Ãw_’Œy
,

70 
gå_t
 
gå
);

71 
bŒfs_Ìu_ÿche_»move
(
bŒfs_Ìu_ÿche
 *
ÿche
,

72 
bŒfs_Ìu_ÿche_’Œy
 *
’Œy
);

73 
bŒfs_Ìu_ÿche_ş—r
(
bŒfs_Ìu_ÿche
 *
ÿche
);

	@lzo.c

6 
	~<lšux/k”Ãl.h
>

7 
	~<lšux/¦ab.h
>

8 
	~<lšux/mm.h
>

9 
	~<lšux/š™.h
>

10 
	~<lšux/”r.h
>

11 
	~<lšux/sched.h
>

12 
	~<lšux/·gem­.h
>

13 
	~<lšux/bio.h
>

14 
	~<lšux/lzo.h
>

15 
	~<lšux/»fcouÁ.h
>

16 
	~"mes§ges.h
"

17 
	~"com´essiÚ.h
"

18 
	~"ù»e.h
"

19 
	~"su³r.h
"

20 
	~"bŒfs_šode.h
"

22 
	#LZO_LEN
 4

	)

61 
	#WORKSPACE_BUF_LENGTH
 (
	`lzo1x_wÜ¡_com´ess
(
PAGE_SIZE
))

	)

62 
	#WORKSPACE_CBUF_LENGTH
 (
	`lzo1x_wÜ¡_com´ess
(
PAGE_SIZE
))

	)

64 
	swÜk¥aû
 {

65 *
	mmem
;

66 *
	mbuf
;

67 *
	mcbuf
;

68 
li¡_h—d
 
	mli¡
;

71 
wÜk¥aû_mªag”
 
	gwsm
;

73 
	$lzo_ä“_wÜk¥aû
(
li¡_h—d
 *
ws
)

75 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

77 
	`kvä“
(
wÜk¥aû
->
buf
);

78 
	`kvä“
(
wÜk¥aû
->
cbuf
);

79 
	`kvä“
(
wÜk¥aû
->
mem
);

80 
	`kä“
(
wÜk¥aû
);

81 
	}
}

83 
li¡_h—d
 *
	$lzo_®loc_wÜk¥aû
(
Ëv–
)

85 
wÜk¥aû
 *workspace;

87 
wÜk¥aû
 = 
	`kz®loc
((*wÜk¥aû), 
GFP_KERNEL
);

88 ià(!
wÜk¥aû
)

89  
	`ERR_PTR
(-
ENOMEM
);

91 
wÜk¥aû
->
mem
 = 
	`kvm®loc
(
LZO1X_MEM_COMPRESS
, 
GFP_KERNEL
 | 
__GFP_NOWARN
);

92 
wÜk¥aû
->
buf
 = 
	`kvm®loc
(
WORKSPACE_BUF_LENGTH
, 
GFP_KERNEL
 | 
__GFP_NOWARN
);

93 
wÜk¥aû
->
cbuf
 = 
	`kvm®loc
(
WORKSPACE_CBUF_LENGTH
, 
GFP_KERNEL
 | 
__GFP_NOWARN
);

94 ià(!
wÜk¥aû
->
mem
 || !wÜk¥aû->
buf
 || !wÜk¥aû->
cbuf
)

95 
ç
;

97 
	`INIT_LIST_HEAD
(&
wÜk¥aû
->
li¡
);

99  &
wÜk¥aû
->
li¡
;

100 
ç
:

101 
	`lzo_ä“_wÜk¥aû
(&
wÜk¥aû
->
li¡
);

102  
	`ERR_PTR
(-
ENOMEM
);

103 
	}
}

105 
šlše
 
	$wr™e_com´ess_Ëngth
(*
buf
, 
size_t
 
Ën
)

107 
__Ë32
 
dËn
;

109 
dËn
 = 
	`ıu_to_Ë32
(
Ën
);

110 
	`memıy
(
buf
, &
dËn
, 
LZO_LEN
);

111 
	}
}

113 
šlše
 
size_t
 
	$»ad_com´ess_Ëngth
(cÚ¡ *
buf
)

115 
__Ë32
 
dËn
;

117 
	`memıy
(&
dËn
, 
buf
, 
LZO_LEN
);

118  
	`Ë32_to_ıu
(
dËn
);

119 
	}
}

131 
	$cİy_com´es£d_d©a_to_·ge
(*
com´es£d_d©a
,

132 
size_t
 
com´es£d_size
,

133 
·ge
 **
out_·ges
,

134 
max_Ä_·ge
,

135 
u32
 *
cur_out
,

136 cÚ¡ 
u32
 
£ùÜsize
)

138 
u32
 
£ùÜ_by‹s_Ëá
;

139 
u32
 
Üig_out
;

140 
·ge
 *
cur_·ge
;

141 *
kaddr
;

143 ià((*
cur_out
 / 
PAGE_SIZE
è>ğ
max_Ä_·ge
)

144  -
E2BIG
;

150 
	`ASSERT
((*
cur_out
 / 
£ùÜsize
è=ğ(*cur_ouˆ+ 
LZO_LEN
 - 1) / sectorsize);

152 
cur_·ge
 = 
out_·ges
[*
cur_out
 / 
PAGE_SIZE
];

154 ià(!
cur_·ge
) {

155 
cur_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
);

156 ià(!
cur_·ge
)

157  -
ENOMEM
;

158 
out_·ges
[*
cur_out
 / 
PAGE_SIZE
] = 
cur_·ge
;

161 
kaddr
 = 
	`km­_loÿl_·ge
(
cur_·ge
);

162 
	`wr™e_com´ess_Ëngth
(
kaddr
 + 
	`off£t_š_·ge
(*
cur_out
),

163 
com´es£d_size
);

164 *
cur_out
 +ğ
LZO_LEN
;

166 
Üig_out
 = *
cur_out
;

169 *
cur_out
 - 
Üig_out
 < 
com´es£d_size
) {

170 
u32
 
cİy_Ën
 = 
	`mš_t
(u32, 
£ùÜsize
 - *
cur_out
 % sectorsize,

171 
Üig_out
 + 
com´es£d_size
 - *
cur_out
);

173 
	`kunm­_loÿl
(
kaddr
);

175 ià((*
cur_out
 / 
PAGE_SIZE
è>ğ
max_Ä_·ge
)

176  -
E2BIG
;

178 
cur_·ge
 = 
out_·ges
[*
cur_out
 / 
PAGE_SIZE
];

180 ià(!
cur_·ge
) {

181 
cur_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
);

182 ià(!
cur_·ge
)

183  -
ENOMEM
;

184 
out_·ges
[*
cur_out
 / 
PAGE_SIZE
] = 
cur_·ge
;

186 
kaddr
 = 
	`km­_loÿl_·ge
(
cur_·ge
);

188 
	`memıy
(
kaddr
 + 
	`off£t_š_·ge
(*
cur_out
),

189 
com´es£d_d©a
 + *
cur_out
 - 
Üig_out
, 
cİy_Ën
);

191 *
cur_out
 +ğ
cİy_Ën
;

198 
£ùÜ_by‹s_Ëá
 = 
	`round_up
(*
cur_out
, 
£ùÜsize
) - *cur_out;

199 ià(
£ùÜ_by‹s_Ëá
 >ğ
LZO_LEN
 || sector_bytes_left == 0)

200 
out
;

203 
	`mem£t
(
kaddr
 + 
	`off£t_š_·ge
(*
cur_out
), 0,

204 
£ùÜ_by‹s_Ëá
);

205 *
cur_out
 +ğ
£ùÜ_by‹s_Ëá
;

207 
out
:

208 
	`kunm­_loÿl
(
kaddr
);

210 
	}
}

212 
	$lzo_com´ess_·ges
(
li¡_h—d
 *
ws
, 
add»ss_¥aû
 *
m­pšg
,

213 
u64
 
¡¬t
, 
·ge
 **
·ges
, *
out_·ges
,

214 *
tÙ®_š
, *
tÙ®_out
)

216 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

217 cÚ¡ 
u32
 
£ùÜsize
 = 
	`bŒfs_sb
(
m­pšg
->
ho¡
->
i_sb
)->sectorsize;

218 
·ge
 *
·ge_š
 = 
NULL
;

219 *
sizes_±r
;

220 cÚ¡ 
max_Ä_·ge
 = *
out_·ges
;

221 
»t
 = 0;

223 
u64
 
cur_š
 = 
¡¬t
;

225 
u32
 
cur_out
 = 0;

226 
u32
 
Ën
 = *
tÙ®_out
;

228 
	`ASSERT
(
max_Ä_·ge
 > 0);

229 *
out_·ges
 = 0;

230 *
tÙ®_out
 = 0;

231 *
tÙ®_š
 = 0;

237 
cur_out
 +ğ
LZO_LEN
;

238 
cur_š
 < 
¡¬t
 + 
Ën
) {

239 *
d©a_š
;

240 cÚ¡ 
u32
 
£ùÜsize_mask
 = 
£ùÜsize
 - 1;

241 
u32
 
£ùÜ_off
 = (
cur_š
 - 
¡¬t
è& 
£ùÜsize_mask
;

242 
u32
 
š_Ën
;

243 
size_t
 
out_Ën
;

246 ià(!
·ge_š
) {

247 
·ge_š
 = 
	`fšd_g‘_·ge
(
m­pšg
, 
cur_š
 >> 
PAGE_SHIFT
);

248 
	`ASSERT
(
·ge_š
);

252 
š_Ën
 = 
	`mš_t
(
u32
, 
¡¬t
 + 
Ën
 - 
cur_š
, 
£ùÜsize
 - 
£ùÜ_off
);

253 
	`ASSERT
(
š_Ën
);

254 
d©a_š
 = 
	`km­_loÿl_·ge
(
·ge_š
);

255 
»t
 = 
	`lzo1x_1_com´ess
(
d©a_š
 +

256 
	`off£t_š_·ge
(
cur_š
), 
š_Ën
,

257 
wÜk¥aû
->
cbuf
, &
out_Ën
,

258 
wÜk¥aû
->
mem
);

259 
	`kunm­_loÿl
(
d©a_š
);

260 ià(
»t
 < 0) {

261 
	`´_debug
("BTRFS:†zØš†oİ„‘uºed %d\n", 
»t
);

262 
»t
 = -
EIO
;

263 
out
;

266 
»t
 = 
	`cİy_com´es£d_d©a_to_·ge
(
wÜk¥aû
->
cbuf
, 
out_Ën
,

267 
·ges
, 
max_Ä_·ge
,

268 &
cur_out
, 
£ùÜsize
);

269 ià(
»t
 < 0)

270 
out
;

272 
cur_š
 +ğ
š_Ën
;

278 ià(
cur_š
 - 
¡¬t
 > 
£ùÜsize
 * 2 && cur_š - s¹ < 
cur_out
) {

279 
»t
 = -
E2BIG
;

280 
out
;

284 ià(
	`PAGE_ALIGNED
(
cur_š
)) {

285 
	`put_·ge
(
·ge_š
);

286 
·ge_š
 = 
NULL
;

291 
sizes_±r
 = 
	`km­_loÿl_·ge
(
·ges
[0]);

292 
	`wr™e_com´ess_Ëngth
(
sizes_±r
, 
cur_out
);

293 
	`kunm­_loÿl
(
sizes_±r
);

295 
»t
 = 0;

296 *
tÙ®_out
 = 
cur_out
;

297 *
tÙ®_š
 = 
cur_š
 - 
¡¬t
;

298 
out
:

299 ià(
·ge_š
)

300 
	`put_·ge
(
·ge_š
);

301 *
out_·ges
 = 
	`DIV_ROUND_UP
(
cur_out
, 
PAGE_SIZE
);

302  
»t
;

303 
	}
}

310 
	$cİy_com´es£d_£gm’t
(
com´es£d_bio
 *
cb
,

311 *
de¡
, 
u32
 
Ën
, u32 *
cur_š
)

313 
u32
 
Üig_š
 = *
cur_š
;

315 *
cur_š
 < 
Üig_š
 + 
Ën
) {

316 
·ge
 *
cur_·ge
;

317 
u32
 
cİy_Ën
 = 
	`mš_t
(u32, 
PAGE_SIZE
 - 
	`off£t_š_·ge
(*
cur_š
),

318 
Üig_š
 + 
Ën
 - *
cur_š
);

320 
	`ASSERT
(
cİy_Ën
);

321 
cur_·ge
 = 
cb
->
com´es£d_·ges
[*
cur_š
 / 
PAGE_SIZE
];

323 
	`memıy_äom_·ge
(
de¡
 + *
cur_š
 - 
Üig_š
, 
cur_·ge
,

324 
	`off£t_š_·ge
(*
cur_š
), 
cİy_Ën
);

326 *
cur_š
 +ğ
cİy_Ën
;

328 
	}
}

330 
	$lzo_decom´ess_bio
(
li¡_h—d
 *
ws
, 
com´es£d_bio
 *
cb
)

332 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

333 cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
 = 
cb
->
bbio
.
šode
->
roÙ
->fs_info;

334 cÚ¡ 
u32
 
£ùÜsize
 = 
fs_šfo
->sectorsize;

335 *
kaddr
;

336 
»t
;

338 
u32
 
Ën_š
;

340 
u32
 
cur_š
 = 0;

342 
u32
 
cur_out
 = 0;

344 
kaddr
 = 
	`km­_loÿl_·ge
(
cb
->
com´es£d_·ges
[0]);

345 
Ën_š
 = 
	`»ad_com´ess_Ëngth
(
kaddr
);

346 
	`kunm­_loÿl
(
kaddr
);

347 
cur_š
 +ğ
LZO_LEN
;

356 ià(
Ën_š
 > 
	`mš_t
(
size_t
, 
BTRFS_MAX_COMPRESSED
, 
cb
->
com´es£d_Ën
) ||

357 
	`round_up
(
Ën_š
, 
£ùÜsize
è< 
cb
->
com´es£d_Ën
) {

358 
	`bŒfs_”r
(
fs_šfo
,

360 
Ën_š
, 
cb
->
com´es£d_Ën
);

361  -
EUCLEAN
;

365 
cur_š
 < 
Ën_š
) {

366 
·ge
 *
cur_·ge
;

368 
u32
 
£g_Ën
;

369 
u32
 
£ùÜ_by‹s_Ëá
;

370 
size_t
 
out_Ën
 = 
	`lzo1x_wÜ¡_com´ess
(
£ùÜsize
);

376 
	`ASSERT
(
cur_š
 / 
£ùÜsize
 ==

377 (
cur_š
 + 
LZO_LEN
 - 1è/ 
£ùÜsize
);

378 
cur_·ge
 = 
cb
->
com´es£d_·ges
[
cur_š
 / 
PAGE_SIZE
];

379 
	`ASSERT
(
cur_·ge
);

380 
kaddr
 = 
	`km­_loÿl_·ge
(
cur_·ge
);

381 
£g_Ën
 = 
	`»ad_com´ess_Ëngth
(
kaddr
 + 
	`off£t_š_·ge
(
cur_š
));

382 
	`kunm­_loÿl
(
kaddr
);

383 
cur_š
 +ğ
LZO_LEN
;

385 ià(
£g_Ën
 > 
WORKSPACE_CBUF_LENGTH
) {

390 
	`bŒfs_”r
(
fs_šfo
, "unexpectedly†arge†zo segment†en %u",

391 
£g_Ën
);

392  -
EIO
;

396 
	`cİy_com´es£d_£gm’t
(
cb
, 
wÜk¥aû
->
cbuf
, 
£g_Ën
, &
cur_š
);

399 
»t
 = 
	`lzo1x_decom´ess_§ã
(
wÜk¥aû
->
cbuf
, 
£g_Ën
,

400 
wÜk¥aû
->
buf
, &
out_Ën
);

401 ià(
»t
 !ğ
LZO_E_OK
) {

402 
	`bŒfs_”r
(
fs_šfo
, "failedo decompress");

403  -
EIO
;

407 
»t
 = 
	`bŒfs_decom´ess_buf2·ge
(
wÜk¥aû
->
buf
, 
out_Ën
, 
cb
, 
cur_out
);

408 
cur_out
 +ğ
out_Ën
;

411 ià(
»t
 == 0)

413 
»t
 = 0;

416 
£ùÜ_by‹s_Ëá
 = 
£ùÜsize
 - (
cur_š
 % sectorsize);

417 ià(
£ùÜ_by‹s_Ëá
 >ğ
LZO_LEN
)

421 
cur_š
 +ğ
£ùÜ_by‹s_Ëá
;

425 
	}
}

427 
	$lzo_decom´ess
(
li¡_h—d
 *
ws
, cÚ¡ 
u8
 *
d©a_š
,

428 
·ge
 *
de¡_·ge
, 
¡¬t_by‹
, 
size_t
 
¤ş’
,

429 
size_t
 
de¡Ën
)

431 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

432 
size_t
 
š_Ën
;

433 
size_t
 
out_Ën
;

434 
size_t
 
max_£gm’t_Ën
 = 
WORKSPACE_BUF_LENGTH
;

435 
»t
 = 0;

436 *
kaddr
;

437 
by‹s
;

439 ià(
¤ş’
 < 
LZO_LEN
 || srş’ > 
max_£gm’t_Ën
 + LZO_LEN * 2)

440  -
EUCLEAN
;

442 
š_Ën
 = 
	`»ad_com´ess_Ëngth
(
d©a_š
);

443 ià(
š_Ën
 !ğ
¤ş’
)

444  -
EUCLEAN
;

445 
d©a_š
 +ğ
LZO_LEN
;

447 
š_Ën
 = 
	`»ad_com´ess_Ëngth
(
d©a_š
);

448 ià(
š_Ën
 !ğ
¤ş’
 - 
LZO_LEN
 * 2) {

449 
»t
 = -
EUCLEAN
;

450 
out
;

452 
d©a_š
 +ğ
LZO_LEN
;

454 
out_Ën
 = 
PAGE_SIZE
;

455 
»t
 = 
	`lzo1x_decom´ess_§ã
(
d©a_š
, 
š_Ën
, 
wÜk¥aû
->
buf
, &
out_Ën
);

456 ià(
»t
 !ğ
LZO_E_OK
) {

457 
	`´_w¬n
("BTRFS: decompress failed!\n");

458 
»t
 = -
EIO
;

459 
out
;

462 ià(
out_Ën
 < 
¡¬t_by‹
) {

463 
»t
 = -
EIO
;

464 
out
;

471 
de¡Ën
 = 
	`mš_t
(, de¡Ën, 
PAGE_SIZE
);

472 
by‹s
 = 
	`mš_t
(, 
de¡Ën
, 
out_Ën
 - 
¡¬t_by‹
);

474 
kaddr
 = 
	`km­_loÿl_·ge
(
de¡_·ge
);

475 
	`memıy
(
kaddr
, 
wÜk¥aû
->
buf
 + 
¡¬t_by‹
, 
by‹s
);

482 ià(
by‹s
 < 
de¡Ën
)

483 
	`mem£t
(
kaddr
+
by‹s
, 0, 
de¡Ën
-bytes);

484 
	`kunm­_loÿl
(
kaddr
);

485 
out
:

486  
»t
;

487 
	}
}

489 cÚ¡ 
bŒfs_com´ess_İ
 
	gbŒfs_lzo_com´ess
 = {

490 .
wÜk¥aû_mªag”
 = &
wsm
,

491 .
	gmax_Ëv–
 = 1,

492 .
	gdeçuÉ_Ëv–
 = 1,

	@messages.c

3 
	~"fs.h
"

4 
	~"mes§ges.h
"

5 
	~"disÿrd.h
"

6 
	~"Œª§ùiÚ.h
"

7 
	~"¥aû-šfo.h
"

8 
	~"su³r.h
"

10 #ifdeà
CONFIG_PRINTK


12 
	#STATE_STRING_PREFACE
 ": s‹ "

	)

13 
	#STATE_STRING_BUF_LEN
 ((
STATE_STRING_PREFACE
è+ 
BTRFS_FS_STATE_COUNT
 + 1)

	)

19 cÚ¡ 
	gfs_¡©e_ch¬s
[] = {

20 [
BTRFS_FS_STATE_REMOUNTING
] = 'M',

21 [
BTRFS_FS_STATE_RO
] = 0,

22 [
BTRFS_FS_STATE_TRANS_ABORTED
] = 'A',

23 [
BTRFS_FS_STATE_DEV_REPLACING
] = 'R',

24 [
BTRFS_FS_STATE_DUMMY_FS_INFO
] = 0,

25 [
BTRFS_FS_STATE_NO_CSUMS
] = 'C',

26 [
BTRFS_FS_STATE_LOG_CLEANUP_ERROR
] = 'L',

29 
	$bŒfs_¡©e_to_¡ršg
(cÚ¡ 
bŒfs_fs_šfo
 *
šfo
, *
buf
)

31 
b™
;

32 
boŞ
 
¡©es_´š‹d
 = 
çl£
;

33 
fs_¡©e
 = 
	`READ_ONCE
(
šfo
->fs_state);

34 *
cu¼
 = 
buf
;

36 
	`memıy
(
cu¼
, 
STATE_STRING_PREFACE
, (STATE_STRING_PREFACE));

37 
cu¼
 +ğ(
STATE_STRING_PREFACE
) - 1;

39 ià(
	`BTRFS_FS_ERROR
(
šfo
)) {

40 *
cu¼
++ = 'E';

41 
¡©es_´š‹d
 = 
Œue
;

44 
	`fÜ_—ch_£t_b™
(
b™
, &
fs_¡©e
, (fs_state)) {

45 
	`WARN_ON_ONCE
(
b™
 >ğ
BTRFS_FS_STATE_COUNT
);

46 ià((
b™
 < 
BTRFS_FS_STATE_COUNT
è&& 
fs_¡©e_ch¬s
[bit]) {

47 *
cu¼
++ = 
fs_¡©e_ch¬s
[
b™
];

48 
¡©es_´š‹d
 = 
Œue
;

53 ià(!
¡©es_´š‹d
)

54 
cu¼
 = 
buf
;

56 *
cu¼
++ = 0;

57 
	}
}

75 cÚ¡ * 
__©Œibu‹_cÚ¡__
 
	$bŒfs_decode_”rÜ
(
”ºo
)

77 *
”r¡r
 = "unknown";

79 
”ºo
) {

80 -
ENOENT
:

81 
”r¡r
 = "No suchƒntry";

83 -
EIO
:

84 
”r¡r
 = "IO failure";

86 -
ENOMEM
:

87 
”r¡r
 = "Out of memory";

89 -
EEXIST
:

90 
”r¡r
 = "Object‡lreadyƒxists";

92 -
ENOSPC
:

93 
”r¡r
 = "No space†eft";

95 -
EROFS
:

96 
”r¡r
 = "Readonly filesystem";

98 -
EOPNOTSUPP
:

99 
”r¡r
 = "Operation‚ot supported";

101 -
EUCLEAN
:

102 
”r¡r
 = "Filesystem corrupted";

104 -
EDQUOT
:

105 
”r¡r
 = "Quotaƒxceeded";

109  
”r¡r
;

110 
	}
}

116 
__cŞd


117 
	$__bŒfs_hªdË_fs_”rÜ
(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
funùiÚ
,

118 
lše
, 
”ºo
, cÚ¡ *
fmt
, ...)

120 
su³r_block
 *
sb
 = 
fs_šfo
->sb;

121 #ifdeà
CONFIG_PRINTK


122 
¡©e¡r
[
STATE_STRING_BUF_LEN
];

123 cÚ¡ *
”r¡r
;

126 #ifdeà
CONFIG_PRINTK_INDEX


127 
	`´štk_šdex_subsys_em™
(

128 "BTRFS:ƒ¼Ü (deviû %s%sèš %s:%d:ƒ¼no=%d %s", 
KERN_CRIT
, 
fmt
);

135 ià(
”ºo
 =ğ-
EROFS
 && 
	`sb_rdÚly
(
sb
))

138 #ifdeà
CONFIG_PRINTK


139 
”r¡r
 = 
	`bŒfs_decode_”rÜ
(
”ºo
);

140 
	`bŒfs_¡©e_to_¡ršg
(
fs_šfo
, 
¡©e¡r
);

141 ià(
fmt
) {

142 
va_fÜm©
 
vaf
;

143 
va_li¡
 
¬gs
;

145 
	`va_¡¬t
(
¬gs
, 
fmt
);

146 
vaf
.
fmt
 = fmt;

147 
vaf
.
va
 = &
¬gs
;

149 
	`´_ü™
("BTRFS:ƒrror (device %s%s) in %s:%d:ƒrrno=%d %s (%pV)\n",

150 
sb
->
s_id
, 
¡©e¡r
, 
funùiÚ
, 
lše
, 
”ºo
, 
”r¡r
, &
vaf
);

151 
	`va_’d
(
¬gs
);

153 
	`´_ü™
("BTRFS:ƒrror (device %s%s) in %s:%d:ƒrrno=%d %s\n",

154 
sb
->
s_id
, 
¡©e¡r
, 
funùiÚ
, 
lše
, 
”ºo
, 
”r¡r
);

162 
	`WRITE_ONCE
(
fs_šfo
->
fs_”rÜ
, 
”ºo
);

165 ià(!(
sb
->
s_æags
 & 
SB_BORN
))

168 ià(
	`sb_rdÚly
(
sb
))

171 
	`bŒfs_disÿrd_¡İ
(
fs_šfo
);

174 
	`bŒfs_£t_sb_rdÚly
(
sb
);

175 
	`bŒfs_šfo
(
fs_šfo
, "forced„eadonly");

184 
	}
}

186 #ifdeà
CONFIG_PRINTK


187 cÚ¡ * cÚ¡ 
	glogty³s
[] = {

202 
¿‹lim™_¡©e
 
	g´štk_lim™s
[] = {

203 
RATELIMIT_STATE_INIT
(
´štk_lim™s
[0], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

204 
RATELIMIT_STATE_INIT
(
´štk_lim™s
[1], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

205 
RATELIMIT_STATE_INIT
(
´štk_lim™s
[2], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

206 
RATELIMIT_STATE_INIT
(
´štk_lim™s
[3], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

207 
RATELIMIT_STATE_INIT
(
´štk_lim™s
[4], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

208 
RATELIMIT_STATE_INIT
(
´štk_lim™s
[5], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

209 
RATELIMIT_STATE_INIT
(
´štk_lim™s
[6], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

210 
RATELIMIT_STATE_INIT
(
´štk_lim™s
[7], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

213 
__cŞd
 
	$_bŒfs_´štk
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
fmt
, ...)

215 
lvl
[
PRINTK_MAX_SINGLE_HEADER_LEN
 + 1] = "\0";

216 
va_fÜm©
 
vaf
;

217 
va_li¡
 
¬gs
;

218 
k”n_Ëv–
;

219 cÚ¡ *
ty³
 = 
logty³s
[4];

220 
¿‹lim™_¡©e
 *
¿‹lim™
 = &
´štk_lim™s
[4];

222 #ifdeà
CONFIG_PRINTK_INDEX


223 
	`´štk_šdex_subsys_em™
("%sBTRFS % (deviû %s): ", 
NULL
, 
fmt
);

226 
	`va_¡¬t
(
¬gs
, 
fmt
);

228 (
k”n_Ëv–
 = 
	`´štk_g‘_Ëv–
(
fmt
)) != 0) {

229 
size_t
 
size
 = 
	`´štk_sk_Ëv–
(
fmt
) - fmt;

231 ià(
k”n_Ëv–
 >= '0' && kern_level <= '7') {

232 
	`memıy
(
lvl
, 
fmt
, 
size
);

233 
lvl
[
size
] = '\0';

234 
ty³
 = 
logty³s
[
k”n_Ëv–
 - '0'];

235 
¿‹lim™
 = &
´štk_lim™s
[
k”n_Ëv–
 - '0'];

237 
fmt
 +ğ
size
;

240 
vaf
.
fmt
 = fmt;

241 
vaf
.
va
 = &
¬gs
;

243 ià(
	`__¿‹lim™
(
¿‹lim™
)) {

244 ià(
fs_šfo
) {

245 
¡©e¡r
[
STATE_STRING_BUF_LEN
];

247 
	`bŒfs_¡©e_to_¡ršg
(
fs_šfo
, 
¡©e¡r
);

248 
	`_´štk
("%sBTRFS % (deviû %s%s): %pV\n", 
lvl
, 
ty³
,

249 
fs_šfo
->
sb
->
s_id
, 
¡©e¡r
, &
vaf
);

251 
	`_´štk
("%sBTRFS %s: %pV\n", 
lvl
, 
ty³
, &
vaf
);

255 
	`va_’d
(
¬gs
);

256 
	}
}

259 #ià
BITS_PER_LONG
 == 32

260 
__cŞd
 
	$bŒfs_w¬n_32b™_lim™
(
bŒfs_fs_šfo
 *
fs_šfo
)

262 ià(!
	`‹¡_ªd_£t_b™
(
BTRFS_FS_32BIT_WARN
, &
fs_šfo
->
æags
)) {

263 
	`bŒfs_w¬n
(
fs_šfo
, "reaching 32bit†imit for†ogical‡ddresses");

264 
	`bŒfs_w¬n
(
fs_šfo
,

266 
BTRFS_32BIT_MAX_FILE_SIZE
 >> 40);

267 
	`bŒfs_w¬n
(
fs_šfo
,

270 
	}
}

272 
__cŞd
 
	$bŒfs_”r_32b™_lim™
(
bŒfs_fs_šfo
 *
fs_šfo
)

274 ià(!
	`‹¡_ªd_£t_b™
(
BTRFS_FS_32BIT_ERROR
, &
fs_šfo
->
æags
)) {

275 
	`bŒfs_”r
(
fs_šfo
, "reached 32bit†imit for†ogical‡ddresses");

276 
	`bŒfs_”r
(
fs_šfo
,

278 
BTRFS_32BIT_MAX_FILE_SIZE
 >> 40);

279 
	`bŒfs_”r
(
fs_šfo
,

282 
	}
}

289 
__cŞd


290 
	$__bŒfs_·nic
(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
funùiÚ
,

291 
lše
, 
”ºo
, cÚ¡ *
fmt
, ...)

293 *
s_id
 = "<unknown>";

294 cÚ¡ *
”r¡r
;

295 
va_fÜm©
 
vaf
 = { .
fmt
 = fmt };

296 
va_li¡
 
¬gs
;

298 ià(
fs_šfo
)

299 
s_id
 = 
fs_šfo
->
sb
->s_id;

301 
	`va_¡¬t
(
¬gs
, 
fmt
);

302 
vaf
.
va
 = &
¬gs
;

304 
”r¡r
 = 
	`bŒfs_decode_”rÜ
(
”ºo
);

305 ià(
fs_šfo
 && (
	`bŒfs_‹¡_İt
(fs_šfo, 
PANIC_ON_FATAL_ERROR
)))

306 
	`·nic
(
KERN_CRIT
 "BTRFS…anic (device %s) in %s:%d: %pV (errno=%d %s)\n",

307 
s_id
, 
funùiÚ
, 
lše
, &
vaf
, 
”ºo
, 
”r¡r
);

309 
	`bŒfs_ü™
(
fs_šfo
, "panic in %s:%d: %pV (errno=%d %s)",

310 
funùiÚ
, 
lše
, &
vaf
, 
”ºo
, 
”r¡r
);

311 
	`va_’d
(
¬gs
);

313 
	}
}

	@messages.h

3 #iâdeà
BTRFS_MESSAGES_H


4 
	#BTRFS_MESSAGES_H


	)

6 
	~<lšux/ty³s.h
>

7 
	~<lšux/´štk.h
>

8 
	~<lšux/bug.h
>

10 
	gbŒfs_fs_šfo
;

15 #ifdeà
__KERNEL__


17 
šlše
 
	$__´štf
(2, 3è
__cŞd


18 
	$bŒfs_no_´štk
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
fmt
, ...)

20 
	}
}

24 #ifdeà
CONFIG_PRINTK


26 
	#bŒfs_´štk
(
fs_šfo
, 
fmt
, 
¬gs
...) \

27 
	`_bŒfs_´štk
(
fs_šfo
, 
fmt
, ##
¬gs
)

	)

29 
	$__´štf
(2, 3)

30 
__cŞd


31 
	`_bŒfs_´štk
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
fmt
, ...);

35 
	#bŒfs_´štk
(
fs_šfo
, 
fmt
, 
¬gs
...) \

36 
	`bŒfs_no_´štk
(
fs_šfo
, 
fmt
, ##
¬gs
)

	)

39 
	#bŒfs_em”g
(
fs_šfo
, 
fmt
, 
¬gs
...) \

40 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_EMERG
 
fmt
, ##
¬gs
)

	)

41 
	#bŒfs_®”t
(
fs_šfo
, 
fmt
, 
¬gs
...) \

42 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_ALERT
 
fmt
, ##
¬gs
)

	)

43 
	#bŒfs_ü™
(
fs_šfo
, 
fmt
, 
¬gs
...) \

44 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_CRIT
 
fmt
, ##
¬gs
)

	)

45 
	#bŒfs_”r
(
fs_šfo
, 
fmt
, 
¬gs
...) \

46 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_ERR
 
fmt
, ##
¬gs
)

	)

47 
	#bŒfs_w¬n
(
fs_šfo
, 
fmt
, 
¬gs
...) \

48 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_WARNING
 
fmt
, ##
¬gs
)

	)

49 
	#bŒfs_nÙiû
(
fs_šfo
, 
fmt
, 
¬gs
...) \

50 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_NOTICE
 
fmt
, ##
¬gs
)

	)

51 
	#bŒfs_šfo
(
fs_šfo
, 
fmt
, 
¬gs
...) \

52 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_INFO
 
fmt
, ##
¬gs
)

	)

57 
	#bŒfs_em”g_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

58 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_EMERG
 
fmt
, ##
¬gs
)

	)

59 
	#bŒfs_®”t_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

60 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_ALERT
 
fmt
, ##
¬gs
)

	)

61 
	#bŒfs_ü™_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

62 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_CRIT
 
fmt
, ##
¬gs
)

	)

63 
	#bŒfs_”r_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

64 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_ERR
 
fmt
, ##
¬gs
)

	)

65 
	#bŒfs_w¬n_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

66 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_WARNING
 
fmt
, ##
¬gs
)

	)

67 
	#bŒfs_nÙiû_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

68 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_NOTICE
 
fmt
, ##
¬gs
)

	)

69 
	#bŒfs_šfo_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

70 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_INFO
 
fmt
, ##
¬gs
)

	)

75 
	#bŒfs_em”g_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

76 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_EMERG
 
fmt
, ##
¬gs
)

	)

77 
	#bŒfs_®”t_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

78 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_ALERT
 
fmt
, ##
¬gs
)

	)

79 
	#bŒfs_ü™_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

80 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_CRIT
 
fmt
, ##
¬gs
)

	)

81 
	#bŒfs_”r_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

82 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_ERR
 
fmt
, ##
¬gs
)

	)

83 
	#bŒfs_w¬n_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

84 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_WARNING
 
fmt
, ##
¬gs
)

	)

85 
	#bŒfs_nÙiû_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

86 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_NOTICE
 
fmt
, ##
¬gs
)

	)

87 
	#bŒfs_šfo_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

88 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_INFO
 
fmt
, ##
¬gs
)

	)

93 
	#bŒfs_em”g_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

94 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_EMERG
 
fmt
, ##
¬gs
)

	)

95 
	#bŒfs_®”t_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

96 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_ALERT
 
fmt
, ##
¬gs
)

	)

97 
	#bŒfs_ü™_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

98 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_CRIT
 
fmt
, ##
¬gs
)

	)

99 
	#bŒfs_”r_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

100 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_ERR
 
fmt
, ##
¬gs
)

	)

101 
	#bŒfs_w¬n_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

102 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_WARNING
 
fmt
, ##
¬gs
)

	)

103 
	#bŒfs_nÙiû_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

104 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_NOTICE
 
fmt
, ##
¬gs
)

	)

105 
	#bŒfs_šfo_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

106 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_INFO
 
fmt
, ##
¬gs
)

	)

108 #ià
	`defšed
(
CONFIG_DYNAMIC_DEBUG
)

109 
	#bŒfs_debug
(
fs_šfo
, 
fmt
, 
¬gs
...) \

110 
	`_dyÇmic_func_ÿÎ_no_desc
(
fmt
, 
bŒfs_´štk
, \

111 
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

112 
	#bŒfs_debug_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

113 
	`_dyÇmic_func_ÿÎ_no_desc
(
fmt
, 
bŒfs_´štk_š_rcu
, \

114 
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

115 
	#bŒfs_debug_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

116 
	`_dyÇmic_func_ÿÎ_no_desc
(
fmt
, 
bŒfs_´štk_¾_š_rcu
, \

117 
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

118 
	#bŒfs_debug_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

119 
	`_dyÇmic_func_ÿÎ_no_desc
(
fmt
, 
bŒfs_´štk_¿‹lim™ed
, \

120 
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

121 #–ià
	`defšed
(
DEBUG
)

122 
	#bŒfs_debug
(
fs_šfo
, 
fmt
, 
¬gs
...) \

123 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

124 
	#bŒfs_debug_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

125 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

126 
	#bŒfs_debug_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

127 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

128 
	#bŒfs_debug_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

129 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

131 
	#bŒfs_debug
(
fs_šfo
, 
fmt
, 
¬gs
...) \

132 
	`bŒfs_no_´štk
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

133 
	#bŒfs_debug_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

134 
	`bŒfs_no_´štk_š_rcu
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

135 
	#bŒfs_debug_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

136 
	`bŒfs_no_´štk_š_rcu
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

137 
	#bŒfs_debug_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

138 
	`bŒfs_no_´štk
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

141 
	#bŒfs_´štk_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

143 
	`rcu_»ad_lock
(); \

144 
	`bŒfs_´štk
(
fs_šfo
, 
fmt
, ##
¬gs
); \

145 
	`rcu_»ad_uÆock
(); \

146 
	}
} 0)

	)

148 
	#bŒfs_no_´štk_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

150 
	`rcu_»ad_lock
(); \

151 
	`bŒfs_no_´štk
(
fs_šfo
, 
fmt
, ##
¬gs
); \

152 
	`rcu_»ad_uÆock
(); \

153 } 0)

	)

155 
	#bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
fmt
, 
¬gs
...) \

157 
	`DEFINE_RATELIMIT_STATE
(
_rs
, \

158 
DEFAULT_RATELIMIT_INTERVAL
, \

159 
DEFAULT_RATELIMIT_BURST
); \

160 ià(
	`__¿‹lim™
(&
_rs
)) \

161 
	`bŒfs_´štk
(
fs_šfo
, 
fmt
, ##
¬gs
); \

162 } 0)

	)

164 
	#bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

166 
	`rcu_»ad_lock
(); \

167 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
fmt
, ##
¬gs
); \

168 
	`rcu_»ad_uÆock
(); \

169 } 0)

	)

171 #ifdeà
CONFIG_BTRFS_ASSERT


173 
	#bŒfs_as£¹ç
(
ex´
, 
fe
, 
lše
) ({ \

174 
	`´_”r
("as£¹iÚ faed: %s, iÀ%s:%d\n", (
ex´
), (
fe
), (
lše
)); \

175 
	`BUG
(); \

176 })

	)

178 
	#ASSERT
(
ex´
) \

179 (
	`lik–y
(
ex´
è? ()0 : 
	`bŒfs_as£¹ç
(#ex´, 
__FILE__
, 
__LINE__
))

	)

181 
	#ASSERT
(
ex´
è()Óx´)

	)

184 
	$__´štf
(5, 6)

185 
__cŞd


186 
	`__bŒfs_hªdË_fs_”rÜ
(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
funùiÚ
,

187 
lše
, 
”ºo
, cÚ¡ *
fmt
, ...);

189 cÚ¡ * 
__©Œibu‹_cÚ¡__
 
	`bŒfs_decode_”rÜ
(
”ºo
);

191 
	#bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
”ºo
, 
fmt
, 
¬gs
...) \

192 
	`__bŒfs_hªdË_fs_”rÜ
((
fs_šfo
), 
__func__
, 
__LINE__
, \

193 (
”ºo
), 
fmt
, ##
¬gs
)

	)

195 
	$__´štf
(5, 6)

196 
__cŞd


197 
	`__bŒfs_·nic
(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
funùiÚ
,

198 
lše
, 
”ºo
, cÚ¡ *
fmt
, ...);

203 
	#bŒfs_·nic
(
fs_šfo
, 
”ºo
, 
fmt
, 
¬gs
...) \

205 
	`__bŒfs_·nic
(
fs_šfo
, 
__func__
, 
__LINE__
, 
”ºo
, 
fmt
, ##
¬gs
); \

206 
	`BUG
(); \

207 
	}
} 0)

	)

209 #ià
BITS_PER_LONG
 == 32

210 
	#BTRFS_32BIT_MAX_FILE_SIZE
 (((
u64
)
ULONG_MAX
 + 1è<< 
PAGE_SHIFT
)

	)

217 
	#BTRFS_32BIT_EARLY_WARN_THRESHOLD
 (
BTRFS_32BIT_MAX_FILE_SIZE
 * 5 / 8)

	)

218 
bŒfs_w¬n_32b™_lim™
(
bŒfs_fs_šfo
 *
fs_šfo
);

219 
bŒfs_”r_32b™_lim™
(
bŒfs_fs_šfo
 *
fs_šfo
);

	@misc.h

3 #iâdeà
BTRFS_MISC_H


4 
	#BTRFS_MISC_H


	)

6 
	~<lšux/sched.h
>

7 
	~<lšux/wa™.h
>

8 
	~<lšux/m©h64.h
>

9 
	~<lšux/rbŒ“.h
>

14 
	#ENUM_BIT
(
Çme
) \

15 
__
 ## 
Çme
 ## 
_BIT
, \

16 
Çme
 = (1U << 
__
 ##‚am## 
_BIT
), \

17 
__
 ## 
Çme
 ## 
_SEQ
 = __ ##‚am## 
_BIT


	)

19 
šlše
 
	$cÚd_wake_up
(
wa™_queue_h—d
 *
wq
)

25 ià(
	`wq_has_¦“³r
(
wq
))

26 
	`wake_up
(
wq
);

27 
	}
}

29 
šlše
 
	$cÚd_wake_up_nomb
(
wa™_queue_h—d
 *
wq
)

37 ià(
	`wa™queue_aùive
(
wq
))

38 
	`wake_up
(
wq
);

39 
	}
}

41 
šlše
 
u64
 
	$muÉ_³rc
(
u64
 
num
, 
u32
 
³rûÁ
)

43  
	`div_u64
(
num
 * 
³rûÁ
, 100);

44 
	}
}

46 
šlše
 
boŞ
 
	$is_pow”_of_two_u64
(
u64
 
n
)

48  
n
 != 0 && (n & (n - 1)) == 0;

49 
	}
}

51 
šlše
 
boŞ
 
	$has_sšgË_b™_£t
(
u64
 
n
)

53  
	`is_pow”_of_two_u64
(
n
);

54 
	}
}

62 
	srb_sim¶e_node
 {

63 
rb_node
 
	mrb_node
;

64 
u64
 
	mby‹Ä
;

67 
šlše
 
rb_node
 *
	$rb_sim¶e_£¬ch
(
rb_roÙ
 *
roÙ
, 
u64
 
by‹Ä
)

69 
rb_node
 *
node
 = 
roÙ
->rb_node;

70 
rb_sim¶e_node
 *
’Œy
;

72 
node
) {

73 
’Œy
 = 
	`rb_’Œy
(
node
, 
rb_sim¶e_node
, 
rb_node
);

75 ià(
by‹Ä
 < 
’Œy
->bytenr)

76 
node
 =‚ode->
rb_Ëá
;

77 ià(
by‹Ä
 > 
’Œy
->bytenr)

78 
node
 =‚ode->
rb_right
;

80  
node
;

82  
NULL
;

83 
	}
}

94 
šlše
 
rb_node
 *
	$rb_sim¶e_£¬ch_fœ¡
(
rb_roÙ
 *
roÙ
,

95 
u64
 
by‹Ä
)

97 
rb_node
 *
node
 = 
roÙ
->rb_node, *
»t
 = 
NULL
;

98 
rb_sim¶e_node
 *
’Œy
, *
»t_’Œy
 = 
NULL
;

100 
node
) {

101 
’Œy
 = 
	`rb_’Œy
(
node
, 
rb_sim¶e_node
, 
rb_node
);

103 ià(
by‹Ä
 < 
’Œy
->bytenr) {

104 ià(!
»t
 || 
’Œy
->
by‹Ä
 < 
»t_’Œy
->bytenr) {

105 
»t
 = 
node
;

106 
»t_’Œy
 = 
’Œy
;

109 
node
 =‚ode->
rb_Ëá
;

110 } ià(
by‹Ä
 > 
’Œy
->bytenr) {

111 
node
 =‚ode->
rb_right
;

113  
node
;

117  
»t
;

118 
	}
}

120 
šlše
 
rb_node
 *
	$rb_sim¶e_š£¹
(
rb_roÙ
 *
roÙ
, 
u64
 
by‹Ä
,

121 
rb_node
 *
node
)

123 
rb_node
 **
p
 = &
roÙ
->rb_node;

124 
rb_node
 *
·»Á
 = 
NULL
;

125 
rb_sim¶e_node
 *
’Œy
;

127 *
p
) {

128 
·»Á
 = *
p
;

129 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
rb_sim¶e_node
, 
rb_node
);

131 ià(
by‹Ä
 < 
’Œy
->bytenr)

132 
p
 = &(*p)->
rb_Ëá
;

133 ià(
by‹Ä
 > 
’Œy
->bytenr)

134 
p
 = &(*p)->
rb_right
;

136  
·»Á
;

139 
	`rb_lšk_node
(
node
, 
·»Á
, 
p
);

140 
	`rb_š£¹_cŞÜ
(
node
, 
roÙ
);

141  
NULL
;

142 
	}
}

144 
šlše
 
boŞ
 
	$b™m­_‹¡_¿nge_®l_£t
(cÚ¡ *
addr
,

145 
¡¬t
,

146 
nb™s
)

148 
found_z”o
;

150 
found_z”o
 = 
	`fšd_Ãxt_z”o_b™
(
addr
, 
¡¬t
 + 
nb™s
, start);

151  (
found_z”o
 =ğ
¡¬t
 + 
nb™s
);

152 
	}
}

154 
šlše
 
boŞ
 
	$b™m­_‹¡_¿nge_®l_z”o
(cÚ¡ *
addr
,

155 
¡¬t
,

156 
nb™s
)

158 
found_£t
;

160 
found_£t
 = 
	`fšd_Ãxt_b™
(
addr
, 
¡¬t
 + 
nb™s
, start);

161  (
found_£t
 =ğ
¡¬t
 + 
nb™s
);

162 
	}
}

	@mm/filemap.c

1 
	~<lšux/expÜt.h
>

2 
	~<lšux/comp”.h
>

3 
	~<lšux/dax.h
>

4 
	~<lšux/fs.h
>

5 
	~<lšux/sched/sigÇl.h
>

6 
	~<lšux/uacûss.h
>

7 
	~<lšux/ÿ·b™y.h
>

8 
	~<lšux/k”Ãl_¡©.h
>

9 
	~<lšux/gå.h
>

10 
	~<lšux/mm.h
>

11 
	~<lšux/sw­.h
>

12 
	~<lšux/sw­İs.h
>

13 
	~<lšux/sysÿÎs.h
>

14 
	~<lšux/mmª.h
>

15 
	~<lšux/·gem­.h
>

16 
	~<lšux/fe.h
>

17 
	~<lšux/uio.h
>

18 
	~<lšux/”rÜ-šjeùiÚ.h
>

19 
	~<lšux/hash.h
>

20 
	~<lšux/wr™eback.h
>

21 
	~<lšux/backšg-dev.h
>

22 
	~<lšux/·gevec.h
>

23 
	~<lšux/£cur™y.h
>

24 
	~<lšux/ıu£t.h
>

25 
	~<lšux/hug‘lb.h
>

26 
	~<lšux/memcÚŒŞ.h
>

27 
	~<lšux/shmem_fs.h
>

28 
	~<lšux/rm­.h
>

29 
	~<lšux/d–ayacù.h
>

30 
	~<lšux/psi.h
>

31 
	~<lšux/¿mfs.h
>

32 
	~<lšux/·ge_idË.h
>

33 
	~<lšux/mig¿‹.h
>

34 
	~<lšux/pe_fs_i.h
>

35 
	~<lšux/¥liû.h
>

36 
	~<asm/pg®loc.h
>

37 
	~<asm/bæush.h
>

38 
	~"../fs.h
"

39 
	~"../su³r.h
"

40 
	~"š‹º®.h
"

41 
	#CREATE_TRACE_POINTS


	)

42 
	~<Œaû/ev’ts/fem­.h
>

44 
	~<lšux/bufãr_h—d.h
>

46 
	~<asm/mmª.h
>

77 
šlše


78 
	$bŒfs_·ge_ÿche_sync_»adah—d
(
add»ss_¥aû
 *
m­pšg
,

79 
fe_¿_¡©e
 *
¿
, 
fe
 *fe, 
pgoff_t
 
šdex
,

80 
»q_couÁ
)

82 
	`DEFINE_READAHEAD
(
¿ùl
, 
fe
, 
¿
, 
m­pšg
, 
šdex
);

83 
	`·ge_ÿche_sync_¿
(&
¿ùl
, 
»q_couÁ
);

84 
šode
 *
ho¡
 = 
m­pšg
->host;

85 
su³r_block
 *
sb
 = 
ho¡
->
i_sb
;

88 
	}
}

91 
boŞ
 
	$pos_§me_fŞio
(
loff_t
 
pos1
,†off_ˆ
pos2
, 
fŞio
 *folio)

93 
shiá
 = 
	`fŞio_shiá
(
fŞio
);

95  (
pos1
 >> 
shiá
 =ğ
pos2
 >> shift);

96 
	}
}

101 
	$fem­_»adah—d
(
kiocb
 *
iocb
, 
fe
 *file,

102 
add»ss_¥aû
 *
m­pšg
, 
fŞio
 *folio,

103 
pgoff_t
 
Ï¡_šdex
)

105 
	`DEFINE_READAHEAD
(
¿ùl
, 
fe
, &fe->
f_¿
, 
m­pšg
, 
fŞio
->
šdex
);

107 ià(
iocb
->
ki_æags
 & 
IOCB_NOIO
)

108  -
EAGAIN
;

109 
	`·ge_ÿche_async_¿
(&
¿ùl
, 
fŞio
, 
Ï¡_šdex
 - fŞio->
šdex
);

111 
	}
}

113 
	$bŒfs_fem­_g‘_·ges
(
kiocb
 *
iocb
, 
size_t
 
couÁ
,

114 
fŞio_b©ch
 *
fb©ch
, 
boŞ
 
Ãed_u±od©e
)

116 
fe
 *
fp
 = 
iocb
->
ki_fp
;

117 
add»ss_¥aû
 *
m­pšg
 = 
fp
->
f_m­pšg
;

119 
šode
 *
f_šode
;

120 
f_šode
 = 
	`fe_šode
(
iocb
->
ki_fp
);

126 ià(
f_šode
->
has_»mÙe
 == 0) {

127 
m­pšg
 = 
f_šode
->
i_m­pšg
;

134 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
f_šode
->
i_sb
);

139 
fe_¿_¡©e
 *
¿
 = &
fp
->
f_¿
;

140 
pgoff_t
 
šdex
 = 
iocb
->
ki_pos
 >> 
PAGE_SHIFT
;

141 
pgoff_t
 
Ï¡_šdex
;

142 
fŞio
 *folio;

143 
”r
 = 0;

145 
Ï¡_šdex
 = 
	`DIV_ROUND_UP
(
iocb
->
ki_pos
 + 
couÁ
, 
PAGE_SIZE
);

146 
»Œy
:

147 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

148  -
EINTR
;

150 
	`fem­_g‘_»ad_b©ch
(
m­pšg
, 
šdex
, 
Ï¡_šdex
 - 1, 
fb©ch
);

152 ià(!
	`fŞio_b©ch_couÁ
(
fb©ch
)) {

153 ià(
iocb
->
ki_æags
 & 
IOCB_NOIO
)

154  -
EAGAIN
;

155 
	`bŒfs_·ge_ÿche_sync_»adah—d
(
m­pšg
, 
¿
, 
fp
, 
šdex
, 
Ï¡_šdex
 - index);

157 
	`fem­_g‘_»ad_b©ch
(
m­pšg
, 
šdex
, 
Ï¡_šdex
 - 1, 
fb©ch
);

159 ià(!
	`fŞio_b©ch_couÁ
(
fb©ch
)) {

160 ià(
iocb
->
ki_æags
 & (
IOCB_NOWAIT
 | 
IOCB_WAITQ
))

161  -
EAGAIN
;

162 
”r
 = 
	`fem­_ü—‹_fŞio
(
fp
, 
m­pšg
,

163 
iocb
->
ki_pos
 >> 
PAGE_SHIFT
, 
fb©ch
);

164 ià(
”r
 =ğ
AOP_TRUNCATED_PAGE
)

165 
»Œy
;

166  
”r
;

169 
fŞio
 = 
fb©ch
->
fŞios
[
	`fŞio_b©ch_couÁ
(fbatch) - 1];

171 ià(
	`fŞio_‹¡_»adah—d
(
fŞio
)) {

173 
”r
 = 
	`fem­_»adah—d
(
iocb
, 
fp
, 
m­pšg
, 
fŞio
, 
Ï¡_šdex
);

175 ià(
”r
)

176 
”r
;

178 ià(!
	`fŞio_‹¡_u±od©e
(
fŞio
)) {

179 ià((
iocb
->
ki_æags
 & 
IOCB_WAITQ
è&& 
	`fŞio_b©ch_couÁ
(
fb©ch
) > 1)

180 
iocb
->
ki_æags
 |ğ
IOCB_NOWAIT
;

182 
”r
 = 
	`fem­_upd©e_·ge
(
iocb
, 
m­pšg
, 
couÁ
, 
fŞio
,

183 
Ãed_u±od©e
);

184 ià(
”r
)

185 
”r
;

188 
”r
:

189 ià(
”r
 < 0)

190 
	`fŞio_put
(
fŞio
);

191 ià(
	`lik–y
(--
fb©ch
->
Ä
))

193 ià(
”r
 =ğ
AOP_TRUNCATED_PAGE
)

194 
»Œy
;

195  
”r
;

196 
	}
}

199 
ssize_t
 
	$bŒfs_fem­_»ad
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
,

200 
ssize_t
 
®»ady_»ad
)

202 
fe
 *
fp
 = 
iocb
->
ki_fp
;

203 
fe_¿_¡©e
 *
¿
 = &
fp
->
f_¿
;

204 
add»ss_¥aû
 *
m­pšg
 = 
fp
->
f_m­pšg
;

205 
šode
 *šodğ
m­pšg
->
ho¡
;

208 
fŞio_b©ch
 
fb©ch
;

209 
i
, 
”rÜ
 = 0;

210 
boŞ
 
wr™ably_m­³d
;

211 
loff_t
 
isize
, 
’d_off£t
;

212 
loff_t
 
Ï¡_pos
 = 
¿
->
´ev_pos
;

214 ià(
	`uÆik–y
(
iocb
->
ki_pos
 >ğ
šode
->
i_sb
->
s_maxby‹s
))

216 ià(
	`uÆik–y
(!
	`iov_™”_couÁ
(
™”
)))

221 
	`iov_™”_Œunÿ‹
(
™”
, 
šode
->
i_sb
->
s_maxby‹s
);

222 
	`fŞio_b©ch_š™
(&
fb©ch
);

225 
	`cÚd_»sched
();

232 ià((
iocb
->
ki_æags
 & 
IOCB_WAITQ
è&& 
®»ady_»ad
)

233 
iocb
->
ki_æags
 |ğ
IOCB_NOWAIT
;

235 ià(
	`uÆik–y
(
iocb
->
ki_pos
 >ğ
	`i_size_»ad
(
šode
)))

238 
”rÜ
 = 
	`bŒfs_fem­_g‘_·ges
(
iocb
, 
™”
->
couÁ
, &
fb©ch
, 
çl£
);

239 ià(
”rÜ
 < 0)

250 
isize
 = 
	`i_size_»ad
(
šode
);

251 ià(
	`uÆik–y
(
iocb
->
ki_pos
 >ğ
isize
))

252 
put_fŞios
;

253 
’d_off£t
 = 
	`mš_t
(
loff_t
, 
isize
, 
iocb
->
ki_pos
 + 
™”
->
couÁ
);

259 
wr™ably_m­³d
 = 
	`m­pšg_wr™ably_m­³d
(
m­pšg
);

265 ià(!
	`pos_§me_fŞio
(
iocb
->
ki_pos
, 
Ï¡_pos
 - 1,

266 
fb©ch
.
fŞios
[0]))

267 
	`fŞio_m¬k_acûs£d
(
fb©ch
.
fŞios
[0]);

269 
i
 = 0; i < 
	`fŞio_b©ch_couÁ
(&
fb©ch
); i++) {

270 
fŞio
 *fŞiØğ
fb©ch
.
fŞios
[
i
];

271 
size_t
 
fsize
 = 
	`fŞio_size
(
fŞio
);

272 
size_t
 
off£t
 = 
iocb
->
ki_pos
 & (
fsize
 - 1);

273 
size_t
 
by‹s
 = 
	`mš_t
(
loff_t
, 
’d_off£t
 - 
iocb
->
ki_pos
,

274 
fsize
 - 
off£t
);

275 
size_t
 
cİ›d
;

277 ià(
’d_off£t
 < 
	`fŞio_pos
(
fŞio
))

279 ià(
i
 > 0)

280 
	`fŞio_m¬k_acûs£d
(
fŞio
);

286 ià(
wr™ably_m­³d
)

287 
	`æush_dÿche_fŞio
(
fŞio
);

289 
cİ›d
 = 
	`cİy_fŞio_to_™”
(
fŞio
, 
off£t
, 
by‹s
, 
™”
);

290 
®»ady_»ad
 +ğ
cİ›d
;

291 
iocb
->
ki_pos
 +ğ
cİ›d
;

292 
Ï¡_pos
 = 
iocb
->
ki_pos
;

294 ià(
cİ›d
 < 
by‹s
) {

295 
”rÜ
 = -
EFAULT
;

299 
put_fŞios
:

300 
i
 = 0; i < 
	`fŞio_b©ch_couÁ
(&
fb©ch
); i++)

301 
	`fŞio_put
(
fb©ch
.
fŞios
[
i
]);

302 
	`fŞio_b©ch_š™
(&
fb©ch
);

303 } 
	`iov_™”_couÁ
(
™”
è&& 
iocb
->
ki_pos
 < 
isize
 && !
”rÜ
);

305 
	`fe_acûs£d
(
fp
);

306 
¿
->
´ev_pos
 = 
Ï¡_pos
;

307  
®»ady_»ad
 ?‡Ì—dy_»ad : 
”rÜ
;

308 
	}
}

	@mm/filemap.h

1 #iâdeà
__FILEMAP_H


2 
	#__FILEMAP_H


	)

4 
bŒfs_fem­_g‘_·ges
(
kiocb
 *
iocb
, 
size_t
 
couÁ
, 
fŞio_b©ch
 *
fb©ch
, 
boŞ
 
Ãed_u±od©e
);

5 
ssize_t
 
bŒfs_fem­_»ad
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
, ssize_ˆ
®»ady_»ad
);

	@mm/internal.h

7 #iâdeà
__MM_INTERNAL_H


8 
	#__MM_INTERNAL_H


	)

10 
	~<lšux/fs.h
>

11 
	~<lšux/mm.h
>

12 
	~<lšux/·gem­.h
>

13 
	~<lšux/rm­.h
>

14 
	~<lšux/Œaûpošt-defs.h
>

16 
	gfŞio_b©ch
;

24 
	#GFP_RECLAIM_MASK
 (
__GFP_RECLAIM
|
__GFP_HIGH
|
__GFP_IO
|
__GFP_FS
|\

25 
__GFP_NOWARN
|
__GFP_RETRY_MAYFAIL
|
__GFP_NOFAIL
|\

26 
__GFP_NORETRY
|
__GFP_MEMALLOC
|
__GFP_NOMEMALLOC
|\

27 
__GFP_NOLOCKDEP
)

	)

30 
	#GFP_BOOT_MASK
 (
__GFP_BITS_MASK
 & ~(
__GFP_RECLAIM
|
__GFP_IO
|
__GFP_FS
))

	)

33 
	#GFP_CONSTRAINT_MASK
 (
__GFP_HARDWALL
|
__GFP_THISNODE
)

	)

36 
	#GFP_SLAB_BUG_MASK
 (
__GFP_DMA32
|
__GFP_HIGHMEM
|~
__GFP_BITS_MASK
)

	)

42 
	#WARN_ON_ONCE_GFP
(
cÚd
, 
gå
) ({ \

43 
boŞ
 
	`__£ùiÚ
(".d©a.Úû"è
__w¬Ãd
; \

44 
__»t_w¬n_Úû
 = !!(
cÚd
); \

46 ià(
	`uÆik–y
(!(
gå
 & 
__GFP_NOWARN
è&& 
__»t_w¬n_Úû
 && !
__w¬Ãd
)) { \

47 
__w¬Ãd
 = 
Œue
; \

48 
	`WARN_ON
(1); \

50 
	`uÆik–y
(
__»t_w¬n_Úû
); \

51 })

	)

53 
·ge_wr™eback_š™
();

61 
	#COMPOUND_MAPPED
 0x800000

	)

62 
	#FOLIO_PAGES_MAPPED
 (
COMPOUND_MAPPED
 - 1)

	)

68 
	#SHOW_MEM_FILTER_NODES
 (0x0001uè

	)

74 
šlše
 
	$fŞio_Ä_·ges_m­³d
(
fŞio
 *folio)

76  
	`©omic_»ad
(&
fŞio
->
_Ä_·ges_m­³d
è& 
FOLIO_PAGES_MAPPED
;

77 
	}
}

79 
šlše
 *
	$fŞio_¿w_m­pšg
(
fŞio
 *folio)

81 
m­pšg
 = ()
fŞio
->mapping;

83  (*)(
m­pšg
 & ~
PAGE_MAPPING_FLAGS
);

84 
	}
}

86 
__acù_»şaim_wr™eback
(
pg_d©a_t
 *
pgd©
, 
fŞio
 *folio,

87 
Ä_thrÙed
);

88 
šlše
 
	$acù_»şaim_wr™eback
(
fŞio
 *folio)

90 
pg_d©a_t
 *
pgd©
 = 
	`fŞio_pgd©
(
fŞio
);

91 
Ä_thrÙed
 = 
	`©omic_»ad
(&
pgd©
->
Ä_wr™eback_thrÙed
);

93 ià(
Ä_thrÙed
)

94 
	`__acù_»şaim_wr™eback
(
pgd©
, 
fŞio
, 
Ä_thrÙed
);

95 
	}
}

97 
šlše
 
	$wake_thrÙe_isŞ©ed
(
pg_d©a_t
 *
pgd©
)

99 
wa™_queue_h—d_t
 *
wqh
;

101 
wqh
 = &
pgd©
->
»şaim_wa™
[
VMSCAN_THROTTLE_ISOLATED
];

102 ià(
	`wa™queue_aùive
(
wqh
))

103 
	`wake_up
(
wqh
);

104 
	}
}

106 
vm_çuÉ_t
 
do_sw­_·ge
(
vm_çuÉ
 *
vmf
);

107 
fŞio_rÙ©e_»şaimabË
(
fŞio
 *folio);

108 
boŞ
 
__fŞio_’d_wr™eback
(
fŞio
 *folio);

109 
d—ùiv©e_fe_fŞio
(
fŞio
 *folio);

110 
fŞio_aùiv©e
(
fŞio
 *folio);

112 
ä“_pgbËs
(
mmu_g©h”
 *
b
, 
ma_¡©e
 *
mas
,

113 
vm_¬—_¡ruù
 *
¡¬t_vma
, 
æoÜ
,

114 
ûšg
, 
boŞ
 
mm_wr_locked
);

115 
pmd_š¡®l
(
mm_¡ruù
 *
mm
, 
pmd_t
 *
pmd
, 
pgbË_t
 *
±e
);

117 
	gz­_d‘as
;

118 
unm­_·ge_¿nge
(
mmu_g©h”
 *
b
,

119 
vm_¬—_¡ruù
 *
vma
,

120 
addr
, 
’d
,

121 
z­_d‘as
 *
d‘as
);

123 
·ge_ÿche_¿_Üd”
(
»adah—d_cÚŒŞ
 *, 
fe_¿_¡©e
 *,

124 
Üd”
);

125 
fÜû_·ge_ÿche_¿
(
»adah—d_cÚŒŞ
 *, 
Ä
);

126 
šlše
 
	$fÜû_·ge_ÿche_»adah—d
(
add»ss_¥aû
 *
m­pšg
,

127 
fe
 *fe, 
pgoff_t
 
šdex
, 
Ä_to_»ad
)

129 
	`DEFINE_READAHEAD
(
¿ùl
, 
fe
, &fe->
f_¿
, 
m­pšg
, 
šdex
);

130 
	`fÜû_·ge_ÿche_¿
(&
¿ùl
, 
Ä_to_»ad
);

131 
	}
}

133 
fšd_lock_’Œ›s
(
add»ss_¥aû
 *
m­pšg
, 
pgoff_t
 *
¡¬t
,

134 
pgoff_t
 
’d
, 
fŞio_b©ch
 *
fb©ch
,…goff_ˆ*
šdiûs
);

135 
fšd_g‘_’Œ›s
(
add»ss_¥aû
 *
m­pšg
, 
pgoff_t
 *
¡¬t
,

136 
pgoff_t
 
’d
, 
fŞio_b©ch
 *
fb©ch
,…goff_ˆ*
šdiûs
);

137 
fem­_ä“_fŞio
(
add»ss_¥aû
 *
m­pšg
, 
fŞio
 *folio);

138 
fem­_g‘_»ad_b©ch
(
add»ss_¥aû
 *
m­pšg
, 
pgoff_t
 
šdex
,…goff_ˆ
max
, 
fŞio_b©ch
 *
fb©ch
);

139 
fem­_ü—‹_fŞio
(
fe
 *fe, 
add»ss_¥aû
 *
m­pšg
, 
pgoff_t
 
šdex
, 
fŞio_b©ch
 *
fb©ch
);

140 
fem­_upd©e_·ge
(
kiocb
 *
iocb
, 
add»ss_¥aû
 *
m­pšg
, 
size_t
 
couÁ
, 
fŞio
 *fŞio, 
boŞ
 
Ãed_u±od©e
);

142 
Œunÿ‹_šode_fŞio
(
add»ss_¥aû
 *
m­pšg
, 
fŞio
 *folio);

143 
boŞ
 
Œunÿ‹_šode_·¹Ÿl_fŞio
(
fŞio
 *fŞio, 
loff_t
 
¡¬t
,

144 
loff_t
 
’d
);

145 
šv®id©e_šode_·ge
(
·ge
 *page);

146 
m­pšg_Œy_šv®id©e
(
add»ss_¥aû
 *
m­pšg
,

147 
pgoff_t
 
¡¬t
,…goff_ˆ
’d
, *
Ä_çed
);

160 
šlše
 
boŞ
 
	$fŞio_eviùabË
(
fŞio
 *folio)

162 
boŞ
 
»t
;

165 
	`rcu_»ad_lock
();

166 
»t
 = !
	`m­pšg_uÃviùabË
(
	`fŞio_m­pšg
(
fŞio
)) &&

167 !
	`fŞio_‹¡_mlocked
(
fŞio
);

168 
	`rcu_»ad_uÆock
();

169  
»t
;

170 
	}
}

176 
šlše
 
	$£t_·ge_»fcouÁed
(
·ge
 *page)

178 
	`VM_BUG_ON_PAGE
(
	`PageTa
(
·ge
),…age);

179 
	`VM_BUG_ON_PAGE
(
	`·ge_»f_couÁ
(
·ge
),…age);

180 
	`£t_·ge_couÁ
(
·ge
, 1);

181 
	}
}

186 
šlše
 
boŞ
 
	$fŞio_Ãeds_»Ëa£
(
fŞio
 *folio)

188 
add»ss_¥aû
 *
m­pšg
 = 
	`fŞio_m­pšg
(
fŞio
);

190  
	`fŞio_has_´iv©e
(
fŞio
) ||

191 (
m­pšg
 && 
	`m­pšg_»Ëa£_®ways
(mapping));

192 
	}
}

194 
highe¡_memm­_pâ
;

200 
	#MAX_RECLAIM_RETRIES
 16

	)

205 
boŞ
 
isŞ©e_Ìu_·ge
(
·ge
 *page);

206 
boŞ
 
fŞio_isŞ©e_Ìu
(
fŞio
 *folio);

207 
putback_Ìu_·ge
(
·ge
 *page);

208 
fŞio_putback_Ìu
(
fŞio
 *folio);

209 
»şaim_thrÙe
(
pg_d©a_t
 *
pgd©
, 
vmsÿn_thrÙe_¡©e
 
»asÚ
);

214 
pmd_t
 *
mm_fšd_pmd
(
mm_¡ruù
 *
mm
, 
add»ss
);

219 
	#K
(
x
è((xè<< (
PAGE_SHIFT
-10))

	)

221 * cÚ¡ 
zÚe_Çmes
[
MAX_NR_ZONES
];

224 
DECLARE_STATIC_KEY_MAYBE
(
CONFIG_DEBUG_VM
, 
check_·ges_’abËd
);

226 
mš_ä“_kby‹s
;

228 
£tup_³r_zÚe_wm¬ks
();

229 
ÿlcuÏ‹_mš_ä“_kby‹s
();

230 
__memš™
 
š™_³r_zÚe_wm¬k_mš
();

231 
·ge_®loc_sysùl_š™
();

246 
	s®loc_cÚ‹xt
 {

247 
zÚ–i¡
 *
	mzÚ–i¡
;

248 
nodemask_t
 *
	mnodemask
;

249 
zÚ”ef
 *
	m´eã¼ed_zÚ”ef
;

250 
	mmig¿‹ty³
;

262 
zÚe_ty³
 
	mhighe¡_zÚeidx
;

263 
boŞ
 
	m¥»ad_dœty_·ges
;

274 
šlše
 
	$buddy_Üd”
(
·ge
 *page)

277  
	`·ge_´iv©e
(
·ge
);

278 
	}
}

291 
	#buddy_Üd”_un§ã
(
·ge
è
	`READ_ONCE
(
	`·ge_´iv©e
Õage))

	)

306 
šlše
 
boŞ
 
	$·ge_is_buddy
(
·ge
 *·ge, ·g*
buddy
,

307 
Üd”
)

309 ià(!
	`·ge_is_gu¬d
(
buddy
è&& !
	`PageBuddy
(buddy))

310  
çl£
;

312 ià(
	`buddy_Üd”
(
buddy
è!ğ
Üd”
)

313  
çl£
;

319 ià(
	`·ge_zÚe_id
(
·ge
è!ğ·ge_zÚe_id(
buddy
))

320  
çl£
;

322 
	`VM_BUG_ON_PAGE
(
	`·ge_couÁ
(
buddy
) != 0, buddy);

324  
Œue
;

325 
	}
}

344 
šlše
 

345 
	$__fšd_buddy_pâ
(
·ge_pâ
, 
Üd”
)

347  
·ge_pâ
 ^ (1 << 
Üd”
);

348 
	}
}

364 
šlše
 
·ge
 *
	$fšd_buddy_·ge_pâ
(
·ge
 *page,

365 
pâ
, 
Üd”
, *
buddy_pâ
)

367 
__buddy_pâ
 = 
	`__fšd_buddy_pâ
(
pâ
, 
Üd”
);

368 
·ge
 *
buddy
;

370 
buddy
 = 
·ge
 + (
__buddy_pâ
 - 
pâ
);

371 ià(
buddy_pâ
)

372 *
buddy_pâ
 = 
__buddy_pâ
;

374 ià(
	`·ge_is_buddy
(
·ge
, 
buddy
, 
Üd”
))

375  
buddy
;

376  
NULL
;

377 
	}
}

379 
·ge
 *
__·geblock_pâ_to_·ge
(
¡¬t_pâ
,

380 
’d_pâ
, 
zÚe
 *zone);

382 
šlše
 
·ge
 *
	$·geblock_pâ_to_·ge
(
¡¬t_pâ
,

383 
’d_pâ
, 
zÚe
 *zone)

385 ià(
zÚe
->
cÚtiguous
)

386  
	`pâ_to_·ge
(
¡¬t_pâ
);

388  
	`__·geblock_pâ_to_·ge
(
¡¬t_pâ
, 
’d_pâ
, 
zÚe
);

389 
	}
}

391 
£t_zÚe_cÚtiguous
(
zÚe
 *zone);

393 
šlše
 
	$ş—r_zÚe_cÚtiguous
(
zÚe
 *zone)

395 
zÚe
->
cÚtiguous
 = 
çl£
;

396 
	}
}

398 
__isŞ©e_ä“_·ge
(
·ge
 *·ge, 
Üd”
);

399 
__putback_isŞ©ed_·ge
(
·ge
 *·ge, 
Üd”
,

400 
mt
);

401 
memblock_ä“_·ges
(
·ge
 *·ge, 
pâ
,

402 
Üd”
);

403 
__ä“_·ges_cÜe
(
·ge
 *·ge, 
Üd”
);

409 
šlše
 
	$fŞio_£t_Üd”
(
fŞio
 *fŞio, 
Üd”
)

411 ià(
	`WARN_ON_ONCE
(!
Üd”
 || !
	`fŞio_‹¡_Ïrge
(
fŞio
)))

414 
fŞio
->
_æags_1
 = (fŞio->_æags_1 & ~0xffULè| 
Üd”
;

415 #ifdeà
CONFIG_64BIT


416 
fŞio
->
_fŞio_Ä_·ges
 = 1U << 
Üd”
;

418 
	}
}

420 
fŞio_undo_Ïrge_rm­·bË
(
fŞio
 *folio);

422 
šlše
 
	$´•_compound_h—d
(
·ge
 *·ge, 
Üd”
)

424 
fŞio
 *fŞiØğ(fŞiØ*)
·ge
;

426 
	`fŞio_£t_Üd”
(
fŞio
, 
Üd”
);

427 
	`©omic_£t
(&
fŞio
->
_’tœe_m­couÁ
, -1);

428 
	`©omic_£t
(&
fŞio
->
_Ä_·ges_m­³d
, 0);

429 
	`©omic_£t
(&
fŞio
->
_pšcouÁ
, 0);

430 
	}
}

432 
šlše
 
	$´•_compound_
(
·ge
 *
h—d
, 
_idx
)

434 
·ge
 *
p
 = 
h—d
 + 
_idx
;

436 
p
->
m­pšg
 = 
TAIL_MAPPING
;

437 
	`£t_compound_h—d
(
p
, 
h—d
);

438 
	`£t_·ge_´iv©e
(
p
, 0);

439 
	}
}

441 
´•_compound_·ge
(
·ge
 *·ge, 
Üd”
);

443 
po¡_®loc_hook
(
·ge
 *·ge, 
Üd”
,

444 
gå_t
 
gå_æags
);

445 
u£r_mš_ä“_kby‹s
;

447 
ä“_uÄef_·ge
(
·ge
 *·ge, 
Üd”
);

448 
ä“_uÄef_·ge_li¡
(
li¡_h—d
 *
li¡
);

450 
zÚe_pı_»£t
(
zÚe
 *zone);

451 
zÚe_pı_di§bË
(
zÚe
 *zone);

452 
zÚe_pı_’abË
(
zÚe
 *zone);

453 
zÚe_pı_š™
(
zÚe
 *zone);

455 *
memm­_®loc
(
phys_addr_t
 
size
,…hys_addr_ˆ
®ign
,

456 
phys_addr_t
 
mš_addr
,

457 
nid
, 
boŞ
 
exaù_nid
);

459 
memm­_š™_¿nge
(, , , ,

460 , 
memš™_cÚ‹xt
, 
vmem_®tm­
 *, );

463 
¥l™_ä“_·ge
(
·ge
 *
ä“_·ge
,

464 
Üd”
, 
¥l™_pâ_off£t
);

466 #ià
defšed
 
CONFIG_COMPACTION
 || defšed 
CONFIG_CMA


478 
	scom·ù_cÚŒŞ
 {

479 
li¡_h—d
 
	mä“·ges
;

480 
li¡_h—d
 
	mmig¿‹·ges
;

481 
	mÄ_ä“·ges
;

482 
	mÄ_mig¿‹·ges
;

483 
	mä“_pâ
;

490 
	mmig¿‹_pâ
;

491 
	mç¡_¡¬t_pâ
;

492 
zÚe
 *
	mzÚe
;

493 
	mtÙ®_mig¿‹_sÿÂed
;

494 
	mtÙ®_ä“_sÿÂed
;

495 
	mç¡_£¬ch_ç
;

496 
	m£¬ch_Üd”
;

497 cÚ¡ 
gå_t
 
	mgå_mask
;

498 
	mÜd”
;

499 
	mmig¿‹ty³
;

500 cÚ¡ 
	m®loc_æags
;

501 cÚ¡ 
	mhighe¡_zÚeidx
;

502 
mig¿‹_mode
 
	mmode
;

503 
boŞ
 
	mignÜe_sk_hšt
;

504 
boŞ
 
	mno_£t_sk_hšt
;

505 
boŞ
 
	mignÜe_block_su™abË
;

506 
boŞ
 
	mdœeù_com·ùiÚ
;

507 
boŞ
 
	m´ßùive_com·ùiÚ
;

508 
boŞ
 
	mwhŞe_zÚe
;

509 
boŞ
 
	mcÚ‹nded
;

510 
boŞ
 
	mfšish_·geblock
;

515 
boŞ
 
	m®loc_cÚtig
;

522 
	sÿ±u»_cÚŒŞ
 {

523 
com·ù_cÚŒŞ
 *
	mcc
;

524 
·ge
 *
	m·ge
;

528 
isŞ©e_ä“·ges_¿nge
(
com·ù_cÚŒŞ
 *
cc
,

529 
¡¬t_pâ
, 
’d_pâ
);

531 
isŞ©e_mig¿‹·ges_¿nge
(
com·ù_cÚŒŞ
 *
cc
,

532 
low_pâ
, 
’d_pâ
);

534 
__®loc_cÚtig_mig¿‹_¿nge
(
com·ù_cÚŒŞ
 *
cc
,

535 
¡¬t
, 
’d
);

538 
š™_cma_»£rved_·geblock
(
·ge
 *page);

542 
fšd_su™abË_çÎback
(
ä“_¬—
 *
¬—
, 
Üd”
,

543 
mig¿‹ty³
, 
boŞ
 
Úly_¡—ÏbË
, boŞ *
ÿn_¡—l
);

545 
šlše
 
boŞ
 
	$ä“_¬—_em±y
(
ä“_¬—
 *
¬—
, 
mig¿‹ty³
)

547  
	`li¡_em±y
(&
¬—
->
ä“_li¡
[
mig¿‹ty³
]);

548 
	}
}

557 
šlše
 
boŞ
 
	$is_exec_m­pšg
(
vm_æags_t
 
æags
)

559  (
æags
 & (
VM_EXEC
 | 
VM_WRITE
 | 
VM_STACK
)) == VM_EXEC;

560 
	}
}

568 
šlše
 
boŞ
 
	$is_¡ack_m­pšg
(
vm_æags_t
 
æags
)

570  ((
æags
 & 
VM_STACK
è=ğVM_STACKè|| (æag & 
VM_SHADOW_STACK
);

571 
	}
}

576 
šlše
 
boŞ
 
	$is_d©a_m­pšg
(
vm_æags_t
 
æags
)

578  (
æags
 & (
VM_WRITE
 | 
VM_SHARED
 | 
VM_STACK
)) == VM_WRITE;

579 
	}
}

582 
ªÚ_vma
 *
fŞio_ªÚ_vma
(
fŞio
 *folio);

584 #ifdeà
CONFIG_MMU


585 
unm­_m­pšg_fŞio
(
fŞio
 *folio);

586 
pİuÏ‹_vma_·ge_¿nge
(
vm_¬—_¡ruù
 *
vma
,

587 
¡¬t
, 
’d
, *
locked
);

588 
çuÉš_vma_·ge_¿nge
(
vm_¬—_¡ruù
 *
vma
,

589 
¡¬t
, 
’d
,

590 
boŞ
 
wr™e
, *
locked
);

591 
boŞ
 
mlock_futu»_ok
(
mm_¡ruù
 *
mm
, 
æags
,

592 
by‹s
);

606 
mlock_fŞio
(
fŞio
 *folio);

607 
šlše
 
	$mlock_vma_fŞio
(
fŞio
 *folio,

608 
vm_¬—_¡ruù
 *
vma
, 
boŞ
 
compound
)

618 ià(
	`uÆik–y
((
vma
->
vm_æags
 & (
VM_LOCKED
|
VM_SPECIAL
)) == VM_LOCKED) &&

619 (
compound
 || !
	`fŞio_‹¡_Ïrge
(
fŞio
)))

620 
	`mlock_fŞio
(
fŞio
);

621 
	}
}

623 
muÆock_fŞio
(
fŞio
 *folio);

624 
šlše
 
	$muÆock_vma_fŞio
(
fŞio
 *folio,

625 
vm_¬—_¡ruù
 *
vma
, 
boŞ
 
compound
)

627 ià(
	`uÆik–y
(
vma
->
vm_æags
 & 
VM_LOCKED
) &&

628 (
compound
 || !
	`fŞio_‹¡_Ïrge
(
fŞio
)))

629 
	`muÆock_fŞio
(
fŞio
);

630 
	}
}

632 
mlock_Ãw_fŞio
(
fŞio
 *folio);

633 
boŞ
 
Ãed_mlock_d¿š
(
ıu
);

634 
mlock_d¿š_loÿl
();

635 
mlock_d¿š_»mÙe
(
ıu
);

637 
pmd_t
 
maybe_pmd_mkwr™e
Õmd_ˆ
pmd
, 
vm_¬—_¡ruù
 *
vma
);

643 
šlše
 

644 
	$vma_pgoff_add»ss
(
pgoff_t
 
pgoff
, 
Ä_·ges
,

645 
vm_¬—_¡ruù
 *
vma
)

647 
add»ss
;

649 ià(
pgoff
 >ğ
vma
->
vm_pgoff
) {

650 
add»ss
 = 
vma
->
vm_¡¬t
 +

651 ((
pgoff
 - 
vma
->
vm_pgoff
è<< 
PAGE_SHIFT
);

653 ià(
add»ss
 < 
vma
->
vm_¡¬t
 ||‡dd»s >ğvma->
vm_’d
)

654 
add»ss
 = -
EFAULT
;

655 } ià(
pgoff
 + 
Ä_·ges
 - 1 >ğ
vma
->
vm_pgoff
) {

657 
add»ss
 = 
vma
->
vm_¡¬t
;

659 
add»ss
 = -
EFAULT
;

661  
add»ss
;

662 
	}
}

669 
šlše
 

670 
	$vma_add»ss
(
·ge
 *·ge, 
vm_¬—_¡ruù
 *
vma
)

672 
	`VM_BUG_ON_PAGE
(
	`PageKsm
(
·ge
),…age);

673  
	`vma_pgoff_add»ss
(
	`·ge_to_pgoff
(
·ge
), 
	`compound_Ä
Õage), 
vma
);

674 
	}
}

680 
šlše
 
	$vma_add»ss_’d
(
·ge_vma_m­³d_w®k
 *
pvmw
)

682 
vm_¬—_¡ruù
 *
vma
 = 
pvmw
->vma;

683 
pgoff_t
 
pgoff
;

684 
add»ss
;

687 ià(
pvmw
->
Ä_·ges
 == 1)

688  
pvmw
->
add»ss
 + 
PAGE_SIZE
;

690 
pgoff
 = 
pvmw
->pgofà+…vmw->
Ä_·ges
;

691 
add»ss
 = 
vma
->
vm_¡¬t
 + ((
pgoff
 - vma->
vm_pgoff
è<< 
PAGE_SHIFT
);

693 ià(
add»ss
 < 
vma
->
vm_¡¬t
 ||‡dd»s > vma->
vm_’d
)

694 
add»ss
 = 
vma
->
vm_’d
;

695  
add»ss
;

696 
	}
}

698 
šlše
 
fe
 *
	$maybe_uÆock_mm­_fÜ_io
(
vm_çuÉ
 *
vmf
,

699 
fe
 *
åš
)

701 
æags
 = 
vmf
->flags;

703 ià(
åš
)

704  
åš
;

711 ià(
	`çuÉ_æag_®low_»Œy_fœ¡
(
æags
) &&

712 !(
æags
 & 
FAULT_FLAG_RETRY_NOWAIT
)) {

713 
åš
 = 
	`g‘_fe
(
vmf
->
vma
->
vm_fe
);

714 
	`»Ëa£_çuÉ_lock
(
vmf
);

716  
åš
;

717 
	}
}

719 
šlše
 
	$unm­_m­pšg_fŞio
(
fŞio
 *fŞioè{ 
	}
}

720 
šlše
 
	$mlock_Ãw_fŞio
(
fŞio
 *fŞioè{ 
	}
}

721 
šlše
 
boŞ
 
	$Ãed_mlock_d¿š
(
ıu
è{  
çl£
; 
	}
}

722 
šlše
 
	$mlock_d¿š_loÿl
(è{ 
	}
}

723 
šlše
 
	$mlock_d¿š_»mÙe
(
ıu
è{ 
	}
}

724 
šlše
 
	$vunm­_¿nge_noæush
(
¡¬t
, 
’d
)

726 
	}
}

730 #ifdeà
CONFIG_DEFERRED_STRUCT_PAGE_INIT


731 
DECLARE_STATIC_KEY_TRUE
(
deã¼ed_·ges
);

733 
boŞ
 
__š™
 
deã¼ed_grow_zÚe
(
zÚe
 *zÚe, 
Üd”
);

736 
	emmš™_Ëv–
 {

737 
	mMMINIT_WARNING
,

738 
	mMMINIT_VERIFY
,

739 
	mMMINIT_TRACE


742 #ifdeà
CONFIG_DEBUG_MEMORY_INIT


744 
mmš™_logËv–
;

746 
	#mmš™_d´štk
(
Ëv–
, 
´efix
, 
fmt
, 
¬g
...) \

748 ià(
Ëv–
 < 
mmš™_logËv–
) { \

749 ià(
Ëv–
 <ğ
MMINIT_WARNING
) \

750 
	`´_w¬n
("mmš™::" 
´efix
 " " 
fmt
, ##
¬g
); \

752 
	`´štk
(
KERN_DEBUG
 "mmš™::" 
´efix
 " " 
fmt
, ##
¬g
); \

754 } 0)

	)

756 
mmš™_v”ify_·geæags_Ïyout
();

757 
mmš™_v”ify_zÚ–i¡
();

760 
šlše
 
	$mmš™_d´štk
(
mmš™_Ëv–
 
Ëv–
,

761 cÚ¡ *
´efix
, cÚ¡ *
fmt
, ...)

763 
	}
}

765 
šlše
 
	$mmš™_v”ify_·geæags_Ïyout
()

767 
	}
}

769 
šlše
 
	$mmš™_v”ify_zÚ–i¡
()

771 
	}
}

774 
	#NODE_RECLAIM_NOSCAN
 -2

	)

775 
	#NODE_RECLAIM_FULL
 -1

	)

776 
	#NODE_RECLAIM_SOME
 0

	)

777 
	#NODE_RECLAIM_SUCCESS
 1

	)

779 #ifdeà
CONFIG_NUMA


780 
node_»şaim
(
pgli¡_d©a
 *, 
gå_t
, );

781 
fšd_Ãxt_be¡_node
(
node
, 
nodemask_t
 *
u£d_node_mask
);

783 
šlše
 
	$node_»şaim
(
pgli¡_d©a
 *
pgd©
, 
gå_t
 
mask
,

784 
Üd”
)

786  
NODE_RECLAIM_NOSCAN
;

787 
	}
}

788 
šlše
 
	$fšd_Ãxt_be¡_node
(
node
, 
nodemask_t
 *
u£d_node_mask
)

790  
NUMA_NO_NODE
;

791 
	}
}

797 
hwpoisÚ_f‹r
(
·ge
 *
p
);

799 
u32
 
hwpoisÚ_f‹r_dev_majÜ
;

800 
u32
 
hwpoisÚ_f‹r_dev_mšÜ
;

801 
u64
 
hwpoisÚ_f‹r_æags_mask
;

802 
u64
 
hwpoisÚ_f‹r_æags_v®ue
;

803 
u64
 
hwpoisÚ_f‹r_memcg
;

804 
u32
 
hwpoisÚ_f‹r_’abË
;

806 
__mu¡_check
 
vm_mm­_pgoff
(
fe
 *, ,

810 
£t_·geblock_Üd”
();

811 
»şaim_·ges
(
li¡_h—d
 *
fŞio_li¡
);

812 
»şaim_ş—n_·ges_äom_li¡
(
zÚe
 *zone,

813 
li¡_h—d
 *
fŞio_li¡
);

815 
	#ALLOC_WMARK_MIN
 
WMARK_MIN


	)

816 
	#ALLOC_WMARK_LOW
 
WMARK_LOW


	)

817 
	#ALLOC_WMARK_HIGH
 
WMARK_HIGH


	)

818 
	#ALLOC_NO_WATERMARKS
 0x04

	)

821 
	#ALLOC_WMARK_MASK
 (
ALLOC_NO_WATERMARKS
-1)

	)

828 #ifdeà
CONFIG_MMU


829 
	#ALLOC_OOM
 0x08

	)

831 
	#ALLOC_OOM
 
ALLOC_NO_WATERMARKS


	)

834 
	#ALLOC_NON_BLOCK
 0x10

	)

838 
	#ALLOC_MIN_RESERVE
 0x20

	)

841 
	#ALLOC_CPUSET
 0x40

	)

842 
	#ALLOC_CMA
 0x80

	)

843 #ifdeà
CONFIG_ZONE_DMA32


844 
	#ALLOC_NOFRAGMENT
 0x100

	)

846 
	#ALLOC_NOFRAGMENT
 0x0

	)

848 
	#ALLOC_HIGHATOMIC
 0x200

	)

849 
	#ALLOC_KSWAPD
 0x800

	)

852 
	#ALLOC_RESERVES
 (
ALLOC_NON_BLOCK
|
ALLOC_MIN_RESERVE
|
ALLOC_HIGHATOMIC
|
ALLOC_OOM
)

	)

854 
	g‰u_æags
;

855 
	gbæush_unm­_b©ch
;

862 
wÜkqueue_¡ruù
 *
mm_³rıu_wq
;

864 #ifdeà
CONFIG_ARCH_WANT_BATCHED_UNMAP_TLB_FLUSH


865 
Œy_to_unm­_æush
();

866 
Œy_to_unm­_æush_dœty
();

867 
æush_b_b©ched_³ndšg
(
mm_¡ruù
 *
mm
);

869 
šlše
 
	$Œy_to_unm­_æush
()

871 
	}
}

872 
šlše
 
	$Œy_to_unm­_æush_dœty
()

874 
	}
}

875 
šlše
 
	$æush_b_b©ched_³ndšg
(
mm_¡ruù
 *
mm
)

877 
	}
}

880 cÚ¡ 
Œaû_´št_æags
 
·geæag_Çmes
[];

881 cÚ¡ 
Œaû_´št_æags
 
·g‘y³_Çmes
[];

882 cÚ¡ 
Œaû_´št_æags
 
vmaæag_Çmes
[];

883 cÚ¡ 
Œaû_´št_æags
 
gåæag_Çmes
[];

885 
šlše
 
boŞ
 
	$is_mig¿‹_high©omic
(
mig¿‹ty³
 migratetype)

887  
mig¿‹ty³
 =ğ
MIGRATE_HIGHATOMIC
;

888 
	}
}

890 
šlše
 
boŞ
 
	$is_mig¿‹_high©omic_·ge
(
·ge
 *page)

892  
	`g‘_·geblock_mig¿‹ty³
(
·ge
è=ğ
MIGRATE_HIGHATOMIC
;

893 
	}
}

895 
£tup_zÚe_·ge£t
(
zÚe
 *zone);

897 
	smig¿tiÚ_rg‘_cÚŒŞ
 {

898 
	mnid
;

899 
nodemask_t
 *
	mnmask
;

900 
gå_t
 
	mgå_mask
;

906 
size_t
 
¥liû_fŞio_što_pe
(
pe_šode_šfo
 *
pe
,

907 
fŞio
 *fŞio, 
loff_t
 
åos
, 
size_t
 
size
);

912 #ifdeà
CONFIG_MMU


913 
__š™
 
vm®loc_š™
();

914 
__mu¡_check
 
vm­_·ges_¿nge_noæush
(
addr
, 
’d
,

915 
pg´Ù_t
 
´Ù
, 
·ge
 **
·ges
, 
·ge_shiá
);

917 
šlše
 
	$vm®loc_š™
()

919 
	}
}

921 
šlše


922 
__mu¡_check
 
	$vm­_·ges_¿nge_noæush
(
addr
, 
’d
,

923 
pg´Ù_t
 
´Ù
, 
·ge
 **
·ges
, 
·ge_shiá
)

925  -
EINVAL
;

926 
	}
}

929 
__mu¡_check
 
__vm­_·ges_¿nge_noæush
(
addr
,

930 
’d
, 
pg´Ù_t
 
´Ù
,

931 
·ge
 **
·ges
, 
·ge_shiá
);

933 
vunm­_¿nge_noæush
(
¡¬t
, 
’d
);

935 
__vunm­_¿nge_noæush
(
¡¬t
, 
’d
);

937 
numa_mig¿‹_´•
(
·ge
 *·ge, 
vm_¬—_¡ruù
 *
vma
,

938 
addr
, 
·ge_nid
, *
æags
);

940 
ä“_zÚe_deviû_·ge
(
·ge
 *page);

941 
mig¿‹_deviû_coh”’t_·ge
(
·ge
 *page);

946 
fŞio
 *
Œy_g¿b_fŞio
(
·ge
 *·ge, 
»fs
, 
æags
);

947 
__mu¡_check
 
Œy_g¿b_·ge
(
·ge
 *·ge, 
æags
);

952 
·ge
 *
fŞlow_Œªs_huge_pmd
(
vm_¬—_¡ruù
 *
vma
,

953 
addr
, 
pmd_t
 *
pmd
,

954 
æags
);

958 
	mFOLL_TOUCH
 = 1 << 16,

960 
	mFOLL_TRIED
 = 1 << 17,

962 
	mFOLL_REMOTE
 = 1 << 18,

964 
	mFOLL_PIN
 = 1 << 19,

966 
	mFOLL_FAST_ONLY
 = 1 << 20,

968 
	mFOLL_UNLOCKABLE
 = 1 << 21,

991 
šlše
 
boŞ
 
	$gup_mu¡_unsh¬e
(
vm_¬—_¡ruù
 *
vma
,

992 
æags
, 
·ge
 *page)

999 ià((
æags
 & (
FOLL_WRITE
 | 
FOLL_PIN
)) != FOLL_PIN)

1000  
çl£
;

1005 ià(!
	`PageAnÚ
(
·ge
)) {

1011 ià(!(
æags
 & 
FOLL_LONGTERM
))

1012  
çl£
;

1015 ià(!
vma
)

1016  
Œue
;

1022  
	`is_cow_m­pšg
(
vma
->
vm_æags
);

1026 ià(
	`IS_ENABLED
(
CONFIG_HAVE_FAST_GUP
))

1027 
	`smp_rmb
();

1036 ià(
	`uÆik–y
(!
	`PageH—d
(
·ge
è&& 
	`PageHuge
(page)))

1037 
·ge
 = 
	`compound_h—d
(page);

1043  !
	`PageAnÚExşusive
(
·ge
);

1044 
	}
}

1046 
boŞ
 
mœrÜed_k”ÃlcÜe
;

1047 
boŞ
 
memblock_has_mœrÜ
();

1049 
šlše
 
boŞ
 
	$vma_soá_dœty_’abËd
(
vm_¬—_¡ruù
 *
vma
)

1057 ià(!
	`IS_ENABLED
(
CONFIG_MEM_SOFT_DIRTY
))

1058  
çl£
;

1064  !(
vma
->
vm_æags
 & 
VM_SOFTDIRTY
);

1065 
	}
}

1067 
šlše
 
	$vma_™”_cÚfig
(
vma_™”©Ü
 *
vmi
,

1068 
šdex
, 
Ï¡
)

1070 
	`MAS_BUG_ON
(&
vmi
->
mas
, vmi->mas.
node
 !ğ
MAS_START
 &&

1071 (
vmi
->
mas
.
šdex
 > index || vmi->mas.
Ï¡
 < index));

1072 
	`__mas_£t_¿nge
(&
vmi
->
mas
, 
šdex
, 
Ï¡
 - 1);

1073 
	}
}

1078 
šlše
 
	$vma_™”_´—Îoc
(
vma_™”©Ü
 *
vmi
,

1079 
vm_¬—_¡ruù
 *
vma
)

1081  
	`mas_´—Îoÿ‹
(&
vmi
->
mas
, 
vma
, 
GFP_KERNEL
);

1082 
	}
}

1084 
šlše
 
	$vma_™”_ş—r
(
vma_™”©Ü
 *
vmi
)

1086 
	`mas_¡Üe_´—Îoc
(&
vmi
->
mas
, 
NULL
);

1087 
	}
}

1089 
šlše
 
	$vma_™”_ş—r_gå
(
vma_™”©Ü
 *
vmi
,

1090 
¡¬t
, 
’d
, 
gå_t
 
gå
)

1092 
	`__mas_£t_¿nge
(&
vmi
->
mas
, 
¡¬t
, 
’d
 - 1);

1093 
	`mas_¡Üe_gå
(&
vmi
->
mas
, 
NULL
, 
gå
);

1094 ià(
	`uÆik–y
(
	`mas_is_”r
(&
vmi
->
mas
)))

1095  -
ENOMEM
;

1098 
	}
}

1100 
šlše
 
vm_¬—_¡ruù
 *
	$vma_™”_lßd
(
vma_™”©Ü
 *
vmi
)

1102  
	`mas_w®k
(&
vmi
->
mas
);

1103 
	}
}

1106 
šlše
 
	$vma_™”_¡Üe
(
vma_™”©Ü
 *
vmi
,

1107 
vm_¬—_¡ruù
 *
vma
)

1110 #ià
	`defšed
(
CONFIG_DEBUG_VM_MAPLE_TREE
)

1111 ià(
	`MAS_WARN_ON
(&
vmi
->
mas
, vmi->mas.
node
 !ğ
MAS_START
 &&

1112 
vmi
->
mas
.
šdex
 > 
vma
->
vm_¡¬t
)) {

1113 
	`´_w¬n
("%lx > %lx\n store vma %lx-%lx\n into slot %lx-%lx\n",

1114 
vmi
->
mas
.
šdex
, 
vma
->
vm_¡¬t
, vma->vm_start,

1115 
vma
->
vm_’d
, 
vmi
->
mas
.
šdex
, vmi->mas.
Ï¡
);

1117 ià(
	`MAS_WARN_ON
(&
vmi
->
mas
, vmi->mas.
node
 !ğ
MAS_START
 &&

1118 
vmi
->
mas
.
Ï¡
 < 
vma
->
vm_¡¬t
)) {

1119 
	`´_w¬n
("%lx < %lx\nstore vma %lx-%lx\ninto slot %lx-%lx\n",

1120 
vmi
->
mas
.
Ï¡
, 
vma
->
vm_¡¬t
, vma->vm_¡¬t, vma->
vm_’d
,

1121 
vmi
->
mas
.
šdex
, vmi->mas.
Ï¡
);

1125 ià(
vmi
->
mas
.
node
 !ğ
MAS_START
 &&

1126 ((
vmi
->
mas
.
šdex
 > 
vma
->
vm_¡¬t
è|| (vmi->mas.
Ï¡
 < vma->vm_start)))

1127 
	`vma_™”_šv®id©e
(
vmi
);

1129 
	`__mas_£t_¿nge
(&
vmi
->
mas
, 
vma
->
vm_¡¬t
, vma->
vm_’d
 - 1);

1130 
	`mas_¡Üe_´—Îoc
(&
vmi
->
mas
, 
vma
);

1131 
	}
}

1133 
šlše
 
	$vma_™”_¡Üe_gå
(
vma_™”©Ü
 *
vmi
,

1134 
vm_¬—_¡ruù
 *
vma
, 
gå_t
 
gå
)

1136 ià(
vmi
->
mas
.
node
 !ğ
MAS_START
 &&

1137 ((
vmi
->
mas
.
šdex
 > 
vma
->
vm_¡¬t
è|| (vmi->mas.
Ï¡
 < vma->vm_start)))

1138 
	`vma_™”_šv®id©e
(
vmi
);

1140 
	`__mas_£t_¿nge
(&
vmi
->
mas
, 
vma
->
vm_¡¬t
, vma->
vm_’d
 - 1);

1141 
	`mas_¡Üe_gå
(&
vmi
->
mas
, 
vma
, 
gå
);

1142 ià(
	`uÆik–y
(
	`mas_is_”r
(&
vmi
->
mas
)))

1143  -
ENOMEM
;

1146 
	}
}

1151 
	svma_´•¬e
 {

1152 
vm_¬—_¡ruù
 *
	mvma
;

1153 
vm_¬—_¡ruù
 *
	madj_Ãxt
;

1154 
fe
 *
	mfe
;

1155 
add»ss_¥aû
 *
	mm­pšg
;

1156 
ªÚ_vma
 *
	mªÚ_vma
;

1157 
vm_¬—_¡ruù
 *
	mš£¹
;

1158 
vm_¬—_¡ruù
 *
	m»move
;

1159 
vm_¬—_¡ruù
 *
	m»move2
;

	@ordered-data.c

6 
	~<lšux/¦ab.h
>

7 
	~<lšux/blkdev.h
>

8 
	~<lšux/wr™eback.h
>

9 
	~<lšux/sched/mm.h
>

10 
	~"mes§ges.h
"

11 
	~"misc.h
"

12 
	~"ù»e.h
"

13 
	~"Œª§ùiÚ.h
"

14 
	~"bŒfs_šode.h
"

15 
	~"ex‹Á_io.h
"

16 
	~"disk-io.h
"

17 
	~"com´essiÚ.h
"

18 
	~"d–®loc-¥aû.h
"

19 
	~"qgroup.h
"

20 
	~"sub·ge.h
"

21 
	~"fe.h
"

22 
	~"su³r.h
"

24 
kmem_ÿche
 *
	gbŒfs_Üd”ed_ex‹Á_ÿche
;

26 
u64
 
	$’Œy_’d
(
bŒfs_Üd”ed_ex‹Á
 *
’Œy
)

28 ià(
’Œy
->
fe_off£t
 +ƒÁry->
num_by‹s
 <ƒntry->file_offset)

29  (
u64
)-1;

30  
’Œy
->
fe_off£t
 +ƒÁry->
num_by‹s
;

31 
	}
}

36 
rb_node
 *
	$Œ“_š£¹
(
rb_roÙ
 *
roÙ
, 
u64
 
fe_off£t
,

37 
rb_node
 *
node
)

39 
rb_node
 **
p
 = &
roÙ
->rb_node;

40 
rb_node
 *
·»Á
 = 
NULL
;

41 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
;

43 *
p
) {

44 
·»Á
 = *
p
;

45 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

47 ià(
fe_off£t
 < 
’Œy
->file_offset)

48 
p
 = &(*p)->
rb_Ëá
;

49 ià(
fe_off£t
 >ğ
	`’Œy_’d
(
’Œy
))

50 
p
 = &(*p)->
rb_right
;

52  
·»Á
;

55 
	`rb_lšk_node
(
node
, 
·»Á
, 
p
);

56 
	`rb_š£¹_cŞÜ
(
node
, 
roÙ
);

57  
NULL
;

58 
	}
}

64 
rb_node
 *
	$__Œ“_£¬ch
(
rb_roÙ
 *
roÙ
, 
u64
 
fe_off£t
,

65 
rb_node
 **
´ev_»t
)

67 
rb_node
 *
n
 = 
roÙ
->rb_node;

68 
rb_node
 *
´ev
 = 
NULL
;

69 
rb_node
 *
‹¡
;

70 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
;

71 
bŒfs_Üd”ed_ex‹Á
 *
´ev_’Œy
 = 
NULL
;

73 
n
) {

74 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

75 
´ev
 = 
n
;

76 
´ev_’Œy
 = 
’Œy
;

78 ià(
fe_off£t
 < 
’Œy
->file_offset)

79 
n
 =‚->
rb_Ëá
;

80 ià(
fe_off£t
 >ğ
	`’Œy_’d
(
’Œy
))

81 
n
 =‚->
rb_right
;

83  
n
;

85 ià(!
´ev_»t
)

86  
NULL
;

88 
´ev
 && 
fe_off£t
 >ğ
	`’Œy_’d
(
´ev_’Œy
)) {

89 
‹¡
 = 
	`rb_Ãxt
(
´ev
);

90 ià(!
‹¡
)

92 
´ev_’Œy
 = 
	`rb_’Œy
(
‹¡
, 
bŒfs_Üd”ed_ex‹Á
,

93 
rb_node
);

94 ià(
fe_off£t
 < 
	`’Œy_’d
(
´ev_’Œy
))

97 
´ev
 = 
‹¡
;

99 ià(
´ev
)

100 
´ev_’Œy
 = 
	`rb_’Œy
(
´ev
, 
bŒfs_Üd”ed_ex‹Á
,

101 
rb_node
);

102 
´ev
 && 
fe_off£t
 < 
	`’Œy_’d
(
´ev_’Œy
)) {

103 
‹¡
 = 
	`rb_´ev
(
´ev
);

104 ià(!
‹¡
)

106 
´ev_’Œy
 = 
	`rb_’Œy
(
‹¡
, 
bŒfs_Üd”ed_ex‹Á
,

107 
rb_node
);

108 
´ev
 = 
‹¡
;

110 *
´ev_»t
 = 
´ev
;

111  
NULL
;

112 
	}
}

114 
	$¿nge_ov”Ïps
(
bŒfs_Üd”ed_ex‹Á
 *
’Œy
, 
u64
 
fe_off£t
,

115 
u64
 
Ën
)

117 ià(
fe_off£t
 + 
Ën
 <ğ
’Œy
->file_offset ||

118 
’Œy
->
fe_off£t
 +ƒÁry->
num_by‹s
 <= file_offset)

121 
	}
}

127 
šlše
 
rb_node
 *
	$Œ“_£¬ch
(
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
,

128 
u64
 
fe_off£t
)

130 
rb_roÙ
 *
roÙ
 = &
Œ“
->tree;

131 
rb_node
 *
´ev
 = 
NULL
;

132 
rb_node
 *
»t
;

133 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
;

135 ià(
Œ“
->
Ï¡
) {

136 
’Œy
 = 
	`rb_’Œy
(
Œ“
->
Ï¡
, 
bŒfs_Üd”ed_ex‹Á
,

137 
rb_node
);

138 ià(
	`š_¿nge
(
fe_off£t
, 
’Œy
->fe_off£t,ƒÁry->
num_by‹s
))

139  
Œ“
->
Ï¡
;

141 
»t
 = 
	`__Œ“_£¬ch
(
roÙ
, 
fe_off£t
, &
´ev
);

142 ià(!
»t
)

143 
»t
 = 
´ev
;

144 ià(
»t
)

145 
Œ“
->
Ï¡
 = 
»t
;

146  
»t
;

147 
	}
}

149 
bŒfs_Üd”ed_ex‹Á
 *
	$®loc_Üd”ed_ex‹Á
(

150 
bŒfs_šode
 *
bšode
, 
u64
 
fe_off£t
, u64 
num_by‹s
,

151 
u64
 
¿m_by‹s
, u64 
disk_by‹Ä
, u64 
disk_num_by‹s
,

152 
u64
 
off£t
, 
æags
, 
com´ess_ty³
)

154 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
;

155 
»t
;

156 
u64
 
qgroup_rsv
 = 0;

158 ià(
æags
 &

159 ((1 << 
BTRFS_ORDERED_NOCOW
è| (1 << 
BTRFS_ORDERED_PREALLOC
))) {

161 
»t
 = 
	`bŒfs_qgroup_ä“_d©a
(
bšode
, 
NULL
, 
fe_off£t
, 
num_by‹s
, &
qgroup_rsv
);

162 ià(
»t
 < 0)

163  
	`ERR_PTR
(
»t
);

169 
»t
 = 
	`bŒfs_qgroup_»Ëa£_d©a
(
bšode
, 
fe_off£t
, 
num_by‹s
, &
qgroup_rsv
);

170 ià(
»t
 < 0)

171  
	`ERR_PTR
(
»t
);

173 
’Œy
 = 
	`kmem_ÿche_z®loc
(
bŒfs_Üd”ed_ex‹Á_ÿche
, 
GFP_NOFS
);

174 ià(!
’Œy
)

175  
	`ERR_PTR
(-
ENOMEM
);

177 
šode
 *
VFSšode
 = &
bšode
->
vfs_šode
;

178 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
VFSšode
->
i_sb
);

179 
bŒfs_su³r_block
 *
sb
 = 
fs_šfo
->
su³r_cİy
;

180 
u64
 
tÙ®_by‹s
 = 
sb
->total_bytes;

181 
u64
 
nodesize
 = 
sb
->nodesize;

184 
’Œy
->
fe_off£t
 = file_offset;

185 
’Œy
->
num_by‹s
 =‚um_bytes;

186 
’Œy
->
¿m_by‹s
 =„am_bytes;

187 
’Œy
->
disk_by‹Ä
 = disk_bytenr;

188 
’Œy
->
disk_num_by‹s
 = disk_num_bytes;

189 
’Œy
->
off£t
 = offset;

190 
’Œy
->
by‹s_Ëá
 = 
num_by‹s
;

191 
’Œy
->
šode
 = 
	`ig¿b
(&
bšode
->
vfs_šode
);

192 
’Œy
->
com´ess_ty³
 = compress_type;

193 
’Œy
->
Œunÿ‹d_Ën
 = (
u64
)-1;

194 
’Œy
->
qgroup_rsv
 = qgroup_rsv;

195 
’Œy
->
æags
 = flags;

196 
	`»fcouÁ_£t
(&
’Œy
->
»fs
, 1);

197 
	`š™_wa™queue_h—d
(&
’Œy
->
wa™
);

198 
	`INIT_LIST_HEAD
(&
’Œy
->
li¡
);

199 
	`INIT_LIST_HEAD
(&
’Œy
->
log_li¡
);

200 
	`INIT_LIST_HEAD
(&
’Œy
->
roÙ_ex‹Á_li¡
);

201 
	`INIT_LIST_HEAD
(&
’Œy
->
wÜk_li¡
);

202 
	`š™_com¶‘iÚ
(&
’Œy
->
com¶‘iÚ
);

209 
	`¥š_lock
(&
bšode
->
lock
);

210 
	`bŒfs_mod_out¡ªdšg_ex‹Ás
(
bšode
, 1);

211 
	`¥š_uÆock
(&
bšode
->
lock
);

213  
’Œy
;

214 
	}
}

216 
	$š£¹_Üd”ed_ex‹Á
(
bŒfs_Üd”ed_ex‹Á
 *
’Œy
)

218 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
’Œy
->inode);

219 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
 = &
šode
->
Üd”ed_Œ“
;

220 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

221 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

222 
rb_node
 *
node
;

224 
	`Œaû_bŒfs_Üd”ed_ex‹Á_add
(
šode
, 
’Œy
);

226 
	`³rıu_couÁ”_add_b©ch
(&
fs_šfo
->
Üd”ed_by‹s
, 
’Œy
->
num_by‹s
,

227 
fs_šfo
->
d–®loc_b©ch
);

230 
	`»fcouÁ_šc
(&
’Œy
->
»fs
);

232 
	`¥š_lock_œq
(&
Œ“
->
lock
);

233 
node
 = 
	`Œ“_š£¹
(&
Œ“
->Œ“, 
’Œy
->
fe_off£t
, &’Œy->
rb_node
);

234 ià(
node
)

235 
	`bŒfs_·nic
(
fs_šfo
, -
EEXIST
,

237 
’Œy
->
fe_off£t
);

238 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

240 
	`¥š_lock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

241 
	`li¡_add_
(&
’Œy
->
roÙ_ex‹Á_li¡
,

242 &
roÙ
->
Üd”ed_ex‹Ás
);

243 
roÙ
->
Ä_Üd”ed_ex‹Ás
++;

244 ià(
roÙ
->
Ä_Üd”ed_ex‹Ás
 == 1) {

245 
	`¥š_lock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

246 
	`BUG_ON
(!
	`li¡_em±y
(&
roÙ
->
Üd”ed_roÙ
));

247 
	`li¡_add_
(&
roÙ
->
Üd”ed_roÙ
, &
fs_šfo
->
Üd”ed_roÙs
);

248 
	`¥š_uÆock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

250 
	`¥š_uÆock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

251 
	}
}

272 
bŒfs_Üd”ed_ex‹Á
 *
	$bŒfs_®loc_Üd”ed_ex‹Á
(

273 
bŒfs_šode
 *
šode
, 
u64
 
fe_off£t
,

274 
u64
 
num_by‹s
, u64 
¿m_by‹s
, u64 
disk_by‹Ä
,

275 
u64
 
disk_num_by‹s
, u64 
off£t
, 
æags
,

276 
com´ess_ty³
)

278 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
;

280 
	`ASSERT
((
æags
 & ~
BTRFS_ORDERED_TYPE_FLAGS
) == 0);

282 
’Œy
 = 
	`®loc_Üd”ed_ex‹Á
(
šode
, 
fe_off£t
, 
num_by‹s
, 
¿m_by‹s
,

283 
disk_by‹Ä
, 
disk_num_by‹s
, 
off£t
, 
æags
,

284 
com´ess_ty³
);

285 ià(!
	`IS_ERR
(
’Œy
))

286 
	`š£¹_Üd”ed_ex‹Á
(
’Œy
);

287  
’Œy
;

288 
	}
}

295 
	$bŒfs_add_Üd”ed_sum
(
bŒfs_Üd”ed_ex‹Á
 *
’Œy
,

296 
bŒfs_Üd”ed_sum
 *
sum
)

298 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
;

300 
Œ“
 = &
	`BTRFS_I
(
’Œy
->
šode
)->
Üd”ed_Œ“
;

301 
	`¥š_lock_œq
(&
Œ“
->
lock
);

302 
	`li¡_add_
(&
sum
->
li¡
, &
’Œy
->list);

303 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

304 
	}
}

306 
	$fšish_Üd”ed_â
(
bŒfs_wÜk
 *
wÜk
)

308 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed_ex‹Á
;

310 
Üd”ed_ex‹Á
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_Üd”ed_ex‹Á
, work);

311 
	`bŒfs_fšish_Üd”ed_io
(
Üd”ed_ex‹Á
);

312 
	}
}

314 
boŞ
 
	$ÿn_fšish_Üd”ed_ex‹Á
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
,

315 
·ge
 *·ge, 
u64
 
fe_off£t
,

316 
u64
 
Ën
, 
boŞ
 
u±od©e
)

318 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
Üd”ed
->inode);

319 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

321 
	`lockd•_as£¹_h–d
(&
šode
->
Üd”ed_Œ“
.
lock
);

323 ià(
·ge
) {

324 
	`ASSERT
(
·ge
->
m­pšg
);

325 
	`ASSERT
(
	`·ge_off£t
(
·ge
è<ğ
fe_off£t
);

326 
	`ASSERT
(
fe_off£t
 + 
Ën
 <ğ
	`·ge_off£t
(
·ge
è+ 
PAGE_SIZE
);

334 ià(!
	`bŒfs_·ge_‹¡_Üd”ed
(
fs_šfo
, 
·ge
, 
fe_off£t
, 
Ën
))

335  
çl£
;

336 
	`bŒfs_·ge_ş—r_Üd”ed
(
fs_šfo
, 
·ge
, 
fe_off£t
, 
Ën
);

340 ià(
	`WARN_ON_ONCE
(
Ën
 > 
Üd”ed
->
by‹s_Ëá
)) {

341 
	`bŒfs_ü™
(
fs_šfo
,

343 
šode
->
roÙ
->
roÙ_key
.
objeùid
, 
	`bŒfs_šo
(inode),

344 
Üd”ed
->
fe_off£t
, ord”ed->
num_by‹s
,

345 
Ën
, 
Üd”ed
->
by‹s_Ëá
);

346 
Üd”ed
->
by‹s_Ëá
 = 0;

348 
Üd”ed
->
by‹s_Ëá
 -ğ
Ën
;

351 ià(!
u±od©e
)

352 
	`£t_b™
(
BTRFS_ORDERED_IOERR
, &
Üd”ed
->
æags
);

354 ià(
Üd”ed
->
by‹s_Ëá
)

355  
çl£
;

361 
	`£t_b™
(
BTRFS_ORDERED_IO_DONE
, &
Üd”ed
->
æags
);

362 
	`cÚd_wake_up
(&
Üd”ed
->
wa™
);

363 
	`»fcouÁ_šc
(&
Üd”ed
->
»fs
);

364 
	`Œaû_bŒfs_Üd”ed_ex‹Á_m¬k_fšished
(
šode
, 
Üd”ed
);

365  
Œue
;

366 
	}
}

368 
	$bŒfs_queue_Üd”ed_â
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
)

370 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
Üd”ed
->inode);

371 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

372 
bŒfs_wÜkqueue
 *
wq
 = 
	`bŒfs_is_ä“_¥aû_šode
(
šode
) ?

373 
fs_šfo
->
’dio_ä“¥aû_wÜk”
 : fs_šfo->
’dio_wr™e_wÜk”s
;

375 
	`bŒfs_š™_wÜk
(&
Üd”ed
->
wÜk
, 
fšish_Üd”ed_â
, 
NULL
, NULL);

376 
	`bŒfs_queue_wÜk
(
wq
, &
Üd”ed
->
wÜk
);

377 
	}
}

379 
boŞ
 
	$bŒfs_fšish_Üd”ed_ex‹Á
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
,

380 
·ge
 *·ge, 
u64
 
fe_off£t
, u64 
Ën
,

381 
boŞ
 
u±od©e
)

383 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
Üd”ed
->inode);

384 
æags
;

385 
boŞ
 
»t
;

387 
	`Œaû_bŒfs_fšish_Üd”ed_ex‹Á
(
šode
, 
fe_off£t
, 
Ën
, 
u±od©e
);

389 
	`¥š_lock_œq§ve
(&
šode
->
Üd”ed_Œ“
.
lock
, 
æags
);

390 
»t
 = 
	`ÿn_fšish_Üd”ed_ex‹Á
(
Üd”ed
, 
·ge
, 
fe_off£t
, 
Ën
, 
u±od©e
);

391 
	`¥š_uÆock_œq»¡Üe
(&
šode
->
Üd”ed_Œ“
.
lock
, 
æags
);

393 ià(
»t
)

394 
	`bŒfs_queue_Üd”ed_â
(
Üd”ed
);

395  
»t
;

396 
	}
}

411 
	$bŒfs_m¬k_Üd”ed_io_fšished
(
bŒfs_šode
 *
šode
,

412 
·ge
 *·ge, 
u64
 
fe_off£t
,

413 
u64
 
num_by‹s
, 
boŞ
 
u±od©e
)

415 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
 = &
šode
->
Üd”ed_Œ“
;

416 
rb_node
 *
node
;

417 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
 = 
NULL
;

418 
æags
;

419 
u64
 
cur
 = 
fe_off£t
;

421 
	`Œaû_bŒfs_wr™•age_’d_io_hook
(
šode
, 
fe_off£t
,

422 
fe_off£t
 + 
num_by‹s
 - 1,

423 
u±od©e
);

425 
	`¥š_lock_œq§ve
(&
Œ“
->
lock
, 
æags
);

426 
cur
 < 
fe_off£t
 + 
num_by‹s
) {

427 
u64
 
’Œy_’d
;

428 
u64
 
’d
;

429 
u32
 
Ën
;

431 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
cur
);

433 ià(!
node
)

436 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

437 
’Œy_’d
 = 
’Œy
->
fe_off£t
 +ƒÁry->
num_by‹s
;

443 ià(
cur
 >ğ
’Œy_’d
) {

444 
node
 = 
	`rb_Ãxt
(node);

446 ià(!
node
)

448 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_Üd”ed_ex‹Á
,

449 
rb_node
);

452 
cur
 = 
’Œy
->
fe_off£t
;

460 ià(
cur
 < 
’Œy
->
fe_off£t
) {

461 
cur
 = 
’Œy
->
fe_off£t
;

472 
’d
 = 
	`mš
(
’Œy
->
fe_off£t
 +ƒÁry->
num_by‹s
,

473 
fe_off£t
 + 
num_by‹s
) - 1;

474 
	`ASSERT
(
’d
 + 1 - 
cur
 < 
U32_MAX
);

475 
Ën
 = 
’d
 + 1 - 
cur
;

477 ià(
	`ÿn_fšish_Üd”ed_ex‹Á
(
’Œy
, 
·ge
, 
cur
, 
Ën
, 
u±od©e
)) {

478 
	`¥š_uÆock_œq»¡Üe
(&
Œ“
->
lock
, 
æags
);

479 
	`bŒfs_queue_Üd”ed_â
(
’Œy
);

480 
	`¥š_lock_œq§ve
(&
Œ“
->
lock
, 
æags
);

482 
cur
 +ğ
Ën
;

484 
	`¥š_uÆock_œq»¡Üe
(&
Œ“
->
lock
, 
æags
);

485 
	}
}

504 
boŞ
 
	$bŒfs_dec_‹¡_Üd”ed_³ndšg
(
bŒfs_šode
 *
šode
,

505 
bŒfs_Üd”ed_ex‹Á
 **
ÿched
,

506 
u64
 
fe_off£t
, u64 
io_size
)

508 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
 = &
šode
->
Üd”ed_Œ“
;

509 
rb_node
 *
node
;

510 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
 = 
NULL
;

511 
æags
;

512 
boŞ
 
fšished
 = 
çl£
;

514 
	`¥š_lock_œq§ve
(&
Œ“
->
lock
, 
æags
);

515 ià(
ÿched
 && *cached) {

516 
’Œy
 = *
ÿched
;

517 
have_’Œy
;

520 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
fe_off£t
);

521 ià(!
node
)

522 
out
;

524 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

525 
have_’Œy
:

526 ià(!
	`š_¿nge
(
fe_off£t
, 
’Œy
->fe_off£t,ƒÁry->
num_by‹s
))

527 
out
;

529 ià(
io_size
 > 
’Œy
->
by‹s_Ëá
)

530 
	`bŒfs_ü™
(
šode
->
roÙ
->
fs_šfo
,

532 
’Œy
->
by‹s_Ëá
, 
io_size
);

534 
’Œy
->
by‹s_Ëá
 -ğ
io_size
;

536 ià(
’Œy
->
by‹s_Ëá
 == 0) {

541 
fšished
 = !
	`‹¡_ªd_£t_b™
(
BTRFS_ORDERED_IO_DONE
, &
’Œy
->
æags
);

543 
	`cÚd_wake_up_nomb
(&
’Œy
->
wa™
);

545 
out
:

546 ià(
fšished
 && 
ÿched
 && 
’Œy
) {

547 *
ÿched
 = 
’Œy
;

548 
	`»fcouÁ_šc
(&
’Œy
->
»fs
);

549 
	`Œaû_bŒfs_Üd”ed_ex‹Á_dec_‹¡_³ndšg
(
šode
, 
’Œy
);

551 
	`¥š_uÆock_œq»¡Üe
(&
Œ“
->
lock
, 
æags
);

552  
fšished
;

553 
	}
}

559 
	$bŒfs_put_Üd”ed_ex‹Á
(
bŒfs_Üd”ed_ex‹Á
 *
’Œy
)

561 
li¡_h—d
 *
cur
;

562 
bŒfs_Üd”ed_sum
 *
sum
;

564 
	`Œaû_bŒfs_Üd”ed_ex‹Á_put
(
	`BTRFS_I
(
’Œy
->
šode
),ƒntry);

566 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
’Œy
->
»fs
)) {

567 
	`ASSERT
(
	`li¡_em±y
(&
’Œy
->
roÙ_ex‹Á_li¡
));

568 
	`ASSERT
(
	`li¡_em±y
(&
’Œy
->
log_li¡
));

569 
	`ASSERT
(
	`RB_EMPTY_NODE
(&
’Œy
->
rb_node
));

570 ià(
’Œy
->
šode
)

571 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
’Œy
->
šode
));

572 !
	`li¡_em±y
(&
’Œy
->
li¡
)) {

573 
cur
 = 
’Œy
->
li¡
.
Ãxt
;

574 
sum
 = 
	`li¡_’Œy
(
cur
, 
bŒfs_Üd”ed_sum
, 
li¡
);

575 
	`li¡_d–
(&
sum
->
li¡
);

576 
	`kvä“
(
sum
);

578 
	`kmem_ÿche_ä“
(
bŒfs_Üd”ed_ex‹Á_ÿche
, 
’Œy
);

580 
	}
}

586 
	$bŒfs_»move_Üd”ed_ex‹Á
(
bŒfs_šode
 *btrfs_inode,

587 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
)

589 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
;

590 
bŒfs_roÙ
 *
roÙ
 = 
bŒfs_šode
->root;

591 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

592 
rb_node
 *
node
;

593 
boŞ
 
³ndšg
;

594 
boŞ
 
ä“¥aû_šode
;

600 
ä“¥aû_šode
 = 
	`bŒfs_is_ä“_¥aû_šode
(
bŒfs_šode
);

602 
	`bŒfs_lockd•_acquœe
(
fs_šfo
, 
bŒfs_Œªs_³ndšg_Üd”ed
);

604 
	`¥š_lock
(&
bŒfs_šode
->
lock
);

605 
	`bŒfs_mod_out¡ªdšg_ex‹Ás
(
bŒfs_šode
, -1);

606 
	`¥š_uÆock
(&
bŒfs_šode
->
lock
);

607 ià(
roÙ
 !ğ
fs_šfo
->
Œ“_roÙ
) {

608 
u64
 
»Ëa£
;

610 ià(
	`‹¡_b™
(
BTRFS_ORDERED_ENCODED
, &
’Œy
->
æags
))

611 
»Ëa£
 = 
’Œy
->
disk_num_by‹s
;

613 
»Ëa£
 = 
’Œy
->
num_by‹s
;

614 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
bŒfs_šode
, 
»Ëa£
,

615 
	`‹¡_b™
(
BTRFS_ORDERED_IOERR
,

616 &
’Œy
->
æags
));

619 
	`³rıu_couÁ”_add_b©ch
(&
fs_šfo
->
Üd”ed_by‹s
, -
’Œy
->
num_by‹s
,

620 
fs_šfo
->
d–®loc_b©ch
);

622 
Œ“
 = &
bŒfs_šode
->
Üd”ed_Œ“
;

623 
	`¥š_lock_œq
(&
Œ“
->
lock
);

624 
node
 = &
’Œy
->
rb_node
;

625 
	`rb_”a£
(
node
, &
Œ“
->tree);

626 
	`RB_CLEAR_NODE
(
node
);

627 ià(
Œ“
->
Ï¡
 =ğ
node
)

628 
Œ“
->
Ï¡
 = 
NULL
;

629 
	`£t_b™
(
BTRFS_ORDERED_COMPLETE
, &
’Œy
->
æags
);

630 
³ndšg
 = 
	`‹¡_ªd_ş—r_b™
(
BTRFS_ORDERED_PENDING
, &
’Œy
->
æags
);

631 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

637 ià(
³ndšg
) {

638 
bŒfs_Œª§ùiÚ
 *
Œªs
;

646 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

647 
Œªs
 = 
fs_šfo
->
ruÂšg_Œª§ùiÚ
;

648 ià(
Œªs
)

649 
	`»fcouÁ_šc
(&
Œªs
->
u£_couÁ
);

650 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

652 
	`ASSERT
(
Œªs
 || 
	`BTRFS_FS_ERROR
(
fs_šfo
));

653 ià(
Œªs
) {

654 ià(
	`©omic_dec_ªd_‹¡
(&
Œªs
->
³ndšg_Üd”ed
))

655 
	`wake_up
(&
Œªs
->
³ndšg_wa™
);

656 
	`bŒfs_put_Œª§ùiÚ
(
Œªs
);

660 
	`bŒfs_lockd•_»Ëa£
(
fs_šfo
, 
bŒfs_Œªs_³ndšg_Üd”ed
);

662 
	`¥š_lock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

663 
	`li¡_d–_š™
(&
’Œy
->
roÙ_ex‹Á_li¡
);

664 
roÙ
->
Ä_Üd”ed_ex‹Ás
--;

666 
	`Œaû_bŒfs_Üd”ed_ex‹Á_»move
(
bŒfs_šode
, 
’Œy
);

668 ià(!
roÙ
->
Ä_Üd”ed_ex‹Ás
) {

669 
	`¥š_lock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

670 
	`BUG_ON
(
	`li¡_em±y
(&
roÙ
->
Üd”ed_roÙ
));

671 
	`li¡_d–_š™
(&
roÙ
->
Üd”ed_roÙ
);

672 
	`¥š_uÆock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

674 
	`¥š_uÆock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

675 
	`wake_up
(&
’Œy
->
wa™
);

676 ià(!
ä“¥aû_šode
)

677 
	`bŒfs_lockd•_»Ëa£
(
fs_šfo
, 
bŒfs_Üd”ed_ex‹Á
);

678 
	}
}

680 
	$bŒfs_run_Üd”ed_ex‹Á_wÜk
(
bŒfs_wÜk
 *
wÜk
)

682 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

684 
Üd”ed
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_Üd”ed_ex‹Á
, 
æush_wÜk
);

685 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
Üd”ed
);

686 
	`com¶‘e
(&
Üd”ed
->
com¶‘iÚ
);

687 
	}
}

693 
u64
 
	$bŒfs_wa™_Üd”ed_ex‹Ás
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
Ä
,

694 cÚ¡ 
u64
 
¿nge_¡¬t
, cÚ¡ u64 
¿nge_Ën
)

696 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

697 
	`LIST_HEAD
(
¥liû
);

698 
	`LIST_HEAD
(
sk³d
);

699 
	`LIST_HEAD
(
wÜks
);

700 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
, *
Ãxt
;

701 
u64
 
couÁ
 = 0;

702 cÚ¡ 
u64
 
¿nge_’d
 = 
¿nge_¡¬t
 + 
¿nge_Ën
;

704 
	`mu‹x_lock
(&
roÙ
->
Üd”ed_ex‹Á_mu‹x
);

705 
	`¥š_lock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

706 
	`li¡_¥liû_š™
(&
roÙ
->
Üd”ed_ex‹Ás
, &
¥liû
);

707 !
	`li¡_em±y
(&
¥liû
è&& 
Ä
) {

708 
Üd”ed
 = 
	`li¡_fœ¡_’Œy
(&
¥liû
, 
bŒfs_Üd”ed_ex‹Á
,

709 
roÙ_ex‹Á_li¡
);

711 ià(
¿nge_’d
 <ğ
Üd”ed
->
disk_by‹Ä
 ||

712 
Üd”ed
->
disk_by‹Ä
 + ord”ed->
disk_num_by‹s
 <ğ
¿nge_¡¬t
) {

713 
	`li¡_move_
(&
Üd”ed
->
roÙ_ex‹Á_li¡
, &
sk³d
);

714 
	`cÚd_»sched_lock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

718 
	`li¡_move_
(&
Üd”ed
->
roÙ_ex‹Á_li¡
,

719 &
roÙ
->
Üd”ed_ex‹Ás
);

720 
	`»fcouÁ_šc
(&
Üd”ed
->
»fs
);

721 
	`¥š_uÆock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

723 
	`bŒfs_š™_wÜk
(&
Üd”ed
->
æush_wÜk
,

724 
bŒfs_run_Üd”ed_ex‹Á_wÜk
, 
NULL
, NULL);

725 
	`li¡_add_
(&
Üd”ed
->
wÜk_li¡
, &
wÜks
);

726 
	`bŒfs_queue_wÜk
(
fs_šfo
->
æush_wÜk”s
, &
Üd”ed
->
æush_wÜk
);

728 
	`cÚd_»sched
();

729 
	`¥š_lock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

730 ià(
Ä
 !ğ
U64_MAX
)

731 
Ä
--;

732 
couÁ
++;

734 
	`li¡_¥liû_
(&
sk³d
, &
roÙ
->
Üd”ed_ex‹Ás
);

735 
	`li¡_¥liû_
(&
¥liû
, &
roÙ
->
Üd”ed_ex‹Ás
);

736 
	`¥š_uÆock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

738 
	`li¡_fÜ_—ch_’Œy_§ã
(
Üd”ed
, 
Ãxt
, &
wÜks
, 
wÜk_li¡
) {

739 
	`li¡_d–_š™
(&
Üd”ed
->
wÜk_li¡
);

740 
	`wa™_fÜ_com¶‘iÚ
(&
Üd”ed
->
com¶‘iÚ
);

741 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

742 
	`cÚd_»sched
();

744 
	`mu‹x_uÆock
(&
roÙ
->
Üd”ed_ex‹Á_mu‹x
);

746  
couÁ
;

747 
	}
}

749 
	$bŒfs_wa™_Üd”ed_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
Ä
,

750 cÚ¡ 
u64
 
¿nge_¡¬t
, cÚ¡ u64 
¿nge_Ën
)

752 
bŒfs_roÙ
 *
roÙ
;

753 
	`LIST_HEAD
(
¥liû
);

754 
u64
 
dÚe
;

756 
	`mu‹x_lock
(&
fs_šfo
->
Üd”ed_İ”©iÚs_mu‹x
);

757 
	`¥š_lock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

758 
	`li¡_¥liû_š™
(&
fs_šfo
->
Üd”ed_roÙs
, &
¥liû
);

759 !
	`li¡_em±y
(&
¥liû
è&& 
Ä
) {

760 
roÙ
 = 
	`li¡_fœ¡_’Œy
(&
¥liû
, 
bŒfs_roÙ
,

761 
Üd”ed_roÙ
);

762 
roÙ
 = 
	`bŒfs_g¿b_roÙ
(root);

763 
	`BUG_ON
(!
roÙ
);

764 
	`li¡_move_
(&
roÙ
->
Üd”ed_roÙ
,

765 &
fs_šfo
->
Üd”ed_roÙs
);

766 
	`¥š_uÆock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

768 
dÚe
 = 
	`bŒfs_wa™_Üd”ed_ex‹Ás
(
roÙ
, 
Ä
,

769 
¿nge_¡¬t
, 
¿nge_Ën
);

770 
	`bŒfs_put_roÙ
(
roÙ
);

772 
	`¥š_lock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

773 ià(
Ä
 !ğ
U64_MAX
) {

774 
Ä
 -ğ
dÚe
;

777 
	`li¡_¥liû_
(&
¥liû
, &
fs_šfo
->
Üd”ed_roÙs
);

778 
	`¥š_uÆock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

779 
	`mu‹x_uÆock
(&
fs_šfo
->
Üd”ed_İ”©iÚs_mu‹x
);

780 
	}
}

788 
	$bŒfs_¡¬t_Üd”ed_ex‹Á
(
bŒfs_Üd”ed_ex‹Á
 *
’Œy
)

790 
u64
 
¡¬t
 = 
’Œy
->
fe_off£t
;

791 
u64
 
’d
 = 
¡¬t
 + 
’Œy
->
num_by‹s
 - 1;

792 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
’Œy
->inode);

793 
boŞ
 
ä“¥aû_šode
;

795 
	`Œaû_bŒfs_Üd”ed_ex‹Á_¡¬t
(
šode
, 
’Œy
);

801 
ä“¥aû_šode
 = 
	`bŒfs_is_ä“_¥aû_šode
(
šode
);

808 ià(!
	`‹¡_b™
(
BTRFS_ORDERED_DIRECT
, &
’Œy
->
æags
))

809 
	`fem­_fd©awr™e_¿nge
(
šode
->
vfs_šode
.
i_m­pšg
, 
¡¬t
, 
’d
);

811 ià(!
ä“¥aû_šode
)

812 
	`bŒfs_might_wa™_fÜ_ev’t
(
šode
->
roÙ
->
fs_šfo
, 
bŒfs_Üd”ed_ex‹Á
);

813 
	`wa™_ev’t
(
’Œy
->
wa™
, 
	`‹¡_b™
(
BTRFS_ORDERED_COMPLETE
, &’Œy->
æags
));

814 
	}
}

819 
	$bŒfs_wa™_Üd”ed_¿nge
(
šode
 *šode, 
u64
 
¡¬t
, u64 
Ën
)

821 
»t
 = 0;

822 
»t_wb
 = 0;

823 
u64
 
’d
;

824 
u64
 
Üig_’d
;

825 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

827 ià(
¡¬t
 + 
Ën
 < start) {

828 
Üig_’d
 = 
OFFSET_MAX
;

830 
Üig_’d
 = 
¡¬t
 + 
Ën
 - 1;

831 ià(
Üig_’d
 > 
OFFSET_MAX
)

832 
Üig_’d
 = 
OFFSET_MAX
;

838 
»t
 = 
	`bŒfs_fd©awr™e_¿nge
(
šode
, 
¡¬t
, 
Üig_’d
);

839 ià(
»t
)

840  
»t
;

849 
»t_wb
 = 
	`fem­_fd©awa™_¿nge
(
šode
->
i_m­pšg
, 
¡¬t
, 
Üig_’d
);

851 
’d
 = 
Üig_’d
;

853 
Üd”ed
 = 
	`bŒfs_lookup_fœ¡_Üd”ed_ex‹Á
(
	`BTRFS_I
(
šode
), 
’d
);

854 ià(!
Üd”ed
)

856 ià(
Üd”ed
->
fe_off£t
 > 
Üig_’d
) {

857 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

860 ià(
Üd”ed
->
fe_off£t
 + ord”ed->
num_by‹s
 <ğ
¡¬t
) {

861 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

864 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
Üd”ed
);

865 
’d
 = 
Üd”ed
->
fe_off£t
;

871 ià(
	`‹¡_b™
(
BTRFS_ORDERED_IOERR
, &
Üd”ed
->
æags
))

872 
»t
 = -
EIO
;

873 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

874 ià(
’d
 =ğ0 ||ƒnd =ğ
¡¬t
)

876 
’d
--;

878  
»t_wb
 ?„‘_wb : 
»t
;

879 
	}
}

885 
bŒfs_Üd”ed_ex‹Á
 *
	$bŒfs_lookup_Üd”ed_ex‹Á
(
bŒfs_šode
 *
šode
,

886 
u64
 
fe_off£t
)

888 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
;

889 
rb_node
 *
node
;

890 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
 = 
NULL
;

891 
æags
;

893 
Œ“
 = &
šode
->
Üd”ed_Œ“
;

894 
	`¥š_lock_œq§ve
(&
Œ“
->
lock
, 
æags
);

895 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
fe_off£t
);

896 ià(!
node
)

897 
out
;

899 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

900 ià(!
	`š_¿nge
(
fe_off£t
, 
’Œy
->fe_off£t,ƒÁry->
num_by‹s
))

901 
’Œy
 = 
NULL
;

902 ià(
’Œy
) {

903 
	`»fcouÁ_šc
(&
’Œy
->
»fs
);

904 
	`Œaû_bŒfs_Üd”ed_ex‹Á_lookup
(
šode
, 
’Œy
);

906 
out
:

907 
	`¥š_uÆock_œq»¡Üe
(&
Œ“
->
lock
, 
æags
);

908  
’Œy
;

909 
	}
}

914 
bŒfs_Üd”ed_ex‹Á
 *
	$bŒfs_lookup_Üd”ed_¿nge
(

915 
bŒfs_šode
 *
šode
, 
u64
 
fe_off£t
, u64 
Ën
)

917 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
;

918 
rb_node
 *
node
;

919 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
 = 
NULL
;

921 
Œ“
 = &
šode
->
Üd”ed_Œ“
;

922 
	`¥š_lock_œq
(&
Œ“
->
lock
);

923 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
fe_off£t
);

924 ià(!
node
) {

925 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
fe_off£t
 + 
Ën
);

926 ià(!
node
)

927 
out
;

931 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

932 ià(
	`¿nge_ov”Ïps
(
’Œy
, 
fe_off£t
, 
Ën
))

935 ià(
’Œy
->
fe_off£t
 >ğfe_off£ˆ+ 
Ën
) {

936 
’Œy
 = 
NULL
;

939 
’Œy
 = 
NULL
;

940 
node
 = 
	`rb_Ãxt
(node);

941 ià(!
node
)

944 
out
:

945 ià(
’Œy
) {

946 
	`»fcouÁ_šc
(&
’Œy
->
»fs
);

947 
	`Œaû_bŒfs_Üd”ed_ex‹Á_lookup_¿nge
(
šode
, 
’Œy
);

949 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

950  
’Œy
;

951 
	}
}

957 
	$bŒfs_g‘_Üd”ed_ex‹Ás_fÜ_loggšg
(
bŒfs_šode
 *
šode
,

958 
li¡_h—d
 *
li¡
)

960 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
 = &
šode
->
Üd”ed_Œ“
;

961 
rb_node
 *
n
;

963 
	`ASSERT
(
	`šode_is_locked
(&
šode
->
vfs_šode
));

965 
	`¥š_lock_œq
(&
Œ“
->
lock
);

966 
n
 = 
	`rb_fœ¡
(&
Œ“
->Œ“);‚;‚ = 
	`rb_Ãxt
(n)) {

967 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

969 
Üd”ed
 = 
	`rb_’Œy
(
n
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

971 ià(
	`‹¡_b™
(
BTRFS_ORDERED_LOGGED
, &
Üd”ed
->
æags
))

974 
	`ASSERT
(
	`li¡_em±y
(&
Üd”ed
->
log_li¡
));

975 
	`li¡_add_
(&
Üd”ed
->
log_li¡
, 
li¡
);

976 
	`»fcouÁ_šc
(&
Üd”ed
->
»fs
);

977 
	`Œaû_bŒfs_Üd”ed_ex‹Á_lookup_fÜ_loggšg
(
šode
, 
Üd”ed
);

979 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

980 
	}
}

986 
bŒfs_Üd”ed_ex‹Á
 *

987 
	$bŒfs_lookup_fœ¡_Üd”ed_ex‹Á
(
bŒfs_šode
 *
šode
, 
u64
 
fe_off£t
)

989 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
;

990 
rb_node
 *
node
;

991 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
 = 
NULL
;

993 
Œ“
 = &
šode
->
Üd”ed_Œ“
;

994 
	`¥š_lock_œq
(&
Œ“
->
lock
);

995 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
fe_off£t
);

996 ià(!
node
)

997 
out
;

999 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

1000 
	`»fcouÁ_šc
(&
’Œy
->
»fs
);

1001 
	`Œaû_bŒfs_Üd”ed_ex‹Á_lookup_fœ¡
(
šode
, 
’Œy
);

1002 
out
:

1003 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

1004  
’Œy
;

1005 
	}
}

1016 
bŒfs_Üd”ed_ex‹Á
 *
	$bŒfs_lookup_fœ¡_Üd”ed_¿nge
(

1017 
bŒfs_šode
 *
šode
, 
u64
 
fe_off£t
, u64 
Ën
)

1019 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
 = &
šode
->
Üd”ed_Œ“
;

1020 
rb_node
 *
node
;

1021 
rb_node
 *
cur
;

1022 
rb_node
 *
´ev
;

1023 
rb_node
 *
Ãxt
;

1024 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
 = 
NULL
;

1026 
	`¥š_lock_œq
(&
Œ“
->
lock
);

1027 
node
 = 
Œ“
->Œ“.
rb_node
;

1034 
node
) {

1035 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

1037 ià(
fe_off£t
 < 
’Œy
->file_offset) {

1038 
node
 =‚ode->
rb_Ëá
;

1039 } ià(
fe_off£t
 >ğ
	`’Œy_’d
(
’Œy
)) {

1040 
node
 =‚ode->
rb_right
;

1046 
out
;

1049 ià(!
’Œy
) {

1051 
out
;

1054 
cur
 = &
’Œy
->
rb_node
;

1056 ià(
’Œy
->
fe_off£t
 < file_offset) {

1057 
´ev
 = 
cur
;

1058 
Ãxt
 = 
	`rb_Ãxt
(
cur
);

1060 
´ev
 = 
	`rb_´ev
(
cur
);

1061 
Ãxt
 = 
cur
;

1063 ià(
´ev
) {

1064 
’Œy
 = 
	`rb_’Œy
(
´ev
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

1065 ià(
	`¿nge_ov”Ïps
(
’Œy
, 
fe_off£t
, 
Ën
))

1066 
out
;

1068 ià(
Ãxt
) {

1069 
’Œy
 = 
	`rb_’Œy
(
Ãxt
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

1070 ià(
	`¿nge_ov”Ïps
(
’Œy
, 
fe_off£t
, 
Ën
))

1071 
out
;

1074 
’Œy
 = 
NULL
;

1075 
out
:

1076 ià(
’Œy
) {

1077 
	`»fcouÁ_šc
(&
’Œy
->
»fs
);

1078 
	`Œaû_bŒfs_Üd”ed_ex‹Á_lookup_fœ¡_¿nge
(
šode
, 
’Œy
);

1081 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

1082  
’Œy
;

1083 
	}
}

1099 
	$bŒfs_lock_ªd_æush_Üd”ed_¿nge
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
,

1100 
u64
 
’d
,

1101 
ex‹Á_¡©e
 **
ÿched_¡©e
)

1103 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

1104 
ex‹Á_¡©e
 *
ÿche
 = 
NULL
;

1105 
ex‹Á_¡©e
 **
ÿchedp
 = &
ÿche
;

1107 ià(
ÿched_¡©e
)

1108 
ÿchedp
 = 
ÿched_¡©e
;

1111 
	`lock_ex‹Á
(&
šode
->
io_Œ“
, 
¡¬t
, 
’d
, 
ÿchedp
);

1112 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
šode
, 
¡¬t
,

1113 
’d
 - 
¡¬t
 + 1);

1114 ià(!
Üd”ed
) {

1120 ià(!
ÿched_¡©e
)

1121 
	`»fcouÁ_dec
(&
ÿche
->
»fs
);

1124 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
¡¬t
, 
’d
, 
ÿchedp
);

1125 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
Üd”ed
);

1126 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

1128 
	}
}

1137 
boŞ
 
	$bŒfs_Œy_lock_Üd”ed_¿nge
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
,

1138 
ex‹Á_¡©e
 **
ÿched_¡©e
)

1140 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

1142 ià(!
	`Œy_lock_ex‹Á
(&
šode
->
io_Œ“
, 
¡¬t
, 
’d
, 
ÿched_¡©e
))

1143  
çl£
;

1145 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
šode
, 
¡¬t
, 
’d
 - start + 1);

1146 ià(!
Üd”ed
)

1147  
Œue
;

1149 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

1150 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
¡¬t
, 
’d
, 
ÿched_¡©e
);

1152  
çl£
;

1153 
	}
}

1156 
bŒfs_Üd”ed_ex‹Á
 *
	$bŒfs_¥l™_Üd”ed_ex‹Á
(

1157 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
, 
u64
 
Ën
)

1159 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
Üd”ed
->inode);

1160 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
 = &
šode
->
Üd”ed_Œ“
;

1161 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

1162 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1163 
u64
 
fe_off£t
 = 
Üd”ed
->file_offset;

1164 
u64
 
disk_by‹Ä
 = 
Üd”ed
->disk_bytenr;

1165 
æags
 = 
Üd”ed
->flags;

1166 
bŒfs_Üd”ed_sum
 *
sum
, *
tmpsum
;

1167 
bŒfs_Üd”ed_ex‹Á
 *
Ãw
;

1168 
rb_node
 *
node
;

1169 
u64
 
off£t
 = 0;

1171 
	`Œaû_bŒfs_Üd”ed_ex‹Á_¥l™
(
šode
, 
Üd”ed
);

1173 
	`ASSERT
(!(
æags
 & (1U << 
BTRFS_ORDERED_COMPRESSED
)));

1179 ià(
	`WARN_ON_ONCE
(
Ën
 >ğ
Üd”ed
->
num_by‹s
))

1180  
	`ERR_PTR
(-
EINVAL
);

1182 ià(
Üd”ed
->
by‹s_Ëá
) {

1183 
	`ASSERT
(!(
æags
 & ~
BTRFS_ORDERED_TYPE_FLAGS
));

1184 ià(
	`WARN_ON_ONCE
(
Üd”ed
->
by‹s_Ëá
 !ğÜd”ed->
disk_num_by‹s
))

1185  
	`ERR_PTR
(-
EINVAL
);

1188 ià(
	`WARN_ON_ONCE
(
Üd”ed
->
disk_num_by‹s
 !ğÜd”ed->
num_by‹s
))

1189  
	`ERR_PTR
(-
EINVAL
);

1191 
Ãw
 = 
	`®loc_Üd”ed_ex‹Á
(
šode
, 
fe_off£t
, 
Ën
,†’, 
disk_by‹Ä
,

1192 
Ën
, 0, 
æags
, 
Üd”ed
->
com´ess_ty³
);

1193 ià(
	`IS_ERR
(
Ãw
))

1194  
Ãw
;

1197 
	`»fcouÁ_šc
(&
Ãw
->
»fs
);

1199 
	`¥š_lock_œq
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

1200 
	`¥š_lock
(&
Œ“
->
lock
);

1202 
node
 = &
Üd”ed
->
rb_node
;

1203 
	`rb_”a£
(
node
, &
Œ“
->tree);

1204 
	`RB_CLEAR_NODE
(
node
);

1205 ià(
Œ“
->
Ï¡
 =ğ
node
)

1206 
Œ“
->
Ï¡
 = 
NULL
;

1208 
Üd”ed
->
fe_off£t
 +ğ
Ën
;

1209 
Üd”ed
->
disk_by‹Ä
 +ğ
Ën
;

1210 
Üd”ed
->
num_by‹s
 -ğ
Ën
;

1211 
Üd”ed
->
disk_num_by‹s
 -ğ
Ën
;

1213 ià(
	`‹¡_b™
(
BTRFS_ORDERED_IO_DONE
, &
Üd”ed
->
æags
)) {

1214 
	`ASSERT
(
Üd”ed
->
by‹s_Ëá
 == 0);

1215 
Ãw
->
by‹s_Ëá
 = 0;

1217 
Üd”ed
->
by‹s_Ëá
 -ğ
Ën
;

1220 ià(
	`‹¡_b™
(
BTRFS_ORDERED_TRUNCATED
, &
Üd”ed
->
æags
)) {

1221 ià(
Üd”ed
->
Œunÿ‹d_Ën
 > 
Ën
) {

1222 
Üd”ed
->
Œunÿ‹d_Ën
 -ğ
Ën
;

1224 
Ãw
->
Œunÿ‹d_Ën
 = 
Üd”ed
->truncated_len;

1225 
Üd”ed
->
Œunÿ‹d_Ën
 = 0;

1229 
	`li¡_fÜ_—ch_’Œy_§ã
(
sum
, 
tmpsum
, &
Üd”ed
->
li¡
,†ist) {

1230 ià(
off£t
 =ğ
Ën
)

1232 
	`li¡_move_
(&
sum
->
li¡
, &
Ãw
->list);

1233 
off£t
 +ğ
sum
->
Ën
;

1237 
node
 = 
	`Œ“_š£¹
(&
Œ“
->Œ“, 
Üd”ed
->
fe_off£t
, &Üd”ed->
rb_node
);

1238 ià(
node
)

1239 
	`bŒfs_·nic
(
fs_šfo
, -
EEXIST
,

1241 
Üd”ed
->
fe_off£t
);

1243 
node
 = 
	`Œ“_š£¹
(&
Œ“
->Œ“, 
Ãw
->
fe_off£t
, &Ãw->
rb_node
);

1244 ià(
node
)

1245 
	`bŒfs_·nic
(
fs_šfo
, -
EEXIST
,

1247 
Ãw
->
fe_off£t
);

1248 
	`¥š_uÆock
(&
Œ“
->
lock
);

1250 
	`li¡_add_
(&
Ãw
->
roÙ_ex‹Á_li¡
, &
roÙ
->
Üd”ed_ex‹Ás
);

1251 
roÙ
->
Ä_Üd”ed_ex‹Ás
++;

1252 
	`¥š_uÆock_œq
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

1253  
Ãw
;

1254 
	}
}

1256 
__š™
 
	$Üd”ed_d©a_š™
()

1258 
bŒfs_Üd”ed_ex‹Á_ÿche
 = 
	`kmem_ÿche_ü—‹
("btrfs_ordered_extent",

1259 (
bŒfs_Üd”ed_ex‹Á
), 0,

1260 
SLAB_MEM_SPREAD
,

1261 
NULL
);

1262 ià(!
bŒfs_Üd”ed_ex‹Á_ÿche
)

1263  -
ENOMEM
;

1266 
	}
}

1268 
__cŞd
 
	$Üd”ed_d©a_ex™
()

1270 
	`kmem_ÿche_de¡roy
(
bŒfs_Üd”ed_ex‹Á_ÿche
);

1271 
	}
}

	@ordered-data.h

6 #iâdeà
BTRFS_ORDERED_DATA_H


7 
	#BTRFS_ORDERED_DATA_H


	)

10 
	sbŒfs_Üd”ed_šode_Œ“
 {

11 
¥šlock_t
 
	mlock
;

12 
rb_roÙ
 
	mŒ“
;

13 
rb_node
 *
	mÏ¡
;

16 
	sbŒfs_Üd”ed_sum
 {

21 
u64
 
	mlogiÿl
;

22 
u32
 
	mËn
;

24 
li¡_h—d
 
	mli¡
;

26 
u8
 
	msums
[];

50 
	mBTRFS_ORDERED_REGULAR
,

51 
	mBTRFS_ORDERED_NOCOW
,

52 
	mBTRFS_ORDERED_PREALLOC
,

53 
	mBTRFS_ORDERED_COMPRESSED
,

59 
	mBTRFS_ORDERED_DIRECT
,

64 
	mBTRFS_ORDERED_IO_DONE
,

66 
	mBTRFS_ORDERED_COMPLETE
,

68 
	mBTRFS_ORDERED_IOERR
,

70 
	mBTRFS_ORDERED_TRUNCATED
,

72 
	mBTRFS_ORDERED_LOGGED
,

74 
	mBTRFS_ORDERED_LOGGED_CSUM
,

76 
	mBTRFS_ORDERED_PENDING
,

78 
	mBTRFS_ORDERED_ENCODED
,

82 
	#BTRFS_ORDERED_TYPE_FLAGS
 ((1UL << 
BTRFS_ORDERED_REGULAR
) | \

83 (1UL << 
BTRFS_ORDERED_NOCOW
) | \

84 (1UL << 
BTRFS_ORDERED_PREALLOC
) | \

85 (1UL << 
BTRFS_ORDERED_COMPRESSED
) | \

86 (1UL << 
BTRFS_ORDERED_DIRECT
) | \

87 (1UL << 
BTRFS_ORDERED_ENCODED
))

	)

89 
	sbŒfs_Üd”ed_ex‹Á
 {

91 
u64
 
	mfe_off£t
;

97 
u64
 
	mnum_by‹s
;

98 
u64
 
	m¿m_by‹s
;

99 
u64
 
	mdisk_by‹Ä
;

100 
u64
 
	mdisk_num_by‹s
;

101 
u64
 
	moff£t
;

104 
u64
 
	mby‹s_Ëá
;

111 
u64
 
	mout¡ªdšg_isize
;

117 
u64
 
	mŒunÿ‹d_Ën
;

120 
	mæags
;

123 
	mcom´ess_ty³
;

126 
	mqgroup_rsv
;

129 
»fcouÁ_t
 
	m»fs
;

132 
šode
 *
	mšode
;

135 
li¡_h—d
 
	mli¡
;

138 
li¡_h—d
 
	mlog_li¡
;

141 
wa™_queue_h—d_t
 
	mwa™
;

144 
rb_node
 
	mrb_node
;

147 
li¡_h—d
 
	mroÙ_ex‹Á_li¡
;

149 
bŒfs_wÜk
 
	mwÜk
;

151 
com¶‘iÚ
 
	mcom¶‘iÚ
;

152 
bŒfs_wÜk
 
	mæush_wÜk
;

153 
li¡_h—d
 
	mwÜk_li¡
;

156 
šlše
 

157 
	$bŒfs_Üd”ed_šode_Œ“_š™
(
bŒfs_Üd”ed_šode_Œ“
 *
t
)

159 
	`¥š_lock_š™
(&
t
->
lock
);

160 
t
->
Œ“
 = 
RB_ROOT
;

161 
t
->
Ï¡
 = 
NULL
;

162 
	}
}

164 
bŒfs_fšish_Úe_Üd”ed
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed_ex‹Á
);

165 
bŒfs_fšish_Üd”ed_io
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed_ex‹Á
);

167 
bŒfs_put_Üd”ed_ex‹Á
(
bŒfs_Üd”ed_ex‹Á
 *
’Œy
);

168 
bŒfs_»move_Üd”ed_ex‹Á
(
bŒfs_šode
 *btrfs_inode,

169 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
);

170 
boŞ
 
bŒfs_fšish_Üd”ed_ex‹Á
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
,

171 
·ge
 *·ge, 
u64
 
fe_off£t
, u64 
Ën
,

172 
boŞ
 
u±od©e
);

173 
bŒfs_m¬k_Üd”ed_io_fšished
(
bŒfs_šode
 *
šode
,

174 
·ge
 *·ge, 
u64
 
fe_off£t
,

175 
u64
 
num_by‹s
, 
boŞ
 
u±od©e
);

176 
boŞ
 
bŒfs_dec_‹¡_Üd”ed_³ndšg
(
bŒfs_šode
 *
šode
,

177 
bŒfs_Üd”ed_ex‹Á
 **
ÿched
,

178 
u64
 
fe_off£t
, u64 
io_size
);

179 
bŒfs_Üd”ed_ex‹Á
 *
bŒfs_®loc_Üd”ed_ex‹Á
(

180 
bŒfs_šode
 *
šode
, 
u64
 
fe_off£t
,

181 
u64
 
num_by‹s
, u64 
¿m_by‹s
, u64 
disk_by‹Ä
,

182 
u64
 
disk_num_by‹s
, u64 
off£t
, 
æags
,

183 
com´ess_ty³
);

184 
bŒfs_add_Üd”ed_sum
(
bŒfs_Üd”ed_ex‹Á
 *
’Œy
,

185 
bŒfs_Üd”ed_sum
 *
sum
);

186 
bŒfs_Üd”ed_ex‹Á
 *
bŒfs_lookup_Üd”ed_ex‹Á
(
bŒfs_šode
 *
šode
,

187 
u64
 
fe_off£t
);

188 
bŒfs_¡¬t_Üd”ed_ex‹Á
(
bŒfs_Üd”ed_ex‹Á
 *
’Œy
);

189 
bŒfs_wa™_Üd”ed_¿nge
(
šode
 *šode, 
u64
 
¡¬t
, u64 
Ën
);

190 
bŒfs_Üd”ed_ex‹Á
 *

191 
bŒfs_lookup_fœ¡_Üd”ed_ex‹Á
(
bŒfs_šode
 *
šode
, 
u64
 
fe_off£t
);

192 
bŒfs_Üd”ed_ex‹Á
 *
bŒfs_lookup_fœ¡_Üd”ed_¿nge
(

193 
bŒfs_šode
 *
šode
, 
u64
 
fe_off£t
, u64 
Ën
);

194 
bŒfs_Üd”ed_ex‹Á
 *
bŒfs_lookup_Üd”ed_¿nge
(

195 
bŒfs_šode
 *
šode
,

196 
u64
 
fe_off£t
,

197 
u64
 
Ën
);

198 
bŒfs_g‘_Üd”ed_ex‹Ás_fÜ_loggšg
(
bŒfs_šode
 *
šode
,

199 
li¡_h—d
 *
li¡
);

200 
u64
 
bŒfs_wa™_Üd”ed_ex‹Ás
(
bŒfs_roÙ
 *
roÙ
, u64 
Ä
,

201 cÚ¡ 
u64
 
¿nge_¡¬t
, cÚ¡ u64 
¿nge_Ën
);

202 
bŒfs_wa™_Üd”ed_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
Ä
,

203 cÚ¡ 
u64
 
¿nge_¡¬t
, cÚ¡ u64 
¿nge_Ën
);

204 
bŒfs_lock_ªd_æush_Üd”ed_¿nge
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
,

205 
u64
 
’d
,

206 
ex‹Á_¡©e
 **
ÿched_¡©e
);

207 
boŞ
 
bŒfs_Œy_lock_Üd”ed_¿nge
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
,

208 
ex‹Á_¡©e
 **
ÿched_¡©e
);

209 
bŒfs_Üd”ed_ex‹Á
 *
bŒfs_¥l™_Üd”ed_ex‹Á
(

210 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
, 
u64
 
Ën
);

211 
__š™
 
Üd”ed_d©a_š™
();

212 
__cŞd
 
Üd”ed_d©a_ex™
();

	@orphan.c

6 
	~"ù»e.h
"

7 
	~"disk-io.h
"

8 
	~"Üphª.h
"

10 
	$bŒfs_š£¹_Üphª_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

11 
bŒfs_roÙ
 *
roÙ
, 
u64
 
off£t
)

13 
bŒfs_·th
 *
·th
;

14 
bŒfs_key
 
key
;

15 
»t
 = 0;

17 
key
.
objeùid
 = 
BTRFS_ORPHAN_OBJECTID
;

18 
key
.
ty³
 = 
BTRFS_ORPHAN_ITEM_KEY
;

19 
key
.
off£t
 = offset;

21 
·th
 = 
	`bŒfs_®loc_·th
();

22 ià(!
·th
)

23  -
ENOMEM
;

25 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 0);

27 
	`bŒfs_ä“_·th
(
·th
);

28  
»t
;

29 
	}
}

31 
	$bŒfs_d–_Üphª_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

32 
bŒfs_roÙ
 *
roÙ
, 
u64
 
off£t
)

34 
bŒfs_·th
 *
·th
;

35 
bŒfs_key
 
key
;

36 
»t
 = 0;

38 
key
.
objeùid
 = 
BTRFS_ORPHAN_OBJECTID
;

39 
key
.
ty³
 = 
BTRFS_ORPHAN_ITEM_KEY
;

40 
key
.
off£t
 = offset;

42 
·th
 = 
	`bŒfs_®loc_·th
();

43 ià(!
·th
)

44  -
ENOMEM
;

46 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

47 ià(
»t
 < 0)

48 
out
;

49 ià(
»t
) {

50 
»t
 = -
ENOENT
;

51 
out
;

54 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

56 
out
:

57 
	`bŒfs_ä“_·th
(
·th
);

58  
»t
;

59 
	}
}

	@orphan.h

3 #iâdeà
BTRFS_ORPHAN_H


4 
	#BTRFS_ORPHAN_H


	)

6 
bŒfs_š£¹_Üphª_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

7 
bŒfs_roÙ
 *
roÙ
, 
u64
 
off£t
);

8 
bŒfs_d–_Üphª_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

9 
bŒfs_roÙ
 *
roÙ
, 
u64
 
off£t
);

	@print-tree.c

6 
	~"mes§ges.h
"

7 
	~"ù»e.h
"

8 
	~"disk-io.h
"

9 
	~"´št-Œ“.h
"

10 
	~"acûssÜs.h
"

11 
	~"Œ“-check”.h
"

13 
	sroÙ_Çme_m­
 {

14 
u64
 
	mid
;

15 
	mÇme
[16];

18 cÚ¡ 
roÙ_Çme_m­
 
	groÙ_m­
[] = {

19 { 
BTRFS_ROOT_TREE_OBJECTID
, "ROOT_TREE" },

20 { 
BTRFS_EXTENT_TREE_OBJECTID
, "EXTENT_TREE" },

21 { 
BTRFS_CHUNK_TREE_OBJECTID
, "CHUNK_TREE" },

22 { 
BTRFS_DEV_TREE_OBJECTID
, "DEV_TREE" },

23 { 
BTRFS_FS_TREE_OBJECTID
, "FS_TREE" },

24 { 
BTRFS_CSUM_TREE_OBJECTID
, "CSUM_TREE" },

25 { 
BTRFS_TREE_LOG_OBJECTID
, "TREE_LOG" },

26 { 
BTRFS_QUOTA_TREE_OBJECTID
, "QUOTA_TREE" },

27 { 
BTRFS_UUID_TREE_OBJECTID
, "UUID_TREE" },

28 { 
BTRFS_FREE_SPACE_TREE_OBJECTID
, "FREE_SPACE_TREE" },

29 { 
BTRFS_BLOCK_GROUP_TREE_OBJECTID
, "BLOCK_GROUP_TREE" },

30 { 
BTRFS_DATA_RELOC_TREE_OBJECTID
, "DATA_RELOC_TREE" },

33 cÚ¡ *
	$bŒfs_roÙ_Çme
(cÚ¡ 
bŒfs_key
 *
key
, *
buf
)

35 
i
;

37 ià(
key
->
objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
) {

38 
	`¢´štf
(
buf
, 
BTRFS_ROOT_NAME_BUF_LEN
,

39 "TREE_RELOC off£t=%Îu", 
key
->
off£t
);

40  
buf
;

43 
i
 = 0; i < 
	`ARRAY_SIZE
(
roÙ_m­
); i++) {

44 ià(
roÙ_m­
[
i
].
id
 =ğ
key
->
objeùid
)

45  
roÙ_m­
[
i
].
Çme
;

48 
	`¢´štf
(
buf
, 
BTRFS_ROOT_NAME_BUF_LEN
, "%Îu", 
key
->
objeùid
);

49  
buf
;

50 
	}
}

52 
	$´št_chunk
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
bŒfs_chunk
 *
chunk
)

54 
num_¡res
 = 
	`bŒfs_chunk_num_¡res
(
eb
, 
chunk
);

55 
i
;

56 
	`´_šfo
("\t\tchunk†ength %llu owner %lluype %llu‚um_stripes %d\n",

57 
	`bŒfs_chunk_Ëngth
(
eb
, 
chunk
), 
	`bŒfs_chunk_owÃr
(eb, chunk),

58 
	`bŒfs_chunk_ty³
(
eb
, 
chunk
), 
num_¡res
);

59 
i
 = 0 ; i < 
num_¡res
 ; i++) {

60 
	`´_šfo
("\t\t\t¡r%d devid %Îu off£ˆ%Îu\n", 
i
,

61 
	`bŒfs_¡re_devid_Ä
(
eb
, 
chunk
, 
i
),

62 
	`bŒfs_¡re_off£t_Ä
(
eb
, 
chunk
, 
i
));

64 
	}
}

65 
	$´št_dev_™em
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

66 
bŒfs_dev_™em
 *
dev_™em
)

68 
	`´_šfo
("\t\tdev item devid %lluotal_bytes %llu bytes used %llu\n",

69 
	`bŒfs_deviû_id
(
eb
, 
dev_™em
),

70 
	`bŒfs_deviû_tÙ®_by‹s
(
eb
, 
dev_™em
),

71 
	`bŒfs_deviû_by‹s_u£d
(
eb
, 
dev_™em
));

72 
	}
}

73 
	$´št_ex‹Á_d©a_»f
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

74 
bŒfs_ex‹Á_d©a_»f
 *
»f
)

76 
	`´_cÚt
("extent data backref„oot %llu objectid %llu offset %llu count %u\n",

77 
	`bŒfs_ex‹Á_d©a_»f_roÙ
(
eb
, 
»f
),

78 
	`bŒfs_ex‹Á_d©a_»f_objeùid
(
eb
, 
»f
),

79 
	`bŒfs_ex‹Á_d©a_»f_off£t
(
eb
, 
»f
),

80 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
eb
, 
»f
));

81 
	}
}

83 
	$´št_ex‹Á_™em
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
¦Ù
, 
ty³
)

85 
bŒfs_ex‹Á_™em
 *
ei
;

86 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

87 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

88 
bŒfs_sh¬ed_d©a_»f
 *
¤ef
;

89 
bŒfs_disk_key
 
key
;

90 
’d
;

91 
±r
;

92 
u32
 
™em_size
 = 
	`bŒfs_™em_size
(
eb
, 
¦Ù
);

93 
u64
 
æags
;

94 
u64
 
off£t
;

95 
»f_šdex
 = 0;

97 ià(
	`uÆik–y
(
™em_size
 < (*
ei
))) {

98 
	`bŒfs_”r
(
eb
->
fs_šfo
,

100 
™em_size
, (*
ei
));

101 
	`bŒfs_hªdË_fs_”rÜ
(
eb
->
fs_šfo
, -
EUCLEAN
, 
NULL
);

104 
ei
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_ex‹Á_™em
);

105 
æags
 = 
	`bŒfs_ex‹Á_æags
(
eb
, 
ei
);

107 
	`´_šfo
("\t\textent„efs %llu gen %llu flags %llu\n",

108 
	`bŒfs_ex‹Á_»fs
(
eb
, 
ei
), 
	`bŒfs_ex‹Á_g’”©iÚ
(eb,ƒi),

109 
æags
);

111 ià((
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
) &&

112 
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

113 
bŒfs_Œ“_block_šfo
 *
šfo
;

114 
šfo
 = (
bŒfs_Œ“_block_šfo
 *)(
ei
 + 1);

115 
	`bŒfs_Œ“_block_key
(
eb
, 
šfo
, &
key
);

116 
	`´_šfo
("\t\ttree block key (%llu %u %llu)†evel %d\n",

117 
	`bŒfs_disk_key_objeùid
(&
key
), key.
ty³
,

118 
	`bŒfs_disk_key_off£t
(&
key
),

119 
	`bŒfs_Œ“_block_Ëv–
(
eb
, 
šfo
));

120 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
šfo
 + 1);

122 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
ei
 + 1);

125 
±r
 = ()
œef
;

126 
’d
 = ()
ei
 + 
™em_size
;

127 
±r
 < 
’d
) {

128 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)
±r
;

129 
ty³
 = 
	`bŒfs_ex‹Á_šlše_»f_ty³
(
eb
, 
œef
);

130 
off£t
 = 
	`bŒfs_ex‹Á_šlše_»f_off£t
(
eb
, 
œef
);

131 
	`´_šfo
("\t\Œef#%d: ", 
»f_šdex
++);

132 
ty³
) {

133 
BTRFS_TREE_BLOCK_REF_KEY
:

134 
	`´_cÚt
("Œ“ block back»àroÙ %Îu\n", 
off£t
);

136 
BTRFS_SHARED_BLOCK_REF_KEY
:

137 
	`´_cÚt
("sh¬ed block back»à·»Á %Îu\n", 
off£t
);

142 ià(!
	`IS_ALIGNED
(
off£t
, 
eb
->
fs_šfo
->
£ùÜsize
))

143 
	`´_šfo
(

145 
off£t
, 
eb
->
fs_šfo
->
£ùÜsize
);

147 
BTRFS_EXTENT_DATA_REF_KEY
:

148 
d»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

149 
	`´št_ex‹Á_d©a_»f
(
eb
, 
d»f
);

151 
BTRFS_SHARED_DATA_REF_KEY
:

152 
¤ef
 = (
bŒfs_sh¬ed_d©a_»f
 *)(
œef
 + 1);

153 
	`´_cÚt
("shared data backref…arent %llu count %u\n",

154 
off£t
, 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
eb
, 
¤ef
));

159 ià(!
	`IS_ALIGNED
(
off£t
, 
eb
->
fs_šfo
->
£ùÜsize
))

160 
	`´_šfo
(

162 
off£t
, 
eb
->
fs_šfo
->
£ùÜsize
);

165 
	`´_cÚt
("(extent %llu has INVALID„efype %d)\n",

166 
eb
->
¡¬t
, 
ty³
);

169 
±r
 +ğ
	`bŒfs_ex‹Á_šlše_»f_size
(
ty³
);

171 
	`WARN_ON
(
±r
 > 
’d
);

172 
	}
}

174 
	$´št_uuid_™em
(cÚ¡ 
ex‹Á_bufãr
 *
l
, 
off£t
,

175 
u32
 
™em_size
)

177 ià(!
	`IS_ALIGNED
(
™em_size
, (
u64
))) {

178 
	`´_w¬n
("BTRFS: uuid item with illegal size %lu!\n",

179 ()
™em_size
);

182 
™em_size
) {

183 
__Ë64
 
subvŞ_id
;

185 
	`»ad_ex‹Á_bufãr
(
l
, &
subvŞ_id
, 
off£t
, (subvol_id));

186 
	`´_šfo
("\t\tsubvŞ_id %Îu\n", 
	`Ë64_to_ıu
(
subvŞ_id
));

187 
™em_size
 -ğ(
u64
);

188 
off£t
 +ğ(
u64
);

190 
	}
}

196 
	$´št_eb_»fs_lock
(cÚ¡ 
ex‹Á_bufãr
 *
eb
)

198 #ifdeà
CONFIG_BTRFS_DEBUG


199 
	`bŒfs_šfo
(
eb
->
fs_šfo
, "refs %u†ock_owner %u current %u",

200 
	`©omic_»ad
(&
eb
->
»fs
),ƒb->
lock_owÃr
, 
cu¼’t
->
pid
);

202 
	}
}

204 
	$bŒfs_´št_Ëaf
(cÚ¡ 
ex‹Á_bufãr
 *
l
)

206 
bŒfs_fs_šfo
 *
fs_šfo
;

207 
i
;

208 
u32
 
ty³
, 
Ä
;

209 
bŒfs_roÙ_™em
 *
ri
;

210 
bŒfs_dœ_™em
 *
di
;

211 
bŒfs_šode_™em
 *
ii
;

212 
bŒfs_block_group_™em
 *
bi
;

213 
bŒfs_fe_ex‹Á_™em
 *
fi
;

214 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

215 
bŒfs_sh¬ed_d©a_»f
 *
¤ef
;

216 
bŒfs_dev_ex‹Á
 *
dev_ex‹Á
;

217 
bŒfs_key
 
key
;

218 
bŒfs_key
 
found_key
;

220 ià(!
l
)

223 
fs_šfo
 = 
l
->fs_info;

224 
Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
l
);

226 
	`bŒfs_šfo
(
fs_šfo
,

228 
	`bŒfs_h—d”_by‹Ä
(
l
), 
	`bŒfs_h—d”_g’”©iÚ
Ö), 
Ä
,

229 
	`bŒfs_Ëaf_ä“_¥aû
(
l
), 
	`bŒfs_h—d”_owÃr
(l));

230 
	`´št_eb_»fs_lock
(
l
);

231 
i
 = 0 ; i < 
Ä
 ; i++) {

232 
	`bŒfs_™em_key_to_ıu
(
l
, &
key
, 
i
);

233 
ty³
 = 
key
.type;

234 
	`´_šfo
("\titem %d key (%llu %u %llu) itemoff %d itemsize %d\n",

235 
i
, 
key
.
objeùid
, 
ty³
, key.
off£t
,

236 
	`bŒfs_™em_off£t
(
l
, 
i
), 
	`bŒfs_™em_size
(l, i));

237 
ty³
) {

238 
BTRFS_INODE_ITEM_KEY
:

239 
ii
 = 
	`bŒfs_™em_±r
(
l
, 
i
, 
bŒfs_šode_™em
);

240 
	`´_šfo
("\t\tinode generation %llu size %llu mode %o\n",

241 
	`bŒfs_šode_g’”©iÚ
(
l
, 
ii
),

242 
	`bŒfs_šode_size
(
l
, 
ii
),

243 
	`bŒfs_šode_mode
(
l
, 
ii
));

245 
BTRFS_DIR_ITEM_KEY
:

246 
di
 = 
	`bŒfs_™em_±r
(
l
, 
i
, 
bŒfs_dœ_™em
);

247 
	`bŒfs_dœ_™em_key_to_ıu
(
l
, 
di
, &
found_key
);

248 
	`´_šfo
("\t\tdir oid %llu flags %u\n",

249 
found_key
.
objeùid
,

250 
	`bŒfs_dœ_æags
(
l
, 
di
));

252 
BTRFS_ROOT_ITEM_KEY
:

253 
ri
 = 
	`bŒfs_™em_±r
(
l
, 
i
, 
bŒfs_roÙ_™em
);

254 
	`´_šfo
("\t\troot data bytenr %llu„efs %u\n",

255 
	`bŒfs_disk_roÙ_by‹Ä
(
l
, 
ri
),

256 
	`bŒfs_disk_roÙ_»fs
(
l
, 
ri
));

258 
BTRFS_EXTENT_ITEM_KEY
:

259 
BTRFS_METADATA_ITEM_KEY
:

260 
	`´št_ex‹Á_™em
(
l
, 
i
, 
ty³
);

262 
BTRFS_TREE_BLOCK_REF_KEY
:

263 
	`´_šfo
("\t\ttree block backref\n");

265 
BTRFS_SHARED_BLOCK_REF_KEY
:

266 
	`´_šfo
("\t\tshared block backref\n");

268 
BTRFS_EXTENT_DATA_REF_KEY
:

269 
d»f
 = 
	`bŒfs_™em_±r
(
l
, 
i
,

270 
bŒfs_ex‹Á_d©a_»f
);

271 
	`´št_ex‹Á_d©a_»f
(
l
, 
d»f
);

273 
BTRFS_SHARED_DATA_REF_KEY
:

274 
¤ef
 = 
	`bŒfs_™em_±r
(
l
, 
i
,

275 
bŒfs_sh¬ed_d©a_»f
);

276 
	`´_šfo
("\t\tshared data backref count %u\n",

277 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
l
, 
¤ef
));

279 
BTRFS_EXTENT_DATA_KEY
:

280 
fi
 = 
	`bŒfs_™em_±r
(
l
, 
i
,

281 
bŒfs_fe_ex‹Á_™em
);

282 ià(
	`bŒfs_fe_ex‹Á_ty³
(
l
, 
fi
) ==

283 
BTRFS_FILE_EXTENT_INLINE
) {

284 
	`´_šfo
("\t\tinlineƒxtent data size %llu\n",

285 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
l
, 
fi
));

288 
	`´_šfo
("\t\textent data disk bytenr %llu‚r %llu\n",

289 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
l
, 
fi
),

290 
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
l
, 
fi
));

291 
	`´_šfo
("\t\textent data offset %llu‚r %llu„am %llu\n",

292 
	`bŒfs_fe_ex‹Á_off£t
(
l
, 
fi
),

293 
	`bŒfs_fe_ex‹Á_num_by‹s
(
l
, 
fi
),

294 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
l
, 
fi
));

296 
BTRFS_BLOCK_GROUP_ITEM_KEY
:

297 
bi
 = 
	`bŒfs_™em_±r
(
l
, 
i
,

298 
bŒfs_block_group_™em
);

299 
	`´_šfo
(

301 
	`bŒfs_block_group_u£d
(
l
, 
bi
),

302 
	`bŒfs_block_group_chunk_objeùid
(
l
, 
bi
),

303 
	`bŒfs_block_group_æags
(
l
, 
bi
));

305 
BTRFS_CHUNK_ITEM_KEY
:

306 
	`´št_chunk
(
l
, 
	`bŒfs_™em_±r
Ö, 
i
,

307 
bŒfs_chunk
));

309 
BTRFS_DEV_ITEM_KEY
:

310 
	`´št_dev_™em
(
l
, 
	`bŒfs_™em_±r
Ö, 
i
,

311 
bŒfs_dev_™em
));

313 
BTRFS_DEV_EXTENT_KEY
:

314 
dev_ex‹Á
 = 
	`bŒfs_™em_±r
(
l
, 
i
,

315 
bŒfs_dev_ex‹Á
);

316 
	`´_šfo
("\t\tdevƒxtent chunk_tree %llu\n\t\tchunk objectid %llu chunk offset %llu†ength %llu\n",

317 
	`bŒfs_dev_ex‹Á_chunk_Œ“
(
l
, 
dev_ex‹Á
),

318 
	`bŒfs_dev_ex‹Á_chunk_objeùid
(
l
, 
dev_ex‹Á
),

319 
	`bŒfs_dev_ex‹Á_chunk_off£t
(
l
, 
dev_ex‹Á
),

320 
	`bŒfs_dev_ex‹Á_Ëngth
(
l
, 
dev_ex‹Á
));

322 
BTRFS_PERSISTENT_ITEM_KEY
:

323 
	`´_šfo
("\t\tpersistent item objectid %llu offset %llu\n",

324 
key
.
objeùid
, key.
off£t
);

325 
key
.
objeùid
) {

326 
BTRFS_DEV_STATS_OBJECTID
:

327 
	`´_šfo
("\t\tdevice stats\n");

330 
	`´_šfo
("\t\tunknown…ersistent item\n");

333 
BTRFS_TEMPORARY_ITEM_KEY
:

334 
	`´_šfo
("\t\ttemporary item objectid %llu offset %llu\n",

335 
key
.
objeùid
, key.
off£t
);

336 
key
.
objeùid
) {

337 
BTRFS_BALANCE_OBJECTID
:

338 
	`´_šfo
("\t\tbalance status\n");

341 
	`´_šfo
("\t\tunknownemporary item\n");

344 
BTRFS_DEV_REPLACE_KEY
:

345 
	`´_šfo
("\t\tdev„eplace\n");

347 
BTRFS_UUID_KEY_SUBVOL
:

348 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
:

349 
	`´št_uuid_™em
(
l
, 
	`bŒfs_™em_±r_off£t
Ö, 
i
),

350 
	`bŒfs_™em_size
(
l
, 
i
));

354 
	}
}

356 
	$bŒfs_´št_Œ“
(cÚ¡ 
ex‹Á_bufãr
 *
c
, 
boŞ
 
fŞlow
)

358 
bŒfs_fs_šfo
 *
fs_šfo
;

359 
i
; 
u32
 
Ä
;

360 
bŒfs_key
 
key
;

361 
Ëv–
;

363 ià(!
c
)

365 
fs_šfo
 = 
c
->fs_info;

366 
Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
c
);

367 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
c
);

368 ià(
Ëv–
 == 0) {

369 
	`bŒfs_´št_Ëaf
(
c
);

372 
	`bŒfs_šfo
(
fs_šfo
,

374 
	`bŒfs_h—d”_by‹Ä
(
c
), 
Ëv–
, 
	`bŒfs_h—d”_g’”©iÚ
(c),

375 
Ä
, (
u32
)
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
) -‚r,

376 
	`bŒfs_h—d”_owÃr
(
c
));

377 
	`´št_eb_»fs_lock
(
c
);

378 
i
 = 0; i < 
Ä
; i++) {

379 
	`bŒfs_node_key_to_ıu
(
c
, &
key
, 
i
);

380 
	`´_šfo
("\tkey %d (%llu %u %llu) block %llu gen %llu\n",

381 
i
, 
key
.
objeùid
, key.
ty³
, key.
off£t
,

382 
	`bŒfs_node_block±r
(
c
, 
i
),

383 
	`bŒfs_node_±r_g’”©iÚ
(
c
, 
i
));

385 ià(!
fŞlow
)

387 
i
 = 0; i < 
Ä
; i++) {

388 
bŒfs_Œ“_·»Á_check
 
check
 = {

389 .
Ëv–
 =†evel - 1,

390 .
Œªsid
 = 
	`bŒfs_node_±r_g’”©iÚ
(
c
, 
i
),

391 .
owÃr_roÙ
 = 
	`bŒfs_h—d”_owÃr
(
c
),

392 .
has_fœ¡_key
 = 
Œue


394 
ex‹Á_bufãr
 *
Ãxt
;

396 
	`bŒfs_node_key_to_ıu
(
c
, &
check
.
fœ¡_key
, 
i
);

397 
Ãxt
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
	`bŒfs_node_block±r
(
c
, 
i
), &
check
);

398 ià(
	`IS_ERR
(
Ãxt
))

400 ià(!
	`ex‹Á_bufãr_u±od©e
(
Ãxt
)) {

401 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

405 ià(
	`bŒfs_is_Ëaf
(
Ãxt
) &&

406 
Ëv–
 != 1)

407 
	`BUG
();

408 ià(
	`bŒfs_h—d”_Ëv–
(
Ãxt
) !=

409 
Ëv–
 - 1)

410 
	`BUG
();

411 
	`bŒfs_´št_Œ“
(
Ãxt
, 
fŞlow
);

412 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

414 
	}
}

	@print-tree.h

6 #iâdeà
BTRFS_PRINT_TREE_H


7 
	#BTRFS_PRINT_TREE_H


	)

10 
	#BTRFS_ROOT_NAME_BUF_LEN
 48

	)

12 
bŒfs_´št_Ëaf
(cÚ¡ 
ex‹Á_bufãr
 *
l
);

13 
bŒfs_´št_Œ“
(cÚ¡ 
ex‹Á_bufãr
 *
c
, 
boŞ
 
fŞlow
);

14 cÚ¡ *
bŒfs_roÙ_Çme
(cÚ¡ 
bŒfs_key
 *
key
, *
buf
);

	@props.c

6 
	~<lšux/hashbË.h
>

7 
	~"mes§ges.h
"

8 
	~"´İs.h
"

9 
	~"bŒfs_šode.h
"

10 
	~"Œª§ùiÚ.h
"

11 
	~"ù»e.h
"

12 
	~"x©Œ.h
"

13 
	~"com´essiÚ.h
"

14 
	~"¥aû-šfo.h
"

15 
	~"fs.h
"

16 
	~"acûssÜs.h
"

17 
	~"su³r.h
"

19 
	#BTRFS_PROP_HANDLERS_HT_BITS
 8

	)

20 
DEFINE_HASHTABLE
(
´İ_hªdËrs_ht
, 
BTRFS_PROP_HANDLERS_HT_BITS
);

22 
	s´İ_hªdËr
 {

23 
hli¡_node
 
	mnode
;

24 cÚ¡ *
	mx©Œ_Çme
;

25 (*
	mv®id©e
)(cÚ¡ 
bŒfs_šode
 *
	mšode
, cÚ¡ *
	mv®ue
,

26 
size_t
 
	mËn
);

27 (*
	m­¶y
)(
šode
 *
	mšode
, cÚ¡ *
	mv®ue
, 
size_t
 
	mËn
);

28 cÚ¡ *(*
	mexŒaù
)(
šode
 *
	mšode
);

29 
boŞ
 (*
ignÜe
)(cÚ¡ 
bŒfs_šode
 *
	mšode
);

30 
	mšh”™abË
;

33 cÚ¡ 
hli¡_h—d
 *
	$fšd_´İ_hªdËrs_by_hash
(cÚ¡ 
u64
 
hash
)

35 
hli¡_h—d
 *
h
;

37 
h
 = &
´İ_hªdËrs_ht
[
	`hash_mš
(
hash
, 
BTRFS_PROP_HANDLERS_HT_BITS
)];

38 ià(
	`hli¡_em±y
(
h
))

39  
NULL
;

41  
h
;

42 
	}
}

44 cÚ¡ 
´İ_hªdËr
 *

45 
	$fšd_´İ_hªdËr
(cÚ¡ *
Çme
,

46 cÚ¡ 
hli¡_h—d
 *
hªdËrs
)

48 
´İ_hªdËr
 *
h
;

50 ià(!
hªdËrs
) {

51 
u64
 
hash
 = 
	`bŒfs_Çme_hash
(
Çme
, 
	`¡¾’
(name));

53 
hªdËrs
 = 
	`fšd_´İ_hªdËrs_by_hash
(
hash
);

54 ià(!
hªdËrs
)

55  
NULL
;

58 
	`hli¡_fÜ_—ch_’Œy
(
h
, 
hªdËrs
, 
node
)

59 ià(!
	`¡rcmp
(
h
->
x©Œ_Çme
, 
Çme
))

60  
h
;

62  
NULL
;

63 
	}
}

65 
	$bŒfs_v®id©e_´İ
(cÚ¡ 
bŒfs_šode
 *
šode
, cÚ¡ *
Çme
,

66 cÚ¡ *
v®ue
, 
size_t
 
v®ue_Ën
)

68 cÚ¡ 
´İ_hªdËr
 *
hªdËr
;

70 ià(
	`¡¾’
(
Çme
è<ğ
XATTR_BTRFS_PREFIX_LEN
)

71  -
EINVAL
;

73 
hªdËr
 = 
	`fšd_´İ_hªdËr
(
Çme
, 
NULL
);

74 ià(!
hªdËr
)

75  -
EINVAL
;

77 ià(
v®ue_Ën
 == 0)

80  
hªdËr
->
	`v®id©e
(
šode
, 
v®ue
, 
v®ue_Ën
);

81 
	}
}

95 
boŞ
 
	$bŒfs_ignÜe_´İ
(cÚ¡ 
bŒfs_šode
 *
šode
, cÚ¡ *
Çme
)

97 cÚ¡ 
´İ_hªdËr
 *
hªdËr
;

99 
hªdËr
 = 
	`fšd_´İ_hªdËr
(
Çme
, 
NULL
);

100 
	`ASSERT
(
hªdËr
 !ğ
NULL
);

102  
hªdËr
->
	`ignÜe
(
šode
);

103 
	}
}

105 
	$bŒfs_£t_´İ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
šode
 *inode,

106 cÚ¡ *
Çme
, cÚ¡ *
v®ue
, 
size_t
 
v®ue_Ën
,

107 
æags
)

109 cÚ¡ 
´İ_hªdËr
 *
hªdËr
;

110 
»t
;

112 
hªdËr
 = 
	`fšd_´İ_hªdËr
(
Çme
, 
NULL
);

113 ià(!
hªdËr
)

114  -
EINVAL
;

116 ià(
v®ue_Ën
 == 0) {

117 
»t
 = 
	`bŒfs_£tx©Œ
(
Œªs
, 
šode
, 
hªdËr
->
x©Œ_Çme
,

118 
NULL
, 0, 
æags
);

119 ià(
»t
)

120  
»t
;

122 
»t
 = 
hªdËr
->
	`­¶y
(
šode
, 
NULL
, 0);

123 
	`ASSERT
(
»t
 == 0);

125  
»t
;

128 
»t
 = 
	`bŒfs_£tx©Œ
(
Œªs
, 
šode
, 
hªdËr
->
x©Œ_Çme
, 
v®ue
,

129 
v®ue_Ën
, 
æags
);

130 ià(
»t
)

131  
»t
;

132 
»t
 = 
hªdËr
->
	`­¶y
(
šode
, 
v®ue
, 
v®ue_Ën
);

133 ià(
»t
) {

134 
	`bŒfs_£tx©Œ
(
Œªs
, 
šode
, 
hªdËr
->
x©Œ_Çme
, 
NULL
,

135 0, 
æags
);

136  
»t
;

139 
	`£t_b™
(
BTRFS_INODE_HAS_PROPS
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

142 
	}
}

144 
	$™”©e_objeù_´İs
(
bŒfs_roÙ
 *
roÙ
,

145 
bŒfs_·th
 *
·th
,

146 
u64
 
objeùid
,

147 (*
™”©Ü
)(*,

148 cÚ¡ 
´İ_hªdËr
 *,

150 
size_t
),

151 *
ùx
)

153 
»t
;

154 *
Çme_buf
 = 
NULL
;

155 *
v®ue_buf
 = 
NULL
;

156 
Çme_buf_Ën
 = 0;

157 
v®ue_buf_Ën
 = 0;

160 
bŒfs_key
 
key
;

161 
bŒfs_dœ_™em
 *
di
;

162 
ex‹Á_bufãr
 *
Ëaf
;

163 
u32
 
tÙ®_Ën
, 
cur
, 
this_Ën
;

164 
¦Ù
;

165 cÚ¡ 
hli¡_h—d
 *
hªdËrs
;

167 
¦Ù
 = 
·th
->
¦Ùs
[0];

168 
Ëaf
 = 
·th
->
nodes
[0];

170 ià(
¦Ù
 >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

171 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

172 ià(
»t
 < 0)

173 
out
;

174 ià(
»t
 > 0)

179 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

180 ià(
key
.
objeùid
 != objectid)

182 ià(
key
.
ty³
 !ğ
BTRFS_XATTR_ITEM_KEY
)

185 
hªdËrs
 = 
	`fšd_´İ_hªdËrs_by_hash
(
key
.
off£t
);

186 ià(!
hªdËrs
)

187 
Ãxt_¦Ù
;

189 
di
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_dœ_™em
);

190 
cur
 = 0;

191 
tÙ®_Ën
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

193 
cur
 < 
tÙ®_Ën
) {

194 
u32
 
Çme_Ën
 = 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
di
);

195 
u32
 
d©a_Ën
 = 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
);

196 
Çme_±r
, 
d©a_±r
;

197 cÚ¡ 
´İ_hªdËr
 *
hªdËr
;

199 
this_Ën
 = (*
di
è+ 
Çme_Ën
 + 
d©a_Ën
;

200 
Çme_±r
 = ()(
di
 + 1);

201 
d©a_±r
 = 
Çme_±r
 + 
Çme_Ën
;

203 ià(
Çme_Ën
 <ğ
XATTR_BTRFS_PREFIX_LEN
 ||

204 
	`memcmp_ex‹Á_bufãr
(
Ëaf
, 
XATTR_BTRFS_PREFIX
,

205 
Çme_±r
,

206 
XATTR_BTRFS_PREFIX_LEN
))

207 
Ãxt_dœ_™em
;

209 ià(
Çme_Ën
 >ğ
Çme_buf_Ën
) {

210 
	`kä“
(
Çme_buf
);

211 
Çme_buf_Ën
 = 
Çme_Ën
 + 1;

212 
Çme_buf
 = 
	`km®loc
(
Çme_buf_Ën
, 
GFP_NOFS
);

213 ià(!
Çme_buf
) {

214 
»t
 = -
ENOMEM
;

215 
out
;

218 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
Çme_buf
, 
Çme_±r
, 
Çme_Ën
);

219 
Çme_buf
[
Çme_Ën
] = '\0';

221 
hªdËr
 = 
	`fšd_´İ_hªdËr
(
Çme_buf
, 
hªdËrs
);

222 ià(!
hªdËr
)

223 
Ãxt_dœ_™em
;

225 ià(
d©a_Ën
 > 
v®ue_buf_Ën
) {

226 
	`kä“
(
v®ue_buf
);

227 
v®ue_buf_Ën
 = 
d©a_Ën
;

228 
v®ue_buf
 = 
	`km®loc
(
d©a_Ën
, 
GFP_NOFS
);

229 ià(!
v®ue_buf
) {

230 
»t
 = -
ENOMEM
;

231 
out
;

234 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
v®ue_buf
, 
d©a_±r
, 
d©a_Ën
);

236 
	`™”©Ü
(
ùx
, 
hªdËr
, 
v®ue_buf
, 
d©a_Ën
);

237 
Ãxt_dœ_™em
:

238 
cur
 +ğ
this_Ën
;

239 
di
 = (
bŒfs_dœ_™em
 *)((*èd˜+ 
this_Ën
);

242 
Ãxt_¦Ù
:

243 
·th
->
¦Ùs
[0]++;

246 
»t
 = 0;

247 
out
:

248 
	`bŒfs_»Ëa£_·th
(
·th
);

249 
	`kä“
(
Çme_buf
);

250 
	`kä“
(
v®ue_buf
);

252  
»t
;

253 
	}
}

255 
	$šode_´İ_™”©Ü
(*
ùx
,

256 cÚ¡ 
´İ_hªdËr
 *
hªdËr
,

257 cÚ¡ *
v®ue
,

258 
size_t
 
Ën
)

260 
šode
 *šodğ
ùx
;

261 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

262 
»t
;

264 
»t
 = 
hªdËr
->
	`­¶y
(
šode
, 
v®ue
, 
Ën
);

265 ià(
	`uÆik–y
(
»t
))

266 
	`bŒfs_w¬n
(
roÙ
->
fs_šfo
,

268 
hªdËr
->
x©Œ_Çme
, 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)),

269 
roÙ
->
roÙ_key
.
objeùid
, 
»t
);

271 
	`£t_b™
(
BTRFS_INODE_HAS_PROPS
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

272 
	}
}

274 
	$bŒfs_lßd_šode_´İs
(
šode
 *šode, 
bŒfs_·th
 *
·th
)

276 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

277 
u64
 
šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

279  
	`™”©e_objeù_´İs
(
roÙ
, 
·th
, 
šo
, 
šode_´İ_™”©Ü
, 
šode
);

280 
	}
}

282 
	$´İ_com´essiÚ_v®id©e
(cÚ¡ 
bŒfs_šode
 *
šode
,

283 cÚ¡ *
v®ue
, 
size_t
 
Ën
)

285 ià(!
	`bŒfs_šode_ÿn_com´ess
(
šode
))

286  -
EINVAL
;

288 ià(!
v®ue
)

291 ià(
	`bŒfs_com´ess_is_v®id_ty³
(
v®ue
, 
Ën
))

294 ià((
Ën
 =ğ2 && 
	`¡ºcmp
("no", 
v®ue
, 2) == 0) ||

295 (
Ën
 =ğ4 && 
	`¡ºcmp
("nÚe", 
v®ue
, 4) == 0))

298  -
EINVAL
;

299 
	}
}

301 
	$´İ_com´essiÚ_­¶y
(
šode
 *šode, cÚ¡ *
v®ue
,

302 
size_t
 
Ën
)

304 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

305 
ty³
;

308 ià(
Ën
 == 0) {

309 
	`BTRFS_I
(
šode
)->
æags
 &ğ~
BTRFS_INODE_COMPRESS
;

310 
	`BTRFS_I
(
šode
)->
æags
 &ğ~
BTRFS_INODE_NOCOMPRESS
;

311 
	`BTRFS_I
(
šode
)->
´İ_com´ess
 = 
BTRFS_COMPRESS_NONE
;

316 ià((
Ën
 =ğ2 && 
	`¡ºcmp
("no", 
v®ue
, 2) == 0) ||

317 (
Ën
 =ğ4 && 
	`¡ºcmp
("nÚe", 
v®ue
, 4) == 0)) {

318 
	`BTRFS_I
(
šode
)->
æags
 |ğ
BTRFS_INODE_NOCOMPRESS
;

319 
	`BTRFS_I
(
šode
)->
æags
 &ğ~
BTRFS_INODE_COMPRESS
;

320 
	`BTRFS_I
(
šode
)->
´İ_com´ess
 = 
BTRFS_COMPRESS_NONE
;

325 ià(!
	`¡ºcmp
("lzo", 
v®ue
, 3)) {

326 
ty³
 = 
BTRFS_COMPRESS_LZO
;

327 
	`bŒfs_£t_fs_šcom·t
(
fs_šfo
, 
COMPRESS_LZO
);

328 } ià(!
	`¡ºcmp
("zlib", 
v®ue
, 4)) {

329 
ty³
 = 
BTRFS_COMPRESS_ZLIB
;

330 } ià(!
	`¡ºcmp
("z¡d", 
v®ue
, 4)) {

331 
ty³
 = 
BTRFS_COMPRESS_ZSTD
;

332 
	`bŒfs_£t_fs_šcom·t
(
fs_šfo
, 
COMPRESS_ZSTD
);

334  -
EINVAL
;

337 
	`BTRFS_I
(
šode
)->
æags
 &ğ~
BTRFS_INODE_NOCOMPRESS
;

338 
	`BTRFS_I
(
šode
)->
æags
 |ğ
BTRFS_INODE_COMPRESS
;

339 
	`BTRFS_I
(
šode
)->
´İ_com´ess
 = 
ty³
;

342 
	}
}

344 
boŞ
 
	$´İ_com´essiÚ_ignÜe
(cÚ¡ 
bŒfs_šode
 *
šode
)

353 ià(!
	`S_ISREG
(
šode
->
vfs_šode
.
i_mode
) &&

354 !
	`S_ISDIR
(
šode
->
vfs_šode
.
i_mode
))

355  
Œue
;

357  
çl£
;

358 
	}
}

360 cÚ¡ *
	$´İ_com´essiÚ_exŒaù
(
šode
 *inode)

362 
	`BTRFS_I
(
šode
)->
´İ_com´ess
) {

363 
BTRFS_COMPRESS_ZLIB
:

364 
BTRFS_COMPRESS_LZO
:

365 
BTRFS_COMPRESS_ZSTD
:

366  
	`bŒfs_com´ess_ty³2¡r
(
	`BTRFS_I
(
šode
)->
´İ_com´ess
);

371  
NULL
;

372 
	}
}

374 
´İ_hªdËr
 
	g´İ_hªdËrs
[] = {

376 .
x©Œ_Çme
 = 
XATTR_BTRFS_PREFIX
 "compression",

377 .
	gv®id©e
 = 
´İ_com´essiÚ_v®id©e
,

378 .
	g­¶y
 = 
´İ_com´essiÚ_­¶y
,

379 .
	gexŒaù
 = 
´İ_com´essiÚ_exŒaù
,

380 .
	gignÜe
 = 
´İ_com´essiÚ_ignÜe
,

381 .
	gšh”™abË
 = 1

385 
	$bŒfs_šode_šh”™_´İs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

386 
šode
 *šode, šod*
·»Á
)

388 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

389 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

390 
»t
;

391 
i
;

392 
boŞ
 
Ãed_»£rve
 = 
çl£
;

394 ià(!
	`‹¡_b™
(
BTRFS_INODE_HAS_PROPS
,

395 &
	`BTRFS_I
(
·»Á
)->
ruÁime_æags
))

398 
i
 = 0; i < 
	`ARRAY_SIZE
(
´İ_hªdËrs
); i++) {

399 cÚ¡ 
´İ_hªdËr
 *
h
 = &
´İ_hªdËrs
[
i
];

400 cÚ¡ *
v®ue
;

401 
u64
 
num_by‹s
 = 0;

403 ià(!
h
->
šh”™abË
)

406 ià(
h
->
	`ignÜe
(
	`BTRFS_I
(
šode
)))

409 
v®ue
 = 
h
->
	`exŒaù
(
·»Á
);

410 ià(!
v®ue
)

417 
»t
 = 
h
->
	`v®id©e
(
	`BTRFS_I
(
šode
), 
v®ue
, 
	`¡¾’
(value));

418 ià(
»t
)

428 ià(
Ãed_»£rve
) {

429 
num_by‹s
 = 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
, 1);

430 
»t
 = 
	`bŒfs_block_rsv_add
(
fs_šfo
, 
Œªs
->
block_rsv
,

431 
num_by‹s
,

432 
BTRFS_RESERVE_NO_FLUSH
);

433 ià(
»t
)

434  
»t
;

437 
»t
 = 
	`bŒfs_£tx©Œ
(
Œªs
, 
šode
, 
h
->
x©Œ_Çme
, 
v®ue
,

438 
	`¡¾’
(
v®ue
), 0);

439 ià(!
»t
) {

440 
»t
 = 
h
->
	`­¶y
(
šode
, 
v®ue
, 
	`¡¾’
(value));

441 ià(
»t
)

442 
	`bŒfs_£tx©Œ
(
Œªs
, 
šode
, 
h
->
x©Œ_Çme
,

443 
NULL
, 0, 0);

445 
	`£t_b™
(
BTRFS_INODE_HAS_PROPS
,

446 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

449 ià(
Ãed_»£rve
) {

450 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
Œªs
->
block_rsv
,

451 
num_by‹s
, 
NULL
);

452 ià(
»t
)

453  
»t
;

455 
Ãed_»£rve
 = 
Œue
;

459 
	}
}

461 
__š™
 
	$bŒfs_´İs_š™
()

463 
i
;

465 
i
 = 0; i < 
	`ARRAY_SIZE
(
´İ_hªdËrs
); i++) {

466 
´İ_hªdËr
 *
p
 = &
´İ_hªdËrs
[
i
];

467 
u64
 
h
 = 
	`bŒfs_Çme_hash
(
p
->
x©Œ_Çme
, 
	`¡¾’
(p->xattr_name));

469 
	`hash_add
(
´İ_hªdËrs_ht
, &
p
->
node
, 
h
);

472 
	}
}

	@props.h

6 #iâdeà
BTRFS_PROPS_H


7 
	#BTRFS_PROPS_H


	)

9 
	~"ù»e.h
"

11 
__š™
 
bŒfs_´İs_š™
();

13 
bŒfs_£t_´İ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
šode
 *inode,

14 cÚ¡ *
Çme
, cÚ¡ *
v®ue
, 
size_t
 
v®ue_Ën
,

15 
æags
);

16 
bŒfs_v®id©e_´İ
(cÚ¡ 
bŒfs_šode
 *
šode
, cÚ¡ *
Çme
,

17 cÚ¡ *
v®ue
, 
size_t
 
v®ue_Ën
);

18 
boŞ
 
bŒfs_ignÜe_´İ
(cÚ¡ 
bŒfs_šode
 *
šode
, cÚ¡ *
Çme
);

20 
bŒfs_lßd_šode_´İs
(
šode
 *šode, 
bŒfs_·th
 *
·th
);

22 
bŒfs_šode_šh”™_´İs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

23 
šode
 *inode,

24 
šode
 *
dœ
);

	@qgroup.c

6 
	~<lšux/sched.h
>

7 
	~<lšux/·gem­.h
>

8 
	~<lšux/wr™eback.h
>

9 
	~<lšux/blkdev.h
>

10 
	~<lšux/rbŒ“.h
>

11 
	~<lšux/¦ab.h
>

12 
	~<lšux/wÜkqueue.h
>

13 
	~<lšux/bŒfs.h
>

14 
	~<lšux/sched/mm.h
>

16 
	~"ù»e.h
"

17 
	~"Œª§ùiÚ.h
"

18 
	~"disk-io.h
"

19 
	~"lockšg.h
"

20 
	~"uli¡.h
"

21 
	~"back»f.h
"

22 
	~"ex‹Á_io.h
"

23 
	~"qgroup.h
"

24 
	~"block-group.h
"

25 
	~"sysfs.h
"

26 
	~"Œ“-mod-log.h
"

27 
	~"fs.h
"

28 
	~"acûssÜs.h
"

29 
	~"ex‹Á-Œ“.h
"

30 
	~"roÙ-Œ“.h
"

31 
	~"Œ“-check”.h
"

39 
u64
 
	$qgroup_rsv_tÙ®
(cÚ¡ 
bŒfs_qgroup
 *
qgroup
)

41 
u64
 
»t
 = 0;

42 
i
;

44 
i
 = 0; i < 
BTRFS_QGROUP_RSV_LAST
; i++)

45 
»t
 +ğ
qgroup
->
rsv
.
v®ues
[
i
];

47  
»t
;

48 
	}
}

50 #ifdeà
CONFIG_BTRFS_DEBUG


51 cÚ¡ *
	$qgroup_rsv_ty³_¡r
(
bŒfs_qgroup_rsv_ty³
 
ty³
)

53 ià(
ty³
 =ğ
BTRFS_QGROUP_RSV_DATA
)

55 ià(
ty³
 =ğ
BTRFS_QGROUP_RSV_META_PERTRANS
)

57 ià(
ty³
 =ğ
BTRFS_QGROUP_RSV_META_PREALLOC
)

59  
NULL
;

60 
	}
}

63 
	$qgroup_rsv_add
(
bŒfs_fs_šfo
 *
fs_šfo
,

64 
bŒfs_qgroup
 *
qgroup
, 
u64
 
num_by‹s
,

65 
bŒfs_qgroup_rsv_ty³
 
ty³
)

67 
	`Œaû_qgroup_upd©e_»£rve
(
fs_šfo
, 
qgroup
, 
num_by‹s
, 
ty³
);

68 
qgroup
->
rsv
.
v®ues
[
ty³
] +ğ
num_by‹s
;

69 
	}
}

71 
	$qgroup_rsv_»Ëa£
(
bŒfs_fs_šfo
 *
fs_šfo
,

72 
bŒfs_qgroup
 *
qgroup
, 
u64
 
num_by‹s
,

73 
bŒfs_qgroup_rsv_ty³
 
ty³
)

75 
	`Œaû_qgroup_upd©e_»£rve
(
fs_šfo
, 
qgroup
, -(
s64
)
num_by‹s
, 
ty³
);

76 ià(
qgroup
->
rsv
.
v®ues
[
ty³
] >ğ
num_by‹s
) {

77 
qgroup
->
rsv
.
v®ues
[
ty³
] -ğ
num_by‹s
;

80 #ifdeà
CONFIG_BTRFS_DEBUG


81 
	`WARN_RATELIMIT
(1,

83 
qgroup
->
qgroupid
, 
	`qgroup_rsv_ty³_¡r
(
ty³
),

84 
qgroup
->
rsv
.
v®ues
[
ty³
], 
num_by‹s
);

86 
qgroup
->
rsv
.
v®ues
[
ty³
] = 0;

87 
	}
}

89 
	$qgroup_rsv_add_by_qgroup
(
bŒfs_fs_šfo
 *
fs_šfo
,

90 
bŒfs_qgroup
 *
de¡
,

91 
bŒfs_qgroup
 *
¤c
)

93 
i
;

95 
i
 = 0; i < 
BTRFS_QGROUP_RSV_LAST
; i++)

96 
	`qgroup_rsv_add
(
fs_šfo
, 
de¡
, 
¤c
->
rsv
.
v®ues
[
i
], i);

97 
	}
}

99 
	$qgroup_rsv_»Ëa£_by_qgroup
(
bŒfs_fs_šfo
 *
fs_šfo
,

100 
bŒfs_qgroup
 *
de¡
,

101 
bŒfs_qgroup
 *
¤c
)

103 
i
;

105 
i
 = 0; i < 
BTRFS_QGROUP_RSV_LAST
; i++)

106 
	`qgroup_rsv_»Ëa£
(
fs_šfo
, 
de¡
, 
¤c
->
rsv
.
v®ues
[
i
], i);

107 
	}
}

109 
	$bŒfs_qgroup_upd©e_Şd_»fút
(
bŒfs_qgroup
 *
qg
, 
u64
 
£q
,

110 
mod
)

112 ià(
qg
->
Şd_»fút
 < 
£q
)

113 
qg
->
Şd_»fút
 = 
£q
;

114 
qg
->
Şd_»fút
 +ğ
mod
;

115 
	}
}

117 
	$bŒfs_qgroup_upd©e_Ãw_»fút
(
bŒfs_qgroup
 *
qg
, 
u64
 
£q
,

118 
mod
)

120 ià(
qg
->
Ãw_»fút
 < 
£q
)

121 
qg
->
Ãw_»fút
 = 
£q
;

122 
qg
->
Ãw_»fút
 +ğ
mod
;

123 
	}
}

125 
šlše
 
u64
 
	$bŒfs_qgroup_g‘_Şd_»fút
(
bŒfs_qgroup
 *
qg
, 
u64
 
£q
)

127 ià(
qg
->
Şd_»fút
 < 
£q
)

129  
qg
->
Şd_»fút
 - 
£q
;

130 
	}
}

132 
šlše
 
u64
 
	$bŒfs_qgroup_g‘_Ãw_»fút
(
bŒfs_qgroup
 *
qg
, 
u64
 
£q
)

134 ià(
qg
->
Ãw_»fút
 < 
£q
)

136  
qg
->
Ãw_»fút
 - 
£q
;

137 
	}
}

142 
	sbŒfs_qgroup_li¡
 {

143 
li¡_h—d
 
	mÃxt_group
;

144 
li¡_h—d
 
	mÃxt_memb”
;

145 
bŒfs_qgroup
 *
	mgroup
;

146 
bŒfs_qgroup
 *
	mmemb”
;

149 
šlše
 
u64
 
	$qgroup_to_aux
(
bŒfs_qgroup
 *
qg
)

151  (
u64
)(
ušŒ_t
)
qg
;

152 
	}
}

154 
šlše
 
bŒfs_qgroup
* 
	$unode_aux_to_qgroup
(
uli¡_node
 *
n
)

156  (
bŒfs_qgroup
 *)(
ušŒ_t
)
n
->
aux
;

157 
	}
}

160 
qgroup_»sÿn_š™
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
´og»ss_objeùid
,

161 
š™_æags
);

162 
qgroup_»sÿn_z”o_Œackšg
(
bŒfs_fs_šfo
 *
fs_šfo
);

165 
bŒfs_qgroup
 *
	$fšd_qgroup_rb
(
bŒfs_fs_šfo
 *
fs_šfo
,

166 
u64
 
qgroupid
)

168 
rb_node
 *
n
 = 
fs_šfo
->
qgroup_Œ“
.rb_node;

169 
bŒfs_qgroup
 *
qgroup
;

171 
n
) {

172 
qgroup
 = 
	`rb_’Œy
(
n
, 
bŒfs_qgroup
, 
node
);

173 ià(
qgroup
->
qgroupid
 < qgroupid)

174 
n
 =‚->
rb_Ëá
;

175 ià(
qgroup
->
qgroupid
 > qgroupid)

176 
n
 =‚->
rb_right
;

178  
qgroup
;

180  
NULL
;

181 
	}
}

184 
bŒfs_qgroup
 *
	$add_qgroup_rb
(
bŒfs_fs_šfo
 *
fs_šfo
,

185 
u64
 
qgroupid
)

187 
rb_node
 **
p
 = &
fs_šfo
->
qgroup_Œ“
.rb_node;

188 
rb_node
 *
·»Á
 = 
NULL
;

189 
bŒfs_qgroup
 *
qgroup
;

191 *
p
) {

192 
·»Á
 = *
p
;

193 
qgroup
 = 
	`rb_’Œy
(
·»Á
, 
bŒfs_qgroup
, 
node
);

195 ià(
qgroup
->
qgroupid
 < qgroupid)

196 
p
 = &(*p)->
rb_Ëá
;

197 ià(
qgroup
->
qgroupid
 > qgroupid)

198 
p
 = &(*p)->
rb_right
;

200  
qgroup
;

203 
qgroup
 = 
	`kz®loc
((*qgroup), 
GFP_ATOMIC
);

204 ià(!
qgroup
)

205  
	`ERR_PTR
(-
ENOMEM
);

207 
qgroup
->
qgroupid
 = qgroupid;

208 
	`INIT_LIST_HEAD
(&
qgroup
->
groups
);

209 
	`INIT_LIST_HEAD
(&
qgroup
->
memb”s
);

210 
	`INIT_LIST_HEAD
(&
qgroup
->
dœty
);

212 
	`rb_lšk_node
(&
qgroup
->
node
, 
·»Á
, 
p
);

213 
	`rb_š£¹_cŞÜ
(&
qgroup
->
node
, &
fs_šfo
->
qgroup_Œ“
);

215  
qgroup
;

216 
	}
}

218 
	$__d–_qgroup_rb
(
bŒfs_fs_šfo
 *
fs_šfo
,

219 
bŒfs_qgroup
 *
qgroup
)

221 
bŒfs_qgroup_li¡
 *
li¡
;

223 
	`li¡_d–
(&
qgroup
->
dœty
);

224 !
	`li¡_em±y
(&
qgroup
->
groups
)) {

225 
li¡
 = 
	`li¡_fœ¡_’Œy
(&
qgroup
->
groups
,

226 
bŒfs_qgroup_li¡
, 
Ãxt_group
);

227 
	`li¡_d–
(&
li¡
->
Ãxt_group
);

228 
	`li¡_d–
(&
li¡
->
Ãxt_memb”
);

229 
	`kä“
(
li¡
);

232 !
	`li¡_em±y
(&
qgroup
->
memb”s
)) {

233 
li¡
 = 
	`li¡_fœ¡_’Œy
(&
qgroup
->
memb”s
,

234 
bŒfs_qgroup_li¡
, 
Ãxt_memb”
);

235 
	`li¡_d–
(&
li¡
->
Ãxt_group
);

236 
	`li¡_d–
(&
li¡
->
Ãxt_memb”
);

237 
	`kä“
(
li¡
);

239 
	}
}

242 
	$d–_qgroup_rb
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
qgroupid
)

244 
bŒfs_qgroup
 *
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
qgroupid
);

246 ià(!
qgroup
)

247  -
ENOENT
;

249 
	`rb_”a£
(&
qgroup
->
node
, &
fs_šfo
->
qgroup_Œ“
);

250 
	`__d–_qgroup_rb
(
fs_šfo
, 
qgroup
);

252 
	}
}

263 
	$__add_»ÏtiÚ_rb
(
bŒfs_qgroup
 *
memb”
, bŒfs_qgrou°*
·»Á
)

265 
bŒfs_qgroup_li¡
 *
li¡
;

267 ià(!
memb”
 || !
·»Á
)

268  -
ENOENT
;

270 
li¡
 = 
	`kz®loc
((*li¡), 
GFP_ATOMIC
);

271 ià(!
li¡
)

272  -
ENOMEM
;

274 
li¡
->
group
 = 
·»Á
;

275 
li¡
->
memb”
 = member;

276 
	`li¡_add_
(&
li¡
->
Ãxt_group
, &
memb”
->
groups
);

277 
	`li¡_add_
(&
li¡
->
Ãxt_memb”
, &
·»Á
->
memb”s
);

280 
	}
}

291 
	$add_»ÏtiÚ_rb
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
memb”id
, u64 
·»Áid
)

293 
bŒfs_qgroup
 *
memb”
;

294 
bŒfs_qgroup
 *
·»Á
;

296 
memb”
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
memb”id
);

297 
·»Á
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
·»Áid
);

299  
	`__add_»ÏtiÚ_rb
(
memb”
, 
·»Á
);

300 
	}
}

303 
	$d–_»ÏtiÚ_rb
(
bŒfs_fs_šfo
 *
fs_šfo
,

304 
u64
 
memb”id
, u64 
·»Áid
)

306 
bŒfs_qgroup
 *
memb”
;

307 
bŒfs_qgroup
 *
·»Á
;

308 
bŒfs_qgroup_li¡
 *
li¡
;

310 
memb”
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
memb”id
);

311 
·»Á
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
·»Áid
);

312 ià(!
memb”
 || !
·»Á
)

313  -
ENOENT
;

315 
	`li¡_fÜ_—ch_’Œy
(
li¡
, &
memb”
->
groups
, 
Ãxt_group
) {

316 ià(
li¡
->
group
 =ğ
·»Á
) {

317 
	`li¡_d–
(&
li¡
->
Ãxt_group
);

318 
	`li¡_d–
(&
li¡
->
Ãxt_memb”
);

319 
	`kä“
(
li¡
);

323  -
ENOENT
;

324 
	}
}

326 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


327 
	$bŒfs_v”ify_qgroup_couÁs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
qgroupid
,

328 
u64
 
rãr
, u64 
exş
)

330 
bŒfs_qgroup
 *
qgroup
;

332 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
qgroupid
);

333 ià(!
qgroup
)

334  -
EINVAL
;

335 ià(
qgroup
->
rãr
 !ğrã¸|| qgroup->
exş
 !=ƒxcl)

336  -
EINVAL
;

338 
	}
}

341 
	$qgroup_m¬k_šcÚsi¡’t
(
bŒfs_fs_šfo
 *
fs_šfo
)

343 
fs_šfo
->
qgroup_æags
 |ğ(
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
 |

344 
BTRFS_QGROUP_RUNTIME_FLAG_CANCEL_RESCAN
 |

345 
BTRFS_QGROUP_RUNTIME_FLAG_NO_ACCOUNTING
);

346 
	}
}

352 
	$bŒfs_»ad_qgroup_cÚfig
(
bŒfs_fs_šfo
 *
fs_šfo
)

354 
bŒfs_key
 
key
;

355 
bŒfs_key
 
found_key
;

356 
bŒfs_roÙ
 *
quÙa_roÙ
 = 
fs_šfo
->quota_root;

357 
bŒfs_·th
 *
·th
 = 
NULL
;

358 
ex‹Á_bufãr
 *
l
;

359 
¦Ù
;

360 
»t
 = 0;

361 
u64
 
æags
 = 0;

362 
u64
 
»sÿn_´og»ss
 = 0;

364 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

367 
fs_šfo
->
qgroup_uli¡
 = 
	`uli¡_®loc
(
GFP_KERNEL
);

368 ià(!
fs_šfo
->
qgroup_uli¡
) {

369 
»t
 = -
ENOMEM
;

370 
out
;

373 
·th
 = 
	`bŒfs_®loc_·th
();

374 ià(!
·th
) {

375 
»t
 = -
ENOMEM
;

376 
out
;

379 
»t
 = 
	`bŒfs_sysfs_add_qgroups
(
fs_šfo
);

380 ià(
»t
 < 0)

381 
out
;

383 
fs_šfo
->
qgroup_æags
 = 0;

388 
key
.
objeùid
 = 0;

389 
key
.
ty³
 = 0;

390 
key
.
off£t
 = 0;

391 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
quÙa_roÙ
, &
key
, 
·th
, 1, 1);

392 ià(
»t
)

393 
out
;

396 
bŒfs_qgroup
 *
qgroup
;

398 
¦Ù
 = 
·th
->
¦Ùs
[0];

399 
l
 = 
·th
->
nodes
[0];

400 
	`bŒfs_™em_key_to_ıu
(
l
, &
found_key
, 
¦Ù
);

402 ià(
found_key
.
ty³
 =ğ
BTRFS_QGROUP_STATUS_KEY
) {

403 
bŒfs_qgroup_¡©us_™em
 *
±r
;

405 
±r
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
,

406 
bŒfs_qgroup_¡©us_™em
);

408 ià(
	`bŒfs_qgroup_¡©us_v”siÚ
(
l
, 
±r
) !=

409 
BTRFS_QGROUP_STATUS_VERSION
) {

410 
	`bŒfs_”r
(
fs_šfo
,

412 
out
;

414 ià(
	`bŒfs_qgroup_¡©us_g’”©iÚ
(
l
, 
±r
) !=

415 
fs_šfo
->
g’”©iÚ
) {

416 
	`qgroup_m¬k_šcÚsi¡’t
(
fs_šfo
);

417 
	`bŒfs_”r
(
fs_šfo
,

420 
fs_šfo
->
qgroup_æags
 = 
	`bŒfs_qgroup_¡©us_æags
(
l
,

421 
±r
);

422 
»sÿn_´og»ss
 = 
	`bŒfs_qgroup_¡©us_»sÿn
(
l
, 
±r
);

423 
Ãxt1
;

426 ià(
found_key
.
ty³
 !ğ
BTRFS_QGROUP_INFO_KEY
 &&

427 
found_key
.
ty³
 !ğ
BTRFS_QGROUP_LIMIT_KEY
)

428 
Ãxt1
;

430 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
found_key
.
off£t
);

431 ià((
qgroup
 && 
found_key
.
ty³
 =ğ
BTRFS_QGROUP_INFO_KEY
) ||

432 (!
qgroup
 && 
found_key
.
ty³
 =ğ
BTRFS_QGROUP_LIMIT_KEY
)) {

433 
	`bŒfs_”r
(
fs_šfo
, "inconsistent qgroup config");

434 
	`qgroup_m¬k_šcÚsi¡’t
(
fs_šfo
);

436 ià(!
qgroup
) {

437 
qgroup
 = 
	`add_qgroup_rb
(
fs_šfo
, 
found_key
.
off£t
);

438 ià(
	`IS_ERR
(
qgroup
)) {

439 
»t
 = 
	`PTR_ERR
(
qgroup
);

440 
out
;

443 
»t
 = 
	`bŒfs_sysfs_add_Úe_qgroup
(
fs_šfo
, 
qgroup
);

444 ià(
»t
 < 0)

445 
out
;

447 
found_key
.
ty³
) {

448 
BTRFS_QGROUP_INFO_KEY
: {

449 
bŒfs_qgroup_šfo_™em
 *
±r
;

451 
±r
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
,

452 
bŒfs_qgroup_šfo_™em
);

453 
qgroup
->
rãr
 = 
	`bŒfs_qgroup_šfo_rãr
(
l
, 
±r
);

454 
qgroup
->
rãr_cm´
 = 
	`bŒfs_qgroup_šfo_rãr_cm´
(
l
, 
±r
);

455 
qgroup
->
exş
 = 
	`bŒfs_qgroup_šfo_exş
(
l
, 
±r
);

456 
qgroup
->
exş_cm´
 = 
	`bŒfs_qgroup_šfo_exş_cm´
(
l
, 
±r
);

460 
BTRFS_QGROUP_LIMIT_KEY
: {

461 
bŒfs_qgroup_lim™_™em
 *
±r
;

463 
±r
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
,

464 
bŒfs_qgroup_lim™_™em
);

465 
qgroup
->
lim_æags
 = 
	`bŒfs_qgroup_lim™_æags
(
l
, 
±r
);

466 
qgroup
->
max_rãr
 = 
	`bŒfs_qgroup_lim™_max_rãr
(
l
, 
±r
);

467 
qgroup
->
max_exş
 = 
	`bŒfs_qgroup_lim™_max_exş
(
l
, 
±r
);

468 
qgroup
->
rsv_rãr
 = 
	`bŒfs_qgroup_lim™_rsv_rãr
(
l
, 
±r
);

469 
qgroup
->
rsv_exş
 = 
	`bŒfs_qgroup_lim™_rsv_exş
(
l
, 
±r
);

473 
Ãxt1
:

474 
»t
 = 
	`bŒfs_Ãxt_™em
(
quÙa_roÙ
, 
·th
);

475 ià(
»t
 < 0)

476 
out
;

477 ià(
»t
)

480 
	`bŒfs_»Ëa£_·th
(
·th
);

485 
key
.
objeùid
 = 0;

486 
key
.
ty³
 = 
BTRFS_QGROUP_RELATION_KEY
;

487 
key
.
off£t
 = 0;

488 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
quÙa_roÙ
, &
key
, 
·th
, 1, 0);

489 ià(
»t
)

490 
out
;

492 
¦Ù
 = 
·th
->
¦Ùs
[0];

493 
l
 = 
·th
->
nodes
[0];

494 
	`bŒfs_™em_key_to_ıu
(
l
, &
found_key
, 
¦Ù
);

496 ià(
found_key
.
ty³
 !ğ
BTRFS_QGROUP_RELATION_KEY
)

497 
Ãxt2
;

499 ià(
found_key
.
objeùid
 > found_key.
off£t
) {

502 
Ãxt2
;

505 
»t
 = 
	`add_»ÏtiÚ_rb
(
fs_šfo
, 
found_key
.
objeùid
,

506 
found_key
.
off£t
);

507 ià(
»t
 =ğ-
ENOENT
) {

508 
	`bŒfs_w¬n
(
fs_šfo
,

510 
found_key
.
objeùid
, found_key.
off£t
);

511 
»t
 = 0;

513 ià(
»t
)

514 
out
;

515 
Ãxt2
:

516 
»t
 = 
	`bŒfs_Ãxt_™em
(
quÙa_roÙ
, 
·th
);

517 ià(
»t
 < 0)

518 
out
;

519 ià(
»t
)

522 
out
:

523 
	`bŒfs_ä“_·th
(
·th
);

524 
fs_šfo
->
qgroup_æags
 |ğ
æags
;

525 ià(!(
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_ON
))

526 
	`ş—r_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
);

527 ià(
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
 &&

528 
»t
 >= 0)

529 
»t
 = 
	`qgroup_»sÿn_š™
(
fs_šfo
, 
»sÿn_´og»ss
, 0);

531 ià(
»t
 < 0) {

532 
	`uli¡_ä“
(
fs_šfo
->
qgroup_uli¡
);

533 
fs_šfo
->
qgroup_uli¡
 = 
NULL
;

534 
fs_šfo
->
qgroup_æags
 &ğ~
BTRFS_QGROUP_STATUS_FLAG_RESCAN
;

535 
	`bŒfs_sysfs_d–_qgroups
(
fs_šfo
);

538  
»t
 < 0 ?„et : 0;

539 
	}
}

548 
boŞ
 
	$bŒfs_check_quÙa_Ëak
(
bŒfs_fs_šfo
 *
fs_šfo
)

550 
rb_node
 *
node
;

551 
boŞ
 
»t
 = 
çl£
;

553 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

554  
»t
;

560 
node
 = 
	`rb_fœ¡
(&
fs_šfo
->
qgroup_Œ“
);‚ode;‚odğ
	`rb_Ãxt
(node)) {

561 
bŒfs_qgroup
 *
qgroup
;

562 
i
;

564 
qgroup
 = 
	`rb_’Œy
(
node
, 
bŒfs_qgroup
,‚ode);

565 
i
 = 0; i < 
BTRFS_QGROUP_RSV_LAST
; i++) {

566 ià(
qgroup
->
rsv
.
v®ues
[
i
]) {

567 
»t
 = 
Œue
;

568 
	`bŒfs_w¬n
(
fs_šfo
,

570 
	`bŒfs_qgroup_Ëv–
(
qgroup
->
qgroupid
),

571 
	`bŒfs_qgroup_subvŞid
(
qgroup
->
qgroupid
),

572 
i
, 
qgroup
->
rsv
.
v®ues
[i]);

576  
»t
;

577 
	}
}

585 
	$bŒfs_ä“_qgroup_cÚfig
(
bŒfs_fs_šfo
 *
fs_šfo
)

587 
rb_node
 *
n
;

588 
bŒfs_qgroup
 *
qgroup
;

590 (
n
 = 
	`rb_fœ¡
(&
fs_šfo
->
qgroup_Œ“
))) {

591 
qgroup
 = 
	`rb_’Œy
(
n
, 
bŒfs_qgroup
, 
node
);

592 
	`rb_”a£
(
n
, &
fs_šfo
->
qgroup_Œ“
);

593 
	`__d–_qgroup_rb
(
fs_šfo
, 
qgroup
);

594 
	`bŒfs_sysfs_d–_Úe_qgroup
(
fs_šfo
, 
qgroup
);

595 
	`kä“
(
qgroup
);

602 
	`uli¡_ä“
(
fs_šfo
->
qgroup_uli¡
);

603 
fs_šfo
->
qgroup_uli¡
 = 
NULL
;

604 
	`bŒfs_sysfs_d–_qgroups
(
fs_šfo
);

605 
	}
}

607 
	$add_qgroup_»ÏtiÚ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
¤c
,

608 
u64
 
d¡
)

610 
»t
;

611 
bŒfs_roÙ
 *
quÙa_roÙ
 = 
Œªs
->
fs_šfo
->quota_root;

612 
bŒfs_·th
 *
·th
;

613 
bŒfs_key
 
key
;

615 
·th
 = 
	`bŒfs_®loc_·th
();

616 ià(!
·th
)

617  -
ENOMEM
;

619 
key
.
objeùid
 = 
¤c
;

620 
key
.
ty³
 = 
BTRFS_QGROUP_RELATION_KEY
;

621 
key
.
off£t
 = 
d¡
;

623 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
quÙa_roÙ
, 
·th
, &
key
, 0);

625 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·th
->
nodes
[0]);

627 
	`bŒfs_ä“_·th
(
·th
);

628  
»t
;

629 
	}
}

631 
	$d–_qgroup_»ÏtiÚ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
¤c
,

632 
u64
 
d¡
)

634 
»t
;

635 
bŒfs_roÙ
 *
quÙa_roÙ
 = 
Œªs
->
fs_šfo
->quota_root;

636 
bŒfs_·th
 *
·th
;

637 
bŒfs_key
 
key
;

639 
·th
 = 
	`bŒfs_®loc_·th
();

640 ià(!
·th
)

641  -
ENOMEM
;

643 
key
.
objeùid
 = 
¤c
;

644 
key
.
ty³
 = 
BTRFS_QGROUP_RELATION_KEY
;

645 
key
.
off£t
 = 
d¡
;

647 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
quÙa_roÙ
, &
key
, 
·th
, -1, 1);

648 ià(
»t
 < 0)

649 
out
;

651 ià(
»t
 > 0) {

652 
»t
 = -
ENOENT
;

653 
out
;

656 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
quÙa_roÙ
, 
·th
);

657 
out
:

658 
	`bŒfs_ä“_·th
(
·th
);

659  
»t
;

660 
	}
}

662 
	$add_qgroup_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

663 
bŒfs_roÙ
 *
quÙa_roÙ
, 
u64
 
qgroupid
)

665 
»t
;

666 
bŒfs_·th
 *
·th
;

667 
bŒfs_qgroup_šfo_™em
 *
qgroup_šfo
;

668 
bŒfs_qgroup_lim™_™em
 *
qgroup_lim™
;

669 
ex‹Á_bufãr
 *
Ëaf
;

670 
bŒfs_key
 
key
;

672 ià(
	`bŒfs_is_‹¡šg
(
quÙa_roÙ
->
fs_šfo
))

675 
·th
 = 
	`bŒfs_®loc_·th
();

676 ià(!
·th
)

677  -
ENOMEM
;

679 
key
.
objeùid
 = 0;

680 
key
.
ty³
 = 
BTRFS_QGROUP_INFO_KEY
;

681 
key
.
off£t
 = 
qgroupid
;

689 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
quÙa_roÙ
, 
·th
, &
key
,

690 (*
qgroup_šfo
));

691 ià(
»t
 &&„‘ !ğ-
EEXIST
)

692 
out
;

694 
Ëaf
 = 
·th
->
nodes
[0];

695 
qgroup_šfo
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

696 
bŒfs_qgroup_šfo_™em
);

697 
	`bŒfs_£t_qgroup_šfo_g’”©iÚ
(
Ëaf
, 
qgroup_šfo
, 
Œªs
->
Œªsid
);

698 
	`bŒfs_£t_qgroup_šfo_rãr
(
Ëaf
, 
qgroup_šfo
, 0);

699 
	`bŒfs_£t_qgroup_šfo_rãr_cm´
(
Ëaf
, 
qgroup_šfo
, 0);

700 
	`bŒfs_£t_qgroup_šfo_exş
(
Ëaf
, 
qgroup_šfo
, 0);

701 
	`bŒfs_£t_qgroup_šfo_exş_cm´
(
Ëaf
, 
qgroup_šfo
, 0);

703 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

705 
	`bŒfs_»Ëa£_·th
(
·th
);

707 
key
.
ty³
 = 
BTRFS_QGROUP_LIMIT_KEY
;

708 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
quÙa_roÙ
, 
·th
, &
key
,

709 (*
qgroup_lim™
));

710 ià(
»t
 &&„‘ !ğ-
EEXIST
)

711 
out
;

713 
Ëaf
 = 
·th
->
nodes
[0];

714 
qgroup_lim™
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

715 
bŒfs_qgroup_lim™_™em
);

716 
	`bŒfs_£t_qgroup_lim™_æags
(
Ëaf
, 
qgroup_lim™
, 0);

717 
	`bŒfs_£t_qgroup_lim™_max_rãr
(
Ëaf
, 
qgroup_lim™
, 0);

718 
	`bŒfs_£t_qgroup_lim™_max_exş
(
Ëaf
, 
qgroup_lim™
, 0);

719 
	`bŒfs_£t_qgroup_lim™_rsv_rãr
(
Ëaf
, 
qgroup_lim™
, 0);

720 
	`bŒfs_£t_qgroup_lim™_rsv_exş
(
Ëaf
, 
qgroup_lim™
, 0);

722 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

724 
»t
 = 0;

725 
out
:

726 
	`bŒfs_ä“_·th
(
·th
);

727  
»t
;

728 
	}
}

730 
	$d–_qgroup_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
qgroupid
)

732 
»t
;

733 
bŒfs_roÙ
 *
quÙa_roÙ
 = 
Œªs
->
fs_šfo
->quota_root;

734 
bŒfs_·th
 *
·th
;

735 
bŒfs_key
 
key
;

737 
·th
 = 
	`bŒfs_®loc_·th
();

738 ià(!
·th
)

739  -
ENOMEM
;

741 
key
.
objeùid
 = 0;

742 
key
.
ty³
 = 
BTRFS_QGROUP_INFO_KEY
;

743 
key
.
off£t
 = 
qgroupid
;

744 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
quÙa_roÙ
, &
key
, 
·th
, -1, 1);

745 ià(
»t
 < 0)

746 
out
;

748 ià(
»t
 > 0) {

749 
»t
 = -
ENOENT
;

750 
out
;

753 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
quÙa_roÙ
, 
·th
);

754 ià(
»t
)

755 
out
;

757 
	`bŒfs_»Ëa£_·th
(
·th
);

759 
key
.
ty³
 = 
BTRFS_QGROUP_LIMIT_KEY
;

760 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
quÙa_roÙ
, &
key
, 
·th
, -1, 1);

761 ià(
»t
 < 0)

762 
out
;

764 ià(
»t
 > 0) {

765 
»t
 = -
ENOENT
;

766 
out
;

769 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
quÙa_roÙ
, 
·th
);

771 
out
:

772 
	`bŒfs_ä“_·th
(
·th
);

773  
»t
;

774 
	}
}

776 
	$upd©e_qgroup_lim™_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

777 
bŒfs_qgroup
 *
qgroup
)

779 
bŒfs_roÙ
 *
quÙa_roÙ
 = 
Œªs
->
fs_šfo
->quota_root;

780 
bŒfs_·th
 *
·th
;

781 
bŒfs_key
 
key
;

782 
ex‹Á_bufãr
 *
l
;

783 
bŒfs_qgroup_lim™_™em
 *
qgroup_lim™
;

784 
»t
;

785 
¦Ù
;

787 
key
.
objeùid
 = 0;

788 
key
.
ty³
 = 
BTRFS_QGROUP_LIMIT_KEY
;

789 
key
.
off£t
 = 
qgroup
->
qgroupid
;

791 
·th
 = 
	`bŒfs_®loc_·th
();

792 ià(!
·th
)

793  -
ENOMEM
;

795 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
quÙa_roÙ
, &
key
, 
·th
, 0, 1);

796 ià(
»t
 > 0)

797 
»t
 = -
ENOENT
;

799 ià(
»t
)

800 
out
;

802 
l
 = 
·th
->
nodes
[0];

803 
¦Ù
 = 
·th
->
¦Ùs
[0];

804 
qgroup_lim™
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
, 
bŒfs_qgroup_lim™_™em
);

805 
	`bŒfs_£t_qgroup_lim™_æags
(
l
, 
qgroup_lim™
, 
qgroup
->
lim_æags
);

806 
	`bŒfs_£t_qgroup_lim™_max_rãr
(
l
, 
qgroup_lim™
, 
qgroup
->
max_rãr
);

807 
	`bŒfs_£t_qgroup_lim™_max_exş
(
l
, 
qgroup_lim™
, 
qgroup
->
max_exş
);

808 
	`bŒfs_£t_qgroup_lim™_rsv_rãr
(
l
, 
qgroup_lim™
, 
qgroup
->
rsv_rãr
);

809 
	`bŒfs_£t_qgroup_lim™_rsv_exş
(
l
, 
qgroup_lim™
, 
qgroup
->
rsv_exş
);

811 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
l
);

813 
out
:

814 
	`bŒfs_ä“_·th
(
·th
);

815  
»t
;

816 
	}
}

818 
	$upd©e_qgroup_šfo_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

819 
bŒfs_qgroup
 *
qgroup
)

821 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

822 
bŒfs_roÙ
 *
quÙa_roÙ
 = 
fs_šfo
->quota_root;

823 
bŒfs_·th
 *
·th
;

824 
bŒfs_key
 
key
;

825 
ex‹Á_bufãr
 *
l
;

826 
bŒfs_qgroup_šfo_™em
 *
qgroup_šfo
;

827 
»t
;

828 
¦Ù
;

830 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
))

833 
key
.
objeùid
 = 0;

834 
key
.
ty³
 = 
BTRFS_QGROUP_INFO_KEY
;

835 
key
.
off£t
 = 
qgroup
->
qgroupid
;

837 
·th
 = 
	`bŒfs_®loc_·th
();

838 ià(!
·th
)

839  -
ENOMEM
;

841 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
quÙa_roÙ
, &
key
, 
·th
, 0, 1);

842 ià(
»t
 > 0)

843 
»t
 = -
ENOENT
;

845 ià(
»t
)

846 
out
;

848 
l
 = 
·th
->
nodes
[0];

849 
¦Ù
 = 
·th
->
¦Ùs
[0];

850 
qgroup_šfo
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
, 
bŒfs_qgroup_šfo_™em
);

851 
	`bŒfs_£t_qgroup_šfo_g’”©iÚ
(
l
, 
qgroup_šfo
, 
Œªs
->
Œªsid
);

852 
	`bŒfs_£t_qgroup_šfo_rãr
(
l
, 
qgroup_šfo
, 
qgroup
->
rãr
);

853 
	`bŒfs_£t_qgroup_šfo_rãr_cm´
(
l
, 
qgroup_šfo
, 
qgroup
->
rãr_cm´
);

854 
	`bŒfs_£t_qgroup_šfo_exş
(
l
, 
qgroup_šfo
, 
qgroup
->
exş
);

855 
	`bŒfs_£t_qgroup_šfo_exş_cm´
(
l
, 
qgroup_šfo
, 
qgroup
->
exş_cm´
);

857 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
l
);

859 
out
:

860 
	`bŒfs_ä“_·th
(
·th
);

861  
»t
;

862 
	}
}

864 
	$upd©e_qgroup_¡©us_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
)

866 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

867 
bŒfs_roÙ
 *
quÙa_roÙ
 = 
fs_šfo
->quota_root;

868 
bŒfs_·th
 *
·th
;

869 
bŒfs_key
 
key
;

870 
ex‹Á_bufãr
 *
l
;

871 
bŒfs_qgroup_¡©us_™em
 *
±r
;

872 
»t
;

873 
¦Ù
;

875 
key
.
objeùid
 = 0;

876 
key
.
ty³
 = 
BTRFS_QGROUP_STATUS_KEY
;

877 
key
.
off£t
 = 0;

879 
·th
 = 
	`bŒfs_®loc_·th
();

880 ià(!
·th
)

881  -
ENOMEM
;

883 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
quÙa_roÙ
, &
key
, 
·th
, 0, 1);

884 ià(
»t
 > 0)

885 
»t
 = -
ENOENT
;

887 ià(
»t
)

888 
out
;

890 
l
 = 
·th
->
nodes
[0];

891 
¦Ù
 = 
·th
->
¦Ùs
[0];

892 
±r
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
, 
bŒfs_qgroup_¡©us_™em
);

893 
	`bŒfs_£t_qgroup_¡©us_æags
(
l
, 
±r
, 
fs_šfo
->
qgroup_æags
 &

894 
BTRFS_QGROUP_STATUS_FLAGS_MASK
);

895 
	`bŒfs_£t_qgroup_¡©us_g’”©iÚ
(
l
, 
±r
, 
Œªs
->
Œªsid
);

896 
	`bŒfs_£t_qgroup_¡©us_»sÿn
(
l
, 
±r
,

897 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
objeùid
);

899 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
l
);

901 
out
:

902 
	`bŒfs_ä“_·th
(
·th
);

903  
»t
;

904 
	}
}

909 
	$bŒfs_ş—n_quÙa_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

910 
bŒfs_roÙ
 *
roÙ
)

912 
bŒfs_·th
 *
·th
;

913 
bŒfs_key
 
key
;

914 
ex‹Á_bufãr
 *
Ëaf
 = 
NULL
;

915 
»t
;

916 
Ä
 = 0;

918 
·th
 = 
	`bŒfs_®loc_·th
();

919 ià(!
·th
)

920  -
ENOMEM
;

922 
key
.
objeùid
 = 0;

923 
key
.
off£t
 = 0;

924 
key
.
ty³
 = 0;

927 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

928 ià(
»t
 < 0)

929 
out
;

930 
Ëaf
 = 
·th
->
nodes
[0];

931 
Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

932 ià(!
Ä
)

939 
·th
->
¦Ùs
[0] = 0;

940 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
, 0, 
Ä
);

941 ià(
»t
)

942 
out
;

944 
	`bŒfs_»Ëa£_·th
(
·th
);

946 
»t
 = 0;

947 
out
:

948 
	`bŒfs_ä“_·th
(
·th
);

949  
»t
;

950 
	}
}

952 
	$bŒfs_quÙa_’abË
(
bŒfs_fs_šfo
 *
fs_šfo
)

954 
bŒfs_roÙ
 *
quÙa_roÙ
;

955 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

956 
bŒfs_·th
 *
·th
 = 
NULL
;

957 
bŒfs_qgroup_¡©us_™em
 *
±r
;

958 
ex‹Á_bufãr
 *
Ëaf
;

959 
bŒfs_key
 
key
;

960 
bŒfs_key
 
found_key
;

961 
bŒfs_qgroup
 *
qgroup
 = 
NULL
;

962 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

963 
uli¡
 *uli¡ = 
NULL
;

964 
»t
 = 0;

965 
¦Ù
;

973 
	`lockd•_as£¹_h–d_wr™e
(&
fs_šfo
->
subvŞ_£m
);

975 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
EXTENT_TREE_V2
)) {

976 
	`bŒfs_”r
(
fs_šfo
,

978  -
EINVAL
;

981 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

982 ià(
fs_šfo
->
quÙa_roÙ
)

983 
out
;

985 
uli¡
 = 
	`uli¡_®loc
(
GFP_KERNEL
);

986 ià(!
uli¡
) {

987 
»t
 = -
ENOMEM
;

988 
out
;

991 
»t
 = 
	`bŒfs_sysfs_add_qgroups
(
fs_šfo
);

992 ià(
»t
 < 0)

993 
out
;

1008 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1018 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
Œ“_roÙ
, 2);

1020 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1021 ià(
	`IS_ERR
(
Œªs
)) {

1022 
»t
 = 
	`PTR_ERR
(
Œªs
);

1023 
Œªs
 = 
NULL
;

1024 
out
;

1027 ià(
fs_šfo
->
quÙa_roÙ
)

1028 
out
;

1030 
fs_šfo
->
qgroup_uli¡
 = 
uli¡
;

1031 
uli¡
 = 
NULL
;

1036 
quÙa_roÙ
 = 
	`bŒfs_ü—‹_Œ“
(
Œªs
, 
BTRFS_QUOTA_TREE_OBJECTID
);

1037 ià(
	`IS_ERR
(
quÙa_roÙ
)) {

1038 
»t
 = 
	`PTR_ERR
(
quÙa_roÙ
);

1039 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1040 
out
;

1043 
·th
 = 
	`bŒfs_®loc_·th
();

1044 ià(!
·th
) {

1045 
»t
 = -
ENOMEM
;

1046 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1047 
out_ä“_roÙ
;

1050 
key
.
objeùid
 = 0;

1051 
key
.
ty³
 = 
BTRFS_QGROUP_STATUS_KEY
;

1052 
key
.
off£t
 = 0;

1054 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
quÙa_roÙ
, 
·th
, &
key
,

1055 (*
±r
));

1056 ià(
»t
) {

1057 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1058 
out_ä“_·th
;

1061 
Ëaf
 = 
·th
->
nodes
[0];

1062 
±r
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1063 
bŒfs_qgroup_¡©us_™em
);

1064 
	`bŒfs_£t_qgroup_¡©us_g’”©iÚ
(
Ëaf
, 
±r
, 
Œªs
->
Œªsid
);

1065 
	`bŒfs_£t_qgroup_¡©us_v”siÚ
(
Ëaf
, 
±r
, 
BTRFS_QGROUP_STATUS_VERSION
);

1066 
fs_šfo
->
qgroup_æags
 = 
BTRFS_QGROUP_STATUS_FLAG_ON
 |

1067 
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

1068 
	`bŒfs_£t_qgroup_¡©us_æags
(
Ëaf
, 
±r
, 
fs_šfo
->
qgroup_æags
 &

1069 
BTRFS_QGROUP_STATUS_FLAGS_MASK
);

1070 
	`bŒfs_£t_qgroup_¡©us_»sÿn
(
Ëaf
, 
±r
, 0);

1072 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

1074 
key
.
objeùid
 = 0;

1075 
key
.
ty³
 = 
BTRFS_ROOT_REF_KEY
;

1076 
key
.
off£t
 = 0;

1078 
	`bŒfs_»Ëa£_·th
(
·th
);

1079 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
Œ“_roÙ
, &
key
, 
·th
, 1, 0);

1080 ià(
»t
 > 0)

1081 
out_add_roÙ
;

1082 ià(
»t
 < 0) {

1083 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1084 
out_ä“_·th
;

1088 
¦Ù
 = 
·th
->
¦Ùs
[0];

1089 
Ëaf
 = 
·th
->
nodes
[0];

1090 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
¦Ù
);

1092 ià(
found_key
.
ty³
 =ğ
BTRFS_ROOT_REF_KEY
) {

1095 
	`bŒfs_»Ëa£_·th
(
·th
);

1097 
»t
 = 
	`add_qgroup_™em
(
Œªs
, 
quÙa_roÙ
,

1098 
found_key
.
off£t
);

1099 ià(
»t
) {

1100 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1101 
out_ä“_·th
;

1104 
qgroup
 = 
	`add_qgroup_rb
(
fs_šfo
, 
found_key
.
off£t
);

1105 ià(
	`IS_ERR
(
qgroup
)) {

1106 
»t
 = 
	`PTR_ERR
(
qgroup
);

1107 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1108 
out_ä“_·th
;

1110 
»t
 = 
	`bŒfs_sysfs_add_Úe_qgroup
(
fs_šfo
, 
qgroup
);

1111 ià(
»t
 < 0) {

1112 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1113 
out_ä“_·th
;

1115 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
Œ“_roÙ
, &
found_key
,

1116 
·th
, 1, 0);

1117 ià(
»t
 < 0) {

1118 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1119 
out_ä“_·th
;

1121 ià(
»t
 > 0) {

1130 
»t
 = 
	`bŒfs_Ãxt_™em
(
Œ“_roÙ
, 
·th
);

1131 ià(
»t
 < 0) {

1132 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1133 
out_ä“_·th
;

1135 ià(
»t
)

1139 
out_add_roÙ
:

1140 
	`bŒfs_»Ëa£_·th
(
·th
);

1141 
»t
 = 
	`add_qgroup_™em
(
Œªs
, 
quÙa_roÙ
, 
BTRFS_FS_TREE_OBJECTID
);

1142 ià(
»t
) {

1143 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1144 
out_ä“_·th
;

1147 
qgroup
 = 
	`add_qgroup_rb
(
fs_šfo
, 
BTRFS_FS_TREE_OBJECTID
);

1148 ià(
	`IS_ERR
(
qgroup
)) {

1149 
»t
 = 
	`PTR_ERR
(
qgroup
);

1150 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1151 
out_ä“_·th
;

1153 
»t
 = 
	`bŒfs_sysfs_add_Úe_qgroup
(
fs_šfo
, 
qgroup
);

1154 ià(
»t
 < 0) {

1155 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1156 
out_ä“_·th
;

1159 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1169 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1170 
Œªs
 = 
NULL
;

1171 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1172 ià(
»t
)

1173 
out_ä“_·th
;

1180 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

1181 
fs_šfo
->
quÙa_roÙ
 = quota_root;

1182 
	`£t_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
);

1183 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

1185 
»t
 = 
	`qgroup_»sÿn_š™
(
fs_šfo
, 0, 1);

1186 ià(!
»t
) {

1187 
	`qgroup_»sÿn_z”o_Œackšg
(
fs_šfo
);

1188 
fs_šfo
->
qgroup_»sÿn_ruÂšg
 = 
Œue
;

1189 
	`bŒfs_queue_wÜk
(
fs_šfo
->
qgroup_»sÿn_wÜk”s
,

1190 &
fs_šfo
->
qgroup_»sÿn_wÜk
);

1204 
	`ASSERT
(
»t
 =ğ-
EINPROGRESS
);

1205 
»t
 = 0;

1208 
out_ä“_·th
:

1209 
	`bŒfs_ä“_·th
(
·th
);

1210 
out_ä“_roÙ
:

1211 ià(
»t
)

1212 
	`bŒfs_put_roÙ
(
quÙa_roÙ
);

1213 
out
:

1214 ià(
»t
) {

1215 
	`uli¡_ä“
(
fs_šfo
->
qgroup_uli¡
);

1216 
fs_šfo
->
qgroup_uli¡
 = 
NULL
;

1217 
	`bŒfs_sysfs_d–_qgroups
(
fs_šfo
);

1219 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1220 ià(
»t
 && 
Œªs
)

1221 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1222 ià(
Œªs
)

1223 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1224 
	`uli¡_ä“
(
uli¡
);

1225  
»t
;

1226 
	}
}

1228 
	$bŒfs_quÙa_di§bË
(
bŒfs_fs_šfo
 *
fs_šfo
)

1230 
bŒfs_roÙ
 *
quÙa_roÙ
;

1231 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

1232 
»t
 = 0;

1238 
	`lockd•_as£¹_h–d_wr™e
(&
fs_šfo
->
subvŞ_£m
);

1250 
	`mu‹x_lock
(&
fs_šfo
->
ş—Ãr_mu‹x
);

1252 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1253 ià(!
fs_šfo
->
quÙa_roÙ
)

1254 
out
;

1262 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1269 
	`ş—r_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
);

1270 
	`bŒfs_qgroup_wa™_fÜ_com¶‘iÚ
(
fs_šfo
, 
çl£
);

1281 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
fs_šfo
->
Œ“_roÙ
, 1);

1283 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1284 ià(
	`IS_ERR
(
Œªs
)) {

1285 
»t
 = 
	`PTR_ERR
(
Œªs
);

1286 
Œªs
 = 
NULL
;

1287 
	`£t_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
);

1288 
out
;

1291 ià(!
fs_šfo
->
quÙa_roÙ
)

1292 
out
;

1294 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

1295 
quÙa_roÙ
 = 
fs_šfo
->quota_root;

1296 
fs_šfo
->
quÙa_roÙ
 = 
NULL
;

1297 
fs_šfo
->
qgroup_æags
 &ğ~
BTRFS_QGROUP_STATUS_FLAG_ON
;

1298 
fs_šfo
->
qgroup_drİ_subŒ“_th»s
 = 
BTRFS_MAX_LEVEL
;

1299 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

1301 
	`bŒfs_ä“_qgroup_cÚfig
(
fs_šfo
);

1303 
»t
 = 
	`bŒfs_ş—n_quÙa_Œ“
(
Œªs
, 
quÙa_roÙ
);

1304 ià(
»t
) {

1305 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1306 
out
;

1309 
»t
 = 
	`bŒfs_d–_roÙ
(
Œªs
, &
quÙa_roÙ
->
roÙ_key
);

1310 ià(
»t
) {

1311 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1312 
out
;

1315 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

1316 
	`li¡_d–
(&
quÙa_roÙ
->
dœty_li¡
);

1317 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1319 
	`bŒfs_Œ“_lock
(
quÙa_roÙ
->
node
);

1320 
	`bŒfs_ş—r_bufãr_dœty
(
Œªs
, 
quÙa_roÙ
->
node
);

1321 
	`bŒfs_Œ“_uÆock
(
quÙa_roÙ
->
node
);

1322 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
	`bŒfs_roÙ_id
(
quÙa_roÙ
),

1323 
quÙa_roÙ
->
node
, 0, 1);

1325 
	`bŒfs_put_roÙ
(
quÙa_roÙ
);

1327 
out
:

1328 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1329 ià(
»t
 && 
Œªs
)

1330 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1331 ià(
Œªs
)

1332 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1333 
	`mu‹x_uÆock
(&
fs_šfo
->
ş—Ãr_mu‹x
);

1335  
»t
;

1336 
	}
}

1338 
	$qgroup_dœty
(
bŒfs_fs_šfo
 *
fs_šfo
,

1339 
bŒfs_qgroup
 *
qgroup
)

1341 ià(
	`li¡_em±y
(&
qgroup
->
dœty
))

1342 
	`li¡_add
(&
qgroup
->
dœty
, &
fs_šfo
->
dœty_qgroups
);

1343 
	}
}

1359 
	$__qgroup_exş_accouÁšg
(
bŒfs_fs_šfo
 *
fs_šfo
,

1360 
uli¡
 *
tmp
, 
u64
 
»f_roÙ
,

1361 
bŒfs_qgroup
 *
¤c
, 
sign
)

1363 
bŒfs_qgroup
 *
qgroup
;

1364 
bŒfs_qgroup_li¡
 *
gli¡
;

1365 
uli¡_node
 *
unode
;

1366 
uli¡_™”©Ü
 
u™”
;

1367 
u64
 
num_by‹s
 = 
¤c
->
exş
;

1368 
»t
 = 0;

1370 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
»f_roÙ
);

1371 ià(!
qgroup
)

1372 
out
;

1374 
qgroup
->
rãr
 +ğ
sign
 * 
num_by‹s
;

1375 
qgroup
->
rãr_cm´
 +ğ
sign
 * 
num_by‹s
;

1377 
	`WARN_ON
(
sign
 < 0 && 
qgroup
->
exş
 < 
num_by‹s
);

1378 
qgroup
->
exş
 +ğ
sign
 * 
num_by‹s
;

1379 
qgroup
->
exş_cm´
 +ğ
sign
 * 
num_by‹s
;

1381 ià(
sign
 > 0)

1382 
	`qgroup_rsv_add_by_qgroup
(
fs_šfo
, 
qgroup
, 
¤c
);

1384 
	`qgroup_rsv_»Ëa£_by_qgroup
(
fs_šfo
, 
qgroup
, 
¤c
);

1386 
	`qgroup_dœty
(
fs_šfo
, 
qgroup
);

1389 
	`li¡_fÜ_—ch_’Œy
(
gli¡
, &
qgroup
->
groups
, 
Ãxt_group
) {

1390 
»t
 = 
	`uli¡_add
(
tmp
, 
gli¡
->
group
->
qgroupid
,

1391 
	`qgroup_to_aux
(
gli¡
->
group
), 
GFP_ATOMIC
);

1392 ià(
»t
 < 0)

1393 
out
;

1397 
	`ULIST_ITER_INIT
(&
u™”
);

1398 (
unode
 = 
	`uli¡_Ãxt
(
tmp
, &
u™”
))) {

1399 
qgroup
 = 
	`unode_aux_to_qgroup
(
unode
);

1400 
qgroup
->
rãr
 +ğ
sign
 * 
num_by‹s
;

1401 
qgroup
->
rãr_cm´
 +ğ
sign
 * 
num_by‹s
;

1402 
	`WARN_ON
(
sign
 < 0 && 
qgroup
->
exş
 < 
num_by‹s
);

1403 
qgroup
->
exş
 +ğ
sign
 * 
num_by‹s
;

1404 ià(
sign
 > 0)

1405 
	`qgroup_rsv_add_by_qgroup
(
fs_šfo
, 
qgroup
, 
¤c
);

1407 
	`qgroup_rsv_»Ëa£_by_qgroup
(
fs_šfo
, 
qgroup
, 
¤c
);

1408 
qgroup
->
exş_cm´
 +ğ
sign
 * 
num_by‹s
;

1409 
	`qgroup_dœty
(
fs_šfo
, 
qgroup
);

1412 
	`li¡_fÜ_—ch_’Œy
(
gli¡
, &
qgroup
->
groups
, 
Ãxt_group
) {

1413 
»t
 = 
	`uli¡_add
(
tmp
, 
gli¡
->
group
->
qgroupid
,

1414 
	`qgroup_to_aux
(
gli¡
->
group
), 
GFP_ATOMIC
);

1415 ià(
»t
 < 0)

1416 
out
;

1419 
»t
 = 0;

1420 
out
:

1421  
»t
;

1422 
	}
}

1436 
	$quick_upd©e_accouÁšg
(
bŒfs_fs_šfo
 *
fs_šfo
,

1437 
uli¡
 *
tmp
, 
u64
 
¤c
, u64 
d¡
,

1438 
sign
)

1440 
bŒfs_qgroup
 *
qgroup
;

1441 
»t
 = 1;

1442 
”r
 = 0;

1444 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
¤c
);

1445 ià(!
qgroup
)

1446 
out
;

1447 ià(
qgroup
->
exş
 =ğqgroup->
rãr
) {

1448 
»t
 = 0;

1449 
”r
 = 
	`__qgroup_exş_accouÁšg
(
fs_šfo
, 
tmp
, 
d¡
,

1450 
qgroup
, 
sign
);

1451 ià(
”r
 < 0) {

1452 
»t
 = 
”r
;

1453 
out
;

1456 
out
:

1457 ià(
»t
)

1458 
fs_šfo
->
qgroup_æags
 |ğ
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

1459  
»t
;

1460 
	}
}

1462 
	$bŒfs_add_qgroup_»ÏtiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
¤c
,

1463 
u64
 
d¡
)

1465 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1466 
bŒfs_qgroup
 *
·»Á
;

1467 
bŒfs_qgroup
 *
memb”
;

1468 
bŒfs_qgroup_li¡
 *
li¡
;

1469 
uli¡
 *
tmp
;

1470 
nofs_æag
;

1471 
»t
 = 0;

1474 ià(
	`bŒfs_qgroup_Ëv–
(
¤c
è>ğbŒfs_qgroup_Ëv–(
d¡
))

1475  -
EINVAL
;

1478 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

1479 
tmp
 = 
	`uli¡_®loc
(
GFP_KERNEL
);

1480 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

1481 ià(!
tmp
)

1482  -
ENOMEM
;

1484 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1485 ià(!
fs_šfo
->
quÙa_roÙ
) {

1486 
»t
 = -
ENOTCONN
;

1487 
out
;

1489 
memb”
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
¤c
);

1490 
·»Á
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
d¡
);

1491 ià(!
memb”
 || !
·»Á
) {

1492 
»t
 = -
EINVAL
;

1493 
out
;

1497 
	`li¡_fÜ_—ch_’Œy
(
li¡
, &
memb”
->
groups
, 
Ãxt_group
) {

1498 ià(
li¡
->
group
 =ğ
·»Á
) {

1499 
»t
 = -
EEXIST
;

1500 
out
;

1504 
»t
 = 
	`add_qgroup_»ÏtiÚ_™em
(
Œªs
, 
¤c
, 
d¡
);

1505 ià(
»t
)

1506 
out
;

1508 
»t
 = 
	`add_qgroup_»ÏtiÚ_™em
(
Œªs
, 
d¡
, 
¤c
);

1509 ià(
»t
) {

1510 
	`d–_qgroup_»ÏtiÚ_™em
(
Œªs
, 
¤c
, 
d¡
);

1511 
out
;

1514 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

1515 
»t
 = 
	`__add_»ÏtiÚ_rb
(
memb”
, 
·»Á
);

1516 ià(
»t
 < 0) {

1517 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

1518 
out
;

1520 
»t
 = 
	`quick_upd©e_accouÁšg
(
fs_šfo
, 
tmp
, 
¤c
, 
d¡
, 1);

1521 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

1522 
out
:

1523 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1524 
	`uli¡_ä“
(
tmp
);

1525  
»t
;

1526 
	}
}

1528 
	$__d–_qgroup_»ÏtiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
¤c
,

1529 
u64
 
d¡
)

1531 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1532 
bŒfs_qgroup
 *
·»Á
;

1533 
bŒfs_qgroup
 *
memb”
;

1534 
bŒfs_qgroup_li¡
 *
li¡
;

1535 
uli¡
 *
tmp
;

1536 
boŞ
 
found
 = 
çl£
;

1537 
nofs_æag
;

1538 
»t
 = 0;

1539 
»t2
;

1542 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

1543 
tmp
 = 
	`uli¡_®loc
(
GFP_KERNEL
);

1544 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

1545 ià(!
tmp
)

1546  -
ENOMEM
;

1548 ià(!
fs_šfo
->
quÙa_roÙ
) {

1549 
»t
 = -
ENOTCONN
;

1550 
out
;

1553 
memb”
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
¤c
);

1554 
·»Á
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
d¡
);

1559 ià(!
memb”
 || !
·»Á
)

1560 
d–‘e_™em
;

1563 
	`li¡_fÜ_—ch_’Œy
(
li¡
, &
memb”
->
groups
, 
Ãxt_group
) {

1564 ià(
li¡
->
group
 =ğ
·»Á
) {

1565 
found
 = 
Œue
;

1570 
d–‘e_™em
:

1571 
»t
 = 
	`d–_qgroup_»ÏtiÚ_™em
(
Œªs
, 
¤c
, 
d¡
);

1572 ià(
»t
 < 0 &&„‘ !ğ-
ENOENT
)

1573 
out
;

1574 
»t2
 = 
	`d–_qgroup_»ÏtiÚ_™em
(
Œªs
, 
d¡
, 
¤c
);

1575 ià(
»t2
 < 0 &&„‘2 !ğ-
ENOENT
)

1576 
out
;

1579 ià(!
»t
 || !
»t2
)

1580 
»t
 = 0;

1582 ià(
found
) {

1583 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

1584 
	`d–_»ÏtiÚ_rb
(
fs_šfo
, 
¤c
, 
d¡
);

1585 
»t
 = 
	`quick_upd©e_accouÁšg
(
fs_šfo
, 
tmp
, 
¤c
, 
d¡
, -1);

1586 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

1588 
out
:

1589 
	`uli¡_ä“
(
tmp
);

1590  
»t
;

1591 
	}
}

1593 
	$bŒfs_d–_qgroup_»ÏtiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
¤c
,

1594 
u64
 
d¡
)

1596 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1597 
»t
 = 0;

1599 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1600 
»t
 = 
	`__d–_qgroup_»ÏtiÚ
(
Œªs
, 
¤c
, 
d¡
);

1601 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1603  
»t
;

1604 
	}
}

1606 
	$bŒfs_ü—‹_qgroup
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
qgroupid
)

1608 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1609 
bŒfs_roÙ
 *
quÙa_roÙ
;

1610 
bŒfs_qgroup
 *
qgroup
;

1611 
»t
 = 0;

1613 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1614 ià(!
fs_šfo
->
quÙa_roÙ
) {

1615 
»t
 = -
ENOTCONN
;

1616 
out
;

1618 
quÙa_roÙ
 = 
fs_šfo
->quota_root;

1619 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
qgroupid
);

1620 ià(
qgroup
) {

1621 
»t
 = -
EEXIST
;

1622 
out
;

1625 
»t
 = 
	`add_qgroup_™em
(
Œªs
, 
quÙa_roÙ
, 
qgroupid
);

1626 ià(
»t
)

1627 
out
;

1629 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

1630 
qgroup
 = 
	`add_qgroup_rb
(
fs_šfo
, 
qgroupid
);

1631 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

1633 ià(
	`IS_ERR
(
qgroup
)) {

1634 
»t
 = 
	`PTR_ERR
(
qgroup
);

1635 
out
;

1637 
»t
 = 
	`bŒfs_sysfs_add_Úe_qgroup
(
fs_šfo
, 
qgroup
);

1638 
out
:

1639 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1640  
»t
;

1641 
	}
}

1643 
	$bŒfs_»move_qgroup
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
qgroupid
)

1645 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1646 
bŒfs_qgroup
 *
qgroup
;

1647 
bŒfs_qgroup_li¡
 *
li¡
;

1648 
»t
 = 0;

1650 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1651 ià(!
fs_šfo
->
quÙa_roÙ
) {

1652 
»t
 = -
ENOTCONN
;

1653 
out
;

1656 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
qgroupid
);

1657 ià(!
qgroup
) {

1658 
»t
 = -
ENOENT
;

1659 
out
;

1663 ià(!
	`li¡_em±y
(&
qgroup
->
memb”s
)) {

1664 
»t
 = -
EBUSY
;

1665 
out
;

1668 
»t
 = 
	`d–_qgroup_™em
(
Œªs
, 
qgroupid
);

1669 ià(
»t
 &&„‘ !ğ-
ENOENT
)

1670 
out
;

1672 !
	`li¡_em±y
(&
qgroup
->
groups
)) {

1673 
li¡
 = 
	`li¡_fœ¡_’Œy
(&
qgroup
->
groups
,

1674 
bŒfs_qgroup_li¡
, 
Ãxt_group
);

1675 
»t
 = 
	`__d–_qgroup_»ÏtiÚ
(
Œªs
, 
qgroupid
,

1676 
li¡
->
group
->
qgroupid
);

1677 ià(
»t
)

1678 
out
;

1681 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

1682 
	`d–_qgroup_rb
(
fs_šfo
, 
qgroupid
);

1683 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

1690 
	`bŒfs_sysfs_d–_Úe_qgroup
(
fs_šfo
, 
qgroup
);

1691 
	`kä“
(
qgroup
);

1692 
out
:

1693 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1694  
»t
;

1695 
	}
}

1697 
	$bŒfs_lim™_qgroup
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
qgroupid
,

1698 
bŒfs_qgroup_lim™
 *
lim™
)

1700 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1701 
bŒfs_qgroup
 *
qgroup
;

1702 
»t
 = 0;

1707 cÚ¡ 
u64
 
CLEAR_VALUE
 = -1;

1709 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1710 ià(!
fs_šfo
->
quÙa_roÙ
) {

1711 
»t
 = -
ENOTCONN
;

1712 
out
;

1715 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
qgroupid
);

1716 ià(!
qgroup
) {

1717 
»t
 = -
ENOENT
;

1718 
out
;

1721 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

1722 ià(
lim™
->
æags
 & 
BTRFS_QGROUP_LIMIT_MAX_RFER
) {

1723 ià(
lim™
->
max_rãr
 =ğ
CLEAR_VALUE
) {

1724 
qgroup
->
lim_æags
 &ğ~
BTRFS_QGROUP_LIMIT_MAX_RFER
;

1725 
lim™
->
æags
 &ğ~
BTRFS_QGROUP_LIMIT_MAX_RFER
;

1726 
qgroup
->
max_rãr
 = 0;

1728 
qgroup
->
max_rãr
 = 
lim™
->max_rfer;

1731 ià(
lim™
->
æags
 & 
BTRFS_QGROUP_LIMIT_MAX_EXCL
) {

1732 ià(
lim™
->
max_exş
 =ğ
CLEAR_VALUE
) {

1733 
qgroup
->
lim_æags
 &ğ~
BTRFS_QGROUP_LIMIT_MAX_EXCL
;

1734 
lim™
->
æags
 &ğ~
BTRFS_QGROUP_LIMIT_MAX_EXCL
;

1735 
qgroup
->
max_exş
 = 0;

1737 
qgroup
->
max_exş
 = 
lim™
->max_excl;

1740 ià(
lim™
->
æags
 & 
BTRFS_QGROUP_LIMIT_RSV_RFER
) {

1741 ià(
lim™
->
rsv_rãr
 =ğ
CLEAR_VALUE
) {

1742 
qgroup
->
lim_æags
 &ğ~
BTRFS_QGROUP_LIMIT_RSV_RFER
;

1743 
lim™
->
æags
 &ğ~
BTRFS_QGROUP_LIMIT_RSV_RFER
;

1744 
qgroup
->
rsv_rãr
 = 0;

1746 
qgroup
->
rsv_rãr
 = 
lim™
->rsv_rfer;

1749 ià(
lim™
->
æags
 & 
BTRFS_QGROUP_LIMIT_RSV_EXCL
) {

1750 ià(
lim™
->
rsv_exş
 =ğ
CLEAR_VALUE
) {

1751 
qgroup
->
lim_æags
 &ğ~
BTRFS_QGROUP_LIMIT_RSV_EXCL
;

1752 
lim™
->
æags
 &ğ~
BTRFS_QGROUP_LIMIT_RSV_EXCL
;

1753 
qgroup
->
rsv_exş
 = 0;

1755 
qgroup
->
rsv_exş
 = 
lim™
->rsv_excl;

1758 
qgroup
->
lim_æags
 |ğ
lim™
->
æags
;

1760 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

1762 
»t
 = 
	`upd©e_qgroup_lim™_™em
(
Œªs
, 
qgroup
);

1763 ià(
»t
) {

1764 
	`qgroup_m¬k_šcÚsi¡’t
(
fs_šfo
);

1765 
	`bŒfs_šfo
(
fs_šfo
, "unableo update quota†imit for %llu",

1766 
qgroupid
);

1769 
out
:

1770 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1771  
»t
;

1772 
	}
}

1774 
	$bŒfs_qgroup_Œaû_ex‹Á_nŞock
(
bŒfs_fs_šfo
 *
fs_šfo
,

1775 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

1776 
bŒfs_qgroup_ex‹Á_»cÜd
 *
»cÜd
)

1778 
rb_node
 **
p
 = &
d–ayed_»fs
->
dœty_ex‹Á_roÙ
.rb_node;

1779 
rb_node
 *
·»Á_node
 = 
NULL
;

1780 
bŒfs_qgroup_ex‹Á_»cÜd
 *
’Œy
;

1781 
u64
 
by‹Ä
 = 
»cÜd
->bytenr;

1783 
	`lockd•_as£¹_h–d
(&
d–ayed_»fs
->
lock
);

1784 
	`Œaû_bŒfs_qgroup_Œaû_ex‹Á
(
fs_šfo
, 
»cÜd
);

1786 *
p
) {

1787 
·»Á_node
 = *
p
;

1788 
’Œy
 = 
	`rb_’Œy
(
·»Á_node
, 
bŒfs_qgroup_ex‹Á_»cÜd
,

1789 
node
);

1790 ià(
by‹Ä
 < 
’Œy
->bytenr) {

1791 
p
 = &(*p)->
rb_Ëá
;

1792 } ià(
by‹Ä
 > 
’Œy
->bytenr) {

1793 
p
 = &(*p)->
rb_right
;

1795 ià(
»cÜd
->
d©a_rsv
 && !
’Œy
->data_rsv) {

1796 
’Œy
->
d©a_rsv
 = 
»cÜd
->data_rsv;

1797 
’Œy
->
d©a_rsv_»äoÙ
 =

1798 
»cÜd
->
d©a_rsv_»äoÙ
;

1804 
	`rb_lšk_node
(&
»cÜd
->
node
, 
·»Á_node
, 
p
);

1805 
	`rb_š£¹_cŞÜ
(&
»cÜd
->
node
, &
d–ayed_»fs
->
dœty_ex‹Á_roÙ
);

1807 
	}
}

1809 
	$bŒfs_qgroup_Œaû_ex‹Á_po¡
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1810 
bŒfs_qgroup_ex‹Á_»cÜd
 *
q»cÜd
)

1812 
bŒfs_back»f_w®k_ùx
 
ùx
 = { 0 };

1813 
»t
;

1834 
	`ASSERT
(
Œªs
 !ğ
NULL
);

1836 ià(
Œªs
->
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_RUNTIME_FLAG_NO_ACCOUNTING
)

1839 
ùx
.
by‹Ä
 = 
q»cÜd
->bytenr;

1840 
ùx
.
fs_šfo
 = 
Œªs
->fs_info;

1842 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
ùx
, 
Œue
);

1843 ià(
»t
 < 0) {

1844 
	`qgroup_m¬k_šcÚsi¡’t
(
Œªs
->
fs_šfo
);

1845 
	`bŒfs_w¬n
(
Œªs
->
fs_šfo
,

1847 
»t
);

1858 
q»cÜd
->
Şd_roÙs
 = 
ùx
.
roÙs
;

1860 
	}
}

1862 
	$bŒfs_qgroup_Œaû_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
by‹Ä
,

1863 
u64
 
num_by‹s
)

1865 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1866 
bŒfs_qgroup_ex‹Á_»cÜd
 *
»cÜd
;

1867 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

1868 
»t
;

1870 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
)

1871 || 
by‹Ä
 =ğ0 || 
num_by‹s
 == 0)

1873 
»cÜd
 = 
	`kz®loc
((*»cÜd), 
GFP_NOFS
);

1874 ià(!
»cÜd
)

1875  -
ENOMEM
;

1877 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

1878 
»cÜd
->
by‹Ä
 = bytenr;

1879 
»cÜd
->
num_by‹s
 =‚um_bytes;

1880 
»cÜd
->
Şd_roÙs
 = 
NULL
;

1882 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

1883 
»t
 = 
	`bŒfs_qgroup_Œaû_ex‹Á_nŞock
(
fs_šfo
, 
d–ayed_»fs
, 
»cÜd
);

1884 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

1885 ià(
»t
 > 0) {

1886 
	`kä“
(
»cÜd
);

1889  
	`bŒfs_qgroup_Œaû_ex‹Á_po¡
(
Œªs
, 
»cÜd
);

1890 
	}
}

1892 
	$bŒfs_qgroup_Œaû_Ëaf_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1893 
ex‹Á_bufãr
 *
eb
)

1895 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1896 
Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

1897 
i
, 
ex‹Á_ty³
, 
»t
;

1898 
bŒfs_key
 
key
;

1899 
bŒfs_fe_ex‹Á_™em
 *
fi
;

1900 
u64
 
by‹Ä
, 
num_by‹s
;

1903 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

1906 
i
 = 0; i < 
Ä
; i++) {

1907 
	`bŒfs_™em_key_to_ıu
(
eb
, &
key
, 
i
);

1909 ià(
key
.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

1912 
fi
 = 
	`bŒfs_™em_±r
(
eb
, 
i
, 
bŒfs_fe_ex‹Á_™em
);

1914 
ex‹Á_ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
eb
, 
fi
);

1916 ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
)

1919 
by‹Ä
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
eb
, 
fi
);

1920 ià(!
by‹Ä
)

1923 
num_by‹s
 = 
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
eb
, 
fi
);

1925 
»t
 = 
	`bŒfs_qgroup_Œaû_ex‹Á
(
Œªs
, 
by‹Ä
, 
num_by‹s
);

1926 ià(
»t
)

1927  
»t
;

1929 
	`cÚd_»sched
();

1931 
	}
}

1947 
	$adju¡_¦Ùs_upw¬ds
(
bŒfs_·th
 *
·th
, 
roÙ_Ëv–
)

1949 
Ëv–
 = 0;

1950 
Ä
, 
¦Ù
;

1951 
ex‹Á_bufãr
 *
eb
;

1953 ià(
roÙ_Ëv–
 == 0)

1956 
Ëv–
 <ğ
roÙ_Ëv–
) {

1957 
eb
 = 
·th
->
nodes
[
Ëv–
];

1958 
Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

1959 
·th
->
¦Ùs
[
Ëv–
]++;

1960 
¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
];

1961 ià(
¦Ù
 >ğ
Ä
 || 
Ëv–
 == 0) {

1967 ià(
Ëv–
 !ğ
roÙ_Ëv–
) {

1968 
	`bŒfs_Œ“_uÆock_rw
(
eb
, 
·th
->
locks
[
Ëv–
]);

1969 
·th
->
locks
[
Ëv–
] = 0;

1971 
	`ä“_ex‹Á_bufãr
(
eb
);

1972 
·th
->
nodes
[
Ëv–
] = 
NULL
;

1973 
·th
->
¦Ùs
[
Ëv–
] = 0;

1984 
Ëv–
++;

1987 
eb
 = 
·th
->
nodes
[
roÙ_Ëv–
];

1988 ià(
·th
->
¦Ùs
[
roÙ_Ëv–
] >ğ
	`bŒfs_h—d”_Ä™ems
(
eb
))

1992 
	}
}

2040 
	$qgroup_Œaû_ex‹Á_sw­
(
bŒfs_Œªs_hªdË
* 
Œªs
,

2041 
ex‹Á_bufãr
 *
¤c_eb
,

2042 
bŒfs_·th
 *
d¡_·th
,

2043 
d¡_Ëv–
, 
roÙ_Ëv–
,

2044 
boŞ
 
Œaû_Ëaf
)

2046 
bŒfs_key
 
key
;

2047 
bŒfs_·th
 *
¤c_·th
;

2048 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2049 
u32
 
nodesize
 = 
fs_šfo
->nodesize;

2050 
cur_Ëv–
 = 
roÙ_Ëv–
;

2051 
»t
;

2053 
	`BUG_ON
(
d¡_Ëv–
 > 
roÙ_Ëv–
);

2055 ià(
	`bŒfs_h—d”_Ëv–
(
¤c_eb
è!ğ
roÙ_Ëv–
)

2056  -
EINVAL
;

2058 
¤c_·th
 = 
	`bŒfs_®loc_·th
();

2059 ià(!
¤c_·th
) {

2060 
»t
 = -
ENOMEM
;

2061 
out
;

2064 ià(
d¡_Ëv–
)

2065 
	`bŒfs_node_key_to_ıu
(
d¡_·th
->
nodes
[
d¡_Ëv–
], &
key
, 0);

2067 
	`bŒfs_™em_key_to_ıu
(
d¡_·th
->
nodes
[
d¡_Ëv–
], &
key
, 0);

2070 
	`©omic_šc
(&
¤c_eb
->
»fs
);

2071 
¤c_·th
->
nodes
[
roÙ_Ëv–
] = 
¤c_eb
;

2072 
¤c_·th
->
¦Ùs
[
roÙ_Ëv–
] = 
d¡_·th
->slots[root_level];

2073 
¤c_·th
->
locks
[
roÙ_Ëv–
] = 0;

2076 
cur_Ëv–
 >ğ
d¡_Ëv–
) {

2077 
bŒfs_key
 
¤c_key
;

2078 
bŒfs_key
 
d¡_key
;

2080 ià(
¤c_·th
->
nodes
[
cur_Ëv–
] =ğ
NULL
) {

2081 
ex‹Á_bufãr
 *
eb
;

2082 
·»Á_¦Ù
;

2084 
eb
 = 
¤c_·th
->
nodes
[
cur_Ëv–
 + 1];

2085 
·»Á_¦Ù
 = 
¤c_·th
->
¦Ùs
[
cur_Ëv–
 + 1];

2087 
eb
 = 
	`bŒfs_»ad_node_¦Ù
Ób, 
·»Á_¦Ù
);

2088 ià(
	`IS_ERR
(
eb
)) {

2089 
»t
 = 
	`PTR_ERR
(
eb
);

2090 
out
;

2093 
¤c_·th
->
nodes
[
cur_Ëv–
] = 
eb
;

2095 
	`bŒfs_Œ“_»ad_lock
(
eb
);

2096 
¤c_·th
->
locks
[
cur_Ëv–
] = 
BTRFS_READ_LOCK
;

2099 
¤c_·th
->
¦Ùs
[
cur_Ëv–
] = 
d¡_·th
->slots[cur_level];

2100 ià(
cur_Ëv–
) {

2101 
	`bŒfs_node_key_to_ıu
(
d¡_·th
->
nodes
[
cur_Ëv–
],

2102 &
d¡_key
, 
d¡_·th
->
¦Ùs
[
cur_Ëv–
]);

2103 
	`bŒfs_node_key_to_ıu
(
¤c_·th
->
nodes
[
cur_Ëv–
],

2104 &
¤c_key
, 
¤c_·th
->
¦Ùs
[
cur_Ëv–
]);

2106 
	`bŒfs_™em_key_to_ıu
(
d¡_·th
->
nodes
[
cur_Ëv–
],

2107 &
d¡_key
, 
d¡_·th
->
¦Ùs
[
cur_Ëv–
]);

2108 
	`bŒfs_™em_key_to_ıu
(
¤c_·th
->
nodes
[
cur_Ëv–
],

2109 &
¤c_key
, 
¤c_·th
->
¦Ùs
[
cur_Ëv–
]);

2112 ià(
	`bŒfs_comp_ıu_keys
(&
d¡_key
, &
¤c_key
)) {

2113 
»t
 = -
ENOENT
;

2114 
out
;

2116 
cur_Ëv–
--;

2123 
»t
 = 
	`bŒfs_qgroup_Œaû_ex‹Á
(
Œªs
, 
¤c_·th
->
nodes
[
d¡_Ëv–
]->
¡¬t
,

2124 
nodesize
);

2125 ià(
»t
 < 0)

2126 
out
;

2127 
»t
 = 
	`bŒfs_qgroup_Œaû_ex‹Á
(
Œªs
, 
d¡_·th
->
nodes
[
d¡_Ëv–
]->
¡¬t
,

2128 
nodesize
);

2129 ià(
»t
 < 0)

2130 
out
;

2133 ià(
d¡_Ëv–
 =ğ0 && 
Œaû_Ëaf
) {

2134 
»t
 = 
	`bŒfs_qgroup_Œaû_Ëaf_™ems
(
Œªs
, 
¤c_·th
->
nodes
[0]);

2135 ià(
»t
 < 0)

2136 
out
;

2137 
»t
 = 
	`bŒfs_qgroup_Œaû_Ëaf_™ems
(
Œªs
, 
d¡_·th
->
nodes
[0]);

2139 
out
:

2140 
	`bŒfs_ä“_·th
(
¤c_·th
);

2141  
»t
;

2142 
	}
}

2166 
	$qgroup_Œaû_Ãw_subŒ“_blocks
(
bŒfs_Œªs_hªdË
* 
Œªs
,

2167 
ex‹Á_bufãr
 *
¤c_eb
,

2168 
bŒfs_·th
 *
d¡_·th
,

2169 
cur_Ëv–
, 
roÙ_Ëv–
,

2170 
u64
 
Ï¡_¢­shÙ
, 
boŞ
 
Œaû_Ëaf
)

2172 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2173 
ex‹Á_bufãr
 *
eb
;

2174 
boŞ
 
Ãed_ş—nup
 = 
çl£
;

2175 
»t
 = 0;

2176 
i
;

2179 ià(
cur_Ëv–
 < 0 || cur_Ëv– >ğ
BTRFS_MAX_LEVEL
 - 1 ||

2180 
roÙ_Ëv–
 < 0 ||„oÙ_Ëv– >ğ
BTRFS_MAX_LEVEL
 - 1 ||

2181 
roÙ_Ëv–
 < 
cur_Ëv–
) {

2182 
	`bŒfs_”r_¾
(
fs_šfo
,

2184 
__func__
, 
cur_Ëv–
, 
roÙ_Ëv–
);

2185  -
EUCLEAN
;

2189 ià(
d¡_·th
->
nodes
[
cur_Ëv–
] =ğ
NULL
) {

2190 
·»Á_¦Ù
;

2191 
u64
 
chd_g’
;

2197 ià(
cur_Ëv–
 =ğ
roÙ_Ëv–
) {

2198 
	`bŒfs_”r_¾
(
fs_šfo
,

2200 
__func__
, 
roÙ_Ëv–
,„oÙ_Ëv–, 
cur_Ëv–
);

2201  -
EUCLEAN
;

2208 
eb
 = 
d¡_·th
->
nodes
[
cur_Ëv–
 + 1];

2209 
·»Á_¦Ù
 = 
d¡_·th
->
¦Ùs
[
cur_Ëv–
 + 1];

2210 
chd_g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
eb
, 
·»Á_¦Ù
);

2213 ià(
chd_g’
 < 
Ï¡_¢­shÙ
)

2214 
out
;

2216 
eb
 = 
	`bŒfs_»ad_node_¦Ù
Ób, 
·»Á_¦Ù
);

2217 ià(
	`IS_ERR
(
eb
)) {

2218 
»t
 = 
	`PTR_ERR
(
eb
);

2219 
out
;

2222 
d¡_·th
->
nodes
[
cur_Ëv–
] = 
eb
;

2223 
d¡_·th
->
¦Ùs
[
cur_Ëv–
] = 0;

2225 
	`bŒfs_Œ“_»ad_lock
(
eb
);

2226 
d¡_·th
->
locks
[
cur_Ëv–
] = 
BTRFS_READ_LOCK
;

2227 
Ãed_ş—nup
 = 
Œue
;

2231 
»t
 = 
	`qgroup_Œaû_ex‹Á_sw­
(
Œªs
, 
¤c_eb
, 
d¡_·th
, 
cur_Ëv–
,

2232 
roÙ_Ëv–
, 
Œaû_Ëaf
);

2233 ià(
»t
 < 0)

2234 
ş—nup
;

2236 
eb
 = 
d¡_·th
->
nodes
[
cur_Ëv–
];

2238 ià(
cur_Ëv–
 > 0) {

2240 
i
 = 0; i < 
	`bŒfs_h—d”_Ä™ems
(
eb
); i++) {

2242 ià(
	`bŒfs_node_±r_g’”©iÚ
(
eb
, 
i
è< 
Ï¡_¢­shÙ
)

2244 
d¡_·th
->
¦Ùs
[
cur_Ëv–
] = 
i
;

2247 
»t
 = 
	`qgroup_Œaû_Ãw_subŒ“_blocks
(
Œªs
, 
¤c_eb
,

2248 
d¡_·th
, 
cur_Ëv–
 - 1, 
roÙ_Ëv–
,

2249 
Ï¡_¢­shÙ
, 
Œaû_Ëaf
);

2250 ià(
»t
 < 0)

2251 
ş—nup
;

2255 
ş—nup
:

2256 ià(
Ãed_ş—nup
) {

2258 
	`bŒfs_Œ“_uÆock_rw
(
d¡_·th
->
nodes
[
cur_Ëv–
],

2259 
d¡_·th
->
locks
[
cur_Ëv–
]);

2260 
	`ä“_ex‹Á_bufãr
(
d¡_·th
->
nodes
[
cur_Ëv–
]);

2261 
d¡_·th
->
nodes
[
cur_Ëv–
] = 
NULL
;

2262 
d¡_·th
->
¦Ùs
[
cur_Ëv–
] = 0;

2263 
d¡_·th
->
locks
[
cur_Ëv–
] = 0;

2265 
out
:

2266  
»t
;

2267 
	}
}

2269 
	$qgroup_Œaû_subŒ“_sw­
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2270 
ex‹Á_bufãr
 *
¤c_eb
,

2271 
ex‹Á_bufãr
 *
d¡_eb
,

2272 
u64
 
Ï¡_¢­shÙ
, 
boŞ
 
Œaû_Ëaf
)

2274 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2275 
bŒfs_·th
 *
d¡_·th
 = 
NULL
;

2276 
Ëv–
;

2277 
»t
;

2279 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

2283 ià(
	`bŒfs_h—d”_g’”©iÚ
(
¤c_eb
è> bŒfs_h—d”_g’”©iÚ(
d¡_eb
)) {

2284 
	`bŒfs_”r_¾
(
fs_šfo
,

2285 "%s: bad…¬am‘” ord”, src_g’=%Îu d¡_g’=%Îu", 
__func__
,

2286 
	`bŒfs_h—d”_g’”©iÚ
(
¤c_eb
),

2287 
	`bŒfs_h—d”_g’”©iÚ
(
d¡_eb
));

2288  -
EUCLEAN
;

2291 ià(!
	`ex‹Á_bufãr_u±od©e
(
¤c_eb
è|| !ex‹Á_bufãr_u±od©e(
d¡_eb
)) {

2292 
»t
 = -
EIO
;

2293 
out
;

2296 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
d¡_eb
);

2297 
d¡_·th
 = 
	`bŒfs_®loc_·th
();

2298 ià(!
d¡_·th
) {

2299 
»t
 = -
ENOMEM
;

2300 
out
;

2303 
	`©omic_šc
(&
d¡_eb
->
»fs
);

2304 
d¡_·th
->
nodes
[
Ëv–
] = 
d¡_eb
;

2305 
d¡_·th
->
¦Ùs
[
Ëv–
] = 0;

2306 
d¡_·th
->
locks
[
Ëv–
] = 0;

2309 
»t
 = 
	`qgroup_Œaû_Ãw_subŒ“_blocks
(
Œªs
, 
¤c_eb
, 
d¡_·th
, 
Ëv–
,

2310 
Ëv–
, 
Ï¡_¢­shÙ
, 
Œaû_Ëaf
);

2311 ià(
»t
 < 0)

2312 
out
;

2313 
»t
 = 0;

2315 
out
:

2316 
	`bŒfs_ä“_·th
(
d¡_·th
);

2317 ià(
»t
 < 0)

2318 
	`qgroup_m¬k_šcÚsi¡’t
(
fs_šfo
);

2319  
»t
;

2320 
	}
}

2322 
	$bŒfs_qgroup_Œaû_subŒ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2323 
ex‹Á_bufãr
 *
roÙ_eb
,

2324 
u64
 
roÙ_g’
, 
roÙ_Ëv–
)

2326 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2327 
»t
 = 0;

2328 
Ëv–
;

2329 
u8
 
drİ_sub±»e_th»s
;

2330 
ex‹Á_bufãr
 *
eb
 = 
roÙ_eb
;

2331 
bŒfs_·th
 *
·th
 = 
NULL
;

2333 
	`BUG_ON
(
roÙ_Ëv–
 < 0 ||„oÙ_Ëv– >ğ
BTRFS_MAX_LEVEL
);

2334 
	`BUG_ON
(
roÙ_eb
 =ğ
NULL
);

2336 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

2339 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2340 
drİ_sub±»e_th»s
 = 
fs_šfo
->
qgroup_drİ_subŒ“_th»s
;

2341 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2351 ià(
roÙ_Ëv–
 >ğ
drİ_sub±»e_th»s
) {

2352 
	`qgroup_m¬k_šcÚsi¡’t
(
fs_šfo
);

2356 ià(!
	`ex‹Á_bufãr_u±od©e
(
roÙ_eb
)) {

2357 
bŒfs_Œ“_·»Á_check
 
check
 = {

2358 .
has_fœ¡_key
 = 
çl£
,

2359 .
Œªsid
 = 
roÙ_g’
,

2360 .
Ëv–
 = 
roÙ_Ëv–


2363 
»t
 = 
	`bŒfs_»ad_ex‹Á_bufãr
(
roÙ_eb
, &
check
);

2364 ià(
»t
)

2365 
out
;

2368 ià(
roÙ_Ëv–
 == 0) {

2369 
»t
 = 
	`bŒfs_qgroup_Œaû_Ëaf_™ems
(
Œªs
, 
roÙ_eb
);

2370 
out
;

2373 
·th
 = 
	`bŒfs_®loc_·th
();

2374 ià(!
·th
)

2375  -
ENOMEM
;

2386 
	`©omic_šc
(&
roÙ_eb
->
»fs
);

2387 
·th
->
nodes
[
roÙ_Ëv–
] = 
roÙ_eb
;

2388 
·th
->
¦Ùs
[
roÙ_Ëv–
] = 0;

2389 
·th
->
locks
[
roÙ_Ëv–
] = 0;

2390 
w®k_down
:

2391 
Ëv–
 = 
roÙ_Ëv–
;

2392 
Ëv–
 >= 0) {

2393 ià(
·th
->
nodes
[
Ëv–
] =ğ
NULL
) {

2394 
·»Á_¦Ù
;

2395 
u64
 
chd_by‹Ä
;

2401 
eb
 = 
·th
->
nodes
[
Ëv–
 + 1];

2402 
·»Á_¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
 + 1];

2403 
chd_by‹Ä
 = 
	`bŒfs_node_block±r
(
eb
, 
·»Á_¦Ù
);

2405 
eb
 = 
	`bŒfs_»ad_node_¦Ù
Ób, 
·»Á_¦Ù
);

2406 ià(
	`IS_ERR
(
eb
)) {

2407 
»t
 = 
	`PTR_ERR
(
eb
);

2408 
out
;

2411 
·th
->
nodes
[
Ëv–
] = 
eb
;

2412 
·th
->
¦Ùs
[
Ëv–
] = 0;

2414 
	`bŒfs_Œ“_»ad_lock
(
eb
);

2415 
·th
->
locks
[
Ëv–
] = 
BTRFS_READ_LOCK
;

2417 
»t
 = 
	`bŒfs_qgroup_Œaû_ex‹Á
(
Œªs
, 
chd_by‹Ä
,

2418 
fs_šfo
->
nodesize
);

2419 ià(
»t
)

2420 
out
;

2423 ià(
Ëv–
 == 0) {

2424 
»t
 = 
	`bŒfs_qgroup_Œaû_Ëaf_™ems
(
Œªs
,

2425 
·th
->
nodes
[
Ëv–
]);

2426 ià(
»t
)

2427 
out
;

2430 
»t
 = 
	`adju¡_¦Ùs_upw¬ds
(
·th
, 
roÙ_Ëv–
);

2431 ià(
»t
)

2435 
w®k_down
;

2438 
Ëv–
--;

2441 
»t
 = 0;

2442 
out
:

2443 
	`bŒfs_ä“_·th
(
·th
);

2445  
»t
;

2446 
	}
}

2448 
	#UPDATE_NEW
 0

	)

2449 
	#UPDATE_OLD
 1

	)

2453 
	$qgroup_upd©e_»fút
(
bŒfs_fs_šfo
 *
fs_šfo
,

2454 
uli¡
 *
roÙs
, uli¡ *
tmp
,

2455 
uli¡
 *
qgroups
, 
u64
 
£q
, 
upd©e_Şd
)

2457 
uli¡_node
 *
unode
;

2458 
uli¡_™”©Ü
 
u™”
;

2459 
uli¡_node
 *
tmp_unode
;

2460 
uli¡_™”©Ü
 
tmp_u™”
;

2461 
bŒfs_qgroup
 *
qg
;

2462 
»t
 = 0;

2464 ià(!
roÙs
)

2466 
	`ULIST_ITER_INIT
(&
u™”
);

2467 (
unode
 = 
	`uli¡_Ãxt
(
roÙs
, &
u™”
))) {

2468 
qg
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
unode
->
v®
);

2469 ià(!
qg
)

2472 
	`uli¡_»š™
(
tmp
);

2473 
»t
 = 
	`uli¡_add
(
qgroups
, 
qg
->
qgroupid
, 
	`qgroup_to_aux
(qg),

2474 
GFP_ATOMIC
);

2475 ià(
»t
 < 0)

2476  
»t
;

2477 
»t
 = 
	`uli¡_add
(
tmp
, 
qg
->
qgroupid
, 
	`qgroup_to_aux
(qg), 
GFP_ATOMIC
);

2478 ià(
»t
 < 0)

2479  
»t
;

2480 
	`ULIST_ITER_INIT
(&
tmp_u™”
);

2481 (
tmp_unode
 = 
	`uli¡_Ãxt
(
tmp
, &
tmp_u™”
))) {

2482 
bŒfs_qgroup_li¡
 *
gli¡
;

2484 
qg
 = 
	`unode_aux_to_qgroup
(
tmp_unode
);

2485 ià(
upd©e_Şd
)

2486 
	`bŒfs_qgroup_upd©e_Şd_»fút
(
qg
, 
£q
, 1);

2488 
	`bŒfs_qgroup_upd©e_Ãw_»fút
(
qg
, 
£q
, 1);

2489 
	`li¡_fÜ_—ch_’Œy
(
gli¡
, &
qg
->
groups
, 
Ãxt_group
) {

2490 
»t
 = 
	`uli¡_add
(
qgroups
, 
gli¡
->
group
->
qgroupid
,

2491 
	`qgroup_to_aux
(
gli¡
->
group
),

2492 
GFP_ATOMIC
);

2493 ià(
»t
 < 0)

2494  
»t
;

2495 
»t
 = 
	`uli¡_add
(
tmp
, 
gli¡
->
group
->
qgroupid
,

2496 
	`qgroup_to_aux
(
gli¡
->
group
),

2497 
GFP_ATOMIC
);

2498 ià(
»t
 < 0)

2499  
»t
;

2504 
	}
}

2542 
	$qgroup_upd©e_couÁ”s
(
bŒfs_fs_šfo
 *
fs_šfo
,

2543 
uli¡
 *
qgroups
,

2544 
u64
 
Ä_Şd_roÙs
,

2545 
u64
 
Ä_Ãw_roÙs
,

2546 
u64
 
num_by‹s
, u64 
£q
)

2548 
uli¡_node
 *
unode
;

2549 
uli¡_™”©Ü
 
u™”
;

2550 
bŒfs_qgroup
 *
qg
;

2551 
u64
 
cur_Ãw_couÁ
, 
cur_Şd_couÁ
;

2553 
	`ULIST_ITER_INIT
(&
u™”
);

2554 (
unode
 = 
	`uli¡_Ãxt
(
qgroups
, &
u™”
))) {

2555 
boŞ
 
dœty
 = 
çl£
;

2557 
qg
 = 
	`unode_aux_to_qgroup
(
unode
);

2558 
cur_Şd_couÁ
 = 
	`bŒfs_qgroup_g‘_Şd_»fút
(
qg
, 
£q
);

2559 
cur_Ãw_couÁ
 = 
	`bŒfs_qgroup_g‘_Ãw_»fút
(
qg
, 
£q
);

2561 
	`Œaû_qgroup_upd©e_couÁ”s
(
fs_šfo
, 
qg
, 
cur_Şd_couÁ
,

2562 
cur_Ãw_couÁ
);

2565 ià(
cur_Şd_couÁ
 =ğ0 && 
cur_Ãw_couÁ
 > 0) {

2566 
qg
->
rãr
 +ğ
num_by‹s
;

2567 
qg
->
rãr_cm´
 +ğ
num_by‹s
;

2568 
dœty
 = 
Œue
;

2570 ià(
cur_Şd_couÁ
 > 0 && 
cur_Ãw_couÁ
 == 0) {

2571 
qg
->
rãr
 -ğ
num_by‹s
;

2572 
qg
->
rãr_cm´
 -ğ
num_by‹s
;

2573 
dœty
 = 
Œue
;

2578 ià(
cur_Şd_couÁ
 =ğ
Ä_Şd_roÙs
 &&

2579 
cur_Ãw_couÁ
 < 
Ä_Ãw_roÙs
) {

2581 ià(
cur_Şd_couÁ
 != 0) {

2582 
qg
->
exş
 -ğ
num_by‹s
;

2583 
qg
->
exş_cm´
 -ğ
num_by‹s
;

2584 
dœty
 = 
Œue
;

2589 ià(
cur_Şd_couÁ
 < 
Ä_Şd_roÙs
 &&

2590 
cur_Ãw_couÁ
 =ğ
Ä_Ãw_roÙs
) {

2592 ià(
cur_Ãw_couÁ
 != 0) {

2593 
qg
->
exş
 +ğ
num_by‹s
;

2594 
qg
->
exş_cm´
 +ğ
num_by‹s
;

2595 
dœty
 = 
Œue
;

2600 ià(
cur_Şd_couÁ
 =ğ
Ä_Şd_roÙs
 &&

2601 
cur_Ãw_couÁ
 =ğ
Ä_Ãw_roÙs
) {

2602 ià(
cur_Şd_couÁ
 == 0) {

2605 ià(
cur_Ãw_couÁ
 != 0) {

2607 
qg
->
exş
 +ğ
num_by‹s
;

2608 
qg
->
exş_cm´
 +ğ
num_by‹s
;

2609 
dœty
 = 
Œue
;

2615 ià(
cur_Ãw_couÁ
 == 0) {

2617 
qg
->
exş
 -ğ
num_by‹s
;

2618 
qg
->
exş_cm´
 -ğ
num_by‹s
;

2619 
dœty
 = 
Œue
;

2625 ià(
dœty
)

2626 
	`qgroup_dœty
(
fs_šfo
, 
qg
);

2629 
	}
}

2638 
	$maybe_fs_roÙs
(
uli¡
 *
roÙs
)

2640 
uli¡_node
 *
unode
;

2641 
uli¡_™”©Ü
 
u™”
;

2644 ià(!
roÙs
 ||„oÙs->
Âodes
 == 0)

2647 
	`ULIST_ITER_INIT
(&
u™”
);

2648 
unode
 = 
	`uli¡_Ãxt
(
roÙs
, &
u™”
);

2649 ià(!
unode
)

2657  
	`is_f¡»e
(
unode
->
v®
);

2658 
	}
}

2660 
	$bŒfs_qgroup_accouÁ_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
by‹Ä
,

2661 
u64
 
num_by‹s
, 
uli¡
 *
Şd_roÙs
,

2662 
uli¡
 *
Ãw_roÙs
)

2664 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2665 
uli¡
 *
qgroups
 = 
NULL
;

2666 
uli¡
 *
tmp
 = 
NULL
;

2667 
u64
 
£q
;

2668 
u64
 
Ä_Ãw_roÙs
 = 0;

2669 
u64
 
Ä_Şd_roÙs
 = 0;

2670 
»t
 = 0;

2676 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
) ||

2677 
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_RUNTIME_FLAG_NO_ACCOUNTING
)

2678 
out_ä“
;

2680 ià(
Ãw_roÙs
) {

2681 ià(!
	`maybe_fs_roÙs
(
Ãw_roÙs
))

2682 
out_ä“
;

2683 
Ä_Ãw_roÙs
 = 
Ãw_roÙs
->
Âodes
;

2685 ià(
Şd_roÙs
) {

2686 ià(!
	`maybe_fs_roÙs
(
Şd_roÙs
))

2687 
out_ä“
;

2688 
Ä_Şd_roÙs
 = 
Şd_roÙs
->
Âodes
;

2692 ià(
Ä_Şd_roÙs
 =ğ0 && 
Ä_Ãw_roÙs
 == 0)

2693 
out_ä“
;

2695 
	`BUG_ON
(!
fs_šfo
->
quÙa_roÙ
);

2697 
	`Œaû_bŒfs_qgroup_accouÁ_ex‹Á
(
fs_šfo
, 
Œªs
->
Œªsid
, 
by‹Ä
,

2698 
num_by‹s
, 
Ä_Şd_roÙs
, 
Ä_Ãw_roÙs
);

2700 
qgroups
 = 
	`uli¡_®loc
(
GFP_NOFS
);

2701 ià(!
qgroups
) {

2702 
»t
 = -
ENOMEM
;

2703 
out_ä“
;

2705 
tmp
 = 
	`uli¡_®loc
(
GFP_NOFS
);

2706 ià(!
tmp
) {

2707 
»t
 = -
ENOMEM
;

2708 
out_ä“
;

2711 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2712 ià(
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
) {

2713 ià(
fs_šfo
->
qgroup_»sÿn_´og»ss
.
objeùid
 <ğ
by‹Ä
) {

2714 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2715 
»t
 = 0;

2716 
out_ä“
;

2719 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2721 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2722 
£q
 = 
fs_šfo
->
qgroup_£q
;

2725 
»t
 = 
	`qgroup_upd©e_»fút
(
fs_šfo
, 
Şd_roÙs
, 
tmp
, 
qgroups
, 
£q
,

2726 
UPDATE_OLD
);

2727 ià(
»t
 < 0)

2728 
out
;

2731 
»t
 = 
	`qgroup_upd©e_»fút
(
fs_šfo
, 
Ãw_roÙs
, 
tmp
, 
qgroups
, 
£q
,

2732 
UPDATE_NEW
);

2733 ià(
»t
 < 0)

2734 
out
;

2736 
	`qgroup_upd©e_couÁ”s
(
fs_šfo
, 
qgroups
, 
Ä_Şd_roÙs
, 
Ä_Ãw_roÙs
,

2737 
num_by‹s
, 
£q
);

2742 
fs_šfo
->
qgroup_£q
 +ğ
	`max
(
Ä_Şd_roÙs
, 
Ä_Ãw_roÙs
) + 1;

2743 
out
:

2744 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2745 
out_ä“
:

2746 
	`uli¡_ä“
(
tmp
);

2747 
	`uli¡_ä“
(
qgroups
);

2748 
	`uli¡_ä“
(
Şd_roÙs
);

2749 
	`uli¡_ä“
(
Ãw_roÙs
);

2750  
»t
;

2751 
	}
}

2753 
	$bŒfs_qgroup_accouÁ_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
)

2755 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2756 
bŒfs_qgroup_ex‹Á_»cÜd
 *
»cÜd
;

2757 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

2758 
uli¡
 *
Ãw_roÙs
 = 
NULL
;

2759 
rb_node
 *
node
;

2760 
u64
 
num_dœty_ex‹Ás
 = 0;

2761 
u64
 
qgroup_to_sk
;

2762 
»t
 = 0;

2764 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

2765 
qgroup_to_sk
 = 
d–ayed_»fs
->qgroup_to_skip;

2766 (
node
 = 
	`rb_fœ¡
(&
d–ayed_»fs
->
dœty_ex‹Á_roÙ
))) {

2767 
»cÜd
 = 
	`rb_’Œy
(
node
, 
bŒfs_qgroup_ex‹Á_»cÜd
,

2768 
node
);

2770 
num_dœty_ex‹Ás
++;

2771 
	`Œaû_bŒfs_qgroup_accouÁ_ex‹Ás
(
fs_šfo
, 
»cÜd
);

2773 ià(!
»t
 && !(
fs_šfo
->
qgroup_æags
 &

2774 
BTRFS_QGROUP_RUNTIME_FLAG_NO_ACCOUNTING
)) {

2775 
bŒfs_back»f_w®k_ùx
 
ùx
 = { 0 };

2777 
ùx
.
by‹Ä
 = 
»cÜd
->bytenr;

2778 
ùx
.
fs_šfo
 = fs_info;

2794 ià(!
»cÜd
->
Şd_roÙs
) {

2796 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
ùx
, 
çl£
);

2797 ià(
»t
 < 0)

2798 
ş—nup
;

2799 
»cÜd
->
Şd_roÙs
 = 
ùx
.
roÙs
;

2800 
ùx
.
roÙs
 = 
NULL
;

2804 
	`bŒfs_qgroup_ä“_»äoÙ
(
fs_šfo
,

2805 
»cÜd
->
d©a_rsv_»äoÙ
,

2806 
»cÜd
->
d©a_rsv
,

2807 
BTRFS_QGROUP_RSV_DATA
);

2813 
ùx
.
Œªs
 =rans;

2814 
ùx
.
time_£q
 = 
BTRFS_SEQ_LAST
;

2815 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
ùx
, 
çl£
);

2816 ià(
»t
 < 0)

2817 
ş—nup
;

2818 
Ãw_roÙs
 = 
ùx
.
roÙs
;

2819 ià(
qgroup_to_sk
) {

2820 
	`uli¡_d–
(
Ãw_roÙs
, 
qgroup_to_sk
, 0);

2821 
	`uli¡_d–
(
»cÜd
->
Şd_roÙs
, 
qgroup_to_sk
,

2824 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Á
(
Œªs
, 
»cÜd
->
by‹Ä
,

2825 
»cÜd
->
num_by‹s
,

2826 
»cÜd
->
Şd_roÙs
,

2827 
Ãw_roÙs
);

2828 
»cÜd
->
Şd_roÙs
 = 
NULL
;

2829 
Ãw_roÙs
 = 
NULL
;

2831 
ş—nup
:

2832 
	`uli¡_ä“
(
»cÜd
->
Şd_roÙs
);

2833 
	`uli¡_ä“
(
Ãw_roÙs
);

2834 
Ãw_roÙs
 = 
NULL
;

2835 
	`rb_”a£
(
node
, &
d–ayed_»fs
->
dœty_ex‹Á_roÙ
);

2836 
	`kä“
(
»cÜd
);

2839 
	`Œaû_qgroup_num_dœty_ex‹Ás
(
fs_šfo
, 
Œªs
->
Œªsid
,

2840 
num_dœty_ex‹Ás
);

2841  
»t
;

2842 
	}
}

2848 
	$bŒfs_run_qgroups
(
bŒfs_Œªs_hªdË
 *
Œªs
)

2850 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2851 
»t
 = 0;

2858 ià(
Œªs
->
Œª§ùiÚ
->
¡©e
 !ğ
TRANS_STATE_COMMIT_DOING
)

2859 
	`lockd•_as£¹_h–d
(&
fs_šfo
->
qgroup_ioùl_lock
);

2861 ià(!
fs_šfo
->
quÙa_roÙ
)

2862  
»t
;

2864 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2865 !
	`li¡_em±y
(&
fs_šfo
->
dœty_qgroups
)) {

2866 
bŒfs_qgroup
 *
qgroup
;

2867 
qgroup
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
dœty_qgroups
,

2868 
bŒfs_qgroup
, 
dœty
);

2869 
	`li¡_d–_š™
(&
qgroup
->
dœty
);

2870 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2871 
»t
 = 
	`upd©e_qgroup_šfo_™em
(
Œªs
, 
qgroup
);

2872 ià(
»t
)

2873 
	`qgroup_m¬k_šcÚsi¡’t
(
fs_šfo
);

2874 
»t
 = 
	`upd©e_qgroup_lim™_™em
(
Œªs
, 
qgroup
);

2875 ià(
»t
)

2876 
	`qgroup_m¬k_šcÚsi¡’t
(
fs_šfo
);

2877 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2879 ià(
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

2880 
fs_šfo
->
qgroup_æags
 |ğ
BTRFS_QGROUP_STATUS_FLAG_ON
;

2882 
fs_šfo
->
qgroup_æags
 &ğ~
BTRFS_QGROUP_STATUS_FLAG_ON
;

2883 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2885 
»t
 = 
	`upd©e_qgroup_¡©us_™em
(
Œªs
);

2886 ià(
»t
)

2887 
	`qgroup_m¬k_šcÚsi¡’t
(
fs_šfo
);

2889  
»t
;

2890 
	}
}

2898 
	$bŒfs_qgroup_šh”™
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
¤cid
,

2899 
u64
 
objeùid
, 
bŒfs_qgroup_šh”™
 *
šh”™
)

2901 
»t
 = 0;

2902 
i
;

2903 
u64
 *
i_qgroups
;

2904 
boŞ
 
comm™tšg
 = 
çl£
;

2905 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2906 
bŒfs_roÙ
 *
quÙa_roÙ
;

2907 
bŒfs_qgroup
 *
¤cgroup
;

2908 
bŒfs_qgroup
 *
d¡group
;

2909 
boŞ
 
Ãed_»sÿn
 = 
çl£
;

2910 
u32
 
Ëv–_size
 = 0;

2911 
u64
 
nums
;

2925 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

2926 ià(
Œªs
->
Œª§ùiÚ
->
¡©e
 =ğ
TRANS_STATE_COMMIT_DOING
)

2927 
comm™tšg
 = 
Œue
;

2928 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2930 ià(!
comm™tšg
)

2931 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

2932 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

2933 
out
;

2935 
quÙa_roÙ
 = 
fs_šfo
->quota_root;

2936 ià(!
quÙa_roÙ
) {

2937 
»t
 = -
EINVAL
;

2938 
out
;

2941 ià(
šh”™
) {

2942 
i_qgroups
 = (
u64
 *)(
šh”™
 + 1);

2943 
nums
 = 
šh”™
->
num_qgroups
 + 2 * inh”™->
num_»f_cİ›s
 +

2944 2 * 
šh”™
->
num_exş_cİ›s
;

2945 
i
 = 0; i < 
nums
; ++i) {

2946 
¤cgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, *
i_qgroups
);

2952 ià(!
¤cgroup
 ||

2953 ((
¤cgroup
->
qgroupid
 >> 48è<ğ(
objeùid
 >> 48)))

2954 *
i_qgroups
 = 0ULL;

2956 ++
i_qgroups
;

2963 
»t
 = 
	`add_qgroup_™em
(
Œªs
, 
quÙa_roÙ
, 
objeùid
);

2964 ià(
»t
)

2965 
out
;

2970 ià(
šh”™
) {

2971 
i_qgroups
 = (
u64
 *)(
šh”™
 + 1);

2972 
i
 = 0; i < 
šh”™
->
num_qgroups
; ++i, ++
i_qgroups
) {

2973 ià(*
i_qgroups
 == 0)

2975 
»t
 = 
	`add_qgroup_»ÏtiÚ_™em
(
Œªs
, 
objeùid
,

2976 *
i_qgroups
);

2977 ià(
»t
 &&„‘ !ğ-
EEXIST
)

2978 
out
;

2979 
»t
 = 
	`add_qgroup_»ÏtiÚ_™em
(
Œªs
, *
i_qgroups
,

2980 
objeùid
);

2981 ià(
»t
 &&„‘ !ğ-
EEXIST
)

2982 
out
;

2984 
»t
 = 0;

2988 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2990 
d¡group
 = 
	`add_qgroup_rb
(
fs_šfo
, 
objeùid
);

2991 ià(
	`IS_ERR
(
d¡group
)) {

2992 
»t
 = 
	`PTR_ERR
(
d¡group
);

2993 
uÆock
;

2996 ià(
šh”™
 && inh”™->
æags
 & 
BTRFS_QGROUP_INHERIT_SET_LIMITS
) {

2997 
d¡group
->
lim_æags
 = 
šh”™
->
lim
.
æags
;

2998 
d¡group
->
max_rãr
 = 
šh”™
->
lim
.max_rfer;

2999 
d¡group
->
max_exş
 = 
šh”™
->
lim
.max_excl;

3000 
d¡group
->
rsv_rãr
 = 
šh”™
->
lim
.rsv_rfer;

3001 
d¡group
->
rsv_exş
 = 
šh”™
->
lim
.rsv_excl;

3003 
	`qgroup_dœty
(
fs_šfo
, 
d¡group
);

3006 ià(
¤cid
) {

3007 
¤cgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
¤cid
);

3008 ià(!
¤cgroup
)

3009 
uÆock
;

3016 
Ëv–_size
 = 
fs_šfo
->
nodesize
;

3017 
d¡group
->
rãr
 = 
¤cgroup
->rfer;

3018 
d¡group
->
rãr_cm´
 = 
¤cgroup
->rfer_cmpr;

3019 
d¡group
->
exş
 = 
Ëv–_size
;

3020 
d¡group
->
exş_cm´
 = 
Ëv–_size
;

3021 
¤cgroup
->
exş
 = 
Ëv–_size
;

3022 
¤cgroup
->
exş_cm´
 = 
Ëv–_size
;

3025 
d¡group
->
lim_æags
 = 
¤cgroup
->lim_flags;

3026 
d¡group
->
max_rãr
 = 
¤cgroup
->max_rfer;

3027 
d¡group
->
max_exş
 = 
¤cgroup
->max_excl;

3028 
d¡group
->
rsv_rãr
 = 
¤cgroup
->rsv_rfer;

3029 
d¡group
->
rsv_exş
 = 
¤cgroup
->rsv_excl;

3031 
	`qgroup_dœty
(
fs_šfo
, 
d¡group
);

3032 
	`qgroup_dœty
(
fs_šfo
, 
¤cgroup
);

3035 ià(!
šh”™
)

3036 
uÆock
;

3038 
i_qgroups
 = (
u64
 *)(
šh”™
 + 1);

3039 
i
 = 0; i < 
šh”™
->
num_qgroups
; ++i) {

3040 ià(*
i_qgroups
) {

3041 
»t
 = 
	`add_»ÏtiÚ_rb
(
fs_šfo
, 
objeùid
, *
i_qgroups
);

3042 ià(
»t
)

3043 
uÆock
;

3045 ++
i_qgroups
;

3051 ià(
¤cid
)

3052 
Ãed_»sÿn
 = 
Œue
;

3055 
i
 = 0; i < 
šh”™
->
num_»f_cİ›s
; ++i, 
i_qgroups
 += 2) {

3056 
bŒfs_qgroup
 *
¤c
;

3057 
bŒfs_qgroup
 *
d¡
;

3059 ià(!
i_qgroups
[0] || !i_qgroups[1])

3062 
¤c
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
i_qgroups
[0]);

3063 
d¡
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
i_qgroups
[1]);

3065 ià(!
¤c
 || !
d¡
) {

3066 
»t
 = -
EINVAL
;

3067 
uÆock
;

3070 
d¡
->
rãr
 = 
¤c
->rã¸- 
Ëv–_size
;

3071 
d¡
->
rãr_cm´
 = 
¤c
->rãr_cm´ - 
Ëv–_size
;

3074 
Ãed_»sÿn
 = 
Œue
;

3076 
i
 = 0; i < 
šh”™
->
num_exş_cİ›s
; ++i, 
i_qgroups
 += 2) {

3077 
bŒfs_qgroup
 *
¤c
;

3078 
bŒfs_qgroup
 *
d¡
;

3080 ià(!
i_qgroups
[0] || !i_qgroups[1])

3083 
¤c
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
i_qgroups
[0]);

3084 
d¡
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
i_qgroups
[1]);

3086 ià(!
¤c
 || !
d¡
) {

3087 
»t
 = -
EINVAL
;

3088 
uÆock
;

3091 
d¡
->
exş
 = 
¤c
->exş + 
Ëv–_size
;

3092 
d¡
->
exş_cm´
 = 
¤c
->exş_cm´ + 
Ëv–_size
;

3093 
Ãed_»sÿn
 = 
Œue
;

3096 
uÆock
:

3097 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

3098 ià(!
»t
)

3099 
»t
 = 
	`bŒfs_sysfs_add_Úe_qgroup
(
fs_šfo
, 
d¡group
);

3100 
out
:

3101 ià(!
comm™tšg
)

3102 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

3103 ià(
Ãed_»sÿn
)

3104 
	`qgroup_m¬k_šcÚsi¡’t
(
fs_šfo
);

3105  
»t
;

3106 
	}
}

3108 
boŞ
 
	$qgroup_check_lim™s
(cÚ¡ 
bŒfs_qgroup
 *
qg
, 
u64
 
num_by‹s
)

3110 ià((
qg
->
lim_æags
 & 
BTRFS_QGROUP_LIMIT_MAX_RFER
) &&

3111 
	`qgroup_rsv_tÙ®
(
qg
è+ (
s64
)qg->
rãr
 + 
num_by‹s
 > qg->
max_rãr
)

3112  
çl£
;

3114 ià((
qg
->
lim_æags
 & 
BTRFS_QGROUP_LIMIT_MAX_EXCL
) &&

3115 
	`qgroup_rsv_tÙ®
(
qg
è+ (
s64
)qg->
exş
 + 
num_by‹s
 > qg->
max_exş
)

3116  
çl£
;

3118  
Œue
;

3119 
	}
}

3121 
	$qgroup_»£rve
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
num_by‹s
, 
boŞ
 
’fÜû
,

3122 
bŒfs_qgroup_rsv_ty³
 
ty³
)

3124 
bŒfs_qgroup
 *
qgroup
;

3125 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3126 
u64
 
»f_roÙ
 = 
roÙ
->
roÙ_key
.
objeùid
;

3127 
»t
 = 0;

3128 
uli¡_node
 *
unode
;

3129 
uli¡_™”©Ü
 
u™”
;

3131 ià(!
	`is_f¡»e
(
»f_roÙ
))

3134 ià(
num_by‹s
 == 0)

3137 ià(
	`‹¡_b™
(
BTRFS_FS_QUOTA_OVERRIDE
, &
fs_šfo
->
æags
) &&

3138 
	`ÿ·bË
(
CAP_SYS_RESOURCE
))

3139 
’fÜû
 = 
çl£
;

3141 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

3142 ià(!
fs_šfo
->
quÙa_roÙ
)

3143 
out
;

3145 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
»f_roÙ
);

3146 ià(!
qgroup
)

3147 
out
;

3153 
	`uli¡_»š™
(
fs_šfo
->
qgroup_uli¡
);

3154 
»t
 = 
	`uli¡_add
(
fs_šfo
->
qgroup_uli¡
, 
qgroup
->
qgroupid
,

3155 
	`qgroup_to_aux
(
qgroup
), 
GFP_ATOMIC
);

3156 ià(
»t
 < 0)

3157 
out
;

3158 
	`ULIST_ITER_INIT
(&
u™”
);

3159 (
unode
 = 
	`uli¡_Ãxt
(
fs_šfo
->
qgroup_uli¡
, &
u™”
))) {

3160 
bŒfs_qgroup
 *
qg
;

3161 
bŒfs_qgroup_li¡
 *
gli¡
;

3163 
qg
 = 
	`unode_aux_to_qgroup
(
unode
);

3165 ià(
’fÜû
 && !
	`qgroup_check_lim™s
(
qg
, 
num_by‹s
)) {

3166 
»t
 = -
EDQUOT
;

3167 
out
;

3170 
	`li¡_fÜ_—ch_’Œy
(
gli¡
, &
qg
->
groups
, 
Ãxt_group
) {

3171 
»t
 = 
	`uli¡_add
(
fs_šfo
->
qgroup_uli¡
,

3172 
gli¡
->
group
->
qgroupid
,

3173 
	`qgroup_to_aux
(
gli¡
->
group
), 
GFP_ATOMIC
);

3174 ià(
»t
 < 0)

3175 
out
;

3178 
»t
 = 0;

3182 
	`ULIST_ITER_INIT
(&
u™”
);

3183 (
unode
 = 
	`uli¡_Ãxt
(
fs_šfo
->
qgroup_uli¡
, &
u™”
))) {

3184 
bŒfs_qgroup
 *
qg
;

3186 
qg
 = 
	`unode_aux_to_qgroup
(
unode
);

3188 
	`qgroup_rsv_add
(
fs_šfo
, 
qg
, 
num_by‹s
, 
ty³
);

3191 
out
:

3192 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

3193  
»t
;

3194 
	}
}

3205 
	$bŒfs_qgroup_ä“_»äoÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

3206 
u64
 
»f_roÙ
, u64 
num_by‹s
,

3207 
bŒfs_qgroup_rsv_ty³
 
ty³
)

3209 
bŒfs_qgroup
 *
qgroup
;

3210 
uli¡_node
 *
unode
;

3211 
uli¡_™”©Ü
 
u™”
;

3212 
»t
 = 0;

3214 ià(!
	`is_f¡»e
(
»f_roÙ
))

3217 ià(
num_by‹s
 == 0)

3220 ià(
num_by‹s
 =ğ(
u64
)-1 && 
ty³
 !ğ
BTRFS_QGROUP_RSV_META_PERTRANS
) {

3221 
	`WARN
(1, "%s: Inv®idy³Øä“", 
__func__
);

3224 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

3226 ià(!
fs_šfo
->
quÙa_roÙ
)

3227 
out
;

3229 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
»f_roÙ
);

3230 ià(!
qgroup
)

3231 
out
;

3233 ià(
num_by‹s
 =ğ(
u64
)-1)

3238 
num_by‹s
 = 
qgroup
->
rsv
.
v®ues
[
ty³
];

3240 
	`uli¡_»š™
(
fs_šfo
->
qgroup_uli¡
);

3241 
»t
 = 
	`uli¡_add
(
fs_šfo
->
qgroup_uli¡
, 
qgroup
->
qgroupid
,

3242 
	`qgroup_to_aux
(
qgroup
), 
GFP_ATOMIC
);

3243 ià(
»t
 < 0)

3244 
out
;

3245 
	`ULIST_ITER_INIT
(&
u™”
);

3246 (
unode
 = 
	`uli¡_Ãxt
(
fs_šfo
->
qgroup_uli¡
, &
u™”
))) {

3247 
bŒfs_qgroup
 *
qg
;

3248 
bŒfs_qgroup_li¡
 *
gli¡
;

3250 
qg
 = 
	`unode_aux_to_qgroup
(
unode
);

3252 
	`qgroup_rsv_»Ëa£
(
fs_šfo
, 
qg
, 
num_by‹s
, 
ty³
);

3254 
	`li¡_fÜ_—ch_’Œy
(
gli¡
, &
qg
->
groups
, 
Ãxt_group
) {

3255 
»t
 = 
	`uli¡_add
(
fs_šfo
->
qgroup_uli¡
,

3256 
gli¡
->
group
->
qgroupid
,

3257 
	`qgroup_to_aux
(
gli¡
->
group
), 
GFP_ATOMIC
);

3258 ià(
»t
 < 0)

3259 
out
;

3263 
out
:

3264 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

3265 
	}
}

3271 
boŞ
 
	$is_Ï¡_Ëaf
(
bŒfs_·th
 *
·th
)

3273 
i
;

3275 
i
 = 1; i < 
BTRFS_MAX_LEVEL
 && 
·th
->
nodes
[i]; i++) {

3276 ià(
·th
->
¦Ùs
[
i
] !ğ
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[i]) - 1)

3277  
çl£
;

3279  
Œue
;

3280 
	}
}

3286 
	$qgroup_»sÿn_Ëaf
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3287 
bŒfs_·th
 *
·th
)

3289 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

3290 
bŒfs_roÙ
 *
ex‹Á_roÙ
;

3291 
bŒfs_key
 
found
;

3292 
ex‹Á_bufãr
 *
sü©ch_Ëaf
 = 
NULL
;

3293 
u64
 
num_by‹s
;

3294 
boŞ
 
dÚe
;

3295 
¦Ù
;

3296 
»t
;

3298 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3299 
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
,

3300 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
objeùid
);

3301 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
ex‹Á_roÙ
,

3302 &
fs_šfo
->
qgroup_»sÿn_´og»ss
,

3303 
·th
, 1, 0);

3305 
	`bŒfs_debug
(
fs_šfo
,

3307 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
objeùid
,

3308 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
ty³
,

3309 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
off£t
, 
»t
);

3311 ià(
»t
) {

3320 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
objeùid
 = (
u64
)-1;

3321 
	`bŒfs_»Ëa£_·th
(
·th
);

3322 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3323  
»t
;

3325 
dÚe
 = 
	`is_Ï¡_Ëaf
(
·th
);

3327 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
found
,

3328 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]) - 1);

3329 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
objeùid
 = 
found
.objectid + 1;

3331 
sü©ch_Ëaf
 = 
	`bŒfs_şÚe_ex‹Á_bufãr
(
·th
->
nodes
[0]);

3332 ià(!
sü©ch_Ëaf
) {

3333 
»t
 = -
ENOMEM
;

3334 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3335 
out
;

3337 
¦Ù
 = 
·th
->
¦Ùs
[0];

3338 
	`bŒfs_»Ëa£_·th
(
·th
);

3339 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3341 ; 
¦Ù
 < 
	`bŒfs_h—d”_Ä™ems
(
sü©ch_Ëaf
); ++slot) {

3342 
bŒfs_back»f_w®k_ùx
 
ùx
 = { 0 };

3344 
	`bŒfs_™em_key_to_ıu
(
sü©ch_Ëaf
, &
found
, 
¦Ù
);

3345 ià(
found
.
ty³
 !ğ
BTRFS_EXTENT_ITEM_KEY
 &&

3346 
found
.
ty³
 !ğ
BTRFS_METADATA_ITEM_KEY
)

3348 ià(
found
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
)

3349 
num_by‹s
 = 
fs_šfo
->
nodesize
;

3351 
num_by‹s
 = 
found
.
off£t
;

3353 
ùx
.
by‹Ä
 = 
found
.
objeùid
;

3354 
ùx
.
fs_šfo
 = fs_info;

3356 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
ùx
, 
çl£
);

3357 ià(
»t
 < 0)

3358 
out
;

3360 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Á
(
Œªs
, 
found
.
objeùid
,

3361 
num_by‹s
, 
NULL
, 
ùx
.
roÙs
);

3362 ià(
»t
 < 0)

3363 
out
;

3365 
out
:

3366 ià(
sü©ch_Ëaf
)

3367 
	`ä“_ex‹Á_bufãr
(
sü©ch_Ëaf
);

3369 ià(
dÚe
 && !
»t
) {

3370 
»t
 = 1;

3371 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
objeùid
 = (
u64
)-1;

3373  
»t
;

3374 
	}
}

3376 
boŞ
 
	$»sÿn_should_¡İ
(
bŒfs_fs_šfo
 *
fs_šfo
)

3378  
	`bŒfs_fs_şosšg
(
fs_šfo
) ||

3379 
	`‹¡_b™
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_šfo
->
fs_¡©e
) ||

3380 !
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
) ||

3381 
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_RUNTIME_FLAG_CANCEL_RESCAN
;

3382 
	}
}

3384 
	$bŒfs_qgroup_»sÿn_wÜk”
(
bŒfs_wÜk
 *
wÜk
)

3386 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`cÚš”_of
(
wÜk
, btrfs_fs_info,

3387 
qgroup_»sÿn_wÜk
);

3388 
bŒfs_·th
 *
·th
;

3389 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

3390 
”r
 = -
ENOMEM
;

3391 
»t
 = 0;

3392 
boŞ
 
¡İ³d
 = 
çl£
;

3393 
boŞ
 
did_Ëaf_»sÿns
 = 
çl£
;

3395 
·th
 = 
	`bŒfs_®loc_·th
();

3396 ià(!
·th
)

3397 
out
;

3402 
·th
->
£¬ch_comm™_roÙ
 = 1;

3403 
·th
->
sk_lockšg
 = 1;

3405 
”r
 = 0;

3406 !
”r
 && !(
¡İ³d
 = 
	`»sÿn_should_¡İ
(
fs_šfo
))) {

3407 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
fs_šfo
->
fs_roÙ
, 0);

3408 ià(
	`IS_ERR
(
Œªs
)) {

3409 
”r
 = 
	`PTR_ERR
(
Œªs
);

3413 
”r
 = 
	`qgroup_»sÿn_Ëaf
(
Œªs
, 
·th
);

3414 
did_Ëaf_»sÿns
 = 
Œue
;

3416 ià(
”r
 > 0)

3417 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

3419 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3422 
out
:

3423 
	`bŒfs_ä“_·th
(
·th
);

3425 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3426 ià(
”r
 > 0 &&

3427 
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
) {

3428 
fs_šfo
->
qgroup_æags
 &ğ~
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

3429 } ià(
”r
 < 0 || 
¡İ³d
) {

3430 
fs_šfo
->
qgroup_æags
 |ğ
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

3432 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3441 ià(
did_Ëaf_»sÿns
) {

3442 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
fs_šfo
->
quÙa_roÙ
, 1);

3443 ià(
	`IS_ERR
(
Œªs
)) {

3444 
”r
 = 
	`PTR_ERR
(
Œªs
);

3445 
Œªs
 = 
NULL
;

3446 
	`bŒfs_”r
(
fs_šfo
,

3448 
”r
);

3451 
Œªs
 = 
NULL
;

3454 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3455 ià(!
¡İ³d
 ||

3456 
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_RUNTIME_FLAG_CANCEL_RESCAN
)

3457 
fs_šfo
->
qgroup_æags
 &ğ~
BTRFS_QGROUP_STATUS_FLAG_RESCAN
;

3458 ià(
Œªs
) {

3459 
»t
 = 
	`upd©e_qgroup_¡©us_™em
(
Œªs
);

3460 ià(
»t
 < 0) {

3461 
”r
 = 
»t
;

3462 
	`bŒfs_”r
(
fs_šfo
, "failo update qgroup status: %d",

3463 
”r
);

3466 
fs_šfo
->
qgroup_»sÿn_ruÂšg
 = 
çl£
;

3467 
fs_šfo
->
qgroup_æags
 &ğ~
BTRFS_QGROUP_RUNTIME_FLAG_CANCEL_RESCAN
;

3468 
	`com¶‘e_®l
(&
fs_šfo
->
qgroup_»sÿn_com¶‘iÚ
);

3469 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3471 ià(!
Œªs
)

3474 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3476 ià(
¡İ³d
) {

3477 
	`bŒfs_šfo
(
fs_šfo
, "qgroup scan…aused");

3478 } ià(
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_RUNTIME_FLAG_CANCEL_RESCAN
) {

3479 
	`bŒfs_šfo
(
fs_šfo
, "qgroup scan cancelled");

3480 } ià(
”r
 >= 0) {

3481 
	`bŒfs_šfo
(
fs_šfo
, "qgroup scan completed%s",

3482 
”r
 > 0 ? " (inconsistency flag cleared)" : "");

3484 
	`bŒfs_”r
(
fs_šfo
, "qgrou°sÿÀçed w™h %d", 
”r
);

3486 
	}
}

3493 
	$qgroup_»sÿn_š™
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
´og»ss_objeùid
,

3494 
š™_æags
)

3496 
»t
 = 0;

3498 ià(!
š™_æags
) {

3500 ià(!(
fs_šfo
->
qgroup_æags
 &

3501 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
)) {

3502 
	`bŒfs_w¬n
(
fs_šfo
,

3504 
»t
 = -
EINVAL
;

3505 } ià(!(
fs_šfo
->
qgroup_æags
 &

3506 
BTRFS_QGROUP_STATUS_FLAG_ON
)) {

3507 
	`bŒfs_w¬n
(
fs_šfo
,

3509 
»t
 = -
EINVAL
;

3512 ià(
»t
)

3513  
»t
;

3516 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3518 ià(
š™_æags
) {

3519 ià(
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
) {

3520 
	`bŒfs_w¬n
(
fs_šfo
,

3522 
»t
 = -
EINPROGRESS
;

3523 } ià(!(
fs_šfo
->
qgroup_æags
 &

3524 
BTRFS_QGROUP_STATUS_FLAG_ON
)) {

3525 
	`bŒfs_w¬n
(
fs_šfo
,

3527 
»t
 = -
EINVAL
;

3528 } ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
)) {

3530 
»t
 = -
EBUSY
;

3533 ià(
»t
) {

3534 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3535  
»t
;

3537 
fs_šfo
->
qgroup_æags
 |ğ
BTRFS_QGROUP_STATUS_FLAG_RESCAN
;

3540 
	`mem£t
(&
fs_šfo
->
qgroup_»sÿn_´og»ss
, 0,

3541 (
fs_šfo
->
qgroup_»sÿn_´og»ss
));

3542 
fs_šfo
->
qgroup_æags
 &ğ~(
BTRFS_QGROUP_RUNTIME_FLAG_CANCEL_RESCAN
 |

3543 
BTRFS_QGROUP_RUNTIME_FLAG_NO_ACCOUNTING
);

3544 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
objeùid
 = 
´og»ss_objeùid
;

3545 
	`š™_com¶‘iÚ
(&
fs_šfo
->
qgroup_»sÿn_com¶‘iÚ
);

3546 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3548 
	`bŒfs_š™_wÜk
(&
fs_šfo
->
qgroup_»sÿn_wÜk
,

3549 
bŒfs_qgroup_»sÿn_wÜk”
, 
NULL
, NULL);

3551 
	}
}

3554 
	$qgroup_»sÿn_z”o_Œackšg
(
bŒfs_fs_šfo
 *
fs_šfo
)

3556 
rb_node
 *
n
;

3557 
bŒfs_qgroup
 *
qgroup
;

3559 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

3561 
n
 = 
	`rb_fœ¡
(&
fs_šfo
->
qgroup_Œ“
);‚;‚ = 
	`rb_Ãxt
(n)) {

3562 
qgroup
 = 
	`rb_’Œy
(
n
, 
bŒfs_qgroup
, 
node
);

3563 
qgroup
->
rãr
 = 0;

3564 
qgroup
->
rãr_cm´
 = 0;

3565 
qgroup
->
exş
 = 0;

3566 
qgroup
->
exş_cm´
 = 0;

3567 
	`qgroup_dœty
(
fs_šfo
, 
qgroup
);

3569 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

3570 
	}
}

3573 
	$bŒfs_qgroup_»sÿn
(
bŒfs_fs_šfo
 *
fs_šfo
)

3575 
»t
 = 0;

3576 
bŒfs_Œªs_hªdË
 *
Œªs
;

3578 
»t
 = 
	`qgroup_»sÿn_š™
(
fs_šfo
, 0, 1);

3579 ià(
»t
)

3580  
»t
;

3593 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ_b¬r›r
(
fs_šfo
->
fs_roÙ
);

3594 ià(
	`IS_ERR
(
Œªs
è&&¿n !ğ
	`ERR_PTR
(-
ENOENT
)) {

3595 
fs_šfo
->
qgroup_æags
 &ğ~
BTRFS_QGROUP_STATUS_FLAG_RESCAN
;

3596  
	`PTR_ERR
(
Œªs
);

3597 } ià(
Œªs
 !ğ
	`ERR_PTR
(-
ENOENT
)) {

3598 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

3599 ià(
»t
) {

3600 
fs_šfo
->
qgroup_æags
 &ğ~
BTRFS_QGROUP_STATUS_FLAG_RESCAN
;

3601  
»t
;

3605 
	`qgroup_»sÿn_z”o_Œackšg
(
fs_šfo
);

3607 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3608 
fs_šfo
->
qgroup_»sÿn_ruÂšg
 = 
Œue
;

3609 
	`bŒfs_queue_wÜk
(
fs_šfo
->
qgroup_»sÿn_wÜk”s
,

3610 &
fs_šfo
->
qgroup_»sÿn_wÜk
);

3611 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3614 
	}
}

3616 
	$bŒfs_qgroup_wa™_fÜ_com¶‘iÚ
(
bŒfs_fs_šfo
 *
fs_šfo
,

3617 
boŞ
 
š‹¼u±ibË
)

3619 
ruÂšg
;

3620 
»t
 = 0;

3622 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3623 
ruÂšg
 = 
fs_šfo
->
qgroup_»sÿn_ruÂšg
;

3624 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3626 ià(!
ruÂšg
)

3629 ià(
š‹¼u±ibË
)

3630 
»t
 = 
	`wa™_fÜ_com¶‘iÚ_š‹¼u±ibË
(

3631 &
fs_šfo
->
qgroup_»sÿn_com¶‘iÚ
);

3633 
	`wa™_fÜ_com¶‘iÚ
(&
fs_šfo
->
qgroup_»sÿn_com¶‘iÚ
);

3635  
»t
;

3636 
	}
}

3643 
	$bŒfs_qgroup_»sÿn_»sume
(
bŒfs_fs_šfo
 *
fs_šfo
)

3645 ià(
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
) {

3646 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3647 
fs_šfo
->
qgroup_»sÿn_ruÂšg
 = 
Œue
;

3648 
	`bŒfs_queue_wÜk
(
fs_šfo
->
qgroup_»sÿn_wÜk”s
,

3649 &
fs_šfo
->
qgroup_»sÿn_wÜk
);

3650 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

3652 
	}
}

3654 
	#rbŒ“_™”©e_äom_§ã
(
node
, 
Ãxt
, 
¡¬t
) \

3655 
node
 = 
¡¬t
;‚od&& ({ 
Ãxt
 = 
	`rb_Ãxt
Òode); 1;});‚odğÃxt)

	)

3657 
	$qgroup_uÄe£rve_¿nge
(
bŒfs_šode
 *
šode
,

3658 
ex‹Á_chªge£t
 *
»£rved
, 
u64
 
¡¬t
,

3659 
u64
 
Ën
)

3661 
rb_node
 *
node
;

3662 
rb_node
 *
Ãxt
;

3663 
uli¡_node
 *
’Œy
;

3664 
»t
 = 0;

3666 
node
 = 
»£rved
->
¿nge_chªged
.
roÙ
.
rb_node
;

3667 ià(!
node
)

3669 
node
) {

3670 
’Œy
 = 
	`rb_’Œy
(
node
, 
uli¡_node
, 
rb_node
);

3671 ià(
’Œy
->
v®
 < 
¡¬t
)

3672 
node
 =‚ode->
rb_right
;

3674 
node
 =‚ode->
rb_Ëá
;

3677 ià(
’Œy
->
v®
 > 
¡¬t
 && 
	`rb_´ev
(&’Œy->
rb_node
))

3678 
’Œy
 = 
	`rb_’Œy
(
	`rb_´ev
(&’Œy->
rb_node
), 
uli¡_node
,

3679 
rb_node
);

3681 
	`rbŒ“_™”©e_äom_§ã
(
node
, 
Ãxt
, &
’Œy
->
rb_node
) {

3682 
u64
 
’Œy_¡¬t
;

3683 
u64
 
’Œy_’d
;

3684 
u64
 
’Œy_Ën
;

3685 
ş—r_»t
;

3687 
’Œy
 = 
	`rb_’Œy
(
node
, 
uli¡_node
, 
rb_node
);

3688 
’Œy_¡¬t
 = 
’Œy
->
v®
;

3689 
’Œy_’d
 = 
’Œy
->
aux
;

3690 
’Œy_Ën
 = 
’Œy_’d
 - 
’Œy_¡¬t
 + 1;

3692 ià(
’Œy_¡¬t
 >ğ
¡¬t
 + 
Ën
)

3694 ià(
’Œy_¡¬t
 + 
’Œy_Ën
 <ğ
¡¬t
)

3700 
ş—r_»t
 = 
	`ş—r_ex‹Á_b™s
(&
šode
->
io_Œ“
, 
’Œy_¡¬t
,

3701 
’Œy_’d
, 
EXTENT_QGROUP_RESERVED
);

3702 ià(!
»t
 && 
ş—r_»t
 < 0)

3703 
»t
 = 
ş—r_»t
;

3705 
	`uli¡_d–
(&
»£rved
->
¿nge_chªged
, 
’Œy
->
v®
,ƒÁry->
aux
);

3706 ià(
	`lik–y
(
»£rved
->
by‹s_chªged
 >ğ
’Œy_Ën
)) {

3707 
»£rved
->
by‹s_chªged
 -ğ
’Œy_Ën
;

3709 
	`WARN_ON
(1);

3710 
»£rved
->
by‹s_chªged
 = 0;

3714  
»t
;

3715 
	}
}

3736 
	$Œy_æush_qgroup
(
bŒfs_roÙ
 *
roÙ
)

3738 
bŒfs_Œªs_hªdË
 *
Œªs
;

3739 
»t
;

3742 
	`ASSERT
(
cu¼’t
->
jouº®_šfo
 =ğ
NULL
);

3743 ià(
	`WARN_ON
(
cu¼’t
->
jouº®_šfo
))

3750 ià(
	`‹¡_ªd_£t_b™
(
BTRFS_ROOT_QGROUP_FLUSHING
, &
roÙ
->
¡©e
)) {

3751 
	`wa™_ev’t
(
roÙ
->
qgroup_æush_wa™
,

3752 !
	`‹¡_b™
(
BTRFS_ROOT_QGROUP_FLUSHING
, &
roÙ
->
¡©e
));

3756 
»t
 = 
	`bŒfs_¡¬t_d–®loc_¢­shÙ
(
roÙ
, 
Œue
);

3757 ià(
»t
 < 0)

3758 
out
;

3759 
	`bŒfs_wa™_Üd”ed_ex‹Ás
(
roÙ
, 
U64_MAX
, 0, (
u64
)-1);

3761 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ_b¬r›r
(
roÙ
);

3762 ià(
	`IS_ERR
(
Œªs
)) {

3763 
»t
 = 
	`PTR_ERR
(
Œªs
);

3764 ià(
»t
 =ğ-
ENOENT
)

3765 
»t
 = 0;

3766 
out
;

3769 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

3770 
out
:

3771 
	`ş—r_b™
(
BTRFS_ROOT_QGROUP_FLUSHING
, &
roÙ
->
¡©e
);

3772 
	`wake_up
(&
roÙ
->
qgroup_æush_wa™
);

3773  
»t
;

3774 
	}
}

3776 
	$qgroup_»£rve_d©a
(
bŒfs_šode
 *
šode
,

3777 
ex‹Á_chªge£t
 **
»£rved_»t
, 
u64
 
¡¬t
,

3778 
u64
 
Ën
)

3780 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

3781 
ex‹Á_chªge£t
 *
»£rved
;

3782 
boŞ
 
Ãw_»£rved
 = 
çl£
;

3783 
u64
 
Üig_»£rved
;

3784 
u64
 
to_»£rve
;

3785 
»t
;

3787 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
roÙ
->
fs_šfo
->
æags
) ||

3788 !
	`is_f¡»e
(
roÙ
->
roÙ_key
.
objeùid
è|| 
Ën
 == 0)

3792 ià(
	`WARN_ON
(!
»£rved_»t
))

3793  -
EINVAL
;

3794 ià(!*
»£rved_»t
) {

3795 
Ãw_»£rved
 = 
Œue
;

3796 *
»£rved_»t
 = 
	`ex‹Á_chªge£t_®loc
();

3797 ià(!*
»£rved_»t
)

3798  -
ENOMEM
;

3800 
»£rved
 = *
»£rved_»t
;

3802 
Üig_»£rved
 = 
»£rved
->
by‹s_chªged
;

3803 
»t
 = 
	`£t_»cÜd_ex‹Á_b™s
(&
šode
->
io_Œ“
, 
¡¬t
,

3804 
¡¬t
 + 
Ën
 -1, 
EXTENT_QGROUP_RESERVED
, 
»£rved
);

3807 
to_»£rve
 = 
»£rved
->
by‹s_chªged
 - 
Üig_»£rved
;

3808 
	`Œaû_bŒfs_qgroup_»£rve_d©a
(&
šode
->
vfs_šode
, 
¡¬t
, 
Ën
,

3809 
to_»£rve
, 
QGROUP_RESERVE
);

3810 ià(
»t
 < 0)

3811 
out
;

3812 
»t
 = 
	`qgroup_»£rve
(
roÙ
, 
to_»£rve
, 
Œue
, 
BTRFS_QGROUP_RSV_DATA
);

3813 ià(
»t
 < 0)

3814 
ş—nup
;

3816  
»t
;

3818 
ş—nup
:

3819 
	`qgroup_uÄe£rve_¿nge
(
šode
, 
»£rved
, 
¡¬t
, 
Ën
);

3820 
out
:

3821 ià(
Ãw_»£rved
) {

3822 
	`ex‹Á_chªge£t_ä“
(
»£rved
);

3823 *
»£rved_»t
 = 
NULL
;

3825  
»t
;

3826 
	}
}

3840 
	$bŒfs_qgroup_»£rve_d©a
(
bŒfs_šode
 *
šode
,

3841 
ex‹Á_chªge£t
 **
»£rved_»t
, 
u64
 
¡¬t
,

3842 
u64
 
Ën
)

3844 
»t
;

3846 
»t
 = 
	`qgroup_»£rve_d©a
(
šode
, 
»£rved_»t
, 
¡¬t
, 
Ën
);

3847 ià(
»t
 <ğ0 &&„‘ !ğ-
EDQUOT
)

3848  
»t
;

3850 
»t
 = 
	`Œy_æush_qgroup
(
šode
->
roÙ
);

3851 ià(
»t
 < 0)

3852  
»t
;

3853  
	`qgroup_»£rve_d©a
(
šode
, 
»£rved_»t
, 
¡¬t
, 
Ën
);

3854 
	}
}

3857 
	$qgroup_ä“_»£rved_d©a
(
bŒfs_šode
 *
šode
,

3858 
ex‹Á_chªge£t
 *
»£rved
,

3859 
u64
 
¡¬t
, u64 
Ën
, u64 *
ä“d_»t
)

3861 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

3862 
uli¡_node
 *
unode
;

3863 
uli¡_™”©Ü
 
u™”
;

3864 
ex‹Á_chªge£t
 
chªge£t
;

3865 
u64
 
ä“d
 = 0;

3866 
»t
;

3868 
	`ex‹Á_chªge£t_š™
(&
chªge£t
);

3869 
Ën
 = 
	`round_up
(
¡¬t
 +†’, 
roÙ
->
fs_šfo
->
£ùÜsize
);

3870 
¡¬t
 = 
	`round_down
(¡¬t, 
roÙ
->
fs_šfo
->
£ùÜsize
);

3872 
	`ULIST_ITER_INIT
(&
u™”
);

3873 (
unode
 = 
	`uli¡_Ãxt
(&
»£rved
->
¿nge_chªged
, &
u™”
))) {

3874 
u64
 
¿nge_¡¬t
 = 
unode
->
v®
;

3876 
u64
 
¿nge_Ën
 = 
unode
->
aux
 - 
¿nge_¡¬t
 + 1;

3877 
u64
 
ä“_¡¬t
;

3878 
u64
 
ä“_Ën
;

3880 
	`ex‹Á_chªge£t_»Ëa£
(&
chªge£t
);

3883 ià(
¿nge_¡¬t
 >ğ
¡¬t
 + 
Ën
 ||

3884 
¿nge_¡¬t
 + 
¿nge_Ën
 <ğ
¡¬t
)

3886 
ä“_¡¬t
 = 
	`max
(
¿nge_¡¬t
, 
¡¬t
);

3887 
ä“_Ën
 = 
	`mš
(
¡¬t
 + 
Ën
, 
¿nge_¡¬t
 + 
¿nge_Ën
) -

3888 
ä“_¡¬t
;

3897 
»t
 = 
	`ş—r_»cÜd_ex‹Á_b™s
(&
šode
->
io_Œ“
, 
ä“_¡¬t
,

3898 
ä“_¡¬t
 + 
ä“_Ën
 - 1,

3899 
EXTENT_QGROUP_RESERVED
, &
chªge£t
);

3900 ià(
»t
 < 0)

3901 
out
;

3902 
ä“d
 +ğ
chªge£t
.
by‹s_chªged
;

3904 
	`bŒfs_qgroup_ä“_»äoÙ
(
roÙ
->
fs_šfo
,„oÙ->
roÙ_key
.
objeùid
, 
ä“d
,

3905 
BTRFS_QGROUP_RSV_DATA
);

3906 ià(
ä“d_»t
)

3907 *
ä“d_»t
 = 
ä“d
;

3908 
»t
 = 0;

3909 
out
:

3910 
	`ex‹Á_chªge£t_»Ëa£
(&
chªge£t
);

3911  
»t
;

3912 
	}
}

3914 
	$__bŒfs_qgroup_»Ëa£_d©a
(
bŒfs_šode
 *
šode
,

3915 
ex‹Á_chªge£t
 *
»£rved
, 
u64
 
¡¬t
, u64 
Ën
,

3916 
u64
 *
»Ëa£d
, 
ä“
)

3918 
ex‹Á_chªge£t
 
chªge£t
;

3919 
Œaû_İ
 = 
QGROUP_RELEASE
;

3920 
»t
;

3922 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
šode
->
roÙ
->
fs_šfo
->
æags
))

3926 
	`WARN_ON
(!
ä“
 && 
»£rved
);

3927 ià(
ä“
 && 
»£rved
)

3928  
	`qgroup_ä“_»£rved_d©a
(
šode
, 
»£rved
, 
¡¬t
, 
Ën
, 
»Ëa£d
);

3929 
	`ex‹Á_chªge£t_š™
(&
chªge£t
);

3930 
»t
 = 
	`ş—r_»cÜd_ex‹Á_b™s
(&
šode
->
io_Œ“
, 
¡¬t
, s¹ + 
Ën
 -1,

3931 
EXTENT_QGROUP_RESERVED
, &
chªge£t
);

3932 ià(
»t
 < 0)

3933 
out
;

3935 ià(
ä“
)

3936 
Œaû_İ
 = 
QGROUP_FREE
;

3937 
	`Œaû_bŒfs_qgroup_»Ëa£_d©a
(&
šode
->
vfs_šode
, 
¡¬t
, 
Ën
,

3938 
chªge£t
.
by‹s_chªged
, 
Œaû_İ
);

3939 ià(
ä“
)

3940 
	`bŒfs_qgroup_ä“_»äoÙ
(
šode
->
roÙ
->
fs_šfo
,

3941 
šode
->
roÙ
->
roÙ_key
.
objeùid
,

3942 
chªge£t
.
by‹s_chªged
, 
BTRFS_QGROUP_RSV_DATA
);

3943 ià(
»Ëa£d
)

3944 *
»Ëa£d
 = 
chªge£t
.
by‹s_chªged
;

3945 
out
:

3946 
	`ex‹Á_chªge£t_»Ëa£
(&
chªge£t
);

3947  
»t
;

3948 
	}
}

3962 
	$bŒfs_qgroup_ä“_d©a
(
bŒfs_šode
 *
šode
,

3963 
ex‹Á_chªge£t
 *
»£rved
,

3964 
u64
 
¡¬t
, u64 
Ën
, u64 *
ä“d
)

3966  
	`__bŒfs_qgroup_»Ëa£_d©a
(
šode
, 
»£rved
, 
¡¬t
, 
Ën
, 
ä“d
, 1);

3967 
	}
}

3984 
	$bŒfs_qgroup_»Ëa£_d©a
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
Ën
, u64 *
»Ëa£d
)

3986  
	`__bŒfs_qgroup_»Ëa£_d©a
(
šode
, 
NULL
, 
¡¬t
, 
Ën
, 
»Ëa£d
, 0);

3987 
	}
}

3989 
	$add_roÙ_m‘a_rsv
(
bŒfs_roÙ
 *
roÙ
, 
num_by‹s
,

3990 
bŒfs_qgroup_rsv_ty³
 
ty³
)

3992 ià(
ty³
 !ğ
BTRFS_QGROUP_RSV_META_PREALLOC
 &&

3993 
ty³
 !ğ
BTRFS_QGROUP_RSV_META_PERTRANS
)

3995 ià(
num_by‹s
 == 0)

3998 
	`¥š_lock
(&
roÙ
->
qgroup_m‘a_rsv_lock
);

3999 ià(
ty³
 =ğ
BTRFS_QGROUP_RSV_META_PREALLOC
)

4000 
roÙ
->
qgroup_m‘a_rsv_´—Îoc
 +ğ
num_by‹s
;

4002 
roÙ
->
qgroup_m‘a_rsv_³¹¿ns
 +ğ
num_by‹s
;

4003 
	`¥š_uÆock
(&
roÙ
->
qgroup_m‘a_rsv_lock
);

4004 
	}
}

4006 
	$sub_roÙ_m‘a_rsv
(
bŒfs_roÙ
 *
roÙ
, 
num_by‹s
,

4007 
bŒfs_qgroup_rsv_ty³
 
ty³
)

4009 ià(
ty³
 !ğ
BTRFS_QGROUP_RSV_META_PREALLOC
 &&

4010 
ty³
 !ğ
BTRFS_QGROUP_RSV_META_PERTRANS
)

4012 ià(
num_by‹s
 == 0)

4015 
	`¥š_lock
(&
roÙ
->
qgroup_m‘a_rsv_lock
);

4016 ià(
ty³
 =ğ
BTRFS_QGROUP_RSV_META_PREALLOC
) {

4017 
num_by‹s
 = 
	`mš_t
(
u64
, 
roÙ
->
qgroup_m‘a_rsv_´—Îoc
,

4018 
num_by‹s
);

4019 
roÙ
->
qgroup_m‘a_rsv_´—Îoc
 -ğ
num_by‹s
;

4021 
num_by‹s
 = 
	`mš_t
(
u64
, 
roÙ
->
qgroup_m‘a_rsv_³¹¿ns
,

4022 
num_by‹s
);

4023 
roÙ
->
qgroup_m‘a_rsv_³¹¿ns
 -ğ
num_by‹s
;

4025 
	`¥š_uÆock
(&
roÙ
->
qgroup_m‘a_rsv_lock
);

4026  
num_by‹s
;

4027 
	}
}

4029 
	$bŒfs_qgroup_»£rve_m‘a
(
bŒfs_roÙ
 *
roÙ
, 
num_by‹s
,

4030 
bŒfs_qgroup_rsv_ty³
 
ty³
, 
boŞ
 
’fÜû
)

4032 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4033 
»t
;

4035 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
) ||

4036 !
	`is_f¡»e
(
roÙ
->
roÙ_key
.
objeùid
è|| 
num_by‹s
 == 0)

4039 
	`BUG_ON
(
num_by‹s
 !ğ
	`round_down
Òum_by‹s, 
fs_šfo
->
nodesize
));

4040 
	`Œaû_qgroup_m‘a_»£rve
(
roÙ
, (
s64
)
num_by‹s
, 
ty³
);

4041 
»t
 = 
	`qgroup_»£rve
(
roÙ
, 
num_by‹s
, 
’fÜû
, 
ty³
);

4042 ià(
»t
 < 0)

4043  
»t
;

4052 
	`add_roÙ_m‘a_rsv
(
roÙ
, 
num_by‹s
, 
ty³
);

4053  
»t
;

4054 
	}
}

4056 
	$__bŒfs_qgroup_»£rve_m‘a
(
bŒfs_roÙ
 *
roÙ
, 
num_by‹s
,

4057 
bŒfs_qgroup_rsv_ty³
 
ty³
, 
boŞ
 
’fÜû
,

4058 
boŞ
 
noæush
)

4060 
»t
;

4062 
»t
 = 
	`bŒfs_qgroup_»£rve_m‘a
(
roÙ
, 
num_by‹s
, 
ty³
, 
’fÜû
);

4063 ià((
»t
 <ğ0 &&„‘ !ğ-
EDQUOT
è|| 
noæush
)

4064  
»t
;

4066 
»t
 = 
	`Œy_æush_qgroup
(
roÙ
);

4067 ià(
»t
 < 0)

4068  
»t
;

4069  
	`bŒfs_qgroup_»£rve_m‘a
(
roÙ
, 
num_by‹s
, 
ty³
, 
’fÜû
);

4070 
	}
}

4072 
	$bŒfs_qgroup_ä“_m‘a_®l_³¹¿ns
(
bŒfs_roÙ
 *
roÙ
)

4074 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4076 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
) ||

4077 !
	`is_f¡»e
(
roÙ
->
roÙ_key
.
objeùid
))

4081 
	`Œaû_qgroup_m‘a_ä“_®l_³¹¿ns
(
roÙ
);

4083 
	`bŒfs_qgroup_ä“_»äoÙ
(
fs_šfo
, 
roÙ
->
roÙ_key
.
objeùid
, (
u64
)-1,

4084 
BTRFS_QGROUP_RSV_META_PERTRANS
);

4085 
	}
}

4087 
	$__bŒfs_qgroup_ä“_m‘a
(
bŒfs_roÙ
 *
roÙ
, 
num_by‹s
,

4088 
bŒfs_qgroup_rsv_ty³
 
ty³
)

4090 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4092 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
) ||

4093 !
	`is_f¡»e
(
roÙ
->
roÙ_key
.
objeùid
))

4101 
num_by‹s
 = 
	`sub_roÙ_m‘a_rsv
(
roÙ
,‚um_by‹s, 
ty³
);

4102 
	`BUG_ON
(
num_by‹s
 !ğ
	`round_down
Òum_by‹s, 
fs_šfo
->
nodesize
));

4103 
	`Œaû_qgroup_m‘a_»£rve
(
roÙ
, -(
s64
)
num_by‹s
, 
ty³
);

4104 
	`bŒfs_qgroup_ä“_»äoÙ
(
fs_šfo
, 
roÙ
->
roÙ_key
.
objeùid
,

4105 
num_by‹s
, 
ty³
);

4106 
	}
}

4108 
	$qgroup_cÚv”t_m‘a
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
»f_roÙ
,

4109 
num_by‹s
)

4111 
bŒfs_qgroup
 *
qgroup
;

4112 
uli¡_node
 *
unode
;

4113 
uli¡_™”©Ü
 
u™”
;

4114 
»t
 = 0;

4116 ià(
num_by‹s
 == 0)

4118 ià(!
fs_šfo
->
quÙa_roÙ
)

4121 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

4122 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
»f_roÙ
);

4123 ià(!
qgroup
)

4124 
out
;

4125 
	`uli¡_»š™
(
fs_šfo
->
qgroup_uli¡
);

4126 
»t
 = 
	`uli¡_add
(
fs_šfo
->
qgroup_uli¡
, 
qgroup
->
qgroupid
,

4127 
	`qgroup_to_aux
(
qgroup
), 
GFP_ATOMIC
);

4128 ià(
»t
 < 0)

4129 
out
;

4130 
	`ULIST_ITER_INIT
(&
u™”
);

4131 (
unode
 = 
	`uli¡_Ãxt
(
fs_šfo
->
qgroup_uli¡
, &
u™”
))) {

4132 
bŒfs_qgroup
 *
qg
;

4133 
bŒfs_qgroup_li¡
 *
gli¡
;

4135 
qg
 = 
	`unode_aux_to_qgroup
(
unode
);

4137 
	`qgroup_rsv_»Ëa£
(
fs_šfo
, 
qg
, 
num_by‹s
,

4138 
BTRFS_QGROUP_RSV_META_PREALLOC
);

4139 
	`qgroup_rsv_add
(
fs_šfo
, 
qg
, 
num_by‹s
,

4140 
BTRFS_QGROUP_RSV_META_PERTRANS
);

4141 
	`li¡_fÜ_—ch_’Œy
(
gli¡
, &
qg
->
groups
, 
Ãxt_group
) {

4142 
»t
 = 
	`uli¡_add
(
fs_šfo
->
qgroup_uli¡
,

4143 
gli¡
->
group
->
qgroupid
,

4144 
	`qgroup_to_aux
(
gli¡
->
group
), 
GFP_ATOMIC
);

4145 ià(
»t
 < 0)

4146 
out
;

4149 
out
:

4150 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

4151 
	}
}

4153 
	$bŒfs_qgroup_cÚv”t_»£rved_m‘a
(
bŒfs_roÙ
 *
roÙ
, 
num_by‹s
)

4155 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4157 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
) ||

4158 !
	`is_f¡»e
(
roÙ
->
roÙ_key
.
objeùid
))

4161 
num_by‹s
 = 
	`sub_roÙ_m‘a_rsv
(
roÙ
,‚um_bytes,

4162 
BTRFS_QGROUP_RSV_META_PREALLOC
);

4163 
	`Œaû_qgroup_m‘a_cÚv”t
(
roÙ
, 
num_by‹s
);

4164 
	`qgroup_cÚv”t_m‘a
(
fs_šfo
, 
roÙ
->
roÙ_key
.
objeùid
, 
num_by‹s
);

4165 
	}
}

4171 
	$bŒfs_qgroup_check_»£rved_Ëak
(
bŒfs_šode
 *
šode
)

4173 
ex‹Á_chªge£t
 
chªge£t
;

4174 
uli¡_node
 *
unode
;

4175 
uli¡_™”©Ü
 
™”
;

4176 
»t
;

4178 
	`ex‹Á_chªge£t_š™
(&
chªge£t
);

4179 
»t
 = 
	`ş—r_»cÜd_ex‹Á_b™s
(&
šode
->
io_Œ“
, 0, (
u64
)-1,

4180 
EXTENT_QGROUP_RESERVED
, &
chªge£t
);

4182 
	`WARN_ON
(
»t
 < 0);

4183 ià(
	`WARN_ON
(
chªge£t
.
by‹s_chªged
)) {

4184 
	`ULIST_ITER_INIT
(&
™”
);

4185 (
unode
 = 
	`uli¡_Ãxt
(&
chªge£t
.
¿nge_chªged
, &
™”
))) {

4186 
	`bŒfs_w¬n
(
šode
->
roÙ
->
fs_šfo
,

4188 
	`bŒfs_šo
(
šode
), 
unode
->
v®
, unode->
aux
);

4190 
	`bŒfs_qgroup_ä“_»äoÙ
(
šode
->
roÙ
->
fs_šfo
,

4191 
šode
->
roÙ
->
roÙ_key
.
objeùid
,

4192 
chªge£t
.
by‹s_chªged
, 
BTRFS_QGROUP_RSV_DATA
);

4195 
	`ex‹Á_chªge£t_»Ëa£
(&
chªge£t
);

4196 
	}
}

4198 
	$bŒfs_qgroup_š™_sw­³d_blocks
(

4199 
bŒfs_qgroup_sw­³d_blocks
 *
sw­³d_blocks
)

4201 
i
;

4203 
	`¥š_lock_š™
(&
sw­³d_blocks
->
lock
);

4204 
i
 = 0; i < 
BTRFS_MAX_LEVEL
; i++)

4205 
sw­³d_blocks
->
blocks
[
i
] = 
RB_ROOT
;

4206 
sw­³d_blocks
->
sw­³d
 = 
çl£
;

4207 
	}
}

4215 
	$bŒfs_qgroup_ş—n_sw­³d_blocks
(
bŒfs_roÙ
 *
roÙ
)

4217 
bŒfs_qgroup_sw­³d_blocks
 *
sw­³d_blocks
;

4218 
i
;

4220 
sw­³d_blocks
 = &
roÙ
->swapped_blocks;

4222 
	`¥š_lock
(&
sw­³d_blocks
->
lock
);

4223 ià(!
sw­³d_blocks
->
sw­³d
)

4224 
out
;

4225 
i
 = 0; i < 
BTRFS_MAX_LEVEL
; i++) {

4226 
rb_roÙ
 *
cur_roÙ
 = &
sw­³d_blocks
->
blocks
[
i
];

4227 
bŒfs_qgroup_sw­³d_block
 *
’Œy
;

4228 
bŒfs_qgroup_sw­³d_block
 *
Ãxt
;

4230 
	`rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
’Œy
, 
Ãxt
, 
cur_roÙ
,

4231 
node
)

4232 
	`kä“
(
’Œy
);

4233 
sw­³d_blocks
->
blocks
[
i
] = 
RB_ROOT
;

4235 
sw­³d_blocks
->
sw­³d
 = 
çl£
;

4236 
out
:

4237 
	`¥š_uÆock
(&
sw­³d_blocks
->
lock
);

4238 
	}
}

4250 
	$bŒfs_qgroup_add_sw­³d_blocks
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4251 
bŒfs_roÙ
 *
subvŞ_roÙ
,

4252 
bŒfs_block_group
 *
bg
,

4253 
ex‹Á_bufãr
 *
subvŞ_·»Á
, 
subvŞ_¦Ù
,

4254 
ex‹Á_bufãr
 *
»loc_·»Á
, 
»loc_¦Ù
,

4255 
u64
 
Ï¡_¢­shÙ
)

4257 
bŒfs_fs_šfo
 *
fs_šfo
 = 
subvŞ_roÙ
->fs_info;

4258 
bŒfs_qgroup_sw­³d_blocks
 *
blocks
 = &
subvŞ_roÙ
->
sw­³d_blocks
;

4259 
bŒfs_qgroup_sw­³d_block
 *
block
;

4260 
rb_node
 **
cur
;

4261 
rb_node
 *
·»Á
 = 
NULL
;

4262 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
subvŞ_·»Á
) - 1;

4263 
»t
 = 0;

4265 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

4268 ià(
	`bŒfs_node_±r_g’”©iÚ
(
subvŞ_·»Á
, 
subvŞ_¦Ù
) >

4269 
	`bŒfs_node_±r_g’”©iÚ
(
»loc_·»Á
, 
»loc_¦Ù
)) {

4270 
	`bŒfs_”r_¾
(
fs_šfo
,

4272 
__func__
,

4273 
	`bŒfs_node_±r_g’”©iÚ
(
subvŞ_·»Á
, 
subvŞ_¦Ù
),

4274 
	`bŒfs_node_±r_g’”©iÚ
(
»loc_·»Á
, 
»loc_¦Ù
));

4275  -
EUCLEAN
;

4278 
block
 = 
	`km®loc
((*block), 
GFP_NOFS
);

4279 ià(!
block
) {

4280 
»t
 = -
ENOMEM
;

4281 
out
;

4288 
block
->
subvŞ_by‹Ä
 = 
	`bŒfs_node_block±r
(
»loc_·»Á
, 
»loc_¦Ù
);

4289 
block
->
subvŞ_g’”©iÚ
 = 
	`bŒfs_node_±r_g’”©iÚ
(
»loc_·»Á
,

4290 
»loc_¦Ù
);

4291 
block
->
»loc_by‹Ä
 = 
	`bŒfs_node_block±r
(
subvŞ_·»Á
, 
subvŞ_¦Ù
);

4292 
block
->
»loc_g’”©iÚ
 = 
	`bŒfs_node_±r_g’”©iÚ
(
subvŞ_·»Á
,

4293 
subvŞ_¦Ù
);

4294 
block
->
Ï¡_¢­shÙ
 =†ast_snapshot;

4295 
block
->
Ëv–
 =†evel;

4302 ià(
bg
 && bg->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

4303 
block
->
Œaû_Ëaf
 = 
Œue
;

4305 
block
->
Œaû_Ëaf
 = 
çl£
;

4306 
	`bŒfs_node_key_to_ıu
(
»loc_·»Á
, &
block
->
fœ¡_key
, 
»loc_¦Ù
);

4309 
	`¥š_lock
(&
blocks
->
lock
);

4310 
cur
 = &
blocks
->blocks[
Ëv–
].
rb_node
;

4311 *
cur
) {

4312 
bŒfs_qgroup_sw­³d_block
 *
’Œy
;

4314 
·»Á
 = *
cur
;

4315 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
bŒfs_qgroup_sw­³d_block
,

4316 
node
);

4318 ià(
’Œy
->
subvŞ_by‹Ä
 < 
block
->subvol_bytenr) {

4319 
cur
 = &(*cur)->
rb_Ëá
;

4320 } ià(
’Œy
->
subvŞ_by‹Ä
 > 
block
->subvol_bytenr) {

4321 
cur
 = &(*cur)->
rb_right
;

4323 ià(
’Œy
->
subvŞ_g’”©iÚ
 !=

4324 
block
->
subvŞ_g’”©iÚ
 ||

4325 
’Œy
->
»loc_by‹Ä
 !ğ
block
->reloc_bytenr ||

4326 
’Œy
->
»loc_g’”©iÚ
 !=

4327 
block
->
»loc_g’”©iÚ
) {

4335 
	`WARN_ON
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
));

4336 
»t
 = -
EEXIST
;

4338 
	`kä“
(
block
);

4339 
out_uÆock
;

4342 
	`rb_lšk_node
(&
block
->
node
, 
·»Á
, 
cur
);

4343 
	`rb_š£¹_cŞÜ
(&
block
->
node
, &
blocks
->blocks[
Ëv–
]);

4344 
blocks
->
sw­³d
 = 
Œue
;

4345 
out_uÆock
:

4346 
	`¥š_uÆock
(&
blocks
->
lock
);

4347 
out
:

4348 ià(
»t
 < 0)

4349 
	`qgroup_m¬k_šcÚsi¡’t
(
fs_šfo
);

4350  
»t
;

4351 
	}
}

4359 
	$bŒfs_qgroup_Œaû_subŒ“_aá”_cow
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4360 
bŒfs_roÙ
 *
roÙ
,

4361 
ex‹Á_bufãr
 *
subvŞ_eb
)

4363 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4364 
bŒfs_Œ“_·»Á_check
 
check
 = { 0 };

4365 
bŒfs_qgroup_sw­³d_blocks
 *
blocks
 = &
roÙ
->
sw­³d_blocks
;

4366 
bŒfs_qgroup_sw­³d_block
 *
block
;

4367 
ex‹Á_bufãr
 *
»loc_eb
 = 
NULL
;

4368 
rb_node
 *
node
;

4369 
boŞ
 
found
 = 
çl£
;

4370 
boŞ
 
sw­³d
 = 
çl£
;

4371 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
subvŞ_eb
);

4372 
»t
 = 0;

4373 
i
;

4375 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

4377 ià(!
	`is_f¡»e
(
roÙ
->
roÙ_key
.
objeùid
è|| !roÙ->
»loc_roÙ
)

4380 
	`¥š_lock
(&
blocks
->
lock
);

4381 ià(!
blocks
->
sw­³d
) {

4382 
	`¥š_uÆock
(&
blocks
->
lock
);

4385 
node
 = 
blocks
->blocks[
Ëv–
].
rb_node
;

4387 
node
) {

4388 
block
 = 
	`rb_’Œy
(
node
, 
bŒfs_qgroup_sw­³d_block
,‚ode);

4389 ià(
block
->
subvŞ_by‹Ä
 < 
subvŞ_eb
->
¡¬t
) {

4390 
node
 =‚ode->
rb_Ëá
;

4391 } ià(
block
->
subvŞ_by‹Ä
 > 
subvŞ_eb
->
¡¬t
) {

4392 
node
 =‚ode->
rb_right
;

4394 
found
 = 
Œue
;

4398 ià(!
found
) {

4399 
	`¥š_uÆock
(&
blocks
->
lock
);

4400 
out
;

4403 
	`rb_”a£
(&
block
->
node
, &
blocks
->blocks[
Ëv–
]);

4404 
i
 = 0; i < 
BTRFS_MAX_LEVEL
; i++) {

4405 ià(
	`RB_EMPTY_ROOT
(&
blocks
->blocks[
i
])) {

4406 
sw­³d
 = 
Œue
;

4410 
blocks
->
sw­³d
 = swapped;

4411 
	`¥š_uÆock
(&
blocks
->
lock
);

4413 
check
.
Ëv–
 = 
block
->level;

4414 
check
.
Œªsid
 = 
block
->
»loc_g’”©iÚ
;

4415 
check
.
has_fœ¡_key
 = 
Œue
;

4416 
	`memıy
(&
check
.
fœ¡_key
, &
block
->first_key, (check.first_key));

4419 
»loc_eb
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
block
->
»loc_by‹Ä
, &
check
);

4420 ià(
	`IS_ERR
(
»loc_eb
)) {

4421 
»t
 = 
	`PTR_ERR
(
»loc_eb
);

4422 
»loc_eb
 = 
NULL
;

4423 
ä“_out
;

4425 ià(!
	`ex‹Á_bufãr_u±od©e
(
»loc_eb
)) {

4426 
»t
 = -
EIO
;

4427 
ä“_out
;

4430 
»t
 = 
	`qgroup_Œaû_subŒ“_sw­
(
Œªs
, 
»loc_eb
, 
subvŞ_eb
,

4431 
block
->
Ï¡_¢­shÙ
, block->
Œaû_Ëaf
);

4432 
ä“_out
:

4433 
	`kä“
(
block
);

4434 
	`ä“_ex‹Á_bufãr
(
»loc_eb
);

4435 
out
:

4436 ià(
»t
 < 0) {

4437 
	`bŒfs_”r_¾
(
fs_šfo
,

4439 
subvŞ_eb
->
¡¬t
, 
»t
);

4440 
	`qgroup_m¬k_šcÚsi¡’t
(
fs_šfo
);

4442  
»t
;

4443 
	}
}

4445 
	$bŒfs_qgroup_de¡roy_ex‹Á_»cÜds
(
bŒfs_Œª§ùiÚ
 *
Œªs
)

4447 
bŒfs_qgroup_ex‹Á_»cÜd
 *
’Œy
;

4448 
bŒfs_qgroup_ex‹Á_»cÜd
 *
Ãxt
;

4449 
rb_roÙ
 *
roÙ
;

4451 
roÙ
 = &
Œªs
->
d–ayed_»fs
.
dœty_ex‹Á_roÙ
;

4452 
	`rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
’Œy
, 
Ãxt
, 
roÙ
, 
node
) {

4453 
	`uli¡_ä“
(
’Œy
->
Şd_roÙs
);

4454 
	`kä“
(
’Œy
);

4456 *
roÙ
 = 
RB_ROOT
;

4457 
	}
}

	@qgroup.h

6 #iâdeà
BTRFS_QGROUP_H


7 
	#BTRFS_QGROUP_H


	)

9 
	~<lšux/¥šlock.h
>

10 
	~<lšux/rbŒ“.h
>

11 
	~<lšux/kobjeù.h
>

12 
	~"uli¡.h
"

13 
	~"d–ayed-»f.h
"

14 
	~"misc.h
"

104 
	#BTRFS_QGROUP_RUNTIME_FLAG_CANCEL_RESCAN
 (1UL << 3)

	)

105 
	#BTRFS_QGROUP_RUNTIME_FLAG_NO_ACCOUNTING
 (1UL << 4)

	)

111 
	sbŒfs_qgroup_ex‹Á_»cÜd
 {

112 
rb_node
 
	mnode
;

113 
u64
 
	mby‹Ä
;

114 
u64
 
	mnum_by‹s
;

124 
u32
 
	md©a_rsv
;

125 
u64
 
	md©a_rsv_»äoÙ
;

126 
uli¡
 *
	mŞd_roÙs
;

129 
	sbŒfs_qgroup_sw­³d_block
 {

130 
rb_node
 
	mnode
;

132 
	mËv–
;

133 
boŞ
 
	mŒaû_Ëaf
;

136 
u64
 
	msubvŞ_by‹Ä
;

137 
u64
 
	msubvŞ_g’”©iÚ
;

140 
u64
 
	m»loc_by‹Ä
;

141 
u64
 
	m»loc_g’”©iÚ
;

143 
u64
 
	mÏ¡_¢­shÙ
;

144 
bŒfs_key
 
	mfœ¡_key
;

168 
	ebŒfs_qgroup_rsv_ty³
 {

169 
	mBTRFS_QGROUP_RSV_DATA
,

170 
	mBTRFS_QGROUP_RSV_META_PERTRANS
,

171 
	mBTRFS_QGROUP_RSV_META_PREALLOC
,

172 
	mBTRFS_QGROUP_RSV_LAST
,

185 
	sbŒfs_qgroup_rsv
 {

186 
u64
 
	mv®ues
[
BTRFS_QGROUP_RSV_LAST
];

192 
	sbŒfs_qgroup
 {

193 
u64
 
	mqgroupid
;

198 
u64
 
	mrãr
;

199 
u64
 
	mrãr_cm´
;

200 
u64
 
	mexş
;

201 
u64
 
	mexş_cm´
;

206 
u64
 
	mlim_æags
;

207 
u64
 
	mmax_rãr
;

208 
u64
 
	mmax_exş
;

209 
u64
 
	mrsv_rãr
;

210 
u64
 
	mrsv_exş
;

215 
bŒfs_qgroup_rsv
 
	mrsv
;

220 
li¡_h—d
 
	mgroups
;

221 
li¡_h—d
 
	mmemb”s
;

222 
li¡_h—d
 
	mdœty
;

223 
rb_node
 
	mnode
;

229 
u64
 
	mŞd_»fút
;

230 
u64
 
	mÃw_»fút
;

235 
kobjeù
 
	mkobj
;

238 
šlše
 
u64
 
	$bŒfs_qgroup_subvŞid
(
u64
 
qgroupid
)

240  (
qgroupid
 & ((1ULL << 
BTRFS_QGROUP_LEVEL_SHIFT
) - 1));

241 
	}
}

247 
ENUM_BIT
(
QGROUP_RESERVE
),

248 
ENUM_BIT
(
QGROUP_RELEASE
),

249 
ENUM_BIT
(
QGROUP_FREE
),

252 
bŒfs_quÙa_’abË
(
bŒfs_fs_šfo
 *
fs_šfo
);

253 
bŒfs_quÙa_di§bË
(
bŒfs_fs_šfo
 *
fs_šfo
);

254 
bŒfs_qgroup_»sÿn
(
bŒfs_fs_šfo
 *
fs_šfo
);

255 
bŒfs_qgroup_»sÿn_»sume
(
bŒfs_fs_šfo
 *
fs_šfo
);

256 
bŒfs_qgroup_wa™_fÜ_com¶‘iÚ
(
bŒfs_fs_šfo
 *
fs_šfo
,

257 
boŞ
 
š‹¼u±ibË
);

258 
bŒfs_add_qgroup_»ÏtiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
¤c
,

259 
u64
 
d¡
);

260 
bŒfs_d–_qgroup_»ÏtiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
¤c
,

261 
u64
 
d¡
);

262 
bŒfs_ü—‹_qgroup
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
qgroupid
);

263 
bŒfs_»move_qgroup
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
qgroupid
);

264 
bŒfs_lim™_qgroup
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
qgroupid
,

265 
bŒfs_qgroup_lim™
 *
lim™
);

266 
bŒfs_»ad_qgroup_cÚfig
(
bŒfs_fs_šfo
 *
fs_šfo
);

267 
bŒfs_ä“_qgroup_cÚfig
(
bŒfs_fs_šfo
 *
fs_šfo
);

268 
	gbŒfs_d–ayed_ex‹Á_İ
;

281 
bŒfs_qgroup_Œaû_ex‹Á_nŞock
(

282 
bŒfs_fs_šfo
 *
fs_šfo
,

283 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

284 
bŒfs_qgroup_ex‹Á_»cÜd
 *
»cÜd
);

307 
bŒfs_qgroup_Œaû_ex‹Á_po¡
(
bŒfs_Œªs_hªdË
 *
Œªs
,

308 
bŒfs_qgroup_ex‹Á_»cÜd
 *
q»cÜd
);

323 
bŒfs_qgroup_Œaû_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
by‹Ä
,

324 
u64
 
num_by‹s
);

332 
bŒfs_qgroup_Œaû_Ëaf_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

333 
ex‹Á_bufãr
 *
eb
);

344 
bŒfs_qgroup_Œaû_subŒ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

345 
ex‹Á_bufãr
 *
roÙ_eb
,

346 
u64
 
roÙ_g’
, 
roÙ_Ëv–
);

347 
bŒfs_qgroup_accouÁ_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
by‹Ä
,

348 
u64
 
num_by‹s
, 
uli¡
 *
Şd_roÙs
,

349 
uli¡
 *
Ãw_roÙs
);

350 
bŒfs_qgroup_accouÁ_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
);

351 
bŒfs_run_qgroups
(
bŒfs_Œªs_hªdË
 *
Œªs
);

352 
bŒfs_qgroup_šh”™
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
¤cid
,

353 
u64
 
objeùid
, 
bŒfs_qgroup_šh”™
 *
šh”™
);

354 
bŒfs_qgroup_ä“_»äoÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

355 
u64
 
»f_roÙ
, u64 
num_by‹s
,

356 
bŒfs_qgroup_rsv_ty³
 
ty³
);

358 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


359 
bŒfs_v”ify_qgroup_couÁs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
qgroupid
,

360 
u64
 
rãr
, u64 
exş
);

364 
bŒfs_qgroup_»£rve_d©a
(
bŒfs_šode
 *
šode
,

365 
ex‹Á_chªge£t
 **
»£rved
, 
u64
 
¡¬t
, u64 
Ën
);

366 
bŒfs_qgroup_»Ëa£_d©a
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
Ën
, u64 *
»Ëa£d
);

367 
bŒfs_qgroup_ä“_d©a
(
bŒfs_šode
 *
šode
,

368 
ex‹Á_chªge£t
 *
»£rved
, 
u64
 
¡¬t
,

369 
u64
 
Ën
, u64 *
ä“d
);

370 
bŒfs_qgroup_»£rve_m‘a
(
bŒfs_roÙ
 *
roÙ
, 
num_by‹s
,

371 
bŒfs_qgroup_rsv_ty³
 
ty³
, 
boŞ
 
’fÜû
);

372 
__bŒfs_qgroup_»£rve_m‘a
(
bŒfs_roÙ
 *
roÙ
, 
num_by‹s
,

373 
bŒfs_qgroup_rsv_ty³
 
ty³
, 
boŞ
 
’fÜû
,

374 
boŞ
 
noæush
);

376 
šlše
 
	$bŒfs_qgroup_»£rve_m‘a_³¹¿ns
(
bŒfs_roÙ
 *
roÙ
,

377 
num_by‹s
, 
boŞ
 
’fÜû
)

379  
	`__bŒfs_qgroup_»£rve_m‘a
(
roÙ
, 
num_by‹s
,

380 
BTRFS_QGROUP_RSV_META_PERTRANS
,

381 
’fÜû
, 
çl£
);

382 
	}
}

383 
šlše
 
	$bŒfs_qgroup_»£rve_m‘a_´—Îoc
(
bŒfs_roÙ
 *
roÙ
,

384 
num_by‹s
, 
boŞ
 
’fÜû
,

385 
boŞ
 
noæush
)

387  
	`__bŒfs_qgroup_»£rve_m‘a
(
roÙ
, 
num_by‹s
,

388 
BTRFS_QGROUP_RSV_META_PREALLOC
,

389 
’fÜû
, 
noæush
);

390 
	}
}

392 
__bŒfs_qgroup_ä“_m‘a
(
bŒfs_roÙ
 *
roÙ
, 
num_by‹s
,

393 
bŒfs_qgroup_rsv_ty³
 
ty³
);

396 
šlše
 
	$bŒfs_qgroup_ä“_m‘a_³¹¿ns
(
bŒfs_roÙ
 *
roÙ
,

397 
num_by‹s
)

399 
	`__bŒfs_qgroup_ä“_m‘a
(
roÙ
, 
num_by‹s
,

400 
BTRFS_QGROUP_RSV_META_PERTRANS
);

401 
	}
}

404 
šlše
 
	$bŒfs_qgroup_ä“_m‘a_´—Îoc
(
bŒfs_roÙ
 *
roÙ
,

405 
num_by‹s
)

407 
	`__bŒfs_qgroup_ä“_m‘a
(
roÙ
, 
num_by‹s
,

408 
BTRFS_QGROUP_RSV_META_PREALLOC
);

409 
	}
}

415 
bŒfs_qgroup_ä“_m‘a_®l_³¹¿ns
(
bŒfs_roÙ
 *
roÙ
);

423 
bŒfs_qgroup_cÚv”t_»£rved_m‘a
(
bŒfs_roÙ
 *
roÙ
, 
num_by‹s
);

425 
bŒfs_qgroup_check_»£rved_Ëak
(
bŒfs_šode
 *
šode
);

428 
bŒfs_qgroup_š™_sw­³d_blocks
(

429 
bŒfs_qgroup_sw­³d_blocks
 *
sw­³d_blocks
);

431 
bŒfs_qgroup_ş—n_sw­³d_blocks
(
bŒfs_roÙ
 *
roÙ
);

432 
bŒfs_qgroup_add_sw­³d_blocks
(
bŒfs_Œªs_hªdË
 *
Œªs
,

433 
bŒfs_roÙ
 *
subvŞ_roÙ
,

434 
bŒfs_block_group
 *
bg
,

435 
ex‹Á_bufãr
 *
subvŞ_·»Á
, 
subvŞ_¦Ù
,

436 
ex‹Á_bufãr
 *
»loc_·»Á
, 
»loc_¦Ù
,

437 
u64
 
Ï¡_¢­shÙ
);

438 
bŒfs_qgroup_Œaû_subŒ“_aá”_cow
(
bŒfs_Œªs_hªdË
 *
Œªs
,

439 
bŒfs_roÙ
 *
roÙ
, 
ex‹Á_bufãr
 *
eb
);

440 
bŒfs_qgroup_de¡roy_ex‹Á_»cÜds
(
bŒfs_Œª§ùiÚ
 *
Œªs
);

441 
boŞ
 
bŒfs_check_quÙa_Ëak
(
bŒfs_fs_šfo
 *
fs_šfo
);

	@raid56.c

7 
	~<lšux/sched.h
>

8 
	~<lšux/bio.h
>

9 
	~<lšux/¦ab.h
>

10 
	~<lšux/blkdev.h
>

11 
	~<lšux/¿id/pq.h
>

12 
	~<lšux/hash.h
>

13 
	~<lšux/li¡_sÜt.h
>

14 
	~<lšux/¿id/xÜ.h
>

15 
	~<lšux/mm.h
>

16 
	~"mes§ges.h
"

17 
	~"misc.h
"

18 
	~"ù»e.h
"

19 
	~"disk-io.h
"

20 
	~"vŞumes.h
"

21 
	~"¿id56.h
"

22 
	~"async-th»ad.h
"

23 
	~"fe-™em.h
"

24 
	~"bŒfs_šode.h
"

27 
	#RBIO_RMW_LOCKED_BIT
 1

	)

33 
	#RBIO_CACHE_BIT
 2

	)

38 
	#RBIO_CACHE_READY_BIT
 3

	)

40 
	#RBIO_CACHE_SIZE
 1024

	)

42 
	#BTRFS_STRIPE_HASH_TABLE_BITS
 11

	)

45 
	sbŒfs_¡re_hash
 {

46 
li¡_h—d
 
	mhash_li¡
;

47 
¥šlock_t
 
	mlock
;

51 
	sbŒfs_¡re_hash_bË
 {

52 
li¡_h—d
 
	m¡re_ÿche
;

53 
¥šlock_t
 
	mÿche_lock
;

54 
	mÿche_size
;

55 
bŒfs_¡re_hash
 
	mbË
[];

63 
	s£ùÜ_±r
 {

64 
·ge
 *
	m·ge
;

65 
	mpgoff
:24;

66 
	mu±od©e
:8;

69 
rmw_rbio_wÜk
(
wÜk_¡ruù
 *
wÜk
);

70 
rmw_rbio_wÜk_locked
(
wÜk_¡ruù
 *
wÜk
);

71 
šdex_rbio_·ges
(
bŒfs_¿id_bio
 *
rbio
);

72 
®loc_rbio_·ges
(
bŒfs_¿id_bio
 *
rbio
);

74 
fšish_·r™y_süub
(
bŒfs_¿id_bio
 *
rbio
);

75 
süub_rbio_wÜk_locked
(
wÜk_¡ruù
 *
wÜk
);

77 
	$ä“_¿id_bio_poš‹rs
(
bŒfs_¿id_bio
 *
rbio
)

79 
	`b™m­_ä“
(
rbio
->
”rÜ_b™m­
);

80 
	`kä“
(
rbio
->
¡re_·ges
);

81 
	`kä“
(
rbio
->
bio_£ùÜs
);

82 
	`kä“
(
rbio
->
¡re_£ùÜs
);

83 
	`kä“
(
rbio
->
fšish_poš‹rs
);

84 
	}
}

86 
	$ä“_¿id_bio
(
bŒfs_¿id_bio
 *
rbio
)

88 
i
;

90 ià(!
	`»fcouÁ_dec_ªd_‹¡
(&
rbio
->
»fs
))

93 
	`WARN_ON
(!
	`li¡_em±y
(&
rbio
->
¡re_ÿche
));

94 
	`WARN_ON
(!
	`li¡_em±y
(&
rbio
->
hash_li¡
));

95 
	`WARN_ON
(!
	`bio_li¡_em±y
(&
rbio
->
bio_li¡
));

97 
i
 = 0; i < 
rbio
->
Ä_·ges
; i++) {

98 ià(
rbio
->
¡re_·ges
[
i
]) {

99 
	`__ä“_·ge
(
rbio
->
¡re_·ges
[
i
]);

100 
rbio
->
¡re_·ges
[
i
] = 
NULL
;

104 
	`bŒfs_put_bioc
(
rbio
->
bioc
);

105 
	`ä“_¿id_bio_poš‹rs
(
rbio
);

106 
	`kä“
(
rbio
);

107 
	}
}

109 
	$¡¬t_async_wÜk
(
bŒfs_¿id_bio
 *
rbio
, 
wÜk_func_t
 
wÜk_func
)

111 
	`INIT_WORK
(&
rbio
->
wÜk
, 
wÜk_func
);

112 
	`queue_wÜk
(
rbio
->
bioc
->
fs_šfo
->
rmw_wÜk”s
, &rbio->
wÜk
);

113 
	}
}

119 
	$bŒfs_®loc_¡re_hash_bË
(
bŒfs_fs_šfo
 *
šfo
)

121 
bŒfs_¡re_hash_bË
 *
bË
;

122 
bŒfs_¡re_hash_bË
 *
x
;

123 
bŒfs_¡re_hash
 *
cur
;

124 
bŒfs_¡re_hash
 *
h
;

125 
num_’Œ›s
 = 1 << 
BTRFS_STRIPE_HASH_TABLE_BITS
;

126 
i
;

128 ià(
šfo
->
¡re_hash_bË
)

138 
bË
 = 
	`kvz®loc
(
	`¡ruù_size
ÑabË,abË, 
num_’Œ›s
), 
GFP_KERNEL
);

139 ià(!
bË
)

140  -
ENOMEM
;

142 
	`¥š_lock_š™
(&
bË
->
ÿche_lock
);

143 
	`INIT_LIST_HEAD
(&
bË
->
¡re_ÿche
);

145 
h
 = 
bË
->table;

147 
i
 = 0; i < 
num_’Œ›s
; i++) {

148 
cur
 = 
h
 + 
i
;

149 
	`INIT_LIST_HEAD
(&
cur
->
hash_li¡
);

150 
	`¥š_lock_š™
(&
cur
->
lock
);

153 
x
 = 
	`cmpxchg
(&
šfo
->
¡re_hash_bË
, 
NULL
, 
bË
);

154 
	`kvä“
(
x
);

156 
	}
}

167 
	$ÿche_rbio_·ges
(
bŒfs_¿id_bio
 *
rbio
)

169 
i
;

170 
»t
;

172 
»t
 = 
	`®loc_rbio_·ges
(
rbio
);

173 ià(
»t
)

176 
i
 = 0; i < 
rbio
->
Ä_£ùÜs
; i++) {

178 ià(!
rbio
->
bio_£ùÜs
[
i
].
·ge
) {

184 ià(
i
 < 
rbio
->
Ä_d©a
 *„bio->
¡re_n£ùÜs
)

185 
	`ASSERT
(
rbio
->
¡re_£ùÜs
[
i
].
u±od©e
);

189 
	`ASSERT
(
rbio
->
¡re_£ùÜs
[
i
].
·ge
);

190 
	`memıy_·ge
(
rbio
->
¡re_£ùÜs
[
i
].
·ge
,

191 
rbio
->
¡re_£ùÜs
[
i
].
pgoff
,

192 
rbio
->
bio_£ùÜs
[
i
].
·ge
,

193 
rbio
->
bio_£ùÜs
[
i
].
pgoff
,

194 
rbio
->
bioc
->
fs_šfo
->
£ùÜsize
);

195 
rbio
->
¡re_£ùÜs
[
i
].
u±od©e
 = 1;

197 
	`£t_b™
(
RBIO_CACHE_READY_BIT
, &
rbio
->
æags
);

198 
	}
}

203 
	$rbio_buck‘
(
bŒfs_¿id_bio
 *
rbio
)

205 
u64
 
num
 = 
rbio
->
bioc
->
fuÎ_¡re_logiÿl
;

215  
	`hash_64
(
num
 >> 16, 
BTRFS_STRIPE_HASH_TABLE_BITS
);

216 
	}
}

218 
boŞ
 
	$fuÎ_·ge_£ùÜs_u±od©e
(
bŒfs_¿id_bio
 *
rbio
,

219 
·ge_Ä
)

221 cÚ¡ 
u32
 
£ùÜsize
 = 
rbio
->
bioc
->
fs_šfo
->sectorsize;

222 cÚ¡ 
u32
 
£ùÜs_³r_·ge
 = 
PAGE_SIZE
 / 
£ùÜsize
;

223 
i
;

225 
	`ASSERT
(
·ge_Ä
 < 
rbio
->
Ä_·ges
);

227 
i
 = 
£ùÜs_³r_·ge
 * 
·ge_Ä
;

228 
i
 < 
£ùÜs_³r_·ge
 * 
·ge_Ä
 + sectors_per_page;

229 
i
++) {

230 ià(!
rbio
->
¡re_£ùÜs
[
i
].
u±od©e
)

231  
çl£
;

233  
Œue
;

234 
	}
}

241 
	$šdex_¡re_£ùÜs
(
bŒfs_¿id_bio
 *
rbio
)

243 cÚ¡ 
u32
 
£ùÜsize
 = 
rbio
->
bioc
->
fs_šfo
->sectorsize;

244 
u32
 
off£t
;

245 
i
;

247 
i
 = 0, 
off£t
 = 0; i < 
rbio
->
Ä_£ùÜs
; i++, off£ˆ+ğ
£ùÜsize
) {

248 
·ge_šdex
 = 
off£t
 >> 
PAGE_SHIFT
;

250 
	`ASSERT
(
·ge_šdex
 < 
rbio
->
Ä_·ges
);

251 
rbio
->
¡re_£ùÜs
[
i
].
·ge
 =„bio->
¡re_·ges
[
·ge_šdex
];

252 
rbio
->
¡re_£ùÜs
[
i
].
pgoff
 = 
	`off£t_š_·ge
(
off£t
);

254 
	}
}

256 
	$¡—l_rbio_·ge
(
bŒfs_¿id_bio
 *
¤c
,

257 
bŒfs_¿id_bio
 *
de¡
, 
·ge_Ä
)

259 cÚ¡ 
u32
 
£ùÜsize
 = 
¤c
->
bioc
->
fs_šfo
->sectorsize;

260 cÚ¡ 
u32
 
£ùÜs_³r_·ge
 = 
PAGE_SIZE
 / 
£ùÜsize
;

261 
i
;

263 ià(
de¡
->
¡re_·ges
[
·ge_Ä
])

264 
	`__ä“_·ge
(
de¡
->
¡re_·ges
[
·ge_Ä
]);

265 
de¡
->
¡re_·ges
[
·ge_Ä
] = 
¤c
->stripe_pages[page_nr];

266 
¤c
->
¡re_·ges
[
·ge_Ä
] = 
NULL
;

269 
i
 = 
£ùÜs_³r_·ge
 * 
·ge_Ä
;

270 
i
 < 
£ùÜs_³r_·ge
 * 
·ge_Ä
 + sectors_per_page; i++)

271 
de¡
->
¡re_£ùÜs
[
i
].
u±od©e
 = 
Œue
;

272 
	}
}

274 
boŞ
 
	$is_d©a_¡re_·ge
(
bŒfs_¿id_bio
 *
rbio
, 
·ge_Ä
)

276 cÚ¡ 
£ùÜ_Ä
 = (
·ge_Ä
 << 
PAGE_SHIFT
) >>

277 
rbio
->
bioc
->
fs_šfo
->
£ùÜsize_b™s
;

286  (
£ùÜ_Ä
 < 
rbio
->
Ä_d©a
 *„bio->
¡re_n£ùÜs
);

287 
	}
}

296 
	$¡—l_rbio
(
bŒfs_¿id_bio
 *
¤c
, bŒfs_¿id_biØ*
de¡
)

298 
i
;

300 ià(!
	`‹¡_b™
(
RBIO_CACHE_READY_BIT
, &
¤c
->
æags
))

303 
i
 = 0; i < 
de¡
->
Ä_·ges
; i++) {

304 
·ge
 *
p
 = 
¤c
->
¡re_·ges
[
i
];

310 ià(!
	`is_d©a_¡re_·ge
(
¤c
, 
i
))

317 
	`ASSERT
(
p
);

318 
	`ASSERT
(
	`fuÎ_·ge_£ùÜs_u±od©e
(
¤c
, 
i
));

319 
	`¡—l_rbio_·ge
(
¤c
, 
de¡
, 
i
);

321 
	`šdex_¡re_£ùÜs
(
de¡
);

322 
	`šdex_¡re_£ùÜs
(
¤c
);

323 
	}
}

332 
	$m”ge_rbio
(
bŒfs_¿id_bio
 *
de¡
,

333 
bŒfs_¿id_bio
 *
viùim
)

335 
	`bio_li¡_m”ge
(&
de¡
->
bio_li¡
, &
viùim
->bio_list);

336 
de¡
->
bio_li¡_by‹s
 +ğ
viùim
->bio_list_bytes;

338 
	`b™m­_Ü
(&
de¡
->
db™m­
, &
viùim
->dbitmap, &dest->dbitmap,

339 
de¡
->
¡re_n£ùÜs
);

340 
	`bio_li¡_š™
(&
viùim
->
bio_li¡
);

341 
	}
}

347 
	$__»move_rbio_äom_ÿche
(
bŒfs_¿id_bio
 *
rbio
)

349 
buck‘
 = 
	`rbio_buck‘
(
rbio
);

350 
bŒfs_¡re_hash_bË
 *
bË
;

351 
bŒfs_¡re_hash
 *
h
;

352 
ä“™
 = 0;

357 ià(!
	`‹¡_b™
(
RBIO_CACHE_BIT
, &
rbio
->
æags
))

360 
bË
 = 
rbio
->
bioc
->
fs_šfo
->
¡re_hash_bË
;

361 
h
 = 
bË
->bË + 
buck‘
;

366 
	`¥š_lock
(&
h
->
lock
);

372 
	`¥š_lock
(&
rbio
->
bio_li¡_lock
);

374 ià(
	`‹¡_ªd_ş—r_b™
(
RBIO_CACHE_BIT
, &
rbio
->
æags
)) {

375 
	`li¡_d–_š™
(&
rbio
->
¡re_ÿche
);

376 
bË
->
ÿche_size
 -= 1;

377 
ä“™
 = 1;

388 ià(
	`bio_li¡_em±y
(&
rbio
->
bio_li¡
)) {

389 ià(!
	`li¡_em±y
(&
rbio
->
hash_li¡
)) {

390 
	`li¡_d–_š™
(&
rbio
->
hash_li¡
);

391 
	`»fcouÁ_dec
(&
rbio
->
»fs
);

392 
	`BUG_ON
(!
	`li¡_em±y
(&
rbio
->
¶ug_li¡
));

397 
	`¥š_uÆock
(&
rbio
->
bio_li¡_lock
);

398 
	`¥š_uÆock
(&
h
->
lock
);

400 ià(
ä“™
)

401 
	`ä“_¿id_bio
(
rbio
);

402 
	}
}

407 
	$»move_rbio_äom_ÿche
(
bŒfs_¿id_bio
 *
rbio
)

409 
bŒfs_¡re_hash_bË
 *
bË
;

411 ià(!
	`‹¡_b™
(
RBIO_CACHE_BIT
, &
rbio
->
æags
))

414 
bË
 = 
rbio
->
bioc
->
fs_šfo
->
¡re_hash_bË
;

416 
	`¥š_lock
(&
bË
->
ÿche_lock
);

417 
	`__»move_rbio_äom_ÿche
(
rbio
);

418 
	`¥š_uÆock
(&
bË
->
ÿche_lock
);

419 
	}
}

424 
	$bŒfs_ş—r_rbio_ÿche
(
bŒfs_fs_šfo
 *
šfo
)

426 
bŒfs_¡re_hash_bË
 *
bË
;

427 
bŒfs_¿id_bio
 *
rbio
;

429 
bË
 = 
šfo
->
¡re_hash_bË
;

431 
	`¥š_lock
(&
bË
->
ÿche_lock
);

432 !
	`li¡_em±y
(&
bË
->
¡re_ÿche
)) {

433 
rbio
 = 
	`li¡_’Œy
(
bË
->
¡re_ÿche
.
Ãxt
,

434 
bŒfs_¿id_bio
,

435 
¡re_ÿche
);

436 
	`__»move_rbio_äom_ÿche
(
rbio
);

438 
	`¥š_uÆock
(&
bË
->
ÿche_lock
);

439 
	}
}

445 
	$bŒfs_ä“_¡re_hash_bË
(
bŒfs_fs_šfo
 *
šfo
)

447 ià(!
šfo
->
¡re_hash_bË
)

449 
	`bŒfs_ş—r_rbio_ÿche
(
šfo
);

450 
	`kvä“
(
šfo
->
¡re_hash_bË
);

451 
šfo
->
¡re_hash_bË
 = 
NULL
;

452 
	}
}

465 
	$ÿche_rbio
(
bŒfs_¿id_bio
 *
rbio
)

467 
bŒfs_¡re_hash_bË
 *
bË
;

469 ià(!
	`‹¡_b™
(
RBIO_CACHE_READY_BIT
, &
rbio
->
æags
))

472 
bË
 = 
rbio
->
bioc
->
fs_šfo
->
¡re_hash_bË
;

474 
	`¥š_lock
(&
bË
->
ÿche_lock
);

475 
	`¥š_lock
(&
rbio
->
bio_li¡_lock
);

478 ià(!
	`‹¡_ªd_£t_b™
(
RBIO_CACHE_BIT
, &
rbio
->
æags
))

479 
	`»fcouÁ_šc
(&
rbio
->
»fs
);

481 ià(!
	`li¡_em±y
(&
rbio
->
¡re_ÿche
)){

482 
	`li¡_move
(&
rbio
->
¡re_ÿche
, &
bË
->stripe_cache);

484 
	`li¡_add
(&
rbio
->
¡re_ÿche
, &
bË
->stripe_cache);

485 
bË
->
ÿche_size
 += 1;

488 
	`¥š_uÆock
(&
rbio
->
bio_li¡_lock
);

490 ià(
bË
->
ÿche_size
 > 
RBIO_CACHE_SIZE
) {

491 
bŒfs_¿id_bio
 *
found
;

493 
found
 = 
	`li¡_’Œy
(
bË
->
¡re_ÿche
.
´ev
,

494 
bŒfs_¿id_bio
,

495 
¡re_ÿche
);

497 ià(
found
 !ğ
rbio
)

498 
	`__»move_rbio_äom_ÿche
(
found
);

501 
	`¥š_uÆock
(&
bË
->
ÿche_lock
);

502 
	}
}

509 
	$run_xÜ
(**
·ges
, 
¤c_út
, 
ssize_t
 
Ën
)

511 
¤c_off
 = 0;

512 
xÜ_¤c_út
 = 0;

513 *
de¡
 = 
·ges
[
¤c_út
];

515 
¤c_út
 > 0) {

516 
xÜ_¤c_út
 = 
	`mš
(
¤c_út
, 
MAX_XOR_BLOCKS
);

517 
	`xÜ_blocks
(
xÜ_¤c_út
, 
Ën
, 
de¡
, 
·ges
 + 
¤c_off
);

519 
¤c_út
 -ğ
xÜ_¤c_út
;

520 
¤c_off
 +ğ
xÜ_¤c_út
;

522 
	}
}

528 
	$rbio_is_fuÎ
(
bŒfs_¿id_bio
 *
rbio
)

530 
size
 = 
rbio
->
bio_li¡_by‹s
;

531 
»t
 = 1;

533 
	`¥š_lock
(&
rbio
->
bio_li¡_lock
);

534 ià(
size
 !ğ
rbio
->
Ä_d©a
 * 
BTRFS_STRIPE_LEN
)

535 
»t
 = 0;

536 
	`BUG_ON
(
size
 > 
rbio
->
Ä_d©a
 * 
BTRFS_STRIPE_LEN
);

537 
	`¥š_uÆock
(&
rbio
->
bio_li¡_lock
);

539  
»t
;

540 
	}
}

552 
	$rbio_ÿn_m”ge
(
bŒfs_¿id_bio
 *
Ï¡
,

553 
bŒfs_¿id_bio
 *
cur
)

555 ià(
	`‹¡_b™
(
RBIO_RMW_LOCKED_BIT
, &
Ï¡
->
æags
) ||

556 
	`‹¡_b™
(
RBIO_RMW_LOCKED_BIT
, &
cur
->
æags
))

566 ià(
	`‹¡_b™
(
RBIO_CACHE_BIT
, &
Ï¡
->
æags
) ||

567 
	`‹¡_b™
(
RBIO_CACHE_BIT
, &
cur
->
æags
))

570 ià(
Ï¡
->
bioc
->
fuÎ_¡re_logiÿl
 !ğ
cur
->bioc->full_stripe_logical)

574 ià(
Ï¡
->
İ”©iÚ
 !ğ
cur
->operation)

584 ià(
Ï¡
->
İ”©iÚ
 =ğ
BTRFS_RBIO_PARITY_SCRUB
)

587 ià(
Ï¡
->
İ”©iÚ
 =ğ
BTRFS_RBIO_READ_REBUILD
)

591 
	}
}

593 
	$rbio_¡re_£ùÜ_šdex
(cÚ¡ 
bŒfs_¿id_bio
 *
rbio
,

594 
¡re_Ä
,

595 
£ùÜ_Ä
)

597 
	`ASSERT
(
¡re_Ä
 < 
rbio
->
»®_¡res
);

598 
	`ASSERT
(
£ùÜ_Ä
 < 
rbio
->
¡re_n£ùÜs
);

600  
¡re_Ä
 * 
rbio
->
¡re_n£ùÜs
 + 
£ùÜ_Ä
;

601 
	}
}

604 
£ùÜ_±r
 *
	$rbio_¡re_£ùÜ
(cÚ¡ 
bŒfs_¿id_bio
 *
rbio
,

605 
¡re_Ä
,

606 
£ùÜ_Ä
)

608  &
rbio
->
¡re_£ùÜs
[
	`rbio_¡re_£ùÜ_šdex
Ôbio, 
¡re_Ä
,

609 
£ùÜ_Ä
)];

610 
	}
}

613 
£ùÜ_±r
 *
	$rbio_p¡re_£ùÜ
(cÚ¡ 
bŒfs_¿id_bio
 *
rbio
,

614 
£ùÜ_Ä
)

616  
	`rbio_¡re_£ùÜ
(
rbio
,„bio->
Ä_d©a
, 
£ùÜ_Ä
);

617 
	}
}

620 
£ùÜ_±r
 *
	$rbio_q¡re_£ùÜ
(cÚ¡ 
bŒfs_¿id_bio
 *
rbio
,

621 
£ùÜ_Ä
)

623 ià(
rbio
->
Ä_d©a
 + 1 =ğrbio->
»®_¡res
)

624  
NULL
;

625  
	`rbio_¡re_£ùÜ
(
rbio
,„bio->
Ä_d©a
 + 1, 
£ùÜ_Ä
);

626 
	}
}

650 
nošlše
 
	$lock_¡re_add
(
bŒfs_¿id_bio
 *
rbio
)

652 
bŒfs_¡re_hash
 *
h
;

653 
bŒfs_¿id_bio
 *
cur
;

654 
bŒfs_¿id_bio
 *
³ndšg
;

655 
bŒfs_¿id_bio
 *
ä“™
 = 
NULL
;

656 
bŒfs_¿id_bio
 *
ÿche_drİ
 = 
NULL
;

657 
»t
 = 0;

659 
h
 = 
rbio
->
bioc
->
fs_šfo
->
¡re_hash_bË
->
bË
 + 
	`rbio_buck‘
(rbio);

661 
	`¥š_lock
(&
h
->
lock
);

662 
	`li¡_fÜ_—ch_’Œy
(
cur
, &
h
->
hash_li¡
, hash_list) {

663 ià(
cur
->
bioc
->
fuÎ_¡re_logiÿl
 !ğ
rbio
->bioc->full_stripe_logical)

666 
	`¥š_lock
(&
cur
->
bio_li¡_lock
);

669 ià(
	`bio_li¡_em±y
(&
cur
->
bio_li¡
) &&

670 
	`li¡_em±y
(&
cur
->
¶ug_li¡
) &&

671 
	`‹¡_b™
(
RBIO_CACHE_BIT
, &
cur
->
æags
) &&

672 !
	`‹¡_b™
(
RBIO_RMW_LOCKED_BIT
, &
cur
->
æags
)) {

673 
	`li¡_d–_š™
(&
cur
->
hash_li¡
);

674 
	`»fcouÁ_dec
(&
cur
->
»fs
);

676 
	`¡—l_rbio
(
cur
, 
rbio
);

677 
ÿche_drİ
 = 
cur
;

678 
	`¥š_uÆock
(&
cur
->
bio_li¡_lock
);

680 
lock™
;

684 ià(
	`rbio_ÿn_m”ge
(
cur
, 
rbio
)) {

685 
	`m”ge_rbio
(
cur
, 
rbio
);

686 
	`¥š_uÆock
(&
cur
->
bio_li¡_lock
);

687 
ä“™
 = 
rbio
;

688 
»t
 = 1;

689 
out
;

698 
	`li¡_fÜ_—ch_’Œy
(
³ndšg
, &
cur
->
¶ug_li¡
,…lug_list) {

699 ià(
	`rbio_ÿn_m”ge
(
³ndšg
, 
rbio
)) {

700 
	`m”ge_rbio
(
³ndšg
, 
rbio
);

701 
	`¥š_uÆock
(&
cur
->
bio_li¡_lock
);

702 
ä“™
 = 
rbio
;

703 
»t
 = 1;

704 
out
;

712 
	`li¡_add_
(&
rbio
->
¶ug_li¡
, &
cur
->plug_list);

713 
	`¥š_uÆock
(&
cur
->
bio_li¡_lock
);

714 
»t
 = 1;

715 
out
;

717 
lock™
:

718 
	`»fcouÁ_šc
(&
rbio
->
»fs
);

719 
	`li¡_add
(&
rbio
->
hash_li¡
, &
h
->hash_list);

720 
out
:

721 
	`¥š_uÆock
(&
h
->
lock
);

722 ià(
ÿche_drİ
)

723 
	`»move_rbio_äom_ÿche
(
ÿche_drİ
);

724 ià(
ä“™
)

725 
	`ä“_¿id_bio
(
ä“™
);

726  
»t
;

727 
	}
}

729 
»cov”_rbio_wÜk_locked
(
wÜk_¡ruù
 *
wÜk
);

735 
nošlše
 
	$uÆock_¡re
(
bŒfs_¿id_bio
 *
rbio
)

737 
buck‘
;

738 
bŒfs_¡re_hash
 *
h
;

739 
k“p_ÿche
 = 0;

741 
buck‘
 = 
	`rbio_buck‘
(
rbio
);

742 
h
 = 
rbio
->
bioc
->
fs_šfo
->
¡re_hash_bË
->
bË
 + 
buck‘
;

744 ià(
	`li¡_em±y
(&
rbio
->
¶ug_li¡
))

745 
	`ÿche_rbio
(
rbio
);

747 
	`¥š_lock
(&
h
->
lock
);

748 
	`¥š_lock
(&
rbio
->
bio_li¡_lock
);

750 ià(!
	`li¡_em±y
(&
rbio
->
hash_li¡
)) {

756 ià(
	`li¡_em±y
(&
rbio
->
¶ug_li¡
) &&

757 
	`‹¡_b™
(
RBIO_CACHE_BIT
, &
rbio
->
æags
)) {

758 
k“p_ÿche
 = 1;

759 
	`ş—r_b™
(
RBIO_RMW_LOCKED_BIT
, &
rbio
->
æags
);

760 
	`BUG_ON
(!
	`bio_li¡_em±y
(&
rbio
->
bio_li¡
));

761 
dÚe
;

764 
	`li¡_d–_š™
(&
rbio
->
hash_li¡
);

765 
	`»fcouÁ_dec
(&
rbio
->
»fs
);

772 ià(!
	`li¡_em±y
(&
rbio
->
¶ug_li¡
)) {

773 
bŒfs_¿id_bio
 *
Ãxt
;

774 
li¡_h—d
 *
h—d
 = 
rbio
->
¶ug_li¡
.
Ãxt
;

776 
Ãxt
 = 
	`li¡_’Œy
(
h—d
, 
bŒfs_¿id_bio
,

777 
¶ug_li¡
);

779 
	`li¡_d–_š™
(&
rbio
->
¶ug_li¡
);

781 
	`li¡_add
(&
Ãxt
->
hash_li¡
, &
h
->hash_list);

782 
	`»fcouÁ_šc
(&
Ãxt
->
»fs
);

783 
	`¥š_uÆock
(&
rbio
->
bio_li¡_lock
);

784 
	`¥š_uÆock
(&
h
->
lock
);

786 ià(
Ãxt
->
İ”©iÚ
 =ğ
BTRFS_RBIO_READ_REBUILD
) {

787 
	`¡¬t_async_wÜk
(
Ãxt
, 
»cov”_rbio_wÜk_locked
);

788 } ià(
Ãxt
->
İ”©iÚ
 =ğ
BTRFS_RBIO_WRITE
) {

789 
	`¡—l_rbio
(
rbio
, 
Ãxt
);

790 
	`¡¬t_async_wÜk
(
Ãxt
, 
rmw_rbio_wÜk_locked
);

791 } ià(
Ãxt
->
İ”©iÚ
 =ğ
BTRFS_RBIO_PARITY_SCRUB
) {

792 
	`¡—l_rbio
(
rbio
, 
Ãxt
);

793 
	`¡¬t_async_wÜk
(
Ãxt
, 
süub_rbio_wÜk_locked
);

796 
dÚe_nŞock
;

799 
dÚe
:

800 
	`¥š_uÆock
(&
rbio
->
bio_li¡_lock
);

801 
	`¥š_uÆock
(&
h
->
lock
);

803 
dÚe_nŞock
:

804 ià(!
k“p_ÿche
)

805 
	`»move_rbio_äom_ÿche
(
rbio
);

806 
	}
}

808 
	$rbio_’dio_bio_li¡
(
bio
 *
cur
, 
blk_¡©us_t
 
”r
)

810 
bio
 *
Ãxt
;

812 
cur
) {

813 
Ãxt
 = 
cur
->
bi_Ãxt
;

814 
cur
->
bi_Ãxt
 = 
NULL
;

815 
cur
->
bi_¡©us
 = 
”r
;

816 
	`bio_’dio
(
cur
);

817 
cur
 = 
Ãxt
;

819 
	}
}

825 
	$rbio_Üig_’d_io
(
bŒfs_¿id_bio
 *
rbio
, 
blk_¡©us_t
 
”r
)

827 
bio
 *
cur
 = 
	`bio_li¡_g‘
(&
rbio
->
bio_li¡
);

828 
bio
 *
exŒa
;

830 
	`kä“
(
rbio
->
csum_buf
);

831 
	`b™m­_ä“
(
rbio
->
csum_b™m­
);

832 
rbio
->
csum_buf
 = 
NULL
;

833 
rbio
->
csum_b™m­
 = 
NULL
;

840 
	`b™m­_ş—r
(&
rbio
->
db™m­
, 0,„bio->
¡re_n£ùÜs
);

850 
	`uÆock_¡re
(
rbio
);

851 
exŒa
 = 
	`bio_li¡_g‘
(&
rbio
->
bio_li¡
);

852 
	`ä“_¿id_bio
(
rbio
);

854 
	`rbio_’dio_bio_li¡
(
cur
, 
”r
);

855 ià(
exŒa
)

856 
	`rbio_’dio_bio_li¡
(
exŒa
, 
”r
);

857 
	}
}

871 
£ùÜ_±r
 *
	$£ùÜ_š_rbio
(
bŒfs_¿id_bio
 *
rbio
,

872 
¡re_Ä
, 
£ùÜ_Ä
,

873 
boŞ
 
bio_li¡_Úly
)

875 
£ùÜ_±r
 *
£ùÜ
;

876 
šdex
;

878 
	`ASSERT
(
¡re_Ä
 >ğ0 && sŒe_Ä < 
rbio
->
»®_¡res
);

879 
	`ASSERT
(
£ùÜ_Ä
 >ğ0 && seùÜ_Ä < 
rbio
->
¡re_n£ùÜs
);

881 
šdex
 = 
¡re_Ä
 * 
rbio
->
¡re_n£ùÜs
 + 
£ùÜ_Ä
;

882 
	`ASSERT
(
šdex
 >ğ0 && index < 
rbio
->
Ä_£ùÜs
);

884 
	`¥š_lock
(&
rbio
->
bio_li¡_lock
);

885 
£ùÜ
 = &
rbio
->
bio_£ùÜs
[
šdex
];

886 ià(
£ùÜ
->
·ge
 || 
bio_li¡_Úly
) {

888 ià(!
£ùÜ
->
·ge
)

889 
£ùÜ
 = 
NULL
;

890 
	`¥š_uÆock
(&
rbio
->
bio_li¡_lock
);

891  
£ùÜ
;

893 
	`¥š_uÆock
(&
rbio
->
bio_li¡_lock
);

895  &
rbio
->
¡re_£ùÜs
[
šdex
];

896 
	}
}

902 
bŒfs_¿id_bio
 *
	$®loc_rbio
(
bŒfs_fs_šfo
 *
fs_šfo
,

903 
bŒfs_io_cÚ‹xt
 *
bioc
)

905 cÚ¡ 
»®_¡res
 = 
bioc
->
num_¡res
 - bioc->
»¶aû_Ä_¡res
;

906 cÚ¡ 
¡re_Åages
 = 
BTRFS_STRIPE_LEN
 >> 
PAGE_SHIFT
;

907 cÚ¡ 
num_·ges
 = 
¡re_Åages
 * 
»®_¡res
;

908 cÚ¡ 
¡re_n£ùÜs
 =

909 
BTRFS_STRIPE_LEN
 >> 
fs_šfo
->
£ùÜsize_b™s
;

910 cÚ¡ 
num_£ùÜs
 = 
¡re_n£ùÜs
 * 
»®_¡res
;

911 
bŒfs_¿id_bio
 *
rbio
;

914 
	`ASSERT
(
	`IS_ALIGNED
(
PAGE_SIZE
, 
fs_šfo
->
£ùÜsize
));

919 
	`ASSERT
(
¡re_n£ùÜs
 <ğ
BITS_PER_LONG
);

921 
rbio
 = 
	`kz®loc
((*rbio), 
GFP_NOFS
);

922 ià(!
rbio
)

923  
	`ERR_PTR
(-
ENOMEM
);

924 
rbio
->
¡re_·ges
 = 
	`kÿÎoc
(
num_·ges
, (
·ge
 *),

925 
GFP_NOFS
);

926 
rbio
->
bio_£ùÜs
 = 
	`kÿÎoc
(
num_£ùÜs
, (
£ùÜ_±r
),

927 
GFP_NOFS
);

928 
rbio
->
¡re_£ùÜs
 = 
	`kÿÎoc
(
num_£ùÜs
, (
£ùÜ_±r
),

929 
GFP_NOFS
);

930 
rbio
->
fšish_poš‹rs
 = 
	`kÿÎoc
(
»®_¡res
, (*), 
GFP_NOFS
);

931 
rbio
->
”rÜ_b™m­
 = 
	`b™m­_z®loc
(
num_£ùÜs
, 
GFP_NOFS
);

933 ià(!
rbio
->
¡re_·ges
 || !rbio->
bio_£ùÜs
 || !rbio->
¡re_£ùÜs
 ||

934 !
rbio
->
fšish_poš‹rs
 || !rbio->
”rÜ_b™m­
) {

935 
	`ä“_¿id_bio_poš‹rs
(
rbio
);

936 
	`kä“
(
rbio
);

937  
	`ERR_PTR
(-
ENOMEM
);

940 
	`bio_li¡_š™
(&
rbio
->
bio_li¡
);

941 
	`š™_wa™queue_h—d
(&
rbio
->
io_wa™
);

942 
	`INIT_LIST_HEAD
(&
rbio
->
¶ug_li¡
);

943 
	`¥š_lock_š™
(&
rbio
->
bio_li¡_lock
);

944 
	`INIT_LIST_HEAD
(&
rbio
->
¡re_ÿche
);

945 
	`INIT_LIST_HEAD
(&
rbio
->
hash_li¡
);

946 
	`bŒfs_g‘_bioc
(
bioc
);

947 
rbio
->
bioc
 = bioc;

948 
rbio
->
Ä_·ges
 = 
num_·ges
;

949 
rbio
->
Ä_£ùÜs
 = 
num_£ùÜs
;

950 
rbio
->
»®_¡res
 =„eal_stripes;

951 
rbio
->
¡re_Åages
 = stripe_npages;

952 
rbio
->
¡re_n£ùÜs
 = stripe_nsectors;

953 
	`»fcouÁ_£t
(&
rbio
->
»fs
, 1);

954 
	`©omic_£t
(&
rbio
->
¡res_³ndšg
, 0);

956 
	`ASSERT
(
	`bŒfs_Ä_·r™y_¡res
(
bioc
->
m­_ty³
));

957 
rbio
->
Ä_d©a
 = 
»®_¡res
 - 
	`bŒfs_Ä_·r™y_¡res
(
bioc
->
m­_ty³
);

959  
rbio
;

960 
	}
}

963 
	$®loc_rbio_·ges
(
bŒfs_¿id_bio
 *
rbio
)

965 
»t
;

967 
»t
 = 
	`bŒfs_®loc_·ge_¬¿y
(
rbio
->
Ä_·ges
,„bio->
¡re_·ges
);

968 ià(
»t
 < 0)

969  
»t
;

971 
	`šdex_¡re_£ùÜs
(
rbio
);

973 
	}
}

976 
	$®loc_rbio_·r™y_·ges
(
bŒfs_¿id_bio
 *
rbio
)

978 cÚ¡ 
d©a_·ges
 = 
rbio
->
Ä_d©a
 *„bio->
¡re_Åages
;

979 
»t
;

981 
»t
 = 
	`bŒfs_®loc_·ge_¬¿y
(
rbio
->
Ä_·ges
 - 
d©a_·ges
,

982 
rbio
->
¡re_·ges
 + 
d©a_·ges
);

983 ià(
»t
 < 0)

984  
»t
;

986 
	`šdex_¡re_£ùÜs
(
rbio
);

988 
	}
}

996 
	$g‘_rbio_v”™iÿl_”rÜs
(
bŒfs_¿id_bio
 *
rbio
, 
£ùÜ_Ä
,

997 *
ça
, *
çb
)

999 
¡re_Ä
;

1000 
found_”rÜs
 = 0;

1002 ià(
ça
 || 
çb
) {

1007 
	`ASSERT
(
ça
 && 
çb
);

1008 *
ça
 = -1;

1009 *
çb
 = -1;

1012 
¡re_Ä
 = 0; sŒe_Ä < 
rbio
->
»®_¡res
; stripe_nr++) {

1013 
tÙ®_£ùÜ_Ä
 = 
¡re_Ä
 * 
rbio
->
¡re_n£ùÜs
 + 
£ùÜ_Ä
;

1015 ià(
	`‹¡_b™
(
tÙ®_£ùÜ_Ä
, 
rbio
->
”rÜ_b™m­
)) {

1016 
found_”rÜs
++;

1017 ià(
ça
) {

1019 ià(*
ça
 < 0)

1020 *
ça
 = 
¡re_Ä
;

1021 ià(*
çb
 < 0)

1022 *
çb
 = 
¡re_Ä
;

1026  
found_”rÜs
;

1027 
	}
}

1035 
	$rbio_add_io_£ùÜ
(
bŒfs_¿id_bio
 *
rbio
,

1036 
bio_li¡
 *bio_list,

1037 
£ùÜ_±r
 *
£ùÜ
,

1038 
¡re_Ä
,

1039 
£ùÜ_Ä
,

1040 
»q_İ
 
İ
)

1042 cÚ¡ 
u32
 
£ùÜsize
 = 
rbio
->
bioc
->
fs_šfo
->sectorsize;

1043 
bio
 *
Ï¡
 = 
bio_li¡
->

;

1044 
»t
;

1045 
bio
 *bio;

1046 
bŒfs_io_¡re
 *
¡re
;

1047 
u64
 
disk_¡¬t
;

1054 
	`ASSERT
(
¡re_Ä
 >ğ0 && sŒe_Ä < 
rbio
->
bioc
->
num_¡res
);

1055 
	`ASSERT
(
£ùÜ_Ä
 >ğ0 && seùÜ_Ä < 
rbio
->
¡re_n£ùÜs
);

1056 
	`ASSERT
(
£ùÜ
->
·ge
);

1058 
¡re
 = &
rbio
->
bioc
->
¡res
[
¡re_Ä
];

1059 
disk_¡¬t
 = 
¡re
->
physiÿl
 + 
£ùÜ_Ä
 * 
£ùÜsize
;

1062 ià(!
¡re
->
dev
->
bdev
) {

1063 
found_”rÜs
;

1065 
	`£t_b™
(
¡re_Ä
 * 
rbio
->
¡re_n£ùÜs
 + 
£ùÜ_Ä
,

1066 
rbio
->
”rÜ_b™m­
);

1069 
found_”rÜs
 = 
	`g‘_rbio_v”™iÿl_”rÜs
(
rbio
, 
£ùÜ_Ä
,

1070 
NULL
, NULL);

1071 ià(
found_”rÜs
 > 
rbio
->
bioc
->
max_”rÜs
)

1072  -
EIO
;

1077 ià(
Ï¡
) {

1078 
u64
 
Ï¡_’d
 = 
Ï¡
->
bi_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
;

1079 
Ï¡_’d
 +ğ
Ï¡
->
bi_™”
.
bi_size
;

1085 ià(
Ï¡_’d
 =ğ
disk_¡¬t
 && !
Ï¡
->
bi_¡©us
 &&

1086 
Ï¡
->
bi_bdev
 =ğ
¡re
->
dev
->
bdev
) {

1087 
»t
 = 
	`bio_add_·ge
(
Ï¡
, 
£ùÜ
->
·ge
, 
£ùÜsize
,

1088 
£ùÜ
->
pgoff
);

1089 ià(
»t
 =ğ
£ùÜsize
)

1095 
bio
 = 
	`bio_®loc
(
¡re
->
dev
->
bdev
,

1096 
	`max
(
BTRFS_STRIPE_LEN
 >> 
PAGE_SHIFT
, 1),

1097 
İ
, 
GFP_NOFS
);

1098 
bio
->
bi_™”
.
bi_£ùÜ
 = 
disk_¡¬t
 >> 
SECTOR_SHIFT
;

1099 
bio
->
bi_´iv©e
 = 
rbio
;

1101 
	`__bio_add_·ge
(
bio
, 
£ùÜ
->
·ge
, 
£ùÜsize
, seùÜ->
pgoff
);

1102 
	`bio_li¡_add
(
bio_li¡
, 
bio
);

1104 
	}
}

1106 
	$šdex_Úe_bio
(
bŒfs_¿id_bio
 *
rbio
, 
bio
 *bio)

1108 cÚ¡ 
u32
 
£ùÜsize
 = 
rbio
->
bioc
->
fs_šfo
->sectorsize;

1109 
bio_vec
 
bvec
;

1110 
bvec_™”
 
™”
;

1111 
u32
 
off£t
 = (
bio
->
bi_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
) -

1112 
rbio
->
bioc
->
fuÎ_¡re_logiÿl
;

1114 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
™”
) {

1115 
u32
 
bvec_off£t
;

1117 
bvec_off£t
 = 0; bvec_off£ˆ< 
bvec
.
bv_Ën
;

1118 
bvec_off£t
 +ğ
£ùÜsize
, 
off£t
 += sectorsize) {

1119 
šdex
 = 
off£t
 / 
£ùÜsize
;

1120 
£ùÜ_±r
 *
£ùÜ
 = &
rbio
->
bio_£ùÜs
[
šdex
];

1122 
£ùÜ
->
·ge
 = 
bvec
.
bv_·ge
;

1123 
£ùÜ
->
pgoff
 = 
bvec
.
bv_off£t
 + 
bvec_off£t
;

1124 
	`ASSERT
(
£ùÜ
->
pgoff
 < 
PAGE_SIZE
);

1127 
	}
}

1137 
	$šdex_rbio_·ges
(
bŒfs_¿id_bio
 *
rbio
)

1139 
bio
 *bio;

1141 
	`¥š_lock
(&
rbio
->
bio_li¡_lock
);

1142 
	`bio_li¡_fÜ_—ch
(
bio
, &
rbio
->
bio_li¡
)

1143 
	`šdex_Úe_bio
(
rbio
, 
bio
);

1145 
	`¥š_uÆock
(&
rbio
->
bio_li¡_lock
);

1146 
	}
}

1148 
	$bio_g‘_Œaû_šfo
(
bŒfs_¿id_bio
 *
rbio
, 
bio
 *bio,

1149 
¿id56_bio_Œaû_šfo
 *
Œaû_šfo
)

1151 cÚ¡ 
bŒfs_io_cÚ‹xt
 *
bioc
 = 
rbio
->bioc;

1152 
i
;

1154 
	`ASSERT
(
bioc
);

1157 ià(!
bio
->
bi_bdev
)

1158 
nÙ_found
;

1160 
i
 = 0; i < 
bioc
->
num_¡res
; i++) {

1161 ià(
bio
->
bi_bdev
 !ğ
bioc
->
¡res
[
i
].
dev
->
bdev
)

1163 
Œaû_šfo
->
¡re_Ä
 = 
i
;

1164 
Œaû_šfo
->
devid
 = 
bioc
->
¡res
[
i
].
dev
->devid;

1165 
Œaû_šfo
->
off£t
 = (
bio
->
bi_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
) -

1166 
bioc
->
¡res
[
i
].
physiÿl
;

1170 
nÙ_found
:

1171 
Œaû_šfo
->
devid
 = -1;

1172 
Œaû_šfo
->
off£t
 = -1;

1173 
Œaû_šfo
->
¡re_Ä
 = -1;

1174 
	}
}

1176 
šlše
 
	$bio_li¡_put
(
bio_li¡
 *bio_list)

1178 
bio
 *bio;

1180 (
bio
 = 
	`bio_li¡_pİ
(
bio_li¡
)))

1181 
	`bio_put
(
bio
);

1182 
	}
}

1185 
	$g’”©e_pq_v”tiÿl
(
bŒfs_¿id_bio
 *
rbio
, 
£ùÜÄ
)

1187 **
poš‹rs
 = 
rbio
->
fšish_poš‹rs
;

1188 cÚ¡ 
u32
 
£ùÜsize
 = 
rbio
->
bioc
->
fs_šfo
->sectorsize;

1189 
£ùÜ_±r
 *
£ùÜ
;

1190 
¡re
;

1191 cÚ¡ 
boŞ
 
has_q¡re
 = 
rbio
->
bioc
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_RAID6
;

1194 
¡re
 = 0; sŒ< 
rbio
->
Ä_d©a
; stripe++) {

1195 
£ùÜ
 = 
	`£ùÜ_š_rbio
(
rbio
, 
¡re
, 
£ùÜÄ
, 0);

1196 
poš‹rs
[
¡re
] = 
	`km­_loÿl_·ge
(
£ùÜ
->
·ge
) +

1197 
£ùÜ
->
pgoff
;

1201 
£ùÜ
 = 
	`rbio_p¡re_£ùÜ
(
rbio
, 
£ùÜÄ
);

1202 
£ùÜ
->
u±od©e
 = 1;

1203 
poš‹rs
[
¡re
++] = 
	`km­_loÿl_·ge
(
£ùÜ
->
·ge
è+ seùÜ->
pgoff
;

1205 ià(
has_q¡re
) {

1210 
£ùÜ
 = 
	`rbio_q¡re_£ùÜ
(
rbio
, 
£ùÜÄ
);

1211 
£ùÜ
->
u±od©e
 = 1;

1212 
poš‹rs
[
¡re
++] = 
	`km­_loÿl_·ge
(
£ùÜ
->
·ge
) +

1213 
£ùÜ
->
pgoff
;

1215 
¿id6_ÿÎ
.
	`g’_syndrome
(
rbio
->
»®_¡res
, 
£ùÜsize
,

1216 
poš‹rs
);

1219 
	`memıy
(
poš‹rs
[
rbio
->
Ä_d©a
],…oš‹rs[0], 
£ùÜsize
);

1220 
	`run_xÜ
(
poš‹rs
 + 1, 
rbio
->
Ä_d©a
 - 1, 
£ùÜsize
);

1222 
¡re
 = stripe - 1; stripe >= 0; stripe--)

1223 
	`kunm­_loÿl
(
poš‹rs
[
¡re
]);

1224 
	}
}

1226 
	$rmw_as£mbË_wr™e_bios
(
bŒfs_¿id_bio
 *
rbio
,

1227 
bio_li¡
 *bio_list)

1230 
tÙ®_£ùÜ_Ä
;

1231 
£ùÜÄ
;

1232 
¡re
;

1233 
»t
;

1235 
	`ASSERT
(
	`bio_li¡_size
(
bio_li¡
) == 0);

1238 
	`ASSERT
(
	`b™m­_weight
(&
rbio
->
db™m­
,„bio->
¡re_n£ùÜs
));

1244 
	`b™m­_ş—r
(
rbio
->
”rÜ_b™m­
, 0,„bio->
Ä_£ùÜs
);

1250 
tÙ®_£ùÜ_Ä
 = 0;Ù®_£ùÜ_Ä < 
rbio
->
Ä_£ùÜs
;

1251 
tÙ®_£ùÜ_Ä
++) {

1252 
£ùÜ_±r
 *
£ùÜ
;

1254 
¡re
 = 
tÙ®_£ùÜ_Ä
 / 
rbio
->
¡re_n£ùÜs
;

1255 
£ùÜÄ
 = 
tÙ®_£ùÜ_Ä
 % 
rbio
->
¡re_n£ùÜs
;

1258 ià(!
	`‹¡_b™
(
£ùÜÄ
, &
rbio
->
db™m­
))

1261 ià(
¡re
 < 
rbio
->
Ä_d©a
) {

1262 
£ùÜ
 = 
	`£ùÜ_š_rbio
(
rbio
, 
¡re
, 
£ùÜÄ
, 1);

1263 ià(!
£ùÜ
)

1266 
£ùÜ
 = 
	`rbio_¡re_£ùÜ
(
rbio
, 
¡re
, 
£ùÜÄ
);

1269 
»t
 = 
	`rbio_add_io_£ùÜ
(
rbio
, 
bio_li¡
, 
£ùÜ
, 
¡re
,

1270 
£ùÜÄ
, 
REQ_OP_WRITE
);

1271 ià(
»t
)

1272 
”rÜ
;

1275 ià(
	`lik–y
(!
rbio
->
bioc
->
»¶aû_Ä_¡res
))

1283 
	`ASSERT
(
rbio
->
bioc
->
»¶aû_¡re_¤c
 >= 0);

1285 
tÙ®_£ùÜ_Ä
 = 0;Ù®_£ùÜ_Ä < 
rbio
->
Ä_£ùÜs
;

1286 
tÙ®_£ùÜ_Ä
++) {

1287 
£ùÜ_±r
 *
£ùÜ
;

1289 
¡re
 = 
tÙ®_£ùÜ_Ä
 / 
rbio
->
¡re_n£ùÜs
;

1290 
£ùÜÄ
 = 
tÙ®_£ùÜ_Ä
 % 
rbio
->
¡re_n£ùÜs
;

1297 ià(
¡re
 !ğ
rbio
->
bioc
->
»¶aû_¡re_¤c
) {

1302 
	`ASSERT
(
£ùÜÄ
 == 0);

1303 
tÙ®_£ùÜ_Ä
 +ğ
rbio
->
¡re_n£ùÜs
 - 1;

1308 ià(!
	`‹¡_b™
(
£ùÜÄ
, &
rbio
->
db™m­
))

1311 ià(
¡re
 < 
rbio
->
Ä_d©a
) {

1312 
£ùÜ
 = 
	`£ùÜ_š_rbio
(
rbio
, 
¡re
, 
£ùÜÄ
, 1);

1313 ià(!
£ùÜ
)

1316 
£ùÜ
 = 
	`rbio_¡re_£ùÜ
(
rbio
, 
¡re
, 
£ùÜÄ
);

1319 
»t
 = 
	`rbio_add_io_£ùÜ
(
rbio
, 
bio_li¡
, 
£ùÜ
,

1320 
rbio
->
»®_¡res
,

1321 
£ùÜÄ
, 
REQ_OP_WRITE
);

1322 ià(
»t
)

1323 
”rÜ
;

1327 
”rÜ
:

1328 
	`bio_li¡_put
(
bio_li¡
);

1329  -
EIO
;

1330 
	}
}

1332 
	$£t_rbio_¿nge_”rÜ
(
bŒfs_¿id_bio
 *
rbio
, 
bio
 *bio)

1334 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rbio
->
bioc
->fs_info;

1335 
u32
 
off£t
 = (
bio
->
bi_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
) -

1336 
rbio
->
bioc
->
fuÎ_¡re_logiÿl
;

1337 
tÙ®_Ä_£ùÜ
 = 
off£t
 >> 
fs_šfo
->
£ùÜsize_b™s
;

1339 
	`ASSERT
(
tÙ®_Ä_£ùÜ
 < 
rbio
->
Ä_d©a
 *„bio->
¡re_n£ùÜs
);

1341 
	`b™m­_£t
(
rbio
->
”rÜ_b™m­
, 
tÙ®_Ä_£ùÜ
,

1342 
bio
->
bi_™”
.
bi_size
 >> 
fs_šfo
->
£ùÜsize_b™s
);

1350 ià(
bio
->
bi_™”
.
bi_size
 == 0) {

1351 
boŞ
 
found_missšg
 = 
çl£
;

1352 
¡re_Ä
;

1354 
¡re_Ä
 = 0; sŒe_Ä < 
rbio
->
»®_¡res
; stripe_nr++) {

1355 ià(!
rbio
->
bioc
->
¡res
[
¡re_Ä
].
dev
->
bdev
) {

1356 
found_missšg
 = 
Œue
;

1357 
	`b™m­_£t
(
rbio
->
”rÜ_b™m­
,

1358 
¡re_Ä
 * 
rbio
->
¡re_n£ùÜs
,

1359 
rbio
->
¡re_n£ùÜs
);

1362 
	`ASSERT
(
found_missšg
);

1364 
	}
}

1370 
£ùÜ_±r
 *
	$fšd_¡re_£ùÜ
(
bŒfs_¿id_bio
 *
rbio
,

1371 
·ge
 *page,

1372 
pgoff
)

1374 
i
;

1376 
i
 = 0; i < 
rbio
->
Ä_£ùÜs
; i++) {

1377 
£ùÜ_±r
 *
£ùÜ
 = &
rbio
->
¡re_£ùÜs
[
i
];

1379 ià(
£ùÜ
->
·ge
 =ğ·g&& seùÜ->
pgoff
 ==…goff)

1380  
£ùÜ
;

1382  
NULL
;

1383 
	}
}

1389 
	$£t_bio_·ges_u±od©e
(
bŒfs_¿id_bio
 *
rbio
, 
bio
 *bio)

1391 cÚ¡ 
u32
 
£ùÜsize
 = 
rbio
->
bioc
->
fs_šfo
->sectorsize;

1392 
bio_vec
 *
bvec
;

1393 
bvec_™”_®l
 
™”_®l
;

1395 
	`ASSERT
(!
	`bio_æagged
(
bio
, 
BIO_CLONED
));

1397 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
™”_®l
) {

1398 
£ùÜ_±r
 *
£ùÜ
;

1399 
pgoff
;

1401 
pgoff
 = 
bvec
->
bv_off£t
;…gofà- bvec->bv_off£ˆ< bvec->
bv_Ën
;

1402 
pgoff
 +ğ
£ùÜsize
) {

1403 
£ùÜ
 = 
	`fšd_¡re_£ùÜ
(
rbio
, 
bvec
->
bv_·ge
, 
pgoff
);

1404 
	`ASSERT
(
£ùÜ
);

1405 ià(
£ùÜ
)

1406 
£ùÜ
->
u±od©e
 = 1;

1409 
	}
}

1411 
	$g‘_bio_£ùÜ_Ä
(
bŒfs_¿id_bio
 *
rbio
, 
bio
 *bio)

1413 
bio_vec
 *
bv
 = 
	`bio_fœ¡_bvec_®l
(
bio
);

1414 
i
;

1416 
i
 = 0; i < 
rbio
->
Ä_£ùÜs
; i++) {

1417 
£ùÜ_±r
 *
£ùÜ
;

1419 
£ùÜ
 = &
rbio
->
¡re_£ùÜs
[
i
];

1420 ià(
£ùÜ
->
·ge
 =ğ
bv
->
bv_·ge
 && seùÜ->
pgoff
 =ğbv->
bv_off£t
)

1422 
£ùÜ
 = &
rbio
->
bio_£ùÜs
[
i
];

1423 ià(
£ùÜ
->
·ge
 =ğ
bv
->
bv_·ge
 && seùÜ->
pgoff
 =ğbv->
bv_off£t
)

1426 
	`ASSERT
(
i
 < 
rbio
->
Ä_£ùÜs
);

1427  
i
;

1428 
	}
}

1430 
	$rbio_upd©e_”rÜ_b™m­
(
bŒfs_¿id_bio
 *
rbio
, 
bio
 *bio)

1432 
tÙ®_£ùÜ_Ä
 = 
	`g‘_bio_£ùÜ_Ä
(
rbio
, 
bio
);

1433 
u32
 
bio_size
 = 0;

1434 
bio_vec
 *
bvec
;

1435 
i
;

1437 
	`bio_fÜ_—ch_bvec_®l
(
bvec
, 
bio
, 
i
)

1438 
bio_size
 +ğ
bvec
->
bv_Ën
;

1446 
i
 = 
tÙ®_£ùÜ_Ä
; i <otal_sector_nr +

1447 (
bio_size
 >> 
rbio
->
bioc
->
fs_šfo
->
£ùÜsize_b™s
); 
i
++)

1448 
	`£t_b™
(
i
, 
rbio
->
”rÜ_b™m­
);

1449 
	}
}

1452 
	$v”ify_bio_d©a_£ùÜs
(
bŒfs_¿id_bio
 *
rbio
,

1453 
bio
 *bio)

1455 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rbio
->
bioc
->fs_info;

1456 
tÙ®_£ùÜ_Ä
 = 
	`g‘_bio_£ùÜ_Ä
(
rbio
, 
bio
);

1457 
bio_vec
 *
bvec
;

1458 
bvec_™”_®l
 
™”_®l
;

1461 ià(!
rbio
->
csum_b™m­
 || !rbio->
csum_buf
)

1465 ià(
tÙ®_£ùÜ_Ä
 >ğ
rbio
->
Ä_d©a
 *„bio->
¡re_n£ùÜs
)

1468 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
™”_®l
) {

1469 
bv_off£t
;

1471 
bv_off£t
 = 
bvec
->bv_offset;

1472 
bv_off£t
 < 
bvec
->bv_off£ˆ+ bvec->
bv_Ën
;

1473 
bv_off£t
 +ğ
fs_šfo
->
£ùÜsize
, 
tÙ®_£ùÜ_Ä
++) {

1474 
u8
 
csum_buf
[
BTRFS_CSUM_SIZE
];

1475 
u8
 *
ex³ùed_csum
 = 
rbio
->
csum_buf
 +

1476 
tÙ®_£ùÜ_Ä
 * 
fs_šfo
->
csum_size
;

1477 
»t
;

1480 ià(!
	`‹¡_b™
(
tÙ®_£ùÜ_Ä
, 
rbio
->
csum_b™m­
))

1483 
»t
 = 
	`bŒfs_check_£ùÜ_csum
(
fs_šfo
, 
bvec
->
bv_·ge
,

1484 
bv_off£t
, 
csum_buf
, 
ex³ùed_csum
);

1485 ià(
»t
 < 0)

1486 
	`£t_b™
(
tÙ®_£ùÜ_Ä
, 
rbio
->
”rÜ_b™m­
);

1489 
	}
}

1491 
	$¿id_wa™_»ad_’d_io
(
bio
 *bio)

1493 
bŒfs_¿id_bio
 *
rbio
 = 
bio
->
bi_´iv©e
;

1495 ià(
bio
->
bi_¡©us
) {

1496 
	`rbio_upd©e_”rÜ_b™m­
(
rbio
, 
bio
);

1498 
	`£t_bio_·ges_u±od©e
(
rbio
, 
bio
);

1499 
	`v”ify_bio_d©a_£ùÜs
(
rbio
, 
bio
);

1502 
	`bio_put
(
bio
);

1503 ià(
	`©omic_dec_ªd_‹¡
(&
rbio
->
¡res_³ndšg
))

1504 
	`wake_up
(&
rbio
->
io_wa™
);

1505 
	}
}

1507 
	$subm™_»ad_wa™_bio_li¡
(
bŒfs_¿id_bio
 *
rbio
,

1508 
bio_li¡
 *bio_list)

1510 
bio
 *bio;

1512 
	`©omic_£t
(&
rbio
->
¡res_³ndšg
, 
	`bio_li¡_size
(
bio_li¡
));

1513 (
bio
 = 
	`bio_li¡_pİ
(
bio_li¡
))) {

1514 
bio
->
bi_’d_io
 = 
¿id_wa™_»ad_’d_io
;

1516 ià(
	`Œaû_¿id56_»ad_’abËd
()) {

1517 
¿id56_bio_Œaû_šfo
 
Œaû_šfo
 = { 0 };

1519 
	`bio_g‘_Œaû_šfo
(
rbio
, 
bio
, &
Œaû_šfo
);

1520 
	`Œaû_¿id56_»ad
(
rbio
, 
bio
, &
Œaû_šfo
);

1522 
	`subm™_bio
(
bio
);

1525 
	`wa™_ev’t
(
rbio
->
io_wa™
, 
	`©omic_»ad
(&rbio->
¡res_³ndšg
) == 0);

1526 
	}
}

1528 
	$®loc_rbio_d©a_·ges
(
bŒfs_¿id_bio
 *
rbio
)

1530 cÚ¡ 
d©a_·ges
 = 
rbio
->
Ä_d©a
 *„bio->
¡re_Åages
;

1531 
»t
;

1533 
»t
 = 
	`bŒfs_®loc_·ge_¬¿y
(
d©a_·ges
, 
rbio
->
¡re_·ges
);

1534 ià(
»t
 < 0)

1535  
»t
;

1537 
	`šdex_¡re_£ùÜs
(
rbio
);

1539 
	}
}

1548 
	sbŒfs_¶ug_cb
 {

1549 
blk_¶ug_cb
 
	mcb
;

1550 
bŒfs_fs_šfo
 *
	mšfo
;

1551 
li¡_h—d
 
	mrbio_li¡
;

1552 
wÜk_¡ruù
 
	mwÜk
;

1558 
	$¶ug_cmp
(*
´iv
, cÚ¡ 
li¡_h—d
 *
a
,

1559 cÚ¡ 
li¡_h—d
 *
b
)

1561 cÚ¡ 
bŒfs_¿id_bio
 *
¿
 = 
	`cÚš”_of
(
a
, btrfs_raid_bio,

1562 
¶ug_li¡
);

1563 cÚ¡ 
bŒfs_¿id_bio
 *
rb
 = 
	`cÚš”_of
(
b
, btrfs_raid_bio,

1564 
¶ug_li¡
);

1565 
u64
 
a_£ùÜ
 = 
¿
->
bio_li¡
.
h—d
->
bi_™”
.
bi_£ùÜ
;

1566 
u64
 
b_£ùÜ
 = 
rb
->
bio_li¡
.
h—d
->
bi_™”
.
bi_£ùÜ
;

1568 ià(
a_£ùÜ
 < 
b_£ùÜ
)

1570 ià(
a_£ùÜ
 > 
b_£ùÜ
)

1573 
	}
}

1575 
	$¿id_uÅlug
(
blk_¶ug_cb
 *
cb
, 
boŞ
 
äom_scheduË
)

1577 
bŒfs_¶ug_cb
 *
¶ug
 = 
	`cÚš”_of
(
cb
, btrfs_plug_cb, cb);

1578 
bŒfs_¿id_bio
 *
cur
;

1579 
bŒfs_¿id_bio
 *
Ï¡
 = 
NULL
;

1581 
	`li¡_sÜt
(
NULL
, &
¶ug
->
rbio_li¡
, 
¶ug_cmp
);

1583 !
	`li¡_em±y
(&
¶ug
->
rbio_li¡
)) {

1584 
cur
 = 
	`li¡_’Œy
(
¶ug
->
rbio_li¡
.
Ãxt
,

1585 
bŒfs_¿id_bio
, 
¶ug_li¡
);

1586 
	`li¡_d–_š™
(&
cur
->
¶ug_li¡
);

1588 ià(
	`rbio_is_fuÎ
(
cur
)) {

1590 
	`¡¬t_async_wÜk
(
cur
, 
rmw_rbio_wÜk
);

1593 ià(
Ï¡
) {

1594 ià(
	`rbio_ÿn_m”ge
(
Ï¡
, 
cur
)) {

1595 
	`m”ge_rbio
(
Ï¡
, 
cur
);

1596 
	`ä“_¿id_bio
(
cur
);

1599 
	`¡¬t_async_wÜk
(
Ï¡
, 
rmw_rbio_wÜk
);

1601 
Ï¡
 = 
cur
;

1603 ià(
Ï¡
)

1604 
	`¡¬t_async_wÜk
(
Ï¡
, 
rmw_rbio_wÜk
);

1605 
	`kä“
(
¶ug
);

1606 
	}
}

1609 
	$rbio_add_bio
(
bŒfs_¿id_bio
 *
rbio
, 
bio
 *
Üig_bio
)

1611 cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rbio
->
bioc
->fs_info;

1612 cÚ¡ 
u64
 
Üig_logiÿl
 = 
Üig_bio
->
bi_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
;

1613 cÚ¡ 
u64
 
fuÎ_¡re_¡¬t
 = 
rbio
->
bioc
->
fuÎ_¡re_logiÿl
;

1614 cÚ¡ 
u32
 
Üig_Ën
 = 
Üig_bio
->
bi_™”
.
bi_size
;

1615 cÚ¡ 
u32
 
£ùÜsize
 = 
fs_šfo
->sectorsize;

1616 
u64
 
cur_logiÿl
;

1618 
	`ASSERT
(
Üig_logiÿl
 >ğ
fuÎ_¡re_¡¬t
 &&

1619 
Üig_logiÿl
 + 
Üig_Ën
 <ğ
fuÎ_¡re_¡¬t
 +

1620 
rbio
->
Ä_d©a
 * 
BTRFS_STRIPE_LEN
);

1622 
	`bio_li¡_add
(&
rbio
->
bio_li¡
, 
Üig_bio
);

1623 
rbio
->
bio_li¡_by‹s
 +ğ
Üig_bio
->
bi_™”
.
bi_size
;

1626 
cur_logiÿl
 = 
Üig_logiÿl
; cur_logiÿÈ< orig_logiÿÈ+ 
Üig_Ën
;

1627 
cur_logiÿl
 +ğ
£ùÜsize
) {

1628 
b™
 = ((
u32
)(
cur_logiÿl
 - 
fuÎ_¡re_¡¬t
) >>

1629 
fs_šfo
->
£ùÜsize_b™s
è% 
rbio
->
¡re_n£ùÜs
;

1631 
	`£t_b™
(
b™
, &
rbio
->
db™m­
);

1633 
	}
}

1638 
	$¿id56_·r™y_wr™e
(
bio
 *bio, 
bŒfs_io_cÚ‹xt
 *
bioc
)

1640 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bioc
->fs_info;

1641 
bŒfs_¿id_bio
 *
rbio
;

1642 
bŒfs_¶ug_cb
 *
¶ug
 = 
NULL
;

1643 
blk_¶ug_cb
 *
cb
;

1645 
rbio
 = 
	`®loc_rbio
(
fs_šfo
, 
bioc
);

1646 ià(
	`IS_ERR
(
rbio
)) {

1647 
bio
->
bi_¡©us
 = 
	`”ºo_to_blk_¡©us
(
	`PTR_ERR
(
rbio
));

1648 
	`bio_’dio
(
bio
);

1651 
rbio
->
İ”©iÚ
 = 
BTRFS_RBIO_WRITE
;

1652 
	`rbio_add_bio
(
rbio
, 
bio
);

1658 ià(!
	`rbio_is_fuÎ
(
rbio
)) {

1659 
cb
 = 
	`blk_check_¶ugged
(
¿id_uÅlug
, 
fs_šfo
, (*
¶ug
));

1660 ià(
cb
) {

1661 
¶ug
 = 
	`cÚš”_of
(
cb
, 
bŒfs_¶ug_cb
, cb);

1662 ià(!
¶ug
->
šfo
) {

1663 
¶ug
->
šfo
 = 
fs_šfo
;

1664 
	`INIT_LIST_HEAD
(&
¶ug
->
rbio_li¡
);

1666 
	`li¡_add_
(&
rbio
->
¶ug_li¡
, &
¶ug
->
rbio_li¡
);

1675 
	`¡¬t_async_wÜk
(
rbio
, 
rmw_rbio_wÜk
);

1676 
	}
}

1678 
	$v”ify_Úe_£ùÜ
(
bŒfs_¿id_bio
 *
rbio
,

1679 
¡re_Ä
, 
£ùÜ_Ä
)

1681 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rbio
->
bioc
->fs_info;

1682 
£ùÜ_±r
 *
£ùÜ
;

1683 
u8
 
csum_buf
[
BTRFS_CSUM_SIZE
];

1684 
u8
 *
csum_ex³ùed
;

1685 
»t
;

1687 ià(!
rbio
->
csum_b™m­
 || !rbio->
csum_buf
)

1691 ià(
¡re_Ä
 >ğ
rbio
->
Ä_d©a
)

1697 ià(
rbio
->
İ”©iÚ
 =ğ
BTRFS_RBIO_READ_REBUILD
) {

1698 
£ùÜ
 = 
	`£ùÜ_š_rbio
(
rbio
, 
¡re_Ä
, 
£ùÜ_Ä
, 0);

1700 
£ùÜ
 = 
	`rbio_¡re_£ùÜ
(
rbio
, 
¡re_Ä
, 
£ùÜ_Ä
);

1703 
	`ASSERT
(
£ùÜ
->
·ge
);

1705 
csum_ex³ùed
 = 
rbio
->
csum_buf
 +

1706 (
¡re_Ä
 * 
rbio
->
¡re_n£ùÜs
 + 
£ùÜ_Ä
) *

1707 
fs_šfo
->
csum_size
;

1708 
»t
 = 
	`bŒfs_check_£ùÜ_csum
(
fs_šfo
, 
£ùÜ
->
·ge
, seùÜ->
pgoff
,

1709 
csum_buf
, 
csum_ex³ùed
);

1710  
»t
;

1711 
	}
}

1718 
	$»cov”_v”tiÿl
(
bŒfs_¿id_bio
 *
rbio
, 
£ùÜ_Ä
,

1719 **
poš‹rs
, **
unm­_¬¿y
)

1721 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rbio
->
bioc
->fs_info;

1722 
£ùÜ_±r
 *
£ùÜ
;

1723 cÚ¡ 
u32
 
£ùÜsize
 = 
fs_šfo
->sectorsize;

1724 
found_”rÜs
;

1725 
ça
;

1726 
çb
;

1727 
¡re_Ä
;

1728 
»t
 = 0;

1734 ià(
rbio
->
İ”©iÚ
 =ğ
BTRFS_RBIO_PARITY_SCRUB
 &&

1735 !
	`‹¡_b™
(
£ùÜ_Ä
, &
rbio
->
db™m­
))

1738 
found_”rÜs
 = 
	`g‘_rbio_v”™iÿl_”rÜs
(
rbio
, 
£ùÜ_Ä
, &
ça
,

1739 &
çb
);

1744 ià(!
found_”rÜs
)

1747 ià(
found_”rÜs
 > 
rbio
->
bioc
->
max_”rÜs
)

1748  -
EIO
;

1756 
¡re_Ä
 = 0; sŒe_Ä < 
rbio
->
»®_¡res
; stripe_nr++) {

1761 ià(
rbio
->
İ”©iÚ
 =ğ
BTRFS_RBIO_READ_REBUILD
) {

1762 
£ùÜ
 = 
	`£ùÜ_š_rbio
(
rbio
, 
¡re_Ä
, 
£ùÜ_Ä
, 0);

1764 
£ùÜ
 = 
	`rbio_¡re_£ùÜ
(
rbio
, 
¡re_Ä
, 
£ùÜ_Ä
);

1766 
	`ASSERT
(
£ùÜ
->
·ge
);

1767 
poš‹rs
[
¡re_Ä
] = 
	`km­_loÿl_·ge
(
£ùÜ
->
·ge
) +

1768 
£ùÜ
->
pgoff
;

1769 
unm­_¬¿y
[
¡re_Ä
] = 
poš‹rs
[stripe_nr];

1773 ià(
rbio
->
bioc
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_RAID6
) {

1775 ià(
çb
 < 0) {

1776 ià(
ça
 =ğ
rbio
->
Ä_d©a
)

1783 
ş—nup
;

1788 
p¡re
;

1798 ià(
çb
 =ğ
rbio
->
»®_¡res
 - 1) {

1799 ià(
ça
 =ğ
rbio
->
»®_¡res
 - 2)

1805 
ş—nup
;

1810 
p¡re
;

1813 ià(
çb
 =ğ
rbio
->
»®_¡res
 - 2) {

1814 
	`¿id6_d©­_»cov
(
rbio
->
»®_¡res
, 
£ùÜsize
,

1815 
ça
, 
poš‹rs
);

1817 
	`¿id6_2d©a_»cov
(
rbio
->
»®_¡res
, 
£ùÜsize
,

1818 
ça
, 
çb
, 
poš‹rs
);

1821 *
p
;

1824 
	`ASSERT
(
çb
 == -1);

1825 
p¡re
:

1827 
	`memıy
(
poš‹rs
[
ça
],…oš‹rs[
rbio
->
Ä_d©a
], 
£ùÜsize
);

1830 
p
 = 
poš‹rs
[
ça
];

1831 
¡re_Ä
 = 
ça
; sŒe_Ä < 
rbio
->
Ä_d©a
 - 1;

1832 
¡re_Ä
++)

1833 
poš‹rs
[
¡re_Ä
] =…ointers[stripe_nr + 1];

1834 
poš‹rs
[
rbio
->
Ä_d©a
 - 1] = 
p
;

1837 
	`run_xÜ
(
poš‹rs
, 
rbio
->
Ä_d©a
 - 1, 
£ùÜsize
);

1851 ià(
ça
 >= 0) {

1852 
»t
 = 
	`v”ify_Úe_£ùÜ
(
rbio
, 
ça
, 
£ùÜ_Ä
);

1853 ià(
»t
 < 0)

1854 
ş—nup
;

1856 
£ùÜ
 = 
	`rbio_¡re_£ùÜ
(
rbio
, 
ça
, 
£ùÜ_Ä
);

1857 
£ùÜ
->
u±od©e
 = 1;

1859 ià(
çb
 >= 0) {

1860 
»t
 = 
	`v”ify_Úe_£ùÜ
(
rbio
, 
çb
, 
£ùÜ_Ä
);

1861 ià(
»t
 < 0)

1862 
ş—nup
;

1864 
£ùÜ
 = 
	`rbio_¡re_£ùÜ
(
rbio
, 
çb
, 
£ùÜ_Ä
);

1865 
£ùÜ
->
u±od©e
 = 1;

1868 
ş—nup
:

1869 
¡re_Ä
 = 
rbio
->
»®_¡res
 - 1; stripe_nr >= 0; stripe_nr--)

1870 
	`kunm­_loÿl
(
unm­_¬¿y
[
¡re_Ä
]);

1871  
»t
;

1872 
	}
}

1874 
	$»cov”_£ùÜs
(
bŒfs_¿id_bio
 *
rbio
)

1876 **
poš‹rs
 = 
NULL
;

1877 **
unm­_¬¿y
 = 
NULL
;

1878 
£ùÜÄ
;

1879 
»t
 = 0;

1887 
poš‹rs
 = 
	`kÿÎoc
(
rbio
->
»®_¡res
, (*), 
GFP_NOFS
);

1888 
unm­_¬¿y
 = 
	`kÿÎoc
(
rbio
->
»®_¡res
, (*), 
GFP_NOFS
);

1889 ià(!
poš‹rs
 || !
unm­_¬¿y
) {

1890 
»t
 = -
ENOMEM
;

1891 
out
;

1894 ià(
rbio
->
İ”©iÚ
 =ğ
BTRFS_RBIO_READ_REBUILD
) {

1895 
	`¥š_lock
(&
rbio
->
bio_li¡_lock
);

1896 
	`£t_b™
(
RBIO_RMW_LOCKED_BIT
, &
rbio
->
æags
);

1897 
	`¥š_uÆock
(&
rbio
->
bio_li¡_lock
);

1900 
	`šdex_rbio_·ges
(
rbio
);

1902 
£ùÜÄ
 = 0; seùÜÄ < 
rbio
->
¡re_n£ùÜs
; sectornr++) {

1903 
»t
 = 
	`»cov”_v”tiÿl
(
rbio
, 
£ùÜÄ
, 
poš‹rs
, 
unm­_¬¿y
);

1904 ià(
»t
 < 0)

1908 
out
:

1909 
	`kä“
(
poš‹rs
);

1910 
	`kä“
(
unm­_¬¿y
);

1911  
»t
;

1912 
	}
}

1914 
	$»cov”_rbio
(
bŒfs_¿id_bio
 *
rbio
)

1916 
bio_li¡
 bio_li¡ = 
BIO_EMPTY_LIST
;

1917 
tÙ®_£ùÜ_Ä
;

1918 
»t
 = 0;

1924 
	`ASSERT
(
	`b™m­_weight
(
rbio
->
”rÜ_b™m­
,„bio->
Ä_£ùÜs
));

1927 
»t
 = 
	`®loc_rbio_·ges
(
rbio
);

1928 ià(
»t
 < 0)

1929 
out
;

1931 
	`šdex_rbio_·ges
(
rbio
);

1941 
tÙ®_£ùÜ_Ä
 = 0;Ù®_£ùÜ_Ä < 
rbio
->
Ä_£ùÜs
;

1942 
tÙ®_£ùÜ_Ä
++) {

1943 
¡re
 = 
tÙ®_£ùÜ_Ä
 / 
rbio
->
¡re_n£ùÜs
;

1944 
£ùÜÄ
 = 
tÙ®_£ùÜ_Ä
 % 
rbio
->
¡re_n£ùÜs
;

1945 
£ùÜ_±r
 *
£ùÜ
;

1952 ià(!
rbio
->
bioc
->
¡res
[
¡re
].
dev
->
bdev
 ||

1953 
	`‹¡_b™
(
tÙ®_£ùÜ_Ä
, 
rbio
->
”rÜ_b™m­
)) {

1958 
	`£t_b™
(
tÙ®_£ùÜ_Ä
, 
rbio
->
”rÜ_b™m­
);

1962 
£ùÜ
 = 
	`rbio_¡re_£ùÜ
(
rbio
, 
¡re
, 
£ùÜÄ
);

1963 
»t
 = 
	`rbio_add_io_£ùÜ
(
rbio
, &
bio_li¡
, 
£ùÜ
, 
¡re
,

1964 
£ùÜÄ
, 
REQ_OP_READ
);

1965 ià(
»t
 < 0) {

1966 
	`bio_li¡_put
(&
bio_li¡
);

1967 
out
;

1971 
	`subm™_»ad_wa™_bio_li¡
(
rbio
, &
bio_li¡
);

1972 
»t
 = 
	`»cov”_£ùÜs
(
rbio
);

1973 
out
:

1974 
	`rbio_Üig_’d_io
(
rbio
, 
	`”ºo_to_blk_¡©us
(
»t
));

1975 
	}
}

1977 
	$»cov”_rbio_wÜk
(
wÜk_¡ruù
 *
wÜk
)

1979 
bŒfs_¿id_bio
 *
rbio
;

1981 
rbio
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_¿id_bio
, work);

1982 ià(!
	`lock_¡re_add
(
rbio
))

1983 
	`»cov”_rbio
(
rbio
);

1984 
	}
}

1986 
	$»cov”_rbio_wÜk_locked
(
wÜk_¡ruù
 *
wÜk
)

1988 
	`»cov”_rbio
(
	`cÚš”_of
(
wÜk
, 
bŒfs_¿id_bio
, work));

1989 
	}
}

1991 
	$£t_rbio_¿id6_exŒa_”rÜ
(
bŒfs_¿id_bio
 *
rbio
, 
mœrÜ_num
)

1993 
boŞ
 
found
 = 
çl£
;

1994 
£ùÜ_Ä
;

2002 
	`ASSERT
(
mœrÜ_num
 > 2);

2003 
£ùÜ_Ä
 = 0; seùÜ_Ä < 
rbio
->
¡re_n£ùÜs
; sector_nr++) {

2004 
found_”rÜs
;

2005 
ça
;

2006 
çb
;

2008 
found_”rÜs
 = 
	`g‘_rbio_v”™iÿl_”rÜs
(
rbio
, 
£ùÜ_Ä
,

2009 &
ça
, &
çb
);

2011 ià(!
found_”rÜs
)

2018 
	`ASSERT
(
found_”rÜs
 == 1);

2019 
found
 = 
Œue
;

2022 
çb
 = 
rbio
->
»®_¡res
 - (
mœrÜ_num
 - 1);

2023 ià(
çb
 <ğ
ça
)

2024 
çb
--;

2027 ià(
çb
 >= 0)

2028 
	`£t_b™
(
çb
 * 
rbio
->
¡re_n£ùÜs
 + 
£ùÜ_Ä
,

2029 
rbio
->
”rÜ_b™m­
);

2033 
	`ASSERT
(
found
);

2034 
	}
}

2042 
	$¿id56_·r™y_»cov”
(
bio
 *bio, 
bŒfs_io_cÚ‹xt
 *
bioc
,

2043 
mœrÜ_num
)

2045 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bioc
->fs_info;

2046 
bŒfs_¿id_bio
 *
rbio
;

2048 
rbio
 = 
	`®loc_rbio
(
fs_šfo
, 
bioc
);

2049 ià(
	`IS_ERR
(
rbio
)) {

2050 
bio
->
bi_¡©us
 = 
	`”ºo_to_blk_¡©us
(
	`PTR_ERR
(
rbio
));

2051 
	`bio_’dio
(
bio
);

2055 
rbio
->
İ”©iÚ
 = 
BTRFS_RBIO_READ_REBUILD
;

2056 
	`rbio_add_bio
(
rbio
, 
bio
);

2058 
	`£t_rbio_¿nge_”rÜ
(
rbio
, 
bio
);

2065 ià(
mœrÜ_num
 > 2)

2066 
	`£t_rbio_¿id6_exŒa_”rÜ
(
rbio
, 
mœrÜ_num
);

2068 
	`¡¬t_async_wÜk
(
rbio
, 
»cov”_rbio_wÜk
);

2069 
	}
}

2071 
	$fl_d©a_csums
(
bŒfs_¿id_bio
 *
rbio
)

2073 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rbio
->
bioc
->fs_info;

2074 
bŒfs_roÙ
 *
csum_roÙ
 = 
	`bŒfs_csum_roÙ
(
fs_šfo
,

2075 
rbio
->
bioc
->
fuÎ_¡re_logiÿl
);

2076 cÚ¡ 
u64
 
¡¬t
 = 
rbio
->
bioc
->
fuÎ_¡re_logiÿl
;

2077 cÚ¡ 
u32
 
Ën
 = (
rbio
->
Ä_d©a
 *„bio->
¡re_n£ùÜs
) <<

2078 
fs_šfo
->
£ùÜsize_b™s
;

2079 
»t
;

2082 
	`ASSERT
(!
rbio
->
csum_buf
 && !rbio->
csum_b™m­
);

2095 ià(!(
rbio
->
bioc
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_DATA
) ||

2096 
rbio
->
bioc
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_METADATA
)

2099 
rbio
->
csum_buf
 = 
	`kz®loc
Ôbio->
Ä_d©a
 *„bio->
¡re_n£ùÜs
 *

2100 
fs_šfo
->
csum_size
, 
GFP_NOFS
);

2101 
rbio
->
csum_b™m­
 = 
	`b™m­_z®loc
Ôbio->
Ä_d©a
 *„bio->
¡re_n£ùÜs
,

2102 
GFP_NOFS
);

2103 ià(!
rbio
->
csum_buf
 || !rbio->
csum_b™m­
) {

2104 
»t
 = -
ENOMEM
;

2105 
”rÜ
;

2108 
»t
 = 
	`bŒfs_lookup_csums_b™m­
(
csum_roÙ
, 
NULL
, 
¡¬t
, s¹ + 
Ën
 - 1,

2109 
rbio
->
csum_buf
,„bio->
csum_b™m­
);

2110 ià(
»t
 < 0)

2111 
”rÜ
;

2112 ià(
	`b™m­_em±y
(
rbio
->
csum_b™m­
, 
Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
))

2113 
no_csum
;

2116 
”rÜ
:

2122 
	`bŒfs_w¬n_¾
(
fs_šfo
,

2124 
rbio
->
bioc
->
fuÎ_¡re_logiÿl
, 
»t
);

2125 
no_csum
:

2126 
	`kä“
(
rbio
->
csum_buf
);

2127 
	`b™m­_ä“
(
rbio
->
csum_b™m­
);

2128 
rbio
->
csum_buf
 = 
NULL
;

2129 
rbio
->
csum_b™m­
 = 
NULL
;

2130 
	}
}

2132 
	$rmw_»ad_wa™_»cov”
(
bŒfs_¿id_bio
 *
rbio
)

2134 
bio_li¡
 bio_li¡ = 
BIO_EMPTY_LIST
;

2135 
tÙ®_£ùÜ_Ä
;

2136 
»t
 = 0;

2143 
	`fl_d©a_csums
(
rbio
);

2150 
tÙ®_£ùÜ_Ä
 = 0;Ù®_£ùÜ_Ä < 
rbio
->
Ä_£ùÜs
;

2151 
tÙ®_£ùÜ_Ä
++) {

2152 
£ùÜ_±r
 *
£ùÜ
;

2153 
¡re
 = 
tÙ®_£ùÜ_Ä
 / 
rbio
->
¡re_n£ùÜs
;

2154 
£ùÜÄ
 = 
tÙ®_£ùÜ_Ä
 % 
rbio
->
¡re_n£ùÜs
;

2156 
£ùÜ
 = 
	`rbio_¡re_£ùÜ
(
rbio
, 
¡re
, 
£ùÜÄ
);

2157 
»t
 = 
	`rbio_add_io_£ùÜ
(
rbio
, &
bio_li¡
, 
£ùÜ
,

2158 
¡re
, 
£ùÜÄ
, 
REQ_OP_READ
);

2159 ià(
»t
) {

2160 
	`bio_li¡_put
(&
bio_li¡
);

2161  
»t
;

2169 
	`subm™_»ad_wa™_bio_li¡
(
rbio
, &
bio_li¡
);

2170  
	`»cov”_£ùÜs
(
rbio
);

2171 
	}
}

2173 
	$¿id_wa™_wr™e_’d_io
(
bio
 *bio)

2175 
bŒfs_¿id_bio
 *
rbio
 = 
bio
->
bi_´iv©e
;

2176 
blk_¡©us_t
 
”r
 = 
bio
->
bi_¡©us
;

2178 ià(
”r
)

2179 
	`rbio_upd©e_”rÜ_b™m­
(
rbio
, 
bio
);

2180 
	`bio_put
(
bio
);

2181 ià(
	`©omic_dec_ªd_‹¡
(&
rbio
->
¡res_³ndšg
))

2182 
	`wake_up
(&
rbio
->
io_wa™
);

2183 
	}
}

2185 
	$subm™_wr™e_bios
(
bŒfs_¿id_bio
 *
rbio
,

2186 
bio_li¡
 *bio_list)

2188 
bio
 *bio;

2190 
	`©omic_£t
(&
rbio
->
¡res_³ndšg
, 
	`bio_li¡_size
(
bio_li¡
));

2191 (
bio
 = 
	`bio_li¡_pİ
(
bio_li¡
))) {

2192 
bio
->
bi_’d_io
 = 
¿id_wa™_wr™e_’d_io
;

2194 ià(
	`Œaû_¿id56_wr™e_’abËd
()) {

2195 
¿id56_bio_Œaû_šfo
 
Œaû_šfo
 = { 0 };

2197 
	`bio_g‘_Œaû_šfo
(
rbio
, 
bio
, &
Œaû_šfo
);

2198 
	`Œaû_¿id56_wr™e
(
rbio
, 
bio
, &
Œaû_šfo
);

2200 
	`subm™_bio
(
bio
);

2202 
	}
}

2208 
boŞ
 
	$Ãed_»ad_¡re_£ùÜs
(
bŒfs_¿id_bio
 *
rbio
)

2210 
i
;

2212 
i
 = 0; i < 
rbio
->
Ä_d©a
 *„bio->
¡re_n£ùÜs
; i++) {

2213 
£ùÜ_±r
 *
£ùÜ
 = &
rbio
->
¡re_£ùÜs
[
i
];

2220 ià(!
£ùÜ
->
·ge
 || !£ùÜ->
u±od©e
)

2221  
Œue
;

2223  
çl£
;

2224 
	}
}

2226 
	$rmw_rbio
(
bŒfs_¿id_bio
 *
rbio
)

2228 
bio_li¡
 bio_list;

2229 
£ùÜÄ
;

2230 
»t
 = 0;

2236 
»t
 = 
	`®loc_rbio_·r™y_·ges
(
rbio
);

2237 ià(
»t
 < 0)

2238 
out
;

2244 ià(!
	`rbio_is_fuÎ
(
rbio
è&& 
	`Ãed_»ad_¡re_£ùÜs
(rbio)) {

2249 
»t
 = 
	`®loc_rbio_d©a_·ges
(
rbio
);

2250 ià(
»t
 < 0)

2251 
out
;

2253 
	`šdex_rbio_·ges
(
rbio
);

2255 
»t
 = 
	`rmw_»ad_wa™_»cov”
(
rbio
);

2256 ià(
»t
 < 0)

2257 
out
;

2265 
	`¥š_lock
(&
rbio
->
bio_li¡_lock
);

2266 
	`£t_b™
(
RBIO_RMW_LOCKED_BIT
, &
rbio
->
æags
);

2267 
	`¥š_uÆock
(&
rbio
->
bio_li¡_lock
);

2269 
	`b™m­_ş—r
(
rbio
->
”rÜ_b™m­
, 0,„bio->
Ä_£ùÜs
);

2271 
	`šdex_rbio_·ges
(
rbio
);

2279 ià(!
	`rbio_is_fuÎ
(
rbio
))

2280 
	`ÿche_rbio_·ges
(
rbio
);

2282 
	`ş—r_b™
(
RBIO_CACHE_READY_BIT
, &
rbio
->
æags
);

2284 
£ùÜÄ
 = 0; seùÜÄ < 
rbio
->
¡re_n£ùÜs
; sectornr++)

2285 
	`g’”©e_pq_v”tiÿl
(
rbio
, 
£ùÜÄ
);

2287 
	`bio_li¡_š™
(&
bio_li¡
);

2288 
»t
 = 
	`rmw_as£mbË_wr™e_bios
(
rbio
, &
bio_li¡
);

2289 ià(
»t
 < 0)

2290 
out
;

2293 
	`ASSERT
(
	`bio_li¡_size
(&
bio_li¡
));

2294 
	`subm™_wr™e_bios
(
rbio
, &
bio_li¡
);

2295 
	`wa™_ev’t
(
rbio
->
io_wa™
, 
	`©omic_»ad
(&rbio->
¡res_³ndšg
) == 0);

2298 
£ùÜÄ
 = 0; seùÜÄ < 
rbio
->
¡re_n£ùÜs
; sectornr++) {

2299 
found_”rÜs
;

2301 
found_”rÜs
 = 
	`g‘_rbio_v”™iÿl_”rÜs
(
rbio
, 
£ùÜÄ
, 
NULL
, NULL);

2302 ià(
found_”rÜs
 > 
rbio
->
bioc
->
max_”rÜs
) {

2303 
»t
 = -
EIO
;

2307 
out
:

2308 
	`rbio_Üig_’d_io
(
rbio
, 
	`”ºo_to_blk_¡©us
(
»t
));

2309 
	}
}

2311 
	$rmw_rbio_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2313 
bŒfs_¿id_bio
 *
rbio
;

2315 
rbio
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_¿id_bio
, work);

2316 ià(
	`lock_¡re_add
(
rbio
) == 0)

2317 
	`rmw_rbio
(
rbio
);

2318 
	}
}

2320 
	$rmw_rbio_wÜk_locked
(
wÜk_¡ruù
 *
wÜk
)

2322 
	`rmw_rbio
(
	`cÚš”_of
(
wÜk
, 
bŒfs_¿id_bio
, work));

2323 
	}
}

2335 
bŒfs_¿id_bio
 *
	$¿id56_·r™y_®loc_süub_rbio
(
bio
 *bio,

2336 
bŒfs_io_cÚ‹xt
 *
bioc
,

2337 
bŒfs_deviû
 *
süub_dev
,

2338 *
db™m­
, 
¡re_n£ùÜs
)

2340 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bioc
->fs_info;

2341 
bŒfs_¿id_bio
 *
rbio
;

2342 
i
;

2344 
rbio
 = 
	`®loc_rbio
(
fs_šfo
, 
bioc
);

2345 ià(
	`IS_ERR
(
rbio
))

2346  
NULL
;

2347 
	`bio_li¡_add
(&
rbio
->
bio_li¡
, 
bio
);

2352 
	`ASSERT
(!
bio
->
bi_™”
.
bi_size
);

2353 
rbio
->
İ”©iÚ
 = 
BTRFS_RBIO_PARITY_SCRUB
;

2360 
i
 = 
rbio
->
Ä_d©a
; i <„bio->
»®_¡res
; i++) {

2361 ià(
bioc
->
¡res
[
i
].
dev
 =ğ
süub_dev
) {

2362 
rbio
->
süubp
 = 
i
;

2366 
	`ASSERT
(
i
 < 
rbio
->
»®_¡res
);

2368 
	`b™m­_cİy
(&
rbio
->
db™m­
, db™m­, 
¡re_n£ùÜs
);

2369  
rbio
;

2370 
	}
}

2376 
	$®loc_rbio_es£ÁŸl_·ges
(
bŒfs_¿id_bio
 *
rbio
)

2378 cÚ¡ 
u32
 
£ùÜsize
 = 
rbio
->
bioc
->
fs_šfo
->sectorsize;

2379 
tÙ®_£ùÜ_Ä
;

2381 
tÙ®_£ùÜ_Ä
 = 0;Ù®_£ùÜ_Ä < 
rbio
->
Ä_£ùÜs
;

2382 
tÙ®_£ùÜ_Ä
++) {

2383 
·ge
 *page;

2384 
£ùÜÄ
 = 
tÙ®_£ùÜ_Ä
 % 
rbio
->
¡re_n£ùÜs
;

2385 
šdex
 = (
tÙ®_£ùÜ_Ä
 * 
£ùÜsize
è>> 
PAGE_SHIFT
;

2387 ià(!
	`‹¡_b™
(
£ùÜÄ
, &
rbio
->
db™m­
))

2389 ià(
rbio
->
¡re_·ges
[
šdex
])

2391 
·ge
 = 
	`®loc_·ge
(
GFP_NOFS
);

2392 ià(!
·ge
)

2393  -
ENOMEM
;

2394 
rbio
->
¡re_·ges
[
šdex
] = 
·ge
;

2396 
	`šdex_¡re_£ùÜs
(
rbio
);

2398 
	}
}

2400 
	$fšish_·r™y_süub
(
bŒfs_¿id_bio
 *
rbio
)

2402 
bŒfs_io_cÚ‹xt
 *
bioc
 = 
rbio
->bioc;

2403 cÚ¡ 
u32
 
£ùÜsize
 = 
bioc
->
fs_šfo
->sectorsize;

2404 **
poš‹rs
 = 
rbio
->
fšish_poš‹rs
;

2405 *
pb™m­
 = &
rbio
->
fšish_pb™m­
;

2406 
Ä_d©a
 = 
rbio
->nr_data;

2407 
¡re
;

2408 
£ùÜÄ
;

2409 
boŞ
 
has_q¡re
;

2410 
£ùÜ_±r
 
p_£ùÜ
 = { 0 };

2411 
£ùÜ_±r
 
q_£ùÜ
 = { 0 };

2412 
bio_li¡
 bio_list;

2413 
is_»¶aû
 = 0;

2414 
»t
;

2416 
	`bio_li¡_š™
(&
bio_li¡
);

2418 ià(
rbio
->
»®_¡res
 -„bio->
Ä_d©a
 == 1)

2419 
has_q¡re
 = 
çl£
;

2420 ià(
rbio
->
»®_¡res
 -„bio->
Ä_d©a
 == 2)

2421 
has_q¡re
 = 
Œue
;

2423 
	`BUG
();

2429 ià(
bioc
->
»¶aû_Ä_¡res
 && bioc->
»¶aû_¡re_¤c
 =ğ
rbio
->
süubp
) {

2430 
is_»¶aû
 = 1;

2431 
	`b™m­_cİy
(
pb™m­
, &
rbio
->
db™m­
,„bio->
¡re_n£ùÜs
);

2439 
	`ş—r_b™
(
RBIO_CACHE_READY_BIT
, &
rbio
->
æags
);

2441 
p_£ùÜ
.
·ge
 = 
	`®loc_·ge
(
GFP_NOFS
);

2442 ià(!
p_£ùÜ
.
·ge
)

2443  -
ENOMEM
;

2444 
p_£ùÜ
.
pgoff
 = 0;

2445 
p_£ùÜ
.
u±od©e
 = 1;

2447 ià(
has_q¡re
) {

2449 
q_£ùÜ
.
·ge
 = 
	`®loc_·ge
(
GFP_NOFS
);

2450 ià(!
q_£ùÜ
.
·ge
) {

2451 
	`__ä“_·ge
(
p_£ùÜ
.
·ge
);

2452 
p_£ùÜ
.
·ge
 = 
NULL
;

2453  -
ENOMEM
;

2455 
q_£ùÜ
.
pgoff
 = 0;

2456 
q_£ùÜ
.
u±od©e
 = 1;

2457 
poš‹rs
[
rbio
->
»®_¡res
 - 1] = 
	`km­_loÿl_·ge
(
q_£ùÜ
.
·ge
);

2460 
	`b™m­_ş—r
(
rbio
->
”rÜ_b™m­
, 0,„bio->
Ä_£ùÜs
);

2463 
poš‹rs
[
Ä_d©a
] = 
	`km­_loÿl_·ge
(
p_£ùÜ
.
·ge
);

2465 
	`fÜ_—ch_£t_b™
(
£ùÜÄ
, &
rbio
->
db™m­
,„bio->
¡re_n£ùÜs
) {

2466 
£ùÜ_±r
 *
£ùÜ
;

2467 *
·r™y
;

2470 
¡re
 = 0; sŒ< 
Ä_d©a
; stripe++) {

2471 
£ùÜ
 = 
	`£ùÜ_š_rbio
(
rbio
, 
¡re
, 
£ùÜÄ
, 0);

2472 
poš‹rs
[
¡re
] = 
	`km­_loÿl_·ge
(
£ùÜ
->
·ge
) +

2473 
£ùÜ
->
pgoff
;

2476 ià(
has_q¡re
) {

2478 
¿id6_ÿÎ
.
	`g’_syndrome
(
rbio
->
»®_¡res
, 
£ùÜsize
,

2479 
poš‹rs
);

2482 
	`memıy
(
poš‹rs
[
Ä_d©a
],…oš‹rs[0], 
£ùÜsize
);

2483 
	`run_xÜ
(
poš‹rs
 + 1, 
Ä_d©a
 - 1, 
£ùÜsize
);

2487 
£ùÜ
 = 
	`rbio_¡re_£ùÜ
(
rbio
,„bio->
süubp
, 
£ùÜÄ
);

2488 
·r™y
 = 
	`km­_loÿl_·ge
(
£ùÜ
->
·ge
è+ seùÜ->
pgoff
;

2489 ià(
	`memcmp
(
·r™y
, 
poš‹rs
[
rbio
->
süubp
], 
£ùÜsize
) != 0)

2490 
	`memıy
(
·r™y
, 
poš‹rs
[
rbio
->
süubp
], 
£ùÜsize
);

2493 
	`b™m­_ş—r
(&
rbio
->
db™m­
, 
£ùÜÄ
, 1);

2494 
	`kunm­_loÿl
(
·r™y
);

2496 
¡re
 = 
Ä_d©a
 - 1; stripe >= 0; stripe--)

2497 
	`kunm­_loÿl
(
poš‹rs
[
¡re
]);

2500 
	`kunm­_loÿl
(
poš‹rs
[
Ä_d©a
]);

2501 
	`__ä“_·ge
(
p_£ùÜ
.
·ge
);

2502 
p_£ùÜ
.
·ge
 = 
NULL
;

2503 ià(
q_£ùÜ
.
·ge
) {

2504 
	`kunm­_loÿl
(
poš‹rs
[
rbio
->
»®_¡res
 - 1]);

2505 
	`__ä“_·ge
(
q_£ùÜ
.
·ge
);

2506 
q_£ùÜ
.
·ge
 = 
NULL
;

2514 
	`fÜ_—ch_£t_b™
(
£ùÜÄ
, &
rbio
->
db™m­
,„bio->
¡re_n£ùÜs
) {

2515 
£ùÜ_±r
 *
£ùÜ
;

2517 
£ùÜ
 = 
	`rbio_¡re_£ùÜ
(
rbio
,„bio->
süubp
, 
£ùÜÄ
);

2518 
»t
 = 
	`rbio_add_io_£ùÜ
(
rbio
, &
bio_li¡
, 
£ùÜ
,„bio->
süubp
,

2519 
£ùÜÄ
, 
REQ_OP_WRITE
);

2520 ià(
»t
)

2521 
ş—nup
;

2524 ià(!
is_»¶aû
)

2525 
subm™_wr™e
;

2531 
	`ASSERT
(
rbio
->
bioc
->
»¶aû_¡re_¤c
 >= 0);

2532 
	`fÜ_—ch_£t_b™
(
£ùÜÄ
, 
pb™m­
, 
rbio
->
¡re_n£ùÜs
) {

2533 
£ùÜ_±r
 *
£ùÜ
;

2535 
£ùÜ
 = 
	`rbio_¡re_£ùÜ
(
rbio
,„bio->
süubp
, 
£ùÜÄ
);

2536 
»t
 = 
	`rbio_add_io_£ùÜ
(
rbio
, &
bio_li¡
, 
£ùÜ
,

2537 
rbio
->
»®_¡res
,

2538 
£ùÜÄ
, 
REQ_OP_WRITE
);

2539 ià(
»t
)

2540 
ş—nup
;

2543 
subm™_wr™e
:

2544 
	`subm™_wr™e_bios
(
rbio
, &
bio_li¡
);

2547 
ş—nup
:

2548 
	`bio_li¡_put
(&
bio_li¡
);

2549  
»t
;

2550 
	}
}

2552 
šlše
 
	$is_d©a_¡re
(
bŒfs_¿id_bio
 *
rbio
, 
¡re
)

2554 ià(
¡re
 >ğ0 && sŒ< 
rbio
->
Ä_d©a
)

2557 
	}
}

2559 
	$»cov”_süub_rbio
(
bŒfs_¿id_bio
 *
rbio
)

2561 **
poš‹rs
 = 
NULL
;

2562 **
unm­_¬¿y
 = 
NULL
;

2563 
£ùÜ_Ä
;

2564 
»t
 = 0;

2572 
poš‹rs
 = 
	`kÿÎoc
(
rbio
->
»®_¡res
, (*), 
GFP_NOFS
);

2573 
unm­_¬¿y
 = 
	`kÿÎoc
(
rbio
->
»®_¡res
, (*), 
GFP_NOFS
);

2574 ià(!
poš‹rs
 || !
unm­_¬¿y
) {

2575 
»t
 = -
ENOMEM
;

2576 
out
;

2579 
£ùÜ_Ä
 = 0; seùÜ_Ä < 
rbio
->
¡re_n£ùÜs
; sector_nr++) {

2580 
dç
 = 0, 
çp
 = -1;

2581 
ça
;

2582 
çb
;

2583 
found_”rÜs
;

2585 
found_”rÜs
 = 
	`g‘_rbio_v”™iÿl_”rÜs
(
rbio
, 
£ùÜ_Ä
,

2586 &
ça
, &
çb
);

2587 ià(
found_”rÜs
 > 
rbio
->
bioc
->
max_”rÜs
) {

2588 
»t
 = -
EIO
;

2589 
out
;

2591 ià(
found_”rÜs
 == 0)

2595 
	`ASSERT
(
ça
 >ğ0 || 
çb
 >= 0);

2597 ià(
	`is_d©a_¡re
(
rbio
, 
ça
))

2598 
dç
++;

2599 ià(
	`is_·r™y_¡re
(
ça
))

2600 
çp
 = 
ça
;

2602 ià(
	`is_d©a_¡re
(
rbio
, 
çb
))

2603 
dç
++;

2604 ià(
	`is_·r™y_¡re
(
çb
))

2605 
çp
 = 
çb
;

2611 ià(
dç
 > 
rbio
->
bioc
->
max_”rÜs
 - 1) {

2612 
»t
 = -
EIO
;

2613 
out
;

2619 ià(
dç
 == 0)

2628 ià(
çp
 !ğ
rbio
->
süubp
) {

2629 
»t
 = -
EIO
;

2630 
out
;

2633 
»t
 = 
	`»cov”_v”tiÿl
(
rbio
, 
£ùÜ_Ä
, 
poš‹rs
, 
unm­_¬¿y
);

2634 ià(
»t
 < 0)

2635 
out
;

2637 
out
:

2638 
	`kä“
(
poš‹rs
);

2639 
	`kä“
(
unm­_¬¿y
);

2640  
»t
;

2641 
	}
}

2643 
	$süub_as£mbË_»ad_bios
(
bŒfs_¿id_bio
 *
rbio
)

2645 
bio_li¡
 bio_li¡ = 
BIO_EMPTY_LIST
;

2646 
tÙ®_£ùÜ_Ä
;

2647 
»t
 = 0;

2650 
tÙ®_£ùÜ_Ä
 = 0;Ù®_£ùÜ_Ä < 
rbio
->
Ä_£ùÜs
;

2651 
tÙ®_£ùÜ_Ä
++) {

2652 
£ùÜÄ
 = 
tÙ®_£ùÜ_Ä
 % 
rbio
->
¡re_n£ùÜs
;

2653 
¡re
 = 
tÙ®_£ùÜ_Ä
 / 
rbio
->
¡re_n£ùÜs
;

2654 
£ùÜ_±r
 *
£ùÜ
;

2657 ià(!
	`‹¡_b™
(
£ùÜÄ
, &
rbio
->
db™m­
))

2665 
£ùÜ
 = 
	`£ùÜ_š_rbio
(
rbio
, 
¡re
, 
£ùÜÄ
, 1);

2666 ià(
£ùÜ
)

2669 
£ùÜ
 = 
	`rbio_¡re_£ùÜ
(
rbio
, 
¡re
, 
£ùÜÄ
);

2674 ià(
£ùÜ
->
u±od©e
)

2677 
»t
 = 
	`rbio_add_io_£ùÜ
(
rbio
, &
bio_li¡
, 
£ùÜ
, 
¡re
,

2678 
£ùÜÄ
, 
REQ_OP_READ
);

2679 ià(
»t
) {

2680 
	`bio_li¡_put
(&
bio_li¡
);

2681  
»t
;

2685 
	`subm™_»ad_wa™_bio_li¡
(
rbio
, &
bio_li¡
);

2687 
	}
}

2689 
	$süub_rbio
(
bŒfs_¿id_bio
 *
rbio
)

2691 
£ùÜ_Ä
;

2692 
»t
;

2694 
»t
 = 
	`®loc_rbio_es£ÁŸl_·ges
(
rbio
);

2695 ià(
»t
)

2696 
out
;

2698 
	`b™m­_ş—r
(
rbio
->
”rÜ_b™m­
, 0,„bio->
Ä_£ùÜs
);

2700 
»t
 = 
	`süub_as£mbË_»ad_bios
(
rbio
);

2701 ià(
»t
 < 0)

2702 
out
;

2705 
»t
 = 
	`»cov”_süub_rbio
(
rbio
);

2706 ià(
»t
 < 0)

2707 
out
;

2713 
»t
 = 
	`fšish_·r™y_süub
(
rbio
);

2714 
	`wa™_ev’t
(
rbio
->
io_wa™
, 
	`©omic_»ad
(&rbio->
¡res_³ndšg
) == 0);

2715 
£ùÜ_Ä
 = 0; seùÜ_Ä < 
rbio
->
¡re_n£ùÜs
; sector_nr++) {

2716 
found_”rÜs
;

2718 
found_”rÜs
 = 
	`g‘_rbio_v”™iÿl_”rÜs
(
rbio
, 
£ùÜ_Ä
, 
NULL
, NULL);

2719 ià(
found_”rÜs
 > 
rbio
->
bioc
->
max_”rÜs
) {

2720 
»t
 = -
EIO
;

2724 
out
:

2725 
	`rbio_Üig_’d_io
(
rbio
, 
	`”ºo_to_blk_¡©us
(
»t
));

2726 
	}
}

2728 
	$süub_rbio_wÜk_locked
(
wÜk_¡ruù
 *
wÜk
)

2730 
	`süub_rbio
(
	`cÚš”_of
(
wÜk
, 
bŒfs_¿id_bio
, work));

2731 
	}
}

2733 
	$¿id56_·r™y_subm™_süub_rbio
(
bŒfs_¿id_bio
 *
rbio
)

2735 ià(!
	`lock_¡re_add
(
rbio
))

2736 
	`¡¬t_async_wÜk
(
rbio
, 
süub_rbio_wÜk_locked
);

2737 
	}
}

2746 
	$¿id56_·r™y_ÿche_d©a_·ges
(
bŒfs_¿id_bio
 *
rbio
,

2747 
·ge
 **
d©a_·ges
, 
u64
 
d©a_logiÿl
)

2749 cÚ¡ 
u64
 
off£t_š_fuÎ_¡re
 = 
d©a_logiÿl
 -

2750 
rbio
->
bioc
->
fuÎ_¡re_logiÿl
;

2751 cÚ¡ 
·ge_šdex
 = 
off£t_š_fuÎ_¡re
 >> 
PAGE_SHIFT
;

2752 cÚ¡ 
u32
 
£ùÜsize
 = 
rbio
->
bioc
->
fs_šfo
->sectorsize;

2753 cÚ¡ 
u32
 
£ùÜs_³r_·ge
 = 
PAGE_SIZE
 / 
£ùÜsize
;

2754 
»t
;

2764 
»t
 = 
	`®loc_rbio_d©a_·ges
(
rbio
);

2765 ià(
»t
 < 0)

2769 
	`ASSERT
(
	`IS_ALIGNED
(
off£t_š_fuÎ_¡re
, 
BTRFS_STRIPE_LEN
));

2770 
	`ASSERT
(
off£t_š_fuÎ_¡re
 < (
rbio
->
Ä_d©a
 << 
BTRFS_STRIPE_LEN_SHIFT
));

2772 
·ge_Ä
 = 0;…age_Ä < (
BTRFS_STRIPE_LEN
 >> 
PAGE_SHIFT
);…age_nr++) {

2773 
·ge
 *
d¡
 = 
rbio
->
¡re_·ges
[
·ge_Ä
 + 
·ge_šdex
];

2774 
·ge
 *
¤c
 = 
d©a_·ges
[
·ge_Ä
];

2776 
	`memıy_·ge
(
d¡
, 0, 
¤c
, 0, 
PAGE_SIZE
);

2777 
£ùÜ_Ä
 = 
£ùÜs_³r_·ge
 * 
·ge_šdex
;

2778 
£ùÜ_Ä
 < 
£ùÜs_³r_·ge
 * (
·ge_šdex
 + 1);

2779 
£ùÜ_Ä
++)

2780 
rbio
->
¡re_£ùÜs
[
£ùÜ_Ä
].
u±od©e
 = 
Œue
;

2782 
	}
}

	@raid56.h

7 #iâdeà
BTRFS_RAID56_H


8 
	#BTRFS_RAID56_H


	)

10 
	~<lšux/wÜkqueue.h
>

11 
	~"vŞumes.h
"

13 
	ebŒfs_rbio_İs
 {

14 
	mBTRFS_RBIO_WRITE
,

15 
	mBTRFS_RBIO_READ_REBUILD
,

16 
	mBTRFS_RBIO_PARITY_SCRUB
,

19 
	sbŒfs_¿id_bio
 {

20 
bŒfs_io_cÚ‹xt
 *
	mbioc
;

26 
li¡_h—d
 
	mhash_li¡
;

29 
li¡_h—d
 
	m¡re_ÿche
;

32 
wÜk_¡ruù
 
	mwÜk
;

38 
bio_li¡
 
	mbio_li¡
;

39 
¥šlock_t
 
	mbio_li¡_lock
;

47 
li¡_h—d
 
	m¶ug_li¡
;

50 
	mæags
;

56 
bŒfs_rbio_İs
 
	mİ”©iÚ
;

59 
u16
 
	mÄ_·ges
;

62 
u16
 
	mÄ_£ùÜs
;

65 
u8
 
	mÄ_d©a
;

68 
u8
 
	m»®_¡res
;

71 
u8
 
	m¡re_Åages
;

74 
u8
 
	m¡re_n£ùÜs
;

77 
u8
 
	msüubp
;

83 
	mbio_li¡_by‹s
;

85 
»fcouÁ_t
 
	m»fs
;

87 
©omic_t
 
	m¡res_³ndšg
;

89 
wa™_queue_h—d_t
 
	mio_wa™
;

92 
	mdb™m­
;

95 
	mfšish_pb™m­
;

107 
·ge
 **
	m¡re_·ges
;

110 
£ùÜ_±r
 *
	mbio_£ùÜs
;

116 
£ùÜ_±r
 *
	m¡re_£ùÜs
;

119 **
	mfšish_poš‹rs
;

130 *
	m”rÜ_b™m­
;

136 
u8
 *
	mcsum_buf
;

142 *
	mcsum_b™m­
;

152 
	s¿id56_bio_Œaû_šfo
 {

153 
u64
 
	mdevid
;

156 
u32
 
	moff£t
;

164 
u8
 
	m¡re_Ä
;

167 
šlše
 
	$Ä_d©a_¡res
(cÚ¡ 
m­_lookup
 *
m­
)

169  
m­
->
num_¡res
 - 
	`bŒfs_Ä_·r™y_¡res
(m­->
ty³
);

170 
	}
}

172 
šlše
 
	$Ä_bioc_d©a_¡res
(cÚ¡ 
bŒfs_io_cÚ‹xt
 *
bioc
)

174  
bioc
->
num_¡res
 - 
	`bŒfs_Ä_·r™y_¡res
(bioc->
m­_ty³
);

175 
	}
}

177 
	#RAID5_P_STRIPE
 ((
u64
)-2)

	)

178 
	#RAID6_Q_STRIPE
 ((
u64
)-1)

	)

180 
	#is_·r™y_¡re
(
x
è(((xè=ğ
RAID5_P_STRIPE
) || \

181 ((
x
è=ğ
RAID6_Q_STRIPE
))

	)

183 
	gbŒfs_deviû
;

185 
¿id56_·r™y_»cov”
(
bio
 *bio, 
bŒfs_io_cÚ‹xt
 *
bioc
,

186 
mœrÜ_num
);

187 
¿id56_·r™y_wr™e
(
bio
 *bio, 
bŒfs_io_cÚ‹xt
 *
bioc
);

189 
bŒfs_¿id_bio
 *
¿id56_·r™y_®loc_süub_rbio
(
bio
 *bio,

190 
bŒfs_io_cÚ‹xt
 *
bioc
,

191 
bŒfs_deviû
 *
süub_dev
,

192 *
db™m­
, 
¡re_n£ùÜs
);

193 
¿id56_·r™y_subm™_süub_rbio
(
bŒfs_¿id_bio
 *
rbio
);

195 
¿id56_·r™y_ÿche_d©a_·ges
(
bŒfs_¿id_bio
 *
rbio
,

196 
·ge
 **
d©a_·ges
, 
u64
 
d©a_logiÿl
);

198 
bŒfs_®loc_¡re_hash_bË
(
bŒfs_fs_šfo
 *
šfo
);

199 
bŒfs_ä“_¡re_hash_bË
(
bŒfs_fs_šfo
 *
šfo
);

	@rcu-string.h

6 #iâdeà
BTRFS_RCU_STRING_H


7 
	#BTRFS_RCU_STRING_H


	)

9 
	srcu_¡ršg
 {

10 
rcu_h—d
 
	mrcu
;

11 
	m¡r
[];

14 
šlše
 
rcu_¡ršg
 *
	$rcu_¡ršg_¡rdup
(cÚ¡ *
¤c
, 
gå_t
 
mask
)

16 
size_t
 
Ën
 = 
	`¡¾’
(
¤c
) + 1;

17 
rcu_¡ršg
 *
»t
 = 
	`kz®loc
((rcu_string) +

18 (
Ën
 * ()), 
mask
);

19 ià(!
»t
)

20  
»t
;

22 ià(
	`WARN_ON
(
	`¡rsıy
(
»t
->
¡r
, 
¤c
, 
Ën
) < 0)) {

23 
	`kä“
(
»t
);

24  
NULL
;

26  
»t
;

27 
	}
}

29 
šlše
 
	$rcu_¡ršg_ä“
(
rcu_¡ršg
 *
¡r
)

31 ià(
¡r
)

32 
	`kä“_rcu
(
¡r
, 
rcu
);

33 
	}
}

35 
	#´štk_š_rcu
(
fmt
, ...) do { \

36 
	`rcu_»ad_lock
(); \

37 
	`´štk
(
fmt
, 
__VA_ARGS__
); \

38 
	`rcu_»ad_uÆock
(); \

39 } 0)

	)

41 
	#´štk_¿‹lim™ed_š_rcu
(
fmt
, ...) do { \

42 
	`rcu_»ad_lock
(); \

43 
	`´štk_¿‹lim™ed
(
fmt
, 
__VA_ARGS__
); \

44 
	`rcu_»ad_uÆock
(); \

45 } 0)

	)

47 
	#rcu_¡r_d”ef
(
rcu_¡r
) ({ \

48 
rcu_¡ršg
 *
__¡r
 = 
	`rcu_d”eã»nû
(
rcu_¡r
); \

49 
__¡r
->
¡r
; \

50 })

	)

	@ref-verify.c

6 
	~<lšux/sched.h
>

7 
	~<lšux/¡ackŒaû.h
>

8 
	~"mes§ges.h
"

9 
	~"ù»e.h
"

10 
	~"disk-io.h
"

11 
	~"lockšg.h
"

12 
	~"d–ayed-»f.h
"

13 
	~"»f-v”ify.h
"

14 
	~"fs.h
"

15 
	~"acûssÜs.h
"

22 
	sroÙ_’Œy
 {

23 
u64
 
	mroÙ_objeùid
;

24 
u64
 
	mnum_»fs
;

25 
rb_node
 
	mnode
;

33 
	s»f_’Œy
 {

34 
u64
 
	mroÙ_objeùid
;

35 
u64
 
	m·»Á
;

36 
u64
 
	mowÃr
;

37 
u64
 
	moff£t
;

38 
u64
 
	mnum_»fs
;

39 
rb_node
 
	mnode
;

42 
	#MAX_TRACE
 16

	)

51 
	s»f_aùiÚ
 {

52 
	maùiÚ
;

53 
u64
 
	mroÙ
;

54 
»f_’Œy
 
	m»f
;

55 
li¡_h—d
 
	mli¡
;

56 
	mŒaû
[
MAX_TRACE
];

57 
	mŒaû_Ën
;

66 
	sblock_’Œy
 {

67 
u64
 
	mby‹Ä
;

68 
u64
 
	mËn
;

69 
u64
 
	mnum_»fs
;

70 
	mm‘ad©a
;

71 
	mäom_disk
;

72 
rb_roÙ
 
	mroÙs
;

73 
rb_roÙ
 
	m»fs
;

74 
rb_node
 
	mnode
;

75 
li¡_h—d
 
	maùiÚs
;

78 
block_’Œy
 *
	$š£¹_block_’Œy
(
rb_roÙ
 *
roÙ
,

79 
block_’Œy
 *
be
)

81 
rb_node
 **
p
 = &
roÙ
->rb_node;

82 
rb_node
 *
·»Á_node
 = 
NULL
;

83 
block_’Œy
 *
’Œy
;

85 *
p
) {

86 
·»Á_node
 = *
p
;

87 
’Œy
 = 
	`rb_’Œy
(
·»Á_node
, 
block_’Œy
, 
node
);

88 ià(
’Œy
->
by‹Ä
 > 
be
->bytenr)

89 
p
 = &(*p)->
rb_Ëá
;

90 ià(
’Œy
->
by‹Ä
 < 
be
->bytenr)

91 
p
 = &(*p)->
rb_right
;

93  
’Œy
;

96 
	`rb_lšk_node
(&
be
->
node
, 
·»Á_node
, 
p
);

97 
	`rb_š£¹_cŞÜ
(&
be
->
node
, 
roÙ
);

98  
NULL
;

99 
	}
}

101 
block_’Œy
 *
	$lookup_block_’Œy
(
rb_roÙ
 *
roÙ
, 
u64
 
by‹Ä
)

103 
rb_node
 *
n
;

104 
block_’Œy
 *
’Œy
 = 
NULL
;

106 
n
 = 
roÙ
->
rb_node
;

107 
n
) {

108 
’Œy
 = 
	`rb_’Œy
(
n
, 
block_’Œy
, 
node
);

109 ià(
’Œy
->
by‹Ä
 < bytenr)

110 
n
 =‚->
rb_right
;

111 ià(
’Œy
->
by‹Ä
 > bytenr)

112 
n
 =‚->
rb_Ëá
;

114  
’Œy
;

116  
NULL
;

117 
	}
}

119 
roÙ_’Œy
 *
	$š£¹_roÙ_’Œy
(
rb_roÙ
 *
roÙ
,

120 
roÙ_’Œy
 *
»
)

122 
rb_node
 **
p
 = &
roÙ
->rb_node;

123 
rb_node
 *
·»Á_node
 = 
NULL
;

124 
roÙ_’Œy
 *
’Œy
;

126 *
p
) {

127 
·»Á_node
 = *
p
;

128 
’Œy
 = 
	`rb_’Œy
(
·»Á_node
, 
roÙ_’Œy
, 
node
);

129 ià(
’Œy
->
roÙ_objeùid
 > 
»
->root_objectid)

130 
p
 = &(*p)->
rb_Ëá
;

131 ià(
’Œy
->
roÙ_objeùid
 < 
»
->root_objectid)

132 
p
 = &(*p)->
rb_right
;

134  
’Œy
;

137 
	`rb_lšk_node
(&
»
->
node
, 
·»Á_node
, 
p
);

138 
	`rb_š£¹_cŞÜ
(&
»
->
node
, 
roÙ
);

139  
NULL
;

141 
	}
}

143 
	$comp_»fs
(
»f_’Œy
 *
»f1
, »f_’Œy *
»f2
)

145 ià(
»f1
->
roÙ_objeùid
 < 
»f2
->root_objectid)

147 ià(
»f1
->
roÙ_objeùid
 > 
»f2
->root_objectid)

149 ià(
»f1
->
·»Á
 < 
»f2
->parent)

151 ià(
»f1
->
·»Á
 > 
»f2
->parent)

153 ià(
»f1
->
owÃr
 < 
»f2
->owner)

155 ià(
»f1
->
owÃr
 > 
»f2
->owner)

157 ià(
»f1
->
off£t
 < 
»f2
->offset)

159 ià(
»f1
->
off£t
 > 
»f2
->offset)

162 
	}
}

164 
»f_’Œy
 *
	$š£¹_»f_’Œy
(
rb_roÙ
 *
roÙ
,

165 
»f_’Œy
 *
»f
)

167 
rb_node
 **
p
 = &
roÙ
->rb_node;

168 
rb_node
 *
·»Á_node
 = 
NULL
;

169 
»f_’Œy
 *
’Œy
;

170 
cmp
;

172 *
p
) {

173 
·»Á_node
 = *
p
;

174 
’Œy
 = 
	`rb_’Œy
(
·»Á_node
, 
»f_’Œy
, 
node
);

175 
cmp
 = 
	`comp_»fs
(
’Œy
, 
»f
);

176 ià(
cmp
 > 0)

177 
p
 = &(*p)->
rb_Ëá
;

178 ià(
cmp
 < 0)

179 
p
 = &(*p)->
rb_right
;

181  
’Œy
;

184 
	`rb_lšk_node
(&
»f
->
node
, 
·»Á_node
, 
p
);

185 
	`rb_š£¹_cŞÜ
(&
»f
->
node
, 
roÙ
);

186  
NULL
;

188 
	}
}

190 
roÙ_’Œy
 *
	$lookup_roÙ_’Œy
(
rb_roÙ
 *
roÙ
, 
u64
 
objeùid
)

192 
rb_node
 *
n
;

193 
roÙ_’Œy
 *
’Œy
 = 
NULL
;

195 
n
 = 
roÙ
->
rb_node
;

196 
n
) {

197 
’Œy
 = 
	`rb_’Œy
(
n
, 
roÙ_’Œy
, 
node
);

198 ià(
’Œy
->
roÙ_objeùid
 < 
objeùid
)

199 
n
 =‚->
rb_right
;

200 ià(
’Œy
->
roÙ_objeùid
 > 
objeùid
)

201 
n
 =‚->
rb_Ëá
;

203  
’Œy
;

205  
NULL
;

206 
	}
}

208 #ifdeà
CONFIG_STACKTRACE


209 
	$__§ve_¡ack_Œaû
(
»f_aùiÚ
 *
¿
)

211 
¿
->
Œaû_Ën
 = 
	`¡ack_Œaû_§ve
Ôa->
Œaû
, 
MAX_TRACE
, 2);

212 
	}
}

214 
	$__´št_¡ack_Œaû
(
bŒfs_fs_šfo
 *
fs_šfo
,

215 
»f_aùiÚ
 *
¿
)

217 ià(
¿
->
Œaû_Ën
 == 0) {

218 
	`bŒfs_”r
(
fs_šfo
, "„ef-verify:‚o stacktrace");

221 
	`¡ack_Œaû_´št
(
¿
->
Œaû
,„a->
Œaû_Ën
, 2);

222 
	}
}

224 
šlše
 
	$__§ve_¡ack_Œaû
(
»f_aùiÚ
 *
¿
)

226 
	}
}

228 
šlše
 
	$__´št_¡ack_Œaû
(
bŒfs_fs_šfo
 *
fs_šfo
,

229 
»f_aùiÚ
 *
¿
)

231 
	`bŒfs_”r
(
fs_šfo
, "„ef-verify:‚o stacktrace support");

232 
	}
}

235 
	$ä“_block_’Œy
(
block_’Œy
 *
be
)

237 
roÙ_’Œy
 *
»
;

238 
»f_’Œy
 *
»f
;

239 
»f_aùiÚ
 *
¿
;

240 
rb_node
 *
n
;

242 (
n
 = 
	`rb_fœ¡
(&
be
->
roÙs
))) {

243 
»
 = 
	`rb_’Œy
(
n
, 
roÙ_’Œy
, 
node
);

244 
	`rb_”a£
(&
»
->
node
, &
be
->
roÙs
);

245 
	`kä“
(
»
);

248 (
n
 = 
	`rb_fœ¡
(&
be
->
»fs
))) {

249 
»f
 = 
	`rb_’Œy
(
n
, 
»f_’Œy
, 
node
);

250 
	`rb_”a£
(&
»f
->
node
, &
be
->
»fs
);

251 
	`kä“
(
»f
);

254 !
	`li¡_em±y
(&
be
->
aùiÚs
)) {

255 
¿
 = 
	`li¡_fœ¡_’Œy
(&
be
->
aùiÚs
, 
»f_aùiÚ
,

256 
li¡
);

257 
	`li¡_d–
(&
¿
->
li¡
);

258 
	`kä“
(
¿
);

260 
	`kä“
(
be
);

261 
	}
}

263 
block_’Œy
 *
	$add_block_’Œy
(
bŒfs_fs_šfo
 *
fs_šfo
,

264 
u64
 
by‹Ä
, u64 
Ën
,

265 
u64
 
roÙ_objeùid
)

267 
block_’Œy
 *
be
 = 
NULL
, *
exi¡
;

268 
roÙ_’Œy
 *
»
 = 
NULL
;

270 
»
 = 
	`kz®loc
((
roÙ_’Œy
), 
GFP_NOFS
);

271 
be
 = 
	`kz®loc
((
block_’Œy
), 
GFP_NOFS
);

272 ià(!
be
 || !
»
) {

273 
	`kä“
(
»
);

274 
	`kä“
(
be
);

275  
	`ERR_PTR
(-
ENOMEM
);

277 
be
->
by‹Ä
 = bytenr;

278 
be
->
Ën
 =†en;

280 
»
->
roÙ_objeùid
 =„oot_objectid;

281 
»
->
num_»fs
 = 0;

283 
	`¥š_lock
(&
fs_šfo
->
»f_v”ify_lock
);

284 
exi¡
 = 
	`š£¹_block_’Œy
(&
fs_šfo
->
block_Œ“
, 
be
);

285 ià(
exi¡
) {

286 ià(
roÙ_objeùid
) {

287 
roÙ_’Œy
 *
exi¡_»
;

289 
exi¡_»
 = 
	`š£¹_roÙ_’Œy
(&
exi¡
->
roÙs
, 
»
);

290 ià(
exi¡_»
)

291 
	`kä“
(
»
);

293 
	`kä“
(
»
);

295 
	`kä“
(
be
);

296  
exi¡
;

299 
be
->
num_»fs
 = 0;

300 
be
->
m‘ad©a
 = 0;

301 
be
->
äom_disk
 = 0;

302 
be
->
roÙs
 = 
RB_ROOT
;

303 
be
->
»fs
 = 
RB_ROOT
;

304 
	`INIT_LIST_HEAD
(&
be
->
aùiÚs
);

305 ià(
roÙ_objeùid
)

306 
	`š£¹_roÙ_’Œy
(&
be
->
roÙs
, 
»
);

308 
	`kä“
(
»
);

309  
be
;

310 
	}
}

312 
	$add_Œ“_block
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
»f_roÙ
,

313 
u64
 
·»Á
, u64 
by‹Ä
, 
Ëv–
)

315 
block_’Œy
 *
be
;

316 
roÙ_’Œy
 *
»
;

317 
»f_’Œy
 *
»f
 = 
NULL
, *
exi¡
;

319 
»f
 = 
	`km®loc
((
»f_’Œy
), 
GFP_NOFS
);

320 ià(!
»f
)

321  -
ENOMEM
;

323 ià(
·»Á
)

324 
»f
->
roÙ_objeùid
 = 0;

326 
»f
->
roÙ_objeùid
 = 
»f_roÙ
;

327 
»f
->
·»Á
 =…arent;

328 
»f
->
owÃr
 = 
Ëv–
;

329 
»f
->
off£t
 = 0;

330 
»f
->
num_»fs
 = 1;

332 
be
 = 
	`add_block_’Œy
(
fs_šfo
, 
by‹Ä
, fs_šfo->
nodesize
, 
»f_roÙ
);

333 ià(
	`IS_ERR
(
be
)) {

334 
	`kä“
(
»f
);

335  
	`PTR_ERR
(
be
);

337 
be
->
num_»fs
++;

338 
be
->
äom_disk
 = 1;

339 
be
->
m‘ad©a
 = 1;

341 ià(!
·»Á
) {

342 
	`ASSERT
(
»f_roÙ
);

343 
»
 = 
	`lookup_roÙ_’Œy
(&
be
->
roÙs
, 
»f_roÙ
);

344 
	`ASSERT
(
»
);

345 
»
->
num_»fs
++;

347 
exi¡
 = 
	`š£¹_»f_’Œy
(&
be
->
»fs
, 
»f
);

348 ià(
exi¡
) {

349 
exi¡
->
num_»fs
++;

350 
	`kä“
(
»f
);

352 
	`¥š_uÆock
(&
fs_šfo
->
»f_v”ify_lock
);

355 
	}
}

357 
	$add_sh¬ed_d©a_»f
(
bŒfs_fs_šfo
 *
fs_šfo
,

358 
u64
 
·»Á
, 
u32
 
num_»fs
, u64 
by‹Ä
,

359 
u64
 
num_by‹s
)

361 
block_’Œy
 *
be
;

362 
»f_’Œy
 *
»f
;

364 
»f
 = 
	`kz®loc
((
»f_’Œy
), 
GFP_NOFS
);

365 ià(!
»f
)

366  -
ENOMEM
;

367 
be
 = 
	`add_block_’Œy
(
fs_šfo
, 
by‹Ä
, 
num_by‹s
, 0);

368 ià(
	`IS_ERR
(
be
)) {

369 
	`kä“
(
»f
);

370  
	`PTR_ERR
(
be
);

372 
be
->
num_»fs
 +=‚um_refs;

374 
»f
->
·»Á
 =…arent;

375 
»f
->
num_»fs
 =‚um_refs;

376 ià(
	`š£¹_»f_’Œy
(&
be
->
»fs
, 
»f
)) {

377 
	`¥š_uÆock
(&
fs_šfo
->
»f_v”ify_lock
);

378 
	`bŒfs_”r
(
fs_šfo
, "existing shared„ef when„eading from disk?");

379 
	`kä“
(
»f
);

380  -
EINVAL
;

382 
	`¥š_uÆock
(&
fs_šfo
->
»f_v”ify_lock
);

384 
	}
}

386 
	$add_ex‹Á_d©a_»f
(
bŒfs_fs_šfo
 *
fs_šfo
,

387 
ex‹Á_bufãr
 *
Ëaf
,

388 
bŒfs_ex‹Á_d©a_»f
 *
d»f
,

389 
u64
 
by‹Ä
, u64 
num_by‹s
)

391 
block_’Œy
 *
be
;

392 
»f_’Œy
 *
»f
;

393 
roÙ_’Œy
 *
»
;

394 
u64
 
»f_roÙ
 = 
	`bŒfs_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
d»f
);

395 
u64
 
owÃr
 = 
	`bŒfs_ex‹Á_d©a_»f_objeùid
(
Ëaf
, 
d»f
);

396 
u64
 
off£t
 = 
	`bŒfs_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
d»f
);

397 
u32
 
num_»fs
 = 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
d»f
);

399 
»f
 = 
	`kz®loc
((
»f_’Œy
), 
GFP_NOFS
);

400 ià(!
»f
)

401  -
ENOMEM
;

402 
be
 = 
	`add_block_’Œy
(
fs_šfo
, 
by‹Ä
, 
num_by‹s
, 
»f_roÙ
);

403 ià(
	`IS_ERR
(
be
)) {

404 
	`kä“
(
»f
);

405  
	`PTR_ERR
(
be
);

407 
be
->
num_»fs
 +=‚um_refs;

409 
»f
->
·»Á
 = 0;

410 
»f
->
owÃr
 = owner;

411 
»f
->
roÙ_objeùid
 = 
»f_roÙ
;

412 
»f
->
off£t
 = offset;

413 
»f
->
num_»fs
 =‚um_refs;

414 ià(
	`š£¹_»f_’Œy
(&
be
->
»fs
, 
»f
)) {

415 
	`¥š_uÆock
(&
fs_šfo
->
»f_v”ify_lock
);

416 
	`bŒfs_”r
(
fs_šfo
, "existing„ef when„eading from disk?");

417 
	`kä“
(
»f
);

418  -
EINVAL
;

421 
»
 = 
	`lookup_roÙ_’Œy
(&
be
->
roÙs
, 
»f_roÙ
);

422 ià(!
»
) {

423 
	`¥š_uÆock
(&
fs_šfo
->
»f_v”ify_lock
);

424 
	`bŒfs_”r
(
fs_šfo
, "missing„oot in‚ew blockƒntry?");

425  -
EINVAL
;

427 
»
->
num_»fs
 +=‚um_refs;

428 
	`¥š_uÆock
(&
fs_šfo
->
»f_v”ify_lock
);

430 
	}
}

432 
	$´oûss_ex‹Á_™em
(
bŒfs_fs_šfo
 *
fs_šfo
,

433 
bŒfs_·th
 *
·th
, 
bŒfs_key
 *
key
,

434 
¦Ù
, *
Œ“_block_Ëv–
)

436 
bŒfs_ex‹Á_™em
 *
ei
;

437 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

438 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

439 
bŒfs_sh¬ed_d©a_»f
 *
¤ef
;

440 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

441 
u32
 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

442 
’d
, 
±r
;

443 
u64
 
off£t
, 
æags
, 
couÁ
;

444 
ty³
, 
»t
;

446 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_ex‹Á_™em
);

447 
æags
 = 
	`bŒfs_ex‹Á_æags
(
Ëaf
, 
ei
);

449 ià((
key
->
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
) &&

450 
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

451 
bŒfs_Œ“_block_šfo
 *
šfo
;

453 
šfo
 = (
bŒfs_Œ“_block_šfo
 *)(
ei
 + 1);

454 *
Œ“_block_Ëv–
 = 
	`bŒfs_Œ“_block_Ëv–
(
Ëaf
, 
šfo
);

455 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
šfo
 + 1);

457 ià(
key
->
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
)

458 *
Œ“_block_Ëv–
 = 
key
->
off£t
;

459 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
ei
 + 1);

462 
±r
 = ()
œef
;

463 
’d
 = ()
ei
 + 
™em_size
;

464 
±r
 < 
’d
) {

465 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)
±r
;

466 
ty³
 = 
	`bŒfs_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
);

467 
off£t
 = 
	`bŒfs_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
);

468 
ty³
) {

469 
BTRFS_TREE_BLOCK_REF_KEY
:

470 
»t
 = 
	`add_Œ“_block
(
fs_šfo
, 
off£t
, 0, 
key
->
objeùid
,

471 *
Œ“_block_Ëv–
);

473 
BTRFS_SHARED_BLOCK_REF_KEY
:

474 
»t
 = 
	`add_Œ“_block
(
fs_šfo
, 0, 
off£t
, 
key
->
objeùid
,

475 *
Œ“_block_Ëv–
);

477 
BTRFS_EXTENT_DATA_REF_KEY
:

478 
d»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

479 
»t
 = 
	`add_ex‹Á_d©a_»f
(
fs_šfo
, 
Ëaf
, 
d»f
,

480 
key
->
objeùid
, key->
off£t
);

482 
BTRFS_SHARED_DATA_REF_KEY
:

483 
¤ef
 = (
bŒfs_sh¬ed_d©a_»f
 *)(
œef
 + 1);

484 
couÁ
 = 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
¤ef
);

485 
»t
 = 
	`add_sh¬ed_d©a_»f
(
fs_šfo
, 
off£t
, 
couÁ
,

486 
key
->
objeùid
, key->
off£t
);

489 
	`bŒfs_”r
(
fs_šfo
, "invalid keyype in iref");

490 
»t
 = -
EINVAL
;

493 ià(
»t
)

495 
±r
 +ğ
	`bŒfs_ex‹Á_šlše_»f_size
(
ty³
);

497  
»t
;

498 
	}
}

500 
	$´oûss_Ëaf
(
bŒfs_roÙ
 *
roÙ
,

501 
bŒfs_·th
 *
·th
, 
u64
 *
by‹Ä
, u64 *
num_by‹s
,

502 *
Œ“_block_Ëv–
)

504 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

505 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

506 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

507 
bŒfs_sh¬ed_d©a_»f
 *
¤ef
;

508 
u32
 
couÁ
;

509 
i
 = 0, 
»t
 = 0;

510 
bŒfs_key
 
key
;

511 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

513 
i
 = 0; i < 
Ä™ems
; i++) {

514 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
i
);

515 
key
.
ty³
) {

516 
BTRFS_EXTENT_ITEM_KEY
:

517 *
num_by‹s
 = 
key
.
off£t
;

518 
çÎthrough
;

519 
BTRFS_METADATA_ITEM_KEY
:

520 *
by‹Ä
 = 
key
.
objeùid
;

521 
»t
 = 
	`´oûss_ex‹Á_™em
(
fs_šfo
, 
·th
, &
key
, 
i
,

522 
Œ“_block_Ëv–
);

524 
BTRFS_TREE_BLOCK_REF_KEY
:

525 
»t
 = 
	`add_Œ“_block
(
fs_šfo
, 
key
.
off£t
, 0,

526 
key
.
objeùid
, *
Œ“_block_Ëv–
);

528 
BTRFS_SHARED_BLOCK_REF_KEY
:

529 
»t
 = 
	`add_Œ“_block
(
fs_šfo
, 0, 
key
.
off£t
,

530 
key
.
objeùid
, *
Œ“_block_Ëv–
);

532 
BTRFS_EXTENT_DATA_REF_KEY
:

533 
d»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
i
,

534 
bŒfs_ex‹Á_d©a_»f
);

535 
»t
 = 
	`add_ex‹Á_d©a_»f
(
fs_šfo
, 
Ëaf
, 
d»f
, *
by‹Ä
,

536 *
num_by‹s
);

538 
BTRFS_SHARED_DATA_REF_KEY
:

539 
¤ef
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
i
,

540 
bŒfs_sh¬ed_d©a_»f
);

541 
couÁ
 = 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
¤ef
);

542 
»t
 = 
	`add_sh¬ed_d©a_»f
(
fs_šfo
, 
key
.
off£t
, 
couÁ
,

543 *
by‹Ä
, *
num_by‹s
);

548 ià(
»t
)

551  
»t
;

552 
	}
}

555 
	$w®k_down_Œ“
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

556 
Ëv–
, 
u64
 *
by‹Ä
, u64 *
num_by‹s
,

557 *
Œ“_block_Ëv–
)

559 
ex‹Á_bufãr
 *
eb
;

560 
»t
 = 0;

562 
Ëv–
 >= 0) {

563 ià(
Ëv–
) {

564 
eb
 = 
	`bŒfs_»ad_node_¦Ù
(
·th
->
nodes
[
Ëv–
],

565 
·th
->
¦Ùs
[
Ëv–
]);

566 ià(
	`IS_ERR
(
eb
))

567  
	`PTR_ERR
(
eb
);

568 
	`bŒfs_Œ“_»ad_lock
(
eb
);

569 
·th
->
nodes
[
Ëv–
-1] = 
eb
;

570 
·th
->
¦Ùs
[
Ëv–
-1] = 0;

571 
·th
->
locks
[
Ëv–
-1] = 
BTRFS_READ_LOCK
;

573 
»t
 = 
	`´oûss_Ëaf
(
roÙ
, 
·th
, 
by‹Ä
, 
num_by‹s
,

574 
Œ“_block_Ëv–
);

575 ià(
»t
)

578 
Ëv–
--;

580  
»t
;

581 
	}
}

584 
	$w®k_up_Œ“
(
bŒfs_·th
 *
·th
, *
Ëv–
)

586 
l
;

588 
l
 = 0;† < 
BTRFS_MAX_LEVEL
;†++) {

589 ià(!
·th
->
nodes
[
l
])

591 ià(
l
) {

592 
·th
->
¦Ùs
[
l
]++;

593 ià(
·th
->
¦Ùs
[
l
] <

594 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[
l
])) {

595 *
Ëv–
 = 
l
;

599 
	`bŒfs_Œ“_uÆock_rw
(
·th
->
nodes
[
l
],…©h->
locks
[l]);

600 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[
l
]);

601 
·th
->
nodes
[
l
] = 
NULL
;

602 
·th
->
¦Ùs
[
l
] = 0;

603 
·th
->
locks
[
l
] = 0;

607 
	}
}

609 
	$dump_»f_aùiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
,

610 
»f_aùiÚ
 *
¿
)

612 
	`bŒfs_”r
(
fs_šfo
,

614 
¿
->
aùiÚ
,„a->
roÙ
,„a->
»f
.
roÙ_objeùid
,„a->»f.
·»Á
,

615 
¿
->
»f
.
owÃr
,„a->»f.
off£t
,„a->»f.
num_»fs
);

616 
	`__´št_¡ack_Œaû
(
fs_šfo
, 
¿
);

617 
	}
}

623 
	$dump_block_’Œy
(
bŒfs_fs_šfo
 *
fs_šfo
,

624 
block_’Œy
 *
be
)

626 
»f_’Œy
 *
»f
;

627 
roÙ_’Œy
 *
»
;

628 
»f_aùiÚ
 *
¿
;

629 
rb_node
 *
n
;

631 
	`bŒfs_”r
(
fs_šfo
,

633 
be
->
by‹Ä
, be->
Ën
, be->
num_»fs
, be->
m‘ad©a
,

634 
be
->
äom_disk
);

636 
n
 = 
	`rb_fœ¡
(&
be
->
»fs
);‚;‚ = 
	`rb_Ãxt
(n)) {

637 
»f
 = 
	`rb_’Œy
(
n
, 
»f_’Œy
, 
node
);

638 
	`bŒfs_”r
(
fs_šfo
,

640 
»f
->
roÙ_objeùid
,„ef->
·»Á
,„ef->
owÃr
,

641 
»f
->
off£t
,„ef->
num_»fs
);

644 
n
 = 
	`rb_fœ¡
(&
be
->
roÙs
);‚;‚ = 
	`rb_Ãxt
(n)) {

645 
»
 = 
	`rb_’Œy
(
n
, 
roÙ_’Œy
, 
node
);

646 
	`bŒfs_”r
(
fs_šfo
, "„ootƒntry %llu,‚um_refs %llu",

647 
»
->
roÙ_objeùid
,„e->
num_»fs
);

650 
	`li¡_fÜ_—ch_’Œy
(
¿
, &
be
->
aùiÚs
, 
li¡
)

651 
	`dump_»f_aùiÚ
(
fs_šfo
, 
¿
);

652 
	}
}

662 
	$bŒfs_»f_Œ“_mod
(
bŒfs_fs_šfo
 *
fs_šfo
,

663 
bŒfs_»f
 *
g’”ic_»f
)

665 
»f_’Œy
 *
»f
 = 
NULL
, *
exi¡
;

666 
»f_aùiÚ
 *
¿
 = 
NULL
;

667 
block_’Œy
 *
be
 = 
NULL
;

668 
roÙ_’Œy
 *
»
 = 
NULL
;

669 
aùiÚ
 = 
g’”ic_»f
->action;

670 
»t
 = 0;

671 
boŞ
 
m‘ad©a
;

672 
u64
 
by‹Ä
 = 
g’”ic_»f
->bytenr;

673 
u64
 
num_by‹s
 = 
g’”ic_»f
->
Ën
;

674 
u64
 
·»Á
 = 
g’”ic_»f
->parent;

675 
u64
 
»f_roÙ
 = 0;

676 
u64
 
owÃr
 = 0;

677 
u64
 
off£t
 = 0;

679 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
REF_VERIFY
))

682 ià(
g’”ic_»f
->
ty³
 =ğ
BTRFS_REF_METADATA
) {

683 ià(!
·»Á
)

684 
»f_roÙ
 = 
g’”ic_»f
->
Œ“_»f
.
ownšg_roÙ
;

685 
owÃr
 = 
g’”ic_»f
->
Œ“_»f
.
Ëv–
;

686 } ià(!
·»Á
) {

687 
»f_roÙ
 = 
g’”ic_»f
->
d©a_»f
.
ownšg_roÙ
;

688 
owÃr
 = 
g’”ic_»f
->
d©a_»f
.
šo
;

689 
off£t
 = 
g’”ic_»f
->
d©a_»f
.offset;

691 
m‘ad©a
 = 
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
;

693 
»f
 = 
	`kz®loc
((
»f_’Œy
), 
GFP_NOFS
);

694 
¿
 = 
	`km®loc
((
»f_aùiÚ
), 
GFP_NOFS
);

695 ià(!
¿
 || !
»f
) {

696 
	`kä“
(
»f
);

697 
	`kä“
(
¿
);

698 
»t
 = -
ENOMEM
;

699 
out
;

702 
»f
->
·»Á
 =…arent;

703 
»f
->
owÃr
 = owner;

704 
»f
->
roÙ_objeùid
 = 
»f_roÙ
;

705 
»f
->
off£t
 = offset;

706 
»f
->
num_»fs
 = (
aùiÚ
 =ğ
BTRFS_DROP_DELAYED_REF
) ? -1 : 1;

708 
	`memıy
(&
¿
->
»f
,„ef, (
»f_’Œy
));

715 
¿
->
»f
.
owÃr
 = owner;

716 
¿
->
»f
.
off£t
 = offset;

717 
¿
->
»f
.
roÙ_objeùid
 = 
»f_roÙ
;

718 
	`__§ve_¡ack_Œaû
(
¿
);

720 
	`INIT_LIST_HEAD
(&
¿
->
li¡
);

721 
¿
->
aùiÚ
 =‡ction;

722 
¿
->
roÙ
 = 
g’”ic_»f
->
»®_roÙ
;

728 
»t
 = -
EINVAL
;

729 ià(
aùiÚ
 =ğ
BTRFS_ADD_DELAYED_EXTENT
) {

735 
be
 = 
	`add_block_’Œy
(
fs_šfo
, 
by‹Ä
, 
num_by‹s
, 
»f_roÙ
);

736 ià(
	`IS_ERR
(
be
)) {

737 
	`kä“
(
»f
);

738 
	`kä“
(
¿
);

739 
»t
 = 
	`PTR_ERR
(
be
);

740 
out
;

742 
be
->
num_»fs
++;

743 ià(
m‘ad©a
)

744 
be
->
m‘ad©a
 = 1;

746 ià(
be
->
num_»fs
 != 1) {

747 
	`bŒfs_”r
(
fs_šfo
,

749 
	`dump_block_’Œy
(
fs_šfo
, 
be
);

750 
	`dump_»f_aùiÚ
(
fs_šfo
, 
¿
);

751 
	`kä“
(
»f
);

752 
	`kä“
(
¿
);

753 
out_uÆock
;

756 !
	`li¡_em±y
(&
be
->
aùiÚs
)) {

757 
»f_aùiÚ
 *
tmp
;

759 
tmp
 = 
	`li¡_fœ¡_’Œy
(&
be
->
aùiÚs
, 
»f_aùiÚ
,

760 
li¡
);

761 
	`li¡_d–
(&
tmp
->
li¡
);

762 
	`kä“
(
tmp
);

765 
roÙ_’Œy
 *
tmp
;

767 ià(!
·»Á
) {

768 
»
 = 
	`km®loc
((
roÙ_’Œy
), 
GFP_NOFS
);

769 ià(!
»
) {

770 
	`kä“
(
»f
);

771 
	`kä“
(
¿
);

772 
»t
 = -
ENOMEM
;

773 
out
;

780 
»f_roÙ
 = 
g’”ic_»f
->
»®_roÙ
;

781 
»
->
roÙ_objeùid
 = 
g’”ic_»f
->
»®_roÙ
;

782 
»
->
num_»fs
 = 0;

785 
	`¥š_lock
(&
fs_šfo
->
»f_v”ify_lock
);

786 
be
 = 
	`lookup_block_’Œy
(&
fs_šfo
->
block_Œ“
, 
by‹Ä
);

787 ià(!
be
) {

788 
	`bŒfs_”r
(
fs_šfo
,

790 
aùiÚ
, 
by‹Ä
, 
num_by‹s
);

791 
	`dump_»f_aùiÚ
(
fs_šfo
, 
¿
);

792 
	`kä“
(
»f
);

793 
	`kä“
(
¿
);

794 
	`kä“
(
»
);

795 
out_uÆock
;

796 } ià(
be
->
num_»fs
 == 0) {

797 
	`bŒfs_”r
(
fs_šfo
,

799 
aùiÚ
);

800 
	`dump_block_’Œy
(
fs_šfo
, 
be
);

801 
	`dump_»f_aùiÚ
(
fs_šfo
, 
¿
);

802 
	`kä“
(
»f
);

803 
	`kä“
(
¿
);

804 
	`kä“
(
»
);

805 
out_uÆock
;

808 ià(!
·»Á
) {

809 
tmp
 = 
	`š£¹_roÙ_’Œy
(&
be
->
roÙs
, 
»
);

810 ià(
tmp
) {

811 
	`kä“
(
»
);

812 
»
 = 
tmp
;

817 
exi¡
 = 
	`š£¹_»f_’Œy
(&
be
->
»fs
, 
»f
);

818 ià(
exi¡
) {

819 ià(
aùiÚ
 =ğ
BTRFS_DROP_DELAYED_REF
) {

820 ià(
exi¡
->
num_»fs
 == 0) {

821 
	`bŒfs_”r
(
fs_šfo
,

823 
	`dump_block_’Œy
(
fs_šfo
, 
be
);

824 
	`dump_»f_aùiÚ
(
fs_šfo
, 
¿
);

825 
	`kä“
(
»f
);

826 
	`kä“
(
¿
);

827 
out_uÆock
;

829 
exi¡
->
num_»fs
--;

830 ià(
exi¡
->
num_»fs
 == 0) {

831 
	`rb_”a£
(&
exi¡
->
node
, &
be
->
»fs
);

832 
	`kä“
(
exi¡
);

834 } ià(!
be
->
m‘ad©a
) {

835 
exi¡
->
num_»fs
++;

837 
	`bŒfs_”r
(
fs_šfo
,

839 
	`dump_block_’Œy
(
fs_šfo
, 
be
);

840 
	`dump_»f_aùiÚ
(
fs_šfo
, 
¿
);

841 
	`kä“
(
»f
);

842 
	`kä“
(
¿
);

843 
out_uÆock
;

845 
	`kä“
(
»f
);

847 ià(
aùiÚ
 =ğ
BTRFS_DROP_DELAYED_REF
) {

848 
	`bŒfs_”r
(
fs_šfo
,

850 
	`dump_block_’Œy
(
fs_šfo
, 
be
);

851 
	`dump_»f_aùiÚ
(
fs_šfo
, 
¿
);

852 
	`kä“
(
»f
);

853 
	`kä“
(
¿
);

854 
out_uÆock
;

858 ià(!
·»Á
 && !
»
) {

859 
»
 = 
	`lookup_roÙ_’Œy
(&
be
->
roÙs
, 
»f_roÙ
);

860 ià(!
»
) {

867 
	`bŒfs_”r
(
fs_šfo
, "failedo find„oot %llu for %llu",

868 
g’”ic_»f
->
»®_roÙ
, 
be
->
by‹Ä
);

869 
	`dump_block_’Œy
(
fs_šfo
, 
be
);

870 
	`dump_»f_aùiÚ
(
fs_šfo
, 
¿
);

871 
	`kä“
(
¿
);

872 
out_uÆock
;

875 ià(
aùiÚ
 =ğ
BTRFS_DROP_DELAYED_REF
) {

876 ià(
»
)

877 
»
->
num_»fs
--;

878 
be
->
num_»fs
--;

879 } ià(
aùiÚ
 =ğ
BTRFS_ADD_DELAYED_REF
) {

880 
be
->
num_»fs
++;

881 ià(
»
)

882 
»
->
num_»fs
++;

884 
	`li¡_add_
(&
¿
->
li¡
, &
be
->
aùiÚs
);

885 
»t
 = 0;

886 
out_uÆock
:

887 
	`¥š_uÆock
(&
fs_šfo
->
»f_v”ify_lock
);

888 
out
:

889 ià(
»t
)

890 
	`bŒfs_ş—r_İt
(
fs_šfo
->
mouÁ_İt
, 
REF_VERIFY
);

891  
»t
;

892 
	}
}

895 
	$bŒfs_ä“_»f_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
)

897 
block_’Œy
 *
be
;

898 
rb_node
 *
n
;

900 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
REF_VERIFY
))

903 
	`¥š_lock
(&
fs_šfo
->
»f_v”ify_lock
);

904 (
n
 = 
	`rb_fœ¡
(&
fs_šfo
->
block_Œ“
))) {

905 
be
 = 
	`rb_’Œy
(
n
, 
block_’Œy
, 
node
);

906 
	`rb_”a£
(&
be
->
node
, &
fs_šfo
->
block_Œ“
);

907 
	`ä“_block_’Œy
(
be
);

908 
	`cÚd_»sched_lock
(&
fs_šfo
->
»f_v”ify_lock
);

910 
	`¥š_uÆock
(&
fs_šfo
->
»f_v”ify_lock
);

911 
	}
}

913 
	$bŒfs_ä“_»f_Œ“_¿nge
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
,

914 
u64
 
Ën
)

916 
block_’Œy
 *
be
 = 
NULL
, *
’Œy
;

917 
rb_node
 *
n
;

919 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
REF_VERIFY
))

922 
	`¥š_lock
(&
fs_šfo
->
»f_v”ify_lock
);

923 
n
 = 
fs_šfo
->
block_Œ“
.
rb_node
;

924 
n
) {

925 
’Œy
 = 
	`rb_’Œy
(
n
, 
block_’Œy
, 
node
);

926 ià(
’Œy
->
by‹Ä
 < 
¡¬t
) {

927 
n
 =‚->
rb_right
;

928 } ià(
’Œy
->
by‹Ä
 > 
¡¬t
) {

929 
n
 =‚->
rb_Ëá
;

931 
be
 = 
’Œy
;

935 ià(
be
 =ğ
NULL
 ||

936 (
’Œy
->
by‹Ä
 < 
¡¬t
 && 
be
->bytenr > start) ||

937 (
’Œy
->
by‹Ä
 < 
¡¬t
 &&ƒÁry->by‹Ä > 
be
->bytenr))

938 
be
 = 
’Œy
;

945 ià(!
be
) {

946 
	`¥š_uÆock
(&
fs_šfo
->
»f_v”ify_lock
);

950 
n
 = &
be
->
node
;

951 
n
) {

952 
be
 = 
	`rb_’Œy
(
n
, 
block_’Œy
, 
node
);

953 
n
 = 
	`rb_Ãxt
(n);

954 ià(
be
->
by‹Ä
 < 
¡¬t
 && be->by‹Ä + be->
Ën
 > start) {

955 
	`bŒfs_”r
(
fs_šfo
,

957 
¡¬t
, 
Ën
);

958 
	`dump_block_’Œy
(
fs_šfo
, 
be
);

961 ià(
be
->
by‹Ä
 < 
¡¬t
)

963 ià(
be
->
by‹Ä
 >ğ
¡¬t
 + 
Ën
)

965 ià(
be
->
by‹Ä
 + be->
Ën
 > 
¡¬t
 +†en) {

966 
	`bŒfs_”r
(
fs_šfo
,

968 
¡¬t
, 
Ën
);

969 
	`dump_block_’Œy
(
fs_šfo
, 
be
);

971 
	`rb_”a£
(&
be
->
node
, &
fs_šfo
->
block_Œ“
);

972 
	`ä“_block_’Œy
(
be
);

974 
	`¥š_uÆock
(&
fs_šfo
->
»f_v”ify_lock
);

975 
	}
}

978 
	$bŒfs_bud_»f_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
)

980 
bŒfs_roÙ
 *
ex‹Á_roÙ
;

981 
bŒfs_·th
 *
·th
;

982 
ex‹Á_bufãr
 *
eb
;

983 
Œ“_block_Ëv–
 = 0;

984 
u64
 
by‹Ä
 = 0, 
num_by‹s
 = 0;

985 
»t
, 
Ëv–
;

987 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
REF_VERIFY
))

990 
·th
 = 
	`bŒfs_®loc_·th
();

991 ià(!
·th
)

992  -
ENOMEM
;

994 
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 0);

995 
eb
 = 
	`bŒfs_»ad_lock_roÙ_node
(
ex‹Á_roÙ
);

996 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
eb
);

997 
·th
->
nodes
[
Ëv–
] = 
eb
;

998 
·th
->
¦Ùs
[
Ëv–
] = 0;

999 
·th
->
locks
[
Ëv–
] = 
BTRFS_READ_LOCK
;

1008 
»t
 = 
	`w®k_down_Œ“
(
ex‹Á_roÙ
, 
·th
, 
Ëv–
,

1009 &
by‹Ä
, &
num_by‹s
, &
Œ“_block_Ëv–
);

1010 ià(
»t
)

1012 
»t
 = 
	`w®k_up_Œ“
(
·th
, &
Ëv–
);

1013 ià(
»t
 < 0)

1015 ià(
»t
 > 0) {

1016 
»t
 = 0;

1020 ià(
»t
) {

1021 
	`bŒfs_ş—r_İt
(
fs_šfo
->
mouÁ_İt
, 
REF_VERIFY
);

1022 
	`bŒfs_ä“_»f_ÿche
(
fs_šfo
);

1024 
	`bŒfs_ä“_·th
(
·th
);

1025  
»t
;

1026 
	}
}

	@ref-verify.h

6 #iâdeà
BTRFS_REF_VERIFY_H


7 
	#BTRFS_REF_VERIFY_H


	)

9 #ifdeà
CONFIG_BTRFS_FS_REF_VERIFY


10 
bŒfs_bud_»f_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
);

11 
bŒfs_ä“_»f_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
);

12 
bŒfs_»f_Œ“_mod
(
bŒfs_fs_šfo
 *
fs_šfo
,

13 
bŒfs_»f
 *
g’”ic_»f
);

14 
bŒfs_ä“_»f_Œ“_¿nge
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
,

15 
u64
 
Ën
);

17 
šlše
 
	$bŒfs_š™_»f_v”ify
(
bŒfs_fs_šfo
 *
fs_šfo
)

19 
	`¥š_lock_š™
(&
fs_šfo
->
»f_v”ify_lock
);

20 
fs_šfo
->
block_Œ“
 = 
RB_ROOT
;

21 
	}
}

23 
šlše
 
	$bŒfs_bud_»f_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
)

26 
	}
}

28 
šlše
 
	$bŒfs_ä“_»f_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
)

30 
	}
}

32 
šlše
 
	$bŒfs_»f_Œ“_mod
(
bŒfs_fs_šfo
 *
fs_šfo
,

33 
bŒfs_»f
 *
g’”ic_»f
)

36 
	}
}

38 
šlše
 
	$bŒfs_ä“_»f_Œ“_¿nge
(
bŒfs_fs_šfo
 *
fs_šfo
,

39 
u64
 
¡¬t
, u64 
Ën
)

41 
	}
}

43 
šlše
 
	$bŒfs_š™_»f_v”ify
(
bŒfs_fs_šfo
 *
fs_šfo
)

45 
	}
}

	@reflink.c

3 
	~<lšux/blkdev.h
>

4 
	~<lšux/iv”siÚ.h
>

5 
	~"ù»e.h
"

6 
	~"fs.h
"

7 
	~"mes§ges.h
"

8 
	~"com´essiÚ.h
"

9 
	~"d–®loc-¥aû.h
"

10 
	~"disk-io.h
"

11 
	~"»æšk.h
"

12 
	~"Œª§ùiÚ.h
"

13 
	~"sub·ge.h
"

14 
	~"acûssÜs.h
"

15 
	~"fe-™em.h
"

16 
	~"fe.h
"

17 
	~"su³r.h
"

19 
	#BTRFS_MAX_DEDUPE_LEN
 
SZ_16M


	)

21 
	$şÚe_fšish_šode_upd©e
(
bŒfs_Œªs_hªdË
 *
Œªs
,

22 
šode
 *inode,

23 
u64
 
’doff
,

24 cÚ¡ 
u64
 
de¡off
,

25 cÚ¡ 
u64
 
Ş’
,

26 
no_time_upd©e
)

28 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

29 
»t
;

31 
	`šode_šc_iv”siÚ
(
šode
);

32 ià(!
no_time_upd©e
) {

33 
šode
->
i_mtime
 = 
	`šode_£t_ùime_cu¼’t
(inode);

39 ià(
’doff
 > 
de¡off
 + 
Ş’
)

40 
’doff
 = 
de¡off
 + 
Ş’
;

41 ià(
’doff
 > 
šode
->
i_size
) {

42 
	`i_size_wr™e
(
šode
, 
’doff
);

43 
	`bŒfs_šode_§ã_disk_i_size_wr™e
(
	`BTRFS_I
(
šode
), 0);

46 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

47 ià(
»t
) {

48 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

49 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

50 
out
;

52 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

53 
out
:

54  
»t
;

55 
	}
}

57 
	$cİy_šlše_to_·ge
(
bŒfs_šode
 *
šode
,

58 cÚ¡ 
u64
 
fe_off£t
,

59 *
šlše_d©a
,

60 cÚ¡ 
u64
 
size
,

61 cÚ¡ 
u64
 
d©®
,

62 cÚ¡ 
u8
 
comp_ty³
)

64 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

65 cÚ¡ 
u32
 
block_size
 = 
fs_šfo
->
£ùÜsize
;

66 cÚ¡ 
u64
 
¿nge_’d
 = 
fe_off£t
 + 
block_size
 - 1;

67 cÚ¡ 
size_t
 
šlše_size
 = 
size
 - 
	`bŒfs_fe_ex‹Á_ÿlc_šlše_size
(0);

68 *
d©a_¡¬t
 = 
šlše_d©a
 + 
	`bŒfs_fe_ex‹Á_ÿlc_šlše_size
(0);

69 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

70 
·ge
 *·gğ
NULL
;

71 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
vfs_šode
.
i_m­pšg
;

72 
»t
;

74 
	`ASSERT
(
	`IS_ALIGNED
(
fe_off£t
, 
block_size
));

82 
»t
 = 
	`bŒfs_d–®loc_»£rve_¥aû
(
šode
, &
d©a_»£rved
, 
fe_off£t
,

83 
block_size
);

84 ià(
»t
)

85 
out
;

87 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
m­pšg
, 
fe_off£t
 >> 
PAGE_SHIFT
,

88 
	`bŒfs_®loc_wr™e_mask
(
m­pšg
));

89 ià(!
·ge
) {

90 
»t
 = -
ENOMEM
;

91 
out_uÆock
;

94 
»t
 = 
	`£t_·ge_ex‹Á_m­³d
(
·ge
);

95 ià(
»t
 < 0)

96 
out_uÆock
;

98 
	`ş—r_ex‹Á_b™
(&
šode
->
io_Œ“
, 
fe_off£t
, 
¿nge_’d
,

99 
EXTENT_DELALLOC
 | 
EXTENT_DO_ACCOUNTING
 | 
EXTENT_DEFRAG
,

100 
NULL
);

101 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
šode
, 
fe_off£t
, 
¿nge_’d
, 0, 
NULL
);

102 ià(
»t
)

103 
out_uÆock
;

116 
	`£t_b™
(
BTRFS_INODE_NO_DELALLOC_FLUSH
, &
šode
->
ruÁime_æags
);

118 ià(
comp_ty³
 =ğ
BTRFS_COMPRESS_NONE
) {

119 
	`memıy_to_·ge
(
·ge
, 
	`off£t_š_·ge
(
fe_off£t
), 
d©a_¡¬t
,

120 
d©®
);

122 
»t
 = 
	`bŒfs_decom´ess
(
comp_ty³
, 
d©a_¡¬t
, 
·ge
,

123 
	`off£t_š_·ge
(
fe_off£t
),

124 
šlše_size
, 
d©®
);

125 ià(
»t
)

126 
out_uÆock
;

127 
	`æush_dÿche_·ge
(
·ge
);

142 ià(
d©®
 < 
block_size
)

143 
	`memz”o_·ge
(
·ge
, 
d©®
, 
block_size
 - datal);

145 
	`bŒfs_·ge_£t_u±od©e
(
fs_šfo
, 
·ge
, 
fe_off£t
, 
block_size
);

146 
	`bŒfs_·ge_ş—r_checked
(
fs_šfo
, 
·ge
, 
fe_off£t
, 
block_size
);

147 
	`bŒfs_·ge_£t_dœty
(
fs_šfo
, 
·ge
, 
fe_off£t
, 
block_size
);

148 
out_uÆock
:

149 ià(
·ge
) {

150 
	`uÆock_·ge
(
·ge
);

151 
	`put_·ge
(
·ge
);

153 ià(
»t
)

154 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
šode
, 
d©a_»£rved
, 
fe_off£t
,

155 
block_size
, 
Œue
);

156 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
šode
, 
block_size
);

157 
out
:

158 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

160  
»t
;

161 
	}
}

168 
	$şÚe_cİy_šlše_ex‹Á
(
šode
 *
d¡
,

169 
bŒfs_·th
 *
·th
,

170 
bŒfs_key
 *
Ãw_key
,

171 cÚ¡ 
u64
 
drİ_¡¬t
,

172 cÚ¡ 
u64
 
d©®
,

173 cÚ¡ 
u64
 
size
,

174 cÚ¡ 
u8
 
comp_ty³
,

175 *
šlše_d©a
,

176 
bŒfs_Œªs_hªdË
 **
Œªs_out
)

178 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
d¡
->
i_sb
);

179 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
d¡
)->root;

180 cÚ¡ 
u64
 
®igÃd_’d
 = 
	`ALIGN
(
Ãw_key
->
off£t
 + 
d©®
,

181 
fs_šfo
->
£ùÜsize
);

182 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

183 
bŒfs_drİ_ex‹Ás_¬gs
 
drİ_¬gs
 = { 0 };

184 
»t
;

185 
bŒfs_key
 
key
;

187 ià(
Ãw_key
->
off£t
 > 0) {

188 
»t
 = 
	`cİy_šlše_to_·ge
(
	`BTRFS_I
(
d¡
), 
Ãw_key
->
off£t
,

189 
šlše_d©a
, 
size
, 
d©®
, 
comp_ty³
);

190 
out
;

193 
key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
d¡
));

194 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

195 
key
.
off£t
 = 0;

196 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

197 ià(
»t
 < 0) {

198  
»t
;

199 } ià(
»t
 > 0) {

200 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0])) {

201 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

202 ià(
»t
 < 0)

203  
»t
;

204 ià(
»t
 > 0)

205 
cİy_šlše_ex‹Á
;

207 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

208 ià(
key
.
objeùid
 =ğ
	`bŒfs_šo
(
	`BTRFS_I
(
d¡
)) &&

209 
key
.
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
) {

214 
	`ASSERT
(
key
.
off£t
 > 0);

215 
cİy_to_·ge
;

217 } ià(
	`i_size_»ad
(
d¡
è<ğ
d©®
) {

218 
bŒfs_fe_ex‹Á_™em
 *
ei
;

220 
ei
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

221 
bŒfs_fe_ex‹Á_™em
);

227 ià(
	`bŒfs_fe_ex‹Á_ty³
(
·th
->
nodes
[0], 
ei
) ==

228 
BTRFS_FILE_EXTENT_INLINE
)

229 
cİy_šlše_ex‹Á
;

231 
cİy_to_·ge
;

234 
cİy_šlše_ex‹Á
:

239 ià(
	`i_size_»ad
(
d¡
è> 
d©®
) {

246 
cİy_to_·ge
;

253 
	`bŒfs_»Ëa£_·th
(
·th
);

263 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 3);

264 ià(
	`IS_ERR
(
Œªs
)) {

265 
»t
 = 
	`PTR_ERR
(
Œªs
);

266 
Œªs
 = 
NULL
;

267 
out
;

269 
drİ_¬gs
.
·th
 =…ath;

270 
drİ_¬gs
.
¡¬t
 = 
drİ_¡¬t
;

271 
drİ_¬gs
.
’d
 = 
®igÃd_’d
;

272 
drİ_¬gs
.
drİ_ÿche
 = 
Œue
;

273 
»t
 = 
	`bŒfs_drİ_ex‹Ás
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
d¡
), &
drİ_¬gs
);

274 ià(
»t
)

275 
out
;

276 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, 
Ãw_key
, 
size
);

277 ià(
»t
)

278 
out
;

280 
	`wr™e_ex‹Á_bufãr
(
·th
->
nodes
[0], 
šlše_d©a
,

281 
	`bŒfs_™em_±r_off£t
(
·th
->
nodes
[0],

282 
·th
->
¦Ùs
[0]),

283 
size
);

284 
	`bŒfs_upd©e_šode_by‹s
(
	`BTRFS_I
(
d¡
), 
d©®
, 
drİ_¬gs
.
by‹s_found
);

285 
	`bŒfs_£t_šode_fuÎ_sync
(
	`BTRFS_I
(
d¡
));

286 
»t
 = 
	`bŒfs_šode_£t_fe_ex‹Á_¿nge
(
	`BTRFS_I
(
d¡
), 0, 
®igÃd_’d
);

287 
out
:

288 ià(!
»t
 && !
Œªs
) {

295 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

296 ià(
	`IS_ERR
(
Œªs
)) {

297 
»t
 = 
	`PTR_ERR
(
Œªs
);

298 
Œªs
 = 
NULL
;

301 ià(
»t
 && 
Œªs
) {

302 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

303 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

305 ià(!
»t
)

306 *
Œªs_out
 = 
Œªs
;

308  
»t
;

310 
cİy_to_·ge
:

319 
	`bŒfs_»Ëa£_·th
(
·th
);

321 
»t
 = 
	`cİy_šlše_to_·ge
(
	`BTRFS_I
(
d¡
), 
Ãw_key
->
off£t
,

322 
šlše_d©a
, 
size
, 
d©®
, 
comp_ty³
);

323 
out
;

324 
	}
}

337 
	$bŒfs_şÚe
(
šode
 *
¤c
, inode *inode,

338 cÚ¡ 
u64
 
off
, cÚ¡ u64 
Ş’
, cÚ¡ u64 
Ş’_®igÃd
,

339 cÚ¡ 
u64
 
de¡off
, 
no_time_upd©e
)

341 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

342 
bŒfs_·th
 *
·th
 = 
NULL
;

343 
ex‹Á_bufãr
 *
Ëaf
;

344 
bŒfs_Œªs_hªdË
 *
Œªs
;

345 *
buf
 = 
NULL
;

346 
bŒfs_key
 
key
;

347 
u32
 
Ä™ems
;

348 
¦Ù
;

349 
»t
;

350 cÚ¡ 
u64
 
Ën
 = 
Ş’_®igÃd
;

351 
u64
 
Ï¡_de¡_’d
 = 
de¡off
;

352 
u64
 
´ev_ex‹Á_’d
 = 
off
;

354 
»t
 = -
ENOMEM
;

355 
buf
 = 
	`kvm®loc
(
fs_šfo
->
nodesize
, 
GFP_KERNEL
);

356 ià(!
buf
)

357  
»t
;

359 
·th
 = 
	`bŒfs_®loc_·th
();

360 ià(!
·th
) {

361 
	`kvä“
(
buf
);

362  
»t
;

365 
·th
->
»ada
 = 
READA_FORWARD
;

367 
key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
¤c
));

368 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

369 
key
.
off£t
 = 
off
;

372 
bŒfs_fe_ex‹Á_™em
 *
ex‹Á
;

373 
u64
 
ex‹Á_g’
;

374 
ty³
;

375 
u32
 
size
;

376 
bŒfs_key
 
Ãw_key
;

377 
u64
 
disko
 = 0, 
diskl
 = 0;

378 
u64
 
d©ao
 = 0, 
d©®
 = 0;

379 
u8
 
comp
;

380 
u64
 
drİ_¡¬t
;

383 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
	`BTRFS_I
(
¤c
)->
roÙ
, &
key
, 
·th
,

385 ià(
»t
 < 0)

386 
out
;

392 ià(
key
.
off£t
 =ğ
off
 && 
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0) {

393 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,

394 
·th
->
¦Ùs
[0] - 1);

395 ià(
key
.
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
)

396 
·th
->
¦Ùs
[0]--;

399 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

400 
´oûss_¦Ù
:

401 ià(
·th
->
¦Ùs
[0] >ğ
Ä™ems
) {

402 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
	`BTRFS_I
(
¤c
)->
roÙ
, 
·th
);

403 ià(
»t
 < 0)

404 
out
;

405 ià(
»t
 > 0)

407 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

409 
Ëaf
 = 
·th
->
nodes
[0];

410 
¦Ù
 = 
·th
->
¦Ùs
[0];

412 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

413 ià(
key
.
ty³
 > 
BTRFS_EXTENT_DATA_KEY
 ||

414 
key
.
objeùid
 !ğ
	`bŒfs_šo
(
	`BTRFS_I
(
¤c
)))

417 
	`ASSERT
(
key
.
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
);

419 
ex‹Á
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
,

420 
bŒfs_fe_ex‹Á_™em
);

421 
ex‹Á_g’
 = 
	`bŒfs_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
ex‹Á
);

422 
comp
 = 
	`bŒfs_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
ex‹Á
);

423 
ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
ex‹Á
);

424 ià(
ty³
 =ğ
BTRFS_FILE_EXTENT_REG
 ||

425 
ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
) {

426 
disko
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
ex‹Á
);

427 
diskl
 = 
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
Ëaf
, 
ex‹Á
);

428 
d©ao
 = 
	`bŒfs_fe_ex‹Á_off£t
(
Ëaf
, 
ex‹Á
);

429 
d©®
 = 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
ex‹Á
);

430 } ià(
ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
) {

432 
d©®
 = 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
ex‹Á
);

446 ià(
key
.
off£t
 + 
d©®
 <ğ
´ev_ex‹Á_’d
) {

447 
·th
->
¦Ùs
[0]++;

448 
´oûss_¦Ù
;

449 } ià(
key
.
off£t
 >ğ
off
 + 
Ën
) {

453 
´ev_ex‹Á_’d
 = 
key
.
off£t
 + 
d©®
;

454 
size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

455 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
buf
, 
	`bŒfs_™em_±r_off£t
Ö—f, 
¦Ù
),

456 
size
);

458 
	`bŒfs_»Ëa£_·th
(
·th
);

460 
	`memıy
(&
Ãw_key
, &
key
, (new_key));

461 
Ãw_key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

462 ià(
off
 <ğ
key
.
off£t
)

463 
Ãw_key
.
off£t
 = 
key
.off£ˆ+ 
de¡off
 - 
off
;

465 
Ãw_key
.
off£t
 = 
de¡off
;

473 ià(
Ãw_key
.
off£t
 !ğ
Ï¡_de¡_’d
)

474 
drİ_¡¬t
 = 
Ï¡_de¡_’d
;

476 
drİ_¡¬t
 = 
Ãw_key
.
off£t
;

478 ià(
ty³
 =ğ
BTRFS_FILE_EXTENT_REG
 ||

479 
ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
) {

480 
bŒfs_»¶aû_ex‹Á_šfo
 
şÚe_šfo
;

488 ià(
key
.
off£t
 + 
d©®
 > 
off
 + 
Ën
)

489 
d©®
 = 
off
 + 
Ën
 - 
key
.
off£t
;

492 ià(
off
 > 
key
.
off£t
) {

493 
d©ao
 +ğ
off
 - 
key
.
off£t
;

494 
d©®
 -ğ
off
 - 
key
.
off£t
;

497 
şÚe_šfo
.
disk_off£t
 = 
disko
;

498 
şÚe_šfo
.
disk_Ën
 = 
diskl
;

499 
şÚe_šfo
.
d©a_off£t
 = 
d©ao
;

500 
şÚe_šfo
.
d©a_Ën
 = 
d©®
;

501 
şÚe_šfo
.
fe_off£t
 = 
Ãw_key
.
off£t
;

502 
şÚe_šfo
.
ex‹Á_buf
 = 
buf
;

503 
şÚe_šfo
.
is_Ãw_ex‹Á
 = 
çl£
;

504 
şÚe_šfo
.
upd©e_times
 = !
no_time_upd©e
;

505 
»t
 = 
	`bŒfs_»¶aû_fe_ex‹Ás
(
	`BTRFS_I
(
šode
), 
·th
,

506 
drİ_¡¬t
, 
Ãw_key
.
off£t
 + 
d©®
 - 1,

507 &
şÚe_šfo
, &
Œªs
);

508 ià(
»t
)

509 
out
;

511 
	`ASSERT
(
ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
);

520 
	`ASSERT
(
key
.
off£t
 == 0);

521 
	`ASSERT
(
d©®
 <ğ
fs_šfo
->
£ùÜsize
);

522 ià(
	`WARN_ON
(
ty³
 !ğ
BTRFS_FILE_EXTENT_INLINE
) ||

523 
	`WARN_ON
(
key
.
off£t
 != 0) ||

524 
	`WARN_ON
(
d©®
 > 
fs_šfo
->
£ùÜsize
)) {

525 
»t
 = -
EUCLEAN
;

526 
out
;

529 
»t
 = 
	`şÚe_cİy_šlše_ex‹Á
(
šode
, 
·th
, &
Ãw_key
,

530 
drİ_¡¬t
, 
d©®
, 
size
,

531 
comp
, 
buf
, &
Œªs
);

532 ià(
»t
)

533 
out
;

536 
	`bŒfs_»Ëa£_·th
(
·th
);

551 ià(
ex‹Á_g’
 =ğ
Œªs
->
Œªsid
 && 
disko
 > 0)

552 
	`BTRFS_I
(
¤c
)->
Ï¡_»æšk_Œªs
 = 
Œªs
->
Œªsid
;

554 
	`BTRFS_I
(
šode
)->
Ï¡_»æšk_Œªs
 = 
Œªs
->
Œªsid
;

556 
Ï¡_de¡_’d
 = 
	`ALIGN
(
Ãw_key
.
off£t
 + 
d©®
,

557 
fs_šfo
->
£ùÜsize
);

558 
»t
 = 
	`şÚe_fšish_šode_upd©e
(
Œªs
, 
šode
, 
Ï¡_de¡_’d
,

559 
de¡off
, 
Ş’
, 
no_time_upd©e
);

560 ià(
»t
)

561 
out
;

562 ià(
Ãw_key
.
off£t
 + 
d©®
 >ğ
de¡off
 + 
Ën
)

565 
	`bŒfs_»Ëa£_·th
(
·th
);

566 
key
.
off£t
 = 
´ev_ex‹Á_’d
;

568 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

569 
»t
 = -
EINTR
;

570 
out
;

573 
	`cÚd_»sched
();

575 
»t
 = 0;

577 ià(
Ï¡_de¡_’d
 < 
de¡off
 + 
Ën
) {

584 
	`bŒfs_»Ëa£_·th
(
·th
);

600 ià(
Ï¡_de¡_’d
 >ğ
	`i_size_»ad
(
šode
))

601 
	`bŒfs_£t_šode_fuÎ_sync
(
	`BTRFS_I
(
šode
));

603 
»t
 = 
	`bŒfs_»¶aû_fe_ex‹Ás
(
	`BTRFS_I
(
šode
), 
·th
,

604 
Ï¡_de¡_’d
, 
de¡off
 + 
Ën
 - 1, 
NULL
, &
Œªs
);

605 ià(
»t
)

606 
out
;

608 
»t
 = 
	`şÚe_fšish_šode_upd©e
(
Œªs
, 
šode
, 
de¡off
 + 
Ën
,

609 
de¡off
, 
Ş’
, 
no_time_upd©e
);

612 
out
:

613 
	`bŒfs_ä“_·th
(
·th
);

614 
	`kvä“
(
buf
);

615 
	`ş—r_b™
(
BTRFS_INODE_NO_DELALLOC_FLUSH
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

617  
»t
;

618 
	}
}

620 
	$bŒfs_doubË_ex‹Á_uÆock
(
šode
 *
šode1
, 
u64
 
loff1
,

621 
šode
 *
šode2
, 
u64
 
loff2
, u64 
Ën
)

623 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode1
)->
io_Œ“
, 
loff1
,†off1 + 
Ën
 - 1, 
NULL
);

624 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode2
)->
io_Œ“
, 
loff2
,†off2 + 
Ën
 - 1, 
NULL
);

625 
	}
}

627 
	$bŒfs_doubË_ex‹Á_lock
(
šode
 *
šode1
, 
u64
 
loff1
,

628 
šode
 *
šode2
, 
u64
 
loff2
, u64 
Ën
)

630 
u64
 
¿nge1_’d
 = 
loff1
 + 
Ën
 - 1;

631 
u64
 
¿nge2_’d
 = 
loff2
 + 
Ën
 - 1;

633 ià(
šode1
 < 
šode2
) {

634 
	`sw­
(
šode1
, 
šode2
);

635 
	`sw­
(
loff1
, 
loff2
);

636 
	`sw­
(
¿nge1_’d
, 
¿nge2_’d
);

637 } ià(
šode1
 =ğ
šode2
 && 
loff2
 < 
loff1
) {

638 
	`sw­
(
loff1
, 
loff2
);

639 
	`sw­
(
¿nge1_’d
, 
¿nge2_’d
);

642 
	`lock_ex‹Á
(&
	`BTRFS_I
(
šode1
)->
io_Œ“
, 
loff1
, 
¿nge1_’d
, 
NULL
);

643 
	`lock_ex‹Á
(&
	`BTRFS_I
(
šode2
)->
io_Œ“
, 
loff2
, 
¿nge2_’d
, 
NULL
);

645 
	`bŒfs_as£¹_šode_¿nge_ş—n
(
	`BTRFS_I
(
šode1
), 
loff1
, 
¿nge1_’d
);

646 
	`bŒfs_as£¹_šode_¿nge_ş—n
(
	`BTRFS_I
(
šode2
), 
loff2
, 
¿nge2_’d
);

647 
	}
}

649 
	$bŒfs_doubË_mm­_lock
(
šode
 *
šode1
, šod*
šode2
)

651 ià(
šode1
 < 
šode2
)

652 
	`sw­
(
šode1
, 
šode2
);

653 
	`down_wr™e
(&
	`BTRFS_I
(
šode1
)->
i_mm­_lock
);

654 
	`down_wr™e_Ã¡ed
(&
	`BTRFS_I
(
šode2
)->
i_mm­_lock
, 
SINGLE_DEPTH_NESTING
);

655 
	}
}

657 
	$bŒfs_doubË_mm­_uÆock
(
šode
 *
šode1
, šod*
šode2
)

659 
	`up_wr™e
(&
	`BTRFS_I
(
šode1
)->
i_mm­_lock
);

660 
	`up_wr™e
(&
	`BTRFS_I
(
šode2
)->
i_mm­_lock
);

661 
	}
}

663 
	$bŒfs_ex‹Á_§me_¿nge
(
šode
 *
¤c
, 
u64
 
loff
, u64 
Ën
,

664 
šode
 *
d¡
, 
u64
 
d¡_loff
)

666 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`BTRFS_I
(
¤c
)->
roÙ
->fs_info;

667 cÚ¡ 
u64
 
bs
 = 
fs_šfo
->
sb
->
s_blocksize
;

668 
»t
;

674 
	`bŒfs_doubË_ex‹Á_lock
(
¤c
, 
loff
, 
d¡
, 
d¡_loff
, 
Ën
);

675 
»t
 = 
	`bŒfs_şÚe
(
¤c
, 
d¡
, 
loff
, 
Ën
, 
	`ALIGN
Ö’, 
bs
), 
d¡_loff
, 1);

676 
	`bŒfs_doubË_ex‹Á_uÆock
(
¤c
, 
loff
, 
d¡
, 
d¡_loff
, 
Ën
);

678 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

680  
»t
;

681 
	}
}

683 
	$bŒfs_ex‹Á_§me
(
šode
 *
¤c
, 
u64
 
loff
, u64 
Ş’
,

684 
šode
 *
d¡
, 
u64
 
d¡_loff
)

686 
»t
 = 0;

687 
u64
 
i
, 
_Ën
, 
chunk_couÁ
;

688 
bŒfs_roÙ
 *
roÙ_d¡
 = 
	`BTRFS_I
(
d¡
)->
roÙ
;

690 
	`¥š_lock
(&
roÙ_d¡
->
roÙ_™em_lock
);

691 ià(
roÙ_d¡
->
£nd_š_´og»ss
) {

692 
	`bŒfs_w¬n_¾
(
roÙ_d¡
->
fs_šfo
,

694 
roÙ_d¡
->
roÙ_key
.
objeùid
,

695 
roÙ_d¡
->
£nd_š_´og»ss
);

696 
	`¥š_uÆock
(&
roÙ_d¡
->
roÙ_™em_lock
);

697  -
EAGAIN
;

699 
roÙ_d¡
->
dedu³_š_´og»ss
++;

700 
	`¥š_uÆock
(&
roÙ_d¡
->
roÙ_™em_lock
);

702 
_Ën
 = 
Ş’
 % 
BTRFS_MAX_DEDUPE_LEN
;

703 
chunk_couÁ
 = 
	`div_u64
(
Ş’
, 
BTRFS_MAX_DEDUPE_LEN
);

705 
i
 = 0; i < 
chunk_couÁ
; i++) {

706 
»t
 = 
	`bŒfs_ex‹Á_§me_¿nge
(
¤c
, 
loff
, 
BTRFS_MAX_DEDUPE_LEN
,

707 
d¡
, 
d¡_loff
);

708 ià(
»t
)

709 
out
;

711 
loff
 +ğ
BTRFS_MAX_DEDUPE_LEN
;

712 
d¡_loff
 +ğ
BTRFS_MAX_DEDUPE_LEN
;

715 ià(
_Ën
 > 0)

716 
»t
 = 
	`bŒfs_ex‹Á_§me_¿nge
(
¤c
, 
loff
, 
_Ën
, 
d¡
, 
d¡_loff
);

717 
out
:

718 
	`¥š_lock
(&
roÙ_d¡
->
roÙ_™em_lock
);

719 
roÙ_d¡
->
dedu³_š_´og»ss
--;

720 
	`¥š_uÆock
(&
roÙ_d¡
->
roÙ_™em_lock
);

722  
»t
;

723 
	}
}

725 
nošlše
 
	$bŒfs_şÚe_fes
(
fe
 *fe, f*
fe_¤c
,

726 
u64
 
off
, u64 
Ş’
, u64 
de¡off
)

728 
šode
 *šodğ
	`fe_šode
(
fe
);

729 
šode
 *
¤c
 = 
	`fe_šode
(
fe_¤c
);

730 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

731 
»t
;

732 
wb_»t
;

733 
u64
 
Ën
 = 
Ş’
;

734 
u64
 
bs
 = 
fs_šfo
->
sb
->
s_blocksize
;

742 ià(
off
 + 
Ën
 =ğ
¤c
->
i_size
)

743 
Ën
 = 
	`ALIGN
(
¤c
->
i_size
, 
bs
è- 
off
;

745 ià(
de¡off
 > 
šode
->
i_size
) {

746 cÚ¡ 
u64
 
wb_¡¬t
 = 
	`ALIGN_DOWN
(
šode
->
i_size
, 
bs
);

748 
»t
 = 
	`bŒfs_cÚt_ex·nd
(
	`BTRFS_I
(
šode
), inode->
i_size
, 
de¡off
);

749 ià(
»t
)

750  
»t
;

760 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 
wb_¡¬t
,

761 
de¡off
 - 
wb_¡¬t
);

762 ià(
»t
)

763  
»t
;

770 
	`bŒfs_doubË_ex‹Á_lock
(
¤c
, 
off
, 
šode
, 
de¡off
, 
Ën
);

771 
»t
 = 
	`bŒfs_şÚe
(
¤c
, 
šode
, 
off
, 
Ş’
, 
Ën
, 
de¡off
, 0);

772 
	`bŒfs_doubË_ex‹Á_uÆock
(
¤c
, 
off
, 
šode
, 
de¡off
, 
Ën
);

779 
wb_»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 
de¡off
, 
Ën
);

780 
»t
 =„‘ ?„‘ : 
wb_»t
;

785 
	`Œunÿ‹_šode_·ges_¿nge
(&
šode
->
i_d©a
,

786 
	`round_down
(
de¡off
, 
PAGE_SIZE
),

787 
	`round_up
(
de¡off
 + 
Ën
, 
PAGE_SIZE
) - 1);

789 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

791  
»t
;

792 
	}
}

794 
	$bŒfs_»m­_fe_¿nge_´•
(
fe
 *
fe_š
, 
loff_t
 
pos_š
,

795 
fe
 *
fe_out
, 
loff_t
 
pos_out
,

796 
loff_t
 *
Ën
, 
»m­_æags
)

798 
šode
 *
šode_š
 = 
	`fe_šode
(
fe_š
);

799 
šode
 *
šode_out
 = 
	`fe_šode
(
fe_out
);

800 
u64
 
bs
 = 
	`BTRFS_I
(
šode_out
)->
roÙ
->
fs_šfo
->
sb
->
s_blocksize
;

801 
u64
 
wb_Ën
;

802 
»t
;

804 ià(!(
»m­_æags
 & 
REMAP_FILE_DEDUP
)) {

805 
bŒfs_roÙ
 *
roÙ_out
 = 
	`BTRFS_I
(
šode_out
)->
roÙ
;

807 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ_out
))

808  -
EROFS
;

810 
	`ASSERT
(
šode_š
->
i_sb
 =ğ
šode_out
->i_sb);

814 ià((
	`BTRFS_I
(
šode_š
)->
æags
 & 
BTRFS_INODE_NODATASUM
) !=

815 (
	`BTRFS_I
(
šode_out
)->
æags
 & 
BTRFS_INODE_NODATASUM
)) {

816  -
EINVAL
;

833 ià(*
Ën
 =ğ0 && !(
»m­_æags
 & 
REMAP_FILE_DEDUP
))

834 
wb_Ën
 = 
	`ALIGN
(
šode_š
->
i_size
, 
bs
è- 
	`ALIGN_DOWN
(
pos_š
, bs);

836 
wb_Ën
 = 
	`ALIGN
(*
Ën
, 
bs
);

855 
»t
 = 
	`fem­_æush
(
šode_š
->
i_m­pšg
);

856 ià(
»t
 < 0)

857  
»t
;

859 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode_š
, 
	`ALIGN_DOWN
(
pos_š
, 
bs
),

860 
wb_Ën
);

861 ià(
»t
 < 0)

862  
»t
;

863 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode_out
, 
	`ALIGN_DOWN
(
pos_out
, 
bs
),

864 
wb_Ën
);

865 ià(
»t
 < 0)

866  
»t
;

868  
	`g’”ic_»m­_fe_¿nge_´•
(
fe_š
, 
pos_š
, 
fe_out
, 
pos_out
,

869 
Ën
, 
»m­_æags
);

870 
	}
}

872 
boŞ
 
	$fe_sync_wr™e
(cÚ¡ 
fe
 *file)

874 ià(
fe
->
f_æags
 & (
__O_SYNC
 | 
O_DSYNC
))

875  
Œue
;

876 ià(
	`IS_SYNC
(
	`fe_šode
(
fe
)))

877  
Œue
;

879  
çl£
;

880 
	}
}

882 
loff_t
 
	$bŒfs_»m­_fe_¿nge
(
fe
 *
¤c_fe
, 
loff_t
 
off
,

883 
fe
 *
d¡_fe
, 
loff_t
 
de¡off
,†off_ˆ
Ën
,

884 
»m­_æags
)

886 
šode
 *
¤c_šode
 = 
	`fe_šode
(
¤c_fe
);

887 
šode
 *
d¡_šode
 = 
	`fe_šode
(
d¡_fe
);

888 
boŞ
 
§me_šode
 = 
d¡_šode
 =ğ
¤c_šode
;

889 
»t
;

891 ià(
»m­_æags
 & ~(
REMAP_FILE_DEDUP
 | 
REMAP_FILE_ADVISORY
))

892  -
EINVAL
;

894 ià(
§me_šode
) {

895 
	`bŒfs_šode_lock
(
	`BTRFS_I
(
¤c_šode
), 
BTRFS_ILOCK_MMAP
);

897 
	`lock_two_nÚdœeùÜ›s
(
¤c_šode
, 
d¡_šode
);

898 
	`bŒfs_doubË_mm­_lock
(
¤c_šode
, 
d¡_šode
);

901 
»t
 = 
	`bŒfs_»m­_fe_¿nge_´•
(
¤c_fe
, 
off
, 
d¡_fe
, 
de¡off
,

902 &
Ën
, 
»m­_æags
);

903 ià(
»t
 < 0 || 
Ën
 == 0)

904 
out_uÆock
;

906 ià(
»m­_æags
 & 
REMAP_FILE_DEDUP
)

907 
»t
 = 
	`bŒfs_ex‹Á_§me
(
¤c_šode
, 
off
, 
Ën
, 
d¡_šode
, 
de¡off
);

909 
»t
 = 
	`bŒfs_şÚe_fes
(
d¡_fe
, 
¤c_fe
, 
off
, 
Ën
, 
de¡off
);

911 
out_uÆock
:

912 ià(
§me_šode
) {

913 
	`bŒfs_šode_uÆock
(
	`BTRFS_I
(
¤c_šode
), 
BTRFS_ILOCK_MMAP
);

915 
	`bŒfs_doubË_mm­_uÆock
(
¤c_šode
, 
d¡_šode
);

916 
	`uÆock_two_nÚdœeùÜ›s
(
¤c_šode
, 
d¡_šode
);

926 ià(
»t
 =ğ0 && 
Ën
 > 0 &&

927 (
	`fe_sync_wr™e
(
¤c_fe
è|| fe_sync_wr™e(
d¡_fe
))) {

928 
»t
 = 
	`bŒfs_sync_fe
(
¤c_fe
, 
off
, ofà+ 
Ën
 - 1, 0);

929 ià(
»t
 == 0)

930 
»t
 = 
	`bŒfs_sync_fe
(
d¡_fe
, 
de¡off
,

931 
de¡off
 + 
Ën
 - 1, 0);

934  
»t
 < 0 ?„‘ : 
Ën
;

935 
	}
}

	@reflink.h

3 #iâdeà
BTRFS_REFLINK_H


4 
	#BTRFS_REFLINK_H


	)

6 
	~<lšux/fs.h
>

8 
loff_t
 
bŒfs_»m­_fe_¿nge
(
fe
 *
fe_š
,†off_ˆ
pos_š
,

9 
fe
 *
fe_out
, 
loff_t
 
pos_out
,

10 
loff_t
 
Ën
, 
»m­_æags
);

	@relocation.c

6 
	~<lšux/sched.h
>

7 
	~<lšux/·gem­.h
>

8 
	~<lšux/wr™eback.h
>

9 
	~<lšux/blkdev.h
>

10 
	~<lšux/rbŒ“.h
>

11 
	~<lšux/¦ab.h
>

12 
	~<lšux/”rÜ-šjeùiÚ.h
>

13 
	~"ù»e.h
"

14 
	~"disk-io.h
"

15 
	~"Œª§ùiÚ.h
"

16 
	~"vŞumes.h
"

17 
	~"lockšg.h
"

18 
	~"bŒfs_šode.h
"

19 
	~"async-th»ad.h
"

20 
	~"ä“-¥aû-ÿche.h
"

21 
	~"qgroup.h
"

22 
	~"´št-Œ“.h
"

23 
	~"d–®loc-¥aû.h
"

24 
	~"block-group.h
"

25 
	~"back»f.h
"

26 
	~"misc.h
"

27 
	~"sub·ge.h
"

28 
	~"zÚed.h
"

29 
	~"šode-™em.h
"

30 
	~"¥aû-šfo.h
"

31 
	~"fs.h
"

32 
	~"acûssÜs.h
"

33 
	~"ex‹Á-Œ“.h
"

34 
	~"roÙ-Œ“.h
"

35 
	~"fe-™em.h
"

36 
	~"»loÿtiÚ.h
"

37 
	~"su³r.h
"

38 
	~"Œ“-check”.h
"

87 
	#RELOCATION_RESERVED_NODES
 256

	)

91 
	sm­pšg_node
 {

93 
rb_node
 
	mrb_node
;

94 
u64
 
	mby‹Ä
;

96 *
	md©a
;

99 
	sm­pšg_Œ“
 {

100 
rb_roÙ
 
	mrb_roÙ
;

101 
¥šlock_t
 
	mlock
;

107 
	sŒ“_block
 {

109 
rb_node
 
	mrb_node
;

110 
u64
 
	mby‹Ä
;

112 
u64
 
	mowÃr
;

113 
bŒfs_key
 
	mkey
;

114 
	mËv–
:8;

115 
	mkey_»ady
:1;

118 
	#MAX_EXTENTS
 128

	)

120 
	sfe_ex‹Á_şu¡”
 {

121 
u64
 
	m¡¬t
;

122 
u64
 
	m’d
;

123 
u64
 
	mbound¬y
[
MAX_EXTENTS
];

124 
	mÄ
;

127 
	s»loc_cÚŒŞ
 {

129 
bŒfs_block_group
 *
	mblock_group
;

131 
bŒfs_roÙ
 *
	mex‹Á_roÙ
;

133 
šode
 *
	md©a_šode
;

135 
bŒfs_block_rsv
 *
	mblock_rsv
;

137 
bŒfs_back»f_ÿche
 
	mback»f_ÿche
;

139 
fe_ex‹Á_şu¡”
 
	mşu¡”
;

141 
ex‹Á_io_Œ“
 
	m´oûs£d_blocks
;

143 
m­pšg_Œ“
 
	m»loc_roÙ_Œ“
;

145 
li¡_h—d
 
	m»loc_roÙs
;

147 
li¡_h—d
 
	mdœty_subvŞ_roÙs
;

149 
u64
 
	mm”gšg_rsv_size
;

151 
u64
 
	mnodes_»loÿ‹d
;

153 
u64
 
	m»£rved_by‹s
;

155 
u64
 
	m£¬ch_¡¬t
;

156 
u64
 
	mex‹Ás_found
;

158 
	m¡age
:8;

159 
	mü—‹_»loc_Œ“
:1;

160 
	mm”ge_»loc_Œ“
:1;

161 
	mfound_fe_ex‹Á
:1;

165 
	#MOVE_DATA_EXTENTS
 0

	)

166 
	#UPDATE_DATA_PTRS
 1

	)

168 
	$m¬k_block_´oûs£d
(
»loc_cÚŒŞ
 *
rc
,

169 
bŒfs_back»f_node
 *
node
)

171 
u32
 
blocksize
;

173 ià(
node
->
Ëv–
 == 0 ||

174 
	`š_¿nge
(
node
->
by‹Ä
, 
rc
->
block_group
->
¡¬t
,

175 
rc
->
block_group
->
Ëngth
)) {

176 
blocksize
 = 
rc
->
ex‹Á_roÙ
->
fs_šfo
->
nodesize
;

177 
	`£t_ex‹Á_b™
(&
rc
->
´oûs£d_blocks
, 
node
->
by‹Ä
,

178 
node
->
by‹Ä
 + 
blocksize
 - 1, 
EXTENT_DIRTY
, 
NULL
);

180 
node
->
´oûs£d
 = 1;

181 
	}
}

184 
	$m­pšg_Œ“_š™
(
m­pšg_Œ“
 *
Œ“
)

186 
Œ“
->
rb_roÙ
 = 
RB_ROOT
;

187 
	`¥š_lock_š™
(&
Œ“
->
lock
);

188 
	}
}

193 
bŒfs_back»f_node
 *
	$w®k_up_back»f
(

194 
bŒfs_back»f_node
 *
node
,

195 
bŒfs_back»f_edge
 *
edges
[], *
šdex
)

197 
bŒfs_back»f_edge
 *
edge
;

198 
idx
 = *
šdex
;

200 !
	`li¡_em±y
(&
node
->
uµ”
)) {

201 
edge
 = 
	`li¡_’Œy
(
node
->
uµ”
.
Ãxt
,

202 
bŒfs_back»f_edge
, 
li¡
[
LOWER
]);

203 
edges
[
idx
++] = 
edge
;

204 
node
 = 
edge
->node[
UPPER
];

206 
	`BUG_ON
(
node
->
d‘ached
);

207 *
šdex
 = 
idx
;

208  
node
;

209 
	}
}

214 
bŒfs_back»f_node
 *
	$w®k_down_back»f
(

215 
bŒfs_back»f_edge
 *
edges
[], *
šdex
)

217 
bŒfs_back»f_edge
 *
edge
;

218 
bŒfs_back»f_node
 *
low”
;

219 
idx
 = *
šdex
;

221 
idx
 > 0) {

222 
edge
 = 
edges
[
idx
 - 1];

223 
low”
 = 
edge
->
node
[
LOWER
];

224 ià(
	`li¡_is_Ï¡
(&
edge
->
li¡
[
LOWER
], &
low”
->
uµ”
)) {

225 
idx
--;

228 
edge
 = 
	`li¡_’Œy
Ódge->
li¡
[
LOWER
].
Ãxt
,

229 
bŒfs_back»f_edge
, 
li¡
[
LOWER
]);

230 
edges
[
idx
 - 1] = 
edge
;

231 *
šdex
 = 
idx
;

232  
edge
->
node
[
UPPER
];

234 *
šdex
 = 0;

235  
NULL
;

236 
	}
}

238 
	$upd©e_back»f_node
(
bŒfs_back»f_ÿche
 *
ÿche
,

239 
bŒfs_back»f_node
 *
node
, 
u64
 
by‹Ä
)

241 
rb_node
 *rb_node;

242 
	`rb_”a£
(&
node
->
rb_node
, &
ÿche
->
rb_roÙ
);

243 
node
->
by‹Ä
 = bytenr;

244 
rb_node
 = 
	`rb_sim¶e_š£¹
(&
ÿche
->
rb_roÙ
, 
node
->
by‹Ä
, &node->rb_node);

245 ià(
rb_node
)

246 
	`bŒfs_back»f_·nic
(
ÿche
->
fs_šfo
, 
by‹Ä
, -
EEXIST
);

247 
	}
}

252 
	$upd©e_back»f_ÿche
(
bŒfs_Œªs_hªdË
 *
Œªs
,

253 
bŒfs_back»f_ÿche
 *
ÿche
)

255 
bŒfs_back»f_node
 *
node
;

256 
Ëv–
 = 0;

258 ià(
ÿche
->
Ï¡_Œªs
 == 0) {

259 
ÿche
->
Ï¡_Œªs
 = 
Œªs
->
Œªsid
;

263 ià(
ÿche
->
Ï¡_Œªs
 =ğ
Œªs
->
Œªsid
)

271 !
	`li¡_em±y
(&
ÿche
->
d‘ached
)) {

272 
node
 = 
	`li¡_’Œy
(
ÿche
->
d‘ached
.
Ãxt
,

273 
bŒfs_back»f_node
, 
li¡
);

274 
	`bŒfs_back»f_ş—nup_node
(
ÿche
, 
node
);

277 !
	`li¡_em±y
(&
ÿche
->
chªged
)) {

278 
node
 = 
	`li¡_’Œy
(
ÿche
->
chªged
.
Ãxt
,

279 
bŒfs_back»f_node
, 
li¡
);

280 
	`li¡_d–_š™
(&
node
->
li¡
);

281 
	`BUG_ON
(
node
->
³ndšg
);

282 
	`upd©e_back»f_node
(
ÿche
, 
node
,‚ode->
Ãw_by‹Ä
);

289 
Ëv–
 = 0;†ev– < 
BTRFS_MAX_LEVEL
;†evel++) {

290 
	`li¡_fÜ_—ch_’Œy
(
node
, &
ÿche
->
³ndšg
[
Ëv–
], 
li¡
) {

291 
	`BUG_ON
(!
node
->
³ndšg
);

292 ià(
node
->
by‹Ä
 =ğnode->
Ãw_by‹Ä
)

294 
	`upd©e_back»f_node
(
ÿche
, 
node
,‚ode->
Ãw_by‹Ä
);

298 
ÿche
->
Ï¡_Œªs
 = 0;

300 
	}
}

302 
boŞ
 
	$»loc_roÙ_is_d—d
(
bŒfs_roÙ
 *
roÙ
)

309 
	`smp_rmb
();

310 ià(
	`‹¡_b™
(
BTRFS_ROOT_DEAD_RELOC_TREE
, &
roÙ
->
¡©e
))

311  
Œue
;

312  
çl£
;

313 
	}
}

323 
boŞ
 
	$have_»loc_roÙ
(
bŒfs_roÙ
 *
roÙ
)

325 ià(
	`»loc_roÙ_is_d—d
(
roÙ
))

326  
çl£
;

327 ià(!
roÙ
->
»loc_roÙ
)

328  
çl£
;

329  
Œue
;

330 
	}
}

332 
	$bŒfs_should_ignÜe_»loc_roÙ
(
bŒfs_roÙ
 *
roÙ
)

334 
bŒfs_roÙ
 *
»loc_roÙ
;

336 ià(!
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
))

340 ià(
	`»loc_roÙ_is_d—d
(
roÙ
))

343 
»loc_roÙ
 = 
roÙ
->reloc_root;

344 ià(!
»loc_roÙ
)

347 ià(
	`bŒfs_h—d”_g’”©iÚ
(
»loc_roÙ
->
comm™_roÙ
) ==

348 
roÙ
->
fs_šfo
->
ruÂšg_Œª§ùiÚ
->
Œªsid
)

357 
	}
}

362 
bŒfs_roÙ
 *
	$fšd_»loc_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
)

364 
»loc_cÚŒŞ
 *
rc
 = 
fs_šfo
->
»loc_ùl
;

365 
rb_node
 *rb_node;

366 
m­pšg_node
 *
node
;

367 
bŒfs_roÙ
 *
roÙ
 = 
NULL
;

369 
	`ASSERT
(
rc
);

370 
	`¥š_lock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

371 
rb_node
 = 
	`rb_sim¶e_£¬ch
(&
rc
->
»loc_roÙ_Œ“
.
rb_roÙ
, 
by‹Ä
);

372 ià(
rb_node
) {

373 
node
 = 
	`rb_’Œy
(
rb_node
, 
m­pšg_node
,„b_node);

374 
roÙ
 = 
node
->
d©a
;

376 
	`¥š_uÆock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

377  
	`bŒfs_g¿b_roÙ
(
roÙ
);

378 
	}
}

393 
boŞ
 
	$hªdË_u£Ëss_nodes
(
»loc_cÚŒŞ
 *
rc
,

394 
bŒfs_back»f_node
 *
node
)

396 
bŒfs_back»f_ÿche
 *
ÿche
 = &
rc
->
back»f_ÿche
;

397 
li¡_h—d
 *
u£Ëss_node
 = &
ÿche
->useless_node;

398 
boŞ
 
»t
 = 
çl£
;

400 !
	`li¡_em±y
(
u£Ëss_node
)) {

401 
bŒfs_back»f_node
 *
cur
;

403 
cur
 = 
	`li¡_fœ¡_’Œy
(
u£Ëss_node
, 
bŒfs_back»f_node
,

404 
li¡
);

405 
	`li¡_d–_š™
(&
cur
->
li¡
);

408 
	`ASSERT
(
	`li¡_em±y
(&
cur
->
uµ”
));

410 ià(
cur
 =ğ
node
)

411 
»t
 = 
Œue
;

414 ià(
cur
->
lowe¡
) {

415 
	`li¡_d–_š™
(&
cur
->
low”
);

416 
cur
->
lowe¡
 = 0;

420 !
	`li¡_em±y
(&
cur
->
low”
)) {

421 
bŒfs_back»f_edge
 *
edge
;

422 
bŒfs_back»f_node
 *
low”
;

424 
edge
 = 
	`li¡_’Œy
(
cur
->
low”
.
Ãxt
,

425 
bŒfs_back»f_edge
, 
li¡
[
UPPER
]);

426 
	`li¡_d–
(&
edge
->
li¡
[
UPPER
]);

427 
	`li¡_d–
(&
edge
->
li¡
[
LOWER
]);

428 
low”
 = 
edge
->
node
[
LOWER
];

429 
	`bŒfs_back»f_ä“_edge
(
ÿche
, 
edge
);

432 ià(
	`li¡_em±y
(&
low”
->
uµ”
))

433 
	`li¡_add
(&
low”
->
li¡
, 
u£Ëss_node
);

436 
	`m¬k_block_´oûs£d
(
rc
, 
cur
);

443 ià(
cur
->
Ëv–
 > 0) {

444 
	`li¡_add
(&
cur
->
li¡
, &
ÿche
->
d‘ached
);

445 
cur
->
d‘ached
 = 1;

447 
	`rb_”a£
(&
cur
->
rb_node
, &
ÿche
->
rb_roÙ
);

448 
	`bŒfs_back»f_ä“_node
(
ÿche
, 
cur
);

451  
»t
;

452 
	}
}

468 
nošlše_fÜ_¡ack
 
bŒfs_back»f_node
 *
	$bud_back»f_Œ“
(

469 
bŒfs_Œªs_hªdË
 *
Œªs
,

470 
»loc_cÚŒŞ
 *
rc
, 
bŒfs_key
 *
node_key
,

471 
Ëv–
, 
u64
 
by‹Ä
)

473 
bŒfs_back»f_™”
 *
™”
;

474 
bŒfs_back»f_ÿche
 *
ÿche
 = &
rc
->
back»f_ÿche
;

476 
bŒfs_·th
 *
·th
;

477 
bŒfs_back»f_node
 *
cur
;

478 
bŒfs_back»f_node
 *
node
 = 
NULL
;

479 
bŒfs_back»f_edge
 *
edge
;

480 
»t
;

481 
”r
 = 0;

483 
™”
 = 
	`bŒfs_back»f_™”_®loc
(
rc
->
ex‹Á_roÙ
->
fs_šfo
);

484 ià(!
™”
)

485  
	`ERR_PTR
(-
ENOMEM
);

486 
·th
 = 
	`bŒfs_®loc_·th
();

487 ià(!
·th
) {

488 
”r
 = -
ENOMEM
;

489 
out
;

492 
node
 = 
	`bŒfs_back»f_®loc_node
(
ÿche
, 
by‹Ä
, 
Ëv–
);

493 ià(!
node
) {

494 
”r
 = -
ENOMEM
;

495 
out
;

498 
node
->
lowe¡
 = 1;

499 
cur
 = 
node
;

503 
»t
 = 
	`bŒfs_back»f_add_Œ“_node
(
Œªs
, 
ÿche
, 
·th
, 
™”
,

504 
node_key
, 
cur
);

505 ià(
»t
 < 0) {

506 
”r
 = 
»t
;

507 
out
;

509 
edge
 = 
	`li¡_fœ¡_’Œy_Ü_nuÎ
(&
ÿche
->
³ndšg_edge
,

510 
bŒfs_back»f_edge
, 
li¡
[
UPPER
]);

515 ià(
edge
) {

516 
	`li¡_d–_š™
(&
edge
->
li¡
[
UPPER
]);

517 
cur
 = 
edge
->
node
[
UPPER
];

519 } 
edge
);

522 
»t
 = 
	`bŒfs_back»f_fšish_uµ”_lšks
(
ÿche
, 
node
);

523 ià(
»t
 < 0) {

524 
”r
 = 
»t
;

525 
out
;

528 ià(
	`hªdË_u£Ëss_nodes
(
rc
, 
node
))

529 
node
 = 
NULL
;

530 
out
:

531 
	`bŒfs_back»f_™”_ä“
(
™”
);

532 
	`bŒfs_ä“_·th
(
·th
);

533 ià(
”r
) {

534 
	`bŒfs_back»f_”rÜ_ş—nup
(
ÿche
, 
node
);

535  
	`ERR_PTR
(
”r
);

537 
	`ASSERT
(!
node
 || !node->
d‘ached
);

538 
	`ASSERT
(
	`li¡_em±y
(&
ÿche
->
u£Ëss_node
) &&

539 
	`li¡_em±y
(&
ÿche
->
³ndšg_edge
));

540  
node
;

541 
	}
}

548 
	$şÚe_back»f_node
(
bŒfs_Œªs_hªdË
 *
Œªs
,

549 
»loc_cÚŒŞ
 *
rc
,

550 
bŒfs_roÙ
 *
¤c
,

551 
bŒfs_roÙ
 *
de¡
)

553 
bŒfs_roÙ
 *
»loc_roÙ
 = 
¤c
->reloc_root;

554 
bŒfs_back»f_ÿche
 *
ÿche
 = &
rc
->
back»f_ÿche
;

555 
bŒfs_back»f_node
 *
node
 = 
NULL
;

556 
bŒfs_back»f_node
 *
Ãw_node
;

557 
bŒfs_back»f_edge
 *
edge
;

558 
bŒfs_back»f_edge
 *
Ãw_edge
;

559 
rb_node
 *rb_node;

561 ià(
ÿche
->
Ï¡_Œªs
 > 0)

562 
	`upd©e_back»f_ÿche
(
Œªs
, 
ÿche
);

564 
rb_node
 = 
	`rb_sim¶e_£¬ch
(&
ÿche
->
rb_roÙ
, 
¤c
->
comm™_roÙ
->
¡¬t
);

565 ià(
rb_node
) {

566 
node
 = 
	`rb_’Œy
(
rb_node
, 
bŒfs_back»f_node
,„b_node);

567 ià(
node
->
d‘ached
)

568 
node
 = 
NULL
;

570 
	`BUG_ON
(
node
->
Ãw_by‹Ä
 !ğ
»loc_roÙ
->node->
¡¬t
);

573 ià(!
node
) {

574 
rb_node
 = 
	`rb_sim¶e_£¬ch
(&
ÿche
->
rb_roÙ
,

575 
»loc_roÙ
->
comm™_roÙ
->
¡¬t
);

576 ià(
rb_node
) {

577 
node
 = 
	`rb_’Œy
(
rb_node
, 
bŒfs_back»f_node
,

578 
rb_node
);

579 
	`BUG_ON
(
node
->
d‘ached
);

583 ià(!
node
)

586 
Ãw_node
 = 
	`bŒfs_back»f_®loc_node
(
ÿche
, 
de¡
->
node
->
¡¬t
,

587 
node
->
Ëv–
);

588 ià(!
Ãw_node
)

589  -
ENOMEM
;

591 
Ãw_node
->
lowe¡
 = 
node
->lowest;

592 
Ãw_node
->
checked
 = 1;

593 
Ãw_node
->
roÙ
 = 
	`bŒfs_g¿b_roÙ
(
de¡
);

594 
	`ASSERT
(
Ãw_node
->
roÙ
);

596 ià(!
node
->
lowe¡
) {

597 
	`li¡_fÜ_—ch_’Œy
(
edge
, &
node
->
low”
, 
li¡
[
UPPER
]) {

598 
Ãw_edge
 = 
	`bŒfs_back»f_®loc_edge
(
ÿche
);

599 ià(!
Ãw_edge
)

600 
ç
;

602 
	`bŒfs_back»f_lšk_edge
(
Ãw_edge
, 
edge
->
node
[
LOWER
],

603 
Ãw_node
, 
LINK_UPPER
);

606 
	`li¡_add_
(&
Ãw_node
->
low”
, &
ÿche
->
Ëaves
);

609 
rb_node
 = 
	`rb_sim¶e_š£¹
(&
ÿche
->
rb_roÙ
, 
Ãw_node
->
by‹Ä
,

610 &
Ãw_node
->
rb_node
);

611 ià(
rb_node
)

612 
	`bŒfs_back»f_·nic
(
Œªs
->
fs_šfo
, 
Ãw_node
->
by‹Ä
, -
EEXIST
);

614 ià(!
Ãw_node
->
lowe¡
) {

615 
	`li¡_fÜ_—ch_’Œy
(
Ãw_edge
, &
Ãw_node
->
low”
, 
li¡
[
UPPER
]) {

616 
	`li¡_add_
(&
Ãw_edge
->
li¡
[
LOWER
],

617 &
Ãw_edge
->
node
[
LOWER
]->
uµ”
);

621 
ç
:

622 !
	`li¡_em±y
(&
Ãw_node
->
low”
)) {

623 
Ãw_edge
 = 
	`li¡_’Œy
(
Ãw_node
->
low”
.
Ãxt
,

624 
bŒfs_back»f_edge
, 
li¡
[
UPPER
]);

625 
	`li¡_d–
(&
Ãw_edge
->
li¡
[
UPPER
]);

626 
	`bŒfs_back»f_ä“_edge
(
ÿche
, 
Ãw_edge
);

628 
	`bŒfs_back»f_ä“_node
(
ÿche
, 
Ãw_node
);

629  -
ENOMEM
;

630 
	}
}

635 
__mu¡_check
 
	$__add_»loc_roÙ
(
bŒfs_roÙ
 *
roÙ
)

637 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

638 
rb_node
 *rb_node;

639 
m­pšg_node
 *
node
;

640 
»loc_cÚŒŞ
 *
rc
 = 
fs_šfo
->
»loc_ùl
;

642 
node
 = 
	`km®loc
((*node), 
GFP_NOFS
);

643 ià(!
node
)

644  -
ENOMEM
;

646 
node
->
by‹Ä
 = 
roÙ
->
comm™_roÙ
->
¡¬t
;

647 
node
->
d©a
 = 
roÙ
;

649 
	`¥š_lock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

650 
rb_node
 = 
	`rb_sim¶e_š£¹
(&
rc
->
»loc_roÙ_Œ“
.
rb_roÙ
,

651 
node
->
by‹Ä
, &node->
rb_node
);

652 
	`¥š_uÆock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

653 ià(
rb_node
) {

654 
	`bŒfs_”r
(
fs_šfo
,

656 
node
->
by‹Ä
);

657  -
EEXIST
;

660 
	`li¡_add_
(&
roÙ
->
roÙ_li¡
, &
rc
->
»loc_roÙs
);

662 
	}
}

668 
	$__d–_»loc_roÙ
(
bŒfs_roÙ
 *
roÙ
)

670 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

671 
rb_node
 *rb_node;

672 
m­pšg_node
 *
node
 = 
NULL
;

673 
»loc_cÚŒŞ
 *
rc
 = 
fs_šfo
->
»loc_ùl
;

674 
boŞ
 
put_»f
 = 
çl£
;

676 ià(
rc
 && 
roÙ
->
node
) {

677 
	`¥š_lock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

678 
rb_node
 = 
	`rb_sim¶e_£¬ch
(&
rc
->
»loc_roÙ_Œ“
.
rb_roÙ
,

679 
roÙ
->
comm™_roÙ
->
¡¬t
);

680 ià(
rb_node
) {

681 
node
 = 
	`rb_’Œy
(
rb_node
, 
m­pšg_node
,„b_node);

682 
	`rb_”a£
(&
node
->
rb_node
, &
rc
->
»loc_roÙ_Œ“
.
rb_roÙ
);

683 
	`RB_CLEAR_NODE
(&
node
->
rb_node
);

685 
	`¥š_uÆock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

686 
	`ASSERT
(!
node
 || (
bŒfs_roÙ
 *êode->
d©a
 =ğ
roÙ
);

697 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

698 ià(!
	`li¡_em±y
(&
roÙ
->
roÙ_li¡
)) {

699 
put_»f
 = 
Œue
;

700 
	`li¡_d–_š™
(&
roÙ
->
roÙ_li¡
);

702 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

703 ià(
put_»f
)

704 
	`bŒfs_put_roÙ
(
roÙ
);

705 
	`kä“
(
node
);

706 
	}
}

712 
	$__upd©e_»loc_roÙ
(
bŒfs_roÙ
 *
roÙ
)

714 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

715 
rb_node
 *rb_node;

716 
m­pšg_node
 *
node
 = 
NULL
;

717 
»loc_cÚŒŞ
 *
rc
 = 
fs_šfo
->
»loc_ùl
;

719 
	`¥š_lock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

720 
rb_node
 = 
	`rb_sim¶e_£¬ch
(&
rc
->
»loc_roÙ_Œ“
.
rb_roÙ
,

721 
roÙ
->
comm™_roÙ
->
¡¬t
);

722 ià(
rb_node
) {

723 
node
 = 
	`rb_’Œy
(
rb_node
, 
m­pšg_node
,„b_node);

724 
	`rb_”a£
(&
node
->
rb_node
, &
rc
->
»loc_roÙ_Œ“
.
rb_roÙ
);

726 
	`¥š_uÆock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

728 ià(!
node
)

730 
	`BUG_ON
((
bŒfs_roÙ
 *)
node
->
d©a
 !ğ
roÙ
);

732 
	`¥š_lock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

733 
node
->
by‹Ä
 = 
roÙ
->node->
¡¬t
;

734 
rb_node
 = 
	`rb_sim¶e_š£¹
(&
rc
->
»loc_roÙ_Œ“
.
rb_roÙ
,

735 
node
->
by‹Ä
, &node->
rb_node
);

736 
	`¥š_uÆock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

737 ià(
rb_node
)

738 
	`bŒfs_back»f_·nic
(
fs_šfo
, 
node
->
by‹Ä
, -
EEXIST
);

740 
	}
}

742 
bŒfs_roÙ
 *
	$ü—‹_»loc_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

743 
bŒfs_roÙ
 *
roÙ
, 
u64
 
objeùid
)

745 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

746 
bŒfs_roÙ
 *
»loc_roÙ
;

747 
ex‹Á_bufãr
 *
eb
;

748 
bŒfs_roÙ_™em
 *
roÙ_™em
;

749 
bŒfs_key
 
roÙ_key
;

750 
»t
 = 0;

751 
boŞ
 
mu¡_abÜt
 = 
çl£
;

753 
roÙ_™em
 = 
	`km®loc
((*roÙ_™em), 
GFP_NOFS
);

754 ià(!
roÙ_™em
)

755  
	`ERR_PTR
(-
ENOMEM
);

757 
roÙ_key
.
objeùid
 = 
BTRFS_TREE_RELOC_OBJECTID
;

758 
roÙ_key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

759 
roÙ_key
.
off£t
 = 
objeùid
;

761 ià(
roÙ
->
roÙ_key
.
objeùid
 == objectid) {

762 
u64
 
comm™_roÙ_g’
;

765 
»t
 = 
	`bŒfs_cİy_roÙ
(
Œªs
, 
roÙ
,„oÙ->
comm™_roÙ
, &
eb
,

766 
BTRFS_TREE_RELOC_OBJECTID
);

767 ià(
»t
)

768 
ç
;

778 
comm™_roÙ_g’
 = 
	`bŒfs_h—d”_g’”©iÚ
(
roÙ
->
comm™_roÙ
);

779 
	`bŒfs_£t_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
, 
comm™_roÙ_g’
);

788 
»t
 = 
	`bŒfs_cİy_roÙ
(
Œªs
, 
roÙ
,„oÙ->
node
, &
eb
,

789 
BTRFS_TREE_RELOC_OBJECTID
);

790 ià(
»t
)

791 
ç
;

798 
mu¡_abÜt
 = 
Œue
;

800 
	`memıy
(
roÙ_™em
, &
roÙ
->root_item, (*root_item));

801 
	`bŒfs_£t_roÙ_by‹Ä
(
roÙ_™em
, 
eb
->
¡¬t
);

802 
	`bŒfs_£t_roÙ_Ëv–
(
roÙ_™em
, 
	`bŒfs_h—d”_Ëv–
(
eb
));

803 
	`bŒfs_£t_roÙ_g’”©iÚ
(
roÙ_™em
, 
Œªs
->
Œªsid
);

805 ià(
roÙ
->
roÙ_key
.
objeùid
 == objectid) {

806 
	`bŒfs_£t_roÙ_»fs
(
roÙ_™em
, 0);

807 
	`mem£t
(&
roÙ_™em
->
drİ_´og»ss
, 0,

808 (
bŒfs_disk_key
));

809 
	`bŒfs_£t_roÙ_drİ_Ëv–
(
roÙ_™em
, 0);

812 
	`bŒfs_Œ“_uÆock
(
eb
);

813 
	`ä“_ex‹Á_bufãr
(
eb
);

815 
»t
 = 
	`bŒfs_š£¹_roÙ
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
,

816 &
roÙ_key
, 
roÙ_™em
);

817 ià(
»t
)

818 
ç
;

820 
	`kä“
(
roÙ_™em
);

822 
»loc_roÙ
 = 
	`bŒfs_»ad_Œ“_roÙ
(
fs_šfo
->
Œ“_roÙ
, &
roÙ_key
);

823 ià(
	`IS_ERR
(
»loc_roÙ
)) {

824 
»t
 = 
	`PTR_ERR
(
»loc_roÙ
);

825 
abÜt
;

827 
	`£t_b™
(
BTRFS_ROOT_SHAREABLE
, &
»loc_roÙ
->
¡©e
);

828 
»loc_roÙ
->
Ï¡_Œªs
 = 
Œªs
->
Œªsid
;

829  
»loc_roÙ
;

830 
ç
:

831 
	`kä“
(
roÙ_™em
);

832 
abÜt
:

833 ià(
mu¡_abÜt
)

834 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

835  
	`ERR_PTR
(
»t
);

836 
	}
}

845 
	$bŒfs_š™_»loc_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

846 
bŒfs_roÙ
 *
roÙ
)

848 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

849 
bŒfs_roÙ
 *
»loc_roÙ
;

850 
»loc_cÚŒŞ
 *
rc
 = 
fs_šfo
->
»loc_ùl
;

851 
bŒfs_block_rsv
 *
rsv
;

852 
ş—r_rsv
 = 0;

853 
»t
;

855 ià(!
rc
)

862 ià(
	`»loc_roÙ_is_d—d
(
roÙ
))

873 ià(
roÙ
->
»loc_roÙ
) {

874 
»loc_roÙ
 = 
roÙ
->reloc_root;

875 
»loc_roÙ
->
Ï¡_Œªs
 = 
Œªs
->
Œªsid
;

883 ià(!
rc
->
ü—‹_»loc_Œ“
 ||

884 
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
)

887 ià(!
Œªs
->
»loc_»£rved
) {

888 
rsv
 = 
Œªs
->
block_rsv
;

889 
Œªs
->
block_rsv
 = 
rc
->block_rsv;

890 
ş—r_rsv
 = 1;

892 
»loc_roÙ
 = 
	`ü—‹_»loc_roÙ
(
Œªs
, 
roÙ
,„oÙ->
roÙ_key
.
objeùid
);

893 ià(
ş—r_rsv
)

894 
Œªs
->
block_rsv
 = 
rsv
;

895 ià(
	`IS_ERR
(
»loc_roÙ
))

896  
	`PTR_ERR
(
»loc_roÙ
);

898 
»t
 = 
	`__add_»loc_roÙ
(
»loc_roÙ
);

899 
	`ASSERT
(
»t
 !ğ-
EEXIST
);

900 ià(
»t
) {

902 
	`bŒfs_put_roÙ
(
»loc_roÙ
);

903  
»t
;

905 
roÙ
->
»loc_roÙ
 = 
	`bŒfs_g¿b_roÙ
(reloc_root);

907 
	}
}

912 
	$bŒfs_upd©e_»loc_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

913 
bŒfs_roÙ
 *
roÙ
)

915 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

916 
bŒfs_roÙ
 *
»loc_roÙ
;

917 
bŒfs_roÙ_™em
 *
roÙ_™em
;

918 
»t
;

920 ià(!
	`have_»loc_roÙ
(
roÙ
))

923 
»loc_roÙ
 = 
roÙ
->reloc_root;

924 
roÙ_™em
 = &
»loc_roÙ
->root_item;

931 
	`bŒfs_g¿b_roÙ
(
»loc_roÙ
);

934 ià(
fs_šfo
->
»loc_ùl
->
m”ge_»loc_Œ“
 &&

935 
	`bŒfs_roÙ_»fs
(
roÙ_™em
) == 0) {

936 
	`£t_b™
(
BTRFS_ROOT_DEAD_RELOC_TREE
, &
roÙ
->
¡©e
);

941 
	`smp_wmb
();

942 
	`__d–_»loc_roÙ
(
»loc_roÙ
);

945 ià(
»loc_roÙ
->
comm™_roÙ
 !ğ»loc_roÙ->
node
) {

946 
	`__upd©e_»loc_roÙ
(
»loc_roÙ
);

947 
	`bŒfs_£t_roÙ_node
(
roÙ_™em
, 
»loc_roÙ
->
node
);

948 
	`ä“_ex‹Á_bufãr
(
»loc_roÙ
->
comm™_roÙ
);

949 
»loc_roÙ
->
comm™_roÙ
 = 
	`bŒfs_roÙ_node
(reloc_root);

952 
»t
 = 
	`bŒfs_upd©e_roÙ
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
,

953 &
»loc_roÙ
->
roÙ_key
, 
roÙ_™em
);

954 
	`bŒfs_put_roÙ
(
»loc_roÙ
);

955  
»t
;

956 
	}
}

962 
šode
 *
	$fšd_Ãxt_šode
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
objeùid
)

964 
rb_node
 *
node
;

965 
rb_node
 *
´ev
;

966 
bŒfs_šode
 *
’Œy
;

967 
šode
 *inode;

969 
	`¥š_lock
(&
roÙ
->
šode_lock
);

970 
agaš
:

971 
node
 = 
roÙ
->
šode_Œ“
.
rb_node
;

972 
´ev
 = 
NULL
;

973 
node
) {

974 
´ev
 = 
node
;

975 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_šode
, 
rb_node
);

977 ià(
objeùid
 < 
	`bŒfs_šo
(
’Œy
))

978 
node
 =‚ode->
rb_Ëá
;

979 ià(
objeùid
 > 
	`bŒfs_šo
(
’Œy
))

980 
node
 =‚ode->
rb_right
;

984 ià(!
node
) {

985 
´ev
) {

986 
’Œy
 = 
	`rb_’Œy
(
´ev
, 
bŒfs_šode
, 
rb_node
);

987 ià(
objeùid
 <ğ
	`bŒfs_šo
(
’Œy
)) {

988 
node
 = 
´ev
;

991 
´ev
 = 
	`rb_Ãxt
(prev);

994 
node
) {

995 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_šode
, 
rb_node
);

996 
šode
 = 
	`ig¿b
(&
’Œy
->
vfs_šode
);

997 ià(
šode
) {

998 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

999  
šode
;

1002 
objeùid
 = 
	`bŒfs_šo
(
’Œy
) + 1;

1003 ià(
	`cÚd_»sched_lock
(&
roÙ
->
šode_lock
))

1004 
agaš
;

1006 
node
 = 
	`rb_Ãxt
(node);

1008 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

1009  
NULL
;

1010 
	}
}

1015 
	$g‘_Ãw_loÿtiÚ
(
šode
 *
»loc_šode
, 
u64
 *
Ãw_by‹Ä
,

1016 
u64
 
by‹Ä
, u64 
num_by‹s
)

1018 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
»loc_šode
)->root;

1019 
bŒfs_·th
 *
·th
;

1020 
bŒfs_fe_ex‹Á_™em
 *
fi
;

1021 
ex‹Á_bufãr
 *
Ëaf
;

1022 
»t
;

1024 
·th
 = 
	`bŒfs_®loc_·th
();

1025 ià(!
·th
)

1026  -
ENOMEM
;

1028 
by‹Ä
 -ğ
	`BTRFS_I
(
»loc_šode
)->
šdex_út
;

1029 
»t
 = 
	`bŒfs_lookup_fe_ex‹Á
(
NULL
, 
roÙ
, 
·th
,

1030 
	`bŒfs_šo
(
	`BTRFS_I
(
»loc_šode
)), 
by‹Ä
, 0);

1031 ià(
»t
 < 0)

1032 
out
;

1033 ià(
»t
 > 0) {

1034 
»t
 = -
ENOENT
;

1035 
out
;

1038 
Ëaf
 = 
·th
->
nodes
[0];

1039 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1040 
bŒfs_fe_ex‹Á_™em
);

1042 
	`BUG_ON
(
	`bŒfs_fe_ex‹Á_off£t
(
Ëaf
, 
fi
) ||

1043 
	`bŒfs_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
) ||

1044 
	`bŒfs_fe_ex‹Á_’üy±iÚ
(
Ëaf
, 
fi
) ||

1045 
	`bŒfs_fe_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
fi
));

1047 ià(
num_by‹s
 !ğ
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
)) {

1048 
»t
 = -
EINVAL
;

1049 
out
;

1052 *
Ãw_by‹Ä
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
);

1053 
»t
 = 0;

1054 
out
:

1055 
	`bŒfs_ä“_·th
(
·th
);

1056  
»t
;

1057 
	}
}

1063 
nošlše_fÜ_¡ack


1064 
	$»¶aû_fe_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1065 
»loc_cÚŒŞ
 *
rc
,

1066 
bŒfs_roÙ
 *
roÙ
,

1067 
ex‹Á_bufãr
 *
Ëaf
)

1069 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1070 
bŒfs_key
 
key
;

1071 
bŒfs_fe_ex‹Á_™em
 *
fi
;

1072 
šode
 *šodğ
NULL
;

1073 
u64
 
·»Á
;

1074 
u64
 
by‹Ä
;

1075 
u64
 
Ãw_by‹Ä
 = 0;

1076 
u64
 
num_by‹s
;

1077 
u64
 
’d
;

1078 
u32
 
Ä™ems
;

1079 
u32
 
i
;

1080 
»t
 = 0;

1081 
fœ¡
 = 1;

1082 
dœty
 = 0;

1084 ià(
rc
->
¡age
 !ğ
UPDATE_DATA_PTRS
)

1088 ià(
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
)

1089 
·»Á
 = 
Ëaf
->
¡¬t
;

1091 
·»Á
 = 0;

1093 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

1094 
i
 = 0; i < 
Ä™ems
; i++) {

1095 
bŒfs_»f
 
»f
 = { 0 };

1097 
	`cÚd_»sched
();

1098 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
i
);

1099 ià(
key
.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

1101 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
i
, 
bŒfs_fe_ex‹Á_™em
);

1102 ià(
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
fi
) ==

1103 
BTRFS_FILE_EXTENT_INLINE
)

1105 
by‹Ä
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
);

1106 
num_by‹s
 = 
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
);

1107 ià(
by‹Ä
 == 0)

1109 ià(!
	`š_¿nge
(
by‹Ä
, 
rc
->
block_group
->
¡¬t
,

1110 
rc
->
block_group
->
Ëngth
))

1117 ià(
roÙ
->
roÙ_key
.
objeùid
 !ğ
BTRFS_TREE_RELOC_OBJECTID
) {

1118 ià(
fœ¡
) {

1119 
šode
 = 
	`fšd_Ãxt_šode
(
roÙ
, 
key
.
objeùid
);

1120 
fœ¡
 = 0;

1121 } ià(
šode
 && 
	`bŒfs_šo
(
	`BTRFS_I
(šode)è< 
key
.
objeùid
) {

1122 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
šode
));

1123 
šode
 = 
	`fšd_Ãxt_šode
(
roÙ
, 
key
.
objeùid
);

1125 ià(
šode
 && 
	`bŒfs_šo
(
	`BTRFS_I
(šode)è=ğ
key
.
objeùid
) {

1126 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

1128 
’d
 = 
key
.
off£t
 +

1129 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

1130 
	`WARN_ON
(!
	`IS_ALIGNED
(
key
.
off£t
,

1131 
fs_šfo
->
£ùÜsize
));

1132 
	`WARN_ON
(!
	`IS_ALIGNED
(
’d
, 
fs_šfo
->
£ùÜsize
));

1133 
’d
--;

1134 
»t
 = 
	`Œy_lock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

1135 
key
.
off£t
, 
’d
,

1136 &
ÿched_¡©e
);

1137 ià(!
»t
)

1140 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
	`BTRFS_I
(
šode
),

1141 
key
.
off£t
, 
’d
, 
Œue
);

1142 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

1143 
key
.
off£t
, 
’d
, &
ÿched_¡©e
);

1147 
»t
 = 
	`g‘_Ãw_loÿtiÚ
(
rc
->
d©a_šode
, &
Ãw_by‹Ä
,

1148 
by‹Ä
, 
num_by‹s
);

1149 ià(
»t
) {

1157 
	`bŒfs_£t_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
, 
Ãw_by‹Ä
);

1158 
dœty
 = 1;

1160 
key
.
off£t
 -ğ
	`bŒfs_fe_ex‹Á_off£t
(
Ëaf
, 
fi
);

1161 
	`bŒfs_š™_g’”ic_»f
(&
»f
, 
BTRFS_ADD_DELAYED_REF
, 
Ãw_by‹Ä
,

1162 
num_by‹s
, 
·»Á
);

1163 
	`bŒfs_š™_d©a_»f
(&
»f
, 
	`bŒfs_h—d”_owÃr
(
Ëaf
),

1164 
key
.
objeùid
, key.
off£t
,

1165 
roÙ
->
roÙ_key
.
objeùid
, 
çl£
);

1166 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, &
»f
);

1167 ià(
»t
) {

1168 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1172 
	`bŒfs_š™_g’”ic_»f
(&
»f
, 
BTRFS_DROP_DELAYED_REF
, 
by‹Ä
,

1173 
num_by‹s
, 
·»Á
);

1174 
	`bŒfs_š™_d©a_»f
(&
»f
, 
	`bŒfs_h—d”_owÃr
(
Ëaf
),

1175 
key
.
objeùid
, key.
off£t
,

1176 
roÙ
->
roÙ_key
.
objeùid
, 
çl£
);

1177 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, &
»f
);

1178 ià(
»t
) {

1179 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1183 ià(
dœty
)

1184 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

1185 ià(
šode
)

1186 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
šode
));

1187  
»t
;

1188 
	}
}

1190 
nošlše_fÜ_¡ack


1191 
	$memcmp_node_keys
(
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

1192 
bŒfs_·th
 *
·th
, 
Ëv–
)

1194 
bŒfs_disk_key
 
key1
;

1195 
bŒfs_disk_key
 
key2
;

1196 
	`bŒfs_node_key
(
eb
, &
key1
, 
¦Ù
);

1197 
	`bŒfs_node_key
(
·th
->
nodes
[
Ëv–
], &
key2
,…©h->
¦Ùs
[level]);

1198  
	`memcmp
(&
key1
, &
key2
, (key1));

1199 
	}
}

1210 
nošlše_fÜ_¡ack


1211 
	$»¶aû_·th
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
»loc_cÚŒŞ
 *
rc
,

1212 
bŒfs_roÙ
 *
de¡
, bŒfs_roÙ *
¤c
,

1213 
bŒfs_·th
 *
·th
, 
bŒfs_key
 *
Ãxt_key
,

1214 
lowe¡_Ëv–
, 
max_Ëv–
)

1216 
bŒfs_fs_šfo
 *
fs_šfo
 = 
de¡
->fs_info;

1217 
ex‹Á_bufãr
 *
eb
;

1218 
ex‹Á_bufãr
 *
·»Á
;

1219 
bŒfs_»f
 
»f
 = { 0 };

1220 
bŒfs_key
 
key
;

1221 
u64
 
Şd_by‹Ä
;

1222 
u64
 
Ãw_by‹Ä
;

1223 
u64
 
Şd_±r_g’
;

1224 
u64
 
Ãw_±r_g’
;

1225 
u64
 
Ï¡_¢­shÙ
;

1226 
u32
 
blocksize
;

1227 
cow
 = 0;

1228 
Ëv–
;

1229 
»t
;

1230 
¦Ù
;

1232 
	`ASSERT
(
¤c
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
);

1233 
	`ASSERT
(
de¡
->
roÙ_key
.
objeùid
 !ğ
BTRFS_TREE_RELOC_OBJECTID
);

1235 
Ï¡_¢­shÙ
 = 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
¤c
->
roÙ_™em
);

1236 
agaš
:

1237 
¦Ù
 = 
·th
->
¦Ùs
[
lowe¡_Ëv–
];

1238 
	`bŒfs_node_key_to_ıu
(
·th
->
nodes
[
lowe¡_Ëv–
], &
key
, 
¦Ù
);

1240 
eb
 = 
	`bŒfs_lock_roÙ_node
(
de¡
);

1241 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
eb
);

1243 ià(
Ëv–
 < 
lowe¡_Ëv–
) {

1244 
	`bŒfs_Œ“_uÆock
(
eb
);

1245 
	`ä“_ex‹Á_bufãr
(
eb
);

1249 ià(
cow
) {

1250 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
de¡
, 
eb
, 
NULL
, 0, &eb,

1251 
BTRFS_NESTING_COW
);

1252 ià(
»t
) {

1253 
	`bŒfs_Œ“_uÆock
(
eb
);

1254 
	`ä“_ex‹Á_bufãr
(
eb
);

1255  
»t
;

1259 ià(
Ãxt_key
) {

1260 
Ãxt_key
->
objeùid
 = (
u64
)-1;

1261 
Ãxt_key
->
ty³
 = (
u8
)-1;

1262 
Ãxt_key
->
off£t
 = (
u64
)-1;

1265 
·»Á
 = 
eb
;

1267 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
·»Á
);

1268 
	`ASSERT
(
Ëv–
 >ğ
lowe¡_Ëv–
);

1270 
»t
 = 
	`bŒfs_bš_£¬ch
(
·»Á
, 0, &
key
, &
¦Ù
);

1271 ià(
»t
 < 0)

1273 ià(
»t
 && 
¦Ù
 > 0)

1274 
¦Ù
--;

1276 ià(
Ãxt_key
 && 
¦Ù
 + 1 < 
	`bŒfs_h—d”_Ä™ems
(
·»Á
))

1277 
	`bŒfs_node_key_to_ıu
(
·»Á
, 
Ãxt_key
, 
¦Ù
 + 1);

1279 
Şd_by‹Ä
 = 
	`bŒfs_node_block±r
(
·»Á
, 
¦Ù
);

1280 
blocksize
 = 
fs_šfo
->
nodesize
;

1281 
Şd_±r_g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
·»Á
, 
¦Ù
);

1283 ià(
Ëv–
 <ğ
max_Ëv–
) {

1284 
eb
 = 
·th
->
nodes
[
Ëv–
];

1285 
Ãw_by‹Ä
 = 
	`bŒfs_node_block±r
(
eb
,

1286 
·th
->
¦Ùs
[
Ëv–
]);

1287 
Ãw_±r_g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
eb
,

1288 
·th
->
¦Ùs
[
Ëv–
]);

1290 
Ãw_by‹Ä
 = 0;

1291 
Ãw_±r_g’
 = 0;

1294 ià(
	`WARN_ON
(
Ãw_by‹Ä
 > 0 &&‚ew_by‹Ä =ğ
Şd_by‹Ä
)) {

1295 
»t
 = 
Ëv–
;

1299 ià(
Ãw_by‹Ä
 =ğ0 || 
Şd_±r_g’
 > 
Ï¡_¢­shÙ
 ||

1300 
	`memcmp_node_keys
(
·»Á
, 
¦Ù
, 
·th
, 
Ëv–
)) {

1301 ià(
Ëv–
 <ğ
lowe¡_Ëv–
) {

1302 
»t
 = 0;

1306 
eb
 = 
	`bŒfs_»ad_node_¦Ù
(
·»Á
, 
¦Ù
);

1307 ià(
	`IS_ERR
(
eb
)) {

1308 
»t
 = 
	`PTR_ERR
(
eb
);

1311 
	`bŒfs_Œ“_lock
(
eb
);

1312 ià(
cow
) {

1313 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
de¡
, 
eb
, 
·»Á
,

1314 
¦Ù
, &
eb
,

1315 
BTRFS_NESTING_COW
);

1316 ià(
»t
) {

1317 
	`bŒfs_Œ“_uÆock
(
eb
);

1318 
	`ä“_ex‹Á_bufãr
(
eb
);

1323 
	`bŒfs_Œ“_uÆock
(
·»Á
);

1324 
	`ä“_ex‹Á_bufãr
(
·»Á
);

1326 
·»Á
 = 
eb
;

1330 ià(!
cow
) {

1331 
	`bŒfs_Œ“_uÆock
(
·»Á
);

1332 
	`ä“_ex‹Á_bufãr
(
·»Á
);

1333 
cow
 = 1;

1334 
agaš
;

1337 
	`bŒfs_node_key_to_ıu
(
·th
->
nodes
[
Ëv–
], &
key
,

1338 
·th
->
¦Ùs
[
Ëv–
]);

1339 
	`bŒfs_»Ëa£_·th
(
·th
);

1341 
·th
->
lowe¡_Ëv–
 = 
Ëv–
;

1342 
	`£t_b™
(
BTRFS_ROOT_RESET_LOCKDEP_CLASS
, &
¤c
->
¡©e
);

1343 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
¤c
, &
key
, 
·th
, 0, 1);

1344 
	`ş—r_b™
(
BTRFS_ROOT_RESET_LOCKDEP_CLASS
, &
¤c
->
¡©e
);

1345 
·th
->
lowe¡_Ëv–
 = 0;

1346 ià(
»t
) {

1347 ià(
»t
 > 0)

1348 
»t
 = -
ENOENT
;

1366 
»t
 = 
	`bŒfs_qgroup_add_sw­³d_blocks
(
Œªs
, 
de¡
,

1367 
rc
->
block_group
, 
·»Á
, 
¦Ù
,

1368 
·th
->
nodes
[
Ëv–
],…©h->
¦Ùs
[level],

1369 
Ï¡_¢­shÙ
);

1370 ià(
»t
 < 0)

1375 
	`bŒfs_£t_node_block±r
(
·»Á
, 
¦Ù
, 
Ãw_by‹Ä
);

1376 
	`bŒfs_£t_node_±r_g’”©iÚ
(
·»Á
, 
¦Ù
, 
Ãw_±r_g’
);

1377 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·»Á
);

1379 
	`bŒfs_£t_node_block±r
(
·th
->
nodes
[
Ëv–
],

1380 
·th
->
¦Ùs
[
Ëv–
], 
Şd_by‹Ä
);

1381 
	`bŒfs_£t_node_±r_g’”©iÚ
(
·th
->
nodes
[
Ëv–
],

1382 
·th
->
¦Ùs
[
Ëv–
], 
Şd_±r_g’
);

1383 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·th
->
nodes
[
Ëv–
]);

1385 
	`bŒfs_š™_g’”ic_»f
(&
»f
, 
BTRFS_ADD_DELAYED_REF
, 
Şd_by‹Ä
,

1386 
blocksize
, 
·th
->
nodes
[
Ëv–
]->
¡¬t
);

1387 
	`bŒfs_š™_Œ“_»f
(&
»f
, 
Ëv–
 - 1, 
¤c
->
roÙ_key
.
objeùid
,

1388 0, 
Œue
);

1389 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, &
»f
);

1390 ià(
»t
) {

1391 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1394 
	`bŒfs_š™_g’”ic_»f
(&
»f
, 
BTRFS_ADD_DELAYED_REF
, 
Ãw_by‹Ä
,

1395 
blocksize
, 0);

1396 
	`bŒfs_š™_Œ“_»f
(&
»f
, 
Ëv–
 - 1, 
de¡
->
roÙ_key
.
objeùid
, 0,

1397 
Œue
);

1398 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, &
»f
);

1399 ià(
»t
) {

1400 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1404 
	`bŒfs_š™_g’”ic_»f
(&
»f
, 
BTRFS_DROP_DELAYED_REF
, 
Ãw_by‹Ä
,

1405 
blocksize
, 
·th
->
nodes
[
Ëv–
]->
¡¬t
);

1406 
	`bŒfs_š™_Œ“_»f
(&
»f
, 
Ëv–
 - 1, 
¤c
->
roÙ_key
.
objeùid
,

1407 0, 
Œue
);

1408 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, &
»f
);

1409 ià(
»t
) {

1410 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1414 
	`bŒfs_š™_g’”ic_»f
(&
»f
, 
BTRFS_DROP_DELAYED_REF
, 
Şd_by‹Ä
,

1415 
blocksize
, 0);

1416 
	`bŒfs_š™_Œ“_»f
(&
»f
, 
Ëv–
 - 1, 
de¡
->
roÙ_key
.
objeùid
,

1417 0, 
Œue
);

1418 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, &
»f
);

1419 ià(
»t
) {

1420 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1424 
	`bŒfs_uÆock_up_§ã
(
·th
, 0);

1426 
»t
 = 
Ëv–
;

1429 
	`bŒfs_Œ“_uÆock
(
·»Á
);

1430 
	`ä“_ex‹Á_bufãr
(
·»Á
);

1431  
»t
;

1432 
	}
}

1437 
nošlše_fÜ_¡ack


1438 
	$w®k_up_»loc_Œ“
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

1439 *
Ëv–
)

1441 
ex‹Á_bufãr
 *
eb
;

1442 
i
;

1443 
u64
 
Ï¡_¢­shÙ
;

1444 
u32
 
Ä™ems
;

1446 
Ï¡_¢­shÙ
 = 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
);

1448 
i
 = 0; i < *
Ëv–
; i++) {

1449 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[
i
]);

1450 
·th
->
nodes
[
i
] = 
NULL
;

1453 
i
 = *
Ëv–
; i < 
BTRFS_MAX_LEVEL
 && 
·th
->
nodes
[i]; i++) {

1454 
eb
 = 
·th
->
nodes
[
i
];

1455 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

1456 
·th
->
¦Ùs
[
i
] + 1 < 
Ä™ems
) {

1457 
·th
->
¦Ùs
[
i
]++;

1458 ià(
	`bŒfs_node_±r_g’”©iÚ
(
eb
, 
·th
->
¦Ùs
[
i
]) <=

1459 
Ï¡_¢­shÙ
)

1462 *
Ëv–
 = 
i
;

1465 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[
i
]);

1466 
·th
->
nodes
[
i
] = 
NULL
;

1469 
	}
}

1474 
nošlše_fÜ_¡ack


1475 
	$w®k_down_»loc_Œ“
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

1476 *
Ëv–
)

1478 
ex‹Á_bufãr
 *
eb
 = 
NULL
;

1479 
i
;

1480 
u64
 
±r_g’
 = 0;

1481 
u64
 
Ï¡_¢­shÙ
;

1482 
u32
 
Ä™ems
;

1484 
Ï¡_¢­shÙ
 = 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
);

1486 
i
 = *
Ëv–
; i > 0; i--) {

1487 
eb
 = 
·th
->
nodes
[
i
];

1488 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

1489 
·th
->
¦Ùs
[
i
] < 
Ä™ems
) {

1490 
±r_g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
eb
, 
·th
->
¦Ùs
[
i
]);

1491 ià(
±r_g’
 > 
Ï¡_¢­shÙ
)

1493 
·th
->
¦Ùs
[
i
]++;

1495 ià(
·th
->
¦Ùs
[
i
] >ğ
Ä™ems
) {

1496 ià(
i
 =ğ*
Ëv–
)

1498 *
Ëv–
 = 
i
 + 1;

1501 ià(
i
 == 1) {

1502 *
Ëv–
 = 
i
;

1506 
eb
 = 
	`bŒfs_»ad_node_¦Ù
Ób, 
·th
->
¦Ùs
[
i
]);

1507 ià(
	`IS_ERR
(
eb
))

1508  
	`PTR_ERR
(
eb
);

1509 
	`BUG_ON
(
	`bŒfs_h—d”_Ëv–
(
eb
è!ğ
i
 - 1);

1510 
·th
->
nodes
[
i
 - 1] = 
eb
;

1511 
·th
->
¦Ùs
[
i
 - 1] = 0;

1514 
	}
}

1520 
	$šv®id©e_ex‹Á_ÿche
(
bŒfs_roÙ
 *
roÙ
,

1521 
bŒfs_key
 *
mš_key
,

1522 
bŒfs_key
 *
max_key
)

1524 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1525 
šode
 *šodğ
NULL
;

1526 
u64
 
objeùid
;

1527 
u64
 
¡¬t
, 
’d
;

1528 
u64
 
šo
;

1530 
objeùid
 = 
mš_key
->objectid;

1532 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

1534 
	`cÚd_»sched
();

1535 
	`ut
(
šode
);

1537 ià(
objeùid
 > 
max_key
->objectid)

1540 
šode
 = 
	`fšd_Ãxt_šode
(
roÙ
, 
objeùid
);

1541 ià(!
šode
)

1543 
šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

1545 ià(
šo
 > 
max_key
->
objeùid
) {

1546 
	`ut
(
šode
);

1550 
objeùid
 = 
šo
 + 1;

1551 ià(!
	`S_ISREG
(
šode
->
i_mode
))

1554 ià(
	`uÆik–y
(
mš_key
->
objeùid
 =ğ
šo
)) {

1555 ià(
mš_key
->
ty³
 > 
BTRFS_EXTENT_DATA_KEY
)

1557 ià(
mš_key
->
ty³
 < 
BTRFS_EXTENT_DATA_KEY
)

1558 
¡¬t
 = 0;

1560 
¡¬t
 = 
mš_key
->
off£t
;

1561 
	`WARN_ON
(!
	`IS_ALIGNED
(
¡¬t
, 
fs_šfo
->
£ùÜsize
));

1564 
¡¬t
 = 0;

1567 ià(
	`uÆik–y
(
max_key
->
objeùid
 =ğ
šo
)) {

1568 ià(
max_key
->
ty³
 < 
BTRFS_EXTENT_DATA_KEY
)

1570 ià(
max_key
->
ty³
 > 
BTRFS_EXTENT_DATA_KEY
) {

1571 
’d
 = (
u64
)-1;

1573 ià(
max_key
->
off£t
 == 0)

1575 
’d
 = 
max_key
->
off£t
;

1576 
	`WARN_ON
(!
	`IS_ALIGNED
(
’d
, 
fs_šfo
->
£ùÜsize
));

1577 
’d
--;

1580 
’d
 = (
u64
)-1;

1584 
	`lock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

1585 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
	`BTRFS_I
(
šode
), 
¡¬t
, 
’d
, 
Œue
);

1586 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

1589 
	}
}

1591 
	$fšd_Ãxt_key
(
bŒfs_·th
 *
·th
, 
Ëv–
,

1592 
bŒfs_key
 *
key
)

1595 
Ëv–
 < 
BTRFS_MAX_LEVEL
) {

1596 ià(!
·th
->
nodes
[
Ëv–
])

1598 ià(
·th
->
¦Ùs
[
Ëv–
] + 1 <

1599 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[
Ëv–
])) {

1600 
	`bŒfs_node_key_to_ıu
(
·th
->
nodes
[
Ëv–
], 
key
,

1601 
·th
->
¦Ùs
[
Ëv–
] + 1);

1604 
Ëv–
++;

1607 
	}
}

1612 
	$š£¹_dœty_subvŞ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1613 
»loc_cÚŒŞ
 *
rc
,

1614 
bŒfs_roÙ
 *
roÙ
)

1616 
bŒfs_roÙ
 *
»loc_roÙ
 = 
roÙ
->reloc_root;

1617 
bŒfs_roÙ_™em
 *
»loc_roÙ_™em
;

1618 
»t
;

1621 
	`ASSERT
(
roÙ
->
roÙ_key
.
objeùid
 !ğ
BTRFS_TREE_RELOC_OBJECTID
);

1622 
	`ASSERT
(
»loc_roÙ
);

1624 
»loc_roÙ_™em
 = &
»loc_roÙ
->
roÙ_™em
;

1625 
	`mem£t
(&
»loc_roÙ_™em
->
drİ_´og»ss
, 0,

1626 (
»loc_roÙ_™em
->
drİ_´og»ss
));

1627 
	`bŒfs_£t_roÙ_drİ_Ëv–
(
»loc_roÙ_™em
, 0);

1628 
	`bŒfs_£t_roÙ_»fs
(
»loc_roÙ_™em
, 0);

1629 
»t
 = 
	`bŒfs_upd©e_»loc_roÙ
(
Œªs
, 
roÙ
);

1630 ià(
»t
)

1631  
»t
;

1633 ià(
	`li¡_em±y
(&
roÙ
->
»loc_dœty_li¡
)) {

1634 
	`bŒfs_g¿b_roÙ
(
roÙ
);

1635 
	`li¡_add_
(&
roÙ
->
»loc_dœty_li¡
, &
rc
->
dœty_subvŞ_roÙs
);

1639 
	}
}

1641 
	$ş—n_dœty_subvŞs
(
»loc_cÚŒŞ
 *
rc
)

1643 
bŒfs_roÙ
 *
roÙ
;

1644 
bŒfs_roÙ
 *
Ãxt
;

1645 
»t
 = 0;

1646 
»t2
;

1648 
	`li¡_fÜ_—ch_’Œy_§ã
(
roÙ
, 
Ãxt
, &
rc
->
dœty_subvŞ_roÙs
,

1649 
»loc_dœty_li¡
) {

1650 ià(
roÙ
->
roÙ_key
.
objeùid
 !ğ
BTRFS_TREE_RELOC_OBJECTID
) {

1652 
bŒfs_roÙ
 *
»loc_roÙ
 = 
roÙ
->reloc_root;

1654 
	`li¡_d–_š™
(&
roÙ
->
»loc_dœty_li¡
);

1655 
roÙ
->
»loc_roÙ
 = 
NULL
;

1660 
	`smp_wmb
();

1661 
	`ş—r_b™
(
BTRFS_ROOT_DEAD_RELOC_TREE
, &
roÙ
->
¡©e
);

1662 ià(
»loc_roÙ
) {

1668 
»t2
 = 
	`bŒfs_drİ_¢­shÙ
(
»loc_roÙ
, 0, 1);

1669 ià(
»t2
 < 0) {

1670 
	`bŒfs_put_roÙ
(
»loc_roÙ
);

1671 ià(!
»t
)

1672 
»t
 = 
»t2
;

1675 
	`bŒfs_put_roÙ
(
roÙ
);

1678 
»t2
 = 
	`bŒfs_drİ_¢­shÙ
(
roÙ
, 0, 1);

1679 ià(
»t2
 < 0) {

1680 
	`bŒfs_put_roÙ
(
roÙ
);

1681 ià(!
»t
)

1682 
»t
 = 
»t2
;

1686  
»t
;

1687 
	}
}

1693 
nošlše_fÜ_¡ack
 
	$m”ge_»loc_roÙ
(
»loc_cÚŒŞ
 *
rc
,

1694 
bŒfs_roÙ
 *
roÙ
)

1696 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

1697 
bŒfs_key
 
key
;

1698 
bŒfs_key
 
Ãxt_key
;

1699 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

1700 
bŒfs_roÙ
 *
»loc_roÙ
;

1701 
bŒfs_roÙ_™em
 *
roÙ_™em
;

1702 
bŒfs_·th
 *
·th
;

1703 
ex‹Á_bufãr
 *
Ëaf
;

1704 
»£rve_Ëv–
;

1705 
Ëv–
;

1706 
max_Ëv–
;

1707 
»¶aûd
 = 0;

1708 
»t
 = 0;

1709 
u32
 
mš_»£rved
;

1711 
·th
 = 
	`bŒfs_®loc_·th
();

1712 ià(!
·th
)

1713  -
ENOMEM
;

1714 
·th
->
»ada
 = 
READA_FORWARD
;

1716 
»loc_roÙ
 = 
roÙ
->reloc_root;

1717 
roÙ_™em
 = &
»loc_roÙ
->root_item;

1719 ià(
	`bŒfs_disk_key_objeùid
(&
roÙ_™em
->
drİ_´og»ss
) == 0) {

1720 
Ëv–
 = 
	`bŒfs_roÙ_Ëv–
(
roÙ_™em
);

1721 
	`©omic_šc
(&
»loc_roÙ
->
node
->
»fs
);

1722 
·th
->
nodes
[
Ëv–
] = 
»loc_roÙ
->
node
;

1723 
·th
->
¦Ùs
[
Ëv–
] = 0;

1725 
	`bŒfs_disk_key_to_ıu
(&
key
, &
roÙ_™em
->
drİ_´og»ss
);

1727 
Ëv–
 = 
	`bŒfs_roÙ_drİ_Ëv–
(
roÙ_™em
);

1728 
	`BUG_ON
(
Ëv–
 == 0);

1729 
·th
->
lowe¡_Ëv–
 = 
Ëv–
;

1730 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
»loc_roÙ
, &
key
, 
·th
, 0, 0);

1731 
·th
->
lowe¡_Ëv–
 = 0;

1732 ià(
»t
 < 0) {

1733 
	`bŒfs_ä“_·th
(
·th
);

1734  
»t
;

1737 
	`bŒfs_node_key_to_ıu
(
·th
->
nodes
[
Ëv–
], &
Ãxt_key
,

1738 
·th
->
¦Ùs
[
Ëv–
]);

1739 
	`WARN_ON
(
	`memcmp
(&
key
, &
Ãxt_key
, (key)));

1741 
	`bŒfs_uÆock_up_§ã
(
·th
, 0);

1752 
»£rve_Ëv–
 = 
	`max_t
(, 1, 
	`bŒfs_roÙ_Ëv–
(
roÙ_™em
));

1753 
mš_»£rved
 = 
fs_šfo
->
nodesize
 * 
»£rve_Ëv–
 * 2;

1754 
	`mem£t
(&
Ãxt_key
, 0, (next_key));

1757 
»t
 = 
	`bŒfs_block_rsv_»fl
(
fs_šfo
, 
rc
->
block_rsv
,

1758 
mš_»£rved
,

1759 
BTRFS_RESERVE_FLUSH_LIMIT
);

1760 ià(
»t
)

1761 
out
;

1762 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

1763 ià(
	`IS_ERR
(
Œªs
)) {

1764 
»t
 = 
	`PTR_ERR
(
Œªs
);

1765 
Œªs
 = 
NULL
;

1766 
out
;

1779 
»loc_roÙ
->
Ï¡_Œªs
 = 
Œªs
->
Œªsid
;

1780 
Œªs
->
block_rsv
 = 
rc
->block_rsv;

1782 
»¶aûd
 = 0;

1783 
max_Ëv–
 = 
Ëv–
;

1785 
»t
 = 
	`w®k_down_»loc_Œ“
(
»loc_roÙ
, 
·th
, &
Ëv–
);

1786 ià(
»t
 < 0)

1787 
out
;

1788 ià(
»t
 > 0)

1791 ià(!
	`fšd_Ãxt_key
(
·th
, 
Ëv–
, &
key
) &&

1792 
	`bŒfs_comp_ıu_keys
(&
Ãxt_key
, &
key
) >= 0) {

1793 
»t
 = 0;

1795 
»t
 = 
	`»¶aû_·th
(
Œªs
, 
rc
, 
roÙ
, 
»loc_roÙ
, 
·th
,

1796 &
Ãxt_key
, 
Ëv–
, 
max_Ëv–
);

1798 ià(
»t
 < 0)

1799 
out
;

1800 ià(
»t
 > 0) {

1801 
Ëv–
 = 
»t
;

1802 
	`bŒfs_node_key_to_ıu
(
·th
->
nodes
[
Ëv–
], &
key
,

1803 
·th
->
¦Ùs
[
Ëv–
]);

1804 
»¶aûd
 = 1;

1807 
»t
 = 
	`w®k_up_»loc_Œ“
(
»loc_roÙ
, 
·th
, &
Ëv–
);

1808 ià(
»t
 > 0)

1811 
	`BUG_ON
(
Ëv–
 == 0);

1816 
	`bŒfs_node_key
(
·th
->
nodes
[
Ëv–
], &
roÙ_™em
->
drİ_´og»ss
,

1817 
·th
->
¦Ùs
[
Ëv–
]);

1818 
	`bŒfs_£t_roÙ_drİ_Ëv–
(
roÙ_™em
, 
Ëv–
);

1820 
	`bŒfs_’d_Œª§ùiÚ_thrÙe
(
Œªs
);

1821 
Œªs
 = 
NULL
;

1823 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

1825 ià(
»¶aûd
 && 
rc
->
¡age
 =ğ
UPDATE_DATA_PTRS
)

1826 
	`šv®id©e_ex‹Á_ÿche
(
roÙ
, &
key
, &
Ãxt_key
);

1833 
Ëaf
 = 
	`bŒfs_lock_roÙ_node
(
roÙ
);

1834 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
Ëaf
, 
NULL
, 0, &leaf,

1835 
BTRFS_NESTING_COW
);

1836 
	`bŒfs_Œ“_uÆock
(
Ëaf
);

1837 
	`ä“_ex‹Á_bufãr
(
Ëaf
);

1838 
out
:

1839 
	`bŒfs_ä“_·th
(
·th
);

1841 ià(
»t
 == 0) {

1842 
»t
 = 
	`š£¹_dœty_subvŞ
(
Œªs
, 
rc
, 
roÙ
);

1843 ià(
»t
)

1844 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1847 ià(
Œªs
)

1848 
	`bŒfs_’d_Œª§ùiÚ_thrÙe
(
Œªs
);

1850 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

1852 ià(
»¶aûd
 && 
rc
->
¡age
 =ğ
UPDATE_DATA_PTRS
)

1853 
	`šv®id©e_ex‹Á_ÿche
(
roÙ
, &
key
, &
Ãxt_key
);

1855  
»t
;

1856 
	}
}

1858 
nošlše_fÜ_¡ack


1859 
	$´•¬e_to_m”ge
(
»loc_cÚŒŞ
 *
rc
, 
”r
)

1861 
bŒfs_roÙ
 *
roÙ
 = 
rc
->
ex‹Á_roÙ
;

1862 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1863 
bŒfs_roÙ
 *
»loc_roÙ
;

1864 
bŒfs_Œªs_hªdË
 *
Œªs
;

1865 
	`LIST_HEAD
(
»loc_roÙs
);

1866 
u64
 
num_by‹s
 = 0;

1867 
»t
;

1869 
	`mu‹x_lock
(&
fs_šfo
->
»loc_mu‹x
);

1870 
rc
->
m”gšg_rsv_size
 +ğ
fs_šfo
->
nodesize
 * (
BTRFS_MAX_LEVEL
 - 1) * 2;

1871 
rc
->
m”gšg_rsv_size
 +ğrc->
nodes_»loÿ‹d
 * 2;

1872 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

1874 
agaš
:

1875 ià(!
”r
) {

1876 
num_by‹s
 = 
rc
->
m”gšg_rsv_size
;

1877 
»t
 = 
	`bŒfs_block_rsv_add
(
fs_šfo
, 
rc
->
block_rsv
, 
num_by‹s
,

1878 
BTRFS_RESERVE_FLUSH_ALL
);

1879 ià(
»t
)

1880 
”r
 = 
»t
;

1883 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
rc
->
ex‹Á_roÙ
);

1884 ià(
	`IS_ERR
(
Œªs
)) {

1885 ià(!
”r
)

1886 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rc
->
block_rsv
,

1887 
num_by‹s
, 
NULL
);

1888  
	`PTR_ERR
(
Œªs
);

1891 ià(!
”r
) {

1892 ià(
num_by‹s
 !ğ
rc
->
m”gšg_rsv_size
) {

1893 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1894 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rc
->
block_rsv
,

1895 
num_by‹s
, 
NULL
);

1896 
agaš
;

1900 
rc
->
m”ge_»loc_Œ“
 = 1;

1902 !
	`li¡_em±y
(&
rc
->
»loc_roÙs
)) {

1903 
»loc_roÙ
 = 
	`li¡_’Œy
(
rc
->
»loc_roÙs
.
Ãxt
,

1904 
bŒfs_roÙ
, 
roÙ_li¡
);

1905 
	`li¡_d–_š™
(&
»loc_roÙ
->
roÙ_li¡
);

1907 
roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
»loc_roÙ
->
roÙ_key
.
off£t
,

1908 
çl£
);

1909 ià(
	`IS_ERR
(
roÙ
)) {

1914 
	`li¡_add
(&
»loc_roÙ
->
roÙ_li¡
, &
»loc_roÙs
);

1915 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, ()
	`PTR_ERR
(
roÙ
));

1916 ià(!
”r
)

1917 
”r
 = 
	`PTR_ERR
(
roÙ
);

1921 ià(
	`uÆik–y
(
roÙ
->
»loc_roÙ
 !=„eloc_root)) {

1922 ià(
roÙ
->
»loc_roÙ
) {

1923 
	`bŒfs_”r
(
fs_šfo
,

1925 
roÙ
->
roÙ_key
.
objeùid
,

1926 
roÙ
->
»loc_roÙ
->
roÙ_key
.
objeùid
,

1927 
roÙ
->
»loc_roÙ
->
roÙ_key
.
ty³
,

1928 
roÙ
->
»loc_roÙ
->
roÙ_key
.
off£t
,

1929 
	`bŒfs_roÙ_g’”©iÚ
(

1930 &
roÙ
->
»loc_roÙ
->
roÙ_™em
),

1931 
»loc_roÙ
->
roÙ_key
.
objeùid
,

1932 
»loc_roÙ
->
roÙ_key
.
ty³
,

1933 
»loc_roÙ
->
roÙ_key
.
off£t
,

1934 
	`bŒfs_roÙ_g’”©iÚ
(

1935 &
»loc_roÙ
->
roÙ_™em
));

1937 
	`bŒfs_”r
(
fs_šfo
,

1939 
roÙ
->
roÙ_key
.
objeùid
,

1940 
»loc_roÙ
->
roÙ_key
.
objeùid
,

1941 
»loc_roÙ
->
roÙ_key
.
ty³
,

1942 
»loc_roÙ
->
roÙ_key
.
off£t
,

1943 
	`bŒfs_roÙ_g’”©iÚ
(

1944 &
»loc_roÙ
->
roÙ_™em
));

1946 
	`li¡_add
(&
»loc_roÙ
->
roÙ_li¡
, &
»loc_roÙs
);

1947 
	`bŒfs_put_roÙ
(
roÙ
);

1948 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, -
EUCLEAN
);

1949 ià(!
”r
)

1950 
”r
 = -
EUCLEAN
;

1958 ià(!
”r
)

1959 
	`bŒfs_£t_roÙ_»fs
(&
»loc_roÙ
->
roÙ_™em
, 1);

1960 
»t
 = 
	`bŒfs_upd©e_»loc_roÙ
(
Œªs
, 
roÙ
);

1966 
	`li¡_add
(&
»loc_roÙ
->
roÙ_li¡
, &
»loc_roÙs
);

1967 
	`bŒfs_put_roÙ
(
roÙ
);

1969 ià(
»t
) {

1970 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1971 ià(!
”r
)

1972 
”r
 = 
»t
;

1977 
	`li¡_¥liû
(&
»loc_roÙs
, &
rc
->reloc_roots);

1979 ià(!
”r
)

1980 
”r
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1982 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1983  
”r
;

1984 
	}
}

1986 
nošlše_fÜ_¡ack


1987 
	$ä“_»loc_roÙs
(
li¡_h—d
 *
li¡
)

1989 
bŒfs_roÙ
 *
»loc_roÙ
, *
tmp
;

1991 
	`li¡_fÜ_—ch_’Œy_§ã
(
»loc_roÙ
, 
tmp
, 
li¡
, 
roÙ_li¡
)

1992 
	`__d–_»loc_roÙ
(
»loc_roÙ
);

1993 
	}
}

1995 
nošlše_fÜ_¡ack


1996 
	$m”ge_»loc_roÙs
(
»loc_cÚŒŞ
 *
rc
)

1998 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

1999 
bŒfs_roÙ
 *
roÙ
;

2000 
bŒfs_roÙ
 *
»loc_roÙ
;

2001 
	`LIST_HEAD
(
»loc_roÙs
);

2002 
found
 = 0;

2003 
»t
 = 0;

2004 
agaš
:

2005 
roÙ
 = 
rc
->
ex‹Á_roÙ
;

2013 
	`mu‹x_lock
(&
fs_šfo
->
»loc_mu‹x
);

2014 
	`li¡_¥liû_š™
(&
rc
->
»loc_roÙs
, &reloc_roots);

2015 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

2017 !
	`li¡_em±y
(&
»loc_roÙs
)) {

2018 
found
 = 1;

2019 
»loc_roÙ
 = 
	`li¡_’Œy
(
»loc_roÙs
.
Ãxt
,

2020 
bŒfs_roÙ
, 
roÙ_li¡
);

2022 
roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
»loc_roÙ
->
roÙ_key
.
off£t
,

2023 
çl£
);

2024 ià(
	`bŒfs_roÙ_»fs
(&
»loc_roÙ
->
roÙ_™em
) > 0) {

2025 ià(
	`WARN_ON
(
	`IS_ERR
(
roÙ
))) {

2034 
»t
 = 
	`PTR_ERR
(
roÙ
);

2035 
out
;

2037 ià(
	`WARN_ON
(
roÙ
->
»loc_roÙ
 !=„eloc_root)) {

2042 
»t
 = -
EINVAL
;

2043 
out
;

2045 
»t
 = 
	`m”ge_»loc_roÙ
(
rc
, 
roÙ
);

2046 
	`bŒfs_put_roÙ
(
roÙ
);

2047 ià(
»t
) {

2048 ià(
	`li¡_em±y
(&
»loc_roÙ
->
roÙ_li¡
))

2049 
	`li¡_add_
(&
»loc_roÙ
->
roÙ_li¡
,

2050 &
»loc_roÙs
);

2051 
out
;

2054 ià(!
	`IS_ERR
(
roÙ
)) {

2055 ià(
roÙ
->
»loc_roÙ
 ==„eloc_root) {

2056 
roÙ
->
»loc_roÙ
 = 
NULL
;

2057 
	`bŒfs_put_roÙ
(
»loc_roÙ
);

2059 
	`ş—r_b™
(
BTRFS_ROOT_DEAD_RELOC_TREE
,

2060 &
roÙ
->
¡©e
);

2061 
	`bŒfs_put_roÙ
(
roÙ
);

2064 
	`li¡_d–_š™
(&
»loc_roÙ
->
roÙ_li¡
);

2066 
	`li¡_add_
(&
»loc_roÙ
->
»loc_dœty_li¡
,

2067 &
rc
->
dœty_subvŞ_roÙs
);

2071 ià(
found
) {

2072 
found
 = 0;

2073 
agaš
;

2075 
out
:

2076 ià(
»t
) {

2077 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
, 
NULL
);

2078 
	`ä“_»loc_roÙs
(&
»loc_roÙs
);

2081 
	`mu‹x_lock
(&
fs_šfo
->
»loc_mu‹x
);

2082 
	`li¡_¥liû_š™
(&
rc
->
»loc_roÙs
, &reloc_roots);

2083 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

2084 
	`ä“_»loc_roÙs
(&
»loc_roÙs
);

2102 
	}
}

2104 
	$ä“_block_li¡
(
rb_roÙ
 *
blocks
)

2106 
Œ“_block
 *
block
;

2107 
rb_node
 *rb_node;

2108 (
rb_node
 = 
	`rb_fœ¡
(
blocks
))) {

2109 
block
 = 
	`rb_’Œy
(
rb_node
, 
Œ“_block
,„b_node);

2110 
	`rb_”a£
(
rb_node
, 
blocks
);

2111 
	`kä“
(
block
);

2113 
	}
}

2115 
	$»cÜd_»loc_roÙ_š_Œªs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2116 
bŒfs_roÙ
 *
»loc_roÙ
)

2118 
bŒfs_fs_šfo
 *
fs_šfo
 = 
»loc_roÙ
->fs_info;

2119 
bŒfs_roÙ
 *
roÙ
;

2120 
»t
;

2122 ià(
»loc_roÙ
->
Ï¡_Œªs
 =ğ
Œªs
->
Œªsid
)

2125 
roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
»loc_roÙ
->
roÙ_key
.
off£t
, 
çl£
);

2135 ià(
	`IS_ERR
(
roÙ
)) {

2136 
	`ASSERT
(0);

2137  
	`PTR_ERR
(
roÙ
);

2139 ià(
roÙ
->
»loc_roÙ
 !=„eloc_root) {

2140 
	`ASSERT
(0);

2141 
	`bŒfs_”r
(
fs_šfo
,

2143 
»loc_roÙ
->
roÙ_key
.
off£t
);

2144 
	`bŒfs_put_roÙ
(
roÙ
);

2145  -
EUCLEAN
;

2147 
»t
 = 
	`bŒfs_»cÜd_roÙ_š_Œªs
(
Œªs
, 
roÙ
);

2148 
	`bŒfs_put_roÙ
(
roÙ
);

2150  
»t
;

2151 
	}
}

2153 
nošlše_fÜ_¡ack


2154 
bŒfs_roÙ
 *
	$£Ëù_»loc_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2155 
»loc_cÚŒŞ
 *
rc
,

2156 
bŒfs_back»f_node
 *
node
,

2157 
bŒfs_back»f_edge
 *
edges
[])

2159 
bŒfs_back»f_node
 *
Ãxt
;

2160 
bŒfs_roÙ
 *
roÙ
;

2161 
šdex
 = 0;

2162 
»t
;

2164 
Ãxt
 = 
node
;

2166 
	`cÚd_»sched
();

2167 
Ãxt
 = 
	`w®k_up_back»f
Òext, 
edges
, &
šdex
);

2168 
roÙ
 = 
Ãxt
->root;

2182 ià(!
roÙ
) {

2183 
	`ASSERT
(0);

2184 
	`bŒfs_”r
(
Œªs
->
fs_šfo
,

2186 
node
->
by‹Ä
);

2187  
	`ERR_PTR
(-
EUCLEAN
);

2189 ià(!
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
)) {

2190 
	`ASSERT
(0);

2191 
	`bŒfs_”r
(
Œªs
->
fs_šfo
,

2193 
node
->
by‹Ä
);

2194  
	`ERR_PTR
(-
EUCLEAN
);

2197 ià(
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
) {

2198 
»t
 = 
	`»cÜd_»loc_roÙ_š_Œªs
(
Œªs
, 
roÙ
);

2199 ià(
»t
)

2200  
	`ERR_PTR
(
»t
);

2204 
»t
 = 
	`bŒfs_»cÜd_roÙ_š_Œªs
(
Œªs
, 
roÙ
);

2205 ià(
»t
)

2206  
	`ERR_PTR
(
»t
);

2207 
roÙ
 =„oÙ->
»loc_roÙ
;

2213 ià(!
roÙ
)

2214  
	`ERR_PTR
(-
ENOENT
);

2216 ià(
Ãxt
->
Ãw_by‹Ä
 !ğ
roÙ
->
node
->
¡¬t
) {

2224 
	`ASSERT
(
Ãxt
->
Ãw_by‹Ä
 == 0);

2225 
	`ASSERT
(
	`li¡_em±y
(&
Ãxt
->
li¡
));

2226 ià(
Ãxt
->
Ãw_by‹Ä
 || !
	`li¡_em±y
(&Ãxt->
li¡
)) {

2227 
	`bŒfs_”r
(
Œªs
->
fs_šfo
,

2229 
node
->
by‹Ä
, 
Ãxt
->bytenr);

2230  
	`ERR_PTR
(-
EUCLEAN
);

2233 
Ãxt
->
Ãw_by‹Ä
 = 
roÙ
->
node
->
¡¬t
;

2234 
	`bŒfs_put_roÙ
(
Ãxt
->
roÙ
);

2235 
Ãxt
->
roÙ
 = 
	`bŒfs_g¿b_roÙ
(root);

2236 
	`ASSERT
(
Ãxt
->
roÙ
);

2237 
	`li¡_add_
(&
Ãxt
->
li¡
,

2238 &
rc
->
back»f_ÿche
.
chªged
);

2239 
	`m¬k_block_´oûs£d
(
rc
, 
Ãxt
);

2243 
	`WARN_ON
(1);

2244 
roÙ
 = 
NULL
;

2245 
Ãxt
 = 
	`w®k_down_back»f
(
edges
, &
šdex
);

2246 ià(!
Ãxt
 ||‚ext->
Ëv–
 <ğ
node
->level)

2249 ià(!
roÙ
) {

2254 
	`ASSERT
(0);

2255  
	`ERR_PTR
(-
ENOENT
);

2258 
Ãxt
 = 
node
;

2261 
rc
->
back»f_ÿche
.
·th
[
Ãxt
->
Ëv–
] =‚ext;

2262 ià(--
šdex
 < 0)

2264 
Ãxt
 = 
edges
[
šdex
]->
node
[
UPPER
];

2266  
roÙ
;

2267 
	}
}

2278 
nošlše_fÜ_¡ack


2279 
bŒfs_roÙ
 *
	$£Ëù_Úe_roÙ
(
bŒfs_back»f_node
 *
node
)

2281 
bŒfs_back»f_node
 *
Ãxt
;

2282 
bŒfs_roÙ
 *
roÙ
;

2283 
bŒfs_roÙ
 *
fs_roÙ
 = 
NULL
;

2284 
bŒfs_back»f_edge
 *
edges
[
BTRFS_MAX_LEVEL
 - 1];

2285 
šdex
 = 0;

2287 
Ãxt
 = 
node
;

2289 
	`cÚd_»sched
();

2290 
Ãxt
 = 
	`w®k_up_back»f
Òext, 
edges
, &
šdex
);

2291 
roÙ
 = 
Ãxt
->root;

2297 ià(!
roÙ
)

2298  
	`ERR_PTR
(-
EUCLEAN
);

2301 ià(!
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
))

2302  
roÙ
;

2304 ià(
roÙ
->
roÙ_key
.
objeùid
 !ğ
BTRFS_TREE_RELOC_OBJECTID
)

2305 
fs_roÙ
 = 
roÙ
;

2307 ià(
Ãxt
 !ğ
node
)

2308  
NULL
;

2310 
Ãxt
 = 
	`w®k_down_back»f
(
edges
, &
šdex
);

2311 ià(!
Ãxt
 ||‚ext->
Ëv–
 <ğ
node
->level)

2315 ià(!
fs_roÙ
)

2316  
	`ERR_PTR
(-
ENOENT
);

2317  
fs_roÙ
;

2318 
	}
}

2320 
nošlše_fÜ_¡ack


2321 
u64
 
	$ÿlcu_m‘ad©a_size
(
»loc_cÚŒŞ
 *
rc
,

2322 
bŒfs_back»f_node
 *
node
, 
»£rve
)

2324 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

2325 
bŒfs_back»f_node
 *
Ãxt
 = 
node
;

2326 
bŒfs_back»f_edge
 *
edge
;

2327 
bŒfs_back»f_edge
 *
edges
[
BTRFS_MAX_LEVEL
 - 1];

2328 
u64
 
num_by‹s
 = 0;

2329 
šdex
 = 0;

2331 
	`BUG_ON
(
»£rve
 && 
node
->
´oûs£d
);

2333 
Ãxt
) {

2334 
	`cÚd_»sched
();

2336 ià(
Ãxt
->
´oûs£d
 && (
»£rve
 ||‚exˆ!ğ
node
))

2339 
num_by‹s
 +ğ
fs_šfo
->
nodesize
;

2341 ià(
	`li¡_em±y
(&
Ãxt
->
uµ”
))

2344 
edge
 = 
	`li¡_’Œy
(
Ãxt
->
uµ”
.next,

2345 
bŒfs_back»f_edge
, 
li¡
[
LOWER
]);

2346 
edges
[
šdex
++] = 
edge
;

2347 
Ãxt
 = 
edge
->
node
[
UPPER
];

2349 
Ãxt
 = 
	`w®k_down_back»f
(
edges
, &
šdex
);

2351  
num_by‹s
;

2352 
	}
}

2354 
	$»£rve_m‘ad©a_¥aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2355 
»loc_cÚŒŞ
 *
rc
,

2356 
bŒfs_back»f_node
 *
node
)

2358 
bŒfs_roÙ
 *
roÙ
 = 
rc
->
ex‹Á_roÙ
;

2359 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2360 
u64
 
num_by‹s
;

2361 
»t
;

2362 
u64
 
tmp
;

2364 
num_by‹s
 = 
	`ÿlcu_m‘ad©a_size
(
rc
, 
node
, 1) * 2;

2366 
Œªs
->
block_rsv
 = 
rc
->block_rsv;

2367 
rc
->
»£rved_by‹s
 +ğ
num_by‹s
;

2374 
»t
 = 
	`bŒfs_block_rsv_»fl
(
fs_šfo
, 
rc
->
block_rsv
, 
num_by‹s
,

2375 
BTRFS_RESERVE_FLUSH_LIMIT
);

2376 ià(
»t
) {

2377 
tmp
 = 
fs_šfo
->
nodesize
 * 
RELOCATION_RESERVED_NODES
;

2378 
tmp
 <ğ
rc
->
»£rved_by‹s
)

2379 
tmp
 <<= 1;

2387 
rc
->
block_rsv
->
size
 = 
tmp
 + 
fs_šfo
->
nodesize
 *

2388 
RELOCATION_RESERVED_NODES
;

2389  -
EAGAIN
;

2393 
	}
}

2402 
	$do_»loÿtiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2403 
»loc_cÚŒŞ
 *
rc
,

2404 
bŒfs_back»f_node
 *
node
,

2405 
bŒfs_key
 *
key
,

2406 
bŒfs_·th
 *
·th
, 
lowe¡
)

2408 
bŒfs_back»f_node
 *
uµ”
;

2409 
bŒfs_back»f_edge
 *
edge
;

2410 
bŒfs_back»f_edge
 *
edges
[
BTRFS_MAX_LEVEL
 - 1];

2411 
bŒfs_roÙ
 *
roÙ
;

2412 
ex‹Á_bufãr
 *
eb
;

2413 
u32
 
blocksize
;

2414 
u64
 
by‹Ä
;

2415 
¦Ù
;

2416 
»t
 = 0;

2422 
	`ASSERT
(!
lowe¡
 || !
node
->
eb
);

2424 
·th
->
lowe¡_Ëv–
 = 
node
->
Ëv–
 + 1;

2425 
rc
->
back»f_ÿche
.
·th
[
node
->
Ëv–
] =‚ode;

2426 
	`li¡_fÜ_—ch_’Œy
(
edge
, &
node
->
uµ”
, 
li¡
[
LOWER
]) {

2427 
bŒfs_»f
 
»f
 = { 0 };

2429 
	`cÚd_»sched
();

2431 
uµ”
 = 
edge
->
node
[
UPPER
];

2432 
roÙ
 = 
	`£Ëù_»loc_roÙ
(
Œªs
, 
rc
, 
uµ”
, 
edges
);

2433 ià(
	`IS_ERR
(
roÙ
)) {

2434 
»t
 = 
	`PTR_ERR
(
roÙ
);

2435 
Ãxt
;

2438 ià(
uµ”
->
eb
 && !uµ”->
locked
) {

2439 ià(!
lowe¡
) {

2440 
»t
 = 
	`bŒfs_bš_£¬ch
(
uµ”
->
eb
, 0, 
key
, &
¦Ù
);

2441 ià(
»t
 < 0)

2442 
Ãxt
;

2443 
	`BUG_ON
(
»t
);

2444 
by‹Ä
 = 
	`bŒfs_node_block±r
(
uµ”
->
eb
, 
¦Ù
);

2445 ià(
node
->
eb
->
¡¬t
 =ğ
by‹Ä
)

2446 
Ãxt
;

2448 
	`bŒfs_back»f_drİ_node_bufãr
(
uµ”
);

2451 ià(!
uµ”
->
eb
) {

2452 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, 
key
, 
·th
, 0, 1);

2453 ià(
»t
) {

2454 ià(
»t
 > 0)

2455 
»t
 = -
ENOENT
;

2457 
	`bŒfs_»Ëa£_·th
(
·th
);

2461 ià(!
uµ”
->
eb
) {

2462 
uµ”
->
eb
 = 
·th
->
nodes
[uµ”->
Ëv–
];

2463 
·th
->
nodes
[
uµ”
->
Ëv–
] = 
NULL
;

2465 
	`BUG_ON
(
uµ”
->
eb
 !ğ
·th
->
nodes
[uµ”->
Ëv–
]);

2468 
uµ”
->
locked
 = 1;

2469 
·th
->
locks
[
uµ”
->
Ëv–
] = 0;

2471 
¦Ù
 = 
·th
->
¦Ùs
[
uµ”
->
Ëv–
];

2472 
	`bŒfs_»Ëa£_·th
(
·th
);

2474 
»t
 = 
	`bŒfs_bš_£¬ch
(
uµ”
->
eb
, 0, 
key
, &
¦Ù
);

2475 ià(
»t
 < 0)

2476 
Ãxt
;

2477 
	`BUG_ON
(
»t
);

2480 
by‹Ä
 = 
	`bŒfs_node_block±r
(
uµ”
->
eb
, 
¦Ù
);

2481 ià(
lowe¡
) {

2482 ià(
by‹Ä
 !ğ
node
->bytenr) {

2483 
	`bŒfs_”r
(
roÙ
->
fs_šfo
,

2485 
by‹Ä
, 
node
->by‹Ä, 
¦Ù
,

2486 
uµ”
->
eb
->
¡¬t
);

2487 
»t
 = -
EIO
;

2488 
Ãxt
;

2491 ià(
node
->
eb
->
¡¬t
 =ğ
by‹Ä
)

2492 
Ãxt
;

2495 
blocksize
 = 
roÙ
->
fs_šfo
->
nodesize
;

2496 
eb
 = 
	`bŒfs_»ad_node_¦Ù
(
uµ”
->eb, 
¦Ù
);

2497 ià(
	`IS_ERR
(
eb
)) {

2498 
»t
 = 
	`PTR_ERR
(
eb
);

2499 
Ãxt
;

2501 
	`bŒfs_Œ“_lock
(
eb
);

2503 ià(!
node
->
eb
) {

2504 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
eb
, 
uµ”
->eb,

2505 
¦Ù
, &
eb
, 
BTRFS_NESTING_COW
);

2506 
	`bŒfs_Œ“_uÆock
(
eb
);

2507 
	`ä“_ex‹Á_bufãr
(
eb
);

2508 ià(
»t
 < 0)

2509 
Ãxt
;

2514 
	`ASSERT
(
node
->
eb
 ==ƒb);

2516 
	`bŒfs_£t_node_block±r
(
uµ”
->
eb
, 
¦Ù
,

2517 
node
->
eb
->
¡¬t
);

2518 
	`bŒfs_£t_node_±r_g’”©iÚ
(
uµ”
->
eb
, 
¦Ù
,

2519 
Œªs
->
Œªsid
);

2520 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
uµ”
->
eb
);

2522 
	`bŒfs_š™_g’”ic_»f
(&
»f
, 
BTRFS_ADD_DELAYED_REF
,

2523 
node
->
eb
->
¡¬t
, 
blocksize
,

2524 
uµ”
->
eb
->
¡¬t
);

2525 
	`bŒfs_š™_Œ“_»f
(&
»f
, 
node
->
Ëv–
,

2526 
	`bŒfs_h—d”_owÃr
(
uµ”
->
eb
),

2527 
roÙ
->
roÙ_key
.
objeùid
, 
çl£
);

2528 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, &
»f
);

2529 ià(!
»t
)

2530 
»t
 = 
	`bŒfs_drİ_subŒ“
(
Œªs
, 
roÙ
, 
eb
,

2531 
uµ”
->
eb
);

2532 ià(
»t
)

2533 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2535 
Ãxt
:

2536 ià(!
uµ”
->
³ndšg
)

2537 
	`bŒfs_back»f_drİ_node_bufãr
(
uµ”
);

2539 
	`bŒfs_back»f_uÆock_node_bufãr
(
uµ”
);

2540 ià(
»t
)

2544 ià(!
»t
 && 
node
->
³ndšg
) {

2545 
	`bŒfs_back»f_drİ_node_bufãr
(
node
);

2546 
	`li¡_move_
(&
node
->
li¡
, &
rc
->
back»f_ÿche
.
chªged
);

2547 
node
->
³ndšg
 = 0;

2550 
·th
->
lowe¡_Ëv–
 = 0;

2556 
	`ASSERT
(
»t
 !ğ-
ENOSPC
);

2557  
»t
;

2558 
	}
}

2560 
	$lšk_to_uµ”
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2561 
»loc_cÚŒŞ
 *
rc
,

2562 
bŒfs_back»f_node
 *
node
,

2563 
bŒfs_·th
 *
·th
)

2565 
bŒfs_key
 
key
;

2567 
	`bŒfs_node_key_to_ıu
(
node
->
eb
, &
key
, 0);

2568  
	`do_»loÿtiÚ
(
Œªs
, 
rc
, 
node
, &
key
, 
·th
, 0);

2569 
	}
}

2571 
	$fšish_³ndšg_nodes
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2572 
»loc_cÚŒŞ
 *
rc
,

2573 
bŒfs_·th
 *
·th
, 
”r
)

2575 
	`LIST_HEAD
(
li¡
);

2576 
bŒfs_back»f_ÿche
 *
ÿche
 = &
rc
->
back»f_ÿche
;

2577 
bŒfs_back»f_node
 *
node
;

2578 
Ëv–
;

2579 
»t
;

2581 
Ëv–
 = 0;†ev– < 
BTRFS_MAX_LEVEL
;†evel++) {

2582 !
	`li¡_em±y
(&
ÿche
->
³ndšg
[
Ëv–
])) {

2583 
node
 = 
	`li¡_’Œy
(
ÿche
->
³ndšg
[
Ëv–
].
Ãxt
,

2584 
bŒfs_back»f_node
, 
li¡
);

2585 
	`li¡_move_
(&
node
->
li¡
, &list);

2586 
	`BUG_ON
(!
node
->
³ndšg
);

2588 ià(!
”r
) {

2589 
»t
 = 
	`lšk_to_uµ”
(
Œªs
, 
rc
, 
node
, 
·th
);

2590 ià(
»t
 < 0)

2591 
”r
 = 
»t
;

2594 
	`li¡_¥liû_š™
(&
li¡
, &
ÿche
->
³ndšg
[
Ëv–
]);

2596  
”r
;

2597 
	}
}

2603 
	$upd©e_´oûs£d_blocks
(
»loc_cÚŒŞ
 *
rc
,

2604 
bŒfs_back»f_node
 *
node
)

2606 
bŒfs_back»f_node
 *
Ãxt
 = 
node
;

2607 
bŒfs_back»f_edge
 *
edge
;

2608 
bŒfs_back»f_edge
 *
edges
[
BTRFS_MAX_LEVEL
 - 1];

2609 
šdex
 = 0;

2611 
Ãxt
) {

2612 
	`cÚd_»sched
();

2614 ià(
Ãxt
->
´oûs£d
)

2617 
	`m¬k_block_´oûs£d
(
rc
, 
Ãxt
);

2619 ià(
	`li¡_em±y
(&
Ãxt
->
uµ”
))

2622 
edge
 = 
	`li¡_’Œy
(
Ãxt
->
uµ”
.next,

2623 
bŒfs_back»f_edge
, 
li¡
[
LOWER
]);

2624 
edges
[
šdex
++] = 
edge
;

2625 
Ãxt
 = 
edge
->
node
[
UPPER
];

2627 
Ãxt
 = 
	`w®k_down_back»f
(
edges
, &
šdex
);

2629 
	}
}

2631 
	$Œ“_block_´oûs£d
(
u64
 
by‹Ä
, 
»loc_cÚŒŞ
 *
rc
)

2633 
u32
 
blocksize
 = 
rc
->
ex‹Á_roÙ
->
fs_šfo
->
nodesize
;

2635 ià(
	`‹¡_¿nge_b™
(&
rc
->
´oûs£d_blocks
, 
by‹Ä
,

2636 
by‹Ä
 + 
blocksize
 - 1, 
EXTENT_DIRTY
, 1, 
NULL
))

2639 
	}
}

2641 
	$g‘_Œ“_block_key
(
bŒfs_fs_šfo
 *
fs_šfo
,

2642 
Œ“_block
 *
block
)

2644 
bŒfs_Œ“_·»Á_check
 
check
 = {

2645 .
Ëv–
 = 
block
->level,

2646 .
owÃr_roÙ
 = 
block
->
owÃr
,

2647 .
Œªsid
 = 
block
->
key
.
off£t


2649 
ex‹Á_bufãr
 *
eb
;

2651 
eb
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
block
->
by‹Ä
, &
check
);

2652 ià(
	`IS_ERR
(
eb
))

2653  
	`PTR_ERR
(
eb
);

2654 ià(!
	`ex‹Á_bufãr_u±od©e
(
eb
)) {

2655 
	`ä“_ex‹Á_bufãr
(
eb
);

2656  -
EIO
;

2658 ià(
block
->
Ëv–
 == 0)

2659 
	`bŒfs_™em_key_to_ıu
(
eb
, &
block
->
key
, 0);

2661 
	`bŒfs_node_key_to_ıu
(
eb
, &
block
->
key
, 0);

2662 
	`ä“_ex‹Á_bufãr
(
eb
);

2663 
block
->
key_»ady
 = 1;

2665 
	}
}

2670 
	$»loÿ‹_Œ“_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2671 
»loc_cÚŒŞ
 *
rc
,

2672 
bŒfs_back»f_node
 *
node
,

2673 
bŒfs_key
 *
key
,

2674 
bŒfs_·th
 *
·th
)

2676 
bŒfs_roÙ
 *
roÙ
;

2677 
»t
 = 0;

2679 ià(!
node
)

2686 
»t
 = 
	`»£rve_m‘ad©a_¥aû
(
Œªs
, 
rc
, 
node
);

2687 ià(
»t
)

2688 
out
;

2690 
	`BUG_ON
(
node
->
´oûs£d
);

2691 
roÙ
 = 
	`£Ëù_Úe_roÙ
(
node
);

2692 ià(
	`IS_ERR
(
roÙ
)) {

2693 
»t
 = 
	`PTR_ERR
(
roÙ
);

2696 
	`ASSERT
(
»t
 =ğ-
ENOENT
);

2697 ià(
»t
 =ğ-
ENOENT
) {

2698 
»t
 = 0;

2699 
	`upd©e_´oûs£d_blocks
(
rc
, 
node
);

2701 
out
;

2704 ià(
roÙ
) {

2705 ià(
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
)) {

2719 
	`ASSERT
(
node
->
Ãw_by‹Ä
 == 0);

2720 
	`ASSERT
(
	`li¡_em±y
(&
node
->
li¡
));

2721 ià(
node
->
Ãw_by‹Ä
 || !
	`li¡_em±y
(&node->
li¡
)) {

2722 
	`bŒfs_”r
(
roÙ
->
fs_šfo
,

2724 
node
->
by‹Ä
);

2725 
»t
 = -
EUCLEAN
;

2726 
out
;

2728 
»t
 = 
	`bŒfs_»cÜd_roÙ_š_Œªs
(
Œªs
, 
roÙ
);

2729 ià(
»t
)

2730 
out
;

2735 ià(!
roÙ
->
»loc_roÙ
) {

2736 
»t
 = -
ENOENT
;

2737 
out
;

2739 
roÙ
 =„oÙ->
»loc_roÙ
;

2740 
node
->
Ãw_by‹Ä
 = 
roÙ
->node->
¡¬t
;

2741 
	`bŒfs_put_roÙ
(
node
->
roÙ
);

2742 
node
->
roÙ
 = 
	`bŒfs_g¿b_roÙ
(root);

2743 
	`ASSERT
(
node
->
roÙ
);

2744 
	`li¡_add_
(&
node
->
li¡
, &
rc
->
back»f_ÿche
.
chªged
);

2746 
·th
->
lowe¡_Ëv–
 = 
node
->
Ëv–
;

2747 ià(
roÙ
 =ğroÙ->
fs_šfo
->
chunk_roÙ
)

2748 
	`bŒfs_»£rve_chunk_m‘ad©a
(
Œªs
, 
çl£
);

2749 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, 
key
, 
·th
, 0, 1);

2750 
	`bŒfs_»Ëa£_·th
(
·th
);

2751 ià(
roÙ
 =ğroÙ->
fs_šfo
->
chunk_roÙ
)

2752 
	`bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
Œªs
);

2753 ià(
»t
 > 0)

2754 
»t
 = 0;

2756 ià(!
»t
)

2757 
	`upd©e_´oûs£d_blocks
(
rc
, 
node
);

2759 
»t
 = 
	`do_»loÿtiÚ
(
Œªs
, 
rc
, 
node
, 
key
, 
·th
, 1);

2761 
out
:

2762 ià(
»t
 || 
node
->
Ëv–
 =ğ0 ||‚ode->
cowÚly
)

2763 
	`bŒfs_back»f_ş—nup_node
(&
rc
->
back»f_ÿche
, 
node
);

2764  
»t
;

2765 
	}
}

2770 
nošlše_fÜ_¡ack


2771 
	$»loÿ‹_Œ“_blocks
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2772 
»loc_cÚŒŞ
 *
rc
, 
rb_roÙ
 *
blocks
)

2774 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

2775 
bŒfs_back»f_node
 *
node
;

2776 
bŒfs_·th
 *
·th
;

2777 
Œ“_block
 *
block
;

2778 
Œ“_block
 *
Ãxt
;

2779 
»t
;

2780 
”r
 = 0;

2782 
·th
 = 
	`bŒfs_®loc_·th
();

2783 ià(!
·th
) {

2784 
”r
 = -
ENOMEM
;

2785 
out_ä“_blocks
;

2789 
	`rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
block
, 
Ãxt
, 
blocks
, 
rb_node
) {

2790 ià(!
block
->
key_»ady
)

2791 
	`bŒfs_»adah—d_Œ“_block
(
fs_šfo
, 
block
->
by‹Ä
,

2792 
block
->
owÃr
, 0,

2793 
block
->
Ëv–
);

2797 
	`rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
block
, 
Ãxt
, 
blocks
, 
rb_node
) {

2798 ià(!
block
->
key_»ady
) {

2799 
”r
 = 
	`g‘_Œ“_block_key
(
fs_šfo
, 
block
);

2800 ià(
”r
)

2801 
out_ä“_·th
;

2806 
	`rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
block
, 
Ãxt
, 
blocks
, 
rb_node
) {

2807 
node
 = 
	`bud_back»f_Œ“
(
Œªs
, 
rc
, &
block
->
key
,

2808 
block
->
Ëv–
, block->
by‹Ä
);

2809 ià(
	`IS_ERR
(
node
)) {

2810 
”r
 = 
	`PTR_ERR
(
node
);

2811 
out
;

2814 
»t
 = 
	`»loÿ‹_Œ“_block
(
Œªs
, 
rc
, 
node
, &
block
->
key
,

2815 
·th
);

2816 ià(
»t
 < 0) {

2817 
”r
 = 
»t
;

2821 
out
:

2822 
”r
 = 
	`fšish_³ndšg_nodes
(
Œªs
, 
rc
, 
·th
,ƒrr);

2824 
out_ä“_·th
:

2825 
	`bŒfs_ä“_·th
(
·th
);

2826 
out_ä“_blocks
:

2827 
	`ä“_block_li¡
(
blocks
);

2828  
”r
;

2829 
	}
}

2831 
nošlše_fÜ_¡ack
 
	$´—Îoc_fe_ex‹Á_şu¡”
(

2832 
bŒfs_šode
 *
šode
,

2833 
fe_ex‹Á_şu¡”
 *
şu¡”
)

2835 
u64
 
®loc_hšt
 = 0;

2836 
u64
 
¡¬t
;

2837 
u64
 
’d
;

2838 
u64
 
off£t
 = 
šode
->
šdex_út
;

2839 
u64
 
num_by‹s
;

2840 
Ä
;

2841 
»t
 = 0;

2842 
u64
 
i_size
 = 
	`i_size_»ad
(&
šode
->
vfs_šode
);

2843 
u64
 
´—Îoc_¡¬t
 = 
şu¡”
->
¡¬t
 - 
off£t
;

2844 
u64
 
´—Îoc_’d
 = 
şu¡”
->
’d
 - 
off£t
;

2845 
u64
 
cur_off£t
 = 
´—Îoc_¡¬t
;

2858 ià(!
	`PAGE_ALIGNED
(
i_size
)) {

2859 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
vfs_šode
.
i_m­pšg
;

2860 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

2861 cÚ¡ 
u32
 
£ùÜsize
 = 
fs_šfo
->sectorsize;

2862 
·ge
 *page;

2864 
	`ASSERT
(
£ùÜsize
 < 
PAGE_SIZE
);

2865 
	`ASSERT
(
	`IS_ALIGNED
(
i_size
, 
£ùÜsize
));

2886 
»t
 = 
	`fem­_wr™e_ªd_wa™
(
m­pšg
);

2887 ià(
»t
 < 0)

2888  
»t
;

2890 
	`ş—r_ex‹Á_b™s
(&
šode
->
io_Œ“
, 
i_size
,

2891 
	`round_up
(
i_size
, 
PAGE_SIZE
) - 1,

2892 
EXTENT_UPTODATE
);

2893 
·ge
 = 
	`fšd_lock_·ge
(
m­pšg
, 
i_size
 >> 
PAGE_SHIFT
);

2898 ià(
·ge
) {

2899 
	`bŒfs_sub·ge_ş—r_u±od©e
(
fs_šfo
, 
·ge
, 
i_size
,

2900 
	`round_up
(
i_size
, 
PAGE_SIZE
) - i_size);

2901 
	`uÆock_·ge
(
·ge
);

2902 
	`put_·ge
(
·ge
);

2906 
	`BUG_ON
(
şu¡”
->
¡¬t
 !ğşu¡”->
bound¬y
[0]);

2907 
»t
 = 
	`bŒfs_®loc_d©a_chunk_Údemªd
(
šode
,

2908 
´—Îoc_’d
 + 1 - 
´—Îoc_¡¬t
);

2909 ià(
»t
)

2910  
»t
;

2912 
	`bŒfs_šode_lock
(
šode
, 0);

2913 
Ä
 = 0;‚¸< 
şu¡”
->nr;‚r++) {

2914 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

2916 
¡¬t
 = 
şu¡”
->
bound¬y
[
Ä
] - 
off£t
;

2917 ià(
Ä
 + 1 < 
şu¡”
->nr)

2918 
’d
 = 
şu¡”
->
bound¬y
[
Ä
 + 1] - 1 - 
off£t
;

2920 
’d
 = 
şu¡”
->’d - 
off£t
;

2922 
	`lock_ex‹Á
(&
šode
->
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

2923 
num_by‹s
 = 
’d
 + 1 - 
¡¬t
;

2924 
»t
 = 
	`bŒfs_´—Îoc_fe_¿nge
(&
šode
->
vfs_šode
, 0, 
¡¬t
,

2925 
num_by‹s
,‚um_bytes,

2926 
’d
 + 1, &
®loc_hšt
);

2927 
cur_off£t
 = 
’d
 + 1;

2928 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

2929 ià(
»t
)

2932 
	`bŒfs_šode_uÆock
(
šode
, 0);

2934 ià(
cur_off£t
 < 
´—Îoc_’d
)

2935 
	`bŒfs_ä“_»£rved_d©a_¥aû_noquÙa
(
šode
->
roÙ
->
fs_šfo
,

2936 
´—Îoc_’d
 + 1 - 
cur_off£t
);

2937  
»t
;

2938 
	}
}

2940 
nošlše_fÜ_¡ack
 
	$£tup_»loÿtiÚ_ex‹Á_m­pšg
(
šode
 *inode,

2941 
u64
 
¡¬t
, u64 
’d
, u64 
block_¡¬t
)

2943 
ex‹Á_m­
 *
em
;

2944 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

2945 
»t
 = 0;

2947 
em
 = 
	`®loc_ex‹Á_m­
();

2948 ià(!
em
)

2949  -
ENOMEM
;

2951 
em
->
¡¬t
 = start;

2952 
em
->
Ën
 = 
’d
 + 1 - 
¡¬t
;

2953 
em
->
block_Ën
 =ƒm->
Ën
;

2954 
em
->
block_¡¬t
 = block_start;

2955 
	`£t_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
);

2957 
	`lock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

2958 
»t
 = 
	`bŒfs_»¶aû_ex‹Á_m­_¿nge
(
	`BTRFS_I
(
šode
), 
em
, 
çl£
);

2959 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

2960 
	`ä“_ex‹Á_m­
(
em
);

2962  
»t
;

2963 
	}
}

2968 
nošlše
 
	$bŒfs_should_ÿnûl_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
)

2970  
	`©omic_»ad
(&
fs_šfo
->
b®ªû_ÿnûl_»q
) ||

2971 
	`©omic_»ad
(&
fs_šfo
->
»loc_ÿnûl_»q
) ||

2972 
	`çl_sigÇl_³ndšg
(
cu¼’t
);

2973 
	}
}

2974 
ALLOW_ERROR_INJECTION
(
bŒfs_should_ÿnûl_b®ªû
, 
TRUE
);

2976 
u64
 
	$g‘_şu¡”_bound¬y_’d
(
fe_ex‹Á_şu¡”
 *
şu¡”
,

2977 
şu¡”_Ä
)

2980 ià(
şu¡”_Ä
 >ğ
şu¡”
->
Ä
 - 1)

2981  
şu¡”
->
’d
;

2984  
şu¡”
->
bound¬y
[
şu¡”_Ä
 + 1] - 1;

2985 
	}
}

2987 
	$»loÿ‹_Úe_·ge
(
šode
 *šode, 
fe_¿_¡©e
 *
¿
,

2988 
fe_ex‹Á_şu¡”
 *
şu¡”
,

2989 *
şu¡”_Ä
, 
·ge_šdex
)

2991 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2992 
u64
 
off£t
 = 
	`BTRFS_I
(
šode
)->
šdex_út
;

2993 cÚ¡ 
Ï¡_šdex
 = (
şu¡”
->
’d
 - 
off£t
è>> 
PAGE_SHIFT
;

2994 
gå_t
 
mask
 = 
	`bŒfs_®loc_wr™e_mask
(
šode
->
i_m­pšg
);

2995 
·ge
 *page;

2996 
u64
 
·ge_¡¬t
;

2997 
u64
 
·ge_’d
;

2998 
u64
 
cur
;

2999 
»t
;

3001 
	`ASSERT
(
·ge_šdex
 <ğ
Ï¡_šdex
);

3002 
·ge
 = 
	`fšd_lock_·ge
(
šode
->
i_m­pšg
, 
·ge_šdex
);

3003 ià(!
·ge
) {

3004 
	`·ge_ÿche_sync_»adah—d
(
šode
->
i_m­pšg
, 
¿
, 
NULL
,

3005 
·ge_šdex
, 
Ï¡_šdex
 + 1 -…age_index);

3006 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
·ge_šdex
, 
mask
);

3007 ià(!
·ge
)

3008  -
ENOMEM
;

3011 ià(
	`PageR—dah—d
(
·ge
))

3012 
	`·ge_ÿche_async_»adah—d
(
šode
->
i_m­pšg
, 
¿
, 
NULL
,

3013 
	`·ge_fŞio
(
·ge
), 
·ge_šdex
,

3014 
Ï¡_šdex
 + 1 - 
·ge_šdex
);

3016 ià(!
	`PageU±od©e
(
·ge
)) {

3017 
	`bŒfs_»ad_fŞio
(
NULL
, 
	`·ge_fŞio
(
·ge
));

3018 
	`lock_·ge
(
·ge
);

3019 ià(!
	`PageU±od©e
(
·ge
)) {

3020 
»t
 = -
EIO
;

3021 
»Ëa£_·ge
;

3030 
»t
 = 
	`£t_·ge_ex‹Á_m­³d
(
·ge
);

3031 ià(
»t
 < 0)

3032 
»Ëa£_·ge
;

3034 
·ge_¡¬t
 = 
	`·ge_off£t
(
·ge
);

3035 
·ge_’d
 = 
·ge_¡¬t
 + 
PAGE_SIZE
 - 1;

3041 
cur
 = 
	`max
(
·ge_¡¬t
, 
şu¡”
->
bound¬y
[*
şu¡”_Ä
] - 
off£t
);

3042 
cur
 <ğ
·ge_’d
) {

3043 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

3044 
u64
 
ex‹Á_¡¬t
 = 
şu¡”
->
bound¬y
[*
şu¡”_Ä
] - 
off£t
;

3045 
u64
 
ex‹Á_’d
 = 
	`g‘_şu¡”_bound¬y_’d
(
şu¡”
,

3046 *
şu¡”_Ä
è- 
off£t
;

3047 
u64
 
şam³d_¡¬t
 = 
	`max
(
·ge_¡¬t
, 
ex‹Á_¡¬t
);

3048 
u64
 
şam³d_’d
 = 
	`mš
(
·ge_’d
, 
ex‹Á_’d
);

3049 
u32
 
şam³d_Ën
 = 
şam³d_’d
 + 1 - 
şam³d_¡¬t
;

3052 
»t
 = 
	`bŒfs_d–®loc_»£rve_m‘ad©a
(
	`BTRFS_I
(
šode
),

3053 
şam³d_Ën
, clamped_len,

3054 
çl£
);

3055 ià(
»t
)

3056 
»Ëa£_·ge
;

3059 
	`lock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
şam³d_¡¬t
, 
şam³d_’d
,

3060 &
ÿched_¡©e
);

3061 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
	`BTRFS_I
(
šode
), 
şam³d_¡¬t
,

3062 
şam³d_’d
, 0, &
ÿched_¡©e
);

3063 ià(
»t
) {

3064 
	`ş—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

3065 
şam³d_¡¬t
, 
şam³d_’d
,

3066 
EXTENT_LOCKED
 | 
EXTENT_BOUNDARY
,

3067 &
ÿched_¡©e
);

3068 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
	`BTRFS_I
(
šode
),

3069 
şam³d_Ën
, 
Œue
);

3070 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
	`BTRFS_I
(
šode
),

3071 
şam³d_Ën
);

3072 
»Ëa£_·ge
;

3074 
	`bŒfs_·ge_£t_dœty
(
fs_šfo
, 
·ge
, 
şam³d_¡¬t
, 
şam³d_Ën
);

3083 ià(
	`š_¿nge
(
şu¡”
->
bound¬y
[*
şu¡”_Ä
] - 
off£t
,

3084 
·ge_¡¬t
, 
PAGE_SIZE
)) {

3085 
u64
 
bound¬y_¡¬t
 = 
şu¡”
->
bound¬y
[*
şu¡”_Ä
] -

3086 
off£t
;

3087 
u64
 
bound¬y_’d
 = 
bound¬y_¡¬t
 +

3088 
fs_šfo
->
£ùÜsize
 - 1;

3090 
	`£t_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

3091 
bound¬y_¡¬t
, 
bound¬y_’d
,

3092 
EXTENT_BOUNDARY
, 
NULL
);

3094 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
şam³d_¡¬t
, 
şam³d_’d
,

3095 &
ÿched_¡©e
);

3096 
	`bŒfs_d–®loc_»Ëa£_ex‹Ás
(
	`BTRFS_I
(
šode
), 
şam³d_Ën
);

3097 
cur
 +ğ
şam³d_Ën
;

3100 ià(
cur
 >ğ
ex‹Á_’d
) {

3101 (*
şu¡”_Ä
)++;

3103 ià(*
şu¡”_Ä
 >ğ
şu¡”
->
Ä
)

3107 
	`uÆock_·ge
(
·ge
);

3108 
	`put_·ge
(
·ge
);

3110 
	`b®ªû_dœty_·ges_¿‹lim™ed
(
šode
->
i_m­pšg
);

3111 
	`bŒfs_thrÙe
(
fs_šfo
);

3112 ià(
	`bŒfs_should_ÿnûl_b®ªû
(
fs_šfo
))

3113 
»t
 = -
ECANCELED
;

3114  
»t
;

3116 
»Ëa£_·ge
:

3117 
	`uÆock_·ge
(
·ge
);

3118 
	`put_·ge
(
·ge
);

3119  
»t
;

3120 
	}
}

3122 
	$»loÿ‹_fe_ex‹Á_şu¡”
(
šode
 *inode,

3123 
fe_ex‹Á_şu¡”
 *
şu¡”
)

3125 
u64
 
off£t
 = 
	`BTRFS_I
(
šode
)->
šdex_út
;

3126 
šdex
;

3127 
Ï¡_šdex
;

3128 
fe_¿_¡©e
 *
¿
;

3129 
şu¡”_Ä
 = 0;

3130 
»t
 = 0;

3132 ià(!
şu¡”
->
Ä
)

3135 
¿
 = 
	`kz®loc
((*¿), 
GFP_NOFS
);

3136 ià(!
¿
)

3137  -
ENOMEM
;

3139 
»t
 = 
	`´—Îoc_fe_ex‹Á_şu¡”
(
	`BTRFS_I
(
šode
), 
şu¡”
);

3140 ià(
»t
)

3141 
out
;

3143 
	`fe_¿_¡©e_š™
(
¿
, 
šode
->
i_m­pšg
);

3145 
»t
 = 
	`£tup_»loÿtiÚ_ex‹Á_m­pšg
(
šode
, 
şu¡”
->
¡¬t
 - 
off£t
,

3146 
şu¡”
->
’d
 - 
off£t
, clu¡”->
¡¬t
);

3147 ià(
»t
)

3148 
out
;

3150 
Ï¡_šdex
 = (
şu¡”
->
’d
 - 
off£t
è>> 
PAGE_SHIFT
;

3151 
šdex
 = (
şu¡”
->
¡¬t
 - 
off£t
è>> 
PAGE_SHIFT
;

3152 
šdex
 <ğ
Ï¡_šdex
 && !
»t
; index++)

3153 
»t
 = 
	`»loÿ‹_Úe_·ge
(
šode
, 
¿
, 
şu¡”
, &
şu¡”_Ä
, 
šdex
);

3154 ià(
»t
 == 0)

3155 
	`WARN_ON
(
şu¡”_Ä
 !ğ
şu¡”
->
Ä
);

3156 
out
:

3157 
	`kä“
(
¿
);

3158  
»t
;

3159 
	}
}

3161 
nošlše_fÜ_¡ack


3162 
	$»loÿ‹_d©a_ex‹Á
(
šode
 *šode, 
bŒfs_key
 *
ex‹Á_key
,

3163 
fe_ex‹Á_şu¡”
 *
şu¡”
)

3165 
»t
;

3167 ià(
şu¡”
->
Ä
 > 0 && 
ex‹Á_key
->
objeùid
 !ğşu¡”->
’d
 + 1) {

3168 
»t
 = 
	`»loÿ‹_fe_ex‹Á_şu¡”
(
šode
, 
şu¡”
);

3169 ià(
»t
)

3170  
»t
;

3171 
şu¡”
->
Ä
 = 0;

3174 ià(!
şu¡”
->
Ä
)

3175 
şu¡”
->
¡¬t
 = 
ex‹Á_key
->
objeùid
;

3177 
	`BUG_ON
(
şu¡”
->
Ä
 >ğ
MAX_EXTENTS
);

3178 
şu¡”
->
’d
 = 
ex‹Á_key
->
objeùid
 +ƒx‹Á_key->
off£t
 - 1;

3179 
şu¡”
->
bound¬y
[şu¡”->
Ä
] = 
ex‹Á_key
->
objeùid
;

3180 
şu¡”
->
Ä
++;

3182 ià(
şu¡”
->
Ä
 >ğ
MAX_EXTENTS
) {

3183 
»t
 = 
	`»loÿ‹_fe_ex‹Á_şu¡”
(
šode
, 
şu¡”
);

3184 ià(
»t
)

3185  
»t
;

3186 
şu¡”
->
Ä
 = 0;

3189 
	}
}

3195 
	$add_Œ“_block
(
»loc_cÚŒŞ
 *
rc
,

3196 
bŒfs_key
 *
ex‹Á_key
,

3197 
bŒfs_·th
 *
·th
,

3198 
rb_roÙ
 *
blocks
)

3200 
ex‹Á_bufãr
 *
eb
;

3201 
bŒfs_ex‹Á_™em
 *
ei
;

3202 
bŒfs_Œ“_block_šfo
 *
bi
;

3203 
Œ“_block
 *
block
;

3204 
rb_node
 *rb_node;

3205 
u32
 
™em_size
;

3206 
Ëv–
 = -1;

3207 
u64
 
g’”©iÚ
;

3208 
u64
 
owÃr
 = 0;

3210 
eb
 = 
·th
->
nodes
[0];

3211 
™em_size
 = 
	`bŒfs_™em_size
(
eb
, 
·th
->
¦Ùs
[0]);

3213 ià(
ex‹Á_key
->
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
 ||

3214 
™em_size
 >ğ(*
ei
è+ (*
bi
)) {

3215 
±r
 = 0, 
’d
;

3217 
ei
 = 
	`bŒfs_™em_±r
(
eb
, 
·th
->
¦Ùs
[0],

3218 
bŒfs_ex‹Á_™em
);

3219 
’d
 = ()
ei
 + 
™em_size
;

3220 ià(
ex‹Á_key
->
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
) {

3221 
bi
 = (
bŒfs_Œ“_block_šfo
 *)(
ei
 + 1);

3222 
Ëv–
 = 
	`bŒfs_Œ“_block_Ëv–
(
eb
, 
bi
);

3223 
±r
 = ()(
bi
 + 1);

3225 
Ëv–
 = ()
ex‹Á_key
->
off£t
;

3226 
±r
 = ()(
ei
 + 1);

3228 
g’”©iÚ
 = 
	`bŒfs_ex‹Á_g’”©iÚ
(
eb
, 
ei
);

3245 ià(
	`bŒfs_ex‹Á_»fs
(
eb
, 
ei
) == 1 &&

3246 !(
	`bŒfs_ex‹Á_æags
(
eb
, 
ei
) &

3247 
BTRFS_BLOCK_FLAG_FULL_BACKREF
) &&

3248 
±r
 < 
’d
) {

3249 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

3250 
ty³
;

3252 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)
±r
;

3253 
ty³
 = 
	`bŒfs_g‘_ex‹Á_šlše_»f_ty³
(
eb
, 
œef
,

3254 
BTRFS_REF_TYPE_BLOCK
);

3255 ià(
ty³
 =ğ
BTRFS_REF_TYPE_INVALID
)

3256  -
EINVAL
;

3257 ià(
ty³
 =ğ
BTRFS_TREE_BLOCK_REF_KEY
)

3258 
owÃr
 = 
	`bŒfs_ex‹Á_šlše_»f_off£t
(
eb
, 
œef
);

3261 
	`bŒfs_´št_Ëaf
(
eb
);

3262 
	`bŒfs_”r
(
rc
->
block_group
->
fs_šfo
,

3264 
eb
->
¡¬t
, 
·th
->
¦Ùs
[0]);

3265 
	`bŒfs_»Ëa£_·th
(
·th
);

3266  -
EUCLEAN
;

3269 
	`bŒfs_»Ëa£_·th
(
·th
);

3271 
	`BUG_ON
(
Ëv–
 == -1);

3273 
block
 = 
	`km®loc
((*block), 
GFP_NOFS
);

3274 ià(!
block
)

3275  -
ENOMEM
;

3277 
block
->
by‹Ä
 = 
ex‹Á_key
->
objeùid
;

3278 
block
->
key
.
objeùid
 = 
rc
->
ex‹Á_roÙ
->
fs_šfo
->
nodesize
;

3279 
block
->
key
.
off£t
 = 
g’”©iÚ
;

3280 
block
->
Ëv–
 =†evel;

3281 
block
->
key_»ady
 = 0;

3282 
block
->
owÃr
 = owner;

3284 
rb_node
 = 
	`rb_sim¶e_š£¹
(
blocks
, 
block
->
by‹Ä
, &block->rb_node);

3285 ià(
rb_node
)

3286 
	`bŒfs_back»f_·nic
(
rc
->
ex‹Á_roÙ
->
fs_šfo
, 
block
->
by‹Ä
,

3287 -
EEXIST
);

3290 
	}
}

3295 
	$__add_Œ“_block
(
»loc_cÚŒŞ
 *
rc
,

3296 
u64
 
by‹Ä
, 
u32
 
blocksize
,

3297 
rb_roÙ
 *
blocks
)

3299 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

3300 
bŒfs_·th
 *
·th
;

3301 
bŒfs_key
 
key
;

3302 
»t
;

3303 
boŞ
 
skšny
 = 
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
);

3305 ià(
	`Œ“_block_´oûs£d
(
by‹Ä
, 
rc
))

3308 ià(
	`rb_sim¶e_£¬ch
(
blocks
, 
by‹Ä
))

3311 
·th
 = 
	`bŒfs_®loc_·th
();

3312 ià(!
·th
)

3313  -
ENOMEM
;

3314 
agaš
:

3315 
key
.
objeùid
 = 
by‹Ä
;

3316 ià(
skšny
) {

3317 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

3318 
key
.
off£t
 = (
u64
)-1;

3320 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

3321 
key
.
off£t
 = 
blocksize
;

3324 
·th
->
£¬ch_comm™_roÙ
 = 1;

3325 
·th
->
sk_lockšg
 = 1;

3326 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
rc
->
ex‹Á_roÙ
, &
key
, 
·th
, 0, 0);

3327 ià(
»t
 < 0)

3328 
out
;

3330 ià(
»t
 > 0 && 
skšny
) {

3331 ià(
·th
->
¦Ùs
[0]) {

3332 
·th
->
¦Ùs
[0]--;

3333 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,

3334 
·th
->
¦Ùs
[0]);

3335 ià(
key
.
objeùid
 =ğ
by‹Ä
 &&

3336 (
key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
 ||

3337 (
key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 &&

3338 
key
.
off£t
 =ğ
blocksize
)))

3339 
»t
 = 0;

3342 ià(
»t
) {

3343 
skšny
 = 
çl£
;

3344 
	`bŒfs_»Ëa£_·th
(
·th
);

3345 
agaš
;

3348 ià(
»t
) {

3349 
	`ASSERT
(
»t
 == 1);

3350 
	`bŒfs_´št_Ëaf
(
·th
->
nodes
[0]);

3351 
	`bŒfs_”r
(
fs_šfo
,

3353 
by‹Ä
);

3354 
	`WARN_ON
(1);

3355 
»t
 = -
EINVAL
;

3356 
out
;

3359 
»t
 = 
	`add_Œ“_block
(
rc
, &
key
, 
·th
, 
blocks
);

3360 
out
:

3361 
	`bŒfs_ä“_·th
(
·th
);

3362  
»t
;

3363 
	}
}

3365 
	$d–‘e_block_group_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
,

3366 
bŒfs_block_group
 *
block_group
,

3367 
šode
 *inode,

3368 
u64
 
šo
)

3370 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

3371 
bŒfs_Œªs_hªdË
 *
Œªs
;

3372 
»t
 = 0;

3374 ià(
šode
)

3375 
Œunÿ‹
;

3377 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
šo
, 
roÙ
);

3378 ià(
	`IS_ERR
(
šode
))

3379  -
ENOENT
;

3381 
Œunÿ‹
:

3382 
»t
 = 
	`bŒfs_check_Œunc_ÿche_ä“_¥aû
(
fs_šfo
,

3383 &
fs_šfo
->
glob®_block_rsv
);

3384 ià(
»t
)

3385 
out
;

3387 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

3388 ià(
	`IS_ERR
(
Œªs
)) {

3389 
»t
 = 
	`PTR_ERR
(
Œªs
);

3390 
out
;

3393 
»t
 = 
	`bŒfs_Œunÿ‹_ä“_¥aû_ÿche
(
Œªs
, 
block_group
, 
šode
);

3395 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3396 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

3397 
out
:

3398 
	`ut
(
šode
);

3399  
»t
;

3400 
	}
}

3406 
	$d–‘e_v1_¥aû_ÿche
(
ex‹Á_bufãr
 *
Ëaf
,

3407 
bŒfs_block_group
 *
block_group
,

3408 
u64
 
d©a_by‹Ä
)

3410 
u64
 
¥aû_ÿche_šo
;

3411 
bŒfs_fe_ex‹Á_™em
 *
ei
;

3412 
bŒfs_key
 
key
;

3413 
boŞ
 
found
 = 
çl£
;

3414 
i
;

3415 
»t
;

3417 ià(
	`bŒfs_h—d”_owÃr
(
Ëaf
è!ğ
BTRFS_ROOT_TREE_OBJECTID
)

3420 
i
 = 0; i < 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
); i++) {

3421 
u8
 
ty³
;

3423 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
i
);

3424 ià(
key
.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

3426 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
i
, 
bŒfs_fe_ex‹Á_™em
);

3427 
ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
ei
);

3429 ià((
ty³
 =ğ
BTRFS_FILE_EXTENT_REG
 ||

3430 
ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
) &&

3431 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
ei
è=ğ
d©a_by‹Ä
) {

3432 
found
 = 
Œue
;

3433 
¥aû_ÿche_šo
 = 
key
.
objeùid
;

3437 ià(!
found
)

3438  -
ENOENT
;

3439 
»t
 = 
	`d–‘e_block_group_ÿche
(
Ëaf
->
fs_šfo
, 
block_group
, 
NULL
,

3440 
¥aû_ÿche_šo
);

3441  
»t
;

3442 
	}
}

3447 
nošlše_fÜ_¡ack


3448 
	$add_d©a_»ã»nûs
(
»loc_cÚŒŞ
 *
rc
,

3449 
bŒfs_key
 *
ex‹Á_key
,

3450 
bŒfs_·th
 *
·th
,

3451 
rb_roÙ
 *
blocks
)

3453 
bŒfs_back»f_w®k_ùx
 
ùx
 = { 0 };

3454 
uli¡_™”©Ü
 
Ëaf_u™”
;

3455 
uli¡_node
 *
»f_node
 = 
NULL
;

3456 cÚ¡ 
u32
 
blocksize
 = 
rc
->
ex‹Á_roÙ
->
fs_šfo
->
nodesize
;

3457 
»t
 = 0;

3459 
	`bŒfs_»Ëa£_·th
(
·th
);

3461 
ùx
.
by‹Ä
 = 
ex‹Á_key
->
objeùid
;

3462 
ùx
.
sk_šode_»f_li¡
 = 
Œue
;

3463 
ùx
.
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

3465 
»t
 = 
	`bŒfs_fšd_®l_Ëafs
(&
ùx
);

3466 ià(
»t
 < 0)

3467  
»t
;

3469 
	`ULIST_ITER_INIT
(&
Ëaf_u™”
);

3470 (
»f_node
 = 
	`uli¡_Ãxt
(
ùx
.
»fs
, &
Ëaf_u™”
))) {

3471 
bŒfs_Œ“_·»Á_check
 
check
 = { 0 };

3472 
ex‹Á_bufãr
 *
eb
;

3474 
eb
 = 
	`»ad_Œ“_block
(
ùx
.
fs_šfo
, 
»f_node
->
v®
, &
check
);

3475 ià(
	`IS_ERR
(
eb
)) {

3476 
»t
 = 
	`PTR_ERR
(
eb
);

3479 
»t
 = 
	`d–‘e_v1_¥aû_ÿche
(
eb
, 
rc
->
block_group
,

3480 
ex‹Á_key
->
objeùid
);

3481 
	`ä“_ex‹Á_bufãr
(
eb
);

3482 ià(
»t
 < 0)

3484 
»t
 = 
	`__add_Œ“_block
(
rc
, 
»f_node
->
v®
, 
blocksize
, 
blocks
);

3485 ià(
»t
 < 0)

3488 ià(
»t
 < 0)

3489 
	`ä“_block_li¡
(
blocks
);

3490 
	`uli¡_ä“
(
ùx
.
»fs
);

3491  
»t
;

3492 
	}
}

3497 
nošlše_fÜ_¡ack


3498 
	$fšd_Ãxt_ex‹Á
(
»loc_cÚŒŞ
 *
rc
, 
bŒfs_·th
 *
·th
,

3499 
bŒfs_key
 *
ex‹Á_key
)

3501 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

3502 
bŒfs_key
 
key
;

3503 
ex‹Á_bufãr
 *
Ëaf
;

3504 
u64
 
¡¬t
, 
’d
, 
Ï¡
;

3505 
»t
;

3507 
Ï¡
 = 
rc
->
block_group
->
¡¬t
 +„c->block_group->
Ëngth
;

3509 
boŞ
 
block_found
;

3511 
	`cÚd_»sched
();

3512 ià(
rc
->
£¬ch_¡¬t
 >ğ
Ï¡
) {

3513 
»t
 = 1;

3517 
key
.
objeùid
 = 
rc
->
£¬ch_¡¬t
;

3518 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

3519 
key
.
off£t
 = 0;

3521 
·th
->
£¬ch_comm™_roÙ
 = 1;

3522 
·th
->
sk_lockšg
 = 1;

3523 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
rc
->
ex‹Á_roÙ
, &
key
, 
·th
,

3525 ià(
»t
 < 0)

3527 
Ãxt
:

3528 
Ëaf
 = 
·th
->
nodes
[0];

3529 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

3530 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
rc
->
ex‹Á_roÙ
, 
·th
);

3531 ià(
»t
 != 0)

3533 
Ëaf
 = 
·th
->
nodes
[0];

3536 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

3537 ià(
key
.
objeùid
 >ğ
Ï¡
) {

3538 
»t
 = 1;

3542 ià(
key
.
ty³
 !ğ
BTRFS_EXTENT_ITEM_KEY
 &&

3543 
key
.
ty³
 !ğ
BTRFS_METADATA_ITEM_KEY
) {

3544 
·th
->
¦Ùs
[0]++;

3545 
Ãxt
;

3548 ià(
key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 &&

3549 
key
.
objeùid
 + key.
off£t
 <ğ
rc
->
£¬ch_¡¬t
) {

3550 
·th
->
¦Ùs
[0]++;

3551 
Ãxt
;

3554 ià(
key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
 &&

3555 
key
.
objeùid
 + 
fs_šfo
->
nodesize
 <=

3556 
rc
->
£¬ch_¡¬t
) {

3557 
·th
->
¦Ùs
[0]++;

3558 
Ãxt
;

3561 
block_found
 = 
	`fšd_fœ¡_ex‹Á_b™
(&
rc
->
´oûs£d_blocks
,

3562 
key
.
objeùid
, &
¡¬t
, &
’d
,

3563 
EXTENT_DIRTY
, 
NULL
);

3565 ià(
block_found
 && 
¡¬t
 <ğ
key
.
objeùid
) {

3566 
	`bŒfs_»Ëa£_·th
(
·th
);

3567 
rc
->
£¬ch_¡¬t
 = 
’d
 + 1;

3569 ià(
key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
)

3570 
rc
->
£¬ch_¡¬t
 = 
key
.
objeùid
 + key.
off£t
;

3572 
rc
->
£¬ch_¡¬t
 = 
key
.
objeùid
 +

3573 
fs_šfo
->
nodesize
;

3574 
	`memıy
(
ex‹Á_key
, &
key
, (key));

3578 
	`bŒfs_»Ëa£_·th
(
·th
);

3579  
»t
;

3580 
	}
}

3582 
	$£t_»loc_cÚŒŞ
(
»loc_cÚŒŞ
 *
rc
)

3584 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

3586 
	`mu‹x_lock
(&
fs_šfo
->
»loc_mu‹x
);

3587 
fs_šfo
->
»loc_ùl
 = 
rc
;

3588 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

3589 
	}
}

3591 
	$un£t_»loc_cÚŒŞ
(
»loc_cÚŒŞ
 *
rc
)

3593 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

3595 
	`mu‹x_lock
(&
fs_šfo
->
»loc_mu‹x
);

3596 
fs_šfo
->
»loc_ùl
 = 
NULL
;

3597 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

3598 
	}
}

3600 
nošlše_fÜ_¡ack


3601 
	$´•¬e_to_»loÿ‹
(
»loc_cÚŒŞ
 *
rc
)

3603 
bŒfs_Œªs_hªdË
 *
Œªs
;

3604 
»t
;

3606 
rc
->
block_rsv
 = 
	`bŒfs_®loc_block_rsv
Ôc->
ex‹Á_roÙ
->
fs_šfo
,

3607 
BTRFS_BLOCK_RSV_TEMP
);

3608 ià(!
rc
->
block_rsv
)

3609  -
ENOMEM
;

3611 
	`mem£t
(&
rc
->
şu¡”
, 0, (rc->cluster));

3612 
rc
->
£¬ch_¡¬t
 =„c->
block_group
->
¡¬t
;

3613 
rc
->
ex‹Ás_found
 = 0;

3614 
rc
->
nodes_»loÿ‹d
 = 0;

3615 
rc
->
m”gšg_rsv_size
 = 0;

3616 
rc
->
»£rved_by‹s
 = 0;

3617 
rc
->
block_rsv
->
size
 =„c->
ex‹Á_roÙ
->
fs_šfo
->
nodesize
 *

3618 
RELOCATION_RESERVED_NODES
;

3619 
»t
 = 
	`bŒfs_block_rsv_»fl
(
rc
->
ex‹Á_roÙ
->
fs_šfo
,

3620 
rc
->
block_rsv
,„c->block_rsv->
size
,

3621 
BTRFS_RESERVE_FLUSH_ALL
);

3622 ià(
»t
)

3623  
»t
;

3625 
rc
->
ü—‹_»loc_Œ“
 = 1;

3626 
	`£t_»loc_cÚŒŞ
(
rc
);

3628 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
rc
->
ex‹Á_roÙ
);

3629 ià(
	`IS_ERR
(
Œªs
)) {

3630 
	`un£t_»loc_cÚŒŞ
(
rc
);

3636  
	`PTR_ERR
(
Œªs
);

3639 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

3640 ià(
»t
)

3641 
	`un£t_»loc_cÚŒŞ
(
rc
);

3643  
»t
;

3644 
	}
}

3646 
nošlše_fÜ_¡ack
 
	$»loÿ‹_block_group
(
»loc_cÚŒŞ
 *
rc
)

3648 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

3649 
rb_roÙ
 
blocks
 = 
RB_ROOT
;

3650 
bŒfs_key
 
key
;

3651 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

3652 
bŒfs_·th
 *
·th
;

3653 
bŒfs_ex‹Á_™em
 *
ei
;

3654 
u64
 
æags
;

3655 
»t
;

3656 
”r
 = 0;

3657 
´og»ss
 = 0;

3659 
·th
 = 
	`bŒfs_®loc_·th
();

3660 ià(!
·th
)

3661  -
ENOMEM
;

3662 
·th
->
»ada
 = 
READA_FORWARD
;

3664 
»t
 = 
	`´•¬e_to_»loÿ‹
(
rc
);

3665 ià(
»t
) {

3666 
”r
 = 
»t
;

3667 
out_ä“
;

3671 
rc
->
»£rved_by‹s
 = 0;

3672 
»t
 = 
	`bŒfs_block_rsv_»fl
(
fs_šfo
, 
rc
->
block_rsv
,

3673 
rc
->
block_rsv
->
size
,

3674 
BTRFS_RESERVE_FLUSH_ALL
);

3675 ià(
»t
) {

3676 
”r
 = 
»t
;

3679 
´og»ss
++;

3680 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
rc
->
ex‹Á_roÙ
, 0);

3681 ià(
	`IS_ERR
(
Œªs
)) {

3682 
”r
 = 
	`PTR_ERR
(
Œªs
);

3683 
Œªs
 = 
NULL
;

3686 
»¡¬t
:

3687 ià(
	`upd©e_back»f_ÿche
(
Œªs
, &
rc
->
back»f_ÿche
)) {

3688 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3689 
Œªs
 = 
NULL
;

3693 
»t
 = 
	`fšd_Ãxt_ex‹Á
(
rc
, 
·th
, &
key
);

3694 ià(
»t
 < 0)

3695 
”r
 = 
»t
;

3696 ià(
»t
 != 0)

3699 
rc
->
ex‹Ás_found
++;

3701 
ei
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

3702 
bŒfs_ex‹Á_™em
);

3703 
æags
 = 
	`bŒfs_ex‹Á_æags
(
·th
->
nodes
[0], 
ei
);

3705 ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

3706 
»t
 = 
	`add_Œ“_block
(
rc
, &
key
, 
·th
, &
blocks
);

3707 } ià(
rc
->
¡age
 =ğ
UPDATE_DATA_PTRS
 &&

3708 (
æags
 & 
BTRFS_EXTENT_FLAG_DATA
)) {

3709 
»t
 = 
	`add_d©a_»ã»nûs
(
rc
, &
key
, 
·th
, &
blocks
);

3711 
	`bŒfs_»Ëa£_·th
(
·th
);

3712 
»t
 = 0;

3714 ià(
»t
 < 0) {

3715 
”r
 = 
»t
;

3719 ià(!
	`RB_EMPTY_ROOT
(&
blocks
)) {

3720 
»t
 = 
	`»loÿ‹_Œ“_blocks
(
Œªs
, 
rc
, &
blocks
);

3721 ià(
»t
 < 0) {

3722 ià(
»t
 !ğ-
EAGAIN
) {

3723 
”r
 = 
»t
;

3726 
rc
->
ex‹Ás_found
--;

3727 
rc
->
£¬ch_¡¬t
 = 
key
.
objeùid
;

3731 
	`bŒfs_’d_Œª§ùiÚ_thrÙe
(
Œªs
);

3732 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

3733 
Œªs
 = 
NULL
;

3735 ià(
rc
->
¡age
 =ğ
MOVE_DATA_EXTENTS
 &&

3736 (
æags
 & 
BTRFS_EXTENT_FLAG_DATA
)) {

3737 
rc
->
found_fe_ex‹Á
 = 1;

3738 
»t
 = 
	`»loÿ‹_d©a_ex‹Á
(
rc
->
d©a_šode
,

3739 &
key
, &
rc
->
şu¡”
);

3740 ià(
»t
 < 0) {

3741 
”r
 = 
»t
;

3745 ià(
	`bŒfs_should_ÿnûl_b®ªû
(
fs_šfo
)) {

3746 
”r
 = -
ECANCELED
;

3750 ià(
Œªs
 && 
´og»ss
 && 
”r
 =ğ-
ENOSPC
) {

3751 
»t
 = 
	`bŒfs_fÜû_chunk_®loc
(
Œªs
, 
rc
->
block_group
->
æags
);

3752 ià(
»t
 == 1) {

3753 
”r
 = 0;

3754 
´og»ss
 = 0;

3755 
»¡¬t
;

3759 
	`bŒfs_»Ëa£_·th
(
·th
);

3760 
	`ş—r_ex‹Á_b™s
(&
rc
->
´oûs£d_blocks
, 0, (
u64
)-1, 
EXTENT_DIRTY
);

3762 ià(
Œªs
) {

3763 
	`bŒfs_’d_Œª§ùiÚ_thrÙe
(
Œªs
);

3764 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

3767 ià(!
”r
) {

3768 
»t
 = 
	`»loÿ‹_fe_ex‹Á_şu¡”
(
rc
->
d©a_šode
,

3769 &
rc
->
şu¡”
);

3770 ià(
»t
 < 0)

3771 
”r
 = 
»t
;

3774 
rc
->
ü—‹_»loc_Œ“
 = 0;

3775 
	`£t_»loc_cÚŒŞ
(
rc
);

3777 
	`bŒfs_back»f_»Ëa£_ÿche
(&
rc
->
back»f_ÿche
);

3778 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rc
->
block_rsv
, (
u64
)-1, 
NULL
);

3788 
”r
 = 
	`´•¬e_to_m”ge
(
rc
,ƒrr);

3790 
	`m”ge_»loc_roÙs
(
rc
);

3792 
rc
->
m”ge_»loc_Œ“
 = 0;

3793 
	`un£t_»loc_cÚŒŞ
(
rc
);

3794 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rc
->
block_rsv
, (
u64
)-1, 
NULL
);

3797 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
rc
->
ex‹Á_roÙ
);

3798 ià(
	`IS_ERR
(
Œªs
)) {

3799 
”r
 = 
	`PTR_ERR
(
Œªs
);

3800 
out_ä“
;

3802 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

3803 ià(
»t
 && !
”r
)

3804 
”r
 = 
»t
;

3805 
out_ä“
:

3806 
»t
 = 
	`ş—n_dœty_subvŞs
(
rc
);

3807 ià(
»t
 < 0 && !
”r
)

3808 
”r
 = 
»t
;

3809 
	`bŒfs_ä“_block_rsv
(
fs_šfo
, 
rc
->
block_rsv
);

3810 
	`bŒfs_ä“_·th
(
·th
);

3811  
”r
;

3812 
	}
}

3814 
	$__š£¹_Üphª_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3815 
bŒfs_roÙ
 *
roÙ
, 
u64
 
objeùid
)

3817 
bŒfs_·th
 *
·th
;

3818 
bŒfs_šode_™em
 *
™em
;

3819 
ex‹Á_bufãr
 *
Ëaf
;

3820 
»t
;

3822 
·th
 = 
	`bŒfs_®loc_·th
();

3823 ià(!
·th
)

3824  -
ENOMEM
;

3826 
»t
 = 
	`bŒfs_š£¹_em±y_šode
(
Œªs
, 
roÙ
, 
·th
, 
objeùid
);

3827 ià(
»t
)

3828 
out
;

3830 
Ëaf
 = 
·th
->
nodes
[0];

3831 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_šode_™em
);

3832 
	`memz”o_ex‹Á_bufãr
(
Ëaf
, ()
™em
, (*item));

3833 
	`bŒfs_£t_šode_g’”©iÚ
(
Ëaf
, 
™em
, 1);

3834 
	`bŒfs_£t_šode_size
(
Ëaf
, 
™em
, 0);

3835 
	`bŒfs_£t_šode_mode
(
Ëaf
, 
™em
, 
S_IFREG
 | 0600);

3836 
	`bŒfs_£t_šode_æags
(
Ëaf
, 
™em
, 
BTRFS_INODE_NOCOMPRESS
 |

3837 
BTRFS_INODE_PREALLOC
);

3838 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

3839 
out
:

3840 
	`bŒfs_ä“_·th
(
·th
);

3841  
»t
;

3842 
	}
}

3844 
	$d–‘e_Üphª_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3845 
bŒfs_roÙ
 *
roÙ
, 
u64
 
objeùid
)

3847 
bŒfs_·th
 *
·th
;

3848 
bŒfs_key
 
key
;

3849 
»t
 = 0;

3851 
·th
 = 
	`bŒfs_®loc_·th
();

3852 ià(!
·th
) {

3853 
»t
 = -
ENOMEM
;

3854 
out
;

3857 
key
.
objeùid
 = objectid;

3858 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

3859 
key
.
off£t
 = 0;

3860 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

3861 ià(
»t
) {

3862 ià(
»t
 > 0)

3863 
»t
 = -
ENOENT
;

3864 
out
;

3866 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

3867 
out
:

3868 ià(
»t
)

3869 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3870 
	`bŒfs_ä“_·th
(
·th
);

3871 
	}
}

3877 
nošlše_fÜ_¡ack


3878 
šode
 *
	$ü—‹_»loc_šode
(
bŒfs_fs_šfo
 *
fs_šfo
,

3879 
bŒfs_block_group
 *
group
)

3881 
šode
 *šodğ
NULL
;

3882 
bŒfs_Œªs_hªdË
 *
Œªs
;

3883 
bŒfs_roÙ
 *
roÙ
;

3884 
u64
 
objeùid
;

3885 
”r
 = 0;

3887 
roÙ
 = 
	`bŒfs_g¿b_roÙ
(
fs_šfo
->
d©a_»loc_roÙ
);

3888 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 6);

3889 ià(
	`IS_ERR
(
Œªs
)) {

3890 
	`bŒfs_put_roÙ
(
roÙ
);

3891  
	`ERR_CAST
(
Œªs
);

3894 
”r
 = 
	`bŒfs_g‘_ä“_objeùid
(
roÙ
, &
objeùid
);

3895 ià(
”r
)

3896 
out
;

3898 
”r
 = 
	`__š£¹_Üphª_šode
(
Œªs
, 
roÙ
, 
objeùid
);

3899 ià(
”r
)

3900 
out
;

3902 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
objeùid
, 
roÙ
);

3903 ià(
	`IS_ERR
(
šode
)) {

3904 
	`d–‘e_Üphª_šode
(
Œªs
, 
roÙ
, 
objeùid
);

3905 
”r
 = 
	`PTR_ERR
(
šode
);

3906 
šode
 = 
NULL
;

3907 
out
;

3909 
	`BTRFS_I
(
šode
)->
šdex_út
 = 
group
->
¡¬t
;

3911 
”r
 = 
	`bŒfs_Üphª_add
(
Œªs
, 
	`BTRFS_I
(
šode
));

3912 
out
:

3913 
	`bŒfs_put_roÙ
(
roÙ
);

3914 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3915 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

3916 ià(
”r
) {

3917 
	`ut
(
šode
);

3918 
šode
 = 
	`ERR_PTR
(
”r
);

3920  
šode
;

3921 
	}
}

3932 
	$»loc_chunk_¡¬t
(
bŒfs_fs_šfo
 *
fs_šfo
)

3934 ià(
	`‹¡_ªd_£t_b™
(
BTRFS_FS_RELOC_RUNNING
, &
fs_šfo
->
æags
)) {

3936 
	`bŒfs_”r
(
fs_šfo
, "reloc‡lready„unning, cannot start");

3937  -
EINPROGRESS
;

3940 ià(
	`©omic_»ad
(&
fs_šfo
->
»loc_ÿnûl_»q
) > 0) {

3941 
	`bŒfs_šfo
(
fs_šfo
, "chunk„elocation canceled on start");

3946 
	`©omic_£t
(&
fs_šfo
->
»loc_ÿnûl_»q
, 0);

3947  -
ECANCELED
;

3950 
	}
}

3955 
	$»loc_chunk_’d
(
bŒfs_fs_šfo
 *
fs_šfo
)

3958 ià(
	`©omic_»ad
(&
fs_šfo
->
»loc_ÿnûl_»q
) > 0)

3959 
	`bŒfs_šfo
(
fs_šfo
, "chunk„elocation canceled during operation");

3960 
	`ş—r_ªd_wake_up_b™
(
BTRFS_FS_RELOC_RUNNING
, &
fs_šfo
->
æags
);

3961 
	`©omic_£t
(&
fs_šfo
->
»loc_ÿnûl_»q
, 0);

3962 
	}
}

3964 
»loc_cÚŒŞ
 *
	$®loc_»loc_cÚŒŞ
(
bŒfs_fs_šfo
 *
fs_šfo
)

3966 
»loc_cÚŒŞ
 *
rc
;

3968 
rc
 = 
	`kz®loc
((*rc), 
GFP_NOFS
);

3969 ià(!
rc
)

3970  
NULL
;

3972 
	`INIT_LIST_HEAD
(&
rc
->
»loc_roÙs
);

3973 
	`INIT_LIST_HEAD
(&
rc
->
dœty_subvŞ_roÙs
);

3974 
	`bŒfs_back»f_š™_ÿche
(
fs_šfo
, &
rc
->
back»f_ÿche
, 1);

3975 
	`m­pšg_Œ“_š™
(&
rc
->
»loc_roÙ_Œ“
);

3976 
	`ex‹Á_io_Œ“_š™
(
fs_šfo
, &
rc
->
´oûs£d_blocks
, 
IO_TREE_RELOC_BLOCKS
);

3977  
rc
;

3978 
	}
}

3980 
	$ä“_»loc_cÚŒŞ
(
»loc_cÚŒŞ
 *
rc
)

3982 
m­pšg_node
 *
node
, *
tmp
;

3984 
	`ä“_»loc_roÙs
(&
rc
->
»loc_roÙs
);

3985 
	`rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
node
, 
tmp
,

3986 &
rc
->
»loc_roÙ_Œ“
.
rb_roÙ
, 
rb_node
)

3987 
	`kä“
(
node
);

3989 
	`kä“
(
rc
);

3990 
	}
}

3995 
	$desüibe_»loÿtiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
,

3996 
bŒfs_block_group
 *
block_group
)

3998 
buf
[128] = {'\0'};

4000 
	`bŒfs_desüibe_block_groups
(
block_group
->
æags
, 
buf
, (buf));

4002 
	`bŒfs_šfo
(
fs_šfo
,

4004 
block_group
->
¡¬t
, 
buf
);

4005 
	}
}

4007 cÚ¡ *
	$¡age_to_¡ršg
(
¡age
)

4009 ià(
¡age
 =ğ
MOVE_DATA_EXTENTS
)

4011 ià(
¡age
 =ğ
UPDATE_DATA_PTRS
)

4014 
	}
}

4019 
	$bŒfs_»loÿ‹_block_group
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
group_¡¬t
)

4021 
bŒfs_block_group
 *
bg
;

4022 
bŒfs_roÙ
 *
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 
group_¡¬t
);

4023 
»loc_cÚŒŞ
 *
rc
;

4024 
šode
 *inode;

4025 
bŒfs_·th
 *
·th
;

4026 
»t
;

4027 
rw
 = 0;

4028 
”r
 = 0;

4035 
»t
 = 
	`wa™_Ú_b™
(&
fs_šfo
->
æags
, 
BTRFS_FS_UNFINISHED_DROPS
, 
TASK_INTERRUPTIBLE
);

4036 ià(
»t
)

4037  
»t
;

4040 ià(
	`bŒfs_fs_şosšg
(
fs_šfo
))

4041  -
EINTR
;

4043 
bg
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
group_¡¬t
);

4044 ià(!
bg
)

4045  -
ENOENT
;

4055 ià(
bg
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

4056 
	`ASSERT
(
	`sb_wr™e_¡¬‹d
(
fs_šfo
->
sb
));

4058 ià(
	`bŒfs_pšÃd_by_sw­fe
(
fs_šfo
, 
bg
)) {

4059 
	`bŒfs_put_block_group
(
bg
);

4060  -
ETXTBSY
;

4063 
rc
 = 
	`®loc_»loc_cÚŒŞ
(
fs_šfo
);

4064 ià(!
rc
) {

4065 
	`bŒfs_put_block_group
(
bg
);

4066  -
ENOMEM
;

4069 
»t
 = 
	`»loc_chunk_¡¬t
(
fs_šfo
);

4070 ià(
»t
 < 0) {

4071 
”r
 = 
»t
;

4072 
out_put_bg
;

4075 
rc
->
ex‹Á_roÙ
 =ƒxtent_root;

4076 
rc
->
block_group
 = 
bg
;

4078 
»t
 = 
	`bŒfs_šc_block_group_ro
(
rc
->
block_group
, 
Œue
);

4079 ià(
»t
) {

4080 
”r
 = 
»t
;

4081 
out
;

4083 
rw
 = 1;

4085 
·th
 = 
	`bŒfs_®loc_·th
();

4086 ià(!
·th
) {

4087 
”r
 = -
ENOMEM
;

4088 
out
;

4091 
šode
 = 
	`lookup_ä“_¥aû_šode
(
rc
->
block_group
, 
·th
);

4092 
	`bŒfs_ä“_·th
(
·th
);

4094 ià(!
	`IS_ERR
(
šode
))

4095 
»t
 = 
	`d–‘e_block_group_ÿche
(
fs_šfo
, 
rc
->
block_group
, 
šode
, 0);

4097 
»t
 = 
	`PTR_ERR
(
šode
);

4099 ià(
»t
 &&„‘ !ğ-
ENOENT
) {

4100 
”r
 = 
»t
;

4101 
out
;

4104 
rc
->
d©a_šode
 = 
	`ü—‹_»loc_šode
(
fs_šfo
,„c->
block_group
);

4105 ià(
	`IS_ERR
(
rc
->
d©a_šode
)) {

4106 
”r
 = 
	`PTR_ERR
(
rc
->
d©a_šode
);

4107 
rc
->
d©a_šode
 = 
NULL
;

4108 
out
;

4111 
	`desüibe_»loÿtiÚ
(
fs_šfo
, 
rc
->
block_group
);

4113 
	`bŒfs_wa™_block_group_»£rv©iÚs
(
rc
->
block_group
);

4114 
	`bŒfs_wa™_nocow_wr™”s
(
rc
->
block_group
);

4115 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
U64_MAX
,

4116 
rc
->
block_group
->
¡¬t
,

4117 
rc
->
block_group
->
Ëngth
);

4119 
»t
 = 
	`bŒfs_zÚe_fšish
(
rc
->
block_group
);

4120 
	`WARN_ON
(
»t
 &&„‘ !ğ-
EAGAIN
);

4123 
fšishes_¡age
;

4125 
	`mu‹x_lock
(&
fs_šfo
->
ş—Ãr_mu‹x
);

4126 
»t
 = 
	`»loÿ‹_block_group
(
rc
);

4127 
	`mu‹x_uÆock
(&
fs_šfo
->
ş—Ãr_mu‹x
);

4128 ià(
»t
 < 0)

4129 
”r
 = 
»t
;

4131 
fšishes_¡age
 = 
rc
->
¡age
;

4141 ià(
rc
->
¡age
 =ğ
MOVE_DATA_EXTENTS
 &&„c->
found_fe_ex‹Á
) {

4142 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
rc
->
d©a_šode
, 0,

4143 (
u64
)-1);

4144 ià(
»t
)

4145 
”r
 = 
»t
;

4146 
	`šv®id©e_m­pšg_·ges
(
rc
->
d©a_šode
->
i_m­pšg
,

4148 
rc
->
¡age
 = 
UPDATE_DATA_PTRS
;

4151 ià(
”r
 < 0)

4152 
out
;

4154 ià(
rc
->
ex‹Ás_found
 == 0)

4157 
	`bŒfs_šfo
(
fs_šfo
, "found %lluƒxtents, stage: %s",

4158 
rc
->
ex‹Ás_found
, 
	`¡age_to_¡ršg
(
fšishes_¡age
));

4161 
	`WARN_ON
(
rc
->
block_group
->
pšÃd
 > 0);

4162 
	`WARN_ON
(
rc
->
block_group
->
»£rved
 > 0);

4163 
	`WARN_ON
(
rc
->
block_group
->
u£d
 > 0);

4164 
out
:

4165 ià(
”r
 && 
rw
)

4166 
	`bŒfs_dec_block_group_ro
(
rc
->
block_group
);

4167 
	`ut
(
rc
->
d©a_šode
);

4168 
out_put_bg
:

4169 
	`bŒfs_put_block_group
(
bg
);

4170 
	`»loc_chunk_’d
(
fs_šfo
);

4171 
	`ä“_»loc_cÚŒŞ
(
rc
);

4172  
”r
;

4173 
	}
}

4175 
nošlše_fÜ_¡ack
 
	$m¬k_g¬bage_roÙ
(
bŒfs_roÙ
 *
roÙ
)

4177 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4178 
bŒfs_Œªs_hªdË
 *
Œªs
;

4179 
»t
, 
”r
;

4181 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
fs_šfo
->
Œ“_roÙ
, 0);

4182 ià(
	`IS_ERR
(
Œªs
))

4183  
	`PTR_ERR
(
Œªs
);

4185 
	`mem£t
(&
roÙ
->
roÙ_™em
.
drİ_´og»ss
, 0,

4186 (
roÙ
->
roÙ_™em
.
drİ_´og»ss
));

4187 
	`bŒfs_£t_roÙ_drİ_Ëv–
(&
roÙ
->
roÙ_™em
, 0);

4188 
	`bŒfs_£t_roÙ_»fs
(&
roÙ
->
roÙ_™em
, 0);

4189 
»t
 = 
	`bŒfs_upd©e_roÙ
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
,

4190 &
roÙ
->
roÙ_key
, &roÙ->
roÙ_™em
);

4192 
”r
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4193 ià(
”r
)

4194  
”r
;

4195  
»t
;

4196 
	}
}

4204 
	$bŒfs_»cov”_»loÿtiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
)

4206 
	`LIST_HEAD
(
»loc_roÙs
);

4207 
bŒfs_key
 
key
;

4208 
bŒfs_roÙ
 *
fs_roÙ
;

4209 
bŒfs_roÙ
 *
»loc_roÙ
;

4210 
bŒfs_·th
 *
·th
;

4211 
ex‹Á_bufãr
 *
Ëaf
;

4212 
»loc_cÚŒŞ
 *
rc
 = 
NULL
;

4213 
bŒfs_Œªs_hªdË
 *
Œªs
;

4214 
»t
;

4215 
”r
 = 0;

4217 
·th
 = 
	`bŒfs_®loc_·th
();

4218 ià(!
·th
)

4219  -
ENOMEM
;

4220 
·th
->
»ada
 = 
READA_BACK
;

4222 
key
.
objeùid
 = 
BTRFS_TREE_RELOC_OBJECTID
;

4223 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

4224 
key
.
off£t
 = (
u64
)-1;

4227 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_šfo
->
Œ“_roÙ
, &
key
,

4228 
·th
, 0, 0);

4229 ià(
»t
 < 0) {

4230 
”r
 = 
»t
;

4231 
out
;

4233 ià(
»t
 > 0) {

4234 ià(
·th
->
¦Ùs
[0] == 0)

4236 
·th
->
¦Ùs
[0]--;

4238 
Ëaf
 = 
·th
->
nodes
[0];

4239 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

4240 
	`bŒfs_»Ëa£_·th
(
·th
);

4242 ià(
key
.
objeùid
 !ğ
BTRFS_TREE_RELOC_OBJECTID
 ||

4243 
key
.
ty³
 !ğ
BTRFS_ROOT_ITEM_KEY
)

4246 
»loc_roÙ
 = 
	`bŒfs_»ad_Œ“_roÙ
(
fs_šfo
->
Œ“_roÙ
, &
key
);

4247 ià(
	`IS_ERR
(
»loc_roÙ
)) {

4248 
”r
 = 
	`PTR_ERR
(
»loc_roÙ
);

4249 
out
;

4252 
	`£t_b™
(
BTRFS_ROOT_SHAREABLE
, &
»loc_roÙ
->
¡©e
);

4253 
	`li¡_add
(&
»loc_roÙ
->
roÙ_li¡
, &
»loc_roÙs
);

4255 ià(
	`bŒfs_roÙ_»fs
(&
»loc_roÙ
->
roÙ_™em
) > 0) {

4256 
fs_roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
,

4257 
»loc_roÙ
->
roÙ_key
.
off£t
, 
çl£
);

4258 ià(
	`IS_ERR
(
fs_roÙ
)) {

4259 
»t
 = 
	`PTR_ERR
(
fs_roÙ
);

4260 ià(
»t
 !ğ-
ENOENT
) {

4261 
”r
 = 
»t
;

4262 
out
;

4264 
»t
 = 
	`m¬k_g¬bage_roÙ
(
»loc_roÙ
);

4265 ià(
»t
 < 0) {

4266 
”r
 = 
»t
;

4267 
out
;

4270 
	`bŒfs_put_roÙ
(
fs_roÙ
);

4274 ià(
key
.
off£t
 == 0)

4277 
key
.
off£t
--;

4279 
	`bŒfs_»Ëa£_·th
(
·th
);

4281 ià(
	`li¡_em±y
(&
»loc_roÙs
))

4282 
out
;

4284 
rc
 = 
	`®loc_»loc_cÚŒŞ
(
fs_šfo
);

4285 ià(!
rc
) {

4286 
”r
 = -
ENOMEM
;

4287 
out
;

4290 
»t
 = 
	`»loc_chunk_¡¬t
(
fs_šfo
);

4291 ià(
»t
 < 0) {

4292 
”r
 = 
»t
;

4293 
out_’d
;

4296 
rc
->
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 0);

4298 
	`£t_»loc_cÚŒŞ
(
rc
);

4300 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
rc
->
ex‹Á_roÙ
);

4301 ià(
	`IS_ERR
(
Œªs
)) {

4302 
”r
 = 
	`PTR_ERR
(
Œªs
);

4303 
out_un£t
;

4306 
rc
->
m”ge_»loc_Œ“
 = 1;

4308 !
	`li¡_em±y
(&
»loc_roÙs
)) {

4309 
»loc_roÙ
 = 
	`li¡_’Œy
(
»loc_roÙs
.
Ãxt
,

4310 
bŒfs_roÙ
, 
roÙ_li¡
);

4311 
	`li¡_d–
(&
»loc_roÙ
->
roÙ_li¡
);

4313 ià(
	`bŒfs_roÙ_»fs
(&
»loc_roÙ
->
roÙ_™em
) == 0) {

4314 
	`li¡_add_
(&
»loc_roÙ
->
roÙ_li¡
,

4315 &
rc
->
»loc_roÙs
);

4319 
fs_roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
»loc_roÙ
->
roÙ_key
.
off£t
,

4320 
çl£
);

4321 ià(
	`IS_ERR
(
fs_roÙ
)) {

4322 
”r
 = 
	`PTR_ERR
(
fs_roÙ
);

4323 
	`li¡_add_
(&
»loc_roÙ
->
roÙ_li¡
, &
»loc_roÙs
);

4324 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4325 
out_un£t
;

4328 
”r
 = 
	`__add_»loc_roÙ
(
»loc_roÙ
);

4329 
	`ASSERT
(
”r
 !ğ-
EEXIST
);

4330 ià(
”r
) {

4331 
	`li¡_add_
(&
»loc_roÙ
->
roÙ_li¡
, &
»loc_roÙs
);

4332 
	`bŒfs_put_roÙ
(
fs_roÙ
);

4333 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4334 
out_un£t
;

4336 
fs_roÙ
->
»loc_roÙ
 = 
	`bŒfs_g¿b_roÙ
(reloc_root);

4337 
	`bŒfs_put_roÙ
(
fs_roÙ
);

4340 
”r
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

4341 ià(
”r
)

4342 
out_un£t
;

4344 
	`m”ge_»loc_roÙs
(
rc
);

4346 
	`un£t_»loc_cÚŒŞ
(
rc
);

4348 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
rc
->
ex‹Á_roÙ
);

4349 ià(
	`IS_ERR
(
Œªs
)) {

4350 
”r
 = 
	`PTR_ERR
(
Œªs
);

4351 
out_ş—n
;

4353 
”r
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

4354 
out_ş—n
:

4355 
»t
 = 
	`ş—n_dœty_subvŞs
(
rc
);

4356 ià(
»t
 < 0 && !
”r
)

4357 
”r
 = 
»t
;

4358 
out_un£t
:

4359 
	`un£t_»loc_cÚŒŞ
(
rc
);

4360 
out_’d
:

4361 
	`»loc_chunk_’d
(
fs_šfo
);

4362 
	`ä“_»loc_cÚŒŞ
(
rc
);

4363 
out
:

4364 
	`ä“_»loc_roÙs
(&
»loc_roÙs
);

4366 
	`bŒfs_ä“_·th
(
·th
);

4368 ià(
”r
 == 0) {

4370 
fs_roÙ
 = 
	`bŒfs_g¿b_roÙ
(
fs_šfo
->
d©a_»loc_roÙ
);

4371 
	`ASSERT
(
fs_roÙ
);

4372 
”r
 = 
	`bŒfs_Üphª_ş—nup
(
fs_roÙ
);

4373 
	`bŒfs_put_roÙ
(
fs_roÙ
);

4375  
”r
;

4376 
	}
}

4384 
	$bŒfs_»loc_şÚe_csums
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
)

4386 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
Üd”ed
->inode);

4387 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

4388 
u64
 
disk_by‹Ä
 = 
Üd”ed
->
fe_off£t
 + 
šode
->
šdex_út
;

4389 
bŒfs_roÙ
 *
csum_roÙ
 = 
	`bŒfs_csum_roÙ
(
fs_šfo
, 
disk_by‹Ä
);

4390 
	`LIST_HEAD
(
li¡
);

4391 
»t
;

4393 
»t
 = 
	`bŒfs_lookup_csums_li¡
(
csum_roÙ
, 
disk_by‹Ä
,

4394 
disk_by‹Ä
 + 
Üd”ed
->
num_by‹s
 - 1,

4395 &
li¡
, 0, 
çl£
);

4396 ià(
»t
)

4397  
»t
;

4399 !
	`li¡_em±y
(&
li¡
)) {

4400 
bŒfs_Üd”ed_sum
 *
sums
 =

4401 
	`li¡_’Œy
(
li¡
.
Ãxt
, 
bŒfs_Üd”ed_sum
,†ist);

4403 
	`li¡_d–_š™
(&
sums
->
li¡
);

4417 
sums
->
logiÿl
 = 
Üd”ed
->
disk_by‹Ä
 + sums->logical - disk_bytenr;

4418 
	`bŒfs_add_Üd”ed_sum
(
Üd”ed
, 
sums
);

4422 
	}
}

4424 
	$bŒfs_»loc_cow_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4425 
bŒfs_roÙ
 *
roÙ
, 
ex‹Á_bufãr
 *
buf
,

4426 
ex‹Á_bufãr
 *
cow
)

4428 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4429 
»loc_cÚŒŞ
 *
rc
;

4430 
bŒfs_back»f_node
 *
node
;

4431 
fœ¡_cow
 = 0;

4432 
Ëv–
;

4433 
»t
 = 0;

4435 
rc
 = 
fs_šfo
->
»loc_ùl
;

4436 ià(!
rc
)

4439 
	`BUG_ON
(
rc
->
¡age
 =ğ
UPDATE_DATA_PTRS
 && 
	`bŒfs_is_d©a_»loc_roÙ
(
roÙ
));

4441 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
buf
);

4442 ià(
	`bŒfs_h—d”_g’”©iÚ
(
buf
) <=

4443 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
))

4444 
fœ¡_cow
 = 1;

4446 ià(
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
 &&

4447 
rc
->
ü—‹_»loc_Œ“
) {

4448 
	`WARN_ON
(!
fœ¡_cow
 && 
Ëv–
 == 0);

4450 
node
 = 
rc
->
back»f_ÿche
.
·th
[
Ëv–
];

4451 
	`BUG_ON
(
node
->
by‹Ä
 !ğ
buf
->
¡¬t
 &&

4452 
node
->
Ãw_by‹Ä
 !ğ
buf
->
¡¬t
);

4454 
	`bŒfs_back»f_drİ_node_bufãr
(
node
);

4455 
	`©omic_šc
(&
cow
->
»fs
);

4456 
node
->
eb
 = 
cow
;

4457 
node
->
Ãw_by‹Ä
 = 
cow
->
¡¬t
;

4459 ià(!
node
->
³ndšg
) {

4460 
	`li¡_move_
(&
node
->
li¡
,

4461 &
rc
->
back»f_ÿche
.
³ndšg
[
Ëv–
]);

4462 
node
->
³ndšg
 = 1;

4465 ià(
fœ¡_cow
)

4466 
	`m¬k_block_´oûs£d
(
rc
, 
node
);

4468 ià(
fœ¡_cow
 && 
Ëv–
 > 0)

4469 
rc
->
nodes_»loÿ‹d
 +ğ
buf
->
Ën
;

4472 ià(
Ëv–
 =ğ0 && 
fœ¡_cow
 && 
rc
->
¡age
 =ğ
UPDATE_DATA_PTRS
)

4473 
»t
 = 
	`»¶aû_fe_ex‹Ás
(
Œªs
, 
rc
, 
roÙ
, 
cow
);

4474  
»t
;

4475 
	}
}

4481 
	$bŒfs_»loc_´e_¢­shÙ
(
bŒfs_³ndšg_¢­shÙ
 *
³ndšg
,

4482 
u64
 *
by‹s_to_»£rve
)

4484 
bŒfs_roÙ
 *
roÙ
 = 
³ndšg
->root;

4485 
»loc_cÚŒŞ
 *
rc
 = 
roÙ
->
fs_šfo
->
»loc_ùl
;

4487 ià(!
rc
 || !
	`have_»loc_roÙ
(
roÙ
))

4490 ià(!
rc
->
m”ge_»loc_Œ“
)

4493 
roÙ
 =„oÙ->
»loc_roÙ
;

4494 
	`BUG_ON
(
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0);

4505 *
by‹s_to_»£rve
 +ğ
rc
->
nodes_»loÿ‹d
;

4506 
	}
}

4516 
	$bŒfs_»loc_po¡_¢­shÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4517 
bŒfs_³ndšg_¢­shÙ
 *
³ndšg
)

4519 
bŒfs_roÙ
 *
roÙ
 = 
³ndšg
->root;

4520 
bŒfs_roÙ
 *
»loc_roÙ
;

4521 
bŒfs_roÙ
 *
Ãw_roÙ
;

4522 
»loc_cÚŒŞ
 *
rc
 = 
roÙ
->
fs_šfo
->
»loc_ùl
;

4523 
»t
;

4525 ià(!
rc
 || !
	`have_»loc_roÙ
(
roÙ
))

4528 
rc
 = 
roÙ
->
fs_šfo
->
»loc_ùl
;

4529 
rc
->
m”gšg_rsv_size
 +ğrc->
nodes_»loÿ‹d
;

4531 ià(
rc
->
m”ge_»loc_Œ“
) {

4532 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(&
³ndšg
->
block_rsv
,

4533 
rc
->
block_rsv
,

4534 
rc
->
nodes_»loÿ‹d
, 
Œue
);

4535 ià(
»t
)

4536  
»t
;

4539 
Ãw_roÙ
 = 
³ndšg
->
¢­
;

4540 
»loc_roÙ
 = 
	`ü—‹_»loc_roÙ
(
Œªs
, 
roÙ
->reloc_root,

4541 
Ãw_roÙ
->
roÙ_key
.
objeùid
);

4542 ià(
	`IS_ERR
(
»loc_roÙ
))

4543  
	`PTR_ERR
(
»loc_roÙ
);

4545 
»t
 = 
	`__add_»loc_roÙ
(
»loc_roÙ
);

4546 
	`ASSERT
(
»t
 !ğ-
EEXIST
);

4547 ià(
»t
) {

4549 
	`bŒfs_put_roÙ
(
»loc_roÙ
);

4550  
»t
;

4552 
Ãw_roÙ
->
»loc_roÙ
 = 
	`bŒfs_g¿b_roÙ
(reloc_root);

4554 ià(
rc
->
ü—‹_»loc_Œ“
)

4555 
»t
 = 
	`şÚe_back»f_node
(
Œªs
, 
rc
, 
roÙ
, 
»loc_roÙ
);

4556  
»t
;

4557 
	}
}

4564 
u64
 
	$bŒfs_g‘_»loc_bg_by‹Ä
(
bŒfs_fs_šfo
 *
fs_šfo
)

4566 
u64
 
logiÿl
 = 
U64_MAX
;

4568 
	`lockd•_as£¹_h–d
(&
fs_šfo
->
»loc_mu‹x
);

4570 ià(
fs_šfo
->
»loc_ùl
 && fs_šfo->»loc_ùl->
block_group
)

4571 
logiÿl
 = 
fs_šfo
->
»loc_ùl
->
block_group
->
¡¬t
;

4572  
logiÿl
;

4573 
	}
}

	@relocation.h

3 #iâdeà
BTRFS_RELOCATION_H


4 
	#BTRFS_RELOCATION_H


	)

6 
bŒfs_»loÿ‹_block_group
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
group_¡¬t
);

7 
bŒfs_š™_»loc_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
);

8 
bŒfs_upd©e_»loc_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

9 
bŒfs_roÙ
 *
roÙ
);

10 
bŒfs_»cov”_»loÿtiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
);

11 
bŒfs_»loc_şÚe_csums
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
);

12 
bŒfs_»loc_cow_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

13 
bŒfs_roÙ
 *
roÙ
, 
ex‹Á_bufãr
 *
buf
,

14 
ex‹Á_bufãr
 *
cow
);

15 
bŒfs_»loc_´e_¢­shÙ
(
bŒfs_³ndšg_¢­shÙ
 *
³ndšg
,

16 
u64
 *
by‹s_to_»£rve
);

17 
bŒfs_»loc_po¡_¢­shÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

18 
bŒfs_³ndšg_¢­shÙ
 *
³ndšg
);

19 
bŒfs_should_ÿnûl_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
);

20 
bŒfs_roÙ
 *
fšd_»loc_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
);

21 
bŒfs_should_ignÜe_»loc_roÙ
(
bŒfs_roÙ
 *
roÙ
);

22 
u64
 
bŒfs_g‘_»loc_bg_by‹Ä
(
bŒfs_fs_šfo
 *
fs_šfo
);

	@root-tree.c

6 
	~<lšux/”r.h
>

7 
	~<lšux/uuid.h
>

8 
	~"ù»e.h
"

9 
	~"fs.h
"

10 
	~"mes§ges.h
"

11 
	~"Œª§ùiÚ.h
"

12 
	~"disk-io.h
"

13 
	~"´št-Œ“.h
"

14 
	~"qgroup.h
"

15 
	~"¥aû-šfo.h
"

16 
	~"acûssÜs.h
"

17 
	~"roÙ-Œ“.h
"

18 
	~"Üphª.h
"

27 
	$bŒfs_»ad_roÙ_™em
(
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

28 
bŒfs_roÙ_™em
 *
™em
)

30 
u32
 
Ën
;

31 
Ãed_»£t
 = 0;

33 
Ën
 = 
	`bŒfs_™em_size
(
eb
, 
¦Ù
);

34 
	`»ad_ex‹Á_bufãr
(
eb
, 
™em
, 
	`bŒfs_™em_±r_off£t
Ób, 
¦Ù
),

35 
	`mš_t
(
u32
, 
Ën
, (*
™em
)));

36 ià(
Ën
 < (*
™em
))

37 
Ãed_»£t
 = 1;

38 ià(!
Ãed_»£t
 && 
	`bŒfs_roÙ_g’”©iÚ
(
™em
)

39 !ğ
	`bŒfs_roÙ_g’”©iÚ_v2
(
™em
)) {

40 ià(
	`bŒfs_roÙ_g’”©iÚ_v2
(
™em
) != 0) {

41 
	`bŒfs_w¬n
(
eb
->
fs_šfo
,

44 
Ãed_»£t
 = 1;

46 ià(
Ãed_»£t
) {

48 
	`mem£t_¡¬t
(
™em
, 0, 
g’”©iÚ_v2
);

49 
	`g’”©e_¿ndom_guid
(
™em
->
uuid
);

51 
	}
}

67 
	$bŒfs_fšd_roÙ
(
bŒfs_roÙ
 *
roÙ
, cÚ¡ 
bŒfs_key
 *
£¬ch_key
,

68 
bŒfs_·th
 *
·th
, 
bŒfs_roÙ_™em
 *
roÙ_™em
,

69 
bŒfs_key
 *
roÙ_key
)

71 
bŒfs_key
 
found_key
;

72 
ex‹Á_bufãr
 *
l
;

73 
»t
;

74 
¦Ù
;

76 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, 
£¬ch_key
, 
·th
, 0, 0);

77 ià(
»t
 < 0)

78  
»t
;

80 ià(
£¬ch_key
->
off£t
 != -1ULL) {

81 ià(
»t
 > 0)

82 
out
;

84 
	`BUG_ON
(
»t
 == 0);

85 ià(
·th
->
¦Ùs
[0] == 0)

86 
out
;

87 
·th
->
¦Ùs
[0]--;

88 
»t
 = 0;

91 
l
 = 
·th
->
nodes
[0];

92 
¦Ù
 = 
·th
->
¦Ùs
[0];

94 
	`bŒfs_™em_key_to_ıu
(
l
, &
found_key
, 
¦Ù
);

95 ià(
found_key
.
objeùid
 !ğ
£¬ch_key
->objectid ||

96 
found_key
.
ty³
 !ğ
BTRFS_ROOT_ITEM_KEY
) {

97 
»t
 = 1;

98 
out
;

101 ià(
roÙ_™em
)

102 
	`bŒfs_»ad_roÙ_™em
(
l
, 
¦Ù
, 
roÙ_™em
);

103 ià(
roÙ_key
)

104 
	`memıy
(
roÙ_key
, &
found_key
, (found_key));

105 
out
:

106 
	`bŒfs_»Ëa£_·th
(
·th
);

107  
»t
;

108 
	}
}

110 
	$bŒfs_£t_roÙ_node
(
bŒfs_roÙ_™em
 *
™em
,

111 
ex‹Á_bufãr
 *
node
)

113 
	`bŒfs_£t_roÙ_by‹Ä
(
™em
, 
node
->
¡¬t
);

114 
	`bŒfs_£t_roÙ_Ëv–
(
™em
, 
	`bŒfs_h—d”_Ëv–
(
node
));

115 
	`bŒfs_£t_roÙ_g’”©iÚ
(
™em
, 
	`bŒfs_h—d”_g’”©iÚ
(
node
));

116 
	}
}

121 
	$bŒfs_upd©e_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ


122 *
roÙ
, 
bŒfs_key
 *
key
, 
bŒfs_roÙ_™em


123 *
™em
)

125 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

126 
bŒfs_·th
 *
·th
;

127 
ex‹Á_bufãr
 *
l
;

128 
»t
;

129 
¦Ù
;

130 
±r
;

131 
u32
 
Şd_Ën
;

133 
·th
 = 
	`bŒfs_®loc_·th
();

134 ià(!
·th
)

135  -
ENOMEM
;

137 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, 
key
, 
·th
, 0, 1);

138 ià(
»t
 < 0)

139 
out
;

141 ià(
»t
 > 0) {

142 
	`bŒfs_ü™
(
fs_šfo
,

144 
key
->
objeùid
, key->
ty³
, key->
off£t
,

145 
roÙ
->
roÙ_key
.
objeùid
);

146 
»t
 = -
EUCLEAN
;

147 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

148 
out
;

151 
l
 = 
·th
->
nodes
[0];

152 
¦Ù
 = 
·th
->
¦Ùs
[0];

153 
±r
 = 
	`bŒfs_™em_±r_off£t
(
l
, 
¦Ù
);

154 
Şd_Ën
 = 
	`bŒfs_™em_size
(
l
, 
¦Ù
);

161 ià(
Şd_Ën
 < (*
™em
)) {

162 
	`bŒfs_»Ëa£_·th
(
·th
);

163 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, 
key
, 
·th
,

165 ià(
»t
 < 0) {

166 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

167 
out
;

170 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

171 ià(
»t
 < 0) {

172 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

173 
out
;

175 
	`bŒfs_»Ëa£_·th
(
·th
);

176 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
,

177 
key
, (*
™em
));

178 ià(
»t
 < 0) {

179 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

180 
out
;

182 
l
 = 
·th
->
nodes
[0];

183 
¦Ù
 = 
·th
->
¦Ùs
[0];

184 
±r
 = 
	`bŒfs_™em_±r_off£t
(
l
, 
¦Ù
);

191 
	`bŒfs_£t_roÙ_g’”©iÚ_v2
(
™em
, 
	`bŒfs_roÙ_g’”©iÚ
(item));

193 
	`wr™e_ex‹Á_bufãr
(
l
, 
™em
, 
±r
, (*item));

194 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·th
->
nodes
[0]);

195 
out
:

196 
	`bŒfs_ä“_·th
(
·th
);

197  
»t
;

198 
	}
}

200 
	$bŒfs_š£¹_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

201 cÚ¡ 
bŒfs_key
 *
key
, 
bŒfs_roÙ_™em
 *
™em
)

206 
	`bŒfs_£t_roÙ_g’”©iÚ_v2
(
™em
, 
	`bŒfs_roÙ_g’”©iÚ
(item));

207  
	`bŒfs_š£¹_™em
(
Œªs
, 
roÙ
, 
key
, 
™em
, (*item));

208 
	}
}

210 
	$bŒfs_fšd_Üphª_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
)

212 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

213 
ex‹Á_bufãr
 *
Ëaf
;

214 
bŒfs_·th
 *
·th
;

215 
bŒfs_key
 
key
;

216 
bŒfs_roÙ
 *
roÙ
;

217 
”r
 = 0;

218 
»t
;

220 
·th
 = 
	`bŒfs_®loc_·th
();

221 ià(!
·th
)

222  -
ENOMEM
;

224 
key
.
objeùid
 = 
BTRFS_ORPHAN_OBJECTID
;

225 
key
.
ty³
 = 
BTRFS_ORPHAN_ITEM_KEY
;

226 
key
.
off£t
 = 0;

229 
u64
 
roÙ_objeùid
;

231 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
Œ“_roÙ
, &
key
, 
·th
, 0, 0);

232 ià(
»t
 < 0) {

233 
”r
 = 
»t
;

237 
Ëaf
 = 
·th
->
nodes
[0];

238 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

239 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
Œ“_roÙ
, 
·th
);

240 ià(
»t
 < 0)

241 
”r
 = 
»t
;

242 ià(
»t
 != 0)

244 
Ëaf
 = 
·th
->
nodes
[0];

247 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

248 
	`bŒfs_»Ëa£_·th
(
·th
);

250 ià(
key
.
objeùid
 !ğ
BTRFS_ORPHAN_OBJECTID
 ||

251 
key
.
ty³
 !ğ
BTRFS_ORPHAN_ITEM_KEY
)

254 
roÙ_objeùid
 = 
key
.
off£t
;

255 
key
.
off£t
++;

257 
roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
roÙ_objeùid
, 
çl£
);

258 
”r
 = 
	`PTR_ERR_OR_ZERO
(
roÙ
);

259 ià(
”r
 &&ƒ¼ !ğ-
ENOENT
) {

261 } ià(
”r
 =ğ-
ENOENT
) {

262 
bŒfs_Œªs_hªdË
 *
Œªs
;

264 
	`bŒfs_»Ëa£_·th
(
·th
);

266 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
Œ“_roÙ
);

267 ià(
	`IS_ERR
(
Œªs
)) {

268 
”r
 = 
	`PTR_ERR
(
Œªs
);

269 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
”r
,

273 
”r
 = 
	`bŒfs_d–_Üphª_™em
(
Œªs
, 
Œ“_roÙ
,

274 
roÙ_objeùid
);

275 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

276 ià(
”r
) {

277 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
”r
,

284 
	`WARN_ON
(!
	`‹¡_b™
(
BTRFS_ROOT_ORPHAN_ITEM_INSERTED
, &
roÙ
->
¡©e
));

285 ià(
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0) {

286 
bŒfs_key
 
drİ_key
;

288 
	`bŒfs_disk_key_to_ıu
(&
drİ_key
, &
roÙ
->
roÙ_™em
.
drİ_´og»ss
);

295 ià(
drİ_key
.
objeùid
 !ğ0 || drİ_key.
ty³
 != 0 ||

296 
drİ_key
.
off£t
 != 0) {

297 
	`£t_b™
(
BTRFS_FS_UNFINISHED_DROPS
, &
fs_šfo
->
æags
);

298 
	`£t_b™
(
BTRFS_ROOT_UNFINISHED_DROP
, &
roÙ
->
¡©e
);

301 
	`£t_b™
(
BTRFS_ROOT_DEAD_TREE
, &
roÙ
->
¡©e
);

302 
	`bŒfs_add_d—d_roÙ
(
roÙ
);

304 
	`bŒfs_put_roÙ
(
roÙ
);

307 
	`bŒfs_ä“_·th
(
·th
);

308  
”r
;

309 
	}
}

312 
	$bŒfs_d–_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

313 cÚ¡ 
bŒfs_key
 *
key
)

315 
bŒfs_roÙ
 *
roÙ
 = 
Œªs
->
fs_šfo
->
Œ“_roÙ
;

316 
bŒfs_·th
 *
·th
;

317 
»t
;

319 
·th
 = 
	`bŒfs_®loc_·th
();

320 ià(!
·th
)

321  -
ENOMEM
;

322 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, 
key
, 
·th
, -1, 1);

323 ià(
»t
 < 0)

324 
out
;

326 
	`BUG_ON
(
»t
 != 0);

328 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

329 
out
:

330 
	`bŒfs_ä“_·th
(
·th
);

331  
»t
;

332 
	}
}

334 
	$bŒfs_d–_roÙ_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
roÙ_id
,

335 
u64
 
»f_id
, u64 
dœid
, u64 *
£qu’û
,

336 cÚ¡ 
fsüy±_¡r
 *
Çme
)

338 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
Œªs
->
fs_šfo
->tree_root;

339 
bŒfs_·th
 *
·th
;

340 
bŒfs_roÙ_»f
 *
»f
;

341 
ex‹Á_bufãr
 *
Ëaf
;

342 
bŒfs_key
 
key
;

343 
±r
;

344 
»t
;

346 
·th
 = 
	`bŒfs_®loc_·th
();

347 ià(!
·th
)

348  -
ENOMEM
;

350 
key
.
objeùid
 = 
roÙ_id
;

351 
key
.
ty³
 = 
BTRFS_ROOT_BACKREF_KEY
;

352 
key
.
off£t
 = 
»f_id
;

353 
agaš
:

354 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
Œ“_roÙ
, &
key
, 
·th
, -1, 1);

355 ià(
»t
 < 0) {

356 
out
;

357 } ià(
»t
 == 0) {

358 
Ëaf
 = 
·th
->
nodes
[0];

359 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

360 
bŒfs_roÙ_»f
);

361 
±r
 = ()(
»f
 + 1);

362 ià((
	`bŒfs_roÙ_»f_dœid
(
Ëaf
, 
»f
è!ğ
dœid
) ||

363 (
	`bŒfs_roÙ_»f_Çme_Ën
(
Ëaf
, 
»f
è!ğ
Çme
->
Ën
) ||

364 
	`memcmp_ex‹Á_bufãr
(
Ëaf
, 
Çme
->Çme, 
±r
,‚ame->
Ën
)) {

365 
»t
 = -
ENOENT
;

366 
out
;

368 *
£qu’û
 = 
	`bŒfs_roÙ_»f_£qu’û
(
Ëaf
, 
»f
);

370 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
Œ“_roÙ
, 
·th
);

371 ià(
»t
)

372 
out
;

374 
»t
 = -
ENOENT
;

375 
out
;

378 ià(
key
.
ty³
 =ğ
BTRFS_ROOT_BACKREF_KEY
) {

379 
	`bŒfs_»Ëa£_·th
(
·th
);

380 
key
.
objeùid
 = 
»f_id
;

381 
key
.
ty³
 = 
BTRFS_ROOT_REF_KEY
;

382 
key
.
off£t
 = 
roÙ_id
;

383 
agaš
;

386 
out
:

387 
	`bŒfs_ä“_·th
(
·th
);

388  
»t
;

389 
	}
}

406 
	$bŒfs_add_roÙ_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
roÙ_id
,

407 
u64
 
»f_id
, u64 
dœid
, u64 
£qu’û
,

408 cÚ¡ 
fsüy±_¡r
 *
Çme
)

410 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
Œªs
->
fs_šfo
->tree_root;

411 
bŒfs_key
 
key
;

412 
»t
;

413 
bŒfs_·th
 *
·th
;

414 
bŒfs_roÙ_»f
 *
»f
;

415 
ex‹Á_bufãr
 *
Ëaf
;

416 
±r
;

418 
·th
 = 
	`bŒfs_®loc_·th
();

419 ià(!
·th
)

420  -
ENOMEM
;

422 
key
.
objeùid
 = 
roÙ_id
;

423 
key
.
ty³
 = 
BTRFS_ROOT_BACKREF_KEY
;

424 
key
.
off£t
 = 
»f_id
;

425 
agaš
:

426 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
Œ“_roÙ
, 
·th
, &
key
,

427 (*
»f
è+ 
Çme
->
Ën
);

428 ià(
»t
) {

429 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

430 
	`bŒfs_ä“_·th
(
·th
);

431  
»t
;

434 
Ëaf
 = 
·th
->
nodes
[0];

435 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_roÙ_»f
);

436 
	`bŒfs_£t_roÙ_»f_dœid
(
Ëaf
, 
»f
, 
dœid
);

437 
	`bŒfs_£t_roÙ_»f_£qu’û
(
Ëaf
, 
»f
, 
£qu’û
);

438 
	`bŒfs_£t_roÙ_»f_Çme_Ën
(
Ëaf
, 
»f
, 
Çme
->
Ën
);

439 
±r
 = ()(
»f
 + 1);

440 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
Çme
->Çme, 
±r
,‚ame->
Ën
);

441 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

443 ià(
key
.
ty³
 =ğ
BTRFS_ROOT_BACKREF_KEY
) {

444 
	`bŒfs_»Ëa£_·th
(
·th
);

445 
key
.
objeùid
 = 
»f_id
;

446 
key
.
ty³
 = 
BTRFS_ROOT_REF_KEY
;

447 
key
.
off£t
 = 
roÙ_id
;

448 
agaš
;

451 
	`bŒfs_ä“_·th
(
·th
);

453 
	}
}

461 
	$bŒfs_check_ªd_š™_roÙ_™em
(
bŒfs_roÙ_™em
 *
roÙ_™em
)

463 
u64
 
šode_æags
 = 
	`bŒfs_¡ack_šode_æags
(&
roÙ_™em
->
šode
);

465 ià(!(
šode_æags
 & 
BTRFS_INODE_ROOT_ITEM_INIT
)) {

466 
šode_æags
 |ğ
BTRFS_INODE_ROOT_ITEM_INIT
;

467 
	`bŒfs_£t_¡ack_šode_æags
(&
roÙ_™em
->
šode
, 
šode_æags
);

468 
	`bŒfs_£t_roÙ_æags
(
roÙ_™em
, 0);

469 
	`bŒfs_£t_roÙ_lim™
(
roÙ_™em
, 0);

471 
	}
}

473 
	$bŒfs_upd©e_roÙ_times
(
bŒfs_Œªs_hªdË
 *
Œªs
,

474 
bŒfs_roÙ
 *
roÙ
)

476 
bŒfs_roÙ_™em
 *
™em
 = &
roÙ
->
roÙ_™em
;

477 
time¥ec64
 
ù
;

479 
	`ktime_g‘_»®_ts64
(&
ù
);

480 
	`¥š_lock
(&
roÙ
->
roÙ_™em_lock
);

481 
	`bŒfs_£t_roÙ_ù¿nsid
(
™em
, 
Œªs
->
Œªsid
);

482 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
™em
->
ùime
, 
ù
.
tv_£c
);

483 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
™em
->
ùime
, 
ù
.
tv_n£c
);

484 
	`¥š_uÆock
(&
roÙ
->
roÙ_™em_lock
);

485 
	}
}

501 
	$bŒfs_subvŞume_»£rve_m‘ad©a
(
bŒfs_roÙ
 *
roÙ
,

502 
bŒfs_block_rsv
 *
rsv
, 
™ems
,

503 
boŞ
 
u£_glob®_rsv
)

505 
u64
 
qgroup_num_by‹s
 = 0;

506 
u64
 
num_by‹s
;

507 
»t
;

508 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

509 
bŒfs_block_rsv
 *
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

511 ià(
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
)) {

513 
qgroup_num_by‹s
 = 3 * 
fs_šfo
->
nodesize
;

514 
»t
 = 
	`bŒfs_qgroup_»£rve_m‘a_´—Îoc
(
roÙ
,

515 
qgroup_num_by‹s
, 
Œue
,

516 
çl£
);

517 ià(
»t
)

518  
»t
;

521 
num_by‹s
 = 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
, 
™ems
);

522 
rsv
->
¥aû_šfo
 = 
	`bŒfs_fšd_¥aû_šfo
(
fs_šfo
,

523 
BTRFS_BLOCK_GROUP_METADATA
);

524 
»t
 = 
	`bŒfs_block_rsv_add
(
fs_šfo
, 
rsv
, 
num_by‹s
,

525 
BTRFS_RESERVE_FLUSH_ALL
);

527 ià(
»t
 =ğ-
ENOSPC
 && 
u£_glob®_rsv
)

528 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(
glob®_rsv
, 
rsv
, 
num_by‹s
, 
Œue
);

530 ià(
»t
 && 
qgroup_num_by‹s
)

531 
	`bŒfs_qgroup_ä“_m‘a_´—Îoc
(
roÙ
, 
qgroup_num_by‹s
);

533 ià(!
»t
) {

534 
	`¥š_lock
(&
rsv
->
lock
);

535 
rsv
->
qgroup_rsv_»£rved
 +ğ
qgroup_num_by‹s
;

536 
	`¥š_uÆock
(&
rsv
->
lock
);

538  
»t
;

539 
	}
}

541 
	$bŒfs_subvŞume_»Ëa£_m‘ad©a
(
bŒfs_roÙ
 *
roÙ
,

542 
bŒfs_block_rsv
 *
rsv
)

544 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

545 
u64
 
qgroup_to_»Ëa£
;

547 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rsv
, (
u64
)-1, &
qgroup_to_»Ëa£
);

548 
	`bŒfs_qgroup_cÚv”t_»£rved_m‘a
(
roÙ
, 
qgroup_to_»Ëa£
);

549 
	}
}

	@root-tree.h

3 #iâdeà
BTRFS_ROOT_TREE_H


4 
	#BTRFS_ROOT_TREE_H


	)

6 
bŒfs_subvŞume_»£rve_m‘ad©a
(
bŒfs_roÙ
 *
roÙ
,

7 
bŒfs_block_rsv
 *
rsv
,

8 
n™ems
, 
boŞ
 
u£_glob®_rsv
);

9 
bŒfs_subvŞume_»Ëa£_m‘ad©a
(
bŒfs_roÙ
 *
roÙ
,

10 
bŒfs_block_rsv
 *
rsv
);

11 
bŒfs_add_roÙ_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
roÙ_id
,

12 
u64
 
»f_id
, u64 
dœid
, u64 
£qu’û
,

13 cÚ¡ 
fsüy±_¡r
 *
Çme
);

14 
bŒfs_d–_roÙ_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
roÙ_id
,

15 
u64
 
»f_id
, u64 
dœid
, u64 *
£qu’û
,

16 cÚ¡ 
fsüy±_¡r
 *
Çme
);

17 
bŒfs_d–_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
, cÚ¡ 
bŒfs_key
 *
key
);

18 
bŒfs_š£¹_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

19 cÚ¡ 
bŒfs_key
 *
key
,

20 
bŒfs_roÙ_™em
 *
™em
);

21 
__mu¡_check
 
bŒfs_upd©e_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

22 
bŒfs_roÙ
 *
roÙ
,

23 
bŒfs_key
 *
key
,

24 
bŒfs_roÙ_™em
 *
™em
);

25 
bŒfs_fšd_roÙ
(
bŒfs_roÙ
 *
roÙ
, cÚ¡ 
bŒfs_key
 *
£¬ch_key
,

26 
bŒfs_·th
 *
·th
, 
bŒfs_roÙ_™em
 *
roÙ_™em
,

27 
bŒfs_key
 *
roÙ_key
);

28 
bŒfs_fšd_Üphª_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
);

29 
bŒfs_£t_roÙ_node
(
bŒfs_roÙ_™em
 *
™em
,

30 
ex‹Á_bufãr
 *
node
);

31 
bŒfs_check_ªd_š™_roÙ_™em
(
bŒfs_roÙ_™em
 *
™em
);

32 
bŒfs_upd©e_roÙ_times
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
);

	@scrub.c

6 
	~<lšux/blkdev.h
>

7 
	~<lšux/¿‹lim™.h
>

8 
	~<lšux/sched/mm.h
>

9 
	~<üy±o/hash.h
>

10 
	~"ù»e.h
"

11 
	~"disÿrd.h
"

12 
	~"vŞumes.h
"

13 
	~"disk-io.h
"

14 
	~"Üd”ed-d©a.h
"

15 
	~"Œª§ùiÚ.h
"

16 
	~"back»f.h
"

17 
	~"ex‹Á_io.h
"

18 
	~"dev-»¶aû.h
"

19 
	~"check-š‹gr™y.h
"

20 
	~"¿id56.h
"

21 
	~"block-group.h
"

22 
	~"zÚed.h
"

23 
	~"fs.h
"

24 
	~"acûssÜs.h
"

25 
	~"fe-™em.h
"

26 
	~"süub.h
"

41 
	gsüub_ùx
;

49 
	#SCRUB_STRIPES_PER_GROUP
 8

	)

57 
	#SCRUB_GROUPS_PER_SCTX
 16

	)

59 
	#SCRUB_TOTAL_STRIPES
 (
SCRUB_GROUPS_PER_SCTX
 * 
SCRUB_STRIPES_PER_GROUP
)

	)

65 
	#SCRUB_MAX_SECTORS_PER_BLOCK
 (
BTRFS_MAX_METADATA_BLOCKSIZE
 / 
SZ_4K
)

	)

68 
	ssüub_£ùÜ_v”ifiÿtiÚ
 {

69 
boŞ
 
	mis_m‘ad©a
;

78 
u8
 *
	mcsum
;

84 
u64
 
	mg’”©iÚ
;

88 
	esüub_¡re_æags
 {

90 
	mSCRUB_STRIPE_FLAG_INITIALIZED
,

93 
	mSCRUB_STRIPE_FLAG_REPAIR_DONE
,

100 
	mSCRUB_STRIPE_FLAG_NO_REPORT
,

103 
	#SCRUB_STRIPE_PAGES
 (
BTRFS_STRIPE_LEN
 / 
PAGE_SIZE
)

	)

108 
	ssüub_¡re
 {

109 
süub_ùx
 *
	msùx
;

110 
bŒfs_block_group
 *
	mbg
;

112 
·ge
 *
	m·ges
[
SCRUB_STRIPE_PAGES
];

113 
süub_£ùÜ_v”ifiÿtiÚ
 *
	m£ùÜs
;

115 
bŒfs_deviû
 *
	mdev
;

116 
u64
 
	mlogiÿl
;

117 
u64
 
	mphysiÿl
;

119 
u16
 
	mmœrÜ_num
;

122 
u16
 
	mÄ_£ùÜs
;

128 
u16
 
	mÄ_d©a_ex‹Ás
;

129 
u16
 
	mÄ_m‘a_ex‹Ás
;

131 
©omic_t
 
	m³ndšg_io
;

132 
wa™_queue_h—d_t
 
	mio_wa™
;

133 
wa™_queue_h—d_t
 
	m»·œ_wa™
;

139 
	m¡©e
;

142 
	mex‹Á_£ùÜ_b™m­
;

152 
	mš™_”rÜ_b™m­
;

153 
	mš™_Ä_io_”rÜs
;

154 
	mš™_Ä_csum_”rÜs
;

155 
	mš™_Ä_m‘a_”rÜs
;

165 
	m”rÜ_b™m­
;

166 
	mio_”rÜ_b™m­
;

167 
	mcsum_”rÜ_b™m­
;

168 
	mm‘a_”rÜ_b™m­
;

171 
	mwr™e_”rÜ_b™m­
;

174 
¥šlock_t
 
	mwr™e_”rÜ_lock
;

180 
u8
 *
	mcsums
;

182 
wÜk_¡ruù
 
	mwÜk
;

185 
	ssüub_ùx
 {

186 
süub_¡re
 
	m¡res
[
SCRUB_TOTAL_STRIPES
];

187 
süub_¡re
 *
	m¿id56_d©a_¡res
;

188 
bŒfs_fs_šfo
 *
	mfs_šfo
;

189 
bŒfs_·th
 
	mex‹Á_·th
;

190 
bŒfs_·th
 
	mcsum_·th
;

191 
	mfœ¡_ä“
;

192 
	mcur_¡re
;

193 
©omic_t
 
	mÿnûl_»q
;

194 
	m»adÚly
;

195 
	m£ùÜs_³r_bio
;

198 
ktime_t
 
	mthrÙe_d—dlše
;

199 
u64
 
	mthrÙe_£Á
;

201 
	mis_dev_»¶aû
;

202 
u64
 
	mwr™e_poš‹r
;

204 
mu‹x
 
	mwr_lock
;

205 
bŒfs_deviû
 *
	mwr_tgtdev
;

210 
bŒfs_süub_´og»ss
 
	m¡©
;

211 
¥šlock_t
 
	m¡©_lock
;

220 
»fcouÁ_t
 
	m»fs
;

223 
	ssüub_w¬nšg
 {

224 
bŒfs_·th
 *
	m·th
;

225 
u64
 
	mex‹Á_™em_size
;

226 cÚ¡ *
	m”r¡r
;

227 
u64
 
	mphysiÿl
;

228 
u64
 
	mlogiÿl
;

229 
bŒfs_deviû
 *
	mdev
;

232 
	$»Ëa£_süub_¡re
(
süub_¡re
 *
¡re
)

234 ià(!
¡re
)

237 
i
 = 0; i < 
SCRUB_STRIPE_PAGES
; i++) {

238 ià(
¡re
->
·ges
[
i
])

239 
	`__ä“_·ge
(
¡re
->
·ges
[
i
]);

240 
¡re
->
·ges
[
i
] = 
NULL
;

242 
	`kä“
(
¡re
->
£ùÜs
);

243 
	`kä“
(
¡re
->
csums
);

244 
¡re
->
£ùÜs
 = 
NULL
;

245 
¡re
->
csums
 = 
NULL
;

246 
¡re
->
sùx
 = 
NULL
;

247 
¡re
->
¡©e
 = 0;

248 
	}
}

250 
	$š™_süub_¡re
(
bŒfs_fs_šfo
 *
fs_šfo
,

251 
süub_¡re
 *
¡re
)

253 
»t
;

255 
	`mem£t
(
¡re
, 0, (*stripe));

257 
¡re
->
Ä_£ùÜs
 = 
BTRFS_STRIPE_LEN
 >> 
fs_šfo
->
£ùÜsize_b™s
;

258 
¡re
->
¡©e
 = 0;

260 
	`š™_wa™queue_h—d
(&
¡re
->
io_wa™
);

261 
	`š™_wa™queue_h—d
(&
¡re
->
»·œ_wa™
);

262 
	`©omic_£t
(&
¡re
->
³ndšg_io
, 0);

263 
	`¥š_lock_š™
(&
¡re
->
wr™e_”rÜ_lock
);

265 
»t
 = 
	`bŒfs_®loc_·ge_¬¿y
(
SCRUB_STRIPE_PAGES
, 
¡re
->
·ges
);

266 ià(
»t
 < 0)

267 
”rÜ
;

269 
¡re
->
£ùÜs
 = 
	`kÿÎoc
(¡re->
Ä_£ùÜs
,

270 (
süub_£ùÜ_v”ifiÿtiÚ
),

271 
GFP_KERNEL
);

272 ià(!
¡re
->
£ùÜs
)

273 
”rÜ
;

275 
¡re
->
csums
 = 
	`kÿÎoc
(
BTRFS_STRIPE_LEN
 >> 
fs_šfo
->
£ùÜsize_b™s
,

276 
fs_šfo
->
csum_size
, 
GFP_KERNEL
);

277 ià(!
¡re
->
csums
)

278 
”rÜ
;

280 
”rÜ
:

281 
	`»Ëa£_süub_¡re
(
¡re
);

282  -
ENOMEM
;

283 
	}
}

285 
	$wa™_süub_¡re_io
(
süub_¡re
 *
¡re
)

287 
	`wa™_ev’t
(
¡re
->
io_wa™
, 
	`©omic_»ad
(&¡re->
³ndšg_io
) == 0);

288 
	}
}

290 
süub_put_ùx
(
süub_ùx
 *
sùx
);

292 
	$__süub_blocked_if_Ãeded
(
bŒfs_fs_šfo
 *
fs_šfo
)

294 
	`©omic_»ad
(&
fs_šfo
->
süub_·u£_»q
)) {

295 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

296 
	`wa™_ev’t
(
fs_šfo
->
süub_·u£_wa™
,

297 
	`©omic_»ad
(&
fs_šfo
->
süub_·u£_»q
) == 0);

298 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

300 
	}
}

302 
	$süub_·u£_Ú
(
bŒfs_fs_šfo
 *
fs_šfo
)

304 
	`©omic_šc
(&
fs_šfo
->
süubs_·u£d
);

305 
	`wake_up
(&
fs_šfo
->
süub_·u£_wa™
);

306 
	}
}

308 
	$süub_·u£_off
(
bŒfs_fs_šfo
 *
fs_šfo
)

310 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

311 
	`__süub_blocked_if_Ãeded
(
fs_šfo
);

312 
	`©omic_dec
(&
fs_šfo
->
süubs_·u£d
);

313 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

315 
	`wake_up
(&
fs_šfo
->
süub_·u£_wa™
);

316 
	}
}

318 
	$süub_blocked_if_Ãeded
(
bŒfs_fs_šfo
 *
fs_šfo
)

320 
	`süub_·u£_Ú
(
fs_šfo
);

321 
	`süub_·u£_off
(
fs_šfo
);

322 
	}
}

324 
nošlše_fÜ_¡ack
 
	$süub_ä“_ùx
(
süub_ùx
 *
sùx
)

326 
i
;

328 ià(!
sùx
)

331 
i
 = 0; i < 
SCRUB_TOTAL_STRIPES
; i++)

332 
	`»Ëa£_süub_¡re
(&
sùx
->
¡res
[
i
]);

334 
	`kvä“
(
sùx
);

335 
	}
}

337 
	$süub_put_ùx
(
süub_ùx
 *
sùx
)

339 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
sùx
->
»fs
))

340 
	`süub_ä“_ùx
(
sùx
);

341 
	}
}

343 
nošlše_fÜ_¡ack
 
süub_ùx
 *
	$süub_£tup_ùx
(

344 
bŒfs_fs_šfo
 *
fs_šfo
, 
is_dev_»¶aû
)

346 
süub_ùx
 *
sùx
;

347 
i
;

352 
sùx
 = 
	`kvz®loc
((*sùx), 
GFP_KERNEL
);

353 ià(!
sùx
)

354 
nomem
;

355 
	`»fcouÁ_£t
(&
sùx
->
»fs
, 1);

356 
sùx
->
is_dev_»¶aû
 = is_dev_replace;

357 
sùx
->
fs_šfo
 = fs_info;

358 
sùx
->
ex‹Á_·th
.
£¬ch_comm™_roÙ
 = 1;

359 
sùx
->
ex‹Á_·th
.
sk_lockšg
 = 1;

360 
sùx
->
csum_·th
.
£¬ch_comm™_roÙ
 = 1;

361 
sùx
->
csum_·th
.
sk_lockšg
 = 1;

362 
i
 = 0; i < 
SCRUB_TOTAL_STRIPES
; i++) {

363 
»t
;

365 
»t
 = 
	`š™_süub_¡re
(
fs_šfo
, &
sùx
->
¡res
[
i
]);

366 ià(
»t
 < 0)

367 
nomem
;

368 
sùx
->
¡res
[
i
].sctx = sctx;

370 
sùx
->
fœ¡_ä“
 = 0;

371 
	`©omic_£t
(&
sùx
->
ÿnûl_»q
, 0);

373 
	`¥š_lock_š™
(&
sùx
->
¡©_lock
);

374 
sùx
->
thrÙe_d—dlše
 = 0;

376 
	`mu‹x_š™
(&
sùx
->
wr_lock
);

377 ià(
is_dev_»¶aû
) {

378 
	`WARN_ON
(!
fs_šfo
->
dev_»¶aû
.
tgtdev
);

379 
sùx
->
wr_tgtdev
 = 
fs_šfo
->
dev_»¶aû
.
tgtdev
;

382  
sùx
;

384 
nomem
:

385 
	`süub_ä“_ùx
(
sùx
);

386  
	`ERR_PTR
(-
ENOMEM
);

387 
	}
}

389 
	$süub_´št_w¬nšg_šode
(
u64
 
šum
, u64 
off£t
, u64 
num_by‹s
,

390 
u64
 
roÙ
, *
w¬n_ùx
)

392 
u32
 
Æšk
;

393 
»t
;

394 
i
;

395 
nofs_æag
;

396 
ex‹Á_bufãr
 *
eb
;

397 
bŒfs_šode_™em
 *
šode_™em
;

398 
süub_w¬nšg
 *
sw¬n
 = 
w¬n_ùx
;

399 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sw¬n
->
dev
->fs_info;

400 
šode_fs_·ths
 *
©h
 = 
NULL
;

401 
bŒfs_roÙ
 *
loÿl_roÙ
;

402 
bŒfs_key
 
key
;

404 
loÿl_roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
roÙ
, 
Œue
);

405 ià(
	`IS_ERR
(
loÿl_roÙ
)) {

406 
»t
 = 
	`PTR_ERR
(
loÿl_roÙ
);

407 
”r
;

413 
key
.
objeùid
 = 
šum
;

414 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

415 
key
.
off£t
 = 0;

417 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
loÿl_roÙ
, &
key
, 
sw¬n
->
·th
, 0, 0);

418 ià(
»t
) {

419 
	`bŒfs_put_roÙ
(
loÿl_roÙ
);

420 
	`bŒfs_»Ëa£_·th
(
sw¬n
->
·th
);

421 
”r
;

424 
eb
 = 
sw¬n
->
·th
->
nodes
[0];

425 
šode_™em
 = 
	`bŒfs_™em_±r
(
eb
, 
sw¬n
->
·th
->
¦Ùs
[0],

426 
bŒfs_šode_™em
);

427 
Æšk
 = 
	`bŒfs_šode_Æšk
(
eb
, 
šode_™em
);

428 
	`bŒfs_»Ëa£_·th
(
sw¬n
->
·th
);

435 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

436 
©h
 = 
	`š™_©h
(4096, 
loÿl_roÙ
, 
sw¬n
->
·th
);

437 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

438 ià(
	`IS_ERR
(
©h
)) {

439 
	`bŒfs_put_roÙ
(
loÿl_roÙ
);

440 
»t
 = 
	`PTR_ERR
(
©h
);

441 
©h
 = 
NULL
;

442 
”r
;

444 
»t
 = 
	`·ths_äom_šode
(
šum
, 
©h
);

446 ià(
»t
 < 0)

447 
”r
;

453 
i
 = 0; i < 
©h
->
f¥©h
->
–em_út
; ++i)

454 
	`bŒfs_w¬n_š_rcu
(
fs_šfo
,

456 
sw¬n
->
”r¡r
, sw¬n->
logiÿl
,

457 
	`bŒfs_dev_Çme
(
sw¬n
->
dev
),

458 
sw¬n
->
physiÿl
,

459 
roÙ
, 
šum
, 
off£t
,

460 
fs_šfo
->
£ùÜsize
, 
Æšk
,

461 (*)()
©h
->
f¥©h
->
v®
[
i
]);

463 
	`bŒfs_put_roÙ
(
loÿl_roÙ
);

464 
	`ä“_©h
(
©h
);

467 
”r
:

468 
	`bŒfs_w¬n_š_rcu
(
fs_šfo
,

470 
sw¬n
->
”r¡r
, sw¬n->
logiÿl
,

471 
	`bŒfs_dev_Çme
(
sw¬n
->
dev
),

472 
sw¬n
->
physiÿl
,

473 
roÙ
, 
šum
, 
off£t
, 
»t
);

475 
	`ä“_©h
(
©h
);

477 
	}
}

479 
	$süub_´št_commÚ_w¬nšg
(cÚ¡ *
”r¡r
, 
bŒfs_deviû
 *
dev
,

480 
boŞ
 
is_su³r
, 
u64
 
logiÿl
, u64 
physiÿl
)

482 
bŒfs_fs_šfo
 *
fs_šfo
 = 
dev
->fs_info;

483 
bŒfs_·th
 *
·th
;

484 
bŒfs_key
 
found_key
;

485 
ex‹Á_bufãr
 *
eb
;

486 
bŒfs_ex‹Á_™em
 *
ei
;

487 
süub_w¬nšg
 
sw¬n
;

488 
u64
 
æags
 = 0;

489 
u32
 
™em_size
;

490 
»t
;

493 ià(
is_su³r
) {

494 
	`bŒfs_w¬n_š_rcu
(
fs_šfo
, "%s on device %s,…hysical %llu",

495 
”r¡r
, 
	`bŒfs_dev_Çme
(
dev
), 
physiÿl
);

498 
·th
 = 
	`bŒfs_®loc_·th
();

499 ià(!
·th
)

502 
sw¬n
.
physiÿl
 =…hysical;

503 
sw¬n
.
logiÿl
 =†ogical;

504 
sw¬n
.
”r¡r
 =ƒrrstr;

505 
sw¬n
.
dev
 = 
NULL
;

507 
»t
 = 
	`ex‹Á_äom_logiÿl
(
fs_šfo
, 
sw¬n
.
logiÿl
, 
·th
, &
found_key
,

508 &
æags
);

509 ià(
»t
 < 0)

510 
out
;

512 
sw¬n
.
ex‹Á_™em_size
 = 
found_key
.
off£t
;

514 
eb
 = 
·th
->
nodes
[0];

515 
ei
 = 
	`bŒfs_™em_±r
(
eb
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

516 
™em_size
 = 
	`bŒfs_™em_size
(
eb
, 
·th
->
¦Ùs
[0]);

518 ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

519 
±r
 = 0;

520 
u8
 
»f_Ëv–
;

521 
u64
 
»f_roÙ
;

523 
Œue
) {

524 
»t
 = 
	`Œ“_back»f_fÜ_ex‹Á
(&
±r
, 
eb
, &
found_key
, 
ei
,

525 
™em_size
, &
»f_roÙ
,

526 &
»f_Ëv–
);

527 ià(
»t
 < 0) {

528 
	`bŒfs_w¬n
(
fs_šfo
,

530 
sw¬n
.
logiÿl
, 
»t
);

533 ià(
»t
 > 0)

535 
	`bŒfs_w¬n_š_rcu
(
fs_šfo
,

537 
”r¡r
, 
sw¬n
.
logiÿl
, 
	`bŒfs_dev_Çme
(
dev
),

538 
sw¬n
.
physiÿl
, (
»f_Ëv–
 ? "node" : "leaf"),

539 
»f_Ëv–
, 
»f_roÙ
);

541 
	`bŒfs_»Ëa£_·th
(
·th
);

543 
bŒfs_back»f_w®k_ùx
 
ùx
 = { 0 };

545 
	`bŒfs_»Ëa£_·th
(
·th
);

547 
ùx
.
by‹Ä
 = 
found_key
.
objeùid
;

548 
ùx
.
ex‹Á_™em_pos
 = 
sw¬n
.
logiÿl
 - 
found_key
.
objeùid
;

549 
ùx
.
fs_šfo
 = fs_info;

551 
sw¬n
.
·th
 =…ath;

552 
sw¬n
.
dev
 = dev;

554 
	`™”©e_ex‹Á_šodes
(&
ùx
, 
Œue
, 
süub_´št_w¬nšg_šode
, &
sw¬n
);

557 
out
:

558 
	`bŒfs_ä“_·th
(
·th
);

559 
	}
}

561 
	$fl_wr™”_poš‹r_g­
(
süub_ùx
 *
sùx
, 
u64
 
physiÿl
)

563 
»t
 = 0;

564 
u64
 
Ëngth
;

566 ià(!
	`bŒfs_is_zÚed
(
sùx
->
fs_šfo
))

569 ià(!
	`bŒfs_dev_is_£qu’tŸl
(
sùx
->
wr_tgtdev
, 
physiÿl
))

572 ià(
sùx
->
wr™e_poš‹r
 < 
physiÿl
) {

573 
Ëngth
 = 
physiÿl
 - 
sùx
->
wr™e_poš‹r
;

575 
»t
 = 
	`bŒfs_zÚed_issue_z”oout
(
sùx
->
wr_tgtdev
,

576 
sùx
->
wr™e_poš‹r
, 
Ëngth
);

577 ià(!
»t
)

578 
sùx
->
wr™e_poš‹r
 = 
physiÿl
;

580  
»t
;

581 
	}
}

583 
·ge
 *
	$süub_¡re_g‘_·ge
(
süub_¡re
 *
¡re
, 
£ùÜ_Ä
)

585 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡re
->
bg
->fs_info;

586 
·ge_šdex
 = (
£ùÜ_Ä
 << 
fs_šfo
->
£ùÜsize_b™s
è>> 
PAGE_SHIFT
;

588  
¡re
->
·ges
[
·ge_šdex
];

589 
	}
}

591 
	$süub_¡re_g‘_·ge_off£t
(
süub_¡re
 *
¡re
,

592 
£ùÜ_Ä
)

594 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡re
->
bg
->fs_info;

596  
	`off£t_š_·ge
(
£ùÜ_Ä
 << 
fs_šfo
->
£ùÜsize_b™s
);

597 
	}
}

599 
	$süub_v”ify_Úe_m‘ad©a
(
süub_¡re
 *
¡re
, 
£ùÜ_Ä
)

601 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡re
->
bg
->fs_info;

602 cÚ¡ 
u32
 
£ùÜs_³r_Œ“
 = 
fs_šfo
->
nodesize
 >> fs_šfo->
£ùÜsize_b™s
;

603 cÚ¡ 
u64
 
logiÿl
 = 
¡re
->logiÿÈ+ (
£ùÜ_Ä
 << 
fs_šfo
->
£ùÜsize_b™s
);

604 cÚ¡ 
·ge
 *
fœ¡_·ge
 = 
	`süub_¡re_g‘_·ge
(
¡re
, 
£ùÜ_Ä
);

605 cÚ¡ 
fœ¡_off
 = 
	`süub_¡re_g‘_·ge_off£t
(
¡re
, 
£ùÜ_Ä
);

606 
	`SHASH_DESC_ON_STACK
(
shash
, 
fs_šfo
->
csum_shash
);

607 
u8
 
Ú_disk_csum
[
BTRFS_CSUM_SIZE
];

608 
u8
 
ÿlcuÏ‹d_csum
[
BTRFS_CSUM_SIZE
];

609 
bŒfs_h—d”
 *
h—d”
;

616 
h—d”
 = (
bŒfs_h—d”
 *)(
	`·ge_add»ss
(
fœ¡_·ge
è+ 
fœ¡_off
);

617 
	`memıy
(
Ú_disk_csum
, 
h—d”
->
csum
, 
fs_šfo
->
csum_size
);

619 ià(
logiÿl
 !ğ
	`bŒfs_¡ack_h—d”_by‹Ä
(
h—d”
)) {

620 
	`b™m­_£t
(&
¡re
->
csum_”rÜ_b™m­
, 
£ùÜ_Ä
, 
£ùÜs_³r_Œ“
);

621 
	`b™m­_£t
(&
¡re
->
”rÜ_b™m­
, 
£ùÜ_Ä
, 
£ùÜs_³r_Œ“
);

622 
	`bŒfs_w¬n_¾
(
fs_šfo
,

624 
logiÿl
, 
¡re
->
mœrÜ_num
,

625 
	`bŒfs_¡ack_h—d”_by‹Ä
(
h—d”
), 
logiÿl
);

628 ià(
	`memcmp
(
h—d”
->
fsid
, 
fs_šfo
->
fs_deviûs
->
m‘ad©a_uuid
,

629 
BTRFS_FSID_SIZE
) != 0) {

630 
	`b™m­_£t
(&
¡re
->
m‘a_”rÜ_b™m­
, 
£ùÜ_Ä
, 
£ùÜs_³r_Œ“
);

631 
	`b™m­_£t
(&
¡re
->
”rÜ_b™m­
, 
£ùÜ_Ä
, 
£ùÜs_³r_Œ“
);

632 
	`bŒfs_w¬n_¾
(
fs_šfo
,

634 
logiÿl
, 
¡re
->
mœrÜ_num
,

635 
h—d”
->
fsid
, 
fs_šfo
->
fs_deviûs
->fsid);

638 ià(
	`memcmp
(
h—d”
->
chunk_Œ“_uuid
, 
fs_šfo
->chunk_tree_uuid,

639 
BTRFS_UUID_SIZE
) != 0) {

640 
	`b™m­_£t
(&
¡re
->
m‘a_”rÜ_b™m­
, 
£ùÜ_Ä
, 
£ùÜs_³r_Œ“
);

641 
	`b™m­_£t
(&
¡re
->
”rÜ_b™m­
, 
£ùÜ_Ä
, 
£ùÜs_³r_Œ“
);

642 
	`bŒfs_w¬n_¾
(
fs_šfo
,

644 
logiÿl
, 
¡re
->
mœrÜ_num
,

645 
h—d”
->
chunk_Œ“_uuid
, 
fs_šfo
->chunk_tree_uuid);

650 
shash
->
tfm
 = 
fs_šfo
->
csum_shash
;

651 
	`üy±o_shash_š™
(
shash
);

652 
	`üy±o_shash_upd©e
(
shash
, 
	`·ge_add»ss
(
fœ¡_·ge
è+ 
fœ¡_off
 +

653 
BTRFS_CSUM_SIZE
, 
fs_šfo
->
£ùÜsize
 - BTRFS_CSUM_SIZE);

655 
i
 = 
£ùÜ_Ä
 + 1; i < seùÜ_Ä + 
£ùÜs_³r_Œ“
; i++) {

656 
·ge
 *·gğ
	`süub_¡re_g‘_·ge
(
¡re
, 
i
);

657 
·ge_off
 = 
	`süub_¡re_g‘_·ge_off£t
(
¡re
, 
i
);

659 
	`üy±o_shash_upd©e
(
shash
, 
	`·ge_add»ss
(
·ge
è+ 
·ge_off
,

660 
fs_šfo
->
£ùÜsize
);

663 
	`üy±o_shash_fš®
(
shash
, 
ÿlcuÏ‹d_csum
);

664 ià(
	`memcmp
(
ÿlcuÏ‹d_csum
, 
Ú_disk_csum
, 
fs_šfo
->
csum_size
) != 0) {

665 
	`b™m­_£t
(&
¡re
->
m‘a_”rÜ_b™m­
, 
£ùÜ_Ä
, 
£ùÜs_³r_Œ“
);

666 
	`b™m­_£t
(&
¡re
->
”rÜ_b™m­
, 
£ùÜ_Ä
, 
£ùÜs_³r_Œ“
);

667 
	`bŒfs_w¬n_¾
(
fs_šfo
,

668 "Œ“ block %Îu mœrÜ %u ha bad csum, ha " 
CSUM_FMT
 " want " CSUM_FMT,

669 
logiÿl
, 
¡re
->
mœrÜ_num
,

670 
	`CSUM_FMT_VALUE
(
fs_šfo
->
csum_size
, 
Ú_disk_csum
),

671 
	`CSUM_FMT_VALUE
(
fs_šfo
->
csum_size
, 
ÿlcuÏ‹d_csum
));

674 ià(
¡re
->
£ùÜs
[
£ùÜ_Ä
].
g’”©iÚ
 !=

675 
	`bŒfs_¡ack_h—d”_g’”©iÚ
(
h—d”
)) {

676 
	`b™m­_£t
(&
¡re
->
m‘a_”rÜ_b™m­
, 
£ùÜ_Ä
, 
£ùÜs_³r_Œ“
);

677 
	`b™m­_£t
(&
¡re
->
”rÜ_b™m­
, 
£ùÜ_Ä
, 
£ùÜs_³r_Œ“
);

678 
	`bŒfs_w¬n_¾
(
fs_šfo
,

680 
logiÿl
, 
¡re
->
mœrÜ_num
,

681 
	`bŒfs_¡ack_h—d”_g’”©iÚ
(
h—d”
),

682 
¡re
->
£ùÜs
[
£ùÜ_Ä
].
g’”©iÚ
);

685 
	`b™m­_ş—r
(&
¡re
->
”rÜ_b™m­
, 
£ùÜ_Ä
, 
£ùÜs_³r_Œ“
);

686 
	`b™m­_ş—r
(&
¡re
->
csum_”rÜ_b™m­
, 
£ùÜ_Ä
, 
£ùÜs_³r_Œ“
);

687 
	`b™m­_ş—r
(&
¡re
->
m‘a_”rÜ_b™m­
, 
£ùÜ_Ä
, 
£ùÜs_³r_Œ“
);

688 
	}
}

690 
	$süub_v”ify_Úe_£ùÜ
(
süub_¡re
 *
¡re
, 
£ùÜ_Ä
)

692 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡re
->
bg
->fs_info;

693 
süub_£ùÜ_v”ifiÿtiÚ
 *
£ùÜ
 = &
¡re
->
£ùÜs
[
£ùÜ_Ä
];

694 cÚ¡ 
u32
 
£ùÜs_³r_Œ“
 = 
fs_šfo
->
nodesize
 >> fs_šfo->
£ùÜsize_b™s
;

695 
·ge
 *·gğ
	`süub_¡re_g‘_·ge
(
¡re
, 
£ùÜ_Ä
);

696 
pgoff
 = 
	`süub_¡re_g‘_·ge_off£t
(
¡re
, 
£ùÜ_Ä
);

697 
u8
 
csum_buf
[
BTRFS_CSUM_SIZE
];

698 
»t
;

700 
	`ASSERT
(
£ùÜ_Ä
 >ğ0 && seùÜ_Ä < 
¡re
->
Ä_£ùÜs
);

703 ià(!
	`‹¡_b™
(
£ùÜ_Ä
, &
¡re
->
ex‹Á_£ùÜ_b™m­
))

707 ià(
	`‹¡_b™
(
£ùÜ_Ä
, &
¡re
->
io_”rÜ_b™m­
))

711 ià(
£ùÜ
->
is_m‘ad©a
) {

720 ià(
	`uÆik–y
(
£ùÜ_Ä
 + 
£ùÜs_³r_Œ“
 > 
¡re
->
Ä_£ùÜs
)) {

721 
	`bŒfs_w¬n_¾
(
fs_šfo
,

723 
¡re
->
logiÿl
 +

724 (
£ùÜ_Ä
 << 
fs_šfo
->
£ùÜsize_b™s
),

725 
¡re
->
logiÿl
);

728 
	`süub_v”ify_Úe_m‘ad©a
(
¡re
, 
£ùÜ_Ä
);

736 ià(!
£ùÜ
->
csum
) {

737 
	`ş—r_b™
(
£ùÜ_Ä
, &
¡re
->
”rÜ_b™m­
);

741 
»t
 = 
	`bŒfs_check_£ùÜ_csum
(
fs_šfo
, 
·ge
, 
pgoff
, 
csum_buf
, 
£ùÜ
->
csum
);

742 ià(
»t
 < 0) {

743 
	`£t_b™
(
£ùÜ_Ä
, &
¡re
->
csum_”rÜ_b™m­
);

744 
	`£t_b™
(
£ùÜ_Ä
, &
¡re
->
”rÜ_b™m­
);

746 
	`ş—r_b™
(
£ùÜ_Ä
, &
¡re
->
csum_”rÜ_b™m­
);

747 
	`ş—r_b™
(
£ùÜ_Ä
, &
¡re
->
”rÜ_b™m­
);

749 
	}
}

752 
	$süub_v”ify_Úe_¡re
(
süub_¡re
 *
¡re
, 
b™m­
)

754 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡re
->
bg
->fs_info;

755 cÚ¡ 
u32
 
£ùÜs_³r_Œ“
 = 
fs_šfo
->
nodesize
 >> fs_šfo->
£ùÜsize_b™s
;

756 
£ùÜ_Ä
;

758 
	`fÜ_—ch_£t_b™
(
£ùÜ_Ä
, &
b™m­
, 
¡re
->
Ä_£ùÜs
) {

759 
	`süub_v”ify_Úe_£ùÜ
(
¡re
, 
£ùÜ_Ä
);

760 ià(
¡re
->
£ùÜs
[
£ùÜ_Ä
].
is_m‘ad©a
)

761 
£ùÜ_Ä
 +ğ
£ùÜs_³r_Œ“
 - 1;

763 
	}
}

765 
	$ÿlc_£ùÜ_numb”
(
süub_¡re
 *
¡re
, 
bio_vec
 *
fœ¡_bvec
)

767 
i
;

769 
i
 = 0; i < 
¡re
->
Ä_£ùÜs
; i++) {

770 ià(
	`süub_¡re_g‘_·ge
(
¡re
, 
i
è=ğ
fœ¡_bvec
->
bv_·ge
 &&

771 
	`süub_¡re_g‘_·ge_off£t
(
¡re
, 
i
è=ğ
fœ¡_bvec
->
bv_off£t
)

774 
	`ASSERT
(
i
 < 
¡re
->
Ä_£ùÜs
);

775  
i
;

776 
	}
}

784 
	$süub_»·œ_»ad_’dio
(
bŒfs_bio
 *
bbio
)

786 
süub_¡re
 *
¡re
 = 
bbio
->
´iv©e
;

787 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡re
->
bg
->fs_info;

788 
bio_vec
 *
bvec
;

789 
£ùÜ_Ä
 = 
	`ÿlc_£ùÜ_numb”
(
¡re
, 
	`bio_fœ¡_bvec_®l
(&
bbio
->
bio
));

790 
u32
 
bio_size
 = 0;

791 
i
;

793 
	`ASSERT
(
£ùÜ_Ä
 < 
¡re
->
Ä_£ùÜs
);

795 
	`bio_fÜ_—ch_bvec_®l
(
bvec
, &
bbio
->
bio
, 
i
)

796 
bio_size
 +ğ
bvec
->
bv_Ën
;

798 ià(
bbio
->
bio
.
bi_¡©us
) {

799 
	`b™m­_£t
(&
¡re
->
io_”rÜ_b™m­
, 
£ùÜ_Ä
,

800 
bio_size
 >> 
fs_šfo
->
£ùÜsize_b™s
);

801 
	`b™m­_£t
(&
¡re
->
”rÜ_b™m­
, 
£ùÜ_Ä
,

802 
bio_size
 >> 
fs_šfo
->
£ùÜsize_b™s
);

804 
	`b™m­_ş—r
(&
¡re
->
io_”rÜ_b™m­
, 
£ùÜ_Ä
,

805 
bio_size
 >> 
fs_šfo
->
£ùÜsize_b™s
);

807 
	`bio_put
(&
bbio
->
bio
);

808 ià(
	`©omic_dec_ªd_‹¡
(&
¡re
->
³ndšg_io
))

809 
	`wake_up
(&
¡re
->
io_wa™
);

810 
	}
}

812 
	$ÿlc_Ãxt_mœrÜ
(
mœrÜ
, 
num_cİ›s
)

814 
	`ASSERT
(
mœrÜ
 <ğ
num_cİ›s
);

815  (
mœrÜ
 + 1 > 
num_cİ›s
) ? 1 : mirror + 1;

816 
	}
}

818 
	$süub_¡re_subm™_»·œ_»ad
(
süub_¡re
 *
¡re
,

819 
mœrÜ
, 
blocksize
, 
boŞ
 
wa™
)

821 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡re
->
bg
->fs_info;

822 
bŒfs_bio
 *
bbio
 = 
NULL
;

823 cÚ¡ 
Şd_”rÜ_b™m­
 = 
¡re
->
”rÜ_b™m­
;

824 
i
;

826 
	`ASSERT
(
¡re
->
mœrÜ_num
 >= 1);

827 
	`ASSERT
(
	`©omic_»ad
(&
¡re
->
³ndšg_io
) == 0);

829 
	`fÜ_—ch_£t_b™
(
i
, &
Şd_”rÜ_b™m­
, 
¡re
->
Ä_£ùÜs
) {

830 
·ge
 *page;

831 
pgoff
;

832 
»t
;

834 
·ge
 = 
	`süub_¡re_g‘_·ge
(
¡re
, 
i
);

835 
pgoff
 = 
	`süub_¡re_g‘_·ge_off£t
(
¡re
, 
i
);

838 ià(
bbio
 && ((
i
 > 0 && !
	`‹¡_b™
(˜- 1, &
¡re
->
”rÜ_b™m­
)) ||

839 
bbio
->
bio
.
bi_™”
.
bi_size
 >ğ
blocksize
)) {

840 
	`ASSERT
(
bbio
->
bio
.
bi_™”
.
bi_size
);

841 
	`©omic_šc
(&
¡re
->
³ndšg_io
);

842 
	`bŒfs_subm™_bio
(
bbio
, 
mœrÜ
);

843 ià(
wa™
)

844 
	`wa™_süub_¡re_io
(
¡re
);

845 
bbio
 = 
NULL
;

848 ià(!
bbio
) {

849 
bbio
 = 
	`bŒfs_bio_®loc
(
¡re
->
Ä_£ùÜs
, 
REQ_OP_READ
,

850 
fs_šfo
, 
süub_»·œ_»ad_’dio
, 
¡re
);

851 
bbio
->
bio
.
bi_™”
.
bi_£ùÜ
 = (
¡re
->
logiÿl
 +

852 (
i
 << 
fs_šfo
->
£ùÜsize_b™s
)è>> 
SECTOR_SHIFT
;

855 
»t
 = 
	`bio_add_·ge
(&
bbio
->
bio
, 
·ge
, 
fs_šfo
->
£ùÜsize
, 
pgoff
);

856 
	`ASSERT
(
»t
 =ğ
fs_šfo
->
£ùÜsize
);

858 ià(
bbio
) {

859 
	`ASSERT
(
bbio
->
bio
.
bi_™”
.
bi_size
);

860 
	`©omic_šc
(&
¡re
->
³ndšg_io
);

861 
	`bŒfs_subm™_bio
(
bbio
, 
mœrÜ
);

862 ià(
wa™
)

863 
	`wa™_süub_¡re_io
(
¡re
);

865 
	}
}

867 
	$süub_¡re_»pÜt_”rÜs
(
süub_ùx
 *
sùx
,

868 
süub_¡re
 *
¡re
)

870 
	`DEFINE_RATELIMIT_STATE
(
rs
, 
DEFAULT_RATELIMIT_INTERVAL
,

871 
DEFAULT_RATELIMIT_BURST
);

872 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

873 
bŒfs_deviû
 *
dev
 = 
NULL
;

874 
u64
 
physiÿl
 = 0;

875 
Ä_d©a_£ùÜs
 = 0;

876 
Ä_m‘a_£ùÜs
 = 0;

877 
Ä_nod©acsum_£ùÜs
 = 0;

878 
Ä_»·œed_£ùÜs
 = 0;

879 
£ùÜ_Ä
;

881 ià(
	`‹¡_b™
(
SCRUB_STRIPE_FLAG_NO_REPORT
, &
¡re
->
¡©e
))

890 ià(!
	`b™m­_em±y
(&
¡re
->
š™_”rÜ_b™m­
, sŒe->
Ä_£ùÜs
)) {

891 
u64
 
m­³d_Ën
 = 
fs_šfo
->
£ùÜsize
;

892 
bŒfs_io_cÚ‹xt
 *
bioc
 = 
NULL
;

893 
¡re_šdex
 = 
¡re
->
mœrÜ_num
 - 1;

894 
»t
;

897 
	`ASSERT
(
¡re
->
mœrÜ_num
 >= 1);

898 
»t
 = 
	`bŒfs_m­_block
(
fs_šfo
, 
BTRFS_MAP_GET_READ_MIRRORS
,

899 
¡re
->
logiÿl
, &
m­³d_Ën
, &
bioc
,

900 
NULL
, NULL, 1);

905 ià(
»t
 < 0)

906 
sk
;

907 
physiÿl
 = 
bioc
->
¡res
[
¡re_šdex
].physical;

908 
dev
 = 
bioc
->
¡res
[
¡re_šdex
].dev;

909 
	`bŒfs_put_bioc
(
bioc
);

912 
sk
:

913 
	`fÜ_—ch_£t_b™
(
£ùÜ_Ä
, &
¡re
->
ex‹Á_£ùÜ_b™m­
, sŒe->
Ä_£ùÜs
) {

914 
boŞ
 
»·œed
 = 
çl£
;

916 ià(
¡re
->
£ùÜs
[
£ùÜ_Ä
].
is_m‘ad©a
) {

917 
Ä_m‘a_£ùÜs
++;

919 
Ä_d©a_£ùÜs
++;

920 ià(!
¡re
->
£ùÜs
[
£ùÜ_Ä
].
csum
)

921 
Ä_nod©acsum_£ùÜs
++;

924 ià(
	`‹¡_b™
(
£ùÜ_Ä
, &
¡re
->
š™_”rÜ_b™m­
) &&

925 !
	`‹¡_b™
(
£ùÜ_Ä
, &
¡re
->
”rÜ_b™m­
)) {

926 
Ä_»·œed_£ùÜs
++;

927 
»·œed
 = 
Œue
;

931 ià(!
	`‹¡_b™
(
£ùÜ_Ä
, &
¡re
->
š™_”rÜ_b™m­
))

938 ià(
»·œed
) {

939 ià(
dev
) {

940 
	`bŒfs_”r_¾_š_rcu
(
fs_šfo
,

942 
¡re
->
logiÿl
, 
	`bŒfs_dev_Çme
(
dev
),

943 
physiÿl
);

945 
	`bŒfs_”r_¾_š_rcu
(
fs_šfo
,

947 
¡re
->
logiÿl
, sŒe->
mœrÜ_num
);

953 ià(
dev
) {

954 
	`bŒfs_”r_¾_š_rcu
(
fs_šfo
,

956 
¡re
->
logiÿl
, 
	`bŒfs_dev_Çme
(
dev
),

957 
physiÿl
);

959 
	`bŒfs_”r_¾_š_rcu
(
fs_šfo
,

961 
¡re
->
logiÿl
, sŒe->
mœrÜ_num
);

964 ià(
	`‹¡_b™
(
£ùÜ_Ä
, &
¡re
->
io_”rÜ_b™m­
))

965 ià(
	`__¿‹lim™
(&
rs
è&& 
dev
)

966 
	`süub_´št_commÚ_w¬nšg
("i/Ø”rÜ", 
dev
, 
çl£
,

967 
¡re
->
logiÿl
, 
physiÿl
);

968 ià(
	`‹¡_b™
(
£ùÜ_Ä
, &
¡re
->
csum_”rÜ_b™m­
))

969 ià(
	`__¿‹lim™
(&
rs
è&& 
dev
)

970 
	`süub_´št_commÚ_w¬nšg
("checksumƒ¼Ü", 
dev
, 
çl£
,

971 
¡re
->
logiÿl
, 
physiÿl
);

972 ià(
	`‹¡_b™
(
£ùÜ_Ä
, &
¡re
->
m‘a_”rÜ_b™m­
))

973 ià(
	`__¿‹lim™
(&
rs
è&& 
dev
)

974 
	`süub_´št_commÚ_w¬nšg
("h—d”ƒ¼Ü", 
dev
, 
çl£
,

975 
¡re
->
logiÿl
, 
physiÿl
);

978 
	`¥š_lock
(&
sùx
->
¡©_lock
);

979 
sùx
->
¡©
.
d©a_ex‹Ás_süubbed
 +ğ
¡re
->
Ä_d©a_ex‹Ás
;

980 
sùx
->
¡©
.
Œ“_ex‹Ás_süubbed
 +ğ
¡re
->
Ä_m‘a_ex‹Ás
;

981 
sùx
->
¡©
.
d©a_by‹s_süubbed
 +ğ
Ä_d©a_£ùÜs
 << 
fs_šfo
->
£ùÜsize_b™s
;

982 
sùx
->
¡©
.
Œ“_by‹s_süubbed
 +ğ
Ä_m‘a_£ùÜs
 << 
fs_šfo
->
£ùÜsize_b™s
;

983 
sùx
->
¡©
.
no_csum
 +ğ
Ä_nod©acsum_£ùÜs
;

984 
sùx
->
¡©
.
»ad_”rÜs
 +ğ
¡re
->
š™_Ä_io_”rÜs
;

985 
sùx
->
¡©
.
csum_”rÜs
 +ğ
¡re
->
š™_Ä_csum_”rÜs
;

986 
sùx
->
¡©
.
v”ify_”rÜs
 +ğ
¡re
->
š™_Ä_m‘a_”rÜs
;

987 
sùx
->
¡©
.
uncÜ»ùabË_”rÜs
 +=

988 
	`b™m­_weight
(&
¡re
->
”rÜ_b™m­
, sŒe->
Ä_£ùÜs
);

989 
sùx
->
¡©
.
cÜ»ùed_”rÜs
 +ğ
Ä_»·œed_£ùÜs
;

990 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

991 
	}
}

993 
süub_wr™e_£ùÜs
(
süub_ùx
 *
sùx
, 
süub_¡re
 *
¡re
,

994 
wr™e_b™m­
, 
boŞ
 
dev_»¶aû
);

1009 
	$süub_¡re_»ad_»·œ_wÜk”
(
wÜk_¡ruù
 *
wÜk
)

1011 
süub_¡re
 *
¡re
 = 
	`cÚš”_of
(
wÜk
, scrub_stripe, work);

1012 
süub_ùx
 *
sùx
 = 
¡re
->sctx;

1013 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

1014 
num_cİ›s
 = 
	`bŒfs_num_cİ›s
(
fs_šfo
, 
¡re
->
bg
->
¡¬t
,

1015 
¡re
->
bg
->
Ëngth
);

1016 
mœrÜ
;

1017 
i
;

1019 
	`ASSERT
(
¡re
->
mœrÜ_num
 > 0);

1021 
	`wa™_süub_¡re_io
(
¡re
);

1022 
	`süub_v”ify_Úe_¡re
(
¡re
, sŒe->
ex‹Á_£ùÜ_b™m­
);

1024 
¡re
->
š™_”rÜ_b™m­
 = sŒe->
”rÜ_b™m­
;

1025 
¡re
->
š™_Ä_io_”rÜs
 = 
	`b™m­_weight
(&¡re->
io_”rÜ_b™m­
,

1026 
¡re
->
Ä_£ùÜs
);

1027 
¡re
->
š™_Ä_csum_”rÜs
 = 
	`b™m­_weight
(&¡re->
csum_”rÜ_b™m­
,

1028 
¡re
->
Ä_£ùÜs
);

1029 
¡re
->
š™_Ä_m‘a_”rÜs
 = 
	`b™m­_weight
(&¡re->
m‘a_”rÜ_b™m­
,

1030 
¡re
->
Ä_£ùÜs
);

1032 ià(
	`b™m­_em±y
(&
¡re
->
š™_”rÜ_b™m­
, sŒe->
Ä_£ùÜs
))

1033 
out
;

1041 
mœrÜ
 = 
	`ÿlc_Ãxt_mœrÜ
(
¡re
->
mœrÜ_num
, 
num_cİ›s
);

1042 
mœrÜ
 !ğ
¡re
->
mœrÜ_num
;

1043 
mœrÜ
 = 
	`ÿlc_Ãxt_mœrÜ
(mœrÜ, 
num_cİ›s
)) {

1044 cÚ¡ 
Şd_”rÜ_b™m­
 = 
¡re
->
”rÜ_b™m­
;

1046 
	`süub_¡re_subm™_»·œ_»ad
(
¡re
, 
mœrÜ
,

1047 
BTRFS_STRIPE_LEN
, 
çl£
);

1048 
	`wa™_süub_¡re_io
(
¡re
);

1049 
	`süub_v”ify_Úe_¡re
(
¡re
, 
Şd_”rÜ_b™m­
);

1050 ià(
	`b™m­_em±y
(&
¡re
->
”rÜ_b™m­
, sŒe->
Ä_£ùÜs
))

1051 
out
;

1065 
i
 = 0, 
mœrÜ
 = 
¡re
->
mœrÜ_num
;

1066 
i
 < 
num_cİ›s
;

1067 
i
++, 
mœrÜ
 = 
	`ÿlc_Ãxt_mœrÜ
(mœrÜ, 
num_cİ›s
)) {

1068 cÚ¡ 
Şd_”rÜ_b™m­
 = 
¡re
->
”rÜ_b™m­
;

1070 
	`süub_¡re_subm™_»·œ_»ad
(
¡re
, 
mœrÜ
,

1071 
fs_šfo
->
£ùÜsize
, 
Œue
);

1072 
	`wa™_süub_¡re_io
(
¡re
);

1073 
	`süub_v”ify_Úe_¡re
(
¡re
, 
Şd_”rÜ_b™m­
);

1074 ià(
	`b™m­_em±y
(&
¡re
->
”rÜ_b™m­
, sŒe->
Ä_£ùÜs
))

1075 
out
;

1077 
out
:

1082 ià(
	`bŒfs_is_zÚed
(
fs_šfo
)) {

1083 ià(!
	`b™m­_em±y
(&
¡re
->
”rÜ_b™m­
, sŒe->
Ä_£ùÜs
))

1084 
	`bŒfs_»·œ_Úe_zÚe
(
fs_šfo
, 
sùx
->
¡res
[0].
bg
->
¡¬t
);

1085 } ià(!
sùx
->
»adÚly
) {

1086 
»·œed
;

1088 
	`b™m­_ªdnÙ
(&
»·œed
, &
¡re
->
š™_”rÜ_b™m­
,

1089 &
¡re
->
”rÜ_b™m­
, sŒe->
Ä_£ùÜs
);

1090 
	`süub_wr™e_£ùÜs
(
sùx
, 
¡re
, 
»·œed
, 
çl£
);

1091 
	`wa™_süub_¡re_io
(
¡re
);

1094 
	`süub_¡re_»pÜt_”rÜs
(
sùx
, 
¡re
);

1095 
	`£t_b™
(
SCRUB_STRIPE_FLAG_REPAIR_DONE
, &
¡re
->
¡©e
);

1096 
	`wake_up
(&
¡re
->
»·œ_wa™
);

1097 
	}
}

1099 
	$süub_»ad_’dio
(
bŒfs_bio
 *
bbio
)

1101 
süub_¡re
 *
¡re
 = 
bbio
->
´iv©e
;

1103 ià(
bbio
->
bio
.
bi_¡©us
) {

1104 
	`b™m­_£t
(&
¡re
->
io_”rÜ_b™m­
, 0, sŒe->
Ä_£ùÜs
);

1105 
	`b™m­_£t
(&
¡re
->
”rÜ_b™m­
, 0, sŒe->
Ä_£ùÜs
);

1107 
	`b™m­_ş—r
(&
¡re
->
io_”rÜ_b™m­
, 0, sŒe->
Ä_£ùÜs
);

1109 
	`bio_put
(&
bbio
->
bio
);

1110 ià(
	`©omic_dec_ªd_‹¡
(&
¡re
->
³ndšg_io
)) {

1111 
	`wake_up
(&
¡re
->
io_wa™
);

1112 
	`INIT_WORK
(&
¡re
->
wÜk
, 
süub_¡re_»ad_»·œ_wÜk”
);

1113 
	`queue_wÜk
(
¡re
->
bg
->
fs_šfo
->
süub_wÜk”s
, &¡re->
wÜk
);

1115 
	}
}

1117 
	$süub_wr™e_’dio
(
bŒfs_bio
 *
bbio
)

1119 
süub_¡re
 *
¡re
 = 
bbio
->
´iv©e
;

1120 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡re
->
bg
->fs_info;

1121 
bio_vec
 *
bvec
;

1122 
£ùÜ_Ä
 = 
	`ÿlc_£ùÜ_numb”
(
¡re
, 
	`bio_fœ¡_bvec_®l
(&
bbio
->
bio
));

1123 
u32
 
bio_size
 = 0;

1124 
i
;

1126 
	`bio_fÜ_—ch_bvec_®l
(
bvec
, &
bbio
->
bio
, 
i
)

1127 
bio_size
 +ğ
bvec
->
bv_Ën
;

1129 ià(
bbio
->
bio
.
bi_¡©us
) {

1130 
æags
;

1132 
	`¥š_lock_œq§ve
(&
¡re
->
wr™e_”rÜ_lock
, 
æags
);

1133 
	`b™m­_£t
(&
¡re
->
wr™e_”rÜ_b™m­
, 
£ùÜ_Ä
,

1134 
bio_size
 >> 
fs_šfo
->
£ùÜsize_b™s
);

1135 
	`¥š_uÆock_œq»¡Üe
(&
¡re
->
wr™e_”rÜ_lock
, 
æags
);

1137 
	`bio_put
(&
bbio
->
bio
);

1139 ià(
	`©omic_dec_ªd_‹¡
(&
¡re
->
³ndšg_io
))

1140 
	`wake_up
(&
¡re
->
io_wa™
);

1141 
	}
}

1143 
	$süub_subm™_wr™e_bio
(
süub_ùx
 *
sùx
,

1144 
süub_¡re
 *
¡re
,

1145 
bŒfs_bio
 *
bbio
, 
boŞ
 
dev_»¶aû
)

1147 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

1148 
u32
 
bio_Ën
 = 
bbio
->
bio
.
bi_™”
.
bi_size
;

1149 
u32
 
bio_off
 = (
bbio
->
bio
.
bi_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
) -

1150 
¡re
->
logiÿl
;

1152 
	`fl_wr™”_poš‹r_g­
(
sùx
, 
¡re
->
physiÿl
 + 
bio_off
);

1153 
	`©omic_šc
(&
¡re
->
³ndšg_io
);

1154 
	`bŒfs_subm™_»·œ_wr™e
(
bbio
, 
¡re
->
mœrÜ_num
, 
dev_»¶aû
);

1155 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

1161 
	`wa™_süub_¡re_io
(
¡re
);

1167 ià(!
	`‹¡_b™
(
bio_off
 >> 
fs_šfo
->
£ùÜsize_b™s
,

1168 &
¡re
->
wr™e_”rÜ_b™m­
))

1169 
sùx
->
wr™e_poš‹r
 +ğ
bio_Ën
;

1170 
	}
}

1185 
	$süub_wr™e_£ùÜs
(
süub_ùx
 *
sùx
, 
süub_¡re
 *
¡re
,

1186 
wr™e_b™m­
, 
boŞ
 
dev_»¶aû
)

1188 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡re
->
bg
->fs_info;

1189 
bŒfs_bio
 *
bbio
 = 
NULL
;

1190 
£ùÜ_Ä
;

1192 
	`fÜ_—ch_£t_b™
(
£ùÜ_Ä
, &
wr™e_b™m­
, 
¡re
->
Ä_£ùÜs
) {

1193 
·ge
 *·gğ
	`süub_¡re_g‘_·ge
(
¡re
, 
£ùÜ_Ä
);

1194 
pgoff
 = 
	`süub_¡re_g‘_·ge_off£t
(
¡re
, 
£ùÜ_Ä
);

1195 
»t
;

1198 
	`ASSERT
(
	`‹¡_b™
(
£ùÜ_Ä
, &
¡re
->
ex‹Á_£ùÜ_b™m­
));

1201 ià(
bbio
 && 
£ùÜ_Ä
 && !
	`‹¡_b™
(£ùÜ_Ä - 1, &
wr™e_b™m­
)) {

1202 
	`süub_subm™_wr™e_bio
(
sùx
, 
¡re
, 
bbio
, 
dev_»¶aû
);

1203 
bbio
 = 
NULL
;

1205 ià(!
bbio
) {

1206 
bbio
 = 
	`bŒfs_bio_®loc
(
¡re
->
Ä_£ùÜs
, 
REQ_OP_WRITE
,

1207 
fs_šfo
, 
süub_wr™e_’dio
, 
¡re
);

1208 
bbio
->
bio
.
bi_™”
.
bi_£ùÜ
 = (
¡re
->
logiÿl
 +

1209 (
£ùÜ_Ä
 << 
fs_šfo
->
£ùÜsize_b™s
)) >>

1210 
SECTOR_SHIFT
;

1212 
»t
 = 
	`bio_add_·ge
(&
bbio
->
bio
, 
·ge
, 
fs_šfo
->
£ùÜsize
, 
pgoff
);

1213 
	`ASSERT
(
»t
 =ğ
fs_šfo
->
£ùÜsize
);

1215 ià(
bbio
)

1216 
	`süub_subm™_wr™e_bio
(
sùx
, 
¡re
, 
bbio
, 
dev_»¶aû
);

1217 
	}
}

1223 
	$süub_thrÙe_dev_io
(
süub_ùx
 *
sùx
, 
bŒfs_deviû
 *
deviû
,

1224 
bio_size
)

1226 cÚ¡ 
time_¦iû
 = 1000;

1227 
s64
 
d–
;

1228 
ktime_t
 
now
;

1229 
u32
 
div
;

1230 
u64
 
bwlim™
;

1232 
bwlim™
 = 
	`READ_ONCE
(
deviû
->
süub_¥“d_max
);

1233 ià(
bwlim™
 == 0)

1240 
div
 = 
	`max_t
(
u32
, 1, (u32)(
bwlim™
 / (16 * 1024 * 1024)));

1241 
div
 = 
	`mš_t
(
u32
, 64, div);

1244 
now
 = 
	`ktime_g‘
();

1245 ià(
sùx
->
thrÙe_d—dlše
 == 0) {

1246 
sùx
->
thrÙe_d—dlše
 = 
	`ktime_add_ms
(
now
, 
time_¦iû
 / 
div
);

1247 
sùx
->
thrÙe_£Á
 = 0;

1251 ià(
	`ktime_befÜe
(
now
, 
sùx
->
thrÙe_d—dlše
)) {

1253 
sùx
->
thrÙe_£Á
 +ğ
bio_size
;

1254 ià(
sùx
->
thrÙe_£Á
 <ğ
	`div_u64
(
bwlim™
, 
div
))

1258 
d–
 = 
	`ktime_ms_d–
(
sùx
->
thrÙe_d—dlše
, 
now
);

1261 
d–
 = 0;

1264 ià(
d–
) {

1265 
timeout
;

1267 
timeout
 = 
	`div_u64
(
d–
 * 
HZ
, 1000);

1268 
	`scheduË_timeout_š‹¼u±ibË
(
timeout
);

1272 
sùx
->
thrÙe_d—dlše
 = 0;

1273 
	}
}

1282 
	$g‘_¿id56_logic_off£t
(
u64
 
physiÿl
, 
num
,

1283 
m­_lookup
 *
m­
, 
u64
 *
off£t
,

1284 
u64
 *
¡re_¡¬t
)

1286 
i
;

1287 
j
 = 0;

1288 
u64
 
Ï¡_off£t
;

1289 cÚ¡ 
d©a_¡res
 = 
	`Ä_d©a_¡res
(
m­
);

1291 
Ï¡_off£t
 = (
physiÿl
 - 
m­
->
¡res
[
num
].physiÿlè* 
d©a_¡res
;

1292 ià(
¡re_¡¬t
)

1293 *
¡re_¡¬t
 = 
Ï¡_off£t
;

1295 *
off£t
 = 
Ï¡_off£t
;

1296 
i
 = 0; i < 
d©a_¡res
; i++) {

1297 
u32
 
¡re_Ä
;

1298 
u32
 
¡re_šdex
;

1299 
u32
 
rÙ
;

1301 *
off£t
 = 
Ï¡_off£t
 + 
	`bŒfs_¡re_Ä_to_off£t
(
i
);

1303 
¡re_Ä
 = (
u32
)(*
off£t
 >> 
BTRFS_STRIPE_LEN_SHIFT
è/ 
d©a_¡res
;

1306 
rÙ
 = 
¡re_Ä
 % 
m­
->
num_¡res
;

1308 
rÙ
 +ğ
i
;

1309 
¡re_šdex
 = 
rÙ
 % 
m­
->
num_¡res
;

1310 ià(
¡re_šdex
 =ğ
num
)

1312 ià(
¡re_šdex
 < 
num
)

1313 
j
++;

1315 *
off£t
 = 
Ï¡_off£t
 + 
	`bŒfs_¡re_Ä_to_off£t
(
j
);

1317 
	}
}

1324 
	$com·»_ex‹Á_™em_¿nge
(
bŒfs_·th
 *
·th
,

1325 
u64
 
£¬ch_¡¬t
, u64 
£¬ch_Ën
)

1327 
bŒfs_fs_šfo
 *
fs_šfo
 = 
·th
->
nodes
[0]->fs_info;

1328 
u64
 
Ën
;

1329 
bŒfs_key
 
key
;

1331 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

1332 
	`ASSERT
(
key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 ||

1333 
key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
);

1334 ià(
key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
)

1335 
Ën
 = 
fs_šfo
->
nodesize
;

1337 
Ën
 = 
key
.
off£t
;

1339 ià(
key
.
objeùid
 + 
Ën
 <ğ
£¬ch_¡¬t
)

1341 ià(
key
.
objeùid
 >ğ
£¬ch_¡¬t
 + 
£¬ch_Ën
)

1344 
	}
}

1362 
	$fšd_fœ¡_ex‹Á_™em
(
bŒfs_roÙ
 *
ex‹Á_roÙ
,

1363 
bŒfs_·th
 *
·th
,

1364 
u64
 
£¬ch_¡¬t
, u64 
£¬ch_Ën
)

1366 
bŒfs_fs_šfo
 *
fs_šfo
 = 
ex‹Á_roÙ
->fs_info;

1367 
bŒfs_key
 
key
;

1368 
»t
;

1371 ià(
·th
->
nodes
[0])

1372 
£¬ch_fÜw¬d
;

1374 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
))

1375 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

1377 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

1378 
key
.
objeùid
 = 
£¬ch_¡¬t
;

1379 
key
.
off£t
 = (
u64
)-1;

1381 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
ex‹Á_roÙ
, &
key
, 
·th
, 0, 0);

1382 ià(
»t
 < 0)

1383  
»t
;

1385 
	`ASSERT
(
»t
 > 0);

1390 
»t
 = 
	`bŒfs_´evious_ex‹Á_™em
(
ex‹Á_roÙ
, 
·th
, 0);

1391 ià(
»t
 < 0)

1392  
»t
;

1397 
£¬ch_fÜw¬d
:

1398 
Œue
) {

1399 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

1400 ià(
key
.
objeùid
 >ğ
£¬ch_¡¬t
 + 
£¬ch_Ën
)

1402 ià(
key
.
ty³
 !ğ
BTRFS_METADATA_ITEM_KEY
 &&

1403 
key
.
ty³
 !ğ
BTRFS_EXTENT_ITEM_KEY
)

1404 
Ãxt
;

1406 
»t
 = 
	`com·»_ex‹Á_™em_¿nge
(
·th
, 
£¬ch_¡¬t
, 
£¬ch_Ën
);

1407 ià(
»t
 == 0)

1408  
»t
;

1409 ià(
»t
 > 0)

1411 
Ãxt
:

1412 
·th
->
¦Ùs
[0]++;

1413 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0])) {

1414 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
ex‹Á_roÙ
, 
·th
);

1415 ià(
»t
) {

1417 
	`bŒfs_»Ëa£_·th
(
·th
);

1418  
»t
;

1422 
	`bŒfs_»Ëa£_·th
(
·th
);

1424 
	}
}

1426 
	$g‘_ex‹Á_šfo
(
bŒfs_·th
 *
·th
, 
u64
 *
ex‹Á_¡¬t_»t
,

1427 
u64
 *
size_»t
, u64 *
æags_»t
, u64 *
g’”©iÚ_»t
)

1429 
bŒfs_key
 
key
;

1430 
bŒfs_ex‹Á_™em
 *
ei
;

1432 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

1433 
	`ASSERT
(
key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
 ||

1434 
key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
);

1435 *
ex‹Á_¡¬t_»t
 = 
key
.
objeùid
;

1436 ià(
key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
)

1437 *
size_»t
 = 
·th
->
nodes
[0]->
fs_šfo
->
nodesize
;

1439 *
size_»t
 = 
key
.
off£t
;

1440 
ei
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

1441 *
æags_»t
 = 
	`bŒfs_ex‹Á_æags
(
·th
->
nodes
[0], 
ei
);

1442 *
g’”©iÚ_»t
 = 
	`bŒfs_ex‹Á_g’”©iÚ
(
·th
->
nodes
[0], 
ei
);

1443 
	}
}

1445 
	$sync_wr™e_poš‹r_fÜ_zÚed
(
süub_ùx
 *
sùx
, 
u64
 
logiÿl
,

1446 
u64
 
physiÿl
, u64 
physiÿl_’d
)

1448 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

1449 
»t
 = 0;

1451 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

1454 
	`mu‹x_lock
(&
sùx
->
wr_lock
);

1455 ià(
sùx
->
wr™e_poš‹r
 < 
physiÿl_’d
) {

1456 
»t
 = 
	`bŒfs_sync_zÚe_wr™e_poš‹r
(
sùx
->
wr_tgtdev
, 
logiÿl
,

1457 
physiÿl
,

1458 
sùx
->
wr™e_poš‹r
);

1459 ià(
»t
)

1460 
	`bŒfs_”r
(
fs_šfo
,

1463 
	`mu‹x_uÆock
(&
sùx
->
wr_lock
);

1464 
	`bŒfs_dev_ş—r_zÚe_em±y
(
sùx
->
wr_tgtdev
, 
physiÿl
);

1466  
»t
;

1467 
	}
}

1469 
	$fl_Úe_ex‹Á_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
,

1470 
süub_¡re
 *
¡re
,

1471 
u64
 
ex‹Á_¡¬t
, u64 
ex‹Á_Ën
,

1472 
u64
 
ex‹Á_æags
, u64 
ex‹Á_g’
)

1474 
u64
 
cur_logiÿl
 = 
	`max
(
¡re
->
logiÿl
, 
ex‹Á_¡¬t
);

1475 
cur_logiÿl
 < 
	`mš
(
¡re
->
logiÿl
 + 
BTRFS_STRIPE_LEN
,

1476 
ex‹Á_¡¬t
 + 
ex‹Á_Ën
);

1477 
cur_logiÿl
 +ğ
fs_šfo
->
£ùÜsize
) {

1478 cÚ¡ 
Ä_£ùÜ
 = (
cur_logiÿl
 - 
¡re
->
logiÿl
) >>

1479 
fs_šfo
->
£ùÜsize_b™s
;

1480 
süub_£ùÜ_v”ifiÿtiÚ
 *
£ùÜ
 =

1481 &
¡re
->
£ùÜs
[
Ä_£ùÜ
];

1483 
	`£t_b™
(
Ä_£ùÜ
, &
¡re
->
ex‹Á_£ùÜ_b™m­
);

1484 ià(
ex‹Á_æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

1485 
£ùÜ
->
is_m‘ad©a
 = 
Œue
;

1486 
£ùÜ
->
g’”©iÚ
 = 
ex‹Á_g’
;

1489 
	}
}

1491 
	$süub_¡re_»£t_b™m­s
(
süub_¡re
 *
¡re
)

1493 
¡re
->
ex‹Á_£ùÜ_b™m­
 = 0;

1494 
¡re
->
š™_”rÜ_b™m­
 = 0;

1495 
¡re
->
š™_Ä_io_”rÜs
 = 0;

1496 
¡re
->
š™_Ä_csum_”rÜs
 = 0;

1497 
¡re
->
š™_Ä_m‘a_”rÜs
 = 0;

1498 
¡re
->
”rÜ_b™m­
 = 0;

1499 
¡re
->
io_”rÜ_b™m­
 = 0;

1500 
¡re
->
csum_”rÜ_b™m­
 = 0;

1501 
¡re
->
m‘a_”rÜ_b™m­
 = 0;

1502 
	}
}

1511 
	$süub_fšd_fl_fœ¡_¡re
(
bŒfs_block_group
 *
bg
,

1512 
bŒfs_·th
 *
ex‹Á_·th
,

1513 
bŒfs_·th
 *
csum_·th
,

1514 
bŒfs_deviû
 *
dev
, 
u64
 
physiÿl
,

1515 
mœrÜ_num
, 
u64
 
logiÿl_¡¬t
,

1516 
u32
 
logiÿl_Ën
,

1517 
süub_¡re
 *
¡re
)

1519 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bg
->fs_info;

1520 
bŒfs_roÙ
 *
ex‹Á_roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 
bg
->
¡¬t
);

1521 
bŒfs_roÙ
 *
csum_roÙ
 = 
	`bŒfs_csum_roÙ
(
fs_šfo
, 
bg
->
¡¬t
);

1522 cÚ¡ 
u64
 
logiÿl_’d
 = 
logiÿl_¡¬t
 + 
logiÿl_Ën
;

1523 
u64
 
cur_logiÿl
 = 
logiÿl_¡¬t
;

1524 
u64
 
¡re_’d
;

1525 
u64
 
ex‹Á_¡¬t
;

1526 
u64
 
ex‹Á_Ën
;

1527 
u64
 
ex‹Á_æags
;

1528 
u64
 
ex‹Á_g’
;

1529 
»t
;

1531 
	`mem£t
(
¡re
->
£ùÜs
, 0, (
süub_£ùÜ_v”ifiÿtiÚ
) *

1532 
¡re
->
Ä_£ùÜs
);

1533 
	`süub_¡re_»£t_b™m­s
(
¡re
);

1536 
	`ASSERT
(
logiÿl_¡¬t
 >ğ
bg
->
¡¬t
 && 
logiÿl_’d
 <ğbg->¡¬ˆ+ bg->
Ëngth
);

1538 
»t
 = 
	`fšd_fœ¡_ex‹Á_™em
(
ex‹Á_roÙ
, 
ex‹Á_·th
, 
logiÿl_¡¬t
,

1539 
logiÿl_Ën
);

1541 ià(
»t
)

1542 
out
;

1543 
	`g‘_ex‹Á_šfo
(
ex‹Á_·th
, &
ex‹Á_¡¬t
, &
ex‹Á_Ën
, &
ex‹Á_æags
,

1544 &
ex‹Á_g’
);

1545 ià(
ex‹Á_æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
)

1546 
¡re
->
Ä_m‘a_ex‹Ás
++;

1547 ià(
ex‹Á_æags
 & 
BTRFS_EXTENT_FLAG_DATA
)

1548 
¡re
->
Ä_d©a_ex‹Ás
++;

1549 
cur_logiÿl
 = 
	`max
(
ex‹Á_¡¬t
, cur_logical);

1557 
¡re
->
logiÿl
 = 
	`round_down
(
cur_logiÿl
 - 
bg
->
¡¬t
, 
BTRFS_STRIPE_LEN
) +

1558 
bg
->
¡¬t
;

1559 
¡re
->
physiÿl
 =…hysiÿÈ+ sŒe->
logiÿl
 - 
logiÿl_¡¬t
;

1560 
¡re
->
dev
 = dev;

1561 
¡re
->
bg
 = bg;

1562 
¡re
->
mœrÜ_num
 = mirror_num;

1563 
¡re_’d
 = 
¡re
->
logiÿl
 + 
BTRFS_STRIPE_LEN
 - 1;

1566 
	`fl_Úe_ex‹Á_šfo
(
fs_šfo
, 
¡re
, 
ex‹Á_¡¬t
, 
ex‹Á_Ën
,

1567 
ex‹Á_æags
, 
ex‹Á_g’
);

1568 
cur_logiÿl
 = 
ex‹Á_¡¬t
 + 
ex‹Á_Ën
;

1571 
cur_logiÿl
 <ğ
¡re_’d
) {

1572 
»t
 = 
	`fšd_fœ¡_ex‹Á_™em
(
ex‹Á_roÙ
, 
ex‹Á_·th
, 
cur_logiÿl
,

1573 
¡re_’d
 - 
cur_logiÿl
 + 1);

1574 ià(
»t
 < 0)

1575 
out
;

1576 ià(
»t
 > 0) {

1577 
»t
 = 0;

1580 
	`g‘_ex‹Á_šfo
(
ex‹Á_·th
, &
ex‹Á_¡¬t
, &
ex‹Á_Ën
,

1581 &
ex‹Á_æags
, &
ex‹Á_g’
);

1582 ià(
ex‹Á_æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
)

1583 
¡re
->
Ä_m‘a_ex‹Ás
++;

1584 ià(
ex‹Á_æags
 & 
BTRFS_EXTENT_FLAG_DATA
)

1585 
¡re
->
Ä_d©a_ex‹Ás
++;

1586 
	`fl_Úe_ex‹Á_šfo
(
fs_šfo
, 
¡re
, 
ex‹Á_¡¬t
, 
ex‹Á_Ën
,

1587 
ex‹Á_æags
, 
ex‹Á_g’
);

1588 
cur_logiÿl
 = 
ex‹Á_¡¬t
 + 
ex‹Á_Ën
;

1592 ià(
bg
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
) {

1593 
£ùÜ_Ä
;

1594 
csum_b™m­
 = 0;

1597 
	`ASSERT
(
¡re
->
csums
);

1603 
	`ASSERT
(
BITS_PER_LONG
 >ğ
BTRFS_STRIPE_LEN
 >> 
fs_šfo
->
£ùÜsize_b™s
);

1605 
»t
 = 
	`bŒfs_lookup_csums_b™m­
(
csum_roÙ
, 
csum_·th
,

1606 
¡re
->
logiÿl
, 
¡re_’d
,

1607 
¡re
->
csums
, &
csum_b™m­
);

1608 ià(
»t
 < 0)

1609 
out
;

1610 ià(
»t
 > 0)

1611 
»t
 = 0;

1613 
	`fÜ_—ch_£t_b™
(
£ùÜ_Ä
, &
csum_b™m­
, 
¡re
->
Ä_£ùÜs
) {

1614 
¡re
->
£ùÜs
[
£ùÜ_Ä
].
csum
 = sŒe->
csums
 +

1615 
£ùÜ_Ä
 * 
fs_šfo
->
csum_size
;

1618 
	`£t_b™
(
SCRUB_STRIPE_FLAG_INITIALIZED
, &
¡re
->
¡©e
);

1619 
out
:

1620  
»t
;

1621 
	}
}

1623 
	$süub_»£t_¡re
(
süub_¡re
 *
¡re
)

1625 
	`süub_¡re_»£t_b™m­s
(
¡re
);

1627 
¡re
->
Ä_m‘a_ex‹Ás
 = 0;

1628 
¡re
->
Ä_d©a_ex‹Ás
 = 0;

1629 
¡re
->
¡©e
 = 0;

1631 
i
 = 0; i < 
¡re
->
Ä_£ùÜs
; i++) {

1632 
¡re
->
£ùÜs
[
i
].
is_m‘ad©a
 = 
çl£
;

1633 
¡re
->
£ùÜs
[
i
].
csum
 = 
NULL
;

1634 
¡re
->
£ùÜs
[
i
].
g’”©iÚ
 = 0;

1636 
	}
}

1638 
	$süub_subm™_š™Ÿl_»ad
(
süub_ùx
 *
sùx
,

1639 
süub_¡re
 *
¡re
)

1641 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

1642 
bŒfs_bio
 *
bbio
;

1643 
mœrÜ
 = 
¡re
->
mœrÜ_num
;

1645 
	`ASSERT
(
¡re
->
bg
);

1646 
	`ASSERT
(
¡re
->
mœrÜ_num
 > 0);

1647 
	`ASSERT
(
	`‹¡_b™
(
SCRUB_STRIPE_FLAG_INITIALIZED
, &
¡re
->
¡©e
));

1649 
bbio
 = 
	`bŒfs_bio_®loc
(
SCRUB_STRIPE_PAGES
, 
REQ_OP_READ
, 
fs_šfo
,

1650 
süub_»ad_’dio
, 
¡re
);

1653 
bbio
->
bio
.
bi_™”
.
bi_£ùÜ
 = 
¡re
->
logiÿl
 >> 
SECTOR_SHIFT
;

1654 
i
 = 0; i < 
BTRFS_STRIPE_LEN
 >> 
PAGE_SHIFT
; i++) {

1655 
»t
;

1657 
»t
 = 
	`bio_add_·ge
(&
bbio
->
bio
, 
¡re
->
·ges
[
i
], 
PAGE_SIZE
, 0);

1659 
	`ASSERT
(
»t
 =ğ
PAGE_SIZE
);

1661 
	`©omic_šc
(&
¡re
->
³ndšg_io
);

1667 ià(
sùx
->
is_dev_»¶aû
 &&

1668 (
fs_šfo
->
dev_»¶aû
.
cÚt_»adšg_äom_¤cdev_mode
 ==

1669 
BTRFS_DEV_REPLACE_ITEM_CONT_READING_FROM_SRCDEV_MODE_AVOID
 ||

1670 !
¡re
->
dev
->
bdev
)) {

1671 
num_cİ›s
 = 
	`bŒfs_num_cİ›s
(
fs_šfo
, 
¡re
->
bg
->
¡¬t
,

1672 
¡re
->
bg
->
Ëngth
);

1674 
mœrÜ
 = 
	`ÿlc_Ãxt_mœrÜ
(mœrÜ, 
num_cİ›s
);

1676 
	`bŒfs_subm™_bio
(
bbio
, 
mœrÜ
);

1677 
	}
}

1679 
boŞ
 
	$¡re_has_m‘ad©a_”rÜ
(
süub_¡re
 *
¡re
)

1681 
i
;

1683 
	`fÜ_—ch_£t_b™
(
i
, &
¡re
->
”rÜ_b™m­
, sŒe->
Ä_£ùÜs
) {

1684 ià(
¡re
->
£ùÜs
[
i
].
is_m‘ad©a
) {

1685 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡re
->
bg
->fs_info;

1687 
	`bŒfs_”r
(
fs_šfo
,

1689 
¡re
->
logiÿl
,

1690 
¡re
->
logiÿl
 + (
i
 << 
fs_šfo
->
£ùÜsize_b™s
));

1691  
Œue
;

1694  
çl£
;

1695 
	}
}

1697 
	$subm™_š™Ÿl_group_»ad
(
süub_ùx
 *
sùx
,

1698 
fœ¡_¦Ù
,

1699 
Ä_¡res
)

1701 
blk_¶ug
 
¶ug
;

1703 
	`ASSERT
(
fœ¡_¦Ù
 < 
SCRUB_TOTAL_STRIPES
);

1704 
	`ASSERT
(
fœ¡_¦Ù
 + 
Ä_¡res
 <ğ
SCRUB_TOTAL_STRIPES
);

1706 
	`süub_thrÙe_dev_io
(
sùx
, sùx->
¡res
[0].
dev
,

1707 
	`bŒfs_¡re_Ä_to_off£t
(
Ä_¡res
));

1708 
	`blk_¡¬t_¶ug
(&
¶ug
);

1709 
i
 = 0; i < 
Ä_¡res
; i++) {

1710 
süub_¡re
 *
¡re
 = &
sùx
->
¡res
[
fœ¡_¦Ù
 + 
i
];

1713 
	`ASSERT
(
	`‹¡_b™
(
SCRUB_STRIPE_FLAG_INITIALIZED
, &
¡re
->
¡©e
));

1714 
	`süub_subm™_š™Ÿl_»ad
(
sùx
, 
¡re
);

1716 
	`blk_fšish_¶ug
(&
¶ug
);

1717 
	}
}

1719 
	$æush_süub_¡res
(
süub_ùx
 *
sùx
)

1721 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

1722 
süub_¡re
 *
¡re
;

1723 cÚ¡ 
Ä_¡res
 = 
sùx
->
cur_¡re
;

1724 
»t
 = 0;

1726 ià(!
Ä_¡res
)

1729 
	`ASSERT
(
	`‹¡_b™
(
SCRUB_STRIPE_FLAG_INITIALIZED
, &
sùx
->
¡res
[0].
¡©e
));

1732 ià(
Ä_¡res
 % 
SCRUB_STRIPES_PER_GROUP
) {

1733 cÚ¡ 
fœ¡_¦Ù
 = 
	`round_down
(
Ä_¡res
, 
SCRUB_STRIPES_PER_GROUP
);

1735 
	`subm™_š™Ÿl_group_»ad
(
sùx
, 
fœ¡_¦Ù
, 
Ä_¡res
 - first_slot);

1738 
i
 = 0; i < 
Ä_¡res
; i++) {

1739 
¡re
 = &
sùx
->
¡res
[
i
];

1741 
	`wa™_ev’t
(
¡re
->
»·œ_wa™
,

1742 
	`‹¡_b™
(
SCRUB_STRIPE_FLAG_REPAIR_DONE
, &
¡re
->
¡©e
));

1746 ià(
sùx
->
is_dev_»¶aû
) {

1751 
i
 = 0; i < 
Ä_¡res
; i++) {

1752 ià(
	`¡re_has_m‘ad©a_”rÜ
(&
sùx
->
¡res
[
i
])) {

1753 
»t
 = -
EIO
;

1754 
out
;

1757 
i
 = 0; i < 
Ä_¡res
; i++) {

1758 
good
;

1760 
¡re
 = &
sùx
->
¡res
[
i
];

1762 
	`ASSERT
(
¡re
->
dev
 =ğ
fs_šfo
->
dev_»¶aû
.
¤cdev
);

1764 
	`b™m­_ªdnÙ
(&
good
, &
¡re
->
ex‹Á_£ùÜ_b™m­
,

1765 &
¡re
->
”rÜ_b™m­
, sŒe->
Ä_£ùÜs
);

1766 
	`süub_wr™e_£ùÜs
(
sùx
, 
¡re
, 
good
, 
Œue
);

1771 
i
 = 0; i < 
Ä_¡res
; i++) {

1772 
¡re
 = &
sùx
->
¡res
[
i
];

1774 
	`wa™_süub_¡re_io
(
¡re
);

1775 
	`süub_»£t_¡re
(
¡re
);

1777 
out
:

1778 
sùx
->
cur_¡re
 = 0;

1779  
»t
;

1780 
	}
}

1782 
	$¿id56_süub_wa™_’dio
(
bio
 *bio)

1784 
	`com¶‘e
(
bio
->
bi_´iv©e
);

1785 
	}
}

1787 
	$queue_süub_¡re
(
süub_ùx
 *
sùx
, 
bŒfs_block_group
 *
bg
,

1788 
bŒfs_deviû
 *
dev
, 
mœrÜ_num
,

1789 
u64
 
logiÿl
, 
u32
 
Ëngth
, u64 
physiÿl
,

1790 
u64
 *
found_logiÿl_»t
)

1792 
süub_¡re
 *
¡re
;

1793 
»t
;

1799 
	`ASSERT
(
sùx
->
cur_¡re
 < 
SCRUB_TOTAL_STRIPES
);

1802 
	`ASSERT
(
found_logiÿl_»t
);

1804 
¡re
 = &
sùx
->
¡res
[sùx->
cur_¡re
];

1805 
	`süub_»£t_¡re
(
¡re
);

1806 
»t
 = 
	`süub_fšd_fl_fœ¡_¡re
(
bg
, &
sùx
->
ex‹Á_·th
,

1807 &
sùx
->
csum_·th
, 
dev
, 
physiÿl
,

1808 
mœrÜ_num
, 
logiÿl
, 
Ëngth
, 
¡re
);

1810 ià(
»t
)

1811  
»t
;

1812 *
found_logiÿl_»t
 = 
¡re
->
logiÿl
;

1813 
sùx
->
cur_¡re
++;

1816 ià(
sùx
->
cur_¡re
 % 
SCRUB_STRIPES_PER_GROUP
 == 0) {

1817 cÚ¡ 
fœ¡_¦Ù
 = 
sùx
->
cur_¡re
 - 
SCRUB_STRIPES_PER_GROUP
;

1819 
	`subm™_š™Ÿl_group_»ad
(
sùx
, 
fœ¡_¦Ù
, 
SCRUB_STRIPES_PER_GROUP
);

1823 ià(
sùx
->
cur_¡re
 =ğ
SCRUB_TOTAL_STRIPES
)

1824  
	`æush_süub_¡res
(
sùx
);

1826 
	}
}

1828 
	$süub_¿id56_·r™y_¡re
(
süub_ùx
 *
sùx
,

1829 
bŒfs_deviû
 *
süub_dev
,

1830 
bŒfs_block_group
 *
bg
,

1831 
m­_lookup
 *
m­
,

1832 
u64
 
fuÎ_¡re_¡¬t
)

1834 
	`DECLARE_COMPLETION_ONSTACK
(
io_dÚe
);

1835 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

1836 
bŒfs_¿id_bio
 *
rbio
;

1837 
bŒfs_io_cÚ‹xt
 *
bioc
 = 
NULL
;

1838 
bŒfs_·th
 
ex‹Á_·th
 = { 0 };

1839 
bŒfs_·th
 
csum_·th
 = { 0 };

1840 
bio
 *bio;

1841 
süub_¡re
 *
¡re
;

1842 
boŞ
 
®l_em±y
 = 
Œue
;

1843 cÚ¡ 
d©a_¡res
 = 
	`Ä_d©a_¡res
(
m­
);

1844 
ex‹Á_b™m­
 = 0;

1845 
u64
 
Ëngth
 = 
	`bŒfs_¡re_Ä_to_off£t
(
d©a_¡res
);

1846 
»t
;

1848 
	`ASSERT
(
sùx
->
¿id56_d©a_¡res
);

1855 
ex‹Á_·th
.
£¬ch_comm™_roÙ
 = 1;

1856 
ex‹Á_·th
.
sk_lockšg
 = 1;

1857 
csum_·th
.
£¬ch_comm™_roÙ
 = 1;

1858 
csum_·th
.
sk_lockšg
 = 1;

1860 
i
 = 0; i < 
d©a_¡res
; i++) {

1861 
¡re_šdex
;

1862 
rÙ
;

1863 
u64
 
physiÿl
;

1865 
¡re
 = &
sùx
->
¿id56_d©a_¡res
[
i
];

1866 
rÙ
 = 
	`div_u64
(
fuÎ_¡re_¡¬t
 - 
bg
->
¡¬t
,

1867 
d©a_¡res
è>> 
BTRFS_STRIPE_LEN_SHIFT
;

1868 
¡re_šdex
 = (
i
 + 
rÙ
è% 
m­
->
num_¡res
;

1869 
physiÿl
 = 
m­
->
¡res
[
¡re_šdex
].physical +

1870 
	`bŒfs_¡re_Ä_to_off£t
(
rÙ
);

1872 
	`süub_»£t_¡re
(
¡re
);

1873 
	`£t_b™
(
SCRUB_STRIPE_FLAG_NO_REPORT
, &
¡re
->
¡©e
);

1874 
»t
 = 
	`süub_fšd_fl_fœ¡_¡re
(
bg
, &
ex‹Á_·th
, &
csum_·th
,

1875 
m­
->
¡res
[
¡re_šdex
].
dev
, 
physiÿl
, 1,

1876 
fuÎ_¡re_¡¬t
 + 
	`bŒfs_¡re_Ä_to_off£t
(
i
),

1877 
BTRFS_STRIPE_LEN
, 
¡re
);

1878 ià(
»t
 < 0)

1879 
out
;

1884 ià(
»t
 > 0) {

1885 
¡re
->
logiÿl
 = 
fuÎ_¡re_¡¬t
 +

1886 
	`bŒfs_¡re_Ä_to_off£t
(
i
);

1887 
¡re
->
dev
 = 
m­
->
¡res
[
¡re_šdex
].dev;

1888 
¡re
->
mœrÜ_num
 = 1;

1889 
	`£t_b™
(
SCRUB_STRIPE_FLAG_INITIALIZED
, &
¡re
->
¡©e
);

1894 
i
 = 0; i < 
d©a_¡res
; i++) {

1895 
¡re
 = &
sùx
->
¿id56_d©a_¡res
[
i
];

1896 ià(!
	`b™m­_em±y
(&
¡re
->
ex‹Á_£ùÜ_b™m­
, sŒe->
Ä_£ùÜs
)) {

1897 
®l_em±y
 = 
çl£
;

1901 ià(
®l_em±y
) {

1902 
»t
 = 0;

1903 
out
;

1906 
i
 = 0; i < 
d©a_¡res
; i++) {

1907 
¡re
 = &
sùx
->
¿id56_d©a_¡res
[
i
];

1908 
	`süub_subm™_š™Ÿl_»ad
(
sùx
, 
¡re
);

1910 
i
 = 0; i < 
d©a_¡res
; i++) {

1911 
¡re
 = &
sùx
->
¿id56_d©a_¡res
[
i
];

1913 
	`wa™_ev’t
(
¡re
->
»·œ_wa™
,

1914 
	`‹¡_b™
(
SCRUB_STRIPE_FLAG_REPAIR_DONE
, &
¡re
->
¡©e
));

1917 
	`ASSERT
(!
	`bŒfs_is_zÚed
(
sùx
->
fs_šfo
));

1926 
i
 = 0; i < 
d©a_¡res
; i++) {

1927 
”rÜ
;

1929 
¡re
 = &
sùx
->
¿id56_d©a_¡res
[
i
];

1935 
	`b™m­_ªd
(&
”rÜ
, &
¡re
->
”rÜ_b™m­
,

1936 &
¡re
->
ex‹Á_£ùÜ_b™m­
, sŒe->
Ä_£ùÜs
);

1937 ià(!
	`b™m­_em±y
(&
”rÜ
, 
¡re
->
Ä_£ùÜs
)) {

1938 
	`bŒfs_”r
(
fs_šfo
,

1940 
fuÎ_¡re_¡¬t
, 
i
, 
¡re
->
Ä_£ùÜs
,

1941 &
”rÜ
);

1942 
»t
 = -
EIO
;

1943 
out
;

1945 
	`b™m­_Ü
(&
ex‹Á_b™m­
, &extent_bitmap,

1946 &
¡re
->
ex‹Á_£ùÜ_b™m­
, sŒe->
Ä_£ùÜs
);

1950 
bio
 = 
	`bio_®loc
(
NULL
, 1, 
REQ_OP_READ
, 
GFP_NOFS
);

1951 
bio
->
bi_™”
.
bi_£ùÜ
 = 
fuÎ_¡re_¡¬t
 >> 
SECTOR_SHIFT
;

1952 
bio
->
bi_´iv©e
 = &
io_dÚe
;

1953 
bio
->
bi_’d_io
 = 
¿id56_süub_wa™_’dio
;

1955 
	`bŒfs_bio_couÁ”_šc_blocked
(
fs_šfo
);

1956 
»t
 = 
	`bŒfs_m­_block
(
fs_šfo
, 
BTRFS_MAP_WRITE
, 
fuÎ_¡re_¡¬t
,

1957 &
Ëngth
, &
bioc
, 
NULL
, NULL, 1);

1958 ià(
»t
 < 0) {

1959 
	`bŒfs_put_bioc
(
bioc
);

1960 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

1961 
out
;

1963 
rbio
 = 
	`¿id56_·r™y_®loc_süub_rbio
(
bio
, 
bioc
, 
süub_dev
, &
ex‹Á_b™m­
,

1964 
BTRFS_STRIPE_LEN
 >> 
fs_šfo
->
£ùÜsize_b™s
);

1965 
	`bŒfs_put_bioc
(
bioc
);

1966 ià(!
rbio
) {

1967 
»t
 = -
ENOMEM
;

1968 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

1969 
out
;

1972 
i
 = 0; i < 
d©a_¡res
; i++) {

1973 
¡re
 = &
sùx
->
¿id56_d©a_¡res
[
i
];

1975 
	`¿id56_·r™y_ÿche_d©a_·ges
(
rbio
, 
¡re
->
·ges
,

1976 
fuÎ_¡re_¡¬t
 + (
i
 << 
BTRFS_STRIPE_LEN_SHIFT
));

1978 
	`¿id56_·r™y_subm™_süub_rbio
(
rbio
);

1979 
	`wa™_fÜ_com¶‘iÚ_io
(&
io_dÚe
);

1980 
»t
 = 
	`blk_¡©us_to_”ºo
(
bio
->
bi_¡©us
);

1981 
	`bio_put
(
bio
);

1982 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

1984 
	`bŒfs_»Ëa£_·th
(&
ex‹Á_·th
);

1985 
	`bŒfs_»Ëa£_·th
(&
csum_·th
);

1986 
out
:

1987  
»t
;

1988 
	}
}

1998 
	$süub_sim¶e_mœrÜ
(
süub_ùx
 *
sùx
,

1999 
bŒfs_block_group
 *
bg
,

2000 
m­_lookup
 *
m­
,

2001 
u64
 
logiÿl_¡¬t
, u64 
logiÿl_Ëngth
,

2002 
bŒfs_deviû
 *
deviû
,

2003 
u64
 
physiÿl
, 
mœrÜ_num
)

2005 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

2006 cÚ¡ 
u64
 
logiÿl_’d
 = 
logiÿl_¡¬t
 + 
logiÿl_Ëngth
;

2007 
u64
 
cur_logiÿl
 = 
logiÿl_¡¬t
;

2008 
»t
;

2011 
	`ASSERT
(
logiÿl_¡¬t
 >ğ
bg
->
¡¬t
 && 
logiÿl_’d
 <ğbg->¡¬ˆ+ bg->
Ëngth
);

2014 
cur_logiÿl
 < 
logiÿl_’d
) {

2015 
u64
 
found_logiÿl
 = 
U64_MAX
;

2016 
u64
 
cur_physiÿl
 = 
physiÿl
 + 
cur_logiÿl
 - 
logiÿl_¡¬t
;

2019 ià(
	`©omic_»ad
(&
fs_šfo
->
süub_ÿnûl_»q
) ||

2020 
	`©omic_»ad
(&
sùx
->
ÿnûl_»q
)) {

2021 
»t
 = -
ECANCELED
;

2025 ià(
	`©omic_»ad
(&
fs_šfo
->
süub_·u£_»q
)) {

2027 
	`süub_blocked_if_Ãeded
(
fs_šfo
);

2030 
	`¥š_lock
(&
bg
->
lock
);

2031 ià(
	`‹¡_b™
(
BLOCK_GROUP_FLAG_REMOVED
, &
bg
->
ruÁime_æags
)) {

2032 
	`¥š_uÆock
(&
bg
->
lock
);

2033 
»t
 = 0;

2036 
	`¥š_uÆock
(&
bg
->
lock
);

2038 
»t
 = 
	`queue_süub_¡re
(
sùx
, 
bg
, 
deviû
, 
mœrÜ_num
,

2039 
cur_logiÿl
, 
logiÿl_’d
 - cur_logical,

2040 
cur_physiÿl
, &
found_logiÿl
);

2041 ià(
»t
 > 0) {

2043 
sùx
->
¡©
.
Ï¡_physiÿl
 = 
physiÿl
 + 
logiÿl_Ëngth
;

2044 
»t
 = 0;

2047 ià(
»t
 < 0)

2051 
	`ASSERT
(
found_logiÿl
 !ğ
U64_MAX
);

2052 
cur_logiÿl
 = 
found_logiÿl
 + 
BTRFS_STRIPE_LEN
;

2055 
	`cÚd_»sched
();

2057  
»t
;

2058 
	}
}

2061 
u64
 
	$sim¶e_¡re_fuÎ_¡re_Ën
(cÚ¡ 
m­_lookup
 *
m­
)

2063 
	`ASSERT
(
m­
->
ty³
 & (
BTRFS_BLOCK_GROUP_RAID0
 |

2064 
BTRFS_BLOCK_GROUP_RAID10
));

2066  
	`bŒfs_¡re_Ä_to_off£t
(
m­
->
num_¡res
 / m­->
sub_¡res
);

2067 
	}
}

2070 
u64
 
	$sim¶e_¡re_g‘_logiÿl
(
m­_lookup
 *
m­
,

2071 
bŒfs_block_group
 *
bg
,

2072 
¡re_šdex
)

2074 
	`ASSERT
(
m­
->
ty³
 & (
BTRFS_BLOCK_GROUP_RAID0
 |

2075 
BTRFS_BLOCK_GROUP_RAID10
));

2076 
	`ASSERT
(
¡re_šdex
 < 
m­
->
num_¡res
);

2082  
	`bŒfs_¡re_Ä_to_off£t
(
¡re_šdex
 / 
m­
->
sub_¡res
) +

2083 
bg
->
¡¬t
;

2084 
	}
}

2087 
	$sim¶e_¡re_mœrÜ_num
(
m­_lookup
 *
m­
, 
¡re_šdex
)

2089 
	`ASSERT
(
m­
->
ty³
 & (
BTRFS_BLOCK_GROUP_RAID0
 |

2090 
BTRFS_BLOCK_GROUP_RAID10
));

2091 
	`ASSERT
(
¡re_šdex
 < 
m­
->
num_¡res
);

2094  
¡re_šdex
 % 
m­
->
sub_¡res
 + 1;

2095 
	}
}

2097 
	$süub_sim¶e_¡re
(
süub_ùx
 *
sùx
,

2098 
bŒfs_block_group
 *
bg
,

2099 
m­_lookup
 *
m­
,

2100 
bŒfs_deviû
 *
deviû
,

2101 
¡re_šdex
)

2103 cÚ¡ 
u64
 
logiÿl_šüem’t
 = 
	`sim¶e_¡re_fuÎ_¡re_Ën
(
m­
);

2104 cÚ¡ 
u64
 
Üig_logiÿl
 = 
	`sim¶e_¡re_g‘_logiÿl
(
m­
, 
bg
, 
¡re_šdex
);

2105 cÚ¡ 
u64
 
Üig_physiÿl
 = 
m­
->
¡res
[
¡re_šdex
].
physiÿl
;

2106 cÚ¡ 
mœrÜ_num
 = 
	`sim¶e_¡re_mœrÜ_num
(
m­
, 
¡re_šdex
);

2107 
u64
 
cur_logiÿl
 = 
Üig_logiÿl
;

2108 
u64
 
cur_physiÿl
 = 
Üig_physiÿl
;

2109 
»t
 = 0;

2111 
cur_logiÿl
 < 
bg
->
¡¬t
 + bg->
Ëngth
) {

2117 
»t
 = 
	`süub_sim¶e_mœrÜ
(
sùx
, 
bg
, 
m­
, 
cur_logiÿl
,

2118 
BTRFS_STRIPE_LEN
, 
deviû
, 
cur_physiÿl
,

2119 
mœrÜ_num
);

2120 ià(
»t
)

2121  
»t
;

2123 
cur_logiÿl
 +ğ
logiÿl_šüem’t
;

2125 
cur_physiÿl
 +ğ
BTRFS_STRIPE_LEN
;

2127  
»t
;

2128 
	}
}

2130 
nošlše_fÜ_¡ack
 
	$süub_¡re
(
süub_ùx
 *
sùx
,

2131 
bŒfs_block_group
 *
bg
,

2132 
ex‹Á_m­
 *
em
,

2133 
bŒfs_deviû
 *
süub_dev
,

2134 
¡re_šdex
)

2136 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

2137 
m­_lookup
 *
m­
 = 
em
->map_lookup;

2138 cÚ¡ 
u64
 
´ofe
 = 
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
;

2139 cÚ¡ 
u64
 
chunk_logiÿl
 = 
bg
->
¡¬t
;

2140 
»t
;

2141 
»t2
;

2142 
u64
 
physiÿl
 = 
m­
->
¡res
[
¡re_šdex
].physical;

2143 cÚ¡ 
u64
 
dev_¡re_Ën
 = 
	`bŒfs_ÿlc_¡re_Ëngth
(
em
);

2144 cÚ¡ 
u64
 
physiÿl_’d
 = 
physiÿl
 + 
dev_¡re_Ën
;

2145 
u64
 
logiÿl
;

2146 
u64
 
logic_’d
;

2148 
u64
 
šüem’t
;

2150 
u64
 
off£t
;

2151 
u64
 
¡re_logiÿl
;

2152 
¡İ_loİ
 = 0;

2155 
	`ASSERT
(
sùx
->
ex‹Á_·th
.
nodes
[0] =ğ
NULL
);

2157 
	`süub_blocked_if_Ãeded
(
fs_šfo
);

2159 ià(
sùx
->
is_dev_»¶aû
 &&

2160 
	`bŒfs_dev_is_£qu’tŸl
(
sùx
->
wr_tgtdev
, 
physiÿl
)) {

2161 
	`mu‹x_lock
(&
sùx
->
wr_lock
);

2162 
sùx
->
wr™e_poš‹r
 = 
physiÿl
;

2163 
	`mu‹x_uÆock
(&
sùx
->
wr_lock
);

2167 ià(
´ofe
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

2168 
	`ASSERT
(
sùx
->
¿id56_d©a_¡res
 =ğ
NULL
);

2170 
sùx
->
¿id56_d©a_¡res
 = 
	`kÿÎoc
(
	`Ä_d©a_¡res
(
m­
),

2171 (
süub_¡re
),

2172 
GFP_KERNEL
);

2173 ià(!
sùx
->
¿id56_d©a_¡res
) {

2174 
»t
 = -
ENOMEM
;

2175 
out
;

2177 
i
 = 0; i < 
	`Ä_d©a_¡res
(
m­
); i++) {

2178 
»t
 = 
	`š™_süub_¡re
(
fs_šfo
,

2179 &
sùx
->
¿id56_d©a_¡res
[
i
]);

2180 ià(
»t
 < 0)

2181 
out
;

2182 
sùx
->
¿id56_d©a_¡res
[
i
].
bg
 = bg;

2183 
sùx
->
¿id56_d©a_¡res
[
i
].sctx = sctx;

2193 ià(!(
´ofe
 & (
BTRFS_BLOCK_GROUP_RAID0
 | 
BTRFS_BLOCK_GROUP_RAID10
 |

2194 
BTRFS_BLOCK_GROUP_RAID56_MASK
))) {

2203 
»t
 = 
	`süub_sim¶e_mœrÜ
(
sùx
, 
bg
, 
m­
, bg->
¡¬t
, bg->
Ëngth
,

2204 
süub_dev
, 
m­
->
¡res
[
¡re_šdex
].
physiÿl
,

2205 
¡re_šdex
 + 1);

2206 
off£t
 = 0;

2207 
out
;

2209 ià(
´ofe
 & (
BTRFS_BLOCK_GROUP_RAID0
 | 
BTRFS_BLOCK_GROUP_RAID10
)) {

2210 
»t
 = 
	`süub_sim¶e_¡re
(
sùx
, 
bg
, 
m­
, 
süub_dev
, 
¡re_šdex
);

2211 
off£t
 = 
	`bŒfs_¡re_Ä_to_off£t
(
¡re_šdex
 / 
m­
->
sub_¡res
);

2212 
out
;

2216 
	`ASSERT
(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
);

2217 
»t
 = 0;

2220 
	`g‘_¿id56_logic_off£t
(
physiÿl_’d
, 
¡re_šdex
,

2221 
m­
, &
logic_’d
, 
NULL
);

2222 
logic_’d
 +ğ
chunk_logiÿl
;

2225 
	`g‘_¿id56_logic_off£t
(
physiÿl
, 
¡re_šdex
, 
m­
, &
off£t
, 
NULL
);

2226 
šüem’t
 = 
	`bŒfs_¡re_Ä_to_off£t
(
	`Ä_d©a_¡res
(
m­
));

2232 
physiÿl
 < 
physiÿl_’d
) {

2233 
»t
 = 
	`g‘_¿id56_logic_off£t
(
physiÿl
, 
¡re_šdex
, 
m­
,

2234 &
logiÿl
, &
¡re_logiÿl
);

2235 
logiÿl
 +ğ
chunk_logiÿl
;

2236 ià(
»t
) {

2238 
¡re_logiÿl
 +ğ
chunk_logiÿl
;

2239 
»t
 = 
	`süub_¿id56_·r™y_¡re
(
sùx
, 
süub_dev
, 
bg
,

2240 
m­
, 
¡re_logiÿl
);

2241 ià(
»t
)

2242 
out
;

2243 
Ãxt
;

2254 
»t
 = 
	`süub_sim¶e_mœrÜ
(
sùx
, 
bg
, 
m­
, 
logiÿl
, 
BTRFS_STRIPE_LEN
,

2255 
süub_dev
, 
physiÿl
, 1);

2256 ià(
»t
 < 0)

2257 
out
;

2258 
Ãxt
:

2259 
logiÿl
 +ğ
šüem’t
;

2260 
physiÿl
 +ğ
BTRFS_STRIPE_LEN
;

2261 
	`¥š_lock
(&
sùx
->
¡©_lock
);

2262 ià(
¡İ_loİ
)

2263 
sùx
->
¡©
.
Ï¡_physiÿl
 =

2264 
m­
->
¡res
[
¡re_šdex
].
physiÿl
 + 
dev_¡re_Ën
;

2266 
sùx
->
¡©
.
Ï¡_physiÿl
 = 
physiÿl
;

2267 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

2268 ià(
¡İ_loİ
)

2271 
out
:

2272 
»t2
 = 
	`æush_süub_¡res
(
sùx
);

2273 ià(!
»t
)

2274 
»t
 = 
»t2
;

2275 
	`bŒfs_»Ëa£_·th
(&
sùx
->
ex‹Á_·th
);

2276 
	`bŒfs_»Ëa£_·th
(&
sùx
->
csum_·th
);

2278 ià(
sùx
->
¿id56_d©a_¡res
) {

2279 
i
 = 0; i < 
	`Ä_d©a_¡res
(
m­
); i++)

2280 
	`»Ëa£_süub_¡re
(&
sùx
->
¿id56_d©a_¡res
[
i
]);

2281 
	`kä“
(
sùx
->
¿id56_d©a_¡res
);

2282 
sùx
->
¿id56_d©a_¡res
 = 
NULL
;

2285 ià(
sùx
->
is_dev_»¶aû
 && 
»t
 >= 0) {

2286 
»t2
;

2288 
»t2
 = 
	`sync_wr™e_poš‹r_fÜ_zÚed
(
sùx
,

2289 
chunk_logiÿl
 + 
off£t
,

2290 
m­
->
¡res
[
¡re_šdex
].
physiÿl
,

2291 
physiÿl_’d
);

2292 ià(
»t2
)

2293 
»t
 = 
»t2
;

2296  
»t
 < 0 ?„et : 0;

2297 
	}
}

2299 
nošlše_fÜ_¡ack
 
	$süub_chunk
(
süub_ùx
 *
sùx
,

2300 
bŒfs_block_group
 *
bg
,

2301 
bŒfs_deviû
 *
süub_dev
,

2302 
u64
 
dev_off£t
,

2303 
u64
 
dev_ex‹Á_Ën
)

2305 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

2306 
ex‹Á_m­_Œ“
 *
m­_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

2307 
m­_lookup
 *
m­
;

2308 
ex‹Á_m­
 *
em
;

2309 
i
;

2310 
»t
 = 0;

2312 
	`»ad_lock
(&
m­_Œ“
->
lock
);

2313 
em
 = 
	`lookup_ex‹Á_m­pšg
(
m­_Œ“
, 
bg
->
¡¬t
, bg->
Ëngth
);

2314 
	`»ad_uÆock
(&
m­_Œ“
->
lock
);

2316 ià(!
em
) {

2321 
	`¥š_lock
(&
bg
->
lock
);

2322 ià(!
	`‹¡_b™
(
BLOCK_GROUP_FLAG_REMOVED
, &
bg
->
ruÁime_æags
))

2323 
»t
 = -
EINVAL
;

2324 
	`¥š_uÆock
(&
bg
->
lock
);

2326  
»t
;

2328 ià(
em
->
¡¬t
 !ğ
bg
->start)

2329 
out
;

2330 ià(
em
->
Ën
 < 
dev_ex‹Á_Ën
)

2331 
out
;

2333 
m­
 = 
em
->
m­_lookup
;

2334 
i
 = 0; i < 
m­
->
num_¡res
; ++i) {

2335 ià(
m­
->
¡res
[
i
].
dev
->
bdev
 =ğ
süub_dev
->bdev &&

2336 
m­
->
¡res
[
i
].
physiÿl
 =ğ
dev_off£t
) {

2337 
»t
 = 
	`süub_¡re
(
sùx
, 
bg
, 
em
, 
süub_dev
, 
i
);

2338 ià(
»t
)

2339 
out
;

2342 
out
:

2343 
	`ä“_ex‹Á_m­
(
em
);

2345  
»t
;

2346 
	}
}

2348 
	$fšish_ex‹Á_wr™es_fÜ_zÚed
(
bŒfs_roÙ
 *
roÙ
,

2349 
bŒfs_block_group
 *
ÿche
)

2351 
bŒfs_fs_šfo
 *
fs_šfo
 = 
ÿche
->fs_info;

2352 
bŒfs_Œªs_hªdË
 *
Œªs
;

2354 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

2357 
	`bŒfs_wa™_block_group_»£rv©iÚs
(
ÿche
);

2358 
	`bŒfs_wa™_nocow_wr™”s
(
ÿche
);

2359 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
U64_MAX
, 
ÿche
->
¡¬t
, cache->
Ëngth
);

2361 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

2362 ià(
	`IS_ERR
(
Œªs
))

2363  
	`PTR_ERR
(
Œªs
);

2364  
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

2365 
	}
}

2367 
nošlše_fÜ_¡ack


2368 
	$süub_’um”©e_chunks
(
süub_ùx
 *
sùx
,

2369 
bŒfs_deviû
 *
süub_dev
, 
u64
 
¡¬t
, u64 
’d
)

2371 
bŒfs_dev_ex‹Á
 *
dev_ex‹Á
 = 
NULL
;

2372 
bŒfs_·th
 *
·th
;

2373 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

2374 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

2375 
u64
 
chunk_off£t
;

2376 
»t
 = 0;

2377 
ro_£t
;

2378 
¦Ù
;

2379 
ex‹Á_bufãr
 *
l
;

2380 
bŒfs_key
 
key
;

2381 
bŒfs_key
 
found_key
;

2382 
bŒfs_block_group
 *
ÿche
;

2383 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

2385 
·th
 = 
	`bŒfs_®loc_·th
();

2386 ià(!
·th
)

2387  -
ENOMEM
;

2389 
·th
->
»ada
 = 
READA_FORWARD
;

2390 
·th
->
£¬ch_comm™_roÙ
 = 1;

2391 
·th
->
sk_lockšg
 = 1;

2393 
key
.
objeùid
 = 
süub_dev
->
devid
;

2394 
key
.
off£t
 = 0ull;

2395 
key
.
ty³
 = 
BTRFS_DEV_EXTENT_KEY
;

2398 
u64
 
dev_ex‹Á_Ën
;

2400 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

2401 ià(
»t
 < 0)

2403 ià(
»t
 > 0) {

2404 ià(
·th
->
¦Ùs
[0] >=

2405 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0])) {

2406 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

2407 ià(
»t
 < 0)

2409 ià(
»t
 > 0) {

2410 
»t
 = 0;

2414 
»t
 = 0;

2418 
l
 = 
·th
->
nodes
[0];

2419 
¦Ù
 = 
·th
->
¦Ùs
[0];

2421 
	`bŒfs_™em_key_to_ıu
(
l
, &
found_key
, 
¦Ù
);

2423 ià(
found_key
.
objeùid
 !ğ
süub_dev
->
devid
)

2426 ià(
found_key
.
ty³
 !ğ
BTRFS_DEV_EXTENT_KEY
)

2429 ià(
found_key
.
off£t
 >ğ
’d
)

2432 ià(
found_key
.
off£t
 < 
key
.offset)

2435 
dev_ex‹Á
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
, 
bŒfs_dev_ex‹Á
);

2436 
dev_ex‹Á_Ën
 = 
	`bŒfs_dev_ex‹Á_Ëngth
(
l
, 
dev_ex‹Á
);

2438 ià(
found_key
.
off£t
 + 
dev_ex‹Á_Ën
 <ğ
¡¬t
)

2439 
sk
;

2441 
chunk_off£t
 = 
	`bŒfs_dev_ex‹Á_chunk_off£t
(
l
, 
dev_ex‹Á
);

2447 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
chunk_off£t
);

2451 ià(!
ÿche
)

2452 
sk
;

2454 
	`ASSERT
(
ÿche
->
¡¬t
 <ğ
chunk_off£t
);

2474 ià(
ÿche
->
¡¬t
 < 
chunk_off£t
) {

2475 
	`bŒfs_put_block_group
(
ÿche
);

2476 
sk
;

2479 ià(
sùx
->
is_dev_»¶aû
 && 
	`bŒfs_is_zÚed
(
fs_šfo
)) {

2480 ià(!
	`‹¡_b™
(
BLOCK_GROUP_FLAG_TO_COPY
, &
ÿche
->
ruÁime_æags
)) {

2481 
	`bŒfs_put_block_group
(
ÿche
);

2482 
sk
;

2494 
	`¥š_lock
(&
ÿche
->
lock
);

2495 ià(
	`‹¡_b™
(
BLOCK_GROUP_FLAG_REMOVED
, &
ÿche
->
ruÁime_æags
)) {

2496 
	`¥š_uÆock
(&
ÿche
->
lock
);

2497 
	`bŒfs_put_block_group
(
ÿche
);

2498 
sk
;

2500 
	`bŒfs_ä“ze_block_group
(
ÿche
);

2501 
	`¥š_uÆock
(&
ÿche
->
lock
);

2511 
	`süub_·u£_Ú
(
fs_šfo
);

2543 
»t
 = 
	`bŒfs_šc_block_group_ro
(
ÿche
, 
sùx
->
is_dev_»¶aû
);

2544 ià(!
»t
 && 
sùx
->
is_dev_»¶aû
) {

2545 
»t
 = 
	`fšish_ex‹Á_wr™es_fÜ_zÚed
(
roÙ
, 
ÿche
);

2546 ià(
»t
) {

2547 
	`bŒfs_dec_block_group_ro
(
ÿche
);

2548 
	`süub_·u£_off
(
fs_šfo
);

2549 
	`bŒfs_put_block_group
(
ÿche
);

2554 ià(
»t
 == 0) {

2555 
ro_£t
 = 1;

2556 } ià(
»t
 =ğ-
ENOSPC
 && !
sùx
->
is_dev_»¶aû
 &&

2557 !(
ÿche
->
æags
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
)) {

2571 
ro_£t
 = 0;

2572 } ià(
»t
 =ğ-
ETXTBSY
) {

2573 
	`bŒfs_w¬n
(
fs_šfo
,

2575 
ÿche
->
¡¬t
);

2576 
	`süub_·u£_off
(
fs_šfo
);

2577 
»t
 = 0;

2578 
sk_unä“ze
;

2580 
	`bŒfs_w¬n
(
fs_šfo
,

2581 "çed s‘tšg block grou°ro: %d", 
»t
);

2582 
	`bŒfs_unä“ze_block_group
(
ÿche
);

2583 
	`bŒfs_put_block_group
(
ÿche
);

2584 
	`süub_·u£_off
(
fs_šfo
);

2593 ià(
sùx
->
is_dev_»¶aû
) {

2594 
	`bŒfs_wa™_nocow_wr™”s
(
ÿche
);

2595 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
U64_MAX
, 
ÿche
->
¡¬t
,

2596 
ÿche
->
Ëngth
);

2599 
	`süub_·u£_off
(
fs_šfo
);

2600 
	`down_wr™e
(&
dev_»¶aû
->
rw£m
);

2601 
dev_»¶aû
->
cursÜ_right
 = 
found_key
.
off£t
 + 
dev_ex‹Á_Ën
;

2602 
dev_»¶aû
->
cursÜ_Ëá
 = 
found_key
.
off£t
;

2603 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 1;

2604 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

2606 
»t
 = 
	`süub_chunk
(
sùx
, 
ÿche
, 
süub_dev
, 
found_key
.
off£t
,

2607 
dev_ex‹Á_Ën
);

2608 ià(
sùx
->
is_dev_»¶aû
 &&

2609 !
	`bŒfs_fšish_block_group_to_cİy
(
dev_»¶aû
->
¤cdev
,

2610 
ÿche
, 
found_key
.
off£t
))

2611 
ro_£t
 = 0;

2613 
	`down_wr™e
(&
dev_»¶aû
->
rw£m
);

2614 
dev_»¶aû
->
cursÜ_Ëá
 = dev_»¶aû->
cursÜ_right
;

2615 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 1;

2616 
	`up_wr™e
(&
dev_»¶aû
->
rw£m
);

2618 ià(
ro_£t
)

2619 
	`bŒfs_dec_block_group_ro
(
ÿche
);

2628 
	`¥š_lock
(&
ÿche
->
lock
);

2629 ià(!
	`‹¡_b™
(
BLOCK_GROUP_FLAG_REMOVED
, &
ÿche
->
ruÁime_æags
) &&

2630 !
ÿche
->
ro
 && cache->
»£rved
 =ğ0 && cache->
u£d
 == 0) {

2631 
	`¥š_uÆock
(&
ÿche
->
lock
);

2632 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DISCARD_ASYNC
))

2633 
	`bŒfs_disÿrd_queue_wÜk
(&
fs_šfo
->
disÿrd_ùl
,

2634 
ÿche
);

2636 
	`bŒfs_m¬k_bg_unu£d
(
ÿche
);

2638 
	`¥š_uÆock
(&
ÿche
->
lock
);

2640 
sk_unä“ze
:

2641 
	`bŒfs_unä“ze_block_group
(
ÿche
);

2642 
	`bŒfs_put_block_group
(
ÿche
);

2643 ià(
»t
)

2645 ià(
sùx
->
is_dev_»¶aû
 &&

2646 
	`©omic64_»ad
(&
dev_»¶aû
->
num_wr™e_”rÜs
) > 0) {

2647 
»t
 = -
EIO
;

2650 ià(
sùx
->
¡©
.
m®loc_”rÜs
 > 0) {

2651 
»t
 = -
ENOMEM
;

2654 
sk
:

2655 
key
.
off£t
 = 
found_key
.off£ˆ+ 
dev_ex‹Á_Ën
;

2656 
	`bŒfs_»Ëa£_·th
(
·th
);

2659 
	`bŒfs_ä“_·th
(
·th
);

2661  
»t
;

2662 
	}
}

2664 
	$süub_Úe_su³r
(
süub_ùx
 *
sùx
, 
bŒfs_deviû
 *
dev
,

2665 
·ge
 *·ge, 
u64
 
physiÿl
, u64 
g’”©iÚ
)

2667 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

2668 
bio_vec
 
bvec
;

2669 
bio
 bio;

2670 
bŒfs_su³r_block
 *
sb
 = 
	`·ge_add»ss
(
·ge
);

2671 
»t
;

2673 
	`bio_š™
(&
bio
, 
dev
->
bdev
, &
bvec
, 1, 
REQ_OP_READ
);

2674 
bio
.
bi_™”
.
bi_£ùÜ
 = 
physiÿl
 >> 
SECTOR_SHIFT
;

2675 
	`__bio_add_·ge
(&
bio
, 
·ge
, 
BTRFS_SUPER_INFO_SIZE
, 0);

2676 
»t
 = 
	`subm™_bio_wa™
(&
bio
);

2677 
	`bio_unš™
(&
bio
);

2679 ià(
»t
 < 0)

2680  
»t
;

2681 
»t
 = 
	`bŒfs_check_su³r_csum
(
fs_šfo
, 
sb
);

2682 ià(
»t
 != 0) {

2683 
	`bŒfs_”r_¾
(
fs_šfo
,

2685 
physiÿl
, 
dev
->
devid
);

2686  -
EIO
;

2688 ià(
	`bŒfs_su³r_g’”©iÚ
(
sb
è!ğ
g’”©iÚ
) {

2689 
	`bŒfs_”r_¾
(
fs_šfo
,

2691 
physiÿl
, 
dev
->
devid
,

2692 
	`bŒfs_su³r_g’”©iÚ
(
sb
), 
g’”©iÚ
);

2693  -
EUCLEAN
;

2696  
	`bŒfs_v®id©e_su³r
(
fs_šfo
, 
sb
, -1);

2697 
	}
}

2699 
nošlše_fÜ_¡ack
 
	$süub_su³rs
(
süub_ùx
 *
sùx
,

2700 
bŒfs_deviû
 *
süub_dev
)

2702 
i
;

2703 
u64
 
by‹Ä
;

2704 
u64
 
g’
;

2705 
»t
 = 0;

2706 
·ge
 *page;

2707 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

2709 ià(
	`BTRFS_FS_ERROR
(
fs_šfo
))

2710  -
EROFS
;

2712 
·ge
 = 
	`®loc_·ge
(
GFP_KERNEL
);

2713 ià(!
·ge
) {

2714 
	`¥š_lock
(&
sùx
->
¡©_lock
);

2715 
sùx
->
¡©
.
m®loc_”rÜs
++;

2716 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

2717  -
ENOMEM
;

2721 ià(
süub_dev
->
fs_deviûs
 !ğ
fs_šfo
->fs_devices)

2722 
g’
 = 
süub_dev
->
g’”©iÚ
;

2724 
g’
 = 
fs_šfo
->
Ï¡_Œªs_comm™‹d
;

2726 
i
 = 0; i < 
BTRFS_SUPER_MIRROR_MAX
; i++) {

2727 
by‹Ä
 = 
	`bŒfs_sb_off£t
(
i
);

2728 ià(
by‹Ä
 + 
BTRFS_SUPER_INFO_SIZE
 >

2729 
süub_dev
->
comm™_tÙ®_by‹s
)

2731 ià(!
	`bŒfs_check_su³r_loÿtiÚ
(
süub_dev
, 
by‹Ä
))

2734 
»t
 = 
	`süub_Úe_su³r
(
sùx
, 
süub_dev
, 
·ge
, 
by‹Ä
, 
g’
);

2735 ià(
»t
) {

2736 
	`¥š_lock
(&
sùx
->
¡©_lock
);

2737 
sùx
->
¡©
.
su³r_”rÜs
++;

2738 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

2741 
	`__ä“_·ge
(
·ge
);

2743 
	}
}

2745 
	$süub_wÜk”s_put
(
bŒfs_fs_šfo
 *
fs_šfo
)

2747 ià(
	`»fcouÁ_dec_ªd_mu‹x_lock
(&
fs_šfo
->
süub_wÜk”s_»fút
,

2748 &
fs_šfo
->
süub_lock
)) {

2749 
wÜkqueue_¡ruù
 *
süub_wÜk”s
 = 
fs_šfo
->scrub_workers;

2751 
fs_šfo
->
süub_wÜk”s
 = 
NULL
;

2752 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

2754 ià(
süub_wÜk”s
)

2755 
	`de¡roy_wÜkqueue
(
süub_wÜk”s
);

2757 
	}
}

2762 
nošlše_fÜ_¡ack
 
	$süub_wÜk”s_g‘
(
bŒfs_fs_šfo
 *
fs_šfo
)

2764 
wÜkqueue_¡ruù
 *
süub_wÜk”s
 = 
NULL
;

2765 
æags
 = 
WQ_FREEZABLE
 | 
WQ_UNBOUND
;

2766 
max_aùive
 = 
fs_šfo
->
th»ad_poŞ_size
;

2767 
»t
 = -
ENOMEM
;

2769 ià(
	`»fcouÁ_šc_nÙ_z”o
(&
fs_šfo
->
süub_wÜk”s_»fút
))

2772 
süub_wÜk”s
 = 
	`®loc_wÜkqueue
("bŒfs-süub", 
æags
, 
max_aùive
);

2773 ià(!
süub_wÜk”s
)

2774  -
ENOMEM
;

2776 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

2777 ià(
	`»fcouÁ_»ad
(&
fs_šfo
->
süub_wÜk”s_»fút
) == 0) {

2778 
	`ASSERT
(
fs_šfo
->
süub_wÜk”s
 =ğ
NULL
);

2779 
fs_šfo
->
süub_wÜk”s
 = scrub_workers;

2780 
	`»fcouÁ_£t
(&
fs_šfo
->
süub_wÜk”s_»fút
, 1);

2781 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

2785 
	`»fcouÁ_šc
(&
fs_šfo
->
süub_wÜk”s_»fút
);

2786 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

2788 
»t
 = 0;

2790 
	`de¡roy_wÜkqueue
(
süub_wÜk”s
);

2791  
»t
;

2792 
	}
}

2794 
	$bŒfs_süub_dev
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
devid
, u64 
¡¬t
,

2795 
u64
 
’d
, 
bŒfs_süub_´og»ss
 *
´og»ss
,

2796 
»adÚly
, 
is_dev_»¶aû
)

2798 
bŒfs_dev_lookup_¬gs
 
¬gs
 = { .
devid
 = devid };

2799 
süub_ùx
 *
sùx
;

2800 
»t
;

2801 
bŒfs_deviû
 *
dev
;

2802 
nofs_æag
;

2803 
boŞ
 
Ãed_comm™
 = 
çl£
;

2805 ià(
	`bŒfs_fs_şosšg
(
fs_šfo
))

2806  -
EAGAIN
;

2809 
	`ASSERT
(
fs_šfo
->
nodesize
 <ğ
BTRFS_STRIPE_LEN
);

2816 
	`ASSERT
(
fs_šfo
->
nodesize
 <=

2817 
SCRUB_MAX_SECTORS_PER_BLOCK
 << 
fs_šfo
->
£ùÜsize_b™s
);

2820 
sùx
 = 
	`süub_£tup_ùx
(
fs_šfo
, 
is_dev_»¶aû
);

2821 ià(
	`IS_ERR
(
sùx
))

2822  
	`PTR_ERR
(
sùx
);

2824 
»t
 = 
	`süub_wÜk”s_g‘
(
fs_šfo
);

2825 ià(
»t
)

2826 
out_ä“_ùx
;

2828 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2829 
dev
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, &
¬gs
);

2830 ià(!
dev
 || (
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
, &dev->
dev_¡©e
) &&

2831 !
is_dev_»¶aû
)) {

2832 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2833 
»t
 = -
ENODEV
;

2834 
out
;

2837 ià(!
is_dev_»¶aû
 && !
»adÚly
 &&

2838 !
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
dev
->
dev_¡©e
)) {

2839 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2840 
	`bŒfs_”r_š_rcu
(
fs_šfo
,

2842 
devid
, 
	`bŒfs_dev_Çme
(
dev
));

2843 
»t
 = -
EROFS
;

2844 
out
;

2847 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

2848 ià(!
	`‹¡_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
dev
->
dev_¡©e
) ||

2849 
	`‹¡_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
dev
->
dev_¡©e
)) {

2850 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

2851 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2852 
»t
 = -
EIO
;

2853 
out
;

2856 
	`down_»ad
(&
fs_šfo
->
dev_»¶aû
.
rw£m
);

2857 ià(
dev
->
süub_ùx
 ||

2858 (!
is_dev_»¶aû
 &&

2859 
	`bŒfs_dev_»¶aû_is_Úgošg
(&
fs_šfo
->
dev_»¶aû
))) {

2860 
	`up_»ad
(&
fs_šfo
->
dev_»¶aû
.
rw£m
);

2861 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

2862 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2863 
»t
 = -
EINPROGRESS
;

2864 
out
;

2866 
	`up_»ad
(&
fs_šfo
->
dev_»¶aû
.
rw£m
);

2868 
sùx
->
»adÚly
 =„eadonly;

2869 
dev
->
süub_ùx
 = 
sùx
;

2870 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2876 
	`__süub_blocked_if_Ãeded
(
fs_šfo
);

2877 
	`©omic_šc
(&
fs_šfo
->
süubs_ruÂšg
);

2878 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

2889 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

2890 ià(!
is_dev_»¶aû
) {

2891 
u64
 
Şd_su³r_”rÜs
;

2893 
	`¥š_lock
(&
sùx
->
¡©_lock
);

2894 
Şd_su³r_”rÜs
 = 
sùx
->
¡©
.
su³r_”rÜs
;

2895 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

2897 
	`bŒfs_šfo
(
fs_šfo
, "süub: s¹ed oÀdevid %Îu", 
devid
);

2902 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2903 
»t
 = 
	`süub_su³rs
(
sùx
, 
dev
);

2904 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2906 
	`¥š_lock
(&
sùx
->
¡©_lock
);

2912 ià(
sùx
->
¡©
.
su³r_”rÜs
 > 
Şd_su³r_”rÜs
 && !sùx->
»adÚly
)

2913 
Ãed_comm™
 = 
Œue
;

2914 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

2917 ià(!
»t
)

2918 
»t
 = 
	`süub_’um”©e_chunks
(
sùx
, 
dev
, 
¡¬t
, 
’d
);

2919 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

2921 
	`©omic_dec
(&
fs_šfo
->
süubs_ruÂšg
);

2922 
	`wake_up
(&
fs_šfo
->
süub_·u£_wa™
);

2924 ià(
´og»ss
)

2925 
	`memıy
(
´og»ss
, &
sùx
->
¡©
, (*progress));

2927 ià(!
is_dev_»¶aû
)

2928 
	`bŒfs_šfo
(
fs_šfo
, "scrub: %s on devid %llu with status: %d",

2929 
»t
 ? "nÙ fšished" : "fšished", 
devid
,„et);

2931 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

2932 
dev
->
süub_ùx
 = 
NULL
;

2933 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

2935 
	`süub_wÜk”s_put
(
fs_šfo
);

2936 
	`süub_put_ùx
(
sùx
);

2942 ià(
Ãed_comm™
) {

2943 
bŒfs_Œªs_hªdË
 *
Œªs
;

2945 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
fs_šfo
->
Œ“_roÙ
, 0);

2946 ià(
	`IS_ERR
(
Œªs
)) {

2947 
»t
 = 
	`PTR_ERR
(
Œªs
);

2948 
	`bŒfs_”r
(
fs_šfo
,

2949 "süub: faedØ¡¬ˆŒª§ùiÚØfix su³¸blockƒ¼Üs: %d", 
»t
);

2950  
»t
;

2952 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

2953 ià(
»t
 < 0)

2954 
	`bŒfs_”r
(
fs_šfo
,

2955 "süub: faedØcomm™¿n§ùiÚØfix su³¸blockƒ¼Üs: %d", 
»t
);

2957  
»t
;

2958 
out
:

2959 
	`süub_wÜk”s_put
(
fs_šfo
);

2960 
out_ä“_ùx
:

2961 
	`süub_ä“_ùx
(
sùx
);

2963  
»t
;

2964 
	}
}

2966 
	$bŒfs_süub_·u£
(
bŒfs_fs_šfo
 *
fs_šfo
)

2968 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

2969 
	`©omic_šc
(&
fs_šfo
->
süub_·u£_»q
);

2970 
	`©omic_»ad
(&
fs_šfo
->
süubs_·u£d
) !=

2971 
	`©omic_»ad
(&
fs_šfo
->
süubs_ruÂšg
)) {

2972 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

2973 
	`wa™_ev’t
(
fs_šfo
->
süub_·u£_wa™
,

2974 
	`©omic_»ad
(&
fs_šfo
->
süubs_·u£d
) ==

2975 
	`©omic_»ad
(&
fs_šfo
->
süubs_ruÂšg
));

2976 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

2978 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

2979 
	}
}

2981 
	$bŒfs_süub_cÚtšue
(
bŒfs_fs_šfo
 *
fs_šfo
)

2983 
	`©omic_dec
(&
fs_šfo
->
süub_·u£_»q
);

2984 
	`wake_up
(&
fs_šfo
->
süub_·u£_wa™
);

2985 
	}
}

2987 
	$bŒfs_süub_ÿnûl
(
bŒfs_fs_šfo
 *
fs_šfo
)

2989 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

2990 ià(!
	`©omic_»ad
(&
fs_šfo
->
süubs_ruÂšg
)) {

2991 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

2992  -
ENOTCONN
;

2995 
	`©omic_šc
(&
fs_šfo
->
süub_ÿnûl_»q
);

2996 
	`©omic_»ad
(&
fs_šfo
->
süubs_ruÂšg
)) {

2997 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

2998 
	`wa™_ev’t
(
fs_šfo
->
süub_·u£_wa™
,

2999 
	`©omic_»ad
(&
fs_šfo
->
süubs_ruÂšg
) == 0);

3000 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

3002 
	`©omic_dec
(&
fs_šfo
->
süub_ÿnûl_»q
);

3003 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

3006 
	}
}

3008 
	$bŒfs_süub_ÿnûl_dev
(
bŒfs_deviû
 *
dev
)

3010 
bŒfs_fs_šfo
 *
fs_šfo
 = 
dev
->fs_info;

3011 
süub_ùx
 *
sùx
;

3013 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

3014 
sùx
 = 
dev
->
süub_ùx
;

3015 ià(!
sùx
) {

3016 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

3017  -
ENOTCONN
;

3019 
	`©omic_šc
(&
sùx
->
ÿnûl_»q
);

3020 
dev
->
süub_ùx
) {

3021 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

3022 
	`wa™_ev’t
(
fs_šfo
->
süub_·u£_wa™
,

3023 
dev
->
süub_ùx
 =ğ
NULL
);

3024 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

3026 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

3029 
	}
}

3031 
	$bŒfs_süub_´og»ss
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
devid
,

3032 
bŒfs_süub_´og»ss
 *
´og»ss
)

3034 
bŒfs_dev_lookup_¬gs
 
¬gs
 = { .
devid
 = devid };

3035 
bŒfs_deviû
 *
dev
;

3036 
süub_ùx
 *
sùx
 = 
NULL
;

3038 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

3039 
dev
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, &
¬gs
);

3040 ià(
dev
)

3041 
sùx
 = 
dev
->
süub_ùx
;

3042 ià(
sùx
)

3043 
	`memıy
(
´og»ss
, &
sùx
->
¡©
, (*progress));

3044 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

3046  
dev
 ? (
sùx
 ? 0 : -
ENOTCONN
è: -
ENODEV
;

3047 
	}
}

	@scrub.h

3 #iâdeà
BTRFS_SCRUB_H


4 
	#BTRFS_SCRUB_H


	)

6 
bŒfs_süub_dev
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
devid
, u64 
¡¬t
,

7 
u64
 
’d
, 
bŒfs_süub_´og»ss
 *
´og»ss
,

8 
»adÚly
, 
is_dev_»¶aû
);

9 
bŒfs_süub_·u£
(
bŒfs_fs_šfo
 *
fs_šfo
);

10 
bŒfs_süub_cÚtšue
(
bŒfs_fs_šfo
 *
fs_šfo
);

11 
bŒfs_süub_ÿnûl
(
bŒfs_fs_šfo
 *
šfo
);

12 
bŒfs_süub_ÿnûl_dev
(
bŒfs_deviû
 *
dev
);

13 
bŒfs_süub_´og»ss
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
devid
,

14 
bŒfs_süub_´og»ss
 *
´og»ss
);

	@send.c

6 
	~<lšux/b£¬ch.h
>

7 
	~<lšux/fs.h
>

8 
	~<lšux/fe.h
>

9 
	~<lšux/sÜt.h
>

10 
	~<lšux/mouÁ.h
>

11 
	~<lšux/x©Œ.h
>

12 
	~<lšux/posix_aş_x©Œ.h
>

13 
	~<lšux/¿dix-Œ“.h
>

14 
	~<lšux/vm®loc.h
>

15 
	~<lšux/¡ršg.h
>

16 
	~<lšux/com·t.h
>

17 
	~<lšux/üc32c.h
>

18 
	~<lšux/fsv”™y.h
>

20 
	~"£nd.h
"

21 
	~"ù»e.h
"

22 
	~"back»f.h
"

23 
	~"lockšg.h
"

24 
	~"disk-io.h
"

25 
	~"bŒfs_šode.h
"

26 
	~"Œª§ùiÚ.h
"

27 
	~"com´essiÚ.h
"

28 
	~"x©Œ.h
"

29 
	~"´št-Œ“.h
"

30 
	~"acûssÜs.h
"

31 
	~"dœ-™em.h
"

32 
	~"fe-™em.h
"

33 
	~"ioùl.h
"

34 
	~"v”™y.h
"

35 
	~"Ìu_ÿche.h
"

43 
	#SEND_MAX_EXTENT_REFS
 1024

	)

52 
	sfs_·th
 {

55 *
	m¡¬t
;

56 *
	m’d
;

58 *
	mbuf
;

59 
	mbuf_Ën
:15;

60 
	m»v”£d
:1;

61 
	mšlše_buf
[];

68 
	m·d
[256];

71 
	#FS_PATH_INLINE_SIZE
 \

72 ((
fs_·th
è- 
	`off£tof
(fs_·th, 
šlše_buf
))

	)

76 
	sşÚe_roÙ
 {

77 
bŒfs_roÙ
 *
	mroÙ
;

78 
u64
 
	mšo
;

79 
u64
 
	moff£t
;

80 
u64
 
	mnum_by‹s
;

81 
boŞ
 
	mfound_»f
;

84 
	#SEND_MAX_NAME_CACHE_SIZE
 256

	)

95 
	#SEND_MAX_BACKREF_CACHE_ROOTS
 17

	)

102 
	#SEND_MAX_BACKREF_CACHE_SIZE
 128

	)

110 
	sback»f_ÿche_’Œy
 {

111 
bŒfs_Ìu_ÿche_’Œy
 
	m’Œy
;

112 
u64
 
	mroÙ_ids
[
SEND_MAX_BACKREF_CACHE_ROOTS
];

114 
	mnum_roÙs
;

118 
¡©ic_as£¹
(
off£tof
(
back»f_ÿche_’Œy
, 
’Œy
) == 0);

126 
	#SEND_MAX_DIR_CREATED_CACHE_SIZE
 64

	)

134 
	#SEND_MAX_DIR_UTIMES_CACHE_SIZE
 64

	)

136 
	s£nd_ùx
 {

137 
fe
 *
	m£nd_fp
;

138 
loff_t
 
	m£nd_off
;

139 *
	m£nd_buf
;

140 
u32
 
	m£nd_size
;

141 
u32
 
	m£nd_max_size
;

146 
boŞ
 
	mput_d©a
;

147 
·ge
 **
	m£nd_buf_·ges
;

148 
u64
 
	mæags
;

150 
u32
 
	m´Ùo
;

152 
bŒfs_roÙ
 *
	m£nd_roÙ
;

153 
bŒfs_roÙ
 *
	m·»Á_roÙ
;

154 
şÚe_roÙ
 *
	mşÚe_roÙs
;

155 
	mşÚe_roÙs_út
;

158 
bŒfs_·th
 *
	mËá_·th
;

159 
bŒfs_·th
 *
	mright_·th
;

160 
bŒfs_key
 *
	mcmp_key
;

169 
u64
 
	mÏ¡_»loc_Œªs
;

175 
u64
 
	mcur_šo
;

176 
u64
 
	mcur_šode_g’
;

177 
u64
 
	mcur_šode_size
;

178 
u64
 
	mcur_šode_mode
;

179 
u64
 
	mcur_šode_rdev
;

180 
u64
 
	mcur_šode_Ï¡_ex‹Á
;

181 
u64
 
	mcur_šode_Ãxt_wr™e_off£t
;

182 
boŞ
 
	mcur_šode_Ãw
;

183 
boŞ
 
	mcur_šode_Ãw_g’
;

184 
boŞ
 
	mcur_šode_d–‘ed
;

185 
boŞ
 
	mignÜe_cur_šode
;

186 
boŞ
 
	mcur_šode_Ãeds_v”™y
;

187 *
	mv”™y_desütÜ
;

189 
u64
 
	m£nd_´og»ss
;

191 
li¡_h—d
 
	mÃw_»fs
;

192 
li¡_h—d
 
	md–‘ed_»fs
;

194 
bŒfs_Ìu_ÿche
 
	mÇme_ÿche
;

200 
šode
 *
	mcur_šode
;

201 
fe_¿_¡©e
 
	m¿
;

202 
u64
 
	m·ge_ÿche_ş—r_¡¬t
;

203 
boŞ
 
	mş—n_·ge_ÿche
;

250 
rb_roÙ
 
	m³ndšg_dœ_moves
;

257 
rb_roÙ
 
	mwa™šg_dœ_moves
;

298 
rb_roÙ
 
	mÜphª_dœs
;

300 
rb_roÙ
 
	mrbŒ“_Ãw_»fs
;

301 
rb_roÙ
 
	mrbŒ“_d–‘ed_»fs
;

303 
bŒfs_Ìu_ÿche
 
	mback»f_ÿche
;

304 
u64
 
	mback»f_ÿche_Ï¡_»loc_Œªs
;

306 
bŒfs_Ìu_ÿche
 
	mdœ_ü—‹d_ÿche
;

307 
bŒfs_Ìu_ÿche
 
	mdœ_utimes_ÿche
;

310 
	s³ndšg_dœ_move
 {

311 
rb_node
 
	mnode
;

312 
li¡_h—d
 
	mli¡
;

313 
u64
 
	m·»Á_šo
;

314 
u64
 
	mšo
;

315 
u64
 
	mg’
;

316 
li¡_h—d
 
	mupd©e_»fs
;

319 
	swa™šg_dœ_move
 {

320 
rb_node
 
	mnode
;

321 
u64
 
	mšo
;

327 
u64
 
	mrmdœ_šo
;

328 
u64
 
	mrmdœ_g’
;

329 
boŞ
 
	mÜphªized
;

332 
	sÜphª_dœ_šfo
 {

333 
rb_node
 
	mnode
;

334 
u64
 
	mšo
;

335 
u64
 
	mg’
;

336 
u64
 
	mÏ¡_dœ_šdex_off£t
;

337 
u64
 
	mdœ_high_£q_šo
;

340 
	sÇme_ÿche_’Œy
 {

345 
bŒfs_Ìu_ÿche_’Œy
 
	m’Œy
;

346 
u64
 
	m·»Á_šo
;

347 
u64
 
	m·»Á_g’
;

348 
	m»t
;

349 
	mÃed_Ï‹r_upd©e
;

350 
	mÇme_Ën
;

351 
	mÇme
[];

355 
¡©ic_as£¹
(
off£tof
(
Çme_ÿche_’Œy
, 
’Œy
) == 0);

357 
	#ADVANCE
 1

	)

358 
	#ADVANCE_ONLY_NEXT
 -1

	)

360 
	ebŒfs_com·»_Œ“_»suÉ
 {

361 
	mBTRFS_COMPARE_TREE_NEW
,

362 
	mBTRFS_COMPARE_TREE_DELETED
,

363 
	mBTRFS_COMPARE_TREE_CHANGED
,

364 
	mBTRFS_COMPARE_TREE_SAME
,

367 
__cŞd


368 
	$šcÚsi¡’t_¢­shÙ_”rÜ
(
£nd_ùx
 *
sùx
,

369 
bŒfs_com·»_Œ“_»suÉ
 
»suÉ
,

370 cÚ¡ *
wh©
)

372 cÚ¡ *
»suÉ_¡ršg
;

374 
»suÉ
) {

375 
BTRFS_COMPARE_TREE_NEW
:

376 
»suÉ_¡ršg
 = "new";

378 
BTRFS_COMPARE_TREE_DELETED
:

379 
»suÉ_¡ršg
 = "deleted";

381 
BTRFS_COMPARE_TREE_CHANGED
:

382 
»suÉ_¡ršg
 = "updated";

384 
BTRFS_COMPARE_TREE_SAME
:

385 
	`ASSERT
(0);

386 
»suÉ_¡ršg
 = "unchanged";

389 
	`ASSERT
(0);

390 
»suÉ_¡ršg
 = "unexpected";

393 
	`bŒfs_”r
(
sùx
->
£nd_roÙ
->
fs_šfo
,

395 
»suÉ_¡ršg
, 
wh©
, 
sùx
->
cmp_key
->
objeùid
,

396 
sùx
->
£nd_roÙ
->
roÙ_key
.
objeùid
,

397 (
sùx
->
·»Á_roÙ
 ?

398 
sùx
->
·»Á_roÙ
->
roÙ_key
.
objeùid
 : 0));

399 
	}
}

401 
__maybe_unu£d


402 
boŞ
 
	$´Ùo_cmd_ok
(cÚ¡ 
£nd_ùx
 *
sùx
, 
cmd
)

404 
sùx
->
´Ùo
) {

405 1:  
cmd
 <ğ
BTRFS_SEND_C_MAX_V1
;

406 2:  
cmd
 <ğ
BTRFS_SEND_C_MAX_V2
;

407 3:  
cmd
 <ğ
BTRFS_SEND_C_MAX_V3
;

408 :  
çl£
;

410 
	}
}

412 
is_wa™šg_fÜ_move
(
£nd_ùx
 *
sùx
, 
u64
 
šo
);

414 
wa™šg_dœ_move
 *

415 
g‘_wa™šg_dœ_move
(
£nd_ùx
 *
sùx
, 
u64
 
šo
);

417 
is_wa™šg_fÜ_rm
(
£nd_ùx
 *
sùx
, 
u64
 
dœ_šo
, u64 
g’
);

419 
	$Ãed_£nd_hŞe
(
£nd_ùx
 *
sùx
)

421  (
sùx
->
·»Á_roÙ
 && !sùx->
cur_šode_Ãw
 &&

422 !
sùx
->
cur_šode_Ãw_g’
 && !sùx->
cur_šode_d–‘ed
 &&

423 
	`S_ISREG
(
sùx
->
cur_šode_mode
));

424 
	}
}

426 
	$fs_·th_»£t
(
fs_·th
 *
p
)

428 ià(
p
->
»v”£d
) {

429 
p
->
¡¬t
 =…->
buf
 +…->
buf_Ën
 - 1;

430 
p
->
’d
 =…->
¡¬t
;

431 *
p
->
¡¬t
 = 0;

433 
p
->
¡¬t
 =…->
buf
;

434 
p
->
’d
 =…->
¡¬t
;

435 *
p
->
¡¬t
 = 0;

437 
	}
}

439 
fs_·th
 *
	$fs_·th_®loc
()

441 
fs_·th
 *
p
;

443 
p
 = 
	`km®loc
((*p), 
GFP_KERNEL
);

444 ià(!
p
)

445  
NULL
;

446 
p
->
»v”£d
 = 0;

447 
p
->
buf
 =…->
šlše_buf
;

448 
p
->
buf_Ën
 = 
FS_PATH_INLINE_SIZE
;

449 
	`fs_·th_»£t
(
p
);

450  
p
;

451 
	}
}

453 
fs_·th
 *
	$fs_·th_®loc_»v”£d
()

455 
fs_·th
 *
p
;

457 
p
 = 
	`fs_·th_®loc
();

458 ià(!
p
)

459  
NULL
;

460 
p
->
»v”£d
 = 1;

461 
	`fs_·th_»£t
(
p
);

462  
p
;

463 
	}
}

465 
	$fs_·th_ä“
(
fs_·th
 *
p
)

467 ià(!
p
)

469 ià(
p
->
buf
 !ğp->
šlše_buf
)

470 
	`kä“
(
p
->
buf
);

471 
	`kä“
(
p
);

472 
	}
}

474 
	$fs_·th_Ën
(
fs_·th
 *
p
)

476  
p
->
’d
 -…->
¡¬t
;

477 
	}
}

479 
	$fs_·th_’su»_buf
(
fs_·th
 *
p
, 
Ën
)

481 *
tmp_buf
;

482 
·th_Ën
;

483 
Şd_buf_Ën
;

485 
Ën
++;

487 ià(
p
->
buf_Ën
 >ğ
Ën
)

490 ià(
Ën
 > 
PATH_MAX
) {

491 
	`WARN_ON
(1);

492  -
ENOMEM
;

495 
·th_Ën
 = 
p
->
’d
 -…->
¡¬t
;

496 
Şd_buf_Ën
 = 
p
->
buf_Ën
;

502 
Ën
 = 
	`km®loc_size_roundup
(len);

506 ià(
p
->
buf
 =ğp->
šlše_buf
) {

507 
tmp_buf
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

508 ià(
tmp_buf
)

509 
	`memıy
(
tmp_buf
, 
p
->
buf
, 
Şd_buf_Ën
);

511 
tmp_buf
 = 
	`k»®loc
(
p
->
buf
, 
Ën
, 
GFP_KERNEL
);

513 ià(!
tmp_buf
)

514  -
ENOMEM
;

515 
p
->
buf
 = 
tmp_buf
;

516 
p
->
buf_Ën
 = 
Ën
;

518 ià(
p
->
»v”£d
) {

519 
tmp_buf
 = 
p
->
buf
 + 
Şd_buf_Ën
 - 
·th_Ën
 - 1;

520 
p
->
’d
 =…->
buf
 +…->
buf_Ën
 - 1;

521 
p
->
¡¬t
 =…->
’d
 - 
·th_Ën
;

522 
	`memmove
(
p
->
¡¬t
, 
tmp_buf
, 
·th_Ën
 + 1);

524 
p
->
¡¬t
 =…->
buf
;

525 
p
->
’d
 =…->
¡¬t
 + 
·th_Ën
;

528 
	}
}

530 
	$fs_·th_´•¬e_fÜ_add
(
fs_·th
 *
p
, 
Çme_Ën
,

531 **
´•¬ed
)

533 
»t
;

534 
Ãw_Ën
;

536 
Ãw_Ën
 = 
p
->
’d
 -…->
¡¬t
 + 
Çme_Ën
;

537 ià(
p
->
¡¬t
 !ğp->
’d
)

538 
Ãw_Ën
++;

539 
»t
 = 
	`fs_·th_’su»_buf
(
p
, 
Ãw_Ën
);

540 ià(
»t
 < 0)

541 
out
;

543 ià(
p
->
»v”£d
) {

544 ià(
p
->
¡¬t
 !ğp->
’d
)

545 *--
p
->
¡¬t
 = '/';

546 
p
->
¡¬t
 -ğ
Çme_Ën
;

547 *
´•¬ed
 = 
p
->
¡¬t
;

549 ià(
p
->
¡¬t
 !ğp->
’d
)

550 *
p
->
’d
++ = '/';

551 *
´•¬ed
 = 
p
->
’d
;

552 
p
->
’d
 +ğ
Çme_Ën
;

553 *
p
->
’d
 = 0;

556 
out
:

557  
»t
;

558 
	}
}

560 
	$fs_·th_add
(
fs_·th
 *
p
, cÚ¡ *
Çme
, 
Çme_Ën
)

562 
»t
;

563 *
´•¬ed
;

565 
»t
 = 
	`fs_·th_´•¬e_fÜ_add
(
p
, 
Çme_Ën
, &
´•¬ed
);

566 ià(
»t
 < 0)

567 
out
;

568 
	`memıy
(
´•¬ed
, 
Çme
, 
Çme_Ën
);

570 
out
:

571  
»t
;

572 
	}
}

574 
	$fs_·th_add_·th
(
fs_·th
 *
p
, fs_·th *
p2
)

576 
»t
;

577 *
´•¬ed
;

579 
»t
 = 
	`fs_·th_´•¬e_fÜ_add
(
p
, 
p2
->
’d
 -…2->
¡¬t
, &
´•¬ed
);

580 ià(
»t
 < 0)

581 
out
;

582 
	`memıy
(
´•¬ed
, 
p2
->
¡¬t
,…2->
’d
 -…2->start);

584 
out
:

585  
»t
;

586 
	}
}

588 
	$fs_·th_add_äom_ex‹Á_bufãr
(
fs_·th
 *
p
,

589 
ex‹Á_bufãr
 *
eb
,

590 
off
, 
Ën
)

592 
»t
;

593 *
´•¬ed
;

595 
»t
 = 
	`fs_·th_´•¬e_fÜ_add
(
p
, 
Ën
, &
´•¬ed
);

596 ià(
»t
 < 0)

597 
out
;

599 
	`»ad_ex‹Á_bufãr
(
eb
, 
´•¬ed
, 
off
, 
Ën
);

601 
out
:

602  
»t
;

603 
	}
}

605 
	$fs_·th_cİy
(
fs_·th
 *
p
, fs_·th *
äom
)

607 
p
->
»v”£d
 = 
äom
->reversed;

608 
	`fs_·th_»£t
(
p
);

610  
	`fs_·th_add_·th
(
p
, 
äom
);

611 
	}
}

613 
	$fs_·th_uÄev”£
(
fs_·th
 *
p
)

615 *
tmp
;

616 
Ën
;

618 ià(!
p
->
»v”£d
)

621 
tmp
 = 
p
->
¡¬t
;

622 
Ën
 = 
p
->
’d
 -…->
¡¬t
;

623 
p
->
¡¬t
 =…->
buf
;

624 
p
->
’d
 =…->
¡¬t
 + 
Ën
;

625 
	`memmove
(
p
->
¡¬t
, 
tmp
, 
Ën
 + 1);

626 
p
->
»v”£d
 = 0;

627 
	}
}

629 
bŒfs_·th
 *
	$®loc_·th_fÜ_£nd
()

631 
bŒfs_·th
 *
·th
;

633 
·th
 = 
	`bŒfs_®loc_·th
();

634 ià(!
·th
)

635  
NULL
;

636 
·th
->
£¬ch_comm™_roÙ
 = 1;

637 
·th
->
sk_lockšg
 = 1;

638 
·th
->
Ãed_comm™_£m
 = 1;

639  
·th
;

640 
	}
}

642 
	$wr™e_buf
(
fe
 *
fp
, cÚ¡ *
buf
, 
u32
 
Ën
, 
loff_t
 *
off
)

644 
»t
;

645 
u32
 
pos
 = 0;

647 
pos
 < 
Ën
) {

648 
»t
 = 
	`k”Ãl_wr™e
(
fp
, 
buf
 + 
pos
, 
Ën
 -…os, 
off
);

649 ià(
»t
 < 0)

650  
»t
;

651 ià(
»t
 == 0)

652  -
EIO
;

653 
pos
 +ğ
»t
;

657 
	}
}

659 
	$v_put
(
£nd_ùx
 *
sùx
, 
u16
 
©Œ
, cÚ¡ *
d©a
, 
Ën
)

661 
bŒfs_v_h—d”
 *
hdr
;

662 
tÙ®_Ën
 = (*
hdr
è+ 
Ën
;

663 
Ëá
 = 
sùx
->
£nd_max_size
 - sùx->
£nd_size
;

665 ià(
	`WARN_ON_ONCE
(
sùx
->
put_d©a
))

666  -
EINVAL
;

668 ià(
	`uÆik–y
(
Ëá
 < 
tÙ®_Ën
))

669  -
EOVERFLOW
;

671 
hdr
 = (
bŒfs_v_h—d”
 *è(
sùx
->
£nd_buf
 + sùx->
£nd_size
);

672 
	`put_uÇligÃd_Ë16
(
©Œ
, &
hdr
->
v_ty³
);

673 
	`put_uÇligÃd_Ë16
(
Ën
, &
hdr
->
v_Ën
);

674 
	`memıy
(
hdr
 + 1, 
d©a
, 
Ën
);

675 
sùx
->
£nd_size
 +ğ
tÙ®_Ën
;

678 
	}
}

680 
	#TLV_PUT_DEFINE_INT
(
b™s
) \

681 
v_put_u
##
	`b™s
(
£nd_ùx
 *
sùx
, \

682 
u
##
b™s
 
©Œ
, u##b™ 
v®ue
) \

684 
__Ë
##
b™s
 
__tmp
 = 
ıu_to_Ë
##
	`b™s
(
v®ue
); \

685  
	`v_put
(
sùx
, 
©Œ
, &
__tmp
, (__tmp)); \

686 }

	)

688 
	$TLV_PUT_DEFINE_INT
(8)

689 
	$TLV_PUT_DEFINE_INT
(32)

690 
	$TLV_PUT_DEFINE_INT
(64)

692 
	$v_put_¡ršg
(
£nd_ùx
 *
sùx
, 
u16
 
©Œ
,

693 cÚ¡ *
¡r
, 
Ën
)

695 ià(
Ën
 == -1)

696 
Ën
 = 
	`¡¾’
(
¡r
);

697  
	`v_put
(
sùx
, 
©Œ
, 
¡r
, 
Ën
);

698 
	}
}

700 
	$v_put_uuid
(
£nd_ùx
 *
sùx
, 
u16
 
©Œ
,

701 cÚ¡ 
u8
 *
uuid
)

703  
	`v_put
(
sùx
, 
©Œ
, 
uuid
, 
BTRFS_UUID_SIZE
);

704 
	}
}

706 
	$v_put_bŒfs_time¥ec
(
£nd_ùx
 *
sùx
, 
u16
 
©Œ
,

707 
ex‹Á_bufãr
 *
eb
,

708 
bŒfs_time¥ec
 *
ts
)

710 
bŒfs_time¥ec
 
bts
;

711 
	`»ad_ex‹Á_bufãr
(
eb
, &
bts
, ()
ts
, (bts));

712  
	`v_put
(
sùx
, 
©Œ
, &
bts
, (bts));

713 
	}
}

716 
	#TLV_PUT
(
sùx
, 
©Œty³
, 
d©a
, 
©ŒËn
) \

718 
»t
 = 
	`v_put
(
sùx
, 
©Œty³
, 
d©a
, 
©ŒËn
); \

719 ià(
»t
 < 0) \

720 
v_put_çu»
; \

721 } 0)

	)

723 
	#TLV_PUT_INT
(
sùx
, 
©Œty³
, 
b™s
, 
v®ue
) \

725 
»t
 = 
v_put_u
##
	`b™s
(
sùx
, 
©Œty³
, 
v®ue
); \

726 ià(
»t
 < 0) \

727 
v_put_çu»
; \

728 } 0)

	)

730 
	#TLV_PUT_U8
(
sùx
, 
©Œty³
, 
d©a
è
	`TLV_PUT_INT
(sùx,‡‰¹y³, 8, d©a)

	)

731 
	#TLV_PUT_U16
(
sùx
, 
©Œty³
, 
d©a
è
	`TLV_PUT_INT
(sùx,‡‰¹y³, 16, d©a)

	)

732 
	#TLV_PUT_U32
(
sùx
, 
©Œty³
, 
d©a
è
	`TLV_PUT_INT
(sùx,‡‰¹y³, 32, d©a)

	)

733 
	#TLV_PUT_U64
(
sùx
, 
©Œty³
, 
d©a
è
	`TLV_PUT_INT
(sùx,‡‰¹y³, 64, d©a)

	)

734 
	#TLV_PUT_STRING
(
sùx
, 
©Œty³
, 
¡r
, 
Ën
) \

736 
»t
 = 
	`v_put_¡ršg
(
sùx
, 
©Œty³
, 
¡r
, 
Ën
); \

737 ià(
»t
 < 0) \

738 
v_put_çu»
; \

739 } 0)

	)

740 
	#TLV_PUT_PATH
(
sùx
, 
©Œty³
, 
p
) \

742 
»t
 = 
	`v_put_¡ršg
(
sùx
, 
©Œty³
, 
p
->
¡¬t
, \

743 
p
->
’d
 -…->
¡¬t
); \

744 ià(
»t
 < 0) \

745 
v_put_çu»
; \

746 } 0)

	)

747 
	#TLV_PUT_UUID
(
sùx
, 
©Œty³
, 
uuid
) \

749 
»t
 = 
	`v_put_uuid
(
sùx
, 
©Œty³
, 
uuid
); \

750 ià(
»t
 < 0) \

751 
v_put_çu»
; \

752 } 0)

	)

753 
	#TLV_PUT_BTRFS_TIMESPEC
(
sùx
, 
©Œty³
, 
eb
, 
ts
) \

755 
»t
 = 
	`v_put_bŒfs_time¥ec
(
sùx
, 
©Œty³
, 
eb
, 
ts
); \

756 ià(
»t
 < 0) \

757 
v_put_çu»
; \

758 } 0)

	)

760 
	$£nd_h—d”
(
£nd_ùx
 *
sùx
)

762 
bŒfs_¡»am_h—d”
 
hdr
;

764 
	`¡rıy
(
hdr
.
magic
, 
BTRFS_SEND_STREAM_MAGIC
);

765 
hdr
.
v”siÚ
 = 
	`ıu_to_Ë32
(
sùx
->
´Ùo
);

766  
	`wr™e_buf
(
sùx
->
£nd_fp
, &
hdr
, (hdr),

767 &
sùx
->
£nd_off
);

768 
	}
}

773 
	$begš_cmd
(
£nd_ùx
 *
sùx
, 
cmd
)

775 
bŒfs_cmd_h—d”
 *
hdr
;

777 ià(
	`WARN_ON
(!
sùx
->
£nd_buf
))

778  -
EINVAL
;

780 
	`BUG_ON
(
sùx
->
£nd_size
);

782 
sùx
->
£nd_size
 +ğ(*
hdr
);

783 
hdr
 = (
bŒfs_cmd_h—d”
 *)
sùx
->
£nd_buf
;

784 
	`put_uÇligÃd_Ë16
(
cmd
, &
hdr
->cmd);

787 
	}
}

789 
	$£nd_cmd
(
£nd_ùx
 *
sùx
)

791 
»t
;

792 
bŒfs_cmd_h—d”
 *
hdr
;

793 
u32
 
üc
;

795 
hdr
 = (
bŒfs_cmd_h—d”
 *)
sùx
->
£nd_buf
;

796 
	`put_uÇligÃd_Ë32
(
sùx
->
£nd_size
 - (*
hdr
), &hdr->
Ën
);

797 
	`put_uÇligÃd_Ë32
(0, &
hdr
->
üc
);

799 
üc
 = 
	`bŒfs_üc32c
(0, (*)
sùx
->
£nd_buf
, sùx->
£nd_size
);

800 
	`put_uÇligÃd_Ë32
(
üc
, &
hdr
->crc);

802 
»t
 = 
	`wr™e_buf
(
sùx
->
£nd_fp
, sùx->
£nd_buf
, sùx->
£nd_size
,

803 &
sùx
->
£nd_off
);

805 
sùx
->
£nd_size
 = 0;

806 
sùx
->
put_d©a
 = 
çl£
;

808  
»t
;

809 
	}
}

814 
	$£nd_»Çme
(
£nd_ùx
 *
sùx
,

815 
fs_·th
 *
äom
, fs_·th *
to
)

817 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

818 
»t
;

820 
	`bŒfs_debug
(
fs_šfo
, "£nd_»Çm% -> %s", 
äom
->
¡¬t
, 
to
->start);

822 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_RENAME
);

823 ià(
»t
 < 0)

824 
out
;

826 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
äom
);

827 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH_TO
, 
to
);

829 
»t
 = 
	`£nd_cmd
(
sùx
);

831 
v_put_çu»
:

832 
out
:

833  
»t
;

834 
	}
}

839 
	$£nd_lšk
(
£nd_ùx
 *
sùx
,

840 
fs_·th
 *
·th
, fs_·th *
Êk
)

842 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

843 
»t
;

845 
	`bŒfs_debug
(
fs_šfo
, "£nd_lšk % -> %s", 
·th
->
¡¬t
, 
Êk
->start);

847 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_LINK
);

848 ià(
»t
 < 0)

849 
out
;

851 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
·th
);

852 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH_LINK
, 
Êk
);

854 
»t
 = 
	`£nd_cmd
(
sùx
);

856 
v_put_çu»
:

857 
out
:

858  
»t
;

859 
	}
}

864 
	$£nd_uÆšk
(
£nd_ùx
 *
sùx
, 
fs_·th
 *
·th
)

866 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

867 
»t
;

869 
	`bŒfs_debug
(
fs_šfo
, "£nd_uÆšk %s", 
·th
->
¡¬t
);

871 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_UNLINK
);

872 ià(
»t
 < 0)

873 
out
;

875 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
·th
);

877 
»t
 = 
	`£nd_cmd
(
sùx
);

879 
v_put_çu»
:

880 
out
:

881  
»t
;

882 
	}
}

887 
	$£nd_rmdœ
(
£nd_ùx
 *
sùx
, 
fs_·th
 *
·th
)

889 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

890 
»t
;

892 
	`bŒfs_debug
(
fs_šfo
, "£nd_rmdœ %s", 
·th
->
¡¬t
);

894 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_RMDIR
);

895 ià(
»t
 < 0)

896 
out
;

898 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
·th
);

900 
»t
 = 
	`£nd_cmd
(
sùx
);

902 
v_put_çu»
:

903 
out
:

904  
»t
;

905 
	}
}

907 
	sbŒfs_šode_šfo
 {

908 
u64
 
	msize
;

909 
u64
 
	mg’
;

910 
u64
 
	mmode
;

911 
u64
 
	muid
;

912 
u64
 
	mgid
;

913 
u64
 
	mrdev
;

914 
u64
 
	mf—‰r
;

915 
u64
 
	mÆšk
;

921 
	$g‘_šode_šfo
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
šo
,

922 
bŒfs_šode_šfo
 *
šfo
)

924 
»t
;

925 
bŒfs_·th
 *
·th
;

926 
bŒfs_šode_™em
 *
ii
;

927 
bŒfs_key
 
key
;

929 
·th
 = 
	`®loc_·th_fÜ_£nd
();

930 ià(!
·th
)

931  -
ENOMEM
;

933 
key
.
objeùid
 = 
šo
;

934 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

935 
key
.
off£t
 = 0;

936 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

937 ià(
»t
) {

938 ià(
»t
 > 0)

939 
»t
 = -
ENOENT
;

940 
out
;

943 ià(!
šfo
)

944 
out
;

946 
ii
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

947 
bŒfs_šode_™em
);

948 
šfo
->
size
 = 
	`bŒfs_šode_size
(
·th
->
nodes
[0], 
ii
);

949 
šfo
->
g’
 = 
	`bŒfs_šode_g’”©iÚ
(
·th
->
nodes
[0], 
ii
);

950 
šfo
->
mode
 = 
	`bŒfs_šode_mode
(
·th
->
nodes
[0], 
ii
);

951 
šfo
->
uid
 = 
	`bŒfs_šode_uid
(
·th
->
nodes
[0], 
ii
);

952 
šfo
->
gid
 = 
	`bŒfs_šode_gid
(
·th
->
nodes
[0], 
ii
);

953 
šfo
->
rdev
 = 
	`bŒfs_šode_rdev
(
·th
->
nodes
[0], 
ii
);

954 
šfo
->
Æšk
 = 
	`bŒfs_šode_Æšk
(
·th
->
nodes
[0], 
ii
);

959 
šfo
->
f—‰r
 = 
	`bŒfs_šode_æags
(
·th
->
nodes
[0], 
ii
);

961 
out
:

962 
	`bŒfs_ä“_·th
(
·th
);

963  
»t
;

964 
	}
}

966 
	$g‘_šode_g’
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
šo
, u64 *
g’
)

968 
»t
;

969 
bŒfs_šode_šfo
 
šfo
 = { 0 };

971 
	`ASSERT
(
g’
);

973 
»t
 = 
	`g‘_šode_šfo
(
roÙ
, 
šo
, &
šfo
);

974 *
g’
 = 
šfo
.gen;

975  
»t
;

976 
	}
}

978 (*
	t™”©e_šode_»f_t
)(
	tnum
, 
	tu64
 
	tdœ
, 
	tšdex
,

979 
	tfs_·th
 *
	tp
,

980 *
	tùx
);

990 
	$™”©e_šode_»f
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

991 
bŒfs_key
 *
found_key
, 
»sŞve
,

992 
™”©e_šode_»f_t
 
™”©e
, *
ùx
)

994 
ex‹Á_bufãr
 *
eb
 = 
·th
->
nodes
[0];

995 
bŒfs_šode_»f
 *
œef
;

996 
bŒfs_šode_exŒef
 *
exŒef
;

997 
bŒfs_·th
 *
tmp_·th
;

998 
fs_·th
 *
p
;

999 
u32
 
cur
 = 0;

1000 
u32
 
tÙ®
;

1001 
¦Ù
 = 
·th
->
¦Ùs
[0];

1002 
u32
 
Çme_Ën
;

1003 *
¡¬t
;

1004 
»t
 = 0;

1005 
num
 = 0;

1006 
šdex
;

1007 
u64
 
dœ
;

1008 
Çme_off
;

1009 
–em_size
;

1010 
±r
;

1012 
p
 = 
	`fs_·th_®loc_»v”£d
();

1013 ià(!
p
)

1014  -
ENOMEM
;

1016 
tmp_·th
 = 
	`®loc_·th_fÜ_£nd
();

1017 ià(!
tmp_·th
) {

1018 
	`fs_·th_ä“
(
p
);

1019  -
ENOMEM
;

1023 ià(
found_key
->
ty³
 =ğ
BTRFS_INODE_REF_KEY
) {

1024 
±r
 = ()
	`bŒfs_™em_±r
(
eb
, 
¦Ù
,

1025 
bŒfs_šode_»f
);

1026 
tÙ®
 = 
	`bŒfs_™em_size
(
eb
, 
¦Ù
);

1027 
–em_size
 = (*
œef
);

1029 
±r
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

1030 
tÙ®
 = 
	`bŒfs_™em_size
(
eb
, 
¦Ù
);

1031 
–em_size
 = (*
exŒef
);

1034 
cur
 < 
tÙ®
) {

1035 
	`fs_·th_»£t
(
p
);

1037 ià(
found_key
->
ty³
 =ğ
BTRFS_INODE_REF_KEY
) {

1038 
œef
 = (
bŒfs_šode_»f
 *)(
±r
 + 
cur
);

1039 
Çme_Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
eb
, 
œef
);

1040 
Çme_off
 = ()(
œef
 + 1);

1041 
šdex
 = 
	`bŒfs_šode_»f_šdex
(
eb
, 
œef
);

1042 
dœ
 = 
found_key
->
off£t
;

1044 
exŒef
 = (
bŒfs_šode_exŒef
 *)(
±r
 + 
cur
);

1045 
Çme_Ën
 = 
	`bŒfs_šode_exŒef_Çme_Ën
(
eb
, 
exŒef
);

1046 
Çme_off
 = ()&
exŒef
->
Çme
;

1047 
šdex
 = 
	`bŒfs_šode_exŒef_šdex
(
eb
, 
exŒef
);

1048 
dœ
 = 
	`bŒfs_šode_exŒef_·»Á
(
eb
, 
exŒef
);

1051 ià(
»sŞve
) {

1052 
¡¬t
 = 
	`bŒfs_»f_to_·th
(
roÙ
, 
tmp_·th
, 
Çme_Ën
,

1053 
Çme_off
, 
eb
, 
dœ
,

1054 
p
->
buf
,…->
buf_Ën
);

1055 ià(
	`IS_ERR
(
¡¬t
)) {

1056 
»t
 = 
	`PTR_ERR
(
¡¬t
);

1057 
out
;

1059 ià(
¡¬t
 < 
p
->
buf
) {

1061 
»t
 = 
	`fs_·th_’su»_buf
(
p
,

1062 
p
->
buf_Ën
 +…->
buf
 - 
¡¬t
);

1063 ià(
»t
 < 0)

1064 
out
;

1065 
¡¬t
 = 
	`bŒfs_»f_to_·th
(
roÙ
, 
tmp_·th
,

1066 
Çme_Ën
, 
Çme_off
,

1067 
eb
, 
dœ
,

1068 
p
->
buf
,…->
buf_Ën
);

1069 ià(
	`IS_ERR
(
¡¬t
)) {

1070 
»t
 = 
	`PTR_ERR
(
¡¬t
);

1071 
out
;

1073 
	`BUG_ON
(
¡¬t
 < 
p
->
buf
);

1075 
p
->
¡¬t
 = start;

1077 
»t
 = 
	`fs_·th_add_äom_ex‹Á_bufãr
(
p
, 
eb
, 
Çme_off
,

1078 
Çme_Ën
);

1079 ià(
»t
 < 0)

1080 
out
;

1083 
cur
 +ğ
–em_size
 + 
Çme_Ën
;

1084 
»t
 = 
	`™”©e
(
num
, 
dœ
, 
šdex
, 
p
, 
ùx
);

1085 ià(
»t
)

1086 
out
;

1087 
num
++;

1090 
out
:

1091 
	`bŒfs_ä“_·th
(
tmp_·th
);

1092 
	`fs_·th_ä“
(
p
);

1093  
»t
;

1094 
	}
}

1096 (*
	t™”©e_dœ_™em_t
)(
	tnum
, 
	tbŒfs_key
 *
	tdi_key
,

1097 cÚ¡ *
	tÇme
, 
	tÇme_Ën
,

1098 cÚ¡ *
	td©a
, 
	td©a_Ën
,

1099 *
	tùx
);

1108 
	$™”©e_dœ_™em
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

1109 
™”©e_dœ_™em_t
 
™”©e
, *
ùx
)

1111 
»t
 = 0;

1112 
ex‹Á_bufãr
 *
eb
;

1113 
bŒfs_dœ_™em
 *
di
;

1114 
bŒfs_key
 
di_key
;

1115 *
buf
 = 
NULL
;

1116 
buf_Ën
;

1117 
u32
 
Çme_Ën
;

1118 
u32
 
d©a_Ën
;

1119 
u32
 
cur
;

1120 
u32
 
Ën
;

1121 
u32
 
tÙ®
;

1122 
¦Ù
;

1123 
num
;

1131 
buf_Ën
 = 
PATH_MAX
;

1132 
buf
 = 
	`km®loc
(
buf_Ën
, 
GFP_KERNEL
);

1133 ià(!
buf
) {

1134 
»t
 = -
ENOMEM
;

1135 
out
;

1138 
eb
 = 
·th
->
nodes
[0];

1139 
¦Ù
 = 
·th
->
¦Ùs
[0];

1140 
di
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_dœ_™em
);

1141 
cur
 = 0;

1142 
Ën
 = 0;

1143 
tÙ®
 = 
	`bŒfs_™em_size
(
eb
, 
¦Ù
);

1145 
num
 = 0;

1146 
cur
 < 
tÙ®
) {

1147 
Çme_Ën
 = 
	`bŒfs_dœ_Çme_Ën
(
eb
, 
di
);

1148 
d©a_Ën
 = 
	`bŒfs_dœ_d©a_Ën
(
eb
, 
di
);

1149 
	`bŒfs_dœ_™em_key_to_ıu
(
eb
, 
di
, &
di_key
);

1151 ià(
	`bŒfs_dœ_áy³
(
eb
, 
di
è=ğ
BTRFS_FT_XATTR
) {

1152 ià(
Çme_Ën
 > 
XATTR_NAME_MAX
) {

1153 
»t
 = -
ENAMETOOLONG
;

1154 
out
;

1156 ià(
Çme_Ën
 + 
d©a_Ën
 >

1157 
	`BTRFS_MAX_XATTR_SIZE
(
roÙ
->
fs_šfo
)) {

1158 
»t
 = -
E2BIG
;

1159 
out
;

1165 ià(
Çme_Ën
 + 
d©a_Ën
 > 
PATH_MAX
) {

1166 
»t
 = -
ENAMETOOLONG
;

1167 
out
;

1171 ià(
Çme_Ën
 + 
d©a_Ën
 > 
buf_Ën
) {

1172 
buf_Ën
 = 
Çme_Ën
 + 
d©a_Ën
;

1173 ià(
	`is_vm®loc_addr
(
buf
)) {

1174 
	`vä“
(
buf
);

1175 
buf
 = 
NULL
;

1177 *
tmp
 = 
	`k»®loc
(
buf
, 
buf_Ën
,

1178 
GFP_KERNEL
 | 
__GFP_NOWARN
);

1180 ià(!
tmp
)

1181 
	`kä“
(
buf
);

1182 
buf
 = 
tmp
;

1184 ià(!
buf
) {

1185 
buf
 = 
	`kvm®loc
(
buf_Ën
, 
GFP_KERNEL
);

1186 ià(!
buf
) {

1187 
»t
 = -
ENOMEM
;

1188 
out
;

1193 
	`»ad_ex‹Á_bufãr
(
eb
, 
buf
, ()(
di
 + 1),

1194 
Çme_Ën
 + 
d©a_Ën
);

1196 
Ën
 = (*
di
è+ 
Çme_Ën
 + 
d©a_Ën
;

1197 
di
 = (
bŒfs_dœ_™em
 *)((*)d˜+ 
Ën
);

1198 
cur
 +ğ
Ën
;

1200 
»t
 = 
	`™”©e
(
num
, &
di_key
, 
buf
, 
Çme_Ën
, buf +‚ame_len,

1201 
d©a_Ën
, 
ùx
);

1202 ià(
»t
 < 0)

1203 
out
;

1204 ià(
»t
) {

1205 
»t
 = 0;

1206 
out
;

1209 
num
++;

1212 
out
:

1213 
	`kvä“
(
buf
);

1214  
»t
;

1215 
	}
}

1217 
	$__cİy_fœ¡_»f
(
num
, 
u64
 
dœ
, 
šdex
,

1218 
fs_·th
 *
p
, *
ùx
)

1220 
»t
;

1221 
fs_·th
 *
±
 = 
ùx
;

1223 
»t
 = 
	`fs_·th_cİy
(
±
, 
p
);

1224 ià(
»t
 < 0)

1225  
»t
;

1229 
	}
}

1235 
	$g‘_šode_·th
(
bŒfs_roÙ
 *
roÙ
,

1236 
u64
 
šo
, 
fs_·th
 *
·th
)

1238 
»t
;

1239 
bŒfs_key
 
key
, 
found_key
;

1240 
bŒfs_·th
 *
p
;

1242 
p
 = 
	`®loc_·th_fÜ_£nd
();

1243 ià(!
p
)

1244  -
ENOMEM
;

1246 
	`fs_·th_»£t
(
·th
);

1248 
key
.
objeùid
 = 
šo
;

1249 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

1250 
key
.
off£t
 = 0;

1252 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
roÙ
, &
key
, 
p
, 1, 0);

1253 ià(
»t
 < 0)

1254 
out
;

1255 ià(
»t
) {

1256 
»t
 = 1;

1257 
out
;

1259 
	`bŒfs_™em_key_to_ıu
(
p
->
nodes
[0], &
found_key
,…->
¦Ùs
[0]);

1260 ià(
found_key
.
objeùid
 !ğ
šo
 ||

1261 (
found_key
.
ty³
 !ğ
BTRFS_INODE_REF_KEY
 &&

1262 
found_key
.
ty³
 !ğ
BTRFS_INODE_EXTREF_KEY
)) {

1263 
»t
 = -
ENOENT
;

1264 
out
;

1267 
»t
 = 
	`™”©e_šode_»f
(
roÙ
, 
p
, &
found_key
, 1,

1268 
__cİy_fœ¡_»f
, 
·th
);

1269 ià(
»t
 < 0)

1270 
out
;

1271 
»t
 = 0;

1273 
out
:

1274 
	`bŒfs_ä“_·th
(
p
);

1275  
»t
;

1276 
	}
}

1278 
	sback»f_ùx
 {

1279 
£nd_ùx
 *
	msùx
;

1282 
u64
 
	mfound
;

1288 
u64
 
	mcur_objeùid
;

1289 
u64
 
	mcur_off£t
;

1292 
u64
 
	mex‹Á_Ën
;

1295 
u64
 
	mby‹Ä
;

1297 
u64
 
	mback»f_owÃr
;

1299 
u64
 
	mback»f_off£t
;

1302 
	$__şÚe_roÙ_cmp_b£¬ch
(cÚ¡ *
key
, cÚ¡ *
–t
)

1304 
u64
 
roÙ
 = (u64)(
ušŒ_t
)
key
;

1305 cÚ¡ 
şÚe_roÙ
 *
ü
 = 
–t
;

1307 ià(
roÙ
 < 
ü
->roÙ->
roÙ_key
.
objeùid
)

1309 ià(
roÙ
 > 
ü
->roÙ->
roÙ_key
.
objeùid
)

1312 
	}
}

1314 
	$__şÚe_roÙ_cmp_sÜt
(cÚ¡ *
e1
, cÚ¡ *
e2
)

1316 cÚ¡ 
şÚe_roÙ
 *
ü1
 = 
e1
;

1317 cÚ¡ 
şÚe_roÙ
 *
ü2
 = 
e2
;

1319 ià(
ü1
->
roÙ
->
roÙ_key
.
objeùid
 < 
ü2
->root->root_key.objectid)

1321 ià(
ü1
->
roÙ
->
roÙ_key
.
objeùid
 > 
ü2
->root->root_key.objectid)

1324 
	}
}

1330 
	$™”©e_back»fs
(
u64
 
šo
, u64 
off£t
, u64 
num_by‹s
, u64 
roÙ_id
,

1331 *
ùx_
)

1333 
back»f_ùx
 *
bùx
 = 
ùx_
;

1334 
şÚe_roÙ
 *clone_root;

1337 
şÚe_roÙ
 = 
	`b£¬ch
((*)(
ušŒ_t
)
roÙ_id
, 
bùx
->
sùx
->
şÚe_roÙs
,

1338 
bùx
->
sùx
->
şÚe_roÙs_út
,

1339 (
şÚe_roÙ
),

1340 
__şÚe_roÙ_cmp_b£¬ch
);

1341 ià(!
şÚe_roÙ
)

1345 ià(
şÚe_roÙ
->
roÙ
 =ğ
bùx
->
sùx
->
£nd_roÙ
 &&

1346 
šo
 =ğ
bùx
->
cur_objeùid
 &&

1347 
off£t
 =ğ
bùx
->
cur_off£t
)

1354 ià(
şÚe_roÙ
->
roÙ
 =ğ
bùx
->
sùx
->
£nd_roÙ
) {

1360 ià(
šo
 > 
bùx
->
cur_objeùid
)

1368 ià(
šo
 =ğ
bùx
->
cur_objeùid
 &&

1369 
off£t
 + 
bùx
->
ex‹Á_Ën
 >

1370 
bùx
->
sùx
->
cur_šode_Ãxt_wr™e_off£t
)

1374 
bùx
->
found
++;

1375 
şÚe_roÙ
->
found_»f
 = 
Œue
;

1383 ià(
num_by‹s
 > 
şÚe_roÙ
->num_bytes) {

1384 
şÚe_roÙ
->
šo
 = ino;

1385 
şÚe_roÙ
->
off£t
 = offset;

1386 
şÚe_roÙ
->
num_by‹s
 =‚um_bytes;

1392 ià(
num_by‹s
 >ğ
bùx
->
ex‹Á_Ën
)

1393  
BTRFS_ITERATE_EXTENT_INODES_STOP
;

1397 
	}
}

1399 
boŞ
 
	$lookup_back»f_ÿche
(
u64
 
Ëaf_by‹Ä
, *
ùx
,

1400 cÚ¡ 
u64
 **
roÙ_ids_»t
, *
roÙ_couÁ_»t
)

1402 
back»f_ùx
 *
bùx
 = 
ùx
;

1403 
£nd_ùx
 *
sùx
 = 
bùx
->sctx;

1404 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

1405 cÚ¡ 
u64
 
key
 = 
Ëaf_by‹Ä
 >> 
fs_šfo
->
£ùÜsize_b™s
;

1406 
bŒfs_Ìu_ÿche_’Œy
 *
¿w_’Œy
;

1407 
back»f_ÿche_’Œy
 *
’Œy
;

1409 ià(
	`bŒfs_Ìu_ÿche_size
(&
sùx
->
back»f_ÿche
) == 0)

1410  
çl£
;

1423 ià(
fs_šfo
->
Ï¡_»loc_Œªs
 > 
sùx
->
back»f_ÿche_Ï¡_»loc_Œªs
) {

1424 
	`bŒfs_Ìu_ÿche_ş—r
(&
sùx
->
back»f_ÿche
);

1425  
çl£
;

1428 
¿w_’Œy
 = 
	`bŒfs_Ìu_ÿche_lookup
(&
sùx
->
back»f_ÿche
, 
key
, 0);

1429 ià(!
¿w_’Œy
)

1430  
çl£
;

1432 
’Œy
 = 
	`cÚš”_of
(
¿w_’Œy
, 
back»f_ÿche_’Œy
,ƒntry);

1433 *
roÙ_ids_»t
 = 
’Œy
->
roÙ_ids
;

1434 *
roÙ_couÁ_»t
 = 
’Œy
->
num_roÙs
;

1436  
Œue
;

1437 
	}
}

1439 
	$¡Üe_back»f_ÿche
(
u64
 
Ëaf_by‹Ä
, cÚ¡ 
uli¡
 *
roÙ_ids
,

1440 *
ùx
)

1442 
back»f_ùx
 *
bùx
 = 
ùx
;

1443 
£nd_ùx
 *
sùx
 = 
bùx
->sctx;

1444 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

1445 
back»f_ÿche_’Œy
 *
Ãw_’Œy
;

1446 
uli¡_™”©Ü
 
u™”
;

1447 
uli¡_node
 *
node
;

1448 
»t
;

1455 
Ãw_’Œy
 = 
	`km®loc
((
back»f_ÿche_’Œy
), 
GFP_NOFS
);

1457 ià(!
Ãw_’Œy
)

1460 
Ãw_’Œy
->
’Œy
.
key
 = 
Ëaf_by‹Ä
 >> 
fs_šfo
->
£ùÜsize_b™s
;

1461 
Ãw_’Œy
->
’Œy
.
g’
 = 0;

1462 
Ãw_’Œy
->
num_roÙs
 = 0;

1463 
	`ULIST_ITER_INIT
(&
u™”
);

1464 (
node
 = 
	`uli¡_Ãxt
(
roÙ_ids
, &
u™”
)è!ğ
NULL
) {

1465 cÚ¡ 
u64
 
roÙ_id
 = 
node
->
v®
;

1466 
şÚe_roÙ
 *
roÙ
;

1468 
roÙ
 = 
	`b£¬ch
((*)(
ušŒ_t
)
roÙ_id
, 
sùx
->
şÚe_roÙs
,

1469 
sùx
->
şÚe_roÙs_út
, (
şÚe_roÙ
),

1470 
__şÚe_roÙ_cmp_b£¬ch
);

1471 ià(!
roÙ
)

1475 ià(
Ãw_’Œy
->
num_roÙs
 >ğ
SEND_MAX_BACKREF_CACHE_ROOTS
) {

1476 
	`kä“
(
Ãw_’Œy
);

1480 
Ãw_’Œy
->
roÙ_ids
[Ãw_’Œy->
num_roÙs
] = 
roÙ_id
;

1481 
Ãw_’Œy
->
num_roÙs
++;

1493 
»t
 = 
	`bŒfs_Ìu_ÿche_¡Üe
(&
sùx
->
back»f_ÿche
, &
Ãw_’Œy
->
’Œy
,

1494 
GFP_NOFS
);

1495 
	`ASSERT
(
»t
 =ğ0 ||„‘ =ğ-
ENOMEM
);

1496 ià(
»t
) {

1498 
	`kä“
(
Ãw_’Œy
);

1507 ià(
	`bŒfs_Ìu_ÿche_size
(&
sùx
->
back»f_ÿche
) == 1)

1508 
sùx
->
back»f_ÿche_Ï¡_»loc_Œªs
 = 
fs_šfo
->
Ï¡_»loc_Œªs
;

1509 
	}
}

1511 
	$check_ex‹Á_™em
(
u64
 
by‹Ä
, cÚ¡ 
bŒfs_ex‹Á_™em
 *
ei
,

1512 cÚ¡ 
ex‹Á_bufãr
 *
Ëaf
, *
ùx
)

1514 cÚ¡ 
u64
 
»fs
 = 
	`bŒfs_ex‹Á_»fs
(
Ëaf
, 
ei
);

1515 cÚ¡ 
back»f_ùx
 *
bùx
 = 
ùx
;

1516 cÚ¡ 
£nd_ùx
 *
sùx
 = 
bùx
->sctx;

1518 ià(
by‹Ä
 =ğ
bùx
->bytenr) {

1519 cÚ¡ 
u64
 
æags
 = 
	`bŒfs_ex‹Á_æags
(
Ëaf
, 
ei
);

1521 ià(
	`WARN_ON
(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
))

1522  -
EUCLEAN
;

1531 ià(
»fs
 =ğ1 && 
sùx
->
şÚe_roÙs_út
 == 1)

1532  -
ENOENT
;

1542 ià(
»fs
 > 
SEND_MAX_EXTENT_REFS
)

1543  -
ENOENT
;

1546 
	}
}

1548 
boŞ
 
	$sk_£lf_d©a_»f
(
u64
 
roÙ
, u64 
šo
, u64 
off£t
, *
ùx
)

1550 cÚ¡ 
back»f_ùx
 *
bùx
 = 
ùx
;

1552 ià(
šo
 =ğ
bùx
->
cur_objeùid
 &&

1553 
roÙ
 =ğ
bùx
->
back»f_owÃr
 &&

1554 
off£t
 =ğ
bùx
->
back»f_off£t
)

1555  
Œue
;

1557  
çl£
;

1558 
	}
}

1569 
	$fšd_ex‹Á_şÚe
(
£nd_ùx
 *
sùx
,

1570 
bŒfs_·th
 *
·th
,

1571 
u64
 
šo
, u64 
d©a_off£t
,

1572 
u64
 
šo_size
,

1573 
şÚe_roÙ
 **
found
)

1575 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

1576 
»t
;

1577 
ex‹Á_ty³
;

1578 
u64
 
logiÿl
;

1579 
u64
 
disk_by‹
;

1580 
u64
 
num_by‹s
;

1581 
bŒfs_fe_ex‹Á_™em
 *
fi
;

1582 
ex‹Á_bufãr
 *
eb
 = 
·th
->
nodes
[0];

1583 
back»f_ùx
 backref_ctx = { 0 };

1584 
bŒfs_back»f_w®k_ùx
 
back»f_w®k_ùx
 = { 0 };

1585 
şÚe_roÙ
 *
cur_şÚe_roÙ
;

1586 
com´es£d
;

1587 
u32
 
i
;

1595 ià(
d©a_off£t
 >ğ
šo_size
)

1598 
fi
 = 
	`bŒfs_™em_±r
(
eb
, 
·th
->
¦Ùs
[0], 
bŒfs_fe_ex‹Á_™em
);

1599 
ex‹Á_ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
eb
, 
fi
);

1600 ià(
ex‹Á_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
)

1601  -
ENOENT
;

1603 
disk_by‹
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
eb
, 
fi
);

1604 ià(
disk_by‹
 == 0)

1605  -
ENOENT
;

1607 
com´es£d
 = 
	`bŒfs_fe_ex‹Á_com´essiÚ
(
eb
, 
fi
);

1608 
num_by‹s
 = 
	`bŒfs_fe_ex‹Á_num_by‹s
(
eb
, 
fi
);

1609 
logiÿl
 = 
disk_by‹
 + 
	`bŒfs_fe_ex‹Á_off£t
(
eb
, 
fi
);

1614 
i
 = 0; i < 
sùx
->
şÚe_roÙs_út
; i++) {

1615 
cur_şÚe_roÙ
 = 
sùx
->
şÚe_roÙs
 + 
i
;

1616 
cur_şÚe_roÙ
->
šo
 = (
u64
)-1;

1617 
cur_şÚe_roÙ
->
off£t
 = 0;

1618 
cur_şÚe_roÙ
->
num_by‹s
 = 0;

1619 
cur_şÚe_roÙ
->
found_»f
 = 
çl£
;

1622 
back»f_ùx
.
sùx
 = sctx;

1623 
back»f_ùx
.
cur_objeùid
 = 
šo
;

1624 
back»f_ùx
.
cur_off£t
 = 
d©a_off£t
;

1625 
back»f_ùx
.
by‹Ä
 = 
disk_by‹
;

1630 
back»f_ùx
.
back»f_owÃr
 = 
	`bŒfs_h—d”_owÃr
(
eb
);

1631 
back»f_ùx
.
back»f_off£t
 = 
d©a_off£t
 - 
	`bŒfs_fe_ex‹Á_off£t
(
eb
, 
fi
);

1638 ià(
d©a_off£t
 + 
num_by‹s
 >ğ
šo_size
)

1639 
back»f_ùx
.
ex‹Á_Ën
 = 
šo_size
 - 
d©a_off£t
;

1641 
back»f_ùx
.
ex‹Á_Ën
 = 
num_by‹s
;

1646 
back»f_w®k_ùx
.
by‹Ä
 = 
disk_by‹
;

1647 ià(
com´es£d
 =ğ
BTRFS_COMPRESS_NONE
)

1648 
back»f_w®k_ùx
.
ex‹Á_™em_pos
 = 
	`bŒfs_fe_ex‹Á_off£t
(
eb
, 
fi
);

1649 
back»f_w®k_ùx
.
fs_šfo
 = fs_info;

1650 
back»f_w®k_ùx
.
ÿche_lookup
 = 
lookup_back»f_ÿche
;

1651 
back»f_w®k_ùx
.
ÿche_¡Üe
 = 
¡Üe_back»f_ÿche
;

1652 
back»f_w®k_ùx
.
šdœeù_»f_™”©Ü
 = 
™”©e_back»fs
;

1653 
back»f_w®k_ùx
.
check_ex‹Á_™em
 = check_extent_item;

1654 
back»f_w®k_ùx
.
u£r_ùx
 = &
back»f_ùx
;

1664 ià(
sùx
->
şÚe_roÙs_út
 == 1)

1665 
back»f_w®k_ùx
.
sk_d©a_»f
 = 
sk_£lf_d©a_»f
;

1667 
»t
 = 
	`™”©e_ex‹Á_šodes
(&
back»f_w®k_ùx
, 
Œue
, 
™”©e_back»fs
,

1668 &
back»f_ùx
);

1669 ià(
»t
 < 0)

1670  
»t
;

1672 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

1673 ià(
fs_šfo
->
Ï¡_»loc_Œªs
 > 
sùx
->last_reloc_trans) {

1686 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

1687  -
ENOENT
;

1689 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

1691 
	`bŒfs_debug
(
fs_šfo
,

1693 
d©a_off£t
, 
šo
, 
num_by‹s
, 
logiÿl
);

1695 ià(!
back»f_ùx
.
found
) {

1696 
	`bŒfs_debug
(
fs_šfo
, "no clones found");

1697  -
ENOENT
;

1700 
cur_şÚe_roÙ
 = 
NULL
;

1701 
i
 = 0; i < 
sùx
->
şÚe_roÙs_út
; i++) {

1702 
şÚe_roÙ
 *şÚe_roÙ = &
sùx
->
şÚe_roÙs
[
i
];

1704 ià(!
şÚe_roÙ
->
found_»f
)

1712 ià(!
cur_şÚe_roÙ
 ||

1713 
şÚe_roÙ
->
num_by‹s
 > 
cur_şÚe_roÙ
->num_bytes) {

1714 
cur_şÚe_roÙ
 = 
şÚe_roÙ
;

1720 ià(
şÚe_roÙ
->
num_by‹s
 >ğ
back»f_ùx
.
ex‹Á_Ën
)

1725 ià(
cur_şÚe_roÙ
) {

1726 *
found
 = 
cur_şÚe_roÙ
;

1727 
»t
 = 0;

1729 
»t
 = -
ENOENT
;

1732  
»t
;

1733 
	}
}

1735 
	$»ad_symlšk
(
bŒfs_roÙ
 *
roÙ
,

1736 
u64
 
šo
,

1737 
fs_·th
 *
de¡
)

1739 
»t
;

1740 
bŒfs_·th
 *
·th
;

1741 
bŒfs_key
 
key
;

1742 
bŒfs_fe_ex‹Á_™em
 *
ei
;

1743 
u8
 
ty³
;

1744 
u8
 
com´essiÚ
;

1745 
off
;

1746 
Ën
;

1748 
·th
 = 
	`®loc_·th_fÜ_£nd
();

1749 ià(!
·th
)

1750  -
ENOMEM
;

1752 
key
.
objeùid
 = 
šo
;

1753 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

1754 
key
.
off£t
 = 0;

1755 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

1756 ià(
»t
 < 0)

1757 
out
;

1758 ià(
»t
) {

1767 
	`bŒfs_”r
(
roÙ
->
fs_šfo
,

1769 
šo
, 
roÙ
->
roÙ_key
.
objeùid
);

1770 
»t
 = -
EIO
;

1771 
out
;

1774 
ei
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

1775 
bŒfs_fe_ex‹Á_™em
);

1776 
ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
·th
->
nodes
[0], 
ei
);

1777 ià(
	`uÆik–y
(
ty³
 !ğ
BTRFS_FILE_EXTENT_INLINE
)) {

1778 
»t
 = -
EUCLEAN
;

1779 
	`bŒfs_ü™
(
roÙ
->
fs_šfo
,

1781 
šo
, 
	`bŒfs_roÙ_id
(
roÙ
), 
ty³
);

1782 
out
;

1784 
com´essiÚ
 = 
	`bŒfs_fe_ex‹Á_com´essiÚ
(
·th
->
nodes
[0], 
ei
);

1785 ià(
	`uÆik–y
(
com´essiÚ
 !ğ
BTRFS_COMPRESS_NONE
)) {

1786 
»t
 = -
EUCLEAN
;

1787 
	`bŒfs_ü™
(
roÙ
->
fs_šfo
,

1789 
šo
, 
	`bŒfs_roÙ_id
(
roÙ
), 
com´essiÚ
);

1790 
out
;

1793 
off
 = 
	`bŒfs_fe_ex‹Á_šlše_¡¬t
(
ei
);

1794 
Ën
 = 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
·th
->
nodes
[0], 
ei
);

1796 
»t
 = 
	`fs_·th_add_äom_ex‹Á_bufãr
(
de¡
, 
·th
->
nodes
[0], 
off
, 
Ën
);

1798 
out
:

1799 
	`bŒfs_ä“_·th
(
·th
);

1800  
»t
;

1801 
	}
}

1807 
	$g’_unique_Çme
(
£nd_ùx
 *
sùx
,

1808 
u64
 
šo
, u64 
g’
,

1809 
fs_·th
 *
de¡
)

1811 
»t
 = 0;

1812 
bŒfs_·th
 *
·th
;

1813 
bŒfs_dœ_™em
 *
di
;

1814 
tmp
[64];

1815 
Ën
;

1816 
u64
 
idx
 = 0;

1818 
·th
 = 
	`®loc_·th_fÜ_£nd
();

1819 ià(!
·th
)

1820  -
ENOMEM
;

1823 
fsüy±_¡r
 
tmp_Çme
;

1825 
Ën
 = 
	`¢´štf
(
tmp
, (tmp), "o%llu-%llu-%llu",

1826 
šo
, 
g’
, 
idx
);

1827 
	`ASSERT
(
Ën
 < (
tmp
));

1828 
tmp_Çme
.
Çme
 = 
tmp
;

1829 
tmp_Çme
.
Ën
 = 
	`¡¾’
(
tmp
);

1831 
di
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
sùx
->
£nd_roÙ
,

1832 
·th
, 
BTRFS_FIRST_FREE_OBJECTID
,

1833 &
tmp_Çme
, 0);

1834 
	`bŒfs_»Ëa£_·th
(
·th
);

1835 ià(
	`IS_ERR
(
di
)) {

1836 
»t
 = 
	`PTR_ERR
(
di
);

1837 
out
;

1839 ià(
di
) {

1841 
idx
++;

1845 ià(!
sùx
->
·»Á_roÙ
) {

1847 
»t
 = 0;

1851 
di
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
sùx
->
·»Á_roÙ
,

1852 
·th
, 
BTRFS_FIRST_FREE_OBJECTID
,

1853 &
tmp_Çme
, 0);

1854 
	`bŒfs_»Ëa£_·th
(
·th
);

1855 ià(
	`IS_ERR
(
di
)) {

1856 
»t
 = 
	`PTR_ERR
(
di
);

1857 
out
;

1859 ià(
di
) {

1861 
idx
++;

1868 
»t
 = 
	`fs_·th_add
(
de¡
, 
tmp
, 
	`¡¾’
(tmp));

1870 
out
:

1871 
	`bŒfs_ä“_·th
(
·th
);

1872  
»t
;

1873 
	}
}

1875 
	ešode_¡©e
 {

1876 
	mšode_¡©e_no_chªge
,

1877 
	mšode_¡©e_wl_ü—‹
,

1878 
	mšode_¡©e_did_ü—‹
,

1879 
	mšode_¡©e_wl_d–‘e
,

1880 
	mšode_¡©e_did_d–‘e
,

1883 
	$g‘_cur_šode_¡©e
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
,

1884 
u64
 *
£nd_g’
, u64 *
·»Á_g’
)

1886 
»t
;

1887 
Ëá_»t
;

1888 
right_»t
;

1889 
u64
 
Ëá_g’
;

1890 
u64
 
right_g’
 = 0;

1891 
bŒfs_šode_šfo
 
šfo
;

1893 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
£nd_roÙ
, 
šo
, &
šfo
);

1894 ià(
»t
 < 0 &&„‘ !ğ-
ENOENT
)

1895 
out
;

1896 
Ëá_»t
 = (
šfo
.
Æšk
 =ğ0è? -
ENOENT
 : 
»t
;

1897 
Ëá_g’
 = 
šfo
.
g’
;

1898 ià(
£nd_g’
)

1899 *
£nd_g’
 = ((
Ëá_»t
 =ğ-
ENOENT
è? 0 : 
šfo
.
g’
);

1901 ià(!
sùx
->
·»Á_roÙ
) {

1902 
right_»t
 = -
ENOENT
;

1904 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
·»Á_roÙ
, 
šo
, &
šfo
);

1905 ià(
»t
 < 0 &&„‘ !ğ-
ENOENT
)

1906 
out
;

1907 
right_»t
 = (
šfo
.
Æšk
 =ğ0è? -
ENOENT
 : 
»t
;

1908 
right_g’
 = 
šfo
.
g’
;

1909 ià(
·»Á_g’
)

1910 *
·»Á_g’
 = ((
right_»t
 =ğ-
ENOENT
è? 0 : 
šfo
.
g’
);

1913 ià(!
Ëá_»t
 && !
right_»t
) {

1914 ià(
Ëá_g’
 =ğ
g’
 && 
right_g’
 == gen) {

1915 
»t
 = 
šode_¡©e_no_chªge
;

1916 } ià(
Ëá_g’
 =ğ
g’
) {

1917 ià(
šo
 < 
sùx
->
£nd_´og»ss
)

1918 
»t
 = 
šode_¡©e_did_ü—‹
;

1920 
»t
 = 
šode_¡©e_wl_ü—‹
;

1921 } ià(
right_g’
 =ğ
g’
) {

1922 ià(
šo
 < 
sùx
->
£nd_´og»ss
)

1923 
»t
 = 
šode_¡©e_did_d–‘e
;

1925 
»t
 = 
šode_¡©e_wl_d–‘e
;

1927 
»t
 = -
ENOENT
;

1929 } ià(!
Ëá_»t
) {

1930 ià(
Ëá_g’
 =ğ
g’
) {

1931 ià(
šo
 < 
sùx
->
£nd_´og»ss
)

1932 
»t
 = 
šode_¡©e_did_ü—‹
;

1934 
»t
 = 
šode_¡©e_wl_ü—‹
;

1936 
»t
 = -
ENOENT
;

1938 } ià(!
right_»t
) {

1939 ià(
right_g’
 =ğ
g’
) {

1940 ià(
šo
 < 
sùx
->
£nd_´og»ss
)

1941 
»t
 = 
šode_¡©e_did_d–‘e
;

1943 
»t
 = 
šode_¡©e_wl_d–‘e
;

1945 
»t
 = -
ENOENT
;

1948 
»t
 = -
ENOENT
;

1951 
out
:

1952  
»t
;

1953 
	}
}

1955 
	$is_šode_exi¡’t
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
,

1956 
u64
 *
£nd_g’
, u64 *
·»Á_g’
)

1958 
»t
;

1960 ià(
šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
)

1963 
»t
 = 
	`g‘_cur_šode_¡©e
(
sùx
, 
šo
, 
g’
, 
£nd_g’
, 
·»Á_g’
);

1964 ià(
»t
 < 0)

1965 
out
;

1967 ià(
»t
 =ğ
šode_¡©e_no_chªge
 ||

1968 
»t
 =ğ
šode_¡©e_did_ü—‹
 ||

1969 
»t
 =ğ
šode_¡©e_wl_d–‘e
)

1970 
»t
 = 1;

1972 
»t
 = 0;

1974 
out
:

1975  
»t
;

1976 
	}
}

1981 
	$lookup_dœ_™em_šode
(
bŒfs_roÙ
 *
roÙ
,

1982 
u64
 
dœ
, cÚ¡ *
Çme
, 
Çme_Ën
,

1983 
u64
 *
found_šode
)

1985 
»t
 = 0;

1986 
bŒfs_dœ_™em
 *
di
;

1987 
bŒfs_key
 
key
;

1988 
bŒfs_·th
 *
·th
;

1989 
fsüy±_¡r
 
Çme_¡r
 = 
	`FSTR_INIT
((*)
Çme
, 
Çme_Ën
);

1991 
·th
 = 
	`®loc_·th_fÜ_£nd
();

1992 ià(!
·th
)

1993  -
ENOMEM
;

1995 
di
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
roÙ
, 
·th
, 
dœ
, &
Çme_¡r
, 0);

1996 ià(
	`IS_ERR_OR_NULL
(
di
)) {

1997 
»t
 = 
di
 ? 
	`PTR_ERR
(diè: -
ENOENT
;

1998 
out
;

2000 
	`bŒfs_dœ_™em_key_to_ıu
(
·th
->
nodes
[0], 
di
, &
key
);

2001 ià(
key
.
ty³
 =ğ
BTRFS_ROOT_ITEM_KEY
) {

2002 
»t
 = -
ENOENT
;

2003 
out
;

2005 *
found_šode
 = 
key
.
objeùid
;

2007 
out
:

2008 
	`bŒfs_ä“_·th
(
·th
);

2009  
»t
;

2010 
	}
}

2016 
	$g‘_fœ¡_»f
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
šo
,

2017 
u64
 *
dœ
, u64 *
dœ_g’
, 
fs_·th
 *
Çme
)

2019 
»t
;

2020 
bŒfs_key
 
key
;

2021 
bŒfs_key
 
found_key
;

2022 
bŒfs_·th
 *
·th
;

2023 
Ën
;

2024 
u64
 
·»Á_dœ
;

2026 
·th
 = 
	`®loc_·th_fÜ_£nd
();

2027 ià(!
·th
)

2028  -
ENOMEM
;

2030 
key
.
objeùid
 = 
šo
;

2031 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

2032 
key
.
off£t
 = 0;

2034 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
roÙ
, &
key
, 
·th
, 1, 0);

2035 ià(
»t
 < 0)

2036 
out
;

2037 ià(!
»t
)

2038 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
found_key
,

2039 
·th
->
¦Ùs
[0]);

2040 ià(
»t
 || 
found_key
.
objeùid
 !ğ
šo
 ||

2041 (
found_key
.
ty³
 !ğ
BTRFS_INODE_REF_KEY
 &&

2042 
found_key
.
ty³
 !ğ
BTRFS_INODE_EXTREF_KEY
)) {

2043 
»t
 = -
ENOENT
;

2044 
out
;

2047 ià(
found_key
.
ty³
 =ğ
BTRFS_INODE_REF_KEY
) {

2048 
bŒfs_šode_»f
 *
œef
;

2049 
œef
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

2050 
bŒfs_šode_»f
);

2051 
Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
·th
->
nodes
[0], 
œef
);

2052 
»t
 = 
	`fs_·th_add_äom_ex‹Á_bufãr
(
Çme
, 
·th
->
nodes
[0],

2053 ()(
œef
 + 1),

2054 
Ën
);

2055 
·»Á_dœ
 = 
found_key
.
off£t
;

2057 
bŒfs_šode_exŒef
 *
exŒef
;

2058 
exŒef
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

2059 
bŒfs_šode_exŒef
);

2060 
Ën
 = 
	`bŒfs_šode_exŒef_Çme_Ën
(
·th
->
nodes
[0], 
exŒef
);

2061 
»t
 = 
	`fs_·th_add_äom_ex‹Á_bufãr
(
Çme
, 
·th
->
nodes
[0],

2062 ()&
exŒef
->
Çme
, 
Ën
);

2063 
·»Á_dœ
 = 
	`bŒfs_šode_exŒef_·»Á
(
·th
->
nodes
[0], 
exŒef
);

2065 ià(
»t
 < 0)

2066 
out
;

2067 
	`bŒfs_»Ëa£_·th
(
·th
);

2069 ià(
dœ_g’
) {

2070 
»t
 = 
	`g‘_šode_g’
(
roÙ
, 
·»Á_dœ
, 
dœ_g’
);

2071 ià(
»t
 < 0)

2072 
out
;

2075 *
dœ
 = 
·»Á_dœ
;

2077 
out
:

2078 
	`bŒfs_ä“_·th
(
·th
);

2079  
»t
;

2080 
	}
}

2082 
	$is_fœ¡_»f
(
bŒfs_roÙ
 *
roÙ
,

2083 
u64
 
šo
, u64 
dœ
,

2084 cÚ¡ *
Çme
, 
Çme_Ën
)

2086 
»t
;

2087 
fs_·th
 *
tmp_Çme
;

2088 
u64
 
tmp_dœ
;

2090 
tmp_Çme
 = 
	`fs_·th_®loc
();

2091 ià(!
tmp_Çme
)

2092  -
ENOMEM
;

2094 
»t
 = 
	`g‘_fœ¡_»f
(
roÙ
, 
šo
, &
tmp_dœ
, 
NULL
, 
tmp_Çme
);

2095 ià(
»t
 < 0)

2096 
out
;

2098 ià(
dœ
 !ğ
tmp_dœ
 || 
Çme_Ën
 !ğ
	`fs_·th_Ën
(
tmp_Çme
)) {

2099 
»t
 = 0;

2100 
out
;

2103 
»t
 = !
	`memcmp
(
tmp_Çme
->
¡¬t
, 
Çme
, 
Çme_Ën
);

2105 
out
:

2106 
	`fs_·th_ä“
(
tmp_Çme
);

2107  
»t
;

2108 
	}
}

2120 
	$wl_ov”wr™e_»f
(
£nd_ùx
 *
sùx
, 
u64
 
dœ
, u64 
dœ_g’
,

2121 cÚ¡ *
Çme
, 
Çme_Ën
,

2122 
u64
 *
who_šo
, u64 *
who_g’
, u64 *
who_mode
)

2124 
»t
;

2125 
u64
 
·»Á_roÙ_dœ_g’
;

2126 
u64
 
Ùh”_šode
 = 0;

2127 
bŒfs_šode_šfo
 
šfo
;

2129 ià(!
sùx
->
·»Á_roÙ
)

2132 
»t
 = 
	`is_šode_exi¡’t
(
sùx
, 
dœ
, 
dœ_g’
, 
NULL
, &
·»Á_roÙ_dœ_g’
);

2133 ià(
»t
 <= 0)

2144 ià(
sùx
->
·»Á_roÙ
 && 
dœ
 !ğ
BTRFS_FIRST_FREE_OBJECTID
 &&

2145 
·»Á_roÙ_dœ_g’
 !ğ
dœ_g’
)

2148 
»t
 = 
	`lookup_dœ_™em_šode
(
sùx
->
·»Á_roÙ
, 
dœ
, 
Çme
, 
Çme_Ën
,

2149 &
Ùh”_šode
);

2150 ià(
»t
 =ğ-
ENOENT
)

2152 ià(
»t
 < 0)

2153  
»t
;

2160 ià(
Ùh”_šode
 > 
sùx
->
£nd_´og»ss
 ||

2161 
	`is_wa™šg_fÜ_move
(
sùx
, 
Ùh”_šode
)) {

2162 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
·»Á_roÙ
, 
Ùh”_šode
, &
šfo
);

2163 ià(
»t
 < 0)

2164  
»t
;

2166 *
who_šo
 = 
Ùh”_šode
;

2167 *
who_g’
 = 
šfo
.
g’
;

2168 *
who_mode
 = 
šfo
.
mode
;

2173 
	}
}

2182 
	$did_ov”wr™e_»f
(
£nd_ùx
 *
sùx
,

2183 
u64
 
dœ
, u64 
dœ_g’
,

2184 
u64
 
šo
, u64 
šo_g’
,

2185 cÚ¡ *
Çme
, 
Çme_Ën
)

2187 
»t
;

2188 
u64
 
ow_šode
;

2189 
u64
 
ow_g’
 = 0;

2190 
u64
 
£nd_roÙ_dœ_g’
;

2192 ià(!
sùx
->
·»Á_roÙ
)

2195 
»t
 = 
	`is_šode_exi¡’t
(
sùx
, 
dœ
, 
dœ_g’
, &
£nd_roÙ_dœ_g’
, 
NULL
);

2196 ià(
»t
 <= 0)

2197  
»t
;

2203 ià(
dœ
 !ğ
BTRFS_FIRST_FREE_OBJECTID
 && 
£nd_roÙ_dœ_g’
 !ğ
dœ_g’
)

2207 
»t
 = 
	`lookup_dœ_™em_šode
(
sùx
->
£nd_roÙ
, 
dœ
, 
Çme
, 
Çme_Ën
,

2208 &
ow_šode
);

2209 ià(
»t
 =ğ-
ENOENT
) {

2212 } ià(
»t
 < 0) {

2213  
»t
;

2216 ià(
ow_šode
 =ğ
šo
) {

2217 
»t
 = 
	`g‘_šode_g’
(
sùx
->
£nd_roÙ
, 
ow_šode
, &
ow_g’
);

2218 ià(
»t
 < 0)

2219  
»t
;

2222 ià(
ow_g’
 =ğ
šo_g’
)

2232 ià(
ow_šode
 < 
sùx
->
£nd_´og»ss
)

2235 ià(
šo
 !ğ
sùx
->
cur_šo
 && 
ow_šode
 == sctx->cur_ino) {

2236 ià(
ow_g’
 == 0) {

2237 
»t
 = 
	`g‘_šode_g’
(
sùx
->
£nd_roÙ
, 
ow_šode
, &
ow_g’
);

2238 ià(
»t
 < 0)

2239  
»t
;

2241 ià(
ow_g’
 =ğ
sùx
->
cur_šode_g’
)

2246 
	}
}

2253 
	$did_ov”wr™e_fœ¡_»f
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
)

2255 
»t
 = 0;

2256 
fs_·th
 *
Çme
 = 
NULL
;

2257 
u64
 
dœ
;

2258 
u64
 
dœ_g’
;

2260 ià(!
sùx
->
·»Á_roÙ
)

2261 
out
;

2263 
Çme
 = 
	`fs_·th_®loc
();

2264 ià(!
Çme
)

2265  -
ENOMEM
;

2267 
»t
 = 
	`g‘_fœ¡_»f
(
sùx
->
·»Á_roÙ
, 
šo
, &
dœ
, &
dœ_g’
, 
Çme
);

2268 ià(
»t
 < 0)

2269 
out
;

2271 
»t
 = 
	`did_ov”wr™e_»f
(
sùx
, 
dœ
, 
dœ_g’
, 
šo
, 
g’
,

2272 
Çme
->
¡¬t
, 
	`fs_·th_Ën
(name));

2274 
out
:

2275 
	`fs_·th_ä“
(
Çme
);

2276  
»t
;

2277 
	}
}

2279 
šlše
 
Çme_ÿche_’Œy
 *
	$Çme_ÿche_£¬ch
(
£nd_ùx
 *
sùx
,

2280 
u64
 
šo
, u64 
g’
)

2282 
bŒfs_Ìu_ÿche_’Œy
 *
’Œy
;

2284 
’Œy
 = 
	`bŒfs_Ìu_ÿche_lookup
(&
sùx
->
Çme_ÿche
, 
šo
, 
g’
);

2285 ià(!
’Œy
)

2286  
NULL
;

2288  
	`cÚš”_of
(
’Œy
, 
Çme_ÿche_’Œy
,ƒntry);

2289 
	}
}

2299 
	$__g‘_cur_Çme_ªd_·»Á
(
£nd_ùx
 *
sùx
,

2300 
u64
 
šo
, u64 
g’
,

2301 
u64
 *
·»Á_šo
,

2302 
u64
 *
·»Á_g’
,

2303 
fs_·th
 *
de¡
)

2305 
»t
;

2306 
nû_»t
;

2307 
Çme_ÿche_’Œy
 *
nû
;

2314 
nû
 = 
	`Çme_ÿche_£¬ch
(
sùx
, 
šo
, 
g’
);

2315 ià(
nû
) {

2316 ià(
šo
 < 
sùx
->
£nd_´og»ss
 && 
nû
->
Ãed_Ï‹r_upd©e
) {

2317 
	`bŒfs_Ìu_ÿche_»move
(&
sùx
->
Çme_ÿche
, &
nû
->
’Œy
);

2318 
nû
 = 
NULL
;

2320 *
·»Á_šo
 = 
nû
->parent_ino;

2321 *
·»Á_g’
 = 
nû
->parent_gen;

2322 
»t
 = 
	`fs_·th_add
(
de¡
, 
nû
->
Çme
,‚û->
Çme_Ën
);

2323 ià(
»t
 < 0)

2324 
out
;

2325 
»t
 = 
nû
->ret;

2326 
out
;

2335 
»t
 = 
	`is_šode_exi¡’t
(
sùx
, 
šo
, 
g’
, 
NULL
, NULL);

2336 ià(
»t
 < 0)

2337 
out
;

2339 ià(!
»t
) {

2340 
»t
 = 
	`g’_unique_Çme
(
sùx
, 
šo
, 
g’
, 
de¡
);

2341 ià(
»t
 < 0)

2342 
out
;

2343 
»t
 = 1;

2344 
out_ÿche
;

2351 ià(
šo
 < 
sùx
->
£nd_´og»ss
)

2352 
»t
 = 
	`g‘_fœ¡_»f
(
sùx
->
£nd_roÙ
, 
šo
,

2353 
·»Á_šo
, 
·»Á_g’
, 
de¡
);

2355 
»t
 = 
	`g‘_fœ¡_»f
(
sùx
->
·»Á_roÙ
, 
šo
,

2356 
·»Á_šo
, 
·»Á_g’
, 
de¡
);

2357 ià(
»t
 < 0)

2358 
out
;

2364 
»t
 = 
	`did_ov”wr™e_»f
(
sùx
, *
·»Á_šo
, *
·»Á_g’
, 
šo
, 
g’
,

2365 
de¡
->
¡¬t
, de¡->
’d
 - dest->start);

2366 ià(
»t
 < 0)

2367 
out
;

2368 ià(
»t
) {

2369 
	`fs_·th_»£t
(
de¡
);

2370 
»t
 = 
	`g’_unique_Çme
(
sùx
, 
šo
, 
g’
, 
de¡
);

2371 ià(
»t
 < 0)

2372 
out
;

2373 
»t
 = 1;

2376 
out_ÿche
:

2380 
nû
 = 
	`km®loc
((*nûè+ 
	`fs_·th_Ën
(
de¡
è+ 1, 
GFP_KERNEL
);

2381 ià(!
nû
) {

2382 
»t
 = -
ENOMEM
;

2383 
out
;

2386 
nû
->
’Œy
.
key
 = 
šo
;

2387 
nû
->
’Œy
.
g’
 = gen;

2388 
nû
->
·»Á_šo
 = *parent_ino;

2389 
nû
->
·»Á_g’
 = *parent_gen;

2390 
nû
->
Çme_Ën
 = 
	`fs_·th_Ën
(
de¡
);

2391 
nû
->
»t
 =„et;

2392 
	`¡rıy
(
nû
->
Çme
, 
de¡
->
¡¬t
);

2394 ià(
šo
 < 
sùx
->
£nd_´og»ss
)

2395 
nû
->
Ãed_Ï‹r_upd©e
 = 0;

2397 
nû
->
Ãed_Ï‹r_upd©e
 = 1;

2399 
nû_»t
 = 
	`bŒfs_Ìu_ÿche_¡Üe
(&
sùx
->
Çme_ÿche
, &
nû
->
’Œy
, 
GFP_KERNEL
);

2400 ià(
nû_»t
 < 0) {

2401 
	`kä“
(
nû
);

2402 
»t
 = 
nû_»t
;

2405 
out
:

2406  
»t
;

2407 
	}
}

2434 
	$g‘_cur_·th
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
,

2435 
fs_·th
 *
de¡
)

2437 
»t
 = 0;

2438 
fs_·th
 *
Çme
 = 
NULL
;

2439 
u64
 
·»Á_šode
 = 0;

2440 
u64
 
·»Á_g’
 = 0;

2441 
¡İ
 = 0;

2443 
Çme
 = 
	`fs_·th_®loc
();

2444 ià(!
Çme
) {

2445 
»t
 = -
ENOMEM
;

2446 
out
;

2449 
de¡
->
»v”£d
 = 1;

2450 
	`fs_·th_»£t
(
de¡
);

2452 !
¡İ
 && 
šo
 !ğ
BTRFS_FIRST_FREE_OBJECTID
) {

2453 
wa™šg_dœ_move
 *
wdm
;

2455 
	`fs_·th_»£t
(
Çme
);

2457 ià(
	`is_wa™šg_fÜ_rm
(
sùx
, 
šo
, 
g’
)) {

2458 
»t
 = 
	`g’_unique_Çme
(
sùx
, 
šo
, 
g’
, 
Çme
);

2459 ià(
»t
 < 0)

2460 
out
;

2461 
»t
 = 
	`fs_·th_add_·th
(
de¡
, 
Çme
);

2465 
wdm
 = 
	`g‘_wa™šg_dœ_move
(
sùx
, 
šo
);

2466 ià(
wdm
 && wdm->
Üphªized
) {

2467 
»t
 = 
	`g’_unique_Çme
(
sùx
, 
šo
, 
g’
, 
Çme
);

2468 
¡İ
 = 1;

2469 } ià(
wdm
) {

2470 
»t
 = 
	`g‘_fœ¡_»f
(
sùx
->
·»Á_roÙ
, 
šo
,

2471 &
·»Á_šode
, &
·»Á_g’
, 
Çme
);

2473 
»t
 = 
	`__g‘_cur_Çme_ªd_·»Á
(
sùx
, 
šo
, 
g’
,

2474 &
·»Á_šode
,

2475 &
·»Á_g’
, 
Çme
);

2476 ià(
»t
)

2477 
¡İ
 = 1;

2480 ià(
»t
 < 0)

2481 
out
;

2483 
»t
 = 
	`fs_·th_add_·th
(
de¡
, 
Çme
);

2484 ià(
»t
 < 0)

2485 
out
;

2487 
šo
 = 
·»Á_šode
;

2488 
g’
 = 
·»Á_g’
;

2491 
out
:

2492 
	`fs_·th_ä“
(
Çme
);

2493 ià(!
»t
)

2494 
	`fs_·th_uÄev”£
(
de¡
);

2495  
»t
;

2496 
	}
}

2501 
	$£nd_subvŞ_begš
(
£nd_ùx
 *
sùx
)

2503 
»t
;

2504 
bŒfs_roÙ
 *
£nd_roÙ
 = 
sùx
->send_root;

2505 
bŒfs_roÙ
 *
·»Á_roÙ
 = 
sùx
->parent_root;

2506 
bŒfs_·th
 *
·th
;

2507 
bŒfs_key
 
key
;

2508 
bŒfs_roÙ_»f
 *
»f
;

2509 
ex‹Á_bufãr
 *
Ëaf
;

2510 *
Çme
 = 
NULL
;

2511 
Çm–’
;

2513 
·th
 = 
	`bŒfs_®loc_·th
();

2514 ià(!
·th
)

2515  -
ENOMEM
;

2517 
Çme
 = 
	`km®loc
(
BTRFS_PATH_NAME_MAX
, 
GFP_KERNEL
);

2518 ià(!
Çme
) {

2519 
	`bŒfs_ä“_·th
(
·th
);

2520  -
ENOMEM
;

2523 
key
.
objeùid
 = 
£nd_roÙ
->
roÙ_key
.objectid;

2524 
key
.
ty³
 = 
BTRFS_ROOT_BACKREF_KEY
;

2525 
key
.
off£t
 = 0;

2527 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
£nd_roÙ
->
fs_šfo
->
Œ“_roÙ
,

2528 &
key
, 
·th
, 1, 0);

2529 ià(
»t
 < 0)

2530 
out
;

2531 ià(
»t
) {

2532 
»t
 = -
ENOENT
;

2533 
out
;

2536 
Ëaf
 = 
·th
->
nodes
[0];

2537 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

2538 ià(
key
.
ty³
 !ğ
BTRFS_ROOT_BACKREF_KEY
 ||

2539 
key
.
objeùid
 !ğ
£nd_roÙ
->
roÙ_key
.objectid) {

2540 
»t
 = -
ENOENT
;

2541 
out
;

2543 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_roÙ_»f
);

2544 
Çm–’
 = 
	`bŒfs_roÙ_»f_Çme_Ën
(
Ëaf
, 
»f
);

2545 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
Çme
, ()(
»f
 + 1), 
Çm–’
);

2546 
	`bŒfs_»Ëa£_·th
(
·th
);

2548 ià(
·»Á_roÙ
) {

2549 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_SNAPSHOT
);

2550 ià(
»t
 < 0)

2551 
out
;

2553 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_SUBVOL
);

2554 ià(
»t
 < 0)

2555 
out
;

2558 
	`TLV_PUT_STRING
(
sùx
, 
BTRFS_SEND_A_PATH
, 
Çme
, 
Çm–’
);

2560 ià(!
	`bŒfs_is_em±y_uuid
(
sùx
->
£nd_roÙ
->
roÙ_™em
.
»ûived_uuid
))

2561 
	`TLV_PUT_UUID
(
sùx
, 
BTRFS_SEND_A_UUID
,

2562 
sùx
->
£nd_roÙ
->
roÙ_™em
.
»ûived_uuid
);

2564 
	`TLV_PUT_UUID
(
sùx
, 
BTRFS_SEND_A_UUID
,

2565 
sùx
->
£nd_roÙ
->
roÙ_™em
.
uuid
);

2567 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_CTRANSID
,

2568 
	`bŒfs_roÙ_ù¿nsid
(&
sùx
->
£nd_roÙ
->
roÙ_™em
));

2569 ià(
·»Á_roÙ
) {

2570 ià(!
	`bŒfs_is_em±y_uuid
(
·»Á_roÙ
->
roÙ_™em
.
»ûived_uuid
))

2571 
	`TLV_PUT_UUID
(
sùx
, 
BTRFS_SEND_A_CLONE_UUID
,

2572 
·»Á_roÙ
->
roÙ_™em
.
»ûived_uuid
);

2574 
	`TLV_PUT_UUID
(
sùx
, 
BTRFS_SEND_A_CLONE_UUID
,

2575 
·»Á_roÙ
->
roÙ_™em
.
uuid
);

2576 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_CLONE_CTRANSID
,

2577 
	`bŒfs_roÙ_ù¿nsid
(&
sùx
->
·»Á_roÙ
->
roÙ_™em
));

2580 
»t
 = 
	`£nd_cmd
(
sùx
);

2582 
v_put_çu»
:

2583 
out
:

2584 
	`bŒfs_ä“_·th
(
·th
);

2585 
	`kä“
(
Çme
);

2586  
»t
;

2587 
	}
}

2589 
	$£nd_Œunÿ‹
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
, u64 
size
)

2591 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

2592 
»t
 = 0;

2593 
fs_·th
 *
p
;

2595 
	`bŒfs_debug
(
fs_šfo
, "£nd_Œunÿ‹ %Îu size=%Îu", 
šo
, 
size
);

2597 
p
 = 
	`fs_·th_®loc
();

2598 ià(!
p
)

2599  -
ENOMEM
;

2601 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_TRUNCATE
);

2602 ià(
»t
 < 0)

2603 
out
;

2605 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
šo
, 
g’
, 
p
);

2606 ià(
»t
 < 0)

2607 
out
;

2608 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

2609 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_SIZE
, 
size
);

2611 
»t
 = 
	`£nd_cmd
(
sùx
);

2613 
v_put_çu»
:

2614 
out
:

2615 
	`fs_·th_ä“
(
p
);

2616  
»t
;

2617 
	}
}

2619 
	$£nd_chmod
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
, u64 
mode
)

2621 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

2622 
»t
 = 0;

2623 
fs_·th
 *
p
;

2625 
	`bŒfs_debug
(
fs_šfo
, "£nd_chmod %Îu mode=%Îu", 
šo
, 
mode
);

2627 
p
 = 
	`fs_·th_®loc
();

2628 ià(!
p
)

2629  -
ENOMEM
;

2631 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_CHMOD
);

2632 ià(
»t
 < 0)

2633 
out
;

2635 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
šo
, 
g’
, 
p
);

2636 ià(
»t
 < 0)

2637 
out
;

2638 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

2639 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_MODE
, 
mode
 & 07777);

2641 
»t
 = 
	`£nd_cmd
(
sùx
);

2643 
v_put_çu»
:

2644 
out
:

2645 
	`fs_·th_ä“
(
p
);

2646  
»t
;

2647 
	}
}

2649 
	$£nd_f—‰r
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
, u64 
f—‰r
)

2651 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

2652 
»t
 = 0;

2653 
fs_·th
 *
p
;

2655 ià(
sùx
->
´Ùo
 < 2)

2658 
	`bŒfs_debug
(
fs_šfo
, "£nd_f—‰¸%Îu f—‰r=%Îu", 
šo
, 
f—‰r
);

2660 
p
 = 
	`fs_·th_®loc
();

2661 ià(!
p
)

2662  -
ENOMEM
;

2664 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_FILEATTR
);

2665 ià(
»t
 < 0)

2666 
out
;

2668 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
šo
, 
g’
, 
p
);

2669 ià(
»t
 < 0)

2670 
out
;

2671 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

2672 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_FILEATTR
, 
f—‰r
);

2674 
»t
 = 
	`£nd_cmd
(
sùx
);

2676 
v_put_çu»
:

2677 
out
:

2678 
	`fs_·th_ä“
(
p
);

2679  
»t
;

2680 
	}
}

2682 
	$£nd_chown
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
, u64 
uid
, u64 
gid
)

2684 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

2685 
»t
 = 0;

2686 
fs_·th
 *
p
;

2688 
	`bŒfs_debug
(
fs_šfo
, "send_chown %llu uid=%llu, gid=%llu",

2689 
šo
, 
uid
, 
gid
);

2691 
p
 = 
	`fs_·th_®loc
();

2692 ià(!
p
)

2693  -
ENOMEM
;

2695 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_CHOWN
);

2696 ià(
»t
 < 0)

2697 
out
;

2699 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
šo
, 
g’
, 
p
);

2700 ià(
»t
 < 0)

2701 
out
;

2702 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

2703 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_UID
, 
uid
);

2704 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_GID
, 
gid
);

2706 
»t
 = 
	`£nd_cmd
(
sùx
);

2708 
v_put_çu»
:

2709 
out
:

2710 
	`fs_·th_ä“
(
p
);

2711  
»t
;

2712 
	}
}

2714 
	$£nd_utimes
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
)

2716 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

2717 
»t
 = 0;

2718 
fs_·th
 *
p
 = 
NULL
;

2719 
bŒfs_šode_™em
 *
ii
;

2720 
bŒfs_·th
 *
·th
 = 
NULL
;

2721 
ex‹Á_bufãr
 *
eb
;

2722 
bŒfs_key
 
key
;

2723 
¦Ù
;

2725 
	`bŒfs_debug
(
fs_šfo
, "£nd_utime %Îu", 
šo
);

2727 
p
 = 
	`fs_·th_®loc
();

2728 ià(!
p
)

2729  -
ENOMEM
;

2731 
·th
 = 
	`®loc_·th_fÜ_£nd
();

2732 ià(!
·th
) {

2733 
»t
 = -
ENOMEM
;

2734 
out
;

2737 
key
.
objeùid
 = 
šo
;

2738 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

2739 
key
.
off£t
 = 0;

2740 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
sùx
->
£nd_roÙ
, &
key
, 
·th
, 0, 0);

2741 ià(
»t
 > 0)

2742 
»t
 = -
ENOENT
;

2743 ià(
»t
 < 0)

2744 
out
;

2746 
eb
 = 
·th
->
nodes
[0];

2747 
¦Ù
 = 
·th
->
¦Ùs
[0];

2748 
ii
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_šode_™em
);

2750 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_UTIMES
);

2751 ià(
»t
 < 0)

2752 
out
;

2754 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
šo
, 
g’
, 
p
);

2755 ià(
»t
 < 0)

2756 
out
;

2757 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

2758 
	`TLV_PUT_BTRFS_TIMESPEC
(
sùx
, 
BTRFS_SEND_A_ATIME
, 
eb
, &
ii
->
©ime
);

2759 
	`TLV_PUT_BTRFS_TIMESPEC
(
sùx
, 
BTRFS_SEND_A_MTIME
, 
eb
, &
ii
->
mtime
);

2760 
	`TLV_PUT_BTRFS_TIMESPEC
(
sùx
, 
BTRFS_SEND_A_CTIME
, 
eb
, &
ii
->
ùime
);

2761 ià(
sùx
->
´Ùo
 >= 2)

2762 
	`TLV_PUT_BTRFS_TIMESPEC
(
sùx
, 
BTRFS_SEND_A_OTIME
, 
eb
, &
ii
->
Ùime
);

2764 
»t
 = 
	`£nd_cmd
(
sùx
);

2766 
v_put_çu»
:

2767 
out
:

2768 
	`fs_·th_ä“
(
p
);

2769 
	`bŒfs_ä“_·th
(
·th
);

2770  
»t
;

2771 
	}
}

2783 
	$ÿche_dœ_utimes
(
£nd_ùx
 *
sùx
, 
u64
 
dœ
, u64 
g’
)

2785 
bŒfs_Ìu_ÿche_’Œy
 *
’Œy
;

2786 
»t
;

2788 
’Œy
 = 
	`bŒfs_Ìu_ÿche_lookup
(&
sùx
->
dœ_utimes_ÿche
, 
dœ
, 
g’
);

2789 ià(
’Œy
 !ğ
NULL
)

2793 
’Œy
 = 
	`km®loc
((*’Œy), 
GFP_KERNEL
);

2794 ià(!
’Œy
)

2795  
	`£nd_utimes
(
sùx
, 
dœ
, 
g’
);

2797 
’Œy
->
key
 = 
dœ
;

2798 
’Œy
->
g’
 = gen;

2800 
»t
 = 
	`bŒfs_Ìu_ÿche_¡Üe
(&
sùx
->
dœ_utimes_ÿche
, 
’Œy
, 
GFP_KERNEL
);

2801 
	`ASSERT
(
»t
 !ğ-
EEXIST
);

2802 ià(
»t
) {

2803 
	`kä“
(
’Œy
);

2804  
	`£nd_utimes
(
sùx
, 
dœ
, 
g’
);

2808 
	}
}

2810 
	$Œim_dœ_utimes_ÿche
(
£nd_ùx
 *
sùx
)

2812 
	`bŒfs_Ìu_ÿche_size
(&
sùx
->
dœ_utimes_ÿche
) >

2813 
SEND_MAX_DIR_UTIMES_CACHE_SIZE
) {

2814 
bŒfs_Ìu_ÿche_’Œy
 *
Ìu
;

2815 
»t
;

2817 
Ìu
 = 
	`bŒfs_Ìu_ÿche_Ìu_’Œy
(&
sùx
->
dœ_utimes_ÿche
);

2818 
	`ASSERT
(
Ìu
 !ğ
NULL
);

2820 
»t
 = 
	`£nd_utimes
(
sùx
, 
Ìu
->
key
,†ru->
g’
);

2821 ià(
»t
)

2822  
»t
;

2824 
	`bŒfs_Ìu_ÿche_»move
(&
sùx
->
dœ_utimes_ÿche
, 
Ìu
);

2828 
	}
}

2835 
	$£nd_ü—‹_šode
(
£nd_ùx
 *
sùx
, 
u64
 
šo
)

2837 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

2838 
»t
 = 0;

2839 
fs_·th
 *
p
;

2840 
cmd
;

2841 
bŒfs_šode_šfo
 
šfo
;

2842 
u64
 
g’
;

2843 
u64
 
mode
;

2844 
u64
 
rdev
;

2846 
	`bŒfs_debug
(
fs_šfo
, "£nd_ü—‹_šod%Îu", 
šo
);

2848 
p
 = 
	`fs_·th_®loc
();

2849 ià(!
p
)

2850  -
ENOMEM
;

2852 ià(
šo
 !ğ
sùx
->
cur_šo
) {

2853 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
£nd_roÙ
, 
šo
, &
šfo
);

2854 ià(
»t
 < 0)

2855 
out
;

2856 
g’
 = 
šfo
.gen;

2857 
mode
 = 
šfo
.mode;

2858 
rdev
 = 
šfo
.rdev;

2860 
g’
 = 
sùx
->
cur_šode_g’
;

2861 
mode
 = 
sùx
->
cur_šode_mode
;

2862 
rdev
 = 
sùx
->
cur_šode_rdev
;

2865 ià(
	`S_ISREG
(
mode
)) {

2866 
cmd
 = 
BTRFS_SEND_C_MKFILE
;

2867 } ià(
	`S_ISDIR
(
mode
)) {

2868 
cmd
 = 
BTRFS_SEND_C_MKDIR
;

2869 } ià(
	`S_ISLNK
(
mode
)) {

2870 
cmd
 = 
BTRFS_SEND_C_SYMLINK
;

2871 } ià(
	`S_ISCHR
(
mode
è|| 
	`S_ISBLK
(mode)) {

2872 
cmd
 = 
BTRFS_SEND_C_MKNOD
;

2873 } ià(
	`S_ISFIFO
(
mode
)) {

2874 
cmd
 = 
BTRFS_SEND_C_MKFIFO
;

2875 } ià(
	`S_ISSOCK
(
mode
)) {

2876 
cmd
 = 
BTRFS_SEND_C_MKSOCK
;

2878 
	`bŒfs_w¬n
(
sùx
->
£nd_roÙ
->
fs_šfo
, "unexpected inodeype %o",

2879 ()(
mode
 & 
S_IFMT
));

2880 
»t
 = -
EOPNOTSUPP
;

2881 
out
;

2884 
»t
 = 
	`begš_cmd
(
sùx
, 
cmd
);

2885 ià(
»t
 < 0)

2886 
out
;

2888 
»t
 = 
	`g’_unique_Çme
(
sùx
, 
šo
, 
g’
, 
p
);

2889 ià(
»t
 < 0)

2890 
out
;

2892 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

2893 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_INO
, 
šo
);

2895 ià(
	`S_ISLNK
(
mode
)) {

2896 
	`fs_·th_»£t
(
p
);

2897 
»t
 = 
	`»ad_symlšk
(
sùx
->
£nd_roÙ
, 
šo
, 
p
);

2898 ià(
»t
 < 0)

2899 
out
;

2900 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH_LINK
, 
p
);

2901 } ià(
	`S_ISCHR
(
mode
è|| 
	`S_ISBLK
(mode) ||

2902 
	`S_ISFIFO
(
mode
è|| 
	`S_ISSOCK
(mode)) {

2903 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_RDEV
, 
	`Ãw_’code_dev
(
rdev
));

2904 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_MODE
, 
mode
);

2907 
»t
 = 
	`£nd_cmd
(
sùx
);

2908 ià(
»t
 < 0)

2909 
out
;

2912 
v_put_çu»
:

2913 
out
:

2914 
	`fs_·th_ä“
(
p
);

2915  
»t
;

2916 
	}
}

2918 
	$ÿche_dœ_ü—‹d
(
£nd_ùx
 *
sùx
, 
u64
 
dœ
)

2920 
bŒfs_Ìu_ÿche_’Œy
 *
’Œy
;

2921 
»t
;

2924 
’Œy
 = 
	`km®loc
((*’Œy), 
GFP_KERNEL
);

2925 ià(!
’Œy
)

2928 
’Œy
->
key
 = 
dœ
;

2929 
’Œy
->
g’
 = 0;

2930 
»t
 = 
	`bŒfs_Ìu_ÿche_¡Üe
(&
sùx
->
dœ_ü—‹d_ÿche
, 
’Œy
, 
GFP_KERNEL
);

2931 ià(
»t
 < 0)

2932 
	`kä“
(
’Œy
);

2933 
	}
}

2940 
	$did_ü—‹_dœ
(
£nd_ùx
 *
sùx
, 
u64
 
dœ
)

2942 
»t
 = 0;

2943 
™”_»t
 = 0;

2944 
bŒfs_·th
 *
·th
 = 
NULL
;

2945 
bŒfs_key
 
key
;

2946 
bŒfs_key
 
found_key
;

2947 
bŒfs_key
 
di_key
;

2948 
bŒfs_dœ_™em
 *
di
;

2950 ià(
	`bŒfs_Ìu_ÿche_lookup
(&
sùx
->
dœ_ü—‹d_ÿche
, 
dœ
, 0))

2953 
·th
 = 
	`®loc_·th_fÜ_£nd
();

2954 ià(!
·th
)

2955  -
ENOMEM
;

2957 
key
.
objeùid
 = 
dœ
;

2958 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

2959 
key
.
off£t
 = 0;

2961 
	`bŒfs_fÜ_—ch_¦Ù
(
sùx
->
£nd_roÙ
, &
key
, &
found_key
, 
·th
, 
™”_»t
) {

2962 
ex‹Á_bufãr
 *
eb
 = 
·th
->
nodes
[0];

2964 ià(
found_key
.
objeùid
 !ğ
key
.objectid ||

2965 
found_key
.
ty³
 !ğ
key
.type) {

2966 
»t
 = 0;

2970 
di
 = 
	`bŒfs_™em_±r
(
eb
, 
·th
->
¦Ùs
[0], 
bŒfs_dœ_™em
);

2971 
	`bŒfs_dœ_™em_key_to_ıu
(
eb
, 
di
, &
di_key
);

2973 ià(
di_key
.
ty³
 !ğ
BTRFS_ROOT_ITEM_KEY
 &&

2974 
di_key
.
objeùid
 < 
sùx
->
£nd_´og»ss
) {

2975 
»t
 = 1;

2976 
	`ÿche_dœ_ü—‹d
(
sùx
, 
dœ
);

2981 ià(
™”_»t
 < 0)

2982 
»t
 = 
™”_»t
;

2984 
	`bŒfs_ä“_·th
(
·th
);

2985  
»t
;

2986 
	}
}

2994 
	$£nd_ü—‹_šode_if_Ãeded
(
£nd_ùx
 *
sùx
)

2996 
»t
;

2998 ià(
	`S_ISDIR
(
sùx
->
cur_šode_mode
)) {

2999 
»t
 = 
	`did_ü—‹_dœ
(
sùx
, sùx->
cur_šo
);

3000 ià(
»t
 < 0)

3001  
»t
;

3002 ià(
»t
 > 0)

3006 
»t
 = 
	`£nd_ü—‹_šode
(
sùx
, sùx->
cur_šo
);

3008 ià(
»t
 =ğ0 && 
	`S_ISDIR
(
sùx
->
cur_šode_mode
))

3009 
	`ÿche_dœ_ü—‹d
(
sùx
, sùx->
cur_šo
);

3011  
»t
;

3012 
	}
}

3014 
	s»cÜded_»f
 {

3015 
li¡_h—d
 
	mli¡
;

3016 *
	mÇme
;

3017 
fs_·th
 *
	mfuÎ_·th
;

3018 
u64
 
	mdœ
;

3019 
u64
 
	mdœ_g’
;

3020 
	mÇme_Ën
;

3021 
rb_node
 
	mnode
;

3022 
rb_roÙ
 *
	mroÙ
;

3025 
»cÜded_»f
 *
	$»cÜded_»f_®loc
()

3027 
»cÜded_»f
 *
»f
;

3029 
»f
 = 
	`kz®loc
((*»f), 
GFP_KERNEL
);

3030 ià(!
»f
)

3031  
NULL
;

3032 
	`RB_CLEAR_NODE
(&
»f
->
node
);

3033 
	`INIT_LIST_HEAD
(&
»f
->
li¡
);

3034  
»f
;

3035 
	}
}

3037 
	$»cÜded_»f_ä“
(
»cÜded_»f
 *
»f
)

3039 ià(!
»f
)

3041 ià(!
	`RB_EMPTY_NODE
(&
»f
->
node
))

3042 
	`rb_”a£
(&
»f
->
node
,„ef->
roÙ
);

3043 
	`li¡_d–
(&
»f
->
li¡
);

3044 
	`fs_·th_ä“
(
»f
->
fuÎ_·th
);

3045 
	`kä“
(
»f
);

3046 
	}
}

3048 
	$£t_»f_·th
(
»cÜded_»f
 *
»f
, 
fs_·th
 *
·th
)

3050 
»f
->
fuÎ_·th
 = 
·th
;

3051 
»f
->
Çme
 = (*)
	`kba£Çme
Ôef->
fuÎ_·th
->
¡¬t
);

3052 
»f
->
Çme_Ën
 =„ef->
fuÎ_·th
->
’d
 -„ef->
Çme
;

3053 
	}
}

3055 
	$dup_»f
(
»cÜded_»f
 *
»f
, 
li¡_h—d
 *
li¡
)

3057 
»cÜded_»f
 *
Ãw
;

3059 
Ãw
 = 
	`»cÜded_»f_®loc
();

3060 ià(!
Ãw
)

3061  -
ENOMEM
;

3063 
Ãw
->
dœ
 = 
»f
->dir;

3064 
Ãw
->
dœ_g’
 = 
»f
->dir_gen;

3065 
	`li¡_add_
(&
Ãw
->
li¡
,†ist);

3067 
	}
}

3069 
	$__ä“_»cÜded_»fs
(
li¡_h—d
 *
h—d
)

3071 
»cÜded_»f
 *
cur
;

3073 !
	`li¡_em±y
(
h—d
)) {

3074 
cur
 = 
	`li¡_’Œy
(
h—d
->
Ãxt
, 
»cÜded_»f
, 
li¡
);

3075 
	`»cÜded_»f_ä“
(
cur
);

3077 
	}
}

3079 
	$ä“_»cÜded_»fs
(
£nd_ùx
 *
sùx
)

3081 
	`__ä“_»cÜded_»fs
(&
sùx
->
Ãw_»fs
);

3082 
	`__ä“_»cÜded_»fs
(&
sùx
->
d–‘ed_»fs
);

3083 
	}
}

3090 
	$Üphªize_šode
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
,

3091 
fs_·th
 *
·th
)

3093 
»t
;

3094 
fs_·th
 *
Üphª
;

3096 
Üphª
 = 
	`fs_·th_®loc
();

3097 ià(!
Üphª
)

3098  -
ENOMEM
;

3100 
»t
 = 
	`g’_unique_Çme
(
sùx
, 
šo
, 
g’
, 
Üphª
);

3101 ià(
»t
 < 0)

3102 
out
;

3104 
»t
 = 
	`£nd_»Çme
(
sùx
, 
·th
, 
Üphª
);

3106 
out
:

3107 
	`fs_·th_ä“
(
Üphª
);

3108  
»t
;

3109 
	}
}

3111 
Üphª_dœ_šfo
 *
	$add_Üphª_dœ_šfo
(
£nd_ùx
 *
sùx
,

3112 
u64
 
dœ_šo
, u64 
dœ_g’
)

3114 
rb_node
 **
p
 = &
sùx
->
Üphª_dœs
.rb_node;

3115 
rb_node
 *
·»Á
 = 
NULL
;

3116 
Üphª_dœ_šfo
 *
’Œy
, *
odi
;

3118 *
p
) {

3119 
·»Á
 = *
p
;

3120 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
Üphª_dœ_šfo
, 
node
);

3121 ià(
dœ_šo
 < 
’Œy
->
šo
)

3122 
p
 = &(*p)->
rb_Ëá
;

3123 ià(
dœ_šo
 > 
’Œy
->
šo
)

3124 
p
 = &(*p)->
rb_right
;

3125 ià(
dœ_g’
 < 
’Œy
->
g’
)

3126 
p
 = &(*p)->
rb_Ëá
;

3127 ià(
dœ_g’
 > 
’Œy
->
g’
)

3128 
p
 = &(*p)->
rb_right
;

3130  
’Œy
;

3133 
odi
 = 
	`km®loc
((*odi), 
GFP_KERNEL
);

3134 ià(!
odi
)

3135  
	`ERR_PTR
(-
ENOMEM
);

3136 
odi
->
šo
 = 
dœ_šo
;

3137 
odi
->
g’
 = 
dœ_g’
;

3138 
odi
->
Ï¡_dœ_šdex_off£t
 = 0;

3139 
odi
->
dœ_high_£q_šo
 = 0;

3141 
	`rb_lšk_node
(&
odi
->
node
, 
·»Á
, 
p
);

3142 
	`rb_š£¹_cŞÜ
(&
odi
->
node
, &
sùx
->
Üphª_dœs
);

3143  
odi
;

3144 
	}
}

3146 
Üphª_dœ_šfo
 *
	$g‘_Üphª_dœ_šfo
(
£nd_ùx
 *
sùx
,

3147 
u64
 
dœ_šo
, u64 
g’
)

3149 
rb_node
 *
n
 = 
sùx
->
Üphª_dœs
.rb_node;

3150 
Üphª_dœ_šfo
 *
’Œy
;

3152 
n
) {

3153 
’Œy
 = 
	`rb_’Œy
(
n
, 
Üphª_dœ_šfo
, 
node
);

3154 ià(
dœ_šo
 < 
’Œy
->
šo
)

3155 
n
 =‚->
rb_Ëá
;

3156 ià(
dœ_šo
 > 
’Œy
->
šo
)

3157 
n
 =‚->
rb_right
;

3158 ià(
g’
 < 
’Œy
->gen)

3159 
n
 =‚->
rb_Ëá
;

3160 ià(
g’
 > 
’Œy
->gen)

3161 
n
 =‚->
rb_right
;

3163  
’Œy
;

3165  
NULL
;

3166 
	}
}

3168 
	$is_wa™šg_fÜ_rm
(
£nd_ùx
 *
sùx
, 
u64
 
dœ_šo
, u64 
g’
)

3170 
Üphª_dœ_šfo
 *
odi
 = 
	`g‘_Üphª_dœ_šfo
(
sùx
, 
dœ_šo
, 
g’
);

3172  
odi
 !ğ
NULL
;

3173 
	}
}

3175 
	$ä“_Üphª_dœ_šfo
(
£nd_ùx
 *
sùx
,

3176 
Üphª_dœ_šfo
 *
odi
)

3178 ià(!
odi
)

3180 
	`rb_”a£
(&
odi
->
node
, &
sùx
->
Üphª_dœs
);

3181 
	`kä“
(
odi
);

3182 
	}
}

3189 
	$ÿn_rmdœ
(
£nd_ùx
 *
sùx
, 
u64
 
dœ
, u64 
dœ_g’
)

3191 
»t
 = 0;

3192 
™”_»t
 = 0;

3193 
bŒfs_roÙ
 *
roÙ
 = 
sùx
->
·»Á_roÙ
;

3194 
bŒfs_·th
 *
·th
;

3195 
bŒfs_key
 
key
;

3196 
bŒfs_key
 
found_key
;

3197 
bŒfs_key
 
loc
;

3198 
bŒfs_dœ_™em
 *
di
;

3199 
Üphª_dœ_šfo
 *
odi
 = 
NULL
;

3200 
u64
 
dœ_high_£q_šo
 = 0;

3201 
u64
 
Ï¡_dœ_šdex_off£t
 = 0;

3206 ià(
dœ
 =ğ
BTRFS_FIRST_FREE_OBJECTID
)

3209 
odi
 = 
	`g‘_Üphª_dœ_šfo
(
sùx
, 
dœ
, 
dœ_g’
);

3210 ià(
odi
 && 
sùx
->
cur_šo
 < odi->
dœ_high_£q_šo
)

3213 
·th
 = 
	`®loc_·th_fÜ_£nd
();

3214 ià(!
·th
)

3215  -
ENOMEM
;

3217 ià(!
odi
) {

3226 
key
.
objeùid
 = 
dœ
;

3227 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

3228 
key
.
off£t
 = (
u64
)-1;

3230 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

3231 ià(
»t
 < 0) {

3232 
out
;

3233 } ià(
»t
 > 0) {

3235 
	`ASSERT
(
·th
->
¦Ùs
[0] > 0);

3236 ià(
	`WARN_ON
(
·th
->
¦Ùs
[0] == 0)) {

3237 
»t
 = -
EUCLEAN
;

3238 
out
;

3240 
·th
->
¦Ùs
[0]--;

3243 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

3244 ià(
key
.
objeùid
 !ğ
dœ
 || key.
ty³
 !ğ
BTRFS_DIR_INDEX_KEY
) {

3246 
»t
 = 1;

3247 
out
;

3250 
di
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

3251 
bŒfs_dœ_™em
);

3252 
	`bŒfs_dœ_™em_key_to_ıu
(
·th
->
nodes
[0], 
di
, &
loc
);

3253 
dœ_high_£q_šo
 = 
loc
.
objeùid
;

3254 ià(
sùx
->
cur_šo
 < 
dœ_high_£q_šo
) {

3255 
»t
 = 0;

3256 
out
;

3259 
	`bŒfs_»Ëa£_·th
(
·th
);

3262 
key
.
objeùid
 = 
dœ
;

3263 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

3264 
key
.
off£t
 = (
odi
 ? odi->
Ï¡_dœ_šdex_off£t
 : 0);

3266 
	`bŒfs_fÜ_—ch_¦Ù
(
roÙ
, &
key
, &
found_key
, 
·th
, 
™”_»t
) {

3267 
wa™šg_dœ_move
 *
dm
;

3269 ià(
found_key
.
objeùid
 !ğ
key
.objectid ||

3270 
found_key
.
ty³
 !ğ
key
.type)

3273 
di
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

3274 
bŒfs_dœ_™em
);

3275 
	`bŒfs_dœ_™em_key_to_ıu
(
·th
->
nodes
[0], 
di
, &
loc
);

3277 
dœ_high_£q_šo
 = 
	`max
(dœ_high_£q_šo, 
loc
.
objeùid
);

3278 
Ï¡_dœ_šdex_off£t
 = 
found_key
.
off£t
;

3280 
dm
 = 
	`g‘_wa™šg_dœ_move
(
sùx
, 
loc
.
objeùid
);

3281 ià(
dm
) {

3282 
dm
->
rmdœ_šo
 = 
dœ
;

3283 
dm
->
rmdœ_g’
 = 
dœ_g’
;

3284 
»t
 = 0;

3285 
out
;

3288 ià(
loc
.
objeùid
 > 
sùx
->
cur_šo
) {

3289 
»t
 = 0;

3290 
out
;

3293 ià(
™”_»t
 < 0) {

3294 
»t
 = 
™”_»t
;

3295 
out
;

3297 
	`ä“_Üphª_dœ_šfo
(
sùx
, 
odi
);

3299 
»t
 = 1;

3301 
out
:

3302 
	`bŒfs_ä“_·th
(
·th
);

3304 ià(
»t
)

3305  
»t
;

3307 ià(!
odi
) {

3308 
odi
 = 
	`add_Üphª_dœ_šfo
(
sùx
, 
dœ
, 
dœ_g’
);

3309 ià(
	`IS_ERR
(
odi
))

3310  
	`PTR_ERR
(
odi
);

3312 
odi
->
g’
 = 
dœ_g’
;

3315 
odi
->
Ï¡_dœ_šdex_off£t
 =†ast_dir_index_offset;

3316 
odi
->
dœ_high_£q_šo
 = 
	`max
(odi->dir_high_seq_ino, dir_high_seq_ino);

3319 
	}
}

3321 
	$is_wa™šg_fÜ_move
(
£nd_ùx
 *
sùx
, 
u64
 
šo
)

3323 
wa™šg_dœ_move
 *
’Œy
 = 
	`g‘_wa™šg_dœ_move
(
sùx
, 
šo
);

3325  
’Œy
 !ğ
NULL
;

3326 
	}
}

3328 
	$add_wa™šg_dœ_move
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, 
boŞ
 
Üphªized
)

3330 
rb_node
 **
p
 = &
sùx
->
wa™šg_dœ_moves
.rb_node;

3331 
rb_node
 *
·»Á
 = 
NULL
;

3332 
wa™šg_dœ_move
 *
’Œy
, *
dm
;

3334 
dm
 = 
	`km®loc
((*dm), 
GFP_KERNEL
);

3335 ià(!
dm
)

3336  -
ENOMEM
;

3337 
dm
->
šo
 = ino;

3338 
dm
->
rmdœ_šo
 = 0;

3339 
dm
->
rmdœ_g’
 = 0;

3340 
dm
->
Üphªized
 = orphanized;

3342 *
p
) {

3343 
·»Á
 = *
p
;

3344 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
wa™šg_dœ_move
, 
node
);

3345 ià(
šo
 < 
’Œy
->ino) {

3346 
p
 = &(*p)->
rb_Ëá
;

3347 } ià(
šo
 > 
’Œy
->ino) {

3348 
p
 = &(*p)->
rb_right
;

3350 
	`kä“
(
dm
);

3351  -
EEXIST
;

3355 
	`rb_lšk_node
(&
dm
->
node
, 
·»Á
, 
p
);

3356 
	`rb_š£¹_cŞÜ
(&
dm
->
node
, &
sùx
->
wa™šg_dœ_moves
);

3358 
	}
}

3360 
wa™šg_dœ_move
 *

3361 
	$g‘_wa™šg_dœ_move
(
£nd_ùx
 *
sùx
, 
u64
 
šo
)

3363 
rb_node
 *
n
 = 
sùx
->
wa™šg_dœ_moves
.rb_node;

3364 
wa™šg_dœ_move
 *
’Œy
;

3366 
n
) {

3367 
’Œy
 = 
	`rb_’Œy
(
n
, 
wa™šg_dœ_move
, 
node
);

3368 ià(
šo
 < 
’Œy
->ino)

3369 
n
 =‚->
rb_Ëá
;

3370 ià(
šo
 > 
’Œy
->ino)

3371 
n
 =‚->
rb_right
;

3373  
’Œy
;

3375  
NULL
;

3376 
	}
}

3378 
	$ä“_wa™šg_dœ_move
(
£nd_ùx
 *
sùx
,

3379 
wa™šg_dœ_move
 *
dm
)

3381 ià(!
dm
)

3383 
	`rb_”a£
(&
dm
->
node
, &
sùx
->
wa™šg_dœ_moves
);

3384 
	`kä“
(
dm
);

3385 
	}
}

3387 
	$add_³ndšg_dœ_move
(
£nd_ùx
 *
sùx
,

3388 
u64
 
šo
,

3389 
u64
 
šo_g’
,

3390 
u64
 
·»Á_šo
,

3391 
li¡_h—d
 *
Ãw_»fs
,

3392 
li¡_h—d
 *
d–‘ed_»fs
,

3393 cÚ¡ 
boŞ
 
is_Üphª
)

3395 
rb_node
 **
p
 = &
sùx
->
³ndšg_dœ_moves
.rb_node;

3396 
rb_node
 *
·»Á
 = 
NULL
;

3397 
³ndšg_dœ_move
 *
’Œy
 = 
NULL
, *
pm
;

3398 
»cÜded_»f
 *
cur
;

3399 
exi¡s
 = 0;

3400 
»t
;

3402 
pm
 = 
	`km®loc
((*pm), 
GFP_KERNEL
);

3403 ià(!
pm
)

3404  -
ENOMEM
;

3405 
pm
->
·»Á_šo
 =…arent_ino;

3406 
pm
->
šo
 = ino;

3407 
pm
->
g’
 = 
šo_g’
;

3408 
	`INIT_LIST_HEAD
(&
pm
->
li¡
);

3409 
	`INIT_LIST_HEAD
(&
pm
->
upd©e_»fs
);

3410 
	`RB_CLEAR_NODE
(&
pm
->
node
);

3412 *
p
) {

3413 
·»Á
 = *
p
;

3414 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
³ndšg_dœ_move
, 
node
);

3415 ià(
·»Á_šo
 < 
’Œy
->parent_ino) {

3416 
p
 = &(*p)->
rb_Ëá
;

3417 } ià(
·»Á_šo
 > 
’Œy
->parent_ino) {

3418 
p
 = &(*p)->
rb_right
;

3420 
exi¡s
 = 1;

3425 
	`li¡_fÜ_—ch_’Œy
(
cur
, 
d–‘ed_»fs
, 
li¡
) {

3426 
»t
 = 
	`dup_»f
(
cur
, &
pm
->
upd©e_»fs
);

3427 ià(
»t
 < 0)

3428 
out
;

3430 
	`li¡_fÜ_—ch_’Œy
(
cur
, 
Ãw_»fs
, 
li¡
) {

3431 
»t
 = 
	`dup_»f
(
cur
, &
pm
->
upd©e_»fs
);

3432 ià(
»t
 < 0)

3433 
out
;

3436 
»t
 = 
	`add_wa™šg_dœ_move
(
sùx
, 
pm
->
šo
, 
is_Üphª
);

3437 ià(
»t
)

3438 
out
;

3440 ià(
exi¡s
) {

3441 
	`li¡_add_
(&
pm
->
li¡
, &
’Œy
->list);

3443 
	`rb_lšk_node
(&
pm
->
node
, 
·»Á
, 
p
);

3444 
	`rb_š£¹_cŞÜ
(&
pm
->
node
, &
sùx
->
³ndšg_dœ_moves
);

3446 
»t
 = 0;

3447 
out
:

3448 ià(
»t
) {

3449 
	`__ä“_»cÜded_»fs
(&
pm
->
upd©e_»fs
);

3450 
	`kä“
(
pm
);

3452  
»t
;

3453 
	}
}

3455 
³ndšg_dœ_move
 *
	$g‘_³ndšg_dœ_moves
(
£nd_ùx
 *
sùx
,

3456 
u64
 
·»Á_šo
)

3458 
rb_node
 *
n
 = 
sùx
->
³ndšg_dœ_moves
.rb_node;

3459 
³ndšg_dœ_move
 *
’Œy
;

3461 
n
) {

3462 
’Œy
 = 
	`rb_’Œy
(
n
, 
³ndšg_dœ_move
, 
node
);

3463 ià(
·»Á_šo
 < 
’Œy
->parent_ino)

3464 
n
 =‚->
rb_Ëá
;

3465 ià(
·»Á_šo
 > 
’Œy
->parent_ino)

3466 
n
 =‚->
rb_right
;

3468  
’Œy
;

3470  
NULL
;

3471 
	}
}

3473 
	$·th_loİ
(
£nd_ùx
 *
sùx
, 
fs_·th
 *
Çme
,

3474 
u64
 
šo
, u64 
g’
, u64 *
ªû¡Ü_šo
)

3476 
»t
 = 0;

3477 
u64
 
·»Á_šode
 = 0;

3478 
u64
 
·»Á_g’
 = 0;

3479 
u64
 
¡¬t_šo
 = 
šo
;

3481 *
ªû¡Ü_šo
 = 0;

3482 
šo
 !ğ
BTRFS_FIRST_FREE_OBJECTID
) {

3483 
	`fs_·th_»£t
(
Çme
);

3485 ià(
	`is_wa™šg_fÜ_rm
(
sùx
, 
šo
, 
g’
))

3487 ià(
	`is_wa™šg_fÜ_move
(
sùx
, 
šo
)) {

3488 ià(*
ªû¡Ü_šo
 == 0)

3489 *
ªû¡Ü_šo
 = 
šo
;

3490 
»t
 = 
	`g‘_fœ¡_»f
(
sùx
->
·»Á_roÙ
, 
šo
,

3491 &
·»Á_šode
, &
·»Á_g’
, 
Çme
);

3493 
»t
 = 
	`__g‘_cur_Çme_ªd_·»Á
(
sùx
, 
šo
, 
g’
,

3494 &
·»Á_šode
,

3495 &
·»Á_g’
, 
Çme
);

3496 ià(
»t
 > 0) {

3497 
»t
 = 0;

3501 ià(
»t
 < 0)

3503 ià(
·»Á_šode
 =ğ
¡¬t_šo
) {

3504 
»t
 = 1;

3505 ià(*
ªû¡Ü_šo
 == 0)

3506 *
ªû¡Ü_šo
 = 
šo
;

3509 
šo
 = 
·»Á_šode
;

3510 
g’
 = 
·»Á_g’
;

3512  
»t
;

3513 
	}
}

3515 
	$­¶y_dœ_move
(
£nd_ùx
 *
sùx
, 
³ndšg_dœ_move
 *
pm
)

3517 
fs_·th
 *
äom_·th
 = 
NULL
;

3518 
fs_·th
 *
to_·th
 = 
NULL
;

3519 
fs_·th
 *
Çme
 = 
NULL
;

3520 
u64
 
Üig_´og»ss
 = 
sùx
->
£nd_´og»ss
;

3521 
»cÜded_»f
 *
cur
;

3522 
u64
 
·»Á_šo
, 
·»Á_g’
;

3523 
wa™šg_dœ_move
 *
dm
 = 
NULL
;

3524 
u64
 
rmdœ_šo
 = 0;

3525 
u64
 
rmdœ_g’
;

3526 
u64
 
ªû¡Ü
;

3527 
boŞ
 
is_Üphª
;

3528 
»t
;

3530 
Çme
 = 
	`fs_·th_®loc
();

3531 
äom_·th
 = 
	`fs_·th_®loc
();

3532 ià(!
Çme
 || !
äom_·th
) {

3533 
»t
 = -
ENOMEM
;

3534 
out
;

3537 
dm
 = 
	`g‘_wa™šg_dœ_move
(
sùx
, 
pm
->
šo
);

3538 
	`ASSERT
(
dm
);

3539 
rmdœ_šo
 = 
dm
->rmdir_ino;

3540 
rmdœ_g’
 = 
dm
->rmdir_gen;

3541 
is_Üphª
 = 
dm
->
Üphªized
;

3542 
	`ä“_wa™šg_dœ_move
(
sùx
, 
dm
);

3544 ià(
is_Üphª
) {

3545 
»t
 = 
	`g’_unique_Çme
(
sùx
, 
pm
->
šo
,

3546 
pm
->
g’
, 
äom_·th
);

3548 
»t
 = 
	`g‘_fœ¡_»f
(
sùx
->
·»Á_roÙ
, 
pm
->
šo
,

3549 &
·»Á_šo
, &
·»Á_g’
, 
Çme
);

3550 ià(
»t
 < 0)

3551 
out
;

3552 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
·»Á_šo
, 
·»Á_g’
,

3553 
äom_·th
);

3554 ià(
»t
 < 0)

3555 
out
;

3556 
»t
 = 
	`fs_·th_add_·th
(
äom_·th
, 
Çme
);

3558 ià(
»t
 < 0)

3559 
out
;

3561 
sùx
->
£nd_´og»ss
 = sùx->
cur_šo
 + 1;

3562 
»t
 = 
	`·th_loİ
(
sùx
, 
Çme
, 
pm
->
šo
,…m->
g’
, &
ªû¡Ü
);

3563 ià(
»t
 < 0)

3564 
out
;

3565 ià(
»t
) {

3566 
	`LIST_HEAD
(
d–‘ed_»fs
);

3567 
	`ASSERT
(
ªû¡Ü
 > 
BTRFS_FIRST_FREE_OBJECTID
);

3568 
»t
 = 
	`add_³ndšg_dœ_move
(
sùx
, 
pm
->
šo
,…m->
g’
, 
ªû¡Ü
,

3569 &
pm
->
upd©e_»fs
, &
d–‘ed_»fs
,

3570 
is_Üphª
);

3571 ià(
»t
 < 0)

3572 
out
;

3573 ià(
rmdœ_šo
) {

3574 
dm
 = 
	`g‘_wa™šg_dœ_move
(
sùx
, 
pm
->
šo
);

3575 
	`ASSERT
(
dm
);

3576 
dm
->
rmdœ_šo
 =„mdir_ino;

3577 
dm
->
rmdœ_g’
 =„mdir_gen;

3579 
out
;

3581 
	`fs_·th_»£t
(
Çme
);

3582 
to_·th
 = 
Çme
;

3583 
Çme
 = 
NULL
;

3584 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
pm
->
šo
,…m->
g’
, 
to_·th
);

3585 ià(
»t
 < 0)

3586 
out
;

3588 
»t
 = 
	`£nd_»Çme
(
sùx
, 
äom_·th
, 
to_·th
);

3589 ià(
»t
 < 0)

3590 
out
;

3592 ià(
rmdœ_šo
) {

3593 
Üphª_dœ_šfo
 *
odi
;

3594 
u64
 
g’
;

3596 
odi
 = 
	`g‘_Üphª_dœ_šfo
(
sùx
, 
rmdœ_šo
, 
rmdœ_g’
);

3597 ià(!
odi
) {

3599 
fšish
;

3601 
g’
 = 
odi
->gen;

3603 
»t
 = 
	`ÿn_rmdœ
(
sùx
, 
rmdœ_šo
, 
g’
);

3604 ià(
»t
 < 0)

3605 
out
;

3606 ià(!
»t
)

3607 
fšish
;

3609 
Çme
 = 
	`fs_·th_®loc
();

3610 ià(!
Çme
) {

3611 
»t
 = -
ENOMEM
;

3612 
out
;

3614 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
rmdœ_šo
, 
g’
, 
Çme
);

3615 ià(
»t
 < 0)

3616 
out
;

3617 
»t
 = 
	`£nd_rmdœ
(
sùx
, 
Çme
);

3618 ià(
»t
 < 0)

3619 
out
;

3622 
fšish
:

3623 
»t
 = 
	`ÿche_dœ_utimes
(
sùx
, 
pm
->
šo
,…m->
g’
);

3624 ià(
»t
 < 0)

3625 
out
;

3631 
	`li¡_fÜ_—ch_’Œy
(
cur
, &
pm
->
upd©e_»fs
, 
li¡
) {

3635 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
£nd_roÙ
, 
cur
->
dœ
, 
NULL
);

3636 ià(
»t
 =ğ-
ENOENT
) {

3637 
»t
 = 0;

3640 ià(
»t
 < 0)

3641 
out
;

3643 
»t
 = 
	`ÿche_dœ_utimes
(
sùx
, 
cur
->
dœ
, cur->
dœ_g’
);

3644 ià(
»t
 < 0)

3645 
out
;

3648 
out
:

3649 
	`fs_·th_ä“
(
Çme
);

3650 
	`fs_·th_ä“
(
äom_·th
);

3651 
	`fs_·th_ä“
(
to_·th
);

3652 
sùx
->
£nd_´og»ss
 = 
Üig_´og»ss
;

3654  
»t
;

3655 
	}
}

3657 
	$ä“_³ndšg_move
(
£nd_ùx
 *
sùx
, 
³ndšg_dœ_move
 *
m
)

3659 ià(!
	`li¡_em±y
(&
m
->
li¡
))

3660 
	`li¡_d–
(&
m
->
li¡
);

3661 ià(!
	`RB_EMPTY_NODE
(&
m
->
node
))

3662 
	`rb_”a£
(&
m
->
node
, &
sùx
->
³ndšg_dœ_moves
);

3663 
	`__ä“_»cÜded_»fs
(&
m
->
upd©e_»fs
);

3664 
	`kä“
(
m
);

3665 
	}
}

3667 
	$_­³nd_³ndšg_moves
(
£nd_ùx
 *
sùx
,

3668 
³ndšg_dœ_move
 *
moves
,

3669 
li¡_h—d
 *
¡ack
)

3671 ià(
	`li¡_em±y
(&
moves
->
li¡
)) {

3672 
	`li¡_add_
(&
moves
->
li¡
, 
¡ack
);

3674 
	`LIST_HEAD
(
li¡
);

3675 
	`li¡_¥liû_š™
(&
moves
->
li¡
, &list);

3676 
	`li¡_add_
(&
moves
->
li¡
, 
¡ack
);

3677 
	`li¡_¥liû_
(&
li¡
, 
¡ack
);

3679 ià(!
	`RB_EMPTY_NODE
(&
moves
->
node
)) {

3680 
	`rb_”a£
(&
moves
->
node
, &
sùx
->
³ndšg_dœ_moves
);

3681 
	`RB_CLEAR_NODE
(&
moves
->
node
);

3683 
	}
}

3685 
	$­¶y_chd»n_dœ_moves
(
£nd_ùx
 *
sùx
)

3687 
³ndšg_dœ_move
 *
pm
;

3688 
	`LIST_HEAD
(
¡ack
);

3689 
u64
 
·»Á_šo
 = 
sùx
->
cur_šo
;

3690 
»t
 = 0;

3692 
pm
 = 
	`g‘_³ndšg_dœ_moves
(
sùx
, 
·»Á_šo
);

3693 ià(!
pm
)

3696 
	`_­³nd_³ndšg_moves
(
sùx
, 
pm
, &
¡ack
);

3698 !
	`li¡_em±y
(&
¡ack
)) {

3699 
pm
 = 
	`li¡_fœ¡_’Œy
(&
¡ack
, 
³ndšg_dœ_move
, 
li¡
);

3700 
·»Á_šo
 = 
pm
->
šo
;

3701 
»t
 = 
	`­¶y_dœ_move
(
sùx
, 
pm
);

3702 
	`ä“_³ndšg_move
(
sùx
, 
pm
);

3703 ià(
»t
)

3704 
out
;

3705 
pm
 = 
	`g‘_³ndšg_dœ_moves
(
sùx
, 
·»Á_šo
);

3706 ià(
pm
)

3707 
	`_­³nd_³ndšg_moves
(
sùx
, 
pm
, &
¡ack
);

3711 
out
:

3712 !
	`li¡_em±y
(&
¡ack
)) {

3713 
pm
 = 
	`li¡_fœ¡_’Œy
(&
¡ack
, 
³ndšg_dœ_move
, 
li¡
);

3714 
	`ä“_³ndšg_move
(
sùx
, 
pm
);

3716  
»t
;

3717 
	}
}

3755 
	$wa™_fÜ_de¡_dœ_move
(
£nd_ùx
 *
sùx
,

3756 
»cÜded_»f
 *
·»Á_»f
,

3757 cÚ¡ 
boŞ
 
is_Üphª
)

3759 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
·»Á_roÙ
->fs_info;

3760 
bŒfs_·th
 *
·th
;

3761 
bŒfs_key
 
key
;

3762 
bŒfs_key
 
di_key
;

3763 
bŒfs_dœ_™em
 *
di
;

3764 
u64
 
Ëá_g’
;

3765 
u64
 
right_g’
;

3766 
»t
 = 0;

3767 
wa™šg_dœ_move
 *
wdm
;

3769 ià(
	`RB_EMPTY_ROOT
(&
sùx
->
wa™šg_dœ_moves
))

3772 
·th
 = 
	`®loc_·th_fÜ_£nd
();

3773 ià(!
·th
)

3774  -
ENOMEM
;

3776 
key
.
objeùid
 = 
·»Á_»f
->
dœ
;

3777 
key
.
ty³
 = 
BTRFS_DIR_ITEM_KEY
;

3778 
key
.
off£t
 = 
	`bŒfs_Çme_hash
(
·»Á_»f
->
Çme
,…¬’t_»f->
Çme_Ën
);

3780 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
sùx
->
·»Á_roÙ
, &
key
, 
·th
, 0, 0);

3781 ià(
»t
 < 0) {

3782 
out
;

3783 } ià(
»t
 > 0) {

3784 
»t
 = 0;

3785 
out
;

3788 
di
 = 
	`bŒfs_m©ch_dœ_™em_Çme
(
fs_šfo
, 
·th
, 
·»Á_»f
->
Çme
,

3789 
·»Á_»f
->
Çme_Ën
);

3790 ià(!
di
) {

3791 
»t
 = 0;

3792 
out
;

3802 
	`bŒfs_dœ_™em_key_to_ıu
(
·th
->
nodes
[0], 
di
, &
di_key
);

3803 ià(
di_key
.
ty³
 !ğ
BTRFS_INODE_ITEM_KEY
) {

3804 
»t
 = 0;

3805 
out
;

3808 
»t
 = 
	`g‘_šode_g’
(
sùx
->
·»Á_roÙ
, 
di_key
.
objeùid
, &
Ëá_g’
);

3809 ià(
»t
 < 0)

3810 
out
;

3811 
»t
 = 
	`g‘_šode_g’
(
sùx
->
£nd_roÙ
, 
di_key
.
objeùid
, &
right_g’
);

3812 ià(
»t
 < 0) {

3813 ià(
»t
 =ğ-
ENOENT
)

3814 
»t
 = 0;

3815 
out
;

3819 ià(
right_g’
 !ğ
Ëá_g’
) {

3820 
»t
 = 0;

3821 
out
;

3824 
wdm
 = 
	`g‘_wa™šg_dœ_move
(
sùx
, 
di_key
.
objeùid
);

3825 ià(
wdm
 && !wdm->
Üphªized
) {

3826 
»t
 = 
	`add_³ndšg_dœ_move
(
sùx
,

3827 
sùx
->
cur_šo
,

3828 
sùx
->
cur_šode_g’
,

3829 
di_key
.
objeùid
,

3830 &
sùx
->
Ãw_»fs
,

3831 &
sùx
->
d–‘ed_»fs
,

3832 
is_Üphª
);

3833 ià(!
»t
)

3834 
»t
 = 1;

3836 
out
:

3837 
	`bŒfs_ä“_·th
(
·th
);

3838  
»t
;

3839 
	}
}

3845 
	$check_šo_š_·th
(
bŒfs_roÙ
 *
roÙ
,

3846 cÚ¡ 
u64
 
šo1
,

3847 cÚ¡ 
u64
 
šo1_g’
,

3848 cÚ¡ 
u64
 
šo2
,

3849 cÚ¡ 
u64
 
šo2_g’
,

3850 
fs_·th
 *fs_path)

3852 
u64
 
šo
 = 
šo2
;

3854 ià(
šo1
 =ğ
šo2
)

3855  
šo1_g’
 =ğ
šo2_g’
;

3857 
šo
 > 
BTRFS_FIRST_FREE_OBJECTID
) {

3858 
u64
 
·»Á
;

3859 
u64
 
·»Á_g’
;

3860 
»t
;

3862 
	`fs_·th_»£t
(
fs_·th
);

3863 
»t
 = 
	`g‘_fœ¡_»f
(
roÙ
, 
šo
, &
·»Á
, &
·»Á_g’
, 
fs_·th
);

3864 ià(
»t
 < 0)

3865  
»t
;

3866 ià(
·»Á
 =ğ
šo1
)

3867  
·»Á_g’
 =ğ
šo1_g’
;

3868 
šo
 = 
·»Á
;

3871 
	}
}

3878 
	$is_ªû¡Ü
(
bŒfs_roÙ
 *
roÙ
,

3879 cÚ¡ 
u64
 
šo1
,

3880 cÚ¡ 
u64
 
šo1_g’
,

3881 cÚ¡ 
u64
 
šo2
,

3882 
fs_·th
 *fs_path)

3884 
boŞ
 
ä“_fs_·th
 = 
çl£
;

3885 
»t
 = 0;

3886 
™”_»t
 = 0;

3887 
bŒfs_·th
 *
·th
 = 
NULL
;

3888 
bŒfs_key
 
key
;

3890 ià(!
fs_·th
) {

3891 
fs_·th
 = 
	`fs_·th_®loc
();

3892 ià(!
fs_·th
)

3893  -
ENOMEM
;

3894 
ä“_fs_·th
 = 
Œue
;

3897 
·th
 = 
	`®loc_·th_fÜ_£nd
();

3898 ià(!
·th
) {

3899 
»t
 = -
ENOMEM
;

3900 
out
;

3903 
key
.
objeùid
 = 
šo2
;

3904 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

3905 
key
.
off£t
 = 0;

3907 
	`bŒfs_fÜ_—ch_¦Ù
(
roÙ
, &
key
, &key, 
·th
, 
™”_»t
) {

3908 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

3909 
¦Ù
 = 
·th
->
¦Ùs
[0];

3910 
u32
 
cur_off£t
 = 0;

3911 
u32
 
™em_size
;

3913 ià(
key
.
objeùid
 !ğ
šo2
)

3915 ià(
key
.
ty³
 !ğ
BTRFS_INODE_REF_KEY
 &&

3916 
key
.
ty³
 !ğ
BTRFS_INODE_EXTREF_KEY
)

3919 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

3920 
cur_off£t
 < 
™em_size
) {

3921 
u64
 
·»Á
;

3922 
u64
 
·»Á_g’
;

3924 ià(
key
.
ty³
 =ğ
BTRFS_INODE_EXTREF_KEY
) {

3925 
±r
;

3926 
bŒfs_šode_exŒef
 *
exŒef
;

3928 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
);

3929 
exŒef
 = (
bŒfs_šode_exŒef
 *)

3930 (
±r
 + 
cur_off£t
);

3931 
·»Á
 = 
	`bŒfs_šode_exŒef_·»Á
(
Ëaf
,

3932 
exŒef
);

3933 
cur_off£t
 +ğ(*
exŒef
);

3934 
cur_off£t
 +ğ
	`bŒfs_šode_exŒef_Çme_Ën
(
Ëaf
,

3935 
exŒef
);

3937 
·»Á
 = 
key
.
off£t
;

3938 
cur_off£t
 = 
™em_size
;

3941 
»t
 = 
	`g‘_šode_g’
(
roÙ
, 
·»Á
, &
·»Á_g’
);

3942 ià(
»t
 < 0)

3943 
out
;

3944 
»t
 = 
	`check_šo_š_·th
(
roÙ
, 
šo1
, 
šo1_g’
,

3945 
·»Á
, 
·»Á_g’
, 
fs_·th
);

3946 ià(
»t
)

3947 
out
;

3950 
»t
 = 0;

3951 ià(
™”_»t
 < 0)

3952 
»t
 = 
™”_»t
;

3954 
out
:

3955 
	`bŒfs_ä“_·th
(
·th
);

3956 ià(
ä“_fs_·th
)

3957 
	`fs_·th_ä“
(
fs_·th
);

3958  
»t
;

3959 
	}
}

3961 
	$wa™_fÜ_·»Á_move
(
£nd_ùx
 *
sùx
,

3962 
»cÜded_»f
 *
·»Á_»f
,

3963 cÚ¡ 
boŞ
 
is_Üphª
)

3965 
»t
 = 0;

3966 
u64
 
šo
 = 
·»Á_»f
->
dœ
;

3967 
u64
 
šo_g’
 = 
·»Á_»f
->
dœ_g’
;

3968 
u64
 
·»Á_šo_befÜe
, 
·»Á_šo_aá”
;

3969 
fs_·th
 *
·th_befÜe
 = 
NULL
;

3970 
fs_·th
 *
·th_aá”
 = 
NULL
;

3971 
Ën1
, 
Ën2
;

3973 
·th_aá”
 = 
	`fs_·th_®loc
();

3974 
·th_befÜe
 = 
	`fs_·th_®loc
();

3975 ià(!
·th_aá”
 || !
·th_befÜe
) {

3976 
»t
 = -
ENOMEM
;

3977 
out
;

3987 
šo
 > 
BTRFS_FIRST_FREE_OBJECTID
) {

3988 
u64
 
·»Á_šo_aá”_g’
;

3990 ià(
	`is_wa™šg_fÜ_move
(
sùx
, 
šo
)) {

4001 
»t
 = 
	`is_ªû¡Ü
(
sùx
->
·»Á_roÙ
,

4002 
sùx
->
cur_šo
, sùx->
cur_šode_g’
,

4003 
šo
, 
·th_befÜe
);

4004 ià(
»t
)

4008 
	`fs_·th_»£t
(
·th_befÜe
);

4009 
	`fs_·th_»£t
(
·th_aá”
);

4011 
»t
 = 
	`g‘_fœ¡_»f
(
sùx
->
£nd_roÙ
, 
šo
, &
·»Á_šo_aá”
,

4012 &
·»Á_šo_aá”_g’
, 
·th_aá”
);

4013 ià(
»t
 < 0)

4014 
out
;

4015 
»t
 = 
	`g‘_fœ¡_»f
(
sùx
->
·»Á_roÙ
, 
šo
, &
·»Á_šo_befÜe
,

4016 
NULL
, 
·th_befÜe
);

4017 ià(
»t
 < 0 &&„‘ !ğ-
ENOENT
) {

4018 
out
;

4019 } ià(
»t
 =ğ-
ENOENT
) {

4020 
»t
 = 0;

4024 
Ën1
 = 
	`fs_·th_Ën
(
·th_befÜe
);

4025 
Ën2
 = 
	`fs_·th_Ën
(
·th_aá”
);

4026 ià(
šo
 > 
sùx
->
cur_šo
 &&

4027 (
·»Á_šo_befÜe
 !ğ
·»Á_šo_aá”
 || 
Ën1
 !ğ
Ën2
 ||

4028 
	`memcmp
(
·th_befÜe
->
¡¬t
, 
·th_aá”
->¡¬t, 
Ën1
))) {

4029 
u64
 
·»Á_šo_g’
;

4031 
»t
 = 
	`g‘_šode_g’
(
sùx
->
·»Á_roÙ
, 
šo
, &
·»Á_šo_g’
);

4032 ià(
»t
 < 0)

4033 
out
;

4034 ià(
šo_g’
 =ğ
·»Á_šo_g’
) {

4035 
»t
 = 1;

4039 
šo
 = 
·»Á_šo_aá”
;

4040 
šo_g’
 = 
·»Á_šo_aá”_g’
;

4043 
out
:

4044 
	`fs_·th_ä“
(
·th_befÜe
);

4045 
	`fs_·th_ä“
(
·th_aá”
);

4047 ià(
»t
 == 1) {

4048 
»t
 = 
	`add_³ndšg_dœ_move
(
sùx
,

4049 
sùx
->
cur_šo
,

4050 
sùx
->
cur_šode_g’
,

4051 
šo
,

4052 &
sùx
->
Ãw_»fs
,

4053 &
sùx
->
d–‘ed_»fs
,

4054 
is_Üphª
);

4055 ià(!
»t
)

4056 
»t
 = 1;

4059  
»t
;

4060 
	}
}

4062 
	$upd©e_»f_·th
(
£nd_ùx
 *
sùx
, 
»cÜded_»f
 *
»f
)

4064 
»t
;

4065 
fs_·th
 *
Ãw_·th
;

4071 
Ãw_·th
 = 
	`fs_·th_®loc
();

4072 ià(!
Ãw_·th
)

4073  -
ENOMEM
;

4075 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
»f
->
dœ
,„ef->
dœ_g’
, 
Ãw_·th
);

4076 ià(
»t
 < 0) {

4077 
	`fs_·th_ä“
(
Ãw_·th
);

4078  
»t
;

4080 
»t
 = 
	`fs_·th_add
(
Ãw_·th
, 
»f
->
Çme
,„ef->
Çme_Ën
);

4081 ià(
»t
 < 0) {

4082 
	`fs_·th_ä“
(
Ãw_·th
);

4083  
»t
;

4086 
	`fs_·th_ä“
(
»f
->
fuÎ_·th
);

4087 
	`£t_»f_·th
(
»f
, 
Ãw_·th
);

4090 
	}
}

4133 
	$»äesh_»f_·th
(
£nd_ùx
 *
sùx
, 
»cÜded_»f
 *
»f
)

4135 *
Çme
;

4136 
»t
;

4138 
Çme
 = 
	`kmemdup
(
»f
->Çme,„ef->
Çme_Ën
, 
GFP_KERNEL
);

4139 ià(!
Çme
)

4140  -
ENOMEM
;

4142 
	`fs_·th_»£t
(
»f
->
fuÎ_·th
);

4143 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
»f
->
dœ
,„ef->
dœ_g’
,„ef->
fuÎ_·th
);

4144 ià(
»t
 < 0)

4145 
out
;

4147 
»t
 = 
	`fs_·th_add
(
»f
->
fuÎ_·th
, 
Çme
,„ef->
Çme_Ën
);

4148 ià(
»t
 < 0)

4149 
out
;

4152 
	`£t_»f_·th
(
»f
,„ef->
fuÎ_·th
);

4153 
out
:

4154 
	`kä“
(
Çme
);

4155  
»t
;

4156 
	}
}

4161 
	$´oûss_»cÜded_»fs
(
£nd_ùx
 *
sùx
, *
³ndšg_move
)

4163 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

4164 
»t
 = 0;

4165 
»cÜded_»f
 *
cur
;

4166 
»cÜded_»f
 *
cur2
;

4167 
	`LIST_HEAD
(
check_dœs
);

4168 
fs_·th
 *
v®id_·th
 = 
NULL
;

4169 
u64
 
ow_šode
 = 0;

4170 
u64
 
ow_g’
;

4171 
u64
 
ow_mode
;

4172 
did_ov”wr™e
 = 0;

4173 
is_Üphª
 = 0;

4174 
u64
 
Ï¡_dœ_šo_rm
 = 0;

4175 
boŞ
 
ÿn_»Çme
 = 
Œue
;

4176 
boŞ
 
Üphªized_dœ
 = 
çl£
;

4177 
boŞ
 
Üphªized_ªû¡Ü
 = 
çl£
;

4179 
	`bŒfs_debug
(
fs_šfo
, "´oûss_»cÜded_»f %Îu", 
sùx
->
cur_šo
);

4185 
	`BUG_ON
(
sùx
->
cur_šo
 <ğ
BTRFS_FIRST_FREE_OBJECTID
);

4187 
v®id_·th
 = 
	`fs_·th_®loc
();

4188 ià(!
v®id_·th
) {

4189 
»t
 = -
ENOMEM
;

4190 
out
;

4204 ià(!
sùx
->
cur_šode_Ãw
) {

4205 
»t
 = 
	`did_ov”wr™e_fœ¡_»f
(
sùx
, sùx->
cur_šo
,

4206 
sùx
->
cur_šode_g’
);

4207 ià(
»t
 < 0)

4208 
out
;

4209 ià(
»t
)

4210 
did_ov”wr™e
 = 1;

4212 ià(
sùx
->
cur_šode_Ãw
 || 
did_ov”wr™e
) {

4213 
»t
 = 
	`g’_unique_Çme
(
sùx
, sùx->
cur_šo
,

4214 
sùx
->
cur_šode_g’
, 
v®id_·th
);

4215 ià(
»t
 < 0)

4216 
out
;

4217 
is_Üphª
 = 1;

4219 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
,

4220 
v®id_·th
);

4221 ià(
»t
 < 0)

4222 
out
;

4263 
	`li¡_fÜ_—ch_’Œy
(
cur
, &
sùx
->
Ãw_»fs
, 
li¡
) {

4264 
»t
 = 
	`g‘_cur_šode_¡©e
(
sùx
, 
cur
->
dœ
, cur->
dœ_g’
, 
NULL
, NULL);

4265 ià(
»t
 < 0)

4266 
out
;

4267 ià(
»t
 =ğ
šode_¡©e_wl_ü—‹
)

4276 
»t
 = 
	`wl_ov”wr™e_»f
(
sùx
, 
cur
->
dœ
, cur->
dœ_g’
,

4277 
cur
->
Çme
, cur->
Çme_Ën
,

4278 &
ow_šode
, &
ow_g’
, &
ow_mode
);

4279 ià(
»t
 < 0)

4280 
out
;

4281 ià(
»t
) {

4282 
»t
 = 
	`is_fœ¡_»f
(
sùx
->
·»Á_roÙ
,

4283 
ow_šode
, 
cur
->
dœ
, cur->
Çme
,

4284 
cur
->
Çme_Ën
);

4285 ià(
»t
 < 0)

4286 
out
;

4287 ià(
»t
) {

4288 
Çme_ÿche_’Œy
 *
nû
;

4289 
wa™šg_dœ_move
 *
wdm
;

4291 ià(
Üphªized_dœ
) {

4292 
»t
 = 
	`»äesh_»f_·th
(
sùx
, 
cur
);

4293 ià(
»t
 < 0)

4294 
out
;

4297 
»t
 = 
	`Üphªize_šode
(
sùx
, 
ow_šode
, 
ow_g’
,

4298 
cur
->
fuÎ_·th
);

4299 ià(
»t
 < 0)

4300 
out
;

4301 ià(
	`S_ISDIR
(
ow_mode
))

4302 
Üphªized_dœ
 = 
Œue
;

4310 
wdm
 = 
	`g‘_wa™šg_dœ_move
(
sùx
, 
ow_šode
);

4311 ià(
wdm
)

4312 
wdm
->
Üphªized
 = 
Œue
;

4324 
nû
 = 
	`Çme_ÿche_£¬ch
(
sùx
, 
ow_šode
, 
ow_g’
);

4325 ià(
nû
)

4326 
	`bŒfs_Ìu_ÿche_»move
(&
sùx
->
Çme_ÿche
,

4327 &
nû
->
’Œy
);

4336 
»t
 = 
	`is_ªû¡Ü
(
sùx
->
·»Á_roÙ
,

4337 
ow_šode
, 
ow_g’
,

4338 
sùx
->
cur_šo
, 
NULL
);

4339 ià(
»t
 > 0) {

4340 
Üphªized_ªû¡Ü
 = 
Œue
;

4341 
	`fs_·th_»£t
(
v®id_·th
);

4342 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
,

4343 
sùx
->
cur_šode_g’
,

4344 
v®id_·th
);

4346 ià(
»t
 < 0)

4347 
out
;

4355 ià(
Üphªized_dœ
) {

4356 
»t
 = 
	`»äesh_»f_·th
(
sùx
, 
cur
);

4357 ià(
»t
 < 0)

4358 
out
;

4360 
»t
 = 
	`£nd_uÆšk
(
sùx
, 
cur
->
fuÎ_·th
);

4361 ià(
»t
 < 0)

4362 
out
;

4368 
	`li¡_fÜ_—ch_’Œy
(
cur
, &
sùx
->
Ãw_»fs
, 
li¡
) {

4376 
»t
 = 
	`g‘_cur_šode_¡©e
(
sùx
, 
cur
->
dœ
, cur->
dœ_g’
, 
NULL
, NULL);

4377 ià(
»t
 < 0)

4378 
out
;

4379 ià(
»t
 =ğ
šode_¡©e_wl_ü—‹
) {

4380 
»t
 = 0;

4385 
	`li¡_fÜ_—ch_’Œy
(
cur2
, &
sùx
->
Ãw_»fs
, 
li¡
) {

4386 ià(
cur
 =ğ
cur2
)

4388 ià(
cur2
->
dœ
 =ğ
cur
->dir) {

4389 
»t
 = 1;

4398 ià(!
»t
)

4399 
»t
 = 
	`did_ü—‹_dœ
(
sùx
, 
cur
->
dœ
);

4400 ià(
»t
 < 0)

4401 
out
;

4402 ià(!
»t
) {

4403 
»t
 = 
	`£nd_ü—‹_šode
(
sùx
, 
cur
->
dœ
);

4404 ià(
»t
 < 0)

4405 
out
;

4406 
	`ÿche_dœ_ü—‹d
(
sùx
, 
cur
->
dœ
);

4410 ià(
	`S_ISDIR
(
sùx
->
cur_šode_mode
è&& sùx->
·»Á_roÙ
) {

4411 
»t
 = 
	`wa™_fÜ_de¡_dœ_move
(
sùx
, 
cur
, 
is_Üphª
);

4412 ià(
»t
 < 0)

4413 
out
;

4414 ià(
»t
 == 1) {

4415 
ÿn_»Çme
 = 
çl£
;

4416 *
³ndšg_move
 = 1;

4420 ià(
	`S_ISDIR
(
sùx
->
cur_šode_mode
è&& sùx->
·»Á_roÙ
 &&

4421 
ÿn_»Çme
) {

4422 
»t
 = 
	`wa™_fÜ_·»Á_move
(
sùx
, 
cur
, 
is_Üphª
);

4423 ià(
»t
 < 0)

4424 
out
;

4425 ià(
»t
 == 1) {

4426 
ÿn_»Çme
 = 
çl£
;

4427 *
³ndšg_move
 = 1;

4436 ià(
is_Üphª
 && 
ÿn_»Çme
) {

4437 
»t
 = 
	`£nd_»Çme
(
sùx
, 
v®id_·th
, 
cur
->
fuÎ_·th
);

4438 ià(
»t
 < 0)

4439 
out
;

4440 
is_Üphª
 = 0;

4441 
»t
 = 
	`fs_·th_cİy
(
v®id_·th
, 
cur
->
fuÎ_·th
);

4442 ià(
»t
 < 0)

4443 
out
;

4444 } ià(
ÿn_»Çme
) {

4445 ià(
	`S_ISDIR
(
sùx
->
cur_šode_mode
)) {

4451 
»t
 = 
	`£nd_»Çme
(
sùx
, 
v®id_·th
,

4452 
cur
->
fuÎ_·th
);

4453 ià(!
»t
)

4454 
»t
 = 
	`fs_·th_cİy
(
v®id_·th
,

4455 
cur
->
fuÎ_·th
);

4456 ià(
»t
 < 0)

4457 
out
;

4466 ià(
Üphªized_dœ
) {

4467 
»t
 = 
	`upd©e_»f_·th
(
sùx
, 
cur
);

4468 ià(
»t
 < 0)

4469 
out
;

4471 
»t
 = 
	`£nd_lšk
(
sùx
, 
cur
->
fuÎ_·th
,

4472 
v®id_·th
);

4473 ià(
»t
 < 0)

4474 
out
;

4477 
»t
 = 
	`dup_»f
(
cur
, &
check_dœs
);

4478 ià(
»t
 < 0)

4479 
out
;

4482 ià(
	`S_ISDIR
(
sùx
->
cur_šode_mode
è&& sùx->
cur_šode_d–‘ed
) {

4489 
»t
 = 
	`ÿn_rmdœ
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
);

4490 ià(
»t
 < 0)

4491 
out
;

4492 ià(
»t
) {

4493 
»t
 = 
	`£nd_rmdœ
(
sùx
, 
v®id_·th
);

4494 ià(
»t
 < 0)

4495 
out
;

4496 } ià(!
is_Üphª
) {

4497 
»t
 = 
	`Üphªize_šode
(
sùx
, sùx->
cur_šo
,

4498 
sùx
->
cur_šode_g’
, 
v®id_·th
);

4499 ià(
»t
 < 0)

4500 
out
;

4501 
is_Üphª
 = 1;

4504 
	`li¡_fÜ_—ch_’Œy
(
cur
, &
sùx
->
d–‘ed_»fs
, 
li¡
) {

4505 
»t
 = 
	`dup_»f
(
cur
, &
check_dœs
);

4506 ià(
»t
 < 0)

4507 
out
;

4509 } ià(
	`S_ISDIR
(
sùx
->
cur_šode_mode
) &&

4510 !
	`li¡_em±y
(&
sùx
->
d–‘ed_»fs
)) {

4514 
cur
 = 
	`li¡_’Œy
(
sùx
->
d–‘ed_»fs
.
Ãxt
, 
»cÜded_»f
,

4515 
li¡
);

4516 
»t
 = 
	`dup_»f
(
cur
, &
check_dœs
);

4517 ià(
»t
 < 0)

4518 
out
;

4519 } ià(!
	`S_ISDIR
(
sùx
->
cur_šode_mode
)) {

4525 
	`li¡_fÜ_—ch_’Œy
(
cur
, &
sùx
->
d–‘ed_»fs
, 
li¡
) {

4526 
»t
 = 
	`did_ov”wr™e_»f
(
sùx
, 
cur
->
dœ
, cur->
dœ_g’
,

4527 
sùx
->
cur_šo
, sùx->
cur_šode_g’
,

4528 
cur
->
Çme
, cur->
Çme_Ën
);

4529 ià(
»t
 < 0)

4530 
out
;

4531 ià(!
»t
) {

4539 ià(
Üphªized_ªû¡Ü
) {

4540 
»t
 = 
	`upd©e_»f_·th
(
sùx
, 
cur
);

4541 ià(
»t
 < 0)

4542 
out
;

4544 
»t
 = 
	`£nd_uÆšk
(
sùx
, 
cur
->
fuÎ_·th
);

4545 ià(
»t
 < 0)

4546 
out
;

4548 
»t
 = 
	`dup_»f
(
cur
, &
check_dœs
);

4549 ià(
»t
 < 0)

4550 
out
;

4560 ià(
is_Üphª
) {

4561 
»t
 = 
	`£nd_uÆšk
(
sùx
, 
v®id_·th
);

4562 ià(
»t
 < 0)

4563 
out
;

4573 
	`li¡_fÜ_—ch_’Œy
(
cur
, &
check_dœs
, 
li¡
) {

4579 ià(
cur
->
dœ
 > 
sùx
->
cur_šo
)

4582 
»t
 = 
	`g‘_cur_šode_¡©e
(
sùx
, 
cur
->
dœ
, cur->
dœ_g’
, 
NULL
, NULL);

4583 ià(
»t
 < 0)

4584 
out
;

4586 ià(
»t
 =ğ
šode_¡©e_did_ü—‹
 ||

4587 
»t
 =ğ
šode_¡©e_no_chªge
) {

4588 
»t
 = 
	`ÿche_dœ_utimes
(
sùx
, 
cur
->
dœ
, cur->
dœ_g’
);

4589 ià(
»t
 < 0)

4590 
out
;

4591 } ià(
»t
 =ğ
šode_¡©e_did_d–‘e
 &&

4592 
cur
->
dœ
 !ğ
Ï¡_dœ_šo_rm
) {

4593 
»t
 = 
	`ÿn_rmdœ
(
sùx
, 
cur
->
dœ
, cur->
dœ_g’
);

4594 ià(
»t
 < 0)

4595 
out
;

4596 ià(
»t
) {

4597 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
cur
->
dœ
,

4598 
cur
->
dœ_g’
, 
v®id_·th
);

4599 ià(
»t
 < 0)

4600 
out
;

4601 
»t
 = 
	`£nd_rmdœ
(
sùx
, 
v®id_·th
);

4602 ià(
»t
 < 0)

4603 
out
;

4604 
Ï¡_dœ_šo_rm
 = 
cur
->
dœ
;

4609 
»t
 = 0;

4611 
out
:

4612 
	`__ä“_»cÜded_»fs
(&
check_dœs
);

4613 
	`ä“_»cÜded_»fs
(
sùx
);

4614 
	`fs_·th_ä“
(
v®id_·th
);

4615  
»t
;

4616 
	}
}

4618 
	$rbŒ“_»f_comp
(cÚ¡ *
k
, cÚ¡ 
rb_node
 *
node
)

4620 cÚ¡ 
»cÜded_»f
 *
d©a
 = 
k
;

4621 cÚ¡ 
»cÜded_»f
 *
»f
 = 
	`rb_’Œy
(
node
, recorded_ref,‚ode);

4622 
»suÉ
;

4624 ià(
d©a
->
dœ
 > 
»f
->dir)

4626 ià(
d©a
->
dœ
 < 
»f
->dir)

4628 ià(
d©a
->
dœ_g’
 > 
»f
->dir_gen)

4630 ià(
d©a
->
dœ_g’
 < 
»f
->dir_gen)

4632 ià(
d©a
->
Çme_Ën
 > 
»f
->name_len)

4634 ià(
d©a
->
Çme_Ën
 < 
»f
->name_len)

4636 
»suÉ
 = 
	`¡rcmp
(
d©a
->
Çme
, 
»f
->name);

4637 ià(
»suÉ
 > 0)

4639 ià(
»suÉ
 < 0)

4642 
	}
}

4644 
boŞ
 
	$rbŒ“_»f_Ëss
(
rb_node
 *
node
, cÚ¡ rb_nod*
·»Á
)

4646 cÚ¡ 
»cÜded_»f
 *
’Œy
 = 
	`rb_’Œy
(
node
, recorded_ref,‚ode);

4648  
	`rbŒ“_»f_comp
(
’Œy
, 
·»Á
) < 0;

4649 
	}
}

4651 
	$»cÜd_»f_š_Œ“
(
rb_roÙ
 *
roÙ
, 
li¡_h—d
 *
»fs
,

4652 
fs_·th
 *
Çme
, 
u64
 
dœ
, u64 
dœ_g’
,

4653 
£nd_ùx
 *
sùx
)

4655 
»t
 = 0;

4656 
fs_·th
 *
·th
 = 
NULL
;

4657 
»cÜded_»f
 *
»f
 = 
NULL
;

4659 
·th
 = 
	`fs_·th_®loc
();

4660 ià(!
·th
) {

4661 
»t
 = -
ENOMEM
;

4662 
out
;

4665 
»f
 = 
	`»cÜded_»f_®loc
();

4666 ià(!
»f
) {

4667 
»t
 = -
ENOMEM
;

4668 
out
;

4671 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
dœ
, 
dœ_g’
, 
·th
);

4672 ià(
»t
 < 0)

4673 
out
;

4674 
»t
 = 
	`fs_·th_add_·th
(
·th
, 
Çme
);

4675 ià(
»t
 < 0)

4676 
out
;

4678 
»f
->
dœ
 = dir;

4679 
»f
->
dœ_g’
 = dir_gen;

4680 
	`£t_»f_·th
(
»f
, 
·th
);

4681 
	`li¡_add_
(&
»f
->
li¡
, 
»fs
);

4682 
	`rb_add
(&
»f
->
node
, 
roÙ
, 
rbŒ“_»f_Ëss
);

4683 
»f
->
roÙ
 =„oot;

4684 
out
:

4685 ià(
»t
) {

4686 ià(
·th
 && (!
»f
 || !»f->
fuÎ_·th
))

4687 
	`fs_·th_ä“
(
·th
);

4688 
	`»cÜded_»f_ä“
(
»f
);

4690  
»t
;

4691 
	}
}

4693 
	$»cÜd_Ãw_»f_if_Ãeded
(
num
, 
u64
 
dœ
, 
šdex
,

4694 
fs_·th
 *
Çme
, *
ùx
)

4696 
»t
 = 0;

4697 
£nd_ùx
 *
sùx
 = 
ùx
;

4698 
rb_node
 *
node
 = 
NULL
;

4699 
»cÜded_»f
 
d©a
;

4700 
»cÜded_»f
 *
»f
;

4701 
u64
 
dœ_g’
;

4703 
»t
 = 
	`g‘_šode_g’
(
sùx
->
£nd_roÙ
, 
dœ
, &
dœ_g’
);

4704 ià(
»t
 < 0)

4705 
out
;

4707 
d©a
.
dœ
 = dir;

4708 
d©a
.
dœ_g’
 = dir_gen;

4709 
	`£t_»f_·th
(&
d©a
, 
Çme
);

4710 
node
 = 
	`rb_fšd
(&
d©a
, &
sùx
->
rbŒ“_d–‘ed_»fs
, 
rbŒ“_»f_comp
);

4711 ià(
node
) {

4712 
»f
 = 
	`rb_’Œy
(
node
, 
»cÜded_»f
,‚ode);

4713 
	`»cÜded_»f_ä“
(
»f
);

4715 
»t
 = 
	`»cÜd_»f_š_Œ“
(&
sùx
->
rbŒ“_Ãw_»fs
,

4716 &
sùx
->
Ãw_»fs
, 
Çme
, 
dœ
, 
dœ_g’
,

4717 
sùx
);

4719 
out
:

4720  
»t
;

4721 
	}
}

4723 
	$»cÜd_d–‘ed_»f_if_Ãeded
(
num
, 
u64
 
dœ
, 
šdex
,

4724 
fs_·th
 *
Çme
, *
ùx
)

4726 
»t
 = 0;

4727 
£nd_ùx
 *
sùx
 = 
ùx
;

4728 
rb_node
 *
node
 = 
NULL
;

4729 
»cÜded_»f
 
d©a
;

4730 
»cÜded_»f
 *
»f
;

4731 
u64
 
dœ_g’
;

4733 
»t
 = 
	`g‘_šode_g’
(
sùx
->
·»Á_roÙ
, 
dœ
, &
dœ_g’
);

4734 ià(
»t
 < 0)

4735 
out
;

4737 
d©a
.
dœ
 = dir;

4738 
d©a
.
dœ_g’
 = dir_gen;

4739 
	`£t_»f_·th
(&
d©a
, 
Çme
);

4740 
node
 = 
	`rb_fšd
(&
d©a
, &
sùx
->
rbŒ“_Ãw_»fs
, 
rbŒ“_»f_comp
);

4741 ià(
node
) {

4742 
»f
 = 
	`rb_’Œy
(
node
, 
»cÜded_»f
,‚ode);

4743 
	`»cÜded_»f_ä“
(
»f
);

4745 
»t
 = 
	`»cÜd_»f_š_Œ“
(&
sùx
->
rbŒ“_d–‘ed_»fs
,

4746 &
sùx
->
d–‘ed_»fs
, 
Çme
, 
dœ
,

4747 
dœ_g’
, 
sùx
);

4749 
out
:

4750  
»t
;

4751 
	}
}

4753 
	$»cÜd_Ãw_»f
(
£nd_ùx
 *
sùx
)

4755 
»t
;

4757 
»t
 = 
	`™”©e_šode_»f
(
sùx
->
£nd_roÙ
, sùx->
Ëá_·th
,

4758 
sùx
->
cmp_key
, 0, 
»cÜd_Ãw_»f_if_Ãeded
, sctx);

4759 ià(
»t
 < 0)

4760 
out
;

4761 
»t
 = 0;

4763 
out
:

4764  
»t
;

4765 
	}
}

4767 
	$»cÜd_d–‘ed_»f
(
£nd_ùx
 *
sùx
)

4769 
»t
;

4771 
»t
 = 
	`™”©e_šode_»f
(
sùx
->
·»Á_roÙ
, sùx->
right_·th
,

4772 
sùx
->
cmp_key
, 0, 
»cÜd_d–‘ed_»f_if_Ãeded
,

4773 
sùx
);

4774 ià(
»t
 < 0)

4775 
out
;

4776 
»t
 = 0;

4778 
out
:

4779  
»t
;

4780 
	}
}

4782 
	$»cÜd_chªged_»f
(
£nd_ùx
 *
sùx
)

4784 
»t
 = 0;

4786 
»t
 = 
	`™”©e_šode_»f
(
sùx
->
£nd_roÙ
, sùx->
Ëá_·th
,

4787 
sùx
->
cmp_key
, 0, 
»cÜd_Ãw_»f_if_Ãeded
, sctx);

4788 ià(
»t
 < 0)

4789 
out
;

4790 
»t
 = 
	`™”©e_šode_»f
(
sùx
->
·»Á_roÙ
, sùx->
right_·th
,

4791 
sùx
->
cmp_key
, 0, 
»cÜd_d–‘ed_»f_if_Ãeded
, sctx);

4792 ià(
»t
 < 0)

4793 
out
;

4794 
»t
 = 0;

4796 
out
:

4797  
»t
;

4798 
	}
}

4804 
	$´oûss_®l_»fs
(
£nd_ùx
 *
sùx
,

4805 
bŒfs_com·»_Œ“_»suÉ
 
cmd
)

4807 
»t
 = 0;

4808 
™”_»t
 = 0;

4809 
bŒfs_roÙ
 *
roÙ
;

4810 
bŒfs_·th
 *
·th
;

4811 
bŒfs_key
 
key
;

4812 
bŒfs_key
 
found_key
;

4813 
™”©e_šode_»f_t
 
cb
;

4814 
³ndšg_move
 = 0;

4816 
·th
 = 
	`®loc_·th_fÜ_£nd
();

4817 ià(!
·th
)

4818  -
ENOMEM
;

4820 ià(
cmd
 =ğ
BTRFS_COMPARE_TREE_NEW
) {

4821 
roÙ
 = 
sùx
->
£nd_roÙ
;

4822 
cb
 = 
»cÜd_Ãw_»f_if_Ãeded
;

4823 } ià(
cmd
 =ğ
BTRFS_COMPARE_TREE_DELETED
) {

4824 
roÙ
 = 
sùx
->
·»Á_roÙ
;

4825 
cb
 = 
»cÜd_d–‘ed_»f_if_Ãeded
;

4827 
	`bŒfs_”r
(
sùx
->
£nd_roÙ
->
fs_šfo
,

4828 "WrÚg commªd %d iÀ´oûss_®l_»fs", 
cmd
);

4829 
»t
 = -
EINVAL
;

4830 
out
;

4833 
key
.
objeùid
 = 
sùx
->
cmp_key
->objectid;

4834 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

4835 
key
.
off£t
 = 0;

4836 
	`bŒfs_fÜ_—ch_¦Ù
(
roÙ
, &
key
, &
found_key
, 
·th
, 
™”_»t
) {

4837 ià(
found_key
.
objeùid
 !ğ
key
.objectid ||

4838 (
found_key
.
ty³
 !ğ
BTRFS_INODE_REF_KEY
 &&

4839 
found_key
.
ty³
 !ğ
BTRFS_INODE_EXTREF_KEY
))

4842 
»t
 = 
	`™”©e_šode_»f
(
roÙ
, 
·th
, &
found_key
, 0, 
cb
, 
sùx
);

4843 ià(
»t
 < 0)

4844 
out
;

4847 ià(
™”_»t
 < 0) {

4848 
»t
 = 
™”_»t
;

4849 
out
;

4851 
	`bŒfs_»Ëa£_·th
(
·th
);

4858 
»t
 = 
	`´oûss_»cÜded_»fs
(
sùx
, &
³ndšg_move
);

4859 
out
:

4860 
	`bŒfs_ä“_·th
(
·th
);

4861  
»t
;

4862 
	}
}

4864 
	$£nd_£t_x©Œ
(
£nd_ùx
 *
sùx
,

4865 
fs_·th
 *
·th
,

4866 cÚ¡ *
Çme
, 
Çme_Ën
,

4867 cÚ¡ *
d©a
, 
d©a_Ën
)

4869 
»t
 = 0;

4871 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_SET_XATTR
);

4872 ià(
»t
 < 0)

4873 
out
;

4875 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
·th
);

4876 
	`TLV_PUT_STRING
(
sùx
, 
BTRFS_SEND_A_XATTR_NAME
, 
Çme
, 
Çme_Ën
);

4877 
	`TLV_PUT
(
sùx
, 
BTRFS_SEND_A_XATTR_DATA
, 
d©a
, 
d©a_Ën
);

4879 
»t
 = 
	`£nd_cmd
(
sùx
);

4881 
v_put_çu»
:

4882 
out
:

4883  
»t
;

4884 
	}
}

4886 
	$£nd_»move_x©Œ
(
£nd_ùx
 *
sùx
,

4887 
fs_·th
 *
·th
,

4888 cÚ¡ *
Çme
, 
Çme_Ën
)

4890 
»t
 = 0;

4892 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_REMOVE_XATTR
);

4893 ià(
»t
 < 0)

4894 
out
;

4896 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
·th
);

4897 
	`TLV_PUT_STRING
(
sùx
, 
BTRFS_SEND_A_XATTR_NAME
, 
Çme
, 
Çme_Ën
);

4899 
»t
 = 
	`£nd_cmd
(
sùx
);

4901 
v_put_çu»
:

4902 
out
:

4903  
»t
;

4904 
	}
}

4906 
	$__´oûss_Ãw_x©Œ
(
num
, 
bŒfs_key
 *
di_key
,

4907 cÚ¡ *
Çme
, 
Çme_Ën
, cÚ¡ *
d©a
,

4908 
d©a_Ën
, *
ùx
)

4910 
»t
;

4911 
£nd_ùx
 *
sùx
 = 
ùx
;

4912 
fs_·th
 *
p
;

4913 
posix_aş_x©Œ_h—d”
 
dummy_aş
;

4916 ià(!
	`¡ºcmp
(
Çme
, 
XATTR_NAME_CAPS
, 
Çme_Ën
))

4919 
p
 = 
	`fs_·th_®loc
();

4920 ià(!
p
)

4921  -
ENOMEM
;

4929 ià(!
	`¡ºcmp
(
Çme
, 
XATTR_NAME_POSIX_ACL_ACCESS
, 
Çme_Ën
) ||

4930 !
	`¡ºcmp
(
Çme
, 
XATTR_NAME_POSIX_ACL_DEFAULT
, 
Çme_Ën
)) {

4931 ià(
d©a_Ën
 == 0) {

4932 
dummy_aş
.
a_v”siÚ
 =

4933 
	`ıu_to_Ë32
(
POSIX_ACL_XATTR_VERSION
);

4934 
d©a
 = (*)&
dummy_aş
;

4935 
d©a_Ën
 = (
dummy_aş
);

4939 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
, 
p
);

4940 ià(
»t
 < 0)

4941 
out
;

4943 
»t
 = 
	`£nd_£t_x©Œ
(
sùx
, 
p
, 
Çme
, 
Çme_Ën
, 
d©a
, 
d©a_Ën
);

4945 
out
:

4946 
	`fs_·th_ä“
(
p
);

4947  
»t
;

4948 
	}
}

4950 
	$__´oûss_d–‘ed_x©Œ
(
num
, 
bŒfs_key
 *
di_key
,

4951 cÚ¡ *
Çme
, 
Çme_Ën
,

4952 cÚ¡ *
d©a
, 
d©a_Ën
, *
ùx
)

4954 
»t
;

4955 
£nd_ùx
 *
sùx
 = 
ùx
;

4956 
fs_·th
 *
p
;

4958 
p
 = 
	`fs_·th_®loc
();

4959 ià(!
p
)

4960  -
ENOMEM
;

4962 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
, 
p
);

4963 ià(
»t
 < 0)

4964 
out
;

4966 
»t
 = 
	`£nd_»move_x©Œ
(
sùx
, 
p
, 
Çme
, 
Çme_Ën
);

4968 
out
:

4969 
	`fs_·th_ä“
(
p
);

4970  
»t
;

4971 
	}
}

4973 
	$´oûss_Ãw_x©Œ
(
£nd_ùx
 *
sùx
)

4975 
»t
 = 0;

4977 
»t
 = 
	`™”©e_dœ_™em
(
sùx
->
£nd_roÙ
, sùx->
Ëá_·th
,

4978 
__´oûss_Ãw_x©Œ
, 
sùx
);

4980  
»t
;

4981 
	}
}

4983 
	$´oûss_d–‘ed_x©Œ
(
£nd_ùx
 *
sùx
)

4985  
	`™”©e_dœ_™em
(
sùx
->
·»Á_roÙ
, sùx->
right_·th
,

4986 
__´oûss_d–‘ed_x©Œ
, 
sùx
);

4987 
	}
}

4989 
	sfšd_x©Œ_ùx
 {

4990 cÚ¡ *
	mÇme
;

4991 
	mÇme_Ën
;

4992 
	mfound_idx
;

4993 *
	mfound_d©a
;

4994 
	mfound_d©a_Ën
;

4997 
	$__fšd_x©Œ
(
num
, 
bŒfs_key
 *
di_key
, cÚ¡ *
Çme
,

4998 
Çme_Ën
, cÚ¡ *
d©a
, 
d©a_Ën
, *
vùx
)

5000 
fšd_x©Œ_ùx
 *
ùx
 = 
vùx
;

5002 ià(
Çme_Ën
 =ğ
ùx
->name_len &&

5003 
	`¡ºcmp
(
Çme
, 
ùx
->Çme, 
Çme_Ën
) == 0) {

5004 
ùx
->
found_idx
 = 
num
;

5005 
ùx
->
found_d©a_Ën
 = 
d©a_Ën
;

5006 
ùx
->
found_d©a
 = 
	`kmemdup
(
d©a
, 
d©a_Ën
, 
GFP_KERNEL
);

5007 ià(!
ùx
->
found_d©a
)

5008  -
ENOMEM
;

5012 
	}
}

5014 
	$fšd_x©Œ
(
bŒfs_roÙ
 *
roÙ
,

5015 
bŒfs_·th
 *
·th
,

5016 
bŒfs_key
 *
key
,

5017 cÚ¡ *
Çme
, 
Çme_Ën
,

5018 **
d©a
, *
d©a_Ën
)

5020 
»t
;

5021 
fšd_x©Œ_ùx
 
ùx
;

5023 
ùx
.
Çme
 =‚ame;

5024 
ùx
.
Çme_Ën
 =‚ame_len;

5025 
ùx
.
found_idx
 = -1;

5026 
ùx
.
found_d©a
 = 
NULL
;

5027 
ùx
.
found_d©a_Ën
 = 0;

5029 
»t
 = 
	`™”©e_dœ_™em
(
roÙ
, 
·th
, 
__fšd_x©Œ
, &
ùx
);

5030 ià(
»t
 < 0)

5031  
»t
;

5033 ià(
ùx
.
found_idx
 == -1)

5034  -
ENOENT
;

5035 ià(
d©a
) {

5036 *
d©a
 = 
ùx
.
found_d©a
;

5037 *
d©a_Ën
 = 
ùx
.
found_d©a_Ën
;

5039 
	`kä“
(
ùx
.
found_d©a
);

5041  
ùx
.
found_idx
;

5042 
	}
}

5045 
	$__´oûss_chªged_Ãw_x©Œ
(
num
, 
bŒfs_key
 *
di_key
,

5046 cÚ¡ *
Çme
, 
Çme_Ën
,

5047 cÚ¡ *
d©a
, 
d©a_Ën
,

5048 *
ùx
)

5050 
»t
;

5051 
£nd_ùx
 *
sùx
 = 
ùx
;

5052 *
found_d©a
 = 
NULL
;

5053 
found_d©a_Ën
 = 0;

5055 
»t
 = 
	`fšd_x©Œ
(
sùx
->
·»Á_roÙ
, sùx->
right_·th
,

5056 
sùx
->
cmp_key
, 
Çme
, 
Çme_Ën
, &
found_d©a
,

5057 &
found_d©a_Ën
);

5058 ià(
»t
 =ğ-
ENOENT
) {

5059 
»t
 = 
	`__´oûss_Ãw_x©Œ
(
num
, 
di_key
, 
Çme
, 
Çme_Ën
, 
d©a
,

5060 
d©a_Ën
, 
ùx
);

5061 } ià(
»t
 >= 0) {

5062 ià(
d©a_Ën
 !ğ
found_d©a_Ën
 ||

5063 
	`memcmp
(
d©a
, 
found_d©a
, 
d©a_Ën
)) {

5064 
»t
 = 
	`__´oûss_Ãw_x©Œ
(
num
, 
di_key
, 
Çme
, 
Çme_Ën
,

5065 
d©a
, 
d©a_Ën
, 
ùx
);

5067 
»t
 = 0;

5071 
	`kä“
(
found_d©a
);

5072  
»t
;

5073 
	}
}

5075 
	$__´oûss_chªged_d–‘ed_x©Œ
(
num
, 
bŒfs_key
 *
di_key
,

5076 cÚ¡ *
Çme
, 
Çme_Ën
,

5077 cÚ¡ *
d©a
, 
d©a_Ën
,

5078 *
ùx
)

5080 
»t
;

5081 
£nd_ùx
 *
sùx
 = 
ùx
;

5083 
»t
 = 
	`fšd_x©Œ
(
sùx
->
£nd_roÙ
, sùx->
Ëá_·th
, sùx->
cmp_key
,

5084 
Çme
, 
Çme_Ën
, 
NULL
, NULL);

5085 ià(
»t
 =ğ-
ENOENT
)

5086 
»t
 = 
	`__´oûss_d–‘ed_x©Œ
(
num
, 
di_key
, 
Çme
, 
Çme_Ën
, 
d©a
,

5087 
d©a_Ën
, 
ùx
);

5088 ià(
»t
 >= 0)

5089 
»t
 = 0;

5091  
»t
;

5092 
	}
}

5094 
	$´oûss_chªged_x©Œ
(
£nd_ùx
 *
sùx
)

5096 
»t
 = 0;

5098 
»t
 = 
	`™”©e_dœ_™em
(
sùx
->
£nd_roÙ
, sùx->
Ëá_·th
,

5099 
__´oûss_chªged_Ãw_x©Œ
, 
sùx
);

5100 ià(
»t
 < 0)

5101 
out
;

5102 
»t
 = 
	`™”©e_dœ_™em
(
sùx
->
·»Á_roÙ
, sùx->
right_·th
,

5103 
__´oûss_chªged_d–‘ed_x©Œ
, 
sùx
);

5105 
out
:

5106  
»t
;

5107 
	}
}

5109 
	$´oûss_®l_Ãw_x©Œs
(
£nd_ùx
 *
sùx
)

5111 
»t
 = 0;

5112 
™”_»t
 = 0;

5113 
bŒfs_roÙ
 *
roÙ
;

5114 
bŒfs_·th
 *
·th
;

5115 
bŒfs_key
 
key
;

5116 
bŒfs_key
 
found_key
;

5118 
·th
 = 
	`®loc_·th_fÜ_£nd
();

5119 ià(!
·th
)

5120  -
ENOMEM
;

5122 
roÙ
 = 
sùx
->
£nd_roÙ
;

5124 
key
.
objeùid
 = 
sùx
->
cmp_key
->objectid;

5125 
key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

5126 
key
.
off£t
 = 0;

5127 
	`bŒfs_fÜ_—ch_¦Ù
(
roÙ
, &
key
, &
found_key
, 
·th
, 
™”_»t
) {

5128 ià(
found_key
.
objeùid
 !ğ
key
.objectid ||

5129 
found_key
.
ty³
 !ğ
key
.type) {

5130 
»t
 = 0;

5134 
»t
 = 
	`™”©e_dœ_™em
(
roÙ
, 
·th
, 
__´oûss_Ãw_x©Œ
, 
sùx
);

5135 ià(
»t
 < 0)

5139 ià(
™”_»t
 < 0)

5140 
»t
 = 
™”_»t
;

5142 
	`bŒfs_ä“_·th
(
·th
);

5143  
»t
;

5144 
	}
}

5146 
	$£nd_v”™y
(
£nd_ùx
 *
sùx
, 
fs_·th
 *
·th
,

5147 
fsv”™y_desütÜ
 *
desc
)

5149 
»t
;

5151 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_ENABLE_VERITY
);

5152 ià(
»t
 < 0)

5153 
out
;

5155 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
·th
);

5156 
	`TLV_PUT_U8
(
sùx
, 
BTRFS_SEND_A_VERITY_ALGORITHM
,

5157 
	`Ë8_to_ıu
(
desc
->
hash_®gÜ™hm
));

5158 
	`TLV_PUT_U32
(
sùx
, 
BTRFS_SEND_A_VERITY_BLOCK_SIZE
,

5159 1U << 
	`Ë8_to_ıu
(
desc
->
log_blocksize
));

5160 
	`TLV_PUT
(
sùx
, 
BTRFS_SEND_A_VERITY_SALT_DATA
, 
desc
->
§É
,

5161 
	`Ë8_to_ıu
(
desc
->
§É_size
));

5162 
	`TLV_PUT
(
sùx
, 
BTRFS_SEND_A_VERITY_SIG_DATA
, 
desc
->
sigÇtu»
,

5163 
	`Ë32_to_ıu
(
desc
->
sig_size
));

5165 
»t
 = 
	`£nd_cmd
(
sùx
);

5167 
v_put_çu»
:

5168 
out
:

5169  
»t
;

5170 
	}
}

5172 
	$´oûss_v”™y
(
£nd_ùx
 *
sùx
)

5174 
»t
 = 0;

5175 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

5176 
šode
 *inode;

5177 
fs_·th
 *
p
;

5179 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
sùx
->
cur_šo
, sùx->
£nd_roÙ
);

5180 ià(
	`IS_ERR
(
šode
))

5181  
	`PTR_ERR
(
šode
);

5183 
»t
 = 
	`bŒfs_g‘_v”™y_desütÜ
(
šode
, 
NULL
, 0);

5184 ià(
»t
 < 0)

5185 
ut
;

5187 ià(
»t
 > 
FS_VERITY_MAX_DESCRIPTOR_SIZE
) {

5188 
»t
 = -
EMSGSIZE
;

5189 
ut
;

5191 ià(!
sùx
->
v”™y_desütÜ
) {

5192 
sùx
->
v”™y_desütÜ
 = 
	`kvm®loc
(
FS_VERITY_MAX_DESCRIPTOR_SIZE
,

5193 
GFP_KERNEL
);

5194 ià(!
sùx
->
v”™y_desütÜ
) {

5195 
»t
 = -
ENOMEM
;

5196 
ut
;

5200 
»t
 = 
	`bŒfs_g‘_v”™y_desütÜ
(
šode
, 
sùx
->
v”™y_desütÜ
,„et);

5201 ià(
»t
 < 0)

5202 
ut
;

5204 
p
 = 
	`fs_·th_®loc
();

5205 ià(!
p
) {

5206 
»t
 = -
ENOMEM
;

5207 
ut
;

5209 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
, 
p
);

5210 ià(
»t
 < 0)

5211 
ä“_·th
;

5213 
»t
 = 
	`£nd_v”™y
(
sùx
, 
p
, sùx->
v”™y_desütÜ
);

5214 ià(
»t
 < 0)

5215 
ä“_·th
;

5217 
ä“_·th
:

5218 
	`fs_·th_ä“
(
p
);

5219 
ut
:

5220 
	`ut
(
šode
);

5221  
»t
;

5222 
	}
}

5224 
šlše
 
u64
 
	$max_£nd_»ad_size
(cÚ¡ 
£nd_ùx
 *
sùx
)

5226  
sùx
->
£nd_max_size
 - 
SZ_16K
;

5227 
	}
}

5229 
	$put_d©a_h—d”
(
£nd_ùx
 *
sùx
, 
u32
 
Ën
)

5231 ià(
	`WARN_ON_ONCE
(
sùx
->
put_d©a
))

5232  -
EINVAL
;

5233 
sùx
->
put_d©a
 = 
Œue
;

5234 ià(
sùx
->
´Ùo
 >= 2) {

5239 ià(
sùx
->
£nd_max_size
 - sùx->
£nd_size
 < (
__Ë16
è+ 
Ën
)

5240  -
EOVERFLOW
;

5241 
	`put_uÇligÃd_Ë16
(
BTRFS_SEND_A_DATA
, 
sùx
->
£nd_buf
 + sùx->
£nd_size
);

5242 
sùx
->
£nd_size
 +ğ(
__Ë16
);

5244 
bŒfs_v_h—d”
 *
hdr
;

5246 ià(
sùx
->
£nd_max_size
 - sùx->
£nd_size
 < (*
hdr
è+ 
Ën
)

5247  -
EOVERFLOW
;

5248 
hdr
 = (
bŒfs_v_h—d”
 *)(
sùx
->
£nd_buf
 + sùx->
£nd_size
);

5249 
	`put_uÇligÃd_Ë16
(
BTRFS_SEND_A_DATA
, &
hdr
->
v_ty³
);

5250 
	`put_uÇligÃd_Ë16
(
Ën
, &
hdr
->
v_Ën
);

5251 
sùx
->
£nd_size
 +ğ(*
hdr
);

5254 
	}
}

5256 
	$put_fe_d©a
(
£nd_ùx
 *
sùx
, 
u64
 
off£t
, 
u32
 
Ën
)

5258 
bŒfs_roÙ
 *
roÙ
 = 
sùx
->
£nd_roÙ
;

5259 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5260 
·ge
 *page;

5261 
pgoff_t
 
šdex
 = 
off£t
 >> 
PAGE_SHIFT
;

5262 
pgoff_t
 
Ï¡_šdex
;

5263 
pg_off£t
 = 
	`off£t_š_·ge
(
off£t
);

5264 
»t
;

5266 
»t
 = 
	`put_d©a_h—d”
(
sùx
, 
Ën
);

5267 ià(
»t
)

5268  
»t
;

5270 
Ï¡_šdex
 = (
off£t
 + 
Ën
 - 1è>> 
PAGE_SHIFT
;

5272 
šdex
 <ğ
Ï¡_šdex
) {

5273 
cur_Ën
 = 
	`mš_t
(, 
Ën
,

5274 
PAGE_SIZE
 - 
pg_off£t
);

5276 
·ge
 = 
	`fšd_lock_·ge
(
sùx
->
cur_šode
->
i_m­pšg
, 
šdex
);

5277 ià(!
·ge
) {

5278 
	`·ge_ÿche_sync_»adah—d
(
sùx
->
cur_šode
->
i_m­pšg
,

5279 &
sùx
->
¿
, 
NULL
, 
šdex
,

5280 
Ï¡_šdex
 + 1 - 
šdex
);

5282 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
sùx
->
cur_šode
->
i_m­pšg
,

5283 
šdex
, 
GFP_KERNEL
);

5284 ià(!
·ge
) {

5285 
»t
 = -
ENOMEM
;

5290 ià(
	`PageR—dah—d
(
·ge
))

5291 
	`·ge_ÿche_async_»adah—d
(
sùx
->
cur_šode
->
i_m­pšg
,

5292 &
sùx
->
¿
, 
NULL
, 
	`·ge_fŞio
(
·ge
),

5293 
šdex
, 
Ï¡_šdex
 + 1 - index);

5295 ià(!
	`PageU±od©e
(
·ge
)) {

5296 
	`bŒfs_»ad_fŞio
(
NULL
, 
	`·ge_fŞio
(
·ge
));

5297 
	`lock_·ge
(
·ge
);

5298 ià(!
	`PageU±od©e
(
·ge
)) {

5299 
	`uÆock_·ge
(
·ge
);

5300 
	`bŒfs_”r
(
fs_šfo
,

5302 
	`·ge_off£t
(
·ge
), 
sùx
->
cur_šo
,

5303 
sùx
->
£nd_roÙ
->
roÙ_key
.
objeùid
);

5304 
	`put_·ge
(
·ge
);

5305 
»t
 = -
EIO
;

5310 
	`memıy_äom_·ge
(
sùx
->
£nd_buf
 + sùx->
£nd_size
, 
·ge
,

5311 
pg_off£t
, 
cur_Ën
);

5312 
	`uÆock_·ge
(
·ge
);

5313 
	`put_·ge
(
·ge
);

5314 
šdex
++;

5315 
pg_off£t
 = 0;

5316 
Ën
 -ğ
cur_Ën
;

5317 
sùx
->
£nd_size
 +ğ
cur_Ën
;

5320  
»t
;

5321 
	}
}

5327 
	$£nd_wr™e
(
£nd_ùx
 *
sùx
, 
u64
 
off£t
, 
u32
 
Ën
)

5329 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

5330 
»t
 = 0;

5331 
fs_·th
 *
p
;

5333 
p
 = 
	`fs_·th_®loc
();

5334 ià(!
p
)

5335  -
ENOMEM
;

5337 
	`bŒfs_debug
(
fs_šfo
, "£nd_wr™off£t=%Îu,†’=%d", 
off£t
, 
Ën
);

5339 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_WRITE
);

5340 ià(
»t
 < 0)

5341 
out
;

5343 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
, 
p
);

5344 ià(
»t
 < 0)

5345 
out
;

5347 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

5348 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_FILE_OFFSET
, 
off£t
);

5349 
»t
 = 
	`put_fe_d©a
(
sùx
, 
off£t
, 
Ën
);

5350 ià(
»t
 < 0)

5351 
out
;

5353 
»t
 = 
	`£nd_cmd
(
sùx
);

5355 
v_put_çu»
:

5356 
out
:

5357 
	`fs_·th_ä“
(
p
);

5358  
»t
;

5359 
	}
}

5364 
	$£nd_şÚe
(
£nd_ùx
 *
sùx
,

5365 
u64
 
off£t
, 
u32
 
Ën
,

5366 
şÚe_roÙ
 *clone_root)

5368 
»t
 = 0;

5369 
fs_·th
 *
p
;

5370 
u64
 
g’
;

5372 
	`bŒfs_debug
(
sùx
->
£nd_roÙ
->
fs_šfo
,

5374 
off£t
, 
Ën
, 
şÚe_roÙ
->
roÙ
->
roÙ_key
.
objeùid
,

5375 
şÚe_roÙ
->
šo
, clÚe_roÙ->
off£t
);

5377 
p
 = 
	`fs_·th_®loc
();

5378 ià(!
p
)

5379  -
ENOMEM
;

5381 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_CLONE
);

5382 ià(
»t
 < 0)

5383 
out
;

5385 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
, 
p
);

5386 ià(
»t
 < 0)

5387 
out
;

5389 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_FILE_OFFSET
, 
off£t
);

5390 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_CLONE_LEN
, 
Ën
);

5391 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

5393 ià(
şÚe_roÙ
->
roÙ
 =ğ
sùx
->
£nd_roÙ
) {

5394 
»t
 = 
	`g‘_šode_g’
(
sùx
->
£nd_roÙ
, 
şÚe_roÙ
->
šo
, &
g’
);

5395 ià(
»t
 < 0)

5396 
out
;

5397 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
şÚe_roÙ
->
šo
, 
g’
, 
p
);

5399 
»t
 = 
	`g‘_šode_·th
(
şÚe_roÙ
->
roÙ
, clÚe_roÙ->
šo
, 
p
);

5401 ià(
»t
 < 0)

5402 
out
;

5413 ià(!
	`bŒfs_is_em±y_uuid
(
şÚe_roÙ
->
roÙ
->
roÙ_™em
.
»ûived_uuid
))

5414 
	`TLV_PUT_UUID
(
sùx
, 
BTRFS_SEND_A_CLONE_UUID
,

5415 
şÚe_roÙ
->
roÙ
->
roÙ_™em
.
»ûived_uuid
);

5417 
	`TLV_PUT_UUID
(
sùx
, 
BTRFS_SEND_A_CLONE_UUID
,

5418 
şÚe_roÙ
->
roÙ
->
roÙ_™em
.
uuid
);

5419 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_CLONE_CTRANSID
,

5420 
	`bŒfs_roÙ_ù¿nsid
(&
şÚe_roÙ
->
roÙ
->
roÙ_™em
));

5421 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_CLONE_PATH
, 
p
);

5422 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_CLONE_OFFSET
,

5423 
şÚe_roÙ
->
off£t
);

5425 
»t
 = 
	`£nd_cmd
(
sùx
);

5427 
v_put_çu»
:

5428 
out
:

5429 
	`fs_·th_ä“
(
p
);

5430  
»t
;

5431 
	}
}

5436 
	$£nd_upd©e_ex‹Á
(
£nd_ùx
 *
sùx
,

5437 
u64
 
off£t
, 
u32
 
Ën
)

5439 
»t
 = 0;

5440 
fs_·th
 *
p
;

5442 
p
 = 
	`fs_·th_®loc
();

5443 ià(!
p
)

5444  -
ENOMEM
;

5446 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_UPDATE_EXTENT
);

5447 ià(
»t
 < 0)

5448 
out
;

5450 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
, 
p
);

5451 ià(
»t
 < 0)

5452 
out
;

5454 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

5455 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_FILE_OFFSET
, 
off£t
);

5456 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_SIZE
, 
Ën
);

5458 
»t
 = 
	`£nd_cmd
(
sùx
);

5460 
v_put_çu»
:

5461 
out
:

5462 
	`fs_·th_ä“
(
p
);

5463  
»t
;

5464 
	}
}

5466 
	$£nd_hŞe
(
£nd_ùx
 *
sùx
, 
u64
 
’d
)

5468 
fs_·th
 *
p
 = 
NULL
;

5469 
u64
 
»ad_size
 = 
	`max_£nd_»ad_size
(
sùx
);

5470 
u64
 
off£t
 = 
sùx
->
cur_šode_Ï¡_ex‹Á
;

5471 
»t
 = 0;

5479 ià(
off£t
 >ğ
sùx
->
cur_šode_size
)

5486 
’d
 = 
	`mš_t
(
u64
,ƒnd, 
sùx
->
cur_šode_size
);

5488 ià(
sùx
->
æags
 & 
BTRFS_SEND_FLAG_NO_FILE_DATA
)

5489  
	`£nd_upd©e_ex‹Á
(
sùx
, 
off£t
, 
’d
 - offset);

5491 
p
 = 
	`fs_·th_®loc
();

5492 ià(!
p
)

5493  -
ENOMEM
;

5494 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
, 
p
);

5495 ià(
»t
 < 0)

5496 
v_put_çu»
;

5497 
off£t
 < 
’d
) {

5498 
u64
 
Ën
 = 
	`mš
(
’d
 - 
off£t
, 
»ad_size
);

5500 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_WRITE
);

5501 ià(
»t
 < 0)

5503 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

5504 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_FILE_OFFSET
, 
off£t
);

5505 
»t
 = 
	`put_d©a_h—d”
(
sùx
, 
Ën
);

5506 ià(
»t
 < 0)

5508 
	`mem£t
(
sùx
->
£nd_buf
 + sùx->
£nd_size
, 0, 
Ën
);

5509 
sùx
->
£nd_size
 +ğ
Ën
;

5510 
»t
 = 
	`£nd_cmd
(
sùx
);

5511 ià(
»t
 < 0)

5513 
off£t
 +ğ
Ën
;

5515 
sùx
->
cur_šode_Ãxt_wr™e_off£t
 = 
off£t
;

5516 
v_put_çu»
:

5517 
	`fs_·th_ä“
(
p
);

5518  
»t
;

5519 
	}
}

5521 
	$£nd_’coded_šlše_ex‹Á
(
£nd_ùx
 *
sùx
,

5522 
bŒfs_·th
 *
·th
, 
u64
 
off£t
,

5523 
u64
 
Ën
)

5525 
bŒfs_roÙ
 *
roÙ
 = 
sùx
->
£nd_roÙ
;

5526 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5527 
šode
 *inode;

5528 
fs_·th
 *
f¥©h
;

5529 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

5530 
bŒfs_key
 
key
;

5531 
bŒfs_fe_ex‹Á_™em
 *
ei
;

5532 
u64
 
¿m_by‹s
;

5533 
size_t
 
šlše_size
;

5534 
»t
;

5536 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
sùx
->
cur_šo
, 
roÙ
);

5537 ià(
	`IS_ERR
(
šode
))

5538  
	`PTR_ERR
(
šode
);

5540 
f¥©h
 = 
	`fs_·th_®loc
();

5541 ià(!
f¥©h
) {

5542 
»t
 = -
ENOMEM
;

5543 
out
;

5546 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_ENCODED_WRITE
);

5547 ià(
»t
 < 0)

5548 
out
;

5550 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
, 
f¥©h
);

5551 ià(
»t
 < 0)

5552 
out
;

5554 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

5555 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_fe_ex‹Á_™em
);

5556 
¿m_by‹s
 = 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
ei
);

5557 
šlše_size
 = 
	`bŒfs_fe_ex‹Á_šlše_™em_Ën
(
Ëaf
, 
·th
->
¦Ùs
[0]);

5559 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
f¥©h
);

5560 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_FILE_OFFSET
, 
off£t
);

5561 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_UNENCODED_FILE_LEN
,

5562 
	`mš
(
key
.
off£t
 + 
¿m_by‹s
 - off£t, 
Ën
));

5563 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_UNENCODED_LEN
, 
¿m_by‹s
);

5564 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_UNENCODED_OFFSET
, 
off£t
 - 
key
.offset);

5565 
»t
 = 
	`bŒfs_’coded_io_com´essiÚ_äom_ex‹Á
(
fs_šfo
,

5566 
	`bŒfs_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
ei
));

5567 ià(
»t
 < 0)

5568 
out
;

5569 
	`TLV_PUT_U32
(
sùx
, 
BTRFS_SEND_A_COMPRESSION
, 
»t
);

5571 
»t
 = 
	`put_d©a_h—d”
(
sùx
, 
šlše_size
);

5572 ià(
»t
 < 0)

5573 
out
;

5574 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
sùx
->
£nd_buf
 + sùx->
£nd_size
,

5575 
	`bŒfs_fe_ex‹Á_šlše_¡¬t
(
ei
), 
šlše_size
);

5576 
sùx
->
£nd_size
 +ğ
šlše_size
;

5578 
»t
 = 
	`£nd_cmd
(
sùx
);

5580 
v_put_çu»
:

5581 
out
:

5582 
	`fs_·th_ä“
(
f¥©h
);

5583 
	`ut
(
šode
);

5584  
»t
;

5585 
	}
}

5587 
	$£nd_’coded_ex‹Á
(
£nd_ùx
 *
sùx
, 
bŒfs_·th
 *
·th
,

5588 
u64
 
off£t
, u64 
Ën
)

5590 
bŒfs_roÙ
 *
roÙ
 = 
sùx
->
£nd_roÙ
;

5591 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5592 
šode
 *inode;

5593 
fs_·th
 *
f¥©h
;

5594 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

5595 
bŒfs_key
 
key
;

5596 
bŒfs_fe_ex‹Á_™em
 *
ei
;

5597 
u64
 
disk_by‹Ä
, 
disk_num_by‹s
;

5598 
u32
 
d©a_off£t
;

5599 
bŒfs_cmd_h—d”
 *
hdr
;

5600 
u32
 
üc
;

5601 
»t
;

5603 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
sùx
->
cur_šo
, 
roÙ
);

5604 ià(
	`IS_ERR
(
šode
))

5605  
	`PTR_ERR
(
šode
);

5607 
f¥©h
 = 
	`fs_·th_®loc
();

5608 ià(!
f¥©h
) {

5609 
»t
 = -
ENOMEM
;

5610 
out
;

5613 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_ENCODED_WRITE
);

5614 ià(
»t
 < 0)

5615 
out
;

5617 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
, 
f¥©h
);

5618 ià(
»t
 < 0)

5619 
out
;

5621 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

5622 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_fe_ex‹Á_™em
);

5623 
disk_by‹Ä
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
ei
);

5624 
disk_num_by‹s
 = 
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
Ëaf
, 
ei
);

5626 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
f¥©h
);

5627 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_FILE_OFFSET
, 
off£t
);

5628 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_UNENCODED_FILE_LEN
,

5629 
	`mš
(
key
.
off£t
 + 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
ei
) - offset,

5630 
Ën
));

5631 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_UNENCODED_LEN
,

5632 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
ei
));

5633 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_UNENCODED_OFFSET
,

5634 
off£t
 - 
key
.off£ˆ+ 
	`bŒfs_fe_ex‹Á_off£t
(
Ëaf
, 
ei
));

5635 
»t
 = 
	`bŒfs_’coded_io_com´essiÚ_äom_ex‹Á
(
fs_šfo
,

5636 
	`bŒfs_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
ei
));

5637 ià(
»t
 < 0)

5638 
out
;

5639 
	`TLV_PUT_U32
(
sùx
, 
BTRFS_SEND_A_COMPRESSION
, 
»t
);

5640 
	`TLV_PUT_U32
(
sùx
, 
BTRFS_SEND_A_ENCRYPTION
, 0);

5642 
»t
 = 
	`put_d©a_h—d”
(
sùx
, 
disk_num_by‹s
);

5643 ià(
»t
 < 0)

5644 
out
;

5651 
d©a_off£t
 = 
	`PAGE_ALIGN
(
sùx
->
£nd_size
);

5652 ià(
d©a_off£t
 > 
sùx
->
£nd_max_size
 ||

5653 
sùx
->
£nd_max_size
 - 
d©a_off£t
 < 
disk_num_by‹s
) {

5654 
»t
 = -
EOVERFLOW
;

5655 
out
;

5662 
»t
 = 
	`bŒfs_’coded_»ad_»guÏr_fl_·ges
(
	`BTRFS_I
(
šode
), 
off£t
,

5663 
disk_by‹Ä
, 
disk_num_by‹s
,

5664 
sùx
->
£nd_buf_·ges
 +

5665 (
d©a_off£t
 >> 
PAGE_SHIFT
));

5666 ià(
»t
)

5667 
out
;

5669 
hdr
 = (
bŒfs_cmd_h—d”
 *)
sùx
->
£nd_buf
;

5670 
hdr
->
Ën
 = 
	`ıu_to_Ë32
(
sùx
->
£nd_size
 + 
disk_num_by‹s
 - (*hdr));

5671 
hdr
->
üc
 = 0;

5672 
üc
 = 
	`bŒfs_üc32c
(0, 
sùx
->
£nd_buf
, sùx->
£nd_size
);

5673 
üc
 = 
	`bŒfs_üc32c
(üc, 
sùx
->
£nd_buf
 + 
d©a_off£t
, 
disk_num_by‹s
);

5674 
hdr
->
üc
 = 
	`ıu_to_Ë32
(crc);

5676 
»t
 = 
	`wr™e_buf
(
sùx
->
£nd_fp
, sùx->
£nd_buf
, sùx->
£nd_size
,

5677 &
sùx
->
£nd_off
);

5678 ià(!
»t
) {

5679 
»t
 = 
	`wr™e_buf
(
sùx
->
£nd_fp
, sùx->
£nd_buf
 + 
d©a_off£t
,

5680 
disk_num_by‹s
, &
sùx
->
£nd_off
);

5682 
sùx
->
£nd_size
 = 0;

5683 
sùx
->
put_d©a
 = 
çl£
;

5685 
v_put_çu»
:

5686 
out
:

5687 
	`fs_·th_ä“
(
f¥©h
);

5688 
	`ut
(
šode
);

5689  
»t
;

5690 
	}
}

5692 
	$£nd_ex‹Á_d©a
(
£nd_ùx
 *
sùx
, 
bŒfs_·th
 *
·th
,

5693 cÚ¡ 
u64
 
off£t
, cÚ¡ u64 
Ën
)

5695 cÚ¡ 
u64
 
’d
 = 
off£t
 + 
Ën
;

5696 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

5697 
bŒfs_fe_ex‹Á_™em
 *
ei
;

5698 
u64
 
»ad_size
 = 
	`max_£nd_»ad_size
(
sùx
);

5699 
u64
 
£Á
 = 0;

5701 ià(
sùx
->
æags
 & 
BTRFS_SEND_FLAG_NO_FILE_DATA
)

5702  
	`£nd_upd©e_ex‹Á
(
sùx
, 
off£t
, 
Ën
);

5704 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

5705 
bŒfs_fe_ex‹Á_™em
);

5706 ià((
sùx
->
æags
 & 
BTRFS_SEND_FLAG_COMPRESSED
) &&

5707 
	`bŒfs_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
ei
è!ğ
BTRFS_COMPRESS_NONE
) {

5708 
boŞ
 
is_šlše
 = (
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
ei
) ==

5709 
BTRFS_FILE_EXTENT_INLINE
);

5718 ià(
is_šlše
 &&

5719 
	`bŒfs_fe_ex‹Á_šlše_™em_Ën
(
Ëaf
,

5720 
·th
->
¦Ùs
[0]è<ğ
Ën
) {

5721  
	`£nd_’coded_šlše_ex‹Á
(
sùx
, 
·th
, 
off£t
,

5722 
Ën
);

5723 } ià(!
is_šlše
 &&

5724 
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
Ëaf
, 
ei
è<ğ
Ën
) {

5725  
	`£nd_’coded_ex‹Á
(
sùx
, 
·th
, 
off£t
, 
Ën
);

5729 ià(
sùx
->
cur_šode
 =ğ
NULL
) {

5730 
bŒfs_roÙ
 *
roÙ
 = 
sùx
->
£nd_roÙ
;

5732 
sùx
->
cur_šode
 = 
	`bŒfs_ig‘
(
roÙ
->
fs_šfo
->
sb
, sùx->
cur_šo
,„oot);

5733 ià(
	`IS_ERR
(
sùx
->
cur_šode
)) {

5734 
”r
 = 
	`PTR_ERR
(
sùx
->
cur_šode
);

5736 
sùx
->
cur_šode
 = 
NULL
;

5737  
”r
;

5739 
	`mem£t
(&
sùx
->
¿
, 0, (
fe_¿_¡©e
));

5740 
	`fe_¿_¡©e_š™
(&
sùx
->
¿
, sùx->
cur_šode
->
i_m­pšg
);

5761 
sùx
->
ş—n_·ge_ÿche
 = (sùx->
cur_šode
->
i_m­pšg
->
Ä·ges
 == 0);

5762 
sùx
->
·ge_ÿche_ş—r_¡¬t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

5765 
£Á
 < 
Ën
) {

5766 
u64
 
size
 = 
	`mš
(
Ën
 - 
£Á
, 
»ad_size
);

5767 
»t
;

5769 
»t
 = 
	`£nd_wr™e
(
sùx
, 
off£t
 + 
£Á
, 
size
);

5770 ià(
»t
 < 0)

5771  
»t
;

5772 
£Á
 +ğ
size
;

5775 ià(
sùx
->
ş—n_·ge_ÿche
 && 
	`PAGE_ALIGNED
(
’d
)) {

5799 
	`Œunÿ‹_šode_·ges_¿nge
(&
sùx
->
cur_šode
->
i_d©a
,

5800 
sùx
->
·ge_ÿche_ş—r_¡¬t
,

5801 
’d
 - 1);

5802 
sùx
->
·ge_ÿche_ş—r_¡¬t
 = 
’d
;

5806 
	}
}

5815 
	$£nd_ÿ·b™›s
(
£nd_ùx
 *
sùx
)

5817 
fs_·th
 *
f¥©h
 = 
NULL
;

5818 
bŒfs_·th
 *
·th
;

5819 
bŒfs_dœ_™em
 *
di
;

5820 
ex‹Á_bufãr
 *
Ëaf
;

5821 
d©a_±r
;

5822 *
buf
 = 
NULL
;

5823 
buf_Ën
;

5824 
»t
 = 0;

5826 
·th
 = 
	`®loc_·th_fÜ_£nd
();

5827 ià(!
·th
)

5828  -
ENOMEM
;

5830 
di
 = 
	`bŒfs_lookup_x©Œ
(
NULL
, 
sùx
->
£nd_roÙ
, 
·th
, sùx->
cur_šo
,

5831 
XATTR_NAME_CAPS
, 
	`¡¾’
(XATTR_NAME_CAPS), 0);

5832 ià(!
di
) {

5834 
out
;

5835 } ià(
	`IS_ERR
(
di
)) {

5836 
»t
 = 
	`PTR_ERR
(
di
);

5837 
out
;

5840 
Ëaf
 = 
·th
->
nodes
[0];

5841 
buf_Ën
 = 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
);

5843 
f¥©h
 = 
	`fs_·th_®loc
();

5844 
buf
 = 
	`km®loc
(
buf_Ën
, 
GFP_KERNEL
);

5845 ià(!
f¥©h
 || !
buf
) {

5846 
»t
 = -
ENOMEM
;

5847 
out
;

5850 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
, 
f¥©h
);

5851 ià(
»t
 < 0)

5852 
out
;

5854 
d©a_±r
 = ()(
di
 + 1è+ 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, di);

5855 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
buf
, 
d©a_±r
, 
buf_Ën
);

5857 
»t
 = 
	`£nd_£t_x©Œ
(
sùx
, 
f¥©h
, 
XATTR_NAME_CAPS
,

5858 
	`¡¾’
(
XATTR_NAME_CAPS
), 
buf
, 
buf_Ën
);

5859 
out
:

5860 
	`kä“
(
buf
);

5861 
	`fs_·th_ä“
(
f¥©h
);

5862 
	`bŒfs_ä“_·th
(
·th
);

5863  
»t
;

5864 
	}
}

5866 
	$şÚe_¿nge
(
£nd_ùx
 *
sùx
, 
bŒfs_·th
 *
d¡_·th
,

5867 
şÚe_roÙ
 *şÚe_roÙ, cÚ¡ 
u64
 
disk_by‹
,

5868 
u64
 
d©a_off£t
, u64 
off£t
, u64 
Ën
)

5870 
bŒfs_·th
 *
·th
;

5871 
bŒfs_key
 
key
;

5872 
»t
;

5873 
bŒfs_šode_šfo
 
šfo
;

5874 
u64
 
şÚe_¤c_i_size
 = 0;

5891 ià(
şÚe_roÙ
->
off£t
 == 0 &&

5892 
Ën
 =ğ
sùx
->
£nd_roÙ
->
fs_šfo
->
£ùÜsize
)

5893  
	`£nd_ex‹Á_d©a
(
sùx
, 
d¡_·th
, 
off£t
, 
Ën
);

5895 
·th
 = 
	`®loc_·th_fÜ_£nd
();

5896 ià(!
·th
)

5897  -
ENOMEM
;

5903 
»t
 = 
	`g‘_šode_šfo
(
şÚe_roÙ
->
roÙ
, clÚe_roÙ->
šo
, &
šfo
);

5904 
	`bŒfs_»Ëa£_·th
(
·th
);

5905 ià(
»t
 < 0)

5906 
out
;

5907 
şÚe_¤c_i_size
 = 
šfo
.
size
;

5931 
key
.
objeùid
 = 
şÚe_roÙ
->
šo
;

5932 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

5933 
key
.
off£t
 = 
şÚe_roÙ
->offset;

5934 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
şÚe_roÙ
->
roÙ
, &
key
, 
·th
, 0, 0);

5935 ià(
»t
 < 0)

5936 
out
;

5937 ià(
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0) {

5938 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0] - 1);

5939 ià(
key
.
objeùid
 =ğ
şÚe_roÙ
->
šo
 &&

5940 
key
.
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
)

5941 
·th
->
¦Ùs
[0]--;

5944 
Œue
) {

5945 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

5946 
¦Ù
 = 
·th
->
¦Ùs
[0];

5947 
bŒfs_fe_ex‹Á_™em
 *
ei
;

5948 
u8
 
ty³
;

5949 
u64
 
ext_Ën
;

5950 
u64
 
şÚe_Ën
;

5951 
u64
 
şÚe_d©a_off£t
;

5952 
boŞ
 
üos£d_¤c_i_size
 = 
çl£
;

5954 ià(
¦Ù
 >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

5955 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
şÚe_roÙ
->
roÙ
, 
·th
);

5956 ià(
»t
 < 0)

5957 
out
;

5958 ià(
»t
 > 0)

5963 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

5969 ià(
key
.
objeùid
 !ğ
şÚe_roÙ
->
šo
 ||

5970 
key
.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

5973 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_fe_ex‹Á_™em
);

5974 
ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
ei
);

5975 ià(
ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
) {

5976 
ext_Ën
 = 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
ei
);

5977 
ext_Ën
 = 
	`PAGE_ALIGN
(ext_len);

5979 
ext_Ën
 = 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
ei
);

5982 ià(
key
.
off£t
 + 
ext_Ën
 <ğ
şÚe_roÙ
->offset)

5983 
Ãxt
;

5985 ià(
key
.
off£t
 > 
şÚe_roÙ
->offset) {

5987 
u64
 
hŞe_Ën
 = 
key
.
off£t
 - 
şÚe_roÙ
->offset;

5989 ià(
hŞe_Ën
 > 
Ën
)

5990 
hŞe_Ën
 = 
Ën
;

5991 
»t
 = 
	`£nd_ex‹Á_d©a
(
sùx
, 
d¡_·th
, 
off£t
,

5992 
hŞe_Ën
);

5993 ià(
»t
 < 0)

5994 
out
;

5996 
Ën
 -ğ
hŞe_Ën
;

5997 ià(
Ën
 == 0)

5999 
off£t
 +ğ
hŞe_Ën
;

6000 
şÚe_roÙ
->
off£t
 +ğ
hŞe_Ën
;

6001 
d©a_off£t
 +ğ
hŞe_Ën
;

6004 ià(
key
.
off£t
 >ğ
şÚe_roÙ
->off£ˆ+ 
Ën
)

6007 ià(
key
.
off£t
 >ğ
şÚe_¤c_i_size
)

6010 ià(
key
.
off£t
 + 
ext_Ën
 > 
şÚe_¤c_i_size
) {

6011 
ext_Ën
 = 
şÚe_¤c_i_size
 - 
key
.
off£t
;

6012 
üos£d_¤c_i_size
 = 
Œue
;

6015 
şÚe_d©a_off£t
 = 
	`bŒfs_fe_ex‹Á_off£t
(
Ëaf
, 
ei
);

6016 ià(
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
ei
è=ğ
disk_by‹
) {

6017 
şÚe_roÙ
->
off£t
 = 
key
.offset;

6018 ià(
şÚe_d©a_off£t
 < 
d©a_off£t
 &&

6019 
şÚe_d©a_off£t
 + 
ext_Ën
 > 
d©a_off£t
) {

6020 
u64
 
ex‹Á_off£t
;

6022 
ex‹Á_off£t
 = 
d©a_off£t
 - 
şÚe_d©a_off£t
;

6023 
ext_Ën
 -ğ
ex‹Á_off£t
;

6024 
şÚe_d©a_off£t
 +ğ
ex‹Á_off£t
;

6025 
şÚe_roÙ
->
off£t
 +ğ
ex‹Á_off£t
;

6029 
şÚe_Ën
 = 
	`mš_t
(
u64
, 
ext_Ën
, 
Ën
);

6031 ià(
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
ei
è=ğ
disk_by‹
 &&

6032 
şÚe_d©a_off£t
 =ğ
d©a_off£t
) {

6033 cÚ¡ 
u64
 
¤c_’d
 = 
şÚe_roÙ
->
off£t
 + 
şÚe_Ën
;

6034 cÚ¡ 
u64
 
£ùÜsize
 = 
SZ_64K
;

6054 ià(
¤c_’d
 =ğ
şÚe_¤c_i_size
 &&

6055 !
	`IS_ALIGNED
(
¤c_’d
, 
£ùÜsize
) &&

6056 
off£t
 + 
şÚe_Ën
 < 
sùx
->
cur_šode_size
) {

6057 
u64
 
¦’
;

6059 
¦’
 = 
	`ALIGN_DOWN
(
¤c_’d
 - 
şÚe_roÙ
->
off£t
,

6060 
£ùÜsize
);

6061 ià(
¦’
 > 0) {

6062 
»t
 = 
	`£nd_şÚe
(
sùx
, 
off£t
, 
¦’
,

6063 
şÚe_roÙ
);

6064 ià(
»t
 < 0)

6065 
out
;

6067 
»t
 = 
	`£nd_ex‹Á_d©a
(
sùx
, 
d¡_·th
,

6068 
off£t
 + 
¦’
,

6069 
şÚe_Ën
 - 
¦’
);

6071 
»t
 = 
	`£nd_şÚe
(
sùx
, 
off£t
, 
şÚe_Ën
,

6072 
şÚe_roÙ
);

6074 } ià(
üos£d_¤c_i_size
 && 
şÚe_Ën
 < 
Ën
) {

6094 
»t
 = 
	`£nd_ex‹Á_d©a
(
sùx
, 
d¡_·th
, 
off£t
,

6095 
şÚe_Ën
);

6098 ià(
»t
 < 0)

6099 
out
;

6101 
Ën
 -ğ
şÚe_Ën
;

6102 ià(
Ën
 == 0)

6104 
off£t
 +ğ
şÚe_Ën
;

6105 
şÚe_roÙ
->
off£t
 +ğ
şÚe_Ën
;

6116 ià(
şÚe_roÙ
->
roÙ
 =ğ
sùx
->
£nd_roÙ
 &&

6117 
şÚe_roÙ
->
šo
 =ğ
sùx
->
cur_šo
 &&

6118 
şÚe_roÙ
->
off£t
 >ğ
sùx
->
cur_šode_Ãxt_wr™e_off£t
)

6121 
d©a_off£t
 +ğ
şÚe_Ën
;

6122 
Ãxt
:

6123 
·th
->
¦Ùs
[0]++;

6126 ià(
Ën
 > 0)

6127 
»t
 = 
	`£nd_ex‹Á_d©a
(
sùx
, 
d¡_·th
, 
off£t
, 
Ën
);

6129 
»t
 = 0;

6130 
out
:

6131 
	`bŒfs_ä“_·th
(
·th
);

6132  
»t
;

6133 
	}
}

6135 
	$£nd_wr™e_Ü_şÚe
(
£nd_ùx
 *
sùx
,

6136 
bŒfs_·th
 *
·th
,

6137 
bŒfs_key
 *
key
,

6138 
şÚe_roÙ
 *clone_root)

6140 
»t
 = 0;

6141 
u64
 
off£t
 = 
key
->offset;

6142 
u64
 
’d
;

6143 
u64
 
bs
 = 
sùx
->
£nd_roÙ
->
fs_šfo
->
sb
->
s_blocksize
;

6145 
’d
 = 
	`mš_t
(
u64
, 
	`bŒfs_fe_ex‹Á_’d
(
·th
), 
sùx
->
cur_šode_size
);

6146 ià(
off£t
 >ğ
’d
)

6149 ià(
şÚe_roÙ
 && 
	`IS_ALIGNED
(
’d
, 
bs
)) {

6150 
bŒfs_fe_ex‹Á_™em
 *
ei
;

6151 
u64
 
disk_by‹
;

6152 
u64
 
d©a_off£t
;

6154 
ei
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

6155 
bŒfs_fe_ex‹Á_™em
);

6156 
disk_by‹
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
·th
->
nodes
[0], 
ei
);

6157 
d©a_off£t
 = 
	`bŒfs_fe_ex‹Á_off£t
(
·th
->
nodes
[0], 
ei
);

6158 
»t
 = 
	`şÚe_¿nge
(
sùx
, 
·th
, 
şÚe_roÙ
, 
disk_by‹
,

6159 
d©a_off£t
, 
off£t
, 
’d
 - offset);

6161 
»t
 = 
	`£nd_ex‹Á_d©a
(
sùx
, 
·th
, 
off£t
, 
’d
 - offset);

6163 
sùx
->
cur_šode_Ãxt_wr™e_off£t
 = 
’d
;

6164  
»t
;

6165 
	}
}

6167 
	$is_ex‹Á_unchªged
(
£nd_ùx
 *
sùx
,

6168 
bŒfs_·th
 *
Ëá_·th
,

6169 
bŒfs_key
 *
ekey
)

6171 
»t
 = 0;

6172 
bŒfs_key
 
key
;

6173 
bŒfs_·th
 *
·th
 = 
NULL
;

6174 
ex‹Á_bufãr
 *
eb
;

6175 
¦Ù
;

6176 
bŒfs_key
 
found_key
;

6177 
bŒfs_fe_ex‹Á_™em
 *
ei
;

6178 
u64
 
Ëá_diskÄ
;

6179 
u64
 
right_diskÄ
;

6180 
u64
 
Ëá_off£t
;

6181 
u64
 
right_off£t
;

6182 
u64
 
Ëá_off£t_fixed
;

6183 
u64
 
Ëá_Ën
;

6184 
u64
 
right_Ën
;

6185 
u64
 
Ëá_g’
;

6186 
u64
 
right_g’
;

6187 
u8
 
Ëá_ty³
;

6188 
u8
 
right_ty³
;

6190 
·th
 = 
	`®loc_·th_fÜ_£nd
();

6191 ià(!
·th
)

6192  -
ENOMEM
;

6194 
eb
 = 
Ëá_·th
->
nodes
[0];

6195 
¦Ù
 = 
Ëá_·th
->
¦Ùs
[0];

6196 
ei
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_fe_ex‹Á_™em
);

6197 
Ëá_ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
eb
, 
ei
);

6199 ià(
Ëá_ty³
 !ğ
BTRFS_FILE_EXTENT_REG
) {

6200 
»t
 = 0;

6201 
out
;

6203 
Ëá_diskÄ
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
eb
, 
ei
);

6204 
Ëá_Ën
 = 
	`bŒfs_fe_ex‹Á_num_by‹s
(
eb
, 
ei
);

6205 
Ëá_off£t
 = 
	`bŒfs_fe_ex‹Á_off£t
(
eb
, 
ei
);

6206 
Ëá_g’
 = 
	`bŒfs_fe_ex‹Á_g’”©iÚ
(
eb
, 
ei
);

6229 
key
.
objeùid
 = 
ekey
->objectid;

6230 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

6231 
key
.
off£t
 = 
ekey
->offset;

6232 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
sùx
->
·»Á_roÙ
, &
key
, 
·th
, 0, 0);

6233 ià(
»t
 < 0)

6234 
out
;

6235 ià(
»t
) {

6236 
»t
 = 0;

6237 
out
;

6243 
eb
 = 
·th
->
nodes
[0];

6244 
¦Ù
 = 
·th
->
¦Ùs
[0];

6245 
	`bŒfs_™em_key_to_ıu
(
eb
, &
found_key
, 
¦Ù
);

6246 ià(
found_key
.
objeùid
 !ğ
key
.objectid ||

6247 
found_key
.
ty³
 !ğ
key
.type) {

6249 
»t
 = (
Ëá_diskÄ
) ? 0 : 1;

6250 
out
;

6256 
key
 = 
found_key
;

6257 
key
.
off£t
 < 
ekey
->off£ˆ+ 
Ëá_Ën
) {

6258 
ei
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_fe_ex‹Á_™em
);

6259 
right_ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
eb
, 
ei
);

6260 ià(
right_ty³
 !ğ
BTRFS_FILE_EXTENT_REG
 &&

6261 
right_ty³
 !ğ
BTRFS_FILE_EXTENT_INLINE
) {

6262 
»t
 = 0;

6263 
out
;

6266 ià(
right_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
) {

6267 
right_Ën
 = 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
eb
, 
ei
);

6268 
right_Ën
 = 
	`PAGE_ALIGN
(right_len);

6270 
right_Ën
 = 
	`bŒfs_fe_ex‹Á_num_by‹s
(
eb
, 
ei
);

6277 ià(
found_key
.
off£t
 + 
right_Ën
 <ğ
ekey
->offset) {

6279 
»t
 = (
Ëá_diskÄ
) ? 0 : 1;

6280 
out
;

6291 ià(
right_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
) {

6292 
»t
 = 0;

6293 
out
;

6296 
right_diskÄ
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
eb
, 
ei
);

6297 
right_off£t
 = 
	`bŒfs_fe_ex‹Á_off£t
(
eb
, 
ei
);

6298 
right_g’
 = 
	`bŒfs_fe_ex‹Á_g’”©iÚ
(
eb
, 
ei
);

6300 
Ëá_off£t_fixed
 = 
Ëá_off£t
;

6301 ià(
key
.
off£t
 < 
ekey
->offset) {

6303 
right_off£t
 +ğ
ekey
->
off£t
 - 
key
.offset;

6306 
Ëá_off£t_fixed
 +ğ
key
.
off£t
 - 
ekey
->offset;

6312 ià(
Ëá_diskÄ
 !ğ
right_diskÄ
 ||

6313 
Ëá_off£t_fixed
 !ğ
right_off£t
 ||

6314 
Ëá_g’
 !ğ
right_g’
) {

6315 
»t
 = 0;

6316 
out
;

6322 
»t
 = 
	`bŒfs_Ãxt_™em
(
sùx
->
·»Á_roÙ
, 
·th
);

6323 ià(
»t
 < 0)

6324 
out
;

6325 ià(!
»t
) {

6326 
eb
 = 
·th
->
nodes
[0];

6327 
¦Ù
 = 
·th
->
¦Ùs
[0];

6328 
	`bŒfs_™em_key_to_ıu
(
eb
, &
found_key
, 
¦Ù
);

6330 ià(
»t
 || 
found_key
.
objeùid
 !ğ
key
.objectid ||

6331 
found_key
.
ty³
 !ğ
key
.type) {

6332 
key
.
off£t
 +ğ
right_Ën
;

6335 ià(
found_key
.
off£t
 !ğ
key
.off£ˆ+ 
right_Ën
) {

6336 
»t
 = 0;

6337 
out
;

6339 
key
 = 
found_key
;

6346 ià(
key
.
off£t
 >ğ
ekey
->off£ˆ+ 
Ëá_Ën
)

6347 
»t
 = 1;

6349 
»t
 = 0;

6352 
out
:

6353 
	`bŒfs_ä“_·th
(
·th
);

6354  
»t
;

6355 
	}
}

6357 
	$g‘_Ï¡_ex‹Á
(
£nd_ùx
 *
sùx
, 
u64
 
off£t
)

6359 
bŒfs_·th
 *
·th
;

6360 
bŒfs_roÙ
 *
roÙ
 = 
sùx
->
£nd_roÙ
;

6361 
bŒfs_key
 
key
;

6362 
»t
;

6364 
·th
 = 
	`®loc_·th_fÜ_£nd
();

6365 ià(!
·th
)

6366  -
ENOMEM
;

6368 
sùx
->
cur_šode_Ï¡_ex‹Á
 = 0;

6370 
key
.
objeùid
 = 
sùx
->
cur_šo
;

6371 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

6372 
key
.
off£t
 = offset;

6373 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
roÙ
, &
key
, 
·th
, 0, 1);

6374 ià(
»t
 < 0)

6375 
out
;

6376 
»t
 = 0;

6377 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

6378 ià(
key
.
objeùid
 !ğ
sùx
->
cur_šo
 || key.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

6379 
out
;

6381 
sùx
->
cur_šode_Ï¡_ex‹Á
 = 
	`bŒfs_fe_ex‹Á_’d
(
·th
);

6382 
out
:

6383 
	`bŒfs_ä“_·th
(
·th
);

6384  
»t
;

6385 
	}
}

6387 
	$¿nge_is_hŞe_š_·»Á
(
£nd_ùx
 *
sùx
,

6388 cÚ¡ 
u64
 
¡¬t
,

6389 cÚ¡ 
u64
 
’d
)

6391 
bŒfs_·th
 *
·th
;

6392 
bŒfs_key
 
key
;

6393 
bŒfs_roÙ
 *
roÙ
 = 
sùx
->
·»Á_roÙ
;

6394 
u64
 
£¬ch_¡¬t
 = 
¡¬t
;

6395 
»t
;

6397 
·th
 = 
	`®loc_·th_fÜ_£nd
();

6398 ià(!
·th
)

6399  -
ENOMEM
;

6401 
key
.
objeùid
 = 
sùx
->
cur_šo
;

6402 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

6403 
key
.
off£t
 = 
£¬ch_¡¬t
;

6404 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

6405 ià(
»t
 < 0)

6406 
out
;

6407 ià(
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0)

6408 
·th
->
¦Ùs
[0]--;

6410 
£¬ch_¡¬t
 < 
’d
) {

6411 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

6412 
¦Ù
 = 
·th
->
¦Ùs
[0];

6413 
bŒfs_fe_ex‹Á_™em
 *
fi
;

6414 
u64
 
ex‹Á_’d
;

6416 ià(
¦Ù
 >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

6417 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

6418 ià(
»t
 < 0)

6419 
out
;

6420 ià(
»t
 > 0)

6425 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

6426 ià(
key
.
objeùid
 < 
sùx
->
cur_šo
 ||

6427 
key
.
ty³
 < 
BTRFS_EXTENT_DATA_KEY
)

6428 
Ãxt
;

6429 ià(
key
.
objeùid
 > 
sùx
->
cur_šo
 ||

6430 
key
.
ty³
 > 
BTRFS_EXTENT_DATA_KEY
 ||

6431 
key
.
off£t
 >ğ
’d
)

6434 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_fe_ex‹Á_™em
);

6435 
ex‹Á_’d
 = 
	`bŒfs_fe_ex‹Á_’d
(
·th
);

6436 ià(
ex‹Á_’d
 <ğ
¡¬t
)

6437 
Ãxt
;

6438 ià(
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
) == 0) {

6439 
£¬ch_¡¬t
 = 
ex‹Á_’d
;

6440 
Ãxt
;

6442 
»t
 = 0;

6443 
out
;

6444 
Ãxt
:

6445 
·th
->
¦Ùs
[0]++;

6447 
»t
 = 1;

6448 
out
:

6449 
	`bŒfs_ä“_·th
(
·th
);

6450  
»t
;

6451 
	}
}

6453 
	$maybe_£nd_hŞe
(
£nd_ùx
 *
sùx
, 
bŒfs_·th
 *
·th
,

6454 
bŒfs_key
 *
key
)

6456 
»t
 = 0;

6458 ià(
sùx
->
cur_šo
 !ğ
key
->
objeùid
 || !
	`Ãed_£nd_hŞe
(sctx))

6461 ià(
sùx
->
cur_šode_Ï¡_ex‹Á
 =ğ(
u64
)-1) {

6462 
»t
 = 
	`g‘_Ï¡_ex‹Á
(
sùx
, 
key
->
off£t
 - 1);

6463 ià(
»t
)

6464  
»t
;

6467 ià(
·th
->
¦Ùs
[0] == 0 &&

6468 
sùx
->
cur_šode_Ï¡_ex‹Á
 < 
key
->
off£t
) {

6476 
»t
 = 
	`g‘_Ï¡_ex‹Á
(
sùx
, 
key
->
off£t
 - 1);

6477 ià(
»t
)

6478  
»t
;

6481 ià(
sùx
->
cur_šode_Ï¡_ex‹Á
 < 
key
->
off£t
) {

6482 
»t
 = 
	`¿nge_is_hŞe_š_·»Á
(
sùx
,

6483 
sùx
->
cur_šode_Ï¡_ex‹Á
,

6484 
key
->
off£t
);

6485 ià(
»t
 < 0)

6486  
»t
;

6487 ià(
»t
 == 0)

6488 
»t
 = 
	`£nd_hŞe
(
sùx
, 
key
->
off£t
);

6490 
»t
 = 0;

6492 
sùx
->
cur_šode_Ï¡_ex‹Á
 = 
	`bŒfs_fe_ex‹Á_’d
(
·th
);

6493  
»t
;

6494 
	}
}

6496 
	$´oûss_ex‹Á
(
£nd_ùx
 *
sùx
,

6497 
bŒfs_·th
 *
·th
,

6498 
bŒfs_key
 *
key
)

6500 
şÚe_roÙ
 *
found_şÚe
 = 
NULL
;

6501 
»t
 = 0;

6503 ià(
	`S_ISLNK
(
sùx
->
cur_šode_mode
))

6506 ià(
sùx
->
·»Á_roÙ
 && !sùx->
cur_šode_Ãw
) {

6507 
»t
 = 
	`is_ex‹Á_unchªged
(
sùx
, 
·th
, 
key
);

6508 ià(
»t
 < 0)

6509 
out
;

6510 ià(
»t
) {

6511 
»t
 = 0;

6512 
out_hŞe
;

6515 
bŒfs_fe_ex‹Á_™em
 *
ei
;

6516 
u8
 
ty³
;

6518 
ei
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

6519 
bŒfs_fe_ex‹Á_™em
);

6520 
ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
·th
->
nodes
[0], 
ei
);

6521 ià(
ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
 ||

6522 
ty³
 =ğ
BTRFS_FILE_EXTENT_REG
) {

6529 ià(
ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
) {

6530 
»t
 = 0;

6531 
out
;

6535 ià(
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
·th
->
nodes
[0], 
ei
) == 0) {

6536 
»t
 = 0;

6537 
out
;

6542 
»t
 = 
	`fšd_ex‹Á_şÚe
(
sùx
, 
·th
, 
key
->
objeùid
, key->
off£t
,

6543 
sùx
->
cur_šode_size
, &
found_şÚe
);

6544 ià(
»t
 !ğ-
ENOENT
 &&„et < 0)

6545 
out
;

6547 
»t
 = 
	`£nd_wr™e_Ü_şÚe
(
sùx
, 
·th
, 
key
, 
found_şÚe
);

6548 ià(
»t
)

6549 
out
;

6550 
out_hŞe
:

6551 
»t
 = 
	`maybe_£nd_hŞe
(
sùx
, 
·th
, 
key
);

6552 
out
:

6553  
»t
;

6554 
	}
}

6556 
	$´oûss_®l_ex‹Ás
(
£nd_ùx
 *
sùx
)

6558 
»t
 = 0;

6559 
™”_»t
 = 0;

6560 
bŒfs_roÙ
 *
roÙ
;

6561 
bŒfs_·th
 *
·th
;

6562 
bŒfs_key
 
key
;

6563 
bŒfs_key
 
found_key
;

6565 
roÙ
 = 
sùx
->
£nd_roÙ
;

6566 
·th
 = 
	`®loc_·th_fÜ_£nd
();

6567 ià(!
·th
)

6568  -
ENOMEM
;

6570 
key
.
objeùid
 = 
sùx
->
cmp_key
->objectid;

6571 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

6572 
key
.
off£t
 = 0;

6573 
	`bŒfs_fÜ_—ch_¦Ù
(
roÙ
, &
key
, &
found_key
, 
·th
, 
™”_»t
) {

6574 ià(
found_key
.
objeùid
 !ğ
key
.objectid ||

6575 
found_key
.
ty³
 !ğ
key
.type) {

6576 
»t
 = 0;

6580 
»t
 = 
	`´oûss_ex‹Á
(
sùx
, 
·th
, &
found_key
);

6581 ià(
»t
 < 0)

6585 ià(
™”_»t
 < 0)

6586 
»t
 = 
™”_»t
;

6588 
	`bŒfs_ä“_·th
(
·th
);

6589  
»t
;

6590 
	}
}

6592 
	$´oûss_»cÜded_»fs_if_Ãeded
(
£nd_ùx
 *
sùx
, 
©_’d
,

6593 *
³ndšg_move
,

6594 *
»fs_´oûs£d
)

6596 
»t
 = 0;

6598 ià(
sùx
->
cur_šo
 == 0)

6599 
out
;

6600 ià(!
©_’d
 && 
sùx
->
cur_šo
 =ğsùx->
cmp_key
->
objeùid
 &&

6601 
sùx
->
cmp_key
->
ty³
 <ğ
BTRFS_INODE_EXTREF_KEY
)

6602 
out
;

6603 ià(
	`li¡_em±y
(&
sùx
->
Ãw_»fs
è&&†i¡_em±y(&sùx->
d–‘ed_»fs
))

6604 
out
;

6606 
»t
 = 
	`´oûss_»cÜded_»fs
(
sùx
, 
³ndšg_move
);

6607 ià(
»t
 < 0)

6608 
out
;

6610 *
»fs_´oûs£d
 = 1;

6611 
out
:

6612  
»t
;

6613 
	}
}

6615 
	$fšish_šode_if_Ãeded
(
£nd_ùx
 *
sùx
, 
©_’d
)

6617 
»t
 = 0;

6618 
bŒfs_šode_šfo
 
šfo
;

6619 
u64
 
Ëá_mode
;

6620 
u64
 
Ëá_uid
;

6621 
u64
 
Ëá_gid
;

6622 
u64
 
Ëá_f—‰r
;

6623 
u64
 
right_mode
;

6624 
u64
 
right_uid
;

6625 
u64
 
right_gid
;

6626 
u64
 
right_f—‰r
;

6627 
Ãed_chmod
 = 0;

6628 
Ãed_chown
 = 0;

6629 
boŞ
 
Ãed_f—‰r
 = 
çl£
;

6630 
Ãed_Œunÿ‹
 = 1;

6631 
³ndšg_move
 = 0;

6632 
»fs_´oûs£d
 = 0;

6634 ià(
sùx
->
ignÜe_cur_šode
)

6637 
»t
 = 
	`´oûss_»cÜded_»fs_if_Ãeded
(
sùx
, 
©_’d
, &
³ndšg_move
,

6638 &
»fs_´oûs£d
);

6639 ià(
»t
 < 0)

6640 
out
;

6654 ià(
»fs_´oûs£d
 && !
³ndšg_move
)

6655 
sùx
->
£nd_´og»ss
 = sùx->
cur_šo
 + 1;

6657 ià(
sùx
->
cur_šo
 =ğ0 || sùx->
cur_šode_d–‘ed
)

6658 
out
;

6659 ià(!
©_’d
 && 
sùx
->
cmp_key
->
objeùid
 =ğsùx->
cur_šo
)

6660 
out
;

6661 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
£nd_roÙ
, sùx->
cur_šo
, &
šfo
);

6662 ià(
»t
 < 0)

6663 
out
;

6664 
Ëá_mode
 = 
šfo
.
mode
;

6665 
Ëá_uid
 = 
šfo
.
uid
;

6666 
Ëá_gid
 = 
šfo
.
gid
;

6667 
Ëá_f—‰r
 = 
šfo
.
f—‰r
;

6669 ià(!
sùx
->
·»Á_roÙ
 || sùx->
cur_šode_Ãw
) {

6670 
Ãed_chown
 = 1;

6671 ià(!
	`S_ISLNK
(
sùx
->
cur_šode_mode
))

6672 
Ãed_chmod
 = 1;

6673 ià(
sùx
->
cur_šode_Ãxt_wr™e_off£t
 =ğsùx->
cur_šode_size
)

6674 
Ãed_Œunÿ‹
 = 0;

6676 
u64
 
Şd_size
;

6678 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
·»Á_roÙ
, sùx->
cur_šo
, &
šfo
);

6679 ià(
»t
 < 0)

6680 
out
;

6681 
Şd_size
 = 
šfo
.
size
;

6682 
right_mode
 = 
šfo
.
mode
;

6683 
right_uid
 = 
šfo
.
uid
;

6684 
right_gid
 = 
šfo
.
gid
;

6685 
right_f—‰r
 = 
šfo
.
f—‰r
;

6687 ià(
Ëá_uid
 !ğ
right_uid
 || 
Ëá_gid
 !ğ
right_gid
)

6688 
Ãed_chown
 = 1;

6689 ià(!
	`S_ISLNK
(
sùx
->
cur_šode_mode
è&& 
Ëá_mode
 !ğ
right_mode
)

6690 
Ãed_chmod
 = 1;

6691 ià(!
	`S_ISLNK
(
sùx
->
cur_šode_mode
è&& 
Ëá_f—‰r
 !ğ
right_f—‰r
)

6692 
Ãed_f—‰r
 = 
Œue
;

6693 ià((
Şd_size
 =ğ
sùx
->
cur_šode_size
) ||

6694 (
sùx
->
cur_šode_size
 > 
Şd_size
 &&

6695 
sùx
->
cur_šode_Ãxt_wr™e_off£t
 =ğsùx->
cur_šode_size
))

6696 
Ãed_Œunÿ‹
 = 0;

6699 ià(
	`S_ISREG
(
sùx
->
cur_šode_mode
)) {

6700 ià(
	`Ãed_£nd_hŞe
(
sùx
)) {

6701 ià(
sùx
->
cur_šode_Ï¡_ex‹Á
 =ğ(
u64
)-1 ||

6702 
sùx
->
cur_šode_Ï¡_ex‹Á
 <

6703 
sùx
->
cur_šode_size
) {

6704 
»t
 = 
	`g‘_Ï¡_ex‹Á
(
sùx
, (
u64
)-1);

6705 ià(
»t
)

6706 
out
;

6708 ià(
sùx
->
cur_šode_Ï¡_ex‹Á
 <

6709 
sùx
->
cur_šode_size
) {

6710 
»t
 = 
	`£nd_hŞe
(
sùx
, sùx->
cur_šode_size
);

6711 ià(
»t
)

6712 
out
;

6715 ià(
Ãed_Œunÿ‹
) {

6716 
»t
 = 
	`£nd_Œunÿ‹
(
sùx
, sùx->
cur_šo
,

6717 
sùx
->
cur_šode_g’
,

6718 
sùx
->
cur_šode_size
);

6719 ià(
»t
 < 0)

6720 
out
;

6724 ià(
Ãed_chown
) {

6725 
»t
 = 
	`£nd_chown
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
,

6726 
Ëá_uid
, 
Ëá_gid
);

6727 ià(
»t
 < 0)

6728 
out
;

6730 ià(
Ãed_chmod
) {

6731 
»t
 = 
	`£nd_chmod
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
,

6732 
Ëá_mode
);

6733 ià(
»t
 < 0)

6734 
out
;

6736 ià(
Ãed_f—‰r
) {

6737 
»t
 = 
	`£nd_f—‰r
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
,

6738 
Ëá_f—‰r
);

6739 ià(
»t
 < 0)

6740 
out
;

6743 ià(
	`´Ùo_cmd_ok
(
sùx
, 
BTRFS_SEND_C_ENABLE_VERITY
)

6744 && 
sùx
->
cur_šode_Ãeds_v”™y
) {

6745 
»t
 = 
	`´oûss_v”™y
(
sùx
);

6746 ià(
»t
 < 0)

6747 
out
;

6750 
»t
 = 
	`£nd_ÿ·b™›s
(
sùx
);

6751 ià(
»t
 < 0)

6752 
out
;

6758 ià(!
	`is_wa™šg_fÜ_move
(
sùx
, sùx->
cur_šo
)) {

6759 
»t
 = 
	`­¶y_chd»n_dœ_moves
(
sùx
);

6760 ià(
»t
)

6761 
out
;

6769 
sùx
->
£nd_´og»ss
 = sùx->
cur_šo
 + 1;

6777 ià(
	`S_ISDIR
(
sùx
->
cur_šode_mode
è&& sùx->
cur_šode_size
 > 0)

6778 
»t
 = 
	`ÿche_dœ_utimes
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
);

6780 
»t
 = 
	`£nd_utimes
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
);

6782 ià(
»t
 < 0)

6783 
out
;

6786 
out
:

6787 ià(!
»t
)

6788 
»t
 = 
	`Œim_dœ_utimes_ÿche
(
sùx
);

6790  
»t
;

6791 
	}
}

6793 
	$şo£_cu¼’t_šode
(
£nd_ùx
 *
sùx
)

6795 
u64
 
i_size
;

6797 ià(
sùx
->
cur_šode
 =ğ
NULL
)

6800 
i_size
 = 
	`i_size_»ad
(
sùx
->
cur_šode
);

6808 ià(
sùx
->
ş—n_·ge_ÿche
 && sùx->
·ge_ÿche_ş—r_¡¬t
 < 
i_size
)

6809 
	`Œunÿ‹_šode_·ges_¿nge
(&
sùx
->
cur_šode
->
i_d©a
,

6810 
sùx
->
·ge_ÿche_ş—r_¡¬t
,

6811 
	`round_up
(
i_size
, 
PAGE_SIZE
) - 1);

6813 
	`ut
(
sùx
->
cur_šode
);

6814 
sùx
->
cur_šode
 = 
NULL
;

6815 
	}
}

6817 
	$chªged_šode
(
£nd_ùx
 *
sùx
,

6818 
bŒfs_com·»_Œ“_»suÉ
 
»suÉ
)

6820 
»t
 = 0;

6821 
bŒfs_key
 *
key
 = 
sùx
->
cmp_key
;

6822 
bŒfs_šode_™em
 *
Ëá_ii
 = 
NULL
;

6823 
bŒfs_šode_™em
 *
right_ii
 = 
NULL
;

6824 
u64
 
Ëá_g’
 = 0;

6825 
u64
 
right_g’
 = 0;

6827 
	`şo£_cu¼’t_šode
(
sùx
);

6829 
sùx
->
cur_šo
 = 
key
->
objeùid
;

6830 
sùx
->
cur_šode_Ãw_g’
 = 
çl£
;

6831 
sùx
->
cur_šode_Ï¡_ex‹Á
 = (
u64
)-1;

6832 
sùx
->
cur_šode_Ãxt_wr™e_off£t
 = 0;

6833 
sùx
->
ignÜe_cur_šode
 = 
çl£
;

6840 
sùx
->
£nd_´og»ss
 = sùx->
cur_šo
;

6842 ià(
»suÉ
 =ğ
BTRFS_COMPARE_TREE_NEW
 ||

6843 
»suÉ
 =ğ
BTRFS_COMPARE_TREE_CHANGED
) {

6844 
Ëá_ii
 = 
	`bŒfs_™em_±r
(
sùx
->
Ëá_·th
->
nodes
[0],

6845 
sùx
->
Ëá_·th
->
¦Ùs
[0],

6846 
bŒfs_šode_™em
);

6847 
Ëá_g’
 = 
	`bŒfs_šode_g’”©iÚ
(
sùx
->
Ëá_·th
->
nodes
[0],

6848 
Ëá_ii
);

6850 
right_ii
 = 
	`bŒfs_™em_±r
(
sùx
->
right_·th
->
nodes
[0],

6851 
sùx
->
right_·th
->
¦Ùs
[0],

6852 
bŒfs_šode_™em
);

6853 
right_g’
 = 
	`bŒfs_šode_g’”©iÚ
(
sùx
->
right_·th
->
nodes
[0],

6854 
right_ii
);

6856 ià(
»suÉ
 =ğ
BTRFS_COMPARE_TREE_CHANGED
) {

6857 
right_ii
 = 
	`bŒfs_™em_±r
(
sùx
->
right_·th
->
nodes
[0],

6858 
sùx
->
right_·th
->
¦Ùs
[0],

6859 
bŒfs_šode_™em
);

6861 
right_g’
 = 
	`bŒfs_šode_g’”©iÚ
(
sùx
->
right_·th
->
nodes
[0],

6862 
right_ii
);

6869 ià(
Ëá_g’
 !ğ
right_g’
 &&

6870 
sùx
->
cur_šo
 !ğ
BTRFS_FIRST_FREE_OBJECTID
)

6871 
sùx
->
cur_šode_Ãw_g’
 = 
Œue
;

6908 ià(
»suÉ
 =ğ
BTRFS_COMPARE_TREE_NEW
) {

6909 ià(
	`bŒfs_šode_Æšk
(
sùx
->
Ëá_·th
->
nodes
[0], 
Ëá_ii
) == 0) {

6910 
sùx
->
ignÜe_cur_šode
 = 
Œue
;

6911 
out
;

6913 
sùx
->
cur_šode_g’
 = 
Ëá_g’
;

6914 
sùx
->
cur_šode_Ãw
 = 
Œue
;

6915 
sùx
->
cur_šode_d–‘ed
 = 
çl£
;

6916 
sùx
->
cur_šode_size
 = 
	`bŒfs_šode_size
(

6917 
sùx
->
Ëá_·th
->
nodes
[0], 
Ëá_ii
);

6918 
sùx
->
cur_šode_mode
 = 
	`bŒfs_šode_mode
(

6919 
sùx
->
Ëá_·th
->
nodes
[0], 
Ëá_ii
);

6920 
sùx
->
cur_šode_rdev
 = 
	`bŒfs_šode_rdev
(

6921 
sùx
->
Ëá_·th
->
nodes
[0], 
Ëá_ii
);

6922 ià(
sùx
->
cur_šo
 !ğ
BTRFS_FIRST_FREE_OBJECTID
)

6923 
»t
 = 
	`£nd_ü—‹_šode_if_Ãeded
(
sùx
);

6924 } ià(
»suÉ
 =ğ
BTRFS_COMPARE_TREE_DELETED
) {

6925 
sùx
->
cur_šode_g’
 = 
right_g’
;

6926 
sùx
->
cur_šode_Ãw
 = 
çl£
;

6927 
sùx
->
cur_šode_d–‘ed
 = 
Œue
;

6928 
sùx
->
cur_šode_size
 = 
	`bŒfs_šode_size
(

6929 
sùx
->
right_·th
->
nodes
[0], 
right_ii
);

6930 
sùx
->
cur_šode_mode
 = 
	`bŒfs_šode_mode
(

6931 
sùx
->
right_·th
->
nodes
[0], 
right_ii
);

6932 } ià(
»suÉ
 =ğ
BTRFS_COMPARE_TREE_CHANGED
) {

6933 
u32
 
Ãw_Æšks
, 
Şd_Æšks
;

6935 
Ãw_Æšks
 = 
	`bŒfs_šode_Æšk
(
sùx
->
Ëá_·th
->
nodes
[0], 
Ëá_ii
);

6936 
Şd_Æšks
 = 
	`bŒfs_šode_Æšk
(
sùx
->
right_·th
->
nodes
[0], 
right_ii
);

6937 ià(
Ãw_Æšks
 =ğ0 && 
Şd_Æšks
 == 0) {

6938 
sùx
->
ignÜe_cur_šode
 = 
Œue
;

6939 
out
;

6940 } ià(
Ãw_Æšks
 =ğ0 || 
Şd_Æšks
 == 0) {

6941 
sùx
->
cur_šode_Ãw_g’
 = 1;

6950 ià(
sùx
->
cur_šode_Ãw_g’
) {

6954 ià(
Şd_Æšks
 > 0) {

6955 
sùx
->
cur_šode_g’
 = 
right_g’
;

6956 
sùx
->
cur_šode_Ãw
 = 
çl£
;

6957 
sùx
->
cur_šode_d–‘ed
 = 
Œue
;

6958 
sùx
->
cur_šode_size
 = 
	`bŒfs_šode_size
(

6959 
sùx
->
right_·th
->
nodes
[0], 
right_ii
);

6960 
sùx
->
cur_šode_mode
 = 
	`bŒfs_šode_mode
(

6961 
sùx
->
right_·th
->
nodes
[0], 
right_ii
);

6962 
»t
 = 
	`´oûss_®l_»fs
(
sùx
,

6963 
BTRFS_COMPARE_TREE_DELETED
);

6964 ià(
»t
 < 0)

6965 
out
;

6971 ià(
Ãw_Æšks
 > 0) {

6972 
sùx
->
cur_šode_g’
 = 
Ëá_g’
;

6973 
sùx
->
cur_šode_Ãw
 = 
Œue
;

6974 
sùx
->
cur_šode_d–‘ed
 = 
çl£
;

6975 
sùx
->
cur_šode_size
 = 
	`bŒfs_šode_size
(

6976 
sùx
->
Ëá_·th
->
nodes
[0],

6977 
Ëá_ii
);

6978 
sùx
->
cur_šode_mode
 = 
	`bŒfs_šode_mode
(

6979 
sùx
->
Ëá_·th
->
nodes
[0],

6980 
Ëá_ii
);

6981 
sùx
->
cur_šode_rdev
 = 
	`bŒfs_šode_rdev
(

6982 
sùx
->
Ëá_·th
->
nodes
[0],

6983 
Ëá_ii
);

6984 
»t
 = 
	`£nd_ü—‹_šode_if_Ãeded
(
sùx
);

6985 ià(
»t
 < 0)

6986 
out
;

6988 
»t
 = 
	`´oûss_®l_»fs
(
sùx
, 
BTRFS_COMPARE_TREE_NEW
);

6989 ià(
»t
 < 0)

6990 
out
;

6996 
sùx
->
£nd_´og»ss
 = sùx->
cur_šo
 + 1;

7002 
»t
 = 
	`´oûss_®l_ex‹Ás
(
sùx
);

7003 ià(
»t
 < 0)

7004 
out
;

7005 
»t
 = 
	`´oûss_®l_Ãw_x©Œs
(
sùx
);

7006 ià(
»t
 < 0)

7007 
out
;

7010 
sùx
->
cur_šode_g’
 = 
Ëá_g’
;

7011 
sùx
->
cur_šode_Ãw
 = 
çl£
;

7012 
sùx
->
cur_šode_Ãw_g’
 = 
çl£
;

7013 
sùx
->
cur_šode_d–‘ed
 = 
çl£
;

7014 
sùx
->
cur_šode_size
 = 
	`bŒfs_šode_size
(

7015 
sùx
->
Ëá_·th
->
nodes
[0], 
Ëá_ii
);

7016 
sùx
->
cur_šode_mode
 = 
	`bŒfs_šode_mode
(

7017 
sùx
->
Ëá_·th
->
nodes
[0], 
Ëá_ii
);

7021 
out
:

7022  
»t
;

7023 
	}
}

7035 
	$chªged_»f
(
£nd_ùx
 *
sùx
,

7036 
bŒfs_com·»_Œ“_»suÉ
 
»suÉ
)

7038 
»t
 = 0;

7040 ià(
sùx
->
cur_šo
 !ğsùx->
cmp_key
->
objeùid
) {

7041 
	`šcÚsi¡’t_¢­shÙ_”rÜ
(
sùx
, 
»suÉ
, "reference");

7042  -
EIO
;

7045 ià(!
sùx
->
cur_šode_Ãw_g’
 &&

7046 
sùx
->
cur_šo
 !ğ
BTRFS_FIRST_FREE_OBJECTID
) {

7047 ià(
»suÉ
 =ğ
BTRFS_COMPARE_TREE_NEW
)

7048 
»t
 = 
	`»cÜd_Ãw_»f
(
sùx
);

7049 ià(
»suÉ
 =ğ
BTRFS_COMPARE_TREE_DELETED
)

7050 
»t
 = 
	`»cÜd_d–‘ed_»f
(
sùx
);

7051 ià(
»suÉ
 =ğ
BTRFS_COMPARE_TREE_CHANGED
)

7052 
»t
 = 
	`»cÜd_chªged_»f
(
sùx
);

7055  
»t
;

7056 
	}
}

7063 
	$chªged_x©Œ
(
£nd_ùx
 *
sùx
,

7064 
bŒfs_com·»_Œ“_»suÉ
 
»suÉ
)

7066 
»t
 = 0;

7068 ià(
sùx
->
cur_šo
 !ğsùx->
cmp_key
->
objeùid
) {

7069 
	`šcÚsi¡’t_¢­shÙ_”rÜ
(
sùx
, 
»suÉ
, "xattr");

7070  -
EIO
;

7073 ià(!
sùx
->
cur_šode_Ãw_g’
 && !sùx->
cur_šode_d–‘ed
) {

7074 ià(
»suÉ
 =ğ
BTRFS_COMPARE_TREE_NEW
)

7075 
»t
 = 
	`´oûss_Ãw_x©Œ
(
sùx
);

7076 ià(
»suÉ
 =ğ
BTRFS_COMPARE_TREE_DELETED
)

7077 
»t
 = 
	`´oûss_d–‘ed_x©Œ
(
sùx
);

7078 ià(
»suÉ
 =ğ
BTRFS_COMPARE_TREE_CHANGED
)

7079 
»t
 = 
	`´oûss_chªged_x©Œ
(
sùx
);

7082  
»t
;

7083 
	}
}

7090 
	$chªged_ex‹Á
(
£nd_ùx
 *
sùx
,

7091 
bŒfs_com·»_Œ“_»suÉ
 
»suÉ
)

7093 
»t
 = 0;

7108 ià(
sùx
->
cur_šo
 !ğsùx->
cmp_key
->
objeùid
)

7111 ià(!
sùx
->
cur_šode_Ãw_g’
 && !sùx->
cur_šode_d–‘ed
) {

7112 ià(
»suÉ
 !ğ
BTRFS_COMPARE_TREE_DELETED
)

7113 
»t
 = 
	`´oûss_ex‹Á
(
sùx
, sùx->
Ëá_·th
,

7114 
sùx
->
cmp_key
);

7117  
»t
;

7118 
	}
}

7120 
	$chªged_v”™y
(
£nd_ùx
 *
sùx
, 
bŒfs_com·»_Œ“_»suÉ
 
»suÉ
)

7122 
»t
 = 0;

7124 ià(!
sùx
->
cur_šode_Ãw_g’
 && !sùx->
cur_šode_d–‘ed
) {

7125 ià(
»suÉ
 =ğ
BTRFS_COMPARE_TREE_NEW
)

7126 
sùx
->
cur_šode_Ãeds_v”™y
 = 
Œue
;

7128  
»t
;

7129 
	}
}

7131 
	$dœ_chªged
(
£nd_ùx
 *
sùx
, 
u64
 
dœ
)

7133 
u64
 
Üig_g’
, 
Ãw_g’
;

7134 
»t
;

7136 
»t
 = 
	`g‘_šode_g’
(
sùx
->
£nd_roÙ
, 
dœ
, &
Ãw_g’
);

7137 ià(
»t
)

7138  
»t
;

7140 
»t
 = 
	`g‘_šode_g’
(
sùx
->
·»Á_roÙ
, 
dœ
, &
Üig_g’
);

7141 ià(
»t
)

7142  
»t
;

7144  (
Üig_g’
 !ğ
Ãw_g’
) ? 1 : 0;

7145 
	}
}

7147 
	$com·»_»fs
(
£nd_ùx
 *
sùx
, 
bŒfs_·th
 *
·th
,

7148 
bŒfs_key
 *
key
)

7150 
bŒfs_šode_exŒef
 *
exŒef
;

7151 
ex‹Á_bufãr
 *
Ëaf
;

7152 
u64
 
dœid
 = 0, 
Ï¡_dœid
 = 0;

7153 
±r
;

7154 
u32
 
™em_size
;

7155 
u32
 
cur_off£t
 = 0;

7156 
»f_Çme_Ën
;

7157 
»t
 = 0;

7160 ià(
key
->
ty³
 =ğ
BTRFS_INODE_REF_KEY
) {

7161 
dœid
 = 
key
->
off£t
;

7163 
»t
 = 
	`dœ_chªged
(
sùx
, 
dœid
);

7164 
out
;

7167 
Ëaf
 = 
·th
->
nodes
[0];

7168 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

7169 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

7170 
cur_off£t
 < 
™em_size
) {

7171 
exŒef
 = (
bŒfs_šode_exŒef
 *)(
±r
 +

7172 
cur_off£t
);

7173 
dœid
 = 
	`bŒfs_šode_exŒef_·»Á
(
Ëaf
, 
exŒef
);

7174 
»f_Çme_Ën
 = 
	`bŒfs_šode_exŒef_Çme_Ën
(
Ëaf
, 
exŒef
);

7175 
cur_off£t
 +ğ
»f_Çme_Ën
 + (*
exŒef
);

7176 ià(
dœid
 =ğ
Ï¡_dœid
)

7178 
»t
 = 
	`dœ_chªged
(
sùx
, 
dœid
);

7179 ià(
»t
)

7181 
Ï¡_dœid
 = 
dœid
;

7183 
out
:

7184  
»t
;

7185 
	}
}

7191 
	$chªged_cb
(
bŒfs_·th
 *
Ëá_·th
,

7192 
bŒfs_·th
 *
right_·th
,

7193 
bŒfs_key
 *
key
,

7194 
bŒfs_com·»_Œ“_»suÉ
 
»suÉ
,

7195 
£nd_ùx
 *
sùx
)

7197 
»t
 = 0;

7224 
	`lockd•_as£¹_nÙ_h–d
(&
sùx
->
£nd_roÙ
->
fs_šfo
->
comm™_roÙ_£m
);

7231 ià(
Ëá_·th
->
nodes
[0])

7232 
	`ASSERT
(
	`‹¡_b™
(
EXTENT_BUFFER_UNMAPPED
,

7233 &
Ëá_·th
->
nodes
[0]->
bæags
));

7239 ià(
right_·th
 &&„ight_·th->
nodes
[0])

7240 
	`ASSERT
(
	`‹¡_b™
(
EXTENT_BUFFER_UNMAPPED
,

7241 &
right_·th
->
nodes
[0]->
bæags
));

7243 ià(
»suÉ
 =ğ
BTRFS_COMPARE_TREE_SAME
) {

7244 ià(
key
->
ty³
 =ğ
BTRFS_INODE_REF_KEY
 ||

7245 
key
->
ty³
 =ğ
BTRFS_INODE_EXTREF_KEY
) {

7246 
»t
 = 
	`com·»_»fs
(
sùx
, 
Ëá_·th
, 
key
);

7247 ià(!
»t
)

7249 ià(
»t
 < 0)

7250  
»t
;

7251 } ià(
key
->
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
) {

7252  
	`maybe_£nd_hŞe
(
sùx
, 
Ëá_·th
, 
key
);

7256 
»suÉ
 = 
BTRFS_COMPARE_TREE_CHANGED
;

7257 
»t
 = 0;

7260 
sùx
->
Ëá_·th
 =†eft_path;

7261 
sùx
->
right_·th
 =„ight_path;

7262 
sùx
->
cmp_key
 = 
key
;

7264 
»t
 = 
	`fšish_šode_if_Ãeded
(
sùx
, 0);

7265 ià(
»t
 < 0)

7266 
out
;

7269 ià(
key
->
objeùid
 =ğ
BTRFS_FREE_INO_OBJECTID
 ||

7270 
key
->
objeùid
 =ğ
BTRFS_FREE_SPACE_OBJECTID
)

7271 
out
;

7273 ià(
key
->
ty³
 =ğ
BTRFS_INODE_ITEM_KEY
) {

7274 
»t
 = 
	`chªged_šode
(
sùx
, 
»suÉ
);

7275 } ià(!
sùx
->
ignÜe_cur_šode
) {

7276 ià(
key
->
ty³
 =ğ
BTRFS_INODE_REF_KEY
 ||

7277 
key
->
ty³
 =ğ
BTRFS_INODE_EXTREF_KEY
)

7278 
»t
 = 
	`chªged_»f
(
sùx
, 
»suÉ
);

7279 ià(
key
->
ty³
 =ğ
BTRFS_XATTR_ITEM_KEY
)

7280 
»t
 = 
	`chªged_x©Œ
(
sùx
, 
»suÉ
);

7281 ià(
key
->
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
)

7282 
»t
 = 
	`chªged_ex‹Á
(
sùx
, 
»suÉ
);

7283 ià(
key
->
ty³
 =ğ
BTRFS_VERITY_DESC_ITEM_KEY
 &&

7284 
key
->
off£t
 == 0)

7285 
»t
 = 
	`chªged_v”™y
(
sùx
, 
»suÉ
);

7288 
out
:

7289  
»t
;

7290 
	}
}

7292 
	$£¬ch_key_agaš
(cÚ¡ 
£nd_ùx
 *
sùx
,

7293 
bŒfs_roÙ
 *
roÙ
,

7294 
bŒfs_·th
 *
·th
,

7295 cÚ¡ 
bŒfs_key
 *
key
)

7297 
»t
;

7299 ià(!
·th
->
Ãed_comm™_£m
)

7300 
	`lockd•_as£¹_h–d_»ad
(&
roÙ
->
fs_šfo
->
comm™_roÙ_£m
);

7309 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, 
key
, 
·th
, 0, 0);

7310 
	`ASSERT
(
»t
 <= 0);

7311 ià(
»t
 > 0) {

7312 
	`bŒfs_´št_Œ“
(
·th
->
nodes
[·th->
lowe¡_Ëv–
], 
çl£
);

7313 
	`bŒfs_”r
(
roÙ
->
fs_šfo
,

7315 
key
->
objeùid
, key->
ty³
, key->
off£t
,

7316 (
roÙ
 =ğ
sùx
->
·»Á_roÙ
 ? "parent" : "send"),

7317 
roÙ
->
roÙ_key
.
objeùid
, 
·th
->
lowe¡_Ëv–
,

7318 
·th
->
¦Ùs
[·th->
lowe¡_Ëv–
]);

7319  -
EUCLEAN
;

7322  
»t
;

7323 
	}
}

7325 
	$fuÎ_£nd_Œ“
(
£nd_ùx
 *
sùx
)

7327 
»t
;

7328 
bŒfs_roÙ
 *
£nd_roÙ
 = 
sùx
->send_root;

7329 
bŒfs_key
 
key
;

7330 
bŒfs_fs_šfo
 *
fs_šfo
 = 
£nd_roÙ
->fs_info;

7331 
bŒfs_·th
 *
·th
;

7333 
·th
 = 
	`®loc_·th_fÜ_£nd
();

7334 ià(!
·th
)

7335  -
ENOMEM
;

7336 
·th
->
»ada
 = 
READA_FORWARD_ALWAYS
;

7338 
key
.
objeùid
 = 
BTRFS_FIRST_FREE_OBJECTID
;

7339 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

7340 
key
.
off£t
 = 0;

7342 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

7343 
sùx
->
Ï¡_»loc_Œªs
 = 
fs_šfo
->last_reloc_trans;

7344 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

7346 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
£nd_roÙ
, &
key
, 
·th
, 1, 0);

7347 ià(
»t
 < 0)

7348 
out
;

7349 ià(
»t
)

7350 
out_fšish
;

7353 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

7355 
»t
 = 
	`chªged_cb
(
·th
, 
NULL
, &
key
,

7356 
BTRFS_COMPARE_TREE_NEW
, 
sùx
);

7357 ià(
»t
 < 0)

7358 
out
;

7360 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

7361 ià(
fs_šfo
->
Ï¡_»loc_Œªs
 > 
sùx
->last_reloc_trans) {

7362 
sùx
->
Ï¡_»loc_Œªs
 = 
fs_šfo
->last_reloc_trans;

7363 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

7374 
	`bŒfs_»Ëa£_·th
(
·th
);

7375 
»t
 = 
	`£¬ch_key_agaš
(
sùx
, 
£nd_roÙ
, 
·th
, &
key
);

7376 ià(
»t
 < 0)

7377 
out
;

7379 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

7382 
»t
 = 
	`bŒfs_Ãxt_™em
(
£nd_roÙ
, 
·th
);

7383 ià(
»t
 < 0)

7384 
out
;

7385 ià(
»t
) {

7386 
»t
 = 0;

7391 
out_fšish
:

7392 
»t
 = 
	`fšish_šode_if_Ãeded
(
sùx
, 1);

7394 
out
:

7395 
	`bŒfs_ä“_·th
(
·th
);

7396  
»t
;

7397 
	}
}

7399 
	$»¶aû_node_w™h_şÚe
(
bŒfs_·th
 *
·th
, 
Ëv–
)

7401 
ex‹Á_bufãr
 *
şÚe
;

7403 
şÚe
 = 
	`bŒfs_şÚe_ex‹Á_bufãr
(
·th
->
nodes
[
Ëv–
]);

7404 ià(!
şÚe
)

7405  -
ENOMEM
;

7407 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[
Ëv–
]);

7408 
·th
->
nodes
[
Ëv–
] = 
şÚe
;

7411 
	}
}

7413 
	$Œ“_move_down
(
bŒfs_·th
 *
·th
, *
Ëv–
, 
u64
 
»ada_mš_g’
)

7415 
ex‹Á_bufãr
 *
eb
;

7416 
ex‹Á_bufãr
 *
·»Á
 = 
·th
->
nodes
[*
Ëv–
];

7417 
¦Ù
 = 
·th
->
¦Ùs
[*
Ëv–
];

7418 cÚ¡ 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·»Á
);

7419 
u64
 
»ada_max
;

7420 
u64
 
»ada_dÚe
 = 0;

7422 
	`lockd•_as£¹_h–d_»ad
(&
·»Á
->
fs_šfo
->
comm™_roÙ_£m
);

7424 
	`BUG_ON
(*
Ëv–
 == 0);

7425 
eb
 = 
	`bŒfs_»ad_node_¦Ù
(
·»Á
, 
¦Ù
);

7426 ià(
	`IS_ERR
(
eb
))

7427  
	`PTR_ERR
(
eb
);

7435 
»ada_max
 = (*
Ëv–
 =ğ1 ? 
SZ_128K
 : 
eb
->
fs_šfo
->
nodesize
);

7437 
¦Ù
++; slÙ < 
Ä™ems
 && 
»ada_dÚe
 < 
»ada_max
; slot++) {

7438 ià(
	`bŒfs_node_±r_g’”©iÚ
(
·»Á
, 
¦Ù
è> 
»ada_mš_g’
) {

7439 
	`bŒfs_»adah—d_node_chd
(
·»Á
, 
¦Ù
);

7440 
»ada_dÚe
 +ğ
eb
->
fs_šfo
->
nodesize
;

7444 
·th
->
nodes
[*
Ëv–
 - 1] = 
eb
;

7445 
·th
->
¦Ùs
[*
Ëv–
 - 1] = 0;

7446 (*
Ëv–
)--;

7448 ià(*
Ëv–
 == 0)

7449  
	`»¶aû_node_w™h_şÚe
(
·th
, 0);

7452 
	}
}

7454 
	$Œ“_move_Ãxt_Ü_u²ext
(
bŒfs_·th
 *
·th
,

7455 *
Ëv–
, 
roÙ_Ëv–
)

7457 
»t
 = 0;

7458 
Ä™ems
;

7459 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[*
Ëv–
]);

7461 
·th
->
¦Ùs
[*
Ëv–
]++;

7463 
·th
->
¦Ùs
[*
Ëv–
] >ğ
Ä™ems
) {

7464 ià(*
Ëv–
 =ğ
roÙ_Ëv–
) {

7465 
·th
->
¦Ùs
[*
Ëv–
] = 
Ä™ems
 - 1;

7470 
·th
->
¦Ùs
[*
Ëv–
] = 0;

7471 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[*
Ëv–
]);

7472 
·th
->
nodes
[*
Ëv–
] = 
NULL
;

7473 (*
Ëv–
)++;

7474 
·th
->
¦Ùs
[*
Ëv–
]++;

7476 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[*
Ëv–
]);

7477 
»t
 = 1;

7479  
»t
;

7480 
	}
}

7486 
	$Œ“_advªû
(
bŒfs_·th
 *
·th
,

7487 *
Ëv–
, 
roÙ_Ëv–
,

7488 
®low_down
,

7489 
bŒfs_key
 *
key
,

7490 
u64
 
»ada_mš_g’
)

7492 
»t
;

7494 ià(*
Ëv–
 =ğ0 || !
®low_down
) {

7495 
»t
 = 
	`Œ“_move_Ãxt_Ü_u²ext
(
·th
, 
Ëv–
, 
roÙ_Ëv–
);

7497 
»t
 = 
	`Œ“_move_down
(
·th
, 
Ëv–
, 
»ada_mš_g’
);

7506 ià(*
Ëv–
 == 0)

7507 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[*
Ëv–
], 
key
,

7508 
·th
->
¦Ùs
[*
Ëv–
]);

7510 
	`bŒfs_node_key_to_ıu
(
·th
->
nodes
[*
Ëv–
], 
key
,

7511 
·th
->
¦Ùs
[*
Ëv–
]);

7513  
»t
;

7514 
	}
}

7516 
	$Œ“_com·»_™em
(
bŒfs_·th
 *
Ëá_·th
,

7517 
bŒfs_·th
 *
right_·th
,

7518 *
tmp_buf
)

7520 
cmp
;

7521 
Ën1
, 
Ën2
;

7522 
off1
, 
off2
;

7524 
Ën1
 = 
	`bŒfs_™em_size
(
Ëá_·th
->
nodes
[0],†eá_·th->
¦Ùs
[0]);

7525 
Ën2
 = 
	`bŒfs_™em_size
(
right_·th
->
nodes
[0],„ight_·th->
¦Ùs
[0]);

7526 ià(
Ën1
 !ğ
Ën2
)

7529 
off1
 = 
	`bŒfs_™em_±r_off£t
(
Ëá_·th
->
nodes
[0],†eá_·th->
¦Ùs
[0]);

7530 
off2
 = 
	`bŒfs_™em_±r_off£t
(
right_·th
->
nodes
[0],

7531 
right_·th
->
¦Ùs
[0]);

7533 
	`»ad_ex‹Á_bufãr
(
Ëá_·th
->
nodes
[0], 
tmp_buf
, 
off1
, 
Ën1
);

7535 
cmp
 = 
	`memcmp_ex‹Á_bufãr
(
right_·th
->
nodes
[0], 
tmp_buf
, 
off2
, 
Ën1
);

7536 ià(
cmp
)

7539 
	}
}

7560 
	$»¡¬t_aá”_»loÿtiÚ
(
bŒfs_·th
 *
Ëá_·th
,

7561 
bŒfs_·th
 *
right_·th
,

7562 cÚ¡ 
bŒfs_key
 *
Ëá_key
,

7563 cÚ¡ 
bŒfs_key
 *
right_key
,

7564 
Ëá_Ëv–
,

7565 
right_Ëv–
,

7566 cÚ¡ 
£nd_ùx
 *
sùx
)

7568 
roÙ_Ëv–
;

7569 
»t
;

7571 
	`lockd•_as£¹_h–d_»ad
(&
sùx
->
£nd_roÙ
->
fs_šfo
->
comm™_roÙ_£m
);

7573 
	`bŒfs_»Ëa£_·th
(
Ëá_·th
);

7574 
	`bŒfs_»Ëa£_·th
(
right_·th
);

7582 
Ëá_·th
->
lowe¡_Ëv–
 = 
Ëá_Ëv–
;

7583 
»t
 = 
	`£¬ch_key_agaš
(
sùx
, sùx->
£nd_roÙ
, 
Ëá_·th
, 
Ëá_key
);

7584 ià(
»t
 < 0)

7585  
»t
;

7587 
right_·th
->
lowe¡_Ëv–
 = 
right_Ëv–
;

7588 
»t
 = 
	`£¬ch_key_agaš
(
sùx
, sùx->
·»Á_roÙ
, 
right_·th
, 
right_key
);

7589 ià(
»t
 < 0)

7590  
»t
;

7598 ià(
Ëá_Ëv–
 == 0) {

7599 
»t
 = 
	`»¶aû_node_w™h_şÚe
(
Ëá_·th
, 0);

7600 ià(
»t
 < 0)

7601  
»t
;

7604 ià(
right_Ëv–
 == 0) {

7605 
»t
 = 
	`»¶aû_node_w™h_şÚe
(
right_·th
, 0);

7606 ià(
»t
 < 0)

7607  
»t
;

7615 
roÙ_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
sùx
->
£nd_roÙ
->
comm™_roÙ
);

7616 ià(
roÙ_Ëv–
 > 0) {

7617 
»t
 = 
	`»¶aû_node_w™h_şÚe
(
Ëá_·th
, 
roÙ_Ëv–
);

7618 ià(
»t
 < 0)

7619  
»t
;

7622 
roÙ_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
sùx
->
·»Á_roÙ
->
comm™_roÙ
);

7623 ià(
roÙ_Ëv–
 > 0) {

7624 
»t
 = 
	`»¶aû_node_w™h_şÚe
(
right_·th
, 
roÙ_Ëv–
);

7625 ià(
»t
 < 0)

7626  
»t
;

7630 
	}
}

7645 
	$bŒfs_com·»_Œ“s
(
bŒfs_roÙ
 *
Ëá_roÙ
,

7646 
bŒfs_roÙ
 *
right_roÙ
, 
£nd_ùx
 *
sùx
)

7648 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëá_roÙ
->fs_info;

7649 
»t
;

7650 
cmp
;

7651 
bŒfs_·th
 *
Ëá_·th
 = 
NULL
;

7652 
bŒfs_·th
 *
right_·th
 = 
NULL
;

7653 
bŒfs_key
 
Ëá_key
;

7654 
bŒfs_key
 
right_key
;

7655 *
tmp_buf
 = 
NULL
;

7656 
Ëá_roÙ_Ëv–
;

7657 
right_roÙ_Ëv–
;

7658 
Ëá_Ëv–
;

7659 
right_Ëv–
;

7660 
Ëá_’d_»ached
 = 0;

7661 
right_’d_»ached
 = 0;

7662 
advªû_Ëá
 = 0;

7663 
advªû_right
 = 0;

7664 
u64
 
Ëá_block±r
;

7665 
u64
 
right_block±r
;

7666 
u64
 
Ëá_g’
;

7667 
u64
 
right_g’
;

7668 
u64
 
»ada_mš_g’
;

7670 
Ëá_·th
 = 
	`bŒfs_®loc_·th
();

7671 ià(!
Ëá_·th
) {

7672 
»t
 = -
ENOMEM
;

7673 
out
;

7675 
right_·th
 = 
	`bŒfs_®loc_·th
();

7676 ià(!
right_·th
) {

7677 
»t
 = -
ENOMEM
;

7678 
out
;

7681 
tmp_buf
 = 
	`kvm®loc
(
fs_šfo
->
nodesize
, 
GFP_KERNEL
);

7682 ià(!
tmp_buf
) {

7683 
»t
 = -
ENOMEM
;

7684 
out
;

7687 
Ëá_·th
->
£¬ch_comm™_roÙ
 = 1;

7688 
Ëá_·th
->
sk_lockšg
 = 1;

7689 
right_·th
->
£¬ch_comm™_roÙ
 = 1;

7690 
right_·th
->
sk_lockšg
 = 1;

7728 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

7729 
Ëá_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
Ëá_roÙ
->
comm™_roÙ
);

7730 
Ëá_roÙ_Ëv–
 = 
Ëá_Ëv–
;

7738 
Ëá_·th
->
nodes
[
Ëá_Ëv–
] =

7739 
	`bŒfs_şÚe_ex‹Á_bufãr
(
Ëá_roÙ
->
comm™_roÙ
);

7740 ià(!
Ëá_·th
->
nodes
[
Ëá_Ëv–
]) {

7741 
»t
 = -
ENOMEM
;

7742 
out_uÆock
;

7745 
right_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
right_roÙ
->
comm™_roÙ
);

7746 
right_roÙ_Ëv–
 = 
right_Ëv–
;

7747 
right_·th
->
nodes
[
right_Ëv–
] =

7748 
	`bŒfs_şÚe_ex‹Á_bufãr
(
right_roÙ
->
comm™_roÙ
);

7749 ià(!
right_·th
->
nodes
[
right_Ëv–
]) {

7750 
»t
 = -
ENOMEM
;

7751 
out_uÆock
;

7760 
»ada_mš_g’
 = 
	`bŒfs_h—d”_g’”©iÚ
(
right_roÙ
->
comm™_roÙ
);

7762 ià(
Ëá_Ëv–
 == 0)

7763 
	`bŒfs_™em_key_to_ıu
(
Ëá_·th
->
nodes
[
Ëá_Ëv–
],

7764 &
Ëá_key
, 
Ëá_·th
->
¦Ùs
[
Ëá_Ëv–
]);

7766 
	`bŒfs_node_key_to_ıu
(
Ëá_·th
->
nodes
[
Ëá_Ëv–
],

7767 &
Ëá_key
, 
Ëá_·th
->
¦Ùs
[
Ëá_Ëv–
]);

7768 ià(
right_Ëv–
 == 0)

7769 
	`bŒfs_™em_key_to_ıu
(
right_·th
->
nodes
[
right_Ëv–
],

7770 &
right_key
, 
right_·th
->
¦Ùs
[
right_Ëv–
]);

7772 
	`bŒfs_node_key_to_ıu
(
right_·th
->
nodes
[
right_Ëv–
],

7773 &
right_key
, 
right_·th
->
¦Ùs
[
right_Ëv–
]);

7775 
sùx
->
Ï¡_»loc_Œªs
 = 
fs_šfo
->last_reloc_trans;

7778 ià(
	`Ãed_»sched
() ||

7779 
	`rw£m_is_cÚ‹nded
(&
fs_šfo
->
comm™_roÙ_£m
)) {

7780 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

7781 
	`cÚd_»sched
();

7782 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

7785 ià(
fs_šfo
->
Ï¡_»loc_Œªs
 > 
sùx
->last_reloc_trans) {

7786 
»t
 = 
	`»¡¬t_aá”_»loÿtiÚ
(
Ëá_·th
, 
right_·th
,

7787 &
Ëá_key
, &
right_key
,

7788 
Ëá_Ëv–
, 
right_Ëv–
,

7789 
sùx
);

7790 ià(
»t
 < 0)

7791 
out_uÆock
;

7792 
sùx
->
Ï¡_»loc_Œªs
 = 
fs_šfo
->last_reloc_trans;

7795 ià(
advªû_Ëá
 && !
Ëá_’d_»ached
) {

7796 
»t
 = 
	`Œ“_advªû
(
Ëá_·th
, &
Ëá_Ëv–
,

7797 
Ëá_roÙ_Ëv–
,

7798 
advªû_Ëá
 !ğ
ADVANCE_ONLY_NEXT
,

7799 &
Ëá_key
, 
»ada_mš_g’
);

7800 ià(
»t
 == -1)

7801 
Ëá_’d_»ached
 = 
ADVANCE
;

7802 ià(
»t
 < 0)

7803 
out_uÆock
;

7804 
advªû_Ëá
 = 0;

7806 ià(
advªû_right
 && !
right_’d_»ached
) {

7807 
»t
 = 
	`Œ“_advªû
(
right_·th
, &
right_Ëv–
,

7808 
right_roÙ_Ëv–
,

7809 
advªû_right
 !ğ
ADVANCE_ONLY_NEXT
,

7810 &
right_key
, 
»ada_mš_g’
);

7811 ià(
»t
 == -1)

7812 
right_’d_»ached
 = 
ADVANCE
;

7813 ià(
»t
 < 0)

7814 
out_uÆock
;

7815 
advªû_right
 = 0;

7818 ià(
Ëá_’d_»ached
 && 
right_’d_»ached
) {

7819 
»t
 = 0;

7820 
out_uÆock
;

7821 } ià(
Ëá_’d_»ached
) {

7822 ià(
right_Ëv–
 == 0) {

7823 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

7824 
»t
 = 
	`chªged_cb
(
Ëá_·th
, 
right_·th
,

7825 &
right_key
,

7826 
BTRFS_COMPARE_TREE_DELETED
,

7827 
sùx
);

7828 ià(
»t
 < 0)

7829 
out
;

7830 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

7832 
advªû_right
 = 
ADVANCE
;

7834 } ià(
right_’d_»ached
) {

7835 ià(
Ëá_Ëv–
 == 0) {

7836 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

7837 
»t
 = 
	`chªged_cb
(
Ëá_·th
, 
right_·th
,

7838 &
Ëá_key
,

7839 
BTRFS_COMPARE_TREE_NEW
,

7840 
sùx
);

7841 ià(
»t
 < 0)

7842 
out
;

7843 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

7845 
advªû_Ëá
 = 
ADVANCE
;

7849 ià(
Ëá_Ëv–
 =ğ0 && 
right_Ëv–
 == 0) {

7850 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

7851 
cmp
 = 
	`bŒfs_comp_ıu_keys
(&
Ëá_key
, &
right_key
);

7852 ià(
cmp
 < 0) {

7853 
»t
 = 
	`chªged_cb
(
Ëá_·th
, 
right_·th
,

7854 &
Ëá_key
,

7855 
BTRFS_COMPARE_TREE_NEW
,

7856 
sùx
);

7857 
advªû_Ëá
 = 
ADVANCE
;

7858 } ià(
cmp
 > 0) {

7859 
»t
 = 
	`chªged_cb
(
Ëá_·th
, 
right_·th
,

7860 &
right_key
,

7861 
BTRFS_COMPARE_TREE_DELETED
,

7862 
sùx
);

7863 
advªû_right
 = 
ADVANCE
;

7865 
bŒfs_com·»_Œ“_»suÉ
 
»suÉ
;

7867 
	`WARN_ON
(!
	`ex‹Á_bufãr_u±od©e
(
Ëá_·th
->
nodes
[0]));

7868 
»t
 = 
	`Œ“_com·»_™em
(
Ëá_·th
, 
right_·th
,

7869 
tmp_buf
);

7870 ià(
»t
)

7871 
»suÉ
 = 
BTRFS_COMPARE_TREE_CHANGED
;

7873 
»suÉ
 = 
BTRFS_COMPARE_TREE_SAME
;

7874 
»t
 = 
	`chªged_cb
(
Ëá_·th
, 
right_·th
,

7875 &
Ëá_key
, 
»suÉ
, 
sùx
);

7876 
advªû_Ëá
 = 
ADVANCE
;

7877 
advªû_right
 = 
ADVANCE
;

7880 ià(
»t
 < 0)

7881 
out
;

7882 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

7883 } ià(
Ëá_Ëv–
 =ğ
right_Ëv–
) {

7884 
cmp
 = 
	`bŒfs_comp_ıu_keys
(&
Ëá_key
, &
right_key
);

7885 ià(
cmp
 < 0) {

7886 
advªû_Ëá
 = 
ADVANCE
;

7887 } ià(
cmp
 > 0) {

7888 
advªû_right
 = 
ADVANCE
;

7890 
Ëá_block±r
 = 
	`bŒfs_node_block±r
(

7891 
Ëá_·th
->
nodes
[
Ëá_Ëv–
],

7892 
Ëá_·th
->
¦Ùs
[
Ëá_Ëv–
]);

7893 
right_block±r
 = 
	`bŒfs_node_block±r
(

7894 
right_·th
->
nodes
[
right_Ëv–
],

7895 
right_·th
->
¦Ùs
[
right_Ëv–
]);

7896 
Ëá_g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(

7897 
Ëá_·th
->
nodes
[
Ëá_Ëv–
],

7898 
Ëá_·th
->
¦Ùs
[
Ëá_Ëv–
]);

7899 
right_g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(

7900 
right_·th
->
nodes
[
right_Ëv–
],

7901 
right_·th
->
¦Ùs
[
right_Ëv–
]);

7902 ià(
Ëá_block±r
 =ğ
right_block±r
 &&

7903 
Ëá_g’
 =ğ
right_g’
) {

7908 
advªû_Ëá
 = 
ADVANCE_ONLY_NEXT
;

7909 
advªû_right
 = 
ADVANCE_ONLY_NEXT
;

7911 
advªû_Ëá
 = 
ADVANCE
;

7912 
advªû_right
 = 
ADVANCE
;

7915 } ià(
Ëá_Ëv–
 < 
right_Ëv–
) {

7916 
advªû_right
 = 
ADVANCE
;

7918 
advªû_Ëá
 = 
ADVANCE
;

7922 
out_uÆock
:

7923 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

7924 
out
:

7925 
	`bŒfs_ä“_·th
(
Ëá_·th
);

7926 
	`bŒfs_ä“_·th
(
right_·th
);

7927 
	`kvä“
(
tmp_buf
);

7928  
»t
;

7929 
	}
}

7931 
	$£nd_subvŞ
(
£nd_ùx
 *
sùx
)

7933 
»t
;

7935 ià(!(
sùx
->
æags
 & 
BTRFS_SEND_FLAG_OMIT_STREAM_HEADER
)) {

7936 
»t
 = 
	`£nd_h—d”
(
sùx
);

7937 ià(
»t
 < 0)

7938 
out
;

7941 
»t
 = 
	`£nd_subvŞ_begš
(
sùx
);

7942 ià(
»t
 < 0)

7943 
out
;

7945 ià(
sùx
->
·»Á_roÙ
) {

7946 
»t
 = 
	`bŒfs_com·»_Œ“s
(
sùx
->
£nd_roÙ
, sùx->
·»Á_roÙ
, sctx);

7947 ià(
»t
 < 0)

7948 
out
;

7949 
»t
 = 
	`fšish_šode_if_Ãeded
(
sùx
, 1);

7950 ià(
»t
 < 0)

7951 
out
;

7953 
»t
 = 
	`fuÎ_£nd_Œ“
(
sùx
);

7954 ià(
»t
 < 0)

7955 
out
;

7958 
out
:

7959 
	`ä“_»cÜded_»fs
(
sùx
);

7960  
»t
;

7961 
	}
}

7976 
	$’su»_comm™_roÙs_u±od©e
(
£nd_ùx
 *
sùx
)

7978 
i
;

7979 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

7981 
agaš
:

7982 ià(
sùx
->
·»Á_roÙ
 &&

7983 
sùx
->
·»Á_roÙ
->
node
 !ğsùx->·»Á_roÙ->
comm™_roÙ
)

7984 
comm™_Œªs
;

7986 
i
 = 0; i < 
sùx
->
şÚe_roÙs_út
; i++)

7987 ià(
sùx
->
şÚe_roÙs
[
i
].
roÙ
->
node
 !=

7988 
sùx
->
şÚe_roÙs
[
i
].
roÙ
->
comm™_roÙ
)

7989 
comm™_Œªs
;

7991 ià(
Œªs
)

7992  
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

7996 
comm™_Œªs
:

7998 ià(!
Œªs
) {

7999 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
sùx
->
£nd_roÙ
);

8000 ià(
	`IS_ERR
(
Œªs
))

8001  
	`PTR_ERR
(
Œªs
);

8002 
agaš
;

8005  
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

8006 
	}
}

8016 
	$æush_d–®loc_roÙs
(
£nd_ùx
 *
sùx
)

8018 
bŒfs_roÙ
 *
roÙ
 = 
sùx
->
·»Á_roÙ
;

8019 
»t
;

8020 
i
;

8022 ià(
roÙ
) {

8023 
»t
 = 
	`bŒfs_¡¬t_d–®loc_¢­shÙ
(
roÙ
, 
çl£
);

8024 ià(
»t
)

8025  
»t
;

8026 
	`bŒfs_wa™_Üd”ed_ex‹Ás
(
roÙ
, 
U64_MAX
, 0, U64_MAX);

8029 
i
 = 0; i < 
sùx
->
şÚe_roÙs_út
; i++) {

8030 
roÙ
 = 
sùx
->
şÚe_roÙs
[
i
].root;

8031 
»t
 = 
	`bŒfs_¡¬t_d–®loc_¢­shÙ
(
roÙ
, 
çl£
);

8032 ià(
»t
)

8033  
»t
;

8034 
	`bŒfs_wa™_Üd”ed_ex‹Ás
(
roÙ
, 
U64_MAX
, 0, U64_MAX);

8038 
	}
}

8040 
	$bŒfs_roÙ_dec_£nd_š_´og»ss
(
bŒfs_roÙ
* 
roÙ
)

8042 
	`¥š_lock
(&
roÙ
->
roÙ_™em_lock
);

8043 
roÙ
->
£nd_š_´og»ss
--;

8048 ià(
roÙ
->
£nd_š_´og»ss
 < 0)

8049 
	`bŒfs_”r
(
roÙ
->
fs_šfo
,

8051 
roÙ
->
£nd_š_´og»ss
,„oÙ->
roÙ_key
.
objeùid
);

8052 
	`¥š_uÆock
(&
roÙ
->
roÙ_™em_lock
);

8053 
	}
}

8055 
	$dedu³_š_´og»ss_w¬n
(cÚ¡ 
bŒfs_roÙ
 *
roÙ
)

8057 
	`bŒfs_w¬n_¾
(
roÙ
->
fs_šfo
,

8059 
roÙ
->
roÙ_key
.
objeùid
,„oÙ->
dedu³_š_´og»ss
);

8060 
	}
}

8062 
	$bŒfs_ioùl_£nd
(
šode
 *šode, 
bŒfs_ioùl_£nd_¬gs
 *
¬g
)

8064 
»t
 = 0;

8065 
bŒfs_roÙ
 *
£nd_roÙ
 = 
	`BTRFS_I
(
šode
)->
roÙ
;

8066 
bŒfs_fs_šfo
 *
fs_šfo
 = 
£nd_roÙ
->fs_info;

8067 
bŒfs_roÙ
 *
şÚe_roÙ
;

8068 
£nd_ùx
 *
sùx
 = 
NULL
;

8069 
u32
 
i
;

8070 
u64
 *
şÚe_sourûs_tmp
 = 
NULL
;

8071 
şÚe_sourûs_to_rŞlback
 = 0;

8072 
size_t
 
®loc_size
;

8073 
sÜt_şÚe_roÙs
 = 0;

8074 
bŒfs_Ìu_ÿche_’Œy
 *
’Œy
;

8075 
bŒfs_Ìu_ÿche_’Œy
 *
tmp
;

8077 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

8078  -
EPERM
;

8084 
	`¥š_lock
(&
£nd_roÙ
->
roÙ_™em_lock
);

8085 ià(
	`bŒfs_roÙ_»adÚly
(
£nd_roÙ
è&& s’d_roÙ->
dedu³_š_´og»ss
) {

8086 
	`dedu³_š_´og»ss_w¬n
(
£nd_roÙ
);

8087 
	`¥š_uÆock
(&
£nd_roÙ
->
roÙ_™em_lock
);

8088  -
EAGAIN
;

8090 
£nd_roÙ
->
£nd_š_´og»ss
++;

8091 
	`¥š_uÆock
(&
£nd_roÙ
->
roÙ_™em_lock
);

8097 ià(!
	`bŒfs_roÙ_»adÚly
(
£nd_roÙ
)) {

8098 
»t
 = -
EPERM
;

8099 
out
;

8108 ià(
¬g
->
şÚe_sourûs_couÁ
 > 
SZ_8M
 / (
şÚe_roÙ
)) {

8109 
»t
 = -
EINVAL
;

8110 
out
;

8113 ià(
¬g
->
æags
 & ~
BTRFS_SEND_FLAG_MASK
) {

8114 
»t
 = -
EINVAL
;

8115 
out
;

8118 
sùx
 = 
	`kz®loc
((
£nd_ùx
), 
GFP_KERNEL
);

8119 ià(!
sùx
) {

8120 
»t
 = -
ENOMEM
;

8121 
out
;

8124 
	`INIT_LIST_HEAD
(&
sùx
->
Ãw_»fs
);

8125 
	`INIT_LIST_HEAD
(&
sùx
->
d–‘ed_»fs
);

8127 
	`bŒfs_Ìu_ÿche_š™
(&
sùx
->
Çme_ÿche
, 
SEND_MAX_NAME_CACHE_SIZE
);

8128 
	`bŒfs_Ìu_ÿche_š™
(&
sùx
->
back»f_ÿche
, 
SEND_MAX_BACKREF_CACHE_SIZE
);

8129 
	`bŒfs_Ìu_ÿche_š™
(&
sùx
->
dœ_ü—‹d_ÿche
,

8130 
SEND_MAX_DIR_CREATED_CACHE_SIZE
);

8135 
	`bŒfs_Ìu_ÿche_š™
(&
sùx
->
dœ_utimes_ÿche
, 0);

8137 
sùx
->
³ndšg_dœ_moves
 = 
RB_ROOT
;

8138 
sùx
->
wa™šg_dœ_moves
 = 
RB_ROOT
;

8139 
sùx
->
Üphª_dœs
 = 
RB_ROOT
;

8140 
sùx
->
rbŒ“_Ãw_»fs
 = 
RB_ROOT
;

8141 
sùx
->
rbŒ“_d–‘ed_»fs
 = 
RB_ROOT
;

8143 
sùx
->
æags
 = 
¬g
->flags;

8145 ià(
¬g
->
æags
 & 
BTRFS_SEND_FLAG_VERSION
) {

8146 ià(
¬g
->
v”siÚ
 > 
BTRFS_SEND_STREAM_VERSION
) {

8147 
»t
 = -
EPROTO
;

8148 
out
;

8151 
sùx
->
´Ùo
 = 
¬g
->
v”siÚ
 ?: 
BTRFS_SEND_STREAM_VERSION
;

8153 
sùx
->
´Ùo
 = 1;

8155 ià((
¬g
->
æags
 & 
BTRFS_SEND_FLAG_COMPRESSED
è&& 
sùx
->
´Ùo
 < 2) {

8156 
»t
 = -
EINVAL
;

8157 
out
;

8160 
sùx
->
£nd_fp
 = 
	`fg‘
(
¬g
->
£nd_fd
);

8161 ià(!
sùx
->
£nd_fp
 || !(sùx->£nd_fp->
f_mode
 & 
FMODE_WRITE
)) {

8162 
»t
 = -
EBADF
;

8163 
out
;

8166 
sùx
->
£nd_roÙ
 = send_root;

8171 ià(
	`bŒfs_roÙ_d—d
(
sùx
->
£nd_roÙ
)) {

8172 
»t
 = -
EPERM
;

8173 
out
;

8176 
sùx
->
şÚe_roÙs_út
 = 
¬g
->
şÚe_sourûs_couÁ
;

8178 ià(
sùx
->
´Ùo
 >= 2) {

8179 
u32
 
£nd_buf_num_·ges
;

8181 
sùx
->
£nd_max_size
 = 
BTRFS_SEND_BUF_SIZE_V2
;

8182 
sùx
->
£nd_buf
 = 
	`vm®loc
(sùx->
£nd_max_size
);

8183 ià(!
sùx
->
£nd_buf
) {

8184 
»t
 = -
ENOMEM
;

8185 
out
;

8187 
£nd_buf_num_·ges
 = 
sùx
->
£nd_max_size
 >> 
PAGE_SHIFT
;

8188 
sùx
->
£nd_buf_·ges
 = 
	`kÿÎoc
(
£nd_buf_num_·ges
,

8189 (*
sùx
->
£nd_buf_·ges
),

8190 
GFP_KERNEL
);

8191 ià(!
sùx
->
£nd_buf_·ges
) {

8192 
»t
 = -
ENOMEM
;

8193 
out
;

8195 
i
 = 0; i < 
£nd_buf_num_·ges
; i++) {

8196 
sùx
->
£nd_buf_·ges
[
i
] =

8197 
	`vm®loc_to_·ge
(
sùx
->
£nd_buf
 + (
i
 << 
PAGE_SHIFT
));

8200 
sùx
->
£nd_max_size
 = 
BTRFS_SEND_BUF_SIZE_V1
;

8201 
sùx
->
£nd_buf
 = 
	`kvm®loc
(sùx->
£nd_max_size
, 
GFP_KERNEL
);

8203 ià(!
sùx
->
£nd_buf
) {

8204 
»t
 = -
ENOMEM
;

8205 
out
;

8208 
sùx
->
şÚe_roÙs
 = 
	`kvÿÎoc
((*sctx->clone_roots),

8209 
¬g
->
şÚe_sourûs_couÁ
 + 1,

8210 
GFP_KERNEL
);

8211 ià(!
sùx
->
şÚe_roÙs
) {

8212 
»t
 = -
ENOMEM
;

8213 
out
;

8216 
®loc_size
 = 
	`¬¿y_size
((*
¬g
->
şÚe_sourûs
),

8217 
¬g
->
şÚe_sourûs_couÁ
);

8219 ià(
¬g
->
şÚe_sourûs_couÁ
) {

8220 
şÚe_sourûs_tmp
 = 
	`kvm®loc
(
®loc_size
, 
GFP_KERNEL
);

8221 ià(!
şÚe_sourûs_tmp
) {

8222 
»t
 = -
ENOMEM
;

8223 
out
;

8226 
»t
 = 
	`cİy_äom_u£r
(
şÚe_sourûs_tmp
, 
¬g
->
şÚe_sourûs
,

8227 
®loc_size
);

8228 ià(
»t
) {

8229 
»t
 = -
EFAULT
;

8230 
out
;

8233 
i
 = 0; i < 
¬g
->
şÚe_sourûs_couÁ
; i++) {

8234 
şÚe_roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
,

8235 
şÚe_sourûs_tmp
[
i
], 
Œue
);

8236 ià(
	`IS_ERR
(
şÚe_roÙ
)) {

8237 
»t
 = 
	`PTR_ERR
(
şÚe_roÙ
);

8238 
out
;

8240 
	`¥š_lock
(&
şÚe_roÙ
->
roÙ_™em_lock
);

8241 ià(!
	`bŒfs_roÙ_»adÚly
(
şÚe_roÙ
) ||

8242 
	`bŒfs_roÙ_d—d
(
şÚe_roÙ
)) {

8243 
	`¥š_uÆock
(&
şÚe_roÙ
->
roÙ_™em_lock
);

8244 
	`bŒfs_put_roÙ
(
şÚe_roÙ
);

8245 
»t
 = -
EPERM
;

8246 
out
;

8248 ià(
şÚe_roÙ
->
dedu³_š_´og»ss
) {

8249 
	`dedu³_š_´og»ss_w¬n
(
şÚe_roÙ
);

8250 
	`¥š_uÆock
(&
şÚe_roÙ
->
roÙ_™em_lock
);

8251 
	`bŒfs_put_roÙ
(
şÚe_roÙ
);

8252 
»t
 = -
EAGAIN
;

8253 
out
;

8255 
şÚe_roÙ
->
£nd_š_´og»ss
++;

8256 
	`¥š_uÆock
(&
şÚe_roÙ
->
roÙ_™em_lock
);

8258 
sùx
->
şÚe_roÙs
[
i
].
roÙ
 = 
şÚe_roÙ
;

8259 
şÚe_sourûs_to_rŞlback
 = 
i
 + 1;

8261 
	`kvä“
(
şÚe_sourûs_tmp
);

8262 
şÚe_sourûs_tmp
 = 
NULL
;

8265 ià(
¬g
->
·»Á_roÙ
) {

8266 
sùx
->
·»Á_roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
¬g
->parent_root,

8267 
Œue
);

8268 ià(
	`IS_ERR
(
sùx
->
·»Á_roÙ
)) {

8269 
»t
 = 
	`PTR_ERR
(
sùx
->
·»Á_roÙ
);

8270 
out
;

8273 
	`¥š_lock
(&
sùx
->
·»Á_roÙ
->
roÙ_™em_lock
);

8274 
sùx
->
·»Á_roÙ
->
£nd_š_´og»ss
++;

8275 ià(!
	`bŒfs_roÙ_»adÚly
(
sùx
->
·»Á_roÙ
) ||

8276 
	`bŒfs_roÙ_d—d
(
sùx
->
·»Á_roÙ
)) {

8277 
	`¥š_uÆock
(&
sùx
->
·»Á_roÙ
->
roÙ_™em_lock
);

8278 
»t
 = -
EPERM
;

8279 
out
;

8281 ià(
sùx
->
·»Á_roÙ
->
dedu³_š_´og»ss
) {

8282 
	`dedu³_š_´og»ss_w¬n
(
sùx
->
·»Á_roÙ
);

8283 
	`¥š_uÆock
(&
sùx
->
·»Á_roÙ
->
roÙ_™em_lock
);

8284 
»t
 = -
EAGAIN
;

8285 
out
;

8287 
	`¥š_uÆock
(&
sùx
->
·»Á_roÙ
->
roÙ_™em_lock
);

8295 
sùx
->
şÚe_roÙs
[sùx->
şÚe_roÙs_út
++].
roÙ
 =

8296 
	`bŒfs_g¿b_roÙ
(
sùx
->
£nd_roÙ
);

8299 
	`sÜt
(
sùx
->
şÚe_roÙs
, sùx->
şÚe_roÙs_út
,

8300 (*
sùx
->
şÚe_roÙs
), 
__şÚe_roÙ_cmp_sÜt
,

8301 
NULL
);

8302 
sÜt_şÚe_roÙs
 = 1;

8304 
»t
 = 
	`æush_d–®loc_roÙs
(
sùx
);

8305 ià(
»t
)

8306 
out
;

8308 
»t
 = 
	`’su»_comm™_roÙs_u±od©e
(
sùx
);

8309 ià(
»t
)

8310 
out
;

8312 
»t
 = 
	`£nd_subvŞ
(
sùx
);

8313 ià(
»t
 < 0)

8314 
out
;

8316 
	`bŒfs_Ìu_ÿche_fÜ_—ch_’Œy_§ã
(&
sùx
->
dœ_utimes_ÿche
, 
’Œy
, 
tmp
) {

8317 
»t
 = 
	`£nd_utimes
(
sùx
, 
’Œy
->
key
,ƒÁry->
g’
);

8318 ià(
»t
 < 0)

8319 
out
;

8320 
	`bŒfs_Ìu_ÿche_»move
(&
sùx
->
dœ_utimes_ÿche
, 
’Œy
);

8323 ià(!(
sùx
->
æags
 & 
BTRFS_SEND_FLAG_OMIT_END_CMD
)) {

8324 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_END
);

8325 ià(
»t
 < 0)

8326 
out
;

8327 
»t
 = 
	`£nd_cmd
(
sùx
);

8328 ià(
»t
 < 0)

8329 
out
;

8332 
out
:

8333 
	`WARN_ON
(
sùx
 && !
»t
 && !
	`RB_EMPTY_ROOT
(&sùx->
³ndšg_dœ_moves
));

8334 
sùx
 && !
	`RB_EMPTY_ROOT
(&sùx->
³ndšg_dœ_moves
)) {

8335 
rb_node
 *
n
;

8336 
³ndšg_dœ_move
 *
pm
;

8338 
n
 = 
	`rb_fœ¡
(&
sùx
->
³ndšg_dœ_moves
);

8339 
pm
 = 
	`rb_’Œy
(
n
, 
³ndšg_dœ_move
, 
node
);

8340 !
	`li¡_em±y
(&
pm
->
li¡
)) {

8341 
³ndšg_dœ_move
 *
pm2
;

8343 
pm2
 = 
	`li¡_fœ¡_’Œy
(&
pm
->
li¡
,

8344 
³ndšg_dœ_move
, 
li¡
);

8345 
	`ä“_³ndšg_move
(
sùx
, 
pm2
);

8347 
	`ä“_³ndšg_move
(
sùx
, 
pm
);

8350 
	`WARN_ON
(
sùx
 && !
»t
 && !
	`RB_EMPTY_ROOT
(&sùx->
wa™šg_dœ_moves
));

8351 
sùx
 && !
	`RB_EMPTY_ROOT
(&sùx->
wa™šg_dœ_moves
)) {

8352 
rb_node
 *
n
;

8353 
wa™šg_dœ_move
 *
dm
;

8355 
n
 = 
	`rb_fœ¡
(&
sùx
->
wa™šg_dœ_moves
);

8356 
dm
 = 
	`rb_’Œy
(
n
, 
wa™šg_dœ_move
, 
node
);

8357 
	`rb_”a£
(&
dm
->
node
, &
sùx
->
wa™šg_dœ_moves
);

8358 
	`kä“
(
dm
);

8361 
	`WARN_ON
(
sùx
 && !
»t
 && !
	`RB_EMPTY_ROOT
(&sùx->
Üphª_dœs
));

8362 
sùx
 && !
	`RB_EMPTY_ROOT
(&sùx->
Üphª_dœs
)) {

8363 
rb_node
 *
n
;

8364 
Üphª_dœ_šfo
 *
odi
;

8366 
n
 = 
	`rb_fœ¡
(&
sùx
->
Üphª_dœs
);

8367 
odi
 = 
	`rb_’Œy
(
n
, 
Üphª_dœ_šfo
, 
node
);

8368 
	`ä“_Üphª_dœ_šfo
(
sùx
, 
odi
);

8371 ià(
sÜt_şÚe_roÙs
) {

8372 
i
 = 0; i < 
sùx
->
şÚe_roÙs_út
; i++) {

8373 
	`bŒfs_roÙ_dec_£nd_š_´og»ss
(

8374 
sùx
->
şÚe_roÙs
[
i
].
roÙ
);

8375 
	`bŒfs_put_roÙ
(
sùx
->
şÚe_roÙs
[
i
].
roÙ
);

8378 
i
 = 0; 
sùx
 && i < 
şÚe_sourûs_to_rŞlback
; i++) {

8379 
	`bŒfs_roÙ_dec_£nd_š_´og»ss
(

8380 
sùx
->
şÚe_roÙs
[
i
].
roÙ
);

8381 
	`bŒfs_put_roÙ
(
sùx
->
şÚe_roÙs
[
i
].
roÙ
);

8384 
	`bŒfs_roÙ_dec_£nd_š_´og»ss
(
£nd_roÙ
);

8386 ià(
sùx
 && !
	`IS_ERR_OR_NULL
(sùx->
·»Á_roÙ
)) {

8387 
	`bŒfs_roÙ_dec_£nd_š_´og»ss
(
sùx
->
·»Á_roÙ
);

8388 
	`bŒfs_put_roÙ
(
sùx
->
·»Á_roÙ
);

8391 
	`kvä“
(
şÚe_sourûs_tmp
);

8393 ià(
sùx
) {

8394 ià(
sùx
->
£nd_fp
)

8395 
	`åut
(
sùx
->
£nd_fp
);

8397 
	`kvä“
(
sùx
->
şÚe_roÙs
);

8398 
	`kä“
(
sùx
->
£nd_buf_·ges
);

8399 
	`kvä“
(
sùx
->
£nd_buf
);

8400 
	`kvä“
(
sùx
->
v”™y_desütÜ
);

8402 
	`şo£_cu¼’t_šode
(
sùx
);

8404 
	`bŒfs_Ìu_ÿche_ş—r
(&
sùx
->
Çme_ÿche
);

8405 
	`bŒfs_Ìu_ÿche_ş—r
(&
sùx
->
back»f_ÿche
);

8406 
	`bŒfs_Ìu_ÿche_ş—r
(&
sùx
->
dœ_ü—‹d_ÿche
);

8407 
	`bŒfs_Ìu_ÿche_ş—r
(&
sùx
->
dœ_utimes_ÿche
);

8409 
	`kä“
(
sùx
);

8412  
»t
;

8413 
	}
}

	@send.h

7 #iâdeà
BTRFS_SEND_H


8 
	#BTRFS_SEND_H


	)

10 
	~<lšux/ty³s.h
>

12 
	#BTRFS_SEND_STREAM_MAGIC
 "bŒfs-¡»am"

	)

14 #ifdeà
CONFIG_BTRFS_DEBUG


15 
	#BTRFS_SEND_STREAM_VERSION
 3

	)

17 
	#BTRFS_SEND_STREAM_VERSION
 2

	)

25 
	#BTRFS_SEND_BUF_SIZE_V1
 
SZ_64K


	)

26 
	#BTRFS_SEND_BUF_SIZE_V2
 
	`ALIGN
(
SZ_16K
 + 
BTRFS_MAX_COMPRESSED
, 
PAGE_SIZE
)

	)

28 
	gšode
;

29 
	gbŒfs_ioùl_£nd_¬gs
;

31 
	ebŒfs_v_ty³
 {

32 
	mBTRFS_TLV_U8
,

33 
	mBTRFS_TLV_U16
,

34 
	mBTRFS_TLV_U32
,

35 
	mBTRFS_TLV_U64
,

36 
	mBTRFS_TLV_BINARY
,

37 
	mBTRFS_TLV_STRING
,

38 
	mBTRFS_TLV_UUID
,

39 
	mBTRFS_TLV_TIMESPEC
,

42 
	sbŒfs_¡»am_h—d”
 {

43 
	mmagic
[(
BTRFS_SEND_STREAM_MAGIC
)];

44 
__Ë32
 
	mv”siÚ
;

45 } 
__©Œibu‹__
 ((
__·cked__
));

47 
	sbŒfs_cmd_h—d”
 {

49 
__Ë32
 
	mËn
;

50 
__Ë16
 
	mcmd
;

52 
__Ë32
 
	müc
;

53 } 
__©Œibu‹__
 ((
__·cked__
));

55 
	sbŒfs_v_h—d”
 {

56 
__Ë16
 
	mv_ty³
;

58 
__Ë16
 
	mv_Ën
;

59 } 
__©Œibu‹__
 ((
__·cked__
));

62 
	ebŒfs_£nd_cmd
 {

63 
	mBTRFS_SEND_C_UNSPEC
 = 0,

66 
	mBTRFS_SEND_C_SUBVOL
 = 1,

67 
	mBTRFS_SEND_C_SNAPSHOT
 = 2,

69 
	mBTRFS_SEND_C_MKFILE
 = 3,

70 
	mBTRFS_SEND_C_MKDIR
 = 4,

71 
	mBTRFS_SEND_C_MKNOD
 = 5,

72 
	mBTRFS_SEND_C_MKFIFO
 = 6,

73 
	mBTRFS_SEND_C_MKSOCK
 = 7,

74 
	mBTRFS_SEND_C_SYMLINK
 = 8,

76 
	mBTRFS_SEND_C_RENAME
 = 9,

77 
	mBTRFS_SEND_C_LINK
 = 10,

78 
	mBTRFS_SEND_C_UNLINK
 = 11,

79 
	mBTRFS_SEND_C_RMDIR
 = 12,

81 
	mBTRFS_SEND_C_SET_XATTR
 = 13,

82 
	mBTRFS_SEND_C_REMOVE_XATTR
 = 14,

84 
	mBTRFS_SEND_C_WRITE
 = 15,

85 
	mBTRFS_SEND_C_CLONE
 = 16,

87 
	mBTRFS_SEND_C_TRUNCATE
 = 17,

88 
	mBTRFS_SEND_C_CHMOD
 = 18,

89 
	mBTRFS_SEND_C_CHOWN
 = 19,

90 
	mBTRFS_SEND_C_UTIMES
 = 20,

92 
	mBTRFS_SEND_C_END
 = 21,

93 
	mBTRFS_SEND_C_UPDATE_EXTENT
 = 22,

94 
	mBTRFS_SEND_C_MAX_V1
 = 22,

97 
	mBTRFS_SEND_C_FALLOCATE
 = 23,

98 
	mBTRFS_SEND_C_FILEATTR
 = 24,

99 
	mBTRFS_SEND_C_ENCODED_WRITE
 = 25,

100 
	mBTRFS_SEND_C_MAX_V2
 = 25,

103 
	mBTRFS_SEND_C_ENABLE_VERITY
 = 26,

104 
	mBTRFS_SEND_C_MAX_V3
 = 26,

106 
	mBTRFS_SEND_C_MAX
 = 26,

111 
	mBTRFS_SEND_A_UNSPEC
 = 0,

114 
	mBTRFS_SEND_A_UUID
 = 1,

115 
	mBTRFS_SEND_A_CTRANSID
 = 2,

117 
	mBTRFS_SEND_A_INO
 = 3,

118 
	mBTRFS_SEND_A_SIZE
 = 4,

119 
	mBTRFS_SEND_A_MODE
 = 5,

120 
	mBTRFS_SEND_A_UID
 = 6,

121 
	mBTRFS_SEND_A_GID
 = 7,

122 
	mBTRFS_SEND_A_RDEV
 = 8,

123 
	mBTRFS_SEND_A_CTIME
 = 9,

124 
	mBTRFS_SEND_A_MTIME
 = 10,

125 
	mBTRFS_SEND_A_ATIME
 = 11,

126 
	mBTRFS_SEND_A_OTIME
 = 12,

128 
	mBTRFS_SEND_A_XATTR_NAME
 = 13,

129 
	mBTRFS_SEND_A_XATTR_DATA
 = 14,

131 
	mBTRFS_SEND_A_PATH
 = 15,

132 
	mBTRFS_SEND_A_PATH_TO
 = 16,

133 
	mBTRFS_SEND_A_PATH_LINK
 = 17,

135 
	mBTRFS_SEND_A_FILE_OFFSET
 = 18,

141 
	mBTRFS_SEND_A_DATA
 = 19,

143 
	mBTRFS_SEND_A_CLONE_UUID
 = 20,

144 
	mBTRFS_SEND_A_CLONE_CTRANSID
 = 21,

145 
	mBTRFS_SEND_A_CLONE_PATH
 = 22,

146 
	mBTRFS_SEND_A_CLONE_OFFSET
 = 23,

147 
	mBTRFS_SEND_A_CLONE_LEN
 = 24,

149 
	mBTRFS_SEND_A_MAX_V1
 = 24,

152 
	mBTRFS_SEND_A_FALLOCATE_MODE
 = 25,

160 
	mBTRFS_SEND_A_FILEATTR
 = 26,

162 
	mBTRFS_SEND_A_UNENCODED_FILE_LEN
 = 27,

163 
	mBTRFS_SEND_A_UNENCODED_LEN
 = 28,

164 
	mBTRFS_SEND_A_UNENCODED_OFFSET
 = 29,

169 
	mBTRFS_SEND_A_COMPRESSION
 = 30,

170 
	mBTRFS_SEND_A_ENCRYPTION
 = 31,

171 
	mBTRFS_SEND_A_MAX_V2
 = 31,

174 
	mBTRFS_SEND_A_VERITY_ALGORITHM
 = 32,

175 
	mBTRFS_SEND_A_VERITY_BLOCK_SIZE
 = 33,

176 
	mBTRFS_SEND_A_VERITY_SALT_DATA
 = 34,

177 
	mBTRFS_SEND_A_VERITY_SIG_DATA
 = 35,

178 
	mBTRFS_SEND_A_MAX_V3
 = 35,

180 
	m__BTRFS_SEND_A_MAX
 = 35,

183 
bŒfs_ioùl_£nd
(
šode
 *šode, 
bŒfs_ioùl_£nd_¬gs
 *
¬g
);

	@space-info.c

3 
	~"misc.h
"

4 
	~"ù»e.h
"

5 
	~"¥aû-šfo.h
"

6 
	~"sysfs.h
"

7 
	~"vŞumes.h
"

8 
	~"ä“-¥aû-ÿche.h
"

9 
	~"Üd”ed-d©a.h
"

10 
	~"Œª§ùiÚ.h
"

11 
	~"block-group.h
"

12 
	~"zÚed.h
"

13 
	~"fs.h
"

14 
	~"acûssÜs.h
"

15 
	~"ex‹Á-Œ“.h
"

165 
u64
 
__pu»
 
	$bŒfs_¥aû_šfo_u£d
(
bŒfs_¥aû_šfo
 *
s_šfo
,

166 
boŞ
 
may_u£_šşuded
)

168 
	`ASSERT
(
s_šfo
);

169  
s_šfo
->
by‹s_u£d
 + s_šfo->
by‹s_»£rved
 +

170 
s_šfo
->
by‹s_pšÃd
 + s_šfo->
by‹s_»adÚly
 +

171 
s_šfo
->
by‹s_zÚe_unu§bË
 +

172 (
may_u£_šşuded
 ? 
s_šfo
->
by‹s_may_u£
 : 0);

173 
	}
}

179 
	$bŒfs_ş—r_¥aû_šfo_fuÎ
(
bŒfs_fs_šfo
 *
šfo
)

181 
li¡_h—d
 *
h—d
 = &
šfo
->
¥aû_šfo
;

182 
bŒfs_¥aû_šfo
 *
found
;

184 
	`li¡_fÜ_—ch_’Œy
(
found
, 
h—d
, 
li¡
)

185 
found
->
fuÎ
 = 0;

186 
	}
}

192 
	#BTRFS_DEFAULT_ZONED_RECLAIM_THRESH
 (75)

	)

197 
u64
 
	$ÿlc_chunk_size
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æags
)

199 ià(
	`bŒfs_is_zÚed
(
fs_šfo
))

200  
fs_šfo
->
zÚe_size
;

202 
	`ASSERT
(
æags
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
);

204 ià(
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

205  
BTRFS_MAX_DATA_CHUNK_SIZE
;

206 ià(
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

207  
SZ_32M
;

210 ià(
fs_šfo
->
fs_deviûs
->
tÙ®_rw_by‹s
 > 50ULL * 
SZ_1G
)

211  
SZ_1G
;

213  
SZ_256M
;

214 
	}
}

219 
	$bŒfs_upd©e_¥aû_šfo_chunk_size
(
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

220 
u64
 
chunk_size
)

222 
	`WRITE_ONCE
(
¥aû_šfo
->
chunk_size
, chunk_size);

223 
	}
}

225 
	$ü—‹_¥aû_šfo
(
bŒfs_fs_šfo
 *
šfo
, 
u64
 
æags
)

228 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

229 
i
;

230 
»t
;

232 
¥aû_šfo
 = 
	`kz®loc
((*¥aû_šfo), 
GFP_NOFS
);

233 ià(!
¥aû_šfo
)

234  -
ENOMEM
;

236 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; i++)

237 
	`INIT_LIST_HEAD
(&
¥aû_šfo
->
block_groups
[
i
]);

238 
	`š™_rw£m
(&
¥aû_šfo
->
groups_£m
);

239 
	`¥š_lock_š™
(&
¥aû_šfo
->
lock
);

240 
¥aû_šfo
->
æags
 = fÏg & 
BTRFS_BLOCK_GROUP_TYPE_MASK
;

241 
¥aû_šfo
->
fÜû_®loc
 = 
CHUNK_ALLOC_NO_FORCE
;

242 
	`INIT_LIST_HEAD
(&
¥aû_šfo
->
ro_bgs
);

243 
	`INIT_LIST_HEAD
(&
¥aû_šfo
->
tick‘s
);

244 
	`INIT_LIST_HEAD
(&
¥aû_šfo
->
´iÜ™y_tick‘s
);

245 
¥aû_šfo
->
şamp
 = 1;

246 
	`bŒfs_upd©e_¥aû_šfo_chunk_size
(
¥aû_šfo
, 
	`ÿlc_chunk_size
(
šfo
, 
æags
));

248 ià(
	`bŒfs_is_zÚed
(
šfo
))

249 
¥aû_šfo
->
bg_»şaim_th»shŞd
 = 
BTRFS_DEFAULT_ZONED_RECLAIM_THRESH
;

251 
»t
 = 
	`bŒfs_sysfs_add_¥aû_šfo_ty³
(
šfo
, 
¥aû_šfo
);

252 ià(
»t
)

253  
»t
;

255 
	`li¡_add
(&
¥aû_šfo
->
li¡
, &
šfo
->space_info);

256 ià(
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

257 
šfo
->
d©a_sšfo
 = 
¥aû_šfo
;

259  
»t
;

260 
	}
}

262 
	$bŒfs_š™_¥aû_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
)

264 
bŒfs_su³r_block
 *
disk_su³r
;

265 
u64
 
ã©u»s
;

266 
u64
 
æags
;

267 
mixed
 = 0;

268 
»t
;

270 
disk_su³r
 = 
fs_šfo
->
su³r_cİy
;

271 ià(!
	`bŒfs_su³r_roÙ
(
disk_su³r
))

272  -
EINVAL
;

274 
ã©u»s
 = 
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
);

275 ià(
ã©u»s
 & 
BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
)

276 
mixed
 = 1;

278 
æags
 = 
BTRFS_BLOCK_GROUP_SYSTEM
;

279 
»t
 = 
	`ü—‹_¥aû_šfo
(
fs_šfo
, 
æags
);

280 ià(
»t
)

281 
out
;

283 ià(
mixed
) {

284 
æags
 = 
BTRFS_BLOCK_GROUP_METADATA
 | 
BTRFS_BLOCK_GROUP_DATA
;

285 
»t
 = 
	`ü—‹_¥aû_šfo
(
fs_šfo
, 
æags
);

287 
æags
 = 
BTRFS_BLOCK_GROUP_METADATA
;

288 
»t
 = 
	`ü—‹_¥aû_šfo
(
fs_šfo
, 
æags
);

289 ià(
»t
)

290 
out
;

292 
æags
 = 
BTRFS_BLOCK_GROUP_DATA
;

293 
»t
 = 
	`ü—‹_¥aû_šfo
(
fs_šfo
, 
æags
);

295 
out
:

296  
»t
;

297 
	}
}

299 
	$bŒfs_add_bg_to_¥aû_šfo
(
bŒfs_fs_šfo
 *
šfo
,

300 
bŒfs_block_group
 *
block_group
)

302 
bŒfs_¥aû_šfo
 *
found
;

303 
çùÜ
, 
šdex
;

305 
çùÜ
 = 
	`bŒfs_bg_ty³_to_çùÜ
(
block_group
->
æags
);

307 
found
 = 
	`bŒfs_fšd_¥aû_šfo
(
šfo
, 
block_group
->
æags
);

308 
	`ASSERT
(
found
);

309 
	`¥š_lock
(&
found
->
lock
);

310 
found
->
tÙ®_by‹s
 +ğ
block_group
->
Ëngth
;

311 
found
->
disk_tÙ®
 +ğ
block_group
->
Ëngth
 * 
çùÜ
;

312 
found
->
by‹s_u£d
 +ğ
block_group
->
u£d
;

313 
found
->
disk_u£d
 +ğ
block_group
->
u£d
 * 
çùÜ
;

314 
found
->
by‹s_»adÚly
 +ğ
block_group
->
by‹s_su³r
;

315 
found
->
by‹s_zÚe_unu§bË
 +ğ
block_group
->
zÚe_unu§bË
;

316 ià(
block_group
->
Ëngth
 > 0)

317 
found
->
fuÎ
 = 0;

318 
	`bŒfs_Œy_g¿Ášg_tick‘s
(
šfo
, 
found
);

319 
	`¥š_uÆock
(&
found
->
lock
);

321 
block_group
->
¥aû_šfo
 = 
found
;

323 
šdex
 = 
	`bŒfs_bg_æags_to_¿id_šdex
(
block_group
->
æags
);

324 
	`down_wr™e
(&
found
->
groups_£m
);

325 
	`li¡_add_
(&
block_group
->
li¡
, &
found
->
block_groups
[
šdex
]);

326 
	`up_wr™e
(&
found
->
groups_£m
);

327 
	}
}

329 
bŒfs_¥aû_šfo
 *
	$bŒfs_fšd_¥aû_šfo
(
bŒfs_fs_šfo
 *
šfo
,

330 
u64
 
æags
)

332 
li¡_h—d
 *
h—d
 = &
šfo
->
¥aû_šfo
;

333 
bŒfs_¥aû_šfo
 *
found
;

335 
æags
 &ğ
BTRFS_BLOCK_GROUP_TYPE_MASK
;

337 
	`li¡_fÜ_—ch_’Œy
(
found
, 
h—d
, 
li¡
) {

338 ià(
found
->
æags
 & flags)

339  
found
;

341  
NULL
;

342 
	}
}

344 
u64
 
	$ÿlc_avaabË_ä“_¥aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

345 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

346 
bŒfs_»£rve_æush_’um
 
æush
)

348 
u64
 
´ofe
;

349 
u64
 
ava
;

350 
çùÜ
;

352 ià(
¥aû_šfo
->
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

353 
´ofe
 = 
	`bŒfs_sy¡em_®loc_´ofe
(
fs_šfo
);

355 
´ofe
 = 
	`bŒfs_m‘ad©a_®loc_´ofe
(
fs_šfo
);

357 
ava
 = 
	`©omic64_»ad
(&
fs_šfo
->
ä“_chunk_¥aû
);

365 
çùÜ
 = 
	`bŒfs_bg_ty³_to_çùÜ
(
´ofe
);

366 
ava
 = 
	`div_u64
×va, 
çùÜ
);

373 ià(
æush
 =ğ
BTRFS_RESERVE_FLUSH_ALL
)

374 
ava
 >>= 3;

376 
ava
 >>= 1;

377  
ava
;

378 
	}
}

380 
	$bŒfs_ÿn_ov”comm™
(
bŒfs_fs_šfo
 *
fs_šfo
,

381 
bŒfs_¥aû_šfo
 *
¥aû_šfo
, 
u64
 
by‹s
,

382 
bŒfs_»£rve_æush_’um
 
æush
)

384 
u64
 
ava
;

385 
u64
 
u£d
;

388 ià(
¥aû_šfo
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

391 
u£d
 = 
	`bŒfs_¥aû_šfo_u£d
(
¥aû_šfo
, 
Œue
);

392 
ava
 = 
	`ÿlc_avaabË_ä“_¥aû
(
fs_šfo
, 
¥aû_šfo
, 
æush
);

394 ià(
u£d
 + 
by‹s
 < 
¥aû_šfo
->
tÙ®_by‹s
 + 
ava
)

397 
	}
}

399 
	$»move_tick‘
(
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

400 
»£rve_tick‘
 *
tick‘
)

402 ià(!
	`li¡_em±y
(&
tick‘
->
li¡
)) {

403 
	`li¡_d–_š™
(&
tick‘
->
li¡
);

404 
	`ASSERT
(
¥aû_šfo
->
»şaim_size
 >ğ
tick‘
->
by‹s
);

405 
¥aû_šfo
->
»şaim_size
 -ğ
tick‘
->
by‹s
;

407 
	}
}

413 
	$bŒfs_Œy_g¿Ášg_tick‘s
(
bŒfs_fs_šfo
 *
fs_šfo
,

414 
bŒfs_¥aû_šfo
 *
¥aû_šfo
)

416 
li¡_h—d
 *
h—d
;

417 
bŒfs_»£rve_æush_’um
 
æush
 = 
BTRFS_RESERVE_NO_FLUSH
;

419 
	`lockd•_as£¹_h–d
(&
¥aû_šfo
->
lock
);

421 
h—d
 = &
¥aû_šfo
->
´iÜ™y_tick‘s
;

422 
agaš
:

423 !
	`li¡_em±y
(
h—d
)) {

424 
»£rve_tick‘
 *
tick‘
;

425 
u64
 
u£d
 = 
	`bŒfs_¥aû_šfo_u£d
(
¥aû_šfo
, 
Œue
);

427 
tick‘
 = 
	`li¡_fœ¡_’Œy
(
h—d
, 
»£rve_tick‘
, 
li¡
);

430 ià((
u£d
 + 
tick‘
->
by‹s
 <ğ
¥aû_šfo
->
tÙ®_by‹s
) ||

431 
	`bŒfs_ÿn_ov”comm™
(
fs_šfo
, 
¥aû_šfo
, 
tick‘
->
by‹s
,

432 
æush
)) {

433 
	`bŒfs_¥aû_šfo_upd©e_by‹s_may_u£
(
fs_šfo
,

434 
¥aû_šfo
,

435 
tick‘
->
by‹s
);

436 
	`»move_tick‘
(
¥aû_šfo
, 
tick‘
);

437 
tick‘
->
by‹s
 = 0;

438 
¥aû_šfo
->
tick‘s_id
++;

439 
	`wake_up
(&
tick‘
->
wa™
);

445 ià(
h—d
 =ğ&
¥aû_šfo
->
´iÜ™y_tick‘s
) {

446 
h—d
 = &
¥aû_šfo
->
tick‘s
;

447 
æush
 = 
BTRFS_RESERVE_FLUSH_ALL
;

448 
agaš
;

450 
	}
}

452 
	#DUMP_BLOCK_RSV
(
fs_šfo
, 
rsv_Çme
) \

454 
bŒfs_block_rsv
 *
__rsv
 = &(
fs_šfo
)->
rsv_Çme
; \

455 
	`¥š_lock
(&
__rsv
->
lock
); \

456 
	`bŒfs_šfo
(
fs_šfo
, #rsv_name ": size %llu„eserved %llu", \

457 
__rsv
->
size
, __rsv->
»£rved
); \

458 
	`¥š_uÆock
(&
__rsv
->
lock
); \

459 } 0)

	)

461 cÚ¡ *
	$¥aû_šfo_æag_to_¡r
(cÚ¡ 
bŒfs_¥aû_šfo
 *
¥aû_šfo
)

463 
¥aû_šfo
->
æags
) {

464 
BTRFS_BLOCK_GROUP_SYSTEM
:

466 
BTRFS_BLOCK_GROUP_METADATA
 | 
BTRFS_BLOCK_GROUP_DATA
:

468 
BTRFS_BLOCK_GROUP_DATA
:

470 
BTRFS_BLOCK_GROUP_METADATA
:

475 
	}
}

477 
	$dump_glob®_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
)

479 
	`DUMP_BLOCK_RSV
(
fs_šfo
, 
glob®_block_rsv
);

480 
	`DUMP_BLOCK_RSV
(
fs_šfo
, 
Œªs_block_rsv
);

481 
	`DUMP_BLOCK_RSV
(
fs_šfo
, 
chunk_block_rsv
);

482 
	`DUMP_BLOCK_RSV
(
fs_šfo
, 
d–ayed_block_rsv
);

483 
	`DUMP_BLOCK_RSV
(
fs_šfo
, 
d–ayed_»fs_rsv
);

484 
	}
}

486 
	$__bŒfs_dump_¥aû_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
,

487 
bŒfs_¥aû_šfo
 *
šfo
)

489 cÚ¡ *
æag_¡r
 = 
	`¥aû_šfo_æag_to_¡r
(
šfo
);

490 
	`lockd•_as£¹_h–d
(&
šfo
->
lock
);

493 
	`bŒfs_šfo
(
fs_šfo
, "space_info %s has %lld free, is %sfull",

494 
æag_¡r
,

495 (
s64
)(
šfo
->
tÙ®_by‹s
 - 
	`bŒfs_¥aû_šfo_u£d
(šfo, 
Œue
)),

496 
šfo
->
fuÎ
 ? "" : "not ");

497 
	`bŒfs_šfo
(
fs_šfo
,

499 
šfo
->
tÙ®_by‹s
, info->
by‹s_u£d
, info->
by‹s_pšÃd
,

500 
šfo
->
by‹s_»£rved
, info->
by‹s_may_u£
,

501 
šfo
->
by‹s_»adÚly
, info->
by‹s_zÚe_unu§bË
);

502 
	}
}

504 
	$bŒfs_dump_¥aû_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
,

505 
bŒfs_¥aû_šfo
 *
šfo
, 
u64
 
by‹s
,

506 
dump_block_groups
)

508 
bŒfs_block_group
 *
ÿche
;

509 
u64
 
tÙ®_ava
 = 0;

510 
šdex
 = 0;

512 
	`¥š_lock
(&
šfo
->
lock
);

513 
	`__bŒfs_dump_¥aû_šfo
(
fs_šfo
, 
šfo
);

514 
	`dump_glob®_block_rsv
(
fs_šfo
);

515 
	`¥š_uÆock
(&
šfo
->
lock
);

517 ià(!
dump_block_groups
)

520 
	`down_»ad
(&
šfo
->
groups_£m
);

521 
agaš
:

522 
	`li¡_fÜ_—ch_’Œy
(
ÿche
, &
šfo
->
block_groups
[
šdex
], 
li¡
) {

523 
u64
 
ava
;

525 
	`¥š_lock
(&
ÿche
->
lock
);

526 
ava
 = 
ÿche
->
Ëngth
 - cache->
u£d
 - cache->
pšÃd
 -

527 
ÿche
->
»£rved
 - cache->
d–®loc_by‹s
 -

528 
ÿche
->
by‹s_su³r
 - cache->
zÚe_unu§bË
;

529 
	`bŒfs_šfo
(
fs_šfo
,

531 
ÿche
->
¡¬t
, cache->
Ëngth
, cache->
u£d
, cache->
pšÃd
,

532 
ÿche
->
»£rved
, cache->
d–®loc_by‹s
,

533 
ÿche
->
by‹s_su³r
, cache->
zÚe_unu§bË
,

534 
ava
, 
ÿche
->
ro
 ? "[readonly]" : "");

535 
	`¥š_uÆock
(&
ÿche
->
lock
);

536 
	`bŒfs_dump_ä“_¥aû
(
ÿche
, 
by‹s
);

537 
tÙ®_ava
 +ğ
ava
;

539 ià(++
šdex
 < 
BTRFS_NR_RAID_TYPES
)

540 
agaš
;

541 
	`up_»ad
(&
šfo
->
groups_£m
);

543 
	`bŒfs_šfo
(
fs_šfo
, "%Îu by‹ avaabË‡üos ®Èblock groups", 
tÙ®_ava
);

544 
	}
}

546 
šlše
 
u64
 
	$ÿlc_»şaim_™ems_Ä
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

547 
u64
 
to_»şaim
)

549 
u64
 
by‹s
;

550 
u64
 
Ä
;

552 
by‹s
 = 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
, 1);

553 
Ä
 = 
	`div64_u64
(
to_»şaim
, 
by‹s
);

554 ià(!
Ä
)

555 
Ä
 = 1;

556  
Ä
;

557 
	}
}

559 
šlše
 
u64
 
	$ÿlc_d–ayed_»fs_Ä
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

560 
u64
 
to_»şaim
)

562 cÚ¡ 
u64
 
by‹s
 = 
	`bŒfs_ÿlc_d–ayed_»f_by‹s
(
fs_šfo
, 1);

563 
u64
 
Ä
;

565 
Ä
 = 
	`div64_u64
(
to_»şaim
, 
by‹s
);

566 ià(!
Ä
)

567 
Ä
 = 1;

568  
Ä
;

569 
	}
}

571 
	#EXTENT_SIZE_PER_ITEM
 
SZ_256K


	)

576 
	$shršk_d–®loc
(
bŒfs_fs_šfo
 *
fs_šfo
,

577 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

578 
u64
 
to_»şaim
, 
boŞ
 
wa™_Üd”ed
,

579 
boŞ
 
fÜ_´“m±
)

581 
bŒfs_Œªs_hªdË
 *
Œªs
;

582 
u64
 
d–®loc_by‹s
;

583 
u64
 
Üd”ed_by‹s
;

584 
u64
 
™ems
;

585 
time_Ëá
;

586 
loİs
;

588 
d–®loc_by‹s
 = 
	`³rıu_couÁ”_sum_pos™ive
(&
fs_šfo
->delalloc_bytes);

589 
Üd”ed_by‹s
 = 
	`³rıu_couÁ”_sum_pos™ive
(&
fs_šfo
->ordered_bytes);

590 ià(
d–®loc_by‹s
 =ğ0 && 
Üd”ed_by‹s
 == 0)

594 ià(
to_»şaim
 =ğ
U64_MAX
) {

595 
™ems
 = 
U64_MAX
;

609 
to_»şaim
 = 
	`max
Ño_»şaim, 
d–®loc_by‹s
 >> 3);

610 
™ems
 = 
	`ÿlc_»şaim_™ems_Ä
(
fs_šfo
, 
to_»şaim
) * 2;

613 
Œªs
 = 
cu¼’t
->
jouº®_šfo
;

620 ià(
Üd”ed_by‹s
 > 
d–®loc_by‹s
 && !
fÜ_´“m±
)

621 
wa™_Üd”ed
 = 
Œue
;

623 
loİs
 = 0;

624 (
d–®loc_by‹s
 || 
Üd”ed_by‹s
è&& 
loİs
 < 3) {

625 
u64
 
‹mp
 = 
	`mš
(
d–®loc_by‹s
, 
to_»şaim
è>> 
PAGE_SHIFT
;

626 
Ä_·ges
 = 
	`mš_t
(
u64
, 
‹mp
, 
LONG_MAX
);

627 
async_·ges
;

629 
	`bŒfs_¡¬t_d–®loc_roÙs
(
fs_šfo
, 
Ä_·ges
, 
Œue
);

652 
async_·ges
 = 
	`©omic_»ad
(&
fs_šfo
->
async_d–®loc_·ges
);

653 ià(!
async_·ges
)

654 
sk_async
;

662 ià(
async_·ges
 > 
Ä_·ges
)

663 
async_·ges
 -ğ
Ä_·ges
;

665 
async_·ges
 = 0;

666 
	`wa™_ev’t
(
fs_šfo
->
async_subm™_wa™
,

667 
	`©omic_»ad
(&
fs_šfo
->
async_d–®loc_·ges
) <=

668 
async_·ges
);

669 
sk_async
:

670 
loİs
++;

671 ià(
wa™_Üd”ed
 && !
Œªs
) {

672 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
™ems
, 0, (
u64
)-1);

674 
time_Ëá
 = 
	`scheduË_timeout_kÏbË
(1);

675 ià(
time_Ëá
)

684 ià(
fÜ_´“m±
)

687 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

688 ià(
	`li¡_em±y
(&
¥aû_šfo
->
tick‘s
) &&

689 
	`li¡_em±y
(&
¥aû_šfo
->
´iÜ™y_tick‘s
)) {

690 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

693 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

695 
d–®loc_by‹s
 = 
	`³rıu_couÁ”_sum_pos™ive
(

696 &
fs_šfo
->
d–®loc_by‹s
);

697 
Üd”ed_by‹s
 = 
	`³rıu_couÁ”_sum_pos™ive
(

698 &
fs_šfo
->
Üd”ed_by‹s
);

700 
	}
}

707 
	$æush_¥aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

708 
bŒfs_¥aû_šfo
 *
¥aû_šfo
, 
u64
 
num_by‹s
,

709 
bŒfs_æush_¡©e
 
¡©e
, 
boŞ
 
fÜ_´“m±
)

711 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

712 
bŒfs_Œªs_hªdË
 *
Œªs
;

713 
Ä
;

714 
»t
 = 0;

716 
¡©e
) {

717 
FLUSH_DELAYED_ITEMS_NR
:

718 
FLUSH_DELAYED_ITEMS
:

719 ià(
¡©e
 =ğ
FLUSH_DELAYED_ITEMS_NR
)

720 
Ä
 = 
	`ÿlc_»şaim_™ems_Ä
(
fs_šfo
, 
num_by‹s
) * 2;

722 
Ä
 = -1;

724 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ_no¡¬t
(
roÙ
);

725 ià(
	`IS_ERR
(
Œªs
)) {

726 
»t
 = 
	`PTR_ERR
(
Œªs
);

727 ià(
»t
 =ğ-
ENOENT
)

728 
»t
 = 0;

731 
»t
 = 
	`bŒfs_run_d–ayed_™ems_Ä
(
Œªs
, 
Ä
);

732 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

734 
FLUSH_DELALLOC
:

735 
FLUSH_DELALLOC_WAIT
:

736 
FLUSH_DELALLOC_FULL
:

737 ià(
¡©e
 =ğ
FLUSH_DELALLOC_FULL
)

738 
num_by‹s
 = 
U64_MAX
;

739 
	`shršk_d–®loc
(
fs_šfo
, 
¥aû_šfo
, 
num_by‹s
,

740 
¡©e
 !ğ
FLUSH_DELALLOC
, 
fÜ_´“m±
);

742 
FLUSH_DELAYED_REFS_NR
:

743 
FLUSH_DELAYED_REFS
:

744 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ_no¡¬t
(
roÙ
);

745 ià(
	`IS_ERR
(
Œªs
)) {

746 
»t
 = 
	`PTR_ERR
(
Œªs
);

747 ià(
»t
 =ğ-
ENOENT
)

748 
»t
 = 0;

751 ià(
¡©e
 =ğ
FLUSH_DELAYED_REFS_NR
)

752 
Ä
 = 
	`ÿlc_d–ayed_»fs_Ä
(
fs_šfo
, 
num_by‹s
);

754 
Ä
 = 0;

755 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 
Ä
);

756 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

758 
ALLOC_CHUNK
:

759 
ALLOC_CHUNK_FORCE
:

760 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

761 ià(
	`IS_ERR
(
Œªs
)) {

762 
»t
 = 
	`PTR_ERR
(
Œªs
);

765 
»t
 = 
	`bŒfs_chunk_®loc
(
Œªs
,

766 
	`bŒfs_g‘_®loc_´ofe
(
fs_šfo
, 
¥aû_šfo
->
æags
),

767 (
¡©e
 =ğ
ALLOC_CHUNK
è? 
CHUNK_ALLOC_NO_FORCE
 :

768 
CHUNK_ALLOC_FORCE
);

769 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

771 ià(
»t
 > 0 ||„‘ =ğ-
ENOSPC
)

772 
»t
 = 0;

774 
RUN_DELAYED_IPUTS
:

780 
	`bŒfs_run_d–ayed_uts
(
fs_šfo
);

781 
	`bŒfs_wa™_Ú_d–ayed_uts
(
fs_šfo
);

783 
COMMIT_TRANS
:

784 
	`ASSERT
(
cu¼’t
->
jouº®_šfo
 =ğ
NULL
);

792 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ_b¬r›r
(
roÙ
);

793 ià(
	`IS_ERR
(
Œªs
)) {

794 
»t
 = 
	`PTR_ERR
(
Œªs
);

795 ià(
»t
 =ğ-
ENOENT
)

796 
»t
 = 0;

799 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

802 
»t
 = -
ENOSPC
;

806 
	`Œaû_bŒfs_æush_¥aû
(
fs_šfo
, 
¥aû_šfo
->
æags
, 
num_by‹s
, 
¡©e
,

807 
»t
, 
fÜ_´“m±
);

809 
	}
}

811 
šlše
 
u64


812 
	$bŒfs_ÿlc_»şaim_m‘ad©a_size
(
bŒfs_fs_šfo
 *
fs_šfo
,

813 
bŒfs_¥aû_šfo
 *
¥aû_šfo
)

815 
u64
 
u£d
;

816 
u64
 
ava
;

817 
u64
 
to_»şaim
 = 
¥aû_šfo
->
»şaim_size
;

819 
	`lockd•_as£¹_h–d
(&
¥aû_šfo
->
lock
);

821 
ava
 = 
	`ÿlc_avaabË_ä“_¥aû
(
fs_šfo
, 
¥aû_šfo
,

822 
BTRFS_RESERVE_FLUSH_ALL
);

823 
u£d
 = 
	`bŒfs_¥aû_šfo_u£d
(
¥aû_šfo
, 
Œue
);

831 ià(
¥aû_šfo
->
tÙ®_by‹s
 + 
ava
 < 
u£d
)

832 
to_»şaim
 +ğ
u£d
 - (
¥aû_šfo
->
tÙ®_by‹s
 + 
ava
);

834  
to_»şaim
;

835 
	}
}

837 
boŞ
 
	$Ãed_´“m±ive_»şaim
(
bŒfs_fs_šfo
 *
fs_šfo
,

838 
bŒfs_¥aû_šfo
 *
¥aû_šfo
)

840 
u64
 
glob®_rsv_size
 = 
fs_šfo
->
glob®_block_rsv
.
»£rved
;

841 
u64
 
Üd”ed
, 
d–®loc
;

842 
u64
 
th»sh
;

843 
u64
 
u£d
;

845 
th»sh
 = 
	`muÉ_³rc
(
¥aû_šfo
->
tÙ®_by‹s
, 90);

847 
	`lockd•_as£¹_h–d
(&
¥aû_šfo
->
lock
);

850 ià((
¥aû_šfo
->
by‹s_u£d
 + s·û_šfo->
by‹s_»£rved
 +

851 
glob®_rsv_size
è>ğ
th»sh
)

852  
çl£
;

854 
u£d
 = 
¥aû_šfo
->
by‹s_may_u£
 + s·û_šfo->
by‹s_pšÃd
;

857 ià(
glob®_rsv_size
 >ğ
u£d
)

858  
çl£
;

865 ià(
u£d
 - 
glob®_rsv_size
 <ğ
SZ_128M
)

866  
çl£
;

872 ià(
¥aû_šfo
->
»şaim_size
)

873  
çl£
;

904 
th»sh
 = 
	`ÿlc_avaabË_ä“_¥aû
(
fs_šfo
, 
¥aû_šfo
,

905 
BTRFS_RESERVE_FLUSH_ALL
);

906 
u£d
 = 
¥aû_šfo
->
by‹s_u£d
 + s·û_šfo->
by‹s_»£rved
 +

907 
¥aû_šfo
->
by‹s_»adÚly
 + 
glob®_rsv_size
;

908 ià(
u£d
 < 
¥aû_šfo
->
tÙ®_by‹s
)

909 
th»sh
 +ğ
¥aû_šfo
->
tÙ®_by‹s
 - 
u£d
;

910 
th»sh
 >>ğ
¥aû_šfo
->
şamp
;

912 
u£d
 = 
¥aû_šfo
->
by‹s_pšÃd
;

937 
Üd”ed
 = 
	`³rıu_couÁ”_»ad_pos™ive
(&
fs_šfo
->
Üd”ed_by‹s
) >> 1;

938 
d–®loc
 = 
	`³rıu_couÁ”_»ad_pos™ive
(&
fs_šfo
->
d–®loc_by‹s
);

939 ià(
Üd”ed
 >ğ
d–®loc
)

940 
u£d
 +ğ
fs_šfo
->
d–ayed_»fs_rsv
.
»£rved
 +

941 
fs_šfo
->
d–ayed_block_rsv
.
»£rved
;

943 
u£d
 +ğ
¥aû_šfo
->
by‹s_may_u£
 - 
glob®_rsv_size
;

945  (
u£d
 >ğ
th»sh
 && !
	`bŒfs_fs_şosšg
(
fs_šfo
) &&

946 !
	`‹¡_b™
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_šfo
->
fs_¡©e
));

947 
	}
}

949 
boŞ
 
	$¡—l_äom_glob®_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
,

950 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

951 
»£rve_tick‘
 *
tick‘
)

953 
bŒfs_block_rsv
 *
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

954 
u64
 
mš_by‹s
;

956 ià(!
tick‘
->
¡—l
)

957  
çl£
;

959 ià(
glob®_rsv
->
¥aû_šfo
 != space_info)

960  
çl£
;

962 
	`¥š_lock
(&
glob®_rsv
->
lock
);

963 
mš_by‹s
 = 
	`muÉ_³rc
(
glob®_rsv
->
size
, 10);

964 ià(
glob®_rsv
->
»£rved
 < 
mš_by‹s
 + 
tick‘
->
by‹s
) {

965 
	`¥š_uÆock
(&
glob®_rsv
->
lock
);

966  
çl£
;

968 
glob®_rsv
->
»£rved
 -ğ
tick‘
->
by‹s
;

969 
	`»move_tick‘
(
¥aû_šfo
, 
tick‘
);

970 
tick‘
->
by‹s
 = 0;

971 
	`wake_up
(&
tick‘
->
wa™
);

972 
¥aû_šfo
->
tick‘s_id
++;

973 ià(
glob®_rsv
->
»£rved
 < glob®_rsv->
size
)

974 
glob®_rsv
->
fuÎ
 = 0;

975 
	`¥š_uÆock
(&
glob®_rsv
->
lock
);

977  
Œue
;

978 
	}
}

995 
boŞ
 
	$maybe_ç_®l_tick‘s
(
bŒfs_fs_šfo
 *
fs_šfo
,

996 
bŒfs_¥aû_šfo
 *
¥aû_šfo
)

998 
»£rve_tick‘
 *
tick‘
;

999 
u64
 
tick‘s_id
 = 
¥aû_šfo
->tickets_id;

1000 cÚ¡ 
boŞ
 
abÜ‹d
 = 
	`BTRFS_FS_ERROR
(
fs_šfo
);

1002 
	`Œaû_bŒfs_ç_®l_tick‘s
(
fs_šfo
, 
¥aû_šfo
);

1004 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
ENOSPC_DEBUG
)) {

1005 
	`bŒfs_šfo
(
fs_šfo
, "cannot satisfyickets, dumping space info");

1006 
	`__bŒfs_dump_¥aû_šfo
(
fs_šfo
, 
¥aû_šfo
);

1009 !
	`li¡_em±y
(&
¥aû_šfo
->
tick‘s
) &&

1010 
tick‘s_id
 =ğ
¥aû_šfo
->tickets_id) {

1011 
tick‘
 = 
	`li¡_fœ¡_’Œy
(&
¥aû_šfo
->
tick‘s
,

1012 
»£rve_tick‘
, 
li¡
);

1014 ià(!
abÜ‹d
 && 
	`¡—l_äom_glob®_rsv
(
fs_šfo
, 
¥aû_šfo
, 
tick‘
))

1015  
Œue
;

1017 ià(!
abÜ‹d
 && 
	`bŒfs_‹¡_İt
(
fs_šfo
, 
ENOSPC_DEBUG
))

1018 
	`bŒfs_šfo
(
fs_šfo
, "failingicket with %llu bytes",

1019 
tick‘
->
by‹s
);

1021 
	`»move_tick‘
(
¥aû_šfo
, 
tick‘
);

1022 ià(
abÜ‹d
)

1023 
tick‘
->
”rÜ
 = -
EIO
;

1025 
tick‘
->
”rÜ
 = -
ENOSPC
;

1026 
	`wake_up
(&
tick‘
->
wa™
);

1034 ià(!
abÜ‹d
)

1035 
	`bŒfs_Œy_g¿Ášg_tick‘s
(
fs_šfo
, 
¥aû_šfo
);

1037  (
tick‘s_id
 !ğ
¥aû_šfo
->tickets_id);

1038 
	}
}

1045 
	$bŒfs_async_»şaim_m‘ad©a_¥aû
(
wÜk_¡ruù
 *
wÜk
)

1047 
bŒfs_fs_šfo
 *
fs_šfo
;

1048 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

1049 
u64
 
to_»şaim
;

1050 
bŒfs_æush_¡©e
 
æush_¡©e
;

1051 
comm™_cyşes
 = 0;

1052 
u64
 
Ï¡_tick‘s_id
;

1054 
fs_šfo
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_fs_šfo
, 
async_»şaim_wÜk
);

1055 
¥aû_šfo
 = 
	`bŒfs_fšd_¥aû_šfo
(
fs_šfo
, 
BTRFS_BLOCK_GROUP_METADATA
);

1057 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1058 
to_»şaim
 = 
	`bŒfs_ÿlc_»şaim_m‘ad©a_size
(
fs_šfo
, 
¥aû_šfo
);

1059 ià(!
to_»şaim
) {

1060 
¥aû_šfo
->
æush
 = 0;

1061 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1064 
Ï¡_tick‘s_id
 = 
¥aû_šfo
->
tick‘s_id
;

1065 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1067 
æush_¡©e
 = 
FLUSH_DELAYED_ITEMS_NR
;

1069 
	`æush_¥aû
(
fs_šfo
, 
¥aû_šfo
, 
to_»şaim
, 
æush_¡©e
, 
çl£
);

1070 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1071 ià(
	`li¡_em±y
(&
¥aû_šfo
->
tick‘s
)) {

1072 
¥aû_šfo
->
æush
 = 0;

1073 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1076 
to_»şaim
 = 
	`bŒfs_ÿlc_»şaim_m‘ad©a_size
(
fs_šfo
,

1077 
¥aû_šfo
);

1078 ià(
Ï¡_tick‘s_id
 =ğ
¥aû_šfo
->
tick‘s_id
) {

1079 
æush_¡©e
++;

1081 
Ï¡_tick‘s_id
 = 
¥aû_šfo
->
tick‘s_id
;

1082 
æush_¡©e
 = 
FLUSH_DELAYED_ITEMS_NR
;

1083 ià(
comm™_cyşes
)

1084 
comm™_cyşes
--;

1092 ià(
æush_¡©e
 =ğ
FLUSH_DELALLOC_FULL
 && !
comm™_cyşes
)

1093 
æush_¡©e
++;

1105 ià(
æush_¡©e
 =ğ
ALLOC_CHUNK_FORCE
 && !
comm™_cyşes
)

1106 
æush_¡©e
++;

1108 ià(
æush_¡©e
 > 
COMMIT_TRANS
) {

1109 
comm™_cyşes
++;

1110 ià(
comm™_cyşes
 > 2) {

1111 ià(
	`maybe_ç_®l_tick‘s
(
fs_šfo
, 
¥aû_šfo
)) {

1112 
æush_¡©e
 = 
FLUSH_DELAYED_ITEMS_NR
;

1113 
comm™_cyşes
--;

1115 
¥aû_šfo
->
æush
 = 0;

1118 
æush_¡©e
 = 
FLUSH_DELAYED_ITEMS_NR
;

1121 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1122 } 
æush_¡©e
 <ğ
COMMIT_TRANS
);

1123 
	}
}

1133 
	$bŒfs_´“m±_»şaim_m‘ad©a_¥aû
(
wÜk_¡ruù
 *
wÜk
)

1135 
bŒfs_fs_šfo
 *
fs_šfo
;

1136 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

1137 
bŒfs_block_rsv
 *
d–ayed_block_rsv
;

1138 
bŒfs_block_rsv
 *
d–ayed_»fs_rsv
;

1139 
bŒfs_block_rsv
 *
glob®_rsv
;

1140 
bŒfs_block_rsv
 *
Œªs_rsv
;

1141 
loİs
 = 0;

1143 
fs_šfo
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_fs_šfo
,

1144 
´“m±_»şaim_wÜk
);

1145 
¥aû_šfo
 = 
	`bŒfs_fšd_¥aû_šfo
(
fs_šfo
, 
BTRFS_BLOCK_GROUP_METADATA
);

1146 
d–ayed_block_rsv
 = &
fs_šfo
->delayed_block_rsv;

1147 
d–ayed_»fs_rsv
 = &
fs_šfo
->delayed_refs_rsv;

1148 
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

1149 
Œªs_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

1151 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1152 
	`Ãed_´“m±ive_»şaim
(
fs_šfo
, 
¥aû_šfo
)) {

1153 
bŒfs_æush_¡©e
 
æush
;

1154 
u64
 
d–®loc_size
 = 0;

1155 
u64
 
to_»şaim
, 
block_rsv_size
;

1156 
u64
 
glob®_rsv_size
 = 
glob®_rsv
->
»£rved
;

1158 
loİs
++;

1167 
block_rsv_size
 = 
glob®_rsv_size
 +

1168 
d–ayed_block_rsv
->
»£rved
 +

1169 
d–ayed_»fs_rsv
->
»£rved
 +

1170 
Œªs_rsv
->
»£rved
;

1171 ià(
block_rsv_size
 < 
¥aû_šfo
->
by‹s_may_u£
)

1172 
d–®loc_size
 = 
¥aû_šfo
->
by‹s_may_u£
 - 
block_rsv_size
;

1179 
block_rsv_size
 -ğ
glob®_rsv_size
;

1186 ià(
d–®loc_size
 > 
block_rsv_size
) {

1187 
to_»şaim
 = 
d–®loc_size
;

1188 
æush
 = 
FLUSH_DELALLOC
;

1189 } ià(
¥aû_šfo
->
by‹s_pšÃd
 >

1190 (
d–ayed_block_rsv
->
»£rved
 +

1191 
d–ayed_»fs_rsv
->
»£rved
)) {

1192 
to_»şaim
 = 
¥aû_šfo
->
by‹s_pšÃd
;

1193 
æush
 = 
COMMIT_TRANS
;

1194 } ià(
d–ayed_block_rsv
->
»£rved
 >

1195 
d–ayed_»fs_rsv
->
»£rved
) {

1196 
to_»şaim
 = 
d–ayed_block_rsv
->
»£rved
;

1197 
æush
 = 
FLUSH_DELAYED_ITEMS_NR
;

1199 
to_»şaim
 = 
d–ayed_»fs_rsv
->
»£rved
;

1200 
æush
 = 
FLUSH_DELAYED_REFS_NR
;

1203 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1210 
to_»şaim
 >>= 2;

1211 ià(!
to_»şaim
)

1212 
to_»şaim
 = 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
, 1);

1213 
	`æush_¥aû
(
fs_šfo
, 
¥aû_šfo
, 
to_»şaim
, 
æush
, 
Œue
);

1214 
	`cÚd_»sched
();

1215 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1219 ià(
loİs
 =ğ1 && !
¥aû_šfo
->
»şaim_size
)

1220 
¥aû_šfo
->
şamp
 = 
	`max
(1, space_info->clamp - 1);

1221 
	`Œaû_bŒfs_dÚe_´“m±ive_»şaim
(
fs_šfo
, 
¥aû_šfo
);

1222 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1223 
	}
}

1258 cÚ¡ 
bŒfs_æush_¡©e
 
	gd©a_æush_¡©es
[] = {

1259 
FLUSH_DELALLOC_FULL
,

1260 
RUN_DELAYED_IPUTS
,

1261 
COMMIT_TRANS
,

1262 
ALLOC_CHUNK_FORCE
,

1265 
	$bŒfs_async_»şaim_d©a_¥aû
(
wÜk_¡ruù
 *
wÜk
)

1267 
bŒfs_fs_šfo
 *
fs_šfo
;

1268 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

1269 
u64
 
Ï¡_tick‘s_id
;

1270 
bŒfs_æush_¡©e
 
æush_¡©e
 = 0;

1272 
fs_šfo
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_fs_šfo
, 
async_d©a_»şaim_wÜk
);

1273 
¥aû_šfo
 = 
fs_šfo
->
d©a_sšfo
;

1275 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1276 ià(
	`li¡_em±y
(&
¥aû_šfo
->
tick‘s
)) {

1277 
¥aû_šfo
->
æush
 = 0;

1278 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1281 
Ï¡_tick‘s_id
 = 
¥aû_šfo
->
tick‘s_id
;

1282 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1284 !
¥aû_šfo
->
fuÎ
) {

1285 
	`æush_¥aû
(
fs_šfo
, 
¥aû_šfo
, 
U64_MAX
, 
ALLOC_CHUNK_FORCE
, 
çl£
);

1286 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1287 ià(
	`li¡_em±y
(&
¥aû_šfo
->
tick‘s
)) {

1288 
¥aû_šfo
->
æush
 = 0;

1289 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1294 ià(
	`BTRFS_FS_ERROR
(
fs_šfo
))

1295 
abÜ‹d_fs
;

1296 
Ï¡_tick‘s_id
 = 
¥aû_šfo
->
tick‘s_id
;

1297 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1300 
æush_¡©e
 < 
	`ARRAY_SIZE
(
d©a_æush_¡©es
)) {

1301 
	`æush_¥aû
(
fs_šfo
, 
¥aû_šfo
, 
U64_MAX
,

1302 
d©a_æush_¡©es
[
æush_¡©e
], 
çl£
);

1303 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1304 ià(
	`li¡_em±y
(&
¥aû_šfo
->
tick‘s
)) {

1305 
¥aû_šfo
->
æush
 = 0;

1306 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1310 ià(
Ï¡_tick‘s_id
 =ğ
¥aû_šfo
->
tick‘s_id
) {

1311 
æush_¡©e
++;

1313 
Ï¡_tick‘s_id
 = 
¥aû_šfo
->
tick‘s_id
;

1314 
æush_¡©e
 = 0;

1317 ià(
æush_¡©e
 >ğ
	`ARRAY_SIZE
(
d©a_æush_¡©es
)) {

1318 ià(
¥aû_šfo
->
fuÎ
) {

1319 ià(
	`maybe_ç_®l_tick‘s
(
fs_šfo
, 
¥aû_šfo
))

1320 
æush_¡©e
 = 0;

1322 
¥aû_šfo
->
æush
 = 0;

1324 
æush_¡©e
 = 0;

1328 ià(
	`BTRFS_FS_ERROR
(
fs_šfo
))

1329 
abÜ‹d_fs
;

1332 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1336 
abÜ‹d_fs
:

1337 
	`maybe_ç_®l_tick‘s
(
fs_šfo
, 
¥aû_šfo
);

1338 
¥aû_šfo
->
æush
 = 0;

1339 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1340 
	}
}

1342 
	$bŒfs_š™_async_»şaim_wÜk
(
bŒfs_fs_šfo
 *
fs_šfo
)

1344 
	`INIT_WORK
(&
fs_šfo
->
async_»şaim_wÜk
, 
bŒfs_async_»şaim_m‘ad©a_¥aû
);

1345 
	`INIT_WORK
(&
fs_šfo
->
async_d©a_»şaim_wÜk
, 
bŒfs_async_»şaim_d©a_¥aû
);

1346 
	`INIT_WORK
(&
fs_šfo
->
´“m±_»şaim_wÜk
,

1347 
bŒfs_´“m±_»şaim_m‘ad©a_¥aû
);

1348 
	}
}

1350 cÚ¡ 
bŒfs_æush_¡©e
 
	g´iÜ™y_æush_¡©es
[] = {

1351 
FLUSH_DELAYED_ITEMS_NR
,

1352 
FLUSH_DELAYED_ITEMS
,

1353 
ALLOC_CHUNK
,

1356 cÚ¡ 
bŒfs_æush_¡©e
 
	geviù_æush_¡©es
[] = {

1357 
FLUSH_DELAYED_ITEMS_NR
,

1358 
FLUSH_DELAYED_ITEMS
,

1359 
FLUSH_DELAYED_REFS_NR
,

1360 
FLUSH_DELAYED_REFS
,

1361 
FLUSH_DELALLOC
,

1362 
FLUSH_DELALLOC_WAIT
,

1363 
FLUSH_DELALLOC_FULL
,

1364 
ALLOC_CHUNK
,

1365 
COMMIT_TRANS
,

1368 
	$´iÜ™y_»şaim_m‘ad©a_¥aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

1369 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

1370 
»£rve_tick‘
 *
tick‘
,

1371 cÚ¡ 
bŒfs_æush_¡©e
 *
¡©es
,

1372 
¡©es_Ä
)

1374 
u64
 
to_»şaim
;

1375 
æush_¡©e
 = 0;

1377 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1378 
to_»şaim
 = 
	`bŒfs_ÿlc_»şaim_m‘ad©a_size
(
fs_šfo
, 
¥aû_šfo
);

1385 ià(
tick‘
->
by‹s
 == 0) {

1386 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1390 
æush_¡©e
 < 
¡©es_Ä
) {

1391 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1392 
	`æush_¥aû
(
fs_šfo
, 
¥aû_šfo
, 
to_»şaim
, 
¡©es
[
æush_¡©e
],

1393 
çl£
);

1394 
æush_¡©e
++;

1395 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1396 ià(
tick‘
->
by‹s
 == 0) {

1397 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1410 ià(
	`BTRFS_FS_ERROR
(
fs_šfo
)) {

1411 
tick‘
->
”rÜ
 = 
	`BTRFS_FS_ERROR
(
fs_šfo
);

1412 
	`»move_tick‘
(
¥aû_šfo
, 
tick‘
);

1413 } ià(!
	`¡—l_äom_glob®_rsv
(
fs_šfo
, 
¥aû_šfo
, 
tick‘
)) {

1414 
tick‘
->
”rÜ
 = -
ENOSPC
;

1415 
	`»move_tick‘
(
¥aû_šfo
, 
tick‘
);

1423 
	`bŒfs_Œy_g¿Ášg_tick‘s
(
fs_šfo
, 
¥aû_šfo
);

1424 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1425 
	}
}

1427 
	$´iÜ™y_»şaim_d©a_¥aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

1428 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

1429 
»£rve_tick‘
 *
tick‘
)

1431 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1434 ià(
tick‘
->
by‹s
 == 0) {

1435 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1439 !
¥aû_šfo
->
fuÎ
) {

1440 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1441 
	`æush_¥aû
(
fs_šfo
, 
¥aû_šfo
, 
U64_MAX
, 
ALLOC_CHUNK_FORCE
, 
çl£
);

1442 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1443 ià(
tick‘
->
by‹s
 == 0) {

1444 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1449 
tick‘
->
”rÜ
 = -
ENOSPC
;

1450 
	`»move_tick‘
(
¥aû_šfo
, 
tick‘
);

1451 
	`bŒfs_Œy_g¿Ášg_tick‘s
(
fs_šfo
, 
¥aû_šfo
);

1452 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1453 
	}
}

1455 
	$wa™_»£rve_tick‘
(
bŒfs_fs_šfo
 *
fs_šfo
,

1456 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

1457 
»£rve_tick‘
 *
tick‘
)

1460 
	`DEFINE_WAIT
(
wa™
);

1461 
»t
 = 0;

1463 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1464 
tick‘
->
by‹s
 > 0 &&ick‘->
”rÜ
 == 0) {

1465 
»t
 = 
	`´•¬e_to_wa™_ev’t
(&
tick‘
->
wa™
, &wa™, 
TASK_KILLABLE
);

1466 ià(
»t
) {

1475 
	`»move_tick‘
(
¥aû_šfo
, 
tick‘
);

1476 
tick‘
->
”rÜ
 = -
EINTR
;

1479 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1481 
	`scheduË
();

1483 
	`fšish_wa™
(&
tick‘
->
wa™
, &wait);

1484 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1486 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1487 
	}
}

1502 
	$hªdË_»£rve_tick‘
(
bŒfs_fs_šfo
 *
fs_šfo
,

1503 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

1504 
»£rve_tick‘
 *
tick‘
,

1505 
u64
 
¡¬t_ns
, u64 
Üig_by‹s
,

1506 
bŒfs_»£rve_æush_’um
 
æush
)

1508 
»t
;

1510 
æush
) {

1511 
BTRFS_RESERVE_FLUSH_DATA
:

1512 
BTRFS_RESERVE_FLUSH_ALL
:

1513 
BTRFS_RESERVE_FLUSH_ALL_STEAL
:

1514 
	`wa™_»£rve_tick‘
(
fs_šfo
, 
¥aû_šfo
, 
tick‘
);

1516 
BTRFS_RESERVE_FLUSH_LIMIT
:

1517 
	`´iÜ™y_»şaim_m‘ad©a_¥aû
(
fs_šfo
, 
¥aû_šfo
, 
tick‘
,

1518 
´iÜ™y_æush_¡©es
,

1519 
	`ARRAY_SIZE
(
´iÜ™y_æush_¡©es
));

1521 
BTRFS_RESERVE_FLUSH_EVICT
:

1522 
	`´iÜ™y_»şaim_m‘ad©a_¥aû
(
fs_šfo
, 
¥aû_šfo
, 
tick‘
,

1523 
eviù_æush_¡©es
,

1524 
	`ARRAY_SIZE
(
eviù_æush_¡©es
));

1526 
BTRFS_RESERVE_FLUSH_FREE_SPACE_INODE
:

1527 
	`´iÜ™y_»şaim_d©a_¥aû
(
fs_šfo
, 
¥aû_šfo
, 
tick‘
);

1530 
	`ASSERT
(0);

1534 
»t
 = 
tick‘
->
”rÜ
;

1535 
	`ASSERT
(
	`li¡_em±y
(&
tick‘
->
li¡
));

1542 
	`ASSERT
(!(
tick‘
->
by‹s
 =ğ0 &&ick‘->
”rÜ
));

1543 
	`Œaû_bŒfs_»£rve_tick‘
(
fs_šfo
, 
¥aû_šfo
->
æags
, 
Üig_by‹s
,

1544 
¡¬t_ns
, 
æush
, 
tick‘
->
”rÜ
);

1545  
»t
;

1546 
	}
}

1552 
šlše
 
boŞ
 
	$is_nÜm®_æushšg
(
bŒfs_»£rve_æush_’um
 
æush
)

1554  (
æush
 =ğ
BTRFS_RESERVE_FLUSH_ALL
) ||

1555 (
æush
 =ğ
BTRFS_RESERVE_FLUSH_ALL_STEAL
);

1556 
	}
}

1558 
šlše
 
	$maybe_şamp_´“m±
(
bŒfs_fs_šfo
 *
fs_šfo
,

1559 
bŒfs_¥aû_šfo
 *
¥aû_šfo
)

1561 
u64
 
Üd”ed
 = 
	`³rıu_couÁ”_sum_pos™ive
(&
fs_šfo
->
Üd”ed_by‹s
);

1562 
u64
 
d–®loc
 = 
	`³rıu_couÁ”_sum_pos™ive
(&
fs_šfo
->
d–®loc_by‹s
);

1572 ià(
Üd”ed
 < 
d–®loc
)

1573 
¥aû_šfo
->
şamp
 = 
	`mš
(space_info->clamp + 1, 8);

1574 
	}
}

1576 
šlše
 
boŞ
 
	$ÿn_¡—l
(
bŒfs_»£rve_æush_’um
 
æush
)

1578  (
æush
 =ğ
BTRFS_RESERVE_FLUSH_ALL_STEAL
 ||

1579 
æush
 =ğ
BTRFS_RESERVE_FLUSH_EVICT
);

1580 
	}
}

1586 
šlše
 
boŞ
 
	$ÿn_tick‘
(
bŒfs_»£rve_æush_’um
 
æush
)

1588  (
æush
 !ğ
BTRFS_RESERVE_NO_FLUSH
 &&

1589 
æush
 !ğ
BTRFS_RESERVE_FLUSH_EMERGENCY
);

1590 
	}
}

1607 
	$__»£rve_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
,

1608 
bŒfs_¥aû_šfo
 *
¥aû_šfo
, 
u64
 
Üig_by‹s
,

1609 
bŒfs_»£rve_æush_’um
 
æush
)

1611 
wÜk_¡ruù
 *
async_wÜk
;

1612 
»£rve_tick‘
 
tick‘
;

1613 
u64
 
¡¬t_ns
 = 0;

1614 
u64
 
u£d
;

1615 
»t
 = -
ENOSPC
;

1616 
boŞ
 
³ndšg_tick‘s
;

1618 
	`ASSERT
(
Üig_by‹s
);

1625 ià(
cu¼’t
->
jouº®_šfo
) {

1627 
	`ASSERT
(
æush
 !ğ
BTRFS_RESERVE_FLUSH_ALL
);

1628 
	`ASSERT
(
æush
 !ğ
BTRFS_RESERVE_FLUSH_ALL_STEAL
);

1629 
	`ASSERT
(
æush
 !ğ
BTRFS_RESERVE_FLUSH_EVICT
);

1632 ià(
æush
 =ğ
BTRFS_RESERVE_FLUSH_DATA
)

1633 
async_wÜk
 = &
fs_šfo
->
async_d©a_»şaim_wÜk
;

1635 
async_wÜk
 = &
fs_šfo
->
async_»şaim_wÜk
;

1637 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1638 
u£d
 = 
	`bŒfs_¥aû_šfo_u£d
(
¥aû_šfo
, 
Œue
);

1645 ià(
	`is_nÜm®_æushšg
(
æush
è|| (æush =ğ
BTRFS_RESERVE_NO_FLUSH
))

1646 
³ndšg_tick‘s
 = !
	`li¡_em±y
(&
¥aû_šfo
->
tick‘s
) ||

1647 !
	`li¡_em±y
(&
¥aû_šfo
->
´iÜ™y_tick‘s
);

1649 
³ndšg_tick‘s
 = !
	`li¡_em±y
(&
¥aû_šfo
->
´iÜ™y_tick‘s
);

1655 ià(!
³ndšg_tick‘s
 &&

1656 ((
u£d
 + 
Üig_by‹s
 <ğ
¥aû_šfo
->
tÙ®_by‹s
) ||

1657 
	`bŒfs_ÿn_ov”comm™
(
fs_šfo
, 
¥aû_šfo
, 
Üig_by‹s
, 
æush
))) {

1658 
	`bŒfs_¥aû_šfo_upd©e_by‹s_may_u£
(
fs_šfo
, 
¥aû_šfo
,

1659 
Üig_by‹s
);

1660 
»t
 = 0;

1668 ià(
»t
 && 
	`uÆik–y
(
æush
 =ğ
BTRFS_RESERVE_FLUSH_EMERGENCY
)) {

1669 
u£d
 = 
	`bŒfs_¥aû_šfo_u£d
(
¥aû_šfo
, 
çl£
);

1670 ià(
u£d
 + 
Üig_by‹s
 <ğ
¥aû_šfo
->
tÙ®_by‹s
) {

1671 
	`bŒfs_¥aû_šfo_upd©e_by‹s_may_u£
(
fs_šfo
, 
¥aû_šfo
,

1672 
Üig_by‹s
);

1673 
»t
 = 0;

1684 ià(
»t
 && 
	`ÿn_tick‘
(
æush
)) {

1685 
tick‘
.
by‹s
 = 
Üig_by‹s
;

1686 
tick‘
.
”rÜ
 = 0;

1687 
¥aû_šfo
->
»şaim_size
 +ğ
tick‘
.
by‹s
;

1688 
	`š™_wa™queue_h—d
(&
tick‘
.
wa™
);

1689 
tick‘
.
¡—l
 = 
	`ÿn_¡—l
(
æush
);

1690 ià(
	`Œaû_bŒfs_»£rve_tick‘_’abËd
())

1691 
¡¬t_ns
 = 
	`ktime_g‘_ns
();

1693 ià(
æush
 =ğ
BTRFS_RESERVE_FLUSH_ALL
 ||

1694 
æush
 =ğ
BTRFS_RESERVE_FLUSH_ALL_STEAL
 ||

1695 
æush
 =ğ
BTRFS_RESERVE_FLUSH_DATA
) {

1696 
	`li¡_add_
(&
tick‘
.
li¡
, &
¥aû_šfo
->
tick‘s
);

1697 ià(!
¥aû_šfo
->
æush
) {

1705 
	`maybe_şamp_´“m±
(
fs_šfo
, 
¥aû_šfo
);

1707 
¥aû_šfo
->
æush
 = 1;

1708 
	`Œaû_bŒfs_Œigg”_æush
(
fs_šfo
,

1709 
¥aû_šfo
->
æags
,

1710 
Üig_by‹s
, 
æush
,

1712 
	`queue_wÜk
(
sy¡em_unbound_wq
, 
async_wÜk
);

1715 
	`li¡_add_
(&
tick‘
.
li¡
,

1716 &
¥aû_šfo
->
´iÜ™y_tick‘s
);

1718 } ià(!
»t
 && 
¥aû_šfo
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
) {

1724 ià(!
	`‹¡_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
) &&

1725 !
	`wÜk_busy
(&
fs_šfo
->
´“m±_»şaim_wÜk
) &&

1726 
	`Ãed_´“m±ive_»şaim
(
fs_šfo
, 
¥aû_šfo
)) {

1727 
	`Œaû_bŒfs_Œigg”_æush
(
fs_šfo
, 
¥aû_šfo
->
æags
,

1728 
Üig_by‹s
, 
æush
, "preempt");

1729 
	`queue_wÜk
(
sy¡em_unbound_wq
,

1730 &
fs_šfo
->
´“m±_»şaim_wÜk
);

1733 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1734 ià(!
»t
 || !
	`ÿn_tick‘
(
æush
))

1735  
»t
;

1737  
	`hªdË_»£rve_tick‘
(
fs_šfo
, 
¥aû_šfo
, &
tick‘
, 
¡¬t_ns
,

1738 
Üig_by‹s
, 
æush
);

1739 
	}
}

1756 
	$bŒfs_»£rve_m‘ad©a_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
,

1757 
bŒfs_block_rsv
 *
block_rsv
,

1758 
u64
 
Üig_by‹s
,

1759 
bŒfs_»£rve_æush_’um
 
æush
)

1761 
»t
;

1763 
»t
 = 
	`__»£rve_by‹s
(
fs_šfo
, 
block_rsv
->
¥aû_šfo
, 
Üig_by‹s
, 
æush
);

1764 ià(
»t
 =ğ-
ENOSPC
) {

1765 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "space_info:enospc",

1766 
block_rsv
->
¥aû_šfo
->
æags
,

1767 
Üig_by‹s
, 1);

1769 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
ENOSPC_DEBUG
))

1770 
	`bŒfs_dump_¥aû_šfo
(
fs_šfo
, 
block_rsv
->
¥aû_šfo
,

1771 
Üig_by‹s
, 0);

1773  
»t
;

1774 
	}
}

1786 
	$bŒfs_»£rve_d©a_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹s
,

1787 
bŒfs_»£rve_æush_’um
 
æush
)

1789 
bŒfs_¥aû_šfo
 *
d©a_sšfo
 = 
fs_šfo
->data_sinfo;

1790 
»t
;

1792 
	`ASSERT
(
æush
 =ğ
BTRFS_RESERVE_FLUSH_DATA
 ||

1793 
æush
 =ğ
BTRFS_RESERVE_FLUSH_FREE_SPACE_INODE
 ||

1794 
æush
 =ğ
BTRFS_RESERVE_NO_FLUSH
);

1795 
	`ASSERT
(!
cu¼’t
->
jouº®_šfo
 || 
æush
 !ğ
BTRFS_RESERVE_FLUSH_DATA
);

1797 
»t
 = 
	`__»£rve_by‹s
(
fs_šfo
, 
d©a_sšfo
, 
by‹s
, 
æush
);

1798 ià(
»t
 =ğ-
ENOSPC
) {

1799 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "space_info:enospc",

1800 
d©a_sšfo
->
æags
, 
by‹s
, 1);

1801 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
ENOSPC_DEBUG
))

1802 
	`bŒfs_dump_¥aû_šfo
(
fs_šfo
, 
d©a_sšfo
, 
by‹s
, 0);

1804  
»t
;

1805 
	}
}

1808 
__cŞd
 
	$bŒfs_dump_¥aû_šfo_fÜ_Œªs_abÜt
(
bŒfs_fs_šfo
 *
fs_šfo
)

1810 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

1812 
	`bŒfs_šfo
(
fs_šfo
, "dumping space info:");

1813 
	`li¡_fÜ_—ch_’Œy
(
¥aû_šfo
, &
fs_šfo
->¥aû_šfo, 
li¡
) {

1814 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1815 
	`__bŒfs_dump_¥aû_šfo
(
fs_šfo
, 
¥aû_šfo
);

1816 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1818 
	`dump_glob®_block_rsv
(
fs_šfo
);

1819 
	}
}

1825 
u64
 
	$bŒfs_accouÁ_ro_block_groups_ä“_¥aû
(
bŒfs_¥aû_šfo
 *
sšfo
)

1827 
bŒfs_block_group
 *
block_group
;

1828 
u64
 
ä“_by‹s
 = 0;

1829 
çùÜ
;

1832 ià(
	`li¡_em±y
(&
sšfo
->
ro_bgs
))

1835 
	`¥š_lock
(&
sšfo
->
lock
);

1836 
	`li¡_fÜ_—ch_’Œy
(
block_group
, &
sšfo
->
ro_bgs
, 
ro_li¡
) {

1837 
	`¥š_lock
(&
block_group
->
lock
);

1839 ià(!
block_group
->
ro
) {

1840 
	`¥š_uÆock
(&
block_group
->
lock
);

1844 
çùÜ
 = 
	`bŒfs_bg_ty³_to_çùÜ
(
block_group
->
æags
);

1845 
ä“_by‹s
 +ğ(
block_group
->
Ëngth
 -

1846 
block_group
->
u£d
è* 
çùÜ
;

1848 
	`¥š_uÆock
(&
block_group
->
lock
);

1850 
	`¥š_uÆock
(&
sšfo
->
lock
);

1852  
ä“_by‹s
;

1853 
	}
}

	@space-info.h

3 #iâdeà
BTRFS_SPACE_INFO_H


4 
	#BTRFS_SPACE_INFO_H


	)

6 
	~"vŞumes.h
"

13 
	ebŒfs_»£rve_æush_’um
 {

15 
	mBTRFS_RESERVE_NO_FLUSH
,

22 
	mBTRFS_RESERVE_FLUSH_LIMIT
,

32 
	mBTRFS_RESERVE_FLUSH_EVICT
,

41 
	mBTRFS_RESERVE_FLUSH_DATA
,

42 
	mBTRFS_RESERVE_FLUSH_FREE_SPACE_INODE
,

43 
	mBTRFS_RESERVE_FLUSH_ALL
,

51 
	mBTRFS_RESERVE_FLUSH_ALL_STEAL
,

69 
	mBTRFS_RESERVE_FLUSH_EMERGENCY
,

72 
	ebŒfs_æush_¡©e
 {

73 
	mFLUSH_DELAYED_ITEMS_NR
 = 1,

74 
	mFLUSH_DELAYED_ITEMS
 = 2,

75 
	mFLUSH_DELAYED_REFS_NR
 = 3,

76 
	mFLUSH_DELAYED_REFS
 = 4,

77 
	mFLUSH_DELALLOC
 = 5,

78 
	mFLUSH_DELALLOC_WAIT
 = 6,

79 
	mFLUSH_DELALLOC_FULL
 = 7,

80 
	mALLOC_CHUNK
 = 8,

81 
	mALLOC_CHUNK_FORCE
 = 9,

82 
	mRUN_DELAYED_IPUTS
 = 10,

83 
	mCOMMIT_TRANS
 = 11,

86 
	sbŒfs_¥aû_šfo
 {

87 
¥šlock_t
 
	mlock
;

89 
u64
 
	mtÙ®_by‹s
;

91 
u64
 
	mby‹s_u£d
;

93 
u64
 
	mby‹s_pšÃd
;

95 
u64
 
	mby‹s_»£rved
;

97 
u64
 
	mby‹s_may_u£
;

99 
u64
 
	mby‹s_»adÚly
;

100 
u64
 
	mby‹s_zÚe_unu§bË
;

103 
u64
 
	mmax_ex‹Á_size
;

107 
u64
 
	mchunk_size
;

113 
	mbg_»şaim_th»shŞd
;

115 
	mşamp
;

119 
	mfuÎ
:1;

121 
	mchunk_®loc
:1;

123 
	mæush
:1;

125 
	mfÜû_®loc
;

128 
u64
 
	mdisk_u£d
;

129 
u64
 
	mdisk_tÙ®
;

132 
u64
 
	mæags
;

134 
li¡_h—d
 
	mli¡
;

136 
li¡_h—d
 
	mro_bgs
;

137 
li¡_h—d
 
	m´iÜ™y_tick‘s
;

138 
li¡_h—d
 
	mtick‘s
;

144 
u64
 
	m»şaim_size
;

150 
u64
 
	mtick‘s_id
;

152 
rw_£m­hÜe
 
	mgroups_£m
;

154 
li¡_h—d
 
	mblock_groups
[
BTRFS_NR_RAID_TYPES
];

156 
kobjeù
 
	mkobj
;

157 
kobjeù
 *
	mblock_group_kobjs
[
BTRFS_NR_RAID_TYPES
];

160 
	s»£rve_tick‘
 {

161 
u64
 
	mby‹s
;

162 
	m”rÜ
;

163 
boŞ
 
	m¡—l
;

164 
li¡_h—d
 
	mli¡
;

165 
wa™_queue_h—d_t
 
	mwa™
;

168 
šlše
 
boŞ
 
	$bŒfs_mixed_¥aû_šfo
(
bŒfs_¥aû_šfo
 *
¥aû_šfo
)

170  ((
¥aû_šfo
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
) &&

171 (
¥aû_šfo
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
));

172 
	}
}

178 
	#DECLARE_SPACE_INFO_UPDATE
(
Çme
, 
Œaû_Çme
) \

179 
šlše
 \

180 
bŒfs_¥aû_šfo_upd©e_
##
	`Çme
(
bŒfs_fs_šfo
 *
fs_šfo
, \

181 
bŒfs_¥aû_šfo
 *
sšfo
, \

182 
s64
 
by‹s
) \

184 cÚ¡ 
u64
 
abs_by‹s
 = (
by‹s
 < 0) ? -bytes : bytes; \

185 
	`lockd•_as£¹_h–d
(&
sšfo
->
lock
); \

186 
Œaû_upd©e_
##
	`Çme
(
fs_šfo
, 
sšfo
, sšfo->
Çme
, 
by‹s
); \

187 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, 
Œaû_Çme
, \

188 
sšfo
->
æags
, 
abs_by‹s
, \

189 
by‹s
 > 0); \

190 ià(
by‹s
 < 0 && 
sšfo
->
Çme
 < -bytes) { \

191 
	`WARN_ON
(1); \

192 
sšfo
->
Çme
 = 0; \

195 
sšfo
->
Çme
 +ğ
by‹s
; \

196 }

	)

198 
DECLARE_SPACE_INFO_UPDATE
(
by‹s_may_u£
, "space_info");

199 
DECLARE_SPACE_INFO_UPDATE
(
by‹s_pšÃd
, "pinned");

201 
bŒfs_š™_¥aû_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
);

202 
bŒfs_add_bg_to_¥aû_šfo
(
bŒfs_fs_šfo
 *
šfo
,

203 
bŒfs_block_group
 *
block_group
);

204 
bŒfs_upd©e_¥aû_šfo_chunk_size
(
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

205 
u64
 
chunk_size
);

206 
bŒfs_¥aû_šfo
 *
bŒfs_fšd_¥aû_šfo
(
bŒfs_fs_šfo
 *
šfo
,

207 
u64
 
æags
);

208 
u64
 
__pu»
 
bŒfs_¥aû_šfo_u£d
(
bŒfs_¥aû_šfo
 *
s_šfo
,

209 
boŞ
 
may_u£_šşuded
);

210 
bŒfs_ş—r_¥aû_šfo_fuÎ
(
bŒfs_fs_šfo
 *
šfo
);

211 
bŒfs_dump_¥aû_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
,

212 
bŒfs_¥aû_šfo
 *
šfo
, 
u64
 
by‹s
,

213 
dump_block_groups
);

214 
bŒfs_»£rve_m‘ad©a_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
,

215 
bŒfs_block_rsv
 *
block_rsv
,

216 
u64
 
Üig_by‹s
,

217 
bŒfs_»£rve_æush_’um
 
æush
);

218 
bŒfs_Œy_g¿Ášg_tick‘s
(
bŒfs_fs_šfo
 *
fs_šfo
,

219 
bŒfs_¥aû_šfo
 *
¥aû_šfo
);

220 
bŒfs_ÿn_ov”comm™
(
bŒfs_fs_šfo
 *
fs_šfo
,

221 
bŒfs_¥aû_šfo
 *
¥aû_šfo
, 
u64
 
by‹s
,

222 
bŒfs_»£rve_æush_’um
 
æush
);

224 
šlše
 
	$bŒfs_¥aû_šfo_ä“_by‹s_may_u£
(

225 
bŒfs_fs_šfo
 *
fs_šfo
,

226 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

227 
u64
 
num_by‹s
)

229 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

230 
	`bŒfs_¥aû_šfo_upd©e_by‹s_may_u£
(
fs_šfo
, 
¥aû_šfo
, -
num_by‹s
);

231 
	`bŒfs_Œy_g¿Ášg_tick‘s
(
fs_šfo
, 
¥aû_šfo
);

232 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

233 
	}
}

234 
bŒfs_»£rve_d©a_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹s
,

235 
bŒfs_»£rve_æush_’um
 
æush
);

236 
bŒfs_dump_¥aû_šfo_fÜ_Œªs_abÜt
(
bŒfs_fs_šfo
 *
fs_šfo
);

237 
bŒfs_š™_async_»şaim_wÜk
(
bŒfs_fs_šfo
 *
fs_šfo
);

238 
u64
 
bŒfs_accouÁ_ro_block_groups_ä“_¥aû
(
bŒfs_¥aû_šfo
 *
sšfo
);

	@subpage.c

3 
	~<lšux/¦ab.h
>

4 
	~"mes§ges.h
"

5 
	~"ù»e.h
"

6 
	~"sub·ge.h
"

7 
	~"bŒfs_šode.h
"

67 
boŞ
 
	$bŒfs_is_sub·ge
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, 
·ge
 *page)

69 ià(
fs_šfo
->
£ùÜsize
 >ğ
PAGE_SIZE
)

70  
çl£
;

77 ià(!
·ge
->
m­pšg
 || !·ge->m­pšg->
ho¡
 ||

78 
	`is_d©a_šode
(
·ge
->
m­pšg
->
ho¡
))

79  
Œue
;

85 ià(
fs_šfo
->
nodesize
 < 
PAGE_SIZE
)

86  
Œue
;

87  
çl£
;

88 
	}
}

90 
	$bŒfs_š™_sub·ge_šfo
(
bŒfs_sub·ge_šfo
 *
sub·ge_šfo
, 
u32
 
£ùÜsize
)

92 
cur
 = 0;

93 
Ä_b™s
;

95 
	`ASSERT
(
	`IS_ALIGNED
(
PAGE_SIZE
, 
£ùÜsize
));

97 
Ä_b™s
 = 
PAGE_SIZE
 / 
£ùÜsize
;

98 
sub·ge_šfo
->
b™m­_Ä_b™s
 = 
Ä_b™s
;

100 
sub·ge_šfo
->
u±od©e_off£t
 = 
cur
;

101 
cur
 +ğ
Ä_b™s
;

103 
sub·ge_šfo
->
dœty_off£t
 = 
cur
;

104 
cur
 +ğ
Ä_b™s
;

106 
sub·ge_šfo
->
wr™eback_off£t
 = 
cur
;

107 
cur
 +ğ
Ä_b™s
;

109 
sub·ge_šfo
->
Üd”ed_off£t
 = 
cur
;

110 
cur
 +ğ
Ä_b™s
;

112 
sub·ge_šfo
->
checked_off£t
 = 
cur
;

113 
cur
 +ğ
Ä_b™s
;

115 
sub·ge_šfo
->
tÙ®_Ä_b™s
 = 
cur
;

116 
	}
}

118 
	$bŒfs_©ch_sub·ge
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

119 
·ge
 *·ge, 
bŒfs_sub·ge_ty³
 
ty³
)

121 
bŒfs_sub·ge
 *
sub·ge
;

127 ià(
·ge
->
m­pšg
)

128 
	`ASSERT
(
	`PageLocked
(
·ge
));

131 ià(!
	`bŒfs_is_sub·ge
(
fs_šfo
, 
·ge
è|| 
	`PagePriv©e
(page))

134 
sub·ge
 = 
	`bŒfs_®loc_sub·ge
(
fs_šfo
, 
ty³
);

135 ià(
	`IS_ERR
(
sub·ge
))

136  
	`PTR_ERR
(
sub·ge
);

138 
	`©ch_·ge_´iv©e
(
·ge
, 
sub·ge
);

140 
	}
}

142 
	$bŒfs_d‘ach_sub·ge
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

143 
·ge
 *page)

145 
bŒfs_sub·ge
 *
sub·ge
;

148 ià(!
	`bŒfs_is_sub·ge
(
fs_šfo
, 
·ge
è|| !
	`PagePriv©e
(page))

151 
sub·ge
 = 
	`d‘ach_·ge_´iv©e
(
·ge
);

152 
	`ASSERT
(
sub·ge
);

153 
	`bŒfs_ä“_sub·ge
(
sub·ge
);

154 
	}
}

156 
bŒfs_sub·ge
 *
	$bŒfs_®loc_sub·ge
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

157 
bŒfs_sub·ge_ty³
 
ty³
)

159 
bŒfs_sub·ge
 *
»t
;

160 
»®_size
;

162 
	`ASSERT
(
fs_šfo
->
£ùÜsize
 < 
PAGE_SIZE
);

164 
»®_size
 = 
	`¡ruù_size
(
»t
, 
b™m­s
,

165 
	`BITS_TO_LONGS
(
fs_šfo
->
sub·ge_šfo
->
tÙ®_Ä_b™s
));

166 
»t
 = 
	`kz®loc
(
»®_size
, 
GFP_NOFS
);

167 ià(!
»t
)

168  
	`ERR_PTR
(-
ENOMEM
);

170 
	`¥š_lock_š™
(&
»t
->
lock
);

171 ià(
ty³
 =ğ
BTRFS_SUBPAGE_METADATA
) {

172 
	`©omic_£t
(&
»t
->
eb_»fs
, 0);

174 
	`©omic_£t
(&
»t
->
»ad”s
, 0);

175 
	`©omic_£t
(&
»t
->
wr™”s
, 0);

177  
»t
;

178 
	}
}

180 
	$bŒfs_ä“_sub·ge
(
bŒfs_sub·ge
 *
sub·ge
)

182 
	`kä“
(
sub·ge
);

183 
	}
}

194 
	$bŒfs_·ge_šc_eb_»fs
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

195 
·ge
 *page)

197 
bŒfs_sub·ge
 *
sub·ge
;

199 ià(!
	`bŒfs_is_sub·ge
(
fs_šfo
, 
·ge
))

202 
	`ASSERT
(
	`PagePriv©e
(
·ge
è&&…age->
m­pšg
);

203 
	`lockd•_as£¹_h–d
(&
·ge
->
m­pšg
->
´iv©e_lock
);

205 
sub·ge
 = (
bŒfs_sub·ge
 *)
·ge
->
´iv©e
;

206 
	`©omic_šc
(&
sub·ge
->
eb_»fs
);

207 
	}
}

209 
	$bŒfs_·ge_dec_eb_»fs
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

210 
·ge
 *page)

212 
bŒfs_sub·ge
 *
sub·ge
;

214 ià(!
	`bŒfs_is_sub·ge
(
fs_šfo
, 
·ge
))

217 
	`ASSERT
(
	`PagePriv©e
(
·ge
è&&…age->
m­pšg
);

218 
	`lockd•_as£¹_h–d
(&
·ge
->
m­pšg
->
´iv©e_lock
);

220 
sub·ge
 = (
bŒfs_sub·ge
 *)
·ge
->
´iv©e
;

221 
	`ASSERT
(
	`©omic_»ad
(&
sub·ge
->
eb_»fs
));

222 
	`©omic_dec
(&
sub·ge
->
eb_»fs
);

223 
	}
}

225 
	$bŒfs_sub·ge_as£¹
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

226 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

229 
	`ASSERT
(
	`PagePriv©e
(
·ge
è&&…age->
´iv©e
);

230 
	`ASSERT
(
	`IS_ALIGNED
(
¡¬t
, 
fs_šfo
->
£ùÜsize
) &&

231 
	`IS_ALIGNED
(
Ën
, 
fs_šfo
->
£ùÜsize
));

236 ià(
·ge
->
m­pšg
)

237 
	`ASSERT
(
	`·ge_off£t
(
·ge
è<ğ
¡¬t
 &&

238 
¡¬t
 + 
Ën
 <ğ
	`·ge_off£t
(
·ge
è+ 
PAGE_SIZE
);

239 
	}
}

241 
	$bŒfs_sub·ge_¡¬t_»ad”
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

242 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

244 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

245 cÚ¡ 
nb™s
 = 
Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
;

247 
	`bŒfs_sub·ge_as£¹
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

249 
	`©omic_add
(
nb™s
, &
sub·ge
->
»ad”s
);

250 
	}
}

252 
	$bŒfs_sub·ge_’d_»ad”
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

253 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

255 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

256 cÚ¡ 
nb™s
 = 
Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
;

257 
boŞ
 
is_d©a
;

258 
boŞ
 
Ï¡
;

260 
	`bŒfs_sub·ge_as£¹
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

261 
is_d©a
 = 
	`is_d©a_šode
(
·ge
->
m­pšg
->
ho¡
);

262 
	`ASSERT
(
	`©omic_»ad
(&
sub·ge
->
»ad”s
è>ğ
nb™s
);

263 
Ï¡
 = 
	`©omic_sub_ªd_‹¡
(
nb™s
, &
sub·ge
->
»ad”s
);

272 ià(
is_d©a
 && 
Ï¡
)

273 
	`uÆock_·ge
(
·ge
);

274 
	}
}

276 
	$bŒfs_sub·ge_şamp_¿nge
(
·ge
 *·ge, 
u64
 *
¡¬t
, 
u32
 *
Ën
)

278 
u64
 
Üig_¡¬t
 = *
¡¬t
;

279 
u32
 
Üig_Ën
 = *
Ën
;

281 *
¡¬t
 = 
	`max_t
(
u64
, 
	`·ge_off£t
(
·ge
), 
Üig_¡¬t
);

287 ià(
	`·ge_off£t
(
·ge
è>ğ
Üig_¡¬t
 + 
Üig_Ën
)

288 *
Ën
 = 0;

290 *
Ën
 = 
	`mš_t
(
u64
, 
	`·ge_off£t
(
·ge
è+ 
PAGE_SIZE
,

291 
Üig_¡¬t
 + 
Üig_Ën
è- *
¡¬t
;

292 
	}
}

294 
	$bŒfs_sub·ge_¡¬t_wr™”
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

295 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

297 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

298 cÚ¡ 
nb™s
 = (
Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
);

299 
»t
;

301 
	`bŒfs_sub·ge_as£¹
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

303 
	`ASSERT
(
	`©omic_»ad
(&
sub·ge
->
»ad”s
) == 0);

304 
»t
 = 
	`©omic_add_»tuº
(
nb™s
, &
sub·ge
->
wr™”s
);

305 
	`ASSERT
(
»t
 =ğ
nb™s
);

306 
	}
}

308 
boŞ
 
	$bŒfs_sub·ge_’d_ªd_‹¡_wr™”
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

309 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

311 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

312 cÚ¡ 
nb™s
 = (
Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
);

314 
	`bŒfs_sub·ge_as£¹
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

323 ià(
	`©omic_»ad
(&
sub·ge
->
wr™”s
) == 0)

324  
Œue
;

326 
	`ASSERT
(
	`©omic_»ad
(&
sub·ge
->
wr™”s
è>ğ
nb™s
);

327  
	`©omic_sub_ªd_‹¡
(
nb™s
, &
sub·ge
->
wr™”s
);

328 
	}
}

340 
	$bŒfs_·ge_¡¬t_wr™”_lock
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

341 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

343 ià(
	`uÆik–y
(!
fs_šfo
è|| !
	`bŒfs_is_sub·ge
(fs_šfo, 
·ge
)) {

344 
	`lock_·ge
(
·ge
);

347 
	`lock_·ge
(
·ge
);

348 ià(!
	`PagePriv©e
(
·ge
è|| !·ge->
´iv©e
) {

349 
	`uÆock_·ge
(
·ge
);

350  -
EAGAIN
;

352 
	`bŒfs_sub·ge_şamp_¿nge
(
·ge
, &
¡¬t
, &
Ën
);

353 
	`bŒfs_sub·ge_¡¬t_wr™”
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

355 
	}
}

357 
	$bŒfs_·ge_’d_wr™”_lock
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

358 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

360 ià(
	`uÆik–y
(!
fs_šfo
è|| !
	`bŒfs_is_sub·ge
(fs_šfo, 
·ge
))

361  
	`uÆock_·ge
(
·ge
);

362 
	`bŒfs_sub·ge_şamp_¿nge
(
·ge
, &
¡¬t
, &
Ën
);

363 ià(
	`bŒfs_sub·ge_’d_ªd_‹¡_wr™”
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
))

364 
	`uÆock_·ge
(
·ge
);

365 
	}
}

367 
	#sub·ge_ÿlc_¡¬t_b™
(
fs_šfo
, 
·ge
, 
Çme
, 
¡¬t
, 
Ën
) \

369 
¡¬t_b™
; \

371 
	`bŒfs_sub·ge_as£¹
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
); \

372 
¡¬t_b™
 = 
	`off£t_š_·ge
(
¡¬t
è>> 
fs_šfo
->
£ùÜsize_b™s
; \

373 
¡¬t_b™
 +ğ
fs_šfo
->
sub·ge_šfo
->
Çme
##
_off£t
; \

374 
¡¬t_b™
; \

375 })

	)

377 
	#sub·ge_‹¡_b™m­_®l_£t
(
fs_šfo
, 
sub·ge
, 
Çme
) \

378 
	`b™m­_‹¡_¿nge_®l_£t
(
sub·ge
->
b™m­s
, \

379 
fs_šfo
->
sub·ge_šfo
->
Çme
##
_off£t
, \

380 
fs_šfo
->
sub·ge_šfo
->
b™m­_Ä_b™s
)

	)

382 
	#sub·ge_‹¡_b™m­_®l_z”o
(
fs_šfo
, 
sub·ge
, 
Çme
) \

383 
	`b™m­_‹¡_¿nge_®l_z”o
(
sub·ge
->
b™m­s
, \

384 
fs_šfo
->
sub·ge_šfo
->
Çme
##
_off£t
, \

385 
fs_šfo
->
sub·ge_šfo
->
b™m­_Ä_b™s
)

	)

387 
	$bŒfs_sub·ge_£t_u±od©e
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

388 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

390 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

391 
¡¬t_b™
 = 
	`sub·ge_ÿlc_¡¬t_b™
(
fs_šfo
, 
·ge
,

392 
u±od©e
, 
¡¬t
, 
Ën
);

393 
æags
;

395 
	`¥š_lock_œq§ve
(&
sub·ge
->
lock
, 
æags
);

396 
	`b™m­_£t
(
sub·ge
->
b™m­s
, 
¡¬t_b™
, 
Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
);

397 ià(
	`sub·ge_‹¡_b™m­_®l_£t
(
fs_šfo
, 
sub·ge
, 
u±od©e
))

398 
	`S‘PageU±od©e
(
·ge
);

399 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
);

400 
	}
}

402 
	$bŒfs_sub·ge_ş—r_u±od©e
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

403 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

405 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

406 
¡¬t_b™
 = 
	`sub·ge_ÿlc_¡¬t_b™
(
fs_šfo
, 
·ge
,

407 
u±od©e
, 
¡¬t
, 
Ën
);

408 
æags
;

410 
	`¥š_lock_œq§ve
(&
sub·ge
->
lock
, 
æags
);

411 
	`b™m­_ş—r
(
sub·ge
->
b™m­s
, 
¡¬t_b™
, 
Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
);

412 
	`CË¬PageU±od©e
(
·ge
);

413 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
);

414 
	}
}

416 
	$bŒfs_sub·ge_£t_dœty
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

417 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

419 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

420 
¡¬t_b™
 = 
	`sub·ge_ÿlc_¡¬t_b™
(
fs_šfo
, 
·ge
,

421 
dœty
, 
¡¬t
, 
Ën
);

422 
æags
;

424 
	`¥š_lock_œq§ve
(&
sub·ge
->
lock
, 
æags
);

425 
	`b™m­_£t
(
sub·ge
->
b™m­s
, 
¡¬t_b™
, 
Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
);

426 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
);

427 
	`£t_·ge_dœty
(
·ge
);

428 
	}
}

440 
boŞ
 
	$bŒfs_sub·ge_ş—r_ªd_‹¡_dœty
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

441 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

443 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

444 
¡¬t_b™
 = 
	`sub·ge_ÿlc_¡¬t_b™
(
fs_šfo
, 
·ge
,

445 
dœty
, 
¡¬t
, 
Ën
);

446 
æags
;

447 
boŞ
 
Ï¡
 = 
çl£
;

449 
	`¥š_lock_œq§ve
(&
sub·ge
->
lock
, 
æags
);

450 
	`b™m­_ş—r
(
sub·ge
->
b™m­s
, 
¡¬t_b™
, 
Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
);

451 ià(
	`sub·ge_‹¡_b™m­_®l_z”o
(
fs_šfo
, 
sub·ge
, 
dœty
))

452 
Ï¡
 = 
Œue
;

453 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
);

454  
Ï¡
;

455 
	}
}

457 
	$bŒfs_sub·ge_ş—r_dœty
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

458 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

460 
boŞ
 
Ï¡
;

462 
Ï¡
 = 
	`bŒfs_sub·ge_ş—r_ªd_‹¡_dœty
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

463 ià(
Ï¡
)

464 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

465 
	}
}

467 
	$bŒfs_sub·ge_£t_wr™eback
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

468 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

470 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

471 
¡¬t_b™
 = 
	`sub·ge_ÿlc_¡¬t_b™
(
fs_šfo
, 
·ge
,

472 
wr™eback
, 
¡¬t
, 
Ën
);

473 
æags
;

475 
	`¥š_lock_œq§ve
(&
sub·ge
->
lock
, 
æags
);

476 
	`b™m­_£t
(
sub·ge
->
b™m­s
, 
¡¬t_b™
, 
Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
);

477 
	`£t_·ge_wr™eback
(
·ge
);

478 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
);

479 
	}
}

481 
	$bŒfs_sub·ge_ş—r_wr™eback
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

482 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

484 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

485 
¡¬t_b™
 = 
	`sub·ge_ÿlc_¡¬t_b™
(
fs_šfo
, 
·ge
,

486 
wr™eback
, 
¡¬t
, 
Ën
);

487 
æags
;

489 
	`¥š_lock_œq§ve
(&
sub·ge
->
lock
, 
æags
);

490 
	`b™m­_ş—r
(
sub·ge
->
b™m­s
, 
¡¬t_b™
, 
Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
);

491 ià(
	`sub·ge_‹¡_b™m­_®l_z”o
(
fs_šfo
, 
sub·ge
, 
wr™eback
)) {

492 
	`ASSERT
(
	`PageWr™eback
(
·ge
));

493 
	`’d_·ge_wr™eback
(
·ge
);

495 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
);

496 
	}
}

498 
	$bŒfs_sub·ge_£t_Üd”ed
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

499 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

501 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

502 
¡¬t_b™
 = 
	`sub·ge_ÿlc_¡¬t_b™
(
fs_šfo
, 
·ge
,

503 
Üd”ed
, 
¡¬t
, 
Ën
);

504 
æags
;

506 
	`¥š_lock_œq§ve
(&
sub·ge
->
lock
, 
æags
);

507 
	`b™m­_£t
(
sub·ge
->
b™m­s
, 
¡¬t_b™
, 
Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
);

508 
	`S‘PageOrd”ed
(
·ge
);

509 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
);

510 
	}
}

512 
	$bŒfs_sub·ge_ş—r_Üd”ed
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

513 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

515 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

516 
¡¬t_b™
 = 
	`sub·ge_ÿlc_¡¬t_b™
(
fs_šfo
, 
·ge
,

517 
Üd”ed
, 
¡¬t
, 
Ën
);

518 
æags
;

520 
	`¥š_lock_œq§ve
(&
sub·ge
->
lock
, 
æags
);

521 
	`b™m­_ş—r
(
sub·ge
->
b™m­s
, 
¡¬t_b™
, 
Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
);

522 ià(
	`sub·ge_‹¡_b™m­_®l_z”o
(
fs_šfo
, 
sub·ge
, 
Üd”ed
))

523 
	`CË¬PageOrd”ed
(
·ge
);

524 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
);

525 
	}
}

527 
	$bŒfs_sub·ge_£t_checked
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

528 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

530 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

531 
¡¬t_b™
 = 
	`sub·ge_ÿlc_¡¬t_b™
(
fs_šfo
, 
·ge
,

532 
checked
, 
¡¬t
, 
Ën
);

533 
æags
;

535 
	`¥š_lock_œq§ve
(&
sub·ge
->
lock
, 
æags
);

536 
	`b™m­_£t
(
sub·ge
->
b™m­s
, 
¡¬t_b™
, 
Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
);

537 ià(
	`sub·ge_‹¡_b™m­_®l_£t
(
fs_šfo
, 
sub·ge
, 
checked
))

538 
	`S‘PageChecked
(
·ge
);

539 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
);

540 
	}
}

542 
	$bŒfs_sub·ge_ş—r_checked
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

543 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

545 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

546 
¡¬t_b™
 = 
	`sub·ge_ÿlc_¡¬t_b™
(
fs_šfo
, 
·ge
,

547 
checked
, 
¡¬t
, 
Ën
);

548 
æags
;

550 
	`¥š_lock_œq§ve
(&
sub·ge
->
lock
, 
æags
);

551 
	`b™m­_ş—r
(
sub·ge
->
b™m­s
, 
¡¬t_b™
, 
Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
);

552 
	`CË¬PageChecked
(
·ge
);

553 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
);

554 
	}
}

560 
	#IMPLEMENT_BTRFS_SUBPAGE_TEST_OP
(
Çme
) \

561 
boŞ
 
bŒfs_sub·ge_‹¡_
##
	`Çme
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, \

562 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
) \

564 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
; \

565 
¡¬t_b™
 = 
	`sub·ge_ÿlc_¡¬t_b™
(
fs_šfo
, 
·ge
, \

566 
Çme
, 
¡¬t
, 
Ën
); \

567 
æags
; \

568 
boŞ
 
»t
; \

570 
	`¥š_lock_œq§ve
(&
sub·ge
->
lock
, 
æags
); \

571 
»t
 = 
	`b™m­_‹¡_¿nge_®l_£t
(
sub·ge
->
b™m­s
, 
¡¬t_b™
, \

572 
Ën
 >> 
fs_šfo
->
£ùÜsize_b™s
); \

573 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
); \

574  
»t
; \

575 }

	)

576 
IMPLEMENT_BTRFS_SUBPAGE_TEST_OP
(
u±od©e
);

577 
IMPLEMENT_BTRFS_SUBPAGE_TEST_OP
(
dœty
);

578 
IMPLEMENT_BTRFS_SUBPAGE_TEST_OP
(
wr™eback
);

579 
IMPLEMENT_BTRFS_SUBPAGE_TEST_OP
(
Üd”ed
);

580 
IMPLEMENT_BTRFS_SUBPAGE_TEST_OP
(
checked
);

587 
	#IMPLEMENT_BTRFS_PAGE_OPS
(
Çme
, 
£t_·ge_func
, 
ş—r_·ge_func
, \

588 
‹¡_·ge_func
) \

589 
bŒfs_·ge_£t_
##
	`Çme
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, \

590 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
) \

592 ià(
	`uÆik–y
(!
fs_šfo
è|| !
	`bŒfs_is_sub·ge
(fs_šfo, 
·ge
)) { \

593 
	`£t_·ge_func
(
·ge
); \

596 
bŒfs_sub·ge_£t_
##
	`Çme
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
); \

598 
bŒfs_·ge_ş—r_
##
	`Çme
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, \

599 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
) \

601 ià(
	`uÆik–y
(!
fs_šfo
è|| !
	`bŒfs_is_sub·ge
(fs_šfo, 
·ge
)) { \

602 
	`ş—r_·ge_func
(
·ge
); \

605 
bŒfs_sub·ge_ş—r_
##
	`Çme
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
); \

607 
boŞ
 
bŒfs_·ge_‹¡_
##
	`Çme
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, \

608 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
) \

610 ià(
	`uÆik–y
(!
fs_šfo
è|| !
	`bŒfs_is_sub·ge
(fs_šfo, 
·ge
)) \

611  
	`‹¡_·ge_func
(
·ge
); \

612  
bŒfs_sub·ge_‹¡_
##
	`Çme
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
); \

614 
bŒfs_·ge_şamp_£t_
##
	`Çme
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, \

615 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
) \

617 ià(
	`uÆik–y
(!
fs_šfo
è|| !
	`bŒfs_is_sub·ge
(fs_šfo, 
·ge
)) { \

618 
	`£t_·ge_func
(
·ge
); \

621 
	`bŒfs_sub·ge_şamp_¿nge
(
·ge
, &
¡¬t
, &
Ën
); \

622 
bŒfs_sub·ge_£t_
##
	`Çme
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
); \

624 
bŒfs_·ge_şamp_ş—r_
##
	`Çme
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, \

625 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
) \

627 ià(
	`uÆik–y
(!
fs_šfo
è|| !
	`bŒfs_is_sub·ge
(fs_šfo, 
·ge
)) { \

628 
	`ş—r_·ge_func
(
·ge
); \

631 
	`bŒfs_sub·ge_şamp_¿nge
(
·ge
, &
¡¬t
, &
Ën
); \

632 
bŒfs_sub·ge_ş—r_
##
	`Çme
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
); \

634 
boŞ
 
bŒfs_·ge_şamp_‹¡_
##
	`Çme
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, \

635 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
) \

637 ià(
	`uÆik–y
(!
fs_šfo
è|| !
	`bŒfs_is_sub·ge
(fs_šfo, 
·ge
)) \

638  
	`‹¡_·ge_func
(
·ge
); \

639 
	`bŒfs_sub·ge_şamp_¿nge
(
·ge
, &
¡¬t
, &
Ën
); \

640  
bŒfs_sub·ge_‹¡_
##
	`Çme
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
); \

641 }

	)

642 
IMPLEMENT_BTRFS_PAGE_OPS
(
u±od©e
, 
S‘PageU±od©e
, 
CË¬PageU±od©e
,

643 
PageU±od©e
);

644 
IMPLEMENT_BTRFS_PAGE_OPS
(
dœty
, 
£t_·ge_dœty
, 
ş—r_·ge_dœty_fÜ_io
,

645 
PageDœty
);

646 
IMPLEMENT_BTRFS_PAGE_OPS
(
wr™eback
, 
£t_·ge_wr™eback
, 
’d_·ge_wr™eback
,

647 
PageWr™eback
);

648 
IMPLEMENT_BTRFS_PAGE_OPS
(
Üd”ed
, 
S‘PageOrd”ed
, 
CË¬PageOrd”ed
,

649 
PageOrd”ed
);

650 
IMPLEMENT_BTRFS_PAGE_OPS
(
checked
, 
S‘PageChecked
, 
CË¬PageChecked
, 
PageChecked
);

656 
	$bŒfs_·ge_as£¹_nÙ_dœty
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

657 
·ge
 *page)

659 
bŒfs_sub·ge
 *
sub·ge
 = (bŒfs_sub·g*)
·ge
->
´iv©e
;

661 ià(!
	`IS_ENABLED
(
CONFIG_BTRFS_ASSERT
))

664 
	`ASSERT
(!
	`PageDœty
(
·ge
));

665 ià(!
	`bŒfs_is_sub·ge
(
fs_šfo
, 
·ge
))

668 
	`ASSERT
(
	`PagePriv©e
(
·ge
è&&…age->
´iv©e
);

669 
	`ASSERT
(
	`sub·ge_‹¡_b™m­_®l_z”o
(
fs_šfo
, 
sub·ge
, 
dœty
));

670 
	}
}

687 
	$bŒfs_·ge_uÆock_wr™”
(
bŒfs_fs_šfo
 *
fs_šfo
, 
·ge
 *page,

688 
u64
 
¡¬t
, 
u32
 
Ën
)

690 
bŒfs_sub·ge
 *
sub·ge
;

692 
	`ASSERT
(
	`PageLocked
(
·ge
));

694 ià(!
	`bŒfs_is_sub·ge
(
fs_šfo
, 
·ge
))

695  
	`uÆock_·ge
(
·ge
);

697 
	`ASSERT
(
	`PagePriv©e
(
·ge
è&&…age->
´iv©e
);

698 
sub·ge
 = (
bŒfs_sub·ge
 *)
·ge
->
´iv©e
;

707 ià(
	`©omic_»ad
(&
sub·ge
->
wr™”s
) == 0)

709  
	`uÆock_·ge
(
·ge
);

712 
	`bŒfs_·ge_’d_wr™”_lock
(
fs_šfo
, 
·ge
, 
¡¬t
, 
Ën
);

713 
	}
}

715 
	#GET_SUBPAGE_BITMAP
(
sub·ge
, 
sub·ge_šfo
, 
Çme
, 
d¡
) \

716 
	`b™m­_cut
(
d¡
, 
sub·ge
->
b™m­s
, 0, \

717 
sub·ge_šfo
->
Çme
##
_off£t
, sub·ge_šfo->
b™m­_Ä_b™s
)

	)

719 
__cŞd
 
	$bŒfs_sub·ge_dump_b™m­
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

720 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
)

722 
bŒfs_sub·ge_šfo
 *
sub·ge_šfo
 = 
fs_šfo
->subpage_info;

723 
bŒfs_sub·ge
 *
sub·ge
;

724 
u±od©e_b™m­
;

725 
”rÜ_b™m­
;

726 
dœty_b™m­
;

727 
wr™eback_b™m­
;

728 
Üd”ed_b™m­
;

729 
checked_b™m­
;

730 
æags
;

732 
	`ASSERT
(
	`PagePriv©e
(
·ge
è&&…age->
´iv©e
);

733 
	`ASSERT
(
sub·ge_šfo
);

734 
sub·ge
 = (
bŒfs_sub·ge
 *)
·ge
->
´iv©e
;

736 
	`¥š_lock_œq§ve
(&
sub·ge
->
lock
, 
æags
);

737 
	`GET_SUBPAGE_BITMAP
(
sub·ge
, 
sub·ge_šfo
, 
u±od©e
, &
u±od©e_b™m­
);

738 
	`GET_SUBPAGE_BITMAP
(
sub·ge
, 
sub·ge_šfo
, 
dœty
, &
dœty_b™m­
);

739 
	`GET_SUBPAGE_BITMAP
(
sub·ge
, 
sub·ge_šfo
, 
wr™eback
, &
wr™eback_b™m­
);

740 
	`GET_SUBPAGE_BITMAP
(
sub·ge
, 
sub·ge_šfo
, 
Üd”ed
, &
Üd”ed_b™m­
);

741 
	`GET_SUBPAGE_BITMAP
(
sub·ge
, 
sub·ge_šfo
, 
checked
, &
checked_b™m­
);

742 
	`¥š_uÆock_œq»¡Üe
(&
sub·ge
->
lock
, 
æags
);

744 
	`dump_·ge
(
·ge
, "btrfs subpage dump");

745 
	`bŒfs_w¬n
(
fs_šfo
,

747 
¡¬t
, 
Ën
, 
	`·ge_off£t
(
·ge
),

748 
sub·ge_šfo
->
b™m­_Ä_b™s
, &
u±od©e_b™m­
,

749 
sub·ge_šfo
->
b™m­_Ä_b™s
, &
”rÜ_b™m­
,

750 
sub·ge_šfo
->
b™m­_Ä_b™s
, &
dœty_b™m­
,

751 
sub·ge_šfo
->
b™m­_Ä_b™s
, &
wr™eback_b™m­
,

752 
sub·ge_šfo
->
b™m­_Ä_b™s
, &
Üd”ed_b™m­
,

753 
sub·ge_šfo
->
b™m­_Ä_b™s
, &
checked_b™m­
);

754 
	}
}

	@subpage.h

3 #iâdeà
BTRFS_SUBPAGE_H


4 
	#BTRFS_SUBPAGE_H


	)

6 
	~<lšux/¥šlock.h
>

23 
	sbŒfs_sub·ge_šfo
 {

25 
	mb™m­_Ä_b™s
;

28 
	mtÙ®_Ä_b™s
;

34 
	mu±od©e_off£t
;

35 
	mdœty_off£t
;

36 
	mwr™eback_off£t
;

37 
	mÜd”ed_off£t
;

38 
	mchecked_off£t
;

45 
	sbŒfs_sub·ge
 {

47 
¥šlock_t
 
	mlock
;

55 
©omic_t
 
	m»ad”s
;

63 
©omic_t
 
	meb_»fs
;

66 
©omic_t
 
	mwr™”s
;

68 
	mb™m­s
[];

71 
	ebŒfs_sub·ge_ty³
 {

72 
	mBTRFS_SUBPAGE_METADATA
,

73 
	mBTRFS_SUBPAGE_DATA
,

76 
boŞ
 
bŒfs_is_sub·ge
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, 
·ge
 *page);

78 
bŒfs_š™_sub·ge_šfo
(
bŒfs_sub·ge_šfo
 *
sub·ge_šfo
, 
u32
 
£ùÜsize
);

79 
bŒfs_©ch_sub·ge
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

80 
·ge
 *·ge, 
bŒfs_sub·ge_ty³
 
ty³
);

81 
bŒfs_d‘ach_sub·ge
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

82 
·ge
 *page);

85 
bŒfs_sub·ge
 *
bŒfs_®loc_sub·ge
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

86 
bŒfs_sub·ge_ty³
 
ty³
);

87 
bŒfs_ä“_sub·ge
(
bŒfs_sub·ge
 *
sub·ge
);

89 
bŒfs_·ge_šc_eb_»fs
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

90 
·ge
 *page);

91 
bŒfs_·ge_dec_eb_»fs
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

92 
·ge
 *page);

94 
bŒfs_sub·ge_¡¬t_»ad”
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

95 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
);

96 
bŒfs_sub·ge_’d_»ad”
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

97 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
);

99 
bŒfs_sub·ge_¡¬t_wr™”
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

100 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
);

101 
boŞ
 
bŒfs_sub·ge_’d_ªd_‹¡_wr™”
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

102 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
);

103 
bŒfs_·ge_¡¬t_wr™”_lock
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

104 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
);

105 
bŒfs_·ge_’d_wr™”_lock
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

106 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
);

122 
	#DECLARE_BTRFS_SUBPAGE_OPS
(
Çme
) \

123 
bŒfs_sub·ge_£t_
##
	`Çme
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, \

124 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
); \

125 
bŒfs_sub·ge_ş—r_
##
	`Çme
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, \

126 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
); \

127 
boŞ
 
bŒfs_sub·ge_‹¡_
##
	`Çme
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, \

128 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
); \

129 
bŒfs_·ge_£t_
##
	`Çme
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, \

130 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
); \

131 
bŒfs_·ge_ş—r_
##
	`Çme
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, \

132 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
); \

133 
boŞ
 
bŒfs_·ge_‹¡_
##
	`Çme
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, \

134 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
); \

135 
bŒfs_·ge_şamp_£t_
##
	`Çme
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, \

136 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
); \

137 
bŒfs_·ge_şamp_ş—r_
##
	`Çme
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, \

138 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
); \

139 
boŞ
 
bŒfs_·ge_şamp_‹¡_
##
	`Çme
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, \

140 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
);

	)

142 
DECLARE_BTRFS_SUBPAGE_OPS
(
u±od©e
);

143 
DECLARE_BTRFS_SUBPAGE_OPS
(
dœty
);

144 
DECLARE_BTRFS_SUBPAGE_OPS
(
wr™eback
);

145 
DECLARE_BTRFS_SUBPAGE_OPS
(
Üd”ed
);

146 
DECLARE_BTRFS_SUBPAGE_OPS
(
checked
);

148 
boŞ
 
bŒfs_sub·ge_ş—r_ªd_‹¡_dœty
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

149 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
);

151 
bŒfs_·ge_as£¹_nÙ_dœty
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

152 
·ge
 *page);

153 
bŒfs_·ge_uÆock_wr™”
(
bŒfs_fs_šfo
 *
fs_šfo
, 
·ge
 *page,

154 
u64
 
¡¬t
, 
u32
 
Ën
);

155 
__cŞd
 
bŒfs_sub·ge_dump_b™m­
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

156 
·ge
 *·ge, 
u64
 
¡¬t
, 
u32
 
Ën
);

	@super.c

6 
	~<lšux/blkdev.h
>

7 
	~<lšux/moduË.h
>

8 
	~<lšux/fs.h
>

9 
	~<lšux/·gem­.h
>

10 
	~<lšux/highmem.h
>

11 
	~<lšux/time.h
>

12 
	~<lšux/š™.h
>

13 
	~<lšux/£q_fe.h
>

14 
	~<lšux/¡ršg.h
>

15 
	~<lšux/backšg-dev.h
>

16 
	~<lšux/mouÁ.h
>

17 
	~<lšux/wr™eback.h
>

18 
	~<lšux/¡©fs.h
>

19 
	~<lšux/com·t.h
>

20 
	~<lšux/·r£r.h
>

21 
	~<lšux/ùy³.h
>

22 
	~<lšux/Çmei.h
>

23 
	~<lšux/miscdeviû.h
>

24 
	~<lšux/magic.h
>

25 
	~<lšux/¦ab.h
>

26 
	~<lšux/¿‹lim™.h
>

27 
	~<lšux/üc32c.h
>

28 
	~<lšux/bŒfs.h
>

29 
	~"mes§ges.h
"

30 
	~"d–ayed-šode.h
"

31 
	~"ù»e.h
"

32 
	~"disk-io.h
"

33 
	~"Œª§ùiÚ.h
"

34 
	~"bŒfs_šode.h
"

35 
	~"´št-Œ“.h
"

36 
	~"´İs.h
"

37 
	~"x©Œ.h
"

38 
	~"bio.h
"

39 
	~"expÜt.h
"

40 
	~"com´essiÚ.h
"

41 
	~"rcu-¡ršg.h
"

42 
	~"dev-»¶aû.h
"

43 
	~"ä“-¥aû-ÿche.h
"

44 
	~"back»f.h
"

45 
	~"¥aû-šfo.h
"

46 
	~"sysfs.h
"

47 
	~"zÚed.h
"

48 
	~"‹¡s/bŒfs-‹¡s.h
"

49 
	~"block-group.h
"

50 
	~"disÿrd.h
"

51 
	~"qgroup.h
"

52 
	~"¿id56.h
"

53 
	~"fs.h
"

54 
	~"acûssÜs.h
"

55 
	~"deäag.h
"

56 
	~"dœ-™em.h
"

57 
	~"ioùl.h
"

58 
	~"süub.h
"

59 
	~"v”™y.h
"

60 
	~"su³r.h
"

61 
	~"ex‹Á-Œ“.h
"

62 
	#CREATE_TRACE_POINTS


	)

63 
	~<Œaû/ev’ts/bŒfs.h
>

65 cÚ¡ 
su³r_İ”©iÚs
 
	gbŒfs_su³r_İs
;

75 
fe_sy¡em_ty³
 
	gbŒfs_fs_ty³
;

76 
fe_sy¡em_ty³
 
	gbŒfs_roÙ_fs_ty³
;

78 
bŒfs_»mouÁ
(
su³r_block
 *
sb
, *
æags
, *
d©a
);

80 
	$bŒfs_put_su³r
(
su³r_block
 *
sb
)

82 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

84 
	`bŒfs_šfo
(
fs_šfo
, "Ï¡ unmouÁ oàfesy¡em %pU", fs_šfo->
fs_deviûs
->
fsid
);

85 
	`şo£_ù»e
(
fs_šfo
);

86 
	}
}

89 
	mO±_aş
, 
	mO±_nßş
,

90 
	mO±_ş—r_ÿche
,

91 
	mO±_comm™_š‹rv®
,

92 
	mO±_com´ess
,

93 
	mO±_com´ess_fÜû
,

94 
	mO±_com´ess_fÜû_ty³
,

95 
	mO±_com´ess_ty³
,

96 
	mO±_deg¿ded
,

97 
	mO±_deviû
,

98 
	mO±_çl_”rÜs
,

99 
	mO±_æushÚcomm™
, 
	mO±_noæushÚcomm™
,

100 
	mO±_max_šlše
,

101 
	mO±_b¬r›r
, 
	mO±_nob¬r›r
,

102 
	mO±_d©acow
, 
	mO±_nod©acow
,

103 
	mO±_d©asum
, 
	mO±_nod©asum
,

104 
	mO±_deäag
, 
	mO±_nodeäag
,

105 
	mO±_disÿrd
, 
	mO±_nodisÿrd
,

106 
	mO±_disÿrd_mode
,

107 
	mO±_nÜecov”y
,

108 
	mO±_¿tio
,

109 
	mO±_»sÿn_uuid_Œ“
,

110 
	mO±_sk_b®ªû
,

111 
	mO±_¥aû_ÿche
, 
	mO±_no_¥aû_ÿche
,

112 
	mO±_¥aû_ÿche_v”siÚ
,

113 
	mO±_ssd
, 
	mO±_nossd
,

114 
	mO±_ssd_¥»ad
, 
	mO±_nossd_¥»ad
,

115 
	mO±_subvŞ
,

116 
	mO±_subvŞ_em±y
,

117 
	mO±_subvŞid
,

118 
	mO±_th»ad_poŞ
,

119 
	mO±_Œ“log
, 
	mO±_nÙ»–og
,

120 
	mO±_u£r_subvŞ_rm_®lowed
,

123 
	mO±_»scue
,

124 
	mO±_u£backu´oÙ
,

125 
	mO±_nŞog»¶ay
,

126 
	mO±_ignÜebadroÙs
,

127 
	mO±_ignÜed©acsums
,

128 
	mO±_»scue_®l
,

131 
	mO±_»cov”y
,

132 
	mO±_šode_ÿche
, 
	mO±_nošode_ÿche
,

135 
	mO±_check_š‹gr™y
,

136 
	mO±_check_š‹gr™y_šşudšg_ex‹Á_d©a
,

137 
	mO±_check_š‹gr™y_´št_mask
,

138 
	mO±_’o¥c_debug
, 
	mO±_nÛno¥c_debug
,

139 #ifdeà
CONFIG_BTRFS_DEBUG


140 
	mO±_äagm’t_d©a
, 
	mO±_äagm’t_m‘ad©a
, 
	mO±_äagm’t_®l
,

142 #ifdeà
CONFIG_BTRFS_FS_REF_VERIFY


143 
	mO±_»f_v”ify
,

145 
	mO±_”r
,

148 cÚ¡ 
m©ch_bË_t
 
	gtok’s
 = {

149 {
O±_aş
, "acl"},

150 {
O±_nßş
, "noacl"},

151 {
O±_ş—r_ÿche
, "clear_cache"},

152 {
O±_comm™_š‹rv®
, "commit=%u"},

153 {
O±_com´ess
, "compress"},

154 {
O±_com´ess_ty³
, "compress=%s"},

155 {
O±_com´ess_fÜû
, "compress-force"},

156 {
O±_com´ess_fÜû_ty³
, "compress-force=%s"},

157 {
O±_deg¿ded
, "degraded"},

158 {
O±_deviû
, "device=%s"},

159 {
O±_çl_”rÜs
, "fatal_errors=%s"},

160 {
O±_æushÚcomm™
, "flushoncommit"},

161 {
O±_noæushÚcomm™
, "noflushoncommit"},

162 {
O±_šode_ÿche
, "inode_cache"},

163 {
O±_nošode_ÿche
, "noinode_cache"},

164 {
O±_max_šlše
, "max_inline=%s"},

165 {
O±_b¬r›r
, "barrier"},

166 {
O±_nob¬r›r
, "nobarrier"},

167 {
O±_d©acow
, "datacow"},

168 {
O±_nod©acow
, "nodatacow"},

169 {
O±_d©asum
, "datasum"},

170 {
O±_nod©asum
, "nodatasum"},

171 {
O±_deäag
, "autodefrag"},

172 {
O±_nodeäag
, "noautodefrag"},

173 {
O±_disÿrd
, "discard"},

174 {
O±_disÿrd_mode
, "discard=%s"},

175 {
O±_nodisÿrd
, "nodiscard"},

176 {
O±_nÜecov”y
, "norecovery"},

177 {
O±_¿tio
, "metadata_ratio=%u"},

178 {
O±_»sÿn_uuid_Œ“
, "rescan_uuid_tree"},

179 {
O±_sk_b®ªû
, "skip_balance"},

180 {
O±_¥aû_ÿche
, "space_cache"},

181 {
O±_no_¥aû_ÿche
, "nospace_cache"},

182 {
O±_¥aû_ÿche_v”siÚ
, "space_cache=%s"},

183 {
O±_ssd
, "ssd"},

184 {
O±_nossd
, "nossd"},

185 {
O±_ssd_¥»ad
, "ssd_spread"},

186 {
O±_nossd_¥»ad
, "nossd_spread"},

187 {
O±_subvŞ
, "subvol=%s"},

188 {
O±_subvŞ_em±y
, "subvol="},

189 {
O±_subvŞid
, "subvolid=%s"},

190 {
O±_th»ad_poŞ
, "thread_pool=%u"},

191 {
O±_Œ“log
, "treelog"},

192 {
O±_nÙ»–og
, "notreelog"},

193 {
O±_u£r_subvŞ_rm_®lowed
, "user_subvol_rm_allowed"},

196 {
O±_»scue
, "rescue=%s"},

198 {
O±_nŞog»¶ay
, "nologreplay"},

200 {
O±_u£backu´oÙ
, "usebackuproot"},

203 {
O±_»cov”y
, "recovery"},

206 {
O±_check_š‹gr™y
, "check_int"},

207 {
O±_check_š‹gr™y_šşudšg_ex‹Á_d©a
, "check_int_data"},

208 {
O±_check_š‹gr™y_´št_mask
, "check_int_print_mask=%u"},

209 {
O±_’o¥c_debug
, "enospc_debug"},

210 {
O±_nÛno¥c_debug
, "noenospc_debug"},

211 #ifdeà
CONFIG_BTRFS_DEBUG


212 {
O±_äagm’t_d©a
, "fragment=data"},

213 {
O±_äagm’t_m‘ad©a
, "fragment=metadata"},

214 {
O±_äagm’t_®l
, "fragment=all"},

216 #ifdeà
CONFIG_BTRFS_FS_REF_VERIFY


217 {
O±_»f_v”ify
, "ref_verify"},

219 {
O±_”r
, 
NULL
},

222 cÚ¡ 
m©ch_bË_t
 
	g»scue_tok’s
 = {

223 {
O±_u£backu´oÙ
, "usebackuproot"},

224 {
O±_nŞog»¶ay
, "nologreplay"},

225 {
O±_ignÜebadroÙs
, "ignorebadroots"},

226 {
O±_ignÜebadroÙs
, "ibadroots"},

227 {
O±_ignÜed©acsums
, "ignoredatacsums"},

228 {
O±_ignÜed©acsums
, "idatacsums"},

229 {
O±_»scue_®l
, "all"},

230 {
O±_”r
, 
NULL
},

233 
boŞ
 
	$check_ro_İtiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
, 
İt
,

234 cÚ¡ *
İt_Çme
)

236 ià(
fs_šfo
->
mouÁ_İt
 & 
İt
) {

237 
	`bŒfs_”r
(
fs_šfo
, "%s must be used with„o mount option",

238 
İt_Çme
);

239  
Œue
;

241  
çl£
;

242 
	}
}

244 
	$·r£_»scue_İtiÚs
(
bŒfs_fs_šfo
 *
šfo
, cÚ¡ *
İtiÚs
)

246 *
İts
;

247 *
Üig
;

248 *
p
;

249 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

250 
»t
 = 0;

252 
İts
 = 
	`k¡rdup
(
İtiÚs
, 
GFP_KERNEL
);

253 ià(!
İts
)

254  -
ENOMEM
;

255 
Üig
 = 
İts
;

257 (
p
 = 
	`¡r£p
(&
İts
, ":")è!ğ
NULL
) {

258 
tok’
;

260 ià(!*
p
)

262 
tok’
 = 
	`m©ch_tok’
(
p
, 
»scue_tok’s
, 
¬gs
);

263 
tok’
){

264 
O±_u£backu´oÙ
:

265 
	`bŒfs_šfo
(
šfo
,

267 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
USEBACKUPROOT
);

269 
O±_nŞog»¶ay
:

270 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
NOLOGREPLAY
,

273 
O±_ignÜebadroÙs
:

274 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
IGNOREBADROOTS
,

277 
O±_ignÜed©acsums
:

278 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
IGNOREDATACSUMS
,

281 
O±_»scue_®l
:

282 
	`bŒfs_šfo
(
šfo
, "enabling‡ll ofhe„escue options");

283 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
IGNOREDATACSUMS
,

285 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
IGNOREBADROOTS
,

287 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
NOLOGREPLAY
,

290 
O±_”r
:

291 
	`bŒfs_šfo
(
šfo
, "uÄecognized„escuİtiÚ '%s'", 
p
);

292 
»t
 = -
EINVAL
;

293 
out
;

299 
out
:

300 
	`kä“
(
Üig
);

301  
»t
;

302 
	}
}

309 
	$bŒfs_·r£_İtiÚs
(
bŒfs_fs_šfo
 *
šfo
, *
İtiÚs
,

310 
Ãw_æags
)

312 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

313 *
p
, *
num
;

314 
šrg
;

315 
»t
 = 0;

316 *
com´ess_ty³
;

317 
boŞ
 
com´ess_fÜû
 = 
çl£
;

318 
bŒfs_com´essiÚ_ty³
 
§ved_com´ess_ty³
;

319 
§ved_com´ess_Ëv–
;

320 
boŞ
 
§ved_com´ess_fÜû
;

321 
no_com´ess
 = 0;

322 cÚ¡ 
boŞ
 
»mouÁšg
 = 
	`‹¡_b™
(
BTRFS_FS_STATE_REMOUNTING
, &
šfo
->
fs_¡©e
);

324 ià(
	`bŒfs_fs_com·t_ro
(
šfo
, 
FREE_SPACE_TREE
))

325 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
FREE_SPACE_TREE
);

326 ià(
	`bŒfs_ä“_¥aû_ÿche_v1_aùive
(
šfo
)) {

327 ià(
	`bŒfs_is_zÚed
(
šfo
)) {

328 
	`bŒfs_šfo
(
šfo
,

330 
	`bŒfs_£t_su³r_ÿche_g’”©iÚ
(
šfo
->
su³r_cİy
, 0);

332 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
SPACE_CACHE
);

340 ià(!
İtiÚs
)

341 
check
;

343 (
p
 = 
	`¡r£p
(&
İtiÚs
, ",")è!ğ
NULL
) {

344 
tok’
;

345 ià(!*
p
)

348 
tok’
 = 
	`m©ch_tok’
(
p
, 
tok’s
, 
¬gs
);

349 
tok’
) {

350 
O±_deg¿ded
:

351 
	`bŒfs_šfo
(
šfo
, "allowing degraded mounts");

352 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
DEGRADED
);

354 
O±_subvŞ
:

355 
O±_subvŞ_em±y
:

356 
O±_subvŞid
:

357 
O±_deviû
:

363 
O±_nod©asum
:

364 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
NODATASUM
,

367 
O±_d©asum
:

368 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
NODATASUM
)) {

369 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
NODATACOW
))

370 
	`bŒfs_šfo
(
šfo
,

373 
	`bŒfs_šfo
(
šfo
, "setting datasum");

375 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
NODATACOW
);

376 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
NODATASUM
);

378 
O±_nod©acow
:

379 ià(!
	`bŒfs_‹¡_İt
(
šfo
, 
NODATACOW
)) {

380 ià(!
	`bŒfs_‹¡_İt
(
šfo
, 
COMPRESS
) ||

381 !
	`bŒfs_‹¡_İt
(
šfo
, 
FORCE_COMPRESS
)) {

382 
	`bŒfs_šfo
(
šfo
,

385 
	`bŒfs_šfo
(
šfo
, "setting‚odatacow");

388 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
COMPRESS
);

389 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
FORCE_COMPRESS
);

390 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
NODATACOW
);

391 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
NODATASUM
);

393 
O±_d©acow
:

394 
	`bŒfs_ş—r_ªd_šfo
(
šfo
, 
NODATACOW
,

397 
O±_com´ess_fÜû
:

398 
O±_com´ess_fÜû_ty³
:

399 
com´ess_fÜû
 = 
Œue
;

400 
çÎthrough
;

401 
O±_com´ess
:

402 
O±_com´ess_ty³
:

403 
§ved_com´ess_ty³
 = 
	`bŒfs_‹¡_İt
(
šfo
,

404 
COMPRESS
) ?

405 
šfo
->
com´ess_ty³
 : 
BTRFS_COMPRESS_NONE
;

406 
§ved_com´ess_fÜû
 =

407 
	`bŒfs_‹¡_İt
(
šfo
, 
FORCE_COMPRESS
);

408 
§ved_com´ess_Ëv–
 = 
šfo
->
com´ess_Ëv–
;

409 ià(
tok’
 =ğ
O±_com´ess
 ||

410 
tok’
 =ğ
O±_com´ess_fÜû
 ||

411 
	`¡ºcmp
(
¬gs
[0].
äom
, "zlib", 4) == 0) {

412 
com´ess_ty³
 = "zlib";

414 
šfo
->
com´ess_ty³
 = 
BTRFS_COMPRESS_ZLIB
;

415 
šfo
->
com´ess_Ëv–
 = 
BTRFS_ZLIB_DEFAULT_LEVEL
;

421 ià(
tok’
 !ğ
O±_com´ess
 &&

422 
tok’
 !ğ
O±_com´ess_fÜû
)

423 
šfo
->
com´ess_Ëv–
 =

424 
	`bŒfs_com´ess_¡r2Ëv–
(

425 
BTRFS_COMPRESS_ZLIB
,

426 
¬gs
[0].
äom
 + 4);

427 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
COMPRESS
);

428 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
NODATACOW
);

429 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
NODATASUM
);

430 
no_com´ess
 = 0;

431 } ià(
	`¡ºcmp
(
¬gs
[0].
äom
, "lzo", 3) == 0) {

432 
com´ess_ty³
 = "lzo";

433 
šfo
->
com´ess_ty³
 = 
BTRFS_COMPRESS_LZO
;

434 
šfo
->
com´ess_Ëv–
 = 0;

435 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
COMPRESS
);

436 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
NODATACOW
);

437 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
NODATASUM
);

438 
	`bŒfs_£t_fs_šcom·t
(
šfo
, 
COMPRESS_LZO
);

439 
no_com´ess
 = 0;

440 } ià(
	`¡ºcmp
(
¬gs
[0].
äom
, "zstd", 4) == 0) {

441 
com´ess_ty³
 = "zstd";

442 
šfo
->
com´ess_ty³
 = 
BTRFS_COMPRESS_ZSTD
;

443 
šfo
->
com´ess_Ëv–
 =

444 
	`bŒfs_com´ess_¡r2Ëv–
(

445 
BTRFS_COMPRESS_ZSTD
,

446 
¬gs
[0].
äom
 + 4);

447 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
COMPRESS
);

448 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
NODATACOW
);

449 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
NODATASUM
);

450 
	`bŒfs_£t_fs_šcom·t
(
šfo
, 
COMPRESS_ZSTD
);

451 
no_com´ess
 = 0;

452 } ià(
	`¡ºcmp
(
¬gs
[0].
äom
, "no", 2) == 0) {

453 
com´ess_ty³
 = "no";

454 
šfo
->
com´ess_Ëv–
 = 0;

455 
šfo
->
com´ess_ty³
 = 0;

456 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
COMPRESS
);

457 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
FORCE_COMPRESS
);

458 
com´ess_fÜû
 = 
çl£
;

459 
no_com´ess
++;

461 
	`bŒfs_”r
(
šfo
, "unrecognized compression value %s",

462 
¬gs
[0].
äom
);

463 
»t
 = -
EINVAL
;

464 
out
;

467 ià(
com´ess_fÜû
) {

468 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
FORCE_COMPRESS
);

476 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
FORCE_COMPRESS
);

478 ià(
no_com´ess
 == 1) {

479 
	`bŒfs_šfo
(
šfo
, "use‚o compression");

480 } ià((
šfo
->
com´ess_ty³
 !ğ
§ved_com´ess_ty³
) ||

481 (
com´ess_fÜû
 !ğ
§ved_com´ess_fÜû
) ||

482 (
šfo
->
com´ess_Ëv–
 !ğ
§ved_com´ess_Ëv–
)) {

483 
	`bŒfs_šfo
(
šfo
, "%s %s compression,†evel %d",

484 (
com´ess_fÜû
) ? "force" : "use",

485 
com´ess_ty³
, 
šfo
->
com´ess_Ëv–
);

487 
com´ess_fÜû
 = 
çl£
;

489 
O±_ssd
:

490 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
SSD
,

492 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
NOSSD
);

494 
O±_ssd_¥»ad
:

495 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
SSD
,

497 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
SSD_SPREAD
,

499 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
NOSSD
);

501 
O±_nossd
:

502 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
NOSSD
);

503 
	`bŒfs_ş—r_ªd_šfo
(
šfo
, 
SSD
,

505 
çÎthrough
;

506 
O±_nossd_¥»ad
:

507 
	`bŒfs_ş—r_ªd_šfo
(
šfo
, 
SSD_SPREAD
,

510 
O±_b¬r›r
:

511 
	`bŒfs_ş—r_ªd_šfo
(
šfo
, 
NOBARRIER
,

514 
O±_nob¬r›r
:

515 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
NOBARRIER
,

518 
O±_th»ad_poŞ
:

519 
»t
 = 
	`m©ch_št
(&
¬gs
[0], &
šrg
);

520 ià(
»t
) {

521 
	`bŒfs_”r
(
šfo
, "unrecognizedhread_pool value %s",

522 
¬gs
[0].
äom
);

523 
out
;

524 } ià(
šrg
 == 0) {

525 
	`bŒfs_”r
(
šfo
, "invalid value 0 forhread_pool");

526 
»t
 = -
EINVAL
;

527 
out
;

529 
šfo
->
th»ad_poŞ_size
 = 
šrg
;

531 
O±_max_šlše
:

532 
num
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

533 ià(
num
) {

534 
šfo
->
max_šlše
 = 
	`mem·r£
(
num
, 
NULL
);

535 
	`kä“
(
num
);

537 ià(
šfo
->
max_šlše
) {

538 
šfo
->
max_šlše
 = 
	`mš_t
(
u64
,

539 
šfo
->
max_šlše
,

540 
šfo
->
£ùÜsize
);

542 
	`bŒfs_šfo
(
šfo
, "max_inline‡t %llu",

543 
šfo
->
max_šlše
);

545 
»t
 = -
ENOMEM
;

546 
out
;

549 
O±_aş
:

550 #ifdeà
CONFIG_BTRFS_FS_POSIX_ACL


551 
šfo
->
sb
->
s_æags
 |ğ
SB_POSIXACL
;

554 
	`bŒfs_”r
(
šfo
, "support for ACL‚ot compiled in!");

555 
»t
 = -
EINVAL
;

556 
out
;

558 
O±_nßş
:

559 
šfo
->
sb
->
s_æags
 &ğ~
SB_POSIXACL
;

561 
O±_nÙ»–og
:

562 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
NOTREELOG
,

565 
O±_Œ“log
:

566 
	`bŒfs_ş—r_ªd_šfo
(
šfo
, 
NOTREELOG
,

569 
O±_nÜecov”y
:

570 
O±_nŞog»¶ay
:

571 
	`bŒfs_w¬n
(
šfo
,

573 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
NOLOGREPLAY
,

576 
O±_æushÚcomm™
:

577 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
FLUSHONCOMMIT
,

580 
O±_noæushÚcomm™
:

581 
	`bŒfs_ş—r_ªd_šfo
(
šfo
, 
FLUSHONCOMMIT
,

584 
O±_¿tio
:

585 
»t
 = 
	`m©ch_št
(&
¬gs
[0], &
šrg
);

586 ià(
»t
) {

587 
	`bŒfs_”r
(
šfo
, "unrecognized metadata_ratio value %s",

588 
¬gs
[0].
äom
);

589 
out
;

591 
šfo
->
m‘ad©a_¿tio
 = 
šrg
;

592 
	`bŒfs_šfo
(
šfo
, "metadata„atio %u",

593 
šfo
->
m‘ad©a_¿tio
);

595 
O±_disÿrd
:

596 
O±_disÿrd_mode
:

597 ià(
tok’
 =ğ
O±_disÿrd
 ||

598 
	`¡rcmp
(
¬gs
[0].
äom
, "sync") == 0) {

599 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
DISCARD_ASYNC
);

600 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
DISCARD_SYNC
,

602 } ià(
	`¡rcmp
(
¬gs
[0].
äom
, "async") == 0) {

603 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
DISCARD_SYNC
);

604 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
DISCARD_ASYNC
,

607 
	`bŒfs_”r
(
šfo
, "unrecognized discard mode value %s",

608 
¬gs
[0].
äom
);

609 
»t
 = -
EINVAL
;

610 
out
;

612 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
NODISCARD
);

614 
O±_nodisÿrd
:

615 
	`bŒfs_ş—r_ªd_šfo
(
šfo
, 
DISCARD_SYNC
,

617 
	`bŒfs_ş—r_ªd_šfo
(
šfo
, 
DISCARD_ASYNC
,

619 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
NODISCARD
);

621 
O±_¥aû_ÿche
:

622 
O±_¥aû_ÿche_v”siÚ
:

629 ià(
	`bŒfs_fs_šcom·t
(
šfo
, 
EXTENT_TREE_V2
))

631 ià(
tok’
 =ğ
O±_¥aû_ÿche
 ||

632 
	`¡rcmp
(
¬gs
[0].
äom
, "v1") == 0) {

633 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
,

634 
FREE_SPACE_TREE
);

635 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
SPACE_CACHE
,

637 } ià(
	`¡rcmp
(
¬gs
[0].
äom
, "v2") == 0) {

638 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
,

639 
SPACE_CACHE
);

640 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
FREE_SPACE_TREE
,

643 
	`bŒfs_”r
(
šfo
, "unrecognized space_cache value %s",

644 
¬gs
[0].
äom
);

645 
»t
 = -
EINVAL
;

646 
out
;

649 
O±_»sÿn_uuid_Œ“
:

650 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
RESCAN_UUID_TREE
);

652 
O±_no_¥aû_ÿche
:

657 ià(
	`bŒfs_fs_šcom·t
(
šfo
, 
EXTENT_TREE_V2
))

659 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
SPACE_CACHE
)) {

660 
	`bŒfs_ş—r_ªd_šfo
(
šfo
, 
SPACE_CACHE
,

663 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
FREE_SPACE_TREE
)) {

664 
	`bŒfs_ş—r_ªd_šfo
(
šfo
, 
FREE_SPACE_TREE
,

668 
O±_šode_ÿche
:

669 
O±_nošode_ÿche
:

670 
	`bŒfs_w¬n
(
šfo
,

673 
O±_ş—r_ÿche
:

678 ià(
	`bŒfs_fs_šcom·t
(
šfo
, 
EXTENT_TREE_V2
))

680 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
CLEAR_CACHE
,

683 
O±_u£r_subvŞ_rm_®lowed
:

684 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
USER_SUBVOL_RM_ALLOWED
);

686 
O±_’o¥c_debug
:

687 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
ENOSPC_DEBUG
);

689 
O±_nÛno¥c_debug
:

690 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
, 
ENOSPC_DEBUG
);

692 
O±_deäag
:

693 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
AUTO_DEFRAG
,

696 
O±_nodeäag
:

697 
	`bŒfs_ş—r_ªd_šfo
(
šfo
, 
AUTO_DEFRAG
,

700 
O±_»cov”y
:

701 
O±_u£backu´oÙ
:

702 
	`bŒfs_w¬n
(
šfo
,

704 
tok’
 =ğ
O±_»cov”y
 ? "recovery" :

706 
	`bŒfs_šfo
(
šfo
,

708 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
USEBACKUPROOT
);

710 
O±_sk_b®ªû
:

711 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
SKIP_BALANCE
);

713 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


714 
O±_check_š‹gr™y_šşudšg_ex‹Á_d©a
:

715 
	`bŒfs_w¬n
(
šfo
,

717 
	`bŒfs_šfo
(
šfo
,

719 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
CHECK_INTEGRITY_DATA
);

720 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
CHECK_INTEGRITY
);

722 
O±_check_š‹gr™y
:

723 
	`bŒfs_w¬n
(
šfo
,

725 
	`bŒfs_šfo
(
šfo
, "enabling check integrity");

726 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
CHECK_INTEGRITY
);

728 
O±_check_š‹gr™y_´št_mask
:

729 
»t
 = 
	`m©ch_št
(&
¬gs
[0], &
šrg
);

730 ià(
»t
) {

731 
	`bŒfs_”r
(
šfo
,

733 
¬gs
[0].
äom
);

734 
out
;

736 
šfo
->
check_š‹gr™y_´št_mask
 = 
šrg
;

737 
	`bŒfs_w¬n
(
šfo
,

739 
	`bŒfs_šfo
(
šfo
, "check_integrity_print_mask 0x%x",

740 
šfo
->
check_š‹gr™y_´št_mask
);

743 
O±_check_š‹gr™y_šşudšg_ex‹Á_d©a
:

744 
O±_check_š‹gr™y
:

745 
O±_check_š‹gr™y_´št_mask
:

746 
	`bŒfs_”r
(
šfo
,

748 
»t
 = -
EINVAL
;

749 
out
;

751 
O±_çl_”rÜs
:

752 ià(
	`¡rcmp
(
¬gs
[0].
äom
, "panic") == 0) {

753 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
,

754 
PANIC_ON_FATAL_ERROR
);

755 } ià(
	`¡rcmp
(
¬gs
[0].
äom
, "bug") == 0) {

756 
	`bŒfs_ş—r_İt
(
šfo
->
mouÁ_İt
,

757 
PANIC_ON_FATAL_ERROR
);

759 
	`bŒfs_”r
(
šfo
, "unrecognized fatal_errors value %s",

760 
¬gs
[0].
äom
);

761 
»t
 = -
EINVAL
;

762 
out
;

765 
O±_comm™_š‹rv®
:

766 
šrg
 = 0;

767 
»t
 = 
	`m©ch_št
(&
¬gs
[0], &
šrg
);

768 ià(
»t
) {

769 
	`bŒfs_”r
(
šfo
, "unrecognized commit_interval value %s",

770 
¬gs
[0].
äom
);

771 
»t
 = -
EINVAL
;

772 
out
;

774 ià(
šrg
 == 0) {

775 
	`bŒfs_šfo
(
šfo
,

777 
BTRFS_DEFAULT_COMMIT_INTERVAL
);

778 
šrg
 = 
BTRFS_DEFAULT_COMMIT_INTERVAL
;

779 } ià(
šrg
 > 300) {

780 
	`bŒfs_w¬n
(
šfo
, "excessive commit interval %d",

781 
šrg
);

783 
šfo
->
comm™_š‹rv®
 = 
šrg
;

785 
O±_»scue
:

786 
»t
 = 
	`·r£_»scue_İtiÚs
(
šfo
, 
¬gs
[0].
äom
);

787 ià(
»t
 < 0) {

788 
	`bŒfs_”r
(
šfo
, "unrecognized„escue value %s",

789 
¬gs
[0].
äom
);

790 
out
;

793 #ifdeà
CONFIG_BTRFS_DEBUG


794 
O±_äagm’t_®l
:

795 
	`bŒfs_šfo
(
šfo
, "fragmenting‡ll space");

796 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
FRAGMENT_DATA
);

797 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
FRAGMENT_METADATA
);

799 
O±_äagm’t_m‘ad©a
:

800 
	`bŒfs_šfo
(
šfo
, "fragmenting metadata");

801 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
,

802 
FRAGMENT_METADATA
);

804 
O±_äagm’t_d©a
:

805 
	`bŒfs_šfo
(
šfo
, "fragmenting data");

806 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
FRAGMENT_DATA
);

809 #ifdeà
CONFIG_BTRFS_FS_REF_VERIFY


810 
O±_»f_v”ify
:

811 
	`bŒfs_šfo
(
šfo
, "doing„ef verification");

812 
	`bŒfs_£t_İt
(
šfo
->
mouÁ_İt
, 
REF_VERIFY
);

815 
O±_”r
:

816 
	`bŒfs_”r
(
šfo
, "uÄecognized mouÁ o±iÚ '%s'", 
p
);

817 
»t
 = -
EINVAL
;

818 
out
;

823 
check
:

825 ià(
Ãw_æags
 & 
SB_RDONLY
)

826 
out
;

828 ià(
	`check_ro_İtiÚ
(
šfo
, 
BTRFS_MOUNT_NOLOGREPLAY
, "nologreplay") ||

829 
	`check_ro_İtiÚ
(
šfo
, 
BTRFS_MOUNT_IGNOREBADROOTS
, "ignorebadroots") ||

830 
	`check_ro_İtiÚ
(
šfo
, 
BTRFS_MOUNT_IGNOREDATACSUMS
, "ignoredatacsums"))

831 
»t
 = -
EINVAL
;

832 
out
:

833 ià(
	`bŒfs_fs_com·t_ro
(
šfo
, 
FREE_SPACE_TREE
) &&

834 !
	`bŒfs_‹¡_İt
(
šfo
, 
FREE_SPACE_TREE
) &&

835 !
	`bŒfs_‹¡_İt
(
šfo
, 
CLEAR_CACHE
)) {

836 
	`bŒfs_”r
(
šfo
, "cannot disable free spaceree");

837 
»t
 = -
EINVAL
;

839 ià(
	`bŒfs_fs_com·t_ro
(
šfo
, 
BLOCK_GROUP_TREE
) &&

840 !
	`bŒfs_‹¡_İt
(
šfo
, 
FREE_SPACE_TREE
)) {

841 
	`bŒfs_”r
(
šfo
, "cannot disable free spaceree with block-group-tree feature");

842 
»t
 = -
EINVAL
;

844 ià(!
»t
)

845 
»t
 = 
	`bŒfs_check_mouÁİts_zÚed
(
šfo
);

846 ià(!
»t
 && !
»mouÁšg
) {

847 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
SPACE_CACHE
))

848 
	`bŒfs_šfo
(
šfo
, "disk space caching isƒnabled");

849 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
FREE_SPACE_TREE
))

850 
	`bŒfs_šfo
(
šfo
, "using free spaceree");

852  
»t
;

853 
	}
}

861 
	$bŒfs_·r£_deviû_İtiÚs
(cÚ¡ *
İtiÚs
, 
blk_mode_t
 
æags
)

863 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

864 *
deviû_Çme
, *
İts
, *
Üig
, *
p
;

865 
bŒfs_deviû
 *
deviû
 = 
NULL
;

866 
”rÜ
 = 0;

868 
	`lockd•_as£¹_h–d
(&
uuid_mu‹x
);

870 ià(!
İtiÚs
)

877 
İts
 = 
	`k¡rdup
(
İtiÚs
, 
GFP_KERNEL
);

878 ià(!
İts
)

879  -
ENOMEM
;

880 
Üig
 = 
İts
;

882 (
p
 = 
	`¡r£p
(&
İts
, ",")è!ğ
NULL
) {

883 
tok’
;

885 ià(!*
p
)

888 
tok’
 = 
	`m©ch_tok’
(
p
, 
tok’s
, 
¬gs
);

889 ià(
tok’
 =ğ
O±_deviû
) {

890 
deviû_Çme
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

891 ià(!
deviû_Çme
) {

892 
”rÜ
 = -
ENOMEM
;

893 
out
;

895 
deviû
 = 
	`bŒfs_sÿn_Úe_deviû
(
deviû_Çme
, 
æags
);

896 
	`kä“
(
deviû_Çme
);

897 ià(
	`IS_ERR
(
deviû
)) {

898 
”rÜ
 = 
	`PTR_ERR
(
deviû
);

899 
out
;

904 
out
:

905 
	`kä“
(
Üig
);

906  
”rÜ
;

907 
	}
}

914 
	$bŒfs_·r£_subvŞ_İtiÚs
(cÚ¡ *
İtiÚs
, **
subvŞ_Çme
,

915 
u64
 *
subvŞ_objeùid
)

917 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

918 *
İts
, *
Üig
, *
p
;

919 
”rÜ
 = 0;

920 
u64
 
subvŞid
;

922 ià(!
İtiÚs
)

929 
İts
 = 
	`k¡rdup
(
İtiÚs
, 
GFP_KERNEL
);

930 ià(!
İts
)

931  -
ENOMEM
;

932 
Üig
 = 
İts
;

934 (
p
 = 
	`¡r£p
(&
İts
, ",")è!ğ
NULL
) {

935 
tok’
;

936 ià(!*
p
)

939 
tok’
 = 
	`m©ch_tok’
(
p
, 
tok’s
, 
¬gs
);

940 
tok’
) {

941 
O±_subvŞ
:

942 
	`kä“
(*
subvŞ_Çme
);

943 *
subvŞ_Çme
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

944 ià(!*
subvŞ_Çme
) {

945 
”rÜ
 = -
ENOMEM
;

946 
out
;

949 
O±_subvŞid
:

950 
”rÜ
 = 
	`m©ch_u64
(&
¬gs
[0], &
subvŞid
);

951 ià(
”rÜ
)

952 
out
;

955 ià(
subvŞid
 == 0)

956 
subvŞid
 = 
BTRFS_FS_TREE_OBJECTID
;

958 *
subvŞ_objeùid
 = 
subvŞid
;

965 
out
:

966 
	`kä“
(
Üig
);

967  
”rÜ
;

968 
	}
}

970 *
	$bŒfs_g‘_subvŞ_Çme_äom_objeùid
(
bŒfs_fs_šfo
 *
fs_šfo
,

971 
u64
 
subvŞ_objeùid
)

973 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

974 
bŒfs_roÙ
 *
fs_roÙ
 = 
NULL
;

975 
bŒfs_roÙ_»f
 *
roÙ_»f
;

976 
bŒfs_šode_»f
 *
šode_»f
;

977 
bŒfs_key
 
key
;

978 
bŒfs_·th
 *
·th
 = 
NULL
;

979 *
Çme
 = 
NULL
, *
±r
;

980 
u64
 
dœid
;

981 
Ën
;

982 
»t
;

984 
·th
 = 
	`bŒfs_®loc_·th
();

985 ià(!
·th
) {

986 
»t
 = -
ENOMEM
;

987 
”r
;

990 
Çme
 = 
	`km®loc
(
PATH_MAX
, 
GFP_KERNEL
);

991 ià(!
Çme
) {

992 
»t
 = -
ENOMEM
;

993 
”r
;

995 
±r
 = 
Çme
 + 
PATH_MAX
 - 1;

996 
±r
[0] = '\0';

1002 
subvŞ_objeùid
 !ğ
BTRFS_FS_TREE_OBJECTID
) {

1003 
key
.
objeùid
 = 
subvŞ_objeùid
;

1004 
key
.
ty³
 = 
BTRFS_ROOT_BACKREF_KEY
;

1005 
key
.
off£t
 = (
u64
)-1;

1007 
»t
 = 
	`bŒfs_£¬ch_backw¬ds
(
roÙ
, &
key
, 
·th
);

1008 ià(
»t
 < 0) {

1009 
”r
;

1010 } ià(
»t
 > 0) {

1011 
»t
 = -
ENOENT
;

1012 
”r
;

1015 
subvŞ_objeùid
 = 
key
.
off£t
;

1017 
roÙ_»f
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

1018 
bŒfs_roÙ_»f
);

1019 
Ën
 = 
	`bŒfs_roÙ_»f_Çme_Ën
(
·th
->
nodes
[0], 
roÙ_»f
);

1020 
±r
 -ğ
Ën
 + 1;

1021 ià(
±r
 < 
Çme
) {

1022 
»t
 = -
ENAMETOOLONG
;

1023 
”r
;

1025 
	`»ad_ex‹Á_bufãr
(
·th
->
nodes
[0], 
±r
 + 1,

1026 ()(
roÙ_»f
 + 1), 
Ën
);

1027 
±r
[0] = '/';

1028 
dœid
 = 
	`bŒfs_roÙ_»f_dœid
(
·th
->
nodes
[0], 
roÙ_»f
);

1029 
	`bŒfs_»Ëa£_·th
(
·th
);

1031 
fs_roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
subvŞ_objeùid
, 
Œue
);

1032 ià(
	`IS_ERR
(
fs_roÙ
)) {

1033 
»t
 = 
	`PTR_ERR
(
fs_roÙ
);

1034 
fs_roÙ
 = 
NULL
;

1035 
”r
;

1042 
dœid
 !ğ
BTRFS_FIRST_FREE_OBJECTID
) {

1043 
key
.
objeùid
 = 
dœid
;

1044 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

1045 
key
.
off£t
 = (
u64
)-1;

1047 
»t
 = 
	`bŒfs_£¬ch_backw¬ds
(
fs_roÙ
, &
key
, 
·th
);

1048 ià(
»t
 < 0) {

1049 
”r
;

1050 } ià(
»t
 > 0) {

1051 
»t
 = -
ENOENT
;

1052 
”r
;

1055 
dœid
 = 
key
.
off£t
;

1057 
šode_»f
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],

1058 
·th
->
¦Ùs
[0],

1059 
bŒfs_šode_»f
);

1060 
Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
·th
->
nodes
[0],

1061 
šode_»f
);

1062 
±r
 -ğ
Ën
 + 1;

1063 ià(
±r
 < 
Çme
) {

1064 
»t
 = -
ENAMETOOLONG
;

1065 
”r
;

1067 
	`»ad_ex‹Á_bufãr
(
·th
->
nodes
[0], 
±r
 + 1,

1068 ()(
šode_»f
 + 1), 
Ën
);

1069 
±r
[0] = '/';

1070 
	`bŒfs_»Ëa£_·th
(
·th
);

1072 
	`bŒfs_put_roÙ
(
fs_roÙ
);

1073 
fs_roÙ
 = 
NULL
;

1076 
	`bŒfs_ä“_·th
(
·th
);

1077 ià(
±r
 =ğ
Çme
 + 
PATH_MAX
 - 1) {

1078 
Çme
[0] = '/';

1079 
Çme
[1] = '\0';

1081 
	`memmove
(
Çme
, 
±r
,‚am+ 
PATH_MAX
 -…tr);

1083  
Çme
;

1085 
”r
:

1086 
	`bŒfs_put_roÙ
(
fs_roÙ
);

1087 
	`bŒfs_ä“_·th
(
·th
);

1088 
	`kä“
(
Çme
);

1089  
	`ERR_PTR
(
»t
);

1090 
	}
}

1092 
	$g‘_deçuÉ_subvŞ_objeùid
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 *
objeùid
)

1094 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

1095 
bŒfs_dœ_™em
 *
di
;

1096 
bŒfs_·th
 *
·th
;

1097 
bŒfs_key
 
loÿtiÚ
;

1098 
fsüy±_¡r
 
Çme
 = 
	`FSTR_INIT
("default", 7);

1099 
u64
 
dœ_id
;

1101 
·th
 = 
	`bŒfs_®loc_·th
();

1102 ià(!
·th
)

1103  -
ENOMEM
;

1110 
dœ_id
 = 
	`bŒfs_su³r_roÙ_dœ
(
fs_šfo
->
su³r_cİy
);

1111 
di
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
roÙ
, 
·th
, 
dœ_id
, &
Çme
, 0);

1112 ià(
	`IS_ERR
(
di
)) {

1113 
	`bŒfs_ä“_·th
(
·th
);

1114  
	`PTR_ERR
(
di
);

1116 ià(!
di
) {

1122 
	`bŒfs_ä“_·th
(
·th
);

1123 *
objeùid
 = 
BTRFS_FS_TREE_OBJECTID
;

1127 
	`bŒfs_dœ_™em_key_to_ıu
(
·th
->
nodes
[0], 
di
, &
loÿtiÚ
);

1128 
	`bŒfs_ä“_·th
(
·th
);

1129 *
objeùid
 = 
loÿtiÚ
.objectid;

1131 
	}
}

1133 
	$bŒfs_fl_su³r
(
su³r_block
 *
sb
,

1134 
bŒfs_fs_deviûs
 *
fs_deviûs
,

1135 *
d©a
)

1137 
šode
 *inode;

1138 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

1139 
”r
;

1141 
sb
->
s_maxby‹s
 = 
MAX_LFS_FILESIZE
;

1142 
sb
->
s_magic
 = 
BTRFS_SUPER_MAGIC
;

1143 
sb
->
s_İ
 = &
bŒfs_su³r_İs
;

1144 
sb
->
s_d_İ
 = &
bŒfs_d’Œy_İ”©iÚs
;

1145 
sb
->
s_expÜt_İ
 = &
bŒfs_expÜt_İs
;

1146 #ifdeà
CONFIG_FS_VERITY


1147 
sb
->
s_vİ
 = &
bŒfs_v”™yİs
;

1149 
sb
->
s_x©Œ
 = 
bŒfs_x©Œ_hªdËrs
;

1150 
sb
->
s_time_g¿n
 = 1;

1151 #ifdeà
CONFIG_BTRFS_FS_POSIX_ACL


1152 
sb
->
s_æags
 |ğ
SB_POSIXACL
;

1154 
sb
->
s_æags
 |ğ
SB_I_VERSION
;

1155 
sb
->
s_iæags
 |ğ
SB_I_CGROUPWB
;

1157 
”r
 = 
	`su³r_£tup_bdi
(
sb
);

1158 ià(
”r
) {

1159 
	`bŒfs_”r
(
fs_šfo
, "super_setup_bdi failed");

1160  
”r
;

1163 
”r
 = 
	`İ’_ù»e
(
sb
, 
fs_deviûs
, (*)
d©a
);

1164 ià(
”r
) {

1165 
	`bŒfs_”r
(
fs_šfo
, "open_ctree failed");

1166  
”r
;

1169 
šode
 = 
	`bŒfs_ig‘
(
sb
, 
BTRFS_FIRST_FREE_OBJECTID
, 
fs_šfo
->
fs_roÙ
);

1170 ià(
	`IS_ERR
(
šode
)) {

1171 
”r
 = 
	`PTR_ERR
(
šode
);

1172 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
”r
, 
NULL
);

1173 
ç_şo£
;

1176 
sb
->
s_roÙ
 = 
	`d_make_roÙ
(
šode
);

1177 ià(!
sb
->
s_roÙ
) {

1178 
”r
 = -
ENOMEM
;

1179 
ç_şo£
;

1182 
sb
->
s_æags
 |ğ
SB_ACTIVE
;

1185 
ç_şo£
:

1186 
	`şo£_ù»e
(
fs_šfo
);

1187  
”r
;

1188 
	}
}

1191 
	$bŒfs_fl_su³r_·¹™iÚ
(
su³r_block
 *
sb
,

1192 
bŒfs_fs_deviûs
 *
fs_deviûs
,

1193 *
d©a
, 
·¹™iÚ_Üd”
)

1195 
šode
 *inode;

1196 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

1197 
”r
;

1199 
sb
->
s_maxby‹s
 = 
MAX_LFS_FILESIZE
;

1200 
sb
->
s_magic
 = 
BTRFS_SUPER_MAGIC
;

1201 
sb
->
s_İ
 = &
bŒfs_su³r_İs
;

1202 
sb
->
s_d_İ
 = &
bŒfs_d’Œy_İ”©iÚs
;

1203 
sb
->
s_expÜt_İ
 = &
bŒfs_expÜt_İs
;

1204 #ifdeà
CONFIG_FS_VERITY


1205 
sb
->
s_vİ
 = &
bŒfs_v”™yİs
;

1207 
sb
->
s_x©Œ
 = 
bŒfs_x©Œ_hªdËrs
;

1208 
sb
->
s_time_g¿n
 = 1;

1209 #ifdeà
CONFIG_BTRFS_FS_POSIX_ACL


1210 
sb
->
s_æags
 |ğ
SB_POSIXACL
;

1212 
sb
->
s_æags
 |ğ
SB_I_VERSION
;

1213 
sb
->
s_iæags
 |ğ
SB_I_CGROUPWB
;

1215 
”r
 = 
	`su³r_£tup_bdi
(
sb
);

1216 
backšg_dev_šfo
 *
bdi
 = 
sb
->
s_bdi
;

1224 ià(
”r
) {

1225 
	`bŒfs_”r
(
fs_šfo
, "super_setup_bdi failed");

1226  
”r
;

1229 
”r
 = 
	`İ’_ù»e_·¹™iÚ
(
sb
, 
fs_deviûs
, (*)
d©a
, 
·¹™iÚ_Üd”
);

1230 ià(
”r
) {

1231 
	`bŒfs_”r
(
fs_šfo
, "open_ctree failed");

1232  
”r
;

1235 
šode
 = 
	`bŒfs_ig‘
(
sb
, 
BTRFS_FIRST_FREE_OBJECTID
, 
fs_šfo
->
fs_roÙ
);

1236 ià(
	`IS_ERR
(
šode
)) {

1237 
”r
 = 
	`PTR_ERR
(
šode
);

1238 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
”r
, 
NULL
);

1239 
ç_şo£
;

1242 
sb
->
s_roÙ
 = 
	`d_make_roÙ
(
šode
);

1243 ià(!
sb
->
s_roÙ
) {

1244 
”r
 = -
ENOMEM
;

1245 
ç_şo£
;

1248 
sb
->
s_æags
 |ğ
SB_ACTIVE
;

1251 
ç_şo£
:

1252 
	`şo£_ù»e
(
fs_šfo
);

1253  
”r
;

1254 
	}
}

1256 
	$bŒfs_sync_fs
(
su³r_block
 *
sb
, 
wa™
)

1258 
bŒfs_Œªs_hªdË
 *
Œªs
;

1259 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

1260 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

1262 
	`Œaû_bŒfs_sync_fs
(
fs_šfo
, 
wa™
);

1264 ià(!
wa™
) {

1265 
	`fem­_æush
(
fs_šfo
->
bŒ“_šode
->
i_m­pšg
);

1269 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
U64_MAX
, 0, (
u64
)-1);

1271 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ_b¬r›r
(
roÙ
);

1272 ià(
	`IS_ERR
(
Œªs
)) {

1274 ià(
	`PTR_ERR
(
Œªs
è=ğ-
ENOENT
) {

1279 ià(!
	`‹¡_b™
(
BTRFS_FS_NEED_TRANS_COMMIT
,

1280 &
fs_šfo
->
æags
))

1288 ià(
	`sb_¡¬t_wr™e_Œylock
(
sb
))

1289 
	`sb_’d_wr™e
(
sb
);

1292 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

1294 ià(
	`IS_ERR
(
Œªs
))

1295  
	`PTR_ERR
(
Œªs
);

1297  
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1298 
	}
}

1300 
	$´št_»scue_İtiÚ
(
£q_fe
 *
£q
, cÚ¡ *
s
, 
boŞ
 *
´š‹d
)

1302 
	`£q_´štf
(
£q
, "%s%s", (*
´š‹d
è? ":" : ",»scue=", 
s
);

1303 *
´š‹d
 = 
Œue
;

1304 
	}
}

1306 
	$bŒfs_show_İtiÚs
(
£q_fe
 *
£q
, 
d’Œy
 *dentry)

1308 
bŒfs_fs_šfo
 *
šfo
 = 
	`bŒfs_sb
(
d’Œy
->
d_sb
);

1309 cÚ¡ *
com´ess_ty³
;

1310 cÚ¡ *
subvŞ_Çme
;

1311 
boŞ
 
´š‹d
 = 
çl£
;

1313 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
DEGRADED
))

1314 
	`£q_puts
(
£q
, ",degraded");

1315 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
NODATASUM
))

1316 
	`£q_puts
(
£q
, ",nodatasum");

1317 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
NODATACOW
))

1318 
	`£q_puts
(
£q
, ",nodatacow");

1319 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
NOBARRIER
))

1320 
	`£q_puts
(
£q
, ",nobarrier");

1321 ià(
šfo
->
max_šlše
 !ğ
BTRFS_DEFAULT_MAX_INLINE
)

1322 
	`£q_´štf
(
£q
, ",max_šlše=%Îu", 
šfo
->
max_šlše
);

1323 ià(
šfo
->
th»ad_poŞ_size
 !ğ
	`mš_t
(,

1324 
	`num_Úlše_ıus
() + 2, 8))

1325 
	`£q_´štf
(
£q
, ",th»ad_poŞ=%u", 
šfo
->
th»ad_poŞ_size
);

1326 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
COMPRESS
)) {

1327 
com´ess_ty³
 = 
	`bŒfs_com´ess_ty³2¡r
(
šfo
->compress_type);

1328 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
FORCE_COMPRESS
))

1329 
	`£q_´štf
(
£q
, ",com´ess-fÜû=%s", 
com´ess_ty³
);

1331 
	`£q_´štf
(
£q
, ",com´ess=%s", 
com´ess_ty³
);

1332 ià(
šfo
->
com´ess_Ëv–
)

1333 
	`£q_´štf
(
£q
, ":%d", 
šfo
->
com´ess_Ëv–
);

1335 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
NOSSD
))

1336 
	`£q_puts
(
£q
, ",nossd");

1337 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
SSD_SPREAD
))

1338 
	`£q_puts
(
£q
, ",ssd_spread");

1339 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
SSD
))

1340 
	`£q_puts
(
£q
, ",ssd");

1341 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
NOTREELOG
))

1342 
	`£q_puts
(
£q
, ",notreelog");

1343 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
NOLOGREPLAY
))

1344 
	`´št_»scue_İtiÚ
(
£q
, "nŞog»¶ay", &
´š‹d
);

1345 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
USEBACKUPROOT
))

1346 
	`´št_»scue_İtiÚ
(
£q
, "u£backu´oÙ", &
´š‹d
);

1347 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
IGNOREBADROOTS
))

1348 
	`´št_»scue_İtiÚ
(
£q
, "ignÜebadroÙs", &
´š‹d
);

1349 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
IGNOREDATACSUMS
))

1350 
	`´št_»scue_İtiÚ
(
£q
, "ignÜed©acsums", &
´š‹d
);

1351 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
FLUSHONCOMMIT
))

1352 
	`£q_puts
(
£q
, ",flushoncommit");

1353 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
DISCARD_SYNC
))

1354 
	`£q_puts
(
£q
, ",discard");

1355 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
DISCARD_ASYNC
))

1356 
	`£q_puts
(
£q
, ",discard=async");

1357 ià(!(
šfo
->
sb
->
s_æags
 & 
SB_POSIXACL
))

1358 
	`£q_puts
(
£q
, ",noacl");

1359 ià(
	`bŒfs_ä“_¥aû_ÿche_v1_aùive
(
šfo
))

1360 
	`£q_puts
(
£q
, ",space_cache");

1361 ià(
	`bŒfs_fs_com·t_ro
(
šfo
, 
FREE_SPACE_TREE
))

1362 
	`£q_puts
(
£q
, ",space_cache=v2");

1364 
	`£q_puts
(
£q
, ",nospace_cache");

1365 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
RESCAN_UUID_TREE
))

1366 
	`£q_puts
(
£q
, ",rescan_uuid_tree");

1367 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
CLEAR_CACHE
))

1368 
	`£q_puts
(
£q
, ",clear_cache");

1369 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
USER_SUBVOL_RM_ALLOWED
))

1370 
	`£q_puts
(
£q
, ",user_subvol_rm_allowed");

1371 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
ENOSPC_DEBUG
))

1372 
	`£q_puts
(
£q
, ",enospc_debug");

1373 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
AUTO_DEFRAG
))

1374 
	`£q_puts
(
£q
, ",autodefrag");

1375 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
SKIP_BALANCE
))

1376 
	`£q_puts
(
£q
, ",skip_balance");

1377 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


1378 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
CHECK_INTEGRITY_DATA
))

1379 
	`£q_puts
(
£q
, ",check_int_data");

1380 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
CHECK_INTEGRITY
))

1381 
	`£q_puts
(
£q
, ",check_int");

1382 ià(
šfo
->
check_š‹gr™y_´št_mask
)

1383 
	`£q_´štf
(
£q
, ",check_int_print_mask=%d",

1384 
šfo
->
check_š‹gr™y_´št_mask
);

1386 ià(
šfo
->
m‘ad©a_¿tio
)

1387 
	`£q_´štf
(
£q
, ",m‘ad©a_¿tio=%u", 
šfo
->
m‘ad©a_¿tio
);

1388 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
PANIC_ON_FATAL_ERROR
))

1389 
	`£q_puts
(
£q
, ",fatal_errors=panic");

1390 ià(
šfo
->
comm™_š‹rv®
 !ğ
BTRFS_DEFAULT_COMMIT_INTERVAL
)

1391 
	`£q_´štf
(
£q
, ",comm™=%u", 
šfo
->
comm™_š‹rv®
);

1392 #ifdeà
CONFIG_BTRFS_DEBUG


1393 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
FRAGMENT_DATA
))

1394 
	`£q_puts
(
£q
, ",fragment=data");

1395 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
FRAGMENT_METADATA
))

1396 
	`£q_puts
(
£q
, ",fragment=metadata");

1398 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
REF_VERIFY
))

1399 
	`£q_puts
(
£q
, ",ref_verify");

1400 
	`£q_´štf
(
£q
, ",subvolid=%llu",

1401 
	`BTRFS_I
(
	`d_šode
(
d’Œy
))->
roÙ
->
roÙ_key
.
objeùid
);

1402 
subvŞ_Çme
 = 
	`bŒfs_g‘_subvŞ_Çme_äom_objeùid
(
šfo
,

1403 
	`BTRFS_I
(
	`d_šode
(
d’Œy
))->
roÙ
->
roÙ_key
.
objeùid
);

1404 ià(!
	`IS_ERR
(
subvŞ_Çme
)) {

1405 
	`£q_puts
(
£q
, ",subvol=");

1406 
	`£q_esÿ³
(
£q
, 
subvŞ_Çme
, " \t\n\\");

1407 
	`kä“
(
subvŞ_Çme
);

1410 
	}
}

1412 
	$bŒfs_‹¡_su³r
(
su³r_block
 *
s
, *
d©a
)

1414 
bŒfs_fs_šfo
 *
p
 = 
d©a
;

1415 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
s
);

1417  
fs_šfo
->
fs_deviûs
 =ğ
p
->fs_devices;

1418 
	}
}

1420 
	$bŒfs_£t_su³r
(
su³r_block
 *
s
, *
d©a
)

1422 
”r
 = 
	`£t_ªÚ_su³r
(
s
, 
d©a
);

1423 ià(!
”r
)

1424 
s
->
s_fs_šfo
 = 
d©a
;

1425  
”r
;

1426 
	}
}

1431 
šlše
 
	$is_subvŞume_šode
(
šode
 *inode)

1433 ià(
šode
 && inode->
i_šo
 =ğ
BTRFS_FIRST_FREE_OBJECTID
)

1436 
	}
}

1438 
d’Œy
 *
	$mouÁ_subvŞ
(cÚ¡ *
subvŞ_Çme
, 
u64
 
subvŞ_objeùid
,

1439 
vfsmouÁ
 *
mÁ
)

1441 
d’Œy
 *
roÙ
;

1442 
»t
;

1444 ià(!
subvŞ_Çme
) {

1445 ià(!
subvŞ_objeùid
) {

1446 
»t
 = 
	`g‘_deçuÉ_subvŞ_objeùid
(
	`bŒfs_sb
(
mÁ
->
mÁ_sb
),

1447 &
subvŞ_objeùid
);

1448 ià(
»t
) {

1449 
roÙ
 = 
	`ERR_PTR
(
»t
);

1450 
out
;

1453 
subvŞ_Çme
 = 
	`bŒfs_g‘_subvŞ_Çme_äom_objeùid
(

1454 
	`bŒfs_sb
(
mÁ
->
mÁ_sb
), 
subvŞ_objeùid
);

1455 ià(
	`IS_ERR
(
subvŞ_Çme
)) {

1456 
roÙ
 = 
	`ERR_CAST
(
subvŞ_Çme
);

1457 
subvŞ_Çme
 = 
NULL
;

1458 
out
;

1463 
roÙ
 = 
	`mouÁ_subŒ“
(
mÁ
, 
subvŞ_Çme
);

1465 
mÁ
 = 
NULL
;

1467 ià(!
	`IS_ERR
(
roÙ
)) {

1468 
su³r_block
 *
s
 = 
roÙ
->
d_sb
;

1469 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
s
);

1470 
šode
 *
roÙ_šode
 = 
	`d_šode
(
roÙ
);

1471 
u64
 
roÙ_objeùid
 = 
	`BTRFS_I
(
roÙ_šode
)->
roÙ
->
roÙ_key
.
objeùid
;

1473 
»t
 = 0;

1474 ià(!
	`is_subvŞume_šode
(
roÙ_šode
)) {

1475 
	`bŒfs_”r
(
fs_šfo
, "'%s' is‚ot‡ valid subvolume",

1476 
subvŞ_Çme
);

1477 
»t
 = -
EINVAL
;

1479 ià(
subvŞ_objeùid
 && 
roÙ_objeùid
 != subvol_objectid) {

1485 
	`bŒfs_”r
(
fs_šfo
,

1487 
subvŞ_Çme
, 
subvŞ_objeùid
);

1488 
»t
 = -
EINVAL
;

1490 ià(
»t
) {

1491 
	`dput
(
roÙ
);

1492 
roÙ
 = 
	`ERR_PTR
(
»t
);

1493 
	`d—ùiv©e_locked_su³r
(
s
);

1497 
out
:

1498 
	`mÁput
(
mÁ
);

1499 
	`kä“
(
subvŞ_Çme
);

1500  
roÙ
;

1501 
	}
}

1503 
bŒfs_fs_šfo
 *
	gglob®_fs_šfo_li¡
[
BTRFS_SUPER_INFO_COUNT
];

1511 
d’Œy
 *
	$bŒfs_mouÁ_roÙ
(
fe_sy¡em_ty³
 *
fs_ty³
,

1512 
æags
, cÚ¡ *
deviû_Çme
, *
d©a
)

1515 
block_deviû
 *
bdev
 = 
NULL
;

1516 
su³r_block
 *
s
;

1517 
bŒfs_deviû
 *
deviû
 = 
NULL
;

1518 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
NULL
;

1519 
bŒfs_fs_šfo
 *
fs_šfo
 = 
NULL
;

1521 *
Ãw_£c_İts
 = 
NULL
;

1522 
blk_mode_t
 
mode
 = 
	`sb_İ’_mode
(
æags
);

1523 
”rÜ
 = 0;

1525 ià(
d©a
) {

1526 
”rÜ
 = 
	`£cur™y_sb_—t_lsm_İts
(
d©a
, &
Ãw_£c_İts
);

1527 ià(
”rÜ
)

1528  
	`ERR_PTR
(
”rÜ
);

1533 
·¹™iÚ_Üd”
 = 
BTRFS_SUPER_INFO_COUNT
-1;…artition_order >= 0;…artition_order--) {

1542 
glob®_fs_šfo_li¡
[
·¹™iÚ_Üd”
] = 
	`kvz®loc
((
bŒfs_fs_šfo
), 
GFP_KERNEL
);

1543 ià(!
glob®_fs_šfo_li¡
[
·¹™iÚ_Üd”
]) {

1544 
”rÜ
 = -
ENOMEM
;

1545 
”rÜ_£c_İts
;

1547 
glob®_fs_šfo_li¡
[
·¹™iÚ_Üd”
]->
id
 =…artition_order;

1549 
	`bŒfs_š™_fs_šfo
(
glob®_fs_šfo_li¡
[
·¹™iÚ_Üd”
]);

1551 
glob®_fs_šfo_li¡
[
·¹™iÚ_Üd”
]->
su³r_cİy
 = 
	`kz®loc
(
BTRFS_SUPER_INFO_SIZE
, 
GFP_KERNEL
);

1552 
glob®_fs_šfo_li¡
[
·¹™iÚ_Üd”
]->
su³r_fÜ_comm™
 = 
	`kz®loc
(
BTRFS_SUPER_INFO_SIZE
, 
GFP_KERNEL
);

1553 ià(!
glob®_fs_šfo_li¡
[
·¹™iÚ_Üd”
]->
su³r_cİy
 || !glob®_fs_šfo_li¡[·¹™iÚ_Üd”]->
su³r_fÜ_comm™
) {

1554 
”rÜ
 = -
ENOMEM
;

1555 
”rÜ_fs_šfo
;

1558 
	`mu‹x_lock
(&
uuid_mu‹x
);

1559 
”rÜ
 = 
	`bŒfs_·r£_deviû_İtiÚs
(
d©a
, 
mode
);

1560 ià(
”rÜ
) {

1561 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

1562 
”rÜ_fs_šfo
;

1565 
deviû
 = 
	`bŒfs_sÿn_Úe_deviû_·¹™iÚ
(
deviû_Çme
, 
mode
, 
·¹™iÚ_Üd”
);

1566 ià(
	`IS_ERR
(
deviû
)) {

1567 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

1568 
”rÜ
 = 
	`PTR_ERR
(
deviû
);

1569 
”rÜ_fs_šfo
;

1572 
fs_deviûs
 = 
deviû
->fs_devices;

1573 
glob®_fs_šfo_li¡
[
·¹™iÚ_Üd”
]->
fs_deviûs
 = fs_devices;

1575 
”rÜ
 = 
	`bŒfs_İ’_deviûs_·¹™iÚ
(
fs_deviûs
, 
mode
, 
fs_ty³
, 
·¹™iÚ_Üd”
);

1576 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

1577 ià(
”rÜ
)

1578 
”rÜ_fs_šfo
;

1580 ià(!(
æags
 & 
SB_RDONLY
è&& 
fs_deviûs
->
rw_deviûs
 == 0) {

1581 
”rÜ
 = -
EACCES
;

1582 
”rÜ_şo£_deviûs
;

1585 
bdev
 = 
fs_deviûs
->
Ï‹¡_dev
->bdev;

1586 
s
 = 
	`sg‘
(
fs_ty³
, 
bŒfs_‹¡_su³r
, 
bŒfs_£t_su³r
, 
æags
 | 
SB_NOSEC
,

1587 
glob®_fs_šfo_li¡
[
·¹™iÚ_Üd”
]);

1588 ià(
	`IS_ERR
(
s
)) {

1589 
”rÜ
 = 
	`PTR_ERR
(
s
);

1590 
”rÜ_şo£_deviûs
;

1592 ià(
s
->
s_roÙ
) {

1593 
	`bŒfs_şo£_deviûs
(
fs_deviûs
);

1594 
	`bŒfs_ä“_fs_šfo
(
glob®_fs_šfo_li¡
[
·¹™iÚ_Üd”
]);

1595 ià((
æags
 ^ 
s
->
s_æags
è& 
SB_RDONLY
)

1596 
”rÜ
 = -
EBUSY
;

1598 
	`¢´štf
(
s
->
s_id
, (s->s_id), "%pg", 
bdev
);

1599 
	`shršk”_debugfs_»Çme
(&
s
->
s_shršk
, "sb-%s:%s", 
fs_ty³
->
Çme
,

1600 
s
->
s_id
);

1601 
	`bŒfs_sb
(
s
)->
bdev_hŞd”
 = 
fs_ty³
;

1603 
”rÜ
 = 
	`bŒfs_fl_su³r_·¹™iÚ
(
s
, 
fs_deviûs
, 
d©a
, 
·¹™iÚ_Üd”
);

1605 ià(!
”rÜ
)

1606 
”rÜ
 = 
	`£cur™y_sb_£t_mÁ_İts
(
s
, 
Ãw_£c_İts
, 0, 
NULL
);

1607 
	`£cur™y_ä“_mÁ_İts
(&
Ãw_£c_İts
);

1608 ià(
”rÜ
) {

1609 
	`d—ùiv©e_locked_su³r
(
s
);

1610  
	`ERR_PTR
(
”rÜ
);

1615  
	`dg‘
(
s
->
s_roÙ
);

1617 
”rÜ_şo£_deviûs
:

1618 
	`bŒfs_şo£_deviûs
(
fs_deviûs
);

1619 
”rÜ_fs_šfo
:

1620 
	`bŒfs_ä“_fs_šfo
(
fs_šfo
);

1621 
”rÜ_£c_İts
:

1622 
	`£cur™y_ä“_mÁ_İts
(&
Ãw_£c_İts
);

1623  
	`ERR_PTR
(
”rÜ
);

1624 
	}
}

1648 
d’Œy
 *
	$bŒfs_mouÁ
(
fe_sy¡em_ty³
 *
fs_ty³
, 
æags
,

1649 cÚ¡ *
deviû_Çme
, *
d©a
)

1651 
vfsmouÁ
 *
mÁ_roÙ
;

1652 
d’Œy
 *
roÙ
;

1653 *
subvŞ_Çme
 = 
NULL
;

1654 
u64
 
subvŞ_objeùid
 = 0;

1655 
”rÜ
 = 0;

1657 
”rÜ
 = 
	`bŒfs_·r£_subvŞ_İtiÚs
(
d©a
, &
subvŞ_Çme
,

1658 &
subvŞ_objeùid
);

1659 ià(
”rÜ
) {

1660 
	`kä“
(
subvŞ_Çme
);

1661  
	`ERR_PTR
(
”rÜ
);

1665 
mÁ_roÙ
 = 
	`vfs_k”n_mouÁ
(&
bŒfs_roÙ_fs_ty³
, 
æags
, 
deviû_Çme
, 
d©a
);

1666 ià(
	`PTR_ERR_OR_ZERO
(
mÁ_roÙ
è=ğ-
EBUSY
) {

1667 ià(
æags
 & 
SB_RDONLY
) {

1668 
mÁ_roÙ
 = 
	`vfs_k”n_mouÁ
(&
bŒfs_roÙ_fs_ty³
,

1669 
æags
 & ~
SB_RDONLY
, 
deviû_Çme
, 
d©a
);

1671 
mÁ_roÙ
 = 
	`vfs_k”n_mouÁ
(&
bŒfs_roÙ_fs_ty³
,

1672 
æags
 | 
SB_RDONLY
, 
deviû_Çme
, 
d©a
);

1673 ià(
	`IS_ERR
(
mÁ_roÙ
)) {

1674 
roÙ
 = 
	`ERR_CAST
(
mÁ_roÙ
);

1675 
	`kä“
(
subvŞ_Çme
);

1676 
out
;

1679 
	`down_wr™e
(&
mÁ_roÙ
->
mÁ_sb
->
s_umouÁ
);

1680 
”rÜ
 = 
	`bŒfs_»mouÁ
(
mÁ_roÙ
->
mÁ_sb
, &
æags
, 
NULL
);

1681 
	`up_wr™e
(&
mÁ_roÙ
->
mÁ_sb
->
s_umouÁ
);

1682 ià(
”rÜ
 < 0) {

1683 
roÙ
 = 
	`ERR_PTR
(
”rÜ
);

1684 
	`mÁput
(
mÁ_roÙ
);

1685 
	`kä“
(
subvŞ_Çme
);

1686 
out
;

1690 ià(
	`IS_ERR
(
mÁ_roÙ
)) {

1691 
roÙ
 = 
	`ERR_CAST
(
mÁ_roÙ
);

1692 
	`kä“
(
subvŞ_Çme
);

1693 
out
;

1697 
roÙ
 = 
	`mouÁ_subvŞ
(
subvŞ_Çme
, 
subvŞ_objeùid
, 
mÁ_roÙ
);

1699 
out
:

1700  
roÙ
;

1701 
	}
}

1703 
	$bŒfs_»size_th»ad_poŞ
(
bŒfs_fs_šfo
 *
fs_šfo
,

1704 
u32
 
Ãw_poŞ_size
, u32 
Şd_poŞ_size
)

1706 ià(
Ãw_poŞ_size
 =ğ
Şd_poŞ_size
)

1709 
fs_šfo
->
th»ad_poŞ_size
 = 
Ãw_poŞ_size
;

1711 
	`bŒfs_šfo
(
fs_šfo
, "resizehread…ool %d -> %d",

1712 
Şd_poŞ_size
, 
Ãw_poŞ_size
);

1714 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
wÜk”s
, 
Ãw_poŞ_size
);

1715 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
d–®loc_wÜk”s
, 
Ãw_poŞ_size
);

1716 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
ÿchšg_wÜk”s
, 
Ãw_poŞ_size
);

1717 
	`wÜkqueue_£t_max_aùive
(
fs_šfo
->
’dio_wÜk”s
, 
Ãw_poŞ_size
);

1718 
	`wÜkqueue_£t_max_aùive
(
fs_šfo
->
’dio_m‘a_wÜk”s
, 
Ãw_poŞ_size
);

1719 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
’dio_wr™e_wÜk”s
, 
Ãw_poŞ_size
);

1720 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
’dio_ä“¥aû_wÜk”
, 
Ãw_poŞ_size
);

1721 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
d–ayed_wÜk”s
, 
Ãw_poŞ_size
);

1722 
	}
}

1724 
šlše
 
	$bŒfs_»mouÁ_begš
(
bŒfs_fs_šfo
 *
fs_šfo
,

1725 
Şd_İts
, 
æags
)

1727 ià(
	`bŒfs_¿w_‹¡_İt
(
Şd_İts
, 
AUTO_DEFRAG
) &&

1728 (!
	`bŒfs_¿w_‹¡_İt
(
fs_šfo
->
mouÁ_İt
, 
AUTO_DEFRAG
) ||

1729 (
æags
 & 
SB_RDONLY
))) {

1731 
	`wa™_ev’t
(
fs_šfo
->
Œª§ùiÚ_wa™
,

1732 (
	`©omic_»ad
(&
fs_šfo
->
deäag_ruÂšg
) == 0));

1733 ià(
æags
 & 
SB_RDONLY
)

1734 
	`sync_fesy¡em
(
fs_šfo
->
sb
);

1736 
	}
}

1738 
šlše
 
	$bŒfs_»mouÁ_ş—nup
(
bŒfs_fs_šfo
 *
fs_šfo
,

1739 
Şd_İts
)

1741 cÚ¡ 
boŞ
 
ÿche_İt
 = 
	`bŒfs_‹¡_İt
(
fs_šfo
, 
SPACE_CACHE
);

1747 ià(
	`bŒfs_¿w_‹¡_İt
(
Şd_İts
, 
AUTO_DEFRAG
) &&

1748 (!
	`bŒfs_¿w_‹¡_İt
(
fs_šfo
->
mouÁ_İt
, 
AUTO_DEFRAG
è|| 
	`sb_rdÚly
(fs_šfo->
sb
))) {

1749 
	`bŒfs_ş—nup_deäag_šodes
(
fs_šfo
);

1753 ià(!
	`bŒfs_¿w_‹¡_İt
(
Şd_İts
, 
DISCARD_ASYNC
) &&

1754 
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DISCARD_ASYNC
))

1755 
	`bŒfs_disÿrd_»sume
(
fs_šfo
);

1756 ià(
	`bŒfs_¿w_‹¡_İt
(
Şd_İts
, 
DISCARD_ASYNC
) &&

1757 !
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DISCARD_ASYNC
))

1758 
	`bŒfs_disÿrd_ş—nup
(
fs_šfo
);

1761 ià(
ÿche_İt
 !ğ
	`bŒfs_ä“_¥aû_ÿche_v1_aùive
(
fs_šfo
))

1762 
	`bŒfs_£t_ä“_¥aû_ÿche_v1_aùive
(
fs_šfo
, 
ÿche_İt
);

1763 
	}
}

1765 
	$bŒfs_»mouÁ
(
su³r_block
 *
sb
, *
æags
, *
d©a
)

1767 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

1768 
Şd_æags
 = 
sb
->
s_æags
;

1769 
Şd_İts
 = 
fs_šfo
->
mouÁ_İt
;

1770 
Şd_com´ess_ty³
 = 
fs_šfo
->
com´ess_ty³
;

1771 
u64
 
Şd_max_šlše
 = 
fs_šfo
->
max_šlše
;

1772 
u32
 
Şd_th»ad_poŞ_size
 = 
fs_šfo
->
th»ad_poŞ_size
;

1773 
u32
 
Şd_m‘ad©a_¿tio
 = 
fs_šfo
->
m‘ad©a_¿tio
;

1774 
»t
;

1776 
	`sync_fesy¡em
(
sb
);

1777 
	`£t_b™
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_šfo
->
fs_¡©e
);

1779 ià(
d©a
) {

1780 *
Ãw_£c_İts
 = 
NULL
;

1782 
»t
 = 
	`£cur™y_sb_—t_lsm_İts
(
d©a
, &
Ãw_£c_İts
);

1783 ià(!
»t
)

1784 
»t
 = 
	`£cur™y_sb_»mouÁ
(
sb
, 
Ãw_£c_İts
);

1785 
	`£cur™y_ä“_mÁ_İts
(&
Ãw_£c_İts
);

1786 ià(
»t
)

1787 
»¡Üe
;

1790 
»t
 = 
	`bŒfs_·r£_İtiÚs
(
fs_šfo
, 
d©a
, *
æags
);

1791 ià(
»t
)

1792 
»¡Üe
;

1794 
»t
 = 
	`bŒfs_check_ã©u»s
(
fs_šfo
, !(*
æags
 & 
SB_RDONLY
));

1795 ià(
»t
 < 0)

1796 
»¡Üe
;

1798 
	`bŒfs_»mouÁ_begš
(
fs_šfo
, 
Şd_İts
, *
æags
);

1799 
	`bŒfs_»size_th»ad_poŞ
(
fs_šfo
,

1800 
fs_šfo
->
th»ad_poŞ_size
, 
Şd_th»ad_poŞ_size
);

1802 ià((
boŞ
)
	`bŒfs_‹¡_İt
(
fs_šfo
, 
FREE_SPACE_TREE
) !=

1803 (
boŞ
)
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
) &&

1804 (!
	`sb_rdÚly
(
sb
è|| (*
æags
 & 
SB_RDONLY
))) {

1805 
	`bŒfs_w¬n
(
fs_šfo
,

1808 ià(
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
)) {

1809 
	`bŒfs_£t_İt
(
fs_šfo
->
mouÁ_İt
, 
FREE_SPACE_TREE
);

1810 
	`bŒfs_ş—r_İt
(
fs_šfo
->
mouÁ_İt
, 
SPACE_CACHE
);

1812 ià(
	`bŒfs_ä“_¥aû_ÿche_v1_aùive
(
fs_šfo
)) {

1813 
	`bŒfs_ş—r_İt
(
fs_šfo
->
mouÁ_İt
, 
FREE_SPACE_TREE
);

1814 
	`bŒfs_£t_İt
(
fs_šfo
->
mouÁ_İt
, 
SPACE_CACHE
);

1818 ià((
boŞ
)(*
æags
 & 
SB_RDONLY
è=ğ
	`sb_rdÚly
(
sb
))

1819 
out
;

1821 ià(*
æags
 & 
SB_RDONLY
) {

1826 
	`ÿnûl_wÜk_sync
(&
fs_šfo
->
async_»şaim_wÜk
);

1827 
	`ÿnûl_wÜk_sync
(&
fs_šfo
->
async_d©a_»şaim_wÜk
);

1829 
	`bŒfs_disÿrd_ş—nup
(
fs_šfo
);

1832 
	`down
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

1834 
	`up
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

1836 
	`bŒfs_£t_sb_rdÚly
(
sb
);

1845 
	`bŒfs_d–‘e_unu£d_bgs
(
fs_šfo
);

1858 
	`wa™_Ú_b™
(&
fs_šfo
->
æags
, 
BTRFS_FS_CLEANER_RUNNING
,

1859 
TASK_UNINTERRUPTIBLE
);

1869 
	`bŒfs_run_d–ayed_uts
(
fs_šfo
);

1871 
	`bŒfs_dev_»¶aû_su¥’d_fÜ_unmouÁ
(
fs_šfo
);

1872 
	`bŒfs_süub_ÿnûl
(
fs_šfo
);

1873 
	`bŒfs_·u£_b®ªû
(
fs_šfo
);

1881 
	`bŒfs_qgroup_wa™_fÜ_com¶‘iÚ
(
fs_šfo
, 
çl£
);

1883 
»t
 = 
	`bŒfs_comm™_su³r
(
fs_šfo
);

1884 ià(
»t
)

1885 
»¡Üe
;

1887 ià(
	`BTRFS_FS_ERROR
(
fs_šfo
)) {

1888 
	`bŒfs_”r
(
fs_šfo
,

1890 
»t
 = -
EINVAL
;

1891 
»¡Üe
;

1893 ià(
fs_šfo
->
fs_deviûs
->
rw_deviûs
 == 0) {

1894 
»t
 = -
EACCES
;

1895 
»¡Üe
;

1898 ià(!
	`bŒfs_check_rw_deg¿dabË
(
fs_šfo
, 
NULL
)) {

1899 
	`bŒfs_w¬n
(
fs_šfo
,

1901 
»t
 = -
EACCES
;

1902 
»¡Üe
;

1905 ià(
	`bŒfs_su³r_log_roÙ
(
fs_šfo
->
su³r_cİy
) != 0) {

1906 
	`bŒfs_w¬n
(
fs_šfo
,

1908 
»t
 = -
EINVAL
;

1909 
»¡Üe
;

1917 
»t
 = 
	`bŒfs_¡¬t_´e_rw_mouÁ
(
fs_šfo
);

1918 ià(
»t
)

1919 
»¡Üe
;

1921 
	`bŒfs_ş—r_sb_rdÚly
(
sb
);

1923 
	`£t_b™
(
BTRFS_FS_OPEN
, &
fs_šfo
->
æags
);

1929 
	`bŒfs_disÿrd_»sume
(
fs_šfo
);

1931 
out
:

1936 *
æags
 |ğ
SB_I_VERSION
;

1938 
	`wake_up_´oûss
(
fs_šfo
->
Œª§ùiÚ_kth»ad
);

1939 
	`bŒfs_»mouÁ_ş—nup
(
fs_šfo
, 
Şd_İts
);

1940 
	`bŒfs_ş—r_ÚeshÙ_İtiÚs
(
fs_šfo
);

1941 
	`ş—r_b™
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_šfo
->
fs_¡©e
);

1945 
»¡Üe
:

1947 ià(
	`sb_rdÚly
(
sb
))

1948 
Şd_æags
 |ğ
SB_RDONLY
;

1949 ià(!(
Şd_æags
 & 
SB_RDONLY
))

1950 
	`ş—r_b™
(
BTRFS_FS_STATE_RO
, &
fs_šfo
->
fs_¡©e
);

1951 
sb
->
s_æags
 = 
Şd_æags
;

1952 
fs_šfo
->
mouÁ_İt
 = 
Şd_İts
;

1953 
fs_šfo
->
com´ess_ty³
 = 
Şd_com´ess_ty³
;

1954 
fs_šfo
->
max_šlše
 = 
Şd_max_šlše
;

1955 
	`bŒfs_»size_th»ad_poŞ
(
fs_šfo
,

1956 
Şd_th»ad_poŞ_size
, 
fs_šfo
->
th»ad_poŞ_size
);

1957 
fs_šfo
->
m‘ad©a_¿tio
 = 
Şd_m‘ad©a_¿tio
;

1958 
	`bŒfs_»mouÁ_ş—nup
(
fs_šfo
, 
Şd_İts
);

1959 
	`ş—r_b™
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_šfo
->
fs_¡©e
);

1961  
»t
;

1962 
	}
}

1965 
	$bŒfs_cmp_deviû_ä“_by‹s
(cÚ¡ *
a
, cÚ¡ *
b
)

1967 cÚ¡ 
bŒfs_deviû_šfo
 *
dev_šfo1
 = 
a
;

1968 cÚ¡ 
bŒfs_deviû_šfo
 *
dev_šfo2
 = 
b
;

1970 ià(
dev_šfo1
->
max_ava
 > 
dev_šfo2
->max_avail)

1972 ià(
dev_šfo1
->
max_ava
 < 
dev_šfo2
->max_avail)

1975 
	}
}

1981 
šlše
 
	$bŒfs_desûndšg_sÜt_deviûs
(

1982 
bŒfs_deviû_šfo
 *
deviûs
,

1983 
size_t
 
Ä_deviûs
)

1985 
	`sÜt
(
deviûs
, 
Ä_deviûs
, (
bŒfs_deviû_šfo
),

1986 
bŒfs_cmp_deviû_ä“_by‹s
, 
NULL
);

1987 
	}
}

1993 
šlše
 
	$bŒfs_ÿlc_ava_d©a_¥aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

1994 
u64
 *
ä“_by‹s
)

1996 
bŒfs_deviû_šfo
 *
deviûs_šfo
;

1997 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

1998 
bŒfs_deviû
 *
deviû
;

1999 
u64
 
ty³
;

2000 
u64
 
ava_¥aû
;

2001 
u64
 
mš_¡re_size
;

2002 
num_¡res
 = 1;

2003 
i
 = 0, 
Ä_deviûs
;

2004 cÚ¡ 
bŒfs_¿id_©Œ
 *
¿‰r
;

2010 
Ä_deviûs
 = 
fs_šfo
->
fs_deviûs
->
İ’_deviûs
;

2011 ià(!
Ä_deviûs
) {

2012 
	`smp_mb
();

2013 
Ä_deviûs
 = 
fs_šfo
->
fs_deviûs
->
İ’_deviûs
;

2014 
	`ASSERT
(
Ä_deviûs
);

2015 ià(!
Ä_deviûs
) {

2016 *
ä“_by‹s
 = 0;

2021 
deviûs_šfo
 = 
	`km®loc_¬¿y
(
Ä_deviûs
, (*devices_info),

2022 
GFP_KERNEL
);

2023 ià(!
deviûs_šfo
)

2024  -
ENOMEM
;

2027 
ty³
 = 
	`bŒfs_d©a_®loc_´ofe
(
fs_šfo
);

2028 
¿‰r
 = &
bŒfs_¿id_¬¿y
[
	`bŒfs_bg_æags_to_¿id_šdex
(
ty³
)];

2030 ià(
ty³
 & 
BTRFS_BLOCK_GROUP_RAID0
)

2031 
num_¡res
 = 
Ä_deviûs
;

2032 ià(
ty³
 & 
BTRFS_BLOCK_GROUP_RAID1_MASK
)

2033 
num_¡res
 = 
¿‰r
->
ncİ›s
;

2034 ià(
ty³
 & 
BTRFS_BLOCK_GROUP_RAID10
)

2035 
num_¡res
 = 4;

2038 
mš_¡re_size
 = 
¿‰r
->
dev_¡res
 * 
BTRFS_STRIPE_LEN
;

2040 
	`rcu_»ad_lock
();

2041 
	`li¡_fÜ_—ch_’Œy_rcu
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

2042 ià(!
	`‹¡_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
,

2043 &
deviû
->
dev_¡©e
) ||

2044 !
deviû
->
bdev
 ||

2045 
	`‹¡_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
))

2048 ià(
i
 >ğ
Ä_deviûs
)

2051 
ava_¥aû
 = 
deviû
->
tÙ®_by‹s
 - deviû->
by‹s_u£d
;

2054 
ava_¥aû
 = 
	`rounddown
×va_¥aû, 
BTRFS_STRIPE_LEN
);

2060 ià(
ava_¥aû
 <ğ
BTRFS_DEVICE_RANGE_RESERVED
 + 
mš_¡re_size
)

2063 
ava_¥aû
 -ğ
BTRFS_DEVICE_RANGE_RESERVED
;

2065 
deviûs_šfo
[
i
].
dev
 = 
deviû
;

2066 
deviûs_šfo
[
i
].
max_ava
 = 
ava_¥aû
;

2068 
i
++;

2070 
	`rcu_»ad_uÆock
();

2072 
Ä_deviûs
 = 
i
;

2074 
	`bŒfs_desûndšg_sÜt_deviûs
(
deviûs_šfo
, 
Ä_deviûs
);

2076 
i
 = 
Ä_deviûs
 - 1;

2077 
ava_¥aû
 = 0;

2078 
Ä_deviûs
 >ğ
¿‰r
->
devs_mš
) {

2079 
num_¡res
 = 
	`mš
Òum_¡res, 
Ä_deviûs
);

2081 ià(
deviûs_šfo
[
i
].
max_ava
 >ğ
mš_¡re_size
) {

2082 
j
;

2083 
u64
 
®loc_size
;

2085 
ava_¥aû
 +ğ
deviûs_šfo
[
i
].
max_ava
 * 
num_¡res
;

2086 
®loc_size
 = 
deviûs_šfo
[
i
].
max_ava
;

2087 
j
 = 
i
 + 1 - 
num_¡res
; j <= i; j++)

2088 
deviûs_šfo
[
j
].
max_ava
 -ğ
®loc_size
;

2090 
i
--;

2091 
Ä_deviûs
--;

2094 
	`kä“
(
deviûs_šfo
);

2095 *
ä“_by‹s
 = 
ava_¥aû
;

2097 
	}
}

2112 
	$bŒfs_¡©fs
(
d’Œy
 *d’Œy, 
k¡©fs
 *
buf
)

2114 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
d’Œy
->
d_sb
);

2115 
bŒfs_su³r_block
 *
disk_su³r
 = 
fs_šfo
->
su³r_cİy
;

2116 
bŒfs_¥aû_šfo
 *
found
;

2117 
u64
 
tÙ®_u£d
 = 0;

2118 
u64
 
tÙ®_ä“_d©a
 = 0;

2119 
u64
 
tÙ®_ä“_m‘a
 = 0;

2120 
u32
 
b™s
 = 
fs_šfo
->
£ùÜsize_b™s
;

2121 
__be32
 *
fsid
 = (__be32 *)
fs_šfo
->
fs_deviûs
->fsid;

2122 
çùÜ
 = 1;

2123 
bŒfs_block_rsv
 *
block_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

2124 
»t
;

2125 
u64
 
th»sh
 = 0;

2126 
mixed
 = 0;

2128 
	`li¡_fÜ_—ch_’Œy
(
found
, &
fs_šfo
->
¥aû_šfo
, 
li¡
) {

2129 ià(
found
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
) {

2130 
i
;

2132 
tÙ®_ä“_d©a
 +ğ
found
->
disk_tÙ®
 - found->
disk_u£d
;

2133 
tÙ®_ä“_d©a
 -=

2134 
	`bŒfs_accouÁ_ro_block_groups_ä“_¥aû
(
found
);

2136 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; i++) {

2137 ià(!
	`li¡_em±y
(&
found
->
block_groups
[
i
]))

2138 
çùÜ
 = 
	`bŒfs_bg_ty³_to_çùÜ
(

2139 
bŒfs_¿id_¬¿y
[
i
].
bg_æag
);

2146 ià(!
mixed
 && 
found
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
) {

2147 ià(
found
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

2148 
mixed
 = 1;

2150 
tÙ®_ä“_m‘a
 +ğ
found
->
disk_tÙ®
 -

2151 
found
->
disk_u£d
;

2154 
tÙ®_u£d
 +ğ
found
->
disk_u£d
;

2157 
buf
->
f_blocks
 = 
	`div_u64
(
	`bŒfs_su³r_tÙ®_by‹s
(
disk_su³r
), 
çùÜ
);

2158 
buf
->
f_blocks
 >>ğ
b™s
;

2159 
buf
->
f_bä“
 = buf->
f_blocks
 - (
	`div_u64
(
tÙ®_u£d
, 
çùÜ
è>> 
b™s
);

2162 
	`¥š_lock
(&
block_rsv
->
lock
);

2164 ià(
buf
->
f_bä“
 >ğ
block_rsv
->
size
 >> 
b™s
)

2165 
buf
->
f_bä“
 -ğ
block_rsv
->
size
 >> 
b™s
;

2167 
buf
->
f_bä“
 = 0;

2168 
	`¥š_uÆock
(&
block_rsv
->
lock
);

2170 
buf
->
f_bava
 = 
	`div_u64
(
tÙ®_ä“_d©a
, 
çùÜ
);

2171 
»t
 = 
	`bŒfs_ÿlc_ava_d©a_¥aû
(
fs_šfo
, &
tÙ®_ä“_d©a
);

2172 ià(
»t
)

2173  
»t
;

2174 
buf
->
f_bava
 +ğ
	`div_u64
(
tÙ®_ä“_d©a
, 
çùÜ
);

2175 
buf
->
f_bava
 = buf->f_bava >> 
b™s
;

2190 
th»sh
 = 
SZ_4M
;

2199 ià(!
mixed
 && 
block_rsv
->
¥aû_šfo
->
fuÎ
 &&

2200 (
tÙ®_ä“_m‘a
 < 
th»sh
 ||Ù®_ä“_m‘¨-h»sh < 
block_rsv
->
size
))

2201 
buf
->
f_bava
 = 0;

2203 
buf
->
f_ty³
 = 
BTRFS_SUPER_MAGIC
;

2204 
buf
->
f_bsize
 = 
d’Œy
->
d_sb
->
s_blocksize
;

2205 
buf
->
f_Çm–’
 = 
BTRFS_NAME_LEN
;

2210 
buf
->
f_fsid
.
v®
[0] = 
	`be32_to_ıu
(
fsid
[0]) ^ be32_to_cpu(fsid[2]);

2211 
buf
->
f_fsid
.
v®
[1] = 
	`be32_to_ıu
(
fsid
[1]) ^ be32_to_cpu(fsid[3]);

2213 
buf
->
f_fsid
.
v®
[0] ^=

2214 
	`BTRFS_I
(
	`d_šode
(
d’Œy
))->
roÙ
->
roÙ_key
.
objeùid
 >> 32;

2215 
buf
->
f_fsid
.
v®
[1] ^=

2216 
	`BTRFS_I
(
	`d_šode
(
d’Œy
))->
roÙ
->
roÙ_key
.
objeùid
;

2219 
	}
}

2221 
kl_su³r_nÙify
(
su³r_block
 *
sb
);

2222 
put_su³r
(
su³r_block
 *
sb
);

2223 
	$bŒfs_put_fesy¡em
(
fe_sy¡em_ty³
 *
fs
)

2225 
	`moduË_put
(
fs
->
owÃr
);

2226 
	}
}

2228 
	$bŒfs_d—ùiv©e_locked_su³r
(
su³r_block
 *
s
)

2230 
fe_sy¡em_ty³
 *
fs
 = 
s
->
s_ty³
;

2231 ià(
	`©omic_dec_ªd_‹¡
(&
s
->
s_aùive
)) {

2232 
	`uÄegi¡”_shršk”
(&
s
->
s_shršk
);

2233 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
s
);

2234 
	`kl_ªÚ_su³r
(
s
);

2235 
	`kl_su³r_nÙify
(
s
);

2242 
	`li¡_Ìu_de¡roy
(&
s
->
s_d’Œy_Ìu
);

2243 
	`li¡_Ìu_de¡roy
(&
s
->
s_šode_Ìu
);

2245 
	`bŒfs_put_fesy¡em
(
fs
);

2246 
	`put_su³r
(
s
);

2248 
	`up_wr™e
(&
s
->
s_umouÁ
);

2250 
	}
}

2252 
	$bŒfs_umouÁ_muÉË
(
cur_·¹™iÚ_id
)

2254 
·¹™iÚ_Üd”
 = 
BTRFS_SUPER_INFO_COUNT
-1;

2255 
·¹™iÚ_Üd”
 >= 0;…artition_order--) {

2256 
su³r_block
 *
s
 = 
glob®_fs_šfo_li¡
[
·¹™iÚ_Üd”
]->
sb
;

2257 ià(
cur_·¹™iÚ_id
 =ğ
·¹™iÚ_Üd”
)

2259 
	`bŒfs_d—ùiv©e_locked_su³r
(
s
);

2261 
	}
}

2263 
	$bŒfs_kl_su³r
(
su³r_block
 *
sb
)

2265 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

2266 
cur_·¹™iÚ_id
 = 0; cur_·¹™iÚ_id < 
BTRFS_SUPER_INFO_COUNT
; cur_partition_id++) {

2267 ià(
sb
 =ğ
glob®_fs_šfo_li¡
[
cur_·¹™iÚ_id
]->sb){

2268 
	`bŒfs_umouÁ_muÉË
(
cur_·¹™iÚ_id
);

2273 
	`kl_ªÚ_su³r
(
sb
);

2274 
	`bŒfs_ä“_fs_šfo
(
fs_šfo
);

2275 
	}
}

2277 
fe_sy¡em_ty³
 
	gbŒfs_fs_ty³
 = {

2278 .
owÃr
 = 
THIS_MODULE
,

2279 .
	gÇme
 = "btrfs",

2280 .
	gmouÁ
 = 
bŒfs_mouÁ
,

2281 .
	gkl_sb
 = 
bŒfs_kl_su³r
,

2282 .
	gfs_æags
 = 
FS_REQUIRES_DEV
 | 
FS_BINARY_MOUNTDATA
,

2285 
fe_sy¡em_ty³
 
	gbŒfs_roÙ_fs_ty³
 = {

2286 .
owÃr
 = 
THIS_MODULE
,

2287 .
	gÇme
 = "btrfs",

2288 .
	gmouÁ
 = 
bŒfs_mouÁ_roÙ
,

2289 .
	gkl_sb
 = 
bŒfs_kl_su³r
,

2290 .
	gfs_æags
 = 
FS_REQUIRES_DEV
 | 
FS_BINARY_MOUNTDATA
 | 
FS_ALLOW_IDMAP
,

2293 
MODULE_ALIAS_FS
("btrfs");

2295 
	$bŒfs_cÚŒŞ_İ’
(
šode
 *šode, 
fe
 *file)

2302 
fe
->
´iv©e_d©a
 = 
NULL
;

2304 
	}
}

2309 
	$bŒfs_cÚŒŞ_ioùl
(
fe
 *fe, 
cmd
,

2310 
¬g
)

2312 
bŒfs_ioùl_vŞ_¬gs
 *
vŞ
;

2313 
bŒfs_deviû
 *
deviû
 = 
NULL
;

2314 
dev_t
 
devt
 = 0;

2315 
»t
 = -
ENOTTY
;

2317 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2318  -
EPERM
;

2320 
vŞ
 = 
	`memdup_u£r
((
__u£r
 *)
¬g
, (*vol));

2321 ià(
	`IS_ERR
(
vŞ
))

2322  
	`PTR_ERR
(
vŞ
);

2323 
vŞ
->
Çme
[
BTRFS_PATH_NAME_MAX
] = '\0';

2325 
cmd
) {

2326 
BTRFS_IOC_SCAN_DEV
:

2327 
	`mu‹x_lock
(&
uuid_mu‹x
);

2328 
deviû
 = 
	`bŒfs_sÿn_Úe_deviû
(
vŞ
->
Çme
, 
BLK_OPEN_READ
);

2329 
»t
 = 
	`PTR_ERR_OR_ZERO
(
deviû
);

2330 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

2332 
BTRFS_IOC_FORGET_DEV
:

2333 ià(
vŞ
->
Çme
[0] != 0) {

2334 
»t
 = 
	`lookup_bdev
(
vŞ
->
Çme
, &
devt
);

2335 ià(
»t
)

2338 
»t
 = 
	`bŒfs_fÜg‘_deviûs
(
devt
);

2340 
BTRFS_IOC_DEVICES_READY
:

2341 
	`mu‹x_lock
(&
uuid_mu‹x
);

2342 
deviû
 = 
	`bŒfs_sÿn_Úe_deviû
(
vŞ
->
Çme
, 
BLK_OPEN_READ
);

2343 ià(
	`IS_ERR
(
deviû
)) {

2344 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

2345 
»t
 = 
	`PTR_ERR
(
deviû
);

2348 
»t
 = !(
deviû
->
fs_deviûs
->
num_deviûs
 ==

2349 
deviû
->
fs_deviûs
->
tÙ®_deviûs
);

2350 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

2352 
BTRFS_IOC_GET_SUPPORTED_FEATURES
:

2353 
»t
 = 
	`bŒfs_ioùl_g‘_suµÜ‹d_ã©u»s
((
__u£r
*)
¬g
);

2357 
	`kä“
(
vŞ
);

2358  
»t
;

2359 
	}
}

2361 
	$bŒfs_ä“ze
(
su³r_block
 *
sb
)

2363 
bŒfs_Œªs_hªdË
 *
Œªs
;

2364 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

2365 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

2367 
	`£t_b™
(
BTRFS_FS_FROZEN
, &
fs_šfo
->
æags
);

2374 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ_b¬r›r
(
roÙ
);

2375 ià(
	`IS_ERR
(
Œªs
)) {

2377 ià(
	`PTR_ERR
(
Œªs
è=ğ-
ENOENT
)

2379  
	`PTR_ERR
(
Œªs
);

2381  
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

2382 
	}
}

2384 
	$check_dev_su³r
(
bŒfs_deviû
 *
dev
)

2386 
bŒfs_fs_šfo
 *
fs_šfo
 = 
dev
->fs_info;

2387 
bŒfs_su³r_block
 *
sb
;

2388 
u16
 
csum_ty³
;

2389 
»t
 = 0;

2392 
	`ASSERT
(
	`‹¡_b™
(
BTRFS_FS_FROZEN
, &
fs_šfo
->
æags
));

2395 ià(!
dev
->
bdev
)

2399 
sb
 = 
	`bŒfs_»ad_dev_Úe_su³r
(
dev
->
bdev
, 0, 
Œue
);

2400 ià(
	`IS_ERR
(
sb
))

2401  
	`PTR_ERR
(
sb
);

2404 
csum_ty³
 = 
	`bŒfs_su³r_csum_ty³
(
sb
);

2405 ià(
csum_ty³
 !ğ
	`bŒfs_su³r_csum_ty³
(
fs_šfo
->
su³r_cİy
)) {

2406 
	`bŒfs_”r
(
fs_šfo
, "csumype changed, has %uƒxpect %u",

2407 
csum_ty³
, 
	`bŒfs_su³r_csum_ty³
(
fs_šfo
->
su³r_cİy
));

2408 
»t
 = -
EUCLEAN
;

2409 
out
;

2412 ià(
	`bŒfs_check_su³r_csum
(
fs_šfo
, 
sb
)) {

2413 
	`bŒfs_”r
(
fs_šfo
, "csum for on-disk super block‚o†onger matches");

2414 
»t
 = -
EUCLEAN
;

2415 
out
;

2419 
»t
 = 
	`bŒfs_v®id©e_su³r
(
fs_šfo
, 
sb
, 0);

2420 ià(
»t
 < 0)

2421 
out
;

2423 ià(
	`bŒfs_su³r_g’”©iÚ
(
sb
è!ğ
fs_šfo
->
Ï¡_Œªs_comm™‹d
) {

2424 
	`bŒfs_”r
(
fs_šfo
, "transid mismatch, has %lluƒxpect %llu",

2425 
	`bŒfs_su³r_g’”©iÚ
(
sb
),

2426 
fs_šfo
->
Ï¡_Œªs_comm™‹d
);

2427 
»t
 = -
EUCLEAN
;

2428 
out
;

2430 
out
:

2431 
	`bŒfs_»Ëa£_disk_su³r
(
sb
);

2432  
»t
;

2433 
	}
}

2435 
	$bŒfs_unä“ze
(
su³r_block
 *
sb
)

2437 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

2438 
bŒfs_deviû
 *
deviû
;

2439 
»t
 = 0;

2449 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_šfo
->
fs_deviûs
->
deviûs
, 
dev_li¡
) {

2450 
»t
 = 
	`check_dev_su³r
(
deviû
);

2451 ià(
»t
 < 0) {

2452 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

2454 
deviû
->
devid
);

2458 
	`ş—r_b™
(
BTRFS_FS_FROZEN
, &
fs_šfo
->
æags
);

2466 
	}
}

2468 
	$bŒfs_show_devÇme
(
£q_fe
 *
m
, 
d’Œy
 *
roÙ
)

2470 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
roÙ
->
d_sb
);

2477 
	`rcu_»ad_lock
();

2478 
	`£q_esÿ³
(
m
, 
	`bŒfs_dev_Çme
(
fs_šfo
->
fs_deviûs
->
Ï‹¡_dev
), " \t\n\\");

2479 
	`rcu_»ad_uÆock
();

2482 
	}
}

2484 cÚ¡ 
su³r_İ”©iÚs
 
	gbŒfs_su³r_İs
 = {

2485 .
drİ_šode
 = 
bŒfs_drİ_šode
,

2486 .
	geviù_šode
 = 
bŒfs_eviù_šode
,

2487 .
	gput_su³r
 = 
bŒfs_put_su³r
,

2488 .
	gsync_fs
 = 
bŒfs_sync_fs
,

2489 .
	gshow_İtiÚs
 = 
bŒfs_show_İtiÚs
,

2490 .
	gshow_devÇme
 = 
bŒfs_show_devÇme
,

2491 .
	g®loc_šode
 = 
bŒfs_®loc_šode
,

2492 .
	gde¡roy_šode
 = 
bŒfs_de¡roy_šode
,

2493 .
	gä“_šode
 = 
bŒfs_ä“_šode
,

2494 .
	g¡©fs
 = 
bŒfs_¡©fs
,

2495 .
	g»mouÁ_fs
 = 
bŒfs_»mouÁ
,

2496 .
	gä“ze_fs
 = 
bŒfs_ä“ze
,

2497 .
	gunä“ze_fs
 = 
bŒfs_unä“ze
,

2500 cÚ¡ 
fe_İ”©iÚs
 
	gbŒfs_ùl_fİs
 = {

2501 .
İ’
 = 
bŒfs_cÚŒŞ_İ’
,

2502 .
	guÆocked_ioùl
 = 
bŒfs_cÚŒŞ_ioùl
,

2503 .
	gcom·t_ioùl
 = 
com·t_±r_ioùl
,

2504 .
	gowÃr
 = 
THIS_MODULE
,

2505 .
	gÎ£ek
 = 
noİ_Î£ek
,

2508 
miscdeviû
 
	gbŒfs_misc
 = {

2509 .
mšÜ
 = 
BTRFS_MINOR
,

2510 .
	gÇme
 = "btrfs-control",

2511 .
	gfİs
 = &
bŒfs_ùl_fİs


2514 
MODULE_ALIAS_MISCDEV
(
BTRFS_MINOR
);

2515 
MODULE_ALIAS
("devname:btrfs-control");

2517 
__š™
 
	$bŒfs_š‹rçû_š™
()

2519  
	`misc_»gi¡”
(&
bŒfs_misc
);

2520 
	}
}

2522 
__cŞd
 
	$bŒfs_š‹rçû_ex™
()

2524 
	`misc_d”egi¡”
(&
bŒfs_misc
);

2525 
	}
}

2527 
__š™
 
	$bŒfs_´št_mod_šfo
()

2529 cÚ¡ 
İtiÚs
[] = ""

2530 #ifdeà
CONFIG_BTRFS_DEBUG


2533 #ifdeà
CONFIG_BTRFS_ASSERT


2536 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


2539 #ifdeà
CONFIG_BTRFS_FS_REF_VERIFY


2542 #ifdeà
CONFIG_BLK_DEV_ZONED


2547 #ifdeà
CONFIG_FS_VERITY


2553 
	`´_šfo
("BŒf lßded%s\n", 
İtiÚs
);

2555 
	}
}

2557 
	$»gi¡”_bŒfs
()

2559  
	`»gi¡”_fesy¡em
(&
bŒfs_fs_ty³
);

2560 
	}
}

2562 
	$uÄegi¡”_bŒfs
()

2564 
	`uÄegi¡”_fesy¡em
(&
bŒfs_fs_ty³
);

2565 
	}
}

2568 
	sš™_£qu’û
 {

2569 (*
	mš™_func
)();

2571 (*
	mex™_func
)();

2574 cÚ¡ 
š™_£qu’û
 
	gmod_š™_£q
[] = {

2576 .
š™_func
 = 
bŒfs_´İs_š™
,

2577 .
	gex™_func
 = 
NULL
,

2579 .
	gš™_func
 = 
bŒfs_š™_sysfs
,

2580 .
	gex™_func
 = 
bŒfs_ex™_sysfs
,

2582 .
	gš™_func
 = 
bŒfs_š™_com´ess
,

2583 .
	gex™_func
 = 
bŒfs_ex™_com´ess
,

2585 .
	gš™_func
 = 
bŒfs_š™_ÿch•
,

2586 .
	gex™_func
 = 
bŒfs_de¡roy_ÿch•
,

2588 .
	gš™_func
 = 
bŒfs_Œª§ùiÚ_š™
,

2589 .
	gex™_func
 = 
bŒfs_Œª§ùiÚ_ex™
,

2591 .
	gš™_func
 = 
bŒfs_ù»e_š™
,

2592 .
	gex™_func
 = 
bŒfs_ù»e_ex™
,

2594 .
	gš™_func
 = 
bŒfs_ä“_¥aû_š™
,

2595 .
	gex™_func
 = 
bŒfs_ä“_¥aû_ex™
,

2597 .
	gš™_func
 = 
ex‹Á_¡©e_š™_ÿch•
,

2598 .
	gex™_func
 = 
ex‹Á_¡©e_ä“_ÿch•
,

2600 .
	gš™_func
 = 
ex‹Á_bufãr_š™_ÿch•
,

2601 .
	gex™_func
 = 
ex‹Á_bufãr_ä“_ÿch•
,

2603 .
	gš™_func
 = 
bŒfs_bio£t_š™
,

2604 .
	gex™_func
 = 
bŒfs_bio£t_ex™
,

2606 .
	gš™_func
 = 
ex‹Á_m­_š™
,

2607 .
	gex™_func
 = 
ex‹Á_m­_ex™
,

2609 .
	gš™_func
 = 
Üd”ed_d©a_š™
,

2610 .
	gex™_func
 = 
Üd”ed_d©a_ex™
,

2612 .
	gš™_func
 = 
bŒfs_d–ayed_šode_š™
,

2613 .
	gex™_func
 = 
bŒfs_d–ayed_šode_ex™
,

2615 .
	gš™_func
 = 
bŒfs_auto_deäag_š™
,

2616 .
	gex™_func
 = 
bŒfs_auto_deäag_ex™
,

2618 .
	gš™_func
 = 
bŒfs_d–ayed_»f_š™
,

2619 .
	gex™_func
 = 
bŒfs_d–ayed_»f_ex™
,

2621 .
	gš™_func
 = 
bŒfs_´–im_»f_š™
,

2622 .
	gex™_func
 = 
bŒfs_´–im_»f_ex™
,

2624 .
	gš™_func
 = 
bŒfs_š‹rçû_š™
,

2625 .
	gex™_func
 = 
bŒfs_š‹rçû_ex™
,

2627 .
	gš™_func
 = 
bŒfs_´št_mod_šfo
,

2628 .
	gex™_func
 = 
NULL
,

2630 .
	gš™_func
 = 
bŒfs_run_§n™y_‹¡s
,

2631 .
	gex™_func
 = 
NULL
,

2633 .
	gš™_func
 = 
»gi¡”_bŒfs
,

2634 .
	gex™_func
 = 
uÄegi¡”_bŒfs
,

2638 
boŞ
 
	gmod_š™_»suÉ
[
ARRAY_SIZE
(
mod_š™_£q
)];

2640 
__®ways_šlše
 
	$bŒfs_ex™_bŒfs_fs
()

2642 
i
;

2644 
i
 = 
	`ARRAY_SIZE
(
mod_š™_£q
) - 1; i >= 0; i--) {

2645 ià(!
mod_š™_»suÉ
[
i
])

2647 ià(
mod_š™_£q
[
i
].
ex™_func
)

2648 
mod_š™_£q
[
i
].
	`ex™_func
();

2649 
mod_š™_»suÉ
[
i
] = 
çl£
;

2651 
	}
}

2653 
__ex™
 
	$ex™_bŒfs_fs
()

2655 
	`bŒfs_ex™_bŒfs_fs
();

2656 
	`bŒfs_ş—nup_fs_uuids
();

2657 
	}
}

2659 
__š™
 
	$š™_bŒfs_fs
()

2661 
»t
;

2662 
i
;

2664 
i
 = 0; i < 
	`ARRAY_SIZE
(
mod_š™_£q
); i++) {

2665 
	`ASSERT
(!
mod_š™_»suÉ
[
i
]);

2666 
»t
 = 
mod_š™_£q
[
i
].
	`š™_func
();

2667 ià(
»t
 < 0) {

2668 
	`bŒfs_ex™_bŒfs_fs
();

2669  
»t
;

2671 
mod_š™_»suÉ
[
i
] = 
Œue
;

2674 
	}
}

2676 
Ï‹_š™ÿÎ
(
š™_bŒfs_fs
);

2677 
	$moduË_ex™
(
ex™_bŒfs_fs
)

2679 
	`MODULE_LICENSE
("GPL");

2680 
	`MODULE_SOFTDEP
("pre: crc32c");

2681 
	`MODULE_SOFTDEP
("pre: xxhash64");

2682 
	`MODULE_SOFTDEP
("pre: sha256");

2683 
	`MODULE_SOFTDEP
("pre: blake2b-256");

	@super.h

3 #iâdeà
BTRFS_SUPER_H


4 
	#BTRFS_SUPER_H


	)

6 
bŒfs_·r£_İtiÚs
(
bŒfs_fs_šfo
 *
šfo
, *
İtiÚs
,

7 
Ãw_æags
);

8 
bŒfs_sync_fs
(
su³r_block
 *
sb
, 
wa™
);

9 *
bŒfs_g‘_subvŞ_Çme_äom_objeùid
(
bŒfs_fs_šfo
 *
fs_šfo
,

10 
u64
 
subvŞ_objeùid
);

12 
šlše
 
bŒfs_fs_šfo
 *
	$bŒfs_sb
(
su³r_block
 *
sb
)

14  
sb
->
s_fs_šfo
;

15 
	}
}

17 
šlše
 
	$bŒfs_£t_sb_rdÚly
(
su³r_block
 *
sb
)

19 
sb
->
s_æags
 |ğ
SB_RDONLY
;

20 
	`£t_b™
(
BTRFS_FS_STATE_RO
, &
	`bŒfs_sb
(
sb
)->
fs_¡©e
);

21 
	}
}

23 
šlše
 
	$bŒfs_ş—r_sb_rdÚly
(
su³r_block
 *
sb
)

25 
sb
->
s_æags
 &ğ~
SB_RDONLY
;

26 
	`ş—r_b™
(
BTRFS_FS_STATE_RO
, &
	`bŒfs_sb
(
sb
)->
fs_¡©e
);

27 
	}
}

	@sysfs.c

6 
	~<lšux/sched.h
>

7 
	~<lšux/sched/mm.h
>

8 
	~<lšux/¦ab.h
>

9 
	~<lšux/¥šlock.h
>

10 
	~<lšux/com¶‘iÚ.h
>

11 
	~<lšux/bug.h
>

12 
	~<lšux/li¡.h
>

13 
	~<üy±o/hash.h
>

14 
	~"mes§ges.h
"

15 
	~"ù»e.h
"

16 
	~"disÿrd.h
"

17 
	~"disk-io.h
"

18 
	~"£nd.h
"

19 
	~"Œª§ùiÚ.h
"

20 
	~"sysfs.h
"

21 
	~"vŞumes.h
"

22 
	~"¥aû-šfo.h
"

23 
	~"block-group.h
"

24 
	~"qgroup.h
"

25 
	~"misc.h
"

26 
	~"fs.h
"

27 
	~"acûssÜs.h
"

49 
	sbŒfs_ã©u»_©Œ
 {

50 
kobj_©Œibu‹
 
	mkobj_©Œ
;

51 
bŒfs_ã©u»_£t
 
	mã©u»_£t
;

52 
u64
 
	mã©u»_b™
;

56 
	s¿id_kobjeù
 {

57 
u64
 
	mæags
;

58 
kobjeù
 
	mkobj
;

61 
	#__INIT_KOBJ_ATTR
(
_Çme
, 
_mode
, 
_show
, 
_¡Üe
) \

63 .
©Œ
 = { .
Çme
 = 
	`__¡ršgify
(
_Çme
), .
mode
 = 
_mode
 }, \

64 .
show
 = 
_show
, \

65 .
¡Üe
 = 
_¡Üe
, \

66 }

	)

68 
	#BTRFS_ATTR_W
(
_´efix
, 
_Çme
, 
_¡Üe
) \

69 
kobj_©Œibu‹
 
bŒfs_©Œ_
##
_´efix
##
_
##
_Çme
 = \

70 
	`__INIT_KOBJ_ATTR
(
_Çme
, 0200, 
NULL
, 
_¡Üe
)

	)

72 
	#BTRFS_ATTR_RW
(
_´efix
, 
_Çme
, 
_show
, 
_¡Üe
) \

73 
kobj_©Œibu‹
 
bŒfs_©Œ_
##
_´efix
##
_
##
_Çme
 = \

74 
	`__INIT_KOBJ_ATTR
(
_Çme
, 0644, 
_show
, 
_¡Üe
)

	)

76 
	#BTRFS_ATTR
(
_´efix
, 
_Çme
, 
_show
) \

77 
kobj_©Œibu‹
 
bŒfs_©Œ_
##
_´efix
##
_
##
_Çme
 = \

78 
	`__INIT_KOBJ_ATTR
(
_Çme
, 0444, 
_show
, 
NULL
)

	)

80 
	#BTRFS_ATTR_PTR
(
_´efix
, 
_Çme
) \

81 (&
bŒfs_©Œ_
##
_´efix
##
_
##
_Çme
.
©Œ
)

	)

83 
	#BTRFS_FEAT_ATTR
(
_Çme
, 
_ã©u»_£t
, 
_ã©u»_´efix
, 
_ã©u»_b™
) \

84 
bŒfs_ã©u»_©Œ
 
bŒfs_©Œ_ã©u»s_
##
_Çme
 = { \

85 .
kobj_©Œ
 = 
	`__INIT_KOBJ_ATTR
(
_Çme
, 
S_IRUGO
, \

86 
bŒfs_ã©u»_©Œ_show
, \

87 
bŒfs_ã©u»_©Œ_¡Üe
), \

88 .
ã©u»_£t
 = 
_ã©u»_£t
, \

89 .
ã©u»_b™
 = 
_ã©u»_´efix
 ##
_
## 
_ã©u»_b™
, \

90 }

	)

91 
	#BTRFS_FEAT_ATTR_PTR
(
_Çme
) \

92 (&
bŒfs_©Œ_ã©u»s_
##
_Çme
.
kobj_©Œ
.
©Œ
)

	)

94 
	#BTRFS_FEAT_ATTR_COMPAT
(
Çme
, 
ã©u»
) \

95 
	`BTRFS_FEAT_ATTR
(
Çme
, 
FEAT_COMPAT
, 
BTRFS_FEATURE_COMPAT
, 
ã©u»
)

	)

96 
	#BTRFS_FEAT_ATTR_COMPAT_RO
(
Çme
, 
ã©u»
) \

97 
	`BTRFS_FEAT_ATTR
(
Çme
, 
FEAT_COMPAT_RO
, 
BTRFS_FEATURE_COMPAT_RO
, 
ã©u»
)

	)

98 
	#BTRFS_FEAT_ATTR_INCOMPAT
(
Çme
, 
ã©u»
) \

99 
	`BTRFS_FEAT_ATTR
(
Çme
, 
FEAT_INCOMPAT
, 
BTRFS_FEATURE_INCOMPAT
, 
ã©u»
)

	)

101 
šlše
 
bŒfs_fs_šfo
 *
to_fs_šfo
(
kobjeù
 *
kobj
);

102 
šlše
 
bŒfs_fs_deviûs
 *
to_fs_devs
(
kobjeù
 *
kobj
);

103 
kobjeù
 *
g‘_bŒfs_kobj
(kobjeù *
kobj
);

105 
bŒfs_ã©u»_©Œ
 *
	$to_bŒfs_ã©u»_©Œ
(
kobj_©Œibu‹
 *
a
)

107  
	`cÚš”_of
(
a
, 
bŒfs_ã©u»_©Œ
, 
kobj_©Œ
);

108 
	}
}

110 
kobj_©Œibu‹
 *
	$©Œ_to_bŒfs_©Œ
(
©Œibu‹
 *
©Œ
)

112  
	`cÚš”_of
(
©Œ
, 
kobj_©Œibu‹
,‡ttr);

113 
	}
}

115 
bŒfs_ã©u»_©Œ
 *
	$©Œ_to_bŒfs_ã©u»_©Œ
(

116 
©Œibu‹
 *
©Œ
)

118  
	`to_bŒfs_ã©u»_©Œ
(
	`©Œ_to_bŒfs_©Œ
(
©Œ
));

119 
	}
}

121 
u64
 
	$g‘_ã©u»s
(
bŒfs_fs_šfo
 *
fs_šfo
,

122 
bŒfs_ã©u»_£t
 
£t
)

124 
bŒfs_su³r_block
 *
disk_su³r
 = 
fs_šfo
->
su³r_cİy
;

125 ià(
£t
 =ğ
FEAT_COMPAT
)

126  
	`bŒfs_su³r_com·t_æags
(
disk_su³r
);

127 ià(
£t
 =ğ
FEAT_COMPAT_RO
)

128  
	`bŒfs_su³r_com·t_ro_æags
(
disk_su³r
);

130  
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
);

131 
	}
}

133 
	$£t_ã©u»s
(
bŒfs_fs_šfo
 *
fs_šfo
,

134 
bŒfs_ã©u»_£t
 
£t
, 
u64
 
ã©u»s
)

136 
bŒfs_su³r_block
 *
disk_su³r
 = 
fs_šfo
->
su³r_cİy
;

137 ià(
£t
 =ğ
FEAT_COMPAT
)

138 
	`bŒfs_£t_su³r_com·t_æags
(
disk_su³r
, 
ã©u»s
);

139 ià(
£t
 =ğ
FEAT_COMPAT_RO
)

140 
	`bŒfs_£t_su³r_com·t_ro_æags
(
disk_su³r
, 
ã©u»s
);

142 
	`bŒfs_£t_su³r_šcom·t_æags
(
disk_su³r
, 
ã©u»s
);

143 
	}
}

145 
	$ÿn_modify_ã©u»
(
bŒfs_ã©u»_©Œ
 *
ç
)

147 
v®
 = 0;

148 
u64
 
£t
, 
ş—r
;

149 
ç
->
ã©u»_£t
) {

150 
FEAT_COMPAT
:

151 
£t
 = 
BTRFS_FEATURE_COMPAT_SAFE_SET
;

152 
ş—r
 = 
BTRFS_FEATURE_COMPAT_SAFE_CLEAR
;

154 
FEAT_COMPAT_RO
:

155 
£t
 = 
BTRFS_FEATURE_COMPAT_RO_SAFE_SET
;

156 
ş—r
 = 
BTRFS_FEATURE_COMPAT_RO_SAFE_CLEAR
;

158 
FEAT_INCOMPAT
:

159 
£t
 = 
BTRFS_FEATURE_INCOMPAT_SAFE_SET
;

160 
ş—r
 = 
BTRFS_FEATURE_INCOMPAT_SAFE_CLEAR
;

163 
	`´_w¬n
("btrfs: sysfs: unknown feature set %d\n",

164 
ç
->
ã©u»_£t
);

168 ià(
£t
 & 
ç
->
ã©u»_b™
)

169 
v®
 |= 1;

170 ià(
ş—r
 & 
ç
->
ã©u»_b™
)

171 
v®
 |= 2;

173  
v®
;

174 
	}
}

176 
ssize_t
 
	$bŒfs_ã©u»_©Œ_show
(
kobjeù
 *
kobj
,

177 
kobj_©Œibu‹
 *
a
, *
buf
)

179 
v®
 = 0;

180 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

181 
bŒfs_ã©u»_©Œ
 *
ç
 = 
	`to_bŒfs_ã©u»_©Œ
(
a
);

182 ià(
fs_šfo
) {

183 
u64
 
ã©u»s
 = 
	`g‘_ã©u»s
(
fs_šfo
, 
ç
->
ã©u»_£t
);

184 ià(
ã©u»s
 & 
ç
->
ã©u»_b™
)

185 
v®
 = 1;

187 
v®
 = 
	`ÿn_modify_ã©u»
(
ç
);

189  
	`sysfs_em™
(
buf
, "%d\n", 
v®
);

190 
	}
}

192 
ssize_t
 
	$bŒfs_ã©u»_©Œ_¡Üe
(
kobjeù
 *
kobj
,

193 
kobj_©Œibu‹
 *
a
,

194 cÚ¡ *
buf
, 
size_t
 
couÁ
)

196 
bŒfs_fs_šfo
 *
fs_šfo
;

197 
bŒfs_ã©u»_©Œ
 *
ç
 = 
	`to_bŒfs_ã©u»_©Œ
(
a
);

198 
u64
 
ã©u»s
, 
£t
, 
ş—r
;

199 
v®
;

200 
»t
;

202 
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

203 ià(!
fs_šfo
)

204  -
EPERM
;

206 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
))

207  -
EROFS
;

209 
»t
 = 
	`k¡¹oul
(
	`sk_¥aûs
(
buf
), 0, &
v®
);

210 ià(
»t
)

211  
»t
;

213 ià(
ç
->
ã©u»_£t
 =ğ
FEAT_COMPAT
) {

214 
£t
 = 
BTRFS_FEATURE_COMPAT_SAFE_SET
;

215 
ş—r
 = 
BTRFS_FEATURE_COMPAT_SAFE_CLEAR
;

216 } ià(
ç
->
ã©u»_£t
 =ğ
FEAT_COMPAT_RO
) {

217 
£t
 = 
BTRFS_FEATURE_COMPAT_RO_SAFE_SET
;

218 
ş—r
 = 
BTRFS_FEATURE_COMPAT_RO_SAFE_CLEAR
;

220 
£t
 = 
BTRFS_FEATURE_INCOMPAT_SAFE_SET
;

221 
ş—r
 = 
BTRFS_FEATURE_INCOMPAT_SAFE_CLEAR
;

224 
ã©u»s
 = 
	`g‘_ã©u»s
(
fs_šfo
, 
ç
->
ã©u»_£t
);

227 ià((
v®
 && (
ã©u»s
 & 
ç
->
ã©u»_b™
)) ||

228 (!
v®
 && !(
ã©u»s
 & 
ç
->
ã©u»_b™
)))

229  
couÁ
;

231 ià((
v®
 && !(
£t
 & 
ç
->
ã©u»_b™
)) ||

232 (!
v®
 && !(
ş—r
 & 
ç
->
ã©u»_b™
))) {

233 
	`bŒfs_šfo
(
fs_šfo
,

235 
v®
 ? "En" : "Dis", 
ç
->
kobj_©Œ
.
©Œ
.
Çme
);

236  -
EPERM
;

239 
	`bŒfs_šfo
(
fs_šfo
, "%s %s feature flag",

240 
v®
 ? "S‘tšg" : "CË¬šg", 
ç
->
kobj_©Œ
.
©Œ
.
Çme
);

242 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

243 
ã©u»s
 = 
	`g‘_ã©u»s
(
fs_šfo
, 
ç
->
ã©u»_£t
);

244 ià(
v®
)

245 
ã©u»s
 |ğ
ç
->
ã©u»_b™
;

247 
ã©u»s
 &ğ~
ç
->
ã©u»_b™
;

248 
	`£t_ã©u»s
(
fs_šfo
, 
ç
->
ã©u»_£t
, 
ã©u»s
);

249 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

254 
	`£t_b™
(
BTRFS_FS_NEED_TRANS_COMMIT
, &
fs_šfo
->
æags
);

255 
	`wake_up_´oûss
(
fs_šfo
->
Œª§ùiÚ_kth»ad
);

257  
couÁ
;

258 
	}
}

260 
umode_t
 
	$bŒfs_ã©u»_visibË
(
kobjeù
 *
kobj
,

261 
©Œibu‹
 *
©Œ
, 
unu£d
)

263 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

264 
umode_t
 
mode
 = 
©Œ
->mode;

266 ià(
fs_šfo
) {

267 
bŒfs_ã©u»_©Œ
 *
ç
;

268 
u64
 
ã©u»s
;

270 
ç
 = 
	`©Œ_to_bŒfs_ã©u»_©Œ
(
©Œ
);

271 
ã©u»s
 = 
	`g‘_ã©u»s
(
fs_šfo
, 
ç
->
ã©u»_£t
);

273 ià(
	`ÿn_modify_ã©u»
(
ç
))

274 
mode
 |ğ
S_IWUSR
;

275 ià(!(
ã©u»s
 & 
ç
->
ã©u»_b™
))

276 
mode
 = 0;

279  
mode
;

280 
	}
}

282 
BTRFS_FEAT_ATTR_INCOMPAT
(
deçuÉ_subvŞ
, 
DEFAULT_SUBVOL
);

283 
BTRFS_FEAT_ATTR_INCOMPAT
(
mixed_groups
, 
MIXED_GROUPS
);

284 
BTRFS_FEAT_ATTR_INCOMPAT
(
com´ess_lzo
, 
COMPRESS_LZO
);

285 
BTRFS_FEAT_ATTR_INCOMPAT
(
com´ess_z¡d
, 
COMPRESS_ZSTD
);

286 
BTRFS_FEAT_ATTR_INCOMPAT
(
ex‹nded_œef
, 
EXTENDED_IREF
);

287 
BTRFS_FEAT_ATTR_INCOMPAT
(
¿id56
, 
RAID56
);

288 
BTRFS_FEAT_ATTR_INCOMPAT
(
skšny_m‘ad©a
, 
SKINNY_METADATA
);

289 
BTRFS_FEAT_ATTR_INCOMPAT
(
no_hŞes
, 
NO_HOLES
);

290 
BTRFS_FEAT_ATTR_INCOMPAT
(
m‘ad©a_uuid
, 
METADATA_UUID
);

291 
BTRFS_FEAT_ATTR_COMPAT_RO
(
ä“_¥aû_Œ“
, 
FREE_SPACE_TREE
);

292 
BTRFS_FEAT_ATTR_COMPAT_RO
(
block_group_Œ“
, 
BLOCK_GROUP_TREE
);

293 
BTRFS_FEAT_ATTR_INCOMPAT
(
¿id1c34
, 
RAID1C34
);

294 #ifdeà
CONFIG_BLK_DEV_ZONED


295 
BTRFS_FEAT_ATTR_INCOMPAT
(
zÚed
, 
ZONED
);

297 #ifdeà
CONFIG_BTRFS_DEBUG


299 
BTRFS_FEAT_ATTR_INCOMPAT
(
ex‹Á_Œ“_v2
, 
EXTENT_TREE_V2
);

301 #ifdeà
CONFIG_FS_VERITY


302 
BTRFS_FEAT_ATTR_COMPAT_RO
(
v”™y
, 
VERITY
);

312 
©Œibu‹
 *
	gbŒfs_suµÜ‹d_ã©u»_©Œs
[] = {

313 
BTRFS_FEAT_ATTR_PTR
(
deçuÉ_subvŞ
),

314 
BTRFS_FEAT_ATTR_PTR
(
mixed_groups
),

315 
BTRFS_FEAT_ATTR_PTR
(
com´ess_lzo
),

316 
BTRFS_FEAT_ATTR_PTR
(
com´ess_z¡d
),

317 
BTRFS_FEAT_ATTR_PTR
(
ex‹nded_œef
),

318 
BTRFS_FEAT_ATTR_PTR
(
¿id56
),

319 
BTRFS_FEAT_ATTR_PTR
(
skšny_m‘ad©a
),

320 
BTRFS_FEAT_ATTR_PTR
(
no_hŞes
),

321 
BTRFS_FEAT_ATTR_PTR
(
m‘ad©a_uuid
),

322 
BTRFS_FEAT_ATTR_PTR
(
ä“_¥aû_Œ“
),

323 
BTRFS_FEAT_ATTR_PTR
(
¿id1c34
),

324 
BTRFS_FEAT_ATTR_PTR
(
block_group_Œ“
),

325 #ifdeà
CONFIG_BLK_DEV_ZONED


326 
BTRFS_FEAT_ATTR_PTR
(
zÚed
),

328 #ifdeà
CONFIG_BTRFS_DEBUG


329 
BTRFS_FEAT_ATTR_PTR
(
ex‹Á_Œ“_v2
),

331 #ifdeà
CONFIG_FS_VERITY


332 
BTRFS_FEAT_ATTR_PTR
(
v”™y
),

334 
NULL


337 cÚ¡ 
©Œibu‹_group
 
	gbŒfs_ã©u»_©Œ_group
 = {

338 .
Çme
 = "features",

339 .
	gis_visibË
 = 
bŒfs_ã©u»_visibË
,

340 .
	g©Œs
 = 
bŒfs_suµÜ‹d_ã©u»_©Œs
,

343 
ssize_t
 
	$rmdœ_subvŞ_show
(
kobjeù
 *
kobj
,

344 
kobj_©Œibu‹
 *
ka
, *
buf
)

346  
	`sysfs_em™
(
buf
, "0\n");

347 
	}
}

348 
BTRFS_ATTR
(
¡©ic_ã©u»
, 
rmdœ_subvŞ
, 
rmdœ_subvŞ_show
);

350 
ssize_t
 
	$suµÜ‹d_checksums_show
(
kobjeù
 *
kobj
,

351 
kobj_©Œibu‹
 *
a
, *
buf
)

353 
ssize_t
 
»t
 = 0;

354 
i
;

356 
i
 = 0; i < 
	`bŒfs_g‘_num_csums
(); i++) {

361 
»t
 +ğ
	`sysfs_em™_©
(
buf
,„‘, "%s%s", (
i
 == 0 ? "" : " "),

362 
	`bŒfs_su³r_csum_Çme
(
i
));

366 
»t
 +ğ
	`sysfs_em™_©
(
buf
,„et, "\n");

367  
»t
;

368 
	}
}

369 
BTRFS_ATTR
(
¡©ic_ã©u»
, 
suµÜ‹d_checksums
, 
suµÜ‹d_checksums_show
);

371 
ssize_t
 
	$£nd_¡»am_v”siÚ_show
(
kobjeù
 *
kobj
,

372 
kobj_©Œibu‹
 *
ka
, *
buf
)

374  
	`sysfs_em™
(
buf
, "%d\n", 
BTRFS_SEND_STREAM_VERSION
);

375 
	}
}

376 
BTRFS_ATTR
(
¡©ic_ã©u»
, 
£nd_¡»am_v”siÚ
, 
£nd_¡»am_v”siÚ_show
);

378 cÚ¡ *
	g»scue_İts
[] = {

386 
ssize_t
 
	$suµÜ‹d_»scue_İtiÚs_show
(
kobjeù
 *
kobj
,

387 
kobj_©Œibu‹
 *
a
,

388 *
buf
)

390 
ssize_t
 
»t
 = 0;

391 
i
;

393 
i
 = 0; i < 
	`ARRAY_SIZE
(
»scue_İts
); i++)

394 
»t
 +ğ
	`sysfs_em™_©
(
buf
,„‘, "%s%s", (
i
 ? " " : ""), 
»scue_İts
[i]);

395 
»t
 +ğ
	`sysfs_em™_©
(
buf
,„et, "\n");

396  
»t
;

397 
	}
}

398 
BTRFS_ATTR
(
¡©ic_ã©u»
, 
suµÜ‹d_»scue_İtiÚs
,

399 
suµÜ‹d_»scue_İtiÚs_show
);

401 
ssize_t
 
	$suµÜ‹d_£ùÜsizes_show
(
kobjeù
 *
kobj
,

402 
kobj_©Œibu‹
 *
a
,

403 *
buf
)

405 
ssize_t
 
»t
 = 0;

408 ià(
PAGE_SIZE
 > 
SZ_4K
)

409 
»t
 +ğ
	`sysfs_em™_©
(
buf
,„‘, "%u ", 
SZ_4K
);

410 
»t
 +ğ
	`sysfs_em™_©
(
buf
,„‘, "%lu\n", 
PAGE_SIZE
);

412  
»t
;

413 
	}
}

414 
BTRFS_ATTR
(
¡©ic_ã©u»
, 
suµÜ‹d_£ùÜsizes
,

415 
suµÜ‹d_£ùÜsizes_show
);

417 
ssize_t
 
	$aş_show
(
kobjeù
 *
kobj
, 
kobj_©Œibu‹
 *
a
, *
buf
)

419  
	`sysfs_em™
(
buf
, "%d\n", !!
	`IS_ENABLED
(
CONFIG_BTRFS_FS_POSIX_ACL
));

420 
	}
}

421 
BTRFS_ATTR
(
¡©ic_ã©u»
, 
aş
, 
aş_show
);

429 
©Œibu‹
 *
	gbŒfs_suµÜ‹d_¡©ic_ã©u»_©Œs
[] = {

430 
BTRFS_ATTR_PTR
(
¡©ic_ã©u»
, 
aş
),

431 
BTRFS_ATTR_PTR
(
¡©ic_ã©u»
, 
rmdœ_subvŞ
),

432 
BTRFS_ATTR_PTR
(
¡©ic_ã©u»
, 
suµÜ‹d_checksums
),

433 
BTRFS_ATTR_PTR
(
¡©ic_ã©u»
, 
£nd_¡»am_v”siÚ
),

434 
BTRFS_ATTR_PTR
(
¡©ic_ã©u»
, 
suµÜ‹d_»scue_İtiÚs
),

435 
BTRFS_ATTR_PTR
(
¡©ic_ã©u»
, 
suµÜ‹d_£ùÜsizes
),

436 
NULL


439 cÚ¡ 
©Œibu‹_group
 
	gbŒfs_¡©ic_ã©u»_©Œ_group
 = {

440 .
Çme
 = "features",

441 .
	g©Œs
 = 
bŒfs_suµÜ‹d_¡©ic_ã©u»_©Œs
,

447 
	#disÿrd_to_fs_šfo
(
_kobj
è
	`to_fs_šfo
(
	`g‘_bŒfs_kobj
(_kobj))

	)

449 
ssize_t
 
	$bŒfs_disÿrdabË_by‹s_show
(
kobjeù
 *
kobj
,

450 
kobj_©Œibu‹
 *
a
,

451 *
buf
)

453 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`disÿrd_to_fs_šfo
(
kobj
);

455  
	`sysfs_em™
(
buf
, "%lld\n",

456 
	`©omic64_»ad
(&
fs_šfo
->
disÿrd_ùl
.
disÿrdabË_by‹s
));

457 
	}
}

458 
BTRFS_ATTR
(
disÿrd
, 
disÿrdabË_by‹s
, 
bŒfs_disÿrdabË_by‹s_show
);

460 
ssize_t
 
	$bŒfs_disÿrdabË_ex‹Ás_show
(
kobjeù
 *
kobj
,

461 
kobj_©Œibu‹
 *
a
,

462 *
buf
)

464 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`disÿrd_to_fs_šfo
(
kobj
);

466  
	`sysfs_em™
(
buf
, "%d\n",

467 
	`©omic_»ad
(&
fs_šfo
->
disÿrd_ùl
.
disÿrdabË_ex‹Ás
));

468 
	}
}

469 
BTRFS_ATTR
(
disÿrd
, 
disÿrdabË_ex‹Ás
, 
bŒfs_disÿrdabË_ex‹Ás_show
);

471 
ssize_t
 
	$bŒfs_disÿrd_b™m­_by‹s_show
(
kobjeù
 *
kobj
,

472 
kobj_©Œibu‹
 *
a
,

473 *
buf
)

475 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`disÿrd_to_fs_šfo
(
kobj
);

477  
	`sysfs_em™
(
buf
, "%llu\n",

478 
fs_šfo
->
disÿrd_ùl
.
disÿrd_b™m­_by‹s
);

479 
	}
}

480 
BTRFS_ATTR
(
disÿrd
, 
disÿrd_b™m­_by‹s
, 
bŒfs_disÿrd_b™m­_by‹s_show
);

482 
ssize_t
 
	$bŒfs_disÿrd_by‹s_§ved_show
(
kobjeù
 *
kobj
,

483 
kobj_©Œibu‹
 *
a
,

484 *
buf
)

486 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`disÿrd_to_fs_šfo
(
kobj
);

488  
	`sysfs_em™
(
buf
, "%lld\n",

489 
	`©omic64_»ad
(&
fs_šfo
->
disÿrd_ùl
.
disÿrd_by‹s_§ved
));

490 
	}
}

491 
BTRFS_ATTR
(
disÿrd
, 
disÿrd_by‹s_§ved
, 
bŒfs_disÿrd_by‹s_§ved_show
);

493 
ssize_t
 
	$bŒfs_disÿrd_ex‹Á_by‹s_show
(
kobjeù
 *
kobj
,

494 
kobj_©Œibu‹
 *
a
,

495 *
buf
)

497 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`disÿrd_to_fs_šfo
(
kobj
);

499  
	`sysfs_em™
(
buf
, "%llu\n",

500 
fs_šfo
->
disÿrd_ùl
.
disÿrd_ex‹Á_by‹s
);

501 
	}
}

502 
BTRFS_ATTR
(
disÿrd
, 
disÿrd_ex‹Á_by‹s
, 
bŒfs_disÿrd_ex‹Á_by‹s_show
);

504 
ssize_t
 
	$bŒfs_disÿrd_iİs_lim™_show
(
kobjeù
 *
kobj
,

505 
kobj_©Œibu‹
 *
a
,

506 *
buf
)

508 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`disÿrd_to_fs_šfo
(
kobj
);

510  
	`sysfs_em™
(
buf
, "%u\n",

511 
	`READ_ONCE
(
fs_šfo
->
disÿrd_ùl
.
iİs_lim™
));

512 
	}
}

514 
ssize_t
 
	$bŒfs_disÿrd_iİs_lim™_¡Üe
(
kobjeù
 *
kobj
,

515 
kobj_©Œibu‹
 *
a
,

516 cÚ¡ *
buf
, 
size_t
 
Ën
)

518 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`disÿrd_to_fs_šfo
(
kobj
);

519 
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
 = &
fs_šfo
->discard_ctl;

520 
u32
 
iİs_lim™
;

521 
»t
;

523 
»t
 = 
	`k¡¹ou32
(
buf
, 10, &
iİs_lim™
);

524 ià(
»t
)

525  -
EINVAL
;

527 
	`WRITE_ONCE
(
disÿrd_ùl
->
iİs_lim™
, iops_limit);

528 
	`bŒfs_disÿrd_ÿlc_d–ay
(
disÿrd_ùl
);

529 
	`bŒfs_disÿrd_scheduË_wÜk
(
disÿrd_ùl
, 
Œue
);

530  
Ën
;

531 
	}
}

532 
BTRFS_ATTR_RW
(
disÿrd
, 
iİs_lim™
, 
bŒfs_disÿrd_iİs_lim™_show
,

533 
bŒfs_disÿrd_iİs_lim™_¡Üe
);

535 
ssize_t
 
	$bŒfs_disÿrd_kbps_lim™_show
(
kobjeù
 *
kobj
,

536 
kobj_©Œibu‹
 *
a
,

537 *
buf
)

539 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`disÿrd_to_fs_šfo
(
kobj
);

541  
	`sysfs_em™
(
buf
, "%u\n",

542 
	`READ_ONCE
(
fs_šfo
->
disÿrd_ùl
.
kbps_lim™
));

543 
	}
}

545 
ssize_t
 
	$bŒfs_disÿrd_kbps_lim™_¡Üe
(
kobjeù
 *
kobj
,

546 
kobj_©Œibu‹
 *
a
,

547 cÚ¡ *
buf
, 
size_t
 
Ën
)

549 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`disÿrd_to_fs_šfo
(
kobj
);

550 
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
 = &
fs_šfo
->discard_ctl;

551 
u32
 
kbps_lim™
;

552 
»t
;

554 
»t
 = 
	`k¡¹ou32
(
buf
, 10, &
kbps_lim™
);

555 ià(
»t
)

556  -
EINVAL
;

558 
	`WRITE_ONCE
(
disÿrd_ùl
->
kbps_lim™
, kbps_limit);

559 
	`bŒfs_disÿrd_scheduË_wÜk
(
disÿrd_ùl
, 
Œue
);

560  
Ën
;

561 
	}
}

562 
BTRFS_ATTR_RW
(
disÿrd
, 
kbps_lim™
, 
bŒfs_disÿrd_kbps_lim™_show
,

563 
bŒfs_disÿrd_kbps_lim™_¡Üe
);

565 
ssize_t
 
	$bŒfs_disÿrd_max_disÿrd_size_show
(
kobjeù
 *
kobj
,

566 
kobj_©Œibu‹
 *
a
,

567 *
buf
)

569 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`disÿrd_to_fs_šfo
(
kobj
);

571  
	`sysfs_em™
(
buf
, "%llu\n",

572 
	`READ_ONCE
(
fs_šfo
->
disÿrd_ùl
.
max_disÿrd_size
));

573 
	}
}

575 
ssize_t
 
	$bŒfs_disÿrd_max_disÿrd_size_¡Üe
(
kobjeù
 *
kobj
,

576 
kobj_©Œibu‹
 *
a
,

577 cÚ¡ *
buf
, 
size_t
 
Ën
)

579 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`disÿrd_to_fs_šfo
(
kobj
);

580 
bŒfs_disÿrd_ùl
 *
disÿrd_ùl
 = &
fs_šfo
->discard_ctl;

581 
u64
 
max_disÿrd_size
;

582 
»t
;

584 
»t
 = 
	`k¡¹ou64
(
buf
, 10, &
max_disÿrd_size
);

585 ià(
»t
)

586  -
EINVAL
;

588 
	`WRITE_ONCE
(
disÿrd_ùl
->
max_disÿrd_size
, max_discard_size);

590  
Ën
;

591 
	}
}

592 
BTRFS_ATTR_RW
(
disÿrd
, 
max_disÿrd_size
, 
bŒfs_disÿrd_max_disÿrd_size_show
,

593 
bŒfs_disÿrd_max_disÿrd_size_¡Üe
);

600 cÚ¡ 
©Œibu‹
 *
	gdisÿrd_©Œs
[] = {

601 
BTRFS_ATTR_PTR
(
disÿrd
, 
disÿrdabË_by‹s
),

602 
BTRFS_ATTR_PTR
(
disÿrd
, 
disÿrdabË_ex‹Ás
),

603 
BTRFS_ATTR_PTR
(
disÿrd
, 
disÿrd_b™m­_by‹s
),

604 
BTRFS_ATTR_PTR
(
disÿrd
, 
disÿrd_by‹s_§ved
),

605 
BTRFS_ATTR_PTR
(
disÿrd
, 
disÿrd_ex‹Á_by‹s
),

606 
BTRFS_ATTR_PTR
(
disÿrd
, 
iİs_lim™
),

607 
BTRFS_ATTR_PTR
(
disÿrd
, 
kbps_lim™
),

608 
BTRFS_ATTR_PTR
(
disÿrd
, 
max_disÿrd_size
),

609 
NULL
,

612 #ifdeà
CONFIG_BTRFS_DEBUG


619 cÚ¡ 
©Œibu‹
 *
	gbŒfs_debug_mouÁ_©Œs
[] = {

620 
NULL
,

628 
©Œibu‹
 *
	gbŒfs_debug_ã©u»_©Œs
[] = {

629 
NULL


632 cÚ¡ 
©Œibu‹_group
 
	gbŒfs_debug_ã©u»_©Œ_group
 = {

633 .
Çme
 = "debug",

634 .
	g©Œs
 = 
bŒfs_debug_ã©u»_©Œs
,

639 
ssize_t
 
	$bŒfs_show_u64
(
u64
 *
v®ue_±r
, 
¥šlock_t
 *
lock
, *
buf
)

641 
u64
 
v®
;

642 ià(
lock
)

643 
	`¥š_lock
(
lock
);

644 
v®
 = *
v®ue_±r
;

645 ià(
lock
)

646 
	`¥š_uÆock
(
lock
);

647  
	`sysfs_em™
(
buf
, "%Îu\n", 
v®
);

648 
	}
}

650 
ssize_t
 
	$glob®_rsv_size_show
(
kobjeù
 *
kobj
,

651 
kobj_©Œibu‹
 *
ka
, *
buf
)

653 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
->
·»Á
);

654 
bŒfs_block_rsv
 *
block_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

655  
	`bŒfs_show_u64
(&
block_rsv
->
size
, &block_rsv->
lock
, 
buf
);

656 
	}
}

657 
BTRFS_ATTR
(
®loÿtiÚ
, 
glob®_rsv_size
, 
glob®_rsv_size_show
);

659 
ssize_t
 
	$glob®_rsv_»£rved_show
(
kobjeù
 *
kobj
,

660 
kobj_©Œibu‹
 *
a
, *
buf
)

662 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
->
·»Á
);

663 
bŒfs_block_rsv
 *
block_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

664  
	`bŒfs_show_u64
(&
block_rsv
->
»£rved
, &block_rsv->
lock
, 
buf
);

665 
	}
}

666 
BTRFS_ATTR
(
®loÿtiÚ
, 
glob®_rsv_»£rved
, 
glob®_rsv_»£rved_show
);

668 
	#to_¥aû_šfo
(
_kobj
è
	`cÚš”_of
(_kobj, 
bŒfs_¥aû_šfo
, 
kobj
)

	)

669 
	#to_¿id_kobj
(
_kobj
è
	`cÚš”_of
(_kobj, 
¿id_kobjeù
, 
kobj
)

	)

671 
ssize_t
 
¿id_by‹s_show
(
kobjeù
 *
kobj
,

672 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

673 
BTRFS_ATTR
(
¿id
, 
tÙ®_by‹s
, 
¿id_by‹s_show
);

674 
BTRFS_ATTR
(
¿id
, 
u£d_by‹s
, 
¿id_by‹s_show
);

676 
ssize_t
 
	$¿id_by‹s_show
(
kobjeù
 *
kobj
,

677 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

680 
bŒfs_¥aû_šfo
 *
sšfo
 = 
	`to_¥aû_šfo
(
kobj
->
·»Á
);

681 
bŒfs_block_group
 *
block_group
;

682 
šdex
 = 
	`bŒfs_bg_æags_to_¿id_šdex
(
	`to_¿id_kobj
(
kobj
)->
æags
);

683 
u64
 
v®
 = 0;

685 
	`down_»ad
(&
sšfo
->
groups_£m
);

686 
	`li¡_fÜ_—ch_’Œy
(
block_group
, &
sšfo
->
block_groups
[
šdex
], 
li¡
) {

687 ià(&
©Œ
->©Œ =ğ
	`BTRFS_ATTR_PTR
(
¿id
, 
tÙ®_by‹s
))

688 
v®
 +ğ
block_group
->
Ëngth
;

690 
v®
 +ğ
block_group
->
u£d
;

692 
	`up_»ad
(&
sšfo
->
groups_£m
);

693  
	`sysfs_em™
(
buf
, "%Îu\n", 
v®
);

694 
	}
}

701 
©Œibu‹
 *
	g¿id_©Œs
[] = {

702 
BTRFS_ATTR_PTR
(
¿id
, 
tÙ®_by‹s
),

703 
BTRFS_ATTR_PTR
(
¿id
, 
u£d_by‹s
),

704 
NULL


706 
ATTRIBUTE_GROUPS
(
¿id
);

708 
	$»Ëa£_¿id_kobj
(
kobjeù
 *
kobj
)

710 
	`kä“
(
	`to_¿id_kobj
(
kobj
));

711 
	}
}

713 cÚ¡ 
kobj_ty³
 
	gbŒfs_¿id_kty³
 = {

714 .
sysfs_İs
 = &
kobj_sysfs_İs
,

715 .
	g»Ëa£
 = 
»Ëa£_¿id_kobj
,

716 .
	gdeçuÉ_groups
 = 
¿id_groups
,

719 
	#SPACE_INFO_ATTR
(
f›ld
) \

720 
ssize_t
 
bŒfs_¥aû_šfo_show_
##
	`f›ld
(
kobjeù
 *
kobj
, \

721 
kobj_©Œibu‹
 *
a
, \

722 *
buf
) \

724 
bŒfs_¥aû_šfo
 *
sšfo
 = 
	`to_¥aû_šfo
(
kobj
); \

725  
	`bŒfs_show_u64
(&
sšfo
->
f›ld
, &sšfo->
lock
, 
buf
); \

727 
	`BTRFS_ATTR
(
¥aû_šfo
, 
f›ld
, 
bŒfs_¥aû_šfo_show_
##f›ld)

	)

729 
ssize_t
 
	$bŒfs_chunk_size_show
(
kobjeù
 *
kobj
,

730 
kobj_©Œibu‹
 *
a
, *
buf
)

732 
bŒfs_¥aû_šfo
 *
sšfo
 = 
	`to_¥aû_šfo
(
kobj
);

734  
	`sysfs_em™
(
buf
, "%Îu\n", 
	`READ_ONCE
(
sšfo
->
chunk_size
));

735 
	}
}

744 
ssize_t
 
	$bŒfs_chunk_size_¡Üe
(
kobjeù
 *
kobj
,

745 
kobj_©Œibu‹
 *
a
,

746 cÚ¡ *
buf
, 
size_t
 
Ën
)

748 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
	`to_¥aû_šfo
(
kobj
);

749 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
	`g‘_bŒfs_kobj
(
kobj
));

750 *
»Œ
;

751 
u64
 
v®
;

753 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

754  -
EPERM
;

756 ià(!
fs_šfo
->
fs_deviûs
)

757  -
EINVAL
;

759 ià(
	`bŒfs_is_zÚed
(
fs_šfo
))

760  -
EINVAL
;

763 ià(
¥aû_šfo
->
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

764  -
EPERM
;

766 
v®
 = 
	`mem·r£
(
buf
, &
»Œ
);

768 
»Œ
 = 
	`sk_¥aûs
(retptr);

769 ià(*
»Œ
 !ğ0 || 
v®
 == 0)

770  -
EINVAL
;

772 
v®
 = 
	`mš
(v®, 
BTRFS_MAX_DATA_CHUNK_SIZE
);

775 
v®
 = 
	`mš
(
	`muÉ_³rc
(
fs_šfo
->
fs_deviûs
->
tÙ®_rw_by‹s
, 10), val);

778 
v®
 &ğ~((
u64
)
SZ_256M
 - 1);

781 ià(
v®
 < 
SZ_256M
)

782  -
EINVAL
;

784 
	`bŒfs_upd©e_¥aû_šfo_chunk_size
(
¥aû_šfo
, 
v®
);

786  
Ën
;

787 
	}
}

789 
ssize_t
 
	$bŒfs_size_şas£s_show
(
kobjeù
 *
kobj
,

790 
kobj_©Œibu‹
 *
a
, *
buf
)

792 
bŒfs_¥aû_šfo
 *
sšfo
 = 
	`to_¥aû_šfo
(
kobj
);

793 
bŒfs_block_group
 *
bg
;

794 
u32
 
nÚe
 = 0;

795 
u32
 
sm®l
 = 0;

796 
u32
 
medium
 = 0;

797 
u32
 
Ïrge
 = 0;

799 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; ++i) {

800 
	`down_»ad
(&
sšfo
->
groups_£m
);

801 
	`li¡_fÜ_—ch_’Œy
(
bg
, &
sšfo
->
block_groups
[
i
], 
li¡
) {

802 ià(!
	`bŒfs_block_group_should_u£_size_şass
(
bg
))

804 
bg
->
size_şass
) {

805 
BTRFS_BG_SZ_NONE
:

806 
nÚe
++;

808 
BTRFS_BG_SZ_SMALL
:

809 
sm®l
++;

811 
BTRFS_BG_SZ_MEDIUM
:

812 
medium
++;

814 
BTRFS_BG_SZ_LARGE
:

815 
Ïrge
++;

819 
	`up_»ad
(&
sšfo
->
groups_£m
);

821  
	`sysfs_em™
(
buf
, "none %u\n"

825 
nÚe
, 
sm®l
, 
medium
, 
Ïrge
);

826 
	}
}

828 #ifdeà
CONFIG_BTRFS_DEBUG


832 
ssize_t
 
	$bŒfs_fÜû_chunk_®loc_¡Üe
(
kobjeù
 *
kobj
,

833 
kobj_©Œibu‹
 *
a
,

834 cÚ¡ *
buf
, 
size_t
 
Ën
)

836 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
	`to_¥aû_šfo
(
kobj
);

837 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
	`g‘_bŒfs_kobj
(
kobj
));

838 
bŒfs_Œªs_hªdË
 *
Œªs
;

839 
boŞ
 
v®
;

840 
»t
;

842 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

843  -
EPERM
;

845 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
))

846  -
EROFS
;

848 
»t
 = 
	`k¡¹oboŞ
(
buf
, &
v®
);

849 ià(
»t
)

850  
»t
;

852 ià(!
v®
)

853  -
EINVAL
;

859 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
fs_šfo
->
Œ“_roÙ
, 0);

860 ià(
	`IS_ERR
(
Œªs
))

861  
	`PTR_ERR
(
Œªs
);

862 
»t
 = 
	`bŒfs_fÜû_chunk_®loc
(
Œªs
, 
¥aû_šfo
->
æags
);

863 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

865 ià(
»t
 == 1)

866  
Ën
;

868  -
ENOSPC
;

869 
	}
}

870 
BTRFS_ATTR_W
(
¥aû_šfo
, 
fÜû_chunk_®loc
, 
bŒfs_fÜû_chunk_®loc_¡Üe
);

874 
SPACE_INFO_ATTR
(
æags
);

875 
SPACE_INFO_ATTR
(
tÙ®_by‹s
);

876 
SPACE_INFO_ATTR
(
by‹s_u£d
);

877 
SPACE_INFO_ATTR
(
by‹s_pšÃd
);

878 
SPACE_INFO_ATTR
(
by‹s_»£rved
);

879 
SPACE_INFO_ATTR
(
by‹s_may_u£
);

880 
SPACE_INFO_ATTR
(
by‹s_»adÚly
);

881 
SPACE_INFO_ATTR
(
by‹s_zÚe_unu§bË
);

882 
SPACE_INFO_ATTR
(
disk_u£d
);

883 
SPACE_INFO_ATTR
(
disk_tÙ®
);

884 
BTRFS_ATTR_RW
(
¥aû_šfo
, 
chunk_size
, 
bŒfs_chunk_size_show
, 
bŒfs_chunk_size_¡Üe
);

885 
BTRFS_ATTR
(
¥aû_šfo
, 
size_şas£s
, 
bŒfs_size_şas£s_show
);

887 
ssize_t
 
	$bŒfs_sšfo_bg_»şaim_th»shŞd_show
(
kobjeù
 *
kobj
,

888 
kobj_©Œibu‹
 *
a
,

889 *
buf
)

891 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
	`to_¥aû_šfo
(
kobj
);

893  
	`sysfs_em™
(
buf
, "%d\n", 
	`READ_ONCE
(
¥aû_šfo
->
bg_»şaim_th»shŞd
));

894 
	}
}

896 
ssize_t
 
	$bŒfs_sšfo_bg_»şaim_th»shŞd_¡Üe
(
kobjeù
 *
kobj
,

897 
kobj_©Œibu‹
 *
a
,

898 cÚ¡ *
buf
, 
size_t
 
Ën
)

900 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
	`to_¥aû_šfo
(
kobj
);

901 
th»sh
;

902 
»t
;

904 
»t
 = 
	`k¡¹ošt
(
buf
, 10, &
th»sh
);

905 ià(
»t
)

906  
»t
;

908 ià(
th»sh
 < 0 ||hresh > 100)

909  -
EINVAL
;

911 
	`WRITE_ONCE
(
¥aû_šfo
->
bg_»şaim_th»shŞd
, 
th»sh
);

913  
Ën
;

914 
	}
}

916 
BTRFS_ATTR_RW
(
¥aû_šfo
, 
bg_»şaim_th»shŞd
,

917 
bŒfs_sšfo_bg_»şaim_th»shŞd_show
,

918 
bŒfs_sšfo_bg_»şaim_th»shŞd_¡Üe
);

925 
©Œibu‹
 *
	g¥aû_šfo_©Œs
[] = {

926 
BTRFS_ATTR_PTR
(
¥aû_šfo
, 
æags
),

927 
BTRFS_ATTR_PTR
(
¥aû_šfo
, 
tÙ®_by‹s
),

928 
BTRFS_ATTR_PTR
(
¥aû_šfo
, 
by‹s_u£d
),

929 
BTRFS_ATTR_PTR
(
¥aû_šfo
, 
by‹s_pšÃd
),

930 
BTRFS_ATTR_PTR
(
¥aû_šfo
, 
by‹s_»£rved
),

931 
BTRFS_ATTR_PTR
(
¥aû_šfo
, 
by‹s_may_u£
),

932 
BTRFS_ATTR_PTR
(
¥aû_šfo
, 
by‹s_»adÚly
),

933 
BTRFS_ATTR_PTR
(
¥aû_šfo
, 
by‹s_zÚe_unu§bË
),

934 
BTRFS_ATTR_PTR
(
¥aû_šfo
, 
disk_u£d
),

935 
BTRFS_ATTR_PTR
(
¥aû_šfo
, 
disk_tÙ®
),

936 
BTRFS_ATTR_PTR
(
¥aû_šfo
, 
bg_»şaim_th»shŞd
),

937 
BTRFS_ATTR_PTR
(
¥aû_šfo
, 
chunk_size
),

938 
BTRFS_ATTR_PTR
(
¥aû_šfo
, 
size_şas£s
),

939 #ifdeà
CONFIG_BTRFS_DEBUG


940 
BTRFS_ATTR_PTR
(
¥aû_šfo
, 
fÜû_chunk_®loc
),

942 
NULL
,

944 
ATTRIBUTE_GROUPS
(
¥aû_šfo
);

946 
	$¥aû_šfo_»Ëa£
(
kobjeù
 *
kobj
)

948 
bŒfs_¥aû_šfo
 *
sšfo
 = 
	`to_¥aû_šfo
(
kobj
);

949 
	`kä“
(
sšfo
);

950 
	}
}

952 cÚ¡ 
kobj_ty³
 
	g¥aû_šfo_kty³
 = {

953 .
sysfs_İs
 = &
kobj_sysfs_İs
,

954 .
	g»Ëa£
 = 
¥aû_šfo_»Ëa£
,

955 .
	gdeçuÉ_groups
 = 
¥aû_šfo_groups
,

963 cÚ¡ 
©Œibu‹
 *
	g®loÿtiÚ_©Œs
[] = {

964 
BTRFS_ATTR_PTR
(
®loÿtiÚ
, 
glob®_rsv_»£rved
),

965 
BTRFS_ATTR_PTR
(
®loÿtiÚ
, 
glob®_rsv_size
),

966 
NULL
,

969 
ssize_t
 
	$bŒfs_Ïb–_show
(
kobjeù
 *
kobj
,

970 
kobj_©Œibu‹
 *
a
, *
buf
)

972 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

973 *
Ïb–
 = 
fs_šfo
->
su³r_cİy
->label;

974 
ssize_t
 
»t
;

976 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

977 
»t
 = 
	`sysfs_em™
(
buf
, 
Ïb–
[0] ? "%s\n" : "%s",†abel);

978 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

980  
»t
;

981 
	}
}

983 
ssize_t
 
	$bŒfs_Ïb–_¡Üe
(
kobjeù
 *
kobj
,

984 
kobj_©Œibu‹
 *
a
,

985 cÚ¡ *
buf
, 
size_t
 
Ën
)

987 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

988 
size_t
 
p_Ën
;

990 ià(!
fs_šfo
)

991  -
EPERM
;

993 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
))

994  -
EROFS
;

1000 
p_Ën
 = 
	`¡rc¥n
(
buf
, "\n");

1002 ià(
p_Ën
 >ğ
BTRFS_LABEL_SIZE
)

1003  -
EINVAL
;

1005 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

1006 
	`mem£t
(
fs_šfo
->
su³r_cİy
->
Ïb–
, 0, 
BTRFS_LABEL_SIZE
);

1007 
	`memıy
(
fs_šfo
->
su³r_cİy
->
Ïb–
, 
buf
, 
p_Ën
);

1008 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

1013 
	`£t_b™
(
BTRFS_FS_NEED_TRANS_COMMIT
, &
fs_šfo
->
æags
);

1014 
	`wake_up_´oûss
(
fs_šfo
->
Œª§ùiÚ_kth»ad
);

1016  
Ën
;

1017 
	}
}

1018 
BTRFS_ATTR_RW
(, 
Ïb–
, 
bŒfs_Ïb–_show
, 
bŒfs_Ïb–_¡Üe
);

1020 
ssize_t
 
	$bŒfs_nodesize_show
(
kobjeù
 *
kobj
,

1021 
kobj_©Œibu‹
 *
a
, *
buf
)

1023 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

1025  
	`sysfs_em™
(
buf
, "%u\n", 
fs_šfo
->
su³r_cİy
->
nodesize
);

1026 
	}
}

1028 
BTRFS_ATTR
(, 
nodesize
, 
bŒfs_nodesize_show
);

1030 
ssize_t
 
	$bŒfs_£ùÜsize_show
(
kobjeù
 *
kobj
,

1031 
kobj_©Œibu‹
 *
a
, *
buf
)

1033 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

1035  
	`sysfs_em™
(
buf
, "%u\n", 
fs_šfo
->
su³r_cİy
->
£ùÜsize
);

1036 
	}
}

1038 
BTRFS_ATTR
(, 
£ùÜsize
, 
bŒfs_£ùÜsize_show
);

1040 
ssize_t
 
	$bŒfs_comm™_¡©s_show
(
kobjeù
 *
kobj
,

1041 
kobj_©Œibu‹
 *
a
, *
buf
)

1043 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

1045  
	`sysfs_em™
(
buf
,

1050 
fs_šfo
->
comm™_¡©s
.
comm™_couÁ
,

1051 
	`div_u64
(
fs_šfo
->
comm™_¡©s
.
Ï¡_comm™_dur
, 
NSEC_PER_MSEC
),

1052 
	`div_u64
(
fs_šfo
->
comm™_¡©s
.
max_comm™_dur
, 
NSEC_PER_MSEC
),

1053 
	`div_u64
(
fs_šfo
->
comm™_¡©s
.
tÙ®_comm™_dur
, 
NSEC_PER_MSEC
));

1054 
	}
}

1056 
ssize_t
 
	$bŒfs_comm™_¡©s_¡Üe
(
kobjeù
 *
kobj
,

1057 
kobj_©Œibu‹
 *
a
,

1058 cÚ¡ *
buf
, 
size_t
 
Ën
)

1060 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

1061 
v®
;

1062 
»t
;

1064 ià(!
fs_šfo
)

1065  -
EPERM
;

1067 ià(!
	`ÿ·bË
(
CAP_SYS_RESOURCE
))

1068  -
EPERM
;

1070 
»t
 = 
	`k¡¹oul
(
buf
, 10, &
v®
);

1071 ià(
»t
)

1072  
»t
;

1073 ià(
v®
)

1074  -
EINVAL
;

1076 
	`WRITE_ONCE
(
fs_šfo
->
comm™_¡©s
.
max_comm™_dur
, 0);

1078  
Ën
;

1079 
	}
}

1080 
BTRFS_ATTR_RW
(, 
comm™_¡©s
, 
bŒfs_comm™_¡©s_show
, 
bŒfs_comm™_¡©s_¡Üe
);

1082 
ssize_t
 
	$bŒfs_şÚe_®ignm’t_show
(
kobjeù
 *
kobj
,

1083 
kobj_©Œibu‹
 *
a
, *
buf
)

1085 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

1087  
	`sysfs_em™
(
buf
, "%u\n", 
fs_šfo
->
su³r_cİy
->
£ùÜsize
);

1088 
	}
}

1090 
BTRFS_ATTR
(, 
şÚe_®ignm’t
, 
bŒfs_şÚe_®ignm’t_show
);

1092 
ssize_t
 
	$quÙa_ov”ride_show
(
kobjeù
 *
kobj
,

1093 
kobj_©Œibu‹
 *
a
, *
buf
)

1095 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

1096 
quÙa_ov”ride
;

1098 
quÙa_ov”ride
 = 
	`‹¡_b™
(
BTRFS_FS_QUOTA_OVERRIDE
, &
fs_šfo
->
æags
);

1099  
	`sysfs_em™
(
buf
, "%d\n", 
quÙa_ov”ride
);

1100 
	}
}

1102 
ssize_t
 
	$quÙa_ov”ride_¡Üe
(
kobjeù
 *
kobj
,

1103 
kobj_©Œibu‹
 *
a
,

1104 cÚ¡ *
buf
, 
size_t
 
Ën
)

1106 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

1107 
knob
;

1108 
”r
;

1110 ià(!
fs_šfo
)

1111  -
EPERM
;

1113 ià(!
	`ÿ·bË
(
CAP_SYS_RESOURCE
))

1114  -
EPERM
;

1116 
”r
 = 
	`k¡¹oul
(
buf
, 10, &
knob
);

1117 ià(
”r
)

1118  
”r
;

1119 ià(
knob
 > 1)

1120  -
EINVAL
;

1122 ià(
knob
)

1123 
	`£t_b™
(
BTRFS_FS_QUOTA_OVERRIDE
, &
fs_šfo
->
æags
);

1125 
	`ş—r_b™
(
BTRFS_FS_QUOTA_OVERRIDE
, &
fs_šfo
->
æags
);

1127  
Ën
;

1128 
	}
}

1130 
BTRFS_ATTR_RW
(, 
quÙa_ov”ride
, 
quÙa_ov”ride_show
, 
quÙa_ov”ride_¡Üe
);

1132 
ssize_t
 
	$bŒfs_m‘ad©a_uuid_show
(
kobjeù
 *
kobj
,

1133 
kobj_©Œibu‹
 *
a
, *
buf
)

1135 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

1137  
	`sysfs_em™
(
buf
, "%pU\n", 
fs_šfo
->
fs_deviûs
->
m‘ad©a_uuid
);

1138 
	}
}

1140 
BTRFS_ATTR
(, 
m‘ad©a_uuid
, 
bŒfs_m‘ad©a_uuid_show
);

1142 
ssize_t
 
	$bŒfs_checksum_show
(
kobjeù
 *
kobj
,

1143 
kobj_©Œibu‹
 *
a
, *
buf
)

1145 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

1146 
u16
 
csum_ty³
 = 
	`bŒfs_su³r_csum_ty³
(
fs_šfo
->
su³r_cİy
);

1148  
	`sysfs_em™
(
buf
, "%s (%s)\n",

1149 
	`bŒfs_su³r_csum_Çme
(
csum_ty³
),

1150 
	`üy±o_shash_driv”_Çme
(
fs_šfo
->
csum_shash
));

1151 
	}
}

1153 
BTRFS_ATTR
(, 
checksum
, 
bŒfs_checksum_show
);

1155 
ssize_t
 
	$bŒfs_exşusive_İ”©iÚ_show
(
kobjeù
 *
kobj
,

1156 
kobj_©Œibu‹
 *
a
, *
buf
)

1158 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

1159 cÚ¡ *
¡r
;

1161 
	`READ_ONCE
(
fs_šfo
->
exşusive_İ”©iÚ
)) {

1162 
BTRFS_EXCLOP_NONE
:

1163 
¡r
 = "none\n";

1165 
BTRFS_EXCLOP_BALANCE
:

1166 
¡r
 = "balance\n";

1168 
BTRFS_EXCLOP_BALANCE_PAUSED
:

1169 
¡r
 = "balance…aused\n";

1171 
BTRFS_EXCLOP_DEV_ADD
:

1172 
¡r
 = "device‡dd\n";

1174 
BTRFS_EXCLOP_DEV_REMOVE
:

1175 
¡r
 = "device„emove\n";

1177 
BTRFS_EXCLOP_DEV_REPLACE
:

1178 
¡r
 = "device„eplace\n";

1180 
BTRFS_EXCLOP_RESIZE
:

1181 
¡r
 = "resize\n";

1183 
BTRFS_EXCLOP_SWAP_ACTIVATE
:

1184 
¡r
 = "swap‡ctivate\n";

1187 
¡r
 = "UNKNOWN\n";

1190  
	`sysfs_em™
(
buf
, "%s", 
¡r
);

1191 
	}
}

1192 
BTRFS_ATTR
(, 
exşusive_İ”©iÚ
, 
bŒfs_exşusive_İ”©iÚ_show
);

1194 
ssize_t
 
	$bŒfs_g’”©iÚ_show
(
kobjeù
 *
kobj
,

1195 
kobj_©Œibu‹
 *
a
, *
buf
)

1197 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

1199  
	`sysfs_em™
(
buf
, "%Îu\n", 
fs_šfo
->
g’”©iÚ
);

1200 
	}
}

1201 
BTRFS_ATTR
(, 
g’”©iÚ
, 
bŒfs_g’”©iÚ_show
);

1203 cÚ¡ * cÚ¡ 
	gbŒfs_»ad_pŞicy_Çme
[] = { "pid" };

1205 
ssize_t
 
	$bŒfs_»ad_pŞicy_show
(
kobjeù
 *
kobj
,

1206 
kobj_©Œibu‹
 *
a
, *
buf
)

1208 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
	`to_fs_devs
(
kobj
);

1209 
ssize_t
 
»t
 = 0;

1210 
i
;

1212 
i
 = 0; i < 
BTRFS_NR_READ_POLICY
; i++) {

1213 ià(
fs_deviûs
->
»ad_pŞicy
 =ğ
i
)

1214 
»t
 +ğ
	`sysfs_em™_©
(
buf
,„et, "%s[%s]",

1215 (
»t
 == 0 ? "" : " "),

1216 
bŒfs_»ad_pŞicy_Çme
[
i
]);

1218 
»t
 +ğ
	`sysfs_em™_©
(
buf
,„et, "%s%s",

1219 (
»t
 == 0 ? "" : " "),

1220 
bŒfs_»ad_pŞicy_Çme
[
i
]);

1223 
»t
 +ğ
	`sysfs_em™_©
(
buf
,„et, "\n");

1225  
»t
;

1226 
	}
}

1228 
ssize_t
 
	$bŒfs_»ad_pŞicy_¡Üe
(
kobjeù
 *
kobj
,

1229 
kobj_©Œibu‹
 *
a
,

1230 cÚ¡ *
buf
, 
size_t
 
Ën
)

1232 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
	`to_fs_devs
(
kobj
);

1233 
i
;

1235 
i
 = 0; i < 
BTRFS_NR_READ_POLICY
; i++) {

1236 ià(
	`sysfs_¡»q
(
buf
, 
bŒfs_»ad_pŞicy_Çme
[
i
])) {

1237 ià(
i
 !ğ
fs_deviûs
->
»ad_pŞicy
) {

1238 
fs_deviûs
->
»ad_pŞicy
 = 
i
;

1239 
	`bŒfs_šfo
(
fs_deviûs
->
fs_šfo
,

1241 
bŒfs_»ad_pŞicy_Çme
[
i
]);

1243  
Ën
;

1247  -
EINVAL
;

1248 
	}
}

1249 
BTRFS_ATTR_RW
(, 
»ad_pŞicy
, 
bŒfs_»ad_pŞicy_show
, 
bŒfs_»ad_pŞicy_¡Üe
);

1251 
ssize_t
 
	$bŒfs_bg_»şaim_th»shŞd_show
(
kobjeù
 *
kobj
,

1252 
kobj_©Œibu‹
 *
a
,

1253 *
buf
)

1255 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

1257  
	`sysfs_em™
(
buf
, "%d\n", 
	`READ_ONCE
(
fs_šfo
->
bg_»şaim_th»shŞd
));

1258 
	}
}

1260 
ssize_t
 
	$bŒfs_bg_»şaim_th»shŞd_¡Üe
(
kobjeù
 *
kobj
,

1261 
kobj_©Œibu‹
 *
a
,

1262 cÚ¡ *
buf
, 
size_t
 
Ën
)

1264 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

1265 
th»sh
;

1266 
»t
;

1268 
»t
 = 
	`k¡¹ošt
(
buf
, 10, &
th»sh
);

1269 ià(
»t
)

1270  
»t
;

1272 #ifdeà
CONFIG_BTRFS_DEBUG


1273 ià(
th»sh
 != 0 && (thresh > 100))

1274  -
EINVAL
;

1276 ià(
th»sh
 != 0 && (thresh <= 50 ||hresh > 100))

1277  -
EINVAL
;

1280 
	`WRITE_ONCE
(
fs_šfo
->
bg_»şaim_th»shŞd
, 
th»sh
);

1282  
Ën
;

1283 
	}
}

1284 
BTRFS_ATTR_RW
(, 
bg_»şaim_th»shŞd
, 
bŒfs_bg_»şaim_th»shŞd_show
,

1285 
bŒfs_bg_»şaim_th»shŞd_¡Üe
);

1292 cÚ¡ 
©Œibu‹
 *
	gbŒfs_©Œs
[] = {

1293 
BTRFS_ATTR_PTR
(, 
Ïb–
),

1294 
BTRFS_ATTR_PTR
(, 
nodesize
),

1295 
BTRFS_ATTR_PTR
(, 
£ùÜsize
),

1296 
BTRFS_ATTR_PTR
(, 
şÚe_®ignm’t
),

1297 
BTRFS_ATTR_PTR
(, 
quÙa_ov”ride
),

1298 
BTRFS_ATTR_PTR
(, 
m‘ad©a_uuid
),

1299 
BTRFS_ATTR_PTR
(, 
checksum
),

1300 
BTRFS_ATTR_PTR
(, 
exşusive_İ”©iÚ
),

1301 
BTRFS_ATTR_PTR
(, 
g’”©iÚ
),

1302 
BTRFS_ATTR_PTR
(, 
»ad_pŞicy
),

1303 
BTRFS_ATTR_PTR
(, 
bg_»şaim_th»shŞd
),

1304 
BTRFS_ATTR_PTR
(, 
comm™_¡©s
),

1305 
NULL
,

1308 
	$bŒfs_»Ëa£_fsid_kobj
(
kobjeù
 *
kobj
)

1310 
bŒfs_fs_deviûs
 *
fs_devs
 = 
	`to_fs_devs
(
kobj
);

1312 
	`mem£t
(&
fs_devs
->
fsid_kobj
, 0, (
kobjeù
));

1313 
	`com¶‘e
(&
fs_devs
->
kobj_uÄegi¡”
);

1314 
	}
}

1316 cÚ¡ 
kobj_ty³
 
	gbŒfs_kty³
 = {

1317 .
sysfs_İs
 = &
kobj_sysfs_İs
,

1318 .
	g»Ëa£
 = 
bŒfs_»Ëa£_fsid_kobj
,

1321 
šlše
 
bŒfs_fs_deviûs
 *
	$to_fs_devs
(
kobjeù
 *
kobj
)

1323 ià(
kobj
->
kty³
 !ğ&
bŒfs_kty³
)

1324  
NULL
;

1325  
	`cÚš”_of
(
kobj
, 
bŒfs_fs_deviûs
, 
fsid_kobj
);

1326 
	}
}

1328 
šlše
 
bŒfs_fs_šfo
 *
	$to_fs_šfo
(
kobjeù
 *
kobj
)

1330 ià(
kobj
->
kty³
 !ğ&
bŒfs_kty³
)

1331  
NULL
;

1332  
	`to_fs_devs
(
kobj
)->
fs_šfo
;

1333 
	}
}

1335 
kobjeù
 *
	$g‘_bŒfs_kobj
(
kobjeù
 *
kobj
)

1337 
kobj
) {

1338 ià(
kobj
->
kty³
 =ğ&
bŒfs_kty³
)

1339  
kobj
;

1340 
kobj
 = kobj->
·»Á
;

1342  
NULL
;

1343 
	}
}

1345 
	#NUM_FEATURE_BITS
 64

	)

1346 
	#BTRFS_FEATURE_NAME_MAX
 13

	)

1347 
	gbŒfs_unknown_ã©u»_Çmes
[
FEAT_MAX
][
NUM_FEATURE_BITS
][
BTRFS_FEATURE_NAME_MAX
];

1348 
bŒfs_ã©u»_©Œ
 
	gbŒfs_ã©u»_©Œs
[
FEAT_MAX
][
NUM_FEATURE_BITS
];

1350 
¡©ic_as£¹
(
ARRAY_SIZE
(
bŒfs_unknown_ã©u»_Çmes
) ==

1351 
ARRAY_SIZE
(
bŒfs_ã©u»_©Œs
));

1352 
¡©ic_as£¹
(
ARRAY_SIZE
(
bŒfs_unknown_ã©u»_Çmes
[0]) ==

1353 
ARRAY_SIZE
(
bŒfs_ã©u»_©Œs
[0]));

1355 cÚ¡ 
u64
 
	gsuµÜ‹d_ã©u»_masks
[
FEAT_MAX
] = {

1356 [
FEAT_COMPAT
] = 
BTRFS_FEATURE_COMPAT_SUPP
,

1357 [
FEAT_COMPAT_RO
] = 
BTRFS_FEATURE_COMPAT_RO_SUPP
,

1358 [
FEAT_INCOMPAT
] = 
BTRFS_FEATURE_INCOMPAT_SUPP
,

1361 
	$addrm_unknown_ã©u»_©Œs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
boŞ
 
add
)

1363 
£t
;

1365 
£t
 = 0; s‘ < 
FEAT_MAX
; set++) {

1366 
i
;

1367 
©Œibu‹
 *
©Œs
[2];

1368 
©Œibu‹_group
 
agroup
 = {

1369 .
Çme
 = "features",

1370 .
©Œs
 =‡ttrs,

1372 
u64
 
ã©u»s
 = 
	`g‘_ã©u»s
(
fs_šfo
, 
£t
);

1373 
ã©u»s
 &ğ~
suµÜ‹d_ã©u»_masks
[
£t
];

1375 ià(!
ã©u»s
)

1378 
©Œs
[1] = 
NULL
;

1379 
i
 = 0; i < 
NUM_FEATURE_BITS
; i++) {

1380 
bŒfs_ã©u»_©Œ
 *
ç
;

1382 ià(!(
ã©u»s
 & (1ULL << 
i
)))

1385 
ç
 = &
bŒfs_ã©u»_©Œs
[
£t
][
i
];

1386 
©Œs
[0] = &
ç
->
kobj_©Œ
.
©Œ
;

1387 ià(
add
) {

1388 
»t
;

1389 
»t
 = 
	`sysfs_m”ge_group
(&
fs_šfo
->
fs_deviûs
->
fsid_kobj
,

1390 &
agroup
);

1391 ià(
»t
)

1392  
»t
;

1394 
	`sysfs_unm”ge_group
(&
fs_šfo
->
fs_deviûs
->
fsid_kobj
,

1395 &
agroup
);

1400 
	}
}

1402 
	$__bŒfs_sysfs_»move_fsid
(
bŒfs_fs_deviûs
 *
fs_devs
)

1404 ià(
fs_devs
->
devšfo_kobj
) {

1405 
	`kobjeù_d–
(
fs_devs
->
devšfo_kobj
);

1406 
	`kobjeù_put
(
fs_devs
->
devšfo_kobj
);

1407 
fs_devs
->
devšfo_kobj
 = 
NULL
;

1410 ià(
fs_devs
->
deviûs_kobj
) {

1411 
	`kobjeù_d–
(
fs_devs
->
deviûs_kobj
);

1412 
	`kobjeù_put
(
fs_devs
->
deviûs_kobj
);

1413 
fs_devs
->
deviûs_kobj
 = 
NULL
;

1416 ià(
fs_devs
->
fsid_kobj
.
¡©e_š™Ÿlized
) {

1417 
	`kobjeù_d–
(&
fs_devs
->
fsid_kobj
);

1418 
	`kobjeù_put
(&
fs_devs
->
fsid_kobj
);

1419 
	`wa™_fÜ_com¶‘iÚ
(&
fs_devs
->
kobj_uÄegi¡”
);

1421 
	}
}

1424 
	$bŒfs_sysfs_»move_fsid
(
bŒfs_fs_deviûs
 *
fs_devs
)

1426 
li¡_h—d
 *
fs_uuids
 = 
	`bŒfs_g‘_fs_uuids
();

1428 ià(
fs_devs
) {

1429 
	`__bŒfs_sysfs_»move_fsid
(
fs_devs
);

1433 
	`li¡_fÜ_—ch_’Œy
(
fs_devs
, 
fs_uuids
, 
fs_li¡
) {

1434 
	`__bŒfs_sysfs_»move_fsid
(
fs_devs
);

1436 
	}
}

1438 
	$bŒfs_sysfs_»move_fs_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
)

1440 
bŒfs_deviû
 *
deviû
;

1441 
bŒfs_fs_deviûs
 *
£ed
;

1443 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
)

1444 
	`bŒfs_sysfs_»move_deviû
(
deviû
);

1446 
	`li¡_fÜ_—ch_’Œy
(
£ed
, &
fs_deviûs
->
£ed_li¡
, seed_list) {

1447 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
£ed
->
deviûs
, 
dev_li¡
)

1448 
	`bŒfs_sysfs_»move_deviû
(
deviû
);

1450 
	}
}

1452 
	$bŒfs_sysfs_»move_mouÁed
(
bŒfs_fs_šfo
 *
fs_šfo
)

1454 
kobjeù
 *
fsid_kobj
 = &
fs_šfo
->
fs_deviûs
->fsid_kobj;

1456 
	`sysfs_»move_lšk
(
fsid_kobj
, "bdi");

1458 ià(
fs_šfo
->
¥aû_šfo_kobj
) {

1459 
	`sysfs_»move_fes
(
fs_šfo
->
¥aû_šfo_kobj
, 
®loÿtiÚ_©Œs
);

1460 
	`kobjeù_d–
(
fs_šfo
->
¥aû_šfo_kobj
);

1461 
	`kobjeù_put
(
fs_šfo
->
¥aû_šfo_kobj
);

1463 ià(
fs_šfo
->
disÿrd_kobj
) {

1464 
	`sysfs_»move_fes
(
fs_šfo
->
disÿrd_kobj
, 
disÿrd_©Œs
);

1465 
	`kobjeù_d–
(
fs_šfo
->
disÿrd_kobj
);

1466 
	`kobjeù_put
(
fs_šfo
->
disÿrd_kobj
);

1468 #ifdeà
CONFIG_BTRFS_DEBUG


1469 ià(
fs_šfo
->
debug_kobj
) {

1470 
	`sysfs_»move_fes
(
fs_šfo
->
debug_kobj
, 
bŒfs_debug_mouÁ_©Œs
);

1471 
	`kobjeù_d–
(
fs_šfo
->
debug_kobj
);

1472 
	`kobjeù_put
(
fs_šfo
->
debug_kobj
);

1475 
	`addrm_unknown_ã©u»_©Œs
(
fs_šfo
, 
çl£
);

1476 
	`sysfs_»move_group
(
fsid_kobj
, &
bŒfs_ã©u»_©Œ_group
);

1477 
	`sysfs_»move_fes
(
fsid_kobj
, 
bŒfs_©Œs
);

1478 
	`bŒfs_sysfs_»move_fs_deviûs
(
fs_šfo
->
fs_deviûs
);

1479 
	}
}

1481 cÚ¡ * cÚ¡ 
	gbŒfs_ã©u»_£t_Çmes
[
FEAT_MAX
] = {

1482 [
FEAT_COMPAT
] = "compat",

1483 [
FEAT_COMPAT_RO
] = "compat_ro",

1484 [
FEAT_INCOMPAT
] = "incompat",

1487 cÚ¡ *
	$bŒfs_ã©u»_£t_Çme
(
bŒfs_ã©u»_£t
 
£t
)

1489  
bŒfs_ã©u»_£t_Çmes
[
£t
];

1490 
	}
}

1492 *
	$bŒfs_´šbË_ã©u»s
(
bŒfs_ã©u»_£t
 
£t
, 
u64
 
æags
)

1494 
size_t
 
bufsize
 = 4096;

1495 
Ën
 = 0;

1496 
i
;

1497 *
¡r
;

1499 
¡r
 = 
	`km®loc
(
bufsize
, 
GFP_KERNEL
);

1500 ià(!
¡r
)

1501  
¡r
;

1503 
i
 = 0; i < 
	`ARRAY_SIZE
(
bŒfs_ã©u»_©Œs
[
£t
]); i++) {

1504 cÚ¡ *
Çme
;

1506 ià(!(
æags
 & (1ULL << 
i
)))

1509 
Çme
 = 
bŒfs_ã©u»_©Œs
[
£t
][
i
].
kobj_©Œ
.
©Œ
.name;

1510 
Ën
 +ğ
	`sú´štf
(
¡r
 +†’, 
bufsize
 -†en, "%s%s",

1511 
Ën
 ? "," : "", 
Çme
);

1514  
¡r
;

1515 
	}
}

1517 
	$š™_ã©u»_©Œs
()

1519 
bŒfs_ã©u»_©Œ
 *
ç
;

1520 
£t
, 
i
;

1522 
	`mem£t
(
bŒfs_ã©u»_©Œs
, 0, (btrfs_feature_attrs));

1523 
	`mem£t
(
bŒfs_unknown_ã©u»_Çmes
, 0,

1524 (
bŒfs_unknown_ã©u»_Çmes
));

1526 
i
 = 0; 
bŒfs_suµÜ‹d_ã©u»_©Œs
[i]; i++) {

1527 
bŒfs_ã©u»_©Œ
 *
sç
;

1528 
©Œibu‹
 *
a
 = 
bŒfs_suµÜ‹d_ã©u»_©Œs
[
i
];

1529 
b™
;

1530 
sç
 = 
	`©Œ_to_bŒfs_ã©u»_©Œ
(
a
);

1531 
b™
 = 
	`og2
(
sç
->
ã©u»_b™
);

1532 
ç
 = &
bŒfs_ã©u»_©Œs
[
sç
->
ã©u»_£t
][
b™
];

1534 
ç
->
kobj_©Œ
.
©Œ
.
Çme
 = 
sç
->kobj_attr.attr.name;

1537 
£t
 = 0; s‘ < 
FEAT_MAX
; set++) {

1538 
i
 = 0; i < 
	`ARRAY_SIZE
(
bŒfs_ã©u»_©Œs
[
£t
]); i++) {

1539 *
Çme
 = 
bŒfs_unknown_ã©u»_Çmes
[
£t
][
i
];

1540 
ç
 = &
bŒfs_ã©u»_©Œs
[
£t
][
i
];

1542 ià(
ç
->
kobj_©Œ
.
©Œ
.
Çme
)

1545 
	`¢´štf
(
Çme
, 
BTRFS_FEATURE_NAME_MAX
, "%s:%u",

1546 
bŒfs_ã©u»_£t_Çmes
[
£t
], 
i
);

1548 
ç
->
kobj_©Œ
.
©Œ
.
Çme
 =‚ame;

1549 
ç
->
kobj_©Œ
.
©Œ
.
mode
 = 
S_IRUGO
;

1550 
ç
->
ã©u»_£t
 = 
£t
;

1551 
ç
->
ã©u»_b™
 = 1ULL << 
i
;

1554 
	}
}

1560 
	$bŒfs_sysfs_add_block_group_ty³
(
bŒfs_block_group
 *
ÿche
)

1562 
bŒfs_fs_šfo
 *
fs_šfo
 = 
ÿche
->fs_info;

1563 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
ÿche
->space_info;

1564 
¿id_kobjeù
 *
rkobj
;

1565 cÚ¡ 
šdex
 = 
	`bŒfs_bg_æags_to_¿id_šdex
(
ÿche
->
æags
);

1566 
nofs_æag
;

1567 
»t
;

1576 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

1578 
rkobj
 = 
	`kz®loc
((*rkobj), 
GFP_NOFS
);

1579 ià(!
rkobj
) {

1580 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

1581 
	`bŒfs_w¬n
(
ÿche
->
fs_šfo
,

1586 
rkobj
->
æags
 = 
ÿche
->flags;

1587 
	`kobjeù_š™
(&
rkobj
->
kobj
, &
bŒfs_¿id_kty³
);

1598 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1599 ià(
¥aû_šfo
->
block_group_kobjs
[
šdex
]) {

1600 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1601 
	`kobjeù_put
(&
rkobj
->
kobj
);

1604 
¥aû_šfo
->
block_group_kobjs
[
šdex
] = &
rkobj
->
kobj
;

1606 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1608 
»t
 = 
	`kobjeù_add
(&
rkobj
->
kobj
, &
¥aû_šfo
->kobj, "%s",

1609 
	`bŒfs_bg_ty³_to_¿id_Çme
(
rkobj
->
æags
));

1610 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

1611 ià(
»t
) {

1612 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

1613 
¥aû_šfo
->
block_group_kobjs
[
šdex
] = 
NULL
;

1614 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

1615 
	`kobjeù_put
(&
rkobj
->
kobj
);

1616 
	`bŒfs_w¬n
(
fs_šfo
,

1620 
	}
}

1626 
	$bŒfs_sysfs_»move_¥aû_šfo
(
bŒfs_¥aû_šfo
 *
¥aû_šfo
)

1628 
i
;

1630 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; i++) {

1631 
kobjeù
 *
kobj
;

1633 
kobj
 = 
¥aû_šfo
->
block_group_kobjs
[
i
];

1634 
¥aû_šfo
->
block_group_kobjs
[
i
] = 
NULL
;

1635 ià(
kobj
) {

1636 
	`kobjeù_d–
(
kobj
);

1637 
	`kobjeù_put
(
kobj
);

1640 
	`kobjeù_d–
(&
¥aû_šfo
->
kobj
);

1641 
	`kobjeù_put
(&
¥aû_šfo
->
kobj
);

1642 
	}
}

1644 cÚ¡ *
	$®loc_Çme
(
u64
 
æags
)

1646 
æags
) {

1647 
BTRFS_BLOCK_GROUP_METADATA
 | 
BTRFS_BLOCK_GROUP_DATA
:

1649 
BTRFS_BLOCK_GROUP_METADATA
:

1651 
BTRFS_BLOCK_GROUP_DATA
:

1653 
BTRFS_BLOCK_GROUP_SYSTEM
:

1656 
	`WARN_ON
(1);

1659 
	}
}

1665 
	$bŒfs_sysfs_add_¥aû_šfo_ty³
(
bŒfs_fs_šfo
 *
fs_šfo
,

1666 
bŒfs_¥aû_šfo
 *
¥aû_šfo
)

1668 
»t
;

1670 
»t
 = 
	`kobjeù_š™_ªd_add
(&
¥aû_šfo
->
kobj
, &
¥aû_šfo_kty³
,

1671 
fs_šfo
->
¥aû_šfo_kobj
, "%s",

1672 
	`®loc_Çme
(
¥aû_šfo
->
æags
));

1673 ià(
»t
) {

1674 
	`kobjeù_put
(&
¥aû_šfo
->
kobj
);

1675  
»t
;

1679 
	}
}

1681 
	$bŒfs_sysfs_»move_deviû
(
bŒfs_deviû
 *
deviû
)

1683 
kobjeù
 *
deviûs_kobj
;

1689 
deviûs_kobj
 = 
deviû
->
fs_šfo
->
fs_deviûs
->devices_kobj;

1690 
	`ASSERT
(
deviûs_kobj
);

1692 ià(
deviû
->
bdev
)

1693 
	`sysfs_»move_lšk
(
deviûs_kobj
, 
	`bdev_kobj
(
deviû
->
bdev
)->
Çme
);

1695 ià(
deviû
->
devid_kobj
.
¡©e_š™Ÿlized
) {

1696 
	`kobjeù_d–
(&
deviû
->
devid_kobj
);

1697 
	`kobjeù_put
(&
deviû
->
devid_kobj
);

1698 
	`wa™_fÜ_com¶‘iÚ
(&
deviû
->
kobj_uÄegi¡”
);

1700 
	}
}

1702 
ssize_t
 
	$bŒfs_devšfo_š_fs_m‘ad©a_show
(
kobjeù
 *
kobj
,

1703 
kobj_©Œibu‹
 *
a
,

1704 *
buf
)

1706 
v®
;

1707 
bŒfs_deviû
 *
deviû
 = 
	`cÚš”_of
(
kobj
, btrfs_device,

1708 
devid_kobj
);

1710 
v®
 = !!
	`‹¡_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
deviû
->
dev_¡©e
);

1712  
	`sysfs_em™
(
buf
, "%d\n", 
v®
);

1713 
	}
}

1714 
BTRFS_ATTR
(
devid
, 
š_fs_m‘ad©a
, 
bŒfs_devšfo_š_fs_m‘ad©a_show
);

1716 
ssize_t
 
	$bŒfs_devšfo_missšg_show
(
kobjeù
 *
kobj
,

1717 
kobj_©Œibu‹
 *
a
, *
buf
)

1719 
v®
;

1720 
bŒfs_deviû
 *
deviû
 = 
	`cÚš”_of
(
kobj
, btrfs_device,

1721 
devid_kobj
);

1723 
v®
 = !!
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
, &
deviû
->
dev_¡©e
);

1725  
	`sysfs_em™
(
buf
, "%d\n", 
v®
);

1726 
	}
}

1727 
BTRFS_ATTR
(
devid
, 
missšg
, 
bŒfs_devšfo_missšg_show
);

1729 
ssize_t
 
	$bŒfs_devšfo_»¶aû_rg‘_show
(
kobjeù
 *
kobj
,

1730 
kobj_©Œibu‹
 *
a
,

1731 *
buf
)

1733 
v®
;

1734 
bŒfs_deviû
 *
deviû
 = 
	`cÚš”_of
(
kobj
, btrfs_device,

1735 
devid_kobj
);

1737 
v®
 = !!
	`‹¡_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
);

1739  
	`sysfs_em™
(
buf
, "%d\n", 
v®
);

1740 
	}
}

1741 
BTRFS_ATTR
(
devid
, 
»¶aû_rg‘
, 
bŒfs_devšfo_»¶aû_rg‘_show
);

1743 
ssize_t
 
	$bŒfs_devšfo_süub_¥“d_max_show
(
kobjeù
 *
kobj
,

1744 
kobj_©Œibu‹
 *
a
,

1745 *
buf
)

1747 
bŒfs_deviû
 *
deviû
 = 
	`cÚš”_of
(
kobj
, btrfs_device,

1748 
devid_kobj
);

1750  
	`sysfs_em™
(
buf
, "%Îu\n", 
	`READ_ONCE
(
deviû
->
süub_¥“d_max
));

1751 
	}
}

1753 
ssize_t
 
	$bŒfs_devšfo_süub_¥“d_max_¡Üe
(
kobjeù
 *
kobj
,

1754 
kobj_©Œibu‹
 *
a
,

1755 cÚ¡ *
buf
, 
size_t
 
Ën
)

1757 
bŒfs_deviû
 *
deviû
 = 
	`cÚš”_of
(
kobj
, btrfs_device,

1758 
devid_kobj
);

1759 *
’d±r
;

1760 
lim™
;

1762 
lim™
 = 
	`mem·r£
(
buf
, &
’d±r
);

1763 
	`WRITE_ONCE
(
deviû
->
süub_¥“d_max
, 
lim™
);

1764  
Ën
;

1765 
	}
}

1766 
BTRFS_ATTR_RW
(
devid
, 
süub_¥“d_max
, 
bŒfs_devšfo_süub_¥“d_max_show
,

1767 
bŒfs_devšfo_süub_¥“d_max_¡Üe
);

1769 
ssize_t
 
	$bŒfs_devšfo_wr™—bË_show
(
kobjeù
 *
kobj
,

1770 
kobj_©Œibu‹
 *
a
, *
buf
)

1772 
v®
;

1773 
bŒfs_deviû
 *
deviû
 = 
	`cÚš”_of
(
kobj
, btrfs_device,

1774 
devid_kobj
);

1776 
v®
 = !!
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
);

1778  
	`sysfs_em™
(
buf
, "%d\n", 
v®
);

1779 
	}
}

1780 
BTRFS_ATTR
(
devid
, 
wr™—bË
, 
bŒfs_devšfo_wr™—bË_show
);

1782 
ssize_t
 
	$bŒfs_devšfo_fsid_show
(
kobjeù
 *
kobj
,

1783 
kobj_©Œibu‹
 *
a
, *
buf
)

1785 
bŒfs_deviû
 *
deviû
 = 
	`cÚš”_of
(
kobj
, btrfs_device,

1786 
devid_kobj
);

1788  
	`sysfs_em™
(
buf
, "%pU\n", 
deviû
->
fs_deviûs
->
fsid
);

1789 
	}
}

1790 
BTRFS_ATTR
(
devid
, 
fsid
, 
bŒfs_devšfo_fsid_show
);

1792 
ssize_t
 
	$bŒfs_devšfo_”rÜ_¡©s_show
(
kobjeù
 *
kobj
,

1793 
kobj_©Œibu‹
 *
a
, *
buf
)

1795 
bŒfs_deviû
 *
deviû
 = 
	`cÚš”_of
(
kobj
, btrfs_device,

1796 
devid_kobj
);

1798 ià(!
deviû
->
dev_¡©s_v®id
)

1799  
	`sysfs_em™
(
buf
, "invalid\n");

1806  
	`sysfs_em™
(
buf
,

1812 
	`bŒfs_dev_¡©_»ad
(
deviû
, 
BTRFS_DEV_STAT_WRITE_ERRS
),

1813 
	`bŒfs_dev_¡©_»ad
(
deviû
, 
BTRFS_DEV_STAT_READ_ERRS
),

1814 
	`bŒfs_dev_¡©_»ad
(
deviû
, 
BTRFS_DEV_STAT_FLUSH_ERRS
),

1815 
	`bŒfs_dev_¡©_»ad
(
deviû
, 
BTRFS_DEV_STAT_CORRUPTION_ERRS
),

1816 
	`bŒfs_dev_¡©_»ad
(
deviû
, 
BTRFS_DEV_STAT_GENERATION_ERRS
));

1817 
	}
}

1818 
BTRFS_ATTR
(
devid
, 
”rÜ_¡©s
, 
bŒfs_devšfo_”rÜ_¡©s_show
);

1825 
©Œibu‹
 *
	gdevid_©Œs
[] = {

1826 
BTRFS_ATTR_PTR
(
devid
, 
”rÜ_¡©s
),

1827 
BTRFS_ATTR_PTR
(
devid
, 
fsid
),

1828 
BTRFS_ATTR_PTR
(
devid
, 
š_fs_m‘ad©a
),

1829 
BTRFS_ATTR_PTR
(
devid
, 
missšg
),

1830 
BTRFS_ATTR_PTR
(
devid
, 
»¶aû_rg‘
),

1831 
BTRFS_ATTR_PTR
(
devid
, 
süub_¥“d_max
),

1832 
BTRFS_ATTR_PTR
(
devid
, 
wr™—bË
),

1833 
NULL


1835 
ATTRIBUTE_GROUPS
(
devid
);

1837 
	$bŒfs_»Ëa£_devid_kobj
(
kobjeù
 *
kobj
)

1839 
bŒfs_deviû
 *
deviû
 = 
	`cÚš”_of
(
kobj
, btrfs_device,

1840 
devid_kobj
);

1842 
	`mem£t
(&
deviû
->
devid_kobj
, 0, (
kobjeù
));

1843 
	`com¶‘e
(&
deviû
->
kobj_uÄegi¡”
);

1844 
	}
}

1846 cÚ¡ 
kobj_ty³
 
	gdevid_kty³
 = {

1847 .
sysfs_İs
 = &
kobj_sysfs_İs
,

1848 .
	gdeçuÉ_groups
 = 
devid_groups
,

1849 .
	g»Ëa£
 = 
bŒfs_»Ëa£_devid_kobj
,

1852 
	$bŒfs_sysfs_add_deviû
(
bŒfs_deviû
 *
deviû
)

1854 
»t
;

1855 
nofs_æag
;

1856 
kobjeù
 *
deviûs_kobj
;

1857 
kobjeù
 *
devšfo_kobj
;

1863 
deviûs_kobj
 = 
deviû
->
fs_šfo
->
fs_deviûs
->devices_kobj;

1864 
devšfo_kobj
 = 
deviû
->
fs_šfo
->
fs_deviûs
->devinfo_kobj;

1865 
	`ASSERT
(
deviûs_kobj
);

1866 
	`ASSERT
(
devšfo_kobj
);

1868 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

1870 ià(
deviû
->
bdev
) {

1871 
kobjeù
 *
disk_kobj
 = 
	`bdev_kobj
(
deviû
->
bdev
);

1873 
»t
 = 
	`sysfs_ü—‹_lšk
(
deviûs_kobj
, 
disk_kobj
, disk_kobj->
Çme
);

1874 ià(
»t
) {

1875 
	`bŒfs_w¬n
(
deviû
->
fs_šfo
,

1877 
deviû
->
devid
, 
»t
);

1878 
out
;

1882 
	`š™_com¶‘iÚ
(&
deviû
->
kobj_uÄegi¡”
);

1883 
»t
 = 
	`kobjeù_š™_ªd_add
(&
deviû
->
devid_kobj
, &
devid_kty³
,

1884 
devšfo_kobj
, "%Îu", 
deviû
->
devid
);

1885 ià(
»t
) {

1886 
	`kobjeù_put
(&
deviû
->
devid_kobj
);

1887 
	`bŒfs_w¬n
(
deviû
->
fs_šfo
,

1889 
deviû
->
devid
, 
»t
);

1892 
out
:

1893 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

1894  
»t
;

1895 
	}
}

1897 
	$bŒfs_sysfs_add_fs_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
)

1899 
»t
;

1900 
bŒfs_deviû
 *
deviû
;

1901 
bŒfs_fs_deviûs
 *
£ed
;

1903 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

1904 
»t
 = 
	`bŒfs_sysfs_add_deviû
(
deviû
);

1905 ià(
»t
)

1906 
ç
;

1909 
	`li¡_fÜ_—ch_’Œy
(
£ed
, &
fs_deviûs
->
£ed_li¡
, seed_list) {

1910 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
£ed
->
deviûs
, 
dev_li¡
) {

1911 
»t
 = 
	`bŒfs_sysfs_add_deviû
(
deviû
);

1912 ià(
»t
)

1913 
ç
;

1919 
ç
:

1920 
	`bŒfs_sysfs_»move_fs_deviûs
(
fs_deviûs
);

1921  
»t
;

1922 
	}
}

1924 
	$bŒfs_kobjeù_uev’t
(
block_deviû
 *
bdev
, 
kobjeù_aùiÚ
 
aùiÚ
)

1926 
»t
;

1928 
»t
 = 
	`kobjeù_uev’t
(&
	`disk_to_dev
(
bdev
->
bd_disk
)->
kobj
, 
aùiÚ
);

1929 ià(
»t
)

1930 
	`´_w¬n
("BTRFS: Sendingƒvent '%d'o kobject: '%s' (%p): failed\n",

1931 
aùiÚ
, 
	`kobjeù_Çme
(&
	`disk_to_dev
(
bdev
->
bd_disk
)->
kobj
),

1932 &
	`disk_to_dev
(
bdev
->
bd_disk
)->
kobj
);

1933 
	}
}

1935 
	$bŒfs_sysfs_upd©e_¥rout_fsid
(
bŒfs_fs_deviûs
 *
fs_deviûs
)

1938 
fsid_buf
[
BTRFS_UUID_UNPARSED_SIZE
];

1944 
	`¢´štf
(
fsid_buf
, 
BTRFS_UUID_UNPARSED_SIZE
, "%pU", 
fs_deviûs
->
fsid
);

1945 ià(
	`kobjeù_»Çme
(&
fs_deviûs
->
fsid_kobj
, 
fsid_buf
))

1946 
	`bŒfs_w¬n
(
fs_deviûs
->
fs_šfo
,

1948 
	}
}

1950 
	$bŒfs_sysfs_upd©e_devid
(
bŒfs_deviû
 *
deviû
)

1952 
tmp
[24];

1954 
	`¢´štf
(
tmp
, Ñmp), "%Îu", 
deviû
->
devid
);

1956 ià(
	`kobjeù_»Çme
(&
deviû
->
devid_kobj
, 
tmp
))

1957 
	`bŒfs_w¬n
(
deviû
->
fs_deviûs
->
fs_šfo
,

1959 
deviû
->
devid
);

1960 
	}
}

1963 
k£t
 *
	gbŒfs_k£t
;

1971 
	$bŒfs_sysfs_add_fsid
(
bŒfs_fs_deviûs
 *
fs_devs
)

1973 
”rÜ
;

1975 
	`š™_com¶‘iÚ
(&
fs_devs
->
kobj_uÄegi¡”
);

1976 
fs_devs
->
fsid_kobj
.
k£t
 = 
bŒfs_k£t
;

1977 
”rÜ
 = 
	`kobjeù_š™_ªd_add
(&
fs_devs
->
fsid_kobj
, &
bŒfs_kty³
, 
NULL
,

1978 "%pU", 
fs_devs
->
fsid
);

1979 ià(
”rÜ
) {

1980 
	`kobjeù_put
(&
fs_devs
->
fsid_kobj
);

1981  
”rÜ
;

1984 
fs_devs
->
deviûs_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("devices",

1985 &
fs_devs
->
fsid_kobj
);

1986 ià(!
fs_devs
->
deviûs_kobj
) {

1987 
	`bŒfs_”r
(
fs_devs
->
fs_šfo
,

1989 
	`bŒfs_sysfs_»move_fsid
(
fs_devs
);

1990  -
ENOMEM
;

1993 
fs_devs
->
devšfo_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("devinfo",

1994 &
fs_devs
->
fsid_kobj
);

1995 ià(!
fs_devs
->
devšfo_kobj
) {

1996 
	`bŒfs_”r
(
fs_devs
->
fs_šfo
,

1998 
	`bŒfs_sysfs_»move_fsid
(
fs_devs
);

1999  -
ENOMEM
;

2003 
	}
}

2005 
	$bŒfs_sysfs_add_mouÁed
(
bŒfs_fs_šfo
 *
fs_šfo
)

2007 
”rÜ
;

2008 
bŒfs_fs_deviûs
 *
fs_devs
 = 
fs_šfo
->
fs_deviûs
;

2009 
kobjeù
 *
fsid_kobj
 = &
fs_devs
->fsid_kobj;

2011 
”rÜ
 = 
	`bŒfs_sysfs_add_fs_deviûs
(
fs_devs
);

2012 ià(
”rÜ
)

2013  
”rÜ
;

2015 
”rÜ
 = 
	`sysfs_ü—‹_fes
(
fsid_kobj
, 
bŒfs_©Œs
);

2016 ià(
”rÜ
) {

2017 
	`bŒfs_sysfs_»move_fs_deviûs
(
fs_devs
);

2018  
”rÜ
;

2021 
”rÜ
 = 
	`sysfs_ü—‹_group
(
fsid_kobj
,

2022 &
bŒfs_ã©u»_©Œ_group
);

2023 ià(
”rÜ
)

2024 
çu»
;

2026 #ifdeà
CONFIG_BTRFS_DEBUG


2027 
fs_šfo
->
debug_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("debug", 
fsid_kobj
);

2028 ià(!
fs_šfo
->
debug_kobj
) {

2029 
”rÜ
 = -
ENOMEM
;

2030 
çu»
;

2033 
”rÜ
 = 
	`sysfs_ü—‹_fes
(
fs_šfo
->
debug_kobj
, 
bŒfs_debug_mouÁ_©Œs
);

2034 ià(
”rÜ
)

2035 
çu»
;

2039 
fs_šfo
->
disÿrd_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("disÿrd", 
fsid_kobj
);

2040 ià(!
fs_šfo
->
disÿrd_kobj
) {

2041 
”rÜ
 = -
ENOMEM
;

2042 
çu»
;

2045 
”rÜ
 = 
	`sysfs_ü—‹_fes
(
fs_šfo
->
disÿrd_kobj
, 
disÿrd_©Œs
);

2046 ià(
”rÜ
)

2047 
çu»
;

2049 
”rÜ
 = 
	`addrm_unknown_ã©u»_©Œs
(
fs_šfo
, 
Œue
);

2050 ià(
”rÜ
)

2051 
çu»
;

2053 
”rÜ
 = 
	`sysfs_ü—‹_lšk
(
fsid_kobj
, &
fs_šfo
->
sb
->
s_bdi
->
dev
->
kobj
, "bdi");

2054 ià(
”rÜ
)

2055 
çu»
;

2057 
fs_šfo
->
¥aû_šfo_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("allocation",

2058 
fsid_kobj
);

2059 ià(!
fs_šfo
->
¥aû_šfo_kobj
) {

2060 
”rÜ
 = -
ENOMEM
;

2061 
çu»
;

2064 
”rÜ
 = 
	`sysfs_ü—‹_fes
(
fs_šfo
->
¥aû_šfo_kobj
, 
®loÿtiÚ_©Œs
);

2065 ià(
”rÜ
)

2066 
çu»
;

2069 
çu»
:

2070 
	`bŒfs_sysfs_»move_mouÁed
(
fs_šfo
);

2071  
”rÜ
;

2072 
	}
}

2074 
ssize_t
 
	$qgroup_’abËd_show
(
kobjeù
 *
qgroups_kobj
,

2075 
kobj_©Œibu‹
 *
a
,

2076 *
buf
)

2078 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
qgroups_kobj
->
·»Á
);

2079 
boŞ
 
’abËd
;

2081 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2082 
’abËd
 = 
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_ON
;

2083 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2085  
	`sysfs_em™
(
buf
, "%d\n", 
’abËd
);

2086 
	}
}

2087 
BTRFS_ATTR
(
qgroups
, 
’abËd
, 
qgroup_’abËd_show
);

2089 
ssize_t
 
	$qgroup_šcÚsi¡’t_show
(
kobjeù
 *
qgroups_kobj
,

2090 
kobj_©Œibu‹
 *
a
,

2091 *
buf
)

2093 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
qgroups_kobj
->
·»Á
);

2094 
boŞ
 
šcÚsi¡’t
;

2096 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2097 
šcÚsi¡’t
 = (
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
);

2098 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2100  
	`sysfs_em™
(
buf
, "%d\n", 
šcÚsi¡’t
);

2101 
	}
}

2102 
BTRFS_ATTR
(
qgroups
, 
šcÚsi¡’t
, 
qgroup_šcÚsi¡’t_show
);

2104 
ssize_t
 
	$qgroup_drİ_subŒ“_th»s_show
(
kobjeù
 *
qgroups_kobj
,

2105 
kobj_©Œibu‹
 *
a
,

2106 *
buf
)

2108 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
qgroups_kobj
->
·»Á
);

2109 
u8
 
»suÉ
;

2111 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2112 
»suÉ
 = 
fs_šfo
->
qgroup_drİ_subŒ“_th»s
;

2113 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2115  
	`sysfs_em™
(
buf
, "%d\n", 
»suÉ
);

2116 
	}
}

2118 
ssize_t
 
	$qgroup_drİ_subŒ“_th»s_¡Üe
(
kobjeù
 *
qgroups_kobj
,

2119 
kobj_©Œibu‹
 *
a
,

2120 cÚ¡ *
buf
, 
size_t
 
Ën
)

2122 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
qgroups_kobj
->
·»Á
);

2123 
u8
 
Ãw_th»s
;

2124 
»t
;

2126 
»t
 = 
	`k¡¹ou8
(
buf
, 10, &
Ãw_th»s
);

2127 ià(
»t
)

2128  -
EINVAL
;

2130 ià(
Ãw_th»s
 > 
BTRFS_MAX_LEVEL
)

2131  -
EINVAL
;

2133 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2134 
fs_šfo
->
qgroup_drİ_subŒ“_th»s
 = 
Ãw_th»s
;

2135 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2137  
Ën
;

2138 
	}
}

2139 
BTRFS_ATTR_RW
(
qgroups
, 
drİ_subŒ“_th»shŞd
, 
qgroup_drİ_subŒ“_th»s_show
,

2140 
qgroup_drİ_subŒ“_th»s_¡Üe
);

2147 
©Œibu‹
 *
	gqgroups_©Œs
[] = {

2148 
BTRFS_ATTR_PTR
(
qgroups
, 
’abËd
),

2149 
BTRFS_ATTR_PTR
(
qgroups
, 
šcÚsi¡’t
),

2150 
BTRFS_ATTR_PTR
(
qgroups
, 
drİ_subŒ“_th»shŞd
),

2151 
NULL


2153 
ATTRIBUTE_GROUPS
(
qgroups
);

2155 
	$qgroups_»Ëa£
(
kobjeù
 *
kobj
)

2157 
	`kä“
(
kobj
);

2158 
	}
}

2160 cÚ¡ 
kobj_ty³
 
	gqgroups_kty³
 = {

2161 .
sysfs_İs
 = &
kobj_sysfs_İs
,

2162 .
	gdeçuÉ_groups
 = 
qgroups_groups
,

2163 .
	g»Ëa£
 = 
qgroups_»Ëa£
,

2166 
šlše
 
bŒfs_fs_šfo
 *
	$qgroup_kobj_to_fs_šfo
(
kobjeù
 *
kobj
)

2168  
	`to_fs_šfo
(
kobj
->
·»Á
->parent);

2169 
	}
}

2171 
	#QGROUP_ATTR
(
_memb”
, 
_show_Çme
) \

2172 
ssize_t
 
bŒfs_qgroup_show_
##
	`_memb”
(
kobjeù
 *
qgroup_kobj
, \

2173 
kobj_©Œibu‹
 *
a
, \

2174 *
buf
) \

2176 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`qgroup_kobj_to_fs_šfo
(
qgroup_kobj
); \

2177 
bŒfs_qgroup
 *
qgroup
 = 
	`cÚš”_of
(
qgroup_kobj
, \

2178 
bŒfs_qgroup
, 
kobj
); \

2179  
	`bŒfs_show_u64
(&
qgroup
->
_memb”
, &
fs_šfo
->
qgroup_lock
, 
buf
); \

2181 
	`BTRFS_ATTR
(
qgroup
, 
_show_Çme
, 
bŒfs_qgroup_show_
##
_memb”
)

	)

2183 
	#QGROUP_RSV_ATTR
(
_Çme
, 
_ty³
) \

2184 
ssize_t
 
bŒfs_qgroup_rsv_show_
##
	`_Çme
(
kobjeù
 *
qgroup_kobj
, \

2185 
kobj_©Œibu‹
 *
a
, \

2186 *
buf
) \

2188 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`qgroup_kobj_to_fs_šfo
(
qgroup_kobj
); \

2189 
bŒfs_qgroup
 *
qgroup
 = 
	`cÚš”_of
(
qgroup_kobj
, \

2190 
bŒfs_qgroup
, 
kobj
); \

2191  
	`bŒfs_show_u64
(&
qgroup
->
rsv
.
v®ues
[
_ty³
], \

2192 &
fs_šfo
->
qgroup_lock
, 
buf
); \

2194 
	`BTRFS_ATTR
(
qgroup
, 
rsv_
##
_Çme
, 
bŒfs_qgroup_rsv_show_
##_Çme)

	)

2196 
QGROUP_ATTR
(
rãr
, 
»ã»nûd
);

2197 
QGROUP_ATTR
(
exş
, 
exşusive
);

2198 
QGROUP_ATTR
(
max_rãr
, 
max_»ã»nûd
);

2199 
QGROUP_ATTR
(
max_exş
, 
max_exşusive
);

2200 
QGROUP_ATTR
(
lim_æags
, 
lim™_æags
);

2201 
QGROUP_RSV_ATTR
(
d©a
, 
BTRFS_QGROUP_RSV_DATA
);

2202 
QGROUP_RSV_ATTR
(
m‘a_³¹¿ns
, 
BTRFS_QGROUP_RSV_META_PERTRANS
);

2203 
QGROUP_RSV_ATTR
(
m‘a_´—Îoc
, 
BTRFS_QGROUP_RSV_META_PREALLOC
);

2210 
©Œibu‹
 *
	gqgroup_©Œs
[] = {

2211 
BTRFS_ATTR_PTR
(
qgroup
, 
»ã»nûd
),

2212 
BTRFS_ATTR_PTR
(
qgroup
, 
exşusive
),

2213 
BTRFS_ATTR_PTR
(
qgroup
, 
max_»ã»nûd
),

2214 
BTRFS_ATTR_PTR
(
qgroup
, 
max_exşusive
),

2215 
BTRFS_ATTR_PTR
(
qgroup
, 
lim™_æags
),

2216 
BTRFS_ATTR_PTR
(
qgroup
, 
rsv_d©a
),

2217 
BTRFS_ATTR_PTR
(
qgroup
, 
rsv_m‘a_³¹¿ns
),

2218 
BTRFS_ATTR_PTR
(
qgroup
, 
rsv_m‘a_´—Îoc
),

2219 
NULL


2221 
ATTRIBUTE_GROUPS
(
qgroup
);

2223 
	$qgroup_»Ëa£
(
kobjeù
 *
kobj
)

2225 
bŒfs_qgroup
 *
qgroup
 = 
	`cÚš”_of
(
kobj
, btrfs_qgroup, kobj);

2227 
	`mem£t
(&
qgroup
->
kobj
, 0, (*kobj));

2228 
	}
}

2230 cÚ¡ 
kobj_ty³
 
	gqgroup_kty³
 = {

2231 .
sysfs_İs
 = &
kobj_sysfs_İs
,

2232 .
	g»Ëa£
 = 
qgroup_»Ëa£
,

2233 .
	gdeçuÉ_groups
 = 
qgroup_groups
,

2236 
	$bŒfs_sysfs_add_Úe_qgroup
(
bŒfs_fs_šfo
 *
fs_šfo
,

2237 
bŒfs_qgroup
 *
qgroup
)

2239 
kobjeù
 *
qgroups_kobj
 = 
fs_šfo
->qgroups_kobj;

2240 
»t
;

2242 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_šfo
->
fs_¡©e
))

2244 ià(
qgroup
->
kobj
.
¡©e_š™Ÿlized
)

2246 ià(!
qgroups_kobj
)

2247  -
EINVAL
;

2249 
»t
 = 
	`kobjeù_š™_ªd_add
(&
qgroup
->
kobj
, &
qgroup_kty³
, 
qgroups_kobj
,

2250 "%hu_%Îu", 
	`bŒfs_qgroup_Ëv–
(
qgroup
->
qgroupid
),

2251 
	`bŒfs_qgroup_subvŞid
(
qgroup
->
qgroupid
));

2252 ià(
»t
 < 0)

2253 
	`kobjeù_put
(&
qgroup
->
kobj
);

2255  
»t
;

2256 
	}
}

2258 
	$bŒfs_sysfs_d–_qgroups
(
bŒfs_fs_šfo
 *
fs_šfo
)

2260 
bŒfs_qgroup
 *
qgroup
;

2261 
bŒfs_qgroup
 *
Ãxt
;

2263 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_šfo
->
fs_¡©e
))

2266 
	`rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
qgroup
, 
Ãxt
,

2267 &
fs_šfo
->
qgroup_Œ“
, 
node
)

2268 
	`bŒfs_sysfs_d–_Úe_qgroup
(
fs_šfo
, 
qgroup
);

2269 ià(
fs_šfo
->
qgroups_kobj
) {

2270 
	`kobjeù_d–
(
fs_šfo
->
qgroups_kobj
);

2271 
	`kobjeù_put
(
fs_šfo
->
qgroups_kobj
);

2272 
fs_šfo
->
qgroups_kobj
 = 
NULL
;

2274 
	}
}

2277 
	$bŒfs_sysfs_add_qgroups
(
bŒfs_fs_šfo
 *
fs_šfo
)

2279 
kobjeù
 *
fsid_kobj
 = &
fs_šfo
->
fs_deviûs
->fsid_kobj;

2280 
bŒfs_qgroup
 *
qgroup
;

2281 
bŒfs_qgroup
 *
Ãxt
;

2282 
»t
 = 0;

2284 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_šfo
->
fs_¡©e
))

2287 
	`ASSERT
(
fsid_kobj
);

2288 ià(
fs_šfo
->
qgroups_kobj
)

2291 
fs_šfo
->
qgroups_kobj
 = 
	`kz®loc
((
kobjeù
), 
GFP_KERNEL
);

2292 ià(!
fs_šfo
->
qgroups_kobj
)

2293  -
ENOMEM
;

2295 
»t
 = 
	`kobjeù_š™_ªd_add
(
fs_šfo
->
qgroups_kobj
, &
qgroups_kty³
,

2296 
fsid_kobj
, "qgroups");

2297 ià(
»t
 < 0)

2298 
out
;

2300 
	`rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
qgroup
, 
Ãxt
,

2301 &
fs_šfo
->
qgroup_Œ“
, 
node
) {

2302 
»t
 = 
	`bŒfs_sysfs_add_Úe_qgroup
(
fs_šfo
, 
qgroup
);

2303 ià(
»t
 < 0)

2304 
out
;

2307 
out
:

2308 ià(
»t
 < 0)

2309 
	`bŒfs_sysfs_d–_qgroups
(
fs_šfo
);

2310  
»t
;

2311 
	}
}

2313 
	$bŒfs_sysfs_d–_Úe_qgroup
(
bŒfs_fs_šfo
 *
fs_šfo
,

2314 
bŒfs_qgroup
 *
qgroup
)

2316 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_šfo
->
fs_¡©e
))

2319 ià(
qgroup
->
kobj
.
¡©e_š™Ÿlized
) {

2320 
	`kobjeù_d–
(&
qgroup
->
kobj
);

2321 
	`kobjeù_put
(&
qgroup
->
kobj
);

2323 
	}
}

2329 
	$bŒfs_sysfs_ã©u»_upd©e
(
bŒfs_fs_šfo
 *
fs_šfo
)

2331 
kobjeù
 *
fsid_kobj
;

2332 
»t
;

2334 ià(!
fs_šfo
)

2337 
fsid_kobj
 = &
fs_šfo
->
fs_deviûs
->fsid_kobj;

2338 ià(!
fsid_kobj
->
¡©e_š™Ÿlized
)

2341 
»t
 = 
	`sysfs_upd©e_group
(
fsid_kobj
, &
bŒfs_ã©u»_©Œ_group
);

2342 ià(
»t
 < 0)

2343 
	`bŒfs_w¬n
(
fs_šfo
,

2345 
fs_šfo
->
fs_deviûs
->
fsid
, 
»t
);

2346 
	}
}

2348 
__š™
 
	$bŒfs_š™_sysfs
()

2350 
»t
;

2352 
bŒfs_k£t
 = 
	`k£t_ü—‹_ªd_add
("bŒfs", 
NULL
, 
fs_kobj
);

2353 ià(!
bŒfs_k£t
)

2354  -
ENOMEM
;

2356 
	`š™_ã©u»_©Œs
();

2357 
»t
 = 
	`sysfs_ü—‹_group
(&
bŒfs_k£t
->
kobj
, &
bŒfs_ã©u»_©Œ_group
);

2358 ià(
»t
)

2359 
out2
;

2360 
»t
 = 
	`sysfs_m”ge_group
(&
bŒfs_k£t
->
kobj
,

2361 &
bŒfs_¡©ic_ã©u»_©Œ_group
);

2362 ià(
»t
)

2363 
out_»move_group
;

2365 #ifdeà
CONFIG_BTRFS_DEBUG


2366 
»t
 = 
	`sysfs_ü—‹_group
(&
bŒfs_k£t
->
kobj
, &
bŒfs_debug_ã©u»_©Œ_group
);

2367 ià(
»t
) {

2368 
	`sysfs_unm”ge_group
(&
bŒfs_k£t
->
kobj
,

2369 &
bŒfs_¡©ic_ã©u»_©Œ_group
);

2370 
out_»move_group
;

2376 
out_»move_group
:

2377 
	`sysfs_»move_group
(&
bŒfs_k£t
->
kobj
, &
bŒfs_ã©u»_©Œ_group
);

2378 
out2
:

2379 
	`k£t_uÄegi¡”
(
bŒfs_k£t
);

2381  
»t
;

2382 
	}
}

2384 
__cŞd
 
	$bŒfs_ex™_sysfs
()

2386 
	`sysfs_unm”ge_group
(&
bŒfs_k£t
->
kobj
,

2387 &
bŒfs_¡©ic_ã©u»_©Œ_group
);

2388 
	`sysfs_»move_group
(&
bŒfs_k£t
->
kobj
, &
bŒfs_ã©u»_©Œ_group
);

2389 #ifdeà
CONFIG_BTRFS_DEBUG


2390 
	`sysfs_»move_group
(&
bŒfs_k£t
->
kobj
, &
bŒfs_debug_ã©u»_©Œ_group
);

2392 
	`k£t_uÄegi¡”
(
bŒfs_k£t
);

2393 
	}
}

	@sysfs.h

3 #iâdeà
BTRFS_SYSFS_H


4 
	#BTRFS_SYSFS_H


	)

6 
	~<lšux/kobjeù.h
>

8 
	ebŒfs_ã©u»_£t
 {

9 
	mFEAT_COMPAT
,

10 
	mFEAT_COMPAT_RO
,

11 
	mFEAT_INCOMPAT
,

12 
	mFEAT_MAX


15 *
bŒfs_´šbË_ã©u»s
(
bŒfs_ã©u»_£t
 
£t
, 
u64
 
æags
);

16 cÚ¡ *
bŒfs_ã©u»_£t_Çme
(
bŒfs_ã©u»_£t
 
£t
);

17 
bŒfs_sysfs_add_deviû
(
bŒfs_deviû
 *
deviû
);

18 
bŒfs_sysfs_»move_deviû
(
bŒfs_deviû
 *
deviû
);

19 
bŒfs_sysfs_add_fsid
(
bŒfs_fs_deviûs
 *
fs_devs
);

20 
bŒfs_sysfs_»move_fsid
(
bŒfs_fs_deviûs
 *
fs_devs
);

21 
bŒfs_sysfs_upd©e_¥rout_fsid
(
bŒfs_fs_deviûs
 *
fs_deviûs
);

22 
bŒfs_sysfs_ã©u»_upd©e
(
bŒfs_fs_šfo
 *
fs_šfo
);

23 
bŒfs_kobjeù_uev’t
(
block_deviû
 *
bdev
, 
kobjeù_aùiÚ
 
aùiÚ
);

25 
__š™
 
bŒfs_š™_sysfs
();

26 
__cŞd
 
bŒfs_ex™_sysfs
();

27 
bŒfs_sysfs_add_mouÁed
(
bŒfs_fs_šfo
 *
fs_šfo
);

28 
bŒfs_sysfs_»move_mouÁed
(
bŒfs_fs_šfo
 *
fs_šfo
);

29 
bŒfs_sysfs_add_block_group_ty³
(
bŒfs_block_group
 *
ÿche
);

30 
bŒfs_sysfs_add_¥aû_šfo_ty³
(
bŒfs_fs_šfo
 *
fs_šfo
,

31 
bŒfs_¥aû_šfo
 *
¥aû_šfo
);

32 
bŒfs_sysfs_»move_¥aû_šfo
(
bŒfs_¥aû_šfo
 *
¥aû_šfo
);

33 
bŒfs_sysfs_upd©e_devid
(
bŒfs_deviû
 *
deviû
);

35 
bŒfs_sysfs_add_Úe_qgroup
(
bŒfs_fs_šfo
 *
fs_šfo
,

36 
bŒfs_qgroup
 *
qgroup
);

37 
bŒfs_sysfs_d–_qgroups
(
bŒfs_fs_šfo
 *
fs_šfo
);

38 
bŒfs_sysfs_add_qgroups
(
bŒfs_fs_šfo
 *
fs_šfo
);

39 
bŒfs_sysfs_d–_Úe_qgroup
(
bŒfs_fs_šfo
 *
fs_šfo
,

40 
bŒfs_qgroup
 *
qgroup
);

	@tests/btrfs-tests.c

6 
	~<lšux/fs.h
>

7 
	~<lšux/mouÁ.h
>

8 
	~<lšux/p£udo_fs.h
>

9 
	~<lšux/magic.h
>

10 
	~"bŒfs-‹¡s.h
"

11 
	~"../ù»e.h
"

12 
	~"../ä“-¥aû-ÿche.h
"

13 
	~"../ä“-¥aû-Œ“.h
"

14 
	~"../Œª§ùiÚ.h
"

15 
	~"../vŞumes.h
"

16 
	~"../disk-io.h
"

17 
	~"../qgroup.h
"

18 
	~"../block-group.h
"

19 
	~"../fs.h
"

21 
vfsmouÁ
 *
	g‹¡_mÁ
 = 
NULL
;

23 cÚ¡ *
	g‹¡_”rÜ
[] = {

24 [
TEST_ALLOC_FS_INFO
] = "cannot‡llocate fs_info",

25 [
TEST_ALLOC_ROOT
] = "cannot‡llocate„oot",

26 [
TEST_ALLOC_EXTENT_BUFFER
] = "cannotƒxtent buffer",

27 [
TEST_ALLOC_PATH
] = "cannot‡llocate…ath",

28 [
TEST_ALLOC_INODE
] = "cannot‡llocate inode",

29 [
TEST_ALLOC_BLOCK_GROUP
] = "cannot‡llocate block group",

30 [
TEST_ALLOC_EXTENT_MAP
] = "cannot‡llocateƒxtent map",

33 cÚ¡ 
su³r_İ”©iÚs
 
	gbŒfs_‹¡_su³r_İs
 = {

34 .
®loc_šode
 = 
bŒfs_®loc_šode
,

35 .
	gde¡roy_šode
 = 
bŒfs_‹¡_de¡roy_šode
,

39 
	$bŒfs_‹¡_š™_fs_cÚ‹xt
(
fs_cÚ‹xt
 *
fc
)

41 
p£udo_fs_cÚ‹xt
 *
ùx
 = 
	`š™_p£udo
(
fc
, 
BTRFS_TEST_MAGIC
);

42 ià(!
ùx
)

43  -
ENOMEM
;

44 
ùx
->
İs
 = &
bŒfs_‹¡_su³r_İs
;

46 
	}
}

48 
fe_sy¡em_ty³
 
	g‹¡_ty³
 = {

49 .
Çme
 = "btrfs_test_fs",

50 .
	gš™_fs_cÚ‹xt
 = 
bŒfs_‹¡_š™_fs_cÚ‹xt
,

51 .
	gkl_sb
 = 
kl_ªÚ_su³r
,

54 
šode
 *
	$bŒfs_Ãw_‹¡_šode
()

56 
šode
 *inode;

58 
šode
 = 
	`Ãw_šode
(
‹¡_mÁ
->
mÁ_sb
);

59 ià(!
šode
)

60  
NULL
;

62 
šode
->
i_mode
 = 
S_IFREG
;

63 
šode
->
i_šo
 = 
BTRFS_FIRST_FREE_OBJECTID
;

64 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

65 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
objeùid
 = 
BTRFS_FIRST_FREE_OBJECTID
;

66 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
off£t
 = 0;

67 
	`šode_š™_owÃr
(&
nİ_mÁ_idm­
, 
šode
, 
NULL
, 
S_IFREG
);

69  
šode
;

70 
	}
}

72 
	$bŒfs_š™_‹¡_fs
()

74 
»t
;

76 
»t
 = 
	`»gi¡”_fesy¡em
(&
‹¡_ty³
);

77 ià(
»t
) {

78 
	`´štk
(
KERN_ERR
 "btrfs: cannot„egisterest file system\n");

79  
»t
;

82 
‹¡_mÁ
 = 
	`k”n_mouÁ
(&
‹¡_ty³
);

83 ià(
	`IS_ERR
(
‹¡_mÁ
)) {

84 
	`´štk
(
KERN_ERR
 "btrfs: cannot mountest file system\n");

85 
	`uÄegi¡”_fesy¡em
(&
‹¡_ty³
);

86  
	`PTR_ERR
(
‹¡_mÁ
);

89 
	}
}

91 
	$bŒfs_de¡roy_‹¡_fs
()

93 
	`k”n_unmouÁ
(
‹¡_mÁ
);

94 
	`uÄegi¡”_fesy¡em
(&
‹¡_ty³
);

95 
	}
}

97 
bŒfs_deviû
 *
	$bŒfs_®loc_dummy_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
)

99 
bŒfs_deviû
 *
dev
;

101 
dev
 = 
	`kz®loc
((*dev), 
GFP_KERNEL
);

102 ià(!
dev
)

103  
	`ERR_PTR
(-
ENOMEM
);

105 
	`ex‹Á_io_Œ“_š™
(
NULL
, &
dev
->
®loc_¡©e
, 0);

106 
	`INIT_LIST_HEAD
(&
dev
->
dev_li¡
);

107 
	`li¡_add
(&
dev
->
dev_li¡
, &
fs_šfo
->
fs_deviûs
->
deviûs
);

109  
dev
;

110 
	}
}

112 
	$bŒfs_ä“_dummy_deviû
(
bŒfs_deviû
 *
dev
)

114 
	`ex‹Á_io_Œ“_»Ëa£
(&
dev
->
®loc_¡©e
);

115 
	`kä“
(
dev
);

116 
	}
}

118 
bŒfs_fs_šfo
 *
	$bŒfs_®loc_dummy_fs_šfo
(
u32
 
nodesize
, u32 
£ùÜsize
)

120 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`kz®loc
((btrfs_fs_info),

121 
GFP_KERNEL
);

123 ià(!
fs_šfo
)

124  
fs_šfo
;

125 
fs_šfo
->
fs_deviûs
 = 
	`kz®loc
((
bŒfs_fs_deviûs
),

126 
GFP_KERNEL
);

127 ià(!
fs_šfo
->
fs_deviûs
) {

128 
	`kä“
(
fs_šfo
);

129  
NULL
;

131 
	`INIT_LIST_HEAD
(&
fs_šfo
->
fs_deviûs
->
deviûs
);

133 
fs_šfo
->
su³r_cİy
 = 
	`kz®loc
((
bŒfs_su³r_block
),

134 
GFP_KERNEL
);

135 ià(!
fs_šfo
->
su³r_cİy
) {

136 
	`kä“
(
fs_šfo
->
fs_deviûs
);

137 
	`kä“
(
fs_šfo
);

138  
NULL
;

141 
	`bŒfs_š™_fs_šfo
(
fs_šfo
);

143 
fs_šfo
->
nodesize
 =‚odesize;

144 
fs_šfo
->
£ùÜsize
 = sectorsize;

145 
fs_šfo
->
£ùÜsize_b™s
 = 
	`og2
(
£ùÜsize
);

146 
	`£t_b™
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_šfo
->
fs_¡©e
);

148 
‹¡_mÁ
->
mÁ_sb
->
s_fs_šfo
 = 
fs_šfo
;

150  
fs_šfo
;

151 
	}
}

153 
	$bŒfs_ä“_dummy_fs_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
)

155 
¿dix_Œ“_™”
 
™”
;

156 **
¦Ù
;

157 
bŒfs_deviû
 *
dev
, *
tmp
;

159 ià(!
fs_šfo
)

162 ià(
	`WARN_ON
(!
	`‹¡_b™
(
BTRFS_FS_STATE_DUMMY_FS_INFO
,

163 &
fs_šfo
->
fs_¡©e
)))

166 
‹¡_mÁ
->
mÁ_sb
->
s_fs_šfo
 = 
NULL
;

168 
	`¥š_lock
(&
fs_šfo
->
bufãr_lock
);

169 
	`¿dix_Œ“_fÜ_—ch_¦Ù
(
¦Ù
, &
fs_šfo
->
bufãr_¿dix
, &
™”
, 0) {

170 
ex‹Á_bufãr
 *
eb
;

172 
eb
 = 
	`¿dix_Œ“_d”ef_¦Ù_´Ùeùed
(
¦Ù
, &
fs_šfo
->
bufãr_lock
);

173 ià(!
eb
)

176 ià(
	`¿dix_Œ“_exû±iÚ
(
eb
)) {

177 ià(
	`¿dix_Œ“_d”ef_»Œy
(
eb
))

178 
¦Ù
 = 
	`¿dix_Œ“_™”_»Œy
(&
™”
);

181 
¦Ù
 = 
	`¿dix_Œ“_™”_»sume
(¦Ù, &
™”
);

182 
	`¥š_uÆock
(&
fs_šfo
->
bufãr_lock
);

183 
	`ä“_ex‹Á_bufãr_¡®e
(
eb
);

184 
	`¥š_lock
(&
fs_šfo
->
bufãr_lock
);

186 
	`¥š_uÆock
(&
fs_šfo
->
bufãr_lock
);

188 
	`bŒfs_m­pšg_Œ“_ä“
(&
fs_šfo
->
m­pšg_Œ“
);

189 
	`li¡_fÜ_—ch_’Œy_§ã
(
dev
, 
tmp
, &
fs_šfo
->
fs_deviûs
->
deviûs
,

190 
dev_li¡
) {

191 
	`bŒfs_ä“_dummy_deviû
(
dev
);

193 
	`bŒfs_ä“_qgroup_cÚfig
(
fs_šfo
);

194 
	`bŒfs_ä“_fs_roÙs
(
fs_šfo
);

195 
	`kä“
(
fs_šfo
->
su³r_cİy
);

196 
	`bŒfs_check_Ëaked_roÙs
(
fs_šfo
);

197 
	`bŒfs_ex‹Á_bufãr_Ëak_debug_check
(
fs_šfo
);

198 
	`kä“
(
fs_šfo
->
fs_deviûs
);

199 
	`kä“
(
fs_šfo
);

200 
	}
}

202 
	$bŒfs_ä“_dummy_roÙ
(
bŒfs_roÙ
 *
roÙ
)

204 ià(
	`IS_ERR_OR_NULL
(
roÙ
))

207 ià(
	`WARN_ON
(
	`‹¡_b™
(
BTRFS_ROOT_IN_RADIX
, &
roÙ
->
¡©e
)))

209 
	`bŒfs_glob®_roÙ_d–‘e
(
roÙ
);

210 
	`bŒfs_put_roÙ
(
roÙ
);

211 
	}
}

213 
bŒfs_block_group
 *

214 
	$bŒfs_®loc_dummy_block_group
(
bŒfs_fs_šfo
 *
fs_šfo
,

215 
Ëngth
)

217 
bŒfs_block_group
 *
ÿche
;

219 
ÿche
 = 
	`kz®loc
((*ÿche), 
GFP_KERNEL
);

220 ià(!
ÿche
)

221  
NULL
;

222 
ÿche
->
ä“_¥aû_ùl
 = 
	`kz®loc
((*cache->free_space_ctl),

223 
GFP_KERNEL
);

224 ià(!
ÿche
->
ä“_¥aû_ùl
) {

225 
	`kä“
(
ÿche
);

226  
NULL
;

229 
ÿche
->
¡¬t
 = 0;

230 
ÿche
->
Ëngth
 =†ength;

231 
ÿche
->
fuÎ_¡re_Ën
 = 
fs_šfo
->
£ùÜsize
;

232 
ÿche
->
fs_šfo
 = fs_info;

234 
	`INIT_LIST_HEAD
(&
ÿche
->
li¡
);

235 
	`INIT_LIST_HEAD
(&
ÿche
->
şu¡”_li¡
);

236 
	`INIT_LIST_HEAD
(&
ÿche
->
bg_li¡
);

237 
	`bŒfs_š™_ä“_¥aû_ùl
(
ÿche
, cache->
ä“_¥aû_ùl
);

238 
	`mu‹x_š™
(&
ÿche
->
ä“_¥aû_lock
);

240  
ÿche
;

241 
	}
}

243 
	$bŒfs_ä“_dummy_block_group
(
bŒfs_block_group
 *
ÿche
)

245 ià(!
ÿche
)

247 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

248 
	`kä“
(
ÿche
->
ä“_¥aû_ùl
);

249 
	`kä“
(
ÿche
);

250 
	}
}

252 
	$bŒfs_š™_dummy_Œªs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

253 
bŒfs_fs_šfo
 *
fs_šfo
)

255 
	`mem£t
(
Œªs
, 0, (*trans));

256 
Œªs
->
Œªsid
 = 1;

257 
Œªs
->
ty³
 = 
__TRANS_DUMMY
;

258 
Œªs
->
fs_šfo
 = fs_info;

259 
	}
}

261 
	$bŒfs_run_§n™y_‹¡s
()

263 
»t
, 
i
;

264 
u32
 
£ùÜsize
, 
nodesize
;

265 
u32
 
‹¡_£ùÜsize
[] = {

266 
PAGE_SIZE
,

268 
»t
 = 
	`bŒfs_š™_‹¡_fs
();

269 ià(
»t
)

270  
»t
;

271 
i
 = 0; i < 
	`ARRAY_SIZE
(
‹¡_£ùÜsize
); i++) {

272 
£ùÜsize
 = 
‹¡_£ùÜsize
[
i
];

273 
nodesize
 = 
£ùÜsize
;

274 
nodesize
 <ğ
BTRFS_MAX_METADATA_BLOCKSIZE
;

275 
nodesize
 <<= 1) {

276 
	`´_šfo
("BTRFS: selftest: sectorsize: %u‚odesize: %u\n",

277 
£ùÜsize
, 
nodesize
);

278 
»t
 = 
	`bŒfs_‹¡_ä“_¥aû_ÿche
(
£ùÜsize
, 
nodesize
);

279 ià(
»t
)

280 
out
;

281 
»t
 = 
	`bŒfs_‹¡_ex‹Á_bufãr_İ”©iÚs
(
£ùÜsize
,

282 
nodesize
);

283 ià(
»t
)

284 
out
;

285 
»t
 = 
	`bŒfs_‹¡_ex‹Á_io
(
£ùÜsize
, 
nodesize
);

286 ià(
»t
)

287 
out
;

288 
»t
 = 
	`bŒfs_‹¡_šodes
(
£ùÜsize
, 
nodesize
);

289 ià(
»t
)

290 
out
;

291 
»t
 = 
	`bŒfs_‹¡_qgroups
(
£ùÜsize
, 
nodesize
);

292 ià(
»t
)

293 
out
;

294 
»t
 = 
	`bŒfs_‹¡_ä“_¥aû_Œ“
(
£ùÜsize
, 
nodesize
);

295 ià(
»t
)

296 
out
;

299 
»t
 = 
	`bŒfs_‹¡_ex‹Á_m­
();

301 
out
:

302 
	`bŒfs_de¡roy_‹¡_fs
();

303  
»t
;

304 
	}
}

	@tests/btrfs-tests.h

6 #iâdeà
BTRFS_TESTS_H


7 
	#BTRFS_TESTS_H


	)

9 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


10 
bŒfs_run_§n™y_‹¡s
();

12 
	#‹¡_msg
(
fmt
, ...è
	`´_šfo
("BTRFS: s–áe¡: " fmˆ"\n", ##
__VA_ARGS__
)

	)

13 
	#‹¡_”r
(
fmt
, ...è
	`´_”r
("BTRFS: selftest: %s:%d " fmt "\n", \

14 
__FILE__
, 
__LINE__
, ##
__VA_ARGS__
)

	)

16 
	#‹¡_¡d_”r
(
šdex
è
	`‹¡_”r
("%s", 
‹¡_”rÜ
[šdex])

	)

19 
	mTEST_ALLOC_FS_INFO
,

20 
	mTEST_ALLOC_ROOT
,

21 
	mTEST_ALLOC_EXTENT_BUFFER
,

22 
	mTEST_ALLOC_PATH
,

23 
	mTEST_ALLOC_INODE
,

24 
	mTEST_ALLOC_BLOCK_GROUP
,

25 
	mTEST_ALLOC_EXTENT_MAP
,

28 cÚ¡ *
‹¡_”rÜ
[];

30 
	gbŒfs_roÙ
;

31 
	gbŒfs_Œªs_hªdË
;

33 
bŒfs_‹¡_ex‹Á_bufãr_İ”©iÚs
(
u32
 
£ùÜsize
, u32 
nodesize
);

34 
bŒfs_‹¡_ä“_¥aû_ÿche
(
u32
 
£ùÜsize
, u32 
nodesize
);

35 
bŒfs_‹¡_ex‹Á_io
(
u32
 
£ùÜsize
, u32 
nodesize
);

36 
bŒfs_‹¡_šodes
(
u32
 
£ùÜsize
, u32 
nodesize
);

37 
bŒfs_‹¡_qgroups
(
u32
 
£ùÜsize
, u32 
nodesize
);

38 
bŒfs_‹¡_ä“_¥aû_Œ“
(
u32
 
£ùÜsize
, u32 
nodesize
);

39 
bŒfs_‹¡_ex‹Á_m­
();

40 
šode
 *
bŒfs_Ãw_‹¡_šode
();

41 
bŒfs_fs_šfo
 *
bŒfs_®loc_dummy_fs_šfo
(
u32
 
nodesize
, u32 
£ùÜsize
);

42 
bŒfs_ä“_dummy_fs_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
);

43 
bŒfs_ä“_dummy_roÙ
(
bŒfs_roÙ
 *
roÙ
);

44 
bŒfs_block_group
 *

45 
bŒfs_®loc_dummy_block_group
(
bŒfs_fs_šfo
 *
fs_šfo
, 
Ëngth
);

46 
bŒfs_ä“_dummy_block_group
(
bŒfs_block_group
 *
ÿche
);

47 
bŒfs_š™_dummy_Œªs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

48 
bŒfs_fs_šfo
 *
fs_šfo
);

49 
bŒfs_deviû
 *
bŒfs_®loc_dummy_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
);

51 
šlše
 
	$bŒfs_run_§n™y_‹¡s
()

54 
	}
}

	@tests/extent-buffer-tests.c

6 
	~<lšux/¦ab.h
>

7 
	~"bŒfs-‹¡s.h
"

8 
	~"../ù»e.h
"

9 
	~"../ex‹Á_io.h
"

10 
	~"../disk-io.h
"

11 
	~"../acûssÜs.h
"

13 
	$‹¡_bŒfs_¥l™_™em
(
u32
 
£ùÜsize
, u32 
nodesize
)

15 
bŒfs_fs_šfo
 *
fs_šfo
;

16 
bŒfs_·th
 *
·th
 = 
NULL
;

17 
bŒfs_roÙ
 *
roÙ
 = 
NULL
;

18 
ex‹Á_bufãr
 *
eb
;

19 *
v®ue
 = "mary had‡†ittle†amb";

20 *
¥l™1
 = "mary had‡†ittle";

21 *
¥l™2
 = "†amb";

22 *
¥l™3
 = "mary";

23 *
¥l™4
 = " had‡†ittle";

24 
buf
[32];

25 
bŒfs_key
 
key
;

26 
u32
 
v®ue_Ën
 = 
	`¡¾’
(
v®ue
);

27 
»t
 = 0;

29 
	`‹¡_msg
("running btrfs_split_itemests");

31 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
nodesize
, 
£ùÜsize
);

32 ià(!
fs_šfo
) {

33 
	`‹¡_¡d_”r
(
TEST_ALLOC_FS_INFO
);

34  -
ENOMEM
;

37 
roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

38 ià(
	`IS_ERR
(
roÙ
)) {

39 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

40 
»t
 = 
	`PTR_ERR
(
roÙ
);

41 
out
;

44 
·th
 = 
	`bŒfs_®loc_·th
();

45 ià(!
·th
) {

46 
	`‹¡_¡d_”r
(
TEST_ALLOC_PATH
);

47 
»t
 = -
ENOMEM
;

48 
out
;

51 
eb
 = 
	`®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
nodesize
);

52 
·th
->
nodes
[0] = 
eb
;

53 ià(!
eb
) {

54 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_BUFFER
);

55 
»t
 = -
ENOMEM
;

56 
out
;

58 
·th
->
¦Ùs
[0] = 0;

60 
key
.
objeùid
 = 0;

61 
key
.
ty³
 = 
BTRFS_EXTENT_CSUM_KEY
;

62 
key
.
off£t
 = 0;

68 
	`bŒfs_£tup_™em_fÜ_š£¹
(
NULL
, 
roÙ
, 
·th
, &
key
, 
v®ue_Ën
);

69 
	`wr™e_ex‹Á_bufãr
(
eb
, 
v®ue
, 
	`bŒfs_™em_±r_off£t
(eb, 0),

70 
v®ue_Ën
);

72 
key
.
off£t
 = 3;

79 
»t
 = 
	`bŒfs_¥l™_™em
(
NULL
, 
roÙ
, 
·th
, &
key
, 17);

80 ià(
»t
) {

81 
	`‹¡_”r
("¥l™ i‹m faed %d", 
»t
);

82 
out
;

89 
	`bŒfs_™em_key_to_ıu
(
eb
, &
key
, 0);

90 ià(
key
.
objeùid
 !ğ0 || key.
ty³
 !ğ
BTRFS_EXTENT_CSUM_KEY
 ||

91 
key
.
off£t
 != 0) {

92 
	`‹¡_”r
("invalid key‡t slot 0");

93 
»t
 = -
EINVAL
;

94 
out
;

97 ià(
	`bŒfs_™em_size
(
eb
, 0è!ğ
	`¡¾’
(
¥l™1
)) {

98 
	`‹¡_”r
("invalid†en inhe first split");

99 
»t
 = -
EINVAL
;

100 
out
;

103 
	`»ad_ex‹Á_bufãr
(
eb
, 
buf
, 
	`bŒfs_™em_±r_off£t
(eb, 0),

104 
	`¡¾’
(
¥l™1
));

105 ià(
	`memcmp
(
buf
, 
¥l™1
, 
	`¡¾’
(split1))) {

106 
	`‹¡_”r
(

108 ()
	`¡¾’
(
¥l™1
), 
buf
, split1);

109 
»t
 = -
EINVAL
;

110 
out
;

113 
	`bŒfs_™em_key_to_ıu
(
eb
, &
key
, 1);

114 ià(
key
.
objeùid
 !ğ0 || key.
ty³
 !ğ
BTRFS_EXTENT_CSUM_KEY
 ||

115 
key
.
off£t
 != 3) {

116 
	`‹¡_”r
("invalid key‡t slot 1");

117 
»t
 = -
EINVAL
;

118 
out
;

121 ià(
	`bŒfs_™em_size
(
eb
, 1è!ğ
	`¡¾’
(
¥l™2
)) {

122 
	`‹¡_”r
("invalid†en inhe second split");

123 
»t
 = -
EINVAL
;

124 
out
;

127 
	`»ad_ex‹Á_bufãr
(
eb
, 
buf
, 
	`bŒfs_™em_±r_off£t
(eb, 1),

128 
	`¡¾’
(
¥l™2
));

129 ià(
	`memcmp
(
buf
, 
¥l™2
, 
	`¡¾’
(split2))) {

130 
	`‹¡_”r
(

132 
»t
 = -
EINVAL
;

133 
out
;

136 
key
.
off£t
 = 1;

138 
»t
 = 
	`bŒfs_¥l™_™em
(
NULL
, 
roÙ
, 
·th
, &
key
, 4);

139 ià(
»t
) {

140 
	`‹¡_”r
("£cÚd s¶™ i‹m faed %d", 
»t
);

141 
out
;

144 
	`bŒfs_™em_key_to_ıu
(
eb
, &
key
, 0);

145 ià(
key
.
objeùid
 !ğ0 || key.
ty³
 !ğ
BTRFS_EXTENT_CSUM_KEY
 ||

146 
key
.
off£t
 != 0) {

147 
	`‹¡_”r
("invalid key‡t slot 0");

148 
»t
 = -
EINVAL
;

149 
out
;

152 ià(
	`bŒfs_™em_size
(
eb
, 0è!ğ
	`¡¾’
(
¥l™3
)) {

153 
	`‹¡_”r
("invalid†en inhe first split");

154 
»t
 = -
EINVAL
;

155 
out
;

158 
	`»ad_ex‹Á_bufãr
(
eb
, 
buf
, 
	`bŒfs_™em_±r_off£t
(eb, 0),

159 
	`¡¾’
(
¥l™3
));

160 ià(
	`memcmp
(
buf
, 
¥l™3
, 
	`¡¾’
(split3))) {

161 
	`‹¡_”r
(

163 
»t
 = -
EINVAL
;

164 
out
;

167 
	`bŒfs_™em_key_to_ıu
(
eb
, &
key
, 1);

168 ià(
key
.
objeùid
 !ğ0 || key.
ty³
 !ğ
BTRFS_EXTENT_CSUM_KEY
 ||

169 
key
.
off£t
 != 1) {

170 
	`‹¡_”r
("invalid key‡t slot 1");

171 
»t
 = -
EINVAL
;

172 
out
;

175 ià(
	`bŒfs_™em_size
(
eb
, 1è!ğ
	`¡¾’
(
¥l™4
)) {

176 
	`‹¡_”r
("invalid†en inhe second split");

177 
»t
 = -
EINVAL
;

178 
out
;

181 
	`»ad_ex‹Á_bufãr
(
eb
, 
buf
, 
	`bŒfs_™em_±r_off£t
(eb, 1),

182 
	`¡¾’
(
¥l™4
));

183 ià(
	`memcmp
(
buf
, 
¥l™4
, 
	`¡¾’
(split4))) {

184 
	`‹¡_”r
(

186 
»t
 = -
EINVAL
;

187 
out
;

190 
	`bŒfs_™em_key_to_ıu
(
eb
, &
key
, 2);

191 ià(
key
.
objeùid
 !ğ0 || key.
ty³
 !ğ
BTRFS_EXTENT_CSUM_KEY
 ||

192 
key
.
off£t
 != 3) {

193 
	`‹¡_”r
("invalid key‡t slot 2");

194 
»t
 = -
EINVAL
;

195 
out
;

198 ià(
	`bŒfs_™em_size
(
eb
, 2è!ğ
	`¡¾’
(
¥l™2
)) {

199 
	`‹¡_”r
("invalid†en inhe second split");

200 
»t
 = -
EINVAL
;

201 
out
;

204 
	`»ad_ex‹Á_bufãr
(
eb
, 
buf
, 
	`bŒfs_™em_±r_off£t
(eb, 2),

205 
	`¡¾’
(
¥l™2
));

206 ià(
	`memcmp
(
buf
, 
¥l™2
, 
	`¡¾’
(split2))) {

207 
	`‹¡_”r
(

209 
»t
 = -
EINVAL
;

210 
out
;

212 
out
:

213 
	`bŒfs_ä“_·th
(
·th
);

214 
	`bŒfs_ä“_dummy_roÙ
(
roÙ
);

215 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

216  
»t
;

217 
	}
}

219 
	$bŒfs_‹¡_ex‹Á_bufãr_İ”©iÚs
(
u32
 
£ùÜsize
, u32 
nodesize
)

221 
	`‹¡_msg
("runningƒxtent buffer operationests");

222  
	`‹¡_bŒfs_¥l™_™em
(
£ùÜsize
, 
nodesize
);

223 
	}
}

	@tests/extent-io-tests.c

6 
	~<lšux/·gem­.h
>

7 
	~<lšux/·gevec.h
>

8 
	~<lšux/sched.h
>

9 
	~<lšux/¦ab.h
>

10 
	~<lšux/sizes.h
>

11 
	~"bŒfs-‹¡s.h
"

12 
	~"../ù»e.h
"

13 
	~"../ex‹Á_io.h
"

14 
	~"../bŒfs_šode.h
"

16 
	#PROCESS_UNLOCK
 (1 << 0)

	)

17 
	#PROCESS_RELEASE
 (1 << 1)

	)

18 
	#PROCESS_TEST_LOCKED
 (1 << 2)

	)

20 
nošlše
 
	$´oûss_·ge_¿nge
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
,

21 
æags
)

23 
»t
;

24 
fŞio_b©ch
 
fb©ch
;

25 
šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

26 
’d_šdex
 = 
’d
 >> 
PAGE_SHIFT
;

27 
i
;

28 
couÁ
 = 0;

29 
loİs
 = 0;

31 
	`fŞio_b©ch_š™
(&
fb©ch
);

33 
šdex
 <ğ
’d_šdex
) {

34 
»t
 = 
	`fem­_g‘_fŞios_cÚtig
(
šode
->
i_m­pšg
, &
šdex
,

35 
’d_šdex
, &
fb©ch
);

36 
i
 = 0; i < 
»t
; i++) {

37 
fŞio
 *fŞiØğ
fb©ch
.
fŞios
[
i
];

39 ià(
æags
 & 
PROCESS_TEST_LOCKED
 &&

40 !
	`fŞio_‹¡_locked
(
fŞio
))

41 
couÁ
++;

42 ià(
æags
 & 
PROCESS_UNLOCK
 && 
	`fŞio_‹¡_locked
(
fŞio
))

43 
	`fŞio_uÆock
(
fŞio
);

44 ià(
æags
 & 
PROCESS_RELEASE
)

45 
	`fŞio_put
(
fŞio
);

47 
	`fŞio_b©ch_»Ëa£
(&
fb©ch
);

48 
	`cÚd_»sched
();

49 
loİs
++;

50 ià(
loİs
 > 100000) {

51 
	`´štk
(
KERN_ERR


53 
¡¬t
, 
’d
, 
»t
);

58  
couÁ
;

59 
	}
}

61 
	#STATE_FLAG_STR_LEN
 256

	)

63 
	#PRINT_ONE_FLAG
(
¡©e
, 
de¡
, 
cur
, 
Çme
) \

65 ià(
¡©e
->¡©& 
EXTENT_
##
Çme
) \

66 
cur
 +ğ
	`sú´štf
(
de¡
 + cur, 
STATE_FLAG_STR_LEN
 - cur, \

67 "%s" #Çme, 
cur
 == 0 ? "" : "|"); \

68 })

	)

70 
	$ex‹Á_æag_to_¡r
(cÚ¡ 
ex‹Á_¡©e
 *
¡©e
, *
de¡
)

72 
cur
 = 0;

74 
de¡
[0] = 0;

75 
	`PRINT_ONE_FLAG
(
¡©e
, 
de¡
, 
cur
, 
DIRTY
);

76 
	`PRINT_ONE_FLAG
(
¡©e
, 
de¡
, 
cur
, 
UPTODATE
);

77 
	`PRINT_ONE_FLAG
(
¡©e
, 
de¡
, 
cur
, 
LOCKED
);

78 
	`PRINT_ONE_FLAG
(
¡©e
, 
de¡
, 
cur
, 
NEW
);

79 
	`PRINT_ONE_FLAG
(
¡©e
, 
de¡
, 
cur
, 
DELALLOC
);

80 
	`PRINT_ONE_FLAG
(
¡©e
, 
de¡
, 
cur
, 
DEFRAG
);

81 
	`PRINT_ONE_FLAG
(
¡©e
, 
de¡
, 
cur
, 
BOUNDARY
);

82 
	`PRINT_ONE_FLAG
(
¡©e
, 
de¡
, 
cur
, 
NODATASUM
);

83 
	`PRINT_ONE_FLAG
(
¡©e
, 
de¡
, 
cur
, 
CLEAR_META_RESV
);

84 
	`PRINT_ONE_FLAG
(
¡©e
, 
de¡
, 
cur
, 
NEED_WAIT
);

85 
	`PRINT_ONE_FLAG
(
¡©e
, 
de¡
, 
cur
, 
NORESERVE
);

86 
	`PRINT_ONE_FLAG
(
¡©e
, 
de¡
, 
cur
, 
QGROUP_RESERVED
);

87 
	`PRINT_ONE_FLAG
(
¡©e
, 
de¡
, 
cur
, 
CLEAR_DATA_RESV
);

88 
	}
}

90 
	$dump_ex‹Á_io_Œ“
(cÚ¡ 
ex‹Á_io_Œ“
 *
Œ“
)

92 
rb_node
 *
node
;

93 
æags_¡r
[
STATE_FLAG_STR_LEN
];

95 
node
 = 
	`rb_fœ¡
(&
Œ“
->
¡©e
);

96 
	`‹¡_msg
("ioree content:");

97 
node
) {

98 
ex‹Á_¡©e
 *
¡©e
;

100 
¡©e
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©e
, 
rb_node
);

101 
	`ex‹Á_æag_to_¡r
(
¡©e
, 
æags_¡r
);

102 
	`‹¡_msg
(" s¹=%Îu†’=%Îu fÏgs=%s", 
¡©e
->
¡¬t
,

103 
¡©e
->
’d
 + 1 - s‹->
¡¬t
, 
æags_¡r
);

104 
node
 = 
	`rb_Ãxt
(node);

106 
	}
}

108 
	$‹¡_fšd_d–®loc
(
u32
 
£ùÜsize
)

110 
šode
 *inode;

111 
ex‹Á_io_Œ“
 *
tmp
;

112 
·ge
 *page;

113 
·ge
 *
locked_·ge
 = 
NULL
;

114 
šdex
 = 0;

116 
u64
 
max_by‹s
 = 
BTRFS_MAX_EXTENT_SIZE
;

117 
u64
 
tÙ®_dœty
 = 2 * 
max_by‹s
;

118 
u64
 
¡¬t
, 
’d
, 
‹¡_¡¬t
;

119 
boŞ
 
found
;

120 
»t
 = -
EINVAL
;

122 
	`‹¡_msg
("running find delallocests");

124 
šode
 = 
	`bŒfs_Ãw_‹¡_šode
();

125 ià(!
šode
) {

126 
	`‹¡_¡d_”r
(
TEST_ALLOC_INODE
);

127  -
ENOMEM
;

129 
tmp
 = &
	`BTRFS_I
(
šode
)->
io_Œ“
;

135 
	`ex‹Á_io_Œ“_š™
(
NULL
, 
tmp
, 
IO_TREE_SELFTEST
);

142 
šdex
 = 0; index < (
tÙ®_dœty
 >> 
PAGE_SHIFT
); index++) {

143 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
šdex
, 
GFP_KERNEL
);

144 ià(!
·ge
) {

145 
	`‹¡_”r
("failedo‡llocateest…age");

146 
»t
 = -
ENOMEM
;

147 
out
;

149 
	`S‘PageDœty
(
·ge
);

150 ià(
šdex
) {

151 
	`uÆock_·ge
(
·ge
);

153 
	`g‘_·ge
(
·ge
);

154 
locked_·ge
 = 
·ge
;

162 
	`£t_ex‹Á_b™
(
tmp
, 0, 
£ùÜsize
 - 1, 
EXTENT_DELALLOC
, 
NULL
);

163 
¡¬t
 = 0;

164 
’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

165 
found
 = 
	`fšd_lock_d–®loc_¿nge
(
šode
, 
locked_·ge
, &
¡¬t
,

166 &
’d
);

167 ià(!
found
) {

168 
	`‹¡_”r
("should have found‡t†east one delalloc");

169 
out_b™s
;

171 ià(
¡¬t
 !ğ0 || 
’d
 !ğ(
£ùÜsize
 - 1)) {

172 
	`‹¡_”r
("expected start 0ƒnd %u, got start %lluƒnd %llu",

173 
£ùÜsize
 - 1, 
¡¬t
, 
’d
);

174 
out_b™s
;

176 
	`uÆock_ex‹Á
(
tmp
, 
¡¬t
, 
’d
, 
NULL
);

177 
	`uÆock_·ge
(
locked_·ge
);

178 
	`put_·ge
(
locked_·ge
);

186 
‹¡_¡¬t
 = 
SZ_64M
;

187 
locked_·ge
 = 
	`fšd_lock_·ge
(
šode
->
i_m­pšg
,

188 
‹¡_¡¬t
 >> 
PAGE_SHIFT
);

189 ià(!
locked_·ge
) {

190 
	`‹¡_”r
("couldn't findhe†ocked…age");

191 
out_b™s
;

193 
	`£t_ex‹Á_b™
(
tmp
, 
£ùÜsize
, 
max_by‹s
 - 1, 
EXTENT_DELALLOC
, 
NULL
);

194 
¡¬t
 = 
‹¡_¡¬t
;

195 
’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

196 
found
 = 
	`fšd_lock_d–®loc_¿nge
(
šode
, 
locked_·ge
, &
¡¬t
,

197 &
’d
);

198 ià(!
found
) {

199 
	`‹¡_”r
("couldn't find delalloc in our„ange");

200 
out_b™s
;

202 ià(
¡¬t
 !ğ
‹¡_¡¬t
 || 
’d
 !ğ
max_by‹s
 - 1) {

203 
	`‹¡_”r
("expected start %lluƒnd %llu, got start %llu,ƒnd %llu",

204 
‹¡_¡¬t
, 
max_by‹s
 - 1, 
¡¬t
, 
’d
);

205 
out_b™s
;

207 ià(
	`´oûss_·ge_¿nge
(
šode
, 
¡¬t
, 
’d
,

208 
PROCESS_TEST_LOCKED
 | 
PROCESS_UNLOCK
)) {

209 
	`‹¡_”r
("there were unlocked…ages inhe„ange");

210 
out_b™s
;

212 
	`uÆock_ex‹Á
(
tmp
, 
¡¬t
, 
’d
, 
NULL
);

214 
	`put_·ge
(
locked_·ge
);

221 
‹¡_¡¬t
 = 
max_by‹s
 + 
£ùÜsize
;

222 
locked_·ge
 = 
	`fšd_lock_·ge
(
šode
->
i_m­pšg
, 
‹¡_¡¬t
 >>

223 
PAGE_SHIFT
);

224 ià(!
locked_·ge
) {

225 
	`‹¡_”r
("couldn't findhe†ocked…age");

226 
out_b™s
;

228 
¡¬t
 = 
‹¡_¡¬t
;

229 
’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

230 
found
 = 
	`fšd_lock_d–®loc_¿nge
(
šode
, 
locked_·ge
, &
¡¬t
,

231 &
’d
);

232 ià(
found
) {

233 
	`‹¡_”r
("found„ange when we shouldn't have");

234 
out_b™s
;

236 ià(
’d
 !ğ
‹¡_¡¬t
 + 
PAGE_SIZE
 - 1) {

237 
	`‹¡_”r
("did‚ot„eturnhe…roperƒnd offset");

238 
out_b™s
;

248 
	`£t_ex‹Á_b™
(
tmp
, 
max_by‹s
, 
tÙ®_dœty
 - 1, 
EXTENT_DELALLOC
, 
NULL
);

249 
¡¬t
 = 
‹¡_¡¬t
;

250 
’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

251 
found
 = 
	`fšd_lock_d–®loc_¿nge
(
šode
, 
locked_·ge
, &
¡¬t
,

252 &
’d
);

253 ià(!
found
) {

254 
	`‹¡_”r
("didn't find our„ange");

255 
out_b™s
;

257 ià(
¡¬t
 !ğ
‹¡_¡¬t
 || 
’d
 !ğ
tÙ®_dœty
 - 1) {

258 
	`‹¡_”r
("expected start %lluƒnd %llu, got start %lluƒnd %llu",

259 
‹¡_¡¬t
, 
tÙ®_dœty
 - 1, 
¡¬t
, 
’d
);

260 
out_b™s
;

262 ià(
	`´oûss_·ge_¿nge
(
šode
, 
¡¬t
, 
’d
,

263 
PROCESS_TEST_LOCKED
 | 
PROCESS_UNLOCK
)) {

264 
	`‹¡_”r
("pages in„ange were‚ot‡ll†ocked");

265 
out_b™s
;

267 
	`uÆock_ex‹Á
(
tmp
, 
¡¬t
, 
’d
, 
NULL
);

273 
·ge
 = 
	`fšd_g‘_·ge
(
šode
->
i_m­pšg
,

274 (
max_by‹s
 + 
SZ_1M
è>> 
PAGE_SHIFT
);

275 ià(!
·ge
) {

276 
	`‹¡_”r
("couldn't find our…age");

277 
out_b™s
;

279 
	`CË¬PageDœty
(
·ge
);

280 
	`put_·ge
(
·ge
);

283 
	`lock_·ge
(
locked_·ge
);

284 
¡¬t
 = 
‹¡_¡¬t
;

285 
’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

292 
found
 = 
	`fšd_lock_d–®loc_¿nge
(
šode
, 
locked_·ge
, &
¡¬t
,

293 &
’d
);

294 ià(!
found
) {

295 
	`‹¡_”r
("didn't find our„ange");

296 
out_b™s
;

298 ià(
¡¬t
 !ğ
‹¡_¡¬t
 && 
’d
 !ğ‹¡_¡¬ˆ+ 
PAGE_SIZE
 - 1) {

299 
	`‹¡_”r
("expected start %lluƒnd %llu, got start %lluƒnd %llu",

300 
‹¡_¡¬t
,e¡_¡¬ˆ+ 
PAGE_SIZE
 - 1, 
¡¬t
, 
’d
);

301 
out_b™s
;

303 ià(
	`´oûss_·ge_¿nge
(
šode
, 
¡¬t
, 
’d
, 
PROCESS_TEST_LOCKED
 |

304 
PROCESS_UNLOCK
)) {

305 
	`‹¡_”r
("pages in„ange were‚ot‡ll†ocked");

306 
out_b™s
;

308 
»t
 = 0;

309 
out_b™s
:

310 ià(
»t
)

311 
	`dump_ex‹Á_io_Œ“
(
tmp
);

312 
	`ş—r_ex‹Á_b™s
(
tmp
, 0, 
tÙ®_dœty
 - 1, ()-1);

313 
out
:

314 ià(
locked_·ge
)

315 
	`put_·ge
(
locked_·ge
);

316 
	`´oûss_·ge_¿nge
(
šode
, 0, 
tÙ®_dœty
 - 1,

317 
PROCESS_UNLOCK
 | 
PROCESS_RELEASE
);

318 
	`ut
(
šode
);

319  
»t
;

320 
	}
}

322 
	$check_eb_b™m­
(*
b™m­
, 
ex‹Á_bufãr
 *
eb
)

324 
i
;

326 
i
 = 0; i < 
eb
->
Ën
 * 
BITS_PER_BYTE
; i++) {

327 
b™
, 
b™1
;

329 
b™
 = !!
	`‹¡_b™
(
i
, 
b™m­
);

330 
b™1
 = !!
	`ex‹Á_bufãr_‹¡_b™
(
eb
, 0, 
i
);

331 ià(
b™1
 !ğ
b™
) {

332 
u8
 
has
;

333 
u8
 
ex³ù
;

335 
	`»ad_ex‹Á_bufãr
(
eb
, &
has
, 
i
 / 
BITS_PER_BYTE
, 1);

336 
ex³ù
 = 
	`b™m­_g‘_v®ue8
(
b™m­
, 
	`ALIGN
(
i
, 
BITS_PER_BYTE
));

338 
	`‹¡_”r
(

340 
i
, i / 
BITS_PER_BYTE
, 
has
, 
ex³ù
);

341  -
EINVAL
;

344 
b™1
 = !!
	`ex‹Á_bufãr_‹¡_b™
(
eb
, 
i
 / 
BITS_PER_BYTE
,

345 
i
 % 
BITS_PER_BYTE
);

346 ià(
b™1
 !ğ
b™
) {

347 
u8
 
has
;

348 
u8
 
ex³ù
;

350 
	`»ad_ex‹Á_bufãr
(
eb
, &
has
, 
i
 / 
BITS_PER_BYTE
, 1);

351 
ex³ù
 = 
	`b™m­_g‘_v®ue8
(
b™m­
, 
	`ALIGN
(
i
, 
BITS_PER_BYTE
));

353 
	`‹¡_”r
(

355 
i
 / 
BITS_PER_BYTE
, i % BITS_PER_BYTE,

356 
i
 / 
BITS_PER_BYTE
, 
has
, 
ex³ù
);

357  -
EINVAL
;

361 
	}
}

363 
	$‹¡_b™m­_£t
(cÚ¡ *
Çme
, *
b™m­
,

364 
ex‹Á_bufãr
 *
eb
,

365 
by‹_¡¬t
, 
b™_¡¬t
,

366 
b™_Ën
)

368 
»t
;

370 
	`b™m­_£t
(
b™m­
, 
by‹_¡¬t
 * 
BITS_PER_BYTE
 + 
b™_¡¬t
, 
b™_Ën
);

371 
	`ex‹Á_bufãr_b™m­_£t
(
eb
, 
by‹_¡¬t
, 
b™_¡¬t
, 
b™_Ën
);

372 
»t
 = 
	`check_eb_b™m­
(
b™m­
, 
eb
);

373 ià(
»t
 < 0)

374 
	`‹¡_”r
("% ‹¡ faed", 
Çme
);

375  
»t
;

376 
	}
}

378 
	$‹¡_b™m­_ş—r
(cÚ¡ *
Çme
, *
b™m­
,

379 
ex‹Á_bufãr
 *
eb
,

380 
by‹_¡¬t
, 
b™_¡¬t
,

381 
b™_Ën
)

383 
»t
;

385 
	`b™m­_ş—r
(
b™m­
, 
by‹_¡¬t
 * 
BITS_PER_BYTE
 + 
b™_¡¬t
, 
b™_Ën
);

386 
	`ex‹Á_bufãr_b™m­_ş—r
(
eb
, 
by‹_¡¬t
, 
b™_¡¬t
, 
b™_Ën
);

387 
»t
 = 
	`check_eb_b™m­
(
b™m­
, 
eb
);

388 ià(
»t
 < 0)

389 
	`‹¡_”r
("% ‹¡ faed", 
Çme
);

390  
»t
;

391 
	}
}

392 
	$__‹¡_eb_b™m­s
(*
b™m­
, 
ex‹Á_bufãr
 *
eb
)

394 
i
, 
j
;

395 
by‹_Ën
 = 
eb
->
Ën
;

396 
u32
 
x
;

397 
»t
;

399 
»t
 = 
	`‹¡_b™m­_ş—r
("ş—¸®ÈruÀ1", 
b™m­
, 
eb
, 0, 0,

400 
by‹_Ën
 * 
BITS_PER_BYTE
);

401 ià(
»t
 < 0)

402  
»t
;

404 
»t
 = 
	`‹¡_b™m­_£t
("£ˆ®l", 
b™m­
, 
eb
, 0, 0, 
by‹_Ën
 * 
BITS_PER_BYTE
);

405 ià(
»t
 < 0)

406  
»t
;

408 
»t
 = 
	`‹¡_b™m­_ş—r
("ş—¸®ÈruÀ2", 
b™m­
, 
eb
, 0, 0,

409 
by‹_Ën
 * 
BITS_PER_BYTE
);

410 ià(
»t
 < 0)

411  
»t
;

413 
»t
 = 
	`‹¡_b™m­_£t
("§mby‹ s‘", 
b™m­
, 
eb
, 0, 2, 4);

414 ià(
»t
 < 0)

415  
»t
;

417 
»t
 = 
	`‹¡_b™m­_ş—r
("§mby‹…¬tŸÈş—r", 
b™m­
, 
eb
, 0, 4, 1);

418 ià(
»t
 < 0)

419  
»t
;

421 
»t
 = 
	`‹¡_b™m­_£t
("üos by‹ s‘", 
b™m­
, 
eb
, 2, 4, 8);

422 ià(
»t
 < 0)

423  
»t
;

425 
»t
 = 
	`‹¡_b™m­_£t
("üos muÉ˜by‹ s‘", 
b™m­
, 
eb
, 4, 4, 24);

426 ià(
»t
 < 0)

427  
»t
;

429 
»t
 = 
	`‹¡_b™m­_ş—r
("üos by‹ cË¬", 
b™m­
, 
eb
, 2, 6, 4);

430 ià(
»t
 < 0)

431  
»t
;

433 
»t
 = 
	`‹¡_b™m­_ş—r
("üos muÉ˜by‹ cË¬", 
b™m­
, 
eb
, 4, 6, 20);

434 ià(
»t
 < 0)

435  
»t
;

438 ià(
by‹_Ën
 > 
PAGE_SIZE
) {

439 
»t
 = 
	`‹¡_b™m­_£t
("üos ·g£t", 
b™m­
, 
eb
,

440 
PAGE_SIZE
 - () / 2, 0,

441 (è* 
BITS_PER_BYTE
);

442 ià(
»t
 < 0)

443  
»t
;

445 
»t
 = 
	`‹¡_b™m­_£t
("üos ·g£ˆ®l", 
b™m­
, 
eb
, 0, 0,

446 
by‹_Ën
 * 
BITS_PER_BYTE
);

447 ià(
»t
 < 0)

448  
»t
;

450 
»t
 = 
	`‹¡_b™m­_ş—r
("üos ·gş—r", 
b™m­
, 
eb
,

451 
PAGE_SIZE
 - () / 2, 0,

452 (è* 
BITS_PER_BYTE
);

453 ià(
»t
 < 0)

454  
»t
;

461 
x
 = 0;

462 
»t
 = 
	`‹¡_b™m­_ş—r
("ş—¸®ÈruÀ3", 
b™m­
, 
eb
, 0, 0,

463 
by‹_Ën
 * 
BITS_PER_BYTE
);

464 ià(
»t
 < 0)

465  
»t
;

467 
i
 = 0; i < 
by‹_Ën
 * 
BITS_PER_BYTE
 / 32; i++) {

468 
x
 = (0x19660dULL * (
u64
)x + 0x3c6ef35fULL) & 0xffffffffU;

469 
j
 = 0; j < 32; j++) {

470 ià(
x
 & (1U << 
j
)) {

471 
	`b™m­_£t
(
b™m­
, 
i
 * 32 + 
j
, 1);

472 
	`ex‹Á_bufãr_b™m­_£t
(
eb
, 0, 
i
 * 32 + 
j
, 1);

477 
»t
 = 
	`check_eb_b™m­
(
b™m­
, 
eb
);

478 ià(
»t
) {

479 
	`‹¡_”r
("random bit…attern failed");

480  
»t
;

484 
	}
}

486 
	$‹¡_eb_b™m­s
(
u32
 
£ùÜsize
, u32 
nodesize
)

488 
bŒfs_fs_šfo
 *
fs_šfo
;

489 *
b™m­
 = 
NULL
;

490 
ex‹Á_bufãr
 *
eb
 = 
NULL
;

491 
»t
;

493 
	`‹¡_msg
("runningƒxtent buffer bitmapests");

495 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
nodesize
, 
£ùÜsize
);

496 ià(!
fs_šfo
) {

497 
	`‹¡_¡d_”r
(
TEST_ALLOC_FS_INFO
);

498  -
ENOMEM
;

501 
b™m­
 = 
	`km®loc
(
nodesize
, 
GFP_KERNEL
);

502 ià(!
b™m­
) {

503 
	`‹¡_”r
("couldn't‡llocateest bitmap");

504 
»t
 = -
ENOMEM
;

505 
out
;

508 
eb
 = 
	`__®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 0, 
nodesize
);

509 ià(!
eb
) {

510 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

511 
»t
 = -
ENOMEM
;

512 
out
;

515 
»t
 = 
	`__‹¡_eb_b™m­s
(
b™m­
, 
eb
);

516 ià(
»t
)

517 
out
;

519 
	`ä“_ex‹Á_bufãr
(
eb
);

525 
eb
 = 
	`__®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
£ùÜsize
, 
nodesize
);

526 ià(!
eb
) {

527 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

528 
»t
 = -
ENOMEM
;

529 
out
;

532 
»t
 = 
	`__‹¡_eb_b™m­s
(
b™m­
, 
eb
);

533 
out
:

534 
	`ä“_ex‹Á_bufãr
(
eb
);

535 
	`kä“
(
b™m­
);

536 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

537  
»t
;

538 
	}
}

540 
	$‹¡_fšd_fœ¡_ş—r_ex‹Á_b™
()

542 
ex‹Á_io_Œ“
 
Œ“
;

543 
u64
 
¡¬t
, 
’d
;

544 
»t
 = -
EINVAL
;

546 
	`‹¡_msg
("running find_first_clear_extent_bitest");

548 
	`ex‹Á_io_Œ“_š™
(
NULL
, &
Œ“
, 
IO_TREE_SELFTEST
);

551 
	`fšd_fœ¡_ş—r_ex‹Á_b™
(&
Œ“
, 0, &
¡¬t
, &
’d
, 
CHUNK_TRIMMED
);

552 ià(
¡¬t
 !ğ0 || 
’d
 != -1) {

553 
	`‹¡_”r
(

555 
¡¬t
, 
’d
);

556 
out
;

562 
	`£t_ex‹Á_b™
(&
Œ“
, 
SZ_1M
, 
SZ_4M
 - 1,

563 
CHUNK_TRIMMED
 | 
CHUNK_ALLOCATED
, 
NULL
);

565 
	`fšd_fœ¡_ş—r_ex‹Á_b™
(&
Œ“
, 
SZ_512K
, &
¡¬t
, &
’d
,

566 
CHUNK_TRIMMED
 | 
CHUNK_ALLOCATED
);

568 ià(
¡¬t
 !ğ0 || 
’d
 !ğ
SZ_1M
 - 1) {

569 
	`‹¡_”r
("error finding beginning„ange: start %lluƒnd %llu",

570 
¡¬t
, 
’d
);

571 
out
;

575 
	`£t_ex‹Á_b™
(&
Œ“
, 
SZ_32M
, 
SZ_64M
 - 1,

576 
CHUNK_TRIMMED
 | 
CHUNK_ALLOCATED
, 
NULL
);

581 
	`fšd_fœ¡_ş—r_ex‹Á_b™
(&
Œ“
, 12 * 
SZ_1M
, &
¡¬t
, &
’d
,

582 
CHUNK_TRIMMED
 | 
CHUNK_ALLOCATED
);

584 ià(
¡¬t
 !ğ
SZ_4M
 || 
’d
 !ğ
SZ_32M
 - 1) {

585 
	`‹¡_”r
("error findingrimmed„ange: start %lluƒnd %llu",

586 
¡¬t
, 
’d
);

587 
out
;

594 
	`fšd_fœ¡_ş—r_ex‹Á_b™
(&
Œ“
, 
SZ_2M
, &
¡¬t
, &
’d
,

595 
CHUNK_TRIMMED
 | 
CHUNK_ALLOCATED
);

597 ià(
¡¬t
 !ğ
SZ_4M
 || 
’d
 !ğ
SZ_32M
 - 1) {

598 
	`‹¡_”r
("error finding‚ext unalloc„ange: start %lluƒnd %llu",

599 
¡¬t
, 
’d
);

600 
out
;

607 
	`£t_ex‹Á_b™
(&
Œ“
, 
SZ_64M
, SZ_64M + 
SZ_8M
 - 1, 
CHUNK_ALLOCATED
, 
NULL
);

608 
	`fšd_fœ¡_ş—r_ex‹Á_b™
(&
Œ“
, 
SZ_64M
 + 
SZ_1M
, &
¡¬t
, &
’d
,

609 
CHUNK_TRIMMED
);

611 ià(
¡¬t
 !ğ
SZ_64M
 || 
’d
 !ğSZ_64M + 
SZ_8M
 - 1) {

612 
	`‹¡_”r
("error findingƒxact„ange: start %lluƒnd %llu",

613 
¡¬t
, 
’d
);

614 
out
;

617 
	`fšd_fœ¡_ş—r_ex‹Á_b™
(&
Œ“
, 
SZ_64M
 - 
SZ_8M
, &
¡¬t
, &
’d
,

618 
CHUNK_TRIMMED
);

624 ià(
¡¬t
 !ğ
SZ_64M
 || 
’d
 !ğSZ_64M + 
SZ_8M
 - 1) {

625 
	`‹¡_”r
("error finding‚ext‡lloc„ange: start %lluƒnd %llu",

626 
¡¬t
, 
’d
);

627 
out
;

634 
	`fšd_fœ¡_ş—r_ex‹Á_b™
(&
Œ“
, -1, &
¡¬t
, &
’d
, 
CHUNK_TRIMMED
);

635 ià(
¡¬t
 !ğ
SZ_64M
 + 
SZ_8M
 || 
’d
 != -1) {

636 
	`‹¡_”r
(

638 
¡¬t
, 
’d
);

639 
out
;

642 
»t
 = 0;

643 
out
:

644 ià(
»t
)

645 
	`dump_ex‹Á_io_Œ“
(&
Œ“
);

646 
	`ş—r_ex‹Á_b™s
(&
Œ“
, 0, (
u64
)-1, 
CHUNK_TRIMMED
 | 
CHUNK_ALLOCATED
);

648  
»t
;

649 
	}
}

651 
	$dump_eb_ªd_memÜy_cÚ‹Ás
(
ex‹Á_bufãr
 *
eb
, *
memÜy
,

652 cÚ¡ *
‹¡_Çme
)

654 
i
 = 0; i < 
eb
->
Ën
; i++) {

655 
·ge
 *·gğ
eb
->
·ges
[
i
 >> 
PAGE_SHIFT
];

656 *
addr
 = 
	`·ge_add»ss
(
·ge
è+ 
	`off£t_š_·ge
(
i
);

658 ià(
	`memcmp
(
addr
, 
memÜy
 + 
i
, 1) != 0) {

659 
	`‹¡_”r
("% çed", 
‹¡_Çme
);

660 
	`‹¡_”r
("eb‡nd memory diffs‡t byte %u,ƒb has 0x%02x memory has 0x%02x",

661 
i
, *(
u8
 *)
addr
, *(u8 *)(
memÜy
 + i));

665 
	}
}

667 
	$v”ify_eb_ªd_memÜy
(
ex‹Á_bufãr
 *
eb
, *
memÜy
,

668 cÚ¡ *
‹¡_Çme
)

670 
i
 = 0; i < (
eb
->
Ën
 >> 
PAGE_SHIFT
); i++) {

671 *
eb_addr
 = 
	`·ge_add»ss
(
eb
->
·ges
[
i
]);

673 ià(
	`memcmp
(
memÜy
 + (
i
 << 
PAGE_SHIFT
), 
eb_addr
, 
PAGE_SIZE
) != 0) {

674 
	`dump_eb_ªd_memÜy_cÚ‹Ás
(
eb
, 
memÜy
, 
‹¡_Çme
);

675  -
EUCLEAN
;

679 
	}
}

685 
	$š™_eb_ªd_memÜy
(
ex‹Á_bufãr
 *
eb
, *
memÜy
)

687 
	`g‘_¿ndom_by‹s
(
memÜy
, 
eb
->
Ën
);

688 
	`wr™e_ex‹Á_bufãr
(
eb
, 
memÜy
, 0,ƒb->
Ën
);

689 
	}
}

691 
	$‹¡_eb_mem_İs
(
u32
 
£ùÜsize
, u32 
nodesize
)

693 
bŒfs_fs_šfo
 *
fs_šfo
;

694 
ex‹Á_bufãr
 *
eb
 = 
NULL
;

695 *
memÜy
 = 
NULL
;

696 
»t
;

698 
	`‹¡_msg
("runningƒxtent buffer memory operationests");

700 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
nodesize
, 
£ùÜsize
);

701 ià(!
fs_šfo
) {

702 
	`‹¡_¡d_”r
(
TEST_ALLOC_FS_INFO
);

703  -
ENOMEM
;

706 
memÜy
 = 
	`kvz®loc
(
nodesize
, 
GFP_KERNEL
);

707 ià(!
memÜy
) {

708 
	`‹¡_”r
("failedo‡llocate memory");

709 
»t
 = -
ENOMEM
;

710 
out
;

713 
eb
 = 
	`__®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
SZ_1M
, 
nodesize
);

714 ià(!
eb
) {

715 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_BUFFER
);

716 
»t
 = -
ENOMEM
;

717 
out
;

720 
	`š™_eb_ªd_memÜy
(
eb
, 
memÜy
);

721 
»t
 = 
	`v”ify_eb_ªd_memÜy
(
eb
, 
memÜy
, "fullƒb write");

722 ià(
»t
 < 0)

723 
out
;

725 
	`memıy
(
memÜy
, memory + 16, 16);

726 
	`memıy_ex‹Á_bufãr
(
eb
, 0, 16, 16);

727 
»t
 = 
	`v”ify_eb_ªd_memÜy
(
eb
, 
memÜy
, "same…age‚on-overlapping memcpy 1");

728 ià(
»t
 < 0)

729 
out
;

731 
	`memıy
(
memÜy
, memory + 2048, 16);

732 
	`memıy_ex‹Á_bufãr
(
eb
, 0, 2048, 16);

733 
»t
 = 
	`v”ify_eb_ªd_memÜy
(
eb
, 
memÜy
, "same…age‚on-overlapping memcpy 2");

734 ià(
»t
 < 0)

735 
out
;

736 
	`memıy
(
memÜy
, memory + 2048, 2048);

737 
	`memıy_ex‹Á_bufãr
(
eb
, 0, 2048, 2048);

738 
»t
 = 
	`v”ify_eb_ªd_memÜy
(
eb
, 
memÜy
, "same…age‚on-overlapping memcpy 3");

739 ià(
»t
 < 0)

740 
out
;

742 
	`memmove
(
memÜy
 + 512, memory + 256, 512);

743 
	`memmove_ex‹Á_bufãr
(
eb
, 512, 256, 512);

744 
»t
 = 
	`v”ify_eb_ªd_memÜy
(
eb
, 
memÜy
, "same…age overlapping memcpy 1");

745 ià(
»t
 < 0)

746 
out
;

748 
	`memmove
(
memÜy
 + 2048, memory + 512, 2048);

749 
	`memmove_ex‹Á_bufãr
(
eb
, 2048, 512, 2048);

750 
»t
 = 
	`v”ify_eb_ªd_memÜy
(
eb
, 
memÜy
, "same…age overlapping memcpy 2");

751 ià(
»t
 < 0)

752 
out
;

753 
	`memmove
(
memÜy
 + 512, memory + 2048, 2048);

754 
	`memmove_ex‹Á_bufãr
(
eb
, 512, 2048, 2048);

755 
»t
 = 
	`v”ify_eb_ªd_memÜy
(
eb
, 
memÜy
, "same…age overlapping memcpy 3");

756 ià(
»t
 < 0)

757 
out
;

759 ià(
nodesize
 > 
PAGE_SIZE
) {

760 
	`memıy
(
memÜy
, memory + 4096 - 128, 256);

761 
	`memıy_ex‹Á_bufãr
(
eb
, 0, 4096 - 128, 256);

762 
»t
 = 
	`v”ify_eb_ªd_memÜy
(
eb
, 
memÜy
, "cross…age‚on-overlapping memcpy 1");

763 ià(
»t
 < 0)

764 
out
;

766 
	`memıy
(
memÜy
 + 4096 - 128, memory + 4096 + 128, 256);

767 
	`memıy_ex‹Á_bufãr
(
eb
, 4096 - 128, 4096 + 128, 256);

768 
»t
 = 
	`v”ify_eb_ªd_memÜy
(
eb
, 
memÜy
, "cross…age‚on-overlapping memcpy 2");

769 ià(
»t
 < 0)

770 
out
;

772 
	`memmove
(
memÜy
 + 4096 - 128, memory + 4096 - 64, 256);

773 
	`memmove_ex‹Á_bufãr
(
eb
, 4096 - 128, 4096 - 64, 256);

774 
»t
 = 
	`v”ify_eb_ªd_memÜy
(
eb
, 
memÜy
, "cross…age overlapping memcpy 1");

775 ià(
»t
 < 0)

776 
out
;

778 
	`memmove
(
memÜy
 + 4096 - 64, memory + 4096 - 128, 256);

779 
	`memmove_ex‹Á_bufãr
(
eb
, 4096 - 64, 4096 - 128, 256);

780 
»t
 = 
	`v”ify_eb_ªd_memÜy
(
eb
, 
memÜy
, "cross…age overlapping memcpy 2");

781 ià(
»t
 < 0)

782 
out
;

784 
out
:

785 
	`ä“_ex‹Á_bufãr
(
eb
);

786 
	`kvä“
(
memÜy
);

787 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

788  
»t
;

789 
	}
}

791 
	$bŒfs_‹¡_ex‹Á_io
(
u32
 
£ùÜsize
, u32 
nodesize
)

793 
»t
;

795 
	`‹¡_msg
("runningƒxtent I/Oests");

797 
»t
 = 
	`‹¡_fšd_d–®loc
(
£ùÜsize
);

798 ià(
»t
)

799 
out
;

801 
»t
 = 
	`‹¡_fšd_fœ¡_ş—r_ex‹Á_b™
();

802 ià(
»t
)

803 
out
;

805 
»t
 = 
	`‹¡_eb_b™m­s
(
£ùÜsize
, 
nodesize
);

806 ià(
»t
)

807 
out
;

809 
»t
 = 
	`‹¡_eb_mem_İs
(
£ùÜsize
, 
nodesize
);

810 
out
:

811  
»t
;

812 
	}
}

	@tests/extent-map-tests.c

6 
	~<lšux/ty³s.h
>

7 
	~"bŒfs-‹¡s.h
"

8 
	~"../ù»e.h
"

9 
	~"../bŒfs_šode.h
"

10 
	~"../vŞumes.h
"

11 
	~"../disk-io.h
"

12 
	~"../block-group.h
"

14 
	$ä“_ex‹Á_m­_Œ“
(
ex‹Á_m­_Œ“
 *
em_Œ“
)

16 
ex‹Á_m­
 *
em
;

17 
rb_node
 *
node
;

19 
	`wr™e_lock
(&
em_Œ“
->
lock
);

20 !
	`RB_EMPTY_ROOT
(&
em_Œ“
->
m­
.
rb_roÙ
)) {

21 
node
 = 
	`rb_fœ¡_ÿched
(&
em_Œ“
->
m­
);

22 
em
 = 
	`rb_’Œy
(
node
, 
ex‹Á_m­
, 
rb_node
);

23 
	`»move_ex‹Á_m­pšg
(
em_Œ“
, 
em
);

25 #ifdeà
CONFIG_BTRFS_DEBUG


26 ià(
	`»fcouÁ_»ad
(&
em
->
»fs
) != 1) {

27 
	`‹¡_”r
(

29 
em
->
¡¬t
,ƒm->
Ën
,ƒm->
block_¡¬t
,

30 
em
->
block_Ën
, 
	`»fcouÁ_»ad
(&em->
»fs
));

32 
	`»fcouÁ_£t
(&
em
->
»fs
, 1);

35 
	`ä“_ex‹Á_m­
(
em
);

37 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

38 
	}
}

56 
	$‹¡_ÿ£_1
(
bŒfs_fs_šfo
 *
fs_šfo
,

57 
ex‹Á_m­_Œ“
 *
em_Œ“
)

59 
ex‹Á_m­
 *
em
;

60 
u64
 
¡¬t
 = 0;

61 
u64
 
Ën
 = 
SZ_8K
;

62 
»t
;

64 
em
 = 
	`®loc_ex‹Á_m­
();

65 ià(!
em
) {

66 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

67  -
ENOMEM
;

71 
em
->
¡¬t
 = 0;

72 
em
->
Ën
 = 
SZ_16K
;

73 
em
->
block_¡¬t
 = 0;

74 
em
->
block_Ën
 = 
SZ_16K
;

75 
	`wr™e_lock
(&
em_Œ“
->
lock
);

76 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

77 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

78 ià(
»t
 < 0) {

79 
	`‹¡_”r
("cannot‡ddƒxtent„ange [0, 16K)");

80 
out
;

82 
	`ä“_ex‹Á_m­
(
em
);

85 
em
 = 
	`®loc_ex‹Á_m­
();

86 ià(!
em
) {

87 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

88 
»t
 = -
ENOMEM
;

89 
out
;

92 
em
->
¡¬t
 = 
SZ_16K
;

93 
em
->
Ën
 = 
SZ_4K
;

94 
em
->
block_¡¬t
 = 
SZ_32K
;

95 
em
->
block_Ën
 = 
SZ_4K
;

96 
	`wr™e_lock
(&
em_Œ“
->
lock
);

97 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

98 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

99 ià(
»t
 < 0) {

100 
	`‹¡_”r
("cannot‡ddƒxtent„ange [16K, 20K)");

101 
out
;

103 
	`ä“_ex‹Á_m­
(
em
);

105 
em
 = 
	`®loc_ex‹Á_m­
();

106 ià(!
em
) {

107 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

108 
»t
 = -
ENOMEM
;

109 
out
;

113 
em
->
¡¬t
 = start;

114 
em
->
Ën
 =†en;

115 
em
->
block_¡¬t
 = 
¡¬t
;

116 
em
->
block_Ën
 = 
Ën
;

117 
	`wr™e_lock
(&
em_Œ“
->
lock
);

118 
»t
 = 
	`bŒfs_add_ex‹Á_m­pšg
(
fs_šfo
, 
em_Œ“
, &
em
,ƒm->
¡¬t
,ƒm->
Ën
);

119 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

120 ià(
»t
) {

121 
	`‹¡_”r
("ÿ£1 [%Îu %Îu]:„‘ %d", 
¡¬t
, s¹ + 
Ën
, 
»t
);

122 
out
;

124 ià(
em
 &&

125 (
em
->
¡¬t
 !ğ0 || 
	`ex‹Á_m­_’d
Ómè!ğ
SZ_16K
 ||

126 
em
->
block_¡¬t
 !ğ0 ||ƒm->
block_Ën
 !ğ
SZ_16K
)) {

127 
	`‹¡_”r
(

129 
¡¬t
, s¹ + 
Ën
, 
»t
, 
em
->start,ƒm->len,

130 
em
->
block_¡¬t
,ƒm->
block_Ën
);

131 
»t
 = -
EINVAL
;

133 
	`ä“_ex‹Á_m­
(
em
);

134 
out
:

135 
	`ä“_ex‹Á_m­_Œ“
(
em_Œ“
);

137  
»t
;

138 
	}
}

146 
	$‹¡_ÿ£_2
(
bŒfs_fs_šfo
 *
fs_šfo
,

147 
ex‹Á_m­_Œ“
 *
em_Œ“
)

149 
ex‹Á_m­
 *
em
;

150 
»t
;

152 
em
 = 
	`®loc_ex‹Á_m­
();

153 ià(!
em
) {

154 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

155  -
ENOMEM
;

159 
em
->
¡¬t
 = 0;

160 
em
->
Ën
 = 
SZ_1K
;

161 
em
->
block_¡¬t
 = 
EXTENT_MAP_INLINE
;

162 
em
->
block_Ën
 = (
u64
)-1;

163 
	`wr™e_lock
(&
em_Œ“
->
lock
);

164 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

165 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

166 ià(
»t
 < 0) {

167 
	`‹¡_”r
("cannot‡ddƒxtent„ange [0, 1K)");

168 
out
;

170 
	`ä“_ex‹Á_m­
(
em
);

173 
em
 = 
	`®loc_ex‹Á_m­
();

174 ià(!
em
) {

175 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

176 
»t
 = -
ENOMEM
;

177 
out
;

180 
em
->
¡¬t
 = 
SZ_4K
;

181 
em
->
Ën
 = 
SZ_4K
;

182 
em
->
block_¡¬t
 = 
SZ_4K
;

183 
em
->
block_Ën
 = 
SZ_4K
;

184 
	`wr™e_lock
(&
em_Œ“
->
lock
);

185 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

186 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

187 ià(
»t
 < 0) {

188 
	`‹¡_”r
("cannot‡ddƒxtent„ange [4K, 8K)");

189 
out
;

191 
	`ä“_ex‹Á_m­
(
em
);

193 
em
 = 
	`®loc_ex‹Á_m­
();

194 ià(!
em
) {

195 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

196 
»t
 = -
ENOMEM
;

197 
out
;

201 
em
->
¡¬t
 = 0;

202 
em
->
Ën
 = 
SZ_1K
;

203 
em
->
block_¡¬t
 = 
EXTENT_MAP_INLINE
;

204 
em
->
block_Ën
 = (
u64
)-1;

205 
	`wr™e_lock
(&
em_Œ“
->
lock
);

206 
»t
 = 
	`bŒfs_add_ex‹Á_m­pšg
(
fs_šfo
, 
em_Œ“
, &
em
,ƒm->
¡¬t
,ƒm->
Ën
);

207 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

208 ià(
»t
) {

209 
	`‹¡_”r
("ÿ£2 [0 1K]:„‘ %d", 
»t
);

210 
out
;

212 ià(
em
 &&

213 (
em
->
¡¬t
 !ğ0 || 
	`ex‹Á_m­_’d
Ómè!ğ
SZ_1K
 ||

214 
em
->
block_¡¬t
 !ğ
EXTENT_MAP_INLINE
 ||ƒm->
block_Ën
 !ğ(
u64
)-1)) {

215 
	`‹¡_”r
(

217 
»t
, 
em
->
¡¬t
,ƒm->
Ën
,ƒm->
block_¡¬t
,

218 
em
->
block_Ën
);

219 
»t
 = -
EINVAL
;

221 
	`ä“_ex‹Á_m­
(
em
);

222 
out
:

223 
	`ä“_ex‹Á_m­_Œ“
(
em_Œ“
);

225  
»t
;

226 
	}
}

228 
	$__‹¡_ÿ£_3
(
bŒfs_fs_šfo
 *
fs_šfo
,

229 
ex‹Á_m­_Œ“
 *
em_Œ“
, 
u64
 
¡¬t
)

231 
ex‹Á_m­
 *
em
;

232 
u64
 
Ën
 = 
SZ_4K
;

233 
»t
;

235 
em
 = 
	`®loc_ex‹Á_m­
();

236 ià(!
em
) {

237 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

238  -
ENOMEM
;

242 
em
->
¡¬t
 = 
SZ_4K
;

243 
em
->
Ën
 = 
SZ_4K
;

244 
em
->
block_¡¬t
 = 
SZ_4K
;

245 
em
->
block_Ën
 = 
SZ_4K
;

246 
	`wr™e_lock
(&
em_Œ“
->
lock
);

247 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

248 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

249 ià(
»t
 < 0) {

250 
	`‹¡_”r
("cannot‡ddƒxtent„ange [4K, 8K)");

251 
out
;

253 
	`ä“_ex‹Á_m­
(
em
);

255 
em
 = 
	`®loc_ex‹Á_m­
();

256 ià(!
em
) {

257 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

258 
»t
 = -
ENOMEM
;

259 
out
;

263 
em
->
¡¬t
 = 0;

264 
em
->
Ën
 = 
SZ_16K
;

265 
em
->
block_¡¬t
 = 0;

266 
em
->
block_Ën
 = 
SZ_16K
;

267 
	`wr™e_lock
(&
em_Œ“
->
lock
);

268 
»t
 = 
	`bŒfs_add_ex‹Á_m­pšg
(
fs_šfo
, 
em_Œ“
, &
em
, 
¡¬t
, 
Ën
);

269 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

270 ià(
»t
) {

271 
	`‹¡_”r
("case3 [0x%llx 0x%llx):„et %d",

272 
¡¬t
, s¹ + 
Ën
, 
»t
);

273 
out
;

279 ià(
em
 &&

280 (
¡¬t
 < 
em
->¡¬ˆ|| s¹ + 
Ën
 > 
	`ex‹Á_m­_’d
(em) ||

281 
em
->
¡¬t
 !ğem->
block_¡¬t
 ||ƒm->
Ën
 !ğem->
block_Ën
)) {

282 
	`‹¡_”r
(

284 
¡¬t
, s¹ + 
Ën
, 
»t
, 
em
->start,ƒm->len,

285 
em
->
block_¡¬t
,ƒm->
block_Ën
);

286 
»t
 = -
EINVAL
;

288 
	`ä“_ex‹Á_m­
(
em
);

289 
out
:

290 
	`ä“_ex‹Á_m­_Œ“
(
em_Œ“
);

292  
»t
;

293 
	}
}

311 
	$‹¡_ÿ£_3
(
bŒfs_fs_šfo
 *
fs_šfo
,

312 
ex‹Á_m­_Œ“
 *
em_Œ“
)

314 
»t
;

316 
»t
 = 
	`__‹¡_ÿ£_3
(
fs_šfo
, 
em_Œ“
, 0);

317 ià(
»t
)

318  
»t
;

319 
»t
 = 
	`__‹¡_ÿ£_3
(
fs_šfo
, 
em_Œ“
, 
SZ_8K
);

320 ià(
»t
)

321  
»t
;

322 
»t
 = 
	`__‹¡_ÿ£_3
(
fs_šfo
, 
em_Œ“
, (12 * 
SZ_1K
));

324  
»t
;

325 
	}
}

327 
	$__‹¡_ÿ£_4
(
bŒfs_fs_šfo
 *
fs_šfo
,

328 
ex‹Á_m­_Œ“
 *
em_Œ“
, 
u64
 
¡¬t
)

330 
ex‹Á_m­
 *
em
;

331 
u64
 
Ën
 = 
SZ_4K
;

332 
»t
;

334 
em
 = 
	`®loc_ex‹Á_m­
();

335 ià(!
em
) {

336 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

337  -
ENOMEM
;

341 
em
->
¡¬t
 = 0;

342 
em
->
Ën
 = 
SZ_8K
;

343 
em
->
block_¡¬t
 = 0;

344 
em
->
block_Ën
 = 
SZ_8K
;

345 
	`wr™e_lock
(&
em_Œ“
->
lock
);

346 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

347 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

348 ià(
»t
 < 0) {

349 
	`‹¡_”r
("cannot‡ddƒxtent„ange [0, 8K)");

350 
out
;

352 
	`ä“_ex‹Á_m­
(
em
);

354 
em
 = 
	`®loc_ex‹Á_m­
();

355 ià(!
em
) {

356 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

357 
»t
 = -
ENOMEM
;

358 
out
;

362 
em
->
¡¬t
 = 
SZ_8K
;

363 
em
->
Ën
 = 24 * 
SZ_1K
;

364 
em
->
block_¡¬t
 = 
SZ_16K
;

365 
em
->
block_Ën
 = 24 * 
SZ_1K
;

366 
	`wr™e_lock
(&
em_Œ“
->
lock
);

367 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

368 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

369 ià(
»t
 < 0) {

370 
	`‹¡_”r
("cannot‡ddƒxtent„ange [8K, 32K)");

371 
out
;

373 
	`ä“_ex‹Á_m­
(
em
);

375 
em
 = 
	`®loc_ex‹Á_m­
();

376 ià(!
em
) {

377 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

378 
»t
 = -
ENOMEM
;

379 
out
;

382 
em
->
¡¬t
 = 0;

383 
em
->
Ën
 = 
SZ_32K
;

384 
em
->
block_¡¬t
 = 0;

385 
em
->
block_Ën
 = 
SZ_32K
;

386 
	`wr™e_lock
(&
em_Œ“
->
lock
);

387 
»t
 = 
	`bŒfs_add_ex‹Á_m­pšg
(
fs_šfo
, 
em_Œ“
, &
em
, 
¡¬t
, 
Ën
);

388 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

389 ià(
»t
) {

390 
	`‹¡_”r
("case4 [0x%llx 0x%llx):„et %d",

391 
¡¬t
, 
Ën
, 
»t
);

392 
out
;

394 ià(
em
 && (
¡¬t
 <ƒm->¡¬ˆ|| s¹ + 
Ën
 > 
	`ex‹Á_m­_’d
(em))) {

395 
	`‹¡_”r
(

397 
¡¬t
, 
Ën
, 
»t
, 
em
->¡¬t,ƒm->Ën,ƒm->
block_¡¬t
,

398 
em
->
block_Ën
);

399 
»t
 = -
EINVAL
;

401 
	`ä“_ex‹Á_m­
(
em
);

402 
out
:

403 
	`ä“_ex‹Á_m­_Œ“
(
em_Œ“
);

405  
»t
;

406 
	}
}

433 
	$‹¡_ÿ£_4
(
bŒfs_fs_šfo
 *
fs_šfo
,

434 
ex‹Á_m­_Œ“
 *
em_Œ“
)

436 
»t
;

438 
»t
 = 
	`__‹¡_ÿ£_4
(
fs_šfo
, 
em_Œ“
, 0);

439 ià(
»t
)

440  
»t
;

441 
»t
 = 
	`__‹¡_ÿ£_4
(
fs_šfo
, 
em_Œ“
, 
SZ_4K
);

443  
»t
;

444 
	}
}

446 
	$add_com´es£d_ex‹Á
(
ex‹Á_m­_Œ“
 *
em_Œ“
,

447 
u64
 
¡¬t
, u64 
Ën
, u64 
block_¡¬t
)

449 
ex‹Á_m­
 *
em
;

450 
»t
;

452 
em
 = 
	`®loc_ex‹Á_m­
();

453 ià(!
em
) {

454 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

455  -
ENOMEM
;

458 
em
->
¡¬t
 = start;

459 
em
->
Ën
 =†en;

460 
em
->
block_¡¬t
 = block_start;

461 
em
->
block_Ën
 = 
SZ_4K
;

462 
	`£t_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
);

463 
	`wr™e_lock
(&
em_Œ“
->
lock
);

464 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

465 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

466 
	`ä“_ex‹Á_m­
(
em
);

467 ià(
»t
 < 0) {

468 
	`‹¡_”r
("ÿÂÙ‡ddƒx‹Á m­ [%Îu, %Îu)", 
¡¬t
, s¹ + 
Ën
);

469  
»t
;

473 
	}
}

475 
	sex‹Á_¿nge
 {

476 
u64
 
	m¡¬t
;

477 
u64
 
	mËn
;

481 
ex‹Á_¿nge
 
	gv®id_¿nges
[][7] = {

483 { .
¡¬t
 = 0, .
	gËn
 = 
SZ_8K
 },

484 { .
	g¡¬t
 = 
SZ_4K
 * 3, .
	gËn
 = SZ_4K * 3},

485 { .
	g¡¬t
 = 
SZ_4K
 * 6, .
	gËn
 = SZ_4K * 3},

486 { .
	g¡¬t
 = 
SZ_32K
 + 
SZ_4K
, .
	gËn
 = SZ_4K},

487 { .
	g¡¬t
 = 
SZ_4K
 * 10, .
	gËn
 = SZ_4K * 6},

490 { .
	g¡¬t
 = 0, .
	gËn
 = 
SZ_8K
 },

491 { .
	g¡¬t
 = 
SZ_4K
 * 5, .
	gËn
 = SZ_4K},

492 { .
	g¡¬t
 = 
SZ_4K
 * 6, .
	gËn
 = SZ_4K * 3},

493 { .
	g¡¬t
 = 
SZ_32K
 + 
SZ_4K
, .
	gËn
 = SZ_4K},

494 { .
	g¡¬t
 = 
SZ_4K
 * 10, .
	gËn
 = SZ_4K * 6},

497 { .
	g¡¬t
 = 0, .
	gËn
 = 
SZ_8K
 },

498 { .
	g¡¬t
 = 
SZ_4K
 * 5, .
	gËn
 = SZ_4K},

499 { .
	g¡¬t
 = 
SZ_4K
 * 6, .
	gËn
 = SZ_4K},

500 { .
	g¡¬t
 = 
SZ_32K
, .
	gËn
 = 
SZ_4K
},

501 { .
	g¡¬t
 = 
SZ_32K
 + 
SZ_4K
, .
	gËn
 = SZ_4K},

502 { .
	g¡¬t
 = 
SZ_4K
 * 10, .
	gËn
 = SZ_4K * 6},

505 { .
	g¡¬t
 = 0, .
	gËn
 = 
SZ_8K
},

506 { .
	g¡¬t
 = 
SZ_4K
 * 5, .
	gËn
 = SZ_4K},

507 { .
	g¡¬t
 = 
SZ_4K
 * 6, .
	gËn
 = SZ_4K},

511 
	$v®id©e_¿nge
(
ex‹Á_m­_Œ“
 *
em_Œ“
, 
šdex
)

513 
rb_node
 *
n
;

514 
i
;

516 
i
 = 0, 
n
 = 
	`rb_fœ¡_ÿched
(&
em_Œ“
->
m­
);

517 
v®id_¿nges
[
šdex
][
i
].
Ën
 && 
n
;

518 
i
++, 
n
 = 
	`rb_Ãxt
(n)) {

519 
ex‹Á_m­
 *
’Œy
 = 
	`rb_’Œy
(
n
, ex‹Á_m­, 
rb_node
);

521 ià(
’Œy
->
¡¬t
 !ğ
v®id_¿nges
[
šdex
][
i
].start) {

522 
	`‹¡_”r
("mapping has start %lluƒxpected %llu",

523 
’Œy
->
¡¬t
, 
v®id_¿nges
[
šdex
][
i
].start);

524  -
EINVAL
;

527 ià(
’Œy
->
Ën
 !ğ
v®id_¿nges
[
šdex
][
i
].len) {

528 
	`‹¡_”r
("mapping has†en %lluƒxpected %llu",

529 
’Œy
->
Ën
, 
v®id_¿nges
[
šdex
][
i
].len);

530  -
EINVAL
;

538 ià(
v®id_¿nges
[
šdex
][
i
].
Ën
) {

539 
	`‹¡_”r
("missing‡nƒntry");

540  -
EINVAL
;

544 ià(
n
) {

545 
	`‹¡_”r
("we have‡†eft overƒntry inheƒxtent map we didn'tƒxpect");

546  -
EINVAL
;

550 
	}
}

570 
	$‹¡_ÿ£_5
()

572 
ex‹Á_m­_Œ“
 *
em_Œ“
;

573 
šode
 *inode;

574 
u64
 
¡¬t
, 
’d
;

575 
»t
;

577 
	`‹¡_msg
("Running btrfs_drop_extent_map_rangeests");

579 
šode
 = 
	`bŒfs_Ãw_‹¡_šode
();

580 ià(!
šode
) {

581 
	`‹¡_¡d_”r
(
TEST_ALLOC_INODE
);

582  -
ENOMEM
;

585 
em_Œ“
 = &
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
;

588 
»t
 = 
	`add_com´es£d_ex‹Á
(
em_Œ“
, 0, 
SZ_4K
 * 3, 0);

589 ià(
»t
) {

590 
	`‹¡_”r
("cannot‡ddƒxtent„ange [0, 12K)");

591 
out
;

595 
»t
 = 
	`add_com´es£d_ex‹Á
(
em_Œ“
, 
SZ_4K
 * 3, SZ_4K * 3, SZ_4K);

596 ià(
»t
) {

597 
	`‹¡_”r
("cannot‡ddƒxtent„ange [12k, 24k)");

598 
out
;

602 
»t
 = 
	`add_com´es£d_ex‹Á
(
em_Œ“
, 
SZ_4K
 * 6, SZ_4K * 3, 
SZ_8K
);

603 ià(
»t
) {

604 
	`‹¡_”r
("cannot‡ddƒxtent„ange [12k, 24k)");

605 
out
;

609 
»t
 = 
	`add_com´es£d_ex‹Á
(
em_Œ“
, 
SZ_32K
 + 
SZ_4K
, SZ_4K, SZ_4K * 3);

610 ià(
»t
) {

611 
	`‹¡_”r
("cannot‡ddƒxtent„ange [12k, 24k)");

612 
out
;

616 
»t
 = 
	`add_com´es£d_ex‹Á
(
em_Œ“
, 
SZ_4K
 * 10, SZ_4K * 6, 
SZ_16K
);

617 ià(
»t
) {

618 
	`‹¡_”r
("cannot‡ddƒxtent„ange [12k, 24k)");

619 
out
;

623 
¡¬t
 = 
SZ_8K
;

624 
’d
 = (3 * 
SZ_4K
) - 1;

625 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
	`BTRFS_I
(
šode
), 
¡¬t
, 
’d
, 
çl£
);

626 
»t
 = 
	`v®id©e_¿nge
(&
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
, 0);

627 ià(
»t
)

628 
out
;

631 
¡¬t
 = 
SZ_4K
 * 3;

632 
’d
 = 
SZ_16K
 + 
SZ_4K
 - 1;

633 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
	`BTRFS_I
(
šode
), 
¡¬t
, 
’d
, 
çl£
);

634 
»t
 = 
	`v®id©e_¿nge
(&
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
, 1);

635 ià(
»t
)

636 
out
;

639 
¡¬t
 = 
SZ_32K
 - 
SZ_4K
;

640 
’d
 = 
SZ_32K
 - 1;

641 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
	`BTRFS_I
(
šode
), 
¡¬t
, 
’d
, 
çl£
);

642 
»t
 = 
	`v®id©e_¿nge
(&
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
, 2);

643 ià(
»t
)

644 
out
;

647 
¡¬t
 = 
SZ_32K
;

648 
’d
 = 
SZ_64K
 - 1;

649 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
	`BTRFS_I
(
šode
), 
¡¬t
, 
’d
, 
çl£
);

650 
»t
 = 
	`v®id©e_¿nge
(&
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
, 3);

651 ià(
»t
)

652 
out
;

653 
out
:

654 
	`ut
(
šode
);

655  
»t
;

656 
	}
}

663 
	$‹¡_ÿ£_6
(
bŒfs_fs_šfo
 *
fs_šfo
, 
ex‹Á_m­_Œ“
 *
em_Œ“
)

665 
ex‹Á_m­
 *
em
 = 
NULL
;

666 
»t
;

668 
»t
 = 
	`add_com´es£d_ex‹Á
(
em_Œ“
, 0, 
SZ_4K
, 0);

669 ià(
»t
)

670 
out
;

672 
»t
 = 
	`add_com´es£d_ex‹Á
(
em_Œ“
, 
SZ_4K
, SZ_4K, 0);

673 ià(
»t
)

674 
out
;

676 
em
 = 
	`®loc_ex‹Á_m­
();

677 ià(!
em
) {

678 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

679  -
ENOMEM
;

682 
em
->
¡¬t
 = 
SZ_4K
;

683 
em
->
Ën
 = 
SZ_4K
;

684 
em
->
block_¡¬t
 = 
SZ_16K
;

685 
em
->
block_Ën
 = 
SZ_16K
;

686 
	`wr™e_lock
(&
em_Œ“
->
lock
);

687 
»t
 = 
	`bŒfs_add_ex‹Á_m­pšg
(
fs_šfo
, 
em_Œ“
, &
em
, 0, 
SZ_8K
);

688 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

690 ià(
»t
 != 0) {

691 
	`‹¡_”r
("gÙ‡À”rÜ wh’‡ddšg ou¸em: %d", 
»t
);

692 
out
;

695 
»t
 = -
EINVAL
;

696 ià(
em
->
¡¬t
 != 0) {

697 
	`‹¡_”r
("uÃx³ùedƒm->¡¬ˆ© %Îu, wª‹d 0", 
em
->
¡¬t
);

698 
out
;

700 ià(
em
->
Ën
 !ğ
SZ_4K
) {

701 
	`‹¡_”r
("uÃx³ùedƒm->ËÀ%Îu,ƒx³ùed 4K", 
em
->
Ën
);

702 
out
;

704 
»t
 = 0;

705 
out
:

706 
	`ä“_ex‹Á_m­
(
em
);

707 
	`ä“_ex‹Á_m­_Œ“
(
em_Œ“
);

708  
»t
;

709 
	}
}

716 
	$‹¡_ÿ£_7
()

718 
ex‹Á_m­_Œ“
 *
em_Œ“
;

719 
ex‹Á_m­
 *
em
;

720 
šode
 *inode;

721 
»t
;

723 
	`‹¡_msg
("Running btrfs_drop_extent_cache with…inned");

725 
šode
 = 
	`bŒfs_Ãw_‹¡_šode
();

726 ià(!
šode
) {

727 
	`‹¡_¡d_”r
(
TEST_ALLOC_INODE
);

728  -
ENOMEM
;

731 
em_Œ“
 = &
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
;

733 
em
 = 
	`®loc_ex‹Á_m­
();

734 ià(!
em
) {

735 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

736 
»t
 = -
ENOMEM
;

737 
out
;

741 
em
->
¡¬t
 = 0;

742 
em
->
Ën
 = 
SZ_16K
;

743 
em
->
block_¡¬t
 = 0;

744 
em
->
block_Ën
 = 
SZ_4K
;

745 
	`£t_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
);

746 
	`wr™e_lock
(&
em_Œ“
->
lock
);

747 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

748 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

749 ià(
»t
 < 0) {

750 
	`‹¡_”r
("couldn't‡ddƒxtent map");

751 
out
;

753 
	`ä“_ex‹Á_m­
(
em
);

755 
em
 = 
	`®loc_ex‹Á_m­
();

756 ià(!
em
) {

757 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

758 
»t
 = -
ENOMEM
;

759 
out
;

763 
em
->
¡¬t
 = 
SZ_32K
;

764 
em
->
Ën
 = 
SZ_16K
;

765 
em
->
block_¡¬t
 = 
SZ_32K
;

766 
em
->
block_Ën
 = 
SZ_16K
;

767 
	`wr™e_lock
(&
em_Œ“
->
lock
);

768 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

769 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

770 ià(
»t
 < 0) {

771 
	`‹¡_”r
("couldn't‡ddƒxtent map");

772 
out
;

774 
	`ä“_ex‹Á_m­
(
em
);

780 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
	`BTRFS_I
(
šode
), 0, (36 * 
SZ_1K
è- 1, 
Œue
);

783 
»t
 = -
EINVAL
;

785 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 0, 
SZ_16K
);

786 ià(!
em
) {

787 
	`‹¡_”r
("didn't find‡nƒm‡t 0‡sƒxpected");

788 
out
;

791 ià(
em
->
¡¬t
 != 0) {

792 
	`‹¡_”r
("em->¡¬ˆi %Îu,ƒx³ùed 0", 
em
->
¡¬t
);

793 
out
;

796 ià(
em
->
Ën
 !ğ
SZ_16K
) {

797 
	`‹¡_”r
("em->ËÀi %Îu,ƒx³ùed 16K", 
em
->
Ën
);

798 
out
;

801 
	`ä“_ex‹Á_m­
(
em
);

803 
	`»ad_lock
(&
em_Œ“
->
lock
);

804 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
SZ_16K
, SZ_16K);

805 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

806 ià(
em
) {

807 
	`‹¡_”r
("found‡nƒm when we weren'tƒxpecting one");

808 
out
;

811 
	`»ad_lock
(&
em_Œ“
->
lock
);

812 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
SZ_32K
, 
SZ_16K
);

813 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

814 ià(!
em
) {

815 
	`‹¡_”r
("didn't find‡nƒm‡t 32K‡sƒxpected");

816 
out
;

819 ià(
em
->
¡¬t
 !ğ(36 * 
SZ_1K
)) {

820 
	`‹¡_”r
("em->¡¬ˆi %Îu,ƒx³ùed 36K", 
em
->
¡¬t
);

821 
out
;

824 ià(
em
->
Ën
 !ğ(12 * 
SZ_1K
)) {

825 
	`‹¡_”r
("em->ËÀi %Îu,ƒx³ùed 12K", 
em
->
Ën
);

826 
out
;

829 
	`ä“_ex‹Á_m­
(
em
);

831 
	`»ad_lock
(&
em_Œ“
->
lock
);

832 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 48 * 
SZ_1K
, (
u64
)-1);

833 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

834 ià(
em
) {

835 
	`‹¡_”r
("found‡n unexpectedƒm‡bove 48K");

836 
out
;

839 
»t
 = 0;

840 
out
:

841 
	`ä“_ex‹Á_m­
(
em
);

842 
	`ut
(
šode
);

843  
»t
;

844 
	}
}

846 
	srm­_‹¡_veùÜ
 {

847 
u64
 
	m¿id_ty³
;

848 
u64
 
	mphysiÿl_¡¬t
;

849 
u64
 
	md©a_¡re_size
;

850 
u64
 
	mnum_d©a_¡res
;

851 
u64
 
	mnum_¡res
;

853 
u64
 
	md©a_¡re_phys_¡¬t
[5];

854 
boŞ
 
	mex³ùed_m­³d_addr
;

856 
u64
 
	mm­³d_logiÿl
[5];

859 
	$‹¡_rm­_block
(
bŒfs_fs_šfo
 *
fs_šfo
,

860 
rm­_‹¡_veùÜ
 *
‹¡
)

862 
ex‹Á_m­
 *
em
;

863 
m­_lookup
 *
m­
 = 
NULL
;

864 
u64
 *
logiÿl
 = 
NULL
;

865 
i
, 
out_ndaddrs
, 
out_¡re_Ën
;

866 
»t
;

868 
em
 = 
	`®loc_ex‹Á_m­
();

869 ià(!
em
) {

870 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

871  -
ENOMEM
;

874 
m­
 = 
	`km®loc
(
	`m­_lookup_size
(
‹¡
->
num_¡res
), 
GFP_KERNEL
);

875 ià(!
m­
) {

876 
	`kä“
(
em
);

877 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_MAP
);

878  -
ENOMEM
;

881 
	`£t_b™
(
EXTENT_FLAG_FS_MAPPING
, &
em
->
æags
);

883 
em
->
¡¬t
 = 
SZ_4G
;

884 
em
->
Ën
 = 
‹¡
->
d©a_¡re_size
 *e¡->
num_d©a_¡res
;

885 
em
->
block_Ën
 =ƒm->
Ën
;

886 
em
->
Üig_block_Ën
 = 
‹¡
->
d©a_¡re_size
;

887 
em
->
m­_lookup
 = 
m­
;

889 
m­
->
num_¡res
 = 
‹¡
->num_stripes;

890 
m­
->
ty³
 = 
‹¡
->
¿id_ty³
;

892 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

893 
bŒfs_deviû
 *
dev
 = 
	`bŒfs_®loc_dummy_deviû
(
fs_šfo
);

895 ià(
	`IS_ERR
(
dev
)) {

896 
	`‹¡_”r
("cannot‡llocate device");

897 
»t
 = 
	`PTR_ERR
(
dev
);

898 
out
;

900 
m­
->
¡res
[
i
].
dev
 = dev;

901 
m­
->
¡res
[
i
].
physiÿl
 = 
‹¡
->
d©a_¡re_phys_¡¬t
[i];

904 
	`wr™e_lock
(&
fs_šfo
->
m­pšg_Œ“
.
lock
);

905 
»t
 = 
	`add_ex‹Á_m­pšg
(&
fs_šfo
->
m­pšg_Œ“
, 
em
, 0);

906 
	`wr™e_uÆock
(&
fs_šfo
->
m­pšg_Œ“
.
lock
);

907 ià(
»t
) {

908 
	`‹¡_”r
("error‡dding block group mappingo mappingree");

909 
out_ä“
;

912 
»t
 = 
	`bŒfs_rm­_block
(
fs_šfo
, 
em
->
¡¬t
, 
	`bŒfs_sb_off£t
(1),

913 &
logiÿl
, &
out_ndaddrs
, &
out_¡re_Ën
);

914 ià(
»t
 || (
out_ndaddrs
 =ğ0 && 
‹¡
->
ex³ùed_m­³d_addr
)) {

915 
	`‹¡_”r
("didn't„map‡nything butƒxpected %d",

916 
‹¡
->
ex³ùed_m­³d_addr
);

917 
out
;

920 ià(
out_¡re_Ën
 !ğ
BTRFS_STRIPE_LEN
) {

921 
	`‹¡_”r
("calculated stripe†ength doesn't match");

922 
out
;

925 ià(
out_ndaddrs
 !ğ
‹¡
->
ex³ùed_m­³d_addr
) {

926 
i
 = 0; i < 
out_ndaddrs
; i++)

927 
	`‹¡_msg
("m­³d %Îu", 
logiÿl
[
i
]);

928 
	`‹¡_”r
("uÃx³ùed‚umb” oàm­³d‡dd»s£s: %d", 
out_ndaddrs
);

929 
out
;

932 
i
 = 0; i < 
out_ndaddrs
; i++) {

933 ià(
logiÿl
[
i
] !ğ
‹¡
->
m­³d_logiÿl
[i]) {

934 
	`‹¡_”r
("unexpected†ogical‡ddress mapped");

935 
out
;

939 
»t
 = 0;

940 
out
:

941 
	`wr™e_lock
(&
fs_šfo
->
m­pšg_Œ“
.
lock
);

942 
	`»move_ex‹Á_m­pšg
(&
fs_šfo
->
m­pšg_Œ“
, 
em
);

943 
	`wr™e_uÆock
(&
fs_šfo
->
m­pšg_Œ“
.
lock
);

945 
	`ä“_ex‹Á_m­
(
em
);

946 
out_ä“
:

948 
	`ä“_ex‹Á_m­
(
em
);

949 
	`kä“
(
logiÿl
);

950  
»t
;

951 
	}
}

953 
	$bŒfs_‹¡_ex‹Á_m­
()

955 
bŒfs_fs_šfo
 *
fs_šfo
 = 
NULL
;

956 
ex‹Á_m­_Œ“
 *
em_Œ“
;

957 
»t
 = 0, 
i
;

958 
rm­_‹¡_veùÜ
 
rm­_‹¡s
[] = {

965 .
¿id_ty³
 = 
BTRFS_BLOCK_GROUP_RAID1
,

966 .
physiÿl_¡¬t
 = 
SZ_64M
 - 
SZ_4M
,

967 .
d©a_¡re_size
 = 
SZ_256M
,

968 .
num_d©a_¡res
 = 2,

969 .
num_¡res
 = 2,

970 .
d©a_¡re_phys_¡¬t
 =

971 {
SZ_64M
 - 
SZ_4M
, SZ_64M - SZ_4M + 
SZ_256M
},

972 .
ex³ùed_m­³d_addr
 = 
Œue
,

973 .
m­³d_logiÿl
ğ{
SZ_4G
 + 
SZ_4M
}

982 .
¿id_ty³
 = 0,

983 .
physiÿl_¡¬t
 = 
SZ_4G
,

984 .
d©a_¡re_size
 = 
SZ_256M
,

985 .
num_d©a_¡res
 = 1,

986 .
num_¡res
 = 1,

987 .
d©a_¡re_phys_¡¬t
 = {
SZ_256M
},

988 .
ex³ùed_m­³d_addr
 = 
çl£
,

989 .
m­³d_logiÿl
 = {0}

993 
	`‹¡_msg
("runningƒxtent_mapests");

999 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
PAGE_SIZE
, PAGE_SIZE);

1000 ià(!
fs_šfo
) {

1001 
	`‹¡_¡d_”r
(
TEST_ALLOC_FS_INFO
);

1002  -
ENOMEM
;

1005 
em_Œ“
 = 
	`kz®loc
((*em_Œ“), 
GFP_KERNEL
);

1006 ià(!
em_Œ“
) {

1007 
»t
 = -
ENOMEM
;

1008 
out
;

1011 
	`ex‹Á_m­_Œ“_š™
(
em_Œ“
);

1013 
»t
 = 
	`‹¡_ÿ£_1
(
fs_šfo
, 
em_Œ“
);

1014 ià(
»t
)

1015 
out
;

1016 
»t
 = 
	`‹¡_ÿ£_2
(
fs_šfo
, 
em_Œ“
);

1017 ià(
»t
)

1018 
out
;

1019 
»t
 = 
	`‹¡_ÿ£_3
(
fs_šfo
, 
em_Œ“
);

1020 ià(
»t
)

1021 
out
;

1022 
»t
 = 
	`‹¡_ÿ£_4
(
fs_šfo
, 
em_Œ“
);

1023 ià(
»t
)

1024 
out
;

1025 
»t
 = 
	`‹¡_ÿ£_5
();

1026 ià(
»t
)

1027 
out
;

1028 
»t
 = 
	`‹¡_ÿ£_6
(
fs_šfo
, 
em_Œ“
);

1029 ià(
»t
)

1030 
out
;

1031 
»t
 = 
	`‹¡_ÿ£_7
();

1032 ià(
»t
)

1033 
out
;

1035 
	`‹¡_msg
("running„mapests");

1036 
i
 = 0; i < 
	`ARRAY_SIZE
(
rm­_‹¡s
); i++) {

1037 
»t
 = 
	`‹¡_rm­_block
(
fs_šfo
, &
rm­_‹¡s
[
i
]);

1038 ià(
»t
)

1039 
out
;

1042 
out
:

1043 
	`kä“
(
em_Œ“
);

1044 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

1046  
»t
;

1047 
	}
}

	@tests/free-space-tests.c

6 
	~<lšux/¦ab.h
>

7 
	~"bŒfs-‹¡s.h
"

8 
	~"../ù»e.h
"

9 
	~"../disk-io.h
"

10 
	~"../ä“-¥aû-ÿche.h
"

11 
	~"../block-group.h
"

13 
	#BITS_PER_BITMAP
 (
PAGE_SIZE
 * 8UL)

	)

20 
	$‹¡_ex‹Ás
(
bŒfs_block_group
 *
ÿche
)

22 
»t
 = 0;

24 
	`‹¡_msg
("runningƒxtent onlyests");

27 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 0, 
SZ_4M
);

28 ià(
»t
) {

29 
	`‹¡_”r
("”rÜ‡ddšg in™ŸÈex‹Á %d", 
»t
);

30  
»t
;

33 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 0, 
SZ_4M
);

34 ià(
»t
) {

35 
	`‹¡_”r
("”rÜ„emovšgƒx‹Á %d", 
»t
);

36  
»t
;

39 ià(
	`‹¡_check_exi¡s
(
ÿche
, 0, 
SZ_4M
)) {

40 
	`‹¡_”r
("full„emove†eft some†ingering space");

45 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 0, 
SZ_4M
);

46 ià(
»t
) {

47 
	`‹¡_”r
("”rÜ‡ddšg h®àex‹Á %d", 
»t
);

48  
»t
;

51 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 3 * 
SZ_1M
, SZ_1M);

52 ià(
»t
) {

53 
	`‹¡_”r
("”rÜ„emovšgaƒnd %d", 
»t
);

54  
»t
;

57 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 0, 
SZ_1M
);

58 ià(
»t
) {

59 
	`‹¡_”r
("”rÜ„emovšg frÚˆ’d %d", 
»t
);

60  
»t
;

63 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 
SZ_2M
, 4096);

64 ià(
»t
) {

65 
	`‹¡_”r
("”rÜ„emovšg middË…›û %d", 
»t
);

66  
»t
;

69 ià(
	`‹¡_check_exi¡s
(
ÿche
, 0, 
SZ_1M
)) {

70 
	`‹¡_”r
("still have space‡the front");

74 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_2M
, 4096)) {

75 
	`‹¡_”r
("still have space inhe middle");

79 ià(
	`‹¡_check_exi¡s
(
ÿche
, 3 * 
SZ_1M
, SZ_1M)) {

80 
	`‹¡_”r
("still have space‡theƒnd");

85 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

88 
	}
}

90 
	$‹¡_b™m­s
(
bŒfs_block_group
 *
ÿche
, 
u32
 
£ùÜsize
)

92 
u64
 
Ãxt_b™m­_off£t
;

93 
»t
;

95 
	`‹¡_msg
("running bitmap onlyests");

97 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 0, 
SZ_4M
, 1);

98 ià(
»t
) {

99 
	`‹¡_”r
("couldn'ˆü—‹‡ b™m­ƒÁry %d", 
»t
);

100  
»t
;

103 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 0, 
SZ_4M
);

104 ià(
»t
) {

105 
	`‹¡_”r
("”rÜ„emovšg b™m­ fuÎ„ªg%d", 
»t
);

106  
»t
;

109 ià(
	`‹¡_check_exi¡s
(
ÿche
, 0, 
SZ_4M
)) {

110 
	`‹¡_”r
("left some space in bitmap");

114 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 0, 
SZ_4M
, 1);

115 ià(
»t
) {

116 
	`‹¡_”r
("couldn'ˆaddØou¸b™m­ƒÁry %d", 
»t
);

117  
»t
;

120 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 
SZ_1M
, 
SZ_2M
);

121 ià(
»t
) {

122 
	`‹¡_”r
("couldn'ˆ»movmiddË chunk %d", 
»t
);

123  
»t
;

130 
Ãxt_b™m­_off£t
 = (
u64
)(
BITS_PER_BITMAP
 * 
£ùÜsize
);

133 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
Ãxt_b™m­_off£t
 - 
SZ_2M
,

134 
SZ_4M
, 1);

135 ià(
»t
) {

136 
	`‹¡_”r
("couldn't‡dd spacehat straddleswo bitmaps %d",

137 
»t
);

138  
»t
;

141 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 
Ãxt_b™m­_off£t
 - 
SZ_1M
, 
SZ_2M
);

142 ià(
»t
) {

143 
	`‹¡_”r
("couldn'ˆ»movov”Ïµšg s·û %d", 
»t
);

144  
»t
;

147 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
Ãxt_b™m­_off£t
 - 
SZ_1M
, 
SZ_2M
)) {

148 
	`‹¡_”r
("left some space when„emoving overlapping");

152 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

155 
	}
}

158 
	$‹¡_b™m­s_ªd_ex‹Ás
(
bŒfs_block_group
 *
ÿche
,

159 
u32
 
£ùÜsize
)

161 
u64
 
b™m­_off£t
 = (u64)(
BITS_PER_BITMAP
 * 
£ùÜsize
);

162 
»t
;

164 
	`‹¡_msg
("running bitmap‡ndƒxtentests");

171 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
SZ_4M
, 
SZ_1M
, 1);

172 ià(
»t
) {

173 
	`‹¡_”r
("couldn'ˆü—‹ b™m­ƒÁry %d", 
»t
);

174  
»t
;

177 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 0, 
SZ_1M
, 0);

178 ià(
»t
) {

179 
	`‹¡_”r
("couldn'ˆaddƒx‹ÁƒÁry %d", 
»t
);

180  
»t
;

183 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 0, 
SZ_1M
);

184 ià(
»t
) {

185 
	`‹¡_”r
("couldn'ˆ»movex‹ÁƒÁry %d", 
»t
);

186  
»t
;

189 ià(
	`‹¡_check_exi¡s
(
ÿche
, 0, 
SZ_1M
)) {

190 
	`‹¡_”r
("left„emnants‡fter our„emove");

195 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 0, 
SZ_1M
, 0);

196 ià(
»t
) {

197 
	`‹¡_”r
("couldn'ˆ»-addƒx‹ÁƒÁry %d", 
»t
);

198  
»t
;

201 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 
SZ_4M
, 
SZ_1M
);

202 ià(
»t
) {

203 
	`‹¡_”r
("couldn'ˆ»moväom b™m­ %d", 
»t
);

204  
»t
;

207 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_4M
, 
SZ_1M
)) {

208 
	`‹¡_”r
("left„emnants inhe bitmap");

216 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
SZ_1M
, 
SZ_4M
, 1);

217 ià(
»t
) {

218 
	`‹¡_”r
("couldn'ˆaddØ¨b™m­ %d", 
»t
);

219  
»t
;

222 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 
SZ_512K
, 3 * 
SZ_1M
);

223 ià(
»t
) {

224 
	`‹¡_”r
("couldn'ˆ»movov”Ïµšg s·û %d", 
»t
);

225  
»t
;

228 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_512K
, 3 * 
SZ_1M
)) {

229 
	`‹¡_”r
("left over…ieces‡fter„emoving overlapping");

233 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

236 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
SZ_4M
, SZ_4M, 1);

237 ià(
»t
) {

238 
	`‹¡_”r
("couldn'ˆadd s·ûØthb™m­ %d", 
»t
);

239  
»t
;

242 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
SZ_2M
, SZ_2M, 0);

243 ià(
»t
) {

244 
	`‹¡_”r
("couldn'ˆaddƒx‹ÁØthÿch%d", 
»t
);

245  
»t
;

248 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 3 * 
SZ_1M
, 
SZ_4M
);

249 ià(
»t
) {

250 
	`‹¡_”r
("´obËm„emovšg ov”Ïµšg s·û %d", 
»t
);

251  
»t
;

254 ià(
	`‹¡_check_exi¡s
(
ÿche
, 3 * 
SZ_1M
, 
SZ_4M
)) {

255 
	`‹¡_”r
("left something behind when„emoving space");

269 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

270 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
b™m­_off£t
 + 
SZ_4M
, SZ_4M, 1);

271 ià(
»t
) {

272 
	`‹¡_”r
("couldn'ˆadd b™m­ %d", 
»t
);

273  
»t
;

276 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
b™m­_off£t
 - 
SZ_1M
,

277 5 * 
SZ_1M
, 0);

278 ià(
»t
) {

279 
	`‹¡_”r
("couldn'ˆaddƒx‹ÁƒÁry %d", 
»t
);

280  
»t
;

283 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 
b™m­_off£t
 + 
SZ_1M
, 5 * SZ_1M);

284 ià(
»t
) {

285 
	`‹¡_”r
("çedØä“ ou¸¥aû %d", 
»t
);

286  
»t
;

289 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
b™m­_off£t
 + 
SZ_1M
, 5 * SZ_1M)) {

290 
	`‹¡_”r
("left stuff over");

294 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

302 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
SZ_1M
, 
SZ_2M
, 1);

303 ià(
»t
) {

304 
	`‹¡_”r
("couldn'ˆadd b™m­ƒÁry %d", 
»t
);

305  
»t
;

308 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 3 * 
SZ_1M
, SZ_1M, 0);

309 ià(
»t
) {

310 
	`‹¡_”r
("couldn'ˆaddƒx‹ÁƒÁry %d", 
»t
);

311  
»t
;

314 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 
SZ_1M
, 3 * SZ_1M);

315 ià(
»t
) {

316 
	`‹¡_”r
("”rÜ„emovšg b™m­‡ndƒx‹Á ov”Ïµšg %d", 
»t
);

317  
»t
;

320 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

322 
	}
}

325 
boŞ
 
	$‹¡_u£_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

326 
bŒfs_ä“_¥aû
 *
šfo
)

328  
ùl
->
ä“_ex‹Ás
 > 0;

329 
	}
}

333 
	$check_num_ex‹Ás_ªd_b™m­s
(cÚ¡ 
bŒfs_block_group
 *
ÿche
,

334 cÚ¡ 
num_ex‹Ás
,

335 cÚ¡ 
num_b™m­s
)

337 ià(
ÿche
->
ä“_¥aû_ùl
->
ä“_ex‹Ás
 !ğ
num_ex‹Ás
) {

338 
	`‹¡_”r
(

340 
ÿche
->
ä“_¥aû_ùl
->
ä“_ex‹Ás
, 
num_ex‹Ás
);

341  -
EINVAL
;

343 ià(
ÿche
->
ä“_¥aû_ùl
->
tÙ®_b™m­s
 !ğ
num_b™m­s
) {

344 
	`‹¡_”r
(

346 
ÿche
->
ä“_¥aû_ùl
->
tÙ®_b™m­s
, 
num_b™m­s
);

347  -
EINVAL
;

350 
	}
}

353 
	$check_ÿche_em±y
(
bŒfs_block_group
 *
ÿche
)

355 
u64
 
off£t
;

356 
u64
 
max_ex‹Á_size
;

362 ià(
ÿche
->
ä“_¥aû_ùl
->
ä“_¥aû
 != 0) {

363 
	`‹¡_”r
("cache free space is‚ot 0");

364  -
EINVAL
;

368 
off£t
 = 
	`bŒfs_fšd_¥aû_fÜ_®loc
(
ÿche
, 0, 4096, 0,

369 &
max_ex‹Á_size
);

370 ià(
off£t
 != 0) {

371 
	`‹¡_”r
("space‡llocation did‚ot fail,„eturned offset: %llu",

372 
off£t
);

373  -
EINVAL
;

377  
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 0, 0);

378 
	}
}

395 
	$‹¡_¡—l_¥aû_äom_b™m­_to_ex‹Á
(
bŒfs_block_group
 *
ÿche
,

396 
u32
 
£ùÜsize
)

398 
»t
;

399 
u64
 
off£t
;

400 
u64
 
max_ex‹Á_size
;

401 cÚ¡ 
bŒfs_ä“_¥aû_İ
 
‹¡_ä“_¥aû_İs
 = {

402 .
u£_b™m­
 = 
‹¡_u£_b™m­
,

404 cÚ¡ 
bŒfs_ä“_¥aû_İ
 *
Üig_ä“_¥aû_İs
;

406 
	`‹¡_msg
("running space stealing from bitmapoƒxtentests");

426 
Üig_ä“_¥aû_İs
 = 
ÿche
->
ä“_¥aû_ùl
->
İ
;

427 
ÿche
->
ä“_¥aû_ùl
->
İ
 = &
‹¡_ä“_¥aû_İs
;

432 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
SZ_128M
 - 
SZ_256K
, 
SZ_128K
, 0);

433 ià(
»t
) {

434 
	`‹¡_”r
("couldn'ˆaddƒx‹ÁƒÁry %d", 
»t
);

435  
»t
;

439 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
SZ_128M
 + 
SZ_512K
,

440 
SZ_128M
 - 
SZ_512K
, 1);

441 ià(
»t
) {

442 
	`‹¡_”r
("couldn'ˆadd b™m­ƒÁry %d", 
»t
);

443  
»t
;

446 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 2, 1);

447 ià(
»t
)

448  
»t
;

457 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
,

458 
SZ_128M
 + 768 * 
SZ_1K
,

459 
SZ_128M
 - 768 * 
SZ_1K
);

460 ià(
»t
) {

461 
	`‹¡_”r
("çedØä“…¬ˆoàb™m­ s·û %d", 
»t
);

462  
»t
;

466 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 - 
SZ_256K
, 
SZ_128K
)) {

467 
	`‹¡_”r
("free space„ange missing");

468  -
ENOENT
;

470 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 + 
SZ_512K
, 
SZ_256K
)) {

471 
	`‹¡_”r
("free space„ange missing");

472  -
ENOENT
;

479 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 + 768 * 
SZ_1K
,

480 
SZ_128M
 - 768 * 
SZ_1K
)) {

481 
	`‹¡_”r
("bitmap„egion‚ot„emoved from space cache");

482  -
EINVAL
;

489 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 + 
SZ_256K
, SZ_256K)) {

490 
	`‹¡_”r
("invalid bitmap„egion marked‡s free");

491  -
EINVAL
;

498 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
, 
SZ_256K
)) {

499 
	`‹¡_”r
("invalid bitmap„egion marked‡s free");

500  -
EINVAL
;

508 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
SZ_128M
, 
SZ_512K
);

509 ià(
»t
) {

510 
	`‹¡_”r
("”rÜ‡ddšg f»¥aû: %d", 
»t
);

511  
»t
;

514 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
, 
SZ_512K
)) {

515 
	`‹¡_”r
("bitmap„egion‚ot marked‡s free");

516  -
ENOENT
;

523 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 2, 1);

524 ià(
»t
)

525  
»t
;

533 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
SZ_128M
 + 
SZ_16M
, 
£ùÜsize
);

534 ià(
»t
) {

535 
	`‹¡_”r
("”rÜ‡ddšg f»¥aû: %d", 
»t
);

536  
»t
;

543 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 2, 1);

544 ià(
»t
)

545  
»t
;

552 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
SZ_128M
 - 
SZ_128K
, SZ_128K);

553 ià(
»t
) {

554 
	`‹¡_”r
("”rÜ‡ddšg f»¥aû: %d", 
»t
);

555  
»t
;

558 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 - 
SZ_128K
, SZ_128K)) {

559 
	`‹¡_”r
("extent„egion‚ot marked‡s free");

560  -
ENOENT
;

567 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 2, 1);

568 ià(
»t
)

569  
»t
;

586 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 - 
SZ_256K
, 
SZ_1M
)) {

587 
	`‹¡_”r
("expected„egion‚ot marked‡s free");

588  -
ENOENT
;

591 ià(
ÿche
->
ä“_¥aû_ùl
->
ä“_¥aû
 !ğ(
SZ_1M
 + 
£ùÜsize
)) {

592 
	`‹¡_”r
("ÿchä“ s·û i nÙ 1Mb + %u", 
£ùÜsize
);

593  -
EINVAL
;

596 
off£t
 = 
	`bŒfs_fšd_¥aû_fÜ_®loc
(
ÿche
,

597 0, 
SZ_1M
, 0,

598 &
max_ex‹Á_size
);

599 ià(
off£t
 !ğ(
SZ_128M
 - 
SZ_256K
)) {

600 
	`‹¡_”r
(

602 
off£t
);

603  -
EINVAL
;

610 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 1, 1);

611 ià(
»t
)

612  
»t
;

614 ià(
ÿche
->
ä“_¥aû_ùl
->
ä“_¥aû
 !ğ
£ùÜsize
) {

615 
	`‹¡_”r
("ÿchä“ s·û i nÙ %u", 
£ùÜsize
);

616  -
EINVAL
;

619 
off£t
 = 
	`bŒfs_fšd_¥aû_fÜ_®loc
(
ÿche
,

620 0, 
£ùÜsize
, 0,

621 &
max_ex‹Á_size
);

622 ià(
off£t
 !ğ(
SZ_128M
 + 
SZ_16M
)) {

623 
	`‹¡_”r
("failedo‡llocate %u,„eturned offset : %llu",

624 
£ùÜsize
, 
off£t
);

625  -
EINVAL
;

628 
»t
 = 
	`check_ÿche_em±y
(
ÿche
);

629 ià(
»t
)

630  
»t
;

632 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

643 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
SZ_128M
 + 
SZ_128K
, SZ_128K, 0);

644 ià(
»t
) {

645 
	`‹¡_”r
("couldn'ˆaddƒx‹ÁƒÁry %d", 
»t
);

646  
»t
;

650 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 0, 
SZ_128M
 - 
SZ_512K
, 1);

651 ià(
»t
) {

652 
	`‹¡_”r
("couldn'ˆadd b™m­ƒÁry %d", 
»t
);

653  
»t
;

656 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 2, 1);

657 ià(
»t
)

658  
»t
;

667 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 0, 
SZ_128M
 - 768 * 
SZ_1K
);

668 ià(
»t
) {

669 
	`‹¡_”r
("çedØä“…¬ˆoàb™m­ s·û %d", 
»t
);

670  
»t
;

674 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 + 
SZ_128K
, SZ_128K)) {

675 
	`‹¡_”r
("free space„ange missing");

676  -
ENOENT
;

678 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 - 768 * 
SZ_1K
, 
SZ_256K
)) {

679 
	`‹¡_”r
("free space„ange missing");

680  -
ENOENT
;

687 ià(
	`‹¡_check_exi¡s
(
ÿche
, 0, 
SZ_128M
 - 768 * 
SZ_1K
)) {

688 
	`‹¡_”r
("bitmap„egion‚ot„emoved from space cache");

689  -
EINVAL
;

696 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 - 
SZ_512K
, SZ_512K)) {

697 
	`‹¡_”r
("invalid bitmap„egion marked‡s free");

698  -
EINVAL
;

706 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
SZ_128M
 - 
SZ_512K
, SZ_512K);

707 ià(
»t
) {

708 
	`‹¡_”r
("”rÜ‡ddšg f»¥aû: %d", 
»t
);

709  
»t
;

712 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 - 
SZ_512K
, SZ_512K)) {

713 
	`‹¡_”r
("bitmap„egion‚ot marked‡s free");

714  -
ENOENT
;

721 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 2, 1);

722 ià(
»t
)

723  
»t
;

731 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
SZ_32M
, 2 * 
£ùÜsize
);

732 ià(
»t
) {

733 
	`‹¡_”r
("”rÜ‡ddšg f»¥aû: %d", 
»t
);

734  
»t
;

742 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
SZ_128M
, 
SZ_128K
);

743 ià(
»t
) {

744 
	`‹¡_”r
("”rÜ‡ddšg f»¥aû: %d", 
»t
);

745  
»t
;

748 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
, 
SZ_128K
)) {

749 
	`‹¡_”r
("extent„egion‚ot marked‡s free");

750  -
ENOENT
;

757 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 2, 1);

758 ià(
»t
)

759  
»t
;

776 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 - 768 * 
SZ_1K
, 
SZ_1M
)) {

777 
	`‹¡_”r
("expected„egion‚ot marked‡s free");

778  -
ENOENT
;

781 ià(
ÿche
->
ä“_¥aû_ùl
->
ä“_¥aû
 !ğ(
SZ_1M
 + 2 * 
£ùÜsize
)) {

782 
	`‹¡_”r
("ÿchä“ s·û i nÙ 1Mb + %u", 2 * 
£ùÜsize
);

783  -
EINVAL
;

786 
off£t
 = 
	`bŒfs_fšd_¥aû_fÜ_®loc
(
ÿche
, 0, 
SZ_1M
, 0,

787 &
max_ex‹Á_size
);

788 ià(
off£t
 !ğ(
SZ_128M
 - 768 * 
SZ_1K
)) {

789 
	`‹¡_”r
(

791 
off£t
);

792  -
EINVAL
;

799 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 1, 1);

800 ià(
»t
)

801  
»t
;

803 ià(
ÿche
->
ä“_¥aû_ùl
->
ä“_¥aû
 !ğ2 * 
£ùÜsize
) {

804 
	`‹¡_”r
("ÿchä“ s·û i nÙ %u", 2 * 
£ùÜsize
);

805  -
EINVAL
;

808 
off£t
 = 
	`bŒfs_fšd_¥aû_fÜ_®loc
(
ÿche
,

809 0, 2 * 
£ùÜsize
, 0,

810 &
max_ex‹Á_size
);

811 ià(
off£t
 !ğ
SZ_32M
) {

812 
	`‹¡_”r
("failedo‡llocate %u, offset: %llu",

813 2 * 
£ùÜsize
, 
off£t
);

814  -
EINVAL
;

817 
»t
 = 
	`check_ÿche_em±y
(
ÿche
);

818 ià(
»t
)

819  
»t
;

821 
ÿche
->
ä“_¥aû_ùl
->
İ
 = 
Üig_ä“_¥aû_İs
;

822 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

825 
	}
}

827 
boŞ
 
	$by‹s_šdex_u£_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

828 
bŒfs_ä“_¥aû
 *
šfo
)

830  
Œue
;

831 
	}
}

833 
	$‹¡_by‹s_šdex
(
bŒfs_block_group
 *
ÿche
, 
u32
 
£ùÜsize
)

835 cÚ¡ 
bŒfs_ä“_¥aû_İ
 
‹¡_ä“_¥aû_İs
 = {

836 .
u£_b™m­
 = 
by‹s_šdex_u£_b™m­
,

838 cÚ¡ 
bŒfs_ä“_¥aû_İ
 *
Üig_ä“_¥aû_İs
;

839 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
ÿche
->
ä“_¥aû_ùl
;

840 
bŒfs_ä“_¥aû
 *
’Œy
;

841 
rb_node
 *
node
;

842 
u64
 
off£t
, 
max_ex‹Á_size
, 
by‹s
;

843 
»t
, 
i
;

845 
	`‹¡_msg
("running bytes indexests");

848 
off£t
 = 0;

849 
i
 = 0; i < 10; i++) {

850 
by‹s
 = (
i
 + 1è* 
SZ_1M
;

851 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
off£t
, 
by‹s
, 0);

852 ià(
»t
) {

853 
	`‹¡_”r
("couldn'ˆaddƒx‹ÁƒÁry %d\n", 
»t
);

854  
»t
;

856 
off£t
 +ğ
by‹s
 + 
£ùÜsize
;

859 
node
 = 
	`rb_fœ¡_ÿched
(&
ùl
->
ä“_¥aû_by‹s
), 
i
 = 9;‚ode;

860 
node
 = 
	`rb_Ãxt
Òode), 
i
--) {

861 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
by‹s_šdex
);

862 
by‹s
 = (
i
 + 1è* 
SZ_1M
;

863 ià(
’Œy
->
by‹s
 != bytes) {

864 
	`‹¡_”r
("invalid bytes index order, found %lluƒxpected %llu",

865 
’Œy
->
by‹s
, bytes);

866  -
EINVAL
;

871 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

872 
i
 = 0; i < 2; i++) {

873 
off£t
 = 
i
 * 
BITS_PER_BITMAP
 * 
£ùÜsize
;

874 
by‹s
 = (
i
 + 1è* 
SZ_1M
;

875 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
off£t
, 
by‹s
, 1);

876 ià(
»t
) {

877 
	`‹¡_”r
("couldn't‡dd bitmapƒntry");

878  
»t
;

882 
node
 = 
	`rb_fœ¡_ÿched
(&
ùl
->
ä“_¥aû_by‹s
), 
i
 = 1;‚ode;

883 
node
 = 
	`rb_Ãxt
Òode), 
i
--) {

884 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
by‹s_šdex
);

885 
by‹s
 = (
i
 + 1è* 
SZ_1M
;

886 ià(
’Œy
->
by‹s
 != bytes) {

887 
	`‹¡_”r
("invalid bytes index order, found %lluƒxpected %llu",

888 
’Œy
->
by‹s
, bytes);

889  -
EINVAL
;

894 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

895 
Üig_ä“_¥aû_İs
 = 
ÿche
->
ä“_¥aû_ùl
->
İ
;

896 
ÿche
->
ä“_¥aû_ùl
->
İ
 = &
‹¡_ä“_¥aû_İs
;

898 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 0, 
£ùÜsize
, 1);

899 ià(
»t
) {

900 
	`‹¡_”r
("couldn't‡dd bitmapƒntry");

901  
»t
;

904 
off£t
 = 
BITS_PER_BITMAP
 * 
£ùÜsize
;

905 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
off£t
, 
£ùÜsize
, 1);

906 ià(
»t
) {

907 
	`‹¡_”r
("couldn't‡dd bitmap_entry");

908  
»t
;

915 
i
 = 2; i < 20; i += 2) {

916 
off£t
 = 
£ùÜsize
 * 
i
;

917 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
off£t
, 
£ùÜsize
);

918 ià(
»t
) {

919 
	`‹¡_”r
("”rÜ…İuÏtšg s·r£ b™m­ %d", 
»t
);

920  
»t
;

928 
off£t
 = (
BITS_PER_BITMAP
 * 
£ùÜsize
) + sectorsize;

929 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
off£t
, 
£ùÜsize
);

930 ià(
»t
) {

931 
	`‹¡_”r
("”rÜ‡ddšg cÚtiguou ex‹Á %d", 
»t
);

932  
»t
;

939 
’Œy
 = 
	`rb_’Œy
(
	`rb_fœ¡_ÿched
(&
ùl
->
ä“_¥aû_by‹s
),

940 
bŒfs_ä“_¥aû
, 
by‹s_šdex
);

941 ià(
’Œy
->
by‹s
 !ğ(10 * 
£ùÜsize
)) {

942 
	`‹¡_”r
("error, wrongƒntry inhe first slot in bytes_index");

943  -
EINVAL
;

946 
max_ex‹Á_size
 = 0;

947 
off£t
 = 
	`bŒfs_fšd_¥aû_fÜ_®loc
(
ÿche
, cache->
¡¬t
, 
£ùÜsize
 * 3,

948 0, &
max_ex‹Á_size
);

949 ià(
off£t
 != 0) {

950 
	`‹¡_”r
("found spaceo‡llocƒvenhough we don't haveƒnough space");

951  -
EINVAL
;

954 ià(
max_ex‹Á_size
 !ğ(2 * 
£ùÜsize
)) {

955 
	`‹¡_”r
("gothe wrong max_extent size %lluƒxpected %llu",

956 
max_ex‹Á_size
, ()(2 * 
£ùÜsize
));

957  -
EINVAL
;

964 
’Œy
 = 
	`rb_’Œy
(
	`rb_fœ¡_ÿched
(&
ùl
->
ä“_¥aû_by‹s
),

965 
bŒfs_ä“_¥aû
, 
by‹s_šdex
);

966 ià(
’Œy
->
by‹s
 !ğ(2 * 
£ùÜsize
)) {

967 
	`‹¡_”r
("error,he bytes index wasn't„ecalculated…roperly");

968  -
EINVAL
;

972 
off£t
 = (
BITS_PER_BITMAP
 * 
£ùÜsize
) - sectorsize;

973 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
off£t
, 
£ùÜsize
);

974 ià(
»t
) {

975 
	`‹¡_”r
("”rÜ‡ddšgƒx‹ÁØth¥¬£ƒÁry %d", 
»t
);

976  
»t
;

979 
’Œy
 = 
	`rb_’Œy
(
	`rb_fœ¡_ÿched
(&
ùl
->
ä“_¥aû_by‹s
),

980 
bŒfs_ä“_¥aû
, 
by‹s_šdex
);

981 ià(
’Œy
->
by‹s
 !ğ(11 * 
£ùÜsize
)) {

982 
	`‹¡_”r
("error, wrongƒntry inhe first slot in bytes_index");

983  -
EINVAL
;

990 
max_ex‹Á_size
 = 0;

991 
off£t
 = 
	`bŒfs_fšd_¥aû_fÜ_®loc
(
ÿche
, cache->
¡¬t
, 
£ùÜsize
 * 2,

992 0, &
max_ex‹Á_size
);

993 ià(
off£t
 !ğ(
BITS_PER_BITMAP
 * 
£ùÜsize
)) {

994 
	`‹¡_”r
("error, found %llu instead of %llu for our‡lloc",

995 
off£t
,

996 ()(
BITS_PER_BITMAP
 * 
£ùÜsize
));

997  -
EINVAL
;

1000 
ÿche
->
ä“_¥aû_ùl
->
İ
 = 
Üig_ä“_¥aû_İs
;

1001 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

1003 
	}
}

1005 
	$bŒfs_‹¡_ä“_¥aû_ÿche
(
u32
 
£ùÜsize
, u32 
nodesize
)

1007 
bŒfs_fs_šfo
 *
fs_šfo
;

1008 
bŒfs_block_group
 *
ÿche
;

1009 
bŒfs_roÙ
 *
roÙ
 = 
NULL
;

1010 
»t
 = -
ENOMEM
;

1012 
	`‹¡_msg
("running btrfs free space cacheests");

1013 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
nodesize
, 
£ùÜsize
);

1014 ià(!
fs_šfo
) {

1015 
	`‹¡_¡d_”r
(
TEST_ALLOC_FS_INFO
);

1016  -
ENOMEM
;

1024 
ÿche
 = 
	`bŒfs_®loc_dummy_block_group
(
fs_šfo
,

1025 
BITS_PER_BITMAP
 * 
£ùÜsize
 + 
PAGE_SIZE
);

1026 ià(!
ÿche
) {

1027 
	`‹¡_¡d_”r
(
TEST_ALLOC_BLOCK_GROUP
);

1028 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

1032 
roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

1033 ià(
	`IS_ERR
(
roÙ
)) {

1034 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

1035 
»t
 = 
	`PTR_ERR
(
roÙ
);

1036 
out
;

1039 
roÙ
->
roÙ_key
.
objeùid
 = 
BTRFS_EXTENT_TREE_OBJECTID
;

1040 
roÙ
->
roÙ_key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

1041 
roÙ
->
roÙ_key
.
off£t
 = 0;

1042 
	`bŒfs_glob®_roÙ_š£¹
(
roÙ
);

1044 
»t
 = 
	`‹¡_ex‹Ás
(
ÿche
);

1045 ià(
»t
)

1046 
out
;

1047 
»t
 = 
	`‹¡_b™m­s
(
ÿche
, 
£ùÜsize
);

1048 ià(
»t
)

1049 
out
;

1050 
»t
 = 
	`‹¡_b™m­s_ªd_ex‹Ás
(
ÿche
, 
£ùÜsize
);

1051 ià(
»t
)

1052 
out
;

1054 
»t
 = 
	`‹¡_¡—l_¥aû_äom_b™m­_to_ex‹Á
(
ÿche
, 
£ùÜsize
);

1055 ià(
»t
)

1056 
out
;

1057 
»t
 = 
	`‹¡_by‹s_šdex
(
ÿche
, 
£ùÜsize
);

1058 
out
:

1059 
	`bŒfs_ä“_dummy_block_group
(
ÿche
);

1060 
	`bŒfs_ä“_dummy_roÙ
(
roÙ
);

1061 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

1062  
»t
;

1063 
	}
}

	@tests/free-space-tree-tests.c

6 
	~<lšux/ty³s.h
>

7 
	~"bŒfs-‹¡s.h
"

8 
	~"../ù»e.h
"

9 
	~"../disk-io.h
"

10 
	~"../ä“-¥aû-Œ“.h
"

11 
	~"../Œª§ùiÚ.h
"

12 
	~"../block-group.h
"

13 
	~"../acûssÜs.h
"

15 
	sä“_¥aû_ex‹Á
 {

16 
u64
 
	m¡¬t
;

17 
u64
 
	mËngth
;

20 
	$__check_ä“_¥aû_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

21 
bŒfs_fs_šfo
 *
fs_šfo
,

22 
bŒfs_block_group
 *
ÿche
,

23 
bŒfs_·th
 *
·th
,

24 cÚ¡ 
ä“_¥aû_ex‹Á
 * cÚ¡ 
ex‹Ás
,

25 
num_ex‹Ás
)

27 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

28 
bŒfs_key
 
key
;

29 
´ev_b™
 = 0, 
b™
;

30 
u64
 
ex‹Á_¡¬t
 = 0, 
off£t
, 
’d
;

31 
u32
 
æags
, 
ex‹Á_couÁ
;

32 
i
;

33 
»t
;

35 
šfo
 = 
	`£¬ch_ä“_¥aû_šfo
(
Œªs
, 
ÿche
, 
·th
, 0);

36 ià(
	`IS_ERR
(
šfo
)) {

37 
	`‹¡_”r
("could‚ot find free space info");

38 
»t
 = 
	`PTR_ERR
(
šfo
);

39 
out
;

41 
æags
 = 
	`bŒfs_ä“_¥aû_æags
(
·th
->
nodes
[0], 
šfo
);

42 
ex‹Á_couÁ
 = 
	`bŒfs_ä“_¥aû_ex‹Á_couÁ
(
·th
->
nodes
[0], 
šfo
);

44 ià(
ex‹Á_couÁ
 !ğ
num_ex‹Ás
) {

45 
	`‹¡_”r
("extent count is wrong");

46 
»t
 = -
EINVAL
;

47 
out
;

49 ià(
æags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) {

50 ià(
·th
->
¦Ùs
[0] != 0)

51 
šv®id
;

52 
’d
 = 
ÿche
->
¡¬t
 + cache->
Ëngth
;

53 
i
 = 0;

54 ++
·th
->
¦Ùs
[0] < 
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0])) {

55 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

56 ià(
key
.
ty³
 !ğ
BTRFS_FREE_SPACE_BITMAP_KEY
)

57 
šv®id
;

58 
off£t
 = 
key
.
objeùid
;

59 
off£t
 < 
key
.
objeùid
 + key.offset) {

60 
b™
 = 
	`ä“_¥aû_‹¡_b™
(
ÿche
, 
·th
, 
off£t
);

61 ià(
´ev_b™
 =ğ0 && 
b™
 == 1) {

62 
ex‹Á_¡¬t
 = 
off£t
;

63 } ià(
´ev_b™
 =ğ1 && 
b™
 == 0) {

64 ià(
i
 >ğ
num_ex‹Ás
 ||

65 
ex‹Á_¡¬t
 !ğ
ex‹Ás
[
i
].
¡¬t
 ||

66 
off£t
 - 
ex‹Á_¡¬t
 !ğ
ex‹Ás
[
i
].
Ëngth
)

67 
šv®id
;

68 
i
++;

70 
´ev_b™
 = 
b™
;

71 
off£t
 +ğ
fs_šfo
->
£ùÜsize
;

74 ià(
´ev_b™
 == 1) {

75 ià(
i
 >ğ
num_ex‹Ás
 ||

76 
ex‹Á_¡¬t
 !ğ
ex‹Ás
[
i
].
¡¬t
 ||

77 
’d
 - 
ex‹Á_¡¬t
 !ğ
ex‹Ás
[
i
].
Ëngth
)

78 
šv®id
;

79 
i
++;

81 ià(
i
 !ğ
num_ex‹Ás
)

82 
šv®id
;

84 ià(
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]è!ğ
num_ex‹Ás
 + 1 ||

85 
·th
->
¦Ùs
[0] != 0)

86 
šv®id
;

87 
i
 = 0; i < 
num_ex‹Ás
; i++) {

88 
·th
->
¦Ùs
[0]++;

89 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

90 ià(
key
.
ty³
 !ğ
BTRFS_FREE_SPACE_EXTENT_KEY
 ||

91 
key
.
objeùid
 !ğ
ex‹Ás
[
i
].
¡¬t
 ||

92 
key
.
off£t
 !ğ
ex‹Ás
[
i
].
Ëngth
)

93 
šv®id
;

97 
»t
 = 0;

98 
out
:

99 
	`bŒfs_»Ëa£_·th
(
·th
);

100  
»t
;

101 
šv®id
:

102 
	`‹¡_”r
("free spaceree is invalid");

103 
»t
 = -
EINVAL
;

104 
out
;

105 
	}
}

107 
	$check_ä“_¥aû_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

108 
bŒfs_fs_šfo
 *
fs_šfo
,

109 
bŒfs_block_group
 *
ÿche
,

110 
bŒfs_·th
 *
·th
,

111 cÚ¡ 
ä“_¥aû_ex‹Á
 * cÚ¡ 
ex‹Ás
,

112 
num_ex‹Ás
)

114 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

115 
u32
 
æags
;

116 
»t
;

118 
šfo
 = 
	`£¬ch_ä“_¥aû_šfo
(
Œªs
, 
ÿche
, 
·th
, 0);

119 ià(
	`IS_ERR
(
šfo
)) {

120 
	`‹¡_”r
("could‚ot find free space info");

121 
	`bŒfs_»Ëa£_·th
(
·th
);

122  
	`PTR_ERR
(
šfo
);

124 
æags
 = 
	`bŒfs_ä“_¥aû_æags
(
·th
->
nodes
[0], 
šfo
);

125 
	`bŒfs_»Ëa£_·th
(
·th
);

127 
»t
 = 
	`__check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
, 
ex‹Ás
,

128 
num_ex‹Ás
);

129 ià(
»t
)

130  
»t
;

133 ià(
æags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) {

134 
»t
 = 
	`cÚv”t_ä“_¥aû_to_ex‹Ás
(
Œªs
, 
ÿche
, 
·th
);

135 ià(
»t
) {

136 
	`‹¡_”r
("could‚ot convertoƒxtents");

137  
»t
;

140 
»t
 = 
	`cÚv”t_ä“_¥aû_to_b™m­s
(
Œªs
, 
ÿche
, 
·th
);

141 ià(
»t
) {

142 
	`‹¡_”r
("could‚ot converto bitmaps");

143  
»t
;

146  
	`__check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
, 
ex‹Ás
,

147 
num_ex‹Ás
);

148 
	}
}

150 
	$‹¡_em±y_block_group
(
bŒfs_Œªs_hªdË
 *
Œªs
,

151 
bŒfs_fs_šfo
 *
fs_šfo
,

152 
bŒfs_block_group
 *
ÿche
,

153 
bŒfs_·th
 *
·th
,

154 
u32
 
®ignm’t
)

156 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {

157 {
ÿche
->
¡¬t
, cache->
Ëngth
},

160  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

161 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

162 
	}
}

164 
	$‹¡_»move_®l
(
bŒfs_Œªs_hªdË
 *
Œªs
,

165 
bŒfs_fs_šfo
 *
fs_šfo
,

166 
bŒfs_block_group
 *
ÿche
,

167 
bŒfs_·th
 *
·th
,

168 
u32
 
®ignm’t
)

170 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {};

171 
»t
;

173 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
,

174 
ÿche
->
¡¬t
,

175 
ÿche
->
Ëngth
);

176 ià(
»t
) {

177 
	`‹¡_”r
("could‚ot„emove free space");

178  
»t
;

181  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

182 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

183 
	}
}

185 
	$‹¡_»move_begšnšg
(
bŒfs_Œªs_hªdË
 *
Œªs
,

186 
bŒfs_fs_šfo
 *
fs_šfo
,

187 
bŒfs_block_group
 *
ÿche
,

188 
bŒfs_·th
 *
·th
,

189 
u32
 
®ignm’t
)

191 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {

192 {
ÿche
->
¡¬t
 + 
®ignm’t
, cache->
Ëngth
 -‡lignment},

194 
»t
;

196 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
,

197 
ÿche
->
¡¬t
, 
®ignm’t
);

198 ià(
»t
) {

199 
	`‹¡_”r
("could‚ot„emove free space");

200  
»t
;

203  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

204 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

206 
	}
}

208 
	$‹¡_»move_’d
(
bŒfs_Œªs_hªdË
 *
Œªs
,

209 
bŒfs_fs_šfo
 *
fs_šfo
,

210 
bŒfs_block_group
 *
ÿche
,

211 
bŒfs_·th
 *
·th
,

212 
u32
 
®ignm’t
)

214 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {

215 {
ÿche
->
¡¬t
, cache->
Ëngth
 - 
®ignm’t
},

217 
»t
;

219 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
,

220 
ÿche
->
¡¬t
 + cache->
Ëngth
 - 
®ignm’t
,

221 
®ignm’t
);

222 ià(
»t
) {

223 
	`‹¡_”r
("could‚ot„emove free space");

224  
»t
;

227  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

228 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

229 
	}
}

231 
	$‹¡_»move_middË
(
bŒfs_Œªs_hªdË
 *
Œªs
,

232 
bŒfs_fs_šfo
 *
fs_šfo
,

233 
bŒfs_block_group
 *
ÿche
,

234 
bŒfs_·th
 *
·th
,

235 
u32
 
®ignm’t
)

237 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {

238 {
ÿche
->
¡¬t
, 
®ignm’t
},

239 {
ÿche
->
¡¬t
 + 2 * 
®ignm’t
, cache->
Ëngth
 - 2 *‡lignment},

241 
»t
;

243 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
,

244 
ÿche
->
¡¬t
 + 
®ignm’t
,

245 
®ignm’t
);

246 ià(
»t
) {

247 
	`‹¡_”r
("could‚ot„emove free space");

248  
»t
;

251  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

252 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

253 
	}
}

255 
	$‹¡_m”ge_Ëá
(
bŒfs_Œªs_hªdË
 *
Œªs
,

256 
bŒfs_fs_šfo
 *
fs_šfo
,

257 
bŒfs_block_group
 *
ÿche
,

258 
bŒfs_·th
 *
·th
,

259 
u32
 
®ignm’t
)

261 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {

262 {
ÿche
->
¡¬t
, 2 * 
®ignm’t
},

264 
»t
;

266 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
,

267 
ÿche
->
¡¬t
, cache->
Ëngth
);

268 ià(
»t
) {

269 
	`‹¡_”r
("could‚ot„emove free space");

270  
»t
;

273 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
, cache->
¡¬t
,

274 
®ignm’t
);

275 ià(
»t
) {

276 
	`‹¡_”r
("could‚ot‡dd free space");

277  
»t
;

280 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
,

281 
ÿche
->
¡¬t
 + 
®ignm’t
,

282 
®ignm’t
);

283 ià(
»t
) {

284 
	`‹¡_”r
("could‚ot‡dd free space");

285  
»t
;

288  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

289 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

290 
	}
}

292 
	$‹¡_m”ge_right
(
bŒfs_Œªs_hªdË
 *
Œªs
,

293 
bŒfs_fs_šfo
 *
fs_šfo
,

294 
bŒfs_block_group
 *
ÿche
,

295 
bŒfs_·th
 *
·th
,

296 
u32
 
®ignm’t
)

298 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {

299 {
ÿche
->
¡¬t
 + 
®ignm’t
, 2 *‡lignment},

301 
»t
;

303 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
,

304 
ÿche
->
¡¬t
, cache->
Ëngth
);

305 ià(
»t
) {

306 
	`‹¡_”r
("could‚ot„emove free space");

307  
»t
;

310 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
,

311 
ÿche
->
¡¬t
 + 2 * 
®ignm’t
,

312 
®ignm’t
);

313 ià(
»t
) {

314 
	`‹¡_”r
("could‚ot‡dd free space");

315  
»t
;

318 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
,

319 
ÿche
->
¡¬t
 + 
®ignm’t
,

320 
®ignm’t
);

321 ià(
»t
) {

322 
	`‹¡_”r
("could‚ot‡dd free space");

323  
»t
;

326  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

327 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

328 
	}
}

330 
	$‹¡_m”ge_bÙh
(
bŒfs_Œªs_hªdË
 *
Œªs
,

331 
bŒfs_fs_šfo
 *
fs_šfo
,

332 
bŒfs_block_group
 *
ÿche
,

333 
bŒfs_·th
 *
·th
,

334 
u32
 
®ignm’t
)

336 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {

337 {
ÿche
->
¡¬t
, 3 * 
®ignm’t
},

339 
»t
;

341 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
,

342 
ÿche
->
¡¬t
, cache->
Ëngth
);

343 ià(
»t
) {

344 
	`‹¡_”r
("could‚ot„emove free space");

345  
»t
;

348 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
, cache->
¡¬t
,

349 
®ignm’t
);

350 ià(
»t
) {

351 
	`‹¡_”r
("could‚ot‡dd free space");

352  
»t
;

355 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
,

356 
ÿche
->
¡¬t
 + 2 * 
®ignm’t
,‡lignment);

357 ià(
»t
) {

358 
	`‹¡_”r
("could‚ot‡dd free space");

359  
»t
;

362 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
,

363 
ÿche
->
¡¬t
 + 
®ignm’t
,‡lignment);

364 ià(
»t
) {

365 
	`‹¡_”r
("could‚ot‡dd free space");

366  
»t
;

369  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

370 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

371 
	}
}

373 
	$‹¡_m”ge_nÚe
(
bŒfs_Œªs_hªdË
 *
Œªs
,

374 
bŒfs_fs_šfo
 *
fs_šfo
,

375 
bŒfs_block_group
 *
ÿche
,

376 
bŒfs_·th
 *
·th
,

377 
u32
 
®ignm’t
)

379 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {

380 {
ÿche
->
¡¬t
, 
®ignm’t
},

381 {
ÿche
->
¡¬t
 + 2 * 
®ignm’t
,‡lignment},

382 {
ÿche
->
¡¬t
 + 4 * 
®ignm’t
,‡lignment},

384 
»t
;

386 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
,

387 
ÿche
->
¡¬t
, cache->
Ëngth
);

388 ià(
»t
) {

389 
	`‹¡_”r
("could‚ot„emove free space");

390  
»t
;

393 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
, cache->
¡¬t
,

394 
®ignm’t
);

395 ià(
»t
) {

396 
	`‹¡_”r
("could‚ot‡dd free space");

397  
»t
;

400 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
,

401 
ÿche
->
¡¬t
 + 4 * 
®ignm’t
,‡lignment);

402 ià(
»t
) {

403 
	`‹¡_”r
("could‚ot‡dd free space");

404  
»t
;

407 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
ÿche
, 
·th
,

408 
ÿche
->
¡¬t
 + 2 * 
®ignm’t
,‡lignment);

409 ià(
»t
) {

410 
	`‹¡_”r
("could‚ot‡dd free space");

411  
»t
;

414  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

415 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

416 
	}
}

418 (*
	t‹¡_func_t
)(
	tbŒfs_Œªs_hªdË
 *,

419 
	tbŒfs_fs_šfo
 *,

420 
	tbŒfs_block_group
 *,

421 
	tbŒfs_·th
 *,

422 
	tu32
 
	t®ignm’t
);

424 
	$run_‹¡
(
‹¡_func_t
 
‹¡_func
, 
b™m­s
, 
u32
 
£ùÜsize
,

425 
u32
 
nodesize
, u32 
®ignm’t
)

427 
bŒfs_fs_šfo
 *
fs_šfo
;

428 
bŒfs_roÙ
 *
roÙ
 = 
NULL
;

429 
bŒfs_block_group
 *
ÿche
 = 
NULL
;

430 
bŒfs_Œªs_hªdË
 
Œªs
;

431 
bŒfs_·th
 *
·th
 = 
NULL
;

432 
»t
;

434 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
nodesize
, 
£ùÜsize
);

435 ià(!
fs_šfo
) {

436 
	`‹¡_¡d_”r
(
TEST_ALLOC_FS_INFO
);

437 
»t
 = -
ENOMEM
;

438 
out
;

441 
roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

442 ià(
	`IS_ERR
(
roÙ
)) {

443 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

444 
»t
 = 
	`PTR_ERR
(
roÙ
);

445 
out
;

448 
	`bŒfs_£t_su³r_com·t_ro_æags
(
roÙ
->
fs_šfo
->
su³r_cİy
,

449 
BTRFS_FEATURE_COMPAT_RO_FREE_SPACE_TREE
);

450 
roÙ
->
roÙ_key
.
objeùid
 = 
BTRFS_FREE_SPACE_TREE_OBJECTID
;

451 
roÙ
->
roÙ_key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

452 
roÙ
->
roÙ_key
.
off£t
 = 0;

453 
	`bŒfs_glob®_roÙ_š£¹
(
roÙ
);

454 
roÙ
->
fs_šfo
->
Œ“_roÙ
 =„oot;

456 
roÙ
->
node
 = 
	`®loc_‹¡_ex‹Á_bufãr
ÔoÙ->
fs_šfo
, 
nodesize
);

457 ià(
	`IS_ERR
(
roÙ
->
node
)) {

458 
	`‹¡_¡d_”r
(
TEST_ALLOC_EXTENT_BUFFER
);

459 
»t
 = 
	`PTR_ERR
(
roÙ
->
node
);

460 
out
;

462 
	`bŒfs_£t_h—d”_Ëv–
(
roÙ
->
node
, 0);

463 
	`bŒfs_£t_h—d”_Ä™ems
(
roÙ
->
node
, 0);

464 
roÙ
->
®loc_by‹Ä
 +ğ2 * 
nodesize
;

466 
ÿche
 = 
	`bŒfs_®loc_dummy_block_group
(
fs_šfo
, 8 * 
®ignm’t
);

467 ià(!
ÿche
) {

468 
	`‹¡_¡d_”r
(
TEST_ALLOC_BLOCK_GROUP
);

469 
»t
 = -
ENOMEM
;

470 
out
;

472 
ÿche
->
b™m­_low_th»sh
 = 0;

473 
ÿche
->
b™m­_high_th»sh
 = (
u32
)-1;

474 
	`£t_b™
(
BLOCK_GROUP_FLAG_NEEDS_FREE_SPACE
, &
ÿche
->
ruÁime_æags
);

475 
ÿche
->
fs_šfo
 = 
roÙ
->fs_info;

477 
	`bŒfs_š™_dummy_Œªs
(&
Œªs
, 
roÙ
->
fs_šfo
);

479 
·th
 = 
	`bŒfs_®loc_·th
();

480 ià(!
·th
) {

481 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

482 
»t
 = -
ENOMEM
;

483 
out
;

486 
»t
 = 
	`add_block_group_ä“_¥aû
(&
Œªs
, 
ÿche
);

487 ià(
»t
) {

488 
	`‹¡_”r
("could‚ot‡dd block group free space");

489 
out
;

492 ià(
b™m­s
) {

493 
»t
 = 
	`cÚv”t_ä“_¥aû_to_b™m­s
(&
Œªs
, 
ÿche
, 
·th
);

494 ià(
»t
) {

495 
	`‹¡_”r
("could‚ot convert block groupo bitmaps");

496 
out
;

500 
»t
 = 
	`‹¡_func
(&
Œªs
, 
roÙ
->
fs_šfo
, 
ÿche
, 
·th
, 
®ignm’t
);

501 ià(
»t
)

502 
out
;

504 
»t
 = 
	`»move_block_group_ä“_¥aû
(&
Œªs
, 
ÿche
);

505 ià(
»t
) {

506 
	`‹¡_”r
("could‚ot„emove block group free space");

507 
out
;

510 ià(
	`bŒfs_h—d”_Ä™ems
(
roÙ
->
node
) != 0) {

511 
	`‹¡_”r
("free spaceree has†eftover items");

512 
»t
 = -
EINVAL
;

513 
out
;

516 
»t
 = 0;

517 
out
:

518 
	`bŒfs_ä“_·th
(
·th
);

519 
	`bŒfs_ä“_dummy_block_group
(
ÿche
);

520 
	`bŒfs_ä“_dummy_roÙ
(
roÙ
);

521 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

522  
»t
;

523 
	}
}

525 
	$run_‹¡_bÙh_fÜm©s
(
‹¡_func_t
 
‹¡_func
, 
u32
 
£ùÜsize
,

526 
u32
 
nodesize
, u32 
®ignm’t
)

528 
‹¡_»t
 = 0;

529 
»t
;

531 
»t
 = 
	`run_‹¡
(
‹¡_func
, 0, 
£ùÜsize
, 
nodesize
, 
®ignm’t
);

532 ià(
»t
) {

533 
	`‹¡_”r
(

535 
‹¡_func
, 
£ùÜsize
, 
nodesize
, 
®ignm’t
);

536 
‹¡_»t
 = 
»t
;

539 
»t
 = 
	`run_‹¡
(
‹¡_func
, 1, 
£ùÜsize
, 
nodesize
, 
®ignm’t
);

540 ià(
»t
) {

541 
	`‹¡_”r
(

543 
‹¡_func
, 
£ùÜsize
, 
nodesize
, 
®ignm’t
);

544 
‹¡_»t
 = 
»t
;

547  
‹¡_»t
;

548 
	}
}

550 
	$bŒfs_‹¡_ä“_¥aû_Œ“
(
u32
 
£ùÜsize
, u32 
nodesize
)

552 
‹¡_func_t
 
‹¡s
[] = {

553 
‹¡_em±y_block_group
,

554 
‹¡_»move_®l
,

555 
‹¡_»move_begšnšg
,

556 
‹¡_»move_’d
,

557 
‹¡_»move_middË
,

558 
‹¡_m”ge_Ëá
,

559 
‹¡_m”ge_right
,

560 
‹¡_m”ge_bÙh
,

561 
‹¡_m”ge_nÚe
,

563 
u32
 
b™m­_®ignm’t
;

564 
‹¡_»t
 = 0;

565 
i
;

571 
b™m­_®ignm’t
 = 
BTRFS_FREE_SPACE_BITMAP_BITS
 * 
PAGE_SIZE
;

573 
	`‹¡_msg
("running free spacereeests");

574 
i
 = 0; i < 
	`ARRAY_SIZE
(
‹¡s
); i++) {

575 
»t
;

577 
»t
 = 
	`run_‹¡_bÙh_fÜm©s
(
‹¡s
[
i
], 
£ùÜsize
, 
nodesize
,

578 
£ùÜsize
);

579 ià(
»t
)

580 
‹¡_»t
 = 
»t
;

582 
»t
 = 
	`run_‹¡_bÙh_fÜm©s
(
‹¡s
[
i
], 
£ùÜsize
, 
nodesize
,

583 
b™m­_®ignm’t
);

584 ià(
»t
)

585 
‹¡_»t
 = 
»t
;

588  
‹¡_»t
;

589 
	}
}

	@tests/inode-tests.c

6 
	~<lšux/ty³s.h
>

7 
	~"bŒfs-‹¡s.h
"

8 
	~"../ù»e.h
"

9 
	~"../bŒfs_šode.h
"

10 
	~"../disk-io.h
"

11 
	~"../ex‹Á_io.h
"

12 
	~"../vŞumes.h
"

13 
	~"../com´essiÚ.h
"

14 
	~"../acûssÜs.h
"

16 
	$š£¹_ex‹Á
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
¡¬t
, u64 
Ën
,

17 
u64
 
¿m_by‹s
, u64 
off£t
, u64 
disk_by‹Ä
,

18 
u64
 
disk_Ën
, 
u32
 
ty³
, 
u8
 
com´essiÚ
, 
¦Ù
)

20 
bŒfs_·th
 
·th
;

21 
bŒfs_fe_ex‹Á_™em
 *
fi
;

22 
ex‹Á_bufãr
 *
Ëaf
 = 
roÙ
->
node
;

23 
bŒfs_key
 
key
;

24 
u32
 
v®ue_Ën
 = (
bŒfs_fe_ex‹Á_™em
);

26 ià(
ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
)

27 
v®ue_Ën
 +ğ
Ën
;

28 
	`mem£t
(&
·th
, 0, (path));

30 
·th
.
nodes
[0] = 
Ëaf
;

31 
·th
.
¦Ùs
[0] = 
¦Ù
;

33 
key
.
objeùid
 = 
BTRFS_FIRST_FREE_OBJECTID
;

34 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

35 
key
.
off£t
 = 
¡¬t
;

41 
	`bŒfs_£tup_™em_fÜ_š£¹
(
NULL
, 
roÙ
, &
·th
, &
key
, 
v®ue_Ën
);

42 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_fe_ex‹Á_™em
);

43 
	`bŒfs_£t_fe_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
, 1);

44 
	`bŒfs_£t_fe_ex‹Á_ty³
(
Ëaf
, 
fi
, 
ty³
);

45 
	`bŒfs_£t_fe_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
, 
disk_by‹Ä
);

46 
	`bŒfs_£t_fe_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
, 
disk_Ën
);

47 
	`bŒfs_£t_fe_ex‹Á_off£t
(
Ëaf
, 
fi
, 
off£t
);

48 
	`bŒfs_£t_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
, 
Ën
);

49 
	`bŒfs_£t_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
, 
¿m_by‹s
);

50 
	`bŒfs_£t_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
, 
com´essiÚ
);

51 
	`bŒfs_£t_fe_ex‹Á_’üy±iÚ
(
Ëaf
, 
fi
, 0);

52 
	`bŒfs_£t_fe_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
fi
, 0);

53 
	}
}

55 
	$š£¹_šode_™em_key
(
bŒfs_roÙ
 *
roÙ
)

57 
bŒfs_·th
 
·th
;

58 
ex‹Á_bufãr
 *
Ëaf
 = 
roÙ
->
node
;

59 
bŒfs_key
 
key
;

60 
u32
 
v®ue_Ën
 = 0;

62 
	`mem£t
(&
·th
, 0, (path));

64 
·th
.
nodes
[0] = 
Ëaf
;

65 
·th
.
¦Ùs
[0] = 0;

67 
key
.
objeùid
 = 
BTRFS_INODE_ITEM_KEY
;

68 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

69 
key
.
off£t
 = 0;

75 
	`bŒfs_£tup_™em_fÜ_š£¹
(
NULL
, 
roÙ
, &
·th
, &
key
, 
v®ue_Ën
);

76 
	}
}

96 
	$£tup_fe_ex‹Ás
(
bŒfs_roÙ
 *
roÙ
, 
u32
 
£ùÜsize
)

98 
¦Ù
 = 0;

99 
u64
 
disk_by‹Ä
 = 
SZ_1M
;

100 
u64
 
off£t
 = 0;

107 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 6, 6, 0, 0, 0, 
BTRFS_FILE_EXTENT_INLINE
, 0,

108 
¦Ù
);

109 
¦Ù
++;

110 
off£t
 = 
£ùÜsize
;

113 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 4, 4, 0, 0, 0, 
BTRFS_FILE_EXTENT_REG
, 0,

114 
¦Ù
);

115 
¦Ù
++;

116 
off£t
 += 4;

119 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
 - 1, sectorsize - 1, 0,

120 
disk_by‹Ä
, 
£ùÜsize
, 
BTRFS_FILE_EXTENT_REG
, 0, 
¦Ù
);

121 
¦Ù
++;

122 
disk_by‹Ä
 +ğ
£ùÜsize
;

123 
off£t
 +ğ
£ùÜsize
 - 1;

129 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, 4 * seùÜsize, 0, 
disk_by‹Ä
,

130 4 * 
£ùÜsize
, 
BTRFS_FILE_EXTENT_REG
, 0, 
¦Ù
);

131 
¦Ù
++;

132 
off£t
 +ğ
£ùÜsize
;

133 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, sectorsize, 0, 0, 0,

134 
BTRFS_FILE_EXTENT_REG
, 0, 
¦Ù
);

135 
¦Ù
++;

136 
off£t
 +ğ
£ùÜsize
;

137 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 2 * 
£ùÜsize
, 4 * sectorsize,

138 2 * 
£ùÜsize
, 
disk_by‹Ä
, 4 * sectorsize,

139 
BTRFS_FILE_EXTENT_REG
, 0, 
¦Ù
);

140 
¦Ù
++;

141 
off£t
 +ğ2 * 
£ùÜsize
;

142 
disk_by‹Ä
 +ğ4 * 
£ùÜsize
;

145 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, seùÜsize, 0, 
disk_by‹Ä
,

146 
£ùÜsize
, 
BTRFS_FILE_EXTENT_PREALLOC
, 0, 
¦Ù
);

147 
¦Ù
++;

148 
off£t
 +ğ
£ùÜsize
;

154 
disk_by‹Ä
 +ğ2 * 
£ùÜsize
;

161 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, 4 * seùÜsize, 0, 
disk_by‹Ä
,

162 4 * 
£ùÜsize
, 
BTRFS_FILE_EXTENT_PREALLOC
, 0, 
¦Ù
);

163 
¦Ù
++;

164 
off£t
 +ğ
£ùÜsize
;

165 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, 4 * sectorsize, sectorsize,

166 
disk_by‹Ä
, 4 * 
£ùÜsize
, 
BTRFS_FILE_EXTENT_REG
, 0,

167 
¦Ù
);

168 
¦Ù
++;

169 
off£t
 +ğ
£ùÜsize
;

170 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 2 * 
£ùÜsize
, 4 * sectorsize,

171 2 * 
£ùÜsize
, 
disk_by‹Ä
, 4 * sectorsize,

172 
BTRFS_FILE_EXTENT_PREALLOC
, 0, 
¦Ù
);

173 
¦Ù
++;

174 
off£t
 +ğ2 * 
£ùÜsize
;

175 
disk_by‹Ä
 +ğ4 * 
£ùÜsize
;

178 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 2 * 
£ùÜsize
, 2 * sectorsize, 0,

179 
disk_by‹Ä
, 
£ùÜsize
, 
BTRFS_FILE_EXTENT_REG
,

180 
BTRFS_COMPRESS_ZLIB
, 
¦Ù
);

181 
¦Ù
++;

182 
off£t
 +ğ2 * 
£ùÜsize
;

184 
disk_by‹Ä
 +ğ2 * 
£ùÜsize
;

187 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, 4 * seùÜsize, 0, 
disk_by‹Ä
,

188 
£ùÜsize
, 
BTRFS_FILE_EXTENT_REG
,

189 
BTRFS_COMPRESS_ZLIB
, 
¦Ù
);

190 
¦Ù
++;

191 
off£t
 +ğ
£ùÜsize
;

192 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, sectorsize, 0,

193 
disk_by‹Ä
 + 
£ùÜsize
, sectorsize,

194 
BTRFS_FILE_EXTENT_REG
, 0, 
¦Ù
);

195 
¦Ù
++;

196 
off£t
 +ğ
£ùÜsize
;

197 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 2 * 
£ùÜsize
, 4 * sectorsize,

198 2 * 
£ùÜsize
, 
disk_by‹Ä
, sectorsize,

199 
BTRFS_FILE_EXTENT_REG
, 
BTRFS_COMPRESS_ZLIB
, 
¦Ù
);

200 
¦Ù
++;

201 
off£t
 +ğ2 * 
£ùÜsize
;

202 
disk_by‹Ä
 +ğ2 * 
£ùÜsize
;

205 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, seùÜsize, 0, 
disk_by‹Ä
,

206 
£ùÜsize
, 
BTRFS_FILE_EXTENT_REG
, 0, 
¦Ù
);

207 
¦Ù
++;

208 
off£t
 +ğ4 * 
£ùÜsize
;

209 
disk_by‹Ä
 +ğ
£ùÜsize
;

210 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, seùÜsize, 0, 
disk_by‹Ä
,

211 
£ùÜsize
, 
BTRFS_FILE_EXTENT_REG
, 0, 
¦Ù
);

212 
	}
}

214 
	g´—Îoc_Úly
 = 0;

215 
	gcom´es£d_Úly
 = 0;

216 
	gvaÿncy_Úly
 = 0;

218 
nošlše
 
	$‹¡_bŒfs_g‘_ex‹Á
(
u32
 
£ùÜsize
, u32 
nodesize
)

220 
bŒfs_fs_šfo
 *
fs_šfo
 = 
NULL
;

221 
šode
 *šodğ
NULL
;

222 
bŒfs_roÙ
 *
roÙ
 = 
NULL
;

223 
ex‹Á_m­
 *
em
 = 
NULL
;

224 
u64
 
Üig_¡¬t
;

225 
u64
 
disk_by‹Ä
;

226 
u64
 
off£t
;

227 
»t
 = -
ENOMEM
;

229 
	`‹¡_msg
("running btrfs_get_extentests");

231 
šode
 = 
	`bŒfs_Ãw_‹¡_šode
();

232 ià(!
šode
) {

233 
	`‹¡_¡d_”r
(
TEST_ALLOC_INODE
);

234  
»t
;

237 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
nodesize
, 
£ùÜsize
);

238 ià(!
fs_šfo
) {

239 
	`‹¡_¡d_”r
(
TEST_ALLOC_FS_INFO
);

240 
out
;

243 
roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

244 ià(
	`IS_ERR
(
roÙ
)) {

245 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

246 
out
;

249 
roÙ
->
node
 = 
	`®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
nodesize
);

250 ià(!
roÙ
->
node
) {

251 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

252 
out
;

255 
	`bŒfs_£t_h—d”_Ä™ems
(
roÙ
->
node
, 0);

256 
	`bŒfs_£t_h—d”_Ëv–
(
roÙ
->
node
, 0);

257 
»t
 = -
EINVAL
;

260 
	`BTRFS_I
(
šode
)->
roÙ
 =„oot;

261 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 0, 
£ùÜsize
);

262 ià(
	`IS_ERR
(
em
)) {

263 
em
 = 
NULL
;

264 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

265 
out
;

267 ià(
em
->
block_¡¬t
 !ğ
EXTENT_MAP_HOLE
) {

268 
	`‹¡_”r
("ex³ùed‡ hŞe, gÙ %Îu", 
em
->
block_¡¬t
);

269 
out
;

271 
	`ä“_ex‹Á_m­
(
em
);

272 
	`bŒfs_drİ_ex‹Á_m­_¿nge
(
	`BTRFS_I
(
šode
), 0, (
u64
)-1, 
çl£
);

279 
	`£tup_fe_ex‹Ás
(
roÙ
, 
£ùÜsize
);

281 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 0, (
u64
)-1);

282 ià(
	`IS_ERR
(
em
)) {

283 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

284 
out
;

286 ià(
em
->
block_¡¬t
 !ğ
EXTENT_MAP_INLINE
) {

287 
	`‹¡_”r
("ex³ùed‡Àšlše, gÙ %Îu", 
em
->
block_¡¬t
);

288 
out
;

301 ià(
em
->
¡¬t
 !ğ0 ||ƒm->
Ën
 !ğ
£ùÜsize
) {

302 
	`‹¡_”r
(

304 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

305 
out
;

307 ià(
em
->
æags
 != 0) {

308 
	`‹¡_”r
("uÃx³ùed fÏg £t, wªˆ0 hav%lu", 
em
->
æags
);

309 
out
;

316 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

317 
	`ä“_ex‹Á_m­
(
em
);

319 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
);

320 ià(
	`IS_ERR
(
em
)) {

321 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

322 
out
;

324 ià(
em
->
block_¡¬t
 !ğ
EXTENT_MAP_HOLE
) {

325 
	`‹¡_”r
("ex³ùed‡ hŞe, gÙ %Îu", 
em
->
block_¡¬t
);

326 
out
;

328 ià(
em
->
¡¬t
 !ğ
off£t
 ||ƒm->
Ën
 != 4) {

329 
	`‹¡_”r
(

331 
off£t
, 
em
->
¡¬t
,ƒm->
Ën
);

332 
out
;

334 ià(
em
->
æags
 != 0) {

335 
	`‹¡_”r
("uÃx³ùed fÏg £t, wªˆ0 hav%lu", 
em
->
æags
);

336 
out
;

338 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

339 
	`ä“_ex‹Á_m­
(
em
);

342 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
);

343 ià(
	`IS_ERR
(
em
)) {

344 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

345 
out
;

347 ià(
em
->
block_¡¬t
 >ğ
EXTENT_MAP_LAST_BYTE
) {

348 
	`‹¡_”r
("ex³ùed‡„—Èex‹Á, gÙ %Îu", 
em
->
block_¡¬t
);

349 
out
;

351 ià(
em
->
¡¬t
 !ğ
off£t
 ||ƒm->
Ën
 !ğ
£ùÜsize
 - 1) {

352 
	`‹¡_”r
(

354 
off£t
, 
em
->
¡¬t
,ƒm->
Ën
);

355 
out
;

357 ià(
em
->
æags
 != 0) {

358 
	`‹¡_”r
("uÃx³ùed fÏg £t, wªˆ0 hav%lu", 
em
->
æags
);

359 
out
;

361 ià(
em
->
Üig_¡¬t
 !ğem->
¡¬t
) {

362 
	`‹¡_”r
("wrÚg orig off£t, wªˆ%Îu, hav%Îu", 
em
->
¡¬t
,

363 
em
->
Üig_¡¬t
);

364 
out
;

366 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

367 
	`ä“_ex‹Á_m­
(
em
);

370 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
);

371 ià(
	`IS_ERR
(
em
)) {

372 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

373 
out
;

375 ià(
em
->
block_¡¬t
 >ğ
EXTENT_MAP_LAST_BYTE
) {

376 
	`‹¡_”r
("ex³ùed‡„—Èex‹Á, gÙ %Îu", 
em
->
block_¡¬t
);

377 
out
;

379 ià(
em
->
¡¬t
 !ğ
off£t
 ||ƒm->
Ën
 !ğ
£ùÜsize
) {

380 
	`‹¡_”r
(

382 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

383 
out
;

385 ià(
em
->
æags
 != 0) {

386 
	`‹¡_”r
("uÃx³ùed fÏg £t, wªˆ0 hav%lu", 
em
->
æags
);

387 
out
;

389 ià(
em
->
Üig_¡¬t
 !ğem->
¡¬t
) {

390 
	`‹¡_”r
("wrÚg orig off£t, wªˆ%Îu, hav%Îu", 
em
->
¡¬t
,

391 
em
->
Üig_¡¬t
);

392 
out
;

394 
disk_by‹Ä
 = 
em
->
block_¡¬t
;

395 
Üig_¡¬t
 = 
em
->
¡¬t
;

396 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

397 
	`ä“_ex‹Á_m­
(
em
);

399 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
);

400 ià(
	`IS_ERR
(
em
)) {

401 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

402 
out
;

404 ià(
em
->
block_¡¬t
 !ğ
EXTENT_MAP_HOLE
) {

405 
	`‹¡_”r
("ex³ùed‡ hŞe, gÙ %Îu", 
em
->
block_¡¬t
);

406 
out
;

408 ià(
em
->
¡¬t
 !ğ
off£t
 ||ƒm->
Ën
 !ğ
£ùÜsize
) {

409 
	`‹¡_”r
(

411 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

412 
out
;

414 ià(
em
->
æags
 != 0) {

415 
	`‹¡_”r
("uÃx³ùed fÏg £t, wªˆ0 hav%lu", 
em
->
æags
);

416 
out
;

418 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

419 
	`ä“_ex‹Á_m­
(
em
);

421 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
);

422 ià(
	`IS_ERR
(
em
)) {

423 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

424 
out
;

426 ià(
em
->
block_¡¬t
 >ğ
EXTENT_MAP_LAST_BYTE
) {

427 
	`‹¡_”r
("ex³ùed‡„—Èex‹Á, gÙ %Îu", 
em
->
block_¡¬t
);

428 
out
;

430 ià(
em
->
¡¬t
 !ğ
off£t
 ||ƒm->
Ën
 !ğ2 * 
£ùÜsize
) {

431 
	`‹¡_”r
(

433 
off£t
, 2 * 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

434 
out
;

436 ià(
em
->
æags
 != 0) {

437 
	`‹¡_”r
("uÃx³ùed fÏg £t, wªˆ0 hav%lu", 
em
->
æags
);

438 
out
;

440 ià(
em
->
Üig_¡¬t
 != orig_start) {

441 
	`‹¡_”r
("wrong orig offset, want %llu, have %llu",

442 
Üig_¡¬t
, 
em
->orig_start);

443 
out
;

445 
disk_by‹Ä
 +ğ(
em
->
¡¬t
 - 
Üig_¡¬t
);

446 ià(
em
->
block_¡¬t
 !ğ
disk_by‹Ä
) {

447 
	`‹¡_”r
("wrong block start, want %llu, have %llu",

448 
disk_by‹Ä
, 
em
->
block_¡¬t
);

449 
out
;

451 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

452 
	`ä“_ex‹Á_m­
(
em
);

455 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
);

456 ià(
	`IS_ERR
(
em
)) {

457 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

458 
out
;

460 ià(
em
->
block_¡¬t
 >ğ
EXTENT_MAP_LAST_BYTE
) {

461 
	`‹¡_”r
("ex³ùed‡„—Èex‹Á, gÙ %Îu", 
em
->
block_¡¬t
);

462 
out
;

464 ià(
em
->
¡¬t
 !ğ
off£t
 ||ƒm->
Ën
 !ğ
£ùÜsize
) {

465 
	`‹¡_”r
(

467 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

468 
out
;

470 ià(
em
->
æags
 !ğ
´—Îoc_Úly
) {

471 
	`‹¡_”r
("unexpected flags set, want %lu have %lu",

472 
´—Îoc_Úly
, 
em
->
æags
);

473 
out
;

475 ià(
em
->
Üig_¡¬t
 !ğem->
¡¬t
) {

476 
	`‹¡_”r
("wrÚg orig off£t, wªˆ%Îu, hav%Îu", 
em
->
¡¬t
,

477 
em
->
Üig_¡¬t
);

478 
out
;

480 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

481 
	`ä“_ex‹Á_m­
(
em
);

484 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
);

485 ià(
	`IS_ERR
(
em
)) {

486 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

487 
out
;

489 ià(
em
->
block_¡¬t
 >ğ
EXTENT_MAP_LAST_BYTE
) {

490 
	`‹¡_”r
("ex³ùed‡„—Èex‹Á, gÙ %Îu", 
em
->
block_¡¬t
);

491 
out
;

493 ià(
em
->
¡¬t
 !ğ
off£t
 ||ƒm->
Ën
 !ğ
£ùÜsize
) {

494 
	`‹¡_”r
(

496 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

497 
out
;

499 ià(
em
->
æags
 !ğ
´—Îoc_Úly
) {

500 
	`‹¡_”r
("unexpected flags set, want %lu have %lu",

501 
´—Îoc_Úly
, 
em
->
æags
);

502 
out
;

504 ià(
em
->
Üig_¡¬t
 !ğem->
¡¬t
) {

505 
	`‹¡_”r
("wrÚg orig off£t, wªˆ%Îu, hav%Îu", 
em
->
¡¬t
,

506 
em
->
Üig_¡¬t
);

507 
out
;

509 
disk_by‹Ä
 = 
em
->
block_¡¬t
;

510 
Üig_¡¬t
 = 
em
->
¡¬t
;

511 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

512 
	`ä“_ex‹Á_m­
(
em
);

514 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
);

515 ià(
	`IS_ERR
(
em
)) {

516 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

517 
out
;

519 ià(
em
->
block_¡¬t
 >ğ
EXTENT_MAP_HOLE
) {

520 
	`‹¡_”r
("ex³ùed‡„—Èex‹Á, gÙ %Îu", 
em
->
block_¡¬t
);

521 
out
;

523 ià(
em
->
¡¬t
 !ğ
off£t
 ||ƒm->
Ën
 !ğ
£ùÜsize
) {

524 
	`‹¡_”r
(

526 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

527 
out
;

529 ià(
em
->
æags
 != 0) {

530 
	`‹¡_”r
("uÃx³ùed fÏg £t, wªˆ0 hav%lu", 
em
->
æags
);

531 
out
;

533 ià(
em
->
Üig_¡¬t
 != orig_start) {

534 
	`‹¡_”r
("unexpected orig offset, wanted %llu, have %llu",

535 
Üig_¡¬t
, 
em
->orig_start);

536 
out
;

538 ià(
em
->
block_¡¬t
 !ğ(
disk_by‹Ä
 + (em->
¡¬t
 -ƒm->
Üig_¡¬t
))) {

539 
	`‹¡_”r
("unexpected block start, wanted %llu, have %llu",

540 
disk_by‹Ä
 + (
em
->
¡¬t
 -ƒm->
Üig_¡¬t
),

541 
em
->
block_¡¬t
);

542 
out
;

544 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

545 
	`ä“_ex‹Á_m­
(
em
);

547 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
);

548 ià(
	`IS_ERR
(
em
)) {

549 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

550 
out
;

552 ià(
em
->
block_¡¬t
 >ğ
EXTENT_MAP_LAST_BYTE
) {

553 
	`‹¡_”r
("ex³ùed‡„—Èex‹Á, gÙ %Îu", 
em
->
block_¡¬t
);

554 
out
;

556 ià(
em
->
¡¬t
 !ğ
off£t
 ||ƒm->
Ën
 !ğ2 * 
£ùÜsize
) {

557 
	`‹¡_”r
(

559 
off£t
, 2 * 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

560 
out
;

562 ià(
em
->
æags
 !ğ
´—Îoc_Úly
) {

563 
	`‹¡_”r
("unexpected flags set, want %lu have %lu",

564 
´—Îoc_Úly
, 
em
->
æags
);

565 
out
;

567 ià(
em
->
Üig_¡¬t
 != orig_start) {

568 
	`‹¡_”r
("wrÚg orig off£t, wªˆ%Îu, hav%Îu", 
Üig_¡¬t
,

569 
em
->
Üig_¡¬t
);

570 
out
;

572 ià(
em
->
block_¡¬t
 !ğ(
disk_by‹Ä
 + (em->
¡¬t
 -ƒm->
Üig_¡¬t
))) {

573 
	`‹¡_”r
("unexpected block start, wanted %llu, have %llu",

574 
disk_by‹Ä
 + (
em
->
¡¬t
 -ƒm->
Üig_¡¬t
),

575 
em
->
block_¡¬t
);

576 
out
;

578 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

579 
	`ä“_ex‹Á_m­
(
em
);

582 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
);

583 ià(
	`IS_ERR
(
em
)) {

584 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

585 
out
;

587 ià(
em
->
block_¡¬t
 >ğ
EXTENT_MAP_LAST_BYTE
) {

588 
	`‹¡_”r
("ex³ùed‡„—Èex‹Á, gÙ %Îu", 
em
->
block_¡¬t
);

589 
out
;

591 ià(
em
->
¡¬t
 !ğ
off£t
 ||ƒm->
Ën
 !ğ2 * 
£ùÜsize
) {

592 
	`‹¡_”r
(

594 
off£t
, 2 * 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

595 
out
;

597 ià(
em
->
æags
 !ğ
com´es£d_Úly
) {

598 
	`‹¡_”r
("unexpected flags set, want %lu have %lu",

599 
com´es£d_Úly
, 
em
->
æags
);

600 
out
;

602 ià(
em
->
Üig_¡¬t
 !ğem->
¡¬t
) {

603 
	`‹¡_”r
("wrong orig offset, want %llu, have %llu",

604 
em
->
¡¬t
,ƒm->
Üig_¡¬t
);

605 
out
;

607 ià(
em
->
com´ess_ty³
 !ğ
BTRFS_COMPRESS_ZLIB
) {

608 
	`‹¡_”r
("unexpected compressype, wanted %d, got %d",

609 
BTRFS_COMPRESS_ZLIB
, 
em
->
com´ess_ty³
);

610 
out
;

612 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

613 
	`ä“_ex‹Á_m­
(
em
);

616 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
);

617 ià(
	`IS_ERR
(
em
)) {

618 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

619 
out
;

621 ià(
em
->
block_¡¬t
 >ğ
EXTENT_MAP_LAST_BYTE
) {

622 
	`‹¡_”r
("ex³ùed‡„—Èex‹Á, gÙ %Îu", 
em
->
block_¡¬t
);

623 
out
;

625 ià(
em
->
¡¬t
 !ğ
off£t
 ||ƒm->
Ën
 !ğ
£ùÜsize
) {

626 
	`‹¡_”r
(

628 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

629 
out
;

631 ià(
em
->
æags
 !ğ
com´es£d_Úly
) {

632 
	`‹¡_”r
("unexpected flags set, want %lu have %lu",

633 
com´es£d_Úly
, 
em
->
æags
);

634 
out
;

636 ià(
em
->
Üig_¡¬t
 !ğem->
¡¬t
) {

637 
	`‹¡_”r
("wrong orig offset, want %llu, have %llu",

638 
em
->
¡¬t
,ƒm->
Üig_¡¬t
);

639 
out
;

641 ià(
em
->
com´ess_ty³
 !ğ
BTRFS_COMPRESS_ZLIB
) {

642 
	`‹¡_”r
("unexpected compressype, wanted %d, got %d",

643 
BTRFS_COMPRESS_ZLIB
, 
em
->
com´ess_ty³
);

644 
out
;

646 
disk_by‹Ä
 = 
em
->
block_¡¬t
;

647 
Üig_¡¬t
 = 
em
->
¡¬t
;

648 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

649 
	`ä“_ex‹Á_m­
(
em
);

651 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
);

652 ià(
	`IS_ERR
(
em
)) {

653 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

654 
out
;

656 ià(
em
->
block_¡¬t
 >ğ
EXTENT_MAP_LAST_BYTE
) {

657 
	`‹¡_”r
("ex³ùed‡„—Èex‹Á, gÙ %Îu", 
em
->
block_¡¬t
);

658 
out
;

660 ià(
em
->
¡¬t
 !ğ
off£t
 ||ƒm->
Ën
 !ğ
£ùÜsize
) {

661 
	`‹¡_”r
(

663 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

664 
out
;

666 ià(
em
->
æags
 != 0) {

667 
	`‹¡_”r
("uÃx³ùed fÏg £t, wªˆ0 hav%lu", 
em
->
æags
);

668 
out
;

670 ià(
em
->
Üig_¡¬t
 !ğem->
¡¬t
) {

671 
	`‹¡_”r
("wrÚg orig off£t, wªˆ%Îu, hav%Îu", 
em
->
¡¬t
,

672 
em
->
Üig_¡¬t
);

673 
out
;

675 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

676 
	`ä“_ex‹Á_m­
(
em
);

678 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
);

679 ià(
	`IS_ERR
(
em
)) {

680 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

681 
out
;

683 ià(
em
->
block_¡¬t
 !ğ
disk_by‹Ä
) {

684 
	`‹¡_”r
("block start does‚ot match, want %llu got %llu",

685 
disk_by‹Ä
, 
em
->
block_¡¬t
);

686 
out
;

688 ià(
em
->
¡¬t
 !ğ
off£t
 ||ƒm->
Ën
 !ğ2 * 
£ùÜsize
) {

689 
	`‹¡_”r
(

691 
off£t
, 2 * 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

692 
out
;

694 ià(
em
->
æags
 !ğ
com´es£d_Úly
) {

695 
	`‹¡_”r
("unexpected flags set, want %lu have %lu",

696 
com´es£d_Úly
, 
em
->
æags
);

697 
out
;

699 ià(
em
->
Üig_¡¬t
 != orig_start) {

700 
	`‹¡_”r
("wrong orig offset, want %llu, have %llu",

701 
em
->
¡¬t
, 
Üig_¡¬t
);

702 
out
;

704 ià(
em
->
com´ess_ty³
 !ğ
BTRFS_COMPRESS_ZLIB
) {

705 
	`‹¡_”r
("unexpected compressype, wanted %d, got %d",

706 
BTRFS_COMPRESS_ZLIB
, 
em
->
com´ess_ty³
);

707 
out
;

709 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

710 
	`ä“_ex‹Á_m­
(
em
);

713 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
 + 6, 
£ùÜsize
);

714 ià(
	`IS_ERR
(
em
)) {

715 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

716 
out
;

718 ià(
em
->
block_¡¬t
 >ğ
EXTENT_MAP_LAST_BYTE
) {

719 
	`‹¡_”r
("ex³ùed‡„—Èex‹Á, gÙ %Îu", 
em
->
block_¡¬t
);

720 
out
;

722 ià(
em
->
¡¬t
 !ğ
off£t
 ||ƒm->
Ën
 !ğ
£ùÜsize
) {

723 
	`‹¡_”r
(

725 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

726 
out
;

728 ià(
em
->
æags
 != 0) {

729 
	`‹¡_”r
("uÃx³ùed fÏg £t, wªˆ0 hav%lu", 
em
->
æags
);

730 
out
;

732 ià(
em
->
Üig_¡¬t
 !ğem->
¡¬t
) {

733 
	`‹¡_”r
("wrÚg orig off£t, wªˆ%Îu, hav%Îu", 
em
->
¡¬t
,

734 
em
->
Üig_¡¬t
);

735 
out
;

737 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

738 
	`ä“_ex‹Á_m­
(
em
);

740 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
SZ_4M
);

741 ià(
	`IS_ERR
(
em
)) {

742 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

743 
out
;

745 ià(
em
->
block_¡¬t
 !ğ
EXTENT_MAP_HOLE
) {

746 
	`‹¡_”r
("ex³ùed‡ hŞex‹Á, gÙ %Îu", 
em
->
block_¡¬t
);

747 
out
;

754 ià(
em
->
¡¬t
 !ğ
off£t
 ||ƒm->
Ën
 !ğ3 * 
£ùÜsize
) {

755 
	`‹¡_”r
(

757 
off£t
, 3 * 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

758 
out
;

760 ià(
em
->
æags
 !ğ
vaÿncy_Úly
) {

761 
	`‹¡_”r
("unexpected flags set, want %lu have %lu",

762 
vaÿncy_Úly
, 
em
->
æags
);

763 
out
;

765 ià(
em
->
Üig_¡¬t
 !ğem->
¡¬t
) {

766 
	`‹¡_”r
("wrÚg orig off£t, wªˆ%Îu, hav%Îu", 
em
->
¡¬t
,

767 
em
->
Üig_¡¬t
);

768 
out
;

770 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

771 
	`ä“_ex‹Á_m­
(
em
);

773 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
);

774 ià(
	`IS_ERR
(
em
)) {

775 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

776 
out
;

778 ià(
em
->
block_¡¬t
 >ğ
EXTENT_MAP_LAST_BYTE
) {

779 
	`‹¡_”r
("ex³ùed‡„—Èex‹Á, gÙ %Îu", 
em
->
block_¡¬t
);

780 
out
;

782 ià(
em
->
¡¬t
 !ğ
off£t
 ||ƒm->
Ën
 !ğ
£ùÜsize
) {

783 
	`‹¡_”r
(

785 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

786 
out
;

788 ià(
em
->
æags
 != 0) {

789 
	`‹¡_”r
("uÃx³ùed fÏg £t, wªˆ0 hav%lu", 
em
->
æags
);

790 
out
;

792 ià(
em
->
Üig_¡¬t
 !ğem->
¡¬t
) {

793 
	`‹¡_”r
("wrÚg orig off£t, wªˆ%Îu, hav%Îu", 
em
->
¡¬t
,

794 
em
->
Üig_¡¬t
);

795 
out
;

797 
»t
 = 0;

798 
out
:

799 ià(!
	`IS_ERR
(
em
))

800 
	`ä“_ex‹Á_m­
(
em
);

801 
	`ut
(
šode
);

802 
	`bŒfs_ä“_dummy_roÙ
(
roÙ
);

803 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

804  
»t
;

805 
	}
}

807 
	$‹¡_hŞe_fœ¡
(
u32
 
£ùÜsize
, u32 
nodesize
)

809 
bŒfs_fs_šfo
 *
fs_šfo
 = 
NULL
;

810 
šode
 *šodğ
NULL
;

811 
bŒfs_roÙ
 *
roÙ
 = 
NULL
;

812 
ex‹Á_m­
 *
em
 = 
NULL
;

813 
»t
 = -
ENOMEM
;

815 
	`‹¡_msg
("running hole first btrfs_get_extentest");

817 
šode
 = 
	`bŒfs_Ãw_‹¡_šode
();

818 ià(!
šode
) {

819 
	`‹¡_¡d_”r
(
TEST_ALLOC_INODE
);

820  
»t
;

823 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
nodesize
, 
£ùÜsize
);

824 ià(!
fs_šfo
) {

825 
	`‹¡_¡d_”r
(
TEST_ALLOC_FS_INFO
);

826 
out
;

829 
roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

830 ià(
	`IS_ERR
(
roÙ
)) {

831 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

832 
out
;

835 
roÙ
->
node
 = 
	`®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
nodesize
);

836 ià(!
roÙ
->
node
) {

837 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

838 
out
;

841 
	`bŒfs_£t_h—d”_Ä™ems
(
roÙ
->
node
, 0);

842 
	`bŒfs_£t_h—d”_Ëv–
(
roÙ
->
node
, 0);

843 
	`BTRFS_I
(
šode
)->
roÙ
 =„oot;

844 
»t
 = -
EINVAL
;

850 
	`š£¹_šode_™em_key
(
roÙ
);

851 
	`š£¹_ex‹Á
(
roÙ
, 
£ùÜsize
, sectorsize, sectorsize, 0, sectorsize,

852 
£ùÜsize
, 
BTRFS_FILE_EXTENT_REG
, 0, 1);

853 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 0, 2 * 
£ùÜsize
);

854 ià(
	`IS_ERR
(
em
)) {

855 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

856 
out
;

858 ià(
em
->
block_¡¬t
 !ğ
EXTENT_MAP_HOLE
) {

859 
	`‹¡_”r
("ex³ùed‡ hŞe, gÙ %Îu", 
em
->
block_¡¬t
);

860 
out
;

862 ià(
em
->
¡¬t
 !ğ0 ||ƒm->
Ën
 !ğ
£ùÜsize
) {

863 
	`‹¡_”r
(

865 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

866 
out
;

868 ià(
em
->
æags
 !ğ
vaÿncy_Úly
) {

869 
	`‹¡_”r
("wrÚg fÏgs, wª‹d %lu, hav%lu", 
vaÿncy_Úly
,

870 
em
->
æags
);

871 
out
;

873 
	`ä“_ex‹Á_m­
(
em
);

875 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
£ùÜsize
, 2 * sectorsize);

876 ià(
	`IS_ERR
(
em
)) {

877 
	`‹¡_”r
("got‡nƒrror when we shouldn't have");

878 
out
;

880 ià(
em
->
block_¡¬t
 !ğ
£ùÜsize
) {

881 
	`‹¡_”r
("ex³ùed‡„—Èex‹Á, gÙ %Îu", 
em
->
block_¡¬t
);

882 
out
;

884 ià(
em
->
¡¬t
 !ğ
£ùÜsize
 ||ƒm->
Ën
 != sectorsize) {

885 
	`‹¡_”r
(

887 
£ùÜsize
, seùÜsize, 
em
->
¡¬t
,ƒm->
Ën
);

888 
out
;

890 ià(
em
->
æags
 != 0) {

891 
	`‹¡_”r
("unexpected flags set, wanted 0 got %lu",

892 
em
->
æags
);

893 
out
;

895 
»t
 = 0;

896 
out
:

897 ià(!
	`IS_ERR
(
em
))

898 
	`ä“_ex‹Á_m­
(
em
);

899 
	`ut
(
šode
);

900 
	`bŒfs_ä“_dummy_roÙ
(
roÙ
);

901 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

902  
»t
;

903 
	}
}

905 
	$‹¡_ex‹Á_accouÁšg
(
u32
 
£ùÜsize
, u32 
nodesize
)

907 
bŒfs_fs_šfo
 *
fs_šfo
 = 
NULL
;

908 
šode
 *šodğ
NULL
;

909 
bŒfs_roÙ
 *
roÙ
 = 
NULL
;

910 
»t
 = -
ENOMEM
;

912 
	`‹¡_msg
("running outstanding_extentsests");

914 
šode
 = 
	`bŒfs_Ãw_‹¡_šode
();

915 ià(!
šode
) {

916 
	`‹¡_¡d_”r
(
TEST_ALLOC_INODE
);

917  
»t
;

920 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
nodesize
, 
£ùÜsize
);

921 ià(!
fs_šfo
) {

922 
	`‹¡_¡d_”r
(
TEST_ALLOC_FS_INFO
);

923 
out
;

926 
roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

927 ià(
	`IS_ERR
(
roÙ
)) {

928 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

929 
out
;

932 
	`BTRFS_I
(
šode
)->
roÙ
 =„oot;

935 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
	`BTRFS_I
(
šode
), 0,

936 
BTRFS_MAX_EXTENT_SIZE
 - 1, 0, 
NULL
);

937 ià(
»t
) {

938 
	`‹¡_”r
("bŒfs_£t_ex‹Á_d–®loø»tuºed %d", 
»t
);

939 
out
;

941 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 != 1) {

942 
»t
 = -
EINVAL
;

943 
	`‹¡_”r
("miscount, wanted 1, got %u",

944 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

945 
out
;

949 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
	`BTRFS_I
(
šode
), 
BTRFS_MAX_EXTENT_SIZE
,

950 
BTRFS_MAX_EXTENT_SIZE
 + 
£ùÜsize
 - 1,

951 0, 
NULL
);

952 ià(
»t
) {

953 
	`‹¡_”r
("bŒfs_£t_ex‹Á_d–®loø»tuºed %d", 
»t
);

954 
out
;

956 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 != 2) {

957 
»t
 = -
EINVAL
;

958 
	`‹¡_”r
("miscount, wanted 2, got %u",

959 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

960 
out
;

964 
»t
 = 
	`ş—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

965 
BTRFS_MAX_EXTENT_SIZE
 >> 1,

966 (
BTRFS_MAX_EXTENT_SIZE
 >> 1è+ 
£ùÜsize
 - 1,

967 
EXTENT_DELALLOC
 | 
EXTENT_DELALLOC_NEW
 |

968 
EXTENT_UPTODATE
, 
NULL
);

969 ià(
»t
) {

970 
	`‹¡_”r
("ş—r_ex‹Á_b™„‘uºed %d", 
»t
);

971 
out
;

973 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 != 2) {

974 
»t
 = -
EINVAL
;

975 
	`‹¡_”r
("miscount, wanted 2, got %u",

976 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

977 
out
;

981 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
	`BTRFS_I
(
šode
), 
BTRFS_MAX_EXTENT_SIZE
 >> 1,

982 (
BTRFS_MAX_EXTENT_SIZE
 >> 1)

983 + 
£ùÜsize
 - 1,

984 0, 
NULL
);

985 ià(
»t
) {

986 
	`‹¡_”r
("bŒfs_£t_ex‹Á_d–®loø»tuºed %d", 
»t
);

987 
out
;

989 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 != 2) {

990 
»t
 = -
EINVAL
;

991 
	`‹¡_”r
("miscount, wanted 2, got %u",

992 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

993 
out
;

999 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
	`BTRFS_I
(
šode
),

1000 
BTRFS_MAX_EXTENT_SIZE
 + 2 * 
£ùÜsize
,

1001 (
BTRFS_MAX_EXTENT_SIZE
 << 1è+ 3 * 
£ùÜsize
 - 1,

1002 0, 
NULL
);

1003 ià(
»t
) {

1004 
	`‹¡_”r
("bŒfs_£t_ex‹Á_d–®loø»tuºed %d", 
»t
);

1005 
out
;

1007 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 != 4) {

1008 
»t
 = -
EINVAL
;

1009 
	`‹¡_”r
("miscount, wanted 4, got %u",

1010 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

1011 
out
;

1017 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
	`BTRFS_I
(
šode
),

1018 
BTRFS_MAX_EXTENT_SIZE
 + 
£ùÜsize
,

1019 
BTRFS_MAX_EXTENT_SIZE
 + 2 * 
£ùÜsize
 - 1, 0, 
NULL
);

1020 ià(
»t
) {

1021 
	`‹¡_”r
("bŒfs_£t_ex‹Á_d–®loø»tuºed %d", 
»t
);

1022 
out
;

1024 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 != 3) {

1025 
»t
 = -
EINVAL
;

1026 
	`‹¡_”r
("miscount, wanted 3, got %u",

1027 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

1028 
out
;

1032 
»t
 = 
	`ş—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

1033 
BTRFS_MAX_EXTENT_SIZE
 + 
£ùÜsize
,

1034 
BTRFS_MAX_EXTENT_SIZE
 + 2 * 
£ùÜsize
 - 1,

1035 
EXTENT_DELALLOC
 | 
EXTENT_DELALLOC_NEW
 |

1036 
EXTENT_UPTODATE
, 
NULL
);

1037 ià(
»t
) {

1038 
	`‹¡_”r
("ş—r_ex‹Á_b™„‘uºed %d", 
»t
);

1039 
out
;

1041 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 != 4) {

1042 
»t
 = -
EINVAL
;

1043 
	`‹¡_”r
("miscount, wanted 4, got %u",

1044 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

1045 
out
;

1052 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
	`BTRFS_I
(
šode
),

1053 
BTRFS_MAX_EXTENT_SIZE
 + 
£ùÜsize
,

1054 
BTRFS_MAX_EXTENT_SIZE
 + 2 * 
£ùÜsize
 - 1, 0, 
NULL
);

1055 ià(
»t
) {

1056 
	`‹¡_”r
("bŒfs_£t_ex‹Á_d–®loø»tuºed %d", 
»t
);

1057 
out
;

1059 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 != 3) {

1060 
»t
 = -
EINVAL
;

1061 
	`‹¡_”r
("miscount, wanted 3, got %u",

1062 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

1063 
out
;

1067 
»t
 = 
	`ş—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0, (
u64
)-1,

1068 
EXTENT_DELALLOC
 | 
EXTENT_DELALLOC_NEW
 |

1069 
EXTENT_UPTODATE
, 
NULL
);

1070 ià(
»t
) {

1071 
	`‹¡_”r
("ş—r_ex‹Á_b™„‘uºed %d", 
»t
);

1072 
out
;

1074 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
) {

1075 
»t
 = -
EINVAL
;

1076 
	`‹¡_”r
("miscount, wanted 0, got %u",

1077 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

1078 
out
;

1080 
»t
 = 0;

1081 
out
:

1082 ià(
»t
)

1083 
	`ş—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0, (
u64
)-1,

1084 
EXTENT_DELALLOC
 | 
EXTENT_DELALLOC_NEW
 |

1085 
EXTENT_UPTODATE
, 
NULL
);

1086 
	`ut
(
šode
);

1087 
	`bŒfs_ä“_dummy_roÙ
(
roÙ
);

1088 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

1089  
»t
;

1090 
	}
}

1092 
	$bŒfs_‹¡_šodes
(
u32
 
£ùÜsize
, u32 
nodesize
)

1094 
»t
;

1096 
	`‹¡_msg
("running inodeests");

1098 
	`£t_b™
(
EXTENT_FLAG_COMPRESSED
, &
com´es£d_Úly
);

1099 
	`£t_b™
(
EXTENT_FLAG_PREALLOC
, &
´—Îoc_Úly
);

1101 
»t
 = 
	`‹¡_bŒfs_g‘_ex‹Á
(
£ùÜsize
, 
nodesize
);

1102 ià(
»t
)

1103  
»t
;

1104 
»t
 = 
	`‹¡_hŞe_fœ¡
(
£ùÜsize
, 
nodesize
);

1105 ià(
»t
)

1106  
»t
;

1107  
	`‹¡_ex‹Á_accouÁšg
(
£ùÜsize
, 
nodesize
);

1108 
	}
}

	@tests/qgroup-tests.c

6 
	~<lšux/ty³s.h
>

7 
	~"bŒfs-‹¡s.h
"

8 
	~"../ù»e.h
"

9 
	~"../Œª§ùiÚ.h
"

10 
	~"../disk-io.h
"

11 
	~"../qgroup.h
"

12 
	~"../back»f.h
"

13 
	~"../fs.h
"

14 
	~"../acûssÜs.h
"

16 
	$š£¹_nÜm®_Œ“_»f
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
by‹Ä
,

17 
u64
 
num_by‹s
, u64 
·»Á
, u64 
roÙ_objeùid
)

19 
bŒfs_Œªs_hªdË
 
Œªs
;

20 
bŒfs_ex‹Á_™em
 *
™em
;

21 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

22 
bŒfs_Œ“_block_šfo
 *
block_šfo
;

23 
bŒfs_·th
 *
·th
;

24 
ex‹Á_bufãr
 *
Ëaf
;

25 
bŒfs_key
 
šs
;

26 
u32
 
size
 = (*
™em
è+ (*
œef
è+ (*
block_šfo
);

27 
»t
;

29 
	`bŒfs_š™_dummy_Œªs
(&
Œªs
, 
NULL
);

31 
šs
.
objeùid
 = 
by‹Ä
;

32 
šs
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

33 
šs
.
off£t
 = 
num_by‹s
;

35 
·th
 = 
	`bŒfs_®loc_·th
();

36 ià(!
·th
) {

37 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

38  -
ENOMEM
;

41 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(&
Œªs
, 
roÙ
, 
·th
, &
šs
, 
size
);

42 ià(
»t
) {

43 
	`‹¡_”r
("couldn'ˆš£¹„eà%d", 
»t
);

44 
	`bŒfs_ä“_·th
(
·th
);

45  
»t
;

48 
Ëaf
 = 
·th
->
nodes
[0];

49 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

50 
	`bŒfs_£t_ex‹Á_»fs
(
Ëaf
, 
™em
, 1);

51 
	`bŒfs_£t_ex‹Á_g’”©iÚ
(
Ëaf
, 
™em
, 1);

52 
	`bŒfs_£t_ex‹Á_æags
(
Ëaf
, 
™em
, 
BTRFS_EXTENT_FLAG_TREE_BLOCK
);

53 
block_šfo
 = (
bŒfs_Œ“_block_šfo
 *)(
™em
 + 1);

54 
	`bŒfs_£t_Œ“_block_Ëv–
(
Ëaf
, 
block_šfo
, 0);

55 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
block_šfo
 + 1);

56 ià(
·»Á
 > 0) {

57 
	`bŒfs_£t_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
,

58 
BTRFS_SHARED_BLOCK_REF_KEY
);

59 
	`bŒfs_£t_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
, 
·»Á
);

61 
	`bŒfs_£t_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
, 
BTRFS_TREE_BLOCK_REF_KEY
);

62 
	`bŒfs_£t_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
, 
roÙ_objeùid
);

64 
	`bŒfs_ä“_·th
(
·th
);

66 
	}
}

68 
	$add_Œ“_»f
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
by‹Ä
, u64 
num_by‹s
,

69 
u64
 
·»Á
, u64 
roÙ_objeùid
)

71 
bŒfs_Œªs_hªdË
 
Œªs
;

72 
bŒfs_ex‹Á_™em
 *
™em
;

73 
bŒfs_·th
 *
·th
;

74 
bŒfs_key
 
key
;

75 
u64
 
»fs
;

76 
»t
;

78 
	`bŒfs_š™_dummy_Œªs
(&
Œªs
, 
NULL
);

80 
key
.
objeùid
 = 
by‹Ä
;

81 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

82 
key
.
off£t
 = 
num_by‹s
;

84 
·th
 = 
	`bŒfs_®loc_·th
();

85 ià(!
·th
) {

86 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

87  -
ENOMEM
;

90 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(&
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

91 ià(
»t
) {

92 
	`‹¡_”r
("couldn't findƒxtent„ef");

93 
	`bŒfs_ä“_·th
(
·th
);

94  
»t
;

97 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

98 
bŒfs_ex‹Á_™em
);

99 
»fs
 = 
	`bŒfs_ex‹Á_»fs
(
·th
->
nodes
[0], 
™em
);

100 
	`bŒfs_£t_ex‹Á_»fs
(
·th
->
nodes
[0], 
™em
, 
»fs
 + 1);

101 
	`bŒfs_»Ëa£_·th
(
·th
);

103 
key
.
objeùid
 = 
by‹Ä
;

104 ià(
·»Á
) {

105 
key
.
ty³
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

106 
key
.
off£t
 = 
·»Á
;

108 
key
.
ty³
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

109 
key
.
off£t
 = 
roÙ_objeùid
;

112 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(&
Œªs
, 
roÙ
, 
·th
, &
key
, 0);

113 ià(
»t
)

114 
	`‹¡_”r
("failedo insert backref");

115 
	`bŒfs_ä“_·th
(
·th
);

116  
»t
;

117 
	}
}

119 
	$»move_ex‹Á_™em
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
by‹Ä
,

120 
u64
 
num_by‹s
)

122 
bŒfs_Œªs_hªdË
 
Œªs
;

123 
bŒfs_key
 
key
;

124 
bŒfs_·th
 *
·th
;

125 
»t
;

127 
	`bŒfs_š™_dummy_Œªs
(&
Œªs
, 
NULL
);

129 
key
.
objeùid
 = 
by‹Ä
;

130 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

131 
key
.
off£t
 = 
num_by‹s
;

133 
·th
 = 
	`bŒfs_®loc_·th
();

134 ià(!
·th
) {

135 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

136  -
ENOMEM
;

139 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(&
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

140 ià(
»t
) {

141 
	`‹¡_”r
("didn'ˆfšd ou¸key %d", 
»t
);

142 
	`bŒfs_ä“_·th
(
·th
);

143  
»t
;

145 
	`bŒfs_d–_™em
(&
Œªs
, 
roÙ
, 
·th
);

146 
	`bŒfs_ä“_·th
(
·th
);

148 
	}
}

150 
	$»move_ex‹Á_»f
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
by‹Ä
,

151 
u64
 
num_by‹s
, u64 
·»Á
, u64 
roÙ_objeùid
)

153 
bŒfs_Œªs_hªdË
 
Œªs
;

154 
bŒfs_ex‹Á_™em
 *
™em
;

155 
bŒfs_·th
 *
·th
;

156 
bŒfs_key
 
key
;

157 
u64
 
»fs
;

158 
»t
;

160 
	`bŒfs_š™_dummy_Œªs
(&
Œªs
, 
NULL
);

162 
key
.
objeùid
 = 
by‹Ä
;

163 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

164 
key
.
off£t
 = 
num_by‹s
;

166 
·th
 = 
	`bŒfs_®loc_·th
();

167 ià(!
·th
) {

168 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

169  -
ENOMEM
;

172 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(&
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

173 ià(
»t
) {

174 
	`‹¡_”r
("couldn't findƒxtent„ef");

175 
	`bŒfs_ä“_·th
(
·th
);

176  
»t
;

179 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

180 
bŒfs_ex‹Á_™em
);

181 
»fs
 = 
	`bŒfs_ex‹Á_»fs
(
·th
->
nodes
[0], 
™em
);

182 
	`bŒfs_£t_ex‹Á_»fs
(
·th
->
nodes
[0], 
™em
, 
»fs
 - 1);

183 
	`bŒfs_»Ëa£_·th
(
·th
);

185 
key
.
objeùid
 = 
by‹Ä
;

186 ià(
·»Á
) {

187 
key
.
ty³
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

188 
key
.
off£t
 = 
·»Á
;

190 
key
.
ty³
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

191 
key
.
off£t
 = 
roÙ_objeùid
;

194 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(&
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

195 ià(
»t
) {

196 
	`‹¡_”r
("couldn'ˆfšd back»à%d", 
»t
);

197 
	`bŒfs_ä“_·th
(
·th
);

198  
»t
;

200 
	`bŒfs_d–_™em
(&
Œªs
, 
roÙ
, 
·th
);

201 
	`bŒfs_ä“_·th
(
·th
);

202  
»t
;

203 
	}
}

205 
	$‹¡_no_sh¬ed_qgroup
(
bŒfs_roÙ
 *
roÙ
,

206 
u32
 
£ùÜsize
, u32 
nodesize
)

208 
bŒfs_back»f_w®k_ùx
 
ùx
 = { 0 };

209 
bŒfs_Œªs_hªdË
 
Œªs
;

210 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

211 
uli¡
 *
Şd_roÙs
 = 
NULL
;

212 
uli¡
 *
Ãw_roÙs
 = 
NULL
;

213 
»t
;

215 
	`bŒfs_š™_dummy_Œªs
(&
Œªs
, 
fs_šfo
);

217 
	`‹¡_msg
("running qgroup‡dd/removeests");

218 
»t
 = 
	`bŒfs_ü—‹_qgroup
(&
Œªs
, 
BTRFS_FS_TREE_OBJECTID
);

219 ià(
»t
) {

220 
	`‹¡_”r
("couldn'ˆü—‹‡ qgrou°%d", 
»t
);

221  
»t
;

224 
ùx
.
by‹Ä
 = 
nodesize
;

225 
ùx
.
Œªs
 = &trans;

226 
ùx
.
fs_šfo
 = fs_info;

233 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
ùx
, 
çl£
);

234 ià(
»t
) {

235 
	`‹¡_”r
("couldn'ˆfšd old„oÙs: %d", 
»t
);

236  
»t
;

238 
Şd_roÙs
 = 
ùx
.
roÙs
;

239 
ùx
.
roÙs
 = 
NULL
;

241 
»t
 = 
	`š£¹_nÜm®_Œ“_»f
(
roÙ
, 
nodesize
,‚odesize, 0,

242 
BTRFS_FS_TREE_OBJECTID
);

243 ià(
»t
) {

244 
	`uli¡_ä“
(
Şd_roÙs
);

245  
»t
;

248 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
ùx
, 
çl£
);

249 ià(
»t
) {

250 
	`uli¡_ä“
(
Şd_roÙs
);

251 
	`‹¡_”r
("couldn'ˆfšd old„oÙs: %d", 
»t
);

252  
»t
;

254 
Ãw_roÙs
 = 
ùx
.
roÙs
;

255 
ùx
.
roÙs
 = 
NULL
;

257 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Á
(&
Œªs
, 
nodesize
,‚odesize, 
Şd_roÙs
,

258 
Ãw_roÙs
);

259 ià(
»t
) {

260 
	`‹¡_”r
("couldn'ˆaccouÁ s·û fÜ‡ qgrou°%d", 
»t
);

261  
»t
;

265 
Şd_roÙs
 = 
NULL
;

266 
Ãw_roÙs
 = 
NULL
;

268 ià(
	`bŒfs_v”ify_qgroup_couÁs
(
fs_šfo
, 
BTRFS_FS_TREE_OBJECTID
,

269 
nodesize
,‚odesize)) {

270 
	`‹¡_”r
("qgroup counts didn't matchƒxpected values");

271  -
EINVAL
;

274 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
ùx
, 
çl£
);

275 ià(
»t
) {

276 
	`‹¡_”r
("couldn'ˆfšd old„oÙs: %d", 
»t
);

277  
»t
;

279 
Şd_roÙs
 = 
ùx
.
roÙs
;

280 
ùx
.
roÙs
 = 
NULL
;

282 
»t
 = 
	`»move_ex‹Á_™em
(
roÙ
, 
nodesize
,‚odesize);

283 ià(
»t
) {

284 
	`uli¡_ä“
(
Şd_roÙs
);

285  -
EINVAL
;

288 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
ùx
, 
çl£
);

289 ià(
»t
) {

290 
	`uli¡_ä“
(
Şd_roÙs
);

291 
	`‹¡_”r
("couldn'ˆfšd old„oÙs: %d", 
»t
);

292  
»t
;

294 
Ãw_roÙs
 = 
ùx
.
roÙs
;

295 
ùx
.
roÙs
 = 
NULL
;

297 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Á
(&
Œªs
, 
nodesize
,‚odesize, 
Şd_roÙs
,

298 
Ãw_roÙs
);

299 ià(
»t
) {

300 
	`‹¡_”r
("couldn'ˆaccouÁ s·û fÜ‡ qgrou°%d", 
»t
);

301  -
EINVAL
;

304 ià(
	`bŒfs_v”ify_qgroup_couÁs
(
fs_šfo
, 
BTRFS_FS_TREE_OBJECTID
, 0, 0)) {

305 
	`‹¡_”r
("qgroup counts didn't matchƒxpected values");

306  -
EINVAL
;

310 
	}
}

317 
	$‹¡_muÉË_»fs
(
bŒfs_roÙ
 *
roÙ
,

318 
u32
 
£ùÜsize
, u32 
nodesize
)

320 
bŒfs_back»f_w®k_ùx
 
ùx
 = { 0 };

321 
bŒfs_Œªs_hªdË
 
Œªs
;

322 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

323 
uli¡
 *
Şd_roÙs
 = 
NULL
;

324 
uli¡
 *
Ãw_roÙs
 = 
NULL
;

325 
»t
;

327 
	`bŒfs_š™_dummy_Œªs
(&
Œªs
, 
fs_šfo
);

329 
	`‹¡_msg
("running qgroup multiple„efsest");

335 
»t
 = 
	`bŒfs_ü—‹_qgroup
(&
Œªs
, 
BTRFS_FIRST_FREE_OBJECTID
);

336 ià(
»t
) {

337 
	`‹¡_”r
("couldn'ˆü—‹‡ qgrou°%d", 
»t
);

338  
»t
;

341 
ùx
.
by‹Ä
 = 
nodesize
;

342 
ùx
.
Œªs
 = &trans;

343 
ùx
.
fs_šfo
 = fs_info;

345 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
ùx
, 
çl£
);

346 ià(
»t
) {

347 
	`‹¡_”r
("couldn'ˆfšd old„oÙs: %d", 
»t
);

348  
»t
;

350 
Şd_roÙs
 = 
ùx
.
roÙs
;

351 
ùx
.
roÙs
 = 
NULL
;

353 
»t
 = 
	`š£¹_nÜm®_Œ“_»f
(
roÙ
, 
nodesize
,‚odesize, 0,

354 
BTRFS_FS_TREE_OBJECTID
);

355 ià(
»t
) {

356 
	`uli¡_ä“
(
Şd_roÙs
);

357  
»t
;

360 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
ùx
, 
çl£
);

361 ià(
»t
) {

362 
	`uli¡_ä“
(
Şd_roÙs
);

363 
	`‹¡_”r
("couldn'ˆfšd old„oÙs: %d", 
»t
);

364  
»t
;

366 
Ãw_roÙs
 = 
ùx
.
roÙs
;

367 
ùx
.
roÙs
 = 
NULL
;

369 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Á
(&
Œªs
, 
nodesize
,‚odesize, 
Şd_roÙs
,

370 
Ãw_roÙs
);

371 ià(
»t
) {

372 
	`‹¡_”r
("couldn'ˆaccouÁ s·û fÜ‡ qgrou°%d", 
»t
);

373  
»t
;

376 ià(
	`bŒfs_v”ify_qgroup_couÁs
(
fs_šfo
, 
BTRFS_FS_TREE_OBJECTID
,

377 
nodesize
,‚odesize)) {

378 
	`‹¡_”r
("qgroup counts didn't matchƒxpected values");

379  -
EINVAL
;

382 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
ùx
, 
çl£
);

383 ià(
»t
) {

384 
	`‹¡_”r
("couldn'ˆfšd old„oÙs: %d", 
»t
);

385  
»t
;

387 
Şd_roÙs
 = 
ùx
.
roÙs
;

388 
ùx
.
roÙs
 = 
NULL
;

390 
»t
 = 
	`add_Œ“_»f
(
roÙ
, 
nodesize
,‚odesize, 0,

391 
BTRFS_FIRST_FREE_OBJECTID
);

392 ià(
»t
) {

393 
	`uli¡_ä“
(
Şd_roÙs
);

394  
»t
;

397 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
ùx
, 
çl£
);

398 ià(
»t
) {

399 
	`uli¡_ä“
(
Şd_roÙs
);

400 
	`‹¡_”r
("couldn'ˆfšd old„oÙs: %d", 
»t
);

401  
»t
;

403 
Ãw_roÙs
 = 
ùx
.
roÙs
;

404 
ùx
.
roÙs
 = 
NULL
;

406 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Á
(&
Œªs
, 
nodesize
,‚odesize, 
Şd_roÙs
,

407 
Ãw_roÙs
);

408 ià(
»t
) {

409 
	`‹¡_”r
("couldn'ˆaccouÁ s·û fÜ‡ qgrou°%d", 
»t
);

410  
»t
;

413 ià(
	`bŒfs_v”ify_qgroup_couÁs
(
fs_šfo
, 
BTRFS_FS_TREE_OBJECTID
,

414 
nodesize
, 0)) {

415 
	`‹¡_”r
("qgroup counts didn't matchƒxpected values");

416  -
EINVAL
;

419 ià(
	`bŒfs_v”ify_qgroup_couÁs
(
fs_šfo
, 
BTRFS_FIRST_FREE_OBJECTID
,

420 
nodesize
, 0)) {

421 
	`‹¡_”r
("qgroup counts didn't matchƒxpected values");

422  -
EINVAL
;

425 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
ùx
, 
çl£
);

426 ià(
»t
) {

427 
	`‹¡_”r
("couldn'ˆfšd old„oÙs: %d", 
»t
);

428  
»t
;

430 
Şd_roÙs
 = 
ùx
.
roÙs
;

431 
ùx
.
roÙs
 = 
NULL
;

433 
»t
 = 
	`»move_ex‹Á_»f
(
roÙ
, 
nodesize
,‚odesize, 0,

434 
BTRFS_FIRST_FREE_OBJECTID
);

435 ià(
»t
) {

436 
	`uli¡_ä“
(
Şd_roÙs
);

437  
»t
;

440 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
ùx
, 
çl£
);

441 ià(
»t
) {

442 
	`uli¡_ä“
(
Şd_roÙs
);

443 
	`‹¡_”r
("couldn'ˆfšd old„oÙs: %d", 
»t
);

444  
»t
;

446 
Ãw_roÙs
 = 
ùx
.
roÙs
;

447 
ùx
.
roÙs
 = 
NULL
;

449 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Á
(&
Œªs
, 
nodesize
,‚odesize, 
Şd_roÙs
,

450 
Ãw_roÙs
);

451 ià(
»t
) {

452 
	`‹¡_”r
("couldn'ˆaccouÁ s·û fÜ‡ qgrou°%d", 
»t
);

453  
»t
;

456 ià(
	`bŒfs_v”ify_qgroup_couÁs
(
fs_šfo
, 
BTRFS_FIRST_FREE_OBJECTID
,

458 
	`‹¡_”r
("qgroup counts didn't matchƒxpected values");

459  -
EINVAL
;

462 ià(
	`bŒfs_v”ify_qgroup_couÁs
(
fs_šfo
, 
BTRFS_FS_TREE_OBJECTID
,

463 
nodesize
,‚odesize)) {

464 
	`‹¡_”r
("qgroup counts didn't matchƒxpected values");

465  -
EINVAL
;

469 
	}
}

471 
	$bŒfs_‹¡_qgroups
(
u32
 
£ùÜsize
, u32 
nodesize
)

473 
bŒfs_fs_šfo
 *
fs_šfo
 = 
NULL
;

474 
bŒfs_roÙ
 *
roÙ
;

475 
bŒfs_roÙ
 *
tmp_roÙ
;

476 
»t
 = 0;

478 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
nodesize
, 
£ùÜsize
);

479 ià(!
fs_šfo
) {

480 
	`‹¡_¡d_”r
(
TEST_ALLOC_FS_INFO
);

481  -
ENOMEM
;

484 
roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

485 ià(
	`IS_ERR
(
roÙ
)) {

486 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

487 
»t
 = 
	`PTR_ERR
(
roÙ
);

488 
out
;

492 
roÙ
->
roÙ_key
.
objeùid
 = 
BTRFS_EXTENT_TREE_OBJECTID
;

493 
roÙ
->
roÙ_key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

494 
roÙ
->
roÙ_key
.
off£t
 = 0;

495 
	`bŒfs_glob®_roÙ_š£¹
(
roÙ
);

501 
roÙ
->
fs_šfo
->
Œ“_roÙ
 =„oot;

502 
roÙ
->
fs_šfo
->
quÙa_roÙ
 =„oot;

503 
	`£t_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
);

509 
roÙ
->
node
 = 
	`®loc_‹¡_ex‹Á_bufãr
ÔoÙ->
fs_šfo
, 
nodesize
);

510 ià(
	`IS_ERR
(
roÙ
->
node
)) {

511 
	`‹¡_”r
("couldn't‡llocate dummy buffer");

512 
»t
 = 
	`PTR_ERR
(
roÙ
->
node
);

513 
out
;

515 
	`bŒfs_£t_h—d”_Ëv–
(
roÙ
->
node
, 0);

516 
	`bŒfs_£t_h—d”_Ä™ems
(
roÙ
->
node
, 0);

517 
roÙ
->
®loc_by‹Ä
 +ğ2 * 
nodesize
;

519 
tmp_roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

520 ià(
	`IS_ERR
(
tmp_roÙ
)) {

521 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

522 
»t
 = 
	`PTR_ERR
(
tmp_roÙ
);

523 
out
;

526 
tmp_roÙ
->
roÙ_key
.
objeùid
 = 
BTRFS_FS_TREE_OBJECTID
;

527 
roÙ
->
fs_šfo
->
fs_roÙ
 = 
tmp_roÙ
;

528 
»t
 = 
	`bŒfs_š£¹_fs_roÙ
(
roÙ
->
fs_šfo
, 
tmp_roÙ
);

529 ià(
»t
) {

530 
	`‹¡_”r
("couldn'ˆš£¹ f roÙ %d", 
»t
);

531 
out
;

533 
	`bŒfs_put_roÙ
(
tmp_roÙ
);

535 
tmp_roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

536 ià(
	`IS_ERR
(
tmp_roÙ
)) {

537 
	`‹¡_¡d_”r
(
TEST_ALLOC_ROOT
);

538 
»t
 = 
	`PTR_ERR
(
tmp_roÙ
);

539 
out
;

542 
tmp_roÙ
->
roÙ_key
.
objeùid
 = 
BTRFS_FIRST_FREE_OBJECTID
;

543 
»t
 = 
	`bŒfs_š£¹_fs_roÙ
(
roÙ
->
fs_šfo
, 
tmp_roÙ
);

544 ià(
»t
) {

545 
	`‹¡_”r
("couldn'ˆš£¹ f roÙ %d", 
»t
);

546 
out
;

548 
	`bŒfs_put_roÙ
(
tmp_roÙ
);

550 
	`‹¡_msg
("running qgroupests");

551 
»t
 = 
	`‹¡_no_sh¬ed_qgroup
(
roÙ
, 
£ùÜsize
, 
nodesize
);

552 ià(
»t
)

553 
out
;

554 
»t
 = 
	`‹¡_muÉË_»fs
(
roÙ
, 
£ùÜsize
, 
nodesize
);

555 
out
:

556 
	`bŒfs_ä“_dummy_roÙ
(
roÙ
);

557 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

558  
»t
;

559 
	}
}

	@transaction.c

6 
	~<lšux/fs.h
>

7 
	~<lšux/¦ab.h
>

8 
	~<lšux/sched.h
>

9 
	~<lšux/sched/mm.h
>

10 
	~<lšux/wr™eback.h
>

11 
	~<lšux/·gem­.h
>

12 
	~<lšux/blkdev.h
>

13 
	~<lšux/uuid.h
>

14 
	~<lšux/timek“pšg.h
>

15 
	~"misc.h
"

16 
	~"ù»e.h
"

17 
	~"disk-io.h
"

18 
	~"Œª§ùiÚ.h
"

19 
	~"lockšg.h
"

20 
	~"Œ“-log.h
"

21 
	~"vŞumes.h
"

22 
	~"dev-»¶aû.h
"

23 
	~"qgroup.h
"

24 
	~"block-group.h
"

25 
	~"¥aû-šfo.h
"

26 
	~"zÚed.h
"

27 
	~"fs.h
"

28 
	~"acûssÜs.h
"

29 
	~"ex‹Á-Œ“.h
"

30 
	~"roÙ-Œ“.h
"

31 
	~"deäag.h
"

32 
	~"dœ-™em.h
"

33 
	~"uuid-Œ“.h
"

34 
	~"ioùl.h
"

35 
	~"»loÿtiÚ.h
"

36 
	~"süub.h
"

38 
kmem_ÿche
 *
	gbŒfs_Œªs_hªdË_ÿch•
;

40 
	#BTRFS_ROOT_TRANS_TAG
 0

	)

118 cÚ¡ 
	gbŒfs_blocked_Œªs_ty³s
[
TRANS_STATE_MAX
] = {

119 [
TRANS_STATE_RUNNING
] = 0U,

120 [
TRANS_STATE_COMMIT_PREP
] = 0U,

121 [
TRANS_STATE_COMMIT_START
] = (
__TRANS_START
 | 
__TRANS_ATTACH
),

122 [
TRANS_STATE_COMMIT_DOING
] = (
__TRANS_START
 |

123 
__TRANS_ATTACH
 |

124 
__TRANS_JOIN
 |

125 
__TRANS_JOIN_NOSTART
),

126 [
TRANS_STATE_UNBLOCKED
] = (
__TRANS_START
 |

127 
__TRANS_ATTACH
 |

128 
__TRANS_JOIN
 |

129 
__TRANS_JOIN_NOLOCK
 |

130 
__TRANS_JOIN_NOSTART
),

131 [
TRANS_STATE_SUPER_COMMITTED
] = (
__TRANS_START
 |

132 
__TRANS_ATTACH
 |

133 
__TRANS_JOIN
 |

134 
__TRANS_JOIN_NOLOCK
 |

135 
__TRANS_JOIN_NOSTART
),

136 [
TRANS_STATE_COMPLETED
] = (
__TRANS_START
 |

137 
__TRANS_ATTACH
 |

138 
__TRANS_JOIN
 |

139 
__TRANS_JOIN_NOLOCK
 |

140 
__TRANS_JOIN_NOSTART
),

143 
	$bŒfs_put_Œª§ùiÚ
(
bŒfs_Œª§ùiÚ
 *
Œª§ùiÚ
)

145 
	`WARN_ON
(
	`»fcouÁ_»ad
(&
Œª§ùiÚ
->
u£_couÁ
) == 0);

146 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
Œª§ùiÚ
->
u£_couÁ
)) {

147 
	`BUG_ON
(!
	`li¡_em±y
(&
Œª§ùiÚ
->
li¡
));

148 
	`WARN_ON
(!
	`RB_EMPTY_ROOT
(

149 &
Œª§ùiÚ
->
d–ayed_»fs
.
h»f_roÙ
.
rb_roÙ
));

150 
	`WARN_ON
(!
	`RB_EMPTY_ROOT
(

151 &
Œª§ùiÚ
->
d–ayed_»fs
.
dœty_ex‹Á_roÙ
));

152 ià(
Œª§ùiÚ
->
d–ayed_»fs
.
³ndšg_csums
)

153 
	`bŒfs_”r
(
Œª§ùiÚ
->
fs_šfo
,

155 
Œª§ùiÚ
->
d–ayed_»fs
.
³ndšg_csums
);

163 !
	`li¡_em±y
(&
Œª§ùiÚ
->
d–‘ed_bgs
)) {

164 
bŒfs_block_group
 *
ÿche
;

166 
ÿche
 = 
	`li¡_fœ¡_’Œy
(&
Œª§ùiÚ
->
d–‘ed_bgs
,

167 
bŒfs_block_group
,

168 
bg_li¡
);

169 
	`li¡_d–_š™
(&
ÿche
->
bg_li¡
);

170 
	`bŒfs_unä“ze_block_group
(
ÿche
);

171 
	`bŒfs_put_block_group
(
ÿche
);

173 
	`WARN_ON
(!
	`li¡_em±y
(&
Œª§ùiÚ
->
dev_upd©e_li¡
));

174 
	`kä“
(
Œª§ùiÚ
);

176 
	}
}

178 
nošlše
 
	$sw™ch_comm™_roÙs
(
bŒfs_Œªs_hªdË
 *
Œªs
)

180 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

181 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

182 
bŒfs_roÙ
 *
roÙ
, *
tmp
;

188 
	`ASSERT
(
cur_Œªs
->
¡©e
 =ğ
TRANS_STATE_COMMIT_DOING
);

190 
	`down_wr™e
(&
fs_šfo
->
comm™_roÙ_£m
);

192 ià(
	`‹¡_b™
(
BTRFS_FS_RELOC_RUNNING
, &
fs_šfo
->
æags
))

193 
fs_šfo
->
Ï¡_»loc_Œªs
 = 
Œªs
->
Œªsid
;

195 
	`li¡_fÜ_—ch_’Œy_§ã
(
roÙ
, 
tmp
, &
cur_Œªs
->
sw™ch_comm™s
,

196 
dœty_li¡
) {

197 
	`li¡_d–_š™
(&
roÙ
->
dœty_li¡
);

198 
	`ä“_ex‹Á_bufãr
(
roÙ
->
comm™_roÙ
);

199 
roÙ
->
comm™_roÙ
 = 
	`bŒfs_roÙ_node
(root);

200 
	`ex‹Á_io_Œ“_»Ëa£
(&
roÙ
->
dœty_log_·ges
);

201 
	`bŒfs_qgroup_ş—n_sw­³d_blocks
(
roÙ
);

205 
	`¥š_lock
(&
cur_Œªs
->
drİ³d_roÙs_lock
);

206 !
	`li¡_em±y
(&
cur_Œªs
->
drİ³d_roÙs
)) {

207 
roÙ
 = 
	`li¡_fœ¡_’Œy
(&
cur_Œªs
->
drİ³d_roÙs
,

208 
bŒfs_roÙ
, 
roÙ_li¡
);

209 
	`li¡_d–_š™
(&
roÙ
->
roÙ_li¡
);

210 
	`¥š_uÆock
(&
cur_Œªs
->
drİ³d_roÙs_lock
);

211 
	`bŒfs_ä“_log
(
Œªs
, 
roÙ
);

212 
	`bŒfs_drİ_ªd_ä“_fs_roÙ
(
fs_šfo
, 
roÙ
);

213 
	`¥š_lock
(&
cur_Œªs
->
drİ³d_roÙs_lock
);

215 
	`¥š_uÆock
(&
cur_Œªs
->
drİ³d_roÙs_lock
);

217 
	`up_wr™e
(&
fs_šfo
->
comm™_roÙ_£m
);

218 
	}
}

220 
šlše
 
	$extwr™”_couÁ”_šc
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

221 
ty³
)

223 ià(
ty³
 & 
TRANS_EXTWRITERS
)

224 
	`©omic_šc
(&
Œªs
->
num_extwr™”s
);

225 
	}
}

227 
šlše
 
	$extwr™”_couÁ”_dec
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

228 
ty³
)

230 ià(
ty³
 & 
TRANS_EXTWRITERS
)

231 
	`©omic_dec
(&
Œªs
->
num_extwr™”s
);

232 
	}
}

234 
šlše
 
	$extwr™”_couÁ”_š™
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

235 
ty³
)

237 
	`©omic_£t
(&
Œªs
->
num_extwr™”s
, ((
ty³
 & 
TRANS_EXTWRITERS
) ? 1 : 0));

238 
	}
}

240 
šlše
 
	$extwr™”_couÁ”_»ad
(
bŒfs_Œª§ùiÚ
 *
Œªs
)

242  
	`©omic_»ad
(&
Œªs
->
num_extwr™”s
);

243 
	}
}

252 
	$bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
bŒfs_Œªs_hªdË
 *
Œªs
)

254 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

256 ià(!
Œªs
->
chunk_by‹s_»£rved
)

259 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, &fs_šfo->
chunk_block_rsv
,

260 
Œªs
->
chunk_by‹s_»£rved
, 
NULL
);

261 
Œªs
->
chunk_by‹s_»£rved
 = 0;

262 
	}
}

267 
nošlše
 
	$još_Œª§ùiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
,

268 
ty³
)

270 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
;

272 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

273 
loİ
:

275 ià(
	`BTRFS_FS_ERROR
(
fs_šfo
)) {

276 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

277  -
EROFS
;

280 
cur_Œªs
 = 
fs_šfo
->
ruÂšg_Œª§ùiÚ
;

281 ià(
cur_Œªs
) {

282 ià(
	`TRANS_ABORTED
(
cur_Œªs
)) {

283 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

284  
cur_Œªs
->
abÜ‹d
;

286 ià(
bŒfs_blocked_Œªs_ty³s
[
cur_Œªs
->
¡©e
] & 
ty³
) {

287 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

288  -
EBUSY
;

290 
	`»fcouÁ_šc
(&
cur_Œªs
->
u£_couÁ
);

291 
	`©omic_šc
(&
cur_Œªs
->
num_wr™”s
);

292 
	`extwr™”_couÁ”_šc
(
cur_Œªs
, 
ty³
);

293 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

294 
	`bŒfs_lockd•_acquœe
(
fs_šfo
, 
bŒfs_Œªs_num_wr™”s
);

295 
	`bŒfs_lockd•_acquœe
(
fs_šfo
, 
bŒfs_Œªs_num_extwr™”s
);

298 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

305 ià(
ty³
 =ğ
TRANS_ATTACH
 ||y³ =ğ
TRANS_JOIN_NOSTART
)

306  -
ENOENT
;

312 
	`BUG_ON
(
ty³
 =ğ
TRANS_JOIN_NOLOCK
);

314 
cur_Œªs
 = 
	`km®loc
((*cur_Œªs), 
GFP_NOFS
);

315 ià(!
cur_Œªs
)

316  -
ENOMEM
;

318 
	`bŒfs_lockd•_acquœe
(
fs_šfo
, 
bŒfs_Œªs_num_wr™”s
);

319 
	`bŒfs_lockd•_acquœe
(
fs_šfo
, 
bŒfs_Œªs_num_extwr™”s
);

321 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

322 ià(
fs_šfo
->
ruÂšg_Œª§ùiÚ
) {

327 
	`bŒfs_lockd•_»Ëa£
(
fs_šfo
, 
bŒfs_Œªs_num_extwr™”s
);

328 
	`bŒfs_lockd•_»Ëa£
(
fs_šfo
, 
bŒfs_Œªs_num_wr™”s
);

329 
	`kä“
(
cur_Œªs
);

330 
loİ
;

331 } ià(
	`BTRFS_FS_ERROR
(
fs_šfo
)) {

332 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

333 
	`bŒfs_lockd•_»Ëa£
(
fs_šfo
, 
bŒfs_Œªs_num_extwr™”s
);

334 
	`bŒfs_lockd•_»Ëa£
(
fs_šfo
, 
bŒfs_Œªs_num_wr™”s
);

335 
	`kä“
(
cur_Œªs
);

336  -
EROFS
;

339 
cur_Œªs
->
fs_šfo
 = fs_info;

340 
	`©omic_£t
(&
cur_Œªs
->
³ndšg_Üd”ed
, 0);

341 
	`š™_wa™queue_h—d
(&
cur_Œªs
->
³ndšg_wa™
);

342 
	`©omic_£t
(&
cur_Œªs
->
num_wr™”s
, 1);

343 
	`extwr™”_couÁ”_š™
(
cur_Œªs
, 
ty³
);

344 
	`š™_wa™queue_h—d
(&
cur_Œªs
->
wr™”_wa™
);

345 
	`š™_wa™queue_h—d
(&
cur_Œªs
->
comm™_wa™
);

346 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_RUNNING
;

351 
	`»fcouÁ_£t
(&
cur_Œªs
->
u£_couÁ
, 2);

352 
cur_Œªs
->
æags
 = 0;

353 
cur_Œªs
->
¡¬t_time
 = 
	`ktime_g‘_£cÚds
();

355 
	`mem£t
(&
cur_Œªs
->
d–ayed_»fs
, 0, (cur_trans->delayed_refs));

357 
cur_Œªs
->
d–ayed_»fs
.
h»f_roÙ
 = 
RB_ROOT_CACHED
;

358 
cur_Œªs
->
d–ayed_»fs
.
dœty_ex‹Á_roÙ
 = 
RB_ROOT
;

359 
	`©omic_£t
(&
cur_Œªs
->
d–ayed_»fs
.
num_’Œ›s
, 0);

365 
	`smp_mb
();

366 ià(!
	`li¡_em±y
(&
fs_šfo
->
Œ“_mod_£q_li¡
))

367 
	`WARN
(1, 
KERN_ERR
 "BTRFS:ree_mod_seq_list‚otƒmpty when creating‡ freshransaction\n");

368 ià(!
	`RB_EMPTY_ROOT
(&
fs_šfo
->
Œ“_mod_log
))

369 
	`WARN
(1, 
KERN_ERR
 "BTRFS:ree_mod_log„bree‚otƒmpty when creating‡ freshransaction\n");

370 
	`©omic64_£t
(&
fs_šfo
->
Œ“_mod_£q
, 0);

372 
	`¥š_lock_š™
(&
cur_Œªs
->
d–ayed_»fs
.
lock
);

374 
	`INIT_LIST_HEAD
(&
cur_Œªs
->
³ndšg_¢­shÙs
);

375 
	`INIT_LIST_HEAD
(&
cur_Œªs
->
dev_upd©e_li¡
);

376 
	`INIT_LIST_HEAD
(&
cur_Œªs
->
sw™ch_comm™s
);

377 
	`INIT_LIST_HEAD
(&
cur_Œªs
->
dœty_bgs
);

378 
	`INIT_LIST_HEAD
(&
cur_Œªs
->
io_bgs
);

379 
	`INIT_LIST_HEAD
(&
cur_Œªs
->
drİ³d_roÙs
);

380 
	`mu‹x_š™
(&
cur_Œªs
->
ÿche_wr™e_mu‹x
);

381 
	`¥š_lock_š™
(&
cur_Œªs
->
dœty_bgs_lock
);

382 
	`INIT_LIST_HEAD
(&
cur_Œªs
->
d–‘ed_bgs
);

383 
	`¥š_lock_š™
(&
cur_Œªs
->
drİ³d_roÙs_lock
);

384 
	`li¡_add_
(&
cur_Œªs
->
li¡
, &
fs_šfo
->
Œªs_li¡
);

385 
	`ex‹Á_io_Œ“_š™
(
fs_šfo
, &
cur_Œªs
->
dœty_·ges
,

386 
IO_TREE_TRANS_DIRTY_PAGES
);

387 
	`ex‹Á_io_Œ“_š™
(
fs_šfo
, &
cur_Œªs
->
pšÃd_ex‹Ás
,

388 
IO_TREE_FS_PINNED_EXTENTS
);

389 
fs_šfo
->
g’”©iÚ
++;

390 
cur_Œªs
->
Œªsid
 = 
fs_šfo
->
g’”©iÚ
;

391 
fs_šfo
->
ruÂšg_Œª§ùiÚ
 = 
cur_Œªs
;

392 
cur_Œªs
->
abÜ‹d
 = 0;

393 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

396 
	}
}

404 
	$»cÜd_roÙ_š_Œªs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

405 
bŒfs_roÙ
 *
roÙ
,

406 
fÜû
)

408 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

409 
»t
 = 0;

411 ià((
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
) &&

412 
roÙ
->
Ï¡_Œªs
 < 
Œªs
->
Œªsid
è|| 
fÜû
) {

413 
	`WARN_ON
(!
fÜû
 && 
roÙ
->
comm™_roÙ
 !ğroÙ->
node
);

420 
	`£t_b™
(
BTRFS_ROOT_IN_TRANS_SETUP
, &
roÙ
->
¡©e
);

425 
	`smp_wmb
();

427 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

428 ià(
roÙ
->
Ï¡_Œªs
 =ğ
Œªs
->
Œªsid
 && !
fÜû
) {

429 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

432 
	`¿dix_Œ“_g_£t
(&
fs_šfo
->
fs_roÙs_¿dix
,

433 ()
roÙ
->
roÙ_key
.
objeùid
,

434 
BTRFS_ROOT_TRANS_TAG
);

435 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

436 
roÙ
->
Ï¡_Œªs
 = 
Œªs
->
Œªsid
;

457 
»t
 = 
	`bŒfs_š™_»loc_roÙ
(
Œªs
, 
roÙ
);

458 
	`smp_mb__befÜe_©omic
();

459 
	`ş—r_b™
(
BTRFS_ROOT_IN_TRANS_SETUP
, &
roÙ
->
¡©e
);

461  
»t
;

462 
	}
}

465 
	$bŒfs_add_drİ³d_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

466 
bŒfs_roÙ
 *
roÙ
)

468 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

469 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

472 
	`¥š_lock
(&
cur_Œªs
->
drİ³d_roÙs_lock
);

473 
	`li¡_add_
(&
roÙ
->
roÙ_li¡
, &
cur_Œªs
->
drİ³d_roÙs
);

474 
	`¥š_uÆock
(&
cur_Œªs
->
drİ³d_roÙs_lock
);

477 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

478 
	`¿dix_Œ“_g_ş—r
(&
fs_šfo
->
fs_roÙs_¿dix
,

479 ()
roÙ
->
roÙ_key
.
objeùid
,

480 
BTRFS_ROOT_TRANS_TAG
);

481 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

482 
	}
}

484 
	$bŒfs_»cÜd_roÙ_š_Œªs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

485 
bŒfs_roÙ
 *
roÙ
)

487 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

488 
»t
;

490 ià(!
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
))

497 
	`smp_rmb
();

498 ià(
roÙ
->
Ï¡_Œªs
 =ğ
Œªs
->
Œªsid
 &&

499 !
	`‹¡_b™
(
BTRFS_ROOT_IN_TRANS_SETUP
, &
roÙ
->
¡©e
))

502 
	`mu‹x_lock
(&
fs_šfo
->
»loc_mu‹x
);

503 
»t
 = 
	`»cÜd_roÙ_š_Œªs
(
Œªs
, 
roÙ
, 0);

504 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

506  
»t
;

507 
	}
}

509 
šlše
 
	$is_Œª§ùiÚ_blocked
(
bŒfs_Œª§ùiÚ
 *
Œªs
)

511  (
Œªs
->
¡©e
 >ğ
TRANS_STATE_COMMIT_START
 &&

512 
Œªs
->
¡©e
 < 
TRANS_STATE_UNBLOCKED
 &&

513 !
	`TRANS_ABORTED
(
Œªs
));

514 
	}
}

520 
	$wa™_cu¼’t_Œªs
(
bŒfs_fs_šfo
 *
fs_šfo
)

522 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
;

524 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

525 
cur_Œªs
 = 
fs_šfo
->
ruÂšg_Œª§ùiÚ
;

526 ià(
cur_Œªs
 && 
	`is_Œª§ùiÚ_blocked
(cur_trans)) {

527 
	`»fcouÁ_šc
(&
cur_Œªs
->
u£_couÁ
);

528 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

530 
	`bŒfs_might_wa™_fÜ_¡©e
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_UNBLOCKED
);

531 
	`wa™_ev’t
(
fs_šfo
->
Œª§ùiÚ_wa™
,

532 
cur_Œªs
->
¡©e
 >ğ
TRANS_STATE_UNBLOCKED
 ||

533 
	`TRANS_ABORTED
(
cur_Œªs
));

534 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

536 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

538 
	}
}

540 
	$may_wa™_Œª§ùiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
, 
ty³
)

542 ià(
	`‹¡_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
))

545 ià(
ty³
 =ğ
TRANS_START
)

549 
	}
}

551 
šlše
 
boŞ
 
	$Ãed_»£rve_»loc_roÙ
(
bŒfs_roÙ
 *
roÙ
)

553 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

555 ià(!
fs_šfo
->
»loc_ùl
 ||

556 !
	`‹¡_b™
(
BTRFS_ROOT_SHAREABLE
, &
roÙ
->
¡©e
) ||

557 
roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
 ||

558 
roÙ
->
»loc_roÙ
)

559  
çl£
;

561  
Œue
;

562 
	}
}

564 
bŒfs_Œªs_hªdË
 *

565 
	$¡¬t_Œª§ùiÚ
(
bŒfs_roÙ
 *
roÙ
, 
num_™ems
,

566 
ty³
, 
bŒfs_»£rve_æush_’um
 
æush
,

567 
boŞ
 
’fÜû_qgroups
)

569 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

570 
bŒfs_block_rsv
 *
d–ayed_»fs_rsv
 = &
fs_šfo
->delayed_refs_rsv;

571 
bŒfs_Œªs_hªdË
 *
h
;

572 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
;

573 
u64
 
num_by‹s
 = 0;

574 
u64
 
qgroup_»£rved
 = 0;

575 
boŞ
 
»loc_»£rved
 = 
çl£
;

576 
boŞ
 
do_chunk_®loc
 = 
çl£
;

577 
»t
;

579 ià(
	`BTRFS_FS_ERROR
(
fs_šfo
))

580  
	`ERR_PTR
(-
EROFS
);

582 ià(
cu¼’t
->
jouº®_šfo
) {

583 
	`WARN_ON
(
ty³
 & 
TRANS_EXTWRITERS
);

584 
h
 = 
cu¼’t
->
jouº®_šfo
;

585 
	`»fcouÁ_šc
(&
h
->
u£_couÁ
);

586 
	`WARN_ON
(
	`»fcouÁ_»ad
(&
h
->
u£_couÁ
) > 2);

587 
h
->
Üig_rsv
 = h->
block_rsv
;

588 
h
->
block_rsv
 = 
NULL
;

589 
gÙ_™
;

596 ià(
num_™ems
 && 
roÙ
 !ğ
fs_šfo
->
chunk_roÙ
) {

597 
bŒfs_block_rsv
 *
rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

598 
u64
 
d–ayed_»fs_by‹s
 = 0;

600 
qgroup_»£rved
 = 
num_™ems
 * 
fs_šfo
->
nodesize
;

606 
»t
 = 
	`bŒfs_qgroup_»£rve_m‘a_´—Îoc
(
roÙ
, 
qgroup_»£rved
,

607 
’fÜû_qgroups
, 
çl£
);

608 ià(
»t
)

609  
	`ERR_PTR
(
»t
);

618 
num_by‹s
 = 
	`bŒfs_ÿlc_š£¹_m‘ad©a_size
(
fs_šfo
, 
num_™ems
);

619 ià(
æush
 =ğ
BTRFS_RESERVE_FLUSH_ALL
 &&

620 !
	`bŒfs_block_rsv_fuÎ
(
d–ayed_»fs_rsv
)) {

621 
d–ayed_»fs_by‹s
 = 
	`bŒfs_ÿlc_d–ayed_»f_by‹s
(
fs_šfo
,

622 
num_™ems
);

623 
num_by‹s
 +ğ
d–ayed_»fs_by‹s
;

629 ià(
	`Ãed_»£rve_»loc_roÙ
(
roÙ
)) {

630 
num_by‹s
 +ğ
fs_šfo
->
nodesize
;

631 
»loc_»£rved
 = 
Œue
;

634 
»t
 = 
	`bŒfs_»£rve_m‘ad©a_by‹s
(
fs_šfo
, 
rsv
, 
num_by‹s
, 
æush
);

635 ià(
»t
)

636 
»£rve_ç
;

637 ià(
d–ayed_»fs_by‹s
) {

638 
	`bŒfs_mig¿‹_to_d–ayed_»fs_rsv
(
fs_šfo
, 
d–ayed_»fs_by‹s
);

639 
num_by‹s
 -ğ
d–ayed_»fs_by‹s
;

641 
	`bŒfs_block_rsv_add_by‹s
(
rsv
, 
num_by‹s
, 
Œue
);

643 ià(
rsv
->
¥aû_šfo
->
fÜû_®loc
)

644 
do_chunk_®loc
 = 
Œue
;

645 } ià(
num_™ems
 =ğ0 && 
æush
 =ğ
BTRFS_RESERVE_FLUSH_ALL
 &&

646 !
	`bŒfs_block_rsv_fuÎ
(
d–ayed_»fs_rsv
)) {

654 
»t
 = 
	`bŒfs_d–ayed_»fs_rsv_»fl
(
fs_šfo
, 
æush
);

655 ià(
»t
)

656 
»£rve_ç
;

658 
agaš
:

659 
h
 = 
	`kmem_ÿche_z®loc
(
bŒfs_Œªs_hªdË_ÿch•
, 
GFP_NOFS
);

660 ià(!
h
) {

661 
»t
 = -
ENOMEM
;

662 
®loc_ç
;

675 ià(
ty³
 & 
__TRANS_FREEZABLE
)

676 
	`sb_¡¬t_štwr™e
(
fs_šfo
->
sb
);

678 ià(
	`may_wa™_Œª§ùiÚ
(
fs_šfo
, 
ty³
))

679 
	`wa™_cu¼’t_Œªs
(
fs_šfo
);

682 
»t
 = 
	`još_Œª§ùiÚ
(
fs_šfo
, 
ty³
);

683 ià(
»t
 =ğ-
EBUSY
) {

684 
	`wa™_cu¼’t_Œªs
(
fs_šfo
);

685 ià(
	`uÆik–y
(
ty³
 =ğ
TRANS_ATTACH
 ||

686 
ty³
 =ğ
TRANS_JOIN_NOSTART
))

687 
»t
 = -
ENOENT
;

689 } 
»t
 =ğ-
EBUSY
);

691 ià(
»t
 < 0)

692 
još_ç
;

694 
cur_Œªs
 = 
fs_šfo
->
ruÂšg_Œª§ùiÚ
;

696 
h
->
Œªsid
 = 
cur_Œªs
->transid;

697 
h
->
Œª§ùiÚ
 = 
cur_Œªs
;

698 
	`»fcouÁ_£t
(&
h
->
u£_couÁ
, 1);

699 
h
->
fs_šfo
 = 
roÙ
->fs_info;

701 
h
->
ty³
 =ype;

702 
	`INIT_LIST_HEAD
(&
h
->
Ãw_bgs
);

704 
	`smp_mb
();

705 ià(
cur_Œªs
->
¡©e
 >ğ
TRANS_STATE_COMMIT_START
 &&

706 
	`may_wa™_Œª§ùiÚ
(
fs_šfo
, 
ty³
)) {

707 
cu¼’t
->
jouº®_šfo
 = 
h
;

708 
	`bŒfs_comm™_Œª§ùiÚ
(
h
);

709 
agaš
;

712 ià(
num_by‹s
) {

713 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "transaction",

714 
h
->
Œªsid
, 
num_by‹s
, 1);

715 
h
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

716 
h
->
by‹s_»£rved
 = 
num_by‹s
;

717 
h
->
»loc_»£rved
 =„eloc_reserved;

725 ià(
qgroup_»£rved
)

726 
	`bŒfs_qgroup_cÚv”t_»£rved_m‘a
(
roÙ
, 
qgroup_»£rved
);

728 
gÙ_™
:

729 ià(!
cu¼’t
->
jouº®_šfo
)

730 
cu¼’t
->
jouº®_šfo
 = 
h
;

738 ià(
do_chunk_®loc
 && 
num_by‹s
) {

739 
u64
 
æags
 = 
h
->
block_rsv
->
¥aû_šfo
->flags;

741 
	`bŒfs_chunk_®loc
(
h
, 
	`bŒfs_g‘_®loc_´ofe
(
fs_šfo
, 
æags
),

742 
CHUNK_ALLOC_NO_FORCE
);

753 
»t
 = 
	`bŒfs_»cÜd_roÙ_š_Œªs
(
h
, 
roÙ
);

754 ià(
»t
) {

760 
	`bŒfs_’d_Œª§ùiÚ
(
h
);

761  
	`ERR_PTR
(
»t
);

764  
h
;

766 
još_ç
:

767 ià(
ty³
 & 
__TRANS_FREEZABLE
)

768 
	`sb_’d_štwr™e
(
fs_šfo
->
sb
);

769 
	`kmem_ÿche_ä“
(
bŒfs_Œªs_hªdË_ÿch•
, 
h
);

770 
®loc_ç
:

771 ià(
num_by‹s
)

772 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, &fs_šfo->
Œªs_block_rsv
,

773 
num_by‹s
, 
NULL
);

774 
»£rve_ç
:

775 
	`bŒfs_qgroup_ä“_m‘a_´—Îoc
(
roÙ
, 
qgroup_»£rved
);

776  
	`ERR_PTR
(
»t
);

777 
	}
}

779 
bŒfs_Œªs_hªdË
 *
	$bŒfs_¡¬t_Œª§ùiÚ
(
bŒfs_roÙ
 *
roÙ
,

780 
num_™ems
)

782  
	`¡¬t_Œª§ùiÚ
(
roÙ
, 
num_™ems
, 
TRANS_START
,

783 
BTRFS_RESERVE_FLUSH_ALL
, 
Œue
);

784 
	}
}

786 
bŒfs_Œªs_hªdË
 *
	$bŒfs_¡¬t_Œª§ùiÚ_çÎback_glob®_rsv
(

787 
bŒfs_roÙ
 *
roÙ
,

788 
num_™ems
)

790  
	`¡¬t_Œª§ùiÚ
(
roÙ
, 
num_™ems
, 
TRANS_START
,

791 
BTRFS_RESERVE_FLUSH_ALL_STEAL
, 
çl£
);

792 
	}
}

794 
bŒfs_Œªs_hªdË
 *
	$bŒfs_još_Œª§ùiÚ
(
bŒfs_roÙ
 *
roÙ
)

796  
	`¡¬t_Œª§ùiÚ
(
roÙ
, 0, 
TRANS_JOIN
, 
BTRFS_RESERVE_NO_FLUSH
,

797 
Œue
);

798 
	}
}

800 
bŒfs_Œªs_hªdË
 *
	$bŒfs_još_Œª§ùiÚ_¥aûÿche
(
bŒfs_roÙ
 *
roÙ
)

802  
	`¡¬t_Œª§ùiÚ
(
roÙ
, 0, 
TRANS_JOIN_NOLOCK
,

803 
BTRFS_RESERVE_NO_FLUSH
, 
Œue
);

804 
	}
}

813 
bŒfs_Œªs_hªdË
 *
	$bŒfs_još_Œª§ùiÚ_no¡¬t
(
bŒfs_roÙ
 *
roÙ
)

815  
	`¡¬t_Œª§ùiÚ
(
roÙ
, 0, 
TRANS_JOIN_NOSTART
,

816 
BTRFS_RESERVE_NO_FLUSH
, 
Œue
);

817 
	}
}

832 
bŒfs_Œªs_hªdË
 *
	$bŒfs_©ch_Œª§ùiÚ
(
bŒfs_roÙ
 *
roÙ
)

834  
	`¡¬t_Œª§ùiÚ
(
roÙ
, 0, 
TRANS_ATTACH
,

835 
BTRFS_RESERVE_NO_FLUSH
, 
Œue
);

836 
	}
}

845 
bŒfs_Œªs_hªdË
 *

846 
	$bŒfs_©ch_Œª§ùiÚ_b¬r›r
(
bŒfs_roÙ
 *
roÙ
)

848 
bŒfs_Œªs_hªdË
 *
Œªs
;

850 
Œªs
 = 
	`¡¬t_Œª§ùiÚ
(
roÙ
, 0, 
TRANS_ATTACH
,

851 
BTRFS_RESERVE_NO_FLUSH
, 
Œue
);

852 ià(
Œªs
 =ğ
	`ERR_PTR
(-
ENOENT
)) {

853 
»t
;

855 
»t
 = 
	`bŒfs_wa™_fÜ_comm™
(
roÙ
->
fs_šfo
, 0);

856 ià(
»t
)

857  
	`ERR_PTR
(
»t
);

860  
Œªs
;

861 
	}
}

864 
nošlše
 
	$wa™_fÜ_comm™
(
bŒfs_Œª§ùiÚ
 *
comm™
,

865 cÚ¡ 
bŒfs_Œªs_¡©e
 
mš_¡©e
)

867 
bŒfs_fs_šfo
 *
fs_šfo
 = 
comm™
->fs_info;

868 
u64
 
Œªsid
 = 
comm™
->transid;

869 
boŞ
 
put
 = 
çl£
;

875 ià(
mš_¡©e
 =ğ
TRANS_STATE_COMPLETED
)

876 
	`bŒfs_might_wa™_fÜ_¡©e
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_COMPLETED
);

878 
	`bŒfs_might_wa™_fÜ_¡©e
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_SUPER_COMMITTED
);

881 
	`wa™_ev’t
(
comm™
->
comm™_wa™
, comm™->
¡©e
 >ğ
mš_¡©e
);

882 ià(
put
)

883 
	`bŒfs_put_Œª§ùiÚ
(
comm™
);

885 ià(
mš_¡©e
 < 
TRANS_STATE_COMPLETED
)

895 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

896 
comm™
 = 
	`li¡_fœ¡_’Œy_Ü_nuÎ
(&
fs_šfo
->
Œªs_li¡
,

897 
bŒfs_Œª§ùiÚ
,

898 
li¡
);

899 ià(!
comm™
 || comm™->
Œªsid
 >ransid) {

900 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

903 
	`»fcouÁ_šc
(&
comm™
->
u£_couÁ
);

904 
put
 = 
Œue
;

905 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

907 
	}
}

909 
	$bŒfs_wa™_fÜ_comm™
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
Œªsid
)

911 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
NULL
, *
t
;

912 
»t
 = 0;

914 ià(
Œªsid
) {

915 ià(
Œªsid
 <ğ
fs_šfo
->
Ï¡_Œªs_comm™‹d
)

916 
out
;

919 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

920 
	`li¡_fÜ_—ch_’Œy
(
t
, &
fs_šfo
->
Œªs_li¡
, 
li¡
) {

921 ià(
t
->
Œªsid
 ==ransid) {

922 
cur_Œªs
 = 
t
;

923 
	`»fcouÁ_šc
(&
cur_Œªs
->
u£_couÁ
);

924 
»t
 = 0;

927 ià(
t
->
Œªsid
 >ransid) {

928 
»t
 = 0;

932 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

938 ià(!
cur_Œªs
) {

939 ià(
Œªsid
 > 
fs_šfo
->
Ï¡_Œªs_comm™‹d
)

940 
»t
 = -
EINVAL
;

941 
out
;

945 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

946 
	`li¡_fÜ_—ch_’Œy_»v”£
(
t
, &
fs_šfo
->
Œªs_li¡
,

947 
li¡
) {

948 ià(
t
->
¡©e
 >ğ
TRANS_STATE_COMMIT_START
) {

949 ià(
t
->
¡©e
 =ğ
TRANS_STATE_COMPLETED
)

951 
cur_Œªs
 = 
t
;

952 
	`»fcouÁ_šc
(&
cur_Œªs
->
u£_couÁ
);

956 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

957 ià(!
cur_Œªs
)

958 
out
;

961 
	`wa™_fÜ_comm™
(
cur_Œªs
, 
TRANS_STATE_COMPLETED
);

962 
»t
 = 
cur_Œªs
->
abÜ‹d
;

963 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

964 
out
:

965  
»t
;

966 
	}
}

968 
	$bŒfs_thrÙe
(
bŒfs_fs_šfo
 *
fs_šfo
)

970 
	`wa™_cu¼’t_Œªs
(
fs_šfo
);

971 
	}
}

973 
boŞ
 
	$bŒfs_should_’d_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
)

975 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

977 ià(
cur_Œªs
->
¡©e
 >ğ
TRANS_STATE_COMMIT_START
 ||

978 
	`‹¡_b™
(
BTRFS_DELAYED_REFS_FLUSHING
, &
cur_Œªs
->
d–ayed_»fs
.
æags
))

979  
Œue
;

981 ià(
	`bŒfs_check_¥aû_fÜ_d–ayed_»fs
(
Œªs
->
fs_šfo
))

982  
Œue
;

984  !!
	`bŒfs_block_rsv_check
(&
Œªs
->
fs_šfo
->
glob®_block_rsv
, 50);

985 
	}
}

987 
	$bŒfs_Œªs_»Ëa£_m‘ad©a
(
bŒfs_Œªs_hªdË
 *
Œªs
)

990 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

992 ià(!
Œªs
->
block_rsv
) {

993 
	`ASSERT
(!
Œªs
->
by‹s_»£rved
);

997 ià(!
Œªs
->
by‹s_»£rved
)

1000 
	`ASSERT
(
Œªs
->
block_rsv
 =ğ&
fs_šfo
->
Œªs_block_rsv
);

1001 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "transaction",

1002 
Œªs
->
Œªsid
,¿ns->
by‹s_»£rved
, 0);

1003 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
Œªs
->
block_rsv
,

1004 
Œªs
->
by‹s_»£rved
, 
NULL
);

1005 
Œªs
->
by‹s_»£rved
 = 0;

1006 
	}
}

1008 
	$__bŒfs_’d_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1009 
thrÙe
)

1011 
bŒfs_fs_šfo
 *
šfo
 = 
Œªs
->
fs_šfo
;

1012 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

1013 
”r
 = 0;

1015 ià(
	`»fcouÁ_»ad
(&
Œªs
->
u£_couÁ
) > 1) {

1016 
	`»fcouÁ_dec
(&
Œªs
->
u£_couÁ
);

1017 
Œªs
->
block_rsv
 =¿ns->
Üig_rsv
;

1021 
	`bŒfs_Œªs_»Ëa£_m‘ad©a
(
Œªs
);

1022 
Œªs
->
block_rsv
 = 
NULL
;

1024 
	`bŒfs_ü—‹_³ndšg_block_groups
(
Œªs
);

1026 
	`bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
Œªs
);

1028 ià(
Œªs
->
ty³
 & 
__TRANS_FREEZABLE
)

1029 
	`sb_’d_štwr™e
(
šfo
->
sb
);

1031 
	`WARN_ON
(
cur_Œªs
 !ğ
šfo
->
ruÂšg_Œª§ùiÚ
);

1032 
	`WARN_ON
(
	`©omic_»ad
(&
cur_Œªs
->
num_wr™”s
) < 1);

1033 
	`©omic_dec
(&
cur_Œªs
->
num_wr™”s
);

1034 
	`extwr™”_couÁ”_dec
(
cur_Œªs
, 
Œªs
->
ty³
);

1036 
	`cÚd_wake_up
(&
cur_Œªs
->
wr™”_wa™
);

1038 
	`bŒfs_lockd•_»Ëa£
(
šfo
, 
bŒfs_Œªs_num_extwr™”s
);

1039 
	`bŒfs_lockd•_»Ëa£
(
šfo
, 
bŒfs_Œªs_num_wr™”s
);

1041 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

1043 ià(
cu¼’t
->
jouº®_šfo
 =ğ
Œªs
)

1044 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

1046 ià(
thrÙe
)

1047 
	`bŒfs_run_d–ayed_uts
(
šfo
);

1049 ià(
	`TRANS_ABORTED
(
Œªs
è|| 
	`BTRFS_FS_ERROR
(
šfo
)) {

1050 
	`wake_up_´oûss
(
šfo
->
Œª§ùiÚ_kth»ad
);

1051 ià(
	`TRANS_ABORTED
(
Œªs
))

1052 
”r
 = 
Œªs
->
abÜ‹d
;

1054 
”r
 = -
EROFS
;

1057 
	`kmem_ÿche_ä“
(
bŒfs_Œªs_hªdË_ÿch•
, 
Œªs
);

1058  
”r
;

1059 
	}
}

1061 
	$bŒfs_’d_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
)

1063  
	`__bŒfs_’d_Œª§ùiÚ
(
Œªs
, 0);

1064 
	}
}

1066 
	$bŒfs_’d_Œª§ùiÚ_thrÙe
(
bŒfs_Œªs_hªdË
 *
Œªs
)

1068  
	`__bŒfs_’d_Œª§ùiÚ
(
Œªs
, 1);

1069 
	}
}

1076 
	$bŒfs_wr™e_m¬ked_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
,

1077 
ex‹Á_io_Œ“
 *
dœty_·ges
, 
m¬k
)

1079 
”r
 = 0;

1080 
w”r
 = 0;

1081 
add»ss_¥aû
 *
m­pšg
 = 
fs_šfo
->
bŒ“_šode
->
i_m­pšg
;

1082 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

1083 
u64
 
¡¬t
 = 0;

1084 
u64
 
’d
;

1086 
	`fšd_fœ¡_ex‹Á_b™
(
dœty_·ges
, 
¡¬t
, &¡¬t, &
’d
,

1087 
m¬k
, &
ÿched_¡©e
)) {

1088 
boŞ
 
wa™_wr™eback
 = 
çl£
;

1090 
”r
 = 
	`cÚv”t_ex‹Á_b™
(
dœty_·ges
, 
¡¬t
, 
’d
,

1091 
EXTENT_NEED_WAIT
,

1092 
m¬k
, &
ÿched_¡©e
);

1106 ià(
”r
 =ğ-
ENOMEM
) {

1107 
”r
 = 0;

1108 
wa™_wr™eback
 = 
Œue
;

1110 ià(!
”r
)

1111 
”r
 = 
	`fem­_fd©awr™e_¿nge
(
m­pšg
, 
¡¬t
, 
’d
);

1112 ià(
”r
)

1113 
w”r
 = 
”r
;

1114 ià(
wa™_wr™eback
)

1115 
w”r
 = 
	`fem­_fd©awa™_¿nge
(
m­pšg
, 
¡¬t
, 
’d
);

1116 
	`ä“_ex‹Á_¡©e
(
ÿched_¡©e
);

1117 
ÿched_¡©e
 = 
NULL
;

1118 
	`cÚd_»sched
();

1119 
¡¬t
 = 
’d
 + 1;

1121  
w”r
;

1122 
	}
}

1130 
	$__bŒfs_wa™_m¬ked_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
,

1131 
ex‹Á_io_Œ“
 *
dœty_·ges
)

1133 
”r
 = 0;

1134 
w”r
 = 0;

1135 
add»ss_¥aû
 *
m­pšg
 = 
fs_šfo
->
bŒ“_šode
->
i_m­pšg
;

1136 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

1137 
u64
 
¡¬t
 = 0;

1138 
u64
 
’d
;

1140 
	`fšd_fœ¡_ex‹Á_b™
(
dœty_·ges
, 
¡¬t
, &¡¬t, &
’d
,

1141 
EXTENT_NEED_WAIT
, &
ÿched_¡©e
)) {

1150 
”r
 = 
	`ş—r_ex‹Á_b™
(
dœty_·ges
, 
¡¬t
, 
’d
,

1151 
EXTENT_NEED_WAIT
, &
ÿched_¡©e
);

1152 ià(
”r
 =ğ-
ENOMEM
)

1153 
”r
 = 0;

1154 ià(!
”r
)

1155 
”r
 = 
	`fem­_fd©awa™_¿nge
(
m­pšg
, 
¡¬t
, 
’d
);

1156 ià(
”r
)

1157 
w”r
 = 
”r
;

1158 
	`ä“_ex‹Á_¡©e
(
ÿched_¡©e
);

1159 
ÿched_¡©e
 = 
NULL
;

1160 
	`cÚd_»sched
();

1161 
¡¬t
 = 
’d
 + 1;

1163 ià(
”r
)

1164 
w”r
 = 
”r
;

1165  
w”r
;

1166 
	}
}

1168 
	$bŒfs_wa™_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
,

1169 
ex‹Á_io_Œ“
 *
dœty_·ges
)

1171 
boŞ
 
”rÜs
 = 
çl£
;

1172 
”r
;

1174 
”r
 = 
	`__bŒfs_wa™_m¬ked_ex‹Ás
(
fs_šfo
, 
dœty_·ges
);

1175 ià(
	`‹¡_ªd_ş—r_b™
(
BTRFS_FS_BTREE_ERR
, &
fs_šfo
->
æags
))

1176 
”rÜs
 = 
Œue
;

1178 ià(
”rÜs
 && !
”r
)

1179 
”r
 = -
EIO
;

1180  
”r
;

1181 
	}
}

1183 
	$bŒfs_wa™_Œ“_log_ex‹Ás
(
bŒfs_roÙ
 *
log_roÙ
, 
m¬k
)

1185 
bŒfs_fs_šfo
 *
fs_šfo
 = 
log_roÙ
->fs_info;

1186 
ex‹Á_io_Œ“
 *
dœty_·ges
 = &
log_roÙ
->
dœty_log_·ges
;

1187 
boŞ
 
”rÜs
 = 
çl£
;

1188 
”r
;

1190 
	`ASSERT
(
log_roÙ
->
roÙ_key
.
objeùid
 =ğ
BTRFS_TREE_LOG_OBJECTID
);

1192 
”r
 = 
	`__bŒfs_wa™_m¬ked_ex‹Ás
(
fs_šfo
, 
dœty_·ges
);

1193 ià((
m¬k
 & 
EXTENT_DIRTY
) &&

1194 
	`‹¡_ªd_ş—r_b™
(
BTRFS_FS_LOG1_ERR
, &
fs_šfo
->
æags
))

1195 
”rÜs
 = 
Œue
;

1197 ià((
m¬k
 & 
EXTENT_NEW
) &&

1198 
	`‹¡_ªd_ş—r_b™
(
BTRFS_FS_LOG2_ERR
, &
fs_šfo
->
æags
))

1199 
”rÜs
 = 
Œue
;

1201 ià(
”rÜs
 && !
”r
)

1202 
”r
 = -
EIO
;

1203  
”r
;

1204 
	}
}

1213 
	$bŒfs_wr™e_ªd_wa™_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
)

1215 
»t
;

1216 
»t2
;

1217 
ex‹Á_io_Œ“
 *
dœty_·ges
 = &
Œªs
->
Œª§ùiÚ
->dirty_pages;

1218 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1219 
blk_¶ug
 
¶ug
;

1221 
	`blk_¡¬t_¶ug
(&
¶ug
);

1222 
»t
 = 
	`bŒfs_wr™e_m¬ked_ex‹Ás
(
fs_šfo
, 
dœty_·ges
, 
EXTENT_DIRTY
);

1223 
	`blk_fšish_¶ug
(&
¶ug
);

1224 
»t2
 = 
	`bŒfs_wa™_ex‹Ás
(
fs_šfo
, 
dœty_·ges
);

1226 
	`ex‹Á_io_Œ“_»Ëa£
(&
Œªs
->
Œª§ùiÚ
->
dœty_·ges
);

1228 ià(
»t
)

1229  
»t
;

1230 ià(
»t2
)

1231  
»t2
;

1234 
	}
}

1246 
	$upd©e_cowÚly_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1247 
bŒfs_roÙ
 *
roÙ
)

1249 
»t
;

1250 
u64
 
Şd_roÙ_by‹Ä
;

1251 
u64
 
Şd_roÙ_u£d
;

1252 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1253 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

1255 
Şd_roÙ_u£d
 = 
	`bŒfs_roÙ_u£d
(&
roÙ
->
roÙ_™em
);

1258 
Şd_roÙ_by‹Ä
 = 
	`bŒfs_roÙ_by‹Ä
(&
roÙ
->
roÙ_™em
);

1259 ià(
Şd_roÙ_by‹Ä
 =ğ
roÙ
->
node
->
¡¬t
 &&

1260 
Şd_roÙ_u£d
 =ğ
	`bŒfs_roÙ_u£d
(&
roÙ
->
roÙ_™em
))

1263 
	`bŒfs_£t_roÙ_node
(&
roÙ
->
roÙ_™em
,„oÙ->
node
);

1264 
»t
 = 
	`bŒfs_upd©e_roÙ
(
Œªs
, 
Œ“_roÙ
,

1265 &
roÙ
->
roÙ_key
,

1266 &
roÙ
->
roÙ_™em
);

1267 ià(
»t
)

1268  
»t
;

1270 
Şd_roÙ_u£d
 = 
	`bŒfs_roÙ_u£d
(&
roÙ
->
roÙ_™em
);

1274 
	}
}

1283 
nošlše
 
	$comm™_cowÚly_roÙs
(
bŒfs_Œªs_hªdË
 *
Œªs
)

1285 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1286 
li¡_h—d
 *
dœty_bgs
 = &
Œªs
->
Œª§ùiÚ
->dirty_bgs;

1287 
li¡_h—d
 *
io_bgs
 = &
Œªs
->
Œª§ùiÚ
->io_bgs;

1288 
li¡_h—d
 *
Ãxt
;

1289 
ex‹Á_bufãr
 *
eb
;

1290 
»t
;

1296 
	`ASSERT
(
Œªs
->
Œª§ùiÚ
->
¡©e
 =ğ
TRANS_STATE_COMMIT_DOING
);

1298 
eb
 = 
	`bŒfs_lock_roÙ_node
(
fs_šfo
->
Œ“_roÙ
);

1299 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
, 
eb
, 
NULL
,

1300 0, &
eb
, 
BTRFS_NESTING_COW
);

1301 
	`bŒfs_Œ“_uÆock
(
eb
);

1302 
	`ä“_ex‹Á_bufãr
(
eb
);

1304 ià(
»t
)

1305  
»t
;

1307 
»t
 = 
	`bŒfs_run_dev_¡©s
(
Œªs
);

1308 ià(
»t
)

1309  
»t
;

1310 
»t
 = 
	`bŒfs_run_dev_»¶aû
(
Œªs
);

1311 ià(
»t
)

1312  
»t
;

1313 
»t
 = 
	`bŒfs_run_qgroups
(
Œªs
);

1314 ià(
»t
)

1315  
»t
;

1317 
»t
 = 
	`bŒfs_£tup_¥aû_ÿche
(
Œªs
);

1318 ià(
»t
)

1319  
»t
;

1321 
agaš
:

1322 !
	`li¡_em±y
(&
fs_šfo
->
dœty_cowÚly_roÙs
)) {

1323 
bŒfs_roÙ
 *
roÙ
;

1324 
Ãxt
 = 
fs_šfo
->
dœty_cowÚly_roÙs
.next;

1325 
	`li¡_d–_š™
(
Ãxt
);

1326 
roÙ
 = 
	`li¡_’Œy
(
Ãxt
, 
bŒfs_roÙ
, 
dœty_li¡
);

1327 
	`ş—r_b™
(
BTRFS_ROOT_DIRTY
, &
roÙ
->
¡©e
);

1329 
	`li¡_add_
(&
roÙ
->
dœty_li¡
,

1330 &
Œªs
->
Œª§ùiÚ
->
sw™ch_comm™s
);

1331 
»t
 = 
	`upd©e_cowÚly_roÙ
(
Œªs
, 
roÙ
);

1332 ià(
»t
)

1333  
»t
;

1337 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, ()-1);

1338 ià(
»t
)

1339  
»t
;

1341 !
	`li¡_em±y
(
dœty_bgs
è|| !li¡_em±y(
io_bgs
)) {

1342 
»t
 = 
	`bŒfs_wr™e_dœty_block_groups
(
Œªs
);

1343 ià(
»t
)

1344  
»t
;

1352 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, ()-1);

1353 ià(
»t
)

1354  
»t
;

1357 ià(!
	`li¡_em±y
(&
fs_šfo
->
dœty_cowÚly_roÙs
))

1358 
agaš
;

1361 
fs_šfo
->
dev_»¶aû
.
comm™‹d_cursÜ_Ëá
 =

1362 
fs_šfo
->
dev_»¶aû
.
cursÜ_Ëá_Ï¡_wr™e_of_™em
;

1365 
	}
}

1371 
	$bŒfs_maybe_wake_unfšished_drİ
(
bŒfs_fs_šfo
 *
fs_šfo
)

1378 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

1379 ià(!
	`li¡_em±y
(&
fs_šfo
->
d—d_roÙs
)) {

1380 
bŒfs_roÙ
 *
roÙ
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
d—d_roÙs
,

1381 
bŒfs_roÙ
,

1382 
roÙ_li¡
);

1383 ià(
	`‹¡_b™
(
BTRFS_ROOT_UNFINISHED_DROP
, &
roÙ
->
¡©e
)) {

1384 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1388 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1390 
	`bŒfs_wake_unfšished_drİ
(
fs_šfo
);

1391 
	}
}

1398 
	$bŒfs_add_d—d_roÙ
(
bŒfs_roÙ
 *
roÙ
)

1400 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1402 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

1403 ià(
	`li¡_em±y
(&
roÙ
->
roÙ_li¡
)) {

1404 
	`bŒfs_g¿b_roÙ
(
roÙ
);

1407 ià(
	`‹¡_b™
(
BTRFS_ROOT_UNFINISHED_DROP
, &
roÙ
->
¡©e
))

1408 
	`li¡_add
(&
roÙ
->
roÙ_li¡
, &
fs_šfo
->
d—d_roÙs
);

1410 
	`li¡_add_
(&
roÙ
->
roÙ_li¡
, &
fs_šfo
->
d—d_roÙs
);

1412 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1413 
	}
}

1419 
nošlše
 
	$comm™_fs_roÙs
(
bŒfs_Œªs_hªdË
 *
Œªs
)

1421 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1422 
bŒfs_roÙ
 *
gªg
[8];

1423 
i
;

1424 
»t
;

1430 
	`ASSERT
(
Œªs
->
Œª§ùiÚ
->
¡©e
 =ğ
TRANS_STATE_COMMIT_DOING
);

1432 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

1434 
»t
 = 
	`¿dix_Œ“_gªg_lookup_g
(&
fs_šfo
->
fs_roÙs_¿dix
,

1435 (**)
gªg
, 0,

1436 
	`ARRAY_SIZE
(
gªg
),

1437 
BTRFS_ROOT_TRANS_TAG
);

1438 ià(
»t
 == 0)

1440 
i
 = 0; i < 
»t
; i++) {

1441 
bŒfs_roÙ
 *
roÙ
 = 
gªg
[
i
];

1442 
»t2
;

1448 
	`ASSERT
(
	`©omic_»ad
(&
roÙ
->
log_wr™”s
) == 0);

1449 
	`ASSERT
(
	`©omic_»ad
(&
roÙ
->
log_comm™
[0]) == 0);

1450 
	`ASSERT
(
	`©omic_»ad
(&
roÙ
->
log_comm™
[1]) == 0);

1452 
	`¿dix_Œ“_g_ş—r
(&
fs_šfo
->
fs_roÙs_¿dix
,

1453 ()
roÙ
->
roÙ_key
.
objeùid
,

1454 
BTRFS_ROOT_TRANS_TAG
);

1455 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

1457 
	`bŒfs_ä“_log
(
Œªs
, 
roÙ
);

1458 
»t2
 = 
	`bŒfs_upd©e_»loc_roÙ
(
Œªs
, 
roÙ
);

1459 ià(
»t2
)

1460  
»t2
;

1463 
	`ş—r_b™
(
BTRFS_ROOT_FORCE_COW
, &
roÙ
->
¡©e
);

1464 
	`smp_mb__aá”_©omic
();

1466 ià(
roÙ
->
comm™_roÙ
 !ğroÙ->
node
) {

1467 
	`li¡_add_
(&
roÙ
->
dœty_li¡
,

1468 &
Œªs
->
Œª§ùiÚ
->
sw™ch_comm™s
);

1469 
	`bŒfs_£t_roÙ_node
(&
roÙ
->
roÙ_™em
,

1470 
roÙ
->
node
);

1473 
»t2
 = 
	`bŒfs_upd©e_roÙ
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
,

1474 &
roÙ
->
roÙ_key
,

1475 &
roÙ
->
roÙ_™em
);

1476 ià(
»t2
)

1477  
»t2
;

1478 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

1479 
	`bŒfs_qgroup_ä“_m‘a_®l_³¹¿ns
(
roÙ
);

1482 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

1484 
	}
}

1490 
	$bŒfs_deäag_roÙ
(
bŒfs_roÙ
 *
roÙ
)

1492 
bŒfs_fs_šfo
 *
šfo
 = 
roÙ
->
fs_šfo
;

1493 
bŒfs_Œªs_hªdË
 *
Œªs
;

1494 
»t
;

1496 ià(
	`‹¡_ªd_£t_b™
(
BTRFS_ROOT_DEFRAG_RUNNING
, &
roÙ
->
¡©e
))

1500 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

1501 ià(
	`IS_ERR
(
Œªs
)) {

1502 
»t
 = 
	`PTR_ERR
(
Œªs
);

1506 
»t
 = 
	`bŒfs_deäag_Ëaves
(
Œªs
, 
roÙ
);

1508 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1509 
	`bŒfs_bŒ“_b®ªû_dœty
(
šfo
);

1510 
	`cÚd_»sched
();

1512 ià(
	`bŒfs_fs_şosšg
(
šfo
è|| 
»t
 !ğ-
EAGAIN
)

1515 ià(
	`bŒfs_deäag_ÿnûÎed
(
šfo
)) {

1516 
	`bŒfs_debug
(
šfo
, "defrag_root cancelled");

1517 
»t
 = -
EAGAIN
;

1521 
	`ş—r_b™
(
BTRFS_ROOT_DEFRAG_RUNNING
, &
roÙ
->
¡©e
);

1522  
»t
;

1523 
	}
}

1532 
	$qgroup_accouÁ_¢­shÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1533 
bŒfs_roÙ
 *
¤c
,

1534 
bŒfs_roÙ
 *
·»Á
,

1535 
bŒfs_qgroup_šh”™
 *
šh”™
,

1536 
u64
 
d¡_objeùid
)

1538 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¤c
->fs_info;

1539 
»t
;

1546 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

1555 
»t
 = 
	`»cÜd_roÙ_š_Œªs
(
Œªs
, 
¤c
, 1);

1556 ià(
»t
)

1557  
»t
;

1570 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, ()-1);

1571 ià(
»t
) {

1572 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1573  
»t
;

1576 
»t
 = 
	`comm™_fs_roÙs
(
Œªs
);

1577 ià(
»t
)

1578 
out
;

1579 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Ás
(
Œªs
);

1580 ià(
»t
 < 0)

1581 
out
;

1584 
»t
 = 
	`bŒfs_qgroup_šh”™
(
Œªs
, 
¤c
->
roÙ_key
.
objeùid
, 
d¡_objeùid
,

1585 
šh”™
);

1586 ià(
»t
 < 0)

1587 
out
;

1601 
»t
 = 
	`comm™_cowÚly_roÙs
(
Œªs
);

1602 ià(
»t
)

1603 
out
;

1604 
	`sw™ch_comm™_roÙs
(
Œªs
);

1605 
»t
 = 
	`bŒfs_wr™e_ªd_wa™_Œª§ùiÚ
(
Œªs
);

1606 ià(
»t
)

1607 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

1610 
out
:

1617 ià(!
»t
)

1618 
»t
 = 
	`»cÜd_roÙ_š_Œªs
(
Œªs
, 
·»Á
, 1);

1619  
»t
;

1620 
	}
}

1631 
nošlše
 
	$ü—‹_³ndšg_¢­shÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1632 
bŒfs_³ndšg_¢­shÙ
 *
³ndšg
)

1635 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1636 
bŒfs_key
 
key
;

1637 
bŒfs_roÙ_™em
 *
Ãw_roÙ_™em
;

1638 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

1639 
bŒfs_roÙ
 *
roÙ
 = 
³ndšg
->root;

1640 
bŒfs_roÙ
 *
·»Á_roÙ
;

1641 
bŒfs_block_rsv
 *
rsv
;

1642 
šode
 *
·»Á_šode
 = 
³ndšg
->
dœ
;

1643 
bŒfs_·th
 *
·th
;

1644 
bŒfs_dœ_™em
 *
dœ_™em
;

1645 
ex‹Á_bufãr
 *
tmp
;

1646 
ex‹Á_bufãr
 *
Şd
;

1647 
time¥ec64
 
cur_time
;

1648 
»t
 = 0;

1649 
u64
 
to_»£rve
 = 0;

1650 
u64
 
šdex
 = 0;

1651 
u64
 
objeùid
;

1652 
u64
 
roÙ_æags
;

1653 
nofs_æags
;

1654 
fsüy±_Çme
 
âame
;

1656 
	`ASSERT
(
³ndšg
->
·th
);

1657 
·th
 = 
³ndšg
->path;

1659 
	`ASSERT
(
³ndšg
->
roÙ_™em
);

1660 
Ãw_roÙ_™em
 = 
³ndšg
->
roÙ_™em
;

1667 
nofs_æags
 = 
	`mem®loc_nofs_§ve
();

1668 
³ndšg
->
”rÜ
 = 
	`fsüy±_£tup_f’ame
(
·»Á_šode
,

1669 &
³ndšg
->
d’Œy
->
d_Çme
, 0,

1670 &
âame
);

1671 
	`mem®loc_nofs_»¡Üe
(
nofs_æags
);

1672 ià(
³ndšg
->
”rÜ
)

1673 
ä“_³ndšg
;

1675 
³ndšg
->
”rÜ
 = 
	`bŒfs_g‘_ä“_objeùid
(
Œ“_roÙ
, &
objeùid
);

1676 ià(
³ndšg
->
”rÜ
)

1677 
ä“_âame
;

1683 
	`bŒfs_£t_sk_qgroup
(
Œªs
, 
objeùid
);

1685 
	`bŒfs_»loc_´e_¢­shÙ
(
³ndšg
, &
to_»£rve
);

1687 ià(
to_»£rve
 > 0) {

1688 
³ndšg
->
”rÜ
 = 
	`bŒfs_block_rsv_add
(
fs_šfo
,

1689 &
³ndšg
->
block_rsv
,

1690 
to_»£rve
,

1691 
BTRFS_RESERVE_NO_FLUSH
);

1692 ià(
³ndšg
->
”rÜ
)

1693 
ş—r_sk_qgroup
;

1696 
key
.
objeùid
 = objectid;

1697 
key
.
off£t
 = (
u64
)-1;

1698 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

1700 
rsv
 = 
Œªs
->
block_rsv
;

1701 
Œªs
->
block_rsv
 = &
³ndšg
->block_rsv;

1702 
Œªs
->
by‹s_»£rved
 =¿ns->
block_rsv
->
»£rved
;

1703 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "transaction",

1704 
Œªs
->
Œªsid
,

1705 
Œªs
->
by‹s_»£rved
, 1);

1706 
·»Á_roÙ
 = 
	`BTRFS_I
(
·»Á_šode
)->
roÙ
;

1707 
»t
 = 
	`»cÜd_roÙ_š_Œªs
(
Œªs
, 
·»Á_roÙ
, 0);

1708 ià(
»t
)

1709 
ç
;

1710 
cur_time
 = 
	`cu¼’t_time
(
·»Á_šode
);

1715 
»t
 = 
	`bŒfs_£t_šode_šdex
(
	`BTRFS_I
(
·»Á_šode
), &
šdex
);

1716 ià(
»t
) {

1717 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1718 
ç
;

1722 
dœ_™em
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
·»Á_roÙ
, 
·th
,

1723 
	`bŒfs_šo
(
	`BTRFS_I
(
·»Á_šode
)),

1724 &
âame
.
disk_Çme
, 0);

1725 ià(
dœ_™em
 !ğ
NULL
 && !
	`IS_ERR
(dir_item)) {

1726 
³ndšg
->
”rÜ
 = -
EEXIST
;

1727 
dœ_™em_exi¡ed
;

1728 } ià(
	`IS_ERR
(
dœ_™em
)) {

1729 
»t
 = 
	`PTR_ERR
(
dœ_™em
);

1730 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1731 
ç
;

1733 
	`bŒfs_»Ëa£_·th
(
·th
);

1741 
»t
 = 
	`bŒfs_run_d–ayed_™ems
(
Œªs
);

1742 ià(
»t
) {

1743 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1744 
ç
;

1747 
»t
 = 
	`»cÜd_roÙ_š_Œªs
(
Œªs
, 
roÙ
, 0);

1748 ià(
»t
) {

1749 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1750 
ç
;

1752 
	`bŒfs_£t_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
, 
Œªs
->
Œªsid
);

1753 
	`memıy
(
Ãw_roÙ_™em
, &
roÙ
->
roÙ_™em
, (*new_root_item));

1754 
	`bŒfs_check_ªd_š™_roÙ_™em
(
Ãw_roÙ_™em
);

1756 
roÙ_æags
 = 
	`bŒfs_roÙ_æags
(
Ãw_roÙ_™em
);

1757 ià(
³ndšg
->
»adÚly
)

1758 
roÙ_æags
 |ğ
BTRFS_ROOT_SUBVOL_RDONLY
;

1760 
roÙ_æags
 &ğ~
BTRFS_ROOT_SUBVOL_RDONLY
;

1761 
	`bŒfs_£t_roÙ_æags
(
Ãw_roÙ_™em
, 
roÙ_æags
);

1763 
	`bŒfs_£t_roÙ_g’”©iÚ_v2
(
Ãw_roÙ_™em
,

1764 
Œªs
->
Œªsid
);

1765 
	`g’”©e_¿ndom_guid
(
Ãw_roÙ_™em
->
uuid
);

1766 
	`memıy
(
Ãw_roÙ_™em
->
·»Á_uuid
, 
roÙ
->
roÙ_™em
.
uuid
,

1767 
BTRFS_UUID_SIZE
);

1768 ià(!(
roÙ_æags
 & 
BTRFS_ROOT_SUBVOL_RDONLY
)) {

1769 
	`mem£t
(
Ãw_roÙ_™em
->
»ûived_uuid
, 0,

1770 (
Ãw_roÙ_™em
->
»ûived_uuid
));

1771 
	`mem£t
(&
Ãw_roÙ_™em
->
¡ime
, 0, (new_root_item->stime));

1772 
	`mem£t
(&
Ãw_roÙ_™em
->
¹ime
, 0, (new_root_item->rtime));

1773 
	`bŒfs_£t_roÙ_¡¿nsid
(
Ãw_roÙ_™em
, 0);

1774 
	`bŒfs_£t_roÙ_¹¿nsid
(
Ãw_roÙ_™em
, 0);

1776 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
Ãw_roÙ_™em
->
Ùime
, 
cur_time
.
tv_£c
);

1777 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
Ãw_roÙ_™em
->
Ùime
, 
cur_time
.
tv_n£c
);

1778 
	`bŒfs_£t_roÙ_Ù¿nsid
(
Ãw_roÙ_™em
, 
Œªs
->
Œªsid
);

1780 
Şd
 = 
	`bŒfs_lock_roÙ_node
(
roÙ
);

1781 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
Şd
, 
NULL
, 0, &old,

1782 
BTRFS_NESTING_COW
);

1783 ià(
»t
) {

1784 
	`bŒfs_Œ“_uÆock
(
Şd
);

1785 
	`ä“_ex‹Á_bufãr
(
Şd
);

1786 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1787 
ç
;

1790 
»t
 = 
	`bŒfs_cİy_roÙ
(
Œªs
, 
roÙ
, 
Şd
, &
tmp
, 
objeùid
);

1792 
	`bŒfs_Œ“_uÆock
(
Şd
);

1793 
	`ä“_ex‹Á_bufãr
(
Şd
);

1794 ià(
»t
) {

1795 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1796 
ç
;

1799 
	`£t_b™
(
BTRFS_ROOT_FORCE_COW
, &
roÙ
->
¡©e
);

1800 
	`smp_wmb
();

1802 
	`bŒfs_£t_roÙ_node
(
Ãw_roÙ_™em
, 
tmp
);

1804 
key
.
off£t
 = 
Œªs
->
Œªsid
;

1805 
»t
 = 
	`bŒfs_š£¹_roÙ
(
Œªs
, 
Œ“_roÙ
, &
key
, 
Ãw_roÙ_™em
);

1806 
	`bŒfs_Œ“_uÆock
(
tmp
);

1807 
	`ä“_ex‹Á_bufãr
(
tmp
);

1808 ià(
»t
) {

1809 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1810 
ç
;

1816 
»t
 = 
	`bŒfs_add_roÙ_»f
(
Œªs
, 
objeùid
,

1817 
·»Á_roÙ
->
roÙ_key
.
objeùid
,

1818 
	`bŒfs_šo
(
	`BTRFS_I
(
·»Á_šode
)), 
šdex
,

1819 &
âame
.
disk_Çme
);

1820 ià(
»t
) {

1821 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1822 
ç
;

1825 
key
.
off£t
 = (
u64
)-1;

1826 
³ndšg
->
¢­
 = 
	`bŒfs_g‘_Ãw_fs_roÙ
(
fs_šfo
, 
objeùid
,…’dšg->
ªÚ_dev
);

1827 ià(
	`IS_ERR
(
³ndšg
->
¢­
)) {

1828 
»t
 = 
	`PTR_ERR
(
³ndšg
->
¢­
);

1829 
³ndšg
->
¢­
 = 
NULL
;

1830 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1831 
ç
;

1834 
»t
 = 
	`bŒfs_»loc_po¡_¢­shÙ
(
Œªs
, 
³ndšg
);

1835 ià(
»t
) {

1836 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1837 
ç
;

1846 
»t
 = 
	`qgroup_accouÁ_¢­shÙ
(
Œªs
, 
roÙ
, 
·»Á_roÙ
,

1847 
³ndšg
->
šh”™
, 
objeùid
);

1848 ià(
»t
 < 0)

1849 
ç
;

1851 
»t
 = 
	`bŒfs_š£¹_dœ_™em
(
Œªs
, &
âame
.
disk_Çme
,

1852 
	`BTRFS_I
(
·»Á_šode
), &
key
, 
BTRFS_FT_DIR
,

1853 
šdex
);

1855 
	`BUG_ON
(
»t
 =ğ-
EEXIST
 ||„‘ =ğ-
EOVERFLOW
);

1856 ià(
»t
) {

1857 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1858 
ç
;

1861 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
·»Á_šode
),…¬’t_šode->
i_size
 +

1862 
âame
.
disk_Çme
.
Ën
 * 2);

1863 
·»Á_šode
->
i_mtime
 = 
	`šode_£t_ùime_cu¼’t
(parent_inode);

1864 
»t
 = 
	`bŒfs_upd©e_šode_çÎback
(
Œªs
, 
·»Á_roÙ
, 
	`BTRFS_I
(
·»Á_šode
));

1865 ià(
»t
) {

1866 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1867 
ç
;

1869 
»t
 = 
	`bŒfs_uuid_Œ“_add
(
Œªs
, 
Ãw_roÙ_™em
->
uuid
,

1870 
BTRFS_UUID_KEY_SUBVOL
,

1871 
objeùid
);

1872 ià(
»t
) {

1873 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1874 
ç
;

1876 ià(!
	`bŒfs_is_em±y_uuid
(
Ãw_roÙ_™em
->
»ûived_uuid
)) {

1877 
»t
 = 
	`bŒfs_uuid_Œ“_add
(
Œªs
, 
Ãw_roÙ_™em
->
»ûived_uuid
,

1878 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
,

1879 
objeùid
);

1880 ià(
»t
 &&„‘ !ğ-
EEXIST
) {

1881 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1882 
ç
;

1886 
ç
:

1887 
³ndšg
->
”rÜ
 = 
»t
;

1888 
dœ_™em_exi¡ed
:

1889 
Œªs
->
block_rsv
 = 
rsv
;

1890 
Œªs
->
by‹s_»£rved
 = 0;

1891 
ş—r_sk_qgroup
:

1892 
	`bŒfs_ş—r_sk_qgroup
(
Œªs
);

1893 
ä“_âame
:

1894 
	`fsüy±_ä“_f’ame
(&
âame
);

1895 
ä“_³ndšg
:

1896 
	`kä“
(
Ãw_roÙ_™em
);

1897 
³ndšg
->
roÙ_™em
 = 
NULL
;

1898 
	`bŒfs_ä“_·th
(
·th
);

1899 
³ndšg
->
·th
 = 
NULL
;

1901  
»t
;

1902 
	}
}

1907 
nošlše
 
	$ü—‹_³ndšg_¢­shÙs
(
bŒfs_Œªs_hªdË
 *
Œªs
)

1909 
bŒfs_³ndšg_¢­shÙ
 *
³ndšg
, *
Ãxt
;

1910 
li¡_h—d
 *
h—d
 = &
Œªs
->
Œª§ùiÚ
->
³ndšg_¢­shÙs
;

1911 
»t
 = 0;

1913 
	`li¡_fÜ_—ch_’Œy_§ã
(
³ndšg
, 
Ãxt
, 
h—d
, 
li¡
) {

1914 
	`li¡_d–
(&
³ndšg
->
li¡
);

1915 
»t
 = 
	`ü—‹_³ndšg_¢­shÙ
(
Œªs
, 
³ndšg
);

1916 ià(
»t
)

1919  
»t
;

1920 
	}
}

1922 
	$upd©e_su³r_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
)

1924 
bŒfs_roÙ_™em
 *
roÙ_™em
;

1925 
bŒfs_su³r_block
 *
su³r
;

1927 
su³r
 = 
fs_šfo
->
su³r_cİy
;

1929 
roÙ_™em
 = &
fs_šfo
->
chunk_roÙ
->root_item;

1930 
su³r
->
chunk_roÙ
 = 
roÙ_™em
->
by‹Ä
;

1931 
su³r
->
chunk_roÙ_g’”©iÚ
 = 
roÙ_™em
->
g’”©iÚ
;

1932 
su³r
->
chunk_roÙ_Ëv–
 = 
roÙ_™em
->
Ëv–
;

1934 
roÙ_™em
 = &
fs_šfo
->
Œ“_roÙ
->root_item;

1935 
su³r
->
roÙ
 = 
roÙ_™em
->
by‹Ä
;

1936 
su³r
->
g’”©iÚ
 = 
roÙ_™em
->generation;

1937 
su³r
->
roÙ_Ëv–
 = 
roÙ_™em
->
Ëv–
;

1938 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
SPACE_CACHE
))

1939 
su³r
->
ÿche_g’”©iÚ
 = 
roÙ_™em
->
g’”©iÚ
;

1940 ià(
	`‹¡_b™
(
BTRFS_FS_CLEANUP_SPACE_CACHE_V1
, &
fs_šfo
->
æags
))

1941 
su³r
->
ÿche_g’”©iÚ
 = 0;

1942 ià(
	`‹¡_b™
(
BTRFS_FS_UPDATE_UUID_TREE_GEN
, &
fs_šfo
->
æags
))

1943 
su³r
->
uuid_Œ“_g’”©iÚ
 = 
roÙ_™em
->
g’”©iÚ
;

1944 
	}
}

1946 
	$bŒfs_Œª§ùiÚ_š_comm™
(
bŒfs_fs_šfo
 *
šfo
)

1948 
bŒfs_Œª§ùiÚ
 *
Œªs
;

1949 
»t
 = 0;

1951 
	`¥š_lock
(&
šfo
->
Œªs_lock
);

1952 
Œªs
 = 
šfo
->
ruÂšg_Œª§ùiÚ
;

1953 ià(
Œªs
)

1954 
»t
 = (
Œªs
->
¡©e
 >ğ
TRANS_STATE_COMMIT_START
);

1955 
	`¥š_uÆock
(&
šfo
->
Œªs_lock
);

1956  
»t
;

1957 
	}
}

1959 
	$bŒfs_Œª§ùiÚ_blocked
(
bŒfs_fs_šfo
 *
šfo
)

1961 
bŒfs_Œª§ùiÚ
 *
Œªs
;

1962 
»t
 = 0;

1964 
	`¥š_lock
(&
šfo
->
Œªs_lock
);

1965 
Œªs
 = 
šfo
->
ruÂšg_Œª§ùiÚ
;

1966 ià(
Œªs
)

1967 
»t
 = 
	`is_Œª§ùiÚ_blocked
(
Œªs
);

1968 
	`¥š_uÆock
(&
šfo
->
Œªs_lock
);

1969  
»t
;

1970 
	}
}

1972 
	$bŒfs_comm™_Œª§ùiÚ_async
(
bŒfs_Œªs_hªdË
 *
Œªs
)

1974 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1975 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
;

1978 
	`£t_b™
(
BTRFS_FS_COMMIT_TRANS
, &
fs_šfo
->
æags
);

1979 
	`wake_up_´oûss
(
fs_šfo
->
Œª§ùiÚ_kth»ad
);

1982 
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

1983 
	`»fcouÁ_šc
(&
cur_Œªs
->
u£_couÁ
);

1985 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1991 
	`bŒfs_might_wa™_fÜ_¡©e
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_COMMIT_PREP
);

1992 
	`wa™_ev’t
(
fs_šfo
->
Œª§ùiÚ_blocked_wa™
,

1993 
cur_Œªs
->
¡©e
 >ğ
TRANS_STATE_COMMIT_START
 ||

1994 
	`TRANS_ABORTED
(
cur_Œªs
));

1995 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

1996 
	}
}

1998 
	$ş—nup_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
”r
)

2000 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2001 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

2003 
	`WARN_ON
(
	`»fcouÁ_»ad
(&
Œªs
->
u£_couÁ
) > 1);

2005 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
”r
);

2007 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

2014 
	`BUG_ON
(
	`li¡_em±y
(&
cur_Œªs
->
li¡
));

2016 ià(
cur_Œªs
 =ğ
fs_šfo
->
ruÂšg_Œª§ùiÚ
) {

2017 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_COMMIT_DOING
;

2018 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2024 
	`bŒfs_might_wa™_fÜ_ev’t
(
fs_šfo
, 
bŒfs_Œªs_num_wr™”s
);

2025 
	`wa™_ev’t
(
cur_Œªs
->
wr™”_wa™
,

2026 
	`©omic_»ad
(&
cur_Œªs
->
num_wr™”s
) == 1);

2028 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

2039 
	`li¡_d–_š™
(&
cur_Œªs
->
li¡
);

2041 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2043 
	`bŒfs_ş—nup_Úe_Œª§ùiÚ
(
Œªs
->
Œª§ùiÚ
, 
fs_šfo
);

2045 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

2046 ià(
cur_Œªs
 =ğ
fs_šfo
->
ruÂšg_Œª§ùiÚ
)

2047 
fs_šfo
->
ruÂšg_Œª§ùiÚ
 = 
NULL
;

2048 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2050 ià(
Œªs
->
ty³
 & 
__TRANS_FREEZABLE
)

2051 
	`sb_’d_štwr™e
(
fs_šfo
->
sb
);

2052 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

2053 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

2055 
	`Œaû_bŒfs_Œª§ùiÚ_comm™
(
fs_šfo
);

2057 ià(
cu¼’t
->
jouº®_šfo
 =ğ
Œªs
)

2058 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

2071 ià(!
	`‹¡_b™
(
BTRFS_FS_RELOC_RUNNING
, &
fs_šfo
->
æags
))

2072 
	`bŒfs_süub_ÿnûl
(
fs_šfo
);

2074 
	`kmem_ÿche_ä“
(
bŒfs_Œªs_hªdË_ÿch•
, 
Œªs
);

2075 
	}
}

2081 
	$bŒfs_ş—nup_³ndšg_block_groups
(
bŒfs_Œªs_hªdË
 *
Œªs
)

2083 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2084 
bŒfs_block_group
 *
block_group
, *
tmp
;

2086 
	`li¡_fÜ_—ch_’Œy_§ã
(
block_group
, 
tmp
, &
Œªs
->
Ãw_bgs
, 
bg_li¡
) {

2087 
	`bŒfs_d–ayed_»fs_rsv_»Ëa£
(
fs_šfo
, 1);

2088 
	`li¡_d–_š™
(&
block_group
->
bg_li¡
);

2090 
	}
}

2092 
šlše
 
	$bŒfs_¡¬t_d–®loc_æush
(
bŒfs_fs_šfo
 *
fs_šfo
)

2111 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
FLUSHONCOMMIT
))

2112 
	`Œy_to_wr™eback_šodes_sb
(
fs_šfo
->
sb
, 
WB_REASON_SYNC
);

2114 
	}
}

2116 
šlše
 
	$bŒfs_wa™_d–®loc_æush
(
bŒfs_fs_šfo
 *
fs_šfo
)

2118 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
FLUSHONCOMMIT
))

2119 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
U64_MAX
, 0, (
u64
)-1);

2120 
	}
}

2130 
	$add_³ndšg_¢­shÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
)

2132 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

2134 ià(!
Œªs
->
³ndšg_¢­shÙ
)

2137 
	`lockd•_as£¹_h–d
(&
Œªs
->
fs_šfo
->
Œªs_lock
);

2138 
	`ASSERT
(
cur_Œªs
->
¡©e
 >ğ
TRANS_STATE_COMMIT_PREP
);

2140 
	`li¡_add
(&
Œªs
->
³ndšg_¢­shÙ
->
li¡
, &
cur_Œªs
->
³ndšg_¢­shÙs
);

2141 
	}
}

2143 
	$upd©e_comm™_¡©s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
ktime_t
 
š‹rv®
)

2145 
fs_šfo
->
comm™_¡©s
.
comm™_couÁ
++;

2146 
fs_šfo
->
comm™_¡©s
.
Ï¡_comm™_dur
 = 
š‹rv®
;

2147 
fs_šfo
->
comm™_¡©s
.
max_comm™_dur
 =

2148 
	`max_t
(
u64
, 
fs_šfo
->
comm™_¡©s
.
max_comm™_dur
, 
š‹rv®
);

2149 
fs_šfo
->
comm™_¡©s
.
tÙ®_comm™_dur
 +ğ
š‹rv®
;

2150 
	}
}

2152 
	$bŒfs_comm™_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
)

2154 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2155 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

2156 
bŒfs_Œª§ùiÚ
 *
´ev_Œªs
 = 
NULL
;

2157 
»t
;

2158 
ktime_t
 
¡¬t_time
;

2159 
ktime_t
 
š‹rv®
;

2161 
	`ASSERT
(
	`»fcouÁ_»ad
(&
Œªs
->
u£_couÁ
) == 1);

2162 
	`bŒfs_Œªs_¡©e_lockd•_acquœe
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_COMMIT_PREP
);

2164 
	`ş—r_b™
(
BTRFS_FS_NEED_TRANS_COMMIT
, &
fs_šfo
->
æags
);

2168 ià(
	`TRANS_ABORTED
(
cur_Œªs
)) {

2169 
»t
 = 
cur_Œªs
->
abÜ‹d
;

2170 
lockd•_Œªs_comm™_¡¬t_»Ëa£
;

2173 
	`bŒfs_Œªs_»Ëa£_m‘ad©a
(
Œªs
);

2174 
Œªs
->
block_rsv
 = 
NULL
;

2180 ià(!
	`‹¡_ªd_£t_b™
(
BTRFS_DELAYED_REFS_FLUSHING
,

2181 &
cur_Œªs
->
d–ayed_»fs
.
æags
)) {

2186 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 0);

2187 ià(
»t
)

2188 
lockd•_Œªs_comm™_¡¬t_»Ëa£
;

2191 
	`bŒfs_ü—‹_³ndšg_block_groups
(
Œªs
);

2193 ià(!
	`‹¡_b™
(
BTRFS_TRANS_DIRTY_BG_RUN
, &
cur_Œªs
->
æags
)) {

2194 
run_™
 = 0;

2209 
	`mu‹x_lock
(&
fs_šfo
->
ro_block_group_mu‹x
);

2210 ià(!
	`‹¡_ªd_£t_b™
(
BTRFS_TRANS_DIRTY_BG_RUN
,

2211 &
cur_Œªs
->
æags
))

2212 
run_™
 = 1;

2213 
	`mu‹x_uÆock
(&
fs_šfo
->
ro_block_group_mu‹x
);

2215 ià(
run_™
) {

2216 
»t
 = 
	`bŒfs_¡¬t_dœty_block_groups
(
Œªs
);

2217 ià(
»t
)

2218 
lockd•_Œªs_comm™_¡¬t_»Ëa£
;

2222 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

2223 ià(
cur_Œªs
->
¡©e
 >ğ
TRANS_STATE_COMMIT_PREP
) {

2224 
bŒfs_Œªs_¡©e
 
wªt_¡©e
 = 
TRANS_STATE_COMPLETED
;

2226 
	`add_³ndšg_¢­shÙ
(
Œªs
);

2228 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2229 
	`»fcouÁ_šc
(&
cur_Œªs
->
u£_couÁ
);

2231 ià(
Œªs
->
š_fsync
)

2232 
wªt_¡©e
 = 
TRANS_STATE_SUPER_COMMITTED
;

2234 
	`bŒfs_Œªs_¡©e_lockd•_»Ëa£
(
fs_šfo
,

2235 
BTRFS_LOCKDEP_TRANS_COMMIT_PREP
);

2236 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2237 
	`wa™_fÜ_comm™
(
cur_Œªs
, 
wªt_¡©e
);

2239 ià(
	`TRANS_ABORTED
(
cur_Œªs
))

2240 
»t
 = 
cur_Œªs
->
abÜ‹d
;

2242 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

2244  
»t
;

2247 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_COMMIT_PREP
;

2248 
	`wake_up
(&
fs_šfo
->
Œª§ùiÚ_blocked_wa™
);

2249 
	`bŒfs_Œªs_¡©e_lockd•_»Ëa£
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_COMMIT_PREP
);

2251 ià(
cur_Œªs
->
li¡
.
´ev
 !ğ&
fs_šfo
->
Œªs_li¡
) {

2252 
bŒfs_Œªs_¡©e
 
wªt_¡©e
 = 
TRANS_STATE_COMPLETED
;

2254 ià(
Œªs
->
š_fsync
)

2255 
wªt_¡©e
 = 
TRANS_STATE_SUPER_COMMITTED
;

2257 
´ev_Œªs
 = 
	`li¡_’Œy
(
cur_Œªs
->
li¡
.
´ev
,

2258 
bŒfs_Œª§ùiÚ
, 
li¡
);

2259 ià(
´ev_Œªs
->
¡©e
 < 
wªt_¡©e
) {

2260 
	`»fcouÁ_šc
(&
´ev_Œªs
->
u£_couÁ
);

2261 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2263 
	`wa™_fÜ_comm™
(
´ev_Œªs
, 
wªt_¡©e
);

2265 
»t
 = 
	`READ_ONCE
(
´ev_Œªs
->
abÜ‹d
);

2267 
	`bŒfs_put_Œª§ùiÚ
(
´ev_Œªs
);

2268 ià(
»t
)

2269 
lockd•_»Ëa£
;

2270 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

2279 ià(
	`BTRFS_FS_ERROR
(
fs_šfo
)) {

2280 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2281 
»t
 = -
EROFS
;

2282 
lockd•_»Ëa£
;

2286 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_COMMIT_START
;

2287 
	`wake_up
(&
fs_šfo
->
Œª§ùiÚ_blocked_wa™
);

2288 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2294 
¡¬t_time
 = 
	`ktime_g‘_ns
();

2296 
	`extwr™”_couÁ”_dec
(
cur_Œªs
, 
Œªs
->
ty³
);

2298 
»t
 = 
	`bŒfs_¡¬t_d–®loc_æush
(
fs_šfo
);

2300 ià(
»t
)

2301 
lockd•_»Ëa£
;

2303 
»t
 = 
	`bŒfs_run_d–ayed_™ems
(
Œªs
);

2304 ià(
»t
)

2305 
lockd•_»Ëa£
;

2312 
	`bŒfs_lockd•_»Ëa£
(
fs_šfo
, 
bŒfs_Œªs_num_extwr™”s
);

2313 
	`bŒfs_might_wa™_fÜ_ev’t
(
fs_šfo
, 
bŒfs_Œªs_num_extwr™”s
);

2314 
	`wa™_ev’t
(
cur_Œªs
->
wr™”_wa™
,

2315 
	`extwr™”_couÁ”_»ad
(
cur_Œªs
) == 0);

2318 
»t
 = 
	`bŒfs_run_d–ayed_™ems
(
Œªs
);

2319 ià(
»t
) {

2320 
	`bŒfs_lockd•_»Ëa£
(
fs_šfo
, 
bŒfs_Œªs_num_wr™”s
);

2321 
ş—nup_Œª§ùiÚ
;

2324 
	`bŒfs_wa™_d–®loc_æush
(
fs_šfo
);

2332 
	`bŒfs_might_wa™_fÜ_ev’t
(
fs_šfo
, 
bŒfs_Œªs_³ndšg_Üd”ed
);

2333 
	`wa™_ev’t
(
cur_Œªs
->
³ndšg_wa™
,

2334 
	`©omic_»ad
(&
cur_Œªs
->
³ndšg_Üd”ed
) == 0);

2336 
	`bŒfs_süub_·u£
(
fs_šfo
);

2342 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

2343 
	`add_³ndšg_¢­shÙ
(
Œªs
);

2344 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_COMMIT_DOING
;

2345 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2352 
	`bŒfs_lockd•_»Ëa£
(
fs_šfo
, 
bŒfs_Œªs_num_wr™”s
);

2353 
	`bŒfs_might_wa™_fÜ_ev’t
(
fs_šfo
, 
bŒfs_Œªs_num_wr™”s
);

2354 
	`wa™_ev’t
(
cur_Œªs
->
wr™”_wa™
,

2355 
	`©omic_»ad
(&
cur_Œªs
->
num_wr™”s
) == 1);

2363 
	`bŒfs_Œªs_¡©e_lockd•_acquœe
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_COMPLETED
);

2364 
	`bŒfs_Œªs_¡©e_lockd•_acquœe
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_SUPER_COMMITTED
);

2365 
	`bŒfs_Œªs_¡©e_lockd•_acquœe
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_UNBLOCKED
);

2372 
	`ş—r_b™
(
BTRFS_FS_COMMIT_TRANS
, &
fs_šfo
->
æags
);

2374 ià(
	`TRANS_ABORTED
(
cur_Œªs
)) {

2375 
»t
 = 
cur_Œªs
->
abÜ‹d
;

2376 
	`bŒfs_Œªs_¡©e_lockd•_»Ëa£
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_UNBLOCKED
);

2377 
süub_cÚtšue
;

2384 
	`mu‹x_lock
(&
fs_šfo
->
»loc_mu‹x
);

2391 
»t
 = 
	`ü—‹_³ndšg_¢­shÙs
(
Œªs
);

2392 ià(
»t
)

2393 
uÆock_»loc
;

2405 
»t
 = 
	`bŒfs_run_d–ayed_™ems
(
Œªs
);

2406 ià(
»t
)

2407 
uÆock_»loc
;

2409 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, ()-1);

2410 ià(
»t
)

2411 
uÆock_»loc
;

2418 
	`bŒfs_as£¹_d–ayed_roÙ_em±y
(
fs_šfo
);

2420 
	`WARN_ON
(
cur_Œªs
 !ğ
Œªs
->
Œª§ùiÚ
);

2422 
»t
 = 
	`comm™_fs_roÙs
(
Œªs
);

2423 ià(
»t
)

2424 
uÆock_»loc
;

2429 
	`bŒfs_ä“_log_roÙ_Œ“
(
Œªs
, 
fs_šfo
);

2435 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Ás
(
Œªs
);

2436 ià(
»t
 < 0)

2437 
uÆock_»loc
;

2439 
»t
 = 
	`comm™_cowÚly_roÙs
(
Œªs
);

2441 ià(
»t
)

2442 
uÆock_»loc
;

2448 ià(
	`TRANS_ABORTED
(
cur_Œªs
)) {

2449 
»t
 = 
cur_Œªs
->
abÜ‹d
;

2450 
uÆock_»loc
;

2453 
cur_Œªs
 = 
fs_šfo
->
ruÂšg_Œª§ùiÚ
;

2455 
	`bŒfs_£t_roÙ_node
(&
fs_šfo
->
Œ“_roÙ
->
roÙ_™em
,

2456 
fs_šfo
->
Œ“_roÙ
->
node
);

2457 
	`li¡_add_
(&
fs_šfo
->
Œ“_roÙ
->
dœty_li¡
,

2458 &
cur_Œªs
->
sw™ch_comm™s
);

2460 
	`bŒfs_£t_roÙ_node
(&
fs_šfo
->
chunk_roÙ
->
roÙ_™em
,

2461 
fs_šfo
->
chunk_roÙ
->
node
);

2462 
	`li¡_add_
(&
fs_šfo
->
chunk_roÙ
->
dœty_li¡
,

2463 &
cur_Œªs
->
sw™ch_comm™s
);

2465 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
EXTENT_TREE_V2
)) {

2466 
	`bŒfs_£t_roÙ_node
(&
fs_šfo
->
block_group_roÙ
->
roÙ_™em
,

2467 
fs_šfo
->
block_group_roÙ
->
node
);

2468 
	`li¡_add_
(&
fs_šfo
->
block_group_roÙ
->
dœty_li¡
,

2469 &
cur_Œªs
->
sw™ch_comm™s
);

2472 
	`sw™ch_comm™_roÙs
(
Œªs
);

2474 
	`ASSERT
(
	`li¡_em±y
(&
cur_Œªs
->
dœty_bgs
));

2475 
	`ASSERT
(
	`li¡_em±y
(&
cur_Œªs
->
io_bgs
));

2476 
	`upd©e_su³r_roÙs
(
fs_šfo
);

2478 
	`bŒfs_£t_su³r_log_roÙ
(
fs_šfo
->
su³r_cİy
, 0);

2479 
	`bŒfs_£t_su³r_log_roÙ_Ëv–
(
fs_šfo
->
su³r_cİy
, 0);

2480 
	`memıy
(
fs_šfo
->
su³r_fÜ_comm™
, fs_šfo->
su³r_cİy
,

2481 (*
fs_šfo
->
su³r_cİy
));

2483 
	`bŒfs_comm™_deviû_sizes
(
cur_Œªs
);

2485 
	`ş—r_b™
(
BTRFS_FS_LOG1_ERR
, &
fs_šfo
->
æags
);

2486 
	`ş—r_b™
(
BTRFS_FS_LOG2_ERR
, &
fs_šfo
->
æags
);

2488 
	`bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
Œªs
);

2498 
	`mu‹x_lock
(&
fs_šfo
->
Œ“_log_mu‹x
);

2500 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

2501 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_UNBLOCKED
;

2502 
fs_šfo
->
ruÂšg_Œª§ùiÚ
 = 
NULL
;

2503 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2504 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

2506 
	`wake_up
(&
fs_šfo
->
Œª§ùiÚ_wa™
);

2507 
	`bŒfs_Œªs_¡©e_lockd•_»Ëa£
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_UNBLOCKED
);

2510 ià(
	`‹¡_b™
(
BTRFS_FS_FEATURE_CHANGED
, &
fs_šfo
->
æags
) &&

2511 
fs_šfo
->
ş—Ãr_kth»ad
)

2512 
	`wake_up_´oûss
(
fs_šfo
->
ş—Ãr_kth»ad
);

2514 
»t
 = 
	`bŒfs_wr™e_ªd_wa™_Œª§ùiÚ
(
Œªs
);

2515 ià(
»t
) {

2516 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

2518 
	`mu‹x_uÆock
(&
fs_šfo
->
Œ“_log_mu‹x
);

2519 
süub_cÚtšue
;

2523 
»t
 = 
	`wr™e_®l_su³rs
(
fs_šfo
, 0);

2529 
	`mu‹x_uÆock
(&
fs_šfo
->
Œ“_log_mu‹x
);

2530 ià(
»t
)

2531 
süub_cÚtšue
;

2537 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_SUPER_COMMITTED
;

2538 
	`wake_up
(&
cur_Œªs
->
comm™_wa™
);

2539 
	`bŒfs_Œªs_¡©e_lockd•_»Ëa£
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_SUPER_COMMITTED
);

2541 
	`bŒfs_fšish_ex‹Á_comm™
(
Œªs
);

2544 ià(
	`‹¡_b™
(
BTRFS_TRANS_HAVE_FREE_BGS
, &
cur_Œªs
->
æags
))

2545 
	`bŒfs_ş—r_¥aû_šfo_fuÎ
(
fs_šfo
);

2547 
fs_šfo
->
Ï¡_Œªs_comm™‹d
 = 
cur_Œªs
->
Œªsid
;

2552 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_COMPLETED
;

2553 
	`wake_up
(&
cur_Œªs
->
comm™_wa™
);

2554 
	`bŒfs_Œªs_¡©e_lockd•_»Ëa£
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_COMPLETED
);

2556 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

2557 
	`li¡_d–_š™
(&
cur_Œªs
->
li¡
);

2558 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2560 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

2561 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

2563 ià(
Œªs
->
ty³
 & 
__TRANS_FREEZABLE
)

2564 
	`sb_’d_štwr™e
(
fs_šfo
->
sb
);

2566 
	`Œaû_bŒfs_Œª§ùiÚ_comm™
(
fs_šfo
);

2568 
š‹rv®
 = 
	`ktime_g‘_ns
(è- 
¡¬t_time
;

2570 
	`bŒfs_süub_cÚtšue
(
fs_šfo
);

2572 ià(
cu¼’t
->
jouº®_šfo
 =ğ
Œªs
)

2573 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

2575 
	`kmem_ÿche_ä“
(
bŒfs_Œªs_hªdË_ÿch•
, 
Œªs
);

2577 
	`upd©e_comm™_¡©s
(
fs_šfo
, 
š‹rv®
);

2579  
»t
;

2581 
uÆock_»loc
:

2582 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

2583 
	`bŒfs_Œªs_¡©e_lockd•_»Ëa£
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_UNBLOCKED
);

2584 
süub_cÚtšue
:

2585 
	`bŒfs_Œªs_¡©e_lockd•_»Ëa£
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_SUPER_COMMITTED
);

2586 
	`bŒfs_Œªs_¡©e_lockd•_»Ëa£
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_COMPLETED
);

2587 
	`bŒfs_süub_cÚtšue
(
fs_šfo
);

2588 
ş—nup_Œª§ùiÚ
:

2589 
	`bŒfs_Œªs_»Ëa£_m‘ad©a
(
Œªs
);

2590 
	`bŒfs_ş—nup_³ndšg_block_groups
(
Œªs
);

2591 
	`bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
Œªs
);

2592 
Œªs
->
block_rsv
 = 
NULL
;

2593 
	`bŒfs_w¬n
(
fs_šfo
, "Skipping commit of‡bortedransaction.");

2594 ià(
cu¼’t
->
jouº®_šfo
 =ğ
Œªs
)

2595 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

2596 
	`ş—nup_Œª§ùiÚ
(
Œªs
, 
»t
);

2598  
»t
;

2600 
lockd•_»Ëa£
:

2601 
	`bŒfs_lockd•_»Ëa£
(
fs_šfo
, 
bŒfs_Œªs_num_extwr™”s
);

2602 
	`bŒfs_lockd•_»Ëa£
(
fs_šfo
, 
bŒfs_Œªs_num_wr™”s
);

2603 
ş—nup_Œª§ùiÚ
;

2605 
lockd•_Œªs_comm™_¡¬t_»Ëa£
:

2606 
	`bŒfs_Œªs_¡©e_lockd•_»Ëa£
(
fs_šfo
, 
BTRFS_LOCKDEP_TRANS_COMMIT_PREP
);

2607 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2608  
»t
;

2609 
	}
}

2621 
	$bŒfs_ş—n_Úe_d–‘ed_¢­shÙ
(
bŒfs_fs_šfo
 *
fs_šfo
)

2623 
bŒfs_roÙ
 *
roÙ
;

2624 
»t
;

2626 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

2627 ià(
	`li¡_em±y
(&
fs_šfo
->
d—d_roÙs
)) {

2628 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2631 
roÙ
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
d—d_roÙs
,

2632 
bŒfs_roÙ
, 
roÙ_li¡
);

2633 
	`li¡_d–_š™
(&
roÙ
->
roÙ_li¡
);

2634 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2636 
	`bŒfs_debug
(
fs_šfo
, "ş—Ã¸»movšg %Îu", 
roÙ
->
roÙ_key
.
objeùid
);

2638 
	`bŒfs_kl_®l_d–ayed_nodes
(
roÙ
);

2640 ià(
	`bŒfs_h—d”_back»f_»v
(
roÙ
->
node
) <

2641 
BTRFS_MIXED_BACKREF_REV
)

2642 
»t
 = 
	`bŒfs_drİ_¢­shÙ
(
roÙ
, 0, 0);

2644 
»t
 = 
	`bŒfs_drİ_¢­shÙ
(
roÙ
, 1, 0);

2646 
	`bŒfs_put_roÙ
(
roÙ
);

2647  (
»t
 < 0) ? 0 : 1;

2648 
	}
}

2663 
__cŞd
 
	$__bŒfs_abÜt_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2664 cÚ¡ *
funùiÚ
,

2665 
lše
, 
”ºo
, 
boŞ
 
fœ¡_h™
)

2667 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2669 
	`WRITE_ONCE
(
Œªs
->
abÜ‹d
, 
”ºo
);

2670 
	`WRITE_ONCE
(
Œªs
->
Œª§ùiÚ
->
abÜ‹d
, 
”ºo
);

2671 ià(
fœ¡_h™
 && 
”ºo
 =ğ-
ENOSPC
)

2672 
	`bŒfs_dump_¥aû_šfo_fÜ_Œªs_abÜt
(
fs_šfo
);

2674 
	`wake_up
(&
fs_šfo
->
Œª§ùiÚ_wa™
);

2675 
	`wake_up
(&
fs_šfo
->
Œª§ùiÚ_blocked_wa™
);

2676 
	`__bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
funùiÚ
, 
lše
, 
”ºo
, 
NULL
);

2677 
	}
}

2679 
__š™
 
	$bŒfs_Œª§ùiÚ_š™
()

2681 
bŒfs_Œªs_hªdË_ÿch•
 = 
	`kmem_ÿche_ü—‹
("btrfs_trans_handle",

2682 (
bŒfs_Œªs_hªdË
), 0,

2683 
SLAB_TEMPORARY
 | 
SLAB_MEM_SPREAD
, 
NULL
);

2684 ià(!
bŒfs_Œªs_hªdË_ÿch•
)

2685  -
ENOMEM
;

2687 
	}
}

2689 
__cŞd
 
	$bŒfs_Œª§ùiÚ_ex™
()

2691 
	`kmem_ÿche_de¡roy
(
bŒfs_Œªs_hªdË_ÿch•
);

2692 
	}
}

	@transaction.h

6 #iâdeà
BTRFS_TRANSACTION_H


7 
	#BTRFS_TRANSACTION_H


	)

9 
	~<lšux/»fcouÁ.h
>

10 
	~"bŒfs_šode.h
"

11 
	~"d–ayed-»f.h
"

12 
	~"ù»e.h
"

13 
	~"misc.h
"

15 
	ebŒfs_Œªs_¡©e
 {

16 
	mTRANS_STATE_RUNNING
,

17 
	mTRANS_STATE_COMMIT_PREP
,

18 
	mTRANS_STATE_COMMIT_START
,

19 
	mTRANS_STATE_COMMIT_DOING
,

20 
	mTRANS_STATE_UNBLOCKED
,

21 
	mTRANS_STATE_SUPER_COMMITTED
,

22 
	mTRANS_STATE_COMPLETED
,

23 
	mTRANS_STATE_MAX
,

26 
	#BTRFS_TRANS_HAVE_FREE_BGS
 0

	)

27 
	#BTRFS_TRANS_DIRTY_BG_RUN
 1

	)

28 
	#BTRFS_TRANS_CACHE_ENOSPC
 2

	)

30 
	sbŒfs_Œª§ùiÚ
 {

31 
u64
 
	mŒªsid
;

37 
©omic_t
 
	mnum_extwr™”s
;

42 
©omic_t
 
	mnum_wr™”s
;

43 
»fcouÁ_t
 
	mu£_couÁ
;

45 
	mæags
;

48 
bŒfs_Œªs_¡©e
 
	m¡©e
;

49 
	mabÜ‹d
;

50 
li¡_h—d
 
	mli¡
;

51 
ex‹Á_io_Œ“
 
	mdœty_·ges
;

52 
time64_t
 
	m¡¬t_time
;

53 
wa™_queue_h—d_t
 
	mwr™”_wa™
;

54 
wa™_queue_h—d_t
 
	mcomm™_wa™
;

55 
li¡_h—d
 
	m³ndšg_¢­shÙs
;

56 
li¡_h—d
 
	mdev_upd©e_li¡
;

57 
li¡_h—d
 
	msw™ch_comm™s
;

58 
li¡_h—d
 
	mdœty_bgs
;

75 
li¡_h—d
 
	mio_bgs
;

76 
li¡_h—d
 
	mdrİ³d_roÙs
;

77 
ex‹Á_io_Œ“
 
	mpšÃd_ex‹Ás
;

84 
mu‹x
 
	mÿche_wr™e_mu‹x
;

85 
¥šlock_t
 
	mdœty_bgs_lock
;

87 
li¡_h—d
 
	md–‘ed_bgs
;

88 
¥šlock_t
 
	mdrİ³d_roÙs_lock
;

89 
bŒfs_d–ayed_»f_roÙ
 
	md–ayed_»fs
;

90 
bŒfs_fs_šfo
 *
	mfs_šfo
;

96 
©omic_t
 
	m³ndšg_Üd”ed
;

97 
wa™_queue_h—d_t
 
	m³ndšg_wa™
;

101 
ENUM_BIT
(
__TRANS_FREEZABLE
),

102 
ENUM_BIT
(
__TRANS_START
),

103 
ENUM_BIT
(
__TRANS_ATTACH
),

104 
ENUM_BIT
(
__TRANS_JOIN
),

105 
ENUM_BIT
(
__TRANS_JOIN_NOLOCK
),

106 
ENUM_BIT
(
__TRANS_DUMMY
),

107 
ENUM_BIT
(
__TRANS_JOIN_NOSTART
),

110 
	#TRANS_START
 (
__TRANS_START
 | 
__TRANS_FREEZABLE
)

	)

111 
	#TRANS_ATTACH
 (
__TRANS_ATTACH
)

	)

112 
	#TRANS_JOIN
 (
__TRANS_JOIN
 | 
__TRANS_FREEZABLE
)

	)

113 
	#TRANS_JOIN_NOLOCK
 (
__TRANS_JOIN_NOLOCK
)

	)

114 
	#TRANS_JOIN_NOSTART
 (
__TRANS_JOIN_NOSTART
)

	)

116 
	#TRANS_EXTWRITERS
 (
__TRANS_START
 | 
__TRANS_ATTACH
)

	)

118 
	sbŒfs_Œªs_hªdË
 {

119 
u64
 
	mŒªsid
;

120 
u64
 
	mby‹s_»£rved
;

121 
u64
 
	mchunk_by‹s_»£rved
;

122 
	md–ayed_»f_upd©es
;

123 
bŒfs_Œª§ùiÚ
 *
	mŒª§ùiÚ
;

124 
bŒfs_block_rsv
 *
	mblock_rsv
;

125 
bŒfs_block_rsv
 *
	mÜig_rsv
;

127 
bŒfs_³ndšg_¢­shÙ
 *
	m³ndšg_¢­shÙ
;

128 
»fcouÁ_t
 
	mu£_couÁ
;

129 
	mty³
;

134 
	mabÜ‹d
;

135 
boŞ
 
	maddšg_csums
;

136 
boŞ
 
	m®loÿtšg_chunk
;

137 
boŞ
 
	m»movšg_chunk
;

138 
boŞ
 
	m»loc_»£rved
;

139 
boŞ
 
	mš_fsync
;

140 
bŒfs_fs_šfo
 *
	mfs_šfo
;

141 
li¡_h—d
 
	mÃw_bgs
;

150 
	#TRANS_ABORTED
(
Œªs
è(
	`uÆik–y
(
	`READ_ONCE
(Ñ¿ns)->
abÜ‹d
)))

	)

152 
	sbŒfs_³ndšg_¢­shÙ
 {

153 
d’Œy
 *
	md’Œy
;

154 
šode
 *
	mdœ
;

155 
bŒfs_roÙ
 *
	mroÙ
;

156 
bŒfs_roÙ_™em
 *
	mroÙ_™em
;

157 
bŒfs_roÙ
 *
	m¢­
;

158 
bŒfs_qgroup_šh”™
 *
	mšh”™
;

159 
bŒfs_·th
 *
	m·th
;

161 
bŒfs_block_rsv
 
	mblock_rsv
;

163 
	m”rÜ
;

165 
dev_t
 
	mªÚ_dev
;

166 
boŞ
 
	m»adÚly
;

167 
li¡_h—d
 
	mli¡
;

170 
šlše
 
	$bŒfs_£t_šode_Ï¡_Œªs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

171 
bŒfs_šode
 *
šode
)

173 
	`¥š_lock
(&
šode
->
lock
);

174 
šode
->
Ï¡_Œªs
 = 
Œªs
->
Œª§ùiÚ
->
Œªsid
;

175 
šode
->
Ï¡_sub_Œªs
 = inode->
roÙ
->
log_Œªsid
;

176 
šode
->
Ï¡_log_comm™
 = inode->
Ï¡_sub_Œªs
 - 1;

177 
	`¥š_uÆock
(&
šode
->
lock
);

178 
	}
}

184 
šlše
 
	$bŒfs_£t_sk_qgroup
(
bŒfs_Œªs_hªdË
 *
Œªs
,

185 
u64
 
qgroupid
)

187 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

189 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

190 
	`WARN_ON
(
d–ayed_»fs
->
qgroup_to_sk
);

191 
d–ayed_»fs
->
qgroup_to_sk
 = 
qgroupid
;

192 
	}
}

194 
šlše
 
	$bŒfs_ş—r_sk_qgroup
(
bŒfs_Œªs_hªdË
 *
Œªs
)

196 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

198 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

199 
	`WARN_ON
(!
d–ayed_»fs
->
qgroup_to_sk
);

200 
d–ayed_»fs
->
qgroup_to_sk
 = 0;

201 
	}
}

203 
boŞ
 
__cŞd
 
abÜt_should_´št_¡ack
(
”ºo
);

209 
	#bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
”ºo
) \

211 
boŞ
 
fœ¡
 = 
çl£
; \

213 ià(!
	`‹¡_ªd_£t_b™
(
BTRFS_FS_STATE_TRANS_ABORTED
, \

214 &((
Œªs
)->
fs_šfo
->
fs_¡©e
))) { \

215 
fœ¡
 = 
Œue
; \

216 ià(
	`WARN
(
	`abÜt_should_´št_¡ack
(
”ºo
), \

217 
KERN_ERR
 \

219 (
”ºo
))) { \

222 
	`bŒfs_”r
((
Œªs
)->
fs_šfo
, \

224 (
”ºo
)); \

227 
	`__bŒfs_abÜt_Œª§ùiÚ
((
Œªs
), 
__func__
, \

228 
__LINE__
, (
”ºo
), 
fœ¡
); \

229 } 0)

	)

231 
bŒfs_’d_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
);

232 
bŒfs_Œªs_hªdË
 *
bŒfs_¡¬t_Œª§ùiÚ
(
bŒfs_roÙ
 *
roÙ
,

233 
num_™ems
);

234 
bŒfs_Œªs_hªdË
 *
bŒfs_¡¬t_Œª§ùiÚ_çÎback_glob®_rsv
(

235 
bŒfs_roÙ
 *
roÙ
,

236 
num_™ems
);

237 
bŒfs_Œªs_hªdË
 *
bŒfs_još_Œª§ùiÚ
(
bŒfs_roÙ
 *
roÙ
);

238 
bŒfs_Œªs_hªdË
 *
bŒfs_još_Œª§ùiÚ_¥aûÿche
(
bŒfs_roÙ
 *
roÙ
);

239 
bŒfs_Œªs_hªdË
 *
bŒfs_još_Œª§ùiÚ_no¡¬t
(
bŒfs_roÙ
 *
roÙ
);

240 
bŒfs_Œªs_hªdË
 *
bŒfs_©ch_Œª§ùiÚ
(
bŒfs_roÙ
 *
roÙ
);

241 
bŒfs_Œªs_hªdË
 *
bŒfs_©ch_Œª§ùiÚ_b¬r›r
(

242 
bŒfs_roÙ
 *
roÙ
);

243 
bŒfs_wa™_fÜ_comm™
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
Œªsid
);

245 
bŒfs_add_d—d_roÙ
(
bŒfs_roÙ
 *
roÙ
);

246 
bŒfs_deäag_roÙ
(
bŒfs_roÙ
 *
roÙ
);

247 
bŒfs_maybe_wake_unfšished_drİ
(
bŒfs_fs_šfo
 *
fs_šfo
);

248 
bŒfs_ş—n_Úe_d–‘ed_¢­shÙ
(
bŒfs_fs_šfo
 *
fs_šfo
);

249 
bŒfs_comm™_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
);

250 
bŒfs_comm™_Œª§ùiÚ_async
(
bŒfs_Œªs_hªdË
 *
Œªs
);

251 
bŒfs_’d_Œª§ùiÚ_thrÙe
(
bŒfs_Œªs_hªdË
 *
Œªs
);

252 
boŞ
 
bŒfs_should_’d_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
);

253 
bŒfs_thrÙe
(
bŒfs_fs_šfo
 *
fs_šfo
);

254 
bŒfs_»cÜd_roÙ_š_Œªs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

255 
bŒfs_roÙ
 *
roÙ
);

256 
bŒfs_wr™e_m¬ked_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
,

257 
ex‹Á_io_Œ“
 *
dœty_·ges
, 
m¬k
);

258 
bŒfs_wa™_Œ“_log_ex‹Ás
(
bŒfs_roÙ
 *
roÙ
, 
m¬k
);

259 
bŒfs_Œª§ùiÚ_blocked
(
bŒfs_fs_šfo
 *
šfo
);

260 
bŒfs_Œª§ùiÚ_š_comm™
(
bŒfs_fs_šfo
 *
šfo
);

261 
bŒfs_put_Œª§ùiÚ
(
bŒfs_Œª§ùiÚ
 *
Œª§ùiÚ
);

262 
bŒfs_add_drİ³d_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

263 
bŒfs_roÙ
 *
roÙ
);

264 
bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
bŒfs_Œªs_hªdË
 *
Œªs
);

265 
__cŞd
 
__bŒfs_abÜt_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

266 cÚ¡ *
funùiÚ
,

267 
lše
, 
”ºo
, 
boŞ
 
fœ¡_h™
);

269 
__š™
 
bŒfs_Œª§ùiÚ_š™
();

270 
__cŞd
 
bŒfs_Œª§ùiÚ_ex™
();

	@tree-checker.c

18 
	~<lšux/ty³s.h
>

19 
	~<lšux/¡ddef.h
>

20 
	~<lšux/”rÜ-šjeùiÚ.h
>

21 
	~"mes§ges.h
"

22 
	~"ù»e.h
"

23 
	~"Œ“-check”.h
"

24 
	~"disk-io.h
"

25 
	~"com´essiÚ.h
"

26 
	~"vŞumes.h
"

27 
	~"misc.h
"

28 
	~"fs.h
"

29 
	~"acûssÜs.h
"

30 
	~"fe-™em.h
"

31 
	~"šode-™em.h
"

53 
	$__´štf
(3, 4)

54 
__cŞd


55 
	$g’”ic_”r
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

56 cÚ¡ *
fmt
, ...)

58 cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

59 
va_fÜm©
 
vaf
;

60 
va_li¡
 
¬gs
;

62 
	`va_¡¬t
(
¬gs
, 
fmt
);

64 
vaf
.
fmt
 = fmt;

65 
vaf
.
va
 = &
¬gs
;

67 
	`bŒfs_ü™
(
fs_šfo
,

69 
	`bŒfs_h—d”_Ëv–
(
eb
) == 0 ? "leaf" : "node",

70 
	`bŒfs_h—d”_owÃr
(
eb
), 
	`bŒfs_h—d”_by‹Ä
Ób), 
¦Ù
, &
vaf
);

71 
	`va_’d
(
¬gs
);

72 
	}
}

78 
	$__´štf
(3, 4)

79 
__cŞd


80 
	$fe_ex‹Á_”r
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

81 cÚ¡ *
fmt
, ...)

83 cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

84 
bŒfs_key
 
key
;

85 
va_fÜm©
 
vaf
;

86 
va_li¡
 
¬gs
;

88 
	`bŒfs_™em_key_to_ıu
(
eb
, &
key
, 
¦Ù
);

89 
	`va_¡¬t
(
¬gs
, 
fmt
);

91 
vaf
.
fmt
 = fmt;

92 
vaf
.
va
 = &
¬gs
;

94 
	`bŒfs_ü™
(
fs_šfo
,

96 
	`bŒfs_h—d”_Ëv–
(
eb
) == 0 ? "leaf" : "node",

97 
	`bŒfs_h—d”_owÃr
(
eb
), 
	`bŒfs_h—d”_by‹Ä
Ób), 
¦Ù
,

98 
key
.
objeùid
, key.
off£t
, &
vaf
);

99 
	`va_’d
(
¬gs
);

100 
	}
}

106 
	#CHECK_FE_ALIGNED
(
Ëaf
, 
¦Ù
, 
fi
, 
Çme
, 
®ignm’t
) \

108 ià(
	`uÆik–y
(!
	`IS_ALIGNED
(
bŒfs_fe_ex‹Á_
##
	`Çme
((
Ëaf
), (
fi
)), \

109 (
®ignm’t
)))) \

110 
	`fe_ex‹Á_”r
((
Ëaf
), (
¦Ù
), \

112 (#Çme), 
bŒfs_fe_ex‹Á_
##
	`Çme
((
Ëaf
), (
fi
)), \

113 (
®ignm’t
)); \

114 (!
	`IS_ALIGNED
(
bŒfs_fe_ex‹Á_
##
	`Çme
((
Ëaf
), (
fi
)), (
®ignm’t
))); \

115 })

	)

117 
u64
 
	$fe_ex‹Á_’d
(
ex‹Á_bufãr
 *
Ëaf
,

118 
bŒfs_key
 *
key
,

119 
bŒfs_fe_ex‹Á_™em
 *
ex‹Á
)

121 
u64
 
’d
;

122 
u64
 
Ën
;

124 ià(
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
ex‹Á
è=ğ
BTRFS_FILE_EXTENT_INLINE
) {

125 
Ën
 = 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
ex‹Á
);

126 
’d
 = 
	`ALIGN
(
key
->
off£t
 + 
Ën
, 
Ëaf
->
fs_šfo
->
£ùÜsize
);

128 
Ën
 = 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
ex‹Á
);

129 
’d
 = 
key
->
off£t
 + 
Ën
;

131  
’d
;

132 
	}
}

138 
	$__´štf
(3, 4)

139 
__cŞd


140 
	$dœ_™em_”r
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

141 cÚ¡ *
fmt
, ...)

143 cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

144 
bŒfs_key
 
key
;

145 
va_fÜm©
 
vaf
;

146 
va_li¡
 
¬gs
;

148 
	`bŒfs_™em_key_to_ıu
(
eb
, &
key
, 
¦Ù
);

149 
	`va_¡¬t
(
¬gs
, 
fmt
);

151 
vaf
.
fmt
 = fmt;

152 
vaf
.
va
 = &
¬gs
;

154 
	`bŒfs_ü™
(
fs_šfo
,

156 
	`bŒfs_h—d”_Ëv–
(
eb
) == 0 ? "leaf" : "node",

157 
	`bŒfs_h—d”_owÃr
(
eb
), 
	`bŒfs_h—d”_by‹Ä
Ób), 
¦Ù
,

158 
key
.
objeùid
, &
vaf
);

159 
	`va_’d
(
¬gs
);

160 
	}
}

171 
boŞ
 
	$check_´ev_šo
(
ex‹Á_bufãr
 *
Ëaf
,

172 
bŒfs_key
 *
key
, 
¦Ù
,

173 
bŒfs_key
 *
´ev_key
)

176 ià(
¦Ù
 == 0)

177  
Œue
;

180 
	`ASSERT
(
key
->
ty³
 =ğ
BTRFS_XATTR_ITEM_KEY
 ||

181 
key
->
ty³
 =ğ
BTRFS_INODE_REF_KEY
 ||

182 
key
->
ty³
 =ğ
BTRFS_DIR_INDEX_KEY
 ||

183 
key
->
ty³
 =ğ
BTRFS_DIR_ITEM_KEY
 ||

184 
key
->
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
);

190 ià(!
	`is_f¡»e
(
	`bŒfs_h—d”_owÃr
(
Ëaf
)))

191  
Œue
;

193 ià(
key
->
objeùid
 =ğ
´ev_key
->objectid)

194  
Œue
;

197 
	`dœ_™em_”r
(
Ëaf
, 
¦Ù
,

199 
´ev_key
->
objeùid
, 
key
->objectid);

200  
çl£
;

201 
	}
}

202 
	$check_ex‹Á_d©a_™em
(
ex‹Á_bufãr
 *
Ëaf
,

203 
bŒfs_key
 *
key
, 
¦Ù
,

204 
bŒfs_key
 *
´ev_key
)

206 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

207 
bŒfs_fe_ex‹Á_™em
 *
fi
;

208 
u32
 
£ùÜsize
 = 
fs_šfo
->sectorsize;

209 
u32
 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

210 
u64
 
ex‹Á_’d
;

212 ià(
	`uÆik–y
(!
	`IS_ALIGNED
(
key
->
off£t
, 
£ùÜsize
))) {

213 
	`fe_ex‹Á_”r
(
Ëaf
, 
¦Ù
,

215 
key
->
off£t
, 
£ùÜsize
);

216  -
EUCLEAN
;

225 ià(
	`uÆik–y
(!
	`check_´ev_šo
(
Ëaf
, 
key
, 
¦Ù
, 
´ev_key
)))

226  -
EUCLEAN
;

228 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_fe_ex‹Á_™em
);

234 ià(
	`uÆik–y
(
™em_size
 < 
BTRFS_FILE_EXTENT_INLINE_DATA_START
)) {

235 
	`fe_ex‹Á_”r
(
Ëaf
, 
¦Ù
,

237 
™em_size
, 
BTRFS_FILE_EXTENT_INLINE_DATA_START
,

238 
SZ_4K
);

239  -
EUCLEAN
;

241 ià(
	`uÆik–y
(
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
fi
) >=

242 
BTRFS_NR_FILE_EXTENT_TYPES
)) {

243 
	`fe_ex‹Á_”r
(
Ëaf
, 
¦Ù
,

245 
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
fi
),

246 
BTRFS_NR_FILE_EXTENT_TYPES
 - 1);

247  -
EUCLEAN
;

254 ià(
	`uÆik–y
(
	`bŒfs_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
) >=

255 
BTRFS_NR_COMPRESS_TYPES
)) {

256 
	`fe_ex‹Á_”r
(
Ëaf
, 
¦Ù
,

258 
	`bŒfs_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
),

259 
BTRFS_NR_COMPRESS_TYPES
 - 1);

260  -
EUCLEAN
;

262 ià(
	`uÆik–y
(
	`bŒfs_fe_ex‹Á_’üy±iÚ
(
Ëaf
, 
fi
))) {

263 
	`fe_ex‹Á_”r
(
Ëaf
, 
¦Ù
,

265 
	`bŒfs_fe_ex‹Á_’üy±iÚ
(
Ëaf
, 
fi
));

266  -
EUCLEAN
;

268 ià(
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
fi
è=ğ
BTRFS_FILE_EXTENT_INLINE
) {

270 ià(
	`uÆik–y
(
key
->
off£t
)) {

271 
	`fe_ex‹Á_”r
(
Ëaf
, 
¦Ù
,

273 
key
->
off£t
);

274  -
EUCLEAN
;

278 ià(
	`bŒfs_fe_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
) !=

279 
BTRFS_COMPRESS_NONE
)

283 ià(
	`uÆik–y
(
™em_size
 !ğ
BTRFS_FILE_EXTENT_INLINE_DATA_START
 +

284 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
))) {

285 
	`fe_ex‹Á_”r
(
Ëaf
, 
¦Ù
,

287 
™em_size
, 
BTRFS_FILE_EXTENT_INLINE_DATA_START
 +

288 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
));

289  -
EUCLEAN
;

295 ià(
	`uÆik–y
(
™em_size
 !ğ(*
fi
))) {

296 
	`fe_ex‹Á_”r
(
Ëaf
, 
¦Ù
,

298 
™em_size
, (*
fi
));

299  -
EUCLEAN
;

301 ià(
	`uÆik–y
(
	`CHECK_FE_ALIGNED
(
Ëaf
, 
¦Ù
, 
fi
, 
¿m_by‹s
, 
£ùÜsize
) ||

302 
	`CHECK_FE_ALIGNED
(
Ëaf
, 
¦Ù
, 
fi
, 
disk_by‹Ä
, 
£ùÜsize
) ||

303 
	`CHECK_FE_ALIGNED
(
Ëaf
, 
¦Ù
, 
fi
, 
disk_num_by‹s
, 
£ùÜsize
) ||

304 
	`CHECK_FE_ALIGNED
(
Ëaf
, 
¦Ù
, 
fi
, 
off£t
, 
£ùÜsize
) ||

305 
	`CHECK_FE_ALIGNED
(
Ëaf
, 
¦Ù
, 
fi
, 
num_by‹s
, 
£ùÜsize
)))

306  -
EUCLEAN
;

309 ià(
	`uÆik–y
(
	`check_add_ov”æow
(
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
),

310 
key
->
off£t
, &
ex‹Á_’d
))) {

311 
	`fe_ex‹Á_”r
(
Ëaf
, 
¦Ù
,

313 
key
->
off£t
,

314 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
fi
));

315  -
EUCLEAN
;

322 ià(
¦Ù
 > 0 &&

323 
´ev_key
->
objeùid
 =ğ
key
->objectid &&

324 
´ev_key
->
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
) {

325 
bŒfs_fe_ex‹Á_™em
 *
´ev_fi
;

326 
u64
 
´ev_’d
;

328 
´ev_fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
 - 1,

329 
bŒfs_fe_ex‹Á_™em
);

330 
´ev_’d
 = 
	`fe_ex‹Á_’d
(
Ëaf
, 
´ev_key
, 
´ev_fi
);

331 ià(
	`uÆik–y
(
´ev_’d
 > 
key
->
off£t
)) {

332 
	`fe_ex‹Á_”r
(
Ëaf
, 
¦Ù
 - 1,

334 
´ev_’d
, 
key
->
off£t
);

335  -
EUCLEAN
;

340 
	}
}

342 
	$check_csum_™em
(
ex‹Á_bufãr
 *
Ëaf
, 
bŒfs_key
 *
key
,

343 
¦Ù
, 
bŒfs_key
 *
´ev_key
)

345 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

346 
u32
 
£ùÜsize
 = 
fs_šfo
->sectorsize;

347 cÚ¡ 
u32
 
csumsize
 = 
fs_šfo
->
csum_size
;

349 ià(
	`uÆik–y
(
key
->
objeùid
 !ğ
BTRFS_EXTENT_CSUM_OBJECTID
)) {

350 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

352 
key
->
objeùid
, 
BTRFS_EXTENT_CSUM_OBJECTID
);

353  -
EUCLEAN
;

355 ià(
	`uÆik–y
(!
	`IS_ALIGNED
(
key
->
off£t
, 
£ùÜsize
))) {

356 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

358 
key
->
off£t
, 
£ùÜsize
);

359  -
EUCLEAN
;

361 ià(
	`uÆik–y
(!
	`IS_ALIGNED
(
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
), 
csumsize
))) {

362 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

364 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
), 
csumsize
);

365  -
EUCLEAN
;

367 ià(
¦Ù
 > 0 && 
´ev_key
->
ty³
 =ğ
BTRFS_EXTENT_CSUM_KEY
) {

368 
u64
 
´ev_csum_’d
;

369 
u32
 
´ev_™em_size
;

371 
´ev_™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
 - 1);

372 
´ev_csum_’d
 = (
´ev_™em_size
 / 
csumsize
è* 
£ùÜsize
;

373 
´ev_csum_’d
 +ğ
´ev_key
->
off£t
;

374 ià(
	`uÆik–y
(
´ev_csum_’d
 > 
key
->
off£t
)) {

375 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
 - 1,

377 
´ev_csum_’d
, 
key
->
off£t
);

378  -
EUCLEAN
;

382 
	}
}

385 
	#šode_™em_”r
(
eb
, 
¦Ù
, 
fmt
, ...) \

386 
	`dœ_™em_”r
(
eb
, 
¦Ù
, 
fmt
, 
__VA_ARGS__
)

	)

388 
	$check_šode_key
(
ex‹Á_bufãr
 *
Ëaf
, 
bŒfs_key
 *
key
,

389 
¦Ù
)

391 
bŒfs_key
 
™em_key
;

392 
boŞ
 
is_šode_™em
;

394 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
™em_key
, 
¦Ù
);

395 
is_šode_™em
 = (
™em_key
.
ty³
 =ğ
BTRFS_INODE_ITEM_KEY
);

398 ià(
™em_key
.
ty³
 =ğ
BTRFS_XATTR_ITEM_KEY
) {

399 ià(
	`uÆik–y
(
key
->
objeùid
 !ğ0 || key->
ty³
 != 0 ||

400 
key
->
off£t
 != 0))

401  -
EUCLEAN
;

405 ià(
	`uÆik–y
((
key
->
objeùid
 < 
BTRFS_FIRST_FREE_OBJECTID
 ||

406 
key
->
objeùid
 > 
BTRFS_LAST_FREE_OBJECTID
) &&

407 
key
->
objeùid
 !ğ
BTRFS_ROOT_TREE_DIR_OBJECTID
 &&

408 
key
->
objeùid
 !ğ
BTRFS_FREE_INO_OBJECTID
)) {

409 ià(
is_šode_™em
) {

410 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

412 
key
->
objeùid
, 
BTRFS_ROOT_TREE_DIR_OBJECTID
,

413 
BTRFS_FIRST_FREE_OBJECTID
,

414 
BTRFS_LAST_FREE_OBJECTID
,

415 
BTRFS_FREE_INO_OBJECTID
);

417 
	`dœ_™em_”r
(
Ëaf
, 
¦Ù
,

419 
key
->
objeùid
, 
BTRFS_ROOT_TREE_DIR_OBJECTID
,

420 
BTRFS_FIRST_FREE_OBJECTID
,

421 
BTRFS_LAST_FREE_OBJECTID
,

422 
BTRFS_FREE_INO_OBJECTID
);

424  -
EUCLEAN
;

426 ià(
	`uÆik–y
(
key
->
off£t
 != 0)) {

427 ià(
is_šode_™em
)

428 
	`šode_™em_”r
(
Ëaf
, 
¦Ù
,

430 
key
->
off£t
);

432 
	`dœ_™em_”r
(
Ëaf
, 
¦Ù
,

434 
key
->
off£t
);

435  -
EUCLEAN
;

438 
	}
}

440 
	$check_roÙ_key
(
ex‹Á_bufãr
 *
Ëaf
, 
bŒfs_key
 *
key
,

441 
¦Ù
)

443 
bŒfs_key
 
™em_key
;

444 
boŞ
 
is_roÙ_™em
;

446 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
™em_key
, 
¦Ù
);

447 
is_roÙ_™em
 = (
™em_key
.
ty³
 =ğ
BTRFS_ROOT_ITEM_KEY
);

455 ià(
	`uÆik–y
(
is_roÙ_™em
 && 
key
->
objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
 &&

456 !
	`is_f¡»e
(
key
->
off£t
))) {

457 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

459 
key
->
off£t
);

460  -
EUCLEAN
;

464 ià(
	`uÆik–y
(
key
->
objeùid
 == 0)) {

465 ià(
is_roÙ_™em
)

466 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
, "invalid„oot id 0");

468 
	`dœ_™em_”r
(
Ëaf
, 
¦Ù
,

470  -
EUCLEAN
;

474 ià(
	`uÆik–y
(!
	`is_f¡»e
(
key
->
objeùid
è&& !
is_roÙ_™em
)) {

475 
	`dœ_™em_”r
(
Ëaf
, 
¦Ù
,

477 
key
->
objeùid
, 
BTRFS_FIRST_FREE_OBJECTID
,

478 
BTRFS_LAST_FREE_OBJECTID
);

479  -
EUCLEAN
;

490 ià(
	`uÆik–y
(
key
->
objeùid
 =ğ
BTRFS_TREE_RELOC_OBJECTID
 &&

491 
key
->
off£t
 == 0)) {

492 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
, "invalid„oot id 0 for„elocree");

493  -
EUCLEAN
;

496 
	}
}

498 
	$check_dœ_™em
(
ex‹Á_bufãr
 *
Ëaf
,

499 
bŒfs_key
 *
key
, bŒfs_key *
´ev_key
,

500 
¦Ù
)

502 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

503 
bŒfs_dœ_™em
 *
di
;

504 
u32
 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

505 
u32
 
cur
 = 0;

507 ià(
	`uÆik–y
(!
	`check_´ev_šo
(
Ëaf
, 
key
, 
¦Ù
, 
´ev_key
)))

508  -
EUCLEAN
;

510 
di
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_dœ_™em
);

511 
cur
 < 
™em_size
) {

512 
bŒfs_key
 
loÿtiÚ_key
;

513 
u32
 
Çme_Ën
;

514 
u32
 
d©a_Ën
;

515 
u32
 
max_Çme_Ën
;

516 
u32
 
tÙ®_size
;

517 
u32
 
Çme_hash
;

518 
u8
 
dœ_ty³
;

519 
»t
;

522 ià(
	`uÆik–y
(
cur
 + (*
di
è> 
™em_size
)) {

523 
	`dœ_™em_”r
(
Ëaf
, 
¦Ù
,

525 
cur
 + (*
di
), 
™em_size
);

526  -
EUCLEAN
;

530 
	`bŒfs_dœ_™em_key_to_ıu
(
Ëaf
, 
di
, &
loÿtiÚ_key
);

531 ià(
loÿtiÚ_key
.
ty³
 =ğ
BTRFS_ROOT_ITEM_KEY
) {

532 
»t
 = 
	`check_roÙ_key
(
Ëaf
, &
loÿtiÚ_key
, 
¦Ù
);

533 ià(
	`uÆik–y
(
»t
 < 0))

534  
»t
;

535 } ià(
loÿtiÚ_key
.
ty³
 =ğ
BTRFS_INODE_ITEM_KEY
 ||

536 
loÿtiÚ_key
.
ty³
 == 0) {

537 
»t
 = 
	`check_šode_key
(
Ëaf
, &
loÿtiÚ_key
, 
¦Ù
);

538 ià(
	`uÆik–y
(
»t
 < 0))

539  
»t
;

541 
	`dœ_™em_”r
(
Ëaf
, 
¦Ù
,

543 
loÿtiÚ_key
.
ty³
, 
BTRFS_ROOT_ITEM_KEY
,

544 
BTRFS_INODE_ITEM_KEY
);

545  -
EUCLEAN
;

549 
dœ_ty³
 = 
	`bŒfs_dœ_áy³
(
Ëaf
, 
di
);

550 ià(
	`uÆik–y
(
dœ_ty³
 >ğ
BTRFS_FT_MAX
)) {

551 
	`dœ_™em_”r
(
Ëaf
, 
¦Ù
,

553 
dœ_ty³
, 
BTRFS_FT_MAX
);

554  -
EUCLEAN
;

557 ià(
	`uÆik–y
(
key
->
ty³
 =ğ
BTRFS_XATTR_ITEM_KEY
 &&

558 
dœ_ty³
 !ğ
BTRFS_FT_XATTR
)) {

559 
	`dœ_™em_”r
(
Ëaf
, 
¦Ù
,

561 
dœ_ty³
, 
BTRFS_FT_XATTR
);

562  -
EUCLEAN
;

564 ià(
	`uÆik–y
(
dœ_ty³
 =ğ
BTRFS_FT_XATTR
 &&

565 
key
->
ty³
 !ğ
BTRFS_XATTR_ITEM_KEY
)) {

566 
	`dœ_™em_”r
(
Ëaf
, 
¦Ù
,

568  -
EUCLEAN
;

570 ià(
dœ_ty³
 =ğ
BTRFS_FT_XATTR
)

571 
max_Çme_Ën
 = 
XATTR_NAME_MAX
;

573 
max_Çme_Ën
 = 
BTRFS_NAME_LEN
;

576 
Çme_Ën
 = 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
di
);

577 
d©a_Ën
 = 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
);

578 ià(
	`uÆik–y
(
Çme_Ën
 > 
max_Çme_Ën
)) {

579 
	`dœ_™em_”r
(
Ëaf
, 
¦Ù
,

581 
Çme_Ën
, 
max_Çme_Ën
);

582  -
EUCLEAN
;

584 ià(
	`uÆik–y
(
Çme_Ën
 + 
d©a_Ën
 > 
	`BTRFS_MAX_XATTR_SIZE
(
fs_šfo
))) {

585 
	`dœ_™em_”r
(
Ëaf
, 
¦Ù
,

587 
Çme_Ën
 + 
d©a_Ën
,

588 
	`BTRFS_MAX_XATTR_SIZE
(
fs_šfo
));

589  -
EUCLEAN
;

592 ià(
	`uÆik–y
(
d©a_Ën
 && 
dœ_ty³
 !ğ
BTRFS_FT_XATTR
)) {

593 
	`dœ_™em_”r
(
Ëaf
, 
¦Ù
,

595 
d©a_Ën
);

596  -
EUCLEAN
;

599 
tÙ®_size
 = (*
di
è+ 
Çme_Ën
 + 
d©a_Ën
;

602 ià(
	`uÆik–y
(
cur
 + 
tÙ®_size
 > 
™em_size
)) {

603 
	`dœ_™em_”r
(
Ëaf
, 
¦Ù
,

605 
cur
 + 
tÙ®_size
, 
™em_size
);

606  -
EUCLEAN
;

613 ià(
key
->
ty³
 =ğ
BTRFS_DIR_ITEM_KEY
 ||

614 
key
->
ty³
 =ğ
BTRFS_XATTR_ITEM_KEY
) {

615 
Çmebuf
[
	`max
(
BTRFS_NAME_LEN
, 
XATTR_NAME_MAX
)];

617 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
Çmebuf
,

618 ()(
di
 + 1), 
Çme_Ën
);

619 
Çme_hash
 = 
	`bŒfs_Çme_hash
(
Çmebuf
, 
Çme_Ën
);

620 ià(
	`uÆik–y
(
key
->
off£t
 !ğ
Çme_hash
)) {

621 
	`dœ_™em_”r
(
Ëaf
, 
¦Ù
,

623 
Çme_hash
, 
key
->
off£t
);

624  -
EUCLEAN
;

627 
cur
 +ğ
tÙ®_size
;

628 
di
 = (
bŒfs_dœ_™em
 *)((*)d˜+ 
tÙ®_size
);

631 
	}
}

633 
	$__´štf
(3, 4)

634 
__cŞd


635 
	$block_group_”r
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

636 cÚ¡ *
fmt
, ...)

638 cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

639 
bŒfs_key
 
key
;

640 
va_fÜm©
 
vaf
;

641 
va_li¡
 
¬gs
;

643 
	`bŒfs_™em_key_to_ıu
(
eb
, &
key
, 
¦Ù
);

644 
	`va_¡¬t
(
¬gs
, 
fmt
);

646 
vaf
.
fmt
 = fmt;

647 
vaf
.
va
 = &
¬gs
;

649 
	`bŒfs_ü™
(
fs_šfo
,

651 
	`bŒfs_h—d”_Ëv–
(
eb
) == 0 ? "leaf" : "node",

652 
	`bŒfs_h—d”_owÃr
(
eb
), 
	`bŒfs_h—d”_by‹Ä
Ób), 
¦Ù
,

653 
key
.
objeùid
, key.
off£t
, &
vaf
);

654 
	`va_’d
(
¬gs
);

655 
	}
}

657 
	$check_block_group_™em
(
ex‹Á_bufãr
 *
Ëaf
,

658 
bŒfs_key
 *
key
, 
¦Ù
)

660 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

661 
bŒfs_block_group_™em
 
bgi
;

662 
u32
 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

663 
u64
 
chunk_objeùid
;

664 
u64
 
æags
;

665 
u64
 
ty³
;

671 ià(
	`uÆik–y
(
key
->
off£t
 == 0)) {

672 
	`block_group_”r
(
Ëaf
, 
¦Ù
,

674  -
EUCLEAN
;

677 ià(
	`uÆik–y
(
™em_size
 !ğ(
bgi
))) {

678 
	`block_group_”r
(
Ëaf
, 
¦Ù
,

680 
™em_size
, (
bgi
));

681  -
EUCLEAN
;

684 
	`»ad_ex‹Á_bufãr
(
Ëaf
, &
bgi
, 
	`bŒfs_™em_±r_off£t
Ö—f, 
¦Ù
),

685 (
bgi
));

686 
chunk_objeùid
 = 
	`bŒfs_¡ack_block_group_chunk_objeùid
(&
bgi
);

687 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
EXTENT_TREE_V2
)) {

694 ià(
	`uÆik–y
(
fs_šfo
->
Ä_glob®_roÙs
 &&

695 
chunk_objeùid
 >ğ
fs_šfo
->
Ä_glob®_roÙs
)) {

696 
	`block_group_”r
(
Ëaf
, 
¦Ù
,

698 
chunk_objeùid
,

699 
fs_šfo
->
Ä_glob®_roÙs
);

700  -
EUCLEAN
;

702 } ià(
	`uÆik–y
(
chunk_objeùid
 !ğ
BTRFS_FIRST_CHUNK_TREE_OBJECTID
)) {

703 
	`block_group_”r
(
Ëaf
, 
¦Ù
,

705 
	`bŒfs_¡ack_block_group_chunk_objeùid
(&
bgi
),

706 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
);

707  -
EUCLEAN
;

710 ià(
	`uÆik–y
(
	`bŒfs_¡ack_block_group_u£d
(&
bgi
è> 
key
->
off£t
)) {

711 
	`block_group_”r
(
Ëaf
, 
¦Ù
,

713 
	`bŒfs_¡ack_block_group_u£d
(&
bgi
), 
key
->
off£t
);

714  -
EUCLEAN
;

717 
æags
 = 
	`bŒfs_¡ack_block_group_æags
(&
bgi
);

718 ià(
	`uÆik–y
(
	`hweight64
(
æags
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) > 1)) {

719 
	`block_group_”r
(
Ëaf
, 
¦Ù
,

721 
æags
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
,

722 
	`hweight64
(
æags
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
));

723  -
EUCLEAN
;

726 
ty³
 = 
æags
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
;

727 ià(
	`uÆik–y
(
ty³
 !ğ
BTRFS_BLOCK_GROUP_DATA
 &&

728 
ty³
 !ğ
BTRFS_BLOCK_GROUP_METADATA
 &&

729 
ty³
 !ğ
BTRFS_BLOCK_GROUP_SYSTEM
 &&

730 
ty³
 !ğ(
BTRFS_BLOCK_GROUP_METADATA
 |

731 
BTRFS_BLOCK_GROUP_DATA
))) {

732 
	`block_group_”r
(
Ëaf
, 
¦Ù
,

734 
ty³
, 
	`hweight64
(type),

735 
BTRFS_BLOCK_GROUP_DATA
, 
BTRFS_BLOCK_GROUP_METADATA
,

736 
BTRFS_BLOCK_GROUP_SYSTEM
,

737 
BTRFS_BLOCK_GROUP_METADATA
 | 
BTRFS_BLOCK_GROUP_DATA
);

738  -
EUCLEAN
;

741 
	}
}

743 
	$__´štf
(4, 5)

744 
__cŞd


745 
	$chunk_”r
(cÚ¡ 
ex‹Á_bufãr
 *
Ëaf
,

746 cÚ¡ 
bŒfs_chunk
 *
chunk
, 
u64
 
logiÿl
,

747 cÚ¡ *
fmt
, ...)

749 cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

750 
boŞ
 
is_sb
;

751 
va_fÜm©
 
vaf
;

752 
va_li¡
 
¬gs
;

753 
i
;

754 
¦Ù
 = -1;

757 
is_sb
 = (
Ëaf
->
¡¬t
 =ğ
BTRFS_SUPER_INFO_OFFSET
);

759 ià(!
is_sb
) {

764 
i
 = 0; i < 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
); i++) {

765 ià(
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
i
) ==

766 ()
chunk
) {

767 
¦Ù
 = 
i
;

772 
	`va_¡¬t
(
¬gs
, 
fmt
);

773 
vaf
.
fmt
 = fmt;

774 
vaf
.
va
 = &
¬gs
;

776 ià(
is_sb
)

777 
	`bŒfs_ü™
(
fs_šfo
,

779 
logiÿl
, &
vaf
);

781 
	`bŒfs_ü™
(
fs_šfo
,

783 
BTRFS_CHUNK_TREE_OBJECTID
, 
Ëaf
->
¡¬t
, 
¦Ù
,

784 
logiÿl
, &
vaf
);

785 
	`va_’d
(
¬gs
);

786 
	}
}

794 
	$bŒfs_check_chunk_v®id
(
ex‹Á_bufãr
 *
Ëaf
,

795 
bŒfs_chunk
 *
chunk
, 
u64
 
logiÿl
)

797 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

798 
u64
 
Ëngth
;

799 
u64
 
chunk_’d
;

800 
u64
 
¡re_Ën
;

801 
u16
 
num_¡res
;

802 
u16
 
sub_¡res
;

803 
u64
 
ty³
;

804 
u64
 
ã©u»s
;

805 
boŞ
 
mixed
 = 
çl£
;

806 
¿id_šdex
;

807 
Å¬™y
;

808 
ncİ›s
;

810 
Ëngth
 = 
	`bŒfs_chunk_Ëngth
(
Ëaf
, 
chunk
);

811 
¡re_Ën
 = 
	`bŒfs_chunk_¡re_Ën
(
Ëaf
, 
chunk
);

812 
num_¡res
 = 
	`bŒfs_chunk_num_¡res
(
Ëaf
, 
chunk
);

813 
sub_¡res
 = 
	`bŒfs_chunk_sub_¡res
(
Ëaf
, 
chunk
);

814 
ty³
 = 
	`bŒfs_chunk_ty³
(
Ëaf
, 
chunk
);

815 
¿id_šdex
 = 
	`bŒfs_bg_æags_to_¿id_šdex
(
ty³
);

816 
ncİ›s
 = 
bŒfs_¿id_¬¿y
[
¿id_šdex
].ncopies;

817 
Å¬™y
 = 
bŒfs_¿id_¬¿y
[
¿id_šdex
].nparity;

819 ià(
	`uÆik–y
(!
num_¡res
)) {

820 
	`chunk_”r
(
Ëaf
, 
chunk
, 
logiÿl
,

821 "šv®id chunk‚um_¡res, hav%u", 
num_¡res
);

822  -
EUCLEAN
;

824 ià(
	`uÆik–y
(
num_¡res
 < 
ncİ›s
)) {

825 
	`chunk_”r
(
Ëaf
, 
chunk
, 
logiÿl
,

827 
num_¡res
, 
ncİ›s
);

828  -
EUCLEAN
;

830 ià(
	`uÆik–y
(
Å¬™y
 && 
num_¡res
 ==‚parity)) {

831 
	`chunk_”r
(
Ëaf
, 
chunk
, 
logiÿl
,

833 
num_¡res
, 
Å¬™y
);

834  -
EUCLEAN
;

836 ià(
	`uÆik–y
(!
	`IS_ALIGNED
(
logiÿl
, 
fs_šfo
->
£ùÜsize
))) {

837 
	`chunk_”r
(
Ëaf
, 
chunk
, 
logiÿl
,

839 
logiÿl
, 
fs_šfo
->
£ùÜsize
);

840  -
EUCLEAN
;

842 ià(
	`uÆik–y
(
	`bŒfs_chunk_£ùÜ_size
(
Ëaf
, 
chunk
è!ğ
fs_šfo
->
£ùÜsize
)) {

843 
	`chunk_”r
(
Ëaf
, 
chunk
, 
logiÿl
,

845 
	`bŒfs_chunk_£ùÜ_size
(
Ëaf
, 
chunk
),

846 
fs_šfo
->
£ùÜsize
);

847  -
EUCLEAN
;

849 ià(
	`uÆik–y
(!
Ëngth
 || !
	`IS_ALIGNED
Ö’gth, 
fs_šfo
->
£ùÜsize
))) {

850 
	`chunk_”r
(
Ëaf
, 
chunk
, 
logiÿl
,

851 "šv®id chunk†’gth, hav%Îu", 
Ëngth
);

852  -
EUCLEAN
;

854 ià(
	`uÆik–y
(
	`check_add_ov”æow
(
logiÿl
, 
Ëngth
, &
chunk_’d
))) {

855 
	`chunk_”r
(
Ëaf
, 
chunk
, 
logiÿl
,

857 
logiÿl
, 
Ëngth
);

858  -
EUCLEAN
;

860 ià(
	`uÆik–y
(!
	`is_pow”_of_2
(
¡re_Ën
è|| sŒe_ËÀ!ğ
BTRFS_STRIPE_LEN
)) {

861 
	`chunk_”r
(
Ëaf
, 
chunk
, 
logiÿl
,

863 
¡re_Ën
);

864  -
EUCLEAN
;

874 ià(
	`uÆik–y
(
Ëngth
 >ğ
	`bŒfs_¡re_Ä_to_off£t
(
U32_MAX
))) {

875 
	`chunk_”r
(
Ëaf
, 
chunk
, 
logiÿl
,

877 
Ëngth
, 
	`bŒfs_¡re_Ä_to_off£t
(
U32_MAX
));

878  -
EUCLEAN
;

880 ià(
	`uÆik–y
(
ty³
 & ~(
BTRFS_BLOCK_GROUP_TYPE_MASK
 |

881 
BTRFS_BLOCK_GROUP_PROFILE_MASK
))) {

882 
	`chunk_”r
(
Ëaf
, 
chunk
, 
logiÿl
,

884 ~(
BTRFS_BLOCK_GROUP_TYPE_MASK
 |

885 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) &

886 
	`bŒfs_chunk_ty³
(
Ëaf
, 
chunk
));

887  -
EUCLEAN
;

890 ià(
	`uÆik–y
(!
	`has_sšgË_b™_£t
(
ty³
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) &&

891 (
ty³
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) != 0)) {

892 
	`chunk_”r
(
Ëaf
, 
chunk
, 
logiÿl
,

894 
ty³
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
);

895  -
EUCLEAN
;

897 ià(
	`uÆik–y
((
ty³
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
) == 0)) {

898 
	`chunk_”r
(
Ëaf
, 
chunk
, 
logiÿl
,

900 
ty³
, 
BTRFS_BLOCK_GROUP_TYPE_MASK
);

901  -
EUCLEAN
;

904 ià(
	`uÆik–y
((
ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) &&

905 (
ty³
 & (
BTRFS_BLOCK_GROUP_METADATA
 |

906 
BTRFS_BLOCK_GROUP_DATA
)))) {

907 
	`chunk_”r
(
Ëaf
, 
chunk
, 
logiÿl
,

909 
ty³
);

910  -
EUCLEAN
;

913 
ã©u»s
 = 
	`bŒfs_su³r_šcom·t_æags
(
fs_šfo
->
su³r_cİy
);

914 ià(
ã©u»s
 & 
BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
)

915 
mixed
 = 
Œue
;

917 ià(!
mixed
) {

918 ià(
	`uÆik–y
((
ty³
 & 
BTRFS_BLOCK_GROUP_METADATA
) &&

919 (
ty³
 & 
BTRFS_BLOCK_GROUP_DATA
))) {

920 
	`chunk_”r
(
Ëaf
, 
chunk
, 
logiÿl
,

921 "mixed chunky³ iÀnÚ-mixed mode: 0x%Îx", 
ty³
);

922  -
EUCLEAN
;

926 ià(
	`uÆik–y
((
ty³
 & 
BTRFS_BLOCK_GROUP_RAID10
 &&

927 
sub_¡res
 !ğ
bŒfs_¿id_¬¿y
[
BTRFS_RAID_RAID10
].sub_stripes) ||

928 (
ty³
 & 
BTRFS_BLOCK_GROUP_RAID1
 &&

929 
num_¡res
 !ğ
bŒfs_¿id_¬¿y
[
BTRFS_RAID_RAID1
].
devs_mš
) ||

930 (
ty³
 & 
BTRFS_BLOCK_GROUP_RAID1C3
 &&

931 
num_¡res
 !ğ
bŒfs_¿id_¬¿y
[
BTRFS_RAID_RAID1C3
].
devs_mš
) ||

932 (
ty³
 & 
BTRFS_BLOCK_GROUP_RAID1C4
 &&

933 
num_¡res
 !ğ
bŒfs_¿id_¬¿y
[
BTRFS_RAID_RAID1C4
].
devs_mš
) ||

934 (
ty³
 & 
BTRFS_BLOCK_GROUP_RAID5
 &&

935 
num_¡res
 < 
bŒfs_¿id_¬¿y
[
BTRFS_RAID_RAID5
].
devs_mš
) ||

936 (
ty³
 & 
BTRFS_BLOCK_GROUP_RAID6
 &&

937 
num_¡res
 < 
bŒfs_¿id_¬¿y
[
BTRFS_RAID_RAID6
].
devs_mš
) ||

938 (
ty³
 & 
BTRFS_BLOCK_GROUP_DUP
 &&

939 
num_¡res
 !ğ
bŒfs_¿id_¬¿y
[
BTRFS_RAID_DUP
].
dev_¡res
) ||

940 ((
ty³
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) == 0 &&

941 
num_¡res
 !ğ
bŒfs_¿id_¬¿y
[
BTRFS_RAID_SINGLE
].
dev_¡res
))) {

942 
	`chunk_”r
(
Ëaf
, 
chunk
, 
logiÿl
,

944 
num_¡res
, 
sub_¡res
,

945 
ty³
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
);

946  -
EUCLEAN
;

950 
	}
}

958 
	$check_Ëaf_chunk_™em
(
ex‹Á_bufãr
 *
Ëaf
,

959 
bŒfs_chunk
 *
chunk
,

960 
bŒfs_key
 *
key
, 
¦Ù
)

962 
num_¡res
;

964 ià(
	`uÆik–y
(
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
è< (
bŒfs_chunk
))) {

965 
	`chunk_”r
(
Ëaf
, 
chunk
, 
key
->
off£t
,

967 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
),

968 (
bŒfs_chunk
),

969 
	`BTRFS_LEAF_DATA_SIZE
(
Ëaf
->
fs_šfo
));

970  -
EUCLEAN
;

973 
num_¡res
 = 
	`bŒfs_chunk_num_¡res
(
Ëaf
, 
chunk
);

975 ià(
num_¡res
 == 0)

976 
out
;

978 ià(
	`uÆik–y
(
	`bŒfs_chunk_™em_size
(
num_¡res
) !=

979 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
))) {

980 
	`chunk_”r
(
Ëaf
, 
chunk
, 
key
->
off£t
,

982 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
),

983 
	`bŒfs_chunk_™em_size
(
num_¡res
));

984  -
EUCLEAN
;

986 
out
:

987  
	`bŒfs_check_chunk_v®id
(
Ëaf
, 
chunk
, 
key
->
off£t
);

988 
	}
}

990 
	$__´štf
(3, 4)

991 
__cŞd


992 
	$dev_™em_”r
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

993 cÚ¡ *
fmt
, ...)

995 
bŒfs_key
 
key
;

996 
va_fÜm©
 
vaf
;

997 
va_li¡
 
¬gs
;

999 
	`bŒfs_™em_key_to_ıu
(
eb
, &
key
, 
¦Ù
);

1000 
	`va_¡¬t
(
¬gs
, 
fmt
);

1002 
vaf
.
fmt
 = fmt;

1003 
vaf
.
va
 = &
¬gs
;

1005 
	`bŒfs_ü™
(
eb
->
fs_šfo
,

1007 
	`bŒfs_h—d”_Ëv–
(
eb
) == 0 ? "leaf" : "node",

1008 
	`bŒfs_h—d”_owÃr
(
eb
), 
	`bŒfs_h—d”_by‹Ä
Ób), 
¦Ù
,

1009 
key
.
objeùid
, &
vaf
);

1010 
	`va_’d
(
¬gs
);

1011 
	}
}

1013 
	$check_dev_™em
(
ex‹Á_bufãr
 *
Ëaf
,

1014 
bŒfs_key
 *
key
, 
¦Ù
)

1016 
bŒfs_dev_™em
 *
d™em
;

1017 cÚ¡ 
u32
 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

1020 ià(
	`uÆik–y
(
key
->
objeùid
 !ğ
BTRFS_DEV_ITEMS_OBJECTID
)) {

1021 
	`dev_™em_”r
(
Ëaf
, 
¦Ù
,

1023 
key
->
objeùid
, 
BTRFS_DEV_ITEMS_OBJECTID
);

1024  -
EUCLEAN
;

1027 ià(
	`uÆik–y
(
™em_size
 !ğ(*
d™em
))) {

1028 
	`dev_™em_”r
(
Ëaf
, 
¦Ù
, "invalid item size: has %uƒxpect %zu",

1029 
™em_size
, (*
d™em
));

1030  -
EUCLEAN
;

1033 
d™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_dev_™em
);

1034 ià(
	`uÆik–y
(
	`bŒfs_deviû_id
(
Ëaf
, 
d™em
è!ğ
key
->
off£t
)) {

1035 
	`dev_™em_”r
(
Ëaf
, 
¦Ù
,

1037 
key
->
off£t
, 
	`bŒfs_deviû_id
(
Ëaf
, 
d™em
));

1038  -
EUCLEAN
;

1049 ià(
	`uÆik–y
(
	`bŒfs_deviû_by‹s_u£d
(
Ëaf
, 
d™em
) >

1050 
	`bŒfs_deviû_tÙ®_by‹s
(
Ëaf
, 
d™em
))) {

1051 
	`dev_™em_”r
(
Ëaf
, 
¦Ù
,

1053 
	`bŒfs_deviû_by‹s_u£d
(
Ëaf
, 
d™em
),

1054 
	`bŒfs_deviû_tÙ®_by‹s
(
Ëaf
, 
d™em
));

1055  -
EUCLEAN
;

1064 
	}
}

1066 
	$check_šode_™em
(
ex‹Á_bufãr
 *
Ëaf
,

1067 
bŒfs_key
 *
key
, 
¦Ù
)

1069 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

1070 
bŒfs_šode_™em
 *
i™em
;

1071 
u64
 
su³r_g’
 = 
	`bŒfs_su³r_g’”©iÚ
(
fs_šfo
->
su³r_cİy
);

1072 
u32
 
v®id_mask
 = (
S_IFMT
 | 
S_ISUID
 | 
S_ISGID
 | 
S_ISVTX
 | 0777);

1073 cÚ¡ 
u32
 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

1074 
u32
 
mode
;

1075 
»t
;

1076 
u32
 
æags
;

1077 
u32
 
ro_æags
;

1079 
»t
 = 
	`check_šode_key
(
Ëaf
, 
key
, 
¦Ù
);

1080 ià(
	`uÆik–y
(
»t
 < 0))

1081  
»t
;

1083 ià(
	`uÆik–y
(
™em_size
 !ğ(*
i™em
))) {

1084 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
, "invalid item size: has %uƒxpect %zu",

1085 
™em_size
, (*
i™em
));

1086  -
EUCLEAN
;

1089 
i™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_šode_™em
);

1092 ià(
	`uÆik–y
(
	`bŒfs_šode_g’”©iÚ
(
Ëaf
, 
i™em
è> 
su³r_g’
 + 1)) {

1093 
	`šode_™em_”r
(
Ëaf
, 
¦Ù
,

1095 
	`bŒfs_šode_g’”©iÚ
(
Ëaf
, 
i™em
),

1096 
su³r_g’
 + 1);

1097  -
EUCLEAN
;

1100 ià(
	`uÆik–y
(
	`bŒfs_šode_Œªsid
(
Ëaf
, 
i™em
è> 
su³r_g’
 + 1)) {

1101 
	`šode_™em_”r
(
Ëaf
, 
¦Ù
,

1103 
	`bŒfs_šode_Œªsid
(
Ëaf
, 
i™em
), 
su³r_g’
 + 1);

1104  -
EUCLEAN
;

1112 
mode
 = 
	`bŒfs_šode_mode
(
Ëaf
, 
i™em
);

1113 ià(
	`uÆik–y
(
mode
 & ~
v®id_mask
)) {

1114 
	`šode_™em_”r
(
Ëaf
, 
¦Ù
,

1116 
mode
 & ~
v®id_mask
);

1117  -
EUCLEAN
;

1125 ià(!
	`has_sšgË_b™_£t
(
mode
 & 
S_IFMT
)) {

1126 ià(
	`uÆik–y
(!
	`S_ISLNK
(
mode
è&& !
	`S_ISBLK
(modeè&& !
	`S_ISSOCK
(mode))) {

1127 
	`šode_™em_”r
(
Ëaf
, 
¦Ù
,

1129 
mode
 & 
S_IFMT
);

1130  -
EUCLEAN
;

1133 ià(
	`uÆik–y
(
	`S_ISDIR
(
mode
è&& 
	`bŒfs_šode_Æšk
(
Ëaf
, 
i™em
) > 1)) {

1134 
	`šode_™em_”r
(
Ëaf
, 
¦Ù
,

1136 
	`bŒfs_šode_Æšk
(
Ëaf
, 
i™em
));

1137  -
EUCLEAN
;

1139 
	`bŒfs_šode_¥l™_æags
(
	`bŒfs_šode_æags
(
Ëaf
, 
i™em
), &
æags
, &
ro_æags
);

1140 ià(
	`uÆik–y
(
æags
 & ~
BTRFS_INODE_FLAG_MASK
)) {

1141 
	`šode_™em_”r
(
Ëaf
, 
¦Ù
,

1142 "unknowÀšcom·ˆæag d‘eùed: 0x%x", 
æags
);

1143  -
EUCLEAN
;

1145 ià(
	`uÆik–y
(!
	`sb_rdÚly
(
fs_šfo
->
sb
) &&

1146 (
ro_æags
 & ~
BTRFS_INODE_RO_FLAG_MASK
))) {

1147 
	`šode_™em_”r
(
Ëaf
, 
¦Ù
,

1149 
ro_æags
);

1150  -
EUCLEAN
;

1153 
	}
}

1155 
	$check_roÙ_™em
(
ex‹Á_bufãr
 *
Ëaf
, 
bŒfs_key
 *
key
,

1156 
¦Ù
)

1158 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

1159 
bŒfs_roÙ_™em
 
ri
 = { 0 };

1160 cÚ¡ 
u64
 
v®id_roÙ_æags
 = 
BTRFS_ROOT_SUBVOL_RDONLY
 |

1161 
BTRFS_ROOT_SUBVOL_DEAD
;

1162 
»t
;

1164 
»t
 = 
	`check_roÙ_key
(
Ëaf
, 
key
, 
¦Ù
);

1165 ià(
	`uÆik–y
(
»t
 < 0))

1166  
»t
;

1168 ià(
	`uÆik–y
(
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
è!ğ(
ri
) &&

1169 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
) !=

1170 
	`bŒfs_Ëgacy_roÙ_™em_size
())) {

1171 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1173 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
), (
ri
),

1174 
	`bŒfs_Ëgacy_roÙ_™em_size
());

1175  -
EUCLEAN
;

1183 
	`»ad_ex‹Á_bufãr
(
Ëaf
, &
ri
, 
	`bŒfs_™em_±r_off£t
Ö—f, 
¦Ù
),

1184 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
));

1187 ià(
	`uÆik–y
(
	`bŒfs_roÙ_g’”©iÚ
(&
ri
) >

1188 
	`bŒfs_su³r_g’”©iÚ
(
fs_šfo
->
su³r_cİy
) + 1)) {

1189 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1191 
	`bŒfs_roÙ_g’”©iÚ
(&
ri
),

1192 
	`bŒfs_su³r_g’”©iÚ
(
fs_šfo
->
su³r_cİy
) + 1);

1193  -
EUCLEAN
;

1195 ià(
	`uÆik–y
(
	`bŒfs_roÙ_g’”©iÚ_v2
(&
ri
) >

1196 
	`bŒfs_su³r_g’”©iÚ
(
fs_šfo
->
su³r_cİy
) + 1)) {

1197 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1199 
	`bŒfs_roÙ_g’”©iÚ_v2
(&
ri
),

1200 
	`bŒfs_su³r_g’”©iÚ
(
fs_šfo
->
su³r_cİy
) + 1);

1201  -
EUCLEAN
;

1203 ià(
	`uÆik–y
(
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
ri
) >

1204 
	`bŒfs_su³r_g’”©iÚ
(
fs_šfo
->
su³r_cİy
) + 1)) {

1205 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1207 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
ri
),

1208 
	`bŒfs_su³r_g’”©iÚ
(
fs_šfo
->
su³r_cİy
) + 1);

1209  -
EUCLEAN
;

1213 ià(
	`uÆik–y
(!
	`IS_ALIGNED
(
	`bŒfs_roÙ_by‹Ä
(&
ri
), 
fs_šfo
->
£ùÜsize
))) {

1214 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1216 
	`bŒfs_roÙ_by‹Ä
(&
ri
), 
fs_šfo
->
£ùÜsize
);

1217  -
EUCLEAN
;

1219 ià(
	`uÆik–y
(
	`bŒfs_roÙ_Ëv–
(&
ri
è>ğ
BTRFS_MAX_LEVEL
)) {

1220 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1222 
	`bŒfs_roÙ_Ëv–
(&
ri
), 
BTRFS_MAX_LEVEL
 - 1);

1223  -
EUCLEAN
;

1225 ià(
	`uÆik–y
(
	`bŒfs_roÙ_drİ_Ëv–
(&
ri
è>ğ
BTRFS_MAX_LEVEL
)) {

1226 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1228 
	`bŒfs_roÙ_drİ_Ëv–
(&
ri
), 
BTRFS_MAX_LEVEL
 - 1);

1229  -
EUCLEAN
;

1233 ià(
	`uÆik–y
(
	`bŒfs_roÙ_æags
(&
ri
è& ~
v®id_roÙ_æags
)) {

1234 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1236 
	`bŒfs_roÙ_æags
(&
ri
), 
v®id_roÙ_æags
);

1237  -
EUCLEAN
;

1240 
	}
}

1242 
	$__´štf
(3,4)

1243 
__cŞd


1244 
	$ex‹Á_”r
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

1245 cÚ¡ *
fmt
, ...)

1247 
bŒfs_key
 
key
;

1248 
va_fÜm©
 
vaf
;

1249 
va_li¡
 
¬gs
;

1250 
u64
 
by‹Ä
;

1251 
u64
 
Ën
;

1253 
	`bŒfs_™em_key_to_ıu
(
eb
, &
key
, 
¦Ù
);

1254 
by‹Ä
 = 
key
.
objeùid
;

1255 ià(
key
.
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
 ||

1256 
key
.
ty³
 =ğ
BTRFS_TREE_BLOCK_REF_KEY
 ||

1257 
key
.
ty³
 =ğ
BTRFS_SHARED_BLOCK_REF_KEY
)

1258 
Ën
 = 
eb
->
fs_šfo
->
nodesize
;

1260 
Ën
 = 
key
.
off£t
;

1261 
	`va_¡¬t
(
¬gs
, 
fmt
);

1263 
vaf
.
fmt
 = fmt;

1264 
vaf
.
va
 = &
¬gs
;

1266 
	`bŒfs_ü™
(
eb
->
fs_šfo
,

1268 
	`bŒfs_h—d”_Ëv–
(
eb
) == 0 ? "leaf" : "node",

1269 
eb
->
¡¬t
, 
¦Ù
, 
by‹Ä
, 
Ën
, &
vaf
);

1270 
	`va_’d
(
¬gs
);

1271 
	}
}

1273 
	$check_ex‹Á_™em
(
ex‹Á_bufãr
 *
Ëaf
,

1274 
bŒfs_key
 *
key
, 
¦Ù
,

1275 
bŒfs_key
 *
´ev_key
)

1277 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

1278 
bŒfs_ex‹Á_™em
 *
ei
;

1279 
boŞ
 
is_Œ“_block
 = 
çl£
;

1280 
±r
;

1281 
’d
;

1282 cÚ¡ 
u32
 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

1283 
u64
 
æags
;

1284 
u64
 
g’”©iÚ
;

1285 
u64
 
tÙ®_»fs
;

1286 
u64
 
šlše_»fs
 = 0;

1288 ià(
	`uÆik–y
(
key
->
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
 &&

1289 !
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
))) {

1290 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1292  -
EUCLEAN
;

1295 ià(
	`uÆik–y
(!
	`IS_ALIGNED
(
key
->
objeùid
, 
fs_šfo
->
£ùÜsize
))) {

1296 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1298 
key
->
objeùid
, 
fs_šfo
->
£ùÜsize
);

1299  -
EUCLEAN
;

1303 ià(
	`uÆik–y
(
key
->
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
 &&

1304 
key
->
off£t
 >ğ
BTRFS_MAX_LEVEL
)) {

1305 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1307 
key
->
off£t
, 
BTRFS_MAX_LEVEL
 - 1);

1308  -
EUCLEAN
;

1330 ià(
	`uÆik–y
(
™em_size
 < (*
ei
))) {

1331 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1333 
™em_size
, (*
ei
),

1334 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
));

1335  -
EUCLEAN
;

1337 
’d
 = 
™em_size
 + 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
);

1340 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_ex‹Á_™em
);

1341 
æags
 = 
	`bŒfs_ex‹Á_æags
(
Ëaf
, 
ei
);

1342 
tÙ®_»fs
 = 
	`bŒfs_ex‹Á_»fs
(
Ëaf
, 
ei
);

1343 
g’”©iÚ
 = 
	`bŒfs_ex‹Á_g’”©iÚ
(
Ëaf
, 
ei
);

1344 ià(
	`uÆik–y
(
g’”©iÚ
 >

1345 
	`bŒfs_su³r_g’”©iÚ
(
fs_šfo
->
su³r_cİy
) + 1)) {

1346 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1348 
g’”©iÚ
,

1349 
	`bŒfs_su³r_g’”©iÚ
(
fs_šfo
->
su³r_cİy
) + 1);

1350  -
EUCLEAN
;

1352 ià(
	`uÆik–y
(!
	`has_sšgË_b™_£t
(
æags
 & (
BTRFS_EXTENT_FLAG_DATA
 |

1353 
BTRFS_EXTENT_FLAG_TREE_BLOCK
)))) {

1354 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1356 
æags
, 
BTRFS_EXTENT_FLAG_DATA
 |

1357 
BTRFS_EXTENT_FLAG_TREE_BLOCK
);

1358  -
EUCLEAN
;

1360 
is_Œ“_block
 = !!(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
);

1361 ià(
is_Œ“_block
) {

1362 ià(
	`uÆik–y
(
key
->
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
 &&

1363 
key
->
off£t
 !ğ
fs_šfo
->
nodesize
)) {

1364 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1366 
key
->
off£t
, 
fs_šfo
->
nodesize
);

1367  -
EUCLEAN
;

1370 ià(
	`uÆik–y
(
key
->
ty³
 !ğ
BTRFS_EXTENT_ITEM_KEY
)) {

1371 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1373 
key
->
ty³
, 
BTRFS_EXTENT_ITEM_KEY
);

1374  -
EUCLEAN
;

1376 ià(
	`uÆik–y
(!
	`IS_ALIGNED
(
key
->
off£t
, 
fs_šfo
->
£ùÜsize
))) {

1377 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1379 
key
->
off£t
, 
fs_šfo
->
£ùÜsize
);

1380  -
EUCLEAN
;

1382 ià(
	`uÆik–y
(
æags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
)) {

1383 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1385  -
EUCLEAN
;

1388 
±r
 = ()(
bŒfs_ex‹Á_™em
 *)(
ei
 + 1);

1391 ià(
is_Œ“_block
 && 
key
->
ty³
 !ğ
BTRFS_METADATA_ITEM_KEY
) {

1392 
bŒfs_Œ“_block_šfo
 *
šfo
;

1394 
šfo
 = (
bŒfs_Œ“_block_šfo
 *)
±r
;

1395 ià(
	`uÆik–y
(
	`bŒfs_Œ“_block_Ëv–
(
Ëaf
, 
šfo
è>ğ
BTRFS_MAX_LEVEL
)) {

1396 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1398 
	`bŒfs_Œ“_block_Ëv–
(
Ëaf
, 
šfo
),

1399 
BTRFS_MAX_LEVEL
 - 1);

1400  -
EUCLEAN
;

1402 
±r
 = ()(
bŒfs_Œ“_block_šfo
 *)(
šfo
 + 1);

1406 
±r
 < 
’d
) {

1407 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

1408 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

1409 
bŒfs_sh¬ed_d©a_»f
 *
¤ef
;

1410 
u64
 
d»f_off£t
;

1411 
u64
 
šlše_off£t
;

1412 
u8
 
šlše_ty³
;

1414 ià(
	`uÆik–y
(
±r
 + (*
œef
è> 
’d
)) {

1415 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1417 
±r
, (*
œef
), 
’d
);

1418  -
EUCLEAN
;

1420 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)
±r
;

1421 
šlše_ty³
 = 
	`bŒfs_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
);

1422 
šlše_off£t
 = 
	`bŒfs_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
);

1423 ià(
	`uÆik–y
(
±r
 + 
	`bŒfs_ex‹Á_šlše_»f_size
(
šlše_ty³
è> 
’d
)) {

1424 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1426 
±r
, 
šlše_ty³
, 
’d
);

1427  -
EUCLEAN
;

1430 
šlše_ty³
) {

1432 
BTRFS_TREE_BLOCK_REF_KEY
:

1433 
šlše_»fs
++;

1436 
BTRFS_SHARED_BLOCK_REF_KEY
:

1437 ià(
	`uÆik–y
(!
	`IS_ALIGNED
(
šlše_off£t
,

1438 
fs_šfo
->
£ùÜsize
))) {

1439 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1441 
šlše_off£t
, 
fs_šfo
->
£ùÜsize
);

1442  -
EUCLEAN
;

1444 
šlše_»fs
++;

1450 
BTRFS_EXTENT_DATA_REF_KEY
:

1451 
d»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

1452 
d»f_off£t
 = 
	`bŒfs_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
d»f
);

1453 ià(
	`uÆik–y
(!
	`IS_ALIGNED
(
d»f_off£t
,

1454 
fs_šfo
->
£ùÜsize
))) {

1455 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1457 
d»f_off£t
, 
fs_šfo
->
£ùÜsize
);

1458  -
EUCLEAN
;

1460 
šlše_»fs
 +ğ
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
d»f
);

1463 
BTRFS_SHARED_DATA_REF_KEY
:

1464 
¤ef
 = (
bŒfs_sh¬ed_d©a_»f
 *)(
œef
 + 1);

1465 ià(
	`uÆik–y
(!
	`IS_ALIGNED
(
šlše_off£t
,

1466 
fs_šfo
->
£ùÜsize
))) {

1467 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1469 
šlše_off£t
, 
fs_šfo
->
£ùÜsize
);

1470  -
EUCLEAN
;

1472 
šlše_»fs
 +ğ
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
¤ef
);

1475 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
, "unknown inline„efype: %u",

1476 
šlše_ty³
);

1477  -
EUCLEAN
;

1479 
±r
 +ğ
	`bŒfs_ex‹Á_šlše_»f_size
(
šlše_ty³
);

1482 ià(
	`uÆik–y
(
±r
 !ğ
’d
)) {

1483 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1485  -
EUCLEAN
;

1489 ià(
	`uÆik–y
(
šlše_»fs
 > 
tÙ®_»fs
)) {

1490 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1492 
tÙ®_»fs
, 
šlše_»fs
);

1493  -
EUCLEAN
;

1496 ià((
´ev_key
->
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
) ||

1497 (
´ev_key
->
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
)) {

1498 
u64
 
´ev_’d
 = 
´ev_key
->
objeùid
;

1500 ià(
´ev_key
->
ty³
 =ğ
BTRFS_METADATA_ITEM_KEY
)

1501 
´ev_’d
 +ğ
fs_šfo
->
nodesize
;

1503 
´ev_’d
 +ğ
´ev_key
->
off£t
;

1505 ià(
	`uÆik–y
(
´ev_’d
 > 
key
->
objeùid
)) {

1506 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1508 
´ev_key
->
objeùid
,…»v_key->
ty³
,

1509 
´ev_key
->
off£t
, 
key
->
objeùid
, key->
ty³
,

1510 
key
->
off£t
);

1511  -
EUCLEAN
;

1516 
	}
}

1518 
	$check_sim¶e_keyed_»fs
(
ex‹Á_bufãr
 *
Ëaf
,

1519 
bŒfs_key
 *
key
, 
¦Ù
)

1521 
u32
 
ex³ù_™em_size
 = 0;

1523 ià(
key
->
ty³
 =ğ
BTRFS_SHARED_DATA_REF_KEY
)

1524 
ex³ù_™em_size
 = (
bŒfs_sh¬ed_d©a_»f
);

1526 ià(
	`uÆik–y
(
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
è!ğ
ex³ù_™em_size
)) {

1527 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1529 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
),

1530 
ex³ù_™em_size
, 
key
->
ty³
);

1531  -
EUCLEAN
;

1533 ià(
	`uÆik–y
(!
	`IS_ALIGNED
(
key
->
objeùid
, 
Ëaf
->
fs_šfo
->
£ùÜsize
))) {

1534 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1536 
key
->
objeùid
, 
Ëaf
->
fs_šfo
->
£ùÜsize
);

1537  -
EUCLEAN
;

1539 ià(
	`uÆik–y
(
key
->
ty³
 !ğ
BTRFS_TREE_BLOCK_REF_KEY
 &&

1540 !
	`IS_ALIGNED
(
key
->
off£t
, 
Ëaf
->
fs_šfo
->
£ùÜsize
))) {

1541 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1543 
key
->
off£t
, 
Ëaf
->
fs_šfo
->
£ùÜsize
);

1544  -
EUCLEAN
;

1547 
	}
}

1549 
	$check_ex‹Á_d©a_»f
(
ex‹Á_bufãr
 *
Ëaf
,

1550 
bŒfs_key
 *
key
, 
¦Ù
)

1552 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

1553 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
);

1554 cÚ¡ 
’d
 = 
±r
 + 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

1556 ià(
	`uÆik–y
(
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
è% (*
d»f
) != 0)) {

1557 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1559 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
),

1560 (*
d»f
), 
key
->
ty³
);

1561  -
EUCLEAN
;

1563 ià(
	`uÆik–y
(!
	`IS_ALIGNED
(
key
->
objeùid
, 
Ëaf
->
fs_šfo
->
£ùÜsize
))) {

1564 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1566 
key
->
objeùid
, 
Ëaf
->
fs_šfo
->
£ùÜsize
);

1567  -
EUCLEAN
;

1569 ; 
±r
 < 
’d
;…Œ +ğ(*
d»f
)) {

1570 
u64
 
off£t
;

1576 
d»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)
±r
;

1577 
off£t
 = 
	`bŒfs_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
d»f
);

1578 ià(
	`uÆik–y
(!
	`IS_ALIGNED
(
off£t
, 
Ëaf
->
fs_šfo
->
£ùÜsize
))) {

1579 
	`ex‹Á_”r
(
Ëaf
, 
¦Ù
,

1581 
off£t
, 
Ëaf
->
fs_šfo
->
£ùÜsize
);

1582  -
EUCLEAN
;

1586 
	}
}

1588 
	#šode_»f_”r
(
eb
, 
¦Ù
, 
fmt
, 
¬gs
...) \

1589 
	`šode_™em_”r
(
eb
, 
¦Ù
, 
fmt
, ##
¬gs
)

	)

1590 
	$check_šode_»f
(
ex‹Á_bufãr
 *
Ëaf
,

1591 
bŒfs_key
 *
key
, bŒfs_key *
´ev_key
,

1592 
¦Ù
)

1594 
bŒfs_šode_»f
 *
œef
;

1595 
±r
;

1596 
’d
;

1598 ià(
	`uÆik–y
(!
	`check_´ev_šo
(
Ëaf
, 
key
, 
¦Ù
, 
´ev_key
)))

1599  -
EUCLEAN
;

1601 ià(
	`uÆik–y
(
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
è<ğ(*
œef
))) {

1602 
	`šode_»f_”r
(
Ëaf
, 
¦Ù
,

1604 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
),

1605 (*
œef
), 
	`BTRFS_LEAF_DATA_SIZE
(
Ëaf
->
fs_šfo
));

1606  -
EUCLEAN
;

1609 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
);

1610 
’d
 = 
±r
 + 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

1611 
±r
 < 
’d
) {

1612 
u16
 
Çm–’
;

1614 ià(
	`uÆik–y
(
±r
 + (
œef
è> 
’d
)) {

1615 
	`šode_»f_”r
(
Ëaf
, 
¦Ù
,

1617 
±r
, 
’d
, (
œef
));

1618  -
EUCLEAN
;

1621 
œef
 = (
bŒfs_šode_»f
 *)
±r
;

1622 
Çm–’
 = 
	`bŒfs_šode_»f_Çme_Ën
(
Ëaf
, 
œef
);

1623 ià(
	`uÆik–y
(
±r
 + (*
œef
è+ 
Çm–’
 > 
’d
)) {

1624 
	`šode_»f_”r
(
Ëaf
, 
¦Ù
,

1626 
±r
, 
’d
, 
Çm–’
);

1627  -
EUCLEAN
;

1635 
±r
 +ğ(*
œef
è+ 
Çm–’
;

1638 
	}
}

1643 
bŒfs_Œ“_block_¡©us
 
	$check_Ëaf_™em
(
ex‹Á_bufãr
 *
Ëaf
,

1644 
bŒfs_key
 *
key
,

1645 
¦Ù
,

1646 
bŒfs_key
 *
´ev_key
)

1648 
»t
 = 0;

1649 
bŒfs_chunk
 *
chunk
;

1651 
key
->
ty³
) {

1652 
BTRFS_EXTENT_DATA_KEY
:

1653 
»t
 = 
	`check_ex‹Á_d©a_™em
(
Ëaf
, 
key
, 
¦Ù
, 
´ev_key
);

1655 
BTRFS_EXTENT_CSUM_KEY
:

1656 
»t
 = 
	`check_csum_™em
(
Ëaf
, 
key
, 
¦Ù
, 
´ev_key
);

1658 
BTRFS_DIR_ITEM_KEY
:

1659 
BTRFS_DIR_INDEX_KEY
:

1660 
BTRFS_XATTR_ITEM_KEY
:

1661 
»t
 = 
	`check_dœ_™em
(
Ëaf
, 
key
, 
´ev_key
, 
¦Ù
);

1663 
BTRFS_INODE_REF_KEY
:

1664 
»t
 = 
	`check_šode_»f
(
Ëaf
, 
key
, 
´ev_key
, 
¦Ù
);

1666 
BTRFS_BLOCK_GROUP_ITEM_KEY
:

1667 
»t
 = 
	`check_block_group_™em
(
Ëaf
, 
key
, 
¦Ù
);

1669 
BTRFS_CHUNK_ITEM_KEY
:

1670 
chunk
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_chunk
);

1671 
»t
 = 
	`check_Ëaf_chunk_™em
(
Ëaf
, 
chunk
, 
key
, 
¦Ù
);

1673 
BTRFS_DEV_ITEM_KEY
:

1674 
»t
 = 
	`check_dev_™em
(
Ëaf
, 
key
, 
¦Ù
);

1676 
BTRFS_INODE_ITEM_KEY
:

1677 
»t
 = 
	`check_šode_™em
(
Ëaf
, 
key
, 
¦Ù
);

1679 
BTRFS_ROOT_ITEM_KEY
:

1680 
»t
 = 
	`check_roÙ_™em
(
Ëaf
, 
key
, 
¦Ù
);

1682 
BTRFS_EXTENT_ITEM_KEY
:

1683 
BTRFS_METADATA_ITEM_KEY
:

1684 
»t
 = 
	`check_ex‹Á_™em
(
Ëaf
, 
key
, 
¦Ù
, 
´ev_key
);

1686 
BTRFS_TREE_BLOCK_REF_KEY
:

1687 
BTRFS_SHARED_DATA_REF_KEY
:

1688 
BTRFS_SHARED_BLOCK_REF_KEY
:

1689 
»t
 = 
	`check_sim¶e_keyed_»fs
(
Ëaf
, 
key
, 
¦Ù
);

1691 
BTRFS_EXTENT_DATA_REF_KEY
:

1692 
»t
 = 
	`check_ex‹Á_d©a_»f
(
Ëaf
, 
key
, 
¦Ù
);

1696 ià(
»t
)

1697  
BTRFS_TREE_BLOCK_INVALID_ITEM
;

1698  
BTRFS_TREE_BLOCK_CLEAN
;

1699 
	}
}

1701 
bŒfs_Œ“_block_¡©us
 
	$__bŒfs_check_Ëaf
(
ex‹Á_bufãr
 *
Ëaf
)

1703 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

1705 
bŒfs_key
 
´ev_key
 = {0, 0, 0};

1706 
bŒfs_key
 
key
;

1707 
u32
 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

1708 
¦Ù
;

1710 ià(
	`uÆik–y
(
	`bŒfs_h—d”_Ëv–
(
Ëaf
) != 0)) {

1711 
	`g’”ic_”r
(
Ëaf
, 0,

1713 
	`bŒfs_h—d”_Ëv–
(
Ëaf
));

1714  
BTRFS_TREE_BLOCK_INVALID_LEVEL
;

1725 ià(
Ä™ems
 =ğ0 && !
	`bŒfs_h—d”_æag
(
Ëaf
, 
BTRFS_HEADER_FLAG_RELOC
)) {

1726 
u64
 
owÃr
 = 
	`bŒfs_h—d”_owÃr
(
Ëaf
);

1729 ià(
	`uÆik–y
(
owÃr
 =ğ
BTRFS_ROOT_TREE_OBJECTID
 ||

1730 
owÃr
 =ğ
BTRFS_CHUNK_TREE_OBJECTID
 ||

1731 
owÃr
 =ğ
BTRFS_DEV_TREE_OBJECTID
 ||

1732 
owÃr
 =ğ
BTRFS_FS_TREE_OBJECTID
 ||

1733 
owÃr
 =ğ
BTRFS_DATA_RELOC_TREE_OBJECTID
)) {

1734 
	`g’”ic_”r
(
Ëaf
, 0,

1736 
owÃr
);

1737  
BTRFS_TREE_BLOCK_INVALID_NRITEMS
;

1741 ià(
	`uÆik–y
(
owÃr
 == 0)) {

1742 
	`g’”ic_”r
(
Ëaf
, 0,

1744  
BTRFS_TREE_BLOCK_INVALID_OWNER
;

1748 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
EXTENT_TREE_V2
))

1749  
BTRFS_TREE_BLOCK_CLEAN
;

1751 ià(
	`uÆik–y
(
owÃr
 =ğ
BTRFS_EXTENT_TREE_OBJECTID
)) {

1752 
	`g’”ic_”r
(
Ëaf
, 0,

1754 
owÃr
);

1755  
BTRFS_TREE_BLOCK_INVALID_NRITEMS
;

1758  
BTRFS_TREE_BLOCK_CLEAN
;

1761 ià(
	`uÆik–y
(
Ä™ems
 == 0))

1762  
BTRFS_TREE_BLOCK_CLEAN
;

1775 
¦Ù
 = 0; slÙ < 
Ä™ems
; slot++) {

1776 
u32
 
™em_’d_ex³ùed
;

1777 
u64
 
™em_d©a_’d
;

1779 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

1782 ià(
	`uÆik–y
(
	`bŒfs_comp_ıu_keys
(&
´ev_key
, &
key
) >= 0)) {

1783 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1785 
´ev_key
.
objeùid
,…»v_key.
ty³
,

1786 
´ev_key
.
off£t
, 
key
.
objeùid
, key.
ty³
,

1787 
key
.
off£t
);

1788  
BTRFS_TREE_BLOCK_BAD_KEY_ORDER
;

1791 
™em_d©a_’d
 = (
u64
)
	`bŒfs_™em_off£t
(
Ëaf
, 
¦Ù
) +

1792 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

1798 ià(
¦Ù
 == 0)

1799 
™em_’d_ex³ùed
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
);

1801 
™em_’d_ex³ùed
 = 
	`bŒfs_™em_off£t
(
Ëaf
,

1802 
¦Ù
 - 1);

1803 ià(
	`uÆik–y
(
™em_d©a_’d
 !ğ
™em_’d_ex³ùed
)) {

1804 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1806 
™em_d©a_’d
, 
™em_’d_ex³ùed
);

1807  
BTRFS_TREE_BLOCK_INVALID_OFFSETS
;

1815 ià(
	`uÆik–y
(
™em_d©a_’d
 > 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
))) {

1816 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1818 
™em_d©a_’d
, 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
));

1819  
BTRFS_TREE_BLOCK_INVALID_OFFSETS
;

1823 ià(
	`uÆik–y
(
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
) <

1824 
	`bŒfs_™em_Ä_off£t
(
Ëaf
, 
¦Ù
è+ (
bŒfs_™em
))) {

1825 
	`g’”ic_”r
(
Ëaf
, 
¦Ù
,

1827 
	`bŒfs_™em_Ä_off£t
(
Ëaf
, 
¦Ù
) +

1828 (
bŒfs_™em
),

1829 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
));

1830  
BTRFS_TREE_BLOCK_INVALID_OFFSETS
;

1837 ià(
	`bŒfs_h—d”_æag
(
Ëaf
, 
BTRFS_HEADER_FLAG_WRITTEN
)) {

1838 
bŒfs_Œ“_block_¡©us
 
»t
;

1844 
»t
 = 
	`check_Ëaf_™em
(
Ëaf
, &
key
, 
¦Ù
, &
´ev_key
);

1845 ià(
	`uÆik–y
(
»t
 !ğ
BTRFS_TREE_BLOCK_CLEAN
))

1846  
»t
;

1849 
´ev_key
.
objeùid
 = 
key
.objectid;

1850 
´ev_key
.
ty³
 = 
key
.type;

1851 
´ev_key
.
off£t
 = 
key
.offset;

1854  
BTRFS_TREE_BLOCK_CLEAN
;

1855 
	}
}

1857 
	$bŒfs_check_Ëaf
(
ex‹Á_bufãr
 *
Ëaf
)

1859 
bŒfs_Œ“_block_¡©us
 
»t
;

1861 
»t
 = 
	`__bŒfs_check_Ëaf
(
Ëaf
);

1862 ià(
	`uÆik–y
(
»t
 !ğ
BTRFS_TREE_BLOCK_CLEAN
))

1863  -
EUCLEAN
;

1865 
	}
}

1866 
ALLOW_ERROR_INJECTION
(
bŒfs_check_Ëaf
, 
ERRNO
);

1868 
bŒfs_Œ“_block_¡©us
 
	$__bŒfs_check_node
(
ex‹Á_bufãr
 *
node
)

1870 
bŒfs_fs_šfo
 *
fs_šfo
 = 
node
->fs_info;

1871 
Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
node
);

1872 
bŒfs_key
 
key
, 
Ãxt_key
;

1873 
¦Ù
;

1874 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
node
);

1875 
u64
 
by‹Ä
;

1877 ià(
	`uÆik–y
(
Ëv–
 <ğ0 ||†ev– >ğ
BTRFS_MAX_LEVEL
)) {

1878 
	`g’”ic_”r
(
node
, 0,

1880 
Ëv–
, 
BTRFS_MAX_LEVEL
 - 1);

1881  
BTRFS_TREE_BLOCK_INVALID_LEVEL
;

1883 ià(
	`uÆik–y
(
Ä
 =ğ0 ||‚¸> 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
))) {

1884 
	`bŒfs_ü™
(
fs_šfo
,

1886 
	`bŒfs_h—d”_owÃr
(
node
),‚ode->
¡¬t
,

1887 
Ä
 == 0 ? "small" : "large",‚r,

1888 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
));

1889  
BTRFS_TREE_BLOCK_INVALID_NRITEMS
;

1892 
¦Ù
 = 0; slÙ < 
Ä
 - 1; slot++) {

1893 
by‹Ä
 = 
	`bŒfs_node_block±r
(
node
, 
¦Ù
);

1894 
	`bŒfs_node_key_to_ıu
(
node
, &
key
, 
¦Ù
);

1895 
	`bŒfs_node_key_to_ıu
(
node
, &
Ãxt_key
, 
¦Ù
 + 1);

1897 ià(
	`uÆik–y
(!
by‹Ä
)) {

1898 
	`g’”ic_”r
(
node
, 
¦Ù
,

1900  
BTRFS_TREE_BLOCK_INVALID_BLOCKPTR
;

1902 ià(
	`uÆik–y
(!
	`IS_ALIGNED
(
by‹Ä
, 
fs_šfo
->
£ùÜsize
))) {

1903 
	`g’”ic_”r
(
node
, 
¦Ù
,

1905 
by‹Ä
, 
fs_šfo
->
£ùÜsize
);

1906  
BTRFS_TREE_BLOCK_INVALID_BLOCKPTR
;

1909 ià(
	`uÆik–y
(
	`bŒfs_comp_ıu_keys
(&
key
, &
Ãxt_key
) >= 0)) {

1910 
	`g’”ic_”r
(
node
, 
¦Ù
,

1912 
key
.
objeùid
, key.
ty³
, key.
off£t
,

1913 
Ãxt_key
.
objeùid
,‚ext_key.
ty³
,

1914 
Ãxt_key
.
off£t
);

1915  
BTRFS_TREE_BLOCK_BAD_KEY_ORDER
;

1918  
BTRFS_TREE_BLOCK_CLEAN
;

1919 
	}
}

1921 
	$bŒfs_check_node
(
ex‹Á_bufãr
 *
node
)

1923 
bŒfs_Œ“_block_¡©us
 
»t
;

1925 
»t
 = 
	`__bŒfs_check_node
(
node
);

1926 ià(
	`uÆik–y
(
»t
 !ğ
BTRFS_TREE_BLOCK_CLEAN
))

1927  -
EUCLEAN
;

1929 
	}
}

1930 
ALLOW_ERROR_INJECTION
(
bŒfs_check_node
, 
ERRNO
);

1932 
	$bŒfs_check_eb_owÃr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
u64
 
roÙ_owÃr
)

1934 cÚ¡ 
boŞ
 
is_subvŞ
 = 
	`is_f¡»e
(
roÙ_owÃr
);

1935 cÚ¡ 
u64
 
eb_owÃr
 = 
	`bŒfs_h—d”_owÃr
(
eb
);

1941 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
eb
->
fs_šfo
->
fs_¡©e
))

1949 ià(
roÙ_owÃr
 == 0)

1955 ià(
roÙ_owÃr
 =ğ
BTRFS_TREE_LOG_OBJECTID
 ||

1956 
roÙ_owÃr
 =ğ
BTRFS_TREE_RELOC_OBJECTID
)

1959 ià(!
is_subvŞ
) {

1961 ià(
	`uÆik–y
(
roÙ_owÃr
 !ğ
eb_owÃr
)) {

1962 
	`bŒfs_ü™
(
eb
->
fs_šfo
,

1964 
	`bŒfs_h—d”_Ëv–
(
eb
) == 0 ? "leaf" : "node",

1965 
roÙ_owÃr
, 
	`bŒfs_h—d”_by‹Ä
(
eb
), 
eb_owÃr
,

1966 
roÙ_owÃr
);

1967  -
EUCLEAN
;

1976 ià(
	`uÆik–y
(
is_subvŞ
 !ğ
	`is_f¡»e
(
eb_owÃr
))) {

1977 
	`bŒfs_ü™
(
eb
->
fs_šfo
,

1979 
	`bŒfs_h—d”_Ëv–
(
eb
) == 0 ? "leaf" : "node",

1980 
roÙ_owÃr
, 
	`bŒfs_h—d”_by‹Ä
(
eb
), 
eb_owÃr
,

1981 
BTRFS_FIRST_FREE_OBJECTID
, 
BTRFS_LAST_FREE_OBJECTID
);

1982  -
EUCLEAN
;

1985 
	}
}

1987 
	$bŒfs_v”ify_Ëv–_key
(
ex‹Á_bufãr
 *
eb
, 
Ëv–
,

1988 
bŒfs_key
 *
fœ¡_key
, 
u64
 
·»Á_Œªsid
)

1990 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

1991 
found_Ëv–
;

1992 
bŒfs_key
 
found_key
;

1993 
»t
;

1995 
found_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
eb
);

1996 ià(
found_Ëv–
 !ğ
Ëv–
) {

1997 
	`WARN
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
),

1998 
KERN_ERR
 "BTRFS:ree†evel check failed\n");

1999 
	`bŒfs_”r
(
fs_šfo
,

2001 
eb
->
¡¬t
, 
Ëv–
, 
found_Ëv–
);

2002  -
EIO
;

2005 ià(!
fœ¡_key
)

2014 ià(
	`bŒfs_h—d”_g’”©iÚ
(
eb
è> 
fs_šfo
->
Ï¡_Œªs_comm™‹d
)

2018 ià(
	`bŒfs_h—d”_Ä™ems
(
eb
) == 0) {

2019 
	`bŒfs_”r
(
fs_šfo
,

2021 
eb
->
¡¬t
);

2022 
	`WARN_ON
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
));

2023  -
EUCLEAN
;

2026 ià(
found_Ëv–
)

2027 
	`bŒfs_node_key_to_ıu
(
eb
, &
found_key
, 0);

2029 
	`bŒfs_™em_key_to_ıu
(
eb
, &
found_key
, 0);

2030 
»t
 = 
	`bŒfs_comp_ıu_keys
(
fœ¡_key
, &
found_key
);

2032 ià(
»t
) {

2033 
	`WARN
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
),

2034 
KERN_ERR
 "BTRFS:ree first key check failed\n");

2035 
	`bŒfs_”r
(
fs_šfo
,

2037 
eb
->
¡¬t
, 
·»Á_Œªsid
, 
fœ¡_key
->
objeùid
,

2038 
fœ¡_key
->
ty³
, fœ¡_key->
off£t
,

2039 
found_key
.
objeùid
, found_key.
ty³
,

2040 
found_key
.
off£t
);

2042  
»t
;

2043 
	}
}

	@tree-checker.h

6 #iâdeà
BTRFS_TREE_CHECKER_H


7 
	#BTRFS_TREE_CHECKER_H


	)

9 
	~<u­i/lšux/bŒfs_Œ“.h
>

11 
	gex‹Á_bufãr
;

12 
	gbŒfs_chunk
;

15 
	sbŒfs_Œ“_·»Á_check
 {

21 
u64
 
	mowÃr_roÙ
;

27 
u64
 
	mŒªsid
;

36 
bŒfs_key
 
	mfœ¡_key
;

37 
boŞ
 
	mhas_fœ¡_key
;

40 
u8
 
	mËv–
;

43 
	ebŒfs_Œ“_block_¡©us
 {

44 
	mBTRFS_TREE_BLOCK_CLEAN
,

45 
	mBTRFS_TREE_BLOCK_INVALID_NRITEMS
,

46 
	mBTRFS_TREE_BLOCK_INVALID_PARENT_KEY
,

47 
	mBTRFS_TREE_BLOCK_BAD_KEY_ORDER
,

48 
	mBTRFS_TREE_BLOCK_INVALID_LEVEL
,

49 
	mBTRFS_TREE_BLOCK_INVALID_FREE_SPACE
,

50 
	mBTRFS_TREE_BLOCK_INVALID_OFFSETS
,

51 
	mBTRFS_TREE_BLOCK_INVALID_BLOCKPTR
,

52 
	mBTRFS_TREE_BLOCK_INVALID_ITEM
,

53 
	mBTRFS_TREE_BLOCK_INVALID_OWNER
,

60 
bŒfs_Œ“_block_¡©us
 
__bŒfs_check_Ëaf
(
ex‹Á_bufãr
 *
Ëaf
);

61 
bŒfs_Œ“_block_¡©us
 
__bŒfs_check_node
(
ex‹Á_bufãr
 *
node
);

63 
bŒfs_check_Ëaf
(
ex‹Á_bufãr
 *
Ëaf
);

64 
bŒfs_check_node
(
ex‹Á_bufãr
 *
node
);

66 
bŒfs_check_chunk_v®id
(
ex‹Á_bufãr
 *
Ëaf
,

67 
bŒfs_chunk
 *
chunk
, 
u64
 
logiÿl
);

68 
bŒfs_check_eb_owÃr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
u64
 
roÙ_owÃr
);

69 
bŒfs_v”ify_Ëv–_key
(
ex‹Á_bufãr
 *
eb
, 
Ëv–
,

70 
bŒfs_key
 *
fœ¡_key
, 
u64
 
·»Á_Œªsid
);

	@tree-log.c

6 
	~<lšux/sched.h
>

7 
	~<lšux/¦ab.h
>

8 
	~<lšux/blkdev.h
>

9 
	~<lšux/li¡_sÜt.h
>

10 
	~<lšux/iv”siÚ.h
>

11 
	~"misc.h
"

12 
	~"ù»e.h
"

13 
	~"Œ“-log.h
"

14 
	~"disk-io.h
"

15 
	~"lockšg.h
"

16 
	~"´št-Œ“.h
"

17 
	~"back»f.h
"

18 
	~"com´essiÚ.h
"

19 
	~"qgroup.h
"

20 
	~"block-group.h
"

21 
	~"¥aû-šfo.h
"

22 
	~"zÚed.h
"

23 
	~"šode-™em.h
"

24 
	~"fs.h
"

25 
	~"acûssÜs.h
"

26 
	~"ex‹Á-Œ“.h
"

27 
	~"roÙ-Œ“.h
"

28 
	~"dœ-™em.h
"

29 
	~"fe-™em.h
"

30 
	~"fe.h
"

31 
	~"Üphª.h
"

32 
	~"Œ“-check”.h
"

34 
	#MAX_CONFLICT_INODES
 10

	)

43 
	mLOG_INODE_ALL
,

44 
	mLOG_INODE_EXISTS
,

100 
	mLOG_WALK_PIN_ONLY
,

101 
	mLOG_WALK_REPLAY_INODES
,

102 
	mLOG_WALK_REPLAY_DIR_INDEX
,

103 
	mLOG_WALK_REPLAY_ALL
,

106 
bŒfs_log_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

107 
bŒfs_šode
 *
šode
,

108 
šode_Úly
,

109 
bŒfs_log_ùx
 *
ùx
);

110 
lšk_to_fixup_dœ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

111 
bŒfs_roÙ
 *
roÙ
,

112 
bŒfs_·th
 *
·th
, 
u64
 
objeùid
);

113 
nošlše
 
»¶ay_dœ_d–‘es
(
bŒfs_Œªs_hªdË
 *
Œªs
,

114 
bŒfs_roÙ
 *
roÙ
,

115 
bŒfs_roÙ
 *
log
,

116 
bŒfs_·th
 *
·th
,

117 
u64
 
dœid
, 
d–_®l
);

118 
wa™_log_comm™
(
bŒfs_roÙ
 *
roÙ
, 
Œªsid
);

148 
	$¡¬t_log_Œªs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

149 
bŒfs_roÙ
 *
roÙ
,

150 
bŒfs_log_ùx
 *
ùx
)

152 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

153 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

154 cÚ¡ 
boŞ
 
zÚed
 = 
	`bŒfs_is_zÚed
(
fs_šfo
);

155 
»t
 = 0;

156 
boŞ
 
ü—‹d
 = 
çl£
;

162 ià(!
	`‹¡_b™
(
BTRFS_ROOT_HAS_LOG_TREE
, &
Œ“_roÙ
->
¡©e
)) {

163 
	`mu‹x_lock
(&
Œ“_roÙ
->
log_mu‹x
);

164 ià(!
fs_šfo
->
log_roÙ_Œ“
) {

165 
»t
 = 
	`bŒfs_š™_log_roÙ_Œ“
(
Œªs
, 
fs_šfo
);

166 ià(!
»t
) {

167 
	`£t_b™
(
BTRFS_ROOT_HAS_LOG_TREE
, &
Œ“_roÙ
->
¡©e
);

168 
ü—‹d
 = 
Œue
;

171 
	`mu‹x_uÆock
(&
Œ“_roÙ
->
log_mu‹x
);

172 ià(
»t
)

173  
»t
;

176 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

178 
agaš
:

179 ià(
roÙ
->
log_roÙ
) {

180 
šdex
 = (
roÙ
->
log_Œªsid
 + 1) % 2;

182 ià(
	`bŒfs_Ãed_log_fuÎ_comm™
(
Œªs
)) {

183 
»t
 = 
BTRFS_LOG_FORCE_COMMIT
;

184 
out
;

187 ià(
zÚed
 && 
	`©omic_»ad
(&
roÙ
->
log_comm™
[
šdex
])) {

188 
	`wa™_log_comm™
(
roÙ
,„oÙ->
log_Œªsid
 - 1);

189 
agaš
;

192 ià(!
roÙ
->
log_¡¬t_pid
) {

193 
	`ş—r_b™
(
BTRFS_ROOT_MULTI_LOG_TASKS
, &
roÙ
->
¡©e
);

194 
roÙ
->
log_¡¬t_pid
 = 
cu¼’t
->
pid
;

195 } ià(
roÙ
->
log_¡¬t_pid
 !ğ
cu¼’t
->
pid
) {

196 
	`£t_b™
(
BTRFS_ROOT_MULTI_LOG_TASKS
, &
roÙ
->
¡©e
);

205 ià(
zÚed
 && !
ü—‹d
) {

206 
»t
 = 
BTRFS_LOG_FORCE_COMMIT
;

207 
out
;

210 
»t
 = 
	`bŒfs_add_log_Œ“
(
Œªs
, 
roÙ
);

211 ià(
»t
)

212 
out
;

214 
	`£t_b™
(
BTRFS_ROOT_HAS_LOG_TREE
, &
roÙ
->
¡©e
);

215 
	`ş—r_b™
(
BTRFS_ROOT_MULTI_LOG_TASKS
, &
roÙ
->
¡©e
);

216 
roÙ
->
log_¡¬t_pid
 = 
cu¼’t
->
pid
;

219 
	`©omic_šc
(&
roÙ
->
log_wr™”s
);

220 ià(!
ùx
->
loggšg_Ãw_Çme
) {

221 
šdex
 = 
roÙ
->
log_Œªsid
 % 2;

222 
	`li¡_add_
(&
ùx
->
li¡
, &
roÙ
->
log_ùxs
[
šdex
]);

223 
ùx
->
log_Œªsid
 = 
roÙ
->log_transid;

226 
out
:

227 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

228  
»t
;

229 
	}
}

236 
	$još_ruÂšg_log_Œªs
(
bŒfs_roÙ
 *
roÙ
)

238 cÚ¡ 
boŞ
 
zÚed
 = 
	`bŒfs_is_zÚed
(
roÙ
->
fs_šfo
);

239 
»t
 = -
ENOENT
;

241 ià(!
	`‹¡_b™
(
BTRFS_ROOT_HAS_LOG_TREE
, &
roÙ
->
¡©e
))

242  
»t
;

244 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

245 
agaš
:

246 ià(
roÙ
->
log_roÙ
) {

247 
šdex
 = (
roÙ
->
log_Œªsid
 + 1) % 2;

249 
»t
 = 0;

250 ià(
zÚed
 && 
	`©omic_»ad
(&
roÙ
->
log_comm™
[
šdex
])) {

251 
	`wa™_log_comm™
(
roÙ
,„oÙ->
log_Œªsid
 - 1);

252 
agaš
;

254 
	`©omic_šc
(&
roÙ
->
log_wr™”s
);

256 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

257  
»t
;

258 
	}
}

265 
	$bŒfs_pš_log_Œªs
(
bŒfs_roÙ
 *
roÙ
)

267 
	`©omic_šc
(&
roÙ
->
log_wr™”s
);

268 
	}
}

274 
	$bŒfs_’d_log_Œªs
(
bŒfs_roÙ
 *
roÙ
)

276 ià(
	`©omic_dec_ªd_‹¡
(&
roÙ
->
log_wr™”s
)) {

278 
	`cÚd_wake_up_nomb
(&
roÙ
->
log_wr™”_wa™
);

280 
	}
}

288 
	sw®k_cÚŒŞ
 {

292 
	mä“
;

297 
	mpš
;

300 
	m¡age
;

307 
boŞ
 
	mignÜe_cur_šode
;

310 
bŒfs_roÙ
 *
	m»¶ay_de¡
;

313 
bŒfs_Œªs_hªdË
 *
	mŒªs
;

320 (*
	m´oûss_func
)(
bŒfs_roÙ
 *
	mlog
, 
ex‹Á_bufãr
 *
	meb
,

321 
w®k_cÚŒŞ
 *
	mwc
, 
u64
 
	mg’
, 
	mËv–
);

327 
	$´oûss_Úe_bufãr
(
bŒfs_roÙ
 *
log
,

328 
ex‹Á_bufãr
 *
eb
,

329 
w®k_cÚŒŞ
 *
wc
, 
u64
 
g’
, 
Ëv–
)

331 
bŒfs_fs_šfo
 *
fs_šfo
 = 
log
->fs_info;

332 
»t
 = 0;

338 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
MIXED_GROUPS
)) {

339 
bŒfs_Œ“_·»Á_check
 
check
 = {

340 .
Ëv–
 =†evel,

341 .
Œªsid
 = 
g’


344 
»t
 = 
	`bŒfs_»ad_ex‹Á_bufãr
(
eb
, &
check
);

345 ià(
»t
)

346  
»t
;

349 ià(
wc
->
pš
) {

350 
»t
 = 
	`bŒfs_pš_ex‹Á_fÜ_log_»¶ay
(
wc
->
Œªs
, 
eb
->
¡¬t
,

351 
eb
->
Ën
);

352 ià(
»t
)

353  
»t
;

355 ià(
	`bŒfs_bufãr_u±od©e
(
eb
, 
g’
, 0) &&

356 
	`bŒfs_h—d”_Ëv–
(
eb
) == 0)

357 
»t
 = 
	`bŒfs_exşude_logged_ex‹Ás
(
eb
);

359  
»t
;

360 
	}
}

376 
	$ov”wr™e_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

377 
bŒfs_roÙ
 *
roÙ
,

378 
bŒfs_·th
 *
·th
,

379 
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

380 
bŒfs_key
 *
key
)

382 
»t
;

383 
u32
 
™em_size
;

384 
u64
 
§ved_i_size
 = 0;

385 
§ve_Şd_i_size
 = 0;

386 
¤c_±r
;

387 
d¡_±r
;

388 
boŞ
 
šode_™em
 = 
key
->
ty³
 =ğ
BTRFS_INODE_ITEM_KEY
;

397 
	`ASSERT
(
roÙ
->
roÙ_key
.
objeùid
 !ğ
BTRFS_TREE_LOG_OBJECTID
);

399 
™em_size
 = 
	`bŒfs_™em_size
(
eb
, 
¦Ù
);

400 
¤c_±r
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

403 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, 
key
, 
·th
, 0, 0);

404 ià(
»t
 < 0)

405  
»t
;

407 ià(
»t
 == 0) {

408 *
¤c_cİy
;

409 *
d¡_cİy
;

410 
u32
 
d¡_size
 = 
	`bŒfs_™em_size
(
·th
->
nodes
[0],

411 
·th
->
¦Ùs
[0]);

412 ià(
d¡_size
 !ğ
™em_size
)

413 
š£¹
;

415 ià(
™em_size
 == 0) {

416 
	`bŒfs_»Ëa£_·th
(
·th
);

419 
d¡_cİy
 = 
	`km®loc
(
™em_size
, 
GFP_NOFS
);

420 
¤c_cİy
 = 
	`km®loc
(
™em_size
, 
GFP_NOFS
);

421 ià(!
d¡_cİy
 || !
¤c_cİy
) {

422 
	`bŒfs_»Ëa£_·th
(
·th
);

423 
	`kä“
(
d¡_cİy
);

424 
	`kä“
(
¤c_cİy
);

425  -
ENOMEM
;

428 
	`»ad_ex‹Á_bufãr
(
eb
, 
¤c_cİy
, 
¤c_±r
, 
™em_size
);

430 
d¡_±r
 = 
	`bŒfs_™em_±r_off£t
(
·th
->
nodes
[0],…©h->
¦Ùs
[0]);

431 
	`»ad_ex‹Á_bufãr
(
·th
->
nodes
[0], 
d¡_cİy
, 
d¡_±r
,

432 
™em_size
);

433 
»t
 = 
	`memcmp
(
d¡_cİy
, 
¤c_cİy
, 
™em_size
);

435 
	`kä“
(
d¡_cİy
);

436 
	`kä“
(
¤c_cİy
);

443 ià(
»t
 == 0) {

444 
	`bŒfs_»Ëa£_·th
(
·th
);

452 ià(
šode_™em
) {

453 
bŒfs_šode_™em
 *
™em
;

454 
u64
 
nby‹s
;

455 
u32
 
mode
;

457 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

458 
bŒfs_šode_™em
);

459 
nby‹s
 = 
	`bŒfs_šode_nby‹s
(
·th
->
nodes
[0], 
™em
);

460 
™em
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
,

461 
bŒfs_šode_™em
);

462 
	`bŒfs_£t_šode_nby‹s
(
eb
, 
™em
, 
nby‹s
);

469 
mode
 = 
	`bŒfs_šode_mode
(
eb
, 
™em
);

470 ià(
	`S_ISDIR
(
mode
))

471 
	`bŒfs_£t_šode_size
(
eb
, 
™em
, 0);

473 } ià(
šode_™em
) {

474 
bŒfs_šode_™em
 *
™em
;

475 
u32
 
mode
;

481 
™em
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_šode_™em
);

482 
	`bŒfs_£t_šode_nby‹s
(
eb
, 
™em
, 0);

489 
mode
 = 
	`bŒfs_šode_mode
(
eb
, 
™em
);

490 ià(
	`S_ISDIR
(
mode
))

491 
	`bŒfs_£t_šode_size
(
eb
, 
™em
, 0);

493 
š£¹
:

494 
	`bŒfs_»Ëa£_·th
(
·th
);

496 
·th
->
sk_»Ëa£_Ú_”rÜ
 = 1;

497 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
,

498 
key
, 
™em_size
);

499 
·th
->
sk_»Ëa£_Ú_”rÜ
 = 0;

502 ià(
»t
 =ğ-
EEXIST
 ||„‘ =ğ-
EOVERFLOW
) {

503 
u32
 
found_size
;

504 
found_size
 = 
	`bŒfs_™em_size
(
·th
->
nodes
[0],

505 
·th
->
¦Ùs
[0]);

506 ià(
found_size
 > 
™em_size
)

507 
	`bŒfs_Œunÿ‹_™em
(
Œªs
, 
·th
, 
™em_size
, 1);

508 ià(
found_size
 < 
™em_size
)

509 
	`bŒfs_ex‹nd_™em
(
Œªs
, 
·th
, 
™em_size
 - 
found_size
);

510 } ià(
»t
) {

511  
»t
;

513 
d¡_±r
 = 
	`bŒfs_™em_±r_off£t
(
·th
->
nodes
[0],

514 
·th
->
¦Ùs
[0]);

525 ià(
key
->
ty³
 =ğ
BTRFS_INODE_ITEM_KEY
 && 
»t
 =ğ-
EEXIST
) {

526 
bŒfs_šode_™em
 *
¤c_™em
;

527 
bŒfs_šode_™em
 *
d¡_™em
;

529 
¤c_™em
 = (
bŒfs_šode_™em
 *)
¤c_±r
;

530 
d¡_™em
 = (
bŒfs_šode_™em
 *)
d¡_±r
;

532 ià(
	`bŒfs_šode_g’”©iÚ
(
eb
, 
¤c_™em
) == 0) {

533 
ex‹Á_bufãr
 *
d¡_eb
 = 
·th
->
nodes
[0];

534 cÚ¡ 
u64
 
šo_size
 = 
	`bŒfs_šode_size
(
eb
, 
¤c_™em
);

543 ià(
	`S_ISREG
(
	`bŒfs_šode_mode
(
eb
, 
¤c_™em
)) &&

544 
	`S_ISREG
(
	`bŒfs_šode_mode
(
d¡_eb
, 
d¡_™em
)) &&

545 
šo_size
 != 0)

546 
	`bŒfs_£t_šode_size
(
d¡_eb
, 
d¡_™em
, 
šo_size
);

547 
no_cİy
;

550 ià(
	`S_ISDIR
(
	`bŒfs_šode_mode
(
eb
, 
¤c_™em
)) &&

551 
	`S_ISDIR
(
	`bŒfs_šode_mode
(
·th
->
nodes
[0], 
d¡_™em
))) {

552 
§ve_Şd_i_size
 = 1;

553 
§ved_i_size
 = 
	`bŒfs_šode_size
(
·th
->
nodes
[0],

554 
d¡_™em
);

558 
	`cİy_ex‹Á_bufãr
(
·th
->
nodes
[0], 
eb
, 
d¡_±r
,

559 
¤c_±r
, 
™em_size
);

561 ià(
§ve_Şd_i_size
) {

562 
bŒfs_šode_™em
 *
d¡_™em
;

563 
d¡_™em
 = (
bŒfs_šode_™em
 *)
d¡_±r
;

564 
	`bŒfs_£t_šode_size
(
·th
->
nodes
[0], 
d¡_™em
, 
§ved_i_size
);

568 ià(
key
->
ty³
 =ğ
BTRFS_INODE_ITEM_KEY
) {

569 
bŒfs_šode_™em
 *
d¡_™em
;

570 
d¡_™em
 = (
bŒfs_šode_™em
 *)
d¡_±r
;

571 ià(
	`bŒfs_šode_g’”©iÚ
(
·th
->
nodes
[0], 
d¡_™em
) == 0) {

572 
	`bŒfs_£t_šode_g’”©iÚ
(
·th
->
nodes
[0], 
d¡_™em
,

573 
Œªs
->
Œªsid
);

576 
no_cİy
:

577 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·th
->
nodes
[0]);

578 
	`bŒfs_»Ëa£_·th
(
·th
);

580 
	}
}

582 
	$»ad_®loc_Úe_Çme
(
ex‹Á_bufãr
 *
eb
, *
¡¬t
, 
Ën
,

583 
fsüy±_¡r
 *
Çme
)

585 *
buf
;

587 
buf
 = 
	`km®loc
(
Ën
, 
GFP_NOFS
);

588 ià(!
buf
)

589  -
ENOMEM
;

591 
	`»ad_ex‹Á_bufãr
(
eb
, 
buf
, ()
¡¬t
, 
Ën
);

592 
Çme
->Çmğ
buf
;

593 
Çme
->
Ën
 =†en;

595 
	}
}

601 
nošlše
 
šode
 *
	$»ad_Úe_šode
(
bŒfs_roÙ
 *
roÙ
,

602 
u64
 
objeùid
)

604 
šode
 *inode;

606 
šode
 = 
	`bŒfs_ig‘
(
roÙ
->
fs_šfo
->
sb
, 
objeùid
,„oot);

607 ià(
	`IS_ERR
(
šode
))

608 
šode
 = 
NULL
;

609  
šode
;

610 
	}
}

624 
nošlše
 
	$»¶ay_Úe_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

625 
bŒfs_roÙ
 *
roÙ
,

626 
bŒfs_·th
 *
·th
,

627 
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

628 
bŒfs_key
 *
key
)

630 
bŒfs_drİ_ex‹Ás_¬gs
 
drİ_¬gs
 = { 0 };

631 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

632 
found_ty³
;

633 
u64
 
ex‹Á_’d
;

634 
u64
 
¡¬t
 = 
key
->
off£t
;

635 
u64
 
nby‹s
 = 0;

636 
bŒfs_fe_ex‹Á_™em
 *
™em
;

637 
šode
 *šodğ
NULL
;

638 
size
;

639 
»t
 = 0;

641 
™em
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_fe_ex‹Á_™em
);

642 
found_ty³
 = 
	`bŒfs_fe_ex‹Á_ty³
(
eb
, 
™em
);

644 ià(
found_ty³
 =ğ
BTRFS_FILE_EXTENT_REG
 ||

645 
found_ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
) {

646 
nby‹s
 = 
	`bŒfs_fe_ex‹Á_num_by‹s
(
eb
, 
™em
);

647 
ex‹Á_’d
 = 
¡¬t
 + 
nby‹s
;

653 ià(
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
eb
, 
™em
) == 0)

654 
nby‹s
 = 0;

655 } ià(
found_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
) {

656 
size
 = 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
eb
, 
™em
);

657 
nby‹s
 = 
	`bŒfs_fe_ex‹Á_¿m_by‹s
(
eb
, 
™em
);

658 
ex‹Á_’d
 = 
	`ALIGN
(
¡¬t
 + 
size
,

659 
fs_šfo
->
£ùÜsize
);

661 
»t
 = 0;

662 
out
;

665 
šode
 = 
	`»ad_Úe_šode
(
roÙ
, 
key
->
objeùid
);

666 ià(!
šode
) {

667 
»t
 = -
EIO
;

668 
out
;

676 
»t
 = 
	`bŒfs_lookup_fe_ex‹Á
(
Œªs
, 
roÙ
, 
·th
,

677 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 
¡¬t
, 0);

679 ià(
»t
 == 0 &&

680 (
found_ty³
 =ğ
BTRFS_FILE_EXTENT_REG
 ||

681 
found_ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
)) {

682 
bŒfs_fe_ex‹Á_™em
 
cmp1
;

683 
bŒfs_fe_ex‹Á_™em
 
cmp2
;

684 
bŒfs_fe_ex‹Á_™em
 *
exi¡šg
;

685 
ex‹Á_bufãr
 *
Ëaf
;

687 
Ëaf
 = 
·th
->
nodes
[0];

688 
exi¡šg
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

689 
bŒfs_fe_ex‹Á_™em
);

691 
	`»ad_ex‹Á_bufãr
(
eb
, &
cmp1
, ()
™em
,

692 (
cmp1
));

693 
	`»ad_ex‹Á_bufãr
(
Ëaf
, &
cmp2
, ()
exi¡šg
,

694 (
cmp2
));

700 ià(
	`memcmp
(&
cmp1
, &
cmp2
, (cmp1)) == 0) {

701 
	`bŒfs_»Ëa£_·th
(
·th
);

702 
out
;

705 
	`bŒfs_»Ëa£_·th
(
·th
);

708 
drİ_¬gs
.
¡¬t
 = start;

709 
drİ_¬gs
.
’d
 = 
ex‹Á_’d
;

710 
drİ_¬gs
.
drİ_ÿche
 = 
Œue
;

711 
»t
 = 
	`bŒfs_drİ_ex‹Ás
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
), &
drİ_¬gs
);

712 ià(
»t
)

713 
out
;

715 ià(
found_ty³
 =ğ
BTRFS_FILE_EXTENT_REG
 ||

716 
found_ty³
 =ğ
BTRFS_FILE_EXTENT_PREALLOC
) {

717 
u64
 
off£t
;

718 
de¡_off£t
;

719 
bŒfs_key
 
šs
;

721 ià(
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
eb
, 
™em
) == 0 &&

722 
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
NO_HOLES
))

723 
upd©e_šode
;

725 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, 
key
,

726 (*
™em
));

727 ià(
»t
)

728 
out
;

729 
de¡_off£t
 = 
	`bŒfs_™em_±r_off£t
(
·th
->
nodes
[0],

730 
·th
->
¦Ùs
[0]);

731 
	`cİy_ex‹Á_bufãr
(
·th
->
nodes
[0], 
eb
, 
de¡_off£t
,

732 ()
™em
, (*item));

734 
šs
.
objeùid
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
eb
, 
™em
);

735 
šs
.
off£t
 = 
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
eb
, 
™em
);

736 
šs
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

737 
off£t
 = 
key
->off£ˆ- 
	`bŒfs_fe_ex‹Á_off£t
(
eb
, 
™em
);

747 
»t
 = 
	`bŒfs_qgroup_Œaû_ex‹Á
(
Œªs
,

748 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
eb
, 
™em
),

749 
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
eb
, 
™em
));

750 ià(
»t
 < 0)

751 
out
;

753 ià(
šs
.
objeùid
 > 0) {

754 
bŒfs_»f
 
»f
 = { 0 };

755 
u64
 
csum_¡¬t
;

756 
u64
 
csum_’d
;

757 
	`LIST_HEAD
(
Üd”ed_sums
);

763 
»t
 = 
	`bŒfs_lookup_d©a_ex‹Á
(
fs_šfo
, 
šs
.
objeùid
,

764 
šs
.
off£t
);

765 ià(
»t
 < 0) {

766 
out
;

767 } ià(
»t
 == 0) {

768 
	`bŒfs_š™_g’”ic_»f
(&
»f
,

769 
BTRFS_ADD_DELAYED_REF
,

770 
šs
.
objeùid
, ins.
off£t
, 0);

771 
	`bŒfs_š™_d©a_»f
(&
»f
,

772 
roÙ
->
roÙ_key
.
objeùid
,

773 
key
->
objeùid
, 
off£t
, 0, 
çl£
);

774 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, &
»f
);

775 ià(
»t
)

776 
out
;

782 
»t
 = 
	`bŒfs_®loc_logged_fe_ex‹Á
(
Œªs
,

783 
roÙ
->
roÙ_key
.
objeùid
,

784 
key
->
objeùid
, 
off£t
, &
šs
);

785 ià(
»t
)

786 
out
;

788 
	`bŒfs_»Ëa£_·th
(
·th
);

790 ià(
	`bŒfs_fe_ex‹Á_com´essiÚ
(
eb
, 
™em
)) {

791 
csum_¡¬t
 = 
šs
.
objeùid
;

792 
csum_’d
 = 
csum_¡¬t
 + 
šs
.
off£t
;

794 
csum_¡¬t
 = 
šs
.
objeùid
 +

795 
	`bŒfs_fe_ex‹Á_off£t
(
eb
, 
™em
);

796 
csum_’d
 = 
csum_¡¬t
 +

797 
	`bŒfs_fe_ex‹Á_num_by‹s
(
eb
, 
™em
);

800 
»t
 = 
	`bŒfs_lookup_csums_li¡
(
roÙ
->
log_roÙ
,

801 
csum_¡¬t
, 
csum_’d
 - 1,

802 &
Üd”ed_sums
, 0, 
çl£
);

803 ià(
»t
)

804 
out
;

854 !
	`li¡_em±y
(&
Üd”ed_sums
)) {

855 
bŒfs_Üd”ed_sum
 *
sums
;

856 
bŒfs_roÙ
 *
csum_roÙ
;

858 
sums
 = 
	`li¡_’Œy
(
Üd”ed_sums
.
Ãxt
,

859 
bŒfs_Üd”ed_sum
,

860 
li¡
);

861 
csum_roÙ
 = 
	`bŒfs_csum_roÙ
(
fs_šfo
,

862 
sums
->
logiÿl
);

863 ià(!
»t
)

864 
»t
 = 
	`bŒfs_d–_csums
(
Œªs
, 
csum_roÙ
,

865 
sums
->
logiÿl
,

866 
sums
->
Ën
);

867 ià(!
»t
)

868 
»t
 = 
	`bŒfs_csum_fe_blocks
(
Œªs
,

869 
csum_roÙ
,

870 
sums
);

871 
	`li¡_d–
(&
sums
->
li¡
);

872 
	`kä“
(
sums
);

874 ià(
»t
)

875 
out
;

877 
	`bŒfs_»Ëa£_·th
(
·th
);

879 } ià(
found_ty³
 =ğ
BTRFS_FILE_EXTENT_INLINE
) {

881 
»t
 = 
	`ov”wr™e_™em
(
Œªs
, 
roÙ
, 
·th
, 
eb
, 
¦Ù
, 
key
);

882 ià(
»t
)

883 
out
;

886 
»t
 = 
	`bŒfs_šode_£t_fe_ex‹Á_¿nge
(
	`BTRFS_I
(
šode
), 
¡¬t
,

887 
ex‹Á_’d
 - 
¡¬t
);

888 ià(
»t
)

889 
out
;

891 
upd©e_šode
:

892 
	`bŒfs_upd©e_šode_by‹s
(
	`BTRFS_I
(
šode
), 
nby‹s
, 
drİ_¬gs
.
by‹s_found
);

893 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

894 
out
:

895 
	`ut
(
šode
);

896  
»t
;

897 
	}
}

899 
	$uÆšk_šode_fÜ_log_»¶ay
(
bŒfs_Œªs_hªdË
 *
Œªs
,

900 
bŒfs_šode
 *
dœ
,

901 
bŒfs_šode
 *
šode
,

902 cÚ¡ 
fsüy±_¡r
 *
Çme
)

904 
»t
;

906 
»t
 = 
	`bŒfs_uÆšk_šode
(
Œªs
, 
dœ
, 
šode
, 
Çme
);

907 ià(
»t
)

908  
»t
;

915  
	`bŒfs_run_d–ayed_™ems
(
Œªs
);

916 
	}
}

926 
nošlše
 
	$drİ_Úe_dœ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

927 
bŒfs_·th
 *
·th
,

928 
bŒfs_šode
 *
dœ
,

929 
bŒfs_dœ_™em
 *
di
)

931 
bŒfs_roÙ
 *
roÙ
 = 
dœ
->root;

932 
šode
 *inode;

933 
fsüy±_¡r
 
Çme
;

934 
ex‹Á_bufãr
 *
Ëaf
;

935 
bŒfs_key
 
loÿtiÚ
;

936 
»t
;

938 
Ëaf
 = 
·th
->
nodes
[0];

940 
	`bŒfs_dœ_™em_key_to_ıu
(
Ëaf
, 
di
, &
loÿtiÚ
);

941 
»t
 = 
	`»ad_®loc_Úe_Çme
(
Ëaf
, 
di
 + 1, 
	`bŒfs_dœ_Çme_Ën
Ö—f, di), &
Çme
);

942 ià(
»t
)

943  -
ENOMEM
;

945 
	`bŒfs_»Ëa£_·th
(
·th
);

947 
šode
 = 
	`»ad_Úe_šode
(
roÙ
, 
loÿtiÚ
.
objeùid
);

948 ià(!
šode
) {

949 
»t
 = -
EIO
;

950 
out
;

953 
»t
 = 
	`lšk_to_fixup_dœ
(
Œªs
, 
roÙ
, 
·th
, 
loÿtiÚ
.
objeùid
);

954 ià(
»t
)

955 
out
;

957 
»t
 = 
	`uÆšk_šode_fÜ_log_»¶ay
(
Œªs
, 
dœ
, 
	`BTRFS_I
(
šode
), &
Çme
);

958 
out
:

959 
	`kä“
(
Çme
.name);

960 
	`ut
(
šode
);

961  
»t
;

962 
	}
}

971 
nošlše
 
	$šode_š_dœ
(
bŒfs_roÙ
 *
roÙ
,

972 
bŒfs_·th
 *
·th
,

973 
u64
 
dœid
, u64 
objeùid
, u64 
šdex
,

974 
fsüy±_¡r
 *
Çme
)

976 
bŒfs_dœ_™em
 *
di
;

977 
bŒfs_key
 
loÿtiÚ
;

978 
»t
 = 0;

980 
di
 = 
	`bŒfs_lookup_dœ_šdex_™em
(
NULL
, 
roÙ
, 
·th
, 
dœid
,

981 
šdex
, 
Çme
, 0);

982 ià(
	`IS_ERR
(
di
)) {

983 
»t
 = 
	`PTR_ERR
(
di
);

984 
out
;

985 } ià(
di
) {

986 
	`bŒfs_dœ_™em_key_to_ıu
(
·th
->
nodes
[0], 
di
, &
loÿtiÚ
);

987 ià(
loÿtiÚ
.
objeùid
 != objectid)

988 
out
;

990 
out
;

993 
	`bŒfs_»Ëa£_·th
(
·th
);

994 
di
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
roÙ
, 
·th
, 
dœid
, 
Çme
, 0);

995 ià(
	`IS_ERR
(
di
)) {

996 
»t
 = 
	`PTR_ERR
(
di
);

997 
out
;

998 } ià(
di
) {

999 
	`bŒfs_dœ_™em_key_to_ıu
(
·th
->
nodes
[0], 
di
, &
loÿtiÚ
);

1000 ià(
loÿtiÚ
.
objeùid
 == objectid)

1001 
»t
 = 1;

1003 
out
:

1004 
	`bŒfs_»Ëa£_·th
(
·th
);

1005  
»t
;

1006 
	}
}

1018 
nošlše
 
	$back»f_š_log
(
bŒfs_roÙ
 *
log
,

1019 
bŒfs_key
 *
key
,

1020 
u64
 
»f_objeùid
,

1021 cÚ¡ 
fsüy±_¡r
 *
Çme
)

1023 
bŒfs_·th
 *
·th
;

1024 
»t
;

1026 
·th
 = 
	`bŒfs_®loc_·th
();

1027 ià(!
·th
)

1028  -
ENOMEM
;

1030 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
log
, 
key
, 
·th
, 0, 0);

1031 ià(
»t
 < 0) {

1032 
out
;

1033 } ià(
»t
 == 1) {

1034 
»t
 = 0;

1035 
out
;

1038 ià(
key
->
ty³
 =ğ
BTRFS_INODE_EXTREF_KEY
)

1039 
»t
 = !!
	`bŒfs_fšd_Çme_š_ext_back»f
(
·th
->
nodes
[0],

1040 
·th
->
¦Ùs
[0],

1041 
»f_objeùid
, 
Çme
);

1043 
»t
 = !!
	`bŒfs_fšd_Çme_š_back»f
(
·th
->
nodes
[0],

1044 
·th
->
¦Ùs
[0], 
Çme
);

1045 
out
:

1046 
	`bŒfs_ä“_·th
(
·th
);

1047  
»t
;

1048 
	}
}

1050 
šlše
 
	$__add_šode_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1051 
bŒfs_roÙ
 *
roÙ
,

1052 
bŒfs_·th
 *
·th
,

1053 
bŒfs_roÙ
 *
log_roÙ
,

1054 
bŒfs_šode
 *
dœ
,

1055 
bŒfs_šode
 *
šode
,

1056 
u64
 
šode_objeùid
, u64 
·»Á_objeùid
,

1057 
u64
 
»f_šdex
, 
fsüy±_¡r
 *
Çme
)

1059 
»t
;

1060 
ex‹Á_bufãr
 *
Ëaf
;

1061 
bŒfs_dœ_™em
 *
di
;

1062 
bŒfs_key
 
£¬ch_key
;

1063 
bŒfs_šode_exŒef
 *
exŒef
;

1065 
agaš
:

1067 
£¬ch_key
.
objeùid
 = 
šode_objeùid
;

1068 
£¬ch_key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

1069 
£¬ch_key
.
off£t
 = 
·»Á_objeùid
;

1070 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
£¬ch_key
, 
·th
, 0, 0);

1071 ià(
»t
 == 0) {

1072 
bŒfs_šode_»f
 *
viùim_»f
;

1073 
±r
;

1074 
±r_’d
;

1076 
Ëaf
 = 
·th
->
nodes
[0];

1081 ià(
£¬ch_key
.
objeùid
 =ğ£¬ch_key.
off£t
)

1088 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1089 
±r_’d
 = 
±r
 + 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1090 
±r
 < 
±r_’d
) {

1091 
fsüy±_¡r
 
viùim_Çme
;

1093 
viùim_»f
 = (
bŒfs_šode_»f
 *)
±r
;

1094 
»t
 = 
	`»ad_®loc_Úe_Çme
(
Ëaf
, (
viùim_»f
 + 1),

1095 
	`bŒfs_šode_»f_Çme_Ën
(
Ëaf
, 
viùim_»f
),

1096 &
viùim_Çme
);

1097 ià(
»t
)

1098  
»t
;

1100 
»t
 = 
	`back»f_š_log
(
log_roÙ
, &
£¬ch_key
,

1101 
·»Á_objeùid
, &
viùim_Çme
);

1102 ià(
»t
 < 0) {

1103 
	`kä“
(
viùim_Çme
.
Çme
);

1104  
»t
;

1105 } ià(!
»t
) {

1106 
	`šc_Æšk
(&
šode
->
vfs_šode
);

1107 
	`bŒfs_»Ëa£_·th
(
·th
);

1109 
»t
 = 
	`uÆšk_šode_fÜ_log_»¶ay
(
Œªs
, 
dœ
, 
šode
,

1110 &
viùim_Çme
);

1111 
	`kä“
(
viùim_Çme
.
Çme
);

1112 ià(
»t
)

1113  
»t
;

1114 
agaš
;

1116 
	`kä“
(
viùim_Çme
.
Çme
);

1118 
±r
 = ()(
viùim_»f
 + 1è+ 
viùim_Çme
.
Ën
;

1121 
	`bŒfs_»Ëa£_·th
(
·th
);

1124 
exŒef
 = 
	`bŒfs_lookup_šode_exŒef
(
NULL
, 
roÙ
, 
·th
, 
Çme
,

1125 
šode_objeùid
, 
·»Á_objeùid
, 0,

1127 ià(
	`IS_ERR
(
exŒef
)) {

1128  
	`PTR_ERR
(
exŒef
);

1129 } ià(
exŒef
) {

1130 
u32
 
™em_size
;

1131 
u32
 
cur_off£t
 = 0;

1132 
ba£
;

1133 
šode
 *
viùim_·»Á
;

1135 
Ëaf
 = 
·th
->
nodes
[0];

1137 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1138 
ba£
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1140 
cur_off£t
 < 
™em_size
) {

1141 
fsüy±_¡r
 
viùim_Çme
;

1143 
exŒef
 = (
bŒfs_šode_exŒef
 *)(
ba£
 + 
cur_off£t
);

1145 ià(
	`bŒfs_šode_exŒef_·»Á
(
Ëaf
, 
exŒef
è!ğ
·»Á_objeùid
)

1146 
Ãxt
;

1148 
»t
 = 
	`»ad_®loc_Úe_Çme
(
Ëaf
, &
exŒef
->
Çme
,

1149 
	`bŒfs_šode_exŒef_Çme_Ën
(
Ëaf
, 
exŒef
),

1150 &
viùim_Çme
);

1151 ià(
»t
)

1152  
»t
;

1154 
£¬ch_key
.
objeùid
 = 
šode_objeùid
;

1155 
£¬ch_key
.
ty³
 = 
BTRFS_INODE_EXTREF_KEY
;

1156 
£¬ch_key
.
off£t
 = 
	`bŒfs_exŒef_hash
(
·»Á_objeùid
,

1157 
viùim_Çme
.
Çme
,

1158 
viùim_Çme
.
Ën
);

1159 
»t
 = 
	`back»f_š_log
(
log_roÙ
, &
£¬ch_key
,

1160 
·»Á_objeùid
, &
viùim_Çme
);

1161 ià(
»t
 < 0) {

1162 
	`kä“
(
viùim_Çme
.
Çme
);

1163  
»t
;

1164 } ià(!
»t
) {

1165 
»t
 = -
ENOENT
;

1166 
viùim_·»Á
 = 
	`»ad_Úe_šode
(
roÙ
,

1167 
·»Á_objeùid
);

1168 ià(
viùim_·»Á
) {

1169 
	`šc_Æšk
(&
šode
->
vfs_šode
);

1170 
	`bŒfs_»Ëa£_·th
(
·th
);

1172 
»t
 = 
	`uÆšk_šode_fÜ_log_»¶ay
(
Œªs
,

1173 
	`BTRFS_I
(
viùim_·»Á
),

1174 
šode
, &
viùim_Çme
);

1176 
	`ut
(
viùim_·»Á
);

1177 
	`kä“
(
viùim_Çme
.
Çme
);

1178 ià(
»t
)

1179  
»t
;

1180 
agaš
;

1182 
	`kä“
(
viùim_Çme
.
Çme
);

1183 
Ãxt
:

1184 
cur_off£t
 +ğ
viùim_Çme
.
Ën
 + (*
exŒef
);

1187 
	`bŒfs_»Ëa£_·th
(
·th
);

1190 
di
 = 
	`bŒfs_lookup_dœ_šdex_™em
(
Œªs
, 
roÙ
, 
·th
, 
	`bŒfs_šo
(
dœ
),

1191 
»f_šdex
, 
Çme
, 0);

1192 ià(
	`IS_ERR
(
di
)) {

1193  
	`PTR_ERR
(
di
);

1194 } ià(
di
) {

1195 
»t
 = 
	`drİ_Úe_dœ_™em
(
Œªs
, 
·th
, 
dœ
, 
di
);

1196 ià(
»t
)

1197  
»t
;

1199 
	`bŒfs_»Ëa£_·th
(
·th
);

1202 
di
 = 
	`bŒfs_lookup_dœ_™em
(
Œªs
, 
roÙ
, 
·th
, 
	`bŒfs_šo
(
dœ
), 
Çme
, 0);

1203 ià(
	`IS_ERR
(
di
)) {

1204  
	`PTR_ERR
(
di
);

1205 } ià(
di
) {

1206 
»t
 = 
	`drİ_Úe_dœ_™em
(
Œªs
, 
·th
, 
dœ
, 
di
);

1207 ià(
»t
)

1208  
»t
;

1210 
	`bŒfs_»Ëa£_·th
(
·th
);

1213 
	}
}

1215 
	$exŒef_g‘_f›lds
(
ex‹Á_bufãr
 *
eb
, 
»f_±r
,

1216 
fsüy±_¡r
 *
Çme
, 
u64
 *
šdex
,

1217 
u64
 *
·»Á_objeùid
)

1219 
bŒfs_šode_exŒef
 *
exŒef
;

1220 
»t
;

1222 
exŒef
 = (
bŒfs_šode_exŒef
 *)
»f_±r
;

1224 
»t
 = 
	`»ad_®loc_Úe_Çme
(
eb
, &
exŒef
->
Çme
,

1225 
	`bŒfs_šode_exŒef_Çme_Ën
(
eb
, 
exŒef
), 
Çme
);

1226 ià(
»t
)

1227  
»t
;

1229 ià(
šdex
)

1230 *
šdex
 = 
	`bŒfs_šode_exŒef_šdex
(
eb
, 
exŒef
);

1231 ià(
·»Á_objeùid
)

1232 *
·»Á_objeùid
 = 
	`bŒfs_šode_exŒef_·»Á
(
eb
, 
exŒef
);

1235 
	}
}

1237 
	$»f_g‘_f›lds
(
ex‹Á_bufãr
 *
eb
, 
»f_±r
,

1238 
fsüy±_¡r
 *
Çme
, 
u64
 *
šdex
)

1240 
bŒfs_šode_»f
 *
»f
;

1241 
»t
;

1243 
»f
 = (
bŒfs_šode_»f
 *)
»f_±r
;

1245 
»t
 = 
	`»ad_®loc_Úe_Çme
(
eb
, 
»f
 + 1, 
	`bŒfs_šode_»f_Çme_Ën
(eb,„ef),

1246 
Çme
);

1247 ià(
»t
)

1248  
»t
;

1250 ià(
šdex
)

1251 *
šdex
 = 
	`bŒfs_šode_»f_šdex
(
eb
, 
»f
);

1254 
	}
}

1263 
	$uÆšk_Şd_šode_»fs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1264 
bŒfs_roÙ
 *
roÙ
,

1265 
bŒfs_·th
 *
·th
,

1266 
bŒfs_šode
 *
šode
,

1267 
ex‹Á_bufãr
 *
log_eb
,

1268 
log_¦Ù
,

1269 
bŒfs_key
 *
key
)

1271 
»t
;

1272 
»f_±r
;

1273 
»f_’d
;

1274 
ex‹Á_bufãr
 *
eb
;

1276 
agaš
:

1277 
	`bŒfs_»Ëa£_·th
(
·th
);

1278 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, 
key
, 
·th
, 0, 0);

1279 ià(
»t
 > 0) {

1280 
»t
 = 0;

1281 
out
;

1283 ià(
»t
 < 0)

1284 
out
;

1286 
eb
 = 
·th
->
nodes
[0];

1287 
»f_±r
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
·th
->
¦Ùs
[0]);

1288 
»f_’d
 = 
»f_±r
 + 
	`bŒfs_™em_size
(
eb
, 
·th
->
¦Ùs
[0]);

1289 
»f_±r
 < 
»f_’d
) {

1290 
fsüy±_¡r
 
Çme
;

1291 
u64
 
·»Á_id
;

1293 ià(
key
->
ty³
 =ğ
BTRFS_INODE_EXTREF_KEY
) {

1294 
»t
 = 
	`exŒef_g‘_f›lds
(
eb
, 
»f_±r
, &
Çme
,

1295 
NULL
, &
·»Á_id
);

1297 
·»Á_id
 = 
key
->
off£t
;

1298 
»t
 = 
	`»f_g‘_f›lds
(
eb
, 
»f_±r
, &
Çme
, 
NULL
);

1300 ià(
»t
)

1301 
out
;

1303 ià(
key
->
ty³
 =ğ
BTRFS_INODE_EXTREF_KEY
)

1304 
»t
 = !!
	`bŒfs_fšd_Çme_š_ext_back»f
(
log_eb
, 
log_¦Ù
,

1305 
·»Á_id
, &
Çme
);

1307 
»t
 = !!
	`bŒfs_fšd_Çme_š_back»f
(
log_eb
, 
log_¦Ù
, &
Çme
);

1309 ià(!
»t
) {

1310 
šode
 *
dœ
;

1312 
	`bŒfs_»Ëa£_·th
(
·th
);

1313 
dœ
 = 
	`»ad_Úe_šode
(
roÙ
, 
·»Á_id
);

1314 ià(!
dœ
) {

1315 
»t
 = -
ENOENT
;

1316 
	`kä“
(
Çme
.name);

1317 
out
;

1319 
»t
 = 
	`uÆšk_šode_fÜ_log_»¶ay
(
Œªs
, 
	`BTRFS_I
(
dœ
),

1320 
šode
, &
Çme
);

1321 
	`kä“
(
Çme
.name);

1322 
	`ut
(
dœ
);

1323 ià(
»t
)

1324 
out
;

1325 
agaš
;

1328 
	`kä“
(
Çme
.name);

1329 
»f_±r
 +ğ
Çme
.
Ën
;

1330 ià(
key
->
ty³
 =ğ
BTRFS_INODE_EXTREF_KEY
)

1331 
»f_±r
 +ğ(
bŒfs_šode_exŒef
);

1333 
»f_±r
 +ğ(
bŒfs_šode_»f
);

1335 
»t
 = 0;

1336 
out
:

1337 
	`bŒfs_»Ëa£_·th
(
·th
);

1338  
»t
;

1339 
	}
}

1347 
nošlše
 
	$add_šode_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1348 
bŒfs_roÙ
 *
roÙ
,

1349 
bŒfs_roÙ
 *
log
,

1350 
bŒfs_·th
 *
·th
,

1351 
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

1352 
bŒfs_key
 *
key
)

1354 
šode
 *
dœ
 = 
NULL
;

1355 
šode
 *šodğ
NULL
;

1356 
»f_±r
;

1357 
»f_’d
;

1358 
fsüy±_¡r
 
Çme
;

1359 
»t
;

1360 
log_»f_v”
 = 0;

1361 
u64
 
·»Á_objeùid
;

1362 
u64
 
šode_objeùid
;

1363 
u64
 
»f_šdex
 = 0;

1364 
»f_¡ruù_size
;

1366 
»f_±r
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

1367 
»f_’d
 = 
»f_±r
 + 
	`bŒfs_™em_size
(
eb
, 
¦Ù
);

1369 ià(
key
->
ty³
 =ğ
BTRFS_INODE_EXTREF_KEY
) {

1370 
bŒfs_šode_exŒef
 *
r
;

1372 
»f_¡ruù_size
 = (
bŒfs_šode_exŒef
);

1373 
log_»f_v”
 = 1;

1374 
r
 = (
bŒfs_šode_exŒef
 *)
»f_±r
;

1375 
·»Á_objeùid
 = 
	`bŒfs_šode_exŒef_·»Á
(
eb
, 
r
);

1377 
»f_¡ruù_size
 = (
bŒfs_šode_»f
);

1378 
·»Á_objeùid
 = 
key
->
off£t
;

1380 
šode_objeùid
 = 
key
->
objeùid
;

1388 
dœ
 = 
	`»ad_Úe_šode
(
roÙ
, 
·»Á_objeùid
);

1389 ià(!
dœ
) {

1390 
»t
 = -
ENOENT
;

1391 
out
;

1394 
šode
 = 
	`»ad_Úe_šode
(
roÙ
, 
šode_objeùid
);

1395 ià(!
šode
) {

1396 
»t
 = -
EIO
;

1397 
out
;

1400 
»f_±r
 < 
»f_’d
) {

1401 ià(
log_»f_v”
) {

1402 
»t
 = 
	`exŒef_g‘_f›lds
(
eb
, 
»f_±r
, &
Çme
,

1403 &
»f_šdex
, &
·»Á_objeùid
);

1408 ià(!
dœ
)

1409 
dœ
 = 
	`»ad_Úe_šode
(
roÙ
, 
·»Á_objeùid
);

1410 ià(!
dœ
) {

1411 
»t
 = -
ENOENT
;

1412 
out
;

1415 
»t
 = 
	`»f_g‘_f›lds
(
eb
, 
»f_±r
, &
Çme
, &
»f_šdex
);

1417 ià(
»t
)

1418 
out
;

1420 
»t
 = 
	`šode_š_dœ
(
roÙ
, 
·th
, 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
)),

1421 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 
»f_šdex
, &
Çme
);

1422 ià(
»t
 < 0) {

1423 
out
;

1424 } ià(
»t
 == 0) {

1432 
»t
 = 
	`__add_šode_»f
(
Œªs
, 
roÙ
, 
·th
, 
log
,

1433 
	`BTRFS_I
(
dœ
), BTRFS_I(
šode
),

1434 
šode_objeùid
, 
·»Á_objeùid
,

1435 
»f_šdex
, &
Çme
);

1436 ià(
»t
) {

1437 ià(
»t
 == 1)

1438 
»t
 = 0;

1439 
out
;

1443 
»t
 = 
	`bŒfs_add_lšk
(
Œªs
, 
	`BTRFS_I
(
dœ
), BTRFS_I(
šode
),

1444 &
Çme
, 0, 
»f_šdex
);

1445 ià(
»t
)

1446 
out
;

1448 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

1449 ià(
»t
)

1450 
out
;

1454 
»f_±r
 = ()Ôef_±¸+ 
»f_¡ruù_size
è+ 
Çme
.
Ën
;

1455 
	`kä“
(
Çme
.name);

1456 
Çme
.Çmğ
NULL
;

1457 ià(
log_»f_v”
) {

1458 
	`ut
(
dœ
);

1459 
dœ
 = 
NULL
;

1471 
»t
 = 
	`uÆšk_Şd_šode_»fs
(
Œªs
, 
roÙ
, 
·th
, 
	`BTRFS_I
(
šode
), 
eb
, 
¦Ù
,

1472 
key
);

1473 ià(
»t
)

1474 
out
;

1477 
»t
 = 
	`ov”wr™e_™em
(
Œªs
, 
roÙ
, 
·th
, 
eb
, 
¦Ù
, 
key
);

1478 
out
:

1479 
	`bŒfs_»Ëa£_·th
(
·th
);

1480 
	`kä“
(
Çme
.name);

1481 
	`ut
(
dœ
);

1482 
	`ut
(
šode
);

1483  
»t
;

1484 
	}
}

1486 
	$couÁ_šode_exŒefs
(
bŒfs_roÙ
 *
roÙ
,

1487 
bŒfs_šode
 *
šode
, 
bŒfs_·th
 *
·th
)

1489 
»t
 = 0;

1490 
Çme_Ën
;

1491 
Æšk
 = 0;

1492 
u32
 
™em_size
;

1493 
u32
 
cur_off£t
 = 0;

1494 
u64
 
šode_objeùid
 = 
	`bŒfs_šo
(
šode
);

1495 
u64
 
off£t
 = 0;

1496 
±r
;

1497 
bŒfs_šode_exŒef
 *
exŒef
;

1498 
ex‹Á_bufãr
 *
Ëaf
;

1501 
»t
 = 
	`bŒfs_fšd_Úe_exŒef
(
roÙ
, 
šode_objeùid
, 
off£t
, 
·th
,

1502 &
exŒef
, &
off£t
);

1503 ià(
»t
)

1506 
Ëaf
 = 
·th
->
nodes
[0];

1507 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1508 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1509 
cur_off£t
 = 0;

1511 
cur_off£t
 < 
™em_size
) {

1512 
exŒef
 = (
bŒfs_šode_exŒef
 *è(
±r
 + 
cur_off£t
);

1513 
Çme_Ën
 = 
	`bŒfs_šode_exŒef_Çme_Ën
(
Ëaf
, 
exŒef
);

1515 
Æšk
++;

1517 
cur_off£t
 +ğ
Çme_Ën
 + (*
exŒef
);

1520 
off£t
++;

1521 
	`bŒfs_»Ëa£_·th
(
·th
);

1523 
	`bŒfs_»Ëa£_·th
(
·th
);

1525 ià(
»t
 < 0 &&„‘ !ğ-
ENOENT
)

1526  
»t
;

1527  
Æšk
;

1528 
	}
}

1530 
	$couÁ_šode_»fs
(
bŒfs_roÙ
 *
roÙ
,

1531 
bŒfs_šode
 *
šode
, 
bŒfs_·th
 *
·th
)

1533 
»t
;

1534 
bŒfs_key
 
key
;

1535 
Æšk
 = 0;

1536 
±r
;

1537 
±r_’d
;

1538 
Çme_Ën
;

1539 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

1541 
key
.
objeùid
 = 
šo
;

1542 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

1543 
key
.
off£t
 = (
u64
)-1;

1546 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

1547 ià(
»t
 < 0)

1549 ià(
»t
 > 0) {

1550 ià(
·th
->
¦Ùs
[0] == 0)

1552 
·th
->
¦Ùs
[0]--;

1554 
´oûss_¦Ù
:

1555 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,

1556 
·th
->
¦Ùs
[0]);

1557 ià(
key
.
objeùid
 !ğ
šo
 ||

1558 
key
.
ty³
 !ğ
BTRFS_INODE_REF_KEY
)

1560 
±r
 = 
	`bŒfs_™em_±r_off£t
(
·th
->
nodes
[0],…©h->
¦Ùs
[0]);

1561 
±r_’d
 = 
±r
 + 
	`bŒfs_™em_size
(
·th
->
nodes
[0],

1562 
·th
->
¦Ùs
[0]);

1563 
±r
 < 
±r_’d
) {

1564 
bŒfs_šode_»f
 *
»f
;

1566 
»f
 = (
bŒfs_šode_»f
 *)
±r
;

1567 
Çme_Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
·th
->
nodes
[0],

1568 
»f
);

1569 
±r
 = ()(
»f
 + 1è+ 
Çme_Ën
;

1570 
Æšk
++;

1573 ià(
key
.
off£t
 == 0)

1575 ià(
·th
->
¦Ùs
[0] > 0) {

1576 
·th
->
¦Ùs
[0]--;

1577 
´oûss_¦Ù
;

1579 
key
.
off£t
--;

1580 
	`bŒfs_»Ëa£_·th
(
·th
);

1582 
	`bŒfs_»Ëa£_·th
(
·th
);

1584  
Æšk
;

1585 
	}
}

1597 
nošlše
 
	$fixup_šode_lšk_couÁ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1598 
bŒfs_roÙ
 *
roÙ
,

1599 
šode
 *inode)

1601 
bŒfs_·th
 *
·th
;

1602 
»t
;

1603 
u64
 
Æšk
 = 0;

1604 
u64
 
šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

1606 
·th
 = 
	`bŒfs_®loc_·th
();

1607 ià(!
·th
)

1608  -
ENOMEM
;

1610 
»t
 = 
	`couÁ_šode_»fs
(
roÙ
, 
	`BTRFS_I
(
šode
), 
·th
);

1611 ià(
»t
 < 0)

1612 
out
;

1614 
Æšk
 = 
»t
;

1616 
»t
 = 
	`couÁ_šode_exŒefs
(
roÙ
, 
	`BTRFS_I
(
šode
), 
·th
);

1617 ià(
»t
 < 0)

1618 
out
;

1620 
Æšk
 +ğ
»t
;

1622 
»t
 = 0;

1624 ià(
Æšk
 !ğ
šode
->
i_Æšk
) {

1625 
	`£t_Æšk
(
šode
, 
Æšk
);

1626 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

1627 ià(
»t
)

1628 
out
;

1630 
	`BTRFS_I
(
šode
)->
šdex_út
 = (
u64
)-1;

1632 ià(
šode
->
i_Æšk
 == 0) {

1633 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

1634 
»t
 = 
	`»¶ay_dœ_d–‘es
(
Œªs
, 
roÙ
, 
NULL
, 
·th
,

1635 
šo
, 1);

1636 ià(
»t
)

1637 
out
;

1639 
»t
 = 
	`bŒfs_š£¹_Üphª_™em
(
Œªs
, 
roÙ
, 
šo
);

1640 ià(
»t
 =ğ-
EEXIST
)

1641 
»t
 = 0;

1644 
out
:

1645 
	`bŒfs_ä“_·th
(
·th
);

1646  
»t
;

1647 
	}
}

1649 
nošlše
 
	$fixup_šode_lšk_couÁs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1650 
bŒfs_roÙ
 *
roÙ
,

1651 
bŒfs_·th
 *
·th
)

1653 
»t
;

1654 
bŒfs_key
 
key
;

1655 
šode
 *inode;

1657 
key
.
objeùid
 = 
BTRFS_TREE_LOG_FIXUP_OBJECTID
;

1658 
key
.
ty³
 = 
BTRFS_ORPHAN_ITEM_KEY
;

1659 
key
.
off£t
 = (
u64
)-1;

1661 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1662 ià(
»t
 < 0)

1665 ià(
»t
 == 1) {

1666 
»t
 = 0;

1667 ià(
·th
->
¦Ùs
[0] == 0)

1669 
·th
->
¦Ùs
[0]--;

1672 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

1673 ià(
key
.
objeùid
 !ğ
BTRFS_TREE_LOG_FIXUP_OBJECTID
 ||

1674 
key
.
ty³
 !ğ
BTRFS_ORPHAN_ITEM_KEY
)

1677 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

1678 ià(
»t
)

1681 
	`bŒfs_»Ëa£_·th
(
·th
);

1682 
šode
 = 
	`»ad_Úe_šode
(
roÙ
, 
key
.
off£t
);

1683 ià(!
šode
) {

1684 
»t
 = -
EIO
;

1688 
»t
 = 
	`fixup_šode_lšk_couÁ
(
Œªs
, 
roÙ
, 
šode
);

1689 
	`ut
(
šode
);

1690 ià(
»t
)

1698 
key
.
off£t
 = (
u64
)-1;

1700 
	`bŒfs_»Ëa£_·th
(
·th
);

1701  
»t
;

1702 
	}
}

1710 
nošlše
 
	$lšk_to_fixup_dœ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1711 
bŒfs_roÙ
 *
roÙ
,

1712 
bŒfs_·th
 *
·th
,

1713 
u64
 
objeùid
)

1715 
bŒfs_key
 
key
;

1716 
»t
 = 0;

1717 
šode
 *inode;

1719 
šode
 = 
	`»ad_Úe_šode
(
roÙ
, 
objeùid
);

1720 ià(!
šode
)

1721  -
EIO
;

1723 
key
.
objeùid
 = 
BTRFS_TREE_LOG_FIXUP_OBJECTID
;

1724 
key
.
ty³
 = 
BTRFS_ORPHAN_ITEM_KEY
;

1725 
key
.
off£t
 = 
objeùid
;

1727 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 0);

1729 
	`bŒfs_»Ëa£_·th
(
·th
);

1730 ià(
»t
 == 0) {

1731 ià(!
šode
->
i_Æšk
)

1732 
	`£t_Æšk
(
šode
, 1);

1734 
	`šc_Æšk
(
šode
);

1735 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

1736 } ià(
»t
 =ğ-
EEXIST
) {

1737 
»t
 = 0;

1739 
	`ut
(
šode
);

1741  
»t
;

1742 
	}
}

1749 
nošlše
 
	$š£¹_Úe_Çme
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1750 
bŒfs_roÙ
 *
roÙ
,

1751 
u64
 
dœid
, u64 
šdex
,

1752 cÚ¡ 
fsüy±_¡r
 *
Çme
,

1753 
bŒfs_key
 *
loÿtiÚ
)

1755 
šode
 *inode;

1756 
šode
 *
dœ
;

1757 
»t
;

1759 
šode
 = 
	`»ad_Úe_šode
(
roÙ
, 
loÿtiÚ
->
objeùid
);

1760 ià(!
šode
)

1761  -
ENOENT
;

1763 
dœ
 = 
	`»ad_Úe_šode
(
roÙ
, 
dœid
);

1764 ià(!
dœ
) {

1765 
	`ut
(
šode
);

1766  -
EIO
;

1769 
»t
 = 
	`bŒfs_add_lšk
(
Œªs
, 
	`BTRFS_I
(
dœ
), BTRFS_I(
šode
), 
Çme
,

1770 1, 
šdex
);

1774 
	`ut
(
šode
);

1775 
	`ut
(
dœ
);

1776  
»t
;

1777 
	}
}

1779 
	$d–‘e_cÚæiùšg_dœ_’Œy
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1780 
bŒfs_šode
 *
dœ
,

1781 
bŒfs_·th
 *
·th
,

1782 
bŒfs_dœ_™em
 *
d¡_di
,

1783 cÚ¡ 
bŒfs_key
 *
log_key
,

1784 
u8
 
log_æags
,

1785 
boŞ
 
exi¡s
)

1787 
bŒfs_key
 
found_key
;

1789 
	`bŒfs_dœ_™em_key_to_ıu
(
·th
->
nodes
[0], 
d¡_di
, &
found_key
);

1791 ià(
found_key
.
objeùid
 =ğ
log_key
->objectid &&

1792 
found_key
.
ty³
 =ğ
log_key
->type &&

1793 
found_key
.
off£t
 =ğ
log_key
->offset &&

1794 
	`bŒfs_dœ_æags
(
·th
->
nodes
[0], 
d¡_di
è=ğ
log_æags
)

1801 ià(!
exi¡s
)

1804  
	`drİ_Úe_dœ_™em
(
Œªs
, 
·th
, 
dœ
, 
d¡_di
);

1805 
	}
}

1823 
nošlše
 
	$»¶ay_Úe_Çme
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1824 
bŒfs_roÙ
 *
roÙ
,

1825 
bŒfs_·th
 *
·th
,

1826 
ex‹Á_bufãr
 *
eb
,

1827 
bŒfs_dœ_™em
 *
di
,

1828 
bŒfs_key
 *
key
)

1830 
fsüy±_¡r
 
Çme
;

1831 
bŒfs_dœ_™em
 *
dœ_d¡_di
;

1832 
bŒfs_dœ_™em
 *
šdex_d¡_di
;

1833 
boŞ
 
dœ_d¡_m©ches
 = 
çl£
;

1834 
boŞ
 
šdex_d¡_m©ches
 = 
çl£
;

1835 
bŒfs_key
 
log_key
;

1836 
bŒfs_key
 
£¬ch_key
;

1837 
šode
 *
dœ
;

1838 
u8
 
log_æags
;

1839 
boŞ
 
exi¡s
;

1840 
»t
;

1841 
boŞ
 
upd©e_size
 = 
Œue
;

1842 
boŞ
 
Çme_added
 = 
çl£
;

1844 
dœ
 = 
	`»ad_Úe_šode
(
roÙ
, 
key
->
objeùid
);

1845 ià(!
dœ
)

1846  -
EIO
;

1848 
»t
 = 
	`»ad_®loc_Úe_Çme
(
eb
, 
di
 + 1, 
	`bŒfs_dœ_Çme_Ën
Ób, di), &
Çme
);

1849 ià(
»t
)

1850 
out
;

1852 
log_æags
 = 
	`bŒfs_dœ_æags
(
eb
, 
di
);

1853 
	`bŒfs_dœ_™em_key_to_ıu
(
eb
, 
di
, &
log_key
);

1854 
»t
 = 
	`bŒfs_lookup_šode
(
Œªs
, 
roÙ
, 
·th
, &
log_key
, 0);

1855 
	`bŒfs_»Ëa£_·th
(
·th
);

1856 ià(
»t
 < 0)

1857 
out
;

1858 
exi¡s
 = (
»t
 == 0);

1859 
»t
 = 0;

1861 
dœ_d¡_di
 = 
	`bŒfs_lookup_dœ_™em
(
Œªs
, 
roÙ
, 
·th
, 
key
->
objeùid
,

1862 &
Çme
, 1);

1863 ià(
	`IS_ERR
(
dœ_d¡_di
)) {

1864 
»t
 = 
	`PTR_ERR
(
dœ_d¡_di
);

1865 
out
;

1866 } ià(
dœ_d¡_di
) {

1867 
»t
 = 
	`d–‘e_cÚæiùšg_dœ_’Œy
(
Œªs
, 
	`BTRFS_I
(
dœ
), 
·th
,

1868 
dœ_d¡_di
, &
log_key
,

1869 
log_æags
, 
exi¡s
);

1870 ià(
»t
 < 0)

1871 
out
;

1872 
dœ_d¡_m©ches
 = (
»t
 == 1);

1875 
	`bŒfs_»Ëa£_·th
(
·th
);

1877 
šdex_d¡_di
 = 
	`bŒfs_lookup_dœ_šdex_™em
(
Œªs
, 
roÙ
, 
·th
,

1878 
key
->
objeùid
, key->
off£t
,

1879 &
Çme
, 1);

1880 ià(
	`IS_ERR
(
šdex_d¡_di
)) {

1881 
»t
 = 
	`PTR_ERR
(
šdex_d¡_di
);

1882 
out
;

1883 } ià(
šdex_d¡_di
) {

1884 
»t
 = 
	`d–‘e_cÚæiùšg_dœ_’Œy
(
Œªs
, 
	`BTRFS_I
(
dœ
), 
·th
,

1885 
šdex_d¡_di
, &
log_key
,

1886 
log_æags
, 
exi¡s
);

1887 ià(
»t
 < 0)

1888 
out
;

1889 
šdex_d¡_m©ches
 = (
»t
 == 1);

1892 
	`bŒfs_»Ëa£_·th
(
·th
);

1894 ià(
dœ_d¡_m©ches
 && 
šdex_d¡_m©ches
) {

1895 
»t
 = 0;

1896 
upd©e_size
 = 
çl£
;

1897 
out
;

1904 
£¬ch_key
.
objeùid
 = 
log_key
.objectid;

1905 
£¬ch_key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

1906 
£¬ch_key
.
off£t
 = 
key
->
objeùid
;

1907 
»t
 = 
	`back»f_š_log
(
roÙ
->
log_roÙ
, &
£¬ch_key
, 0, &
Çme
);

1908 ià(
»t
 < 0) {

1909 
out
;

1910 } ià(
»t
) {

1912 
»t
 = 0;

1913 
upd©e_size
 = 
çl£
;

1914 
out
;

1917 
£¬ch_key
.
objeùid
 = 
log_key
.objectid;

1918 
£¬ch_key
.
ty³
 = 
BTRFS_INODE_EXTREF_KEY
;

1919 
£¬ch_key
.
off£t
 = 
key
->
objeùid
;

1920 
»t
 = 
	`back»f_š_log
(
roÙ
->
log_roÙ
, &
£¬ch_key
, 
key
->
objeùid
, &
Çme
);

1921 ià(
»t
 < 0) {

1922 
out
;

1923 } ià(
»t
) {

1925 
»t
 = 0;

1926 
upd©e_size
 = 
çl£
;

1927 
out
;

1929 
	`bŒfs_»Ëa£_·th
(
·th
);

1930 
»t
 = 
	`š£¹_Úe_Çme
(
Œªs
, 
roÙ
, 
key
->
objeùid
, key->
off£t
,

1931 &
Çme
, &
log_key
);

1932 ià(
»t
 &&„‘ !ğ-
ENOENT
 &&„‘ !ğ-
EEXIST
)

1933 
out
;

1934 ià(!
»t
)

1935 
Çme_added
 = 
Œue
;

1936 
upd©e_size
 = 
çl£
;

1937 
»t
 = 0;

1939 
out
:

1940 ià(!
»t
 && 
upd©e_size
) {

1941 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
dœ
), dœ->
i_size
 + 
Çme
.
Ën
 * 2);

1942 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
dœ
));

1944 
	`kä“
(
Çme
.name);

1945 
	`ut
(
dœ
);

1946 ià(!
»t
 && 
Çme_added
)

1947 
»t
 = 1;

1948  
»t
;

1949 
	}
}

1952 
nošlše
 
	$»¶ay_Úe_dœ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1953 
bŒfs_roÙ
 *
roÙ
,

1954 
bŒfs_·th
 *
·th
,

1955 
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

1956 
bŒfs_key
 *
key
)

1958 
»t
;

1959 
bŒfs_dœ_™em
 *
di
;

1962 
	`ASSERT
(
key
->
ty³
 =ğ
BTRFS_DIR_INDEX_KEY
);

1964 
di
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_dœ_™em
);

1965 
»t
 = 
	`»¶ay_Úe_Çme
(
Œªs
, 
roÙ
, 
·th
, 
eb
, 
di
, 
key
);

1966 ià(
»t
 < 0)

1967  
»t
;

1995 ià(
»t
 =ğ1 && 
	`bŒfs_dœ_áy³
(
eb
, 
di
è!ğ
BTRFS_FT_DIR
) {

1996 
bŒfs_·th
 *
fixup_·th
;

1997 
bŒfs_key
 
di_key
;

1999 
fixup_·th
 = 
	`bŒfs_®loc_·th
();

2000 ià(!
fixup_·th
)

2001  -
ENOMEM
;

2003 
	`bŒfs_dœ_™em_key_to_ıu
(
eb
, 
di
, &
di_key
);

2004 
»t
 = 
	`lšk_to_fixup_dœ
(
Œªs
, 
roÙ
, 
fixup_·th
, 
di_key
.
objeùid
);

2005 
	`bŒfs_ä“_·th
(
fixup_·th
);

2008  
»t
;

2009 
	}
}

2022 
nošlše
 
	$fšd_dœ_¿nge
(
bŒfs_roÙ
 *
roÙ
,

2023 
bŒfs_·th
 *
·th
,

2024 
u64
 
dœid
,

2025 
u64
 *
¡¬t_»t
, u64 *
’d_»t
)

2027 
bŒfs_key
 
key
;

2028 
u64
 
found_’d
;

2029 
bŒfs_dœ_log_™em
 *
™em
;

2030 
»t
;

2031 
Ä™ems
;

2033 ià(*
¡¬t_»t
 =ğ(
u64
)-1)

2036 
key
.
objeùid
 = 
dœid
;

2037 
key
.
ty³
 = 
BTRFS_DIR_LOG_INDEX_KEY
;

2038 
key
.
off£t
 = *
¡¬t_»t
;

2040 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

2041 ià(
»t
 < 0)

2042 
out
;

2043 ià(
»t
 > 0) {

2044 ià(
·th
->
¦Ùs
[0] == 0)

2045 
out
;

2046 
·th
->
¦Ùs
[0]--;

2048 ià(
»t
 != 0)

2049 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

2051 ià(
key
.
ty³
 !ğ
BTRFS_DIR_LOG_INDEX_KEY
 || key.
objeùid
 !ğ
dœid
) {

2052 
»t
 = 1;

2053 
Ãxt
;

2055 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

2056 
bŒfs_dœ_log_™em
);

2057 
found_’d
 = 
	`bŒfs_dœ_log_’d
(
·th
->
nodes
[0], 
™em
);

2059 ià(*
¡¬t_»t
 >ğ
key
.
off£t
 && *¡¬t_»ˆ<ğ
found_’d
) {

2060 
»t
 = 0;

2061 *
¡¬t_»t
 = 
key
.
off£t
;

2062 *
’d_»t
 = 
found_’d
;

2063 
out
;

2065 
»t
 = 1;

2066 
Ãxt
:

2068 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

2069 
·th
->
¦Ùs
[0]++;

2070 ià(
·th
->
¦Ùs
[0] >ğ
Ä™ems
) {

2071 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

2072 ià(
»t
)

2073 
out
;

2076 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

2078 ià(
key
.
ty³
 !ğ
BTRFS_DIR_LOG_INDEX_KEY
 || key.
objeùid
 !ğ
dœid
) {

2079 
»t
 = 1;

2080 
out
;

2082 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

2083 
bŒfs_dœ_log_™em
);

2084 
found_’d
 = 
	`bŒfs_dœ_log_’d
(
·th
->
nodes
[0], 
™em
);

2085 *
¡¬t_»t
 = 
key
.
off£t
;

2086 *
’d_»t
 = 
found_’d
;

2087 
»t
 = 0;

2088 
out
:

2089 
	`bŒfs_»Ëa£_·th
(
·th
);

2090  
»t
;

2091 
	}
}

2098 
nošlše
 
	$check_™em_š_log
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2099 
bŒfs_roÙ
 *
log
,

2100 
bŒfs_·th
 *
·th
,

2101 
bŒfs_·th
 *
log_·th
,

2102 
šode
 *
dœ
,

2103 
bŒfs_key
 *
dœ_key
)

2105 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

2106 
»t
;

2107 
ex‹Á_bufãr
 *
eb
;

2108 
¦Ù
;

2109 
bŒfs_dœ_™em
 *
di
;

2110 
fsüy±_¡r
 
Çme
;

2111 
šode
 *šodğ
NULL
;

2112 
bŒfs_key
 
loÿtiÚ
;

2120 
	`ASSERT
(
dœ_key
->
ty³
 =ğ
BTRFS_DIR_INDEX_KEY
);

2122 
eb
 = 
·th
->
nodes
[0];

2123 
¦Ù
 = 
·th
->
¦Ùs
[0];

2124 
di
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_dœ_™em
);

2125 
»t
 = 
	`»ad_®loc_Úe_Çme
(
eb
, 
di
 + 1, 
	`bŒfs_dœ_Çme_Ën
Ób, di), &
Çme
);

2126 ià(
»t
)

2127 
out
;

2129 ià(
log
) {

2130 
bŒfs_dœ_™em
 *
log_di
;

2132 
log_di
 = 
	`bŒfs_lookup_dœ_šdex_™em
(
Œªs
, 
log
, 
log_·th
,

2133 
dœ_key
->
objeùid
,

2134 
dœ_key
->
off£t
, &
Çme
, 0);

2135 ià(
	`IS_ERR
(
log_di
)) {

2136 
»t
 = 
	`PTR_ERR
(
log_di
);

2137 
out
;

2138 } ià(
log_di
) {

2140 
»t
 = 0;

2141 
out
;

2145 
	`bŒfs_dœ_™em_key_to_ıu
(
eb
, 
di
, &
loÿtiÚ
);

2146 
	`bŒfs_»Ëa£_·th
(
·th
);

2147 
	`bŒfs_»Ëa£_·th
(
log_·th
);

2148 
šode
 = 
	`»ad_Úe_šode
(
roÙ
, 
loÿtiÚ
.
objeùid
);

2149 ià(!
šode
) {

2150 
»t
 = -
EIO
;

2151 
out
;

2154 
»t
 = 
	`lšk_to_fixup_dœ
(
Œªs
, 
roÙ
, 
·th
, 
loÿtiÚ
.
objeùid
);

2155 ià(
»t
)

2156 
out
;

2158 
	`šc_Æšk
(
šode
);

2159 
»t
 = 
	`uÆšk_šode_fÜ_log_»¶ay
(
Œªs
, 
	`BTRFS_I
(
dœ
), BTRFS_I(
šode
),

2160 &
Çme
);

2166 
out
:

2167 
	`bŒfs_»Ëa£_·th
(
·th
);

2168 
	`bŒfs_»Ëa£_·th
(
log_·th
);

2169 
	`kä“
(
Çme
.name);

2170 
	`ut
(
šode
);

2171  
»t
;

2172 
	}
}

2174 
	$»¶ay_x©Œ_d–‘es
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2175 
bŒfs_roÙ
 *
roÙ
,

2176 
bŒfs_roÙ
 *
log
,

2177 
bŒfs_·th
 *
·th
,

2178 cÚ¡ 
u64
 
šo
)

2180 
bŒfs_key
 
£¬ch_key
;

2181 
bŒfs_·th
 *
log_·th
;

2182 
i
;

2183 
Ä™ems
;

2184 
»t
;

2186 
log_·th
 = 
	`bŒfs_®loc_·th
();

2187 ià(!
log_·th
)

2188  -
ENOMEM
;

2190 
£¬ch_key
.
objeùid
 = 
šo
;

2191 
£¬ch_key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

2192 
£¬ch_key
.
off£t
 = 0;

2193 
agaš
:

2194 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
£¬ch_key
, 
·th
, 0, 0);

2195 ià(
»t
 < 0)

2196 
out
;

2197 
´oûss_Ëaf
:

2198 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

2199 
i
 = 
·th
->
¦Ùs
[0]; i < 
Ä™ems
; i++) {

2200 
bŒfs_key
 
key
;

2201 
bŒfs_dœ_™em
 *
di
;

2202 
bŒfs_dœ_™em
 *
log_di
;

2203 
u32
 
tÙ®_size
;

2204 
u32
 
cur
;

2206 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
, 
i
);

2207 ià(
key
.
objeùid
 !ğ
šo
 || key.
ty³
 !ğ
BTRFS_XATTR_ITEM_KEY
) {

2208 
»t
 = 0;

2209 
out
;

2212 
di
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0], 
i
, 
bŒfs_dœ_™em
);

2213 
tÙ®_size
 = 
	`bŒfs_™em_size
(
·th
->
nodes
[0], 
i
);

2214 
cur
 = 0;

2215 
cur
 < 
tÙ®_size
) {

2216 
u16
 
Çme_Ën
 = 
	`bŒfs_dœ_Çme_Ën
(
·th
->
nodes
[0], 
di
);

2217 
u16
 
d©a_Ën
 = 
	`bŒfs_dœ_d©a_Ën
(
·th
->
nodes
[0], 
di
);

2218 
u32
 
this_Ën
 = (*
di
è+ 
Çme_Ën
 + 
d©a_Ën
;

2219 *
Çme
;

2221 
Çme
 = 
	`km®loc
(
Çme_Ën
, 
GFP_NOFS
);

2222 ià(!
Çme
) {

2223 
»t
 = -
ENOMEM
;

2224 
out
;

2226 
	`»ad_ex‹Á_bufãr
(
·th
->
nodes
[0], 
Çme
,

2227 ()(
di
 + 1), 
Çme_Ën
);

2229 
log_di
 = 
	`bŒfs_lookup_x©Œ
(
NULL
, 
log
, 
log_·th
, 
šo
,

2230 
Çme
, 
Çme_Ën
, 0);

2231 
	`bŒfs_»Ëa£_·th
(
log_·th
);

2232 ià(!
log_di
) {

2234 
	`bŒfs_»Ëa£_·th
(
·th
);

2235 
di
 = 
	`bŒfs_lookup_x©Œ
(
Œªs
, 
roÙ
, 
·th
, 
šo
,

2236 
Çme
, 
Çme_Ën
, -1);

2237 
	`kä“
(
Çme
);

2238 ià(
	`IS_ERR
(
di
)) {

2239 
»t
 = 
	`PTR_ERR
(
di
);

2240 
out
;

2242 
	`ASSERT
(
di
);

2243 
»t
 = 
	`bŒfs_d–‘e_Úe_dœ_Çme
(
Œªs
, 
roÙ
,

2244 
·th
, 
di
);

2245 ià(
»t
)

2246 
out
;

2247 
	`bŒfs_»Ëa£_·th
(
·th
);

2248 
£¬ch_key
 = 
key
;

2249 
agaš
;

2251 
	`kä“
(
Çme
);

2252 ià(
	`IS_ERR
(
log_di
)) {

2253 
»t
 = 
	`PTR_ERR
(
log_di
);

2254 
out
;

2256 
cur
 +ğ
this_Ën
;

2257 
di
 = (
bŒfs_dœ_™em
 *)((*)d˜+ 
this_Ën
);

2260 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

2261 ià(
»t
 > 0)

2262 
»t
 = 0;

2263 ià(
»t
 == 0)

2264 
´oûss_Ëaf
;

2265 
out
:

2266 
	`bŒfs_ä“_·th
(
log_·th
);

2267 
	`bŒfs_»Ëa£_·th
(
·th
);

2268  
»t
;

2269 
	}
}

2282 
nošlše
 
	$»¶ay_dœ_d–‘es
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2283 
bŒfs_roÙ
 *
roÙ
,

2284 
bŒfs_roÙ
 *
log
,

2285 
bŒfs_·th
 *
·th
,

2286 
u64
 
dœid
, 
d–_®l
)

2288 
u64
 
¿nge_¡¬t
;

2289 
u64
 
¿nge_’d
;

2290 
»t
 = 0;

2291 
bŒfs_key
 
dœ_key
;

2292 
bŒfs_key
 
found_key
;

2293 
bŒfs_·th
 *
log_·th
;

2294 
šode
 *
dœ
;

2296 
dœ_key
.
objeùid
 = 
dœid
;

2297 
dœ_key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

2298 
log_·th
 = 
	`bŒfs_®loc_·th
();

2299 ià(!
log_·th
)

2300  -
ENOMEM
;

2302 
dœ
 = 
	`»ad_Úe_šode
(
roÙ
, 
dœid
);

2307 ià(!
dœ
) {

2308 
	`bŒfs_ä“_·th
(
log_·th
);

2312 
¿nge_¡¬t
 = 0;

2313 
¿nge_’d
 = 0;

2315 ià(
d–_®l
)

2316 
¿nge_’d
 = (
u64
)-1;

2318 
»t
 = 
	`fšd_dœ_¿nge
(
log
, 
·th
, 
dœid
,

2319 &
¿nge_¡¬t
, &
¿nge_’d
);

2320 ià(
»t
 < 0)

2321 
out
;

2322 ià(
»t
 > 0)

2326 
dœ_key
.
off£t
 = 
¿nge_¡¬t
;

2328 
Ä™ems
;

2329 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
dœ_key
, 
·th
,

2331 ià(
»t
 < 0)

2332 
out
;

2334 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

2335 ià(
·th
->
¦Ùs
[0] >ğ
Ä™ems
) {

2336 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

2337 ià(
»t
 == 1)

2339 ià(
»t
 < 0)

2340 
out
;

2342 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
found_key
,

2343 
·th
->
¦Ùs
[0]);

2344 ià(
found_key
.
objeùid
 !ğ
dœid
 ||

2345 
found_key
.
ty³
 !ğ
dœ_key
.type) {

2346 
»t
 = 0;

2347 
out
;

2350 ià(
found_key
.
off£t
 > 
¿nge_’d
)

2353 
»t
 = 
	`check_™em_š_log
(
Œªs
, 
log
, 
·th
,

2354 
log_·th
, 
dœ
,

2355 &
found_key
);

2356 ià(
»t
)

2357 
out
;

2358 ià(
found_key
.
off£t
 =ğ(
u64
)-1)

2360 
dœ_key
.
off£t
 = 
found_key
.offset + 1;

2362 
	`bŒfs_»Ëa£_·th
(
·th
);

2363 ià(
¿nge_’d
 =ğ(
u64
)-1)

2365 
¿nge_¡¬t
 = 
¿nge_’d
 + 1;

2367 
»t
 = 0;

2368 
out
:

2369 
	`bŒfs_»Ëa£_·th
(
·th
);

2370 
	`bŒfs_ä“_·th
(
log_·th
);

2371 
	`ut
(
dœ
);

2372  
»t
;

2373 
	}
}

2386 
	$»¶ay_Úe_bufãr
(
bŒfs_roÙ
 *
log
, 
ex‹Á_bufãr
 *
eb
,

2387 
w®k_cÚŒŞ
 *
wc
, 
u64
 
g’
, 
Ëv–
)

2389 
Ä™ems
;

2390 
bŒfs_Œ“_·»Á_check
 
check
 = {

2391 .
Œªsid
 = 
g’
,

2392 .
Ëv–
 =†evel

2394 
bŒfs_·th
 *
·th
;

2395 
bŒfs_roÙ
 *
roÙ
 = 
wc
->
»¶ay_de¡
;

2396 
bŒfs_key
 
key
;

2397 
i
;

2398 
»t
;

2400 
»t
 = 
	`bŒfs_»ad_ex‹Á_bufãr
(
eb
, &
check
);

2401 ià(
»t
)

2402  
»t
;

2404 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
eb
);

2406 ià(
Ëv–
 != 0)

2409 
·th
 = 
	`bŒfs_®loc_·th
();

2410 ià(!
·th
)

2411  -
ENOMEM
;

2413 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

2414 
i
 = 0; i < 
Ä™ems
; i++) {

2415 
	`bŒfs_™em_key_to_ıu
(
eb
, &
key
, 
i
);

2418 ià(
key
.
ty³
 =ğ
BTRFS_INODE_ITEM_KEY
 &&

2419 
wc
->
¡age
 =ğ
LOG_WALK_REPLAY_INODES
) {

2420 
bŒfs_šode_™em
 *
šode_™em
;

2421 
u32
 
mode
;

2423 
šode_™em
 = 
	`bŒfs_™em_±r
(
eb
, 
i
,

2424 
bŒfs_šode_™em
);

2433 ià(
	`bŒfs_šode_Æšk
(
eb
, 
šode_™em
) == 0) {

2434 
wc
->
ignÜe_cur_šode
 = 
Œue
;

2437 
wc
->
ignÜe_cur_šode
 = 
çl£
;

2439 
»t
 = 
	`»¶ay_x©Œ_d–‘es
(
wc
->
Œªs
, 
roÙ
, 
log
,

2440 
·th
, 
key
.
objeùid
);

2441 ià(
»t
)

2443 
mode
 = 
	`bŒfs_šode_mode
(
eb
, 
šode_™em
);

2444 ià(
	`S_ISDIR
(
mode
)) {

2445 
»t
 = 
	`»¶ay_dœ_d–‘es
(
wc
->
Œªs
,

2446 
roÙ
, 
log
, 
·th
, 
key
.
objeùid
, 0);

2447 ià(
»t
)

2450 
»t
 = 
	`ov”wr™e_™em
(
wc
->
Œªs
, 
roÙ
, 
·th
,

2451 
eb
, 
i
, &
key
);

2452 ià(
»t
)

2463 ià(
	`S_ISREG
(
mode
)) {

2464 
bŒfs_drİ_ex‹Ás_¬gs
 
drİ_¬gs
 = { 0 };

2465 
šode
 *inode;

2466 
u64
 
äom
;

2468 
šode
 = 
	`»ad_Úe_šode
(
roÙ
, 
key
.
objeùid
);

2469 ià(!
šode
) {

2470 
»t
 = -
EIO
;

2473 
äom
 = 
	`ALIGN
(
	`i_size_»ad
(
šode
),

2474 
roÙ
->
fs_šfo
->
£ùÜsize
);

2475 
drİ_¬gs
.
¡¬t
 = 
äom
;

2476 
drİ_¬gs
.
’d
 = (
u64
)-1;

2477 
drİ_¬gs
.
drİ_ÿche
 = 
Œue
;

2478 
»t
 = 
	`bŒfs_drİ_ex‹Ás
(
wc
->
Œªs
, 
roÙ
,

2479 
	`BTRFS_I
(
šode
),

2480 &
drİ_¬gs
);

2481 ià(!
»t
) {

2482 
	`šode_sub_by‹s
(
šode
,

2483 
drİ_¬gs
.
by‹s_found
);

2485 
»t
 = 
	`bŒfs_upd©e_šode
(
wc
->
Œªs
,

2486 
roÙ
, 
	`BTRFS_I
(
šode
));

2488 
	`ut
(
šode
);

2489 ià(
»t
)

2493 
»t
 = 
	`lšk_to_fixup_dœ
(
wc
->
Œªs
, 
roÙ
,

2494 
·th
, 
key
.
objeùid
);

2495 ià(
»t
)

2499 ià(
wc
->
ignÜe_cur_šode
)

2502 ià(
key
.
ty³
 =ğ
BTRFS_DIR_INDEX_KEY
 &&

2503 
wc
->
¡age
 =ğ
LOG_WALK_REPLAY_DIR_INDEX
) {

2504 
»t
 = 
	`»¶ay_Úe_dœ_™em
(
wc
->
Œªs
, 
roÙ
, 
·th
,

2505 
eb
, 
i
, &
key
);

2506 ià(
»t
)

2510 ià(
wc
->
¡age
 < 
LOG_WALK_REPLAY_ALL
)

2514 ià(
key
.
ty³
 =ğ
BTRFS_XATTR_ITEM_KEY
) {

2515 
»t
 = 
	`ov”wr™e_™em
(
wc
->
Œªs
, 
roÙ
, 
·th
,

2516 
eb
, 
i
, &
key
);

2517 ià(
»t
)

2519 } ià(
key
.
ty³
 =ğ
BTRFS_INODE_REF_KEY
 ||

2520 
key
.
ty³
 =ğ
BTRFS_INODE_EXTREF_KEY
) {

2521 
»t
 = 
	`add_šode_»f
(
wc
->
Œªs
, 
roÙ
, 
log
, 
·th
,

2522 
eb
, 
i
, &
key
);

2523 ià(
»t
 &&„‘ !ğ-
ENOENT
)

2525 
»t
 = 0;

2526 } ià(
key
.
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
) {

2527 
»t
 = 
	`»¶ay_Úe_ex‹Á
(
wc
->
Œªs
, 
roÙ
, 
·th
,

2528 
eb
, 
i
, &
key
);

2529 ià(
»t
)

2539 
	`bŒfs_ä“_·th
(
·th
);

2540  
»t
;

2541 
	}
}

2546 
	$uÇccouÁ_log_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
)

2548 
bŒfs_block_group
 *
ÿche
;

2550 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
¡¬t
);

2551 ià(!
ÿche
) {

2552 
	`bŒfs_”r
(
fs_šfo
, "uÇbËØfšd block grou°fÜ %Îu", 
¡¬t
);

2556 
	`¥š_lock
(&
ÿche
->
¥aû_šfo
->
lock
);

2557 
	`¥š_lock
(&
ÿche
->
lock
);

2558 
ÿche
->
»£rved
 -ğ
fs_šfo
->
nodesize
;

2559 
ÿche
->
¥aû_šfo
->
by‹s_»£rved
 -ğ
fs_šfo
->
nodesize
;

2560 
	`¥š_uÆock
(&
ÿche
->
lock
);

2561 
	`¥š_uÆock
(&
ÿche
->
¥aû_šfo
->
lock
);

2563 
	`bŒfs_put_block_group
(
ÿche
);

2564 
	}
}

2566 
	$ş—n_log_bufãr
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2567 
ex‹Á_bufãr
 *
eb
)

2569 
»t
;

2571 
	`bŒfs_Œ“_lock
(
eb
);

2572 
	`bŒfs_ş—r_bufãr_dœty
(
Œªs
, 
eb
);

2573 
	`wa™_Ú_ex‹Á_bufãr_wr™eback
(
eb
);

2574 
	`bŒfs_Œ“_uÆock
(
eb
);

2576 ià(
Œªs
) {

2577 
»t
 = 
	`bŒfs_pš_»£rved_ex‹Á
(
Œªs
, 
eb
->
¡¬t
,ƒb->
Ën
);

2578 ià(
»t
)

2579  
»t
;

2580 
	`bŒfs_»dœty_li¡_add
(
Œªs
->
Œª§ùiÚ
, 
eb
);

2582 
	`uÇccouÁ_log_bufãr
(
eb
->
fs_šfo
,ƒb->
¡¬t
);

2586 
	}
}

2588 
nošlše
 
	$w®k_down_log_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2589 
bŒfs_roÙ
 *
roÙ
,

2590 
bŒfs_·th
 *
·th
, *
Ëv–
,

2591 
w®k_cÚŒŞ
 *
wc
)

2593 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2594 
u64
 
by‹Ä
;

2595 
u64
 
±r_g’
;

2596 
ex‹Á_bufãr
 *
Ãxt
;

2597 
ex‹Á_bufãr
 *
cur
;

2598 
»t
 = 0;

2600 *
Ëv–
 > 0) {

2601 
bŒfs_Œ“_·»Á_check
 
check
 = { 0 };

2603 
cur
 = 
·th
->
nodes
[*
Ëv–
];

2605 
	`WARN_ON
(
	`bŒfs_h—d”_Ëv–
(
cur
è!ğ*
Ëv–
);

2607 ià(
·th
->
¦Ùs
[*
Ëv–
] >=

2608 
	`bŒfs_h—d”_Ä™ems
(
cur
))

2611 
by‹Ä
 = 
	`bŒfs_node_block±r
(
cur
, 
·th
->
¦Ùs
[*
Ëv–
]);

2612 
±r_g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
cur
, 
·th
->
¦Ùs
[*
Ëv–
]);

2613 
check
.
Œªsid
 = 
±r_g’
;

2614 
check
.
Ëv–
 = *level - 1;

2615 
check
.
has_fœ¡_key
 = 
Œue
;

2616 
	`bŒfs_node_key_to_ıu
(
cur
, &
check
.
fœ¡_key
, 
·th
->
¦Ùs
[*
Ëv–
]);

2618 
Ãxt
 = 
	`bŒfs_fšd_ü—‹_Œ“_block
(
fs_šfo
, 
by‹Ä
,

2619 
	`bŒfs_h—d”_owÃr
(
cur
),

2620 *
Ëv–
 - 1);

2621 ià(
	`IS_ERR
(
Ãxt
))

2622  
	`PTR_ERR
(
Ãxt
);

2624 ià(*
Ëv–
 == 1) {

2625 
»t
 = 
wc
->
	`´oûss_func
(
roÙ
, 
Ãxt
, wc, 
±r_g’
,

2626 *
Ëv–
 - 1);

2627 ià(
»t
) {

2628 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

2629  
»t
;

2632 
·th
->
¦Ùs
[*
Ëv–
]++;

2633 ià(
wc
->
ä“
) {

2634 
»t
 = 
	`bŒfs_»ad_ex‹Á_bufãr
(
Ãxt
, &
check
);

2635 ià(
»t
) {

2636 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

2637  
»t
;

2640 
»t
 = 
	`ş—n_log_bufãr
(
Œªs
, 
Ãxt
);

2641 ià(
»t
) {

2642 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

2643  
»t
;

2646 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

2649 
»t
 = 
	`bŒfs_»ad_ex‹Á_bufãr
(
Ãxt
, &
check
);

2650 ià(
»t
) {

2651 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

2652  
»t
;

2655 ià(
·th
->
nodes
[*
Ëv–
-1])

2656 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[*
Ëv–
-1]);

2657 
·th
->
nodes
[*
Ëv–
-1] = 
Ãxt
;

2658 *
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
Ãxt
);

2659 
·th
->
¦Ùs
[*
Ëv–
] = 0;

2660 
	`cÚd_»sched
();

2662 
·th
->
¦Ùs
[*
Ëv–
] = 
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[*level]);

2664 
	`cÚd_»sched
();

2666 
	}
}

2668 
nošlše
 
	$w®k_up_log_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2669 
bŒfs_roÙ
 *
roÙ
,

2670 
bŒfs_·th
 *
·th
, *
Ëv–
,

2671 
w®k_cÚŒŞ
 *
wc
)

2673 
i
;

2674 
¦Ù
;

2675 
»t
;

2677 
i
 = *
Ëv–
; i < 
BTRFS_MAX_LEVEL
 - 1 && 
·th
->
nodes
[i]; i++) {

2678 
¦Ù
 = 
·th
->
¦Ùs
[
i
];

2679 ià(
¦Ù
 + 1 < 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[
i
])) {

2680 
·th
->
¦Ùs
[
i
]++;

2681 *
Ëv–
 = 
i
;

2682 
	`WARN_ON
(*
Ëv–
 == 0);

2685 
»t
 = 
wc
->
	`´oûss_func
(
roÙ
, 
·th
->
nodes
[*
Ëv–
], wc,

2686 
	`bŒfs_h—d”_g’”©iÚ
(
·th
->
nodes
[*
Ëv–
]),

2687 *
Ëv–
);

2688 ià(
»t
)

2689  
»t
;

2691 ià(
wc
->
ä“
) {

2692 
»t
 = 
	`ş—n_log_bufãr
(
Œªs
, 
·th
->
nodes
[*
Ëv–
]);

2693 ià(
»t
)

2694  
»t
;

2696 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[*
Ëv–
]);

2697 
·th
->
nodes
[*
Ëv–
] = 
NULL
;

2698 *
Ëv–
 = 
i
 + 1;

2702 
	}
}

2709 
	$w®k_log_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2710 
bŒfs_roÙ
 *
log
, 
w®k_cÚŒŞ
 *
wc
)

2712 
»t
 = 0;

2713 
w»t
;

2714 
Ëv–
;

2715 
bŒfs_·th
 *
·th
;

2716 
Üig_Ëv–
;

2718 
·th
 = 
	`bŒfs_®loc_·th
();

2719 ià(!
·th
)

2720  -
ENOMEM
;

2722 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
log
->
node
);

2723 
Üig_Ëv–
 = 
Ëv–
;

2724 
·th
->
nodes
[
Ëv–
] = 
log
->
node
;

2725 
	`©omic_šc
(&
log
->
node
->
»fs
);

2726 
·th
->
¦Ùs
[
Ëv–
] = 0;

2729 
w»t
 = 
	`w®k_down_log_Œ“
(
Œªs
, 
log
, 
·th
, &
Ëv–
, 
wc
);

2730 ià(
w»t
 > 0)

2732 ià(
w»t
 < 0) {

2733 
»t
 = 
w»t
;

2734 
out
;

2737 
w»t
 = 
	`w®k_up_log_Œ“
(
Œªs
, 
log
, 
·th
, &
Ëv–
, 
wc
);

2738 ià(
w»t
 > 0)

2740 ià(
w»t
 < 0) {

2741 
»t
 = 
w»t
;

2742 
out
;

2747 ià(
·th
->
nodes
[
Üig_Ëv–
]) {

2748 
»t
 = 
wc
->
	`´oûss_func
(
log
, 
·th
->
nodes
[
Üig_Ëv–
], wc,

2749 
	`bŒfs_h—d”_g’”©iÚ
(
·th
->
nodes
[
Üig_Ëv–
]),

2750 
Üig_Ëv–
);

2751 ià(
»t
)

2752 
out
;

2753 ià(
wc
->
ä“
)

2754 
»t
 = 
	`ş—n_log_bufãr
(
Œªs
, 
·th
->
nodes
[
Üig_Ëv–
]);

2757 
out
:

2758 
	`bŒfs_ä“_·th
(
·th
);

2759  
»t
;

2760 
	}
}

2766 
	$upd©e_log_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2767 
bŒfs_roÙ
 *
log
,

2768 
bŒfs_roÙ_™em
 *
roÙ_™em
)

2770 
bŒfs_fs_šfo
 *
fs_šfo
 = 
log
->fs_info;

2771 
»t
;

2773 ià(
log
->
log_Œªsid
 == 1) {

2775 
»t
 = 
	`bŒfs_š£¹_roÙ
(
Œªs
, 
fs_šfo
->
log_roÙ_Œ“
,

2776 &
log
->
roÙ_key
, 
roÙ_™em
);

2778 
»t
 = 
	`bŒfs_upd©e_roÙ
(
Œªs
, 
fs_šfo
->
log_roÙ_Œ“
,

2779 &
log
->
roÙ_key
, 
roÙ_™em
);

2781  
»t
;

2782 
	}
}

2784 
	$wa™_log_comm™
(
bŒfs_roÙ
 *
roÙ
, 
Œªsid
)

2786 
	`DEFINE_WAIT
(
wa™
);

2787 
šdex
 = 
Œªsid
 % 2;

2795 
	`´•¬e_to_wa™
(&
roÙ
->
log_comm™_wa™
[
šdex
],

2796 &
wa™
, 
TASK_UNINTERRUPTIBLE
);

2798 ià(!(
roÙ
->
log_Œªsid_comm™‹d
 < 
Œªsid
 &&

2799 
	`©omic_»ad
(&
roÙ
->
log_comm™
[
šdex
])))

2802 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2803 
	`scheduË
();

2804 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

2806 
	`fšish_wa™
(&
roÙ
->
log_comm™_wa™
[
šdex
], &
wa™
);

2807 
	}
}

2809 
	$wa™_fÜ_wr™”
(
bŒfs_roÙ
 *
roÙ
)

2811 
	`DEFINE_WAIT
(
wa™
);

2814 
	`´•¬e_to_wa™
(&
roÙ
->
log_wr™”_wa™
, &
wa™
,

2815 
TASK_UNINTERRUPTIBLE
);

2816 ià(!
	`©omic_»ad
(&
roÙ
->
log_wr™”s
))

2819 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2820 
	`scheduË
();

2821 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

2823 
	`fšish_wa™
(&
roÙ
->
log_wr™”_wa™
, &
wa™
);

2824 
	}
}

2826 
šlše
 
	$bŒfs_»move_log_ùx
(
bŒfs_roÙ
 *
roÙ
,

2827 
bŒfs_log_ùx
 *
ùx
)

2829 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

2830 
	`li¡_d–_š™
(&
ùx
->
li¡
);

2831 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2832 
	}
}

2838 
šlše
 
	$bŒfs_»move_®l_log_ùxs
(
bŒfs_roÙ
 *
roÙ
,

2839 
šdex
, 
”rÜ
)

2841 
bŒfs_log_ùx
 *
ùx
;

2842 
bŒfs_log_ùx
 *
§ã
;

2844 
	`li¡_fÜ_—ch_’Œy_§ã
(
ùx
, 
§ã
, &
roÙ
->
log_ùxs
[
šdex
], 
li¡
) {

2845 
	`li¡_d–_š™
(&
ùx
->
li¡
);

2846 
ùx
->
log_»t
 = 
”rÜ
;

2848 
	}
}

2862 
	$bŒfs_sync_log
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2863 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_log_ùx
 *
ùx
)

2865 
šdex1
;

2866 
šdex2
;

2867 
m¬k
;

2868 
»t
;

2869 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2870 
bŒfs_roÙ
 *
log
 = 
roÙ
->
log_roÙ
;

2871 
bŒfs_roÙ
 *
log_roÙ_Œ“
 = 
fs_šfo
->log_root_tree;

2872 
bŒfs_roÙ_™em
 
Ãw_roÙ_™em
;

2873 
log_Œªsid
 = 0;

2874 
bŒfs_log_ùx
 
roÙ_log_ùx
;

2875 
blk_¶ug
 
¶ug
;

2876 
u64
 
log_roÙ_¡¬t
;

2877 
u64
 
log_roÙ_Ëv–
;

2879 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

2880 
log_Œªsid
 = 
ùx
->log_transid;

2881 ià(
roÙ
->
log_Œªsid_comm™‹d
 >ğ
log_Œªsid
) {

2882 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2883  
ùx
->
log_»t
;

2886 
šdex1
 = 
log_Œªsid
 % 2;

2887 ià(
	`©omic_»ad
(&
roÙ
->
log_comm™
[
šdex1
])) {

2888 
	`wa™_log_comm™
(
roÙ
, 
log_Œªsid
);

2889 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2890  
ùx
->
log_»t
;

2892 
	`ASSERT
(
log_Œªsid
 =ğ
roÙ
->log_transid);

2893 
	`©omic_£t
(&
roÙ
->
log_comm™
[
šdex1
], 1);

2896 ià(
	`©omic_»ad
(&
roÙ
->
log_comm™
[(
šdex1
 + 1) % 2]))

2897 
	`wa™_log_comm™
(
roÙ
, 
log_Œªsid
 - 1);

2900 
b©ch
 = 
	`©omic_»ad
(&
roÙ
->
log_b©ch
);

2902 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
SSD
) &&

2903 
	`‹¡_b™
(
BTRFS_ROOT_MULTI_LOG_TASKS
, &
roÙ
->
¡©e
)) {

2904 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2905 
	`scheduË_timeout_unš‹¼u±ibË
(1);

2906 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

2908 
	`wa™_fÜ_wr™”
(
roÙ
);

2909 ià(
b©ch
 =ğ
	`©omic_»ad
(&
roÙ
->
log_b©ch
))

2914 ià(
	`bŒfs_Ãed_log_fuÎ_comm™
(
Œªs
)) {

2915 
»t
 = 
BTRFS_LOG_FORCE_COMMIT
;

2916 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2917 
out
;

2920 ià(
log_Œªsid
 % 2 == 0)

2921 
m¬k
 = 
EXTENT_DIRTY
;

2923 
m¬k
 = 
EXTENT_NEW
;

2928 
	`blk_¡¬t_¶ug
(&
¶ug
);

2929 
»t
 = 
	`bŒfs_wr™e_m¬ked_ex‹Ás
(
fs_šfo
, &
log
->
dœty_log_·ges
, 
m¬k
);

2939 ià(
»t
 =ğ-
EAGAIN
 && 
	`bŒfs_is_zÚed
(
fs_šfo
))

2940 
»t
 = 0;

2941 ià(
»t
) {

2942 
	`blk_fšish_¶ug
(&
¶ug
);

2943 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

2944 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2945 
out
;

2961 
	`bŒfs_£t_roÙ_node
(&
log
->
roÙ_™em
,†og->
node
);

2962 
	`memıy
(&
Ãw_roÙ_™em
, &
log
->
roÙ_™em
, (new_root_item));

2964 
roÙ
->
log_Œªsid
++;

2965 
log
->
log_Œªsid
 = 
roÙ
->log_transid;

2966 
roÙ
->
log_¡¬t_pid
 = 0;

2972 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2974 ià(
	`bŒfs_is_zÚed
(
fs_šfo
)) {

2975 
	`mu‹x_lock
(&
fs_šfo
->
Œ“_roÙ
->
log_mu‹x
);

2976 ià(!
log_roÙ_Œ“
->
node
) {

2977 
»t
 = 
	`bŒfs_®loc_log_Œ“_node
(
Œªs
, 
log_roÙ_Œ“
);

2978 ià(
»t
) {

2979 
	`mu‹x_uÆock
(&
fs_šfo
->
Œ“_roÙ
->
log_mu‹x
);

2980 
	`blk_fšish_¶ug
(&
¶ug
);

2981 
out
;

2984 
	`mu‹x_uÆock
(&
fs_šfo
->
Œ“_roÙ
->
log_mu‹x
);

2987 
	`bŒfs_š™_log_ùx
(&
roÙ_log_ùx
, 
NULL
);

2989 
	`mu‹x_lock
(&
log_roÙ_Œ“
->
log_mu‹x
);

2991 
šdex2
 = 
log_roÙ_Œ“
->
log_Œªsid
 % 2;

2992 
	`li¡_add_
(&
roÙ_log_ùx
.
li¡
, &
log_roÙ_Œ“
->
log_ùxs
[
šdex2
]);

2993 
roÙ_log_ùx
.
log_Œªsid
 = 
log_roÙ_Œ“
->log_transid;

3000 
»t
 = 
	`upd©e_log_roÙ
(
Œªs
, 
log
, &
Ãw_roÙ_™em
);

3001 ià(
»t
) {

3002 ià(!
	`li¡_em±y
(&
roÙ_log_ùx
.
li¡
))

3003 
	`li¡_d–_š™
(&
roÙ_log_ùx
.
li¡
);

3005 
	`blk_fšish_¶ug
(&
¶ug
);

3006 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

3007 ià(
»t
 !ğ-
ENOSPC
)

3008 
	`bŒfs_”r
(
fs_šfo
,

3010 
roÙ
->
roÙ_key
.
objeùid
, 
»t
);

3011 
	`bŒfs_wa™_Œ“_log_ex‹Ás
(
log
, 
m¬k
);

3012 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

3013 
out
;

3016 ià(
log_roÙ_Œ“
->
log_Œªsid_comm™‹d
 >ğ
roÙ_log_ùx
.
log_Œªsid
) {

3017 
	`blk_fšish_¶ug
(&
¶ug
);

3018 
	`li¡_d–_š™
(&
roÙ_log_ùx
.
li¡
);

3019 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

3020 
»t
 = 
roÙ_log_ùx
.
log_»t
;

3021 
out
;

3024 
šdex2
 = 
roÙ_log_ùx
.
log_Œªsid
 % 2;

3025 ià(
	`©omic_»ad
(&
log_roÙ_Œ“
->
log_comm™
[
šdex2
])) {

3026 
	`blk_fšish_¶ug
(&
¶ug
);

3027 
»t
 = 
	`bŒfs_wa™_Œ“_log_ex‹Ás
(
log
, 
m¬k
);

3028 
	`wa™_log_comm™
(
log_roÙ_Œ“
,

3029 
roÙ_log_ùx
.
log_Œªsid
);

3030 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

3031 ià(!
»t
)

3032 
»t
 = 
roÙ_log_ùx
.
log_»t
;

3033 
out
;

3035 
	`ASSERT
(
roÙ_log_ùx
.
log_Œªsid
 =ğ
log_roÙ_Œ“
->log_transid);

3036 
	`©omic_£t
(&
log_roÙ_Œ“
->
log_comm™
[
šdex2
], 1);

3038 ià(
	`©omic_»ad
(&
log_roÙ_Œ“
->
log_comm™
[(
šdex2
 + 1) % 2])) {

3039 
	`wa™_log_comm™
(
log_roÙ_Œ“
,

3040 
roÙ_log_ùx
.
log_Œªsid
 - 1);

3047 ià(
	`bŒfs_Ãed_log_fuÎ_comm™
(
Œªs
)) {

3048 
	`blk_fšish_¶ug
(&
¶ug
);

3049 
	`bŒfs_wa™_Œ“_log_ex‹Ás
(
log
, 
m¬k
);

3050 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

3051 
»t
 = 
BTRFS_LOG_FORCE_COMMIT
;

3052 
out_wake_log_roÙ
;

3055 
»t
 = 
	`bŒfs_wr™e_m¬ked_ex‹Ás
(
fs_šfo
,

3056 &
log_roÙ_Œ“
->
dœty_log_·ges
,

3057 
EXTENT_DIRTY
 | 
EXTENT_NEW
);

3058 
	`blk_fšish_¶ug
(&
¶ug
);

3064 ià(
»t
 =ğ-
EAGAIN
 && 
	`bŒfs_is_zÚed
(
fs_šfo
)) {

3065 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

3066 
	`bŒfs_wa™_Œ“_log_ex‹Ás
(
log
, 
m¬k
);

3067 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

3068 
out_wake_log_roÙ
;

3069 } ià(
»t
) {

3070 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

3071 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

3072 
out_wake_log_roÙ
;

3074 
»t
 = 
	`bŒfs_wa™_Œ“_log_ex‹Ás
(
log
, 
m¬k
);

3075 ià(!
»t
)

3076 
»t
 = 
	`bŒfs_wa™_Œ“_log_ex‹Ás
(
log_roÙ_Œ“
,

3077 
EXTENT_NEW
 | 
EXTENT_DIRTY
);

3078 ià(
»t
) {

3079 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

3080 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

3081 
out_wake_log_roÙ
;

3084 
log_roÙ_¡¬t
 = 
log_roÙ_Œ“
->
node
->
¡¬t
;

3085 
log_roÙ_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
log_roÙ_Œ“
->
node
);

3086 
log_roÙ_Œ“
->
log_Œªsid
++;

3087 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

3104 
	`mu‹x_lock
(&
fs_šfo
->
Œ“_log_mu‹x
);

3113 ià(
	`BTRFS_FS_ERROR
(
fs_šfo
)) {

3114 
»t
 = -
EIO
;

3115 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

3116 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3117 
	`mu‹x_uÆock
(&
fs_šfo
->
Œ“_log_mu‹x
);

3118 
out_wake_log_roÙ
;

3121 
	`bŒfs_£t_su³r_log_roÙ
(
fs_šfo
->
su³r_fÜ_comm™
, 
log_roÙ_¡¬t
);

3122 
	`bŒfs_£t_su³r_log_roÙ_Ëv–
(
fs_šfo
->
su³r_fÜ_comm™
, 
log_roÙ_Ëv–
);

3123 
»t
 = 
	`wr™e_®l_su³rs
(
fs_šfo
, 1);

3124 
	`mu‹x_uÆock
(&
fs_šfo
->
Œ“_log_mu‹x
);

3125 ià(
»t
) {

3126 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

3127 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3128 
out_wake_log_roÙ
;

3139 
	`ASSERT
(
roÙ
->
Ï¡_log_comm™
 <ğ
log_Œªsid
);

3140 
roÙ
->
Ï¡_log_comm™
 = 
log_Œªsid
;

3142 
out_wake_log_roÙ
:

3143 
	`mu‹x_lock
(&
log_roÙ_Œ“
->
log_mu‹x
);

3144 
	`bŒfs_»move_®l_log_ùxs
(
log_roÙ_Œ“
, 
šdex2
, 
»t
);

3146 
log_roÙ_Œ“
->
log_Œªsid_comm™‹d
++;

3147 
	`©omic_£t
(&
log_roÙ_Œ“
->
log_comm™
[
šdex2
], 0);

3148 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

3155 
	`cÚd_wake_up
(&
log_roÙ_Œ“
->
log_comm™_wa™
[
šdex2
]);

3156 
out
:

3157 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

3158 
	`bŒfs_»move_®l_log_ùxs
(
roÙ
, 
šdex1
, 
»t
);

3159 
roÙ
->
log_Œªsid_comm™‹d
++;

3160 
	`©omic_£t
(&
roÙ
->
log_comm™
[
šdex1
], 0);

3161 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

3168 
	`cÚd_wake_up
(&
roÙ
->
log_comm™_wa™
[
šdex1
]);

3169  
»t
;

3170 
	}
}

3172 
	$ä“_log_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3173 
bŒfs_roÙ
 *
log
)

3175 
»t
;

3176 
w®k_cÚŒŞ
 
wc
 = {

3177 .
ä“
 = 1,

3178 .
´oûss_func
 = 
´oûss_Úe_bufãr


3181 ià(
log
->
node
) {

3182 
»t
 = 
	`w®k_log_Œ“
(
Œªs
, 
log
, &
wc
);

3183 ià(
»t
) {

3190 
	`£t_b™
(
BTRFS_FS_STATE_LOG_CLEANUP_ERROR
,

3191 &
log
->
fs_šfo
->
fs_¡©e
);

3201 
	`bŒfs_wr™e_m¬ked_ex‹Ás
(
log
->
fs_šfo
,

3202 &
log
->
dœty_log_·ges
,

3203 
EXTENT_DIRTY
 | 
EXTENT_NEW
);

3204 
	`bŒfs_wa™_Œ“_log_ex‹Ás
(
log
,

3205 
EXTENT_DIRTY
 | 
EXTENT_NEW
);

3207 ià(
Œªs
)

3208 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3210 
	`bŒfs_hªdË_fs_”rÜ
(
log
->
fs_šfo
, 
»t
, 
NULL
);

3214 
	`ş—r_ex‹Á_b™s
(&
log
->
dœty_log_·ges
, 0, (
u64
)-1,

3215 
EXTENT_DIRTY
 | 
EXTENT_NEW
 | 
EXTENT_NEED_WAIT
);

3216 
	`ex‹Á_io_Œ“_»Ëa£
(&
log
->
log_csum_¿nge
);

3218 
	`bŒfs_put_roÙ
(
log
);

3219 
	}
}

3225 
	$bŒfs_ä“_log
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
)

3227 ià(
roÙ
->
log_roÙ
) {

3228 
	`ä“_log_Œ“
(
Œªs
, 
roÙ
->
log_roÙ
);

3229 
roÙ
->
log_roÙ
 = 
NULL
;

3230 
	`ş—r_b™
(
BTRFS_ROOT_HAS_LOG_TREE
, &
roÙ
->
¡©e
);

3233 
	}
}

3235 
	$bŒfs_ä“_log_roÙ_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3236 
bŒfs_fs_šfo
 *
fs_šfo
)

3238 ià(
fs_šfo
->
log_roÙ_Œ“
) {

3239 
	`ä“_log_Œ“
(
Œªs
, 
fs_šfo
->
log_roÙ_Œ“
);

3240 
fs_šfo
->
log_roÙ_Œ“
 = 
NULL
;

3241 
	`ş—r_b™
(
BTRFS_ROOT_HAS_LOG_TREE
, &
fs_šfo
->
Œ“_roÙ
->
¡©e
);

3244 
	}
}

3255 
	$šode_logged
(cÚ¡ 
bŒfs_Œªs_hªdË
 *
Œªs
,

3256 
bŒfs_šode
 *
šode
,

3257 
bŒfs_·th
 *
·th_š
)

3259 
bŒfs_·th
 *
·th
 = 
·th_š
;

3260 
bŒfs_key
 
key
;

3261 
»t
;

3263 ià(
šode
->
logged_Œªs
 =ğ
Œªs
->
Œªsid
)

3270 ià(
šode
->
logged_Œªs
 > 0)

3280 ià(!
	`‹¡_b™
(
BTRFS_ROOT_HAS_LOG_TREE
, &
šode
->
roÙ
->
¡©e
)) {

3281 
šode
->
logged_Œªs
 = 
Œªs
->
Œªsid
 - 1;

3309 
key
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

3310 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

3311 
key
.
off£t
 = 0;

3313 ià(!
·th
) {

3314 
·th
 = 
	`bŒfs_®loc_·th
();

3315 ià(!
·th
)

3316  -
ENOMEM
;

3319 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
šode
->
roÙ
->
log_roÙ
, &
key
, 
·th
, 0, 0);

3321 ià(
·th_š
)

3322 
	`bŒfs_»Ëa£_·th
(
·th
);

3324 
	`bŒfs_ä“_·th
(
·th
);

3330 ià(
»t
 < 0) {

3331  
»t
;

3332 } ià(
»t
 > 0) {

3337 
šode
->
logged_Œªs
 = 
Œªs
->
Œªsid
 - 1;

3346 
šode
->
logged_Œªs
 = 
Œªs
->
Œªsid
;

3358 ià(
	`S_ISDIR
(
šode
->
vfs_šode
.
i_mode
))

3359 
šode
->
Ï¡_dœ_šdex_off£t
 = (
u64
)-1;

3362 
	}
}

3371 
	$d–_logged_d’Œy
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3372 
bŒfs_roÙ
 *
log
,

3373 
bŒfs_·th
 *
·th
,

3374 
u64
 
dœ_šo
,

3375 cÚ¡ 
fsüy±_¡r
 *
Çme
,

3376 
u64
 
šdex
)

3378 
bŒfs_dœ_™em
 *
di
;

3384 
di
 = 
	`bŒfs_lookup_dœ_šdex_™em
(
Œªs
, 
log
, 
·th
, 
dœ_šo
,

3385 
šdex
, 
Çme
, -1);

3386 ià(
	`IS_ERR
(
di
))

3387  
	`PTR_ERR
(
di
);

3388 ià(!
di
)

3396  
	`bŒfs_d–‘e_Úe_dœ_Çme
(
Œªs
, 
log
, 
·th
, 
di
);

3397 
	}
}

3420 
	$bŒfs_d–_dœ_’Œ›s_š_log
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3421 
bŒfs_roÙ
 *
roÙ
,

3422 cÚ¡ 
fsüy±_¡r
 *
Çme
,

3423 
bŒfs_šode
 *
dœ
, 
u64
 
šdex
)

3425 
bŒfs_·th
 *
·th
;

3426 
»t
;

3428 
»t
 = 
	`šode_logged
(
Œªs
, 
dœ
, 
NULL
);

3429 ià(
»t
 == 0)

3431 ià(
»t
 < 0) {

3432 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

3436 
»t
 = 
	`još_ruÂšg_log_Œªs
(
roÙ
);

3437 ià(
»t
)

3440 
	`mu‹x_lock
(&
dœ
->
log_mu‹x
);

3442 
·th
 = 
	`bŒfs_®loc_·th
();

3443 ià(!
·th
) {

3444 
»t
 = -
ENOMEM
;

3445 
out_uÆock
;

3448 
»t
 = 
	`d–_logged_d’Œy
(
Œªs
, 
roÙ
->
log_roÙ
, 
·th
, 
	`bŒfs_šo
(
dœ
),

3449 
Çme
, 
šdex
);

3450 
	`bŒfs_ä“_·th
(
·th
);

3451 
out_uÆock
:

3452 
	`mu‹x_uÆock
(&
dœ
->
log_mu‹x
);

3453 ià(
»t
 < 0)

3454 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

3455 
	`bŒfs_’d_log_Œªs
(
roÙ
);

3456 
	}
}

3459 
	$bŒfs_d–_šode_»f_š_log
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3460 
bŒfs_roÙ
 *
roÙ
,

3461 cÚ¡ 
fsüy±_¡r
 *
Çme
,

3462 
bŒfs_šode
 *
šode
, 
u64
 
dœid
)

3464 
bŒfs_roÙ
 *
log
;

3465 
u64
 
šdex
;

3466 
»t
;

3468 
»t
 = 
	`šode_logged
(
Œªs
, 
šode
, 
NULL
);

3469 ià(
»t
 == 0)

3471 ià(
»t
 < 0) {

3472 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

3476 
»t
 = 
	`još_ruÂšg_log_Œªs
(
roÙ
);

3477 ià(
»t
)

3479 
log
 = 
roÙ
->
log_roÙ
;

3480 
	`mu‹x_lock
(&
šode
->
log_mu‹x
);

3482 
»t
 = 
	`bŒfs_d–_šode_»f
(
Œªs
, 
log
, 
Çme
, 
	`bŒfs_šo
(
šode
),

3483 
dœid
, &
šdex
);

3484 
	`mu‹x_uÆock
(&
šode
->
log_mu‹x
);

3485 ià(
»t
 < 0 &&„‘ !ğ-
ENOENT
)

3486 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

3487 
	`bŒfs_’d_log_Œªs
(
roÙ
);

3488 
	}
}

3495 
nošlše
 
	$š£¹_dœ_log_key
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3496 
bŒfs_roÙ
 *
log
,

3497 
bŒfs_·th
 *
·th
,

3498 
u64
 
dœid
,

3499 
u64
 
fœ¡_off£t
, u64 
Ï¡_off£t
)

3501 
»t
;

3502 
bŒfs_key
 
key
;

3503 
bŒfs_dœ_log_™em
 *
™em
;

3505 
key
.
objeùid
 = 
dœid
;

3506 
key
.
off£t
 = 
fœ¡_off£t
;

3507 
key
.
ty³
 = 
BTRFS_DIR_LOG_INDEX_KEY
;

3508 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
log
, 
·th
, &
key
, (*
™em
));

3516 ià(
»t
 &&„‘ !ğ-
EEXIST
)

3517  
»t
;

3519 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

3520 
bŒfs_dœ_log_™em
);

3521 ià(
»t
 =ğ-
EEXIST
) {

3522 cÚ¡ 
u64
 
cu¼_’d
 = 
	`bŒfs_dœ_log_’d
(
·th
->
nodes
[0], 
™em
);

3530 
Ï¡_off£t
 = 
	`max
Öa¡_off£t, 
cu¼_’d
);

3532 
	`bŒfs_£t_dœ_log_’d
(
·th
->
nodes
[0], 
™em
, 
Ï¡_off£t
);

3533 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
·th
->
nodes
[0]);

3534 
	`bŒfs_»Ëa£_·th
(
·th
);

3536 
	}
}

3538 
	$æush_dœ_™ems_b©ch
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3539 
bŒfs_šode
 *
šode
,

3540 
ex‹Á_bufãr
 *
¤c
,

3541 
bŒfs_·th
 *
d¡_·th
,

3542 
¡¬t_¦Ù
,

3543 
couÁ
)

3545 
bŒfs_roÙ
 *
log
 = 
šode
->
roÙ
->
log_roÙ
;

3546 *
šs_d©a
 = 
NULL
;

3547 
bŒfs_™em_b©ch
 
b©ch
;

3548 
ex‹Á_bufãr
 *
d¡
;

3549 
¤c_off£t
;

3550 
d¡_off£t
;

3551 
u64
 
Ï¡_šdex
;

3552 
bŒfs_key
 
key
;

3553 
u32
 
™em_size
;

3554 
»t
;

3555 
i
;

3557 
	`ASSERT
(
couÁ
 > 0);

3558 
b©ch
.
Ä
 = 
couÁ
;

3560 ià(
couÁ
 == 1) {

3561 
	`bŒfs_™em_key_to_ıu
(
¤c
, &
key
, 
¡¬t_¦Ù
);

3562 
™em_size
 = 
	`bŒfs_™em_size
(
¤c
, 
¡¬t_¦Ù
);

3563 
b©ch
.
keys
 = &
key
;

3564 
b©ch
.
d©a_sizes
 = &
™em_size
;

3565 
b©ch
.
tÙ®_d©a_size
 = 
™em_size
;

3567 
bŒfs_key
 *
šs_keys
;

3568 
u32
 *
šs_sizes
;

3570 
šs_d©a
 = 
	`km®loc
(
couÁ
 * (
u32
) +

3571 
couÁ
 * (
bŒfs_key
), 
GFP_NOFS
);

3572 ià(!
šs_d©a
)

3573  -
ENOMEM
;

3575 
šs_sizes
 = (
u32
 *)
šs_d©a
;

3576 
šs_keys
 = (
bŒfs_key
 *)(
šs_d©a
 + 
couÁ
 * (
u32
));

3577 
b©ch
.
keys
 = 
šs_keys
;

3578 
b©ch
.
d©a_sizes
 = 
šs_sizes
;

3579 
b©ch
.
tÙ®_d©a_size
 = 0;

3581 
i
 = 0; i < 
couÁ
; i++) {

3582 cÚ¡ 
¦Ù
 = 
¡¬t_¦Ù
 + 
i
;

3584 
	`bŒfs_™em_key_to_ıu
(
¤c
, &
šs_keys
[
i
], 
¦Ù
);

3585 
šs_sizes
[
i
] = 
	`bŒfs_™em_size
(
¤c
, 
¦Ù
);

3586 
b©ch
.
tÙ®_d©a_size
 +ğ
šs_sizes
[
i
];

3590 
»t
 = 
	`bŒfs_š£¹_em±y_™ems
(
Œªs
, 
log
, 
d¡_·th
, &
b©ch
);

3591 ià(
»t
)

3592 
out
;

3594 
d¡
 = 
d¡_·th
->
nodes
[0];

3605 
d¡_off£t
 = 
	`bŒfs_™em_±r_off£t
(
d¡
, 
d¡_·th
->
¦Ùs
[0] + 
couÁ
 - 1);

3606 
¤c_off£t
 = 
	`bŒfs_™em_±r_off£t
(
¤c
, 
¡¬t_¦Ù
 + 
couÁ
 - 1);

3607 
	`cİy_ex‹Á_bufãr
(
d¡
, 
¤c
, 
d¡_off£t
, 
¤c_off£t
, 
b©ch
.
tÙ®_d©a_size
);

3608 
	`bŒfs_»Ëa£_·th
(
d¡_·th
);

3610 
Ï¡_šdex
 = 
b©ch
.
keys
[
couÁ
 - 1].
off£t
;

3611 
	`ASSERT
(
Ï¡_šdex
 > 
šode
->
Ï¡_dœ_šdex_off£t
);

3617 ià(
	`WARN_ON
(
Ï¡_šdex
 <ğ
šode
->
Ï¡_dœ_šdex_off£t
))

3618 
»t
 = 
BTRFS_LOG_FORCE_COMMIT
;

3620 
šode
->
Ï¡_dœ_šdex_off£t
 = 
Ï¡_šdex
;

3622 ià(
	`bŒfs_g‘_fœ¡_dœ_šdex_to_log
(
šode
) == 0)

3623 
	`bŒfs_£t_fœ¡_dœ_šdex_to_log
(
šode
, 
b©ch
.
keys
[0].
off£t
);

3624 
out
:

3625 
	`kä“
(
šs_d©a
);

3627  
»t
;

3628 
	}
}

3630 
	$´oûss_dœ_™ems_Ëaf
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3631 
bŒfs_šode
 *
šode
,

3632 
bŒfs_·th
 *
·th
,

3633 
bŒfs_·th
 *
d¡_·th
,

3634 
bŒfs_log_ùx
 *
ùx
,

3635 
u64
 *
Ï¡_Şd_d’Œy_off£t
)

3637 
bŒfs_roÙ
 *
log
 = 
šode
->
roÙ
->
log_roÙ
;

3638 
ex‹Á_bufãr
 *
¤c
;

3639 cÚ¡ 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

3640 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

3641 
boŞ
 
Ï¡_found
 = 
çl£
;

3642 
b©ch_¡¬t
 = 0;

3643 
b©ch_size
 = 0;

3644 
i
;

3651 
¤c
 = 
	`bŒfs_şÚe_ex‹Á_bufãr
(
·th
->
nodes
[0]);

3652 ià(!
¤c
)

3653  -
ENOMEM
;

3655 
i
 = 
·th
->
¦Ùs
[0];

3656 
	`bŒfs_»Ëa£_·th
(
·th
);

3657 
·th
->
nodes
[0] = 
¤c
;

3658 
·th
->
¦Ùs
[0] = 
i
;

3660 ; 
i
 < 
Ä™ems
; i++) {

3661 
bŒfs_dœ_™em
 *
di
;

3662 
bŒfs_key
 
key
;

3663 
»t
;

3665 
	`bŒfs_™em_key_to_ıu
(
¤c
, &
key
, 
i
);

3667 ià(
key
.
objeùid
 !ğ
šo
 || key.
ty³
 !ğ
BTRFS_DIR_INDEX_KEY
) {

3668 
Ï¡_found
 = 
Œue
;

3672 
di
 = 
	`bŒfs_™em_±r
(
¤c
, 
i
, 
bŒfs_dœ_™em
);

3680 ià(
	`bŒfs_dœ_Œªsid
(
¤c
, 
di
è< 
Œªs
->
Œªsid
) {

3681 ià(
key
.
off£t
 > *
Ï¡_Şd_d’Œy_off£t
 + 1) {

3682 
»t
 = 
	`š£¹_dœ_log_key
(
Œªs
, 
log
, 
d¡_·th
,

3683 
šo
, *
Ï¡_Şd_d’Œy_off£t
 + 1,

3684 
key
.
off£t
 - 1);

3685 ià(
»t
 < 0)

3686  
»t
;

3689 *
Ï¡_Şd_d’Œy_off£t
 = 
key
.
off£t
;

3694 ià(
key
.
off£t
 <ğ
šode
->
Ï¡_dœ_šdex_off£t
)

3719 ià(!
ùx
->
log_Ãw_d’Œ›s
) {

3720 
bŒfs_key
 
di_key
;

3722 
	`bŒfs_dœ_™em_key_to_ıu
(
¤c
, 
di
, &
di_key
);

3723 ià(
di_key
.
ty³
 !ğ
BTRFS_ROOT_ITEM_KEY
)

3724 
ùx
->
log_Ãw_d’Œ›s
 = 
Œue
;

3727 ià(
b©ch_size
 == 0)

3728 
b©ch_¡¬t
 = 
i
;

3729 
b©ch_size
++;

3732 ià(
b©ch_size
 > 0) {

3733 
»t
;

3735 
»t
 = 
	`æush_dœ_™ems_b©ch
(
Œªs
, 
šode
, 
¤c
, 
d¡_·th
,

3736 
b©ch_¡¬t
, 
b©ch_size
);

3737 ià(
»t
 < 0)

3738  
»t
;

3741  
Ï¡_found
 ? 1 : 0;

3742 
	}
}

3749 
nošlše
 
	$log_dœ_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3750 
bŒfs_šode
 *
šode
,

3751 
bŒfs_·th
 *
·th
,

3752 
bŒfs_·th
 *
d¡_·th
,

3753 
bŒfs_log_ùx
 *
ùx
,

3754 
u64
 
mš_off£t
, u64 *
Ï¡_off£t_»t
)

3756 
bŒfs_key
 
mš_key
;

3757 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

3758 
bŒfs_roÙ
 *
log
 = 
roÙ
->
log_roÙ
;

3759 
»t
;

3760 
u64
 
Ï¡_Şd_d’Œy_off£t
 = 
mš_off£t
 - 1;

3761 
u64
 
Ï¡_off£t
 = (u64)-1;

3762 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

3764 
mš_key
.
objeùid
 = 
šo
;

3765 
mš_key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

3766 
mš_key
.
off£t
 = 
mš_off£t
;

3768 
»t
 = 
	`bŒfs_£¬ch_fÜw¬d
(
roÙ
, &
mš_key
, 
·th
, 
Œªs
->
Œªsid
);

3774 ià(
»t
 !ğ0 || 
mš_key
.
objeùid
 !ğ
šo
 ||

3775 
mš_key
.
ty³
 !ğ
BTRFS_DIR_INDEX_KEY
) {

3776 
mš_key
.
objeùid
 = 
šo
;

3777 
mš_key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

3778 
mš_key
.
off£t
 = (
u64
)-1;

3779 
	`bŒfs_»Ëa£_·th
(
·th
);

3780 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
mš_key
, 
·th
, 0, 0);

3781 ià(
»t
 < 0) {

3782 
	`bŒfs_»Ëa£_·th
(
·th
);

3783  
»t
;

3785 
»t
 = 
	`bŒfs_´evious_™em
(
roÙ
, 
·th
, 
šo
, 
BTRFS_DIR_INDEX_KEY
);

3792 ià(
»t
 == 0) {

3793 
bŒfs_key
 
tmp
;

3795 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
tmp
,

3796 
·th
->
¦Ùs
[0]);

3797 ià(
tmp
.
ty³
 =ğ
BTRFS_DIR_INDEX_KEY
)

3798 
Ï¡_Şd_d’Œy_off£t
 = 
tmp
.
off£t
;

3799 } ià(
»t
 > 0) {

3800 
»t
 = 0;

3803 
dÚe
;

3807 
»t
 = 
	`bŒfs_´evious_™em
(
roÙ
, 
·th
, 
šo
, 
BTRFS_DIR_INDEX_KEY
);

3808 ià(
»t
 == 0) {

3809 
bŒfs_key
 
tmp
;

3811 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
tmp
,…©h->
¦Ùs
[0]);

3820 ià(
tmp
.
ty³
 =ğ
BTRFS_DIR_INDEX_KEY
)

3821 
Ï¡_Şd_d’Œy_off£t
 = 
tmp
.
off£t
;

3822 } ià(
»t
 < 0) {

3823 
dÚe
;

3826 
	`bŒfs_»Ëa£_·th
(
·th
);

3842 
£¬ch
:

3843 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
mš_key
, 
·th
, 0, 0);

3844 ià(
»t
 > 0) {

3845 
»t
 = 
	`bŒfs_Ãxt_™em
(
roÙ
, 
·th
);

3846 ià(
»t
 > 0) {

3848 
»t
 = 0;

3849 
dÚe
;

3852 ià(
»t
 < 0)

3853 
dÚe
;

3860 
»t
 = 
	`´oûss_dœ_™ems_Ëaf
(
Œªs
, 
šode
, 
·th
, 
d¡_·th
, 
ùx
,

3861 &
Ï¡_Şd_d’Œy_off£t
);

3862 ià(
»t
 != 0) {

3863 ià(
»t
 > 0)

3864 
»t
 = 0;

3865 
dÚe
;

3867 
·th
->
¦Ùs
[0] = 
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0]);

3873 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

3874 ià(
»t
) {

3875 ià(
»t
 == 1) {

3876 
Ï¡_off£t
 = (
u64
)-1;

3877 
»t
 = 0;

3879 
dÚe
;

3881 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
mš_key
,…©h->
¦Ùs
[0]);

3882 ià(
mš_key
.
objeùid
 !ğ
šo
 || mš_key.
ty³
 !ğ
BTRFS_DIR_INDEX_KEY
) {

3883 
Ï¡_off£t
 = (
u64
)-1;

3884 
dÚe
;

3886 ià(
	`bŒfs_h—d”_g’”©iÚ
(
·th
->
nodes
[0]è!ğ
Œªs
->
Œªsid
) {

3896 
Ï¡_off£t
 = 
mš_key
.
off£t
 - 1;

3897 
dÚe
;

3899 ià(
	`Ãed_»sched
()) {

3900 
	`bŒfs_»Ëa£_·th
(
·th
);

3901 
	`cÚd_»sched
();

3902 
£¬ch
;

3905 
dÚe
:

3906 
	`bŒfs_»Ëa£_·th
(
·th
);

3907 
	`bŒfs_»Ëa£_·th
(
d¡_·th
);

3909 ià(
»t
 == 0) {

3910 *
Ï¡_off£t_»t
 = 
Ï¡_off£t
;

3919 
	`ASSERT
(
Ï¡_Şd_d’Œy_off£t
 <ğ
Ï¡_off£t
);

3920 ià(
Ï¡_Şd_d’Œy_off£t
 < 
Ï¡_off£t
)

3921 
»t
 = 
	`š£¹_dœ_log_key
(
Œªs
, 
log
, 
·th
, 
šo
,

3922 
Ï¡_Şd_d’Œy_off£t
 + 1,

3923 
Ï¡_off£t
);

3926  
»t
;

3927 
	}
}

3937 
	$upd©e_Ï¡_dœ_šdex_off£t
(
bŒfs_šode
 *
šode
,

3938 
bŒfs_·th
 *
·th
,

3939 cÚ¡ 
bŒfs_log_ùx
 *
ùx
)

3941 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

3942 
bŒfs_key
 
key
;

3943 
»t
;

3945 
	`lockd•_as£¹_h–d
(&
šode
->
log_mu‹x
);

3947 ià(
šode
->
Ï¡_dœ_šdex_off£t
 !ğ(
u64
)-1)

3950 ià(!
ùx
->
logged_befÜe
) {

3951 
šode
->
Ï¡_dœ_šdex_off£t
 = 
BTRFS_DIR_START_INDEX
 - 1;

3955 
key
.
objeùid
 = 
šo
;

3956 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

3957 
key
.
off£t
 = (
u64
)-1;

3959 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
šode
->
roÙ
->
log_roÙ
, &
key
, 
·th
, 0, 0);

3964 ià(
»t
 <= 0)

3965 
out
;

3967 
»t
 = 0;

3968 
šode
->
Ï¡_dœ_šdex_off£t
 = 
BTRFS_DIR_START_INDEX
 - 1;

3974 ià(
·th
->
¦Ùs
[0] == 0)

3975 
out
;

3984 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0] - 1);

3985 ià(
key
.
objeùid
 =ğ
šo
 && key.
ty³
 =ğ
BTRFS_DIR_INDEX_KEY
)

3986 
šode
->
Ï¡_dœ_šdex_off£t
 = 
key
.
off£t
;

3988 
out
:

3989 
	`bŒfs_»Ëa£_·th
(
·th
);

3991  
»t
;

3992 
	}
}

4006 
nošlše
 
	$log_dœeùÜy_chªges
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4007 
bŒfs_šode
 *
šode
,

4008 
bŒfs_·th
 *
·th
,

4009 
bŒfs_·th
 *
d¡_·th
,

4010 
bŒfs_log_ùx
 *
ùx
)

4012 
u64
 
mš_key
;

4013 
u64
 
max_key
;

4014 
»t
;

4016 
»t
 = 
	`upd©e_Ï¡_dœ_šdex_off£t
(
šode
, 
·th
, 
ùx
);

4017 ià(
»t
)

4018  
»t
;

4020 
mš_key
 = 
BTRFS_DIR_START_INDEX
;

4021 
max_key
 = 0;

4024 
»t
 = 
	`log_dœ_™ems
(
Œªs
, 
šode
, 
·th
, 
d¡_·th
,

4025 
ùx
, 
mš_key
, &
max_key
);

4026 ià(
»t
)

4027  
»t
;

4028 ià(
max_key
 =ğ(
u64
)-1)

4030 
mš_key
 = 
max_key
 + 1;

4034 
	}
}

4042 
	$drİ_šode_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4043 
bŒfs_roÙ
 *
log
,

4044 
bŒfs_·th
 *
·th
,

4045 
bŒfs_šode
 *
šode
,

4046 
max_key_ty³
)

4048 
»t
;

4049 
bŒfs_key
 
key
;

4050 
bŒfs_key
 
found_key
;

4051 
¡¬t_¦Ù
;

4053 
key
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

4054 
key
.
ty³
 = 
max_key_ty³
;

4055 
key
.
off£t
 = (
u64
)-1;

4058 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
log
, &
key
, 
·th
, -1, 1);

4059 ià(
»t
 < 0) {

4061 } ià(
»t
 > 0) {

4062 ià(
·th
->
¦Ùs
[0] == 0)

4064 
·th
->
¦Ùs
[0]--;

4067 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
found_key
,

4068 
·th
->
¦Ùs
[0]);

4070 ià(
found_key
.
objeùid
 !ğ
key
.objectid)

4073 
found_key
.
off£t
 = 0;

4074 
found_key
.
ty³
 = 0;

4075 
»t
 = 
	`bŒfs_bš_£¬ch
(
·th
->
nodes
[0], 0, &
found_key
, &
¡¬t_¦Ù
);

4076 ià(
»t
 < 0)

4079 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
log
, 
·th
, 
¡¬t_¦Ù
,

4080 
·th
->
¦Ùs
[0] - 
¡¬t_¦Ù
 + 1);

4085 ià(
»t
 || 
¡¬t_¦Ù
 != 0)

4087 
	`bŒfs_»Ëa£_·th
(
·th
);

4089 
	`bŒfs_»Ëa£_·th
(
·th
);

4090 ià(
»t
 > 0)

4091 
»t
 = 0;

4092  
»t
;

4093 
	}
}

4095 
	$Œunÿ‹_šode_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4096 
bŒfs_roÙ
 *
log_roÙ
,

4097 
bŒfs_šode
 *
šode
,

4098 
u64
 
Ãw_size
, 
u32
 
mš_ty³
)

4100 
bŒfs_Œunÿ‹_cÚŒŞ
 
cÚŒŞ
 = {

4101 .
Ãw_size
 =‚ew_size,

4102 .
šo
 = 
	`bŒfs_šo
(
šode
),

4103 .
mš_ty³
 = min_type,

4104 .
sk_»f_upd©es
 = 
Œue
,

4107  
	`bŒfs_Œunÿ‹_šode_™ems
(
Œªs
, 
log_roÙ
, &
cÚŒŞ
);

4108 
	}
}

4110 
	$fl_šode_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4111 
ex‹Á_bufãr
 *
Ëaf
,

4112 
bŒfs_šode_™em
 *
™em
,

4113 
šode
 *šode, 
log_šode_Úly
,

4114 
u64
 
logged_isize
)

4116 
bŒfs_m­_tok’
 
tok’
;

4117 
u64
 
æags
;

4119 
	`bŒfs_š™_m­_tok’
(&
tok’
, 
Ëaf
);

4121 ià(
log_šode_Úly
) {

4127 
	`bŒfs_£t_tok’_šode_g’”©iÚ
(&
tok’
, 
™em
, 0);

4128 
	`bŒfs_£t_tok’_šode_size
(&
tok’
, 
™em
, 
logged_isize
);

4130 
	`bŒfs_£t_tok’_šode_g’”©iÚ
(&
tok’
, 
™em
,

4131 
	`BTRFS_I
(
šode
)->
g’”©iÚ
);

4132 
	`bŒfs_£t_tok’_šode_size
(&
tok’
, 
™em
, 
šode
->
i_size
);

4135 
	`bŒfs_£t_tok’_šode_uid
(&
tok’
, 
™em
, 
	`i_uid_»ad
(
šode
));

4136 
	`bŒfs_£t_tok’_šode_gid
(&
tok’
, 
™em
, 
	`i_gid_»ad
(
šode
));

4137 
	`bŒfs_£t_tok’_šode_mode
(&
tok’
, 
™em
, 
šode
->
i_mode
);

4138 
	`bŒfs_£t_tok’_šode_Æšk
(&
tok’
, 
™em
, 
šode
->
i_Æšk
);

4140 
	`bŒfs_£t_tok’_time¥ec_£c
(&
tok’
, &
™em
->
©ime
,

4141 
šode
->
i_©ime
.
tv_£c
);

4142 
	`bŒfs_£t_tok’_time¥ec_n£c
(&
tok’
, &
™em
->
©ime
,

4143 
šode
->
i_©ime
.
tv_n£c
);

4145 
	`bŒfs_£t_tok’_time¥ec_£c
(&
tok’
, &
™em
->
mtime
,

4146 
šode
->
i_mtime
.
tv_£c
);

4147 
	`bŒfs_£t_tok’_time¥ec_n£c
(&
tok’
, &
™em
->
mtime
,

4148 
šode
->
i_mtime
.
tv_n£c
);

4150 
	`bŒfs_£t_tok’_time¥ec_£c
(&
tok’
, &
™em
->
ùime
,

4151 
	`šode_g‘_ùime
(
šode
).
tv_£c
);

4152 
	`bŒfs_£t_tok’_time¥ec_n£c
(&
tok’
, &
™em
->
ùime
,

4153 
	`šode_g‘_ùime
(
šode
).
tv_n£c
);

4164 
	`bŒfs_£t_tok’_šode_£qu’û
(&
tok’
, 
™em
, 
	`šode_³ek_iv”siÚ
(
šode
));

4165 
	`bŒfs_£t_tok’_šode_Œªsid
(&
tok’
, 
™em
, 
Œªs
->
Œªsid
);

4166 
	`bŒfs_£t_tok’_šode_rdev
(&
tok’
, 
™em
, 
šode
->
i_rdev
);

4167 
æags
 = 
	`bŒfs_šode_combše_æags
(
	`BTRFS_I
(
šode
)->flags,

4168 
	`BTRFS_I
(
šode
)->
ro_æags
);

4169 
	`bŒfs_£t_tok’_šode_æags
(&
tok’
, 
™em
, 
æags
);

4170 
	`bŒfs_£t_tok’_šode_block_group
(&
tok’
, 
™em
, 0);

4171 
	}
}

4173 
	$log_šode_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4174 
bŒfs_roÙ
 *
log
, 
bŒfs_·th
 *
·th
,

4175 
bŒfs_šode
 *
šode
, 
boŞ
 
šode_™em_drİ³d
)

4177 
bŒfs_šode_™em
 *
šode_™em
;

4178 
»t
;

4190 ià(!
šode_™em_drİ³d
 && 
šode
->
logged_Œªs
 =ğ
Œªs
->
Œªsid
) {

4191 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
log
, &
šode
->
loÿtiÚ
, 
·th
, 0, 1);

4192 
	`ASSERT
(
»t
 <= 0);

4193 ià(
»t
 > 0)

4194 
»t
 = -
ENOENT
;

4205 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
log
, 
·th
, &
šode
->
loÿtiÚ
,

4206 (*
šode_™em
));

4207 
	`ASSERT
(
»t
 !ğ-
EEXIST
);

4209 ià(
»t
)

4210  
»t
;

4211 
šode_™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

4212 
bŒfs_šode_™em
);

4213 
	`fl_šode_™em
(
Œªs
, 
·th
->
nodes
[0], 
šode_™em
, &
šode
->
vfs_šode
,

4215 
	`bŒfs_»Ëa£_·th
(
·th
);

4217 
	}
}

4219 
	$log_csums
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4220 
bŒfs_šode
 *
šode
,

4221 
bŒfs_roÙ
 *
log_roÙ
,

4222 
bŒfs_Üd”ed_sum
 *
sums
)

4224 cÚ¡ 
u64
 
lock_’d
 = 
sums
->
logiÿl
 + sums->
Ën
 - 1;

4225 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

4226 
»t
;

4233 ià(
šode
->
Ï¡_»æšk_Œªs
 < 
Œªs
->
Œªsid
)

4234  
	`bŒfs_csum_fe_blocks
(
Œªs
, 
log_roÙ
, 
sums
);

4242 
»t
 = 
	`lock_ex‹Á
(&
log_roÙ
->
log_csum_¿nge
, 
sums
->
logiÿl
, 
lock_’d
,

4243 &
ÿched_¡©e
);

4244 ià(
»t
)

4245  
»t
;

4255 
»t
 = 
	`bŒfs_d–_csums
(
Œªs
, 
log_roÙ
, 
sums
->
logiÿl
, sums->
Ën
);

4256 ià(!
»t
)

4257 
»t
 = 
	`bŒfs_csum_fe_blocks
(
Œªs
, 
log_roÙ
, 
sums
);

4259 
	`uÆock_ex‹Á
(&
log_roÙ
->
log_csum_¿nge
, 
sums
->
logiÿl
, 
lock_’d
,

4260 &
ÿched_¡©e
);

4262  
»t
;

4263 
	}
}

4265 
nošlše
 
	$cİy_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4266 
bŒfs_šode
 *
šode
,

4267 
bŒfs_·th
 *
d¡_·th
,

4268 
bŒfs_·th
 *
¤c_·th
,

4269 
¡¬t_¦Ù
, 
Ä
, 
šode_Úly
,

4270 
u64
 
logged_isize
)

4272 
bŒfs_roÙ
 *
log
 = 
šode
->
roÙ
->
log_roÙ
;

4273 
bŒfs_fe_ex‹Á_™em
 *
ex‹Á
;

4274 
ex‹Á_bufãr
 *
¤c
;

4275 
»t
 = 0;

4276 
bŒfs_key
 *
šs_keys
;

4277 
u32
 *
šs_sizes
;

4278 
bŒfs_™em_b©ch
 
b©ch
;

4279 *
šs_d©a
;

4280 
i
;

4281 
d¡_šdex
;

4282 cÚ¡ 
boŞ
 
sk_csum
 = (
šode
->
æags
 & 
BTRFS_INODE_NODATASUM
);

4283 cÚ¡ 
u64
 
i_size
 = 
	`i_size_»ad
(&
šode
->
vfs_šode
);

4313 
¤c
 = 
	`bŒfs_şÚe_ex‹Á_bufãr
(
¤c_·th
->
nodes
[0]);

4314 ià(!
¤c
)

4315  -
ENOMEM
;

4317 
i
 = 
¤c_·th
->
¦Ùs
[0];

4318 
	`bŒfs_»Ëa£_·th
(
¤c_·th
);

4319 
¤c_·th
->
nodes
[0] = 
¤c
;

4320 
¤c_·th
->
¦Ùs
[0] = 
i
;

4322 
šs_d©a
 = 
	`km®loc
(
Ä
 * (
bŒfs_key
) +

4323 
Ä
 * (
u32
), 
GFP_NOFS
);

4324 ià(!
šs_d©a
)

4325  -
ENOMEM
;

4327 
šs_sizes
 = (
u32
 *)
šs_d©a
;

4328 
šs_keys
 = (
bŒfs_key
 *)(
šs_d©a
 + 
Ä
 * (
u32
));

4329 
b©ch
.
keys
 = 
šs_keys
;

4330 
b©ch
.
d©a_sizes
 = 
šs_sizes
;

4331 
b©ch
.
tÙ®_d©a_size
 = 0;

4332 
b©ch
.
Ä
 = 0;

4334 
d¡_šdex
 = 0;

4335 
i
 = 0; i < 
Ä
; i++) {

4336 cÚ¡ 
¤c_¦Ù
 = 
¡¬t_¦Ù
 + 
i
;

4337 
bŒfs_roÙ
 *
csum_roÙ
;

4338 
bŒfs_Üd”ed_sum
 *
sums
;

4339 
bŒfs_Üd”ed_sum
 *
sums_Ãxt
;

4340 
	`LIST_HEAD
(
Üd”ed_sums
);

4341 
u64
 
disk_by‹Ä
;

4342 
u64
 
disk_num_by‹s
;

4343 
u64
 
ex‹Á_off£t
;

4344 
u64
 
ex‹Á_num_by‹s
;

4345 
boŞ
 
is_Şd_ex‹Á
;

4347 
	`bŒfs_™em_key_to_ıu
(
¤c
, &
šs_keys
[
d¡_šdex
], 
¤c_¦Ù
);

4349 ià(
šs_keys
[
d¡_šdex
].
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

4350 
add_to_b©ch
;

4352 
ex‹Á
 = 
	`bŒfs_™em_±r
(
¤c
, 
¤c_¦Ù
,

4353 
bŒfs_fe_ex‹Á_™em
);

4355 
is_Şd_ex‹Á
 = (
	`bŒfs_fe_ex‹Á_g’”©iÚ
(
¤c
, 
ex‹Á
) <

4356 
Œªs
->
Œªsid
);

4371 ià(
is_Şd_ex‹Á
 &&

4372 
šs_keys
[
d¡_šdex
].
off£t
 < 
i_size
 &&

4373 
šode
->
Ï¡_»æšk_Œªs
 < 
Œªs
->
Œªsid
)

4376 ià(
sk_csum
)

4377 
add_to_b©ch
;

4380 ià(
	`bŒfs_fe_ex‹Á_ty³
(
¤c
, 
ex‹Á
è!ğ
BTRFS_FILE_EXTENT_REG
)

4381 
add_to_b©ch
;

4388 ià(
is_Şd_ex‹Á
)

4389 
add_to_b©ch
;

4391 
disk_by‹Ä
 = 
	`bŒfs_fe_ex‹Á_disk_by‹Ä
(
¤c
, 
ex‹Á
);

4393 ià(
disk_by‹Ä
 == 0)

4394 
add_to_b©ch
;

4396 
disk_num_by‹s
 = 
	`bŒfs_fe_ex‹Á_disk_num_by‹s
(
¤c
, 
ex‹Á
);

4398 ià(
	`bŒfs_fe_ex‹Á_com´essiÚ
(
¤c
, 
ex‹Á
)) {

4399 
ex‹Á_off£t
 = 0;

4400 
ex‹Á_num_by‹s
 = 
disk_num_by‹s
;

4402 
ex‹Á_off£t
 = 
	`bŒfs_fe_ex‹Á_off£t
(
¤c
, 
ex‹Á
);

4403 
ex‹Á_num_by‹s
 = 
	`bŒfs_fe_ex‹Á_num_by‹s
(
¤c
, 
ex‹Á
);

4406 
csum_roÙ
 = 
	`bŒfs_csum_roÙ
(
Œªs
->
fs_šfo
, 
disk_by‹Ä
);

4407 
disk_by‹Ä
 +ğ
ex‹Á_off£t
;

4408 
»t
 = 
	`bŒfs_lookup_csums_li¡
(
csum_roÙ
, 
disk_by‹Ä
,

4409 
disk_by‹Ä
 + 
ex‹Á_num_by‹s
 - 1,

4410 &
Üd”ed_sums
, 0, 
çl£
);

4411 ià(
»t
)

4412 
out
;

4414 
	`li¡_fÜ_—ch_’Œy_§ã
(
sums
, 
sums_Ãxt
, &
Üd”ed_sums
, 
li¡
) {

4415 ià(!
»t
)

4416 
»t
 = 
	`log_csums
(
Œªs
, 
šode
, 
log
, 
sums
);

4417 
	`li¡_d–
(&
sums
->
li¡
);

4418 
	`kä“
(
sums
);

4420 ià(
»t
)

4421 
out
;

4423 
add_to_b©ch
:

4424 
šs_sizes
[
d¡_šdex
] = 
	`bŒfs_™em_size
(
¤c
, 
¤c_¦Ù
);

4425 
b©ch
.
tÙ®_d©a_size
 +ğ
šs_sizes
[
d¡_šdex
];

4426 
b©ch
.
Ä
++;

4427 
d¡_šdex
++;

4434 ià(
b©ch
.
Ä
 == 0)

4435 
out
;

4437 
»t
 = 
	`bŒfs_š£¹_em±y_™ems
(
Œªs
, 
log
, 
d¡_·th
, &
b©ch
);

4438 ià(
»t
)

4439 
out
;

4441 
d¡_šdex
 = 0;

4442 
i
 = 0; i < 
Ä
; i++) {

4443 cÚ¡ 
¤c_¦Ù
 = 
¡¬t_¦Ù
 + 
i
;

4444 cÚ¡ 
d¡_¦Ù
 = 
d¡_·th
->
¦Ùs
[0] + 
d¡_šdex
;

4445 
bŒfs_key
 
key
;

4446 
¤c_off£t
;

4447 
d¡_off£t
;

4453 ià(
d¡_šdex
 >ğ
b©ch
.
Ä
)

4456 
	`bŒfs_™em_key_to_ıu
(
¤c
, &
key
, 
¤c_¦Ù
);

4458 ià(
key
.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

4459 
cİy_™em
;

4461 
ex‹Á
 = 
	`bŒfs_™em_±r
(
¤c
, 
¤c_¦Ù
,

4462 
bŒfs_fe_ex‹Á_™em
);

4465 ià(
	`bŒfs_fe_ex‹Á_g’”©iÚ
(
¤c
, 
ex‹Á
è< 
Œªs
->
Œªsid
 &&

4466 
key
.
off£t
 < 
i_size
 &&

4467 
šode
->
Ï¡_»æšk_Œªs
 < 
Œªs
->
Œªsid
)

4470 
cİy_™em
:

4471 
d¡_off£t
 = 
	`bŒfs_™em_±r_off£t
(
d¡_·th
->
nodes
[0], 
d¡_¦Ù
);

4472 
¤c_off£t
 = 
	`bŒfs_™em_±r_off£t
(
¤c
, 
¤c_¦Ù
);

4474 ià(
key
.
ty³
 =ğ
BTRFS_INODE_ITEM_KEY
) {

4475 
bŒfs_šode_™em
 *
šode_™em
;

4477 
šode_™em
 = 
	`bŒfs_™em_±r
(
d¡_·th
->
nodes
[0], 
d¡_¦Ù
,

4478 
bŒfs_šode_™em
);

4479 
	`fl_šode_™em
(
Œªs
, 
d¡_·th
->
nodes
[0], 
šode_™em
,

4480 &
šode
->
vfs_šode
,

4481 
šode_Úly
 =ğ
LOG_INODE_EXISTS
,

4482 
logged_isize
);

4484 
	`cİy_ex‹Á_bufãr
(
d¡_·th
->
nodes
[0], 
¤c
, 
d¡_off£t
,

4485 
¤c_off£t
, 
šs_sizes
[
d¡_šdex
]);

4488 
d¡_šdex
++;

4491 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
d¡_·th
->
nodes
[0]);

4492 
	`bŒfs_»Ëa£_·th
(
d¡_·th
);

4493 
out
:

4494 
	`kä“
(
šs_d©a
);

4496  
»t
;

4497 
	}
}

4499 
	$ex‹Á_cmp
(*
´iv
, cÚ¡ 
li¡_h—d
 *
a
,

4500 cÚ¡ 
li¡_h—d
 *
b
)

4502 cÚ¡ 
ex‹Á_m­
 *
em1
, *
em2
;

4504 
em1
 = 
	`li¡_’Œy
(
a
, 
ex‹Á_m­
, 
li¡
);

4505 
em2
 = 
	`li¡_’Œy
(
b
, 
ex‹Á_m­
, 
li¡
);

4507 ià(
em1
->
¡¬t
 < 
em2
->start)

4509 ià(
em1
->
¡¬t
 > 
em2
->start)

4512 
	}
}

4514 
	$log_ex‹Á_csums
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4515 
bŒfs_šode
 *
šode
,

4516 
bŒfs_roÙ
 *
log_roÙ
,

4517 cÚ¡ 
ex‹Á_m­
 *
em
,

4518 
bŒfs_log_ùx
 *
ùx
)

4520 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

4521 
bŒfs_roÙ
 *
csum_roÙ
;

4522 
u64
 
csum_off£t
;

4523 
u64
 
csum_Ën
;

4524 
u64
 
mod_¡¬t
 = 
em
->mod_start;

4525 
u64
 
mod_Ën
 = 
em
->mod_len;

4526 
	`LIST_HEAD
(
Üd”ed_sums
);

4527 
»t
 = 0;

4529 ià(
šode
->
æags
 & 
BTRFS_INODE_NODATASUM
 ||

4530 
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
) ||

4531 
em
->
block_¡¬t
 =ğ
EXTENT_MAP_HOLE
)

4534 
	`li¡_fÜ_—ch_’Œy
(
Üd”ed
, &
ùx
->
Üd”ed_ex‹Ás
, 
log_li¡
) {

4535 cÚ¡ 
u64
 
Üd”ed_’d
 = 
Üd”ed
->
fe_off£t
 + ord”ed->
num_by‹s
;

4536 cÚ¡ 
u64
 
mod_’d
 = 
mod_¡¬t
 + 
mod_Ën
;

4537 
bŒfs_Üd”ed_sum
 *
sums
;

4539 ià(
mod_Ën
 == 0)

4542 ià(
Üd”ed_’d
 <ğ
mod_¡¬t
)

4544 ià(
mod_’d
 <ğ
Üd”ed
->
fe_off£t
)

4552 ià(
Üd”ed
->
fe_off£t
 > 
mod_¡¬t
) {

4553 ià(
Üd”ed_’d
 >ğ
mod_’d
)

4554 
mod_Ën
 = 
Üd”ed
->
fe_off£t
 - 
mod_¡¬t
;

4566 ià(
Üd”ed_’d
 < 
mod_’d
) {

4567 
mod_Ën
 = 
mod_’d
 - 
Üd”ed_’d
;

4568 
mod_¡¬t
 = 
Üd”ed_’d
;

4570 
mod_Ën
 = 0;

4578 ià(
	`‹¡_ªd_£t_b™
(
BTRFS_ORDERED_LOGGED_CSUM
, &
Üd”ed
->
æags
))

4581 
	`li¡_fÜ_—ch_’Œy
(
sums
, &
Üd”ed
->
li¡
,†ist) {

4582 
»t
 = 
	`log_csums
(
Œªs
, 
šode
, 
log_roÙ
, 
sums
);

4583 ià(
»t
)

4584  
»t
;

4589 ià(
mod_Ën
 == 0)

4593 ià(
em
->
com´ess_ty³
) {

4594 
csum_off£t
 = 0;

4595 
csum_Ën
 = 
	`max
(
em
->
block_Ën
,ƒm->
Üig_block_Ën
);

4597 
csum_off£t
 = 
mod_¡¬t
 - 
em
->
¡¬t
;

4598 
csum_Ën
 = 
mod_Ën
;

4602 
csum_roÙ
 = 
	`bŒfs_csum_roÙ
(
Œªs
->
fs_šfo
, 
em
->
block_¡¬t
);

4603 
»t
 = 
	`bŒfs_lookup_csums_li¡
(
csum_roÙ
, 
em
->
block_¡¬t
 + 
csum_off£t
,

4604 
em
->
block_¡¬t
 + 
csum_off£t
 +

4605 
csum_Ën
 - 1, &
Üd”ed_sums
, 0, 
çl£
);

4606 ià(
»t
)

4607  
»t
;

4609 !
	`li¡_em±y
(&
Üd”ed_sums
)) {

4610 
bŒfs_Üd”ed_sum
 *
sums
 = 
	`li¡_’Œy
(
Üd”ed_sums
.
Ãxt
,

4611 
bŒfs_Üd”ed_sum
,

4612 
li¡
);

4613 ià(!
»t
)

4614 
»t
 = 
	`log_csums
(
Œªs
, 
šode
, 
log_roÙ
, 
sums
);

4615 
	`li¡_d–
(&
sums
->
li¡
);

4616 
	`kä“
(
sums
);

4619  
»t
;

4620 
	}
}

4622 
	$log_Úe_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4623 
bŒfs_šode
 *
šode
,

4624 cÚ¡ 
ex‹Á_m­
 *
em
,

4625 
bŒfs_·th
 *
·th
,

4626 
bŒfs_log_ùx
 *
ùx
)

4628 
bŒfs_drİ_ex‹Ás_¬gs
 
drİ_¬gs
 = { 0 };

4629 
bŒfs_roÙ
 *
log
 = 
šode
->
roÙ
->
log_roÙ
;

4630 
bŒfs_fe_ex‹Á_™em
 
fi
 = { 0 };

4631 
ex‹Á_bufãr
 *
Ëaf
;

4632 
bŒfs_key
 
key
;

4633 
u64
 
ex‹Á_off£t
 = 
em
->
¡¬t
 -ƒm->
Üig_¡¬t
;

4634 
u64
 
block_Ën
;

4635 
»t
;

4637 
	`bŒfs_£t_¡ack_fe_ex‹Á_g’”©iÚ
(&
fi
, 
Œªs
->
Œªsid
);

4638 ià(
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
))

4639 
	`bŒfs_£t_¡ack_fe_ex‹Á_ty³
(&
fi
, 
BTRFS_FILE_EXTENT_PREALLOC
);

4641 
	`bŒfs_£t_¡ack_fe_ex‹Á_ty³
(&
fi
, 
BTRFS_FILE_EXTENT_REG
);

4643 
block_Ën
 = 
	`max
(
em
->block_Ën,ƒm->
Üig_block_Ën
);

4644 ià(
em
->
com´ess_ty³
 !ğ
BTRFS_COMPRESS_NONE
) {

4645 
	`bŒfs_£t_¡ack_fe_ex‹Á_disk_by‹Ä
(&
fi
, 
em
->
block_¡¬t
);

4646 
	`bŒfs_£t_¡ack_fe_ex‹Á_disk_num_by‹s
(&
fi
, 
block_Ën
);

4647 } ià(
em
->
block_¡¬t
 < 
EXTENT_MAP_LAST_BYTE
) {

4648 
	`bŒfs_£t_¡ack_fe_ex‹Á_disk_by‹Ä
(&
fi
, 
em
->
block_¡¬t
 -

4649 
ex‹Á_off£t
);

4650 
	`bŒfs_£t_¡ack_fe_ex‹Á_disk_num_by‹s
(&
fi
, 
block_Ën
);

4653 
	`bŒfs_£t_¡ack_fe_ex‹Á_off£t
(&
fi
, 
ex‹Á_off£t
);

4654 
	`bŒfs_£t_¡ack_fe_ex‹Á_num_by‹s
(&
fi
, 
em
->
Ën
);

4655 
	`bŒfs_£t_¡ack_fe_ex‹Á_¿m_by‹s
(&
fi
, 
em
->
¿m_by‹s
);

4656 
	`bŒfs_£t_¡ack_fe_ex‹Á_com´essiÚ
(&
fi
, 
em
->
com´ess_ty³
);

4658 
»t
 = 
	`log_ex‹Á_csums
(
Œªs
, 
šode
, 
log
, 
em
, 
ùx
);

4659 ià(
»t
)

4660  
»t
;

4671 ià(
ùx
->
logged_befÜe
) {

4672 
drİ_¬gs
.
·th
 =…ath;

4673 
drİ_¬gs
.
¡¬t
 = 
em
->start;

4674 
drİ_¬gs
.
’d
 = 
em
->
¡¬t
 +ƒm->
Ën
;

4675 
drİ_¬gs
.
»¶aû_ex‹Á
 = 
Œue
;

4676 
drİ_¬gs
.
ex‹Á_™em_size
 = (
fi
);

4677 
»t
 = 
	`bŒfs_drİ_ex‹Ás
(
Œªs
, 
log
, 
šode
, &
drİ_¬gs
);

4678 ià(
»t
)

4679  
»t
;

4682 ià(!
drİ_¬gs
.
ex‹Á_š£¹ed
) {

4683 
key
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

4684 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

4685 
key
.
off£t
 = 
em
->
¡¬t
;

4687 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
log
, 
·th
, &
key
,

4688 (
fi
));

4689 ià(
»t
)

4690  
»t
;

4692 
Ëaf
 = 
·th
->
nodes
[0];

4693 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, &
fi
,

4694 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]),

4695 (
fi
));

4696 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

4698 
	`bŒfs_»Ëa£_·th
(
·th
);

4700  
»t
;

4701 
	}
}

4711 
	$bŒfs_log_´—Îoc_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4712 
bŒfs_šode
 *
šode
,

4713 
bŒfs_·th
 *
·th
)

4715 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

4716 
bŒfs_key
 
key
;

4717 cÚ¡ 
u64
 
i_size
 = 
	`i_size_»ad
(&
šode
->
vfs_šode
);

4718 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

4719 
bŒfs_·th
 *
d¡_·th
 = 
NULL
;

4720 
boŞ
 
drİ³d_ex‹Ás
 = 
çl£
;

4721 
u64
 
Œunÿ‹_off£t
 = 
i_size
;

4722 
ex‹Á_bufãr
 *
Ëaf
;

4723 
¦Ù
;

4724 
šs_Ä
 = 0;

4725 
¡¬t_¦Ù
 = 0;

4726 
»t
;

4728 ià(!(
šode
->
æags
 & 
BTRFS_INODE_PREALLOC
))

4731 
key
.
objeùid
 = 
šo
;

4732 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

4733 
key
.
off£t
 = 
i_size
;

4734 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

4735 ià(
»t
 < 0)

4736 
out
;

4746 
»t
 = 
	`bŒfs_´evious_™em
(
roÙ
, 
·th
, 
šo
, 
BTRFS_EXTENT_DATA_KEY
);

4747 ià(
»t
 < 0)

4748 
out
;

4750 ià(
»t
 == 0) {

4751 
bŒfs_fe_ex‹Á_™em
 *
ei
;

4753 
Ëaf
 = 
·th
->
nodes
[0];

4754 
¦Ù
 = 
·th
->
¦Ùs
[0];

4755 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_fe_ex‹Á_™em
);

4757 ià(
	`bŒfs_fe_ex‹Á_ty³
(
Ëaf
, 
ei
) ==

4758 
BTRFS_FILE_EXTENT_PREALLOC
) {

4759 
u64
 
ex‹Á_’d
;

4761 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

4762 
ex‹Á_’d
 = 
key
.
off£t
 +

4763 
	`bŒfs_fe_ex‹Á_num_by‹s
(
Ëaf
, 
ei
);

4765 ià(
ex‹Á_’d
 > 
i_size
)

4766 
Œunÿ‹_off£t
 = 
ex‹Á_’d
;

4769 
»t
 = 0;

4772 
Œue
) {

4773 
Ëaf
 = 
·th
->
nodes
[0];

4774 
¦Ù
 = 
·th
->
¦Ùs
[0];

4776 ià(
¦Ù
 >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

4777 ià(
šs_Ä
 > 0) {

4778 
»t
 = 
	`cİy_™ems
(
Œªs
, 
šode
, 
d¡_·th
, 
·th
,

4779 
¡¬t_¦Ù
, 
šs_Ä
, 1, 0);

4780 ià(
»t
 < 0)

4781 
out
;

4782 
šs_Ä
 = 0;

4784 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

4785 ià(
»t
 < 0)

4786 
out
;

4787 ià(
»t
 > 0) {

4788 
»t
 = 0;

4794 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

4795 ià(
key
.
objeùid
 > 
šo
)

4797 ià(
	`WARN_ON_ONCE
(
key
.
objeùid
 < 
šo
) ||

4798 
key
.
ty³
 < 
BTRFS_EXTENT_DATA_KEY
 ||

4799 
key
.
off£t
 < 
i_size
) {

4800 
·th
->
¦Ùs
[0]++;

4803 ià(!
drİ³d_ex‹Ás
) {

4808 
»t
 = 
	`Œunÿ‹_šode_™ems
(
Œªs
, 
roÙ
->
log_roÙ
, 
šode
,

4809 
Œunÿ‹_off£t
,

4810 
BTRFS_EXTENT_DATA_KEY
);

4811 ià(
»t
)

4812 
out
;

4813 
drİ³d_ex‹Ás
 = 
Œue
;

4815 ià(
šs_Ä
 == 0)

4816 
¡¬t_¦Ù
 = 
¦Ù
;

4817 
šs_Ä
++;

4818 
·th
->
¦Ùs
[0]++;

4819 ià(!
d¡_·th
) {

4820 
d¡_·th
 = 
	`bŒfs_®loc_·th
();

4821 ià(!
d¡_·th
) {

4822 
»t
 = -
ENOMEM
;

4823 
out
;

4827 ià(
šs_Ä
 > 0)

4828 
»t
 = 
	`cİy_™ems
(
Œªs
, 
šode
, 
d¡_·th
, 
·th
,

4829 
¡¬t_¦Ù
, 
šs_Ä
, 1, 0);

4830 
out
:

4831 
	`bŒfs_»Ëa£_·th
(
·th
);

4832 
	`bŒfs_ä“_·th
(
d¡_·th
);

4833  
»t
;

4834 
	}
}

4836 
	$bŒfs_log_chªged_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4837 
bŒfs_šode
 *
šode
,

4838 
bŒfs_·th
 *
·th
,

4839 
bŒfs_log_ùx
 *
ùx
)

4841 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

4842 
bŒfs_Üd”ed_ex‹Á
 *
tmp
;

4843 
ex‹Á_m­
 *
em
, *
n
;

4844 
	`LIST_HEAD
(
ex‹Ás
);

4845 
ex‹Á_m­_Œ“
 *
Œ“
 = &
šode
->
ex‹Á_Œ“
;

4846 
»t
 = 0;

4847 
num
 = 0;

4849 
	`wr™e_lock
(&
Œ“
->
lock
);

4851 
	`li¡_fÜ_—ch_’Œy_§ã
(
em
, 
n
, &
Œ“
->
modif›d_ex‹Ás
, 
li¡
) {

4852 
	`li¡_d–_š™
(&
em
->
li¡
);

4859 ià(++
num
 > 32768) {

4860 
	`li¡_d–_š™
(&
Œ“
->
modif›d_ex‹Ás
);

4861 
»t
 = -
EFBIG
;

4862 
´oûss
;

4865 ià(
em
->
g’”©iÚ
 < 
Œªs
->
Œªsid
)

4869 ià(
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
) &&

4870 
em
->
¡¬t
 >ğ
	`i_size_»ad
(&
šode
->
vfs_šode
))

4874 
	`»fcouÁ_šc
(&
em
->
»fs
);

4875 
	`£t_b™
(
EXTENT_FLAG_LOGGING
, &
em
->
æags
);

4876 
	`li¡_add_
(&
em
->
li¡
, &
ex‹Ás
);

4877 
num
++;

4880 
	`li¡_sÜt
(
NULL
, &
ex‹Ás
, 
ex‹Á_cmp
);

4881 
´oûss
:

4882 !
	`li¡_em±y
(&
ex‹Ás
)) {

4883 
em
 = 
	`li¡_’Œy
(
ex‹Ás
.
Ãxt
, 
ex‹Á_m­
, 
li¡
);

4885 
	`li¡_d–_š™
(&
em
->
li¡
);

4891 ià(
»t
) {

4892 
	`ş—r_em_loggšg
(
Œ“
, 
em
);

4893 
	`ä“_ex‹Á_m­
(
em
);

4897 
	`wr™e_uÆock
(&
Œ“
->
lock
);

4899 
»t
 = 
	`log_Úe_ex‹Á
(
Œªs
, 
šode
, 
em
, 
·th
, 
ùx
);

4900 
	`wr™e_lock
(&
Œ“
->
lock
);

4901 
	`ş—r_em_loggšg
(
Œ“
, 
em
);

4902 
	`ä“_ex‹Á_m­
(
em
);

4904 
	`WARN_ON
(!
	`li¡_em±y
(&
ex‹Ás
));

4905 
	`wr™e_uÆock
(&
Œ“
->
lock
);

4907 ià(!
»t
)

4908 
»t
 = 
	`bŒfs_log_´—Îoc_ex‹Ás
(
Œªs
, 
šode
, 
·th
);

4909 ià(
»t
)

4910  
»t
;

4919 
	`li¡_fÜ_—ch_’Œy_§ã
(
Üd”ed
, 
tmp
, &
ùx
->
Üd”ed_ex‹Ás
, 
log_li¡
) {

4920 
	`li¡_d–_š™
(&
Üd”ed
->
log_li¡
);

4921 
	`£t_b™
(
BTRFS_ORDERED_LOGGED
, &
Üd”ed
->
æags
);

4923 ià(!
	`‹¡_b™
(
BTRFS_ORDERED_COMPLETE
, &
Üd”ed
->
æags
)) {

4924 
	`¥š_lock_œq
(&
šode
->
Üd”ed_Œ“
.
lock
);

4925 ià(!
	`‹¡_b™
(
BTRFS_ORDERED_COMPLETE
, &
Üd”ed
->
æags
)) {

4926 
	`£t_b™
(
BTRFS_ORDERED_PENDING
, &
Üd”ed
->
æags
);

4927 
	`©omic_šc
(&
Œªs
->
Œª§ùiÚ
->
³ndšg_Üd”ed
);

4929 
	`¥š_uÆock_œq
(&
šode
->
Üd”ed_Œ“
.
lock
);

4931 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

4935 
	}
}

4937 
	$logged_šode_size
(
bŒfs_roÙ
 *
log
, 
bŒfs_šode
 *
šode
,

4938 
bŒfs_·th
 *
·th
, 
u64
 *
size_»t
)

4940 
bŒfs_key
 
key
;

4941 
»t
;

4943 
key
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

4944 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

4945 
key
.
off£t
 = 0;

4947 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
log
, &
key
, 
·th
, 0, 0);

4948 ià(
»t
 < 0) {

4949  
»t
;

4950 } ià(
»t
 > 0) {

4951 *
size_»t
 = 0;

4953 
bŒfs_šode_™em
 *
™em
;

4955 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

4956 
bŒfs_šode_™em
);

4957 *
size_»t
 = 
	`bŒfs_šode_size
(
·th
->
nodes
[0], 
™em
);

4969 ià(*
size_»t
 > 
šode
->
vfs_šode
.
i_size
)

4970 *
size_»t
 = 
šode
->
vfs_šode
.
i_size
;

4973 
	`bŒfs_»Ëa£_·th
(
·th
);

4975 
	}
}

4986 
	$bŒfs_log_®l_x©Œs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4987 
bŒfs_šode
 *
šode
,

4988 
bŒfs_·th
 *
·th
,

4989 
bŒfs_·th
 *
d¡_·th
)

4991 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

4992 
»t
;

4993 
bŒfs_key
 
key
;

4994 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

4995 
šs_Ä
 = 0;

4996 
¡¬t_¦Ù
 = 0;

4997 
boŞ
 
found_x©Œs
 = 
çl£
;

4999 ià(
	`‹¡_b™
(
BTRFS_INODE_NO_XATTRS
, &
šode
->
ruÁime_æags
))

5002 
key
.
objeùid
 = 
šo
;

5003 
key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

5004 
key
.
off£t
 = 0;

5006 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

5007 ià(
»t
 < 0)

5008  
»t
;

5010 
Œue
) {

5011 
¦Ù
 = 
·th
->
¦Ùs
[0];

5012 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

5013 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

5015 ià(
¦Ù
 >ğ
Ä™ems
) {

5016 ià(
šs_Ä
 > 0) {

5017 
»t
 = 
	`cİy_™ems
(
Œªs
, 
šode
, 
d¡_·th
, 
·th
,

5018 
¡¬t_¦Ù
, 
šs_Ä
, 1, 0);

5019 ià(
»t
 < 0)

5020  
»t
;

5021 
šs_Ä
 = 0;

5023 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

5024 ià(
»t
 < 0)

5025  
»t
;

5026 ià(
»t
 > 0)

5031 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

5032 ià(
key
.
objeùid
 !ğ
šo
 || key.
ty³
 !ğ
BTRFS_XATTR_ITEM_KEY
)

5035 ià(
šs_Ä
 == 0)

5036 
¡¬t_¦Ù
 = 
¦Ù
;

5037 
šs_Ä
++;

5038 
·th
->
¦Ùs
[0]++;

5039 
found_x©Œs
 = 
Œue
;

5040 
	`cÚd_»sched
();

5042 ià(
šs_Ä
 > 0) {

5043 
»t
 = 
	`cİy_™ems
(
Œªs
, 
šode
, 
d¡_·th
, 
·th
,

5044 
¡¬t_¦Ù
, 
šs_Ä
, 1, 0);

5045 ià(
»t
 < 0)

5046  
»t
;

5049 ià(!
found_x©Œs
)

5050 
	`£t_b™
(
BTRFS_INODE_NO_XATTRS
, &
šode
->
ruÁime_æags
);

5053 
	}
}

5064 
	$bŒfs_log_hŞes
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5065 
bŒfs_šode
 *
šode
,

5066 
bŒfs_·th
 *
·th
)

5068 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

5069 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5070 
bŒfs_key
 
key
;

5071 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

5072 cÚ¡ 
u64
 
i_size
 = 
	`i_size_»ad
(&
šode
->
vfs_šode
);

5073 
u64
 
´ev_ex‹Á_’d
 = 0;

5074 
»t
;

5076 ià(!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
NO_HOLES
è|| 
i_size
 == 0)

5079 
key
.
objeùid
 = 
šo
;

5080 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

5081 
key
.
off£t
 = 0;

5083 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

5084 ià(
»t
 < 0)

5085  
»t
;

5087 
Œue
) {

5088 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

5090 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0])) {

5091 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

5092 ià(
»t
 < 0)

5093  
»t
;

5094 ià(
»t
 > 0) {

5095 
»t
 = 0;

5098 
Ëaf
 = 
·th
->
nodes
[0];

5101 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

5102 ià(
key
.
objeùid
 !ğ
šo
 || key.
ty³
 !ğ
BTRFS_EXTENT_DATA_KEY
)

5106 ià(
´ev_ex‹Á_’d
 < 
key
.
off£t
) {

5107 cÚ¡ 
u64
 
hŞe_Ën
 = 
key
.
off£t
 - 
´ev_ex‹Á_’d
;

5114 
	`bŒfs_»Ëa£_·th
(
·th
);

5115 
»t
 = 
	`bŒfs_š£¹_hŞe_ex‹Á
(
Œªs
, 
roÙ
->
log_roÙ
,

5116 
šo
, 
´ev_ex‹Á_’d
,

5117 
hŞe_Ën
);

5118 ià(
»t
 < 0)

5119  
»t
;

5128 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

5129 ià(
»t
 < 0)

5130  
»t
;

5131 ià(
	`WARN_ON
(
»t
 > 0))

5132  -
ENOENT
;

5133 
Ëaf
 = 
·th
->
nodes
[0];

5136 
´ev_ex‹Á_’d
 = 
	`bŒfs_fe_ex‹Á_’d
(
·th
);

5137 
·th
->
¦Ùs
[0]++;

5138 
	`cÚd_»sched
();

5141 ià(
´ev_ex‹Á_’d
 < 
i_size
) {

5142 
u64
 
hŞe_Ën
;

5144 
	`bŒfs_»Ëa£_·th
(
·th
);

5145 
hŞe_Ën
 = 
	`ALIGN
(
i_size
 - 
´ev_ex‹Á_’d
, 
fs_šfo
->
£ùÜsize
);

5146 
»t
 = 
	`bŒfs_š£¹_hŞe_ex‹Á
(
Œªs
, 
roÙ
->
log_roÙ
, 
šo
,

5147 
´ev_ex‹Á_’d
, 
hŞe_Ën
);

5148 ià(
»t
 < 0)

5149  
»t
;

5153 
	}
}

5197 
	$bŒfs_check_»f_Çme_ov”ride
(
ex‹Á_bufãr
 *
eb
,

5198 cÚ¡ 
¦Ù
,

5199 cÚ¡ 
bŒfs_key
 *
key
,

5200 
bŒfs_šode
 *
šode
,

5201 
u64
 *
Ùh”_šo
, u64 *
Ùh”_·»Á
)

5203 
»t
;

5204 
bŒfs_·th
 *
£¬ch_·th
;

5205 *
Çme
 = 
NULL
;

5206 
u32
 
Çme_Ën
 = 0;

5207 
u32
 
™em_size
 = 
	`bŒfs_™em_size
(
eb
, 
¦Ù
);

5208 
u32
 
cur_off£t
 = 0;

5209 
±r
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

5211 
£¬ch_·th
 = 
	`bŒfs_®loc_·th
();

5212 ià(!
£¬ch_·th
)

5213  -
ENOMEM
;

5214 
£¬ch_·th
->
£¬ch_comm™_roÙ
 = 1;

5215 
£¬ch_·th
->
sk_lockšg
 = 1;

5217 
cur_off£t
 < 
™em_size
) {

5218 
u64
 
·»Á
;

5219 
u32
 
this_Çme_Ën
;

5220 
u32
 
this_Ën
;

5221 
Çme_±r
;

5222 
bŒfs_dœ_™em
 *
di
;

5223 
fsüy±_¡r
 
Çme_¡r
;

5225 ià(
key
->
ty³
 =ğ
BTRFS_INODE_REF_KEY
) {

5226 
bŒfs_šode_»f
 *
œef
;

5228 
œef
 = (
bŒfs_šode_»f
 *)(
±r
 + 
cur_off£t
);

5229 
·»Á
 = 
key
->
off£t
;

5230 
this_Çme_Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
eb
, 
œef
);

5231 
Çme_±r
 = ()(
œef
 + 1);

5232 
this_Ën
 = (*
œef
è+ 
this_Çme_Ën
;

5234 
bŒfs_šode_exŒef
 *
exŒef
;

5236 
exŒef
 = (
bŒfs_šode_exŒef
 *)(
±r
 +

5237 
cur_off£t
);

5238 
·»Á
 = 
	`bŒfs_šode_exŒef_·»Á
(
eb
, 
exŒef
);

5239 
this_Çme_Ën
 = 
	`bŒfs_šode_exŒef_Çme_Ën
(
eb
, 
exŒef
);

5240 
Çme_±r
 = ()&
exŒef
->
Çme
;

5241 
this_Ën
 = (*
exŒef
è+ 
this_Çme_Ën
;

5244 ià(
this_Çme_Ën
 > 
Çme_Ën
) {

5245 *
Ãw_Çme
;

5247 
Ãw_Çme
 = 
	`k»®loc
(
Çme
, 
this_Çme_Ën
, 
GFP_NOFS
);

5248 ià(!
Ãw_Çme
) {

5249 
»t
 = -
ENOMEM
;

5250 
out
;

5252 
Çme_Ën
 = 
this_Çme_Ën
;

5253 
Çme
 = 
Ãw_Çme
;

5256 
	`»ad_ex‹Á_bufãr
(
eb
, 
Çme
, 
Çme_±r
, 
this_Çme_Ën
);

5258 
Çme_¡r
.
Çme
 =‚ame;

5259 
Çme_¡r
.
Ën
 = 
this_Çme_Ën
;

5260 
di
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
šode
->
roÙ
, 
£¬ch_·th
,

5261 
·»Á
, &
Çme_¡r
, 0);

5262 ià(
di
 && !
	`IS_ERR
(di)) {

5263 
bŒfs_key
 
di_key
;

5265 
	`bŒfs_dœ_™em_key_to_ıu
(
£¬ch_·th
->
nodes
[0],

5266 
di
, &
di_key
);

5267 ià(
di_key
.
ty³
 =ğ
BTRFS_INODE_ITEM_KEY
) {

5268 ià(
di_key
.
objeùid
 !ğ
key
->objectid) {

5269 
»t
 = 1;

5270 *
Ùh”_šo
 = 
di_key
.
objeùid
;

5271 *
Ùh”_·»Á
 = 
·»Á
;

5273 
»t
 = 0;

5276 
»t
 = -
EAGAIN
;

5278 
out
;

5279 } ià(
	`IS_ERR
(
di
)) {

5280 
»t
 = 
	`PTR_ERR
(
di
);

5281 
out
;

5283 
	`bŒfs_»Ëa£_·th
(
£¬ch_·th
);

5285 
cur_off£t
 +ğ
this_Ën
;

5287 
»t
 = 0;

5288 
out
:

5289 
	`bŒfs_ä“_·th
(
£¬ch_·th
);

5290 
	`kä“
(
Çme
);

5291  
»t
;

5292 
	}
}

5303 
boŞ
 
	$Ãed_log_šode
(cÚ¡ 
bŒfs_Œªs_hªdË
 *
Œªs
,

5304 
bŒfs_šode
 *
šode
)

5310 ià(
	`S_ISDIR
(
šode
->
vfs_šode
.
i_mode
è&& inode->
Ï¡_Œªs
 < 
Œªs
->
Œªsid
)

5311  
çl£
;

5322 ià(
	`šode_logged
(
Œªs
, 
šode
, 
NULL
) == 1 &&

5323 !
	`‹¡_b™
(
BTRFS_INODE_COPY_EVERYTHING
, &
šode
->
ruÁime_æags
))

5324  
çl£
;

5326  
Œue
;

5327 
	}
}

5329 
	sbŒfs_dœ_li¡
 {

5330 
u64
 
	mšo
;

5331 
li¡_h—d
 
	mli¡
;

5370 
	$log_Ãw_dœ_d’Œ›s
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5371 
bŒfs_šode
 *
¡¬t_šode
,

5372 
bŒfs_log_ùx
 *
ùx
)

5374 
bŒfs_roÙ
 *
roÙ
 = 
¡¬t_šode
->root;

5375 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5376 
bŒfs_·th
 *
·th
;

5377 
	`LIST_HEAD
(
dœ_li¡
);

5378 
bŒfs_dœ_li¡
 *
dœ_–em
;

5379 
u64
 
šo
 = 
	`bŒfs_šo
(
¡¬t_šode
);

5380 
bŒfs_šode
 *
cu¼_šode
 = 
¡¬t_šode
;

5381 
»t
 = 0;

5388 ià(
ùx
->
loggšg_Ãw_Çme
)

5391 
·th
 = 
	`bŒfs_®loc_·th
();

5392 ià(!
·th
)

5393  -
ENOMEM
;

5396 
	`ihŞd
(&
cu¼_šode
->
vfs_šode
);

5398 
Œue
) {

5399 
šode
 *
vfs_šode
;

5400 
bŒfs_key
 
key
;

5401 
bŒfs_key
 
found_key
;

5402 
u64
 
Ãxt_šdex
;

5403 
boŞ
 
cÚtšue_cu¼_šode
 = 
Œue
;

5404 
™”_»t
;

5406 
key
.
objeùid
 = 
šo
;

5407 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

5408 
key
.
off£t
 = 
	`bŒfs_g‘_fœ¡_dœ_šdex_to_log
(
cu¼_šode
);

5409 
Ãxt_šdex
 = 
key
.
off£t
;

5410 
agaš
:

5411 
	`bŒfs_fÜ_—ch_¦Ù
(
roÙ
->
log_roÙ
, &
key
, &
found_key
, 
·th
, 
™”_»t
) {

5412 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

5413 
bŒfs_dœ_™em
 *
di
;

5414 
bŒfs_key
 
di_key
;

5415 
šode
 *
di_šode
;

5416 
log_mode
 = 
LOG_INODE_EXISTS
;

5417 
ty³
;

5419 ià(
found_key
.
objeùid
 !ğ
šo
 ||

5420 
found_key
.
ty³
 !ğ
BTRFS_DIR_INDEX_KEY
) {

5421 
cÚtšue_cu¼_šode
 = 
çl£
;

5425 
Ãxt_šdex
 = 
found_key
.
off£t
 + 1;

5427 
di
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_dœ_™em
);

5428 
ty³
 = 
	`bŒfs_dœ_áy³
(
Ëaf
, 
di
);

5429 ià(
	`bŒfs_dœ_Œªsid
(
Ëaf
, 
di
è< 
Œªs
->
Œªsid
)

5431 
	`bŒfs_dœ_™em_key_to_ıu
(
Ëaf
, 
di
, &
di_key
);

5432 ià(
di_key
.
ty³
 =ğ
BTRFS_ROOT_ITEM_KEY
)

5435 
	`bŒfs_»Ëa£_·th
(
·th
);

5436 
di_šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
di_key
.
objeùid
, 
roÙ
);

5437 ià(
	`IS_ERR
(
di_šode
)) {

5438 
»t
 = 
	`PTR_ERR
(
di_šode
);

5439 
out
;

5442 ià(!
	`Ãed_log_šode
(
Œªs
, 
	`BTRFS_I
(
di_šode
))) {

5443 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
di_šode
));

5447 
ùx
->
log_Ãw_d’Œ›s
 = 
çl£
;

5448 ià(
ty³
 =ğ
BTRFS_FT_DIR
)

5449 
log_mode
 = 
LOG_INODE_ALL
;

5450 
»t
 = 
	`bŒfs_log_šode
(
Œªs
, 
	`BTRFS_I
(
di_šode
),

5451 
log_mode
, 
ùx
);

5452 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
di_šode
));

5453 ià(
»t
)

5454 
out
;

5455 ià(
ùx
->
log_Ãw_d’Œ›s
) {

5456 
dœ_–em
 = 
	`km®loc
((*dœ_–em), 
GFP_NOFS
);

5457 ià(!
dœ_–em
) {

5458 
»t
 = -
ENOMEM
;

5459 
out
;

5461 
dœ_–em
->
šo
 = 
di_key
.
objeùid
;

5462 
	`li¡_add_
(&
dœ_–em
->
li¡
, &
dœ_li¡
);

5467 
	`bŒfs_»Ëa£_·th
(
·th
);

5469 ià(
™”_»t
 < 0) {

5470 
»t
 = 
™”_»t
;

5471 
out
;

5472 } ià(
™”_»t
 > 0) {

5473 
cÚtšue_cu¼_šode
 = 
çl£
;

5475 
key
 = 
found_key
;

5478 ià(
cÚtšue_cu¼_šode
 && 
key
.
off£t
 < (
u64
)-1) {

5479 
key
.
off£t
++;

5480 
agaš
;

5483 
	`bŒfs_£t_fœ¡_dœ_šdex_to_log
(
cu¼_šode
, 
Ãxt_šdex
);

5485 ià(
	`li¡_em±y
(&
dœ_li¡
))

5488 
dœ_–em
 = 
	`li¡_fœ¡_’Œy
(&
dœ_li¡
, 
bŒfs_dœ_li¡
, 
li¡
);

5489 
šo
 = 
dœ_–em
->ino;

5490 
	`li¡_d–
(&
dœ_–em
->
li¡
);

5491 
	`kä“
(
dœ_–em
);

5493 
	`bŒfs_add_d–ayed_ut
(
cu¼_šode
);

5494 
cu¼_šode
 = 
NULL
;

5496 
vfs_šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
šo
, 
roÙ
);

5497 ià(
	`IS_ERR
(
vfs_šode
)) {

5498 
»t
 = 
	`PTR_ERR
(
vfs_šode
);

5501 
cu¼_šode
 = 
	`BTRFS_I
(
vfs_šode
);

5503 
out
:

5504 
	`bŒfs_ä“_·th
(
·th
);

5505 ià(
cu¼_šode
)

5506 
	`bŒfs_add_d–ayed_ut
(
cu¼_šode
);

5508 ià(
»t
) {

5509 
bŒfs_dœ_li¡
 *
Ãxt
;

5511 
	`li¡_fÜ_—ch_’Œy_§ã
(
dœ_–em
, 
Ãxt
, &
dœ_li¡
, 
li¡
)

5512 
	`kä“
(
dœ_–em
);

5515  
»t
;

5516 
	}
}

5518 
	sbŒfs_šo_li¡
 {

5519 
u64
 
	mšo
;

5520 
u64
 
	m·»Á
;

5521 
li¡_h—d
 
	mli¡
;

5524 
	$ä“_cÚæiùšg_šodes
(
bŒfs_log_ùx
 *
ùx
)

5526 
bŒfs_šo_li¡
 *
cu¼
;

5527 
bŒfs_šo_li¡
 *
Ãxt
;

5529 
	`li¡_fÜ_—ch_’Œy_§ã
(
cu¼
, 
Ãxt
, &
ùx
->
cÚæiù_šodes
, 
li¡
) {

5530 
	`li¡_d–
(&
cu¼
->
li¡
);

5531 
	`kä“
(
cu¼
);

5533 
	}
}

5535 
	$cÚæiùšg_šode_is_dœ
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
šo
,

5536 
bŒfs_·th
 *
·th
)

5538 
bŒfs_key
 
key
;

5539 
»t
;

5541 
key
.
objeùid
 = 
šo
;

5542 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

5543 
key
.
off£t
 = 0;

5545 
·th
->
£¬ch_comm™_roÙ
 = 1;

5546 
·th
->
sk_lockšg
 = 1;

5548 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

5549 ià(
	`WARN_ON_ONCE
(
»t
 > 0)) {

5555 
»t
 = -
ENOENT
;

5556 } ià(
»t
 == 0) {

5557 
bŒfs_šode_™em
 *
™em
;

5559 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

5560 
bŒfs_šode_™em
);

5561 ià(
	`S_ISDIR
(
	`bŒfs_šode_mode
(
·th
->
nodes
[0], 
™em
)))

5562 
»t
 = 1;

5565 
	`bŒfs_»Ëa£_·th
(
·th
);

5566 
·th
->
£¬ch_comm™_roÙ
 = 0;

5567 
·th
->
sk_lockšg
 = 0;

5569  
»t
;

5570 
	}
}

5572 
	$add_cÚæiùšg_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5573 
bŒfs_roÙ
 *
roÙ
,

5574 
bŒfs_·th
 *
·th
,

5575 
u64
 
šo
, u64 
·»Á
,

5576 
bŒfs_log_ùx
 *
ùx
)

5578 
bŒfs_šo_li¡
 *
šo_–em
;

5579 
šode
 *inode;

5588 ià(
ùx
->
num_cÚæiù_šodes
 >ğ
MAX_CONFLICT_INODES
)

5589  
BTRFS_LOG_FORCE_COMMIT
;

5591 
šode
 = 
	`bŒfs_ig‘
(
roÙ
->
fs_šfo
->
sb
, 
šo
,„oot);

5612 ià(
	`IS_ERR
(
šode
)) {

5613 
»t
 = 
	`PTR_ERR
(
šode
);

5615 ià(
»t
 !ğ-
ENOENT
)

5616  
»t
;

5618 
»t
 = 
	`cÚæiùšg_šode_is_dœ
(
roÙ
, 
šo
, 
·th
);

5620 ià(
»t
 <= 0)

5621  
»t
;

5624 
šo_–em
 = 
	`km®loc
((*šo_–em), 
GFP_NOFS
);

5625 ià(!
šo_–em
)

5626  -
ENOMEM
;

5627 
šo_–em
->
šo
 = ino;

5628 
šo_–em
->
·»Á
 =…arent;

5629 
	`li¡_add_
(&
šo_–em
->
li¡
, &
ùx
->
cÚæiù_šodes
);

5630 
ùx
->
num_cÚæiù_šodes
++;

5670 ià(!
	`Ãed_log_šode
(
Œªs
, 
	`BTRFS_I
(
šode
))) {

5671 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
šode
));

5675 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
šode
));

5677 
šo_–em
 = 
	`km®loc
((*šo_–em), 
GFP_NOFS
);

5678 ià(!
šo_–em
)

5679  -
ENOMEM
;

5680 
šo_–em
->
šo
 = ino;

5681 
šo_–em
->
·»Á
 =…arent;

5682 
	`li¡_add_
(&
šo_–em
->
li¡
, &
ùx
->
cÚæiù_šodes
);

5683 
ùx
->
num_cÚæiù_šodes
++;

5686 
	}
}

5688 
	$log_cÚæiùšg_šodes
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5689 
bŒfs_roÙ
 *
roÙ
,

5690 
bŒfs_log_ùx
 *
ùx
)

5692 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5693 
»t
 = 0;

5700 ià(
ùx
->
loggšg_cÚæiù_šodes
)

5703 
ùx
->
loggšg_cÚæiù_šodes
 = 
Œue
;

5710 !
	`li¡_em±y
(&
ùx
->
cÚæiù_šodes
)) {

5711 
bŒfs_šo_li¡
 *
cu¼
;

5712 
šode
 *inode;

5713 
u64
 
šo
;

5714 
u64
 
·»Á
;

5716 
cu¼
 = 
	`li¡_fœ¡_’Œy
(&
ùx
->
cÚæiù_šodes
,

5717 
bŒfs_šo_li¡
, 
li¡
);

5718 
šo
 = 
cu¼
->ino;

5719 
·»Á
 = 
cu¼
->parent;

5720 
	`li¡_d–
(&
cu¼
->
li¡
);

5721 
	`kä“
(
cu¼
);

5723 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
šo
, 
roÙ
);

5729 ià(
	`IS_ERR
(
šode
)) {

5730 
»t
 = 
	`PTR_ERR
(
šode
);

5731 ià(
»t
 !ğ-
ENOENT
)

5734 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
·»Á
, 
roÙ
);

5735 ià(
	`IS_ERR
(
šode
)) {

5736 
»t
 = 
	`PTR_ERR
(
šode
);

5748 
»t
 = 
	`bŒfs_log_šode
(
Œªs
, 
	`BTRFS_I
(
šode
),

5749 
LOG_INODE_ALL
, 
ùx
);

5750 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
šode
));

5751 ià(
»t
)

5766 ià(!
	`Ãed_log_šode
(
Œªs
, 
	`BTRFS_I
(
šode
))) {

5767 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
šode
));

5778 
»t
 = 
	`bŒfs_log_šode
(
Œªs
, 
	`BTRFS_I
(
šode
), 
LOG_INODE_EXISTS
, 
ùx
);

5779 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
šode
));

5780 ià(
»t
)

5784 
ùx
->
loggšg_cÚæiù_šodes
 = 
çl£
;

5785 ià(
»t
)

5786 
	`ä“_cÚæiùšg_šodes
(
ùx
);

5788  
»t
;

5789 
	}
}

5791 
	$cİy_šode_™ems_to_log
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5792 
bŒfs_šode
 *
šode
,

5793 
bŒfs_key
 *
mš_key
,

5794 cÚ¡ 
bŒfs_key
 *
max_key
,

5795 
bŒfs_·th
 *
·th
,

5796 
bŒfs_·th
 *
d¡_·th
,

5797 cÚ¡ 
u64
 
logged_isize
,

5798 cÚ¡ 
šode_Úly
,

5799 
bŒfs_log_ùx
 *
ùx
,

5800 
boŞ
 *
Ãed_log_šode_™em
)

5802 cÚ¡ 
u64
 
i_size
 = 
	`i_size_»ad
(&
šode
->
vfs_šode
);

5803 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

5804 
šs_¡¬t_¦Ù
 = 0;

5805 
šs_Ä
 = 0;

5806 
»t
;

5809 
»t
 = 
	`bŒfs_£¬ch_fÜw¬d
(
roÙ
, 
mš_key
, 
·th
, 
Œªs
->
Œªsid
);

5810 ià(
»t
 < 0)

5811  
»t
;

5812 ià(
»t
 > 0) {

5813 
»t
 = 0;

5816 
agaš
:

5818 ià(
mš_key
->
objeùid
 !ğ
max_key
->objectid)

5820 ià(
mš_key
->
ty³
 > 
max_key
->type)

5823 ià(
mš_key
->
ty³
 =ğ
BTRFS_INODE_ITEM_KEY
) {

5824 *
Ãed_log_šode_™em
 = 
çl£
;

5825 } ià(
mš_key
->
ty³
 =ğ
BTRFS_EXTENT_DATA_KEY
 &&

5826 
mš_key
->
off£t
 >ğ
i_size
) {

5834 } ià((
mš_key
->
ty³
 =ğ
BTRFS_INODE_REF_KEY
 ||

5835 
mš_key
->
ty³
 =ğ
BTRFS_INODE_EXTREF_KEY
) &&

5836 (
šode
->
g’”©iÚ
 =ğ
Œªs
->
Œªsid
 ||

5837 
ùx
->
loggšg_cÚæiù_šodes
)) {

5838 
u64
 
Ùh”_šo
 = 0;

5839 
u64
 
Ùh”_·»Á
 = 0;

5841 
»t
 = 
	`bŒfs_check_»f_Çme_ov”ride
(
·th
->
nodes
[0],

5842 
·th
->
¦Ùs
[0], 
mš_key
, 
šode
,

5843 &
Ùh”_šo
, &
Ùh”_·»Á
);

5844 ià(
»t
 < 0) {

5845  
»t
;

5846 } ià(
»t
 > 0 &&

5847 
Ùh”_šo
 !ğ
	`bŒfs_šo
(
	`BTRFS_I
(
ùx
->
šode
))) {

5848 ià(
šs_Ä
 > 0) {

5849 
šs_Ä
++;

5851 
šs_Ä
 = 1;

5852 
šs_¡¬t_¦Ù
 = 
·th
->
¦Ùs
[0];

5854 
»t
 = 
	`cİy_™ems
(
Œªs
, 
šode
, 
d¡_·th
, 
·th
,

5855 
šs_¡¬t_¦Ù
, 
šs_Ä
,

5856 
šode_Úly
, 
logged_isize
);

5857 ià(
»t
 < 0)

5858  
»t
;

5859 
šs_Ä
 = 0;

5861 
	`bŒfs_»Ëa£_·th
(
·th
);

5862 
»t
 = 
	`add_cÚæiùšg_šode
(
Œªs
, 
roÙ
, 
·th
,

5863 
Ùh”_šo
,

5864 
Ùh”_·»Á
, 
ùx
);

5865 ià(
»t
)

5866  
»t
;

5867 
Ãxt_key
;

5869 } ià(
mš_key
->
ty³
 =ğ
BTRFS_XATTR_ITEM_KEY
) {

5871 ià(
šs_Ä
 == 0)

5872 
Ãxt_¦Ù
;

5873 
»t
 = 
	`cİy_™ems
(
Œªs
, 
šode
, 
d¡_·th
, 
·th
,

5874 
šs_¡¬t_¦Ù
,

5875 
šs_Ä
, 
šode_Úly
, 
logged_isize
);

5876 ià(
»t
 < 0)

5877  
»t
;

5878 
šs_Ä
 = 0;

5879 
Ãxt_¦Ù
;

5882 ià(
šs_Ä
 && 
šs_¡¬t_¦Ù
 + ins_Ä =ğ
·th
->
¦Ùs
[0]) {

5883 
šs_Ä
++;

5884 
Ãxt_¦Ù
;

5885 } ià(!
šs_Ä
) {

5886 
šs_¡¬t_¦Ù
 = 
·th
->
¦Ùs
[0];

5887 
šs_Ä
 = 1;

5888 
Ãxt_¦Ù
;

5891 
»t
 = 
	`cİy_™ems
(
Œªs
, 
šode
, 
d¡_·th
, 
·th
, 
šs_¡¬t_¦Ù
,

5892 
šs_Ä
, 
šode_Úly
, 
logged_isize
);

5893 ià(
»t
 < 0)

5894  
»t
;

5895 
šs_Ä
 = 1;

5896 
šs_¡¬t_¦Ù
 = 
·th
->
¦Ùs
[0];

5897 
Ãxt_¦Ù
:

5898 
·th
->
¦Ùs
[0]++;

5899 ià(
·th
->
¦Ùs
[0] < 
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0])) {

5900 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], 
mš_key
,

5901 
·th
->
¦Ùs
[0]);

5902 
agaš
;

5904 ià(
šs_Ä
) {

5905 
»t
 = 
	`cİy_™ems
(
Œªs
, 
šode
, 
d¡_·th
, 
·th
,

5906 
šs_¡¬t_¦Ù
, 
šs_Ä
, 
šode_Úly
,

5907 
logged_isize
);

5908 ià(
»t
 < 0)

5909  
»t
;

5910 
šs_Ä
 = 0;

5912 
	`bŒfs_»Ëa£_·th
(
·th
);

5913 
Ãxt_key
:

5914 ià(
mš_key
->
off£t
 < (
u64
)-1) {

5915 
mš_key
->
off£t
++;

5916 } ià(
mš_key
->
ty³
 < 
max_key
->type) {

5917 
mš_key
->
ty³
++;

5918 
mš_key
->
off£t
 = 0;

5928 
	`cÚd_»sched
();

5930 ià(
šs_Ä
) {

5931 
»t
 = 
	`cİy_™ems
(
Œªs
, 
šode
, 
d¡_·th
, 
·th
, 
šs_¡¬t_¦Ù
,

5932 
šs_Ä
, 
šode_Úly
, 
logged_isize
);

5933 ià(
»t
)

5934  
»t
;

5937 ià(
šode_Úly
 =ğ
LOG_INODE_ALL
 && 
	`S_ISREG
(
šode
->
vfs_šode
.
i_mode
)) {

5942 
	`bŒfs_»Ëa£_·th
(
·th
);

5943 
»t
 = 
	`bŒfs_log_´—Îoc_ex‹Ás
(
Œªs
, 
šode
, 
d¡_·th
);

5946  
»t
;

5947 
	}
}

5949 
	$š£¹_d–ayed_™ems_b©ch
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5950 
bŒfs_roÙ
 *
log
,

5951 
bŒfs_·th
 *
·th
,

5952 cÚ¡ 
bŒfs_™em_b©ch
 *
b©ch
,

5953 cÚ¡ 
bŒfs_d–ayed_™em
 *
fœ¡_™em
)

5955 cÚ¡ 
bŒfs_d–ayed_™em
 *
cu¼
 = 
fœ¡_™em
;

5956 
»t
;

5958 
»t
 = 
	`bŒfs_š£¹_em±y_™ems
(
Œªs
, 
log
, 
·th
, 
b©ch
);

5959 ià(
»t
)

5960  
»t
;

5962 
i
 = 0; i < 
b©ch
->
Ä
; i++) {

5963 *
d©a_±r
;

5965 
d©a_±r
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0], );

5966 
	`wr™e_ex‹Á_bufãr
(
·th
->
nodes
[0], &
cu¼
->
d©a
,

5967 ()
d©a_±r
, 
cu¼
->
d©a_Ën
);

5968 
cu¼
 = 
	`li¡_Ãxt_’Œy
(cu¼, 
log_li¡
);

5969 
·th
->
¦Ùs
[0]++;

5972 
	`bŒfs_»Ëa£_·th
(
·th
);

5975 
	}
}

5977 
	$log_d–ayed_š£¹iÚ_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5978 
bŒfs_šode
 *
šode
,

5979 
bŒfs_·th
 *
·th
,

5980 cÚ¡ 
li¡_h—d
 *
d–ayed_šs_li¡
,

5981 
bŒfs_log_ùx
 *
ùx
)

5984 cÚ¡ 
max_b©ch_size
 = 195;

5985 cÚ¡ 
Ëaf_d©a_size
 = 
	`BTRFS_LEAF_DATA_SIZE
(
Œªs
->
fs_šfo
);

5986 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

5987 
bŒfs_roÙ
 *
log
 = 
šode
->
roÙ
->
log_roÙ
;

5988 
bŒfs_™em_b©ch
 
b©ch
 = {

5989 .
Ä
 = 0,

5990 .
tÙ®_d©a_size
 = 0,

5992 cÚ¡ 
bŒfs_d–ayed_™em
 *
fœ¡
 = 
NULL
;

5993 cÚ¡ 
bŒfs_d–ayed_™em
 *
cu¼
;

5994 *
šs_d©a
;

5995 
bŒfs_key
 *
šs_keys
;

5996 
u32
 *
šs_sizes
;

5997 
u64
 
cu¼_b©ch_size
 = 0;

5998 
b©ch_idx
 = 0;

5999 
»t
;

6002 
	`lockd•_as£¹_h–d
(&
šode
->
log_mu‹x
);

6012 
	`li¡_fÜ_—ch_’Œy
(
cu¼
, 
d–ayed_šs_li¡
, 
log_li¡
) {

6013 ià(
cu¼
->
šdex
 > 
šode
->
Ï¡_dœ_šdex_off£t
) {

6014 
fœ¡
 = 
cu¼
;

6020 ià(!
fœ¡
)

6023 
šs_d©a
 = 
	`km®loc
(
max_b©ch_size
 * (
u32
) +

6024 
max_b©ch_size
 * (
bŒfs_key
), 
GFP_NOFS
);

6025 ià(!
šs_d©a
)

6026  -
ENOMEM
;

6027 
šs_sizes
 = (
u32
 *)
šs_d©a
;

6028 
b©ch
.
d©a_sizes
 = 
šs_sizes
;

6029 
šs_keys
 = (
bŒfs_key
 *)(
šs_d©a
 + 
max_b©ch_size
 * (
u32
));

6030 
b©ch
.
keys
 = 
šs_keys
;

6032 
cu¼
 = 
fœ¡
;

6033 !
	`li¡_’Œy_is_h—d
(
cu¼
, 
d–ayed_šs_li¡
, 
log_li¡
)) {

6034 cÚ¡ 
u32
 
cu¼_size
 = 
cu¼
->
d©a_Ën
 + (
bŒfs_™em
);

6036 ià(
cu¼_b©ch_size
 + 
cu¼_size
 > 
Ëaf_d©a_size
 ||

6037 
b©ch
.
Ä
 =ğ
max_b©ch_size
) {

6038 
»t
 = 
	`š£¹_d–ayed_™ems_b©ch
(
Œªs
, 
log
, 
·th
,

6039 &
b©ch
, 
fœ¡
);

6040 ià(
»t
)

6041 
out
;

6042 
b©ch_idx
 = 0;

6043 
b©ch
.
Ä
 = 0;

6044 
b©ch
.
tÙ®_d©a_size
 = 0;

6045 
cu¼_b©ch_size
 = 0;

6046 
fœ¡
 = 
cu¼
;

6049 
šs_sizes
[
b©ch_idx
] = 
cu¼
->
d©a_Ën
;

6050 
šs_keys
[
b©ch_idx
].
objeùid
 = 
šo
;

6051 
šs_keys
[
b©ch_idx
].
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

6052 
šs_keys
[
b©ch_idx
].
off£t
 = 
cu¼
->
šdex
;

6053 
cu¼_b©ch_size
 +ğ
cu¼_size
;

6054 
b©ch
.
tÙ®_d©a_size
 +ğ
cu¼
->
d©a_Ën
;

6055 
b©ch
.
Ä
++;

6056 
b©ch_idx
++;

6057 
cu¼
 = 
	`li¡_Ãxt_’Œy
(cu¼, 
log_li¡
);

6060 
	`ASSERT
(
b©ch
.
Ä
 >= 1);

6061 
»t
 = 
	`š£¹_d–ayed_™ems_b©ch
(
Œªs
, 
log
, 
·th
, &
b©ch
, 
fœ¡
);

6063 
cu¼
 = 
	`li¡_Ï¡_’Œy
(
d–ayed_šs_li¡
, 
bŒfs_d–ayed_™em
,

6064 
log_li¡
);

6065 
šode
->
Ï¡_dœ_šdex_off£t
 = 
cu¼
->
šdex
;

6066 
out
:

6067 
	`kä“
(
šs_d©a
);

6069  
»t
;

6070 
	}
}

6072 
	$log_d–ayed_d–‘iÚs_fuÎ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6073 
bŒfs_šode
 *
šode
,

6074 
bŒfs_·th
 *
·th
,

6075 cÚ¡ 
li¡_h—d
 *
d–ayed_d–_li¡
,

6076 
bŒfs_log_ùx
 *
ùx
)

6078 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

6079 cÚ¡ 
bŒfs_d–ayed_™em
 *
cu¼
;

6081 
cu¼
 = 
	`li¡_fœ¡_’Œy
(
d–ayed_d–_li¡
, 
bŒfs_d–ayed_™em
,

6082 
log_li¡
);

6084 !
	`li¡_’Œy_is_h—d
(
cu¼
, 
d–ayed_d–_li¡
, 
log_li¡
)) {

6085 
u64
 
fœ¡_dœ_šdex
 = 
cu¼
->
šdex
;

6086 
u64
 
Ï¡_dœ_šdex
;

6087 cÚ¡ 
bŒfs_d–ayed_™em
 *
Ãxt
;

6088 
»t
;

6095 
Ãxt
 = 
	`li¡_Ãxt_’Œy
(
cu¼
, 
log_li¡
);

6096 !
	`li¡_’Œy_is_h—d
(
Ãxt
, 
d–ayed_d–_li¡
, 
log_li¡
)) {

6097 ià(
Ãxt
->
šdex
 !ğ
cu¼
->index + 1)

6099 
cu¼
 = 
Ãxt
;

6100 
Ãxt
 = 
	`li¡_Ãxt_’Œy
Òext, 
log_li¡
);

6103 
Ï¡_dœ_šdex
 = 
cu¼
->
šdex
;

6104 
	`ASSERT
(
Ï¡_dœ_šdex
 >ğ
fœ¡_dœ_šdex
);

6106 
»t
 = 
	`š£¹_dœ_log_key
(
Œªs
, 
šode
->
roÙ
->
log_roÙ
, 
·th
,

6107 
šo
, 
fœ¡_dœ_šdex
, 
Ï¡_dœ_šdex
);

6108 ià(
»t
)

6109  
»t
;

6110 
cu¼
 = 
	`li¡_Ãxt_’Œy
(cu¼, 
log_li¡
);

6114 
	}
}

6116 
	$b©ch_d–‘e_dœ_šdex_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6117 
bŒfs_šode
 *
šode
,

6118 
bŒfs_·th
 *
·th
,

6119 
bŒfs_log_ùx
 *
ùx
,

6120 cÚ¡ 
li¡_h—d
 *
d–ayed_d–_li¡
,

6121 cÚ¡ 
bŒfs_d–ayed_™em
 *
fœ¡
,

6122 cÚ¡ 
bŒfs_d–ayed_™em
 **
Ï¡_»t
)

6124 cÚ¡ 
bŒfs_d–ayed_™em
 *
Ãxt
;

6125 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

6126 cÚ¡ 
Ï¡_¦Ù
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
) - 1;

6127 
¦Ù
 = 
·th
->
¦Ùs
[0] + 1;

6128 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

6130 
Ãxt
 = 
	`li¡_Ãxt_’Œy
(
fœ¡
, 
log_li¡
);

6132 
¦Ù
 < 
Ï¡_¦Ù
 &&

6133 !
	`li¡_’Œy_is_h—d
(
Ãxt
, 
d–ayed_d–_li¡
, 
log_li¡
)) {

6134 
bŒfs_key
 
key
;

6136 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

6137 ià(
key
.
objeùid
 !ğ
šo
 ||

6138 
key
.
ty³
 !ğ
BTRFS_DIR_INDEX_KEY
 ||

6139 
key
.
off£t
 !ğ
Ãxt
->
šdex
)

6142 
¦Ù
++;

6143 *
Ï¡_»t
 = 
Ãxt
;

6144 
Ãxt
 = 
	`li¡_Ãxt_’Œy
Òext, 
log_li¡
);

6147  
	`bŒfs_d–_™ems
(
Œªs
, 
šode
->
roÙ
->
log_roÙ
, 
·th
,

6148 
·th
->
¦Ùs
[0], 
¦Ù
 -…ath->slots[0]);

6149 
	}
}

6151 
	$log_d–ayed_d–‘iÚs_šüem’l
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6152 
bŒfs_šode
 *
šode
,

6153 
bŒfs_·th
 *
·th
,

6154 cÚ¡ 
li¡_h—d
 *
d–ayed_d–_li¡
,

6155 
bŒfs_log_ùx
 *
ùx
)

6157 
bŒfs_roÙ
 *
log
 = 
šode
->
roÙ
->
log_roÙ
;

6158 cÚ¡ 
bŒfs_d–ayed_™em
 *
cu¼
;

6159 
u64
 
Ï¡_¿nge_¡¬t
 = 0;

6160 
u64
 
Ï¡_¿nge_’d
 = 0;

6161 
bŒfs_key
 
key
;

6163 
key
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

6164 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

6165 
cu¼
 = 
	`li¡_fœ¡_’Œy
(
d–ayed_d–_li¡
, 
bŒfs_d–ayed_™em
,

6166 
log_li¡
);

6168 !
	`li¡_’Œy_is_h—d
(
cu¼
, 
d–ayed_d–_li¡
, 
log_li¡
)) {

6169 cÚ¡ 
bŒfs_d–ayed_™em
 *
Ï¡
 = 
cu¼
;

6170 
u64
 
fœ¡_dœ_šdex
 = 
cu¼
->
šdex
;

6171 
u64
 
Ï¡_dœ_šdex
;

6172 
boŞ
 
d–‘ed_™ems
 = 
çl£
;

6173 
»t
;

6175 
key
.
off£t
 = 
cu¼
->
šdex
;

6176 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
log
, &
key
, 
·th
, -1, 1);

6177 ià(
»t
 < 0) {

6178  
»t
;

6179 } ià(
»t
 == 0) {

6180 
»t
 = 
	`b©ch_d–‘e_dœ_šdex_™ems
(
Œªs
, 
šode
, 
·th
, 
ùx
,

6181 
d–ayed_d–_li¡
, 
cu¼
,

6182 &
Ï¡
);

6183 ià(
»t
)

6184  
»t
;

6185 
d–‘ed_™ems
 = 
Œue
;

6188 
	`bŒfs_»Ëa£_·th
(
·th
);

6195 ià(
d–‘ed_™ems
)

6196 
Ãxt_b©ch
;

6198 
Ï¡_dœ_šdex
 = 
Ï¡
->
šdex
;

6199 
	`ASSERT
(
Ï¡_dœ_šdex
 >ğ
fœ¡_dœ_šdex
);

6206 ià(
Ï¡_¿nge_’d
 !ğ0 && 
fœ¡_dœ_šdex
 ==†ast_range_end + 1)

6207 
fœ¡_dœ_šdex
 = 
Ï¡_¿nge_¡¬t
;

6209 
»t
 = 
	`š£¹_dœ_log_key
(
Œªs
, 
log
, 
·th
, 
key
.
objeùid
,

6210 
fœ¡_dœ_šdex
, 
Ï¡_dœ_šdex
);

6211 ià(
»t
)

6212  
»t
;

6214 
Ï¡_¿nge_¡¬t
 = 
fœ¡_dœ_šdex
;

6215 
Ï¡_¿nge_’d
 = 
Ï¡_dœ_šdex
;

6216 
Ãxt_b©ch
:

6217 
cu¼
 = 
	`li¡_Ãxt_’Œy
(
Ï¡
, 
log_li¡
);

6221 
	}
}

6223 
	$log_d–ayed_d–‘iÚ_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6224 
bŒfs_šode
 *
šode
,

6225 
bŒfs_·th
 *
·th
,

6226 cÚ¡ 
li¡_h—d
 *
d–ayed_d–_li¡
,

6227 
bŒfs_log_ùx
 *
ùx
)

6233 
	`lockd•_as£¹_h–d
(&
šode
->
log_mu‹x
);

6235 ià(
	`li¡_em±y
(
d–ayed_d–_li¡
))

6238 ià(
ùx
->
logged_befÜe
)

6239  
	`log_d–ayed_d–‘iÚs_šüem’l
(
Œªs
, 
šode
, 
·th
,

6240 
d–ayed_d–_li¡
, 
ùx
);

6242  
	`log_d–ayed_d–‘iÚs_fuÎ
(
Œªs
, 
šode
, 
·th
, 
d–ayed_d–_li¡
,

6243 
ùx
);

6244 
	}
}

6250 
	$log_Ãw_d–ayed_d’Œ›s
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6251 
bŒfs_šode
 *
šode
,

6252 cÚ¡ 
li¡_h—d
 *
d–ayed_šs_li¡
,

6253 
bŒfs_log_ùx
 *
ùx
)

6255 cÚ¡ 
boŞ
 
Üig_log_Ãw_d’Œ›s
 = 
ùx
->
log_Ãw_d’Œ›s
;

6256 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

6257 
bŒfs_d–ayed_™em
 *
™em
;

6258 
»t
 = 0;

6265 
	`lockd•_as£¹_nÙ_h–d
(&
šode
->
log_mu‹x
);

6267 
	`ASSERT
(!
ùx
->
loggšg_Ãw_d–ayed_d’Œ›s
);

6268 
ùx
->
loggšg_Ãw_d–ayed_d’Œ›s
 = 
Œue
;

6270 
	`li¡_fÜ_—ch_’Œy
(
™em
, 
d–ayed_šs_li¡
, 
log_li¡
) {

6271 
bŒfs_dœ_™em
 *
dœ_™em
;

6272 
šode
 *
di_šode
;

6273 
bŒfs_key
 
key
;

6274 
log_mode
 = 
LOG_INODE_EXISTS
;

6276 
dœ_™em
 = (
bŒfs_dœ_™em
 *)
™em
->
d©a
;

6277 
	`bŒfs_disk_key_to_ıu
(&
key
, &
dœ_™em
->
loÿtiÚ
);

6279 ià(
key
.
ty³
 =ğ
BTRFS_ROOT_ITEM_KEY
)

6282 
di_šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
key
.
objeùid
, 
šode
->
roÙ
);

6283 ià(
	`IS_ERR
(
di_šode
)) {

6284 
»t
 = 
	`PTR_ERR
(
di_šode
);

6288 ià(!
	`Ãed_log_šode
(
Œªs
, 
	`BTRFS_I
(
di_šode
))) {

6289 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
di_šode
));

6293 ià(
	`bŒfs_¡ack_dœ_áy³
(
dœ_™em
è=ğ
BTRFS_FT_DIR
)

6294 
log_mode
 = 
LOG_INODE_ALL
;

6296 
ùx
->
log_Ãw_d’Œ›s
 = 
çl£
;

6297 
»t
 = 
	`bŒfs_log_šode
(
Œªs
, 
	`BTRFS_I
(
di_šode
), 
log_mode
, 
ùx
);

6299 ià(!
»t
 && 
ùx
->
log_Ãw_d’Œ›s
)

6300 
»t
 = 
	`log_Ãw_dœ_d’Œ›s
(
Œªs
, 
	`BTRFS_I
(
di_šode
), 
ùx
);

6302 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
di_šode
));

6304 ià(
»t
)

6308 
ùx
->
log_Ãw_d’Œ›s
 = 
Üig_log_Ãw_d’Œ›s
;

6309 
ùx
->
loggšg_Ãw_d–ayed_d’Œ›s
 = 
çl£
;

6311  
»t
;

6312 
	}
}

6328 
	$bŒfs_log_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6329 
bŒfs_šode
 *
šode
,

6330 
šode_Úly
,

6331 
bŒfs_log_ùx
 *
ùx
)

6333 
bŒfs_·th
 *
·th
;

6334 
bŒfs_·th
 *
d¡_·th
;

6335 
bŒfs_key
 
mš_key
;

6336 
bŒfs_key
 
max_key
;

6337 
bŒfs_roÙ
 *
log
 = 
šode
->
roÙ
->
log_roÙ
;

6338 
»t
;

6339 
boŞ
 
ç¡_£¬ch
 = 
çl£
;

6340 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

6341 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
šode
->
ex‹Á_Œ“
;

6342 
u64
 
logged_isize
 = 0;

6343 
boŞ
 
Ãed_log_šode_™em
 = 
Œue
;

6344 
boŞ
 
x©Œs_logged
 = 
çl£
;

6345 
boŞ
 
šode_™em_drİ³d
 = 
Œue
;

6346 
boŞ
 
fuÎ_dœ_loggšg
 = 
çl£
;

6347 
	`LIST_HEAD
(
d–ayed_šs_li¡
);

6348 
	`LIST_HEAD
(
d–ayed_d–_li¡
);

6350 
·th
 = 
	`bŒfs_®loc_·th
();

6351 ià(!
·th
)

6352  -
ENOMEM
;

6353 
d¡_·th
 = 
	`bŒfs_®loc_·th
();

6354 ià(!
d¡_·th
) {

6355 
	`bŒfs_ä“_·th
(
·th
);

6356  -
ENOMEM
;

6359 
mš_key
.
objeùid
 = 
šo
;

6360 
mš_key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

6361 
mš_key
.
off£t
 = 0;

6363 
max_key
.
objeùid
 = 
šo
;

6367 ià(
	`S_ISDIR
(
šode
->
vfs_šode
.
i_mode
) ||

6368 (!
	`‹¡_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

6369 &
šode
->
ruÁime_æags
) &&

6370 
šode_Úly
 >ğ
LOG_INODE_EXISTS
))

6371 
max_key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

6373 
max_key
.
ty³
 = (
u8
)-1;

6374 
max_key
.
off£t
 = (
u64
)-1;

6376 ià(
	`S_ISDIR
(
šode
->
vfs_šode
.
i_mode
è&& 
šode_Úly
 =ğ
LOG_INODE_ALL
)

6377 
fuÎ_dœ_loggšg
 = 
Œue
;

6409 ià(
fuÎ_dœ_loggšg
 && 
ùx
->
loggšg_Ãw_d–ayed_d’Œ›s
) {

6410 
»t
 = 
	`bŒfs_comm™_šode_d–ayed_™ems
(
Œªs
, 
šode
);

6411 ià(
»t
)

6412 
out
;

6415 
	`mu‹x_lock
(&
šode
->
log_mu‹x
);

6426 ià(
	`S_ISLNK
(
šode
->
vfs_šode
.
i_mode
))

6427 
šode_Úly
 = 
LOG_INODE_ALL
;

6434 
»t
 = 
	`šode_logged
(
Œªs
, 
šode
, 
·th
);

6435 ià(
»t
 < 0)

6436 
out_uÆock
;

6437 
ùx
->
logged_befÜe
 = (
»t
 == 1);

6438 
»t
 = 0;

6447 ià(
fuÎ_dœ_loggšg
 && 
šode
->
Ï¡_uÆšk_Œªs
 >ğ
Œªs
->
Œªsid
) {

6448 
»t
 = 
BTRFS_LOG_FORCE_COMMIT
;

6449 
out_uÆock
;

6456 ià(
	`S_ISDIR
(
šode
->
vfs_šode
.
i_mode
)) {

6457 
	`ş—r_b™
(
BTRFS_INODE_COPY_EVERYTHING
, &
šode
->
ruÁime_æags
);

6458 ià(
ùx
->
logged_befÜe
)

6459 
»t
 = 
	`drİ_šode_™ems
(
Œªs
, 
log
, 
·th
, 
šode
,

6460 
BTRFS_XATTR_ITEM_KEY
);

6462 ià(
šode_Úly
 =ğ
LOG_INODE_EXISTS
 && 
ùx
->
logged_befÜe
) {

6476 
»t
 = 
	`logged_šode_size
(
log
, 
šode
, 
·th
, &
logged_isize
);

6477 ià(
»t
)

6478 
out_uÆock
;

6480 ià(
	`‹¡_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

6481 &
šode
->
ruÁime_æags
)) {

6482 ià(
šode_Úly
 =ğ
LOG_INODE_EXISTS
) {

6483 
max_key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

6484 ià(
ùx
->
logged_befÜe
)

6485 
»t
 = 
	`drİ_šode_™ems
(
Œªs
, 
log
, 
·th
,

6486 
šode
, 
max_key
.
ty³
);

6488 
	`ş—r_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

6489 &
šode
->
ruÁime_æags
);

6490 
	`ş—r_b™
(
BTRFS_INODE_COPY_EVERYTHING
,

6491 &
šode
->
ruÁime_æags
);

6492 ià(
ùx
->
logged_befÜe
)

6493 
»t
 = 
	`Œunÿ‹_šode_™ems
(
Œªs
, 
log
,

6494 
šode
, 0, 0);

6496 } ià(
	`‹¡_ªd_ş—r_b™
(
BTRFS_INODE_COPY_EVERYTHING
,

6497 &
šode
->
ruÁime_æags
) ||

6498 
šode_Úly
 =ğ
LOG_INODE_EXISTS
) {

6499 ià(
šode_Úly
 =ğ
LOG_INODE_ALL
)

6500 
ç¡_£¬ch
 = 
Œue
;

6501 
max_key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

6502 ià(
ùx
->
logged_befÜe
)

6503 
»t
 = 
	`drİ_šode_™ems
(
Œªs
, 
log
, 
·th
, 
šode
,

6504 
max_key
.
ty³
);

6506 ià(
šode_Úly
 =ğ
LOG_INODE_ALL
)

6507 
ç¡_£¬ch
 = 
Œue
;

6508 
šode_™em_drİ³d
 = 
çl£
;

6509 
log_ex‹Ás
;

6513 ià(
»t
)

6514 
out_uÆock
;

6522 ià(
fuÎ_dœ_loggšg
 && !
ùx
->
loggšg_Ãw_d–ayed_d’Œ›s
)

6523 
	`bŒfs_log_g‘_d–ayed_™ems
(
šode
, &
d–ayed_šs_li¡
,

6524 &
d–ayed_d–_li¡
);

6526 
»t
 = 
	`cİy_šode_™ems_to_log
(
Œªs
, 
šode
, &
mš_key
, &
max_key
,

6527 
·th
, 
d¡_·th
, 
logged_isize
,

6528 
šode_Úly
, 
ùx
,

6529 &
Ãed_log_šode_™em
);

6530 ià(
»t
)

6531 
out_uÆock
;

6533 
	`bŒfs_»Ëa£_·th
(
·th
);

6534 
	`bŒfs_»Ëa£_·th
(
d¡_·th
);

6535 
»t
 = 
	`bŒfs_log_®l_x©Œs
(
Œªs
, 
šode
, 
·th
, 
d¡_·th
);

6536 ià(
»t
)

6537 
out_uÆock
;

6538 
x©Œs_logged
 = 
Œue
;

6539 ià(
max_key
.
ty³
 >ğ
BTRFS_EXTENT_DATA_KEY
 && !
ç¡_£¬ch
) {

6540 
	`bŒfs_»Ëa£_·th
(
·th
);

6541 
	`bŒfs_»Ëa£_·th
(
d¡_·th
);

6542 
»t
 = 
	`bŒfs_log_hŞes
(
Œªs
, 
šode
, 
·th
);

6543 ià(
»t
)

6544 
out_uÆock
;

6546 
log_ex‹Ás
:

6547 
	`bŒfs_»Ëa£_·th
(
·th
);

6548 
	`bŒfs_»Ëa£_·th
(
d¡_·th
);

6549 ià(
Ãed_log_šode_™em
) {

6550 
»t
 = 
	`log_šode_™em
(
Œªs
, 
log
, 
d¡_·th
, 
šode
, 
šode_™em_drİ³d
);

6551 ià(
»t
)

6552 
out_uÆock
;

6561 ià(!
x©Œs_logged
 && 
šode
->
logged_Œªs
 < 
Œªs
->
Œªsid
) {

6562 
»t
 = 
	`bŒfs_log_®l_x©Œs
(
Œªs
, 
šode
, 
·th
, 
d¡_·th
);

6563 ià(
»t
)

6564 
out_uÆock
;

6565 
	`bŒfs_»Ëa£_·th
(
·th
);

6568 ià(
ç¡_£¬ch
) {

6569 
»t
 = 
	`bŒfs_log_chªged_ex‹Ás
(
Œªs
, 
šode
, 
d¡_·th
, 
ùx
);

6570 ià(
»t
)

6571 
out_uÆock
;

6572 } ià(
šode_Úly
 =ğ
LOG_INODE_ALL
) {

6573 
ex‹Á_m­
 *
em
, *
n
;

6575 
	`wr™e_lock
(&
em_Œ“
->
lock
);

6576 
	`li¡_fÜ_—ch_’Œy_§ã
(
em
, 
n
, &
em_Œ“
->
modif›d_ex‹Ás
, 
li¡
)

6577 
	`li¡_d–_š™
(&
em
->
li¡
);

6578 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

6581 ià(
fuÎ_dœ_loggšg
) {

6582 
»t
 = 
	`log_dœeùÜy_chªges
(
Œªs
, 
šode
, 
·th
, 
d¡_·th
, 
ùx
);

6583 ià(
»t
)

6584 
out_uÆock
;

6585 
»t
 = 
	`log_d–ayed_š£¹iÚ_™ems
(
Œªs
, 
šode
, 
·th
,

6586 &
d–ayed_šs_li¡
, 
ùx
);

6587 ià(
»t
)

6588 
out_uÆock
;

6589 
»t
 = 
	`log_d–ayed_d–‘iÚ_™ems
(
Œªs
, 
šode
, 
·th
,

6590 &
d–ayed_d–_li¡
, 
ùx
);

6591 ià(
»t
)

6592 
out_uÆock
;

6595 
	`¥š_lock
(&
šode
->
lock
);

6596 
šode
->
logged_Œªs
 = 
Œªs
->
Œªsid
;

6628 ià(
šode_Úly
 !ğ
LOG_INODE_EXISTS
)

6629 
šode
->
Ï¡_log_comm™
 = inode->
Ï¡_sub_Œªs
;

6630 
	`¥š_uÆock
(&
šode
->
lock
);

6636 ià(
šode_Úly
 =ğ
LOG_INODE_ALL
)

6637 
šode
->
Ï¡_»æšk_Œªs
 = 0;

6639 
out_uÆock
:

6640 
	`mu‹x_uÆock
(&
šode
->
log_mu‹x
);

6641 
out
:

6642 
	`bŒfs_ä“_·th
(
·th
);

6643 
	`bŒfs_ä“_·th
(
d¡_·th
);

6645 ià(
»t
)

6646 
	`ä“_cÚæiùšg_šodes
(
ùx
);

6648 
»t
 = 
	`log_cÚæiùšg_šodes
(
Œªs
, 
šode
->
roÙ
, 
ùx
);

6650 ià(
fuÎ_dœ_loggšg
 && !
ùx
->
loggšg_Ãw_d–ayed_d’Œ›s
) {

6651 ià(!
»t
)

6652 
»t
 = 
	`log_Ãw_d–ayed_d’Œ›s
(
Œªs
, 
šode
,

6653 &
d–ayed_šs_li¡
, 
ùx
);

6655 
	`bŒfs_log_put_d–ayed_™ems
(
šode
, &
d–ayed_šs_li¡
,

6656 &
d–ayed_d–_li¡
);

6659  
»t
;

6660 
	}
}

6662 
	$bŒfs_log_®l_·»Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6663 
bŒfs_šode
 *
šode
,

6664 
bŒfs_log_ùx
 *
ùx
)

6666 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

6667 
»t
;

6668 
bŒfs_·th
 *
·th
;

6669 
bŒfs_key
 
key
;

6670 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

6671 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

6673 
·th
 = 
	`bŒfs_®loc_·th
();

6674 ià(!
·th
)

6675  -
ENOMEM
;

6676 
·th
->
sk_lockšg
 = 1;

6677 
·th
->
£¬ch_comm™_roÙ
 = 1;

6679 
key
.
objeùid
 = 
šo
;

6680 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

6681 
key
.
off£t
 = 0;

6682 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

6683 ià(
»t
 < 0)

6684 
out
;

6686 
Œue
) {

6687 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

6688 
¦Ù
 = 
·th
->
¦Ùs
[0];

6689 
u32
 
cur_off£t
 = 0;

6690 
u32
 
™em_size
;

6691 
±r
;

6693 ià(
¦Ù
 >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

6694 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

6695 ià(
»t
 < 0)

6696 
out
;

6697 ià(
»t
 > 0)

6702 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

6704 ià(
key
.
objeùid
 !ğ
šo
 || key.
ty³
 > 
BTRFS_INODE_EXTREF_KEY
)

6707 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

6708 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
);

6709 
cur_off£t
 < 
™em_size
) {

6710 
bŒfs_key
 
šode_key
;

6711 
šode
 *
dœ_šode
;

6713 
šode_key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

6714 
šode_key
.
off£t
 = 0;

6716 ià(
key
.
ty³
 =ğ
BTRFS_INODE_EXTREF_KEY
) {

6717 
bŒfs_šode_exŒef
 *
exŒef
;

6719 
exŒef
 = (
bŒfs_šode_exŒef
 *)

6720 (
±r
 + 
cur_off£t
);

6721 
šode_key
.
objeùid
 = 
	`bŒfs_šode_exŒef_·»Á
(

6722 
Ëaf
, 
exŒef
);

6723 
cur_off£t
 +ğ(*
exŒef
);

6724 
cur_off£t
 +ğ
	`bŒfs_šode_exŒef_Çme_Ën
(
Ëaf
,

6725 
exŒef
);

6727 
šode_key
.
objeùid
 = 
key
.
off£t
;

6728 
cur_off£t
 = 
™em_size
;

6731 
dœ_šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
šode_key
.
objeùid
,

6732 
roÙ
);

6756 ià(
	`IS_ERR
(
dœ_šode
)) {

6757 
»t
 = 
	`PTR_ERR
(
dœ_šode
);

6758 
out
;

6761 ià(!
	`Ãed_log_šode
(
Œªs
, 
	`BTRFS_I
(
dœ_šode
))) {

6762 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
dœ_šode
));

6766 
ùx
->
log_Ãw_d’Œ›s
 = 
çl£
;

6767 
»t
 = 
	`bŒfs_log_šode
(
Œªs
, 
	`BTRFS_I
(
dœ_šode
),

6768 
LOG_INODE_ALL
, 
ùx
);

6769 ià(!
»t
 && 
ùx
->
log_Ãw_d’Œ›s
)

6770 
»t
 = 
	`log_Ãw_dœ_d’Œ›s
(
Œªs
,

6771 
	`BTRFS_I
(
dœ_šode
), 
ùx
);

6772 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
dœ_šode
));

6773 ià(
»t
)

6774 
out
;

6776 
·th
->
¦Ùs
[0]++;

6778 
»t
 = 0;

6779 
out
:

6780 
	`bŒfs_ä“_·th
(
·th
);

6781  
»t
;

6782 
	}
}

6784 
	$log_Ãw_ªû¡Üs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6785 
bŒfs_roÙ
 *
roÙ
,

6786 
bŒfs_·th
 *
·th
,

6787 
bŒfs_log_ùx
 *
ùx
)

6789 
bŒfs_key
 
found_key
;

6791 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
found_key
,…©h->
¦Ùs
[0]);

6793 
Œue
) {

6794 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

6795 
ex‹Á_bufãr
 *
Ëaf
;

6796 
¦Ù
;

6797 
bŒfs_key
 
£¬ch_key
;

6798 
šode
 *inode;

6799 
u64
 
šo
;

6800 
»t
 = 0;

6802 
	`bŒfs_»Ëa£_·th
(
·th
);

6804 
šo
 = 
found_key
.
off£t
;

6806 
£¬ch_key
.
objeùid
 = 
found_key
.
off£t
;

6807 
£¬ch_key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

6808 
£¬ch_key
.
off£t
 = 0;

6809 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, 
šo
, 
roÙ
);

6810 ià(
	`IS_ERR
(
šode
))

6811  
	`PTR_ERR
(
šode
);

6813 ià(
	`BTRFS_I
(
šode
)->
g’”©iÚ
 >ğ
Œªs
->
Œªsid
 &&

6814 
	`Ãed_log_šode
(
Œªs
, 
	`BTRFS_I
(
šode
)))

6815 
»t
 = 
	`bŒfs_log_šode
(
Œªs
, 
	`BTRFS_I
(
šode
),

6816 
LOG_INODE_EXISTS
, 
ùx
);

6817 
	`bŒfs_add_d–ayed_ut
(
	`BTRFS_I
(
šode
));

6818 ià(
»t
)

6819  
»t
;

6821 ià(
£¬ch_key
.
objeùid
 =ğ
BTRFS_FIRST_FREE_OBJECTID
)

6824 
£¬ch_key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

6825 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
£¬ch_key
, 
·th
, 0, 0);

6826 ià(
»t
 < 0)

6827  
»t
;

6829 
Ëaf
 = 
·th
->
nodes
[0];

6830 
¦Ù
 = 
·th
->
¦Ùs
[0];

6831 ià(
¦Ù
 >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

6832 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

6833 ià(
»t
 < 0)

6834  
»t
;

6835 ià(
»t
 > 0)

6836  -
ENOENT
;

6837 
Ëaf
 = 
·th
->
nodes
[0];

6838 
¦Ù
 = 
·th
->
¦Ùs
[0];

6841 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
¦Ù
);

6842 ià(
found_key
.
objeùid
 !ğ
£¬ch_key
.objectid ||

6843 
found_key
.
ty³
 !ğ
BTRFS_INODE_REF_KEY
)

6844  -
ENOENT
;

6847 
	}
}

6849 
	$log_Ãw_ªû¡Üs_ç¡
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6850 
bŒfs_šode
 *
šode
,

6851 
d’Œy
 *
·»Á
,

6852 
bŒfs_log_ùx
 *
ùx
)

6854 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

6855 
d’Œy
 *
Şd_·»Á
 = 
NULL
;

6856 
su³r_block
 *
sb
 = 
šode
->
vfs_šode
.
i_sb
;

6857 
»t
 = 0;

6859 
Œue
) {

6860 ià(!
·»Á
 || 
	`d_»®ly_is_Ãg©ive
(parent) ||

6861 
sb
 !ğ
·»Á
->
d_sb
)

6864 
šode
 = 
	`BTRFS_I
(
	`d_šode
(
·»Á
));

6865 ià(
roÙ
 !ğ
šode
->root)

6868 ià(
šode
->
g’”©iÚ
 >ğ
Œªs
->
Œªsid
 &&

6869 
	`Ãed_log_šode
(
Œªs
, 
šode
)) {

6870 
»t
 = 
	`bŒfs_log_šode
(
Œªs
, 
šode
,

6871 
LOG_INODE_EXISTS
, 
ùx
);

6872 ià(
»t
)

6875 ià(
	`IS_ROOT
(
·»Á
))

6878 
·»Á
 = 
	`dg‘_·»Á
(parent);

6879 
	`dput
(
Şd_·»Á
);

6880 
Şd_·»Á
 = 
·»Á
;

6882 
	`dput
(
Şd_·»Á
);

6884  
»t
;

6885 
	}
}

6887 
	$log_®l_Ãw_ªû¡Üs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6888 
bŒfs_šode
 *
šode
,

6889 
d’Œy
 *
·»Á
,

6890 
bŒfs_log_ùx
 *
ùx
)

6892 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

6893 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

6894 
bŒfs_·th
 *
·th
;

6895 
bŒfs_key
 
£¬ch_key
;

6896 
»t
;

6902 ià(
šode
->
vfs_šode
.
i_Æšk
 < 2)

6903  
	`log_Ãw_ªû¡Üs_ç¡
(
Œªs
, 
šode
, 
·»Á
, 
ùx
);

6905 
·th
 = 
	`bŒfs_®loc_·th
();

6906 ià(!
·th
)

6907  -
ENOMEM
;

6909 
£¬ch_key
.
objeùid
 = 
šo
;

6910 
£¬ch_key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

6911 
£¬ch_key
.
off£t
 = 0;

6912 
agaš
:

6913 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
£¬ch_key
, 
·th
, 0, 0);

6914 ià(
»t
 < 0)

6915 
out
;

6916 ià(
»t
 == 0)

6917 
·th
->
¦Ùs
[0]++;

6919 
Œue
) {

6920 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

6921 
¦Ù
 = 
·th
->
¦Ùs
[0];

6922 
bŒfs_key
 
found_key
;

6924 ià(
¦Ù
 >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

6925 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

6926 ià(
»t
 < 0)

6927 
out
;

6928 ià(
»t
 > 0)

6933 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
¦Ù
);

6934 ià(
found_key
.
objeùid
 !ğ
šo
 ||

6935 
found_key
.
ty³
 > 
BTRFS_INODE_EXTREF_KEY
)

6945 ià(
found_key
.
ty³
 =ğ
BTRFS_INODE_EXTREF_KEY
) {

6946 
»t
 = -
EMLINK
;

6947 
out
;

6956 
	`memıy
(&
£¬ch_key
, &
found_key
, (search_key));

6958 
»t
 = 
	`log_Ãw_ªû¡Üs
(
Œªs
, 
roÙ
, 
·th
, 
ùx
);

6959 ià(
»t
)

6960 
out
;

6961 
	`bŒfs_»Ëa£_·th
(
·th
);

6962 
agaš
;

6964 
»t
 = 0;

6965 
out
:

6966 
	`bŒfs_ä“_·th
(
·th
);

6967  
»t
;

6968 
	}
}

6976 
	$bŒfs_log_šode_·»Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6977 
bŒfs_šode
 *
šode
,

6978 
d’Œy
 *
·»Á
,

6979 
šode_Úly
,

6980 
bŒfs_log_ùx
 *
ùx
)

6982 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

6983 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

6984 
»t
 = 0;

6985 
boŞ
 
log_d’Œ›s
 = 
çl£
;

6987 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
NOTREELOG
)) {

6988 
»t
 = 
BTRFS_LOG_FORCE_COMMIT
;

6989 
’d_no_Œªs
;

6992 ià(
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0) {

6993 
»t
 = 
BTRFS_LOG_FORCE_COMMIT
;

6994 
’d_no_Œªs
;

7002 ià((
	`bŒfs_šode_š_log
(
šode
, 
Œªs
->
Œªsid
) &&

7003 
	`li¡_em±y
(&
ùx
->
Üd”ed_ex‹Ás
)) ||

7004 
šode
->
vfs_šode
.
i_Æšk
 == 0) {

7005 
»t
 = 
BTRFS_NO_LOG_SYNC
;

7006 
’d_no_Œªs
;

7009 
»t
 = 
	`¡¬t_log_Œªs
(
Œªs
, 
roÙ
, 
ùx
);

7010 ià(
»t
)

7011 
’d_no_Œªs
;

7013 
»t
 = 
	`bŒfs_log_šode
(
Œªs
, 
šode
, 
šode_Úly
, 
ùx
);

7014 ià(
»t
)

7015 
’d_Œªs
;

7023 ià(
	`S_ISREG
(
šode
->
vfs_šode
.
i_mode
) &&

7024 
šode
->
g’”©iÚ
 < 
Œªs
->
Œªsid
 &&

7025 
šode
->
Ï¡_uÆšk_Œªs
 < 
Œªs
->
Œªsid
) {

7026 
»t
 = 0;

7027 
’d_Œªs
;

7030 ià(
	`S_ISDIR
(
šode
->
vfs_šode
.
i_mode
è&& 
ùx
->
log_Ãw_d’Œ›s
)

7031 
log_d’Œ›s
 = 
Œue
;

7074 ià(
šode
->
Ï¡_uÆšk_Œªs
 >ğ
Œªs
->
Œªsid
) {

7075 
»t
 = 
	`bŒfs_log_®l_·»Ás
(
Œªs
, 
šode
, 
ùx
);

7076 ià(
»t
)

7077 
’d_Œªs
;

7080 
»t
 = 
	`log_®l_Ãw_ªû¡Üs
(
Œªs
, 
šode
, 
·»Á
, 
ùx
);

7081 ià(
»t
)

7082 
’d_Œªs
;

7084 ià(
log_d’Œ›s
)

7085 
»t
 = 
	`log_Ãw_dœ_d’Œ›s
(
Œªs
, 
šode
, 
ùx
);

7087 
»t
 = 0;

7088 
’d_Œªs
:

7089 ià(
»t
 < 0) {

7090 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

7091 
»t
 = 
BTRFS_LOG_FORCE_COMMIT
;

7094 ià(
»t
)

7095 
	`bŒfs_»move_log_ùx
(
roÙ
, 
ùx
);

7096 
	`bŒfs_’d_log_Œªs
(
roÙ
);

7097 
’d_no_Œªs
:

7098  
»t
;

7099 
	}
}

7107 
	$bŒfs_log_d’Œy_§ã
(
bŒfs_Œªs_hªdË
 *
Œªs
,

7108 
d’Œy
 *dentry,

7109 
bŒfs_log_ùx
 *
ùx
)

7111 
d’Œy
 *
·»Á
 = 
	`dg‘_·»Á
(dentry);

7112 
»t
;

7114 
»t
 = 
	`bŒfs_log_šode_·»Á
(
Œªs
, 
	`BTRFS_I
(
	`d_šode
(
d’Œy
)), 
·»Á
,

7115 
LOG_INODE_ALL
, 
ùx
);

7116 
	`dput
(
·»Á
);

7118  
»t
;

7119 
	}
}

7125 
	$bŒfs_»cov”_log_Œ“s
(
bŒfs_roÙ
 *
log_roÙ_Œ“
)

7127 
»t
;

7128 
bŒfs_·th
 *
·th
;

7129 
bŒfs_Œªs_hªdË
 *
Œªs
;

7130 
bŒfs_key
 
key
;

7131 
bŒfs_key
 
found_key
;

7132 
bŒfs_roÙ
 *
log
;

7133 
bŒfs_fs_šfo
 *
fs_šfo
 = 
log_roÙ_Œ“
->fs_info;

7134 
w®k_cÚŒŞ
 
wc
 = {

7135 .
´oûss_func
 = 
´oûss_Úe_bufãr
,

7136 .
¡age
 = 
LOG_WALK_PIN_ONLY
,

7139 
·th
 = 
	`bŒfs_®loc_·th
();

7140 ià(!
·th
)

7141  -
ENOMEM
;

7143 
	`£t_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
);

7145 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
fs_šfo
->
Œ“_roÙ
, 0);

7146 ià(
	`IS_ERR
(
Œªs
)) {

7147 
»t
 = 
	`PTR_ERR
(
Œªs
);

7148 
”rÜ
;

7151 
wc
.
Œªs
 =rans;

7152 
wc
.
pš
 = 1;

7154 
»t
 = 
	`w®k_log_Œ“
(
Œªs
, 
log_roÙ_Œ“
, &
wc
);

7155 ià(
»t
) {

7156 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7157 
”rÜ
;

7160 
agaš
:

7161 
key
.
objeùid
 = 
BTRFS_TREE_LOG_OBJECTID
;

7162 
key
.
off£t
 = (
u64
)-1;

7163 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

7166 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
log_roÙ_Œ“
, &
key
, 
·th
, 0, 0);

7168 ià(
»t
 < 0) {

7169 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7170 
”rÜ
;

7172 ià(
»t
 > 0) {

7173 ià(
·th
->
¦Ùs
[0] == 0)

7175 
·th
->
¦Ùs
[0]--;

7177 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
found_key
,

7178 
·th
->
¦Ùs
[0]);

7179 
	`bŒfs_»Ëa£_·th
(
·th
);

7180 ià(
found_key
.
objeùid
 !ğ
BTRFS_TREE_LOG_OBJECTID
)

7183 
log
 = 
	`bŒfs_»ad_Œ“_roÙ
(
log_roÙ_Œ“
, &
found_key
);

7184 ià(
	`IS_ERR
(
log
)) {

7185 
»t
 = 
	`PTR_ERR
(
log
);

7186 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7187 
”rÜ
;

7190 
wc
.
»¶ay_de¡
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
found_key
.
off£t
,

7191 
Œue
);

7192 ià(
	`IS_ERR
(
wc
.
»¶ay_de¡
)) {

7193 
»t
 = 
	`PTR_ERR
(
wc
.
»¶ay_de¡
);

7206 ià(
»t
 =ğ-
ENOENT
)

7207 
»t
 = 
	`bŒfs_pš_ex‹Á_fÜ_log_»¶ay
(
Œªs
,

7208 
log
->
node
->
¡¬t
,

7209 
log
->
node
->
Ën
);

7210 
	`bŒfs_put_roÙ
(
log
);

7212 ià(!
»t
)

7213 
Ãxt
;

7214 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7215 
”rÜ
;

7218 
wc
.
»¶ay_de¡
->
log_roÙ
 = 
log
;

7219 
»t
 = 
	`bŒfs_»cÜd_roÙ_š_Œªs
(
Œªs
, 
wc
.
»¶ay_de¡
);

7220 ià(
»t
)

7222 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7224 
»t
 = 
	`w®k_log_Œ“
(
Œªs
, 
log
, &
wc
);

7226 ià(!
»t
 && 
wc
.
¡age
 =ğ
LOG_WALK_REPLAY_ALL
) {

7227 
»t
 = 
	`fixup_šode_lšk_couÁs
(
Œªs
, 
wc
.
»¶ay_de¡
,

7228 
·th
);

7229 ià(
»t
)

7230 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7233 ià(!
»t
 && 
wc
.
¡age
 =ğ
LOG_WALK_REPLAY_ALL
) {

7234 
bŒfs_roÙ
 *
roÙ
 = 
wc
.
»¶ay_de¡
;

7236 
	`bŒfs_»Ëa£_·th
(
·th
);

7246 
»t
 = 
	`bŒfs_š™_roÙ_ä“_objeùid
(
roÙ
);

7247 ià(
»t
)

7248 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7251 
wc
.
»¶ay_de¡
->
log_roÙ
 = 
NULL
;

7252 
	`bŒfs_put_roÙ
(
wc
.
»¶ay_de¡
);

7253 
	`bŒfs_put_roÙ
(
log
);

7255 ià(
»t
)

7256 
”rÜ
;

7257 
Ãxt
:

7258 ià(
found_key
.
off£t
 == 0)

7260 
key
.
off£t
 = 
found_key
.offset - 1;

7262 
	`bŒfs_»Ëa£_·th
(
·th
);

7265 ià(
wc
.
pš
) {

7266 
wc
.
pš
 = 0;

7267 
wc
.
´oûss_func
 = 
»¶ay_Úe_bufãr
;

7268 
wc
.
¡age
 = 
LOG_WALK_REPLAY_INODES
;

7269 
agaš
;

7272 ià(
wc
.
¡age
 < 
LOG_WALK_REPLAY_ALL
) {

7273 
wc
.
¡age
++;

7274 
agaš
;

7277 
	`bŒfs_ä“_·th
(
·th
);

7280 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

7281 ià(
»t
)

7282  
»t
;

7284 
log_roÙ_Œ“
->
log_roÙ
 = 
NULL
;

7285 
	`ş—r_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
);

7286 
	`bŒfs_put_roÙ
(
log_roÙ_Œ“
);

7289 
”rÜ
:

7290 ià(
wc
.
Œªs
)

7291 
	`bŒfs_’d_Œª§ùiÚ
(
wc
.
Œªs
);

7292 
	`ş—r_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
);

7293 
	`bŒfs_ä“_·th
(
·th
);

7294  
»t
;

7295 
	}
}

7308 
	$bŒfs_»cÜd_uÆšk_dœ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

7309 
bŒfs_šode
 *
dœ
, bŒfs_šod*
šode
,

7310 
boŞ
 
fÜ_»Çme
)

7322 
	`mu‹x_lock
(&
šode
->
log_mu‹x
);

7323 
šode
->
Ï¡_uÆšk_Œªs
 = 
Œªs
->
Œªsid
;

7324 
	`mu‹x_uÆock
(&
šode
->
log_mu‹x
);

7326 ià(!
fÜ_»Çme
)

7335 ià(
	`šode_logged
(
Œªs
, 
dœ
, 
NULL
) == 1)

7344 ià(
	`šode_logged
(
Œªs
, 
šode
, 
NULL
) == 1)

7354 
	`mu‹x_lock
(&
dœ
->
log_mu‹x
);

7355 
dœ
->
Ï¡_uÆšk_Œªs
 = 
Œªs
->
Œªsid
;

7356 
	`mu‹x_uÆock
(&
dœ
->
log_mu‹x
);

7357 
	}
}

7371 
	$bŒfs_»cÜd_¢­shÙ_de¡roy
(
bŒfs_Œªs_hªdË
 *
Œªs
,

7372 
bŒfs_šode
 *
dœ
)

7374 
	`mu‹x_lock
(&
dœ
->
log_mu‹x
);

7375 
dœ
->
Ï¡_uÆšk_Œªs
 = 
Œªs
->
Œªsid
;

7376 
	`mu‹x_uÆock
(&
dœ
->
log_mu‹x
);

7377 
	}
}

7396 
	$bŒfs_log_Ãw_Çme
(
bŒfs_Œªs_hªdË
 *
Œªs
,

7397 
d’Œy
 *
Şd_d’Œy
, 
bŒfs_šode
 *
Şd_dœ
,

7398 
u64
 
Şd_dœ_šdex
, 
d’Œy
 *
·»Á
)

7400 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
	`d_šode
(
Şd_d’Œy
));

7401 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

7402 
bŒfs_log_ùx
 
ùx
;

7403 
boŞ
 
log_pšÃd
 = 
çl£
;

7404 
»t
;

7410 ià(!
	`S_ISDIR
(
šode
->
vfs_šode
.
i_mode
))

7411 
šode
->
Ï¡_uÆšk_Œªs
 = 
Œªs
->
Œªsid
;

7417 
»t
 = 
	`šode_logged
(
Œªs
, 
šode
, 
NULL
);

7418 ià(
»t
 < 0) {

7419 
out
;

7420 } ià(
»t
 == 0) {

7421 ià(!
Şd_dœ
)

7428 
»t
 = 
	`šode_logged
(
Œªs
, 
Şd_dœ
, 
NULL
);

7429 ià(
»t
 < 0)

7430 
out
;

7431 ià(
»t
 == 0)

7434 
»t
 = 0;

7443 ià(
Şd_dœ
 && old_dœ->
logged_Œªs
 =ğ
Œªs
->
Œªsid
) {

7444 
bŒfs_roÙ
 *
log
 = 
Şd_dœ
->
roÙ
->
log_roÙ
;

7445 
bŒfs_·th
 *
·th
;

7446 
fsüy±_Çme
 
âame
;

7448 
	`ASSERT
(
Şd_dœ_šdex
 >ğ
BTRFS_DIR_START_INDEX
);

7450 
»t
 = 
	`fsüy±_£tup_f’ame
(&
Şd_dœ
->
vfs_šode
,

7451 &
Şd_d’Œy
->
d_Çme
, 0, &
âame
);

7452 ià(
»t
)

7453 
out
;

7460 
»t
 = 
	`još_ruÂšg_log_Œªs
(
roÙ
);

7466 ià(
	`WARN_ON_ONCE
(
»t
 < 0)) {

7467 
	`fsüy±_ä“_f’ame
(&
âame
);

7468 
out
;

7471 
log_pšÃd
 = 
Œue
;

7473 
·th
 = 
	`bŒfs_®loc_·th
();

7474 ià(!
·th
) {

7475 
»t
 = -
ENOMEM
;

7476 
	`fsüy±_ä“_f’ame
(&
âame
);

7477 
out
;

7490 
	`mu‹x_lock
(&
Şd_dœ
->
log_mu‹x
);

7491 
»t
 = 
	`d–_logged_d’Œy
(
Œªs
, 
log
, 
·th
, 
	`bŒfs_šo
(
Şd_dœ
),

7492 &
âame
.
disk_Çme
, 
Şd_dœ_šdex
);

7493 ià(
»t
 > 0) {

7498 
	`bŒfs_»Ëa£_·th
(
·th
);

7499 
»t
 = 
	`š£¹_dœ_log_key
(
Œªs
, 
log
, 
·th
,

7500 
	`bŒfs_šo
(
Şd_dœ
),

7501 
Şd_dœ_šdex
, old_dir_index);

7503 
	`mu‹x_uÆock
(&
Şd_dœ
->
log_mu‹x
);

7505 
	`bŒfs_ä“_·th
(
·th
);

7506 
	`fsüy±_ä“_f’ame
(&
âame
);

7507 ià(
»t
 < 0)

7508 
out
;

7511 
	`bŒfs_š™_log_ùx
(&
ùx
, &
šode
->
vfs_šode
);

7512 
ùx
.
loggšg_Ãw_Çme
 = 
Œue
;

7520 
	`bŒfs_log_šode_·»Á
(
Œªs
, 
šode
, 
·»Á
, 
LOG_INODE_EXISTS
, &
ùx
);

7521 
	`ASSERT
(
	`li¡_em±y
(&
ùx
.
cÚæiù_šodes
));

7522 
out
:

7529 ià(
»t
 < 0)

7530 
	`bŒfs_£t_log_fuÎ_comm™
(
Œªs
);

7531 ià(
log_pšÃd
)

7532 
	`bŒfs_’d_log_Œªs
(
roÙ
);

7533 
	}
}

	@tree-log.h

6 #iâdeà
BTRFS_TREE_LOG_H


7 
	#BTRFS_TREE_LOG_H


	)

9 
	~"mes§ges.h
"

10 
	~"ù»e.h
"

11 
	~"Œª§ùiÚ.h
"

14 
	#BTRFS_NO_LOG_SYNC
 256

	)

22 
	#BTRFS_LOG_FORCE_COMMIT
 (-(
MAX_ERRNO
 + 1))

	)

24 
	sbŒfs_log_ùx
 {

25 
	mlog_»t
;

26 
	mlog_Œªsid
;

27 
boŞ
 
	mlog_Ãw_d’Œ›s
;

28 
boŞ
 
	mloggšg_Ãw_Çme
;

29 
boŞ
 
	mloggšg_Ãw_d–ayed_d’Œ›s
;

31 
boŞ
 
	mlogged_befÜe
;

32 
šode
 *
	mšode
;

33 
li¡_h—d
 
	mli¡
;

35 
li¡_h—d
 
	mÜd”ed_ex‹Ás
;

36 
li¡_h—d
 
	mcÚæiù_šodes
;

37 
	mnum_cÚæiù_šodes
;

38 
boŞ
 
	mloggšg_cÚæiù_šodes
;

41 
šlše
 
	$bŒfs_š™_log_ùx
(
bŒfs_log_ùx
 *
ùx
,

42 
šode
 *inode)

44 
ùx
->
log_»t
 = 0;

45 
ùx
->
log_Œªsid
 = 0;

46 
ùx
->
log_Ãw_d’Œ›s
 = 
çl£
;

47 
ùx
->
loggšg_Ãw_Çme
 = 
çl£
;

48 
ùx
->
loggšg_Ãw_d–ayed_d’Œ›s
 = 
çl£
;

49 
ùx
->
logged_befÜe
 = 
çl£
;

50 
ùx
->
šode
 = inode;

51 
	`INIT_LIST_HEAD
(&
ùx
->
li¡
);

52 
	`INIT_LIST_HEAD
(&
ùx
->
Üd”ed_ex‹Ás
);

53 
	`INIT_LIST_HEAD
(&
ùx
->
cÚæiù_šodes
);

54 
ùx
->
num_cÚæiù_šodes
 = 0;

55 
ùx
->
loggšg_cÚæiù_šodes
 = 
çl£
;

56 
	}
}

58 
šlše
 
	$bŒfs_»Ëa£_log_ùx_ex‹Ás
(
bŒfs_log_ùx
 *
ùx
)

60 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

61 
bŒfs_Üd”ed_ex‹Á
 *
tmp
;

63 
	`ASSERT
(
	`šode_is_locked
(
ùx
->
šode
));

65 
	`li¡_fÜ_—ch_’Œy_§ã
(
Üd”ed
, 
tmp
, &
ùx
->
Üd”ed_ex‹Ás
, 
log_li¡
) {

66 
	`li¡_d–_š™
(&
Üd”ed
->
log_li¡
);

67 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

69 
	}
}

71 
šlše
 
	$bŒfs_£t_log_fuÎ_comm™
(
bŒfs_Œªs_hªdË
 *
Œªs
)

73 
	`WRITE_ONCE
(
Œªs
->
fs_šfo
->
Ï¡_Œªs_log_fuÎ_comm™
,¿ns->
Œªsid
);

74 
	}
}

76 
šlše
 
	$bŒfs_Ãed_log_fuÎ_comm™
(
bŒfs_Œªs_hªdË
 *
Œªs
)

78  
	`READ_ONCE
(
Œªs
->
fs_šfo
->
Ï¡_Œªs_log_fuÎ_comm™
) ==

79 
Œªs
->
Œªsid
;

80 
	}
}

82 
bŒfs_sync_log
(
bŒfs_Œªs_hªdË
 *
Œªs
,

83 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_log_ùx
 *
ùx
);

84 
bŒfs_ä“_log
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
);

85 
bŒfs_ä“_log_roÙ_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

86 
bŒfs_fs_šfo
 *
fs_šfo
);

87 
bŒfs_»cov”_log_Œ“s
(
bŒfs_roÙ
 *
Œ“_roÙ
);

88 
bŒfs_log_d’Œy_§ã
(
bŒfs_Œªs_hªdË
 *
Œªs
,

89 
d’Œy
 *dentry,

90 
bŒfs_log_ùx
 *
ùx
);

91 
bŒfs_d–_dœ_’Œ›s_š_log
(
bŒfs_Œªs_hªdË
 *
Œªs
,

92 
bŒfs_roÙ
 *
roÙ
,

93 cÚ¡ 
fsüy±_¡r
 *
Çme
,

94 
bŒfs_šode
 *
dœ
, 
u64
 
šdex
);

95 
bŒfs_d–_šode_»f_š_log
(
bŒfs_Œªs_hªdË
 *
Œªs
,

96 
bŒfs_roÙ
 *
roÙ
,

97 cÚ¡ 
fsüy±_¡r
 *
Çme
,

98 
bŒfs_šode
 *
šode
, 
u64
 
dœid
);

99 
bŒfs_’d_log_Œªs
(
bŒfs_roÙ
 *
roÙ
);

100 
bŒfs_pš_log_Œªs
(
bŒfs_roÙ
 *
roÙ
);

101 
bŒfs_»cÜd_uÆšk_dœ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

102 
bŒfs_šode
 *
dœ
, bŒfs_šod*
šode
,

103 
boŞ
 
fÜ_»Çme
);

104 
bŒfs_»cÜd_¢­shÙ_de¡roy
(
bŒfs_Œªs_hªdË
 *
Œªs
,

105 
bŒfs_šode
 *
dœ
);

106 
bŒfs_log_Ãw_Çme
(
bŒfs_Œªs_hªdË
 *
Œªs
,

107 
d’Œy
 *
Şd_d’Œy
, 
bŒfs_šode
 *
Şd_dœ
,

108 
u64
 
Şd_dœ_šdex
, 
d’Œy
 *
·»Á
);

	@tree-mod-log.c

3 
	~"mes§ges.h
"

4 
	~"Œ“-mod-log.h
"

5 
	~"disk-io.h
"

6 
	~"fs.h
"

7 
	~"acûssÜs.h
"

8 
	~"Œ“-check”.h
"

10 
	sŒ“_mod_roÙ
 {

11 
u64
 
	mlogiÿl
;

12 
u8
 
	mËv–
;

15 
	sŒ“_mod_–em
 {

16 
rb_node
 
	mnode
;

17 
u64
 
	mlogiÿl
;

18 
u64
 
	m£q
;

19 
bŒfs_mod_log_İ
 
	mİ
;

25 
	m¦Ù
;

28 
u64
 
	mg’”©iÚ
;

31 
bŒfs_disk_key
 
	mkey
;

32 
u64
 
	mblock±r
;

36 
	md¡_¦Ù
;

37 
	mÄ_™ems
;

38 } 
	mmove
;

41 
Œ“_mod_roÙ
 
	mŞd_roÙ
;

47 
šlše
 
u64
 
	$bŒfs_šc_Œ“_mod_£q
(
bŒfs_fs_šfo
 *
fs_šfo
)

49  
	`©omic64_šc_»tuº
(&
fs_šfo
->
Œ“_mod_£q
);

50 
	}
}

60 
u64
 
	$bŒfs_g‘_Œ“_mod_£q
(
bŒfs_fs_šfo
 *
fs_šfo
,

61 
bŒfs_£q_li¡
 *
–em
)

63 
	`wr™e_lock
(&
fs_šfo
->
Œ“_mod_log_lock
);

64 ià(!
–em
->
£q
) {

65 
–em
->
£q
 = 
	`bŒfs_šc_Œ“_mod_£q
(
fs_šfo
);

66 
	`li¡_add_
(&
–em
->
li¡
, &
fs_šfo
->
Œ“_mod_£q_li¡
);

67 
	`£t_b™
(
BTRFS_FS_TREE_MOD_LOG_USERS
, &
fs_šfo
->
æags
);

69 
	`wr™e_uÆock
(&
fs_šfo
->
Œ“_mod_log_lock
);

71  
–em
->
£q
;

72 
	}
}

74 
	$bŒfs_put_Œ“_mod_£q
(
bŒfs_fs_šfo
 *
fs_šfo
,

75 
bŒfs_£q_li¡
 *
–em
)

77 
rb_roÙ
 *
tm_roÙ
;

78 
rb_node
 *
node
;

79 
rb_node
 *
Ãxt
;

80 
Œ“_mod_–em
 *
tm
;

81 
u64
 
mš_£q
 = 
BTRFS_SEQ_LAST
;

82 
u64
 
£q_pu‰šg
 = 
–em
->
£q
;

84 ià(!
£q_pu‰šg
)

87 
	`wr™e_lock
(&
fs_šfo
->
Œ“_mod_log_lock
);

88 
	`li¡_d–
(&
–em
->
li¡
);

89 
–em
->
£q
 = 0;

91 ià(
	`li¡_em±y
(&
fs_šfo
->
Œ“_mod_£q_li¡
)) {

92 
	`ş—r_b™
(
BTRFS_FS_TREE_MOD_LOG_USERS
, &
fs_šfo
->
æags
);

94 
bŒfs_£q_li¡
 *
fœ¡
;

96 
fœ¡
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
Œ“_mod_£q_li¡
,

97 
bŒfs_£q_li¡
, 
li¡
);

98 ià(
£q_pu‰šg
 > 
fœ¡
->
£q
) {

103 
	`wr™e_uÆock
(&
fs_šfo
->
Œ“_mod_log_lock
);

106 
mš_£q
 = 
fœ¡
->
£q
;

113 
tm_roÙ
 = &
fs_šfo
->
Œ“_mod_log
;

114 
node
 = 
	`rb_fœ¡
(
tm_roÙ
);‚ode;‚odğ
Ãxt
) {

115 
Ãxt
 = 
	`rb_Ãxt
(
node
);

116 
tm
 = 
	`rb_’Œy
(
node
, 
Œ“_mod_–em
,‚ode);

117 ià(
tm
->
£q
 >ğ
mš_£q
)

119 
	`rb_”a£
(
node
, 
tm_roÙ
);

120 
	`kä“
(
tm
);

122 
	`wr™e_uÆock
(&
fs_šfo
->
Œ“_mod_log_lock
);

123 
	}
}

133 
nošlše
 
	$Œ“_mod_log_š£¹
(
bŒfs_fs_šfo
 *
fs_šfo
,

134 
Œ“_mod_–em
 *
tm
)

136 
rb_roÙ
 *
tm_roÙ
;

137 
rb_node
 **
Ãw
;

138 
rb_node
 *
·»Á
 = 
NULL
;

139 
Œ“_mod_–em
 *
cur
;

141 
	`lockd•_as£¹_h–d_wr™e
(&
fs_šfo
->
Œ“_mod_log_lock
);

143 
tm
->
£q
 = 
	`bŒfs_šc_Œ“_mod_£q
(
fs_šfo
);

145 
tm_roÙ
 = &
fs_šfo
->
Œ“_mod_log
;

146 
Ãw
 = &
tm_roÙ
->
rb_node
;

147 *
Ãw
) {

148 
cur
 = 
	`rb_’Œy
(*
Ãw
, 
Œ“_mod_–em
, 
node
);

149 
·»Á
 = *
Ãw
;

150 ià(
cur
->
logiÿl
 < 
tm
->logical)

151 
Ãw
 = &((*Ãw)->
rb_Ëá
);

152 ià(
cur
->
logiÿl
 > 
tm
->logical)

153 
Ãw
 = &((*Ãw)->
rb_right
);

154 ià(
cur
->
£q
 < 
tm
->seq)

155 
Ãw
 = &((*Ãw)->
rb_Ëá
);

156 ià(
cur
->
£q
 > 
tm
->seq)

157 
Ãw
 = &((*Ãw)->
rb_right
);

159  -
EEXIST
;

162 
	`rb_lšk_node
(&
tm
->
node
, 
·»Á
, 
Ãw
);

163 
	`rb_š£¹_cŞÜ
(&
tm
->
node
, 
tm_roÙ
);

165 
	}
}

173 
šlše
 
boŞ
 
	$Œ“_mod_dÚt_log
(
bŒfs_fs_šfo
 *
fs_šfo
,

174 
ex‹Á_bufãr
 *
eb
)

176 ià(!
	`‹¡_b™
(
BTRFS_FS_TREE_MOD_LOG_USERS
, &
fs_šfo
->
æags
))

177  
Œue
;

178 ià(
eb
 && 
	`bŒfs_h—d”_Ëv–
(eb) == 0)

179  
Œue
;

181 
	`wr™e_lock
(&
fs_šfo
->
Œ“_mod_log_lock
);

182 ià(
	`li¡_em±y
(&(
fs_šfo
)->
Œ“_mod_£q_li¡
)) {

183 
	`wr™e_uÆock
(&
fs_šfo
->
Œ“_mod_log_lock
);

184  
Œue
;

187  
çl£
;

188 
	}
}

191 
šlše
 
boŞ
 
	$Œ“_mod_Ãed_log
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

192 
ex‹Á_bufãr
 *
eb
)

194 ià(!
	`‹¡_b™
(
BTRFS_FS_TREE_MOD_LOG_USERS
, &
fs_šfo
->
æags
))

195  
çl£
;

196 ià(
eb
 && 
	`bŒfs_h—d”_Ëv–
(eb) == 0)

197  
çl£
;

199  
Œue
;

200 
	}
}

202 
Œ“_mod_–em
 *
	$®loc_Œ“_mod_–em
(
ex‹Á_bufãr
 *
eb
,

203 
¦Ù
,

204 
bŒfs_mod_log_İ
 
İ
)

206 
Œ“_mod_–em
 *
tm
;

208 
tm
 = 
	`kz®loc
((*tm), 
GFP_NOFS
);

209 ià(!
tm
)

210  
NULL
;

212 
tm
->
logiÿl
 = 
eb
->
¡¬t
;

213 ià(
İ
 !ğ
BTRFS_MOD_LOG_KEY_ADD
) {

214 
	`bŒfs_node_key
(
eb
, &
tm
->
key
, 
¦Ù
);

215 
tm
->
block±r
 = 
	`bŒfs_node_block±r
(
eb
, 
¦Ù
);

217 
tm
->
İ
 = op;

218 
tm
->
¦Ù
 = slot;

219 
tm
->
g’”©iÚ
 = 
	`bŒfs_node_±r_g’”©iÚ
(
eb
, 
¦Ù
);

220 
	`RB_CLEAR_NODE
(&
tm
->
node
);

222  
tm
;

223 
	}
}

225 
	$bŒfs_Œ“_mod_log_š£¹_key
(
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

226 
bŒfs_mod_log_İ
 
İ
)

228 
Œ“_mod_–em
 *
tm
;

229 
»t
 = 0;

231 ià(!
	`Œ“_mod_Ãed_log
(
eb
->
fs_šfo
,ƒb))

234 
tm
 = 
	`®loc_Œ“_mod_–em
(
eb
, 
¦Ù
, 
İ
);

235 ià(!
tm
)

236 
»t
 = -
ENOMEM
;

238 ià(
	`Œ“_mod_dÚt_log
(
eb
->
fs_šfo
,ƒb)) {

239 
	`kä“
(
tm
);

245 } ià(
»t
 != 0) {

250 
out_uÆock
;

253 
»t
 = 
	`Œ“_mod_log_š£¹
(
eb
->
fs_šfo
, 
tm
);

254 
out_uÆock
:

255 
	`wr™e_uÆock
(&
eb
->
fs_šfo
->
Œ“_mod_log_lock
);

256 ià(
»t
)

257 
	`kä“
(
tm
);

259  
»t
;

260 
	}
}

262 
Œ“_mod_–em
 *
	$Œ“_mod_log_®loc_move
(
ex‹Á_bufãr
 *
eb
,

263 
d¡_¦Ù
, 
¤c_¦Ù
,

264 
Ä_™ems
)

266 
Œ“_mod_–em
 *
tm
;

268 
tm
 = 
	`kz®loc
((*tm), 
GFP_NOFS
);

269 ià(!
tm
)

270  
	`ERR_PTR
(-
ENOMEM
);

272 
tm
->
logiÿl
 = 
eb
->
¡¬t
;

273 
tm
->
¦Ù
 = 
¤c_¦Ù
;

274 
tm
->
move
.
d¡_¦Ù
 = dst_slot;

275 
tm
->
move
.
Ä_™ems
 =‚r_items;

276 
tm
->
İ
 = 
BTRFS_MOD_LOG_MOVE_KEYS
;

277 
	`RB_CLEAR_NODE
(&
tm
->
node
);

279  
tm
;

280 
	}
}

282 
	$bŒfs_Œ“_mod_log_š£¹_move
(
ex‹Á_bufãr
 *
eb
,

283 
d¡_¦Ù
, 
¤c_¦Ù
,

284 
Ä_™ems
)

286 
Œ“_mod_–em
 *
tm
 = 
NULL
;

287 
Œ“_mod_–em
 **
tm_li¡
 = 
NULL
;

288 
»t
 = 0;

289 
i
;

290 
boŞ
 
locked
 = 
çl£
;

292 ià(!
	`Œ“_mod_Ãed_log
(
eb
->
fs_šfo
,ƒb))

295 
tm_li¡
 = 
	`kÿÎoc
(
Ä_™ems
, (
Œ“_mod_–em
 *), 
GFP_NOFS
);

296 ià(!
tm_li¡
) {

297 
»t
 = -
ENOMEM
;

298 
lock
;

301 
tm
 = 
	`Œ“_mod_log_®loc_move
(
eb
, 
d¡_¦Ù
, 
¤c_¦Ù
, 
Ä_™ems
);

302 ià(
	`IS_ERR
(
tm
)) {

303 
»t
 = 
	`PTR_ERR
(
tm
);

304 
tm
 = 
NULL
;

305 
lock
;

308 
i
 = 0; i + 
d¡_¦Ù
 < 
¤c_¦Ù
 && i < 
Ä_™ems
; i++) {

309 
tm_li¡
[
i
] = 
	`®loc_Œ“_mod_–em
(
eb
, i + 
d¡_¦Ù
,

310 
BTRFS_MOD_LOG_KEY_REMOVE_WHILE_MOVING
);

311 ià(!
tm_li¡
[
i
]) {

312 
»t
 = -
ENOMEM
;

313 
lock
;

317 
lock
:

318 ià(
	`Œ“_mod_dÚt_log
(
eb
->
fs_šfo
,ƒb)) {

323 
»t
 = 0;

324 
ä“_tms
;

326 
locked
 = 
Œue
;

332 ià(
»t
 != 0)

333 
ä“_tms
;

340 
i
 = 0; i + 
d¡_¦Ù
 < 
¤c_¦Ù
 && i < 
Ä_™ems
; i++) {

341 
»t
 = 
	`Œ“_mod_log_š£¹
(
eb
->
fs_šfo
, 
tm_li¡
[
i
]);

342 ià(
»t
)

343 
ä“_tms
;

346 
»t
 = 
	`Œ“_mod_log_š£¹
(
eb
->
fs_šfo
, 
tm
);

347 ià(
»t
)

348 
ä“_tms
;

349 
	`wr™e_uÆock
(&
eb
->
fs_šfo
->
Œ“_mod_log_lock
);

350 
	`kä“
(
tm_li¡
);

354 
ä“_tms
:

355 ià(
tm_li¡
) {

356 
i
 = 0; i < 
Ä_™ems
; i++) {

357 ià(
tm_li¡
[
i
] && !
	`RB_EMPTY_NODE
(&tm_li¡[i]->
node
))

358 
	`rb_”a£
(&
tm_li¡
[
i
]->
node
, &
eb
->
fs_šfo
->
Œ“_mod_log
);

359 
	`kä“
(
tm_li¡
[
i
]);

362 ià(
locked
)

363 
	`wr™e_uÆock
(&
eb
->
fs_šfo
->
Œ“_mod_log_lock
);

364 
	`kä“
(
tm_li¡
);

365 
	`kä“
(
tm
);

367  
»t
;

368 
	}
}

370 
šlše
 
	$Œ“_mod_log_ä“_eb
(
bŒfs_fs_šfo
 *
fs_šfo
,

371 
Œ“_mod_–em
 **
tm_li¡
,

372 
Ä™ems
)

374 
i
, 
j
;

375 
»t
;

377 
i
 = 
Ä™ems
 - 1; i >= 0; i--) {

378 
»t
 = 
	`Œ“_mod_log_š£¹
(
fs_šfo
, 
tm_li¡
[
i
]);

379 ià(
»t
) {

380 
j
 = 
Ä™ems
 - 1; j > 
i
; j--)

381 
	`rb_”a£
(&
tm_li¡
[
j
]->
node
,

382 &
fs_šfo
->
Œ“_mod_log
);

383  
»t
;

388 
	}
}

390 
	$bŒfs_Œ“_mod_log_š£¹_roÙ
(
ex‹Á_bufãr
 *
Şd_roÙ
,

391 
ex‹Á_bufãr
 *
Ãw_roÙ
,

392 
boŞ
 
log_»mov®
)

394 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Şd_roÙ
->fs_info;

395 
Œ“_mod_–em
 *
tm
 = 
NULL
;

396 
Œ“_mod_–em
 **
tm_li¡
 = 
NULL
;

397 
Ä™ems
 = 0;

398 
»t
 = 0;

399 
i
;

401 ià(!
	`Œ“_mod_Ãed_log
(
fs_šfo
, 
NULL
))

404 ià(
log_»mov®
 && 
	`bŒfs_h—d”_Ëv–
(
Şd_roÙ
) > 0) {

405 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Şd_roÙ
);

406 
tm_li¡
 = 
	`kÿÎoc
(
Ä™ems
, (
Œ“_mod_–em
 *),

407 
GFP_NOFS
);

408 ià(!
tm_li¡
) {

409 
»t
 = -
ENOMEM
;

410 
lock
;

412 
i
 = 0; i < 
Ä™ems
; i++) {

413 
tm_li¡
[
i
] = 
	`®loc_Œ“_mod_–em
(
Şd_roÙ
, i,

414 
BTRFS_MOD_LOG_KEY_REMOVE_WHILE_FREEING
);

415 ià(!
tm_li¡
[
i
]) {

416 
»t
 = -
ENOMEM
;

417 
lock
;

422 
tm
 = 
	`kz®loc
((*tm), 
GFP_NOFS
);

423 ià(!
tm
) {

424 
»t
 = -
ENOMEM
;

425 
lock
;

428 
tm
->
logiÿl
 = 
Ãw_roÙ
->
¡¬t
;

429 
tm
->
Şd_roÙ
.
logiÿl
 = old_roÙ->
¡¬t
;

430 
tm
->
Şd_roÙ
.
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(old_root);

431 
tm
->
g’”©iÚ
 = 
	`bŒfs_h—d”_g’”©iÚ
(
Şd_roÙ
);

432 
tm
->
İ
 = 
BTRFS_MOD_LOG_ROOT_REPLACE
;

434 
lock
:

435 ià(
	`Œ“_mod_dÚt_log
(
fs_šfo
, 
NULL
)) {

440 
»t
 = 0;

441 
ä“_tms
;

442 } ià(
»t
 != 0) {

447 
out_uÆock
;

450 ià(
tm_li¡
)

451 
»t
 = 
	`Œ“_mod_log_ä“_eb
(
fs_šfo
, 
tm_li¡
, 
Ä™ems
);

452 ià(!
»t
)

453 
»t
 = 
	`Œ“_mod_log_š£¹
(
fs_šfo
, 
tm
);

455 
out_uÆock
:

456 
	`wr™e_uÆock
(&
fs_šfo
->
Œ“_mod_log_lock
);

457 ià(
»t
)

458 
ä“_tms
;

459 
	`kä“
(
tm_li¡
);

461  
»t
;

463 
ä“_tms
:

464 ià(
tm_li¡
) {

465 
i
 = 0; i < 
Ä™ems
; i++)

466 
	`kä“
(
tm_li¡
[
i
]);

467 
	`kä“
(
tm_li¡
);

469 
	`kä“
(
tm
);

471  
»t
;

472 
	}
}

474 
Œ“_mod_–em
 *
	$__Œ“_mod_log_£¬ch
(
bŒfs_fs_šfo
 *
fs_šfo
,

475 
u64
 
¡¬t
, u64 
mš_£q
,

476 
boŞ
 
sm®Ë¡
)

478 
rb_roÙ
 *
tm_roÙ
;

479 
rb_node
 *
node
;

480 
Œ“_mod_–em
 *
cur
 = 
NULL
;

481 
Œ“_mod_–em
 *
found
 = 
NULL
;

483 
	`»ad_lock
(&
fs_šfo
->
Œ“_mod_log_lock
);

484 
tm_roÙ
 = &
fs_šfo
->
Œ“_mod_log
;

485 
node
 = 
tm_roÙ
->
rb_node
;

486 
node
) {

487 
cur
 = 
	`rb_’Œy
(
node
, 
Œ“_mod_–em
,‚ode);

488 ià(
cur
->
logiÿl
 < 
¡¬t
) {

489 
node
 =‚ode->
rb_Ëá
;

490 } ià(
cur
->
logiÿl
 > 
¡¬t
) {

491 
node
 =‚ode->
rb_right
;

492 } ià(
cur
->
£q
 < 
mš_£q
) {

493 
node
 =‚ode->
rb_Ëá
;

494 } ià(!
sm®Ë¡
) {

496 ià(
found
)

497 
	`BUG_ON
(
found
->
£q
 > 
cur
->seq);

498 
found
 = 
cur
;

499 
node
 =‚ode->
rb_Ëá
;

500 } ià(
cur
->
£q
 > 
mš_£q
) {

502 ià(
found
)

503 
	`BUG_ON
(
found
->
£q
 < 
cur
->seq);

504 
found
 = 
cur
;

505 
node
 =‚ode->
rb_right
;

507 
found
 = 
cur
;

511 
	`»ad_uÆock
(&
fs_šfo
->
Œ“_mod_log_lock
);

513  
found
;

514 
	}
}

521 
Œ“_mod_–em
 *
	$Œ“_mod_log_£¬ch_Şde¡
(
bŒfs_fs_šfo
 *
fs_šfo
,

522 
u64
 
¡¬t
, u64 
mš_£q
)

524  
	`__Œ“_mod_log_£¬ch
(
fs_šfo
, 
¡¬t
, 
mš_£q
, 
Œue
);

525 
	}
}

532 
Œ“_mod_–em
 *
	$Œ“_mod_log_£¬ch
(
bŒfs_fs_šfo
 *
fs_šfo
,

533 
u64
 
¡¬t
, u64 
mš_£q
)

535  
	`__Œ“_mod_log_£¬ch
(
fs_šfo
, 
¡¬t
, 
mš_£q
, 
çl£
);

536 
	}
}

538 
	$bŒfs_Œ“_mod_log_eb_cİy
(
ex‹Á_bufãr
 *
d¡
,

539 
ex‹Á_bufãr
 *
¤c
,

540 
d¡_off£t
,

541 
¤c_off£t
,

542 
Ä_™ems
)

544 
bŒfs_fs_šfo
 *
fs_šfo
 = 
d¡
->fs_info;

545 
»t
 = 0;

546 
Œ“_mod_–em
 **
tm_li¡
 = 
NULL
;

547 
Œ“_mod_–em
 **
tm_li¡_add
 = 
NULL
;

548 
Œ“_mod_–em
 **
tm_li¡_»m
 = 
NULL
;

549 
i
;

550 
boŞ
 
locked
 = 
çl£
;

551 
Œ“_mod_–em
 *
d¡_move_tm
 = 
NULL
;

552 
Œ“_mod_–em
 *
¤c_move_tm
 = 
NULL
;

553 
u32
 
d¡_move_Ä_™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
d¡
è- 
d¡_off£t
;

554 
u32
 
¤c_move_Ä_™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
¤c
è- (
¤c_off£t
 + 
Ä_™ems
);

556 ià(!
	`Œ“_mod_Ãed_log
(
fs_šfo
, 
NULL
))

559 ià(
	`bŒfs_h—d”_Ëv–
(
d¡
è=ğ0 && bŒfs_h—d”_Ëv–(
¤c
) == 0)

562 
tm_li¡
 = 
	`kÿÎoc
(
Ä_™ems
 * 2, (
Œ“_mod_–em
 *),

563 
GFP_NOFS
);

564 ià(!
tm_li¡
) {

565 
»t
 = -
ENOMEM
;

566 
lock
;

569 ià(
d¡_move_Ä_™ems
) {

570 
d¡_move_tm
 = 
	`Œ“_mod_log_®loc_move
(
d¡
, 
d¡_off£t
 + 
Ä_™ems
,

571 
d¡_off£t
, 
d¡_move_Ä_™ems
);

572 ià(
	`IS_ERR
(
d¡_move_tm
)) {

573 
»t
 = 
	`PTR_ERR
(
d¡_move_tm
);

574 
d¡_move_tm
 = 
NULL
;

575 
lock
;

578 ià(
¤c_move_Ä_™ems
) {

579 
¤c_move_tm
 = 
	`Œ“_mod_log_®loc_move
(
¤c
, 
¤c_off£t
,

580 
¤c_off£t
 + 
Ä_™ems
,

581 
¤c_move_Ä_™ems
);

582 ià(
	`IS_ERR
(
¤c_move_tm
)) {

583 
»t
 = 
	`PTR_ERR
(
¤c_move_tm
);

584 
¤c_move_tm
 = 
NULL
;

585 
lock
;

589 
tm_li¡_add
 = 
tm_li¡
;

590 
tm_li¡_»m
 = 
tm_li¡
 + 
Ä_™ems
;

591 
i
 = 0; i < 
Ä_™ems
; i++) {

592 
tm_li¡_»m
[
i
] = 
	`®loc_Œ“_mod_–em
(
¤c
, i + 
¤c_off£t
,

593 
BTRFS_MOD_LOG_KEY_REMOVE
);

594 ià(!
tm_li¡_»m
[
i
]) {

595 
»t
 = -
ENOMEM
;

596 
lock
;

599 
tm_li¡_add
[
i
] = 
	`®loc_Œ“_mod_–em
(
d¡
, i + 
d¡_off£t
,

600 
BTRFS_MOD_LOG_KEY_ADD
);

601 ià(!
tm_li¡_add
[
i
]) {

602 
»t
 = -
ENOMEM
;

603 
lock
;

607 
lock
:

608 ià(
	`Œ“_mod_dÚt_log
(
fs_šfo
, 
NULL
)) {

613 
»t
 = 0;

614 
ä“_tms
;

616 
locked
 = 
Œue
;

622 ià(
»t
 != 0)

623 
ä“_tms
;

625 ià(
d¡_move_tm
) {

626 
»t
 = 
	`Œ“_mod_log_š£¹
(
fs_šfo
, 
d¡_move_tm
);

627 ià(
»t
)

628 
ä“_tms
;

630 
i
 = 0; i < 
Ä_™ems
; i++) {

631 
»t
 = 
	`Œ“_mod_log_š£¹
(
fs_šfo
, 
tm_li¡_»m
[
i
]);

632 ià(
»t
)

633 
ä“_tms
;

634 
»t
 = 
	`Œ“_mod_log_š£¹
(
fs_šfo
, 
tm_li¡_add
[
i
]);

635 ià(
»t
)

636 
ä“_tms
;

638 ià(
¤c_move_tm
) {

639 
»t
 = 
	`Œ“_mod_log_š£¹
(
fs_šfo
, 
¤c_move_tm
);

640 ià(
»t
)

641 
ä“_tms
;

644 
	`wr™e_uÆock
(&
fs_šfo
->
Œ“_mod_log_lock
);

645 
	`kä“
(
tm_li¡
);

649 
ä“_tms
:

650 ià(
d¡_move_tm
 && !
	`RB_EMPTY_NODE
(&d¡_move_tm->
node
))

651 
	`rb_”a£
(&
d¡_move_tm
->
node
, &
fs_šfo
->
Œ“_mod_log
);

652 
	`kä“
(
d¡_move_tm
);

653 ià(
¤c_move_tm
 && !
	`RB_EMPTY_NODE
(&¤c_move_tm->
node
))

654 
	`rb_”a£
(&
¤c_move_tm
->
node
, &
fs_šfo
->
Œ“_mod_log
);

655 
	`kä“
(
¤c_move_tm
);

656 ià(
tm_li¡
) {

657 
i
 = 0; i < 
Ä_™ems
 * 2; i++) {

658 ià(
tm_li¡
[
i
] && !
	`RB_EMPTY_NODE
(&tm_li¡[i]->
node
))

659 
	`rb_”a£
(&
tm_li¡
[
i
]->
node
, &
fs_šfo
->
Œ“_mod_log
);

660 
	`kä“
(
tm_li¡
[
i
]);

663 ià(
locked
)

664 
	`wr™e_uÆock
(&
fs_šfo
->
Œ“_mod_log_lock
);

665 
	`kä“
(
tm_li¡
);

667  
»t
;

668 
	}
}

670 
	$bŒfs_Œ“_mod_log_ä“_eb
(
ex‹Á_bufãr
 *
eb
)

672 
Œ“_mod_–em
 **
tm_li¡
 = 
NULL
;

673 
Ä™ems
 = 0;

674 
i
;

675 
»t
 = 0;

677 ià(!
	`Œ“_mod_Ãed_log
(
eb
->
fs_šfo
,ƒb))

680 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

681 
tm_li¡
 = 
	`kÿÎoc
(
Ä™ems
, (
Œ“_mod_–em
 *), 
GFP_NOFS
);

682 ià(!
tm_li¡
) {

683 
»t
 = -
ENOMEM
;

684 
lock
;

687 
i
 = 0; i < 
Ä™ems
; i++) {

688 
tm_li¡
[
i
] = 
	`®loc_Œ“_mod_–em
(
eb
, i,

689 
BTRFS_MOD_LOG_KEY_REMOVE_WHILE_FREEING
);

690 ià(!
tm_li¡
[
i
]) {

691 
»t
 = -
ENOMEM
;

692 
lock
;

696 
lock
:

697 ià(
	`Œ“_mod_dÚt_log
(
eb
->
fs_šfo
,ƒb)) {

702 
»t
 = 0;

703 
ä“_tms
;

704 } ià(
»t
 != 0) {

709 
out_uÆock
;

712 
»t
 = 
	`Œ“_mod_log_ä“_eb
(
eb
->
fs_šfo
, 
tm_li¡
, 
Ä™ems
);

713 
out_uÆock
:

714 
	`wr™e_uÆock
(&
eb
->
fs_šfo
->
Œ“_mod_log_lock
);

715 ià(
»t
)

716 
ä“_tms
;

717 
	`kä“
(
tm_li¡
);

721 
ä“_tms
:

722 ià(
tm_li¡
) {

723 
i
 = 0; i < 
Ä™ems
; i++)

724 
	`kä“
(
tm_li¡
[
i
]);

725 
	`kä“
(
tm_li¡
);

728  
»t
;

729 
	}
}

735 
Œ“_mod_–em
 *
	$Œ“_mod_log_Şde¡_roÙ
(
ex‹Á_bufãr
 *
eb_roÙ
,

736 
u64
 
time_£q
)

738 
Œ“_mod_–em
 *
tm
;

739 
Œ“_mod_–em
 *
found
 = 
NULL
;

740 
u64
 
roÙ_logiÿl
 = 
eb_roÙ
->
¡¬t
;

741 
boŞ
 
loİed
 = 
çl£
;

743 ià(!
time_£q
)

744  
NULL
;

753 
tm
 = 
	`Œ“_mod_log_£¬ch_Şde¡
(
eb_roÙ
->
fs_šfo
, 
roÙ_logiÿl
,

754 
time_£q
);

755 ià(!
loİed
 && !
tm
)

756  
NULL
;

762 ià(!
tm
)

770 ià(
tm
->
İ
 !ğ
BTRFS_MOD_LOG_ROOT_REPLACE
)

773 
found
 = 
tm
;

774 
roÙ_logiÿl
 = 
tm
->
Şd_roÙ
.
logiÿl
;

775 
loİed
 = 
Œue
;

779 ià(!
found
)

780 
found
 = 
tm
;

782  
found
;

783 
	}
}

791 
	$Œ“_mod_log_»wšd
(
bŒfs_fs_šfo
 *
fs_šfo
,

792 
ex‹Á_bufãr
 *
eb
,

793 
u64
 
time_£q
,

794 
Œ“_mod_–em
 *
fœ¡_tm
)

796 
u32
 
n
;

797 
rb_node
 *
Ãxt
;

798 
Œ“_mod_–em
 *
tm
 = 
fœ¡_tm
;

799 
o_d¡
;

800 
o_¤c
;

801 
p_size
 = (
bŒfs_key_±r
);

814 
max_¦Ù
;

815 
move_¤c_’d_¦Ù
;

816 
move_d¡_’d_¦Ù
;

818 
n
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

819 
max_¦Ù
 = 
n
 - 1;

820 
	`»ad_lock
(&
fs_šfo
->
Œ“_mod_log_lock
);

821 
tm
 &&m->
£q
 >ğ
time_£q
) {

822 
	`ASSERT
(
max_¦Ù
 >= -1);

828 
tm
->
İ
) {

829 
BTRFS_MOD_LOG_KEY_REMOVE_WHILE_FREEING
:

830 
	`BUG_ON
(
tm
->
¦Ù
 < 
n
);

831 
çÎthrough
;

832 
BTRFS_MOD_LOG_KEY_REMOVE_WHILE_MOVING
:

833 
BTRFS_MOD_LOG_KEY_REMOVE
:

834 
	`bŒfs_£t_node_key
(
eb
, &
tm
->
key
,m->
¦Ù
);

835 
	`bŒfs_£t_node_block±r
(
eb
, 
tm
->
¦Ù
,m->
block±r
);

836 
	`bŒfs_£t_node_±r_g’”©iÚ
(
eb
, 
tm
->
¦Ù
,

837 
tm
->
g’”©iÚ
);

838 
n
++;

839 ià(
tm
->
¦Ù
 > 
max_¦Ù
)

840 
max_¦Ù
 = 
tm
->
¦Ù
;

842 
BTRFS_MOD_LOG_KEY_REPLACE
:

843 
	`BUG_ON
(
tm
->
¦Ù
 >ğ
n
);

844 
	`bŒfs_£t_node_key
(
eb
, &
tm
->
key
,m->
¦Ù
);

845 
	`bŒfs_£t_node_block±r
(
eb
, 
tm
->
¦Ù
,m->
block±r
);

846 
	`bŒfs_£t_node_±r_g’”©iÚ
(
eb
, 
tm
->
¦Ù
,

847 
tm
->
g’”©iÚ
);

849 
BTRFS_MOD_LOG_KEY_ADD
:

859 ià(
tm
->
¦Ù
 =ğ
max_¦Ù
)

860 
max_¦Ù
--;

862 
n
--;

864 
BTRFS_MOD_LOG_MOVE_KEYS
:

865 
	`ASSERT
(
tm
->
move
.
Ä_™ems
 > 0);

866 
move_¤c_’d_¦Ù
 = 
tm
->
move
.
d¡_¦Ù
 +m->move.
Ä_™ems
 - 1;

867 
move_d¡_’d_¦Ù
 = 
tm
->
¦Ù
 +m->
move
.
Ä_™ems
 - 1;

868 
o_d¡
 = 
	`bŒfs_node_key_±r_off£t
(
eb
, 
tm
->
¦Ù
);

869 
o_¤c
 = 
	`bŒfs_node_key_±r_off£t
(
eb
, 
tm
->
move
.
d¡_¦Ù
);

870 ià(
	`WARN_ON
(
move_¤c_’d_¦Ù
 > 
max_¦Ù
 ||

871 
tm
->
move
.
Ä_™ems
 <= 0)) {

872 
	`bŒfs_w¬n
(
fs_šfo
,

874 
eb
->
¡¬t
, 
tm
->
¦Ù
,

875 
tm
->
move
.
d¡_¦Ù
,m->move.
Ä_™ems
,

876 
tm
->
£q
, 
n
, 
max_¦Ù
);

878 
	`memmove_ex‹Á_bufãr
(
eb
, 
o_d¡
, 
o_¤c
,

879 
tm
->
move
.
Ä_™ems
 * 
p_size
);

880 
max_¦Ù
 = 
move_d¡_’d_¦Ù
;

882 
BTRFS_MOD_LOG_ROOT_REPLACE
:

894 
Ãxt
 = 
	`rb_Ãxt
(&
tm
->
node
);

895 ià(!
Ãxt
)

897 
tm
 = 
	`rb_’Œy
(
Ãxt
, 
Œ“_mod_–em
, 
node
);

898 ià(
tm
->
logiÿl
 !ğ
fœ¡_tm
->logical)

901 
	`»ad_uÆock
(&
fs_šfo
->
Œ“_mod_log_lock
);

902 
	`bŒfs_£t_h—d”_Ä™ems
(
eb
, 
n
);

903 
	}
}

912 
ex‹Á_bufãr
 *
	$bŒfs_Œ“_mod_log_»wšd
(
bŒfs_fs_šfo
 *
fs_šfo
,

913 
bŒfs_·th
 *
·th
,

914 
ex‹Á_bufãr
 *
eb
,

915 
u64
 
time_£q
)

917 
ex‹Á_bufãr
 *
eb_»wš
;

918 
Œ“_mod_–em
 *
tm
;

920 ià(!
time_£q
)

921  
eb
;

923 ià(
	`bŒfs_h—d”_Ëv–
(
eb
) == 0)

924  
eb
;

926 
tm
 = 
	`Œ“_mod_log_£¬ch
(
fs_šfo
, 
eb
->
¡¬t
, 
time_£q
);

927 ià(!
tm
)

928  
eb
;

930 ià(
tm
->
İ
 =ğ
BTRFS_MOD_LOG_KEY_REMOVE_WHILE_FREEING
) {

931 
	`BUG_ON
(
tm
->
¦Ù
 != 0);

932 
eb_»wš
 = 
	`®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
eb
->
¡¬t
);

933 ià(!
eb_»wš
) {

934 
	`bŒfs_Œ“_»ad_uÆock
(
eb
);

935 
	`ä“_ex‹Á_bufãr
(
eb
);

936  
NULL
;

938 
	`bŒfs_£t_h—d”_by‹Ä
(
eb_»wš
, 
eb
->
¡¬t
);

939 
	`bŒfs_£t_h—d”_back»f_»v
(
eb_»wš
,

940 
	`bŒfs_h—d”_back»f_»v
(
eb
));

941 
	`bŒfs_£t_h—d”_owÃr
(
eb_»wš
, 
	`bŒfs_h—d”_owÃr
(
eb
));

942 
	`bŒfs_£t_h—d”_Ëv–
(
eb_»wš
, 
	`bŒfs_h—d”_Ëv–
(
eb
));

944 
eb_»wš
 = 
	`bŒfs_şÚe_ex‹Á_bufãr
(
eb
);

945 ià(!
eb_»wš
) {

946 
	`bŒfs_Œ“_»ad_uÆock
(
eb
);

947 
	`ä“_ex‹Á_bufãr
(
eb
);

948  
NULL
;

952 
	`bŒfs_Œ“_»ad_uÆock
(
eb
);

953 
	`ä“_ex‹Á_bufãr
(
eb
);

955 
	`bŒfs_£t_bufãr_lockd•_şass
(
	`bŒfs_h—d”_owÃr
(
eb_»wš
),

956 
eb_»wš
, 
	`bŒfs_h—d”_Ëv–
(eb_rewin));

957 
	`bŒfs_Œ“_»ad_lock
(
eb_»wš
);

958 
	`Œ“_mod_log_»wšd
(
fs_šfo
, 
eb_»wš
, 
time_£q
, 
tm
);

959 
	`WARN_ON
(
	`bŒfs_h—d”_Ä™ems
(
eb_»wš
) >

960 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
));

962  
eb_»wš
;

963 
	}
}

972 
ex‹Á_bufãr
 *
	$bŒfs_g‘_Şd_roÙ
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
time_£q
)

974 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

975 
Œ“_mod_–em
 *
tm
;

976 
ex‹Á_bufãr
 *
eb
 = 
NULL
;

977 
ex‹Á_bufãr
 *
eb_roÙ
;

978 
u64
 
eb_roÙ_owÃr
 = 0;

979 
ex‹Á_bufãr
 *
Şd
;

980 
Œ“_mod_roÙ
 *
Şd_roÙ
 = 
NULL
;

981 
u64
 
Şd_g’”©iÚ
 = 0;

982 
u64
 
logiÿl
;

983 
Ëv–
;

985 
eb_roÙ
 = 
	`bŒfs_»ad_lock_roÙ_node
(
roÙ
);

986 
tm
 = 
	`Œ“_mod_log_Şde¡_roÙ
(
eb_roÙ
, 
time_£q
);

987 ià(!
tm
)

988  
eb_roÙ
;

990 ià(
tm
->
İ
 =ğ
BTRFS_MOD_LOG_ROOT_REPLACE
) {

991 
Şd_roÙ
 = &
tm
->old_root;

992 
Şd_g’”©iÚ
 = 
tm
->
g’”©iÚ
;

993 
logiÿl
 = 
Şd_roÙ
->logical;

994 
Ëv–
 = 
Şd_roÙ
->level;

996 
logiÿl
 = 
eb_roÙ
->
¡¬t
;

997 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
eb_roÙ
);

1000 
tm
 = 
	`Œ“_mod_log_£¬ch
(
fs_šfo
, 
logiÿl
, 
time_£q
);

1001 ià(
Şd_roÙ
 && 
tm
 &&m->
İ
 !ğ
BTRFS_MOD_LOG_KEY_REMOVE_WHILE_FREEING
) {

1002 
bŒfs_Œ“_·»Á_check
 
check
 = { 0 };

1004 
	`bŒfs_Œ“_»ad_uÆock
(
eb_roÙ
);

1005 
	`ä“_ex‹Á_bufãr
(
eb_roÙ
);

1007 
check
.
Ëv–
 =†evel;

1008 
check
.
owÃr_roÙ
 = 
roÙ
->
roÙ_key
.
objeùid
;

1010 
Şd
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
logiÿl
, &
check
);

1011 ià(
	`WARN_ON
(
	`IS_ERR
(
Şd
è|| !
	`ex‹Á_bufãr_u±od©e
(old))) {

1012 ià(!
	`IS_ERR
(
Şd
))

1013 
	`ä“_ex‹Á_bufãr
(
Şd
);

1014 
	`bŒfs_w¬n
(
fs_šfo
,

1016 
logiÿl
);

1018 
Œ“_mod_–em
 *
tm2
;

1020 
	`bŒfs_Œ“_»ad_lock
(
Şd
);

1021 
eb
 = 
	`bŒfs_şÚe_ex‹Á_bufãr
(
Şd
);

1032 
tm2
 = 
	`Œ“_mod_log_£¬ch
(
fs_šfo
, 
logiÿl
, 
time_£q
);

1033 
	`bŒfs_Œ“_»ad_uÆock
(
Şd
);

1034 
	`ä“_ex‹Á_bufãr
(
Şd
);

1035 
	`ASSERT
(
tm2
);

1036 
	`ASSERT
(
tm2
 =ğ
tm
 ||m2->
£q
 >m->seq);

1037 ià(!
tm2
 ||m2->
£q
 < 
tm
->seq) {

1038 
	`ä“_ex‹Á_bufãr
(
eb
);

1039  
NULL
;

1041 
tm
 = 
tm2
;

1043 } ià(
Şd_roÙ
) {

1044 
eb_roÙ_owÃr
 = 
	`bŒfs_h—d”_owÃr
(
eb_roÙ
);

1045 
	`bŒfs_Œ“_»ad_uÆock
(
eb_roÙ
);

1046 
	`ä“_ex‹Á_bufãr
(
eb_roÙ
);

1047 
eb
 = 
	`®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
logiÿl
);

1049 
eb
 = 
	`bŒfs_şÚe_ex‹Á_bufãr
(
eb_roÙ
);

1050 
	`bŒfs_Œ“_»ad_uÆock
(
eb_roÙ
);

1051 
	`ä“_ex‹Á_bufãr
(
eb_roÙ
);

1054 ià(!
eb
)

1055  
NULL
;

1056 ià(
Şd_roÙ
) {

1057 
	`bŒfs_£t_h—d”_by‹Ä
(
eb
,ƒb->
¡¬t
);

1058 
	`bŒfs_£t_h—d”_back»f_»v
(
eb
, 
BTRFS_MIXED_BACKREF_REV
);

1059 
	`bŒfs_£t_h—d”_owÃr
(
eb
, 
eb_roÙ_owÃr
);

1060 
	`bŒfs_£t_h—d”_Ëv–
(
eb
, 
Şd_roÙ
->
Ëv–
);

1061 
	`bŒfs_£t_h—d”_g’”©iÚ
(
eb
, 
Şd_g’”©iÚ
);

1063 
	`bŒfs_£t_bufãr_lockd•_şass
(
	`bŒfs_h—d”_owÃr
(
eb
),ƒb,

1064 
	`bŒfs_h—d”_Ëv–
(
eb
));

1065 
	`bŒfs_Œ“_»ad_lock
(
eb
);

1066 ià(
tm
)

1067 
	`Œ“_mod_log_»wšd
(
fs_šfo
, 
eb
, 
time_£q
, 
tm
);

1069 
	`WARN_ON
(
	`bŒfs_h—d”_Ëv–
(
eb
) != 0);

1070 
	`WARN_ON
(
	`bŒfs_h—d”_Ä™ems
(
eb
è> 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
));

1072  
eb
;

1073 
	}
}

1075 
	$bŒfs_Şd_roÙ_Ëv–
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
time_£q
)

1077 
Œ“_mod_–em
 *
tm
;

1078 
Ëv–
;

1079 
ex‹Á_bufãr
 *
eb_roÙ
 = 
	`bŒfs_roÙ_node
(
roÙ
);

1081 
tm
 = 
	`Œ“_mod_log_Şde¡_roÙ
(
eb_roÙ
, 
time_£q
);

1082 ià(
tm
 &&m->
İ
 =ğ
BTRFS_MOD_LOG_ROOT_REPLACE
)

1083 
Ëv–
 = 
tm
->
Şd_roÙ
.level;

1085 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
eb_roÙ
);

1087 
	`ä“_ex‹Á_bufãr
(
eb_roÙ
);

1089  
Ëv–
;

1090 
	}
}

1099 
u64
 
	$bŒfs_Œ“_mod_log_lowe¡_£q
(
bŒfs_fs_šfo
 *
fs_šfo
)

1101 
u64
 
»t
 = 0;

1103 
	`»ad_lock
(&
fs_šfo
->
Œ“_mod_log_lock
);

1104 ià(!
	`li¡_em±y
(&
fs_šfo
->
Œ“_mod_£q_li¡
)) {

1105 
bŒfs_£q_li¡
 *
–em
;

1107 
–em
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
Œ“_mod_£q_li¡
,

1108 
bŒfs_£q_li¡
, 
li¡
);

1109 
»t
 = 
–em
->
£q
;

1111 
	`»ad_uÆock
(&
fs_šfo
->
Œ“_mod_log_lock
);

1113  
»t
;

1114 
	}
}

	@tree-mod-log.h

3 #iâdeà
BTRFS_TREE_MOD_LOG_H


4 
	#BTRFS_TREE_MOD_LOG_H


	)

6 
	~"ù»e.h
"

9 
	sbŒfs_£q_li¡
 {

10 
li¡_h—d
 
	mli¡
;

11 
u64
 
	m£q
;

14 
	#BTRFS_SEQ_LIST_INIT
(
Çme
è{ .
li¡
 = 
	`LIST_HEAD_INIT
(Òame).li¡), .
£q
 = 0 }

	)

15 
	#BTRFS_SEQ_LAST
 ((
u64
)-1)

	)

17 
	ebŒfs_mod_log_İ
 {

18 
	mBTRFS_MOD_LOG_KEY_REPLACE
,

19 
	mBTRFS_MOD_LOG_KEY_ADD
,

20 
	mBTRFS_MOD_LOG_KEY_REMOVE
,

21 
	mBTRFS_MOD_LOG_KEY_REMOVE_WHILE_FREEING
,

22 
	mBTRFS_MOD_LOG_KEY_REMOVE_WHILE_MOVING
,

23 
	mBTRFS_MOD_LOG_MOVE_KEYS
,

24 
	mBTRFS_MOD_LOG_ROOT_REPLACE
,

27 
u64
 
bŒfs_g‘_Œ“_mod_£q
(
bŒfs_fs_šfo
 *
fs_šfo
,

28 
bŒfs_£q_li¡
 *
–em
);

29 
bŒfs_put_Œ“_mod_£q
(
bŒfs_fs_šfo
 *
fs_šfo
,

30 
bŒfs_£q_li¡
 *
–em
);

31 
bŒfs_Œ“_mod_log_š£¹_roÙ
(
ex‹Á_bufãr
 *
Şd_roÙ
,

32 
ex‹Á_bufãr
 *
Ãw_roÙ
,

33 
boŞ
 
log_»mov®
);

34 
bŒfs_Œ“_mod_log_š£¹_key
(
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

35 
bŒfs_mod_log_İ
 
İ
);

36 
bŒfs_Œ“_mod_log_ä“_eb
(
ex‹Á_bufãr
 *
eb
);

37 
ex‹Á_bufãr
 *
bŒfs_Œ“_mod_log_»wšd
(
bŒfs_fs_šfo
 *
fs_šfo
,

38 
bŒfs_·th
 *
·th
,

39 
ex‹Á_bufãr
 *
eb
,

40 
u64
 
time_£q
);

41 
ex‹Á_bufãr
 *
bŒfs_g‘_Şd_roÙ
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
time_£q
);

42 
bŒfs_Şd_roÙ_Ëv–
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
time_£q
);

43 
bŒfs_Œ“_mod_log_eb_cİy
(
ex‹Á_bufãr
 *
d¡
,

44 
ex‹Á_bufãr
 *
¤c
,

45 
d¡_off£t
,

46 
¤c_off£t
,

47 
Ä_™ems
);

48 
bŒfs_Œ“_mod_log_š£¹_move
(
ex‹Á_bufãr
 *
eb
,

49 
d¡_¦Ù
, 
¤c_¦Ù
,

50 
Ä_™ems
);

51 
u64
 
bŒfs_Œ“_mod_log_lowe¡_£q
(
bŒfs_fs_šfo
 *
fs_šfo
);

	@ulist.c

7 
	~<lšux/¦ab.h
>

8 
	~"mes§ges.h
"

9 
	~"uli¡.h
"

10 
	~"ù»e.h
"

49 
	$uli¡_š™
(
uli¡
 *ulist)

51 
	`INIT_LIST_HEAD
(&
uli¡
->
nodes
);

52 
uli¡
->
roÙ
 = 
RB_ROOT
;

53 
uli¡
->
Âodes
 = 0;

54 
	}
}

64 
	$uli¡_»Ëa£
(
uli¡
 *ulist)

66 
uli¡_node
 *
node
;

67 
uli¡_node
 *
Ãxt
;

69 
	`li¡_fÜ_—ch_’Œy_§ã
(
node
, 
Ãxt
, &
uli¡
->
nodes
, 
li¡
) {

70 
	`kä“
(
node
);

72 
uli¡
->
roÙ
 = 
RB_ROOT
;

73 
	`INIT_LIST_HEAD
(&
uli¡
->
nodes
);

74 
	}
}

84 
	$uli¡_»š™
(
uli¡
 *ulist)

86 
	`uli¡_»Ëa£
(
uli¡
);

87 
	`uli¡_š™
(
uli¡
);

88 
	}
}

97 
uli¡
 *
	$uli¡_®loc
(
gå_t
 
gå_mask
)

99 
uli¡
 *uli¡ = 
	`km®loc
((*uli¡), 
gå_mask
);

101 ià(!
uli¡
)

102  
NULL
;

104 
	`uli¡_š™
(
uli¡
);

106  
uli¡
;

107 
	}
}

116 
	$uli¡_ä“
(
uli¡
 *ulist)

118 ià(!
uli¡
)

120 
	`uli¡_»Ëa£
(
uli¡
);

121 
	`kä“
(
uli¡
);

122 
	}
}

124 
uli¡_node
 *
	$uli¡_rbŒ“_£¬ch
(
uli¡
 *uli¡, 
u64
 
v®
)

126 
rb_node
 *
n
 = 
uli¡
->
roÙ
.rb_node;

127 
uli¡_node
 *
u
 = 
NULL
;

129 
n
) {

130 
u
 = 
	`rb_’Œy
(
n
, 
uli¡_node
, 
rb_node
);

131 ià(
u
->
v®
 < val)

132 
n
 =‚->
rb_right
;

133 ià(
u
->
v®
 > val)

134 
n
 =‚->
rb_Ëá
;

136  
u
;

138  
NULL
;

139 
	}
}

141 
	$uli¡_rbŒ“_”a£
(
uli¡
 *uli¡, 
uli¡_node
 *
node
)

143 
	`rb_”a£
(&
node
->
rb_node
, &
uli¡
->
roÙ
);

144 
	`li¡_d–
(&
node
->
li¡
);

145 
	`kä“
(
node
);

146 
	`BUG_ON
(
uli¡
->
Âodes
 == 0);

147 
uli¡
->
Âodes
--;

148 
	}
}

150 
	$uli¡_rbŒ“_š£¹
(
uli¡
 *uli¡, 
uli¡_node
 *
šs
)

152 
rb_node
 **
p
 = &
uli¡
->
roÙ
.rb_node;

153 
rb_node
 *
·»Á
 = 
NULL
;

154 
uli¡_node
 *
cur
 = 
NULL
;

156 *
p
) {

157 
·»Á
 = *
p
;

158 
cur
 = 
	`rb_’Œy
(
·»Á
, 
uli¡_node
, 
rb_node
);

160 ià(
cur
->
v®
 < 
šs
->val)

161 
p
 = &(*p)->
rb_right
;

162 ià(
cur
->
v®
 > 
šs
->val)

163 
p
 = &(*p)->
rb_Ëá
;

165  -
EEXIST
;

167 
	`rb_lšk_node
(&
šs
->
rb_node
, 
·»Á
, 
p
);

168 
	`rb_š£¹_cŞÜ
(&
šs
->
rb_node
, &
uli¡
->
roÙ
);

170 
	}
}

193 
	$uli¡_add
(
uli¡
 *uli¡, 
u64
 
v®
, u64 
aux
, 
gå_t
 
gå_mask
)

195  
	`uli¡_add_m”ge
(
uli¡
, 
v®
, 
aux
, 
NULL
, 
gå_mask
);

196 
	}
}

198 
	$uli¡_add_m”ge
(
uli¡
 *uli¡, 
u64
 
v®
, u64 
aux
,

199 
u64
 *
Şd_aux
, 
gå_t
 
gå_mask
)

201 
»t
;

202 
uli¡_node
 *
node
;

204 
node
 = 
	`uli¡_rbŒ“_£¬ch
(
uli¡
, 
v®
);

205 ià(
node
) {

206 ià(
Şd_aux
)

207 *
Şd_aux
 = 
node
->
aux
;

210 
node
 = 
	`km®loc
((*node), 
gå_mask
);

211 ià(!
node
)

212  -
ENOMEM
;

214 
node
->
v®
 = val;

215 
node
->
aux
 =‡ux;

217 
»t
 = 
	`uli¡_rbŒ“_š£¹
(
uli¡
, 
node
);

218 
	`ASSERT
(!
»t
);

219 
	`li¡_add_
(&
node
->
li¡
, &
uli¡
->
nodes
);

220 
uli¡
->
Âodes
++;

223 
	}
}

235 
	$uli¡_d–
(
uli¡
 *uli¡, 
u64
 
v®
, u64 
aux
)

237 
uli¡_node
 *
node
;

239 
node
 = 
	`uli¡_rbŒ“_£¬ch
(
uli¡
, 
v®
);

241 ià(!
node
)

244 ià(
node
->
aux
 !=‡ux)

248 
	`uli¡_rbŒ“_”a£
(
uli¡
, 
node
);

250 
	}
}

269 
uli¡_node
 *
	$uli¡_Ãxt
(cÚ¡ 
uli¡
 *uli¡, 
uli¡_™”©Ü
 *
u™”
)

271 
uli¡_node
 *
node
;

273 ià(
	`li¡_em±y
(&
uli¡
->
nodes
))

274  
NULL
;

275 ià(
u™”
->
cur_li¡
 && u™”->cur_li¡->
Ãxt
 =ğ&
uli¡
->
nodes
)

276  
NULL
;

277 ià(
u™”
->
cur_li¡
) {

278 
u™”
->
cur_li¡
 = u™”->cur_li¡->
Ãxt
;

280 
u™”
->
cur_li¡
 = 
uli¡
->
nodes
.
Ãxt
;

282 
node
 = 
	`li¡_’Œy
(
u™”
->
cur_li¡
, 
uli¡_node
, 
li¡
);

283  
node
;

284 
	}
}

	@ulist.h

7 #iâdeà
BTRFS_ULIST_H


8 
	#BTRFS_ULIST_H


	)

10 
	~<lšux/li¡.h
>

11 
	~<lšux/rbŒ“.h
>

20 
	suli¡_™”©Ü
 {

21 
li¡_h—d
 *
	mcur_li¡
;

27 
	suli¡_node
 {

28 
u64
 
	mv®
;

29 
u64
 
	maux
;

31 
li¡_h—d
 
	mli¡
;

32 
rb_node
 
	mrb_node
;

35 
	suli¡
 {

39 
	mÂodes
;

41 
li¡_h—d
 
	mnodes
;

42 
rb_roÙ
 
	mroÙ
;

45 
uli¡_š™
(
uli¡
 *ulist);

46 
uli¡_»Ëa£
(
uli¡
 *ulist);

47 
uli¡_»š™
(
uli¡
 *ulist);

48 
uli¡
 *
uli¡_®loc
(
gå_t
 
gå_mask
);

49 
uli¡_ä“
(
uli¡
 *ulist);

50 
uli¡_add
(
uli¡
 *uli¡, 
u64
 
v®
, u64 
aux
, 
gå_t
 
gå_mask
);

51 
uli¡_add_m”ge
(
uli¡
 *uli¡, 
u64
 
v®
, u64 
aux
,

52 
u64
 *
Şd_aux
, 
gå_t
 
gå_mask
);

53 
uli¡_d–
(
uli¡
 *uli¡, 
u64
 
v®
, u64 
aux
);

56 
šlše
 
	$uli¡_add_m”ge_±r
(
uli¡
 *uli¡, 
u64
 
v®
, *
aux
,

57 **
Şd_aux
, 
gå_t
 
gå_mask
)

59 #ià
BITS_PER_LONG
 == 32

60 
u64
 
Şd64
 = (
ušŒ_t
)*
Şd_aux
;

61 
»t
 = 
	`uli¡_add_m”ge
(
uli¡
, 
v®
, (
ušŒ_t
)
aux
, &
Şd64
, 
gå_mask
);

62 *
Şd_aux
 = (*)((
ušŒ_t
)
Şd64
);

63  
»t
;

65  
	`uli¡_add_m”ge
(
uli¡
, 
v®
, (
u64
)
aux
, (u64 *)
Şd_aux
, 
gå_mask
);

67 
	}
}

69 
uli¡_node
 *
uli¡_Ãxt
(cÚ¡ 
uli¡
 *ulist,

70 
uli¡_™”©Ü
 *
u™”
);

72 
	#ULIST_ITER_INIT
(
u™”
è((u™”)->
cur_li¡
 = 
NULL
)

	)

	@uuid-tree.c

6 
	~<lšux/uuid.h
>

7 
	~<asm/uÇligÃd.h
>

8 
	~"mes§ges.h
"

9 
	~"ù»e.h
"

10 
	~"Œª§ùiÚ.h
"

11 
	~"disk-io.h
"

12 
	~"´št-Œ“.h
"

13 
	~"fs.h
"

14 
	~"acûssÜs.h
"

15 
	~"uuid-Œ“.h
"

17 
	$bŒfs_uuid_to_key
(
u8
 *
uuid
, u8 
ty³
, 
bŒfs_key
 *
key
)

19 
key
->
ty³
 =ype;

20 
key
->
objeùid
 = 
	`g‘_uÇligÃd_Ë64
(
uuid
);

21 
key
->
off£t
 = 
	`g‘_uÇligÃd_Ë64
(
uuid
 + (
u64
));

22 
	}
}

25 
	$bŒfs_uuid_Œ“_lookup
(
bŒfs_roÙ
 *
uuid_roÙ
, 
u8
 *
uuid
,

26 
u8
 
ty³
, 
u64
 
subid
)

28 
»t
;

29 
bŒfs_·th
 *
·th
 = 
NULL
;

30 
ex‹Á_bufãr
 *
eb
;

31 
¦Ù
;

32 
u32
 
™em_size
;

33 
off£t
;

34 
bŒfs_key
 
key
;

36 ià(
	`WARN_ON_ONCE
(!
uuid_roÙ
)) {

37 
»t
 = -
ENOENT
;

38 
out
;

41 
·th
 = 
	`bŒfs_®loc_·th
();

42 ià(!
·th
) {

43 
»t
 = -
ENOMEM
;

44 
out
;

47 
	`bŒfs_uuid_to_key
(
uuid
, 
ty³
, &
key
);

48 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
uuid_roÙ
, &
key
, 
·th
, 0, 0);

49 ià(
»t
 < 0) {

50 
out
;

51 } ià(
»t
 > 0) {

52 
»t
 = -
ENOENT
;

53 
out
;

56 
eb
 = 
·th
->
nodes
[0];

57 
¦Ù
 = 
·th
->
¦Ùs
[0];

58 
™em_size
 = 
	`bŒfs_™em_size
(
eb
, 
¦Ù
);

59 
off£t
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

60 
»t
 = -
ENOENT
;

62 ià(!
	`IS_ALIGNED
(
™em_size
, (
u64
))) {

63 
	`bŒfs_w¬n
(
uuid_roÙ
->
fs_šfo
,

65 ()
™em_size
);

66 
out
;

68 
™em_size
) {

69 
__Ë64
 
d©a
;

71 
	`»ad_ex‹Á_bufãr
(
eb
, &
d©a
, 
off£t
, (data));

72 ià(
	`Ë64_to_ıu
(
d©a
è=ğ
subid
) {

73 
»t
 = 0;

76 
off£t
 +ğ(
d©a
);

77 
™em_size
 -ğ(
d©a
);

80 
out
:

81 
	`bŒfs_ä“_·th
(
·th
);

82  
»t
;

83 
	}
}

85 
	$bŒfs_uuid_Œ“_add
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u8
 *
uuid
, u8 
ty³
,

86 
u64
 
subid_ıu
)

88 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

89 
bŒfs_roÙ
 *
uuid_roÙ
 = 
fs_šfo
->uuid_root;

90 
»t
;

91 
bŒfs_·th
 *
·th
 = 
NULL
;

92 
bŒfs_key
 
key
;

93 
ex‹Á_bufãr
 *
eb
;

94 
¦Ù
;

95 
off£t
;

96 
__Ë64
 
subid_Ë
;

98 
»t
 = 
	`bŒfs_uuid_Œ“_lookup
(
uuid_roÙ
, 
uuid
, 
ty³
, 
subid_ıu
);

99 ià(
»t
 !ğ-
ENOENT
)

100  
»t
;

102 ià(
	`WARN_ON_ONCE
(!
uuid_roÙ
)) {

103 
»t
 = -
EINVAL
;

104 
out
;

107 
	`bŒfs_uuid_to_key
(
uuid
, 
ty³
, &
key
);

109 
·th
 = 
	`bŒfs_®loc_·th
();

110 ià(!
·th
) {

111 
»t
 = -
ENOMEM
;

112 
out
;

115 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
uuid_roÙ
, 
·th
, &
key
,

116 (
subid_Ë
));

117 ià(
»t
 >= 0) {

119 
eb
 = 
·th
->
nodes
[0];

120 
¦Ù
 = 
·th
->
¦Ùs
[0];

121 
off£t
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

122 } ià(
»t
 =ğ-
EEXIST
) {

127 
	`bŒfs_ex‹nd_™em
(
Œªs
, 
·th
, (
subid_Ë
));

128 
eb
 = 
·th
->
nodes
[0];

129 
¦Ù
 = 
·th
->
¦Ùs
[0];

130 
off£t
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

131 
off£t
 +ğ
	`bŒfs_™em_size
(
eb
, 
¦Ù
è- (
subid_Ë
);

133 
	`bŒfs_w¬n
(
fs_šfo
,

135 
»t
, 
key
.
objeùid
, key.
off£t
, 
ty³
);

136 
out
;

139 
»t
 = 0;

140 
subid_Ë
 = 
	`ıu_to_Ë64
(
subid_ıu
);

141 
	`wr™e_ex‹Á_bufãr
(
eb
, &
subid_Ë
, 
off£t
, (subid_le));

142 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
eb
);

144 
out
:

145 
	`bŒfs_ä“_·th
(
·th
);

146  
»t
;

147 
	}
}

149 
	$bŒfs_uuid_Œ“_»move
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u8
 *
uuid
, u8 
ty³
,

150 
u64
 
subid
)

152 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

153 
bŒfs_roÙ
 *
uuid_roÙ
 = 
fs_šfo
->uuid_root;

154 
»t
;

155 
bŒfs_·th
 *
·th
 = 
NULL
;

156 
bŒfs_key
 
key
;

157 
ex‹Á_bufãr
 *
eb
;

158 
¦Ù
;

159 
off£t
;

160 
u32
 
™em_size
;

161 
move_d¡
;

162 
move_¤c
;

163 
move_Ën
;

165 ià(
	`WARN_ON_ONCE
(!
uuid_roÙ
)) {

166 
»t
 = -
EINVAL
;

167 
out
;

170 
	`bŒfs_uuid_to_key
(
uuid
, 
ty³
, &
key
);

172 
·th
 = 
	`bŒfs_®loc_·th
();

173 ià(!
·th
) {

174 
»t
 = -
ENOMEM
;

175 
out
;

178 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
uuid_roÙ
, &
key
, 
·th
, -1, 1);

179 ià(
»t
 < 0) {

180 
	`bŒfs_w¬n
(
fs_šfo
, "error %d while searching for uuid item!",

181 
»t
);

182 
out
;

184 ià(
»t
 > 0) {

185 
»t
 = -
ENOENT
;

186 
out
;

189 
eb
 = 
·th
->
nodes
[0];

190 
¦Ù
 = 
·th
->
¦Ùs
[0];

191 
off£t
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

192 
™em_size
 = 
	`bŒfs_™em_size
(
eb
, 
¦Ù
);

193 ià(!
	`IS_ALIGNED
(
™em_size
, (
u64
))) {

194 
	`bŒfs_w¬n
(
fs_šfo
, "uuid item with illegal size %lu!",

195 ()
™em_size
);

196 
»t
 = -
ENOENT
;

197 
out
;

199 
™em_size
) {

200 
__Ë64
 
»ad_subid
;

202 
	`»ad_ex‹Á_bufãr
(
eb
, &
»ad_subid
, 
off£t
, (read_subid));

203 ià(
	`Ë64_to_ıu
(
»ad_subid
è=ğ
subid
)

205 
off£t
 +ğ(
»ad_subid
);

206 
™em_size
 -ğ(
»ad_subid
);

209 ià(!
™em_size
) {

210 
»t
 = -
ENOENT
;

211 
out
;

214 
™em_size
 = 
	`bŒfs_™em_size
(
eb
, 
¦Ù
);

215 ià(
™em_size
 =ğ(
subid
)) {

216 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
uuid_roÙ
, 
·th
);

217 
out
;

220 
move_d¡
 = 
off£t
;

221 
move_¤c
 = 
off£t
 + (
subid
);

222 
move_Ën
 = 
™em_size
 - (
move_¤c
 - 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
));

223 
	`memmove_ex‹Á_bufãr
(
eb
, 
move_d¡
, 
move_¤c
, 
move_Ën
);

224 
	`bŒfs_Œunÿ‹_™em
(
Œªs
, 
·th
, 
™em_size
 - (
subid
), 1);

226 
out
:

227 
	`bŒfs_ä“_·th
(
·th
);

228  
»t
;

229 
	}
}

231 
	$bŒfs_uuid_™”_»m
(
bŒfs_roÙ
 *
uuid_roÙ
, 
u8
 *
uuid
, u8 
ty³
,

232 
u64
 
subid
)

234 
bŒfs_Œªs_hªdË
 *
Œªs
;

235 
»t
;

238 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
uuid_roÙ
, 1);

239 ià(
	`IS_ERR
(
Œªs
)) {

240 
»t
 = 
	`PTR_ERR
(
Œªs
);

241 
out
;

244 
»t
 = 
	`bŒfs_uuid_Œ“_»move
(
Œªs
, 
uuid
, 
ty³
, 
subid
);

245 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

247 
out
:

248  
»t
;

249 
	}
}

259 
	$bŒfs_check_uuid_Œ“_’Œy
(
bŒfs_fs_šfo
 *
fs_šfo
,

260 
u8
 *
uuid
, u8 
ty³
, 
u64
 
subvŞid
)

262 
»t
 = 0;

263 
bŒfs_roÙ
 *
subvŞ_roÙ
;

265 ià(
ty³
 !ğ
BTRFS_UUID_KEY_SUBVOL
 &&

266 
ty³
 !ğ
BTRFS_UUID_KEY_RECEIVED_SUBVOL
)

267 
out
;

269 
subvŞ_roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
subvŞid
, 
Œue
);

270 ià(
	`IS_ERR
(
subvŞ_roÙ
)) {

271 
»t
 = 
	`PTR_ERR
(
subvŞ_roÙ
);

272 ià(
»t
 =ğ-
ENOENT
)

273 
»t
 = 1;

274 
out
;

277 
ty³
) {

278 
BTRFS_UUID_KEY_SUBVOL
:

279 ià(
	`memcmp
(
uuid
, 
subvŞ_roÙ
->
roÙ_™em
.uuid, 
BTRFS_UUID_SIZE
))

280 
»t
 = 1;

282 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
:

283 ià(
	`memcmp
(
uuid
, 
subvŞ_roÙ
->
roÙ_™em
.
»ûived_uuid
,

284 
BTRFS_UUID_SIZE
))

285 
»t
 = 1;

288 
	`bŒfs_put_roÙ
(
subvŞ_roÙ
);

289 
out
:

290  
»t
;

291 
	}
}

293 
	$bŒfs_uuid_Œ“_™”©e
(
bŒfs_fs_šfo
 *
fs_šfo
)

295 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
uuid_roÙ
;

296 
bŒfs_key
 
key
;

297 
bŒfs_·th
 *
·th
;

298 
»t
 = 0;

299 
ex‹Á_bufãr
 *
Ëaf
;

300 
¦Ù
;

301 
u32
 
™em_size
;

302 
off£t
;

304 
·th
 = 
	`bŒfs_®loc_·th
();

305 ià(!
·th
) {

306 
»t
 = -
ENOMEM
;

307 
out
;

310 
key
.
objeùid
 = 0;

311 
key
.
ty³
 = 0;

312 
key
.
off£t
 = 0;

314 
agaš_£¬ch_¦Ù
:

315 
»t
 = 
	`bŒfs_£¬ch_fÜw¬d
(
roÙ
, &
key
, 
·th
, 
BTRFS_OLDEST_GENERATION
);

316 ià(
»t
) {

317 ià(
»t
 > 0)

318 
»t
 = 0;

319 
out
;

323 ià(
	`bŒfs_fs_şosšg
(
fs_šfo
)) {

324 
»t
 = -
EINTR
;

325 
out
;

327 
	`cÚd_»sched
();

328 
Ëaf
 = 
·th
->
nodes
[0];

329 
¦Ù
 = 
·th
->
¦Ùs
[0];

330 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

332 ià(
key
.
ty³
 !ğ
BTRFS_UUID_KEY_SUBVOL
 &&

333 
key
.
ty³
 !ğ
BTRFS_UUID_KEY_RECEIVED_SUBVOL
)

334 
sk
;

336 
off£t
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
);

337 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

338 ià(!
	`IS_ALIGNED
(
™em_size
, (
u64
))) {

339 
	`bŒfs_w¬n
(
fs_šfo
,

341 ()
™em_size
);

342 
sk
;

344 
™em_size
) {

345 
u8
 
uuid
[
BTRFS_UUID_SIZE
];

346 
__Ë64
 
subid_Ë
;

347 
u64
 
subid_ıu
;

349 
	`put_uÇligÃd_Ë64
(
key
.
objeùid
, 
uuid
);

350 
	`put_uÇligÃd_Ë64
(
key
.
off£t
, 
uuid
 + (
u64
));

351 
	`»ad_ex‹Á_bufãr
(
Ëaf
, &
subid_Ë
, 
off£t
,

352 (
subid_Ë
));

353 
subid_ıu
 = 
	`Ë64_to_ıu
(
subid_Ë
);

354 
»t
 = 
	`bŒfs_check_uuid_Œ“_’Œy
(
fs_šfo
, 
uuid
,

355 
key
.
ty³
, 
subid_ıu
);

356 ià(
»t
 < 0)

357 
out
;

358 ià(
»t
 > 0) {

359 
	`bŒfs_»Ëa£_·th
(
·th
);

360 
»t
 = 
	`bŒfs_uuid_™”_»m
(
roÙ
, 
uuid
, 
key
.
ty³
,

361 
subid_ıu
);

362 ià(
»t
 == 0) {

370 
agaš_£¬ch_¦Ù
;

372 ià(
»t
 < 0 &&„‘ !ğ-
ENOENT
)

373 
out
;

374 
key
.
off£t
++;

375 
agaš_£¬ch_¦Ù
;

377 
™em_size
 -ğ(
subid_Ë
);

378 
off£t
 +ğ(
subid_Ë
);

381 
sk
:

382 
»t
 = 
	`bŒfs_Ãxt_™em
(
roÙ
, 
·th
);

383 ià(
»t
 == 0)

385 ià(
»t
 > 0)

386 
»t
 = 0;

390 
out
:

391 
	`bŒfs_ä“_·th
(
·th
);

392  
»t
;

393 
	}
}

	@uuid-tree.h

3 #iâdeà
BTRFS_UUID_TREE_H


4 
	#BTRFS_UUID_TREE_H


	)

6 
bŒfs_uuid_Œ“_add
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u8
 *
uuid
, u8 
ty³
,

7 
u64
 
subid
);

8 
bŒfs_uuid_Œ“_»move
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u8
 *
uuid
, u8 
ty³
,

9 
u64
 
subid
);

10 
bŒfs_uuid_Œ“_™”©e
(
bŒfs_fs_šfo
 *
fs_šfo
);

	@verity.c

3 
	~<lšux/š™.h
>

4 
	~<lšux/fs.h
>

5 
	~<lšux/¦ab.h
>

6 
	~<lšux/rw£m.h
>

7 
	~<lšux/x©Œ.h
>

8 
	~<lšux/£cur™y.h
>

9 
	~<lšux/posix_aş_x©Œ.h
>

10 
	~<lšux/iv”siÚ.h
>

11 
	~<lšux/fsv”™y.h
>

12 
	~<lšux/sched/mm.h
>

13 
	~"mes§ges.h
"

14 
	~"ù»e.h
"

15 
	~"bŒfs_šode.h
"

16 
	~"Œª§ùiÚ.h
"

17 
	~"disk-io.h
"

18 
	~"lockšg.h
"

19 
	~"fs.h
"

20 
	~"acûssÜs.h
"

21 
	~"ioùl.h
"

22 
	~"v”™y.h
"

23 
	~"Üphª.h
"

69 
	#MERKLE_START_ALIGN
 65536

	)

86 
loff_t
 
	$m”kË_fe_pos
(cÚ¡ 
šode
 *inode)

88 
u64
 
sz
 = 
šode
->
i_size
;

89 
u64
 
rounded
 = 
	`round_up
(
sz
, 
MERKLE_START_ALIGN
);

91 ià(
rounded
 > 
šode
->
i_sb
->
s_maxby‹s
)

92  -
EFBIG
;

94  
rounded
;

95 
	}
}

109 
	$drİ_v”™y_™ems
(
bŒfs_šode
 *
šode
, 
u8
 
key_ty³
)

111 
bŒfs_Œªs_hªdË
 *
Œªs
;

112 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

113 
bŒfs_·th
 *
·th
;

114 
bŒfs_key
 
key
;

115 
couÁ
 = 0;

116 
»t
;

118 
·th
 = 
	`bŒfs_®loc_·th
();

119 ià(!
·th
)

120  -
ENOMEM
;

124 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

125 ià(
	`IS_ERR
(
Œªs
)) {

126 
»t
 = 
	`PTR_ERR
(
Œªs
);

127 
out
;

134 
key
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

135 
key
.
ty³
 = 
key_ty³
;

136 
key
.
off£t
 = (
u64
)-1;

138 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

139 ià(
»t
 > 0) {

140 
»t
 = 0;

142 ià(
·th
->
¦Ùs
[0] == 0)

144 
·th
->
¦Ùs
[0]--;

145 } ià(
»t
 < 0) {

146 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

147 
out
;

150 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

153 ià(
key
.
objeùid
 !ğ
	`bŒfs_šo
(
šode
è|| key.
ty³
 !ğ
key_ty³
)

162 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
,…©h->
¦Ùs
[0], 1);

163 ià(
»t
) {

164 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

165 
out
;

167 
couÁ
++;

168 
	`bŒfs_»Ëa£_·th
(
·th
);

169 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

171 
»t
 = 
couÁ
;

172 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

173 
out
:

174 
	`bŒfs_ä“_·th
(
·th
);

175  
»t
;

176 
	}
}

188 
	$bŒfs_drİ_v”™y_™ems
(
bŒfs_šode
 *
šode
)

190 
»t
;

192 
»t
 = 
	`drİ_v”™y_™ems
(
šode
, 
BTRFS_VERITY_DESC_ITEM_KEY
);

193 ià(
»t
 < 0)

194  
»t
;

195 
»t
 = 
	`drİ_v”™y_™ems
(
šode
, 
BTRFS_VERITY_MERKLE_ITEM_KEY
);

196 ià(
»t
 < 0)

197  
»t
;

200 
	}
}

217 
	$wr™e_key_by‹s
(
bŒfs_šode
 *
šode
, 
u8
 
key_ty³
, 
u64
 
off£t
,

218 cÚ¡ *
¤c
, 
u64
 
Ën
)

220 
bŒfs_Œªs_hªdË
 *
Œªs
;

221 
bŒfs_·th
 *
·th
;

222 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

223 
ex‹Á_bufãr
 *
Ëaf
;

224 
bŒfs_key
 
key
;

225 
cİy_by‹s
;

226 
¤c_off£t
 = 0;

227 *
d©a
;

228 
»t
 = 0;

230 
·th
 = 
	`bŒfs_®loc_·th
();

231 ià(!
·th
)

232  -
ENOMEM
;

234 
Ën
 > 0) {

236 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

237 ià(
	`IS_ERR
(
Œªs
)) {

238 
»t
 = 
	`PTR_ERR
(
Œªs
);

242 
key
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

243 
key
.
ty³
 = 
key_ty³
;

244 
key
.
off£t
 = offset;

250 
cİy_by‹s
 = 
	`mš_t
(
u64
, 
Ën
, 2048);

252 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 
cİy_by‹s
);

253 ià(
»t
) {

254 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

258 
Ëaf
 = 
·th
->
nodes
[0];

260 
d©a
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], );

261 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
¤c
 + 
¤c_off£t
,

262 ()
d©a
, 
cİy_by‹s
);

263 
off£t
 +ğ
cİy_by‹s
;

264 
¤c_off£t
 +ğ
cİy_by‹s
;

265 
Ën
 -ğ
cİy_by‹s
;

267 
	`bŒfs_»Ëa£_·th
(
·th
);

268 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

271 
	`bŒfs_ä“_·th
(
·th
);

272  
»t
;

273 
	}
}

297 
	$»ad_key_by‹s
(
bŒfs_šode
 *
šode
, 
u8
 
key_ty³
, 
u64
 
off£t
,

298 *
de¡
, 
u64
 
Ën
, 
·ge
 *
de¡_·ge
)

300 
bŒfs_·th
 *
·th
;

301 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

302 
ex‹Á_bufãr
 *
Ëaf
;

303 
bŒfs_key
 
key
;

304 
u64
 
™em_’d
;

305 
u64
 
cİy_’d
;

306 
cİ›d
 = 0;

307 
u32
 
cİy_off£t
;

308 
cİy_by‹s
;

309 
de¡_off£t
 = 0;

310 *
d©a
;

311 *
kaddr
 = 
de¡
;

312 
»t
;

314 
·th
 = 
	`bŒfs_®loc_·th
();

315 ià(!
·th
)

316  -
ENOMEM
;

318 ià(
de¡_·ge
)

319 
·th
->
»ada
 = 
READA_FORWARD
;

321 
key
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

322 
key
.
ty³
 = 
key_ty³
;

323 
key
.
off£t
 = offset;

325 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

326 ià(
»t
 < 0) {

327 
out
;

328 } ià(
»t
 > 0) {

329 
»t
 = 0;

330 ià(
·th
->
¦Ùs
[0] == 0)

331 
out
;

332 
·th
->
¦Ùs
[0]--;

335 
Ën
 > 0) {

336 
Ëaf
 = 
·th
->
nodes
[0];

337 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

339 ià(
key
.
objeùid
 !ğ
	`bŒfs_šo
(
šode
è|| key.
ty³
 !ğ
key_ty³
)

342 
™em_’d
 = 
	`bŒfs_™em_size
(
Ëaf
, 
·th
->
¦Ùs
[0]è+ 
key
.
off£t
;

344 ià(
cİ›d
 > 0) {

349 ià(
key
.
off£t
 != offset)

356 ià(
key
.
off£t
 > offset)

358 ià(
™em_’d
 <ğ
off£t
)

363 ià(!
de¡
)

364 
cİy_’d
 = 
™em_’d
;

366 
cİy_’d
 = 
	`mš
(
off£t
 + 
Ën
, 
™em_’d
);

369 
cİy_by‹s
 = 
cİy_’d
 - 
off£t
;

372 
cİy_off£t
 = 
off£t
 - 
key
.offset;

374 ià(
de¡
) {

375 ià(
de¡_·ge
)

376 
kaddr
 = 
	`km­_loÿl_·ge
(
de¡_·ge
);

378 
d©a
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], );

379 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
kaddr
 + 
de¡_off£t
,

380 ()
d©a
 + 
cİy_off£t
,

381 
cİy_by‹s
);

383 ià(
de¡_·ge
)

384 
	`kunm­_loÿl
(
kaddr
);

387 
off£t
 +ğ
cİy_by‹s
;

388 
de¡_off£t
 +ğ
cİy_by‹s
;

389 
Ën
 -ğ
cİy_by‹s
;

390 
cİ›d
 +ğ
cİy_by‹s
;

392 
·th
->
¦Ùs
[0]++;

393 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0])) {

398 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

399 ià(
»t
 < 0) {

401 } ià(
»t
 > 0) {

402 
»t
 = 0;

407 
out
:

408 
	`bŒfs_ä“_·th
(
·th
);

409 ià(!
»t
)

410 
»t
 = 
cİ›d
;

411  
»t
;

412 
	}
}

426 
	$d–_Üphª
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_šode
 *
šode
)

428 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

429 
»t
;

438 ià(!
šode
->
vfs_šode
.
i_Æšk
)

441 
»t
 = 
	`bŒfs_d–_Üphª_™em
(
Œªs
, 
roÙ
, 
	`bŒfs_šo
(
šode
));

442 ià(
»t
 =ğ-
ENOENT
)

443 
»t
 = 0;

444  
»t
;

445 
	}
}

458 
	$rŞlback_v”™y
(
bŒfs_šode
 *
šode
)

460 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

461 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

462 
»t
;

464 
	`ASSERT
(
	`šode_is_locked
(&
šode
->
vfs_šode
));

465 
	`Œunÿ‹_šode_·ges
(
šode
->
vfs_šode
.
i_m­pšg
, inode->vfs_šode.
i_size
);

466 
	`ş—r_b™
(
BTRFS_INODE_VERITY_IN_PROGRESS
, &
šode
->
ruÁime_æags
);

467 
»t
 = 
	`bŒfs_drİ_v”™y_™ems
(
šode
);

468 ià(
»t
) {

469 
	`bŒfs_hªdË_fs_”rÜ
(
roÙ
->
fs_šfo
, 
»t
,

471 (
u64
)
šode
->
vfs_šode
.
i_šo
);

472 
out
;

479 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 2);

480 ià(
	`IS_ERR
(
Œªs
)) {

481 
»t
 = 
	`PTR_ERR
(
Œªs
);

482 
Œªs
 = 
NULL
;

483 
	`bŒfs_hªdË_fs_”rÜ
(
roÙ
->
fs_šfo
, 
»t
,

485 (
u64
)
šode
->
vfs_šode
.
i_šo
);

486 
out
;

488 
šode
->
ro_æags
 &ğ~
BTRFS_INODE_RO_VERITY
;

489 
	`bŒfs_sync_šode_æags_to_i_æags
(&
šode
->
vfs_šode
);

490 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

491 ià(
»t
) {

492 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

493 
out
;

495 
»t
 = 
	`d–_Üphª
(
Œªs
, 
šode
);

496 ià(
»t
) {

497 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

498 
out
;

500 
out
:

501 ià(
Œªs
)

502 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

503  
»t
;

504 
	}
}

524 
	$fšish_v”™y
(
bŒfs_šode
 *
šode
, cÚ¡ *
desc
,

525 
size_t
 
desc_size
)

527 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

528 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

529 
bŒfs_v”™y_desütÜ_™em
 
™em
;

530 
»t
;

533 
	`mem£t
(&
™em
, 0, (item));

534 
	`bŒfs_£t_¡ack_v”™y_desütÜ_size
(&
™em
, 
desc_size
);

535 
»t
 = 
	`wr™e_key_by‹s
(
šode
, 
BTRFS_VERITY_DESC_ITEM_KEY
, 0,

536 (cÚ¡ *)&
™em
, (item));

537 ià(
»t
)

538 
out
;

541 
»t
 = 
	`wr™e_key_by‹s
(
šode
, 
BTRFS_VERITY_DESC_ITEM_KEY
, 1,

542 
desc
, 
desc_size
);

543 ià(
»t
)

544 
out
;

550 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 2);

551 ià(
	`IS_ERR
(
Œªs
)) {

552 
»t
 = 
	`PTR_ERR
(
Œªs
);

553 
out
;

555 
šode
->
ro_æags
 |ğ
BTRFS_INODE_RO_VERITY
;

556 
	`bŒfs_sync_šode_æags_to_i_æags
(&
šode
->
vfs_šode
);

557 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

558 ià(
»t
)

559 
’d_Œªs
;

560 
»t
 = 
	`d–_Üphª
(
Œªs
, 
šode
);

561 ià(
»t
)

562 
’d_Œªs
;

563 
	`ş—r_b™
(
BTRFS_INODE_VERITY_IN_PROGRESS
, &
šode
->
ruÁime_æags
);

564 
	`bŒfs_£t_fs_com·t_ro
(
roÙ
->
fs_šfo
, 
VERITY
);

565 
’d_Œªs
:

566 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

567 
out
:

568  
»t
;

570 
	}
}

582 
	$bŒfs_begš_’abË_v”™y
(
fe
 *
fp
)

584 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
	`fe_šode
(
fp
));

585 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

586 
bŒfs_Œªs_hªdË
 *
Œªs
;

587 
»t
;

589 
	`ASSERT
(
	`šode_is_locked
(
	`fe_šode
(
fp
)));

591 ià(
	`‹¡_b™
(
BTRFS_INODE_VERITY_IN_PROGRESS
, &
šode
->
ruÁime_æags
))

592  -
EBUSY
;

600 
»t
 = 
	`bŒfs_drİ_v”™y_™ems
(
šode
);

601 ià(
»t
)

602  
»t
;

605 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

606 ià(
	`IS_ERR
(
Œªs
))

607  
	`PTR_ERR
(
Œªs
);

609 
»t
 = 
	`bŒfs_Üphª_add
(
Œªs
, 
šode
);

610 ià(!
»t
)

611 
	`£t_b™
(
BTRFS_INODE_VERITY_IN_PROGRESS
, &
šode
->
ruÁime_æags
);

612 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

615 
	}
}

630 
	$bŒfs_’d_’abË_v”™y
(
fe
 *
fp
, cÚ¡ *
desc
,

631 
size_t
 
desc_size
, 
u64
 
m”kË_Œ“_size
)

633 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
	`fe_šode
(
fp
));

634 
»t
 = 0;

635 
rŞlback_»t
;

637 
	`ASSERT
(
	`šode_is_locked
(
	`fe_šode
(
fp
)));

639 ià(
desc
 =ğ
NULL
)

640 
rŞlback
;

642 
»t
 = 
	`fšish_v”™y
(
šode
, 
desc
, 
desc_size
);

643 ià(
»t
)

644 
rŞlback
;

645  
»t
;

647 
rŞlback
:

648 
rŞlback_»t
 = 
	`rŞlback_v”™y
(
šode
);

649 ià(
rŞlback_»t
)

650 
	`bŒfs_”r
(
šode
->
roÙ
->
fs_šfo
,

651 "çedØrŞlback v”™y i‹ms: %d", 
rŞlback_»t
);

652  
»t
;

653 
	}
}

668 
	$bŒfs_g‘_v”™y_desütÜ
(
šode
 *šode, *
buf
, 
size_t
 
buf_size
)

670 
u64
 
Œue_size
;

671 
»t
 = 0;

672 
bŒfs_v”™y_desütÜ_™em
 
™em
;

674 
	`mem£t
(&
™em
, 0, (item));

675 
»t
 = 
	`»ad_key_by‹s
(
	`BTRFS_I
(
šode
), 
BTRFS_VERITY_DESC_ITEM_KEY
, 0,

676 (*)&
™em
, (™em), 
NULL
);

677 ià(
»t
 < 0)

678  
»t
;

680 ià(
™em
.
»£rved
[0] != 0 || item.reserved[1] != 0)

681  -
EUCLEAN
;

683 
Œue_size
 = 
	`bŒfs_¡ack_v”™y_desütÜ_size
(&
™em
);

684 ià(
Œue_size
 > 
INT_MAX
)

685  -
EUCLEAN
;

687 ià(
buf_size
 == 0)

688  
Œue_size
;

689 ià(
buf_size
 < 
Œue_size
)

690  -
ERANGE
;

692 
»t
 = 
	`»ad_key_by‹s
(
	`BTRFS_I
(
šode
), 
BTRFS_VERITY_DESC_ITEM_KEY
, 1,

693 
buf
, 
buf_size
, 
NULL
);

694 ià(
»t
 < 0)

695  
»t
;

696 ià(
»t
 !ğ
Œue_size
)

697  -
EIO
;

699  
Œue_size
;

700 
	}
}

714 
·ge
 *
	$bŒfs_»ad_m”kË_Œ“_·ge
(
šode
 *inode,

715 
pgoff_t
 
šdex
,

716 
num_¿_·ges
)

718 
fŞio
 *folio;

719 
u64
 
off
 = (u64)
šdex
 << 
PAGE_SHIFT
;

720 
loff_t
 
m”kË_pos
 = 
	`m”kË_fe_pos
(
šode
);

721 
»t
;

723 ià(
m”kË_pos
 < 0)

724  
	`ERR_PTR
(
m”kË_pos
);

725 ià(
m”kË_pos
 > 
šode
->
i_sb
->
s_maxby‹s
 - 
off
 - 
PAGE_SIZE
)

726  
	`ERR_PTR
(-
EFBIG
);

727 
šdex
 +ğ
m”kË_pos
 >> 
PAGE_SHIFT
;

728 
agaš
:

729 
fŞio
 = 
	`__fem­_g‘_fŞio
(
šode
->
i_m­pšg
, 
šdex
, 
FGP_ACCESSED
, 0);

730 ià(!
	`IS_ERR
(
fŞio
)) {

731 ià(
	`fŞio_‹¡_u±od©e
(
fŞio
))

732 
out
;

734 
	`fŞio_lock
(
fŞio
);

736 ià(!
	`fŞio_‹¡_u±od©e
(
fŞio
)) {

737 
	`fŞio_uÆock
(
fŞio
);

738 
	`fŞio_put
(
fŞio
);

739  
	`ERR_PTR
(-
EIO
);

741 
	`fŞio_uÆock
(
fŞio
);

742 
out
;

745 
fŞio
 = 
	`fem­_®loc_fŞio
(
	`m­pšg_gå_cÚ¡¿št
(
šode
->
i_m­pšg
, ~
__GFP_FS
),

747 ià(!
fŞio
)

748  
	`ERR_PTR
(-
ENOMEM
);

750 
»t
 = 
	`fem­_add_fŞio
(
šode
->
i_m­pšg
, 
fŞio
, 
šdex
, 
GFP_NOFS
);

751 ià(
»t
) {

752 
	`fŞio_put
(
fŞio
);

754 ià(
»t
 =ğ-
EEXIST
)

755 
agaš
;

756  
	`ERR_PTR
(
»t
);

765 
»t
 = 
	`»ad_key_by‹s
(
	`BTRFS_I
(
šode
), 
BTRFS_VERITY_MERKLE_ITEM_KEY
, 
off
,

766 
	`fŞio_add»ss
(
fŞio
), 
PAGE_SIZE
, &fŞio->
·ge
);

767 ià(
»t
 < 0) {

768 
	`fŞio_put
(
fŞio
);

769  
	`ERR_PTR
(
»t
);

771 ià(
»t
 < 
PAGE_SIZE
)

772 
	`fŞio_z”o_£gm’t
(
fŞio
, 
»t
, 
PAGE_SIZE
);

774 
	`fŞio_m¬k_u±od©e
(
fŞio
);

775 
	`fŞio_uÆock
(
fŞio
);

777 
out
:

778  
	`fŞio_fe_·ge
(
fŞio
, 
šdex
);

779 
	}
}

791 
	$bŒfs_wr™e_m”kË_Œ“_block
(
šode
 *šode, cÚ¡ *
buf
,

792 
u64
 
pos
, 
size
)

794 
loff_t
 
m”kË_pos
 = 
	`m”kË_fe_pos
(
šode
);

796 ià(
m”kË_pos
 < 0)

797  
m”kË_pos
;

798 ià(
m”kË_pos
 > 
šode
->
i_sb
->
s_maxby‹s
 - 
pos
 - 
size
)

799  -
EFBIG
;

801  
	`wr™e_key_by‹s
(
	`BTRFS_I
(
šode
), 
BTRFS_VERITY_MERKLE_ITEM_KEY
,

802 
pos
, 
buf
, 
size
);

803 
	}
}

805 cÚ¡ 
fsv”™y_İ”©iÚs
 
	gbŒfs_v”™yİs
 = {

806 .
begš_’abË_v”™y
 = 
bŒfs_begš_’abË_v”™y
,

807 .
	g’d_’abË_v”™y
 = 
bŒfs_’d_’abË_v”™y
,

808 .
	gg‘_v”™y_desütÜ
 = 
bŒfs_g‘_v”™y_desütÜ
,

809 .
	g»ad_m”kË_Œ“_·ge
 = 
bŒfs_»ad_m”kË_Œ“_·ge
,

810 .
	gwr™e_m”kË_Œ“_block
 = 
bŒfs_wr™e_m”kË_Œ“_block
,

	@verity.h

3 #iâdeà
BTRFS_VERITY_H


4 
	#BTRFS_VERITY_H


	)

6 #ifdeà
CONFIG_FS_VERITY


8 cÚ¡ 
fsv”™y_İ”©iÚs
 
bŒfs_v”™yİs
;

10 
bŒfs_drİ_v”™y_™ems
(
bŒfs_šode
 *
šode
);

11 
bŒfs_g‘_v”™y_desütÜ
(
šode
 *šode, *
buf
, 
size_t
 
buf_size
);

15 
šlše
 
	$bŒfs_drİ_v”™y_™ems
(
bŒfs_šode
 *
šode
)

18 
	}
}

20 
šlše
 
	$bŒfs_g‘_v”™y_desütÜ
(
šode
 *šode, *
buf
,

21 
size_t
 
buf_size
)

23  -
EPERM
;

24 
	}
}

	@volumes.c

6 
	~<lšux/sched.h
>

7 
	~<lšux/sched/mm.h
>

8 
	~<lšux/¦ab.h
>

9 
	~<lšux/¿‹lim™.h
>

10 
	~<lšux/kth»ad.h
>

11 
	~<lšux/£m­hÜe.h
>

12 
	~<lšux/uuid.h
>

13 
	~<lšux/li¡_sÜt.h
>

14 
	~<lšux/Çmei.h
>

15 
	~"misc.h
"

16 
	~"ù»e.h
"

17 
	~"ex‹Á_m­.h
"

18 
	~"disk-io.h
"

19 
	~"Œª§ùiÚ.h
"

20 
	~"´št-Œ“.h
"

21 
	~"vŞumes.h
"

22 
	~"¿id56.h
"

23 
	~"rcu-¡ršg.h
"

24 
	~"dev-»¶aû.h
"

25 
	~"sysfs.h
"

26 
	~"Œ“-check”.h
"

27 
	~"¥aû-šfo.h
"

28 
	~"block-group.h
"

29 
	~"disÿrd.h
"

30 
	~"zÚed.h
"

31 
	~"fs.h
"

32 
	~"acûssÜs.h
"

33 
	~"uuid-Œ“.h
"

34 
	~"ioùl.h
"

35 
	~"»loÿtiÚ.h
"

36 
	~"süub.h
"

37 
	~"su³r.h
"

39 
	#BTRFS_BLOCK_GROUP_STRIPE_MASK
 (
BTRFS_BLOCK_GROUP_RAID0
 | \

40 
BTRFS_BLOCK_GROUP_RAID10
 | \

41 
BTRFS_BLOCK_GROUP_RAID56_MASK
)

	)

43 cÚ¡ 
bŒfs_¿id_©Œ
 
	gbŒfs_¿id_¬¿y
[
BTRFS_NR_RAID_TYPES
] = {

44 [
BTRFS_RAID_RAID10
] = {

45 .
sub_¡res
 = 2,

46 .
	gdev_¡res
 = 1,

47 .
	gdevs_max
 = 0,

48 .
	gdevs_mš
 = 2,

49 .
	gtŞ”©ed_çu»s
 = 1,

50 .
	gdevs_šüem’t
 = 2,

51 .
	gncİ›s
 = 2,

52 .
	gÅ¬™y
 = 0,

53 .
	g¿id_Çme
 = "raid10",

54 .
	gbg_æag
 = 
BTRFS_BLOCK_GROUP_RAID10
,

55 .
	gmšdev_”rÜ
 = 
BTRFS_ERROR_DEV_RAID10_MIN_NOT_MET
,

57 [
BTRFS_RAID_RAID1
] = {

58 .
sub_¡res
 = 1,

59 .
	gdev_¡res
 = 1,

60 .
	gdevs_max
 = 2,

61 .
	gdevs_mš
 = 2,

62 .
	gtŞ”©ed_çu»s
 = 1,

63 .
	gdevs_šüem’t
 = 2,

64 .
	gncİ›s
 = 2,

65 .
	gÅ¬™y
 = 0,

66 .
	g¿id_Çme
 = "raid1",

67 .
	gbg_æag
 = 
BTRFS_BLOCK_GROUP_RAID1
,

68 .
	gmšdev_”rÜ
 = 
BTRFS_ERROR_DEV_RAID1_MIN_NOT_MET
,

70 [
BTRFS_RAID_RAID1C3
] = {

71 .
sub_¡res
 = 1,

72 .
	gdev_¡res
 = 1,

73 .
	gdevs_max
 = 3,

74 .
	gdevs_mš
 = 3,

75 .
	gtŞ”©ed_çu»s
 = 2,

76 .
	gdevs_šüem’t
 = 3,

77 .
	gncİ›s
 = 3,

78 .
	gÅ¬™y
 = 0,

79 .
	g¿id_Çme
 = "raid1c3",

80 .
	gbg_æag
 = 
BTRFS_BLOCK_GROUP_RAID1C3
,

81 .
	gmšdev_”rÜ
 = 
BTRFS_ERROR_DEV_RAID1C3_MIN_NOT_MET
,

83 [
BTRFS_RAID_RAID1C4
] = {

84 .
sub_¡res
 = 1,

85 .
	gdev_¡res
 = 1,

86 .
	gdevs_max
 = 4,

87 .
	gdevs_mš
 = 4,

88 .
	gtŞ”©ed_çu»s
 = 3,

89 .
	gdevs_šüem’t
 = 4,

90 .
	gncİ›s
 = 4,

91 .
	gÅ¬™y
 = 0,

92 .
	g¿id_Çme
 = "raid1c4",

93 .
	gbg_æag
 = 
BTRFS_BLOCK_GROUP_RAID1C4
,

94 .
	gmšdev_”rÜ
 = 
BTRFS_ERROR_DEV_RAID1C4_MIN_NOT_MET
,

96 [
BTRFS_RAID_DUP
] = {

97 .
sub_¡res
 = 1,

98 .
	gdev_¡res
 = 2,

99 .
	gdevs_max
 = 1,

100 .
	gdevs_mš
 = 1,

101 .
	gtŞ”©ed_çu»s
 = 0,

102 .
	gdevs_šüem’t
 = 1,

103 .
	gncİ›s
 = 2,

104 .
	gÅ¬™y
 = 0,

105 .
	g¿id_Çme
 = "dup",

106 .
	gbg_æag
 = 
BTRFS_BLOCK_GROUP_DUP
,

107 .
	gmšdev_”rÜ
 = 0,

109 [
BTRFS_RAID_RAID0
] = {

110 .
sub_¡res
 = 1,

111 .
	gdev_¡res
 = 1,

112 .
	gdevs_max
 = 0,

113 .
	gdevs_mš
 = 1,

114 .
	gtŞ”©ed_çu»s
 = 0,

115 .
	gdevs_šüem’t
 = 1,

116 .
	gncİ›s
 = 1,

117 .
	gÅ¬™y
 = 0,

118 .
	g¿id_Çme
 = "raid0",

119 .
	gbg_æag
 = 
BTRFS_BLOCK_GROUP_RAID0
,

120 .
	gmšdev_”rÜ
 = 0,

122 [
BTRFS_RAID_SINGLE
] = {

123 .
sub_¡res
 = 1,

124 .
	gdev_¡res
 = 1,

125 .
	gdevs_max
 = 1,

126 .
	gdevs_mš
 = 1,

127 .
	gtŞ”©ed_çu»s
 = 0,

128 .
	gdevs_šüem’t
 = 1,

129 .
	gncİ›s
 = 1,

130 .
	gÅ¬™y
 = 0,

131 .
	g¿id_Çme
 = "single",

132 .
	gbg_æag
 = 0,

133 .
	gmšdev_”rÜ
 = 0,

135 [
BTRFS_RAID_RAID5
] = {

136 .
sub_¡res
 = 1,

137 .
	gdev_¡res
 = 1,

138 .
	gdevs_max
 = 0,

139 .
	gdevs_mš
 = 2,

140 .
	gtŞ”©ed_çu»s
 = 1,

141 .
	gdevs_šüem’t
 = 1,

142 .
	gncİ›s
 = 1,

143 .
	gÅ¬™y
 = 1,

144 .
	g¿id_Çme
 = "raid5",

145 .
	gbg_æag
 = 
BTRFS_BLOCK_GROUP_RAID5
,

146 .
	gmšdev_”rÜ
 = 
BTRFS_ERROR_DEV_RAID5_MIN_NOT_MET
,

148 [
BTRFS_RAID_RAID6
] = {

149 .
sub_¡res
 = 1,

150 .
	gdev_¡res
 = 1,

151 .
	gdevs_max
 = 0,

152 .
	gdevs_mš
 = 3,

153 .
	gtŞ”©ed_çu»s
 = 2,

154 .
	gdevs_šüem’t
 = 1,

155 .
	gncİ›s
 = 1,

156 .
	gÅ¬™y
 = 2,

157 .
	g¿id_Çme
 = "raid6",

158 .
	gbg_æag
 = 
BTRFS_BLOCK_GROUP_RAID6
,

159 .
	gmšdev_”rÜ
 = 
BTRFS_ERROR_DEV_RAID6_MIN_NOT_MET
,

167 
bŒfs_¿id_ty³s
 
__©Œibu‹_cÚ¡__
 
	$bŒfs_bg_æags_to_¿id_šdex
(
u64
 
æags
)

169 cÚ¡ 
u64
 
´ofe
 = (
æags
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
);

171 ià(!
´ofe
)

172  
BTRFS_RAID_SINGLE
;

174  
	`BTRFS_BG_FLAG_TO_INDEX
(
´ofe
);

175 
	}
}

177 cÚ¡ *
	$bŒfs_bg_ty³_to_¿id_Çme
(
u64
 
æags
)

179 cÚ¡ 
šdex
 = 
	`bŒfs_bg_æags_to_¿id_šdex
(
æags
);

181 ià(
šdex
 >ğ
BTRFS_NR_RAID_TYPES
)

182  
NULL
;

184  
bŒfs_¿id_¬¿y
[
šdex
].
¿id_Çme
;

185 
	}
}

187 
	$bŒfs_Ä_·r™y_¡res
(
u64
 
ty³
)

189 
bŒfs_¿id_ty³s
 
šdex
 = 
	`bŒfs_bg_æags_to_¿id_šdex
(
ty³
);

191  
bŒfs_¿id_¬¿y
[
šdex
].
Å¬™y
;

192 
	}
}

198 
	$bŒfs_desüibe_block_groups
(
u64
 
bg_æags
, *
buf
, 
u32
 
size_buf
)

200 
i
;

201 
»t
;

202 *
bp
 = 
buf
;

203 
u64
 
æags
 = 
bg_æags
;

204 
u32
 
size_bp
 = 
size_buf
;

206 ià(!
æags
) {

207 
	`¡rıy
(
bp
, "NONE");

211 
	#DESCRIBE_FLAG
(
æag
, 
desc
) \

213 ià(
æags
 & (
æag
)) { \

214 
»t
 = 
	`¢´štf
(
bp
, 
size_bp
, "%s|", (
desc
)); \

215 ià(
»t
 < 0 ||„‘ >ğ
size_bp
) \

216 
out_ov”æow
; \

217 
size_bp
 -ğ
»t
; \

218 
bp
 +ğ
»t
; \

219 
æags
 &ğ~(
æag
); \

221 } 0)

	)

223 
	`DESCRIBE_FLAG
(
BTRFS_BLOCK_GROUP_DATA
, "data");

224 
	`DESCRIBE_FLAG
(
BTRFS_BLOCK_GROUP_SYSTEM
, "system");

225 
	`DESCRIBE_FLAG
(
BTRFS_BLOCK_GROUP_METADATA
, "metadata");

227 
	`DESCRIBE_FLAG
(
BTRFS_AVAIL_ALLOC_BIT_SINGLE
, "single");

228 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; i++)

229 
	`DESCRIBE_FLAG
(
bŒfs_¿id_¬¿y
[
i
].
bg_æag
,

230 
bŒfs_¿id_¬¿y
[
i
].
¿id_Çme
);

231 #undeà
DESCRIBE_FLAG


233 ià(
æags
) {

234 
»t
 = 
	`¢´štf
(
bp
, 
size_bp
, "0x%Îx|", 
æags
);

235 
size_bp
 -ğ
»t
;

238 ià(
size_bp
 < 
size_buf
)

239 
buf
[
size_buf
 - 
size_bp
 - 1] = '\0';

245 
out_ov”æow
:;

246 
	}
}

248 
š™_fœ¡_rw_deviû
(
bŒfs_Œªs_hªdË
 *
Œªs
);

249 
bŒfs_»loÿ‹_sys_chunks
(
bŒfs_fs_šfo
 *
fs_šfo
);

250 
bŒfs_dev_¡©_´št_Ú_lßd
(
bŒfs_deviû
 *
deviû
);

352 
DEFINE_MUTEX
(
uuid_mu‹x
);

353 
LIST_HEAD
(
fs_uuids
);

354 
li¡_h—d
 * 
__©Œibu‹_cÚ¡__
 
	$bŒfs_g‘_fs_uuids
()

356  &
fs_uuids
;

357 
	}
}

368 
bŒfs_fs_deviûs
 *
	$®loc_fs_deviûs
(cÚ¡ 
u8
 *
fsid
,

369 cÚ¡ 
u8
 *
m‘ad©a_fsid
)

371 
bŒfs_fs_deviûs
 *
fs_devs
;

373 
	`ASSERT
(
fsid
 || !
m‘ad©a_fsid
);

375 
fs_devs
 = 
	`kz®loc
((*fs_devs), 
GFP_KERNEL
);

376 ià(!
fs_devs
)

377  
	`ERR_PTR
(-
ENOMEM
);

379 
	`mu‹x_š™
(&
fs_devs
->
deviû_li¡_mu‹x
);

381 
	`INIT_LIST_HEAD
(&
fs_devs
->
deviûs
);

382 
	`INIT_LIST_HEAD
(&
fs_devs
->
®loc_li¡
);

383 
	`INIT_LIST_HEAD
(&
fs_devs
->
fs_li¡
);

384 
	`INIT_LIST_HEAD
(&
fs_devs
->
£ed_li¡
);

386 ià(
fsid
) {

387 
	`memıy
(
fs_devs
->
fsid
, fsid, 
BTRFS_FSID_SIZE
);

388 
	`memıy
(
fs_devs
->
m‘ad©a_uuid
,

389 
m‘ad©a_fsid
 ?: 
fsid
, 
BTRFS_FSID_SIZE
);

392  
fs_devs
;

393 
	}
}

395 
	$bŒfs_ä“_deviû
(
bŒfs_deviû
 *
deviû
)

397 
	`WARN_ON
(!
	`li¡_em±y
(&
deviû
->
po¡_comm™_li¡
));

398 
	`rcu_¡ršg_ä“
(
deviû
->
Çme
);

399 
	`ex‹Á_io_Œ“_»Ëa£
(&
deviû
->
®loc_¡©e
);

400 
	`bŒfs_de¡roy_dev_zÚe_šfo
(
deviû
);

401 
	`kä“
(
deviû
);

402 
	}
}

404 
	$ä“_fs_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
)

406 
bŒfs_deviû
 *
deviû
;

408 
	`WARN_ON
(
fs_deviûs
->
İ’ed
);

409 !
	`li¡_em±y
(&
fs_deviûs
->
deviûs
)) {

410 
deviû
 = 
	`li¡_’Œy
(
fs_deviûs
->
deviûs
.
Ãxt
,

411 
bŒfs_deviû
, 
dev_li¡
);

412 
	`li¡_d–
(&
deviû
->
dev_li¡
);

413 
	`bŒfs_ä“_deviû
(
deviû
);

415 
	`kä“
(
fs_deviûs
);

416 
	}
}

418 
__ex™
 
	$bŒfs_ş—nup_fs_uuids
()

420 
bŒfs_fs_deviûs
 *
fs_deviûs
;

422 !
	`li¡_em±y
(&
fs_uuids
)) {

423 
fs_deviûs
 = 
	`li¡_’Œy
(
fs_uuids
.
Ãxt
,

424 
bŒfs_fs_deviûs
, 
fs_li¡
);

425 
	`li¡_d–
(&
fs_deviûs
->
fs_li¡
);

426 
	`ä“_fs_deviûs
(
fs_deviûs
);

428 
	}
}

430 
boŞ
 
	$m©ch_fsid_fs_deviûs
(cÚ¡ 
bŒfs_fs_deviûs
 *
fs_deviûs
,

431 cÚ¡ 
u8
 *
fsid
, cÚ¡ u8 *
m‘ad©a_fsid
)

433 ià(
	`memcmp
(
fsid
, 
fs_deviûs
->fsid, 
BTRFS_FSID_SIZE
) != 0)

434  
çl£
;

436 ià(!
m‘ad©a_fsid
)

437  
Œue
;

439 ià(
	`memcmp
(
m‘ad©a_fsid
, 
fs_deviûs
->
m‘ad©a_uuid
, 
BTRFS_FSID_SIZE
) != 0)

440  
çl£
;

442  
Œue
;

443 
	}
}

445 
nošlše
 
bŒfs_fs_deviûs
 *
	$fšd_fsid
(

446 cÚ¡ 
u8
 *
fsid
, cÚ¡ u8 *
m‘ad©a_fsid
)

448 
bŒfs_fs_deviûs
 *
fs_deviûs
;

450 
	`ASSERT
(
fsid
);

453 
	`li¡_fÜ_—ch_’Œy
(
fs_deviûs
, &
fs_uuids
, 
fs_li¡
) {

454 ià(
	`m©ch_fsid_fs_deviûs
(
fs_deviûs
, 
fsid
, 
m‘ad©a_fsid
))

455  
fs_deviûs
;

457  
NULL
;

458 
	}
}

465 
šlše
 
boŞ
 
	$check_fsid_chªged
(cÚ¡ 
bŒfs_fs_deviûs
 *
fs_deviûs
,

466 cÚ¡ 
u8
 *
fsid
)

468  
	`memcmp
(
fs_deviûs
->
fsid
, fs_deviûs->
m‘ad©a_uuid
,

469 
BTRFS_FSID_SIZE
) != 0 &&

470 
	`memcmp
(
fs_deviûs
->
m‘ad©a_uuid
, 
fsid
, 
BTRFS_FSID_SIZE
) == 0;

471 
	}
}

473 
bŒfs_fs_deviûs
 *
	$fšd_fsid_w™h_m‘ad©a_uuid
(

474 
bŒfs_su³r_block
 *
disk_su³r
)

477 
bŒfs_fs_deviûs
 *
fs_deviûs
;

485 
	`li¡_fÜ_—ch_’Œy
(
fs_deviûs
, &
fs_uuids
, 
fs_li¡
) {

486 ià(!
fs_deviûs
->
fsid_chªge
)

489 ià(
	`m©ch_fsid_fs_deviûs
(
fs_deviûs
, 
disk_su³r
->
m‘ad©a_uuid
,

490 
fs_deviûs
->
fsid
))

491  
fs_deviûs
;

500 
	`li¡_fÜ_—ch_’Œy
(
fs_deviûs
, &
fs_uuids
, 
fs_li¡
) {

501 ià(!
fs_deviûs
->
fsid_chªge
)

504 ià(
	`check_fsid_chªged
(
fs_deviûs
, 
disk_su³r
->
m‘ad©a_uuid
))

505  
fs_deviûs
;

508  
	`fšd_fsid
(
disk_su³r
->
fsid
, disk_su³r->
m‘ad©a_uuid
);

509 
	}
}

512 
	$bŒfs_g‘_bdev_ªd_sb
(cÚ¡ *
deviû_·th
, 
blk_mode_t
 
æags
, *
hŞd”
,

513 
æush
, 
block_deviû
 **
bdev
,

514 
bŒfs_su³r_block
 **
disk_su³r
)

516 
»t
;

518 *
bdev
 = 
	`blkdev_g‘_by_·th
(
deviû_·th
, 
æags
, 
hŞd”
, 
NULL
);

520 ià(
	`IS_ERR
(*
bdev
)) {

521 
»t
 = 
	`PTR_ERR
(*
bdev
);

522 
”rÜ
;

525 ià(
æush
)

526 
	`sync_blockdev
(*
bdev
);

527 
»t
 = 
	`£t_blocksize
(*
bdev
, 
BTRFS_BDEV_BLOCKSIZE
);

528 ià(
»t
) {

529 
	`blkdev_put
(*
bdev
, 
hŞd”
);

530 
”rÜ
;

532 
	`šv®id©e_bdev
(*
bdev
);

533 *
disk_su³r
 = 
	`bŒfs_»ad_dev_su³r
(*
bdev
);

534 ià(
	`IS_ERR
(*
disk_su³r
)) {

535 
»t
 = 
	`PTR_ERR
(*
disk_su³r
);

536 
	`blkdev_put
(*
bdev
, 
hŞd”
);

537 
”rÜ
;

542 
”rÜ
:

543 *
bdev
 = 
NULL
;

544  
»t
;

545 
	}
}

548 
	$bŒfs_g‘_bdev_ªd_sb_·¹™iÚ
(cÚ¡ *
deviû_·th
, 
blk_mode_t
 
æags
, *
hŞd”
,

549 
æush
, 
block_deviû
 **
bdev
,

550 
bŒfs_su³r_block
 **
disk_su³r
, 
·¹™iÚ_Üd”
)

552 
»t
;

554 *
bdev
 = 
	`blkdev_g‘_by_·th
(
deviû_·th
, 
æags
, 
hŞd”
, 
NULL
);

556 ià(
	`IS_ERR
(*
bdev
)) {

557 
»t
 = 
	`PTR_ERR
(*
bdev
);

558 
”rÜ
;

561 ià(
æush
)

562 
	`sync_blockdev
(*
bdev
);

563 
»t
 = 
	`£t_blocksize
(*
bdev
, 
BTRFS_BDEV_BLOCKSIZE
);

564 ià(
»t
) {

565 
	`blkdev_put
(*
bdev
, 
hŞd”
);

566 
”rÜ
;

568 
	`šv®id©e_bdev
(*
bdev
);

569 *
disk_su³r
 = 
	`bŒfs_»ad_dev_su³r_·¹™iÚ
(*
bdev
, 
·¹™iÚ_Üd”
);

570 ià(
	`IS_ERR
(*
disk_su³r
)) {

571 
»t
 = 
	`PTR_ERR
(*
disk_su³r
);

572 
	`blkdev_put
(*
bdev
, 
hŞd”
);

573 
”rÜ
;

578 
”rÜ
:

579 *
bdev
 = 
NULL
;

580  
»t
;

581 
	}
}

596 
	$bŒfs_ä“_¡®e_deviûs
(
dev_t
 
devt
, 
bŒfs_deviû
 *
sk_deviû
)

598 
bŒfs_fs_deviûs
 *
fs_deviûs
, *
tmp_fs_deviûs
;

599 
bŒfs_deviû
 *
deviû
, *
tmp_deviû
;

600 
»t
 = 0;

602 
	`lockd•_as£¹_h–d
(&
uuid_mu‹x
);

604 ià(
devt
)

605 
»t
 = -
ENOENT
;

607 
	`li¡_fÜ_—ch_’Œy_§ã
(
fs_deviûs
, 
tmp_fs_deviûs
, &
fs_uuids
, 
fs_li¡
) {

609 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

610 
	`li¡_fÜ_—ch_’Œy_§ã
(
deviû
, 
tmp_deviû
,

611 &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

612 ià(
sk_deviû
 && sk_deviû =ğ
deviû
)

614 ià(
devt
 && devˆ!ğ
deviû
->devt)

616 ià(
fs_deviûs
->
İ’ed
) {

618 ià(
devt
 && 
»t
 != 0)

619 
»t
 = -
EBUSY
;

624 
fs_deviûs
->
num_deviûs
--;

625 
	`li¡_d–
(&
deviû
->
dev_li¡
);

626 
	`bŒfs_ä“_deviû
(
deviû
);

628 
»t
 = 0;

630 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

632 ià(
fs_deviûs
->
num_deviûs
 == 0) {

633 
	`bŒfs_sysfs_»move_fsid
(
fs_deviûs
);

634 
	`li¡_d–
(&
fs_deviûs
->
fs_li¡
);

635 
	`ä“_fs_deviûs
(
fs_deviûs
);

639  
»t
;

640 
	}
}

647 
	$bŒfs_İ’_Úe_deviû
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

648 
bŒfs_deviû
 *
deviû
, 
blk_mode_t
 
æags
,

649 *
hŞd”
)

651 
block_deviû
 *
bdev
;

652 
bŒfs_su³r_block
 *
disk_su³r
;

653 
u64
 
devid
;

654 
»t
;

656 ià(
deviû
->
bdev
)

657  -
EINVAL
;

658 ià(!
deviû
->
Çme
)

659  -
EINVAL
;

661 
»t
 = 
	`bŒfs_g‘_bdev_ªd_sb
(
deviû
->
Çme
->
¡r
, 
æags
, 
hŞd”
, 1,

662 &
bdev
, &
disk_su³r
);

663 ià(
»t
)

664  
»t
;

666 
devid
 = 
	`bŒfs_¡ack_deviû_id
(&
disk_su³r
->
dev_™em
);

667 ià(
devid
 !ğ
deviû
->devid)

668 
”rÜ_ä“_·ge
;

670 ià(
	`memcmp
(
deviû
->
uuid
, 
disk_su³r
->
dev_™em
.uuid, 
BTRFS_UUID_SIZE
))

671 
”rÜ_ä“_·ge
;

673 
deviû
->
g’”©iÚ
 = 
	`bŒfs_su³r_g’”©iÚ
(
disk_su³r
);

675 ià(
	`bŒfs_su³r_æags
(
disk_su³r
è& 
BTRFS_SUPER_FLAG_SEEDING
) {

676 ià(
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
) &

677 
BTRFS_FEATURE_INCOMPAT_METADATA_UUID
) {

678 
	`´_”r
(

680 
”rÜ_ä“_·ge
;

683 
	`ş—r_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
);

684 
fs_deviûs
->
£edšg
 = 
Œue
;

686 ià(
	`bdev_»ad_Úly
(
bdev
))

687 
	`ş—r_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
);

689 
	`£t_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
);

692 ià(!
	`bdev_nÚrÙ
(
bdev
))

693 
fs_deviûs
->
rÙ©šg
 = 
Œue
;

695 ià(
	`bdev_max_disÿrd_£ùÜs
(
bdev
))

696 
fs_deviûs
->
disÿrdabË
 = 
Œue
;

698 
deviû
->
bdev
 = bdev;

699 
	`ş—r_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
deviû
->
dev_¡©e
);

700 
deviû
->
hŞd”
 = holder;

702 
fs_deviûs
->
İ’_deviûs
++;

703 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
) &&

704 
deviû
->
devid
 !ğ
BTRFS_DEV_REPLACE_DEVID
) {

705 
fs_deviûs
->
rw_deviûs
++;

706 
	`li¡_add_
(&
deviû
->
dev_®loc_li¡
, &
fs_deviûs
->
®loc_li¡
);

708 
	`bŒfs_»Ëa£_disk_su³r
(
disk_su³r
);

712 
”rÜ_ä“_·ge
:

713 
	`bŒfs_»Ëa£_disk_su³r
(
disk_su³r
);

714 
	`blkdev_put
(
bdev
, 
hŞd”
);

716  -
EINVAL
;

717 
	}
}

720 
	$bŒfs_İ’_Úe_deviû_·¹™iÚ
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

721 
bŒfs_deviû
 *
deviû
, 
blk_mode_t
 
æags
,

722 *
hŞd”
, 
·¹™iÚ_Üd”
)

724 
block_deviû
 *
bdev
;

725 
bŒfs_su³r_block
 *
disk_su³r
;

726 
u64
 
devid
;

727 
»t
;

729 ià(
deviû
->
bdev
)

730  -
EINVAL
;

731 ià(!
deviû
->
Çme
)

732  -
EINVAL
;

734 
»t
 = 
	`bŒfs_g‘_bdev_ªd_sb_·¹™iÚ
(
deviû
->
Çme
->
¡r
, 
æags
, 
hŞd”
, 1,

735 &
bdev
, &
disk_su³r
, 
·¹™iÚ_Üd”
);

736 ià(
»t
)

737  
»t
;

739 
devid
 = 
	`bŒfs_¡ack_deviû_id
(&
disk_su³r
->
dev_™em
);

740 ià(
devid
 !ğ
deviû
->devid)

741 
”rÜ_ä“_·ge
;

743 ià(
	`memcmp
(
deviû
->
uuid
, 
disk_su³r
->
dev_™em
.uuid, 
BTRFS_UUID_SIZE
))

744 
”rÜ_ä“_·ge
;

746 
deviû
->
g’”©iÚ
 = 
	`bŒfs_su³r_g’”©iÚ
(
disk_su³r
);

748 ià(
	`bŒfs_su³r_æags
(
disk_su³r
è& 
BTRFS_SUPER_FLAG_SEEDING
) {

749 ià(
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
) &

750 
BTRFS_FEATURE_INCOMPAT_METADATA_UUID
) {

751 
	`´_”r
(

753 
”rÜ_ä“_·ge
;

756 
	`ş—r_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
);

757 
fs_deviûs
->
£edšg
 = 
Œue
;

759 ià(
	`bdev_»ad_Úly
(
bdev
))

760 
	`ş—r_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
);

762 
	`£t_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
);

765 ià(!
	`bdev_nÚrÙ
(
bdev
))

766 
fs_deviûs
->
rÙ©šg
 = 
Œue
;

768 ià(
	`bdev_max_disÿrd_£ùÜs
(
bdev
))

769 
fs_deviûs
->
disÿrdabË
 = 
Œue
;

771 
deviû
->
bdev
 = bdev;

772 
	`ş—r_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
deviû
->
dev_¡©e
);

773 
deviû
->
hŞd”
 = holder;

775 
fs_deviûs
->
İ’_deviûs
++;

776 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
) &&

777 
deviû
->
devid
 !ğ
BTRFS_DEV_REPLACE_DEVID
) {

778 
fs_deviûs
->
rw_deviûs
++;

779 
	`li¡_add_
(&
deviû
->
dev_®loc_li¡
, &
fs_deviûs
->
®loc_li¡
);

781 
	`bŒfs_»Ëa£_disk_su³r
(
disk_su³r
);

785 
”rÜ_ä“_·ge
:

786 
	`bŒfs_»Ëa£_disk_su³r
(
disk_su³r
);

787 
	`blkdev_put
(
bdev
, 
hŞd”
);

789  -
EINVAL
;

790 
	}
}

792 
u8
 *
	$bŒfs_sb_fsid_±r
(
bŒfs_su³r_block
 *
sb
)

794 
boŞ
 
has_m‘ad©a_uuid
 = (
	`bŒfs_su³r_šcom·t_æags
(
sb
) &

795 
BTRFS_FEATURE_INCOMPAT_METADATA_UUID
);

797  
has_m‘ad©a_uuid
 ? 
sb
->
m‘ad©a_uuid
 : sb->
fsid
;

798 
	}
}

806 
bŒfs_fs_deviûs
 *
	$fšd_fsid_š´og»ss
(

807 
bŒfs_su³r_block
 *
disk_su³r
)

809 
bŒfs_fs_deviûs
 *
fs_deviûs
;

811 
	`li¡_fÜ_—ch_’Œy
(
fs_deviûs
, &
fs_uuids
, 
fs_li¡
) {

812 ià(
fs_deviûs
->
fsid_chªge
)

815 ià(
	`check_fsid_chªged
(
fs_deviûs
, 
disk_su³r
->
fsid
))

816  
fs_deviûs
;

819  
	`fšd_fsid
(
disk_su³r
->
fsid
, 
NULL
);

820 
	}
}

822 
bŒfs_fs_deviûs
 *
	$fšd_fsid_chªged
(

823 
bŒfs_su³r_block
 *
disk_su³r
)

825 
bŒfs_fs_deviûs
 *
fs_deviûs
;

836 
	`li¡_fÜ_—ch_’Œy
(
fs_deviûs
, &
fs_uuids
, 
fs_li¡
) {

838 ià(
	`check_fsid_chªged
(
fs_deviûs
, 
disk_su³r
->
m‘ad©a_uuid
) &&

839 
	`memcmp
(
fs_deviûs
->
fsid
, 
disk_su³r
->fsid,

840 
BTRFS_FSID_SIZE
) != 0)

841  
fs_deviûs
;

844 ià(
	`memcmp
(
fs_deviûs
->
m‘ad©a_uuid
, fs_deviûs->
fsid
,

845 
BTRFS_FSID_SIZE
) == 0 &&

846 
	`memcmp
(
fs_deviûs
->
fsid
, 
disk_su³r
->
m‘ad©a_uuid
,

847 
BTRFS_FSID_SIZE
) == 0)

848  
fs_deviûs
;

851  
NULL
;

852 
	}
}

854 
bŒfs_fs_deviûs
 *
	$fšd_fsid_»v”‹d_m‘ad©a
(

855 
bŒfs_su³r_block
 *
disk_su³r
)

857 
bŒfs_fs_deviûs
 *
fs_deviûs
;

868 
	`li¡_fÜ_—ch_’Œy
(
fs_deviûs
, &
fs_uuids
, 
fs_li¡
) {

869 ià(!
fs_deviûs
->
fsid_chªge
)

872 ià(
	`check_fsid_chªged
(
fs_deviûs
, 
disk_su³r
->
fsid
))

873  
fs_deviûs
;

876  
NULL
;

877 
	}
}

885 
nošlše
 
bŒfs_deviû
 *
	$deviû_li¡_add
(cÚ¡ *
·th
,

886 
bŒfs_su³r_block
 *
disk_su³r
,

887 
boŞ
 *
Ãw_deviû_added
)

889 
bŒfs_deviû
 *
deviû
;

890 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
NULL
;

891 
rcu_¡ršg
 *
Çme
;

892 
u64
 
found_Œªsid
 = 
	`bŒfs_su³r_g’”©iÚ
(
disk_su³r
);

893 
u64
 
devid
 = 
	`bŒfs_¡ack_deviû_id
(&
disk_su³r
->
dev_™em
);

894 
dev_t
 
·th_devt
;

895 
”rÜ
;

896 
boŞ
 
has_m‘ad©a_uuid
 = (
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
) &

897 
BTRFS_FEATURE_INCOMPAT_METADATA_UUID
);

898 
boŞ
 
fsid_chªge_š_´og»ss
 = (
	`bŒfs_su³r_æags
(
disk_su³r
) &

899 
BTRFS_SUPER_FLAG_CHANGING_FSID_V2
);

901 
”rÜ
 = 
	`lookup_bdev
(
·th
, &
·th_devt
);

902 ià(
”rÜ
) {

903 
	`bŒfs_”r
(
NULL
, "failedo†ookup block device for…ath %s: %d",

904 
·th
, 
”rÜ
);

905  
	`ERR_PTR
(
”rÜ
);

908 ià(
fsid_chªge_š_´og»ss
) {

909 ià(!
has_m‘ad©a_uuid
)

910 
fs_deviûs
 = 
	`fšd_fsid_š´og»ss
(
disk_su³r
);

912 
fs_deviûs
 = 
	`fšd_fsid_chªged
(
disk_su³r
);

913 } ià(
has_m‘ad©a_uuid
) {

914 
fs_deviûs
 = 
	`fšd_fsid_w™h_m‘ad©a_uuid
(
disk_su³r
);

916 
fs_deviûs
 = 
	`fšd_fsid_»v”‹d_m‘ad©a
(
disk_su³r
);

917 ià(!
fs_deviûs
)

918 
fs_deviûs
 = 
	`fšd_fsid
(
disk_su³r
->
fsid
, 
NULL
);

922 ià(!
fs_deviûs
) {

923 
fs_deviûs
 = 
	`®loc_fs_deviûs
(
disk_su³r
->
fsid
,

924 
has_m‘ad©a_uuid
 ? 
disk_su³r
->
m‘ad©a_uuid
 : 
NULL
);

925 ià(
	`IS_ERR
(
fs_deviûs
))

926  
	`ERR_CAST
(
fs_deviûs
);

928 
fs_deviûs
->
fsid_chªge
 = 
fsid_chªge_š_´og»ss
;

930 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

931 
	`li¡_add
(&
fs_deviûs
->
fs_li¡
, &
fs_uuids
);

933 
deviû
 = 
NULL
;

935 
bŒfs_dev_lookup_¬gs
 
¬gs
 = {

936 .
devid
 = devid,

937 .
uuid
 = 
disk_su³r
->
dev_™em
.uuid,

940 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

941 
deviû
 = 
	`bŒfs_fšd_deviû
(
fs_deviûs
, &
¬gs
);

948 ià(
fs_deviûs
->
fsid_chªge
 &&

949 
found_Œªsid
 > 
fs_deviûs
->
Ï‹¡_g’”©iÚ
) {

950 
	`memıy
(
fs_deviûs
->
fsid
, 
disk_su³r
->fsid,

951 
BTRFS_FSID_SIZE
);

952 
	`memıy
(
fs_deviûs
->
m‘ad©a_uuid
,

953 
	`bŒfs_sb_fsid_±r
(
disk_su³r
), 
BTRFS_FSID_SIZE
);

954 
fs_deviûs
->
fsid_chªge
 = 
çl£
;

958 ià(!
deviû
) {

959 
nofs_æag
;

961 ià(
fs_deviûs
->
İ’ed
) {

962 
	`bŒfs_”r
(
NULL
,

964 
·th
, 
fs_deviûs
->
fsid
, 
cu¼’t
->
comm
,

965 
	`sk_pid_Ä
(
cu¼’t
));

966 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

967  
	`ERR_PTR
(-
EBUSY
);

970 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

971 
deviû
 = 
	`bŒfs_®loc_deviû
(
NULL
, &
devid
,

972 
disk_su³r
->
dev_™em
.
uuid
, 
·th
);

973 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

974 ià(
	`IS_ERR
(
deviû
)) {

975 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

977  
deviû
;

980 
deviû
->
devt
 = 
·th_devt
;

982 
	`li¡_add_rcu
(&
deviû
->
dev_li¡
, &
fs_deviûs
->
deviûs
);

983 
fs_deviûs
->
num_deviûs
++;

985 
deviû
->
fs_deviûs
 = fs_devices;

986 *
Ãw_deviû_added
 = 
Œue
;

988 ià(
disk_su³r
->
Ïb–
[0])

989 
	`´_šfo
(

991 
disk_su³r
->
Ïb–
, 
devid
, 
found_Œªsid
, 
·th
,

992 
cu¼’t
->
comm
, 
	`sk_pid_Ä
(current));

994 
	`´_šfo
(

996 
disk_su³r
->
fsid
, 
devid
, 
found_Œªsid
, 
·th
,

997 
cu¼’t
->
comm
, 
	`sk_pid_Ä
(current));

999 } ià(!
deviû
->
Çme
 || 
	`¡rcmp
(deviû->Çme->
¡r
, 
·th
)) {

1026 ià(!
fs_deviûs
->
İ’ed
 && 
found_Œªsid
 < 
deviû
->
g’”©iÚ
) {

1034 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

1035 
	`bŒfs_”r
(
NULL
,

1037 
·th
, 
found_Œªsid
, 
deviû
->
g’”©iÚ
);

1038  
	`ERR_PTR
(-
EEXIST
);

1050 ià(
deviû
->
bdev
) {

1051 ià(
deviû
->
devt
 !ğ
·th_devt
) {

1052 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

1053 
	`bŒfs_w¬n_š_rcu
(
NULL
,

1055 
·th
, 
devid
, 
found_Œªsid
,

1056 
cu¼’t
->
comm
,

1057 
	`sk_pid_Ä
(
cu¼’t
));

1058  
	`ERR_PTR
(-
EEXIST
);

1060 
	`bŒfs_šfo_š_rcu
(
NULL
,

1062 
devid
, 
	`bŒfs_dev_Çme
(
deviû
),

1063 
·th
, 
cu¼’t
->
comm
,

1064 
	`sk_pid_Ä
(
cu¼’t
));

1067 
Çme
 = 
	`rcu_¡ršg_¡rdup
(
·th
, 
GFP_NOFS
);

1068 ià(!
Çme
) {

1069 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

1070  
	`ERR_PTR
(-
ENOMEM
);

1072 
	`rcu_¡ršg_ä“
(
deviû
->
Çme
);

1073 
	`rcu_assign_poš‹r
(
deviû
->
Çme
,‚ame);

1074 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
, &
deviû
->
dev_¡©e
)) {

1075 
fs_deviûs
->
missšg_deviûs
--;

1076 
	`ş—r_b™
(
BTRFS_DEV_STATE_MISSING
, &
deviû
->
dev_¡©e
);

1078 
deviû
->
devt
 = 
·th_devt
;

1087 ià(!
fs_deviûs
->
İ’ed
) {

1088 
deviû
->
g’”©iÚ
 = 
found_Œªsid
;

1089 
fs_deviûs
->
Ï‹¡_g’”©iÚ
 = 
	`max_t
(
u64
, 
found_Œªsid
,

1090 
fs_deviûs
->
Ï‹¡_g’”©iÚ
);

1093 
fs_deviûs
->
tÙ®_deviûs
 = 
	`bŒfs_su³r_num_deviûs
(
disk_su³r
);

1095 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

1096  
deviû
;

1097 
	}
}

1099 
bŒfs_fs_deviûs
 *
	$şÚe_fs_deviûs
(
bŒfs_fs_deviûs
 *
Üig
)

1101 
bŒfs_fs_deviûs
 *
fs_deviûs
;

1102 
bŒfs_deviû
 *
deviû
;

1103 
bŒfs_deviû
 *
Üig_dev
;

1104 
»t
 = 0;

1106 
	`lockd•_as£¹_h–d
(&
uuid_mu‹x
);

1108 
fs_deviûs
 = 
	`®loc_fs_deviûs
(
Üig
->
fsid
, 
NULL
);

1109 ià(
	`IS_ERR
(
fs_deviûs
))

1110  
fs_deviûs
;

1112 
fs_deviûs
->
tÙ®_deviûs
 = 
Üig
->total_devices;

1114 
	`li¡_fÜ_—ch_’Œy
(
Üig_dev
, &
Üig
->
deviûs
, 
dev_li¡
) {

1115 cÚ¡ *
dev_·th
 = 
NULL
;

1121 ià(
Üig_dev
->
Çme
)

1122 
dev_·th
 = 
Üig_dev
->
Çme
->
¡r
;

1124 
deviû
 = 
	`bŒfs_®loc_deviû
(
NULL
, &
Üig_dev
->
devid
,

1125 
Üig_dev
->
uuid
, 
dev_·th
);

1126 ià(
	`IS_ERR
(
deviû
)) {

1127 
»t
 = 
	`PTR_ERR
(
deviû
);

1128 
”rÜ
;

1131 ià(
Üig_dev
->
zÚe_šfo
) {

1132 
bŒfs_zÚed_deviû_šfo
 *
zÚe_šfo
;

1134 
zÚe_šfo
 = 
	`bŒfs_şÚe_dev_zÚe_šfo
(
Üig_dev
);

1135 ià(!
zÚe_šfo
) {

1136 
	`bŒfs_ä“_deviû
(
deviû
);

1137 
»t
 = -
ENOMEM
;

1138 
”rÜ
;

1140 
deviû
->
zÚe_šfo
 = zone_info;

1143 
	`li¡_add
(&
deviû
->
dev_li¡
, &
fs_deviûs
->
deviûs
);

1144 
deviû
->
fs_deviûs
 = fs_devices;

1145 
fs_deviûs
->
num_deviûs
++;

1147  
fs_deviûs
;

1148 
”rÜ
:

1149 
	`ä“_fs_deviûs
(
fs_deviûs
);

1150  
	`ERR_PTR
(
»t
);

1151 
	}
}

1153 
	$__bŒfs_ä“_exŒa_devids
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

1154 
bŒfs_deviû
 **
Ï‹¡_dev
)

1156 
bŒfs_deviû
 *
deviû
, *
Ãxt
;

1159 
	`li¡_fÜ_—ch_’Œy_§ã
(
deviû
, 
Ãxt
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

1160 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
deviû
->
dev_¡©e
)) {

1161 ià(!
	`‹¡_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
,

1162 &
deviû
->
dev_¡©e
) &&

1163 !
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
,

1164 &
deviû
->
dev_¡©e
) &&

1165 (!*
Ï‹¡_dev
 ||

1166 
deviû
->
g’”©iÚ
 > (*
Ï‹¡_dev
)->generation)) {

1167 *
Ï‹¡_dev
 = 
deviû
;

1176 ià(
deviû
->
devid
 =ğ
BTRFS_DEV_REPLACE_DEVID
)

1179 ià(
deviû
->
bdev
) {

1180 
	`blkdev_put
(
deviû
->
bdev
, deviû->
hŞd”
);

1181 
deviû
->
bdev
 = 
NULL
;

1182 
fs_deviûs
->
İ’_deviûs
--;

1184 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
)) {

1185 
	`li¡_d–_š™
(&
deviû
->
dev_®loc_li¡
);

1186 
	`ş—r_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
);

1187 
fs_deviûs
->
rw_deviûs
--;

1189 
	`li¡_d–_š™
(&
deviû
->
dev_li¡
);

1190 
fs_deviûs
->
num_deviûs
--;

1191 
	`bŒfs_ä“_deviû
(
deviû
);

1194 
	}
}

1200 
	$bŒfs_ä“_exŒa_devids
(
bŒfs_fs_deviûs
 *
fs_deviûs
)

1202 
bŒfs_deviû
 *
Ï‹¡_dev
 = 
NULL
;

1203 
bŒfs_fs_deviûs
 *
£ed_dev
;

1205 
	`mu‹x_lock
(&
uuid_mu‹x
);

1206 
	`__bŒfs_ä“_exŒa_devids
(
fs_deviûs
, &
Ï‹¡_dev
);

1208 
	`li¡_fÜ_—ch_’Œy
(
£ed_dev
, &
fs_deviûs
->
£ed_li¡
, seed_list)

1209 
	`__bŒfs_ä“_exŒa_devids
(
£ed_dev
, &
Ï‹¡_dev
);

1211 
fs_deviûs
->
Ï‹¡_dev
 =†atest_dev;

1213 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

1214 
	}
}

1216 
	$bŒfs_şo£_bdev
(
bŒfs_deviû
 *
deviû
)

1218 ià(!
deviû
->
bdev
)

1221 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
)) {

1222 
	`sync_blockdev
(
deviû
->
bdev
);

1223 
	`šv®id©e_bdev
(
deviû
->
bdev
);

1226 
	`blkdev_put
(
deviû
->
bdev
, deviû->
hŞd”
);

1227 
	}
}

1229 
	$bŒfs_şo£_Úe_deviû
(
bŒfs_deviû
 *
deviû
)

1231 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
deviû
->fs_devices;

1233 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
) &&

1234 
deviû
->
devid
 !ğ
BTRFS_DEV_REPLACE_DEVID
) {

1235 
	`li¡_d–_š™
(&
deviû
->
dev_®loc_li¡
);

1236 
fs_deviûs
->
rw_deviûs
--;

1239 ià(
deviû
->
devid
 =ğ
BTRFS_DEV_REPLACE_DEVID
)

1240 
	`ş—r_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
);

1242 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
, &
deviû
->
dev_¡©e
)) {

1243 
	`ş—r_b™
(
BTRFS_DEV_STATE_MISSING
, &
deviû
->
dev_¡©e
);

1244 
fs_deviûs
->
missšg_deviûs
--;

1247 
	`bŒfs_şo£_bdev
(
deviû
);

1248 ià(
deviû
->
bdev
) {

1249 
fs_deviûs
->
İ’_deviûs
--;

1250 
deviû
->
bdev
 = 
NULL
;

1252 
	`ş—r_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
);

1253 
	`bŒfs_de¡roy_dev_zÚe_šfo
(
deviû
);

1255 
deviû
->
fs_šfo
 = 
NULL
;

1256 
	`©omic_£t
(&
deviû
->
dev_¡©s_cút
, 0);

1257 
	`ex‹Á_io_Œ“_»Ëa£
(&
deviû
->
®loc_¡©e
);

1270 
deviû
->
Ï¡_æush_”rÜ
 = 0;

1273 
	`WARN_ON
(
	`‹¡_b™
(
BTRFS_DEV_STATE_FLUSH_SENT
, &
deviû
->
dev_¡©e
));

1274 
	`WARN_ON
(
	`‹¡_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
));

1275 
	`WARN_ON
(!
	`li¡_em±y
(&
deviû
->
dev_®loc_li¡
));

1276 
	`WARN_ON
(!
	`li¡_em±y
(&
deviû
->
po¡_comm™_li¡
));

1277 
	}
}

1279 
	$şo£_fs_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
)

1281 
bŒfs_deviû
 *
deviû
, *
tmp
;

1283 
	`lockd•_as£¹_h–d
(&
uuid_mu‹x
);

1285 ià(--
fs_deviûs
->
İ’ed
 > 0)

1288 
	`li¡_fÜ_—ch_’Œy_§ã
(
deviû
, 
tmp
, &
fs_deviûs
->
deviûs
, 
dev_li¡
)

1289 
	`bŒfs_şo£_Úe_deviû
(
deviû
);

1291 
	`WARN_ON
(
fs_deviûs
->
İ’_deviûs
);

1292 
	`WARN_ON
(
fs_deviûs
->
rw_deviûs
);

1293 
fs_deviûs
->
İ’ed
 = 0;

1294 
fs_deviûs
->
£edšg
 = 
çl£
;

1295 
fs_deviûs
->
fs_šfo
 = 
NULL
;

1296 
	}
}

1298 
	$bŒfs_şo£_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
)

1300 
	`LIST_HEAD
(
li¡
);

1301 
bŒfs_fs_deviûs
 *
tmp
;

1303 
	`mu‹x_lock
(&
uuid_mu‹x
);

1304 
	`şo£_fs_deviûs
(
fs_deviûs
);

1305 ià(!
fs_deviûs
->
İ’ed
) {

1306 
	`li¡_¥liû_š™
(&
fs_deviûs
->
£ed_li¡
, &
li¡
);

1314 ià(
fs_deviûs
->
num_deviûs
 == 1) {

1315 
	`li¡_d–
(&
fs_deviûs
->
fs_li¡
);

1316 
	`ä“_fs_deviûs
(
fs_deviûs
);

1321 
	`li¡_fÜ_—ch_’Œy_§ã
(
fs_deviûs
, 
tmp
, &
li¡
, 
£ed_li¡
) {

1322 
	`şo£_fs_deviûs
(
fs_deviûs
);

1323 
	`li¡_d–
(&
fs_deviûs
->
£ed_li¡
);

1324 
	`ä“_fs_deviûs
(
fs_deviûs
);

1326 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

1327 
	}
}

1329 
	$İ’_fs_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

1330 
blk_mode_t
 
æags
, *
hŞd”
)

1332 
bŒfs_deviû
 *
deviû
;

1333 
bŒfs_deviû
 *
Ï‹¡_dev
 = 
NULL
;

1334 
bŒfs_deviû
 *
tmp_deviû
;

1336 
	`li¡_fÜ_—ch_’Œy_§ã
(
deviû
, 
tmp_deviû
, &
fs_deviûs
->
deviûs
,

1337 
dev_li¡
) {

1338 
»t
;

1340 
»t
 = 
	`bŒfs_İ’_Úe_deviû
(
fs_deviûs
, 
deviû
, 
æags
, 
hŞd”
);

1341 ià(
»t
 == 0 &&

1342 (!
Ï‹¡_dev
 || 
deviû
->
g’”©iÚ
 >†atest_dev->generation)) {

1343 
Ï‹¡_dev
 = 
deviû
;

1344 } ià(
»t
 =ğ-
ENODATA
) {

1345 
fs_deviûs
->
num_deviûs
--;

1346 
	`li¡_d–
(&
deviû
->
dev_li¡
);

1347 
	`bŒfs_ä“_deviû
(
deviû
);

1350 ià(
fs_deviûs
->
İ’_deviûs
 == 0)

1351  -
EINVAL
;

1353 
fs_deviûs
->
İ’ed
 = 1;

1354 
fs_deviûs
->
Ï‹¡_dev
 =†atest_dev;

1355 
fs_deviûs
->
tÙ®_rw_by‹s
 = 0;

1356 
fs_deviûs
->
chunk_®loc_pŞicy
 = 
BTRFS_CHUNK_ALLOC_REGULAR
;

1357 
fs_deviûs
->
»ad_pŞicy
 = 
BTRFS_READ_POLICY_PID
;

1360 
	}
}

1363 
	$İ’_fs_deviûs_·¹™iÚ
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

1364 
blk_mode_t
 
æags
, *
hŞd”
, 
·¹™iÚ_Üd”
)

1366 
bŒfs_deviû
 *
deviû
;

1367 
bŒfs_deviû
 *
Ï‹¡_dev
 = 
NULL
;

1368 
bŒfs_deviû
 *
tmp_deviû
;

1370 
	`li¡_fÜ_—ch_’Œy_§ã
(
deviû
, 
tmp_deviû
, &
fs_deviûs
->
deviûs
,

1371 
dev_li¡
) {

1372 
»t
;

1374 
»t
 = 
	`bŒfs_İ’_Úe_deviû_·¹™iÚ
(
fs_deviûs
, 
deviû
, 
æags
, 
hŞd”
, 
·¹™iÚ_Üd”
);

1375 ià(
»t
 == 0 &&

1376 (!
Ï‹¡_dev
 || 
deviû
->
g’”©iÚ
 >†atest_dev->generation)) {

1377 
Ï‹¡_dev
 = 
deviû
;

1378 } ià(
»t
 =ğ-
ENODATA
) {

1379 
fs_deviûs
->
num_deviûs
--;

1380 
	`li¡_d–
(&
deviû
->
dev_li¡
);

1381 
	`bŒfs_ä“_deviû
(
deviû
);

1384 ià(
fs_deviûs
->
İ’_deviûs
 == 0)

1385  -
EINVAL
;

1387 
fs_deviûs
->
İ’ed
 = 1;

1388 
fs_deviûs
->
Ï‹¡_dev
 =†atest_dev;

1389 
fs_deviûs
->
tÙ®_rw_by‹s
 = 0;

1390 
fs_deviûs
->
chunk_®loc_pŞicy
 = 
BTRFS_CHUNK_ALLOC_REGULAR
;

1391 
fs_deviûs
->
»ad_pŞicy
 = 
BTRFS_READ_POLICY_PID
;

1394 
	}
}

1396 
	$devid_cmp
(*
´iv
, cÚ¡ 
li¡_h—d
 *
a
,

1397 cÚ¡ 
li¡_h—d
 *
b
)

1399 cÚ¡ 
bŒfs_deviû
 *
dev1
, *
dev2
;

1401 
dev1
 = 
	`li¡_’Œy
(
a
, 
bŒfs_deviû
, 
dev_li¡
);

1402 
dev2
 = 
	`li¡_’Œy
(
b
, 
bŒfs_deviû
, 
dev_li¡
);

1404 ià(
dev1
->
devid
 < 
dev2
->devid)

1406 ià(
dev1
->
devid
 > 
dev2
->devid)

1409 
	}
}

1411 
	$bŒfs_İ’_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

1412 
blk_mode_t
 
æags
, *
hŞd”
)

1414 
»t
;

1416 
	`lockd•_as£¹_h–d
(&
uuid_mu‹x
);

1425 ià(
fs_deviûs
->
İ’ed
) {

1426 
fs_deviûs
->
İ’ed
++;

1427 
»t
 = 0;

1429 
	`li¡_sÜt
(
NULL
, &
fs_deviûs
->
deviûs
, 
devid_cmp
);

1430 
»t
 = 
	`İ’_fs_deviûs
(
fs_deviûs
, 
æags
, 
hŞd”
);

1433  
»t
;

1434 
	}
}

1437 
	$bŒfs_İ’_deviûs_·¹™iÚ
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

1438 
blk_mode_t
 
æags
, *
hŞd”
, 
·¹™iÚ_Üd”
)

1440 
»t
;

1442 
	`lockd•_as£¹_h–d
(&
uuid_mu‹x
);

1451 ià(
fs_deviûs
->
İ’ed
) {

1452 
fs_deviûs
->
İ’ed
++;

1453 
»t
 = 0;

1455 
	`li¡_sÜt
(
NULL
, &
fs_deviûs
->
deviûs
, 
devid_cmp
);

1456 
»t
 = 
	`İ’_fs_deviûs_·¹™iÚ
(
fs_deviûs
, 
æags
, 
hŞd”
, 
·¹™iÚ_Üd”
);

1459  
»t
;

1460 
	}
}

1462 
	$bŒfs_»Ëa£_disk_su³r
(
bŒfs_su³r_block
 *
su³r
)

1464 
·ge
 *·gğ
	`vœt_to_·ge
(
su³r
);

1466 
	`put_·ge
(
·ge
);

1467 
	}
}

1469 
bŒfs_su³r_block
 *
	$bŒfs_»ad_disk_su³r
(
block_deviû
 *
bdev
,

1470 
u64
 
by‹Ä
, u64 
by‹Ä_Üig
)

1472 
bŒfs_su³r_block
 *
disk_su³r
;

1473 
·ge
 *page;

1474 *
p
;

1475 
pgoff_t
 
šdex
;

1478 ià(
by‹Ä
 + 
PAGE_SIZE
 >ğ
	`bdev_Ä_by‹s
(
bdev
))

1479  
	`ERR_PTR
(-
EINVAL
);

1482 ià((*
disk_su³r
è> 
PAGE_SIZE
)

1483  
	`ERR_PTR
(-
EINVAL
);

1486 
šdex
 = 
by‹Ä
 >> 
PAGE_SHIFT
;

1487 ià((
by‹Ä
 + (*
disk_su³r
è- 1è>> 
PAGE_SHIFT
 !ğ
šdex
)

1488  
	`ERR_PTR
(-
EINVAL
);

1491 
·ge
 = 
	`»ad_ÿche_·ge_gå
(
bdev
->
bd_šode
->
i_m­pšg
, 
šdex
, 
GFP_KERNEL
);

1493 ià(
	`IS_ERR
(
·ge
))

1494  
	`ERR_CAST
(
·ge
);

1496 
p
 = 
	`·ge_add»ss
(
·ge
);

1499 
disk_su³r
 = 
p
 + 
	`off£t_š_·ge
(
by‹Ä
);

1501 ià(
	`bŒfs_su³r_by‹Ä
(
disk_su³r
è!ğ
by‹Ä_Üig
 ||

1502 
	`bŒfs_su³r_magic
(
disk_su³r
è!ğ
BTRFS_MAGIC
) {

1503 
	`bŒfs_»Ëa£_disk_su³r
(
p
);

1504  
	`ERR_PTR
(-
EINVAL
);

1507 ià(
disk_su³r
->
Ïb–
[0] && disk_su³r->Ïb–[
BTRFS_LABEL_SIZE
 - 1])

1508 
disk_su³r
->
Ïb–
[
BTRFS_LABEL_SIZE
 - 1] = 0;

1510  
disk_su³r
;

1511 
	}
}

1513 
	$bŒfs_fÜg‘_deviûs
(
dev_t
 
devt
)

1515 
»t
;

1517 
	`mu‹x_lock
(&
uuid_mu‹x
);

1518 
»t
 = 
	`bŒfs_ä“_¡®e_deviûs
(
devt
, 
NULL
);

1519 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

1521  
»t
;

1522 
	}
}

1529 
bŒfs_deviû
 *
	$bŒfs_sÿn_Úe_deviû
(cÚ¡ *
·th
, 
blk_mode_t
 
æags
)

1531 
bŒfs_su³r_block
 *
disk_su³r
;

1532 
boŞ
 
Ãw_deviû_added
 = 
çl£
;

1533 
bŒfs_deviû
 *
deviû
 = 
NULL
;

1534 
block_deviû
 *
bdev
;

1535 
u64
 
by‹Ä
, 
by‹Ä_Üig
;

1536 
»t
;

1538 
	`lockd•_as£¹_h–d
(&
uuid_mu‹x
);

1557 
bdev
 = 
	`blkdev_g‘_by_·th
(
·th
, 
æags
, 
NULL
, NULL);

1558 ià(
	`IS_ERR
(
bdev
))

1559  
	`ERR_CAST
(
bdev
);

1561 
by‹Ä_Üig
 = 
	`bŒfs_sb_off£t
(0);

1562 
»t
 = 
	`bŒfs_sb_log_loÿtiÚ_bdev
(
bdev
, 0, 
READ
, &
by‹Ä
);

1563 ià(
»t
) {

1564 
deviû
 = 
	`ERR_PTR
(
»t
);

1565 
”rÜ_bdev_put
;

1568 
disk_su³r
 = 
	`bŒfs_»ad_disk_su³r
(
bdev
, 
by‹Ä
, 
by‹Ä_Üig
);

1569 ià(
	`IS_ERR
(
disk_su³r
)) {

1570 
deviû
 = 
	`ERR_CAST
(
disk_su³r
);

1571 
”rÜ_bdev_put
;

1574 
deviû
 = 
	`deviû_li¡_add
(
·th
, 
disk_su³r
, &
Ãw_deviû_added
);

1575 ià(!
	`IS_ERR
(
deviû
è&& 
Ãw_deviû_added
)

1576 
	`bŒfs_ä“_¡®e_deviûs
(
deviû
->
devt
, device);

1578 
	`bŒfs_»Ëa£_disk_su³r
(
disk_su³r
);

1580 
”rÜ_bdev_put
:

1581 
	`blkdev_put
(
bdev
, 
NULL
);

1583  
deviû
;

1584 
	}
}

1587 
bŒfs_deviû
 *
	$bŒfs_sÿn_Úe_deviû_·¹™iÚ
(cÚ¡ *
·th
, 
blk_mode_t
 
æags
, 
·¹™iÚ_Üd”
)

1589 
bŒfs_su³r_block
 *
disk_su³r
;

1590 
boŞ
 
Ãw_deviû_added
 = 
çl£
;

1591 
bŒfs_deviû
 *
deviû
 = 
NULL
;

1592 
block_deviû
 *
bdev
;

1593 
u64
 
by‹Ä
, 
by‹Ä_Üig
;

1594 
»t
;

1596 
	`lockd•_as£¹_h–d
(&
uuid_mu‹x
);

1615 
bdev
 = 
	`blkdev_g‘_by_·th
(
·th
, 
æags
, 
NULL
, NULL);

1616 ià(
	`IS_ERR
(
bdev
))

1617  
	`ERR_CAST
(
bdev
);

1618 
u64
 
sb_off£t
 = 
·¹™iÚ_Üd”
 * 
BTRFS_SUPER_INFO_SIZE
;

1619 
by‹Ä_Üig
 = 
	`bŒfs_sb_off£t_·¹™iÚ
(0, 
sb_off£t
);

1620 
»t
 = 
	`bŒfs_sb_log_loÿtiÚ_bdev_·¹™iÚ
(
bdev
, 0, 
READ
, &
by‹Ä
, 
sb_off£t
);

1621 ià(
»t
) {

1622 
deviû
 = 
	`ERR_PTR
(
»t
);

1623 
”rÜ_bdev_put
;

1633 
disk_su³r
 = 
	`bŒfs_»ad_disk_su³r
(
bdev
, 
by‹Ä
, 
by‹Ä_Üig
);

1634 ià(
	`IS_ERR
(
disk_su³r
)) {

1635 
deviû
 = 
	`ERR_CAST
(
disk_su³r
);

1636 
”rÜ_bdev_put
;

1647 
deviû
 = 
	`deviû_li¡_add
(
·th
, 
disk_su³r
, &
Ãw_deviû_added
);

1648 ià(!
	`IS_ERR
(
deviû
è&& 
Ãw_deviû_added
)

1649 
	`bŒfs_ä“_¡®e_deviûs
(
deviû
->
devt
, device);

1651 
	`bŒfs_»Ëa£_disk_su³r
(
disk_su³r
);

1653 
”rÜ_bdev_put
:

1654 
	`blkdev_put
(
bdev
, 
NULL
);

1656  
deviû
;

1657 
	}
}

1663 
boŞ
 
	$cÚšs_³ndšg_ex‹Á
(
bŒfs_deviû
 *
deviû
, 
u64
 *
¡¬t
,

1664 
u64
 
Ën
)

1666 
u64
 
physiÿl_¡¬t
, 
physiÿl_’d
;

1668 
	`lockd•_as£¹_h–d
(&
deviû
->
fs_šfo
->
chunk_mu‹x
);

1670 ià(
	`fšd_fœ¡_ex‹Á_b™
(&
deviû
->
®loc_¡©e
, *
¡¬t
,

1671 &
physiÿl_¡¬t
, &
physiÿl_’d
,

1672 
CHUNK_ALLOCATED
, 
NULL
)) {

1674 ià(
	`š_¿nge
(
physiÿl_¡¬t
, *
¡¬t
, 
Ën
) ||

1675 
	`š_¿nge
(*
¡¬t
, 
physiÿl_¡¬t
,

1676 
physiÿl_’d
 - 
physiÿl_¡¬t
)) {

1677 *
¡¬t
 = 
physiÿl_’d
 + 1;

1678  
Œue
;

1681  
çl£
;

1682 
	}
}

1684 
u64
 
	$dev_ex‹Á_£¬ch_¡¬t
(
bŒfs_deviû
 *
deviû
)

1686 
deviû
->
fs_deviûs
->
chunk_®loc_pŞicy
) {

1687 
BTRFS_CHUNK_ALLOC_REGULAR
:

1688  
BTRFS_DEVICE_RANGE_RESERVED
;

1689 
BTRFS_CHUNK_ALLOC_ZONED
:

1697 
	`BUG
();

1699 
	}
}

1701 
boŞ
 
	$dev_ex‹Á_hŞe_check_zÚed
(
bŒfs_deviû
 *
deviû
,

1702 
u64
 *
hŞe_¡¬t
, u64 *
hŞe_size
,

1703 
u64
 
num_by‹s
)

1705 
u64
 
zÚe_size
 = 
deviû
->
zÚe_šfo
->zone_size;

1706 
u64
 
pos
;

1707 
»t
;

1708 
boŞ
 
chªged
 = 
çl£
;

1710 
	`ASSERT
(
	`IS_ALIGNED
(*
hŞe_¡¬t
, 
zÚe_size
));

1712 *
hŞe_size
 > 0) {

1713 
pos
 = 
	`bŒfs_fšd_®loÿbË_zÚes
(
deviû
, *
hŞe_¡¬t
,

1714 *
hŞe_¡¬t
 + *
hŞe_size
,

1715 
num_by‹s
);

1716 ià(
pos
 !ğ*
hŞe_¡¬t
) {

1717 *
hŞe_size
 = *
hŞe_¡¬t
 + *hŞe_siz- 
pos
;

1718 *
hŞe_¡¬t
 = 
pos
;

1719 
chªged
 = 
Œue
;

1720 ià(*
hŞe_size
 < 
num_by‹s
)

1724 
»t
 = 
	`bŒfs_’su»_em±y_zÚes
(
deviû
, 
pos
, 
num_by‹s
);

1727 ià(!
»t
)

1728  
chªged
;

1731 ià(
»t
 =ğ-
ERANGE
) {

1732 *
hŞe_¡¬t
 +ğ*
hŞe_size
;

1733 *
hŞe_size
 = 0;

1734  
Œue
;

1737 *
hŞe_¡¬t
 +ğ
zÚe_size
;

1738 *
hŞe_size
 -ğ
zÚe_size
;

1739 
chªged
 = 
Œue
;

1742  
chªged
;

1743 
	}
}

1756 
boŞ
 
	$dev_ex‹Á_hŞe_check
(
bŒfs_deviû
 *
deviû
, 
u64
 *
hŞe_¡¬t
,

1757 
u64
 *
hŞe_size
, u64 
num_by‹s
)

1759 
boŞ
 
chªged
 = 
çl£
;

1760 
u64
 
hŞe_’d
 = *
hŞe_¡¬t
 + *
hŞe_size
;

1767 ià(
	`cÚšs_³ndšg_ex‹Á
(
deviû
, 
hŞe_¡¬t
, *
hŞe_size
)) {

1768 ià(
hŞe_’d
 >ğ*
hŞe_¡¬t
)

1769 *
hŞe_size
 = 
hŞe_’d
 - *
hŞe_¡¬t
;

1771 *
hŞe_size
 = 0;

1772 
chªged
 = 
Œue
;

1775 
deviû
->
fs_deviûs
->
chunk_®loc_pŞicy
) {

1776 
BTRFS_CHUNK_ALLOC_REGULAR
:

1779 
BTRFS_CHUNK_ALLOC_ZONED
:

1780 ià(
	`dev_ex‹Á_hŞe_check_zÚed
(
deviû
, 
hŞe_¡¬t
,

1781 
hŞe_size
, 
num_by‹s
)) {

1782 
chªged
 = 
Œue
;

1791 
	`BUG
();

1797  
chªged
;

1798 
	}
}

1827 
	$fšd_ä“_dev_ex‹Á
(
bŒfs_deviû
 *
deviû
, 
u64
 
num_by‹s
,

1828 
u64
 *
¡¬t
, u64 *
Ën
)

1830 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

1831 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

1832 
bŒfs_key
 
key
;

1833 
bŒfs_dev_ex‹Á
 *
dev_ex‹Á
;

1834 
bŒfs_·th
 *
·th
;

1835 
u64
 
£¬ch_¡¬t
;

1836 
u64
 
hŞe_size
;

1837 
u64
 
max_hŞe_¡¬t
;

1838 
u64
 
max_hŞe_size
 = 0;

1839 
u64
 
ex‹Á_’d
;

1840 
u64
 
£¬ch_’d
 = 
deviû
->
tÙ®_by‹s
;

1841 
»t
;

1842 
¦Ù
;

1843 
ex‹Á_bufãr
 *
l
;

1845 
£¬ch_¡¬t
 = 
	`dev_ex‹Á_£¬ch_¡¬t
(
deviû
);

1846 
max_hŞe_¡¬t
 = 
£¬ch_¡¬t
;

1848 
	`WARN_ON
(
deviû
->
zÚe_šfo
 &&

1849 !
	`IS_ALIGNED
(
num_by‹s
, 
deviû
->
zÚe_šfo
->
zÚe_size
));

1851 
·th
 = 
	`bŒfs_®loc_·th
();

1852 ià(!
·th
) {

1853 
»t
 = -
ENOMEM
;

1854 
out
;

1856 
agaš
:

1857 ià(
£¬ch_¡¬t
 >ğ
£¬ch_’d
 ||

1858 
	`‹¡_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
)) {

1859 
»t
 = -
ENOSPC
;

1860 
out
;

1863 
·th
->
»ada
 = 
READA_FORWARD
;

1864 
·th
->
£¬ch_comm™_roÙ
 = 1;

1865 
·th
->
sk_lockšg
 = 1;

1867 
key
.
objeùid
 = 
deviû
->
devid
;

1868 
key
.
off£t
 = 
£¬ch_¡¬t
;

1869 
key
.
ty³
 = 
BTRFS_DEV_EXTENT_KEY
;

1871 
»t
 = 
	`bŒfs_£¬ch_backw¬ds
(
roÙ
, &
key
, 
·th
);

1872 ià(
»t
 < 0)

1873 
out
;

1875 
£¬ch_¡¬t
 < 
£¬ch_’d
) {

1876 
l
 = 
·th
->
nodes
[0];

1877 
¦Ù
 = 
·th
->
¦Ùs
[0];

1878 ià(
¦Ù
 >ğ
	`bŒfs_h—d”_Ä™ems
(
l
)) {

1879 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

1880 ià(
»t
 == 0)

1882 ià(
»t
 < 0)

1883 
out
;

1887 
	`bŒfs_™em_key_to_ıu
(
l
, &
key
, 
¦Ù
);

1889 ià(
key
.
objeùid
 < 
deviû
->
devid
)

1890 
Ãxt
;

1892 ià(
key
.
objeùid
 > 
deviû
->
devid
)

1895 ià(
key
.
ty³
 !ğ
BTRFS_DEV_EXTENT_KEY
)

1896 
Ãxt
;

1898 ià(
key
.
off£t
 > 
£¬ch_’d
)

1901 ià(
key
.
off£t
 > 
£¬ch_¡¬t
) {

1902 
hŞe_size
 = 
key
.
off£t
 - 
£¬ch_¡¬t
;

1903 
	`dev_ex‹Á_hŞe_check
(
deviû
, &
£¬ch_¡¬t
, &
hŞe_size
,

1904 
num_by‹s
);

1906 ià(
hŞe_size
 > 
max_hŞe_size
) {

1907 
max_hŞe_¡¬t
 = 
£¬ch_¡¬t
;

1908 
max_hŞe_size
 = 
hŞe_size
;

1920 ià(
hŞe_size
 >ğ
num_by‹s
) {

1921 
»t
 = 0;

1922 
out
;

1926 
dev_ex‹Á
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
, 
bŒfs_dev_ex‹Á
);

1927 
ex‹Á_’d
 = 
key
.
off£t
 + 
	`bŒfs_dev_ex‹Á_Ëngth
(
l
,

1928 
dev_ex‹Á
);

1929 ià(
ex‹Á_’d
 > 
£¬ch_¡¬t
)

1930 
£¬ch_¡¬t
 = 
ex‹Á_’d
;

1931 
Ãxt
:

1932 
·th
->
¦Ùs
[0]++;

1933 
	`cÚd_»sched
();

1941 ià(
£¬ch_’d
 > 
£¬ch_¡¬t
) {

1942 
hŞe_size
 = 
£¬ch_’d
 - 
£¬ch_¡¬t
;

1943 ià(
	`dev_ex‹Á_hŞe_check
(
deviû
, &
£¬ch_¡¬t
, &
hŞe_size
,

1944 
num_by‹s
)) {

1945 
	`bŒfs_»Ëa£_·th
(
·th
);

1946 
agaš
;

1949 ià(
hŞe_size
 > 
max_hŞe_size
) {

1950 
max_hŞe_¡¬t
 = 
£¬ch_¡¬t
;

1951 
max_hŞe_size
 = 
hŞe_size
;

1956 ià(
max_hŞe_size
 < 
num_by‹s
)

1957 
»t
 = -
ENOSPC
;

1959 
»t
 = 0;

1961 
	`ASSERT
(
max_hŞe_¡¬t
 + 
max_hŞe_size
 <ğ
£¬ch_’d
);

1962 
out
:

1963 
	`bŒfs_ä“_·th
(
·th
);

1964 *
¡¬t
 = 
max_hŞe_¡¬t
;

1965 ià(
Ën
)

1966 *
Ën
 = 
max_hŞe_size
;

1967  
»t
;

1968 
	}
}

1970 
	$bŒfs_ä“_dev_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1971 
bŒfs_deviû
 *
deviû
,

1972 
u64
 
¡¬t
, u64 *
dev_ex‹Á_Ën
)

1974 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

1975 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

1976 
»t
;

1977 
bŒfs_·th
 *
·th
;

1978 
bŒfs_key
 
key
;

1979 
bŒfs_key
 
found_key
;

1980 
ex‹Á_bufãr
 *
Ëaf
 = 
NULL
;

1981 
bŒfs_dev_ex‹Á
 *
ex‹Á
 = 
NULL
;

1983 
·th
 = 
	`bŒfs_®loc_·th
();

1984 ià(!
·th
)

1985  -
ENOMEM
;

1987 
key
.
objeùid
 = 
deviû
->
devid
;

1988 
key
.
off£t
 = 
¡¬t
;

1989 
key
.
ty³
 = 
BTRFS_DEV_EXTENT_KEY
;

1990 
agaš
:

1991 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1992 ià(
»t
 > 0) {

1993 
»t
 = 
	`bŒfs_´evious_™em
(
roÙ
, 
·th
, 
key
.
objeùid
,

1994 
BTRFS_DEV_EXTENT_KEY
);

1995 ià(
»t
)

1996 
out
;

1997 
Ëaf
 = 
·th
->
nodes
[0];

1998 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

1999 
ex‹Á
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

2000 
bŒfs_dev_ex‹Á
);

2001 
	`BUG_ON
(
found_key
.
off£t
 > 
¡¬t
 || found_key.offset +

2002 
	`bŒfs_dev_ex‹Á_Ëngth
(
Ëaf
, 
ex‹Á
è< 
¡¬t
);

2003 
key
 = 
found_key
;

2004 
	`bŒfs_»Ëa£_·th
(
·th
);

2005 
agaš
;

2006 } ià(
»t
 == 0) {

2007 
Ëaf
 = 
·th
->
nodes
[0];

2008 
ex‹Á
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

2009 
bŒfs_dev_ex‹Á
);

2011 
out
;

2014 *
dev_ex‹Á_Ën
 = 
	`bŒfs_dev_ex‹Á_Ëngth
(
Ëaf
, 
ex‹Á
);

2016 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

2017 ià(
»t
 == 0)

2018 
	`£t_b™
(
BTRFS_TRANS_HAVE_FREE_BGS
, &
Œªs
->
Œª§ùiÚ
->
æags
);

2019 
out
:

2020 
	`bŒfs_ä“_·th
(
·th
);

2021  
»t
;

2022 
	}
}

2024 
u64
 
	$fšd_Ãxt_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
)

2026 
ex‹Á_m­_Œ“
 *
em_Œ“
;

2027 
ex‹Á_m­
 *
em
;

2028 
rb_node
 *
n
;

2029 
u64
 
»t
 = 0;

2031 
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

2032 
	`»ad_lock
(&
em_Œ“
->
lock
);

2033 
n
 = 
	`rb_Ï¡
(&
em_Œ“
->
m­
.
rb_roÙ
);

2034 ià(
n
) {

2035 
em
 = 
	`rb_’Œy
(
n
, 
ex‹Á_m­
, 
rb_node
);

2036 
»t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

2038 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

2040  
»t
;

2041 
	}
}

2043 
nošlše
 
	$fšd_Ãxt_devid
(
bŒfs_fs_šfo
 *
fs_šfo
,

2044 
u64
 *
devid_»t
)

2046 
»t
;

2047 
bŒfs_key
 
key
;

2048 
bŒfs_key
 
found_key
;

2049 
bŒfs_·th
 *
·th
;

2051 
·th
 = 
	`bŒfs_®loc_·th
();

2052 ià(!
·th
)

2053  -
ENOMEM
;

2055 
key
.
objeùid
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

2056 
key
.
ty³
 = 
BTRFS_DEV_ITEM_KEY
;

2057 
key
.
off£t
 = (
u64
)-1;

2059 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_šfo
->
chunk_roÙ
, &
key
, 
·th
, 0, 0);

2060 ià(
»t
 < 0)

2061 
”rÜ
;

2063 ià(
»t
 == 0) {

2065 
	`bŒfs_”r
(
fs_šfo
, "corrupted chunkree devid -1 matched");

2066 
»t
 = -
EUCLEAN
;

2067 
”rÜ
;

2070 
»t
 = 
	`bŒfs_´evious_™em
(
fs_šfo
->
chunk_roÙ
, 
·th
,

2071 
BTRFS_DEV_ITEMS_OBJECTID
,

2072 
BTRFS_DEV_ITEM_KEY
);

2073 ià(
»t
) {

2074 *
devid_»t
 = 1;

2076 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
found_key
,

2077 
·th
->
¦Ùs
[0]);

2078 *
devid_»t
 = 
found_key
.
off£t
 + 1;

2080 
»t
 = 0;

2081 
”rÜ
:

2082 
	`bŒfs_ä“_·th
(
·th
);

2083  
»t
;

2084 
	}
}

2090 
	$bŒfs_add_dev_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2091 
bŒfs_deviû
 *
deviû
)

2093 
»t
;

2094 
bŒfs_·th
 *
·th
;

2095 
bŒfs_dev_™em
 *
dev_™em
;

2096 
ex‹Á_bufãr
 *
Ëaf
;

2097 
bŒfs_key
 
key
;

2098 
±r
;

2100 
·th
 = 
	`bŒfs_®loc_·th
();

2101 ià(!
·th
)

2102  -
ENOMEM
;

2104 
key
.
objeùid
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

2105 
key
.
ty³
 = 
BTRFS_DEV_ITEM_KEY
;

2106 
key
.
off£t
 = 
deviû
->
devid
;

2108 
	`bŒfs_»£rve_chunk_m‘ad©a
(
Œªs
, 
Œue
);

2109 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
,¿ns->
fs_šfo
->
chunk_roÙ
, 
·th
,

2110 &
key
, (*
dev_™em
));

2111 
	`bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
Œªs
);

2112 ià(
»t
)

2113 
out
;

2115 
Ëaf
 = 
·th
->
nodes
[0];

2116 
dev_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_dev_™em
);

2118 
	`bŒfs_£t_deviû_id
(
Ëaf
, 
dev_™em
, 
deviû
->
devid
);

2119 
	`bŒfs_£t_deviû_g’”©iÚ
(
Ëaf
, 
dev_™em
, 0);

2120 
	`bŒfs_£t_deviû_ty³
(
Ëaf
, 
dev_™em
, 
deviû
->
ty³
);

2121 
	`bŒfs_£t_deviû_io_®ign
(
Ëaf
, 
dev_™em
, 
deviû
->
io_®ign
);

2122 
	`bŒfs_£t_deviû_io_width
(
Ëaf
, 
dev_™em
, 
deviû
->
io_width
);

2123 
	`bŒfs_£t_deviû_£ùÜ_size
(
Ëaf
, 
dev_™em
, 
deviû
->
£ùÜ_size
);

2124 
	`bŒfs_£t_deviû_tÙ®_by‹s
(
Ëaf
, 
dev_™em
,

2125 
	`bŒfs_deviû_g‘_disk_tÙ®_by‹s
(
deviû
));

2126 
	`bŒfs_£t_deviû_by‹s_u£d
(
Ëaf
, 
dev_™em
,

2127 
	`bŒfs_deviû_g‘_by‹s_u£d
(
deviû
));

2128 
	`bŒfs_£t_deviû_group
(
Ëaf
, 
dev_™em
, 0);

2129 
	`bŒfs_£t_deviû_£ek_¥“d
(
Ëaf
, 
dev_™em
, 0);

2130 
	`bŒfs_£t_deviû_bªdwidth
(
Ëaf
, 
dev_™em
, 0);

2131 
	`bŒfs_£t_deviû_¡¬t_off£t
(
Ëaf
, 
dev_™em
, 0);

2133 
±r
 = 
	`bŒfs_deviû_uuid
(
dev_™em
);

2134 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
deviû
->
uuid
, 
±r
, 
BTRFS_UUID_SIZE
);

2135 
±r
 = 
	`bŒfs_deviû_fsid
(
dev_™em
);

2136 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
Œªs
->
fs_šfo
->
fs_deviûs
->
m‘ad©a_uuid
,

2137 
±r
, 
BTRFS_FSID_SIZE
);

2138 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

2140 
»t
 = 0;

2141 
out
:

2142 
	`bŒfs_ä“_·th
(
·th
);

2143  
»t
;

2144 
	}
}

2152 
	$upd©e_dev_time
(cÚ¡ *
deviû_·th
)

2154 
·th
…ath;

2155 
»t
;

2157 
»t
 = 
	`k”n_·th
(
deviû_·th
, 
LOOKUP_FOLLOW
, &
·th
);

2158 ià(
»t
)

2161 
	`šode_upd©e_time
(
	`d_šode
(
·th
.
d’Œy
), 
S_MTIME
 | 
S_CTIME
 | 
S_VERSION
);

2162 
	`·th_put
(&
·th
);

2163 
	}
}

2165 
	$bŒfs_rm_dev_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2166 
bŒfs_deviû
 *
deviû
)

2168 
bŒfs_roÙ
 *
roÙ
 = 
deviû
->
fs_šfo
->
chunk_roÙ
;

2169 
»t
;

2170 
bŒfs_·th
 *
·th
;

2171 
bŒfs_key
 
key
;

2173 
·th
 = 
	`bŒfs_®loc_·th
();

2174 ià(!
·th
)

2175  -
ENOMEM
;

2177 
key
.
objeùid
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

2178 
key
.
ty³
 = 
BTRFS_DEV_ITEM_KEY
;

2179 
key
.
off£t
 = 
deviû
->
devid
;

2181 
	`bŒfs_»£rve_chunk_m‘ad©a
(
Œªs
, 
çl£
);

2182 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

2183 
	`bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
Œªs
);

2184 ià(
»t
) {

2185 ià(
»t
 > 0)

2186 
»t
 = -
ENOENT
;

2187 
out
;

2190 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

2191 
out
:

2192 
	`bŒfs_ä“_·th
(
·th
);

2193  
»t
;

2194 
	}
}

2201 
	$bŒfs_check_¿id_mš_deviûs
(
bŒfs_fs_šfo
 *
fs_šfo
,

2202 
u64
 
num_deviûs
)

2204 
u64
 
®l_ava
;

2205 
£q
;

2206 
i
;

2209 
£q
 = 
	`»ad_£qbegš
(&
fs_šfo
->
´ofes_lock
);

2211 
®l_ava
 = 
fs_šfo
->
ava_d©a_®loc_b™s
 |

2212 
fs_šfo
->
ava_sy¡em_®loc_b™s
 |

2213 
fs_šfo
->
ava_m‘ad©a_®loc_b™s
;

2214 } 
	`»ad_£q»Œy
(&
fs_šfo
->
´ofes_lock
, 
£q
));

2216 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; i++) {

2217 ià(!(
®l_ava
 & 
bŒfs_¿id_¬¿y
[
i
].
bg_æag
))

2220 ià(
num_deviûs
 < 
bŒfs_¿id_¬¿y
[
i
].
devs_mš
)

2221  
bŒfs_¿id_¬¿y
[
i
].
mšdev_”rÜ
;

2225 
	}
}

2227 
bŒfs_deviû
 * 
	$bŒfs_fšd_Ãxt_aùive_deviû
(

2228 
bŒfs_fs_deviûs
 *
fs_devs
, 
bŒfs_deviû
 *
deviû
)

2230 
bŒfs_deviû
 *
Ãxt_deviû
;

2232 
	`li¡_fÜ_—ch_’Œy
(
Ãxt_deviû
, &
fs_devs
->
deviûs
, 
dev_li¡
) {

2233 ià(
Ãxt_deviû
 !ğ
deviû
 &&

2234 !
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
, &
Ãxt_deviû
->
dev_¡©e
)

2235 && 
Ãxt_deviû
->
bdev
)

2236  
Ãxt_deviû
;

2239  
NULL
;

2240 
	}
}

2248 
__cŞd
 
	$bŒfs_assign_Ãxt_aùive_deviû
(
bŒfs_deviû
 *
deviû
,

2249 
bŒfs_deviû
 *
Ãxt_deviû
)

2251 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

2253 ià(!
Ãxt_deviû
)

2254 
Ãxt_deviû
 = 
	`bŒfs_fšd_Ãxt_aùive_deviû
(
fs_šfo
->
fs_deviûs
,

2255 
deviû
);

2256 
	`ASSERT
(
Ãxt_deviû
);

2258 ià(
fs_šfo
->
sb
->
s_bdev
 &&

2259 (
fs_šfo
->
sb
->
s_bdev
 =ğ
deviû
->
bdev
))

2260 
fs_šfo
->
sb
->
s_bdev
 = 
Ãxt_deviû
->
bdev
;

2262 ià(
fs_šfo
->
fs_deviûs
->
Ï‹¡_dev
->
bdev
 =ğ
deviû
->bdev)

2263 
fs_šfo
->
fs_deviûs
->
Ï‹¡_dev
 = 
Ãxt_deviû
;

2264 
	}
}

2270 
u64
 
	$bŒfs_num_deviûs
(
bŒfs_fs_šfo
 *
fs_šfo
)

2272 
u64
 
num_deviûs
 = 
fs_šfo
->
fs_deviûs
->num_devices;

2274 
	`down_»ad
(&
fs_šfo
->
dev_»¶aû
.
rw£m
);

2275 ià(
	`bŒfs_dev_»¶aû_is_Úgošg
(&
fs_šfo
->
dev_»¶aû
)) {

2276 
	`ASSERT
(
num_deviûs
 > 1);

2277 
num_deviûs
--;

2279 
	`up_»ad
(&
fs_šfo
->
dev_»¶aû
.
rw£m
);

2281  
num_deviûs
;

2282 
	}
}

2284 
	$bŒfs_sü©ch_su³rblock
(
bŒfs_fs_šfo
 *
fs_šfo
,

2285 
block_deviû
 *
bdev
, 
cİy_num
)

2287 
bŒfs_su³r_block
 *
disk_su³r
;

2288 cÚ¡ 
size_t
 
Ën
 = (
disk_su³r
->
magic
);

2289 cÚ¡ 
u64
 
by‹Ä
 = 
	`bŒfs_sb_off£t
(
cİy_num
);

2290 
»t
;

2292 
disk_su³r
 = 
	`bŒfs_»ad_disk_su³r
(
bdev
, 
by‹Ä
, bytenr);

2293 ià(
	`IS_ERR
(
disk_su³r
))

2296 
	`mem£t
(&
disk_su³r
->
magic
, 0, 
Ën
);

2297 
	`fŞio_m¬k_dœty
(
	`vœt_to_fŞio
(
disk_su³r
));

2298 
	`bŒfs_»Ëa£_disk_su³r
(
disk_su³r
);

2300 
»t
 = 
	`sync_blockdev_¿nge
(
bdev
, 
by‹Ä
, by‹Ä + 
Ën
 - 1);

2301 ià(
»t
)

2302 
	`bŒfs_w¬n
(
fs_šfo
, "error clearing superblock‚umber %d (%d)",

2303 
cİy_num
, 
»t
);

2304 
	}
}

2306 
	$bŒfs_sü©ch_su³rblocks
(
bŒfs_fs_šfo
 *
fs_šfo
,

2307 
block_deviû
 *
bdev
,

2308 cÚ¡ *
deviû_·th
)

2310 
cİy_num
;

2312 ià(!
bdev
)

2315 
cİy_num
 = 0; cİy_num < 
BTRFS_SUPER_MIRROR_MAX
; copy_num++) {

2316 ià(
	`bdev_is_zÚed
(
bdev
))

2317 
	`bŒfs_»£t_sb_log_zÚes
(
bdev
, 
cİy_num
);

2319 
	`bŒfs_sü©ch_su³rblock
(
fs_šfo
, 
bdev
, 
cİy_num
);

2323 
	`bŒfs_kobjeù_uev’t
(
bdev
, 
KOBJ_CHANGE
);

2326 
	`upd©e_dev_time
(
deviû_·th
);

2327 
	}
}

2329 
	$bŒfs_rm_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
,

2330 
bŒfs_dev_lookup_¬gs
 *
¬gs
,

2331 
block_deviû
 **
bdev
, **
hŞd”
)

2333 
bŒfs_Œªs_hªdË
 *
Œªs
;

2334 
bŒfs_deviû
 *
deviû
;

2335 
bŒfs_fs_deviûs
 *
cur_deviûs
;

2336 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

2337 
u64
 
num_deviûs
;

2338 
»t
 = 0;

2340 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
EXTENT_TREE_V2
)) {

2341 
	`bŒfs_”r
(
fs_šfo
, "device„emove‚ot supported onƒxtentree v2 yet");

2342  -
EINVAL
;

2350 
num_deviûs
 = 
	`bŒfs_num_deviûs
(
fs_šfo
);

2352 
»t
 = 
	`bŒfs_check_¿id_mš_deviûs
(
fs_šfo
, 
num_deviûs
 - 1);

2353 ià(
»t
)

2354  
»t
;

2356 
deviû
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, 
¬gs
);

2357 ià(!
deviû
) {

2358 ià(
¬gs
->
missšg
)

2359 
»t
 = 
BTRFS_ERROR_DEV_MISSING_NOT_FOUND
;

2361 
»t
 = -
ENOENT
;

2362  
»t
;

2365 ià(
	`bŒfs_pšÃd_by_sw­fe
(
fs_šfo
, 
deviû
)) {

2366 
	`bŒfs_w¬n_š_rcu
(
fs_šfo
,

2368 
	`bŒfs_dev_Çme
(
deviû
), deviû->
devid
);

2369  -
ETXTBSY
;

2372 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
))

2373  
BTRFS_ERROR_DEV_TGT_REPLACE
;

2375 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
) &&

2376 
fs_šfo
->
fs_deviûs
->
rw_deviûs
 == 1)

2377  
BTRFS_ERROR_DEV_ONLY_WRITABLE
;

2379 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
)) {

2380 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

2381 
	`li¡_d–_š™
(&
deviû
->
dev_®loc_li¡
);

2382 
deviû
->
fs_deviûs
->
rw_deviûs
--;

2383 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

2386 
»t
 = 
	`bŒfs_shršk_deviû
(
deviû
, 0);

2387 ià(
»t
)

2388 
”rÜ_undo
;

2390 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
fs_šfo
->
chunk_roÙ
, 0);

2391 ià(
	`IS_ERR
(
Œªs
)) {

2392 
»t
 = 
	`PTR_ERR
(
Œªs
);

2393 
”rÜ_undo
;

2396 
»t
 = 
	`bŒfs_rm_dev_™em
(
Œªs
, 
deviû
);

2397 ià(
»t
) {

2399 
	`bŒfs_ü™
(
fs_šfo
,

2401 
deviû
->
devid
, 
»t
);

2402 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2403 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2404  
»t
;

2407 
	`ş—r_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
deviû
->
dev_¡©e
);

2408 
	`bŒfs_süub_ÿnûl_dev
(
deviû
);

2425 
cur_deviûs
 = 
deviû
->
fs_deviûs
;

2426 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2427 
	`li¡_d–_rcu
(&
deviû
->
dev_li¡
);

2429 
cur_deviûs
->
num_deviûs
--;

2430 
cur_deviûs
->
tÙ®_deviûs
--;

2432 ià(
cur_deviûs
 !ğ
fs_deviûs
)

2433 
fs_deviûs
->
tÙ®_deviûs
--;

2435 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
, &
deviû
->
dev_¡©e
))

2436 
cur_deviûs
->
missšg_deviûs
--;

2438 
	`bŒfs_assign_Ãxt_aùive_deviû
(
deviû
, 
NULL
);

2440 ià(
deviû
->
bdev
) {

2441 
cur_deviûs
->
İ’_deviûs
--;

2443 
	`bŒfs_sysfs_»move_deviû
(
deviû
);

2446 
num_deviûs
 = 
	`bŒfs_su³r_num_deviûs
(
fs_šfo
->
su³r_cİy
) - 1;

2447 
	`bŒfs_£t_su³r_num_deviûs
(
fs_šfo
->
su³r_cİy
, 
num_deviûs
);

2448 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2460 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
)) {

2461 
	`bŒfs_sü©ch_su³rblocks
(
fs_šfo
, 
deviû
->
bdev
,

2462 
deviû
->
Çme
->
¡r
);

2463 ià(
deviû
->
bdev
) {

2464 
	`sync_blockdev
(
deviû
->
bdev
);

2465 
	`šv®id©e_bdev
(
deviû
->
bdev
);

2469 *
bdev
 = 
deviû
->bdev;

2470 *
hŞd”
 = 
deviû
->holder;

2471 
	`synchrÚize_rcu
();

2472 
	`bŒfs_ä“_deviû
(
deviû
);

2481 ià(
cur_deviûs
->
num_deviûs
 == 0) {

2482 
	`li¡_d–_š™
(&
cur_deviûs
->
£ed_li¡
);

2483 
	`ASSERT
(
cur_deviûs
->
İ’ed
 == 1);

2484 
cur_deviûs
->
İ’ed
--;

2485 
	`ä“_fs_deviûs
(
cur_deviûs
);

2488 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

2490  
»t
;

2492 
”rÜ_undo
:

2493 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
)) {

2494 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

2495 
	`li¡_add
(&
deviû
->
dev_®loc_li¡
,

2496 &
fs_deviûs
->
®loc_li¡
);

2497 
deviû
->
fs_deviûs
->
rw_deviûs
++;

2498 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

2500  
»t
;

2501 
	}
}

2503 
	$bŒfs_rm_dev_»¶aû_»move_¤cdev
(
bŒfs_deviû
 *
¤cdev
)

2505 
bŒfs_fs_deviûs
 *
fs_deviûs
;

2507 
	`lockd•_as£¹_h–d
(&
¤cdev
->
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2515 
fs_deviûs
 = 
¤cdev
->fs_devices;

2517 
	`li¡_d–_rcu
(&
¤cdev
->
dev_li¡
);

2518 
	`li¡_d–
(&
¤cdev
->
dev_®loc_li¡
);

2519 
fs_deviûs
->
num_deviûs
--;

2520 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
, &
¤cdev
->
dev_¡©e
))

2521 
fs_deviûs
->
missšg_deviûs
--;

2523 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
¤cdev
->
dev_¡©e
))

2524 
fs_deviûs
->
rw_deviûs
--;

2526 ià(
¤cdev
->
bdev
)

2527 
fs_deviûs
->
İ’_deviûs
--;

2528 
	}
}

2530 
	$bŒfs_rm_dev_»¶aû_ä“_¤cdev
(
bŒfs_deviû
 *
¤cdev
)

2532 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
¤cdev
->fs_devices;

2534 
	`mu‹x_lock
(&
uuid_mu‹x
);

2536 
	`bŒfs_şo£_bdev
(
¤cdev
);

2537 
	`synchrÚize_rcu
();

2538 
	`bŒfs_ä“_deviû
(
¤cdev
);

2541 ià(!
fs_deviûs
->
num_deviûs
) {

2548 
	`ASSERT
(
fs_deviûs
->
£edšg
);

2550 
	`li¡_d–_š™
(&
fs_deviûs
->
£ed_li¡
);

2551 
	`şo£_fs_deviûs
(
fs_deviûs
);

2552 
	`ä“_fs_deviûs
(
fs_deviûs
);

2554 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

2555 
	}
}

2557 
	$bŒfs_de¡roy_dev_»¶aû_tgtdev
(
bŒfs_deviû
 *
tgtdev
)

2559 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
tgtdev
->
fs_šfo
->fs_devices;

2561 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2563 
	`bŒfs_sysfs_»move_deviû
(
tgtdev
);

2565 ià(
tgtdev
->
bdev
)

2566 
fs_deviûs
->
İ’_deviûs
--;

2568 
fs_deviûs
->
num_deviûs
--;

2570 
	`bŒfs_assign_Ãxt_aùive_deviû
(
tgtdev
, 
NULL
);

2572 
	`li¡_d–_rcu
(&
tgtdev
->
dev_li¡
);

2574 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2576 
	`bŒfs_sü©ch_su³rblocks
(
tgtdev
->
fs_šfo
,gtdev->
bdev
,

2577 
tgtdev
->
Çme
->
¡r
);

2579 
	`bŒfs_şo£_bdev
(
tgtdev
);

2580 
	`synchrÚize_rcu
();

2581 
	`bŒfs_ä“_deviû
(
tgtdev
);

2582 
	}
}

2602 
	$bŒfs_g‘_dev_¬gs_äom_·th
(
bŒfs_fs_šfo
 *
fs_šfo
,

2603 
bŒfs_dev_lookup_¬gs
 *
¬gs
,

2604 cÚ¡ *
·th
)

2606 
bŒfs_su³r_block
 *
disk_su³r
;

2607 
block_deviû
 *
bdev
;

2608 
»t
;

2610 ià(!
·th
 || !path[0])

2611  -
EINVAL
;

2612 ià(!
	`¡rcmp
(
·th
, "missing")) {

2613 
¬gs
->
missšg
 = 
Œue
;

2617 
¬gs
->
uuid
 = 
	`kz®loc
(
BTRFS_UUID_SIZE
, 
GFP_KERNEL
);

2618 
¬gs
->
fsid
 = 
	`kz®loc
(
BTRFS_FSID_SIZE
, 
GFP_KERNEL
);

2619 ià(!
¬gs
->
uuid
 || !¬gs->
fsid
) {

2620 
	`bŒfs_put_dev_¬gs_äom_·th
(
¬gs
);

2621  -
ENOMEM
;

2624 
»t
 = 
	`bŒfs_g‘_bdev_ªd_sb
(
·th
, 
BLK_OPEN_READ
, 
NULL
, 0,

2625 &
bdev
, &
disk_su³r
);

2626 ià(
»t
) {

2627 
	`bŒfs_put_dev_¬gs_äom_·th
(
¬gs
);

2628  
»t
;

2631 
¬gs
->
devid
 = 
	`bŒfs_¡ack_deviû_id
(&
disk_su³r
->
dev_™em
);

2632 
	`memıy
(
¬gs
->
uuid
, 
disk_su³r
->
dev_™em
.uuid, 
BTRFS_UUID_SIZE
);

2633 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
METADATA_UUID
))

2634 
	`memıy
(
¬gs
->
fsid
, 
disk_su³r
->
m‘ad©a_uuid
, 
BTRFS_FSID_SIZE
);

2636 
	`memıy
(
¬gs
->
fsid
, 
disk_su³r
->fsid, 
BTRFS_FSID_SIZE
);

2637 
	`bŒfs_»Ëa£_disk_su³r
(
disk_su³r
);

2638 
	`blkdev_put
(
bdev
, 
NULL
);

2640 
	}
}

2647 
	$bŒfs_put_dev_¬gs_äom_·th
(
bŒfs_dev_lookup_¬gs
 *
¬gs
)

2649 
	`kä“
(
¬gs
->
uuid
);

2650 
	`kä“
(
¬gs
->
fsid
);

2651 
¬gs
->
uuid
 = 
NULL
;

2652 
¬gs
->
fsid
 = 
NULL
;

2653 
	}
}

2655 
bŒfs_deviû
 *
	$bŒfs_fšd_deviû_by_dev¥ec
(

2656 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
devid
,

2657 cÚ¡ *
deviû_·th
)

2659 
	`BTRFS_DEV_LOOKUP_ARGS
(
¬gs
);

2660 
bŒfs_deviû
 *
deviû
;

2661 
»t
;

2663 ià(
devid
) {

2664 
¬gs
.
devid
 = devid;

2665 
deviû
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, &
¬gs
);

2666 ià(!
deviû
)

2667  
	`ERR_PTR
(-
ENOENT
);

2668  
deviû
;

2671 
»t
 = 
	`bŒfs_g‘_dev_¬gs_äom_·th
(
fs_šfo
, &
¬gs
, 
deviû_·th
);

2672 ià(
»t
)

2673  
	`ERR_PTR
(
»t
);

2674 
deviû
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, &
¬gs
);

2675 
	`bŒfs_put_dev_¬gs_äom_·th
(&
¬gs
);

2676 ià(!
deviû
)

2677  
	`ERR_PTR
(-
ENOENT
);

2678  
deviû
;

2679 
	}
}

2681 
bŒfs_fs_deviûs
 *
	$bŒfs_š™_¥rout
(
bŒfs_fs_šfo
 *
fs_šfo
)

2683 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

2684 
bŒfs_fs_deviûs
 *
Şd_deviûs
;

2685 
bŒfs_fs_deviûs
 *
£ed_deviûs
;

2687 
	`lockd•_as£¹_h–d
(&
uuid_mu‹x
);

2688 ià(!
fs_deviûs
->
£edšg
)

2689  
	`ERR_PTR
(-
EINVAL
);

2695 
£ed_deviûs
 = 
	`®loc_fs_deviûs
(
NULL
, NULL);

2696 ià(
	`IS_ERR
(
£ed_deviûs
))

2697  
£ed_deviûs
;

2705 
Şd_deviûs
 = 
	`şÚe_fs_deviûs
(
fs_deviûs
);

2706 ià(
	`IS_ERR
(
Şd_deviûs
)) {

2707 
	`kä“
(
£ed_deviûs
);

2708  
Şd_deviûs
;

2711 
	`li¡_add
(&
Şd_deviûs
->
fs_li¡
, &
fs_uuids
);

2713 
	`memıy
(
£ed_deviûs
, 
fs_deviûs
, (*seed_devices));

2714 
£ed_deviûs
->
İ’ed
 = 1;

2715 
	`INIT_LIST_HEAD
(&
£ed_deviûs
->
deviûs
);

2716 
	`INIT_LIST_HEAD
(&
£ed_deviûs
->
®loc_li¡
);

2717 
	`mu‹x_š™
(&
£ed_deviûs
->
deviû_li¡_mu‹x
);

2719  
£ed_deviûs
;

2720 
	}
}

2726 
	$bŒfs_£tup_¥rout
(
bŒfs_fs_šfo
 *
fs_šfo
,

2727 
bŒfs_fs_deviûs
 *
£ed_deviûs
)

2729 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

2730 
bŒfs_su³r_block
 *
disk_su³r
 = 
fs_šfo
->
su³r_cİy
;

2731 
bŒfs_deviû
 *
deviû
;

2732 
u64
 
su³r_æags
;

2738 
	`lockd•_as£¹_h–d
(&
uuid_mu‹x
);

2752 
	`lockd•_as£¹_h–d
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2754 
	`li¡_¥liû_š™_rcu
(&
fs_deviûs
->
deviûs
, &
£ed_deviûs
->devices,

2755 
synchrÚize_rcu
);

2756 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
£ed_deviûs
->
deviûs
, 
dev_li¡
)

2757 
deviû
->
fs_deviûs
 = 
£ed_deviûs
;

2759 
fs_deviûs
->
£edšg
 = 
çl£
;

2760 
fs_deviûs
->
num_deviûs
 = 0;

2761 
fs_deviûs
->
İ’_deviûs
 = 0;

2762 
fs_deviûs
->
missšg_deviûs
 = 0;

2763 
fs_deviûs
->
rÙ©šg
 = 
çl£
;

2764 
	`li¡_add
(&
£ed_deviûs
->
£ed_li¡
, &
fs_deviûs
->seed_list);

2766 
	`g’”©e_¿ndom_uuid
(
fs_deviûs
->
fsid
);

2767 
	`memıy
(
fs_deviûs
->
m‘ad©a_uuid
, fs_deviûs->
fsid
, 
BTRFS_FSID_SIZE
);

2768 
	`memıy
(
disk_su³r
->
fsid
, 
fs_deviûs
->fsid, 
BTRFS_FSID_SIZE
);

2770 
su³r_æags
 = 
	`bŒfs_su³r_æags
(
disk_su³r
) &

2771 ~
BTRFS_SUPER_FLAG_SEEDING
;

2772 
	`bŒfs_£t_su³r_æags
(
disk_su³r
, 
su³r_æags
);

2773 
	}
}

2778 
	$bŒfs_fšish_¥rout
(
bŒfs_Œªs_hªdË
 *
Œªs
)

2780 
	`BTRFS_DEV_LOOKUP_ARGS
(
¬gs
);

2781 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

2782 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
chunk_roÙ
;

2783 
bŒfs_·th
 *
·th
;

2784 
ex‹Á_bufãr
 *
Ëaf
;

2785 
bŒfs_dev_™em
 *
dev_™em
;

2786 
bŒfs_deviû
 *
deviû
;

2787 
bŒfs_key
 
key
;

2788 
u8
 
fs_uuid
[
BTRFS_FSID_SIZE
];

2789 
u8
 
dev_uuid
[
BTRFS_UUID_SIZE
];

2790 
»t
;

2792 
·th
 = 
	`bŒfs_®loc_·th
();

2793 ià(!
·th
)

2794  -
ENOMEM
;

2796 
key
.
objeùid
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

2797 
key
.
off£t
 = 0;

2798 
key
.
ty³
 = 
BTRFS_DEV_ITEM_KEY
;

2801 
	`bŒfs_»£rve_chunk_m‘ad©a
(
Œªs
, 
çl£
);

2802 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

2803 
	`bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
Œªs
);

2804 ià(
»t
 < 0)

2805 
”rÜ
;

2807 
Ëaf
 = 
·th
->
nodes
[0];

2808 
Ãxt_¦Ù
:

2809 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

2810 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

2811 ià(
»t
 > 0)

2813 ià(
»t
 < 0)

2814 
”rÜ
;

2815 
Ëaf
 = 
·th
->
nodes
[0];

2816 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

2817 
	`bŒfs_»Ëa£_·th
(
·th
);

2821 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

2822 ià(
key
.
objeùid
 !ğ
BTRFS_DEV_ITEMS_OBJECTID
 ||

2823 
key
.
ty³
 !ğ
BTRFS_DEV_ITEM_KEY
)

2826 
dev_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

2827 
bŒfs_dev_™em
);

2828 
¬gs
.
devid
 = 
	`bŒfs_deviû_id
(
Ëaf
, 
dev_™em
);

2829 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
dev_uuid
, 
	`bŒfs_deviû_uuid
(
dev_™em
),

2830 
BTRFS_UUID_SIZE
);

2831 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
fs_uuid
, 
	`bŒfs_deviû_fsid
(
dev_™em
),

2832 
BTRFS_FSID_SIZE
);

2833 
¬gs
.
uuid
 = 
dev_uuid
;

2834 
¬gs
.
fsid
 = 
fs_uuid
;

2835 
deviû
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, &
¬gs
);

2836 
	`BUG_ON
(!
deviû
);

2838 ià(
deviû
->
fs_deviûs
->
£edšg
) {

2839 
	`bŒfs_£t_deviû_g’”©iÚ
(
Ëaf
, 
dev_™em
,

2840 
deviû
->
g’”©iÚ
);

2841 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

2844 
·th
->
¦Ùs
[0]++;

2845 
Ãxt_¦Ù
;

2847 
»t
 = 0;

2848 
”rÜ
:

2849 
	`bŒfs_ä“_·th
(
·th
);

2850  
»t
;

2851 
	}
}

2853 
	$bŒfs_š™_Ãw_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
deviû_·th
)

2855 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

2856 
bŒfs_Œªs_hªdË
 *
Œªs
;

2857 
bŒfs_deviû
 *
deviû
;

2858 
block_deviû
 *
bdev
;

2859 
su³r_block
 *
sb
 = 
fs_šfo
->sb;

2860 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

2861 
bŒfs_fs_deviûs
 *
£ed_deviûs
 = 
NULL
;

2862 
u64
 
Üig_su³r_tÙ®_by‹s
;

2863 
u64
 
Üig_su³r_num_deviûs
;

2864 
»t
 = 0;

2865 
boŞ
 
£edšg_dev
 = 
çl£
;

2866 
boŞ
 
locked
 = 
çl£
;

2868 ià(
	`sb_rdÚly
(
sb
è&& !
fs_deviûs
->
£edšg
)

2869  -
EROFS
;

2871 
bdev
 = 
	`blkdev_g‘_by_·th
(
deviû_·th
, 
BLK_OPEN_WRITE
,

2872 
fs_šfo
->
bdev_hŞd”
, 
NULL
);

2873 ià(
	`IS_ERR
(
bdev
))

2874  
	`PTR_ERR
(
bdev
);

2876 ià(!
	`bŒfs_check_deviû_zÚe_ty³
(
fs_šfo
, 
bdev
)) {

2877 
»t
 = -
EINVAL
;

2878 
”rÜ
;

2881 ià(
fs_deviûs
->
£edšg
) {

2882 
£edšg_dev
 = 
Œue
;

2883 
	`down_wr™e
(&
sb
->
s_umouÁ
);

2884 
	`mu‹x_lock
(&
uuid_mu‹x
);

2885 
locked
 = 
Œue
;

2888 
	`sync_blockdev
(
bdev
);

2890 
	`rcu_»ad_lock
();

2891 
	`li¡_fÜ_—ch_’Œy_rcu
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

2892 ià(
deviû
->
bdev
 == bdev) {

2893 
»t
 = -
EEXIST
;

2894 
	`rcu_»ad_uÆock
();

2895 
”rÜ
;

2898 
	`rcu_»ad_uÆock
();

2900 
deviû
 = 
	`bŒfs_®loc_deviû
(
fs_šfo
, 
NULL
, NULL, 
deviû_·th
);

2901 ià(
	`IS_ERR
(
deviû
)) {

2903 
»t
 = 
	`PTR_ERR
(
deviû
);

2904 
”rÜ
;

2907 
deviû
->
fs_šfo
 = fs_info;

2908 
deviû
->
bdev
 = bdev;

2909 
»t
 = 
	`lookup_bdev
(
deviû_·th
, &
deviû
->
devt
);

2910 ià(
»t
)

2911 
”rÜ_ä“_deviû
;

2913 
»t
 = 
	`bŒfs_g‘_dev_zÚe_šfo
(
deviû
, 
çl£
);

2914 ià(
»t
)

2915 
”rÜ_ä“_deviû
;

2917 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

2918 ià(
	`IS_ERR
(
Œªs
)) {

2919 
»t
 = 
	`PTR_ERR
(
Œªs
);

2920 
”rÜ_ä“_zÚe
;

2923 
	`£t_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
);

2924 
deviû
->
g’”©iÚ
 = 
Œªs
->
Œªsid
;

2925 
deviû
->
io_width
 = 
fs_šfo
->
£ùÜsize
;

2926 
deviû
->
io_®ign
 = 
fs_šfo
->
£ùÜsize
;

2927 
deviû
->
£ùÜ_size
 = 
fs_šfo
->
£ùÜsize
;

2928 
deviû
->
tÙ®_by‹s
 =

2929 
	`round_down
(
	`bdev_Ä_by‹s
(
bdev
), 
fs_šfo
->
£ùÜsize
);

2930 
deviû
->
disk_tÙ®_by‹s
 = deviû->
tÙ®_by‹s
;

2931 
deviû
->
comm™_tÙ®_by‹s
 = deviû->
tÙ®_by‹s
;

2932 
	`£t_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
deviû
->
dev_¡©e
);

2933 
	`ş—r_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
);

2934 
deviû
->
hŞd”
 = 
fs_šfo
->
bdev_hŞd”
;

2935 
deviû
->
dev_¡©s_v®id
 = 1;

2936 
	`£t_blocksize
(
deviû
->
bdev
, 
BTRFS_BDEV_BLOCKSIZE
);

2938 ià(
£edšg_dev
) {

2939 
	`bŒfs_ş—r_sb_rdÚly
(
sb
);

2942 
£ed_deviûs
 = 
	`bŒfs_š™_¥rout
(
fs_šfo
);

2943 ià(
	`IS_ERR
(
£ed_deviûs
)) {

2944 
»t
 = 
	`PTR_ERR
(
£ed_deviûs
);

2945 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2946 
”rÜ_Œªs
;

2950 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2951 ià(
£edšg_dev
) {

2952 
	`bŒfs_£tup_¥rout
(
fs_šfo
, 
£ed_deviûs
);

2953 
	`bŒfs_assign_Ãxt_aùive_deviû
(
fs_šfo
->
fs_deviûs
->
Ï‹¡_dev
,

2954 
deviû
);

2957 
deviû
->
fs_deviûs
 = fs_devices;

2959 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

2960 
	`li¡_add_rcu
(&
deviû
->
dev_li¡
, &
fs_deviûs
->
deviûs
);

2961 
	`li¡_add
(&
deviû
->
dev_®loc_li¡
, &
fs_deviûs
->
®loc_li¡
);

2962 
fs_deviûs
->
num_deviûs
++;

2963 
fs_deviûs
->
İ’_deviûs
++;

2964 
fs_deviûs
->
rw_deviûs
++;

2965 
fs_deviûs
->
tÙ®_deviûs
++;

2966 
fs_deviûs
->
tÙ®_rw_by‹s
 +ğ
deviû
->
tÙ®_by‹s
;

2968 
	`©omic64_add
(
deviû
->
tÙ®_by‹s
, &
fs_šfo
->
ä“_chunk_¥aû
);

2970 ià(!
	`bdev_nÚrÙ
(
bdev
))

2971 
fs_deviûs
->
rÙ©šg
 = 
Œue
;

2973 
Üig_su³r_tÙ®_by‹s
 = 
	`bŒfs_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cİy
);

2974 
	`bŒfs_£t_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cİy
,

2975 
	`round_down
(
Üig_su³r_tÙ®_by‹s
 + 
deviû
->
tÙ®_by‹s
,

2976 
fs_šfo
->
£ùÜsize
));

2978 
Üig_su³r_num_deviûs
 = 
	`bŒfs_su³r_num_deviûs
(
fs_šfo
->
su³r_cİy
);

2979 
	`bŒfs_£t_su³r_num_deviûs
(
fs_šfo
->
su³r_cİy
,

2980 
Üig_su³r_num_deviûs
 + 1);

2986 
	`bŒfs_ş—r_¥aû_šfo_fuÎ
(
fs_šfo
);

2988 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

2991 
	`bŒfs_sysfs_add_deviû
(
deviû
);

2993 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2995 ià(
£edšg_dev
) {

2996 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

2997 
»t
 = 
	`š™_fœ¡_rw_deviû
(
Œªs
);

2998 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

2999 ià(
»t
) {

3000 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3001 
”rÜ_sysfs
;

3005 
»t
 = 
	`bŒfs_add_dev_™em
(
Œªs
, 
deviû
);

3006 ià(
»t
) {

3007 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3008 
”rÜ_sysfs
;

3011 ià(
£edšg_dev
) {

3012 
»t
 = 
	`bŒfs_fšish_¥rout
(
Œªs
);

3013 ià(
»t
) {

3014 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3015 
”rÜ_sysfs
;

3022 
	`bŒfs_sysfs_upd©e_¥rout_fsid
(
fs_deviûs
);

3025 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

3027 ià(
£edšg_dev
) {

3028 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

3029 
	`up_wr™e
(&
sb
->
s_umouÁ
);

3030 
locked
 = 
çl£
;

3032 ià(
»t
)

3033  
»t
;

3035 
»t
 = 
	`bŒfs_»loÿ‹_sys_chunks
(
fs_šfo
);

3036 ià(
»t
 < 0)

3037 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

3039 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ
(
roÙ
);

3040 ià(
	`IS_ERR
(
Œªs
)) {

3041 ià(
	`PTR_ERR
(
Œªs
è=ğ-
ENOENT
)

3043 
»t
 = 
	`PTR_ERR
(
Œªs
);

3044 
Œªs
 = 
NULL
;

3045 
”rÜ_sysfs
;

3047 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

3057 
	`bŒfs_fÜg‘_deviûs
(
deviû
->
devt
);

3060 
	`upd©e_dev_time
(
deviû_·th
);

3062  
»t
;

3064 
”rÜ_sysfs
:

3065 
	`bŒfs_sysfs_»move_deviû
(
deviû
);

3066 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

3067 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

3068 
	`li¡_d–_rcu
(&
deviû
->
dev_li¡
);

3069 
	`li¡_d–
(&
deviû
->
dev_®loc_li¡
);

3070 
fs_šfo
->
fs_deviûs
->
num_deviûs
--;

3071 
fs_šfo
->
fs_deviûs
->
İ’_deviûs
--;

3072 
fs_šfo
->
fs_deviûs
->
rw_deviûs
--;

3073 
fs_šfo
->
fs_deviûs
->
tÙ®_deviûs
--;

3074 
fs_šfo
->
fs_deviûs
->
tÙ®_rw_by‹s
 -ğ
deviû
->
tÙ®_by‹s
;

3075 
	`©omic64_sub
(
deviû
->
tÙ®_by‹s
, &
fs_šfo
->
ä“_chunk_¥aû
);

3076 
	`bŒfs_£t_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cİy
,

3077 
Üig_su³r_tÙ®_by‹s
);

3078 
	`bŒfs_£t_su³r_num_deviûs
(
fs_šfo
->
su³r_cİy
,

3079 
Üig_su³r_num_deviûs
);

3080 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

3081 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

3082 
”rÜ_Œªs
:

3083 ià(
£edšg_dev
)

3084 
	`bŒfs_£t_sb_rdÚly
(
sb
);

3085 ià(
Œªs
)

3086 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3087 
”rÜ_ä“_zÚe
:

3088 
	`bŒfs_de¡roy_dev_zÚe_šfo
(
deviû
);

3089 
”rÜ_ä“_deviû
:

3090 
	`bŒfs_ä“_deviû
(
deviû
);

3091 
”rÜ
:

3092 
	`blkdev_put
(
bdev
, 
fs_šfo
->
bdev_hŞd”
);

3093 ià(
locked
) {

3094 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

3095 
	`up_wr™e
(&
sb
->
s_umouÁ
);

3097  
»t
;

3098 
	}
}

3100 
nošlše
 
	$bŒfs_upd©e_deviû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3101 
bŒfs_deviû
 *
deviû
)

3103 
»t
;

3104 
bŒfs_·th
 *
·th
;

3105 
bŒfs_roÙ
 *
roÙ
 = 
deviû
->
fs_šfo
->
chunk_roÙ
;

3106 
bŒfs_dev_™em
 *
dev_™em
;

3107 
ex‹Á_bufãr
 *
Ëaf
;

3108 
bŒfs_key
 
key
;

3110 
·th
 = 
	`bŒfs_®loc_·th
();

3111 ià(!
·th
)

3112  -
ENOMEM
;

3114 
key
.
objeùid
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

3115 
key
.
ty³
 = 
BTRFS_DEV_ITEM_KEY
;

3116 
key
.
off£t
 = 
deviû
->
devid
;

3118 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

3119 ià(
»t
 < 0)

3120 
out
;

3122 ià(
»t
 > 0) {

3123 
»t
 = -
ENOENT
;

3124 
out
;

3127 
Ëaf
 = 
·th
->
nodes
[0];

3128 
dev_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_dev_™em
);

3130 
	`bŒfs_£t_deviû_id
(
Ëaf
, 
dev_™em
, 
deviû
->
devid
);

3131 
	`bŒfs_£t_deviû_ty³
(
Ëaf
, 
dev_™em
, 
deviû
->
ty³
);

3132 
	`bŒfs_£t_deviû_io_®ign
(
Ëaf
, 
dev_™em
, 
deviû
->
io_®ign
);

3133 
	`bŒfs_£t_deviû_io_width
(
Ëaf
, 
dev_™em
, 
deviû
->
io_width
);

3134 
	`bŒfs_£t_deviû_£ùÜ_size
(
Ëaf
, 
dev_™em
, 
deviû
->
£ùÜ_size
);

3135 
	`bŒfs_£t_deviû_tÙ®_by‹s
(
Ëaf
, 
dev_™em
,

3136 
	`bŒfs_deviû_g‘_disk_tÙ®_by‹s
(
deviû
));

3137 
	`bŒfs_£t_deviû_by‹s_u£d
(
Ëaf
, 
dev_™em
,

3138 
	`bŒfs_deviû_g‘_by‹s_u£d
(
deviû
));

3139 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

3141 
out
:

3142 
	`bŒfs_ä“_·th
(
·th
);

3143  
»t
;

3144 
	}
}

3146 
	$bŒfs_grow_deviû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3147 
bŒfs_deviû
 *
deviû
, 
u64
 
Ãw_size
)

3149 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

3150 
bŒfs_su³r_block
 *
su³r_cİy
 = 
fs_šfo
->super_copy;

3151 
u64
 
Şd_tÙ®
;

3152 
u64
 
diff
;

3153 
»t
;

3155 ià(!
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
))

3156  -
EACCES
;

3158 
Ãw_size
 = 
	`round_down
Òew_size, 
fs_šfo
->
£ùÜsize
);

3160 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

3161 
Şd_tÙ®
 = 
	`bŒfs_su³r_tÙ®_by‹s
(
su³r_cİy
);

3162 
diff
 = 
	`round_down
(
Ãw_size
 - 
deviû
->
tÙ®_by‹s
, 
fs_šfo
->
£ùÜsize
);

3164 ià(
Ãw_size
 <ğ
deviû
->
tÙ®_by‹s
 ||

3165 
	`‹¡_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
)) {

3166 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

3167  -
EINVAL
;

3170 
	`bŒfs_£t_su³r_tÙ®_by‹s
(
su³r_cİy
,

3171 
	`round_down
(
Şd_tÙ®
 + 
diff
, 
fs_šfo
->
£ùÜsize
));

3172 
deviû
->
fs_deviûs
->
tÙ®_rw_by‹s
 +ğ
diff
;

3174 
	`bŒfs_deviû_£t_tÙ®_by‹s
(
deviû
, 
Ãw_size
);

3175 
	`bŒfs_deviû_£t_disk_tÙ®_by‹s
(
deviû
, 
Ãw_size
);

3176 
	`bŒfs_ş—r_¥aû_šfo_fuÎ
(
deviû
->
fs_šfo
);

3177 ià(
	`li¡_em±y
(&
deviû
->
po¡_comm™_li¡
))

3178 
	`li¡_add_
(&
deviû
->
po¡_comm™_li¡
,

3179 &
Œªs
->
Œª§ùiÚ
->
dev_upd©e_li¡
);

3180 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

3182 
	`bŒfs_»£rve_chunk_m‘ad©a
(
Œªs
, 
çl£
);

3183 
»t
 = 
	`bŒfs_upd©e_deviû
(
Œªs
, 
deviû
);

3184 
	`bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
Œªs
);

3186  
»t
;

3187 
	}
}

3189 
	$bŒfs_ä“_chunk
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
chunk_off£t
)

3191 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

3192 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
chunk_roÙ
;

3193 
»t
;

3194 
bŒfs_·th
 *
·th
;

3195 
bŒfs_key
 
key
;

3197 
·th
 = 
	`bŒfs_®loc_·th
();

3198 ià(!
·th
)

3199  -
ENOMEM
;

3201 
key
.
objeùid
 = 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
;

3202 
key
.
off£t
 = 
chunk_off£t
;

3203 
key
.
ty³
 = 
BTRFS_CHUNK_ITEM_KEY
;

3205 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

3206 ià(
»t
 < 0)

3207 
out
;

3208 ià(
»t
 > 0) {

3209 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, -
ENOENT
,

3211 
»t
 = -
ENOENT
;

3212 
out
;

3215 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

3216 ià(
»t
 < 0)

3217 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

3219 
out
:

3220 
	`bŒfs_ä“_·th
(
·th
);

3221  
»t
;

3222 
	}
}

3224 
	$bŒfs_d–_sys_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
chunk_off£t
)

3226 
bŒfs_su³r_block
 *
su³r_cİy
 = 
fs_šfo
->super_copy;

3227 
bŒfs_disk_key
 *
disk_key
;

3228 
bŒfs_chunk
 *
chunk
;

3229 
u8
 *
±r
;

3230 
»t
 = 0;

3231 
u32
 
num_¡res
;

3232 
u32
 
¬¿y_size
;

3233 
u32
 
Ën
 = 0;

3234 
u32
 
cur
;

3235 
bŒfs_key
 
key
;

3237 
	`lockd•_as£¹_h–d
(&
fs_šfo
->
chunk_mu‹x
);

3238 
¬¿y_size
 = 
	`bŒfs_su³r_sys_¬¿y_size
(
su³r_cİy
);

3240 
±r
 = 
su³r_cİy
->
sys_chunk_¬¿y
;

3241 
cur
 = 0;

3243 
cur
 < 
¬¿y_size
) {

3244 
disk_key
 = (
bŒfs_disk_key
 *)
±r
;

3245 
	`bŒfs_disk_key_to_ıu
(&
key
, 
disk_key
);

3247 
Ën
 = (*
disk_key
);

3249 ià(
key
.
ty³
 =ğ
BTRFS_CHUNK_ITEM_KEY
) {

3250 
chunk
 = (
bŒfs_chunk
 *)(
±r
 + 
Ën
);

3251 
num_¡res
 = 
	`bŒfs_¡ack_chunk_num_¡res
(
chunk
);

3252 
Ën
 +ğ
	`bŒfs_chunk_™em_size
(
num_¡res
);

3254 
»t
 = -
EIO
;

3257 ià(
key
.
objeùid
 =ğ
BTRFS_FIRST_CHUNK_TREE_OBJECTID
 &&

3258 
key
.
off£t
 =ğ
chunk_off£t
) {

3259 
	`memmove
(
±r
,…Œ + 
Ën
, 
¬¿y_size
 - (
cur
 +†en));

3260 
¬¿y_size
 -ğ
Ën
;

3261 
	`bŒfs_£t_su³r_sys_¬¿y_size
(
su³r_cİy
, 
¬¿y_size
);

3263 
±r
 +ğ
Ën
;

3264 
cur
 +ğ
Ën
;

3267  
»t
;

3268 
	}
}

3277 
ex‹Á_m­
 *
	$bŒfs_g‘_chunk_m­
(
bŒfs_fs_šfo
 *
fs_šfo
,

3278 
u64
 
logiÿl
, u64 
Ëngth
)

3280 
ex‹Á_m­_Œ“
 *
em_Œ“
;

3281 
ex‹Á_m­
 *
em
;

3283 
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

3284 
	`»ad_lock
(&
em_Œ“
->
lock
);

3285 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
logiÿl
, 
Ëngth
);

3286 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

3288 ià(!
em
) {

3289 
	`bŒfs_ü™
(
fs_šfo
,

3291 
logiÿl
, 
Ëngth
);

3292  
	`ERR_PTR
(-
EINVAL
);

3295 ià(
em
->
¡¬t
 > 
logiÿl
 ||ƒm->¡¬ˆ+ƒm->
Ën
 <=†ogical) {

3296 
	`bŒfs_ü™
(
fs_šfo
,

3298 
logiÿl
,†ogiÿÈ+ 
Ëngth
, 
em
->
¡¬t
,ƒm->¡¬ˆ+ƒm->
Ën
);

3299 
	`ä“_ex‹Á_m­
(
em
);

3300  
	`ERR_PTR
(-
EINVAL
);

3304  
em
;

3305 
	}
}

3307 
	$»move_chunk_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3308 
m­_lookup
 *
m­
, 
u64
 
chunk_off£t
)

3310 
i
;

3317 
	`lockd•_as£¹_h–d
(&
Œªs
->
fs_šfo
->
chunk_mu‹x
);

3319 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

3320 
»t
;

3322 
»t
 = 
	`bŒfs_upd©e_deviû
(
Œªs
, 
m­
->
¡res
[
i
].
dev
);

3323 ià(
»t
)

3324  
»t
;

3327  
	`bŒfs_ä“_chunk
(
Œªs
, 
chunk_off£t
);

3328 
	}
}

3330 
	$bŒfs_»move_chunk
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
chunk_off£t
)

3332 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

3333 
ex‹Á_m­
 *
em
;

3334 
m­_lookup
 *
m­
;

3335 
u64
 
dev_ex‹Á_Ën
 = 0;

3336 
i
, 
»t
 = 0;

3337 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

3339 
em
 = 
	`bŒfs_g‘_chunk_m­
(
fs_šfo
, 
chunk_off£t
, 1);

3340 ià(
	`IS_ERR
(
em
)) {

3346 
	`ASSERT
(0);

3347  
	`PTR_ERR
(
em
);

3349 
m­
 = 
em
->
m­_lookup
;

3361 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

3362 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

3363 
bŒfs_deviû
 *
deviû
 = 
m­
->
¡res
[
i
].
dev
;

3364 
»t
 = 
	`bŒfs_ä“_dev_ex‹Á
(
Œªs
, 
deviû
,

3365 
m­
->
¡res
[
i
].
physiÿl
,

3366 &
dev_ex‹Á_Ën
);

3367 ià(
»t
) {

3368 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

3369 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3370 
out
;

3373 ià(
deviû
->
by‹s_u£d
 > 0) {

3374 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

3375 
	`bŒfs_deviû_£t_by‹s_u£d
(
deviû
,

3376 
deviû
->
by‹s_u£d
 - 
dev_ex‹Á_Ën
);

3377 
	`©omic64_add
(
dev_ex‹Á_Ën
, &
fs_šfo
->
ä“_chunk_¥aû
);

3378 
	`bŒfs_ş—r_¥aû_šfo_fuÎ
(
fs_šfo
);

3379 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

3382 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

3405 
Œªs
->
»movšg_chunk
 = 
Œue
;

3406 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

3408 
	`check_sy¡em_chunk
(
Œªs
, 
m­
->
ty³
);

3410 
»t
 = 
	`»move_chunk_™em
(
Œªs
, 
m­
, 
chunk_off£t
);

3425 ià(
»t
 =ğ-
ENOSPC
) {

3426 cÚ¡ 
u64
 
sys_æags
 = 
	`bŒfs_sy¡em_®loc_´ofe
(
fs_šfo
);

3427 
bŒfs_block_group
 *
sys_bg
;

3429 
sys_bg
 = 
	`bŒfs_ü—‹_chunk
(
Œªs
, 
sys_æags
);

3430 ià(
	`IS_ERR
(
sys_bg
)) {

3431 
»t
 = 
	`PTR_ERR
(
sys_bg
);

3432 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3433 
out
;

3436 
»t
 = 
	`bŒfs_chunk_®loc_add_chunk_™em
(
Œªs
, 
sys_bg
);

3437 ià(
»t
) {

3438 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3439 
out
;

3442 
»t
 = 
	`»move_chunk_™em
(
Œªs
, 
m­
, 
chunk_off£t
);

3443 ià(
»t
) {

3444 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3445 
out
;

3447 } ià(
»t
) {

3448 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3449 
out
;

3452 
	`Œaû_bŒfs_chunk_ä“
(
fs_šfo
, 
m­
, 
chunk_off£t
, 
em
->
Ën
);

3454 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) {

3455 
»t
 = 
	`bŒfs_d–_sys_chunk
(
fs_šfo
, 
chunk_off£t
);

3456 ià(
»t
) {

3457 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3458 
out
;

3462 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

3463 
Œªs
->
»movšg_chunk
 = 
çl£
;

3469 
	`bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
Œªs
);

3471 
»t
 = 
	`bŒfs_»move_block_group
(
Œªs
, 
chunk_off£t
, 
em
);

3472 ià(
»t
) {

3473 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3474 
out
;

3477 
out
:

3478 ià(
Œªs
->
»movšg_chunk
) {

3479 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

3480 
Œªs
->
»movšg_chunk
 = 
çl£
;

3483 
	`ä“_ex‹Á_m­
(
em
);

3484  
»t
;

3485 
	}
}

3487 
	$bŒfs_»loÿ‹_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
chunk_off£t
)

3489 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
chunk_roÙ
;

3490 
bŒfs_Œªs_hªdË
 *
Œªs
;

3491 
bŒfs_block_group
 *
block_group
;

3492 
u64
 
Ëngth
;

3493 
»t
;

3495 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
EXTENT_TREE_V2
)) {

3496 
	`bŒfs_”r
(
fs_šfo
,

3498  -
EINVAL
;

3513 
	`lockd•_as£¹_h–d
(&
fs_šfo
->
»şaim_bgs_lock
);

3516 
	`bŒfs_süub_·u£
(
fs_šfo
);

3517 
»t
 = 
	`bŒfs_»loÿ‹_block_group
(
fs_šfo
, 
chunk_off£t
);

3518 
	`bŒfs_süub_cÚtšue
(
fs_šfo
);

3519 ià(
»t
) {

3524 ià(
	`BTRFS_FS_ERROR
(
fs_šfo
))

3525 
	`bŒfs_süub_ÿnûl
(
fs_šfo
);

3526  
»t
;

3529 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
chunk_off£t
);

3530 ià(!
block_group
)

3531  -
ENOENT
;

3532 
	`bŒfs_disÿrd_ÿnûl_wÜk
(&
fs_šfo
->
disÿrd_ùl
, 
block_group
);

3533 
Ëngth
 = 
block_group
->length;

3534 
	`bŒfs_put_block_group
(
block_group
);

3542 ià(
	`bŒfs_is_zÚed
(
fs_šfo
)) {

3543 
»t
 = 
	`bŒfs_disÿrd_ex‹Á
(
fs_šfo
, 
chunk_off£t
, 
Ëngth
, 
NULL
);

3544 ià(
»t
)

3545 
	`bŒfs_šfo
(
fs_šfo
,

3547 
chunk_off£t
);

3550 
Œªs
 = 
	`bŒfs_¡¬t_Œªs_»move_block_group
(
roÙ
->
fs_šfo
,

3551 
chunk_off£t
);

3552 ià(
	`IS_ERR
(
Œªs
)) {

3553 
»t
 = 
	`PTR_ERR
(
Œªs
);

3554 
	`bŒfs_hªdË_fs_”rÜ
(
roÙ
->
fs_šfo
, 
»t
, 
NULL
);

3555  
»t
;

3562 
»t
 = 
	`bŒfs_»move_chunk
(
Œªs
, 
chunk_off£t
);

3563 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3564  
»t
;

3565 
	}
}

3567 
	$bŒfs_»loÿ‹_sys_chunks
(
bŒfs_fs_šfo
 *
fs_šfo
)

3569 
bŒfs_roÙ
 *
chunk_roÙ
 = 
fs_šfo
->chunk_root;

3570 
bŒfs_·th
 *
·th
;

3571 
ex‹Á_bufãr
 *
Ëaf
;

3572 
bŒfs_chunk
 *
chunk
;

3573 
bŒfs_key
 
key
;

3574 
bŒfs_key
 
found_key
;

3575 
u64
 
chunk_ty³
;

3576 
boŞ
 
»Œ›d
 = 
çl£
;

3577 
çed
 = 0;

3578 
»t
;

3580 
·th
 = 
	`bŒfs_®loc_·th
();

3581 ià(!
·th
)

3582  -
ENOMEM
;

3584 
agaš
:

3585 
key
.
objeùid
 = 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
;

3586 
key
.
off£t
 = (
u64
)-1;

3587 
key
.
ty³
 = 
BTRFS_CHUNK_ITEM_KEY
;

3590 
	`mu‹x_lock
(&
fs_šfo
->
»şaim_bgs_lock
);

3591 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
chunk_roÙ
, &
key
, 
·th
, 0, 0);

3592 ià(
»t
 < 0) {

3593 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

3594 
”rÜ
;

3596 
	`BUG_ON
(
»t
 == 0);

3598 
»t
 = 
	`bŒfs_´evious_™em
(
chunk_roÙ
, 
·th
, 
key
.
objeùid
,

3599 
key
.
ty³
);

3600 ià(
»t
)

3601 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

3602 ià(
»t
 < 0)

3603 
”rÜ
;

3604 ià(
»t
 > 0)

3607 
Ëaf
 = 
·th
->
nodes
[0];

3608 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

3610 
chunk
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

3611 
bŒfs_chunk
);

3612 
chunk_ty³
 = 
	`bŒfs_chunk_ty³
(
Ëaf
, 
chunk
);

3613 
	`bŒfs_»Ëa£_·th
(
·th
);

3615 ià(
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) {

3616 
»t
 = 
	`bŒfs_»loÿ‹_chunk
(
fs_šfo
, 
found_key
.
off£t
);

3617 ià(
»t
 =ğ-
ENOSPC
)

3618 
çed
++;

3620 
	`BUG_ON
(
»t
);

3622 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

3624 ià(
found_key
.
off£t
 == 0)

3626 
key
.
off£t
 = 
found_key
.offset - 1;

3628 
»t
 = 0;

3629 ià(
çed
 && !
»Œ›d
) {

3630 
çed
 = 0;

3631 
»Œ›d
 = 
Œue
;

3632 
agaš
;

3633 } ià(
	`WARN_ON
(
çed
 && 
»Œ›d
)) {

3634 
»t
 = -
ENOSPC
;

3636 
”rÜ
:

3637 
	`bŒfs_ä“_·th
(
·th
);

3638  
»t
;

3639 
	}
}

3646 
	$bŒfs_may_®loc_d©a_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
,

3647 
u64
 
chunk_off£t
)

3649 
bŒfs_block_group
 *
ÿche
;

3650 
u64
 
by‹s_u£d
;

3651 
u64
 
chunk_ty³
;

3653 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
chunk_off£t
);

3654 
	`ASSERT
(
ÿche
);

3655 
chunk_ty³
 = 
ÿche
->
æags
;

3656 
	`bŒfs_put_block_group
(
ÿche
);

3658 ià(!(
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_DATA
))

3661 
	`¥š_lock
(&
fs_šfo
->
d©a_sšfo
->
lock
);

3662 
by‹s_u£d
 = 
fs_šfo
->
d©a_sšfo
->bytes_used;

3663 
	`¥š_uÆock
(&
fs_šfo
->
d©a_sšfo
->
lock
);

3665 ià(!
by‹s_u£d
) {

3666 
bŒfs_Œªs_hªdË
 *
Œªs
;

3667 
»t
;

3669 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
fs_šfo
->
Œ“_roÙ
);

3670 ià(
	`IS_ERR
(
Œªs
))

3671  
	`PTR_ERR
(
Œªs
);

3673 
»t
 = 
	`bŒfs_fÜû_chunk_®loc
(
Œªs
, 
BTRFS_BLOCK_GROUP_DATA
);

3674 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3675 ià(
»t
 < 0)

3676  
»t
;

3681 
	}
}

3683 
	$š£¹_b®ªû_™em
(
bŒfs_fs_šfo
 *
fs_šfo
,

3684 
bŒfs_b®ªû_cÚŒŞ
 *
bùl
)

3686 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

3687 
bŒfs_Œªs_hªdË
 *
Œªs
;

3688 
bŒfs_b®ªû_™em
 *
™em
;

3689 
bŒfs_disk_b®ªû_¬gs
 
disk_b¬gs
;

3690 
bŒfs_·th
 *
·th
;

3691 
ex‹Á_bufãr
 *
Ëaf
;

3692 
bŒfs_key
 
key
;

3693 
»t
, 
”r
;

3695 
·th
 = 
	`bŒfs_®loc_·th
();

3696 ià(!
·th
)

3697  -
ENOMEM
;

3699 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

3700 ià(
	`IS_ERR
(
Œªs
)) {

3701 
	`bŒfs_ä“_·th
(
·th
);

3702  
	`PTR_ERR
(
Œªs
);

3705 
key
.
objeùid
 = 
BTRFS_BALANCE_OBJECTID
;

3706 
key
.
ty³
 = 
BTRFS_TEMPORARY_ITEM_KEY
;

3707 
key
.
off£t
 = 0;

3709 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

3710 (*
™em
));

3711 ià(
»t
)

3712 
out
;

3714 
Ëaf
 = 
·th
->
nodes
[0];

3715 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_b®ªû_™em
);

3717 
	`memz”o_ex‹Á_bufãr
(
Ëaf
, ()
™em
, (*item));

3719 
	`bŒfs_ıu_b®ªû_¬gs_to_disk
(&
disk_b¬gs
, &
bùl
->
d©a
);

3720 
	`bŒfs_£t_b®ªû_d©a
(
Ëaf
, 
™em
, &
disk_b¬gs
);

3721 
	`bŒfs_ıu_b®ªû_¬gs_to_disk
(&
disk_b¬gs
, &
bùl
->
m‘a
);

3722 
	`bŒfs_£t_b®ªû_m‘a
(
Ëaf
, 
™em
, &
disk_b¬gs
);

3723 
	`bŒfs_ıu_b®ªû_¬gs_to_disk
(&
disk_b¬gs
, &
bùl
->
sys
);

3724 
	`bŒfs_£t_b®ªû_sys
(
Ëaf
, 
™em
, &
disk_b¬gs
);

3726 
	`bŒfs_£t_b®ªû_æags
(
Ëaf
, 
™em
, 
bùl
->
æags
);

3728 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

3729 
out
:

3730 
	`bŒfs_ä“_·th
(
·th
);

3731 
”r
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

3732 ià(
”r
 && !
»t
)

3733 
»t
 = 
”r
;

3734  
»t
;

3735 
	}
}

3737 
	$d–_b®ªû_™em
(
bŒfs_fs_šfo
 *
fs_šfo
)

3739 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

3740 
bŒfs_Œªs_hªdË
 *
Œªs
;

3741 
bŒfs_·th
 *
·th
;

3742 
bŒfs_key
 
key
;

3743 
»t
, 
”r
;

3745 
·th
 = 
	`bŒfs_®loc_·th
();

3746 ià(!
·th
)

3747  -
ENOMEM
;

3749 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ_çÎback_glob®_rsv
(
roÙ
, 0);

3750 ià(
	`IS_ERR
(
Œªs
)) {

3751 
	`bŒfs_ä“_·th
(
·th
);

3752  
	`PTR_ERR
(
Œªs
);

3755 
key
.
objeùid
 = 
BTRFS_BALANCE_OBJECTID
;

3756 
key
.
ty³
 = 
BTRFS_TEMPORARY_ITEM_KEY
;

3757 
key
.
off£t
 = 0;

3759 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

3760 ià(
»t
 < 0)

3761 
out
;

3762 ià(
»t
 > 0) {

3763 
»t
 = -
ENOENT
;

3764 
out
;

3767 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

3768 
out
:

3769 
	`bŒfs_ä“_·th
(
·th
);

3770 
”r
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

3771 ià(
”r
 && !
»t
)

3772 
»t
 = 
”r
;

3773  
»t
;

3774 
	}
}

3780 
	$upd©e_b®ªû_¬gs
(
bŒfs_b®ªû_cÚŒŞ
 *
bùl
)

3785 ià(
bùl
->
d©a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)

3786 
bùl
->
d©a
.
æags
 |ğ
BTRFS_BALANCE_ARGS_SOFT
;

3787 ià(
bùl
->
sys
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)

3788 
bùl
->
sys
.
æags
 |ğ
BTRFS_BALANCE_ARGS_SOFT
;

3789 ià(
bùl
->
m‘a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)

3790 
bùl
->
m‘a
.
æags
 |ğ
BTRFS_BALANCE_ARGS_SOFT
;

3799 ià(!(
bùl
->
d©a
.
æags
 & 
BTRFS_BALANCE_ARGS_USAGE
) &&

3800 !(
bùl
->
d©a
.
æags
 & 
BTRFS_BALANCE_ARGS_USAGE_RANGE
) &&

3801 !(
bùl
->
d©a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)) {

3802 
bùl
->
d©a
.
æags
 |ğ
BTRFS_BALANCE_ARGS_USAGE
;

3803 
bùl
->
d©a
.
u§ge
 = 90;

3805 ià(!(
bùl
->
sys
.
æags
 & 
BTRFS_BALANCE_ARGS_USAGE
) &&

3806 !(
bùl
->
sys
.
æags
 & 
BTRFS_BALANCE_ARGS_USAGE_RANGE
) &&

3807 !(
bùl
->
sys
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)) {

3808 
bùl
->
sys
.
æags
 |ğ
BTRFS_BALANCE_ARGS_USAGE
;

3809 
bùl
->
sys
.
u§ge
 = 90;

3811 ià(!(
bùl
->
m‘a
.
æags
 & 
BTRFS_BALANCE_ARGS_USAGE
) &&

3812 !(
bùl
->
m‘a
.
æags
 & 
BTRFS_BALANCE_ARGS_USAGE_RANGE
) &&

3813 !(
bùl
->
m‘a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)) {

3814 
bùl
->
m‘a
.
æags
 |ğ
BTRFS_BALANCE_ARGS_USAGE
;

3815 
bùl
->
m‘a
.
u§ge
 = 90;

3817 
	}
}

3822 
	$»£t_b®ªû_¡©e
(
bŒfs_fs_šfo
 *
fs_šfo
)

3824 
bŒfs_b®ªû_cÚŒŞ
 *
bùl
 = 
fs_šfo
->
b®ªû_ùl
;

3825 
»t
;

3827 
	`BUG_ON
(!
fs_šfo
->
b®ªû_ùl
);

3829 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

3830 
fs_šfo
->
b®ªû_ùl
 = 
NULL
;

3831 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

3833 
	`kä“
(
bùl
);

3834 
»t
 = 
	`d–_b®ªû_™em
(
fs_šfo
);

3835 ià(
»t
)

3836 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
, 
NULL
);

3837 
	}
}

3843 
	$chunk_´ofes_f‹r
(
u64
 
chunk_ty³
,

3844 
bŒfs_b®ªû_¬gs
 *
b¬gs
)

3846 
chunk_ty³
 = 
	`chunk_to_ex‹nded
(chunk_type) &

3847 
BTRFS_EXTENDED_PROFILE_MASK
;

3849 ià(
b¬gs
->
´ofes
 & 
chunk_ty³
)

3853 
	}
}

3855 
	$chunk_u§ge_¿nge_f‹r
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
chunk_off£t
,

3856 
bŒfs_b®ªû_¬gs
 *
b¬gs
)

3858 
bŒfs_block_group
 *
ÿche
;

3859 
u64
 
chunk_u£d
;

3860 
u64
 
u£r_th»sh_mš
;

3861 
u64
 
u£r_th»sh_max
;

3862 
»t
 = 1;

3864 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
chunk_off£t
);

3865 
chunk_u£d
 = 
ÿche
->
u£d
;

3867 ià(
b¬gs
->
u§ge_mš
 == 0)

3868 
u£r_th»sh_mš
 = 0;

3870 
u£r_th»sh_mš
 = 
	`muÉ_³rc
(
ÿche
->
Ëngth
, 
b¬gs
->
u§ge_mš
);

3872 ià(
b¬gs
->
u§ge_max
 == 0)

3873 
u£r_th»sh_max
 = 1;

3874 ià(
b¬gs
->
u§ge_max
 > 100)

3875 
u£r_th»sh_max
 = 
ÿche
->
Ëngth
;

3877 
u£r_th»sh_max
 = 
	`muÉ_³rc
(
ÿche
->
Ëngth
, 
b¬gs
->
u§ge_max
);

3879 ià(
u£r_th»sh_mš
 <ğ
chunk_u£d
 && chunk_u£d < 
u£r_th»sh_max
)

3880 
»t
 = 0;

3882 
	`bŒfs_put_block_group
(
ÿche
);

3883  
»t
;

3884 
	}
}

3886 
	$chunk_u§ge_f‹r
(
bŒfs_fs_šfo
 *
fs_šfo
,

3887 
u64
 
chunk_off£t
, 
bŒfs_b®ªû_¬gs
 *
b¬gs
)

3889 
bŒfs_block_group
 *
ÿche
;

3890 
u64
 
chunk_u£d
, 
u£r_th»sh
;

3891 
»t
 = 1;

3893 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
chunk_off£t
);

3894 
chunk_u£d
 = 
ÿche
->
u£d
;

3896 ià(
b¬gs
->
u§ge_mš
 == 0)

3897 
u£r_th»sh
 = 1;

3898 ià(
b¬gs
->
u§ge
 > 100)

3899 
u£r_th»sh
 = 
ÿche
->
Ëngth
;

3901 
u£r_th»sh
 = 
	`muÉ_³rc
(
ÿche
->
Ëngth
, 
b¬gs
->
u§ge
);

3903 ià(
chunk_u£d
 < 
u£r_th»sh
)

3904 
»t
 = 0;

3906 
	`bŒfs_put_block_group
(
ÿche
);

3907  
»t
;

3908 
	}
}

3910 
	$chunk_devid_f‹r
(
ex‹Á_bufãr
 *
Ëaf
,

3911 
bŒfs_chunk
 *
chunk
,

3912 
bŒfs_b®ªû_¬gs
 *
b¬gs
)

3914 
bŒfs_¡re
 *
¡re
;

3915 
num_¡res
 = 
	`bŒfs_chunk_num_¡res
(
Ëaf
, 
chunk
);

3916 
i
;

3918 
i
 = 0; i < 
num_¡res
; i++) {

3919 
¡re
 = 
	`bŒfs_¡re_Ä
(
chunk
, 
i
);

3920 ià(
	`bŒfs_¡re_devid
(
Ëaf
, 
¡re
è=ğ
b¬gs
->
devid
)

3925 
	}
}

3927 
u64
 
	$ÿlc_d©a_¡res
(
u64
 
ty³
, 
num_¡res
)

3929 cÚ¡ 
šdex
 = 
	`bŒfs_bg_æags_to_¿id_šdex
(
ty³
);

3930 cÚ¡ 
ncİ›s
 = 
bŒfs_¿id_¬¿y
[
šdex
].ncopies;

3931 cÚ¡ 
Å¬™y
 = 
bŒfs_¿id_¬¿y
[
šdex
].nparity;

3933  (
num_¡res
 - 
Å¬™y
è/ 
ncİ›s
;

3934 
	}
}

3937 
	$chunk_d¿nge_f‹r
(
ex‹Á_bufãr
 *
Ëaf
,

3938 
bŒfs_chunk
 *
chunk
,

3939 
bŒfs_b®ªû_¬gs
 *
b¬gs
)

3941 
bŒfs_¡re
 *
¡re
;

3942 
num_¡res
 = 
	`bŒfs_chunk_num_¡res
(
Ëaf
, 
chunk
);

3943 
u64
 
¡re_off£t
;

3944 
u64
 
¡re_Ëngth
;

3945 
u64
 
ty³
;

3946 
çùÜ
;

3947 
i
;

3949 ià(!(
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_DEVID
))

3952 
ty³
 = 
	`bŒfs_chunk_ty³
(
Ëaf
, 
chunk
);

3953 
çùÜ
 = 
	`ÿlc_d©a_¡res
(
ty³
, 
num_¡res
);

3955 
i
 = 0; i < 
num_¡res
; i++) {

3956 
¡re
 = 
	`bŒfs_¡re_Ä
(
chunk
, 
i
);

3957 ià(
	`bŒfs_¡re_devid
(
Ëaf
, 
¡re
è!ğ
b¬gs
->
devid
)

3960 
¡re_off£t
 = 
	`bŒfs_¡re_off£t
(
Ëaf
, 
¡re
);

3961 
¡re_Ëngth
 = 
	`bŒfs_chunk_Ëngth
(
Ëaf
, 
chunk
);

3962 
¡re_Ëngth
 = 
	`div_u64
(¡re_Ëngth, 
çùÜ
);

3964 ià(
¡re_off£t
 < 
b¬gs
->
³nd
 &&

3965 
¡re_off£t
 + 
¡re_Ëngth
 > 
b¬gs
->
p¡¬t
)

3970 
	}
}

3973 
	$chunk_v¿nge_f‹r
(
ex‹Á_bufãr
 *
Ëaf
,

3974 
bŒfs_chunk
 *
chunk
,

3975 
u64
 
chunk_off£t
,

3976 
bŒfs_b®ªû_¬gs
 *
b¬gs
)

3978 ià(
chunk_off£t
 < 
b¬gs
->
v’d
 &&

3979 
chunk_off£t
 + 
	`bŒfs_chunk_Ëngth
(
Ëaf
, 
chunk
è> 
b¬gs
->
v¡¬t
)

3984 
	}
}

3986 
	$chunk_¡res_¿nge_f‹r
(
ex‹Á_bufãr
 *
Ëaf
,

3987 
bŒfs_chunk
 *
chunk
,

3988 
bŒfs_b®ªû_¬gs
 *
b¬gs
)

3990 
num_¡res
 = 
	`bŒfs_chunk_num_¡res
(
Ëaf
, 
chunk
);

3992 ià(
b¬gs
->
¡res_mš
 <ğ
num_¡res


3993 && 
num_¡res
 <ğ
b¬gs
->
¡res_max
)

3997 
	}
}

3999 
	$chunk_soá_cÚv”t_f‹r
(
u64
 
chunk_ty³
,

4000 
bŒfs_b®ªû_¬gs
 *
b¬gs
)

4002 ià(!(
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
))

4005 
chunk_ty³
 = 
	`chunk_to_ex‹nded
(chunk_type) &

4006 
BTRFS_EXTENDED_PROFILE_MASK
;

4008 ià(
b¬gs
->
rg‘
 =ğ
chunk_ty³
)

4012 
	}
}

4014 
	$should_b®ªû_chunk
(
ex‹Á_bufãr
 *
Ëaf
,

4015 
bŒfs_chunk
 *
chunk
, 
u64
 
chunk_off£t
)

4017 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

4018 
bŒfs_b®ªû_cÚŒŞ
 *
bùl
 = 
fs_šfo
->
b®ªû_ùl
;

4019 
bŒfs_b®ªû_¬gs
 *
b¬gs
 = 
NULL
;

4020 
u64
 
chunk_ty³
 = 
	`bŒfs_chunk_ty³
(
Ëaf
, 
chunk
);

4023 ià(!((
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
) &

4024 (
bùl
->
æags
 & 
BTRFS_BALANCE_TYPE_MASK
))) {

4028 ià(
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_DATA
)

4029 
b¬gs
 = &
bùl
->
d©a
;

4030 ià(
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

4031 
b¬gs
 = &
bùl
->
sys
;

4032 ià(
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_METADATA
)

4033 
b¬gs
 = &
bùl
->
m‘a
;

4036 ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_PROFILES
) &&

4037 
	`chunk_´ofes_f‹r
(
chunk_ty³
, 
b¬gs
)) {

4042 ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_USAGE
) &&

4043 
	`chunk_u§ge_f‹r
(
fs_šfo
, 
chunk_off£t
, 
b¬gs
)) {

4045 } ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_USAGE_RANGE
) &&

4046 
	`chunk_u§ge_¿nge_f‹r
(
fs_šfo
, 
chunk_off£t
, 
b¬gs
)) {

4051 ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_DEVID
) &&

4052 
	`chunk_devid_f‹r
(
Ëaf
, 
chunk
, 
b¬gs
)) {

4057 ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_DRANGE
) &&

4058 
	`chunk_d¿nge_f‹r
(
Ëaf
, 
chunk
, 
b¬gs
)) {

4063 ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_VRANGE
) &&

4064 
	`chunk_v¿nge_f‹r
(
Ëaf
, 
chunk
, 
chunk_off£t
, 
b¬gs
)) {

4069 ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_STRIPES_RANGE
) &&

4070 
	`chunk_¡res_¿nge_f‹r
(
Ëaf
, 
chunk
, 
b¬gs
)) {

4075 ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_SOFT
) &&

4076 
	`chunk_soá_cÚv”t_f‹r
(
chunk_ty³
, 
b¬gs
)) {

4083 ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_LIMIT
)) {

4084 ià(
b¬gs
->
lim™
 == 0)

4087 
b¬gs
->
lim™
--;

4088 } ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_LIMIT_RANGE
)) {

4094 ià(
b¬gs
->
lim™_max
 == 0)

4097 
b¬gs
->
lim™_max
--;

4101 
	}
}

4103 
	$__bŒfs_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
)

4105 
bŒfs_b®ªû_cÚŒŞ
 *
bùl
 = 
fs_šfo
->
b®ªû_ùl
;

4106 
bŒfs_roÙ
 *
chunk_roÙ
 = 
fs_šfo
->chunk_root;

4107 
u64
 
chunk_ty³
;

4108 
bŒfs_chunk
 *
chunk
;

4109 
bŒfs_·th
 *
·th
 = 
NULL
;

4110 
bŒfs_key
 
key
;

4111 
bŒfs_key
 
found_key
;

4112 
ex‹Á_bufãr
 *
Ëaf
;

4113 
¦Ù
;

4114 
»t
;

4115 
’o¥c_”rÜs
 = 0;

4116 
boŞ
 
couÁšg
 = 
Œue
;

4118 
u64
 
lim™_d©a
 = 
bùl
->
d©a
.
lim™
;

4119 
u64
 
lim™_m‘a
 = 
bùl
->
m‘a
.
lim™
;

4120 
u64
 
lim™_sys
 = 
bùl
->
sys
.
lim™
;

4121 
u32
 
couÁ_d©a
 = 0;

4122 
u32
 
couÁ_m‘a
 = 0;

4123 
u32
 
couÁ_sys
 = 0;

4124 
chunk_»£rved
 = 0;

4126 
·th
 = 
	`bŒfs_®loc_·th
();

4127 ià(!
·th
) {

4128 
»t
 = -
ENOMEM
;

4129 
”rÜ
;

4133 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

4134 
	`mem£t
(&
bùl
->
¡©
, 0, (bctl->stat));

4135 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

4136 
agaš
:

4137 ià(!
couÁšg
) {

4142 
bùl
->
d©a
.
lim™
 = 
lim™_d©a
;

4143 
bùl
->
m‘a
.
lim™
 = 
lim™_m‘a
;

4144 
bùl
->
sys
.
lim™
 = 
lim™_sys
;

4146 
key
.
objeùid
 = 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
;

4147 
key
.
off£t
 = (
u64
)-1;

4148 
key
.
ty³
 = 
BTRFS_CHUNK_ITEM_KEY
;

4151 ià((!
couÁšg
 && 
	`©omic_»ad
(&
fs_šfo
->
b®ªû_·u£_»q
)) ||

4152 
	`©omic_»ad
(&
fs_šfo
->
b®ªû_ÿnûl_»q
)) {

4153 
»t
 = -
ECANCELED
;

4154 
”rÜ
;

4157 
	`mu‹x_lock
(&
fs_šfo
->
»şaim_bgs_lock
);

4158 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
chunk_roÙ
, &
key
, 
·th
, 0, 0);

4159 ià(
»t
 < 0) {

4160 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

4161 
”rÜ
;

4168 ià(
»t
 == 0)

4169 
	`BUG
();

4171 
»t
 = 
	`bŒfs_´evious_™em
(
chunk_roÙ
, 
·th
, 0,

4172 
BTRFS_CHUNK_ITEM_KEY
);

4173 ià(
»t
) {

4174 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

4175 
»t
 = 0;

4179 
Ëaf
 = 
·th
->
nodes
[0];

4180 
¦Ù
 = 
·th
->
¦Ùs
[0];

4181 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
found_key
, 
¦Ù
);

4183 ià(
found_key
.
objeùid
 !ğ
key
.objectid) {

4184 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

4188 
chunk
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_chunk
);

4189 
chunk_ty³
 = 
	`bŒfs_chunk_ty³
(
Ëaf
, 
chunk
);

4191 ià(!
couÁšg
) {

4192 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

4193 
bùl
->
¡©
.
cÚsid”ed
++;

4194 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

4197 
»t
 = 
	`should_b®ªû_chunk
(
Ëaf
, 
chunk
, 
found_key
.
off£t
);

4199 
	`bŒfs_»Ëa£_·th
(
·th
);

4200 ià(!
»t
) {

4201 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

4202 
loİ
;

4205 ià(
couÁšg
) {

4206 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

4207 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

4208 
bùl
->
¡©
.
ex³ùed
++;

4209 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

4211 ià(
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_DATA
)

4212 
couÁ_d©a
++;

4213 ià(
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

4214 
couÁ_sys
++;

4215 ià(
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_METADATA
)

4216 
couÁ_m‘a
++;

4218 
loİ
;

4225 ià(((
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_DATA
) &&

4226 
couÁ_d©a
 < 
bùl
->
d©a
.
lim™_mš
)

4227 || ((
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_METADATA
) &&

4228 
couÁ_m‘a
 < 
bùl
->
m‘a
.
lim™_mš
)

4229 || ((
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) &&

4230 
couÁ_sys
 < 
bùl
->
sys
.
lim™_mš
)) {

4231 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

4232 
loİ
;

4235 ià(!
chunk_»£rved
) {

4242 
»t
 = 
	`bŒfs_may_®loc_d©a_chunk
(
fs_šfo
,

4243 
found_key
.
off£t
);

4244 ià(
»t
 < 0) {

4245 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

4246 
”rÜ
;

4247 } ià(
»t
 == 1) {

4248 
chunk_»£rved
 = 1;

4252 
»t
 = 
	`bŒfs_»loÿ‹_chunk
(
fs_šfo
, 
found_key
.
off£t
);

4253 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

4254 ià(
»t
 =ğ-
ENOSPC
) {

4255 
’o¥c_”rÜs
++;

4256 } ià(
»t
 =ğ-
ETXTBSY
) {

4257 
	`bŒfs_šfo
(
fs_šfo
,

4259 
found_key
.
off£t
);

4260 
»t
 = 0;

4261 } ià(
»t
) {

4262 
”rÜ
;

4264 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

4265 
bùl
->
¡©
.
com¶‘ed
++;

4266 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

4268 
loİ
:

4269 ià(
found_key
.
off£t
 == 0)

4271 
key
.
off£t
 = 
found_key
.offset - 1;

4274 ià(
couÁšg
) {

4275 
	`bŒfs_»Ëa£_·th
(
·th
);

4276 
couÁšg
 = 
çl£
;

4277 
agaš
;

4279 
”rÜ
:

4280 
	`bŒfs_ä“_·th
(
·th
);

4281 ià(
’o¥c_”rÜs
) {

4282 
	`bŒfs_šfo
(
fs_šfo
, "%dƒnospcƒrrors during balance",

4283 
’o¥c_”rÜs
);

4284 ià(!
»t
)

4285 
»t
 = -
ENOSPC
;

4288  
»t
;

4289 
	}
}

4297 
	$®loc_´ofe_is_v®id
(
u64
 
æags
, 
ex‹nded
)

4299 
u64
 
mask
 = (
ex‹nded
 ? 
BTRFS_EXTENDED_PROFILE_MASK
 :

4300 
BTRFS_BLOCK_GROUP_PROFILE_MASK
);

4302 
æags
 &ğ~
BTRFS_BLOCK_GROUP_TYPE_MASK
;

4305 ià(
æags
 & ~
mask
)

4309 ià(
æags
 == 0)

4310  !
ex‹nded
;

4312  
	`has_sšgË_b™_£t
(
æags
);

4313 
	}
}

4319 
šlše
 
	$v®id©e_cÚv”t_´ofe
(
bŒfs_fs_šfo
 *
fs_šfo
,

4320 cÚ¡ 
bŒfs_b®ªû_¬gs
 *
b¬gs
,

4321 
u64
 
®lowed
, cÚ¡ *
ty³
)

4323 ià(!(
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
))

4324  
Œue
;

4327 ià(
	`®loc_´ofe_is_v®id
(
b¬gs
->
rg‘
, 1) &&

4328 (
b¬gs
->
rg‘
 & ~
®lowed
) == 0)

4329  
Œue
;

4331 
	`bŒfs_”r
(
fs_šfo
, "balance: invalid convert %s…rofile %s",

4332 
ty³
, 
	`bŒfs_bg_ty³_to_¿id_Çme
(
b¬gs
->
rg‘
));

4333  
çl£
;

4334 
	}
}

4341 
	$desüibe_b®ªû_¬gs
(
bŒfs_b®ªû_¬gs
 *
b¬gs
, *
buf
,

4342 
u32
 
size_buf
)

4344 
»t
;

4345 
u32
 
size_bp
 = 
size_buf
;

4346 *
bp
 = 
buf
;

4347 
u64
 
æags
 = 
b¬gs
->flags;

4348 
tmp_buf
[128] = {'\0'};

4350 ià(!
æags
)

4353 
	#CHECK_APPEND_NOARG
(
a
) \

4355 
»t
 = 
	`¢´štf
(
bp
, 
size_bp
, (
a
)); \

4356 ià(
»t
 < 0 ||„‘ >ğ
size_bp
) \

4357 
out_ov”æow
; \

4358 
size_bp
 -ğ
»t
; \

4359 
bp
 +ğ
»t
; \

4360 } 0)

	)

4362 
	#CHECK_APPEND_1ARG
(
a
, 
v1
) \

4364 
»t
 = 
	`¢´štf
(
bp
, 
size_bp
, (
a
), (
v1
)); \

4365 ià(
»t
 < 0 ||„‘ >ğ
size_bp
) \

4366 
out_ov”æow
; \

4367 
size_bp
 -ğ
»t
; \

4368 
bp
 +ğ
»t
; \

4369 } 0)

	)

4371 
	#CHECK_APPEND_2ARG
(
a
, 
v1
, 
v2
) \

4373 
»t
 = 
	`¢´štf
(
bp
, 
size_bp
, (
a
), (
v1
), (
v2
)); \

4374 ià(
»t
 < 0 ||„‘ >ğ
size_bp
) \

4375 
out_ov”æow
; \

4376 
size_bp
 -ğ
»t
; \

4377 
bp
 +ğ
»t
; \

4378 } 0)

	)

4380 ià(
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)

4381 
	`CHECK_APPEND_1ARG
("convert=%s,",

4382 
	`bŒfs_bg_ty³_to_¿id_Çme
(
b¬gs
->
rg‘
));

4384 ià(
æags
 & 
BTRFS_BALANCE_ARGS_SOFT
)

4385 
	`CHECK_APPEND_NOARG
("soft,");

4387 ià(
æags
 & 
BTRFS_BALANCE_ARGS_PROFILES
) {

4388 
	`bŒfs_desüibe_block_groups
(
b¬gs
->
´ofes
, 
tmp_buf
,

4389 (
tmp_buf
));

4390 
	`CHECK_APPEND_1ARG
("´ofes=%s,", 
tmp_buf
);

4393 ià(
æags
 & 
BTRFS_BALANCE_ARGS_USAGE
)

4394 
	`CHECK_APPEND_1ARG
("u§ge=%Îu,", 
b¬gs
->
u§ge
);

4396 ià(
æags
 & 
BTRFS_BALANCE_ARGS_USAGE_RANGE
)

4397 
	`CHECK_APPEND_2ARG
("usage=%u..%u,",

4398 
b¬gs
->
u§ge_mš
, b¬gs->
u§ge_max
);

4400 ià(
æags
 & 
BTRFS_BALANCE_ARGS_DEVID
)

4401 
	`CHECK_APPEND_1ARG
("devid=%Îu,", 
b¬gs
->
devid
);

4403 ià(
æags
 & 
BTRFS_BALANCE_ARGS_DRANGE
)

4404 
	`CHECK_APPEND_2ARG
("drange=%llu..%llu,",

4405 
b¬gs
->
p¡¬t
, b¬gs->
³nd
);

4407 ià(
æags
 & 
BTRFS_BALANCE_ARGS_VRANGE
)

4408 
	`CHECK_APPEND_2ARG
("vrange=%llu..%llu,",

4409 
b¬gs
->
v¡¬t
, b¬gs->
v’d
);

4411 ià(
æags
 & 
BTRFS_BALANCE_ARGS_LIMIT
)

4412 
	`CHECK_APPEND_1ARG
("lim™=%Îu,", 
b¬gs
->
lim™
);

4414 ià(
æags
 & 
BTRFS_BALANCE_ARGS_LIMIT_RANGE
)

4415 
	`CHECK_APPEND_2ARG
("limit=%u..%u,",

4416 
b¬gs
->
lim™_mš
, b¬gs->
lim™_max
);

4418 ià(
æags
 & 
BTRFS_BALANCE_ARGS_STRIPES_RANGE
)

4419 
	`CHECK_APPEND_2ARG
("stripes=%u..%u,",

4420 
b¬gs
->
¡res_mš
, b¬gs->
¡res_max
);

4422 #undeà
CHECK_APPEND_2ARG


4423 #undeà
CHECK_APPEND_1ARG


4424 #undeà
CHECK_APPEND_NOARG


4426 
out_ov”æow
:

4428 ià(
size_bp
 < 
size_buf
)

4429 
buf
[
size_buf
 - 
size_bp
 - 1] = '\0';

4431 
buf
[0] = '\0';

4432 
	}
}

4434 
	$desüibe_b®ªû_¡¬t_Ü_»sume
(
bŒfs_fs_šfo
 *
fs_šfo
)

4436 
u32
 
size_buf
 = 1024;

4437 
tmp_buf
[192] = {'\0'};

4438 *
buf
;

4439 *
bp
;

4440 
u32
 
size_bp
 = 
size_buf
;

4441 
»t
;

4442 
bŒfs_b®ªû_cÚŒŞ
 *
bùl
 = 
fs_šfo
->
b®ªû_ùl
;

4444 
buf
 = 
	`kz®loc
(
size_buf
, 
GFP_KERNEL
);

4445 ià(!
buf
)

4448 
bp
 = 
buf
;

4450 
	#CHECK_APPEND_1ARG
(
a
, 
v1
) \

4452 
»t
 = 
	`¢´štf
(
bp
, 
size_bp
, (
a
), (
v1
)); \

4453 ià(
»t
 < 0 ||„‘ >ğ
size_bp
) \

4454 
out_ov”æow
; \

4455 
size_bp
 -ğ
»t
; \

4456 
bp
 +ğ
»t
; \

4457 } 0)

	)

4459 ià(
bùl
->
æags
 & 
BTRFS_BALANCE_FORCE
)

4460 
	`CHECK_APPEND_1ARG
("%s", "-f ");

4462 ià(
bùl
->
æags
 & 
BTRFS_BALANCE_DATA
) {

4463 
	`desüibe_b®ªû_¬gs
(&
bùl
->
d©a
, 
tmp_buf
, (tmp_buf));

4464 
	`CHECK_APPEND_1ARG
("-d% ", 
tmp_buf
);

4467 ià(
bùl
->
æags
 & 
BTRFS_BALANCE_METADATA
) {

4468 
	`desüibe_b®ªû_¬gs
(&
bùl
->
m‘a
, 
tmp_buf
, (tmp_buf));

4469 
	`CHECK_APPEND_1ARG
("-m% ", 
tmp_buf
);

4472 ià(
bùl
->
æags
 & 
BTRFS_BALANCE_SYSTEM
) {

4473 
	`desüibe_b®ªû_¬gs
(&
bùl
->
sys
, 
tmp_buf
, (tmp_buf));

4474 
	`CHECK_APPEND_1ARG
("-s% ", 
tmp_buf
);

4477 #undeà
CHECK_APPEND_1ARG


4479 
out_ov”æow
:

4481 ià(
size_bp
 < 
size_buf
)

4482 
buf
[
size_buf
 - 
size_bp
 - 1] = '\0';

4483 
	`bŒfs_šfo
(
fs_šfo
, "balance: %s %s",

4484 (
bùl
->
æags
 & 
BTRFS_BALANCE_RESUME
) ?

4485 "»sume" : "¡¬t", 
buf
);

4487 
	`kä“
(
buf
);

4488 
	}
}

4493 
	$bŒfs_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
,

4494 
bŒfs_b®ªû_cÚŒŞ
 *
bùl
,

4495 
bŒfs_ioùl_b®ªû_¬gs
 *
b¬gs
)

4497 
u64
 
m‘a_rg‘
, 
d©a_rg‘
;

4498 
u64
 
®lowed
;

4499 
mixed
 = 0;

4500 
»t
;

4501 
u64
 
num_deviûs
;

4502 
£q
;

4503 
boŞ
 
»ducšg_»dundªcy
;

4504 
boŞ
 
·u£d
 = 
çl£
;

4505 
i
;

4507 ià(
	`bŒfs_fs_şosšg
(
fs_šfo
) ||

4508 
	`©omic_»ad
(&
fs_šfo
->
b®ªû_·u£_»q
) ||

4509 
	`bŒfs_should_ÿnûl_b®ªû
(
fs_šfo
)) {

4510 
»t
 = -
EINVAL
;

4511 
out
;

4514 
®lowed
 = 
	`bŒfs_su³r_šcom·t_æags
(
fs_šfo
->
su³r_cİy
);

4515 ià(
®lowed
 & 
BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
)

4516 
mixed
 = 1;

4522 
®lowed
 = 
BTRFS_BALANCE_DATA
 | 
BTRFS_BALANCE_METADATA
;

4523 ià(
mixed
 && (
bùl
->
æags
 & 
®lowed
)) {

4524 ià(!(
bùl
->
æags
 & 
BTRFS_BALANCE_DATA
) ||

4525 !(
bùl
->
æags
 & 
BTRFS_BALANCE_METADATA
) ||

4526 
	`memcmp
(&
bùl
->
d©a
, &bùl->
m‘a
, (bctl->data))) {

4527 
	`bŒfs_”r
(
fs_šfo
,

4529 
»t
 = -
EINVAL
;

4530 
out
;

4538 
num_deviûs
 = 
fs_šfo
->
fs_deviûs
->
rw_deviûs
;

4545 
®lowed
 = 
BTRFS_AVAIL_ALLOC_BIT_SINGLE
;

4546 
i
 = 0; i < 
	`ARRAY_SIZE
(
bŒfs_¿id_¬¿y
); i++)

4547 ià(
num_deviûs
 >ğ
bŒfs_¿id_¬¿y
[
i
].
devs_mš
)

4548 
®lowed
 |ğ
bŒfs_¿id_¬¿y
[
i
].
bg_æag
;

4550 ià(!
	`v®id©e_cÚv”t_´ofe
(
fs_šfo
, &
bùl
->
d©a
, 
®lowed
, "data") ||

4551 !
	`v®id©e_cÚv”t_´ofe
(
fs_šfo
, &
bùl
->
m‘a
, 
®lowed
, "metadata") ||

4552 !
	`v®id©e_cÚv”t_´ofe
(
fs_šfo
, &
bùl
->
sys
, 
®lowed
, "system")) {

4553 
»t
 = -
EINVAL
;

4554 
out
;

4561 
®lowed
 = 0;

4562 
i
 = 0; i < 
	`ARRAY_SIZE
(
bŒfs_¿id_¬¿y
); i++) {

4563 ià(
bŒfs_¿id_¬¿y
[
i
].
ncİ›s
 >= 2 ||

4564 
bŒfs_¿id_¬¿y
[
i
].
tŞ”©ed_çu»s
 >= 1)

4565 
®lowed
 |ğ
bŒfs_¿id_¬¿y
[
i
].
bg_æag
;

4568 
£q
 = 
	`»ad_£qbegš
(&
fs_šfo
->
´ofes_lock
);

4570 ià(((
bùl
->
sys
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) &&

4571 (
fs_šfo
->
ava_sy¡em_®loc_b™s
 & 
®lowed
) &&

4572 !(
bùl
->
sys
.
rg‘
 & 
®lowed
)) ||

4573 ((
bùl
->
m‘a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) &&

4574 (
fs_šfo
->
ava_m‘ad©a_®loc_b™s
 & 
®lowed
) &&

4575 !(
bùl
->
m‘a
.
rg‘
 & 
®lowed
)))

4576 
»ducšg_»dundªcy
 = 
Œue
;

4578 
»ducšg_»dundªcy
 = 
çl£
;

4581 
m‘a_rg‘
 = (
bùl
->
m‘a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) ?

4582 
bùl
->
m‘a
.
rg‘
 : 
fs_šfo
->
ava_m‘ad©a_®loc_b™s
;

4583 
d©a_rg‘
 = (
bùl
->
d©a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) ?

4584 
bùl
->
d©a
.
rg‘
 : 
fs_šfo
->
ava_d©a_®loc_b™s
;

4585 } 
	`»ad_£q»Œy
(&
fs_šfo
->
´ofes_lock
, 
£q
));

4587 ià(
»ducšg_»dundªcy
) {

4588 ià(
bùl
->
æags
 & 
BTRFS_BALANCE_FORCE
) {

4589 
	`bŒfs_šfo
(
fs_šfo
,

4592 
	`bŒfs_”r
(
fs_šfo
,

4594 
»t
 = -
EINVAL
;

4595 
out
;

4599 ià(
	`bŒfs_g‘_num_tŞ”©ed_disk_b¬r›r_çu»s
(
m‘a_rg‘
) <

4600 
	`bŒfs_g‘_num_tŞ”©ed_disk_b¬r›r_çu»s
(
d©a_rg‘
)) {

4601 
	`bŒfs_w¬n
(
fs_šfo
,

4603 
	`bŒfs_bg_ty³_to_¿id_Çme
(
m‘a_rg‘
),

4604 
	`bŒfs_bg_ty³_to_¿id_Çme
(
d©a_rg‘
));

4607 
»t
 = 
	`š£¹_b®ªû_™em
(
fs_šfo
, 
bùl
);

4608 ià(
»t
 &&„‘ !ğ-
EEXIST
)

4609 
out
;

4611 ià(!(
bùl
->
æags
 & 
BTRFS_BALANCE_RESUME
)) {

4612 
	`BUG_ON
(
»t
 =ğ-
EEXIST
);

4613 
	`BUG_ON
(
fs_šfo
->
b®ªû_ùl
);

4614 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

4615 
fs_šfo
->
b®ªû_ùl
 = 
bùl
;

4616 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

4618 
	`BUG_ON
(
»t
 !ğ-
EEXIST
);

4619 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

4620 
	`upd©e_b®ªû_¬gs
(
bùl
);

4621 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

4624 
	`ASSERT
(!
	`‹¡_b™
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_šfo
->
æags
));

4625 
	`£t_b™
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_šfo
->
æags
);

4626 
	`desüibe_b®ªû_¡¬t_Ü_»sume
(
fs_šfo
);

4627 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4629 
»t
 = 
	`__bŒfs_b®ªû
(
fs_šfo
);

4631 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4632 ià(
»t
 =ğ-
ECANCELED
 && 
	`©omic_»ad
(&
fs_šfo
->
b®ªû_·u£_»q
)) {

4633 
	`bŒfs_šfo
(
fs_šfo
, "balance:…aused");

4634 
	`bŒfs_exşİ_b®ªû
(
fs_šfo
, 
BTRFS_EXCLOP_BALANCE_PAUSED
);

4635 
·u£d
 = 
Œue
;

4652 ià(
»t
 =ğ-
ECANCELED
 ||„‘ =ğ-
EINTR
)

4653 
	`bŒfs_šfo
(
fs_šfo
, "balance: canceled");

4655 
	`bŒfs_šfo
(
fs_šfo
, "b®ªû:ƒnded w™h stus: %d", 
»t
);

4657 
	`ş—r_b™
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_šfo
->
æags
);

4659 ià(
b¬gs
) {

4660 
	`mem£t
(
b¬gs
, 0, (*bargs));

4661 
	`bŒfs_upd©e_ioùl_b®ªû_¬gs
(
fs_šfo
, 
b¬gs
);

4665 ià(!
·u£d
) {

4666 
	`»£t_b®ªû_¡©e
(
fs_šfo
);

4667 
	`bŒfs_exşİ_fšish
(
fs_šfo
);

4670 
	`wake_up
(&
fs_šfo
->
b®ªû_wa™_q
);

4672  
»t
;

4673 
out
:

4674 ià(
bùl
->
æags
 & 
BTRFS_BALANCE_RESUME
)

4675 
	`»£t_b®ªû_¡©e
(
fs_šfo
);

4677 
	`kä“
(
bùl
);

4678 
	`bŒfs_exşİ_fšish
(
fs_šfo
);

4680  
»t
;

4681 
	}
}

4683 
	$b®ªû_kth»ad
(*
d©a
)

4685 
bŒfs_fs_šfo
 *
fs_šfo
 = 
d©a
;

4686 
»t
 = 0;

4688 
	`sb_¡¬t_wr™e
(
fs_šfo
->
sb
);

4689 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4690 ià(
fs_šfo
->
b®ªû_ùl
)

4691 
»t
 = 
	`bŒfs_b®ªû
(
fs_šfo
, fs_šfo->
b®ªû_ùl
, 
NULL
);

4692 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4693 
	`sb_’d_wr™e
(
fs_šfo
->
sb
);

4695  
»t
;

4696 
	}
}

4698 
	$bŒfs_»sume_b®ªû_async
(
bŒfs_fs_šfo
 *
fs_šfo
)

4700 
sk_¡ruù
 *
tsk
;

4702 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4703 ià(!
fs_šfo
->
b®ªû_ùl
) {

4704 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4707 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4709 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
SKIP_BALANCE
)) {

4710 
	`bŒfs_šfo
(
fs_šfo
, "balance:„esume skipped");

4714 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

4715 
	`ASSERT
(
fs_šfo
->
exşusive_İ”©iÚ
 =ğ
BTRFS_EXCLOP_BALANCE_PAUSED
);

4716 
fs_šfo
->
exşusive_İ”©iÚ
 = 
BTRFS_EXCLOP_BALANCE
;

4717 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

4723 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

4724 
fs_šfo
->
b®ªû_ùl
->
æags
 |ğ
BTRFS_BALANCE_RESUME
;

4725 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

4727 
tsk
 = 
	`kth»ad_run
(
b®ªû_kth»ad
, 
fs_šfo
, "btrfs-balance");

4728  
	`PTR_ERR_OR_ZERO
(
tsk
);

4729 
	}
}

4731 
	$bŒfs_»cov”_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
)

4733 
bŒfs_b®ªû_cÚŒŞ
 *
bùl
;

4734 
bŒfs_b®ªû_™em
 *
™em
;

4735 
bŒfs_disk_b®ªû_¬gs
 
disk_b¬gs
;

4736 
bŒfs_·th
 *
·th
;

4737 
ex‹Á_bufãr
 *
Ëaf
;

4738 
bŒfs_key
 
key
;

4739 
»t
;

4741 
·th
 = 
	`bŒfs_®loc_·th
();

4742 ià(!
·th
)

4743  -
ENOMEM
;

4745 
key
.
objeùid
 = 
BTRFS_BALANCE_OBJECTID
;

4746 
key
.
ty³
 = 
BTRFS_TEMPORARY_ITEM_KEY
;

4747 
key
.
off£t
 = 0;

4749 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_šfo
->
Œ“_roÙ
, &
key
, 
·th
, 0, 0);

4750 ià(
»t
 < 0)

4751 
out
;

4752 ià(
»t
 > 0) {

4753 
»t
 = 0;

4754 
out
;

4757 
bùl
 = 
	`kz®loc
((*bùl), 
GFP_NOFS
);

4758 ià(!
bùl
) {

4759 
»t
 = -
ENOMEM
;

4760 
out
;

4763 
Ëaf
 = 
·th
->
nodes
[0];

4764 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_b®ªû_™em
);

4766 
bùl
->
æags
 = 
	`bŒfs_b®ªû_æags
(
Ëaf
, 
™em
);

4767 
bùl
->
æags
 |ğ
BTRFS_BALANCE_RESUME
;

4769 
	`bŒfs_b®ªû_d©a
(
Ëaf
, 
™em
, &
disk_b¬gs
);

4770 
	`bŒfs_disk_b®ªû_¬gs_to_ıu
(&
bùl
->
d©a
, &
disk_b¬gs
);

4771 
	`bŒfs_b®ªû_m‘a
(
Ëaf
, 
™em
, &
disk_b¬gs
);

4772 
	`bŒfs_disk_b®ªû_¬gs_to_ıu
(&
bùl
->
m‘a
, &
disk_b¬gs
);

4773 
	`bŒfs_b®ªû_sys
(
Ëaf
, 
™em
, &
disk_b¬gs
);

4774 
	`bŒfs_disk_b®ªû_¬gs_to_ıu
(&
bùl
->
sys
, &
disk_b¬gs
);

4786 ià(!
	`bŒfs_exşİ_¡¬t
(
fs_šfo
, 
BTRFS_EXCLOP_BALANCE_PAUSED
))

4787 
	`bŒfs_w¬n
(
fs_šfo
,

4790 
	`bŒfs_»Ëa£_·th
(
·th
);

4792 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4793 
	`BUG_ON
(
fs_šfo
->
b®ªû_ùl
);

4794 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

4795 
fs_šfo
->
b®ªû_ùl
 = 
bùl
;

4796 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

4797 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4798 
out
:

4799 
	`bŒfs_ä“_·th
(
·th
);

4800  
»t
;

4801 
	}
}

4803 
	$bŒfs_·u£_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
)

4805 
»t
 = 0;

4807 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4808 ià(!
fs_šfo
->
b®ªû_ùl
) {

4809 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4810  -
ENOTCONN
;

4813 ià(
	`‹¡_b™
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_šfo
->
æags
)) {

4814 
	`©omic_šc
(&
fs_šfo
->
b®ªû_·u£_»q
);

4815 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4817 
	`wa™_ev’t
(
fs_šfo
->
b®ªû_wa™_q
,

4818 !
	`‹¡_b™
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_šfo
->
æags
));

4820 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4822 
	`BUG_ON
(
	`‹¡_b™
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_šfo
->
æags
));

4823 
	`©omic_dec
(&
fs_šfo
->
b®ªû_·u£_»q
);

4825 
»t
 = -
ENOTCONN
;

4828 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4829  
»t
;

4830 
	}
}

4832 
	$bŒfs_ÿnûl_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
)

4834 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4835 ià(!
fs_šfo
->
b®ªû_ùl
) {

4836 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4837  -
ENOTCONN
;

4845 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
)) {

4846 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4847  -
EROFS
;

4850 
	`©omic_šc
(&
fs_šfo
->
b®ªû_ÿnûl_»q
);

4855 ià(
	`‹¡_b™
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_šfo
->
æags
)) {

4856 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4857 
	`wa™_ev’t
(
fs_šfo
->
b®ªû_wa™_q
,

4858 !
	`‹¡_b™
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_šfo
->
æags
));

4859 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4861 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4866 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4868 ià(
fs_šfo
->
b®ªû_ùl
) {

4869 
	`»£t_b®ªû_¡©e
(
fs_šfo
);

4870 
	`bŒfs_exşİ_fšish
(
fs_šfo
);

4871 
	`bŒfs_šfo
(
fs_šfo
, "balance: canceled");

4875 
	`ASSERT
(!
	`‹¡_b™
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_šfo
->
æags
));

4876 
	`©omic_dec
(&
fs_šfo
->
b®ªû_ÿnûl_»q
);

4877 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4879 
	}
}

4881 
	$bŒfs_uuid_sÿn_kth»ad
(*
d©a
)

4883 
bŒfs_fs_šfo
 *
fs_šfo
 = 
d©a
;

4884 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

4885 
bŒfs_key
 
key
;

4886 
bŒfs_·th
 *
·th
 = 
NULL
;

4887 
»t
 = 0;

4888 
ex‹Á_bufãr
 *
eb
;

4889 
¦Ù
;

4890 
bŒfs_roÙ_™em
 
roÙ_™em
;

4891 
u32
 
™em_size
;

4892 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

4893 
boŞ
 
şosšg
 = 
çl£
;

4895 
·th
 = 
	`bŒfs_®loc_·th
();

4896 ià(!
·th
) {

4897 
»t
 = -
ENOMEM
;

4898 
out
;

4901 
key
.
objeùid
 = 0;

4902 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

4903 
key
.
off£t
 = 0;

4906 ià(
	`bŒfs_fs_şosšg
(
fs_šfo
)) {

4907 
şosšg
 = 
Œue
;

4910 
»t
 = 
	`bŒfs_£¬ch_fÜw¬d
(
roÙ
, &
key
, 
·th
,

4911 
BTRFS_OLDEST_GENERATION
);

4912 ià(
»t
) {

4913 ià(
»t
 > 0)

4914 
»t
 = 0;

4918 ià(
key
.
ty³
 !ğ
BTRFS_ROOT_ITEM_KEY
 ||

4919 (
key
.
objeùid
 < 
BTRFS_FIRST_FREE_OBJECTID
 &&

4920 
key
.
objeùid
 !ğ
BTRFS_FS_TREE_OBJECTID
) ||

4921 
key
.
objeùid
 > 
BTRFS_LAST_FREE_OBJECTID
)

4922 
sk
;

4924 
eb
 = 
·th
->
nodes
[0];

4925 
¦Ù
 = 
·th
->
¦Ùs
[0];

4926 
™em_size
 = 
	`bŒfs_™em_size
(
eb
, 
¦Ù
);

4927 ià(
™em_size
 < (
roÙ_™em
))

4928 
sk
;

4930 
	`»ad_ex‹Á_bufãr
(
eb
, &
roÙ_™em
,

4931 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
),

4932 ()(
roÙ_™em
));

4933 ià(
	`bŒfs_roÙ_»fs
(&
roÙ_™em
) == 0)

4934 
sk
;

4936 ià(!
	`bŒfs_is_em±y_uuid
(
roÙ_™em
.
uuid
) ||

4937 !
	`bŒfs_is_em±y_uuid
(
roÙ_™em
.
»ûived_uuid
)) {

4938 ià(
Œªs
)

4939 
upd©e_Œ“
;

4941 
	`bŒfs_»Ëa£_·th
(
·th
);

4946 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
fs_šfo
->
uuid_roÙ
, 2);

4947 ià(
	`IS_ERR
(
Œªs
)) {

4948 
»t
 = 
	`PTR_ERR
(
Œªs
);

4953 
sk
;

4955 
upd©e_Œ“
:

4956 
	`bŒfs_»Ëa£_·th
(
·th
);

4957 ià(!
	`bŒfs_is_em±y_uuid
(
roÙ_™em
.
uuid
)) {

4958 
»t
 = 
	`bŒfs_uuid_Œ“_add
(
Œªs
, 
roÙ_™em
.
uuid
,

4959 
BTRFS_UUID_KEY_SUBVOL
,

4960 
key
.
objeùid
);

4961 ià(
»t
 < 0) {

4962 
	`bŒfs_w¬n
(
fs_šfo
, "uuid_tree_add failed %d",

4963 
»t
);

4968 ià(!
	`bŒfs_is_em±y_uuid
(
roÙ_™em
.
»ûived_uuid
)) {

4969 
»t
 = 
	`bŒfs_uuid_Œ“_add
(
Œªs
,

4970 
roÙ_™em
.
»ûived_uuid
,

4971 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
,

4972 
key
.
objeùid
);

4973 ià(
»t
 < 0) {

4974 
	`bŒfs_w¬n
(
fs_šfo
, "uuid_tree_add failed %d",

4975 
»t
);

4980 
sk
:

4981 
	`bŒfs_»Ëa£_·th
(
·th
);

4982 ià(
Œªs
) {

4983 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4984 
Œªs
 = 
NULL
;

4985 ià(
»t
)

4989 ià(
key
.
off£t
 < (
u64
)-1) {

4990 
key
.
off£t
++;

4991 } ià(
key
.
ty³
 < 
BTRFS_ROOT_ITEM_KEY
) {

4992 
key
.
off£t
 = 0;

4993 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

4994 } ià(
key
.
objeùid
 < (
u64
)-1) {

4995 
key
.
off£t
 = 0;

4996 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

4997 
key
.
objeùid
++;

5001 
	`cÚd_»sched
();

5004 
out
:

5005 
	`bŒfs_ä“_·th
(
·th
);

5006 ià(
Œªs
 && !
	`IS_ERR
(trans))

5007 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

5008 ià(
»t
)

5009 
	`bŒfs_w¬n
(
fs_šfo
, "bŒfs_uuid_sÿn_kth»ad faed %d", 
»t
);

5010 ià(!
şosšg
)

5011 
	`£t_b™
(
BTRFS_FS_UPDATE_UUID_TREE_GEN
, &
fs_šfo
->
æags
);

5012 
	`up
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

5014 
	}
}

5016 
	$bŒfs_ü—‹_uuid_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
)

5018 
bŒfs_Œªs_hªdË
 *
Œªs
;

5019 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

5020 
bŒfs_roÙ
 *
uuid_roÙ
;

5021 
sk_¡ruù
 *
sk
;

5022 
»t
;

5028 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
Œ“_roÙ
, 2);

5029 ià(
	`IS_ERR
(
Œªs
))

5030  
	`PTR_ERR
(
Œªs
);

5032 
uuid_roÙ
 = 
	`bŒfs_ü—‹_Œ“
(
Œªs
, 
BTRFS_UUID_TREE_OBJECTID
);

5033 ià(
	`IS_ERR
(
uuid_roÙ
)) {

5034 
»t
 = 
	`PTR_ERR
(
uuid_roÙ
);

5035 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

5036 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

5037  
»t
;

5040 
fs_šfo
->
uuid_roÙ
 = uuid_root;

5042 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

5043 ià(
»t
)

5044  
»t
;

5046 
	`down
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

5047 
sk
 = 
	`kth»ad_run
(
bŒfs_uuid_sÿn_kth»ad
, 
fs_šfo
, "btrfs-uuid");

5048 ià(
	`IS_ERR
(
sk
)) {

5050 
	`bŒfs_w¬n
(
fs_šfo
, "failedo start uuid_scanask");

5051 
	`up
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

5052  
	`PTR_ERR
(
sk
);

5056 
	}
}

5063 
	$bŒfs_shršk_deviû
(
bŒfs_deviû
 *
deviû
, 
u64
 
Ãw_size
)

5065 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

5066 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

5067 
bŒfs_Œªs_hªdË
 *
Œªs
;

5068 
bŒfs_dev_ex‹Á
 *
dev_ex‹Á
 = 
NULL
;

5069 
bŒfs_·th
 *
·th
;

5070 
u64
 
Ëngth
;

5071 
u64
 
chunk_off£t
;

5072 
»t
;

5073 
¦Ù
;

5074 
çed
 = 0;

5075 
boŞ
 
»Œ›d
 = 
çl£
;

5076 
ex‹Á_bufãr
 *
l
;

5077 
bŒfs_key
 
key
;

5078 
bŒfs_su³r_block
 *
su³r_cİy
 = 
fs_šfo
->super_copy;

5079 
u64
 
Şd_tÙ®
 = 
	`bŒfs_su³r_tÙ®_by‹s
(
su³r_cİy
);

5080 
u64
 
Şd_size
 = 
	`bŒfs_deviû_g‘_tÙ®_by‹s
(
deviû
);

5081 
u64
 
diff
;

5082 
u64
 
¡¬t
;

5084 
Ãw_size
 = 
	`round_down
Òew_size, 
fs_šfo
->
£ùÜsize
);

5085 
¡¬t
 = 
Ãw_size
;

5086 
diff
 = 
	`round_down
(
Şd_size
 - 
Ãw_size
, 
fs_šfo
->
£ùÜsize
);

5088 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
))

5089  -
EINVAL
;

5091 
·th
 = 
	`bŒfs_®loc_·th
();

5092 ià(!
·th
)

5093  -
ENOMEM
;

5095 
·th
->
»ada
 = 
READA_BACK
;

5097 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

5098 ià(
	`IS_ERR
(
Œªs
)) {

5099 
	`bŒfs_ä“_·th
(
·th
);

5100  
	`PTR_ERR
(
Œªs
);

5103 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

5105 
	`bŒfs_deviû_£t_tÙ®_by‹s
(
deviû
, 
Ãw_size
);

5106 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
)) {

5107 
deviû
->
fs_deviûs
->
tÙ®_rw_by‹s
 -ğ
diff
;

5108 
	`©omic64_sub
(
diff
, &
fs_šfo
->
ä“_chunk_¥aû
);

5116 ià(
	`cÚšs_³ndšg_ex‹Á
(
deviû
, &
¡¬t
, 
diff
)) {

5117 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

5118 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

5119 ià(
»t
)

5120 
dÚe
;

5122 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

5123 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

5126 
agaš
:

5127 
key
.
objeùid
 = 
deviû
->
devid
;

5128 
key
.
off£t
 = (
u64
)-1;

5129 
key
.
ty³
 = 
BTRFS_DEV_EXTENT_KEY
;

5132 
	`mu‹x_lock
(&
fs_šfo
->
»şaim_bgs_lock
);

5133 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

5134 ià(
»t
 < 0) {

5135 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

5136 
dÚe
;

5139 
»t
 = 
	`bŒfs_´evious_™em
(
roÙ
, 
·th
, 0, 
key
.
ty³
);

5140 ià(
»t
) {

5141 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

5142 ià(
»t
 < 0)

5143 
dÚe
;

5144 
»t
 = 0;

5145 
	`bŒfs_»Ëa£_·th
(
·th
);

5149 
l
 = 
·th
->
nodes
[0];

5150 
¦Ù
 = 
·th
->
¦Ùs
[0];

5151 
	`bŒfs_™em_key_to_ıu
(
l
, &
key
, 
·th
->
¦Ùs
[0]);

5153 ià(
key
.
objeùid
 !ğ
deviû
->
devid
) {

5154 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

5155 
	`bŒfs_»Ëa£_·th
(
·th
);

5159 
dev_ex‹Á
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
, 
bŒfs_dev_ex‹Á
);

5160 
Ëngth
 = 
	`bŒfs_dev_ex‹Á_Ëngth
(
l
, 
dev_ex‹Á
);

5162 ià(
key
.
off£t
 + 
Ëngth
 <ğ
Ãw_size
) {

5163 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

5164 
	`bŒfs_»Ëa£_·th
(
·th
);

5168 
chunk_off£t
 = 
	`bŒfs_dev_ex‹Á_chunk_off£t
(
l
, 
dev_ex‹Á
);

5169 
	`bŒfs_»Ëa£_·th
(
·th
);

5177 
»t
 = 
	`bŒfs_may_®loc_d©a_chunk
(
fs_šfo
, 
chunk_off£t
);

5178 ià(
»t
 < 0) {

5179 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

5180 
dÚe
;

5183 
»t
 = 
	`bŒfs_»loÿ‹_chunk
(
fs_šfo
, 
chunk_off£t
);

5184 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

5185 ià(
»t
 =ğ-
ENOSPC
) {

5186 
çed
++;

5187 } ià(
»t
) {

5188 ià(
»t
 =ğ-
ETXTBSY
) {

5189 
	`bŒfs_w¬n
(
fs_šfo
,

5191 
chunk_off£t
);

5193 
dÚe
;

5195 } 
key
.
off£t
-- > 0);

5197 ià(
çed
 && !
»Œ›d
) {

5198 
çed
 = 0;

5199 
»Œ›d
 = 
Œue
;

5200 
agaš
;

5201 } ià(
çed
 && 
»Œ›d
) {

5202 
»t
 = -
ENOSPC
;

5203 
dÚe
;

5207 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

5208 ià(
	`IS_ERR
(
Œªs
)) {

5209 
»t
 = 
	`PTR_ERR
(
Œªs
);

5210 
dÚe
;

5213 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

5215 
	`ş—r_ex‹Á_b™s
(&
deviû
->
®loc_¡©e
, 
Ãw_size
, (
u64
)-1,

5216 
CHUNK_STATE_MASK
);

5218 
	`bŒfs_deviû_£t_disk_tÙ®_by‹s
(
deviû
, 
Ãw_size
);

5219 ià(
	`li¡_em±y
(&
deviû
->
po¡_comm™_li¡
))

5220 
	`li¡_add_
(&
deviû
->
po¡_comm™_li¡
,

5221 &
Œªs
->
Œª§ùiÚ
->
dev_upd©e_li¡
);

5223 
	`WARN_ON
(
diff
 > 
Şd_tÙ®
);

5224 
	`bŒfs_£t_su³r_tÙ®_by‹s
(
su³r_cİy
,

5225 
	`round_down
(
Şd_tÙ®
 - 
diff
, 
fs_šfo
->
£ùÜsize
));

5226 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

5228 
	`bŒfs_»£rve_chunk_m‘ad©a
(
Œªs
, 
çl£
);

5230 
»t
 = 
	`bŒfs_upd©e_deviû
(
Œªs
, 
deviû
);

5231 
	`bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
Œªs
);

5232 ià(
»t
 < 0) {

5233 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

5234 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

5236 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

5238 
dÚe
:

5239 
	`bŒfs_ä“_·th
(
·th
);

5240 ià(
»t
) {

5241 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

5242 
	`bŒfs_deviû_£t_tÙ®_by‹s
(
deviû
, 
Şd_size
);

5243 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
))

5244 
deviû
->
fs_deviûs
->
tÙ®_rw_by‹s
 +ğ
diff
;

5245 
	`©omic64_add
(
diff
, &
fs_šfo
->
ä“_chunk_¥aû
);

5246 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

5248  
»t
;

5249 
	}
}

5251 
	$bŒfs_add_sy¡em_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
,

5252 
bŒfs_key
 *
key
,

5253 
bŒfs_chunk
 *
chunk
, 
™em_size
)

5255 
bŒfs_su³r_block
 *
su³r_cİy
 = 
fs_šfo
->super_copy;

5256 
bŒfs_disk_key
 
disk_key
;

5257 
u32
 
¬¿y_size
;

5258 
u8
 *
±r
;

5260 
	`lockd•_as£¹_h–d
(&
fs_šfo
->
chunk_mu‹x
);

5262 
¬¿y_size
 = 
	`bŒfs_su³r_sys_¬¿y_size
(
su³r_cİy
);

5263 ià(
¬¿y_size
 + 
™em_size
 + (
disk_key
)

5264 > 
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
)

5265  -
EFBIG
;

5267 
±r
 = 
su³r_cİy
->
sys_chunk_¬¿y
 + 
¬¿y_size
;

5268 
	`bŒfs_ıu_key_to_disk
(&
disk_key
, 
key
);

5269 
	`memıy
(
±r
, &
disk_key
, (disk_key));

5270 
±r
 +ğ(
disk_key
);

5271 
	`memıy
(
±r
, 
chunk
, 
™em_size
);

5272 
™em_size
 +ğ(
disk_key
);

5273 
	`bŒfs_£t_su³r_sys_¬¿y_size
(
su³r_cİy
, 
¬¿y_size
 + 
™em_size
);

5276 
	}
}

5281 
	$bŒfs_cmp_deviû_šfo
(cÚ¡ *
a
, cÚ¡ *
b
)

5283 cÚ¡ 
bŒfs_deviû_šfo
 *
di_a
 = 
a
;

5284 cÚ¡ 
bŒfs_deviû_šfo
 *
di_b
 = 
b
;

5286 ià(
di_a
->
max_ava
 > 
di_b
->max_avail)

5288 ià(
di_a
->
max_ava
 < 
di_b
->max_avail)

5290 ià(
di_a
->
tÙ®_ava
 > 
di_b
->total_avail)

5292 ià(
di_a
->
tÙ®_ava
 < 
di_b
->total_avail)

5295 
	}
}

5297 
	$check_¿id56_šcom·t_æag
(
bŒfs_fs_šfo
 *
šfo
, 
u64
 
ty³
)

5299 ià(!(
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
))

5302 
	`bŒfs_£t_fs_šcom·t
(
šfo
, 
RAID56
);

5303 
	}
}

5305 
	$check_¿id1c34_šcom·t_æag
(
bŒfs_fs_šfo
 *
šfo
, 
u64
 
ty³
)

5307 ià(!(
ty³
 & (
BTRFS_BLOCK_GROUP_RAID1C3
 | 
BTRFS_BLOCK_GROUP_RAID1C4
)))

5310 
	`bŒfs_£t_fs_šcom·t
(
šfo
, 
RAID1C34
);

5311 
	}
}

5317 
	s®loc_chunk_ùl
 {

5318 
u64
 
	m¡¬t
;

5319 
u64
 
	mty³
;

5321 
	mnum_¡res
;

5323 
	msub_¡res
;

5325 
	mdev_¡res
;

5327 
	mdevs_max
;

5329 
	mdevs_mš
;

5331 
	mdevs_šüem’t
;

5333 
	mncİ›s
;

5335 
	mÅ¬™y
;

5336 
u64
 
	mmax_¡re_size
;

5337 
u64
 
	mmax_chunk_size
;

5338 
u64
 
	mdev_ex‹Á_mš
;

5339 
u64
 
	m¡re_size
;

5340 
u64
 
	mchunk_size
;

5341 
	mndevs
;

5344 
	$š™_®loc_chunk_ùl_pŞicy_»guÏr
(

5345 
bŒfs_fs_deviûs
 *
fs_deviûs
,

5346 
®loc_chunk_ùl
 *
ùl
)

5348 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

5350 
¥aû_šfo
 = 
	`bŒfs_fšd_¥aû_šfo
(
fs_deviûs
->
fs_šfo
, 
ùl
->
ty³
);

5351 
	`ASSERT
(
¥aû_šfo
);

5353 
ùl
->
max_chunk_size
 = 
	`READ_ONCE
(
¥aû_šfo
->
chunk_size
);

5354 
ùl
->
max_¡re_size
 = 
	`mš_t
(
u64
, c->
max_chunk_size
, 
SZ_1G
);

5356 ià(
ùl
->
ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

5357 
ùl
->
devs_max
 = 
	`mš_t
(, c->devs_max, 
BTRFS_MAX_DEVS_SYS_CHUNK
);

5360 
ùl
->
max_chunk_size
 = 
	`mš
(
	`muÉ_³rc
(
fs_deviûs
->
tÙ®_rw_by‹s
, 10),

5361 
ùl
->
max_chunk_size
);

5362 
ùl
->
dev_ex‹Á_mš
 = 
	`bŒfs_¡re_Ä_to_off£t
(ùl->
dev_¡res
);

5363 
	}
}

5365 
	$š™_®loc_chunk_ùl_pŞicy_zÚed
(

5366 
bŒfs_fs_deviûs
 *
fs_deviûs
,

5367 
®loc_chunk_ùl
 *
ùl
)

5369 
u64
 
zÚe_size
 = 
fs_deviûs
->
fs_šfo
->zone_size;

5370 
u64
 
lim™
;

5371 
mš_num_¡res
 = 
ùl
->
devs_mš
 * c->
dev_¡res
;

5372 
mš_d©a_¡res
 = (
mš_num_¡res
 - 
ùl
->
Å¬™y
è/ c->
ncİ›s
;

5373 
u64
 
mš_chunk_size
 = 
mš_d©a_¡res
 * 
zÚe_size
;

5374 
u64
 
ty³
 = 
ùl
->type;

5376 
ùl
->
max_¡re_size
 = 
zÚe_size
;

5377 ià(
ty³
 & 
BTRFS_BLOCK_GROUP_DATA
) {

5378 
ùl
->
max_chunk_size
 = 
	`round_down
(
BTRFS_MAX_DATA_CHUNK_SIZE
,

5379 
zÚe_size
);

5380 } ià(
ty³
 & 
BTRFS_BLOCK_GROUP_METADATA
) {

5381 
ùl
->
max_chunk_size
 = c->
max_¡re_size
;

5382 } ià(
ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) {

5383 
ùl
->
max_chunk_size
 = 2 * c->
max_¡re_size
;

5384 
ùl
->
devs_max
 = 
	`mš_t
(, ctl->devs_max,

5385 
BTRFS_MAX_DEVS_SYS_CHUNK
);

5387 
	`BUG
();

5391 
lim™
 = 
	`max
(
	`round_down
(
	`muÉ_³rc
(
fs_deviûs
->
tÙ®_rw_by‹s
, 10),

5392 
zÚe_size
),

5393 
mš_chunk_size
);

5394 
ùl
->
max_chunk_size
 = 
	`mš
(
lim™
, ctl->max_chunk_size);

5395 
ùl
->
dev_ex‹Á_mš
 = 
zÚe_size
 * c->
dev_¡res
;

5396 
	}
}

5398 
	$š™_®loc_chunk_ùl
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

5399 
®loc_chunk_ùl
 *
ùl
)

5401 
šdex
 = 
	`bŒfs_bg_æags_to_¿id_šdex
(
ùl
->
ty³
);

5403 
ùl
->
sub_¡res
 = 
bŒfs_¿id_¬¿y
[
šdex
].sub_stripes;

5404 
ùl
->
dev_¡res
 = 
bŒfs_¿id_¬¿y
[
šdex
].dev_stripes;

5405 
ùl
->
devs_max
 = 
bŒfs_¿id_¬¿y
[
šdex
].devs_max;

5406 ià(!
ùl
->
devs_max
)

5407 
ùl
->
devs_max
 = 
	`BTRFS_MAX_DEVS
(
fs_deviûs
->
fs_šfo
);

5408 
ùl
->
devs_mš
 = 
bŒfs_¿id_¬¿y
[
šdex
].devs_min;

5409 
ùl
->
devs_šüem’t
 = 
bŒfs_¿id_¬¿y
[
šdex
].devs_increment;

5410 
ùl
->
ncİ›s
 = 
bŒfs_¿id_¬¿y
[
šdex
].ncopies;

5411 
ùl
->
Å¬™y
 = 
bŒfs_¿id_¬¿y
[
šdex
].nparity;

5412 
ùl
->
ndevs
 = 0;

5414 
fs_deviûs
->
chunk_®loc_pŞicy
) {

5415 
BTRFS_CHUNK_ALLOC_REGULAR
:

5416 
	`š™_®loc_chunk_ùl_pŞicy_»guÏr
(
fs_deviûs
, 
ùl
);

5418 
BTRFS_CHUNK_ALLOC_ZONED
:

5419 
	`š™_®loc_chunk_ùl_pŞicy_zÚed
(
fs_deviûs
, 
ùl
);

5422 
	`BUG
();

5424 
	}
}

5426 
	$g©h”_deviû_šfo
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

5427 
®loc_chunk_ùl
 *
ùl
,

5428 
bŒfs_deviû_šfo
 *
deviûs_šfo
)

5430 
bŒfs_fs_šfo
 *
šfo
 = 
fs_deviûs
->
fs_šfo
;

5431 
bŒfs_deviû
 *
deviû
;

5432 
u64
 
tÙ®_ava
;

5433 
u64
 
dev_ex‹Á_wªt
 = 
ùl
->
max_¡re_size
 * c->
dev_¡res
;

5434 
»t
;

5435 
ndevs
 = 0;

5436 
u64
 
max_ava
;

5437 
u64
 
dev_off£t
;

5443 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
®loc_li¡
, 
dev_®loc_li¡
) {

5444 ià(!
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
)) {

5445 
	`WARN
(1, 
KERN_ERR


5450 ià(!
	`‹¡_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
,

5451 &
deviû
->
dev_¡©e
) ||

5452 
	`‹¡_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
))

5455 ià(
deviû
->
tÙ®_by‹s
 > deviû->
by‹s_u£d
)

5456 
tÙ®_ava
 = 
deviû
->
tÙ®_by‹s
 - deviû->
by‹s_u£d
;

5458 
tÙ®_ava
 = 0;

5461 ià(
tÙ®_ava
 < 
ùl
->
dev_ex‹Á_mš
)

5464 
»t
 = 
	`fšd_ä“_dev_ex‹Á
(
deviû
, 
dev_ex‹Á_wªt
, &
dev_off£t
,

5465 &
max_ava
);

5466 ià(
»t
 &&„‘ !ğ-
ENOSPC
)

5467  
»t
;

5469 ià(
»t
 == 0)

5470 
max_ava
 = 
dev_ex‹Á_wªt
;

5472 ià(
max_ava
 < 
ùl
->
dev_ex‹Á_mš
) {

5473 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
ENOSPC_DEBUG
))

5474 
	`bŒfs_debug
(
šfo
,

5476 
__func__
, 
deviû
->
devid
, 
max_ava
,

5477 
ùl
->
dev_ex‹Á_mš
);

5481 ià(
ndevs
 =ğ
fs_deviûs
->
rw_deviûs
) {

5482 
	`WARN
(1, "%s: found morehan %llu devices\n",

5483 
__func__
, 
fs_deviûs
->
rw_deviûs
);

5486 
deviûs_šfo
[
ndevs
].
dev_off£t
 = dev_offset;

5487 
deviûs_šfo
[
ndevs
].
max_ava
 = max_avail;

5488 
deviûs_šfo
[
ndevs
].
tÙ®_ava
 =otal_avail;

5489 
deviûs_šfo
[
ndevs
].
dev
 = 
deviû
;

5490 ++
ndevs
;

5492 
ùl
->
ndevs
 =‚devs;

5497 
	`sÜt
(
deviûs_šfo
, 
ndevs
, (
bŒfs_deviû_šfo
),

5498 
bŒfs_cmp_deviû_šfo
, 
NULL
);

5501 
	}
}

5503 
	$decide_¡re_size_»guÏr
(
®loc_chunk_ùl
 *
ùl
,

5504 
bŒfs_deviû_šfo
 *
deviûs_šfo
)

5507 
d©a_¡res
;

5516 
ùl
->
¡re_size
 = 
	`div_u64
(
deviûs_šfo
[ùl->
ndevs
 - 1].
max_ava
,

5517 
ùl
->
dev_¡res
);

5518 
ùl
->
num_¡res
 = c->
ndevs
 * c->
dev_¡res
;

5521 
d©a_¡res
 = (
ùl
->
num_¡res
 - c->
Å¬™y
è/ c->
ncİ›s
;

5529 ià(
ùl
->
¡re_size
 * 
d©a_¡res
 > c->
max_chunk_size
) {

5535 
ùl
->
¡re_size
 = 
	`mš
(
	`round_up
(
	`div_u64
(ùl->
max_chunk_size
,

5536 
d©a_¡res
), 
SZ_16M
),

5537 
ùl
->
¡re_size
);

5541 
ùl
->
¡re_size
 = 
	`mš_t
(
u64
, c->¡re_size, 
SZ_1G
);

5544 
ùl
->
¡re_size
 = 
	`round_down
(ùl->¡re_size, 
BTRFS_STRIPE_LEN
);

5545 
ùl
->
chunk_size
 = c->
¡re_size
 * 
d©a_¡res
;

5548 
	}
}

5550 
	$decide_¡re_size_zÚed
(
®loc_chunk_ùl
 *
ùl
,

5551 
bŒfs_deviû_šfo
 *
deviûs_šfo
)

5553 
u64
 
zÚe_size
 = 
deviûs_šfo
[0].
dev
->
zÚe_šfo
->zone_size;

5555 
d©a_¡res
;

5561 
	`ASSERT
(
deviûs_šfo
[
ùl
->
ndevs
 - 1].
max_ava
 =ğùl->
dev_ex‹Á_mš
);

5563 
ùl
->
¡re_size
 = 
zÚe_size
;

5564 
ùl
->
num_¡res
 = c->
ndevs
 * c->
dev_¡res
;

5565 
d©a_¡res
 = (
ùl
->
num_¡res
 - c->
Å¬™y
è/ c->
ncİ›s
;

5568 ià(
ùl
->
¡re_size
 * 
d©a_¡res
 > c->
max_chunk_size
) {

5569 
ùl
->
ndevs
 = 
	`div_u64
(div_u64(ùl->
max_chunk_size
 * c->
ncİ›s
,

5570 
ùl
->
¡re_size
è+ c->
Å¬™y
,

5571 
ùl
->
dev_¡res
);

5572 
ùl
->
num_¡res
 = c->
ndevs
 * c->
dev_¡res
;

5573 
d©a_¡res
 = (
ùl
->
num_¡res
 - c->
Å¬™y
è/ c->
ncİ›s
;

5574 
	`ASSERT
(
ùl
->
¡re_size
 * 
d©a_¡res
 <ğùl->
max_chunk_size
);

5577 
ùl
->
chunk_size
 = c->
¡re_size
 * 
d©a_¡res
;

5580 
	}
}

5582 
	$decide_¡re_size
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

5583 
®loc_chunk_ùl
 *
ùl
,

5584 
bŒfs_deviû_šfo
 *
deviûs_šfo
)

5586 
bŒfs_fs_šfo
 *
šfo
 = 
fs_deviûs
->
fs_šfo
;

5593 
ùl
->
ndevs
 = 
	`rounddown
(ùl->ndevs, c->
devs_šüem’t
);

5595 ià(
ùl
->
ndevs
 < c->
devs_mš
) {

5596 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
ENOSPC_DEBUG
)) {

5597 
	`bŒfs_debug
(
šfo
,

5599 
__func__
, 
ùl
->
ndevs
, c->
devs_mš
);

5601  -
ENOSPC
;

5604 
ùl
->
ndevs
 = 
	`mš
(ùl->ndevs, c->
devs_max
);

5606 
fs_deviûs
->
chunk_®loc_pŞicy
) {

5607 
BTRFS_CHUNK_ALLOC_REGULAR
:

5608  
	`decide_¡re_size_»guÏr
(
ùl
, 
deviûs_šfo
);

5609 
BTRFS_CHUNK_ALLOC_ZONED
:

5610  
	`decide_¡re_size_zÚed
(
ùl
, 
deviûs_šfo
);

5612 
	`BUG
();

5614 
	}
}

5616 
bŒfs_block_group
 *
	$ü—‹_chunk
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5617 
®loc_chunk_ùl
 *
ùl
,

5618 
bŒfs_deviû_šfo
 *
deviûs_šfo
)

5620 
bŒfs_fs_šfo
 *
šfo
 = 
Œªs
->
fs_šfo
;

5621 
m­_lookup
 *
m­
 = 
NULL
;

5622 
ex‹Á_m­_Œ“
 *
em_Œ“
;

5623 
bŒfs_block_group
 *
block_group
;

5624 
ex‹Á_m­
 *
em
;

5625 
u64
 
¡¬t
 = 
ùl
->start;

5626 
u64
 
ty³
 = 
ùl
->type;

5627 
»t
;

5628 
i
;

5629 
j
;

5631 
m­
 = 
	`km®loc
(
	`m­_lookup_size
(
ùl
->
num_¡res
), 
GFP_NOFS
);

5632 ià(!
m­
)

5633  
	`ERR_PTR
(-
ENOMEM
);

5634 
m­
->
num_¡res
 = 
ùl
->num_stripes;

5636 
i
 = 0; i < 
ùl
->
ndevs
; ++i) {

5637 
j
 = 0; j < 
ùl
->
dev_¡res
; ++j) {

5638 
s
 = 
i
 * 
ùl
->
dev_¡res
 + 
j
;

5639 
m­
->
¡res
[
s
].
dev
 = 
deviûs_šfo
[
i
].dev;

5640 
m­
->
¡res
[
s
].
physiÿl
 = 
deviûs_šfo
[
i
].
dev_off£t
 +

5641 
j
 * 
ùl
->
¡re_size
;

5644 
m­
->
io_®ign
 = 
BTRFS_STRIPE_LEN
;

5645 
m­
->
io_width
 = 
BTRFS_STRIPE_LEN
;

5646 
m­
->
ty³
 =ype;

5647 
m­
->
sub_¡res
 = 
ùl
->sub_stripes;

5649 
	`Œaû_bŒfs_chunk_®loc
(
šfo
, 
m­
, 
¡¬t
, 
ùl
->
chunk_size
);

5651 
em
 = 
	`®loc_ex‹Á_m­
();

5652 ià(!
em
) {

5653 
	`kä“
(
m­
);

5654  
	`ERR_PTR
(-
ENOMEM
);

5656 
	`£t_b™
(
EXTENT_FLAG_FS_MAPPING
, &
em
->
æags
);

5657 
em
->
m­_lookup
 = 
m­
;

5658 
em
->
¡¬t
 = start;

5659 
em
->
Ën
 = 
ùl
->
chunk_size
;

5660 
em
->
block_¡¬t
 = 0;

5661 
em
->
block_Ën
 =ƒm->
Ën
;

5662 
em
->
Üig_block_Ën
 = 
ùl
->
¡re_size
;

5664 
em_Œ“
 = &
šfo
->
m­pšg_Œ“
;

5665 
	`wr™e_lock
(&
em_Œ“
->
lock
);

5666 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

5667 ià(
»t
) {

5668 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

5669 
	`ä“_ex‹Á_m­
(
em
);

5670  
	`ERR_PTR
(
»t
);

5672 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

5674 
block_group
 = 
	`bŒfs_make_block_group
(
Œªs
, 
ty³
, 
¡¬t
, 
ùl
->
chunk_size
);

5675 ià(
	`IS_ERR
(
block_group
))

5676 
”rÜ_d–_ex‹Á
;

5678 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

5679 
bŒfs_deviû
 *
dev
 = 
m­
->
¡res
[
i
].dev;

5681 
	`bŒfs_deviû_£t_by‹s_u£d
(
dev
,

5682 
dev
->
by‹s_u£d
 + 
ùl
->
¡re_size
);

5683 ià(
	`li¡_em±y
(&
dev
->
po¡_comm™_li¡
))

5684 
	`li¡_add_
(&
dev
->
po¡_comm™_li¡
,

5685 &
Œªs
->
Œª§ùiÚ
->
dev_upd©e_li¡
);

5688 
	`©omic64_sub
(
ùl
->
¡re_size
 * 
m­
->
num_¡res
,

5689 &
šfo
->
ä“_chunk_¥aû
);

5691 
	`ä“_ex‹Á_m­
(
em
);

5692 
	`check_¿id56_šcom·t_æag
(
šfo
, 
ty³
);

5693 
	`check_¿id1c34_šcom·t_æag
(
šfo
, 
ty³
);

5695  
block_group
;

5697 
”rÜ_d–_ex‹Á
:

5698 
	`wr™e_lock
(&
em_Œ“
->
lock
);

5699 
	`»move_ex‹Á_m­pšg
(
em_Œ“
, 
em
);

5700 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

5703 
	`ä“_ex‹Á_m­
(
em
);

5705 
	`ä“_ex‹Á_m­
(
em
);

5707  
block_group
;

5708 
	}
}

5710 
bŒfs_block_group
 *
	$bŒfs_ü—‹_chunk
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5711 
u64
 
ty³
)

5713 
bŒfs_fs_šfo
 *
šfo
 = 
Œªs
->
fs_šfo
;

5714 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
šfo
->fs_devices;

5715 
bŒfs_deviû_šfo
 *
deviûs_šfo
 = 
NULL
;

5716 
®loc_chunk_ùl
 
ùl
;

5717 
bŒfs_block_group
 *
block_group
;

5718 
»t
;

5720 
	`lockd•_as£¹_h–d
(&
šfo
->
chunk_mu‹x
);

5722 ià(!
	`®loc_´ofe_is_v®id
(
ty³
, 0)) {

5723 
	`ASSERT
(0);

5724  
	`ERR_PTR
(-
EINVAL
);

5727 ià(
	`li¡_em±y
(&
fs_deviûs
->
®loc_li¡
)) {

5728 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
ENOSPC_DEBUG
))

5729 
	`bŒfs_debug
(
šfo
, "%s:‚Øwr™abË deviû", 
__func__
);

5730  
	`ERR_PTR
(-
ENOSPC
);

5733 ià(!(
ty³
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
)) {

5734 
	`bŒfs_”r
(
šfo
, "šv®id chunky³ 0x%Îx„eque¡ed", 
ty³
);

5735 
	`ASSERT
(0);

5736  
	`ERR_PTR
(-
EINVAL
);

5739 
ùl
.
¡¬t
 = 
	`fšd_Ãxt_chunk
(
šfo
);

5740 
ùl
.
ty³
 =ype;

5741 
	`š™_®loc_chunk_ùl
(
fs_deviûs
, &
ùl
);

5743 
deviûs_šfo
 = 
	`kÿÎoc
(
fs_deviûs
->
rw_deviûs
, (*devices_info),

5744 
GFP_NOFS
);

5745 ià(!
deviûs_šfo
)

5746  
	`ERR_PTR
(-
ENOMEM
);

5748 
»t
 = 
	`g©h”_deviû_šfo
(
fs_deviûs
, &
ùl
, 
deviûs_šfo
);

5749 ià(
»t
 < 0) {

5750 
block_group
 = 
	`ERR_PTR
(
»t
);

5751 
out
;

5754 
»t
 = 
	`decide_¡re_size
(
fs_deviûs
, &
ùl
, 
deviûs_šfo
);

5755 ià(
»t
 < 0) {

5756 
block_group
 = 
	`ERR_PTR
(
»t
);

5757 
out
;

5760 
block_group
 = 
	`ü—‹_chunk
(
Œªs
, &
ùl
, 
deviûs_šfo
);

5762 
out
:

5763 
	`kä“
(
deviûs_šfo
);

5764  
block_group
;

5765 
	}
}

5775 
	$bŒfs_chunk_®loc_add_chunk_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5776 
bŒfs_block_group
 *
bg
)

5778 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

5779 
bŒfs_roÙ
 *
chunk_roÙ
 = 
fs_šfo
->chunk_root;

5780 
bŒfs_key
 
key
;

5781 
bŒfs_chunk
 *
chunk
;

5782 
bŒfs_¡re
 *
¡re
;

5783 
ex‹Á_m­
 *
em
;

5784 
m­_lookup
 *
m­
;

5785 
size_t
 
™em_size
;

5786 
i
;

5787 
»t
;

5811 
	`lockd•_as£¹_h–d
(&
fs_šfo
->
chunk_mu‹x
);

5813 
em
 = 
	`bŒfs_g‘_chunk_m­
(
fs_šfo
, 
bg
->
¡¬t
, bg->
Ëngth
);

5814 ià(
	`IS_ERR
(
em
)) {

5815 
»t
 = 
	`PTR_ERR
(
em
);

5816 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

5817  
»t
;

5820 
m­
 = 
em
->
m­_lookup
;

5821 
™em_size
 = 
	`bŒfs_chunk_™em_size
(
m­
->
num_¡res
);

5823 
chunk
 = 
	`kz®loc
(
™em_size
, 
GFP_NOFS
);

5824 ià(!
chunk
) {

5825 
»t
 = -
ENOMEM
;

5826 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

5827 
out
;

5830 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

5831 
bŒfs_deviû
 *
deviû
 = 
m­
->
¡res
[
i
].
dev
;

5833 
»t
 = 
	`bŒfs_upd©e_deviû
(
Œªs
, 
deviû
);

5834 ià(
»t
)

5835 
out
;

5838 
¡re
 = &
chunk
->stripe;

5839 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

5840 
bŒfs_deviû
 *
deviû
 = 
m­
->
¡res
[
i
].
dev
;

5841 cÚ¡ 
u64
 
dev_off£t
 = 
m­
->
¡res
[
i
].
physiÿl
;

5843 
	`bŒfs_£t_¡ack_¡re_devid
(
¡re
, 
deviû
->
devid
);

5844 
	`bŒfs_£t_¡ack_¡re_off£t
(
¡re
, 
dev_off£t
);

5845 
	`memıy
(
¡re
->
dev_uuid
, 
deviû
->
uuid
, 
BTRFS_UUID_SIZE
);

5846 
¡re
++;

5849 
	`bŒfs_£t_¡ack_chunk_Ëngth
(
chunk
, 
bg
->
Ëngth
);

5850 
	`bŒfs_£t_¡ack_chunk_owÃr
(
chunk
, 
BTRFS_EXTENT_TREE_OBJECTID
);

5851 
	`bŒfs_£t_¡ack_chunk_¡re_Ën
(
chunk
, 
BTRFS_STRIPE_LEN
);

5852 
	`bŒfs_£t_¡ack_chunk_ty³
(
chunk
, 
m­
->
ty³
);

5853 
	`bŒfs_£t_¡ack_chunk_num_¡res
(
chunk
, 
m­
->
num_¡res
);

5854 
	`bŒfs_£t_¡ack_chunk_io_®ign
(
chunk
, 
BTRFS_STRIPE_LEN
);

5855 
	`bŒfs_£t_¡ack_chunk_io_width
(
chunk
, 
BTRFS_STRIPE_LEN
);

5856 
	`bŒfs_£t_¡ack_chunk_£ùÜ_size
(
chunk
, 
fs_šfo
->
£ùÜsize
);

5857 
	`bŒfs_£t_¡ack_chunk_sub_¡res
(
chunk
, 
m­
->
sub_¡res
);

5859 
key
.
objeùid
 = 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
;

5860 
key
.
ty³
 = 
BTRFS_CHUNK_ITEM_KEY
;

5861 
key
.
off£t
 = 
bg
->
¡¬t
;

5863 
»t
 = 
	`bŒfs_š£¹_™em
(
Œªs
, 
chunk_roÙ
, &
key
, 
chunk
, 
™em_size
);

5864 ià(
»t
)

5865 
out
;

5867 
	`£t_b™
(
BLOCK_GROUP_FLAG_CHUNK_ITEM_INSERTED
, &
bg
->
ruÁime_æags
);

5869 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) {

5870 
»t
 = 
	`bŒfs_add_sy¡em_chunk
(
fs_šfo
, &
key
, 
chunk
, 
™em_size
);

5871 ià(
»t
)

5872 
out
;

5875 
out
:

5876 
	`kä“
(
chunk
);

5877 
	`ä“_ex‹Á_m­
(
em
);

5878  
»t
;

5879 
	}
}

5881 
nošlše
 
	$š™_fœ¡_rw_deviû
(
bŒfs_Œªs_hªdË
 *
Œªs
)

5883 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

5884 
u64
 
®loc_´ofe
;

5885 
bŒfs_block_group
 *
m‘a_bg
;

5886 
bŒfs_block_group
 *
sys_bg
;

5909 
®loc_´ofe
 = 
	`bŒfs_m‘ad©a_®loc_´ofe
(
fs_šfo
);

5910 
m‘a_bg
 = 
	`bŒfs_ü—‹_chunk
(
Œªs
, 
®loc_´ofe
);

5911 ià(
	`IS_ERR
(
m‘a_bg
))

5912  
	`PTR_ERR
(
m‘a_bg
);

5914 
®loc_´ofe
 = 
	`bŒfs_sy¡em_®loc_´ofe
(
fs_šfo
);

5915 
sys_bg
 = 
	`bŒfs_ü—‹_chunk
(
Œªs
, 
®loc_´ofe
);

5916 ià(
	`IS_ERR
(
sys_bg
))

5917  
	`PTR_ERR
(
sys_bg
);

5920 
	}
}

5922 
šlše
 
	$bŒfs_chunk_max_”rÜs
(
m­_lookup
 *
m­
)

5924 cÚ¡ 
šdex
 = 
	`bŒfs_bg_æags_to_¿id_šdex
(
m­
->
ty³
);

5926  
bŒfs_¿id_¬¿y
[
šdex
].
tŞ”©ed_çu»s
;

5927 
	}
}

5929 
boŞ
 
	$bŒfs_chunk_wr™—bË
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
chunk_off£t
)

5931 
ex‹Á_m­
 *
em
;

5932 
m­_lookup
 *
m­
;

5933 
miss_ndevs
 = 0;

5934 
i
;

5935 
boŞ
 
»t
 = 
Œue
;

5937 
em
 = 
	`bŒfs_g‘_chunk_m­
(
fs_šfo
, 
chunk_off£t
, 1);

5938 ià(
	`IS_ERR
(
em
))

5939  
çl£
;

5941 
m­
 = 
em
->
m­_lookup
;

5942 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

5943 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
,

5944 &
m­
->
¡res
[
i
].
dev
->
dev_¡©e
)) {

5945 
miss_ndevs
++;

5948 ià(!
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
,

5949 &
m­
->
¡res
[
i
].
dev
->
dev_¡©e
)) {

5950 
»t
 = 
çl£
;

5951 
’d
;

5959 ià(
miss_ndevs
 > 
	`bŒfs_chunk_max_”rÜs
(
m­
))

5960 
»t
 = 
çl£
;

5961 
’d
:

5962 
	`ä“_ex‹Á_m­
(
em
);

5963  
»t
;

5964 
	}
}

5966 
	$bŒfs_m­pšg_Œ“_ä“
(
ex‹Á_m­_Œ“
 *
Œ“
)

5968 
ex‹Á_m­
 *
em
;

5971 
	`wr™e_lock
(&
Œ“
->
lock
);

5972 
em
 = 
	`lookup_ex‹Á_m­pšg
(
Œ“
, 0, (
u64
)-1);

5973 ià(
em
)

5974 
	`»move_ex‹Á_m­pšg
(
Œ“
, 
em
);

5975 
	`wr™e_uÆock
(&
Œ“
->
lock
);

5976 ià(!
em
)

5979 
	`ä“_ex‹Á_m­
(
em
);

5981 
	`ä“_ex‹Á_m­
(
em
);

5983 
	}
}

5985 
	$bŒfs_num_cİ›s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
, u64 
Ën
)

5987 
ex‹Á_m­
 *
em
;

5988 
m­_lookup
 *
m­
;

5989 
bŒfs_¿id_ty³s
 
šdex
;

5990 
»t
 = 1;

5992 
em
 = 
	`bŒfs_g‘_chunk_m­
(
fs_šfo
, 
logiÿl
, 
Ën
);

5993 ià(
	`IS_ERR
(
em
))

6002 
m­
 = 
em
->
m­_lookup
;

6003 
šdex
 = 
	`bŒfs_bg_æags_to_¿id_šdex
(
m­
->
ty³
);

6006 ià(!(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
))

6007 
»t
 = 
bŒfs_¿id_¬¿y
[
šdex
].
ncİ›s
;

6008 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID5
)

6009 
»t
 = 2;

6010 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID6
)

6018 
»t
 = 
m­
->
num_¡res
;

6019 
	`ä“_ex‹Á_m­
(
em
);

6020  
»t
;

6021 
	}
}

6023 
	$bŒfs_fuÎ_¡re_Ën
(
bŒfs_fs_šfo
 *
fs_šfo
,

6024 
u64
 
logiÿl
)

6026 
ex‹Á_m­
 *
em
;

6027 
m­_lookup
 *
m­
;

6028 
Ën
 = 
fs_šfo
->
£ùÜsize
;

6030 ià(!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
RAID56
))

6031  
Ën
;

6033 
em
 = 
	`bŒfs_g‘_chunk_m­
(
fs_šfo
, 
logiÿl
, 
Ën
);

6035 ià(!
	`WARN_ON
(
	`IS_ERR
(
em
))) {

6036 
m­
 = 
em
->
m­_lookup
;

6037 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
)

6038 
Ën
 = 
	`bŒfs_¡re_Ä_to_off£t
(
	`Ä_d©a_¡res
(
m­
));

6039 
	`ä“_ex‹Á_m­
(
em
);

6041  
Ën
;

6042 
	}
}

6044 
	$bŒfs_is_·r™y_mœrÜ
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
, u64 
Ën
)

6046 
ex‹Á_m­
 *
em
;

6047 
m­_lookup
 *
m­
;

6048 
»t
 = 0;

6050 ià(!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
RAID56
))

6053 
em
 = 
	`bŒfs_g‘_chunk_m­
(
fs_šfo
, 
logiÿl
, 
Ën
);

6055 if(!
	`WARN_ON
(
	`IS_ERR
(
em
))) {

6056 
m­
 = 
em
->
m­_lookup
;

6057 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
)

6058 
»t
 = 1;

6059 
	`ä“_ex‹Á_m­
(
em
);

6061  
»t
;

6062 
	}
}

6064 
	$fšd_live_mœrÜ
(
bŒfs_fs_šfo
 *
fs_šfo
,

6065 
m­_lookup
 *
m­
, 
fœ¡
,

6066 
dev_»¶aû_is_Úgošg
)

6068 
i
;

6069 
num_¡res
;

6070 
´eã¼ed_mœrÜ
;

6071 
tŞ”ªû
;

6072 
bŒfs_deviû
 *
¤cdev
;

6074 
	`ASSERT
((
m­
->
ty³
 &

6075 (
BTRFS_BLOCK_GROUP_RAID1_MASK
 | 
BTRFS_BLOCK_GROUP_RAID10
)));

6077 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID10
)

6078 
num_¡res
 = 
m­
->
sub_¡res
;

6080 
num_¡res
 = 
m­
->num_stripes;

6082 
fs_šfo
->
fs_deviûs
->
»ad_pŞicy
) {

6085 
	`bŒfs_w¬n_¾
(
fs_šfo
,

6087 
fs_šfo
->
fs_deviûs
->
»ad_pŞicy
);

6088 
fs_šfo
->
fs_deviûs
->
»ad_pŞicy
 = 
BTRFS_READ_POLICY_PID
;

6089 
çÎthrough
;

6090 
BTRFS_READ_POLICY_PID
:

6091 
´eã¼ed_mœrÜ
 = 
fœ¡
 + (
cu¼’t
->
pid
 % 
num_¡res
);

6095 ià(
dev_»¶aû_is_Úgošg
 &&

6096 
fs_šfo
->
dev_»¶aû
.
cÚt_»adšg_äom_¤cdev_mode
 ==

6097 
BTRFS_DEV_REPLACE_ITEM_CONT_READING_FROM_SRCDEV_MODE_AVOID
)

6098 
¤cdev
 = 
fs_šfo
->
dev_»¶aû
.srcdev;

6100 
¤cdev
 = 
NULL
;

6107 
tŞ”ªû
 = 0;olerance < 2;olerance++) {

6108 ià(
m­
->
¡res
[
´eã¼ed_mœrÜ
].
dev
->
bdev
 &&

6109 (
tŞ”ªû
 || 
m­
->
¡res
[
´eã¼ed_mœrÜ
].
dev
 !ğ
¤cdev
))

6110  
´eã¼ed_mœrÜ
;

6111 
i
 = 
fœ¡
; i < fœ¡ + 
num_¡res
; i++) {

6112 ià(
m­
->
¡res
[
i
].
dev
->
bdev
 &&

6113 (
tŞ”ªû
 || 
m­
->
¡res
[
i
].
dev
 !ğ
¤cdev
))

6114  
i
;

6121  
´eã¼ed_mœrÜ
;

6122 
	}
}

6124 
bŒfs_io_cÚ‹xt
 *
	$®loc_bŒfs_io_cÚ‹xt
(
bŒfs_fs_šfo
 *
fs_šfo
,

6125 
u16
 
tÙ®_¡res
)

6127 
bŒfs_io_cÚ‹xt
 *
bioc
;

6129 
bioc
 = 
	`kz®loc
(

6131 (
bŒfs_io_cÚ‹xt
) +

6133 (
bŒfs_io_¡re
è* (
tÙ®_¡res
),

6134 
GFP_NOFS
);

6136 ià(!
bioc
)

6137  
NULL
;

6139 
	`»fcouÁ_£t
(&
bioc
->
»fs
, 1);

6141 
bioc
->
fs_šfo
 = fs_info;

6142 
bioc
->
»¶aû_¡re_¤c
 = -1;

6143 
bioc
->
fuÎ_¡re_logiÿl
 = (
u64
)-1;

6145  
bioc
;

6146 
	}
}

6148 
	$bŒfs_g‘_bioc
(
bŒfs_io_cÚ‹xt
 *
bioc
)

6150 
	`WARN_ON
(!
	`»fcouÁ_»ad
(&
bioc
->
»fs
));

6151 
	`»fcouÁ_šc
(&
bioc
->
»fs
);

6152 
	}
}

6154 
	$bŒfs_put_bioc
(
bŒfs_io_cÚ‹xt
 *
bioc
)

6156 ià(!
bioc
)

6158 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
bioc
->
»fs
))

6159 
	`kä“
(
bioc
);

6160 
	}
}

6166 
bŒfs_disÿrd_¡re
 *
	$bŒfs_m­_disÿrd
(
bŒfs_fs_šfo
 *
fs_šfo
,

6167 
u64
 
logiÿl
, u64 *
Ëngth_»t
,

6168 
u32
 *
num_¡res
)

6170 
ex‹Á_m­
 *
em
;

6171 
m­_lookup
 *
m­
;

6172 
bŒfs_disÿrd_¡re
 *
¡res
;

6173 
u64
 
Ëngth
 = *
Ëngth_»t
;

6174 
u64
 
off£t
;

6175 
u32
 
¡re_Ä
;

6176 
u32
 
¡re_Ä_’d
;

6177 
u32
 
¡re_út
;

6178 
u64
 
¡re_’d_off£t
;

6179 
u64
 
¡re_off£t
;

6180 
u32
 
¡re_šdex
;

6181 
u32
 
çùÜ
 = 0;

6182 
u32
 
sub_¡res
 = 0;

6183 
u32
 
¡res_³r_dev
 = 0;

6184 
u32
 
»maššg_¡res
 = 0;

6185 
u32
 
Ï¡_¡re
 = 0;

6186 
»t
;

6187 
i
;

6189 
em
 = 
	`bŒfs_g‘_chunk_m­
(
fs_šfo
, 
logiÿl
, 
Ëngth
);

6190 ià(
	`IS_ERR
(
em
))

6191  
	`ERR_CAST
(
em
);

6193 
m­
 = 
em
->
m­_lookup
;

6196 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

6197 
»t
 = -
EOPNOTSUPP
;

6198 
out_ä“_m­
;

6201 
off£t
 = 
logiÿl
 - 
em
->
¡¬t
;

6202 
Ëngth
 = 
	`mš_t
(
u64
, 
em
->
¡¬t
 +ƒm->
Ën
 - 
logiÿl
,†ength);

6203 *
Ëngth_»t
 = 
Ëngth
;

6209 
¡re_Ä
 = 
off£t
 >> 
BTRFS_STRIPE_LEN_SHIFT
;

6212 
¡re_off£t
 = 
off£t
 - 
	`bŒfs_¡re_Ä_to_off£t
(
¡re_Ä
);

6214 
¡re_Ä_’d
 = 
	`round_up
(
off£t
 + 
Ëngth
, 
BTRFS_STRIPE_LEN
) >>

6215 
BTRFS_STRIPE_LEN_SHIFT
;

6216 
¡re_út
 = 
¡re_Ä_’d
 - 
¡re_Ä
;

6217 
¡re_’d_off£t
 = 
	`bŒfs_¡re_Ä_to_off£t
(
¡re_Ä_’d
) -

6218 (
off£t
 + 
Ëngth
);

6224 *
num_¡res
 = 1;

6225 
¡re_šdex
 = 0;

6226 ià(
m­
->
ty³
 & (
BTRFS_BLOCK_GROUP_RAID0
 |

6227 
BTRFS_BLOCK_GROUP_RAID10
)) {

6228 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID0
)

6229 
sub_¡res
 = 1;

6231 
sub_¡res
 = 
m­
->sub_stripes;

6233 
çùÜ
 = 
m­
->
num_¡res
 / 
sub_¡res
;

6234 *
num_¡res
 = 
	`mš_t
(
u64
, 
m­
->num_stripes,

6235 
sub_¡res
 * 
¡re_út
);

6236 
¡re_šdex
 = 
¡re_Ä
 % 
çùÜ
;

6237 
¡re_Ä
 /ğ
çùÜ
;

6238 
¡re_šdex
 *ğ
sub_¡res
;

6240 
»maššg_¡res
 = 
¡re_út
 % 
çùÜ
;

6241 
¡res_³r_dev
 = 
¡re_út
 / 
çùÜ
;

6242 
Ï¡_¡re
 = ((
¡re_Ä_’d
 - 1è% 
çùÜ
è* 
sub_¡res
;

6243 } ià(
m­
->
ty³
 & (
BTRFS_BLOCK_GROUP_RAID1_MASK
 |

6244 
BTRFS_BLOCK_GROUP_DUP
)) {

6245 *
num_¡res
 = 
m­
->num_stripes;

6247 
¡re_šdex
 = 
¡re_Ä
 % 
m­
->
num_¡res
;

6248 
¡re_Ä
 /ğ
m­
->
num_¡res
;

6251 
¡res
 = 
	`kÿÎoc
(*
num_¡res
, (*¡res), 
GFP_NOFS
);

6252 ià(!
¡res
) {

6253 
»t
 = -
ENOMEM
;

6254 
out_ä“_m­
;

6257 
i
 = 0; i < *
num_¡res
; i++) {

6258 
¡res
[
i
].
physiÿl
 =

6259 
m­
->
¡res
[
¡re_šdex
].
physiÿl
 +

6260 
¡re_off£t
 + 
	`bŒfs_¡re_Ä_to_off£t
(
¡re_Ä
);

6261 
¡res
[
i
].
dev
 = 
m­
->¡res[
¡re_šdex
].dev;

6263 ià(
m­
->
ty³
 & (
BTRFS_BLOCK_GROUP_RAID0
 |

6264 
BTRFS_BLOCK_GROUP_RAID10
)) {

6265 
¡res
[
i
].
Ëngth
 = 
	`bŒfs_¡re_Ä_to_off£t
(
¡res_³r_dev
);

6267 ià(
i
 / 
sub_¡res
 < 
»maššg_¡res
)

6268 
¡res
[
i
].
Ëngth
 +ğ
BTRFS_STRIPE_LEN
;

6278 ià(
i
 < 
sub_¡res
)

6279 
¡res
[
i
].
Ëngth
 -ğ
¡re_off£t
;

6281 ià(
¡re_šdex
 >ğ
Ï¡_¡re
 &&

6282 
¡re_šdex
 <ğ(
Ï¡_¡re
 +

6283 
sub_¡res
 - 1))

6284 
¡res
[
i
].
Ëngth
 -ğ
¡re_’d_off£t
;

6286 ià(
i
 =ğ
sub_¡res
 - 1)

6287 
¡re_off£t
 = 0;

6289 
¡res
[
i
].
Ëngth
 =†ength;

6292 
¡re_šdex
++;

6293 ià(
¡re_šdex
 =ğ
m­
->
num_¡res
) {

6294 
¡re_šdex
 = 0;

6295 
¡re_Ä
++;

6299 
	`ä“_ex‹Á_m­
(
em
);

6300  
¡res
;

6301 
out_ä“_m­
:

6302 
	`ä“_ex‹Á_m­
(
em
);

6303  
	`ERR_PTR
(
»t
);

6304 
	}
}

6306 
boŞ
 
	$is_block_group_to_cİy
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
)

6308 
bŒfs_block_group
 *
ÿche
;

6309 
boŞ
 
»t
;

6312 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

6313  
çl£
;

6315 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
logiÿl
);

6317 
»t
 = 
	`‹¡_b™
(
BLOCK_GROUP_FLAG_TO_COPY
, &
ÿche
->
ruÁime_æags
);

6319 
	`bŒfs_put_block_group
(
ÿche
);

6320  
»t
;

6321 
	}
}

6323 
	$hªdË_İs_Ú_dev_»¶aû
(
bŒfs_m­_İ
 
İ
,

6324 
bŒfs_io_cÚ‹xt
 *
bioc
,

6325 
bŒfs_dev_»¶aû
 *
dev_»¶aû
,

6326 
u64
 
logiÿl
,

6327 *
num_¡res_»t
, *
max_”rÜs_»t
)

6329 
u64
 
¤cdev_devid
 = 
dev_»¶aû
->
¤cdev
->
devid
;

6334 
num_¡res
 = *
num_¡res_»t
;

6335 
Ä_exŒa_¡res
 = 0;

6336 
max_”rÜs
 = *
max_”rÜs_»t
;

6337 
i
;

6343 ià(
	`is_block_group_to_cİy
(
dev_»¶aû
->
¤cdev
->
fs_šfo
, 
logiÿl
))

6356 
i
 = 0; i < 
num_¡res
; i++) {

6357 
bŒfs_io_¡re
 *
Şd
 = &
bioc
->
¡res
[
i
];

6358 
bŒfs_io_¡re
 *
Ãw
 = &
bioc
->
¡res
[
num_¡res
 + 
Ä_exŒa_¡res
];

6360 ià(
Şd
->
dev
->
devid
 !ğ
¤cdev_devid
)

6363 
Ãw
->
physiÿl
 = 
Şd
->physical;

6364 
Ãw
->
dev
 = 
dev_»¶aû
->
tgtdev
;

6365 ià(
bioc
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
)

6366 
bioc
->
»¶aû_¡re_¤c
 = 
i
;

6367 
Ä_exŒa_¡res
++;

6371 
	`ASSERT
(
Ä_exŒa_¡res
 <= 2);

6377 ià(
İ
 =ğ
BTRFS_MAP_GET_READ_MIRRORS
 && 
Ä_exŒa_¡res
 == 2) {

6378 
bŒfs_io_¡re
 *
fœ¡
 = &
bioc
->
¡res
[
num_¡res
];

6379 
bŒfs_io_¡re
 *
£cÚd
 = &
bioc
->
¡res
[
num_¡res
 + 1];

6382 
	`ASSERT
(
bioc
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_DUP
);

6388 ià(
fœ¡
->
physiÿl
 > 
£cÚd
->physical) {

6389 
	`sw­
(
£cÚd
->
physiÿl
, 
fœ¡
->physical);

6390 
	`sw­
(
£cÚd
->
dev
, 
fœ¡
->dev);

6391 
Ä_exŒa_¡res
--;

6395 *
num_¡res_»t
 = 
num_¡res
 + 
Ä_exŒa_¡res
;

6396 *
max_”rÜs_»t
 = 
max_”rÜs
 + 
Ä_exŒa_¡res
;

6397 
bioc
->
»¶aû_Ä_¡res
 = 
Ä_exŒa_¡res
;

6398 
	}
}

6400 
u64
 
	$bŒfs_max_io_Ën
(
m­_lookup
 *
m­
, 
bŒfs_m­_İ
 
İ
,

6401 
u64
 
off£t
, 
u32
 *
¡re_Ä
, u64 *
¡re_off£t
,

6402 
u64
 *
fuÎ_¡re_¡¬t
)

6408 *
¡re_off£t
 = 
off£t
 & 
BTRFS_STRIPE_LEN_MASK
;

6409 *
¡re_Ä
 = 
off£t
 >> 
BTRFS_STRIPE_LEN_SHIFT
;

6410 
	`ASSERT
(*
¡re_off£t
 < 
U32_MAX
);

6412 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

6413 
fuÎ_¡re_Ën
 =

6414 
	`bŒfs_¡re_Ä_to_off£t
(
	`Ä_d©a_¡res
(
m­
));

6425 *
fuÎ_¡re_¡¬t
 =

6426 
	`bŒfs_¡re_Ä_to_off£t
(

6427 
	`rounddown
(*
¡re_Ä
, 
	`Ä_d©a_¡res
(
m­
)));

6429 
	`ASSERT
(*
fuÎ_¡re_¡¬t
 + 
fuÎ_¡re_Ën
 > 
off£t
);

6430 
	`ASSERT
(*
fuÎ_¡re_¡¬t
 <ğ
off£t
);

6435 ià(
İ
 =ğ
BTRFS_MAP_WRITE
)

6436  
fuÎ_¡re_Ën
 - (
off£t
 - *
fuÎ_¡re_¡¬t
);

6443 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_STRIPE_MASK
)

6444  
BTRFS_STRIPE_LEN
 - *
¡re_off£t
;

6445  
U64_MAX
;

6446 
	}
}

6448 
	$£t_io_¡re
(
bŒfs_io_¡re
 *
d¡
, cÚ¡ 
m­_lookup
 *
m­
,

6449 
u32
 
¡re_šdex
, 
u64
 
¡re_off£t
, u32 
¡re_Ä
)

6451 
d¡
->
dev
 = 
m­
->
¡res
[
¡re_šdex
].dev;

6452 
d¡
->
physiÿl
 = 
m­
->
¡res
[
¡re_šdex
].physical +

6453 
¡re_off£t
 + 
	`bŒfs_¡re_Ä_to_off£t
(
¡re_Ä
);

6454 
	}
}

6495 
	$bŒfs_m­_block
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bŒfs_m­_İ
 
İ
,

6496 
u64
 
logiÿl
, u64 *
Ëngth
,

6497 
bŒfs_io_cÚ‹xt
 **
bioc_»t
,

6498 
bŒfs_io_¡re
 *
sm­
, *
mœrÜ_num_»t
,

6499 
Ãed_¿id_m­
)

6501 
ex‹Á_m­
 *
em
;

6502 
m­_lookup
 *
m­
;

6503 
u64
 
m­_off£t
;

6504 
u64
 
¡re_off£t
;

6505 
u32
 
¡re_Ä
;

6506 
u32
 
¡re_šdex
;

6507 
d©a_¡res
;

6508 
i
;

6509 
»t
 = 0;

6510 
mœrÜ_num
 = (
mœrÜ_num_»t
 ? *mirror_num_ret : 0);

6511 
num_¡res
;

6512 
num_cİ›s
;

6513 
max_”rÜs
 = 0;

6514 
bŒfs_io_cÚ‹xt
 *
bioc
 = 
NULL
;

6515 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

6516 
dev_»¶aû_is_Úgošg
 = 0;

6517 
u16
 
num_®loc_¡res
;

6518 
u64
 
¿id56_fuÎ_¡re_¡¬t
 = (u64)-1;

6519 
u64
 
max_Ën
;

6521 
	`ASSERT
(
bioc_»t
);

6523 
num_cİ›s
 = 
	`bŒfs_num_cİ›s
(
fs_šfo
, 
logiÿl
, fs_šfo->
£ùÜsize
);

6524 ià(
mœrÜ_num
 > 
num_cİ›s
)

6525  -
EINVAL
;

6527 
em
 = 
	`bŒfs_g‘_chunk_m­
(
fs_šfo
, 
logiÿl
, *
Ëngth
);

6528 ià(
	`IS_ERR
(
em
))

6529  
	`PTR_ERR
(
em
);

6531 
m­
 = 
em
->
m­_lookup
;

6532 
d©a_¡res
 = 
	`Ä_d©a_¡res
(
m­
);

6534 
m­_off£t
 = 
logiÿl
 - 
em
->
¡¬t
;

6535 
max_Ën
 = 
	`bŒfs_max_io_Ën
(
m­
, 
İ
, 
m­_off£t
, &
¡re_Ä
,

6536 &
¡re_off£t
, &
¿id56_fuÎ_¡re_¡¬t
);

6537 *
Ëngth
 = 
	`mš_t
(
u64
, 
em
->
Ën
 - 
m­_off£t
, 
max_Ën
);

6539 
	`down_»ad
(&
dev_»¶aû
->
rw£m
);

6540 
dev_»¶aû_is_Úgošg
 = 
	`bŒfs_dev_»¶aû_is_Úgošg
(
dev_»¶aû
);

6545 ià(!
dev_»¶aû_is_Úgošg
)

6546 
	`up_»ad
(&
dev_»¶aû
->
rw£m
);

6548 
num_¡res
 = 1;

6549 
¡re_šdex
 = 0;

6550 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID0
) {

6551 
¡re_šdex
 = 
¡re_Ä
 % 
m­
->
num_¡res
;

6552 
¡re_Ä
 /ğ
m­
->
num_¡res
;

6553 ià(
İ
 =ğ
BTRFS_MAP_READ
)

6554 
mœrÜ_num
 = 1;

6555 } ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID1_MASK
) {

6556 ià(
İ
 !ğ
BTRFS_MAP_READ
) {

6557 
num_¡res
 = 
m­
->num_stripes;

6558 } ià(
mœrÜ_num
) {

6559 
¡re_šdex
 = 
mœrÜ_num
 - 1;

6561 
¡re_šdex
 = 
	`fšd_live_mœrÜ
(
fs_šfo
, 
m­
, 0,

6562 
dev_»¶aû_is_Úgošg
);

6563 
mœrÜ_num
 = 
¡re_šdex
 + 1;

6566 } ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_DUP
) {

6567 ià(
İ
 !ğ
BTRFS_MAP_READ
) {

6568 
num_¡res
 = 
m­
->num_stripes;

6569 } ià(
mœrÜ_num
) {

6570 
¡re_šdex
 = 
mœrÜ_num
 - 1;

6572 
mœrÜ_num
 = 1;

6575 } ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID10
) {

6576 
u32
 
çùÜ
 = 
m­
->
num_¡res
 / m­->
sub_¡res
;

6578 
¡re_šdex
 = (
¡re_Ä
 % 
çùÜ
è* 
m­
->
sub_¡res
;

6579 
¡re_Ä
 /ğ
çùÜ
;

6581 ià(
İ
 !ğ
BTRFS_MAP_READ
)

6582 
num_¡res
 = 
m­
->
sub_¡res
;

6583 ià(
mœrÜ_num
)

6584 
¡re_šdex
 +ğ
mœrÜ_num
 - 1;

6586 
Şd_¡re_šdex
 = 
¡re_šdex
;

6587 
¡re_šdex
 = 
	`fšd_live_mœrÜ
(
fs_šfo
, 
m­
,

6588 
¡re_šdex
,

6589 
dev_»¶aû_is_Úgošg
);

6590 
mœrÜ_num
 = 
¡re_šdex
 - 
Şd_¡re_šdex
 + 1;

6593 } ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

6594 ià(
Ãed_¿id_m­
 && (
İ
 !ğ
BTRFS_MAP_READ
 || 
mœrÜ_num
 > 1)) {

6604 
¡re_Ä
 /ğ
d©a_¡res
;

6607 
num_¡res
 = 
m­
->num_stripes;

6608 
max_”rÜs
 = 
	`bŒfs_chunk_max_”rÜs
(
m­
);

6611 *
Ëngth
 = 
	`mš
(
logiÿl
 + *length,

6612 
¿id56_fuÎ_¡re_¡¬t
 + 
em
->
¡¬t
 +

6613 
	`bŒfs_¡re_Ä_to_off£t
(
d©a_¡res
)) -

6614 
logiÿl
;

6615 
¡re_šdex
 = 0;

6616 
¡re_off£t
 = 0;

6623 
¡re_šdex
 = 
¡re_Ä
 % 
d©a_¡res
;

6624 
¡re_Ä
 /ğ
d©a_¡res
;

6625 ià(
mœrÜ_num
 > 1)

6626 
¡re_šdex
 = 
d©a_¡res
 + 
mœrÜ_num
 - 2;

6629 
¡re_šdex
 = (
¡re_Ä
 + sŒe_šdexè% 
m­
->
num_¡res
;

6630 ià(
İ
 =ğ
BTRFS_MAP_READ
 && 
mœrÜ_num
 <= 1)

6631 
mœrÜ_num
 = 1;

6639 
¡re_šdex
 = 
¡re_Ä
 % 
m­
->
num_¡res
;

6640 
¡re_Ä
 /ğ
m­
->
num_¡res
;

6641 
mœrÜ_num
 = 
¡re_šdex
 + 1;

6643 ià(
¡re_šdex
 >ğ
m­
->
num_¡res
) {

6644 
	`bŒfs_ü™
(
fs_šfo
,

6646 
¡re_šdex
, 
m­
->
num_¡res
);

6647 
»t
 = -
EINVAL
;

6648 
out
;

6651 
num_®loc_¡res
 = 
num_¡res
;

6652 ià(
dev_»¶aû_is_Úgošg
 && 
dev_»¶aû
->
tgtdev
 !ğ
NULL
 &&

6653 
İ
 !ğ
BTRFS_MAP_READ
)

6661 
num_®loc_¡res
 += 2;

6668 ià(
sm­
 && 
num_®loc_¡res
 == 1 &&

6669 !((
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
è&& 
mœrÜ_num
 > 1)) {

6670 
	`£t_io_¡re
(
sm­
, 
m­
, 
¡re_šdex
, 
¡re_off£t
, 
¡re_Ä
);

6671 ià(
mœrÜ_num_»t
)

6672 *
mœrÜ_num_»t
 = 
mœrÜ_num
;

6673 *
bioc_»t
 = 
NULL
;

6674 
»t
 = 0;

6675 
out
;

6678 
bioc
 = 
	`®loc_bŒfs_io_cÚ‹xt
(
fs_šfo
, 
num_®loc_¡res
);

6679 ià(!
bioc
) {

6680 
»t
 = -
ENOMEM
;

6681 
out
;

6683 
bioc
->
m­_ty³
 = 
m­
->
ty³
;

6692 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
 && 
Ãed_¿id_m­
 &&

6693 (
İ
 !ğ
BTRFS_MAP_READ
 || 
mœrÜ_num
 > 1)) {

6702 
bioc
->
fuÎ_¡re_logiÿl
 = 
em
->
¡¬t
 +

6703 
	`bŒfs_¡re_Ä_to_off£t
(
¡re_Ä
 * 
d©a_¡res
);

6704 
i
 = 0; i < 
num_¡res
; i++)

6705 
	`£t_io_¡re
(&
bioc
->
¡res
[
i
], 
m­
,

6706 (
i
 + 
¡re_Ä
è% 
num_¡res
,

6707 
¡re_off£t
, 
¡re_Ä
);

6713 
i
 = 0; i < 
num_¡res
; i++) {

6714 
	`£t_io_¡re
(&
bioc
->
¡res
[
i
], 
m­
, 
¡re_šdex
,

6715 
¡re_off£t
, 
¡re_Ä
);

6716 
¡re_šdex
++;

6720 ià(
İ
 !ğ
BTRFS_MAP_READ
)

6721 
max_”rÜs
 = 
	`bŒfs_chunk_max_”rÜs
(
m­
);

6723 ià(
dev_»¶aû_is_Úgošg
 && 
dev_»¶aû
->
tgtdev
 !ğ
NULL
 &&

6724 
İ
 !ğ
BTRFS_MAP_READ
) {

6725 
	`hªdË_İs_Ú_dev_»¶aû
(
İ
, 
bioc
, 
dev_»¶aû
, 
logiÿl
,

6726 &
num_¡res
, &
max_”rÜs
);

6729 *
bioc_»t
 = 
bioc
;

6730 
bioc
->
num_¡res
 =‚um_stripes;

6731 
bioc
->
max_”rÜs
 = max_errors;

6732 
bioc
->
mœrÜ_num
 = mirror_num;

6734 
out
:

6735 ià(
dev_»¶aû_is_Úgošg
) {

6736 
	`lockd•_as£¹_h–d
(&
dev_»¶aû
->
rw£m
);

6738 
	`up_»ad
(&
dev_»¶aû
->
rw£m
);

6740 
	`ä“_ex‹Á_m­
(
em
);

6741  
»t
;

6742 
	}
}

6744 
boŞ
 
	$dev_¬gs_m©ch_fs_deviûs
(cÚ¡ 
bŒfs_dev_lookup_¬gs
 *
¬gs
,

6745 cÚ¡ 
bŒfs_fs_deviûs
 *
fs_deviûs
)

6747 ià(
¬gs
->
fsid
 =ğ
NULL
)

6748  
Œue
;

6749 ià(
	`memcmp
(
fs_deviûs
->
m‘ad©a_uuid
, 
¬gs
->
fsid
, 
BTRFS_FSID_SIZE
) == 0)

6750  
Œue
;

6751  
çl£
;

6752 
	}
}

6754 
boŞ
 
	$dev_¬gs_m©ch_deviû
(cÚ¡ 
bŒfs_dev_lookup_¬gs
 *
¬gs
,

6755 cÚ¡ 
bŒfs_deviû
 *
deviû
)

6757 ià(
¬gs
->
missšg
) {

6758 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
deviû
->
dev_¡©e
) &&

6759 !
deviû
->
bdev
)

6760  
Œue
;

6761  
çl£
;

6764 ià(
deviû
->
devid
 !ğ
¬gs
->devid)

6765  
çl£
;

6766 ià(
¬gs
->
uuid
 && 
	`memcmp
(
deviû
->uuid,‡rgs->uuid, 
BTRFS_UUID_SIZE
) != 0)

6767  
çl£
;

6768  
Œue
;

6769 
	}
}

6778 
bŒfs_deviû
 *
	$bŒfs_fšd_deviû
(cÚ¡ 
bŒfs_fs_deviûs
 *
fs_deviûs
,

6779 cÚ¡ 
bŒfs_dev_lookup_¬gs
 *
¬gs
)

6781 
bŒfs_deviû
 *
deviû
;

6782 
bŒfs_fs_deviûs
 *
£ed_devs
;

6784 ià(
	`dev_¬gs_m©ch_fs_deviûs
(
¬gs
, 
fs_deviûs
)) {

6785 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

6786 ià(
	`dev_¬gs_m©ch_deviû
(
¬gs
, 
deviû
))

6787  
deviû
;

6791 
	`li¡_fÜ_—ch_’Œy
(
£ed_devs
, &
fs_deviûs
->
£ed_li¡
, seed_list) {

6792 ià(!
	`dev_¬gs_m©ch_fs_deviûs
(
¬gs
, 
£ed_devs
))

6794 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
£ed_devs
->
deviûs
, 
dev_li¡
) {

6795 ià(
	`dev_¬gs_m©ch_deviû
(
¬gs
, 
deviû
))

6796  
deviû
;

6800  
NULL
;

6801 
	}
}

6803 
bŒfs_deviû
 *
	$add_missšg_dev
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

6804 
u64
 
devid
, 
u8
 *
dev_uuid
)

6806 
bŒfs_deviû
 *
deviû
;

6807 
nofs_æag
;

6816 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

6817 
deviû
 = 
	`bŒfs_®loc_deviû
(
NULL
, &
devid
, 
dev_uuid
, NULL);

6818 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

6819 ià(
	`IS_ERR
(
deviû
))

6820  
deviû
;

6822 
	`li¡_add
(&
deviû
->
dev_li¡
, &
fs_deviûs
->
deviûs
);

6823 
deviû
->
fs_deviûs
 = fs_devices;

6824 
fs_deviûs
->
num_deviûs
++;

6826 
	`£t_b™
(
BTRFS_DEV_STATE_MISSING
, &
deviû
->
dev_¡©e
);

6827 
fs_deviûs
->
missšg_deviûs
++;

6829  
deviû
;

6830 
	}
}

6847 
bŒfs_deviû
 *
	$bŒfs_®loc_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
,

6848 cÚ¡ 
u64
 *
devid
, cÚ¡ 
u8
 *
uuid
,

6849 cÚ¡ *
·th
)

6851 
bŒfs_deviû
 *
dev
;

6852 
u64
 
tmp
;

6854 ià(
	`WARN_ON
(!
devid
 && !
fs_šfo
))

6855  
	`ERR_PTR
(-
EINVAL
);

6857 
dev
 = 
	`kz®loc
((*dev), 
GFP_KERNEL
);

6858 ià(!
dev
)

6859  
	`ERR_PTR
(-
ENOMEM
);

6861 
	`INIT_LIST_HEAD
(&
dev
->
dev_li¡
);

6862 
	`INIT_LIST_HEAD
(&
dev
->
dev_®loc_li¡
);

6863 
	`INIT_LIST_HEAD
(&
dev
->
po¡_comm™_li¡
);

6865 
	`©omic_£t
(&
dev
->
dev_¡©s_cút
, 0);

6866 
	`bŒfs_deviû_d©a_Üd”ed_š™
(
dev
);

6867 
	`ex‹Á_io_Œ“_š™
(
fs_šfo
, &
dev
->
®loc_¡©e
, 
IO_TREE_DEVICE_ALLOC_STATE
);

6869 ià(
devid
)

6870 
tmp
 = *
devid
;

6872 
»t
;

6874 
»t
 = 
	`fšd_Ãxt_devid
(
fs_šfo
, &
tmp
);

6875 ià(
»t
) {

6876 
	`bŒfs_ä“_deviû
(
dev
);

6877  
	`ERR_PTR
(
»t
);

6880 
dev
->
devid
 = 
tmp
;

6882 ià(
uuid
)

6883 
	`memıy
(
dev
->
uuid
, uuid, 
BTRFS_UUID_SIZE
);

6885 
	`g’”©e_¿ndom_uuid
(
dev
->
uuid
);

6887 ià(
·th
) {

6888 
rcu_¡ršg
 *
Çme
;

6890 
Çme
 = 
	`rcu_¡ršg_¡rdup
(
·th
, 
GFP_KERNEL
);

6891 ià(!
Çme
) {

6892 
	`bŒfs_ä“_deviû
(
dev
);

6893  
	`ERR_PTR
(-
ENOMEM
);

6895 
	`rcu_assign_poš‹r
(
dev
->
Çme
,‚ame);

6898  
dev
;

6899 
	}
}

6901 
	$bŒfs_»pÜt_missšg_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
,

6902 
u64
 
devid
, 
u8
 *
uuid
, 
boŞ
 
”rÜ
)

6904 ià(
”rÜ
)

6905 
	`bŒfs_”r_¾
(
fs_šfo
, "devid %llu uuid %pU is missing",

6906 
devid
, 
uuid
);

6908 
	`bŒfs_w¬n_¾
(
fs_šfo
, "devid %llu uuid %pU is missing",

6909 
devid
, 
uuid
);

6910 
	}
}

6912 
u64
 
	$bŒfs_ÿlc_¡re_Ëngth
(cÚ¡ 
ex‹Á_m­
 *
em
)

6914 cÚ¡ 
m­_lookup
 *
m­
 = 
em
->map_lookup;

6915 cÚ¡ 
d©a_¡res
 = 
	`ÿlc_d©a_¡res
(
m­
->
ty³
, m­->
num_¡res
);

6917  
	`div_u64
(
em
->
Ën
, 
d©a_¡res
);

6918 
	}
}

6920 #ià
BITS_PER_LONG
 == 32

6928 
	$check_32b™_m‘a_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
,

6929 
u64
 
logiÿl
, u64 
Ëngth
, u64 
ty³
)

6931 ià(!(
ty³
 & 
BTRFS_BLOCK_GROUP_METADATA
))

6934 ià(
logiÿl
 + 
Ëngth
 < 
MAX_LFS_FILESIZE
)

6937 
	`bŒfs_”r_32b™_lim™
(
fs_šfo
);

6938  -
EOVERFLOW
;

6939 
	}
}

6947 
	$w¬n_32b™_m‘a_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
,

6948 
u64
 
logiÿl
, u64 
Ëngth
, u64 
ty³
)

6950 ià(!(
ty³
 & 
BTRFS_BLOCK_GROUP_METADATA
))

6953 ià(
logiÿl
 + 
Ëngth
 < 
BTRFS_32BIT_EARLY_WARN_THRESHOLD
)

6956 
	`bŒfs_w¬n_32b™_lim™
(
fs_šfo
);

6957 
	}
}

6960 
bŒfs_deviû
 *
	$hªdË_missšg_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
,

6961 
u64
 
devid
, 
u8
 *
uuid
)

6963 
bŒfs_deviû
 *
dev
;

6965 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DEGRADED
)) {

6966 
	`bŒfs_»pÜt_missšg_deviû
(
fs_šfo
, 
devid
, 
uuid
, 
Œue
);

6967  
	`ERR_PTR
(-
ENOENT
);

6970 
dev
 = 
	`add_missšg_dev
(
fs_šfo
->
fs_deviûs
, 
devid
, 
uuid
);

6971 ià(
	`IS_ERR
(
dev
)) {

6972 
	`bŒfs_”r
(
fs_šfo
, "failedo init missing device %llu: %ld",

6973 
devid
, 
	`PTR_ERR
(
dev
));

6974  
dev
;

6976 
	`bŒfs_»pÜt_missšg_deviû
(
fs_šfo
, 
devid
, 
uuid
, 
çl£
);

6978  
dev
;

6979 
	}
}

6981 
	$»ad_Úe_chunk
(
bŒfs_key
 *
key
, 
ex‹Á_bufãr
 *
Ëaf
,

6982 
bŒfs_chunk
 *
chunk
)

6984 
	`BTRFS_DEV_LOOKUP_ARGS
(
¬gs
);

6985 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

6986 
ex‹Á_m­_Œ“
 *
m­_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

6987 
m­_lookup
 *
m­
;

6988 
ex‹Á_m­
 *
em
;

6989 
u64
 
logiÿl
;

6990 
u64
 
Ëngth
;

6991 
u64
 
devid
;

6992 
u64
 
ty³
;

6993 
u8
 
uuid
[
BTRFS_UUID_SIZE
];

6994 
šdex
;

6995 
num_¡res
;

6996 
»t
;

6997 
i
;

6999 
logiÿl
 = 
key
->
off£t
;

7000 
Ëngth
 = 
	`bŒfs_chunk_Ëngth
(
Ëaf
, 
chunk
);

7001 
ty³
 = 
	`bŒfs_chunk_ty³
(
Ëaf
, 
chunk
);

7002 
šdex
 = 
	`bŒfs_bg_æags_to_¿id_šdex
(
ty³
);

7003 
num_¡res
 = 
	`bŒfs_chunk_num_¡res
(
Ëaf
, 
chunk
);

7005 #ià
BITS_PER_LONG
 == 32

7006 
»t
 = 
	`check_32b™_m‘a_chunk
(
fs_šfo
, 
logiÿl
, 
Ëngth
, 
ty³
);

7007 ià(
»t
 < 0)

7008  
»t
;

7009 
	`w¬n_32b™_m‘a_chunk
(
fs_šfo
, 
logiÿl
, 
Ëngth
, 
ty³
);

7016 ià(
Ëaf
->
¡¬t
 =ğ
BTRFS_SUPER_INFO_OFFSET
) {

7017 
»t
 = 
	`bŒfs_check_chunk_v®id
(
Ëaf
, 
chunk
, 
logiÿl
);

7018 ià(
»t
)

7019  
»t
;

7022 
	`»ad_lock
(&
m­_Œ“
->
lock
);

7023 
em
 = 
	`lookup_ex‹Á_m­pšg
(
m­_Œ“
, 
logiÿl
, 1);

7024 
	`»ad_uÆock
(&
m­_Œ“
->
lock
);

7027 ià(
em
 &&ƒm->
¡¬t
 <ğ
logiÿl
 &&ƒm->¡¬ˆ+ƒm->
Ën
 >†ogical) {

7028 
	`ä“_ex‹Á_m­
(
em
);

7030 } ià(
em
) {

7031 
	`ä“_ex‹Á_m­
(
em
);

7034 
em
 = 
	`®loc_ex‹Á_m­
();

7035 ià(!
em
)

7036  -
ENOMEM
;

7037 
m­
 = 
	`km®loc
(
	`m­_lookup_size
(
num_¡res
), 
GFP_NOFS
);

7038 ià(!
m­
) {

7039 
	`ä“_ex‹Á_m­
(
em
);

7040  -
ENOMEM
;

7043 
	`£t_b™
(
EXTENT_FLAG_FS_MAPPING
, &
em
->
æags
);

7044 
em
->
m­_lookup
 = 
m­
;

7045 
em
->
¡¬t
 = 
logiÿl
;

7046 
em
->
Ën
 = 
Ëngth
;

7047 
em
->
Üig_¡¬t
 = 0;

7048 
em
->
block_¡¬t
 = 0;

7049 
em
->
block_Ën
 =ƒm->
Ën
;

7051 
m­
->
num_¡res
 =‚um_stripes;

7052 
m­
->
io_width
 = 
	`bŒfs_chunk_io_width
(
Ëaf
, 
chunk
);

7053 
m­
->
io_®ign
 = 
	`bŒfs_chunk_io_®ign
(
Ëaf
, 
chunk
);

7054 
m­
->
ty³
 =ype;

7063 
m­
->
sub_¡res
 = 
bŒfs_¿id_¬¿y
[
šdex
].sub_stripes;

7064 
m­
->
v”if›d_¡res
 = 0;

7065 
em
->
Üig_block_Ën
 = 
	`bŒfs_ÿlc_¡re_Ëngth
(em);

7066 
i
 = 0; i < 
num_¡res
; i++) {

7067 
m­
->
¡res
[
i
].
physiÿl
 =

7068 
	`bŒfs_¡re_off£t_Ä
(
Ëaf
, 
chunk
, 
i
);

7069 
devid
 = 
	`bŒfs_¡re_devid_Ä
(
Ëaf
, 
chunk
, 
i
);

7070 
¬gs
.
devid
 = devid;

7071 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
uuid
, ()

7072 
	`bŒfs_¡re_dev_uuid_Ä
(
chunk
, 
i
),

7073 
BTRFS_UUID_SIZE
);

7074 
¬gs
.
uuid
 = uuid;

7075 
m­
->
¡res
[
i
].
dev
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, &
¬gs
);

7076 ià(!
m­
->
¡res
[
i
].
dev
) {

7077 
m­
->
¡res
[
i
].
dev
 = 
	`hªdË_missšg_deviû
(
fs_šfo
,

7078 
devid
, 
uuid
);

7079 ià(
	`IS_ERR
(
m­
->
¡res
[
i
].
dev
)) {

7080 
»t
 = 
	`PTR_ERR
(
m­
->
¡res
[
i
].
dev
);

7081 
	`ä“_ex‹Á_m­
(
em
);

7082  
»t
;

7086 
	`£t_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
,

7087 &(
m­
->
¡res
[
i
].
dev
->
dev_¡©e
));

7090 
	`wr™e_lock
(&
m­_Œ“
->
lock
);

7091 
»t
 = 
	`add_ex‹Á_m­pšg
(
m­_Œ“
, 
em
, 0);

7092 
	`wr™e_uÆock
(&
m­_Œ“
->
lock
);

7093 ià(
»t
 < 0) {

7094 
	`bŒfs_”r
(
fs_šfo
,

7096 
em
->
¡¬t
,ƒm->
Ën
, 
»t
);

7098 
	`ä“_ex‹Á_m­
(
em
);

7100  
»t
;

7101 
	}
}

7103 
	$fl_deviû_äom_™em
(
ex‹Á_bufãr
 *
Ëaf
,

7104 
bŒfs_dev_™em
 *
dev_™em
,

7105 
bŒfs_deviû
 *
deviû
)

7107 
±r
;

7109 
deviû
->
devid
 = 
	`bŒfs_deviû_id
(
Ëaf
, 
dev_™em
);

7110 
deviû
->
disk_tÙ®_by‹s
 = 
	`bŒfs_deviû_tÙ®_by‹s
(
Ëaf
, 
dev_™em
);

7111 
deviû
->
tÙ®_by‹s
 = deviû->
disk_tÙ®_by‹s
;

7112 
deviû
->
comm™_tÙ®_by‹s
 = deviû->
disk_tÙ®_by‹s
;

7113 
deviû
->
by‹s_u£d
 = 
	`bŒfs_deviû_by‹s_u£d
(
Ëaf
, 
dev_™em
);

7114 
deviû
->
comm™_by‹s_u£d
 = deviû->
by‹s_u£d
;

7115 
deviû
->
ty³
 = 
	`bŒfs_deviû_ty³
(
Ëaf
, 
dev_™em
);

7116 
deviû
->
io_®ign
 = 
	`bŒfs_deviû_io_®ign
(
Ëaf
, 
dev_™em
);

7117 
deviû
->
io_width
 = 
	`bŒfs_deviû_io_width
(
Ëaf
, 
dev_™em
);

7118 
deviû
->
£ùÜ_size
 = 
	`bŒfs_deviû_£ùÜ_size
(
Ëaf
, 
dev_™em
);

7119 
	`WARN_ON
(
deviû
->
devid
 =ğ
BTRFS_DEV_REPLACE_DEVID
);

7120 
	`ş—r_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
);

7122 
±r
 = 
	`bŒfs_deviû_uuid
(
dev_™em
);

7123 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
deviû
->
uuid
, 
±r
, 
BTRFS_UUID_SIZE
);

7124 
	}
}

7127 
	$fl_deviû_äom_™em_·¹™iÚ
(
ex‹Á_bufãr
 *
Ëaf
,

7128 
bŒfs_dev_™em
 *
dev_™em
,

7129 
bŒfs_deviû
 *
deviû
, 
·¹™iÚ_Üd”
)

7131 
±r
;

7133 
deviû
->
devid
 = 
	`bŒfs_deviû_id
(
Ëaf
, 
dev_™em
);

7134 
deviû
->
disk_tÙ®_by‹s
 = 
	`bŒfs_deviû_tÙ®_by‹s
(
Ëaf
, 
dev_™em
);

7136 
deviû
->
·¹™iÚ_¡¬t
 = deviû->
disk_tÙ®_by‹s
*
·¹™iÚ_Üd”
;

7137 
deviû
->
·¹™iÚ_’d
 = deviû->
disk_tÙ®_by‹s
*(
·¹™iÚ_Üd”
+1);

7139 
deviû
->
tÙ®_by‹s
 = deviû->
disk_tÙ®_by‹s
;

7141 
deviû
->
comm™_tÙ®_by‹s
 = deviû->
disk_tÙ®_by‹s
;

7142 
deviû
->
by‹s_u£d
 = 
	`bŒfs_deviû_by‹s_u£d
(
Ëaf
, 
dev_™em
);

7143 
deviû
->
comm™_by‹s_u£d
 = deviû->
by‹s_u£d
;

7144 
deviû
->
ty³
 = 
	`bŒfs_deviû_ty³
(
Ëaf
, 
dev_™em
);

7145 
deviû
->
io_®ign
 = 
	`bŒfs_deviû_io_®ign
(
Ëaf
, 
dev_™em
);

7146 
deviû
->
io_width
 = 
	`bŒfs_deviû_io_width
(
Ëaf
, 
dev_™em
);

7147 
deviû
->
£ùÜ_size
 = 
	`bŒfs_deviû_£ùÜ_size
(
Ëaf
, 
dev_™em
);

7148 
	`WARN_ON
(
deviû
->
devid
 =ğ
BTRFS_DEV_REPLACE_DEVID
);

7149 
	`ş—r_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
);

7151 
±r
 = 
	`bŒfs_deviû_uuid
(
dev_™em
);

7152 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
deviû
->
uuid
, 
±r
, 
BTRFS_UUID_SIZE
);

7153 
	}
}

7155 
bŒfs_fs_deviûs
 *
	$İ’_£ed_deviûs
(
bŒfs_fs_šfo
 *
fs_šfo
,

7156 
u8
 *
fsid
)

7158 
bŒfs_fs_deviûs
 *
fs_deviûs
;

7159 
»t
;

7161 
	`lockd•_as£¹_h–d
(&
uuid_mu‹x
);

7162 
	`ASSERT
(
fsid
);

7165 
	`li¡_fÜ_—ch_’Œy
(
fs_deviûs
, &
fs_šfo
->fs_deviûs->
£ed_li¡
, seed_list)

7166 ià(!
	`memcmp
(
fs_deviûs
->
fsid
, fsid, 
BTRFS_FSID_SIZE
))

7167  
fs_deviûs
;

7170 
fs_deviûs
 = 
	`fšd_fsid
(
fsid
, 
NULL
);

7171 ià(!
fs_deviûs
) {

7172 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DEGRADED
))

7173  
	`ERR_PTR
(-
ENOENT
);

7175 
fs_deviûs
 = 
	`®loc_fs_deviûs
(
fsid
, 
NULL
);

7176 ià(
	`IS_ERR
(
fs_deviûs
))

7177  
fs_deviûs
;

7179 
fs_deviûs
->
£edšg
 = 
Œue
;

7180 
fs_deviûs
->
İ’ed
 = 1;

7181  
fs_deviûs
;

7188 
fs_deviûs
 = 
	`şÚe_fs_deviûs
(fs_devices);

7189 ià(
	`IS_ERR
(
fs_deviûs
))

7190  
fs_deviûs
;

7192 
»t
 = 
	`İ’_fs_deviûs
(
fs_deviûs
, 
BLK_OPEN_READ
, 
fs_šfo
->
bdev_hŞd”
);

7193 ià(
»t
) {

7194 
	`ä“_fs_deviûs
(
fs_deviûs
);

7195  
	`ERR_PTR
(
»t
);

7198 ià(!
fs_deviûs
->
£edšg
) {

7199 
	`şo£_fs_deviûs
(
fs_deviûs
);

7200 
	`ä“_fs_deviûs
(
fs_deviûs
);

7201  
	`ERR_PTR
(-
EINVAL
);

7204 
	`li¡_add
(&
fs_deviûs
->
£ed_li¡
, &
fs_šfo
->fs_devices->seed_list);

7206  
fs_deviûs
;

7207 
	}
}

7209 
	$»ad_Úe_dev
(
ex‹Á_bufãr
 *
Ëaf
,

7210 
bŒfs_dev_™em
 *
dev_™em
)

7212 
	`BTRFS_DEV_LOOKUP_ARGS
(
¬gs
);

7213 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

7214 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

7215 
bŒfs_deviû
 *
deviû
;

7216 
u64
 
devid
;

7217 
»t
;

7218 
u8
 
fs_uuid
[
BTRFS_FSID_SIZE
];

7219 
u8
 
dev_uuid
[
BTRFS_UUID_SIZE
];

7221 
devid
 = 
	`bŒfs_deviû_id
(
Ëaf
, 
dev_™em
);

7222 
¬gs
.
devid
 = devid;

7223 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
dev_uuid
, 
	`bŒfs_deviû_uuid
(
dev_™em
),

7224 
BTRFS_UUID_SIZE
);

7225 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
fs_uuid
, 
	`bŒfs_deviû_fsid
(
dev_™em
),

7226 
BTRFS_FSID_SIZE
);

7227 
¬gs
.
uuid
 = 
dev_uuid
;

7228 
¬gs
.
fsid
 = 
fs_uuid
;

7230 ià(
	`memcmp
(
fs_uuid
, 
fs_deviûs
->
m‘ad©a_uuid
, 
BTRFS_FSID_SIZE
)) {

7231 
fs_deviûs
 = 
	`İ’_£ed_deviûs
(
fs_šfo
, 
fs_uuid
);

7232 ià(
	`IS_ERR
(
fs_deviûs
))

7233  
	`PTR_ERR
(
fs_deviûs
);

7236 
deviû
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, &
¬gs
);

7237 ià(!
deviû
) {

7238 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DEGRADED
)) {

7239 
	`bŒfs_»pÜt_missšg_deviû
(
fs_šfo
, 
devid
,

7240 
dev_uuid
, 
Œue
);

7241  -
ENOENT
;

7244 
deviû
 = 
	`add_missšg_dev
(
fs_deviûs
, 
devid
, 
dev_uuid
);

7245 ià(
	`IS_ERR
(
deviû
)) {

7246 
	`bŒfs_”r
(
fs_šfo
,

7248 
devid
, 
	`PTR_ERR
(
deviû
));

7249  
	`PTR_ERR
(
deviû
);

7251 
	`bŒfs_»pÜt_missšg_deviû
(
fs_šfo
, 
devid
, 
dev_uuid
, 
çl£
);

7253 ià(!
deviû
->
bdev
) {

7254 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DEGRADED
)) {

7255 
	`bŒfs_»pÜt_missšg_deviû
(
fs_šfo
,

7256 
devid
, 
dev_uuid
, 
Œue
);

7257  -
ENOENT
;

7259 
	`bŒfs_»pÜt_missšg_deviû
(
fs_šfo
, 
devid
,

7260 
dev_uuid
, 
çl£
);

7263 ià(!
deviû
->
bdev
 &&

7264 !
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
, &
deviû
->
dev_¡©e
)) {

7271 
deviû
->
fs_deviûs
->
missšg_deviûs
++;

7272 
	`£t_b™
(
BTRFS_DEV_STATE_MISSING
, &
deviû
->
dev_¡©e
);

7276 ià(
deviû
->
fs_deviûs
 != fs_devices) {

7277 
	`ASSERT
(
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
,

7278 &
deviû
->
dev_¡©e
));

7280 
	`li¡_move
(&
deviû
->
dev_li¡
, &
fs_deviûs
->
deviûs
);

7281 
deviû
->
fs_deviûs
->
num_deviûs
--;

7282 
fs_deviûs
->
num_deviûs
++;

7284 
deviû
->
fs_deviûs
->
missšg_deviûs
--;

7285 
fs_deviûs
->
missšg_deviûs
++;

7287 
deviû
->
fs_deviûs
 = fs_devices;

7291 ià(
deviû
->
fs_deviûs
 !ğ
fs_šfo
->fs_devices) {

7292 
	`BUG_ON
(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
));

7293 ià(
deviû
->
g’”©iÚ
 !=

7294 
	`bŒfs_deviû_g’”©iÚ
(
Ëaf
, 
dev_™em
))

7295  -
EINVAL
;

7298 
	`fl_deviû_äom_™em
(
Ëaf
, 
dev_™em
, 
deviû
);

7299 ià(
deviû
->
bdev
) {

7300 
u64
 
max_tÙ®_by‹s
 = 
	`bdev_Ä_by‹s
(
deviû
->
bdev
);

7302 ià(
deviû
->
tÙ®_by‹s
 > 
max_tÙ®_by‹s
) {

7303 
	`bŒfs_”r
(
fs_šfo
,

7305 
max_tÙ®_by‹s
, 
deviû
->
tÙ®_by‹s
);

7306  -
EINVAL
;

7309 
	`£t_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
deviû
->
dev_¡©e
);

7310 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
) &&

7311 !
	`‹¡_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
)) {

7312 
deviû
->
fs_deviûs
->
tÙ®_rw_by‹s
 +ğdeviû->
tÙ®_by‹s
;

7313 
	`©omic64_add
(
deviû
->
tÙ®_by‹s
 - deviû->
by‹s_u£d
,

7314 &
fs_šfo
->
ä“_chunk_¥aû
);

7316 
»t
 = 0;

7317  
»t
;

7318 
	}
}

7321 
	$»ad_Úe_dev_·¹™iÚ
(
ex‹Á_bufãr
 *
Ëaf
,

7322 
bŒfs_dev_™em
 *
dev_™em
, 
·¹™iÚ_Üd”
)

7324 
	`BTRFS_DEV_LOOKUP_ARGS
(
¬gs
);

7325 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

7326 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

7327 
bŒfs_deviû
 *
deviû
;

7328 
u64
 
devid
;

7329 
»t
;

7330 
u8
 
fs_uuid
[
BTRFS_FSID_SIZE
];

7331 
u8
 
dev_uuid
[
BTRFS_UUID_SIZE
];

7333 
devid
 = 
	`bŒfs_deviû_id
(
Ëaf
, 
dev_™em
);

7334 
¬gs
.
devid
 = devid;

7335 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
dev_uuid
, 
	`bŒfs_deviû_uuid
(
dev_™em
),

7336 
BTRFS_UUID_SIZE
);

7337 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
fs_uuid
, 
	`bŒfs_deviû_fsid
(
dev_™em
),

7338 
BTRFS_FSID_SIZE
);

7339 
¬gs
.
uuid
 = 
dev_uuid
;

7340 
¬gs
.
fsid
 = 
fs_uuid
;

7342 ià(
	`memcmp
(
fs_uuid
, 
fs_deviûs
->
m‘ad©a_uuid
, 
BTRFS_FSID_SIZE
)) {

7343 
fs_deviûs
 = 
	`İ’_£ed_deviûs
(
fs_šfo
, 
fs_uuid
);

7344 ià(
	`IS_ERR
(
fs_deviûs
))

7345  
	`PTR_ERR
(
fs_deviûs
);

7348 
deviû
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, &
¬gs
);

7349 ià(!
deviû
) {

7350 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DEGRADED
)) {

7351 
	`bŒfs_»pÜt_missšg_deviû
(
fs_šfo
, 
devid
,

7352 
dev_uuid
, 
Œue
);

7353  -
ENOENT
;

7356 
deviû
 = 
	`add_missšg_dev
(
fs_deviûs
, 
devid
, 
dev_uuid
);

7357 ià(
	`IS_ERR
(
deviû
)) {

7358 
	`bŒfs_”r
(
fs_šfo
,

7360 
devid
, 
	`PTR_ERR
(
deviû
));

7361  
	`PTR_ERR
(
deviû
);

7363 
	`bŒfs_»pÜt_missšg_deviû
(
fs_šfo
, 
devid
, 
dev_uuid
, 
çl£
);

7365 ià(!
deviû
->
bdev
) {

7366 ià(!
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DEGRADED
)) {

7367 
	`bŒfs_»pÜt_missšg_deviû
(
fs_šfo
,

7368 
devid
, 
dev_uuid
, 
Œue
);

7369  -
ENOENT
;

7371 
	`bŒfs_»pÜt_missšg_deviû
(
fs_šfo
, 
devid
,

7372 
dev_uuid
, 
çl£
);

7375 ià(!
deviû
->
bdev
 &&

7376 !
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
, &
deviû
->
dev_¡©e
)) {

7383 
deviû
->
fs_deviûs
->
missšg_deviûs
++;

7384 
	`£t_b™
(
BTRFS_DEV_STATE_MISSING
, &
deviû
->
dev_¡©e
);

7388 ià(
deviû
->
fs_deviûs
 != fs_devices) {

7389 
	`ASSERT
(
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
,

7390 &
deviû
->
dev_¡©e
));

7392 
	`li¡_move
(&
deviû
->
dev_li¡
, &
fs_deviûs
->
deviûs
);

7393 
deviû
->
fs_deviûs
->
num_deviûs
--;

7394 
fs_deviûs
->
num_deviûs
++;

7396 
deviû
->
fs_deviûs
->
missšg_deviûs
--;

7397 
fs_deviûs
->
missšg_deviûs
++;

7399 
deviû
->
fs_deviûs
 = fs_devices;

7403 ià(
deviû
->
fs_deviûs
 !ğ
fs_šfo
->fs_devices) {

7404 
	`BUG_ON
(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
));

7405 ià(
deviû
->
g’”©iÚ
 !=

7406 
	`bŒfs_deviû_g’”©iÚ
(
Ëaf
, 
dev_™em
))

7407  -
EINVAL
;

7410 
	`fl_deviû_äom_™em_·¹™iÚ
(
Ëaf
, 
dev_™em
, 
deviû
, 
·¹™iÚ_Üd”
);

7411 ià(
deviû
->
bdev
) {

7412 
u64
 
max_tÙ®_by‹s
 = 
	`bdev_Ä_by‹s
(
deviû
->
bdev
);

7414 ià(
deviû
->
tÙ®_by‹s
 > 
max_tÙ®_by‹s
) {

7415 
	`bŒfs_”r
(
fs_šfo
,

7417 
max_tÙ®_by‹s
, 
deviû
->
tÙ®_by‹s
);

7418  -
EINVAL
;

7421 
	`£t_b™
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
deviû
->
dev_¡©e
);

7422 ià(
	`‹¡_b™
(
BTRFS_DEV_STATE_WRITEABLE
, &
deviû
->
dev_¡©e
) &&

7423 !
	`‹¡_b™
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
deviû
->
dev_¡©e
)) {

7424 
deviû
->
fs_deviûs
->
tÙ®_rw_by‹s
 +ğdeviû->
tÙ®_by‹s
;

7425 
	`©omic64_add
(
deviû
->
tÙ®_by‹s
 - deviû->
by‹s_u£d
,

7426 &
fs_šfo
->
ä“_chunk_¥aû
);

7428 
»t
 = 0;

7429  
»t
;

7430 
	}
}

7432 
	$bŒfs_»ad_sys_¬¿y
(
bŒfs_fs_šfo
 *
fs_šfo
)

7434 
bŒfs_su³r_block
 *
su³r_cİy
 = 
fs_šfo
->super_copy;

7435 
ex‹Á_bufãr
 *
sb
;

7436 
bŒfs_disk_key
 *
disk_key
;

7437 
bŒfs_chunk
 *
chunk
;

7438 
u8
 *
¬¿y_±r
;

7439 
sb_¬¿y_off£t
;

7440 
»t
 = 0;

7441 
u32
 
num_¡res
;

7442 
u32
 
¬¿y_size
;

7443 
u32
 
Ën
 = 0;

7444 
u32
 
cur_off£t
;

7445 
u64
 
ty³
;

7446 
bŒfs_key
 
key
;

7448 
	`ASSERT
(
BTRFS_SUPER_INFO_SIZE
 <ğ
fs_šfo
->
nodesize
);

7455 
sb
 = 
	`®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
BTRFS_SUPER_INFO_OFFSET
);

7456 ià(!
sb
)

7457  -
ENOMEM
;

7458 
	`£t_ex‹Á_bufãr_u±od©e
(
sb
);

7460 
	`wr™e_ex‹Á_bufãr
(
sb
, 
su³r_cİy
, 0, 
BTRFS_SUPER_INFO_SIZE
);

7461 
¬¿y_size
 = 
	`bŒfs_su³r_sys_¬¿y_size
(
su³r_cİy
);

7463 
¬¿y_±r
 = 
su³r_cİy
->
sys_chunk_¬¿y
;

7464 
sb_¬¿y_off£t
 = 
	`off£tof
(
bŒfs_su³r_block
, 
sys_chunk_¬¿y
);

7465 
cur_off£t
 = 0;

7467 
cur_off£t
 < 
¬¿y_size
) {

7468 
disk_key
 = (
bŒfs_disk_key
 *)
¬¿y_±r
;

7469 
Ën
 = (*
disk_key
);

7470 ià(
cur_off£t
 + 
Ën
 > 
¬¿y_size
)

7471 
out_shÜt_»ad
;

7473 
	`bŒfs_disk_key_to_ıu
(&
key
, 
disk_key
);

7475 
¬¿y_±r
 +ğ
Ën
;

7476 
sb_¬¿y_off£t
 +ğ
Ën
;

7477 
cur_off£t
 +ğ
Ën
;

7479 ià(
key
.
ty³
 !ğ
BTRFS_CHUNK_ITEM_KEY
) {

7480 
	`bŒfs_”r
(
fs_šfo
,

7482 (
u32
)
key
.
ty³
, 
cur_off£t
);

7483 
»t
 = -
EIO
;

7487 
chunk
 = (
bŒfs_chunk
 *)
sb_¬¿y_off£t
;

7492 
Ën
 = 
	`bŒfs_chunk_™em_size
(1);

7493 ià(
cur_off£t
 + 
Ën
 > 
¬¿y_size
)

7494 
out_shÜt_»ad
;

7496 
num_¡res
 = 
	`bŒfs_chunk_num_¡res
(
sb
, 
chunk
);

7497 ià(!
num_¡res
) {

7498 
	`bŒfs_”r
(
fs_šfo
,

7500 
num_¡res
, 
cur_off£t
);

7501 
»t
 = -
EIO
;

7505 
ty³
 = 
	`bŒfs_chunk_ty³
(
sb
, 
chunk
);

7506 ià((
ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) == 0) {

7507 
	`bŒfs_”r
(
fs_šfo
,

7509 
ty³
, 
cur_off£t
);

7510 
»t
 = -
EIO
;

7514 
Ën
 = 
	`bŒfs_chunk_™em_size
(
num_¡res
);

7515 ià(
cur_off£t
 + 
Ën
 > 
¬¿y_size
)

7516 
out_shÜt_»ad
;

7518 
»t
 = 
	`»ad_Úe_chunk
(&
key
, 
sb
, 
chunk
);

7519 ià(
»t
)

7522 
¬¿y_±r
 +ğ
Ën
;

7523 
sb_¬¿y_off£t
 +ğ
Ën
;

7524 
cur_off£t
 +ğ
Ën
;

7526 
	`ş—r_ex‹Á_bufãr_u±od©e
(
sb
);

7527 
	`ä“_ex‹Á_bufãr_¡®e
(
sb
);

7528  
»t
;

7530 
out_shÜt_»ad
:

7531 
	`bŒfs_”r
(
fs_šfo
, "sys_arrayoo shorto„ead %u bytes‡t offset %u",

7532 
Ën
, 
cur_off£t
);

7533 
	`ş—r_ex‹Á_bufãr_u±od©e
(
sb
);

7534 
	`ä“_ex‹Á_bufãr_¡®e
(
sb
);

7535  -
EIO
;

7536 
	}
}

7546 
boŞ
 
	$bŒfs_check_rw_deg¿dabË
(
bŒfs_fs_šfo
 *
fs_šfo
,

7547 
bŒfs_deviû
 *
çšg_dev
)

7549 
ex‹Á_m­_Œ“
 *
m­_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

7550 
ex‹Á_m­
 *
em
;

7551 
u64
 
Ãxt_¡¬t
 = 0;

7552 
boŞ
 
»t
 = 
Œue
;

7554 
	`»ad_lock
(&
m­_Œ“
->
lock
);

7555 
em
 = 
	`lookup_ex‹Á_m­pšg
(
m­_Œ“
, 0, (
u64
)-1);

7556 
	`»ad_uÆock
(&
m­_Œ“
->
lock
);

7558 ià(!
em
) {

7559 
»t
 = 
çl£
;

7560 
out
;

7562 
em
) {

7563 
m­_lookup
 *
m­
;

7564 
missšg
 = 0;

7565 
max_tŞ”©ed
;

7566 
i
;

7568 
m­
 = 
em
->
m­_lookup
;

7569 
max_tŞ”©ed
 =

7570 
	`bŒfs_g‘_num_tŞ”©ed_disk_b¬r›r_çu»s
(

7571 
m­
->
ty³
);

7572 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

7573 
bŒfs_deviû
 *
dev
 = 
m­
->
¡res
[
i
].dev;

7575 ià(!
dev
 || !dev->
bdev
 ||

7576 
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
, &
dev
->
dev_¡©e
) ||

7577 
dev
->
Ï¡_æush_”rÜ
)

7578 
missšg
++;

7579 ià(
çšg_dev
 && fašg_dev =ğ
dev
)

7580 
missšg
++;

7582 ià(
missšg
 > 
max_tŞ”©ed
) {

7583 ià(!
çšg_dev
)

7584 
	`bŒfs_w¬n
(
fs_šfo
,

7586 
em
->
¡¬t
, 
missšg
, 
max_tŞ”©ed
);

7587 
	`ä“_ex‹Á_m­
(
em
);

7588 
»t
 = 
çl£
;

7589 
out
;

7591 
Ãxt_¡¬t
 = 
	`ex‹Á_m­_’d
(
em
);

7592 
	`ä“_ex‹Á_m­
(
em
);

7594 
	`»ad_lock
(&
m­_Œ“
->
lock
);

7595 
em
 = 
	`lookup_ex‹Á_m­pšg
(
m­_Œ“
, 
Ãxt_¡¬t
,

7596 (
u64
)(-1è- 
Ãxt_¡¬t
);

7597 
	`»ad_uÆock
(&
m­_Œ“
->
lock
);

7599 
out
:

7600  
»t
;

7601 
	}
}

7603 
	$»adah—d_Œ“_node_chd»n
(
ex‹Á_bufãr
 *
node
)

7605 
i
;

7606 cÚ¡ 
Ä_™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
node
);

7608 
i
 = 0; i < 
Ä_™ems
; i++)

7609 
	`bŒfs_»adah—d_node_chd
(
node
, 
i
);

7610 
	}
}

7612 
	$bŒfs_»ad_chunk_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
)

7614 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
chunk_roÙ
;

7615 
bŒfs_·th
 *
·th
;

7616 
ex‹Á_bufãr
 *
Ëaf
;

7617 
bŒfs_key
 
key
;

7618 
bŒfs_key
 
found_key
;

7619 
»t
;

7620 
¦Ù
;

7621 
™”_»t
 = 0;

7622 
u64
 
tÙ®_dev
 = 0;

7623 
u64
 
Ï¡_¿_node
 = 0;

7625 
·th
 = 
	`bŒfs_®loc_·th
();

7626 ià(!
·th
)

7627  -
ENOMEM
;

7633 
	`mu‹x_lock
(&
uuid_mu‹x
);

7641 
fs_šfo
->
fs_deviûs
->
tÙ®_rw_by‹s
 = 0;

7653 
	`ASSERT
(!
	`‹¡_b™
(
BTRFS_FS_OPEN
, &
fs_šfo
->
æags
));

7654 
·th
->
sk_lockšg
 = 1;

7662 
key
.
objeùid
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

7663 
key
.
off£t
 = 0;

7664 
key
.
ty³
 = 0;

7665 
	`bŒfs_fÜ_—ch_¦Ù
(
roÙ
, &
key
, &
found_key
, 
·th
, 
™”_»t
) {

7666 
ex‹Á_bufãr
 *
node
 = 
·th
->
nodes
[1];

7668 
Ëaf
 = 
·th
->
nodes
[0];

7669 
¦Ù
 = 
·th
->
¦Ùs
[0];

7671 ià(
node
) {

7672 ià(
Ï¡_¿_node
 !ğ
node
->
¡¬t
) {

7673 
	`»adah—d_Œ“_node_chd»n
(
node
);

7674 
Ï¡_¿_node
 = 
node
->
¡¬t
;

7677 ià(
found_key
.
ty³
 =ğ
BTRFS_DEV_ITEM_KEY
) {

7678 
bŒfs_dev_™em
 *
dev_™em
;

7679 
dev_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
,

7680 
bŒfs_dev_™em
);

7681 
»t
 = 
	`»ad_Úe_dev
(
Ëaf
, 
dev_™em
);

7682 ià(
»t
)

7683 
”rÜ
;

7684 
tÙ®_dev
++;

7685 } ià(
found_key
.
ty³
 =ğ
BTRFS_CHUNK_ITEM_KEY
) {

7686 
bŒfs_chunk
 *
chunk
;

7696 
chunk
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_chunk
);

7697 
»t
 = 
	`»ad_Úe_chunk
(&
found_key
, 
Ëaf
, 
chunk
);

7698 ià(
»t
)

7699 
”rÜ
;

7703 ià(
™”_»t
 < 0) {

7704 
»t
 = 
™”_»t
;

7705 
”rÜ
;

7712 ià(
tÙ®_dev
 !ğ
fs_šfo
->
fs_deviûs
->
tÙ®_deviûs
) {

7713 
	`bŒfs_w¬n
(
fs_šfo
,

7715 
	`bŒfs_su³r_num_deviûs
(
fs_šfo
->
su³r_cİy
),

7716 
tÙ®_dev
);

7717 
fs_šfo
->
fs_deviûs
->
tÙ®_deviûs
 = 
tÙ®_dev
;

7718 
	`bŒfs_£t_su³r_num_deviûs
(
fs_šfo
->
su³r_cİy
, 
tÙ®_dev
);

7720 ià(
	`bŒfs_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cİy
) <

7721 
fs_šfo
->
fs_deviûs
->
tÙ®_rw_by‹s
) {

7722 
	`bŒfs_”r
(
fs_šfo
,

7724 
	`bŒfs_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cİy
),

7725 
fs_šfo
->
fs_deviûs
->
tÙ®_rw_by‹s
);

7726 
»t
 = -
EINVAL
;

7727 
”rÜ
;

7729 
»t
 = 0;

7730 
”rÜ
:

7731 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

7733 
	`bŒfs_ä“_·th
(
·th
);

7734  
»t
;

7735 
	}
}

7738 
	$bŒfs_»ad_chunk_Œ“_·¹™iÚ
(
bŒfs_fs_šfo
 *
fs_šfo
, 
·¹™iÚ_Üd”
)

7740 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
chunk_roÙ
;

7741 
bŒfs_·th
 *
·th
;

7742 
ex‹Á_bufãr
 *
Ëaf
;

7743 
bŒfs_key
 
key
;

7744 
bŒfs_key
 
found_key
;

7745 
»t
;

7746 
¦Ù
;

7747 
™”_»t
 = 0;

7748 
u64
 
tÙ®_dev
 = 0;

7749 
u64
 
Ï¡_¿_node
 = 0;

7751 
·th
 = 
	`bŒfs_®loc_·th
();

7752 ià(!
·th
)

7753  -
ENOMEM
;

7759 
	`mu‹x_lock
(&
uuid_mu‹x
);

7767 
fs_šfo
->
fs_deviûs
->
tÙ®_rw_by‹s
 = 0;

7779 
	`ASSERT
(!
	`‹¡_b™
(
BTRFS_FS_OPEN
, &
fs_šfo
->
æags
));

7780 
·th
->
sk_lockšg
 = 1;

7788 
key
.
objeùid
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

7789 
key
.
off£t
 = 0;

7790 
key
.
ty³
 = 0;

7791 
	`bŒfs_fÜ_—ch_¦Ù
(
roÙ
, &
key
, &
found_key
, 
·th
, 
™”_»t
) {

7792 
ex‹Á_bufãr
 *
node
 = 
·th
->
nodes
[1];

7794 
Ëaf
 = 
·th
->
nodes
[0];

7795 
¦Ù
 = 
·th
->
¦Ùs
[0];

7797 ià(
node
) {

7798 ià(
Ï¡_¿_node
 !ğ
node
->
¡¬t
) {

7799 
	`»adah—d_Œ“_node_chd»n
(
node
);

7800 
Ï¡_¿_node
 = 
node
->
¡¬t
;

7803 ià(
found_key
.
ty³
 =ğ
BTRFS_DEV_ITEM_KEY
) {

7804 
bŒfs_dev_™em
 *
dev_™em
;

7805 
dev_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
,

7806 
bŒfs_dev_™em
);

7807 
»t
 = 
	`»ad_Úe_dev_·¹™iÚ
(
Ëaf
, 
dev_™em
, 
·¹™iÚ_Üd”
);

7808 ià(
»t
)

7809 
”rÜ
;

7810 
tÙ®_dev
++;

7811 } ià(
found_key
.
ty³
 =ğ
BTRFS_CHUNK_ITEM_KEY
) {

7812 
bŒfs_chunk
 *
chunk
;

7822 
chunk
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_chunk
);

7823 
»t
 = 
	`»ad_Úe_chunk
(&
found_key
, 
Ëaf
, 
chunk
);

7824 ià(
»t
)

7825 
”rÜ
;

7829 ià(
™”_»t
 < 0) {

7830 
»t
 = 
™”_»t
;

7831 
”rÜ
;

7838 ià(
tÙ®_dev
 !ğ
fs_šfo
->
fs_deviûs
->
tÙ®_deviûs
) {

7839 
	`bŒfs_w¬n
(
fs_šfo
,

7841 
	`bŒfs_su³r_num_deviûs
(
fs_šfo
->
su³r_cİy
),

7842 
tÙ®_dev
);

7843 
fs_šfo
->
fs_deviûs
->
tÙ®_deviûs
 = 
tÙ®_dev
;

7844 
	`bŒfs_£t_su³r_num_deviûs
(
fs_šfo
->
su³r_cİy
, 
tÙ®_dev
);

7846 ià(
	`bŒfs_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cİy
) <

7847 
fs_šfo
->
fs_deviûs
->
tÙ®_rw_by‹s
) {

7848 
	`bŒfs_”r
(
fs_šfo
,

7850 
	`bŒfs_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cİy
),

7851 
fs_šfo
->
fs_deviûs
->
tÙ®_rw_by‹s
);

7852 
»t
 = -
EINVAL
;

7853 
”rÜ
;

7855 
»t
 = 0;

7856 
”rÜ
:

7857 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

7859 
	`bŒfs_ä“_·th
(
·th
);

7860  
»t
;

7861 
	}
}

7863 
	$bŒfs_š™_deviûs_Ï‹
(
bŒfs_fs_šfo
 *
fs_šfo
)

7865 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_deviûs, *
£ed_devs
;

7866 
bŒfs_deviû
 *
deviû
;

7867 
»t
 = 0;

7869 
fs_deviûs
->
fs_šfo
 = fs_info;

7871 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

7872 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
)

7873 
deviû
->
fs_šfo
 = fs_info;

7875 
	`li¡_fÜ_—ch_’Œy
(
£ed_devs
, &
fs_deviûs
->
£ed_li¡
, seed_list) {

7876 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
£ed_devs
->
deviûs
, 
dev_li¡
) {

7877 
deviû
->
fs_šfo
 = fs_info;

7878 
»t
 = 
	`bŒfs_g‘_dev_zÚe_šfo
(
deviû
, 
çl£
);

7879 ià(
»t
)

7883 
£ed_devs
->
fs_šfo
 = fs_info;

7885 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

7887  
»t
;

7888 
	}
}

7890 
u64
 
	$bŒfs_dev_¡©s_v®ue
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

7891 cÚ¡ 
bŒfs_dev_¡©s_™em
 *
±r
,

7892 
šdex
)

7894 
u64
 
v®
;

7896 
	`»ad_ex‹Á_bufãr
(
eb
, &
v®
,

7897 
	`off£tof
(
bŒfs_dev_¡©s_™em
, 
v®ues
) +

7898 (()
±r
è+ (
šdex
 * (
u64
)),

7899 (
v®
));

7900  
v®
;

7901 
	}
}

7903 
	$bŒfs_£t_dev_¡©s_v®ue
(
ex‹Á_bufãr
 *
eb
,

7904 
bŒfs_dev_¡©s_™em
 *
±r
,

7905 
šdex
, 
u64
 
v®
)

7907 
	`wr™e_ex‹Á_bufãr
(
eb
, &
v®
,

7908 
	`off£tof
(
bŒfs_dev_¡©s_™em
, 
v®ues
) +

7909 (()
±r
è+ (
šdex
 * (
u64
)),

7910 (
v®
));

7911 
	}
}

7913 
	$bŒfs_deviû_š™_dev_¡©s
(
bŒfs_deviû
 *
deviû
,

7914 
bŒfs_·th
 *
·th
)

7916 
bŒfs_dev_¡©s_™em
 *
±r
;

7917 
ex‹Á_bufãr
 *
eb
;

7918 
bŒfs_key
 
key
;

7919 
™em_size
;

7920 
i
, 
»t
, 
¦Ù
;

7922 ià(!
deviû
->
fs_šfo
->
dev_roÙ
)

7925 
key
.
objeùid
 = 
BTRFS_DEV_STATS_OBJECTID
;

7926 
key
.
ty³
 = 
BTRFS_PERSISTENT_ITEM_KEY
;

7927 
key
.
off£t
 = 
deviû
->
devid
;

7928 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
deviû
->
fs_šfo
->
dev_roÙ
, &
key
, 
·th
, 0, 0);

7929 ià(
»t
) {

7930 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++)

7931 
	`bŒfs_dev_¡©_£t
(
deviû
, 
i
, 0);

7932 
deviû
->
dev_¡©s_v®id
 = 1;

7933 
	`bŒfs_»Ëa£_·th
(
·th
);

7934  
»t
 < 0 ?„et : 0;

7936 
¦Ù
 = 
·th
->
¦Ùs
[0];

7937 
eb
 = 
·th
->
nodes
[0];

7938 
™em_size
 = 
	`bŒfs_™em_size
(
eb
, 
¦Ù
);

7940 
±r
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_dev_¡©s_™em
);

7942 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++) {

7943 ià(
™em_size
 >ğ(1 + 
i
è* (
__Ë64
))

7944 
	`bŒfs_dev_¡©_£t
(
deviû
, 
i
,

7945 
	`bŒfs_dev_¡©s_v®ue
(
eb
, 
±r
, 
i
));

7947 
	`bŒfs_dev_¡©_£t
(
deviû
, 
i
, 0);

7950 
deviû
->
dev_¡©s_v®id
 = 1;

7951 
	`bŒfs_dev_¡©_´št_Ú_lßd
(
deviû
);

7952 
	`bŒfs_»Ëa£_·th
(
·th
);

7955 
	}
}

7957 
	$bŒfs_š™_dev_¡©s
(
bŒfs_fs_šfo
 *
fs_šfo
)

7959 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_deviûs, *
£ed_devs
;

7960 
bŒfs_deviû
 *
deviû
;

7961 
bŒfs_·th
 *
·th
 = 
NULL
;

7962 
»t
 = 0;

7964 
·th
 = 
	`bŒfs_®loc_·th
();

7965 ià(!
·th
)

7966  -
ENOMEM
;

7968 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

7969 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

7970 
»t
 = 
	`bŒfs_deviû_š™_dev_¡©s
(
deviû
, 
·th
);

7971 ià(
»t
)

7972 
out
;

7974 
	`li¡_fÜ_—ch_’Œy
(
£ed_devs
, &
fs_deviûs
->
£ed_li¡
, seed_list) {

7975 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
£ed_devs
->
deviûs
, 
dev_li¡
) {

7976 
»t
 = 
	`bŒfs_deviû_š™_dev_¡©s
(
deviû
, 
·th
);

7977 ià(
»t
)

7978 
out
;

7981 
out
:

7982 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

7984 
	`bŒfs_ä“_·th
(
·th
);

7985  
»t
;

7986 
	}
}

7988 
	$upd©e_dev_¡©_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

7989 
bŒfs_deviû
 *
deviû
)

7991 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

7992 
bŒfs_roÙ
 *
dev_roÙ
 = 
fs_šfo
->dev_root;

7993 
bŒfs_·th
 *
·th
;

7994 
bŒfs_key
 
key
;

7995 
ex‹Á_bufãr
 *
eb
;

7996 
bŒfs_dev_¡©s_™em
 *
±r
;

7997 
»t
;

7998 
i
;

8000 
key
.
objeùid
 = 
BTRFS_DEV_STATS_OBJECTID
;

8001 
key
.
ty³
 = 
BTRFS_PERSISTENT_ITEM_KEY
;

8002 
key
.
off£t
 = 
deviû
->
devid
;

8004 
·th
 = 
	`bŒfs_®loc_·th
();

8005 ià(!
·th
)

8006  -
ENOMEM
;

8007 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
dev_roÙ
, &
key
, 
·th
, -1, 1);

8008 ià(
»t
 < 0) {

8009 
	`bŒfs_w¬n_š_rcu
(
fs_šfo
,

8011 
»t
, 
	`bŒfs_dev_Çme
(
deviû
));

8012 
out
;

8015 ià(
»t
 == 0 &&

8016 
	`bŒfs_™em_size
(
·th
->
nodes
[0],…©h->
¦Ùs
[0]è< (*
±r
)) {

8018 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
dev_roÙ
, 
·th
);

8019 ià(
»t
 != 0) {

8020 
	`bŒfs_w¬n_š_rcu
(
fs_šfo
,

8022 
	`bŒfs_dev_Çme
(
deviû
), 
»t
);

8023 
out
;

8025 
»t
 = 1;

8028 ià(
»t
 == 1) {

8030 
	`bŒfs_»Ëa£_·th
(
·th
);

8031 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
dev_roÙ
, 
·th
,

8032 &
key
, (*
±r
));

8033 ià(
»t
 < 0) {

8034 
	`bŒfs_w¬n_š_rcu
(
fs_šfo
,

8036 
	`bŒfs_dev_Çme
(
deviû
), 
»t
);

8037 
out
;

8041 
eb
 = 
·th
->
nodes
[0];

8042 
±r
 = 
	`bŒfs_™em_±r
(
eb
, 
·th
->
¦Ùs
[0], 
bŒfs_dev_¡©s_™em
);

8043 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++)

8044 
	`bŒfs_£t_dev_¡©s_v®ue
(
eb
, 
±r
, 
i
,

8045 
	`bŒfs_dev_¡©_»ad
(
deviû
, 
i
));

8046 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
eb
);

8048 
out
:

8049 
	`bŒfs_ä“_·th
(
·th
);

8050  
»t
;

8051 
	}
}

8056 
	$bŒfs_run_dev_¡©s
(
bŒfs_Œªs_hªdË
 *
Œªs
)

8058 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

8059 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

8060 
bŒfs_deviû
 *
deviû
;

8061 
¡©s_út
;

8062 
»t
 = 0;

8064 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

8065 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

8066 
¡©s_út
 = 
	`©omic_»ad
(&
deviû
->
dev_¡©s_cút
);

8067 ià(!
deviû
->
dev_¡©s_v®id
 || 
¡©s_út
 == 0)

8082 
	`smp_rmb
();

8084 
»t
 = 
	`upd©e_dev_¡©_™em
(
Œªs
, 
deviû
);

8085 ià(!
»t
)

8086 
	`©omic_sub
(
¡©s_út
, &
deviû
->
dev_¡©s_cút
);

8088 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

8090  
»t
;

8091 
	}
}

8093 
	$bŒfs_dev_¡©_šc_ªd_´št
(
bŒfs_deviû
 *
dev
, 
šdex
)

8095 
	`bŒfs_dev_¡©_šc
(
dev
, 
šdex
);

8097 ià(!
dev
->
dev_¡©s_v®id
)

8099 
	`bŒfs_”r_¾_š_rcu
(
dev
->
fs_šfo
,

8101 
	`bŒfs_dev_Çme
(
dev
),

8102 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_WRITE_ERRS
),

8103 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_READ_ERRS
),

8104 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_FLUSH_ERRS
),

8105 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_CORRUPTION_ERRS
),

8106 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_GENERATION_ERRS
));

8107 
	}
}

8109 
	$bŒfs_dev_¡©_´št_Ú_lßd
(
bŒfs_deviû
 *
dev
)

8111 
i
;

8113 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++)

8114 ià(
	`bŒfs_dev_¡©_»ad
(
dev
, 
i
) != 0)

8116 ià(
i
 =ğ
BTRFS_DEV_STAT_VALUES_MAX
)

8119 
	`bŒfs_šfo_š_rcu
(
dev
->
fs_šfo
,

8121 
	`bŒfs_dev_Çme
(
dev
),

8122 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_WRITE_ERRS
),

8123 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_READ_ERRS
),

8124 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_FLUSH_ERRS
),

8125 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_CORRUPTION_ERRS
),

8126 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_GENERATION_ERRS
));

8127 
	}
}

8129 
	$bŒfs_g‘_dev_¡©s
(
bŒfs_fs_šfo
 *
fs_šfo
,

8130 
bŒfs_ioùl_g‘_dev_¡©s
 *
¡©s
)

8132 
	`BTRFS_DEV_LOOKUP_ARGS
(
¬gs
);

8133 
bŒfs_deviû
 *
dev
;

8134 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

8135 
i
;

8137 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

8138 
¬gs
.
devid
 = 
¡©s
->devid;

8139 
dev
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, &
¬gs
);

8140 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

8142 ià(!
dev
) {

8143 
	`bŒfs_w¬n
(
fs_šfo
, "get dev_stats failed, device‚ot found");

8144  -
ENODEV
;

8145 } ià(!
dev
->
dev_¡©s_v®id
) {

8146 
	`bŒfs_w¬n
(
fs_šfo
, "get dev_stats failed,‚ot yet valid");

8147  -
ENODEV
;

8148 } ià(
¡©s
->
æags
 & 
BTRFS_DEV_STATS_RESET
) {

8149 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++) {

8150 ià(
¡©s
->
Ä_™ems
 > 
i
)

8151 
¡©s
->
v®ues
[
i
] =

8152 
	`bŒfs_dev_¡©_»ad_ªd_»£t
(
dev
, 
i
);

8154 
	`bŒfs_dev_¡©_£t
(
dev
, 
i
, 0);

8156 
	`bŒfs_šfo
(
fs_šfo
, "device stats zeroed by %s (%d)",

8157 
cu¼’t
->
comm
, 
	`sk_pid_Ä
(current));

8159 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++)

8160 ià(
¡©s
->
Ä_™ems
 > 
i
)

8161 
¡©s
->
v®ues
[
i
] = 
	`bŒfs_dev_¡©_»ad
(
dev
, i);

8163 ià(
¡©s
->
Ä_™ems
 > 
BTRFS_DEV_STAT_VALUES_MAX
)

8164 
¡©s
->
Ä_™ems
 = 
BTRFS_DEV_STAT_VALUES_MAX
;

8166 
	}
}

8175 
	$bŒfs_comm™_deviû_sizes
(
bŒfs_Œª§ùiÚ
 *
Œªs
)

8177 
bŒfs_deviû
 *
cu¼
, *
Ãxt
;

8179 
	`ASSERT
(
Œªs
->
¡©e
 =ğ
TRANS_STATE_COMMIT_DOING
);

8181 ià(
	`li¡_em±y
(&
Œªs
->
dev_upd©e_li¡
))

8189 
	`mu‹x_lock
(&
Œªs
->
fs_šfo
->
chunk_mu‹x
);

8190 
	`li¡_fÜ_—ch_’Œy_§ã
(
cu¼
, 
Ãxt
, &
Œªs
->
dev_upd©e_li¡
,

8191 
po¡_comm™_li¡
) {

8192 
	`li¡_d–_š™
(&
cu¼
->
po¡_comm™_li¡
);

8193 
cu¼
->
comm™_tÙ®_by‹s
 = cu¼->
disk_tÙ®_by‹s
;

8194 
cu¼
->
comm™_by‹s_u£d
 = cu¼->
by‹s_u£d
;

8196 
	`mu‹x_uÆock
(&
Œªs
->
fs_šfo
->
chunk_mu‹x
);

8197 
	}
}

8202 
	$bŒfs_bg_ty³_to_çùÜ
(
u64
 
æags
)

8204 cÚ¡ 
šdex
 = 
	`bŒfs_bg_æags_to_¿id_šdex
(
æags
);

8206  
bŒfs_¿id_¬¿y
[
šdex
].
ncİ›s
;

8207 
	}
}

8211 
	$v”ify_Úe_dev_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

8212 
u64
 
chunk_off£t
, u64 
devid
,

8213 
u64
 
physiÿl_off£t
, u64 
physiÿl_Ën
)

8215 
bŒfs_dev_lookup_¬gs
 
¬gs
 = { .
devid
 = devid };

8216 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

8217 
ex‹Á_m­
 *
em
;

8218 
m­_lookup
 *
m­
;

8219 
bŒfs_deviû
 *
dev
;

8220 
u64
 
¡re_Ën
;

8221 
boŞ
 
found
 = 
çl£
;

8222 
»t
 = 0;

8223 
i
;

8225 
	`»ad_lock
(&
em_Œ“
->
lock
);

8226 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
chunk_off£t
, 1);

8227 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

8229 ià(!
em
) {

8230 
	`bŒfs_”r
(
fs_šfo
,

8232 
physiÿl_off£t
, 
devid
);

8233 
»t
 = -
EUCLEAN
;

8234 
out
;

8237 
m­
 = 
em
->
m­_lookup
;

8238 
¡re_Ën
 = 
	`bŒfs_ÿlc_¡re_Ëngth
(
em
);

8239 ià(
physiÿl_Ën
 !ğ
¡re_Ën
) {

8240 
	`bŒfs_”r
(
fs_šfo
,

8242 
physiÿl_off£t
, 
devid
, 
em
->
¡¬t
, 
physiÿl_Ën
,

8243 
¡re_Ën
);

8244 
»t
 = -
EUCLEAN
;

8245 
out
;

8253 ià(
physiÿl_off£t
 < 
BTRFS_DEVICE_RANGE_RESERVED
)

8254 
	`bŒfs_w¬n
(
fs_šfo
,

8256 
devid
, 
physiÿl_off£t
, 
physiÿl_Ën
);

8258 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

8259 ià(
m­
->
¡res
[
i
].
dev
->
devid
 == devid &&

8260 
m­
->
¡res
[
i
].
physiÿl
 =ğ
physiÿl_off£t
) {

8261 
found
 = 
Œue
;

8262 ià(
m­
->
v”if›d_¡res
 >ğm­->
num_¡res
) {

8263 
	`bŒfs_”r
(
fs_šfo
,

8265 
em
->
¡¬t
);

8266 
»t
 = -
EUCLEAN
;

8267 
out
;

8269 
m­
->
v”if›d_¡res
++;

8273 ià(!
found
) {

8274 
	`bŒfs_”r
(
fs_šfo
,

8276 
physiÿl_off£t
, 
devid
);

8277 
»t
 = -
EUCLEAN
;

8281 
dev
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
->
fs_deviûs
, &
¬gs
);

8282 ià(!
dev
) {

8283 
	`bŒfs_”r
(
fs_šfo
, "çedØfšd devid %Îu", 
devid
);

8284 
»t
 = -
EUCLEAN
;

8285 
out
;

8289 ià(
physiÿl_off£t
 + 
physiÿl_Ën
 > 
dev
->
·¹™iÚ_’d
) {

8290 
	`bŒfs_”r
(
fs_šfo
,

8292 
devid
, 
physiÿl_off£t
, 
physiÿl_Ën
,

8293 
dev
->
disk_tÙ®_by‹s
);

8294 
»t
 = -
EUCLEAN
;

8295 
out
;

8298 ià(
dev
->
zÚe_šfo
) {

8299 
u64
 
zÚe_size
 = 
dev
->
zÚe_šfo
->zone_size;

8301 ià(!
	`IS_ALIGNED
(
physiÿl_off£t
, 
zÚe_size
) ||

8302 !
	`IS_ALIGNED
(
physiÿl_Ën
, 
zÚe_size
)) {

8303 
	`bŒfs_”r
(
fs_šfo
,

8305 
devid
, 
physiÿl_off£t
, 
physiÿl_Ën
);

8306 
»t
 = -
EUCLEAN
;

8307 
out
;

8311 
out
:

8312 
	`ä“_ex‹Á_m­
(
em
);

8313  
»t
;

8314 
	}
}

8316 
	$v”ify_chunk_dev_ex‹Á_m­pšg
(
bŒfs_fs_šfo
 *
fs_šfo
)

8318 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

8319 
ex‹Á_m­
 *
em
;

8320 
rb_node
 *
node
;

8321 
»t
 = 0;

8323 
	`»ad_lock
(&
em_Œ“
->
lock
);

8324 
node
 = 
	`rb_fœ¡_ÿched
(&
em_Œ“
->
m­
);‚ode;‚odğ
	`rb_Ãxt
(node)) {

8325 
em
 = 
	`rb_’Œy
(
node
, 
ex‹Á_m­
, 
rb_node
);

8326 ià(
em
->
m­_lookup
->
num_¡res
 !=

8327 
em
->
m­_lookup
->
v”if›d_¡res
) {

8328 
	`bŒfs_”r
(
fs_šfo
,

8330 
em
->
¡¬t
,ƒm->
m­_lookup
->
v”if›d_¡res
,

8331 
em
->
m­_lookup
->
num_¡res
);

8332 
»t
 = -
EUCLEAN
;

8333 
out
;

8336 
out
:

8337 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

8338  
»t
;

8339 
	}
}

8348 
	$bŒfs_v”ify_dev_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
)

8350 
bŒfs_·th
 *
·th
;

8351 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

8352 
bŒfs_key
 
key
;

8353 
u64
 
´ev_devid
 = 0;

8354 
u64
 
´ev_dev_ext_’d
 = 0;

8355 
»t
 = 0;

8367 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
IGNOREBADROOTS
))

8370 
key
.
objeùid
 = 1;

8371 
key
.
ty³
 = 
BTRFS_DEV_EXTENT_KEY
;

8372 
key
.
off£t
 = 0;

8374 
·th
 = 
	`bŒfs_®loc_·th
();

8375 ià(!
·th
)

8376  -
ENOMEM
;

8378 
·th
->
»ada
 = 
READA_FORWARD
;

8379 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

8380 ià(
»t
 < 0)

8381 
out
;

8383 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0])) {

8384 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

8385 ià(
»t
 < 0)

8386 
out
;

8388 ià(
»t
 > 0) {

8389 
»t
 = -
EUCLEAN
;

8390 
out
;

8394 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

8395 
bŒfs_dev_ex‹Á
 *
dext
;

8396 
¦Ù
 = 
·th
->
¦Ùs
[0];

8397 
u64
 
chunk_off£t
;

8398 
u64
 
physiÿl_off£t
;

8399 
u64
 
physiÿl_Ën
;

8400 
u64
 
devid
;

8402 
	`bŒfs_™em_key_to_ıu
(
Ëaf
, &
key
, 
¦Ù
);

8403 ià(
key
.
ty³
 !ğ
BTRFS_DEV_EXTENT_KEY
)

8405 
devid
 = 
key
.
objeùid
;

8406 
physiÿl_off£t
 = 
key
.
off£t
;

8408 
dext
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_dev_ex‹Á
);

8409 
chunk_off£t
 = 
	`bŒfs_dev_ex‹Á_chunk_off£t
(
Ëaf
, 
dext
);

8410 
physiÿl_Ën
 = 
	`bŒfs_dev_ex‹Á_Ëngth
(
Ëaf
, 
dext
);

8413 ià(
devid
 =ğ
´ev_devid
 && 
physiÿl_off£t
 < 
´ev_dev_ext_’d
) {

8414 
	`bŒfs_”r
(
fs_šfo
,

8416 
devid
, 
physiÿl_off£t
, 
´ev_dev_ext_’d
);

8417 
»t
 = -
EUCLEAN
;

8418 
out
;

8422 
»t
 = 
	`v”ify_Úe_dev_ex‹Á
(
fs_šfo
, 
chunk_off£t
, 
devid
,

8423 
physiÿl_off£t
, 
physiÿl_Ën
);

8424 ià(
»t
 < 0)

8425 
out
;

8426 
´ev_devid
 = 
devid
;

8427 
´ev_dev_ext_’d
 = 
physiÿl_off£t
 + 
physiÿl_Ën
;

8429 
»t
 = 
	`bŒfs_Ãxt_™em
(
roÙ
, 
·th
);

8430 ià(
»t
 < 0)

8431 
out
;

8432 ià(
»t
 > 0) {

8433 
»t
 = 0;

8439 
»t
 = 
	`v”ify_chunk_dev_ex‹Á_m­pšg
(
fs_šfo
);

8440 
out
:

8441 
	`bŒfs_ä“_·th
(
·th
);

8442  
»t
;

8443 
	}
}

8449 
boŞ
 
	$bŒfs_pšÃd_by_sw­fe
(
bŒfs_fs_šfo
 *
fs_šfo
, *
±r
)

8451 
bŒfs_sw­fe_pš
 *
¥
;

8452 
rb_node
 *
node
;

8454 
	`¥š_lock
(&
fs_šfo
->
sw­fe_pšs_lock
);

8455 
node
 = 
fs_šfo
->
sw­fe_pšs
.
rb_node
;

8456 
node
) {

8457 
¥
 = 
	`rb_’Œy
(
node
, 
bŒfs_sw­fe_pš
,‚ode);

8458 ià(
±r
 < 
¥
->ptr)

8459 
node
 =‚ode->
rb_Ëá
;

8460 ià(
±r
 > 
¥
->ptr)

8461 
node
 =‚ode->
rb_right
;

8465 
	`¥š_uÆock
(&
fs_šfo
->
sw­fe_pšs_lock
);

8466  
node
 !ğ
NULL
;

8467 
	}
}

8469 
	$»loÿtšg_»·œ_kth»ad
(*
d©a
)

8471 
bŒfs_block_group
 *
ÿche
 = 
d©a
;

8472 
bŒfs_fs_šfo
 *
fs_šfo
 = 
ÿche
->fs_info;

8473 
u64
 
rg‘
;

8474 
»t
 = 0;

8476 
rg‘
 = 
ÿche
->
¡¬t
;

8477 
	`bŒfs_put_block_group
(
ÿche
);

8479 
	`sb_¡¬t_wr™e
(
fs_šfo
->
sb
);

8480 ià(!
	`bŒfs_exşİ_¡¬t
(
fs_šfo
, 
BTRFS_EXCLOP_BALANCE
)) {

8481 
	`bŒfs_šfo
(
fs_šfo
,

8483 
rg‘
);

8484 
	`sb_’d_wr™e
(
fs_šfo
->
sb
);

8485  -
EBUSY
;

8488 
	`mu‹x_lock
(&
fs_šfo
->
»şaim_bgs_lock
);

8491 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
rg‘
);

8492 ià(!
ÿche
)

8493 
out
;

8495 ià(!
	`‹¡_b™
(
BLOCK_GROUP_FLAG_RELOCATING_REPAIR
, &
ÿche
->
ruÁime_æags
))

8496 
out
;

8498 
»t
 = 
	`bŒfs_may_®loc_d©a_chunk
(
fs_šfo
, 
rg‘
);

8499 ià(
»t
 < 0)

8500 
out
;

8502 
	`bŒfs_šfo
(
fs_šfo
,

8504 
rg‘
);

8505 
»t
 = 
	`bŒfs_»loÿ‹_chunk
(
fs_šfo
, 
rg‘
);

8507 
out
:

8508 ià(
ÿche
)

8509 
	`bŒfs_put_block_group
(
ÿche
);

8510 
	`mu‹x_uÆock
(&
fs_šfo
->
»şaim_bgs_lock
);

8511 
	`bŒfs_exşİ_fšish
(
fs_šfo
);

8512 
	`sb_’d_wr™e
(
fs_šfo
->
sb
);

8514  
»t
;

8515 
	}
}

8517 
boŞ
 
	$bŒfs_»·œ_Úe_zÚe
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
)

8519 
bŒfs_block_group
 *
ÿche
;

8521 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

8522  
çl£
;

8525 ià(
	`bŒfs_‹¡_İt
(
fs_šfo
, 
DEGRADED
))

8526  
Œue
;

8528 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
logiÿl
);

8529 ià(!
ÿche
)

8530  
Œue
;

8532 ià(
	`‹¡_ªd_£t_b™
(
BLOCK_GROUP_FLAG_RELOCATING_REPAIR
, &
ÿche
->
ruÁime_æags
)) {

8533 
	`bŒfs_put_block_group
(
ÿche
);

8534  
Œue
;

8537 
	`kth»ad_run
(
»loÿtšg_»·œ_kth»ad
, 
ÿche
,

8540  
Œue
;

8541 
	}
}

8543 
	$m­_¿id56_»·œ_block
(
bŒfs_io_cÚ‹xt
 *
bioc
,

8544 
bŒfs_io_¡re
 *
sm­
,

8545 
u64
 
logiÿl
)

8547 
d©a_¡res
 = 
	`Ä_bioc_d©a_¡res
(
bioc
);

8548 
i
;

8550 
i
 = 0; i < 
d©a_¡res
; i++) {

8551 
u64
 
¡re_¡¬t
 = 
bioc
->
fuÎ_¡re_logiÿl
 +

8552 
	`bŒfs_¡re_Ä_to_off£t
(
i
);

8554 ià(
logiÿl
 >ğ
¡re_¡¬t
 &&

8555 
logiÿl
 < 
¡re_¡¬t
 + 
BTRFS_STRIPE_LEN
)

8558 
	`ASSERT
(
i
 < 
d©a_¡res
);

8559 
sm­
->
dev
 = 
bioc
->
¡res
[
i
].dev;

8560 
sm­
->
physiÿl
 = 
bioc
->
¡res
[
i
].physical +

8561 ((
logiÿl
 - 
bioc
->
fuÎ_¡re_logiÿl
) &

8562 
BTRFS_STRIPE_LEN_MASK
);

8563 
	}
}

8578 
	$bŒfs_m­_»·œ_block
(
bŒfs_fs_šfo
 *
fs_šfo
,

8579 
bŒfs_io_¡re
 *
sm­
, 
u64
 
logiÿl
,

8580 
u32
 
Ëngth
, 
mœrÜ_num
)

8582 
bŒfs_io_cÚ‹xt
 *
bioc
 = 
NULL
;

8583 
u64
 
m­_Ëngth
 = 
Ëngth
;

8584 
mœrÜ_»t
 = 
mœrÜ_num
;

8585 
»t
;

8587 
	`ASSERT
(
mœrÜ_num
 > 0);

8589 
»t
 = 
	`bŒfs_m­_block
(
fs_šfo
, 
BTRFS_MAP_WRITE
, 
logiÿl
, &
m­_Ëngth
,

8590 &
bioc
, 
sm­
, &
mœrÜ_»t
, 
Œue
);

8591 ià(
»t
 < 0)

8592  
»t
;

8595 
	`ASSERT
(
m­_Ëngth
 >ğ
Ëngth
);

8598 ià(!
bioc
)

8599 
out
;

8602 ià(
bioc
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

8603 
	`m­_¿id56_»·œ_block
(
bioc
, 
sm­
, 
logiÿl
);

8604 
out
;

8607 
	`ASSERT
(
mœrÜ_num
 <ğ
bioc
->
num_¡res
);

8608 
sm­
->
dev
 = 
bioc
->
¡res
[
mœrÜ_num
 - 1].dev;

8609 
sm­
->
physiÿl
 = 
bioc
->
¡res
[
mœrÜ_num
 - 1].physical;

8610 
out
:

8611 
	`bŒfs_put_bioc
(
bioc
);

8612 
	`ASSERT
(
sm­
->
dev
);

8614 
	}
}

	@volumes.h

6 #iâdeà
BTRFS_VOLUMES_H


7 
	#BTRFS_VOLUMES_H


	)

9 
	~<lšux/sÜt.h
>

10 
	~<lšux/bŒfs.h
>

11 
	~"async-th»ad.h
"

12 
	~"mes§ges.h
"

13 
	~"Œ“-check”.h
"

14 
	~"rcu-¡ršg.h
"

16 
	#BTRFS_MAX_DATA_CHUNK_SIZE
 (10ULL * 
SZ_1G
)

	)

18 
mu‹x
 
uuid_mu‹x
;

20 
	#BTRFS_STRIPE_LEN
 
SZ_64K


	)

21 
	#BTRFS_STRIPE_LEN_SHIFT
 (16)

	)

22 
	#BTRFS_STRIPE_LEN_MASK
 (
BTRFS_STRIPE_LEN
 - 1)

	)

24 
¡©ic_as£¹
(
cÚ¡_og2
(
BTRFS_STRIPE_LEN
è=ğ
BTRFS_STRIPE_LEN_SHIFT
);

27 
	#cÚ¡_ffs
(
n
è(
	`__butš_ùzÎ
Òè+ 1)

	)

35 
¡©ic_as£¹
(
cÚ¡_ffs
(
BTRFS_BLOCK_GROUP_RAID0
) <

36 
cÚ¡_ffs
(
BTRFS_BLOCK_GROUP_PROFILE_MASK
 & ~
BTRFS_BLOCK_GROUP_RAID0
));

37 
¡©ic_as£¹
(
cÚ¡_og2
(
BTRFS_BLOCK_GROUP_RAID0
) >

38 
og2
(
BTRFS_BLOCK_GROUP_TYPE_MASK
));

41 
	#BTRFS_BG_FLAG_TO_INDEX
(
´ofe
) \

42 
	`og2
((
´ofe
è>> (og2(
BTRFS_BLOCK_GROUP_RAID0
è- 1))

	)

44 
	ebŒfs_¿id_ty³s
 {

46 
	mBTRFS_RAID_SINGLE
 = 0,

48 
	mBTRFS_RAID_RAID0
 = 
BTRFS_BG_FLAG_TO_INDEX
(
BTRFS_BLOCK_GROUP_RAID0
),

49 
	mBTRFS_RAID_RAID1
 = 
BTRFS_BG_FLAG_TO_INDEX
(
BTRFS_BLOCK_GROUP_RAID1
),

50 
	mBTRFS_RAID_DUP
 = 
BTRFS_BG_FLAG_TO_INDEX
(
BTRFS_BLOCK_GROUP_DUP
),

51 
	mBTRFS_RAID_RAID10
 = 
BTRFS_BG_FLAG_TO_INDEX
(
BTRFS_BLOCK_GROUP_RAID10
),

52 
	mBTRFS_RAID_RAID5
 = 
BTRFS_BG_FLAG_TO_INDEX
(
BTRFS_BLOCK_GROUP_RAID5
),

53 
	mBTRFS_RAID_RAID6
 = 
BTRFS_BG_FLAG_TO_INDEX
(
BTRFS_BLOCK_GROUP_RAID6
),

54 
	mBTRFS_RAID_RAID1C3
 = 
BTRFS_BG_FLAG_TO_INDEX
(
BTRFS_BLOCK_GROUP_RAID1C3
),

55 
	mBTRFS_RAID_RAID1C4
 = 
BTRFS_BG_FLAG_TO_INDEX
(
BTRFS_BLOCK_GROUP_RAID1C4
),

57 
	mBTRFS_NR_RAID_TYPES


64 #ià
BITS_PER_LONG
==32 && 
defšed
(
CONFIG_SMP
)

65 
	~<lšux/£qlock.h
>

66 
	#__BTRFS_NEED_DEVICE_DATA_ORDERED


	)

67 
	#bŒfs_deviû_d©a_Üd”ed_š™
(
deviû
) \

68 
	`£qcouÁ_š™
(&
deviû
->
d©a_£qcouÁ
)

	)

70 
	#bŒfs_deviû_d©a_Üd”ed_š™
(
deviû
èdØ{ } 0)

	)

73 
	#BTRFS_DEV_STATE_WRITEABLE
 (0)

	)

74 
	#BTRFS_DEV_STATE_IN_FS_METADATA
 (1)

	)

75 
	#BTRFS_DEV_STATE_MISSING
 (2)

	)

76 
	#BTRFS_DEV_STATE_REPLACE_TGT
 (3)

	)

77 
	#BTRFS_DEV_STATE_FLUSH_SENT
 (4)

	)

78 
	#BTRFS_DEV_STATE_NO_READA
 (5)

	)

80 
	gbŒfs_zÚed_deviû_šfo
;

82 
	sbŒfs_deviû
 {

83 
li¡_h—d
 
	mdev_li¡
;

84 
li¡_h—d
 
	mdev_®loc_li¡
;

85 
li¡_h—d
 
	mpo¡_comm™_li¡
;

86 
bŒfs_fs_deviûs
 *
	mfs_deviûs
;

87 
bŒfs_fs_šfo
 *
	mfs_šfo
;

89 
rcu_¡ršg
 
__rcu
 *
	mÇme
;

91 
u64
 
	mg’”©iÚ
;

93 
block_deviû
 *
	mbdev
;

95 
bŒfs_zÚed_deviû_šfo
 *
	mzÚe_šfo
;

98 *
	mhŞd”
;

104 
dev_t
 
	mdevt
;

105 
	mdev_¡©e
;

106 
blk_¡©us_t
 
	mÏ¡_æush_”rÜ
;

108 #ifdeà
__BTRFS_NEED_DEVICE_DATA_ORDERED


109 
£qcouÁ_t
 
	md©a_£qcouÁ
;

113 
u64
 
	mdevid
;

116 
u64
 
	mtÙ®_by‹s
;

119 
u64
 
	mdisk_tÙ®_by‹s
;

122 
u64
 
	m·¹™iÚ_¡¬t
;

123 
u64
 
	m·¹™iÚ_’d
;

126 
u64
 
	mby‹s_u£d
;

129 
u32
 
	mio_®ign
;

132 
u32
 
	mio_width
;

134 
u64
 
	mty³
;

137 
u32
 
	m£ùÜ_size
;

140 
u8
 
	muuid
[
BTRFS_UUID_SIZE
];

148 
u64
 
	mcomm™_tÙ®_by‹s
;

151 
u64
 
	mcomm™_by‹s_u£d
;

154 
bio
 
	mæush_bio
;

155 
com¶‘iÚ
 
	mæush_wa™
;

158 
süub_ùx
 *
	msüub_ùx
;

162 
	mdev_¡©s_v®id
;

165 
©omic_t
 
	mdev_¡©s_cút
;

166 
©omic_t
 
	mdev_¡©_v®ues
[
BTRFS_DEV_STAT_VALUES_MAX
];

168 
ex‹Á_io_Œ“
 
	m®loc_¡©e
;

170 
com¶‘iÚ
 
	mkobj_uÄegi¡”
;

172 
kobjeù
 
	mdevid_kobj
;

175 
u64
 
	msüub_¥“d_max
;

187 
	sbŒfs_sw­fe_pš
 {

188 
rb_node
 
	mnode
;

189 *
	m±r
;

190 
šode
 *
	mšode
;

195 
boŞ
 
	mis_block_group
;

200 
	mbg_ex‹Á_couÁ
;

207 #ià
BITS_PER_LONG
==32 && 
defšed
(
CONFIG_SMP
)

208 
	#BTRFS_DEVICE_GETSET_FUNCS
(
Çme
) \

209 
šlše
 
u64
 \

210 
bŒfs_deviû_g‘_
##
	`Çme
(cÚ¡ 
bŒfs_deviû
 *
dev
) \

212 
u64
 
size
; \

213 
£q
; \

216 
£q
 = 
	`»ad_£qcouÁ_begš
(&
dev
->
d©a_£qcouÁ
); \

217 
size
 = 
dev
->
Çme
; \

218 } 
	`»ad_£qcouÁ_»Œy
(&
dev
->
d©a_£qcouÁ
, 
£q
)); \

219  
size
; \

222 
šlše
 \

223 
bŒfs_deviû_£t_
##
	`Çme
(
bŒfs_deviû
 *
dev
, 
u64
 
size
) \

225 
	`´“m±_di§bË
(); \

226 
	`wr™e_£qcouÁ_begš
(&
dev
->
d©a_£qcouÁ
); \

227 
dev
->
Çme
 = 
size
; \

228 
	`wr™e_£qcouÁ_’d
(&
dev
->
d©a_£qcouÁ
); \

229 
	`´“m±_’abË
(); \

230 }

	)

231 #–ià
BITS_PER_LONG
==32 && 
defšed
(
CONFIG_PREEMPTION
)

232 
	#BTRFS_DEVICE_GETSET_FUNCS
(
Çme
) \

233 
šlše
 
u64
 \

234 
bŒfs_deviû_g‘_
##
	`Çme
(cÚ¡ 
bŒfs_deviû
 *
dev
) \

236 
u64
 
size
; \

238 
	`´“m±_di§bË
(); \

239 
size
 = 
dev
->
Çme
; \

240 
	`´“m±_’abË
(); \

241  
size
; \

244 
šlše
 \

245 
bŒfs_deviû_£t_
##
	`Çme
(
bŒfs_deviû
 *
dev
, 
u64
 
size
) \

247 
	`´“m±_di§bË
(); \

248 
dev
->
Çme
 = 
size
; \

249 
	`´“m±_’abË
(); \

250 }

	)

252 
	#BTRFS_DEVICE_GETSET_FUNCS
(
Çme
) \

253 
šlše
 
u64
 \

254 
bŒfs_deviû_g‘_
##
	`Çme
(cÚ¡ 
bŒfs_deviû
 *
dev
) \

256  
dev
->
Çme
; \

259 
šlše
 \

260 
bŒfs_deviû_£t_
##
	`Çme
(
bŒfs_deviû
 *
dev
, 
u64
 
size
) \

262 
dev
->
Çme
 = 
size
; \

263 }

	)

266 
BTRFS_DEVICE_GETSET_FUNCS
(
tÙ®_by‹s
);

267 
BTRFS_DEVICE_GETSET_FUNCS
(
disk_tÙ®_by‹s
);

268 
BTRFS_DEVICE_GETSET_FUNCS
(
by‹s_u£d
);

270 
	ebŒfs_chunk_®loÿtiÚ_pŞicy
 {

271 
	mBTRFS_CHUNK_ALLOC_REGULAR
,

272 
	mBTRFS_CHUNK_ALLOC_ZONED
,

279 
	ebŒfs_»ad_pŞicy
 {

281 
	mBTRFS_READ_POLICY_PID
,

282 
	mBTRFS_NR_READ_POLICY
,

285 
	sbŒfs_fs_deviûs
 {

286 
u8
 
	mfsid
[
BTRFS_FSID_SIZE
];

298 
u8
 
	mm‘ad©a_uuid
[
BTRFS_FSID_SIZE
];

300 
li¡_h—d
 
	mfs_li¡
;

306 
u64
 
	mnum_deviûs
;

312 
u64
 
	mİ’_deviûs
;

315 
u64
 
	mrw_deviûs
;

318 
u64
 
	mmissšg_deviûs
;

319 
u64
 
	mtÙ®_rw_by‹s
;

326 
u64
 
	mtÙ®_deviûs
;

329 
u64
 
	mÏ‹¡_g’”©iÚ
;

335 
bŒfs_deviû
 *
	mÏ‹¡_dev
;

343 
mu‹x
 
	mdeviû_li¡_mu‹x
;

346 
li¡_h—d
 
	mdeviûs
;

349 
li¡_h—d
 
	m®loc_li¡
;

351 
li¡_h—d
 
	m£ed_li¡
;

354 
	mİ’ed
;

357 
boŞ
 
	mrÙ©šg
;

359 
boŞ
 
	mdisÿrdabË
;

360 
boŞ
 
	mfsid_chªge
;

362 
boŞ
 
	m£edšg
;

364 
bŒfs_fs_šfo
 *
	mfs_šfo
;

366 
kobjeù
 
	mfsid_kobj
;

367 
kobjeù
 *
	mdeviûs_kobj
;

368 
kobjeù
 *
	mdevšfo_kobj
;

369 
com¶‘iÚ
 
	mkobj_uÄegi¡”
;

371 
bŒfs_chunk_®loÿtiÚ_pŞicy
 
	mchunk_®loc_pŞicy
;

374 
bŒfs_»ad_pŞicy
 
	m»ad_pŞicy
;

377 
	#BTRFS_MAX_DEVS
(
šfo
è((
	`BTRFS_MAX_ITEM_SIZE
(info) \

378 - (
bŒfs_chunk
)) \

379 / (
bŒfs_¡re
è+ 1)

	)

381 
	#BTRFS_MAX_DEVS_SYS_CHUNK
 ((
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
 \

382 - 2 * (
bŒfs_disk_key
) \

383 - 2 * (
bŒfs_chunk
)) \

384 / (
bŒfs_¡re
è+ 1)

	)

386 
	sbŒfs_io_¡re
 {

387 
bŒfs_deviû
 *
	mdev
;

390 
u64
 
	mphysiÿl
;

392 
bŒfs_io_cÚ‹xt
 *
	mbioc
;

396 
	sbŒfs_disÿrd_¡re
 {

397 
bŒfs_deviû
 *
	mdev
;

398 
u64
 
	mphysiÿl
;

399 
u64
 
	mËngth
;

418 
	sbŒfs_io_cÚ‹xt
 {

419 
»fcouÁ_t
 
	m»fs
;

420 
bŒfs_fs_šfo
 *
	mfs_šfo
;

421 
u64
 
	mm­_ty³
;

422 
bio
 *
	mÜig_bio
;

423 
©omic_t
 
	m”rÜ
;

424 
u16
 
	mmax_”rÜs
;

430 
u16
 
	mnum_¡res
;

438 
u16
 
	mmœrÜ_num
;

473 
u16
 
	m»¶aû_Ä_¡res
;

474 
s16
 
	m»¶aû_¡re_¤c
;

491 
u64
 
	mfuÎ_¡re_logiÿl
;

492 
bŒfs_io_¡re
 
	m¡res
[];

495 
	sbŒfs_deviû_šfo
 {

496 
bŒfs_deviû
 *
	mdev
;

497 
u64
 
	mdev_off£t
;

498 
u64
 
	mmax_ava
;

499 
u64
 
	mtÙ®_ava
;

502 
	sbŒfs_¿id_©Œ
 {

503 
u8
 
	msub_¡res
;

504 
u8
 
	mdev_¡res
;

505 
u8
 
	mdevs_max
;

506 
u8
 
	mdevs_mš
;

507 
u8
 
	mtŞ”©ed_çu»s
;

508 
u8
 
	mdevs_šüem’t
;

509 
u8
 
	mncİ›s
;

510 
u8
 
	mÅ¬™y
;

512 
u8
 
	mmšdev_”rÜ
;

513 cÚ¡ 
	m¿id_Çme
[8];

514 
u64
 
	mbg_æag
;

517 cÚ¡ 
bŒfs_¿id_©Œ
 
bŒfs_¿id_¬¿y
[
BTRFS_NR_RAID_TYPES
];

519 
	sm­_lookup
 {

520 
u64
 
	mty³
;

521 
	mio_®ign
;

522 
	mio_width
;

523 
	mnum_¡res
;

524 
	msub_¡res
;

525 
	mv”if›d_¡res
;

526 
bŒfs_io_¡re
 
	m¡res
[];

529 
	#m­_lookup_size
(
n
è((
m­_lookup
) + \

530 ((
bŒfs_io_¡re
è* (
n
)))

	)

532 
	gbŒfs_b®ªû_¬gs
;

533 
	gbŒfs_b®ªû_´og»ss
;

534 
	sbŒfs_b®ªû_cÚŒŞ
 {

535 
bŒfs_b®ªû_¬gs
 
	md©a
;

536 
bŒfs_b®ªû_¬gs
 
	mm‘a
;

537 
bŒfs_b®ªû_¬gs
 
	msys
;

539 
u64
 
	mæags
;

541 
bŒfs_b®ªû_´og»ss
 
	m¡©
;

547 
	sbŒfs_dev_lookup_¬gs
 {

548 
u64
 
	mdevid
;

549 
u8
 *
	muuid
;

550 
u8
 *
	mfsid
;

551 
boŞ
 
	mmissšg
;

555 
	#BTRFS_DEV_LOOKUP_ARGS_INIT
 { .
devid
 = (
u64
)-1 }

	)

557 
	#BTRFS_DEV_LOOKUP_ARGS
(
Çme
) \

558 
bŒfs_dev_lookup_¬gs
 
Çme
 = 
BTRFS_DEV_LOOKUP_ARGS_INIT


	)

560 
	ebŒfs_m­_İ
 {

561 
	mBTRFS_MAP_READ
,

562 
	mBTRFS_MAP_WRITE
,

563 
	mBTRFS_MAP_GET_READ_MIRRORS
,

566 
šlše
 
bŒfs_m­_İ
 
	$bŒfs_İ
(
bio
 *bio)

568 
	`bio_İ
(
bio
)) {

569 
REQ_OP_WRITE
:

570 
REQ_OP_ZONE_APPEND
:

571  
BTRFS_MAP_WRITE
;

573 
	`WARN_ON_ONCE
(1);

574 
çÎthrough
;

575 
REQ_OP_READ
:

576  
BTRFS_MAP_READ
;

578 
	}
}

580 
šlše
 
	$bŒfs_chunk_™em_size
(
num_¡res
)

582 
	`ASSERT
(
num_¡res
);

583  (
bŒfs_chunk
) +

584 (
bŒfs_¡re
è* (
num_¡res
 - 1);

585 
	}
}

593 
šlše
 
u64
 
	$bŒfs_¡re_Ä_to_off£t
(
u32
 
¡re_Ä
)

595  (
u64
)
¡re_Ä
 << 
BTRFS_STRIPE_LEN_SHIFT
;

596 
	}
}

598 
bŒfs_g‘_bioc
(
bŒfs_io_cÚ‹xt
 *
bioc
);

599 
bŒfs_put_bioc
(
bŒfs_io_cÚ‹xt
 *
bioc
);

600 
bŒfs_m­_block
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bŒfs_m­_İ
 
İ
,

601 
u64
 
logiÿl
, u64 *
Ëngth
,

602 
bŒfs_io_cÚ‹xt
 **
bioc_»t
,

603 
bŒfs_io_¡re
 *
sm­
, *
mœrÜ_num_»t
,

604 
Ãed_¿id_m­
);

605 
bŒfs_m­_»·œ_block
(
bŒfs_fs_šfo
 *
fs_šfo
,

606 
bŒfs_io_¡re
 *
sm­
, 
u64
 
logiÿl
,

607 
u32
 
Ëngth
, 
mœrÜ_num
);

608 
bŒfs_disÿrd_¡re
 *
bŒfs_m­_disÿrd
(
bŒfs_fs_šfo
 *
fs_šfo
,

609 
u64
 
logiÿl
, u64 *
Ëngth_»t
,

610 
u32
 *
num_¡res
);

611 
bŒfs_»ad_sys_¬¿y
(
bŒfs_fs_šfo
 *
fs_šfo
);

612 
bŒfs_»ad_chunk_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
);

613 
bŒfs_»ad_chunk_Œ“_·¹™iÚ
(
bŒfs_fs_šfo
 *
fs_šfo
, 
·¹™iÚ_Üd”
);

614 
bŒfs_block_group
 *
bŒfs_ü—‹_chunk
(
bŒfs_Œªs_hªdË
 *
Œªs
,

615 
u64
 
ty³
);

616 
bŒfs_m­pšg_Œ“_ä“
(
ex‹Á_m­_Œ“
 *
Œ“
);

617 
bŒfs_İ’_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

618 
blk_mode_t
 
æags
, *
hŞd”
);

619 
bŒfs_İ’_deviûs_·¹™iÚ
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

620 
blk_mode_t
 
æags
, *
hŞd”
, 
·¹™iÚ_Üd”
);

621 
bŒfs_deviû
 *
bŒfs_sÿn_Úe_deviû
(cÚ¡ *
·th
, 
blk_mode_t
 
æags
);

622 
bŒfs_deviû
 *
bŒfs_sÿn_Úe_deviû_·¹™iÚ
(cÚ¡ *
·th
, 
blk_mode_t
 
æags
, 
·¹™iÚ_Üd”
);

623 
bŒfs_fÜg‘_deviûs
(
dev_t
 
devt
);

624 
bŒfs_şo£_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
);

625 
bŒfs_ä“_exŒa_devids
(
bŒfs_fs_deviûs
 *
fs_deviûs
);

626 
bŒfs_assign_Ãxt_aùive_deviû
(
bŒfs_deviû
 *
deviû
,

627 
bŒfs_deviû
 *
this_dev
);

628 
bŒfs_deviû
 *
bŒfs_fšd_deviû_by_dev¥ec
(
bŒfs_fs_šfo
 *
fs_šfo
,

629 
u64
 
devid
,

630 cÚ¡ *
dev·th
);

631 
bŒfs_g‘_dev_¬gs_äom_·th
(
bŒfs_fs_šfo
 *
fs_šfo
,

632 
bŒfs_dev_lookup_¬gs
 *
¬gs
,

633 cÚ¡ *
·th
);

634 
bŒfs_deviû
 *
bŒfs_®loc_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
,

635 cÚ¡ 
u64
 *
devid
, cÚ¡ 
u8
 *
uuid
,

636 cÚ¡ *
·th
);

637 
bŒfs_put_dev_¬gs_äom_·th
(
bŒfs_dev_lookup_¬gs
 *
¬gs
);

638 
bŒfs_rm_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
,

639 
bŒfs_dev_lookup_¬gs
 *
¬gs
,

640 
block_deviû
 **
bdev
, **
hŞd”
);

641 
__ex™
 
bŒfs_ş—nup_fs_uuids
();

642 
bŒfs_num_cİ›s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
, u64 
Ën
);

643 
bŒfs_grow_deviû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

644 
bŒfs_deviû
 *
deviû
, 
u64
 
Ãw_size
);

645 
bŒfs_deviû
 *
bŒfs_fšd_deviû
(cÚ¡ 
bŒfs_fs_deviûs
 *
fs_deviûs
,

646 cÚ¡ 
bŒfs_dev_lookup_¬gs
 *
¬gs
);

647 
bŒfs_shršk_deviû
(
bŒfs_deviû
 *
deviû
, 
u64
 
Ãw_size
);

648 
bŒfs_š™_Ãw_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
·th
);

649 
bŒfs_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
,

650 
bŒfs_b®ªû_cÚŒŞ
 *
bùl
,

651 
bŒfs_ioùl_b®ªû_¬gs
 *
b¬gs
);

652 
bŒfs_desüibe_block_groups
(
u64
 
æags
, *
buf
, 
u32
 
size_buf
);

653 
bŒfs_»sume_b®ªû_async
(
bŒfs_fs_šfo
 *
fs_šfo
);

654 
bŒfs_»cov”_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
);

655 
bŒfs_·u£_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
);

656 
bŒfs_»loÿ‹_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
chunk_off£t
);

657 
bŒfs_ÿnûl_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
);

658 
bŒfs_ü—‹_uuid_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
);

659 
bŒfs_uuid_sÿn_kth»ad
(*
d©a
);

660 
boŞ
 
bŒfs_chunk_wr™—bË
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
chunk_off£t
);

661 
bŒfs_dev_¡©_šc_ªd_´št
(
bŒfs_deviû
 *
dev
, 
šdex
);

662 
bŒfs_g‘_dev_¡©s
(
bŒfs_fs_šfo
 *
fs_šfo
,

663 
bŒfs_ioùl_g‘_dev_¡©s
 *
¡©s
);

664 
bŒfs_š™_deviûs_Ï‹
(
bŒfs_fs_šfo
 *
fs_šfo
);

665 
bŒfs_š™_dev_¡©s
(
bŒfs_fs_šfo
 *
fs_šfo
);

666 
bŒfs_run_dev_¡©s
(
bŒfs_Œªs_hªdË
 *
Œªs
);

667 
bŒfs_rm_dev_»¶aû_»move_¤cdev
(
bŒfs_deviû
 *
¤cdev
);

668 
bŒfs_rm_dev_»¶aû_ä“_¤cdev
(
bŒfs_deviû
 *
¤cdev
);

669 
bŒfs_de¡roy_dev_»¶aû_tgtdev
(
bŒfs_deviû
 *
tgtdev
);

670 
bŒfs_is_·r™y_mœrÜ
(
bŒfs_fs_šfo
 *
fs_šfo
,

671 
u64
 
logiÿl
, u64 
Ën
);

672 
bŒfs_fuÎ_¡re_Ën
(
bŒfs_fs_šfo
 *
fs_šfo
,

673 
u64
 
logiÿl
);

674 
u64
 
bŒfs_ÿlc_¡re_Ëngth
(cÚ¡ 
ex‹Á_m­
 *
em
);

675 
bŒfs_Ä_·r™y_¡res
(
u64
 
ty³
);

676 
bŒfs_chunk_®loc_add_chunk_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

677 
bŒfs_block_group
 *
bg
);

678 
bŒfs_»move_chunk
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
u64
 
chunk_off£t
);

679 
ex‹Á_m­
 *
bŒfs_g‘_chunk_m­
(
bŒfs_fs_šfo
 *
fs_šfo
,

680 
u64
 
logiÿl
, u64 
Ëngth
);

681 
bŒfs_»Ëa£_disk_su³r
(
bŒfs_su³r_block
 *
su³r
);

683 
šlše
 
	$bŒfs_dev_¡©_šc
(
bŒfs_deviû
 *
dev
,

684 
šdex
)

686 
	`©omic_šc
(
dev
->
dev_¡©_v®ues
 + 
šdex
);

693 
	`smp_mb__befÜe_©omic
();

694 
	`©omic_šc
(&
dev
->
dev_¡©s_cút
);

695 
	}
}

697 
šlše
 
	$bŒfs_dev_¡©_»ad
(
bŒfs_deviû
 *
dev
,

698 
šdex
)

700  
	`©omic_»ad
(
dev
->
dev_¡©_v®ues
 + 
šdex
);

701 
	}
}

703 
šlše
 
	$bŒfs_dev_¡©_»ad_ªd_»£t
(
bŒfs_deviû
 *
dev
,

704 
šdex
)

706 
»t
;

708 
»t
 = 
	`©omic_xchg
(
dev
->
dev_¡©_v®ues
 + 
šdex
, 0);

716 
	`©omic_šc
(&
dev
->
dev_¡©s_cút
);

717  
»t
;

718 
	}
}

720 
šlše
 
	$bŒfs_dev_¡©_£t
(
bŒfs_deviû
 *
dev
,

721 
šdex
, 
v®
)

723 
	`©omic_£t
(
dev
->
dev_¡©_v®ues
 + 
šdex
, 
v®
);

730 
	`smp_mb__befÜe_©omic
();

731 
	`©omic_šc
(&
dev
->
dev_¡©s_cút
);

732 
	}
}

734 
šlše
 cÚ¡ *
	$bŒfs_dev_Çme
(cÚ¡ 
bŒfs_deviû
 *
deviû
)

736 ià(!
deviû
 || 
	`‹¡_b™
(
BTRFS_DEV_STATE_MISSING
, &deviû->
dev_¡©e
))

739  
	`rcu_¡r_d”ef
(
deviû
->
Çme
);

740 
	}
}

742 
bŒfs_comm™_deviû_sizes
(
bŒfs_Œª§ùiÚ
 *
Œªs
);

744 
li¡_h—d
 * 
__©Œibu‹_cÚ¡__
 
bŒfs_g‘_fs_uuids
();

745 
boŞ
 
bŒfs_check_rw_deg¿dabË
(
bŒfs_fs_šfo
 *
fs_šfo
,

746 
bŒfs_deviû
 *
çšg_dev
);

747 
bŒfs_sü©ch_su³rblocks
(
bŒfs_fs_šfo
 *
fs_šfo
,

748 
block_deviû
 *
bdev
,

749 cÚ¡ *
deviû_·th
);

751 
bŒfs_¿id_ty³s
 
__©Œibu‹_cÚ¡__
 
bŒfs_bg_æags_to_¿id_šdex
(
u64
 
æags
);

752 
bŒfs_bg_ty³_to_çùÜ
(
u64
 
æags
);

753 cÚ¡ *
bŒfs_bg_ty³_to_¿id_Çme
(
u64
 
æags
);

754 
bŒfs_v”ify_dev_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
);

755 
boŞ
 
bŒfs_»·œ_Úe_zÚe
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
);

757 
boŞ
 
bŒfs_pšÃd_by_sw­fe
(
bŒfs_fs_šfo
 *
fs_šfo
, *
±r
);

758 
u8
 *
bŒfs_sb_fsid_±r
(
bŒfs_su³r_block
 *
sb
);

	@xattr.c

6 
	~<lšux/š™.h
>

7 
	~<lšux/fs.h
>

8 
	~<lšux/¦ab.h
>

9 
	~<lšux/rw£m.h
>

10 
	~<lšux/x©Œ.h
>

11 
	~<lšux/£cur™y.h
>

12 
	~<lšux/posix_aş_x©Œ.h
>

13 
	~<lšux/iv”siÚ.h
>

14 
	~<lšux/sched/mm.h
>

15 
	~"ù»e.h
"

16 
	~"fs.h
"

17 
	~"mes§ges.h
"

18 
	~"bŒfs_šode.h
"

19 
	~"Œª§ùiÚ.h
"

20 
	~"x©Œ.h
"

21 
	~"disk-io.h
"

22 
	~"´İs.h
"

23 
	~"lockšg.h
"

24 
	~"acûssÜs.h
"

25 
	~"dœ-™em.h
"

27 
	$bŒfs_g‘x©Œ
(
šode
 *šode, cÚ¡ *
Çme
,

28 *
bufãr
, 
size_t
 
size
)

30 
bŒfs_dœ_™em
 *
di
;

31 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

32 
bŒfs_·th
 *
·th
;

33 
ex‹Á_bufãr
 *
Ëaf
;

34 
»t
 = 0;

35 
d©a_±r
;

37 
·th
 = 
	`bŒfs_®loc_·th
();

38 ià(!
·th
)

39  -
ENOMEM
;

42 
di
 = 
	`bŒfs_lookup_x©Œ
(
NULL
, 
roÙ
, 
·th
, 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)),

43 
Çme
, 
	`¡¾’
(name), 0);

44 ià(!
di
) {

45 
»t
 = -
ENODATA
;

46 
out
;

47 } ià(
	`IS_ERR
(
di
)) {

48 
»t
 = 
	`PTR_ERR
(
di
);

49 
out
;

52 
Ëaf
 = 
·th
->
nodes
[0];

54 ià(!
size
) {

55 
»t
 = 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
);

56 
out
;

60 ià(
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
è> 
size
) {

61 
»t
 = -
ERANGE
;

62 
out
;

72 
d©a_±r
 = ()((*)(
di
 + 1) +

73 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
di
));

74 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
bufãr
, 
d©a_±r
,

75 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
));

76 
»t
 = 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
);

78 
out
:

79 
	`bŒfs_ä“_·th
(
·th
);

80  
»t
;

81 
	}
}

83 
	$bŒfs_£tx©Œ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
šode
 *inode,

84 cÚ¡ *
Çme
, cÚ¡ *
v®ue
, 
size_t
 
size
, 
æags
)

86 
bŒfs_dœ_™em
 *
di
 = 
NULL
;

87 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

88 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

89 
bŒfs_·th
 *
·th
;

90 
size_t
 
Çme_Ën
 = 
	`¡¾’
(
Çme
);

91 
»t
 = 0;

93 
	`ASSERT
(
Œªs
);

95 ià(
Çme_Ën
 + 
size
 > 
	`BTRFS_MAX_XATTR_SIZE
(
roÙ
->
fs_šfo
))

96  -
ENOSPC
;

98 
·th
 = 
	`bŒfs_®loc_·th
();

99 ià(!
·th
)

100  -
ENOMEM
;

101 
·th
->
sk_»Ëa£_Ú_”rÜ
 = 1;

103 ià(!
v®ue
) {

104 
di
 = 
	`bŒfs_lookup_x©Œ
(
Œªs
, 
roÙ
, 
·th
,

105 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 
Çme
, 
Çme_Ën
, -1);

106 ià(!
di
 && (
æags
 & 
XATTR_REPLACE
))

107 
»t
 = -
ENODATA
;

108 ià(
	`IS_ERR
(
di
))

109 
»t
 = 
	`PTR_ERR
(
di
);

110 ià(
di
)

111 
»t
 = 
	`bŒfs_d–‘e_Úe_dœ_Çme
(
Œªs
, 
roÙ
, 
·th
, 
di
);

112 
out
;

122 ià(
æags
 & 
XATTR_REPLACE
) {

123 
	`ASSERT
(
	`šode_is_locked
(
šode
));

124 
di
 = 
	`bŒfs_lookup_x©Œ
(
NULL
, 
roÙ
, 
·th
,

125 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 
Çme
, 
Çme_Ën
, 0);

126 ià(!
di
)

127 
»t
 = -
ENODATA
;

128 ià(
	`IS_ERR
(
di
))

129 
»t
 = 
	`PTR_ERR
(
di
);

130 ià(
»t
)

131 
out
;

132 
	`bŒfs_»Ëa£_·th
(
·th
);

133 
di
 = 
NULL
;

136 
»t
 = 
	`bŒfs_š£¹_x©Œ_™em
(
Œªs
, 
roÙ
, 
·th
, 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)),

137 
Çme
, 
Çme_Ën
, 
v®ue
, 
size
);

138 ià(
»t
 =ğ-
EOVERFLOW
) {

144 
»t
 = 0;

145 
	`bŒfs_as£¹_Œ“_wr™e_locked
(
·th
->
nodes
[0]);

146 
di
 = 
	`bŒfs_m©ch_dœ_™em_Çme
(
fs_šfo
, 
·th
, 
Çme
, 
Çme_Ën
);

147 ià(!
di
 && !(
æags
 & 
XATTR_REPLACE
)) {

148 
»t
 = -
ENOSPC
;

149 
out
;

151 } ià(
»t
 =ğ-
EEXIST
) {

152 
»t
 = 0;

153 
di
 = 
	`bŒfs_m©ch_dœ_™em_Çme
(
fs_šfo
, 
·th
, 
Çme
, 
Çme_Ën
);

154 
	`ASSERT
(
di
);

155 } ià(
»t
) {

156 
out
;

159 ià(
di
 && (
æags
 & 
XATTR_CREATE
)) {

160 
»t
 = -
EEXIST
;

161 
out
;

164 ià(
di
) {

172 cÚ¡ 
¦Ù
 = 
·th
->
¦Ùs
[0];

173 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

174 cÚ¡ 
u16
 
Şd_d©a_Ën
 = 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
);

175 cÚ¡ 
u32
 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

176 cÚ¡ 
u32
 
d©a_size
 = (*
di
è+ 
Çme_Ën
 + 
size
;

177 
d©a_±r
;

178 *
±r
;

180 ià(
size
 > 
Şd_d©a_Ën
) {

181 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
Ëaf
) <

182 (
size
 - 
Şd_d©a_Ën
)) {

183 
»t
 = -
ENOSPC
;

184 
out
;

188 ià(
Şd_d©a_Ën
 + 
Çme_Ën
 + (*
di
è=ğ
™em_size
) {

190 ià(
size
 > 
Şd_d©a_Ën
)

191 
	`bŒfs_ex‹nd_™em
(
Œªs
, 
·th
, 
size
 - 
Şd_d©a_Ën
);

192 ià(
size
 < 
Şd_d©a_Ën
)

193 
	`bŒfs_Œunÿ‹_™em
(
Œªs
, 
·th
, 
d©a_size
, 1);

196 
»t
 = 
	`bŒfs_d–‘e_Úe_dœ_Çme
(
Œªs
, 
roÙ
, 
·th
, 
di
);

197 ià(
»t
)

198 
out
;

199 
	`bŒfs_ex‹nd_™em
(
Œªs
, 
·th
, 
d©a_size
);

202 
±r
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, );

203 
±r
 +ğ
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
è- 
d©a_size
;

204 
di
 = (
bŒfs_dœ_™em
 *)
±r
;

205 
	`bŒfs_£t_dœ_d©a_Ën
(
Ëaf
, 
di
, 
size
);

206 
d©a_±r
 = (()(
di
 + 1)è+ 
Çme_Ën
;

207 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
v®ue
, 
d©a_±r
, 
size
);

208 
	`bŒfs_m¬k_bufãr_dœty
(
Œªs
, 
Ëaf
);

216 
out
:

217 
	`bŒfs_ä“_·th
(
·th
);

218 ià(!
»t
) {

219 
	`£t_b™
(
BTRFS_INODE_COPY_EVERYTHING
,

220 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

221 
	`ş—r_b™
(
BTRFS_INODE_NO_XATTRS
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

223  
»t
;

224 
	}
}

229 
	$bŒfs_£tx©Œ_Œªs
(
šode
 *šode, cÚ¡ *
Çme
,

230 cÚ¡ *
v®ue
, 
size_t
 
size
, 
æags
)

232 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

233 
bŒfs_Œªs_hªdË
 *
Œªs
;

234 cÚ¡ 
boŞ
 
¡¬t_Œªs
 = (
cu¼’t
->
jouº®_šfo
 =ğ
NULL
);

235 
»t
;

237 ià(
¡¬t_Œªs
) {

242 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 2);

243 ià(
	`IS_ERR
(
Œªs
))

244  
	`PTR_ERR
(
Œªs
);

257 
	`ASSERT
(
	`¡ºcmp
(
Çme
, 
XATTR_SECURITY_PREFIX
,

258 
XATTR_SECURITY_PREFIX_LEN
) == 0);

259 
Œªs
 = 
cu¼’t
->
jouº®_šfo
;

262 
»t
 = 
	`bŒfs_£tx©Œ
(
Œªs
, 
šode
, 
Çme
, 
v®ue
, 
size
, 
æags
);

263 ià(
»t
)

264 
out
;

266 
	`šode_šc_iv”siÚ
(
šode
);

267 
	`šode_£t_ùime_cu¼’t
(
šode
);

268 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

269 ià(
»t
)

270 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

271 
out
:

272 ià(
¡¬t_Œªs
)

273 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

274  
»t
;

275 
	}
}

277 
ssize_t
 
	$bŒfs_li¡x©Œ
(
d’Œy
 *d’Œy, *
bufãr
, 
size_t
 
size
)

279 
bŒfs_key
 
found_key
;

280 
bŒfs_key
 
key
;

281 
šode
 *šodğ
	`d_šode
(
d’Œy
);

282 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

283 
bŒfs_·th
 *
·th
;

284 
™”_»t
 = 0;

285 
»t
 = 0;

286 
size_t
 
tÙ®_size
 = 0, 
size_Ëá
 = 
size
;

293 
key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

294 
key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

295 
key
.
off£t
 = 0;

297 
·th
 = 
	`bŒfs_®loc_·th
();

298 ià(!
·th
)

299  -
ENOMEM
;

300 
·th
->
»ada
 = 
READA_FORWARD
;

303 
	`bŒfs_fÜ_—ch_¦Ù
(
roÙ
, &
key
, &
found_key
, 
·th
, 
™”_»t
) {

304 
ex‹Á_bufãr
 *
Ëaf
;

305 
¦Ù
;

306 
bŒfs_dœ_™em
 *
di
;

307 
u32
 
™em_size
;

308 
u32
 
cur
;

310 
Ëaf
 = 
·th
->
nodes
[0];

311 
¦Ù
 = 
·th
->
¦Ùs
[0];

314 ià(
found_key
.
objeùid
 !ğ
key
.objectid)

316 ià(
found_key
.
ty³
 > 
BTRFS_XATTR_ITEM_KEY
)

318 ià(
found_key
.
ty³
 < 
BTRFS_XATTR_ITEM_KEY
)

321 
di
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_dœ_™em
);

322 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
¦Ù
);

323 
cur
 = 0;

324 
cur
 < 
™em_size
) {

325 
u16
 
Çme_Ën
 = 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
di
);

326 
u16
 
d©a_Ën
 = 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
);

327 
u32
 
this_Ën
 = (*
di
è+ 
Çme_Ën
 + 
d©a_Ën
;

328 
Çme_±r
 = ()(
di
 + 1);

330 
tÙ®_size
 +ğ
Çme_Ën
 + 1;

335 ià(!
size
)

336 
Ãxt
;

338 ià(!
bufãr
 || (
Çme_Ën
 + 1è> 
size_Ëá
) {

339 
™”_»t
 = -
ERANGE
;

343 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
bufãr
, 
Çme_±r
, 
Çme_Ën
);

344 
bufãr
[
Çme_Ën
] = '\0';

346 
size_Ëá
 -ğ
Çme_Ën
 + 1;

347 
bufãr
 +ğ
Çme_Ën
 + 1;

348 
Ãxt
:

349 
cur
 +ğ
this_Ën
;

350 
di
 = (
bŒfs_dœ_™em
 *)((*)d˜+ 
this_Ën
);

354 ià(
™”_»t
 < 0)

355 
»t
 = 
™”_»t
;

357 
»t
 = 
tÙ®_size
;

359 
	`bŒfs_ä“_·th
(
·th
);

361  
»t
;

362 
	}
}

364 
	$bŒfs_x©Œ_hªdËr_g‘
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

365 
d’Œy
 *
unu£d
, 
šode
 *inode,

366 cÚ¡ *
Çme
, *
bufãr
, 
size_t
 
size
)

368 
Çme
 = 
	`x©Œ_fuÎ_Çme
(
hªdËr
,‚ame);

369  
	`bŒfs_g‘x©Œ
(
šode
, 
Çme
, 
bufãr
, 
size
);

370 
	}
}

372 
	$bŒfs_x©Œ_hªdËr_£t
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

373 
mÁ_idm­
 *
idm­
,

374 
d’Œy
 *
unu£d
, 
šode
 *inode,

375 cÚ¡ *
Çme
, cÚ¡ *
bufãr
,

376 
size_t
 
size
, 
æags
)

378 ià(
	`bŒfs_roÙ_»adÚly
(
	`BTRFS_I
(
šode
)->
roÙ
))

379  -
EROFS
;

381 
Çme
 = 
	`x©Œ_fuÎ_Çme
(
hªdËr
,‚ame);

382  
	`bŒfs_£tx©Œ_Œªs
(
šode
, 
Çme
, 
bufãr
, 
size
, 
æags
);

383 
	}
}

385 
	$bŒfs_x©Œ_hªdËr_£t_´İ
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

386 
mÁ_idm­
 *
idm­
,

387 
d’Œy
 *
unu£d
, 
šode
 *inode,

388 cÚ¡ *
Çme
, cÚ¡ *
v®ue
,

389 
size_t
 
size
, 
æags
)

391 
»t
;

392 
bŒfs_Œªs_hªdË
 *
Œªs
;

393 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

395 
Çme
 = 
	`x©Œ_fuÎ_Çme
(
hªdËr
,‚ame);

396 
»t
 = 
	`bŒfs_v®id©e_´İ
(
	`BTRFS_I
(
šode
), 
Çme
, 
v®ue
, 
size
);

397 ià(
»t
)

398  
»t
;

400 ià(
	`bŒfs_ignÜe_´İ
(
	`BTRFS_I
(
šode
), 
Çme
))

403 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 2);

404 ià(
	`IS_ERR
(
Œªs
))

405  
	`PTR_ERR
(
Œªs
);

407 
»t
 = 
	`bŒfs_£t_´İ
(
Œªs
, 
šode
, 
Çme
, 
v®ue
, 
size
, 
æags
);

408 ià(!
»t
) {

409 
	`šode_šc_iv”siÚ
(
šode
);

410 
	`šode_£t_ùime_cu¼’t
(
šode
);

411 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
));

412 ià(
»t
)

413 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

416 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

418  
»t
;

419 
	}
}

421 cÚ¡ 
x©Œ_hªdËr
 
	gbŒfs_£cur™y_x©Œ_hªdËr
 = {

422 .
´efix
 = 
XATTR_SECURITY_PREFIX
,

423 .
	gg‘
 = 
bŒfs_x©Œ_hªdËr_g‘
,

424 .
	g£t
 = 
bŒfs_x©Œ_hªdËr_£t
,

427 cÚ¡ 
x©Œ_hªdËr
 
	gbŒfs_Œu¡ed_x©Œ_hªdËr
 = {

428 .
´efix
 = 
XATTR_TRUSTED_PREFIX
,

429 .
	gg‘
 = 
bŒfs_x©Œ_hªdËr_g‘
,

430 .
	g£t
 = 
bŒfs_x©Œ_hªdËr_£t
,

433 cÚ¡ 
x©Œ_hªdËr
 
	gbŒfs_u£r_x©Œ_hªdËr
 = {

434 .
´efix
 = 
XATTR_USER_PREFIX
,

435 .
	gg‘
 = 
bŒfs_x©Œ_hªdËr_g‘
,

436 .
	g£t
 = 
bŒfs_x©Œ_hªdËr_£t
,

439 cÚ¡ 
x©Œ_hªdËr
 
	gbŒfs_bŒfs_x©Œ_hªdËr
 = {

440 .
´efix
 = 
XATTR_BTRFS_PREFIX
,

441 .
	gg‘
 = 
bŒfs_x©Œ_hªdËr_g‘
,

442 .
	g£t
 = 
bŒfs_x©Œ_hªdËr_£t_´İ
,

445 cÚ¡ 
x©Œ_hªdËr
 *
	gbŒfs_x©Œ_hªdËrs
[] = {

446 &
bŒfs_£cur™y_x©Œ_hªdËr
,

447 &
bŒfs_Œu¡ed_x©Œ_hªdËr
,

448 &
bŒfs_u£r_x©Œ_hªdËr
,

449 &
bŒfs_bŒfs_x©Œ_hªdËr
,

450 
NULL
,

453 
	$bŒfs_š™x©Œs
(
šode
 *inode,

454 cÚ¡ 
x©Œ
 *
x©Œ_¬¿y
, *
fs_´iv©e
)

456 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
fs_´iv©e
;

457 cÚ¡ 
x©Œ
 *xattr;

458 
nofs_æag
;

459 *
Çme
;

460 
”r
 = 0;

466 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

467 
x©Œ
 = 
x©Œ_¬¿y
; x©Œ->
Çme
 !ğ
NULL
; xattr++) {

468 
Çme
 = 
	`km®loc
(
XATTR_SECURITY_PREFIX_LEN
 +

469 
	`¡¾’
(
x©Œ
->
Çme
è+ 1, 
GFP_KERNEL
);

470 ià(!
Çme
) {

471 
”r
 = -
ENOMEM
;

474 
	`¡rıy
(
Çme
, 
XATTR_SECURITY_PREFIX
);

475 
	`¡rıy
(
Çme
 + 
XATTR_SECURITY_PREFIX_LEN
, 
x©Œ
->name);

476 
”r
 = 
	`bŒfs_£tx©Œ
(
Œªs
, 
šode
, 
Çme
, 
x©Œ
->
v®ue
,

477 
x©Œ
->
v®ue_Ën
, 0);

478 
	`kä“
(
Çme
);

479 ià(
”r
 < 0)

482 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

483  
”r
;

484 
	}
}

486 
	$bŒfs_x©Œ_£cur™y_š™
(
bŒfs_Œªs_hªdË
 *
Œªs
,

487 
šode
 *šode, šod*
dœ
,

488 cÚ¡ 
q¡r
 *qstr)

490  
	`£cur™y_šode_š™_£cur™y
(
šode
, 
dœ
, 
q¡r
,

491 &
bŒfs_š™x©Œs
, 
Œªs
);

492 
	}
}

	@xattr.h

6 #iâdeà
BTRFS_XATTR_H


7 
	#BTRFS_XATTR_H


	)

9 
	~<lšux/x©Œ.h
>

11 cÚ¡ 
x©Œ_hªdËr
 *
bŒfs_x©Œ_hªdËrs
[];

13 
bŒfs_g‘x©Œ
(
šode
 *šode, cÚ¡ *
Çme
,

14 *
bufãr
, 
size_t
 
size
);

15 
bŒfs_£tx©Œ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
šode
 *inode,

16 cÚ¡ *
Çme
, cÚ¡ *
v®ue
, 
size_t
 
size
, 
æags
);

17 
bŒfs_£tx©Œ_Œªs
(
šode
 *šode, cÚ¡ *
Çme
,

18 cÚ¡ *
v®ue
, 
size_t
 
size
, 
æags
);

19 
ssize_t
 
bŒfs_li¡x©Œ
(
d’Œy
 *d’Œy, *
bufãr
, 
size_t
 
size
);

21 
bŒfs_x©Œ_£cur™y_š™
(
bŒfs_Œªs_hªdË
 *
Œªs
,

22 
šode
 *šode, šod*
dœ
,

23 cÚ¡ 
q¡r
 *qstr);

	@zlib.c

10 
	~<lšux/k”Ãl.h
>

11 
	~<lšux/¦ab.h
>

12 
	~<lšux/zlib.h
>

13 
	~<lšux/zut.h
>

14 
	~<lšux/mm.h
>

15 
	~<lšux/š™.h
>

16 
	~<lšux/”r.h
>

17 
	~<lšux/sched.h
>

18 
	~<lšux/·gem­.h
>

19 
	~<lšux/bio.h
>

20 
	~<lšux/»fcouÁ.h
>

21 
	~"com´essiÚ.h
"

24 
	#ZLIB_DFLTCC_BUF_SIZE
 (4 * 
PAGE_SIZE
)

	)

26 
	swÜk¥aû
 {

27 
z_¡»am
 
	m¡rm
;

28 *
	mbuf
;

29 
	mbuf_size
;

30 
li¡_h—d
 
	mli¡
;

31 
	mËv–
;

34 
wÜk¥aû_mªag”
 
	gwsm
;

36 
li¡_h—d
 *
	$zlib_g‘_wÜk¥aû
(
Ëv–
)

38 
li¡_h—d
 *
ws
 = 
	`bŒfs_g‘_wÜk¥aû
(
BTRFS_COMPRESS_ZLIB
, 
Ëv–
);

39 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

41 
wÜk¥aû
->
Ëv–
 =†evel;

43  
ws
;

44 
	}
}

46 
	$zlib_ä“_wÜk¥aû
(
li¡_h—d
 *
ws
)

48 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

50 
	`kvä“
(
wÜk¥aû
->
¡rm
.workspace);

51 
	`kä“
(
wÜk¥aû
->
buf
);

52 
	`kä“
(
wÜk¥aû
);

53 
	}
}

55 
li¡_h—d
 *
	$zlib_®loc_wÜk¥aû
(
Ëv–
)

57 
wÜk¥aû
 *workspace;

58 
wÜk¥aûsize
;

60 
wÜk¥aû
 = 
	`kz®loc
((*wÜk¥aû), 
GFP_KERNEL
);

61 ià(!
wÜk¥aû
)

62  
	`ERR_PTR
(-
ENOMEM
);

64 
wÜk¥aûsize
 = 
	`max
(
	`zlib_deæ©e_wÜk¥aûsize
(
MAX_WBITS
, 
MAX_MEM_LEVEL
),

65 
	`zlib_šæ©e_wÜk¥aûsize
());

66 
wÜk¥aû
->
¡rm
.wÜk¥aû = 
	`kvz®loc
(
wÜk¥aûsize
, 
GFP_KERNEL
 | 
__GFP_NOWARN
);

67 
wÜk¥aû
->
Ëv–
 =†evel;

68 
wÜk¥aû
->
buf
 = 
NULL
;

73 ià(
	`zlib_deæ©e_dætcc_’abËd
()) {

74 
wÜk¥aû
->
buf
 = 
	`km®loc
(
ZLIB_DFLTCC_BUF_SIZE
,

75 
__GFP_NOMEMALLOC
 | 
__GFP_NORETRY
 |

76 
__GFP_NOWARN
 | 
GFP_NOIO
);

77 
wÜk¥aû
->
buf_size
 = 
ZLIB_DFLTCC_BUF_SIZE
;

79 ià(!
wÜk¥aû
->
buf
) {

80 
wÜk¥aû
->
buf
 = 
	`km®loc
(
PAGE_SIZE
, 
GFP_KERNEL
);

81 
wÜk¥aû
->
buf_size
 = 
PAGE_SIZE
;

83 ià(!
wÜk¥aû
->
¡rm
.wÜk¥aû || !wÜk¥aû->
buf
)

84 
ç
;

86 
	`INIT_LIST_HEAD
(&
wÜk¥aû
->
li¡
);

88  &
wÜk¥aû
->
li¡
;

89 
ç
:

90 
	`zlib_ä“_wÜk¥aû
(&
wÜk¥aû
->
li¡
);

91  
	`ERR_PTR
(-
ENOMEM
);

92 
	}
}

94 
	$zlib_com´ess_·ges
(
li¡_h—d
 *
ws
, 
add»ss_¥aû
 *
m­pšg
,

95 
u64
 
¡¬t
, 
·ge
 **
·ges
, *
out_·ges
,

96 *
tÙ®_š
, *
tÙ®_out
)

98 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

99 
»t
;

100 *
d©a_š
 = 
NULL
;

101 *
ıage_out
;

102 
Ä_·ges
 = 0;

103 
·ge
 *
š_·ge
 = 
NULL
;

104 
·ge
 *
out_·ge
 = 
NULL
;

105 
by‹s_Ëá
;

106 
š_buf_·ges
;

107 
Ën
 = *
tÙ®_out
;

108 
Ä_de¡_·ges
 = *
out_·ges
;

109 cÚ¡ 
max_out
 = 
Ä_de¡_·ges
 * 
PAGE_SIZE
;

111 *
out_·ges
 = 0;

112 *
tÙ®_out
 = 0;

113 *
tÙ®_š
 = 0;

115 ià(
Z_OK
 !ğ
	`zlib_deæ©eIn™
(&
wÜk¥aû
->
¡rm
, wÜk¥aû->
Ëv–
)) {

116 
	`´_w¬n
("BTRFS: deflateInit failed\n");

117 
»t
 = -
EIO
;

118 
out
;

121 
wÜk¥aû
->
¡rm
.
tÙ®_š
 = 0;

122 
wÜk¥aû
->
¡rm
.
tÙ®_out
 = 0;

124 
out_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
);

125 ià(
out_·ge
 =ğ
NULL
) {

126 
»t
 = -
ENOMEM
;

127 
out
;

129 
ıage_out
 = 
	`·ge_add»ss
(
out_·ge
);

130 
·ges
[0] = 
out_·ge
;

131 
Ä_·ges
 = 1;

133 
wÜk¥aû
->
¡rm
.
Ãxt_š
 = wÜk¥aû->
buf
;

134 
wÜk¥aû
->
¡rm
.
ava_š
 = 0;

135 
wÜk¥aû
->
¡rm
.
Ãxt_out
 = 
ıage_out
;

136 
wÜk¥aû
->
¡rm
.
ava_out
 = 
PAGE_SIZE
;

138 
wÜk¥aû
->
¡rm
.
tÙ®_š
 < 
Ën
) {

143 ià(
wÜk¥aû
->
¡rm
.
ava_š
 == 0) {

144 
by‹s_Ëá
 = 
Ën
 - 
wÜk¥aû
->
¡rm
.
tÙ®_š
;

145 
š_buf_·ges
 = 
	`mš
(
	`DIV_ROUND_UP
(
by‹s_Ëá
, 
PAGE_SIZE
),

146 
wÜk¥aû
->
buf_size
 / 
PAGE_SIZE
);

147 ià(
š_buf_·ges
 > 1) {

148 
i
;

150 
i
 = 0; i < 
š_buf_·ges
; i++) {

151 ià(
d©a_š
) {

152 
	`kunm­_loÿl
(
d©a_š
);

153 
	`put_·ge
(
š_·ge
);

155 
š_·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
,

156 
¡¬t
 >> 
PAGE_SHIFT
);

157 
d©a_š
 = 
	`km­_loÿl_·ge
(
š_·ge
);

158 
	`cİy_·ge
(
wÜk¥aû
->
buf
 + 
i
 * 
PAGE_SIZE
,

159 
d©a_š
);

160 
¡¬t
 +ğ
PAGE_SIZE
;

162 
wÜk¥aû
->
¡rm
.
Ãxt_š
 = wÜk¥aû->
buf
;

164 ià(
d©a_š
) {

165 
	`kunm­_loÿl
(
d©a_š
);

166 
	`put_·ge
(
š_·ge
);

168 
š_·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
,

169 
¡¬t
 >> 
PAGE_SHIFT
);

170 
d©a_š
 = 
	`km­_loÿl_·ge
(
š_·ge
);

171 
¡¬t
 +ğ
PAGE_SIZE
;

172 
wÜk¥aû
->
¡rm
.
Ãxt_š
 = 
d©a_š
;

174 
wÜk¥aû
->
¡rm
.
ava_š
 = 
	`mš
(
by‹s_Ëá
,

175 (è
wÜk¥aû
->
buf_size
);

178 
»t
 = 
	`zlib_deæ©e
(&
wÜk¥aû
->
¡rm
, 
Z_SYNC_FLUSH
);

179 ià(
»t
 !ğ
Z_OK
) {

180 
	`´_debug
("BTRFS: deflate in†oop„eturned %d\n",

181 
»t
);

182 
	`zlib_deæ©eEnd
(&
wÜk¥aû
->
¡rm
);

183 
»t
 = -
EIO
;

184 
out
;

188 ià(
wÜk¥aû
->
¡rm
.
tÙ®_š
 > 8192 &&

189 
wÜk¥aû
->
¡rm
.
tÙ®_š
 <

190 
wÜk¥aû
->
¡rm
.
tÙ®_out
) {

191 
»t
 = -
E2BIG
;

192 
out
;

198 ià(
wÜk¥aû
->
¡rm
.
ava_out
 == 0) {

199 ià(
Ä_·ges
 =ğ
Ä_de¡_·ges
) {

200 
»t
 = -
E2BIG
;

201 
out
;

203 
out_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
);

204 ià(
out_·ge
 =ğ
NULL
) {

205 
»t
 = -
ENOMEM
;

206 
out
;

208 
ıage_out
 = 
	`·ge_add»ss
(
out_·ge
);

209 
·ges
[
Ä_·ges
] = 
out_·ge
;

210 
Ä_·ges
++;

211 
wÜk¥aû
->
¡rm
.
ava_out
 = 
PAGE_SIZE
;

212 
wÜk¥aû
->
¡rm
.
Ãxt_out
 = 
ıage_out
;

215 ià(
wÜk¥aû
->
¡rm
.
tÙ®_š
 >ğ
Ën
)

217 ià(
wÜk¥aû
->
¡rm
.
tÙ®_out
 > 
max_out
)

220 
wÜk¥aû
->
¡rm
.
ava_š
 = 0;

225 
»t
 !ğ
Z_STREAM_END
) {

226 
»t
 = 
	`zlib_deæ©e
(&
wÜk¥aû
->
¡rm
, 
Z_FINISH
);

227 ià(
»t
 =ğ
Z_STREAM_END
)

229 ià(
»t
 !ğ
Z_OK
 &&„‘ !ğ
Z_BUF_ERROR
) {

230 
	`zlib_deæ©eEnd
(&
wÜk¥aû
->
¡rm
);

231 
»t
 = -
EIO
;

232 
out
;

233 } ià(
wÜk¥aû
->
¡rm
.
ava_out
 == 0) {

235 ià(
Ä_·ges
 =ğ
Ä_de¡_·ges
) {

236 
»t
 = -
E2BIG
;

237 
out
;

239 
out_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
);

240 ià(
out_·ge
 =ğ
NULL
) {

241 
»t
 = -
ENOMEM
;

242 
out
;

244 
ıage_out
 = 
	`·ge_add»ss
(
out_·ge
);

245 
·ges
[
Ä_·ges
] = 
out_·ge
;

246 
Ä_·ges
++;

247 
wÜk¥aû
->
¡rm
.
ava_out
 = 
PAGE_SIZE
;

248 
wÜk¥aû
->
¡rm
.
Ãxt_out
 = 
ıage_out
;

251 
	`zlib_deæ©eEnd
(&
wÜk¥aû
->
¡rm
);

253 ià(
wÜk¥aû
->
¡rm
.
tÙ®_out
 >ğwÜk¥aû->¡rm.
tÙ®_š
) {

254 
»t
 = -
E2BIG
;

255 
out
;

258 
»t
 = 0;

259 *
tÙ®_out
 = 
wÜk¥aû
->
¡rm
.total_out;

260 *
tÙ®_š
 = 
wÜk¥aû
->
¡rm
.total_in;

261 
out
:

262 *
out_·ges
 = 
Ä_·ges
;

263 ià(
d©a_š
) {

264 
	`kunm­_loÿl
(
d©a_š
);

265 
	`put_·ge
(
š_·ge
);

268  
»t
;

269 
	}
}

271 
	$zlib_decom´ess_bio
(
li¡_h—d
 *
ws
, 
com´es£d_bio
 *
cb
)

273 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

274 
»t
 = 0, 
»t2
;

275 
wb™s
 = 
MAX_WBITS
;

276 *
d©a_š
;

277 
size_t
 
tÙ®_out
 = 0;

278 
·ge_š_šdex
 = 0;

279 
size_t
 
¤ş’
 = 
cb
->
com´es£d_Ën
;

280 
tÙ®_·ges_š
 = 
	`DIV_ROUND_UP
(
¤ş’
, 
PAGE_SIZE
);

281 
buf_¡¬t
;

282 
·ge
 **
·ges_š
 = 
cb
->
com´es£d_·ges
;

284 
d©a_š
 = 
	`km­_loÿl_·ge
(
·ges_š
[
·ge_š_šdex
]);

285 
wÜk¥aû
->
¡rm
.
Ãxt_š
 = 
d©a_š
;

286 
wÜk¥aû
->
¡rm
.
ava_š
 = 
	`mš_t
(
size_t
, 
¤ş’
, 
PAGE_SIZE
);

287 
wÜk¥aû
->
¡rm
.
tÙ®_š
 = 0;

289 
wÜk¥aû
->
¡rm
.
tÙ®_out
 = 0;

290 
wÜk¥aû
->
¡rm
.
Ãxt_out
 = wÜk¥aû->
buf
;

291 
wÜk¥aû
->
¡rm
.
ava_out
 = wÜk¥aû->
buf_size
;

295 ià(
¤ş’
 > 2 && !(
d©a_š
[1] & 
PRESET_DICT
) &&

296 ((
d©a_š
[0] & 0x0fè=ğ
Z_DEFLATED
) &&

297 !(((
d©a_š
[0]<<8) + data_in[1]) % 31)) {

299 
wb™s
 = -((
d©a_š
[0] >> 4) + 8);

300 
wÜk¥aû
->
¡rm
.
Ãxt_š
 += 2;

301 
wÜk¥aû
->
¡rm
.
ava_š
 -= 2;

304 ià(
Z_OK
 !ğ
	`zlib_šæ©eIn™2
(&
wÜk¥aû
->
¡rm
, 
wb™s
)) {

305 
	`´_w¬n
("BTRFS: inflateInit failed\n");

306 
	`kunm­_loÿl
(
d©a_š
);

307  -
EIO
;

309 
wÜk¥aû
->
¡rm
.
tÙ®_š
 < 
¤ş’
) {

310 
»t
 = 
	`zlib_šæ©e
(&
wÜk¥aû
->
¡rm
, 
Z_NO_FLUSH
);

311 ià(
»t
 !ğ
Z_OK
 &&„‘ !ğ
Z_STREAM_END
)

314 
buf_¡¬t
 = 
tÙ®_out
;

315 
tÙ®_out
 = 
wÜk¥aû
->
¡rm
.total_out;

318 ià(
buf_¡¬t
 =ğ
tÙ®_out
)

321 
»t2
 = 
	`bŒfs_decom´ess_buf2·ge
(
wÜk¥aû
->
buf
,

322 
tÙ®_out
 - 
buf_¡¬t
, 
cb
, buf_start);

323 ià(
»t2
 == 0) {

324 
»t
 = 0;

325 
dÚe
;

328 
wÜk¥aû
->
¡rm
.
Ãxt_out
 = wÜk¥aû->
buf
;

329 
wÜk¥aû
->
¡rm
.
ava_out
 = wÜk¥aû->
buf_size
;

331 ià(
wÜk¥aû
->
¡rm
.
ava_š
 == 0) {

332 
tmp
;

333 
	`kunm­_loÿl
(
d©a_š
);

334 
·ge_š_šdex
++;

335 ià(
·ge_š_šdex
 >ğ
tÙ®_·ges_š
) {

336 
d©a_š
 = 
NULL
;

339 
d©a_š
 = 
	`km­_loÿl_·ge
(
·ges_š
[
·ge_š_šdex
]);

340 
wÜk¥aû
->
¡rm
.
Ãxt_š
 = 
d©a_š
;

341 
tmp
 = 
¤ş’
 - 
wÜk¥aû
->
¡rm
.
tÙ®_š
;

342 
wÜk¥aû
->
¡rm
.
ava_š
 = 
	`mš
(
tmp
, 
PAGE_SIZE
);

345 ià(
»t
 !ğ
Z_STREAM_END
)

346 
»t
 = -
EIO
;

348 
»t
 = 0;

349 
dÚe
:

350 
	`zlib_šæ©eEnd
(&
wÜk¥aû
->
¡rm
);

351 ià(
d©a_š
)

352 
	`kunm­_loÿl
(
d©a_š
);

353  
»t
;

354 
	}
}

356 
	$zlib_decom´ess
(
li¡_h—d
 *
ws
, cÚ¡ 
u8
 *
d©a_š
,

357 
·ge
 *
de¡_·ge
, 
¡¬t_by‹
, 
size_t
 
¤ş’
,

358 
size_t
 
de¡Ën
)

360 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

361 
»t
 = 0;

362 
wb™s
 = 
MAX_WBITS
;

363 
by‹s_Ëá
;

364 
tÙ®_out
 = 0;

365 
pg_off£t
 = 0;

367 
de¡Ën
 = 
	`mš_t
(, de¡Ën, 
PAGE_SIZE
);

368 
by‹s_Ëá
 = 
de¡Ën
;

370 
wÜk¥aû
->
¡rm
.
Ãxt_š
 = 
d©a_š
;

371 
wÜk¥aû
->
¡rm
.
ava_š
 = 
¤ş’
;

372 
wÜk¥aû
->
¡rm
.
tÙ®_š
 = 0;

374 
wÜk¥aû
->
¡rm
.
Ãxt_out
 = wÜk¥aû->
buf
;

375 
wÜk¥aû
->
¡rm
.
ava_out
 = wÜk¥aû->
buf_size
;

376 
wÜk¥aû
->
¡rm
.
tÙ®_out
 = 0;

379 ià(
¤ş’
 > 2 && !(
d©a_š
[1] & 
PRESET_DICT
) &&

380 ((
d©a_š
[0] & 0x0fè=ğ
Z_DEFLATED
) &&

381 !(((
d©a_š
[0]<<8) + data_in[1]) % 31)) {

383 
wb™s
 = -((
d©a_š
[0] >> 4) + 8);

384 
wÜk¥aû
->
¡rm
.
Ãxt_š
 += 2;

385 
wÜk¥aû
->
¡rm
.
ava_š
 -= 2;

388 ià(
Z_OK
 !ğ
	`zlib_šæ©eIn™2
(&
wÜk¥aû
->
¡rm
, 
wb™s
)) {

389 
	`´_w¬n
("BTRFS: inflateInit failed\n");

390  -
EIO
;

393 
by‹s_Ëá
 > 0) {

394 
buf_¡¬t
;

395 
buf_off£t
;

396 
by‹s
;

398 
»t
 = 
	`zlib_šæ©e
(&
wÜk¥aû
->
¡rm
, 
Z_NO_FLUSH
);

399 ià(
»t
 !ğ
Z_OK
 &&„‘ !ğ
Z_STREAM_END
)

402 
buf_¡¬t
 = 
tÙ®_out
;

403 
tÙ®_out
 = 
wÜk¥aû
->
¡rm
.total_out;

405 ià(
tÙ®_out
 =ğ
buf_¡¬t
) {

406 
»t
 = -
EIO
;

410 ià(
tÙ®_out
 <ğ
¡¬t_by‹
)

411 
Ãxt
;

413 ià(
tÙ®_out
 > 
¡¬t_by‹
 && 
buf_¡¬t
 < start_byte)

414 
buf_off£t
 = 
¡¬t_by‹
 - 
buf_¡¬t
;

416 
buf_off£t
 = 0;

418 
by‹s
 = 
	`mš
(
PAGE_SIZE
 - 
pg_off£t
,

419 
PAGE_SIZE
 - (
buf_off£t
 % PAGE_SIZE));

420 
by‹s
 = 
	`mš
(by‹s, 
by‹s_Ëá
);

422 
	`memıy_to_·ge
(
de¡_·ge
, 
pg_off£t
,

423 
wÜk¥aû
->
buf
 + 
buf_off£t
, 
by‹s
);

425 
pg_off£t
 +ğ
by‹s
;

426 
by‹s_Ëá
 -ğ
by‹s
;

427 
Ãxt
:

428 
wÜk¥aû
->
¡rm
.
Ãxt_out
 = wÜk¥aû->
buf
;

429 
wÜk¥aû
->
¡rm
.
ava_out
 = wÜk¥aû->
buf_size
;

432 ià(
»t
 !ğ
Z_STREAM_END
 && 
by‹s_Ëá
 != 0)

433 
»t
 = -
EIO
;

435 
»t
 = 0;

437 
	`zlib_šæ©eEnd
(&
wÜk¥aû
->
¡rm
);

444 ià(
pg_off£t
 < 
de¡Ën
) {

445 
	`memz”o_·ge
(
de¡_·ge
, 
pg_off£t
, 
de¡Ën
 -…g_offset);

447  
»t
;

448 
	}
}

450 cÚ¡ 
bŒfs_com´ess_İ
 
	gbŒfs_zlib_com´ess
 = {

451 .
wÜk¥aû_mªag”
 = &
wsm
,

452 .
	gmax_Ëv–
 = 9,

453 .
	gdeçuÉ_Ëv–
 = 
BTRFS_ZLIB_DEFAULT_LEVEL
,

	@zoned.c

3 
	~<lšux/b™İs.h
>

4 
	~<lšux/¦ab.h
>

5 
	~<lšux/blkdev.h
>

6 
	~<lšux/sched/mm.h
>

7 
	~<lšux/©omic.h
>

8 
	~<lšux/vm®loc.h
>

9 
	~"ù»e.h
"

10 
	~"vŞumes.h
"

11 
	~"zÚed.h
"

12 
	~"rcu-¡ršg.h
"

13 
	~"disk-io.h
"

14 
	~"block-group.h
"

15 
	~"Œª§ùiÚ.h
"

16 
	~"dev-»¶aû.h
"

17 
	~"¥aû-šfo.h
"

18 
	~"su³r.h
"

19 
	~"fs.h
"

20 
	~"acûssÜs.h
"

21 
	~"bio.h
"

24 
	#BTRFS_REPORT_NR_ZONES
 4096

	)

26 
	#WP_MISSING_DEV
 ((
u64
)-1)

	)

28 
	#WP_CONVENTIONAL
 ((
u64
)-2)

	)

37 
	#BTRFS_SB_LOG_PRIMARY_OFFSET
 (0ULL)

	)

38 
	#BTRFS_SB_LOG_FIRST_OFFSET
 (512ULL * 
SZ_1G
)

	)

39 
	#BTRFS_SB_LOG_SECOND_OFFSET
 (4096ULL * 
SZ_1G
)

	)

41 
	#BTRFS_SB_LOG_FIRST_SHIFT
 
	`cÚ¡_og2
(
BTRFS_SB_LOG_FIRST_OFFSET
)

	)

42 
	#BTRFS_SB_LOG_SECOND_SHIFT
 
	`cÚ¡_og2
(
BTRFS_SB_LOG_SECOND_OFFSET
)

	)

45 
	#BTRFS_NR_SB_LOG_ZONES
 2

	)

55 
	#BTRFS_MIN_ACTIVE_ZONES
 (
BTRFS_SUPER_MIRROR_MAX
 + 5)

	)

63 
	#BTRFS_MAX_ZONE_SIZE
 
SZ_8G


	)

64 
	#BTRFS_MIN_ZONE_SIZE
 
SZ_4M


	)

66 
	#SUPER_INFO_SECTORS
 ((
u64
)
BTRFS_SUPER_INFO_SIZE
 >> 
SECTOR_SHIFT
)

	)

68 
wa™_eb_wr™ebacks
(
bŒfs_block_group
 *
block_group
);

69 
do_zÚe_fšish
(
bŒfs_block_group
 *
block_group
, 
boŞ
 
fuÎy_wr™‹n
);

71 
šlše
 
boŞ
 
	$sb_zÚe_is_fuÎ
(cÚ¡ 
blk_zÚe
 *
zÚe
)

73  (
zÚe
->
cÚd
 =ğ
BLK_ZONE_COND_FULL
) ||

74 (
zÚe
->
wp
 + 
SUPER_INFO_SECTORS
 > zÚe->
¡¬t
 + zÚe->
ÿ·c™y
);

75 
	}
}

77 
	$cİy_zÚe_šfo_cb
(
blk_zÚe
 *
zÚe
, 
idx
, *
d©a
)

79 
blk_zÚe
 *
zÚes
 = 
d©a
;

81 
	`memıy
(&
zÚes
[
idx
], 
zÚe
, (*zone));

84 
	}
}

86 
	$sb_wr™e_poš‹r
(
block_deviû
 *
bdev
, 
blk_zÚe
 *
zÚes
,

87 
u64
 *
wp_»t
)

89 
boŞ
 
em±y
[
BTRFS_NR_SB_LOG_ZONES
];

90 
boŞ
 
fuÎ
[
BTRFS_NR_SB_LOG_ZONES
];

91 
£ùÜ_t
 
£ùÜ
;

92 
i
;

94 
i
 = 0; i < 
BTRFS_NR_SB_LOG_ZONES
; i++) {

95 
	`ASSERT
(
zÚes
[
i
].
ty³
 !ğ
BLK_ZONE_TYPE_CONVENTIONAL
);

96 
em±y
[
i
] = (
zÚes
[i].
cÚd
 =ğ
BLK_ZONE_COND_EMPTY
);

97 
fuÎ
[
i
] = 
	`sb_zÚe_is_fuÎ
(&
zÚes
[i]);

117 ià(
em±y
[0] &&ƒmpty[1]) {

119 *
wp_»t
 = 
zÚes
[0].
¡¬t
 << 
SECTOR_SHIFT
;

120  -
ENOENT
;

121 } ià(
fuÎ
[0] && full[1]) {

123 
add»ss_¥aû
 *
m­pšg
 = 
bdev
->
bd_šode
->
i_m­pšg
;

124 
·ge
 *·ge[
BTRFS_NR_SB_LOG_ZONES
];

125 
bŒfs_su³r_block
 *
su³r
[
BTRFS_NR_SB_LOG_ZONES
];

126 
i
;

128 
i
 = 0; i < 
BTRFS_NR_SB_LOG_ZONES
; i++) {

129 
u64
 
zÚe_’d
 = (
zÚes
[
i
].
¡¬t
 + zÚes[i].
ÿ·c™y
è<< 
SECTOR_SHIFT
;

130 
u64
 
by‹Ä
 = 
	`ALIGN_DOWN
(
zÚe_’d
, 
BTRFS_SUPER_INFO_SIZE
) -

131 
BTRFS_SUPER_INFO_SIZE
;

133 
·ge
[
i
] = 
	`»ad_ÿche_·ge_gå
(
m­pšg
,

134 
by‹Ä
 >> 
PAGE_SHIFT
, 
GFP_NOFS
);

135 ià(
	`IS_ERR
(
·ge
[
i
])) {

136 ià(
i
 == 1)

137 
	`bŒfs_»Ëa£_disk_su³r
(
su³r
[0]);

138  
	`PTR_ERR
(
·ge
[
i
]);

140 
su³r
[
i
] = 
	`·ge_add»ss
(
·ge
[i]);

143 ià(
	`bŒfs_su³r_g’”©iÚ
(
su³r
[0]) >

144 
	`bŒfs_su³r_g’”©iÚ
(
su³r
[1]))

145 
£ùÜ
 = 
zÚes
[1].
¡¬t
;

147 
£ùÜ
 = 
zÚes
[0].
¡¬t
;

149 
i
 = 0; i < 
BTRFS_NR_SB_LOG_ZONES
; i++)

150 
	`bŒfs_»Ëa£_disk_su³r
(
su³r
[
i
]);

151 } ià(!
fuÎ
[0] && (
em±y
[1] || full[1])) {

152 
£ùÜ
 = 
zÚes
[0].
wp
;

153 } ià(
fuÎ
[0]) {

154 
£ùÜ
 = 
zÚes
[1].
wp
;

156  -
EUCLEAN
;

158 *
wp_»t
 = 
£ùÜ
 << 
SECTOR_SHIFT
;

160 
	}
}

165 
šlše
 
u32
 
	$sb_zÚe_numb”
(
shiá
, 
mœrÜ
)

167 
u64
 
zÚe
 = 
U64_MAX
;

169 
	`ASSERT
(
mœrÜ
 < 
BTRFS_SUPER_MIRROR_MAX
);

170 
mœrÜ
) {

171 0: 
zÚe
 = 0; ;

172 1: 
zÚe
 = 1ULL << (
BTRFS_SB_LOG_FIRST_SHIFT
 - 
shiá
); ;

173 2: 
zÚe
 = 1ULL << (
BTRFS_SB_LOG_SECOND_SHIFT
 - 
shiá
); ;

176 
	`ASSERT
(
zÚe
 <ğ
U32_MAX
);

178  (
u32
)
zÚe
;

179 
	}
}

181 
šlše
 
£ùÜ_t
 
	$zÚe_¡¬t_£ùÜ
(
u32
 
zÚe_numb”
,

182 
block_deviû
 *
bdev
)

184  (
£ùÜ_t
)
zÚe_numb”
 << 
	`og2
(
	`bdev_zÚe_£ùÜs
(
bdev
));

185 
	}
}

187 
šlše
 
u64
 
	$zÚe_¡¬t_physiÿl
(
u32
 
zÚe_numb”
,

188 
bŒfs_zÚed_deviû_šfo
 *
zÚe_šfo
)

190  (
u64
)
zÚe_numb”
 << 
zÚe_šfo
->
zÚe_size_shiá
;

191 
	}
}

198 
	$emuÏ‹_»pÜt_zÚes
(
bŒfs_deviû
 *
deviû
, 
u64
 
pos
,

199 
blk_zÚe
 *
zÚes
, 
Ä_zÚes
)

201 cÚ¡ 
£ùÜ_t
 
zÚe_£ùÜs
 = 
deviû
->
fs_šfo
->
zÚe_size
 >> 
SECTOR_SHIFT
;

202 
£ùÜ_t
 
bdev_size
 = 
	`bdev_Ä_£ùÜs
(
deviû
->
bdev
);

203 
i
;

205 
pos
 >>ğ
SECTOR_SHIFT
;

206 
i
 = 0; i < 
Ä_zÚes
; i++) {

207 
zÚes
[
i
].
¡¬t
 = i * 
zÚe_£ùÜs
 + 
pos
;

208 
zÚes
[
i
].
Ën
 = 
zÚe_£ùÜs
;

209 
zÚes
[
i
].
ÿ·c™y
 = 
zÚe_£ùÜs
;

210 
zÚes
[
i
].
wp
 = zÚes[i].
¡¬t
 + 
zÚe_£ùÜs
;

211 
zÚes
[
i
].
ty³
 = 
BLK_ZONE_TYPE_CONVENTIONAL
;

212 
zÚes
[
i
].
cÚd
 = 
BLK_ZONE_COND_NOT_WP
;

214 ià(
zÚes
[
i
].
wp
 >ğ
bdev_size
) {

215 
i
++;

220  
i
;

221 
	}
}

223 
	$bŒfs_g‘_dev_zÚes
(
bŒfs_deviû
 *
deviû
, 
u64
 
pos
,

224 
blk_zÚe
 *
zÚes
, *
Ä_zÚes
)

226 
bŒfs_zÚed_deviû_šfo
 *
zšfo
 = 
deviû
->
zÚe_šfo
;

227 
»t
;

229 ià(!*
Ä_zÚes
)

232 ià(!
	`bdev_is_zÚed
(
deviû
->
bdev
)) {

233 
»t
 = 
	`emuÏ‹_»pÜt_zÚes
(
deviû
, 
pos
, 
zÚes
, *
Ä_zÚes
);

234 *
Ä_zÚes
 = 
»t
;

239 ià(
zšfo
->
zÚe_ÿche
) {

240 
i
;

241 
u32
 
zno
;

243 
	`ASSERT
(
	`IS_ALIGNED
(
pos
, 
zšfo
->
zÚe_size
));

244 
zno
 = 
pos
 >> 
zšfo
->
zÚe_size_shiá
;

249 *
Ä_zÚes
 = 
	`mš_t
(
u32
, *Ä_zÚes, 
zšfo
->Ä_zÚe - 
zno
);

251 
i
 = 0; i < *
Ä_zÚes
; i++) {

252 
blk_zÚe
 *
zÚe_šfo
;

254 
zÚe_šfo
 = &
zšfo
->
zÚe_ÿche
[
zno
 + 
i
];

255 ià(!
zÚe_šfo
->
Ën
)

259 ià(
i
 =ğ*
Ä_zÚes
) {

261 
	`memıy
(
zÚes
, 
zšfo
->
zÚe_ÿche
 + 
zno
,

262 (*
zšfo
->
zÚe_ÿche
è* *
Ä_zÚes
);

267 
»t
 = 
	`blkdev_»pÜt_zÚes
(
deviû
->
bdev
, 
pos
 >> 
SECTOR_SHIFT
, *
Ä_zÚes
,

268 
cİy_zÚe_šfo_cb
, 
zÚes
);

269 ià(
»t
 < 0) {

270 
	`bŒfs_”r_š_rcu
(
deviû
->
fs_šfo
,

272 
pos
, 
	`rcu_¡r_d”ef
(
deviû
->
Çme
),

273 
deviû
->
devid
);

274  
»t
;

276 *
Ä_zÚes
 = 
»t
;

277 ià(!
»t
)

278  -
EIO
;

281 ià(
zšfo
->
zÚe_ÿche
) {

282 
u32
 
zno
 = 
pos
 >> 
zšfo
->
zÚe_size_shiá
;

284 
	`memıy
(
zšfo
->
zÚe_ÿche
 + 
zno
, 
zÚes
,

285 (*
zšfo
->
zÚe_ÿche
è* *
Ä_zÚes
);

289 
	}
}

292 
	$ÿlcuÏ‹_emuÏ‹d_zÚe_size
(
bŒfs_fs_šfo
 *
fs_šfo
)

294 
bŒfs_·th
 *
·th
;

295 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

296 
bŒfs_key
 
key
;

297 
ex‹Á_bufãr
 *
Ëaf
;

298 
bŒfs_dev_ex‹Á
 *
dext
;

299 
»t
 = 0;

301 
key
.
objeùid
 = 1;

302 
key
.
ty³
 = 
BTRFS_DEV_EXTENT_KEY
;

303 
key
.
off£t
 = 0;

305 
·th
 = 
	`bŒfs_®loc_·th
();

306 ià(!
·th
)

307  -
ENOMEM
;

309 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

310 ià(
»t
 < 0)

311 
out
;

313 ià(
·th
->
¦Ùs
[0] >ğ
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0])) {

314 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

315 ià(
»t
 < 0)

316 
out
;

318 ià(
»t
 > 0) {

319 
»t
 = -
EUCLEAN
;

320 
out
;

324 
Ëaf
 = 
·th
->
nodes
[0];

325 
dext
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_dev_ex‹Á
);

326 
fs_šfo
->
zÚe_size
 = 
	`bŒfs_dev_ex‹Á_Ëngth
(
Ëaf
, 
dext
);

327 
»t
 = 0;

329 
out
:

330 
	`bŒfs_ä“_·th
(
·th
);

332  
»t
;

333 
	}
}

335 
	$bŒfs_g‘_dev_zÚe_šfo_®l_deviûs
(
bŒfs_fs_šfo
 *
fs_šfo
)

337 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

338 
bŒfs_deviû
 *
deviû
;

339 
»t
 = 0;

342 ià(!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
ZONED
))

345 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

346 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

348 ià(!
deviû
->
bdev
)

351 
»t
 = 
	`bŒfs_g‘_dev_zÚe_šfo
(
deviû
, 
Œue
);

352 ià(
»t
)

355 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

357  
»t
;

358 
	}
}

360 
	$bŒfs_g‘_dev_zÚe_šfo
(
bŒfs_deviû
 *
deviû
, 
boŞ
 
pİuÏ‹_ÿche
)

362 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

363 
bŒfs_zÚed_deviû_šfo
 *
zÚe_šfo
 = 
NULL
;

364 
block_deviû
 *
bdev
 = 
deviû
->bdev;

365 
max_aùive_zÚes
;

366 
Çùive
;

367 
£ùÜ_t
 
Ä_£ùÜs
;

368 
£ùÜ_t
 
£ùÜ
 = 0;

369 
blk_zÚe
 *
zÚes
 = 
NULL
;

370 
i
, 
Ä•Ü‹d
 = 0, 
Ä_zÚes
;

371 
£ùÜ_t
 
zÚe_£ùÜs
;

372 *
mod–
, *
emuÏ‹d
;

373 
»t
;

379 ià(!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
ZONED
))

382 ià(
deviû
->
zÚe_šfo
)

385 
zÚe_šfo
 = 
	`kz®loc
((*zÚe_šfo), 
GFP_KERNEL
);

386 ià(!
zÚe_šfo
)

387  -
ENOMEM
;

389 
deviû
->
zÚe_šfo
 = zone_info;

391 ià(!
	`bdev_is_zÚed
(
bdev
)) {

392 ià(!
fs_šfo
->
zÚe_size
) {

393 
»t
 = 
	`ÿlcuÏ‹_emuÏ‹d_zÚe_size
(
fs_šfo
);

394 ià(
»t
)

395 
out
;

398 
	`ASSERT
(
fs_šfo
->
zÚe_size
);

399 
zÚe_£ùÜs
 = 
fs_šfo
->
zÚe_size
 >> 
SECTOR_SHIFT
;

401 
zÚe_£ùÜs
 = 
	`bdev_zÚe_£ùÜs
(
bdev
);

404 
	`ASSERT
(
	`is_pow”_of_two_u64
(
zÚe_£ùÜs
));

405 
zÚe_šfo
->
zÚe_size
 = 
zÚe_£ùÜs
 << 
SECTOR_SHIFT
;

408 ià(
zÚe_šfo
->
zÚe_size
 > 
BTRFS_MAX_ZONE_SIZE
) {

409 
	`bŒfs_”r_š_rcu
(
fs_šfo
,

411 
	`rcu_¡r_d”ef
(
deviû
->
Çme
),

412 
zÚe_šfo
->
zÚe_size
, 
BTRFS_MAX_ZONE_SIZE
);

413 
»t
 = -
EINVAL
;

414 
out
;

415 } ià(
zÚe_šfo
->
zÚe_size
 < 
BTRFS_MIN_ZONE_SIZE
) {

416 
	`bŒfs_”r_š_rcu
(
fs_šfo
,

418 
	`rcu_¡r_d”ef
(
deviû
->
Çme
),

419 
zÚe_šfo
->
zÚe_size
, 
BTRFS_MIN_ZONE_SIZE
);

420 
»t
 = -
EINVAL
;

421 
out
;

424 
Ä_£ùÜs
 = 
	`bdev_Ä_£ùÜs
(
bdev
);

425 
zÚe_šfo
->
zÚe_size_shiá
 = 
	`og2
(zÚe_šfo->
zÚe_size
);

426 
zÚe_šfo
->
Ä_zÚes
 = 
Ä_£ùÜs
 >> 
	`og2
(
zÚe_£ùÜs
);

427 ià(!
	`IS_ALIGNED
(
Ä_£ùÜs
, 
zÚe_£ùÜs
))

428 
zÚe_šfo
->
Ä_zÚes
++;

430 
max_aùive_zÚes
 = 
	`bdev_max_aùive_zÚes
(
bdev
);

431 ià(
max_aùive_zÚes
 && max_aùive_zÚe < 
BTRFS_MIN_ACTIVE_ZONES
) {

432 
	`bŒfs_”r_š_rcu
(
fs_šfo
,

434 
	`rcu_¡r_d”ef
(
deviû
->
Çme
), 
max_aùive_zÚes
,

435 
BTRFS_MIN_ACTIVE_ZONES
);

436 
»t
 = -
EINVAL
;

437 
out
;

439 
zÚe_šfo
->
max_aùive_zÚes
 = max_active_zones;

441 
zÚe_šfo
->
£q_zÚes
 = 
	`b™m­_z®loc
(zÚe_šfo->
Ä_zÚes
, 
GFP_KERNEL
);

442 ià(!
zÚe_šfo
->
£q_zÚes
) {

443 
»t
 = -
ENOMEM
;

444 
out
;

447 
zÚe_šfo
->
em±y_zÚes
 = 
	`b™m­_z®loc
(zÚe_šfo->
Ä_zÚes
, 
GFP_KERNEL
);

448 ià(!
zÚe_šfo
->
em±y_zÚes
) {

449 
»t
 = -
ENOMEM
;

450 
out
;

453 
zÚe_šfo
->
aùive_zÚes
 = 
	`b™m­_z®loc
(zÚe_šfo->
Ä_zÚes
, 
GFP_KERNEL
);

454 ià(!
zÚe_šfo
->
aùive_zÚes
) {

455 
»t
 = -
ENOMEM
;

456 
out
;

459 
zÚes
 = 
	`kvÿÎoc
(
BTRFS_REPORT_NR_ZONES
, (
blk_zÚe
), 
GFP_KERNEL
);

460 ià(!
zÚes
) {

461 
»t
 = -
ENOMEM
;

462 
out
;

470 ià(
pİuÏ‹_ÿche
 && 
	`bdev_is_zÚed
(
deviû
->
bdev
)) {

471 
zÚe_šfo
->
zÚe_ÿche
 = 
	`vÿÎoc
(zÚe_šfo->
Ä_zÚes
,

472 (
blk_zÚe
));

473 ià(!
zÚe_šfo
->
zÚe_ÿche
) {

474 
	`bŒfs_”r_š_rcu
(
deviû
->
fs_šfo
,

476 
	`rcu_¡r_d”ef
(
deviû
->
Çme
));

477 
»t
 = -
ENOMEM
;

478 
out
;

483 
Çùive
 = 0;

484 
£ùÜ
 < 
Ä_£ùÜs
) {

485 
Ä_zÚes
 = 
BTRFS_REPORT_NR_ZONES
;

486 
»t
 = 
	`bŒfs_g‘_dev_zÚes
(
deviû
, 
£ùÜ
 << 
SECTOR_SHIFT
, 
zÚes
,

487 &
Ä_zÚes
);

488 ià(
»t
)

489 
out
;

491 
i
 = 0; i < 
Ä_zÚes
; i++) {

492 ià(
zÚes
[
i
].
ty³
 =ğ
BLK_ZONE_TYPE_SEQWRITE_REQ
)

493 
	`__£t_b™
(
Ä•Ü‹d
, 
zÚe_šfo
->
£q_zÚes
);

494 
zÚes
[
i
].
cÚd
) {

495 
BLK_ZONE_COND_EMPTY
:

496 
	`__£t_b™
(
Ä•Ü‹d
, 
zÚe_šfo
->
em±y_zÚes
);

498 
BLK_ZONE_COND_IMP_OPEN
:

499 
BLK_ZONE_COND_EXP_OPEN
:

500 
BLK_ZONE_COND_CLOSED
:

501 
	`__£t_b™
(
Ä•Ü‹d
, 
zÚe_šfo
->
aùive_zÚes
);

502 
Çùive
++;

505 
Ä•Ü‹d
++;

507 
£ùÜ
 = 
zÚes
[
Ä_zÚes
 - 1].
¡¬t
 + zÚes[Ä_zÚe - 1].
Ën
;

510 ià(
Ä•Ü‹d
 !ğ
zÚe_šfo
->
Ä_zÚes
) {

511 
	`bŒfs_”r_š_rcu
(
deviû
->
fs_šfo
,

513 
	`rcu_¡r_d”ef
(
deviû
->
Çme
), 
Ä•Ü‹d
,

514 
zÚe_šfo
->
Ä_zÚes
);

515 
»t
 = -
EIO
;

516 
out
;

519 ià(
max_aùive_zÚes
) {

520 ià(
Çùive
 > 
max_aùive_zÚes
) {

521 
	`bŒfs_”r_š_rcu
(
deviû
->
fs_šfo
,

523 
Çùive
, 
	`rcu_¡r_d”ef
(
deviû
->
Çme
),

524 
max_aùive_zÚes
);

525 
»t
 = -
EIO
;

526 
out
;

528 
	`©omic_£t
(&
zÚe_šfo
->
aùive_zÚes_Ëá
,

529 
max_aùive_zÚes
 - 
Çùive
);

530 
	`£t_b™
(
BTRFS_FS_ACTIVE_ZONE_TRACKING
, &
fs_šfo
->
æags
);

534 
Ä_zÚes
 = 
BTRFS_NR_SB_LOG_ZONES
;

535 
i
 = 0; i < 
BTRFS_SUPER_MIRROR_MAX
; i++) {

536 
u32
 
sb_zÚe
;

537 
u64
 
sb_wp
;

538 
sb_pos
 = 
BTRFS_NR_SB_LOG_ZONES
 * 
i
;

540 
sb_zÚe
 = 
	`sb_zÚe_numb”
(
zÚe_šfo
->
zÚe_size_shiá
, 
i
);

541 ià(
sb_zÚe
 + 1 >ğ
zÚe_šfo
->
Ä_zÚes
)

544 
»t
 = 
	`bŒfs_g‘_dev_zÚes
(
deviû
,

545 
	`zÚe_¡¬t_physiÿl
(
sb_zÚe
, 
zÚe_šfo
),

546 &
zÚe_šfo
->
sb_zÚes
[
sb_pos
],

547 &
Ä_zÚes
);

548 ià(
»t
)

549 
out
;

551 ià(
Ä_zÚes
 !ğ
BTRFS_NR_SB_LOG_ZONES
) {

552 
	`bŒfs_”r_š_rcu
(
deviû
->
fs_šfo
,

554 
deviû
->
devid
, 
sb_zÚe
);

555 
»t
 = -
EUCLEAN
;

556 
out
;

563 ià(
zÚe_šfo
->
sb_zÚes
[
BTRFS_NR_SB_LOG_ZONES
 * 
i
].
ty³
 ==

564 
BLK_ZONE_TYPE_CONVENTIONAL
)

567 
»t
 = 
	`sb_wr™e_poš‹r
(
deviû
->
bdev
,

568 &
zÚe_šfo
->
sb_zÚes
[
sb_pos
], &
sb_wp
);

569 ià(
»t
 !ğ-
ENOENT
 &&„et) {

570 
	`bŒfs_”r_š_rcu
(
deviû
->
fs_šfo
,

572 
deviû
->
devid
, 
sb_zÚe
);

573 
»t
 = -
EUCLEAN
;

574 
out
;

579 
	`kvä“
(
zÚes
);

581 
	`bdev_zÚed_mod–
(
bdev
)) {

582 
BLK_ZONED_HM
:

583 
mod–
 = "host-managed zoned";

584 
emuÏ‹d
 = "";

586 
BLK_ZONED_HA
:

587 
mod–
 = "host-aware zoned";

588 
emuÏ‹d
 = "";

590 
BLK_ZONED_NONE
:

591 
mod–
 = "regular";

592 
emuÏ‹d
 = "emulated ";

596 
	`bŒfs_”r_š_rcu
(
fs_šfo
, "zoned: unsupported model %d on %s",

597 
	`bdev_zÚed_mod–
(
bdev
),

598 
	`rcu_¡r_d”ef
(
deviû
->
Çme
));

599 
»t
 = -
EOPNOTSUPP
;

600 
out_ä“_zÚe_šfo
;

603 
	`bŒfs_šfo_š_rcu
(
fs_šfo
,

605 
mod–
, 
	`rcu_¡r_d”ef
(
deviû
->
Çme
), 
zÚe_šfo
->
Ä_zÚes
,

606 
emuÏ‹d
, 
zÚe_šfo
->
zÚe_size
);

610 
out
:

611 
	`kvä“
(
zÚes
);

612 
out_ä“_zÚe_šfo
:

613 
	`bŒfs_de¡roy_dev_zÚe_šfo
(
deviû
);

615  
»t
;

616 
	}
}

618 
	$bŒfs_de¡roy_dev_zÚe_šfo
(
bŒfs_deviû
 *
deviû
)

620 
bŒfs_zÚed_deviû_šfo
 *
zÚe_šfo
 = 
deviû
->zone_info;

622 ià(!
zÚe_šfo
)

625 
	`b™m­_ä“
(
zÚe_šfo
->
aùive_zÚes
);

626 
	`b™m­_ä“
(
zÚe_šfo
->
£q_zÚes
);

627 
	`b™m­_ä“
(
zÚe_šfo
->
em±y_zÚes
);

628 
	`vä“
(
zÚe_šfo
->
zÚe_ÿche
);

629 
	`kä“
(
zÚe_šfo
);

630 
deviû
->
zÚe_šfo
 = 
NULL
;

631 
	}
}

633 
bŒfs_zÚed_deviû_šfo
 *
	$bŒfs_şÚe_dev_zÚe_šfo
(
bŒfs_deviû
 *
Üig_dev
)

635 
bŒfs_zÚed_deviû_šfo
 *
zÚe_šfo
;

637 
zÚe_šfo
 = 
	`kmemdup
(
Üig_dev
->zÚe_šfo, (*zÚe_šfo), 
GFP_KERNEL
);

638 ià(!
zÚe_šfo
)

639  
NULL
;

641 
zÚe_šfo
->
£q_zÚes
 = 
	`b™m­_z®loc
(zÚe_šfo->
Ä_zÚes
, 
GFP_KERNEL
);

642 ià(!
zÚe_šfo
->
£q_zÚes
)

643 
out
;

645 
	`b™m­_cİy
(
zÚe_šfo
->
£q_zÚes
, 
Üig_dev
->zone_info->seq_zones,

646 
zÚe_šfo
->
Ä_zÚes
);

648 
zÚe_šfo
->
em±y_zÚes
 = 
	`b™m­_z®loc
(zÚe_šfo->
Ä_zÚes
, 
GFP_KERNEL
);

649 ià(!
zÚe_šfo
->
em±y_zÚes
)

650 
out
;

652 
	`b™m­_cİy
(
zÚe_šfo
->
em±y_zÚes
, 
Üig_dev
->zone_info->empty_zones,

653 
zÚe_šfo
->
Ä_zÚes
);

655 
zÚe_šfo
->
aùive_zÚes
 = 
	`b™m­_z®loc
(zÚe_šfo->
Ä_zÚes
, 
GFP_KERNEL
);

656 ià(!
zÚe_šfo
->
aùive_zÚes
)

657 
out
;

659 
	`b™m­_cİy
(
zÚe_šfo
->
aùive_zÚes
, 
Üig_dev
->zone_info->active_zones,

660 
zÚe_šfo
->
Ä_zÚes
);

661 
zÚe_šfo
->
zÚe_ÿche
 = 
NULL
;

663  
zÚe_šfo
;

665 
out
:

666 
	`b™m­_ä“
(
zÚe_šfo
->
£q_zÚes
);

667 
	`b™m­_ä“
(
zÚe_šfo
->
em±y_zÚes
);

668 
	`b™m­_ä“
(
zÚe_šfo
->
aùive_zÚes
);

669 
	`kä“
(
zÚe_šfo
);

670  
NULL
;

671 
	}
}

673 
	$bŒfs_g‘_dev_zÚe
(
bŒfs_deviû
 *
deviû
, 
u64
 
pos
,

674 
blk_zÚe
 *
zÚe
)

676 
Ä_zÚes
 = 1;

677 
»t
;

679 
»t
 = 
	`bŒfs_g‘_dev_zÚes
(
deviû
, 
pos
, 
zÚe
, &
Ä_zÚes
);

680 ià(
»t
 !ğ0 || !
Ä_zÚes
)

681  
»t
 ?„‘ : -
EIO
;

684 
	}
}

686 
	$bŒfs_check_fÜ_zÚed_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
)

688 
bŒfs_deviû
 *
deviû
;

690 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_šfo
->
fs_deviûs
->
deviûs
, 
dev_li¡
) {

691 ià(
deviû
->
bdev
 &&

692 
	`bdev_zÚed_mod–
(
deviû
->
bdev
è=ğ
BLK_ZONED_HM
) {

693 
	`bŒfs_”r
(
fs_šfo
,

695 
deviû
->
bdev
);

696  -
EINVAL
;

701 
	}
}

703 
	$bŒfs_check_zÚed_mode
(
bŒfs_fs_šfo
 *
fs_šfo
)

705 
queue_lim™s
 *
lim
 = &
fs_šfo
->
lim™s
;

706 
bŒfs_deviû
 *
deviû
;

707 
u64
 
zÚe_size
 = 0;

708 
»t
;

714 ià(!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
ZONED
))

715  
	`bŒfs_check_fÜ_zÚed_deviû
(
fs_šfo
);

717 
	`blk_£t_¡ackšg_lim™s
(
lim
);

719 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_šfo
->
fs_deviûs
->
deviûs
, 
dev_li¡
) {

720 
bŒfs_zÚed_deviû_šfo
 *
zÚe_šfo
 = 
deviû
->zone_info;

722 ià(!
deviû
->
bdev
)

725 ià(!
zÚe_size
) {

726 
zÚe_size
 = 
zÚe_šfo
->zone_size;

727 } ià(
zÚe_šfo
->
zÚe_size
 != zone_size) {

728 
	`bŒfs_”r
(
fs_šfo
,

730 
zÚe_šfo
->
zÚe_size
, zone_size);

731  -
EINVAL
;

739 ià(
	`bdev_is_zÚed
(
deviû
->
bdev
)) {

740 
	`blk_¡ack_lim™s
(
lim
,

741 &
	`bdev_g‘_queue
(
deviû
->
bdev
)->
lim™s
,

751 ià(!
	`IS_ALIGNED
(
zÚe_size
, 
BTRFS_STRIPE_LEN
)) {

752 
	`bŒfs_”r
(
fs_šfo
,

754 
zÚe_size
, 
BTRFS_STRIPE_LEN
);

755  -
EINVAL
;

758 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
MIXED_GROUPS
)) {

759 
	`bŒfs_”r
(
fs_šfo
, "zoned: mixed block groups‚ot supported");

760  -
EINVAL
;

763 
fs_šfo
->
zÚe_size
 = zone_size;

771 
fs_šfo
->
max_zÚe_­³nd_size
 = 
	`ALIGN_DOWN
(

772 
	`mš3
((
u64
)
lim
->
max_zÚe_­³nd_£ùÜs
 << 
SECTOR_SHIFT
,

773 (
u64
)
lim
->
max_£ùÜs
 << 
SECTOR_SHIFT
,

774 (
u64
)
lim
->
max_£gm’ts
 << 
PAGE_SHIFT
),

775 
fs_šfo
->
£ùÜsize
);

776 
fs_šfo
->
fs_deviûs
->
chunk_®loc_pŞicy
 = 
BTRFS_CHUNK_ALLOC_ZONED
;

777 ià(
fs_šfo
->
max_zÚe_­³nd_size
 < fs_šfo->
max_ex‹Á_size
)

778 
fs_šfo
->
max_ex‹Á_size
 = fs_šfo->
max_zÚe_­³nd_size
;

784 
»t
 = 
	`bŒfs_check_mouÁİts_zÚed
(
fs_šfo
);

785 ià(
»t
)

786  
»t
;

788 
	`bŒfs_šfo
(
fs_šfo
, "zÚed mod’abËd w™h zÚsiz%Îu", 
zÚe_size
);

790 
	}
}

792 
	$bŒfs_check_mouÁİts_zÚed
(
bŒfs_fs_šfo
 *
šfo
)

794 ià(!
	`bŒfs_is_zÚed
(
šfo
))

801 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
SPACE_CACHE
)) {

802 
	`bŒfs_”r
(
šfo
, "zoned: space cache v1 is‚ot supported");

803  -
EINVAL
;

806 ià(
	`bŒfs_‹¡_İt
(
šfo
, 
NODATACOW
)) {

807 
	`bŒfs_”r
(
šfo
, "zoned: NODATACOW‚ot supported");

808  -
EINVAL
;

811 
	`bŒfs_ş—r_ªd_šfo
(
šfo
, 
DISCARD_ASYNC
,

815 
	}
}

817 
	$sb_log_loÿtiÚ
(
block_deviû
 *
bdev
, 
blk_zÚe
 *
zÚes
,

818 
rw
, 
u64
 *
by‹Ä_»t
)

820 
u64
 
wp
;

821 
»t
;

823 ià(
zÚes
[0].
ty³
 =ğ
BLK_ZONE_TYPE_CONVENTIONAL
) {

824 *
by‹Ä_»t
 = 
zÚes
[0].
¡¬t
 << 
SECTOR_SHIFT
;

828 
»t
 = 
	`sb_wr™e_poš‹r
(
bdev
, 
zÚes
, &
wp
);

829 ià(
»t
 !ğ-
ENOENT
 &&„et < 0)

830  
»t
;

832 ià(
rw
 =ğ
WRITE
) {

833 
blk_zÚe
 *
»£t
 = 
NULL
;

835 ià(
wp
 =ğ
zÚes
[0].
¡¬t
 << 
SECTOR_SHIFT
)

836 
»£t
 = &
zÚes
[0];

837 ià(
wp
 =ğ
zÚes
[1].
¡¬t
 << 
SECTOR_SHIFT
)

838 
»£t
 = &
zÚes
[1];

840 ià(
»£t
 &&„e£t->
cÚd
 !ğ
BLK_ZONE_COND_EMPTY
) {

841 
	`ASSERT
(
	`sb_zÚe_is_fuÎ
(
»£t
));

843 
»t
 = 
	`blkdev_zÚe_mgmt
(
bdev
, 
REQ_OP_ZONE_RESET
,

844 
»£t
->
¡¬t
,„e£t->
Ën
,

845 
GFP_NOFS
);

846 ià(
»t
)

847  
»t
;

849 
»£t
->
cÚd
 = 
BLK_ZONE_COND_EMPTY
;

850 
»£t
->
wp
 =„e£t->
¡¬t
;

852 } ià(
»t
 !ğ-
ENOENT
) {

857 
u64
 
zÚe_’d
 = 0;

859 ià(
wp
 =ğ
zÚes
[0].
¡¬t
 << 
SECTOR_SHIFT
)

860 
zÚe_’d
 = 
zÚes
[1].
¡¬t
 + zÚes[1].
ÿ·c™y
;

861 ià(
wp
 =ğ
zÚes
[1].
¡¬t
 << 
SECTOR_SHIFT
)

862 
zÚe_’d
 = 
zÚes
[0].
¡¬t
 + zÚes[0].
ÿ·c™y
;

863 ià(
zÚe_’d
)

864 
wp
 = 
	`ALIGN_DOWN
(
zÚe_’d
 << 
SECTOR_SHIFT
,

865 
BTRFS_SUPER_INFO_SIZE
);

867 
wp
 -ğ
BTRFS_SUPER_INFO_SIZE
;

870 *
by‹Ä_»t
 = 
wp
;

873 
	}
}

875 
	$bŒfs_sb_log_loÿtiÚ_bdev
(
block_deviû
 *
bdev
, 
mœrÜ
, 
rw
,

876 
u64
 *
by‹Ä_»t
)

878 
blk_zÚe
 
zÚes
[
BTRFS_NR_SB_LOG_ZONES
];

879 
£ùÜ_t
 
zÚe_£ùÜs
;

880 
u32
 
sb_zÚe
;

881 
»t
;

882 
u8
 
zÚe_£ùÜs_shiá
;

883 
£ùÜ_t
 
Ä_£ùÜs
;

884 
u32
 
Ä_zÚes
;

886 ià(!
	`bdev_is_zÚed
(
bdev
)) {

887 *
by‹Ä_»t
 = 
	`bŒfs_sb_off£t
(
mœrÜ
);

891 
	`ASSERT
(
rw
 =ğ
READ
 ||„w =ğ
WRITE
);

893 
zÚe_£ùÜs
 = 
	`bdev_zÚe_£ùÜs
(
bdev
);

894 ià(!
	`is_pow”_of_2
(
zÚe_£ùÜs
))

895  -
EINVAL
;

896 
zÚe_£ùÜs_shiá
 = 
	`og2
(
zÚe_£ùÜs
);

897 
Ä_£ùÜs
 = 
	`bdev_Ä_£ùÜs
(
bdev
);

898 
Ä_zÚes
 = 
Ä_£ùÜs
 >> 
zÚe_£ùÜs_shiá
;

900 
sb_zÚe
 = 
	`sb_zÚe_numb”
(
zÚe_£ùÜs_shiá
 + 
SECTOR_SHIFT
, 
mœrÜ
);

901 ià(
sb_zÚe
 + 1 >ğ
Ä_zÚes
)

902  -
ENOENT
;

904 
»t
 = 
	`blkdev_»pÜt_zÚes
(
bdev
, 
	`zÚe_¡¬t_£ùÜ
(
sb_zÚe
, bdev),

905 
BTRFS_NR_SB_LOG_ZONES
, 
cİy_zÚe_šfo_cb
,

906 
zÚes
);

907 ià(
»t
 < 0)

908  
»t
;

909 ià(
»t
 !ğ
BTRFS_NR_SB_LOG_ZONES
)

910  -
EIO
;

912  
	`sb_log_loÿtiÚ
(
bdev
, 
zÚes
, 
rw
, 
by‹Ä_»t
);

913 
	}
}

915 
	$bŒfs_sb_log_loÿtiÚ_bdev_·¹™iÚ
(
block_deviû
 *
bdev
,

916 
mœrÜ
, 
rw
, 
u64
 *
by‹Ä_»t
, u64 
sb_off£t
)

918 
blk_zÚe
 
zÚes
[
BTRFS_NR_SB_LOG_ZONES
];

919 
£ùÜ_t
 
zÚe_£ùÜs
;

920 
u32
 
sb_zÚe
;

921 
»t
;

922 
u8
 
zÚe_£ùÜs_shiá
;

923 
£ùÜ_t
 
Ä_£ùÜs
;

924 
u32
 
Ä_zÚes
;

926 ià(!
	`bdev_is_zÚed
(
bdev
)) {

927 *
by‹Ä_»t
 = 
	`bŒfs_sb_off£t_·¹™iÚ
(
mœrÜ
, 
sb_off£t
);

931 
	`ASSERT
(
rw
 =ğ
READ
 ||„w =ğ
WRITE
);

933 
zÚe_£ùÜs
 = 
	`bdev_zÚe_£ùÜs
(
bdev
);

934 ià(!
	`is_pow”_of_2
(
zÚe_£ùÜs
))

935  -
EINVAL
;

936 
zÚe_£ùÜs_shiá
 = 
	`og2
(
zÚe_£ùÜs
);

937 
Ä_£ùÜs
 = 
	`bdev_Ä_£ùÜs
(
bdev
);

938 
Ä_zÚes
 = 
Ä_£ùÜs
 >> 
zÚe_£ùÜs_shiá
;

940 
sb_zÚe
 = 
	`sb_zÚe_numb”
(
zÚe_£ùÜs_shiá
 + 
SECTOR_SHIFT
, 
mœrÜ
);

941 ià(
sb_zÚe
 + 1 >ğ
Ä_zÚes
)

942  -
ENOENT
;

944 
»t
 = 
	`blkdev_»pÜt_zÚes
(
bdev
, 
	`zÚe_¡¬t_£ùÜ
(
sb_zÚe
, bdev),

945 
BTRFS_NR_SB_LOG_ZONES
, 
cİy_zÚe_šfo_cb
,

946 
zÚes
);

947 ià(
»t
 < 0)

948  
»t
;

949 ià(
»t
 !ğ
BTRFS_NR_SB_LOG_ZONES
)

950  -
EIO
;

952  
	`sb_log_loÿtiÚ
(
bdev
, 
zÚes
, 
rw
, 
by‹Ä_»t
);

953 
	}
}

955 
	$bŒfs_sb_log_loÿtiÚ
(
bŒfs_deviû
 *
deviû
, 
mœrÜ
, 
rw
,

956 
u64
 *
by‹Ä_»t
)

958 
bŒfs_zÚed_deviû_šfo
 *
zšfo
 = 
deviû
->
zÚe_šfo
;

959 
u32
 
zÚe_num
;

967 ià(!
	`bdev_is_zÚed
(
deviû
->
bdev
)) {

968 *
by‹Ä_»t
 = 
	`bŒfs_sb_off£t
(
mœrÜ
);

972 
zÚe_num
 = 
	`sb_zÚe_numb”
(
zšfo
->
zÚe_size_shiá
, 
mœrÜ
);

973 ià(
zÚe_num
 + 1 >ğ
zšfo
->
Ä_zÚes
)

974  -
ENOENT
;

976  
	`sb_log_loÿtiÚ
(
deviû
->
bdev
,

977 &
zšfo
->
sb_zÚes
[
BTRFS_NR_SB_LOG_ZONES
 * 
mœrÜ
],

978 
rw
, 
by‹Ä_»t
);

979 
	}
}

981 
	$bŒfs_sb_log_loÿtiÚ_·¹™iÚ
(
bŒfs_deviû
 *
deviû
, 
mœrÜ
, 
rw
,

982 
u64
 *
by‹Ä_»t
, u64 
sb_off£t
)

984 
bŒfs_zÚed_deviû_šfo
 *
zšfo
 = 
deviû
->
zÚe_šfo
;

985 
u32
 
zÚe_num
;

993 ià(!
	`bdev_is_zÚed
(
deviû
->
bdev
)) {

994 *
by‹Ä_»t
 = 
	`bŒfs_sb_off£t_·¹™iÚ
(
mœrÜ
, 
sb_off£t
);

998 
zÚe_num
 = 
	`sb_zÚe_numb”
(
zšfo
->
zÚe_size_shiá
, 
mœrÜ
);

999 ià(
zÚe_num
 + 1 >ğ
zšfo
->
Ä_zÚes
)

1000  -
ENOENT
;

1002  
	`sb_log_loÿtiÚ
(
deviû
->
bdev
,

1003 &
zšfo
->
sb_zÚes
[
BTRFS_NR_SB_LOG_ZONES
 * 
mœrÜ
],

1004 
rw
, 
by‹Ä_»t
);

1005 
	}
}

1007 
šlše
 
boŞ
 
	$is_sb_log_zÚe
(
bŒfs_zÚed_deviû_šfo
 *
zšfo
,

1008 
mœrÜ
)

1010 
u32
 
zÚe_num
;

1012 ià(!
zšfo
)

1013  
çl£
;

1015 
zÚe_num
 = 
	`sb_zÚe_numb”
(
zšfo
->
zÚe_size_shiá
, 
mœrÜ
);

1016 ià(
zÚe_num
 + 1 >ğ
zšfo
->
Ä_zÚes
)

1017  
çl£
;

1019 ià(!
	`‹¡_b™
(
zÚe_num
, 
zšfo
->
£q_zÚes
))

1020  
çl£
;

1022  
Œue
;

1023 
	}
}

1025 
	$bŒfs_advªû_sb_log
(
bŒfs_deviû
 *
deviû
, 
mœrÜ
)

1027 
bŒfs_zÚed_deviû_šfo
 *
zšfo
 = 
deviû
->
zÚe_šfo
;

1028 
blk_zÚe
 *
zÚe
;

1029 
i
;

1031 ià(!
	`is_sb_log_zÚe
(
zšfo
, 
mœrÜ
))

1034 
zÚe
 = &
zšfo
->
sb_zÚes
[
BTRFS_NR_SB_LOG_ZONES
 * 
mœrÜ
];

1035 
i
 = 0; i < 
BTRFS_NR_SB_LOG_ZONES
; i++) {

1037 ià(
zÚe
->
cÚd
 =ğ
BLK_ZONE_COND_FULL
) {

1038 
zÚe
++;

1042 ià(
zÚe
->
cÚd
 =ğ
BLK_ZONE_COND_EMPTY
)

1043 
zÚe
->
cÚd
 = 
BLK_ZONE_COND_IMP_OPEN
;

1045 
zÚe
->
wp
 +ğ
SUPER_INFO_SECTORS
;

1047 ià(
	`sb_zÚe_is_fuÎ
(
zÚe
)) {

1056 ià(
zÚe
->
wp
 !ğzÚe->
¡¬t
 + zÚe->
ÿ·c™y
) {

1057 
»t
;

1059 
»t
 = 
	`blkdev_zÚe_mgmt
(
deviû
->
bdev
,

1060 
REQ_OP_ZONE_FINISH
, 
zÚe
->
¡¬t
,

1061 
zÚe
->
Ën
, 
GFP_NOFS
);

1062 ià(
»t
)

1063  
»t
;

1066 
zÚe
->
wp
 = zÚe->
¡¬t
 + zÚe->
Ën
;

1067 
zÚe
->
cÚd
 = 
BLK_ZONE_COND_FULL
;

1073 
	`ASSERT
(0);

1074  -
EIO
;

1075 
	}
}

1077 
	$bŒfs_»£t_sb_log_zÚes
(
block_deviû
 *
bdev
, 
mœrÜ
)

1079 
£ùÜ_t
 
zÚe_£ùÜs
;

1080 
£ùÜ_t
 
Ä_£ùÜs
;

1081 
u8
 
zÚe_£ùÜs_shiá
;

1082 
u32
 
sb_zÚe
;

1083 
u32
 
Ä_zÚes
;

1085 
zÚe_£ùÜs
 = 
	`bdev_zÚe_£ùÜs
(
bdev
);

1086 
zÚe_£ùÜs_shiá
 = 
	`og2
(
zÚe_£ùÜs
);

1087 
Ä_£ùÜs
 = 
	`bdev_Ä_£ùÜs
(
bdev
);

1088 
Ä_zÚes
 = 
Ä_£ùÜs
 >> 
zÚe_£ùÜs_shiá
;

1090 
sb_zÚe
 = 
	`sb_zÚe_numb”
(
zÚe_£ùÜs_shiá
 + 
SECTOR_SHIFT
, 
mœrÜ
);

1091 ià(
sb_zÚe
 + 1 >ğ
Ä_zÚes
)

1092  -
ENOENT
;

1094  
	`blkdev_zÚe_mgmt
(
bdev
, 
REQ_OP_ZONE_RESET
,

1095 
	`zÚe_¡¬t_£ùÜ
(
sb_zÚe
, 
bdev
),

1096 
zÚe_£ùÜs
 * 
BTRFS_NR_SB_LOG_ZONES
, 
GFP_NOFS
);

1097 
	}
}

1110 
u64
 
	$bŒfs_fšd_®loÿbË_zÚes
(
bŒfs_deviû
 *
deviû
, 
u64
 
hŞe_¡¬t
,

1111 
u64
 
hŞe_’d
, u64 
num_by‹s
)

1113 
bŒfs_zÚed_deviû_šfo
 *
zšfo
 = 
deviû
->
zÚe_šfo
;

1114 cÚ¡ 
u8
 
shiá
 = 
zšfo
->
zÚe_size_shiá
;

1115 
u64
 
nzÚes
 = 
num_by‹s
 >> 
shiá
;

1116 
u64
 
pos
 = 
hŞe_¡¬t
;

1117 
u64
 
begš
, 
’d
;

1118 
boŞ
 
have_sb
;

1119 
i
;

1121 
	`ASSERT
(
	`IS_ALIGNED
(
hŞe_¡¬t
, 
zšfo
->
zÚe_size
));

1122 
	`ASSERT
(
	`IS_ALIGNED
(
num_by‹s
, 
zšfo
->
zÚe_size
));

1124 
pos
 < 
hŞe_’d
) {

1125 
begš
 = 
pos
 >> 
shiá
;

1126 
’d
 = 
begš
 + 
nzÚes
;

1128 ià(
’d
 > 
zšfo
->
Ä_zÚes
)

1129  
hŞe_’d
;

1132 ià(
	`bŒfs_dev_is_£qu’tŸl
(
deviû
, 
pos
) &&

1133 !
	`b™m­_‹¡_¿nge_®l_£t
(
zšfo
->
em±y_zÚes
, 
begš
, 
nzÚes
)) {

1134 
pos
 +ğ
zšfo
->
zÚe_size
;

1138 
have_sb
 = 
çl£
;

1139 
i
 = 0; i < 
BTRFS_SUPER_MIRROR_MAX
; i++) {

1140 
u32
 
sb_zÚe
;

1141 
u64
 
sb_pos
;

1143 
sb_zÚe
 = 
	`sb_zÚe_numb”
(
shiá
, 
i
);

1144 ià(!(
’d
 <ğ
sb_zÚe
 ||

1145 
sb_zÚe
 + 
BTRFS_NR_SB_LOG_ZONES
 <ğ
begš
)) {

1146 
have_sb
 = 
Œue
;

1147 
pos
 = 
	`zÚe_¡¬t_physiÿl
(

1148 
sb_zÚe
 + 
BTRFS_NR_SB_LOG_ZONES
, 
zšfo
);

1153 
sb_pos
 = 
	`bŒfs_sb_off£t
(
i
);

1154 ià(!(
pos
 + 
num_by‹s
 <ğ
sb_pos
 ||

1155 
sb_pos
 + 
BTRFS_SUPER_INFO_SIZE
 <ğ
pos
)) {

1156 
have_sb
 = 
Œue
;

1157 
pos
 = 
	`ALIGN
(
sb_pos
 + 
BTRFS_SUPER_INFO_SIZE
,

1158 
zšfo
->
zÚe_size
);

1162 ià(!
have_sb
)

1166  
pos
;

1167 
	}
}

1169 
boŞ
 
	$bŒfs_dev_£t_aùive_zÚe
(
bŒfs_deviû
 *
deviû
, 
u64
 
pos
)

1171 
bŒfs_zÚed_deviû_šfo
 *
zÚe_šfo
 = 
deviû
->zone_info;

1172 
zno
 = (
pos
 >> 
zÚe_šfo
->
zÚe_size_shiá
);

1175 ià(
zÚe_šfo
->
max_aùive_zÚes
 == 0)

1176  
Œue
;

1178 ià(!
	`‹¡_b™
(
zno
, 
zÚe_šfo
->
aùive_zÚes
)) {

1180 ià(
	`©omic_dec_if_pos™ive
(&
zÚe_šfo
->
aùive_zÚes_Ëá
) < 0)

1181  
çl£
;

1182 ià(
	`‹¡_ªd_£t_b™
(
zno
, 
zÚe_šfo
->
aùive_zÚes
)) {

1184 
	`©omic_šc
(&
zÚe_šfo
->
aùive_zÚes_Ëá
);

1188  
Œue
;

1189 
	}
}

1191 
	$bŒfs_dev_ş—r_aùive_zÚe
(
bŒfs_deviû
 *
deviû
, 
u64
 
pos
)

1193 
bŒfs_zÚed_deviû_šfo
 *
zÚe_šfo
 = 
deviû
->zone_info;

1194 
zno
 = (
pos
 >> 
zÚe_šfo
->
zÚe_size_shiá
);

1197 ià(
zÚe_šfo
->
max_aùive_zÚes
 == 0)

1200 ià(
	`‹¡_ªd_ş—r_b™
(
zno
, 
zÚe_šfo
->
aùive_zÚes
))

1201 
	`©omic_šc
(&
zÚe_šfo
->
aùive_zÚes_Ëá
);

1202 
	}
}

1204 
	$bŒfs_»£t_deviû_zÚe
(
bŒfs_deviû
 *
deviû
, 
u64
 
physiÿl
,

1205 
u64
 
Ëngth
, u64 *
by‹s
)

1207 
»t
;

1209 *
by‹s
 = 0;

1210 
»t
 = 
	`blkdev_zÚe_mgmt
(
deviû
->
bdev
, 
REQ_OP_ZONE_RESET
,

1211 
physiÿl
 >> 
SECTOR_SHIFT
, 
Ëngth
 >> SECTOR_SHIFT,

1212 
GFP_NOFS
);

1213 ià(
»t
)

1214  
»t
;

1216 *
by‹s
 = 
Ëngth
;

1217 
Ëngth
) {

1218 
	`bŒfs_dev_£t_zÚe_em±y
(
deviû
, 
physiÿl
);

1219 
	`bŒfs_dev_ş—r_aùive_zÚe
(
deviû
, 
physiÿl
);

1220 
physiÿl
 +ğ
deviû
->
zÚe_šfo
->
zÚe_size
;

1221 
Ëngth
 -ğ
deviû
->
zÚe_šfo
->
zÚe_size
;

1225 
	}
}

1227 
	$bŒfs_’su»_em±y_zÚes
(
bŒfs_deviû
 *
deviû
, 
u64
 
¡¬t
, u64 
size
)

1229 
bŒfs_zÚed_deviû_šfo
 *
zšfo
 = 
deviû
->
zÚe_šfo
;

1230 cÚ¡ 
u8
 
shiá
 = 
zšfo
->
zÚe_size_shiá
;

1231 
begš
 = 
¡¬t
 >> 
shiá
;

1232 
nb™s
 = 
size
 >> 
shiá
;

1233 
u64
 
pos
;

1234 
»t
;

1236 
	`ASSERT
(
	`IS_ALIGNED
(
¡¬t
, 
zšfo
->
zÚe_size
));

1237 
	`ASSERT
(
	`IS_ALIGNED
(
size
, 
zšfo
->
zÚe_size
));

1239 ià(
begš
 + 
nb™s
 > 
zšfo
->
Ä_zÚes
)

1240  -
ERANGE
;

1243 ià(
	`b™m­_‹¡_¿nge_®l_z”o
(
zšfo
->
£q_zÚes
, 
begš
, 
nb™s
))

1247 ià(
	`b™m­_‹¡_¿nge_®l_£t
(
zšfo
->
£q_zÚes
, 
begš
, 
nb™s
) &&

1248 
	`b™m­_‹¡_¿nge_®l_£t
(
zšfo
->
em±y_zÚes
, 
begš
, 
nb™s
))

1251 
pos
 = 
¡¬t
;…o < s¹ + 
size
;…o +ğ
zšfo
->
zÚe_size
) {

1252 
u64
 
»£t_by‹s
;

1254 ià(!
	`bŒfs_dev_is_£qu’tŸl
(
deviû
, 
pos
) ||

1255 
	`bŒfs_dev_is_em±y_zÚe
(
deviû
, 
pos
))

1259 
	`bŒfs_w¬n_š_rcu
(

1260 
deviû
->
fs_šfo
,

1262 
	`rcu_¡r_d”ef
(
deviû
->
Çme
), deviû->
devid
, 
pos
 >> 
shiá
);

1263 
	`WARN_ON_ONCE
(1);

1265 
»t
 = 
	`bŒfs_»£t_deviû_zÚe
(
deviû
, 
pos
, 
zšfo
->
zÚe_size
,

1266 &
»£t_by‹s
);

1267 ià(
»t
)

1268  
»t
;

1272 
	}
}

1280 
	$ÿlcuÏ‹_®loc_poš‹r
(
bŒfs_block_group
 *
ÿche
,

1281 
u64
 *
off£t_»t
, 
boŞ
 
Ãw
)

1283 
bŒfs_fs_šfo
 *
fs_šfo
 = 
ÿche
->fs_info;

1284 
bŒfs_roÙ
 *
roÙ
;

1285 
bŒfs_·th
 *
·th
;

1286 
bŒfs_key
 
key
;

1287 
bŒfs_key
 
found_key
;

1288 
»t
;

1289 
u64
 
Ëngth
;

1301 ià(
Ãw
) {

1302 *
off£t_»t
 = 0;

1306 
·th
 = 
	`bŒfs_®loc_·th
();

1307 ià(!
·th
)

1308  -
ENOMEM
;

1310 
key
.
objeùid
 = 
ÿche
->
¡¬t
 + cache->
Ëngth
;

1311 
key
.
ty³
 = 0;

1312 
key
.
off£t
 = 0;

1314 
roÙ
 = 
	`bŒfs_ex‹Á_roÙ
(
fs_šfo
, 
key
.
objeùid
);

1315 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

1317 ià(!
»t
)

1318 
»t
 = -
EUCLEAN
;

1319 ià(
»t
 < 0)

1320 
out
;

1322 
»t
 = 
	`bŒfs_´evious_ex‹Á_™em
(
roÙ
, 
·th
, 
ÿche
->
¡¬t
);

1323 ià(
»t
) {

1324 ià(
»t
 == 1) {

1325 
»t
 = 0;

1326 *
off£t_»t
 = 0;

1328 
out
;

1331 
	`bŒfs_™em_key_to_ıu
(
·th
->
nodes
[0], &
found_key
,…©h->
¦Ùs
[0]);

1333 ià(
found_key
.
ty³
 =ğ
BTRFS_EXTENT_ITEM_KEY
)

1334 
Ëngth
 = 
found_key
.
off£t
;

1336 
Ëngth
 = 
fs_šfo
->
nodesize
;

1338 ià(!(
found_key
.
objeùid
 >ğ
ÿche
->
¡¬t
 &&

1339 
found_key
.
objeùid
 + 
Ëngth
 <ğ
ÿche
->
¡¬t
 + cache->length)) {

1340 
»t
 = -
EUCLEAN
;

1341 
out
;

1343 *
off£t_»t
 = 
found_key
.
objeùid
 + 
Ëngth
 - 
ÿche
->
¡¬t
;

1344 
»t
 = 0;

1346 
out
:

1347 
	`bŒfs_ä“_·th
(
·th
);

1348  
»t
;

1349 
	}
}

1351 
	$bŒfs_lßd_block_group_zÚe_šfo
(
bŒfs_block_group
 *
ÿche
, 
boŞ
 
Ãw
)

1353 
bŒfs_fs_šfo
 *
fs_šfo
 = 
ÿche
->fs_info;

1354 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

1355 
ex‹Á_m­
 *
em
;

1356 
m­_lookup
 *
m­
;

1357 
bŒfs_deviû
 *
deviû
;

1358 
u64
 
logiÿl
 = 
ÿche
->
¡¬t
;

1359 
u64
 
Ëngth
 = 
ÿche
->length;

1360 
»t
;

1361 
i
;

1362 
nofs_æag
;

1363 
u64
 *
®loc_off£ts
 = 
NULL
;

1364 
u64
 *
ÿps
 = 
NULL
;

1365 
u64
 *
physiÿl
 = 
NULL
;

1366 *
aùive
 = 
NULL
;

1367 
u64
 
Ï¡_®loc
 = 0;

1368 
u32
 
num_£qu’tŸl
 = 0, 
num_cÚv’tiÚ®
 = 0;

1370 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

1374 ià(!
	`IS_ALIGNED
(
Ëngth
, 
fs_šfo
->
zÚe_size
)) {

1375 
	`bŒfs_”r
(
fs_šfo
,

1377 
logiÿl
, 
Ëngth
, 
fs_šfo
->
zÚe_size
);

1378  -
EIO
;

1382 
	`»ad_lock
(&
em_Œ“
->
lock
);

1383 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
logiÿl
, 
Ëngth
);

1384 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

1386 ià(!
em
)

1387  -
EINVAL
;

1389 
m­
 = 
em
->
m­_lookup
;

1391 
ÿche
->
physiÿl_m­
 = 
	`kmemdup
(
m­
, 
	`m­_lookup_size
(m­->
num_¡res
), 
GFP_NOFS
);

1392 ià(!
ÿche
->
physiÿl_m­
) {

1393 
»t
 = -
ENOMEM
;

1394 
out
;

1397 
®loc_off£ts
 = 
	`kÿÎoc
(
m­
->
num_¡res
, (*®loc_off£ts), 
GFP_NOFS
);

1398 ià(!
®loc_off£ts
) {

1399 
»t
 = -
ENOMEM
;

1400 
out
;

1403 
ÿps
 = 
	`kÿÎoc
(
m­
->
num_¡res
, (*ÿps), 
GFP_NOFS
);

1404 ià(!
ÿps
) {

1405 
»t
 = -
ENOMEM
;

1406 
out
;

1409 
physiÿl
 = 
	`kÿÎoc
(
m­
->
num_¡res
, (*physiÿl), 
GFP_NOFS
);

1410 ià(!
physiÿl
) {

1411 
»t
 = -
ENOMEM
;

1412 
out
;

1415 
aùive
 = 
	`b™m­_z®loc
(
m­
->
num_¡res
, 
GFP_NOFS
);

1416 ià(!
aùive
) {

1417 
»t
 = -
ENOMEM
;

1418 
out
;

1421 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

1422 
boŞ
 
is_£qu’tŸl
;

1423 
blk_zÚe
 
zÚe
;

1424 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

1425 
dev_»¶aû_is_Úgošg
 = 0;

1427 
deviû
 = 
m­
->
¡res
[
i
].
dev
;

1428 
physiÿl
[
i
] = 
m­
->
¡res
[i].physical;

1430 ià(
deviû
->
bdev
 =ğ
NULL
) {

1431 
®loc_off£ts
[
i
] = 
WP_MISSING_DEV
;

1435 
is_£qu’tŸl
 = 
	`bŒfs_dev_is_£qu’tŸl
(
deviû
, 
physiÿl
[
i
]);

1436 ià(
is_£qu’tŸl
)

1437 
num_£qu’tŸl
++;

1439 
num_cÚv’tiÚ®
++;

1445 ià(!
deviû
->
zÚe_šfo
->
max_aùive_zÚes
)

1446 
	`__£t_b™
(
i
, 
aùive
);

1448 ià(!
is_£qu’tŸl
) {

1449 
®loc_off£ts
[
i
] = 
WP_CONVENTIONAL
;

1457 
	`bŒfs_dev_ş—r_zÚe_em±y
(
deviû
, 
physiÿl
[
i
]);

1459 
	`down_»ad
(&
dev_»¶aû
->
rw£m
);

1460 
dev_»¶aû_is_Úgošg
 = 
	`bŒfs_dev_»¶aû_is_Úgošg
(
dev_»¶aû
);

1461 ià(
dev_»¶aû_is_Úgošg
 && 
dev_»¶aû
->
tgtdev
 !ğ
NULL
)

1462 
	`bŒfs_dev_ş—r_zÚe_em±y
(
dev_»¶aû
->
tgtdev
, 
physiÿl
[
i
]);

1463 
	`up_»ad
(&
dev_»¶aû
->
rw£m
);

1469 
	`WARN_ON
(!
	`IS_ALIGNED
(
physiÿl
[
i
], 
fs_šfo
->
zÚe_size
));

1470 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

1471 
»t
 = 
	`bŒfs_g‘_dev_zÚe
(
deviû
, 
physiÿl
[
i
], &
zÚe
);

1472 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

1473 ià(
»t
 =ğ-
EIO
 ||„‘ =ğ-
EOPNOTSUPP
) {

1474 
»t
 = 0;

1475 
®loc_off£ts
[
i
] = 
WP_MISSING_DEV
;

1477 } ià(
»t
) {

1478 
out
;

1481 ià(
zÚe
.
ty³
 =ğ
BLK_ZONE_TYPE_CONVENTIONAL
) {

1482 
	`bŒfs_”r_š_rcu
(
fs_šfo
,

1484 
zÚe
.
¡¬t
 << 
SECTOR_SHIFT
,

1485 
	`rcu_¡r_d”ef
(
deviû
->
Çme
), deviû->
devid
);

1486 
»t
 = -
EIO
;

1487 
out
;

1490 
ÿps
[
i
] = (
zÚe
.
ÿ·c™y
 << 
SECTOR_SHIFT
);

1492 
zÚe
.
cÚd
) {

1493 
BLK_ZONE_COND_OFFLINE
:

1494 
BLK_ZONE_COND_READONLY
:

1495 
	`bŒfs_”r
(
fs_šfo
,

1497 
physiÿl
[
i
] >> 
deviû
->
zÚe_šfo
->
zÚe_size_shiá
,

1498 
	`rcu_¡r_d”ef
(
deviû
->
Çme
), deviû->
devid
);

1499 
®loc_off£ts
[
i
] = 
WP_MISSING_DEV
;

1501 
BLK_ZONE_COND_EMPTY
:

1502 
®loc_off£ts
[
i
] = 0;

1504 
BLK_ZONE_COND_FULL
:

1505 
®loc_off£ts
[
i
] = 
ÿps
[i];

1509 
®loc_off£ts
[
i
] =

1510 ((
zÚe
.
wp
 - zÚe.
¡¬t
è<< 
SECTOR_SHIFT
);

1511 
	`__£t_b™
(
i
, 
aùive
);

1516 ià(
num_£qu’tŸl
 > 0)

1517 
	`£t_b™
(
BLOCK_GROUP_FLAG_SEQUENTIAL_ZONE
, &
ÿche
->
ruÁime_æags
);

1519 ià(
num_cÚv’tiÚ®
 > 0) {

1521 
ÿche
->
zÚe_ÿ·c™y
 = cache->
Ëngth
;

1522 
»t
 = 
	`ÿlcuÏ‹_®loc_poš‹r
(
ÿche
, &
Ï¡_®loc
, 
Ãw
);

1523 ià(
»t
) {

1524 
	`bŒfs_”r
(
fs_šfo
,

1526 
ÿche
->
¡¬t
);

1527 
out
;

1528 } ià(
m­
->
num_¡res
 =ğ
num_cÚv’tiÚ®
) {

1529 
ÿche
->
®loc_off£t
 = 
Ï¡_®loc
;

1530 
	`£t_b™
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
, &
ÿche
->
ruÁime_æags
);

1531 
out
;

1535 
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) {

1537 ià(
®loc_off£ts
[0] =ğ
WP_MISSING_DEV
) {

1538 
	`bŒfs_”r
(
fs_šfo
,

1540 
physiÿl
[0]);

1541 
»t
 = -
EIO
;

1542 
out
;

1544 
ÿche
->
®loc_off£t
 = 
®loc_off£ts
[0];

1545 
ÿche
->
zÚe_ÿ·c™y
 = 
ÿps
[0];

1546 ià(
	`‹¡_b™
(0, 
aùive
))

1547 
	`£t_b™
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
, &
ÿche
->
ruÁime_æags
);

1549 
BTRFS_BLOCK_GROUP_DUP
:

1550 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_DATA
) {

1551 
	`bŒfs_”r
(
fs_šfo
, "zoned:…rofile DUP‚ot yet supported on data bg");

1552 
»t
 = -
EINVAL
;

1553 
out
;

1555 ià(
®loc_off£ts
[0] =ğ
WP_MISSING_DEV
) {

1556 
	`bŒfs_”r
(
fs_šfo
,

1558 
physiÿl
[0]);

1559 
»t
 = -
EIO
;

1560 
out
;

1562 ià(
®loc_off£ts
[1] =ğ
WP_MISSING_DEV
) {

1563 
	`bŒfs_”r
(
fs_šfo
,

1565 
physiÿl
[1]);

1566 
»t
 = -
EIO
;

1567 
out
;

1569 ià(
®loc_off£ts
[0] !=‡lloc_offsets[1]) {

1570 
	`bŒfs_”r
(
fs_šfo
,

1572 
»t
 = -
EIO
;

1573 
out
;

1575 ià(
	`‹¡_b™
(0, 
aùive
) !=est_bit(1,‡ctive)) {

1576 ià(!
	`bŒfs_zÚe_aùiv©e
(
ÿche
)) {

1577 
»t
 = -
EIO
;

1578 
out
;

1581 ià(
	`‹¡_b™
(0, 
aùive
))

1582 
	`£t_b™
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
,

1583 &
ÿche
->
ruÁime_æags
);

1585 
ÿche
->
®loc_off£t
 = 
®loc_off£ts
[0];

1586 
ÿche
->
zÚe_ÿ·c™y
 = 
	`mš
(
ÿps
[0], caps[1]);

1588 
BTRFS_BLOCK_GROUP_RAID1
:

1589 
BTRFS_BLOCK_GROUP_RAID0
:

1590 
BTRFS_BLOCK_GROUP_RAID10
:

1591 
BTRFS_BLOCK_GROUP_RAID5
:

1592 
BTRFS_BLOCK_GROUP_RAID6
:

1595 
	`bŒfs_”r
(
fs_šfo
, "zoned:…rofile %s‚ot yet supported",

1596 
	`bŒfs_bg_ty³_to_¿id_Çme
(
m­
->
ty³
));

1597 
»t
 = -
EINVAL
;

1598 
out
;

1601 
out
:

1602 ià(
ÿche
->
®loc_off£t
 > 
fs_šfo
->
zÚe_size
) {

1603 
	`bŒfs_”r
(
fs_šfo
,

1605 
ÿche
->
®loc_off£t
, cache->
¡¬t
);

1606 
»t
 = -
EIO
;

1609 ià(
ÿche
->
®loc_off£t
 > cache->
zÚe_ÿ·c™y
) {

1610 
	`bŒfs_”r
(
fs_šfo
,

1612 
ÿche
->
®loc_off£t
, cache->
zÚe_ÿ·c™y
,

1613 
ÿche
->
¡¬t
);

1614 
»t
 = -
EIO
;

1618 ià(!
»t
 && 
num_cÚv’tiÚ®
 && 
Ï¡_®loc
 > 
ÿche
->
®loc_off£t
) {

1619 
	`bŒfs_”r
(
fs_šfo
,

1621 
logiÿl
, 
Ï¡_®loc
, 
ÿche
->
®loc_off£t
);

1622 
»t
 = -
EIO
;

1625 ià(!
»t
) {

1626 
ÿche
->
m‘a_wr™e_poš‹r
 = cache->
®loc_off£t
 + cache->
¡¬t
;

1627 ià(
	`‹¡_b™
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
, &
ÿche
->
ruÁime_æags
)) {

1628 
	`bŒfs_g‘_block_group
(
ÿche
);

1629 
	`¥š_lock
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

1630 
	`li¡_add_
(&
ÿche
->
aùive_bg_li¡
,

1631 &
fs_šfo
->
zÚe_aùive_bgs
);

1632 
	`¥š_uÆock
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

1635 
	`kä“
(
ÿche
->
physiÿl_m­
);

1636 
ÿche
->
physiÿl_m­
 = 
NULL
;

1638 
	`b™m­_ä“
(
aùive
);

1639 
	`kä“
(
physiÿl
);

1640 
	`kä“
(
ÿps
);

1641 
	`kä“
(
®loc_off£ts
);

1642 
	`ä“_ex‹Á_m­
(
em
);

1644  
»t
;

1645 
	}
}

1647 
	$bŒfs_ÿlc_zÚe_unu§bË
(
bŒfs_block_group
 *
ÿche
)

1649 
u64
 
unu§bË
, 
ä“
;

1651 ià(!
	`bŒfs_is_zÚed
(
ÿche
->
fs_šfo
))

1654 
	`WARN_ON
(
ÿche
->
by‹s_su³r
 != 0);

1655 
unu§bË
 = (
ÿche
->
®loc_off£t
 - cache->
u£d
) +

1656 (
ÿche
->
Ëngth
 - cache->
zÚe_ÿ·c™y
);

1657 
ä“
 = 
ÿche
->
zÚe_ÿ·c™y
 - cache->
®loc_off£t
;

1660 
ÿche
->
ÿched
 = 
BTRFS_CACHE_FINISHED
;

1661 
ÿche
->
ä“_¥aû_ùl
->
ä“_¥aû
 = 
ä“
;

1662 
ÿche
->
zÚe_unu§bË
 = 
unu§bË
;

1663 
	}
}

1665 
	$bŒfs_»dœty_li¡_add
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

1666 
ex‹Á_bufãr
 *
eb
)

1668 ià(!
	`bŒfs_is_zÚed
(
eb
->
fs_šfo
) ||

1669 
	`bŒfs_h—d”_æag
(
eb
, 
BTRFS_HEADER_FLAG_WRITTEN
))

1672 
	`ASSERT
(!
	`‹¡_b™
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bæags
));

1674 
	`memz”o_ex‹Á_bufãr
(
eb
, 0,ƒb->
Ën
);

1675 
	`£t_b™
(
EXTENT_BUFFER_NO_CHECK
, &
eb
->
bæags
);

1676 
	`£t_ex‹Á_bufãr_dœty
(
eb
);

1677 
	`£t_ex‹Á_b™
(&
Œªs
->
dœty_·ges
, 
eb
->
¡¬t
,ƒb->¡¬ˆ+ƒb->
Ën
 - 1,

1678 
EXTENT_DIRTY
 | 
EXTENT_NOWAIT
, 
NULL
);

1679 
	}
}

1681 
boŞ
 
	$bŒfs_u£_zÚe_­³nd
(
bŒfs_bio
 *
bbio
)

1683 
u64
 
¡¬t
 = (
bbio
->
bio
.
bi_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
);

1684 
bŒfs_šode
 *
šode
 = 
bbio
->inode;

1685 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bbio
->fs_info;

1686 
bŒfs_block_group
 *
ÿche
;

1687 
boŞ
 
»t
 = 
çl£
;

1689 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

1690  
çl£
;

1692 ià(!
šode
 || !
	`is_d©a_šode
(&šode->
vfs_šode
))

1693  
çl£
;

1695 ià(
	`bŒfs_İ
(&
bbio
->
bio
è!ğ
BTRFS_MAP_WRITE
)

1696  
çl£
;

1706 ià(
	`bŒfs_is_d©a_»loc_roÙ
(
šode
->
roÙ
))

1707  
çl£
;

1709 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
¡¬t
);

1710 
	`ASSERT
(
ÿche
);

1711 ià(!
ÿche
)

1712  
çl£
;

1714 
»t
 = !!
	`‹¡_b™
(
BLOCK_GROUP_FLAG_SEQUENTIAL_ZONE
, &
ÿche
->
ruÁime_æags
);

1715 
	`bŒfs_put_block_group
(
ÿche
);

1717  
»t
;

1718 
	}
}

1720 
	$bŒfs_»cÜd_physiÿl_zÚed
(
bŒfs_bio
 *
bbio
)

1722 cÚ¡ 
u64
 
physiÿl
 = 
bbio
->
bio
.
bi_™”
.
bi_£ùÜ
 << 
SECTOR_SHIFT
;

1723 
bŒfs_Üd”ed_sum
 *
sum
 = 
bbio
->
sums
;

1725 ià(
physiÿl
 < 
bbio
->
Üig_physiÿl
)

1726 
sum
->
logiÿl
 -ğ
bbio
->
Üig_physiÿl
 - 
physiÿl
;

1728 
sum
->
logiÿl
 +ğ
physiÿl
 - 
bbio
->
Üig_physiÿl
;

1729 
	}
}

1731 
	$bŒfs_»wr™e_logiÿl_zÚed
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
,

1732 
u64
 
logiÿl
)

1734 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
	`BTRFS_I
(
Üd”ed
->
šode
)->
ex‹Á_Œ“
;

1735 
ex‹Á_m­
 *
em
;

1737 
Üd”ed
->
disk_by‹Ä
 = 
logiÿl
;

1739 
	`wr™e_lock
(&
em_Œ“
->
lock
);

1740 
em
 = 
	`£¬ch_ex‹Á_m­pšg
(
em_Œ“
, 
Üd”ed
->
fe_off£t
,

1741 
Üd”ed
->
num_by‹s
);

1742 
em
->
block_¡¬t
 = 
logiÿl
;

1743 
	`ä“_ex‹Á_m­
(
em
);

1744 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

1745 
	}
}

1747 
boŞ
 
	$bŒfs_zÚed_¥l™_Üd”ed
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
,

1748 
u64
 
logiÿl
, u64 
Ën
)

1750 
bŒfs_Üd”ed_ex‹Á
 *
Ãw
;

1752 ià(!
	`‹¡_b™
(
BTRFS_ORDERED_NOCOW
, &
Üd”ed
->
æags
) &&

1753 
	`¥l™_ex‹Á_m­
(
	`BTRFS_I
(
Üd”ed
->
šode
), ord”ed->
fe_off£t
,

1754 
Üd”ed
->
num_by‹s
, 
Ën
, 
logiÿl
))

1755  
çl£
;

1757 
Ãw
 = 
	`bŒfs_¥l™_Üd”ed_ex‹Á
(
Üd”ed
, 
Ën
);

1758 ià(
	`IS_ERR
(
Ãw
))

1759  
çl£
;

1760 
Ãw
->
disk_by‹Ä
 = 
logiÿl
;

1761 
	`bŒfs_fšish_Úe_Üd”ed
(
Ãw
);

1762  
Œue
;

1763 
	}
}

1765 
	$bŒfs_fšish_Üd”ed_zÚed
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
)

1767 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
(
Üd”ed
->inode);

1768 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

1769 
bŒfs_Üd”ed_sum
 *
sum
;

1770 
u64
 
logiÿl
, 
Ën
;

1776 ià(
	`‹¡_b™
(
BTRFS_ORDERED_PREALLOC
, &
Üd”ed
->
æags
))

1779 
	`ASSERT
(!
	`li¡_em±y
(&
Üd”ed
->
li¡
));

1781 
sum
 = 
	`li¡_fœ¡_’Œy
(&
Üd”ed
->
li¡
, 
bŒfs_Üd”ed_sum
,†ist);

1782 
logiÿl
 = 
sum
->logical;

1783 
Ën
 = 
sum
->len;

1785 
Ën
 < 
Üd”ed
->
disk_num_by‹s
) {

1786 
sum
 = 
	`li¡_Ãxt_’Œy
(sum, 
li¡
);

1787 ià(
sum
->
logiÿl
 =ğlogiÿÈ+ 
Ën
) {

1788 
Ën
 +ğ
sum
->len;

1791 ià(!
	`bŒfs_zÚed_¥l™_Üd”ed
(
Üd”ed
, 
logiÿl
, 
Ën
)) {

1792 
	`£t_b™
(
BTRFS_ORDERED_IOERR
, &
Üd”ed
->
æags
);

1793 
	`bŒfs_”r
(
fs_šfo
, "failedo split orderedƒxtent");

1794 
out
;

1796 
logiÿl
 = 
sum
->logical;

1797 
Ën
 = 
sum
->len;

1800 ià(
Üd”ed
->
disk_by‹Ä
 !ğ
logiÿl
)

1801 
	`bŒfs_»wr™e_logiÿl_zÚed
(
Üd”ed
, 
logiÿl
);

1803 
out
:

1810 ià((
šode
->
æags
 & 
BTRFS_INODE_NODATASUM
) ||

1811 
	`‹¡_b™
(
BTRFS_FS_STATE_NO_CSUMS
, &
fs_šfo
->
fs_¡©e
)) {

1812 (
sum
 = 
	`li¡_fœ¡_’Œy_Ü_nuÎ
(&
Üd”ed
->
li¡
,

1813 
	`ty³of
(*
sum
), 
li¡
))) {

1814 
	`li¡_d–
(&
sum
->
li¡
);

1815 
	`kä“
(
sum
);

1818 
	}
}

1820 
boŞ
 
	$check_bg_is_aùive
(
bŒfs_eb_wr™e_cÚ‹xt
 *
ùx
,

1821 
bŒfs_block_group
 **
aùive_bg
)

1823 cÚ¡ 
wr™eback_cÚŒŞ
 *
wbc
 = 
ùx
->wbc;

1824 
bŒfs_block_group
 *
block_group
 = 
ùx
->
zÚed_bg
;

1825 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

1827 ià(
	`‹¡_b™
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
, &
block_group
->
ruÁime_æags
))

1828  
Œue
;

1830 ià(
fs_šfo
->
Œ“log_bg
 =ğ
block_group
->
¡¬t
) {

1831 ià(!
	`bŒfs_zÚe_aùiv©e
(
block_group
)) {

1832 
»t_fš
 = 
	`bŒfs_zÚe_fšish_Úe_bg
(
fs_šfo
);

1834 ià(
»t_fš
 !ğ1 || !
	`bŒfs_zÚe_aùiv©e
(
block_group
))

1835  
çl£
;

1837 } ià(*
aùive_bg
 !ğ
block_group
) {

1838 
bŒfs_block_group
 *
tgt
 = *
aùive_bg
;

1841 
	`lockd•_as£¹_h–d
(&
fs_šfo
->
zÚed_m‘a_io_lock
);

1843 ià(
tgt
) {

1848 ià(
tgt
->
m‘a_wr™e_poš‹r
 <gt->
¡¬t
 +gt->
®loc_off£t
) {

1849 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
 ||

1850 (
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
 && !wbc->
fÜ_sync
))

1851  
çl£
;

1855 
	`bŒfs_zÚed_m‘a_io_uÆock
(
fs_šfo
);

1856 
	`wa™_eb_wr™ebacks
(
tgt
);

1857 
	`do_zÚe_fšish
(
tgt
, 
Œue
);

1858 
	`bŒfs_zÚed_m‘a_io_lock
(
fs_šfo
);

1859 ià(*
aùive_bg
 =ğ
tgt
) {

1860 
	`bŒfs_put_block_group
(
tgt
);

1861 *
aùive_bg
 = 
NULL
;

1864 ià(!
	`bŒfs_zÚe_aùiv©e
(
block_group
))

1865  
çl£
;

1866 ià(*
aùive_bg
 !ğ
block_group
) {

1867 
	`ASSERT
(*
aùive_bg
 =ğ
NULL
);

1868 *
aùive_bg
 = 
block_group
;

1869 
	`bŒfs_g‘_block_group
(
block_group
);

1873  
Œue
;

1874 
	}
}

1884 
	$bŒfs_check_m‘a_wr™e_poš‹r
(
bŒfs_fs_šfo
 *
fs_šfo
,

1885 
bŒfs_eb_wr™e_cÚ‹xt
 *
ùx
)

1887 cÚ¡ 
wr™eback_cÚŒŞ
 *
wbc
 = 
ùx
->wbc;

1888 cÚ¡ 
ex‹Á_bufãr
 *
eb
 = 
ùx
->eb;

1889 
bŒfs_block_group
 *
block_group
 = 
ùx
->
zÚed_bg
;

1891 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

1894 ià(
block_group
) {

1895 ià(
block_group
->
¡¬t
 > 
eb
->start ||

1896 
block_group
->
¡¬t
 + block_group->
Ëngth
 <ğ
eb
->start) {

1897 
	`bŒfs_put_block_group
(
block_group
);

1898 
block_group
 = 
NULL
;

1899 
ùx
->
zÚed_bg
 = 
NULL
;

1903 ià(!
block_group
) {

1904 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
eb
->
¡¬t
);

1905 ià(!
block_group
)

1907 
ùx
->
zÚed_bg
 = 
block_group
;

1910 ià(
block_group
->
m‘a_wr™e_poš‹r
 =ğ
eb
->
¡¬t
) {

1911 
bŒfs_block_group
 **
tgt
;

1913 ià(!
	`‹¡_b™
(
BTRFS_FS_ACTIVE_ZONE_TRACKING
, &
fs_šfo
->
æags
))

1916 ià(
block_group
->
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

1917 
tgt
 = &
fs_šfo
->
aùive_sy¡em_bg
;

1919 
tgt
 = &
fs_šfo
->
aùive_m‘a_bg
;

1920 ià(
	`check_bg_is_aùive
(
ùx
, 
tgt
))

1928 ià(
block_group
->
m‘a_wr™e_poš‹r
 > 
eb
->
¡¬t
)

1929  -
EBUSY
;

1932 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
 && !wbc->
fÜ_sync
)

1933  -
EAGAIN
;

1934  -
EBUSY
;

1935 
	}
}

1937 
	$bŒfs_zÚed_issue_z”oout
(
bŒfs_deviû
 *
deviû
, 
u64
 
physiÿl
, u64 
Ëngth
)

1939 ià(!
	`bŒfs_dev_is_£qu’tŸl
(
deviû
, 
physiÿl
))

1940  -
EOPNOTSUPP
;

1942  
	`blkdev_issue_z”oout
(
deviû
->
bdev
, 
physiÿl
 >> 
SECTOR_SHIFT
,

1943 
Ëngth
 >> 
SECTOR_SHIFT
, 
GFP_NOFS
, 0);

1944 
	}
}

1946 
	$»ad_zÚe_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
,

1947 
blk_zÚe
 *
zÚe
)

1949 
bŒfs_io_cÚ‹xt
 *
bioc
 = 
NULL
;

1950 
u64
 
m­³d_Ëngth
 = 
PAGE_SIZE
;

1951 
nofs_æag
;

1952 
nmœrÜs
;

1953 
i
, 
»t
;

1955 
»t
 = 
	`bŒfs_m­_block
(
fs_šfo
, 
BTRFS_MAP_GET_READ_MIRRORS
, 
logiÿl
,

1956 &
m­³d_Ëngth
, &
bioc
, 
NULL
, NULL, 1);

1957 ià(
»t
 || !
bioc
 || 
m­³d_Ëngth
 < 
PAGE_SIZE
) {

1958 
»t
 = -
EIO
;

1959 
out_put_bioc
;

1962 ià(
bioc
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

1963 
»t
 = -
EINVAL
;

1964 
out_put_bioc
;

1967 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

1968 
nmœrÜs
 = ()
bioc
->
num_¡res
;

1969 
i
 = 0; i < 
nmœrÜs
; i++) {

1970 
u64
 
physiÿl
 = 
bioc
->
¡res
[
i
].physical;

1971 
bŒfs_deviû
 *
dev
 = 
bioc
->
¡res
[
i
].dev;

1974 ià(!
dev
->
bdev
)

1977 
»t
 = 
	`bŒfs_g‘_dev_zÚe
(
dev
, 
physiÿl
, 
zÚe
);

1979 ià(
»t
 =ğ-
EIO
 ||„‘ =ğ-
EOPNOTSUPP
)

1983 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

1984 
out_put_bioc
:

1985 
	`bŒfs_put_bioc
(
bioc
);

1986  
»t
;

1987 
	}
}

1994 
	$bŒfs_sync_zÚe_wr™e_poš‹r
(
bŒfs_deviû
 *
tgt_dev
, 
u64
 
logiÿl
,

1995 
u64
 
physiÿl_¡¬t
, u64 
physiÿl_pos
)

1997 
bŒfs_fs_šfo
 *
fs_šfo
 = 
tgt_dev
->fs_info;

1998 
blk_zÚe
 
zÚe
;

1999 
u64
 
Ëngth
;

2000 
u64
 
wp
;

2001 
»t
;

2003 ià(!
	`bŒfs_dev_is_£qu’tŸl
(
tgt_dev
, 
physiÿl_pos
))

2006 
»t
 = 
	`»ad_zÚe_šfo
(
fs_šfo
, 
logiÿl
, &
zÚe
);

2007 ià(
»t
)

2008  
»t
;

2010 
wp
 = 
physiÿl_¡¬t
 + ((
zÚe
.w°- zÚe.
¡¬t
è<< 
SECTOR_SHIFT
);

2012 ià(
physiÿl_pos
 =ğ
wp
)

2015 ià(
physiÿl_pos
 > 
wp
)

2016  -
EUCLEAN
;

2018 
Ëngth
 = 
wp
 - 
physiÿl_pos
;

2019  
	`bŒfs_zÚed_issue_z”oout
(
tgt_dev
, 
physiÿl_pos
, 
Ëngth
);

2020 
	}
}

2029 
boŞ
 
	$bŒfs_zÚe_aùiv©e
(
bŒfs_block_group
 *
block_group
)

2031 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

2032 
m­_lookup
 *
m­
;

2033 
bŒfs_deviû
 *
deviû
;

2034 
u64
 
physiÿl
;

2035 cÚ¡ 
boŞ
 
is_d©a
 = (
block_group
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
);

2036 
boŞ
 
»t
;

2037 
i
;

2039 ià(!
	`bŒfs_is_zÚed
(
block_group
->
fs_šfo
))

2040  
Œue
;

2042 
m­
 = 
block_group
->
physiÿl_m­
;

2044 
	`¥š_lock
(&
block_group
->
lock
);

2045 ià(
	`‹¡_b™
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
, &
block_group
->
ruÁime_æags
)) {

2046 
»t
 = 
Œue
;

2047 
out_uÆock
;

2051 ià(
	`bŒfs_zÚed_bg_is_fuÎ
(
block_group
)) {

2052 
»t
 = 
çl£
;

2053 
out_uÆock
;

2056 
	`¥š_lock
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

2057 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

2058 
bŒfs_zÚed_deviû_šfo
 *
zšfo
;

2059 
»£rved
 = 0;

2061 
deviû
 = 
m­
->
¡res
[
i
].
dev
;

2062 
physiÿl
 = 
m­
->
¡res
[
i
].physical;

2063 
zšfo
 = 
deviû
->
zÚe_šfo
;

2065 ià(
zšfo
->
max_aùive_zÚes
 == 0)

2068 ià(
is_d©a
)

2069 
»£rved
 = 
zšfo
->
»£rved_aùive_zÚes
;

2074 ià(
	`©omic_»ad
(&
zšfo
->
aùive_zÚes_Ëá
è<ğ
»£rved
) {

2075 
»t
 = 
çl£
;

2076 
	`¥š_uÆock
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

2077 
out_uÆock
;

2080 ià(!
	`bŒfs_dev_£t_aùive_zÚe
(
deviû
, 
physiÿl
)) {

2082 
»t
 = 
çl£
;

2083 
	`¥š_uÆock
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

2084 
out_uÆock
;

2086 ià(!
is_d©a
)

2087 
zšfo
->
»£rved_aùive_zÚes
--;

2089 
	`¥š_uÆock
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

2092 
	`£t_b™
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
, &
block_group
->
ruÁime_æags
);

2093 
	`¥š_uÆock
(&
block_group
->
lock
);

2096 
	`bŒfs_g‘_block_group
(
block_group
);

2098 
	`¥š_lock
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

2099 
	`li¡_add_
(&
block_group
->
aùive_bg_li¡
, &
fs_šfo
->
zÚe_aùive_bgs
);

2100 
	`¥š_uÆock
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

2102  
Œue
;

2104 
out_uÆock
:

2105 
	`¥š_uÆock
(&
block_group
->
lock
);

2106  
»t
;

2107 
	}
}

2109 
	$wa™_eb_wr™ebacks
(
bŒfs_block_group
 *
block_group
)

2111 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

2112 cÚ¡ 
u64
 
’d
 = 
block_group
->
¡¬t
 + block_group->
Ëngth
;

2113 
¿dix_Œ“_™”
 
™”
;

2114 
ex‹Á_bufãr
 *
eb
;

2115 
__rcu
 **
¦Ù
;

2117 
	`rcu_»ad_lock
();

2118 
	`¿dix_Œ“_fÜ_—ch_¦Ù
(
¦Ù
, &
fs_šfo
->
bufãr_¿dix
, &
™”
,

2119 
block_group
->
¡¬t
 >> 
fs_šfo
->
£ùÜsize_b™s
) {

2120 
eb
 = 
	`¿dix_Œ“_d”ef_¦Ù
(
¦Ù
);

2121 ià(!
eb
)

2123 ià(
	`¿dix_Œ“_d”ef_»Œy
(
eb
)) {

2124 
¦Ù
 = 
	`¿dix_Œ“_™”_»Œy
(&
™”
);

2128 ià(
eb
->
¡¬t
 < 
block_group
->start)

2130 ià(
eb
->
¡¬t
 >ğ
’d
)

2133 
¦Ù
 = 
	`¿dix_Œ“_™”_»sume
(¦Ù, &
™”
);

2134 
	`rcu_»ad_uÆock
();

2135 
	`wa™_Ú_ex‹Á_bufãr_wr™eback
(
eb
);

2136 
	`rcu_»ad_lock
();

2138 
	`rcu_»ad_uÆock
();

2139 
	}
}

2141 
	$do_zÚe_fšish
(
bŒfs_block_group
 *
block_group
, 
boŞ
 
fuÎy_wr™‹n
)

2143 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

2144 
m­_lookup
 *
m­
;

2145 cÚ¡ 
boŞ
 
is_m‘ad©a
 = (
block_group
->
æags
 &

2146 (
BTRFS_BLOCK_GROUP_METADATA
 | 
BTRFS_BLOCK_GROUP_SYSTEM
));

2147 
»t
 = 0;

2148 
i
;

2150 
	`¥š_lock
(&
block_group
->
lock
);

2151 ià(!
	`‹¡_b™
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
, &
block_group
->
ruÁime_æags
)) {

2152 
	`¥š_uÆock
(&
block_group
->
lock
);

2157 ià(
is_m‘ad©a
 &&

2158 
block_group
->
¡¬t
 + block_group->
®loc_off£t
 > block_group->
m‘a_wr™e_poš‹r
) {

2159 
	`¥š_uÆock
(&
block_group
->
lock
);

2160  -
EAGAIN
;

2170 ià(!
fuÎy_wr™‹n
) {

2171 ià(
	`‹¡_b™
(
BLOCK_GROUP_FLAG_ZONED_DATA_RELOC
, &
block_group
->
ruÁime_æags
)) {

2172 
	`¥š_uÆock
(&
block_group
->
lock
);

2173  -
EAGAIN
;

2175 
	`¥š_uÆock
(&
block_group
->
lock
);

2177 
»t
 = 
	`bŒfs_šc_block_group_ro
(
block_group
, 
çl£
);

2178 ià(
»t
)

2179  
»t
;

2182 
	`bŒfs_wa™_block_group_»£rv©iÚs
(
block_group
);

2184 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
U64_MAX
, 
block_group
->
¡¬t
,

2185 
block_group
->
Ëngth
);

2187 ià(
is_m‘ad©a
)

2188 
	`wa™_eb_wr™ebacks
(
block_group
);

2190 
	`¥š_lock
(&
block_group
->
lock
);

2196 ià(!
	`‹¡_b™
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
,

2197 &
block_group
->
ruÁime_æags
)) {

2198 
	`¥š_uÆock
(&
block_group
->
lock
);

2199 
	`bŒfs_dec_block_group_ro
(
block_group
);

2203 ià(
block_group
->
»£rved
 ||

2204 
	`‹¡_b™
(
BLOCK_GROUP_FLAG_ZONED_DATA_RELOC
,

2205 &
block_group
->
ruÁime_æags
)) {

2206 
	`¥š_uÆock
(&
block_group
->
lock
);

2207 
	`bŒfs_dec_block_group_ro
(
block_group
);

2208  -
EAGAIN
;

2212 
	`ş—r_b™
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
, &
block_group
->
ruÁime_æags
);

2213 
block_group
->
®loc_off£t
 = block_group->
zÚe_ÿ·c™y
;

2214 ià(
block_group
->
æags
 & (
BTRFS_BLOCK_GROUP_METADATA
 | 
BTRFS_BLOCK_GROUP_SYSTEM
))

2215 
block_group
->
m‘a_wr™e_poš‹r
 = block_group->
¡¬t
 +

2216 
block_group
->
zÚe_ÿ·c™y
;

2217 
block_group
->
ä“_¥aû_ùl
->
ä“_¥aû
 = 0;

2218 
	`bŒfs_ş—r_Œ“log_bg
(
block_group
);

2219 
	`bŒfs_ş—r_d©a_»loc_bg
(
block_group
);

2220 
	`¥š_uÆock
(&
block_group
->
lock
);

2222 
m­
 = 
block_group
->
physiÿl_m­
;

2223 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

2224 
bŒfs_deviû
 *
deviû
 = 
m­
->
¡res
[
i
].
dev
;

2225 cÚ¡ 
u64
 
physiÿl
 = 
m­
->
¡res
[
i
].physical;

2226 
bŒfs_zÚed_deviû_šfo
 *
zšfo
 = 
deviû
->
zÚe_šfo
;

2228 ià(
zšfo
->
max_aùive_zÚes
 == 0)

2231 
»t
 = 
	`blkdev_zÚe_mgmt
(
deviû
->
bdev
, 
REQ_OP_ZONE_FINISH
,

2232 
physiÿl
 >> 
SECTOR_SHIFT
,

2233 
zšfo
->
zÚe_size
 >> 
SECTOR_SHIFT
,

2234 
GFP_NOFS
);

2236 ià(
»t
)

2237  
»t
;

2239 ià(!(
block_group
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
))

2240 
zšfo
->
»£rved_aùive_zÚes
++;

2241 
	`bŒfs_dev_ş—r_aùive_zÚe
(
deviû
, 
physiÿl
);

2244 ià(!
fuÎy_wr™‹n
)

2245 
	`bŒfs_dec_block_group_ro
(
block_group
);

2247 
	`¥š_lock
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

2248 
	`ASSERT
(!
	`li¡_em±y
(&
block_group
->
aùive_bg_li¡
));

2249 
	`li¡_d–_š™
(&
block_group
->
aùive_bg_li¡
);

2250 
	`¥š_uÆock
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

2253 
	`bŒfs_put_block_group
(
block_group
);

2255 
	`ş—r_ªd_wake_up_b™
(
BTRFS_FS_NEED_ZONE_FINISH
, &
fs_šfo
->
æags
);

2258 
	}
}

2260 
	$bŒfs_zÚe_fšish
(
bŒfs_block_group
 *
block_group
)

2262 ià(!
	`bŒfs_is_zÚed
(
block_group
->
fs_šfo
))

2265  
	`do_zÚe_fšish
(
block_group
, 
çl£
);

2266 
	}
}

2268 
boŞ
 
	$bŒfs_ÿn_aùiv©e_zÚe
(
bŒfs_fs_deviûs
 *
fs_deviûs
, 
u64
 
æags
)

2270 
bŒfs_fs_šfo
 *
fs_šfo
 = 
fs_deviûs
->fs_info;

2271 
bŒfs_deviû
 *
deviû
;

2272 
boŞ
 
»t
 = 
çl£
;

2274 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

2275  
Œue
;

2278 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

2279 
	`¥š_lock
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

2280 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
®loc_li¡
, 
dev_®loc_li¡
) {

2281 
bŒfs_zÚed_deviû_šfo
 *
zšfo
 = 
deviû
->
zÚe_šfo
;

2282 
»£rved
 = 0;

2284 ià(!
deviû
->
bdev
)

2287 ià(!
zšfo
->
max_aùive_zÚes
) {

2288 
»t
 = 
Œue
;

2292 ià(
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

2293 
»£rved
 = 
zšfo
->
»£rved_aùive_zÚes
;

2295 
æags
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) {

2297 
»t
 = (
	`©omic_»ad
(&
zšfo
->
aùive_zÚes_Ëá
è>ğ(1 + 
»£rved
));

2299 
BTRFS_BLOCK_GROUP_DUP
:

2300 
»t
 = (
	`©omic_»ad
(&
zšfo
->
aùive_zÚes_Ëá
è>ğ(2 + 
»£rved
));

2303 ià(
»t
)

2306 
	`¥š_uÆock
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

2307 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

2309 ià(!
»t
)

2310 
	`£t_b™
(
BTRFS_FS_NEED_ZONE_FINISH
, &
fs_šfo
->
æags
);

2312  
»t
;

2313 
	}
}

2315 
	$bŒfs_zÚe_fšish_’dio
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
, u64 
Ëngth
)

2317 
bŒfs_block_group
 *
block_group
;

2318 
u64
 
mš_®loc_by‹s
;

2320 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

2323 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
logiÿl
);

2324 
	`ASSERT
(
block_group
);

2327 ià(
block_group
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

2328 
mš_®loc_by‹s
 = 
fs_šfo
->
£ùÜsize
;

2330 
mš_®loc_by‹s
 = 
fs_šfo
->
nodesize
;

2333 ià(
logiÿl
 + 
Ëngth
 + 
mš_®loc_by‹s
 <=

2334 
block_group
->
¡¬t
 + block_group->
zÚe_ÿ·c™y
)

2335 
out
;

2337 
	`do_zÚe_fšish
(
block_group
, 
Œue
);

2339 
out
:

2340 
	`bŒfs_put_block_group
(
block_group
);

2341 
	}
}

2343 
	$bŒfs_zÚe_fšish_’dio_wÜkâ
(
wÜk_¡ruù
 *
wÜk
)

2345 
bŒfs_block_group
 *
bg
 =

2346 
	`cÚš”_of
(
wÜk
, 
bŒfs_block_group
, 
zÚe_fšish_wÜk
);

2348 
	`wa™_Ú_ex‹Á_bufãr_wr™eback
(
bg
->
Ï¡_eb
);

2349 
	`ä“_ex‹Á_bufãr
(
bg
->
Ï¡_eb
);

2350 
	`bŒfs_zÚe_fšish_’dio
(
bg
->
fs_šfo
, bg->
¡¬t
, bg->
Ëngth
);

2351 
	`bŒfs_put_block_group
(
bg
);

2352 
	}
}

2354 
	$bŒfs_scheduË_zÚe_fšish_bg
(
bŒfs_block_group
 *
bg
,

2355 
ex‹Á_bufãr
 *
eb
)

2357 ià(!
	`‹¡_b™
(
BLOCK_GROUP_FLAG_SEQUENTIAL_ZONE
, &
bg
->
ruÁime_æags
) ||

2358 
eb
->
¡¬t
 +ƒb->
Ën
 * 2 <ğ
bg
->¡¬ˆ+ bg->
zÚe_ÿ·c™y
)

2361 ià(
	`WARN_ON
(
bg
->
zÚe_fšish_wÜk
.
func
 =ğ
bŒfs_zÚe_fšish_’dio_wÜkâ
)) {

2362 
	`bŒfs_”r
(
bg
->
fs_šfo
, "double scheduling of bg %llu zone finishing",

2363 
bg
->
¡¬t
);

2368 
	`bŒfs_g‘_block_group
(
bg
);

2369 
	`©omic_šc
(&
eb
->
»fs
);

2370 
bg
->
Ï¡_eb
 = 
eb
;

2371 
	`INIT_WORK
(&
bg
->
zÚe_fšish_wÜk
, 
bŒfs_zÚe_fšish_’dio_wÜkâ
);

2372 
	`queue_wÜk
(
sy¡em_unbound_wq
, &
bg
->
zÚe_fšish_wÜk
);

2373 
	}
}

2375 
	$bŒfs_ş—r_d©a_»loc_bg
(
bŒfs_block_group
 *
bg
)

2377 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bg
->fs_info;

2379 
	`¥š_lock
(&
fs_šfo
->
»loÿtiÚ_bg_lock
);

2380 ià(
fs_šfo
->
d©a_»loc_bg
 =ğ
bg
->
¡¬t
)

2381 
fs_šfo
->
d©a_»loc_bg
 = 0;

2382 
	`¥š_uÆock
(&
fs_šfo
->
»loÿtiÚ_bg_lock
);

2383 
	}
}

2385 
	$bŒfs_ä“_zÚe_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
)

2387 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

2388 
bŒfs_deviû
 *
deviû
;

2390 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

2393 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2394 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

2395 ià(
deviû
->
zÚe_šfo
) {

2396 
	`vä“
(
deviû
->
zÚe_šfo
->
zÚe_ÿche
);

2397 
deviû
->
zÚe_šfo
->
zÚe_ÿche
 = 
NULL
;

2400 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2401 
	}
}

2403 
boŞ
 
	$bŒfs_zÚed_should_»şaim
(
bŒfs_fs_šfo
 *
fs_šfo
)

2405 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

2406 
bŒfs_deviû
 *
deviû
;

2407 
u64
 
u£d
 = 0;

2408 
u64
 
tÙ®
 = 0;

2409 
u64
 
çùÜ
;

2411 
	`ASSERT
(
	`bŒfs_is_zÚed
(
fs_šfo
));

2413 ià(
fs_šfo
->
bg_»şaim_th»shŞd
 == 0)

2414  
çl£
;

2416 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2417 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

2418 ià(!
deviû
->
bdev
)

2421 
tÙ®
 +ğ
deviû
->
disk_tÙ®_by‹s
;

2422 
u£d
 +ğ
deviû
->
by‹s_u£d
;

2424 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2426 
çùÜ
 = 
	`div64_u64
(
u£d
 * 100, 
tÙ®
);

2427  
çùÜ
 >ğ
fs_šfo
->
bg_»şaim_th»shŞd
;

2428 
	}
}

2430 
	$bŒfs_zÚed_»Ëa£_d©a_»loc_bg
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
,

2431 
u64
 
Ëngth
)

2433 
bŒfs_block_group
 *
block_group
;

2435 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

2438 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
logiÿl
);

2440 
	`ASSERT
(
block_group
 && (block_group->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
));

2442 
	`¥š_lock
(&
block_group
->
lock
);

2443 ià(!
	`‹¡_b™
(
BLOCK_GROUP_FLAG_ZONED_DATA_RELOC
, &
block_group
->
ruÁime_æags
))

2444 
out
;

2447 ià(
block_group
->
¡¬t
 + block_group->
®loc_off£t
 =ğ
logiÿl
 + 
Ëngth
) {

2452 
	`ş—r_b™
(
BLOCK_GROUP_FLAG_ZONED_DATA_RELOC
,

2453 &
block_group
->
ruÁime_æags
);

2456 
out
:

2457 
	`¥š_uÆock
(&
block_group
->
lock
);

2458 
	`bŒfs_put_block_group
(
block_group
);

2459 
	}
}

2461 
	$bŒfs_zÚe_fšish_Úe_bg
(
bŒfs_fs_šfo
 *
fs_šfo
)

2463 
bŒfs_block_group
 *
block_group
;

2464 
bŒfs_block_group
 *
mš_bg
 = 
NULL
;

2465 
u64
 
mš_ava
 = 
U64_MAX
;

2466 
»t
;

2468 
	`¥š_lock
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

2469 
	`li¡_fÜ_—ch_’Œy
(
block_group
, &
fs_šfo
->
zÚe_aùive_bgs
,

2470 
aùive_bg_li¡
) {

2471 
u64
 
ava
;

2473 
	`¥š_lock
(&
block_group
->
lock
);

2474 ià(
block_group
->
»£rved
 || block_group->
®loc_off£t
 == 0 ||

2475 (
block_group
->
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) ||

2476 
	`‹¡_b™
(
BLOCK_GROUP_FLAG_ZONED_DATA_RELOC
, &
block_group
->
ruÁime_æags
)) {

2477 
	`¥š_uÆock
(&
block_group
->
lock
);

2481 
ava
 = 
block_group
->
zÚe_ÿ·c™y
 - block_group->
®loc_off£t
;

2482 ià(
mš_ava
 > 
ava
) {

2483 ià(
mš_bg
)

2484 
	`bŒfs_put_block_group
(
mš_bg
);

2485 
mš_bg
 = 
block_group
;

2486 
mš_ava
 = 
ava
;

2487 
	`bŒfs_g‘_block_group
(
mš_bg
);

2489 
	`¥š_uÆock
(&
block_group
->
lock
);

2491 
	`¥š_uÆock
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

2493 ià(!
mš_bg
)

2496 
»t
 = 
	`bŒfs_zÚe_fšish
(
mš_bg
);

2497 
	`bŒfs_put_block_group
(
mš_bg
);

2499  
»t
 < 0 ?„et : 1;

2500 
	}
}

2502 
	$bŒfs_zÚed_aùiv©e_Úe_bg
(
bŒfs_fs_šfo
 *
fs_šfo
,

2503 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

2504 
boŞ
 
do_fšish
)

2506 
bŒfs_block_group
 *
bg
;

2507 
šdex
;

2509 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
è|| (
¥aû_šfo
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
))

2513 
»t
;

2514 
boŞ
 
Ãed_fšish
 = 
çl£
;

2516 
	`down_»ad
(&
¥aû_šfo
->
groups_£m
);

2517 
šdex
 = 0; index < 
BTRFS_NR_RAID_TYPES
; index++) {

2518 
	`li¡_fÜ_—ch_’Œy
(
bg
, &
¥aû_šfo
->
block_groups
[
šdex
],

2519 
li¡
) {

2520 ià(!
	`¥š_Œylock
(&
bg
->
lock
))

2522 ià(
	`bŒfs_zÚed_bg_is_fuÎ
(
bg
) ||

2523 
	`‹¡_b™
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
,

2524 &
bg
->
ruÁime_æags
)) {

2525 
	`¥š_uÆock
(&
bg
->
lock
);

2528 
	`¥š_uÆock
(&
bg
->
lock
);

2530 ià(
	`bŒfs_zÚe_aùiv©e
(
bg
)) {

2531 
	`up_»ad
(&
¥aû_šfo
->
groups_£m
);

2535 
Ãed_fšish
 = 
Œue
;

2538 
	`up_»ad
(&
¥aû_šfo
->
groups_£m
);

2540 ià(!
do_fšish
 || !
Ãed_fšish
)

2543 
»t
 = 
	`bŒfs_zÚe_fšish_Úe_bg
(
fs_šfo
);

2544 ià(
»t
 == 0)

2546 ià(
»t
 < 0)

2547  
»t
;

2551 
	}
}

2557 
	$bŒfs_check_aùive_zÚe_»£rv©iÚ
(
bŒfs_fs_šfo
 *
fs_šfo
)

2559 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

2560 
bŒfs_block_group
 *
block_group
;

2561 
bŒfs_deviû
 *
deviû
;

2563 
m‘ad©a_»£rve
 = 2;

2565 
sy¡em_»£rve
 = 1;

2567 ià(!
	`‹¡_b™
(
BTRFS_FS_ACTIVE_ZONE_TRACKING
, &
fs_šfo
->
æags
))

2574 ià(
fs_šfo
->
ava_m‘ad©a_®loc_b™s
 & 
BTRFS_BLOCK_GROUP_DUP
)

2575 
m‘ad©a_»£rve
 = 4;

2576 ià(
fs_šfo
->
ava_sy¡em_®loc_b™s
 & 
BTRFS_BLOCK_GROUP_DUP
)

2577 
sy¡em_»£rve
 = 2;

2580 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2581 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

2582 ià(!
deviû
->
bdev
)

2585 
deviû
->
zÚe_šfo
->
»£rved_aùive_zÚes
 =

2586 
m‘ad©a_»£rve
 + 
sy¡em_»£rve
;

2588 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2591 
	`¥š_lock
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

2592 
	`li¡_fÜ_—ch_’Œy
(
block_group
, &
fs_šfo
->
zÚe_aùive_bgs
, 
aùive_bg_li¡
) {

2593 
m­_lookup
 *
m­
 = 
block_group
->
physiÿl_m­
;

2595 ià(!(
block_group
->
æags
 &

2596 (
BTRFS_BLOCK_GROUP_METADATA
 | 
BTRFS_BLOCK_GROUP_SYSTEM
)))

2599 
i
 = 0; i < 
m­
->
num_¡res
; i++)

2600 
m­
->
¡res
[
i
].
dev
->
zÚe_šfo
->
»£rved_aùive_zÚes
--;

2602 
	`¥š_uÆock
(&
fs_šfo
->
zÚe_aùive_bgs_lock
);

2603 
	}
}

	@zoned.h

3 #iâdeà
BTRFS_ZONED_H


4 
	#BTRFS_ZONED_H


	)

6 
	~<lšux/ty³s.h
>

7 
	~<lšux/blkdev.h
>

8 
	~"mes§ges.h
"

9 
	~"vŞumes.h
"

10 
	~"disk-io.h
"

11 
	~"block-group.h
"

12 
	~"bŒfs_šode.h
"

14 
	#BTRFS_DEFAULT_RECLAIM_THRESH
 (75)

	)

16 
	sbŒfs_zÚed_deviû_šfo
 {

21 
u64
 
	mzÚe_size
;

22 
u8
 
	mzÚe_size_shiá
;

23 
u32
 
	mÄ_zÚes
;

24 
	mmax_aùive_zÚes
;

29 
	m»£rved_aùive_zÚes
;

30 
©omic_t
 
	maùive_zÚes_Ëá
;

31 *
	m£q_zÚes
;

32 *
	mem±y_zÚes
;

33 *
	maùive_zÚes
;

34 
blk_zÚe
 *
	mzÚe_ÿche
;

35 
blk_zÚe
 
	msb_zÚes
[2 * 
BTRFS_SUPER_MIRROR_MAX
];

38 
bŒfs_fšish_Üd”ed_zÚed
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
);

40 #ifdeà
CONFIG_BLK_DEV_ZONED


41 
bŒfs_g‘_dev_zÚe
(
bŒfs_deviû
 *
deviû
, 
u64
 
pos
,

42 
blk_zÚe
 *
zÚe
);

43 
bŒfs_g‘_dev_zÚe_šfo_®l_deviûs
(
bŒfs_fs_šfo
 *
fs_šfo
);

44 
bŒfs_g‘_dev_zÚe_šfo
(
bŒfs_deviû
 *
deviû
, 
boŞ
 
pİuÏ‹_ÿche
);

45 
bŒfs_de¡roy_dev_zÚe_šfo
(
bŒfs_deviû
 *
deviû
);

46 
bŒfs_zÚed_deviû_šfo
 *
bŒfs_şÚe_dev_zÚe_šfo
(
bŒfs_deviû
 *
Üig_dev
);

47 
bŒfs_check_zÚed_mode
(
bŒfs_fs_šfo
 *
fs_šfo
);

48 
bŒfs_check_mouÁİts_zÚed
(
bŒfs_fs_šfo
 *
šfo
);

49 
bŒfs_sb_log_loÿtiÚ_bdev
(
block_deviû
 *
bdev
, 
mœrÜ
, 
rw
,

50 
u64
 *
by‹Ä_»t
);

51 
bŒfs_sb_log_loÿtiÚ_bdev_·¹™iÚ
(
block_deviû
 *
bdev
,

52 
mœrÜ
, 
rw
, 
u64
 *
by‹Ä_»t
, u64 
sb_off£t
);

53 
bŒfs_sb_log_loÿtiÚ
(
bŒfs_deviû
 *
deviû
, 
mœrÜ
, 
rw
,

54 
u64
 *
by‹Ä_»t
);

55 
bŒfs_sb_log_loÿtiÚ_·¹™iÚ
(
bŒfs_deviû
 *
deviû
, 
mœrÜ
,

56 
rw
, 
u64
 *
by‹Ä_»t
, u64 
sb_off£t
);

57 
bŒfs_advªû_sb_log
(
bŒfs_deviû
 *
deviû
, 
mœrÜ
);

58 
bŒfs_»£t_sb_log_zÚes
(
block_deviû
 *
bdev
, 
mœrÜ
);

59 
u64
 
bŒfs_fšd_®loÿbË_zÚes
(
bŒfs_deviû
 *
deviû
, u64 
hŞe_¡¬t
,

60 
u64
 
hŞe_’d
, u64 
num_by‹s
);

61 
bŒfs_»£t_deviû_zÚe
(
bŒfs_deviû
 *
deviû
, 
u64
 
physiÿl
,

62 
u64
 
Ëngth
, u64 *
by‹s
);

63 
bŒfs_’su»_em±y_zÚes
(
bŒfs_deviû
 *
deviû
, 
u64
 
¡¬t
, u64 
size
);

64 
bŒfs_lßd_block_group_zÚe_šfo
(
bŒfs_block_group
 *
ÿche
, 
boŞ
 
Ãw
);

65 
bŒfs_ÿlc_zÚe_unu§bË
(
bŒfs_block_group
 *
ÿche
);

66 
bŒfs_»dœty_li¡_add
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

67 
ex‹Á_bufãr
 *
eb
);

68 
boŞ
 
bŒfs_u£_zÚe_­³nd
(
bŒfs_bio
 *
bbio
);

69 
bŒfs_»cÜd_physiÿl_zÚed
(
bŒfs_bio
 *
bbio
);

70 
bŒfs_check_m‘a_wr™e_poš‹r
(
bŒfs_fs_šfo
 *
fs_šfo
,

71 
bŒfs_eb_wr™e_cÚ‹xt
 *
ùx
);

72 
bŒfs_zÚed_issue_z”oout
(
bŒfs_deviû
 *
deviû
, 
u64
 
physiÿl
, u64 
Ëngth
);

73 
bŒfs_sync_zÚe_wr™e_poš‹r
(
bŒfs_deviû
 *
tgt_dev
, 
u64
 
logiÿl
,

74 
u64
 
physiÿl_¡¬t
, u64 
physiÿl_pos
);

75 
boŞ
 
bŒfs_zÚe_aùiv©e
(
bŒfs_block_group
 *
block_group
);

76 
bŒfs_zÚe_fšish
(
bŒfs_block_group
 *
block_group
);

77 
boŞ
 
bŒfs_ÿn_aùiv©e_zÚe
(
bŒfs_fs_deviûs
 *
fs_deviûs
, 
u64
 
æags
);

78 
bŒfs_zÚe_fšish_’dio
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
,

79 
u64
 
Ëngth
);

80 
bŒfs_scheduË_zÚe_fšish_bg
(
bŒfs_block_group
 *
bg
,

81 
ex‹Á_bufãr
 *
eb
);

82 
bŒfs_ş—r_d©a_»loc_bg
(
bŒfs_block_group
 *
bg
);

83 
bŒfs_ä“_zÚe_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
);

84 
boŞ
 
bŒfs_zÚed_should_»şaim
(
bŒfs_fs_šfo
 *
fs_šfo
);

85 
bŒfs_zÚed_»Ëa£_d©a_»loc_bg
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
,

86 
u64
 
Ëngth
);

87 
bŒfs_zÚe_fšish_Úe_bg
(
bŒfs_fs_šfo
 *
fs_šfo
);

88 
bŒfs_zÚed_aùiv©e_Úe_bg
(
bŒfs_fs_šfo
 *
fs_šfo
,

89 
bŒfs_¥aû_šfo
 *
¥aû_šfo
, 
boŞ
 
do_fšish
);

90 
bŒfs_check_aùive_zÚe_»£rv©iÚ
(
bŒfs_fs_šfo
 *
fs_šfo
);

92 
šlše
 
	$bŒfs_g‘_dev_zÚe
(
bŒfs_deviû
 *
deviû
, 
u64
 
pos
,

93 
blk_zÚe
 *
zÚe
)

96 
	}
}

98 
šlše
 
	$bŒfs_g‘_dev_zÚe_šfo_®l_deviûs
(
bŒfs_fs_šfo
 *
fs_šfo
)

101 
	}
}

103 
šlše
 
	$bŒfs_g‘_dev_zÚe_šfo
(
bŒfs_deviû
 *
deviû
,

104 
boŞ
 
pİuÏ‹_ÿche
)

107 
	}
}

109 
šlše
 
	$bŒfs_de¡roy_dev_zÚe_šfo
(
bŒfs_deviû
 *
deviû
è{ 
	}
}

115 
šlše
 
bŒfs_zÚed_deviû_šfo
 *
	$bŒfs_şÚe_dev_zÚe_šfo
(

116 
bŒfs_deviû
 *
Üig_dev
)

118  
NULL
;

119 
	}
}

121 
šlše
 
	$bŒfs_check_zÚed_mode
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
)

123 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

126 
	`bŒfs_”r
(
fs_šfo
, "zoned block devices support is‚otƒnabled");

127  -
EOPNOTSUPP
;

128 
	}
}

130 
šlše
 
	$bŒfs_check_mouÁİts_zÚed
(
bŒfs_fs_šfo
 *
šfo
)

133 
	}
}

135 
šlše
 
	$bŒfs_sb_log_loÿtiÚ_bdev
(
block_deviû
 *
bdev
,

136 
mœrÜ
, 
rw
, 
u64
 *
by‹Ä_»t
)

138 *
by‹Ä_»t
 = 
	`bŒfs_sb_off£t
(
mœrÜ
);

140 
	}
}

143 
šlše
 
	$bŒfs_sb_log_loÿtiÚ_bdev_·¹™iÚ
(
block_deviû
 *
bdev
,

144 
mœrÜ
, 
rw
, 
u64
 *
by‹Ä_»t
, u64 
sb_off£t
)

146 *
by‹Ä_»t
 = 
	`bŒfs_sb_off£t_·¹™iÚ
(
mœrÜ
, 
sb_off£t
);

148 
	}
}

150 
šlše
 
	$bŒfs_sb_log_loÿtiÚ
(
bŒfs_deviû
 *
deviû
, 
mœrÜ
,

151 
rw
, 
u64
 *
by‹Ä_»t
)

153 *
by‹Ä_»t
 = 
	`bŒfs_sb_off£t
(
mœrÜ
);

155 
	}
}

157 
šlše
 
	$bŒfs_sb_log_loÿtiÚ_·¹™iÚ
(
bŒfs_deviû
 *
deviû
, 
mœrÜ
,

158 
rw
, 
u64
 *
by‹Ä_»t
, u64 
sb_off£t
)

160 *
by‹Ä_»t
 = 
	`bŒfs_sb_off£t_·¹™iÚ
(
mœrÜ
, 
sb_off£t
);

162 
	}
}

164 
šlše
 
	$bŒfs_advªû_sb_log
(
bŒfs_deviû
 *
deviû
, 
mœrÜ
)

167 
	}
}

169 
šlše
 
	$bŒfs_»£t_sb_log_zÚes
(
block_deviû
 *
bdev
, 
mœrÜ
)

172 
	}
}

174 
šlše
 
u64
 
	$bŒfs_fšd_®loÿbË_zÚes
(
bŒfs_deviû
 *
deviû
,

175 
u64
 
hŞe_¡¬t
, u64 
hŞe_’d
,

176 
u64
 
num_by‹s
)

178  
hŞe_¡¬t
;

179 
	}
}

181 
šlše
 
	$bŒfs_»£t_deviû_zÚe
(
bŒfs_deviû
 *
deviû
,

182 
u64
 
physiÿl
, u64 
Ëngth
, u64 *
by‹s
)

184 *
by‹s
 = 0;

186 
	}
}

188 
šlše
 
	$bŒfs_’su»_em±y_zÚes
(
bŒfs_deviû
 *
deviû
,

189 
u64
 
¡¬t
, u64 
size
)

192 
	}
}

194 
šlše
 
	$bŒfs_lßd_block_group_zÚe_šfo
(

195 
bŒfs_block_group
 *
ÿche
, 
boŞ
 
Ãw
)

198 
	}
}

200 
šlše
 
	$bŒfs_ÿlc_zÚe_unu§bË
(
bŒfs_block_group
 *
ÿche
è{ 
	}
}

202 
šlše
 
	$bŒfs_»dœty_li¡_add
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

203 
ex‹Á_bufãr
 *
eb
è{ 
	}
}

205 
šlše
 
boŞ
 
	$bŒfs_u£_zÚe_­³nd
(
bŒfs_bio
 *
bbio
)

207  
çl£
;

208 
	}
}

210 
šlše
 
	$bŒfs_»cÜd_physiÿl_zÚed
(
bŒfs_bio
 *
bbio
)

212 
	}
}

214 
šlše
 
	$bŒfs_check_m‘a_wr™e_poš‹r
(
bŒfs_fs_šfo
 *
fs_šfo
,

215 
bŒfs_eb_wr™e_cÚ‹xt
 *
ùx
)

218 
	}
}

220 
šlše
 
	$bŒfs_zÚed_issue_z”oout
(
bŒfs_deviû
 *
deviû
,

221 
u64
 
physiÿl
, u64 
Ëngth
)

223  -
EOPNOTSUPP
;

224 
	}
}

226 
šlše
 
	$bŒfs_sync_zÚe_wr™e_poš‹r
(
bŒfs_deviû
 *
tgt_dev
,

227 
u64
 
logiÿl
, u64 
physiÿl_¡¬t
,

228 
u64
 
physiÿl_pos
)

230  -
EOPNOTSUPP
;

231 
	}
}

233 
šlše
 
boŞ
 
	$bŒfs_zÚe_aùiv©e
(
bŒfs_block_group
 *
block_group
)

235  
Œue
;

236 
	}
}

238 
šlše
 
	$bŒfs_zÚe_fšish
(
bŒfs_block_group
 *
block_group
)

241 
	}
}

243 
šlše
 
boŞ
 
	$bŒfs_ÿn_aùiv©e_zÚe
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

244 
u64
 
æags
)

246  
Œue
;

247 
	}
}

249 
šlše
 
	$bŒfs_zÚe_fšish_’dio
(
bŒfs_fs_šfo
 *
fs_šfo
,

250 
u64
 
logiÿl
, u64 
Ëngth
è{ 
	}
}

252 
šlše
 
	$bŒfs_scheduË_zÚe_fšish_bg
(
bŒfs_block_group
 *
bg
,

253 
ex‹Á_bufãr
 *
eb
è{ 
	}
}

255 
šlše
 
	$bŒfs_ş—r_d©a_»loc_bg
(
bŒfs_block_group
 *
bg
è{ 
	}
}

257 
šlše
 
	$bŒfs_ä“_zÚe_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
è{ 
	}
}

259 
šlše
 
boŞ
 
	$bŒfs_zÚed_should_»şaim
(
bŒfs_fs_šfo
 *
fs_šfo
)

261  
çl£
;

262 
	}
}

264 
šlše
 
	$bŒfs_zÚed_»Ëa£_d©a_»loc_bg
(
bŒfs_fs_šfo
 *
fs_šfo
,

265 
u64
 
logiÿl
, u64 
Ëngth
è{ 
	}
}

267 
šlše
 
	$bŒfs_zÚe_fšish_Úe_bg
(
bŒfs_fs_šfo
 *
fs_šfo
)

270 
	}
}

272 
šlše
 
	$bŒfs_zÚed_aùiv©e_Úe_bg
(
bŒfs_fs_šfo
 *
fs_šfo
,

273 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

274 
boŞ
 
do_fšish
)

278 
	}
}

280 
šlše
 
	$bŒfs_check_aùive_zÚe_»£rv©iÚ
(
bŒfs_fs_šfo
 *
fs_šfo
è{ 
	}
}

284 
šlše
 
boŞ
 
	$bŒfs_dev_is_£qu’tŸl
(
bŒfs_deviû
 *
deviû
, 
u64
 
pos
)

286 
bŒfs_zÚed_deviû_šfo
 *
zÚe_šfo
 = 
deviû
->zone_info;

288 ià(!
zÚe_šfo
)

289  
çl£
;

291  
	`‹¡_b™
(
pos
 >> 
zÚe_šfo
->
zÚe_size_shiá
, zÚe_šfo->
£q_zÚes
);

292 
	}
}

294 
šlše
 
boŞ
 
	$bŒfs_dev_is_em±y_zÚe
(
bŒfs_deviû
 *
deviû
, 
u64
 
pos
)

296 
bŒfs_zÚed_deviû_šfo
 *
zÚe_šfo
 = 
deviû
->zone_info;

298 ià(!
zÚe_šfo
)

299  
Œue
;

301  
	`‹¡_b™
(
pos
 >> 
zÚe_šfo
->
zÚe_size_shiá
, zÚe_šfo->
em±y_zÚes
);

302 
	}
}

304 
šlše
 
	$bŒfs_dev_£t_em±y_zÚe_b™
(
bŒfs_deviû
 *
deviû
,

305 
u64
 
pos
, 
boŞ
 
£t
)

307 
bŒfs_zÚed_deviû_šfo
 *
zÚe_šfo
 = 
deviû
->zone_info;

308 
zno
;

310 ià(!
zÚe_šfo
)

313 
zno
 = 
pos
 >> 
zÚe_šfo
->
zÚe_size_shiá
;

314 ià(
£t
)

315 
	`£t_b™
(
zno
, 
zÚe_šfo
->
em±y_zÚes
);

317 
	`ş—r_b™
(
zno
, 
zÚe_šfo
->
em±y_zÚes
);

318 
	}
}

320 
šlše
 
	$bŒfs_dev_£t_zÚe_em±y
(
bŒfs_deviû
 *
deviû
, 
u64
 
pos
)

322 
	`bŒfs_dev_£t_em±y_zÚe_b™
(
deviû
, 
pos
, 
Œue
);

323 
	}
}

325 
šlše
 
	$bŒfs_dev_ş—r_zÚe_em±y
(
bŒfs_deviû
 *
deviû
, 
u64
 
pos
)

327 
	`bŒfs_dev_£t_em±y_zÚe_b™
(
deviû
, 
pos
, 
çl£
);

328 
	}
}

330 
šlše
 
boŞ
 
	$bŒfs_check_deviû_zÚe_ty³
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

331 
block_deviû
 *
bdev
)

333 ià(
	`bŒfs_is_zÚed
(
fs_šfo
)) {

338 ià(!
	`bdev_is_zÚed
(
bdev
))

339  
Œue
;

341  
fs_šfo
->
zÚe_size
 ==

342 (
	`bdev_zÚe_£ùÜs
(
bdev
è<< 
SECTOR_SHIFT
);

346  
	`bdev_zÚed_mod–
(
bdev
è!ğ
BLK_ZONED_HM
;

347 
	}
}

349 
šlše
 
boŞ
 
	$bŒfs_check_su³r_loÿtiÚ
(
bŒfs_deviû
 *
deviû
, 
u64
 
pos
)

355  
deviû
->
zÚe_šfo
 =ğ
NULL
 || !
	`bŒfs_dev_is_£qu’tŸl
(deviû, 
pos
);

356 
	}
}

358 
šlše
 
boŞ
 
	$bŒfs_ÿn_zÚe_»£t
(
bŒfs_deviû
 *
deviû
,

359 
u64
 
physiÿl
, u64 
Ëngth
)

361 
u64
 
zÚe_size
;

363 ià(!
	`bŒfs_dev_is_£qu’tŸl
(
deviû
, 
physiÿl
))

364  
çl£
;

366 
zÚe_size
 = 
deviû
->
zÚe_šfo
->zone_size;

367 ià(!
	`IS_ALIGNED
(
physiÿl
, 
zÚe_size
è|| !IS_ALIGNED(
Ëngth
, zone_size))

368  
çl£
;

370  
Œue
;

371 
	}
}

373 
šlše
 
	$bŒfs_zÚed_m‘a_io_lock
(
bŒfs_fs_šfo
 *
fs_šfo
)

375 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

377 
	`mu‹x_lock
(&
fs_šfo
->
zÚed_m‘a_io_lock
);

378 
	}
}

380 
šlše
 
	$bŒfs_zÚed_m‘a_io_uÆock
(
bŒfs_fs_šfo
 *
fs_šfo
)

382 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

384 
	`mu‹x_uÆock
(&
fs_šfo
->
zÚed_m‘a_io_lock
);

385 
	}
}

387 
šlše
 
	$bŒfs_ş—r_Œ“log_bg
(
bŒfs_block_group
 *
bg
)

389 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bg
->fs_info;

391 ià(!
	`bŒfs_is_zÚed
(
fs_šfo
))

394 
	`¥š_lock
(&
fs_šfo
->
Œ“log_bg_lock
);

395 ià(
fs_šfo
->
Œ“log_bg
 =ğ
bg
->
¡¬t
)

396 
fs_šfo
->
Œ“log_bg
 = 0;

397 
	`¥š_uÆock
(&
fs_šfo
->
Œ“log_bg_lock
);

398 
	}
}

400 
šlše
 
	$bŒfs_zÚed_d©a_»loc_lock
(
bŒfs_šode
 *
šode
)

402 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

404 ià(
	`bŒfs_is_d©a_»loc_roÙ
(
roÙ
è&& 
	`bŒfs_is_zÚed
ÔoÙ->
fs_šfo
))

405 
	`mu‹x_lock
(&
roÙ
->
fs_šfo
->
zÚed_d©a_»loc_io_lock
);

406 
	}
}

408 
šlše
 
	$bŒfs_zÚed_d©a_»loc_uÆock
(
bŒfs_šode
 *
šode
)

410 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

412 ià(
	`bŒfs_is_d©a_»loc_roÙ
(
roÙ
è&& 
	`bŒfs_is_zÚed
ÔoÙ->
fs_šfo
))

413 
	`mu‹x_uÆock
(&
roÙ
->
fs_šfo
->
zÚed_d©a_»loc_io_lock
);

414 
	}
}

416 
šlše
 
boŞ
 
	$bŒfs_zÚed_bg_is_fuÎ
(cÚ¡ 
bŒfs_block_group
 *
bg
)

418 
	`ASSERT
(
	`bŒfs_is_zÚed
(
bg
->
fs_šfo
));

419  (
bg
->
®loc_off£t
 =ğbg->
zÚe_ÿ·c™y
);

420 
	}
}

	@zstd.c

8 
	~<lšux/bio.h
>

9 
	~<lšux/b™m­.h
>

10 
	~<lšux/”r.h
>

11 
	~<lšux/š™.h
>

12 
	~<lšux/k”Ãl.h
>

13 
	~<lšux/mm.h
>

14 
	~<lšux/sched/mm.h
>

15 
	~<lšux/·gem­.h
>

16 
	~<lšux/»fcouÁ.h
>

17 
	~<lšux/sched.h
>

18 
	~<lšux/¦ab.h
>

19 
	~<lšux/z¡d.h
>

20 
	~"misc.h
"

21 
	~"com´essiÚ.h
"

22 
	~"ù»e.h
"

24 
	#ZSTD_BTRFS_MAX_WINDOWLOG
 17

	)

25 
	#ZSTD_BTRFS_MAX_INPUT
 (1 << 
ZSTD_BTRFS_MAX_WINDOWLOG
)

	)

26 
	#ZSTD_BTRFS_DEFAULT_LEVEL
 3

	)

27 
	#ZSTD_BTRFS_MAX_LEVEL
 15

	)

29 
	#ZSTD_BTRFS_RECLAIM_JIFFIES
 (307 * 
HZ
)

	)

31 
z¡d_·¿m‘”s
 
	$z¡d_g‘_bŒfs_·¿m‘”s
(
Ëv–
,

32 
size_t
 
¤c_Ën
)

34 
z¡d_·¿m‘”s
 
·¿ms
 = 
	`z¡d_g‘_·¿ms
(
Ëv–
, 
¤c_Ën
);

36 ià(
·¿ms
.
cP¬ams
.
wšdowLog
 > 
ZSTD_BTRFS_MAX_WINDOWLOG
)

37 
·¿ms
.
cP¬ams
.
wšdowLog
 = 
ZSTD_BTRFS_MAX_WINDOWLOG
;

38 
	`WARN_ON
(
¤c_Ën
 > 
ZSTD_BTRFS_MAX_INPUT
);

39  
·¿ms
;

40 
	}
}

42 
	swÜk¥aû
 {

43 *
	mmem
;

44 
size_t
 
	msize
;

45 *
	mbuf
;

46 
	mËv–
;

47 
	m»q_Ëv–
;

48 
	mÏ¡_u£d
;

49 
li¡_h—d
 
	mli¡
;

50 
li¡_h—d
 
	mÌu_li¡
;

51 
z¡d_š_bufãr
 
	mš_buf
;

52 
z¡d_out_bufãr
 
	mout_buf
;

75 
	sz¡d_wÜk¥aû_mªag”
 {

76 cÚ¡ 
bŒfs_com´ess_İ
 *
	mİs
;

77 
¥šlock_t
 
	mlock
;

78 
li¡_h—d
 
	mÌu_li¡
;

79 
li¡_h—d
 
	midË_ws
[
ZSTD_BTRFS_MAX_LEVEL
];

80 
	maùive_m­
;

81 
wa™_queue_h—d_t
 
	mwa™
;

82 
tim”_li¡
 
	mtim”
;

85 
z¡d_wÜk¥aû_mªag”
 
	gwsm
;

87 
size_t
 
	gz¡d_ws_mem_sizes
[
ZSTD_BTRFS_MAX_LEVEL
];

89 
šlše
 
wÜk¥aû
 *
	$li¡_to_wÜk¥aû
(
li¡_h—d
 *
li¡
)

91  
	`cÚš”_of
(
li¡
, 
wÜk¥aû
,†ist);

92 
	}
}

94 
z¡d_ä“_wÜk¥aû
(
li¡_h—d
 *
ws
);

95 
li¡_h—d
 *
z¡d_®loc_wÜk¥aû
(
Ëv–
);

107 
	$z¡d_»şaim_tim”_â
(
tim”_li¡
 *
tim”
)

109 
»şaim_th»shŞd
 = 
jiff›s
 - 
ZSTD_BTRFS_RECLAIM_JIFFIES
;

110 
li¡_h—d
 *
pos
, *
Ãxt
;

112 
	`¥š_lock
(&
wsm
.
lock
);

114 ià(
	`li¡_em±y
(&
wsm
.
Ìu_li¡
)) {

115 
	`¥š_uÆock
(&
wsm
.
lock
);

119 
	`li¡_fÜ_—ch_´ev_§ã
(
pos
, 
Ãxt
, &
wsm
.
Ìu_li¡
) {

120 
wÜk¥aû
 *
viùim
 = 
	`cÚš”_of
(
pos
, workspace,

121 
Ìu_li¡
);

122 
Ëv–
;

124 ià(
	`time_aá”
(
viùim
->
Ï¡_u£d
, 
»şaim_th»shŞd
))

128 ià(
viùim
->
»q_Ëv–
)

131 
Ëv–
 = 
viùim
->level;

132 
	`li¡_d–
(&
viùim
->
Ìu_li¡
);

133 
	`li¡_d–
(&
viùim
->
li¡
);

134 
	`z¡d_ä“_wÜk¥aû
(&
viùim
->
li¡
);

136 ià(
	`li¡_em±y
(&
wsm
.
idË_ws
[
Ëv–
 - 1]))

137 
	`ş—r_b™
(
Ëv–
 - 1, &
wsm
.
aùive_m­
);

141 ià(!
	`li¡_em±y
(&
wsm
.
Ìu_li¡
))

142 
	`mod_tim”
(&
wsm
.
tim”
, 
jiff›s
 + 
ZSTD_BTRFS_RECLAIM_JIFFIES
);

144 
	`¥š_uÆock
(&
wsm
.
lock
);

145 
	}
}

156 
	$z¡d_ÿlc_ws_mem_sizes
()

158 
size_t
 
max_size
 = 0;

159 
Ëv–
;

161 
Ëv–
 = 1;†ev– <ğ
ZSTD_BTRFS_MAX_LEVEL
;†evel++) {

162 
z¡d_·¿m‘”s
 
·¿ms
 =

163 
	`z¡d_g‘_bŒfs_·¿m‘”s
(
Ëv–
, 
ZSTD_BTRFS_MAX_INPUT
);

164 
size_t
 
Ëv–_size
 =

165 
	`max_t
(
size_t
,

166 
	`z¡d_c¡»am_wÜk¥aû_bound
(&
·¿ms
.
cP¬ams
),

167 
	`z¡d_d¡»am_wÜk¥aû_bound
(
ZSTD_BTRFS_MAX_INPUT
));

169 
max_size
 = 
	`max_t
(
size_t
, max_size, 
Ëv–_size
);

170 
z¡d_ws_mem_sizes
[
Ëv–
 - 1] = 
max_size
;

172 
	}
}

174 
	$z¡d_š™_wÜk¥aû_mªag”
()

176 
li¡_h—d
 *
ws
;

177 
i
;

179 
	`z¡d_ÿlc_ws_mem_sizes
();

181 
wsm
.
İs
 = &
bŒfs_z¡d_com´ess
;

182 
	`¥š_lock_š™
(&
wsm
.
lock
);

183 
	`š™_wa™queue_h—d
(&
wsm
.
wa™
);

184 
	`tim”_£tup
(&
wsm
.
tim”
, 
z¡d_»şaim_tim”_â
, 0);

186 
	`INIT_LIST_HEAD
(&
wsm
.
Ìu_li¡
);

187 
i
 = 0; i < 
ZSTD_BTRFS_MAX_LEVEL
; i++)

188 
	`INIT_LIST_HEAD
(&
wsm
.
idË_ws
[
i
]);

190 
ws
 = 
	`z¡d_®loc_wÜk¥aû
(
ZSTD_BTRFS_MAX_LEVEL
);

191 ià(
	`IS_ERR
(
ws
)) {

192 
	`´_w¬n
(

195 
	`£t_b™
(
ZSTD_BTRFS_MAX_LEVEL
 - 1, &
wsm
.
aùive_m­
);

196 
	`li¡_add
(
ws
, &
wsm
.
idË_ws
[
ZSTD_BTRFS_MAX_LEVEL
 - 1]);

198 
	}
}

200 
	$z¡d_ş—nup_wÜk¥aû_mªag”
()

202 
wÜk¥aû
 *workspace;

203 
i
;

205 
	`¥š_lock_bh
(&
wsm
.
lock
);

206 
i
 = 0; i < 
ZSTD_BTRFS_MAX_LEVEL
; i++) {

207 !
	`li¡_em±y
(&
wsm
.
idË_ws
[
i
])) {

208 
wÜk¥aû
 = 
	`cÚš”_of
(
wsm
.
idË_ws
[
i
].
Ãxt
,

209 
wÜk¥aû
, 
li¡
);

210 
	`li¡_d–
(&
wÜk¥aû
->
li¡
);

211 
	`li¡_d–
(&
wÜk¥aû
->
Ìu_li¡
);

212 
	`z¡d_ä“_wÜk¥aû
(&
wÜk¥aû
->
li¡
);

215 
	`¥š_uÆock_bh
(&
wsm
.
lock
);

217 
	`d–_tim”_sync
(&
wsm
.
tim”
);

218 
	}
}

231 
li¡_h—d
 *
	$z¡d_fšd_wÜk¥aû
(
Ëv–
)

233 
li¡_h—d
 *
ws
;

234 
wÜk¥aû
 *workspace;

235 
i
 = 
Ëv–
 - 1;

237 
	`¥š_lock_bh
(&
wsm
.
lock
);

238 
	`fÜ_—ch_£t_b™_äom
(
i
, &
wsm
.
aùive_m­
, 
ZSTD_BTRFS_MAX_LEVEL
) {

239 ià(!
	`li¡_em±y
(&
wsm
.
idË_ws
[
i
])) {

240 
ws
 = 
wsm
.
idË_ws
[
i
].
Ãxt
;

241 
wÜk¥aû
 = 
	`li¡_to_wÜk¥aû
(
ws
);

242 
	`li¡_d–_š™
(
ws
);

244 
wÜk¥aû
->
»q_Ëv–
 = 
Ëv–
;

245 ià(
Ëv–
 =ğ
wÜk¥aû
->level)

246 
	`li¡_d–
(&
wÜk¥aû
->
Ìu_li¡
);

247 ià(
	`li¡_em±y
(&
wsm
.
idË_ws
[
i
]))

248 
	`ş—r_b™
(
i
, &
wsm
.
aùive_m­
);

249 
	`¥š_uÆock_bh
(&
wsm
.
lock
);

250  
ws
;

253 
	`¥š_uÆock_bh
(&
wsm
.
lock
);

255  
NULL
;

256 
	}
}

267 
li¡_h—d
 *
	$z¡d_g‘_wÜk¥aû
(
Ëv–
)

269 
li¡_h—d
 *
ws
;

270 
nofs_æag
;

273 ià(!
Ëv–
)

274 
Ëv–
 = 1;

276 
agaš
:

277 
ws
 = 
	`z¡d_fšd_wÜk¥aû
(
Ëv–
);

278 ià(
ws
)

279  
ws
;

281 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

282 
ws
 = 
	`z¡d_®loc_wÜk¥aû
(
Ëv–
);

283 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

285 ià(
	`IS_ERR
(
ws
)) {

286 
	`DEFINE_WAIT
(
wa™
);

288 
	`´•¬e_to_wa™
(&
wsm
.
wa™
, &wa™, 
TASK_UNINTERRUPTIBLE
);

289 
	`scheduË
();

290 
	`fšish_wa™
(&
wsm
.
wa™
, &wait);

292 
agaš
;

295  
ws
;

296 
	}
}

308 
	$z¡d_put_wÜk¥aû
(
li¡_h—d
 *
ws
)

310 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_to_wÜk¥aû
(
ws
);

312 
	`¥š_lock_bh
(&
wsm
.
lock
);

315 ià(
wÜk¥aû
->
»q_Ëv–
 =ğwÜk¥aû->
Ëv–
) {

317 ià(
	`li¡_em±y
(&
wsm
.
idË_ws
[
ZSTD_BTRFS_MAX_LEVEL
 - 1])) {

318 
	`INIT_LIST_HEAD
(&
wÜk¥aû
->
Ìu_li¡
);

320 
wÜk¥aû
->
Ï¡_u£d
 = 
jiff›s
;

321 
	`li¡_add
(&
wÜk¥aû
->
Ìu_li¡
, &
wsm
.lru_list);

322 ià(!
	`tim”_³ndšg
(&
wsm
.
tim”
))

323 
	`mod_tim”
(&
wsm
.
tim”
,

324 
jiff›s
 + 
ZSTD_BTRFS_RECLAIM_JIFFIES
);

328 
	`£t_b™
(
wÜk¥aû
->
Ëv–
 - 1, &
wsm
.
aùive_m­
);

329 
	`li¡_add
(&
wÜk¥aû
->
li¡
, &
wsm
.
idË_ws
[wÜk¥aû->
Ëv–
 - 1]);

330 
wÜk¥aû
->
»q_Ëv–
 = 0;

332 
	`¥š_uÆock_bh
(&
wsm
.
lock
);

334 ià(
wÜk¥aû
->
Ëv–
 =ğ
ZSTD_BTRFS_MAX_LEVEL
)

335 
	`cÚd_wake_up
(&
wsm
.
wa™
);

336 
	}
}

338 
	$z¡d_ä“_wÜk¥aû
(
li¡_h—d
 *
ws
)

340 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

342 
	`kvä“
(
wÜk¥aû
->
mem
);

343 
	`kä“
(
wÜk¥aû
->
buf
);

344 
	`kä“
(
wÜk¥aû
);

345 
	}
}

347 
li¡_h—d
 *
	$z¡d_®loc_wÜk¥aû
(
Ëv–
)

349 
wÜk¥aû
 *workspace;

351 
wÜk¥aû
 = 
	`kz®loc
((*wÜk¥aû), 
GFP_KERNEL
);

352 ià(!
wÜk¥aû
)

353  
	`ERR_PTR
(-
ENOMEM
);

355 
wÜk¥aû
->
size
 = 
z¡d_ws_mem_sizes
[
Ëv–
 - 1];

356 
wÜk¥aû
->
Ëv–
 =†evel;

357 
wÜk¥aû
->
»q_Ëv–
 = 
Ëv–
;

358 
wÜk¥aû
->
Ï¡_u£d
 = 
jiff›s
;

359 
wÜk¥aû
->
mem
 = 
	`kvm®loc
(wÜk¥aû->
size
, 
GFP_KERNEL
 | 
__GFP_NOWARN
);

360 
wÜk¥aû
->
buf
 = 
	`km®loc
(
PAGE_SIZE
, 
GFP_KERNEL
);

361 ià(!
wÜk¥aû
->
mem
 || !wÜk¥aû->
buf
)

362 
ç
;

364 
	`INIT_LIST_HEAD
(&
wÜk¥aû
->
li¡
);

365 
	`INIT_LIST_HEAD
(&
wÜk¥aû
->
Ìu_li¡
);

367  &
wÜk¥aû
->
li¡
;

368 
ç
:

369 
	`z¡d_ä“_wÜk¥aû
(&
wÜk¥aû
->
li¡
);

370  
	`ERR_PTR
(-
ENOMEM
);

371 
	}
}

373 
	$z¡d_com´ess_·ges
(
li¡_h—d
 *
ws
, 
add»ss_¥aû
 *
m­pšg
,

374 
u64
 
¡¬t
, 
·ge
 **
·ges
, *
out_·ges
,

375 *
tÙ®_š
, *
tÙ®_out
)

377 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

378 
z¡d_c¡»am
 *
¡»am
;

379 
»t
 = 0;

380 
Ä_·ges
 = 0;

381 
·ge
 *
š_·ge
 = 
NULL
;

382 
·ge
 *
out_·ge
 = 
NULL
;

383 
tÙ_š
 = 0;

384 
tÙ_out
 = 0;

385 
Ën
 = *
tÙ®_out
;

386 cÚ¡ 
Ä_de¡_·ges
 = *
out_·ges
;

387 
max_out
 = 
Ä_de¡_·ges
 * 
PAGE_SIZE
;

388 
z¡d_·¿m‘”s
 
·¿ms
 = 
	`z¡d_g‘_bŒfs_·¿m‘”s
(
wÜk¥aû
->
»q_Ëv–
,

389 
Ën
);

391 *
out_·ges
 = 0;

392 *
tÙ®_out
 = 0;

393 *
tÙ®_š
 = 0;

396 
¡»am
 = 
	`z¡d_š™_c¡»am
(&
·¿ms
, 
Ën
, 
wÜk¥aû
->
mem
,

397 
wÜk¥aû
->
size
);

398 ià(!
¡»am
) {

399 
	`´_w¬n
("BTRFS: zstd_init_cstream failed\n");

400 
»t
 = -
EIO
;

401 
out
;

405 
š_·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
, 
¡¬t
 >> 
PAGE_SHIFT
);

406 
wÜk¥aû
->
š_buf
.
¤c
 = 
	`km­_loÿl_·ge
(
š_·ge
);

407 
wÜk¥aû
->
š_buf
.
pos
 = 0;

408 
wÜk¥aû
->
š_buf
.
size
 = 
	`mš_t
(
size_t
, 
Ën
, 
PAGE_SIZE
);

412 
out_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
);

413 ià(
out_·ge
 =ğ
NULL
) {

414 
»t
 = -
ENOMEM
;

415 
out
;

417 
·ges
[
Ä_·ges
++] = 
out_·ge
;

418 
wÜk¥aû
->
out_buf
.
d¡
 = 
	`·ge_add»ss
(
out_·ge
);

419 
wÜk¥aû
->
out_buf
.
pos
 = 0;

420 
wÜk¥aû
->
out_buf
.
size
 = 
	`mš_t
(
size_t
, 
max_out
, 
PAGE_SIZE
);

423 
size_t
 
»t2
;

425 
»t2
 = 
	`z¡d_com´ess_¡»am
(
¡»am
, &
wÜk¥aû
->
out_buf
,

426 &
wÜk¥aû
->
š_buf
);

427 ià(
	`z¡d_is_”rÜ
(
»t2
)) {

428 
	`´_debug
("BTRFS: zstd_compress_stream„eturned %d\n",

429 
	`z¡d_g‘_”rÜ_code
(
»t2
));

430 
»t
 = -
EIO
;

431 
out
;

435 ià(
tÙ_š
 + 
wÜk¥aû
->
š_buf
.
pos
 > 8192 &&

436 
tÙ_š
 + 
wÜk¥aû
->
š_buf
.
pos
 <

437 
tÙ_out
 + 
wÜk¥aû
->
out_buf
.
pos
) {

438 
»t
 = -
E2BIG
;

439 
out
;

443 ià(
wÜk¥aû
->
out_buf
.
pos
 >ğ
max_out
) {

444 
tÙ_out
 +ğ
wÜk¥aû
->
out_buf
.
pos
;

445 
»t
 = -
E2BIG
;

446 
out
;

450 ià(
wÜk¥aû
->
out_buf
.
pos
 =ğwÜk¥aû->out_buf.
size
) {

451 
tÙ_out
 +ğ
PAGE_SIZE
;

452 
max_out
 -ğ
PAGE_SIZE
;

453 ià(
Ä_·ges
 =ğ
Ä_de¡_·ges
) {

454 
»t
 = -
E2BIG
;

455 
out
;

457 
out_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
);

458 ià(
out_·ge
 =ğ
NULL
) {

459 
»t
 = -
ENOMEM
;

460 
out
;

462 
·ges
[
Ä_·ges
++] = 
out_·ge
;

463 
wÜk¥aû
->
out_buf
.
d¡
 = 
	`·ge_add»ss
(
out_·ge
);

464 
wÜk¥aû
->
out_buf
.
pos
 = 0;

465 
wÜk¥aû
->
out_buf
.
size
 = 
	`mš_t
(
size_t
, 
max_out
,

466 
PAGE_SIZE
);

470 ià(
wÜk¥aû
->
š_buf
.
pos
 >ğ
Ën
) {

471 
tÙ_š
 +ğ
wÜk¥aû
->
š_buf
.
pos
;

476 ià(
wÜk¥aû
->
š_buf
.
pos
 =ğwÜk¥aû->š_buf.
size
) {

477 
tÙ_š
 +ğ
PAGE_SIZE
;

478 
	`kunm­_loÿl
(
wÜk¥aû
->
š_buf
.
¤c
);

479 
	`put_·ge
(
š_·ge
);

480 
¡¬t
 +ğ
PAGE_SIZE
;

481 
Ën
 -ğ
PAGE_SIZE
;

482 
š_·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
, 
¡¬t
 >> 
PAGE_SHIFT
);

483 
wÜk¥aû
->
š_buf
.
¤c
 = 
	`km­_loÿl_·ge
(
š_·ge
);

484 
wÜk¥aû
->
š_buf
.
pos
 = 0;

485 
wÜk¥aû
->
š_buf
.
size
 = 
	`mš_t
(
size_t
, 
Ën
, 
PAGE_SIZE
);

489 
size_t
 
»t2
;

491 
»t2
 = 
	`z¡d_’d_¡»am
(
¡»am
, &
wÜk¥aû
->
out_buf
);

492 ià(
	`z¡d_is_”rÜ
(
»t2
)) {

493 
	`´_debug
("BTRFS: zstd_end_stream„eturned %d\n",

494 
	`z¡d_g‘_”rÜ_code
(
»t2
));

495 
»t
 = -
EIO
;

496 
out
;

498 ià(
»t2
 == 0) {

499 
tÙ_out
 +ğ
wÜk¥aû
->
out_buf
.
pos
;

502 ià(
wÜk¥aû
->
out_buf
.
pos
 >ğ
max_out
) {

503 
tÙ_out
 +ğ
wÜk¥aû
->
out_buf
.
pos
;

504 
»t
 = -
E2BIG
;

505 
out
;

508 
tÙ_out
 +ğ
PAGE_SIZE
;

509 
max_out
 -ğ
PAGE_SIZE
;

510 ià(
Ä_·ges
 =ğ
Ä_de¡_·ges
) {

511 
»t
 = -
E2BIG
;

512 
out
;

514 
out_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
);

515 ià(
out_·ge
 =ğ
NULL
) {

516 
»t
 = -
ENOMEM
;

517 
out
;

519 
·ges
[
Ä_·ges
++] = 
out_·ge
;

520 
wÜk¥aû
->
out_buf
.
d¡
 = 
	`·ge_add»ss
(
out_·ge
);

521 
wÜk¥aû
->
out_buf
.
pos
 = 0;

522 
wÜk¥aû
->
out_buf
.
size
 = 
	`mš_t
(
size_t
, 
max_out
, 
PAGE_SIZE
);

525 ià(
tÙ_out
 >ğ
tÙ_š
) {

526 
»t
 = -
E2BIG
;

527 
out
;

530 
»t
 = 0;

531 *
tÙ®_š
 = 
tÙ_š
;

532 *
tÙ®_out
 = 
tÙ_out
;

533 
out
:

534 *
out_·ges
 = 
Ä_·ges
;

535 ià(
wÜk¥aû
->
š_buf
.
¤c
) {

536 
	`kunm­_loÿl
(
wÜk¥aû
->
š_buf
.
¤c
);

537 
	`put_·ge
(
š_·ge
);

539  
»t
;

540 
	}
}

542 
	$z¡d_decom´ess_bio
(
li¡_h—d
 *
ws
, 
com´es£d_bio
 *
cb
)

544 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

545 
·ge
 **
·ges_š
 = 
cb
->
com´es£d_·ges
;

546 
size_t
 
¤ş’
 = 
cb
->
com´es£d_Ën
;

547 
z¡d_d¡»am
 *
¡»am
;

548 
»t
 = 0;

549 
·ge_š_šdex
 = 0;

550 
tÙ®_·ges_š
 = 
	`DIV_ROUND_UP
(
¤ş’
, 
PAGE_SIZE
);

551 
buf_¡¬t
;

552 
tÙ®_out
 = 0;

554 
¡»am
 = 
	`z¡d_š™_d¡»am
(

555 
ZSTD_BTRFS_MAX_INPUT
, 
wÜk¥aû
->
mem
, wÜk¥aû->
size
);

556 ià(!
¡»am
) {

557 
	`´_debug
("BTRFS: zstd_init_dstream failed\n");

558 
»t
 = -
EIO
;

559 
dÚe
;

562 
wÜk¥aû
->
š_buf
.
¤c
 = 
	`km­_loÿl_·ge
(
·ges_š
[
·ge_š_šdex
]);

563 
wÜk¥aû
->
š_buf
.
pos
 = 0;

564 
wÜk¥aû
->
š_buf
.
size
 = 
	`mš_t
(
size_t
, 
¤ş’
, 
PAGE_SIZE
);

566 
wÜk¥aû
->
out_buf
.
d¡
 = wÜk¥aû->
buf
;

567 
wÜk¥aû
->
out_buf
.
pos
 = 0;

568 
wÜk¥aû
->
out_buf
.
size
 = 
PAGE_SIZE
;

571 
size_t
 
»t2
;

573 
»t2
 = 
	`z¡d_decom´ess_¡»am
(
¡»am
, &
wÜk¥aû
->
out_buf
,

574 &
wÜk¥aû
->
š_buf
);

575 ià(
	`z¡d_is_”rÜ
(
»t2
)) {

576 
	`´_debug
("BTRFS: zstd_decompress_stream„eturned %d\n",

577 
	`z¡d_g‘_”rÜ_code
(
»t2
));

578 
»t
 = -
EIO
;

579 
dÚe
;

581 
buf_¡¬t
 = 
tÙ®_out
;

582 
tÙ®_out
 +ğ
wÜk¥aû
->
out_buf
.
pos
;

583 
wÜk¥aû
->
out_buf
.
pos
 = 0;

585 
»t
 = 
	`bŒfs_decom´ess_buf2·ge
(
wÜk¥aû
->
out_buf
.
d¡
,

586 
tÙ®_out
 - 
buf_¡¬t
, 
cb
, buf_start);

587 ià(
»t
 == 0)

590 ià(
wÜk¥aû
->
š_buf
.
pos
 >ğ
¤ş’
)

594 ià(
»t2
 == 0)

597 ià(
wÜk¥aû
->
š_buf
.
pos
 =ğwÜk¥aû->š_buf.
size
) {

598 
	`kunm­_loÿl
(
wÜk¥aû
->
š_buf
.
¤c
);

599 
·ge_š_šdex
++;

600 ià(
·ge_š_šdex
 >ğ
tÙ®_·ges_š
) {

601 
wÜk¥aû
->
š_buf
.
¤c
 = 
NULL
;

602 
»t
 = -
EIO
;

603 
dÚe
;

605 
¤ş’
 -ğ
PAGE_SIZE
;

606 
wÜk¥aû
->
š_buf
.
¤c
 = 
	`km­_loÿl_·ge
(
·ges_š
[
·ge_š_šdex
]);

607 
wÜk¥aû
->
š_buf
.
pos
 = 0;

608 
wÜk¥aû
->
š_buf
.
size
 = 
	`mš_t
(
size_t
, 
¤ş’
, 
PAGE_SIZE
);

611 
»t
 = 0;

612 
dÚe
:

613 ià(
wÜk¥aû
->
š_buf
.
¤c
)

614 
	`kunm­_loÿl
(
wÜk¥aû
->
š_buf
.
¤c
);

615  
»t
;

616 
	}
}

618 
	$z¡d_decom´ess
(
li¡_h—d
 *
ws
, cÚ¡ 
u8
 *
d©a_š
,

619 
·ge
 *
de¡_·ge
, 
¡¬t_by‹
, 
size_t
 
¤ş’
,

620 
size_t
 
de¡Ën
)

622 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

623 
z¡d_d¡»am
 *
¡»am
;

624 
»t
 = 0;

625 
size_t
 
»t2
;

626 
tÙ®_out
 = 0;

627 
pg_off£t
 = 0;

629 
¡»am
 = 
	`z¡d_š™_d¡»am
(

630 
ZSTD_BTRFS_MAX_INPUT
, 
wÜk¥aû
->
mem
, wÜk¥aû->
size
);

631 ià(!
¡»am
) {

632 
	`´_w¬n
("BTRFS: zstd_init_dstream failed\n");

633 
»t
 = -
EIO
;

634 
fšish
;

637 
de¡Ën
 = 
	`mš_t
(
size_t
, de¡Ën, 
PAGE_SIZE
);

639 
wÜk¥aû
->
š_buf
.
¤c
 = 
d©a_š
;

640 
wÜk¥aû
->
š_buf
.
pos
 = 0;

641 
wÜk¥aû
->
š_buf
.
size
 = 
¤ş’
;

643 
wÜk¥aû
->
out_buf
.
d¡
 = wÜk¥aû->
buf
;

644 
wÜk¥aû
->
out_buf
.
pos
 = 0;

645 
wÜk¥aû
->
out_buf
.
size
 = 
PAGE_SIZE
;

647 
»t2
 = 1;

648 
pg_off£t
 < 
de¡Ën


649 && 
wÜk¥aû
->
š_buf
.
pos
 < wÜk¥aû->š_buf.
size
) {

650 
buf_¡¬t
;

651 
buf_off£t
;

652 
by‹s
;

655 ià(
»t2
 == 0) {

656 
	`´_debug
("BTRFS: zstd_decompress_streamƒndedƒarly\n");

657 
»t
 = -
EIO
;

658 
fšish
;

660 
»t2
 = 
	`z¡d_decom´ess_¡»am
(
¡»am
, &
wÜk¥aû
->
out_buf
,

661 &
wÜk¥aû
->
š_buf
);

662 ià(
	`z¡d_is_”rÜ
(
»t2
)) {

663 
	`´_debug
("BTRFS: zstd_decompress_stream„eturned %d\n",

664 
	`z¡d_g‘_”rÜ_code
(
»t2
));

665 
»t
 = -
EIO
;

666 
fšish
;

669 
buf_¡¬t
 = 
tÙ®_out
;

670 
tÙ®_out
 +ğ
wÜk¥aû
->
out_buf
.
pos
;

671 
wÜk¥aû
->
out_buf
.
pos
 = 0;

673 ià(
tÙ®_out
 <ğ
¡¬t_by‹
)

676 ià(
tÙ®_out
 > 
¡¬t_by‹
 && 
buf_¡¬t
 < start_byte)

677 
buf_off£t
 = 
¡¬t_by‹
 - 
buf_¡¬t
;

679 
buf_off£t
 = 0;

681 
by‹s
 = 
	`mš_t
(, 
de¡Ën
 - 
pg_off£t
,

682 
wÜk¥aû
->
out_buf
.
size
 - 
buf_off£t
);

684 
	`memıy_to_·ge
(
de¡_·ge
, 
pg_off£t
,

685 
wÜk¥aû
->
out_buf
.
d¡
 + 
buf_off£t
, 
by‹s
);

687 
pg_off£t
 +ğ
by‹s
;

689 
»t
 = 0;

690 
fšish
:

691 ià(
pg_off£t
 < 
de¡Ën
) {

692 
	`memz”o_·ge
(
de¡_·ge
, 
pg_off£t
, 
de¡Ën
 -…g_offset);

694  
»t
;

695 
	}
}

697 cÚ¡ 
bŒfs_com´ess_İ
 
	gbŒfs_z¡d_com´ess
 = {

699 .
wÜk¥aû_mªag”
 = 
NULL
,

700 .
	gmax_Ëv–
 = 
ZSTD_BTRFS_MAX_LEVEL
,

701 .
	gdeçuÉ_Ëv–
 = 
ZSTD_BTRFS_DEFAULT_LEVEL
,

	@/usr/include/linux/btrfs.h

20 #iâdeà
_LINUX_BTRFS_H


21 
	#_LINUX_BTRFS_H


	)

22 
	~<lšux/ty³s.h
>

23 
	~<lšux/ioùl.h
>

25 
	#BTRFS_IOCTL_MAGIC
 0x94

	)

26 
	#BTRFS_VOL_NAME_MAX
 255

	)

27 
	#BTRFS_LABEL_SIZE
 256

	)

30 
	#BTRFS_PATH_NAME_MAX
 4087

	)

31 
	sbŒfs_ioùl_vŞ_¬gs
 {

32 
__s64
 
	mfd
;

33 
	mÇme
[
BTRFS_PATH_NAME_MAX
 + 1];

36 
	#BTRFS_DEVICE_PATH_NAME_MAX
 1024

	)

37 
	#BTRFS_SUBVOL_NAME_MAX
 4039

	)

40 
	#BTRFS_SUBVOL_CREATE_ASYNC
 (1ULL << 0)

	)

41 
	#BTRFS_SUBVOL_RDONLY
 (1ULL << 1)

	)

42 
	#BTRFS_SUBVOL_QGROUP_INHERIT
 (1ULL << 2)

	)

44 
	#BTRFS_DEVICE_SPEC_BY_ID
 (1ULL << 3)

	)

46 
	#BTRFS_SUBVOL_SPEC_BY_ID
 (1ULL << 4)

	)

48 
	#BTRFS_VOL_ARG_V2_FLAGS_SUPPORTED
 \

49 (
BTRFS_SUBVOL_RDONLY
 | \

50 
BTRFS_SUBVOL_QGROUP_INHERIT
 | \

51 
BTRFS_DEVICE_SPEC_BY_ID
 | \

52 
BTRFS_SUBVOL_SPEC_BY_ID
)

	)

54 
	#BTRFS_FSID_SIZE
 16

	)

55 
	#BTRFS_UUID_SIZE
 16

	)

56 
	#BTRFS_UUID_UNPARSED_SIZE
 37

	)

65 
	#BTRFS_QGROUP_LIMIT_MAX_RFER
 (1ULL << 0)

	)

66 
	#BTRFS_QGROUP_LIMIT_MAX_EXCL
 (1ULL << 1)

	)

67 
	#BTRFS_QGROUP_LIMIT_RSV_RFER
 (1ULL << 2)

	)

68 
	#BTRFS_QGROUP_LIMIT_RSV_EXCL
 (1ULL << 3)

	)

69 
	#BTRFS_QGROUP_LIMIT_RFER_CMPR
 (1ULL << 4)

	)

70 
	#BTRFS_QGROUP_LIMIT_EXCL_CMPR
 (1ULL << 5)

	)

72 
	sbŒfs_qgroup_lim™
 {

73 
__u64
 
	mæags
;

74 
__u64
 
	mmax_rãr
;

75 
__u64
 
	mmax_exş
;

76 
__u64
 
	mrsv_rãr
;

77 
__u64
 
	mrsv_exş
;

86 
	#BTRFS_QGROUP_INHERIT_SET_LIMITS
 (1ULL << 0)

	)

88 
	sbŒfs_qgroup_šh”™
 {

89 
__u64
 
	mæags
;

90 
__u64
 
	mnum_qgroups
;

91 
__u64
 
	mnum_»f_cİ›s
;

92 
__u64
 
	mnum_exş_cİ›s
;

93 
bŒfs_qgroup_lim™
 
	mlim
;

94 
__u64
 
	mqgroups
[0];

97 
	sbŒfs_ioùl_qgroup_lim™_¬gs
 {

98 
__u64
 
	mqgroupid
;

99 
bŒfs_qgroup_lim™
 
	mlim
;

114 
	#BTRFS_DEVICE_REMOVE_ARGS_MASK
 \

115 (
BTRFS_DEVICE_SPEC_BY_ID
)

	)

118 
	#BTRFS_SUBVOL_CREATE_ARGS_MASK
 \

119 (
BTRFS_SUBVOL_RDONLY
 | \

120 
BTRFS_SUBVOL_QGROUP_INHERIT
)

	)

123 
	#BTRFS_SUBVOL_DELETE_ARGS_MASK
 \

124 (
BTRFS_SUBVOL_SPEC_BY_ID
)

	)

126 
	sbŒfs_ioùl_vŞ_¬gs_v2
 {

127 
__s64
 
	mfd
;

128 
__u64
 
	mŒªsid
;

129 
__u64
 
	mæags
;

132 
__u64
 
	msize
;

133 
bŒfs_qgroup_šh”™
 *
	mqgroup_šh”™
;

135 
__u64
 
	munu£d
[4];

138 
	mÇme
[
BTRFS_SUBVOL_NAME_MAX
 + 1];

139 
__u64
 
	mdevid
;

140 
__u64
 
	msubvŞid
;

148 
	sbŒfs_süub_´og»ss
 {

149 
__u64
 
	md©a_ex‹Ás_süubbed
;

150 
__u64
 
	mŒ“_ex‹Ás_süubbed
;

151 
__u64
 
	md©a_by‹s_süubbed
;

152 
__u64
 
	mŒ“_by‹s_süubbed
;

153 
__u64
 
	m»ad_”rÜs
;

154 
__u64
 
	mcsum_”rÜs
;

155 
__u64
 
	mv”ify_”rÜs
;

159 
__u64
 
	mno_csum
;

162 
__u64
 
	mcsum_disÿrds
;

164 
__u64
 
	msu³r_”rÜs
;

165 
__u64
 
	mm®loc_”rÜs
;

168 
__u64
 
	muncÜ»ùabË_”rÜs
;

171 
__u64
 
	mcÜ»ùed_”rÜs
;

172 
__u64
 
	mÏ¡_physiÿl
;

175 
__u64
 
	munv”if›d_”rÜs
;

181 
	#BTRFS_SCRUB_READONLY
 1

	)

182 
	#BTRFS_SCRUB_SUPPORTED_FLAGS
 (
BTRFS_SCRUB_READONLY
)

	)

183 
	sbŒfs_ioùl_süub_¬gs
 {

184 
__u64
 
	mdevid
;

185 
__u64
 
	m¡¬t
;

186 
__u64
 
	m’d
;

187 
__u64
 
	mæags
;

188 
bŒfs_süub_´og»ss
 
	m´og»ss
;

190 
__u64
 
	munu£d
[(1024-32-(
bŒfs_süub_´og»ss
))/8];

193 
	#BTRFS_IOCTL_DEV_REPLACE_CONT_READING_FROM_SRCDEV_MODE_ALWAYS
 0

	)

194 
	#BTRFS_IOCTL_DEV_REPLACE_CONT_READING_FROM_SRCDEV_MODE_AVOID
 1

	)

195 
	sbŒfs_ioùl_dev_»¶aû_¡¬t_·¿ms
 {

196 
__u64
 
	m¤cdevid
;

197 
__u64
 
	mcÚt_»adšg_äom_¤cdev_mode
;

199 
__u8
 
	m¤cdev_Çme
[
BTRFS_DEVICE_PATH_NAME_MAX
 + 1];

200 
__u8
 
	mtgtdev_Çme
[
BTRFS_DEVICE_PATH_NAME_MAX
 + 1];

203 
	#BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
 0

	)

204 
	#BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
 1

	)

205 
	#BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
 2

	)

206 
	#BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
 3

	)

207 
	#BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
 4

	)

208 
	sbŒfs_ioùl_dev_»¶aû_¡©us_·¿ms
 {

209 
__u64
 
	m»¶aû_¡©e
;

210 
__u64
 
	m´og»ss_1000
;

211 
__u64
 
	mtime_¡¬‹d
;

212 
__u64
 
	mtime_¡İ³d
;

213 
__u64
 
	mnum_wr™e_”rÜs
;

214 
__u64
 
	mnum_uncÜ»ùabË_»ad_”rÜs
;

217 
	#BTRFS_IOCTL_DEV_REPLACE_CMD_START
 0

	)

218 
	#BTRFS_IOCTL_DEV_REPLACE_CMD_STATUS
 1

	)

219 
	#BTRFS_IOCTL_DEV_REPLACE_CMD_CANCEL
 2

	)

220 
	#BTRFS_IOCTL_DEV_REPLACE_RESULT_NO_ERROR
 0

	)

221 
	#BTRFS_IOCTL_DEV_REPLACE_RESULT_NOT_STARTED
 1

	)

222 
	#BTRFS_IOCTL_DEV_REPLACE_RESULT_ALREADY_STARTED
 2

	)

223 
	#BTRFS_IOCTL_DEV_REPLACE_RESULT_SCRUB_INPROGRESS
 3

	)

224 
	sbŒfs_ioùl_dev_»¶aû_¬gs
 {

225 
__u64
 
	mcmd
;

226 
__u64
 
	m»suÉ
;

229 
bŒfs_ioùl_dev_»¶aû_¡¬t_·¿ms
 
	m¡¬t
;

230 
bŒfs_ioùl_dev_»¶aû_¡©us_·¿ms
 
	m¡©us
;

233 
__u64
 
	m¥¬e
[64];

236 
	sbŒfs_ioùl_dev_šfo_¬gs
 {

237 
__u64
 
	mdevid
;

238 
__u8
 
	muuid
[
BTRFS_UUID_SIZE
];

239 
__u64
 
	mby‹s_u£d
;

240 
__u64
 
	mtÙ®_by‹s
;

241 
__u64
 
	munu£d
[379];

242 
__u8
 
	m·th
[
BTRFS_DEVICE_PATH_NAME_MAX
];

250 
	#BTRFS_FS_INFO_FLAG_CSUM_INFO
 (1 << 0)

	)

253 
	#BTRFS_FS_INFO_FLAG_GENERATION
 (1 << 1)

	)

255 
	#BTRFS_FS_INFO_FLAG_METADATA_UUID
 (1 << 2)

	)

257 
	sbŒfs_ioùl_fs_šfo_¬gs
 {

258 
__u64
 
	mmax_id
;

259 
__u64
 
	mnum_deviûs
;

260 
__u8
 
	mfsid
[
BTRFS_FSID_SIZE
];

261 
__u32
 
	mnodesize
;

262 
__u32
 
	m£ùÜsize
;

263 
__u32
 
	mşÚe_®ignm’t
;

265 
__u16
 
	mcsum_ty³
;

266 
__u16
 
	mcsum_size
;

267 
__u64
 
	mæags
;

268 
__u64
 
	mg’”©iÚ
;

269 
__u8
 
	mm‘ad©a_uuid
[
BTRFS_FSID_SIZE
];

270 
__u8
 
	m»£rved
[944];

279 
	#BTRFS_FEATURE_COMPAT_RO_FREE_SPACE_TREE
 (1ULL << 0)

	)

289 
	#BTRFS_FEATURE_COMPAT_RO_FREE_SPACE_TREE_VALID
 (1ULL << 1)

	)

290 
	#BTRFS_FEATURE_COMPAT_RO_VERITY
 (1ULL << 2)

	)

292 
	#BTRFS_FEATURE_INCOMPAT_MIXED_BACKREF
 (1ULL << 0)

	)

293 
	#BTRFS_FEATURE_INCOMPAT_DEFAULT_SUBVOL
 (1ULL << 1)

	)

294 
	#BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
 (1ULL << 2)

	)

295 
	#BTRFS_FEATURE_INCOMPAT_COMPRESS_LZO
 (1ULL << 3)

	)

296 
	#BTRFS_FEATURE_INCOMPAT_COMPRESS_ZSTD
 (1ULL << 4)

	)

302 
	#BTRFS_FEATURE_INCOMPAT_BIG_METADATA
 (1ULL << 5)

	)

304 
	#BTRFS_FEATURE_INCOMPAT_EXTENDED_IREF
 (1ULL << 6)

	)

305 
	#BTRFS_FEATURE_INCOMPAT_RAID56
 (1ULL << 7)

	)

306 
	#BTRFS_FEATURE_INCOMPAT_SKINNY_METADATA
 (1ULL << 8)

	)

307 
	#BTRFS_FEATURE_INCOMPAT_NO_HOLES
 (1ULL << 9)

	)

308 
	#BTRFS_FEATURE_INCOMPAT_METADATA_UUID
 (1ULL << 10)

	)

309 
	#BTRFS_FEATURE_INCOMPAT_RAID1C34
 (1ULL << 11)

	)

310 
	#BTRFS_FEATURE_INCOMPAT_ZONED
 (1ULL << 12)

	)

311 
	#BTRFS_FEATURE_INCOMPAT_EXTENT_TREE_V2
 (1ULL << 13)

	)

313 
	sbŒfs_ioùl_ã©u»_æags
 {

314 
__u64
 
	mcom·t_æags
;

315 
__u64
 
	mcom·t_ro_æags
;

316 
__u64
 
	mšcom·t_æags
;

320 
	#BTRFS_BALANCE_CTL_PAUSE
 1

	)

321 
	#BTRFS_BALANCE_CTL_CANCEL
 2

	)

327 
	sbŒfs_b®ªû_¬gs
 {

328 
__u64
 
	m´ofes
;

330 
__u64
 
	mu§ge
;

332 
__u32
 
	mu§ge_mš
;

333 
__u32
 
	mu§ge_max
;

336 
__u64
 
	mdevid
;

337 
__u64
 
	mp¡¬t
;

338 
__u64
 
	m³nd
;

339 
__u64
 
	mv¡¬t
;

340 
__u64
 
	mv’d
;

342 
__u64
 
	mrg‘
;

344 
__u64
 
	mæags
;

352 
__u64
 
	mlim™
;

354 
__u32
 
	mlim™_mš
;

355 
__u32
 
	mlim™_max
;

363 
__u32
 
	m¡res_mš
;

364 
__u32
 
	m¡res_max
;

366 
__u64
 
	munu£d
[6];

367 } 
__©Œibu‹__
 ((
__·cked__
));

370 
	sbŒfs_b®ªû_´og»ss
 {

371 
__u64
 
	mex³ùed
;

373 
__u64
 
	mcÚsid”ed
;

374 
__u64
 
	mcom¶‘ed
;

386 
	#BTRFS_BALANCE_DATA
 (1ULL << 0)

	)

387 
	#BTRFS_BALANCE_SYSTEM
 (1ULL << 1)

	)

388 
	#BTRFS_BALANCE_METADATA
 (1ULL << 2)

	)

390 
	#BTRFS_BALANCE_TYPE_MASK
 (
BTRFS_BALANCE_DATA
 | \

391 
BTRFS_BALANCE_SYSTEM
 | \

392 
BTRFS_BALANCE_METADATA
)

	)

394 
	#BTRFS_BALANCE_FORCE
 (1ULL << 3)

	)

395 
	#BTRFS_BALANCE_RESUME
 (1ULL << 4)

	)

405 
	#BTRFS_BALANCE_ARGS_PROFILES
 (1ULL << 0)

	)

406 
	#BTRFS_BALANCE_ARGS_USAGE
 (1ULL << 1)

	)

407 
	#BTRFS_BALANCE_ARGS_DEVID
 (1ULL << 2)

	)

408 
	#BTRFS_BALANCE_ARGS_DRANGE
 (1ULL << 3)

	)

409 
	#BTRFS_BALANCE_ARGS_VRANGE
 (1ULL << 4)

	)

410 
	#BTRFS_BALANCE_ARGS_LIMIT
 (1ULL << 5)

	)

411 
	#BTRFS_BALANCE_ARGS_LIMIT_RANGE
 (1ULL << 6)

	)

412 
	#BTRFS_BALANCE_ARGS_STRIPES_RANGE
 (1ULL << 7)

	)

413 
	#BTRFS_BALANCE_ARGS_USAGE_RANGE
 (1ULL << 10)

	)

415 
	#BTRFS_BALANCE_ARGS_MASK
 \

416 (
BTRFS_BALANCE_ARGS_PROFILES
 | \

417 
BTRFS_BALANCE_ARGS_USAGE
 | \

418 
BTRFS_BALANCE_ARGS_DEVID
 | \

419 
BTRFS_BALANCE_ARGS_DRANGE
 | \

420 
BTRFS_BALANCE_ARGS_VRANGE
 | \

421 
BTRFS_BALANCE_ARGS_LIMIT
 | \

422 
BTRFS_BALANCE_ARGS_LIMIT_RANGE
 | \

423 
BTRFS_BALANCE_ARGS_STRIPES_RANGE
 | \

424 
BTRFS_BALANCE_ARGS_USAGE_RANGE
)

	)

431 
	#BTRFS_BALANCE_ARGS_CONVERT
 (1ULL << 8)

	)

432 
	#BTRFS_BALANCE_ARGS_SOFT
 (1ULL << 9)

	)

441 
	#BTRFS_BALANCE_STATE_RUNNING
 (1ULL << 0)

	)

442 
	#BTRFS_BALANCE_STATE_PAUSE_REQ
 (1ULL << 1)

	)

443 
	#BTRFS_BALANCE_STATE_CANCEL_REQ
 (1ULL << 2)

	)

445 
	sbŒfs_ioùl_b®ªû_¬gs
 {

446 
__u64
 
	mæags
;

447 
__u64
 
	m¡©e
;

449 
bŒfs_b®ªû_¬gs
 
	md©a
;

450 
bŒfs_b®ªû_¬gs
 
	mm‘a
;

451 
bŒfs_b®ªû_¬gs
 
	msys
;

453 
bŒfs_b®ªû_´og»ss
 
	m¡©
;

455 
__u64
 
	munu£d
[72];

458 
	#BTRFS_INO_LOOKUP_PATH_MAX
 4080

	)

459 
	sbŒfs_ioùl_šo_lookup_¬gs
 {

460 
__u64
 
	mŒ“id
;

461 
__u64
 
	mobjeùid
;

462 
	mÇme
[
BTRFS_INO_LOOKUP_PATH_MAX
];

465 
	#BTRFS_INO_LOOKUP_USER_PATH_MAX
 (4080 - 
BTRFS_VOL_NAME_MAX
 - 1)

	)

466 
	sbŒfs_ioùl_šo_lookup_u£r_¬gs
 {

468 
__u64
 
	mdœid
;

470 
__u64
 
	mŒ“id
;

472 
	mÇme
[
BTRFS_VOL_NAME_MAX
 + 1];

477 
	m·th
[
BTRFS_INO_LOOKUP_USER_PATH_MAX
];

481 
	sbŒfs_ioùl_£¬ch_key
 {

489 
__u64
 
	mŒ“_id
;

511 
__u64
 
	mmš_objeùid
;

512 
__u64
 
	mmax_objeùid
;

513 
__u64
 
	mmš_off£t
;

514 
__u64
 
	mmax_off£t
;

515 
__u64
 
	mmš_Œªsid
;

516 
__u64
 
	mmax_Œªsid
;

517 
__u32
 
	mmš_ty³
;

518 
__u32
 
	mmax_ty³
;

527 
__u32
 
	mÄ_™ems
;

530 
__u32
 
	munu£d
;

533 
__u64
 
	munu£d1
;

534 
__u64
 
	munu£d2
;

535 
__u64
 
	munu£d3
;

536 
__u64
 
	munu£d4
;

539 
	sbŒfs_ioùl_£¬ch_h—d”
 {

540 
__u64
 
	mŒªsid
;

541 
__u64
 
	mobjeùid
;

542 
__u64
 
	moff£t
;

543 
__u32
 
	mty³
;

544 
__u32
 
	mËn
;

547 
	#BTRFS_SEARCH_ARGS_BUFSIZE
 (4096 - (
bŒfs_ioùl_£¬ch_key
))

	)

553 
	sbŒfs_ioùl_£¬ch_¬gs
 {

554 
bŒfs_ioùl_£¬ch_key
 
	mkey
;

555 
	mbuf
[
BTRFS_SEARCH_ARGS_BUFSIZE
];

558 
	sbŒfs_ioùl_£¬ch_¬gs_v2
 {

559 
bŒfs_ioùl_£¬ch_key
 
	mkey
;

560 
__u64
 
	mbuf_size
;

563 
__u64
 
	mbuf
[0];

566 
	sbŒfs_ioùl_şÚe_¿nge_¬gs
 {

567 
__s64
 
	m¤c_fd
;

568 
__u64
 
	m¤c_off£t
, 
	m¤c_Ëngth
;

569 
__u64
 
	mde¡_off£t
;

578 
	#BTRFS_DEFRAG_RANGE_COMPRESS
 1

	)

579 
	#BTRFS_DEFRAG_RANGE_START_IO
 2

	)

580 
	#BTRFS_DEFRAG_RANGE_FLAGS_SUPP
 (
BTRFS_DEFRAG_RANGE_COMPRESS
 | \

581 
BTRFS_DEFRAG_RANGE_START_IO
)

	)

583 
	sbŒfs_ioùl_deäag_¿nge_¬gs
 {

585 
__u64
 
	m¡¬t
;

588 
__u64
 
	mËn
;

594 
__u64
 
	mæags
;

601 
__u32
 
	mex‹Á_th»sh
;

608 
__u32
 
	mcom´ess_ty³
;

611 
__u32
 
	munu£d
[4];

615 
	#BTRFS_SAME_DATA_DIFFERS
 1

	)

617 
	sbŒfs_ioùl_§me_ex‹Á_šfo
 {

618 
__s64
 
	mfd
;

619 
__u64
 
	mlogiÿl_off£t
;

620 
__u64
 
	mby‹s_dedu³d
;

627 
__s32
 
	m¡©us
;

628 
__u32
 
	m»£rved
;

631 
	sbŒfs_ioùl_§me_¬gs
 {

632 
__u64
 
	mlogiÿl_off£t
;

633 
__u64
 
	mËngth
;

634 
__u16
 
	mde¡_couÁ
;

635 
__u16
 
	m»£rved1
;

636 
__u32
 
	m»£rved2
;

637 
bŒfs_ioùl_§me_ex‹Á_šfo
 
	mšfo
[0];

640 
	sbŒfs_ioùl_¥aû_šfo
 {

641 
__u64
 
	mæags
;

642 
__u64
 
	mtÙ®_by‹s
;

643 
__u64
 
	mu£d_by‹s
;

646 
	sbŒfs_ioùl_¥aû_¬gs
 {

647 
__u64
 
	m¥aû_¦Ùs
;

648 
__u64
 
	mtÙ®_¥aûs
;

649 
bŒfs_ioùl_¥aû_šfo
 
	m¥aûs
[0];

652 
	sbŒfs_d©a_cÚš”
 {

653 
__u32
 
	mby‹s_Ëá
;

654 
__u32
 
	mby‹s_missšg
;

655 
__u32
 
	m–em_út
;

656 
__u32
 
	m–em_mis£d
;

657 
__u64
 
	mv®
[0];

660 
	sbŒfs_ioùl_šo_·th_¬gs
 {

661 
__u64
 
	mšum
;

662 
__u64
 
	msize
;

663 
__u64
 
	m»£rved
[4];

665 
__u64
 
	mf¥©h
;

668 
	sbŒfs_ioùl_logiÿl_šo_¬gs
 {

669 
__u64
 
	mlogiÿl
;

670 
__u64
 
	msize
;

671 
__u64
 
	m»£rved
[3];

672 
__u64
 
	mæags
;

674 
__u64
 
	mšodes
;

678 
	#BTRFS_LOGICAL_INO_ARGS_IGNORE_OFFSET
 (1ULL << 0)

	)

680 
	ebŒfs_dev_¡©_v®ues
 {

682 
	mBTRFS_DEV_STAT_WRITE_ERRS
,

683 
	mBTRFS_DEV_STAT_READ_ERRS
,

684 
	mBTRFS_DEV_STAT_FLUSH_ERRS
,

687 
	mBTRFS_DEV_STAT_CORRUPTION_ERRS
,

693 
	mBTRFS_DEV_STAT_GENERATION_ERRS
,

696 
	mBTRFS_DEV_STAT_VALUES_MAX


700 
	#BTRFS_DEV_STATS_RESET
 (1ULL << 0)

	)

702 
	sbŒfs_ioùl_g‘_dev_¡©s
 {

703 
__u64
 
	mdevid
;

704 
__u64
 
	mÄ_™ems
;

705 
__u64
 
	mæags
;

708 
__u64
 
	mv®ues
[
BTRFS_DEV_STAT_VALUES_MAX
];

715 
__u64
 
	munu£d
[128 - 2 - 
BTRFS_DEV_STAT_VALUES_MAX
];

718 
	#BTRFS_QUOTA_CTL_ENABLE
 1

	)

719 
	#BTRFS_QUOTA_CTL_DISABLE
 2

	)

720 
	#BTRFS_QUOTA_CTL_RESCAN__NOTUSED
 3

	)

721 
	sbŒfs_ioùl_quÙa_ùl_¬gs
 {

722 
__u64
 
	mcmd
;

723 
__u64
 
	m¡©us
;

726 
	sbŒfs_ioùl_quÙa_»sÿn_¬gs
 {

727 
__u64
 
	mæags
;

728 
__u64
 
	m´og»ss
;

729 
__u64
 
	m»£rved
[6];

732 
	sbŒfs_ioùl_qgroup_assign_¬gs
 {

733 
__u64
 
	massign
;

734 
__u64
 
	m¤c
;

735 
__u64
 
	md¡
;

738 
	sbŒfs_ioùl_qgroup_ü—‹_¬gs
 {

739 
__u64
 
	mü—‹
;

740 
__u64
 
	mqgroupid
;

742 
	sbŒfs_ioùl_time¥ec
 {

743 
__u64
 
	m£c
;

744 
__u32
 
	mn£c
;

747 
	sbŒfs_ioùl_»ûived_subvŞ_¬gs
 {

748 
	muuid
[
BTRFS_UUID_SIZE
];

749 
__u64
 
	m¡¿nsid
;

750 
__u64
 
	m¹¿nsid
;

751 
bŒfs_ioùl_time¥ec
 
	m¡ime
;

752 
bŒfs_ioùl_time¥ec
 
	m¹ime
;

753 
__u64
 
	mæags
;

754 
__u64
 
	m»£rved
[16];

762 
	#BTRFS_SEND_FLAG_NO_FILE_DATA
 0x1

	)

768 
	#BTRFS_SEND_FLAG_OMIT_STREAM_HEADER
 0x2

	)

775 
	#BTRFS_SEND_FLAG_OMIT_END_CMD
 0x4

	)

777 
	#BTRFS_SEND_FLAG_MASK
 \

778 (
BTRFS_SEND_FLAG_NO_FILE_DATA
 | \

779 
BTRFS_SEND_FLAG_OMIT_STREAM_HEADER
 | \

780 
BTRFS_SEND_FLAG_OMIT_END_CMD
)

	)

782 
	sbŒfs_ioùl_£nd_¬gs
 {

783 
__s64
 
	m£nd_fd
;

784 
__u64
 
	mşÚe_sourûs_couÁ
;

785 
__u64
 *
	mşÚe_sourûs
;

786 
__u64
 
	m·»Á_roÙ
;

787 
__u64
 
	mæags
;

788 
__u64
 
	m»£rved
[4];

796 
	sbŒfs_ioùl_g‘_subvŞ_šfo_¬gs
 {

798 
__u64
 
	mŒ“id
;

801 
	mÇme
[
BTRFS_VOL_NAME_MAX
 + 1];

807 
__u64
 
	m·»Á_id
;

813 
__u64
 
	mdœid
;

816 
__u64
 
	mg’”©iÚ
;

819 
__u64
 
	mæags
;

822 
__u8
 
	muuid
[
BTRFS_UUID_SIZE
];

828 
__u8
 
	m·»Á_uuid
[
BTRFS_UUID_SIZE
];

834 
__u8
 
	m»ûived_uuid
[
BTRFS_UUID_SIZE
];

837 
__u64
 
	mù¿nsid
;

838 
__u64
 
	mÙ¿nsid
;

839 
__u64
 
	m¡¿nsid
;

840 
__u64
 
	m¹¿nsid
;

842 
bŒfs_ioùl_time¥ec
 
	mùime
;

843 
bŒfs_ioùl_time¥ec
 
	mÙime
;

844 
bŒfs_ioùl_time¥ec
 
	m¡ime
;

845 
bŒfs_ioùl_time¥ec
 
	m¹ime
;

848 
__u64
 
	m»£rved
[8];

851 
	#BTRFS_MAX_ROOTREF_BUFFER_NUM
 255

	)

852 
	sbŒfs_ioùl_g‘_subvŞ_roÙ»f_¬gs
 {

854 
__u64
 
	mmš_Œ“id
;

858 
__u64
 
	mŒ“id
;

859 
__u64
 
	mdœid
;

860 } 
	mroÙ»f
[
BTRFS_MAX_ROOTREF_BUFFER_NUM
];

863 
__u8
 
	mnum_™ems
;

864 
__u8
 
	m®ign
[7];

868 
	ebŒfs_”r_code
 {

869 
	mBTRFS_ERROR_DEV_RAID1_MIN_NOT_MET
 = 1,

870 
	mBTRFS_ERROR_DEV_RAID10_MIN_NOT_MET
,

871 
	mBTRFS_ERROR_DEV_RAID5_MIN_NOT_MET
,

872 
	mBTRFS_ERROR_DEV_RAID6_MIN_NOT_MET
,

873 
	mBTRFS_ERROR_DEV_TGT_REPLACE
,

874 
	mBTRFS_ERROR_DEV_MISSING_NOT_FOUND
,

875 
	mBTRFS_ERROR_DEV_ONLY_WRITABLE
,

876 
	mBTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
,

877 
	mBTRFS_ERROR_DEV_RAID1C3_MIN_NOT_MET
,

878 
	mBTRFS_ERROR_DEV_RAID1C4_MIN_NOT_MET
,

881 
	#BTRFS_IOC_SNAP_CREATE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 1, \

882 
bŒfs_ioùl_vŞ_¬gs
)

	)

883 
	#BTRFS_IOC_DEFRAG
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 2, \

884 
bŒfs_ioùl_vŞ_¬gs
)

	)

885 
	#BTRFS_IOC_RESIZE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 3, \

886 
bŒfs_ioùl_vŞ_¬gs
)

	)

887 
	#BTRFS_IOC_SCAN_DEV
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 4, \

888 
bŒfs_ioùl_vŞ_¬gs
)

	)

889 
	#BTRFS_IOC_FORGET_DEV
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 5, \

890 
bŒfs_ioùl_vŞ_¬gs
)

	)

895 
	#BTRFS_IOC_TRANS_START
 
	`_IO
(
BTRFS_IOCTL_MAGIC
, 6)

	)

896 
	#BTRFS_IOC_TRANS_END
 
	`_IO
(
BTRFS_IOCTL_MAGIC
, 7)

	)

897 
	#BTRFS_IOC_SYNC
 
	`_IO
(
BTRFS_IOCTL_MAGIC
, 8)

	)

899 
	#BTRFS_IOC_CLONE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 9, )

	)

900 
	#BTRFS_IOC_ADD_DEV
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 10, \

901 
bŒfs_ioùl_vŞ_¬gs
)

	)

902 
	#BTRFS_IOC_RM_DEV
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 11, \

903 
bŒfs_ioùl_vŞ_¬gs
)

	)

904 
	#BTRFS_IOC_BALANCE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 12, \

905 
bŒfs_ioùl_vŞ_¬gs
)

	)

907 
	#BTRFS_IOC_CLONE_RANGE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 13, \

908 
bŒfs_ioùl_şÚe_¿nge_¬gs
)

	)

910 
	#BTRFS_IOC_SUBVOL_CREATE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 14, \

911 
bŒfs_ioùl_vŞ_¬gs
)

	)

912 
	#BTRFS_IOC_SNAP_DESTROY
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 15, \

913 
bŒfs_ioùl_vŞ_¬gs
)

	)

914 
	#BTRFS_IOC_DEFRAG_RANGE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 16, \

915 
bŒfs_ioùl_deäag_¿nge_¬gs
)

	)

916 
	#BTRFS_IOC_TREE_SEARCH
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 17, \

917 
bŒfs_ioùl_£¬ch_¬gs
)

	)

918 
	#BTRFS_IOC_TREE_SEARCH_V2
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 17, \

919 
bŒfs_ioùl_£¬ch_¬gs_v2
)

	)

920 
	#BTRFS_IOC_INO_LOOKUP
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 18, \

921 
bŒfs_ioùl_šo_lookup_¬gs
)

	)

922 
	#BTRFS_IOC_DEFAULT_SUBVOL
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 19, 
__u64
)

	)

923 
	#BTRFS_IOC_SPACE_INFO
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 20, \

924 
bŒfs_ioùl_¥aû_¬gs
)

	)

925 
	#BTRFS_IOC_START_SYNC
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 24, 
__u64
)

	)

926 
	#BTRFS_IOC_WAIT_SYNC
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 22, 
__u64
)

	)

927 
	#BTRFS_IOC_SNAP_CREATE_V2
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 23, \

928 
bŒfs_ioùl_vŞ_¬gs_v2
)

	)

929 
	#BTRFS_IOC_SUBVOL_CREATE_V2
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 24, \

930 
bŒfs_ioùl_vŞ_¬gs_v2
)

	)

931 
	#BTRFS_IOC_SUBVOL_GETFLAGS
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 25, 
__u64
)

	)

932 
	#BTRFS_IOC_SUBVOL_SETFLAGS
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 26, 
__u64
)

	)

933 
	#BTRFS_IOC_SCRUB
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 27, \

934 
bŒfs_ioùl_süub_¬gs
)

	)

935 
	#BTRFS_IOC_SCRUB_CANCEL
 
	`_IO
(
BTRFS_IOCTL_MAGIC
, 28)

	)

936 
	#BTRFS_IOC_SCRUB_PROGRESS
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 29, \

937 
bŒfs_ioùl_süub_¬gs
)

	)

938 
	#BTRFS_IOC_DEV_INFO
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 30, \

939 
bŒfs_ioùl_dev_šfo_¬gs
)

	)

940 
	#BTRFS_IOC_FS_INFO
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 31, \

941 
bŒfs_ioùl_fs_šfo_¬gs
)

	)

942 
	#BTRFS_IOC_BALANCE_V2
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 32, \

943 
bŒfs_ioùl_b®ªû_¬gs
)

	)

944 
	#BTRFS_IOC_BALANCE_CTL
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 33, )

	)

945 
	#BTRFS_IOC_BALANCE_PROGRESS
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 34, \

946 
bŒfs_ioùl_b®ªû_¬gs
)

	)

947 
	#BTRFS_IOC_INO_PATHS
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 35, \

948 
bŒfs_ioùl_šo_·th_¬gs
)

	)

949 
	#BTRFS_IOC_LOGICAL_INO
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 36, \

950 
bŒfs_ioùl_logiÿl_šo_¬gs
)

	)

951 
	#BTRFS_IOC_SET_RECEIVED_SUBVOL
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 37, \

952 
bŒfs_ioùl_»ûived_subvŞ_¬gs
)

	)

953 
	#BTRFS_IOC_SEND
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 38, 
bŒfs_ioùl_£nd_¬gs
)

	)

954 
	#BTRFS_IOC_DEVICES_READY
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 39, \

955 
bŒfs_ioùl_vŞ_¬gs
)

	)

956 
	#BTRFS_IOC_QUOTA_CTL
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 40, \

957 
bŒfs_ioùl_quÙa_ùl_¬gs
)

	)

958 
	#BTRFS_IOC_QGROUP_ASSIGN
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 41, \

959 
bŒfs_ioùl_qgroup_assign_¬gs
)

	)

960 
	#BTRFS_IOC_QGROUP_CREATE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 42, \

961 
bŒfs_ioùl_qgroup_ü—‹_¬gs
)

	)

962 
	#BTRFS_IOC_QGROUP_LIMIT
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 43, \

963 
bŒfs_ioùl_qgroup_lim™_¬gs
)

	)

964 
	#BTRFS_IOC_QUOTA_RESCAN
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 44, \

965 
bŒfs_ioùl_quÙa_»sÿn_¬gs
)

	)

966 
	#BTRFS_IOC_QUOTA_RESCAN_STATUS
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 45, \

967 
bŒfs_ioùl_quÙa_»sÿn_¬gs
)

	)

968 
	#BTRFS_IOC_QUOTA_RESCAN_WAIT
 
	`_IO
(
BTRFS_IOCTL_MAGIC
, 46)

	)

969 
	#BTRFS_IOC_GET_FSLABEL
 
FS_IOC_GETFSLABEL


	)

970 
	#BTRFS_IOC_SET_FSLABEL
 
FS_IOC_SETFSLABEL


	)

971 
	#BTRFS_IOC_GET_DEV_STATS
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 52, \

972 
bŒfs_ioùl_g‘_dev_¡©s
)

	)

973 
	#BTRFS_IOC_DEV_REPLACE
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 53, \

974 
bŒfs_ioùl_dev_»¶aû_¬gs
)

	)

975 
	#BTRFS_IOC_FILE_EXTENT_SAME
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 54, \

976 
bŒfs_ioùl_§me_¬gs
)

	)

977 
	#BTRFS_IOC_GET_FEATURES
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 57, \

978 
bŒfs_ioùl_ã©u»_æags
)

	)

979 
	#BTRFS_IOC_SET_FEATURES
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 57, \

980 
bŒfs_ioùl_ã©u»_æags
[2])

	)

981 
	#BTRFS_IOC_GET_SUPPORTED_FEATURES
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 57, \

982 
bŒfs_ioùl_ã©u»_æags
[3])

	)

983 
	#BTRFS_IOC_RM_DEV_V2
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 58, \

984 
bŒfs_ioùl_vŞ_¬gs_v2
)

	)

985 
	#BTRFS_IOC_LOGICAL_INO_V2
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 59, \

986 
bŒfs_ioùl_logiÿl_šo_¬gs
)

	)

987 
	#BTRFS_IOC_GET_SUBVOL_INFO
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 60, \

988 
bŒfs_ioùl_g‘_subvŞ_šfo_¬gs
)

	)

989 
	#BTRFS_IOC_GET_SUBVOL_ROOTREF
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 61, \

990 
bŒfs_ioùl_g‘_subvŞ_roÙ»f_¬gs
)

	)

991 
	#BTRFS_IOC_INO_LOOKUP_USER
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 62, \

992 
bŒfs_ioùl_šo_lookup_u£r_¬gs
)

	)

993 
	#BTRFS_IOC_SNAP_DESTROY_V2
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 63, \

994 
bŒfs_ioùl_vŞ_¬gs_v2
)

	)

	@/usr/include/linux/btrfs_tree.h

2 #iâdeà
_BTRFS_CTREE_H_


3 
	#_BTRFS_CTREE_H_


	)

5 
	~<lšux/bŒfs.h
>

6 
	~<lšux/ty³s.h
>

7 
	~<¡ddef.h
>

17 
	#BTRFS_ROOT_TREE_OBJECTID
 1ULL

	)

20 
	#BTRFS_EXTENT_TREE_OBJECTID
 2ULL

	)

26 
	#BTRFS_CHUNK_TREE_OBJECTID
 3ULL

	)

32 
	#BTRFS_DEV_TREE_OBJECTID
 4ULL

	)

35 
	#BTRFS_FS_TREE_OBJECTID
 5ULL

	)

38 
	#BTRFS_ROOT_TREE_DIR_OBJECTID
 6ULL

	)

41 
	#BTRFS_CSUM_TREE_OBJECTID
 7ULL

	)

44 
	#BTRFS_QUOTA_TREE_OBJECTID
 8ULL

	)

47 
	#BTRFS_UUID_TREE_OBJECTID
 9ULL

	)

50 
	#BTRFS_FREE_SPACE_TREE_OBJECTID
 10ULL

	)

53 
	#BTRFS_DEV_STATS_OBJECTID
 0ULL

	)

56 
	#BTRFS_BALANCE_OBJECTID
 -4ULL

	)

59 
	#BTRFS_ORPHAN_OBJECTID
 -5ULL

	)

62 
	#BTRFS_TREE_LOG_OBJECTID
 -6ULL

	)

63 
	#BTRFS_TREE_LOG_FIXUP_OBJECTID
 -7ULL

	)

66 
	#BTRFS_TREE_RELOC_OBJECTID
 -8ULL

	)

67 
	#BTRFS_DATA_RELOC_TREE_OBJECTID
 -9ULL

	)

74 
	#BTRFS_EXTENT_CSUM_OBJECTID
 -10ULL

	)

77 
	#BTRFS_FREE_SPACE_OBJECTID
 -11ULL

	)

83 
	#BTRFS_FREE_INO_OBJECTID
 -12ULL

	)

86 
	#BTRFS_MULTIPLE_OBJECTIDS
 -255ULL

	)

91 
	#BTRFS_FIRST_FREE_OBJECTID
 256ULL

	)

92 
	#BTRFS_LAST_FREE_OBJECTID
 -256ULL

	)

93 
	#BTRFS_FIRST_CHUNK_TREE_OBJECTID
 256ULL

	)

100 
	#BTRFS_DEV_ITEMS_OBJECTID
 1ULL

	)

102 
	#BTRFS_BTREE_INODE_OBJECTID
 1

	)

104 
	#BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
 2

	)

106 
	#BTRFS_DEV_REPLACE_DEVID
 0ULL

	)

113 
	#BTRFS_INODE_ITEM_KEY
 1

	)

114 
	#BTRFS_INODE_REF_KEY
 12

	)

115 
	#BTRFS_INODE_EXTREF_KEY
 13

	)

116 
	#BTRFS_XATTR_ITEM_KEY
 24

	)

137 
	#BTRFS_VERITY_DESC_ITEM_KEY
 36

	)

138 
	#BTRFS_VERITY_MERKLE_ITEM_KEY
 37

	)

140 
	#BTRFS_ORPHAN_ITEM_KEY
 48

	)

149 
	#BTRFS_DIR_LOG_ITEM_KEY
 60

	)

150 
	#BTRFS_DIR_LOG_INDEX_KEY
 72

	)

151 
	#BTRFS_DIR_ITEM_KEY
 84

	)

152 
	#BTRFS_DIR_INDEX_KEY
 96

	)

156 
	#BTRFS_EXTENT_DATA_KEY
 108

	)

162 
	#BTRFS_EXTENT_CSUM_KEY
 128

	)

168 
	#BTRFS_ROOT_ITEM_KEY
 132

	)

174 
	#BTRFS_ROOT_BACKREF_KEY
 144

	)

181 
	#BTRFS_ROOT_REF_KEY
 156

	)

187 
	#BTRFS_EXTENT_ITEM_KEY
 168

	)

193 
	#BTRFS_METADATA_ITEM_KEY
 169

	)

195 
	#BTRFS_TREE_BLOCK_REF_KEY
 176

	)

197 
	#BTRFS_EXTENT_DATA_REF_KEY
 178

	)

199 
	#BTRFS_EXTENT_REF_V0_KEY
 180

	)

201 
	#BTRFS_SHARED_BLOCK_REF_KEY
 182

	)

203 
	#BTRFS_SHARED_DATA_REF_KEY
 184

	)

209 
	#BTRFS_BLOCK_GROUP_ITEM_KEY
 192

	)

216 
	#BTRFS_FREE_SPACE_INFO_KEY
 198

	)

222 
	#BTRFS_FREE_SPACE_EXTENT_KEY
 199

	)

230 
	#BTRFS_FREE_SPACE_BITMAP_KEY
 200

	)

232 
	#BTRFS_DEV_EXTENT_KEY
 204

	)

233 
	#BTRFS_DEV_ITEM_KEY
 216

	)

234 
	#BTRFS_CHUNK_ITEM_KEY
 228

	)

241 
	#BTRFS_QGROUP_STATUS_KEY
 240

	)

246 
	#BTRFS_QGROUP_INFO_KEY
 242

	)

251 
	#BTRFS_QGROUP_LIMIT_KEY
 244

	)

258 
	#BTRFS_QGROUP_RELATION_KEY
 246

	)

263 
	#BTRFS_BALANCE_ITEM_KEY
 248

	)

276 
	#BTRFS_TEMPORARY_ITEM_KEY
 248

	)

281 
	#BTRFS_DEV_STATS_KEY
 249

	)

296 
	#BTRFS_PERSISTENT_ITEM_KEY
 249

	)

302 
	#BTRFS_DEV_REPLACE_KEY
 250

	)

310 #ià
BTRFS_UUID_SIZE
 != 16

313 
	#BTRFS_UUID_KEY_SUBVOL
 251

	)

314 
	#BTRFS_UUID_KEY_RECEIVED_SUBVOL
 252

	)

321 
	#BTRFS_STRING_ITEM_KEY
 253

	)

324 
	#BTRFS_MAX_METADATA_BLOCKSIZE
 65536

	)

327 
	#BTRFS_CSUM_SIZE
 32

	)

330 
	ebŒfs_csum_ty³
 {

331 
	mBTRFS_CSUM_TYPE_CRC32
 = 0,

332 
	mBTRFS_CSUM_TYPE_XXHASH
 = 1,

333 
	mBTRFS_CSUM_TYPE_SHA256
 = 2,

334 
	mBTRFS_CSUM_TYPE_BLAKE2
 = 3,

345 
	#BTRFS_FT_UNKNOWN
 0

	)

346 
	#BTRFS_FT_REG_FILE
 1

	)

347 
	#BTRFS_FT_DIR
 2

	)

348 
	#BTRFS_FT_CHRDEV
 3

	)

349 
	#BTRFS_FT_BLKDEV
 4

	)

350 
	#BTRFS_FT_FIFO
 5

	)

351 
	#BTRFS_FT_SOCK
 6

	)

352 
	#BTRFS_FT_SYMLINK
 7

	)

353 
	#BTRFS_FT_XATTR
 8

	)

354 
	#BTRFS_FT_MAX
 9

	)

373 
	sbŒfs_disk_key
 {

374 
__Ë64
 
	mobjeùid
;

375 
__u8
 
	mty³
;

376 
__Ë64
 
	moff£t
;

377 } 
__©Œibu‹__
 ((
__·cked__
));

379 
	sbŒfs_key
 {

380 
__u64
 
	mobjeùid
;

381 
__u8
 
	mty³
;

382 
__u64
 
	moff£t
;

383 } 
__©Œibu‹__
 ((
__·cked__
));

385 
	sbŒfs_dev_™em
 {

387 
__Ë64
 
	mdevid
;

390 
__Ë64
 
	mtÙ®_by‹s
;

393 
__Ë64
 
	mby‹s_u£d
;

396 
__Ë32
 
	mio_®ign
;

399 
__Ë32
 
	mio_width
;

402 
__Ë32
 
	m£ùÜ_size
;

405 
__Ë64
 
	mty³
;

408 
__Ë64
 
	mg’”©iÚ
;

414 
__Ë64
 
	m¡¬t_off£t
;

417 
__Ë32
 
	mdev_group
;

420 
__u8
 
	m£ek_¥“d
;

423 
__u8
 
	mbªdwidth
;

426 
__u8
 
	muuid
[
BTRFS_UUID_SIZE
];

429 
__u8
 
	mfsid
[
BTRFS_UUID_SIZE
];

430 } 
__©Œibu‹__
 ((
__·cked__
));

432 
	sbŒfs_¡re
 {

433 
__Ë64
 
	mdevid
;

434 
__Ë64
 
	moff£t
;

435 
__u8
 
	mdev_uuid
[
BTRFS_UUID_SIZE
];

436 } 
__©Œibu‹__
 ((
__·cked__
));

438 
	sbŒfs_chunk
 {

440 
__Ë64
 
	mËngth
;

443 
__Ë64
 
	mowÃr
;

445 
__Ë64
 
	m¡re_Ën
;

446 
__Ë64
 
	mty³
;

449 
__Ë32
 
	mio_®ign
;

452 
__Ë32
 
	mio_width
;

455 
__Ë32
 
	m£ùÜ_size
;

460 
__Ë16
 
	mnum_¡res
;

463 
__Ë16
 
	msub_¡res
;

464 
bŒfs_¡re
 
	m¡re
;

466 } 
__©Œibu‹__
 ((
__·cked__
));

468 
	#BTRFS_FREE_SPACE_EXTENT
 1

	)

469 
	#BTRFS_FREE_SPACE_BITMAP
 2

	)

471 
	sbŒfs_ä“_¥aû_’Œy
 {

472 
__Ë64
 
	moff£t
;

473 
__Ë64
 
	mby‹s
;

474 
__u8
 
	mty³
;

475 } 
__©Œibu‹__
 ((
__·cked__
));

477 
	sbŒfs_ä“_¥aû_h—d”
 {

478 
bŒfs_disk_key
 
	mloÿtiÚ
;

479 
__Ë64
 
	mg’”©iÚ
;

480 
__Ë64
 
	mnum_’Œ›s
;

481 
__Ë64
 
	mnum_b™m­s
;

482 } 
__©Œibu‹__
 ((
__·cked__
));

484 
	#BTRFS_HEADER_FLAG_WRITTEN
 (1ULL << 0)

	)

485 
	#BTRFS_HEADER_FLAG_RELOC
 (1ULL << 1)

	)

489 
	#BTRFS_SUPER_FLAG_ERROR
 (1ULL << 2)

	)

491 
	#BTRFS_SUPER_FLAG_SEEDING
 (1ULL << 32)

	)

492 
	#BTRFS_SUPER_FLAG_METADUMP
 (1ULL << 33)

	)

493 
	#BTRFS_SUPER_FLAG_METADUMP_V2
 (1ULL << 34)

	)

494 
	#BTRFS_SUPER_FLAG_CHANGING_FSID
 (1ULL << 35)

	)

495 
	#BTRFS_SUPER_FLAG_CHANGING_FSID_V2
 (1ULL << 36)

	)

503 
	sbŒfs_ex‹Á_™em
 {

504 
__Ë64
 
	m»fs
;

505 
__Ë64
 
	mg’”©iÚ
;

506 
__Ë64
 
	mæags
;

507 } 
__©Œibu‹__
 ((
__·cked__
));

509 
	sbŒfs_ex‹Á_™em_v0
 {

510 
__Ë32
 
	m»fs
;

511 } 
__©Œibu‹__
 ((
__·cked__
));

514 
	#BTRFS_EXTENT_FLAG_DATA
 (1ULL << 0)

	)

515 
	#BTRFS_EXTENT_FLAG_TREE_BLOCK
 (1ULL << 1)

	)

520 
	#BTRFS_BLOCK_FLAG_FULL_BACKREF
 (1ULL << 8)

	)

526 
	#BTRFS_EXTENT_FLAG_SUPER
 (1ULL << 48)

	)

528 
	sbŒfs_Œ“_block_šfo
 {

529 
bŒfs_disk_key
 
	mkey
;

530 
__u8
 
	mËv–
;

531 } 
__©Œibu‹__
 ((
__·cked__
));

533 
	sbŒfs_ex‹Á_d©a_»f
 {

534 
__Ë64
 
	mroÙ
;

535 
__Ë64
 
	mobjeùid
;

536 
__Ë64
 
	moff£t
;

537 
__Ë32
 
	mcouÁ
;

538 } 
__©Œibu‹__
 ((
__·cked__
));

540 
	sbŒfs_sh¬ed_d©a_»f
 {

541 
__Ë32
 
	mcouÁ
;

542 } 
__©Œibu‹__
 ((
__·cked__
));

544 
	sbŒfs_ex‹Á_šlše_»f
 {

545 
__u8
 
	mty³
;

546 
__Ë64
 
	moff£t
;

547 } 
__©Œibu‹__
 ((
__·cked__
));

553 
	sbŒfs_dev_ex‹Á
 {

554 
__Ë64
 
	mchunk_Œ“
;

555 
__Ë64
 
	mchunk_objeùid
;

556 
__Ë64
 
	mchunk_off£t
;

557 
__Ë64
 
	mËngth
;

558 
__u8
 
	mchunk_Œ“_uuid
[
BTRFS_UUID_SIZE
];

559 } 
__©Œibu‹__
 ((
__·cked__
));

561 
	sbŒfs_šode_»f
 {

562 
__Ë64
 
	mšdex
;

563 
__Ë16
 
	mÇme_Ën
;

565 } 
__©Œibu‹__
 ((
__·cked__
));

567 
	sbŒfs_šode_exŒef
 {

568 
__Ë64
 
	m·»Á_objeùid
;

569 
__Ë64
 
	mšdex
;

570 
__Ë16
 
	mÇme_Ën
;

571 
__u8
 
	mÇme
[0];

573 } 
__©Œibu‹__
 ((
__·cked__
));

575 
	sbŒfs_time¥ec
 {

576 
__Ë64
 
	m£c
;

577 
__Ë32
 
	mn£c
;

578 } 
__©Œibu‹__
 ((
__·cked__
));

580 
	sbŒfs_šode_™em
 {

582 
__Ë64
 
	mg’”©iÚ
;

584 
__Ë64
 
	mŒªsid
;

585 
__Ë64
 
	msize
;

586 
__Ë64
 
	mnby‹s
;

587 
__Ë64
 
	mblock_group
;

588 
__Ë32
 
	mÆšk
;

589 
__Ë32
 
	muid
;

590 
__Ë32
 
	mgid
;

591 
__Ë32
 
	mmode
;

592 
__Ë64
 
	mrdev
;

593 
__Ë64
 
	mæags
;

596 
__Ë64
 
	m£qu’û
;

602 
__Ë64
 
	m»£rved
[4];

603 
bŒfs_time¥ec
 
	m©ime
;

604 
bŒfs_time¥ec
 
	mùime
;

605 
bŒfs_time¥ec
 
	mmtime
;

606 
bŒfs_time¥ec
 
	mÙime
;

607 } 
__©Œibu‹__
 ((
__·cked__
));

609 
	sbŒfs_dœ_log_™em
 {

610 
__Ë64
 
	m’d
;

611 } 
__©Œibu‹__
 ((
__·cked__
));

613 
	sbŒfs_dœ_™em
 {

614 
bŒfs_disk_key
 
	mloÿtiÚ
;

615 
__Ë64
 
	mŒªsid
;

616 
__Ë16
 
	md©a_Ën
;

617 
__Ë16
 
	mÇme_Ën
;

618 
__u8
 
	mty³
;

619 } 
__©Œibu‹__
 ((
__·cked__
));

621 
	#BTRFS_ROOT_SUBVOL_RDONLY
 (1ULL << 0)

	)

627 
	#BTRFS_ROOT_SUBVOL_DEAD
 (1ULL << 48)

	)

629 
	sbŒfs_roÙ_™em
 {

630 
bŒfs_šode_™em
 
	mšode
;

631 
__Ë64
 
	mg’”©iÚ
;

632 
__Ë64
 
	mroÙ_dœid
;

633 
__Ë64
 
	mby‹Ä
;

634 
__Ë64
 
	mby‹_lim™
;

635 
__Ë64
 
	mby‹s_u£d
;

636 
__Ë64
 
	mÏ¡_¢­shÙ
;

637 
__Ë64
 
	mæags
;

638 
__Ë32
 
	m»fs
;

639 
bŒfs_disk_key
 
	mdrİ_´og»ss
;

640 
__u8
 
	mdrİ_Ëv–
;

641 
__u8
 
	mËv–
;

659 
__Ë64
 
	mg’”©iÚ_v2
;

660 
__u8
 
	muuid
[
BTRFS_UUID_SIZE
];

661 
__u8
 
	m·»Á_uuid
[
BTRFS_UUID_SIZE
];

662 
__u8
 
	m»ûived_uuid
[
BTRFS_UUID_SIZE
];

663 
__Ë64
 
	mù¿nsid
;

664 
__Ë64
 
	mÙ¿nsid
;

665 
__Ë64
 
	m¡¿nsid
;

666 
__Ë64
 
	m¹¿nsid
;

667 
bŒfs_time¥ec
 
	mùime
;

668 
bŒfs_time¥ec
 
	mÙime
;

669 
bŒfs_time¥ec
 
	m¡ime
;

670 
bŒfs_time¥ec
 
	m¹ime
;

671 
__Ë64
 
	m»£rved
[8];

672 } 
__©Œibu‹__
 ((
__·cked__
));

678 
__šlše__
 
__u32
 
	$bŒfs_Ëgacy_roÙ_™em_size
()

680  
	`off£tof
(
bŒfs_roÙ_™em
, 
g’”©iÚ_v2
);

681 
	}
}

686 
	sbŒfs_roÙ_»f
 {

687 
__Ë64
 
	mdœid
;

688 
__Ë64
 
	m£qu’û
;

689 
__Ë16
 
	mÇme_Ën
;

690 } 
__©Œibu‹__
 ((
__·cked__
));

692 
	sbŒfs_disk_b®ªû_¬gs
 {

697 
__Ë64
 
	m´ofes
;

705 
__Ë64
 
	mu§ge
;

707 
__Ë32
 
	mu§ge_mš
;

708 
__Ë32
 
	mu§ge_max
;

713 
__Ë64
 
	mdevid
;

716 
__Ë64
 
	mp¡¬t
;

717 
__Ë64
 
	m³nd
;

720 
__Ë64
 
	mv¡¬t
;

721 
__Ë64
 
	mv’d
;

727 
__Ë64
 
	mrg‘
;

730 
__Ë64
 
	mæags
;

738 
__Ë64
 
	mlim™
;

740 
__Ë32
 
	mlim™_mš
;

741 
__Ë32
 
	mlim™_max
;

749 
__Ë32
 
	m¡res_mš
;

750 
__Ë32
 
	m¡res_max
;

752 
__Ë64
 
	munu£d
[6];

753 } 
__©Œibu‹__
 ((
__·cked__
));

759 
	sbŒfs_b®ªû_™em
 {

761 
__Ë64
 
	mæags
;

763 
bŒfs_disk_b®ªû_¬gs
 
	md©a
;

764 
bŒfs_disk_b®ªû_¬gs
 
	mm‘a
;

765 
bŒfs_disk_b®ªû_¬gs
 
	msys
;

767 
__Ë64
 
	munu£d
[4];

768 } 
__©Œibu‹__
 ((
__·cked__
));

771 
	mBTRFS_FILE_EXTENT_INLINE
 = 0,

772 
	mBTRFS_FILE_EXTENT_REG
 = 1,

773 
	mBTRFS_FILE_EXTENT_PREALLOC
 = 2,

774 
	mBTRFS_NR_FILE_EXTENT_TYPES
 = 3,

777 
	sbŒfs_fe_ex‹Á_™em
 {

781 
__Ë64
 
	mg’”©iÚ
;

789 
__Ë64
 
	m¿m_by‹s
;

798 
__u8
 
	mcom´essiÚ
;

799 
__u8
 
	m’üy±iÚ
;

800 
__Ë16
 
	mÙh”_’codšg
;

803 
__u8
 
	mty³
;

811 
__Ë64
 
	mdisk_by‹Ä
;

812 
__Ë64
 
	mdisk_num_by‹s
;

820 
__Ë64
 
	moff£t
;

825 
__Ë64
 
	mnum_by‹s
;

827 } 
__©Œibu‹__
 ((
__·cked__
));

829 
	sbŒfs_csum_™em
 {

830 
__u8
 
	mcsum
;

831 } 
__©Œibu‹__
 ((
__·cked__
));

833 
	sbŒfs_dev_¡©s_™em
 {

838 
__Ë64
 
	mv®ues
[
BTRFS_DEV_STAT_VALUES_MAX
];

839 } 
__©Œibu‹__
 ((
__·cked__
));

841 
	#BTRFS_DEV_REPLACE_ITEM_CONT_READING_FROM_SRCDEV_MODE_ALWAYS
 0

	)

842 
	#BTRFS_DEV_REPLACE_ITEM_CONT_READING_FROM_SRCDEV_MODE_AVOID
 1

	)

844 
	sbŒfs_dev_»¶aû_™em
 {

849 
__Ë64
 
	m¤c_devid
;

850 
__Ë64
 
	mcursÜ_Ëá
;

851 
__Ë64
 
	mcursÜ_right
;

852 
__Ë64
 
	mcÚt_»adšg_äom_¤cdev_mode
;

854 
__Ë64
 
	m»¶aû_¡©e
;

855 
__Ë64
 
	mtime_¡¬‹d
;

856 
__Ë64
 
	mtime_¡İ³d
;

857 
__Ë64
 
	mnum_wr™e_”rÜs
;

858 
__Ë64
 
	mnum_uncÜ»ùabË_»ad_”rÜs
;

859 } 
__©Œibu‹__
 ((
__·cked__
));

862 
	#BTRFS_BLOCK_GROUP_DATA
 (1ULL << 0)

	)

863 
	#BTRFS_BLOCK_GROUP_SYSTEM
 (1ULL << 1)

	)

864 
	#BTRFS_BLOCK_GROUP_METADATA
 (1ULL << 2)

	)

865 
	#BTRFS_BLOCK_GROUP_RAID0
 (1ULL << 3)

	)

866 
	#BTRFS_BLOCK_GROUP_RAID1
 (1ULL << 4)

	)

867 
	#BTRFS_BLOCK_GROUP_DUP
 (1ULL << 5)

	)

868 
	#BTRFS_BLOCK_GROUP_RAID10
 (1ULL << 6)

	)

869 
	#BTRFS_BLOCK_GROUP_RAID5
 (1ULL << 7)

	)

870 
	#BTRFS_BLOCK_GROUP_RAID6
 (1ULL << 8)

	)

871 
	#BTRFS_BLOCK_GROUP_RAID1C3
 (1ULL << 9)

	)

872 
	#BTRFS_BLOCK_GROUP_RAID1C4
 (1ULL << 10)

	)

873 
	#BTRFS_BLOCK_GROUP_RESERVED
 (
BTRFS_AVAIL_ALLOC_BIT_SINGLE
 | \

874 
BTRFS_SPACE_INFO_GLOBAL_RSV
)

	)

876 
	ebŒfs_¿id_ty³s
 {

877 
	mBTRFS_RAID_RAID10
,

878 
	mBTRFS_RAID_RAID1
,

879 
	mBTRFS_RAID_DUP
,

880 
	mBTRFS_RAID_RAID0
,

881 
	mBTRFS_RAID_SINGLE
,

882 
	mBTRFS_RAID_RAID5
,

883 
	mBTRFS_RAID_RAID6
,

884 
	mBTRFS_RAID_RAID1C3
,

885 
	mBTRFS_RAID_RAID1C4
,

886 
	mBTRFS_NR_RAID_TYPES


889 
	#BTRFS_BLOCK_GROUP_TYPE_MASK
 (
BTRFS_BLOCK_GROUP_DATA
 | \

890 
BTRFS_BLOCK_GROUP_SYSTEM
 | \

891 
BTRFS_BLOCK_GROUP_METADATA
)

	)

893 
	#BTRFS_BLOCK_GROUP_PROFILE_MASK
 (
BTRFS_BLOCK_GROUP_RAID0
 | \

894 
BTRFS_BLOCK_GROUP_RAID1
 | \

895 
BTRFS_BLOCK_GROUP_RAID1C3
 | \

896 
BTRFS_BLOCK_GROUP_RAID1C4
 | \

897 
BTRFS_BLOCK_GROUP_RAID5
 | \

898 
BTRFS_BLOCK_GROUP_RAID6
 | \

899 
BTRFS_BLOCK_GROUP_DUP
 | \

900 
BTRFS_BLOCK_GROUP_RAID10
)

	)

901 
	#BTRFS_BLOCK_GROUP_RAID56_MASK
 (
BTRFS_BLOCK_GROUP_RAID5
 | \

902 
BTRFS_BLOCK_GROUP_RAID6
)

	)

904 
	#BTRFS_BLOCK_GROUP_RAID1_MASK
 (
BTRFS_BLOCK_GROUP_RAID1
 | \

905 
BTRFS_BLOCK_GROUP_RAID1C3
 | \

906 
BTRFS_BLOCK_GROUP_RAID1C4
)

	)

915 
	#BTRFS_AVAIL_ALLOC_BIT_SINGLE
 (1ULL << 48)

	)

921 
	#BTRFS_SPACE_INFO_GLOBAL_RSV
 (1ULL << 49)

	)

923 
	#BTRFS_EXTENDED_PROFILE_MASK
 (
BTRFS_BLOCK_GROUP_PROFILE_MASK
 | \

924 
BTRFS_AVAIL_ALLOC_BIT_SINGLE
)

	)

926 
__šlše__
 
__u64
 
	$chunk_to_ex‹nded
(
__u64
 
æags
)

928 ià((
æags
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) == 0)

929 
æags
 |ğ
BTRFS_AVAIL_ALLOC_BIT_SINGLE
;

931  
æags
;

932 
	}
}

933 
__šlše__
 
__u64
 
	$ex‹nded_to_chunk
(
__u64
 
æags
)

935  
æags
 & ~
BTRFS_AVAIL_ALLOC_BIT_SINGLE
;

936 
	}
}

938 
	sbŒfs_block_group_™em
 {

939 
__Ë64
 
	mu£d
;

940 
__Ë64
 
	mchunk_objeùid
;

941 
__Ë64
 
	mæags
;

942 } 
__©Œibu‹__
 ((
__·cked__
));

944 
	sbŒfs_ä“_¥aû_šfo
 {

945 
__Ë32
 
	mex‹Á_couÁ
;

946 
__Ë32
 
	mæags
;

947 } 
__©Œibu‹__
 ((
__·cked__
));

949 
	#BTRFS_FREE_SPACE_USING_BITMAPS
 (1ULL << 0)

	)

951 
	#BTRFS_QGROUP_LEVEL_SHIFT
 48

	)

952 
__šlše__
 
__u16
 
	$bŒfs_qgroup_Ëv–
(
__u64
 
qgroupid
)

954  (
__u16
)(
qgroupid
 >> 
BTRFS_QGROUP_LEVEL_SHIFT
);

955 
	}
}

960 
	#BTRFS_QGROUP_STATUS_FLAG_ON
 (1ULL << 0)

	)

964 
	#BTRFS_QGROUP_STATUS_FLAG_RESCAN
 (1ULL << 1)

	)

972 
	#BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
 (1ULL << 2)

	)

974 
	#BTRFS_QGROUP_STATUS_VERSION
 1

	)

976 
	sbŒfs_qgroup_¡©us_™em
 {

977 
__Ë64
 
	mv”siÚ
;

984 
__Ë64
 
	mg’”©iÚ
;

987 
__Ë64
 
	mæags
;

993 
__Ë64
 
	m»sÿn
;

994 } 
__©Œibu‹__
 ((
__·cked__
));

996 
	sbŒfs_qgroup_šfo_™em
 {

997 
__Ë64
 
	mg’”©iÚ
;

998 
__Ë64
 
	mrãr
;

999 
__Ë64
 
	mrãr_cm´
;

1000 
__Ë64
 
	mexş
;

1001 
__Ë64
 
	mexş_cm´
;

1002 } 
__©Œibu‹__
 ((
__·cked__
));

1004 
	sbŒfs_qgroup_lim™_™em
 {

1008 
__Ë64
 
	mæags
;

1009 
__Ë64
 
	mmax_rãr
;

1010 
__Ë64
 
	mmax_exş
;

1011 
__Ë64
 
	mrsv_rãr
;

1012 
__Ë64
 
	mrsv_exş
;

1013 } 
__©Œibu‹__
 ((
__·cked__
));

1015 
	sbŒfs_v”™y_desütÜ_™em
 {

1017 
__Ë64
 
	msize
;

1023 
__Ë64
 
	m»£rved
[2];

1024 
__u8
 
	m’üy±iÚ
;

1025 } 
__©Œibu‹__
 ((
__·cked__
));

	@/usr/include/linux/capability.h

14 #iâdeà
_LINUX_CAPABILITY_H


15 
	#_LINUX_CAPABILITY_H


	)

17 
	~<lšux/ty³s.h
>

30 
	#_LINUX_CAPABILITY_VERSION_1
 0x19980330

	)

31 
	#_LINUX_CAPABILITY_U32S_1
 1

	)

33 
	#_LINUX_CAPABILITY_VERSION_2
 0x20071026

	)

34 
	#_LINUX_CAPABILITY_U32S_2
 2

	)

36 
	#_LINUX_CAPABILITY_VERSION_3
 0x20080522

	)

37 
	#_LINUX_CAPABILITY_U32S_3
 2

	)

39 
	s__u£r_ÿp_h—d”_¡ruù
 {

40 
__u32
 
	mv”siÚ
;

41 
	mpid
;

42 } *
	tÿp_u£r_h—d”_t
;

44 
	s__u£r_ÿp_d©a_¡ruù
 {

45 
__u32
 
	mefãùive
;

46 
__u32
 
	m³rm™‹d
;

47 
__u32
 
	mšh”™abË
;

48 } *
	tÿp_u£r_d©a_t
;

51 
	#VFS_CAP_REVISION_MASK
 0xFF000000

	)

52 
	#VFS_CAP_REVISION_SHIFT
 24

	)

53 
	#VFS_CAP_FLAGS_MASK
 ~
VFS_CAP_REVISION_MASK


	)

54 
	#VFS_CAP_FLAGS_EFFECTIVE
 0x000001

	)

56 
	#VFS_CAP_REVISION_1
 0x01000000

	)

57 
	#VFS_CAP_U32_1
 1

	)

58 
	#XATTR_CAPS_SZ_1
 ((
__Ë32
)*(1 + 2*
VFS_CAP_U32_1
))

	)

60 
	#VFS_CAP_REVISION_2
 0x02000000

	)

61 
	#VFS_CAP_U32_2
 2

	)

62 
	#XATTR_CAPS_SZ_2
 ((
__Ë32
)*(1 + 2*
VFS_CAP_U32_2
))

	)

64 
	#VFS_CAP_REVISION_3
 0x03000000

	)

65 
	#VFS_CAP_U32_3
 2

	)

66 
	#XATTR_CAPS_SZ_3
 ((
__Ë32
)*(2 + 2*
VFS_CAP_U32_3
))

	)

68 
	#XATTR_CAPS_SZ
 
XATTR_CAPS_SZ_3


	)

69 
	#VFS_CAP_U32
 
VFS_CAP_U32_3


	)

70 
	#VFS_CAP_REVISION
 
VFS_CAP_REVISION_3


	)

72 
	svfs_ÿp_d©a
 {

73 
__Ë32
 
	mmagic_‘c
;

75 
__Ë32
 
	m³rm™‹d
;

76 
__Ë32
 
	mšh”™abË
;

77 } 
	md©a
[
VFS_CAP_U32
];

83 
	svfs_ns_ÿp_d©a
 {

84 
__Ë32
 
	mmagic_‘c
;

86 
__Ë32
 
	m³rm™‹d
;

87 
__Ë32
 
	mšh”™abË
;

88 } 
	md©a
[
VFS_CAP_U32
];

89 
__Ë32
 
	mroÙid
;

98 
	#_LINUX_CAPABILITY_VERSION
 
_LINUX_CAPABILITY_VERSION_1


	)

99 
	#_LINUX_CAPABILITY_U32S
 
_LINUX_CAPABILITY_U32S_1


	)

111 
	#CAP_CHOWN
 0

	)

117 
	#CAP_DAC_OVERRIDE
 1

	)

123 
	#CAP_DAC_READ_SEARCH
 2

	)

129 
	#CAP_FOWNER
 3

	)

138 
	#CAP_FSETID
 4

	)

144 
	#CAP_KILL
 5

	)

150 
	#CAP_SETGID
 6

	)

155 
	#CAP_SETUID
 7

	)

172 
	#CAP_SETPCAP
 8

	)

176 
	#CAP_LINUX_IMMUTABLE
 9

	)

181 
	#CAP_NET_BIND_SERVICE
 10

	)

185 
	#CAP_NET_BROADCAST
 11

	)

201 
	#CAP_NET_ADMIN
 12

	)

207 
	#CAP_NET_RAW
 13

	)

213 
	#CAP_IPC_LOCK
 14

	)

217 
	#CAP_IPC_OWNER
 15

	)

220 
	#CAP_SYS_MODULE
 16

	)

225 
	#CAP_SYS_RAWIO
 17

	)

229 
	#CAP_SYS_CHROOT
 18

	)

233 
	#CAP_SYS_PTRACE
 19

	)

237 
	#CAP_SYS_PACCT
 20

	)

276 
	#CAP_SYS_ADMIN
 21

	)

280 
	#CAP_SYS_BOOT
 22

	)

291 
	#CAP_SYS_NICE
 23

	)

306 
	#CAP_SYS_RESOURCE
 24

	)

312 
	#CAP_SYS_TIME
 25

	)

317 
	#CAP_SYS_TTY_CONFIG
 26

	)

321 
	#CAP_MKNOD
 27

	)

325 
	#CAP_LEASE
 28

	)

329 
	#CAP_AUDIT_WRITE
 29

	)

333 
	#CAP_AUDIT_CONTROL
 30

	)

338 
	#CAP_SETFCAP
 31

	)

346 
	#CAP_MAC_OVERRIDE
 32

	)

355 
	#CAP_MAC_ADMIN
 33

	)

359 
	#CAP_SYSLOG
 34

	)

363 
	#CAP_WAKE_ALARM
 35

	)

367 
	#CAP_BLOCK_SUSPEND
 36

	)

371 
	#CAP_AUDIT_READ
 37

	)

378 
	#CAP_PERFMON
 38

	)

409 
	#CAP_BPF
 39

	)

416 
	#CAP_CHECKPOINT_RESTORE
 40

	)

418 
	#CAP_LAST_CAP
 
CAP_CHECKPOINT_RESTORE


	)

420 
	#ÿp_v®id
(
x
è((xè>ğ0 && (xè<ğ
CAP_LAST_CAP
)

	)

426 
	#CAP_TO_INDEX
(
x
è((xè>> 5è

	)

427 
	#CAP_TO_MASK
(
x
è(1U << ((xè& 31)è

	)

	@/usr/include/linux/falloc.h

2 #iâdeà
_FALLOC_H_


3 
	#_FALLOC_H_


	)

5 
	#FALLOC_FL_KEEP_SIZE
 0x01

	)

6 
	#FALLOC_FL_PUNCH_HOLE
 0x02

	)

7 
	#FALLOC_FL_NO_HIDE_STALE
 0x04

	)

29 
	#FALLOC_FL_COLLAPSE_RANGE
 0x08

	)

43 
	#FALLOC_FL_ZERO_RANGE
 0x10

	)

60 
	#FALLOC_FL_INSERT_RANGE
 0x20

	)

78 
	#FALLOC_FL_UNSHARE_RANGE
 0x40

	)

	@/usr/include/linux/fiemap.h

12 #iâdeà
_LINUX_FIEMAP_H


13 
	#_LINUX_FIEMAP_H


	)

15 
	~<lšux/ty³s.h
>

17 
	sf›m­_ex‹Á
 {

18 
__u64
 
	mã_logiÿl
;

20 
__u64
 
	mã_physiÿl
;

22 
__u64
 
	mã_Ëngth
;

23 
__u64
 
	mã_»£rved64
[2];

24 
__u32
 
	mã_æags
;

25 
__u32
 
	mã_»£rved
[3];

28 
	sf›m­
 {

29 
__u64
 
	mfm_¡¬t
;

31 
__u64
 
	mfm_Ëngth
;

33 
__u32
 
	mfm_æags
;

34 
__u32
 
	mfm_m­³d_ex‹Ás
;

35 
__u32
 
	mfm_ex‹Á_couÁ
;

36 
__u32
 
	mfm_»£rved
;

37 
f›m­_ex‹Á
 
	mfm_ex‹Ás
[0];

40 
	#FIEMAP_MAX_OFFSET
 (~0ULL)

	)

42 
	#FIEMAP_FLAG_SYNC
 0x00000001

	)

43 
	#FIEMAP_FLAG_XATTR
 0x00000002

	)

44 
	#FIEMAP_FLAG_CACHE
 0x00000004

	)

46 
	#FIEMAP_FLAGS_COMPAT
 (
FIEMAP_FLAG_SYNC
 | 
FIEMAP_FLAG_XATTR
)

	)

48 
	#FIEMAP_EXTENT_LAST
 0x00000001

	)

49 
	#FIEMAP_EXTENT_UNKNOWN
 0x00000002

	)

50 
	#FIEMAP_EXTENT_DELALLOC
 0x00000004

	)

52 
	#FIEMAP_EXTENT_ENCODED
 0x00000008

	)

54 
	#FIEMAP_EXTENT_DATA_ENCRYPTED
 0x00000080

	)

56 
	#FIEMAP_EXTENT_NOT_ALIGNED
 0x00000100

	)

58 
	#FIEMAP_EXTENT_DATA_INLINE
 0x00000200

	)

60 
	#FIEMAP_EXTENT_DATA_TAIL
 0x00000400

	)

62 
	#FIEMAP_EXTENT_UNWRITTEN
 0x00000800

	)

64 
	#FIEMAP_EXTENT_MERGED
 0x00001000

	)

67 
	#FIEMAP_EXTENT_SHARED
 0x00002000

	)

	@/usr/include/linux/fs.h

2 #iâdeà
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<lšux/lim™s.h
>

14 
	~<lšux/ioùl.h
>

15 
	~<lšux/ty³s.h
>

16 
	~<lšux/fsüy±.h
>

19 
	~<lšux/mouÁ.h
>

32 #undeà
NR_OPEN


33 
	#INR_OPEN_CUR
 1024

	)

34 
	#INR_OPEN_MAX
 4096

	)

36 
	#BLOCK_SIZE_BITS
 10

	)

37 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

39 
	#SEEK_SET
 0

	)

40 
	#SEEK_CUR
 1

	)

41 
	#SEEK_END
 2

	)

42 
	#SEEK_DATA
 3

	)

43 
	#SEEK_HOLE
 4

	)

44 
	#SEEK_MAX
 
SEEK_HOLE


	)

46 
	#RENAME_NOREPLACE
 (1 << 0è

	)

47 
	#RENAME_EXCHANGE
 (1 << 1è

	)

48 
	#RENAME_WHITEOUT
 (1 << 2è

	)

50 
	sfe_şÚe_¿nge
 {

51 
__s64
 
	m¤c_fd
;

52 
__u64
 
	m¤c_off£t
;

53 
__u64
 
	m¤c_Ëngth
;

54 
__u64
 
	mde¡_off£t
;

57 
	sf¡rim_¿nge
 {

58 
__u64
 
	m¡¬t
;

59 
__u64
 
	mËn
;

60 
__u64
 
	mmšËn
;

64 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

65 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

68 
	sfe_dedu³_¿nge_šfo
 {

69 
__s64
 
	mde¡_fd
;

70 
__u64
 
	mde¡_off£t
;

71 
__u64
 
	mby‹s_dedu³d
;

78 
__s32
 
	m¡©us
;

79 
__u32
 
	m»£rved
;

83 
	sfe_dedu³_¿nge
 {

84 
__u64
 
	m¤c_off£t
;

85 
__u64
 
	m¤c_Ëngth
;

86 
__u16
 
	mde¡_couÁ
;

87 
__u16
 
	m»£rved1
;

88 
__u32
 
	m»£rved2
;

89 
fe_dedu³_¿nge_šfo
 
	mšfo
[0];

93 
	sfes_¡©_¡ruù
 {

94 
	mÄ_fes
;

95 
	mÄ_ä“_fes
;

96 
	mmax_fes
;

99 
	sšodes_¡©_t
 {

100 
	mÄ_šodes
;

101 
	mÄ_unu£d
;

102 
	mdummy
[5];

106 
	#NR_FILE
 8192

	)

111 
	sfsx©Œ
 {

112 
__u32
 
	mfsx_xæags
;

113 
__u32
 
	mfsx_extsize
;

114 
__u32
 
	mfsx_Ãx‹Ás
;

115 
__u32
 
	mfsx_´ojid
;

116 
__u32
 
	mfsx_cowextsize
;

117 
	mfsx_·d
[8];

123 
	#FS_XFLAG_REALTIME
 0x00000001

	)

124 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

125 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

126 
	#FS_XFLAG_APPEND
 0x00000010

	)

127 
	#FS_XFLAG_SYNC
 0x00000020

	)

128 
	#FS_XFLAG_NOATIME
 0x00000040

	)

129 
	#FS_XFLAG_NODUMP
 0x00000080

	)

130 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

131 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

132 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

133 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

134 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

135 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

136 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

137 
	#FS_XFLAG_DAX
 0x00008000

	)

138 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

139 
	#FS_XFLAG_HASATTR
 0x80000000

	)

144 
	#BLKROSET
 
	`_IO
(0x12,93è

	)

145 
	#BLKROGET
 
	`_IO
(0x12,94è

	)

146 
	#BLKRRPART
 
	`_IO
(0x12,95è

	)

147 
	#BLKGETSIZE
 
	`_IO
(0x12,96è

	)

148 
	#BLKFLSBUF
 
	`_IO
(0x12,97è

	)

149 
	#BLKRASET
 
	`_IO
(0x12,98è

	)

150 
	#BLKRAGET
 
	`_IO
(0x12,99è

	)

151 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

152 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

153 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

154 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

155 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

157 
	#BLKPG
 
	`_IO
(0x12,105)

	)

161 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

162 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

167 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

168 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

169 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
è

	)

170 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_Œaû_£tup
)

	)

171 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

172 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

173 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

174 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

175 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

176 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

177 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

178 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

179 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

180 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

181 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

182 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

183 
	#BLKGETDISKSEQ
 
	`_IOR
(0x12,128,
__u64
)

	)

189 
	#BMAP_IOCTL
 1

	)

190 
	#FIBMAP
 
	`_IO
(0x00,1è

	)

191 
	#FIGETBSZ
 
	`_IO
(0x00,2è

	)

192 
	#FIFREEZE
 
	`_IOWR
('X', 119, è

	)

193 
	#FITHAW
 
	`_IOWR
('X', 120, è

	)

194 
	#FITRIM
 
	`_IOWR
('X', 121, 
f¡rim_¿nge
è

	)

195 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

196 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fe_şÚe_¿nge
)

	)

197 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fe_dedu³_¿nge
)

	)

199 
	#FSLABEL_MAX
 256

	)

201 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

202 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

203 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

204 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

205 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
f›m­
)

	)

206 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

207 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

208 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

209 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

210 
	#FS_IOC_FSGETXATTR
 
	`_IOR
('X', 31, 
fsx©Œ
)

	)

211 
	#FS_IOC_FSSETXATTR
 
	`_IOW
('X', 32, 
fsx©Œ
)

	)

212 
	#FS_IOC_GETFSLABEL
 
	`_IOR
(0x94, 49, [
FSLABEL_MAX
])

	)

213 
	#FS_IOC_SETFSLABEL
 
	`_IOW
(0x94, 50, [
FSLABEL_MAX
])

	)

235 
	#FS_SECRM_FL
 0x00000001

	)

236 
	#FS_UNRM_FL
 0x00000002

	)

237 
	#FS_COMPR_FL
 0x00000004

	)

238 
	#FS_SYNC_FL
 0x00000008

	)

239 
	#FS_IMMUTABLE_FL
 0x00000010

	)

240 
	#FS_APPEND_FL
 0x00000020

	)

241 
	#FS_NODUMP_FL
 0x00000040

	)

242 
	#FS_NOATIME_FL
 0x00000080

	)

244 
	#FS_DIRTY_FL
 0x00000100

	)

245 
	#FS_COMPRBLK_FL
 0x00000200

	)

246 
	#FS_NOCOMP_FL
 0x00000400

	)

248 
	#FS_ENCRYPT_FL
 0x00000800

	)

249 
	#FS_BTREE_FL
 0x00001000

	)

250 
	#FS_INDEX_FL
 0x00001000

	)

251 
	#FS_IMAGIC_FL
 0x00002000

	)

252 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

253 
	#FS_NOTAIL_FL
 0x00008000

	)

254 
	#FS_DIRSYNC_FL
 0x00010000

	)

255 
	#FS_TOPDIR_FL
 0x00020000

	)

256 
	#FS_HUGE_FILE_FL
 0x00040000

	)

257 
	#FS_EXTENT_FL
 0x00080000

	)

258 
	#FS_VERITY_FL
 0x00100000

	)

259 
	#FS_EA_INODE_FL
 0x00200000

	)

260 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

261 
	#FS_NOCOW_FL
 0x00800000

	)

262 
	#FS_DAX_FL
 0x02000000

	)

263 
	#FS_INLINE_DATA_FL
 0x10000000

	)

264 
	#FS_PROJINHERIT_FL
 0x20000000

	)

265 
	#FS_CASEFOLD_FL
 0x40000000

	)

266 
	#FS_RESERVED_FL
 0x80000000

	)

268 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

269 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

272 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

273 
	#SYNC_FILE_RANGE_WRITE
 2

	)

274 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

275 
	#SYNC_FILE_RANGE_WRITE_AND_WAIT
 (
SYNC_FILE_RANGE_WRITE
 | \

276 
SYNC_FILE_RANGE_WAIT_BEFORE
 | \

277 
SYNC_FILE_RANGE_WAIT_AFTER
)

	)

283 
	t__b™wi£
 
	t__k”Ãl_rwf_t
;

286 
	#RWF_HIPRI
 ((
__k”Ãl_rwf_t
)0x00000001)

	)

289 
	#RWF_DSYNC
 ((
__k”Ãl_rwf_t
)0x00000002)

	)

292 
	#RWF_SYNC
 ((
__k”Ãl_rwf_t
)0x00000004)

	)

295 
	#RWF_NOWAIT
 ((
__k”Ãl_rwf_t
)0x00000008)

	)

298 
	#RWF_APPEND
 ((
__k”Ãl_rwf_t
)0x00000010)

	)

301 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
 |\

302 
RWF_APPEND
)

	)

	@/usr/include/linux/fscrypt.h

8 #iâdeà
_LINUX_FSCRYPT_H


9 
	#_LINUX_FSCRYPT_H


	)

11 
	~<lšux/ioùl.h
>

12 
	~<lšux/ty³s.h
>

15 
	#FSCRYPT_POLICY_FLAGS_PAD_4
 0x00

	)

16 
	#FSCRYPT_POLICY_FLAGS_PAD_8
 0x01

	)

17 
	#FSCRYPT_POLICY_FLAGS_PAD_16
 0x02

	)

18 
	#FSCRYPT_POLICY_FLAGS_PAD_32
 0x03

	)

19 
	#FSCRYPT_POLICY_FLAGS_PAD_MASK
 0x03

	)

20 
	#FSCRYPT_POLICY_FLAG_DIRECT_KEY
 0x04

	)

21 
	#FSCRYPT_POLICY_FLAG_IV_INO_LBLK_64
 0x08

	)

22 
	#FSCRYPT_POLICY_FLAG_IV_INO_LBLK_32
 0x10

	)

25 
	#FSCRYPT_MODE_AES_256_XTS
 1

	)

26 
	#FSCRYPT_MODE_AES_256_CTS
 4

	)

27 
	#FSCRYPT_MODE_AES_128_CBC
 5

	)

28 
	#FSCRYPT_MODE_AES_128_CTS
 6

	)

29 
	#FSCRYPT_MODE_ADIANTUM
 9

	)

38 
	#FSCRYPT_POLICY_V1
 0

	)

39 
	#FSCRYPT_KEY_DESCRIPTOR_SIZE
 8

	)

40 
	sfsüy±_pŞicy_v1
 {

41 
__u8
 
	mv”siÚ
;

42 
__u8
 
	mcÚ‹Ás_’üy±iÚ_mode
;

43 
__u8
 
	mf’ames_’üy±iÚ_mode
;

44 
__u8
 
	mæags
;

45 
__u8
 
	mma¡”_key_desütÜ
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

52 
	#FSCRYPT_KEY_DESC_PREFIX
 "fsüy±:"

	)

53 
	#FSCRYPT_KEY_DESC_PREFIX_SIZE
 8

	)

54 
	#FSCRYPT_MAX_KEY_SIZE
 64

	)

55 
	sfsüy±_key
 {

56 
__u32
 
	mmode
;

57 
__u8
 
	m¿w
[
FSCRYPT_MAX_KEY_SIZE
];

58 
__u32
 
	msize
;

64 
	#FSCRYPT_POLICY_V2
 2

	)

65 
	#FSCRYPT_KEY_IDENTIFIER_SIZE
 16

	)

66 
	sfsüy±_pŞicy_v2
 {

67 
__u8
 
	mv”siÚ
;

68 
__u8
 
	mcÚ‹Ás_’üy±iÚ_mode
;

69 
__u8
 
	mf’ames_’üy±iÚ_mode
;

70 
__u8
 
	mæags
;

71 
__u8
 
	m__»£rved
[4];

72 
__u8
 
	mma¡”_key_id’tif›r
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

76 
	sfsüy±_g‘_pŞicy_ex_¬g
 {

77 
__u64
 
	mpŞicy_size
;

79 
__u8
 
	mv”siÚ
;

80 
fsüy±_pŞicy_v1
 
	mv1
;

81 
fsüy±_pŞicy_v2
 
	mv2
;

82 } 
	mpŞicy
;

89 
	#FSCRYPT_KEY_SPEC_TYPE_DESCRIPTOR
 1

	)

96 
	#FSCRYPT_KEY_SPEC_TYPE_IDENTIFIER
 2

	)

102 
	sfsüy±_key_¥ecif›r
 {

103 
__u32
 
	mty³
;

104 
__u32
 
	m__»£rved
;

106 
__u8
 
	m__»£rved
[32];

107 
__u8
 
	mdesütÜ
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

108 
__u8
 
	mid’tif›r
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

109 } 
	mu
;

116 
	sfsüy±_´ovisiÚšg_key_·ylßd
 {

117 
__u32
 
	mty³
;

118 
__u32
 
	m__»£rved
;

119 
__u8
 
	m¿w
[];

123 
	sfsüy±_add_key_¬g
 {

124 
fsüy±_key_¥ecif›r
 
	mkey_¥ec
;

125 
__u32
 
	m¿w_size
;

126 
__u32
 
	mkey_id
;

127 
__u32
 
	m__»£rved
[8];

128 
__u8
 
	m¿w
[];

132 
	sfsüy±_»move_key_¬g
 {

133 
fsüy±_key_¥ecif›r
 
	mkey_¥ec
;

134 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_FILES_BUSY
 0x00000001

	)

135 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_OTHER_USERS
 0x00000002

	)

136 
__u32
 
	m»mov®_¡©us_æags
;

137 
__u32
 
	m__»£rved
[5];

141 
	sfsüy±_g‘_key_¡©us_¬g
 {

143 
fsüy±_key_¥ecif›r
 
	mkey_¥ec
;

144 
__u32
 
	m__»£rved
[6];

147 
	#FSCRYPT_KEY_STATUS_ABSENT
 1

	)

148 
	#FSCRYPT_KEY_STATUS_PRESENT
 2

	)

149 
	#FSCRYPT_KEY_STATUS_INCOMPLETELY_REMOVED
 3

	)

150 
__u32
 
	m¡©us
;

151 
	#FSCRYPT_KEY_STATUS_FLAG_ADDED_BY_SELF
 0x00000001

	)

152 
__u32
 
	m¡©us_æags
;

153 
__u32
 
	mu£r_couÁ
;

154 
__u32
 
	m__out_»£rved
[13];

157 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fsüy±_pŞicy_v1
)

	)

158 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

159 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fsüy±_pŞicy_v1
)

	)

160 
	#FS_IOC_GET_ENCRYPTION_POLICY_EX
 
	`_IOWR
('f', 22, 
__u8
[9]è

	)

161 
	#FS_IOC_ADD_ENCRYPTION_KEY
 
	`_IOWR
('f', 23, 
fsüy±_add_key_¬g
)

	)

162 
	#FS_IOC_REMOVE_ENCRYPTION_KEY
 
	`_IOWR
('f', 24, 
fsüy±_»move_key_¬g
)

	)

163 
	#FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
 
	`_IOWR
('f', 25, 
fsüy±_»move_key_¬g
)

	)

164 
	#FS_IOC_GET_ENCRYPTION_KEY_STATUS
 
	`_IOWR
('f', 26, 
fsüy±_g‘_key_¡©us_¬g
)

	)

165 
	#FS_IOC_GET_ENCRYPTION_NONCE
 
	`_IOR
('f', 27, 
__u8
[16])

	)

170 
	#fsüy±_pŞicy
 
fsüy±_pŞicy_v1


	)

171 
	#FS_KEY_DESCRIPTOR_SIZE
 
FSCRYPT_KEY_DESCRIPTOR_SIZE


	)

172 
	#FS_POLICY_FLAGS_PAD_4
 
FSCRYPT_POLICY_FLAGS_PAD_4


	)

173 
	#FS_POLICY_FLAGS_PAD_8
 
FSCRYPT_POLICY_FLAGS_PAD_8


	)

174 
	#FS_POLICY_FLAGS_PAD_16
 
FSCRYPT_POLICY_FLAGS_PAD_16


	)

175 
	#FS_POLICY_FLAGS_PAD_32
 
FSCRYPT_POLICY_FLAGS_PAD_32


	)

176 
	#FS_POLICY_FLAGS_PAD_MASK
 
FSCRYPT_POLICY_FLAGS_PAD_MASK


	)

177 
	#FS_POLICY_FLAG_DIRECT_KEY
 
FSCRYPT_POLICY_FLAG_DIRECT_KEY


	)

178 
	#FS_POLICY_FLAGS_VALID
 0x07

	)

179 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

180 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 
FSCRYPT_MODE_AES_256_XTS


	)

181 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

182 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

183 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 
FSCRYPT_MODE_AES_256_CTS


	)

184 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 
FSCRYPT_MODE_AES_128_CBC


	)

185 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 
FSCRYPT_MODE_AES_128_CTS


	)

186 
	#FS_ENCRYPTION_MODE_SPECK128_256_XTS
 7

	)

187 
	#FS_ENCRYPTION_MODE_SPECK128_256_CTS
 8

	)

188 
	#FS_ENCRYPTION_MODE_ADIANTUM
 
FSCRYPT_MODE_ADIANTUM


	)

189 
	#FS_KEY_DESC_PREFIX
 
FSCRYPT_KEY_DESC_PREFIX


	)

190 
	#FS_KEY_DESC_PREFIX_SIZE
 
FSCRYPT_KEY_DESC_PREFIX_SIZE


	)

191 
	#FS_MAX_KEY_SIZE
 
FSCRYPT_MAX_KEY_SIZE


	)

	@/usr/include/linux/fsverity.h

10 #iâdeà
_LINUX_FSVERITY_H


11 
	#_LINUX_FSVERITY_H


	)

13 
	~<lšux/ioùl.h
>

14 
	~<lšux/ty³s.h
>

16 
	#FS_VERITY_HASH_ALG_SHA256
 1

	)

17 
	#FS_VERITY_HASH_ALG_SHA512
 2

	)

19 
	sfsv”™y_’abË_¬g
 {

20 
__u32
 
	mv”siÚ
;

21 
__u32
 
	mhash_®gÜ™hm
;

22 
__u32
 
	mblock_size
;

23 
__u32
 
	m§É_size
;

24 
__u64
 
	m§É_±r
;

25 
__u32
 
	msig_size
;

26 
__u32
 
	m__»£rved1
;

27 
__u64
 
	msig_±r
;

28 
__u64
 
	m__»£rved2
[11];

31 
	sfsv”™y_dige¡
 {

32 
__u16
 
	mdige¡_®gÜ™hm
;

33 
__u16
 
	mdige¡_size
;

34 
__u8
 
	mdige¡
[];

47 
	sfsv”™y_desütÜ
 {

48 
__u8
 
	mv”siÚ
;

49 
__u8
 
	mhash_®gÜ™hm
;

50 
__u8
 
	mlog_blocksize
;

51 
__u8
 
	m§É_size
;

52 
__Ë32
 
	m__»£rved_0x04
;

53 
__Ë64
 
	md©a_size
;

54 
__u8
 
	mroÙ_hash
[64];

55 
__u8
 
	m§É
[32];

56 
__u8
 
	m__»£rved
[144];

72 
	sfsv”™y_fÜm©‹d_dige¡
 {

73 
	mmagic
[8];

74 
__Ë16
 
	mdige¡_®gÜ™hm
;

75 
__Ë16
 
	mdige¡_size
;

76 
__u8
 
	mdige¡
[];

79 
	#FS_VERITY_METADATA_TYPE_MERKLE_TREE
 1

	)

80 
	#FS_VERITY_METADATA_TYPE_DESCRIPTOR
 2

	)

81 
	#FS_VERITY_METADATA_TYPE_SIGNATURE
 3

	)

83 
	sfsv”™y_»ad_m‘ad©a_¬g
 {

84 
__u64
 
	mm‘ad©a_ty³
;

85 
__u64
 
	moff£t
;

86 
__u64
 
	mËngth
;

87 
__u64
 
	mbuf_±r
;

88 
__u64
 
	m__»£rved
;

91 
	#FS_IOC_ENABLE_VERITY
 
	`_IOW
('f', 133, 
fsv”™y_’abË_¬g
)

	)

92 
	#FS_IOC_MEASURE_VERITY
 
	`_IOWR
('f', 134, 
fsv”™y_dige¡
)

	)

93 
	#FS_IOC_READ_VERITY_METADATA
 \

94 
	`_IOWR
('f', 135, 
fsv”™y_»ad_m‘ad©a_¬g
)

	)

	@/usr/include/linux/kernel.h

2 #iâdeà
_LINUX_KERNEL_H


3 
	#_LINUX_KERNEL_H


	)

5 
	~<lšux/sysšfo.h
>

6 
	~<lšux/cÚ¡.h
>

	@/usr/include/linux/magic.h

2 #iâdeà
__LINUX_MAGIC_H__


3 
	#__LINUX_MAGIC_H__


	)

5 
	#ADFS_SUPER_MAGIC
 0xadf5

	)

6 
	#AFFS_SUPER_MAGIC
 0xadff

	)

7 
	#AFS_SUPER_MAGIC
 0x5346414F

	)

8 
	#AUTOFS_SUPER_MAGIC
 0x0187

	)

9 
	#CODA_SUPER_MAGIC
 0x73757245

	)

10 
	#CRAMFS_MAGIC
 0x28cd3d45

	)

11 
	#CRAMFS_MAGIC_WEND
 0x453dcd28

	)

12 
	#DEBUGFS_MAGIC
 0x64626720

	)

13 
	#SECURITYFS_MAGIC
 0x73636673

	)

14 
	#SELINUX_MAGIC
 0xf97cff8c

	)

15 
	#SMACK_MAGIC
 0x43415d53

	)

16 
	#RAMFS_MAGIC
 0x858458f6

	)

17 
	#TMPFS_MAGIC
 0x01021994

	)

18 
	#HUGETLBFS_MAGIC
 0x958458f6

	)

19 
	#SQUASHFS_MAGIC
 0x73717368

	)

20 
	#ECRYPTFS_SUPER_MAGIC
 0xf15f

	)

21 
	#EFS_SUPER_MAGIC
 0x414A53

	)

22 
	#EROFS_SUPER_MAGIC_V1
 0xE0F5E1E2

	)

23 
	#EXT2_SUPER_MAGIC
 0xEF53

	)

24 
	#EXT3_SUPER_MAGIC
 0xEF53

	)

25 
	#XENFS_SUPER_MAGIC
 0xabba1974

	)

26 
	#EXT4_SUPER_MAGIC
 0xEF53

	)

27 
	#BTRFS_SUPER_MAGIC
 0x9123683E

	)

28 
	#NILFS_SUPER_MAGIC
 0x3434

	)

29 
	#F2FS_SUPER_MAGIC
 0xF2F52010

	)

30 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

31 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

32 
	#JFFS2_SUPER_MAGIC
 0x72b6

	)

33 
	#XFS_SUPER_MAGIC
 0x58465342

	)

34 
	#PSTOREFS_MAGIC
 0x6165676C

	)

35 
	#EFIVARFS_MAGIC
 0xde5e81e4

	)

36 
	#HOSTFS_SUPER_MAGIC
 0x00c0fãe

	)

37 
	#OVERLAYFS_SUPER_MAGIC
 0x794c7630

	)

39 
	#MINIX_SUPER_MAGIC
 0x137F

	)

40 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

41 
	#MINIX2_SUPER_MAGIC
 0x2468

	)

42 
	#MINIX2_SUPER_MAGIC2
 0x2478

	)

43 
	#MINIX3_SUPER_MAGIC
 0x4d5¨

	)

45 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

46 
	#NCP_SUPER_MAGIC
 0x564ø

	)

47 
	#NFS_SUPER_MAGIC
 0x6969

	)

48 
	#OCFS2_SUPER_MAGIC
 0x7461636f

	)

49 
	#OPENPROM_SUPER_MAGIC
 0x9ç1

	)

50 
	#QNX4_SUPER_MAGIC
 0x002à

	)

51 
	#QNX6_SUPER_MAGIC
 0x68191122

	)

52 
	#AFS_FS_MAGIC
 0x6B414653

	)

54 
	#REISERFS_SUPER_MAGIC
 0x52654973

	)

57 
	#REISERFS_SUPER_MAGIC_STRING
 "ReIsErFs"

	)

58 
	#REISER2FS_SUPER_MAGIC_STRING
 "ReIsEr2Fs"

	)

59 
	#REISER2FS_JR_SUPER_MAGIC_STRING
 "ReIsEr3Fs"

	)

61 
	#SMB_SUPER_MAGIC
 0x517B

	)

62 
	#CGROUP_SUPER_MAGIC
 0x27e0eb

	)

63 
	#CGROUP2_SUPER_MAGIC
 0x63677270

	)

65 
	#RDTGROUP_SUPER_MAGIC
 0x7655821

	)

67 
	#STACK_END_MAGIC
 0x57AC6E9D

	)

69 
	#TRACEFS_MAGIC
 0x74726163

	)

71 
	#V9FS_MAGIC
 0x01021997

	)

73 
	#BDEVFS_MAGIC
 0x62646576

	)

74 
	#DAXFS_MAGIC
 0x64646178

	)

75 
	#BINFMTFS_MAGIC
 0x42494e4d

	)

76 
	#DEVPTS_SUPER_MAGIC
 0x1cd1

	)

77 
	#BINDERFS_SUPER_MAGIC
 0x6c6f6f70

	)

78 
	#FUTEXFS_SUPER_MAGIC
 0xBAD1DEA

	)

79 
	#PIPEFS_MAGIC
 0x50495045

	)

80 
	#PROC_SUPER_MAGIC
 0x9ç0

	)

81 
	#SOCKFS_MAGIC
 0x534F434B

	)

82 
	#SYSFS_MAGIC
 0x62656572

	)

83 
	#USBDEVICE_SUPER_MAGIC
 0x9ç2

	)

84 
	#MTD_INODE_FS_MAGIC
 0x11307854

	)

85 
	#ANON_INODE_FS_MAGIC
 0x09041934

	)

86 
	#BTRFS_TEST_MAGIC
 0x73727279

	)

87 
	#NSFS_MAGIC
 0x6e736673

	)

88 
	#BPF_FS_MAGIC
 0xÿã4a11

	)

89 
	#AAFS_MAGIC
 0x5a3c69f0

	)

90 
	#ZONEFS_MAGIC
 0x5a4f4653

	)

93 
	#UDF_SUPER_MAGIC
 0x15013346

	)

94 
	#BALLOON_KVM_MAGIC
 0x13661366

	)

95 
	#ZSMALLOC_MAGIC
 0x58295829

	)

96 
	#DMA_BUF_MAGIC
 0x444d4142

	)

97 
	#DEVMEM_MAGIC
 0x454d444d

	)

98 
	#Z3FOLD_MAGIC
 0x33

	)

99 
	#PPC_CMM_MAGIC
 0xc7571590

	)

100 
	#SECRETMEM_MAGIC
 0x5345434d

	)

102 
	#SHIFTFS_MAGIC
 0x6a656a62

	)

	@/usr/include/linux/mman.h

2 #iâdeà
_LINUX_MMAN_H


3 
	#_LINUX_MMAN_H


	)

5 
	~<asm/mmª.h
>

6 
	~<asm-g’”ic/hug‘lb_’code.h
>

8 
	#MREMAP_MAYMOVE
 1

	)

9 
	#MREMAP_FIXED
 2

	)

10 
	#MREMAP_DONTUNMAP
 4

	)

12 
	#OVERCOMMIT_GUESS
 0

	)

13 
	#OVERCOMMIT_ALWAYS
 1

	)

14 
	#OVERCOMMIT_NEVER
 2

	)

16 
	#MAP_SHARED
 0x01

	)

17 
	#MAP_PRIVATE
 0x02

	)

18 
	#MAP_SHARED_VALIDATE
 0x03

	)

27 
	#MAP_HUGE_SHIFT
 
HUGETLB_FLAG_ENCODE_SHIFT


	)

28 
	#MAP_HUGE_MASK
 
HUGETLB_FLAG_ENCODE_MASK


	)

30 
	#MAP_HUGE_16KB
 
HUGETLB_FLAG_ENCODE_16KB


	)

31 
	#MAP_HUGE_64KB
 
HUGETLB_FLAG_ENCODE_64KB


	)

32 
	#MAP_HUGE_512KB
 
HUGETLB_FLAG_ENCODE_512KB


	)

33 
	#MAP_HUGE_1MB
 
HUGETLB_FLAG_ENCODE_1MB


	)

34 
	#MAP_HUGE_2MB
 
HUGETLB_FLAG_ENCODE_2MB


	)

35 
	#MAP_HUGE_8MB
 
HUGETLB_FLAG_ENCODE_8MB


	)

36 
	#MAP_HUGE_16MB
 
HUGETLB_FLAG_ENCODE_16MB


	)

37 
	#MAP_HUGE_32MB
 
HUGETLB_FLAG_ENCODE_32MB


	)

38 
	#MAP_HUGE_256MB
 
HUGETLB_FLAG_ENCODE_256MB


	)

39 
	#MAP_HUGE_512MB
 
HUGETLB_FLAG_ENCODE_512MB


	)

40 
	#MAP_HUGE_1GB
 
HUGETLB_FLAG_ENCODE_1GB


	)

41 
	#MAP_HUGE_2GB
 
HUGETLB_FLAG_ENCODE_2GB


	)

42 
	#MAP_HUGE_16GB
 
HUGETLB_FLAG_ENCODE_16GB


	)

	@/usr/include/linux/module.h

2 #iâdeà
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/mount.h

1 #iâdeà
_LINUX_MOUNT_H


2 
	#_LINUX_MOUNT_H


	)

4 
	~<lšux/ty³s.h
>

13 
	#MS_RDONLY
 1

	)

14 
	#MS_NOSUID
 2

	)

15 
	#MS_NODEV
 4

	)

16 
	#MS_NOEXEC
 8

	)

17 
	#MS_SYNCHRONOUS
 16

	)

18 
	#MS_REMOUNT
 32

	)

19 
	#MS_MANDLOCK
 64

	)

20 
	#MS_DIRSYNC
 128

	)

21 
	#MS_NOSYMFOLLOW
 256

	)

22 
	#MS_NOATIME
 1024

	)

23 
	#MS_NODIRATIME
 2048

	)

24 
	#MS_BIND
 4096

	)

25 
	#MS_MOVE
 8192

	)

26 
	#MS_REC
 16384

	)

27 
	#MS_VERBOSE
 32768

	)

29 
	#MS_SILENT
 32768

	)

30 
	#MS_POSIXACL
 (1<<16è

	)

31 
	#MS_UNBINDABLE
 (1<<17è

	)

32 
	#MS_PRIVATE
 (1<<18è

	)

33 
	#MS_SLAVE
 (1<<19è

	)

34 
	#MS_SHARED
 (1<<20è

	)

35 
	#MS_RELATIME
 (1<<21è

	)

36 
	#MS_KERNMOUNT
 (1<<22è

	)

37 
	#MS_I_VERSION
 (1<<23è

	)

38 
	#MS_STRICTATIME
 (1<<24è

	)

39 
	#MS_LAZYTIME
 (1<<25è

	)

42 
	#MS_SUBMOUNT
 (1<<26)

	)

43 
	#MS_NOREMOTELOCK
 (1<<27)

	)

44 
	#MS_NOSEC
 (1<<28)

	)

45 
	#MS_BORN
 (1<<29)

	)

46 
	#MS_ACTIVE
 (1<<30)

	)

47 
	#MS_NOUSER
 (1<<31)

	)

52 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

53 
MS_LAZYTIME
)

	)

58 
	#MS_MGC_VAL
 0xC0ED0000

	)

59 
	#MS_MGC_MSK
 0xffff0000

	)

64 
	#OPEN_TREE_CLONE
 1

	)

65 
	#OPEN_TREE_CLOEXEC
 
O_CLOEXEC


	)

70 
	#MOVE_MOUNT_F_SYMLINKS
 0x00000001

	)

71 
	#MOVE_MOUNT_F_AUTOMOUNTS
 0x00000002

	)

72 
	#MOVE_MOUNT_F_EMPTY_PATH
 0x00000004

	)

73 
	#MOVE_MOUNT_T_SYMLINKS
 0x00000010

	)

74 
	#MOVE_MOUNT_T_AUTOMOUNTS
 0x00000020

	)

75 
	#MOVE_MOUNT_T_EMPTY_PATH
 0x00000040

	)

76 
	#MOVE_MOUNT_SET_GROUP
 0x00000100

	)

77 
	#MOVE_MOUNT__MASK
 0x00000177

	)

82 
	#FSOPEN_CLOEXEC
 0x00000001

	)

87 
	#FSPICK_CLOEXEC
 0x00000001

	)

88 
	#FSPICK_SYMLINK_NOFOLLOW
 0x00000002

	)

89 
	#FSPICK_NO_AUTOMOUNT
 0x00000004

	)

90 
	#FSPICK_EMPTY_PATH
 0x00000008

	)

95 
	efscÚfig_commªd
 {

96 
	mFSCONFIG_SET_FLAG
 = 0,

97 
	mFSCONFIG_SET_STRING
 = 1,

98 
	mFSCONFIG_SET_BINARY
 = 2,

99 
	mFSCONFIG_SET_PATH
 = 3,

100 
	mFSCONFIG_SET_PATH_EMPTY
 = 4,

101 
	mFSCONFIG_SET_FD
 = 5,

102 
	mFSCONFIG_CMD_CREATE
 = 6,

103 
	mFSCONFIG_CMD_RECONFIGURE
 = 7,

109 
	#FSMOUNT_CLOEXEC
 0x00000001

	)

114 
	#MOUNT_ATTR_RDONLY
 0x00000001

	)

115 
	#MOUNT_ATTR_NOSUID
 0x00000002

	)

116 
	#MOUNT_ATTR_NODEV
 0x00000004

	)

117 
	#MOUNT_ATTR_NOEXEC
 0x00000008

	)

118 
	#MOUNT_ATTR__ATIME
 0x00000070

	)

119 
	#MOUNT_ATTR_RELATIME
 0x00000000

	)

120 
	#MOUNT_ATTR_NOATIME
 0x00000010

	)

121 
	#MOUNT_ATTR_STRICTATIME
 0x00000020

	)

122 
	#MOUNT_ATTR_NODIRATIME
 0x00000080

	)

123 
	#MOUNT_ATTR_IDMAP
 0x00100000

	)

124 
	#MOUNT_ATTR_NOSYMFOLLOW
 0x00200000

	)

129 
	smouÁ_©Œ
 {

130 
__u64
 
	m©Œ_£t
;

131 
__u64
 
	m©Œ_şr
;

132 
__u64
 
	m´İag©iÚ
;

133 
__u64
 
	mu£ºs_fd
;

137 
	#MOUNT_ATTR_SIZE_VER0
 32

	)

	@/usr/include/linux/posix_acl.h

18 #iâdeà
__UAPI_POSIX_ACL_H


19 
	#__UAPI_POSIX_ACL_H


	)

21 
	#ACL_UNDEFINED_ID
 (-1)

	)

24 
	#ACL_TYPE_ACCESS
 (0x8000)

	)

25 
	#ACL_TYPE_DEFAULT
 (0x4000)

	)

28 
	#ACL_USER_OBJ
 (0x01)

	)

29 
	#ACL_USER
 (0x02)

	)

30 
	#ACL_GROUP_OBJ
 (0x04)

	)

31 
	#ACL_GROUP
 (0x08)

	)

32 
	#ACL_MASK
 (0x10)

	)

33 
	#ACL_OTHER
 (0x20)

	)

36 
	#ACL_READ
 (0x04)

	)

37 
	#ACL_WRITE
 (0x02)

	)

38 
	#ACL_EXECUTE
 (0x01)

	)

	@/usr/include/linux/posix_acl_xattr.h

18 #iâdeà
__UAPI_POSIX_ACL_XATTR_H


19 
	#__UAPI_POSIX_ACL_XATTR_H


	)

21 
	~<lšux/ty³s.h
>

24 
	#POSIX_ACL_XATTR_VERSION
 0x0002

	)

27 
	#ACL_UNDEFINED_ID
 (-1)

	)

29 
	sposix_aş_x©Œ_’Œy
 {

30 
__Ë16
 
	me_g
;

31 
__Ë16
 
	me_³rm
;

32 
__Ë32
 
	me_id
;

35 
	sposix_aş_x©Œ_h—d”
 {

36 
__Ë32
 
	ma_v”siÚ
;

	@/usr/include/linux/sched.h

2 #iâdeà
_LINUX_SCHED_H


3 
	#_LINUX_SCHED_H


	)

5 
	~<lšux/ty³s.h
>

10 
	#CSIGNAL
 0x000000fà

	)

11 
	#CLONE_VM
 0x00000100

	)

12 
	#CLONE_FS
 0x00000200

	)

13 
	#CLONE_FILES
 0x00000400

	)

14 
	#CLONE_SIGHAND
 0x00000800

	)

15 
	#CLONE_PIDFD
 0x00001000

	)

16 
	#CLONE_PTRACE
 0x00002000

	)

17 
	#CLONE_VFORK
 0x00004000

	)

18 
	#CLONE_PARENT
 0x00008000

	)

19 
	#CLONE_THREAD
 0x00010000

	)

20 
	#CLONE_NEWNS
 0x00020000

	)

21 
	#CLONE_SYSVSEM
 0x00040000

	)

22 
	#CLONE_SETTLS
 0x00080000

	)

23 
	#CLONE_PARENT_SETTID
 0x00100000

	)

24 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

25 
	#CLONE_DETACHED
 0x00400000

	)

26 
	#CLONE_UNTRACED
 0x00800000

	)

27 
	#CLONE_CHILD_SETTID
 0x01000000

	)

28 
	#CLONE_NEWCGROUP
 0x02000000

	)

29 
	#CLONE_NEWUTS
 0x04000000

	)

30 
	#CLONE_NEWIPC
 0x08000000

	)

31 
	#CLONE_NEWUSER
 0x10000000

	)

32 
	#CLONE_NEWPID
 0x20000000

	)

33 
	#CLONE_NEWNET
 0x40000000

	)

34 
	#CLONE_IO
 0x80000000

	)

37 
	#CLONE_CLEAR_SIGHAND
 0x100000000ULL

	)

38 
	#CLONE_INTO_CGROUP
 0x200000000ULL

	)

44 
	#CLONE_NEWTIME
 0x00000080

	)

46 #iâdeà
__ASSEMBLY__


92 
	sşÚe_¬gs
 {

93 
__®igÃd_u64
 
	mæags
;

94 
__®igÃd_u64
 
	mpidfd
;

95 
__®igÃd_u64
 
	mchd_tid
;

96 
__®igÃd_u64
 
	m·»Á_tid
;

97 
__®igÃd_u64
 
	mex™_sigÇl
;

98 
__®igÃd_u64
 
	m¡ack
;

99 
__®igÃd_u64
 
	m¡ack_size
;

100 
__®igÃd_u64
 
	ms
;

101 
__®igÃd_u64
 
	m£t_tid
;

102 
__®igÃd_u64
 
	m£t_tid_size
;

103 
__®igÃd_u64
 
	mcgroup
;

107 
	#CLONE_ARGS_SIZE_VER0
 64

	)

108 
	#CLONE_ARGS_SIZE_VER1
 80

	)

109 
	#CLONE_ARGS_SIZE_VER2
 88

	)

114 
	#SCHED_NORMAL
 0

	)

115 
	#SCHED_FIFO
 1

	)

116 
	#SCHED_RR
 2

	)

117 
	#SCHED_BATCH
 3

	)

119 
	#SCHED_IDLE
 5

	)

120 
	#SCHED_DEADLINE
 6

	)

123 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

128 
	#SCHED_FLAG_RESET_ON_FORK
 0x01

	)

129 
	#SCHED_FLAG_RECLAIM
 0x02

	)

130 
	#SCHED_FLAG_DL_OVERRUN
 0x04

	)

131 
	#SCHED_FLAG_KEEP_POLICY
 0x08

	)

132 
	#SCHED_FLAG_KEEP_PARAMS
 0x10

	)

133 
	#SCHED_FLAG_UTIL_CLAMP_MIN
 0x20

	)

134 
	#SCHED_FLAG_UTIL_CLAMP_MAX
 0x40

	)

136 
	#SCHED_FLAG_KEEP_ALL
 (
SCHED_FLAG_KEEP_POLICY
 | \

137 
SCHED_FLAG_KEEP_PARAMS
)

	)

139 
	#SCHED_FLAG_UTIL_CLAMP
 (
SCHED_FLAG_UTIL_CLAMP_MIN
 | \

140 
SCHED_FLAG_UTIL_CLAMP_MAX
)

	)

142 
	#SCHED_FLAG_ALL
 (
SCHED_FLAG_RESET_ON_FORK
 | \

143 
SCHED_FLAG_RECLAIM
 | \

144 
SCHED_FLAG_DL_OVERRUN
 | \

145 
SCHED_FLAG_KEEP_ALL
 | \

146 
SCHED_FLAG_UTIL_CLAMP
)

	)

	@/usr/include/linux/stddef.h

2 #iâdeà
_LINUX_STDDEF_H


3 
	#_LINUX_STDDEF_H


	)

7 #iâdeà
__®ways_šlše


8 
	#__®ways_šlše
 
__šlše__


	)

26 
	#__¡ruù_group
(
TAG
, 
NAME
, 
ATTRS
, 
MEMBERS
...) \

28 ¡ruù { 
MEMBERS
 } 
ATTRS
; \

29 
	sTAG
 { 
MEMBERS
 } 
ATTRS
 
NAME
; \

30 } 
ATTRS


	)

42 
	#__DECLARE_FLEX_ARRAY
(
TYPE
, 
NAME
) \

44 ¡ruù { } 
__em±y_
 ## 
NAME
; \

45 
TYPE
 
NAME
[]; \

46 }

	)

	@/usr/include/linux/string.h

2 #iâdeà
_LINUX_STRING_H_


3 
	#_LINUX_STRING_H_


	)

7 
	~<¡ršg.h
>

	@/usr/include/linux/time.h

2 #iâdeà
_LINUX_TIME_H


3 
	#_LINUX_TIME_H


	)

5 
	~<lšux/ty³s.h
>

6 
	~<lšux/time_ty³s.h
>

8 #iâdeà
_STRUCT_TIMESPEC


9 
	#_STRUCT_TIMESPEC


	)

10 
	stime¥ec
 {

11 
__k”Ãl_Şd_time_t
 
	mtv_£c
;

12 
	mtv_n£c
;

16 
	stimev®
 {

17 
__k”Ãl_Şd_time_t
 
	mtv_£c
;

18 
__k”Ãl_su£cÚds_t
 
	mtv_u£c
;

21 
	s™im”¥ec
 {

22 
time¥ec
 
	m™_š‹rv®
;

23 
time¥ec
 
	m™_v®ue
;

26 
	s™im”v®
 {

27 
timev®
 
	m™_š‹rv®
;

28 
timev®
 
	m™_v®ue
;

31 
	stimezÚe
 {

32 
	mtz_mšu‹swe¡
;

33 
	mtz_d¡time
;

40 
	#ITIMER_REAL
 0

	)

41 
	#ITIMER_VIRTUAL
 1

	)

42 
	#ITIMER_PROF
 2

	)

47 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

49 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

50 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

51 
	#CLOCK_MONOTONIC_RAW
 4

	)

52 
	#CLOCK_REALTIME_COARSE
 5

	)

53 
	#CLOCK_MONOTONIC_COARSE
 6

	)

54 
	#CLOCK_BOOTTIME
 7

	)

55 
	#CLOCK_REALTIME_ALARM
 8

	)

56 
	#CLOCK_BOOTTIME_ALARM
 9

	)

61 
	#CLOCK_SGI_CYCLE
 10

	)

62 
	#CLOCK_TAI
 11

	)

64 
	#MAX_CLOCKS
 16

	)

65 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

66 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

71 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/types.h

2 #iâdeà
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty³s.h
>

7 #iâdeà
__ASSEMBLY__


9 
	~<lšux/posix_ty³s.h
>

17 #ifdeà
__CHECKER__


18 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

20 
	#__b™wi£__


	)

22 
	#__b™wi£
 
__b™wi£__


	)

24 
__u16
 
	t__b™wi£
 
	t__Ë16
;

25 
__u16
 
	t__b™wi£
 
	t__be16
;

26 
__u32
 
	t__b™wi£
 
	t__Ë32
;

27 
__u32
 
	t__b™wi£
 
	t__be32
;

28 
__u64
 
	t__b™wi£
 
	t__Ë64
;

29 
__u64
 
	t__b™wi£
 
	t__be64
;

31 
__u16
 
	t__b™wi£
 
	t__sum16
;

32 
__u32
 
	t__b™wi£
 
	t__wsum
;

43 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

44 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

45 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

47 
	t__b™wi£
 
	t__pŞl_t
;

	@/usr/include/linux/uio.h

10 #iâdeà
__LINUX_UIO_H


11 
	#__LINUX_UIO_H


	)

14 
	~<lšux/ty³s.h
>

17 
	siovec


19 *
	miov_ba£
;

20 
__k”Ãl_size_t
 
	miov_Ën
;

27 
	#UIO_FASTIOV
 8

	)

28 
	#UIO_MAXIOV
 1024

	)

	@/usr/include/linux/uuid.h

18 #iâdeà
_LINUX_UUID_H_


19 
	#_LINUX_UUID_H_


	)

21 
	~<lšux/ty³s.h
>

24 
__u8
 
	mb
[16];

25 } 
	tguid_t
;

27 
	#GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

28 ((
guid_t
) \

29 {{ (
a
) & 0xff, ((a) >> 8) & 0xff, ((a) >> 16) & 0xff, ((a) >> 24) & 0xff, \

30 (
b
) & 0xff, ((b) >> 8) & 0xff, \

31 (
c
) & 0xff, ((c) >> 8) & 0xff, \

32 (
d0
), (
d1
), (
d2
), (
d3
), (
d4
), (
d5
), (
d6
), (
d7
è}})

	)

35 
guid_t
 
	tuuid_Ë
;

36 
	#UUID_LE
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

37 
	`GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
)

	)

38 
	#NULL_UUID_LE
 \

39 
	`UUID_LE
(0x00000000, 0x0000, 0x0000, 0x00, 0x00, 0x00, 0x00, \

40 0x00, 0x00, 0x00, 0x00)

	)

	@/usr/include/linux/wait.h

2 #iâdeà
_LINUX_WAIT_H


3 
	#_LINUX_WAIT_H


	)

5 
	#WNOHANG
 0x00000001

	)

6 
	#WUNTRACED
 0x00000002

	)

7 
	#WSTOPPED
 
WUNTRACED


	)

8 
	#WEXITED
 0x00000004

	)

9 
	#WCONTINUED
 0x00000008

	)

10 
	#WNOWAIT
 0x01000000

	)

12 
	#__WNOTHREAD
 0x20000000

	)

13 
	#__WALL
 0x40000000

	)

14 
	#__WCLONE
 0x80000000

	)

17 
	#P_ALL
 0

	)

18 
	#P_PID
 1

	)

19 
	#P_PGID
 2

	)

20 
	#P_PIDFD
 3

	)

	@/usr/include/linux/xattr.h

13 
	~<lšux/libc-com·t.h
>

15 #iâdeà
_LINUX_XATTR_H


16 
	#_LINUX_XATTR_H


	)

18 #ià
__UAPI_DEF_XATTR


19 
	#__USE_KERNEL_XATTR_DEFS


	)

21 
	#XATTR_CREATE
 0x1

	)

22 
	#XATTR_REPLACE
 0x2

	)

26 
	#XATTR_OS2_PREFIX
 "os2."

	)

27 
	#XATTR_OS2_PREFIX_LEN
 ((
XATTR_OS2_PREFIX
è- 1)

	)

29 
	#XATTR_MAC_OSX_PREFIX
 "osx."

	)

30 
	#XATTR_MAC_OSX_PREFIX_LEN
 ((
XATTR_MAC_OSX_PREFIX
è- 1)

	)

32 
	#XATTR_BTRFS_PREFIX
 "bŒfs."

	)

33 
	#XATTR_BTRFS_PREFIX_LEN
 ((
XATTR_BTRFS_PREFIX
è- 1)

	)

35 
	#XATTR_HURD_PREFIX
 "gnu."

	)

36 
	#XATTR_HURD_PREFIX_LEN
 ((
XATTR_HURD_PREFIX
è- 1)

	)

38 
	#XATTR_SECURITY_PREFIX
 "£cur™y."

	)

39 
	#XATTR_SECURITY_PREFIX_LEN
 ((
XATTR_SECURITY_PREFIX
è- 1)

	)

41 
	#XATTR_SYSTEM_PREFIX
 "sy¡em."

	)

42 
	#XATTR_SYSTEM_PREFIX_LEN
 ((
XATTR_SYSTEM_PREFIX
è- 1)

	)

44 
	#XATTR_TRUSTED_PREFIX
 "Œu¡ed."

	)

45 
	#XATTR_TRUSTED_PREFIX_LEN
 ((
XATTR_TRUSTED_PREFIX
è- 1)

	)

47 
	#XATTR_USER_PREFIX
 "u£r."

	)

48 
	#XATTR_USER_PREFIX_LEN
 ((
XATTR_USER_PREFIX
è- 1)

	)

51 
	#XATTR_EVM_SUFFIX
 "evm"

	)

52 
	#XATTR_NAME_EVM
 
XATTR_SECURITY_PREFIX
 
XATTR_EVM_SUFFIX


	)

54 
	#XATTR_IMA_SUFFIX
 "ima"

	)

55 
	#XATTR_NAME_IMA
 
XATTR_SECURITY_PREFIX
 
XATTR_IMA_SUFFIX


	)

57 
	#XATTR_SELINUX_SUFFIX
 "£lšux"

	)

58 
	#XATTR_NAME_SELINUX
 
XATTR_SECURITY_PREFIX
 
XATTR_SELINUX_SUFFIX


	)

60 
	#XATTR_SMACK_SUFFIX
 "SMACK64"

	)

61 
	#XATTR_SMACK_IPIN
 "SMACK64IPIN"

	)

62 
	#XATTR_SMACK_IPOUT
 "SMACK64IPOUT"

	)

63 
	#XATTR_SMACK_EXEC
 "SMACK64EXEC"

	)

64 
	#XATTR_SMACK_TRANSMUTE
 "SMACK64TRANSMUTE"

	)

65 
	#XATTR_SMACK_MMAP
 "SMACK64MMAP"

	)

66 
	#XATTR_NAME_SMACK
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_SUFFIX


	)

67 
	#XATTR_NAME_SMACKIPIN
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPIN


	)

68 
	#XATTR_NAME_SMACKIPOUT
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPOUT


	)

69 
	#XATTR_NAME_SMACKEXEC
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_EXEC


	)

70 
	#XATTR_NAME_SMACKTRANSMUTE
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_TRANSMUTE


	)

71 
	#XATTR_NAME_SMACKMMAP
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_MMAP


	)

73 
	#XATTR_APPARMOR_SUFFIX
 "­·rmÜ"

	)

74 
	#XATTR_NAME_APPARMOR
 
XATTR_SECURITY_PREFIX
 
XATTR_APPARMOR_SUFFIX


	)

76 
	#XATTR_CAPS_SUFFIX
 "ÿ·b™y"

	)

77 
	#XATTR_NAME_CAPS
 
XATTR_SECURITY_PREFIX
 
XATTR_CAPS_SUFFIX


	)

79 
	#XATTR_POSIX_ACL_ACCESS
 "posix_aş_acûss"

	)

80 
	#XATTR_NAME_POSIX_ACL_ACCESS
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_ACCESS


	)

81 
	#XATTR_POSIX_ACL_DEFAULT
 "posix_aş_deçuÉ"

	)

82 
	#XATTR_NAME_POSIX_ACL_DEFAULT
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_DEFAULT


	)

	@/usr/include/asm-generic/hugetlb_encode.h

1 #iâdeà
_ASM_GENERIC_HUGETLB_ENCODE_H_


2 
	#_ASM_GENERIC_HUGETLB_ENCODE_H_


	)

20 
	#HUGETLB_FLAG_ENCODE_SHIFT
 26

	)

21 
	#HUGETLB_FLAG_ENCODE_MASK
 0x3f

	)

23 
	#HUGETLB_FLAG_ENCODE_16KB
 (14U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

24 
	#HUGETLB_FLAG_ENCODE_64KB
 (16U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

25 
	#HUGETLB_FLAG_ENCODE_512KB
 (19U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

26 
	#HUGETLB_FLAG_ENCODE_1MB
 (20U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

27 
	#HUGETLB_FLAG_ENCODE_2MB
 (21U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

28 
	#HUGETLB_FLAG_ENCODE_8MB
 (23U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

29 
	#HUGETLB_FLAG_ENCODE_16MB
 (24U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

30 
	#HUGETLB_FLAG_ENCODE_32MB
 (25U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

31 
	#HUGETLB_FLAG_ENCODE_256MB
 (28U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

32 
	#HUGETLB_FLAG_ENCODE_512MB
 (29U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

33 
	#HUGETLB_FLAG_ENCODE_1GB
 (30U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

34 
	#HUGETLB_FLAG_ENCODE_2GB
 (31U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

35 
	#HUGETLB_FLAG_ENCODE_16GB
 (34U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

	@/usr/include/linux/const.h

4 #iâdeà
_LINUX_CONST_H


5 
	#_LINUX_CONST_H


	)

16 #ifdeà
__ASSEMBLY__


17 
	#_AC
(
X
,
Y
è
	)
X

18 
	#_AT
(
T
,
X
è
	)
X

20 
	#__AC
(
X
,
Y
è(X##Y)

	)

21 
	#_AC
(
X
,
Y
è
	`__AC
(X,Y)

	)

22 
	#_AT
(
T
,
X
è((T)(X))

	)

25 
	#_UL
(
x
è(
	`_AC
(x, 
UL
))

	)

26 
	#_ULL
(
x
è(
	`_AC
(x, 
ULL
))

	)

28 
	#_BITUL
(
x
è(
	`_UL
(1è<< (x))

	)

29 
	#_BITULL
(
x
è(
	`_ULL
(1è<< (x))

	)

31 
	#__ALIGN_KERNEL
(
x
, 
a
è
	`__ALIGN_KERNEL_MASK
(x, (
	`__ty³of__
(x))×è- 1)

	)

32 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
è(((xè+ (mask)è& ~(mask))

	)

34 
	#__KERNEL_DIV_ROUND_UP
(
n
, 
d
è((Òè+ (dè- 1è/ (d))

	)

	@/usr/include/linux/ioctl.h

2 #iâdeà
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/ioùl.h
>

	@/usr/include/linux/libc-compat.h

49 #iâdeà
_LIBC_COMPAT_H


50 
	#_LIBC_COMPAT_H


	)

53 #ià
defšed
(
__GLIBC__
)

56 #ià
defšed
(
_NET_IF_H
è&& defšed(
__USE_MISC
)

61 
	#__UAPI_DEF_IF_IFCONF
 0

	)

62 
	#__UAPI_DEF_IF_IFMAP
 0

	)

63 
	#__UAPI_DEF_IF_IFNAMSIZ
 0

	)

64 
	#__UAPI_DEF_IF_IFREQ
 0

	)

66 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 0

	)

68 #iâdeà
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


69 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

78 
	#__UAPI_DEF_IF_IFCONF
 1

	)

79 
	#__UAPI_DEF_IF_IFMAP
 1

	)

80 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

81 
	#__UAPI_DEF_IF_IFREQ
 1

	)

83 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

85 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

90 #ià
defšed
(
_NETINET_IN_H
)

94 
	#__UAPI_DEF_IN_ADDR
 0

	)

95 
	#__UAPI_DEF_IN_IPPROTO
 0

	)

96 
	#__UAPI_DEF_IN_PKTINFO
 0

	)

97 
	#__UAPI_DEF_IP_MREQ
 0

	)

98 
	#__UAPI_DEF_SOCKADDR_IN
 0

	)

99 
	#__UAPI_DEF_IN_CLASS
 0

	)

101 
	#__UAPI_DEF_IN6_ADDR
 0

	)

106 #ià
defšed
(
__USE_MISC
è|| defšed (
__USE_GNU
)

107 
	#__UAPI_DEF_IN6_ADDR_ALT
 0

	)

109 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

111 
	#__UAPI_DEF_SOCKADDR_IN6
 0

	)

112 
	#__UAPI_DEF_IPV6_MREQ
 0

	)

113 
	#__UAPI_DEF_IPPROTO_V6
 0

	)

114 
	#__UAPI_DEF_IPV6_OPTIONS
 0

	)

115 
	#__UAPI_DEF_IN6_PKTINFO
 0

	)

116 
	#__UAPI_DEF_IP6_MTUINFO
 0

	)

123 
	#__UAPI_DEF_IN_ADDR
 1

	)

124 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

125 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

126 
	#__UAPI_DEF_IP_MREQ
 1

	)

127 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

128 
	#__UAPI_DEF_IN_CLASS
 1

	)

130 
	#__UAPI_DEF_IN6_ADDR
 1

	)

133 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

134 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

135 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

136 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

137 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

138 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

139 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

144 #ià
defšed
(
__NETIPX_IPX_H
)

146 
	#__UAPI_DEF_SOCKADDR_IPX
 0

	)

147 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 0

	)

148 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 0

	)

149 
	#__UAPI_DEF_IPX_CONFIG_DATA
 0

	)

150 
	#__UAPI_DEF_IPX_ROUTE_DEF
 0

	)

154 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

155 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

156 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

157 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

158 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

163 #ià
defšed
(
_SYS_XATTR_H
)

164 
	#__UAPI_DEF_XATTR
 0

	)

166 
	#__UAPI_DEF_XATTR
 1

	)

176 #iâdeà
__UAPI_DEF_IF_IFCONF


177 
	#__UAPI_DEF_IF_IFCONF
 1

	)

179 #iâdeà
__UAPI_DEF_IF_IFMAP


180 
	#__UAPI_DEF_IF_IFMAP
 1

	)

182 #iâdeà
__UAPI_DEF_IF_IFNAMSIZ


183 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

185 #iâdeà
__UAPI_DEF_IF_IFREQ


186 
	#__UAPI_DEF_IF_IFREQ
 1

	)

189 #iâdeà
__UAPI_DEF_IF_NET_DEVICE_FLAGS


190 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

193 #iâdeà
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


194 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

198 #iâdeà
__UAPI_DEF_IN_ADDR


199 
	#__UAPI_DEF_IN_ADDR
 1

	)

201 #iâdeà
__UAPI_DEF_IN_IPPROTO


202 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

204 #iâdeà
__UAPI_DEF_IN_PKTINFO


205 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

207 #iâdeà
__UAPI_DEF_IP_MREQ


208 
	#__UAPI_DEF_IP_MREQ
 1

	)

210 #iâdeà
__UAPI_DEF_SOCKADDR_IN


211 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

213 #iâdeà
__UAPI_DEF_IN_CLASS


214 
	#__UAPI_DEF_IN_CLASS
 1

	)

218 #iâdeà
__UAPI_DEF_IN6_ADDR


219 
	#__UAPI_DEF_IN6_ADDR
 1

	)

221 #iâdeà
__UAPI_DEF_IN6_ADDR_ALT


222 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

224 #iâdeà
__UAPI_DEF_SOCKADDR_IN6


225 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

227 #iâdeà
__UAPI_DEF_IPV6_MREQ


228 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

230 #iâdeà
__UAPI_DEF_IPPROTO_V6


231 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

233 #iâdeà
__UAPI_DEF_IPV6_OPTIONS


234 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

236 #iâdeà
__UAPI_DEF_IN6_PKTINFO


237 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

239 #iâdeà
__UAPI_DEF_IP6_MTUINFO


240 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

244 #iâdeà
__UAPI_DEF_SOCKADDR_IPX


245 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

247 #iâdeà
__UAPI_DEF_IPX_ROUTE_DEFINITION


248 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

250 #iâdeà
__UAPI_DEF_IPX_INTERFACE_DEFINITION


251 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

253 #iâdeà
__UAPI_DEF_IPX_CONFIG_DATA


254 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

256 #iâdeà
__UAPI_DEF_IPX_ROUTE_DEF


257 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

261 #iâdeà
__UAPI_DEF_XATTR


262 
	#__UAPI_DEF_XATTR
 1

	)

	@/usr/include/linux/limits.h

2 #iâdeà
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/posix_types.h

2 #iâdeà
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<lšux/¡ddef.h
>

22 #undeà
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_b™s
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__k”Ãl_fd_£t
;

30 (*
	t__k”Ãl_sighªdËr_t
)();

33 
	t__k”Ãl_key_t
;

34 
	t__k”Ãl_mqd_t
;

36 
	~<asm/posix_ty³s.h
>

	@/usr/include/linux/sysinfo.h

2 #iâdeà
_LINUX_SYSINFO_H


3 
	#_LINUX_SYSINFO_H


	)

5 
	~<lšux/ty³s.h
>

7 
	#SI_LOAD_SHIFT
 16

	)

8 
	ssysšfo
 {

9 
__k”Ãl_lÚg_t
 
	mu±ime
;

10 
__k”Ãl_ulÚg_t
 
	mlßds
[3];

11 
__k”Ãl_ulÚg_t
 
	mtÙ®¿m
;

12 
__k”Ãl_ulÚg_t
 
	mä“¿m
;

13 
__k”Ãl_ulÚg_t
 
	msh¬ed¿m
;

14 
__k”Ãl_ulÚg_t
 
	mbufã¼am
;

15 
__k”Ãl_ulÚg_t
 
	mtÙ®sw­
;

16 
__k”Ãl_ulÚg_t
 
	mä“sw­
;

17 
__u16
 
	m´ocs
;

18 
__u16
 
	m·d
;

19 
__k”Ãl_ulÚg_t
 
	mtÙ®high
;

20 
__k”Ãl_ulÚg_t
 
	mä“high
;

21 
__u32
 
	mmem_un™
;

22 
	m_f
[20-2*(
__k”Ãl_ulÚg_t
)-(
__u32
)];

	@/usr/include/linux/time_types.h

2 #iâdeà
_LINUX_TIME_TYPES_H


3 
	#_LINUX_TIME_TYPES_H


	)

5 
	~<lšux/ty³s.h
>

7 
	s__k”Ãl_time¥ec
 {

8 
__k”Ãl_time64_t
 
	mtv_£c
;

9 
	mtv_n£c
;

12 
	s__k”Ãl_™im”¥ec
 {

13 
__k”Ãl_time¥ec
 
	m™_š‹rv®
;

14 
__k”Ãl_time¥ec
 
	m™_v®ue
;

24 #iâdeà
__k”Ãl_Şd_timev®


25 
	s__k”Ãl_Şd_timev®
 {

26 
__k”Ãl_lÚg_t
 
	mtv_£c
;

27 
__k”Ãl_lÚg_t
 
	mtv_u£c
;

31 
	s__k”Ãl_Şd_time¥ec
 {

32 
__k”Ãl_Şd_time_t
 
	mtv_£c
;

33 
	mtv_n£c
;

36 
	s__k”Ãl_Şd_™im”v®
 {

37 
__k”Ãl_Şd_timev®
 
	m™_š‹rv®
;

38 
__k”Ãl_Şd_timev®
 
	m™_v®ue
;

41 
	s__k”Ãl_sock_timev®
 {

42 
__s64
 
	mtv_£c
;

43 
__s64
 
	mtv_u£c
;

	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<b™s/libc-h—d”-¡¬t.h
>

28 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

36 #ià
defšed
 
__ılu¥lus
 && (
__GNUC_PREREQ
 (4, 4) \

37 || 
	$__glibc_şªg_´”eq
 (3, 5))

38 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

43 *
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

44 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

47 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

48 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

53 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN
 || 
	`__GLIBC_USE
 (
ISOC2X
)

54 *
	$memcıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
	`__©Œ_acûss
 ((
__wr™e_Úly__
, 1, 4));

61 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

64 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

65 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

80 
	$__memcm³q
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

81 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

84 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


87 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

88 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

89 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

90 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

92 #ifdeà
__OPTIMIZE__


93 
__ex‹º_®ways_šlše
 *

94 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


96  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

99 
__ex‹º_®ways_šlše
 const *

100 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


102  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

105 
	}
}

107 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

108 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

111 #ifdeà
__USE_GNU


114 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


115 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

116 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

117 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

118 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

120 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

121 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

125 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


126 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

127 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1))

128 
	`__©Œ_acûss
 ((
__»ad_Úly__
, 1, 3));

129 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

130 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1))

131 
	`__©Œ_acûss
 ((
__»ad_Úly__
, 1, 3));

133 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

134 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1))

135 
	`__©Œ_acûss
 ((
__»ad_Úly__
, 1, 3));

141 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

142 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

144 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

145 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

146 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

149 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

150 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

152 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

153 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

156 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

157 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

159 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

160 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

163 
	$¡rcŞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

164 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

166 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

167 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

168 
__THROW
 
	`__nÚnuÎ
 ((2)è
	`__©Œ_acûss
 ((
__wr™e_Úly__
, 1, 3));

170 #ifdeà
__USE_XOPEN2K8


172 
	~<b™s/ty³s/loÿË_t.h
>

175 
	$¡rcŞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
loÿË_t
 
__l
)

176 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

179 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

180 
loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4))

181 
	`__©Œ_acûss
 ((
__wr™e_Úly__
, 1, 3));

184 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8
 \

185 || 
	`__GLIBC_USE
 (
LIB_EXT2
è|| 
	$__GLIBC_USE
 (
ISOC2X
))

187 *
	$¡rdup
 (cÚ¡ *
__s
)

188 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

194 #ià
defšed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
è|| __GLIBC_USE (
ISOC2X
)

195 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

196 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

199 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


201 
	#¡rdu·
(
s
) \

202 (
__ex‹nsiÚ__
 \

204 cÚ¡ *
__Şd
 = (
s
); \

205 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

206 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

207 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

208 
	}
}))

	)

211 
	#¡ºdu·
(
s
, 
n
) \

212 (
__ex‹nsiÚ__
 \

214 cÚ¡ *
__Şd
 = (
s
); \

215 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

216 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

217 
__Ãw
[
__Ën
] = '\0'; \

218 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

219 }))

	)

223 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


226 *
¡rchr
 (*
__s
, 
__c
)

227 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

228 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

229 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

231 #ifdeà
__OPTIMIZE__


232 
__ex‹º_®ways_šlše
 *

233 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


235  
__butš_¡rchr
 (
__s
, 
__c
);

238 
__ex‹º_®ways_šlše
 const *

239 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


241  
__butš_¡rchr
 (
__s
, 
__c
);

246 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

247 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

250 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


253 *
	`¡¼chr
 (*
__s
, 
__c
)

254 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

255 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

256 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

258 #ifdeà
__OPTIMIZE__


259 
__ex‹º_®ways_šlše
 *

260 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


262  
	`__butš_¡¼chr
 (
__s
, 
__c
);

265 
__ex‹º_®ways_šlše
 const *

266 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


268  
	`__butš_¡¼chr
 (
__s
, 
__c
);

271 
	}
}

273 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

274 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

277 #ifdeà
__USE_GNU


280 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


281 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

282 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

283 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

284 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

286 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

287 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

293 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

294 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

297 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

298 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

300 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


303 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

304 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

305 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

306 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

308 #ifdeà
__OPTIMIZE__


309 
__ex‹º_®ways_šlše
 *

310 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


312  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

315 
__ex‹º_®ways_šlše
 const *

316 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


318  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

321 
	}
}

323 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

324 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

327 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


330 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

331 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

332 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

333 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

335 #ifdeà
__OPTIMIZE__


336 
__ex‹º_®ways_šlše
 *

337 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


339  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

342 
__ex‹º_®ways_šlše
 const *

343 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


345  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

348 
	}
}

350 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

351 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

356 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

357 
__THROW
 
	`__nÚnuÎ
 ((2));

361 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

362 cÚ¡ *
__»¡riù
 
__d–im
,

363 **
__»¡riù
 
__§ve_±r
)

364 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

365 #ifdeà
__USE_POSIX


366 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

367 **
__»¡riù
 
__§ve_±r
)

368 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

371 #ifdeà
__USE_GNU


373 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


374 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

375 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

376 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

377 cÚ¡ *
__ÃedË
)

378 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

380 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

381 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

385 #ifdeà
__USE_GNU


389 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

390 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

391 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3))

392 
	`__©Œ_acûss
 ((
__»ad_Úly__
, 1, 2))

393 
	`__©Œ_acûss
 ((
__»ad_Úly__
, 3, 4));

397 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

398 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

399 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

400 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

401 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

402 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

407 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

408 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

410 #ifdef 
__USE_XOPEN2K8


413 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

414 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

419 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

420 #ifdeà
__USE_XOPEN2K


428 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


431 #ifdeà
__REDIRECT_NTH


432 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

433 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

434 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2))

435 
	`__©Œ_acûss
 ((
__wr™e_Úly__
, 2, 3));

437 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

438 
__THROW
 
	`__nÚnuÎ
 ((2)è
	`__©Œ_acûss
 ((
__wr™e_Úly__
, 2, 3));

439 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

444 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

445 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
 
	`__©Œ_acûss
 ((
__wr™e_Úly__
, 2, 3));

448 #ifdeà
__USE_GNU


450 cÚ¡ *
	$¡»¼Üdesc_Å
 (
__”r
è
__THROW
;

452 cÚ¡ *
	$¡»¼ÜÇme_Å
 (
__”r
è
__THROW
;

456 #ifdeà
__USE_XOPEN2K8


458 *
	$¡»¼Ü_l
 (
__”ºum
, 
loÿË_t
 
__l
è
__THROW
;

461 #ifdeà
__USE_MISC


462 
	~<¡ršgs.h
>

466 
	$ex¶ic™_bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1))

467 
	`__fÜtif›d_©Œ_acûss
 (
__wr™e_Úly__
, 1, 2);

471 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

472 cÚ¡ *
__»¡riù
 
__d–im
)

473 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

476 #ifdef 
__USE_XOPEN2K8


478 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

480 #ifdeà
__USE_GNU


482 cÚ¡ *
	$sigabb»v_Å
 (
__sig
è
__THROW
;

485 cÚ¡ *
	$sigdesü_Å
 (
__sig
è
__THROW
;

489 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

490 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

491 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

492 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

496 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

497 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

498 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

499 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

500 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

501 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

504 #ifdef 
__USE_GNU


506 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

507 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

510 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

513 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1))

514 
	`__©Œ_acûss
 ((
__»ad_wr™e__
, 1, 2));

516 #iâdeà
ba£Çme


521 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


522 "C++" *
	$ba£Çme
 (*
__f’ame
)

523 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

524 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__f’ame
)

525 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

527 *
	$ba£Çme
 (cÚ¡ *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

532 #ià
	`__GNUC_PREREQ
 (3,4)

533 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


535 
	~<b™s/¡ršg_fÜtif›d.h
>

539 
__END_DECLS


	@/usr/include/strings.h

18 #iâdef 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	#__Ãed_size_t


	)

23 
	~<¡ddef.h
>

26 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

27 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

30 
	g__BEGIN_DECLS


32 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


34 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

35 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

38 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

39 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

42 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

45 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


48 *
	`šdex
 (*
__s
, 
__c
)

49 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

50 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

51 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

53 #ià
defšed
 
__OPTIMIZE__


54 
__ex‹º_®ways_šlše
 *

55 
	`šdex
 (*
__s
, 
__c
è
__THROW


57  
	`__butš_šdex
 (
__s
, 
__c
);

60 
__ex‹º_®ways_šlše
 const *

61 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


63  
	`__butš_šdex
 (
__s
, 
__c
);

66 
	}
}

68 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

69 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

73 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


76 *
	`ršdex
 (*
__s
, 
__c
)

77 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

78 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

79 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

81 #ià
defšed
 
__OPTIMIZE__


82 
__ex‹º_®ways_šlše
 *

83 
	`ršdex
 (*
__s
, 
__c
è
__THROW


85  
	`__butš_ršdex
 (
__s
, 
__c
);

88 
__ex‹º_®ways_šlše
 const *

89 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


91  
	`__butš_ršdex
 (
__s
, 
__c
);

94 
	}
}

96 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

97 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

101 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8
 || defšed 
__USE_XOPEN2K8XSI


104 
	$ffs
 (
__i
è
__THROW
 
__©Œibu‹_cÚ¡__
;

109 #ifdef 
__USE_MISC


110 
	$ff¦
 (
__l
è
__THROW
 
__©Œibu‹_cÚ¡__
;

111 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

112 
__THROW
 
__©Œibu‹_cÚ¡__
;

116 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

117 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

120 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

121 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

123 #ifdef 
__USE_XOPEN2K8


125 
	~<b™s/ty³s/loÿË_t.h
>

128 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
loÿË_t
 
__loc
)

129 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

133 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

134 
size_t
 
__n
, 
loÿË_t
 
__loc
)

135 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

138 
__END_DECLS


140 #ià
	`__GNUC_PREREQ
 (3,4è&& 
__USE_FORTIFY_LEVEL
 > 0 \

141 && 
defšed
 
__fÜtify_funùiÚ


143 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


144 
	~<b™s/¡ršgs_fÜtif›d.h
>

	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

126 #undeà
__USE_ISOC11


127 #undeà
__USE_ISOC99


128 #undeà
__USE_ISOC95


129 #undeà
__USE_ISOCXX11


130 #undeà
__USE_POSIX


131 #undeà
__USE_POSIX2


132 #undeà
__USE_POSIX199309


133 #undeà
__USE_POSIX199506


134 #undeà
__USE_XOPEN


135 #undeà
__USE_XOPEN_EXTENDED


136 #undeà
__USE_UNIX98


137 #undeà
__USE_XOPEN2K


138 #undeà
__USE_XOPEN2KXSI


139 #undeà
__USE_XOPEN2K8


140 #undeà
__USE_XOPEN2K8XSI


141 #undeà
__USE_LARGEFILE


142 #undeà
__USE_LARGEFILE64


143 #undeà
__USE_FILE_OFFSET64


144 #undeà
__USE_MISC


145 #undeà
__USE_ATFILE


146 #undeà
__USE_DYNAMIC_STACK_SIZE


147 #undeà
__USE_GNU


148 #undeà
__USE_FORTIFY_LEVEL


149 #undeà
__KERNEL_STRICT_NAMES


150 #undeà
__GLIBC_USE_ISOC2X


151 #undeà
__GLIBC_USE_DEPRECATED_GETS


152 #undeà
__GLIBC_USE_DEPRECATED_SCANF


156 #iâdeà
_LOOSE_KERNEL_NAMES


157 
	#__KERNEL_STRICT_NAMES


	)

167 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


168 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

169 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

171 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

178 #ià
defšed
 
__şªg_majÜ__
 && defšed 
__şªg_mšÜ__


179 
	#__glibc_şªg_´”eq
(
maj
, 
mš
) \

180 ((
__şªg_majÜ__
 << 16è+ 
__şªg_mšÜ__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

182 
	#__glibc_şªg_´”eq
(
maj
, 
mš
è0

	)

186 
	#__GLIBC_USE
(
F
è
__GLIBC_USE_
 ## 
	)
F

192 #ià(
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE
) \

193 && !
defšed
 
	g_DEFAULT_SOURCE


195 #undeà
_DEFAULT_SOURCE


196 
	#_DEFAULT_SOURCE
 1

	)

200 #ifdeà
_GNU_SOURCE


201 #undeà
_ISOC95_SOURCE


202 
	#_ISOC95_SOURCE
 1

	)

203 #undeà
_ISOC99_SOURCE


204 
	#_ISOC99_SOURCE
 1

	)

205 #undeà
_ISOC11_SOURCE


206 
	#_ISOC11_SOURCE
 1

	)

207 #undeà
_ISOC2X_SOURCE


208 
	#_ISOC2X_SOURCE
 1

	)

209 #undeà
_POSIX_SOURCE


210 
	#_POSIX_SOURCE
 1

	)

211 #undeà
_POSIX_C_SOURCE


212 
	#_POSIX_C_SOURCE
 200809L

	)

213 #undeà
_XOPEN_SOURCE


214 
	#_XOPEN_SOURCE
 700

	)

215 #undeà
_XOPEN_SOURCE_EXTENDED


216 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

217 #undeà
_LARGEFILE64_SOURCE


218 
	#_LARGEFILE64_SOURCE
 1

	)

219 #undeà
_DEFAULT_SOURCE


220 
	#_DEFAULT_SOURCE
 1

	)

221 #undeà
_ATFILE_SOURCE


222 
	#_ATFILE_SOURCE
 1

	)

223 #undeà
_DYNAMIC_STACK_SIZE_SOURCE


224 
	#_DYNAMIC_STACK_SIZE_SOURCE
 1

	)

229 #ià(
defšed
 
_DEFAULT_SOURCE
 \

230 || (!
defšed
 
	g__STRICT_ANSI__
 \

231 && !
defšed
 
	g_ISOC99_SOURCE
 && !defšed 
	g_ISOC11_SOURCE
 \

232 && !
defšed
 
	g_ISOC2X_SOURCE
 \

233 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

234 && !
defšed
 
	g_XOPEN_SOURCE
))

235 #undeà
_DEFAULT_SOURCE


236 
	#_DEFAULT_SOURCE
 1

	)

240 #ià(
defšed
 
_ISOC2X_SOURCE
 \

241 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ > 201710L))

242 
	#__GLIBC_USE_ISOC2X
 1

	)

244 
	#__GLIBC_USE_ISOC2X
 0

	)

248 #ià(
defšed
 
_ISOC11_SOURCE
 || defšed 
_ISOC2X_SOURCE
 \

249 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

250 
	#__USE_ISOC11
 1

	)

254 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

255 || 
defšed
 
_ISOC2X_SOURCE
 \

256 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

257 
	#__USE_ISOC99
 1

	)

261 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

262 || 
defšed
 
_ISOC2X_SOURCE
 \

263 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

264 
	#__USE_ISOC95
 1

	)

267 #ifdeà
__ılu¥lus


269 #ià
__ılu¥lus
 >= 201703L

270 
	#__USE_ISOC11
 1

	)

274 #ià
__ılu¥lus
 >ğ201103L || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__


275 
	#__USE_ISOCXX11
 1

	)

276 
	#__USE_ISOC99
 1

	)

283 #ifdeà
_DEFAULT_SOURCE


284 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


285 
	#__USE_POSIX_IMPLICITLY
 1

	)

287 #undeà
_POSIX_SOURCE


288 
	#_POSIX_SOURCE
 1

	)

289 #undeà
_POSIX_C_SOURCE


290 
	#_POSIX_C_SOURCE
 200809L

	)

293 #ià((!
defšed
 
__STRICT_ANSI__
 \

294 || (
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

295 && !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

296 
	#_POSIX_SOURCE
 1

	)

297 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

298 
	#_POSIX_C_SOURCE
 2

	)

299 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

300 
	#_POSIX_C_SOURCE
 199506L

	)

301 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

302 
	#_POSIX_C_SOURCE
 200112L

	)

304 
	#_POSIX_C_SOURCE
 200809L

	)

306 
	#__USE_POSIX_IMPLICITLY
 1

	)

315 #ià((!
defšed
 
_POSIX_C_SOURCE
 || (_POSIX_C_SOURCE - 0) < 199506L) \

316 && (
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE
))

317 
	#_POSIX_SOURCE
 1

	)

318 #undeà
_POSIX_C_SOURCE


319 
	#_POSIX_C_SOURCE
 199506L

	)

322 #ià(
defšed
 
_POSIX_SOURCE
 \

323 || (
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

324 || 
defšed
 
_XOPEN_SOURCE
)

325 
	#__USE_POSIX
 1

	)

328 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


329 
	#__USE_POSIX2
 1

	)

332 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

333 
	#__USE_POSIX199309
 1

	)

336 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

337 
	#__USE_POSIX199506
 1

	)

340 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

341 
	#__USE_XOPEN2K
 1

	)

342 #undeà
__USE_ISOC95


343 
	#__USE_ISOC95
 1

	)

344 #undeà
__USE_ISOC99


345 
	#__USE_ISOC99
 1

	)

348 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

349 
	#__USE_XOPEN2K8
 1

	)

350 #undeà
_ATFILE_SOURCE


351 
	#_ATFILE_SOURCE
 1

	)

354 #ifdef 
_XOPEN_SOURCE


355 
	#__USE_XOPEN
 1

	)

356 #ià(
_XOPEN_SOURCE
 - 0) >= 500

357 
	#__USE_XOPEN_EXTENDED
 1

	)

358 
	#__USE_UNIX98
 1

	)

359 #undeà
_LARGEFILE_SOURCE


360 
	#_LARGEFILE_SOURCE
 1

	)

361 #ià(
_XOPEN_SOURCE
 - 0) >= 600

362 #ià(
_XOPEN_SOURCE
 - 0) >= 700

363 
	#__USE_XOPEN2K8
 1

	)

364 
	#__USE_XOPEN2K8XSI
 1

	)

366 
	#__USE_XOPEN2K
 1

	)

367 
	#__USE_XOPEN2KXSI
 1

	)

368 #undeà
__USE_ISOC95


369 
	#__USE_ISOC95
 1

	)

370 #undeà
__USE_ISOC99


371 
	#__USE_ISOC99
 1

	)

374 #ifdeà
_XOPEN_SOURCE_EXTENDED


375 
	#__USE_XOPEN_EXTENDED
 1

	)

380 #ifdeà
_LARGEFILE_SOURCE


381 
	#__USE_LARGEFILE
 1

	)

384 #ifdeà
_LARGEFILE64_SOURCE


385 
	#__USE_LARGEFILE64
 1

	)

388 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

389 
	#__USE_FILE_OFFSET64
 1

	)

392 
	~<ã©u»s-time64.h
>

394 #ià
defšed
 
_DEFAULT_SOURCE


395 
	#__USE_MISC
 1

	)

398 #ifdef 
_ATFILE_SOURCE


399 
	#__USE_ATFILE
 1

	)

402 #ifdef 
_DYNAMIC_STACK_SIZE_SOURCE


403 
	#__USE_DYNAMIC_STACK_SIZE
 1

	)

406 #ifdef 
_GNU_SOURCE


407 
	#__USE_GNU
 1

	)

410 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0

411 #ià!
defšed
 
__OPTIMIZE__
 || __OPTIMIZE__ <= 0

412 #–ià!
__GNUC_PREREQ
 (4, 1)

413 #–ià
_FORTIFY_SOURCE
 > 2 && (
__glibc_şªg_´”eq
 (9, 0) \

414 || 
	$__GNUC_PREREQ
 (12, 0))

416 #ià
_FORTIFY_SOURCE
 > 3

418 
	#__USE_FORTIFY_LEVEL
 3

	)

419 #–ià
_FORTIFY_SOURCE
 > 1

420 #ià
_FORTIFY_SOURCE
 > 2

422 
	#__USE_FORTIFY_LEVEL
 2

	)

424 
	#__USE_FORTIFY_LEVEL
 1

	)

427 #iâdeà
__USE_FORTIFY_LEVEL


428 
	#__USE_FORTIFY_LEVEL
 0

	)

435 #ià
defšed
 
__ılu¥lus
 ? __ılu¥lu >ğ201402L : defšed 
__USE_ISOC11


436 
	#__GLIBC_USE_DEPRECATED_GETS
 0

	)

438 
	#__GLIBC_USE_DEPRECATED_GETS
 1

	)

453 #ià(
defšed
 
__USE_GNU
 \

454 && (
defšed
 
__ılu¥lus
 \

455 ? (
__ılu¥lus
 < 201103L && !
defšed
 
__GXX_EXPERIMENTAL_CXX0X__
) \

456 : (!
defšed
 
__STDC_VERSION__
 || __STDC_VERSION__ < 199901L)))

457 
	#__GLIBC_USE_DEPRECATED_SCANF
 1

	)

459 
	#__GLIBC_USE_DEPRECATED_SCANF
 0

	)

464 
	~<¡dc-´edef.h
>

472 #undeà
__GNU_LIBRARY__


473 
	#__GNU_LIBRARY__
 6

	)

477 
	#__GLIBC__
 2

	)

478 
	#__GLIBC_MINOR__
 35

	)

480 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

481 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

484 #iâdeà
__ASSEMBLER__


485 #iâdeà
_SYS_CDEFS_H


486 
	~<sys/cdefs.h
>

491 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


492 
	#__USE_LARGEFILE
 1

	)

493 
	#__USE_LARGEFILE64
 1

	)

499 #ià
	`__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

500 && !
defšed
 
__OPTIMIZE_SIZE__
 && !defšed 
__NO_INLINE__
 \

501 && 
defšed
 
__ex‹º_šlše


502 
	#__USE_EXTERN_INLINES
 1

	)

510 
	~<gnu/¡ubs.h
>

	@/usr/include/features-time64.h

20 
	~<b™s/wÜdsize.h
>

21 
	~<b™s/timesize.h
>

23 #ià
defšed
 
_TIME_BITS


24 #ià
_TIME_BITS
 == 64

25 #ià! 
defšed
 (
_FILE_OFFSET_BITS
) || _FILE_OFFSET_BITS != 64

27 #–ià
__TIMESIZE
 == 32

28 
	#__USE_TIME_BITS64
 1

	)

30 #–ià
_TIME_BITS
 == 32

31 #ià
__TIMESIZE
 > 32

35 #”rÜ 
Inv®id
 
_TIME_BITS
 
v®ue
 (
ÿn
 
Úly
 
be
 32 
Ü
 64-
b™
)

	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

39 
	#__STDC_IEC_60559_BFP__
 201404L

	)

42 
	#__STDC_IEC_559__
 1

	)

43 
	#__STDC_IEC_60559_BFP__
 201404L

	)

46 #ifdeà
__GCC_IEC_559_COMPLEX


47 #ià
__GCC_IEC_559_COMPLEX
 > 0

48 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_60559_COMPLEX__
 201404L

	)

52 
	#__STDC_IEC_559_COMPLEX__
 1

	)

53 
	#__STDC_IEC_60559_COMPLEX__
 201404L

	)

62 
	#__STDC_ISO_10646__
 201706L

	)

	@
1
.
1
/usr/include
177
2761
accessors.c
accessors.h
acl.c
acl.h
async-thread.c
async-thread.h
backref.c
backref.h
bio.c
bio.h
block-group.c
block-group.h
block-rsv.c
block-rsv.h
btrfs.mod.c
btrfs_inode.h
calclock/calclock.c
calclock/calclock.h
check-integrity.c
check-integrity.h
compression.c
compression.h
ctree.c
ctree.h
defrag.c
defrag.h
delalloc-space.c
delalloc-space.h
delayed-inode.c
delayed-inode.h
delayed-ref.c
delayed-ref.h
dev-replace.c
dev-replace.h
dir-item.c
dir-item.h
discard.c
discard.h
disk-io.c
disk-io.h
export.c
export.h
extent-io-tree.c
extent-io-tree.h
extent-tree.c
extent-tree.h
extent_io.c
extent_io.h
extent_map.c
extent_map.h
file-item.c
file-item.h
file.c
file.h
free-space-cache.c
free-space-cache.h
free-space-tree.c
free-space-tree.h
fs.c
fs.h
inode-item.c
inode-item.h
inode.c
ioctl.c
ioctl.h
locking.c
locking.h
lru_cache.c
lru_cache.h
lzo.c
messages.c
messages.h
misc.h
mm/filemap.c
mm/filemap.h
mm/internal.h
ordered-data.c
ordered-data.h
orphan.c
orphan.h
print-tree.c
print-tree.h
props.c
props.h
qgroup.c
qgroup.h
raid56.c
raid56.h
rcu-string.h
ref-verify.c
ref-verify.h
reflink.c
reflink.h
relocation.c
relocation.h
root-tree.c
root-tree.h
scrub.c
scrub.h
send.c
send.h
space-info.c
space-info.h
subpage.c
subpage.h
super.c
super.h
sysfs.c
sysfs.h
tests/btrfs-tests.c
tests/btrfs-tests.h
tests/extent-buffer-tests.c
tests/extent-io-tests.c
tests/extent-map-tests.c
tests/free-space-tests.c
tests/free-space-tree-tests.c
tests/inode-tests.c
tests/qgroup-tests.c
transaction.c
transaction.h
tree-checker.c
tree-checker.h
tree-log.c
tree-log.h
tree-mod-log.c
tree-mod-log.h
ulist.c
ulist.h
uuid-tree.c
uuid-tree.h
verity.c
verity.h
volumes.c
volumes.h
xattr.c
xattr.h
zlib.c
zoned.c
zoned.h
zstd.c
/usr/include/linux/btrfs.h
/usr/include/linux/btrfs_tree.h
/usr/include/linux/capability.h
/usr/include/linux/falloc.h
/usr/include/linux/fiemap.h
/usr/include/linux/fs.h
/usr/include/linux/fscrypt.h
/usr/include/linux/fsverity.h
/usr/include/linux/kernel.h
/usr/include/linux/magic.h
/usr/include/linux/mman.h
/usr/include/linux/module.h
/usr/include/linux/mount.h
/usr/include/linux/posix_acl.h
/usr/include/linux/posix_acl_xattr.h
/usr/include/linux/sched.h
/usr/include/linux/stddef.h
/usr/include/linux/string.h
/usr/include/linux/time.h
/usr/include/linux/types.h
/usr/include/linux/uio.h
/usr/include/linux/uuid.h
/usr/include/linux/wait.h
/usr/include/linux/xattr.h
/usr/include/asm-generic/hugetlb_encode.h
/usr/include/linux/const.h
/usr/include/linux/ioctl.h
/usr/include/linux/libc-compat.h
/usr/include/linux/limits.h
/usr/include/linux/posix_types.h
/usr/include/linux/sysinfo.h
/usr/include/linux/time_types.h
/usr/include/string.h
/usr/include/strings.h
/usr/include/features.h
/usr/include/features-time64.h
/usr/include/stdc-predef.h
