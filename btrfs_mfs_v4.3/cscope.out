cscope 15 $HOME/workspace_la/btrfs_mfs_v4.3               0003594279
	@accessors.c

6 
	~<asm/u«lig√d.h
>

7 
	~"mesßges.h
"

8 
	~"˘ªe.h
"

9 
	~"ac˚ss‹s.h
"

11 
boﬁ
 
	$check_£tgë_bounds
(c⁄° 
exã¡_buf„r
 *
eb
,

12 c⁄° *
±r
, 
off
, 
size
)

14 c⁄° 
membî_off£t
 = ()
±r
 + 
off
;

16 i‡(
	`u∆ikñy
(
membî_off£t
 + 
size
 > 
eb
->
Àn
)) {

17 
	`båfs_w¨n
(
eb
->
fs_öfo
,

19 (
membî_off£t
 > 
eb
->
Àn
 ? "start" : "end"),

20 ()
±r
, 
eb
->
°¨t
, 
membî_off£t
, 
size
);

21  
Ál£
;

24  
åue
;

25 
	}
}

27 
	$båfs_öô_m≠_tokí
(
båfs_m≠_tokí
 *
tokí
, 
exã¡_buf„r
 *
eb
)

29 
tokí
->
eb
 =Éb;

30 
tokí
->
kaddr
 = 
	`∑ge_addªss
(
eb
->
∑ges
[0]);

31 
tokí
->
off£t
 = 0;

32 
	}
}

58 
	#DEFINE_BTRFS_SETGET_BITS
(
bôs
) \

59 
u
##
bôs
 
båfs_gë_tokí_
##
	`bôs
(
båfs_m≠_tokí
 *
tokí
, \

60 c⁄° *
±r
, 
off
) \

62 c⁄° 
membî_off£t
 = ()
±r
 + 
off
; \

63 c⁄° 
idx
 = 
	`gë_eb_∑ge_ödex
(
membî_off£t
); \

64 c⁄° 
où
 = 
	`gë_eb_off£t_ö_∑ge
(
tokí
->
eb
, \

65 
membî_off£t
); \

66 c⁄° 
size
 = (
u
##
bôs
); \

67 
u8
 
Àbyãs
[(
u
##
bôs
)]; \

68 c⁄° 
∑π
 = 
PAGE_SIZE
 - 
où
; \

70 
	`ASSERT
(
tokí
); \

71 
	`ASSERT
(
tokí
->
kaddr
); \

72 
	`ASSERT
(
	`check_£tgë_bounds
(
tokí
->
eb
, 
±r
, 
off
, 
size
)); \

73 i‡(
tokí
->
off£t
 <
membî_off£t
 && \

74 
membî_off£t
 + 
size
 <
tokí
->
off£t
 + 
PAGE_SIZE
) { \

75  
gë_u«lig√d_À
##
	`bôs
(
tokí
->
kaddr
 + 
où
); \

77 
tokí
->
kaddr
 = 
	`∑ge_addªss
—okí->
eb
->
∑ges
[
idx
]); \

78 
tokí
->
off£t
 = 
idx
 << 
PAGE_SHIFT
; \

79 i‡(
INLINE_EXTENT_BUFFER_PAGES
 =1 || 
où
 + 
size
 <
PAGE_SIZE
 ) \

80  
gë_u«lig√d_À
##
	`bôs
(
tokí
->
kaddr
 + 
où
); \

82 
	`mem˝y
(
Àbyãs
, 
tokí
->
kaddr
 + 
où
, 
∑π
); \

83 
tokí
->
kaddr
 = 
	`∑ge_addªss
—okí->
eb
->
∑ges
[
idx
 + 1]); \

84 
tokí
->
off£t
 = (
idx
 + 1Ë<< 
PAGE_SHIFT
; \

85 
	`mem˝y
(
Àbyãs
 + 
∑π
, 
tokí
->
kaddr
, 
size
 -Öart); \

86  
gë_u«lig√d_À
##
	`bôs
(
Àbyãs
); \

88 
u
##
bôs
 
båfs_gë_
##
	`bôs
(c⁄° 
exã¡_buf„r
 *
eb
, \

89 c⁄° *
±r
, 
off
) \

91 c⁄° 
membî_off£t
 = ()
±r
 + 
off
; \

92 c⁄° 
où
 = 
	`gë_eb_off£t_ö_∑ge
(
eb
, 
membî_off£t
); \

93 c⁄° 
idx
 = 
	`gë_eb_∑ge_ödex
(
membî_off£t
); \

94 *
kaddr
 = 
	`∑ge_addªss
(
eb
->
∑ges
[
idx
]); \

95 c⁄° 
size
 = (
u
##
bôs
); \

96 c⁄° 
∑π
 = 
PAGE_SIZE
 - 
où
; \

97 
u8
 
Àbyãs
[(
u
##
bôs
)]; \

99 
	`ASSERT
(
	`check_£tgë_bounds
(
eb
, 
±r
, 
off
, 
size
)); \

100 i‡(
INLINE_EXTENT_BUFFER_PAGES
 =1 || 
où
 + 
size
 <
PAGE_SIZE
) \

101  
gë_u«lig√d_À
##
	`bôs
(
kaddr
 + 
où
); \

103 
	`mem˝y
(
Àbyãs
, 
kaddr
 + 
où
, 
∑π
); \

104 
kaddr
 = 
	`∑ge_addªss
(
eb
->
∑ges
[
idx
 + 1]); \

105 
	`mem˝y
(
Àbyãs
 + 
∑π
, 
kaddr
, 
size
 -Öart); \

106  
gë_u«lig√d_À
##
	`bôs
(
Àbyãs
); \

108 
båfs_£t_tokí_
##
	`bôs
(
båfs_m≠_tokí
 *
tokí
, \

109 c⁄° *
±r
, 
off
, \

110 
u
##
bôs
 
vÆ
) \

112 c⁄° 
membî_off£t
 = ()
±r
 + 
off
; \

113 c⁄° 
idx
 = 
	`gë_eb_∑ge_ödex
(
membî_off£t
); \

114 c⁄° 
où
 = 
	`gë_eb_off£t_ö_∑ge
(
tokí
->
eb
, \

115 
membî_off£t
); \

116 c⁄° 
size
 = (
u
##
bôs
); \

117 
u8
 
Àbyãs
[(
u
##
bôs
)]; \

118 c⁄° 
∑π
 = 
PAGE_SIZE
 - 
où
; \

120 
	`ASSERT
(
tokí
); \

121 
	`ASSERT
(
tokí
->
kaddr
); \

122 
	`ASSERT
(
	`check_£tgë_bounds
(
tokí
->
eb
, 
±r
, 
off
, 
size
)); \

123 i‡(
tokí
->
off£t
 <
membî_off£t
 && \

124 
membî_off£t
 + 
size
 <
tokí
->
off£t
 + 
PAGE_SIZE
) { \

125 
put_u«lig√d_À
##
	`bôs
(
vÆ
, 
tokí
->
kaddr
 + 
où
); \

128 
tokí
->
kaddr
 = 
	`∑ge_addªss
—okí->
eb
->
∑ges
[
idx
]); \

129 
tokí
->
off£t
 = 
idx
 << 
PAGE_SHIFT
; \

130 i‡(
INLINE_EXTENT_BUFFER_PAGES
 =1 || 
où
 + 
size
 <
PAGE_SIZE
) { \

131 
put_u«lig√d_À
##
	`bôs
(
vÆ
, 
tokí
->
kaddr
 + 
où
); \

134 
put_u«lig√d_À
##
	`bôs
(
vÆ
, 
Àbyãs
); \

135 
	`mem˝y
(
tokí
->
kaddr
 + 
où
, 
Àbyãs
, 
∑π
); \

136 
tokí
->
kaddr
 = 
	`∑ge_addªss
—okí->
eb
->
∑ges
[
idx
 + 1]); \

137 
tokí
->
off£t
 = (
idx
 + 1Ë<< 
PAGE_SHIFT
; \

138 
	`mem˝y
(
tokí
->
kaddr
, 
Àbyãs
 + 
∑π
, 
size
 -Öart); \

140 
båfs_£t_
##
	`bôs
(c⁄° 
exã¡_buf„r
 *
eb
, *
±r
, \

141 
off
, 
u
##
bôs
 
vÆ
) \

143 c⁄° 
membî_off£t
 = ()
±r
 + 
off
; \

144 c⁄° 
où
 = 
	`gë_eb_off£t_ö_∑ge
(
eb
, 
membî_off£t
); \

145 c⁄° 
idx
 = 
	`gë_eb_∑ge_ödex
(
membî_off£t
); \

146 *
kaddr
 = 
	`∑ge_addªss
(
eb
->
∑ges
[
idx
]); \

147 c⁄° 
size
 = (
u
##
bôs
); \

148 c⁄° 
∑π
 = 
PAGE_SIZE
 - 
où
; \

149 
u8
 
Àbyãs
[(
u
##
bôs
)]; \

151 
	`ASSERT
(
	`check_£tgë_bounds
(
eb
, 
±r
, 
off
, 
size
)); \

152 i‡(
INLINE_EXTENT_BUFFER_PAGES
 =1 || 
où
 + 
size
 <
PAGE_SIZE
) { \

153 
put_u«lig√d_À
##
	`bôs
(
vÆ
, 
kaddr
 + 
où
); \

157 
put_u«lig√d_À
##
	`bôs
(
vÆ
, 
Àbyãs
); \

158 
	`mem˝y
(
kaddr
 + 
où
, 
Àbyãs
, 
∑π
); \

159 
kaddr
 = 
	`∑ge_addªss
(
eb
->
∑ges
[
idx
 + 1]); \

160 
	`mem˝y
(
kaddr
, 
Àbyãs
 + 
∑π
, 
size
 -Öart); \

161 }

	)

163 
	$DEFINE_BTRFS_SETGET_BITS
(8)

164 
	$DEFINE_BTRFS_SETGET_BITS
(16)

165 
	$DEFINE_BTRFS_SETGET_BITS
(32)

166 
	$DEFINE_BTRFS_SETGET_BITS
(64)

168 
	$båfs_node_key
(c⁄° 
exã¡_buf„r
 *
eb
,

169 
båfs_disk_key
 *
disk_key
, 
ƒ
)

171 
±r
 = 
	`båfs_node_key_±r_off£t
(
eb
, 
ƒ
);

172 
	`ªad_eb_membî
(
eb
, (
båfs_key_±r
 *)
±r
,

173 
båfs_key_±r
, 
key
, 
disk_key
);

174 
	}
}

	@accessors.h

3 #i‚de‡
BTRFS_ACCESSORS_H


4 
	#BTRFS_ACCESSORS_H


	)

6 
	~<löux/°ddef.h
>

8 
	sbåfs_m≠_tokí
 {

9 
exã¡_buf„r
 *
	meb
;

10 *
	mkaddr
;

11 
	moff£t
;

14 
båfs_öô_m≠_tokí
(
båfs_m≠_tokí
 *
tokí
, 
exã¡_buf„r
 *
eb
);

21 
	#À8_to_˝u
(
v
Ë(v)

	)

22 
	#˝u_to_À8
(
v
Ë(v)

	)

23 
	#__À8
 
u8


	)

25 
ölöe
 
u8
 
	$gë_u«lig√d_À8
(c⁄° *
p
)

27  *(
u8
 *)
p
;

28 
	}
}

30 
ölöe
 
	$put_u«lig√d_À8
(
u8
 
vÆ
, *
p
)

32 *(
u8
 *)
p
 = 
vÆ
;

33 
	}
}

35 
	#ªad_eb_membî
(
eb
, 
±r
, 
ty≥
, 
membî
, 
ªsu…
) (\

36 
	`ªad_exã¡_buf„r
(
eb
, (*)(
ªsu…
), \

37 (()(
±r
)) + \

38 
	`off£tof
(
ty≥
, 
membî
), \

39 
	`sizeof_fõld
(
ty≥
, 
membî
)))

	)

41 
	#wrôe_eb_membî
(
eb
, 
±r
, 
ty≥
, 
membî
, 
ªsu…
) (\

42 
	`wrôe_exã¡_buf„r
(
eb
, (*)(
ªsu…
), \

43 (()(
±r
)) + \

44 
	`off£tof
(
ty≥
, 
membî
), \

45 
	`sizeof_fõld
(
ty≥
, 
membî
)))

	)

47 
	#DECLARE_BTRFS_SETGET_BITS
(
bôs
) \

48 
u
##
bôs
 
båfs_gë_tokí_
##
	`bôs
(
båfs_m≠_tokí
 *
tokí
, \

49 c⁄° *
±r
, 
off
); \

50 
båfs_£t_tokí_
##
	`bôs
(
båfs_m≠_tokí
 *
tokí
, \

51 c⁄° *
±r
, 
off
, \

52 
u
##
bôs
 
vÆ
); \

53 
u
##
bôs
 
båfs_gë_
##
	`bôs
(c⁄° 
exã¡_buf„r
 *
eb
, \

54 c⁄° *
±r
, 
off
); \

55 
båfs_£t_
##
	`bôs
(c⁄° 
exã¡_buf„r
 *
eb
, *
±r
, \

56 
off
, 
u
##
bôs
 
vÆ
);

	)

58 
	$DECLARE_BTRFS_SETGET_BITS
(8)

59 
	$DECLARE_BTRFS_SETGET_BITS
(16)

60 
	$DECLARE_BTRFS_SETGET_BITS
(32)

61 
	$DECLARE_BTRFS_SETGET_BITS
(64)

63 
	#BTRFS_SETGET_FUNCS
(
«me
, 
ty≥
, 
membî
, 
bôs
) \

64 
ölöe
 
u
##
bôs
 
båfs_
##
	`«me
(c⁄° 
exã¡_buf„r
 *
eb
, \

65 c⁄° 
ty≥
 *
s
) \

67 
	`°©ic_as£π
((
u
##
bôs
Ë=
	`sizeof_fõld
(
ty≥
, 
membî
)); \

68  
båfs_gë_
##
	`bôs
(
eb
, 
s
, 
	`off£tof
(
ty≥
, 
membî
)); \

69 
	}
} \

70 
ölöe
 
båfs_£t_
##
	`«me
(c⁄° 
exã¡_buf„r
 *
eb
, 
ty≥
 *
s
, \

71 
u
##
bôs
 
vÆ
) \

73 
	`°©ic_as£π
((
u
##
bôs
Ë=
	`sizeof_fõld
(
ty≥
, 
membî
)); \

74 
båfs_£t_
##
	`bôs
(
eb
, 
s
, 
	`off£tof
(
ty≥
, 
membî
), 
vÆ
); \

76 
ölöe
 
u
##
bôs
 
båfs_tokí_
##
	`«me
(
båfs_m≠_tokí
 *
tokí
, \

77 c⁄° 
ty≥
 *
s
) \

79 
	`°©ic_as£π
((
u
##
bôs
Ë=
	`sizeof_fõld
(
ty≥
, 
membî
)); \

80  
båfs_gë_tokí_
##
	`bôs
(
tokí
, 
s
, 
	`off£tof
(
ty≥
, 
membî
));\

82 
ölöe
 
båfs_£t_tokí_
##
	`«me
(
båfs_m≠_tokí
 *
tokí
,\

83 
ty≥
 *
s
, 
u
##
bôs
 
vÆ
) \

85 
	`°©ic_as£π
((
u
##
bôs
Ë=
	`sizeof_fõld
(
ty≥
, 
membî
)); \

86 
båfs_£t_tokí_
##
	`bôs
(
tokí
, 
s
, 
	`off£tof
(
ty≥
, 
membî
), 
vÆ
); \

87 }

	)

89 
	#BTRFS_SETGET_HEADER_FUNCS
(
«me
, 
ty≥
, 
membî
, 
bôs
) \

90 
ölöe
 
u
##
bôs
 
båfs_
##
	`«me
(c⁄° 
exã¡_buf„r
 *
eb
) \

92 c⁄° 
ty≥
 *
p
 = 
	`∑ge_addªss
(
eb
->
∑ges
[0]) + \

93 
	`off£t_ö_∑ge
(
eb
->
°¨t
); \

94  
gë_u«lig√d_À
##
	`bôs
(&
p
->
membî
); \

96 
ölöe
 
båfs_£t_
##
	`«me
(c⁄° 
exã¡_buf„r
 *
eb
, \

97 
u
##
bôs
 
vÆ
) \

99 
ty≥
 *
p
 = 
	`∑ge_addªss
(
eb
->
∑ges
[0]Ë+ 
	`off£t_ö_∑ge
”b->
°¨t
); \

100 
put_u«lig√d_À
##
	`bôs
(
vÆ
, &
p
->
membî
); \

101 }

	)

103 
	#BTRFS_SETGET_STACK_FUNCS
(
«me
, 
ty≥
, 
membî
, 
bôs
) \

104 
ölöe
 
u
##
bôs
 
båfs_
##
	`«me
(c⁄° 
ty≥
 *
s
) \

106  
gë_u«lig√d_À
##
	`bôs
(&
s
->
membî
); \

108 
ölöe
 
båfs_£t_
##
	`«me
(
ty≥
 *
s
, 
u
##
bôs
 
vÆ
) \

110 
put_u«lig√d_À
##
	`bôs
(
vÆ
, &
s
->
membî
); \

111 }

	)

113 
ölöe
 
u64
 
	$båfs_devi˚_tŸÆ_byãs
(c⁄° 
exã¡_buf„r
 *
eb
,

114 
båfs_dev_ôem
 *
s
)

116 
	`°©ic_as£π
((
u64
Ë=
	`sizeof_fõld
(
båfs_dev_ôem
, 
tŸÆ_byãs
));

117  
	`båfs_gë_64
(
eb
, 
s
, 
	`off£tof
(
båfs_dev_ôem
, 
tŸÆ_byãs
));

118 
	}
}

119 
ölöe
 
	$båfs_£t_devi˚_tŸÆ_byãs
(c⁄° 
exã¡_buf„r
 *
eb
,

120 
båfs_dev_ôem
 *
s
,

121 
u64
 
vÆ
)

123 
	`°©ic_as£π
((
u64
Ë=
	`sizeof_fõld
(
båfs_dev_ôem
, 
tŸÆ_byãs
));

124 
	`WARN_ON
(!
	`IS_ALIGNED
(
vÆ
, 
eb
->
fs_öfo
->
£˘‹size
));

125 
	`båfs_£t_64
(
eb
, 
s
, 
	`off£tof
(
båfs_dev_ôem
, 
tŸÆ_byãs
), 
vÆ
);

126 
	}
}

128 
BTRFS_SETGET_FUNCS
(
devi˚_ty≥
, 
båfs_dev_ôem
, 
ty≥
, 64);

129 
BTRFS_SETGET_FUNCS
(
devi˚_byãs_u£d
, 
båfs_dev_ôem
, 
byãs_u£d
, 64);

130 
BTRFS_SETGET_FUNCS
(
devi˚_io_Æign
, 
båfs_dev_ôem
, 
io_Æign
, 32);

131 
BTRFS_SETGET_FUNCS
(
devi˚_io_width
, 
båfs_dev_ôem
, 
io_width
, 32);

132 
BTRFS_SETGET_FUNCS
(
devi˚_°¨t_off£t
, 
båfs_dev_ôem
, 
°¨t_off£t
, 64);

133 
BTRFS_SETGET_FUNCS
(
devi˚_£˘‹_size
, 
båfs_dev_ôem
, 
£˘‹_size
, 32);

134 
BTRFS_SETGET_FUNCS
(
devi˚_id
, 
båfs_dev_ôem
, 
devid
, 64);

135 
BTRFS_SETGET_FUNCS
(
devi˚_group
, 
båfs_dev_ôem
, 
dev_group
, 32);

136 
BTRFS_SETGET_FUNCS
(
devi˚_£ek_•ìd
, 
båfs_dev_ôem
, 
£ek_•ìd
, 8);

137 
BTRFS_SETGET_FUNCS
(
devi˚_b™dwidth
, 
båfs_dev_ôem
, 
b™dwidth
, 8);

138 
BTRFS_SETGET_FUNCS
(
devi˚_gíî©i⁄
, 
båfs_dev_ôem
, 
gíî©i⁄
, 64);

140 
BTRFS_SETGET_STACK_FUNCS
(
°ack_devi˚_ty≥
, 
båfs_dev_ôem
, 
ty≥
, 64);

141 
BTRFS_SETGET_STACK_FUNCS
(
°ack_devi˚_tŸÆ_byãs
, 
båfs_dev_ôem
,

142 
tŸÆ_byãs
, 64);

143 
BTRFS_SETGET_STACK_FUNCS
(
°ack_devi˚_byãs_u£d
, 
båfs_dev_ôem
,

144 
byãs_u£d
, 64);

145 
BTRFS_SETGET_STACK_FUNCS
(
°ack_devi˚_io_Æign
, 
båfs_dev_ôem
,

146 
io_Æign
, 32);

147 
BTRFS_SETGET_STACK_FUNCS
(
°ack_devi˚_io_width
, 
båfs_dev_ôem
,

148 
io_width
, 32);

149 
BTRFS_SETGET_STACK_FUNCS
(
°ack_devi˚_£˘‹_size
, 
båfs_dev_ôem
,

150 
£˘‹_size
, 32);

151 
BTRFS_SETGET_STACK_FUNCS
(
°ack_devi˚_id
, 
båfs_dev_ôem
, 
devid
, 64);

152 
BTRFS_SETGET_STACK_FUNCS
(
°ack_devi˚_group
, 
båfs_dev_ôem
, 
dev_group
, 32);

153 
BTRFS_SETGET_STACK_FUNCS
(
°ack_devi˚_£ek_•ìd
, 
båfs_dev_ôem
,

154 
£ek_•ìd
, 8);

155 
BTRFS_SETGET_STACK_FUNCS
(
°ack_devi˚_b™dwidth
, 
båfs_dev_ôem
,

156 
b™dwidth
, 8);

157 
BTRFS_SETGET_STACK_FUNCS
(
°ack_devi˚_gíî©i⁄
, 
båfs_dev_ôem
,

158 
gíî©i⁄
, 64);

160 
ölöe
 
	$båfs_devi˚_uuid
(
båfs_dev_ôem
 *
d
)

162  ()
d
 + 
	`off£tof
(
båfs_dev_ôem
, 
uuid
);

163 
	}
}

165 
ölöe
 
	$båfs_devi˚_fsid
(
båfs_dev_ôem
 *
d
)

167  ()
d
 + 
	`off£tof
(
båfs_dev_ôem
, 
fsid
);

168 
	}
}

170 
BTRFS_SETGET_FUNCS
(
chunk_Àngth
, 
båfs_chunk
, 
Àngth
, 64);

171 
BTRFS_SETGET_FUNCS
(
chunk_ow√r
, 
båfs_chunk
, 
ow√r
, 64);

172 
BTRFS_SETGET_FUNCS
(
chunk_°rùe_Àn
, 
båfs_chunk
, 
°rùe_Àn
, 64);

173 
BTRFS_SETGET_FUNCS
(
chunk_io_Æign
, 
båfs_chunk
, 
io_Æign
, 32);

174 
BTRFS_SETGET_FUNCS
(
chunk_io_width
, 
båfs_chunk
, 
io_width
, 32);

175 
BTRFS_SETGET_FUNCS
(
chunk_£˘‹_size
, 
båfs_chunk
, 
£˘‹_size
, 32);

176 
BTRFS_SETGET_FUNCS
(
chunk_ty≥
, 
båfs_chunk
, 
ty≥
, 64);

177 
BTRFS_SETGET_FUNCS
(
chunk_num_°rùes
, 
båfs_chunk
, 
num_°rùes
, 16);

178 
BTRFS_SETGET_FUNCS
(
chunk_sub_°rùes
, 
båfs_chunk
, 
sub_°rùes
, 16);

179 
BTRFS_SETGET_FUNCS
(
°rùe_devid
, 
båfs_°rùe
, 
devid
, 64);

180 
BTRFS_SETGET_FUNCS
(
°rùe_off£t
, 
båfs_°rùe
, 
off£t
, 64);

182 
ölöe
 *
	$båfs_°rùe_dev_uuid
(
båfs_°rùe
 *
s
)

184  (*)
s
 + 
	`off£tof
(
båfs_°rùe
, 
dev_uuid
);

185 
	}
}

187 
BTRFS_SETGET_STACK_FUNCS
(
°ack_chunk_Àngth
, 
båfs_chunk
, 
Àngth
, 64);

188 
BTRFS_SETGET_STACK_FUNCS
(
°ack_chunk_ow√r
, 
båfs_chunk
, 
ow√r
, 64);

189 
BTRFS_SETGET_STACK_FUNCS
(
°ack_chunk_°rùe_Àn
, 
båfs_chunk
,

190 
°rùe_Àn
, 64);

191 
BTRFS_SETGET_STACK_FUNCS
(
°ack_chunk_io_Æign
, 
båfs_chunk
, 
io_Æign
, 32);

192 
BTRFS_SETGET_STACK_FUNCS
(
°ack_chunk_io_width
, 
båfs_chunk
, 
io_width
, 32);

193 
BTRFS_SETGET_STACK_FUNCS
(
°ack_chunk_£˘‹_size
, 
båfs_chunk
,

194 
£˘‹_size
, 32);

195 
BTRFS_SETGET_STACK_FUNCS
(
°ack_chunk_ty≥
, 
båfs_chunk
, 
ty≥
, 64);

196 
BTRFS_SETGET_STACK_FUNCS
(
°ack_chunk_num_°rùes
, 
båfs_chunk
,

197 
num_°rùes
, 16);

198 
BTRFS_SETGET_STACK_FUNCS
(
°ack_chunk_sub_°rùes
, 
båfs_chunk
,

199 
sub_°rùes
, 16);

200 
BTRFS_SETGET_STACK_FUNCS
(
°ack_°rùe_devid
, 
båfs_°rùe
, 
devid
, 64);

201 
BTRFS_SETGET_STACK_FUNCS
(
°ack_°rùe_off£t
, 
båfs_°rùe
, 
off£t
, 64);

203 
ölöe
 
båfs_°rùe
 *
	$båfs_°rùe_ƒ
(
båfs_chunk
 *
c
, 
ƒ
)

205 
off£t
 = ()
c
;

207 
off£t
 +
	`off£tof
(
båfs_chunk
, 
°rùe
);

208 
off£t
 +
ƒ
 * (
båfs_°rùe
);

209  (
båfs_°rùe
 *)
off£t
;

210 
	}
}

212 
ölöe
 *
	$båfs_°rùe_dev_uuid_ƒ
(
båfs_chunk
 *
c
, 
ƒ
)

214  
	`båfs_°rùe_dev_uuid
(
	`båfs_°rùe_ƒ
(
c
, 
ƒ
));

215 
	}
}

217 
ölöe
 
u64
 
	$båfs_°rùe_off£t_ƒ
(c⁄° 
exã¡_buf„r
 *
eb
,

218 
båfs_chunk
 *
c
, 
ƒ
)

220  
	`båfs_°rùe_off£t
(
eb
, 
	`båfs_°rùe_ƒ
(
c
, 
ƒ
));

221 
	}
}

223 
ölöe
 
	$båfs_£t_°rùe_off£t_ƒ
(
exã¡_buf„r
 *
eb
,

224 
båfs_chunk
 *
c
, 
ƒ
,

225 
u64
 
vÆ
)

227 
	`båfs_£t_°rùe_off£t
(
eb
, 
	`båfs_°rùe_ƒ
(
c
, 
ƒ
), 
vÆ
);

228 
	}
}

230 
ölöe
 
u64
 
	$båfs_°rùe_devid_ƒ
(c⁄° 
exã¡_buf„r
 *
eb
,

231 
båfs_chunk
 *
c
, 
ƒ
)

233  
	`båfs_°rùe_devid
(
eb
, 
	`båfs_°rùe_ƒ
(
c
, 
ƒ
));

234 
	}
}

236 
ölöe
 
	$båfs_£t_°rùe_devid_ƒ
(
exã¡_buf„r
 *
eb
,

237 
båfs_chunk
 *
c
, 
ƒ
,

238 
u64
 
vÆ
)

240 
	`båfs_£t_°rùe_devid
(
eb
, 
	`båfs_°rùe_ƒ
(
c
, 
ƒ
), 
vÆ
);

241 
	}
}

244 
BTRFS_SETGET_STACK_FUNCS
(
°ack_block_group_u£d
, 
båfs_block_group_ôem
,

245 
u£d
, 64);

246 
BTRFS_SETGET_FUNCS
(
block_group_u£d
, 
båfs_block_group_ôem
, 
u£d
, 64);

247 
BTRFS_SETGET_STACK_FUNCS
(
°ack_block_group_chunk_obje˘id
,

248 
båfs_block_group_ôem
, 
chunk_obje˘id
, 64);

250 
BTRFS_SETGET_FUNCS
(
block_group_chunk_obje˘id
,

251 
båfs_block_group_ôem
, 
chunk_obje˘id
, 64);

252 
BTRFS_SETGET_FUNCS
(
block_group_Êags
, 
båfs_block_group_ôem
, 
Êags
, 64);

253 
BTRFS_SETGET_STACK_FUNCS
(
°ack_block_group_Êags
,

254 
båfs_block_group_ôem
, 
Êags
, 64);

257 
BTRFS_SETGET_FUNCS
(
‰ì_•a˚_exã¡_cou¡
, 
båfs_‰ì_•a˚_öfo
,

258 
exã¡_cou¡
, 32);

259 
BTRFS_SETGET_FUNCS
(
‰ì_•a˚_Êags
, 
båfs_‰ì_•a˚_öfo
, 
Êags
, 32);

262 
BTRFS_SETGET_FUNCS
(
öode_ªf_«me_Àn
, 
båfs_öode_ªf
, 
«me_Àn
, 16);

263 
BTRFS_SETGET_FUNCS
(
öode_ªf_ödex
, 
båfs_öode_ªf
, 
ödex
, 64);

264 
BTRFS_SETGET_STACK_FUNCS
(
°ack_öode_ªf_«me_Àn
, 
båfs_öode_ªf
, 
«me_Àn
, 16);

265 
BTRFS_SETGET_STACK_FUNCS
(
°ack_öode_ªf_ödex
, 
båfs_öode_ªf
, 
ödex
, 64);

268 
BTRFS_SETGET_FUNCS
(
öode_exåef_∑ª¡
, 
båfs_öode_exåef
,

269 
∑ª¡_obje˘id
, 64);

270 
BTRFS_SETGET_FUNCS
(
öode_exåef_«me_Àn
, 
båfs_öode_exåef
,

271 
«me_Àn
, 16);

272 
BTRFS_SETGET_FUNCS
(
öode_exåef_ödex
, 
båfs_öode_exåef
, 
ödex
, 64);

275 
BTRFS_SETGET_FUNCS
(
öode_gíî©i⁄
, 
båfs_öode_ôem
, 
gíî©i⁄
, 64);

276 
BTRFS_SETGET_FUNCS
(
öode_£quí˚
, 
båfs_öode_ôem
, 
£quí˚
, 64);

277 
BTRFS_SETGET_FUNCS
(
öode_å™sid
, 
båfs_öode_ôem
, 
å™sid
, 64);

278 
BTRFS_SETGET_FUNCS
(
öode_size
, 
båfs_öode_ôem
, 
size
, 64);

279 
BTRFS_SETGET_FUNCS
(
öode_nbyãs
, 
båfs_öode_ôem
, 
nbyãs
, 64);

280 
BTRFS_SETGET_FUNCS
(
öode_block_group
, 
båfs_öode_ôem
, 
block_group
, 64);

281 
BTRFS_SETGET_FUNCS
(
öode_∆ök
, 
båfs_öode_ôem
, 
∆ök
, 32);

282 
BTRFS_SETGET_FUNCS
(
öode_uid
, 
båfs_öode_ôem
, 
uid
, 32);

283 
BTRFS_SETGET_FUNCS
(
öode_gid
, 
båfs_öode_ôem
, 
gid
, 32);

284 
BTRFS_SETGET_FUNCS
(
öode_mode
, 
båfs_öode_ôem
, 
mode
, 32);

285 
BTRFS_SETGET_FUNCS
(
öode_rdev
, 
båfs_öode_ôem
, 
rdev
, 64);

286 
BTRFS_SETGET_FUNCS
(
öode_Êags
, 
båfs_öode_ôem
, 
Êags
, 64);

287 
BTRFS_SETGET_STACK_FUNCS
(
°ack_öode_gíî©i⁄
, 
båfs_öode_ôem
,

288 
gíî©i⁄
, 64);

289 
BTRFS_SETGET_STACK_FUNCS
(
°ack_öode_£quí˚
, 
båfs_öode_ôem
,

290 
£quí˚
, 64);

291 
BTRFS_SETGET_STACK_FUNCS
(
°ack_öode_å™sid
, 
båfs_öode_ôem
,

292 
å™sid
, 64);

293 
BTRFS_SETGET_STACK_FUNCS
(
°ack_öode_size
, 
båfs_öode_ôem
, 
size
, 64);

294 
BTRFS_SETGET_STACK_FUNCS
(
°ack_öode_nbyãs
, 
båfs_öode_ôem
, 
nbyãs
, 64);

295 
BTRFS_SETGET_STACK_FUNCS
(
°ack_öode_block_group
, 
båfs_öode_ôem
,

296 
block_group
, 64);

297 
BTRFS_SETGET_STACK_FUNCS
(
°ack_öode_∆ök
, 
båfs_öode_ôem
, 
∆ök
, 32);

298 
BTRFS_SETGET_STACK_FUNCS
(
°ack_öode_uid
, 
båfs_öode_ôem
, 
uid
, 32);

299 
BTRFS_SETGET_STACK_FUNCS
(
°ack_öode_gid
, 
båfs_öode_ôem
, 
gid
, 32);

300 
BTRFS_SETGET_STACK_FUNCS
(
°ack_öode_mode
, 
båfs_öode_ôem
, 
mode
, 32);

301 
BTRFS_SETGET_STACK_FUNCS
(
°ack_öode_rdev
, 
båfs_öode_ôem
, 
rdev
, 64);

302 
BTRFS_SETGET_STACK_FUNCS
(
°ack_öode_Êags
, 
båfs_öode_ôem
, 
Êags
, 64);

303 
BTRFS_SETGET_FUNCS
(
time•ec_£c
, 
båfs_time•ec
, 
£c
, 64);

304 
BTRFS_SETGET_FUNCS
(
time•ec_n£c
, 
båfs_time•ec
, 
n£c
, 32);

305 
BTRFS_SETGET_STACK_FUNCS
(
°ack_time•ec_£c
, 
båfs_time•ec
, 
£c
, 64);

306 
BTRFS_SETGET_STACK_FUNCS
(
°ack_time•ec_n£c
, 
båfs_time•ec
, 
n£c
, 32);

309 
BTRFS_SETGET_FUNCS
(
dev_exã¡_chunk_åì
, 
båfs_dev_exã¡
, 
chunk_åì
, 64);

310 
BTRFS_SETGET_FUNCS
(
dev_exã¡_chunk_obje˘id
, 
båfs_dev_exã¡
,

311 
chunk_obje˘id
, 64);

312 
BTRFS_SETGET_FUNCS
(
dev_exã¡_chunk_off£t
, 
båfs_dev_exã¡
,

313 
chunk_off£t
, 64);

314 
BTRFS_SETGET_FUNCS
(
dev_exã¡_Àngth
, 
båfs_dev_exã¡
, 
Àngth
, 64);

315 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dev_exã¡_chunk_åì
, 
båfs_dev_exã¡
,

316 
chunk_åì
, 64);

317 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dev_exã¡_chunk_obje˘id
, 
båfs_dev_exã¡
,

318 
chunk_obje˘id
, 64);

319 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dev_exã¡_chunk_off£t
, 
båfs_dev_exã¡
,

320 
chunk_off£t
, 64);

321 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dev_exã¡_Àngth
, 
båfs_dev_exã¡
, 
Àngth
, 64);

323 
BTRFS_SETGET_FUNCS
(
exã¡_ªfs
, 
båfs_exã¡_ôem
, 
ªfs
, 64);

324 
BTRFS_SETGET_FUNCS
(
exã¡_gíî©i⁄
, 
båfs_exã¡_ôem
, 
gíî©i⁄
, 64);

325 
BTRFS_SETGET_FUNCS
(
exã¡_Êags
, 
båfs_exã¡_ôem
, 
Êags
, 64);

327 
BTRFS_SETGET_FUNCS
(
åì_block_Àvñ
, 
båfs_åì_block_öfo
, 
Àvñ
, 8);

329 
ölöe
 
	$båfs_åì_block_key
(c⁄° 
exã¡_buf„r
 *
eb
,

330 
båfs_åì_block_öfo
 *
ôem
,

331 
båfs_disk_key
 *
key
)

333 
	`ªad_eb_membî
(
eb
, 
ôem
, 
båfs_åì_block_öfo
, 
key
, key);

334 
	}
}

336 
ölöe
 
	$båfs_£t_åì_block_key
(c⁄° 
exã¡_buf„r
 *
eb
,

337 
båfs_åì_block_öfo
 *
ôem
,

338 
båfs_disk_key
 *
key
)

340 
	`wrôe_eb_membî
(
eb
, 
ôem
, 
båfs_åì_block_öfo
, 
key
, key);

341 
	}
}

343 
BTRFS_SETGET_FUNCS
(
exã¡_d©a_ªf_roŸ
, 
båfs_exã¡_d©a_ªf
, 
roŸ
, 64);

344 
BTRFS_SETGET_FUNCS
(
exã¡_d©a_ªf_obje˘id
, 
båfs_exã¡_d©a_ªf
,

345 
obje˘id
, 64);

346 
BTRFS_SETGET_FUNCS
(
exã¡_d©a_ªf_off£t
, 
båfs_exã¡_d©a_ªf
,

347 
off£t
, 64);

348 
BTRFS_SETGET_FUNCS
(
exã¡_d©a_ªf_cou¡
, 
båfs_exã¡_d©a_ªf
, 
cou¡
, 32);

350 
BTRFS_SETGET_FUNCS
(
sh¨ed_d©a_ªf_cou¡
, 
båfs_sh¨ed_d©a_ªf
, 
cou¡
, 32);

352 
BTRFS_SETGET_FUNCS
(
exã¡_ölöe_ªf_ty≥
, 
båfs_exã¡_ölöe_ªf
,

353 
ty≥
, 8);

354 
BTRFS_SETGET_FUNCS
(
exã¡_ölöe_ªf_off£t
, 
båfs_exã¡_ölöe_ªf
,

355 
off£t
, 64);

357 
ölöe
 
u32
 
	$båfs_exã¡_ölöe_ªf_size
(
ty≥
)

359 i‡(
ty≥
 =
BTRFS_TREE_BLOCK_REF_KEY
 ||

360 
ty≥
 =
BTRFS_SHARED_BLOCK_REF_KEY
)

361  (
båfs_exã¡_ölöe_ªf
);

362 i‡(
ty≥
 =
BTRFS_SHARED_DATA_REF_KEY
)

363  (
båfs_sh¨ed_d©a_ªf
) +

364 (
båfs_exã¡_ölöe_ªf
);

365 i‡(
ty≥
 =
BTRFS_EXTENT_DATA_REF_KEY
)

366  (
båfs_exã¡_d©a_ªf
) +

367 
	`off£tof
(
båfs_exã¡_ölöe_ªf
, 
off£t
);

369 
	}
}

372 
BTRFS_SETGET_FUNCS
(
key_block±r
, 
båfs_key_±r
, 
block±r
, 64);

373 
BTRFS_SETGET_FUNCS
(
key_gíî©i⁄
, 
båfs_key_±r
, 
gíî©i⁄
, 64);

374 
BTRFS_SETGET_STACK_FUNCS
(
°ack_key_block±r
, 
båfs_key_±r
, 
block±r
, 64);

375 
BTRFS_SETGET_STACK_FUNCS
(
°ack_key_gíî©i⁄
, 
båfs_key_±r
,

376 
gíî©i⁄
, 64);

378 
ölöe
 
u64
 
	$båfs_node_block±r
(c⁄° 
exã¡_buf„r
 *
eb
, 
ƒ
)

380 
±r
;

382 
±r
 = 
	`off£tof
(
båfs_node
, 
±rs
) +

383 (
båfs_key_±r
Ë* 
ƒ
;

384  
	`båfs_key_block±r
(
eb
, (
båfs_key_±r
 *)
±r
);

385 
	}
}

387 
ölöe
 
	$båfs_£t_node_block±r
(c⁄° 
exã¡_buf„r
 *
eb
,

388 
ƒ
, 
u64
 
vÆ
)

390 
±r
;

392 
±r
 = 
	`off£tof
(
båfs_node
, 
±rs
) +

393 (
båfs_key_±r
Ë* 
ƒ
;

394 
	`båfs_£t_key_block±r
(
eb
, (
båfs_key_±r
 *)
±r
, 
vÆ
);

395 
	}
}

397 
ölöe
 
u64
 
	$båfs_node_±r_gíî©i⁄
(c⁄° 
exã¡_buf„r
 *
eb
, 
ƒ
)

399 
±r
;

401 
±r
 = 
	`off£tof
(
båfs_node
, 
±rs
) +

402 (
båfs_key_±r
Ë* 
ƒ
;

403  
	`båfs_key_gíî©i⁄
(
eb
, (
båfs_key_±r
 *)
±r
);

404 
	}
}

406 
ölöe
 
	$båfs_£t_node_±r_gíî©i⁄
(c⁄° 
exã¡_buf„r
 *
eb
,

407 
ƒ
, 
u64
 
vÆ
)

409 
±r
;

411 
±r
 = 
	`off£tof
(
båfs_node
, 
±rs
) +

412 (
båfs_key_±r
Ë* 
ƒ
;

413 
	`båfs_£t_key_gíî©i⁄
(
eb
, (
båfs_key_±r
 *)
±r
, 
vÆ
);

414 
	}
}

416 
ölöe
 
	$båfs_node_key_±r_off£t
(c⁄° 
exã¡_buf„r
 *
eb
, 
ƒ
)

418  
	`off£tof
(
båfs_node
, 
±rs
) +

419 (
båfs_key_±r
Ë* 
ƒ
;

420 
	}
}

422 
båfs_node_key
(c⁄° 
exã¡_buf„r
 *
eb
,

423 
båfs_disk_key
 *
disk_key
, 
ƒ
);

425 
ölöe
 
	$båfs_£t_node_key
(c⁄° 
exã¡_buf„r
 *
eb
,

426 
båfs_disk_key
 *
disk_key
, 
ƒ
)

428 
±r
;

430 
±r
 = 
	`båfs_node_key_±r_off£t
(
eb
, 
ƒ
);

431 
	`wrôe_eb_membî
(
eb
, (
båfs_key_±r
 *)
±r
,

432 
båfs_key_±r
, 
key
, 
disk_key
);

433 
	}
}

436 
BTRFS_SETGET_FUNCS
(
øw_ôem_off£t
, 
båfs_ôem
, 
off£t
, 32);

437 
BTRFS_SETGET_FUNCS
(
øw_ôem_size
, 
båfs_ôem
, 
size
, 32);

438 
BTRFS_SETGET_STACK_FUNCS
(
°ack_ôem_off£t
, 
båfs_ôem
, 
off£t
, 32);

439 
BTRFS_SETGET_STACK_FUNCS
(
°ack_ôem_size
, 
båfs_ôem
, 
size
, 32);

441 
ölöe
 
	$båfs_ôem_ƒ_off£t
(c⁄° 
exã¡_buf„r
 *
eb
, 
ƒ
)

443  
	`off£tof
(
båfs_Àaf
, 
ôems
) +

444 (
båfs_ôem
Ë* 
ƒ
;

445 
	}
}

447 
ölöe
 
båfs_ôem
 *
	$båfs_ôem_ƒ
(c⁄° 
exã¡_buf„r
 *
eb
, 
ƒ
)

449  (
båfs_ôem
 *)
	`båfs_ôem_ƒ_off£t
(
eb
, 
ƒ
);

450 
	}
}

452 
	#BTRFS_ITEM_SETGET_FUNCS
(
membî
) \

453 
ölöe
 
u32
 
båfs_ôem_
##
	`membî
(c⁄° 
exã¡_buf„r
 *
eb
, 
¶Ÿ
) \

455  
båfs_øw_ôem_
##
	`membî
(
eb
, 
	`båfs_ôem_ƒ
”b, 
¶Ÿ
)); \

457 
ölöe
 
båfs_£t_ôem_
##
	`membî
(c⁄° 
exã¡_buf„r
 *
eb
, \

458 
¶Ÿ
, 
u32
 
vÆ
) \

460 
båfs_£t_øw_ôem_
##
	`membî
(
eb
, 
	`båfs_ôem_ƒ
”b, 
¶Ÿ
), 
vÆ
); \

462 
ölöe
 
u32
 
båfs_tokí_ôem_
##
	`membî
(
båfs_m≠_tokí
 *
tokí
, \

463 
¶Ÿ
) \

465 
båfs_ôem
 *
ôem
 = 
	`båfs_ôem_ƒ
(
tokí
->
eb
, 
¶Ÿ
); \

466  
båfs_tokí_øw_ôem_
##
	`membî
(
tokí
, 
ôem
); \

468 
ölöe
 
båfs_£t_tokí_ôem_
##
	`membî
(
båfs_m≠_tokí
 *
tokí
, \

469 
¶Ÿ
, 
u32
 
vÆ
) \

471 
båfs_ôem
 *
ôem
 = 
	`båfs_ôem_ƒ
(
tokí
->
eb
, 
¶Ÿ
); \

472 
båfs_£t_tokí_øw_ôem_
##
	`membî
(
tokí
, 
ôem
, 
vÆ
); \

473 }

	)

475 
	$BTRFS_ITEM_SETGET_FUNCS
(
off£t
)

476 
	`BTRFS_ITEM_SETGET_FUNCS
(
size
);

478 
ölöe
 
u32
 
	$båfs_ôem_d©a_íd
(c⁄° 
exã¡_buf„r
 *
eb
, 
ƒ
)

480  
	`båfs_ôem_off£t
(
eb
, 
ƒ
Ë+ 
	`båfs_ôem_size
(eb,Çr);

481 
	}
}

483 
ölöe
 
	$båfs_ôem_key
(c⁄° 
exã¡_buf„r
 *
eb
,

484 
båfs_disk_key
 *
disk_key
, 
ƒ
)

486 
båfs_ôem
 *
ôem
 = 
	`båfs_ôem_ƒ
(
eb
, 
ƒ
);

488 
	`ªad_eb_membî
(
eb
, 
ôem
, 
båfs_ôem
, 
key
, 
disk_key
);

489 
	}
}

491 
ölöe
 
	$båfs_£t_ôem_key
(
exã¡_buf„r
 *
eb
,

492 
båfs_disk_key
 *
disk_key
, 
ƒ
)

494 
båfs_ôem
 *
ôem
 = 
	`båfs_ôem_ƒ
(
eb
, 
ƒ
);

496 
	`wrôe_eb_membî
(
eb
, 
ôem
, 
båfs_ôem
, 
key
, 
disk_key
);

497 
	}
}

499 
BTRFS_SETGET_FUNCS
(
dú_log_íd
, 
båfs_dú_log_ôem
, 
íd
, 64);

502 
BTRFS_SETGET_FUNCS
(
roŸ_ªf_dúid
, 
båfs_roŸ_ªf
, 
dúid
, 64);

503 
BTRFS_SETGET_FUNCS
(
roŸ_ªf_£quí˚
, 
båfs_roŸ_ªf
, 
£quí˚
, 64);

504 
BTRFS_SETGET_FUNCS
(
roŸ_ªf_«me_Àn
, 
båfs_roŸ_ªf
, 
«me_Àn
, 16);

505 
BTRFS_SETGET_STACK_FUNCS
(
°ack_roŸ_ªf_dúid
, 
båfs_roŸ_ªf
, 
dúid
, 64);

506 
BTRFS_SETGET_STACK_FUNCS
(
°ack_roŸ_ªf_£quí˚
, 
båfs_roŸ_ªf
, 
£quí˚
, 64);

507 
BTRFS_SETGET_STACK_FUNCS
(
°ack_roŸ_ªf_«me_Àn
, 
båfs_roŸ_ªf
, 
«me_Àn
, 16);

510 
BTRFS_SETGET_FUNCS
(
dú_d©a_Àn
, 
båfs_dú_ôem
, 
d©a_Àn
, 16);

511 
BTRFS_SETGET_FUNCS
(
dú_Êags
, 
båfs_dú_ôem
, 
ty≥
, 8);

512 
BTRFS_SETGET_FUNCS
(
dú_«me_Àn
, 
båfs_dú_ôem
, 
«me_Àn
, 16);

513 
BTRFS_SETGET_FUNCS
(
dú_å™sid
, 
båfs_dú_ôem
, 
å™sid
, 64);

514 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dú_Êags
, 
båfs_dú_ôem
, 
ty≥
, 8);

515 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dú_d©a_Àn
, 
båfs_dú_ôem
, 
d©a_Àn
, 16);

516 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dú_«me_Àn
, 
båfs_dú_ôem
, 
«me_Àn
, 16);

517 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dú_å™sid
, 
båfs_dú_ôem
, 
å™sid
, 64);

519 
ölöe
 
u8
 
	$båfs_dú_·y≥
(c⁄° 
exã¡_buf„r
 *
eb
,

520 c⁄° 
båfs_dú_ôem
 *
ôem
)

522  
	`båfs_dú_Êags_to_·y≥
(
	`båfs_dú_Êags
(
eb
, 
ôem
));

523 
	}
}

525 
ölöe
 
u8
 
	$båfs_°ack_dú_·y≥
(c⁄° 
båfs_dú_ôem
 *
ôem
)

527  
	`båfs_dú_Êags_to_·y≥
(
	`båfs_°ack_dú_Êags
(
ôem
));

528 
	}
}

530 
ölöe
 
	$båfs_dú_ôem_key
(c⁄° 
exã¡_buf„r
 *
eb
,

531 c⁄° 
båfs_dú_ôem
 *
ôem
,

532 
båfs_disk_key
 *
key
)

534 
	`ªad_eb_membî
(
eb
, 
ôem
, 
båfs_dú_ôem
, 
loˇti⁄
, 
key
);

535 
	}
}

537 
ölöe
 
	$båfs_£t_dú_ôem_key
(
exã¡_buf„r
 *
eb
,

538 
båfs_dú_ôem
 *
ôem
,

539 c⁄° 
båfs_disk_key
 *
key
)

541 
	`wrôe_eb_membî
(
eb
, 
ôem
, 
båfs_dú_ôem
, 
loˇti⁄
, 
key
);

542 
	}
}

544 
BTRFS_SETGET_FUNCS
(
‰ì_•a˚_íåõs
, 
båfs_‰ì_•a˚_hódî
,

545 
num_íåõs
, 64);

546 
BTRFS_SETGET_FUNCS
(
‰ì_•a˚_bôm≠s
, 
båfs_‰ì_•a˚_hódî
,

547 
num_bôm≠s
, 64);

548 
BTRFS_SETGET_FUNCS
(
‰ì_•a˚_gíî©i⁄
, 
båfs_‰ì_•a˚_hódî
,

549 
gíî©i⁄
, 64);

551 
ölöe
 
	$båfs_‰ì_•a˚_key
(c⁄° 
exã¡_buf„r
 *
eb
,

552 c⁄° 
båfs_‰ì_•a˚_hódî
 *
h
,

553 
båfs_disk_key
 *
key
)

555 
	`ªad_eb_membî
(
eb
, 
h
, 
båfs_‰ì_•a˚_hódî
, 
loˇti⁄
, 
key
);

556 
	}
}

558 
ölöe
 
	$båfs_£t_‰ì_•a˚_key
(
exã¡_buf„r
 *
eb
,

559 
båfs_‰ì_•a˚_hódî
 *
h
,

560 c⁄° 
båfs_disk_key
 *
key
)

562 
	`wrôe_eb_membî
(
eb
, 
h
, 
båfs_‰ì_•a˚_hódî
, 
loˇti⁄
, 
key
);

563 
	}
}

566 
BTRFS_SETGET_STACK_FUNCS
(
disk_key_obje˘id
, 
båfs_disk_key
, 
obje˘id
, 64);

567 
BTRFS_SETGET_STACK_FUNCS
(
disk_key_off£t
, 
båfs_disk_key
, 
off£t
, 64);

568 
BTRFS_SETGET_STACK_FUNCS
(
disk_key_ty≥
, 
båfs_disk_key
, 
ty≥
, 8);

570 #ifde‡
__LITTLE_ENDIAN


577 
ölöe
 
	$båfs_disk_key_to_˝u
(
båfs_key
 *
˝u_key
,

578 c⁄° 
båfs_disk_key
 *
disk_key
)

580 
	`mem˝y
(
˝u_key
, 
disk_key
, (
båfs_key
));

581 
	}
}

583 
ölöe
 
	$båfs_˝u_key_to_disk
(
båfs_disk_key
 *
disk_key
,

584 c⁄° 
båfs_key
 *
˝u_key
)

586 
	`mem˝y
(
disk_key
, 
˝u_key
, (
båfs_key
));

587 
	}
}

589 
ölöe
 
	$båfs_node_key_to_˝u
(c⁄° 
exã¡_buf„r
 *
eb
,

590 
båfs_key
 *
˝u_key
, 
ƒ
)

592 
båfs_disk_key
 *
disk_key
 = (båfs_disk_key *)
˝u_key
;

594 
	`båfs_node_key
(
eb
, 
disk_key
, 
ƒ
);

595 
	}
}

597 
ölöe
 
	$båfs_ôem_key_to_˝u
(c⁄° 
exã¡_buf„r
 *
eb
,

598 
båfs_key
 *
˝u_key
, 
ƒ
)

600 
båfs_disk_key
 *
disk_key
 = (båfs_disk_key *)
˝u_key
;

602 
	`båfs_ôem_key
(
eb
, 
disk_key
, 
ƒ
);

603 
	}
}

605 
ölöe
 
	$båfs_dú_ôem_key_to_˝u
(c⁄° 
exã¡_buf„r
 *
eb
,

606 c⁄° 
båfs_dú_ôem
 *
ôem
,

607 
båfs_key
 *
˝u_key
)

609 
båfs_disk_key
 *
disk_key
 = (båfs_disk_key *)
˝u_key
;

611 
	`båfs_dú_ôem_key
(
eb
, 
ôem
, 
disk_key
);

612 
	}
}

616 
ölöe
 
	$båfs_disk_key_to_˝u
(
båfs_key
 *
˝u
,

617 c⁄° 
båfs_disk_key
 *
disk
)

619 
˝u
->
off£t
 = 
	`À64_to_˝u
(
disk
->offset);

620 
˝u
->
ty≥
 = 
disk
->type;

621 
˝u
->
obje˘id
 = 
	`À64_to_˝u
(
disk
->objectid);

622 
	}
}

624 
ölöe
 
	$båfs_˝u_key_to_disk
(
båfs_disk_key
 *
disk
,

625 c⁄° 
båfs_key
 *
˝u
)

627 
disk
->
off£t
 = 
	`˝u_to_À64
(
˝u
->offset);

628 
disk
->
ty≥
 = 
˝u
->type;

629 
disk
->
obje˘id
 = 
	`˝u_to_À64
(
˝u
->objectid);

630 
	}
}

632 
ölöe
 
	$båfs_node_key_to_˝u
(c⁄° 
exã¡_buf„r
 *
eb
,

633 
båfs_key
 *
key
, 
ƒ
)

635 
båfs_disk_key
 
disk_key
;

637 
	`båfs_node_key
(
eb
, &
disk_key
, 
ƒ
);

638 
	`båfs_disk_key_to_˝u
(
key
, &
disk_key
);

639 
	}
}

641 
ölöe
 
	$båfs_ôem_key_to_˝u
(c⁄° 
exã¡_buf„r
 *
eb
,

642 
båfs_key
 *
key
, 
ƒ
)

644 
båfs_disk_key
 
disk_key
;

646 
	`båfs_ôem_key
(
eb
, &
disk_key
, 
ƒ
);

647 
	`båfs_disk_key_to_˝u
(
key
, &
disk_key
);

648 
	}
}

650 
ölöe
 
	$båfs_dú_ôem_key_to_˝u
(c⁄° 
exã¡_buf„r
 *
eb
,

651 c⁄° 
båfs_dú_ôem
 *
ôem
,

652 
båfs_key
 *
key
)

654 
båfs_disk_key
 
disk_key
;

656 
	`båfs_dú_ôem_key
(
eb
, 
ôem
, &
disk_key
);

657 
	`båfs_disk_key_to_˝u
(
key
, &
disk_key
);

658 
	}
}

663 
BTRFS_SETGET_HEADER_FUNCS
(
hódî_byãƒ
, 
båfs_hódî
, 
byãƒ
, 64);

664 
BTRFS_SETGET_HEADER_FUNCS
(
hódî_gíî©i⁄
, 
båfs_hódî
, 
gíî©i⁄
, 64);

665 
BTRFS_SETGET_HEADER_FUNCS
(
hódî_ow√r
, 
båfs_hódî
, 
ow√r
, 64);

666 
BTRFS_SETGET_HEADER_FUNCS
(
hódî_ƒôems
, 
båfs_hódî
, 
ƒôems
, 32);

667 
BTRFS_SETGET_HEADER_FUNCS
(
hódî_Êags
, 
båfs_hódî
, 
Êags
, 64);

668 
BTRFS_SETGET_HEADER_FUNCS
(
hódî_Àvñ
, 
båfs_hódî
, 
Àvñ
, 8);

669 
BTRFS_SETGET_STACK_FUNCS
(
°ack_hódî_gíî©i⁄
, 
båfs_hódî
,

670 
gíî©i⁄
, 64);

671 
BTRFS_SETGET_STACK_FUNCS
(
°ack_hódî_ow√r
, 
båfs_hódî
, 
ow√r
, 64);

672 
BTRFS_SETGET_STACK_FUNCS
(
°ack_hódî_ƒôems
, 
båfs_hódî
, 
ƒôems
, 32);

673 
BTRFS_SETGET_STACK_FUNCS
(
°ack_hódî_byãƒ
, 
båfs_hódî
, 
byãƒ
, 64);

675 
ölöe
 
	$båfs_hódî_Êag
(c⁄° 
exã¡_buf„r
 *
eb
, 
u64
 
Êag
)

677  (
	`båfs_hódî_Êags
(
eb
Ë& 
Êag
) == flag;

678 
	}
}

680 
ölöe
 
	$båfs_£t_hódî_Êag
(
exã¡_buf„r
 *
eb
, 
u64
 
Êag
)

682 
u64
 
Êags
 = 
	`båfs_hódî_Êags
(
eb
);

684 
	`båfs_£t_hódî_Êags
(
eb
, 
Êags
 | 
Êag
);

685 
	}
}

687 
ölöe
 
	$båfs_˛ór_hódî_Êag
(
exã¡_buf„r
 *
eb
, 
u64
 
Êag
)

689 
u64
 
Êags
 = 
	`båfs_hódî_Êags
(
eb
);

691 
	`båfs_£t_hódî_Êags
(
eb
, 
Êags
 & ~
Êag
);

692 
	}
}

694 
ölöe
 
	$båfs_hódî_backªf_ªv
(c⁄° 
exã¡_buf„r
 *
eb
)

696 
u64
 
Êags
 = 
	`båfs_hódî_Êags
(
eb
);

698  
Êags
 >> 
BTRFS_BACKREF_REV_SHIFT
;

699 
	}
}

701 
ölöe
 
	$båfs_£t_hódî_backªf_ªv
(
exã¡_buf„r
 *
eb
, 
ªv
)

703 
u64
 
Êags
 = 
	`båfs_hódî_Êags
(
eb
);

705 
Êags
 &~
BTRFS_BACKREF_REV_MASK
;

706 
Êags
 |(
u64
)
ªv
 << 
BTRFS_BACKREF_REV_SHIFT
;

707 
	`båfs_£t_hódî_Êags
(
eb
, 
Êags
);

708 
	}
}

710 
ölöe
 
	$båfs_is_Àaf
(c⁄° 
exã¡_buf„r
 *
eb
)

712  
	`båfs_hódî_Àvñ
(
eb
) == 0;

713 
	}
}

716 
BTRFS_SETGET_FUNCS
(
disk_roŸ_gíî©i⁄
, 
båfs_roŸ_ôem
, 
gíî©i⁄
, 64);

717 
BTRFS_SETGET_FUNCS
(
disk_roŸ_ªfs
, 
båfs_roŸ_ôem
, 
ªfs
, 32);

718 
BTRFS_SETGET_FUNCS
(
disk_roŸ_byãƒ
, 
båfs_roŸ_ôem
, 
byãƒ
, 64);

719 
BTRFS_SETGET_FUNCS
(
disk_roŸ_Àvñ
, 
båfs_roŸ_ôem
, 
Àvñ
, 8);

721 
BTRFS_SETGET_STACK_FUNCS
(
roŸ_gíî©i⁄
, 
båfs_roŸ_ôem
, 
gíî©i⁄
, 64);

722 
BTRFS_SETGET_STACK_FUNCS
(
roŸ_byãƒ
, 
båfs_roŸ_ôem
, 
byãƒ
, 64);

723 
BTRFS_SETGET_STACK_FUNCS
(
roŸ_dr›_Àvñ
, 
båfs_roŸ_ôem
, 
dr›_Àvñ
, 8);

724 
BTRFS_SETGET_STACK_FUNCS
(
roŸ_Àvñ
, 
båfs_roŸ_ôem
, 
Àvñ
, 8);

725 
BTRFS_SETGET_STACK_FUNCS
(
roŸ_dúid
, 
båfs_roŸ_ôem
,Ñoot_dirid, 64);

726 
BTRFS_SETGET_STACK_FUNCS
(
roŸ_ªfs
, 
båfs_roŸ_ôem
, 
ªfs
, 32);

727 
BTRFS_SETGET_STACK_FUNCS
(
roŸ_Êags
, 
båfs_roŸ_ôem
, 
Êags
, 64);

728 
BTRFS_SETGET_STACK_FUNCS
(
roŸ_u£d
, 
båfs_roŸ_ôem
, 
byãs_u£d
, 64);

729 
BTRFS_SETGET_STACK_FUNCS
(
roŸ_limô
, 
båfs_roŸ_ôem
, 
byã_limô
, 64);

730 
BTRFS_SETGET_STACK_FUNCS
(
roŸ_œ°_¢≠shŸ
, 
båfs_roŸ_ôem
,

731 
œ°_¢≠shŸ
, 64);

732 
BTRFS_SETGET_STACK_FUNCS
(
roŸ_gíî©i⁄_v2
, 
båfs_roŸ_ôem
,

733 
gíî©i⁄_v2
, 64);

734 
BTRFS_SETGET_STACK_FUNCS
(
roŸ_˘ønsid
, 
båfs_roŸ_ôem
, 
˘ønsid
, 64);

735 
BTRFS_SETGET_STACK_FUNCS
(
roŸ_Ÿønsid
, 
båfs_roŸ_ôem
, 
Ÿønsid
, 64);

736 
BTRFS_SETGET_STACK_FUNCS
(
roŸ_°ønsid
, 
båfs_roŸ_ôem
, 
°ønsid
, 64);

737 
BTRFS_SETGET_STACK_FUNCS
(
roŸ_πønsid
, 
båfs_roŸ_ôem
, 
πønsid
, 64);

740 
BTRFS_SETGET_STACK_FUNCS
(
backup_åì_roŸ
, 
båfs_roŸ_backup
,

741 
åì_roŸ
, 64);

742 
BTRFS_SETGET_STACK_FUNCS
(
backup_åì_roŸ_gí
, 
båfs_roŸ_backup
,

743 
åì_roŸ_gí
, 64);

744 
BTRFS_SETGET_STACK_FUNCS
(
backup_åì_roŸ_Àvñ
, 
båfs_roŸ_backup
,

745 
åì_roŸ_Àvñ
, 8);

747 
BTRFS_SETGET_STACK_FUNCS
(
backup_chunk_roŸ
, 
båfs_roŸ_backup
,

748 
chunk_roŸ
, 64);

749 
BTRFS_SETGET_STACK_FUNCS
(
backup_chunk_roŸ_gí
, 
båfs_roŸ_backup
,

750 
chunk_roŸ_gí
, 64);

751 
BTRFS_SETGET_STACK_FUNCS
(
backup_chunk_roŸ_Àvñ
, 
båfs_roŸ_backup
,

752 
chunk_roŸ_Àvñ
, 8);

754 
BTRFS_SETGET_STACK_FUNCS
(
backup_exã¡_roŸ
, 
båfs_roŸ_backup
,

755 
exã¡_roŸ
, 64);

756 
BTRFS_SETGET_STACK_FUNCS
(
backup_exã¡_roŸ_gí
, 
båfs_roŸ_backup
,

757 
exã¡_roŸ_gí
, 64);

758 
BTRFS_SETGET_STACK_FUNCS
(
backup_exã¡_roŸ_Àvñ
, 
båfs_roŸ_backup
,

759 
exã¡_roŸ_Àvñ
, 8);

761 
BTRFS_SETGET_STACK_FUNCS
(
backup_fs_roŸ
, 
båfs_roŸ_backup
,

762 
fs_roŸ
, 64);

763 
BTRFS_SETGET_STACK_FUNCS
(
backup_fs_roŸ_gí
, 
båfs_roŸ_backup
,

764 
fs_roŸ_gí
, 64);

765 
BTRFS_SETGET_STACK_FUNCS
(
backup_fs_roŸ_Àvñ
, 
båfs_roŸ_backup
,

766 
fs_roŸ_Àvñ
, 8);

768 
BTRFS_SETGET_STACK_FUNCS
(
backup_dev_roŸ
, 
båfs_roŸ_backup
,

769 
dev_roŸ
, 64);

770 
BTRFS_SETGET_STACK_FUNCS
(
backup_dev_roŸ_gí
, 
båfs_roŸ_backup
,

771 
dev_roŸ_gí
, 64);

772 
BTRFS_SETGET_STACK_FUNCS
(
backup_dev_roŸ_Àvñ
, 
båfs_roŸ_backup
,

773 
dev_roŸ_Àvñ
, 8);

775 
BTRFS_SETGET_STACK_FUNCS
(
backup_csum_roŸ
, 
båfs_roŸ_backup
,

776 
csum_roŸ
, 64);

777 
BTRFS_SETGET_STACK_FUNCS
(
backup_csum_roŸ_gí
, 
båfs_roŸ_backup
,

778 
csum_roŸ_gí
, 64);

779 
BTRFS_SETGET_STACK_FUNCS
(
backup_csum_roŸ_Àvñ
, 
båfs_roŸ_backup
,

780 
csum_roŸ_Àvñ
, 8);

781 
BTRFS_SETGET_STACK_FUNCS
(
backup_tŸÆ_byãs
, 
båfs_roŸ_backup
,

782 
tŸÆ_byãs
, 64);

783 
BTRFS_SETGET_STACK_FUNCS
(
backup_byãs_u£d
, 
båfs_roŸ_backup
,

784 
byãs_u£d
, 64);

785 
BTRFS_SETGET_STACK_FUNCS
(
backup_num_devi˚s
, 
båfs_roŸ_backup
,

786 
num_devi˚s
, 64);

789 
BTRFS_SETGET_FUNCS
(
bÆ™˚_Êags
, 
båfs_bÆ™˚_ôem
, 
Êags
, 64);

791 
ölöe
 
	$båfs_bÆ™˚_d©a
(c⁄° 
exã¡_buf„r
 *
eb
,

792 c⁄° 
båfs_bÆ™˚_ôem
 *
bi
,

793 
båfs_disk_bÆ™˚_¨gs
 *
ba
)

795 
	`ªad_eb_membî
(
eb
, 
bi
, 
båfs_bÆ™˚_ôem
, 
d©a
, 
ba
);

796 
	}
}

798 
ölöe
 
	$båfs_£t_bÆ™˚_d©a
(
exã¡_buf„r
 *
eb
,

799 
båfs_bÆ™˚_ôem
 *
bi
,

800 c⁄° 
båfs_disk_bÆ™˚_¨gs
 *
ba
)

802 
	`wrôe_eb_membî
(
eb
, 
bi
, 
båfs_bÆ™˚_ôem
, 
d©a
, 
ba
);

803 
	}
}

805 
ölöe
 
	$båfs_bÆ™˚_mëa
(c⁄° 
exã¡_buf„r
 *
eb
,

806 c⁄° 
båfs_bÆ™˚_ôem
 *
bi
,

807 
båfs_disk_bÆ™˚_¨gs
 *
ba
)

809 
	`ªad_eb_membî
(
eb
, 
bi
, 
båfs_bÆ™˚_ôem
, 
mëa
, 
ba
);

810 
	}
}

812 
ölöe
 
	$båfs_£t_bÆ™˚_mëa
(
exã¡_buf„r
 *
eb
,

813 
båfs_bÆ™˚_ôem
 *
bi
,

814 c⁄° 
båfs_disk_bÆ™˚_¨gs
 *
ba
)

816 
	`wrôe_eb_membî
(
eb
, 
bi
, 
båfs_bÆ™˚_ôem
, 
mëa
, 
ba
);

817 
	}
}

819 
ölöe
 
	$båfs_bÆ™˚_sys
(c⁄° 
exã¡_buf„r
 *
eb
,

820 c⁄° 
båfs_bÆ™˚_ôem
 *
bi
,

821 
båfs_disk_bÆ™˚_¨gs
 *
ba
)

823 
	`ªad_eb_membî
(
eb
, 
bi
, 
båfs_bÆ™˚_ôem
, 
sys
, 
ba
);

824 
	}
}

826 
ölöe
 
	$båfs_£t_bÆ™˚_sys
(
exã¡_buf„r
 *
eb
,

827 
båfs_bÆ™˚_ôem
 *
bi
,

828 c⁄° 
båfs_disk_bÆ™˚_¨gs
 *
ba
)

830 
	`wrôe_eb_membî
(
eb
, 
bi
, 
båfs_bÆ™˚_ôem
, 
sys
, 
ba
);

831 
	}
}

833 
ölöe
 
	$båfs_disk_bÆ™˚_¨gs_to_˝u
(
båfs_bÆ™˚_¨gs
 *
˝u
,

834 c⁄° 
båfs_disk_bÆ™˚_¨gs
 *
disk
)

836 
	`mem£t
(
˝u
, 0, (*cpu));

838 
˝u
->
¥ofûes
 = 
	`À64_to_˝u
(
disk
->profiles);

839 
˝u
->
ußge
 = 
	`À64_to_˝u
(
disk
->usage);

840 
˝u
->
devid
 = 
	`À64_to_˝u
(
disk
->devid);

841 
˝u
->
p°¨t
 = 
	`À64_to_˝u
(
disk
->pstart);

842 
˝u
->
≥nd
 = 
	`À64_to_˝u
(
disk
->pend);

843 
˝u
->
v°¨t
 = 
	`À64_to_˝u
(
disk
->vstart);

844 
˝u
->
víd
 = 
	`À64_to_˝u
(
disk
->vend);

845 
˝u
->
èrgë
 = 
	`À64_to_˝u
(
disk
->target);

846 
˝u
->
Êags
 = 
	`À64_to_˝u
(
disk
->flags);

847 
˝u
->
limô
 = 
	`À64_to_˝u
(
disk
->limit);

848 
˝u
->
°rùes_mö
 = 
	`À32_to_˝u
(
disk
->stripes_min);

849 
˝u
->
°rùes_max
 = 
	`À32_to_˝u
(
disk
->stripes_max);

850 
	}
}

852 
ölöe
 
	$båfs_˝u_bÆ™˚_¨gs_to_disk
(

853 
båfs_disk_bÆ™˚_¨gs
 *
disk
,

854 c⁄° 
båfs_bÆ™˚_¨gs
 *
˝u
)

856 
	`mem£t
(
disk
, 0, (*disk));

858 
disk
->
¥ofûes
 = 
	`˝u_to_À64
(
˝u
->profiles);

859 
disk
->
ußge
 = 
	`˝u_to_À64
(
˝u
->usage);

860 
disk
->
devid
 = 
	`˝u_to_À64
(
˝u
->devid);

861 
disk
->
p°¨t
 = 
	`˝u_to_À64
(
˝u
->pstart);

862 
disk
->
≥nd
 = 
	`˝u_to_À64
(
˝u
->pend);

863 
disk
->
v°¨t
 = 
	`˝u_to_À64
(
˝u
->vstart);

864 
disk
->
víd
 = 
	`˝u_to_À64
(
˝u
->vend);

865 
disk
->
èrgë
 = 
	`˝u_to_À64
(
˝u
->target);

866 
disk
->
Êags
 = 
	`˝u_to_À64
(
˝u
->flags);

867 
disk
->
limô
 = 
	`˝u_to_À64
(
˝u
->limit);

868 
disk
->
°rùes_mö
 = 
	`˝u_to_À32
(
˝u
->stripes_min);

869 
disk
->
°rùes_max
 = 
	`˝u_to_À32
(
˝u
->stripes_max);

870 
	}
}

873 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_byãƒ
, 
båfs_su≥r_block
, 
byãƒ
, 64);

874 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_Êags
, 
båfs_su≥r_block
, 
Êags
, 64);

875 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_gíî©i⁄
, 
båfs_su≥r_block
,

876 
gíî©i⁄
, 64);

877 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_roŸ
, 
båfs_su≥r_block
, 
roŸ
, 64);

878 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_sys_¨øy_size
,

879 
båfs_su≥r_block
, 
sys_chunk_¨øy_size
, 32);

880 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_chunk_roŸ_gíî©i⁄
,

881 
båfs_su≥r_block
, 
chunk_roŸ_gíî©i⁄
, 64);

882 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_roŸ_Àvñ
, 
båfs_su≥r_block
,

883 
roŸ_Àvñ
, 8);

884 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_chunk_roŸ
, 
båfs_su≥r_block
,

885 
chunk_roŸ
, 64);

886 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_chunk_roŸ_Àvñ
, 
båfs_su≥r_block
,

887 
chunk_roŸ_Àvñ
, 8);

888 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_log_roŸ
, 
båfs_su≥r_block
, 
log_roŸ
, 64);

889 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_log_roŸ_Àvñ
, 
båfs_su≥r_block
,

890 
log_roŸ_Àvñ
, 8);

891 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_tŸÆ_byãs
, 
båfs_su≥r_block
,

892 
tŸÆ_byãs
, 64);

893 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_byãs_u£d
, 
båfs_su≥r_block
,

894 
byãs_u£d
, 64);

895 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_£˘‹size
, 
båfs_su≥r_block
,

896 
£˘‹size
, 32);

897 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_nodesize
, 
båfs_su≥r_block
,

898 
nodesize
, 32);

899 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_°rùesize
, 
båfs_su≥r_block
,

900 
°rùesize
, 32);

901 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_roŸ_dú
, 
båfs_su≥r_block
,

902 
roŸ_dú_obje˘id
, 64);

903 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_num_devi˚s
, 
båfs_su≥r_block
,

904 
num_devi˚s
, 64);

905 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_com∑t_Êags
, 
båfs_su≥r_block
,

906 
com∑t_Êags
, 64);

907 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_com∑t_ro_Êags
, 
båfs_su≥r_block
,

908 
com∑t_ro_Êags
, 64);

909 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_öcom∑t_Êags
, 
båfs_su≥r_block
,

910 
öcom∑t_Êags
, 64);

911 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_csum_ty≥
, 
båfs_su≥r_block
,

912 
csum_ty≥
, 16);

913 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_ˇche_gíî©i⁄
, 
båfs_su≥r_block
,

914 
ˇche_gíî©i⁄
, 64);

915 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_magic
, 
båfs_su≥r_block
, 
magic
, 64);

916 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_uuid_åì_gíî©i⁄
, 
båfs_su≥r_block
,

917 
uuid_åì_gíî©i⁄
, 64);

918 
BTRFS_SETGET_STACK_FUNCS
(
su≥r_ƒ_globÆ_roŸs
, 
båfs_su≥r_block
,

919 
ƒ_globÆ_roŸs
, 64);

922 
BTRFS_SETGET_STACK_FUNCS
(
°ack_fûe_exã¡_ty≥
, 
båfs_fûe_exã¡_ôem
,

923 
ty≥
, 8);

924 
BTRFS_SETGET_STACK_FUNCS
(
°ack_fûe_exã¡_disk_byãƒ
,

925 
båfs_fûe_exã¡_ôem
, 
disk_byãƒ
, 64);

926 
BTRFS_SETGET_STACK_FUNCS
(
°ack_fûe_exã¡_off£t
,

927 
båfs_fûe_exã¡_ôem
, 
off£t
, 64);

928 
BTRFS_SETGET_STACK_FUNCS
(
°ack_fûe_exã¡_gíî©i⁄
,

929 
båfs_fûe_exã¡_ôem
, 
gíî©i⁄
, 64);

930 
BTRFS_SETGET_STACK_FUNCS
(
°ack_fûe_exã¡_num_byãs
,

931 
båfs_fûe_exã¡_ôem
, 
num_byãs
, 64);

932 
BTRFS_SETGET_STACK_FUNCS
(
°ack_fûe_exã¡_øm_byãs
,

933 
båfs_fûe_exã¡_ôem
, 
øm_byãs
, 64);

934 
BTRFS_SETGET_STACK_FUNCS
(
°ack_fûe_exã¡_disk_num_byãs
,

935 
båfs_fûe_exã¡_ôem
, 
disk_num_byãs
, 64);

936 
BTRFS_SETGET_STACK_FUNCS
(
°ack_fûe_exã¡_com¥essi⁄
,

937 
båfs_fûe_exã¡_ôem
, 
com¥essi⁄
, 8);

940 
BTRFS_SETGET_FUNCS
(
fûe_exã¡_ty≥
, 
båfs_fûe_exã¡_ôem
, 
ty≥
, 8);

941 
BTRFS_SETGET_FUNCS
(
fûe_exã¡_disk_byãƒ
, 
båfs_fûe_exã¡_ôem
,

942 
disk_byãƒ
, 64);

943 
BTRFS_SETGET_FUNCS
(
fûe_exã¡_gíî©i⁄
, 
båfs_fûe_exã¡_ôem
,

944 
gíî©i⁄
, 64);

945 
BTRFS_SETGET_FUNCS
(
fûe_exã¡_disk_num_byãs
, 
båfs_fûe_exã¡_ôem
,

946 
disk_num_byãs
, 64);

947 
BTRFS_SETGET_FUNCS
(
fûe_exã¡_off£t
, 
båfs_fûe_exã¡_ôem
,

948 
off£t
, 64);

949 
BTRFS_SETGET_FUNCS
(
fûe_exã¡_num_byãs
, 
båfs_fûe_exã¡_ôem
,

950 
num_byãs
, 64);

951 
BTRFS_SETGET_FUNCS
(
fûe_exã¡_øm_byãs
, 
båfs_fûe_exã¡_ôem
,

952 
øm_byãs
, 64);

953 
BTRFS_SETGET_FUNCS
(
fûe_exã¡_com¥essi⁄
, 
båfs_fûe_exã¡_ôem
,

954 
com¥essi⁄
, 8);

955 
BTRFS_SETGET_FUNCS
(
fûe_exã¡_í¸y±i⁄
, 
båfs_fûe_exã¡_ôem
,

956 
í¸y±i⁄
, 8);

957 
BTRFS_SETGET_FUNCS
(
fûe_exã¡_Ÿhî_ícodög
, 
båfs_fûe_exã¡_ôem
,

958 
Ÿhî_ícodög
, 16);

961 
BTRFS_SETGET_FUNCS
(
qgroup_°©us_gíî©i⁄
, 
båfs_qgroup_°©us_ôem
,

962 
gíî©i⁄
, 64);

963 
BTRFS_SETGET_FUNCS
(
qgroup_°©us_vîsi⁄
, 
båfs_qgroup_°©us_ôem
,

964 
vîsi⁄
, 64);

965 
BTRFS_SETGET_FUNCS
(
qgroup_°©us_Êags
, 
båfs_qgroup_°©us_ôem
,

966 
Êags
, 64);

967 
BTRFS_SETGET_FUNCS
(
qgroup_°©us_ªsˇn
, 
båfs_qgroup_°©us_ôem
,

968 
ªsˇn
, 64);

971 
BTRFS_SETGET_FUNCS
(
qgroup_öfo_gíî©i⁄
, 
båfs_qgroup_öfo_ôem
,

972 
gíî©i⁄
, 64);

973 
BTRFS_SETGET_FUNCS
(
qgroup_öfo_r„r
, 
båfs_qgroup_öfo_ôem
, 
r„r
, 64);

974 
BTRFS_SETGET_FUNCS
(
qgroup_öfo_r„r_cm¥
, 
båfs_qgroup_öfo_ôem
,

975 
r„r_cm¥
, 64);

976 
BTRFS_SETGET_FUNCS
(
qgroup_öfo_ex˛
, 
båfs_qgroup_öfo_ôem
, 
ex˛
, 64);

977 
BTRFS_SETGET_FUNCS
(
qgroup_öfo_ex˛_cm¥
, 
båfs_qgroup_öfo_ôem
,

978 
ex˛_cm¥
, 64);

980 
BTRFS_SETGET_STACK_FUNCS
(
°ack_qgroup_öfo_gíî©i⁄
,

981 
båfs_qgroup_öfo_ôem
, 
gíî©i⁄
, 64);

982 
BTRFS_SETGET_STACK_FUNCS
(
°ack_qgroup_öfo_r„r
, 
båfs_qgroup_öfo_ôem
,

983 
r„r
, 64);

984 
BTRFS_SETGET_STACK_FUNCS
(
°ack_qgroup_öfo_r„r_cm¥
,

985 
båfs_qgroup_öfo_ôem
, 
r„r_cm¥
, 64);

986 
BTRFS_SETGET_STACK_FUNCS
(
°ack_qgroup_öfo_ex˛
, 
båfs_qgroup_öfo_ôem
,

987 
ex˛
, 64);

988 
BTRFS_SETGET_STACK_FUNCS
(
°ack_qgroup_öfo_ex˛_cm¥
,

989 
båfs_qgroup_öfo_ôem
, 
ex˛_cm¥
, 64);

992 
BTRFS_SETGET_FUNCS
(
qgroup_limô_Êags
, 
båfs_qgroup_limô_ôem
, 
Êags
, 64);

993 
BTRFS_SETGET_FUNCS
(
qgroup_limô_max_r„r
, 
båfs_qgroup_limô_ôem
,

994 
max_r„r
, 64);

995 
BTRFS_SETGET_FUNCS
(
qgroup_limô_max_ex˛
, 
båfs_qgroup_limô_ôem
,

996 
max_ex˛
, 64);

997 
BTRFS_SETGET_FUNCS
(
qgroup_limô_rsv_r„r
, 
båfs_qgroup_limô_ôem
,

998 
rsv_r„r
, 64);

999 
BTRFS_SETGET_FUNCS
(
qgroup_limô_rsv_ex˛
, 
båfs_qgroup_limô_ôem
,

1000 
rsv_ex˛
, 64);

1001 
BTRFS_SETGET_STACK_FUNCS
(
°ack_qgroup_limô_Êags
,

1002 
båfs_qgroup_limô_ôem
, 
Êags
, 64);

1003 
BTRFS_SETGET_STACK_FUNCS
(
°ack_qgroup_limô_max_r„r
,

1004 
båfs_qgroup_limô_ôem
, 
max_r„r
, 64);

1005 
BTRFS_SETGET_STACK_FUNCS
(
°ack_qgroup_limô_max_ex˛
,

1006 
båfs_qgroup_limô_ôem
, 
max_ex˛
, 64);

1007 
BTRFS_SETGET_STACK_FUNCS
(
°ack_qgroup_limô_rsv_r„r
,

1008 
båfs_qgroup_limô_ôem
, 
rsv_r„r
, 64);

1009 
BTRFS_SETGET_STACK_FUNCS
(
°ack_qgroup_limô_rsv_ex˛
,

1010 
båfs_qgroup_limô_ôem
, 
rsv_ex˛
, 64);

1013 
BTRFS_SETGET_FUNCS
(
dev_ª∂a˚_§c_devid
,

1014 
båfs_dev_ª∂a˚_ôem
, 
§c_devid
, 64);

1015 
BTRFS_SETGET_FUNCS
(
dev_ª∂a˚_c⁄t_ªadög_‰om_§cdev_mode
,

1016 
båfs_dev_ª∂a˚_ôem
, 
c⁄t_ªadög_‰om_§cdev_mode
,

1018 
BTRFS_SETGET_FUNCS
(
dev_ª∂a˚_ª∂a˚_°©e
, 
båfs_dev_ª∂a˚_ôem
,

1019 
ª∂a˚_°©e
, 64);

1020 
BTRFS_SETGET_FUNCS
(
dev_ª∂a˚_time_°¨ãd
, 
båfs_dev_ª∂a˚_ôem
,

1021 
time_°¨ãd
, 64);

1022 
BTRFS_SETGET_FUNCS
(
dev_ª∂a˚_time_°›≥d
, 
båfs_dev_ª∂a˚_ôem
,

1023 
time_°›≥d
, 64);

1024 
BTRFS_SETGET_FUNCS
(
dev_ª∂a˚_num_wrôe_îr‹s
, 
båfs_dev_ª∂a˚_ôem
,

1025 
num_wrôe_îr‹s
, 64);

1026 
BTRFS_SETGET_FUNCS
(
dev_ª∂a˚_num_unc‹ª˘abÀ_ªad_îr‹s
,

1027 
båfs_dev_ª∂a˚_ôem
, 
num_unc‹ª˘abÀ_ªad_îr‹s
,

1029 
BTRFS_SETGET_FUNCS
(
dev_ª∂a˚_curs‹_À·
, 
båfs_dev_ª∂a˚_ôem
,

1030 
curs‹_À·
, 64);

1031 
BTRFS_SETGET_FUNCS
(
dev_ª∂a˚_curs‹_right
, 
båfs_dev_ª∂a˚_ôem
,

1032 
curs‹_right
, 64);

1034 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dev_ª∂a˚_§c_devid
,

1035 
båfs_dev_ª∂a˚_ôem
, 
§c_devid
, 64);

1036 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dev_ª∂a˚_c⁄t_ªadög_‰om_§cdev_mode
,

1037 
båfs_dev_ª∂a˚_ôem
,

1038 
c⁄t_ªadög_‰om_§cdev_mode
, 64);

1039 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dev_ª∂a˚_ª∂a˚_°©e
,

1040 
båfs_dev_ª∂a˚_ôem
, 
ª∂a˚_°©e
, 64);

1041 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dev_ª∂a˚_time_°¨ãd
,

1042 
båfs_dev_ª∂a˚_ôem
, 
time_°¨ãd
, 64);

1043 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dev_ª∂a˚_time_°›≥d
,

1044 
båfs_dev_ª∂a˚_ôem
, 
time_°›≥d
, 64);

1045 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dev_ª∂a˚_num_wrôe_îr‹s
,

1046 
båfs_dev_ª∂a˚_ôem
, 
num_wrôe_îr‹s
, 64);

1047 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dev_ª∂a˚_num_unc‹ª˘abÀ_ªad_îr‹s
,

1048 
båfs_dev_ª∂a˚_ôem
,

1049 
num_unc‹ª˘abÀ_ªad_îr‹s
, 64);

1050 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dev_ª∂a˚_curs‹_À·
,

1051 
båfs_dev_ª∂a˚_ôem
, 
curs‹_À·
, 64);

1052 
BTRFS_SETGET_STACK_FUNCS
(
°ack_dev_ª∂a˚_curs‹_right
,

1053 
båfs_dev_ª∂a˚_ôem
, 
curs‹_right
, 64);

1056 
BTRFS_SETGET_FUNCS
(
vîôy_des¸ùt‹_í¸y±i⁄
, 
båfs_vîôy_des¸ùt‹_ôem
,

1057 
í¸y±i⁄
, 8);

1058 
BTRFS_SETGET_FUNCS
(
vîôy_des¸ùt‹_size
, 
båfs_vîôy_des¸ùt‹_ôem
,

1059 
size
, 64);

1060 
BTRFS_SETGET_STACK_FUNCS
(
°ack_vîôy_des¸ùt‹_í¸y±i⁄
,

1061 
båfs_vîôy_des¸ùt‹_ôem
, 
í¸y±i⁄
, 8);

1062 
BTRFS_SETGET_STACK_FUNCS
(
°ack_vîôy_des¸ùt‹_size
,

1063 
båfs_vîôy_des¸ùt‹_ôem
, 
size
, 64);

1066 
	#båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
ty≥
) \

1067 ((
ty≥
 *)(
	`båfs_ôem_ƒ_off£t
(
Àaf
, 0Ë+ 
	`båfs_ôem_off£t
÷óf, 
¶Ÿ
)))

	)

1069 
	#båfs_ôem_±r_off£t
(
Àaf
, 
¶Ÿ
) \

1070 (()(
	`båfs_ôem_ƒ_off£t
(
Àaf
, 0Ë+ 
	`båfs_ôem_off£t
÷óf, 
¶Ÿ
)))

	)

	@acl.c

6 
	~<löux/fs.h
>

7 
	~<löux/°rög.h
>

8 
	~<löux/x©å.h
>

9 
	~<löux/posix_a˛_x©å.h
>

10 
	~<löux/posix_a˛.h
>

11 
	~<löux/sched.h
>

12 
	~<löux/sched/mm.h
>

13 
	~<löux/¶ab.h
>

14 
	~"˘ªe.h
"

15 
	~"båfs_öode.h
"

16 
	~"x©å.h
"

17 
	~"a˛.h
"

19 
posix_a˛
 *
	$båfs_gë_a˛
(
öode
 *öode, 
ty≥
, 
boﬁ
 
rcu
)

21 
size
;

22 c⁄° *
«me
;

23 *
vÆue
 = 
NULL
;

24 
posix_a˛
 *
a˛
;

26 i‡(
rcu
)

27  
	`ERR_PTR
(-
ECHILD
);

29 
ty≥
) {

30 
ACL_TYPE_ACCESS
:

31 
«me
 = 
XATTR_NAME_POSIX_ACL_ACCESS
;

33 
ACL_TYPE_DEFAULT
:

34 
«me
 = 
XATTR_NAME_POSIX_ACL_DEFAULT
;

37  
	`ERR_PTR
(-
EINVAL
);

40 
size
 = 
	`båfs_gëx©å
(
öode
, 
«me
, 
NULL
, 0);

41 i‡(
size
 > 0) {

42 
vÆue
 = 
	`kzÆloc
(
size
, 
GFP_KERNEL
);

43 i‡(!
vÆue
)

44  
	`ERR_PTR
(-
ENOMEM
);

45 
size
 = 
	`båfs_gëx©å
(
öode
, 
«me
, 
vÆue
, size);

47 i‡(
size
 > 0)

48 
a˛
 = 
	`posix_a˛_‰om_x©å
(&
öô_u£r_ns
, 
vÆue
, 
size
);

49 i‡(
size
 =-
ENODATA
 || size == 0)

50 
a˛
 = 
NULL
;

52 
a˛
 = 
	`ERR_PTR
(
size
);

53 
	`k‰ì
(
vÆue
);

55  
a˛
;

56 
	}
}

58 
	$__båfs_£t_a˛
(
båfs_å™s_h™dÀ
 *
å™s
, 
öode
 *inode,

59 
posix_a˛
 *
a˛
, 
ty≥
)

61 
ªt
, 
size
 = 0;

62 c⁄° *
«me
;

63 *
vÆue
 = 
NULL
;

65 
ty≥
) {

66 
ACL_TYPE_ACCESS
:

67 
«me
 = 
XATTR_NAME_POSIX_ACL_ACCESS
;

69 
ACL_TYPE_DEFAULT
:

70 i‡(!
	`S_ISDIR
(
öode
->
i_mode
))

71  
a˛
 ? -
EINVAL
 : 0;

72 
«me
 = 
XATTR_NAME_POSIX_ACL_DEFAULT
;

75  -
EINVAL
;

78 i‡(
a˛
) {

79 
nofs_Êag
;

81 
size
 = 
	`posix_a˛_x©å_size
(
a˛
->
a_cou¡
);

86 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

87 
vÆue
 = 
	`kmÆloc
(
size
, 
GFP_KERNEL
);

88 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

89 i‡(!
vÆue
) {

90 
ªt
 = -
ENOMEM
;

91 
out
;

94 
ªt
 = 
	`posix_a˛_to_x©å
(&
öô_u£r_ns
, 
a˛
, 
vÆue
, 
size
);

95 i‡(
ªt
 < 0)

96 
out
;

99 i‡(
å™s
)

100 
ªt
 = 
	`båfs_£tx©å
(
å™s
, 
öode
, 
«me
, 
vÆue
, 
size
, 0);

102 
ªt
 = 
	`båfs_£tx©å_å™s
(
öode
, 
«me
, 
vÆue
, 
size
, 0);

104 
out
:

105 
	`k‰ì
(
vÆue
);

107 i‡(!
ªt
)

108 
	`£t_ˇched_a˛
(
öode
, 
ty≥
, 
a˛
);

110  
ªt
;

111 
	}
}

113 
	$båfs_£t_a˛
(
m¡_idm≠
 *
idm≠
, 
díåy
 *dentry,

114 
posix_a˛
 *
a˛
, 
ty≥
)

116 
ªt
;

117 
öode
 *öodê
	`d_öode
(
díåy
);

118 
umode_t
 
ﬁd_mode
 = 
öode
->
i_mode
;

120 i‡(
ty≥
 =
ACL_TYPE_ACCESS
 && 
a˛
) {

121 
ªt
 = 
	`posix_a˛_upd©e_mode
(
idm≠
, 
öode
,

122 &
öode
->
i_mode
, &
a˛
);

123 i‡(
ªt
)

124  
ªt
;

126 
ªt
 = 
	`__båfs_£t_a˛
(
NULL
, 
öode
, 
a˛
, 
ty≥
);

127 i‡(
ªt
)

128 
öode
->
i_mode
 = 
ﬁd_mode
;

129  
ªt
;

130 
	}
}

	@acl.h

3 #i‚de‡
BTRFS_ACL_H


4 
	#BTRFS_ACL_H


	)

6 #ifde‡
CONFIG_BTRFS_FS_POSIX_ACL


8 
posix_a˛
 *
båfs_gë_a˛
(
öode
 *öode, 
ty≥
, 
boﬁ
 
rcu
);

9 
båfs_£t_a˛
(
m¡_idm≠
 *
idm≠
, 
díåy
 *dentry,

10 
posix_a˛
 *
a˛
, 
ty≥
);

11 
__båfs_£t_a˛
(
båfs_å™s_h™dÀ
 *
å™s
, 
öode
 *inode,

12 
posix_a˛
 *
a˛
, 
ty≥
);

16 
	#båfs_gë_a˛
 
NULL


	)

17 
	#båfs_£t_a˛
 
NULL


	)

18 
ölöe
 
	$__båfs_£t_a˛
(
båfs_å™s_h™dÀ
 *
å™s
,

19 
öode
 *öode, 
posix_a˛
 *
a˛
,

20 
ty≥
)

22  -
EOPNOTSUPP
;

23 
	}
}

	@async-thread.c

7 
	~<löux/kthªad.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/li°.h
>

10 
	~<löux/•ölock.h
>

11 
	~<löux/‰ìzî.h
>

12 
	~"async-thªad.h
"

13 
	~"˘ªe.h
"

16 
	mWORK_DONE_BIT
,

17 
	mWORK_ORDER_DONE_BIT
,

20 
	#NO_THRESHOLD
 (-1)

	)

21 
	#DFT_THRESHOLD
 (32)

	)

23 
	sbåfs_w‹kqueue
 {

24 
w‹kqueue_°ru˘
 *
	mn‹mÆ_wq
;

27 
båfs_fs_öfo
 *
	mfs_öfo
;

30 
li°_hód
 
	m‹dîed_li°
;

33 
•ölock_t
 
	mli°_lock
;

36 
©omic_t
 
	m≥ndög
;

39 
	mlimô_a˘ive
;

42 
	mcuºít_a˘ive
;

45 
	mthªsh
;

46 
	mcou¡
;

47 
•ölock_t
 
	mthªs_lock
;

50 
båfs_fs_öfo
 * 
__puª
 
	$båfs_w‹kqueue_ow√r
(c⁄° 
båfs_w‹kqueue
 *
wq
)

52  
wq
->
fs_öfo
;

53 
	}
}

55 
båfs_fs_öfo
 * 
__puª
 
	$båfs_w‹k_ow√r
(c⁄° 
båfs_w‹k
 *
w‹k
)

57  
w‹k
->
wq
->
fs_öfo
;

58 
	}
}

60 
boﬁ
 
	$båfs_w‹kqueue_n‹mÆ_c⁄ge°ed
(c⁄° 
båfs_w‹kqueue
 *
wq
)

68 i‡(
wq
->
thªsh
 =
NO_THRESHOLD
)

69  
Ál£
;

71  
	`©omic_ªad
(&
wq
->
≥ndög
Ë> wq->
thªsh
 * 2;

72 
	}
}

74 
	$båfs_öô_w‹kqueue
(
båfs_w‹kqueue
 *
wq
,

75 
båfs_fs_öfo
 *
fs_öfo
)

77 
wq
->
fs_öfo
 = fs_info;

78 
	`©omic_£t
(&
wq
->
≥ndög
, 0);

79 
	`INIT_LIST_HEAD
(&
wq
->
‹dîed_li°
);

80 
	`•ö_lock_öô
(&
wq
->
li°_lock
);

81 
	`•ö_lock_öô
(&
wq
->
thªs_lock
);

82 
	}
}

84 
båfs_w‹kqueue
 *
	$båfs_Æloc_w‹kqueue
(
båfs_fs_öfo
 *
fs_öfo
,

85 c⁄° *
«me
, 
Êags
,

86 
limô_a˘ive
, 
thªsh
)

88 
båfs_w‹kqueue
 *
ªt
 = 
	`kzÆloc
((*ªt), 
GFP_KERNEL
);

90 i‡(!
ªt
)

91  
NULL
;

93 
	`båfs_öô_w‹kqueue
(
ªt
, 
fs_öfo
);

95 
ªt
->
limô_a˘ive
 =Üimit_active;

96 i‡(
thªsh
 == 0)

97 
thªsh
 = 
DFT_THRESHOLD
;

99 i‡(
thªsh
 < 
DFT_THRESHOLD
) {

100 
ªt
->
cuºít_a˘ive
 = 
limô_a˘ive
;

101 
ªt
->
thªsh
 = 
NO_THRESHOLD
;

108 
ªt
->
cuºít_a˘ive
 = 1;

109 
ªt
->
thªsh
 =Åhresh;

112 
ªt
->
n‹mÆ_wq
 = 
	`Æloc_w‹kqueue
("båfs-%s", 
Êags
,Ñë->
cuºít_a˘ive
,

113 
«me
);

114 i‡(!
ªt
->
n‹mÆ_wq
) {

115 
	`k‰ì
(
ªt
);

116  
NULL
;

119 
	`åa˚_båfs_w‹kqueue_Æloc
(
ªt
, 
«me
);

120  
ªt
;

121 
	}
}

123 
båfs_w‹kqueue
 *
	$båfs_Æloc_‹dîed_w‹kqueue
(

124 
båfs_fs_öfo
 *
fs_öfo
, c⁄° *
«me
,

125 
Êags
)

127 
båfs_w‹kqueue
 *
ªt
;

129 
ªt
 = 
	`kzÆloc
((*ªt), 
GFP_KERNEL
);

130 i‡(!
ªt
)

131  
NULL
;

133 
	`båfs_öô_w‹kqueue
(
ªt
, 
fs_öfo
);

136 
ªt
->
limô_a˘ive
 = 1;

137 
ªt
->
cuºít_a˘ive
 = 1;

138 
ªt
->
thªsh
 = 
NO_THRESHOLD
;

140 
ªt
->
n‹mÆ_wq
 = 
	`Æloc_‹dîed_w‹kqueue
("båfs-%s", 
Êags
, 
«me
);

141 i‡(!
ªt
->
n‹mÆ_wq
) {

142 
	`k‰ì
(
ªt
);

143  
NULL
;

146 
	`åa˚_båfs_w‹kqueue_Æloc
(
ªt
, 
«me
);

147  
ªt
;

148 
	}
}

155 
ölöe
 
	$thªsh_queue_hook
(
båfs_w‹kqueue
 *
wq
)

157 i‡(
wq
->
thªsh
 =
NO_THRESHOLD
)

159 
	`©omic_öc
(&
wq
->
≥ndög
);

160 
	}
}

167 
ölöe
 
	$thªsh_exec_hook
(
båfs_w‹kqueue
 *
wq
)

169 
√w_cuºít_a˘ive
;

170 
≥ndög
;

171 
√ed_ch™ge
 = 0;

173 i‡(
wq
->
thªsh
 =
NO_THRESHOLD
)

176 
	`©omic_dec
(&
wq
->
≥ndög
);

177 
	`•ö_lock
(&
wq
->
thªs_lock
);

182 
wq
->
cou¡
++;

183 
wq
->
cou¡
 %(wq->
thªsh
 / 4);

184 i‡(!
wq
->
cou¡
)

185 
out
;

186 
√w_cuºít_a˘ive
 = 
wq
->
cuºít_a˘ive
;

192 
≥ndög
 = 
	`©omic_ªad
(&
wq
->pending);

193 i‡(
≥ndög
 > 
wq
->
thªsh
)

194 
√w_cuºít_a˘ive
++;

195 i‡(
≥ndög
 < 
wq
->
thªsh
 / 2)

196 
√w_cuºít_a˘ive
--;

197 
√w_cuºít_a˘ive
 = 
	`˛amp_vÆ
“ew_cuºít_a˘ive, 1, 
wq
->
limô_a˘ive
);

198 i‡(
√w_cuºít_a˘ive
 !
wq
->
cuºít_a˘ive
) {

199 
√ed_ch™ge
 = 1;

200 
wq
->
cuºít_a˘ive
 = 
√w_cuºít_a˘ive
;

202 
out
:

203 
	`•ö_u∆ock
(&
wq
->
thªs_lock
);

205 i‡(
√ed_ch™ge
) {

206 
	`w‹kqueue_£t_max_a˘ive
(
wq
->
n‹mÆ_wq
, wq->
cuºít_a˘ive
);

208 
	}
}

210 
	$run_‹dîed_w‹k
(
båfs_w‹kqueue
 *
wq
,

211 
båfs_w‹k
 *
£lf
)

213 
li°_hód
 *
li°
 = &
wq
->
‹dîed_li°
;

214 
båfs_w‹k
 *
w‹k
;

215 
•ölock_t
 *
lock
 = &
wq
->
li°_lock
;

216 
Êags
;

217 
boﬁ
 
‰ì_£lf
 = 
Ál£
;

220 
	`•ö_lock_úqßve
(
lock
, 
Êags
);

221 i‡(
	`li°_em±y
(
li°
))

223 
w‹k
 = 
	`li°_íåy
(
li°
->
√xt
, 
båfs_w‹k
,

224 
‹dîed_li°
);

225 i‡(!
	`ã°_bô
(
WORK_DONE_BIT
, &
w‹k
->
Êags
))

233 
	`smp_rmb
();

241 i‡(
	`ã°_™d_£t_bô
(
WORK_ORDER_DONE_BIT
, &
w‹k
->
Êags
))

243 
	`åa˚_båfs_‹dîed_sched
(
w‹k
);

244 
	`•ö_u∆ock_úqª°‹e
(
lock
, 
Êags
);

245 
w‹k
->
	`‹dîed_func
(work);

248 
	`•ö_lock_úqßve
(
lock
, 
Êags
);

249 
	`li°_dñ
(&
w‹k
->
‹dîed_li°
);

250 
	`•ö_u∆ock_úqª°‹e
(
lock
, 
Êags
);

252 i‡(
w‹k
 =
£lf
) {

274 
‰ì_£lf
 = 
åue
;

280 
w‹k
->
	`‹dîed_‰ì
(work);

282 
	`åa˚_båfs_Æl_w‹k_d⁄e
(
wq
->
fs_öfo
, 
w‹k
);

285 
	`•ö_u∆ock_úqª°‹e
(
lock
, 
Êags
);

287 i‡(
‰ì_£lf
) {

288 
£lf
->
	`‹dîed_‰ì
(self);

290 
	`åa˚_båfs_Æl_w‹k_d⁄e
(
wq
->
fs_öfo
, 
£lf
);

292 
	}
}

294 
	$båfs_w‹k_hñ≥r
(
w‹k_°ru˘
 *
n‹mÆ_w‹k
)

296 
båfs_w‹k
 *
w‹k
 = 
	`c⁄èöî_of
(
n‹mÆ_w‹k
, btrfs_work,

297 
n‹mÆ_w‹k
);

298 
båfs_w‹kqueue
 *
wq
 = 
w‹k
->wq;

299 
√ed_‹dî
 = 0;

309 i‡(
w‹k
->
‹dîed_func
)

310 
√ed_‹dî
 = 1;

312 
	`åa˚_båfs_w‹k_sched
(
w‹k
);

313 
	`thªsh_exec_hook
(
wq
);

314 
w‹k
->
	`func
(work);

315 i‡(
√ed_‹dî
) {

322 
	`smp_mb__bef‹e_©omic
();

323 
	`£t_bô
(
WORK_DONE_BIT
, &
w‹k
->
Êags
);

324 
	`run_‹dîed_w‹k
(
wq
, 
w‹k
);

327 
	`åa˚_båfs_Æl_w‹k_d⁄e
(
wq
->
fs_öfo
, 
w‹k
);

329 
	}
}

331 
	$båfs_öô_w‹k
(
båfs_w‹k
 *
w‹k
, 
båfs_func_t
 
func
,

332 
båfs_func_t
 
‹dîed_func
, båfs_func_à
‹dîed_‰ì
)

334 
w‹k
->
func
 = func;

335 
w‹k
->
‹dîed_func
 = ordered_func;

336 
w‹k
->
‹dîed_‰ì
 = ordered_free;

337 
	`INIT_WORK
(&
w‹k
->
n‹mÆ_w‹k
, 
båfs_w‹k_hñ≥r
);

338 
	`INIT_LIST_HEAD
(&
w‹k
->
‹dîed_li°
);

339 
w‹k
->
Êags
 = 0;

340 
	}
}

342 
	$båfs_queue_w‹k
(
båfs_w‹kqueue
 *
wq
, 
båfs_w‹k
 *
w‹k
)

344 
Êags
;

346 
w‹k
->
wq
 = wq;

347 
	`thªsh_queue_hook
(
wq
);

348 i‡(
w‹k
->
‹dîed_func
) {

349 
	`•ö_lock_úqßve
(&
wq
->
li°_lock
, 
Êags
);

350 
	`li°_add_èû
(&
w‹k
->
‹dîed_li°
, &
wq
->ordered_list);

351 
	`•ö_u∆ock_úqª°‹e
(&
wq
->
li°_lock
, 
Êags
);

353 
	`åa˚_båfs_w‹k_queued
(
w‹k
);

354 
	`queue_w‹k
(
wq
->
n‹mÆ_wq
, &
w‹k
->
n‹mÆ_w‹k
);

355 
	}
}

357 
	$båfs_de°roy_w‹kqueue
(
båfs_w‹kqueue
 *
wq
)

359 i‡(!
wq
)

361 
	`de°roy_w‹kqueue
(
wq
->
n‹mÆ_wq
);

362 
	`åa˚_båfs_w‹kqueue_de°roy
(
wq
);

363 
	`k‰ì
(
wq
);

364 
	}
}

366 
	$båfs_w‹kqueue_£t_max
(
båfs_w‹kqueue
 *
wq
, 
limô_a˘ive
)

368 i‡(
wq
)

369 
wq
->
limô_a˘ive
 =Üimit_active;

370 
	}
}

372 
	$båfs_Êush_w‹kqueue
(
båfs_w‹kqueue
 *
wq
)

374 
	`Êush_w‹kqueue
(
wq
->
n‹mÆ_wq
);

375 
	}
}

	@async-thread.h

7 #i‚de‡
BTRFS_ASYNC_THREAD_H


8 
	#BTRFS_ASYNC_THREAD_H


	)

10 
	~<löux/w‹kqueue.h
>

12 
	gbåfs_fs_öfo
;

13 
	gbåfs_w‹kqueue
;

14 
	gbåfs_w‹k
;

15 (*
	tbåfs_func_t
)(
	tbåfs_w‹k
 *
	t¨g
);

17 
	sbåfs_w‹k
 {

18 
båfs_func_t
 
func
;

19 
båfs_func_t
 
‹dîed_func
;

20 
båfs_func_t
 
‹dîed_‰ì
;

23 
w‹k_°ru˘
 
n‹mÆ_w‹k
;

24 
li°_hód
 
‹dîed_li°
;

25 
båfs_w‹kqueue
 *
wq
;

26 
Êags
;

29 
båfs_w‹kqueue
 *
	`båfs_Æloc_w‹kqueue
(
båfs_fs_öfo
 *
fs_öfo
,

30 c⁄° *
«me
,

31 
Êags
,

32 
limô_a˘ive
,

33 
thªsh
);

34 
båfs_w‹kqueue
 *
	`båfs_Æloc_‹dîed_w‹kqueue
(

35 
båfs_fs_öfo
 *
fs_öfo
, c⁄° *
«me
,

36 
Êags
);

37 
	`båfs_öô_w‹k
(
båfs_w‹k
 *
w‹k
, 
båfs_func_t
 
func
,

38 
båfs_func_t
 
‹dîed_func
, båfs_func_à
‹dîed_‰ì
);

39 
	`båfs_queue_w‹k
(
båfs_w‹kqueue
 *
wq
,

40 
båfs_w‹k
 *
w‹k
);

41 
	`båfs_de°roy_w‹kqueue
(
båfs_w‹kqueue
 *
wq
);

42 
	`båfs_w‹kqueue_£t_max
(
båfs_w‹kqueue
 *
wq
, 
max
);

43 
båfs_fs_öfo
 * 
__puª
 
	`båfs_w‹k_ow√r
(c⁄° 
båfs_w‹k
 *
w‹k
);

44 
båfs_fs_öfo
 * 
__puª
 
	`båfs_w‹kqueue_ow√r
(c⁄° 
båfs_w‹kqueue
 *
wq
);

45 
boﬁ
 
	`båfs_w‹kqueue_n‹mÆ_c⁄ge°ed
(c⁄° 
båfs_w‹kqueue
 *
wq
);

46 
	`båfs_Êush_w‹kqueue
(
båfs_w‹kqueue
 *
wq
);

	@backref.c

6 
	~<löux/mm.h
>

7 
	~<löux/rbåì.h
>

8 
	~<åa˚/evíts/båfs.h
>

9 
	~"˘ªe.h
"

10 
	~"disk-io.h
"

11 
	~"backªf.h
"

12 
	~"uli°.h
"

13 
	~"å™ß˘i⁄.h
"

14 
	~"dñayed-ªf.h
"

15 
	~"lockög.h
"

16 
	~"misc.h
"

17 
	~"åì-mod-log.h
"

18 
	~"fs.h
"

19 
	~"ac˚ss‹s.h
"

20 
	~"exã¡-åì.h
"

21 
	~"ªloˇti⁄.h
"

22 
	~"åì-checkî.h
"

25 
	#BACKREF_FOUND_SHARED
 6

	)

26 
	#BACKREF_FOUND_NOT_SHARED
 7

	)

28 
	sexã¡_öode_ñem
 {

29 
u64
 
	möum
;

30 
u64
 
	moff£t
;

31 
u64
 
	mnum_byãs
;

32 
exã¡_öode_ñem
 *
	m√xt
;

35 
	$check_exã¡_ö_eb
(
båfs_backªf_wÆk_˘x
 *
˘x
,

36 c⁄° 
båfs_key
 *
key
,

37 c⁄° 
exã¡_buf„r
 *
eb
,

38 c⁄° 
båfs_fûe_exã¡_ôem
 *
fi
,

39 
exã¡_öode_ñem
 **
eõ
)

41 c⁄° 
u64
 
d©a_Àn
 = 
	`båfs_fûe_exã¡_num_byãs
(
eb
, 
fi
);

42 
u64
 
off£t
 = 
key
->offset;

43 
exã¡_öode_ñem
 *
e
;

44 c⁄° 
u64
 *
roŸ_ids
;

45 
roŸ_cou¡
;

46 
boﬁ
 
ˇched
;

48 i‡(!
˘x
->
ign‹e_exã¡_ôem_pos
 &&

49 !
	`båfs_fûe_exã¡_com¥essi⁄
(
eb
, 
fi
) &&

50 !
	`båfs_fûe_exã¡_í¸y±i⁄
(
eb
, 
fi
) &&

51 !
	`båfs_fûe_exã¡_Ÿhî_ícodög
(
eb
, 
fi
)) {

52 
u64
 
d©a_off£t
;

54 
d©a_off£t
 = 
	`båfs_fûe_exã¡_off£t
(
eb
, 
fi
);

56 i‡(
˘x
->
exã¡_ôem_pos
 < 
d©a_off£t
 ||

57 
˘x
->
exã¡_ôem_pos
 >
d©a_off£t
 + 
d©a_Àn
)

59 
off£t
 +
˘x
->
exã¡_ôem_pos
 - 
d©a_off£t
;

62 i‡(!
˘x
->
ödúe˘_ªf_ôî©‹
 || !˘x->
ˇche_lookup
)

63 
add_öode_ñem
;

65 
ˇched
 = 
˘x
->
	`ˇche_lookup
(
eb
->
°¨t
, ctx->
u£r_˘x
, &
roŸ_ids
,

66 &
roŸ_cou¡
);

67 i‡(!
ˇched
)

68 
add_öode_ñem
;

70 
i
 = 0; i < 
roŸ_cou¡
; i++) {

71 
ªt
;

73 
ªt
 = 
˘x
->
	`ödúe˘_ªf_ôî©‹
(
key
->
obje˘id
, 
off£t
,

74 
d©a_Àn
, 
roŸ_ids
[
i
],

75 
˘x
->
u£r_˘x
);

76 i‡(
ªt
)

77  
ªt
;

80 
add_öode_ñem
:

81 
e
 = 
	`kmÆloc
((*e), 
GFP_NOFS
);

82 i‡(!
e
)

83  -
ENOMEM
;

85 
e
->
√xt
 = *
eõ
;

86 
e
->
öum
 = 
key
->
obje˘id
;

87 
e
->
off£t
 = offset;

88 
e
->
num_byãs
 = 
d©a_Àn
;

89 *
eõ
 = 
e
;

92 
	}
}

94 
	$‰ì_öode_ñem_li°
(
exã¡_öode_ñem
 *
eõ
)

96 
exã¡_öode_ñem
 *
eõ_√xt
;

98 ; 
eõ
;Éõ = 
eõ_√xt
) {

99 
eõ_√xt
 = 
eõ
->
√xt
;

100 
	`k‰ì
(
eõ
);

102 
	}
}

104 
	$föd_exã¡_ö_eb
(
båfs_backªf_wÆk_˘x
 *
˘x
,

105 c⁄° 
exã¡_buf„r
 *
eb
,

106 
exã¡_öode_ñem
 **
eõ
)

108 
u64
 
disk_byã
;

109 
båfs_key
 
key
;

110 
båfs_fûe_exã¡_ôem
 *
fi
;

111 
¶Ÿ
;

112 
ƒôems
;

113 
exã¡_ty≥
;

114 
ªt
;

121 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
eb
);

122 
¶Ÿ
 = 0; slŸ < 
ƒôems
; ++slot) {

123 
	`båfs_ôem_key_to_˝u
(
eb
, &
key
, 
¶Ÿ
);

124 i‡(
key
.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

126 
fi
 = 
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
, 
båfs_fûe_exã¡_ôem
);

127 
exã¡_ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
eb
, 
fi
);

128 i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
)

131 
disk_byã
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
eb
, 
fi
);

132 i‡(
disk_byã
 !
˘x
->
byãƒ
)

135 
ªt
 = 
	`check_exã¡_ö_eb
(
˘x
, &
key
, 
eb
, 
fi
, 
eõ
);

136 i‡(
ªt
 =
BTRFS_ITERATE_EXTENT_INODES_STOP
 ||Ñet < 0)

137  
ªt
;

141 
	}
}

143 
	s¥e·ªe
 {

144 
rb_roŸ_ˇched
 
	mroŸ
;

145 
	mcou¡
;

148 
	#PREFTREE_INIT
 { .
roŸ
 = 
RB_ROOT_CACHED
, .
cou¡
 = 0 }

	)

150 
	s¥e·ªes
 {

151 
¥e·ªe
 
	mdúe˘
;

152 
¥e·ªe
 
	mödúe˘
;

153 
¥e·ªe
 
	mödúe˘_missög_keys
;

164 
	ssh¨e_check
 {

165 
båfs_backªf_sh¨e_check_˘x
 *
	m˘x
;

166 
båfs_roŸ
 *
	mroŸ
;

167 
u64
 
	möum
;

168 
u64
 
	md©a_byãƒ
;

169 
u64
 
	md©a_exã¡_gí
;

176 
	msh¨e_cou¡
;

187 
	m£lf_ªf_cou¡
;

188 
boﬁ
 
	mhave_dñayed_dñëe_ªfs
;

191 
ölöe
 
	$exã¡_is_sh¨ed
(
sh¨e_check
 *
sc
)

193  (
sc
 && sc->
sh¨e_cou¡
 > 1Ë? 
BACKREF_FOUND_SHARED
 : 0;

194 
	}
}

196 
kmem_ˇche
 *
	gbåfs_¥ñim_ªf_ˇche
;

198 
__öô
 
	$båfs_¥ñim_ªf_öô
()

200 
båfs_¥ñim_ªf_ˇche
 = 
	`kmem_ˇche_¸óã
("btrfs_prelim_ref",

201 (
¥ñim_ªf
),

203 
SLAB_MEM_SPREAD
,

204 
NULL
);

205 i‡(!
båfs_¥ñim_ªf_ˇche
)

206  -
ENOMEM
;

208 
	}
}

210 
__cﬁd
 
	$båfs_¥ñim_ªf_exô
()

212 
	`kmem_ˇche_de°roy
(
båfs_¥ñim_ªf_ˇche
);

213 
	}
}

215 
	$‰ì_¥ef
(
¥ñim_ªf
 *
ªf
)

217 
	`kmem_ˇche_‰ì
(
båfs_¥ñim_ªf_ˇche
, 
ªf
);

218 
	}
}

225 
	$¥ñim_ªf_com∑ª
(
¥ñim_ªf
 *
ªf1
,

226 
¥ñim_ªf
 *
ªf2
)

228 i‡(
ªf1
->
Àvñ
 < 
ªf2
->level)

230 i‡(
ªf1
->
Àvñ
 > 
ªf2
->level)

232 i‡(
ªf1
->
roŸ_id
 < 
ªf2
->root_id)

234 i‡(
ªf1
->
roŸ_id
 > 
ªf2
->root_id)

236 i‡(
ªf1
->
key_f‹_£¨ch
.
ty≥
 < 
ªf2
->key_for_search.type)

238 i‡(
ªf1
->
key_f‹_£¨ch
.
ty≥
 > 
ªf2
->key_for_search.type)

240 i‡(
ªf1
->
key_f‹_£¨ch
.
obje˘id
 < 
ªf2
->key_for_search.objectid)

242 i‡(
ªf1
->
key_f‹_£¨ch
.
obje˘id
 > 
ªf2
->key_for_search.objectid)

244 i‡(
ªf1
->
key_f‹_£¨ch
.
off£t
 < 
ªf2
->key_for_search.offset)

246 i‡(
ªf1
->
key_f‹_£¨ch
.
off£t
 > 
ªf2
->key_for_search.offset)

248 i‡(
ªf1
->
∑ª¡
 < 
ªf2
->parent)

250 i‡(
ªf1
->
∑ª¡
 > 
ªf2
->parent)

254 
	}
}

256 
	$upd©e_sh¨e_cou¡
(
sh¨e_check
 *
sc
, 
ﬁdcou¡
,

257 
√wcou¡
, 
¥ñim_ªf
 *
√wªf
)

259 i‡((!
sc
Ë|| (
ﬁdcou¡
 =0 && 
√wcou¡
 < 1))

262 i‡(
ﬁdcou¡
 > 0 && 
√wcou¡
 < 1)

263 
sc
->
sh¨e_cou¡
--;

264 i‡(
ﬁdcou¡
 < 1 && 
√wcou¡
 > 0)

265 
sc
->
sh¨e_cou¡
++;

267 i‡(
√wªf
->
roŸ_id
 =
sc
->
roŸ
->
roŸ_key
.
obje˘id
 &&

268 
√wªf
->
w™ãd_disk_byã
 =
sc
->
d©a_byãƒ
 &&

269 
√wªf
->
key_f‹_£¨ch
.
obje˘id
 =
sc
->
öum
)

270 
sc
->
£lf_ªf_cou¡
 +
√wªf
->
cou¡
;

271 
	}
}

278 
	$¥ñim_ªf_ö£π
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

279 
¥e·ªe
 *preftree,

280 
¥ñim_ªf
 *
√wªf
,

281 
sh¨e_check
 *
sc
)

283 
rb_roŸ_ˇched
 *
roŸ
;

284 
rb_node
 **
p
;

285 
rb_node
 *
∑ª¡
 = 
NULL
;

286 
¥ñim_ªf
 *
ªf
;

287 
ªsu…
;

288 
boﬁ
 
À·mo°
 = 
åue
;

290 
roŸ
 = &
¥e·ªe
->root;

291 
p
 = &
roŸ
->
rb_roŸ
.
rb_node
;

293 *
p
) {

294 
∑ª¡
 = *
p
;

295 
ªf
 = 
	`rb_íåy
(
∑ª¡
, 
¥ñim_ªf
, 
rbnode
);

296 
ªsu…
 = 
	`¥ñim_ªf_com∑ª
(
ªf
, 
√wªf
);

297 i‡(
ªsu…
 < 0) {

298 
p
 = &(*p)->
rb_À·
;

299 } i‡(
ªsu…
 > 0) {

300 
p
 = &(*p)->
rb_right
;

301 
À·mo°
 = 
Ál£
;

304 
exã¡_öode_ñem
 *
eõ
 = 
ªf
->
öode_li°
;

306 
eõ
 &&Éõ->
√xt
)

307 
eõ
 =Éõ->
√xt
;

309 i‡(!
eõ
)

310 
ªf
->
öode_li°
 = 
√wªf
->inode_list;

312 
eõ
->
√xt
 = 
√wªf
->
öode_li°
;

313 
	`åa˚_båfs_¥ñim_ªf_mîge
(
fs_öfo
, 
ªf
, 
√wªf
,

314 
¥e·ªe
->
cou¡
);

320 
	`upd©e_sh¨e_cou¡
(
sc
, 
ªf
->
cou¡
,

321 
ªf
->
cou¡
 + 
√wªf
->count,Çewref);

322 
ªf
->
cou¡
 +
√wªf
->count;

323 
	`‰ì_¥ef
(
√wªf
);

328 
	`upd©e_sh¨e_cou¡
(
sc
, 0, 
√wªf
->
cou¡
,Çewref);

329 
¥e·ªe
->
cou¡
++;

330 
	`åa˚_båfs_¥ñim_ªf_ö£π
(
fs_öfo
, 
√wªf
, 
NULL
, 
¥e·ªe
->
cou¡
);

331 
	`rb_lök_node
(&
√wªf
->
rbnode
, 
∑ª¡
, 
p
);

332 
	`rb_ö£π_cﬁ‹_ˇched
(&
√wªf
->
rbnode
, 
roŸ
, 
À·mo°
);

333 
	}
}

339 
	$¥ñim_ªÀa£
(
¥e·ªe
 *preftree)

341 
¥ñim_ªf
 *
ªf
, *
√xt_ªf
;

343 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
ªf
, 
√xt_ªf
,

344 &
¥e·ªe
->
roŸ
.
rb_roŸ
, 
rbnode
) {

345 
	`‰ì_öode_ñem_li°
(
ªf
->
öode_li°
);

346 
	`‰ì_¥ef
(
ªf
);

349 
¥e·ªe
->
roŸ
 = 
RB_ROOT_CACHED
;

350 
¥e·ªe
->
cou¡
 = 0;

351 
	}
}

391 
	$add_¥ñim_ªf
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

392 
¥e·ªe
 *¥e·ªe, 
u64
 
roŸ_id
,

393 c⁄° 
båfs_key
 *
key
, 
Àvñ
, 
u64
 
∑ª¡
,

394 
u64
 
w™ãd_disk_byã
, 
cou¡
,

395 
sh¨e_check
 *
sc
, 
gÂ_t
 
gÂ_mask
)

397 
¥ñim_ªf
 *
ªf
;

399 i‡(
roŸ_id
 =
BTRFS_DATA_RELOC_TREE_OBJECTID
)

402 
ªf
 = 
	`kmem_ˇche_Æloc
(
båfs_¥ñim_ªf_ˇche
, 
gÂ_mask
);

403 i‡(!
ªf
)

404  -
ENOMEM
;

406 
ªf
->
roŸ_id
 =Ñoot_id;

407 i‡(
key
)

408 
ªf
->
key_f‹_£¨ch
 = *
key
;

410 
	`mem£t
(&
ªf
->
key_f‹_£¨ch
, 0, (ref->key_for_search));

412 
ªf
->
öode_li°
 = 
NULL
;

413 
ªf
->
Àvñ
 =Üevel;

414 
ªf
->
cou¡
 = count;

415 
ªf
->
∑ª¡
 =Öarent;

416 
ªf
->
w™ãd_disk_byã
 = wanted_disk_byte;

417 
	`¥ñim_ªf_ö£π
(
fs_öfo
, 
¥e·ªe
, 
ªf
, 
sc
);

418  
	`exã¡_is_sh¨ed
(
sc
);

419 
	}
}

422 
	$add_dúe˘_ªf
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

423 
¥e·ªes
 *¥e·ªes, 
Àvñ
, 
u64
 
∑ª¡
,

424 
u64
 
w™ãd_disk_byã
, 
cou¡
,

425 
sh¨e_check
 *
sc
, 
gÂ_t
 
gÂ_mask
)

427  
	`add_¥ñim_ªf
(
fs_öfo
, &
¥e·ªes
->
dúe˘
, 0, 
NULL
, 
Àvñ
,

428 
∑ª¡
, 
w™ãd_disk_byã
, 
cou¡
, 
sc
, 
gÂ_mask
);

429 
	}
}

432 
	$add_ödúe˘_ªf
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

433 
¥e·ªes
 *¥e·ªes, 
u64
 
roŸ_id
,

434 c⁄° 
båfs_key
 *
key
, 
Àvñ
,

435 
u64
 
w™ãd_disk_byã
, 
cou¡
,

436 
sh¨e_check
 *
sc
, 
gÂ_t
 
gÂ_mask
)

438 
¥e·ªe
 *
åì
 = &
¥e·ªes
->
ödúe˘
;

440 i‡(!
key
)

441 
åì
 = &
¥e·ªes
->
ödúe˘_missög_keys
;

442  
	`add_¥ñim_ªf
(
fs_öfo
, 
åì
, 
roŸ_id
, 
key
, 
Àvñ
, 0,

443 
w™ãd_disk_byã
, 
cou¡
, 
sc
, 
gÂ_mask
);

444 
	}
}

446 
	$is_sh¨ed_d©a_backªf
(
¥e·ªes
 *¥e·ªes, 
u64
 
byãƒ
)

448 
rb_node
 **
p
 = &
¥e·ªes
->
dúe˘
.
roŸ
.
rb_roŸ
.rb_node;

449 
rb_node
 *
∑ª¡
 = 
NULL
;

450 
¥ñim_ªf
 *
ªf
 = 
NULL
;

451 
¥ñim_ªf
 
èrgë
 = {};

452 
ªsu…
;

454 
èrgë
.
∑ª¡
 = 
byãƒ
;

456 *
p
) {

457 
∑ª¡
 = *
p
;

458 
ªf
 = 
	`rb_íåy
(
∑ª¡
, 
¥ñim_ªf
, 
rbnode
);

459 
ªsu…
 = 
	`¥ñim_ªf_com∑ª
(
ªf
, &
èrgë
);

461 i‡(
ªsu…
 < 0)

462 
p
 = &(*p)->
rb_À·
;

463 i‡(
ªsu…
 > 0)

464 
p
 = &(*p)->
rb_right
;

469 
	}
}

471 
	$add_Æl_∑ª¡s
(
båfs_backªf_wÆk_˘x
 *
˘x
,

472 
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
,

473 
uli°
 *
∑ª¡s
,

474 
¥e·ªes
 *¥e·ªes, 
¥ñim_ªf
 *
ªf
,

475 
Àvñ
)

477 
ªt
 = 0;

478 
¶Ÿ
;

479 
exã¡_buf„r
 *
eb
;

480 
båfs_key
 
key
;

481 
båfs_key
 *
key_f‹_£¨ch
 = &
ªf
->key_for_search;

482 
båfs_fûe_exã¡_ôem
 *
fi
;

483 
exã¡_öode_ñem
 *
eõ
 = 
NULL
, *
ﬁd
 = NULL;

484 
u64
 
disk_byã
;

485 
u64
 
w™ãd_disk_byã
 = 
ªf
->wanted_disk_byte;

486 
u64
 
cou¡
 = 0;

487 
u64
 
d©a_off£t
;

488 
u8
 
ty≥
;

490 i‡(
Àvñ
 != 0) {

491 
eb
 = 
∑th
->
nodes
[
Àvñ
];

492 
ªt
 = 
	`uli°_add
(
∑ª¡s
, 
eb
->
°¨t
, 0, 
GFP_NOFS
);

493 i‡(
ªt
 < 0)

494  
ªt
;

508 
eb
 = 
∑th
->
nodes
[0];

509 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
(
eb
) ||

510 
	`is_sh¨ed_d©a_backªf
(
¥e·ªes
, 
eb
->
°¨t
) ||

511 
ªf
->
roŸ_id
 !
	`båfs_hódî_ow√r
(
eb
)) {

512 i‡(
˘x
->
time_£q
 =
BTRFS_SEQ_LAST
)

513 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

515 
ªt
 = 
	`båfs_√xt_ﬁd_Àaf
(
roŸ
, 
∑th
, 
˘x
->
time_£q
);

518 !
ªt
 && 
cou¡
 < 
ªf
->count) {

519 
eb
 = 
∑th
->
nodes
[0];

520 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

522 
	`båfs_ôem_key_to_˝u
(
eb
, &
key
, 
¶Ÿ
);

524 i‡(
key
.
obje˘id
 !
key_f‹_£¨ch
->objectid ||

525 
key
.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

533 i‡(
¶Ÿ
 == 0 &&

534 (
	`is_sh¨ed_d©a_backªf
(
¥e·ªes
, 
eb
->
°¨t
) ||

535 
ªf
->
roŸ_id
 !
	`båfs_hódî_ow√r
(
eb
))) {

536 i‡(
˘x
->
time_£q
 =
BTRFS_SEQ_LAST
)

537 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

539 
ªt
 = 
	`båfs_√xt_ﬁd_Àaf
(
roŸ
, 
∑th
, 
˘x
->
time_£q
);

542 
fi
 = 
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
, 
båfs_fûe_exã¡_ôem
);

543 
ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
eb
, 
fi
);

544 i‡(
ty≥
 =
BTRFS_FILE_EXTENT_INLINE
)

545 
√xt
;

546 
disk_byã
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
eb
, 
fi
);

547 
d©a_off£t
 = 
	`båfs_fûe_exã¡_off£t
(
eb
, 
fi
);

549 i‡(
disk_byã
 =
w™ãd_disk_byã
) {

550 
eõ
 = 
NULL
;

551 
ﬁd
 = 
NULL
;

552 i‡(
ªf
->
key_f‹_£¨ch
.
off£t
 =
key
.off£à- 
d©a_off£t
)

553 
cou¡
++;

555 
√xt
;

556 i‡(!
˘x
->
skù_öode_ªf_li°
) {

557 
ªt
 = 
	`check_exã¡_ö_eb
(
˘x
, &
key
, 
eb
, 
fi
, &
eõ
);

558 i‡(
ªt
 =
BTRFS_ITERATE_EXTENT_INODES_STOP
 ||

559 
ªt
 < 0)

562 i‡(
ªt
 > 0)

563 
√xt
;

564 
ªt
 = 
	`uli°_add_mîge_±r
(
∑ª¡s
, 
eb
->
°¨t
,

565 
eõ
, (**)&
ﬁd
, 
GFP_NOFS
);

566 i‡(
ªt
 < 0)

568 i‡(!
ªt
 && !
˘x
->
skù_öode_ªf_li°
) {

569 
ﬁd
->
√xt
)

570 
ﬁd
 = old->
√xt
;

571 
ﬁd
->
√xt
 = 
eõ
;

573 
eõ
 = 
NULL
;

575 
√xt
:

576 i‡(
˘x
->
time_£q
 =
BTRFS_SEQ_LAST
)

577 
ªt
 = 
	`båfs_√xt_ôem
(
roŸ
, 
∑th
);

579 
ªt
 = 
	`båfs_√xt_ﬁd_ôem
(
roŸ
, 
∑th
, 
˘x
->
time_£q
);

582 i‡(
ªt
 =
BTRFS_ITERATE_EXTENT_INODES_STOP
 ||Ñet < 0)

583 
	`‰ì_öode_ñem_li°
(
eõ
);

584 i‡(
ªt
 > 0)

585 
ªt
 = 0;

587  
ªt
;

588 
	}
}

594 
	$ªsﬁve_ödúe˘_ªf
(
båfs_backªf_wÆk_˘x
 *
˘x
,

595 
båfs_∑th
 *
∑th
,

596 
¥e·ªes
 *preftrees,

597 
¥ñim_ªf
 *
ªf
, 
uli°
 *
∑ª¡s
)

599 
båfs_roŸ
 *
roŸ
;

600 
exã¡_buf„r
 *
eb
;

601 
ªt
 = 0;

602 
roŸ_Àvñ
;

603 
Àvñ
 = 
ªf
->level;

604 
båfs_key
 
£¨ch_key
 = 
ªf
->
key_f‹_£¨ch
;

614 i‡(
∑th
->
£¨ch_commô_roŸ
)

615 
roŸ
 = 
	`båfs_gë_fs_roŸ_commô_roŸ
(
˘x
->
fs_öfo
, 
∑th
, 
ªf
->
roŸ_id
);

617 
roŸ
 = 
	`båfs_gë_fs_roŸ
(
˘x
->
fs_öfo
, 
ªf
->
roŸ_id
, 
Ál£
);

618 i‡(
	`IS_ERR
(
roŸ
)) {

619 
ªt
 = 
	`PTR_ERR
(
roŸ
);

620 
out_‰ì
;

623 i‡(!
∑th
->
£¨ch_commô_roŸ
 &&

624 
	`ã°_bô
(
BTRFS_ROOT_DELETING
, &
roŸ
->
°©e
)) {

625 
ªt
 = -
ENOENT
;

626 
out
;

629 i‡(
	`båfs_is_ã°ög
(
˘x
->
fs_öfo
)) {

630 
ªt
 = -
ENOENT
;

631 
out
;

634 i‡(
∑th
->
£¨ch_commô_roŸ
)

635 
roŸ_Àvñ
 = 
	`båfs_hódî_Àvñ
(
roŸ
->
commô_roŸ
);

636 i‡(
˘x
->
time_£q
 =
BTRFS_SEQ_LAST
)

637 
roŸ_Àvñ
 = 
	`båfs_hódî_Àvñ
(
roŸ
->
node
);

639 
roŸ_Àvñ
 = 
	`båfs_ﬁd_roŸ_Àvñ
(
roŸ
, 
˘x
->
time_£q
);

641 i‡(
roŸ_Àvñ
 + 1 =
Àvñ
)

642 
out
;

663 i‡(
£¨ch_key
.
ty≥
 =
BTRFS_EXTENT_DATA_KEY
 &&

664 
£¨ch_key
.
off£t
 >
LLONG_MAX
)

665 
£¨ch_key
.
off£t
 = 0;

666 
∑th
->
lowe°_Àvñ
 = 
Àvñ
;

667 i‡(
˘x
->
time_£q
 =
BTRFS_SEQ_LAST
)

668 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
£¨ch_key
, 
∑th
, 0, 0);

670 
ªt
 = 
	`båfs_£¨ch_ﬁd_¶Ÿ
(
roŸ
, &
£¨ch_key
, 
∑th
, 
˘x
->
time_£q
);

672 
	`båfs_debug
(
˘x
->
fs_öfo
,

674 
ªf
->
roŸ_id
, 
Àvñ
,Ñef->
cou¡
, 
ªt
,

675 
ªf
->
key_f‹_£¨ch
.
obje˘id
,Ñef->key_f‹_£¨ch.
ty≥
,

676 
ªf
->
key_f‹_£¨ch
.
off£t
);

677 i‡(
ªt
 < 0)

678 
out
;

680 
eb
 = 
∑th
->
nodes
[
Àvñ
];

681 !
eb
) {

682 i‡(
	`WARN_ON
(!
Àvñ
)) {

683 
ªt
 = 1;

684 
out
;

686 
Àvñ
--;

687 
eb
 = 
∑th
->
nodes
[
Àvñ
];

690 
ªt
 = 
	`add_Æl_∑ª¡s
(
˘x
, 
roŸ
, 
∑th
, 
∑ª¡s
, 
¥e·ªes
, 
ªf
, 
Àvñ
);

691 
out
:

692 
	`båfs_put_roŸ
(
roŸ
);

693 
out_‰ì
:

694 
∑th
->
lowe°_Àvñ
 = 0;

695 
	`båfs_ªÀa£_∑th
(
∑th
);

696  
ªt
;

697 
	}
}

699 
exã¡_öode_ñem
 *

700 
	$unode_aux_to_öode_li°
(
uli°_node
 *
node
)

702 i‡(!
node
)

703  
NULL
;

704  (
exã¡_öode_ñem
 *)(
uöçå_t
)
node
->
aux
;

705 
	}
}

707 
	$‰ì_Àaf_li°
(
uli°
 *ulist)

709 
uli°_node
 *
node
;

710 
uli°_ôî©‹
 
uôî
;

712 
	`ULIST_ITER_INIT
(&
uôî
);

713 (
node
 = 
	`uli°_√xt
(
uli°
, &
uôî
)))

714 
	`‰ì_öode_ñem_li°
(
	`unode_aux_to_öode_li°
(
node
));

716 
	`uli°_‰ì
(
uli°
);

717 
	}
}

735 
	$ªsﬁve_ödúe˘_ªfs
(
båfs_backªf_wÆk_˘x
 *
˘x
,

736 
båfs_∑th
 *
∑th
,

737 
¥e·ªes
 *preftrees,

738 
sh¨e_check
 *
sc
)

740 
îr
;

741 
ªt
 = 0;

742 
uli°
 *
∑ª¡s
;

743 
uli°_node
 *
node
;

744 
uli°_ôî©‹
 
uôî
;

745 
rb_node
 *
∫ode
;

747 
∑ª¡s
 = 
	`uli°_Æloc
(
GFP_NOFS
);

748 i‡(!
∑ª¡s
)

749  -
ENOMEM
;

757 (
∫ode
 = 
	`rb_fú°_ˇched
(&
¥e·ªes
->
ödúe˘
.
roŸ
))) {

758 
¥ñim_ªf
 *
ªf
;

760 
ªf
 = 
	`rb_íåy
(
∫ode
, 
¥ñim_ªf
, 
rbnode
);

761 i‡(
	`WARN
(
ªf
->
∑ª¡
,

763 
ªt
 = -
EINVAL
;

764 
out
;

767 
	`rb_îa£_ˇched
(&
ªf
->
rbnode
, &
¥e·ªes
->
ödúe˘
.
roŸ
);

768 
¥e·ªes
->
ödúe˘
.
cou¡
--;

770 i‡(
ªf
->
cou¡
 == 0) {

771 
	`‰ì_¥ef
(
ªf
);

775 i‡(
sc
 && 
ªf
->
roŸ_id
 !sc->
roŸ
->
roŸ_key
.
obje˘id
) {

776 
	`‰ì_¥ef
(
ªf
);

777 
ªt
 = 
BACKREF_FOUND_SHARED
;

778 
out
;

780 
îr
 = 
	`ªsﬁve_ödúe˘_ªf
(
˘x
, 
∑th
, 
¥e·ªes
, 
ªf
, 
∑ª¡s
);

785 i‡(
îr
 =-
ENOENT
) {

786 
	`¥ñim_ªf_ö£π
(
˘x
->
fs_öfo
, &
¥e·ªes
->
dúe˘
, 
ªf
,

787 
NULL
);

789 } i‡(
îr
) {

790 
	`‰ì_¥ef
(
ªf
);

791 
ªt
 = 
îr
;

792 
out
;

796 
	`ULIST_ITER_INIT
(&
uôî
);

797 
node
 = 
	`uli°_√xt
(
∑ª¡s
, &
uôî
);

798 
ªf
->
∑ª¡
 = 
node
 ?Çode->
vÆ
 : 0;

799 
ªf
->
öode_li°
 = 
	`unode_aux_to_öode_li°
(
node
);

802 (
node
 = 
	`uli°_√xt
(
∑ª¡s
, &
uôî
))) {

803 
¥ñim_ªf
 *
√w_ªf
;

805 
√w_ªf
 = 
	`kmem_ˇche_Æloc
(
båfs_¥ñim_ªf_ˇche
,

806 
GFP_NOFS
);

807 i‡(!
√w_ªf
) {

808 
	`‰ì_¥ef
(
ªf
);

809 
ªt
 = -
ENOMEM
;

810 
out
;

812 
	`mem˝y
(
√w_ªf
, 
ªf
, (*ref));

813 
√w_ªf
->
∑ª¡
 = 
node
->
vÆ
;

814 
√w_ªf
->
öode_li°
 = 
	`unode_aux_to_öode_li°
(
node
);

815 
	`¥ñim_ªf_ö£π
(
˘x
->
fs_öfo
, &
¥e·ªes
->
dúe˘
,

816 
√w_ªf
, 
NULL
);

823 
	`¥ñim_ªf_ö£π
(
˘x
->
fs_öfo
, &
¥e·ªes
->
dúe˘
, 
ªf
, 
NULL
);

825 
	`uli°_ªöô
(
∑ª¡s
);

826 
	`c⁄d_ªsched
();

828 
out
:

833 
	`‰ì_Àaf_li°
(
∑ª¡s
);

834  
ªt
;

835 
	}
}

840 
	$add_missög_keys
(
båfs_fs_öfo
 *
fs_öfo
,

841 
¥e·ªes
 *¥e·ªes, 
boﬁ
 
lock
)

843 
¥ñim_ªf
 *
ªf
;

844 
exã¡_buf„r
 *
eb
;

845 
¥e·ªe
 *
åì
 = &
¥e·ªes
->
ödúe˘_missög_keys
;

846 
rb_node
 *
node
;

848 (
node
 = 
	`rb_fú°_ˇched
(&
åì
->
roŸ
))) {

849 
båfs_åì_∑ª¡_check
 
check
 = { 0 };

851 
ªf
 = 
	`rb_íåy
(
node
, 
¥ñim_ªf
, 
rbnode
);

852 
	`rb_îa£_ˇched
(
node
, &
åì
->
roŸ
);

854 
	`BUG_ON
(
ªf
->
∑ª¡
);

855 
	`BUG_ON
(
ªf
->
key_f‹_£¨ch
.
ty≥
);

856 
	`BUG_ON
(!
ªf
->
w™ãd_disk_byã
);

858 
check
.
Àvñ
 = 
ªf
->level - 1;

859 
check
.
ow√r_roŸ
 = 
ªf
->
roŸ_id
;

861 
eb
 = 
	`ªad_åì_block
(
fs_öfo
, 
ªf
->
w™ãd_disk_byã
, &
check
);

862 i‡(
	`IS_ERR
(
eb
)) {

863 
	`‰ì_¥ef
(
ªf
);

864  
	`PTR_ERR
(
eb
);

866 i‡(!
	`exã¡_buf„r_u±od©e
(
eb
)) {

867 
	`‰ì_¥ef
(
ªf
);

868 
	`‰ì_exã¡_buf„r
(
eb
);

869  -
EIO
;

872 i‡(
lock
)

873 
	`båfs_åì_ªad_lock
(
eb
);

874 i‡(
	`båfs_hódî_Àvñ
(
eb
) == 0)

875 
	`båfs_ôem_key_to_˝u
(
eb
, &
ªf
->
key_f‹_£¨ch
, 0);

877 
	`båfs_node_key_to_˝u
(
eb
, &
ªf
->
key_f‹_£¨ch
, 0);

878 i‡(
lock
)

879 
	`båfs_åì_ªad_u∆ock
(
eb
);

880 
	`‰ì_exã¡_buf„r
(
eb
);

881 
	`¥ñim_ªf_ö£π
(
fs_öfo
, &
¥e·ªes
->
ödúe˘
, 
ªf
, 
NULL
);

882 
	`c⁄d_ªsched
();

885 
	}
}

891 
	$add_dñayed_ªfs
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

892 
båfs_dñayed_ªf_hód
 *
hód
, 
u64
 
£q
,

893 
¥e·ªes
 *¥e·ªes, 
sh¨e_check
 *
sc
)

895 
båfs_dñayed_ªf_node
 *
node
;

896 
båfs_key
 
key
;

897 
rb_node
 *
n
;

898 
cou¡
;

899 
ªt
 = 0;

901 
	`•ö_lock
(&
hód
->
lock
);

902 
n
 = 
	`rb_fú°_ˇched
(&
hód
->
ªf_åì
);Ç;Ç = 
	`rb_√xt
(n)) {

903 
node
 = 
	`rb_íåy
(
n
, 
båfs_dñayed_ªf_node
,

904 
ªf_node
);

905 i‡(
node
->
£q
 > seq)

908 
node
->
a˘i⁄
) {

909 
BTRFS_ADD_DELAYED_EXTENT
:

910 
BTRFS_UPDATE_DELAYED_HEAD
:

911 
	`WARN_ON
(1);

913 
BTRFS_ADD_DELAYED_REF
:

914 
cou¡
 = 
node
->
ªf_mod
;

916 
BTRFS_DROP_DELAYED_REF
:

917 
cou¡
 = 
node
->
ªf_mod
 * -1;

920 
	`BUG
();

922 
node
->
ty≥
) {

923 
BTRFS_TREE_BLOCK_REF_KEY
: {

925 
båfs_dñayed_åì_ªf
 *
ªf
;

926 
båfs_key
 *
key_±r
 = 
NULL
;

928 i‡(
hód
->
exã¡_›
 && hód->exã¡_›->
upd©e_key
) {

929 
	`båfs_disk_key_to_˝u
(&
key
, &
hód
->
exã¡_›
->key);

930 
key_±r
 = &
key
;

933 
ªf
 = 
	`båfs_dñayed_node_to_åì_ªf
(
node
);

934 
ªt
 = 
	`add_ödúe˘_ªf
(
fs_öfo
, 
¥e·ªes
, 
ªf
->
roŸ
,

935 
key_±r
, 
ªf
->
Àvñ
 + 1,

936 
node
->
byãƒ
, 
cou¡
, 
sc
,

937 
GFP_ATOMIC
);

940 
BTRFS_SHARED_BLOCK_REF_KEY
: {

942 
båfs_dñayed_åì_ªf
 *
ªf
;

944 
ªf
 = 
	`båfs_dñayed_node_to_åì_ªf
(
node
);

946 
ªt
 = 
	`add_dúe˘_ªf
(
fs_öfo
, 
¥e·ªes
, 
ªf
->
Àvñ
 + 1,

947 
ªf
->
∑ª¡
, 
node
->
byãƒ
, 
cou¡
,

948 
sc
, 
GFP_ATOMIC
);

951 
BTRFS_EXTENT_DATA_REF_KEY
: {

953 
båfs_dñayed_d©a_ªf
 *
ªf
;

954 
ªf
 = 
	`båfs_dñayed_node_to_d©a_ªf
(
node
);

956 
key
.
obje˘id
 = 
ªf
->objectid;

957 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

958 
key
.
off£t
 = 
ªf
->offset;

975 i‡(
sc
 && 
cou¡
 < 0)

976 
sc
->
have_dñayed_dñëe_ªfs
 = 
åue
;

978 
ªt
 = 
	`add_ödúe˘_ªf
(
fs_öfo
, 
¥e·ªes
, 
ªf
->
roŸ
,

979 &
key
, 0, 
node
->
byãƒ
, 
cou¡
, 
sc
,

980 
GFP_ATOMIC
);

983 
BTRFS_SHARED_DATA_REF_KEY
: {

985 
båfs_dñayed_d©a_ªf
 *
ªf
;

987 
ªf
 = 
	`båfs_dñayed_node_to_d©a_ªf
(
node
);

989 
ªt
 = 
	`add_dúe˘_ªf
(
fs_öfo
, 
¥e·ªes
, 0, 
ªf
->
∑ª¡
,

990 
node
->
byãƒ
, 
cou¡
, 
sc
,

991 
GFP_ATOMIC
);

995 
	`WARN_ON
(1);

1001 i‡(
ªt
 && (ªà!
BACKREF_FOUND_SHARED
))

1004 i‡(!
ªt
)

1005 
ªt
 = 
	`exã¡_is_sh¨ed
(
sc
);

1007 
	`•ö_u∆ock
(&
hód
->
lock
);

1008  
ªt
;

1009 
	}
}

1016 
	$add_ölöe_ªfs
(
båfs_backªf_wÆk_˘x
 *
˘x
,

1017 
båfs_∑th
 *
∑th
,

1018 *
öfo_Àvñ
, 
¥e·ªes
 *preftrees,

1019 
sh¨e_check
 *
sc
)

1021 
ªt
 = 0;

1022 
¶Ÿ
;

1023 
exã¡_buf„r
 *
Àaf
;

1024 
båfs_key
 
key
;

1025 
båfs_key
 
found_key
;

1026 
±r
;

1027 
íd
;

1028 
båfs_exã¡_ôem
 *
ei
;

1029 
u64
 
Êags
;

1030 
u64
 
ôem_size
;

1035 
Àaf
 = 
∑th
->
nodes
[0];

1036 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

1038 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

1039 
	`BUG_ON
(
ôem_size
 < (*
ei
));

1041 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_exã¡_ôem
);

1043 i‡(
˘x
->
check_exã¡_ôem
) {

1044 
ªt
 = 
˘x
->
	`check_exã¡_ôem
(˘x->
byãƒ
, 
ei
, 
Àaf
, ctx->
u£r_˘x
);

1045 i‡(
ªt
)

1046  
ªt
;

1049 
Êags
 = 
	`båfs_exã¡_Êags
(
Àaf
, 
ei
);

1050 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
¶Ÿ
);

1052 
±r
 = ()(
ei
 + 1);

1053 
íd
 = ()
ei
 + 
ôem_size
;

1055 i‡(
found_key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 &&

1056 
Êags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

1057 
båfs_åì_block_öfo
 *
öfo
;

1059 
öfo
 = (
båfs_åì_block_öfo
 *)
±r
;

1060 *
öfo_Àvñ
 = 
	`båfs_åì_block_Àvñ
(
Àaf
, 
öfo
);

1061 
±r
 +(
båfs_åì_block_öfo
);

1062 
	`BUG_ON
(
±r
 > 
íd
);

1063 } i‡(
found_key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
) {

1064 *
öfo_Àvñ
 = 
found_key
.
off£t
;

1066 
	`BUG_ON
(!(
Êags
 & 
BTRFS_EXTENT_FLAG_DATA
));

1069 
±r
 < 
íd
) {

1070 
båfs_exã¡_ölöe_ªf
 *
úef
;

1071 
u64
 
off£t
;

1072 
ty≥
;

1074 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)
±r
;

1075 
ty≥
 = 
	`båfs_gë_exã¡_ölöe_ªf_ty≥
(
Àaf
, 
úef
,

1076 
BTRFS_REF_TYPE_ANY
);

1077 i‡(
ty≥
 =
BTRFS_REF_TYPE_INVALID
)

1078  -
EUCLEAN
;

1080 
off£t
 = 
	`båfs_exã¡_ölöe_ªf_off£t
(
Àaf
, 
úef
);

1082 
ty≥
) {

1083 
BTRFS_SHARED_BLOCK_REF_KEY
:

1084 
ªt
 = 
	`add_dúe˘_ªf
(
˘x
->
fs_öfo
, 
¥e·ªes
,

1085 *
öfo_Àvñ
 + 1, 
off£t
,

1086 
˘x
->
byãƒ
, 1, 
NULL
, 
GFP_NOFS
);

1088 
BTRFS_SHARED_DATA_REF_KEY
: {

1089 
båfs_sh¨ed_d©a_ªf
 *
sdªf
;

1090 
cou¡
;

1092 
sdªf
 = (
båfs_sh¨ed_d©a_ªf
 *)(
úef
 + 1);

1093 
cou¡
 = 
	`båfs_sh¨ed_d©a_ªf_cou¡
(
Àaf
, 
sdªf
);

1095 
ªt
 = 
	`add_dúe˘_ªf
(
˘x
->
fs_öfo
, 
¥e·ªes
, 0, 
off£t
,

1096 
˘x
->
byãƒ
, 
cou¡
, 
sc
, 
GFP_NOFS
);

1099 
BTRFS_TREE_BLOCK_REF_KEY
:

1100 
ªt
 = 
	`add_ödúe˘_ªf
(
˘x
->
fs_öfo
, 
¥e·ªes
, 
off£t
,

1101 
NULL
, *
öfo_Àvñ
 + 1,

1102 
˘x
->
byãƒ
, 1, 
NULL
, 
GFP_NOFS
);

1104 
BTRFS_EXTENT_DATA_REF_KEY
: {

1105 
båfs_exã¡_d©a_ªf
 *
dªf
;

1106 
cou¡
;

1107 
u64
 
roŸ
;

1109 
dªf
 = (
båfs_exã¡_d©a_ªf
 *)(&
úef
->
off£t
);

1110 
cou¡
 = 
	`båfs_exã¡_d©a_ªf_cou¡
(
Àaf
, 
dªf
);

1111 
key
.
obje˘id
 = 
	`båfs_exã¡_d©a_ªf_obje˘id
(
Àaf
,

1112 
dªf
);

1113 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

1114 
key
.
off£t
 = 
	`båfs_exã¡_d©a_ªf_off£t
(
Àaf
, 
dªf
);

1116 i‡(
sc
 && 
key
.
obje˘id
 !sc->
öum
 &&

1117 !
sc
->
have_dñayed_dñëe_ªfs
) {

1118 
ªt
 = 
BACKREF_FOUND_SHARED
;

1122 
roŸ
 = 
	`båfs_exã¡_d©a_ªf_roŸ
(
Àaf
, 
dªf
);

1124 i‡(!
˘x
->
skù_d©a_ªf
 ||

1125 !
˘x
->
	`skù_d©a_ªf
(
roŸ
, 
key
.
obje˘id
, key.
off£t
,

1126 
˘x
->
u£r_˘x
))

1127 
ªt
 = 
	`add_ödúe˘_ªf
(
˘x
->
fs_öfo
, 
¥e·ªes
,

1128 
roŸ
, &
key
, 0, 
˘x
->
byãƒ
,

1129 
cou¡
, 
sc
, 
GFP_NOFS
);

1133 
	`WARN_ON
(1);

1135 i‡(
ªt
)

1136  
ªt
;

1137 
±r
 +
	`båfs_exã¡_ölöe_ªf_size
(
ty≥
);

1141 
	}
}

1148 
	$add_keyed_ªfs
(
båfs_backªf_wÆk_˘x
 *
˘x
,

1149 
båfs_roŸ
 *
exã¡_roŸ
,

1150 
båfs_∑th
 *
∑th
,

1151 
öfo_Àvñ
, 
¥e·ªes
 *preftrees,

1152 
sh¨e_check
 *
sc
)

1154 
båfs_fs_öfo
 *
fs_öfo
 = 
exã¡_roŸ
->fs_info;

1155 
ªt
;

1156 
¶Ÿ
;

1157 
exã¡_buf„r
 *
Àaf
;

1158 
båfs_key
 
key
;

1161 
ªt
 = 
	`båfs_√xt_ôem
(
exã¡_roŸ
, 
∑th
);

1162 i‡(
ªt
 < 0)

1164 i‡(
ªt
) {

1165 
ªt
 = 0;

1169 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

1170 
Àaf
 = 
∑th
->
nodes
[0];

1171 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

1173 i‡(
key
.
obje˘id
 !
˘x
->
byãƒ
)

1175 i‡(
key
.
ty≥
 < 
BTRFS_TREE_BLOCK_REF_KEY
)

1177 i‡(
key
.
ty≥
 > 
BTRFS_SHARED_DATA_REF_KEY
)

1180 
key
.
ty≥
) {

1181 
BTRFS_SHARED_BLOCK_REF_KEY
:

1183 
ªt
 = 
	`add_dúe˘_ªf
(
fs_öfo
, 
¥e·ªes
,

1184 
öfo_Àvñ
 + 1, 
key
.
off£t
,

1185 
˘x
->
byãƒ
, 1, 
NULL
, 
GFP_NOFS
);

1187 
BTRFS_SHARED_DATA_REF_KEY
: {

1189 
båfs_sh¨ed_d©a_ªf
 *
sdªf
;

1190 
cou¡
;

1192 
sdªf
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
,

1193 
båfs_sh¨ed_d©a_ªf
);

1194 
cou¡
 = 
	`båfs_sh¨ed_d©a_ªf_cou¡
(
Àaf
, 
sdªf
);

1195 
ªt
 = 
	`add_dúe˘_ªf
(
fs_öfo
, 
¥e·ªes
, 0,

1196 
key
.
off£t
, 
˘x
->
byãƒ
, 
cou¡
,

1197 
sc
, 
GFP_NOFS
);

1200 
BTRFS_TREE_BLOCK_REF_KEY
:

1202 
ªt
 = 
	`add_ödúe˘_ªf
(
fs_öfo
, 
¥e·ªes
, 
key
.
off£t
,

1203 
NULL
, 
öfo_Àvñ
 + 1, 
˘x
->
byãƒ
,

1204 1, 
NULL
, 
GFP_NOFS
);

1206 
BTRFS_EXTENT_DATA_REF_KEY
: {

1208 
båfs_exã¡_d©a_ªf
 *
dªf
;

1209 
cou¡
;

1210 
u64
 
roŸ
;

1212 
dªf
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
,

1213 
båfs_exã¡_d©a_ªf
);

1214 
cou¡
 = 
	`båfs_exã¡_d©a_ªf_cou¡
(
Àaf
, 
dªf
);

1215 
key
.
obje˘id
 = 
	`båfs_exã¡_d©a_ªf_obje˘id
(
Àaf
,

1216 
dªf
);

1217 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

1218 
key
.
off£t
 = 
	`båfs_exã¡_d©a_ªf_off£t
(
Àaf
, 
dªf
);

1220 i‡(
sc
 && 
key
.
obje˘id
 !sc->
öum
 &&

1221 !
sc
->
have_dñayed_dñëe_ªfs
) {

1222 
ªt
 = 
BACKREF_FOUND_SHARED
;

1226 
roŸ
 = 
	`båfs_exã¡_d©a_ªf_roŸ
(
Àaf
, 
dªf
);

1228 i‡(!
˘x
->
skù_d©a_ªf
 ||

1229 !
˘x
->
	`skù_d©a_ªf
(
roŸ
, 
key
.
obje˘id
, key.
off£t
,

1230 
˘x
->
u£r_˘x
))

1231 
ªt
 = 
	`add_ödúe˘_ªf
(
fs_öfo
, 
¥e·ªes
, 
roŸ
,

1232 &
key
, 0, 
˘x
->
byãƒ
,

1233 
cou¡
, 
sc
, 
GFP_NOFS
);

1237 
	`WARN_ON
(1);

1239 i‡(
ªt
)

1240  
ªt
;

1244  
ªt
;

1245 
	}
}

1252 
boﬁ
 
	$lookup_backªf_sh¨ed_ˇche
(
båfs_backªf_sh¨e_check_˘x
 *
˘x
,

1253 
båfs_roŸ
 *
roŸ
,

1254 
u64
 
byãƒ
, 
Àvñ
, 
boﬁ
 *
is_sh¨ed
)

1256 c⁄° 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1257 
båfs_backªf_sh¨ed_ˇche_íåy
 *
íåy
;

1259 i‡(!
cuºít
->
jou∫Æ_öfo
)

1260 
	`lockdï_as£π_hñd
(&
fs_öfo
->
commô_roŸ_£m
);

1262 i‡(!
˘x
->
u£_∑th_ˇche
)

1263  
Ál£
;

1265 i‡(
	`WARN_ON_ONCE
(
Àvñ
 >
BTRFS_MAX_LEVEL
))

1266  
Ál£
;

1274 
	`ASSERT
(
Àvñ
 >= 0);

1276 
íåy
 = &
˘x
->
∑th_ˇche_íåõs
[
Àvñ
];

1279 i‡(
íåy
->
byãƒ
 != bytenr)

1280  
Ál£
;

1286 i‡(!
íåy
->
is_sh¨ed
 &&

1287 
íåy
->
gí
 !
	`båfs_roŸ_œ°_¢≠shŸ
(&
roŸ
->
roŸ_ôem
))

1288  
Ál£
;

1295 i‡(
íåy
->
is_sh¨ed
 &&

1296 
íåy
->
gí
 !
	`båfs_gë_œ°_roŸ_dr›_gí
(
fs_öfo
))

1297  
Ál£
;

1299 *
is_sh¨ed
 = 
íåy
->is_shared;

1307 i‡(*
is_sh¨ed
) {

1308 
i
 = 0; i < 
Àvñ
; i++) {

1309 
˘x
->
∑th_ˇche_íåõs
[
i
].
is_sh¨ed
 = 
åue
;

1310 
˘x
->
∑th_ˇche_íåõs
[
i
].
gí
 = 
íåy
->gen;

1314  
åue
;

1315 
	}
}

1322 
	$°‹e_backªf_sh¨ed_ˇche
(
båfs_backªf_sh¨e_check_˘x
 *
˘x
,

1323 
båfs_roŸ
 *
roŸ
,

1324 
u64
 
byãƒ
, 
Àvñ
, 
boﬁ
 
is_sh¨ed
)

1326 c⁄° 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1327 
båfs_backªf_sh¨ed_ˇche_íåy
 *
íåy
;

1328 
u64
 
gí
;

1330 i‡(!
cuºít
->
jou∫Æ_öfo
)

1331 
	`lockdï_as£π_hñd
(&
fs_öfo
->
commô_roŸ_£m
);

1333 i‡(!
˘x
->
u£_∑th_ˇche
)

1336 i‡(
	`WARN_ON_ONCE
(
Àvñ
 >
BTRFS_MAX_LEVEL
))

1345 
	`ASSERT
(
Àvñ
 >= 0);

1347 i‡(
is_sh¨ed
)

1348 
gí
 = 
	`båfs_gë_œ°_roŸ_dr›_gí
(
fs_öfo
);

1350 
gí
 = 
	`båfs_roŸ_œ°_¢≠shŸ
(&
roŸ
->
roŸ_ôem
);

1352 
íåy
 = &
˘x
->
∑th_ˇche_íåõs
[
Àvñ
];

1353 
íåy
->
byãƒ
 = bytenr;

1354 
íåy
->
is_sh¨ed
 = is_shared;

1355 
íåy
->
gí
 = gen;

1364 i‡(
is_sh¨ed
) {

1365 
i
 = 0; i < 
Àvñ
; i++) {

1366 
íåy
 = &
˘x
->
∑th_ˇche_íåõs
[
i
];

1367 
íåy
->
is_sh¨ed
 = is_shared;

1368 
íåy
->
gí
 = gen;

1371 
	}
}

1387 
	$föd_∑ª¡_nodes
(
båfs_backªf_wÆk_˘x
 *
˘x
,

1388 
sh¨e_check
 *
sc
)

1390 
båfs_roŸ
 *
roŸ
 = 
	`båfs_exã¡_roŸ
(
˘x
->
fs_öfo
, ctx->
byãƒ
);

1391 
båfs_key
 
key
;

1392 
båfs_∑th
 *
∑th
;

1393 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
 = 
NULL
;

1394 
båfs_dñayed_ªf_hód
 *
hód
;

1395 
öfo_Àvñ
 = 0;

1396 
ªt
;

1397 
¥ñim_ªf
 *
ªf
;

1398 
rb_node
 *
node
;

1399 
exã¡_öode_ñem
 *
eõ
 = 
NULL
;

1400 
¥e·ªes
Öreftrees = {

1401 .
dúe˘
 = 
PREFTREE_INIT
,

1402 .
ödúe˘
 = 
PREFTREE_INIT
,

1403 .
ödúe˘_missög_keys
 = 
PREFTREE_INIT


1407 i‡(
sc
)

1408 
	`ASSERT
(
˘x
->
roŸs
 =
NULL
);

1410 
key
.
obje˘id
 = 
˘x
->
byãƒ
;

1411 
key
.
off£t
 = (
u64
)-1;

1412 i‡(
	`båfs_fs_öcom∑t
(
˘x
->
fs_öfo
, 
SKINNY_METADATA
))

1413 
key
.
ty≥
 = 
BTRFS_METADATA_ITEM_KEY
;

1415 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

1417 
∑th
 = 
	`båfs_Æloc_∑th
();

1418 i‡(!
∑th
)

1419  -
ENOMEM
;

1420 i‡(!
˘x
->
å™s
) {

1421 
∑th
->
£¨ch_commô_roŸ
 = 1;

1422 
∑th
->
skù_lockög
 = 1;

1425 i‡(
˘x
->
time_£q
 =
BTRFS_SEQ_LAST
)

1426 
∑th
->
skù_lockög
 = 1;

1428 
agaö
:

1429 
hód
 = 
NULL
;

1431 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

1432 i‡(
ªt
 < 0)

1433 
out
;

1434 i‡(
ªt
 == 0) {

1436 
	`ASSERT
(
ªt
 != 0);

1437 
ªt
 = -
EUCLEAN
;

1438 
out
;

1441 i‡(
˘x
->
å™s
 && 
	`likñy
(˘x->å™s->
ty≥
 !
__TRANS_DUMMY
) &&

1442 
˘x
->
time_£q
 !
BTRFS_SEQ_LAST
) {

1449 
dñayed_ªfs
 = &
˘x
->
å™s
->
å™ß˘i⁄
->delayed_refs;

1450 
	`•ö_lock
(&
dñayed_ªfs
->
lock
);

1451 
hód
 = 
	`båfs_föd_dñayed_ªf_hód
(
dñayed_ªfs
, 
˘x
->
byãƒ
);

1452 i‡(
hód
) {

1453 i‡(!
	`muãx_åylock
(&
hód
->
muãx
)) {

1454 
	`ªfcou¡_öc
(&
hód
->
ªfs
);

1455 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

1457 
	`båfs_ªÀa£_∑th
(
∑th
);

1463 
	`muãx_lock
(&
hód
->
muãx
);

1464 
	`muãx_u∆ock
(&
hód
->
muãx
);

1465 
	`båfs_put_dñayed_ªf_hód
(
hód
);

1466 
agaö
;

1468 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

1469 
ªt
 = 
	`add_dñayed_ªfs
(
˘x
->
fs_öfo
, 
hód
, ctx->
time_£q
,

1470 &
¥e·ªes
, 
sc
);

1471 
	`muãx_u∆ock
(&
hód
->
muãx
);

1472 i‡(
ªt
)

1473 
out
;

1475 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

1479 i‡(
∑th
->
¶Ÿs
[0]) {

1480 
exã¡_buf„r
 *
Àaf
;

1481 
¶Ÿ
;

1483 
∑th
->
¶Ÿs
[0]--;

1484 
Àaf
 = 
∑th
->
nodes
[0];

1485 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

1486 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

1487 i‡(
key
.
obje˘id
 =
˘x
->
byãƒ
 &&

1488 (
key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 ||

1489 
key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
)) {

1490 
ªt
 = 
	`add_ölöe_ªfs
(
˘x
, 
∑th
, &
öfo_Àvñ
,

1491 &
¥e·ªes
, 
sc
);

1492 i‡(
ªt
)

1493 
out
;

1494 
ªt
 = 
	`add_keyed_ªfs
(
˘x
, 
roŸ
, 
∑th
, 
öfo_Àvñ
,

1495 &
¥e·ªes
, 
sc
);

1496 i‡(
ªt
)

1497 
out
;

1513 
	`ASSERT
(
	`exã¡_is_sh¨ed
(
sc
) == 0);

1523 i‡(
sc
 && 
˘x
->
byãƒ
 =sc->
d©a_byãƒ
) {

1533 i‡(
sc
->
d©a_exã¡_gí
 >

1534 
	`båfs_roŸ_œ°_¢≠shŸ
(&
sc
->
roŸ
->
roŸ_ôem
)) {

1535 
ªt
 = 
BACKREF_FOUND_NOT_SHARED
;

1536 
out
;

1550 i‡(
sc
->
˘x
->
cuº_Àaf_byãƒ
 =sc->˘x->
¥ev_Àaf_byãƒ
 &&

1551 
sc
->
£lf_ªf_cou¡
 == 1) {

1552 
boﬁ
 
ˇched
;

1553 
boﬁ
 
is_sh¨ed
;

1555 
ˇched
 = 
	`lookup_backªf_sh¨ed_ˇche
(
sc
->
˘x
, sc->
roŸ
,

1556 
sc
->
˘x
->
cuº_Àaf_byãƒ
,

1557 0, &
is_sh¨ed
);

1558 i‡(
ˇched
) {

1559 i‡(
is_sh¨ed
)

1560 
ªt
 = 
BACKREF_FOUND_SHARED
;

1562 
ªt
 = 
BACKREF_FOUND_NOT_SHARED
;

1563 
out
;

1568 
	`båfs_ªÀa£_∑th
(
∑th
);

1570 
ªt
 = 
	`add_missög_keys
(
˘x
->
fs_öfo
, &
¥e·ªes
, 
∑th
->
skù_lockög
 == 0);

1571 i‡(
ªt
)

1572 
out
;

1574 
	`WARN_ON
(!
	`RB_EMPTY_ROOT
(&
¥e·ªes
.
ödúe˘_missög_keys
.
roŸ
.
rb_roŸ
));

1576 
ªt
 = 
	`ªsﬁve_ödúe˘_ªfs
(
˘x
, 
∑th
, &
¥e·ªes
, 
sc
);

1577 i‡(
ªt
)

1578 
out
;

1580 
	`WARN_ON
(!
	`RB_EMPTY_ROOT
(&
¥e·ªes
.
ödúe˘
.
roŸ
.
rb_roŸ
));

1589 
node
 = 
	`rb_fú°_ˇched
(&
¥e·ªes
.
dúe˘
.
roŸ
);

1590 
node
) {

1591 
ªf
 = 
	`rb_íåy
(
node
, 
¥ñim_ªf
, 
rbnode
);

1592 
node
 = 
	`rb_√xt
(&
ªf
->
rbnode
);

1603 i‡(
˘x
->
roŸs
 && 
ªf
->
cou¡
 &&Ñef->
roŸ_id
 &&Ñef->
∑ª¡
 == 0) {

1605 
ªt
 = 
	`uli°_add
(
˘x
->
roŸs
, 
ªf
->
roŸ_id
, 0, 
GFP_NOFS
);

1606 i‡(
ªt
 < 0)

1607 
out
;

1609 i‡(
ªf
->
cou¡
 &&Ñef->
∑ª¡
) {

1610 i‡(!
˘x
->
skù_öode_ªf_li°
 && !
ªf
->
öode_li°
 &&

1611 
ªf
->
Àvñ
 == 0) {

1612 
båfs_åì_∑ª¡_check
 
check
 = { 0 };

1613 
exã¡_buf„r
 *
eb
;

1615 
check
.
Àvñ
 = 
ªf
->level;

1617 
eb
 = 
	`ªad_åì_block
(
˘x
->
fs_öfo
, 
ªf
->
∑ª¡
,

1618 &
check
);

1619 i‡(
	`IS_ERR
(
eb
)) {

1620 
ªt
 = 
	`PTR_ERR
(
eb
);

1621 
out
;

1623 i‡(!
	`exã¡_buf„r_u±od©e
(
eb
)) {

1624 
	`‰ì_exã¡_buf„r
(
eb
);

1625 
ªt
 = -
EIO
;

1626 
out
;

1629 i‡(!
∑th
->
skù_lockög
)

1630 
	`båfs_åì_ªad_lock
(
eb
);

1631 
ªt
 = 
	`föd_exã¡_ö_eb
(
˘x
, 
eb
, &
eõ
);

1632 i‡(!
∑th
->
skù_lockög
)

1633 
	`båfs_åì_ªad_u∆ock
(
eb
);

1634 
	`‰ì_exã¡_buf„r
(
eb
);

1635 i‡(
ªt
 =
BTRFS_ITERATE_EXTENT_INODES_STOP
 ||

1636 
ªt
 < 0)

1637 
out
;

1638 
ªf
->
öode_li°
 = 
eõ
;

1644 
eõ
 = 
NULL
;

1646 
ªt
 = 
	`uli°_add_mîge_±r
(
˘x
->
ªfs
, 
ªf
->
∑ª¡
,

1647 
ªf
->
öode_li°
,

1648 (**)&
eõ
, 
GFP_NOFS
);

1649 i‡(
ªt
 < 0)

1650 
out
;

1651 i‡(!
ªt
 && !
˘x
->
skù_öode_ªf_li°
) {

1660 
	`ASSERT
(
eõ
);

1661 i‡(!
eõ
) {

1662 
ªt
 = -
EUCLEAN
;

1663 
out
;

1665 
eõ
->
√xt
)

1666 
eõ
 =Éõ->
√xt
;

1667 
eõ
->
√xt
 = 
ªf
->
öode_li°
;

1669 
eõ
 = 
NULL
;

1677 
ªf
->
öode_li°
 = 
NULL
;

1679 
	`c⁄d_ªsched
();

1682 
out
:

1683 
	`båfs_‰ì_∑th
(
∑th
);

1685 
	`¥ñim_ªÀa£
(&
¥e·ªes
.
dúe˘
);

1686 
	`¥ñim_ªÀa£
(&
¥e·ªes
.
ödúe˘
);

1687 
	`¥ñim_ªÀa£
(&
¥e·ªes
.
ödúe˘_missög_keys
);

1689 i‡(
ªt
 =
BTRFS_ITERATE_EXTENT_INODES_STOP
 ||Ñet < 0)

1690 
	`‰ì_öode_ñem_li°
(
eõ
);

1691  
ªt
;

1692 
	}
}

1704 
	$båfs_föd_Æl_Àafs
(
båfs_backªf_wÆk_˘x
 *
˘x
)

1706 
ªt
;

1708 
	`ASSERT
(
˘x
->
ªfs
 =
NULL
);

1710 
˘x
->
ªfs
 = 
	`uli°_Æloc
(
GFP_NOFS
);

1711 i‡(!
˘x
->
ªfs
)

1712  -
ENOMEM
;

1714 
ªt
 = 
	`föd_∑ª¡_nodes
(
˘x
, 
NULL
);

1715 i‡(
ªt
 =
BTRFS_ITERATE_EXTENT_INODES_STOP
 ||

1716 (
ªt
 < 0 &&Ñë !-
ENOENT
)) {

1717 
	`‰ì_Àaf_li°
(
˘x
->
ªfs
);

1718 
˘x
->
ªfs
 = 
NULL
;

1719  
ªt
;

1723 
	}
}

1744 
	$båfs_föd_Æl_roŸs_ß„
(
båfs_backªf_wÆk_˘x
 *
˘x
)

1746 c⁄° 
u64
 
‹ig_byãƒ
 = 
˘x
->
byãƒ
;

1747 c⁄° 
boﬁ
 
‹ig_skù_öode_ªf_li°
 = 
˘x
->
skù_öode_ªf_li°
;

1748 
boﬁ
 
roŸs_uli°_Æloˇãd
 = 
Ál£
;

1749 
uli°_ôî©‹
 
uôî
;

1750 
ªt
 = 0;

1752 
	`ASSERT
(
˘x
->
ªfs
 =
NULL
);

1754 
˘x
->
ªfs
 = 
	`uli°_Æloc
(
GFP_NOFS
);

1755 i‡(!
˘x
->
ªfs
)

1756  -
ENOMEM
;

1758 i‡(!
˘x
->
roŸs
) {

1759 
˘x
->
roŸs
 = 
	`uli°_Æloc
(
GFP_NOFS
);

1760 i‡(!
˘x
->
roŸs
) {

1761 
	`uli°_‰ì
(
˘x
->
ªfs
);

1762 
˘x
->
ªfs
 = 
NULL
;

1763  -
ENOMEM
;

1765 
roŸs_uli°_Æloˇãd
 = 
åue
;

1768 
˘x
->
skù_öode_ªf_li°
 = 
åue
;

1770 
	`ULIST_ITER_INIT
(&
uôî
);

1772 
uli°_node
 *
node
;

1774 
ªt
 = 
	`föd_∑ª¡_nodes
(
˘x
, 
NULL
);

1775 i‡(
ªt
 < 0 &&Ñë !-
ENOENT
) {

1776 i‡(
roŸs_uli°_Æloˇãd
) {

1777 
	`uli°_‰ì
(
˘x
->
roŸs
);

1778 
˘x
->
roŸs
 = 
NULL
;

1782 
ªt
 = 0;

1783 
node
 = 
	`uli°_√xt
(
˘x
->
ªfs
, &
uôî
);

1784 i‡(!
node
)

1786 
˘x
->
byãƒ
 = 
node
->
vÆ
;

1787 
	`c⁄d_ªsched
();

1790 
	`uli°_‰ì
(
˘x
->
ªfs
);

1791 
˘x
->
ªfs
 = 
NULL
;

1792 
˘x
->
byãƒ
 = 
‹ig_byãƒ
;

1793 
˘x
->
skù_öode_ªf_li°
 = 
‹ig_skù_öode_ªf_li°
;

1795  
ªt
;

1796 
	}
}

1798 
	$båfs_föd_Æl_roŸs
(
båfs_backªf_wÆk_˘x
 *
˘x
,

1799 
boﬁ
 
skù_commô_roŸ_£m
)

1801 
ªt
;

1803 i‡(!
˘x
->
å™s
 && !
skù_commô_roŸ_£m
)

1804 
	`down_ªad
(&
˘x
->
fs_öfo
->
commô_roŸ_£m
);

1805 
ªt
 = 
	`båfs_föd_Æl_roŸs_ß„
(
˘x
);

1806 i‡(!
˘x
->
å™s
 && !
skù_commô_roŸ_£m
)

1807 
	`up_ªad
(&
˘x
->
fs_öfo
->
commô_roŸ_£m
);

1808  
ªt
;

1809 
	}
}

1811 
båfs_backªf_sh¨e_check_˘x
 *
	$båfs_Æloc_backªf_sh¨e_check_˘x
()

1813 
båfs_backªf_sh¨e_check_˘x
 *
˘x
;

1815 
˘x
 = 
	`kzÆloc
((*˘x), 
GFP_KERNEL
);

1816 i‡(!
˘x
)

1817  
NULL
;

1819 
	`uli°_öô
(&
˘x
->
ªfs
);

1821  
˘x
;

1822 
	}
}

1824 
	$båfs_‰ì_backªf_sh¨e_˘x
(
båfs_backªf_sh¨e_check_˘x
 *
˘x
)

1826 i‡(!
˘x
)

1829 
	`uli°_ªÀa£
(&
˘x
->
ªfs
);

1830 
	`k‰ì
(
˘x
);

1831 
	}
}

1853 
	$båfs_is_d©a_exã¡_sh¨ed
(
båfs_öode
 *
öode
, 
u64
 
byãƒ
,

1854 
u64
 
exã¡_gí
,

1855 
båfs_backªf_sh¨e_check_˘x
 *
˘x
)

1857 
båfs_backªf_wÆk_˘x
 
wÆk_˘x
 = { 0 };

1858 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

1859 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1860 
båfs_å™s_h™dÀ
 *
å™s
;

1861 
uli°_ôî©‹
 
uôî
;

1862 
uli°_node
 *
node
;

1863 
båfs_£q_li°
 
ñem
 = 
	`BTRFS_SEQ_LIST_INIT
(elem);

1864 
ªt
 = 0;

1865 
sh¨e_check
 
sh¨ed
 = {

1866 .
˘x
 = ctx,

1867 .
roŸ
 =Ñoot,

1868 .
öum
 = 
	`båfs_öo
(
öode
),

1869 .
d©a_byãƒ
 = 
byãƒ
,

1870 .
d©a_exã¡_gí
 = 
exã¡_gí
,

1871 .
sh¨e_cou¡
 = 0,

1872 .
£lf_ªf_cou¡
 = 0,

1873 .
have_dñayed_dñëe_ªfs
 = 
Ál£
,

1875 
Àvñ
;

1876 
boﬁ
 
Àaf_ˇched
;

1877 
boﬁ
 
Àaf_is_sh¨ed
;

1879 
i
 = 0; i < 
BTRFS_BACKREF_CTX_PREV_EXTENTS_SIZE
; i++) {

1880 i‡(
˘x
->
¥ev_exã¡s_ˇche
[
i
].
byãƒ
 == bytenr)

1881  
˘x
->
¥ev_exã¡s_ˇche
[
i
].
is_sh¨ed
;

1884 
	`uli°_öô
(&
˘x
->
ªfs
);

1886 
å™s
 = 
	`båfs_joö_å™ß˘i⁄_no°¨t
(
roŸ
);

1887 i‡(
	`IS_ERR
(
å™s
)) {

1888 i‡(
	`PTR_ERR
(
å™s
Ë!-
ENOENT
 && PTR_ERR—ønsË!-
EROFS
) {

1889 
ªt
 = 
	`PTR_ERR
(
å™s
);

1890 
out
;

1892 
å™s
 = 
NULL
;

1893 
	`down_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

1895 
	`båfs_gë_åì_mod_£q
(
fs_öfo
, &
ñem
);

1896 
wÆk_˘x
.
time_£q
 = 
ñem
.
£q
;

1899 
˘x
->
u£_∑th_ˇche
 = 
åue
;

1908 
Àaf_ˇched
 = 
	`lookup_backªf_sh¨ed_ˇche
(
˘x
, 
roŸ
,

1909 
˘x
->
cuº_Àaf_byãƒ
, 0,

1910 &
Àaf_is_sh¨ed
);

1911 i‡(
Àaf_ˇched
 && 
Àaf_is_sh¨ed
) {

1912 
ªt
 = 1;

1913 
out_å™s
;

1916 
wÆk_˘x
.
skù_öode_ªf_li°
 = 
åue
;

1917 
wÆk_˘x
.
å™s
 =Årans;

1918 
wÆk_˘x
.
fs_öfo
 = fs_info;

1919 
wÆk_˘x
.
ªfs
 = &
˘x
->refs;

1922 
Àvñ
 = -1;

1923 
	`ULIST_ITER_INIT
(&
uôî
);

1925 c⁄° 
¥ev_ªf_cou¡
 = 
˘x
->
ªfs
.
¬odes
;

1927 
wÆk_˘x
.
byãƒ
 = bytenr;

1928 
ªt
 = 
	`föd_∑ª¡_nodes
(&
wÆk_˘x
, &
sh¨ed
);

1929 i‡(
ªt
 =
BACKREF_FOUND_SHARED
 ||

1930 
ªt
 =
BACKREF_FOUND_NOT_SHARED
) {

1932 
ªt
 = (ªà=
BACKREF_FOUND_SHARED
) ? 1 : 0;

1933 i‡(
Àvñ
 >= 0)

1934 
	`°‹e_backªf_sh¨ed_ˇche
(
˘x
, 
roŸ
, 
byãƒ
,

1935 
Àvñ
, 
ªt
 == 1);

1938 i‡(
ªt
 < 0 &&Ñë !-
ENOENT
)

1940 
ªt
 = 0;

1972 i‡((
˘x
->
ªfs
.
¬odes
 - 
¥ev_ªf_cou¡
) > 1)

1973 
˘x
->
u£_∑th_ˇche
 = 
Ál£
;

1975 i‡(
Àvñ
 >= 0)

1976 
	`°‹e_backªf_sh¨ed_ˇche
(
˘x
, 
roŸ
, 
byãƒ
,

1977 
Àvñ
, 
Ál£
);

1978 
node
 = 
	`uli°_√xt
(&
˘x
->
ªfs
, &
uôî
);

1979 i‡(!
node
)

1981 
byãƒ
 = 
node
->
vÆ
;

1982 i‡(
˘x
->
u£_∑th_ˇche
) {

1983 
boﬁ
 
is_sh¨ed
;

1984 
boﬁ
 
ˇched
;

1986 
Àvñ
++;

1987 
ˇched
 = 
	`lookup_backªf_sh¨ed_ˇche
(
˘x
, 
roŸ
, 
byãƒ
,

1988 
Àvñ
, &
is_sh¨ed
);

1989 i‡(
ˇched
) {

1990 
ªt
 = (
is_sh¨ed
 ? 1 : 0);

1994 
sh¨ed
.
sh¨e_cou¡
 = 0;

1995 
sh¨ed
.
have_dñayed_dñëe_ªfs
 = 
Ál£
;

1996 
	`c⁄d_ªsched
();

2006 i‡(!
˘x
->
u£_∑th_ˇche
) {

2007 
i
 = 0;

2009 
Àvñ
--;

2010 i‡(
ªt
 >0 && 
Àvñ
 >= 0) {

2011 
byãƒ
 = 
˘x
->
∑th_ˇche_íåõs
[
Àvñ
].bytenr;

2012 
˘x
->
u£_∑th_ˇche
 = 
åue
;

2013 
	`°‹e_backªf_sh¨ed_ˇche
(
˘x
, 
roŸ
, 
byãƒ
, 
Àvñ
, 
ªt
);

2014 
i
 = 
Àvñ
 + 1;

2017  ; 
i
 < 
BTRFS_MAX_LEVEL
; i++)

2018 
˘x
->
∑th_ˇche_íåõs
[
i
].
byãƒ
 = 0;

2025 i‡(
ªt
 >0 && 
sh¨ed
.
£lf_ªf_cou¡
 > 1) {

2026 
¶Ÿ
 = 
˘x
->
¥ev_exã¡s_ˇche_¶Ÿ
;

2028 
˘x
->
¥ev_exã¡s_ˇche
[
¶Ÿ
].
byãƒ
 = 
sh¨ed
.
d©a_byãƒ
;

2029 
˘x
->
¥ev_exã¡s_ˇche
[
¶Ÿ
].
is_sh¨ed
 = (
ªt
 == 1);

2031 
¶Ÿ
 = (¶Ÿ + 1Ë% 
BTRFS_BACKREF_CTX_PREV_EXTENTS_SIZE
;

2032 
˘x
->
¥ev_exã¡s_ˇche_¶Ÿ
 = 
¶Ÿ
;

2035 
out_å™s
:

2036 i‡(
å™s
) {

2037 
	`båfs_put_åì_mod_£q
(
fs_öfo
, &
ñem
);

2038 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

2040 
	`up_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

2042 
out
:

2043 
	`uli°_ªÀa£
(&
˘x
->
ªfs
);

2044 
˘x
->
¥ev_Àaf_byãƒ
 = ctx->
cuº_Àaf_byãƒ
;

2046  
ªt
;

2047 
	}
}

2049 
	$båfs_föd_⁄e_exåef
(
båfs_roŸ
 *
roŸ
, 
u64
 
öode_obje˘id
,

2050 
u64
 
°¨t_off
, 
båfs_∑th
 *
∑th
,

2051 
båfs_öode_exåef
 **
ªt_exåef
,

2052 
u64
 *
found_off
)

2054 
ªt
, 
¶Ÿ
;

2055 
båfs_key
 
key
;

2056 
båfs_key
 
found_key
;

2057 
båfs_öode_exåef
 *
exåef
;

2058 c⁄° 
exã¡_buf„r
 *
Àaf
;

2059 
±r
;

2061 
key
.
obje˘id
 = 
öode_obje˘id
;

2062 
key
.
ty≥
 = 
BTRFS_INODE_EXTREF_KEY
;

2063 
key
.
off£t
 = 
°¨t_off
;

2065 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

2066 i‡(
ªt
 < 0)

2067  
ªt
;

2070 
Àaf
 = 
∑th
->
nodes
[0];

2071 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

2072 i‡(
¶Ÿ
 >
	`båfs_hódî_ƒôems
(
Àaf
)) {

2082 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

2083 i‡(
ªt
) {

2084 i‡(
ªt
 >= 1)

2085 
ªt
 = -
ENOENT
;

2091 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
¶Ÿ
);

2099 
ªt
 = -
ENOENT
;

2100 i‡(
found_key
.
obje˘id
 !
öode_obje˘id
)

2102 i‡(
found_key
.
ty≥
 !
BTRFS_INODE_EXTREF_KEY
)

2105 
ªt
 = 0;

2106 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

2107 
exåef
 = (
båfs_öode_exåef
 *)
±r
;

2108 *
ªt_exåef
 = 
exåef
;

2109 i‡(
found_off
)

2110 *
found_off
 = 
found_key
.
off£t
;

2114  
ªt
;

2115 
	}
}

2131 *
	$båfs_ªf_to_∑th
(
båfs_roŸ
 *
fs_roŸ
, 
båfs_∑th
 *
∑th
,

2132 
u32
 
«me_Àn
, 
«me_off
,

2133 
exã¡_buf„r
 *
eb_ö
, 
u64
 
∑ª¡
,

2134 *
de°
, 
u32
 
size
)

2136 
¶Ÿ
;

2137 
u64
 
√xt_öum
;

2138 
ªt
;

2139 
s64
 
byãs_À·
 = ((s64)
size
) - 1;

2140 
exã¡_buf„r
 *
eb
 = 
eb_ö
;

2141 
båfs_key
 
found_key
;

2142 
båfs_öode_ªf
 *
úef
;

2144 i‡(
byãs_À·
 >= 0)

2145 
de°
[
byãs_À·
] = '\0';

2148 
byãs_À·
 -
«me_Àn
;

2149 i‡(
byãs_À·
 >= 0)

2150 
	`ªad_exã¡_buf„r
(
eb
, 
de°
 + 
byãs_À·
,

2151 
«me_off
, 
«me_Àn
);

2152 i‡(
eb
 !
eb_ö
) {

2153 i‡(!
∑th
->
skù_lockög
)

2154 
	`båfs_åì_ªad_u∆ock
(
eb
);

2155 
	`‰ì_exã¡_buf„r
(
eb
);

2157 
ªt
 = 
	`båfs_föd_ôem
(
fs_roŸ
, 
∑th
, 
∑ª¡
, 0,

2158 
BTRFS_INODE_REF_KEY
, &
found_key
);

2159 i‡(
ªt
 > 0)

2160 
ªt
 = -
ENOENT
;

2161 i‡(
ªt
)

2164 
√xt_öum
 = 
found_key
.
off£t
;

2167 i‡(
∑ª¡
 =
√xt_öum
)

2170 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

2171 
eb
 = 
∑th
->
nodes
[0];

2173 i‡(
eb
 !
eb_ö
) {

2174 
∑th
->
nodes
[0] = 
NULL
;

2175 
∑th
->
locks
[0] = 0;

2177 
	`båfs_ªÀa£_∑th
(
∑th
);

2178 
úef
 = 
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
, 
båfs_öode_ªf
);

2180 
«me_Àn
 = 
	`båfs_öode_ªf_«me_Àn
(
eb
, 
úef
);

2181 
«me_off
 = ()(
úef
 + 1);

2183 
∑ª¡
 = 
√xt_öum
;

2184 --
byãs_À·
;

2185 i‡(
byãs_À·
 >= 0)

2186 
de°
[
byãs_À·
] = '/';

2189 
	`båfs_ªÀa£_∑th
(
∑th
);

2191 i‡(
ªt
)

2192  
	`ERR_PTR
(
ªt
);

2194  
de°
 + 
byãs_À·
;

2195 
	}
}

2202 
	$exã¡_‰om_logiˇl
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
logiˇl
,

2203 
båfs_∑th
 *
∑th
, 
båfs_key
 *
found_key
,

2204 
u64
 *
Êags_ªt
)

2206 
båfs_roŸ
 *
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
, 
logiˇl
);

2207 
ªt
;

2208 
u64
 
Êags
;

2209 
u64
 
size
 = 0;

2210 
u32
 
ôem_size
;

2211 c⁄° 
exã¡_buf„r
 *
eb
;

2212 
båfs_exã¡_ôem
 *
ei
;

2213 
båfs_key
 
key
;

2215 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
SKINNY_METADATA
))

2216 
key
.
ty≥
 = 
BTRFS_METADATA_ITEM_KEY
;

2218 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

2219 
key
.
obje˘id
 = 
logiˇl
;

2220 
key
.
off£t
 = (
u64
)-1;

2222 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
exã¡_roŸ
, &
key
, 
∑th
, 0, 0);

2223 i‡(
ªt
 < 0)

2224  
ªt
;

2226 
ªt
 = 
	`båfs_¥evious_exã¡_ôem
(
exã¡_roŸ
, 
∑th
, 0);

2227 i‡(
ªt
) {

2228 i‡(
ªt
 > 0)

2229 
ªt
 = -
ENOENT
;

2230  
ªt
;

2232 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], 
found_key
,Ö©h->
¶Ÿs
[0]);

2233 i‡(
found_key
->
ty≥
 =
BTRFS_METADATA_ITEM_KEY
)

2234 
size
 = 
fs_öfo
->
nodesize
;

2235 i‡(
found_key
->
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
)

2236 
size
 = 
found_key
->
off£t
;

2238 i‡(
found_key
->
obje˘id
 > 
logiˇl
 ||

2239 
found_key
->
obje˘id
 + 
size
 <
logiˇl
) {

2240 
	`båfs_debug
(
fs_öfo
,

2241 "logiˇ»%Œu i†nŸ wôhöányÉxã¡", 
logiˇl
);

2242  -
ENOENT
;

2245 
eb
 = 
∑th
->
nodes
[0];

2246 
ôem_size
 = 
	`båfs_ôem_size
(
eb
, 
∑th
->
¶Ÿs
[0]);

2247 
	`BUG_ON
(
ôem_size
 < (*
ei
));

2249 
ei
 = 
	`båfs_ôem_±r
(
eb
, 
∑th
->
¶Ÿs
[0], 
båfs_exã¡_ôem
);

2250 
Êags
 = 
	`båfs_exã¡_Êags
(
eb
, 
ei
);

2252 
	`båfs_debug
(
fs_öfo
,

2254 
logiˇl
,Üogiˇ»- 
found_key
->
obje˘id
, found_key->objectid,

2255 
found_key
->
off£t
, 
Êags
, 
ôem_size
);

2257 
	`WARN_ON
(!
Êags_ªt
);

2258 i‡(
Êags_ªt
) {

2259 i‡(
Êags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
)

2260 *
Êags_ªt
 = 
BTRFS_EXTENT_FLAG_TREE_BLOCK
;

2261 i‡(
Êags
 & 
BTRFS_EXTENT_FLAG_DATA
)

2262 *
Êags_ªt
 = 
BTRFS_EXTENT_FLAG_DATA
;

2264 
	`BUG
();

2268  -
EIO
;

2269 
	}
}

2279 
	$gë_exã¡_ölöe_ªf
(*
±r
,

2280 c⁄° 
exã¡_buf„r
 *
eb
,

2281 c⁄° 
båfs_key
 *
key
,

2282 c⁄° 
båfs_exã¡_ôem
 *
ei
,

2283 
u32
 
ôem_size
,

2284 
båfs_exã¡_ölöe_ªf
 **
out_eúef
,

2285 *
out_ty≥
)

2287 
íd
;

2288 
u64
 
Êags
;

2289 
båfs_åì_block_öfo
 *
öfo
;

2291 i‡(!*
±r
) {

2293 
Êags
 = 
	`båfs_exã¡_Êags
(
eb
, 
ei
);

2294 i‡(
Êags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

2295 i‡(
key
->
ty≥
 =
BTRFS_METADATA_ITEM_KEY
) {

2297 *
out_eúef
 =

2298 (
båfs_exã¡_ölöe_ªf
 *)(
ei
 + 1);

2300 
	`WARN_ON
(
key
->
ty≥
 !
BTRFS_EXTENT_ITEM_KEY
);

2301 
öfo
 = (
båfs_åì_block_öfo
 *)(
ei
 + 1);

2302 *
out_eúef
 =

2303 (
båfs_exã¡_ölöe_ªf
 *)(
öfo
 + 1);

2306 *
out_eúef
 = (
båfs_exã¡_ölöe_ªf
 *)(
ei
 + 1);

2308 *
±r
 = ()*
out_eúef
;

2309 i‡(()(*
±r
Ë>()
ei
 + 
ôem_size
)

2310  -
ENOENT
;

2313 
íd
 = ()
ei
 + 
ôem_size
;

2314 *
out_eúef
 = (
båfs_exã¡_ölöe_ªf
 *)(*
±r
);

2315 *
out_ty≥
 = 
	`båfs_gë_exã¡_ölöe_ªf_ty≥
(
eb
, *
out_eúef
,

2316 
BTRFS_REF_TYPE_ANY
);

2317 i‡(*
out_ty≥
 =
BTRFS_REF_TYPE_INVALID
)

2318  -
EUCLEAN
;

2320 *
±r
 +
	`båfs_exã¡_ölöe_ªf_size
(*
out_ty≥
);

2321 
	`WARN_ON
(*
±r
 > 
íd
);

2322 i‡(*
±r
 =
íd
)

2326 
	}
}

2335 
	$åì_backªf_f‹_exã¡
(*
±r
, 
exã¡_buf„r
 *
eb
,

2336 
båfs_key
 *
key
, 
båfs_exã¡_ôem
 *
ei
,

2337 
u32
 
ôem_size
, 
u64
 *
out_roŸ
, 
u8
 *
out_Àvñ
)

2339 
ªt
;

2340 
ty≥
;

2341 
båfs_exã¡_ölöe_ªf
 *
eúef
;

2343 i‡(*
±r
 == ()-1)

2347 
ªt
 = 
	`gë_exã¡_ölöe_ªf
(
±r
, 
eb
, 
key
, 
ei
, 
ôem_size
,

2348 &
eúef
, &
ty≥
);

2349 i‡(
ªt
 < 0)

2350  
ªt
;

2352 i‡(
ty≥
 =
BTRFS_TREE_BLOCK_REF_KEY
 ||

2353 
ty≥
 =
BTRFS_SHARED_BLOCK_REF_KEY
)

2356 i‡(
ªt
 == 1)

2361 *
out_roŸ
 = 
	`båfs_exã¡_ölöe_ªf_off£t
(
eb
, 
eúef
);

2363 i‡(
key
->
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
) {

2364 
båfs_åì_block_öfo
 *
öfo
;

2366 
öfo
 = (
båfs_åì_block_öfo
 *)(
ei
 + 1);

2367 *
out_Àvñ
 = 
	`båfs_åì_block_Àvñ
(
eb
, 
öfo
);

2369 
	`ASSERT
(
key
->
ty≥
 =
BTRFS_METADATA_ITEM_KEY
);

2370 *
out_Àvñ
 = (
u8
)
key
->
off£t
;

2373 i‡(
ªt
 == 1)

2374 *
±r
 = ()-1;

2377 
	}
}

2379 
	$ôî©e_Àaf_ªfs
(
båfs_fs_öfo
 *
fs_öfo
,

2380 
exã¡_öode_ñem
 *
öode_li°
,

2381 
u64
 
roŸ
, u64 
exã¡_ôem_obje˘id
,

2382 
ôî©e_exã¡_öodes_t
 *
ôî©e
, *
˘x
)

2384 
exã¡_öode_ñem
 *
eõ
;

2385 
ªt
 = 0;

2387 
eõ
 = 
öode_li°
;Éõ;Éõ =Éõ->
√xt
) {

2388 
	`båfs_debug
(
fs_öfo
,

2390 
exã¡_ôem_obje˘id
, 
eõ
->
öum
,

2391 
eõ
->
off£t
, 
roŸ
);

2392 
ªt
 = 
	`ôî©e
(
eõ
->
öum
,Éõ->
off£t
,Éõ->
num_byãs
, 
roŸ
, 
˘x
);

2393 i‡(
ªt
) {

2394 
	`båfs_debug
(
fs_öfo
,

2396 
exã¡_ôem_obje˘id
, 
ªt
);

2401  
ªt
;

2402 
	}
}

2409 
	$ôî©e_exã¡_öodes
(
båfs_backªf_wÆk_˘x
 *
˘x
,

2410 
boﬁ
 
£¨ch_commô_roŸ
,

2411 
ôî©e_exã¡_öodes_t
 *
ôî©e
, *
u£r_˘x
)

2413 
ªt
;

2414 
uli°
 *
ªfs
;

2415 
uli°_node
 *
ªf_node
;

2416 
båfs_£q_li°
 
£q_ñem
 = 
	`BTRFS_SEQ_LIST_INIT
(seq_elem);

2417 
uli°_ôî©‹
 
ªf_uôî
;

2419 
	`båfs_debug
(
˘x
->
fs_öfo
, "resolvingáll inodes forÉxtent %llu",

2420 
˘x
->
byãƒ
);

2422 
	`ASSERT
(
˘x
->
å™s
 =
NULL
);

2423 
	`ASSERT
(
˘x
->
roŸs
 =
NULL
);

2425 i‡(!
£¨ch_commô_roŸ
) {

2426 
båfs_å™s_h™dÀ
 *
å™s
;

2428 
å™s
 = 
	`båfs_©èch_å™ß˘i⁄
(
˘x
->
fs_öfo
->
åì_roŸ
);

2429 i‡(
	`IS_ERR
(
å™s
)) {

2430 i‡(
	`PTR_ERR
(
å™s
Ë!-
ENOENT
 &&

2431 
	`PTR_ERR
(
å™s
Ë!-
EROFS
)

2432  
	`PTR_ERR
(
å™s
);

2433 
å™s
 = 
NULL
;

2435 
˘x
->
å™s
 =Årans;

2438 i‡(
˘x
->
å™s
) {

2439 
	`båfs_gë_åì_mod_£q
(
˘x
->
fs_öfo
, &
£q_ñem
);

2440 
˘x
->
time_£q
 = 
£q_ñem
.
£q
;

2442 
	`down_ªad
(&
˘x
->
fs_öfo
->
commô_roŸ_£m
);

2445 
ªt
 = 
	`båfs_föd_Æl_Àafs
(
˘x
);

2446 i‡(
ªt
)

2447 
out
;

2448 
ªfs
 = 
˘x
->refs;

2449 
˘x
->
ªfs
 = 
NULL
;

2451 
	`ULIST_ITER_INIT
(&
ªf_uôî
);

2452 !
ªt
 && (
ªf_node
 = 
	`uli°_√xt
(
ªfs
, &
ªf_uôî
))) {

2453 c⁄° 
u64
 
Àaf_byãƒ
 = 
ªf_node
->
vÆ
;

2454 
uli°_node
 *
roŸ_node
;

2455 
uli°_ôî©‹
 
roŸ_uôî
;

2456 
exã¡_öode_ñem
 *
öode_li°
;

2458 
öode_li°
 = (
exã¡_öode_ñem
 *)(
uöçå_t
)
ªf_node
->
aux
;

2460 i‡(
˘x
->
ˇche_lookup
) {

2461 c⁄° 
u64
 *
roŸ_ids
;

2462 
roŸ_cou¡
;

2463 
boﬁ
 
ˇched
;

2465 
ˇched
 = 
˘x
->
	`ˇche_lookup
(
Àaf_byãƒ
, ctx->
u£r_˘x
,

2466 &
roŸ_ids
, &
roŸ_cou¡
);

2467 i‡(
ˇched
) {

2468 
i
 = 0; i < 
roŸ_cou¡
; i++) {

2469 
ªt
 = 
	`ôî©e_Àaf_ªfs
(
˘x
->
fs_öfo
,

2470 
öode_li°
,

2471 
roŸ_ids
[
i
],

2472 
Àaf_byãƒ
,

2473 
ôî©e
,

2474 
u£r_˘x
);

2475 i‡(
ªt
)

2482 i‡(!
˘x
->
roŸs
) {

2483 
˘x
->
roŸs
 = 
	`uli°_Æloc
(
GFP_NOFS
);

2484 i‡(!
˘x
->
roŸs
) {

2485 
ªt
 = -
ENOMEM
;

2490 
˘x
->
byãƒ
 = 
Àaf_byãƒ
;

2491 
ªt
 = 
	`båfs_föd_Æl_roŸs_ß„
(
˘x
);

2492 i‡(
ªt
)

2495 i‡(
˘x
->
ˇche_°‹e
)

2496 
˘x
->
	`ˇche_°‹e
(
Àaf_byãƒ
, ctx->
roŸs
, ctx->
u£r_˘x
);

2498 
	`ULIST_ITER_INIT
(&
roŸ_uôî
);

2499 !
ªt
 && (
roŸ_node
 = 
	`uli°_√xt
(
˘x
->
roŸs
, &
roŸ_uôî
))) {

2500 
	`båfs_debug
(
˘x
->
fs_öfo
,

2502 
roŸ_node
->
vÆ
, 
ªf_node
->val,

2503 
ªf_node
->
aux
);

2504 
ªt
 = 
	`ôî©e_Àaf_ªfs
(
˘x
->
fs_öfo
, 
öode_li°
,

2505 
roŸ_node
->
vÆ
, 
˘x
->
byãƒ
,

2506 
ôî©e
, 
u£r_˘x
);

2508 
	`uli°_ªöô
(
˘x
->
roŸs
);

2511 
	`‰ì_Àaf_li°
(
ªfs
);

2512 
out
:

2513 i‡(
˘x
->
å™s
) {

2514 
	`båfs_put_åì_mod_£q
(
˘x
->
fs_öfo
, &
£q_ñem
);

2515 
	`båfs_íd_å™ß˘i⁄
(
˘x
->
å™s
);

2516 
˘x
->
å™s
 = 
NULL
;

2518 
	`up_ªad
(&
˘x
->
fs_öfo
->
commô_roŸ_£m
);

2521 
	`uli°_‰ì
(
˘x
->
roŸs
);

2522 
˘x
->
roŸs
 = 
NULL
;

2524 i‡(
ªt
 =
BTRFS_ITERATE_EXTENT_INODES_STOP
)

2525 
ªt
 = 0;

2527  
ªt
;

2528 
	}
}

2530 
	$buûd_öo_li°
(
u64
 
öum
, u64 
off£t
, u64 
num_byãs
, u64 
roŸ
, *
˘x
)

2532 
båfs_d©a_c⁄èöî
 *
öodes
 = 
˘x
;

2533 c⁄° 
size_t
 
c
 = 3 * (
u64
);

2535 i‡(
öodes
->
byãs_À·
 >
c
) {

2536 
öodes
->
byãs_À·
 -
c
;

2537 
öodes
->
vÆ
[öodes->
ñem_˙t
] = 
öum
;

2538 
öodes
->
vÆ
[öodes->
ñem_˙t
 + 1] = 
off£t
;

2539 
öodes
->
vÆ
[öodes->
ñem_˙t
 + 2] = 
roŸ
;

2540 
öodes
->
ñem_˙t
 += 3;

2542 
öodes
->
byãs_missög
 +
c
 - inodes->
byãs_À·
;

2543 
öodes
->
byãs_À·
 = 0;

2544 
öodes
->
ñem_mis£d
 += 3;

2548 
	}
}

2550 
	$ôî©e_öodes_‰om_logiˇl
(
u64
 
logiˇl
, 
båfs_fs_öfo
 *
fs_öfo
,

2551 
båfs_∑th
 *
∑th
,

2552 *
˘x
, 
boﬁ
 
ign‹e_off£t
)

2554 
båfs_backªf_wÆk_˘x
 
wÆk_˘x
 = { 0 };

2555 
ªt
;

2556 
u64
 
Êags
 = 0;

2557 
båfs_key
 
found_key
;

2558 
£¨ch_commô_roŸ
 = 
∑th
->search_commit_root;

2560 
ªt
 = 
	`exã¡_‰om_logiˇl
(
fs_öfo
, 
logiˇl
, 
∑th
, &
found_key
, &
Êags
);

2561 
	`båfs_ªÀa£_∑th
(
∑th
);

2562 i‡(
ªt
 < 0)

2563  
ªt
;

2564 i‡(
Êags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
)

2565  -
EINVAL
;

2567 
wÆk_˘x
.
byãƒ
 = 
found_key
.
obje˘id
;

2568 i‡(
ign‹e_off£t
)

2569 
wÆk_˘x
.
ign‹e_exã¡_ôem_pos
 = 
åue
;

2571 
wÆk_˘x
.
exã¡_ôem_pos
 = 
logiˇl
 - 
found_key
.
obje˘id
;

2572 
wÆk_˘x
.
fs_öfo
 = fs_info;

2574  
	`ôî©e_exã¡_öodes
(&
wÆk_˘x
, 
£¨ch_commô_roŸ
,

2575 
buûd_öo_li°
, 
˘x
);

2576 
	}
}

2578 
öode_to_∑th
(
u64
 
öum
, 
u32
 
«me_Àn
, 
«me_off
,

2579 
exã¡_buf„r
 *
eb
, 
öode_fs_∑ths
 *
ù©h
);

2581 
	$ôî©e_öode_ªfs
(
u64
 
öum
, 
öode_fs_∑ths
 *
ù©h
)

2583 
ªt
 = 0;

2584 
¶Ÿ
;

2585 
u32
 
cur
;

2586 
u32
 
Àn
;

2587 
u32
 
«me_Àn
;

2588 
u64
 
∑ª¡
 = 0;

2589 
found
 = 0;

2590 
båfs_roŸ
 *
fs_roŸ
 = 
ù©h
->fs_root;

2591 
båfs_∑th
 *
∑th
 = 
ù©h
->btrfs_path;

2592 
exã¡_buf„r
 *
eb
;

2593 
båfs_öode_ªf
 *
úef
;

2594 
båfs_key
 
found_key
;

2596 !
ªt
) {

2597 
ªt
 = 
	`båfs_föd_ôem
(
fs_roŸ
, 
∑th
, 
öum
,

2598 
∑ª¡
 ?Ö¨íà+ 1 : 0, 
BTRFS_INODE_REF_KEY
,

2599 &
found_key
);

2601 i‡(
ªt
 < 0)

2603 i‡(
ªt
) {

2604 
ªt
 = 
found
 ? 0 : -
ENOENT
;

2607 ++
found
;

2609 
∑ª¡
 = 
found_key
.
off£t
;

2610 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

2611 
eb
 = 
	`båfs_˛⁄e_exã¡_buf„r
(
∑th
->
nodes
[0]);

2612 i‡(!
eb
) {

2613 
ªt
 = -
ENOMEM
;

2616 
	`båfs_ªÀa£_∑th
(
∑th
);

2618 
úef
 = 
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
, 
båfs_öode_ªf
);

2620 
cur
 = 0; cu∏< 
	`båfs_ôem_size
(
eb
, 
¶Ÿ
); cu∏+
Àn
) {

2621 
«me_Àn
 = 
	`båfs_öode_ªf_«me_Àn
(
eb
, 
úef
);

2623 
	`båfs_debug
(
fs_roŸ
->
fs_öfo
,

2625 
cur
, 
found_key
.
obje˘id
,

2626 
fs_roŸ
->
roŸ_key
.
obje˘id
);

2627 
ªt
 = 
	`öode_to_∑th
(
∑ª¡
, 
«me_Àn
,

2628 ()(
úef
 + 1), 
eb
, 
ù©h
);

2629 i‡(
ªt
)

2631 
Àn
 = (*
úef
Ë+ 
«me_Àn
;

2632 
úef
 = (
båfs_öode_ªf
 *)((*)úe‡+ 
Àn
);

2634 
	`‰ì_exã¡_buf„r
(
eb
);

2637 
	`båfs_ªÀa£_∑th
(
∑th
);

2639  
ªt
;

2640 
	}
}

2642 
	$ôî©e_öode_exåefs
(
u64
 
öum
, 
öode_fs_∑ths
 *
ù©h
)

2644 
ªt
;

2645 
¶Ÿ
;

2646 
u64
 
off£t
 = 0;

2647 
u64
 
∑ª¡
;

2648 
found
 = 0;

2649 
båfs_roŸ
 *
fs_roŸ
 = 
ù©h
->fs_root;

2650 
båfs_∑th
 *
∑th
 = 
ù©h
->btrfs_path;

2651 
exã¡_buf„r
 *
eb
;

2652 
båfs_öode_exåef
 *
exåef
;

2653 
u32
 
ôem_size
;

2654 
u32
 
cur_off£t
;

2655 
±r
;

2658 
ªt
 = 
	`båfs_föd_⁄e_exåef
(
fs_roŸ
, 
öum
, 
off£t
, 
∑th
, &
exåef
,

2659 &
off£t
);

2660 i‡(
ªt
 < 0)

2662 i‡(
ªt
) {

2663 
ªt
 = 
found
 ? 0 : -
ENOENT
;

2666 ++
found
;

2668 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

2669 
eb
 = 
	`båfs_˛⁄e_exã¡_buf„r
(
∑th
->
nodes
[0]);

2670 i‡(!
eb
) {

2671 
ªt
 = -
ENOMEM
;

2674 
	`båfs_ªÀa£_∑th
(
∑th
);

2676 
ôem_size
 = 
	`båfs_ôem_size
(
eb
, 
¶Ÿ
);

2677 
±r
 = 
	`båfs_ôem_±r_off£t
(
eb
, 
¶Ÿ
);

2678 
cur_off£t
 = 0;

2680 
cur_off£t
 < 
ôem_size
) {

2681 
u32
 
«me_Àn
;

2683 
exåef
 = (
båfs_öode_exåef
 *)(
±r
 + 
cur_off£t
);

2684 
∑ª¡
 = 
	`båfs_öode_exåef_∑ª¡
(
eb
, 
exåef
);

2685 
«me_Àn
 = 
	`båfs_öode_exåef_«me_Àn
(
eb
, 
exåef
);

2686 
ªt
 = 
	`öode_to_∑th
(
∑ª¡
, 
«me_Àn
,

2687 ()&
exåef
->
«me
, 
eb
, 
ù©h
);

2688 i‡(
ªt
)

2691 
cur_off£t
 +
	`båfs_öode_exåef_«me_Àn
(
eb
, 
exåef
);

2692 
cur_off£t
 +(*
exåef
);

2694 
	`‰ì_exã¡_buf„r
(
eb
);

2696 
off£t
++;

2699 
	`båfs_ªÀa£_∑th
(
∑th
);

2701  
ªt
;

2702 
	}
}

2708 
	$öode_to_∑th
(
u64
 
öum
, 
u32
 
«me_Àn
, 
«me_off
,

2709 
exã¡_buf„r
 *
eb
, 
öode_fs_∑ths
 *
ù©h
)

2711 *
f•©h
;

2712 *
f•©h_mö
;

2713 
i
 = 
ù©h
->
f•©h
->
ñem_˙t
;

2714 c⁄° 
s_±r
 = (*);

2715 
u32
 
byãs_À·
;

2717 
byãs_À·
 = 
ù©h
->
f•©h
->byãs_À· > 
s_±r
 ?

2718 
ù©h
->
f•©h
->
byãs_À·
 - 
s_±r
 : 0;

2720 
f•©h_mö
 = (*)
ù©h
->
f•©h
->
vÆ
 + (
i
 + 1Ë* 
s_±r
;

2721 
f•©h
 = 
	`båfs_ªf_to_∑th
(
ù©h
->
fs_roŸ
, i∑th->
båfs_∑th
, 
«me_Àn
,

2722 
«me_off
, 
eb
, 
öum
, 
f•©h_mö
, 
byãs_À·
);

2723 i‡(
	`IS_ERR
(
f•©h
))

2724  
	`PTR_ERR
(
f•©h
);

2726 i‡(
f•©h
 > 
f•©h_mö
) {

2727 
ù©h
->
f•©h
->
vÆ
[
i
] = (
u64
)()fspath;

2728 ++
ù©h
->
f•©h
->
ñem_˙t
;

2729 
ù©h
->
f•©h
->
byãs_À·
 = f•©h - 
f•©h_mö
;

2731 ++
ù©h
->
f•©h
->
ñem_mis£d
;

2732 
ù©h
->
f•©h
->
byãs_missög
 +
f•©h_mö
 - fspath;

2733 
ù©h
->
f•©h
->
byãs_À·
 = 0;

2737 
	}
}

2749 
	$∑ths_‰om_öode
(
u64
 
öum
, 
öode_fs_∑ths
 *
ù©h
)

2751 
ªt
;

2752 
found_ªfs
 = 0;

2754 
ªt
 = 
	`ôî©e_öode_ªfs
(
öum
, 
ù©h
);

2755 i‡(!
ªt
)

2756 ++
found_ªfs
;

2757 i‡(
ªt
 !-
ENOENT
)

2758  
ªt
;

2760 
ªt
 = 
	`ôî©e_öode_exåefs
(
öum
, 
ù©h
);

2761 i‡(
ªt
 =-
ENOENT
 && 
found_ªfs
)

2764  
ªt
;

2765 
	}
}

2767 
båfs_d©a_c⁄èöî
 *
	$öô_d©a_c⁄èöî
(
u32
 
tŸÆ_byãs
)

2769 
båfs_d©a_c⁄èöî
 *
d©a
;

2770 
size_t
 
Æloc_byãs
;

2772 
Æloc_byãs
 = 
	`max_t
(
size_t
, 
tŸÆ_byãs
, (*
d©a
));

2773 
d©a
 = 
	`kvmÆloc
(
Æloc_byãs
, 
GFP_KERNEL
);

2774 i‡(!
d©a
)

2775  
	`ERR_PTR
(-
ENOMEM
);

2777 i‡(
tŸÆ_byãs
 >(*
d©a
)) {

2778 
d©a
->
byãs_À·
 = 
tŸÆ_byãs
 - (*data);

2779 
d©a
->
byãs_missög
 = 0;

2781 
d©a
->
byãs_missög
 = (*d©aË- 
tŸÆ_byãs
;

2782 
d©a
->
byãs_À·
 = 0;

2785 
d©a
->
ñem_˙t
 = 0;

2786 
d©a
->
ñem_mis£d
 = 0;

2788  
d©a
;

2789 
	}
}

2797 
öode_fs_∑ths
 *
	$öô_ù©h
(
s32
 
tŸÆ_byãs
, 
båfs_roŸ
 *
fs_roŸ
,

2798 
båfs_∑th
 *
∑th
)

2800 
öode_fs_∑ths
 *
iÂ
;

2801 
båfs_d©a_c⁄èöî
 *
f•©h
;

2803 
f•©h
 = 
	`öô_d©a_c⁄èöî
(
tŸÆ_byãs
);

2804 i‡(
	`IS_ERR
(
f•©h
))

2805  
	`ERR_CAST
(
f•©h
);

2807 
iÂ
 = 
	`kmÆloc
((*iÂ), 
GFP_KERNEL
);

2808 i‡(!
iÂ
) {

2809 
	`kv‰ì
(
f•©h
);

2810  
	`ERR_PTR
(-
ENOMEM
);

2813 
iÂ
->
båfs_∑th
 = 
∑th
;

2814 
iÂ
->
f•©h
 = fspath;

2815 
iÂ
->
fs_roŸ
 = fs_root;

2817  
iÂ
;

2818 
	}
}

2820 
	$‰ì_ù©h
(
öode_fs_∑ths
 *
ù©h
)

2822 i‡(!
ù©h
)

2824 
	`kv‰ì
(
ù©h
->
f•©h
);

2825 
	`k‰ì
(
ù©h
);

2826 
	}
}

2828 
båfs_backªf_ôî
 *
	$båfs_backªf_ôî_Æloc
(
båfs_fs_öfo
 *
fs_öfo
)

2830 
båfs_backªf_ôî
 *
ªt
;

2832 
ªt
 = 
	`kzÆloc
((*ªt), 
GFP_NOFS
);

2833 i‡(!
ªt
)

2834  
NULL
;

2836 
ªt
->
∑th
 = 
	`båfs_Æloc_∑th
();

2837 i‡(!
ªt
->
∑th
) {

2838 
	`k‰ì
(
ªt
);

2839  
NULL
;

2843 
ªt
->
∑th
->
£¨ch_commô_roŸ
 = 1;

2844 
ªt
->
∑th
->
skù_lockög
 = 1;

2845 
ªt
->
fs_öfo
 = fs_info;

2847  
ªt
;

2848 
	}
}

2850 
	$båfs_backªf_ôî_°¨t
(
båfs_backªf_ôî
 *
ôî
, 
u64
 
byãƒ
)

2852 
båfs_fs_öfo
 *
fs_öfo
 = 
ôî
->fs_info;

2853 
båfs_roŸ
 *
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
, 
byãƒ
);

2854 
båfs_∑th
 *
∑th
 = 
ôî
->path;

2855 
båfs_exã¡_ôem
 *
ei
;

2856 
båfs_key
 
key
;

2857 
ªt
;

2859 
key
.
obje˘id
 = 
byãƒ
;

2860 
key
.
ty≥
 = 
BTRFS_METADATA_ITEM_KEY
;

2861 
key
.
off£t
 = (
u64
)-1;

2862 
ôî
->
byãƒ
 = bytenr;

2864 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
exã¡_roŸ
, &
key
, 
∑th
, 0, 0);

2865 i‡(
ªt
 < 0)

2866  
ªt
;

2867 i‡(
ªt
 == 0) {

2868 
ªt
 = -
EUCLEAN
;

2869 
ªÀa£
;

2871 i‡(
∑th
->
¶Ÿs
[0] == 0) {

2872 
	`WARN_ON
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
));

2873 
ªt
 = -
EUCLEAN
;

2874 
ªÀa£
;

2876 
∑th
->
¶Ÿs
[0]--;

2878 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

2879 i‡((
key
.
ty≥
 !
BTRFS_EXTENT_ITEM_KEY
 &&

2880 
key
.
ty≥
 !
BTRFS_METADATA_ITEM_KEY
Ë|| key.
obje˘id
 !
byãƒ
) {

2881 
ªt
 = -
ENOENT
;

2882 
ªÀa£
;

2884 
	`mem˝y
(&
ôî
->
cur_key
, &
key
, (key));

2885 
ôî
->
ôem_±r
 = (
u32
)
	`båfs_ôem_±r_off£t
(
∑th
->
nodes
[0],

2886 
∑th
->
¶Ÿs
[0]);

2887 
ôî
->
íd_±r
 = (
u32
)(ôî->
ôem_±r
 +

2888 
	`båfs_ôem_size
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0]));

2889 
ei
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

2890 
båfs_exã¡_ôem
);

2899 i‡(
	`båfs_exã¡_Êags
(
∑th
->
nodes
[0], 
ei
Ë& 
BTRFS_EXTENT_FLAG_DATA
) {

2900 
ªt
 = -
ENOTSUPP
;

2901 
ªÀa£
;

2903 
ôî
->
cur_±r
 = (
u32
)(ôî->
ôem_±r
 + (*
ei
));

2906 i‡(
ôî
->
cur_±r
 >ôî->
íd_±r
) {

2907 
ªt
 = 
	`båfs_√xt_ôem
(
exã¡_roŸ
, 
∑th
);

2910 i‡(
ªt
 > 0) {

2911 
ªt
 = -
ENOENT
;

2912 
ªÀa£
;

2914 i‡(
ªt
 < 0)

2915 
ªÀa£
;

2917 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
ôî
->
cur_key
,

2918 
∑th
->
¶Ÿs
[0]);

2919 i‡(
ôî
->
cur_key
.
obje˘id
 !
byãƒ
 ||

2920 (
ôî
->
cur_key
.
ty≥
 !
BTRFS_SHARED_BLOCK_REF_KEY
 &&

2921 
ôî
->
cur_key
.
ty≥
 !
BTRFS_TREE_BLOCK_REF_KEY
)) {

2922 
ªt
 = -
ENOENT
;

2923 
ªÀa£
;

2925 
ôî
->
cur_±r
 = (
u32
)
	`båfs_ôem_±r_off£t
(
∑th
->
nodes
[0],

2926 
∑th
->
¶Ÿs
[0]);

2927 
ôî
->
ôem_±r
 = iãr->
cur_±r
;

2928 
ôî
->
íd_±r
 = (
u32
)(ôî->
ôem_±r
 + 
	`båfs_ôem_size
(

2929 
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0]));

2933 
ªÀa£
:

2934 
	`båfs_backªf_ôî_ªÀa£
(
ôî
);

2935  
ªt
;

2936 
	}
}

2948 
	$båfs_backªf_ôî_√xt
(
båfs_backªf_ôî
 *
ôî
)

2950 
exã¡_buf„r
 *
eb
 = 
	`båfs_backªf_gë_eb
(
ôî
);

2951 
båfs_roŸ
 *
exã¡_roŸ
;

2952 
båfs_∑th
 *
∑th
 = 
ôî
->path;

2953 
båfs_exã¡_ölöe_ªf
 *
úef
;

2954 
ªt
;

2955 
u32
 
size
;

2957 i‡(
	`båfs_backªf_ôî_is_ölöe_ªf
(
ôî
)) {

2959 
	`ASSERT
(
ôî
->
cur_±r
 < iãr->
íd_±r
);

2961 i‡(
	`båfs_backªf_has_åì_block_öfo
(
ôî
)) {

2963 
size
 = (
båfs_åì_block_öfo
);

2966 
ty≥
;

2968 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)

2969 (()
ôî
->
cur_±r
);

2970 
ty≥
 = 
	`båfs_exã¡_ölöe_ªf_ty≥
(
eb
, 
úef
);

2972 
size
 = 
	`båfs_exã¡_ölöe_ªf_size
(
ty≥
);

2974 
ôî
->
cur_±r
 +
size
;

2975 i‡(
ôî
->
cur_±r
 < iãr->
íd_±r
)

2982 
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
ôî
->
fs_öfo
, iãr->
byãƒ
);

2983 
ªt
 = 
	`båfs_√xt_ôem
(
exã¡_roŸ
, 
ôî
->
∑th
);

2984 i‡(
ªt
)

2985  
ªt
;

2987 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
ôî
->
cur_key
,Ö©h->
¶Ÿs
[0]);

2988 i‡(
ôî
->
cur_key
.
obje˘id
 !ôî->
byãƒ
 ||

2989 (
ôî
->
cur_key
.
ty≥
 !
BTRFS_TREE_BLOCK_REF_KEY
 &&

2990 
ôî
->
cur_key
.
ty≥
 !
BTRFS_SHARED_BLOCK_REF_KEY
))

2992 
ôî
->
ôem_±r
 = (
u32
)
	`båfs_ôem_±r_off£t
(
∑th
->
nodes
[0],

2993 
∑th
->
¶Ÿs
[0]);

2994 
ôî
->
cur_±r
 = iãr->
ôem_±r
;

2995 
ôî
->
íd_±r
 = iãr->
ôem_±r
 + (
u32
)
	`båfs_ôem_size
(
∑th
->
nodes
[0],

2996 
∑th
->
¶Ÿs
[0]);

2998 
	}
}

3000 
	$båfs_backªf_öô_ˇche
(
båfs_fs_öfo
 *
fs_öfo
,

3001 
båfs_backªf_ˇche
 *
ˇche
, 
is_ªloc
)

3003 
i
;

3005 
ˇche
->
rb_roŸ
 = 
RB_ROOT
;

3006 
i
 = 0; i < 
BTRFS_MAX_LEVEL
; i++)

3007 
	`INIT_LIST_HEAD
(&
ˇche
->
≥ndög
[
i
]);

3008 
	`INIT_LIST_HEAD
(&
ˇche
->
ch™ged
);

3009 
	`INIT_LIST_HEAD
(&
ˇche
->
dëached
);

3010 
	`INIT_LIST_HEAD
(&
ˇche
->
Àaves
);

3011 
	`INIT_LIST_HEAD
(&
ˇche
->
≥ndög_edge
);

3012 
	`INIT_LIST_HEAD
(&
ˇche
->
u£Àss_node
);

3013 
ˇche
->
fs_öfo
 = fs_info;

3014 
ˇche
->
is_ªloc
 = is_reloc;

3015 
	}
}

3017 
båfs_backªf_node
 *
	$båfs_backªf_Æloc_node
(

3018 
båfs_backªf_ˇche
 *
ˇche
, 
u64
 
byãƒ
, 
Àvñ
)

3020 
båfs_backªf_node
 *
node
;

3022 
	`ASSERT
(
Àvñ
 >0 &&Üevñ < 
BTRFS_MAX_LEVEL
);

3023 
node
 = 
	`kzÆloc
((*node), 
GFP_NOFS
);

3024 i‡(!
node
)

3025  
node
;

3027 
	`INIT_LIST_HEAD
(&
node
->
li°
);

3028 
	`INIT_LIST_HEAD
(&
node
->
uµî
);

3029 
	`INIT_LIST_HEAD
(&
node
->
lowî
);

3030 
	`RB_CLEAR_NODE
(&
node
->
rb_node
);

3031 
ˇche
->
ƒ_nodes
++;

3032 
node
->
Àvñ
 =Üevel;

3033 
node
->
byãƒ
 = bytenr;

3035  
node
;

3036 
	}
}

3038 
båfs_backªf_edge
 *
	$båfs_backªf_Æloc_edge
(

3039 
båfs_backªf_ˇche
 *
ˇche
)

3041 
båfs_backªf_edge
 *
edge
;

3043 
edge
 = 
	`kzÆloc
((*edge), 
GFP_NOFS
);

3044 i‡(
edge
)

3045 
ˇche
->
ƒ_edges
++;

3046  
edge
;

3047 
	}
}

3056 
	$båfs_backªf_˛ónup_node
(
båfs_backªf_ˇche
 *
ˇche
,

3057 
båfs_backªf_node
 *
node
)

3059 
båfs_backªf_node
 *
uµî
;

3060 
båfs_backªf_edge
 *
edge
;

3062 i‡(!
node
)

3065 
	`BUG_ON
(!
node
->
lowe°
 && !node->
dëached
);

3066 !
	`li°_em±y
(&
node
->
uµî
)) {

3067 
edge
 = 
	`li°_íåy
(
node
->
uµî
.
√xt
, 
båfs_backªf_edge
,

3068 
li°
[
LOWER
]);

3069 
uµî
 = 
edge
->
node
[
UPPER
];

3070 
	`li°_dñ
(&
edge
->
li°
[
LOWER
]);

3071 
	`li°_dñ
(&
edge
->
li°
[
UPPER
]);

3072 
	`båfs_backªf_‰ì_edge
(
ˇche
, 
edge
);

3078 i‡(
	`li°_em±y
(&
uµî
->
lowî
)) {

3079 
	`li°_add_èû
(&
uµî
->
lowî
, &
ˇche
->
Àaves
);

3080 
uµî
->
lowe°
 = 1;

3084 
	`båfs_backªf_dr›_node
(
ˇche
, 
node
);

3085 
	}
}

3090 
	$båfs_backªf_ªÀa£_ˇche
(
båfs_backªf_ˇche
 *
ˇche
)

3092 
båfs_backªf_node
 *
node
;

3093 
i
;

3095 !
	`li°_em±y
(&
ˇche
->
dëached
)) {

3096 
node
 = 
	`li°_íåy
(
ˇche
->
dëached
.
√xt
,

3097 
båfs_backªf_node
, 
li°
);

3098 
	`båfs_backªf_˛ónup_node
(
ˇche
, 
node
);

3101 !
	`li°_em±y
(&
ˇche
->
Àaves
)) {

3102 
node
 = 
	`li°_íåy
(
ˇche
->
Àaves
.
√xt
,

3103 
båfs_backªf_node
, 
lowî
);

3104 
	`båfs_backªf_˛ónup_node
(
ˇche
, 
node
);

3107 
ˇche
->
œ°_å™s
 = 0;

3109 
i
 = 0; i < 
BTRFS_MAX_LEVEL
; i++)

3110 
	`ASSERT
(
	`li°_em±y
(&
ˇche
->
≥ndög
[
i
]));

3111 
	`ASSERT
(
	`li°_em±y
(&
ˇche
->
≥ndög_edge
));

3112 
	`ASSERT
(
	`li°_em±y
(&
ˇche
->
u£Àss_node
));

3113 
	`ASSERT
(
	`li°_em±y
(&
ˇche
->
ch™ged
));

3114 
	`ASSERT
(
	`li°_em±y
(&
ˇche
->
dëached
));

3115 
	`ASSERT
(
	`RB_EMPTY_ROOT
(&
ˇche
->
rb_roŸ
));

3116 
	`ASSERT
(!
ˇche
->
ƒ_nodes
);

3117 
	`ASSERT
(!
ˇche
->
ƒ_edges
);

3118 
	}
}

3132 
	$h™dÀ_dúe˘_åì_backªf
(
båfs_backªf_ˇche
 *
ˇche
,

3133 
båfs_key
 *
ªf_key
,

3134 
båfs_backªf_node
 *
cur
)

3136 
båfs_backªf_edge
 *
edge
;

3137 
båfs_backªf_node
 *
uµî
;

3138 
rb_node
 *rb_node;

3140 
	`ASSERT
(
ªf_key
->
ty≥
 =
BTRFS_SHARED_BLOCK_REF_KEY
);

3143 i‡(
ªf_key
->
obje˘id
 =ªf_key->
off£t
) {

3144 
båfs_roŸ
 *
roŸ
;

3146 
cur
->
is_ªloc_roŸ
 = 1;

3148 i‡(
ˇche
->
is_ªloc
) {

3149 
roŸ
 = 
	`föd_ªloc_roŸ
(
ˇche
->
fs_öfo
, 
cur
->
byãƒ
);

3150 i‡(!
roŸ
)

3151  -
ENOENT
;

3152 
cur
->
roŸ
 =Ñoot;

3158 
	`li°_add
(&
cur
->
li°
, &
ˇche
->
u£Àss_node
);

3163 
edge
 = 
	`båfs_backªf_Æloc_edge
(
ˇche
);

3164 i‡(!
edge
)

3165  -
ENOMEM
;

3167 
rb_node
 = 
	`rb_sim∂e_£¨ch
(&
ˇche
->
rb_roŸ
, 
ªf_key
->
off£t
);

3168 i‡(!
rb_node
) {

3170 
uµî
 = 
	`båfs_backªf_Æloc_node
(
ˇche
, 
ªf_key
->
off£t
,

3171 
cur
->
Àvñ
 + 1);

3172 i‡(!
uµî
) {

3173 
	`båfs_backªf_‰ì_edge
(
ˇche
, 
edge
);

3174  -
ENOMEM
;

3181 
	`li°_add_èû
(&
edge
->
li°
[
UPPER
], &
ˇche
->
≥ndög_edge
);

3184 
uµî
 = 
	`rb_íåy
(
rb_node
, 
båfs_backªf_node
,Ñb_node);

3185 
	`ASSERT
(
uµî
->
checked
);

3186 
	`INIT_LIST_HEAD
(&
edge
->
li°
[
UPPER
]);

3188 
	`båfs_backªf_lök_edge
(
edge
, 
cur
, 
uµî
, 
LINK_LOWER
);

3190 
	}
}

3205 
	$h™dÀ_ödúe˘_åì_backªf
(
båfs_å™s_h™dÀ
 *
å™s
,

3206 
båfs_backªf_ˇche
 *
ˇche
,

3207 
båfs_∑th
 *
∑th
,

3208 
båfs_key
 *
ªf_key
,

3209 
båfs_key
 *
åì_key
,

3210 
båfs_backªf_node
 *
cur
)

3212 
båfs_fs_öfo
 *
fs_öfo
 = 
ˇche
->fs_info;

3213 
båfs_backªf_node
 *
uµî
;

3214 
båfs_backªf_node
 *
lowî
;

3215 
båfs_backªf_edge
 *
edge
;

3216 
exã¡_buf„r
 *
eb
;

3217 
båfs_roŸ
 *
roŸ
;

3218 
rb_node
 *rb_node;

3219 
Àvñ
;

3220 
boﬁ
 
√ed_check
 = 
åue
;

3221 
ªt
;

3223 
roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
ªf_key
->
off£t
, 
Ál£
);

3224 i‡(
	`IS_ERR
(
roŸ
))

3225  
	`PTR_ERR
(
roŸ
);

3226 i‡(!
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
))

3227 
cur
->
cow⁄ly
 = 1;

3229 i‡(
	`båfs_roŸ_Àvñ
(&
roŸ
->
roŸ_ôem
Ë=
cur
->
Àvñ
) {

3231 
	`ASSERT
(
	`båfs_roŸ_byãƒ
(&
roŸ
->
roŸ_ôem
Ë=
cur
->
byãƒ
);

3242 i‡(
	`båfs_should_ign‹e_ªloc_roŸ
(
roŸ
Ë&& 
ˇche
->
is_ªloc
) {

3243 
	`båfs_put_roŸ
(
roŸ
);

3244 
	`li°_add
(&
cur
->
li°
, &
ˇche
->
u£Àss_node
);

3246 
cur
->
roŸ
 =Ñoot;

3251 
Àvñ
 = 
cur
->level + 1;

3254 
∑th
->
£¨ch_commô_roŸ
 = 1;

3255 
∑th
->
skù_lockög
 = 1;

3256 
∑th
->
lowe°_Àvñ
 = 
Àvñ
;

3257 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, 
åì_key
, 
∑th
, 0, 0);

3258 
∑th
->
lowe°_Àvñ
 = 0;

3259 i‡(
ªt
 < 0) {

3260 
	`båfs_put_roŸ
(
roŸ
);

3261  
ªt
;

3263 i‡(
ªt
 > 0 && 
∑th
->
¶Ÿs
[
Àvñ
] > 0)

3264 
∑th
->
¶Ÿs
[
Àvñ
]--;

3266 
eb
 = 
∑th
->
nodes
[
Àvñ
];

3267 i‡(
	`båfs_node_block±r
(
eb
, 
∑th
->
¶Ÿs
[
Àvñ
]Ë!
cur
->
byãƒ
) {

3268 
	`båfs_îr
(
fs_öfo
,

3270 
cur
->
byãƒ
, 
Àvñ
 - 1, 
roŸ
->
roŸ_key
.
obje˘id
,

3271 
åì_key
->
obje˘id
,Åªe_key->
ty≥
,Åªe_key->
off£t
);

3272 
	`båfs_put_roŸ
(
roŸ
);

3273 
ªt
 = -
ENOENT
;

3274 
out
;

3276 
lowî
 = 
cur
;

3279 ; 
Àvñ
 < 
BTRFS_MAX_LEVEL
;Üevel++) {

3280 i‡(!
∑th
->
nodes
[
Àvñ
]) {

3281 
	`ASSERT
(
	`båfs_roŸ_byãƒ
(&
roŸ
->
roŸ_ôem
) ==

3282 
lowî
->
byãƒ
);

3284 i‡(
	`båfs_should_ign‹e_ªloc_roŸ
(
roŸ
) &&

3285 
ˇche
->
is_ªloc
) {

3286 
	`båfs_put_roŸ
(
roŸ
);

3287 
	`li°_add
(&
lowî
->
li°
, &
ˇche
->
u£Àss_node
);

3289 
lowî
->
roŸ
 =Ñoot;

3294 
edge
 = 
	`båfs_backªf_Æloc_edge
(
ˇche
);

3295 i‡(!
edge
) {

3296 
	`båfs_put_roŸ
(
roŸ
);

3297 
ªt
 = -
ENOMEM
;

3298 
out
;

3301 
eb
 = 
∑th
->
nodes
[
Àvñ
];

3302 
rb_node
 = 
	`rb_sim∂e_£¨ch
(&
ˇche
->
rb_roŸ
, 
eb
->
°¨t
);

3303 i‡(!
rb_node
) {

3304 
uµî
 = 
	`båfs_backªf_Æloc_node
(
ˇche
, 
eb
->
°¨t
,

3305 
lowî
->
Àvñ
 + 1);

3306 i‡(!
uµî
) {

3307 
	`båfs_put_roŸ
(
roŸ
);

3308 
	`båfs_backªf_‰ì_edge
(
ˇche
, 
edge
);

3309 
ªt
 = -
ENOMEM
;

3310 
out
;

3312 
uµî
->
ow√r
 = 
	`båfs_hódî_ow√r
(
eb
);

3313 i‡(!
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
))

3314 
uµî
->
cow⁄ly
 = 1;

3320 i‡(
	`båfs_block_ˇn_be_sh¨ed
(
å™s
, 
roŸ
, 
eb
))

3321 
uµî
->
checked
 = 0;

3323 
uµî
->
checked
 = 1;

3330 i‡(!
uµî
->
checked
 && 
√ed_check
) {

3331 
√ed_check
 = 
Ál£
;

3332 
	`li°_add_èû
(&
edge
->
li°
[
UPPER
],

3333 &
ˇche
->
≥ndög_edge
);

3335 i‡(
uµî
->
checked
)

3336 
√ed_check
 = 
åue
;

3337 
	`INIT_LIST_HEAD
(&
edge
->
li°
[
UPPER
]);

3340 
uµî
 = 
	`rb_íåy
(
rb_node
, 
båfs_backªf_node
,

3341 
rb_node
);

3342 
	`ASSERT
(
uµî
->
checked
);

3343 
	`INIT_LIST_HEAD
(&
edge
->
li°
[
UPPER
]);

3344 i‡(!
uµî
->
ow√r
)

3345 
uµî
->
ow√r
 = 
	`båfs_hódî_ow√r
(
eb
);

3347 
	`båfs_backªf_lök_edge
(
edge
, 
lowî
, 
uµî
, 
LINK_LOWER
);

3349 i‡(
rb_node
) {

3350 
	`båfs_put_roŸ
(
roŸ
);

3353 
lowî
 = 
uµî
;

3354 
uµî
 = 
NULL
;

3356 
out
:

3357 
	`båfs_ªÀa£_∑th
(
∑th
);

3358  
ªt
;

3359 
	}
}

3373 
	$båfs_backªf_add_åì_node
(
båfs_å™s_h™dÀ
 *
å™s
,

3374 
båfs_backªf_ˇche
 *
ˇche
,

3375 
båfs_∑th
 *
∑th
,

3376 
båfs_backªf_ôî
 *
ôî
,

3377 
båfs_key
 *
node_key
,

3378 
båfs_backªf_node
 *
cur
)

3380 
båfs_backªf_edge
 *
edge
;

3381 
båfs_backªf_node
 *
exi°
;

3382 
ªt
;

3384 
ªt
 = 
	`båfs_backªf_ôî_°¨t
(
ôî
, 
cur
->
byãƒ
);

3385 i‡(
ªt
 < 0)

3386  
ªt
;

3391 i‡(
	`båfs_backªf_has_åì_block_öfo
(
ôî
)) {

3392 
ªt
 = 
	`båfs_backªf_ôî_√xt
(
ôî
);

3393 i‡(
ªt
 < 0)

3394 
out
;

3396 i‡(
ªt
 > 0) {

3397 
ªt
 = -
EUCLEAN
;

3398 
out
;

3401 
	`WARN_ON
(
cur
->
checked
);

3402 i‡(!
	`li°_em±y
(&
cur
->
uµî
)) {

3407 
	`ASSERT
(
	`li°_is_söguœr
(&
cur
->
uµî
));

3408 
edge
 = 
	`li°_íåy
(
cur
->
uµî
.
√xt
, 
båfs_backªf_edge
,

3409 
li°
[
LOWER
]);

3410 
	`ASSERT
(
	`li°_em±y
(&
edge
->
li°
[
UPPER
]));

3411 
exi°
 = 
edge
->
node
[
UPPER
];

3416 i‡(!
exi°
->
checked
)

3417 
	`li°_add_èû
(&
edge
->
li°
[
UPPER
], &
ˇche
->
≥ndög_edge
);

3419 
exi°
 = 
NULL
;

3422 ; 
ªt
 =0;Ñë = 
	`båfs_backªf_ôî_√xt
(
ôî
)) {

3423 
exã¡_buf„r
 *
eb
;

3424 
båfs_key
 
key
;

3425 
ty≥
;

3427 
	`c⁄d_ªsched
();

3428 
eb
 = 
	`båfs_backªf_gë_eb
(
ôî
);

3430 
key
.
obje˘id
 = 
ôî
->
byãƒ
;

3431 i‡(
	`båfs_backªf_ôî_is_ölöe_ªf
(
ôî
)) {

3432 
båfs_exã¡_ölöe_ªf
 *
úef
;

3435 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)

3436 (()
ôî
->
cur_±r
);

3437 
ty≥
 = 
	`båfs_gë_exã¡_ölöe_ªf_ty≥
(
eb
, 
úef
,

3438 
BTRFS_REF_TYPE_BLOCK
);

3439 i‡(
ty≥
 =
BTRFS_REF_TYPE_INVALID
) {

3440 
ªt
 = -
EUCLEAN
;

3441 
out
;

3443 
key
.
ty≥
 =Åype;

3444 
key
.
off£t
 = 
	`båfs_exã¡_ölöe_ªf_off£t
(
eb
, 
úef
);

3446 
key
.
ty≥
 = 
ôî
->
cur_key
.type;

3447 
key
.
off£t
 = 
ôî
->
cur_key
.offset;

3454 i‡(
exi°
 &&

3455 ((
key
.
ty≥
 =
BTRFS_TREE_BLOCK_REF_KEY
 &&

3456 
exi°
->
ow√r
 =
key
.
off£t
) ||

3457 (
key
.
ty≥
 =
BTRFS_SHARED_BLOCK_REF_KEY
 &&

3458 
exi°
->
byãƒ
 =
key
.
off£t
))) {

3459 
exi°
 = 
NULL
;

3464 i‡(
key
.
ty≥
 =
BTRFS_SHARED_BLOCK_REF_KEY
) {

3465 
ªt
 = 
	`h™dÀ_dúe˘_åì_backªf
(
ˇche
, &
key
, 
cur
);

3466 i‡(
ªt
 < 0)

3467 
out
;

3468 } i‡(
key
.
ty≥
 =
BTRFS_TREE_BLOCK_REF_KEY
) {

3474 
ªt
 = 
	`h™dÀ_ödúe˘_åì_backªf
(
å™s
, 
ˇche
, 
∑th
,

3475 &
key
, 
node_key
, 
cur
);

3476 i‡(
ªt
 < 0)

3477 
out
;

3484 
ªt
 = 0;

3485 
cur
->
checked
 = 1;

3486 
	`WARN_ON
(
exi°
);

3487 
out
:

3488 
	`båfs_backªf_ôî_ªÀa£
(
ôî
);

3489  
ªt
;

3490 
	}
}

3495 
	$båfs_backªf_föish_uµî_löks
(
båfs_backªf_ˇche
 *
ˇche
,

3496 
båfs_backªf_node
 *
°¨t
)

3498 
li°_hód
 *
u£Àss_node
 = &
ˇche
->useless_node;

3499 
båfs_backªf_edge
 *
edge
;

3500 
rb_node
 *rb_node;

3501 
	`LIST_HEAD
(
≥ndög_edge
);

3503 
	`ASSERT
(
°¨t
->
checked
);

3506 i‡(!
°¨t
->
cow⁄ly
) {

3507 
rb_node
 = 
	`rb_sim∂e_ö£π
(&
ˇche
->
rb_roŸ
, 
°¨t
->
byãƒ
,

3508 &
°¨t
->
rb_node
);

3509 i‡(
rb_node
)

3510 
	`båfs_backªf_∑nic
(
ˇche
->
fs_öfo
, 
°¨t
->
byãƒ
,

3511 -
EEXIST
);

3512 
	`li°_add_èû
(&
°¨t
->
lowî
, &
ˇche
->
Àaves
);

3520 
	`li°_f‹_óch_íåy
(
edge
, &
°¨t
->
uµî
, 
li°
[
LOWER
])

3521 
	`li°_add_èû
(&
edge
->
li°
[
UPPER
], &
≥ndög_edge
);

3523 !
	`li°_em±y
(&
≥ndög_edge
)) {

3524 
båfs_backªf_node
 *
uµî
;

3525 
båfs_backªf_node
 *
lowî
;

3527 
edge
 = 
	`li°_fú°_íåy
(&
≥ndög_edge
,

3528 
båfs_backªf_edge
, 
li°
[
UPPER
]);

3529 
	`li°_dñ_öô
(&
edge
->
li°
[
UPPER
]);

3530 
uµî
 = 
edge
->
node
[
UPPER
];

3531 
lowî
 = 
edge
->
node
[
LOWER
];

3534 i‡(
uµî
->
dëached
) {

3535 
	`li°_dñ
(&
edge
->
li°
[
LOWER
]);

3536 
	`båfs_backªf_‰ì_edge
(
ˇche
, 
edge
);

3539 i‡(
	`li°_em±y
(&
lowî
->
uµî
))

3540 
	`li°_add
(&
lowî
->
li°
, 
u£Àss_node
);

3551 i‡(!
	`RB_EMPTY_NODE
(&
uµî
->
rb_node
)) {

3552 i‡(
uµî
->
lowe°
) {

3553 
	`li°_dñ_öô
(&
uµî
->
lowî
);

3554 
uµî
->
lowe°
 = 0;

3557 
	`li°_add_èû
(&
edge
->
li°
[
UPPER
], &
uµî
->
lowî
);

3562 i‡(!
uµî
->
checked
) {

3563 
	`ASSERT
(0);

3564  -
EUCLEAN
;

3568 i‡(
°¨t
->
cow⁄ly
 !
uµî
->cowonly) {

3569 
	`ASSERT
(0);

3570  -
EUCLEAN
;

3574 i‡(!
uµî
->
cow⁄ly
) {

3575 
rb_node
 = 
	`rb_sim∂e_ö£π
(&
ˇche
->
rb_roŸ
, 
uµî
->
byãƒ
,

3576 &
uµî
->
rb_node
);

3577 i‡(
rb_node
) {

3578 
	`båfs_backªf_∑nic
(
ˇche
->
fs_öfo
,

3579 
uµî
->
byãƒ
, -
EEXIST
);

3580  -
EUCLEAN
;

3584 
	`li°_add_èû
(&
edge
->
li°
[
UPPER
], &
uµî
->
lowî
);

3590 
	`li°_f‹_óch_íåy
(
edge
, &
uµî
->uµî, 
li°
[
LOWER
])

3591 
	`li°_add_èû
(&
edge
->
li°
[
UPPER
], &
≥ndög_edge
);

3594 
	}
}

3596 
	$båfs_backªf_îr‹_˛ónup
(
båfs_backªf_ˇche
 *
ˇche
,

3597 
båfs_backªf_node
 *
node
)

3599 
båfs_backªf_node
 *
lowî
;

3600 
båfs_backªf_node
 *
uµî
;

3601 
båfs_backªf_edge
 *
edge
;

3603 !
	`li°_em±y
(&
ˇche
->
u£Àss_node
)) {

3604 
lowî
 = 
	`li°_fú°_íåy
(&
ˇche
->
u£Àss_node
,

3605 
båfs_backªf_node
, 
li°
);

3606 
	`li°_dñ_öô
(&
lowî
->
li°
);

3608 !
	`li°_em±y
(&
ˇche
->
≥ndög_edge
)) {

3609 
edge
 = 
	`li°_fú°_íåy
(&
ˇche
->
≥ndög_edge
,

3610 
båfs_backªf_edge
, 
li°
[
UPPER
]);

3611 
	`li°_dñ
(&
edge
->
li°
[
UPPER
]);

3612 
	`li°_dñ
(&
edge
->
li°
[
LOWER
]);

3613 
lowî
 = 
edge
->
node
[
LOWER
];

3614 
uµî
 = 
edge
->
node
[
UPPER
];

3615 
	`båfs_backªf_‰ì_edge
(
ˇche
, 
edge
);

3621 i‡(
	`li°_em±y
(&
lowî
->
uµî
) &&

3622 
	`RB_EMPTY_NODE
(&
lowî
->
rb_node
))

3623 
	`li°_add
(&
lowî
->
li°
, &
ˇche
->
u£Àss_node
);

3625 i‡(!
	`RB_EMPTY_NODE
(&
uµî
->
rb_node
))

3629 
	`li°_f‹_óch_íåy
(
edge
, &
uµî
->uµî, 
li°
[
LOWER
])

3630 
	`li°_add_èû
(&
edge
->
li°
[
UPPER
],

3631 &
ˇche
->
≥ndög_edge
);

3632 i‡(
	`li°_em±y
(&
uµî
->upper))

3633 
	`li°_add
(&
uµî
->
li°
, &
ˇche
->
u£Àss_node
);

3636 !
	`li°_em±y
(&
ˇche
->
u£Àss_node
)) {

3637 
lowî
 = 
	`li°_fú°_íåy
(&
ˇche
->
u£Àss_node
,

3638 
båfs_backªf_node
, 
li°
);

3639 
	`li°_dñ_öô
(&
lowî
->
li°
);

3640 i‡(
lowî
 =
node
)

3641 
node
 = 
NULL
;

3642 
	`båfs_backªf_dr›_node
(
ˇche
, 
lowî
);

3645 
	`båfs_backªf_˛ónup_node
(
ˇche
, 
node
);

3646 
	`ASSERT
(
	`li°_em±y
(&
ˇche
->
u£Àss_node
) &&

3647 
	`li°_em±y
(&
ˇche
->
≥ndög_edge
));

3648 
	}
}

	@backref.h

6 #i‚de‡
BTRFS_BACKREF_H


7 
	#BTRFS_BACKREF_H


	)

9 
	~<löux/båfs.h
>

10 
	~"mesßges.h
"

11 
	~"uli°.h
"

12 
	~"disk-io.h
"

13 
	~"exã¡_io.h
"

23 
	#BTRFS_ITERATE_EXTENT_INODES_STOP
 5

	)

31 (
	tôî©e_exã¡_öodes_t
)(
	tu64
 
	töum
, u64 
	toff£t
, u64 
	tnum_byãs
,

32 
	tu64
 
	troŸ
, *
	t˘x
);

39 
	sbåfs_backªf_wÆk_˘x
 {

46 
u64
 
byãƒ
;

56 
u64
 
exã¡_ôem_pos
;

62 
boﬁ
 
ign‹e_exã¡_ôem_pos
;

68 
boﬁ
 
skù_öode_ªf_li°
;

70 
båfs_å™s_h™dÀ
 *
å™s
;

76 
båfs_fs_öfo
 *
fs_öfo
;

85 
u64
 
time_£q
;

90 
uli°
 *
ªfs
;

96 
uli°
 *
roŸs
;

103 
	`boﬁ
 (*
ˇche_lookup
)(
u64
 
Àaf_byãƒ
, *
u£r_˘x
,

104 c⁄° 
u64
 **
roŸ_ids_ªt
, *
roŸ_cou¡_ªt
);

105 (*
ˇche_°‹e
)(
u64
 
Àaf_byãƒ
, c⁄° 
uli°
 *
roŸ_ids
,

106 *
u£r_˘x
);

116 
ôî©e_exã¡_öodes_t
 *
ödúe˘_ªf_ôî©‹
;

123 (*
check_exã¡_ôem
)(
u64
 
byãƒ
, c⁄° 
båfs_exã¡_ôem
 *
ei
,

124 c⁄° 
exã¡_buf„r
 *
Àaf
, *
u£r_˘x
);

133 
	`boﬁ
 (*
skù_d©a_ªf
)(
u64
 
roŸ
, u64 
öo
, u64 
off£t
, *
u£r_˘x
);

135 *
u£r_˘x
;

138 
	söode_fs_∑ths
 {

139 
båfs_∑th
 *btrfs_path;

140 
båfs_roŸ
 *
fs_roŸ
;

141 
båfs_d©a_c⁄èöî
 *
f•©h
;

144 
	sbåfs_backªf_sh¨ed_ˇche_íåy
 {

145 
u64
 
byãƒ
;

146 
u64
 
gí
;

147 
boﬁ
 
is_sh¨ed
;

150 
	#BTRFS_BACKREF_CTX_PREV_EXTENTS_SIZE
 8

	)

152 
	sbåfs_backªf_sh¨e_check_˘x
 {

154 
uli°
 
ªfs
;

161 
u64
 
cuº_Àaf_byãƒ
;

167 
u64
 
¥ev_Àaf_byãƒ
;

172 
båfs_backªf_sh¨ed_ˇche_íåy
 
∑th_ˇche_íåõs
[
BTRFS_MAX_LEVEL
];

173 
boﬁ
 
u£_∑th_ˇche
;

191 
u64
 
byãƒ
;

192 
boﬁ
 
is_sh¨ed
;

193 } 
¥ev_exã¡s_ˇche
[
BTRFS_BACKREF_CTX_PREV_EXTENTS_SIZE
];

198 
¥ev_exã¡s_ˇche_¶Ÿ
;

201 
båfs_backªf_sh¨e_check_˘x
 *
	`båfs_Æloc_backªf_sh¨e_check_˘x
();

202 
	`båfs_‰ì_backªf_sh¨e_˘x
(
båfs_backªf_sh¨e_check_˘x
 *
˘x
);

204 
	`exã¡_‰om_logiˇl
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
logiˇl
,

205 
båfs_∑th
 *
∑th
, 
båfs_key
 *
found_key
,

206 
u64
 *
Êags
);

208 
	`åì_backªf_f‹_exã¡
(*
±r
, 
exã¡_buf„r
 *
eb
,

209 
båfs_key
 *
key
, 
båfs_exã¡_ôem
 *
ei
,

210 
u32
 
ôem_size
, 
u64
 *
out_roŸ
, 
u8
 *
out_Àvñ
);

212 
	`ôî©e_exã¡_öodes
(
båfs_backªf_wÆk_˘x
 *
˘x
,

213 
boﬁ
 
£¨ch_commô_roŸ
,

214 
ôî©e_exã¡_öodes_t
 *
ôî©e
, *
u£r_˘x
);

216 
	`ôî©e_öodes_‰om_logiˇl
(
u64
 
logiˇl
, 
båfs_fs_öfo
 *
fs_öfo
,

217 
båfs_∑th
 *
∑th
, *
˘x
,

218 
boﬁ
 
ign‹e_off£t
);

220 
	`∑ths_‰om_öode
(
u64
 
öum
, 
öode_fs_∑ths
 *
ù©h
);

222 
	`båfs_föd_Æl_Àafs
(
båfs_backªf_wÆk_˘x
 *
˘x
);

223 
	`båfs_föd_Æl_roŸs
(
båfs_backªf_wÆk_˘x
 *
˘x
,

224 
boﬁ
 
skù_commô_roŸ_£m
);

225 *
	`båfs_ªf_to_∑th
(
båfs_roŸ
 *
fs_roŸ
, 
båfs_∑th
 *
∑th
,

226 
u32
 
«me_Àn
, 
«me_off
,

227 
exã¡_buf„r
 *
eb_ö
, 
u64
 
∑ª¡
,

228 *
de°
, 
u32
 
size
);

230 
båfs_d©a_c⁄èöî
 *
	`öô_d©a_c⁄èöî
(
u32
 
tŸÆ_byãs
);

231 
öode_fs_∑ths
 *
	`öô_ù©h
(
s32
 
tŸÆ_byãs
, 
båfs_roŸ
 *
fs_roŸ
,

232 
båfs_∑th
 *
∑th
);

233 
	`‰ì_ù©h
(
öode_fs_∑ths
 *
ù©h
);

235 
	`båfs_föd_⁄e_exåef
(
båfs_roŸ
 *
roŸ
, 
u64
 
öode_obje˘id
,

236 
u64
 
°¨t_off
, 
båfs_∑th
 *
∑th
,

237 
båfs_öode_exåef
 **
ªt_exåef
,

238 
u64
 *
found_off
);

239 
	`båfs_is_d©a_exã¡_sh¨ed
(
båfs_öode
 *
öode
, 
u64
 
byãƒ
,

240 
u64
 
exã¡_gí
,

241 
båfs_backªf_sh¨e_check_˘x
 *
˘x
);

243 
__öô
 
	`båfs_¥ñim_ªf_öô
();

244 
__cﬁd
 
	`båfs_¥ñim_ªf_exô
();

246 
	s¥ñim_ªf
 {

247 
rb_node
 
rbnode
;

248 
u64
 
roŸ_id
;

249 
båfs_key
 
key_f‹_£¨ch
;

250 
Àvñ
;

251 
cou¡
;

252 
exã¡_öode_ñem
 *
öode_li°
;

253 
u64
 
∑ª¡
;

254 
u64
 
w™ãd_disk_byã
;

262 
	sbåfs_backªf_ôî
 {

263 
u64
 
byãƒ
;

264 
båfs_∑th
 *
∑th
;

265 
båfs_fs_öfo
 *
fs_öfo
;

266 
båfs_key
 
cur_key
;

267 
u32
 
ôem_±r
;

268 
u32
 
cur_±r
;

269 
u32
 
íd_±r
;

272 
båfs_backªf_ôî
 *
	`båfs_backªf_ôî_Æloc
(
båfs_fs_öfo
 *
fs_öfo
);

274 
ölöe
 
	$båfs_backªf_ôî_‰ì
(
båfs_backªf_ôî
 *
ôî
)

276 i‡(!
ôî
)

278 
	`båfs_‰ì_∑th
(
ôî
->
∑th
);

279 
	`k‰ì
(
ôî
);

280 
	}
}

282 
ölöe
 
exã¡_buf„r
 *
	$båfs_backªf_gë_eb
(

283 
båfs_backªf_ôî
 *
ôî
)

285 i‡(!
ôî
)

286  
NULL
;

287  
ôî
->
∑th
->
nodes
[0];

288 
	}
}

296 
ölöe
 
boﬁ
 
	$båfs_backªf_has_åì_block_öfo
(

297 
båfs_backªf_ôî
 *
ôî
)

299 i‡(
ôî
->
cur_key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 &&

300 
ôî
->
cur_±r
 - iãr->
ôem_±r
 =(
båfs_exã¡_ôem
))

301  
åue
;

302  
Ál£
;

303 
	}
}

305 
båfs_backªf_ôî_°¨t
(
båfs_backªf_ôî
 *
ôî
, 
u64
 
byãƒ
);

307 
båfs_backªf_ôî_√xt
(
båfs_backªf_ôî
 *
ôî
);

309 
ölöe
 
boﬁ
 
	$båfs_backªf_ôî_is_ölöe_ªf
(

310 
båfs_backªf_ôî
 *
ôî
)

312 i‡(
ôî
->
cur_key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 ||

313 
ôî
->
cur_key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
)

314  
åue
;

315  
Ál£
;

316 
	}
}

318 
ölöe
 
	$båfs_backªf_ôî_ªÀa£
(
båfs_backªf_ôî
 *
ôî
)

320 
ôî
->
byãƒ
 = 0;

321 
ôî
->
ôem_±r
 = 0;

322 
ôî
->
cur_±r
 = 0;

323 
ôî
->
íd_±r
 = 0;

324 
	`båfs_ªÀa£_∑th
(
ôî
->
∑th
);

325 
	`mem£t
(&
ôî
->
cur_key
, 0, (iter->cur_key));

326 
	}
}

338 
	sbåfs_backªf_node
 {

340 
rb_node
 
	mrb_node
;

341 
u64
 
	mbyãƒ
;

344 
u64
 
	m√w_byãƒ
;

346 
u64
 
	mow√r
;

348 
li°_hód
 
	mli°
;

351 
li°_hód
 
	muµî
;

353 
li°_hód
 
	mlowî
;

356 
båfs_roŸ
 *
	mroŸ
;

358 
exã¡_buf„r
 *
	meb
;

360 
	mÀvñ
:8;

362 
	mcow⁄ly
:1;

364 
	mlowe°
:1;

366 
	mlocked
:1;

368 
	m¥o˚s£d
:1;

370 
	mchecked
:1;

375 
	m≥ndög
:1;

377 
	mdëached
:1;

383 
	mis_ªloc_roŸ
:1;

386 
	#LOWER
 0

	)

387 
	#UPPER
 1

	)

392 
	sbåfs_backªf_edge
 {

401 
li°_hód
 
	mli°
[2];

404 
båfs_backªf_node
 *
	mnode
[2];

407 
	sbåfs_backªf_ˇche
 {

409 
rb_roŸ
 
	mrb_roŸ
;

411 
båfs_backªf_node
 *
	m∑th
[
BTRFS_MAX_LEVEL
];

416 
li°_hód
 
	m≥ndög
[
BTRFS_MAX_LEVEL
];

418 
li°_hód
 
	mÀaves
;

420 
li°_hód
 
	mch™ged
;

422 
li°_hód
 
	mdëached
;

424 
u64
 
	mœ°_å™s
;

426 
	mƒ_nodes
;

427 
	mƒ_edges
;

430 
li°_hód
 
	m≥ndög_edge
;

433 
li°_hód
 
	mu£Àss_node
;

435 
båfs_fs_öfo
 *
	mfs_öfo
;

443 
	mis_ªloc
;

446 
båfs_backªf_öô_ˇche
(
båfs_fs_öfo
 *
fs_öfo
,

447 
båfs_backªf_ˇche
 *
ˇche
, 
is_ªloc
);

448 
båfs_backªf_node
 *
båfs_backªf_Æloc_node
(

449 
båfs_backªf_ˇche
 *
ˇche
, 
u64
 
byãƒ
, 
Àvñ
);

450 
båfs_backªf_edge
 *
båfs_backªf_Æloc_edge
(

451 
båfs_backªf_ˇche
 *
ˇche
);

453 
	#LINK_LOWER
 (1 << 0)

	)

454 
	#LINK_UPPER
 (1 << 1)

	)

455 
ölöe
 
	$båfs_backªf_lök_edge
(
båfs_backªf_edge
 *
edge
,

456 
båfs_backªf_node
 *
lowî
,

457 
båfs_backªf_node
 *
uµî
,

458 
lök_which
)

460 
	`ASSERT
(
uµî
 && 
lowî
 && uµî->
Àvñ
 ==Üower->level + 1);

461 
edge
->
node
[
LOWER
] = 
lowî
;

462 
edge
->
node
[
UPPER
] = 
uµî
;

463 i‡(
lök_which
 & 
LINK_LOWER
)

464 
	`li°_add_èû
(&
edge
->
li°
[
LOWER
], &
lowî
->
uµî
);

465 i‡(
lök_which
 & 
LINK_UPPER
)

466 
	`li°_add_èû
(&
edge
->
li°
[
UPPER
], &
uµî
->
lowî
);

467 
	}
}

469 
ölöe
 
	$båfs_backªf_‰ì_node
(
båfs_backªf_ˇche
 *
ˇche
,

470 
båfs_backªf_node
 *
node
)

472 i‡(
node
) {

473 
	`ASSERT
(
	`li°_em±y
(&
node
->
li°
));

474 
	`ASSERT
(
	`li°_em±y
(&
node
->
lowî
));

475 
	`ASSERT
(
node
->
eb
 =
NULL
);

476 
ˇche
->
ƒ_nodes
--;

477 
	`båfs_put_roŸ
(
node
->
roŸ
);

478 
	`k‰ì
(
node
);

480 
	}
}

482 
ölöe
 
	$båfs_backªf_‰ì_edge
(
båfs_backªf_ˇche
 *
ˇche
,

483 
båfs_backªf_edge
 *
edge
)

485 i‡(
edge
) {

486 
ˇche
->
ƒ_edges
--;

487 
	`k‰ì
(
edge
);

489 
	}
}

491 
ölöe
 
	$båfs_backªf_u∆ock_node_buf„r
(

492 
båfs_backªf_node
 *
node
)

494 i‡(
node
->
locked
) {

495 
	`båfs_åì_u∆ock
(
node
->
eb
);

496 
node
->
locked
 = 0;

498 
	}
}

500 
ölöe
 
	$båfs_backªf_dr›_node_buf„r
(

501 
båfs_backªf_node
 *
node
)

503 i‡(
node
->
eb
) {

504 
	`båfs_backªf_u∆ock_node_buf„r
(
node
);

505 
	`‰ì_exã¡_buf„r
(
node
->
eb
);

506 
node
->
eb
 = 
NULL
;

508 
	}
}

517 
ölöe
 
	$båfs_backªf_dr›_node
(
båfs_backªf_ˇche
 *
åì
,

518 
båfs_backªf_node
 *
node
)

520 
	`ASSERT
(
	`li°_em±y
(&
node
->
uµî
));

522 
	`båfs_backªf_dr›_node_buf„r
(
node
);

523 
	`li°_dñ_öô
(&
node
->
li°
);

524 
	`li°_dñ_öô
(&
node
->
lowî
);

525 i‡(!
	`RB_EMPTY_NODE
(&
node
->
rb_node
))

526 
	`rb_îa£
(&
node
->
rb_node
, &
åì
->
rb_roŸ
);

527 
	`båfs_backªf_‰ì_node
(
åì
, 
node
);

528 
	}
}

530 
båfs_backªf_˛ónup_node
(
båfs_backªf_ˇche
 *
ˇche
,

531 
båfs_backªf_node
 *
node
);

533 
båfs_backªf_ªÀa£_ˇche
(
båfs_backªf_ˇche
 *
ˇche
);

535 
ölöe
 
	$båfs_backªf_∑nic
(
båfs_fs_öfo
 *
fs_öfo
,

536 
u64
 
byãƒ
, 
î∫o
)

538 
	`båfs_∑nic
(
fs_öfo
, 
î∫o
,

540 
byãƒ
);

541 
	}
}

543 
båfs_backªf_add_åì_node
(
båfs_å™s_h™dÀ
 *
å™s
,

544 
båfs_backªf_ˇche
 *
ˇche
,

545 
båfs_∑th
 *
∑th
,

546 
båfs_backªf_ôî
 *
ôî
,

547 
båfs_key
 *
node_key
,

548 
båfs_backªf_node
 *
cur
);

550 
båfs_backªf_föish_uµî_löks
(
båfs_backªf_ˇche
 *
ˇche
,

551 
båfs_backªf_node
 *
°¨t
);

553 
båfs_backªf_îr‹_˛ónup
(
båfs_backªf_ˇche
 *
ˇche
,

554 
båfs_backªf_node
 *
node
);

	@bio.c

7 
	~<löux/bio.h
>

8 
	~"bio.h
"

9 
	~"˘ªe.h
"

10 
	~"vﬁumes.h
"

11 
	~"øid56.h
"

12 
	~"async-thªad.h
"

13 
	~"check-öãgrôy.h
"

14 
	~"dev-ª∂a˚.h
"

15 
	~"rcu-°rög.h
"

16 
	~"z⁄ed.h
"

17 
	~"fûe-ôem.h
"

19 
bio_£t
 
	gbåfs_bio£t
;

20 
bio_£t
 
	gbåfs_˛⁄e_bio£t
;

21 
bio_£t
 
	gbåfs_ª∑ú_bio£t
;

22 
mempoﬁ_t
 
	gbåfs_Áûed_bio_poﬁ
;

24 
	sbåfs_Áûed_bio
 {

25 
båfs_bio
 *
	mbbio
;

26 
	mnum_c›õs
;

27 
©omic_t
 
	mª∑ú_cou¡
;

31 
ölöe
 
boﬁ
 
	$is_d©a_bbio
(
båfs_bio
 *
bbio
)

33  
bbio
->
öode
 && 
	`is_d©a_öode
(&bbio->öode->
vfs_öode
);

34 
	}
}

36 
boﬁ
 
	$bbio_has_‹dîed_exã¡
(
båfs_bio
 *
bbio
)

38  
	`is_d©a_bbio
(
bbio
Ë&& 
	`båfs_›
(&bbio->
bio
Ë=
BTRFS_MAP_WRITE
;

39 
	}
}

45 
	$båfs_bio_öô
(
båfs_bio
 *
bbio
, 
båfs_fs_öfo
 *
fs_öfo
,

46 
båfs_bio_íd_io_t
 
íd_io
, *
¥iv©e
)

48 
	`mem£t
(
bbio
, 0, 
	`off£tof
(
båfs_bio
, 
bio
));

49 
bbio
->
fs_öfo
 = fs_info;

50 
bbio
->
íd_io
 =Énd_io;

51 
bbio
->
¥iv©e
 =Örivate;

52 
	`©omic_£t
(&
bbio
->
≥ndög_ios
, 1);

53 
	}
}

62 
båfs_bio
 *
	$båfs_bio_Æloc
(
ƒ_vecs
, 
blk_›f_t
 
›f
,

63 
båfs_fs_öfo
 *
fs_öfo
,

64 
båfs_bio_íd_io_t
 
íd_io
, *
¥iv©e
)

66 
båfs_bio
 *
bbio
;

67 
bio
 *bio;

69 
bio
 = 
	`bio_Æloc_bio£t
(
NULL
, 
ƒ_vecs
, 
›f
, 
GFP_NOFS
, &
båfs_bio£t
);

70 
bbio
 = 
	`båfs_bio
(
bio
);

71 
	`båfs_bio_öô
(
bbio
, 
fs_öfo
, 
íd_io
, 
¥iv©e
);

72  
bbio
;

73 
	}
}

75 
båfs_bio
 *
	$båfs_•lô_bio
(
båfs_fs_öfo
 *
fs_öfo
,

76 
båfs_bio
 *
‹ig_bbio
,

77 
u64
 
m≠_Àngth
, 
boﬁ
 
u£_≠≥nd
)

79 
båfs_bio
 *
bbio
;

80 
bio
 *bio;

82 i‡(
u£_≠≥nd
) {

83 
ƒ_£gs
;

85 
bio
 = 
	`bio_•lô_rw
(&
‹ig_bbio
->bio, &
fs_öfo
->
limôs
, &
ƒ_£gs
,

86 &
båfs_˛⁄e_bio£t
, 
m≠_Àngth
);

88 
bio
 = 
	`bio_•lô
(&
‹ig_bbio
->bio, 
m≠_Àngth
 >> 
SECTOR_SHIFT
,

89 
GFP_NOFS
, &
båfs_˛⁄e_bio£t
);

91 
bbio
 = 
	`båfs_bio
(
bio
);

92 
	`båfs_bio_öô
(
bbio
, 
fs_öfo
, 
NULL
, 
‹ig_bbio
);

93 
bbio
->
öode
 = 
‹ig_bbio
->inode;

94 
bbio
->
fûe_off£t
 = 
‹ig_bbio
->file_offset;

95 
‹ig_bbio
->
fûe_off£t
 +
m≠_Àngth
;

96 i‡(
	`bbio_has_‹dîed_exã¡
(
bbio
)) {

97 
	`ªfcou¡_öc
(&
‹ig_bbio
->
‹dîed
->
ªfs
);

98 
bbio
->
‹dîed
 = 
‹ig_bbio
->ordered;

100 
	`©omic_öc
(&
‹ig_bbio
->
≥ndög_ios
);

101  
bbio
;

102 
	}
}

105 
	$båfs_˛ónup_bio
(
båfs_bio
 *
bbio
)

107 i‡(
	`bbio_has_‹dîed_exã¡
(
bbio
))

108 
	`båfs_put_‹dîed_exã¡
(
bbio
->
‹dîed
);

109 
	`bio_put
(&
bbio
->
bio
);

110 
	}
}

112 
	$__båfs_bio_íd_io
(
båfs_bio
 *
bbio
)

114 i‡(
	`bbio_has_‹dîed_exã¡
(
bbio
)) {

115 
båfs_‹dîed_exã¡
 *
‹dîed
 = 
bbio
->ordered;

117 
bbio
->
	`íd_io
(bbio);

118 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

120 
bbio
->
	`íd_io
(bbio);

122 
	}
}

124 
	$båfs_bio_íd_io
(
båfs_bio
 *
bbio
, 
blk_°©us_t
 
°©us
)

126 
bbio
->
bio
.
bi_°©us
 = 
°©us
;

127 
	`__båfs_bio_íd_io
(
bbio
);

128 
	}
}

130 
båfs_‹ig_wrôe_íd_io
(
bio
 *bio);

132 
	$båfs_bbio_¥›ag©e_îr‹
(
båfs_bio
 *
bbio
,

133 
båfs_bio
 *
‹ig_bbio
)

141 i‡(
bbio
->
bio
.
bi_íd_io
 =&
båfs_‹ig_wrôe_íd_io
) {

142 
båfs_io_°rùe
 *
‹ig_°rùe
 = 
‹ig_bbio
->
bio
.
bi_¥iv©e
;

143 
båfs_io_c⁄ãxt
 *
‹ig_bioc
 = 
‹ig_°rùe
->
bioc
;

145 
	`©omic_add
(
‹ig_bioc
->
max_îr‹s
, &‹ig_bioc->
îr‹
);

147 
‹ig_bbio
->
bio
.
bi_°©us
 = 
bbio
->bio.bi_status;

149 
	}
}

151 
	$båfs_‹ig_bbio_íd_io
(
båfs_bio
 *
bbio
)

153 i‡(
bbio
->
bio
.
bi_poﬁ
 =&
båfs_˛⁄e_bio£t
) {

154 
båfs_bio
 *
‹ig_bbio
 = 
bbio
->
¥iv©e
;

156 i‡(
bbio
->
bio
.
bi_°©us
)

157 
	`båfs_bbio_¥›ag©e_îr‹
(
bbio
, 
‹ig_bbio
);

158 
	`båfs_˛ónup_bio
(
bbio
);

159 
bbio
 = 
‹ig_bbio
;

162 i‡(
	`©omic_dec_™d_ã°
(&
bbio
->
≥ndög_ios
))

163 
	`__båfs_bio_íd_io
(
bbio
);

164 
	}
}

166 
	$√xt_ª∑ú_múr‹
(
båfs_Áûed_bio
 *
fbio
, 
cur_múr‹
)

168 i‡(
cur_múr‹
 =
fbio
->
num_c›õs
)

169  
cur_múr‹
 + 1 - 
fbio
->
num_c›õs
;

170  
cur_múr‹
 + 1;

171 
	}
}

173 
	$¥ev_ª∑ú_múr‹
(
båfs_Áûed_bio
 *
fbio
, 
cur_múr‹
)

175 i‡(
cur_múr‹
 == 1)

176  
fbio
->
num_c›õs
;

177  
cur_múr‹
 - 1;

178 
	}
}

180 
	$båfs_ª∑ú_d⁄e
(
båfs_Áûed_bio
 *
fbio
)

182 i‡(
	`©omic_dec_™d_ã°
(&
fbio
->
ª∑ú_cou¡
)) {

183 
	`båfs_‹ig_bbio_íd_io
(
fbio
->
bbio
);

184 
	`mempoﬁ_‰ì
(
fbio
, &
båfs_Áûed_bio_poﬁ
);

186 
	}
}

188 
	$båfs_íd_ª∑ú_bio
(
båfs_bio
 *
ª∑ú_bbio
,

189 
båfs_devi˚
 *
dev
)

191 
båfs_Áûed_bio
 *
fbio
 = 
ª∑ú_bbio
->
¥iv©e
;

192 
båfs_öode
 *
öode
 = 
ª∑ú_bbio
->inode;

193 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

194 
bio_vec
 *
bv
 = 
	`bio_fú°_bvec_Æl
(&
ª∑ú_bbio
->
bio
);

195 
múr‹
 = 
ª∑ú_bbio
->
múr‹_num
;

197 i‡(
ª∑ú_bbio
->
bio
.
bi_°©us
 ||

198 !
	`båfs_d©a_csum_ok
(
ª∑ú_bbio
, 
dev
, 0, 
bv
)) {

199 
	`bio_ª£t
(&
ª∑ú_bbio
->
bio
, 
NULL
, 
REQ_OP_READ
);

200 
ª∑ú_bbio
->
bio
.
bi_ôî
 =Ñïaú_bbio->
ßved_ôî
;

202 
múr‹
 = 
	`√xt_ª∑ú_múr‹
(
fbio
, mirror);

203 i‡(
múr‹
 =
fbio
->
bbio
->
múr‹_num
) {

204 
	`båfs_debug
(
fs_öfo
, "no mirrorÜeft");

205 
fbio
->
bbio
->
bio
.
bi_°©us
 = 
BLK_STS_IOERR
;

206 
d⁄e
;

209 
	`båfs_submô_bio
(
ª∑ú_bbio
, 
múr‹
);

214 
múr‹
 = 
	`¥ev_ª∑ú_múr‹
(
fbio
, mirror);

215 
	`båfs_ª∑ú_io_Áûuª
(
fs_öfo
, 
	`båfs_öo
(
öode
),

216 
ª∑ú_bbio
->
fûe_off£t
, 
fs_öfo
->
£˘‹size
,

217 
ª∑ú_bbio
->
ßved_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
,

218 
bv
->
bv_∑ge
, bv->
bv_off£t
, 
múr‹
);

219 } 
múr‹
 !
fbio
->
bbio
->
múr‹_num
);

221 
d⁄e
:

222 
	`båfs_ª∑ú_d⁄e
(
fbio
);

223 
	`bio_put
(&
ª∑ú_bbio
->
bio
);

224 
	}
}

233 
båfs_Áûed_bio
 *
	$ª∑ú_⁄e_£˘‹
(
båfs_bio
 *
Áûed_bbio
,

234 
u32
 
bio_off£t
,

235 
bio_vec
 *
bv
,

236 
båfs_Áûed_bio
 *
fbio
)

238 
båfs_öode
 *
öode
 = 
Áûed_bbio
->inode;

239 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

240 c⁄° 
u32
 
£˘‹size
 = 
fs_öfo
->sectorsize;

241 c⁄° 
u64
 
logiˇl
 = (
Áûed_bbio
->
ßved_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
);

242 
båfs_bio
 *
ª∑ú_bbio
;

243 
bio
 *
ª∑ú_bio
;

244 
num_c›õs
;

245 
múr‹
;

247 
	`båfs_debug
(
fs_öfo
, "repairÑeadÉrror:ÑeadÉrrorát %llu",

248 
Áûed_bbio
->
fûe_off£t
 + 
bio_off£t
);

250 
num_c›õs
 = 
	`båfs_num_c›õs
(
fs_öfo
, 
logiˇl
, 
£˘‹size
);

251 i‡(
num_c›õs
 == 1) {

252 
	`båfs_debug
(
fs_öfo
, "no copyÅoÑepair from");

253 
Áûed_bbio
->
bio
.
bi_°©us
 = 
BLK_STS_IOERR
;

254  
fbio
;

257 i‡(!
fbio
) {

258 
fbio
 = 
	`mempoﬁ_Æloc
(&
båfs_Áûed_bio_poﬁ
, 
GFP_NOFS
);

259 
fbio
->
bbio
 = 
Áûed_bbio
;

260 
fbio
->
num_c›õs
 =Çum_copies;

261 
	`©omic_£t
(&
fbio
->
ª∑ú_cou¡
, 1);

264 
	`©omic_öc
(&
fbio
->
ª∑ú_cou¡
);

266 
ª∑ú_bio
 = 
	`bio_Æloc_bio£t
(
NULL
, 1, 
REQ_OP_READ
, 
GFP_NOFS
,

267 &
båfs_ª∑ú_bio£t
);

268 
ª∑ú_bio
->
bi_ôî
.
bi_£˘‹
 = 
Áûed_bbio
->
ßved_ôî
.bi_sector;

269 
	`__bio_add_∑ge
(
ª∑ú_bio
, 
bv
->
bv_∑ge
, bv->
bv_Àn
, bv->
bv_off£t
);

271 
ª∑ú_bbio
 = 
	`båfs_bio
(
ª∑ú_bio
);

272 
	`båfs_bio_öô
(
ª∑ú_bbio
, 
fs_öfo
, 
NULL
, 
fbio
);

273 
ª∑ú_bbio
->
öode
 = 
Áûed_bbio
->inode;

274 
ª∑ú_bbio
->
fûe_off£t
 = 
Áûed_bbio
->fûe_off£à+ 
bio_off£t
;

276 
múr‹
 = 
	`√xt_ª∑ú_múr‹
(
fbio
, 
Áûed_bbio
->
múr‹_num
);

277 
	`båfs_debug
(
fs_öfo
, "submôtögÑïaúÑódÅÿmúr‹ %d", 
múr‹
);

278 
	`båfs_submô_bio
(
ª∑ú_bbio
, 
múr‹
);

279  
fbio
;

280 
	}
}

282 
	$båfs_check_ªad_bio
(
båfs_bio
 *
bbio
, 
båfs_devi˚
 *
dev
)

284 
båfs_öode
 *
öode
 = 
bbio
->inode;

285 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

286 
u32
 
£˘‹size
 = 
fs_öfo
->sectorsize;

287 
bvec_ôî
 *
ôî
 = &
bbio
->
ßved_ôî
;

288 
blk_°©us_t
 
°©us
 = 
bbio
->
bio
.
bi_°©us
;

289 
båfs_Áûed_bio
 *
fbio
 = 
NULL
;

290 
u32
 
off£t
 = 0;

293 
	`ASSERT
(
öode
);

299 i‡(
bbio
->
bio
.
bi_poﬁ
 =&
båfs_ª∑ú_bio£t
) {

300 
	`båfs_íd_ª∑ú_bio
(
bbio
, 
dev
);

305 
bbio
->
bio
.
bi_°©us
 = 
BLK_STS_OK
;

307 
ôî
->
bi_size
) {

308 
bio_vec
 
bv
 = 
	`bio_ôî_iovec
(&
bbio
->
bio
, *
ôî
);

310 
bv
.
bv_Àn
 = 
	`mö
(bv.bv_Àn, 
£˘‹size
);

312 i‡(
°©us
 || !
	`båfs_d©a_csum_ok
(
bbio
, 
dev
, 
off£t
, &
bv
))

313 
fbio
 = 
	`ª∑ú_⁄e_£˘‹
(
bbio
, 
off£t
, &
bv
, fbio);

315 
	`bio_adv™˚_ôî_sögÀ
(&
bbio
->
bio
, 
ôî
, 
£˘‹size
);

316 
off£t
 +
£˘‹size
;

319 i‡(
bbio
->
csum
 !bbio->
csum_ölöe
)

320 
	`k‰ì
(
bbio
->
csum
);

322 i‡(
fbio
)

323 
	`båfs_ª∑ú_d⁄e
(
fbio
);

325 
	`båfs_‹ig_bbio_íd_io
(
bbio
);

326 
	}
}

328 
	$båfs_log_dev_io_îr‹
(
bio
 *bio, 
båfs_devi˚
 *
dev
)

330 i‡(!
dev
 || !dev->
bdev
)

332 i‡(
bio
->
bi_°©us
 !
BLK_STS_IOERR
 && bio->bi_°©u†!
BLK_STS_TARGET
)

335 i‡(
	`båfs_›
(
bio
Ë=
BTRFS_MAP_WRITE
)

336 
	`båfs_dev_°©_öc_™d_¥öt
(
dev
, 
BTRFS_DEV_STAT_WRITE_ERRS
);

337 i‡(!(
bio
->
bi_›f
 & 
REQ_RAHEAD
))

338 
	`båfs_dev_°©_öc_™d_¥öt
(
dev
, 
BTRFS_DEV_STAT_READ_ERRS
);

339 i‡(
bio
->
bi_›f
 & 
REQ_PREFLUSH
)

340 
	`båfs_dev_°©_öc_™d_¥öt
(
dev
, 
BTRFS_DEV_STAT_FLUSH_ERRS
);

341 
	}
}

343 
w‹kqueue_°ru˘
 *
	$båfs_íd_io_wq
(
båfs_fs_öfo
 *
fs_öfo
,

344 
bio
 *bio)

346 i‡(
bio
->
bi_›f
 & 
REQ_META
)

347  
fs_öfo
->
ídio_mëa_w‹kîs
;

348  
fs_öfo
->
ídio_w‹kîs
;

349 
	}
}

351 
	$båfs_íd_bio_w‹k
(
w‹k_°ru˘
 *
w‹k
)

353 
båfs_bio
 *
bbio
 = 
	`c⁄èöî_of
(
w‹k
, båfs_bio, 
íd_io_w‹k
);

356 i‡(
	`is_d©a_bbio
(
bbio
)) {

358 
	`båfs_check_ªad_bio
(
bbio
, bbio->
bio
.
bi_¥iv©e
);

361 
	`båfs_‹ig_bbio_íd_io
(
bbio
);

363 
	}
}

365 
	$båfs_sim∂e_íd_io
(
bio
 *bio)

367 
båfs_bio
 *
bbio
 = 
	`båfs_bio
(
bio
);

368 
båfs_devi˚
 *
dev
 = 
bio
->
bi_¥iv©e
;

369 
båfs_fs_öfo
 *
fs_öfo
 = 
bbio
->fs_info;

371 
	`båfs_bio_cou¡î_dec
(
fs_öfo
);

373 i‡(
bio
->
bi_°©us
)

374 
	`båfs_log_dev_io_îr‹
(
bio
, 
dev
);

376 i‡(
	`bio_›
(
bio
Ë=
REQ_OP_READ
) {

377 
	`INIT_WORK
(&
bbio
->
íd_io_w‹k
, 
båfs_íd_bio_w‹k
);

378 
	`queue_w‹k
(
	`båfs_íd_io_wq
(
fs_öfo
, 
bio
), &
bbio
->
íd_io_w‹k
);

381 i‡(
	`bio_›
(
bio
Ë=
REQ_OP_ZONE_APPEND
 && !bio->
bi_°©us
)

382 
	`båfs_ªc‹d_physiˇl_z⁄ed
(
bbio
);

383 
	`båfs_‹ig_bbio_íd_io
(
bbio
);

385 
	}
}

387 
	$båfs_øid56_íd_io
(
bio
 *bio)

389 
båfs_io_c⁄ãxt
 *
bioc
 = 
bio
->
bi_¥iv©e
;

390 
båfs_bio
 *
bbio
 = 
	`båfs_bio
(
bio
);

392 
	`båfs_bio_cou¡î_dec
(
bioc
->
fs_öfo
);

393 
bbio
->
múr‹_num
 = 
bioc
->mirror_num;

394 i‡(
	`bio_›
(
bio
Ë=
REQ_OP_READ
 && 
	`is_d©a_bbio
(
bbio
))

395 
	`båfs_check_ªad_bio
(
bbio
, 
NULL
);

397 
	`båfs_‹ig_bbio_íd_io
(
bbio
);

399 
	`båfs_put_bioc
(
bioc
);

400 
	}
}

402 
	$båfs_‹ig_wrôe_íd_io
(
bio
 *bio)

404 
båfs_io_°rùe
 *
°rùe
 = 
bio
->
bi_¥iv©e
;

405 
båfs_io_c⁄ãxt
 *
bioc
 = 
°rùe
->bioc;

406 
båfs_bio
 *
bbio
 = 
	`båfs_bio
(
bio
);

408 
	`båfs_bio_cou¡î_dec
(
bioc
->
fs_öfo
);

410 i‡(
bio
->
bi_°©us
) {

411 
	`©omic_öc
(&
bioc
->
îr‹
);

412 
	`båfs_log_dev_io_îr‹
(
bio
, 
°rùe
->
dev
);

419 i‡(
	`©omic_ªad
(&
bioc
->
îr‹
Ë> bioc->
max_îr‹s
)

420 
bio
->
bi_°©us
 = 
BLK_STS_IOERR
;

422 
bio
->
bi_°©us
 = 
BLK_STS_OK
;

424 
	`båfs_‹ig_bbio_íd_io
(
bbio
);

425 
	`båfs_put_bioc
(
bioc
);

426 
	}
}

428 
	$båfs_˛⁄e_wrôe_íd_io
(
bio
 *bio)

430 
båfs_io_°rùe
 *
°rùe
 = 
bio
->
bi_¥iv©e
;

432 i‡(
bio
->
bi_°©us
) {

433 
	`©omic_öc
(&
°rùe
->
bioc
->
îr‹
);

434 
	`båfs_log_dev_io_îr‹
(
bio
, 
°rùe
->
dev
);

438 
	`bio_ídio
(
°rùe
->
bioc
->
‹ig_bio
);

439 
	`bio_put
(
bio
);

440 
	}
}

442 
	$båfs_submô_dev_bio
(
båfs_devi˚
 *
dev
, 
bio
 *bio)

444 i‡(!
dev
 || !dev->
bdev
 ||

445 
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
, &
dev
->
dev_°©e
) ||

446 (
	`båfs_›
(
bio
Ë=
BTRFS_MAP_WRITE
 &&

447 !
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
dev
->
dev_°©e
))) {

448 
	`bio_io_îr‹
(
bio
);

452 
	`bio_£t_dev
(
bio
, 
dev
->
bdev
);

458 i‡(
	`bio_›
(
bio
Ë=
REQ_OP_ZONE_APPEND
) {

459 
u64
 
physiˇl
 = 
bio
->
bi_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
;

460 
u64
 
z⁄e_°¨t
 = 
	`round_down
(
physiˇl
, 
dev
->
fs_öfo
->
z⁄e_size
);

462 
	`ASSERT
(
	`båfs_dev_is_£quítül
(
dev
, 
physiˇl
));

463 
bio
->
bi_ôî
.
bi_£˘‹
 = 
z⁄e_°¨t
 >> 
SECTOR_SHIFT
;

465 
	`båfs_debug_ö_rcu
(
dev
->
fs_öfo
,

467 
__func__
, 
	`bio_›
(
bio
), bio->
bi_›f
, bio->
bi_ôî
.
bi_£˘‹
,

468 ()
dev
->
bdev
->
bd_dev
, 
	`båfs_dev_«me
(dev),

469 
dev
->
devid
, 
bio
->
bi_ôî
.
bi_size
);

471 
	`båfsic_check_bio
(
bio
);

473 i‡(
bio
->
bi_›f
 & 
REQ_BTRFS_CGROUP_PUNT
)

474 
	`blkcg_pu¡_bio_submô
(
bio
);

476 
	`submô_bio
(
bio
);

477 
	}
}

479 
	$båfs_submô_múr‹ed_bio
(
båfs_io_c⁄ãxt
 *
bioc
, 
dev_ƒ
)

481 
bio
 *
‹ig_bio
 = 
bioc
->orig_bio, *bio;

483 
	`ASSERT
(
	`bio_›
(
‹ig_bio
Ë!
REQ_OP_READ
);

486 i‡(
dev_ƒ
 =
bioc
->
num_°rùes
 - 1) {

487 
bio
 = 
‹ig_bio
;

488 
bio
->
bi_íd_io
 = 
båfs_‹ig_wrôe_íd_io
;

490 
bio
 = 
	`bio_Æloc_˛⁄e
(
NULL
, 
‹ig_bio
, 
GFP_NOFS
, &
fs_bio_£t
);

491 
	`bio_öc_ªmaöög
(
‹ig_bio
);

492 
bio
->
bi_íd_io
 = 
båfs_˛⁄e_wrôe_íd_io
;

495 
bio
->
bi_¥iv©e
 = &
bioc
->
°rùes
[
dev_ƒ
];

496 
bio
->
bi_ôî
.
bi_£˘‹
 = 
bioc
->
°rùes
[
dev_ƒ
].
physiˇl
 >> 
SECTOR_SHIFT
;

497 
bioc
->
°rùes
[
dev_ƒ
].bioc = bioc;

498 
	`båfs_submô_dev_bio
(
bioc
->
°rùes
[
dev_ƒ
].
dev
, 
bio
);

499 
	}
}

501 
	$__båfs_submô_bio
(
bio
 *bio, 
båfs_io_c⁄ãxt
 *
bioc
,

502 
båfs_io_°rùe
 *
sm≠
, 
múr‹_num
)

504 i‡(!
bioc
) {

506 
	`båfs_bio
(
bio
)->
múr‹_num
 = mirror_num;

507 
bio
->
bi_ôî
.
bi_£˘‹
 = 
sm≠
->
physiˇl
 >> 
SECTOR_SHIFT
;

508 i‡(
	`bio_›
(
bio
Ë!
REQ_OP_READ
)

509 
	`båfs_bio
(
bio
)->
‹ig_physiˇl
 = 
sm≠
->
physiˇl
;

510 
bio
->
bi_¥iv©e
 = 
sm≠
->
dev
;

512 
bio
->
bi_íd_io
 = 
båfs_sim∂e_íd_io
;

513 
	`båfs_submô_dev_bio
(
sm≠
->
dev
, 
bio
);

514 } i‡(
bioc
->
m≠_ty≥
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

516 
bio
->
bi_¥iv©e
 = 
bioc
;

517 
bio
->
bi_íd_io
 = 
båfs_øid56_íd_io
;

518 i‡(
	`bio_›
(
bio
Ë=
REQ_OP_READ
)

519 
	`øid56_∑rôy_ªcovî
(
bio
, 
bioc
, 
múr‹_num
);

521 
	`øid56_∑rôy_wrôe
(
bio
, 
bioc
);

524 
tŸÆ_devs
 = 
bioc
->
num_°rùes
;

526 
bioc
->
‹ig_bio
 = 
bio
;

527 
dev_ƒ
 = 0; dev_ƒ < 
tŸÆ_devs
; dev_nr++)

528 
	`båfs_submô_múr‹ed_bio
(
bioc
, 
dev_ƒ
);

530 
	}
}

532 
blk_°©us_t
 
	$båfs_bio_csum
(
båfs_bio
 *
bbio
)

534 i‡(
bbio
->
bio
.
bi_›f
 & 
REQ_META
)

535  
	`båì_csum_⁄e_bio
(
bbio
);

536  
	`båfs_csum_⁄e_bio
(
bbio
);

537 
	}
}

543 
	sasync_submô_bio
 {

544 
båfs_bio
 *
	mbbio
;

545 
båfs_io_c⁄ãxt
 *
	mbioc
;

546 
båfs_io_°rùe
 
	msm≠
;

547 
	mmúr‹_num
;

548 
båfs_w‹k
 
	mw‹k
;

559 
	$run_⁄e_async_°¨t
(
båfs_w‹k
 *
w‹k
)

561 
async_submô_bio
 *
async
 =

562 
	`c⁄èöî_of
(
w‹k
, 
async_submô_bio
, work);

564 
blk_°©us_t
 
ªt
;

568 i‡(
ªt
)

569 
async
->
bbio
->
bio
.
bi_°©us
 = 
ªt
;

570 
	}
}

580 
	$run_⁄e_async_d⁄e
(
båfs_w‹k
 *
w‹k
)

582 
async_submô_bio
 *
async
 =

583 
	`c⁄èöî_of
(
w‹k
, 
async_submô_bio
, work);

584 
bio
 *biÿ&
async
->
bbio
->bio;

587 i‡(
bio
->
bi_°©us
) {

588 
	`båfs_‹ig_bbio_íd_io
(
async
->
bbio
);

597 
bio
->
bi_›f
 |
REQ_BTRFS_CGROUP_PUNT
;

598 
	`__båfs_submô_bio
(
bio
, 
async
->
bioc
, &async->
sm≠
,ásync->
múr‹_num
);

599 
	}
}

601 
	$run_⁄e_async_‰ì
(
båfs_w‹k
 *
w‹k
)

603 
	`k‰ì
(
	`c⁄èöî_of
(
w‹k
, 
async_submô_bio
, work));

604 
	}
}

606 
boﬁ
 
	$should_async_wrôe
(
båfs_bio
 *
bbio
)

609 i‡(
	`ã°_bô
(
BTRFS_FS_CSUM_IMPL_FAST
, &
bbio
->
fs_öfo
->
Êags
))

610  
Ál£
;

616 i‡(
	`›_is_sync
(
bbio
->
bio
.
bi_›f
))

617  
Ál£
;

620 i‡((
bbio
->
bio
.
bi_›f
 & 
REQ_META
Ë&& 
	`båfs_is_z⁄ed
(bbio->
fs_öfo
))

621  
Ál£
;

623  
åue
;

624 
	}
}

631 
boﬁ
 
	$båfs_wq_submô_bio
(
båfs_bio
 *
bbio
,

632 
båfs_io_c⁄ãxt
 *
bioc
,

633 
båfs_io_°rùe
 *
sm≠
, 
múr‹_num
)

635 
båfs_fs_öfo
 *
fs_öfo
 = 
bbio
->fs_info;

636 
async_submô_bio
 *
async
;

638 
async
 = 
	`kmÆloc
((*async), 
GFP_NOFS
);

639 i‡(!
async
)

640  
Ál£
;

642 
async
->
bbio
 = bbio;

643 
async
->
bioc
 = bioc;

644 
async
->
sm≠
 = *smap;

645 
async
->
múr‹_num
 = mirror_num;

647 
	`båfs_öô_w‹k
(&
async
->
w‹k
, 
run_⁄e_async_°¨t
, 
run_⁄e_async_d⁄e
,

648 
run_⁄e_async_‰ì
);

649 
	`båfs_queue_w‹k
(
fs_öfo
->
w‹kîs
, &
async
->
w‹k
);

650  
åue
;

651 
	}
}

653 
boﬁ
 
	$båfs_submô_chunk
(
båfs_bio
 *
bbio
, 
múr‹_num
)

655 
båfs_öode
 *
öode
 = 
bbio
->inode;

656 
båfs_fs_öfo
 *
fs_öfo
 = 
bbio
->fs_info;

657 
båfs_bio
 *
‹ig_bbio
 = 
bbio
;

658 
bio
 *biÿ&
bbio
->bio;

659 
u64
 
logiˇl
 = 
bio
->
bi_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
;

660 
u64
 
Àngth
 = 
bio
->
bi_ôî
.
bi_size
;

661 
u64
 
m≠_Àngth
 = 
Àngth
;

662 
boﬁ
 
u£_≠≥nd
 = 
	`båfs_u£_z⁄e_≠≥nd
(
bbio
);

663 
båfs_io_c⁄ãxt
 *
bioc
 = 
NULL
;

664 
båfs_io_°rùe
 
sm≠
;

665 
blk_°©us_t
 
ªt
;

666 
îr‹
;

669 
	`båfs_bio_cou¡î_öc_blocked
(
fs_öfo
);

670 
îr‹
 = 
	`båfs_m≠_block
(
fs_öfo
, 
	`båfs_›
(
bio
), 
logiˇl
, &
m≠_Àngth
,

671 &
bioc
, &
sm≠
, &
múr‹_num
, 1);

672 i‡(
îr‹
) {

673 
ªt
 = 
	`î∫o_to_blk_°©us
(
îr‹
);

674 
Áû
;

677 
m≠_Àngth
 = 
	`mö
(m≠_Àngth, 
Àngth
);

678 i‡(
u£_≠≥nd
)

679 
m≠_Àngth
 = 
	`mö
(m≠_Àngth, 
fs_öfo
->
max_z⁄e_≠≥nd_size
);

681 i‡(
m≠_Àngth
 < 
Àngth
) {

682 
bbio
 = 
	`båfs_•lô_bio
(
fs_öfo
, bbio, 
m≠_Àngth
, 
u£_≠≥nd
);

683 
bio
 = &
bbio
->bio;

690 i‡(
	`bio_›
(
bio
Ë=
REQ_OP_READ
 && 
	`is_d©a_bbio
(
bbio
)) {

691 
bbio
->
ßved_ôî
 = 
bio
->
bi_ôî
;

694 i‡(
ªt
)

695 
Áû_put_bio
;

698 i‡(
	`båfs_›
(
bio
Ë=
BTRFS_MAP_WRITE
) {

699 i‡(
u£_≠≥nd
) {

700 
bio
->
bi_›f
 &~
REQ_OP_WRITE
;

701 
bio
->
bi_›f
 |
REQ_OP_ZONE_APPEND
;

708 i‡(
öode
 && !(öode->
Êags
 & 
BTRFS_INODE_NODATASUM
) &&

709 !
	`ã°_bô
(
BTRFS_FS_STATE_NO_CSUMS
, &
fs_öfo
->
fs_°©e
) &&

710 !
	`båfs_is_d©a_ªloc_roŸ
(
öode
->
roŸ
)) {

711 i‡(
	`should_async_wrôe
(
bbio
) &&

712 
	`båfs_wq_submô_bio
(
bbio
, 
bioc
, &
sm≠
, 
múr‹_num
))

713 
d⁄e
;

718 i‡(
ªt
)

719 
Áû_put_bio
;

720 } i‡(
u£_≠≥nd
) {

721 
ªt
 = 
	`båfs_Æloc_dummy_sum
(
bbio
);

722 i‡(
ªt
)

723 
Áû_put_bio
;

728 
	`__båfs_submô_bio
(
bio
, 
bioc
, &
sm≠
, 
múr‹_num
);

729 
d⁄e
:

730  
m≠_Àngth
 =
Àngth
;

732 
Áû_put_bio
:

733 i‡(
m≠_Àngth
 < 
Àngth
)

734 
	`båfs_˛ónup_bio
(
bbio
);

735 
Áû
:

736 
	`båfs_bio_cou¡î_dec
(
fs_öfo
);

737 
	`båfs_bio_íd_io
(
‹ig_bbio
, 
ªt
);

739  
åue
;

740 
	}
}

742 
	$båfs_submô_bio
(
båfs_bio
 *
bbio
, 
múr‹_num
)

745 
	`ASSERT
(
bbio
->
öode
 || bbio->
fûe_off£t
 == 0);

747 !
	`båfs_submô_chunk
(
bbio
, 
múr‹_num
))

749 
	}
}

761 
	$båfs_ª∑ú_io_Áûuª
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
öo
, u64 
°¨t
,

762 
u64
 
Àngth
, u64 
logiˇl
, 
∑ge
 *page,

763 
pg_off£t
, 
múr‹_num
)

765 
båfs_io_°rùe
 
sm≠
 = { 0 };

766 
bio_vec
 
bvec
;

767 
bio
 bio;

768 
ªt
 = 0;

770 
	`ASSERT
(!(
fs_öfo
->
sb
->
s_Êags
 & 
SB_RDONLY
));

771 
	`BUG_ON
(!
múr‹_num
);

773 i‡(
	`båfs_ª∑ú_⁄e_z⁄e
(
fs_öfo
, 
logiˇl
))

781 
	`båfs_bio_cou¡î_öc_blocked
(
fs_öfo
);

782 
ªt
 = 
	`båfs_m≠_ª∑ú_block
(
fs_öfo
, &
sm≠
, 
logiˇl
, 
Àngth
, 
múr‹_num
);

783 i‡(
ªt
 < 0)

784 
out_cou¡î_dec
;

786 i‡(!
sm≠
.
dev
->
bdev
 ||

787 !
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
sm≠
.
dev
->
dev_°©e
)) {

788 
ªt
 = -
EIO
;

789 
out_cou¡î_dec
;

792 
	`bio_öô
(&
bio
, 
sm≠
.
dev
->
bdev
, &
bvec
, 1, 
REQ_OP_WRITE
 | 
REQ_SYNC
);

793 
bio
.
bi_ôî
.
bi_£˘‹
 = 
sm≠
.
physiˇl
 >> 
SECTOR_SHIFT
;

794 
	`__bio_add_∑ge
(&
bio
, 
∑ge
, 
Àngth
, 
pg_off£t
);

796 
	`båfsic_check_bio
(&
bio
);

797 
ªt
 = 
	`submô_bio_waô
(&
bio
);

798 i‡(
ªt
) {

800 
	`båfs_dev_°©_öc_™d_¥öt
(
sm≠
.
dev
, 
BTRFS_DEV_STAT_WRITE_ERRS
);

801 
out_bio_unöô
;

804 
	`båfs_öfo_æ_ö_rcu
(
fs_öfo
,

806 
öo
, 
°¨t
, 
	`båfs_dev_«me
(
sm≠
.
dev
),

807 
sm≠
.
physiˇl
 >> 
SECTOR_SHIFT
);

808 
ªt
 = 0;

810 
out_bio_unöô
:

811 
	`bio_unöô
(&
bio
);

812 
out_cou¡î_dec
:

813 
	`båfs_bio_cou¡î_dec
(
fs_öfo
);

814  
ªt
;

815 
	}
}

822 
	$båfs_submô_ª∑ú_wrôe
(
båfs_bio
 *
bbio
, 
múr‹_num
, 
boﬁ
 
dev_ª∂a˚
)

824 
båfs_fs_öfo
 *
fs_öfo
 = 
bbio
->fs_info;

825 
u64
 
logiˇl
 = 
bbio
->
bio
.
bi_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
;

826 
u64
 
Àngth
 = 
bbio
->
bio
.
bi_ôî
.
bi_size
;

827 
båfs_io_°rùe
 
sm≠
 = { 0 };

828 
ªt
;

830 
	`ASSERT
(
fs_öfo
);

831 
	`ASSERT
(
múr‹_num
 > 0);

832 
	`ASSERT
(
	`båfs_›
(&
bbio
->
bio
Ë=
BTRFS_MAP_WRITE
);

833 
	`ASSERT
(!
bbio
->
öode
);

835 
	`båfs_bio_cou¡î_öc_blocked
(
fs_öfo
);

836 
ªt
 = 
	`båfs_m≠_ª∑ú_block
(
fs_öfo
, &
sm≠
, 
logiˇl
, 
Àngth
, 
múr‹_num
);

837 i‡(
ªt
 < 0)

838 
Áû
;

840 i‡(
dev_ª∂a˚
) {

841 
	`ASSERT
(
sm≠
.
dev
 =
fs_öfo
->
dev_ª∂a˚
.
§cdev
);

842 
sm≠
.
dev
 = 
fs_öfo
->
dev_ª∂a˚
.
tgtdev
;

844 
	`__båfs_submô_bio
(&
bbio
->
bio
, 
NULL
, &
sm≠
, 
múr‹_num
);

847 
Áû
:

848 
	`båfs_bio_cou¡î_dec
(
fs_öfo
);

849 
	`båfs_bio_íd_io
(
bbio
, 
	`î∫o_to_blk_°©us
(
ªt
));

850 
	}
}

852 
__öô
 
	$båfs_bio£t_öô
()

854 i‡(
	`bio£t_öô
(&
båfs_bio£t
, 
BIO_POOL_SIZE
,

855 
	`off£tof
(
båfs_bio
, 
bio
),

856 
BIOSET_NEED_BVECS
))

857  -
ENOMEM
;

858 i‡(
	`bio£t_öô
(&
båfs_˛⁄e_bio£t
, 
BIO_POOL_SIZE
,

859 
	`off£tof
(
båfs_bio
, 
bio
), 0))

860 
out_‰ì_bio£t
;

861 i‡(
	`bio£t_öô
(&
båfs_ª∑ú_bio£t
, 
BIO_POOL_SIZE
,

862 
	`off£tof
(
båfs_bio
, 
bio
),

863 
BIOSET_NEED_BVECS
))

864 
out_‰ì_˛⁄e_bio£t
;

865 i‡(
	`mempoﬁ_öô_kmÆloc_poﬁ
(&
båfs_Áûed_bio_poﬁ
, 
BIO_POOL_SIZE
,

866 (
båfs_Áûed_bio
)))

867 
out_‰ì_ª∑ú_bio£t
;

870 
out_‰ì_ª∑ú_bio£t
:

871 
	`bio£t_exô
(&
båfs_ª∑ú_bio£t
);

872 
out_‰ì_˛⁄e_bio£t
:

873 
	`bio£t_exô
(&
båfs_˛⁄e_bio£t
);

874 
out_‰ì_bio£t
:

875 
	`bio£t_exô
(&
båfs_bio£t
);

876  -
ENOMEM
;

877 
	}
}

879 
__cﬁd
 
	$båfs_bio£t_exô
()

881 
	`mempoﬁ_exô
(&
båfs_Áûed_bio_poﬁ
);

882 
	`bio£t_exô
(&
båfs_ª∑ú_bio£t
);

883 
	`bio£t_exô
(&
båfs_˛⁄e_bio£t
);

884 
	`bio£t_exô
(&
båfs_bio£t
);

885 
	}
}

	@bio.h

7 #i‚de‡
BTRFS_BIO_H


8 
	#BTRFS_BIO_H


	)

10 
	~<löux/bio.h
>

11 
	~<löux/w‹kqueue.h
>

12 
	~"åì-checkî.h
"

14 
	gbåfs_bio
;

15 
	gbåfs_fs_öfo
;

17 
	#BTRFS_BIO_INLINE_CSUM_SIZE
 64

	)

24 
	#BTRFS_MAX_BIO_SECTORS
 (256)

	)

26 (*
	tbåfs_bio_íd_io_t
)(
	tbåfs_bio
 *
	tbbio
);

32 
	sbåfs_bio
 {

37 
båfs_öode
 *
öode
;

38 
u64
 
fûe_off£t
;

46 
u8
 *
csum
;

47 
u8
 
csum_ölöe
[
BTRFS_BIO_INLINE_CSUM_SIZE
];

48 
bvec_ôî
 
ßved_ôî
;

59 
båfs_‹dîed_exã¡
 *
‹dîed
;

60 
båfs_‹dîed_sum
 *
sums
;

61 
u64
 
‹ig_physiˇl
;

65 
båfs_åì_∑ª¡_check
 
∑ª¡_check
;

69 
båfs_bio_íd_io_t
 
íd_io
;

70 *
¥iv©e
;

73 
múr‹_num
;

74 
©omic_t
 
≥ndög_ios
;

75 
w‹k_°ru˘
 
íd_io_w‹k
;

78 
båfs_fs_öfo
 *
fs_öfo
;

84 
bio
 bio;

87 
ölöe
 
båfs_bio
 *
	$båfs_bio
(
bio
 *bio)

89  
	`c⁄èöî_of
(
bio
, 
båfs_bio
, bio);

90 
	}
}

92 
__öô
 
båfs_bio£t_öô
();

93 
__cﬁd
 
båfs_bio£t_exô
();

95 
båfs_bio_öô
(
båfs_bio
 *
bbio
, 
båfs_fs_öfo
 *
fs_öfo
,

96 
båfs_bio_íd_io_t
 
íd_io
, *
¥iv©e
);

97 
båfs_bio
 *
båfs_bio_Æloc
(
ƒ_vecs
, 
blk_›f_t
 
›f
,

98 
båfs_fs_öfo
 *
fs_öfo
,

99 
båfs_bio_íd_io_t
 
íd_io
, *
¥iv©e
);

100 
båfs_bio_íd_io
(
båfs_bio
 *
bbio
, 
blk_°©us_t
 
°©us
);

103 
	#REQ_BTRFS_CGROUP_PUNT
 
REQ_FS_PRIVATE


	)

105 
båfs_submô_bio
(
båfs_bio
 *
bbio
, 
múr‹_num
);

106 
båfs_submô_ª∑ú_wrôe
(
båfs_bio
 *
bbio
, 
múr‹_num
, 
boﬁ
 
dev_ª∂a˚
);

107 
båfs_ª∑ú_io_Áûuª
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
öo
, u64 
°¨t
,

108 
u64
 
Àngth
, u64 
logiˇl
, 
∑ge
 *page,

109 
pg_off£t
, 
múr‹_num
);

	@block-group.c

3 
	~<löux/sizes.h
>

4 
	~<löux/li°_s‹t.h
>

5 
	~"misc.h
"

6 
	~"˘ªe.h
"

7 
	~"block-group.h
"

8 
	~"•a˚-öfo.h
"

9 
	~"disk-io.h
"

10 
	~"‰ì-•a˚-ˇche.h
"

11 
	~"‰ì-•a˚-åì.h
"

12 
	~"vﬁumes.h
"

13 
	~"å™ß˘i⁄.h
"

14 
	~"ªf-vîify.h
"

15 
	~"sysfs.h
"

16 
	~"åì-log.h
"

17 
	~"dñÆloc-•a˚.h
"

18 
	~"disˇrd.h
"

19 
	~"øid56.h
"

20 
	~"z⁄ed.h
"

21 
	~"fs.h
"

22 
	~"ac˚ss‹s.h
"

23 
	~"exã¡-åì.h
"

25 #ifde‡
CONFIG_BTRFS_DEBUG


26 
	$båfs_should_‰agmít_‰ì_•a˚
(
båfs_block_group
 *
block_group
)

28 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

30  (
	`båfs_ã°_›t
(
fs_öfo
, 
FRAGMENT_METADATA
) &&

31 
block_group
->
Êags
 & 
BTRFS_BLOCK_GROUP_METADATA
) ||

32 (
	`båfs_ã°_›t
(
fs_öfo
, 
FRAGMENT_DATA
) &&

33 
block_group
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
);

34 
	}
}

43 
u64
 
	$gë_ª°rùe_èrgë
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
Êags
)

45 
båfs_bÆ™˚_c⁄åﬁ
 *
b˘l
 = 
fs_öfo
->
bÆ™˚_˘l
;

46 
u64
 
èrgë
 = 0;

48 i‡(!
b˘l
)

51 i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
 &&

52 
b˘l
->
d©a
.
Êags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) {

53 
èrgë
 = 
BTRFS_BLOCK_GROUP_DATA
 | 
b˘l
->
d©a
.target;

54 } i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
 &&

55 
b˘l
->
sys
.
Êags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) {

56 
èrgë
 = 
BTRFS_BLOCK_GROUP_SYSTEM
 | 
b˘l
->
sys
.target;

57 } i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_METADATA
 &&

58 
b˘l
->
mëa
.
Êags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) {

59 
èrgë
 = 
BTRFS_BLOCK_GROUP_METADATA
 | 
b˘l
->
mëa
.target;

62  
èrgë
;

63 
	}
}

72 
u64
 
	$båfs_ªdu˚_Æloc_¥ofûe
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
Êags
)

74 
u64
 
num_devi˚s
 = 
fs_öfo
->
fs_devi˚s
->
rw_devi˚s
;

75 
u64
 
èrgë
;

76 
u64
 
øid_ty≥
;

77 
u64
 
Ælowed
 = 0;

83 
	`•ö_lock
(&
fs_öfo
->
bÆ™˚_lock
);

84 
èrgë
 = 
	`gë_ª°rùe_èrgë
(
fs_öfo
, 
Êags
);

85 i‡(
èrgë
) {

86 
	`•ö_u∆ock
(&
fs_öfo
->
bÆ™˚_lock
);

87  
	`exãnded_to_chunk
(
èrgë
);

89 
	`•ö_u∆ock
(&
fs_öfo
->
bÆ™˚_lock
);

92 
øid_ty≥
 = 0;Ñaid_ty≥ < 
BTRFS_NR_RAID_TYPES
;Ñaid_type++) {

93 i‡(
num_devi˚s
 >
båfs_øid_¨øy
[
øid_ty≥
].
devs_mö
)

94 
Ælowed
 |
båfs_øid_¨øy
[
øid_ty≥
].
bg_Êag
;

96 
Ælowed
 &
Êags
;

99 i‡(
Ælowed
 & 
BTRFS_BLOCK_GROUP_RAID1C4
)

100 
Ælowed
 = 
BTRFS_BLOCK_GROUP_RAID1C4
;

101 i‡(
Ælowed
 & 
BTRFS_BLOCK_GROUP_RAID6
)

102 
Ælowed
 = 
BTRFS_BLOCK_GROUP_RAID6
;

103 i‡(
Ælowed
 & 
BTRFS_BLOCK_GROUP_RAID1C3
)

104 
Ælowed
 = 
BTRFS_BLOCK_GROUP_RAID1C3
;

105 i‡(
Ælowed
 & 
BTRFS_BLOCK_GROUP_RAID5
)

106 
Ælowed
 = 
BTRFS_BLOCK_GROUP_RAID5
;

107 i‡(
Ælowed
 & 
BTRFS_BLOCK_GROUP_RAID10
)

108 
Ælowed
 = 
BTRFS_BLOCK_GROUP_RAID10
;

109 i‡(
Ælowed
 & 
BTRFS_BLOCK_GROUP_RAID1
)

110 
Ælowed
 = 
BTRFS_BLOCK_GROUP_RAID1
;

111 i‡(
Ælowed
 & 
BTRFS_BLOCK_GROUP_DUP
)

112 
Ælowed
 = 
BTRFS_BLOCK_GROUP_DUP
;

113 i‡(
Ælowed
 & 
BTRFS_BLOCK_GROUP_RAID0
)

114 
Ælowed
 = 
BTRFS_BLOCK_GROUP_RAID0
;

116 
Êags
 &~
BTRFS_BLOCK_GROUP_PROFILE_MASK
;

118  
	`exãnded_to_chunk
(
Êags
 | 
Ælowed
);

119 
	}
}

121 
u64
 
	$båfs_gë_Æloc_¥ofûe
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
‹ig_Êags
)

123 
£q
;

124 
u64
 
Êags
;

127 
Êags
 = 
‹ig_Êags
;

128 
£q
 = 
	`ªad_£qbegö
(&
fs_öfo
->
¥ofûes_lock
);

130 i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
)

131 
Êags
 |
fs_öfo
->
avaû_d©a_Æloc_bôs
;

132 i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

133 
Êags
 |
fs_öfo
->
avaû_sy°em_Æloc_bôs
;

134 i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_METADATA
)

135 
Êags
 |
fs_öfo
->
avaû_mëad©a_Æloc_bôs
;

136 } 
	`ªad_£qªåy
(&
fs_öfo
->
¥ofûes_lock
, 
£q
));

138  
	`båfs_ªdu˚_Æloc_¥ofûe
(
fs_öfo
, 
Êags
);

139 
	}
}

141 
	$båfs_gë_block_group
(
båfs_block_group
 *
ˇche
)

143 
	`ªfcou¡_öc
(&
ˇche
->
ªfs
);

144 
	}
}

146 
	$båfs_put_block_group
(
båfs_block_group
 *
ˇche
)

148 i‡(
	`ªfcou¡_dec_™d_ã°
(&
ˇche
->
ªfs
)) {

149 
	`WARN_ON
(
ˇche
->
pö√d
 > 0);

157 i‡(!(
ˇche
->
Êags
 & 
BTRFS_BLOCK_GROUP_METADATA
) ||

158 !
	`BTRFS_FS_LOG_CLEANUP_ERROR
(
ˇche
->
fs_öfo
))

159 
	`WARN_ON
(
ˇche
->
ª£rved
 > 0);

166 i‡(
	`WARN_ON
(!
	`li°_em±y
(&
ˇche
->
disˇrd_li°
)))

167 
	`båfs_disˇrd_ˇn˚l_w‹k
(&
ˇche
->
fs_öfo
->
disˇrd_˘l
,

168 
ˇche
);

170 
	`k‰ì
(
ˇche
->
‰ì_•a˚_˘l
);

171 
	`k‰ì
(
ˇche
->
physiˇl_m≠
);

172 
	`k‰ì
(
ˇche
);

174 
	}
}

179 
	$båfs_add_block_group_ˇche
(
båfs_fs_öfo
 *
öfo
,

180 
båfs_block_group
 *
block_group
)

182 
rb_node
 **
p
;

183 
rb_node
 *
∑ª¡
 = 
NULL
;

184 
båfs_block_group
 *
ˇche
;

185 
boﬁ
 
À·mo°
 = 
åue
;

187 
	`ASSERT
(
block_group
->
Àngth
 != 0);

189 
	`wrôe_lock
(&
öfo
->
block_group_ˇche_lock
);

190 
p
 = &
öfo
->
block_group_ˇche_åì
.
rb_roŸ
.
rb_node
;

192 *
p
) {

193 
∑ª¡
 = *
p
;

194 
ˇche
 = 
	`rb_íåy
(
∑ª¡
, 
båfs_block_group
, 
ˇche_node
);

195 i‡(
block_group
->
°¨t
 < 
ˇche
->start) {

196 
p
 = &(*p)->
rb_À·
;

197 } i‡(
block_group
->
°¨t
 > 
ˇche
->start) {

198 
p
 = &(*p)->
rb_right
;

199 
À·mo°
 = 
Ál£
;

201 
	`wrôe_u∆ock
(&
öfo
->
block_group_ˇche_lock
);

202  -
EEXIST
;

206 
	`rb_lök_node
(&
block_group
->
ˇche_node
, 
∑ª¡
, 
p
);

207 
	`rb_ö£π_cﬁ‹_ˇched
(&
block_group
->
ˇche_node
,

208 &
öfo
->
block_group_ˇche_åì
, 
À·mo°
);

210 
	`wrôe_u∆ock
(&
öfo
->
block_group_ˇche_lock
);

213 
	}
}

219 
båfs_block_group
 *
	$block_group_ˇche_åì_£¨ch
(

220 
båfs_fs_öfo
 *
öfo
, 
u64
 
byãƒ
, 
c⁄èös
)

222 
båfs_block_group
 *
ˇche
, *
ªt
 = 
NULL
;

223 
rb_node
 *
n
;

224 
u64
 
íd
, 
°¨t
;

226 
	`ªad_lock
(&
öfo
->
block_group_ˇche_lock
);

227 
n
 = 
öfo
->
block_group_ˇche_åì
.
rb_roŸ
.
rb_node
;

229 
n
) {

230 
ˇche
 = 
	`rb_íåy
(
n
, 
båfs_block_group
, 
ˇche_node
);

231 
íd
 = 
ˇche
->
°¨t
 + cache->
Àngth
 - 1;

232 
°¨t
 = 
ˇche
->start;

234 i‡(
byãƒ
 < 
°¨t
) {

235 i‡(!
c⁄èös
 && (!
ªt
 || 
°¨t
 <Ñet->start))

236 
ªt
 = 
ˇche
;

237 
n
 =Ç->
rb_À·
;

238 } i‡(
byãƒ
 > 
°¨t
) {

239 i‡(
c⁄èös
 && 
byãƒ
 <
íd
) {

240 
ªt
 = 
ˇche
;

243 
n
 =Ç->
rb_right
;

245 
ªt
 = 
ˇche
;

249 i‡(
ªt
)

250 
	`båfs_gë_block_group
(
ªt
);

251 
	`ªad_u∆ock
(&
öfo
->
block_group_ˇche_lock
);

253  
ªt
;

254 
	}
}

259 
båfs_block_group
 *
	$båfs_lookup_fú°_block_group
(

260 
båfs_fs_öfo
 *
öfo
, 
u64
 
byãƒ
)

262  
	`block_group_ˇche_åì_£¨ch
(
öfo
, 
byãƒ
, 0);

263 
	}
}

268 
båfs_block_group
 *
	$båfs_lookup_block_group
(

269 
båfs_fs_öfo
 *
öfo
, 
u64
 
byãƒ
)

271  
	`block_group_ˇche_åì_£¨ch
(
öfo
, 
byãƒ
, 1);

272 
	}
}

274 
båfs_block_group
 *
	$båfs_√xt_block_group
(

275 
båfs_block_group
 *
ˇche
)

277 
båfs_fs_öfo
 *
fs_öfo
 = 
ˇche
->fs_info;

278 
rb_node
 *
node
;

280 
	`ªad_lock
(&
fs_öfo
->
block_group_ˇche_lock
);

283 i‡(
	`RB_EMPTY_NODE
(&
ˇche
->
ˇche_node
)) {

284 c⁄° 
u64
 
√xt_byãƒ
 = 
ˇche
->
°¨t
 + cache->
Àngth
;

286 
	`ªad_u∆ock
(&
fs_öfo
->
block_group_ˇche_lock
);

287 
	`båfs_put_block_group
(
ˇche
);

288  
	`båfs_lookup_fú°_block_group
(
fs_öfo
, 
√xt_byãƒ
);

290 
node
 = 
	`rb_√xt
(&
ˇche
->
ˇche_node
);

291 
	`båfs_put_block_group
(
ˇche
);

292 i‡(
node
) {

293 
ˇche
 = 
	`rb_íåy
(
node
, 
båfs_block_group
, 
ˇche_node
);

294 
	`båfs_gë_block_group
(
ˇche
);

296 
ˇche
 = 
NULL
;

297 
	`ªad_u∆ock
(&
fs_öfo
->
block_group_ˇche_lock
);

298  
ˇche
;

299 
	}
}

316 
båfs_block_group
 *
	$båfs_öc_nocow_wrôîs
(
båfs_fs_öfo
 *
fs_öfo
,

317 
u64
 
byãƒ
)

319 
båfs_block_group
 *
bg
;

320 
boﬁ
 
ˇn_nocow
 = 
åue
;

322 
bg
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
byãƒ
);

323 i‡(!
bg
)

324  
NULL
;

326 
	`•ö_lock
(&
bg
->
lock
);

327 i‡(
bg
->
ro
)

328 
ˇn_nocow
 = 
Ál£
;

330 
	`©omic_öc
(&
bg
->
nocow_wrôîs
);

331 
	`•ö_u∆ock
(&
bg
->
lock
);

333 i‡(!
ˇn_nocow
) {

334 
	`båfs_put_block_group
(
bg
);

335  
NULL
;

339  
bg
;

340 
	}
}

353 
	$båfs_dec_nocow_wrôîs
(
båfs_block_group
 *
bg
)

355 i‡(
	`©omic_dec_™d_ã°
(&
bg
->
nocow_wrôîs
))

356 
	`wake_up_v¨
(&
bg
->
nocow_wrôîs
);

359 
	`båfs_put_block_group
(
bg
);

360 
	}
}

362 
	$båfs_waô_nocow_wrôîs
(
båfs_block_group
 *
bg
)

364 
	`waô_v¨_evít
(&
bg
->
nocow_wrôîs
, !
	`©omic_ªad
(&bg->nocow_writers));

365 
	}
}

367 
	$båfs_dec_block_group_ª£rv©i⁄s
(
båfs_fs_öfo
 *
fs_öfo
,

368 c⁄° 
u64
 
°¨t
)

370 
båfs_block_group
 *
bg
;

372 
bg
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
°¨t
);

373 
	`ASSERT
(
bg
);

374 i‡(
	`©omic_dec_™d_ã°
(&
bg
->
ª£rv©i⁄s
))

375 
	`wake_up_v¨
(&
bg
->
ª£rv©i⁄s
);

376 
	`båfs_put_block_group
(
bg
);

377 
	}
}

379 
	$båfs_waô_block_group_ª£rv©i⁄s
(
båfs_block_group
 *
bg
)

381 
båfs_•a˚_öfo
 *
•a˚_öfo
 = 
bg
->space_info;

383 
	`ASSERT
(
bg
->
ro
);

385 i‡(!(
bg
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
))

398 
	`down_wrôe
(&
•a˚_öfo
->
groups_£m
);

399 
	`up_wrôe
(&
•a˚_öfo
->
groups_£m
);

401 
	`waô_v¨_evít
(&
bg
->
ª£rv©i⁄s
, !
	`©omic_ªad
(&bg->reservations));

402 
	}
}

404 
båfs_ˇchög_c⁄åﬁ
 *
	$båfs_gë_ˇchög_c⁄åﬁ
(

405 
båfs_block_group
 *
ˇche
)

407 
båfs_ˇchög_c⁄åﬁ
 *
˘l
;

409 
	`•ö_lock
(&
ˇche
->
lock
);

410 i‡(!
ˇche
->
ˇchög_˘l
) {

411 
	`•ö_u∆ock
(&
ˇche
->
lock
);

412  
NULL
;

415 
˘l
 = 
ˇche
->
ˇchög_˘l
;

416 
	`ªfcou¡_öc
(&
˘l
->
cou¡
);

417 
	`•ö_u∆ock
(&
ˇche
->
lock
);

418  
˘l
;

419 
	}
}

421 
	$båfs_put_ˇchög_c⁄åﬁ
(
båfs_ˇchög_c⁄åﬁ
 *
˘l
)

423 i‡(
	`ªfcou¡_dec_™d_ã°
(&
˘l
->
cou¡
))

424 
	`k‰ì
(
˘l
);

425 
	}
}

440 
	$båfs_waô_block_group_ˇche_¥ogªss
(
båfs_block_group
 *
ˇche
,

441 
u64
 
num_byãs
)

443 
båfs_ˇchög_c⁄åﬁ
 *
ˇchög_˘l
;

444 
¥ogªss
;

446 
ˇchög_˘l
 = 
	`båfs_gë_ˇchög_c⁄åﬁ
(
ˇche
);

447 i‡(!
ˇchög_˘l
)

456 
¥ogªss
 = 
	`©omic_ªad
(&
ˇchög_˘l
->progress);

458 
	`waô_evít
(
ˇchög_˘l
->
waô
, 
	`båfs_block_group_d⁄e
(
ˇche
) ||

459 (
¥ogªss
 !
	`©omic_ªad
(&
ˇchög_˘l
->progress) &&

460 (
ˇche
->
‰ì_•a˚_˘l
->
‰ì_•a˚
 >
num_byãs
)));

462 
	`båfs_put_ˇchög_c⁄åﬁ
(
ˇchög_˘l
);

463 
	}
}

465 
	$båfs_ˇchög_˘l_waô_d⁄e
(
båfs_block_group
 *
ˇche
,

466 
båfs_ˇchög_c⁄åﬁ
 *
ˇchög_˘l
)

468 
	`waô_evít
(
ˇchög_˘l
->
waô
, 
	`båfs_block_group_d⁄e
(
ˇche
));

469  
ˇche
->
ˇched
 =
BTRFS_CACHE_ERROR
 ? -
EIO
 : 0;

470 
	}
}

472 
	$båfs_waô_block_group_ˇche_d⁄e
(
båfs_block_group
 *
ˇche
)

474 
båfs_ˇchög_c⁄åﬁ
 *
ˇchög_˘l
;

475 
ªt
;

477 
ˇchög_˘l
 = 
	`båfs_gë_ˇchög_c⁄åﬁ
(
ˇche
);

478 i‡(!
ˇchög_˘l
)

479  (
ˇche
->
ˇched
 =
BTRFS_CACHE_ERROR
Ë? -
EIO
 : 0;

480 
ªt
 = 
	`båfs_ˇchög_˘l_waô_d⁄e
(
ˇche
, 
ˇchög_˘l
);

481 
	`båfs_put_ˇchög_c⁄åﬁ
(
ˇchög_˘l
);

482  
ªt
;

483 
	}
}

485 #ifde‡
CONFIG_BTRFS_DEBUG


486 
	$‰agmít_‰ì_•a˚
(
båfs_block_group
 *
block_group
)

488 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

489 
u64
 
°¨t
 = 
block_group
->start;

490 
u64
 
Àn
 = 
block_group
->
Àngth
;

491 
u64
 
chunk
 = 
block_group
->
Êags
 & 
BTRFS_BLOCK_GROUP_METADATA
 ?

492 
fs_öfo
->
nodesize
 : fs_öfo->
£˘‹size
;

493 
u64
 
°ï
 = 
chunk
 << 1;

495 
Àn
 > 
chunk
) {

496 
	`båfs_ªmove_‰ì_•a˚
(
block_group
, 
°¨t
, 
chunk
);

497 
°¨t
 +
°ï
;

498 i‡(
Àn
 < 
°ï
)

499 
Àn
 = 0;

501 
Àn
 -
°ï
;

503 
	}
}

519 
	$båfs_add_√w_‰ì_•a˚
(
båfs_block_group
 *
block_group
, 
u64
 
°¨t
,

520 
u64
 
íd
, u64 *
tŸÆ_added_ªt
)

522 
båfs_fs_öfo
 *
öfo
 = 
block_group
->
fs_öfo
;

523 
u64
 
exã¡_°¨t
, 
exã¡_íd
, 
size
;

524 
ªt
;

526 i‡(
tŸÆ_added_ªt
)

527 *
tŸÆ_added_ªt
 = 0;

529 
°¨t
 < 
íd
) {

530 i‡(!
	`föd_fú°_exã¡_bô
(&
öfo
->
ex˛uded_exã¡s
, 
°¨t
,

531 &
exã¡_°¨t
, &
exã¡_íd
,

532 
EXTENT_DIRTY
 | 
EXTENT_UPTODATE
,

533 
NULL
))

536 i‡(
exã¡_°¨t
 <
°¨t
) {

537 
°¨t
 = 
exã¡_íd
 + 1;

538 } i‡(
exã¡_°¨t
 > 
°¨t
 &&Éxã¡_°¨à< 
íd
) {

539 
size
 = 
exã¡_°¨t
 - 
°¨t
;

540 
ªt
 = 
	`båfs_add_‰ì_•a˚_async_åimmed
(
block_group
,

541 
°¨t
, 
size
);

542 i‡(
ªt
)

543  
ªt
;

544 i‡(
tŸÆ_added_ªt
)

545 *
tŸÆ_added_ªt
 +
size
;

546 
°¨t
 = 
exã¡_íd
 + 1;

552 i‡(
°¨t
 < 
íd
) {

553 
size
 = 
íd
 - 
°¨t
;

554 
ªt
 = 
	`båfs_add_‰ì_•a˚_async_åimmed
(
block_group
, 
°¨t
,

555 
size
);

556 i‡(
ªt
)

557  
ªt
;

558 i‡(
tŸÆ_added_ªt
)

559 *
tŸÆ_added_ªt
 +
size
;

563 
	}
}

580 
	$ßm∂e_block_group_exã¡_ôem
(
båfs_ˇchög_c⁄åﬁ
 *
ˇchög_˘l
,

581 
båfs_block_group
 *
block_group
,

582 
ödex
, 
max_ödex
,

583 
båfs_key
 *
found_key
)

585 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

586 
båfs_roŸ
 *
exã¡_roŸ
;

587 
u64
 
£¨ch_off£t
;

588 
u64
 
£¨ch_íd
 = 
block_group
->
°¨t
 + block_group->
Àngth
;

589 
båfs_∑th
 *
∑th
;

590 
båfs_key
 
£¨ch_key
;

591 
ªt
 = 0;

593 
	`ASSERT
(
ödex
 >= 0);

594 
	`ASSERT
(
ödex
 <
max_ödex
);

595 
	`ASSERT
(
max_ödex
 > 0);

596 
	`lockdï_as£π_hñd
(&
ˇchög_˘l
->
muãx
);

597 
	`lockdï_as£π_hñd_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

599 
∑th
 = 
	`båfs_Æloc_∑th
();

600 i‡(!
∑th
)

601  -
ENOMEM
;

603 
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
, 
	`max_t
(
u64
, 
block_group
->
°¨t
,

604 
BTRFS_SUPER_INFO_OFFSET
));

606 
∑th
->
skù_lockög
 = 1;

607 
∑th
->
£¨ch_commô_roŸ
 = 1;

608 
∑th
->
ªada
 = 
READA_FORWARD
;

610 
£¨ch_off£t
 = 
ödex
 * 
	`div_u64
(
block_group
->
Àngth
, 
max_ödex
);

611 
£¨ch_key
.
obje˘id
 = 
block_group
->
°¨t
 + 
£¨ch_off£t
;

612 
£¨ch_key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

613 
£¨ch_key
.
off£t
 = 0;

615 
	`båfs_f‹_óch_¶Ÿ
(
exã¡_roŸ
, &
£¨ch_key
, 
found_key
, 
∑th
, 
ªt
) {

617 i‡(
found_key
->
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 &&

618 
found_key
->
obje˘id
 >
block_group
->
°¨t
 &&

619 
found_key
->
obje˘id
 + found_key->
off£t
 <
£¨ch_íd
)

623 i‡(
found_key
->
obje˘id
 >
£¨ch_íd
) {

624 
ªt
 = 1;

629 
	`lockdï_as£π_hñd
(&
ˇchög_˘l
->
muãx
);

630 
	`lockdï_as£π_hñd_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

631 
	`båfs_‰ì_∑th
(
∑th
);

632  
ªt
;

633 
	}
}

669 
	$lﬂd_block_group_size_˛ass
(
båfs_ˇchög_c⁄åﬁ
 *
ˇchög_˘l
,

670 
båfs_block_group
 *
block_group
)

672 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

673 
båfs_key
 
key
;

674 
i
;

675 
u64
 
mö_size
 = 
block_group
->
Àngth
;

676 
båfs_block_group_size_˛ass
 
size_˛ass
 = 
BTRFS_BG_SZ_NONE
;

677 
ªt
;

679 i‡(!
	`båfs_block_group_should_u£_size_˛ass
(
block_group
))

682 
	`lockdï_as£π_hñd
(&
ˇchög_˘l
->
muãx
);

683 
	`lockdï_as£π_hñd_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

684 
i
 = 0; i < 5; ++i) {

685 
ªt
 = 
	`ßm∂e_block_group_exã¡_ôem
(
ˇchög_˘l
, 
block_group
, 
i
, 5, &
key
);

686 i‡(
ªt
 < 0)

687 
out
;

688 i‡(
ªt
 > 0)

690 
mö_size
 = 
	`mö_t
(
u64
, mö_size, 
key
.
off£t
);

691 
size_˛ass
 = 
	`båfs_ˇlc_block_group_size_˛ass
(
mö_size
);

693 i‡(
size_˛ass
 !
BTRFS_BG_SZ_NONE
) {

694 
	`•ö_lock
(&
block_group
->
lock
);

695 
block_group
->
size_˛ass
 = size_class;

696 
	`•ö_u∆ock
(&
block_group
->
lock
);

698 
out
:

699  
ªt
;

700 
	}
}

702 
	$lﬂd_exã¡_åì_‰ì
(
båfs_ˇchög_c⁄åﬁ
 *
ˇchög_˘l
)

704 
båfs_block_group
 *
block_group
 = 
ˇchög_˘l
->block_group;

705 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

706 
båfs_roŸ
 *
exã¡_roŸ
;

707 
båfs_∑th
 *
∑th
;

708 
exã¡_buf„r
 *
Àaf
;

709 
båfs_key
 
key
;

710 
u64
 
tŸÆ_found
 = 0;

711 
u64
 
œ°
 = 0;

712 
u32
 
ƒôems
;

713 
ªt
;

714 
boﬁ
 
wakeup
 = 
åue
;

716 
∑th
 = 
	`båfs_Æloc_∑th
();

717 i‡(!
∑th
)

718  -
ENOMEM
;

720 
œ°
 = 
	`max_t
(
u64
, 
block_group
->
°¨t
, 
BTRFS_SUPER_INFO_OFFSET
);

721 
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
, 
œ°
);

723 #ifde‡
CONFIG_BTRFS_DEBUG


729 i‡(
	`båfs_should_‰agmít_‰ì_•a˚
(
block_group
))

730 
wakeup
 = 
Ál£
;

738 
∑th
->
skù_lockög
 = 1;

739 
∑th
->
£¨ch_commô_roŸ
 = 1;

740 
∑th
->
ªada
 = 
READA_FORWARD
;

742 
key
.
obje˘id
 = 
œ°
;

743 
key
.
off£t
 = 0;

744 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

746 
√xt
:

747 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
exã¡_roŸ
, &
key
, 
∑th
, 0, 0);

748 i‡(
ªt
 < 0)

749 
out
;

751 
Àaf
 = 
∑th
->
nodes
[0];

752 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

755 i‡(
	`båfs_fs_˛osög
(
fs_öfo
) > 1) {

756 
œ°
 = (
u64
)-1;

760 i‡(
∑th
->
¶Ÿs
[0] < 
ƒôems
) {

761 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

763 
ªt
 = 
	`båfs_föd_√xt_key
(
exã¡_roŸ
, 
∑th
, &
key
, 0, 0);

764 i‡(
ªt
)

767 i‡(
	`√ed_ªsched
() ||

768 
	`rw£m_is_c⁄ãnded
(&
fs_öfo
->
commô_roŸ_£m
)) {

769 
	`båfs_ªÀa£_∑th
(
∑th
);

770 
	`up_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

771 
	`muãx_u∆ock
(&
ˇchög_˘l
->
muãx
);

772 
	`c⁄d_ªsched
();

773 
	`muãx_lock
(&
ˇchög_˘l
->
muãx
);

774 
	`down_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

775 
√xt
;

778 
ªt
 = 
	`båfs_√xt_Àaf
(
exã¡_roŸ
, 
∑th
);

779 i‡(
ªt
 < 0)

780 
out
;

781 i‡(
ªt
)

783 
Àaf
 = 
∑th
->
nodes
[0];

784 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

788 i‡(
key
.
obje˘id
 < 
œ°
) {

789 
key
.
obje˘id
 = 
œ°
;

790 
key
.
off£t
 = 0;

791 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

792 
	`båfs_ªÀa£_∑th
(
∑th
);

793 
√xt
;

796 i‡(
key
.
obje˘id
 < 
block_group
->
°¨t
) {

797 
∑th
->
¶Ÿs
[0]++;

801 i‡(
key
.
obje˘id
 >
block_group
->
°¨t
 + block_group->
Àngth
)

804 i‡(
key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 ||

805 
key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
) {

806 
u64
 
•a˚_added
;

808 
ªt
 = 
	`båfs_add_√w_‰ì_•a˚
(
block_group
, 
œ°
,

809 
key
.
obje˘id
, &
•a˚_added
);

810 i‡(
ªt
)

811 
out
;

812 
tŸÆ_found
 +
•a˚_added
;

813 i‡(
key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
)

814 
œ°
 = 
key
.
obje˘id
 +

815 
fs_öfo
->
nodesize
;

817 
œ°
 = 
key
.
obje˘id
 + key.
off£t
;

819 i‡(
tŸÆ_found
 > 
CACHING_CTL_WAKE_UP
) {

820 
tŸÆ_found
 = 0;

821 i‡(
wakeup
) {

822 
	`©omic_öc
(&
ˇchög_˘l
->
¥ogªss
);

823 
	`wake_up
(&
ˇchög_˘l
->
waô
);

827 
∑th
->
¶Ÿs
[0]++;

830 
ªt
 = 
	`båfs_add_√w_‰ì_•a˚
(
block_group
, 
œ°
,

831 
block_group
->
°¨t
 + block_group->
Àngth
,

832 
NULL
);

833 
out
:

834 
	`båfs_‰ì_∑th
(
∑th
);

835  
ªt
;

836 
	}
}

838 
ölöe
 
	$båfs_‰ì_ex˛uded_exã¡s
(c⁄° 
båfs_block_group
 *
bg
)

840 
	`˛ór_exã¡_bôs
(&
bg
->
fs_öfo
->
ex˛uded_exã¡s
, bg->
°¨t
,

841 
bg
->
°¨t
 + bg->
Àngth
 - 1, 
EXTENT_UPTODATE
);

842 
	}
}

844 
noölöe
 
	$ˇchög_thªad
(
båfs_w‹k
 *
w‹k
)

846 
båfs_block_group
 *
block_group
;

847 
båfs_fs_öfo
 *
fs_öfo
;

848 
båfs_ˇchög_c⁄åﬁ
 *
ˇchög_˘l
;

849 
ªt
;

851 
ˇchög_˘l
 = 
	`c⁄èöî_of
(
w‹k
, 
båfs_ˇchög_c⁄åﬁ
, work);

852 
block_group
 = 
ˇchög_˘l
->block_group;

853 
fs_öfo
 = 
block_group
->fs_info;

855 
	`muãx_lock
(&
ˇchög_˘l
->
muãx
);

856 
	`down_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

858 
	`lﬂd_block_group_size_˛ass
(
ˇchög_˘l
, 
block_group
);

859 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
SPACE_CACHE
)) {

860 
ªt
 = 
	`lﬂd_‰ì_•a˚_ˇche
(
block_group
);

861 i‡(
ªt
 == 1) {

862 
ªt
 = 0;

863 
d⁄e
;

870 
	`•ö_lock
(&
block_group
->
lock
);

871 
block_group
->
ˇched
 = 
BTRFS_CACHE_STARTED
;

872 
	`•ö_u∆ock
(&
block_group
->
lock
);

873 
	`wake_up
(&
ˇchög_˘l
->
waô
);

883 i‡(
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE
) &&

884 !(
	`ã°_bô
(
BTRFS_FS_FREE_SPACE_TREE_UNTRUSTED
, &
fs_öfo
->
Êags
)))

885 
ªt
 = 
	`lﬂd_‰ì_•a˚_åì
(
ˇchög_˘l
);

887 
ªt
 = 
	`lﬂd_exã¡_åì_‰ì
(
ˇchög_˘l
);

888 
d⁄e
:

889 
	`•ö_lock
(&
block_group
->
lock
);

890 
block_group
->
ˇchög_˘l
 = 
NULL
;

891 
block_group
->
ˇched
 = 
ªt
 ? 
BTRFS_CACHE_ERROR
 : 
BTRFS_CACHE_FINISHED
;

892 
	`•ö_u∆ock
(&
block_group
->
lock
);

894 #ifde‡
CONFIG_BTRFS_DEBUG


895 i‡(
	`båfs_should_‰agmít_‰ì_•a˚
(
block_group
)) {

896 
u64
 
byãs_u£d
;

898 
	`•ö_lock
(&
block_group
->
•a˚_öfo
->
lock
);

899 
	`•ö_lock
(&
block_group
->
lock
);

900 
byãs_u£d
 = 
block_group
->
Àngth
 - block_group->
u£d
;

901 
block_group
->
•a˚_öfo
->
byãs_u£d
 += bytes_used >> 1;

902 
	`•ö_u∆ock
(&
block_group
->
lock
);

903 
	`•ö_u∆ock
(&
block_group
->
•a˚_öfo
->
lock
);

904 
	`‰agmít_‰ì_•a˚
(
block_group
);

908 
	`up_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

909 
	`båfs_‰ì_ex˛uded_exã¡s
(
block_group
);

910 
	`muãx_u∆ock
(&
ˇchög_˘l
->
muãx
);

912 
	`wake_up
(&
ˇchög_˘l
->
waô
);

914 
	`båfs_put_ˇchög_c⁄åﬁ
(
ˇchög_˘l
);

915 
	`båfs_put_block_group
(
block_group
);

916 
	}
}

918 
	$båfs_ˇche_block_group
(
båfs_block_group
 *
ˇche
, 
boﬁ
 
waô
)

920 
båfs_fs_öfo
 *
fs_öfo
 = 
ˇche
->fs_info;

921 
båfs_ˇchög_c⁄åﬁ
 *
ˇchög_˘l
 = 
NULL
;

922 
ªt
 = 0;

925 i‡(
	`båfs_is_z⁄ed
(
fs_öfo
))

928 
ˇchög_˘l
 = 
	`kzÆloc
((*ˇchög_˘l), 
GFP_NOFS
);

929 i‡(!
ˇchög_˘l
)

930  -
ENOMEM
;

932 
	`INIT_LIST_HEAD
(&
ˇchög_˘l
->
li°
);

933 
	`muãx_öô
(&
ˇchög_˘l
->
muãx
);

934 
	`öô_waôqueue_hód
(&
ˇchög_˘l
->
waô
);

935 
ˇchög_˘l
->
block_group
 = 
ˇche
;

936 
	`ªfcou¡_£t
(&
ˇchög_˘l
->
cou¡
, 2);

937 
	`©omic_£t
(&
ˇchög_˘l
->
¥ogªss
, 0);

938 
	`båfs_öô_w‹k
(&
ˇchög_˘l
->
w‹k
, 
ˇchög_thªad
, 
NULL
, NULL);

940 
	`•ö_lock
(&
ˇche
->
lock
);

941 i‡(
ˇche
->
ˇched
 !
BTRFS_CACHE_NO
) {

942 
	`k‰ì
(
ˇchög_˘l
);

944 
ˇchög_˘l
 = 
ˇche
->caching_ctl;

945 i‡(
ˇchög_˘l
)

946 
	`ªfcou¡_öc
(&
ˇchög_˘l
->
cou¡
);

947 
	`•ö_u∆ock
(&
ˇche
->
lock
);

948 
out
;

950 
	`WARN_ON
(
ˇche
->
ˇchög_˘l
);

951 
ˇche
->
ˇchög_˘l
 = caching_ctl;

952 
ˇche
->
ˇched
 = 
BTRFS_CACHE_STARTED
;

953 
	`•ö_u∆ock
(&
ˇche
->
lock
);

955 
	`wrôe_lock
(&
fs_öfo
->
block_group_ˇche_lock
);

956 
	`ªfcou¡_öc
(&
ˇchög_˘l
->
cou¡
);

957 
	`li°_add_èû
(&
ˇchög_˘l
->
li°
, &
fs_öfo
->
ˇchög_block_groups
);

958 
	`wrôe_u∆ock
(&
fs_öfo
->
block_group_ˇche_lock
);

960 
	`båfs_gë_block_group
(
ˇche
);

962 
	`båfs_queue_w‹k
(
fs_öfo
->
ˇchög_w‹kîs
, &
ˇchög_˘l
->
w‹k
);

963 
out
:

964 i‡(
waô
 && 
ˇchög_˘l
)

965 
ªt
 = 
	`båfs_ˇchög_˘l_waô_d⁄e
(
ˇche
, 
ˇchög_˘l
);

966 i‡(
ˇchög_˘l
)

967 
	`båfs_put_ˇchög_c⁄åﬁ
(
ˇchög_˘l
);

969  
ªt
;

970 
	}
}

972 
	$˛ór_avaû_Æloc_bôs
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
Êags
)

974 
u64
 
exåa_Êags
 = 
	`chunk_to_exãnded
(
Êags
) &

975 
BTRFS_EXTENDED_PROFILE_MASK
;

977 
	`wrôe_£qlock
(&
fs_öfo
->
¥ofûes_lock
);

978 i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
)

979 
fs_öfo
->
avaû_d©a_Æloc_bôs
 &~
exåa_Êags
;

980 i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_METADATA
)

981 
fs_öfo
->
avaû_mëad©a_Æloc_bôs
 &~
exåa_Êags
;

982 i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

983 
fs_öfo
->
avaû_sy°em_Æloc_bôs
 &~
exåa_Êags
;

984 
	`wrôe_£qu∆ock
(&
fs_öfo
->
¥ofûes_lock
);

985 
	}
}

995 
	$˛ór_öcom∑t_bg_bôs
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
Êags
)

997 
boﬁ
 
found_øid56
 = 
Ál£
;

998 
boﬁ
 
found_øid1c34
 = 
Ál£
;

1000 i‡((
Êags
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) ||

1001 (
Êags
 & 
BTRFS_BLOCK_GROUP_RAID1C3
) ||

1002 (
Êags
 & 
BTRFS_BLOCK_GROUP_RAID1C4
)) {

1003 
li°_hód
 *
hód
 = &
fs_öfo
->
•a˚_öfo
;

1004 
båfs_•a˚_öfo
 *
söfo
;

1006 
	`li°_f‹_óch_íåy_rcu
(
söfo
, 
hód
, 
li°
) {

1007 
	`down_ªad
(&
söfo
->
groups_£m
);

1008 i‡(!
	`li°_em±y
(&
söfo
->
block_groups
[
BTRFS_RAID_RAID5
]))

1009 
found_øid56
 = 
åue
;

1010 i‡(!
	`li°_em±y
(&
söfo
->
block_groups
[
BTRFS_RAID_RAID6
]))

1011 
found_øid56
 = 
åue
;

1012 i‡(!
	`li°_em±y
(&
söfo
->
block_groups
[
BTRFS_RAID_RAID1C3
]))

1013 
found_øid1c34
 = 
åue
;

1014 i‡(!
	`li°_em±y
(&
söfo
->
block_groups
[
BTRFS_RAID_RAID1C4
]))

1015 
found_øid1c34
 = 
åue
;

1016 
	`up_ªad
(&
söfo
->
groups_£m
);

1018 i‡(!
found_øid56
)

1019 
	`båfs_˛ór_fs_öcom∑t
(
fs_öfo
, 
RAID56
);

1020 i‡(!
found_øid1c34
)

1021 
	`båfs_˛ór_fs_öcom∑t
(
fs_öfo
, 
RAID1C34
);

1023 
	}
}

1025 
	$ªmove_block_group_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

1026 
båfs_∑th
 *
∑th
,

1027 
båfs_block_group
 *
block_group
)

1029 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1030 
båfs_roŸ
 *
roŸ
;

1031 
båfs_key
 
key
;

1032 
ªt
;

1034 
roŸ
 = 
	`båfs_block_group_roŸ
(
fs_öfo
);

1035 
key
.
obje˘id
 = 
block_group
->
°¨t
;

1036 
key
.
ty≥
 = 
BTRFS_BLOCK_GROUP_ITEM_KEY
;

1037 
key
.
off£t
 = 
block_group
->
Àngth
;

1039 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

1040 i‡(
ªt
 > 0)

1041 
ªt
 = -
ENOENT
;

1042 i‡(
ªt
 < 0)

1043  
ªt
;

1045 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

1046  
ªt
;

1047 
	}
}

1049 
	$båfs_ªmove_block_group
(
båfs_å™s_h™dÀ
 *
å™s
,

1050 
u64
 
group_°¨t
, 
exã¡_m≠
 *
em
)

1052 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1053 
båfs_∑th
 *
∑th
;

1054 
båfs_block_group
 *
block_group
;

1055 
båfs_‰ì_˛u°î
 *
˛u°î
;

1056 
öode
 *inode;

1057 
kobje˘
 *
kobj
 = 
NULL
;

1058 
ªt
;

1059 
ödex
;

1060 
Á˘‹
;

1061 
båfs_ˇchög_c⁄åﬁ
 *
ˇchög_˘l
 = 
NULL
;

1062 
boﬁ
 
ªmove_em
;

1063 
boﬁ
 
ªmove_rsv
 = 
Ál£
;

1065 
block_group
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
group_°¨t
);

1066 
	`BUG_ON
(!
block_group
);

1067 
	`BUG_ON
(!
block_group
->
ro
);

1069 
	`åa˚_båfs_ªmove_block_group
(
block_group
);

1074 
	`båfs_‰ì_ex˛uded_exã¡s
(
block_group
);

1075 
	`båfs_‰ì_ªf_åì_ønge
(
fs_öfo
, 
block_group
->
°¨t
,

1076 
block_group
->
Àngth
);

1078 
ödex
 = 
	`båfs_bg_Êags_to_øid_ödex
(
block_group
->
Êags
);

1079 
Á˘‹
 = 
	`båfs_bg_ty≥_to_Á˘‹
(
block_group
->
Êags
);

1082 
˛u°î
 = &
fs_öfo
->
d©a_Æloc_˛u°î
;

1083 
	`•ö_lock
(&
˛u°î
->
ªfûl_lock
);

1084 
	`båfs_ªtu∫_˛u°î_to_‰ì_•a˚
(
block_group
, 
˛u°î
);

1085 
	`•ö_u∆ock
(&
˛u°î
->
ªfûl_lock
);

1091 
˛u°î
 = &
fs_öfo
->
mëa_Æloc_˛u°î
;

1092 
	`•ö_lock
(&
˛u°î
->
ªfûl_lock
);

1093 
	`båfs_ªtu∫_˛u°î_to_‰ì_•a˚
(
block_group
, 
˛u°î
);

1094 
	`•ö_u∆ock
(&
˛u°î
->
ªfûl_lock
);

1096 
	`båfs_˛ór_åìlog_bg
(
block_group
);

1097 
	`båfs_˛ór_d©a_ªloc_bg
(
block_group
);

1099 
∑th
 = 
	`båfs_Æloc_∑th
();

1100 i‡(!
∑th
) {

1101 
ªt
 = -
ENOMEM
;

1102 
out
;

1109 
öode
 = 
	`lookup_‰ì_•a˚_öode
(
block_group
, 
∑th
);

1111 
	`muãx_lock
(&
å™s
->
å™ß˘i⁄
->
ˇche_wrôe_muãx
);

1116 
	`•ö_lock
(&
å™s
->
å™ß˘i⁄
->
dúty_bgs_lock
);

1117 i‡(!
	`li°_em±y
(&
block_group
->
io_li°
)) {

1118 
	`li°_dñ_öô
(&
block_group
->
io_li°
);

1120 
	`WARN_ON
(!
	`IS_ERR
(
öode
Ë&& inodê!
block_group
->
io_˘l
.inode);

1122 
	`•ö_u∆ock
(&
å™s
->
å™ß˘i⁄
->
dúty_bgs_lock
);

1123 
	`båfs_waô_ˇche_io
(
å™s
, 
block_group
, 
∑th
);

1124 
	`båfs_put_block_group
(
block_group
);

1125 
	`•ö_lock
(&
å™s
->
å™ß˘i⁄
->
dúty_bgs_lock
);

1128 i‡(!
	`li°_em±y
(&
block_group
->
dúty_li°
)) {

1129 
	`li°_dñ_öô
(&
block_group
->
dúty_li°
);

1130 
ªmove_rsv
 = 
åue
;

1131 
	`båfs_put_block_group
(
block_group
);

1133 
	`•ö_u∆ock
(&
å™s
->
å™ß˘i⁄
->
dúty_bgs_lock
);

1134 
	`muãx_u∆ock
(&
å™s
->
å™ß˘i⁄
->
ˇche_wrôe_muãx
);

1136 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚_öode
(
å™s
, 
öode
, 
block_group
);

1137 i‡(
ªt
)

1138 
out
;

1140 
	`wrôe_lock
(&
fs_öfo
->
block_group_ˇche_lock
);

1141 
	`rb_îa£_ˇched
(&
block_group
->
ˇche_node
,

1142 &
fs_öfo
->
block_group_ˇche_åì
);

1143 
	`RB_CLEAR_NODE
(&
block_group
->
ˇche_node
);

1146 
	`båfs_put_block_group
(
block_group
);

1148 
	`wrôe_u∆ock
(&
fs_öfo
->
block_group_ˇche_lock
);

1150 
	`down_wrôe
(&
block_group
->
•a˚_öfo
->
groups_£m
);

1155 
	`li°_dñ_öô
(&
block_group
->
li°
);

1156 i‡(
	`li°_em±y
(&
block_group
->
•a˚_öfo
->
block_groups
[
ödex
])) {

1157 
kobj
 = 
block_group
->
•a˚_öfo
->
block_group_kobjs
[
ödex
];

1158 
block_group
->
•a˚_öfo
->
block_group_kobjs
[
ödex
] = 
NULL
;

1159 
	`˛ór_avaû_Æloc_bôs
(
fs_öfo
, 
block_group
->
Êags
);

1161 
	`up_wrôe
(&
block_group
->
•a˚_öfo
->
groups_£m
);

1162 
	`˛ór_öcom∑t_bg_bôs
(
fs_öfo
, 
block_group
->
Êags
);

1163 i‡(
kobj
) {

1164 
	`kobje˘_dñ
(
kobj
);

1165 
	`kobje˘_put
(
kobj
);

1168 i‡(
block_group
->
ˇched
 =
BTRFS_CACHE_STARTED
)

1169 
	`båfs_waô_block_group_ˇche_d⁄e
(
block_group
);

1171 
	`wrôe_lock
(&
fs_öfo
->
block_group_ˇche_lock
);

1172 
ˇchög_˘l
 = 
	`båfs_gë_ˇchög_c⁄åﬁ
(
block_group
);

1173 i‡(!
ˇchög_˘l
) {

1174 
båfs_ˇchög_c⁄åﬁ
 *
˘l
;

1176 
	`li°_f‹_óch_íåy
(
˘l
, &
fs_öfo
->
ˇchög_block_groups
, 
li°
) {

1177 i‡(
˘l
->
block_group
 == block_group) {

1178 
ˇchög_˘l
 = 
˘l
;

1179 
	`ªfcou¡_öc
(&
ˇchög_˘l
->
cou¡
);

1184 i‡(
ˇchög_˘l
)

1185 
	`li°_dñ_öô
(&
ˇchög_˘l
->
li°
);

1186 
	`wrôe_u∆ock
(&
fs_öfo
->
block_group_ˇche_lock
);

1188 i‡(
ˇchög_˘l
) {

1190 
	`båfs_put_ˇchög_c⁄åﬁ
(
ˇchög_˘l
);

1191 
	`båfs_put_ˇchög_c⁄åﬁ
(
ˇchög_˘l
);

1194 
	`•ö_lock
(&
å™s
->
å™ß˘i⁄
->
dúty_bgs_lock
);

1195 
	`WARN_ON
(!
	`li°_em±y
(&
block_group
->
dúty_li°
));

1196 
	`WARN_ON
(!
	`li°_em±y
(&
block_group
->
io_li°
));

1197 
	`•ö_u∆ock
(&
å™s
->
å™ß˘i⁄
->
dúty_bgs_lock
);

1199 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
block_group
);

1201 
	`•ö_lock
(&
block_group
->
•a˚_öfo
->
lock
);

1202 
	`li°_dñ_öô
(&
block_group
->
ro_li°
);

1204 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
ENOSPC_DEBUG
)) {

1205 
	`WARN_ON
(
block_group
->
•a˚_öfo
->
tŸÆ_byãs


1206 < 
block_group
->
Àngth
);

1207 
	`WARN_ON
(
block_group
->
•a˚_öfo
->
byãs_ªad⁄ly


1208 < 
block_group
->
Àngth
 - block_group->
z⁄e_unußbÀ
);

1209 
	`WARN_ON
(
block_group
->
•a˚_öfo
->
byãs_z⁄e_unußbÀ


1210 < 
block_group
->
z⁄e_unußbÀ
);

1211 
	`WARN_ON
(
block_group
->
•a˚_öfo
->
disk_tŸÆ


1212 < 
block_group
->
Àngth
 * 
Á˘‹
);

1214 
block_group
->
•a˚_öfo
->
tŸÆ_byãs
 -block_group->
Àngth
;

1215 
block_group
->
•a˚_öfo
->
byãs_ªad⁄ly
 -=

1216 (
block_group
->
Àngth
 - block_group->
z⁄e_unußbÀ
);

1217 
block_group
->
•a˚_öfo
->
byãs_z⁄e_unußbÀ
 -=

1218 
block_group
->
z⁄e_unußbÀ
;

1219 
block_group
->
•a˚_öfo
->
disk_tŸÆ
 -block_group->
Àngth
 * 
Á˘‹
;

1221 
	`•ö_u∆ock
(&
block_group
->
•a˚_öfo
->
lock
);

1234 
ªt
 = 
	`ªmove_block_group_‰ì_•a˚
(
å™s
, 
block_group
);

1235 i‡(
ªt
)

1236 
out
;

1238 
ªt
 = 
	`ªmove_block_group_ôem
(
å™s
, 
∑th
, 
block_group
);

1239 i‡(
ªt
 < 0)

1240 
out
;

1242 
	`•ö_lock
(&
block_group
->
lock
);

1243 
	`£t_bô
(
BLOCK_GROUP_FLAG_REMOVED
, &
block_group
->
ru¡ime_Êags
);

1271 
ªmove_em
 = (
	`©omic_ªad
(&
block_group
->
‰ozí
) == 0);

1272 
	`•ö_u∆ock
(&
block_group
->
lock
);

1274 i‡(
ªmove_em
) {

1275 
exã¡_m≠_åì
 *
em_åì
;

1277 
em_åì
 = &
fs_öfo
->
m≠pög_åì
;

1278 
	`wrôe_lock
(&
em_åì
->
lock
);

1279 
	`ªmove_exã¡_m≠pög
(
em_åì
, 
em
);

1280 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

1282 
	`‰ì_exã¡_m≠
(
em
);

1285 
out
:

1287 
	`båfs_put_block_group
(
block_group
);

1288 i‡(
ªmove_rsv
)

1289 
	`båfs_dñayed_ªfs_rsv_ªÀa£
(
fs_öfo
, 1);

1290 
	`båfs_‰ì_∑th
(
∑th
);

1291  
ªt
;

1292 
	}
}

1294 
båfs_å™s_h™dÀ
 *
	$båfs_°¨t_å™s_ªmove_block_group
(

1295 
båfs_fs_öfo
 *
fs_öfo
, c⁄° 
u64
 
chunk_off£t
)

1297 
båfs_roŸ
 *
roŸ
 = 
	`båfs_block_group_roŸ
(
fs_öfo
);

1298 
exã¡_m≠_åì
 *
em_åì
 = &
fs_öfo
->
m≠pög_åì
;

1299 
exã¡_m≠
 *
em
;

1300 
m≠_lookup
 *
m≠
;

1301 
num_ôems
;

1303 
	`ªad_lock
(&
em_åì
->
lock
);

1304 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 
chunk_off£t
, 1);

1305 
	`ªad_u∆ock
(&
em_åì
->
lock
);

1306 
	`ASSERT
(
em
 &&Ém->
°¨t
 =
chunk_off£t
);

1327 
m≠
 = 
em
->
m≠_lookup
;

1328 
num_ôems
 = 3 + 
m≠
->
num_°rùes
;

1329 
	`‰ì_exã¡_m≠
(
em
);

1331  
	`båfs_°¨t_å™ß˘i⁄_ÁŒback_globÆ_rsv
(
roŸ
, 
num_ôems
);

1332 
	}
}

1347 
	$öc_block_group_ro
(
båfs_block_group
 *
ˇche
, 
f‹˚
)

1349 
båfs_•a˚_öfo
 *
söfo
 = 
ˇche
->
•a˚_öfo
;

1350 
u64
 
num_byãs
;

1351 
ªt
 = -
ENOSPC
;

1353 
	`•ö_lock
(&
söfo
->
lock
);

1354 
	`•ö_lock
(&
ˇche
->
lock
);

1356 i‡(
ˇche
->
sw≠_exã¡s
) {

1357 
ªt
 = -
ETXTBSY
;

1358 
out
;

1361 i‡(
ˇche
->
ro
) {

1362 
ˇche
->
ro
++;

1363 
ªt
 = 0;

1364 
out
;

1367 
num_byãs
 = 
ˇche
->
Àngth
 - cache->
ª£rved
 - cache->
pö√d
 -

1368 
ˇche
->
byãs_su≥r
 - cache->
z⁄e_unußbÀ
 - cache->
u£d
;

1374 i‡(
f‹˚
) {

1375 
ªt
 = 0;

1376 } i‡(
söfo
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
) {

1377 
u64
 
söfo_u£d
 = 
	`båfs_•a˚_öfo_u£d
(
söfo
, 
åue
);

1383 i‡(
söfo_u£d
 + 
num_byãs
 <
söfo
->
tŸÆ_byãs
)

1384 
ªt
 = 0;

1392 i‡(
	`båfs_ˇn_ovîcommô
(
ˇche
->
fs_öfo
, 
söfo
, 
num_byãs
,

1393 
BTRFS_RESERVE_NO_FLUSH
))

1394 
ªt
 = 0;

1397 i‡(!
ªt
) {

1398 
söfo
->
byãs_ªad⁄ly
 +
num_byãs
;

1399 i‡(
	`båfs_is_z⁄ed
(
ˇche
->
fs_öfo
)) {

1401 
söfo
->
byãs_ªad⁄ly
 +
ˇche
->
z⁄e_unußbÀ
;

1402 
söfo
->
byãs_z⁄e_unußbÀ
 -
ˇche
->
z⁄e_unußbÀ
;

1403 
ˇche
->
z⁄e_unußbÀ
 = 0;

1405 
ˇche
->
ro
++;

1406 
	`li°_add_èû
(&
ˇche
->
ro_li°
, &
söfo
->
ro_bgs
);

1408 
out
:

1409 
	`•ö_u∆ock
(&
ˇche
->
lock
);

1410 
	`•ö_u∆ock
(&
söfo
->
lock
);

1411 i‡(
ªt
 =-
ENOSPC
 && 
	`båfs_ã°_›t
(
ˇche
->
fs_öfo
, 
ENOSPC_DEBUG
)) {

1412 
	`båfs_öfo
(
ˇche
->
fs_öfo
,

1413 "u«bÀÅÿmakêblock grou∞%ŒuÑo", 
ˇche
->
°¨t
);

1414 
	`båfs_dump_•a˚_öfo
(
ˇche
->
fs_öfo
, cache->
•a˚_öfo
, 0, 0);

1416  
ªt
;

1417 
	}
}

1419 
boﬁ
 
	$˛ón_pö√d_exã¡s
(
båfs_å™s_h™dÀ
 *
å™s
,

1420 
båfs_block_group
 *
bg
)

1422 
båfs_fs_öfo
 *
fs_öfo
 = 
bg
->fs_info;

1423 
båfs_å™ß˘i⁄
 *
¥ev_å™s
 = 
NULL
;

1424 c⁄° 
u64
 
°¨t
 = 
bg
->start;

1425 c⁄° 
u64
 
íd
 = 
°¨t
 + 
bg
->
Àngth
 - 1;

1426 
ªt
;

1428 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

1429 i‡(
å™s
->
å™ß˘i⁄
->
li°
.
¥ev
 !&
fs_öfo
->
å™s_li°
) {

1430 
¥ev_å™s
 = 
	`li°_œ°_íåy
(&
å™s
->
å™ß˘i⁄
->
li°
,

1431 
båfs_å™ß˘i⁄
, 
li°
);

1432 
	`ªfcou¡_öc
(&
¥ev_å™s
->
u£_cou¡
);

1434 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

1446 
	`muãx_lock
(&
fs_öfo
->
unu£d_bg_u≈ö_muãx
);

1447 i‡(
¥ev_å™s
) {

1448 
ªt
 = 
	`˛ór_exã¡_bôs
(&
¥ev_å™s
->
pö√d_exã¡s
, 
°¨t
, 
íd
,

1449 
EXTENT_DIRTY
);

1450 i‡(
ªt
)

1451 
out
;

1454 
ªt
 = 
	`˛ór_exã¡_bôs
(&
å™s
->
å™ß˘i⁄
->
pö√d_exã¡s
, 
°¨t
, 
íd
,

1455 
EXTENT_DIRTY
);

1456 
out
:

1457 
	`muãx_u∆ock
(&
fs_öfo
->
unu£d_bg_u≈ö_muãx
);

1458 i‡(
¥ev_å™s
)

1459 
	`båfs_put_å™ß˘i⁄
(
¥ev_å™s
);

1461  
ªt
 == 0;

1462 
	}
}

1468 
	$båfs_dñëe_unu£d_bgs
(
båfs_fs_öfo
 *
fs_öfo
)

1470 
båfs_block_group
 *
block_group
;

1471 
båfs_•a˚_öfo
 *
•a˚_öfo
;

1472 
båfs_å™s_h™dÀ
 *
å™s
;

1473 c⁄° 
boﬁ
 
async_åim_íabÀd
 = 
	`båfs_ã°_›t
(
fs_öfo
, 
DISCARD_ASYNC
);

1474 
ªt
 = 0;

1476 i‡(!
	`ã°_bô
(
BTRFS_FS_OPEN
, &
fs_öfo
->
Êags
))

1479 i‡(
	`båfs_fs_˛osög
(
fs_öfo
))

1486 i‡(!
	`muãx_åylock
(&
fs_öfo
->
ª˛aim_bgs_lock
))

1489 
	`•ö_lock
(&
fs_öfo
->
unu£d_bgs_lock
);

1490 !
	`li°_em±y
(&
fs_öfo
->
unu£d_bgs
)) {

1491 
åimmög
;

1493 
block_group
 = 
	`li°_fú°_íåy
(&
fs_öfo
->
unu£d_bgs
,

1494 
båfs_block_group
,

1495 
bg_li°
);

1496 
	`li°_dñ_öô
(&
block_group
->
bg_li°
);

1498 
•a˚_öfo
 = 
block_group
->space_info;

1500 i‡(
ªt
 || 
	`båfs_mixed_•a˚_öfo
(
•a˚_öfo
)) {

1501 
	`båfs_put_block_group
(
block_group
);

1504 
	`•ö_u∆ock
(&
fs_öfo
->
unu£d_bgs_lock
);

1506 
	`båfs_disˇrd_ˇn˚l_w‹k
(&
fs_öfo
->
disˇrd_˘l
, 
block_group
);

1509 
	`down_wrôe
(&
•a˚_öfo
->
groups_£m
);

1516 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
DISCARD_ASYNC
) &&

1517 !
	`båfs_is_‰ì_•a˚_åimmed
(
block_group
)) {

1518 
	`åa˚_båfs_skù_unu£d_block_group
(
block_group
);

1519 
	`up_wrôe
(&
•a˚_öfo
->
groups_£m
);

1521 
	`båfs_disˇrd_queue_w‹k
(&
fs_öfo
->
disˇrd_˘l
,

1522 
block_group
);

1523 
√xt
;

1526 
	`•ö_lock
(&
block_group
->
lock
);

1527 i‡(
block_group
->
ª£rved
 || block_group->
pö√d
 ||

1528 
block_group
->
u£d
 || block_group->
ro
 ||

1529 
	`li°_is_söguœr
(&
block_group
->
li°
)) {

1536 
	`åa˚_båfs_skù_unu£d_block_group
(
block_group
);

1537 
	`•ö_u∆ock
(&
block_group
->
lock
);

1538 
	`up_wrôe
(&
•a˚_öfo
->
groups_£m
);

1539 
√xt
;

1541 
	`•ö_u∆ock
(&
block_group
->
lock
);

1544 
ªt
 = 
	`öc_block_group_ro
(
block_group
, 0);

1545 
	`up_wrôe
(&
•a˚_öfo
->
groups_£m
);

1546 i‡(
ªt
 < 0) {

1547 
ªt
 = 0;

1548 
√xt
;

1551 
ªt
 = 
	`båfs_z⁄e_föish
(
block_group
);

1552 i‡(
ªt
 < 0) {

1553 
	`båfs_dec_block_group_ro
(
block_group
);

1554 i‡(
ªt
 =-
EAGAIN
)

1555 
ªt
 = 0;

1556 
√xt
;

1563 
å™s
 = 
	`båfs_°¨t_å™s_ªmove_block_group
(
fs_öfo
,

1564 
block_group
->
°¨t
);

1565 i‡(
	`IS_ERR
(
å™s
)) {

1566 
	`båfs_dec_block_group_ro
(
block_group
);

1567 
ªt
 = 
	`PTR_ERR
(
å™s
);

1568 
√xt
;

1575 i‡(!
	`˛ón_pö√d_exã¡s
(
å™s
, 
block_group
)) {

1576 
	`båfs_dec_block_group_ro
(
block_group
);

1577 
íd_å™s
;

1587 
	`•ö_lock
(&
fs_öfo
->
disˇrd_˘l
.
lock
);

1588 i‡(!
	`li°_em±y
(&
block_group
->
disˇrd_li°
)) {

1589 
	`•ö_u∆ock
(&
fs_öfo
->
disˇrd_˘l
.
lock
);

1590 
	`båfs_dec_block_group_ro
(
block_group
);

1591 
	`båfs_disˇrd_queue_w‹k
(&
fs_öfo
->
disˇrd_˘l
,

1592 
block_group
);

1593 
íd_å™s
;

1595 
	`•ö_u∆ock
(&
fs_öfo
->
disˇrd_˘l
.
lock
);

1598 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1599 
	`•ö_lock
(&
block_group
->
lock
);

1601 
	`båfs_•a˚_öfo_upd©e_byãs_pö√d
(
fs_öfo
, 
•a˚_öfo
,

1602 -
block_group
->
pö√d
);

1603 
•a˚_öfo
->
byãs_ªad⁄ly
 +
block_group
->
pö√d
;

1604 
block_group
->
pö√d
 = 0;

1606 
	`•ö_u∆ock
(&
block_group
->
lock
);

1607 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1616 i‡(!
async_åim_íabÀd
 && 
	`båfs_ã°_›t
(
fs_öfo
, 
DISCARD_ASYNC
))

1617 
Êù_async
;

1623 
åimmög
 = 
	`båfs_ã°_›t
(
fs_öfo
, 
DISCARD_SYNC
) ||

1624 
	`båfs_is_z⁄ed
(
fs_öfo
);

1627 i‡(
åimmög
)

1628 
	`båfs_‰ìze_block_group
(
block_group
);

1634 
ªt
 = 
	`båfs_ªmove_chunk
(
å™s
, 
block_group
->
°¨t
);

1636 i‡(
ªt
) {

1637 i‡(
åimmög
)

1638 
	`båfs_un‰ìze_block_group
(
block_group
);

1639 
íd_å™s
;

1647 i‡(
åimmög
) {

1648 
	`•ö_lock
(&
fs_öfo
->
unu£d_bgs_lock
);

1654 
	`li°_move
(&
block_group
->
bg_li°
,

1655 &
å™s
->
å™ß˘i⁄
->
dñëed_bgs
);

1656 
	`•ö_u∆ock
(&
fs_öfo
->
unu£d_bgs_lock
);

1657 
	`båfs_gë_block_group
(
block_group
);

1659 
íd_å™s
:

1660 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1661 
√xt
:

1662 
	`båfs_put_block_group
(
block_group
);

1663 
	`•ö_lock
(&
fs_öfo
->
unu£d_bgs_lock
);

1665 
	`•ö_u∆ock
(&
fs_öfo
->
unu£d_bgs_lock
);

1666 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

1669 
Êù_async
:

1670 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1671 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

1672 
	`båfs_put_block_group
(
block_group
);

1673 
	`båfs_disˇrd_pu¡_unu£d_bgs_li°
(
fs_öfo
);

1674 
	}
}

1676 
	$båfs_m¨k_bg_unu£d
(
båfs_block_group
 *
bg
)

1678 
båfs_fs_öfo
 *
fs_öfo
 = 
bg
->fs_info;

1680 
	`•ö_lock
(&
fs_öfo
->
unu£d_bgs_lock
);

1681 i‡(
	`li°_em±y
(&
bg
->
bg_li°
)) {

1682 
	`båfs_gë_block_group
(
bg
);

1683 
	`åa˚_båfs_add_unu£d_block_group
(
bg
);

1684 
	`li°_add_èû
(&
bg
->
bg_li°
, &
fs_öfo
->
unu£d_bgs
);

1685 } i‡(!
	`ã°_bô
(
BLOCK_GROUP_FLAG_NEW
, &
bg
->
ru¡ime_Êags
)) {

1687 
	`åa˚_båfs_add_unu£d_block_group
(
bg
);

1688 
	`li°_move_èû
(&
bg
->
bg_li°
, &
fs_öfo
->
unu£d_bgs
);

1690 
	`•ö_u∆ock
(&
fs_öfo
->
unu£d_bgs_lock
);

1691 
	}
}

1697 
	$ª˛aim_bgs_cmp
(*
unu£d
, c⁄° 
li°_hód
 *
a
,

1698 c⁄° 
li°_hód
 *
b
)

1700 c⁄° 
båfs_block_group
 *
bg1
, *
bg2
;

1702 
bg1
 = 
	`li°_íåy
(
a
, 
båfs_block_group
, 
bg_li°
);

1703 
bg2
 = 
	`li°_íåy
(
b
, 
båfs_block_group
, 
bg_li°
);

1705  
bg1
->
u£d
 > 
bg2
->used;

1706 
	}
}

1708 
ölöe
 
boﬁ
 
	$båfs_should_ª˛aim
(
båfs_fs_öfo
 *
fs_öfo
)

1710 i‡(
	`båfs_is_z⁄ed
(
fs_öfo
))

1711  
	`båfs_z⁄ed_should_ª˛aim
(
fs_öfo
);

1712  
åue
;

1713 
	}
}

1715 
boﬁ
 
	$should_ª˛aim_block_group
(
båfs_block_group
 *
bg
, 
u64
 
byãs_‰ìd
)

1717 c⁄° 
båfs_•a˚_öfo
 *
•a˚_öfo
 = 
bg
->space_info;

1718 c⁄° 
ª˛aim_thªsh
 = 
	`READ_ONCE
(
•a˚_öfo
->
bg_ª˛aim_thªshﬁd
);

1719 c⁄° 
u64
 
√w_vÆ
 = 
bg
->
u£d
;

1720 c⁄° 
u64
 
ﬁd_vÆ
 = 
√w_vÆ
 + 
byãs_‰ìd
;

1721 
u64
 
thªsh
;

1723 i‡(
ª˛aim_thªsh
 == 0)

1724  
Ál£
;

1726 
thªsh
 = 
	`mu…_≥rc
(
bg
->
Àngth
, 
ª˛aim_thªsh
);

1732 i‡(
ﬁd_vÆ
 < 
thªsh
)

1733  
Ál£
;

1734 i‡(
√w_vÆ
 >
thªsh
)

1735  
Ál£
;

1736  
åue
;

1737 
	}
}

1739 
	$båfs_ª˛aim_bgs_w‹k
(
w‹k_°ru˘
 *
w‹k
)

1741 
båfs_fs_öfo
 *
fs_öfo
 =

1742 
	`c⁄èöî_of
(
w‹k
, 
båfs_fs_öfo
, 
ª˛aim_bgs_w‹k
);

1743 
båfs_block_group
 *
bg
;

1744 
båfs_•a˚_öfo
 *
•a˚_öfo
;

1746 i‡(!
	`ã°_bô
(
BTRFS_FS_OPEN
, &
fs_öfo
->
Êags
))

1749 i‡(
	`båfs_fs_˛osög
(
fs_öfo
))

1752 i‡(!
	`båfs_should_ª˛aim
(
fs_öfo
))

1755 
	`sb_°¨t_wrôe
(
fs_öfo
->
sb
);

1757 i‡(!
	`båfs_ex˛›_°¨t
(
fs_öfo
, 
BTRFS_EXCLOP_BALANCE
)) {

1758 
	`sb_íd_wrôe
(
fs_öfo
->
sb
);

1766 i‡(!
	`muãx_åylock
(&
fs_öfo
->
ª˛aim_bgs_lock
)) {

1767 
	`båfs_ex˛›_föish
(
fs_öfo
);

1768 
	`sb_íd_wrôe
(
fs_öfo
->
sb
);

1772 
	`•ö_lock
(&
fs_öfo
->
unu£d_bgs_lock
);

1778 
	`li°_s‹t
(
NULL
, &
fs_öfo
->
ª˛aim_bgs
, 
ª˛aim_bgs_cmp
);

1779 !
	`li°_em±y
(&
fs_öfo
->
ª˛aim_bgs
)) {

1780 
u64
 
z⁄e_unußbÀ
;

1781 
ªt
 = 0;

1783 
bg
 = 
	`li°_fú°_íåy
(&
fs_öfo
->
ª˛aim_bgs
,

1784 
båfs_block_group
,

1785 
bg_li°
);

1786 
	`li°_dñ_öô
(&
bg
->
bg_li°
);

1788 
•a˚_öfo
 = 
bg
->space_info;

1789 
	`•ö_u∆ock
(&
fs_öfo
->
unu£d_bgs_lock
);

1792 
	`down_wrôe
(&
•a˚_öfo
->
groups_£m
);

1794 
	`•ö_lock
(&
bg
->
lock
);

1795 i‡(
bg
->
ª£rved
 || bg->
pö√d
 || bg->
ro
) {

1802 
	`•ö_u∆ock
(&
bg
->
lock
);

1803 
	`up_wrôe
(&
•a˚_öfo
->
groups_£m
);

1804 
√xt
;

1806 i‡(
bg
->
u£d
 == 0) {

1818 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
DISCARD_ASYNC
))

1819 
	`båfs_m¨k_bg_unu£d
(
bg
);

1820 
	`•ö_u∆ock
(&
bg
->
lock
);

1821 
	`up_wrôe
(&
•a˚_öfo
->
groups_£m
);

1822 
√xt
;

1835 i‡(!
	`should_ª˛aim_block_group
(
bg
, bg->
Àngth
)) {

1836 
	`•ö_u∆ock
(&
bg
->
lock
);

1837 
	`up_wrôe
(&
•a˚_öfo
->
groups_£m
);

1838 
√xt
;

1840 
	`•ö_u∆ock
(&
bg
->
lock
);

1850 i‡(
	`båfs_√ed_˛ó√r_¶ìp
(
fs_öfo
)) {

1851 
	`up_wrôe
(&
•a˚_öfo
->
groups_£m
);

1852 
√xt
;

1861 
z⁄e_unußbÀ
 = 
bg
->zone_unusable;

1862 
ªt
 = 
	`öc_block_group_ro
(
bg
, 0);

1863 
	`up_wrôe
(&
•a˚_öfo
->
groups_£m
);

1864 i‡(
ªt
 < 0)

1865 
√xt
;

1867 
	`båfs_öfo
(
fs_öfo
,

1869 
bg
->
°¨t
,

1870 
	`div64_u64
(
bg
->
u£d
 * 100, bg->
Àngth
),

1871 
	`div64_u64
(
z⁄e_unußbÀ
 * 100, 
bg
->
Àngth
));

1872 
	`åa˚_båfs_ª˛aim_block_group
(
bg
);

1873 
ªt
 = 
	`båfs_ªloˇã_chunk
(
fs_öfo
, 
bg
->
°¨t
);

1874 i‡(
ªt
) {

1875 
	`båfs_dec_block_group_ro
(
bg
);

1876 
	`båfs_îr
(
fs_öfo
, "errorÑelocating chunk %llu",

1877 
bg
->
°¨t
);

1880 
√xt
:

1881 i‡(
ªt
)

1882 
	`båfs_m¨k_bg_to_ª˛aim
(
bg
);

1883 
	`båfs_put_block_group
(
bg
);

1885 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

1890 
	`båfs_dñëe_unu£d_bgs
(
fs_öfo
);

1895 i‡(!
	`muãx_åylock
(&
fs_öfo
->
ª˛aim_bgs_lock
))

1896 
íd
;

1897 
	`•ö_lock
(&
fs_öfo
->
unu£d_bgs_lock
);

1899 
	`•ö_u∆ock
(&
fs_öfo
->
unu£d_bgs_lock
);

1900 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

1901 
íd
:

1902 
	`båfs_ex˛›_föish
(
fs_öfo
);

1903 
	`sb_íd_wrôe
(
fs_öfo
->
sb
);

1904 
	}
}

1906 
	$båfs_ª˛aim_bgs
(
båfs_fs_öfo
 *
fs_öfo
)

1908 
	`•ö_lock
(&
fs_öfo
->
unu£d_bgs_lock
);

1909 i‡(!
	`li°_em±y
(&
fs_öfo
->
ª˛aim_bgs
))

1910 
	`queue_w‹k
(
sy°em_unbound_wq
, &
fs_öfo
->
ª˛aim_bgs_w‹k
);

1911 
	`•ö_u∆ock
(&
fs_öfo
->
unu£d_bgs_lock
);

1912 
	}
}

1914 
	$båfs_m¨k_bg_to_ª˛aim
(
båfs_block_group
 *
bg
)

1916 
båfs_fs_öfo
 *
fs_öfo
 = 
bg
->fs_info;

1918 
	`•ö_lock
(&
fs_öfo
->
unu£d_bgs_lock
);

1919 i‡(
	`li°_em±y
(&
bg
->
bg_li°
)) {

1920 
	`båfs_gë_block_group
(
bg
);

1921 
	`åa˚_båfs_add_ª˛aim_block_group
(
bg
);

1922 
	`li°_add_èû
(&
bg
->
bg_li°
, &
fs_öfo
->
ª˛aim_bgs
);

1924 
	`•ö_u∆ock
(&
fs_öfo
->
unu£d_bgs_lock
);

1925 
	}
}

1927 
	$ªad_bg_‰om_eb
(
båfs_fs_öfo
 *
fs_öfo
, 
båfs_key
 *
key
,

1928 
båfs_∑th
 *
∑th
)

1930 
exã¡_m≠_åì
 *
em_åì
;

1931 
exã¡_m≠
 *
em
;

1932 
båfs_block_group_ôem
 
bg
;

1933 
exã¡_buf„r
 *
Àaf
;

1934 
¶Ÿ
;

1935 
u64
 
Êags
;

1936 
ªt
 = 0;

1938 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

1939 
Àaf
 = 
∑th
->
nodes
[0];

1941 
em_åì
 = &
fs_öfo
->
m≠pög_åì
;

1942 
	`ªad_lock
(&
em_åì
->
lock
);

1943 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 
key
->
obje˘id
, key->
off£t
);

1944 
	`ªad_u∆ock
(&
em_åì
->
lock
);

1945 i‡(!
em
) {

1946 
	`båfs_îr
(
fs_öfo
,

1948 
key
->
obje˘id
, key->
off£t
);

1949  -
ENOENT
;

1952 i‡(
em
->
°¨t
 !
key
->
obje˘id
 ||Ém->
Àn
 !key->
off£t
) {

1953 
	`båfs_îr
(
fs_öfo
,

1955 
key
->
obje˘id
, key->
off£t
, 
em
->
°¨t
,Ém->
Àn
);

1956 
ªt
 = -
EUCLEAN
;

1957 
out_‰ì_em
;

1960 
	`ªad_exã¡_buf„r
(
Àaf
, &
bg
, 
	`båfs_ôem_±r_off£t
÷óf, 
¶Ÿ
),

1961 (
bg
));

1962 
Êags
 = 
	`båfs_°ack_block_group_Êags
(&
bg
) &

1963 
BTRFS_BLOCK_GROUP_TYPE_MASK
;

1965 i‡(
Êags
 !(
em
->
m≠_lookup
->
ty≥
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
)) {

1966 
	`båfs_îr
(
fs_öfo
,

1968 
key
->
obje˘id
, key->
off£t
, 
Êags
,

1969 (
BTRFS_BLOCK_GROUP_TYPE_MASK
 & 
em
->
m≠_lookup
->
ty≥
));

1970 
ªt
 = -
EUCLEAN
;

1973 
out_‰ì_em
:

1974 
	`‰ì_exã¡_m≠
(
em
);

1975  
ªt
;

1976 
	}
}

1978 
	$föd_fú°_block_group
(
båfs_fs_öfo
 *
fs_öfo
,

1979 
båfs_∑th
 *
∑th
,

1980 
båfs_key
 *
key
)

1982 
båfs_roŸ
 *
roŸ
 = 
	`båfs_block_group_roŸ
(
fs_öfo
);

1983 
ªt
;

1984 
båfs_key
 
found_key
;

1986 
	`båfs_f‹_óch_¶Ÿ
(
roŸ
, 
key
, &
found_key
, 
∑th
, 
ªt
) {

1987 i‡(
found_key
.
obje˘id
 >
key
->objectid &&

1988 
found_key
.
ty≥
 =
BTRFS_BLOCK_GROUP_ITEM_KEY
) {

1989  
	`ªad_bg_‰om_eb
(
fs_öfo
, &
found_key
, 
∑th
);

1992  
ªt
;

1993 
	}
}

1995 
	$£t_avaû_Æloc_bôs
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
Êags
)

1997 
u64
 
exåa_Êags
 = 
	`chunk_to_exãnded
(
Êags
) &

1998 
BTRFS_EXTENDED_PROFILE_MASK
;

2000 
	`wrôe_£qlock
(&
fs_öfo
->
¥ofûes_lock
);

2001 i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
)

2002 
fs_öfo
->
avaû_d©a_Æloc_bôs
 |
exåa_Êags
;

2003 i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_METADATA
)

2004 
fs_öfo
->
avaû_mëad©a_Æloc_bôs
 |
exåa_Êags
;

2005 i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

2006 
fs_öfo
->
avaû_sy°em_Æloc_bôs
 |
exåa_Êags
;

2007 
	`wrôe_£qu∆ock
(&
fs_öfo
->
¥ofûes_lock
);

2008 
	}
}

2024 
	$båfs_rm≠_block
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
chunk_°¨t
,

2025 
u64
 
physiˇl
, u64 **
logiˇl
, *
«ddrs
, *
°rùe_Àn
)

2027 
exã¡_m≠
 *
em
;

2028 
m≠_lookup
 *
m≠
;

2029 
u64
 *
buf
;

2030 
u64
 
byãƒ
;

2031 
u64
 
d©a_°rùe_Àngth
;

2032 
u64
 
io_°rùe_size
;

2033 
i
, 
ƒ
 = 0;

2034 
ªt
 = 0;

2036 
em
 = 
	`båfs_gë_chunk_m≠
(
fs_öfo
, 
chunk_°¨t
, 1);

2037 i‡(
	`IS_ERR
(
em
))

2038  -
EIO
;

2040 
m≠
 = 
em
->
m≠_lookup
;

2041 
d©a_°rùe_Àngth
 = 
em
->
‹ig_block_Àn
;

2042 
io_°rùe_size
 = 
BTRFS_STRIPE_LEN
;

2043 
chunk_°¨t
 = 
em
->
°¨t
;

2046 i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
)

2047 
io_°rùe_size
 = 
	`båfs_°rùe_ƒ_to_off£t
(
	`ƒ_d©a_°rùes
(
m≠
));

2049 
buf
 = 
	`kˇŒoc
(
m≠
->
num_°rùes
, (
u64
), 
GFP_NOFS
);

2050 i‡(!
buf
) {

2051 
ªt
 = -
ENOMEM
;

2052 
out
;

2055 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

2056 
boﬁ
 
Æªady_ö£πed
 = 
Ál£
;

2057 
u32
 
°rùe_ƒ
;

2058 
u32
 
off£t
;

2059 
j
;

2061 i‡(!
	`ö_ønge
(
physiˇl
, 
m≠
->
°rùes
[
i
].physical,

2062 
d©a_°rùe_Àngth
))

2065 
°rùe_ƒ
 = (
physiˇl
 - 
m≠
->
°rùes
[
i
].physical) >>

2066 
BTRFS_STRIPE_LEN_SHIFT
;

2067 
off£t
 = (
physiˇl
 - 
m≠
->
°rùes
[
i
].physical) &

2068 
BTRFS_STRIPE_LEN_MASK
;

2070 i‡(
m≠
->
ty≥
 & (
BTRFS_BLOCK_GROUP_RAID0
 |

2071 
BTRFS_BLOCK_GROUP_RAID10
))

2072 
°rùe_ƒ
 = 
	`div_u64
(°rùe_ƒ * 
m≠
->
num_°rùes
 + 
i
,

2073 
m≠
->
sub_°rùes
);

2079 
byãƒ
 = 
chunk_°¨t
 + 
°rùe_ƒ
 * 
io_°rùe_size
 + 
off£t
;

2082 
j
 = 0; j < 
ƒ
; j++) {

2083 i‡(
buf
[
j
] =
byãƒ
) {

2084 
Æªady_ö£πed
 = 
åue
;

2089 i‡(!
Æªady_ö£πed
)

2090 
buf
[
ƒ
++] = 
byãƒ
;

2093 *
logiˇl
 = 
buf
;

2094 *
«ddrs
 = 
ƒ
;

2095 *
°rùe_Àn
 = 
io_°rùe_size
;

2096 
out
:

2097 
	`‰ì_exã¡_m≠
(
em
);

2098  
ªt
;

2099 
	}
}

2101 
	$ex˛ude_su≥r_°rùes
(
båfs_block_group
 *
ˇche
)

2103 
båfs_fs_öfo
 *
fs_öfo
 = 
ˇche
->fs_info;

2104 c⁄° 
boﬁ
 
z⁄ed
 = 
	`båfs_is_z⁄ed
(
fs_öfo
);

2105 
u64
 
byãƒ
;

2106 
u64
 *
logiˇl
;

2107 
°rùe_Àn
;

2108 
i
, 
ƒ
, 
ªt
;

2110 i‡(
ˇche
->
°¨t
 < 
BTRFS_SUPER_INFO_OFFSET
) {

2111 
°rùe_Àn
 = 
BTRFS_SUPER_INFO_OFFSET
 - 
ˇche
->
°¨t
;

2112 
ˇche
->
byãs_su≥r
 +
°rùe_Àn
;

2113 
ªt
 = 
	`£t_exã¡_bô
(&
fs_öfo
->
ex˛uded_exã¡s
, 
ˇche
->
°¨t
,

2114 
ˇche
->
°¨t
 + 
°rùe_Àn
 - 1,

2115 
EXTENT_UPTODATE
, 
NULL
);

2116 i‡(
ªt
)

2117  
ªt
;

2120 
i
 = 0; i < 
BTRFS_SUPER_MIRROR_MAX
; i++) {

2121 
byãƒ
 = 
	`båfs_sb_off£t
(
i
);

2122 
ªt
 = 
	`båfs_rm≠_block
(
fs_öfo
, 
ˇche
->
°¨t
,

2123 
byãƒ
, &
logiˇl
, &
ƒ
, &
°rùe_Àn
);

2124 i‡(
ªt
)

2125  
ªt
;

2128 i‡(
z⁄ed
 && 
ƒ
) {

2129 
	`k‰ì
(
logiˇl
);

2130 
	`båfs_îr
(
fs_öfo
,

2132 
ˇche
->
°¨t
);

2133  -
EUCLEAN
;

2136 
ƒ
--) {

2137 
u64
 
Àn
 = 
	`mö_t
(u64, 
°rùe_Àn
,

2138 
ˇche
->
°¨t
 + cache->
Àngth
 - 
logiˇl
[
ƒ
]);

2140 
ˇche
->
byãs_su≥r
 +
Àn
;

2141 
ªt
 = 
	`£t_exã¡_bô
(&
fs_öfo
->
ex˛uded_exã¡s
, 
logiˇl
[
ƒ
],

2142 
logiˇl
[
ƒ
] + 
Àn
 - 1,

2143 
EXTENT_UPTODATE
, 
NULL
);

2144 i‡(
ªt
) {

2145 
	`k‰ì
(
logiˇl
);

2146  
ªt
;

2150 
	`k‰ì
(
logiˇl
);

2153 
	}
}

2155 
båfs_block_group
 *
	$båfs_¸óã_block_group_ˇche
(

2156 
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
°¨t
)

2158 
båfs_block_group
 *
ˇche
;

2160 
ˇche
 = 
	`kzÆloc
((*ˇche), 
GFP_NOFS
);

2161 i‡(!
ˇche
)

2162  
NULL
;

2164 
ˇche
->
‰ì_•a˚_˘l
 = 
	`kzÆloc
((*cache->free_space_ctl),

2165 
GFP_NOFS
);

2166 i‡(!
ˇche
->
‰ì_•a˚_˘l
) {

2167 
	`k‰ì
(
ˇche
);

2168  
NULL
;

2171 
ˇche
->
°¨t
 = start;

2173 
ˇche
->
fs_öfo
 = fs_info;

2174 
ˇche
->
fuŒ_°rùe_Àn
 = 
	`båfs_fuŒ_°rùe_Àn
(
fs_öfo
, 
°¨t
);

2176 
ˇche
->
disˇrd_ödex
 = 
BTRFS_DISCARD_INDEX_UNUSED
;

2178 
	`ªfcou¡_£t
(&
ˇche
->
ªfs
, 1);

2179 
	`•ö_lock_öô
(&
ˇche
->
lock
);

2180 
	`öô_rw£m
(&
ˇche
->
d©a_rw£m
);

2181 
	`INIT_LIST_HEAD
(&
ˇche
->
li°
);

2182 
	`INIT_LIST_HEAD
(&
ˇche
->
˛u°î_li°
);

2183 
	`INIT_LIST_HEAD
(&
ˇche
->
bg_li°
);

2184 
	`INIT_LIST_HEAD
(&
ˇche
->
ro_li°
);

2185 
	`INIT_LIST_HEAD
(&
ˇche
->
disˇrd_li°
);

2186 
	`INIT_LIST_HEAD
(&
ˇche
->
dúty_li°
);

2187 
	`INIT_LIST_HEAD
(&
ˇche
->
io_li°
);

2188 
	`INIT_LIST_HEAD
(&
ˇche
->
a˘ive_bg_li°
);

2189 
	`båfs_öô_‰ì_•a˚_˘l
(
ˇche
, cache->
‰ì_•a˚_˘l
);

2190 
	`©omic_£t
(&
ˇche
->
‰ozí
, 0);

2191 
	`muãx_öô
(&
ˇche
->
‰ì_•a˚_lock
);

2193  
ˇche
;

2194 
	}
}

2200 
	$check_chunk_block_group_m≠pögs
(
båfs_fs_öfo
 *
fs_öfo
)

2202 
exã¡_m≠_åì
 *
m≠_åì
 = &
fs_öfo
->
m≠pög_åì
;

2203 
exã¡_m≠
 *
em
;

2204 
båfs_block_group
 *
bg
;

2205 
u64
 
°¨t
 = 0;

2206 
ªt
 = 0;

2209 
	`ªad_lock
(&
m≠_åì
->
lock
);

2215 
em
 = 
	`lookup_exã¡_m≠pög
(
m≠_åì
, 
°¨t
, 1);

2216 
	`ªad_u∆ock
(&
m≠_åì
->
lock
);

2217 i‡(!
em
)

2220 
bg
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
em
->
°¨t
);

2221 i‡(!
bg
) {

2222 
	`båfs_îr
(
fs_öfo
,

2224 
em
->
°¨t
,Ém->
Àn
);

2225 
ªt
 = -
EUCLEAN
;

2226 
	`‰ì_exã¡_m≠
(
em
);

2229 i‡(
bg
->
°¨t
 !
em
->°¨à|| bg->
Àngth
 !em->
Àn
 ||

2230 (
bg
->
Êags
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
) !=

2231 (
em
->
m≠_lookup
->
ty≥
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
)) {

2232 
	`båfs_îr
(
fs_öfo
,

2234 
em
->
°¨t
,Ém->
Àn
,

2235 
em
->
m≠_lookup
->
ty≥
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
,

2236 
bg
->
°¨t
, bg->
Àngth
,

2237 
bg
->
Êags
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
);

2238 
ªt
 = -
EUCLEAN
;

2239 
	`‰ì_exã¡_m≠
(
em
);

2240 
	`båfs_put_block_group
(
bg
);

2243 
°¨t
 = 
em
->°¨à+Ém->
Àn
;

2244 
	`‰ì_exã¡_m≠
(
em
);

2245 
	`båfs_put_block_group
(
bg
);

2247  
ªt
;

2248 
	}
}

2250 
	$ªad_⁄e_block_group
(
båfs_fs_öfo
 *
öfo
,

2251 
båfs_block_group_ôem
 *
bgi
,

2252 c⁄° 
båfs_key
 *
key
,

2253 
√ed_˛ór
)

2255 
båfs_block_group
 *
ˇche
;

2256 c⁄° 
boﬁ
 
mixed
 = 
	`båfs_fs_öcom∑t
(
öfo
, 
MIXED_GROUPS
);

2257 
ªt
;

2259 
	`ASSERT
(
key
->
ty≥
 =
BTRFS_BLOCK_GROUP_ITEM_KEY
);

2261 
ˇche
 = 
	`båfs_¸óã_block_group_ˇche
(
öfo
, 
key
->
obje˘id
);

2262 i‡(!
ˇche
)

2263  -
ENOMEM
;

2265 
ˇche
->
Àngth
 = 
key
->
off£t
;

2266 
ˇche
->
u£d
 = 
	`båfs_°ack_block_group_u£d
(
bgi
);

2267 
ˇche
->
commô_u£d
 = cache->
u£d
;

2268 
ˇche
->
Êags
 = 
	`båfs_°ack_block_group_Êags
(
bgi
);

2269 
ˇche
->
globÆ_roŸ_id
 = 
	`båfs_°ack_block_group_chunk_obje˘id
(
bgi
);

2271 
	`£t_‰ì_•a˚_åì_thªshﬁds
(
ˇche
);

2273 i‡(
√ed_˛ór
) {

2284 i‡(
	`båfs_ã°_›t
(
öfo
, 
SPACE_CACHE
))

2285 
ˇche
->
disk_ˇche_°©e
 = 
BTRFS_DC_CLEAR
;

2287 i‡(!
mixed
 && ((
ˇche
->
Êags
 & 
BTRFS_BLOCK_GROUP_METADATA
) &&

2288 (
ˇche
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
))) {

2289 
	`båfs_îr
(
öfo
,

2291 
ˇche
->
°¨t
);

2292 
ªt
 = -
EINVAL
;

2293 
îr‹
;

2296 
ªt
 = 
	`båfs_lﬂd_block_group_z⁄e_öfo
(
ˇche
, 
Ál£
);

2297 i‡(
ªt
) {

2298 
	`båfs_îr
(
öfo
, "zoned: failedÅoÜoad zone info of bg %llu",

2299 
ˇche
->
°¨t
);

2300 
îr‹
;

2308 
ªt
 = 
	`ex˛ude_su≥r_°rùes
(
ˇche
);

2309 i‡(
ªt
) {

2311 
	`båfs_‰ì_ex˛uded_exã¡s
(
ˇche
);

2312 
îr‹
;

2327 i‡(
	`båfs_is_z⁄ed
(
öfo
)) {

2328 
	`båfs_ˇlc_z⁄e_unußbÀ
(
ˇche
);

2330 
	`båfs_‰ì_ex˛uded_exã¡s
(
ˇche
);

2331 } i‡(
ˇche
->
Àngth
 =ˇche->
u£d
) {

2332 
ˇche
->
ˇched
 = 
BTRFS_CACHE_FINISHED
;

2333 
	`båfs_‰ì_ex˛uded_exã¡s
(
ˇche
);

2334 } i‡(
ˇche
->
u£d
 == 0) {

2335 
ˇche
->
ˇched
 = 
BTRFS_CACHE_FINISHED
;

2336 
ªt
 = 
	`båfs_add_√w_‰ì_•a˚
(
ˇche
, cache->
°¨t
,

2337 
ˇche
->
°¨t
 + cache->
Àngth
, 
NULL
);

2338 
	`båfs_‰ì_ex˛uded_exã¡s
(
ˇche
);

2339 i‡(
ªt
)

2340 
îr‹
;

2343 
ªt
 = 
	`båfs_add_block_group_ˇche
(
öfo
, 
ˇche
);

2344 i‡(
ªt
) {

2345 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
ˇche
);

2346 
îr‹
;

2348 
	`åa˚_båfs_add_block_group
(
öfo
, 
ˇche
, 0);

2349 
	`båfs_add_bg_to_•a˚_öfo
(
öfo
, 
ˇche
);

2351 
	`£t_avaû_Æloc_bôs
(
öfo
, 
ˇche
->
Êags
);

2352 i‡(
	`båfs_chunk_wrôóbÀ
(
öfo
, 
ˇche
->
°¨t
)) {

2353 i‡(
ˇche
->
u£d
 == 0) {

2354 
	`ASSERT
(
	`li°_em±y
(&
ˇche
->
bg_li°
));

2355 i‡(
	`båfs_ã°_›t
(
öfo
, 
DISCARD_ASYNC
))

2356 
	`båfs_disˇrd_queue_w‹k
(&
öfo
->
disˇrd_˘l
, 
ˇche
);

2358 
	`båfs_m¨k_bg_unu£d
(
ˇche
);

2361 
	`öc_block_group_ro
(
ˇche
, 1);

2365 
îr‹
:

2366 
	`båfs_put_block_group
(
ˇche
);

2367  
ªt
;

2368 
	}
}

2370 
	$fûl_dummy_bgs
(
båfs_fs_öfo
 *
fs_öfo
)

2372 
exã¡_m≠_åì
 *
em_åì
 = &
fs_öfo
->
m≠pög_åì
;

2373 
rb_node
 *
node
;

2374 
ªt
 = 0;

2376 
node
 = 
	`rb_fú°_ˇched
(&
em_åì
->
m≠
);Çode;Çodê
	`rb_√xt
(node)) {

2377 
exã¡_m≠
 *
em
;

2378 
m≠_lookup
 *
m≠
;

2379 
båfs_block_group
 *
bg
;

2381 
em
 = 
	`rb_íåy
(
node
, 
exã¡_m≠
, 
rb_node
);

2382 
m≠
 = 
em
->
m≠_lookup
;

2383 
bg
 = 
	`båfs_¸óã_block_group_ˇche
(
fs_öfo
, 
em
->
°¨t
);

2384 i‡(!
bg
) {

2385 
ªt
 = -
ENOMEM
;

2390 
bg
->
Àngth
 = 
em
->
Àn
;

2391 
bg
->
Êags
 = 
m≠
->
ty≥
;

2392 
bg
->
ˇched
 = 
BTRFS_CACHE_FINISHED
;

2393 
bg
->
u£d
 = 
em
->
Àn
;

2394 
bg
->
Êags
 = 
m≠
->
ty≥
;

2395 
ªt
 = 
	`båfs_add_block_group_ˇche
(
fs_öfo
, 
bg
);

2400 i‡(
ªt
 =-
EEXIST
) {

2401 
ªt
 = 0;

2402 
	`båfs_put_block_group
(
bg
);

2406 i‡(
ªt
) {

2407 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
bg
);

2408 
	`båfs_put_block_group
(
bg
);

2412 
	`båfs_add_bg_to_•a˚_öfo
(
fs_öfo
, 
bg
);

2414 
	`£t_avaû_Æloc_bôs
(
fs_öfo
, 
bg
->
Êags
);

2416 i‡(!
ªt
)

2417 
	`båfs_öô_globÆ_block_rsv
(
fs_öfo
);

2418  
ªt
;

2419 
	}
}

2421 
	$båfs_ªad_block_groups
(
båfs_fs_öfo
 *
öfo
)

2423 
båfs_roŸ
 *
roŸ
 = 
	`båfs_block_group_roŸ
(
öfo
);

2424 
båfs_∑th
 *
∑th
;

2425 
ªt
;

2426 
båfs_block_group
 *
ˇche
;

2427 
båfs_•a˚_öfo
 *
•a˚_öfo
;

2428 
båfs_key
 
key
;

2429 
√ed_˛ór
 = 0;

2430 
u64
 
ˇche_gí
;

2440 i‡(!
roŸ
 || (
	`båfs_su≥r_com∑t_ro_Êags
(
öfo
->
su≥r_c›y
) &

2441 ~
BTRFS_FEATURE_COMPAT_RO_SUPP
))

2442  
	`fûl_dummy_bgs
(
öfo
);

2444 
key
.
obje˘id
 = 0;

2445 
key
.
off£t
 = 0;

2446 
key
.
ty≥
 = 
BTRFS_BLOCK_GROUP_ITEM_KEY
;

2447 
∑th
 = 
	`båfs_Æloc_∑th
();

2448 i‡(!
∑th
)

2449  -
ENOMEM
;

2451 
ˇche_gí
 = 
	`båfs_su≥r_ˇche_gíî©i⁄
(
öfo
->
su≥r_c›y
);

2452 i‡(
	`båfs_ã°_›t
(
öfo
, 
SPACE_CACHE
) &&

2453 
	`båfs_su≥r_gíî©i⁄
(
öfo
->
su≥r_c›y
Ë!
ˇche_gí
)

2454 
√ed_˛ór
 = 1;

2455 i‡(
	`båfs_ã°_›t
(
öfo
, 
CLEAR_CACHE
))

2456 
√ed_˛ór
 = 1;

2459 
båfs_block_group_ôem
 
bgi
;

2460 
exã¡_buf„r
 *
Àaf
;

2461 
¶Ÿ
;

2463 
ªt
 = 
	`föd_fú°_block_group
(
öfo
, 
∑th
, &
key
);

2464 i‡(
ªt
 > 0)

2466 i‡(
ªt
 != 0)

2467 
îr‹
;

2469 
Àaf
 = 
∑th
->
nodes
[0];

2470 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

2472 
	`ªad_exã¡_buf„r
(
Àaf
, &
bgi
, 
	`båfs_ôem_±r_off£t
÷óf, 
¶Ÿ
),

2473 (
bgi
));

2475 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

2476 
	`båfs_ªÀa£_∑th
(
∑th
);

2477 
ªt
 = 
	`ªad_⁄e_block_group
(
öfo
, &
bgi
, &
key
, 
√ed_˛ór
);

2478 i‡(
ªt
 < 0)

2479 
îr‹
;

2480 
key
.
obje˘id
 +key.
off£t
;

2481 
key
.
off£t
 = 0;

2483 
	`båfs_ªÀa£_∑th
(
∑th
);

2485 
	`li°_f‹_óch_íåy
(
•a˚_öfo
, &
öfo
->•a˚_öfo, 
li°
) {

2486 
i
;

2488 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; i++) {

2489 i‡(
	`li°_em±y
(&
•a˚_öfo
->
block_groups
[
i
]))

2491 
ˇche
 = 
	`li°_fú°_íåy
(&
•a˚_öfo
->
block_groups
[
i
],

2492 
båfs_block_group
,

2493 
li°
);

2494 
	`båfs_sysfs_add_block_group_ty≥
(
ˇche
);

2497 i‡(!(
	`båfs_gë_Æloc_¥ofûe
(
öfo
, 
•a˚_öfo
->
Êags
) &

2498 (
BTRFS_BLOCK_GROUP_RAID10
 |

2499 
BTRFS_BLOCK_GROUP_RAID1_MASK
 |

2500 
BTRFS_BLOCK_GROUP_RAID56_MASK
 |

2501 
BTRFS_BLOCK_GROUP_DUP
)))

2507 
	`li°_f‹_óch_íåy
(
ˇche
,

2508 &
•a˚_öfo
->
block_groups
[
BTRFS_RAID_RAID0
],

2509 
li°
)

2510 
	`öc_block_group_ro
(
ˇche
, 1);

2511 
	`li°_f‹_óch_íåy
(
ˇche
,

2512 &
•a˚_öfo
->
block_groups
[
BTRFS_RAID_SINGLE
],

2513 
li°
)

2514 
	`öc_block_group_ro
(
ˇche
, 1);

2517 
	`båfs_öô_globÆ_block_rsv
(
öfo
);

2518 
ªt
 = 
	`check_chunk_block_group_m≠pögs
(
öfo
);

2519 
îr‹
:

2520 
	`båfs_‰ì_∑th
(
∑th
);

2527 i‡(
ªt
 && 
	`båfs_ã°_›t
(
öfo
, 
IGNOREBADROOTS
))

2528 
ªt
 = 
	`fûl_dummy_bgs
(
öfo
);

2529  
ªt
;

2530 
	}
}

2539 
	$ö£π_block_group_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

2540 
båfs_block_group
 *
block_group
)

2542 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2543 
båfs_block_group_ôem
 
bgi
;

2544 
båfs_roŸ
 *
roŸ
 = 
	`båfs_block_group_roŸ
(
fs_öfo
);

2545 
båfs_key
 
key
;

2546 
u64
 
ﬁd_commô_u£d
;

2547 
ªt
;

2549 
	`•ö_lock
(&
block_group
->
lock
);

2550 
	`båfs_£t_°ack_block_group_u£d
(&
bgi
, 
block_group
->
u£d
);

2551 
	`båfs_£t_°ack_block_group_chunk_obje˘id
(&
bgi
,

2552 
block_group
->
globÆ_roŸ_id
);

2553 
	`båfs_£t_°ack_block_group_Êags
(&
bgi
, 
block_group
->
Êags
);

2554 
ﬁd_commô_u£d
 = 
block_group
->
commô_u£d
;

2555 
block_group
->
commô_u£d
 = block_group->
u£d
;

2556 
key
.
obje˘id
 = 
block_group
->
°¨t
;

2557 
key
.
ty≥
 = 
BTRFS_BLOCK_GROUP_ITEM_KEY
;

2558 
key
.
off£t
 = 
block_group
->
Àngth
;

2559 
	`•ö_u∆ock
(&
block_group
->
lock
);

2561 
ªt
 = 
	`båfs_ö£π_ôem
(
å™s
, 
roŸ
, &
key
, &
bgi
, (bgi));

2562 i‡(
ªt
 < 0) {

2563 
	`•ö_lock
(&
block_group
->
lock
);

2564 
block_group
->
commô_u£d
 = 
ﬁd_commô_u£d
;

2565 
	`•ö_u∆ock
(&
block_group
->
lock
);

2568  
ªt
;

2569 
	}
}

2571 
	$ö£π_dev_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

2572 
båfs_devi˚
 *
devi˚
, 
u64
 
chunk_off£t
,

2573 
u64
 
°¨t
, u64 
num_byãs
)

2575 
båfs_fs_öfo
 *
fs_öfo
 = 
devi˚
->fs_info;

2576 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
dev_roŸ
;

2577 
båfs_∑th
 *
∑th
;

2578 
båfs_dev_exã¡
 *
exã¡
;

2579 
exã¡_buf„r
 *
Àaf
;

2580 
båfs_key
 
key
;

2581 
ªt
;

2583 
	`WARN_ON
(!
	`ã°_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
devi˚
->
dev_°©e
));

2584 
	`WARN_ON
(
	`ã°_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
));

2585 
∑th
 = 
	`båfs_Æloc_∑th
();

2586 i‡(!
∑th
)

2587  -
ENOMEM
;

2589 
key
.
obje˘id
 = 
devi˚
->
devid
;

2590 
key
.
ty≥
 = 
BTRFS_DEV_EXTENT_KEY
;

2591 
key
.
off£t
 = 
°¨t
;

2592 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
, (*
exã¡
));

2593 i‡(
ªt
)

2594 
out
;

2596 
Àaf
 = 
∑th
->
nodes
[0];

2597 
exã¡
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_dev_exã¡
);

2598 
	`båfs_£t_dev_exã¡_chunk_åì
(
Àaf
, 
exã¡
, 
BTRFS_CHUNK_TREE_OBJECTID
);

2599 
	`båfs_£t_dev_exã¡_chunk_obje˘id
(
Àaf
, 
exã¡
,

2600 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
);

2601 
	`båfs_£t_dev_exã¡_chunk_off£t
(
Àaf
, 
exã¡
, 
chunk_off£t
);

2603 
	`båfs_£t_dev_exã¡_Àngth
(
Àaf
, 
exã¡
, 
num_byãs
);

2604 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

2605 
out
:

2606 
	`båfs_‰ì_∑th
(
∑th
);

2607  
ªt
;

2608 
	}
}

2616 
	$ö£π_dev_exã¡s
(
båfs_å™s_h™dÀ
 *
å™s
,

2617 
u64
 
chunk_off£t
, u64 
chunk_size
)

2619 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2620 
båfs_devi˚
 *
devi˚
;

2621 
exã¡_m≠
 *
em
;

2622 
m≠_lookup
 *
m≠
;

2623 
u64
 
dev_off£t
;

2624 
u64
 
°rùe_size
;

2625 
i
;

2626 
ªt
 = 0;

2628 
em
 = 
	`båfs_gë_chunk_m≠
(
fs_öfo
, 
chunk_off£t
, 
chunk_size
);

2629 i‡(
	`IS_ERR
(
em
))

2630  
	`PTR_ERR
(
em
);

2632 
m≠
 = 
em
->
m≠_lookup
;

2633 
°rùe_size
 = 
em
->
‹ig_block_Àn
;

2644 
	`muãx_lock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

2645 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

2646 
devi˚
 = 
m≠
->
°rùes
[
i
].
dev
;

2647 
dev_off£t
 = 
m≠
->
°rùes
[
i
].
physiˇl
;

2649 
ªt
 = 
	`ö£π_dev_exã¡
(
å™s
, 
devi˚
, 
chunk_off£t
, 
dev_off£t
,

2650 
°rùe_size
);

2651 i‡(
ªt
)

2654 
	`muãx_u∆ock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

2656 
	`‰ì_exã¡_m≠
(
em
);

2657  
ªt
;

2658 
	}
}

2667 
	$båfs_¸óã_≥ndög_block_groups
(
båfs_å™s_h™dÀ
 *
å™s
)

2669 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2670 
båfs_block_group
 *
block_group
;

2671 
ªt
 = 0;

2673 !
	`li°_em±y
(&
å™s
->
√w_bgs
)) {

2674 
ödex
;

2676 
block_group
 = 
	`li°_fú°_íåy
(&
å™s
->
√w_bgs
,

2677 
båfs_block_group
,

2678 
bg_li°
);

2679 i‡(
ªt
)

2680 
√xt
;

2682 
ödex
 = 
	`båfs_bg_Êags_to_øid_ödex
(
block_group
->
Êags
);

2684 
ªt
 = 
	`ö£π_block_group_ôem
(
å™s
, 
block_group
);

2685 i‡(
ªt
)

2686 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2687 i‡(!
	`ã°_bô
(
BLOCK_GROUP_FLAG_CHUNK_ITEM_INSERTED
,

2688 &
block_group
->
ru¡ime_Êags
)) {

2689 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

2690 
ªt
 = 
	`båfs_chunk_Æloc_add_chunk_ôem
(
å™s
, 
block_group
);

2691 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

2692 i‡(
ªt
)

2693 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2695 
ªt
 = 
	`ö£π_dev_exã¡s
(
å™s
, 
block_group
->
°¨t
,

2696 
block_group
->
Àngth
);

2697 i‡(
ªt
)

2698 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2699 
	`add_block_group_‰ì_•a˚
(
å™s
, 
block_group
);

2707 i‡(
block_group
->
•a˚_öfo
->
block_group_kobjs
[
ödex
] =
NULL
)

2708 
	`båfs_sysfs_add_block_group_ty≥
(
block_group
);

2711 
√xt
:

2712 
	`båfs_dñayed_ªfs_rsv_ªÀa£
(
fs_öfo
, 1);

2713 
	`li°_dñ_öô
(&
block_group
->
bg_li°
);

2714 
	`˛ór_bô
(
BLOCK_GROUP_FLAG_NEW
, &
block_group
->
ru¡ime_Êags
);

2716 
	`båfs_å™s_ªÀa£_chunk_mëad©a
(
å™s
);

2717 
	}
}

2723 
u64
 
	$ˇlcuœã_globÆ_roŸ_id
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
off£t
)

2725 
u64
 
div
 = 
SZ_1G
;

2726 
u64
 
ödex
;

2728 i‡(!
	`båfs_fs_öcom∑t
(
fs_öfo
, 
EXTENT_TREE_V2
))

2729  
BTRFS_FIRST_CHUNK_TREE_OBJECTID
;

2732 i‡(
	`båfs_su≥r_tŸÆ_byãs
(
fs_öfo
->
su≥r_c›y
Ë<(
SZ_1G
 * 10ULL))

2733 
div
 = 
SZ_128M
;

2735 
off£t
 = 
	`div64_u64
(off£t, 
div
);

2736 
	`div64_u64_ªm
(
off£t
, 
fs_öfo
->
ƒ_globÆ_roŸs
, &
ödex
);

2737  
ödex
;

2738 
	}
}

2740 
båfs_block_group
 *
	$båfs_make_block_group
(
båfs_å™s_h™dÀ
 *
å™s
,

2741 
u64
 
ty≥
,

2742 
u64
 
chunk_off£t
, u64 
size
)

2744 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2745 
båfs_block_group
 *
ˇche
;

2746 
ªt
;

2748 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

2750 
ˇche
 = 
	`båfs_¸óã_block_group_ˇche
(
fs_öfo
, 
chunk_off£t
);

2751 i‡(!
ˇche
)

2752  
	`ERR_PTR
(-
ENOMEM
);

2759 
	`£t_bô
(
BLOCK_GROUP_FLAG_NEW
, &
ˇche
->
ru¡ime_Êags
);

2761 
ˇche
->
Àngth
 = 
size
;

2762 
	`£t_‰ì_•a˚_åì_thªshﬁds
(
ˇche
);

2763 
ˇche
->
Êags
 = 
ty≥
;

2764 
ˇche
->
ˇched
 = 
BTRFS_CACHE_FINISHED
;

2765 
ˇche
->
globÆ_roŸ_id
 = 
	`ˇlcuœã_globÆ_roŸ_id
(
fs_öfo
, cache->
°¨t
);

2767 i‡(
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE
))

2768 
	`£t_bô
(
BLOCK_GROUP_FLAG_NEEDS_FREE_SPACE
, &
ˇche
->
ru¡ime_Êags
);

2770 
ªt
 = 
	`båfs_lﬂd_block_group_z⁄e_öfo
(
ˇche
, 
åue
);

2771 i‡(
ªt
) {

2772 
	`båfs_put_block_group
(
ˇche
);

2773  
	`ERR_PTR
(
ªt
);

2776 
ªt
 = 
	`ex˛ude_su≥r_°rùes
(
ˇche
);

2777 i‡(
ªt
) {

2779 
	`båfs_‰ì_ex˛uded_exã¡s
(
ˇche
);

2780 
	`båfs_put_block_group
(
ˇche
);

2781  
	`ERR_PTR
(
ªt
);

2784 
ªt
 = 
	`båfs_add_√w_‰ì_•a˚
(
ˇche
, 
chunk_off£t
, chunk_off£à+ 
size
, 
NULL
);

2785 
	`båfs_‰ì_ex˛uded_exã¡s
(
ˇche
);

2786 i‡(
ªt
) {

2787 
	`båfs_put_block_group
(
ˇche
);

2788  
	`ERR_PTR
(
ªt
);

2796 
ˇche
->
•a˚_öfo
 = 
	`båfs_föd_•a˚_öfo
(
fs_öfo
, cache->
Êags
);

2797 
	`ASSERT
(
ˇche
->
•a˚_öfo
);

2799 
ªt
 = 
	`båfs_add_block_group_ˇche
(
fs_öfo
, 
ˇche
);

2800 i‡(
ªt
) {

2801 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
ˇche
);

2802 
	`båfs_put_block_group
(
ˇche
);

2803  
	`ERR_PTR
(
ªt
);

2810 
	`åa˚_båfs_add_block_group
(
fs_öfo
, 
ˇche
, 1);

2811 
	`båfs_add_bg_to_•a˚_öfo
(
fs_öfo
, 
ˇche
);

2812 
	`båfs_upd©e_globÆ_block_rsv
(
fs_öfo
);

2814 #ifde‡
CONFIG_BTRFS_DEBUG


2815 i‡(
	`båfs_should_‰agmít_‰ì_•a˚
(
ˇche
)) {

2816 
ˇche
->
•a˚_öfo
->
byãs_u£d
 +
size
 >> 1;

2817 
	`‰agmít_‰ì_•a˚
(
ˇche
);

2821 
	`li°_add_èû
(&
ˇche
->
bg_li°
, &
å™s
->
√w_bgs
);

2822 
å™s
->
dñayed_ªf_upd©es
++;

2823 
	`båfs_upd©e_dñayed_ªfs_rsv
(
å™s
);

2825 
	`£t_avaû_Æloc_bôs
(
fs_öfo
, 
ty≥
);

2826  
ˇche
;

2827 
	}
}

2838 
	$båfs_öc_block_group_ro
(
båfs_block_group
 *
ˇche
,

2839 
boﬁ
 
do_chunk_Æloc
)

2841 
båfs_fs_öfo
 *
fs_öfo
 = 
ˇche
->fs_info;

2842 
båfs_å™s_h™dÀ
 *
å™s
;

2843 
båfs_roŸ
 *
roŸ
 = 
	`båfs_block_group_roŸ
(
fs_öfo
);

2844 
u64
 
Æloc_Êags
;

2845 
ªt
;

2846 
boﬁ
 
dúty_bg_ru¬ög
;

2854 i‡(
	`sb_rd⁄ly
(
fs_öfo
->
sb
)) {

2855 
	`muãx_lock
(&
fs_öfo
->
ro_block_group_muãx
);

2856 
ªt
 = 
	`öc_block_group_ro
(
ˇche
, 0);

2857 
	`muãx_u∆ock
(&
fs_öfo
->
ro_block_group_muãx
);

2858  
ªt
;

2862 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
roŸ
);

2863 i‡(
	`IS_ERR
(
å™s
))

2864  
	`PTR_ERR
(
å™s
);

2866 
dúty_bg_ru¬ög
 = 
Ál£
;

2873 
	`muãx_lock
(&
fs_öfo
->
ro_block_group_muãx
);

2874 i‡(
	`ã°_bô
(
BTRFS_TRANS_DIRTY_BG_RUN
, &
å™s
->
å™ß˘i⁄
->
Êags
)) {

2875 
u64
 
å™sid
 = 
å™s
->transid;

2877 
	`muãx_u∆ock
(&
fs_öfo
->
ro_block_group_muãx
);

2878 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

2880 
ªt
 = 
	`båfs_waô_f‹_commô
(
fs_öfo
, 
å™sid
);

2881 i‡(
ªt
)

2882  
ªt
;

2883 
dúty_bg_ru¬ög
 = 
åue
;

2885 } 
dúty_bg_ru¬ög
);

2887 i‡(
do_chunk_Æloc
) {

2892 
Æloc_Êags
 = 
	`båfs_gë_Æloc_¥ofûe
(
fs_öfo
, 
ˇche
->
Êags
);

2893 i‡(
Æloc_Êags
 !
ˇche
->
Êags
) {

2894 
ªt
 = 
	`båfs_chunk_Æloc
(
å™s
, 
Æloc_Êags
,

2895 
CHUNK_ALLOC_FORCE
);

2900 i‡(
ªt
 =-
ENOSPC
)

2901 
ªt
 = 0;

2902 i‡(
ªt
 < 0)

2903 
out
;

2907 
ªt
 = 
	`öc_block_group_ro
(
ˇche
, 0);

2908 i‡(!
ªt
)

2909 
out
;

2910 i‡(
ªt
 =-
ETXTBSY
)

2911 
u∆ock_out
;

2918 i‡(!
do_chunk_Æloc
 && 
ªt
 =-
ENOSPC
 &&

2919 (
ˇche
->
Êags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
))

2920 
u∆ock_out
;

2922 
Æloc_Êags
 = 
	`båfs_gë_Æloc_¥ofûe
(
fs_öfo
, 
ˇche
->
•a˚_öfo
->
Êags
);

2923 
ªt
 = 
	`båfs_chunk_Æloc
(
å™s
, 
Æloc_Êags
, 
CHUNK_ALLOC_FORCE
);

2924 i‡(
ªt
 < 0)

2925 
out
;

2930 
ªt
 = 
	`båfs_z⁄ed_a˘iv©e_⁄e_bg
(
fs_öfo
, 
ˇche
->
•a˚_öfo
, 
åue
);

2931 i‡(
ªt
 < 0)

2932 
out
;

2934 
ªt
 = 
	`öc_block_group_ro
(
ˇche
, 0);

2935 i‡(
ªt
 =-
ETXTBSY
)

2936 
u∆ock_out
;

2937 
out
:

2938 i‡(
ˇche
->
Êags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) {

2939 
Æloc_Êags
 = 
	`båfs_gë_Æloc_¥ofûe
(
fs_öfo
, 
ˇche
->
Êags
);

2940 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

2941 
	`check_sy°em_chunk
(
å™s
, 
Æloc_Êags
);

2942 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

2944 
u∆ock_out
:

2945 
	`muãx_u∆ock
(&
fs_öfo
->
ro_block_group_muãx
);

2947 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

2948  
ªt
;

2949 
	}
}

2951 
	$båfs_dec_block_group_ro
(
båfs_block_group
 *
ˇche
)

2953 
båfs_•a˚_öfo
 *
söfo
 = 
ˇche
->
•a˚_öfo
;

2954 
u64
 
num_byãs
;

2956 
	`BUG_ON
(!
ˇche
->
ro
);

2958 
	`•ö_lock
(&
söfo
->
lock
);

2959 
	`•ö_lock
(&
ˇche
->
lock
);

2960 i‡(!--
ˇche
->
ro
) {

2961 i‡(
	`båfs_is_z⁄ed
(
ˇche
->
fs_öfo
)) {

2963 
ˇche
->
z⁄e_unußbÀ
 =

2964 (
ˇche
->
Æloc_off£t
 - cache->
u£d
) +

2965 (
ˇche
->
Àngth
 - cache->
z⁄e_ˇ∑côy
);

2966 
söfo
->
byãs_z⁄e_unußbÀ
 +
ˇche
->
z⁄e_unußbÀ
;

2967 
söfo
->
byãs_ªad⁄ly
 -
ˇche
->
z⁄e_unußbÀ
;

2969 
num_byãs
 = 
ˇche
->
Àngth
 - cache->
ª£rved
 -

2970 
ˇche
->
pö√d
 - cache->
byãs_su≥r
 -

2971 
ˇche
->
z⁄e_unußbÀ
 - cache->
u£d
;

2972 
söfo
->
byãs_ªad⁄ly
 -
num_byãs
;

2973 
	`li°_dñ_öô
(&
ˇche
->
ro_li°
);

2975 
	`•ö_u∆ock
(&
ˇche
->
lock
);

2976 
	`•ö_u∆ock
(&
söfo
->
lock
);

2977 
	}
}

2979 
	$upd©e_block_group_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

2980 
båfs_∑th
 *
∑th
,

2981 
båfs_block_group
 *
ˇche
)

2983 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2984 
ªt
;

2985 
båfs_roŸ
 *
roŸ
 = 
	`båfs_block_group_roŸ
(
fs_öfo
);

2986 
bi
;

2987 
exã¡_buf„r
 *
Àaf
;

2988 
båfs_block_group_ôem
 
bgi
;

2989 
båfs_key
 
key
;

2990 
u64
 
ﬁd_commô_u£d
;

2991 
u64
 
u£d
;

2999 
	`•ö_lock
(&
ˇche
->
lock
);

3000 
ﬁd_commô_u£d
 = 
ˇche
->
commô_u£d
;

3001 
u£d
 = 
ˇche
->used;

3003 i‡(
ˇche
->
commô_u£d
 =
u£d
) {

3004 
	`•ö_u∆ock
(&
ˇche
->
lock
);

3007 
ˇche
->
commô_u£d
 = 
u£d
;

3008 
	`•ö_u∆ock
(&
ˇche
->
lock
);

3010 
key
.
obje˘id
 = 
ˇche
->
°¨t
;

3011 
key
.
ty≥
 = 
BTRFS_BLOCK_GROUP_ITEM_KEY
;

3012 
key
.
off£t
 = 
ˇche
->
Àngth
;

3014 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, 0, 1);

3015 i‡(
ªt
) {

3016 i‡(
ªt
 > 0)

3017 
ªt
 = -
ENOENT
;

3018 
Áû
;

3021 
Àaf
 = 
∑th
->
nodes
[0];

3022 
bi
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

3023 
	`båfs_£t_°ack_block_group_u£d
(&
bgi
, 
u£d
);

3024 
	`båfs_£t_°ack_block_group_chunk_obje˘id
(&
bgi
,

3025 
ˇche
->
globÆ_roŸ_id
);

3026 
	`båfs_£t_°ack_block_group_Êags
(&
bgi
, 
ˇche
->
Êags
);

3027 
	`wrôe_exã¡_buf„r
(
Àaf
, &
bgi
, 
bi
, (bgi));

3028 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

3029 
Áû
:

3030 
	`båfs_ªÀa£_∑th
(
∑th
);

3040 i‡(
ªt
 < 0 &&Ñë !-
ENOENT
) {

3041 
	`•ö_lock
(&
ˇche
->
lock
);

3042 
ˇche
->
commô_u£d
 = 
ﬁd_commô_u£d
;

3043 
	`•ö_u∆ock
(&
ˇche
->
lock
);

3045  
ªt
;

3047 
	}
}

3049 
	$ˇche_ßve_£tup
(
båfs_block_group
 *
block_group
,

3050 
båfs_å™s_h™dÀ
 *
å™s
,

3051 
båfs_∑th
 *
∑th
)

3053 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

3054 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
åì_roŸ
;

3055 
öode
 *öodê
NULL
;

3056 
exã¡_ch™ge£t
 *
d©a_ª£rved
 = 
NULL
;

3057 
u64
 
Æloc_höt
 = 0;

3058 
dcs
 = 
BTRFS_DC_ERROR
;

3059 
u64
 
ˇche_size
 = 0;

3060 
ªåõs
 = 0;

3061 
ªt
 = 0;

3063 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
SPACE_CACHE
))

3070 i‡(
block_group
->
Àngth
 < (100 * 
SZ_1M
)) {

3071 
	`•ö_lock
(&
block_group
->
lock
);

3072 
block_group
->
disk_ˇche_°©e
 = 
BTRFS_DC_WRITTEN
;

3073 
	`•ö_u∆ock
(&
block_group
->
lock
);

3077 i‡(
	`TRANS_ABORTED
(
å™s
))

3079 
agaö
:

3080 
öode
 = 
	`lookup_‰ì_•a˚_öode
(
block_group
, 
∑th
);

3081 i‡(
	`IS_ERR
(
öode
Ë&& 
	`PTR_ERR
(öodeË!-
ENOENT
) {

3082 
ªt
 = 
	`PTR_ERR
(
öode
);

3083 
	`båfs_ªÀa£_∑th
(
∑th
);

3084 
out
;

3087 i‡(
	`IS_ERR
(
öode
)) {

3088 
	`BUG_ON
(
ªåõs
);

3089 
ªåõs
++;

3091 i‡(
block_group
->
ro
)

3092 
out_‰ì
;

3094 
ªt
 = 
	`¸óã_‰ì_•a˚_öode
(
å™s
, 
block_group
, 
∑th
);

3095 i‡(
ªt
)

3096 
out_‰ì
;

3097 
agaö
;

3105 
	`BTRFS_I
(
öode
)->
gíî©i⁄
 = 0;

3106 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

3107 i‡(
ªt
) {

3118 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3119 
out_put
;

3121 
	`WARN_ON
(
ªt
);

3124 i‡(
block_group
->
ˇche_gíî©i⁄
 =
å™s
->
å™sid
 &&

3125 
	`i_size_ªad
(
öode
)) {

3126 
dcs
 = 
BTRFS_DC_SETUP
;

3127 
out_put
;

3130 i‡(
	`i_size_ªad
(
öode
) > 0) {

3131 
ªt
 = 
	`båfs_check_åunc_ˇche_‰ì_•a˚
(
fs_öfo
,

3132 &
fs_öfo
->
globÆ_block_rsv
);

3133 i‡(
ªt
)

3134 
out_put
;

3136 
ªt
 = 
	`båfs_åunˇã_‰ì_•a˚_ˇche
(
å™s
, 
NULL
, 
öode
);

3137 i‡(
ªt
)

3138 
out_put
;

3141 
	`•ö_lock
(&
block_group
->
lock
);

3142 i‡(
block_group
->
ˇched
 !
BTRFS_CACHE_FINISHED
 ||

3143 !
	`båfs_ã°_›t
(
fs_öfo
, 
SPACE_CACHE
)) {

3150 
dcs
 = 
BTRFS_DC_WRITTEN
;

3151 
	`•ö_u∆ock
(&
block_group
->
lock
);

3152 
out_put
;

3154 
	`•ö_u∆ock
(&
block_group
->
lock
);

3160 i‡(
	`ã°_bô
(
BTRFS_TRANS_CACHE_ENOSPC
, &
å™s
->
å™ß˘i⁄
->
Êags
)) {

3161 
ªt
 = -
ENOSPC
;

3162 
out_put
;

3171 
ˇche_size
 = 
	`div_u64
(
block_group
->
Àngth
, 
SZ_256M
);

3172 i‡(!
ˇche_size
)

3173 
ˇche_size
 = 1;

3175 
ˇche_size
 *= 16;

3176 
ˇche_size
 *
fs_öfo
->
£˘‹size
;

3178 
ªt
 = 
	`båfs_check_d©a_‰ì_•a˚
(
	`BTRFS_I
(
öode
), &
d©a_ª£rved
, 0,

3179 
ˇche_size
, 
Ál£
);

3180 i‡(
ªt
)

3181 
out_put
;

3183 
ªt
 = 
	`båfs_¥óŒoc_fûe_ønge_å™s
(
öode
, 
å™s
, 0, 0, 
ˇche_size
,

3184 
ˇche_size
, cache_size,

3185 &
Æloc_höt
);

3194 i‡(!
ªt
)

3195 
dcs
 = 
BTRFS_DC_SETUP
;

3196 i‡(
ªt
 =-
ENOSPC
)

3197 
	`£t_bô
(
BTRFS_TRANS_CACHE_ENOSPC
, &
å™s
->
å™ß˘i⁄
->
Êags
);

3199 
out_put
:

3200 
	`ùut
(
öode
);

3201 
out_‰ì
:

3202 
	`båfs_ªÀa£_∑th
(
∑th
);

3203 
out
:

3204 
	`•ö_lock
(&
block_group
->
lock
);

3205 i‡(!
ªt
 && 
dcs
 =
BTRFS_DC_SETUP
)

3206 
block_group
->
ˇche_gíî©i⁄
 = 
å™s
->
å™sid
;

3207 
block_group
->
disk_ˇche_°©e
 = 
dcs
;

3208 
	`•ö_u∆ock
(&
block_group
->
lock
);

3210 
	`exã¡_ch™ge£t_‰ì
(
d©a_ª£rved
);

3211  
ªt
;

3212 
	}
}

3214 
	$båfs_£tup_•a˚_ˇche
(
båfs_å™s_h™dÀ
 *
å™s
)

3216 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

3217 
båfs_block_group
 *
ˇche
, *
tmp
;

3218 
båfs_å™ß˘i⁄
 *
cur_å™s
 = 
å™s
->
å™ß˘i⁄
;

3219 
båfs_∑th
 *
∑th
;

3221 i‡(
	`li°_em±y
(&
cur_å™s
->
dúty_bgs
) ||

3222 !
	`båfs_ã°_›t
(
fs_öfo
, 
SPACE_CACHE
))

3225 
∑th
 = 
	`båfs_Æloc_∑th
();

3226 i‡(!
∑th
)

3227  -
ENOMEM
;

3230 
	`li°_f‹_óch_íåy_ß„
(
ˇche
, 
tmp
, &
cur_å™s
->
dúty_bgs
,

3231 
dúty_li°
) {

3232 i‡(
ˇche
->
disk_ˇche_°©e
 =
BTRFS_DC_CLEAR
)

3233 
	`ˇche_ßve_£tup
(
ˇche
, 
å™s
, 
∑th
);

3236 
	`båfs_‰ì_∑th
(
∑th
);

3238 
	}
}

3252 
	$båfs_°¨t_dúty_block_groups
(
båfs_å™s_h™dÀ
 *
å™s
)

3254 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

3255 
båfs_block_group
 *
ˇche
;

3256 
båfs_å™ß˘i⁄
 *
cur_å™s
 = 
å™s
->
å™ß˘i⁄
;

3257 
ªt
 = 0;

3258 
should_put
;

3259 
båfs_∑th
 *
∑th
 = 
NULL
;

3260 
	`LIST_HEAD
(
dúty
);

3261 
li°_hód
 *
io
 = &
cur_å™s
->
io_bgs
;

3262 
lo›s
 = 0;

3264 
	`•ö_lock
(&
cur_å™s
->
dúty_bgs_lock
);

3265 i‡(
	`li°_em±y
(&
cur_å™s
->
dúty_bgs
)) {

3266 
	`•ö_u∆ock
(&
cur_å™s
->
dúty_bgs_lock
);

3269 
	`li°_•li˚_öô
(&
cur_å™s
->
dúty_bgs
, &
dúty
);

3270 
	`•ö_u∆ock
(&
cur_å™s
->
dúty_bgs_lock
);

3272 
agaö
:

3274 
	`båfs_¸óã_≥ndög_block_groups
(
å™s
);

3276 i‡(!
∑th
) {

3277 
∑th
 = 
	`båfs_Æloc_∑th
();

3278 i‡(!
∑th
) {

3279 
ªt
 = -
ENOMEM
;

3280 
out
;

3289 
	`muãx_lock
(&
å™s
->
å™ß˘i⁄
->
ˇche_wrôe_muãx
);

3290 !
	`li°_em±y
(&
dúty
)) {

3291 
boﬁ
 
dr›_ª£rve
 = 
åue
;

3293 
ˇche
 = 
	`li°_fú°_íåy
(&
dúty
, 
båfs_block_group
,

3294 
dúty_li°
);

3300 i‡(!
	`li°_em±y
(&
ˇche
->
io_li°
)) {

3301 
	`li°_dñ_öô
(&
ˇche
->
io_li°
);

3302 
	`båfs_waô_ˇche_io
(
å™s
, 
ˇche
, 
∑th
);

3303 
	`båfs_put_block_group
(
ˇche
);

3315 
	`•ö_lock
(&
cur_å™s
->
dúty_bgs_lock
);

3316 
	`li°_dñ_öô
(&
ˇche
->
dúty_li°
);

3317 
	`•ö_u∆ock
(&
cur_å™s
->
dúty_bgs_lock
);

3319 
should_put
 = 1;

3321 
	`ˇche_ßve_£tup
(
ˇche
, 
å™s
, 
∑th
);

3323 i‡(
ˇche
->
disk_ˇche_°©e
 =
BTRFS_DC_SETUP
) {

3324 
ˇche
->
io_˘l
.
öode
 = 
NULL
;

3325 
ªt
 = 
	`båfs_wrôe_out_ˇche
(
å™s
, 
ˇche
, 
∑th
);

3326 i‡(
ªt
 =0 && 
ˇche
->
io_˘l
.
öode
) {

3327 
should_put
 = 0;

3334 
	`li°_add_èû
(&
ˇche
->
io_li°
, 
io
);

3340 
ªt
 = 0;

3343 i‡(!
ªt
) {

3344 
ªt
 = 
	`upd©e_block_group_ôem
(
å™s
, 
∑th
, 
ˇche
);

3354 i‡(
ªt
 =-
ENOENT
) {

3355 
ªt
 = 0;

3356 
	`•ö_lock
(&
cur_å™s
->
dúty_bgs_lock
);

3357 i‡(
	`li°_em±y
(&
ˇche
->
dúty_li°
)) {

3358 
	`li°_add_èû
(&
ˇche
->
dúty_li°
,

3359 &
cur_å™s
->
dúty_bgs
);

3360 
	`båfs_gë_block_group
(
ˇche
);

3361 
dr›_ª£rve
 = 
Ál£
;

3363 
	`•ö_u∆ock
(&
cur_å™s
->
dúty_bgs_lock
);

3364 } i‡(
ªt
) {

3365 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3370 i‡(
should_put
)

3371 
	`båfs_put_block_group
(
ˇche
);

3372 i‡(
dr›_ª£rve
)

3373 
	`båfs_dñayed_ªfs_rsv_ªÀa£
(
fs_öfo
, 1);

3379 
	`muãx_u∆ock
(&
å™s
->
å™ß˘i⁄
->
ˇche_wrôe_muãx
);

3380 i‡(
ªt
)

3381 
out
;

3382 
	`muãx_lock
(&
å™s
->
å™ß˘i⁄
->
ˇche_wrôe_muãx
);

3384 
	`muãx_u∆ock
(&
å™s
->
å™ß˘i⁄
->
ˇche_wrôe_muãx
);

3390 i‡(!
ªt
)

3391 
ªt
 = 
	`båfs_run_dñayed_ªfs
(
å™s
, 0);

3392 i‡(!
ªt
 && 
lo›s
 == 0) {

3393 
lo›s
++;

3394 
	`•ö_lock
(&
cur_å™s
->
dúty_bgs_lock
);

3395 
	`li°_•li˚_öô
(&
cur_å™s
->
dúty_bgs
, &
dúty
);

3400 i‡(!
	`li°_em±y
(&
dúty
)) {

3401 
	`•ö_u∆ock
(&
cur_å™s
->
dúty_bgs_lock
);

3402 
agaö
;

3404 
	`•ö_u∆ock
(&
cur_å™s
->
dúty_bgs_lock
);

3406 
out
:

3407 i‡(
ªt
 < 0) {

3408 
	`•ö_lock
(&
cur_å™s
->
dúty_bgs_lock
);

3409 
	`li°_•li˚_öô
(&
dúty
, &
cur_å™s
->
dúty_bgs
);

3410 
	`•ö_u∆ock
(&
cur_å™s
->
dúty_bgs_lock
);

3411 
	`båfs_˛ónup_dúty_bgs
(
cur_å™s
, 
fs_öfo
);

3414 
	`båfs_‰ì_∑th
(
∑th
);

3415  
ªt
;

3416 
	}
}

3418 
	$båfs_wrôe_dúty_block_groups
(
båfs_å™s_h™dÀ
 *
å™s
)

3420 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

3421 
båfs_block_group
 *
ˇche
;

3422 
båfs_å™ß˘i⁄
 *
cur_å™s
 = 
å™s
->
å™ß˘i⁄
;

3423 
ªt
 = 0;

3424 
should_put
;

3425 
båfs_∑th
 *
∑th
;

3426 
li°_hód
 *
io
 = &
cur_å™s
->
io_bgs
;

3428 
∑th
 = 
	`båfs_Æloc_∑th
();

3429 i‡(!
∑th
)

3430  -
ENOMEM
;

3447 
	`•ö_lock
(&
cur_å™s
->
dúty_bgs_lock
);

3448 !
	`li°_em±y
(&
cur_å™s
->
dúty_bgs
)) {

3449 
ˇche
 = 
	`li°_fú°_íåy
(&
cur_å™s
->
dúty_bgs
,

3450 
båfs_block_group
,

3451 
dúty_li°
);

3458 i‡(!
	`li°_em±y
(&
ˇche
->
io_li°
)) {

3459 
	`•ö_u∆ock
(&
cur_å™s
->
dúty_bgs_lock
);

3460 
	`li°_dñ_öô
(&
ˇche
->
io_li°
);

3461 
	`båfs_waô_ˇche_io
(
å™s
, 
ˇche
, 
∑th
);

3462 
	`båfs_put_block_group
(
ˇche
);

3463 
	`•ö_lock
(&
cur_å™s
->
dúty_bgs_lock
);

3470 
	`li°_dñ_öô
(&
ˇche
->
dúty_li°
);

3471 
	`•ö_u∆ock
(&
cur_å™s
->
dúty_bgs_lock
);

3472 
should_put
 = 1;

3474 
	`ˇche_ßve_£tup
(
ˇche
, 
å™s
, 
∑th
);

3476 i‡(!
ªt
)

3477 
ªt
 = 
	`båfs_run_dñayed_ªfs
(
å™s
,

3480 i‡(!
ªt
 && 
ˇche
->
disk_ˇche_°©e
 =
BTRFS_DC_SETUP
) {

3481 
ˇche
->
io_˘l
.
öode
 = 
NULL
;

3482 
ªt
 = 
	`båfs_wrôe_out_ˇche
(
å™s
, 
ˇche
, 
∑th
);

3483 i‡(
ªt
 =0 && 
ˇche
->
io_˘l
.
öode
) {

3484 
should_put
 = 0;

3485 
	`li°_add_èû
(&
ˇche
->
io_li°
, 
io
);

3491 
ªt
 = 0;

3494 i‡(!
ªt
) {

3495 
ªt
 = 
	`upd©e_block_group_ôem
(
å™s
, 
∑th
, 
ˇche
);

3509 i‡(
ªt
 =-
ENOENT
) {

3510 
	`waô_evít
(
cur_å™s
->
wrôî_waô
,

3511 
	`©omic_ªad
(&
cur_å™s
->
num_wrôîs
) == 1);

3512 
ªt
 = 
	`upd©e_block_group_ôem
(
å™s
, 
∑th
, 
ˇche
);

3514 i‡(
ªt
)

3515 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3519 i‡(
should_put
)

3520 
	`båfs_put_block_group
(
ˇche
);

3521 
	`båfs_dñayed_ªfs_rsv_ªÀa£
(
fs_öfo
, 1);

3522 
	`•ö_lock
(&
cur_å™s
->
dúty_bgs_lock
);

3524 
	`•ö_u∆ock
(&
cur_å™s
->
dúty_bgs_lock
);

3530 !
	`li°_em±y
(
io
)) {

3531 
ˇche
 = 
	`li°_fú°_íåy
(
io
, 
båfs_block_group
,

3532 
io_li°
);

3533 
	`li°_dñ_öô
(&
ˇche
->
io_li°
);

3534 
	`båfs_waô_ˇche_io
(
å™s
, 
ˇche
, 
∑th
);

3535 
	`båfs_put_block_group
(
ˇche
);

3538 
	`båfs_‰ì_∑th
(
∑th
);

3539  
ªt
;

3540 
	}
}

3542 
	$båfs_upd©e_block_group
(
båfs_å™s_h™dÀ
 *
å™s
,

3543 
u64
 
byãƒ
, u64 
num_byãs
, 
boﬁ
 
Æloc
)

3545 
båfs_fs_öfo
 *
öfo
 = 
å™s
->
fs_öfo
;

3546 
båfs_block_group
 *
ˇche
 = 
NULL
;

3547 
u64
 
tŸÆ
 = 
num_byãs
;

3548 
u64
 
ﬁd_vÆ
;

3549 
u64
 
byã_ö_group
;

3550 
Á˘‹
;

3551 
ªt
 = 0;

3554 
	`•ö_lock
(&
öfo
->
dñÆloc_roŸ_lock
);

3555 
ﬁd_vÆ
 = 
	`båfs_su≥r_byãs_u£d
(
öfo
->
su≥r_c›y
);

3556 i‡(
Æloc
)

3557 
ﬁd_vÆ
 +
num_byãs
;

3559 
ﬁd_vÆ
 -
num_byãs
;

3560 
	`båfs_£t_su≥r_byãs_u£d
(
öfo
->
su≥r_c›y
, 
ﬁd_vÆ
);

3561 
	`•ö_u∆ock
(&
öfo
->
dñÆloc_roŸ_lock
);

3563 
tŸÆ
) {

3564 
båfs_•a˚_öfo
 *
•a˚_öfo
;

3565 
boﬁ
 
ª˛aim
 = 
Ál£
;

3567 
ˇche
 = 
	`båfs_lookup_block_group
(
öfo
, 
byãƒ
);

3568 i‡(!
ˇche
) {

3569 
ªt
 = -
ENOENT
;

3572 
•a˚_öfo
 = 
ˇche
->space_info;

3573 
Á˘‹
 = 
	`båfs_bg_ty≥_to_Á˘‹
(
ˇche
->
Êags
);

3581 i‡(!
Æloc
 && !
	`båfs_block_group_d⁄e
(
ˇche
))

3582 
	`båfs_ˇche_block_group
(
ˇche
, 
åue
);

3584 
byã_ö_group
 = 
byãƒ
 - 
ˇche
->
°¨t
;

3585 
	`WARN_ON
(
byã_ö_group
 > 
ˇche
->
Àngth
);

3587 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

3588 
	`•ö_lock
(&
ˇche
->
lock
);

3590 i‡(
	`båfs_ã°_›t
(
öfo
, 
SPACE_CACHE
) &&

3591 
ˇche
->
disk_ˇche_°©e
 < 
BTRFS_DC_CLEAR
)

3592 
ˇche
->
disk_ˇche_°©e
 = 
BTRFS_DC_CLEAR
;

3594 
ﬁd_vÆ
 = 
ˇche
->
u£d
;

3595 
num_byãs
 = 
	`mö
(
tŸÆ
, 
ˇche
->
Àngth
 - 
byã_ö_group
);

3596 i‡(
Æloc
) {

3597 
ﬁd_vÆ
 +
num_byãs
;

3598 
ˇche
->
u£d
 = 
ﬁd_vÆ
;

3599 
ˇche
->
ª£rved
 -
num_byãs
;

3600 
•a˚_öfo
->
byãs_ª£rved
 -
num_byãs
;

3601 
•a˚_öfo
->
byãs_u£d
 +
num_byãs
;

3602 
•a˚_öfo
->
disk_u£d
 +
num_byãs
 * 
Á˘‹
;

3603 
	`•ö_u∆ock
(&
ˇche
->
lock
);

3604 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

3606 
ﬁd_vÆ
 -
num_byãs
;

3607 
ˇche
->
u£d
 = 
ﬁd_vÆ
;

3608 
ˇche
->
pö√d
 +
num_byãs
;

3609 
	`båfs_•a˚_öfo_upd©e_byãs_pö√d
(
öfo
, 
•a˚_öfo
,

3610 
num_byãs
);

3611 
•a˚_öfo
->
byãs_u£d
 -
num_byãs
;

3612 
•a˚_öfo
->
disk_u£d
 -
num_byãs
 * 
Á˘‹
;

3614 
ª˛aim
 = 
	`should_ª˛aim_block_group
(
ˇche
, 
num_byãs
);

3616 
	`•ö_u∆ock
(&
ˇche
->
lock
);

3617 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

3619 
	`£t_exã¡_bô
(&
å™s
->
å™ß˘i⁄
->
pö√d_exã¡s
,

3620 
byãƒ
, byãƒ + 
num_byãs
 - 1,

3621 
EXTENT_DIRTY
, 
NULL
);

3624 
	`•ö_lock
(&
å™s
->
å™ß˘i⁄
->
dúty_bgs_lock
);

3625 i‡(
	`li°_em±y
(&
ˇche
->
dúty_li°
)) {

3626 
	`li°_add_èû
(&
ˇche
->
dúty_li°
,

3627 &
å™s
->
å™ß˘i⁄
->
dúty_bgs
);

3628 
å™s
->
dñayed_ªf_upd©es
++;

3629 
	`båfs_gë_block_group
(
ˇche
);

3631 
	`•ö_u∆ock
(&
å™s
->
å™ß˘i⁄
->
dúty_bgs_lock
);

3639 i‡(!
Æloc
 && 
ﬁd_vÆ
 == 0) {

3640 i‡(!
	`båfs_ã°_›t
(
öfo
, 
DISCARD_ASYNC
))

3641 
	`båfs_m¨k_bg_unu£d
(
ˇche
);

3642 } i‡(!
Æloc
 && 
ª˛aim
) {

3643 
	`båfs_m¨k_bg_to_ª˛aim
(
ˇche
);

3646 
	`båfs_put_block_group
(
ˇche
);

3647 
tŸÆ
 -
num_byãs
;

3648 
byãƒ
 +
num_byãs
;

3652 
	`båfs_upd©e_dñayed_ªfs_rsv
(
å™s
);

3653  
ªt
;

3654 
	}
}

3669 
	$båfs_add_ª£rved_byãs
(
båfs_block_group
 *
ˇche
,

3670 
u64
 
øm_byãs
, u64 
num_byãs
, 
dñÆloc
,

3671 
boﬁ
 
f‹˚_wr⁄g_size_˛ass
)

3673 
båfs_•a˚_öfo
 *
•a˚_öfo
 = 
ˇche
->space_info;

3674 
båfs_block_group_size_˛ass
 
size_˛ass
;

3675 
ªt
 = 0;

3677 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

3678 
	`•ö_lock
(&
ˇche
->
lock
);

3679 i‡(
ˇche
->
ro
) {

3680 
ªt
 = -
EAGAIN
;

3681 
out
;

3684 i‡(
	`båfs_block_group_should_u£_size_˛ass
(
ˇche
)) {

3685 
size_˛ass
 = 
	`båfs_ˇlc_block_group_size_˛ass
(
num_byãs
);

3686 
ªt
 = 
	`båfs_u£_block_group_size_˛ass
(
ˇche
, 
size_˛ass
, 
f‹˚_wr⁄g_size_˛ass
);

3687 i‡(
ªt
)

3688 
out
;

3690 
ˇche
->
ª£rved
 +
num_byãs
;

3691 
•a˚_öfo
->
byãs_ª£rved
 +
num_byãs
;

3692 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
ˇche
->
fs_öfo
, "space_info",

3693 
•a˚_öfo
->
Êags
, 
num_byãs
, 1);

3694 
	`båfs_•a˚_öfo_upd©e_byãs_may_u£
(
ˇche
->
fs_öfo
,

3695 
•a˚_öfo
, -
øm_byãs
);

3696 i‡(
dñÆloc
)

3697 
ˇche
->
dñÆloc_byãs
 +
num_byãs
;

3703 i‡(
num_byãs
 < 
øm_byãs
)

3704 
	`båfs_åy_gø¡ög_tickës
(
ˇche
->
fs_öfo
, 
•a˚_öfo
);

3705 
out
:

3706 
	`•ö_u∆ock
(&
ˇche
->
lock
);

3707 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

3708  
ªt
;

3709 
	}
}

3723 
	$båfs_‰ì_ª£rved_byãs
(
båfs_block_group
 *
ˇche
,

3724 
u64
 
num_byãs
, 
dñÆloc
)

3726 
båfs_•a˚_öfo
 *
•a˚_öfo
 = 
ˇche
->space_info;

3728 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

3729 
	`•ö_lock
(&
ˇche
->
lock
);

3730 i‡(
ˇche
->
ro
)

3731 
•a˚_öfo
->
byãs_ªad⁄ly
 +
num_byãs
;

3732 
ˇche
->
ª£rved
 -
num_byãs
;

3733 
•a˚_öfo
->
byãs_ª£rved
 -
num_byãs
;

3734 
•a˚_öfo
->
max_exã¡_size
 = 0;

3736 i‡(
dñÆloc
)

3737 
ˇche
->
dñÆloc_byãs
 -
num_byãs
;

3738 
	`•ö_u∆ock
(&
ˇche
->
lock
);

3740 
	`båfs_åy_gø¡ög_tickës
(
ˇche
->
fs_öfo
, 
•a˚_öfo
);

3741 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

3742 
	}
}

3744 
	$f‹˚_mëad©a_Æloˇti⁄
(
båfs_fs_öfo
 *
öfo
)

3746 
li°_hód
 *
hód
 = &
öfo
->
•a˚_öfo
;

3747 
båfs_•a˚_öfo
 *
found
;

3749 
	`li°_f‹_óch_íåy
(
found
, 
hód
, 
li°
) {

3750 i‡(
found
->
Êags
 & 
BTRFS_BLOCK_GROUP_METADATA
)

3751 
found
->
f‹˚_Æloc
 = 
CHUNK_ALLOC_FORCE
;

3753 
	}
}

3755 
	$should_Æloc_chunk
(
båfs_fs_öfo
 *
fs_öfo
,

3756 
båfs_•a˚_öfo
 *
söfo
, 
f‹˚
)

3758 
u64
 
byãs_u£d
 = 
	`båfs_•a˚_öfo_u£d
(
söfo
, 
Ál£
);

3759 
u64
 
thªsh
;

3761 i‡(
f‹˚
 =
CHUNK_ALLOC_FORCE
)

3768 i‡(
f‹˚
 =
CHUNK_ALLOC_LIMITED
) {

3769 
thªsh
 = 
	`båfs_su≥r_tŸÆ_byãs
(
fs_öfo
->
su≥r_c›y
);

3770 
thªsh
 = 
	`max_t
(
u64
, 
SZ_64M
, 
	`mu…_≥rc
(thresh, 1));

3772 i‡(
söfo
->
tŸÆ_byãs
 - 
byãs_u£d
 < 
thªsh
)

3776 i‡(
byãs_u£d
 + 
SZ_2M
 < 
	`mu…_≥rc
(
söfo
->
tŸÆ_byãs
, 80))

3779 
	}
}

3781 
	$båfs_f‹˚_chunk_Æloc
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
ty≥
)

3783 
u64
 
Æloc_Êags
 = 
	`båfs_gë_Æloc_¥ofûe
(
å™s
->
fs_öfo
, 
ty≥
);

3785  
	`båfs_chunk_Æloc
(
å™s
, 
Æloc_Êags
, 
CHUNK_ALLOC_FORCE
);

3786 
	}
}

3788 
båfs_block_group
 *
	$do_chunk_Æloc
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
Êags
)

3790 
båfs_block_group
 *
bg
;

3791 
ªt
;

3799 
	`check_sy°em_chunk
(
å™s
, 
Êags
);

3801 
bg
 = 
	`båfs_¸óã_chunk
(
å™s
, 
Êags
);

3802 i‡(
	`IS_ERR
(
bg
)) {

3803 
ªt
 = 
	`PTR_ERR
(
bg
);

3804 
out
;

3807 
ªt
 = 
	`båfs_chunk_Æloc_add_chunk_ôem
(
å™s
, 
bg
);

3846 i‡(
ªt
 =-
ENOSPC
) {

3847 c⁄° 
u64
 
sys_Êags
 = 
	`båfs_sy°em_Æloc_¥ofûe
(
å™s
->
fs_öfo
);

3848 
båfs_block_group
 *
sys_bg
;

3850 
sys_bg
 = 
	`båfs_¸óã_chunk
(
å™s
, 
sys_Êags
);

3851 i‡(
	`IS_ERR
(
sys_bg
)) {

3852 
ªt
 = 
	`PTR_ERR
(
sys_bg
);

3853 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3854 
out
;

3857 
ªt
 = 
	`båfs_chunk_Æloc_add_chunk_ôem
(
å™s
, 
sys_bg
);

3858 i‡(
ªt
) {

3859 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3860 
out
;

3863 
ªt
 = 
	`båfs_chunk_Æloc_add_chunk_ôem
(
å™s
, 
bg
);

3864 i‡(
ªt
) {

3865 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3866 
out
;

3868 } i‡(
ªt
) {

3869 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3870 
out
;

3872 
out
:

3873 
	`båfs_å™s_ªÀa£_chunk_mëad©a
(
å™s
);

3875 i‡(
ªt
)

3876  
	`ERR_PTR
(
ªt
);

3878 
	`båfs_gë_block_group
(
bg
);

3879  
bg
;

3880 
	}
}

3989 
	$båfs_chunk_Æloc
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
Êags
,

3990 
båfs_chunk_Æloc_íum
 
f‹˚
)

3992 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

3993 
båfs_•a˚_öfo
 *
•a˚_öfo
;

3994 
båfs_block_group
 *
ªt_bg
;

3995 
boﬁ
 
waô_f‹_Æloc
 = 
Ál£
;

3996 
boﬁ
 
should_Æloc
 = 
Ál£
;

3997 
boﬁ
 
‰om_exã¡_Æloˇti⁄
 = 
Ál£
;

3998 
ªt
 = 0;

4000 i‡(
f‹˚
 =
CHUNK_ALLOC_FORCE_FOR_EXTENT
) {

4001 
‰om_exã¡_Æloˇti⁄
 = 
åue
;

4002 
f‹˚
 = 
CHUNK_ALLOC_FORCE
;

4006 i‡(
å™s
->
Æloˇtög_chunk
)

4007  -
ENOSPC
;

4029 i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

4030  -
ENOSPC
;

4032 
•a˚_öfo
 = 
	`båfs_föd_•a˚_öfo
(
fs_öfo
, 
Êags
);

4033 
	`ASSERT
(
•a˚_öfo
);

4036 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

4037 i‡(
f‹˚
 < 
•a˚_öfo
->
f‹˚_Æloc
)

4038 
f‹˚
 = 
•a˚_öfo
->
f‹˚_Æloc
;

4039 
should_Æloc
 = 
	`should_Æloc_chunk
(
fs_öfo
, 
•a˚_öfo
, 
f‹˚
);

4040 i‡(
•a˚_öfo
->
fuŒ
) {

4042 i‡(
should_Æloc
)

4043 
ªt
 = -
ENOSPC
;

4045 
ªt
 = 0;

4046 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

4047  
ªt
;

4048 } i‡(!
should_Æloc
) {

4049 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

4051 } i‡(
•a˚_öfo
->
chunk_Æloc
) {

4058 
waô_f‹_Æloc
 = 
åue
;

4059 
f‹˚
 = 
CHUNK_ALLOC_NO_FORCE
;

4060 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

4061 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

4062 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

4065 
•a˚_öfo
->
chunk_Æloc
 = 1;

4066 
waô_f‹_Æloc
 = 
Ál£
;

4067 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

4070 
	`c⁄d_ªsched
();

4071 } 
waô_f‹_Æloc
);

4073 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

4074 
å™s
->
Æloˇtög_chunk
 = 
åue
;

4080 i‡(
	`båfs_mixed_•a˚_öfo
(
•a˚_öfo
))

4081 
Êags
 |(
BTRFS_BLOCK_GROUP_DATA
 | 
BTRFS_BLOCK_GROUP_METADATA
);

4088 i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
 && 
fs_öfo
->
mëad©a_øtio
) {

4089 
fs_öfo
->
d©a_chunk_Æloˇti⁄s
++;

4090 i‡(!(
fs_öfo
->
d©a_chunk_Æloˇti⁄s
 %

4091 
fs_öfo
->
mëad©a_øtio
))

4092 
	`f‹˚_mëad©a_Æloˇti⁄
(
fs_öfo
);

4095 
ªt_bg
 = 
	`do_chunk_Æloc
(
å™s
, 
Êags
);

4096 
å™s
->
Æloˇtög_chunk
 = 
Ál£
;

4098 i‡(
	`IS_ERR
(
ªt_bg
)) {

4099 
ªt
 = 
	`PTR_ERR
(
ªt_bg
);

4100 } i‡(
‰om_exã¡_Æloˇti⁄
 && (
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
)) {

4105 
	`båfs_z⁄e_a˘iv©e
(
ªt_bg
);

4108 i‡(!
ªt
)

4109 
	`båfs_put_block_group
(
ªt_bg
);

4111 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

4112 i‡(
ªt
 < 0) {

4113 i‡(
ªt
 =-
ENOSPC
)

4114 
•a˚_öfo
->
fuŒ
 = 1;

4116 
out
;

4118 
ªt
 = 1;

4119 
•a˚_öfo
->
max_exã¡_size
 = 0;

4122 
•a˚_öfo
->
f‹˚_Æloc
 = 
CHUNK_ALLOC_NO_FORCE
;

4123 
out
:

4124 
•a˚_öfo
->
chunk_Æloc
 = 0;

4125 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

4126 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

4128  
ªt
;

4129 
	}
}

4131 
u64
 
	$gë_¥ofûe_num_devs
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
ty≥
)

4133 
u64
 
num_dev
;

4135 
num_dev
 = 
båfs_øid_¨øy
[
	`båfs_bg_Êags_to_øid_ödex
(
ty≥
)].
devs_max
;

4136 i‡(!
num_dev
)

4137 
num_dev
 = 
fs_öfo
->
fs_devi˚s
->
rw_devi˚s
;

4139  
num_dev
;

4140 
	}
}

4142 
	$ª£rve_chunk_•a˚
(
båfs_å™s_h™dÀ
 *
å™s
,

4143 
u64
 
byãs
,

4144 
u64
 
ty≥
)

4146 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

4147 
båfs_•a˚_öfo
 *
öfo
;

4148 
u64
 
À·
;

4149 
ªt
 = 0;

4155 
	`lockdï_as£π_hñd
(&
fs_öfo
->
chunk_muãx
);

4157 
öfo
 = 
	`båfs_föd_•a˚_öfo
(
fs_öfo
, 
BTRFS_BLOCK_GROUP_SYSTEM
);

4158 
	`•ö_lock
(&
öfo
->
lock
);

4159 
À·
 = 
öfo
->
tŸÆ_byãs
 - 
	`båfs_•a˚_öfo_u£d
(öfo, 
åue
);

4160 
	`•ö_u∆ock
(&
öfo
->
lock
);

4162 i‡(
À·
 < 
byãs
 && 
	`båfs_ã°_›t
(
fs_öfo
, 
ENOSPC_DEBUG
)) {

4163 
	`båfs_öfo
(
fs_öfo
, "left=%llu,Çeed=%llu, flags=%llu",

4164 
À·
, 
byãs
, 
ty≥
);

4165 
	`båfs_dump_•a˚_öfo
(
fs_öfo
, 
öfo
, 0, 0);

4168 i‡(
À·
 < 
byãs
) {

4169 
u64
 
Êags
 = 
	`båfs_sy°em_Æloc_¥ofûe
(
fs_öfo
);

4170 
båfs_block_group
 *
bg
;

4178 
bg
 = 
	`båfs_¸óã_chunk
(
å™s
, 
Êags
);

4179 i‡(
	`IS_ERR
(
bg
)) {

4180 
ªt
 = 
	`PTR_ERR
(
bg
);

4186 
ªt
 = 
	`båfs_z⁄ed_a˘iv©e_⁄e_bg
(
fs_öfo
, 
öfo
, 
åue
);

4187 i‡(
ªt
 < 0)

4200 
	`båfs_chunk_Æloc_add_chunk_ôem
(
å™s
, 
bg
);

4204 i‡(!
ªt
) {

4205 
ªt
 = 
	`båfs_block_rsv_add
(
fs_öfo
,

4206 &
fs_öfo
->
chunk_block_rsv
,

4207 
byãs
, 
BTRFS_RESERVE_NO_FLUSH
);

4208 i‡(!
ªt
)

4209 
å™s
->
chunk_byãs_ª£rved
 +
byãs
;

4211 
	}
}

4217 
	$check_sy°em_chunk
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
ty≥
)

4219 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

4220 c⁄° 
u64
 
num_devs
 = 
	`gë_¥ofûe_num_devs
(
fs_öfo
, 
ty≥
);

4221 
u64
 
byãs
;

4224 
byãs
 = 
	`båfs_ˇlc_mëad©a_size
(
fs_öfo
, 
num_devs
) +

4225 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
, 1);

4227 
	`ª£rve_chunk_•a˚
(
å™s
, 
byãs
, 
ty≥
);

4228 
	}
}

4246 
	$båfs_ª£rve_chunk_mëad©a
(
båfs_å™s_h™dÀ
 *
å™s
,

4247 
boﬁ
 
is_ôem_ö£πi⁄
)

4249 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

4250 
u64
 
byãs
;

4252 i‡(
is_ôem_ö£πi⁄
)

4253 
byãs
 = 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
, 1);

4255 
byãs
 = 
	`båfs_ˇlc_mëad©a_size
(
fs_öfo
, 1);

4257 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

4258 
	`ª£rve_chunk_•a˚
(
å™s
, 
byãs
, 
BTRFS_BLOCK_GROUP_SYSTEM
);

4259 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

4260 
	}
}

4262 
	$båfs_put_block_group_ˇche
(
båfs_fs_öfo
 *
öfo
)

4264 
båfs_block_group
 *
block_group
;

4266 
block_group
 = 
	`båfs_lookup_fú°_block_group
(
öfo
, 0);

4267 
block_group
) {

4268 
	`båfs_waô_block_group_ˇche_d⁄e
(
block_group
);

4269 
	`•ö_lock
(&
block_group
->
lock
);

4270 i‡(
	`ã°_™d_˛ór_bô
(
BLOCK_GROUP_FLAG_IREF
,

4271 &
block_group
->
ru¡ime_Êags
)) {

4272 
öode
 *öodê
block_group
->inode;

4274 
block_group
->
öode
 = 
NULL
;

4275 
	`•ö_u∆ock
(&
block_group
->
lock
);

4277 
	`ASSERT
(
block_group
->
io_˘l
.
öode
 =
NULL
);

4278 
	`ùut
(
öode
);

4280 
	`•ö_u∆ock
(&
block_group
->
lock
);

4282 
block_group
 = 
	`båfs_√xt_block_group
(block_group);

4284 
	}
}

4291 
	$båfs_‰ì_block_groups
(
båfs_fs_öfo
 *
öfo
)

4293 
båfs_block_group
 *
block_group
;

4294 
båfs_•a˚_öfo
 *
•a˚_öfo
;

4295 
båfs_ˇchög_c⁄åﬁ
 *
ˇchög_˘l
;

4296 
rb_node
 *
n
;

4298 i‡(
	`båfs_is_z⁄ed
(
öfo
)) {

4299 i‡(
öfo
->
a˘ive_mëa_bg
) {

4300 
	`båfs_put_block_group
(
öfo
->
a˘ive_mëa_bg
);

4301 
öfo
->
a˘ive_mëa_bg
 = 
NULL
;

4303 i‡(
öfo
->
a˘ive_sy°em_bg
) {

4304 
	`båfs_put_block_group
(
öfo
->
a˘ive_sy°em_bg
);

4305 
öfo
->
a˘ive_sy°em_bg
 = 
NULL
;

4309 
	`wrôe_lock
(&
öfo
->
block_group_ˇche_lock
);

4310 !
	`li°_em±y
(&
öfo
->
ˇchög_block_groups
)) {

4311 
ˇchög_˘l
 = 
	`li°_íåy
(
öfo
->
ˇchög_block_groups
.
√xt
,

4312 
båfs_ˇchög_c⁄åﬁ
, 
li°
);

4313 
	`li°_dñ
(&
ˇchög_˘l
->
li°
);

4314 
	`båfs_put_ˇchög_c⁄åﬁ
(
ˇchög_˘l
);

4316 
	`wrôe_u∆ock
(&
öfo
->
block_group_ˇche_lock
);

4318 
	`•ö_lock
(&
öfo
->
unu£d_bgs_lock
);

4319 !
	`li°_em±y
(&
öfo
->
unu£d_bgs
)) {

4320 
block_group
 = 
	`li°_fú°_íåy
(&
öfo
->
unu£d_bgs
,

4321 
båfs_block_group
,

4322 
bg_li°
);

4323 
	`li°_dñ_öô
(&
block_group
->
bg_li°
);

4324 
	`båfs_put_block_group
(
block_group
);

4327 !
	`li°_em±y
(&
öfo
->
ª˛aim_bgs
)) {

4328 
block_group
 = 
	`li°_fú°_íåy
(&
öfo
->
ª˛aim_bgs
,

4329 
båfs_block_group
,

4330 
bg_li°
);

4331 
	`li°_dñ_öô
(&
block_group
->
bg_li°
);

4332 
	`båfs_put_block_group
(
block_group
);

4334 
	`•ö_u∆ock
(&
öfo
->
unu£d_bgs_lock
);

4336 
	`•ö_lock
(&
öfo
->
z⁄e_a˘ive_bgs_lock
);

4337 !
	`li°_em±y
(&
öfo
->
z⁄e_a˘ive_bgs
)) {

4338 
block_group
 = 
	`li°_fú°_íåy
(&
öfo
->
z⁄e_a˘ive_bgs
,

4339 
båfs_block_group
,

4340 
a˘ive_bg_li°
);

4341 
	`li°_dñ_öô
(&
block_group
->
a˘ive_bg_li°
);

4342 
	`båfs_put_block_group
(
block_group
);

4344 
	`•ö_u∆ock
(&
öfo
->
z⁄e_a˘ive_bgs_lock
);

4346 
	`wrôe_lock
(&
öfo
->
block_group_ˇche_lock
);

4347 (
n
 = 
	`rb_œ°
(&
öfo
->
block_group_ˇche_åì
.
rb_roŸ
)Ë!
NULL
) {

4348 
block_group
 = 
	`rb_íåy
(
n
, 
båfs_block_group
,

4349 
ˇche_node
);

4350 
	`rb_îa£_ˇched
(&
block_group
->
ˇche_node
,

4351 &
öfo
->
block_group_ˇche_åì
);

4352 
	`RB_CLEAR_NODE
(&
block_group
->
ˇche_node
);

4353 
	`wrôe_u∆ock
(&
öfo
->
block_group_ˇche_lock
);

4355 
	`down_wrôe
(&
block_group
->
•a˚_öfo
->
groups_£m
);

4356 
	`li°_dñ
(&
block_group
->
li°
);

4357 
	`up_wrôe
(&
block_group
->
•a˚_öfo
->
groups_£m
);

4363 i‡(
block_group
->
ˇched
 =
BTRFS_CACHE_NO
 ||

4364 
block_group
->
ˇched
 =
BTRFS_CACHE_ERROR
)

4365 
	`båfs_‰ì_ex˛uded_exã¡s
(
block_group
);

4367 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
block_group
);

4368 
	`ASSERT
(
block_group
->
ˇched
 !
BTRFS_CACHE_STARTED
);

4369 
	`ASSERT
(
	`li°_em±y
(&
block_group
->
dúty_li°
));

4370 
	`ASSERT
(
	`li°_em±y
(&
block_group
->
io_li°
));

4371 
	`ASSERT
(
	`li°_em±y
(&
block_group
->
bg_li°
));

4372 
	`ASSERT
(
	`ªfcou¡_ªad
(&
block_group
->
ªfs
) == 1);

4373 
	`ASSERT
(
block_group
->
sw≠_exã¡s
 == 0);

4374 
	`båfs_put_block_group
(
block_group
);

4376 
	`wrôe_lock
(&
öfo
->
block_group_ˇche_lock
);

4378 
	`wrôe_u∆ock
(&
öfo
->
block_group_ˇche_lock
);

4380 
	`båfs_ªÀa£_globÆ_block_rsv
(
öfo
);

4382 !
	`li°_em±y
(&
öfo
->
•a˚_öfo
)) {

4383 
•a˚_öfo
 = 
	`li°_íåy
(
öfo
->•a˚_öfo.
√xt
,

4384 
båfs_•a˚_öfo
,

4385 
li°
);

4391 i‡(
	`WARN_ON
(
•a˚_öfo
->
byãs_pö√d
 > 0 ||

4392 
•a˚_öfo
->
byãs_may_u£
 > 0))

4393 
	`båfs_dump_•a˚_öfo
(
öfo
, 
•a˚_öfo
, 0, 0);

4402 i‡(!(
•a˚_öfo
->
Êags
 & 
BTRFS_BLOCK_GROUP_METADATA
) ||

4403 !
	`BTRFS_FS_LOG_CLEANUP_ERROR
(
öfo
)) {

4404 i‡(
	`WARN_ON
(
•a˚_öfo
->
byãs_ª£rved
 > 0))

4405 
	`båfs_dump_•a˚_öfo
(
öfo
, 
•a˚_öfo
, 0, 0);

4408 
	`WARN_ON
(
•a˚_öfo
->
ª˛aim_size
 > 0);

4409 
	`li°_dñ
(&
•a˚_öfo
->
li°
);

4410 
	`båfs_sysfs_ªmove_•a˚_öfo
(
•a˚_öfo
);

4413 
	}
}

4415 
	$båfs_‰ìze_block_group
(
båfs_block_group
 *
ˇche
)

4417 
	`©omic_öc
(&
ˇche
->
‰ozí
);

4418 
	}
}

4420 
	$båfs_un‰ìze_block_group
(
båfs_block_group
 *
block_group
)

4422 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

4423 
exã¡_m≠_åì
 *
em_åì
;

4424 
exã¡_m≠
 *
em
;

4425 
boﬁ
 
˛ónup
;

4427 
	`•ö_lock
(&
block_group
->
lock
);

4428 
˛ónup
 = (
	`©omic_dec_™d_ã°
(&
block_group
->
‰ozí
) &&

4429 
	`ã°_bô
(
BLOCK_GROUP_FLAG_REMOVED
, &
block_group
->
ru¡ime_Êags
));

4430 
	`•ö_u∆ock
(&
block_group
->
lock
);

4432 i‡(
˛ónup
) {

4433 
em_åì
 = &
fs_öfo
->
m≠pög_åì
;

4434 
	`wrôe_lock
(&
em_åì
->
lock
);

4435 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 
block_group
->
°¨t
,

4437 
	`BUG_ON
(!
em
);

4438 
	`ªmove_exã¡_m≠pög
(
em_åì
, 
em
);

4439 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

4442 
	`‰ì_exã¡_m≠
(
em
);

4443 
	`‰ì_exã¡_m≠
(
em
);

4450 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
block_group
);

4452 
	}
}

4454 
boﬁ
 
	$båfs_öc_block_group_sw≠_exã¡s
(
båfs_block_group
 *
bg
)

4456 
boﬁ
 
ªt
 = 
åue
;

4458 
	`•ö_lock
(&
bg
->
lock
);

4459 i‡(
bg
->
ro
)

4460 
ªt
 = 
Ál£
;

4462 
bg
->
sw≠_exã¡s
++;

4463 
	`•ö_u∆ock
(&
bg
->
lock
);

4465  
ªt
;

4466 
	}
}

4468 
	$båfs_dec_block_group_sw≠_exã¡s
(
båfs_block_group
 *
bg
, 
amou¡
)

4470 
	`•ö_lock
(&
bg
->
lock
);

4471 
	`ASSERT
(!
bg
->
ro
);

4472 
	`ASSERT
(
bg
->
sw≠_exã¡s
 >
amou¡
);

4473 
bg
->
sw≠_exã¡s
 -
amou¡
;

4474 
	`•ö_u∆ock
(&
bg
->
lock
);

4475 
	}
}

4477 
båfs_block_group_size_˛ass
 
	$båfs_ˇlc_block_group_size_˛ass
(
u64
 
size
)

4479 i‡(
size
 <
SZ_128K
)

4480  
BTRFS_BG_SZ_SMALL
;

4481 i‡(
size
 <
SZ_8M
)

4482  
BTRFS_BG_SZ_MEDIUM
;

4483  
BTRFS_BG_SZ_LARGE
;

4484 
	}
}

4505 
	$båfs_u£_block_group_size_˛ass
(
båfs_block_group
 *
bg
,

4506 
båfs_block_group_size_˛ass
 
size_˛ass
,

4507 
boﬁ
 
f‹˚_wr⁄g_size_˛ass
)

4509 
	`ASSERT
(
size_˛ass
 !
BTRFS_BG_SZ_NONE
);

4512 i‡(
bg
->
size_˛ass
 == size_class)

4524 i‡(
bg
->
size_˛ass
 !
BTRFS_BG_SZ_NONE
) {

4525 i‡(
f‹˚_wr⁄g_size_˛ass
)

4527  -
EAGAIN
;

4533 
bg
->
size_˛ass
 = size_class;

4536 
	}
}

4538 
boﬁ
 
	$båfs_block_group_should_u£_size_˛ass
(
båfs_block_group
 *
bg
)

4540 i‡(
	`båfs_is_z⁄ed
(
bg
->
fs_öfo
))

4541  
Ál£
;

4542 i‡(!
	`båfs_is_block_group_d©a_⁄ly
(
bg
))

4543  
Ál£
;

4544  
åue
;

4545 
	}
}

	@block-group.h

3 #i‚de‡
BTRFS_BLOCK_GROUP_H


4 
	#BTRFS_BLOCK_GROUP_H


	)

6 
	~"‰ì-•a˚-ˇche.h
"

8 
	ebåfs_disk_ˇche_°©e
 {

9 
	mBTRFS_DC_WRITTEN
,

10 
	mBTRFS_DC_ERROR
,

11 
	mBTRFS_DC_CLEAR
,

12 
	mBTRFS_DC_SETUP
,

15 
	ebåfs_block_group_size_˛ass
 {

17 
	mBTRFS_BG_SZ_NONE
,

19 
	mBTRFS_BG_SZ_SMALL
,

21 
	mBTRFS_BG_SZ_MEDIUM
,

23 
	mBTRFS_BG_SZ_LARGE
,

33 
	ebåfs_disˇrd_°©e
 {

34 
	mBTRFS_DISCARD_EXTENTS
,

35 
	mBTRFS_DISCARD_BITMAPS
,

36 
	mBTRFS_DISCARD_RESET_CURSOR
,

53 
	ebåfs_chunk_Æloc_íum
 {

54 
	mCHUNK_ALLOC_NO_FORCE
,

55 
	mCHUNK_ALLOC_LIMITED
,

56 
	mCHUNK_ALLOC_FORCE
,

57 
	mCHUNK_ALLOC_FORCE_FOR_EXTENT
,

61 
	ebåfs_block_group_Êags
 {

62 
	mBLOCK_GROUP_FLAG_IREF
,

63 
	mBLOCK_GROUP_FLAG_REMOVED
,

64 
	mBLOCK_GROUP_FLAG_TO_COPY
,

65 
	mBLOCK_GROUP_FLAG_RELOCATING_REPAIR
,

66 
	mBLOCK_GROUP_FLAG_CHUNK_ITEM_INSERTED
,

67 
	mBLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
,

68 
	mBLOCK_GROUP_FLAG_ZONED_DATA_RELOC
,

70 
	mBLOCK_GROUP_FLAG_NEEDS_FREE_SPACE
,

72 
	mBLOCK_GROUP_FLAG_SEQUENTIAL_ZONE
,

77 
	mBLOCK_GROUP_FLAG_NEW
,

80 
	ebåfs_ˇchög_ty≥
 {

81 
	mBTRFS_CACHE_NO
,

82 
	mBTRFS_CACHE_STARTED
,

83 
	mBTRFS_CACHE_FINISHED
,

84 
	mBTRFS_CACHE_ERROR
,

87 
	sbåfs_ˇchög_c⁄åﬁ
 {

88 
li°_hód
 
	mli°
;

89 
muãx
 
	mmuãx
;

90 
waô_queue_hód_t
 
	mwaô
;

91 
båfs_w‹k
 
	mw‹k
;

92 
båfs_block_group
 *
	mblock_group
;

94 
©omic_t
 
	m¥ogªss
;

95 
ªfcou¡_t
 
	mcou¡
;

99 
	#CACHING_CTL_WAKE_UP
 
SZ_2M


	)

101 
	sbåfs_block_group
 {

102 
båfs_fs_öfo
 *
	mfs_öfo
;

103 
öode
 *
	möode
;

104 
•ölock_t
 
	mlock
;

105 
u64
 
	m°¨t
;

106 
u64
 
	mÀngth
;

107 
u64
 
	mpö√d
;

108 
u64
 
	mª£rved
;

109 
u64
 
	mu£d
;

110 
u64
 
	mdñÆloc_byãs
;

111 
u64
 
	mbyãs_su≥r
;

112 
u64
 
	mÊags
;

113 
u64
 
	mˇche_gíî©i⁄
;

114 
u64
 
	mglobÆ_roŸ_id
;

121 
u64
 
	mcommô_u£d
;

126 
u32
 
	mbôm≠_high_thªsh
;

132 
u32
 
	mbôm≠_low_thªsh
;

139 
rw_£m≠h‹e
 
	md©a_rw£m
;

142 
	mfuŒ_°rùe_Àn
;

143 
	mru¡ime_Êags
;

145 
	mro
;

147 
	mdisk_ˇche_°©e
;

150 
	mˇched
;

151 
båfs_ˇchög_c⁄åﬁ
 *
	mˇchög_˘l
;

153 
båfs_•a˚_öfo
 *
	m•a˚_öfo
;

156 
båfs_‰ì_•a˚_˘l
 *
	m‰ì_•a˚_˘l
;

159 
rb_node
 
	mˇche_node
;

162 
li°_hód
 
	mli°
;

164 
ªfcou¡_t
 
	mªfs
;

170 
li°_hód
 
	m˛u°î_li°
;

180 
li°_hód
 
	mbg_li°
;

183 
li°_hód
 
	mro_li°
;

193 
©omic_t
 
	m‰ozí
;

196 
li°_hód
 
	mdisˇrd_li°
;

197 
	mdisˇrd_ödex
;

198 
u64
 
	mdisˇrd_ñigibÀ_time
;

199 
u64
 
	mdisˇrd_curs‹
;

200 
båfs_disˇrd_°©e
 
	mdisˇrd_°©e
;

203 
li°_hód
 
	mdúty_li°
;

204 
li°_hód
 
	mio_li°
;

206 
båfs_io_˘l
 
	mio_˘l
;

217 
©omic_t
 
	mª£rv©i⁄s
;

227 
©omic_t
 
	mnocow_wrôîs
;

230 
muãx
 
	m‰ì_•a˚_lock
;

236 
	msw≠_exã¡s
;

242 
u64
 
	mÆloc_off£t
;

243 
u64
 
	mz⁄e_unußbÀ
;

244 
u64
 
	mz⁄e_ˇ∑côy
;

245 
u64
 
	mmëa_wrôe_poöãr
;

246 
m≠_lookup
 *
	mphysiˇl_m≠
;

247 
li°_hód
 
	ma˘ive_bg_li°
;

248 
w‹k_°ru˘
 
	mz⁄e_föish_w‹k
;

249 
exã¡_buf„r
 *
	mœ°_eb
;

250 
båfs_block_group_size_˛ass
 
	msize_˛ass
;

253 
ölöe
 
u64
 
	$båfs_block_group_íd
(
båfs_block_group
 *
block_group
)

255  (
block_group
->
°¨t
 + block_group->
Àngth
);

256 
	}
}

258 
ölöe
 
boﬁ
 
	$båfs_is_block_group_d©a_⁄ly
(

259 
båfs_block_group
 *
block_group
)

265  (
block_group
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
) &&

266 !(
block_group
->
Êags
 & 
BTRFS_BLOCK_GROUP_METADATA
);

267 
	}
}

269 #ifde‡
CONFIG_BTRFS_DEBUG


270 
båfs_should_‰agmít_‰ì_•a˚
(
båfs_block_group
 *
block_group
);

273 
båfs_block_group
 *
båfs_lookup_fú°_block_group
(

274 
båfs_fs_öfo
 *
öfo
, 
u64
 
byãƒ
);

275 
båfs_block_group
 *
båfs_lookup_block_group
(

276 
båfs_fs_öfo
 *
öfo
, 
u64
 
byãƒ
);

277 
båfs_block_group
 *
båfs_√xt_block_group
(

278 
båfs_block_group
 *
ˇche
);

279 
båfs_gë_block_group
(
båfs_block_group
 *
ˇche
);

280 
båfs_put_block_group
(
båfs_block_group
 *
ˇche
);

281 
båfs_dec_block_group_ª£rv©i⁄s
(
båfs_fs_öfo
 *
fs_öfo
,

282 c⁄° 
u64
 
°¨t
);

283 
båfs_waô_block_group_ª£rv©i⁄s
(
båfs_block_group
 *
bg
);

284 
båfs_block_group
 *
båfs_öc_nocow_wrôîs
(
båfs_fs_öfo
 *
fs_öfo
,

285 
u64
 
byãƒ
);

286 
båfs_dec_nocow_wrôîs
(
båfs_block_group
 *
bg
);

287 
båfs_waô_nocow_wrôîs
(
båfs_block_group
 *
bg
);

288 
båfs_waô_block_group_ˇche_¥ogªss
(
båfs_block_group
 *
ˇche
,

289 
u64
 
num_byãs
);

290 
båfs_ˇche_block_group
(
båfs_block_group
 *
ˇche
, 
boﬁ
 
waô
);

291 
båfs_put_ˇchög_c⁄åﬁ
(
båfs_ˇchög_c⁄åﬁ
 *
˘l
);

292 
båfs_ˇchög_c⁄åﬁ
 *
båfs_gë_ˇchög_c⁄åﬁ
(

293 
båfs_block_group
 *
ˇche
);

294 
båfs_add_√w_‰ì_•a˚
(
båfs_block_group
 *
block_group
,

295 
u64
 
°¨t
, u64 
íd
, u64 *
tŸÆ_added_ªt
);

296 
båfs_å™s_h™dÀ
 *
båfs_°¨t_å™s_ªmove_block_group
(

297 
båfs_fs_öfo
 *
fs_öfo
,

298 c⁄° 
u64
 
chunk_off£t
);

299 
båfs_ªmove_block_group
(
båfs_å™s_h™dÀ
 *
å™s
,

300 
u64
 
group_°¨t
, 
exã¡_m≠
 *
em
);

301 
båfs_dñëe_unu£d_bgs
(
båfs_fs_öfo
 *
fs_öfo
);

302 
båfs_m¨k_bg_unu£d
(
båfs_block_group
 *
bg
);

303 
båfs_ª˛aim_bgs_w‹k
(
w‹k_°ru˘
 *
w‹k
);

304 
båfs_ª˛aim_bgs
(
båfs_fs_öfo
 *
fs_öfo
);

305 
båfs_m¨k_bg_to_ª˛aim
(
båfs_block_group
 *
bg
);

306 
båfs_ªad_block_groups
(
båfs_fs_öfo
 *
öfo
);

307 
båfs_block_group
 *
båfs_make_block_group
(
båfs_å™s_h™dÀ
 *
å™s
,

308 
u64
 
ty≥
,

309 
u64
 
chunk_off£t
, u64 
size
);

310 
båfs_¸óã_≥ndög_block_groups
(
båfs_å™s_h™dÀ
 *
å™s
);

311 
båfs_öc_block_group_ro
(
båfs_block_group
 *
ˇche
,

312 
boﬁ
 
do_chunk_Æloc
);

313 
båfs_dec_block_group_ro
(
båfs_block_group
 *
ˇche
);

314 
båfs_°¨t_dúty_block_groups
(
båfs_å™s_h™dÀ
 *
å™s
);

315 
båfs_wrôe_dúty_block_groups
(
båfs_å™s_h™dÀ
 *
å™s
);

316 
båfs_£tup_•a˚_ˇche
(
båfs_å™s_h™dÀ
 *
å™s
);

317 
båfs_upd©e_block_group
(
båfs_å™s_h™dÀ
 *
å™s
,

318 
u64
 
byãƒ
, u64 
num_byãs
, 
boﬁ
 
Æloc
);

319 
båfs_add_ª£rved_byãs
(
båfs_block_group
 *
ˇche
,

320 
u64
 
øm_byãs
, u64 
num_byãs
, 
dñÆloc
,

321 
boﬁ
 
f‹˚_wr⁄g_size_˛ass
);

322 
båfs_‰ì_ª£rved_byãs
(
båfs_block_group
 *
ˇche
,

323 
u64
 
num_byãs
, 
dñÆloc
);

324 
båfs_chunk_Æloc
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
Êags
,

325 
båfs_chunk_Æloc_íum
 
f‹˚
);

326 
båfs_f‹˚_chunk_Æloc
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
ty≥
);

327 
check_sy°em_chunk
(
båfs_å™s_h™dÀ
 *
å™s
, c⁄° 
u64
 
ty≥
);

328 
båfs_ª£rve_chunk_mëad©a
(
båfs_å™s_h™dÀ
 *
å™s
,

329 
boﬁ
 
is_ôem_ö£πi⁄
);

330 
u64
 
båfs_gë_Æloc_¥ofûe
(
båfs_fs_öfo
 *
fs_öfo
, u64 
‹ig_Êags
);

331 
båfs_put_block_group_ˇche
(
båfs_fs_öfo
 *
öfo
);

332 
båfs_‰ì_block_groups
(
båfs_fs_öfo
 *
öfo
);

333 
båfs_rm≠_block
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
chunk_°¨t
,

334 
u64
 
physiˇl
, u64 **
logiˇl
, *
«ddrs
, *
°rùe_Àn
);

336 
ölöe
 
u64
 
	$båfs_d©a_Æloc_¥ofûe
(
båfs_fs_öfo
 *
fs_öfo
)

338  
	`båfs_gë_Æloc_¥ofûe
(
fs_öfo
, 
BTRFS_BLOCK_GROUP_DATA
);

339 
	}
}

341 
ölöe
 
u64
 
	$båfs_mëad©a_Æloc_¥ofûe
(
båfs_fs_öfo
 *
fs_öfo
)

343  
	`båfs_gë_Æloc_¥ofûe
(
fs_öfo
, 
BTRFS_BLOCK_GROUP_METADATA
);

344 
	}
}

346 
ölöe
 
u64
 
	$båfs_sy°em_Æloc_¥ofûe
(
båfs_fs_öfo
 *
fs_öfo
)

348  
	`båfs_gë_Æloc_¥ofûe
(
fs_öfo
, 
BTRFS_BLOCK_GROUP_SYSTEM
);

349 
	}
}

351 
ölöe
 
	$båfs_block_group_d⁄e
(
båfs_block_group
 *
ˇche
)

353 
	`smp_mb
();

354  
ˇche
->
ˇched
 =
BTRFS_CACHE_FINISHED
 ||

355 
ˇche
->
ˇched
 =
BTRFS_CACHE_ERROR
;

356 
	}
}

358 
båfs_‰ìze_block_group
(
båfs_block_group
 *
ˇche
);

359 
båfs_un‰ìze_block_group
(
båfs_block_group
 *
ˇche
);

361 
boﬁ
 
båfs_öc_block_group_sw≠_exã¡s
(
båfs_block_group
 *
bg
);

362 
båfs_dec_block_group_sw≠_exã¡s
(
båfs_block_group
 *
bg
, 
amou¡
);

364 
båfs_block_group_size_˛ass
 
båfs_ˇlc_block_group_size_˛ass
(
u64
 
size
);

365 
båfs_u£_block_group_size_˛ass
(
båfs_block_group
 *
bg
,

366 
båfs_block_group_size_˛ass
 
size_˛ass
,

367 
boﬁ
 
f‹˚_wr⁄g_size_˛ass
);

368 
boﬁ
 
båfs_block_group_should_u£_size_˛ass
(
båfs_block_group
 *
bg
);

	@block-rsv.c

3 
	~"misc.h
"

4 
	~"˘ªe.h
"

5 
	~"block-rsv.h
"

6 
	~"•a˚-öfo.h
"

7 
	~"å™ß˘i⁄.h
"

8 
	~"block-group.h
"

9 
	~"disk-io.h
"

10 
	~"fs.h
"

11 
	~"ac˚ss‹s.h
"

105 
u64
 
	$block_rsv_ªÀa£_byãs
(
båfs_fs_öfo
 *
fs_öfo
,

106 
båfs_block_rsv
 *
block_rsv
,

107 
båfs_block_rsv
 *
de°
, 
u64
 
num_byãs
,

108 
u64
 *
qgroup_to_ªÀa£_ªt
)

110 
båfs_•a˚_öfo
 *
•a˚_öfo
 = 
block_rsv
->space_info;

111 
u64
 
qgroup_to_ªÀa£
 = 0;

112 
u64
 
ªt
;

114 
	`•ö_lock
(&
block_rsv
->
lock
);

115 i‡(
num_byãs
 =(
u64
)-1) {

116 
num_byãs
 = 
block_rsv
->
size
;

117 
qgroup_to_ªÀa£
 = 
block_rsv
->
qgroup_rsv_size
;

119 
block_rsv
->
size
 -
num_byãs
;

120 i‡(
block_rsv
->
ª£rved
 >block_rsv->
size
) {

121 
num_byãs
 = 
block_rsv
->
ª£rved
 - block_rsv->
size
;

122 
block_rsv
->
ª£rved
 = block_rsv->
size
;

123 
block_rsv
->
fuŒ
 = 
åue
;

125 
num_byãs
 = 0;

127 i‡(
qgroup_to_ªÀa£_ªt
 &&

128 
block_rsv
->
qgroup_rsv_ª£rved
 >block_rsv->
qgroup_rsv_size
) {

129 
qgroup_to_ªÀa£
 = 
block_rsv
->
qgroup_rsv_ª£rved
 -

130 
block_rsv
->
qgroup_rsv_size
;

131 
block_rsv
->
qgroup_rsv_ª£rved
 = block_rsv->
qgroup_rsv_size
;

133 
qgroup_to_ªÀa£
 = 0;

135 
	`•ö_u∆ock
(&
block_rsv
->
lock
);

137 
ªt
 = 
num_byãs
;

138 i‡(
num_byãs
 > 0) {

139 i‡(
de°
) {

140 
	`•ö_lock
(&
de°
->
lock
);

141 i‡(!
de°
->
fuŒ
) {

142 
u64
 
byãs_to_add
;

144 
byãs_to_add
 = 
de°
->
size
 - de°->
ª£rved
;

145 
byãs_to_add
 = 
	`mö
(
num_byãs
, bytes_to_add);

146 
de°
->
ª£rved
 +
byãs_to_add
;

147 i‡(
de°
->
ª£rved
 >de°->
size
)

148 
de°
->
fuŒ
 = 
åue
;

149 
num_byãs
 -
byãs_to_add
;

151 
	`•ö_u∆ock
(&
de°
->
lock
);

153 i‡(
num_byãs
)

154 
	`båfs_•a˚_öfo_‰ì_byãs_may_u£
(
fs_öfo
,

155 
•a˚_öfo
,

156 
num_byãs
);

158 i‡(
qgroup_to_ªÀa£_ªt
)

159 *
qgroup_to_ªÀa£_ªt
 = 
qgroup_to_ªÀa£
;

160  
ªt
;

161 
	}
}

163 
	$båfs_block_rsv_migøã
(
båfs_block_rsv
 *
§c
,

164 
båfs_block_rsv
 *
d°
, 
u64
 
num_byãs
,

165 
boﬁ
 
upd©e_size
)

167 
ªt
;

169 
ªt
 = 
	`båfs_block_rsv_u£_byãs
(
§c
, 
num_byãs
);

170 i‡(
ªt
)

171  
ªt
;

173 
	`båfs_block_rsv_add_byãs
(
d°
, 
num_byãs
, 
upd©e_size
);

175 
	}
}

177 
	$båfs_öô_block_rsv
(
båfs_block_rsv
 *
rsv
, 
båfs_rsv_ty≥
 
ty≥
)

179 
	`mem£t
(
rsv
, 0, (*rsv));

180 
	`•ö_lock_öô
(&
rsv
->
lock
);

181 
rsv
->
ty≥
 =Åype;

182 
	}
}

184 
	$båfs_öô_mëad©a_block_rsv
(
båfs_fs_öfo
 *
fs_öfo
,

185 
båfs_block_rsv
 *
rsv
,

186 
båfs_rsv_ty≥
 
ty≥
)

188 
	`båfs_öô_block_rsv
(
rsv
, 
ty≥
);

189 
rsv
->
•a˚_öfo
 = 
	`båfs_föd_•a˚_öfo
(
fs_öfo
,

190 
BTRFS_BLOCK_GROUP_METADATA
);

191 
	}
}

193 
båfs_block_rsv
 *
	$båfs_Æloc_block_rsv
(
båfs_fs_öfo
 *
fs_öfo
,

194 
båfs_rsv_ty≥
 
ty≥
)

196 
båfs_block_rsv
 *
block_rsv
;

198 
block_rsv
 = 
	`kmÆloc
((*block_rsv), 
GFP_NOFS
);

199 i‡(!
block_rsv
)

200  
NULL
;

202 
	`båfs_öô_mëad©a_block_rsv
(
fs_öfo
, 
block_rsv
, 
ty≥
);

203  
block_rsv
;

204 
	}
}

206 
	$båfs_‰ì_block_rsv
(
båfs_fs_öfo
 *
fs_öfo
,

207 
båfs_block_rsv
 *
rsv
)

209 i‡(!
rsv
)

211 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, 
rsv
, (
u64
)-1, 
NULL
);

212 
	`k‰ì
(
rsv
);

213 
	}
}

215 
	$båfs_block_rsv_add
(
båfs_fs_öfo
 *
fs_öfo
,

216 
båfs_block_rsv
 *
block_rsv
, 
u64
 
num_byãs
,

217 
båfs_ª£rve_Êush_íum
 
Êush
)

219 
ªt
;

221 i‡(
num_byãs
 == 0)

224 
ªt
 = 
	`båfs_ª£rve_mëad©a_byãs
(
fs_öfo
, 
block_rsv
, 
num_byãs
, 
Êush
);

225 i‡(!
ªt
)

226 
	`båfs_block_rsv_add_byãs
(
block_rsv
, 
num_byãs
, 
åue
);

228  
ªt
;

229 
	}
}

231 
	$båfs_block_rsv_check
(
båfs_block_rsv
 *
block_rsv
, 
mö_≥r˚¡
)

233 
u64
 
num_byãs
 = 0;

234 
ªt
 = -
ENOSPC
;

236 
	`•ö_lock
(&
block_rsv
->
lock
);

237 
num_byãs
 = 
	`mu…_≥rc
(
block_rsv
->
size
, 
mö_≥r˚¡
);

238 i‡(
block_rsv
->
ª£rved
 >
num_byãs
)

239 
ªt
 = 0;

240 
	`•ö_u∆ock
(&
block_rsv
->
lock
);

242  
ªt
;

243 
	}
}

245 
	$båfs_block_rsv_ªfûl
(
båfs_fs_öfo
 *
fs_öfo
,

246 
båfs_block_rsv
 *
block_rsv
, 
u64
 
num_byãs
,

247 
båfs_ª£rve_Êush_íum
 
Êush
)

249 
ªt
 = -
ENOSPC
;

251 i‡(!
block_rsv
)

254 
	`•ö_lock
(&
block_rsv
->
lock
);

255 i‡(
block_rsv
->
ª£rved
 >
num_byãs
)

256 
ªt
 = 0;

258 
num_byãs
 -
block_rsv
->
ª£rved
;

259 
	`•ö_u∆ock
(&
block_rsv
->
lock
);

261 i‡(!
ªt
)

264 
ªt
 = 
	`båfs_ª£rve_mëad©a_byãs
(
fs_öfo
, 
block_rsv
, 
num_byãs
, 
Êush
);

265 i‡(!
ªt
) {

266 
	`båfs_block_rsv_add_byãs
(
block_rsv
, 
num_byãs
, 
Ál£
);

270  
ªt
;

271 
	}
}

273 
u64
 
	$båfs_block_rsv_ªÀa£
(
båfs_fs_öfo
 *
fs_öfo
,

274 
båfs_block_rsv
 *
block_rsv
, 
u64
 
num_byãs
,

275 
u64
 *
qgroup_to_ªÀa£
)

277 
båfs_block_rsv
 *
globÆ_rsv
 = &
fs_öfo
->
globÆ_block_rsv
;

278 
båfs_block_rsv
 *
dñayed_rsv
 = &
fs_öfo
->
dñayed_ªfs_rsv
;

279 
båfs_block_rsv
 *
èrgë
 = 
NULL
;

285 i‡(
block_rsv
 =
dñayed_rsv
)

286 
èrgë
 = 
globÆ_rsv
;

287 i‡(
block_rsv
 !
globÆ_rsv
 && !
	`båfs_block_rsv_fuŒ
(
dñayed_rsv
))

288 
èrgë
 = 
dñayed_rsv
;

290 i‡(
èrgë
 && 
block_rsv
->
•a˚_öfo
 !=Åarget->space_info)

291 
èrgë
 = 
NULL
;

293  
	`block_rsv_ªÀa£_byãs
(
fs_öfo
, 
block_rsv
, 
èrgë
, 
num_byãs
,

294 
qgroup_to_ªÀa£
);

295 
	}
}

297 
	$båfs_block_rsv_u£_byãs
(
båfs_block_rsv
 *
block_rsv
, 
u64
 
num_byãs
)

299 
ªt
 = -
ENOSPC
;

301 
	`•ö_lock
(&
block_rsv
->
lock
);

302 i‡(
block_rsv
->
ª£rved
 >
num_byãs
) {

303 
block_rsv
->
ª£rved
 -
num_byãs
;

304 i‡(
block_rsv
->
ª£rved
 < block_rsv->
size
)

305 
block_rsv
->
fuŒ
 = 
Ál£
;

306 
ªt
 = 0;

308 
	`•ö_u∆ock
(&
block_rsv
->
lock
);

309  
ªt
;

310 
	}
}

312 
	$båfs_block_rsv_add_byãs
(
båfs_block_rsv
 *
block_rsv
,

313 
u64
 
num_byãs
, 
boﬁ
 
upd©e_size
)

315 
	`•ö_lock
(&
block_rsv
->
lock
);

316 
block_rsv
->
ª£rved
 +
num_byãs
;

317 i‡(
upd©e_size
)

318 
block_rsv
->
size
 +
num_byãs
;

319 i‡(
block_rsv
->
ª£rved
 >block_rsv->
size
)

320 
block_rsv
->
fuŒ
 = 
åue
;

321 
	`•ö_u∆ock
(&
block_rsv
->
lock
);

322 
	}
}

324 
	$båfs_upd©e_globÆ_block_rsv
(
båfs_fs_öfo
 *
fs_öfo
)

326 
båfs_block_rsv
 *
block_rsv
 = &
fs_öfo
->
globÆ_block_rsv
;

327 
båfs_•a˚_öfo
 *
söfo
 = 
block_rsv
->
•a˚_öfo
;

328 
båfs_roŸ
 *
roŸ
, *
tmp
;

329 
u64
 
num_byãs
 = 
	`båfs_roŸ_u£d
(&
fs_öfo
->
åì_roŸ
->
roŸ_ôem
);

330 
mö_ôems
 = 1;

340 
	`ªad_lock
(&
fs_öfo
->
globÆ_roŸ_lock
);

341 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
roŸ
, 
tmp
, &
fs_öfo
->
globÆ_roŸ_åì
,

342 
rb_node
) {

343 i‡(
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_EXTENT_TREE_OBJECTID
 ||

344 
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_CSUM_TREE_OBJECTID
 ||

345 
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_FREE_SPACE_TREE_OBJECTID
) {

346 
num_byãs
 +
	`båfs_roŸ_u£d
(&
roŸ
->
roŸ_ôem
);

347 
mö_ôems
++;

350 
	`ªad_u∆ock
(&
fs_öfo
->
globÆ_roŸ_lock
);

352 i‡(
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
BLOCK_GROUP_TREE
)) {

353 
num_byãs
 +
	`båfs_roŸ_u£d
(&
fs_öfo
->
block_group_roŸ
->
roŸ_ôem
);

354 
mö_ôems
++;

366 
mö_ôems
 +
BTRFS_UNLINK_METADATA_UNITS
;

368 
num_byãs
 = 
	`max_t
(
u64
,Çum_bytes,

369 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
, 
mö_ôems
) +

370 
	`båfs_ˇlc_dñayed_ªf_byãs
(
fs_öfo
,

371 
BTRFS_UNLINK_METADATA_UNITS
));

373 
	`•ö_lock
(&
söfo
->
lock
);

374 
	`•ö_lock
(&
block_rsv
->
lock
);

376 
block_rsv
->
size
 = 
	`mö_t
(
u64
, 
num_byãs
, 
SZ_512M
);

378 i‡(
block_rsv
->
ª£rved
 < block_rsv->
size
) {

379 
num_byãs
 = 
block_rsv
->
size
 - block_rsv->
ª£rved
;

380 
	`båfs_•a˚_öfo_upd©e_byãs_may_u£
(
fs_öfo
, 
söfo
,

381 
num_byãs
);

382 
block_rsv
->
ª£rved
 = block_rsv->
size
;

383 } i‡(
block_rsv
->
ª£rved
 > block_rsv->
size
) {

384 
num_byãs
 = 
block_rsv
->
ª£rved
 - block_rsv->
size
;

385 
	`båfs_•a˚_öfo_upd©e_byãs_may_u£
(
fs_öfo
, 
söfo
,

386 -
num_byãs
);

387 
block_rsv
->
ª£rved
 = block_rsv->
size
;

388 
	`båfs_åy_gø¡ög_tickës
(
fs_öfo
, 
söfo
);

391 
block_rsv
->
fuŒ
 = (block_rsv->
ª£rved
 =block_rsv->
size
);

393 i‡(
block_rsv
->
size
 >
söfo
->
tŸÆ_byãs
)

394 
söfo
->
f‹˚_Æloc
 = 
CHUNK_ALLOC_FORCE
;

395 
	`•ö_u∆ock
(&
block_rsv
->
lock
);

396 
	`•ö_u∆ock
(&
söfo
->
lock
);

397 
	}
}

399 
	$båfs_öô_roŸ_block_rsv
(
båfs_roŸ
 *
roŸ
)

401 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

403 
roŸ
->
roŸ_key
.
obje˘id
) {

404 
BTRFS_CSUM_TREE_OBJECTID
:

405 
BTRFS_EXTENT_TREE_OBJECTID
:

406 
BTRFS_FREE_SPACE_TREE_OBJECTID
:

407 
BTRFS_BLOCK_GROUP_TREE_OBJECTID
:

408 
roŸ
->
block_rsv
 = &
fs_öfo
->
dñayed_ªfs_rsv
;

410 
BTRFS_ROOT_TREE_OBJECTID
:

411 
BTRFS_DEV_TREE_OBJECTID
:

412 
BTRFS_QUOTA_TREE_OBJECTID
:

413 
roŸ
->
block_rsv
 = &
fs_öfo
->
globÆ_block_rsv
;

415 
BTRFS_CHUNK_TREE_OBJECTID
:

416 
roŸ
->
block_rsv
 = &
fs_öfo
->
chunk_block_rsv
;

419 
roŸ
->
block_rsv
 = 
NULL
;

422 
	}
}

424 
	$båfs_öô_globÆ_block_rsv
(
båfs_fs_öfo
 *
fs_öfo
)

426 
båfs_•a˚_öfo
 *
•a˚_öfo
;

428 
•a˚_öfo
 = 
	`båfs_föd_•a˚_öfo
(
fs_öfo
, 
BTRFS_BLOCK_GROUP_SYSTEM
);

429 
fs_öfo
->
chunk_block_rsv
.
•a˚_öfo
 = space_info;

431 
•a˚_öfo
 = 
	`båfs_föd_•a˚_öfo
(
fs_öfo
, 
BTRFS_BLOCK_GROUP_METADATA
);

432 
fs_öfo
->
globÆ_block_rsv
.
•a˚_öfo
 = space_info;

433 
fs_öfo
->
å™s_block_rsv
.
•a˚_öfo
 = space_info;

434 
fs_öfo
->
em±y_block_rsv
.
•a˚_öfo
 = space_info;

435 
fs_öfo
->
dñayed_block_rsv
.
•a˚_öfo
 = space_info;

436 
fs_öfo
->
dñayed_ªfs_rsv
.
•a˚_öfo
 = space_info;

438 
	`båfs_upd©e_globÆ_block_rsv
(
fs_öfo
);

439 
	}
}

441 
	$båfs_ªÀa£_globÆ_block_rsv
(
båfs_fs_öfo
 *
fs_öfo
)

443 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, &fs_öfo->
globÆ_block_rsv
, (
u64
)-1,

444 
NULL
);

445 
	`WARN_ON
(
fs_öfo
->
å™s_block_rsv
.
size
 > 0);

446 
	`WARN_ON
(
fs_öfo
->
å™s_block_rsv
.
ª£rved
 > 0);

447 
	`WARN_ON
(
fs_öfo
->
chunk_block_rsv
.
size
 > 0);

448 
	`WARN_ON
(
fs_öfo
->
chunk_block_rsv
.
ª£rved
 > 0);

449 
	`WARN_ON
(
fs_öfo
->
dñayed_block_rsv
.
size
 > 0);

450 
	`WARN_ON
(
fs_öfo
->
dñayed_block_rsv
.
ª£rved
 > 0);

451 
	`WARN_ON
(
fs_öfo
->
dñayed_ªfs_rsv
.
ª£rved
 > 0);

452 
	`WARN_ON
(
fs_öfo
->
dñayed_ªfs_rsv
.
size
 > 0);

453 
	}
}

455 
båfs_block_rsv
 *
	$gë_block_rsv
(

456 c⁄° 
båfs_å™s_h™dÀ
 *
å™s
,

457 c⁄° 
båfs_roŸ
 *
roŸ
)

459 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

460 
båfs_block_rsv
 *
block_rsv
 = 
NULL
;

462 i‡(
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
) ||

463 (
roŸ
 =
fs_öfo
->
uuid_roŸ
) ||

464 (
å™s
->
addög_csums
 &&

465 
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_CSUM_TREE_OBJECTID
))

466 
block_rsv
 = 
å™s
->block_rsv;

468 i‡(!
block_rsv
)

469 
block_rsv
 = 
roŸ
->block_rsv;

471 i‡(!
block_rsv
)

472 
block_rsv
 = &
fs_öfo
->
em±y_block_rsv
;

474  
block_rsv
;

475 
	}
}

477 
båfs_block_rsv
 *
	$båfs_u£_block_rsv
(
båfs_å™s_h™dÀ
 *
å™s
,

478 
båfs_roŸ
 *
roŸ
,

479 
u32
 
blocksize
)

481 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

482 
båfs_block_rsv
 *
block_rsv
;

483 
båfs_block_rsv
 *
globÆ_rsv
 = &
fs_öfo
->
globÆ_block_rsv
;

484 
ªt
;

485 
boﬁ
 
globÆ_upd©ed
 = 
Ál£
;

487 
block_rsv
 = 
	`gë_block_rsv
(
å™s
, 
roŸ
);

489 i‡(
	`u∆ikñy
(
block_rsv
->
size
 == 0))

490 
åy_ª£rve
;

491 
agaö
:

492 
ªt
 = 
	`båfs_block_rsv_u£_byãs
(
block_rsv
, 
blocksize
);

493 i‡(!
ªt
)

494  
block_rsv
;

496 i‡(
block_rsv
->
ÁûÁ°
)

497  
	`ERR_PTR
(
ªt
);

499 i‡(
block_rsv
->
ty≥
 =
BTRFS_BLOCK_RSV_GLOBAL
 && !
globÆ_upd©ed
) {

500 
globÆ_upd©ed
 = 
åue
;

501 
	`båfs_upd©e_globÆ_block_rsv
(
fs_öfo
);

502 
agaö
;

509 i‡(
block_rsv
->
ty≥
 !
BTRFS_BLOCK_RSV_DELREFS
 &&

510 
	`båfs_ã°_›t
(
fs_öfo
, 
ENOSPC_DEBUG
)) {

511 
	`DEFINE_RATELIMIT_STATE
(
_rs
,

512 
DEFAULT_RATELIMIT_INTERVAL
 * 10,

514 i‡(
	`__øãlimô
(&
_rs
))

515 
	`WARN
(1, 
KERN_DEBUG


517 
block_rsv
->
ty≥
, 
ªt
);

519 
åy_ª£rve
:

520 
ªt
 = 
	`båfs_ª£rve_mëad©a_byãs
(
fs_öfo
, 
block_rsv
, 
blocksize
,

521 
BTRFS_RESERVE_NO_FLUSH
);

522 i‡(!
ªt
)

523  
block_rsv
;

529 i‡(
block_rsv
->
ty≥
 !
BTRFS_BLOCK_RSV_GLOBAL
 &&

530 
block_rsv
->
•a˚_öfo
 =
globÆ_rsv
->space_info) {

531 
ªt
 = 
	`båfs_block_rsv_u£_byãs
(
globÆ_rsv
, 
blocksize
);

532 i‡(!
ªt
)

533  
globÆ_rsv
;

542 
ªt
 = 
	`båfs_ª£rve_mëad©a_byãs
(
fs_öfo
, 
block_rsv
, 
blocksize
,

543 
BTRFS_RESERVE_FLUSH_EMERGENCY
);

544 i‡(!
ªt
)

545  
block_rsv
;

547  
	`ERR_PTR
(
ªt
);

548 
	}
}

550 
	$båfs_check_åunc_ˇche_‰ì_•a˚
(
båfs_fs_öfo
 *
fs_öfo
,

551 
båfs_block_rsv
 *
rsv
)

553 
u64
 
√eded_byãs
;

554 
ªt
;

557 
√eded_byãs
 = 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
, 1) +

558 
	`båfs_ˇlc_mëad©a_size
(
fs_öfo
, 1);

560 
	`•ö_lock
(&
rsv
->
lock
);

561 i‡(
rsv
->
ª£rved
 < 
√eded_byãs
)

562 
ªt
 = -
ENOSPC
;

564 
ªt
 = 0;

565 
	`•ö_u∆ock
(&
rsv
->
lock
);

566  
ªt
;

567 
	}
}

	@block-rsv.h

3 #i‚de‡
BTRFS_BLOCK_RSV_H


4 
	#BTRFS_BLOCK_RSV_H


	)

6 
	gbåfs_å™s_h™dÀ
;

7 
	gbåfs_roŸ
;

8 
	gbåfs_ª£rve_Êush_íum
;

13 
	ebåfs_rsv_ty≥
 {

14 
	mBTRFS_BLOCK_RSV_GLOBAL
,

15 
	mBTRFS_BLOCK_RSV_DELALLOC
,

16 
	mBTRFS_BLOCK_RSV_TRANS
,

17 
	mBTRFS_BLOCK_RSV_CHUNK
,

18 
	mBTRFS_BLOCK_RSV_DELOPS
,

19 
	mBTRFS_BLOCK_RSV_DELREFS
,

20 
	mBTRFS_BLOCK_RSV_EMPTY
,

21 
	mBTRFS_BLOCK_RSV_TEMP
,

24 
	sbåfs_block_rsv
 {

25 
u64
 
	msize
;

26 
u64
 
	mª£rved
;

27 
båfs_•a˚_öfo
 *
	m•a˚_öfo
;

28 
•ölock_t
 
	mlock
;

29 
boﬁ
 
	mfuŒ
;

30 
boﬁ
 
	mÁûÁ°
;

32 
båfs_rsv_ty≥
 
	mty≥
:8;

50 
u64
 
	mqgroup_rsv_size
;

51 
u64
 
	mqgroup_rsv_ª£rved
;

54 
båfs_öô_block_rsv
(
båfs_block_rsv
 *
rsv
, 
båfs_rsv_ty≥
 
ty≥
);

55 
båfs_öô_roŸ_block_rsv
(
båfs_roŸ
 *
roŸ
);

56 
båfs_block_rsv
 *
båfs_Æloc_block_rsv
(
båfs_fs_öfo
 *
fs_öfo
,

57 
båfs_rsv_ty≥
 
ty≥
);

58 
båfs_öô_mëad©a_block_rsv
(
båfs_fs_öfo
 *
fs_öfo
,

59 
båfs_block_rsv
 *
rsv
,

60 
båfs_rsv_ty≥
 
ty≥
);

61 
båfs_‰ì_block_rsv
(
båfs_fs_öfo
 *
fs_öfo
,

62 
båfs_block_rsv
 *
rsv
);

63 
båfs_block_rsv_add
(
båfs_fs_öfo
 *
fs_öfo
,

64 
båfs_block_rsv
 *
block_rsv
, 
u64
 
num_byãs
,

65 
båfs_ª£rve_Êush_íum
 
Êush
);

66 
båfs_block_rsv_check
(
båfs_block_rsv
 *
block_rsv
, 
mö_≥r˚¡
);

67 
båfs_block_rsv_ªfûl
(
båfs_fs_öfo
 *
fs_öfo
,

68 
båfs_block_rsv
 *
block_rsv
, 
u64
 
num_byãs
,

69 
båfs_ª£rve_Êush_íum
 
Êush
);

70 
båfs_block_rsv_migøã
(
båfs_block_rsv
 *
§c_rsv
,

71 
båfs_block_rsv
 *
d°_rsv
, 
u64
 
num_byãs
,

72 
boﬁ
 
upd©e_size
);

73 
båfs_block_rsv_u£_byãs
(
båfs_block_rsv
 *
block_rsv
, 
u64
 
num_byãs
);

74 
båfs_block_rsv_add_byãs
(
båfs_block_rsv
 *
block_rsv
,

75 
u64
 
num_byãs
, 
boﬁ
 
upd©e_size
);

76 
u64
 
båfs_block_rsv_ªÀa£
(
båfs_fs_öfo
 *
fs_öfo
,

77 
båfs_block_rsv
 *
block_rsv
,

78 
u64
 
num_byãs
, u64 *
qgroup_to_ªÀa£
);

79 
båfs_upd©e_globÆ_block_rsv
(
båfs_fs_öfo
 *
fs_öfo
);

80 
båfs_öô_globÆ_block_rsv
(
båfs_fs_öfo
 *
fs_öfo
);

81 
båfs_ªÀa£_globÆ_block_rsv
(
båfs_fs_öfo
 *
fs_öfo
);

82 
båfs_block_rsv
 *
båfs_u£_block_rsv
(
båfs_å™s_h™dÀ
 *
å™s
,

83 
båfs_roŸ
 *
roŸ
,

84 
u32
 
blocksize
);

85 
båfs_check_åunc_ˇche_‰ì_•a˚
(
båfs_fs_öfo
 *
fs_öfo
,

86 
båfs_block_rsv
 *
rsv
);

87 
ölöe
 
	$båfs_unu£_block_rsv
(
båfs_fs_öfo
 *
fs_öfo
,

88 
båfs_block_rsv
 *
block_rsv
,

89 
u32
 
blocksize
)

91 
	`båfs_block_rsv_add_byãs
(
block_rsv
, 
blocksize
, 
Ál£
);

92 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, 
block_rsv
, 0, 
NULL
);

93 
	}
}

99 
ölöe
 
boﬁ
 
	$båfs_block_rsv_fuŒ
(c⁄° 
båfs_block_rsv
 *
rsv
)

101  
	`d©a_ø˚
(
rsv
->
fuŒ
);

102 
	}
}

	@btrfs.mod.c

1 
	~<löux/moduÀ.h
>

2 
	#INCLUDE_VERMAGIC


	)

3 
	~<löux/buûd-ß….h
>

4 
	~<löux/ñ‚Ÿe-…o.h
>

5 
	~<löux/exp‹t-öã∫Æ.h
>

6 
	~<löux/vîmagic.h
>

7 
	~<löux/compûî.h
>

9 #ifde‡
CONFIG_UNWINDER_ORC


10 
	~<asm/‹c_hódî.h
>

11 
	gORC_HEADER
;

14 
	gBUILD_SALT
;

15 
	gBUILD_LTO_INFO
;

17 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

18 
MODULE_INFO
(
«me
, 
KBUILD_MODNAME
);

20 
__visibÀ
 
moduÀ
 
__this_moduÀ


21 
__£˘i⁄
(".gnu.linkonce.this_module") = {

22 .
«me
 = 
KBUILD_MODNAME
,

23 .
	göô
 = 
öô_moduÀ
,

24 #ifde‡
CONFIG_MODULE_UNLOAD


25 .
	gexô
 = 
˛ónup_moduÀ
,

27 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

30 #ifde‡
CONFIG_RETPOLINE


31 
MODULE_INFO
(
ªçﬁöe
, "Y");

36 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

37 
__u£d
 
__£˘i⁄
("__versions") = {

640 
MODULE_INFO
(
dïíds
, "xor,raid6_pq,libcrc32c");

643 
MODULE_INFO
(
§cvîsi⁄
, "9C150C4FEEF4E80D67EC478");

	@btrfs_inode.h

6 #i‚de‡
BTRFS_INODE_H


7 
	#BTRFS_INODE_H


	)

9 
	~<löux/hash.h
>

10 
	~<löux/ªfcou¡.h
>

11 
	~"exã¡_m≠.h
"

12 
	~"exã¡_io.h
"

13 
	~"‹dîed-d©a.h
"

14 
	~"dñayed-öode.h
"

21 
	#BTRFS_DIR_START_INDEX
 2

	)

31 
	mBTRFS_INODE_FLUSH_ON_CLOSE
,

32 
	mBTRFS_INODE_DUMMY
,

33 
	mBTRFS_INODE_IN_DEFRAG
,

34 
	mBTRFS_INODE_HAS_ASYNC_EXTENT
,

40 
	mBTRFS_INODE_NEEDS_FULL_SYNC
,

41 
	mBTRFS_INODE_COPY_EVERYTHING
,

42 
	mBTRFS_INODE_IN_DELALLOC_LIST
,

43 
	mBTRFS_INODE_HAS_PROPS
,

44 
	mBTRFS_INODE_SNAPSHOT_FLUSH
,

51 
	mBTRFS_INODE_NO_XATTRS
,

60 
	mBTRFS_INODE_NO_DELALLOC_FLUSH
,

67 
	mBTRFS_INODE_VERITY_IN_PROGRESS
,

69 
	mBTRFS_INODE_FREE_SPACE_INODE
,

73 
	sbåfs_öode
 {

75 
båfs_roŸ
 *
	mroŸ
;

80 
båfs_key
 
	mloˇti⁄
;

88 
•ölock_t
 
	mlock
;

91 
exã¡_m≠_åì
 
	mexã¡_åì
;

94 
exã¡_io_åì
 
	mio_åì
;

100 
exã¡_io_åì
 
	mfûe_exã¡_åì
;

103 
muãx
 
	mlog_muãx
;

106 
båfs_‹dîed_öode_åì
 
	m‹dîed_åì
;

112 
li°_hód
 
	mdñÆloc_öodes
;

115 
rb_node
 
	mrb_node
;

117 
	mru¡ime_Êags
;

122 
u64
 
	mgíî©i⁄
;

127 
u64
 
	mœ°_å™s
;

132 
u64
 
	mlogged_å™s
;

137 
	mœ°_sub_å™s
;

140 
	mœ°_log_commô
;

148 
u64
 
	mdñÆloc_byãs
;

156 
u64
 
	mfú°_dú_ödex_to_log
;

166 
u64
 
	m√w_dñÆloc_byãs
;

171 
u64
 
	mœ°_dú_ödex_off£t
;

178 
u64
 
	mde‰ag_byãs
;

185 
u64
 
	mdisk_i_size
;

192 
u64
 
	mödex_˙t
;

195 
u64
 
	mdú_ödex
;

202 
u64
 
	mœ°_u∆ök_å™s
;

213 
u64
 
	mœ°_ªÊök_å™s
;

219 
u64
 
	mcsum_byãs
;

222 
u32
 
	mÊags
;

224 
u32
 
	mro_Êags
;

232 
	mout°™dög_exã¡s
;

234 
båfs_block_rsv
 
	mblock_rsv
;

239 
	m¥›_com¥ess
;

244 
	mde‰ag_com¥ess
;

246 
båfs_dñayed_node
 *
	mdñayed_node
;

249 
time•ec64
 
	mi_Ÿime
;

252 
li°_hód
 
	mdñayed_ùut
;

254 
rw_£m≠h‹e
 
	mi_mm≠_lock
;

255 
öode
 
	mvfs_öode
;

258 
ölöe
 
u64
 
	$båfs_gë_fú°_dú_ödex_to_log
(c⁄° 
båfs_öode
 *
öode
)

260  
	`READ_ONCE
(
öode
->
fú°_dú_ödex_to_log
);

261 
	}
}

263 
ölöe
 
	$båfs_£t_fú°_dú_ödex_to_log
(
båfs_öode
 *
öode
,

264 
u64
 
ödex
)

266 
	`WRITE_ONCE
(
öode
->
fú°_dú_ödex_to_log
, 
ödex
);

267 
	}
}

269 
ölöe
 
båfs_öode
 *
	$BTRFS_I
(c⁄° 
öode
 *inode)

271  
	`c⁄èöî_of
(
öode
, 
båfs_öode
, 
vfs_öode
);

272 
	}
}

274 
ölöe
 
	$båfs_öode_hash
(
u64
 
obje˘id
,

275 c⁄° 
båfs_roŸ
 *
roŸ
)

277 
u64
 
h
 = 
obje˘id
 ^ (
roŸ
->
roŸ_key
.obje˘id * 
GOLDEN_RATIO_PRIME
);

279 #i‡
BITS_PER_LONG
 == 32

280 
h
 = (h >> 32) ^ (h & 0xffffffff);

283  ()
h
;

284 
	}
}

286 #i‡
BITS_PER_LONG
 == 32

292 
ölöe
 
u64
 
	$båfs_öo
(c⁄° 
båfs_öode
 *
öode
)

294 
u64
 
öo
 = 
öode
->
loˇti⁄
.
obje˘id
;

297 i‡(
öode
->
loˇti⁄
.
ty≥
 =
BTRFS_ROOT_ITEM_KEY
)

298 
öo
 = 
öode
->
vfs_öode
.
i_öo
;

299  
öo
;

300 
	}
}

304 
ölöe
 
u64
 
	$båfs_öo
(c⁄° 
båfs_öode
 *
öode
)

306  
öode
->
vfs_öode
.
i_öo
;

307 
	}
}

311 
ölöe
 
	$båfs_i_size_wrôe
(
båfs_öode
 *
öode
, 
u64
 
size
)

313 
	`i_size_wrôe
(&
öode
->
vfs_öode
, 
size
);

314 
öode
->
disk_i_size
 = 
size
;

315 
	}
}

317 
ölöe
 
boﬁ
 
	$båfs_is_‰ì_•a˚_öode
(
båfs_öode
 *
öode
)

319  
	`ã°_bô
(
BTRFS_INODE_FREE_SPACE_INODE
, &
öode
->
ru¡ime_Êags
);

320 
	}
}

322 
ölöe
 
boﬁ
 
	$is_d©a_öode
(
öode
 *inode)

324  
	`båfs_öo
(
	`BTRFS_I
(
öode
)Ë!
BTRFS_BTREE_INODE_OBJECTID
;

325 
	}
}

327 
ölöe
 
	$båfs_mod_out°™dög_exã¡s
(
båfs_öode
 *
öode
,

328 
mod
)

330 
	`lockdï_as£π_hñd
(&
öode
->
lock
);

331 
öode
->
out°™dög_exã¡s
 +
mod
;

332 i‡(
	`båfs_is_‰ì_•a˚_öode
(
öode
))

334 
	`åa˚_båfs_öode_mod_out°™dög_exã¡s
(
öode
->
roŸ
, 
	`båfs_öo
(inode),

335 
mod
, 
öode
->
out°™dög_exã¡s
);

336 
	}
}

346 
ölöe
 
	$båfs_£t_öode_œ°_sub_å™s
(
båfs_öode
 *
öode
)

348 
	`•ö_lock
(&
öode
->
lock
);

349 
öode
->
œ°_sub_å™s
 = inode->
roŸ
->
log_å™sid
;

350 
	`•ö_u∆ock
(&
öode
->
lock
);

351 
	}
}

358 
ölöe
 
	$båfs_£t_öode_fuŒ_sync
(
båfs_öode
 *
öode
)

360 
	`£t_bô
(
BTRFS_INODE_NEEDS_FULL_SYNC
, &
öode
->
ru¡ime_Êags
);

377 
	`•ö_lock
(&
öode
->
lock
);

378 i‡(
öode
->
œ°_ªÊök_å™s
 < inode->
œ°_å™s
)

379 
öode
->
œ°_ªÊök_å™s
 = inode->
œ°_å™s
;

380 
	`•ö_u∆ock
(&
öode
->
lock
);

381 
	}
}

383 
ölöe
 
boﬁ
 
	$båfs_öode_ö_log
(
båfs_öode
 *
öode
, 
u64
 
gíî©i⁄
)

385 
boﬁ
 
ªt
 = 
Ál£
;

387 
	`•ö_lock
(&
öode
->
lock
);

388 i‡(
öode
->
logged_å™s
 =
gíî©i⁄
 &&

389 
öode
->
œ°_sub_å™s
 <öode->
œ°_log_commô
 &&

390 
öode
->
œ°_sub_å™s
 <öode->
roŸ
->
œ°_log_commô
)

391 
ªt
 = 
åue
;

392 
	`•ö_u∆ock
(&
öode
->
lock
);

393  
ªt
;

394 
	}
}

399 
ölöe
 
boﬁ
 
	$båfs_öode_ˇn_com¥ess
(c⁄° 
båfs_öode
 *
öode
)

401 i‡(
öode
->
Êags
 & 
BTRFS_INODE_NODATACOW
 ||

402 
öode
->
Êags
 & 
BTRFS_INODE_NODATASUM
)

403  
Ál£
;

404  
åue
;

405 
	}
}

408 
	#CSUM_FMT
 "0x%*phN"

	)

409 
	#CSUM_FMT_VALUE
(
size
, 
byãs
Ësize, 
	)
bytes

411 
båfs_check_£˘‹_csum
(
båfs_fs_öfo
 *
fs_öfo
, 
∑ge
 *page,

412 
u32
 
pgoff
, 
u8
 *
csum
, c⁄° u8 * c⁄° 
csum_ex≥˘ed
);

413 
boﬁ
 
båfs_d©a_csum_ok
(
båfs_bio
 *
bbio
, 
båfs_devi˚
 *
dev
,

414 
u32
 
bio_off£t
, 
bio_vec
 *
bv
);

415 
noölöe
 
ˇn_nocow_exã¡
(
öode
 *öode, 
u64
 
off£t
, u64 *
Àn
,

416 
u64
 *
‹ig_°¨t
, u64 *
‹ig_block_Àn
,

417 
u64
 *
øm_byãs
, 
boﬁ
 
nowaô
, boﬁ 
°ri˘
);

419 
__båfs_dñ_dñÆloc_öode
(
båfs_roŸ
 *
roŸ
, 
båfs_öode
 *
öode
);

420 
öode
 *
båfs_lookup_díåy
(öodê*
dú
, 
díåy
 *dentry);

421 
båfs_£t_öode_ödex
(
båfs_öode
 *
dú
, 
u64
 *
ödex
);

422 
båfs_u∆ök_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

423 
båfs_öode
 *
dú
, båfs_öodê*
öode
,

424 c⁄° 
fs¸y±_°r
 *
«me
);

425 
båfs_add_lök
(
båfs_å™s_h™dÀ
 *
å™s
,

426 
båfs_öode
 *
∑ª¡_öode
, båfs_öodê*
öode
,

427 c⁄° 
fs¸y±_°r
 *
«me
, 
add_backªf
, 
u64
 
ödex
);

428 
båfs_dñëe_subvﬁume
(
båfs_öode
 *
dú
, 
díåy
 *dentry);

429 
båfs_åunˇã_block
(
båfs_öode
 *
öode
, 
loff_t
 
‰om
,Üoff_à
Àn
,

430 
‰⁄t
);

432 
båfs_°¨t_dñÆloc_¢≠shŸ
(
båfs_roŸ
 *
roŸ
, 
boﬁ
 
ö_ª˛aim_c⁄ãxt
);

433 
båfs_°¨t_dñÆloc_roŸs
(
båfs_fs_öfo
 *
fs_öfo
, 
ƒ
,

434 
boﬁ
 
ö_ª˛aim_c⁄ãxt
);

435 
båfs_£t_exã¡_dñÆloc
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
,

436 
exåa_bôs
,

437 
exã¡_°©e
 **
ˇched_°©e
);

439 
	sbåfs_√w_öode_¨gs
 {

441 
öode
 *
	mdú
;

443 
	mhas_loˇl_dú
;

444 
öode
 *
	mloˇl_dú
;

445 
öode
 *
	mloˇl_öode
;

446 
díåy
 *
	mdíåy
;

447 
öode
 *
	möode
;

448 
boﬁ
 
	m‹ph™
;

449 
boﬁ
 
	msubvﬁ
;

452 
posix_a˛
 *
	mdeÁu…_a˛
;

453 
posix_a˛
 *
	ma˛
;

454 
fs¸y±_«me
 
	m‚ame
;

457 
båfs_√w_öode_¥ï¨e
(
båfs_√w_öode_¨gs
 *
¨gs
,

458 *
å™s_num_ôems
);

459 
båfs_¸óã_√w_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

460 
båfs_√w_öode_¨gs
 *
¨gs
);

461 
båfs_√w_öode_¨gs_de°roy
(
båfs_√w_öode_¨gs
 *
¨gs
);

462 
öode
 *
båfs_√w_subvﬁ_öode
(
m¡_idm≠
 *
idm≠
,

463 
öode
 *
dú
);

464 
båfs_£t_dñÆloc_exã¡
(
båfs_öode
 *
öode
, 
exã¡_°©e
 *
°©e
,

465 
u32
 
bôs
);

466 
båfs_˛ór_dñÆloc_exã¡
(
båfs_öode
 *
öode
,

467 
exã¡_°©e
 *
°©e
, 
u32
 
bôs
);

468 
båfs_mîge_dñÆloc_exã¡
(
båfs_öode
 *
öode
, 
exã¡_°©e
 *
√w
,

469 
exã¡_°©e
 *
Ÿhî
);

470 
båfs_•lô_dñÆloc_exã¡
(
båfs_öode
 *
öode
,

471 
exã¡_°©e
 *
‹ig
, 
u64
 
•lô
);

472 
båfs_£t_ønge_wrôeback
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
);

473 
vm_Áu…_t
 
båfs_∑ge_mkwrôe
(
vm_Áu…
 *
vmf
);

474 
båfs_evi˘_öode
(
öode
 *inode);

475 
öode
 *
båfs_Æloc_öode
(
su≥r_block
 *
sb
);

476 
båfs_de°roy_öode
(
öode
 *inode);

477 
båfs_‰ì_öode
(
öode
 *inode);

478 
båfs_dr›_öode
(
öode
 *inode);

479 
__öô
 
båfs_öô_ˇchï
();

480 
__cﬁd
 
båfs_de°roy_ˇchï
();

481 
öode
 *
båfs_igë_∑th
(
su≥r_block
 *
s
, 
u64
 
öo
,

482 
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
);

483 
öode
 *
båfs_igë
(
su≥r_block
 *
s
, 
u64
 
öo
, 
båfs_roŸ
 *
roŸ
);

484 
exã¡_m≠
 *
båfs_gë_exã¡
(
båfs_öode
 *
öode
,

485 
∑ge
 *∑ge, 
size_t
 
pg_off£t
,

486 
u64
 
°¨t
, u64 
íd
);

487 
båfs_upd©e_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

488 
båfs_roŸ
 *
roŸ
, 
båfs_öode
 *
öode
);

489 
båfs_upd©e_öode_ÁŒback
(
båfs_å™s_h™dÀ
 *
å™s
,

490 
båfs_roŸ
 *
roŸ
, 
båfs_öode
 *
öode
);

491 
båfs_‹ph™_add
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_öode
 *
öode
);

492 
båfs_‹ph™_˛ónup
(
båfs_roŸ
 *
roŸ
);

493 
båfs_c⁄t_ex∑nd
(
båfs_öode
 *
öode
, 
loff_t
 
ﬁdsize
,Üoff_à
size
);

494 
båfs_add_dñayed_ùut
(
båfs_öode
 *
öode
);

495 
båfs_run_dñayed_ùuts
(
båfs_fs_öfo
 *
fs_öfo
);

496 
båfs_waô_⁄_dñayed_ùuts
(
båfs_fs_öfo
 *
fs_öfo
);

497 
båfs_¥óŒoc_fûe_ønge
(
öode
 *öode, 
mode
,

498 
u64
 
°¨t
, u64 
num_byãs
, u64 
mö_size
,

499 
loff_t
 
a˘uÆ_Àn
, 
u64
 *
Æloc_höt
);

500 
båfs_¥óŒoc_fûe_ønge_å™s
(
öode
 *inode,

501 
båfs_å™s_h™dÀ
 *
å™s
, 
mode
,

502 
u64
 
°¨t
, u64 
num_byãs
, u64 
mö_size
,

503 
loff_t
 
a˘uÆ_Àn
, 
u64
 *
Æloc_höt
);

504 
båfs_run_dñÆloc_ønge
(
båfs_öode
 *
öode
, 
∑ge
 *
locked_∑ge
,

505 
u64
 
°¨t
, u64 
íd
, 
wrôeback_c⁄åﬁ
 *
wbc
);

506 
båfs_wrôïage_cow_fixup
(
∑ge
 *page);

507 
båfs_ícoded_io_com¥essi⁄_‰om_exã¡
(
båfs_fs_öfo
 *
fs_öfo
,

508 
com¥ess_ty≥
);

509 
båfs_ícoded_ªad_ªguœr_fûl_∑ges
(
båfs_öode
 *
öode
,

510 
u64
 
fûe_off£t
, u64 
disk_byãƒ
,

511 
u64
 
disk_io_size
,

512 
∑ge
 **
∑ges
);

513 
ssize_t
 
båfs_ícoded_ªad
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
,

514 
båfs_io˘l_ícoded_io_¨gs
 *
ícoded
);

515 
ssize_t
 
båfs_do_ícoded_wrôe
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
,

516 c⁄° 
båfs_io˘l_ícoded_io_¨gs
 *
ícoded
);

518 
ssize_t
 
båfs_dio_ªad
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
,

519 
size_t
 
d⁄e_bef‹e
);

520 
iom≠_dio
 *
båfs_dio_wrôe
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
,

521 
size_t
 
d⁄e_bef‹e
);

523 c⁄° 
díåy_›î©i⁄s
 
båfs_díåy_›î©i⁄s
;

526 
	ebåfs_ûock_ty≥
 {

527 
ENUM_BIT
(
BTRFS_ILOCK_SHARED
),

528 
ENUM_BIT
(
BTRFS_ILOCK_TRY
),

529 
ENUM_BIT
(
BTRFS_ILOCK_MMAP
),

532 
båfs_öode_lock
(
båfs_öode
 *
öode
, 
ûock_Êags
);

533 
båfs_öode_u∆ock
(
båfs_öode
 *
öode
, 
ûock_Êags
);

534 
båfs_upd©e_öode_byãs
(
båfs_öode
 *
öode
, c⁄° 
u64
 
add_byãs
,

535 c⁄° 
u64
 
dñ_byãs
);

536 
båfs_as£π_öode_ønge_˛ón
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
);

	@calclock/calclock.c

5 
	~"ˇl˛ock.h
"

6 
	~<löux/¶ab.h
>

8 c⁄° *
	$£∑øã
(*
buf
, 
size_t
 
buf_Àn
)

10 *
ªvî£d_buf
;

11 
cur
, 
cou¡î
 = 0, 
rvs_cur
 = 0;

13 
ªvî£d_buf
 = 
	`kmÆloc
(
buf_Àn
, 
GFP_KERNEL
);

14 
cur
 = 
	`°æí
(
buf
);

15 --
cur
; cur > -1; cur--) {

16 i‡(
cou¡î
 == 3) {

17 
ªvî£d_buf
[
rvs_cur
++] = ',';

18 
cou¡î
 = 0;

19 
cur
++;

22 
ªvî£d_buf
[
rvs_cur
++] = 
buf
[
cur
];

23 
cou¡î
++;

26 
cur
 = 0;

27 --
rvs_cur
;Ñvs_cur > -1;Ñvs_cur--)

28 
buf
[
cur
++] = 
ªvî£d_buf
[
rvs_cur
];

30 
	`k‰ì
(
ªvî£d_buf
);

31  
buf
;

32 
	}
}

42 
ölöe
 c⁄° *
	$£p_num
(c⁄° 
uöt64_t
 
num
, *
buf
, 
size_t
 
buf_Àn
)

44 
	`mem£t
(
buf
, 0, 
buf_Àn
);

45 
	`•rötf
(
buf
, "%Œu", 
num
);

46  
	`£∑øã
(
buf
, 
buf_Àn
);

47 
	}
}

57 
ölöe
 c⁄° *
	$£p_n£c
(c⁄° 
ktime_t
 
n£c
, *
buf
, 
size_t
 
buf_Àn
)

59 
	`mem£t
(
buf
, 0, 
buf_Àn
);

60 
	`•rötf
(
buf
, "%Œd", 
n£c
);

61  
	`£∑øã
(
buf
, 
buf_Àn
);

62 
	}
}

64 
	$__kçröt
(
dïth
, *
‚_«me
, 
ktime_t
 
time
,

65 
uöt64_t
 
cou¡
, 
size_t
 
ƒ_thªads
)

67 
buff
[100], 
buff2
[100], 
buff3
[100];

68 
≥r˚¡age
;

69 
ktime_t
 
tŸÆtime
 = 1;

71 i‡(
	`ktime_bef‹e
(
tŸÆtime
, 
time
))

72 
tŸÆtime
 = 
time
;

73 
≥r˚¡age
 = 
time
 * 10000 / 
tŸÆtime
;

75 
	`¥ötk
("%s", "");

76 
dïth
--)

77 
	`¥_c⁄t
(" ");

78 
	`¥_c⁄t
("%s is called %sÅimes,ándÅheÅime interval is %sns "

80 
‚_«me
, 
	`£p_num
(
cou¡
, 
buff
, (buff)),

81 
	`£p_n£c
(
	`ktime_to_ns
(
time
), 
buff2
, (buff2)),

82 
	`£p_n£c
(
	`ktime_to_ns
(
time
Ë/ (
ƒ_thªads
 ? : 1), 
buff3
, (buff3)),

83 
ƒ_thªads
, 
≥r˚¡age
 / 100,Öercentage % 100);

84 
	}
}

	@calclock/calclock.h

7 #i‚de‡
__CALCLOCK_H


8 
	#__CALCLOCK_H


	)

10 
	~<löux/ktime.h
>

11 
	~<löux/≥r˝u.h
>

13 
	#CONFIG_CALCLOCK


	)

15 
	sˇl˛ock
 {

16 
ktime_t
 
	mtime
;

17 
	mcou¡
;

20 
	#KTDEF
(
fun˙ame
) \

21 
	`DEFINE_PER_CPU
(
ˇl˛ock
, 
fun˙ame
##
_˛ock
Ë{0, 0}

	)

22 
	#KTDEC
(
fun˙ame
) \

23 
	`DECLARE_PER_CPU
(
ˇl˛ock
, 
fun˙ame
##
_˛ock
)

	)

25 #ifde‡
CONFIG_CALCLOCK


27 
ölöe
 
	$ktgë
(
ktime_t
 *
˛ock
)

29 *
˛ock
 = 
	`ktime_gë_øw
();

30 
	}
}

32 
ölöe
 
	$__kçut
(
ktime_t
 
loˇl˛ocks
[], 
ˇl˛ock
 *
˛ock
)

34 
ktime_t
 
diff
;

36 
	`WARN_ONCE
(
	`ktime_a·î
(
loˇl˛ocks
[0],Üocalclocks[1]),

38 
diff
 = 
	`ktime_sub
(
loˇl˛ocks
[1],Üocalclocks[0]);

39 
˛ock
->
time
 = 
	`ktime_add_ß„
(˛ock->time, 
diff
);

40 
˛ock
->
cou¡
++;

41 
	}
}

43 
	#kçut
(
loˇl˛ocks
, 
fun˙ame
) \

45 
ˇl˛ock
 *
˛ock
; \

47 
˛ock
 = 
	`gë_˝u_±r
(&(
fun˙ame
##
_˛ock
)); \

48 
	`__kçut
(
loˇl˛ocks
, 
˛ock
); \

49 
	`put_˝u_±r
(&(
fun˙ame
##
_˛ock
)); \

50 } 0)

	)

52 
__kçröt
(
dïth
, *
‚_«me
, 
ktime_t
 
time
,

53 
uöt64_t
 
cou¡
, 
size_t
 
ƒ_thªads
);

55 
	#kçröt
(
dïth
, 
fun˙ame
) \

57 
˝u
; \

58 
ˇl˛ock
 *
˛ock
; \

59 
ktime_t
 
timesum
 = 0; \

60 
uöt64_t
 
cou¡sum
 = 0; \

61 
size_t
 
thªads
 = 0; \

63 
	`f‹_óch_⁄löe_˝u
(
˝u
) { \

64 
˛ock
 = 
	`≥r_˝u_±r
(&
fun˙ame
##
_˛ock
, 
˝u
); \

65 
timesum
 +
˛ock
->
time
; \

66 
cou¡sum
 +
˛ock
->
cou¡
; \

67 
thªads
 +!!
˛ock
->
cou¡
; \

69 
	`__kçröt
(
dïth
, #fun˙ame, 
timesum
, 
cou¡sum
, 
thªads
);\

70 } 0)

	)

73 
	#ktgë
(
˛ock
Ëdÿ{ ()(˛ock); } 0)

	)

74 
	#kçut
(
loˇl˛ock
, 
fun˙ame
Ëdÿ{ } 0)

	)

75 
	#kçröt
(
dïth
, 
fun˙ame
Ëdÿ{ } 0)

	)

	@check-integrity.c

78 
	~<löux/sched.h
>

79 
	~<löux/¶ab.h
>

80 
	~<löux/muãx.h
>

81 
	~<löux/blkdev.h
>

82 
	~<löux/mm.h
>

83 
	~<löux/°rög.h
>

84 
	~<¸y±o/hash.h
>

85 
	~"mesßges.h
"

86 
	~"˘ªe.h
"

87 
	~"disk-io.h
"

88 
	~"å™ß˘i⁄.h
"

89 
	~"exã¡_io.h
"

90 
	~"vﬁumes.h
"

91 
	~"¥öt-åì.h
"

92 
	~"lockög.h
"

93 
	~"check-öãgrôy.h
"

94 
	~"rcu-°rög.h
"

95 
	~"com¥essi⁄.h
"

96 
	~"ac˚ss‹s.h
"

98 
	#BTRFSIC_BLOCK_HASHTABLE_SIZE
 0x10000

	)

99 
	#BTRFSIC_BLOCK_LINK_HASHTABLE_SIZE
 0x10000

	)

100 
	#BTRFSIC_DEV2STATE_HASHTABLE_SIZE
 0x100

	)

101 
	#BTRFSIC_BLOCK_MAGIC_NUMBER
 0x14491051

	)

102 
	#BTRFSIC_BLOCK_LINK_MAGIC_NUMBER
 0x11070807

	)

103 
	#BTRFSIC_DEV2STATE_MAGIC_NUMBER
 0x20111530

	)

104 
	#BTRFSIC_BLOCK_STACK_FRAME_MAGIC_NUMBER
 20111300

	)

105 
	#BTRFSIC_TREE_DUMP_MAX_INDENT_LEVEL
 (200 - 6Ë

	)

107 
	#BTRFSIC_GENERATION_UNKNOWN
 ((
u64
)-1)

	)

113 
	#BTRFSIC_PRINT_MASK_SUPERBLOCK_WRITE
 0x00000001

	)

114 
	#BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
 0x00000002

	)

115 
	#BTRFSIC_PRINT_MASK_TREE_AFTER_SB_WRITE
 0x00000004

	)

116 
	#BTRFSIC_PRINT_MASK_TREE_BEFORE_SB_WRITE
 0x00000008

	)

117 
	#BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH
 0x00000010

	)

118 
	#BTRFSIC_PRINT_MASK_END_IO_BIO_BH
 0x00000020

	)

119 
	#BTRFSIC_PRINT_MASK_VERBOSE
 0x00000040

	)

120 
	#BTRFSIC_PRINT_MASK_VERY_VERBOSE
 0x00000080

	)

121 
	#BTRFSIC_PRINT_MASK_INITIAL_TREE
 0x00000100

	)

122 
	#BTRFSIC_PRINT_MASK_INITIAL_ALL_TREES
 0x00000200

	)

123 
	#BTRFSIC_PRINT_MASK_INITIAL_DATABASE
 0x00000400

	)

124 
	#BTRFSIC_PRINT_MASK_NUM_COPIES
 0x00000800

	)

125 
	#BTRFSIC_PRINT_MASK_TREE_WITH_ALL_MIRRORS
 0x00001000

	)

126 
	#BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH_VERBOSE
 0x00002000

	)

128 
	gbåfsic_dev_°©e
;

129 
	gbåfsic_°©e
;

131 
	sbåfsic_block
 {

132 
u32
 
	mmagic_num
;

133 
	mis_mëad©a
:1;

134 
	mis_su≥rblock
:1;

135 
	mis_iod⁄e
:1;

136 
	miod⁄e_w_îr‹
:1;

137 
	m√vî_wrôãn
:1;

140 
	mmúr‹_num
;

142 
båfsic_dev_°©e
 *
	mdev_°©e
;

143 
u64
 
	mdev_byãƒ
;

144 
u64
 
	mlogiˇl_byãƒ
;

145 
u64
 
	mgíî©i⁄
;

146 
båfs_disk_key
 
	mdisk_key
;

148 
li°_hód
 
	mcﬁlisi⁄_ªsﬁvög_node
;

149 
li°_hód
 
	mÆl_blocks_node
;

152 
li°_hód
 
	mªf_to_li°
;

153 
li°_hód
 
	mªf_‰om_li°
;

154 
båfsic_block
 *
	m√xt_ö_ßme_bio
;

155 *
	m‹ig_bio_¥iv©e
;

156 
bio_íd_io_t
 *
	m‹ig_bio_íd_io
;

157 
blk_›f_t
 
	msubmô_bio_bh_rw
;

158 
u64
 
	mÊush_gí
;

172 
	sbåfsic_block_lök
 {

173 
u32
 
	mmagic_num
;

174 
u32
 
	mªf_˙t
;

175 
li°_hód
 
	mnode_ªf_to
;

176 
li°_hód
 
	mnode_ªf_‰om
;

177 
li°_hód
 
	mcﬁlisi⁄_ªsﬁvög_node
;

178 
båfsic_block
 *
	mblock_ªf_to
;

179 
båfsic_block
 *
	mblock_ªf_‰om
;

180 
u64
 
	m∑ª¡_gíî©i⁄
;

183 
	sbåfsic_dev_°©e
 {

184 
u32
 
	mmagic_num
;

185 
block_devi˚
 *
	mbdev
;

186 
båfsic_°©e
 *
	m°©e
;

187 
li°_hód
 
	mcﬁlisi⁄_ªsﬁvög_node
;

188 
båfsic_block
 
	mdummy_block_f‹_bio_bh_Êush
;

189 
u64
 
	mœ°_Êush_gí
;

192 
	sbåfsic_block_hashèbÀ
 {

193 
li°_hód
 
	mèbÀ
[
BTRFSIC_BLOCK_HASHTABLE_SIZE
];

196 
	sbåfsic_block_lök_hashèbÀ
 {

197 
li°_hód
 
	mèbÀ
[
BTRFSIC_BLOCK_LINK_HASHTABLE_SIZE
];

200 
	sbåfsic_dev_°©e_hashèbÀ
 {

201 
li°_hód
 
	mèbÀ
[
BTRFSIC_DEV2STATE_HASHTABLE_SIZE
];

204 
	sbåfsic_block_d©a_˘x
 {

205 
u64
 
	m°¨t
;

206 
u64
 
	mdev_byãƒ
;

207 
u32
 
	mÀn
;

208 
båfsic_dev_°©e
 *
	mdev
;

209 **
	md©av
;

210 
∑ge
 **
	m∑gev
;

211 *
	mmem_to_‰ì
;

216 
	sbåfsic_°ack_‰ame
 {

217 
u32
 
	mmagic
;

218 
u32
 
	mƒ
;

219 
	mîr‹
;

220 
	mi
;

221 
	mlimô_√°ög
;

222 
	mnum_c›õs
;

223 
	mmúr‹_num
;

224 
båfsic_block
 *
	mblock
;

225 
båfsic_block_d©a_˘x
 *
	mblock_˘x
;

226 
båfsic_block
 *
	m√xt_block
;

227 
båfsic_block_d©a_˘x
 
	m√xt_block_˘x
;

228 
båfs_hódî
 *
	mhdr
;

229 
båfsic_°ack_‰ame
 *
	m¥ev
;

233 
	sbåfsic_°©e
 {

234 
u32
 
	m¥öt_mask
;

235 
	mö˛ude_exã¡_d©a
;

236 
li°_hód
 
	mÆl_blocks_li°
;

237 
båfsic_block_hashèbÀ
 
	mblock_hashèbÀ
;

238 
båfsic_block_lök_hashèbÀ
 
	mblock_lök_hashèbÀ
;

239 
båfs_fs_öfo
 *
	mfs_öfo
;

240 
u64
 
	mmax_su≥rblock_gíî©i⁄
;

241 
båfsic_block
 *
	mœã°_su≥rblock
;

242 
u32
 
	mmëablock_size
;

243 
u32
 
	md©ablock_size
;

246 
båfsic_¥o˚ss_mëablock
(
båfsic_°©e
 *
°©e
,

247 
båfsic_block
 *
block
,

248 
båfsic_block_d©a_˘x
 *
block_˘x
,

249 
limô_√°ög
, 
f‹˚_iod⁄e_Êag
);

250 
båfsic_ªad_‰om_block_d©a
(

251 
båfsic_block_d©a_˘x
 *
block_˘x
,

252 *
d°
, 
u32
 
off£t
, 
size_t
 
Àn
);

253 
båfsic_¸óã_lök_to_√xt_block
(

254 
båfsic_°©e
 *
°©e
,

255 
båfsic_block
 *
block
,

256 
båfsic_block_d©a_˘x


257 *
block_˘x
, 
u64
 
√xt_byãƒ
,

258 
limô_√°ög
,

259 
båfsic_block_d©a_˘x
 *
√xt_block_˘x
,

260 
båfsic_block
 **
√xt_blockp
,

261 
f‹˚_iod⁄e_Êag
,

262 *
num_c›õ•
, *
múr‹_nump
,

263 
båfs_disk_key
 *
disk_key
,

264 
u64
 
∑ª¡_gíî©i⁄
);

265 
båfsic_h™dÀ_exã¡_d©a
(
båfsic_°©e
 *
°©e
,

266 
båfsic_block
 *
block
,

267 
båfsic_block_d©a_˘x
 *
block_˘x
,

268 
u32
 
ôem_off£t
, 
f‹˚_iod⁄e_Êag
);

269 
båfsic_m≠_block
(
båfsic_°©e
 *
°©e
, 
u64
 
byãƒ
, 
u32
 
Àn
,

270 
båfsic_block_d©a_˘x
 *
block_˘x_out
,

271 
múr‹_num
);

272 
båfsic_ªÀa£_block_˘x
(
båfsic_block_d©a_˘x
 *
block_˘x
);

273 
båfsic_ªad_block
(
båfsic_°©e
 *
°©e
,

274 
båfsic_block_d©a_˘x
 *
block_˘x
);

275 
båfsic_¥o˚ss_wrôãn_su≥rblock
(

276 
båfsic_°©e
 *
°©e
,

277 
båfsic_block
 *c⁄° 
block
,

278 
båfs_su≥r_block
 *c⁄° 
su≥r_hdr
);

279 
båfsic_bio_íd_io
(
bio
 *
bp
);

280 
båfsic_is_block_ªf_by_su≥rblock
(c⁄° 
båfsic_°©e
 *
°©e
,

281 c⁄° 
båfsic_block
 *
block
,

282 
ªcursi⁄_Àvñ
);

283 
båfsic_check_Æl_ªf_blocks
(
båfsic_°©e
 *
°©e
,

284 
båfsic_block
 *c⁄° 
block
,

285 
ªcursi⁄_Àvñ
);

286 
båfsic_¥öt_add_lök
(c⁄° 
båfsic_°©e
 *
°©e
,

287 c⁄° 
båfsic_block_lök
 *
l
);

288 
båfsic_¥öt_ªm_lök
(c⁄° 
båfsic_°©e
 *
°©e
,

289 c⁄° 
båfsic_block_lök
 *
l
);

290 
båfsic_gë_block_ty≥
(c⁄° 
båfsic_°©e
 *
°©e
,

291 c⁄° 
båfsic_block
 *
block
);

292 
båfsic_dump_åì
(c⁄° 
båfsic_°©e
 *
°©e
);

293 
båfsic_dump_åì_sub
(c⁄° 
båfsic_°©e
 *
°©e
,

294 c⁄° 
båfsic_block
 *
block
,

295 
ödít_Àvñ
);

296 
båfsic_block_lök
 *
båfsic_block_lök_lookup_‹_add
(

297 
båfsic_°©e
 *
°©e
,

298 
båfsic_block_d©a_˘x
 *
√xt_block_˘x
,

299 
båfsic_block
 *
√xt_block
,

300 
båfsic_block
 *
‰om_block
,

301 
u64
 
∑ª¡_gíî©i⁄
);

302 
båfsic_block
 *
båfsic_block_lookup_‹_add
(

303 
båfsic_°©e
 *
°©e
,

304 
båfsic_block_d©a_˘x
 *
block_˘x
,

305 c⁄° *
addôi⁄Æ_°rög
,

306 
is_mëad©a
,

307 
is_iod⁄e
,

308 
√vî_wrôãn
,

309 
múr‹_num
,

310 *
was_¸óãd
);

311 
båfsic_¥o˚ss_su≥rblock_dev_múr‹
(

312 
båfsic_°©e
 *
°©e
,

313 
båfsic_dev_°©e
 *
dev_°©e
,

314 
båfs_devi˚
 *
devi˚
,

315 
su≥rblock_múr‹_num
,

316 
båfsic_dev_°©e
 **
£À˘ed_dev_°©e
,

317 
båfs_su≥r_block
 *
£À˘ed_su≥r
);

318 
båfsic_dev_°©e
 *
båfsic_dev_°©e_lookup
(
dev_t
 
dev
);

319 
båfsic_cmp_log_™d_dev_byãƒ
(
båfsic_°©e
 *
°©e
,

320 
u64
 
byãƒ
,

321 
båfsic_dev_°©e
 *
dev_°©e
,

322 
u64
 
dev_byãƒ
);

324 
muãx
 
	gbåfsic_muãx
;

325 
	gbåfsic_is_öôülized
;

326 
båfsic_dev_°©e_hashèbÀ
 
	gbåfsic_dev_°©e_hashèbÀ
;

329 
	$båfsic_block_öô
(
båfsic_block
 *
b
)

331 
b
->
magic_num
 = 
BTRFSIC_BLOCK_MAGIC_NUMBER
;

332 
b
->
dev_°©e
 = 
NULL
;

333 
b
->
dev_byãƒ
 = 0;

334 
b
->
logiˇl_byãƒ
 = 0;

335 
b
->
gíî©i⁄
 = 
BTRFSIC_GENERATION_UNKNOWN
;

336 
b
->
disk_key
.
obje˘id
 = 0;

337 
b
->
disk_key
.
ty≥
 = 0;

338 
b
->
disk_key
.
off£t
 = 0;

339 
b
->
is_mëad©a
 = 0;

340 
b
->
is_su≥rblock
 = 0;

341 
b
->
is_iod⁄e
 = 0;

342 
b
->
iod⁄e_w_îr‹
 = 0;

343 
b
->
√vî_wrôãn
 = 0;

344 
b
->
múr‹_num
 = 0;

345 
b
->
√xt_ö_ßme_bio
 = 
NULL
;

346 
b
->
‹ig_bio_¥iv©e
 = 
NULL
;

347 
b
->
‹ig_bio_íd_io
 = 
NULL
;

348 
	`INIT_LIST_HEAD
(&
b
->
cﬁlisi⁄_ªsﬁvög_node
);

349 
	`INIT_LIST_HEAD
(&
b
->
Æl_blocks_node
);

350 
	`INIT_LIST_HEAD
(&
b
->
ªf_to_li°
);

351 
	`INIT_LIST_HEAD
(&
b
->
ªf_‰om_li°
);

352 
b
->
submô_bio_bh_rw
 = 0;

353 
b
->
Êush_gí
 = 0;

354 
	}
}

356 
båfsic_block
 *
	$båfsic_block_Æloc
()

358 
båfsic_block
 *
b
;

360 
b
 = 
	`kzÆloc
((*b), 
GFP_NOFS
);

361 i‡(
NULL
 !
b
)

362 
	`båfsic_block_öô
(
b
);

364  
b
;

365 
	}
}

367 
	$båfsic_block_‰ì
(
båfsic_block
 *
b
)

369 
	`BUG_ON
(!(
NULL
 =
b
 || 
BTRFSIC_BLOCK_MAGIC_NUMBER
 =b->
magic_num
));

370 
	`k‰ì
(
b
);

371 
	}
}

373 
	$båfsic_block_lök_öô
(
båfsic_block_lök
 *
l
)

375 
l
->
magic_num
 = 
BTRFSIC_BLOCK_LINK_MAGIC_NUMBER
;

376 
l
->
ªf_˙t
 = 1;

377 
	`INIT_LIST_HEAD
(&
l
->
node_ªf_to
);

378 
	`INIT_LIST_HEAD
(&
l
->
node_ªf_‰om
);

379 
	`INIT_LIST_HEAD
(&
l
->
cﬁlisi⁄_ªsﬁvög_node
);

380 
l
->
block_ªf_to
 = 
NULL
;

381 
l
->
block_ªf_‰om
 = 
NULL
;

382 
	}
}

384 
båfsic_block_lök
 *
	$båfsic_block_lök_Æloc
()

386 
båfsic_block_lök
 *
l
;

388 
l
 = 
	`kzÆloc
((*l), 
GFP_NOFS
);

389 i‡(
NULL
 !
l
)

390 
	`båfsic_block_lök_öô
(
l
);

392  
l
;

393 
	}
}

395 
	$båfsic_block_lök_‰ì
(
båfsic_block_lök
 *
l
)

397 
	`BUG_ON
(!(
NULL
 =
l
 || 
BTRFSIC_BLOCK_LINK_MAGIC_NUMBER
 =l->
magic_num
));

398 
	`k‰ì
(
l
);

399 
	}
}

401 
	$båfsic_dev_°©e_öô
(
båfsic_dev_°©e
 *
ds
)

403 
ds
->
magic_num
 = 
BTRFSIC_DEV2STATE_MAGIC_NUMBER
;

404 
ds
->
bdev
 = 
NULL
;

405 
ds
->
°©e
 = 
NULL
;

406 
	`INIT_LIST_HEAD
(&
ds
->
cﬁlisi⁄_ªsﬁvög_node
);

407 
ds
->
œ°_Êush_gí
 = 0;

408 
	`båfsic_block_öô
(&
ds
->
dummy_block_f‹_bio_bh_Êush
);

409 
ds
->
dummy_block_f‹_bio_bh_Êush
.
is_iod⁄e
 = 1;

410 
ds
->
dummy_block_f‹_bio_bh_Êush
.
dev_°©e
 = ds;

411 
	}
}

413 
båfsic_dev_°©e
 *
	$båfsic_dev_°©e_Æloc
()

415 
båfsic_dev_°©e
 *
ds
;

417 
ds
 = 
	`kzÆloc
((*ds), 
GFP_NOFS
);

418 i‡(
NULL
 !
ds
)

419 
	`båfsic_dev_°©e_öô
(
ds
);

421  
ds
;

422 
	}
}

424 
	$båfsic_dev_°©e_‰ì
(
båfsic_dev_°©e
 *
ds
)

426 
	`BUG_ON
(!(
NULL
 =
ds
 ||

427 
BTRFSIC_DEV2STATE_MAGIC_NUMBER
 =
ds
->
magic_num
));

428 
	`k‰ì
(
ds
);

429 
	}
}

431 
	$båfsic_block_hashèbÀ_öô
(
båfsic_block_hashèbÀ
 *
h
)

433 
i
;

435 
i
 = 0; i < 
BTRFSIC_BLOCK_HASHTABLE_SIZE
; i++)

436 
	`INIT_LIST_HEAD
(
h
->
èbÀ
 + 
i
);

437 
	}
}

439 
	$båfsic_block_hashèbÀ_add
(
båfsic_block
 *
b
,

440 
båfsic_block_hashèbÀ
 *
h
)

442 c⁄° 
hashvÆ
 =

443 ((()(
b
->
dev_byãƒ
 >> 16)) ^

444 (()((
uöçå_t
)
b
->
dev_°©e
->
bdev
))) &

445 (
BTRFSIC_BLOCK_HASHTABLE_SIZE
 - 1);

447 
	`li°_add
(&
b
->
cﬁlisi⁄_ªsﬁvög_node
, 
h
->
èbÀ
 + 
hashvÆ
);

448 
	}
}

450 
	$båfsic_block_hashèbÀ_ªmove
(
båfsic_block
 *
b
)

452 
	`li°_dñ
(&
b
->
cﬁlisi⁄_ªsﬁvög_node
);

453 
	}
}

455 
båfsic_block
 *
	$båfsic_block_hashèbÀ_lookup
(

456 
block_devi˚
 *
bdev
,

457 
u64
 
dev_byãƒ
,

458 
båfsic_block_hashèbÀ
 *
h
)

460 c⁄° 
hashvÆ
 =

461 ((()(
dev_byãƒ
 >> 16)) ^

462 (()((
uöçå_t
)
bdev
))) &

463 (
BTRFSIC_BLOCK_HASHTABLE_SIZE
 - 1);

464 
båfsic_block
 *
b
;

466 
	`li°_f‹_óch_íåy
(
b
, 
h
->
èbÀ
 + 
hashvÆ
, 
cﬁlisi⁄_ªsﬁvög_node
) {

467 i‡(
b
->
dev_°©e
->
bdev
 =bdev && b->
dev_byãƒ
 == dev_bytenr)

468  
b
;

471  
NULL
;

472 
	}
}

474 
	$båfsic_block_lök_hashèbÀ_öô
(

475 
båfsic_block_lök_hashèbÀ
 *
h
)

477 
i
;

479 
i
 = 0; i < 
BTRFSIC_BLOCK_LINK_HASHTABLE_SIZE
; i++)

480 
	`INIT_LIST_HEAD
(
h
->
èbÀ
 + 
i
);

481 
	}
}

483 
	$båfsic_block_lök_hashèbÀ_add
(

484 
båfsic_block_lök
 *
l
,

485 
båfsic_block_lök_hashèbÀ
 *
h
)

487 c⁄° 
hashvÆ
 =

488 ((()(
l
->
block_ªf_to
->
dev_byãƒ
 >> 16)) ^

489 (()(
l
->
block_ªf_‰om
->
dev_byãƒ
 >> 16)) ^

490 (()((
uöçå_t
)
l
->
block_ªf_to
->
dev_°©e
->
bdev
)) ^

491 (()((
uöçå_t
)
l
->
block_ªf_‰om
->
dev_°©e
->
bdev
)))

492 & (
BTRFSIC_BLOCK_LINK_HASHTABLE_SIZE
 - 1);

494 
	`BUG_ON
(
NULL
 =
l
->
block_ªf_to
);

495 
	`BUG_ON
(
NULL
 =
l
->
block_ªf_‰om
);

496 
	`li°_add
(&
l
->
cﬁlisi⁄_ªsﬁvög_node
, 
h
->
èbÀ
 + 
hashvÆ
);

497 
	}
}

499 
	$båfsic_block_lök_hashèbÀ_ªmove
(
båfsic_block_lök
 *
l
)

501 
	`li°_dñ
(&
l
->
cﬁlisi⁄_ªsﬁvög_node
);

502 
	}
}

504 
båfsic_block_lök
 *
	$båfsic_block_lök_hashèbÀ_lookup
(

505 
block_devi˚
 *
bdev_ªf_to
,

506 
u64
 
dev_byãƒ_ªf_to
,

507 
block_devi˚
 *
bdev_ªf_‰om
,

508 
u64
 
dev_byãƒ_ªf_‰om
,

509 
båfsic_block_lök_hashèbÀ
 *
h
)

511 c⁄° 
hashvÆ
 =

512 ((()(
dev_byãƒ_ªf_to
 >> 16)) ^

513 (()(
dev_byãƒ_ªf_‰om
 >> 16)) ^

514 (()((
uöçå_t
)
bdev_ªf_to
)) ^

515 (()((
uöçå_t
)
bdev_ªf_‰om
))) &

516 (
BTRFSIC_BLOCK_LINK_HASHTABLE_SIZE
 - 1);

517 
båfsic_block_lök
 *
l
;

519 
	`li°_f‹_óch_íåy
(
l
, 
h
->
èbÀ
 + 
hashvÆ
, 
cﬁlisi⁄_ªsﬁvög_node
) {

520 
	`BUG_ON
(
NULL
 =
l
->
block_ªf_to
);

521 
	`BUG_ON
(
NULL
 =
l
->
block_ªf_‰om
);

522 i‡(
l
->
block_ªf_to
->
dev_°©e
->
bdev
 =
bdev_ªf_to
 &&

523 
l
->
block_ªf_to
->
dev_byãƒ
 =
dev_byãƒ_ªf_to
 &&

524 
l
->
block_ªf_‰om
->
dev_°©e
->
bdev
 =
bdev_ªf_‰om
 &&

525 
l
->
block_ªf_‰om
->
dev_byãƒ
 =
dev_byãƒ_ªf_‰om
)

526  
l
;

529  
NULL
;

530 
	}
}

532 
	$båfsic_dev_°©e_hashèbÀ_öô
(

533 
båfsic_dev_°©e_hashèbÀ
 *
h
)

535 
i
;

537 
i
 = 0; i < 
BTRFSIC_DEV2STATE_HASHTABLE_SIZE
; i++)

538 
	`INIT_LIST_HEAD
(
h
->
èbÀ
 + 
i
);

539 
	}
}

541 
	$båfsic_dev_°©e_hashèbÀ_add
(

542 
båfsic_dev_°©e
 *
ds
,

543 
båfsic_dev_°©e_hashèbÀ
 *
h
)

545 c⁄° 
hashvÆ
 =

546 ((()((
uöçå_t
)
ds
->
bdev
->
bd_dev
)) &

547 (
BTRFSIC_DEV2STATE_HASHTABLE_SIZE
 - 1));

549 
	`li°_add
(&
ds
->
cﬁlisi⁄_ªsﬁvög_node
, 
h
->
èbÀ
 + 
hashvÆ
);

550 
	}
}

552 
	$båfsic_dev_°©e_hashèbÀ_ªmove
(
båfsic_dev_°©e
 *
ds
)

554 
	`li°_dñ
(&
ds
->
cﬁlisi⁄_ªsﬁvög_node
);

555 
	}
}

557 
båfsic_dev_°©e
 *
	$båfsic_dev_°©e_hashèbÀ_lookup
(
dev_t
 
dev
,

558 
båfsic_dev_°©e_hashèbÀ
 *
h
)

560 c⁄° 
hashvÆ
 =

561 
dev
 & (
BTRFSIC_DEV2STATE_HASHTABLE_SIZE
 - 1);

562 
båfsic_dev_°©e
 *
ds
;

564 
	`li°_f‹_óch_íåy
(
ds
, 
h
->
èbÀ
 + 
hashvÆ
, 
cﬁlisi⁄_ªsﬁvög_node
) {

565 i‡(
ds
->
bdev
->
bd_dev
 =
dev
)

566  
ds
;

569  
NULL
;

570 
	}
}

572 
	$båfsic_¥o˚ss_su≥rblock
(
båfsic_°©e
 *
°©e
,

573 
båfs_fs_devi˚s
 *
fs_devi˚s
)

575 
båfs_su≥r_block
 *
£À˘ed_su≥r
;

576 
li°_hód
 *
dev_hód
 = &
fs_devi˚s
->
devi˚s
;

577 
båfs_devi˚
 *
devi˚
;

578 
båfsic_dev_°©e
 *
£À˘ed_dev_°©e
 = 
NULL
;

579 
ªt
 = 0;

580 
∑ss
;

582 
£À˘ed_su≥r
 = 
	`kzÆloc
((*£À˘ed_su≥r), 
GFP_NOFS
);

583 i‡(!
£À˘ed_su≥r
)

584  -
ENOMEM
;

586 
	`li°_f‹_óch_íåy
(
devi˚
, 
dev_hód
, 
dev_li°
) {

587 
i
;

588 
båfsic_dev_°©e
 *
dev_°©e
;

590 i‡(!
devi˚
->
bdev
 || !devi˚->
«me
)

593 
dev_°©e
 = 
	`båfsic_dev_°©e_lookup
(
devi˚
->
bdev
->
bd_dev
);

594 
	`BUG_ON
(
NULL
 =
dev_°©e
);

595 
i
 = 0; i < 
BTRFS_SUPER_MIRROR_MAX
; i++) {

596 
ªt
 = 
	`båfsic_¥o˚ss_su≥rblock_dev_múr‹
(

597 
°©e
, 
dev_°©e
, 
devi˚
, 
i
,

598 &
£À˘ed_dev_°©e
, 
£À˘ed_su≥r
);

599 i‡(0 !
ªt
 && 0 =
i
) {

600 
	`k‰ì
(
£À˘ed_su≥r
);

601  
ªt
;

606 i‡(
NULL
 =
°©e
->
œã°_su≥rblock
) {

607 
	`¥_öfo
("btrfsic:Ço superblock found!\n");

608 
	`k‰ì
(
£À˘ed_su≥r
);

612 
∑ss
 = 0;Öass < 3;Öass++) {

613 
num_c›õs
;

614 
múr‹_num
;

615 
u64
 
√xt_byãƒ
;

617 
∑ss
) {

619 
√xt_byãƒ
 = 
	`båfs_su≥r_roŸ
(
£À˘ed_su≥r
);

620 i‡(
°©e
->
¥öt_mask
 &

621 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

622 
	`¥_öfo
("roŸ@%Œu\n", 
√xt_byãƒ
);

625 
√xt_byãƒ
 = 
	`båfs_su≥r_chunk_roŸ
(
£À˘ed_su≥r
);

626 i‡(
°©e
->
¥öt_mask
 &

627 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

628 
	`¥_öfo
("chunk@%Œu\n", 
√xt_byãƒ
);

631 
√xt_byãƒ
 = 
	`båfs_su≥r_log_roŸ
(
£À˘ed_su≥r
);

632 i‡(0 =
√xt_byãƒ
)

634 i‡(
°©e
->
¥öt_mask
 &

635 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

636 
	`¥_öfo
("log@%Œu\n", 
√xt_byãƒ
);

640 
num_c›õs
 = 
	`båfs_num_c›õs
(
°©e
->
fs_öfo
, 
√xt_byãƒ
,

641 
°©e
->
mëablock_size
);

642 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_NUM_COPIES
)

643 
	`¥_öfo
("num_copies(log_bytenr=%llu) = %d\n",

644 
√xt_byãƒ
, 
num_c›õs
);

646 
múr‹_num
 = 1; múr‹_num <
num_c›õs
; mirror_num++) {

647 
båfsic_block
 *
√xt_block
;

648 
båfsic_block_d©a_˘x
 
tmp_√xt_block_˘x
;

649 
båfsic_block_lök
 *
l
;

651 
ªt
 = 
	`båfsic_m≠_block
(
°©e
, 
√xt_byãƒ
,

652 
°©e
->
mëablock_size
,

653 &
tmp_√xt_block_˘x
,

654 
múr‹_num
);

655 i‡(
ªt
) {

656 
	`¥_öfo
("btrfsic: btrfsic_map_block(root @%llu, mirror %d) failed!\n",

657 
√xt_byãƒ
, 
múr‹_num
);

658 
	`k‰ì
(
£À˘ed_su≥r
);

662 
√xt_block
 = 
	`båfsic_block_hashèbÀ_lookup
(

663 
tmp_√xt_block_˘x
.
dev
->
bdev
,

664 
tmp_√xt_block_˘x
.
dev_byãƒ
,

665 &
°©e
->
block_hashèbÀ
);

666 
	`BUG_ON
(
NULL
 =
√xt_block
);

668 
l
 = 
	`båfsic_block_lök_hashèbÀ_lookup
(

669 
tmp_√xt_block_˘x
.
dev
->
bdev
,

670 
tmp_√xt_block_˘x
.
dev_byãƒ
,

671 
°©e
->
œã°_su≥rblock
->
dev_°©e
->

672 
bdev
,

673 
°©e
->
œã°_su≥rblock
->
dev_byãƒ
,

674 &
°©e
->
block_lök_hashèbÀ
);

675 
	`BUG_ON
(
NULL
 =
l
);

677 
ªt
 = 
	`båfsic_ªad_block
(
°©e
, &
tmp_√xt_block_˘x
);

678 i‡(
ªt
 < ()
PAGE_SIZE
) {

679 
	`¥_öfo
("btrfsic:Ñead @logical %llu failed!\n",

680 
tmp_√xt_block_˘x
.
°¨t
);

681 
	`båfsic_ªÀa£_block_˘x
(&
tmp_√xt_block_˘x
);

682 
	`k‰ì
(
£À˘ed_su≥r
);

686 
ªt
 = 
	`båfsic_¥o˚ss_mëablock
(
°©e
,

687 
√xt_block
,

688 &
tmp_√xt_block_˘x
,

689 
BTRFS_MAX_LEVEL
 + 3, 1);

690 
	`båfsic_ªÀa£_block_˘x
(&
tmp_√xt_block_˘x
);

694 
	`k‰ì
(
£À˘ed_su≥r
);

695  
ªt
;

696 
	}
}

698 
	$båfsic_¥o˚ss_su≥rblock_dev_múr‹
(

699 
båfsic_°©e
 *
°©e
,

700 
båfsic_dev_°©e
 *
dev_°©e
,

701 
båfs_devi˚
 *
devi˚
,

702 
su≥rblock_múr‹_num
,

703 
båfsic_dev_°©e
 **
£À˘ed_dev_°©e
,

704 
båfs_su≥r_block
 *
£À˘ed_su≥r
)

706 
båfs_fs_öfo
 *
fs_öfo
 = 
°©e
->fs_info;

707 
båfs_su≥r_block
 *
su≥r_tmp
;

708 
u64
 
dev_byãƒ
;

709 
båfsic_block
 *
su≥rblock_tmp
;

710 
∑ss
;

711 
block_devi˚
 *c⁄° 
su≥rblock_bdev
 = 
devi˚
->
bdev
;

712 
∑ge
 *page;

713 
addªss_•a˚
 *
m≠pög
 = 
su≥rblock_bdev
->
bd_öode
->
i_m≠pög
;

714 
ªt
 = 0;

717 
dev_byãƒ
 = 
	`båfs_sb_off£t
(
su≥rblock_múr‹_num
);

718 i‡(
dev_byãƒ
 + 
BTRFS_SUPER_INFO_SIZE
 > 
devi˚
->
commô_tŸÆ_byãs
)

721 
∑ge
 = 
	`ªad_ˇche_∑ge_gÂ
(
m≠pög
, 
dev_byãƒ
 >> 
PAGE_SHIFT
, 
GFP_NOFS
);

722 i‡(
	`IS_ERR
(
∑ge
))

725 
su≥r_tmp
 = 
	`∑ge_addªss
(
∑ge
);

727 i‡(
	`båfs_su≥r_byãƒ
(
su≥r_tmp
Ë!
dev_byãƒ
 ||

728 
	`båfs_su≥r_magic
(
su≥r_tmp
Ë!
BTRFS_MAGIC
 ||

729 
	`memcmp
(
devi˚
->
uuid
, 
su≥r_tmp
->
dev_ôem
.uuid, 
BTRFS_UUID_SIZE
) ||

730 
	`båfs_su≥r_nodesize
(
su≥r_tmp
Ë!
°©e
->
mëablock_size
 ||

731 
	`båfs_su≥r_£˘‹size
(
su≥r_tmp
Ë!
°©e
->
d©ablock_size
) {

732 
ªt
 = 0;

733 
out
;

736 
su≥rblock_tmp
 =

737 
	`båfsic_block_hashèbÀ_lookup
(
su≥rblock_bdev
,

738 
dev_byãƒ
,

739 &
°©e
->
block_hashèbÀ
);

740 i‡(
NULL
 =
su≥rblock_tmp
) {

741 
su≥rblock_tmp
 = 
	`båfsic_block_Æloc
();

742 i‡(
NULL
 =
su≥rblock_tmp
) {

743 
ªt
 = -1;

744 
out
;

747 
su≥rblock_tmp
->
dev_byãƒ
 = dev_bytenr;

748 
su≥rblock_tmp
->
dev_°©e
 = dev_state;

749 
su≥rblock_tmp
->
logiˇl_byãƒ
 = 
dev_byãƒ
;

750 
su≥rblock_tmp
->
gíî©i⁄
 = 
	`båfs_su≥r_gíî©i⁄
(
su≥r_tmp
);

751 
su≥rblock_tmp
->
is_mëad©a
 = 1;

752 
su≥rblock_tmp
->
is_su≥rblock
 = 1;

753 
su≥rblock_tmp
->
is_iod⁄e
 = 1;

754 
su≥rblock_tmp
->
√vî_wrôãn
 = 0;

755 
su≥rblock_tmp
->
múr‹_num
 = 1 + 
su≥rblock_múr‹_num
;

756 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_SUPERBLOCK_WRITE
)

757 
	`båfs_öfo_ö_rcu
(
fs_öfo
,

759 
su≥rblock_bdev
,

760 
	`båfs_dev_«me
(
devi˚
), 
dev_byãƒ
,

761 
dev_°©e
->
bdev
, 
dev_byãƒ
,

762 
su≥rblock_múr‹_num
);

763 
	`li°_add
(&
su≥rblock_tmp
->
Æl_blocks_node
,

764 &
°©e
->
Æl_blocks_li°
);

765 
	`båfsic_block_hashèbÀ_add
(
su≥rblock_tmp
,

766 &
°©e
->
block_hashèbÀ
);

770 i‡(
	`båfs_su≥r_gíî©i⁄
(
su≥r_tmp
) >

771 
°©e
->
max_su≥rblock_gíî©i⁄
 ||

772 0 =
°©e
->
max_su≥rblock_gíî©i⁄
) {

773 
	`mem˝y
(
£À˘ed_su≥r
, 
su≥r_tmp
, (*selected_super));

774 *
£À˘ed_dev_°©e
 = 
dev_°©e
;

775 
°©e
->
max_su≥rblock_gíî©i⁄
 =

776 
	`båfs_su≥r_gíî©i⁄
(
su≥r_tmp
);

777 
°©e
->
œã°_su≥rblock
 = 
su≥rblock_tmp
;

780 
∑ss
 = 0;Öass < 3;Öass++) {

781 
u64
 
√xt_byãƒ
;

782 
num_c›õs
;

783 
múr‹_num
;

784 c⁄° *
addôi⁄Æ_°rög
 = 
NULL
;

785 
båfs_disk_key
 
tmp_disk_key
;

787 
tmp_disk_key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

788 
tmp_disk_key
.
off£t
 = 0;

789 
∑ss
) {

791 
	`båfs_£t_disk_key_obje˘id
(&
tmp_disk_key
,

792 
BTRFS_ROOT_TREE_OBJECTID
);

793 
addôi⁄Æ_°rög
 = "initialÑoot ";

794 
√xt_byãƒ
 = 
	`båfs_su≥r_roŸ
(
su≥r_tmp
);

797 
	`båfs_£t_disk_key_obje˘id
(&
tmp_disk_key
,

798 
BTRFS_CHUNK_TREE_OBJECTID
);

799 
addôi⁄Æ_°rög
 = "initial chunk ";

800 
√xt_byãƒ
 = 
	`båfs_su≥r_chunk_roŸ
(
su≥r_tmp
);

803 
	`båfs_£t_disk_key_obje˘id
(&
tmp_disk_key
,

804 
BTRFS_TREE_LOG_OBJECTID
);

805 
addôi⁄Æ_°rög
 = "initialÜog ";

806 
√xt_byãƒ
 = 
	`båfs_su≥r_log_roŸ
(
su≥r_tmp
);

807 i‡(0 =
√xt_byãƒ
)

812 
num_c›õs
 = 
	`båfs_num_c›õs
(
fs_öfo
, 
√xt_byãƒ
,

813 
°©e
->
mëablock_size
);

814 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_NUM_COPIES
)

815 
	`¥_öfo
("num_copies(log_bytenr=%llu) = %d\n",

816 
√xt_byãƒ
, 
num_c›õs
);

817 
múr‹_num
 = 1; múr‹_num <
num_c›õs
; mirror_num++) {

818 
båfsic_block
 *
√xt_block
;

819 
båfsic_block_d©a_˘x
 
tmp_√xt_block_˘x
;

820 
båfsic_block_lök
 *
l
;

822 i‡(
	`båfsic_m≠_block
(
°©e
, 
√xt_byãƒ
,

823 
°©e
->
mëablock_size
,

824 &
tmp_√xt_block_˘x
,

825 
múr‹_num
)) {

826 
	`¥_öfo
("btrfsic: btrfsic_map_block(bytenr @%llu, mirror %d) failed!\n",

827 
√xt_byãƒ
, 
múr‹_num
);

828 
ªt
 = -1;

829 
out
;

832 
√xt_block
 = 
	`båfsic_block_lookup_‹_add
(

833 
°©e
, &
tmp_√xt_block_˘x
,

834 
addôi⁄Æ_°rög
, 1, 1, 0,

835 
múr‹_num
, 
NULL
);

836 i‡(
NULL
 =
√xt_block
) {

837 
	`båfsic_ªÀa£_block_˘x
(&
tmp_√xt_block_˘x
);

838 
ªt
 = -1;

839 
out
;

842 
√xt_block
->
disk_key
 = 
tmp_disk_key
;

843 
√xt_block
->
gíî©i⁄
 = 
BTRFSIC_GENERATION_UNKNOWN
;

844 
l
 = 
	`båfsic_block_lök_lookup_‹_add
(

845 
°©e
, &
tmp_√xt_block_˘x
,

846 
√xt_block
, 
su≥rblock_tmp
,

847 
BTRFSIC_GENERATION_UNKNOWN
);

848 
	`båfsic_ªÀa£_block_˘x
(&
tmp_√xt_block_˘x
);

849 i‡(
NULL
 =
l
) {

850 
ªt
 = -1;

851 
out
;

855 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_INITIAL_ALL_TREES
)

856 
	`båfsic_dump_åì_sub
(
°©e
, 
su≥rblock_tmp
, 0);

858 
out
:

859 
	`put_∑ge
(
∑ge
);

860  
ªt
;

861 
	}
}

863 
båfsic_°ack_‰ame
 *
	$båfsic_°ack_‰ame_Æloc
()

865 
båfsic_°ack_‰ame
 *
sf
;

867 
sf
 = 
	`kzÆloc
((*sf), 
GFP_NOFS
);

868 i‡(
sf
)

869 
sf
->
magic
 = 
BTRFSIC_BLOCK_STACK_FRAME_MAGIC_NUMBER
;

870  
sf
;

871 
	}
}

873 
	$båfsic_°ack_‰ame_‰ì
(
båfsic_°ack_‰ame
 *
sf
)

875 
	`BUG_ON
(!(
NULL
 =
sf
 ||

876 
BTRFSIC_BLOCK_STACK_FRAME_MAGIC_NUMBER
 =
sf
->
magic
));

877 
	`k‰ì
(
sf
);

878 
	}
}

880 
noölöe_f‹_°ack
 
	$båfsic_¥o˚ss_mëablock
(

881 
båfsic_°©e
 *
°©e
,

882 
båfsic_block
 *c⁄° 
fú°_block
,

883 
båfsic_block_d©a_˘x
 *c⁄° 
fú°_block_˘x
,

884 
fú°_limô_√°ög
, 
f‹˚_iod⁄e_Êag
)

886 
båfsic_°ack_‰ame
 
öôül_°ack_‰ame
 = { 0 };

887 
båfsic_°ack_‰ame
 *
sf
;

888 
båfsic_°ack_‰ame
 *
√xt_°ack
;

889 
båfs_hódî
 *c⁄° 
fú°_hdr
 =

890 (
båfs_hódî
 *)
fú°_block_˘x
->
d©av
[0];

892 
	`BUG_ON
(!
fú°_hdr
);

893 
sf
 = &
öôül_°ack_‰ame
;

894 
sf
->
îr‹
 = 0;

895 
sf
->
i
 = -1;

896 
sf
->
limô_√°ög
 = 
fú°_limô_√°ög
;

897 
sf
->
block
 = 
fú°_block
;

898 
sf
->
block_˘x
 = 
fú°_block_˘x
;

899 
sf
->
√xt_block
 = 
NULL
;

900 
sf
->
hdr
 = 
fú°_hdr
;

901 
sf
->
¥ev
 = 
NULL
;

903 
c⁄töue_wôh_√w_°ack_‰ame
:

904 
sf
->
block
->
gíî©i⁄
 = 
	`båfs_°ack_hódî_gíî©i⁄
(sf->
hdr
);

905 i‡(0 =
sf
->
hdr
->
Àvñ
) {

906 
båfs_Àaf
 *c⁄° 
Àafhdr
 =

907 (
båfs_Àaf
 *)
sf
->
hdr
;

909 i‡(-1 =
sf
->
i
) {

910 
sf
->
ƒ
 = 
	`båfs_°ack_hódî_ƒôems
(&
Àafhdr
->
hódî
);

912 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

913 
	`¥_öfo
("leaf %llu items %d generation %llu owner %llu\n",

914 
sf
->
block_˘x
->
°¨t
, sf->
ƒ
,

915 
	`båfs_°ack_hódî_gíî©i⁄
(

916 &
Àafhdr
->
hódî
),

917 
	`båfs_°ack_hódî_ow√r
(

918 &
Àafhdr
->
hódî
));

921 
c⁄töue_wôh_cuºít_Àaf_°ack_‰ame
:

922 i‡(0 =
sf
->
num_c›õs
 || sf->
múr‹_num
 > sf->num_copies) {

923 
sf
->
i
++;

924 
sf
->
num_c›õs
 = 0;

927 i‡(
sf
->
i
 < sf->
ƒ
) {

928 
båfs_ôem
 
disk_ôem
;

929 
u32
 
disk_ôem_off£t
 =

930 (
uöçå_t
)(
Àafhdr
->
ôems
 + 
sf
->
i
) -

931 (
uöçå_t
)
Àafhdr
;

932 
båfs_disk_key
 *
disk_key
;

933 
u8
 
ty≥
;

934 
u32
 
ôem_off£t
;

935 
u32
 
ôem_size
;

937 i‡(
disk_ôem_off£t
 + (
båfs_ôem
) >

938 
sf
->
block_˘x
->
Àn
) {

939 
Àaf_ôem_out_of_boun˚_îr‹
:

940 
	`¥_öfo
(

942 
sf
->
block_˘x
->
°¨t
,

943 
sf
->
block_˘x
->
dev
->
bdev
);

944 
⁄e_°ack_‰ame_backw¨ds
;

946 
	`båfsic_ªad_‰om_block_d©a
(
sf
->
block_˘x
,

947 &
disk_ôem
,

948 
disk_ôem_off£t
,

949 (
båfs_ôem
));

950 
ôem_off£t
 = 
	`båfs_°ack_ôem_off£t
(&
disk_ôem
);

951 
ôem_size
 = 
	`båfs_°ack_ôem_size
(&
disk_ôem
);

952 
disk_key
 = &
disk_ôem
.
key
;

953 
ty≥
 = 
	`båfs_disk_key_ty≥
(
disk_key
);

955 i‡(
BTRFS_ROOT_ITEM_KEY
 =
ty≥
) {

956 
båfs_roŸ_ôem
 
roŸ_ôem
;

957 
u32
 
roŸ_ôem_off£t
;

958 
u64
 
√xt_byãƒ
;

960 
roŸ_ôem_off£t
 = 
ôem_off£t
 +

961 
	`off£tof
(
båfs_Àaf
, 
ôems
);

962 i‡(
roŸ_ôem_off£t
 + 
ôem_size
 >

963 
sf
->
block_˘x
->
Àn
)

964 
Àaf_ôem_out_of_boun˚_îr‹
;

965 
	`båfsic_ªad_‰om_block_d©a
(

966 
sf
->
block_˘x
, &
roŸ_ôem
,

967 
roŸ_ôem_off£t
,

968 
ôem_size
);

969 
√xt_byãƒ
 = 
	`båfs_roŸ_byãƒ
(&
roŸ_ôem
);

971 
sf
->
îr‹
 =

972 
	`båfsic_¸óã_lök_to_√xt_block
(

973 
°©e
,

974 
sf
->
block
,

975 
sf
->
block_˘x
,

976 
√xt_byãƒ
,

977 
sf
->
limô_√°ög
,

978 &
sf
->
√xt_block_˘x
,

979 &
sf
->
√xt_block
,

980 
f‹˚_iod⁄e_Êag
,

981 &
sf
->
num_c›õs
,

982 &
sf
->
múr‹_num
,

983 
disk_key
,

984 
	`båfs_roŸ_gíî©i⁄
(

985 &
roŸ_ôem
));

986 i‡(
sf
->
îr‹
)

987 
⁄e_°ack_‰ame_backw¨ds
;

989 i‡(
NULL
 !
sf
->
√xt_block
) {

990 
båfs_hódî
 *c⁄° 
√xt_hdr
 =

991 (
båfs_hódî
 *)

992 
sf
->
√xt_block_˘x
.
d©av
[0];

994 
√xt_°ack
 =

995 
	`båfsic_°ack_‰ame_Æloc
();

996 i‡(
NULL
 =
√xt_°ack
) {

997 
sf
->
îr‹
 = -1;

998 
	`båfsic_ªÀa£_block_˘x
(

999 &
sf
->

1000 
√xt_block_˘x
);

1001 
⁄e_°ack_‰ame_backw¨ds
;

1004 
√xt_°ack
->
i
 = -1;

1005 
√xt_°ack
->
block
 = 
sf
->
√xt_block
;

1006 
√xt_°ack
->
block_˘x
 =

1007 &
sf
->
√xt_block_˘x
;

1008 
√xt_°ack
->
√xt_block
 = 
NULL
;

1009 
√xt_°ack
->
hdr
 = 
√xt_hdr
;

1010 
√xt_°ack
->
limô_√°ög
 =

1011 
sf
->
limô_√°ög
 - 1;

1012 
√xt_°ack
->
¥ev
 = 
sf
;

1013 
sf
 = 
√xt_°ack
;

1014 
c⁄töue_wôh_√w_°ack_‰ame
;

1016 } i‡(
BTRFS_EXTENT_DATA_KEY
 =
ty≥
 &&

1017 
°©e
->
ö˛ude_exã¡_d©a
) {

1018 
sf
->
îr‹
 = 
	`båfsic_h™dÀ_exã¡_d©a
(

1019 
°©e
,

1020 
sf
->
block
,

1021 
sf
->
block_˘x
,

1022 
ôem_off£t
,

1023 
f‹˚_iod⁄e_Êag
);

1024 i‡(
sf
->
îr‹
)

1025 
⁄e_°ack_‰ame_backw¨ds
;

1028 
c⁄töue_wôh_cuºít_Àaf_°ack_‰ame
;

1031 
båfs_node
 *c⁄° 
nodehdr
 = (båfs_nodê*)
sf
->
hdr
;

1033 i‡(-1 =
sf
->
i
) {

1034 
sf
->
ƒ
 = 
	`båfs_°ack_hódî_ƒôems
(&
nodehdr
->
hódî
);

1036 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1037 
	`¥_öfo
("node %lluÜevel %d items %d generation %llu owner %llu\n",

1038 
sf
->
block_˘x
->
°¨t
,

1039 
nodehdr
->
hódî
.
Àvñ
, 
sf
->
ƒ
,

1040 
	`båfs_°ack_hódî_gíî©i⁄
(

1041 &
nodehdr
->
hódî
),

1042 
	`båfs_°ack_hódî_ow√r
(

1043 &
nodehdr
->
hódî
));

1046 
c⁄töue_wôh_cuºít_node_°ack_‰ame
:

1047 i‡(0 =
sf
->
num_c›õs
 || sf->
múr‹_num
 > sf->num_copies) {

1048 
sf
->
i
++;

1049 
sf
->
num_c›õs
 = 0;

1052 i‡(
sf
->
i
 < sf->
ƒ
) {

1053 
båfs_key_±r
 
key_±r
;

1054 
u32
 
key_±r_off£t
;

1055 
u64
 
√xt_byãƒ
;

1057 
key_±r_off£t
 = (
uöçå_t
)(
nodehdr
->
±rs
 + 
sf
->
i
) -

1058 (
uöçå_t
)
nodehdr
;

1059 i‡(
key_±r_off£t
 + (
båfs_key_±r
) >

1060 
sf
->
block_˘x
->
Àn
) {

1061 
	`¥_öfo
(

1063 
sf
->
block_˘x
->
°¨t
,

1064 
sf
->
block_˘x
->
dev
->
bdev
);

1065 
⁄e_°ack_‰ame_backw¨ds
;

1067 
	`båfsic_ªad_‰om_block_d©a
(

1068 
sf
->
block_˘x
, &
key_±r
, 
key_±r_off£t
,

1069 (
båfs_key_±r
));

1070 
√xt_byãƒ
 = 
	`båfs_°ack_key_block±r
(&
key_±r
);

1072 
sf
->
îr‹
 = 
	`båfsic_¸óã_lök_to_√xt_block
(

1073 
°©e
,

1074 
sf
->
block
,

1075 
sf
->
block_˘x
,

1076 
√xt_byãƒ
,

1077 
sf
->
limô_√°ög
,

1078 &
sf
->
√xt_block_˘x
,

1079 &
sf
->
√xt_block
,

1080 
f‹˚_iod⁄e_Êag
,

1081 &
sf
->
num_c›õs
,

1082 &
sf
->
múr‹_num
,

1083 &
key_±r
.
key
,

1084 
	`båfs_°ack_key_gíî©i⁄
(&
key_±r
));

1085 i‡(
sf
->
îr‹
)

1086 
⁄e_°ack_‰ame_backw¨ds
;

1088 i‡(
NULL
 !
sf
->
√xt_block
) {

1089 
båfs_hódî
 *c⁄° 
√xt_hdr
 =

1090 (
båfs_hódî
 *)

1091 
sf
->
√xt_block_˘x
.
d©av
[0];

1093 
√xt_°ack
 = 
	`båfsic_°ack_‰ame_Æloc
();

1094 i‡(
NULL
 =
√xt_°ack
) {

1095 
sf
->
îr‹
 = -1;

1096 
⁄e_°ack_‰ame_backw¨ds
;

1099 
√xt_°ack
->
i
 = -1;

1100 
√xt_°ack
->
block
 = 
sf
->
√xt_block
;

1101 
√xt_°ack
->
block_˘x
 = &
sf
->
√xt_block_˘x
;

1102 
√xt_°ack
->
√xt_block
 = 
NULL
;

1103 
√xt_°ack
->
hdr
 = 
√xt_hdr
;

1104 
√xt_°ack
->
limô_√°ög
 =

1105 
sf
->
limô_√°ög
 - 1;

1106 
√xt_°ack
->
¥ev
 = 
sf
;

1107 
sf
 = 
√xt_°ack
;

1108 
c⁄töue_wôh_√w_°ack_‰ame
;

1111 
c⁄töue_wôh_cuºít_node_°ack_‰ame
;

1115 
⁄e_°ack_‰ame_backw¨ds
:

1116 i‡(
NULL
 !
sf
->
¥ev
) {

1117 
båfsic_°ack_‰ame
 *c⁄° 
¥ev
 = 
sf
->prev;

1120 
	`båfsic_ªÀa£_block_˘x
(
sf
->
block_˘x
);

1122 i‡(
sf
->
îr‹
) {

1123 
¥ev
->
îr‹
 = 
sf
->error;

1124 
	`båfsic_°ack_‰ame_‰ì
(
sf
);

1125 
sf
 = 
¥ev
;

1126 
⁄e_°ack_‰ame_backw¨ds
;

1129 
	`båfsic_°ack_‰ame_‰ì
(
sf
);

1130 
sf
 = 
¥ev
;

1131 
c⁄töue_wôh_√w_°ack_‰ame
;

1133 
	`BUG_ON
(&
öôül_°ack_‰ame
 !
sf
);

1136  
sf
->
îr‹
;

1137 
	}
}

1139 
	$båfsic_ªad_‰om_block_d©a
(

1140 
båfsic_block_d©a_˘x
 *
block_˘x
,

1141 *
d°v
, 
u32
 
off£t
, 
size_t
 
Àn
)

1143 
size_t
 
cur
;

1144 
size_t
 
pgoff
;

1145 *
kaddr
;

1146 *
d°
 = (*)
d°v
;

1147 
size_t
 
°¨t_off£t
 = 
	`off£t_ö_∑ge
(
block_˘x
->
°¨t
);

1148 
i
 = (
°¨t_off£t
 + 
off£t
Ë>> 
PAGE_SHIFT
;

1150 
	`WARN_ON
(
off£t
 + 
Àn
 > 
block_˘x
->len);

1151 
pgoff
 = 
	`off£t_ö_∑ge
(
°¨t_off£t
 + 
off£t
);

1153 
Àn
 > 0) {

1154 
cur
 = 
	`mö
(
Àn
, ((
size_t
)
PAGE_SIZE
 - 
pgoff
));

1155 
	`BUG_ON
(
i
 >
	`DIV_ROUND_UP
(
block_˘x
->
Àn
, 
PAGE_SIZE
));

1156 
kaddr
 = 
block_˘x
->
d©av
[
i
];

1157 
	`mem˝y
(
d°
, 
kaddr
 + 
pgoff
, 
cur
);

1159 
d°
 +
cur
;

1160 
Àn
 -
cur
;

1161 
pgoff
 = 0;

1162 
i
++;

1164 
	}
}

1166 
	$båfsic_¸óã_lök_to_√xt_block
(

1167 
båfsic_°©e
 *
°©e
,

1168 
båfsic_block
 *
block
,

1169 
båfsic_block_d©a_˘x
 *
block_˘x
,

1170 
u64
 
√xt_byãƒ
,

1171 
limô_√°ög
,

1172 
båfsic_block_d©a_˘x
 *
√xt_block_˘x
,

1173 
båfsic_block
 **
√xt_blockp
,

1174 
f‹˚_iod⁄e_Êag
,

1175 *
num_c›õ•
, *
múr‹_nump
,

1176 
båfs_disk_key
 *
disk_key
,

1177 
u64
 
∑ª¡_gíî©i⁄
)

1179 
båfs_fs_öfo
 *
fs_öfo
 = 
°©e
->fs_info;

1180 
båfsic_block
 *
√xt_block
 = 
NULL
;

1181 
ªt
;

1182 
båfsic_block_lök
 *
l
;

1183 
did_Æloc_block_lök
;

1184 
block_was_¸óãd
;

1186 *
√xt_blockp
 = 
NULL
;

1187 i‡(0 =*
num_c›õ•
) {

1188 *
num_c›õ•
 = 
	`båfs_num_c›õs
(
fs_öfo
, 
√xt_byãƒ
,

1189 
°©e
->
mëablock_size
);

1190 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_NUM_COPIES
)

1191 
	`¥_öfo
("num_copies(log_bytenr=%llu) = %d\n",

1192 
√xt_byãƒ
, *
num_c›õ•
);

1193 *
múr‹_nump
 = 1;

1196 i‡(*
múr‹_nump
 > *
num_c›õ•
)

1199 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1200 
	`¥_öfo
("btrfsic_create_link_to_next_block(mirror_num=%d)\n",

1201 *
múr‹_nump
);

1202 
ªt
 = 
	`båfsic_m≠_block
(
°©e
, 
√xt_byãƒ
,

1203 
°©e
->
mëablock_size
,

1204 
√xt_block_˘x
, *
múr‹_nump
);

1205 i‡(
ªt
) {

1206 
	`¥_öfo
("btrfsic: btrfsic_map_block(@%llu, mirror=%d) failed!\n",

1207 
√xt_byãƒ
, *
múr‹_nump
);

1208 
	`båfsic_ªÀa£_block_˘x
(
√xt_block_˘x
);

1209 *
√xt_blockp
 = 
NULL
;

1213 
√xt_block
 = 
	`båfsic_block_lookup_‹_add
(
°©e
,

1214 
√xt_block_˘x
, "referenced ",

1215 1, 
f‹˚_iod⁄e_Êag
,

1216 !
f‹˚_iod⁄e_Êag
,

1217 *
múr‹_nump
,

1218 &
block_was_¸óãd
);

1219 i‡(
NULL
 =
√xt_block
) {

1220 
	`båfsic_ªÀa£_block_˘x
(
√xt_block_˘x
);

1221 *
√xt_blockp
 = 
NULL
;

1224 i‡(
block_was_¸óãd
) {

1225 
l
 = 
NULL
;

1226 
√xt_block
->
gíî©i⁄
 = 
BTRFSIC_GENERATION_UNKNOWN
;

1228 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
) {

1229 i‡(
√xt_block
->
logiˇl_byãƒ
 !
√xt_byãƒ
 &&

1230 !(!
√xt_block
->
is_mëad©a
 &&

1231 0 =
√xt_block
->
logiˇl_byãƒ
))

1232 
	`¥_öfo
(

1234 
√xt_byãƒ
, 
√xt_block_˘x
->
dev
->
bdev
,

1235 
√xt_block_˘x
->
dev_byãƒ
, *
múr‹_nump
,

1236 
	`båfsic_gë_block_ty≥
(
°©e
,

1237 
√xt_block
),

1238 
√xt_block
->
logiˇl_byãƒ
);

1240 
	`¥_öfo
(

1242 
√xt_byãƒ
, 
√xt_block_˘x
->
dev
->
bdev
,

1243 
√xt_block_˘x
->
dev_byãƒ
, *
múr‹_nump
,

1244 
	`båfsic_gë_block_ty≥
(
°©e
,

1245 
√xt_block
));

1247 
√xt_block
->
logiˇl_byãƒ
 = 
√xt_byãƒ
;

1249 
√xt_block
->
múr‹_num
 = *
múr‹_nump
;

1250 
l
 = 
	`båfsic_block_lök_hashèbÀ_lookup
(

1251 
√xt_block_˘x
->
dev
->
bdev
,

1252 
√xt_block_˘x
->
dev_byãƒ
,

1253 
block_˘x
->
dev
->
bdev
,

1254 
block_˘x
->
dev_byãƒ
,

1255 &
°©e
->
block_lök_hashèbÀ
);

1258 
√xt_block
->
disk_key
 = *disk_key;

1259 i‡(
NULL
 =
l
) {

1260 
l
 = 
	`båfsic_block_lök_Æloc
();

1261 i‡(
NULL
 =
l
) {

1262 
	`båfsic_ªÀa£_block_˘x
(
√xt_block_˘x
);

1263 *
√xt_blockp
 = 
NULL
;

1267 
did_Æloc_block_lök
 = 1;

1268 
l
->
block_ªf_to
 = 
√xt_block
;

1269 
l
->
block_ªf_‰om
 = 
block
;

1270 
l
->
ªf_˙t
 = 1;

1271 
l
->
∑ª¡_gíî©i⁄
 =Öarent_generation;

1273 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1274 
	`båfsic_¥öt_add_lök
(
°©e
, 
l
);

1276 
	`li°_add
(&
l
->
node_ªf_to
, &
block
->
ªf_to_li°
);

1277 
	`li°_add
(&
l
->
node_ªf_‰om
, &
√xt_block
->
ªf_‰om_li°
);

1279 
	`båfsic_block_lök_hashèbÀ_add
(
l
,

1280 &
°©e
->
block_lök_hashèbÀ
);

1282 
did_Æloc_block_lök
 = 0;

1283 i‡(0 =
limô_√°ög
) {

1284 
l
->
ªf_˙t
++;

1285 
l
->
∑ª¡_gíî©i⁄
 =Öarent_generation;

1286 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1287 
	`båfsic_¥öt_add_lök
(
°©e
, 
l
);

1291 i‡(
limô_√°ög
 > 0 && 
did_Æloc_block_lök
) {

1292 
ªt
 = 
	`båfsic_ªad_block
(
°©e
, 
√xt_block_˘x
);

1293 i‡(
ªt
 < ()
√xt_block_˘x
->
Àn
) {

1294 
	`¥_öfo
("btrfsic:Ñead block @logical %llu failed!\n",

1295 
√xt_byãƒ
);

1296 
	`båfsic_ªÀa£_block_˘x
(
√xt_block_˘x
);

1297 *
√xt_blockp
 = 
NULL
;

1301 *
√xt_blockp
 = 
√xt_block
;

1303 *
√xt_blockp
 = 
NULL
;

1305 (*
múr‹_nump
)++;

1308 
	}
}

1310 
	$båfsic_h™dÀ_exã¡_d©a
(

1311 
båfsic_°©e
 *
°©e
,

1312 
båfsic_block
 *
block
,

1313 
båfsic_block_d©a_˘x
 *
block_˘x
,

1314 
u32
 
ôem_off£t
, 
f‹˚_iod⁄e_Êag
)

1316 
båfs_fs_öfo
 *
fs_öfo
 = 
°©e
->fs_info;

1317 
båfs_fûe_exã¡_ôem
 
fûe_exã¡_ôem
;

1318 
u64
 
fûe_exã¡_ôem_off£t
;

1319 
u64
 
√xt_byãƒ
;

1320 
u64
 
num_byãs
;

1321 
u64
 
gíî©i⁄
;

1322 
båfsic_block_lök
 *
l
;

1323 
ªt
;

1325 
fûe_exã¡_ôem_off£t
 = 
	`off£tof
(
båfs_Àaf
, 
ôems
) +

1326 
ôem_off£t
;

1327 i‡(
fûe_exã¡_ôem_off£t
 +

1328 
	`off£tof
(
båfs_fûe_exã¡_ôem
, 
disk_num_byãs
) >

1329 
block_˘x
->
Àn
) {

1330 
	`¥_öfo
("btrfsic: file item out of bounceátÜogical %llu, dev %pg\n",

1331 
block_˘x
->
°¨t
, block_˘x->
dev
->
bdev
);

1335 
	`båfsic_ªad_‰om_block_d©a
(
block_˘x
, &
fûe_exã¡_ôem
,

1336 
fûe_exã¡_ôem_off£t
,

1337 
	`off£tof
(
båfs_fûe_exã¡_ôem
, 
disk_num_byãs
));

1338 i‡(
BTRFS_FILE_EXTENT_REG
 !
fûe_exã¡_ôem
.
ty≥
 ||

1339 
	`båfs_°ack_fûe_exã¡_disk_byãƒ
(&
fûe_exã¡_ôem
) == 0) {

1340 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERY_VERBOSE
)

1341 
	`¥_öfo
("extent_data:Åype %u, disk_bytenr = %llu\n",

1342 
fûe_exã¡_ôem
.
ty≥
,

1343 
	`båfs_°ack_fûe_exã¡_disk_byãƒ
(

1344 &
fûe_exã¡_ôem
));

1348 i‡(
fûe_exã¡_ôem_off£t
 + (
båfs_fûe_exã¡_ôem
) >

1349 
block_˘x
->
Àn
) {

1350 
	`¥_öfo
("btrfsic: file item out of bounceátÜogical %llu, dev %pg\n",

1351 
block_˘x
->
°¨t
, block_˘x->
dev
->
bdev
);

1354 
	`båfsic_ªad_‰om_block_d©a
(
block_˘x
, &
fûe_exã¡_ôem
,

1355 
fûe_exã¡_ôem_off£t
,

1356 (
båfs_fûe_exã¡_ôem
));

1357 
√xt_byãƒ
 = 
	`båfs_°ack_fûe_exã¡_disk_byãƒ
(&
fûe_exã¡_ôem
);

1358 i‡(
	`båfs_°ack_fûe_exã¡_com¥essi⁄
(&
fûe_exã¡_ôem
) ==

1359 
BTRFS_COMPRESS_NONE
) {

1360 
√xt_byãƒ
 +
	`båfs_°ack_fûe_exã¡_off£t
(&
fûe_exã¡_ôem
);

1361 
num_byãs
 = 
	`båfs_°ack_fûe_exã¡_num_byãs
(&
fûe_exã¡_ôem
);

1363 
num_byãs
 = 
	`båfs_°ack_fûe_exã¡_disk_num_byãs
(&
fûe_exã¡_ôem
);

1365 
gíî©i⁄
 = 
	`båfs_°ack_fûe_exã¡_gíî©i⁄
(&
fûe_exã¡_ôem
);

1367 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERY_VERBOSE
)

1368 
	`¥_öfo
("extent_data:Åype %u, disk_bytenr = %llu, offset = %llu,Çum_bytes = %llu\n",

1369 
fûe_exã¡_ôem
.
ty≥
,

1370 
	`båfs_°ack_fûe_exã¡_disk_byãƒ
(&
fûe_exã¡_ôem
),

1371 
	`båfs_°ack_fûe_exã¡_off£t
(&
fûe_exã¡_ôem
),

1372 
num_byãs
);

1373 
num_byãs
 > 0) {

1374 
u32
 
chunk_Àn
;

1375 
num_c›õs
;

1376 
múr‹_num
;

1378 i‡(
num_byãs
 > 
°©e
->
d©ablock_size
)

1379 
chunk_Àn
 = 
°©e
->
d©ablock_size
;

1381 
chunk_Àn
 = 
num_byãs
;

1383 
num_c›õs
 = 
	`båfs_num_c›õs
(
fs_öfo
, 
√xt_byãƒ
,

1384 
°©e
->
d©ablock_size
);

1385 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_NUM_COPIES
)

1386 
	`¥_öfo
("num_copies(log_bytenr=%llu) = %d\n",

1387 
√xt_byãƒ
, 
num_c›õs
);

1388 
múr‹_num
 = 1; múr‹_num <
num_c›õs
; mirror_num++) {

1389 
båfsic_block_d©a_˘x
 
√xt_block_˘x
;

1390 
båfsic_block
 *
√xt_block
;

1391 
block_was_¸óãd
;

1393 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1394 
	`¥_öfo
("btrfsic_handle_extent_data(mirror_num=%d)\n",

1395 
múr‹_num
);

1396 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERY_VERBOSE
)

1397 
	`¥_öfo
("\tdisk_bytenr = %llu,Çum_bytes %u\n",

1398 
√xt_byãƒ
, 
chunk_Àn
);

1399 
ªt
 = 
	`båfsic_m≠_block
(
°©e
, 
√xt_byãƒ
,

1400 
chunk_Àn
, &
√xt_block_˘x
,

1401 
múr‹_num
);

1402 i‡(
ªt
) {

1403 
	`¥_öfo
("btrfsic: btrfsic_map_block(@%llu, mirror=%d) failed!\n",

1404 
√xt_byãƒ
, 
múr‹_num
);

1408 
√xt_block
 = 
	`båfsic_block_lookup_‹_add
(

1409 
°©e
,

1410 &
√xt_block_˘x
,

1413 
f‹˚_iod⁄e_Êag
,

1414 !
f‹˚_iod⁄e_Êag
,

1415 
múr‹_num
,

1416 &
block_was_¸óãd
);

1417 i‡(
NULL
 =
√xt_block
) {

1418 
	`båfsic_ªÀa£_block_˘x
(&
√xt_block_˘x
);

1421 i‡(!
block_was_¸óãd
) {

1422 i‡((
°©e
->
¥öt_mask
 &

1423 
BTRFSIC_PRINT_MASK_VERBOSE
) &&

1424 
√xt_block
->
logiˇl_byãƒ
 !
√xt_byãƒ
 &&

1425 !(!
√xt_block
->
is_mëad©a
 &&

1426 0 =
√xt_block
->
logiˇl_byãƒ
)) {

1427 
	`¥_öfo
(

1429 
√xt_byãƒ
,

1430 
√xt_block_˘x
.
dev
->
bdev
,

1431 
√xt_block_˘x
.
dev_byãƒ
,

1432 
múr‹_num
,

1433 
√xt_block
->
logiˇl_byãƒ
);

1435 
√xt_block
->
logiˇl_byãƒ
 = 
√xt_byãƒ
;

1436 
√xt_block
->
múr‹_num
 = mirror_num;

1439 
l
 = 
	`båfsic_block_lök_lookup_‹_add
(
°©e
,

1440 &
√xt_block_˘x
,

1441 
√xt_block
, 
block
,

1442 
gíî©i⁄
);

1443 
	`båfsic_ªÀa£_block_˘x
(&
√xt_block_˘x
);

1444 i‡(
NULL
 =
l
)

1448 
√xt_byãƒ
 +
chunk_Àn
;

1449 
num_byãs
 -
chunk_Àn
;

1453 
	}
}

1455 
	$båfsic_m≠_block
(
båfsic_°©e
 *
°©e
, 
u64
 
byãƒ
, 
u32
 
Àn
,

1456 
båfsic_block_d©a_˘x
 *
block_˘x_out
,

1457 
múr‹_num
)

1459 
båfs_fs_öfo
 *
fs_öfo
 = 
°©e
->fs_info;

1460 
ªt
;

1461 
u64
 
Àngth
;

1462 
båfs_io_c⁄ãxt
 *
bioc
 = 
NULL
;

1463 
båfs_io_°rùe
 
sm≠
, *
m≠
;

1464 
båfs_devi˚
 *
devi˚
;

1466 
Àngth
 = 
Àn
;

1467 
ªt
 = 
	`båfs_m≠_block
(
fs_öfo
, 
BTRFS_MAP_READ
, 
byãƒ
, &
Àngth
, &
bioc
,

1468 
NULL
, &
múr‹_num
, 0);

1469 i‡(
ªt
) {

1470 
block_˘x_out
->
°¨t
 = 0;

1471 
block_˘x_out
->
dev_byãƒ
 = 0;

1472 
block_˘x_out
->
Àn
 = 0;

1473 
block_˘x_out
->
dev
 = 
NULL
;

1474 
block_˘x_out
->
d©av
 = 
NULL
;

1475 
block_˘x_out
->
∑gev
 = 
NULL
;

1476 
block_˘x_out
->
mem_to_‰ì
 = 
NULL
;

1478  
ªt
;

1481 i‡(
bioc
)

1482 
m≠
 = &
bioc
->
°rùes
[0];

1484 
m≠
 = &
sm≠
;

1486 
devi˚
 = 
m≠
->
dev
;

1487 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
, &
devi˚
->
dev_°©e
) ||

1488 !
devi˚
->
bdev
 || !devi˚->
«me
)

1489 
block_˘x_out
->
dev
 = 
NULL
;

1491 
block_˘x_out
->
dev
 = 
	`båfsic_dev_°©e_lookup
(

1492 
devi˚
->
bdev
->
bd_dev
);

1493 
block_˘x_out
->
dev_byãƒ
 = 
m≠
->
physiˇl
;

1494 
block_˘x_out
->
°¨t
 = 
byãƒ
;

1495 
block_˘x_out
->
Àn
 =Üen;

1496 
block_˘x_out
->
d©av
 = 
NULL
;

1497 
block_˘x_out
->
∑gev
 = 
NULL
;

1498 
block_˘x_out
->
mem_to_‰ì
 = 
NULL
;

1500 
	`k‰ì
(
bioc
);

1501 i‡(
NULL
 =
block_˘x_out
->
dev
) {

1502 
ªt
 = -
ENXIO
;

1503 
	`¥_öfo
("btrfsic:Érror, cannotÜookup dev (#1)!\n");

1506  
ªt
;

1507 
	}
}

1509 
	$båfsic_ªÀa£_block_˘x
(
båfsic_block_d©a_˘x
 *
block_˘x
)

1511 i‡(
block_˘x
->
mem_to_‰ì
) {

1512 
num_∑ges
;

1514 
	`BUG_ON
(!
block_˘x
->
d©av
);

1515 
	`BUG_ON
(!
block_˘x
->
∑gev
);

1516 
num_∑ges
 = (
block_˘x
->
Àn
 + (
u64
)
PAGE_SIZE
 - 1) >>

1517 
PAGE_SHIFT
;

1519 
num_∑ges
 > 0) {

1520 
num_∑ges
--;

1521 i‡(
block_˘x
->
d©av
[
num_∑ges
])

1522 
block_˘x
->
d©av
[
num_∑ges
] = 
NULL
;

1523 i‡(
block_˘x
->
∑gev
[
num_∑ges
]) {

1524 
	`__‰ì_∑ge
(
block_˘x
->
∑gev
[
num_∑ges
]);

1525 
block_˘x
->
∑gev
[
num_∑ges
] = 
NULL
;

1529 
	`k‰ì
(
block_˘x
->
mem_to_‰ì
);

1530 
block_˘x
->
mem_to_‰ì
 = 
NULL
;

1531 
block_˘x
->
∑gev
 = 
NULL
;

1532 
block_˘x
->
d©av
 = 
NULL
;

1534 
	}
}

1536 
	$båfsic_ªad_block
(
båfsic_°©e
 *
°©e
,

1537 
båfsic_block_d©a_˘x
 *
block_˘x
)

1539 
num_∑ges
;

1540 
i
;

1541 
size_t
 
size
;

1542 
u64
 
dev_byãƒ
;

1543 
ªt
;

1545 
	`BUG_ON
(
block_˘x
->
d©av
);

1546 
	`BUG_ON
(
block_˘x
->
∑gev
);

1547 
	`BUG_ON
(
block_˘x
->
mem_to_‰ì
);

1548 i‡(!
	`PAGE_ALIGNED
(
block_˘x
->
dev_byãƒ
)) {

1549 
	`¥_öfo
("btrfsic:Ñead_block() with unaligned bytenr %llu\n",

1550 
block_˘x
->
dev_byãƒ
);

1554 
num_∑ges
 = (
block_˘x
->
Àn
 + (
u64
)
PAGE_SIZE
 - 1) >>

1555 
PAGE_SHIFT
;

1556 
size
 = (*
block_˘x
->
d©av
Ë+ (*block_˘x->
∑gev
);

1557 
block_˘x
->
mem_to_‰ì
 = 
	`kˇŒoc
(
num_∑ges
, 
size
, 
GFP_NOFS
);

1558 i‡(!
block_˘x
->
mem_to_‰ì
)

1559  -
ENOMEM
;

1560 
block_˘x
->
d©av
 = block_˘x->
mem_to_‰ì
;

1561 
block_˘x
->
∑gev
 = (
∑ge
 **)(block_˘x->
d©av
 + 
num_∑ges
);

1562 
ªt
 = 
	`båfs_Æloc_∑ge_¨øy
(
num_∑ges
, 
block_˘x
->
∑gev
);

1563 i‡(
ªt
)

1564  
ªt
;

1566 
dev_byãƒ
 = 
block_˘x
->dev_bytenr;

1567 
i
 = 0; i < 
num_∑ges
;) {

1568 
bio
 *bio;

1569 
j
;

1571 
bio
 = 
	`bio_Æloc
(
block_˘x
->
dev
->
bdev
, 
num_∑ges
 - 
i
,

1572 
REQ_OP_READ
, 
GFP_NOFS
);

1573 
bio
->
bi_ôî
.
bi_£˘‹
 = 
dev_byãƒ
 >> 
SECTOR_SHIFT
;

1575 
j
 = 
i
; j < 
num_∑ges
; j++) {

1576 
ªt
 = 
	`bio_add_∑ge
(
bio
, 
block_˘x
->
∑gev
[
j
],

1577 
PAGE_SIZE
, 0);

1578 i‡(
PAGE_SIZE
 !
ªt
)

1581 i‡(
j
 =
i
) {

1582 
	`¥_öfo
("btrfsic:Érror, failedÅoáddá singleÖage!\n");

1585 i‡(
	`submô_bio_waô
(
bio
)) {

1586 
	`¥_öfo
("btrfsic:ÑeadÉrrorátÜogical %llu dev %pg!\n",

1587 
block_˘x
->
°¨t
, block_˘x->
dev
->
bdev
);

1588 
	`bio_put
(
bio
);

1591 
	`bio_put
(
bio
);

1592 
dev_byãƒ
 +(
j
 - 
i
Ë* 
PAGE_SIZE
;

1593 
i
 = 
j
;

1595 
i
 = 0; i < 
num_∑ges
; i++)

1596 
block_˘x
->
d©av
[
i
] = 
	`∑ge_addªss
(block_˘x->
∑gev
[i]);

1598  
block_˘x
->
Àn
;

1599 
	}
}

1601 
	$båfsic_dump_d©aba£
(
båfsic_°©e
 *
°©e
)

1603 c⁄° 
båfsic_block
 *
b_Æl
;

1605 
	`BUG_ON
(
NULL
 =
°©e
);

1607 
	`¥_öfo
("all_blocks_list:\n");

1608 
	`li°_f‹_óch_íåy
(
b_Æl
, &
°©e
->
Æl_blocks_li°
, 
Æl_blocks_node
) {

1609 c⁄° 
båfsic_block_lök
 *
l
;

1611 
	`¥_öfo
("%c-block @%llu (%pg/%llu/%d)\n",

1612 
	`båfsic_gë_block_ty≥
(
°©e
, 
b_Æl
),

1613 
b_Æl
->
logiˇl_byãƒ
, b_Æl->
dev_°©e
->
bdev
,

1614 
b_Æl
->
dev_byãƒ
, b_Æl->
múr‹_num
);

1616 
	`li°_f‹_óch_íåy
(
l
, &
b_Æl
->
ªf_to_li°
, 
node_ªf_to
) {

1617 
	`¥_öfo
(

1619 
	`båfsic_gë_block_ty≥
(
°©e
, 
b_Æl
),

1620 
b_Æl
->
logiˇl_byãƒ
, b_Æl->
dev_°©e
->
bdev
,

1621 
b_Æl
->
dev_byãƒ
, b_Æl->
múr‹_num
,

1622 
l
->
ªf_˙t
,

1623 
	`båfsic_gë_block_ty≥
(
°©e
, 
l
->
block_ªf_to
),

1624 
l
->
block_ªf_to
->
logiˇl_byãƒ
,

1625 
l
->
block_ªf_to
->
dev_°©e
->
bdev
,

1626 
l
->
block_ªf_to
->
dev_byãƒ
,

1627 
l
->
block_ªf_to
->
múr‹_num
);

1630 
	`li°_f‹_óch_íåy
(
l
, &
b_Æl
->
ªf_‰om_li°
, 
node_ªf_‰om
) {

1631 
	`¥_öfo
(

1633 
	`båfsic_gë_block_ty≥
(
°©e
, 
b_Æl
),

1634 
b_Æl
->
logiˇl_byãƒ
, b_Æl->
dev_°©e
->
bdev
,

1635 
b_Æl
->
dev_byãƒ
, b_Æl->
múr‹_num
,

1636 
l
->
ªf_˙t
,

1637 
	`båfsic_gë_block_ty≥
(
°©e
, 
l
->
block_ªf_‰om
),

1638 
l
->
block_ªf_‰om
->
logiˇl_byãƒ
,

1639 
l
->
block_ªf_‰om
->
dev_°©e
->
bdev
,

1640 
l
->
block_ªf_‰om
->
dev_byãƒ
,

1641 
l
->
block_ªf_‰om
->
múr‹_num
);

1644 
	`¥_öfo
("\n");

1646 
	}
}

1652 
noölöe_f‹_°ack
 
	$båfsic_ã°_f‹_mëad©a
(

1653 
båfsic_°©e
 *
°©e
,

1654 **
d©av
, 
num_∑ges
)

1656 
båfs_fs_öfo
 *
fs_öfo
 = 
°©e
->fs_info;

1657 
	`SHASH_DESC_ON_STACK
(
shash
, 
fs_öfo
->
csum_shash
);

1658 
båfs_hódî
 *
h
;

1659 
u8
 
csum
[
BTRFS_CSUM_SIZE
];

1660 
i
;

1662 i‡(
num_∑ges
 * 
PAGE_SIZE
 < 
°©e
->
mëablock_size
)

1664 
num_∑ges
 = 
°©e
->
mëablock_size
 >> 
PAGE_SHIFT
;

1665 
h
 = (
båfs_hódî
 *)
d©av
[0];

1667 i‡(
	`memcmp
(
h
->
fsid
, 
fs_öfo
->
fs_devi˚s
->fsid, 
BTRFS_FSID_SIZE
))

1670 
shash
->
tfm
 = 
fs_öfo
->
csum_shash
;

1671 
	`¸y±o_shash_öô
(
shash
);

1673 
i
 = 0; i < 
num_∑ges
; i++) {

1674 
u8
 *
d©a
 = 
i
 ? 
d©av
[i] : (d©av[i] + 
BTRFS_CSUM_SIZE
);

1675 
size_t
 
subÀn
 = 
i
 ? 
PAGE_SIZE
 :

1676 (
PAGE_SIZE
 - 
BTRFS_CSUM_SIZE
);

1678 
	`¸y±o_shash_upd©e
(
shash
, 
d©a
, 
subÀn
);

1680 
	`¸y±o_shash_föÆ
(
shash
, 
csum
);

1681 i‡(
	`memcmp
(
csum
, 
h
->csum, 
fs_öfo
->
csum_size
))

1685 
	}
}

1687 
	$båfsic_¥o˚ss_wrôãn_block
(
båfsic_dev_°©e
 *
dev_°©e
,

1688 
u64
 
dev_byãƒ
, **
m≠≥d_d©av
,

1689 
num_∑ges
,

1690 
bio
 *bio, *
bio_is_∑tched
,

1691 
blk_›f_t
 
submô_bio_bh_rw
)

1693 
is_mëad©a
;

1694 
båfsic_block
 *
block
;

1695 
båfsic_block_d©a_˘x
 
block_˘x
;

1696 
ªt
;

1697 
båfsic_°©e
 *
°©e
 = 
dev_°©e
->state;

1698 
block_devi˚
 *
bdev
 = 
dev_°©e
->bdev;

1699 
¥o˚s£d_Àn
;

1701 i‡(
NULL
 !
bio_is_∑tched
)

1702 *
bio_is_∑tched
 = 0;

1704 
agaö
:

1705 i‡(
num_∑ges
 == 0)

1708 
¥o˚s£d_Àn
 = 0;

1709 
is_mëad©a
 = (0 =
	`båfsic_ã°_f‹_mëad©a
(
°©e
, 
m≠≥d_d©av
,

1710 
num_∑ges
));

1712 
block
 = 
	`båfsic_block_hashèbÀ_lookup
(
bdev
, 
dev_byãƒ
,

1713 &
°©e
->
block_hashèbÀ
);

1714 i‡(
NULL
 !
block
) {

1715 
u64
 
byãƒ
 = 0;

1716 
båfsic_block_lök
 *
l
, *
tmp
;

1718 i‡(
block
->
is_su≥rblock
) {

1719 
byãƒ
 = 
	`båfs_su≥r_byãƒ
((
båfs_su≥r_block
 *)

1720 
m≠≥d_d©av
[0]);

1721 i‡(
num_∑ges
 * 
PAGE_SIZE
 <

1722 
BTRFS_SUPER_INFO_SIZE
) {

1723 
	`¥_öfo
("btrfsic: cannot work withÅoo short bios!\n");

1726 
is_mëad©a
 = 1;

1727 
	`BUG_ON
(!
	`PAGE_ALIGNED
(
BTRFS_SUPER_INFO_SIZE
));

1728 
¥o˚s£d_Àn
 = 
BTRFS_SUPER_INFO_SIZE
;

1729 i‡(
°©e
->
¥öt_mask
 &

1730 
BTRFSIC_PRINT_MASK_TREE_BEFORE_SB_WRITE
) {

1731 
	`¥_öfo
("[beforeÇew superblock is written]:\n");

1732 
	`båfsic_dump_åì_sub
(
°©e
, 
block
, 0);

1735 i‡(
is_mëad©a
) {

1736 i‡(!
block
->
is_su≥rblock
) {

1737 i‡(
num_∑ges
 * 
PAGE_SIZE
 <

1738 
°©e
->
mëablock_size
) {

1739 
	`¥_öfo
("btrfsic: cannot work withÅoo short bios!\n");

1742 
¥o˚s£d_Àn
 = 
°©e
->
mëablock_size
;

1743 
byãƒ
 = 
	`båfs_°ack_hódî_byãƒ
(

1744 (
båfs_hódî
 *)

1745 
m≠≥d_d©av
[0]);

1746 
	`båfsic_cmp_log_™d_dev_byãƒ
(
°©e
, 
byãƒ
,

1747 
dev_°©e
,

1748 
dev_byãƒ
);

1750 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
) {

1751 i‡(
block
->
logiˇl_byãƒ
 !
byãƒ
 &&

1752 !(!
block
->
is_mëad©a
 &&

1753 
block
->
logiˇl_byãƒ
 == 0))

1754 
	`¥_öfo
(

1756 
byãƒ
, 
dev_°©e
->
bdev
,

1757 
dev_byãƒ
,

1758 
block
->
múr‹_num
,

1759 
	`båfsic_gë_block_ty≥
(
°©e
,

1760 
block
),

1761 
block
->
logiˇl_byãƒ
);

1763 
	`¥_öfo
(

1765 
byãƒ
, 
dev_°©e
->
bdev
,

1766 
dev_byãƒ
, 
block
->
múr‹_num
,

1767 
	`båfsic_gë_block_ty≥
(
°©e
,

1768 
block
));

1770 
block
->
logiˇl_byãƒ
 = 
byãƒ
;

1772 i‡(
num_∑ges
 * 
PAGE_SIZE
 <

1773 
°©e
->
d©ablock_size
) {

1774 
	`¥_öfo
("btrfsic: cannot work withÅoo short bios!\n");

1777 
¥o˚s£d_Àn
 = 
°©e
->
d©ablock_size
;

1778 
byãƒ
 = 
block
->
logiˇl_byãƒ
;

1779 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1780 
	`¥_öfo
(

1782 
byãƒ
, 
dev_°©e
->
bdev
, 
dev_byãƒ
,

1783 
block
->
múr‹_num
,

1784 
	`båfsic_gë_block_ty≥
(
°©e
, 
block
));

1787 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1788 
	`¥_öfo
("ref_to_list: %cE,Ñef_from_list: %cE\n",

1789 
	`li°_em±y
(&
block
->
ªf_to_li°
) ? ' ' : '!',

1790 
	`li°_em±y
(&
block
->
ªf_‰om_li°
) ? ' ' : '!');

1791 i‡(
	`båfsic_is_block_ªf_by_su≥rblock
(
°©e
, 
block
, 0)) {

1792 
	`¥_öfo
(

1794 
	`båfsic_gë_block_ty≥
(
°©e
, 
block
), 
byãƒ
,

1795 
dev_°©e
->
bdev
, 
dev_byãƒ
, 
block
->
múr‹_num
,

1796 
block
->
gíî©i⁄
,

1797 
	`båfs_disk_key_obje˘id
(&
block
->
disk_key
),

1798 
block
->
disk_key
.
ty≥
,

1799 
	`båfs_disk_key_off£t
(&
block
->
disk_key
),

1800 
	`båfs_°ack_hódî_gíî©i⁄
(

1801 (
båfs_hódî
 *Ë
m≠≥d_d©av
[0]),

1802 
°©e
->
max_su≥rblock_gíî©i⁄
);

1803 
	`båfsic_dump_åì
(
°©e
);

1806 i‡(!
block
->
is_iod⁄e
 && !block->
√vî_wrôãn
) {

1807 
	`¥_öfo
(

1809 
	`båfsic_gë_block_ty≥
(
°©e
, 
block
), 
byãƒ
,

1810 
dev_°©e
->
bdev
, 
dev_byãƒ
, 
block
->
múr‹_num
,

1811 
block
->
gíî©i⁄
,

1812 
	`båfs_°ack_hódî_gíî©i⁄
(

1813 (
båfs_hódî
 *)

1814 
m≠≥d_d©av
[0]));

1816 
	`båfsic_dump_åì
(
°©e
);

1817 
c⁄töue_lo›
;

1826 
	`li°_f‹_óch_íåy_ß„
(
l
, 
tmp
, &
block
->
ªf_to_li°
,

1827 
node_ªf_to
) {

1828 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1829 
	`båfsic_¥öt_ªm_lök
(
°©e
, 
l
);

1830 
l
->
ªf_˙t
--;

1831 i‡(0 =
l
->
ªf_˙t
) {

1832 
	`li°_dñ
(&
l
->
node_ªf_to
);

1833 
	`li°_dñ
(&
l
->
node_ªf_‰om
);

1834 
	`båfsic_block_lök_hashèbÀ_ªmove
(
l
);

1835 
	`båfsic_block_lök_‰ì
(
l
);

1839 
block_˘x
.
dev
 = 
dev_°©e
;

1840 
block_˘x
.
dev_byãƒ
 = dev_bytenr;

1841 
block_˘x
.
°¨t
 = 
byãƒ
;

1842 
block_˘x
.
Àn
 = 
¥o˚s£d_Àn
;

1843 
block_˘x
.
∑gev
 = 
NULL
;

1844 
block_˘x
.
mem_to_‰ì
 = 
NULL
;

1845 
block_˘x
.
d©av
 = 
m≠≥d_d©av
;

1847 i‡(
is_mëad©a
 || 
°©e
->
ö˛ude_exã¡_d©a
) {

1848 
block
->
√vî_wrôãn
 = 0;

1849 
block
->
iod⁄e_w_îr‹
 = 0;

1850 i‡(
NULL
 !
bio
) {

1851 
block
->
is_iod⁄e
 = 0;

1852 
	`BUG_ON
(
NULL
 =
bio_is_∑tched
);

1853 i‡(!*
bio_is_∑tched
) {

1854 
block
->
‹ig_bio_¥iv©e
 =

1855 
bio
->
bi_¥iv©e
;

1856 
block
->
‹ig_bio_íd_io
 =

1857 
bio
->
bi_íd_io
;

1858 
block
->
√xt_ö_ßme_bio
 = 
NULL
;

1859 
bio
->
bi_¥iv©e
 = 
block
;

1860 
bio
->
bi_íd_io
 = 
båfsic_bio_íd_io
;

1861 *
bio_is_∑tched
 = 1;

1863 
båfsic_block
 *
chaöed_block
 =

1864 (
båfsic_block
 *)

1865 
bio
->
bi_¥iv©e
;

1867 
	`BUG_ON
(
NULL
 =
chaöed_block
);

1868 
block
->
‹ig_bio_¥iv©e
 =

1869 
chaöed_block
->
‹ig_bio_¥iv©e
;

1870 
block
->
‹ig_bio_íd_io
 =

1871 
chaöed_block
->
‹ig_bio_íd_io
;

1872 
block
->
√xt_ö_ßme_bio
 = 
chaöed_block
;

1873 
bio
->
bi_¥iv©e
 = 
block
;

1876 
block
->
is_iod⁄e
 = 1;

1877 
block
->
‹ig_bio_¥iv©e
 = 
NULL
;

1878 
block
->
‹ig_bio_íd_io
 = 
NULL
;

1879 
block
->
√xt_ö_ßme_bio
 = 
NULL
;

1883 
block
->
Êush_gí
 = 
dev_°©e
->
œ°_Êush_gí
 + 1;

1884 
block
->
submô_bio_bh_rw
 = submit_bio_bh_rw;

1885 i‡(
is_mëad©a
) {

1886 
block
->
logiˇl_byãƒ
 = 
byãƒ
;

1887 
block
->
is_mëad©a
 = 1;

1888 i‡(
block
->
is_su≥rblock
) {

1889 
	`BUG_ON
(
PAGE_SIZE
 !=

1890 
BTRFS_SUPER_INFO_SIZE
);

1891 
ªt
 = 
	`båfsic_¥o˚ss_wrôãn_su≥rblock
(

1892 
°©e
,

1893 
block
,

1894 (
båfs_su≥r_block
 *)

1895 
m≠≥d_d©av
[0]);

1896 i‡(
°©e
->
¥öt_mask
 &

1897 
BTRFSIC_PRINT_MASK_TREE_AFTER_SB_WRITE
) {

1898 
	`¥_öfo
("[afterÇew superblock is written]:\n");

1899 
	`båfsic_dump_åì_sub
(
°©e
, 
block
, 0);

1902 
block
->
múr‹_num
 = 0;

1903 
ªt
 = 
	`båfsic_¥o˚ss_mëablock
(

1904 
°©e
,

1905 
block
,

1906 &
block_˘x
,

1909 i‡(
ªt
)

1910 
	`¥_öfo
("btrfsic: btrfsic_process_metablock(root @%llu) failed!\n",

1911 
dev_byãƒ
);

1913 
block
->
is_mëad©a
 = 0;

1914 
block
->
múr‹_num
 = 0;

1915 
block
->
gíî©i⁄
 = 
BTRFSIC_GENERATION_UNKNOWN
;

1916 i‡(!
°©e
->
ö˛ude_exã¡_d©a


1917 && 
	`li°_em±y
(&
block
->
ªf_‰om_li°
)) {

1924 
	`båfsic_block_hashèbÀ_ªmove
(
block
);

1925 
	`li°_dñ
(&
block
->
Æl_blocks_node
);

1926 
	`båfsic_block_‰ì
(
block
);

1929 
	`båfsic_ªÀa£_block_˘x
(&
block_˘x
);

1932 
u64
 
byãƒ
;

1934 i‡(!
is_mëad©a
) {

1935 
¥o˚s£d_Àn
 = 
°©e
->
d©ablock_size
;

1936 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1937 
	`¥_öfo
(

1939 
dev_°©e
->
bdev
, 
dev_byãƒ
);

1940 i‡(!
°©e
->
ö˛ude_exã¡_d©a
) {

1942 
c⁄töue_lo›
;

1947 
byãƒ
 = 0;

1949 
¥o˚s£d_Àn
 = 
°©e
->
mëablock_size
;

1950 
byãƒ
 = 
	`båfs_°ack_hódî_byãƒ
(

1951 (
båfs_hódî
 *)

1952 
m≠≥d_d©av
[0]);

1953 
	`båfsic_cmp_log_™d_dev_byãƒ
(
°©e
, 
byãƒ
, 
dev_°©e
,

1954 
dev_byãƒ
);

1955 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1956 
	`¥_öfo
(

1958 
byãƒ
, 
dev_°©e
->
bdev
, 
dev_byãƒ
);

1961 
block_˘x
.
dev
 = 
dev_°©e
;

1962 
block_˘x
.
dev_byãƒ
 = dev_bytenr;

1963 
block_˘x
.
°¨t
 = 
byãƒ
;

1964 
block_˘x
.
Àn
 = 
¥o˚s£d_Àn
;

1965 
block_˘x
.
∑gev
 = 
NULL
;

1966 
block_˘x
.
mem_to_‰ì
 = 
NULL
;

1967 
block_˘x
.
d©av
 = 
m≠≥d_d©av
;

1969 
block
 = 
	`båfsic_block_Æloc
();

1970 i‡(
NULL
 =
block
) {

1971 
	`båfsic_ªÀa£_block_˘x
(&
block_˘x
);

1972 
c⁄töue_lo›
;

1974 
block
->
dev_°©e
 = dev_state;

1975 
block
->
dev_byãƒ
 = dev_bytenr;

1976 
block
->
logiˇl_byãƒ
 = 
byãƒ
;

1977 
block
->
is_mëad©a
 = is_metadata;

1978 
block
->
√vî_wrôãn
 = 0;

1979 
block
->
iod⁄e_w_îr‹
 = 0;

1980 
block
->
múr‹_num
 = 0;

1981 
block
->
Êush_gí
 = 
dev_°©e
->
œ°_Êush_gí
 + 1;

1982 
block
->
submô_bio_bh_rw
 = submit_bio_bh_rw;

1983 i‡(
NULL
 !
bio
) {

1984 
block
->
is_iod⁄e
 = 0;

1985 
	`BUG_ON
(
NULL
 =
bio_is_∑tched
);

1986 i‡(!*
bio_is_∑tched
) {

1987 
block
->
‹ig_bio_¥iv©e
 = 
bio
->
bi_¥iv©e
;

1988 
block
->
‹ig_bio_íd_io
 = 
bio
->
bi_íd_io
;

1989 
block
->
√xt_ö_ßme_bio
 = 
NULL
;

1990 
bio
->
bi_¥iv©e
 = 
block
;

1991 
bio
->
bi_íd_io
 = 
båfsic_bio_íd_io
;

1992 *
bio_is_∑tched
 = 1;

1994 
båfsic_block
 *
chaöed_block
 =

1995 (
båfsic_block
 *)

1996 
bio
->
bi_¥iv©e
;

1998 
	`BUG_ON
(
NULL
 =
chaöed_block
);

1999 
block
->
‹ig_bio_¥iv©e
 =

2000 
chaöed_block
->
‹ig_bio_¥iv©e
;

2001 
block
->
‹ig_bio_íd_io
 =

2002 
chaöed_block
->
‹ig_bio_íd_io
;

2003 
block
->
√xt_ö_ßme_bio
 = 
chaöed_block
;

2004 
bio
->
bi_¥iv©e
 = 
block
;

2007 
block
->
is_iod⁄e
 = 1;

2008 
block
->
‹ig_bio_¥iv©e
 = 
NULL
;

2009 
block
->
‹ig_bio_íd_io
 = 
NULL
;

2010 
block
->
√xt_ö_ßme_bio
 = 
NULL
;

2012 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2013 
	`¥_öfo
("new written %c-block @%llu (%pg/%llu/%d)\n",

2014 
is_mëad©a
 ? 'M' : 'D',

2015 
block
->
logiˇl_byãƒ
, block->
dev_°©e
->
bdev
,

2016 
block
->
dev_byãƒ
, block->
múr‹_num
);

2017 
	`li°_add
(&
block
->
Æl_blocks_node
, &
°©e
->
Æl_blocks_li°
);

2018 
	`båfsic_block_hashèbÀ_add
(
block
, &
°©e
->
block_hashèbÀ
);

2020 i‡(
is_mëad©a
) {

2021 
ªt
 = 
	`båfsic_¥o˚ss_mëablock
(
°©e
, 
block
,

2022 &
block_˘x
, 0, 0);

2023 i‡(
ªt
)

2024 
	`¥_öfo
("btrfsic:Örocess_metablock(root @%llu) failed!\n",

2025 
dev_byãƒ
);

2027 
	`båfsic_ªÀa£_block_˘x
(&
block_˘x
);

2030 
c⁄töue_lo›
:

2031 
	`BUG_ON
(!
¥o˚s£d_Àn
);

2032 
dev_byãƒ
 +
¥o˚s£d_Àn
;

2033 
m≠≥d_d©av
 +
¥o˚s£d_Àn
 >> 
PAGE_SHIFT
;

2034 
num_∑ges
 -
¥o˚s£d_Àn
 >> 
PAGE_SHIFT
;

2035 
agaö
;

2036 
	}
}

2038 
	$båfsic_bio_íd_io
(
bio
 *
bp
)

2040 
båfsic_block
 *
block
 = 
bp
->
bi_¥iv©e
;

2041 
iod⁄e_w_îr‹
;

2045 
iod⁄e_w_îr‹
 = 0;

2046 i‡(
bp
->
bi_°©us
)

2047 
iod⁄e_w_îr‹
 = 1;

2049 
	`BUG_ON
(
NULL
 =
block
);

2050 
bp
->
bi_¥iv©e
 = 
block
->
‹ig_bio_¥iv©e
;

2051 
bp
->
bi_íd_io
 = 
block
->
‹ig_bio_íd_io
;

2054 
båfsic_block
 *
√xt_block
;

2055 
båfsic_dev_°©e
 *c⁄° 
dev_°©e
 = 
block
->dev_state;

2057 i‡((
dev_°©e
->
°©e
->
¥öt_mask
 &

2058 
BTRFSIC_PRINT_MASK_END_IO_BIO_BH
))

2059 
	`¥_öfo
("bio_end_io(err=%d) for %c @%llu (%pg/%llu/%d)\n",

2060 
bp
->
bi_°©us
,

2061 
	`båfsic_gë_block_ty≥
(
dev_°©e
->
°©e
, 
block
),

2062 
block
->
logiˇl_byãƒ
, 
dev_°©e
->
bdev
,

2063 
block
->
dev_byãƒ
, block->
múr‹_num
);

2064 
√xt_block
 = 
block
->
√xt_ö_ßme_bio
;

2065 
block
->
iod⁄e_w_îr‹
 = iodone_w_error;

2066 i‡(
block
->
submô_bio_bh_rw
 & 
REQ_PREFLUSH
) {

2067 
dev_°©e
->
œ°_Êush_gí
++;

2068 i‡((
dev_°©e
->
°©e
->
¥öt_mask
 &

2069 
BTRFSIC_PRINT_MASK_END_IO_BIO_BH
))

2070 
	`¥_öfo
("bio_end_io()Çew %pg flush_gen=%llu\n",

2071 
dev_°©e
->
bdev
,

2072 
dev_°©e
->
œ°_Êush_gí
);

2074 i‡(
block
->
submô_bio_bh_rw
 & 
REQ_FUA
)

2075 
block
->
Êush_gí
 = 0;

2077 
block
->
is_iod⁄e
 = 1;

2078 
block
 = 
√xt_block
;

2079 } 
NULL
 !
block
);

2081 
bp
->
	`bi_íd_io
(bp);

2082 
	}
}

2084 
	$båfsic_¥o˚ss_wrôãn_su≥rblock
(

2085 
båfsic_°©e
 *
°©e
,

2086 
båfsic_block
 *c⁄° 
su≥rblock
,

2087 
båfs_su≥r_block
 *c⁄° 
su≥r_hdr
)

2089 
båfs_fs_öfo
 *
fs_öfo
 = 
°©e
->fs_info;

2090 
∑ss
;

2092 
su≥rblock
->
gíî©i⁄
 = 
	`båfs_su≥r_gíî©i⁄
(
su≥r_hdr
);

2093 i‡(!(
su≥rblock
->
gíî©i⁄
 > 
°©e
->
max_su≥rblock_gíî©i⁄
 ||

2094 0 =
°©e
->
max_su≥rblock_gíî©i⁄
)) {

2095 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_SUPERBLOCK_WRITE
)

2096 
	`¥_öfo
(

2098 
su≥rblock
->
logiˇl_byãƒ
,

2099 
su≥rblock
->
dev_°©e
->
bdev
,

2100 
su≥rblock
->
dev_byãƒ
, su≥rblock->
múr‹_num
,

2101 
	`båfs_su≥r_gíî©i⁄
(
su≥r_hdr
),

2102 
°©e
->
max_su≥rblock_gíî©i⁄
);

2104 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_SUPERBLOCK_WRITE
)

2105 
	`¥_öfo
(

2107 
su≥rblock
->
logiˇl_byãƒ
,

2108 
su≥rblock
->
dev_°©e
->
bdev
,

2109 
su≥rblock
->
dev_byãƒ
, su≥rblock->
múr‹_num
,

2110 
	`båfs_su≥r_gíî©i⁄
(
su≥r_hdr
),

2111 
°©e
->
max_su≥rblock_gíî©i⁄
);

2113 
°©e
->
max_su≥rblock_gíî©i⁄
 =

2114 
	`båfs_su≥r_gíî©i⁄
(
su≥r_hdr
);

2115 
°©e
->
œã°_su≥rblock
 = 
su≥rblock
;

2118 
∑ss
 = 0;Öass < 3;Öass++) {

2119 
ªt
;

2120 
u64
 
√xt_byãƒ
;

2121 
båfsic_block
 *
√xt_block
;

2122 
båfsic_block_d©a_˘x
 
tmp_√xt_block_˘x
;

2123 
båfsic_block_lök
 *
l
;

2124 
num_c›õs
;

2125 
múr‹_num
;

2126 c⁄° *
addôi⁄Æ_°rög
 = 
NULL
;

2127 
båfs_disk_key
 
tmp_disk_key
 = {0};

2129 
	`båfs_£t_disk_key_obje˘id
(&
tmp_disk_key
,

2130 
BTRFS_ROOT_ITEM_KEY
);

2131 
	`båfs_£t_disk_key_obje˘id
(&
tmp_disk_key
, 0);

2133 
∑ss
) {

2135 
	`båfs_£t_disk_key_obje˘id
(&
tmp_disk_key
,

2136 
BTRFS_ROOT_TREE_OBJECTID
);

2137 
addôi⁄Æ_°rög
 = "root ";

2138 
√xt_byãƒ
 = 
	`båfs_su≥r_roŸ
(
su≥r_hdr
);

2139 i‡(
°©e
->
¥öt_mask
 &

2140 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

2141 
	`¥_öfo
("roŸ@%Œu\n", 
√xt_byãƒ
);

2144 
	`båfs_£t_disk_key_obje˘id
(&
tmp_disk_key
,

2145 
BTRFS_CHUNK_TREE_OBJECTID
);

2146 
addôi⁄Æ_°rög
 = "chunk ";

2147 
√xt_byãƒ
 = 
	`båfs_su≥r_chunk_roŸ
(
su≥r_hdr
);

2148 i‡(
°©e
->
¥öt_mask
 &

2149 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

2150 
	`¥_öfo
("chunk@%Œu\n", 
√xt_byãƒ
);

2153 
	`båfs_£t_disk_key_obje˘id
(&
tmp_disk_key
,

2154 
BTRFS_TREE_LOG_OBJECTID
);

2155 
addôi⁄Æ_°rög
 = "log ";

2156 
√xt_byãƒ
 = 
	`båfs_su≥r_log_roŸ
(
su≥r_hdr
);

2157 i‡(0 =
√xt_byãƒ
)

2159 i‡(
°©e
->
¥öt_mask
 &

2160 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

2161 
	`¥_öfo
("log@%Œu\n", 
√xt_byãƒ
);

2165 
num_c›õs
 = 
	`båfs_num_c›õs
(
fs_öfo
, 
√xt_byãƒ
,

2166 
BTRFS_SUPER_INFO_SIZE
);

2167 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_NUM_COPIES
)

2168 
	`¥_öfo
("num_copies(log_bytenr=%llu) = %d\n",

2169 
√xt_byãƒ
, 
num_c›õs
);

2170 
múr‹_num
 = 1; múr‹_num <
num_c›õs
; mirror_num++) {

2171 
was_¸óãd
;

2173 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2174 
	`¥_öfo
("båfsic_¥o˚ss_wrôãn_su≥rblock(múr‹_num=%d)\n", 
múr‹_num
);

2175 
ªt
 = 
	`båfsic_m≠_block
(
°©e
, 
√xt_byãƒ
,

2176 
BTRFS_SUPER_INFO_SIZE
,

2177 &
tmp_√xt_block_˘x
,

2178 
múr‹_num
);

2179 i‡(
ªt
) {

2180 
	`¥_öfo
("btrfsic: btrfsic_map_block(@%llu, mirror=%d) failed!\n",

2181 
√xt_byãƒ
, 
múr‹_num
);

2185 
√xt_block
 = 
	`båfsic_block_lookup_‹_add
(

2186 
°©e
,

2187 &
tmp_√xt_block_˘x
,

2188 
addôi⁄Æ_°rög
,

2190 
múr‹_num
,

2191 &
was_¸óãd
);

2192 i‡(
NULL
 =
√xt_block
) {

2193 
	`båfsic_ªÀa£_block_˘x
(&
tmp_√xt_block_˘x
);

2197 
√xt_block
->
disk_key
 = 
tmp_disk_key
;

2198 i‡(
was_¸óãd
)

2199 
√xt_block
->
gíî©i⁄
 =

2200 
BTRFSIC_GENERATION_UNKNOWN
;

2201 
l
 = 
	`båfsic_block_lök_lookup_‹_add
(

2202 
°©e
,

2203 &
tmp_√xt_block_˘x
,

2204 
√xt_block
,

2205 
su≥rblock
,

2206 
BTRFSIC_GENERATION_UNKNOWN
);

2207 
	`båfsic_ªÀa£_block_˘x
(&
tmp_√xt_block_˘x
);

2208 i‡(
NULL
 =
l
)

2213 i‡(
	`WARN_ON
(-1 =
	`båfsic_check_Æl_ªf_blocks
(
°©e
, 
su≥rblock
, 0)))

2214 
	`båfsic_dump_åì
(
°©e
);

2217 
	}
}

2219 
	$båfsic_check_Æl_ªf_blocks
(
båfsic_°©e
 *
°©e
,

2220 
båfsic_block
 *c⁄° 
block
,

2221 
ªcursi⁄_Àvñ
)

2223 c⁄° 
båfsic_block_lök
 *
l
;

2224 
ªt
 = 0;

2226 i‡(
ªcursi⁄_Àvñ
 >3 + 
BTRFS_MAX_LEVEL
) {

2240 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2241 
	`¥_öfo
("btrfsic:ábort cyclicÜinkage (case 1).\n");

2243  
ªt
;

2250 
	`li°_f‹_óch_íåy
(
l
, &
block
->
ªf_to_li°
, 
node_ªf_to
) {

2251 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2252 
	`¥_öfo
(

2254 
ªcursi⁄_Àvñ
,

2255 
	`båfsic_gë_block_ty≥
(
°©e
, 
block
),

2256 
block
->
logiˇl_byãƒ
, block->
dev_°©e
->
bdev
,

2257 
block
->
dev_byãƒ
, block->
múr‹_num
,

2258 
l
->
ªf_˙t
,

2259 
	`båfsic_gë_block_ty≥
(
°©e
, 
l
->
block_ªf_to
),

2260 
l
->
block_ªf_to
->
logiˇl_byãƒ
,

2261 
l
->
block_ªf_to
->
dev_°©e
->
bdev
,

2262 
l
->
block_ªf_to
->
dev_byãƒ
,

2263 
l
->
block_ªf_to
->
múr‹_num
);

2264 i‡(
l
->
block_ªf_to
->
√vî_wrôãn
) {

2265 
	`¥_öfo
(

2267 
	`båfsic_gë_block_ty≥
(
°©e
, 
l
->
block_ªf_to
),

2268 
l
->
block_ªf_to
->
logiˇl_byãƒ
,

2269 
l
->
block_ªf_to
->
dev_°©e
->
bdev
,

2270 
l
->
block_ªf_to
->
dev_byãƒ
,

2271 
l
->
block_ªf_to
->
múr‹_num
);

2272 
ªt
 = -1;

2273 } i‡(!
l
->
block_ªf_to
->
is_iod⁄e
) {

2274 
	`¥_öfo
(

2276 
	`båfsic_gë_block_ty≥
(
°©e
, 
l
->
block_ªf_to
),

2277 
l
->
block_ªf_to
->
logiˇl_byãƒ
,

2278 
l
->
block_ªf_to
->
dev_°©e
->
bdev
,

2279 
l
->
block_ªf_to
->
dev_byãƒ
,

2280 
l
->
block_ªf_to
->
múr‹_num
);

2281 
ªt
 = -1;

2282 } i‡(
l
->
block_ªf_to
->
iod⁄e_w_îr‹
) {

2283 
	`¥_öfo
(

2285 
	`båfsic_gë_block_ty≥
(
°©e
, 
l
->
block_ªf_to
),

2286 
l
->
block_ªf_to
->
logiˇl_byãƒ
,

2287 
l
->
block_ªf_to
->
dev_°©e
->
bdev
,

2288 
l
->
block_ªf_to
->
dev_byãƒ
,

2289 
l
->
block_ªf_to
->
múr‹_num
);

2290 
ªt
 = -1;

2291 } i‡(
l
->
∑ª¡_gíî©i⁄
 !=

2292 
l
->
block_ªf_to
->
gíî©i⁄
 &&

2293 
BTRFSIC_GENERATION_UNKNOWN
 !=

2294 
l
->
∑ª¡_gíî©i⁄
 &&

2295 
BTRFSIC_GENERATION_UNKNOWN
 !=

2296 
l
->
block_ªf_to
->
gíî©i⁄
) {

2297 
	`¥_öfo
(

2299 
	`båfsic_gë_block_ty≥
(
°©e
, 
l
->
block_ªf_to
),

2300 
l
->
block_ªf_to
->
logiˇl_byãƒ
,

2301 
l
->
block_ªf_to
->
dev_°©e
->
bdev
,

2302 
l
->
block_ªf_to
->
dev_byãƒ
,

2303 
l
->
block_ªf_to
->
múr‹_num
,

2304 
l
->
block_ªf_to
->
gíî©i⁄
,

2305 
l
->
∑ª¡_gíî©i⁄
);

2306 
ªt
 = -1;

2307 } i‡(
l
->
block_ªf_to
->
Êush_gí
 >

2308 
l
->
block_ªf_to
->
dev_°©e
->
œ°_Êush_gí
) {

2309 
	`¥_öfo
(

2311 
	`båfsic_gë_block_ty≥
(
°©e
, 
l
->
block_ªf_to
),

2312 
l
->
block_ªf_to
->
logiˇl_byãƒ
,

2313 
l
->
block_ªf_to
->
dev_°©e
->
bdev
,

2314 
l
->
block_ªf_to
->
dev_byãƒ
,

2315 
l
->
block_ªf_to
->
múr‹_num
, 
block
->
Êush_gí
,

2316 
l
->
block_ªf_to
->
dev_°©e
->
œ°_Êush_gí
);

2317 
ªt
 = -1;

2318 } i‡(-1 =
	`båfsic_check_Æl_ªf_blocks
(
°©e
,

2319 
l
->
block_ªf_to
,

2320 
ªcursi⁄_Àvñ
 +

2322 
ªt
 = -1;

2326  
ªt
;

2327 
	}
}

2329 
	$båfsic_is_block_ªf_by_su≥rblock
(

2330 c⁄° 
båfsic_°©e
 *
°©e
,

2331 c⁄° 
båfsic_block
 *
block
,

2332 
ªcursi⁄_Àvñ
)

2334 c⁄° 
båfsic_block_lök
 *
l
;

2336 i‡(
ªcursi⁄_Àvñ
 >3 + 
BTRFS_MAX_LEVEL
) {

2338 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2339 
	`¥_öfo
("btrfsic:ábort cyclicÜinkage (case 2).\n");

2348 
	`li°_f‹_óch_íåy
(
l
, &
block
->
ªf_‰om_li°
, 
node_ªf_‰om
) {

2349 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2350 
	`¥_öfo
(

2352 
ªcursi⁄_Àvñ
,

2353 
	`båfsic_gë_block_ty≥
(
°©e
, 
block
),

2354 
block
->
logiˇl_byãƒ
, block->
dev_°©e
->
bdev
,

2355 
block
->
dev_byãƒ
, block->
múr‹_num
,

2356 
l
->
ªf_˙t
,

2357 
	`båfsic_gë_block_ty≥
(
°©e
, 
l
->
block_ªf_‰om
),

2358 
l
->
block_ªf_‰om
->
logiˇl_byãƒ
,

2359 
l
->
block_ªf_‰om
->
dev_°©e
->
bdev
,

2360 
l
->
block_ªf_‰om
->
dev_byãƒ
,

2361 
l
->
block_ªf_‰om
->
múr‹_num
);

2362 i‡(
l
->
block_ªf_‰om
->
is_su≥rblock
 &&

2363 
°©e
->
œã°_su≥rblock
->
dev_byãƒ
 ==

2364 
l
->
block_ªf_‰om
->
dev_byãƒ
 &&

2365 
°©e
->
œã°_su≥rblock
->
dev_°©e
->
bdev
 ==

2366 
l
->
block_ªf_‰om
->
dev_°©e
->
bdev
)

2368 i‡(
	`båfsic_is_block_ªf_by_su≥rblock
(
°©e
,

2369 
l
->
block_ªf_‰om
,

2370 
ªcursi⁄_Àvñ
 +

2376 
	}
}

2378 
	$båfsic_¥öt_add_lök
(c⁄° 
båfsic_°©e
 *
°©e
,

2379 c⁄° 
båfsic_block_lök
 *
l
)

2381 
	`¥_öfo
("add %u*Üink from %c @%llu (%pg/%llu/%d)Åo %c @%llu (%pg/%llu/%d)\n",

2382 
l
->
ªf_˙t
,

2383 
	`båfsic_gë_block_ty≥
(
°©e
, 
l
->
block_ªf_‰om
),

2384 
l
->
block_ªf_‰om
->
logiˇl_byãƒ
,

2385 
l
->
block_ªf_‰om
->
dev_°©e
->
bdev
,

2386 
l
->
block_ªf_‰om
->
dev_byãƒ
,Ü->block_ªf_‰om->
múr‹_num
,

2387 
	`båfsic_gë_block_ty≥
(
°©e
, 
l
->
block_ªf_to
),

2388 
l
->
block_ªf_to
->
logiˇl_byãƒ
,

2389 
l
->
block_ªf_to
->
dev_°©e
->
bdev
,Ü->block_ªf_to->
dev_byãƒ
,

2390 
l
->
block_ªf_to
->
múr‹_num
);

2391 
	}
}

2393 
	$båfsic_¥öt_ªm_lök
(c⁄° 
båfsic_°©e
 *
°©e
,

2394 c⁄° 
båfsic_block_lök
 *
l
)

2396 
	`¥_öfo
("rem %u*Üink from %c @%llu (%pg/%llu/%d)Åo %c @%llu (%pg/%llu/%d)\n",

2397 
l
->
ªf_˙t
,

2398 
	`båfsic_gë_block_ty≥
(
°©e
, 
l
->
block_ªf_‰om
),

2399 
l
->
block_ªf_‰om
->
logiˇl_byãƒ
,

2400 
l
->
block_ªf_‰om
->
dev_°©e
->
bdev
,

2401 
l
->
block_ªf_‰om
->
dev_byãƒ
,Ü->block_ªf_‰om->
múr‹_num
,

2402 
	`båfsic_gë_block_ty≥
(
°©e
, 
l
->
block_ªf_to
),

2403 
l
->
block_ªf_to
->
logiˇl_byãƒ
,

2404 
l
->
block_ªf_to
->
dev_°©e
->
bdev
,Ü->block_ªf_to->
dev_byãƒ
,

2405 
l
->
block_ªf_to
->
múr‹_num
);

2406 
	}
}

2408 
	$båfsic_gë_block_ty≥
(c⁄° 
båfsic_°©e
 *
°©e
,

2409 c⁄° 
båfsic_block
 *
block
)

2411 i‡(
block
->
is_su≥rblock
 &&

2412 
°©e
->
œã°_su≥rblock
->
dev_byãƒ
 =
block
->dev_bytenr &&

2413 
°©e
->
œã°_su≥rblock
->
dev_°©e
->
bdev
 =
block
->dev_state->bdev)

2415 i‡(
block
->
is_su≥rblock
)

2417 i‡(
block
->
is_mëad©a
)

2421 
	}
}

2423 
	$båfsic_dump_åì
(c⁄° 
båfsic_°©e
 *
°©e
)

2425 
	`båfsic_dump_åì_sub
(
°©e
, sèã->
œã°_su≥rblock
, 0);

2426 
	}
}

2428 
	$båfsic_dump_åì_sub
(c⁄° 
båfsic_°©e
 *
°©e
,

2429 c⁄° 
båfsic_block
 *
block
,

2430 
ödít_Àvñ
)

2432 c⁄° 
båfsic_block_lök
 *
l
;

2433 
ödít_add
;

2434 
buf
[80];

2435 
curs‹_posôi⁄
;

2446 
ödít_add
 = 
	`•rötf
(
buf
, "%c-%llu(%pg/%llu/%u)",

2447 
	`båfsic_gë_block_ty≥
(
°©e
, 
block
),

2448 
block
->
logiˇl_byãƒ
, block->
dev_°©e
->
bdev
,

2449 
block
->
dev_byãƒ
, block->
múr‹_num
);

2450 i‡(
ödít_Àvñ
 + 
ödít_add
 > 
BTRFSIC_TREE_DUMP_MAX_INDENT_LEVEL
) {

2451 
	`¥ötk
("[...]\n");

2454 
	`¥ötk
(
buf
);

2455 
ödít_Àvñ
 +
ödít_add
;

2456 i‡(
	`li°_em±y
(&
block
->
ªf_to_li°
)) {

2457 
	`¥ötk
("\n");

2460 i‡(
block
->
múr‹_num
 > 1 &&

2461 !(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_TREE_WITH_ALL_MIRRORS
)) {

2462 
	`¥ötk
(" [...]\n");

2466 
curs‹_posôi⁄
 = 
ödít_Àvñ
;

2467 
	`li°_f‹_óch_íåy
(
l
, &
block
->
ªf_to_li°
, 
node_ªf_to
) {

2468 
curs‹_posôi⁄
 < 
ödít_Àvñ
) {

2469 
	`¥ötk
(" ");

2470 
curs‹_posôi⁄
++;

2472 i‡(
l
->
ªf_˙t
 > 1)

2473 
ödít_add
 = 
	`•rötf
(
buf
, " %d*--> ", 
l
->
ªf_˙t
);

2475 
ödít_add
 = 
	`•rötf
(
buf
, " --> ");

2476 i‡(
ödít_Àvñ
 + 
ödít_add
 >

2477 
BTRFSIC_TREE_DUMP_MAX_INDENT_LEVEL
) {

2478 
	`¥ötk
("[...]\n");

2479 
curs‹_posôi⁄
 = 0;

2483 
	`¥ötk
(
buf
);

2485 
	`båfsic_dump_åì_sub
(
°©e
, 
l
->
block_ªf_to
,

2486 
ödít_Àvñ
 + 
ödít_add
);

2487 
curs‹_posôi⁄
 = 0;

2489 
	}
}

2491 
båfsic_block_lök
 *
	$båfsic_block_lök_lookup_‹_add
(

2492 
båfsic_°©e
 *
°©e
,

2493 
båfsic_block_d©a_˘x
 *
√xt_block_˘x
,

2494 
båfsic_block
 *
√xt_block
,

2495 
båfsic_block
 *
‰om_block
,

2496 
u64
 
∑ª¡_gíî©i⁄
)

2498 
båfsic_block_lök
 *
l
;

2500 
l
 = 
	`båfsic_block_lök_hashèbÀ_lookup
(
√xt_block_˘x
->
dev
->
bdev
,

2501 
√xt_block_˘x
->
dev_byãƒ
,

2502 
‰om_block
->
dev_°©e
->
bdev
,

2503 
‰om_block
->
dev_byãƒ
,

2504 &
°©e
->
block_lök_hashèbÀ
);

2505 i‡(
NULL
 =
l
) {

2506 
l
 = 
	`båfsic_block_lök_Æloc
();

2507 i‡(!
l
)

2508  
NULL
;

2510 
l
->
block_ªf_to
 = 
√xt_block
;

2511 
l
->
block_ªf_‰om
 = 
‰om_block
;

2512 
l
->
ªf_˙t
 = 1;

2513 
l
->
∑ª¡_gíî©i⁄
 =Öarent_generation;

2515 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2516 
	`båfsic_¥öt_add_lök
(
°©e
, 
l
);

2518 
	`li°_add
(&
l
->
node_ªf_to
, &
‰om_block
->
ªf_to_li°
);

2519 
	`li°_add
(&
l
->
node_ªf_‰om
, &
√xt_block
->
ªf_‰om_li°
);

2521 
	`båfsic_block_lök_hashèbÀ_add
(
l
,

2522 &
°©e
->
block_lök_hashèbÀ
);

2524 
l
->
ªf_˙t
++;

2525 
l
->
∑ª¡_gíî©i⁄
 =Öarent_generation;

2526 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2527 
	`båfsic_¥öt_add_lök
(
°©e
, 
l
);

2530  
l
;

2531 
	}
}

2533 
båfsic_block
 *
	$båfsic_block_lookup_‹_add
(

2534 
båfsic_°©e
 *
°©e
,

2535 
båfsic_block_d©a_˘x
 *
block_˘x
,

2536 c⁄° *
addôi⁄Æ_°rög
,

2537 
is_mëad©a
,

2538 
is_iod⁄e
,

2539 
√vî_wrôãn
,

2540 
múr‹_num
,

2541 *
was_¸óãd
)

2543 
båfsic_block
 *
block
;

2545 
block
 = 
	`båfsic_block_hashèbÀ_lookup
(
block_˘x
->
dev
->
bdev
,

2546 
block_˘x
->
dev_byãƒ
,

2547 &
°©e
->
block_hashèbÀ
);

2548 i‡(
NULL
 =
block
) {

2549 
båfsic_dev_°©e
 *
dev_°©e
;

2551 
block
 = 
	`båfsic_block_Æloc
();

2552 i‡(!
block
)

2553  
NULL
;

2555 
dev_°©e
 = 
	`båfsic_dev_°©e_lookup
(
block_˘x
->
dev
->
bdev
->
bd_dev
);

2556 i‡(
NULL
 =
dev_°©e
) {

2557 
	`¥_öfo
("btrfsic:Érror,Üookup dev_state failed!\n");

2558 
	`båfsic_block_‰ì
(
block
);

2559  
NULL
;

2561 
block
->
dev_°©e
 = dev_state;

2562 
block
->
dev_byãƒ
 = 
block_˘x
->dev_bytenr;

2563 
block
->
logiˇl_byãƒ
 = 
block_˘x
->
°¨t
;

2564 
block
->
is_mëad©a
 = is_metadata;

2565 
block
->
is_iod⁄e
 = is_iodone;

2566 
block
->
√vî_wrôãn
 =Çever_written;

2567 
block
->
múr‹_num
 = mirror_num;

2568 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2569 
	`¥_öfo
("New %s%c-block @%llu (%pg/%llu/%d)\n",

2570 
addôi⁄Æ_°rög
,

2571 
	`båfsic_gë_block_ty≥
(
°©e
, 
block
),

2572 
block
->
logiˇl_byãƒ
, 
dev_°©e
->
bdev
,

2573 
block
->
dev_byãƒ
, 
múr‹_num
);

2574 
	`li°_add
(&
block
->
Æl_blocks_node
, &
°©e
->
Æl_blocks_li°
);

2575 
	`båfsic_block_hashèbÀ_add
(
block
, &
°©e
->
block_hashèbÀ
);

2576 i‡(
NULL
 !
was_¸óãd
)

2577 *
was_¸óãd
 = 1;

2579 i‡(
NULL
 !
was_¸óãd
)

2580 *
was_¸óãd
 = 0;

2583  
block
;

2584 
	}
}

2586 
	$båfsic_cmp_log_™d_dev_byãƒ
(
båfsic_°©e
 *
°©e
,

2587 
u64
 
byãƒ
,

2588 
båfsic_dev_°©e
 *
dev_°©e
,

2589 
u64
 
dev_byãƒ
)

2591 
båfs_fs_öfo
 *
fs_öfo
 = 
°©e
->fs_info;

2592 
båfsic_block_d©a_˘x
 
block_˘x
;

2593 
num_c›õs
;

2594 
múr‹_num
;

2595 
m©ch
 = 0;

2596 
ªt
;

2598 
num_c›õs
 = 
	`båfs_num_c›õs
(
fs_öfo
, 
byãƒ
, 
°©e
->
mëablock_size
);

2600 
múr‹_num
 = 1; múr‹_num <
num_c›õs
; mirror_num++) {

2601 
ªt
 = 
	`båfsic_m≠_block
(
°©e
, 
byãƒ
, sèã->
mëablock_size
,

2602 &
block_˘x
, 
múr‹_num
);

2603 i‡(
ªt
) {

2604 
	`¥_öfo
("btrfsic: btrfsic_map_block(logical @%llu, mirror %d) failed!\n",

2605 
byãƒ
, 
múr‹_num
);

2609 i‡(
dev_°©e
->
bdev
 =
block_˘x
.
dev
->bdev &&

2610 
dev_byãƒ
 =
block_˘x
.dev_bytenr) {

2611 
m©ch
++;

2612 
	`båfsic_ªÀa£_block_˘x
(&
block_˘x
);

2615 
	`båfsic_ªÀa£_block_˘x
(&
block_˘x
);

2618 i‡(
	`WARN_ON
(!
m©ch
)) {

2619 
	`¥_öfo
(

2621 
byãƒ
, 
dev_°©e
->
bdev
, 
dev_byãƒ
);

2622 
múr‹_num
 = 1; múr‹_num <
num_c›õs
; mirror_num++) {

2623 
ªt
 = 
	`båfsic_m≠_block
(
°©e
, 
byãƒ
,

2624 
°©e
->
mëablock_size
,

2625 &
block_˘x
, 
múr‹_num
);

2626 i‡(
ªt
)

2629 
	`¥_öfo
("readÜogical bytenr @%llu mapsÅo (%pg/%llu/%d)\n",

2630 
byãƒ
, 
block_˘x
.
dev
->
bdev
,

2631 
block_˘x
.
dev_byãƒ
, 
múr‹_num
);

2634 
	}
}

2636 
båfsic_dev_°©e
 *
	$båfsic_dev_°©e_lookup
(
dev_t
 
dev
)

2638  
	`båfsic_dev_°©e_hashèbÀ_lookup
(
dev
,

2639 &
båfsic_dev_°©e_hashèbÀ
);

2640 
	}
}

2642 
	$båfsic_check_wrôe_bio
(
bio
 *bio, 
båfsic_dev_°©e
 *
dev_°©e
)

2644 
£gs
 = 
	`bio_£gmíts
(
bio
);

2645 
u64
 
dev_byãƒ
 = 512 * 
bio
->
bi_ôî
.
bi_£˘‹
;

2646 
u64
 
cur_byãƒ
 = 
dev_byãƒ
;

2647 
bvec_ôî
 
ôî
;

2648 
bio_vec
 
bvec
;

2649 **
m≠≥d_d©av
;

2650 
bio_is_∑tched
 = 0;

2651 
i
 = 0;

2653 i‡(
dev_°©e
->
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH
)

2654 
	`¥_öfo
(

2656 
	`bio_›
(
bio
), bio->
bi_›f
, 
£gs
,

2657 
bio
->
bi_ôî
.
bi_£˘‹
, 
dev_byãƒ
, bio->
bi_bdev
);

2659 
m≠≥d_d©av
 = 
	`kmÆloc_¨øy
(
£gs
, (*m≠≥d_d©av), 
GFP_NOFS
);

2660 i‡(!
m≠≥d_d©av
)

2663 
	`bio_f‹_óch_£gmít
(
bvec
, 
bio
, 
ôî
) {

2664 
	`BUG_ON
(
bvec
.
bv_Àn
 !
PAGE_SIZE
);

2665 
m≠≥d_d©av
[
i
] = 
	`∑ge_addªss
(
bvec
.
bv_∑ge
);

2666 
i
++;

2668 i‡(
dev_°©e
->
°©e
->
¥öt_mask
 &

2669 
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH_VERBOSE
)

2670 
	`¥_öfo
("#%u: bytenr=%llu,Üen=%u, offset=%u\n",

2671 
i
, 
cur_byãƒ
, 
bvec
.
bv_Àn
, bvec.
bv_off£t
);

2672 
cur_byãƒ
 +
bvec
.
bv_Àn
;

2675 
	`båfsic_¥o˚ss_wrôãn_block
(
dev_°©e
, 
dev_byãƒ
, 
m≠≥d_d©av
, 
£gs
,

2676 
bio
, &
bio_is_∑tched
, bio->
bi_›f
);

2677 
	`k‰ì
(
m≠≥d_d©av
);

2678 
	}
}

2680 
	$båfsic_check_Êush_bio
(
bio
 *bio, 
båfsic_dev_°©e
 *
dev_°©e
)

2682 i‡(
dev_°©e
->
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH
)

2683 
	`¥_öfo
("submit_bio(rw=%d,0x%x FLUSH, bdev=%p)\n",

2684 
	`bio_›
(
bio
), bio->
bi_›f
, bio->
bi_bdev
);

2686 i‡(
dev_°©e
->
dummy_block_f‹_bio_bh_Êush
.
is_iod⁄e
) {

2687 
båfsic_block
 *c⁄° 
block
 =

2688 &
dev_°©e
->
dummy_block_f‹_bio_bh_Êush
;

2690 
block
->
is_iod⁄e
 = 0;

2691 
block
->
√vî_wrôãn
 = 0;

2692 
block
->
iod⁄e_w_îr‹
 = 0;

2693 
block
->
Êush_gí
 = 
dev_°©e
->
œ°_Êush_gí
 + 1;

2694 
block
->
submô_bio_bh_rw
 = 
bio
->
bi_›f
;

2695 
block
->
‹ig_bio_¥iv©e
 = 
bio
->
bi_¥iv©e
;

2696 
block
->
‹ig_bio_íd_io
 = 
bio
->
bi_íd_io
;

2697 
block
->
√xt_ö_ßme_bio
 = 
NULL
;

2698 
bio
->
bi_¥iv©e
 = 
block
;

2699 
bio
->
bi_íd_io
 = 
båfsic_bio_íd_io
;

2700 } i‡((
dev_°©e
->
°©e
->
¥öt_mask
 &

2701 (
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH
 |

2702 
BTRFSIC_PRINT_MASK_VERBOSE
))) {

2703 
	`¥_öfo
(

2705 
dev_°©e
->
bdev
);

2707 
	}
}

2709 
	$båfsic_check_bio
(
bio
 *bio)

2711 
båfsic_dev_°©e
 *
dev_°©e
;

2713 i‡(!
båfsic_is_öôülized
)

2720 
dev_°©e
 = 
	`båfsic_dev_°©e_lookup
(
bio
->
bi_bdev
->
bd_dev
);

2721 
	`muãx_lock
(&
båfsic_muãx
);

2722 i‡(
dev_°©e
) {

2723 i‡(
	`bio_›
(
bio
Ë=
REQ_OP_WRITE
 && 
	`bio_has_d©a
(bio))

2724 
	`båfsic_check_wrôe_bio
(
bio
, 
dev_°©e
);

2725 i‡(
bio
->
bi_›f
 & 
REQ_PREFLUSH
)

2726 
	`båfsic_check_Êush_bio
(
bio
, 
dev_°©e
);

2728 
	`muãx_u∆ock
(&
båfsic_muãx
);

2729 
	}
}

2731 
	$båfsic_mou¡
(
båfs_fs_öfo
 *
fs_öfo
,

2732 
båfs_fs_devi˚s
 *
fs_devi˚s
,

2733 
ö˛udög_exã¡_d©a
, 
u32
 
¥öt_mask
)

2735 
ªt
;

2736 
båfsic_°©e
 *
°©e
;

2737 
li°_hód
 *
dev_hód
 = &
fs_devi˚s
->
devi˚s
;

2738 
båfs_devi˚
 *
devi˚
;

2740 i‡(!
	`PAGE_ALIGNED
(
fs_öfo
->
nodesize
)) {

2741 
	`¥_öfo
("btrfsic: cannot handleÇodesize %dÇot beingá multiple of PAGE_SIZE %ld!\n",

2742 
fs_öfo
->
nodesize
, 
PAGE_SIZE
);

2745 i‡(!
	`PAGE_ALIGNED
(
fs_öfo
->
£˘‹size
)) {

2746 
	`¥_öfo
("btrfsic: cannot handle sectorsize %dÇot beingá multiple of PAGE_SIZE %ld!\n",

2747 
fs_öfo
->
£˘‹size
, 
PAGE_SIZE
);

2750 
°©e
 = 
	`kvzÆloc
((*°©e), 
GFP_KERNEL
);

2751 i‡(!
°©e
)

2752  -
ENOMEM
;

2754 i‡(!
båfsic_is_öôülized
) {

2755 
	`muãx_öô
(&
båfsic_muãx
);

2756 
	`båfsic_dev_°©e_hashèbÀ_öô
(&
båfsic_dev_°©e_hashèbÀ
);

2757 
båfsic_is_öôülized
 = 1;

2759 
	`muãx_lock
(&
båfsic_muãx
);

2760 
°©e
->
fs_öfo
 = fs_info;

2761 
°©e
->
¥öt_mask
 =Örint_mask;

2762 
°©e
->
ö˛ude_exã¡_d©a
 = 
ö˛udög_exã¡_d©a
;

2763 
°©e
->
mëablock_size
 = 
fs_öfo
->
nodesize
;

2764 
°©e
->
d©ablock_size
 = 
fs_öfo
->
£˘‹size
;

2765 
	`INIT_LIST_HEAD
(&
°©e
->
Æl_blocks_li°
);

2766 
	`båfsic_block_hashèbÀ_öô
(&
°©e
->
block_hashèbÀ
);

2767 
	`båfsic_block_lök_hashèbÀ_öô
(&
°©e
->
block_lök_hashèbÀ
);

2768 
°©e
->
max_su≥rblock_gíî©i⁄
 = 0;

2769 
°©e
->
œã°_su≥rblock
 = 
NULL
;

2771 
	`li°_f‹_óch_íåy
(
devi˚
, 
dev_hód
, 
dev_li°
) {

2772 
båfsic_dev_°©e
 *
ds
;

2774 i‡(!
devi˚
->
bdev
 || !devi˚->
«me
)

2777 
ds
 = 
	`båfsic_dev_°©e_Æloc
();

2778 i‡(
NULL
 =
ds
) {

2779 
	`muãx_u∆ock
(&
båfsic_muãx
);

2780  -
ENOMEM
;

2782 
ds
->
bdev
 = 
devi˚
->bdev;

2783 
ds
->
°©e
 = state;

2784 
	`båfsic_dev_°©e_hashèbÀ_add
(
ds
,

2785 &
båfsic_dev_°©e_hashèbÀ
);

2788 
ªt
 = 
	`båfsic_¥o˚ss_su≥rblock
(
°©e
, 
fs_devi˚s
);

2789 i‡(0 !
ªt
) {

2790 
	`muãx_u∆ock
(&
båfsic_muãx
);

2791 
	`båfsic_unmou¡
(
fs_devi˚s
);

2792  
ªt
;

2795 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_INITIAL_DATABASE
)

2796 
	`båfsic_dump_d©aba£
(
°©e
);

2797 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_INITIAL_TREE
)

2798 
	`båfsic_dump_åì
(
°©e
);

2800 
	`muãx_u∆ock
(&
båfsic_muãx
);

2802 
	}
}

2804 
	$båfsic_unmou¡
(
båfs_fs_devi˚s
 *
fs_devi˚s
)

2806 
båfsic_block
 *
b_Æl
, *
tmp_Æl
;

2807 
båfsic_°©e
 *
°©e
;

2808 
li°_hód
 *
dev_hód
 = &
fs_devi˚s
->
devi˚s
;

2809 
båfs_devi˚
 *
devi˚
;

2811 i‡(!
båfsic_is_öôülized
)

2814 
	`muãx_lock
(&
båfsic_muãx
);

2816 
°©e
 = 
NULL
;

2817 
	`li°_f‹_óch_íåy
(
devi˚
, 
dev_hód
, 
dev_li°
) {

2818 
båfsic_dev_°©e
 *
ds
;

2820 i‡(!
devi˚
->
bdev
 || !devi˚->
«me
)

2823 
ds
 = 
	`båfsic_dev_°©e_hashèbÀ_lookup
(

2824 
devi˚
->
bdev
->
bd_dev
,

2825 &
båfsic_dev_°©e_hashèbÀ
);

2826 i‡(
NULL
 !
ds
) {

2827 
°©e
 = 
ds
->state;

2828 
	`båfsic_dev_°©e_hashèbÀ_ªmove
(
ds
);

2829 
	`båfsic_dev_°©e_‰ì
(
ds
);

2833 i‡(
NULL
 =
°©e
) {

2834 
	`¥_öfo
("btrfsic:Érror, cannot find state information on umount!\n");

2835 
	`muãx_u∆ock
(&
båfsic_muãx
);

2844 
	`li°_f‹_óch_íåy_ß„
(
b_Æl
, 
tmp_Æl
, &
°©e
->
Æl_blocks_li°
,

2845 
Æl_blocks_node
) {

2846 
båfsic_block_lök
 *
l
, *
tmp
;

2848 
	`li°_f‹_óch_íåy_ß„
(
l
, 
tmp
, &
b_Æl
->
ªf_to_li°
,

2849 
node_ªf_to
) {

2850 i‡(
°©e
->
¥öt_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2851 
	`båfsic_¥öt_ªm_lök
(
°©e
, 
l
);

2853 
l
->
ªf_˙t
--;

2854 i‡(0 =
l
->
ªf_˙t
)

2855 
	`båfsic_block_lök_‰ì
(
l
);

2858 i‡(
b_Æl
->
is_iod⁄e
 || b_Æl->
√vî_wrôãn
)

2859 
	`båfsic_block_‰ì
(
b_Æl
);

2861 
	`¥_öfo
(

2863 
	`båfsic_gë_block_ty≥
(
°©e
, 
b_Æl
),

2864 
b_Æl
->
logiˇl_byãƒ
, b_Æl->
dev_°©e
->
bdev
,

2865 
b_Æl
->
dev_byãƒ
, b_Æl->
múr‹_num
);

2868 
	`muãx_u∆ock
(&
båfsic_muãx
);

2870 
	`kv‰ì
(
°©e
);

2871 
	}
}

	@check-integrity.h

6 #i‚de‡
BTRFS_CHECK_INTEGRITY_H


7 
	#BTRFS_CHECK_INTEGRITY_H


	)

9 #ifde‡
CONFIG_BTRFS_FS_CHECK_INTEGRITY


10 
båfsic_check_bio
(
bio
 *bio);

12 
ölöe
 
	$båfsic_check_bio
(
bio
 *bioË{ 
	}
}

15 
båfsic_mou¡
(
båfs_fs_öfo
 *
fs_öfo
,

16 
båfs_fs_devi˚s
 *
fs_devi˚s
,

17 
ö˛udög_exã¡_d©a
, 
u32
 
¥öt_mask
);

18 
båfsic_unmou¡
(
båfs_fs_devi˚s
 *
fs_devi˚s
);

	@compression.c

6 
	~<löux/kî√l.h
>

7 
	~<löux/bio.h
>

8 
	~<löux/fûe.h
>

9 
	~<löux/fs.h
>

10 
	~<löux/∑gem≠.h
>

11 
	~<löux/∑gevec.h
>

12 
	~<löux/highmem.h
>

13 
	~<löux/kthªad.h
>

14 
	~<löux/time.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/°rög.h
>

17 
	~<löux/backög-dev.h
>

18 
	~<löux/wrôeback.h
>

19 
	~<löux/psi.h
>

20 
	~<löux/¶ab.h
>

21 
	~<löux/sched/mm.h
>

22 
	~<löux/log2.h
>

23 
	~<¸y±o/hash.h
>

24 
	~"misc.h
"

25 
	~"˘ªe.h
"

26 
	~"fs.h
"

27 
	~"disk-io.h
"

28 
	~"å™ß˘i⁄.h
"

29 
	~"båfs_öode.h
"

30 
	~"bio.h
"

31 
	~"‹dîed-d©a.h
"

32 
	~"com¥essi⁄.h
"

33 
	~"exã¡_io.h
"

34 
	~"exã¡_m≠.h
"

35 
	~"sub∑ge.h
"

36 
	~"z⁄ed.h
"

37 
	~"fûe-ôem.h
"

38 
	~"su≥r.h
"

40 
bio_£t
 
	gbåfs_com¥es£d_bio£t
;

42 c⁄° * c⁄° 
	gbåfs_com¥ess_ty≥s
[] = { "", "zlib", "lzo", "zstd" };

44 c⁄° * 
	$båfs_com¥ess_ty≥2°r
(
båfs_com¥essi⁄_ty≥
 
ty≥
)

46 
ty≥
) {

47 
BTRFS_COMPRESS_ZLIB
:

48 
BTRFS_COMPRESS_LZO
:

49 
BTRFS_COMPRESS_ZSTD
:

50 
BTRFS_COMPRESS_NONE
:

51  
båfs_com¥ess_ty≥s
[
ty≥
];

56  
NULL
;

57 
	}
}

59 
ölöe
 
com¥es£d_bio
 *
	$to_com¥es£d_bio
(
båfs_bio
 *
bbio
)

61  
	`c⁄èöî_of
(
bbio
, 
com¥es£d_bio
, bbio);

62 
	}
}

64 
com¥es£d_bio
 *
	$Æloc_com¥es£d_bio
(
båfs_öode
 *
öode
,

65 
u64
 
°¨t
, 
blk_›f_t
 
›
,

66 
båfs_bio_íd_io_t
 
íd_io
)

68 
båfs_bio
 *
bbio
;

70 
bbio
 = 
	`båfs_bio
(
	`bio_Æloc_bio£t
(
NULL
, 
BTRFS_MAX_COMPRESSED_PAGES
, 
›
,

71 
GFP_NOFS
, &
båfs_com¥es£d_bio£t
));

72 
	`båfs_bio_öô
(
bbio
, 
öode
->
roŸ
->
fs_öfo
, 
íd_io
, 
NULL
);

73 
bbio
->
öode
 = inode;

74 
bbio
->
fûe_off£t
 = 
°¨t
;

75  
	`to_com¥es£d_bio
(
bbio
);

76 
	}
}

78 
boﬁ
 
	$båfs_com¥ess_is_vÆid_ty≥
(c⁄° *
°r
, 
size_t
 
Àn
)

80 
i
;

82 
i
 = 1; i < 
	`ARRAY_SIZE
(
båfs_com¥ess_ty≥s
); i++) {

83 
size_t
 
comp_Àn
 = 
	`°æí
(
båfs_com¥ess_ty≥s
[
i
]);

85 i‡(
Àn
 < 
comp_Àn
)

88 i‡(!
	`°∫cmp
(
båfs_com¥ess_ty≥s
[
i
], 
°r
, 
comp_Àn
))

89  
åue
;

91  
Ál£
;

92 
	}
}

94 
	$com¥essi⁄_com¥ess_∑ges
(
ty≥
, 
li°_hód
 *
ws
,

95 
addªss_•a˚
 *
m≠pög
, 
u64
 
°¨t
, 
∑ge
 **
∑ges
,

96 *
out_∑ges
, *
tŸÆ_ö
,

97 *
tŸÆ_out
)

99 
ty≥
) {

100 
BTRFS_COMPRESS_ZLIB
:

101  
	`zlib_com¥ess_∑ges
(
ws
, 
m≠pög
, 
°¨t
, 
∑ges
,

102 
out_∑ges
, 
tŸÆ_ö
, 
tŸÆ_out
);

103 
BTRFS_COMPRESS_LZO
:

104  
	`lzo_com¥ess_∑ges
(
ws
, 
m≠pög
, 
°¨t
, 
∑ges
,

105 
out_∑ges
, 
tŸÆ_ö
, 
tŸÆ_out
);

106 
BTRFS_COMPRESS_ZSTD
:

107  
	`z°d_com¥ess_∑ges
(
ws
, 
m≠pög
, 
°¨t
, 
∑ges
,

108 
out_∑ges
, 
tŸÆ_ö
, 
tŸÆ_out
);

109 
BTRFS_COMPRESS_NONE
:

120 *
out_∑ges
 = 0;

121  -
E2BIG
;

123 
	}
}

125 
	$com¥essi⁄_decom¥ess_bio
(
li°_hód
 *
ws
,

126 
com¥es£d_bio
 *
cb
)

128 
cb
->
com¥ess_ty≥
) {

129 
BTRFS_COMPRESS_ZLIB
:  
	`zlib_decom¥ess_bio
(
ws
, 
cb
);

130 
BTRFS_COMPRESS_LZO
:  
	`lzo_decom¥ess_bio
(
ws
, 
cb
);

131 
BTRFS_COMPRESS_ZSTD
:  
	`z°d_decom¥ess_bio
(
ws
, 
cb
);

132 
BTRFS_COMPRESS_NONE
:

138 
	`BUG
();

140 
	}
}

142 
	$com¥essi⁄_decom¥ess
(
ty≥
, 
li°_hód
 *
ws
,

143 c⁄° 
u8
 *
d©a_ö
, 
∑ge
 *
de°_∑ge
,

144 
°¨t_byã
, 
size_t
 
§˛í
, size_à
de°Àn
)

146 
ty≥
) {

147 
BTRFS_COMPRESS_ZLIB
:  
	`zlib_decom¥ess
(
ws
, 
d©a_ö
, 
de°_∑ge
,

148 
°¨t_byã
, 
§˛í
, 
de°Àn
);

149 
BTRFS_COMPRESS_LZO
:  
	`lzo_decom¥ess
(
ws
, 
d©a_ö
, 
de°_∑ge
,

150 
°¨t_byã
, 
§˛í
, 
de°Àn
);

151 
BTRFS_COMPRESS_ZSTD
:  
	`z°d_decom¥ess
(
ws
, 
d©a_ö
, 
de°_∑ge
,

152 
°¨t_byã
, 
§˛í
, 
de°Àn
);

153 
BTRFS_COMPRESS_NONE
:

159 
	`BUG
();

161 
	}
}

163 
	$båfs_‰ì_com¥es£d_∑ges
(
com¥es£d_bio
 *
cb
)

165 
i
 = 0; i < 
cb
->
ƒ_∑ges
; i++)

166 
	`put_∑ge
(
cb
->
com¥es£d_∑ges
[
i
]);

167 
	`k‰ì
(
cb
->
com¥es£d_∑ges
);

168 
	}
}

170 
båfs_decom¥ess_bio
(
com¥es£d_bio
 *
cb
);

172 
	$íd_com¥es£d_bio_ªad
(
båfs_bio
 *
bbio
)

174 
com¥es£d_bio
 *
cb
 = 
	`to_com¥es£d_bio
(
bbio
);

175 
blk_°©us_t
 
°©us
 = 
bbio
->
bio
.
bi_°©us
;

177 i‡(!
°©us
)

178 
°©us
 = 
	`î∫o_to_blk_°©us
(
	`båfs_decom¥ess_bio
(
cb
));

180 
	`båfs_‰ì_com¥es£d_∑ges
(
cb
);

181 
	`båfs_bio_íd_io
(
cb
->
‹ig_bbio
, 
°©us
);

182 
	`bio_put
(&
bbio
->
bio
);

183 
	}
}

189 
noölöe
 
	$íd_com¥es£d_wrôeback
(c⁄° 
com¥es£d_bio
 *
cb
)

191 
öode
 *öodê&
cb
->
bbio
.öode->
vfs_öode
;

192 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

193 
ödex
 = 
cb
->
°¨t
 >> 
PAGE_SHIFT
;

194 
íd_ödex
 = (
cb
->
°¨t
 + cb->
Àn
 - 1Ë>> 
PAGE_SHIFT
;

195 
fﬁio_b©ch
 
fb©ch
;

196 c⁄° 
î∫o
 = 
	`blk_°©us_to_î∫o
(
cb
->
bbio
.
bio
.
bi_°©us
);

197 
i
;

198 
ªt
;

200 i‡(
î∫o
)

201 
	`m≠pög_£t_îr‹
(
öode
->
i_m≠pög
, 
î∫o
);

203 
	`fﬁio_b©ch_öô
(&
fb©ch
);

204 
ödex
 <
íd_ödex
) {

205 
ªt
 = 
	`fûem≠_gë_fﬁios
(
öode
->
i_m≠pög
, &
ödex
, 
íd_ödex
,

206 &
fb©ch
);

208 i‡(
ªt
 == 0)

211 
i
 = 0; i < 
ªt
; i++) {

212 
fﬁio
 *fﬁiÿ
fb©ch
.
fﬁios
[
i
];

214 
	`båfs_∑ge_˛amp_˛ór_wrôeback
(
fs_öfo
, &
fﬁio
->
∑ge
,

215 
cb
->
°¨t
, cb->
Àn
);

217 
	`fﬁio_b©ch_ªÀa£
(&
fb©ch
);

220 
	}
}

222 
	$båfs_föish_com¥es£d_wrôe_w‹k
(
w‹k_°ru˘
 *
w‹k
)

224 
com¥es£d_bio
 *
cb
 =

225 
	`c⁄èöî_of
(
w‹k
, 
com¥es£d_bio
, 
wrôe_íd_w‹k
);

227 
	`båfs_föish_‹dîed_exã¡
(
cb
->
bbio
.
‹dîed
, 
NULL
, cb->
°¨t
, cb->
Àn
,

228 
cb
->
bbio
.
bio
.
bi_°©us
 =
BLK_STS_OK
);

230 i‡(
cb
->
wrôeback
)

231 
	`íd_com¥es£d_wrôeback
(
cb
);

234 
	`båfs_‰ì_com¥es£d_∑ges
(
cb
);

235 
	`bio_put
(&
cb
->
bbio
.
bio
);

236 
	}
}

245 
	$íd_com¥es£d_bio_wrôe
(
båfs_bio
 *
bbio
)

247 
com¥es£d_bio
 *
cb
 = 
	`to_com¥es£d_bio
(
bbio
);

248 
båfs_fs_öfo
 *
fs_öfo
 = 
bbio
->
öode
->
roŸ
->fs_info;

250 
	`queue_w‹k
(
fs_öfo
->
com¥es£d_wrôe_w‹kîs
, &
cb
->
wrôe_íd_w‹k
);

251 
	}
}

253 
	$båfs_add_com¥es£d_bio_∑ges
(
com¥es£d_bio
 *
cb
)

255 
bio
 *biÿ&
cb
->
bbio
.bio;

256 
u32
 
off£t
 = 0;

258 
off£t
 < 
cb
->
com¥es£d_Àn
) {

259 
u32
 
Àn
 = 
	`mö_t
(u32, 
cb
->
com¥es£d_Àn
 - 
off£t
, 
PAGE_SIZE
);

262 
	`__bio_add_∑ge
(
bio
, 
cb
->
com¥es£d_∑ges
[
off£t
 >> 
PAGE_SHIFT
],

263 
Àn
, 0);

264 
off£t
 +
Àn
;

266 
	}
}

277 
	$båfs_submô_com¥es£d_wrôe
(
båfs_‹dîed_exã¡
 *
‹dîed
,

278 
∑ge
 **
com¥es£d_∑ges
,

279 
ƒ_∑ges
,

280 
blk_›f_t
 
wrôe_Êags
,

281 
boﬁ
 
wrôeback
)

283 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
‹dîed
->inode);

284 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

285 
com¥es£d_bio
 *
cb
;

287 
	`ASSERT
(
	`IS_ALIGNED
(
‹dîed
->
fûe_off£t
, 
fs_öfo
->
£˘‹size
));

288 
	`ASSERT
(
	`IS_ALIGNED
(
‹dîed
->
num_byãs
, 
fs_öfo
->
£˘‹size
));

290 
cb
 = 
	`Æloc_com¥es£d_bio
(
öode
, 
‹dîed
->
fûe_off£t
,

291 
REQ_OP_WRITE
 | 
wrôe_Êags
,

292 
íd_com¥es£d_bio_wrôe
);

293 
cb
->
°¨t
 = 
‹dîed
->
fûe_off£t
;

294 
cb
->
Àn
 = 
‹dîed
->
num_byãs
;

295 
cb
->
com¥es£d_∑ges
 = compressed_pages;

296 
cb
->
com¥es£d_Àn
 = 
‹dîed
->
disk_num_byãs
;

297 
cb
->
wrôeback
 = writeback;

298 
	`INIT_WORK
(&
cb
->
wrôe_íd_w‹k
, 
båfs_föish_com¥es£d_wrôe_w‹k
);

299 
cb
->
ƒ_∑ges
 =Çr_pages;

300 
cb
->
bbio
.
bio
.
bi_ôî
.
bi_£˘‹
 = 
‹dîed
->
disk_byãƒ
 >> 
SECTOR_SHIFT
;

301 
cb
->
bbio
.
‹dîed
 = ordered;

302 
	`båfs_add_com¥es£d_bio_∑ges
(
cb
);

304 
	`båfs_submô_bio
(&
cb
->
bbio
, 0);

305 
	}
}

318 
noölöe
 
	$add_ø_bio_∑ges
(
öode
 *inode,

319 
u64
 
com¥es£d_íd
,

320 
com¥es£d_bio
 *
cb
,

321 *
mem°Æl
, *
pÊags
)

323 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

324 
íd_ödex
;

325 
bio
 *
‹ig_bio
 = &
cb
->
‹ig_bbio
->bio;

326 
u64
 
cur
 = 
cb
->
‹ig_bbio
->
fûe_off£t
 + 
‹ig_bio
->
bi_ôî
.
bi_size
;

327 
u64
 
isize
 = 
	`i_size_ªad
(
öode
);

328 
ªt
;

329 
∑ge
 *page;

330 
exã¡_m≠
 *
em
;

331 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

332 
exã¡_m≠_åì
 *
em_åì
;

333 
exã¡_io_åì
 *
åì
;

334 
£˘‹s_mis£d
 = 0;

336 
em_åì
 = &
	`BTRFS_I
(
öode
)->
exã¡_åì
;

337 
åì
 = &
	`BTRFS_I
(
öode
)->
io_åì
;

339 i‡(
isize
 == 0)

349 i‡(
	`båfs_sb
(
öode
->
i_sb
)->
£˘‹size
 < 
PAGE_SIZE
)

352 
íd_ödex
 = (
	`i_size_ªad
(
öode
Ë- 1Ë>> 
PAGE_SHIFT
;

354 
cur
 < 
com¥es£d_íd
) {

355 
u64
 
∑ge_íd
;

356 
u64
 
pg_ödex
 = 
cur
 >> 
PAGE_SHIFT
;

357 
u32
 
add_size
;

359 i‡(
pg_ödex
 > 
íd_ödex
)

362 
∑ge
 = 
	`xa_lﬂd
(&
m≠pög
->
i_∑ges
, 
pg_ödex
);

363 i‡(
∑ge
 && !
	`xa_is_vÆue
(page)) {

364 
£˘‹s_mis£d
 +(
PAGE_SIZE
 - 
	`off£t_ö_∑ge
(
cur
)) >>

365 
fs_öfo
->
£˘‹size_bôs
;

368 i‡(
£˘‹s_mis£d
 > 4)

375 
cur
 = (
pg_ödex
 << 
PAGE_SHIFT
Ë+ 
PAGE_SIZE
;

379 
∑ge
 = 
	`__∑ge_ˇche_Æloc
(
	`m≠pög_gÂ_c⁄°øöt
(
m≠pög
,

380 ~
__GFP_FS
));

381 i‡(!
∑ge
)

384 i‡(
	`add_to_∑ge_ˇche_Ãu
(
∑ge
, 
m≠pög
, 
pg_ödex
, 
GFP_NOFS
)) {

385 
	`put_∑ge
(
∑ge
);

387 
cur
 = (
pg_ödex
 << 
PAGE_SHIFT
Ë+ 
PAGE_SIZE
;

391 i‡(!*
mem°Æl
 && 
	`PageW‹kög£t
(
∑ge
)) {

392 
	`psi_mem°Æl_íãr
(
pÊags
);

393 *
mem°Æl
 = 1;

396 
ªt
 = 
	`£t_∑ge_exã¡_m≠≥d
(
∑ge
);

397 i‡(
ªt
 < 0) {

398 
	`u∆ock_∑ge
(
∑ge
);

399 
	`put_∑ge
(
∑ge
);

403 
∑ge_íd
 = (
pg_ödex
 << 
PAGE_SHIFT
Ë+ 
PAGE_SIZE
 - 1;

404 
	`lock_exã¡
(
åì
, 
cur
, 
∑ge_íd
, 
NULL
);

405 
	`ªad_lock
(&
em_åì
->
lock
);

406 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 
cur
, 
∑ge_íd
 + 1 - cur);

407 
	`ªad_u∆ock
(&
em_åì
->
lock
);

414 i‡(!
em
 || 
cur
 <Ém->
°¨t
 ||

415 (
cur
 + 
fs_öfo
->
£˘‹size
 > 
	`exã¡_m≠_íd
(
em
)) ||

416 (
em
->
block_°¨t
 >> 
SECTOR_SHIFT
Ë!
‹ig_bio
->
bi_ôî
.
bi_£˘‹
) {

417 
	`‰ì_exã¡_m≠
(
em
);

418 
	`u∆ock_exã¡
(
åì
, 
cur
, 
∑ge_íd
, 
NULL
);

419 
	`u∆ock_∑ge
(
∑ge
);

420 
	`put_∑ge
(
∑ge
);

423 
	`‰ì_exã¡_m≠
(
em
);

425 i‡(
∑ge
->
ödex
 =
íd_ödex
) {

426 
size_t
 
zîo_off£t
 = 
	`off£t_ö_∑ge
(
isize
);

428 i‡(
zîo_off£t
) {

429 
zîos
;

430 
zîos
 = 
PAGE_SIZE
 - 
zîo_off£t
;

431 
	`memzîo_∑ge
(
∑ge
, 
zîo_off£t
, 
zîos
);

435 
add_size
 = 
	`mö
(
em
->
°¨t
 +Ém->
Àn
, 
∑ge_íd
 + 1Ë- 
cur
;

436 
ªt
 = 
	`bio_add_∑ge
(
‹ig_bio
, 
∑ge
, 
add_size
, 
	`off£t_ö_∑ge
(
cur
));

437 i‡(
ªt
 !
add_size
) {

438 
	`u∆ock_exã¡
(
åì
, 
cur
, 
∑ge_íd
, 
NULL
);

439 
	`u∆ock_∑ge
(
∑ge
);

440 
	`put_∑ge
(
∑ge
);

448 i‡(
fs_öfo
->
£˘‹size
 < 
PAGE_SIZE
)

449 
	`båfs_sub∑ge_°¨t_ªadî
(
fs_öfo
, 
∑ge
, 
cur
, 
add_size
);

450 
	`put_∑ge
(
∑ge
);

451 
cur
 +
add_size
;

454 
	}
}

467 
	$båfs_submô_com¥es£d_ªad
(
båfs_bio
 *
bbio
)

469 
båfs_öode
 *
öode
 = 
bbio
->inode;

470 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

471 
exã¡_m≠_åì
 *
em_åì
 = &
öode
->
exã¡_åì
;

472 
com¥es£d_bio
 *
cb
;

473 
com¥es£d_Àn
;

474 
u64
 
fûe_off£t
 = 
bbio
->file_offset;

475 
u64
 
em_Àn
;

476 
u64
 
em_°¨t
;

477 
exã¡_m≠
 *
em
;

478 
pÊags
;

479 
mem°Æl
 = 0;

480 
blk_°©us_t
 
ªt
;

481 
ªt2
;

484 
	`ªad_lock
(&
em_åì
->
lock
);

485 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 
fûe_off£t
, 
fs_öfo
->
£˘‹size
);

486 
	`ªad_u∆ock
(&
em_åì
->
lock
);

487 i‡(!
em
) {

488 
ªt
 = 
BLK_STS_IOERR
;

489 
out
;

492 
	`ASSERT
(
em
->
com¥ess_ty≥
 !
BTRFS_COMPRESS_NONE
);

493 
com¥es£d_Àn
 = 
em
->
block_Àn
;

495 
cb
 = 
	`Æloc_com¥es£d_bio
(
öode
, 
fûe_off£t
, 
REQ_OP_READ
,

496 
íd_com¥es£d_bio_ªad
);

498 
cb
->
°¨t
 = 
em
->
‹ig_°¨t
;

499 
em_Àn
 = 
em
->
Àn
;

500 
em_°¨t
 = 
em
->
°¨t
;

502 
cb
->
Àn
 = 
bbio
->
bio
.
bi_ôî
.
bi_size
;

503 
cb
->
com¥es£d_Àn
 = compressed_len;

504 
cb
->
com¥ess_ty≥
 = 
em
->compress_type;

505 
cb
->
‹ig_bbio
 = 
bbio
;

507 
	`‰ì_exã¡_m≠
(
em
);

509 
cb
->
ƒ_∑ges
 = 
	`DIV_ROUND_UP
(
com¥es£d_Àn
, 
PAGE_SIZE
);

510 
cb
->
com¥es£d_∑ges
 = 
	`kˇŒoc
(cb->
ƒ_∑ges
, (
∑ge
 *), 
GFP_NOFS
);

511 i‡(!
cb
->
com¥es£d_∑ges
) {

512 
ªt
 = 
BLK_STS_RESOURCE
;

513 
out_‰ì_bio
;

516 
ªt2
 = 
	`båfs_Æloc_∑ge_¨øy
(
cb
->
ƒ_∑ges
, cb->
com¥es£d_∑ges
);

517 i‡(
ªt2
) {

518 
ªt
 = 
BLK_STS_RESOURCE
;

519 
out_‰ì_com¥es£d_∑ges
;

522 
	`add_ø_bio_∑ges
(&
öode
->
vfs_öode
, 
em_°¨t
 + 
em_Àn
, 
cb
, &
mem°Æl
,

523 &
pÊags
);

526 
cb
->
Àn
 = 
bbio
->
bio
.
bi_ôî
.
bi_size
;

527 
cb
->
bbio
.
bio
.
bi_ôî
.
bi_£˘‹
 = bbio->bio.bi_iter.bi_sector;

528 
	`båfs_add_com¥es£d_bio_∑ges
(
cb
);

530 i‡(
mem°Æl
)

531 
	`psi_mem°Æl_Àave
(&
pÊags
);

533 
	`båfs_submô_bio
(&
cb
->
bbio
, 0);

536 
out_‰ì_com¥es£d_∑ges
:

537 
	`k‰ì
(
cb
->
com¥es£d_∑ges
);

538 
out_‰ì_bio
:

539 
	`bio_put
(&
cb
->
bbio
.
bio
);

540 
out
:

541 
	`båfs_bio_íd_io
(
bbio
, 
ªt
);

542 
	}
}

551 
	#SAMPLING_READ_SIZE
 (16)

	)

552 
	#SAMPLING_INTERVAL
 (256)

	)

559 
	#BUCKET_SIZE
 (256)

	)

573 
	#MAX_SAMPLE_SIZE
 (
BTRFS_MAX_UNCOMPRESSED
 * \

574 
SAMPLING_READ_SIZE
 / 
SAMPLING_INTERVAL
)

	)

576 
	sbuckë_ôem
 {

577 
u32
 
	mcou¡
;

580 
	sheuri°ic_ws
 {

582 
u8
 *
	mßm∂e
;

583 
u32
 
	mßm∂e_size
;

585 
buckë_ôem
 *
	mbuckë
;

587 
buckë_ôem
 *
	mbuckë_b
;

588 
li°_hód
 
	mli°
;

591 
w‹k•a˚_m™agî
 
	gheuri°ic_wsm
;

593 
	$‰ì_heuri°ic_ws
(
li°_hód
 *
ws
)

595 
heuri°ic_ws
 *
w‹k•a˚
;

597 
w‹k•a˚
 = 
	`li°_íåy
(
ws
, 
heuri°ic_ws
, 
li°
);

599 
	`kv‰ì
(
w‹k•a˚
->
ßm∂e
);

600 
	`k‰ì
(
w‹k•a˚
->
buckë
);

601 
	`k‰ì
(
w‹k•a˚
->
buckë_b
);

602 
	`k‰ì
(
w‹k•a˚
);

603 
	}
}

605 
li°_hód
 *
	$Æloc_heuri°ic_ws
(
Àvñ
)

607 
heuri°ic_ws
 *
ws
;

609 
ws
 = 
	`kzÆloc
((*ws), 
GFP_KERNEL
);

610 i‡(!
ws
)

611  
	`ERR_PTR
(-
ENOMEM
);

613 
ws
->
ßm∂e
 = 
	`kvmÆloc
(
MAX_SAMPLE_SIZE
, 
GFP_KERNEL
);

614 i‡(!
ws
->
ßm∂e
)

615 
Áû
;

617 
ws
->
buckë
 = 
	`kˇŒoc
(
BUCKET_SIZE
, (*ws->buckë), 
GFP_KERNEL
);

618 i‡(!
ws
->
buckë
)

619 
Áû
;

621 
ws
->
buckë_b
 = 
	`kˇŒoc
(
BUCKET_SIZE
, (*ws->buckë_b), 
GFP_KERNEL
);

622 i‡(!
ws
->
buckë_b
)

623 
Áû
;

625 
	`INIT_LIST_HEAD
(&
ws
->
li°
);

626  &
ws
->
li°
;

627 
Áû
:

628 
	`‰ì_heuri°ic_ws
(&
ws
->
li°
);

629  
	`ERR_PTR
(-
ENOMEM
);

630 
	}
}

632 c⁄° 
båfs_com¥ess_›
 
	gbåfs_heuri°ic_com¥ess
 = {

633 .
w‹k•a˚_m™agî
 = &
heuri°ic_wsm
,

636 c⁄° 
båfs_com¥ess_›
 * c⁄° 
	gbåfs_com¥ess_›
[] = {

638 &
båfs_heuri°ic_com¥ess
,

639 &
båfs_zlib_com¥ess
,

640 &
båfs_lzo_com¥ess
,

641 &
båfs_z°d_com¥ess
,

644 
li°_hód
 *
	$Æloc_w‹k•a˚
(
ty≥
, 
Àvñ
)

646 
ty≥
) {

647 
BTRFS_COMPRESS_NONE
:  
	`Æloc_heuri°ic_ws
(
Àvñ
);

648 
BTRFS_COMPRESS_ZLIB
:  
	`zlib_Æloc_w‹k•a˚
(
Àvñ
);

649 
BTRFS_COMPRESS_LZO
:  
	`lzo_Æloc_w‹k•a˚
(
Àvñ
);

650 
BTRFS_COMPRESS_ZSTD
:  
	`z°d_Æloc_w‹k•a˚
(
Àvñ
);

656 
	`BUG
();

658 
	}
}

660 
	$‰ì_w‹k•a˚
(
ty≥
, 
li°_hód
 *
ws
)

662 
ty≥
) {

663 
BTRFS_COMPRESS_NONE
:  
	`‰ì_heuri°ic_ws
(
ws
);

664 
BTRFS_COMPRESS_ZLIB
:  
	`zlib_‰ì_w‹k•a˚
(
ws
);

665 
BTRFS_COMPRESS_LZO
:  
	`lzo_‰ì_w‹k•a˚
(
ws
);

666 
BTRFS_COMPRESS_ZSTD
:  
	`z°d_‰ì_w‹k•a˚
(
ws
);

672 
	`BUG
();

674 
	}
}

676 
	$båfs_öô_w‹k•a˚_m™agî
(
ty≥
)

678 
w‹k•a˚_m™agî
 *
wsm
;

679 
li°_hód
 *
w‹k•a˚
;

681 
wsm
 = 
båfs_com¥ess_›
[
ty≥
]->
w‹k•a˚_m™agî
;

682 
	`INIT_LIST_HEAD
(&
wsm
->
idÀ_ws
);

683 
	`•ö_lock_öô
(&
wsm
->
ws_lock
);

684 
	`©omic_£t
(&
wsm
->
tŸÆ_ws
, 0);

685 
	`öô_waôqueue_hód
(&
wsm
->
ws_waô
);

691 
w‹k•a˚
 = 
	`Æloc_w‹k•a˚
(
ty≥
, 0);

692 i‡(
	`IS_ERR
(
w‹k•a˚
)) {

693 
	`¥_w¨n
(

696 
	`©omic_£t
(&
wsm
->
tŸÆ_ws
, 1);

697 
wsm
->
‰ì_ws
 = 1;

698 
	`li°_add
(
w‹k•a˚
, &
wsm
->
idÀ_ws
);

700 
	}
}

702 
	$båfs_˛ónup_w‹k•a˚_m™agî
(
ty≥
)

704 
w‹k•a˚_m™agî
 *
wsm™
;

705 
li°_hód
 *
ws
;

707 
wsm™
 = 
båfs_com¥ess_›
[
ty≥
]->
w‹k•a˚_m™agî
;

708 !
	`li°_em±y
(&
wsm™
->
idÀ_ws
)) {

709 
ws
 = 
wsm™
->
idÀ_ws
.
√xt
;

710 
	`li°_dñ
(
ws
);

711 
	`‰ì_w‹k•a˚
(
ty≥
, 
ws
);

712 
	`©omic_dec
(&
wsm™
->
tŸÆ_ws
);

714 
	}
}

722 
li°_hód
 *
	$båfs_gë_w‹k•a˚
(
ty≥
, 
Àvñ
)

724 
w‹k•a˚_m™agî
 *
wsm
;

725 
li°_hód
 *
w‹k•a˚
;

726 
˝us
 = 
	`num_⁄löe_˝us
();

727 
nofs_Êag
;

728 
li°_hód
 *
idÀ_ws
;

729 
•ölock_t
 *
ws_lock
;

730 
©omic_t
 *
tŸÆ_ws
;

731 
waô_queue_hód_t
 *
ws_waô
;

732 *
‰ì_ws
;

734 
wsm
 = 
båfs_com¥ess_›
[
ty≥
]->
w‹k•a˚_m™agî
;

735 
idÀ_ws
 = &
wsm
->idle_ws;

736 
ws_lock
 = &
wsm
->ws_lock;

737 
tŸÆ_ws
 = &
wsm
->total_ws;

738 
ws_waô
 = &
wsm
->ws_wait;

739 
‰ì_ws
 = &
wsm
->free_ws;

741 
agaö
:

742 
	`•ö_lock
(
ws_lock
);

743 i‡(!
	`li°_em±y
(
idÀ_ws
)) {

744 
w‹k•a˚
 = 
idÀ_ws
->
√xt
;

745 
	`li°_dñ
(
w‹k•a˚
);

746 (*
‰ì_ws
)--;

747 
	`•ö_u∆ock
(
ws_lock
);

748  
w‹k•a˚
;

751 i‡(
	`©omic_ªad
(
tŸÆ_ws
Ë> 
˝us
) {

752 
	`DEFINE_WAIT
(
waô
);

754 
	`•ö_u∆ock
(
ws_lock
);

755 
	`¥ï¨e_to_waô
(
ws_waô
, &
waô
, 
TASK_UNINTERRUPTIBLE
);

756 i‡(
	`©omic_ªad
(
tŸÆ_ws
Ë> 
˝us
 && !*
‰ì_ws
)

757 
	`scheduÀ
();

758 
	`föish_waô
(
ws_waô
, &
waô
);

759 
agaö
;

761 
	`©omic_öc
(
tŸÆ_ws
);

762 
	`•ö_u∆ock
(
ws_lock
);

769 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

770 
w‹k•a˚
 = 
	`Æloc_w‹k•a˚
(
ty≥
, 
Àvñ
);

771 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

773 i‡(
	`IS_ERR
(
w‹k•a˚
)) {

774 
	`©omic_dec
(
tŸÆ_ws
);

775 
	`wake_up
(
ws_waô
);

787 i‡(
	`©omic_ªad
(
tŸÆ_ws
) == 0) {

788 
	`DEFINE_RATELIMIT_STATE
(
_rs
,

789  60 * 
HZ
,

792 i‡(
	`__øãlimô
(&
_rs
)) {

793 
	`¥_w¨n
("BTRFS:Ço compression workspaces,Üow memory,Ñetrying\n");

796 
agaö
;

798  
w‹k•a˚
;

799 
	}
}

801 
li°_hód
 *
	$gë_w‹k•a˚
(
ty≥
, 
Àvñ
)

803 
ty≥
) {

804 
BTRFS_COMPRESS_NONE
:  
	`båfs_gë_w‹k•a˚
(
ty≥
, 
Àvñ
);

805 
BTRFS_COMPRESS_ZLIB
:  
	`zlib_gë_w‹k•a˚
(
Àvñ
);

806 
BTRFS_COMPRESS_LZO
:  
	`båfs_gë_w‹k•a˚
(
ty≥
, 
Àvñ
);

807 
BTRFS_COMPRESS_ZSTD
:  
	`z°d_gë_w‹k•a˚
(
Àvñ
);

813 
	`BUG
();

815 
	}
}

821 
	$båfs_put_w‹k•a˚
(
ty≥
, 
li°_hód
 *
ws
)

823 
w‹k•a˚_m™agî
 *
wsm
;

824 
li°_hód
 *
idÀ_ws
;

825 
•ölock_t
 *
ws_lock
;

826 
©omic_t
 *
tŸÆ_ws
;

827 
waô_queue_hód_t
 *
ws_waô
;

828 *
‰ì_ws
;

830 
wsm
 = 
båfs_com¥ess_›
[
ty≥
]->
w‹k•a˚_m™agî
;

831 
idÀ_ws
 = &
wsm
->idle_ws;

832 
ws_lock
 = &
wsm
->ws_lock;

833 
tŸÆ_ws
 = &
wsm
->total_ws;

834 
ws_waô
 = &
wsm
->ws_wait;

835 
‰ì_ws
 = &
wsm
->free_ws;

837 
	`•ö_lock
(
ws_lock
);

838 i‡(*
‰ì_ws
 <
	`num_⁄löe_˝us
()) {

839 
	`li°_add
(
ws
, 
idÀ_ws
);

840 (*
‰ì_ws
)++;

841 
	`•ö_u∆ock
(
ws_lock
);

842 
wake
;

844 
	`•ö_u∆ock
(
ws_lock
);

846 
	`‰ì_w‹k•a˚
(
ty≥
, 
ws
);

847 
	`©omic_dec
(
tŸÆ_ws
);

848 
wake
:

849 
	`c⁄d_wake_up
(
ws_waô
);

850 
	}
}

852 
	$put_w‹k•a˚
(
ty≥
, 
li°_hód
 *
ws
)

854 
ty≥
) {

855 
BTRFS_COMPRESS_NONE
:  
	`båfs_put_w‹k•a˚
(
ty≥
, 
ws
);

856 
BTRFS_COMPRESS_ZLIB
:  
	`båfs_put_w‹k•a˚
(
ty≥
, 
ws
);

857 
BTRFS_COMPRESS_LZO
:  
	`båfs_put_w‹k•a˚
(
ty≥
, 
ws
);

858 
BTRFS_COMPRESS_ZSTD
:  
	`z°d_put_w‹k•a˚
(
ws
);

864 
	`BUG
();

866 
	}
}

872 
	$båfs_com¥ess_£t_Àvñ
(
ty≥
, 
Àvñ
)

874 c⁄° 
båfs_com¥ess_›
 *
›s
 = båfs_com¥ess_›[
ty≥
];

876 i‡(
Àvñ
 == 0)

877 
Àvñ
 = 
›s
->
deÁu…_Àvñ
;

879 
Àvñ
 = 
	`mö
÷evñ, 
›s
->
max_Àvñ
);

881  
Àvñ
;

882 
	}
}

904 
	$båfs_com¥ess_∑ges
(
ty≥_Àvñ
, 
addªss_•a˚
 *
m≠pög
,

905 
u64
 
°¨t
, 
∑ge
 **
∑ges
,

906 *
out_∑ges
,

907 *
tŸÆ_ö
,

908 *
tŸÆ_out
)

910 
ty≥
 = 
	`båfs_com¥ess_ty≥
(
ty≥_Àvñ
);

911 
Àvñ
 = 
	`båfs_com¥ess_Àvñ
(
ty≥_Àvñ
);

912 
li°_hód
 *
w‹k•a˚
;

913 
ªt
;

915 
Àvñ
 = 
	`båfs_com¥ess_£t_Àvñ
(
ty≥
,Üevel);

916 
w‹k•a˚
 = 
	`gë_w‹k•a˚
(
ty≥
, 
Àvñ
);

917 
ªt
 = 
	`com¥essi⁄_com¥ess_∑ges
(
ty≥
, 
w‹k•a˚
, 
m≠pög
, 
°¨t
, 
∑ges
,

918 
out_∑ges
, 
tŸÆ_ö
, 
tŸÆ_out
);

919 
	`put_w‹k•a˚
(
ty≥
, 
w‹k•a˚
);

920  
ªt
;

921 
	}
}

923 
	$båfs_decom¥ess_bio
(
com¥es£d_bio
 *
cb
)

925 
li°_hód
 *
w‹k•a˚
;

926 
ªt
;

927 
ty≥
 = 
cb
->
com¥ess_ty≥
;

929 
w‹k•a˚
 = 
	`gë_w‹k•a˚
(
ty≥
, 0);

930 
ªt
 = 
	`com¥essi⁄_decom¥ess_bio
(
w‹k•a˚
, 
cb
);

931 
	`put_w‹k•a˚
(
ty≥
, 
w‹k•a˚
);

933 i‡(!
ªt
)

934 
	`zîo_fûl_bio
(&
cb
->
‹ig_bbio
->
bio
);

935  
ªt
;

936 
	}
}

943 
	$båfs_decom¥ess
(
ty≥
, c⁄° 
u8
 *
d©a_ö
, 
∑ge
 *
de°_∑ge
,

944 
°¨t_byã
, 
size_t
 
§˛í
, size_à
de°Àn
)

946 
li°_hód
 *
w‹k•a˚
;

947 
ªt
;

949 
w‹k•a˚
 = 
	`gë_w‹k•a˚
(
ty≥
, 0);

950 
ªt
 = 
	`com¥essi⁄_decom¥ess
(
ty≥
, 
w‹k•a˚
, 
d©a_ö
, 
de°_∑ge
,

951 
°¨t_byã
, 
§˛í
, 
de°Àn
);

952 
	`put_w‹k•a˚
(
ty≥
, 
w‹k•a˚
);

954  
ªt
;

955 
	}
}

957 
__öô
 
	$båfs_öô_com¥ess
()

959 i‡(
	`bio£t_öô
(&
båfs_com¥es£d_bio£t
, 
BIO_POOL_SIZE
,

960 
	`off£tof
(
com¥es£d_bio
, 
bbio
.
bio
),

961 
BIOSET_NEED_BVECS
))

962  -
ENOMEM
;

963 
	`båfs_öô_w‹k•a˚_m™agî
(
BTRFS_COMPRESS_NONE
);

964 
	`båfs_öô_w‹k•a˚_m™agî
(
BTRFS_COMPRESS_ZLIB
);

965 
	`båfs_öô_w‹k•a˚_m™agî
(
BTRFS_COMPRESS_LZO
);

966 
	`z°d_öô_w‹k•a˚_m™agî
();

968 
	}
}

970 
__cﬁd
 
	$båfs_exô_com¥ess
()

972 
	`båfs_˛ónup_w‹k•a˚_m™agî
(
BTRFS_COMPRESS_NONE
);

973 
	`båfs_˛ónup_w‹k•a˚_m™agî
(
BTRFS_COMPRESS_ZLIB
);

974 
	`båfs_˛ónup_w‹k•a˚_m™agî
(
BTRFS_COMPRESS_LZO
);

975 
	`z°d_˛ónup_w‹k•a˚_m™agî
();

976 
	`bio£t_exô
(&
båfs_com¥es£d_bio£t
);

977 
	}
}

1009 
	$båfs_decom¥ess_buf2∑ge
(c⁄° *
buf
, 
u32
 
buf_Àn
,

1010 
com¥es£d_bio
 *
cb
, 
u32
 
decom¥es£d
)

1012 
bio
 *
‹ig_bio
 = &
cb
->
‹ig_bbio
->bio;

1014 
u32
 
cur_off£t
;

1016 
cur_off£t
 = 
decom¥es£d
;

1018 
cur_off£t
 < 
decom¥es£d
 + 
buf_Àn
) {

1019 
bio_vec
 
bvec
;

1020 
size_t
 
c›y_Àn
;

1021 
u32
 
c›y_°¨t
;

1023 
u32
 
bvec_off£t
;

1025 
bvec
 = 
	`bio_ôî_iovec
(
‹ig_bio
, orig_bio->
bi_ôî
);

1030 
bvec_off£t
 = 
	`∑ge_off£t
(
bvec
.
bv_∑ge
Ë+ bvec.
bv_off£t
 - 
cb
->
°¨t
;

1033 i‡(
decom¥es£d
 + 
buf_Àn
 <
bvec_off£t
)

1036 
c›y_°¨t
 = 
	`max
(
cur_off£t
, 
bvec_off£t
);

1037 
c›y_Àn
 = 
	`mö
(
bvec_off£t
 + 
bvec
.
bv_Àn
,

1038 
decom¥es£d
 + 
buf_Àn
Ë- 
c›y_°¨t
;

1039 
	`ASSERT
(
c›y_Àn
);

1045 
	`ASSERT
(
c›y_°¨t
 - 
decom¥es£d
 < 
buf_Àn
);

1046 
	`mem˝y_to_∑ge
(
bvec
.
bv_∑ge
, bvec.
bv_off£t
,

1047 
buf
 + 
c›y_°¨t
 - 
decom¥es£d
, 
c›y_Àn
);

1048 
cur_off£t
 +
c›y_Àn
;

1050 
	`bio_adv™˚
(
‹ig_bio
, 
c›y_Àn
);

1052 i‡(!
‹ig_bio
->
bi_ôî
.
bi_size
)

1056 
	}
}

1075 
	#ENTROPY_LVL_ACEPTABLE
 (65)

	)

1076 
	#ENTROPY_LVL_HIGH
 (80)

	)

1088 
ölöe
 
u32
 
	$ûog2_w
(
u64
 
n
)

1090  
	`ûog2
(
n
 *Ç *Ç *Ç);

1091 
	}
}

1093 
u32
 
	$sh™n⁄_íå›y
(
heuri°ic_ws
 *
ws
)

1095 c⁄° 
u32
 
íå›y_max
 = 8 * 
	`ûog2_w
(2);

1096 
u32
 
íå›y_sum
 = 0;

1097 
u32
 
p
, 
p_ba£
, 
sz_ba£
;

1098 
u32
 
i
;

1100 
sz_ba£
 = 
	`ûog2_w
(
ws
->
ßm∂e_size
);

1101 
i
 = 0; i < 
BUCKET_SIZE
 && 
ws
->
buckë
[i].
cou¡
 > 0; i++) {

1102 
p
 = 
ws
->
buckë
[
i
].
cou¡
;

1103 
p_ba£
 = 
	`ûog2_w
(
p
);

1104 
íå›y_sum
 +
p
 * (
sz_ba£
 - 
p_ba£
);

1107 
íå›y_sum
 /
ws
->
ßm∂e_size
;

1108  
íå›y_sum
 * 100 / 
íå›y_max
;

1109 
	}
}

1111 
	#RADIX_BASE
 4U

	)

1112 
	#COUNTERS_SIZE
 (1U << 
RADIX_BASE
)

	)

1114 
u8
 
	$gë4bôs
(
u64
 
num
, 
shi·
) {

1115 
u8
 
low4bôs
;

1117 
num
 >>
shi·
;

1119 
low4bôs
 = (
COUNTERS_SIZE
 - 1Ë- (
num
 % COUNTERS_SIZE);

1120  
low4bôs
;

1121 
	}
}

1132 
	$ødix_s‹t
(
buckë_ôem
 *
¨øy
, buckë_ôem *
¨øy_buf
,

1133 
num
)

1135 
u64
 
max_num
;

1136 
u64
 
buf_num
;

1137 
u32
 
cou¡îs
[
COUNTERS_SIZE
];

1138 
u32
 
√w_addr
;

1139 
u32
 
addr
;

1140 
bôÀn
;

1141 
shi·
;

1142 
i
;

1148 
max_num
 = 
¨øy
[0].
cou¡
;

1149 
i
 = 1; i < 
num
; i++) {

1150 
buf_num
 = 
¨øy
[
i
].
cou¡
;

1151 i‡(
buf_num
 > 
max_num
)

1152 
max_num
 = 
buf_num
;

1155 
buf_num
 = 
	`ûog2
(
max_num
);

1156 
bôÀn
 = 
	`ALIGN
(
buf_num
, 
RADIX_BASE
 * 2);

1158 
shi·
 = 0;

1159 
shi·
 < 
bôÀn
) {

1160 
	`mem£t
(
cou¡îs
, 0, (counters));

1162 
i
 = 0; i < 
num
; i++) {

1163 
buf_num
 = 
¨øy
[
i
].
cou¡
;

1164 
addr
 = 
	`gë4bôs
(
buf_num
, 
shi·
);

1165 
cou¡îs
[
addr
]++;

1168 
i
 = 1; i < 
COUNTERS_SIZE
; i++)

1169 
cou¡îs
[
i
] += counters[i - 1];

1171 
i
 = 
num
 - 1; i >= 0; i--) {

1172 
buf_num
 = 
¨øy
[
i
].
cou¡
;

1173 
addr
 = 
	`gë4bôs
(
buf_num
, 
shi·
);

1174 
cou¡îs
[
addr
]--;

1175 
√w_addr
 = 
cou¡îs
[
addr
];

1176 
¨øy_buf
[
√w_addr
] = 
¨øy
[
i
];

1179 
shi·
 +
RADIX_BASE
;

1187 
	`mem£t
(
cou¡îs
, 0, (counters));

1189 
i
 = 0; i < 
num
; i ++) {

1190 
buf_num
 = 
¨øy_buf
[
i
].
cou¡
;

1191 
addr
 = 
	`gë4bôs
(
buf_num
, 
shi·
);

1192 
cou¡îs
[
addr
]++;

1195 
i
 = 1; i < 
COUNTERS_SIZE
; i++)

1196 
cou¡îs
[
i
] += counters[i - 1];

1198 
i
 = 
num
 - 1; i >= 0; i--) {

1199 
buf_num
 = 
¨øy_buf
[
i
].
cou¡
;

1200 
addr
 = 
	`gë4bôs
(
buf_num
, 
shi·
);

1201 
cou¡îs
[
addr
]--;

1202 
√w_addr
 = 
cou¡îs
[
addr
];

1203 
¨øy
[
√w_addr
] = 
¨øy_buf
[
i
];

1206 
shi·
 +
RADIX_BASE
;

1208 
	}
}

1226 
	#BYTE_CORE_SET_LOW
 (64)

	)

1227 
	#BYTE_CORE_SET_HIGH
 (200)

	)

1229 
	$byã_c‹e_£t_size
(
heuri°ic_ws
 *
ws
)

1231 
u32
 
i
;

1232 
u32
 
c‹e£t_sum
 = 0;

1233 c⁄° 
u32
 
c‹e_£t_thªshﬁd
 = 
ws
->
ßm∂e_size
 * 90 / 100;

1234 
buckë_ôem
 *
buckë
 = 
ws
->bucket;

1237 
	`ødix_s‹t
(
ws
->
buckë
, ws->
buckë_b
, 
BUCKET_SIZE
);

1239 
i
 = 0; i < 
BYTE_CORE_SET_LOW
; i++)

1240 
c‹e£t_sum
 +
buckë
[
i
].
cou¡
;

1242 i‡(
c‹e£t_sum
 > 
c‹e_£t_thªshﬁd
)

1243  
i
;

1245 ; 
i
 < 
BYTE_CORE_SET_HIGH
 && 
buckë
[i].
cou¡
 > 0; i++) {

1246 
c‹e£t_sum
 +
buckë
[
i
].
cou¡
;

1247 i‡(
c‹e£t_sum
 > 
c‹e_£t_thªshﬁd
)

1251  
i
;

1252 
	}
}

1265 
	#BYTE_SET_THRESHOLD
 (64)

	)

1267 
u32
 
	$byã_£t_size
(c⁄° 
heuri°ic_ws
 *
ws
)

1269 
u32
 
i
;

1270 
u32
 
byã_£t_size
 = 0;

1272 
i
 = 0; i < 
BYTE_SET_THRESHOLD
; i++) {

1273 i‡(
ws
->
buckë
[
i
].
cou¡
 > 0)

1274 
byã_£t_size
++;

1282 ; 
i
 < 
BUCKET_SIZE
; i++) {

1283 i‡(
ws
->
buckë
[
i
].
cou¡
 > 0) {

1284 
byã_£t_size
++;

1285 i‡(
byã_£t_size
 > 
BYTE_SET_THRESHOLD
)

1286  
byã_£t_size
;

1290  
byã_£t_size
;

1291 
	}
}

1293 
boﬁ
 
	$ßm∂e_ª≥©ed_∑âîns
(
heuri°ic_ws
 *
ws
)

1295 c⁄° 
u32
 
hÆf_of_ßm∂e
 = 
ws
->
ßm∂e_size
 / 2;

1296 c⁄° 
u8
 *
d©a
 = 
ws
->
ßm∂e
;

1298  
	`memcmp
(&
d©a
[0], &d©a[
hÆf_of_ßm∂e
], half_of_sample) == 0;

1299 
	}
}

1301 
	$heuri°ic_cﬁÀ˘_ßm∂e
(
öode
 *öode, 
u64
 
°¨t
, u64 
íd
,

1302 
heuri°ic_ws
 *
ws
)

1304 
∑ge
 *page;

1305 
u64
 
ödex
, 
ödex_íd
;

1306 
u32
 
i
, 
cuº_ßm∂e_pos
;

1307 
u8
 *
ö_d©a
;

1318 i‡(
íd
 - 
°¨t
 > 
BTRFS_MAX_UNCOMPRESSED
)

1319 
íd
 = 
°¨t
 + 
BTRFS_MAX_UNCOMPRESSED
;

1321 
ödex
 = 
°¨t
 >> 
PAGE_SHIFT
;

1322 
ödex_íd
 = 
íd
 >> 
PAGE_SHIFT
;

1325 i‡(!
	`PAGE_ALIGNED
(
íd
))

1326 
ödex_íd
++;

1328 
cuº_ßm∂e_pos
 = 0;

1329 
ödex
 < 
ödex_íd
) {

1330 
∑ge
 = 
	`föd_gë_∑ge
(
öode
->
i_m≠pög
, 
ödex
);

1331 
ö_d©a
 = 
	`km≠_loˇl_∑ge
(
∑ge
);

1333 
i
 = 
°¨t
 % 
PAGE_SIZE
;

1334 
i
 < 
PAGE_SIZE
 - 
SAMPLING_READ_SIZE
) {

1336 i‡(
°¨t
 > 
íd
 - 
SAMPLING_READ_SIZE
)

1338 
	`mem˝y
(&
ws
->
ßm∂e
[
cuº_ßm∂e_pos
], &
ö_d©a
[
i
],

1339 
SAMPLING_READ_SIZE
);

1340 
i
 +
SAMPLING_INTERVAL
;

1341 
°¨t
 +
SAMPLING_INTERVAL
;

1342 
cuº_ßm∂e_pos
 +
SAMPLING_READ_SIZE
;

1344 
	`kunm≠_loˇl
(
ö_d©a
);

1345 
	`put_∑ge
(
∑ge
);

1347 
ödex
++;

1350 
ws
->
ßm∂e_size
 = 
cuº_ßm∂e_pos
;

1351 
	}
}

1368 
	$båfs_com¥ess_heuri°ic
(
öode
 *öode, 
u64
 
°¨t
, u64 
íd
)

1370 
li°_hód
 *
ws_li°
 = 
	`gë_w‹k•a˚
(0, 0);

1371 
heuri°ic_ws
 *
ws
;

1372 
u32
 
i
;

1373 
u8
 
byã
;

1374 
ªt
 = 0;

1376 
ws
 = 
	`li°_íåy
(
ws_li°
, 
heuri°ic_ws
, 
li°
);

1378 
	`heuri°ic_cﬁÀ˘_ßm∂e
(
öode
, 
°¨t
, 
íd
, 
ws
);

1380 i‡(
	`ßm∂e_ª≥©ed_∑âîns
(
ws
)) {

1381 
ªt
 = 1;

1382 
out
;

1385 
	`mem£t
(
ws
->
buckë
, 0, (*ws->buckë)*
BUCKET_SIZE
);

1387 
i
 = 0; i < 
ws
->
ßm∂e_size
; i++) {

1388 
byã
 = 
ws
->
ßm∂e
[
i
];

1389 
ws
->
buckë
[
byã
].
cou¡
++;

1392 
i
 = 
	`byã_£t_size
(
ws
);

1393 i‡(
i
 < 
BYTE_SET_THRESHOLD
) {

1394 
ªt
 = 2;

1395 
out
;

1398 
i
 = 
	`byã_c‹e_£t_size
(
ws
);

1399 i‡(
i
 <
BYTE_CORE_SET_LOW
) {

1400 
ªt
 = 3;

1401 
out
;

1404 i‡(
i
 >
BYTE_CORE_SET_HIGH
) {

1405 
ªt
 = 0;

1406 
out
;

1409 
i
 = 
	`sh™n⁄_íå›y
(
ws
);

1410 i‡(
i
 <
ENTROPY_LVL_ACEPTABLE
) {

1411 
ªt
 = 4;

1412 
out
;

1430 i‡(
i
 < 
ENTROPY_LVL_HIGH
) {

1431 
ªt
 = 5;

1432 
out
;

1434 
ªt
 = 0;

1435 
out
;

1438 
out
:

1439 
	`put_w‹k•a˚
(0, 
ws_li°
);

1440  
ªt
;

1441 
	}
}

1447 
	$båfs_com¥ess_°r2Àvñ
(
ty≥
, c⁄° *
°r
)

1449 
Àvñ
 = 0;

1450 
ªt
;

1452 i‡(!
ty≥
)

1455 i‡(
°r
[0] == ':') {

1456 
ªt
 = 
	`k°πouöt
(
°r
 + 1, 10, &
Àvñ
);

1457 i‡(
ªt
)

1458 
Àvñ
 = 0;

1461 
Àvñ
 = 
	`båfs_com¥ess_£t_Àvñ
(
ty≥
,Üevel);

1463  
Àvñ
;

1464 
	}
}

	@compression.h

6 #i‚de‡
BTRFS_COMPRESSION_H


7 
	#BTRFS_COMPRESSION_H


	)

9 
	~<löux/sizes.h
>

10 
	~"bio.h
"

12 
	gbåfs_öode
;

13 
	gbåfs_‹dîed_exã¡
;

26 
	#BTRFS_MAX_COMPRESSED
 (
SZ_128K
)

	)

27 
	#BTRFS_MAX_COMPRESSED_PAGES
 (
BTRFS_MAX_COMPRESSED
 / 
PAGE_SIZE
)

	)

28 
°©ic_as£π
((
BTRFS_MAX_COMPRESSED
 % 
PAGE_SIZE
) == 0);

31 
	#BTRFS_MAX_UNCOMPRESSED
 (
SZ_128K
)

	)

33 
	#BTRFS_ZLIB_DEFAULT_LEVEL
 3

	)

35 
	scom¥es£d_bio
 {

37 
	mƒ_∑ges
;

40 
∑ge
 **
	mcom¥es£d_∑ges
;

43 
u64
 
	m°¨t
;

46 
	mÀn
;

49 
	mcom¥es£d_Àn
;

52 
u8
 
	mcom¥ess_ty≥
;

55 
boﬁ
 
	mwrôeback
;

59 
båfs_bio
 *
	m‹ig_bbio
;

60 
w‹k_°ru˘
 
	mwrôe_íd_w‹k
;

64 
båfs_bio
 
	mbbio
;

67 
ölöe
 
	$båfs_com¥ess_ty≥
(
ty≥_Àvñ
)

69  (
ty≥_Àvñ
 & 0xF);

70 
	}
}

72 
ölöe
 
	$båfs_com¥ess_Àvñ
(
ty≥_Àvñ
)

74  ((
ty≥_Àvñ
 & 0xF0) >> 4);

75 
	}
}

77 
__öô
 
båfs_öô_com¥ess
();

78 
__cﬁd
 
båfs_exô_com¥ess
();

80 
båfs_com¥ess_∑ges
(
ty≥_Àvñ
, 
addªss_•a˚
 *
m≠pög
,

81 
u64
 
°¨t
, 
∑ge
 **
∑ges
,

82 *
out_∑ges
,

83 *
tŸÆ_ö
,

84 *
tŸÆ_out
);

85 
båfs_decom¥ess
(
ty≥
, c⁄° 
u8
 *
d©a_ö
, 
∑ge
 *
de°_∑ge
,

86 
°¨t_byã
, 
size_t
 
§˛í
, size_à
de°Àn
);

87 
båfs_decom¥ess_buf2∑ge
(c⁄° *
buf
, 
u32
 
buf_Àn
,

88 
com¥es£d_bio
 *
cb
, 
u32
 
decom¥es£d
);

90 
båfs_submô_com¥es£d_wrôe
(
båfs_‹dîed_exã¡
 *
‹dîed
,

91 
∑ge
 **
com¥es£d_∑ges
,

92 
ƒ_∑ges
,

93 
blk_›f_t
 
wrôe_Êags
,

94 
boﬁ
 
wrôeback
);

95 
båfs_submô_com¥es£d_ªad
(
båfs_bio
 *
bbio
);

97 
båfs_com¥ess_°r2Àvñ
(
ty≥
, c⁄° *
°r
);

99 
	ebåfs_com¥essi⁄_ty≥
 {

100 
	mBTRFS_COMPRESS_NONE
 = 0,

101 
	mBTRFS_COMPRESS_ZLIB
 = 1,

102 
	mBTRFS_COMPRESS_LZO
 = 2,

103 
	mBTRFS_COMPRESS_ZSTD
 = 3,

104 
	mBTRFS_NR_COMPRESS_TYPES
 = 4,

107 
	sw‹k•a˚_m™agî
 {

108 
li°_hód
 
	midÀ_ws
;

109 
•ölock_t
 
	mws_lock
;

111 
	m‰ì_ws
;

113 
©omic_t
 
	mtŸÆ_ws
;

115 
waô_queue_hód_t
 
	mws_waô
;

118 
li°_hód
 *
båfs_gë_w‹k•a˚
(
ty≥
, 
Àvñ
);

119 
båfs_put_w‹k•a˚
(
ty≥
, 
li°_hód
 *
ws
);

121 
	sbåfs_com¥ess_›
 {

122 
w‹k•a˚_m™agî
 *
	mw‹k•a˚_m™agî
;

124 
	mmax_Àvñ
;

125 
	mdeÁu…_Àvñ
;

129 
	#BTRFS_NR_WORKSPACE_MANAGERS
 
BTRFS_NR_COMPRESS_TYPES


	)

131 c⁄° 
båfs_com¥ess_›
 
båfs_heuri°ic_com¥ess
;

132 c⁄° 
båfs_com¥ess_›
 
båfs_zlib_com¥ess
;

133 c⁄° 
båfs_com¥ess_›
 
båfs_lzo_com¥ess
;

134 c⁄° 
båfs_com¥ess_›
 
båfs_z°d_com¥ess
;

136 c⁄° * 
båfs_com¥ess_ty≥2°r
(
båfs_com¥essi⁄_ty≥
 
ty≥
);

137 
boﬁ
 
båfs_com¥ess_is_vÆid_ty≥
(c⁄° *
°r
, 
size_t
 
Àn
);

139 
båfs_com¥ess_heuri°ic
(
öode
 *öode, 
u64
 
°¨t
, u64 
íd
);

141 
zlib_com¥ess_∑ges
(
li°_hód
 *
ws
, 
addªss_•a˚
 *
m≠pög
,

142 
u64
 
°¨t
, 
∑ge
 **
∑ges
, *
out_∑ges
,

143 *
tŸÆ_ö
, *
tŸÆ_out
);

144 
zlib_decom¥ess_bio
(
li°_hód
 *
ws
, 
com¥es£d_bio
 *
cb
);

145 
zlib_decom¥ess
(
li°_hód
 *
ws
, c⁄° 
u8
 *
d©a_ö
,

146 
∑ge
 *
de°_∑ge
, 
°¨t_byã
, 
size_t
 
§˛í
,

147 
size_t
 
de°Àn
);

148 
li°_hód
 *
zlib_Æloc_w‹k•a˚
(
Àvñ
);

149 
zlib_‰ì_w‹k•a˚
(
li°_hód
 *
ws
);

150 
li°_hód
 *
zlib_gë_w‹k•a˚
(
Àvñ
);

152 
lzo_com¥ess_∑ges
(
li°_hód
 *
ws
, 
addªss_•a˚
 *
m≠pög
,

153 
u64
 
°¨t
, 
∑ge
 **
∑ges
, *
out_∑ges
,

154 *
tŸÆ_ö
, *
tŸÆ_out
);

155 
lzo_decom¥ess_bio
(
li°_hód
 *
ws
, 
com¥es£d_bio
 *
cb
);

156 
lzo_decom¥ess
(
li°_hód
 *
ws
, c⁄° 
u8
 *
d©a_ö
,

157 
∑ge
 *
de°_∑ge
, 
°¨t_byã
, 
size_t
 
§˛í
,

158 
size_t
 
de°Àn
);

159 
li°_hód
 *
lzo_Æloc_w‹k•a˚
(
Àvñ
);

160 
lzo_‰ì_w‹k•a˚
(
li°_hód
 *
ws
);

162 
z°d_com¥ess_∑ges
(
li°_hód
 *
ws
, 
addªss_•a˚
 *
m≠pög
,

163 
u64
 
°¨t
, 
∑ge
 **
∑ges
, *
out_∑ges
,

164 *
tŸÆ_ö
, *
tŸÆ_out
);

165 
z°d_decom¥ess_bio
(
li°_hód
 *
ws
, 
com¥es£d_bio
 *
cb
);

166 
z°d_decom¥ess
(
li°_hód
 *
ws
, c⁄° 
u8
 *
d©a_ö
,

167 
∑ge
 *
de°_∑ge
, 
°¨t_byã
, 
size_t
 
§˛í
,

168 
size_t
 
de°Àn
);

169 
z°d_öô_w‹k•a˚_m™agî
();

170 
z°d_˛ónup_w‹k•a˚_m™agî
();

171 
li°_hód
 *
z°d_Æloc_w‹k•a˚
(
Àvñ
);

172 
z°d_‰ì_w‹k•a˚
(
li°_hód
 *
ws
);

173 
li°_hód
 *
z°d_gë_w‹k•a˚
(
Àvñ
);

174 
z°d_put_w‹k•a˚
(
li°_hód
 *
ws
);

	@ctree.c

6 
	~<löux/sched.h
>

7 
	~<löux/¶ab.h
>

8 
	~<löux/rbåì.h
>

9 
	~<löux/mm.h
>

10 
	~<löux/îr‹-öje˘i⁄.h
>

11 
	~"mesßges.h
"

12 
	~"˘ªe.h
"

13 
	~"disk-io.h
"

14 
	~"å™ß˘i⁄.h
"

15 
	~"¥öt-åì.h
"

16 
	~"lockög.h
"

17 
	~"vﬁumes.h
"

18 
	~"qgroup.h
"

19 
	~"åì-mod-log.h
"

20 
	~"åì-checkî.h
"

21 
	~"fs.h
"

22 
	~"ac˚ss‹s.h
"

23 
	~"exã¡-åì.h
"

24 
	~"ªloˇti⁄.h
"

25 
	~"fûe-ôem.h
"

27 
kmem_ˇche
 *
	gbåfs_∑th_ˇchï
;

29 
•lô_node
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ


30 *
roŸ
, 
båfs_∑th
 *
∑th
, 
Àvñ
);

31 
•lô_Àaf
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
,

32 c⁄° 
båfs_key
 *
ös_key
, 
båfs_∑th
 *
∑th
,

33 
d©a_size
, 
exãnd
);

34 
push_node_À·
(
båfs_å™s_h™dÀ
 *
å™s
,

35 
exã¡_buf„r
 *
d°
,

36 
exã¡_buf„r
 *
§c
, 
em±y
);

37 
bÆ™˚_node_right
(
båfs_å™s_h™dÀ
 *
å™s
,

38 
exã¡_buf„r
 *
d°_buf
,

39 
exã¡_buf„r
 *
§c_buf
);

41 c⁄° 
	sbåfs_csums
 {

42 
u16
 
	msize
;

43 c⁄° 
	m«me
[10];

44 c⁄° 
	mdrivî
[12];

45 } 
	gbåfs_csums
[] = {

46 [
BTRFS_CSUM_TYPE_CRC32
] = { .
size
 = 4, .
	g«me
 = "crc32c" },

47 [
BTRFS_CSUM_TYPE_XXHASH
] = { .
size
 = 8, .
	g«me
 = "xxhash64" },

48 [
BTRFS_CSUM_TYPE_SHA256
] = { .
size
 = 32, .
	g«me
 = "sha256" },

49 [
BTRFS_CSUM_TYPE_BLAKE2
] = { .
size
 = 32, .
	g«me
 = "blake2b",

50 .
	gdrivî
 = "blake2b-256" },

57 
	$Àaf_d©a_íd
(c⁄° 
exã¡_buf„r
 *
Àaf
)

59 
u32
 
ƒ
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

61 i‡(
ƒ
 == 0)

62  
	`BTRFS_LEAF_DATA_SIZE
(
Àaf
->
fs_öfo
);

63  
	`båfs_ôem_off£t
(
Àaf
, 
ƒ
 - 1);

64 
	}
}

79 
ölöe
 
	$memmove_Àaf_d©a
(c⁄° 
exã¡_buf„r
 *
Àaf
,

80 
d°_off£t
,

81 
§c_off£t
,

82 
Àn
)

84 
	`memmove_exã¡_buf„r
(
Àaf
, 
	`båfs_ôem_ƒ_off£t
÷óf, 0Ë+ 
d°_off£t
,

85 
	`båfs_ôem_ƒ_off£t
(
Àaf
, 0Ë+ 
§c_off£t
, 
Àn
);

86 
	}
}

102 
ölöe
 
	$c›y_Àaf_d©a
(c⁄° 
exã¡_buf„r
 *
d°
,

103 c⁄° 
exã¡_buf„r
 *
§c
,

104 
d°_off£t
,

105 
§c_off£t
, 
Àn
)

107 
	`c›y_exã¡_buf„r
(
d°
, 
§c
, 
	`båfs_ôem_ƒ_off£t
(d°, 0Ë+ 
d°_off£t
,

108 
	`båfs_ôem_ƒ_off£t
(
§c
, 0Ë+ 
§c_off£t
, 
Àn
);

109 
	}
}

122 
ölöe
 
	$memmove_Àaf_ôems
(c⁄° 
exã¡_buf„r
 *
Àaf
,

123 
d°_ôem
, 
§c_ôem
, 
ƒ_ôems
)

125 
	`memmove_exã¡_buf„r
(
Àaf
, 
	`båfs_ôem_ƒ_off£t
÷óf, 
d°_ôem
),

126 
	`båfs_ôem_ƒ_off£t
(
Àaf
, 
§c_ôem
),

127 
ƒ_ôems
 * (
båfs_ôem
));

128 
	}
}

142 
ölöe
 
	$c›y_Àaf_ôems
(c⁄° 
exã¡_buf„r
 *
d°
,

143 c⁄° 
exã¡_buf„r
 *
§c
,

144 
d°_ôem
, 
§c_ôem
, 
ƒ_ôems
)

146 
	`c›y_exã¡_buf„r
(
d°
, 
§c
, 
	`båfs_ôem_ƒ_off£t
(d°, 
d°_ôem
),

147 
	`båfs_ôem_ƒ_off£t
(
§c
, 
§c_ôem
),

148 
ƒ_ôems
 * (
båfs_ôem
));

149 
	}
}

152 
u16
 
	$båfs_csum_ty≥_size
(
u16
 
ty≥
)

154  
båfs_csums
[
ty≥
].
size
;

155 
	}
}

157 
	$båfs_su≥r_csum_size
(c⁄° 
båfs_su≥r_block
 *
s
)

159 
u16
 
t
 = 
	`båfs_su≥r_csum_ty≥
(
s
);

163  
	`båfs_csum_ty≥_size
(
t
);

164 
	}
}

166 c⁄° *
	$båfs_su≥r_csum_«me
(
u16
 
csum_ty≥
)

169  
båfs_csums
[
csum_ty≥
].
«me
;

170 
	}
}

176 c⁄° *
	$båfs_su≥r_csum_drivî
(
u16
 
csum_ty≥
)

179  
båfs_csums
[
csum_ty≥
].
drivî
[0] ?

180 
båfs_csums
[
csum_ty≥
].
drivî
 :

181 
båfs_csums
[
csum_ty≥
].
«me
;

182 
	}
}

184 
size_t
 
__©åibuã_c⁄°__
 
	$båfs_gë_num_csums
()

186  
	`ARRAY_SIZE
(
båfs_csums
);

187 
	}
}

189 
båfs_∑th
 *
	$båfs_Æloc_∑th
()

191 
	`might_¶ìp
();

193  
	`kmem_ˇche_zÆloc
(
båfs_∑th_ˇchï
, 
GFP_NOFS
);

194 
	}
}

197 
	$båfs_‰ì_∑th
(
båfs_∑th
 *
p
)

199 i‡(!
p
)

201 
	`båfs_ªÀa£_∑th
(
p
);

202 
	`kmem_ˇche_‰ì
(
båfs_∑th_ˇchï
, 
p
);

203 
	}
}

211 
noölöe
 
	$båfs_ªÀa£_∑th
(
båfs_∑th
 *
p
)

213 
i
;

215 
i
 = 0; i < 
BTRFS_MAX_LEVEL
; i++) {

216 
p
->
¶Ÿs
[
i
] = 0;

217 i‡(!
p
->
nodes
[
i
])

219 i‡(
p
->
locks
[
i
]) {

220 
	`båfs_åì_u∆ock_rw
(
p
->
nodes
[
i
],Ö->
locks
[i]);

221 
p
->
locks
[
i
] = 0;

223 
	`‰ì_exã¡_buf„r
(
p
->
nodes
[
i
]);

224 
p
->
nodes
[
i
] = 
NULL
;

226 
	}
}

233 
boﬁ
 
__cﬁd
 
	$ab‹t_should_¥öt_°ack
(
î∫o
)

235 
î∫o
) {

236 -
EIO
:

237 -
EROFS
:

238 -
ENOMEM
:

239  
Ál£
;

241  
åue
;

242 
	}
}

254 
exã¡_buf„r
 *
	$båfs_roŸ_node
(
båfs_roŸ
 *
roŸ
)

256 
exã¡_buf„r
 *
eb
;

259 
	`rcu_ªad_lock
();

260 
eb
 = 
	`rcu_dîe„ªn˚
(
roŸ
->
node
);

268 i‡(
	`©omic_öc_nŸ_zîo
(&
eb
->
ªfs
)) {

269 
	`rcu_ªad_u∆ock
();

272 
	`rcu_ªad_u∆ock
();

273 
	`synchr⁄ize_rcu
();

275  
eb
;

276 
	}
}

283 
	$add_roŸ_to_dúty_li°
(
båfs_roŸ
 *
roŸ
)

285 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

287 i‡(
	`ã°_bô
(
BTRFS_ROOT_DIRTY
, &
roŸ
->
°©e
) ||

288 !
	`ã°_bô
(
BTRFS_ROOT_TRACK_DIRTY
, &
roŸ
->
°©e
))

291 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

292 i‡(!
	`ã°_™d_£t_bô
(
BTRFS_ROOT_DIRTY
, &
roŸ
->
°©e
)) {

294 i‡(
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_EXTENT_TREE_OBJECTID
)

295 
	`li°_move_èû
(&
roŸ
->
dúty_li°
,

296 &
fs_öfo
->
dúty_cow⁄ly_roŸs
);

298 
	`li°_move
(&
roŸ
->
dúty_li°
,

299 &
fs_öfo
->
dúty_cow⁄ly_roŸs
);

301 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

302 
	}
}

309 
	$båfs_c›y_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

310 
båfs_roŸ
 *
roŸ
,

311 
exã¡_buf„r
 *
buf
,

312 
exã¡_buf„r
 **
cow_ªt
, 
u64
 
√w_roŸ_obje˘id
)

314 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

315 
exã¡_buf„r
 *
cow
;

316 
ªt
 = 0;

317 
Àvñ
;

318 
båfs_disk_key
 
disk_key
;

320 
	`WARN_ON
(
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
) &&

321 
å™s
->
å™sid
 !
fs_öfo
->
ru¬ög_å™ß˘i⁄
->transid);

322 
	`WARN_ON
(
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
) &&

323 
å™s
->
å™sid
 !
roŸ
->
œ°_å™s
);

325 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
buf
);

326 i‡(
Àvñ
 == 0)

327 
	`båfs_ôem_key
(
buf
, &
disk_key
, 0);

329 
	`båfs_node_key
(
buf
, &
disk_key
, 0);

331 
cow
 = 
	`båfs_Æloc_åì_block
(
å™s
, 
roŸ
, 0, 
√w_roŸ_obje˘id
,

332 &
disk_key
, 
Àvñ
, 
buf
->
°¨t
, 0,

333 
BTRFS_NESTING_NEW_ROOT
);

334 i‡(
	`IS_ERR
(
cow
))

335  
	`PTR_ERR
(
cow
);

337 
	`c›y_exã¡_buf„r_fuŒ
(
cow
, 
buf
);

338 
	`båfs_£t_hódî_byãƒ
(
cow
, cow->
°¨t
);

339 
	`båfs_£t_hódî_gíî©i⁄
(
cow
, 
å™s
->
å™sid
);

340 
	`båfs_£t_hódî_backªf_ªv
(
cow
, 
BTRFS_MIXED_BACKREF_REV
);

341 
	`båfs_˛ór_hódî_Êag
(
cow
, 
BTRFS_HEADER_FLAG_WRITTEN
 |

342 
BTRFS_HEADER_FLAG_RELOC
);

343 i‡(
√w_roŸ_obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
)

344 
	`båfs_£t_hódî_Êag
(
cow
, 
BTRFS_HEADER_FLAG_RELOC
);

346 
	`båfs_£t_hódî_ow√r
(
cow
, 
√w_roŸ_obje˘id
);

348 
	`wrôe_exã¡_buf„r_fsid
(
cow
, 
fs_öfo
->
fs_devi˚s
->
mëad©a_uuid
);

350 
	`WARN_ON
(
	`båfs_hódî_gíî©i⁄
(
buf
Ë> 
å™s
->
å™sid
);

351 i‡(
√w_roŸ_obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
)

352 
ªt
 = 
	`båfs_öc_ªf
(
å™s
, 
roŸ
, 
cow
, 1);

354 
ªt
 = 
	`båfs_öc_ªf
(
å™s
, 
roŸ
, 
cow
, 0);

355 i‡(
ªt
) {

356 
	`båfs_åì_u∆ock
(
cow
);

357 
	`‰ì_exã¡_buf„r
(
cow
);

358 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

359  
ªt
;

362 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
cow
);

363 *
cow_ªt
 = 
cow
;

365 
	}
}

370 
	$båfs_block_ˇn_be_sh¨ed
(
båfs_å™s_h™dÀ
 *
å™s
,

371 
båfs_roŸ
 *
roŸ
,

372 
exã¡_buf„r
 *
buf
)

379 i‡(
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
) &&

380 
buf
 !
roŸ
->
node
 &&

381 (
	`båfs_hódî_gíî©i⁄
(
buf
) <=

382 
	`båfs_roŸ_œ°_¢≠shŸ
(&
roŸ
->
roŸ_ôem
) ||

383 
	`båfs_hódî_Êag
(
buf
, 
BTRFS_HEADER_FLAG_RELOC
))) {

384 i‡(
buf
 !
roŸ
->
commô_roŸ
)

392 i‡(
	`båfs_hódî_gíî©i⁄
(
buf
Ë=
å™s
->
å™sid
)

397 
	}
}

399 
noölöe
 
	$upd©e_ªf_f‹_cow
(
båfs_å™s_h™dÀ
 *
å™s
,

400 
båfs_roŸ
 *
roŸ
,

401 
exã¡_buf„r
 *
buf
,

402 
exã¡_buf„r
 *
cow
,

403 *
œ°_ªf
)

405 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

406 
u64
 
ªfs
;

407 
u64
 
ow√r
;

408 
u64
 
Êags
;

409 
u64
 
√w_Êags
 = 0;

410 
ªt
;

429 i‡(
	`båfs_block_ˇn_be_sh¨ed
(
å™s
, 
roŸ
, 
buf
)) {

430 
ªt
 = 
	`båfs_lookup_exã¡_öfo
(
å™s
, 
fs_öfo
, 
buf
->
°¨t
,

431 
	`båfs_hódî_Àvñ
(
buf
), 1,

432 &
ªfs
, &
Êags
);

433 i‡(
ªt
)

434  
ªt
;

435 i‡(
	`u∆ikñy
(
ªfs
 == 0)) {

436 
	`båfs_¸ô
(
fs_öfo
,

438 
buf
->
°¨t
, 
	`båfs_hódî_Àvñ
(buf),

439 
	`båfs_roŸ_id
(
roŸ
));

440 
ªt
 = -
EUCLEAN
;

441 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

442  
ªt
;

445 
ªfs
 = 1;

446 i‡(
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
 ||

447 
	`båfs_hódî_backªf_ªv
(
buf
Ë< 
BTRFS_MIXED_BACKREF_REV
)

448 
Êags
 = 
BTRFS_BLOCK_FLAG_FULL_BACKREF
;

450 
Êags
 = 0;

453 
ow√r
 = 
	`båfs_hódî_ow√r
(
buf
);

454 
	`BUG_ON
(
ow√r
 =
BTRFS_TREE_RELOC_OBJECTID
 &&

455 !(
Êags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
));

457 i‡(
ªfs
 > 1) {

458 i‡((
ow√r
 =
roŸ
->
roŸ_key
.
obje˘id
 ||

459 
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
) &&

460 !(
Êags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
)) {

461 
ªt
 = 
	`båfs_öc_ªf
(
å™s
, 
roŸ
, 
buf
, 1);

462 i‡(
ªt
)

463  
ªt
;

465 i‡(
roŸ
->
roŸ_key
.
obje˘id
 ==

466 
BTRFS_TREE_RELOC_OBJECTID
) {

467 
ªt
 = 
	`båfs_dec_ªf
(
å™s
, 
roŸ
, 
buf
, 0);

468 i‡(
ªt
)

469  
ªt
;

470 
ªt
 = 
	`båfs_öc_ªf
(
å™s
, 
roŸ
, 
cow
, 1);

471 i‡(
ªt
)

472  
ªt
;

474 
√w_Êags
 |
BTRFS_BLOCK_FLAG_FULL_BACKREF
;

477 i‡(
roŸ
->
roŸ_key
.
obje˘id
 ==

478 
BTRFS_TREE_RELOC_OBJECTID
)

479 
ªt
 = 
	`båfs_öc_ªf
(
å™s
, 
roŸ
, 
cow
, 1);

481 
ªt
 = 
	`båfs_öc_ªf
(
å™s
, 
roŸ
, 
cow
, 0);

482 i‡(
ªt
)

483  
ªt
;

485 i‡(
√w_Êags
 != 0) {

486 
ªt
 = 
	`båfs_£t_disk_exã¡_Êags
(
å™s
, 
buf
, 
√w_Êags
);

487 i‡(
ªt
)

488  
ªt
;

491 i‡(
Êags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
) {

492 i‡(
roŸ
->
roŸ_key
.
obje˘id
 ==

493 
BTRFS_TREE_RELOC_OBJECTID
)

494 
ªt
 = 
	`båfs_öc_ªf
(
å™s
, 
roŸ
, 
cow
, 1);

496 
ªt
 = 
	`båfs_öc_ªf
(
å™s
, 
roŸ
, 
cow
, 0);

497 i‡(
ªt
)

498  
ªt
;

499 
ªt
 = 
	`båfs_dec_ªf
(
å™s
, 
roŸ
, 
buf
, 1);

500 i‡(
ªt
)

501  
ªt
;

503 
	`båfs_˛ór_buf„r_dúty
(
å™s
, 
buf
);

504 *
œ°_ªf
 = 1;

507 
	}
}

521 
noölöe
 
	$__båfs_cow_block
(
båfs_å™s_h™dÀ
 *
å™s
,

522 
båfs_roŸ
 *
roŸ
,

523 
exã¡_buf„r
 *
buf
,

524 
exã¡_buf„r
 *
∑ª¡
, 
∑ª¡_¶Ÿ
,

525 
exã¡_buf„r
 **
cow_ªt
,

526 
u64
 
£¨ch_°¨t
, u64 
em±y_size
,

527 
båfs_lock_√°ög
 
√°
)

529 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

530 
båfs_disk_key
 
disk_key
;

531 
exã¡_buf„r
 *
cow
;

532 
Àvñ
, 
ªt
;

533 
œ°_ªf
 = 0;

534 
u∆ock_‹ig
 = 0;

535 
u64
 
∑ª¡_°¨t
 = 0;

537 i‡(*
cow_ªt
 =
buf
)

538 
u∆ock_‹ig
 = 1;

540 
	`båfs_as£π_åì_wrôe_locked
(
buf
);

542 
	`WARN_ON
(
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
) &&

543 
å™s
->
å™sid
 !
fs_öfo
->
ru¬ög_å™ß˘i⁄
->transid);

544 
	`WARN_ON
(
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
) &&

545 
å™s
->
å™sid
 !
roŸ
->
œ°_å™s
);

547 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
buf
);

549 i‡(
Àvñ
 == 0)

550 
	`båfs_ôem_key
(
buf
, &
disk_key
, 0);

552 
	`båfs_node_key
(
buf
, &
disk_key
, 0);

554 i‡((
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
Ë&& 
∑ª¡
)

555 
∑ª¡_°¨t
 = 
∑ª¡
->
°¨t
;

557 
cow
 = 
	`båfs_Æloc_åì_block
(
å™s
, 
roŸ
, 
∑ª¡_°¨t
,

558 
roŸ
->
roŸ_key
.
obje˘id
, &
disk_key
, 
Àvñ
,

559 
£¨ch_°¨t
, 
em±y_size
, 
√°
);

560 i‡(
	`IS_ERR
(
cow
))

561  
	`PTR_ERR
(
cow
);

565 
	`c›y_exã¡_buf„r_fuŒ
(
cow
, 
buf
);

566 
	`båfs_£t_hódî_byãƒ
(
cow
, cow->
°¨t
);

567 
	`båfs_£t_hódî_gíî©i⁄
(
cow
, 
å™s
->
å™sid
);

568 
	`båfs_£t_hódî_backªf_ªv
(
cow
, 
BTRFS_MIXED_BACKREF_REV
);

569 
	`båfs_˛ór_hódî_Êag
(
cow
, 
BTRFS_HEADER_FLAG_WRITTEN
 |

570 
BTRFS_HEADER_FLAG_RELOC
);

571 i‡(
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
)

572 
	`båfs_£t_hódî_Êag
(
cow
, 
BTRFS_HEADER_FLAG_RELOC
);

574 
	`båfs_£t_hódî_ow√r
(
cow
, 
roŸ
->
roŸ_key
.
obje˘id
);

576 
	`wrôe_exã¡_buf„r_fsid
(
cow
, 
fs_öfo
->
fs_devi˚s
->
mëad©a_uuid
);

578 
ªt
 = 
	`upd©e_ªf_f‹_cow
(
å™s
, 
roŸ
, 
buf
, 
cow
, &
œ°_ªf
);

579 i‡(
ªt
) {

580 
	`båfs_åì_u∆ock
(
cow
);

581 
	`‰ì_exã¡_buf„r
(
cow
);

582 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

583  
ªt
;

586 i‡(
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
)) {

587 
ªt
 = 
	`båfs_ªloc_cow_block
(
å™s
, 
roŸ
, 
buf
, 
cow
);

588 i‡(
ªt
) {

589 
	`båfs_åì_u∆ock
(
cow
);

590 
	`‰ì_exã¡_buf„r
(
cow
);

591 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

592  
ªt
;

596 i‡(
buf
 =
roŸ
->
node
) {

597 
	`WARN_ON
(
∑ª¡
 &&Ö¨íà!
buf
);

598 i‡(
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
 ||

599 
	`båfs_hódî_backªf_ªv
(
buf
Ë< 
BTRFS_MIXED_BACKREF_REV
)

600 
∑ª¡_°¨t
 = 
buf
->
°¨t
;

602 
ªt
 = 
	`båfs_åì_mod_log_ö£π_roŸ
(
roŸ
->
node
, 
cow
, 
åue
);

603 i‡(
ªt
 < 0) {

604 
	`båfs_åì_u∆ock
(
cow
);

605 
	`‰ì_exã¡_buf„r
(
cow
);

606 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

607  
ªt
;

609 
	`©omic_öc
(&
cow
->
ªfs
);

610 
	`rcu_assign_poöãr
(
roŸ
->
node
, 
cow
);

612 
	`båfs_‰ì_åì_block
(
å™s
, 
	`båfs_roŸ_id
(
roŸ
), 
buf
,

613 
∑ª¡_°¨t
, 
œ°_ªf
);

614 
	`‰ì_exã¡_buf„r
(
buf
);

615 
	`add_roŸ_to_dúty_li°
(
roŸ
);

617 
	`WARN_ON
(
å™s
->
å™sid
 !
	`båfs_hódî_gíî©i⁄
(
∑ª¡
));

618 
ªt
 = 
	`båfs_åì_mod_log_ö£π_key
(
∑ª¡
, 
∑ª¡_¶Ÿ
,

619 
BTRFS_MOD_LOG_KEY_REPLACE
);

620 i‡(
ªt
) {

621 
	`båfs_åì_u∆ock
(
cow
);

622 
	`‰ì_exã¡_buf„r
(
cow
);

623 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

624  
ªt
;

626 
	`båfs_£t_node_block±r
(
∑ª¡
, 
∑ª¡_¶Ÿ
,

627 
cow
->
°¨t
);

628 
	`båfs_£t_node_±r_gíî©i⁄
(
∑ª¡
, 
∑ª¡_¶Ÿ
,

629 
å™s
->
å™sid
);

630 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑ª¡
);

631 i‡(
œ°_ªf
) {

632 
ªt
 = 
	`båfs_åì_mod_log_‰ì_eb
(
buf
);

633 i‡(
ªt
) {

634 
	`båfs_åì_u∆ock
(
cow
);

635 
	`‰ì_exã¡_buf„r
(
cow
);

636 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

637  
ªt
;

640 
	`båfs_‰ì_åì_block
(
å™s
, 
	`båfs_roŸ_id
(
roŸ
), 
buf
,

641 
∑ª¡_°¨t
, 
œ°_ªf
);

643 i‡(
u∆ock_‹ig
)

644 
	`båfs_åì_u∆ock
(
buf
);

645 
	`‰ì_exã¡_buf„r_°Æe
(
buf
);

646 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
cow
);

647 *
cow_ªt
 = 
cow
;

649 
	}
}

651 
ölöe
 
	$should_cow_block
(
båfs_å™s_h™dÀ
 *
å™s
,

652 
båfs_roŸ
 *
roŸ
,

653 
exã¡_buf„r
 *
buf
)

655 i‡(
	`båfs_is_ã°ög
(
roŸ
->
fs_öfo
))

659 
	`smp_mb__bef‹e_©omic
();

672 i‡(
	`båfs_hódî_gíî©i⁄
(
buf
Ë=
å™s
->
å™sid
 &&

673 !
	`båfs_hódî_Êag
(
buf
, 
BTRFS_HEADER_FLAG_WRITTEN
) &&

674 !(
roŸ
->
roŸ_key
.
obje˘id
 !
BTRFS_TREE_RELOC_OBJECTID
 &&

675 
	`båfs_hódî_Êag
(
buf
, 
BTRFS_HEADER_FLAG_RELOC
)) &&

676 !
	`ã°_bô
(
BTRFS_ROOT_FORCE_COW
, &
roŸ
->
°©e
))

679 
	}
}

686 
noölöe
 
	$båfs_cow_block
(
båfs_å™s_h™dÀ
 *
å™s
,

687 
båfs_roŸ
 *
roŸ
, 
exã¡_buf„r
 *
buf
,

688 
exã¡_buf„r
 *
∑ª¡
, 
∑ª¡_¶Ÿ
,

689 
exã¡_buf„r
 **
cow_ªt
,

690 
båfs_lock_√°ög
 
√°
)

692 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

693 
u64
 
£¨ch_°¨t
;

694 
ªt
;

696 i‡(
	`u∆ikñy
(
	`ã°_bô
(
BTRFS_ROOT_DELETING
, &
roŸ
->
°©e
))) {

697 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, -
EUCLEAN
);

698 
	`båfs_¸ô
(
fs_öfo
,

700 
buf
->
°¨t
, 
	`båfs_roŸ_id
(
roŸ
));

701  -
EUCLEAN
;

710 i‡(
	`u∆ikñy
(
å™s
->
å™ß˘i⁄
 !
fs_öfo
->
ru¬ög_å™ß˘i⁄
 ||

711 
å™s
->
å™sid
 !
fs_öfo
->
gíî©i⁄
)) {

712 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, -
EUCLEAN
);

713 
	`båfs_¸ô
(
fs_öfo
,

715 
buf
->
°¨t
, 
	`båfs_roŸ_id
(
roŸ
), 
å™s
->
å™sid
,

716 
fs_öfo
->
ru¬ög_å™ß˘i⁄
->
å™sid
,

717 
fs_öfo
->
gíî©i⁄
);

718  -
EUCLEAN
;

721 i‡(!
	`should_cow_block
(
å™s
, 
roŸ
, 
buf
)) {

722 *
cow_ªt
 = 
buf
;

726 
£¨ch_°¨t
 = 
buf
->
°¨t
 & ~((
u64
)
SZ_1G
 - 1);

734 
	`båfs_qgroup_åa˚_subåì_a·î_cow
(
å™s
, 
roŸ
, 
buf
);

735 
ªt
 = 
	`__båfs_cow_block
(
å™s
, 
roŸ
, 
buf
, 
∑ª¡
,

736 
∑ª¡_¶Ÿ
, 
cow_ªt
, 
£¨ch_°¨t
, 0, 
√°
);

738 
	`åa˚_båfs_cow_block
(
roŸ
, 
buf
, *
cow_ªt
);

740  
ªt
;

741 
	}
}

742 
ALLOW_ERROR_INJECTION
(
båfs_cow_block
, 
ERRNO
);

748 
	$˛o£_blocks
(
u64
 
blockƒ
, u64 
Ÿhî
, 
u32
 
blocksize
)

750 i‡(
blockƒ
 < 
Ÿhî
 && othî - (blockƒ + 
blocksize
) < 32768)

752 i‡(
blockƒ
 > 
Ÿhî
 && blockƒ - (Ÿhî + 
blocksize
) < 32768)

755 
	}
}

757 #ifde‡
__LITTLE_ENDIAN


763 
	$comp_keys
(c⁄° 
båfs_disk_key
 *
disk_key
,

764 c⁄° 
båfs_key
 *
k2
)

766 c⁄° 
båfs_key
 *
k1
 = (c⁄° båfs_key *)
disk_key
;

768  
	`båfs_comp_˝u_keys
(
k1
, 
k2
);

769 
	}
}

776 
	$comp_keys
(c⁄° 
båfs_disk_key
 *
disk
,

777 c⁄° 
båfs_key
 *
k2
)

779 
båfs_key
 
k1
;

781 
	`båfs_disk_key_to_˝u
(&
k1
, 
disk
);

783  
	`båfs_comp_˝u_keys
(&
k1
, 
k2
);

784 
	}
}

790 
__puª
 
	$båfs_comp_˝u_keys
(c⁄° 
båfs_key
 *
k1
, c⁄° båfs_key *
k2
)

792 i‡(
k1
->
obje˘id
 > 
k2
->objectid)

794 i‡(
k1
->
obje˘id
 < 
k2
->objectid)

796 i‡(
k1
->
ty≥
 > 
k2
->type)

798 i‡(
k1
->
ty≥
 < 
k2
->type)

800 i‡(
k1
->
off£t
 > 
k2
->offset)

802 i‡(
k1
->
off£t
 < 
k2
->offset)

805 
	}
}

812 
	$båfs_ªÆloc_node
(
båfs_å™s_h™dÀ
 *
å™s
,

813 
båfs_roŸ
 *
roŸ
, 
exã¡_buf„r
 *
∑ª¡
,

814 
°¨t_¶Ÿ
, 
u64
 *
œ°_ªt
,

815 
båfs_key
 *
¥ogªss
)

817 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

818 
exã¡_buf„r
 *
cur
;

819 
u64
 
blockƒ
;

820 
u64
 
£¨ch_°¨t
 = *
œ°_ªt
;

821 
u64
 
œ°_block
 = 0;

822 
u64
 
Ÿhî
;

823 
u32
 
∑ª¡_ƒôems
;

824 
íd_¶Ÿ
;

825 
i
;

826 
îr
 = 0;

827 
u32
 
blocksize
;

828 
¥ogªss_∑s£d
 = 0;

829 
båfs_disk_key
 
disk_key
;

837 i‡(
	`u∆ikñy
(
å™s
->
å™ß˘i⁄
 !
fs_öfo
->
ru¬ög_å™ß˘i⁄
 ||

838 
å™s
->
å™sid
 !
fs_öfo
->
gíî©i⁄
)) {

839 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, -
EUCLEAN
);

840 
	`båfs_¸ô
(
fs_öfo
,

842 
∑ª¡
->
°¨t
, 
	`båfs_roŸ_id
(
roŸ
), 
å™s
->
å™sid
,

843 
fs_öfo
->
ru¬ög_å™ß˘i⁄
->
å™sid
,

844 
fs_öfo
->
gíî©i⁄
);

845  -
EUCLEAN
;

848 
∑ª¡_ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑ª¡
);

849 
blocksize
 = 
fs_öfo
->
nodesize
;

850 
íd_¶Ÿ
 = 
∑ª¡_ƒôems
 - 1;

852 i‡(
∑ª¡_ƒôems
 <= 1)

855 
i
 = 
°¨t_¶Ÿ
; i <
íd_¶Ÿ
; i++) {

856 
˛o£
 = 1;

858 
	`båfs_node_key
(
∑ª¡
, &
disk_key
, 
i
);

859 i‡(!
¥ogªss_∑s£d
 && 
	`comp_keys
(&
disk_key
, 
¥ogªss
) < 0)

862 
¥ogªss_∑s£d
 = 1;

863 
blockƒ
 = 
	`båfs_node_block±r
(
∑ª¡
, 
i
);

864 i‡(
œ°_block
 == 0)

865 
œ°_block
 = 
blockƒ
;

867 i‡(
i
 > 0) {

868 
Ÿhî
 = 
	`båfs_node_block±r
(
∑ª¡
, 
i
 - 1);

869 
˛o£
 = 
	`˛o£_blocks
(
blockƒ
, 
Ÿhî
, 
blocksize
);

871 i‡(!
˛o£
 && 
i
 < 
íd_¶Ÿ
) {

872 
Ÿhî
 = 
	`båfs_node_block±r
(
∑ª¡
, 
i
 + 1);

873 
˛o£
 = 
	`˛o£_blocks
(
blockƒ
, 
Ÿhî
, 
blocksize
);

875 i‡(
˛o£
) {

876 
œ°_block
 = 
blockƒ
;

880 
cur
 = 
	`båfs_ªad_node_¶Ÿ
(
∑ª¡
, 
i
);

881 i‡(
	`IS_ERR
(
cur
))

882  
	`PTR_ERR
(
cur
);

883 i‡(
£¨ch_°¨t
 == 0)

884 
£¨ch_°¨t
 = 
œ°_block
;

886 
	`båfs_åì_lock
(
cur
);

887 
îr
 = 
	`__båfs_cow_block
(
å™s
, 
roŸ
, 
cur
, 
∑ª¡
, 
i
,

888 &
cur
, 
£¨ch_°¨t
,

889 
	`mö
(16 * 
blocksize
,

890 (
íd_¶Ÿ
 - 
i
Ë* 
blocksize
),

891 
BTRFS_NESTING_COW
);

892 i‡(
îr
) {

893 
	`båfs_åì_u∆ock
(
cur
);

894 
	`‰ì_exã¡_buf„r
(
cur
);

897 
£¨ch_°¨t
 = 
cur
->
°¨t
;

898 
œ°_block
 = 
cur
->
°¨t
;

899 *
œ°_ªt
 = 
£¨ch_°¨t
;

900 
	`båfs_åì_u∆ock
(
cur
);

901 
	`‰ì_exã¡_buf„r
(
cur
);

903  
îr
;

904 
	}
}

920 
	$båfs_bö_£¨ch
(
exã¡_buf„r
 *
eb
, 
fú°_¶Ÿ
,

921 c⁄° 
båfs_key
 *
key
, *
¶Ÿ
)

923 
p
;

924 
ôem_size
;

929 
u32
 
low
 = 
fú°_¶Ÿ
;

930 
u32
 
high
 = 
	`båfs_hódî_ƒôems
(
eb
);

931 
ªt
;

932 c⁄° 
key_size
 = (
båfs_disk_key
);

934 i‡(
	`u∆ikñy
(
low
 > 
high
)) {

935 
	`båfs_îr
(
eb
->
fs_öfo
,

937 
__func__
, 
low
, 
high
, 
eb
->
°¨t
,

938 
	`båfs_hódî_ow√r
(
eb
), 
	`båfs_hódî_Àvñ
(eb));

939  -
EINVAL
;

942 i‡(
	`båfs_hódî_Àvñ
(
eb
) == 0) {

943 
p
 = 
	`off£tof
(
båfs_Àaf
, 
ôems
);

944 
ôem_size
 = (
båfs_ôem
);

946 
p
 = 
	`off£tof
(
båfs_node
, 
±rs
);

947 
ôem_size
 = (
båfs_key_±r
);

950 
low
 < 
high
) {

951 
où
;

952 
off£t
;

953 
båfs_disk_key
 *
tmp
;

954 
båfs_disk_key
 
u«lig√d
;

955 
mid
;

957 
mid
 = (
low
 + 
high
) / 2;

958 
off£t
 = 
p
 + 
mid
 * 
ôem_size
;

959 
où
 = 
	`off£t_ö_∑ge
(
off£t
);

961 i‡(
où
 + 
key_size
 <
PAGE_SIZE
) {

962 c⁄° 
idx
 = 
	`gë_eb_∑ge_ödex
(
off£t
);

963 *
kaddr
 = 
	`∑ge_addªss
(
eb
->
∑ges
[
idx
]);

965 
où
 = 
	`gë_eb_off£t_ö_∑ge
(
eb
, 
off£t
);

966 
tmp
 = (
båfs_disk_key
 *)(
kaddr
 + 
où
);

968 
	`ªad_exã¡_buf„r
(
eb
, &
u«lig√d
, 
off£t
, 
key_size
);

969 
tmp
 = &
u«lig√d
;

972 
ªt
 = 
	`comp_keys
(
tmp
, 
key
);

974 i‡(
ªt
 < 0)

975 
low
 = 
mid
 + 1;

976 i‡(
ªt
 > 0)

977 
high
 = 
mid
;

979 *
¶Ÿ
 = 
mid
;

983 *
¶Ÿ
 = 
low
;

985 
	}
}

987 
	$roŸ_add_u£d
(
båfs_roŸ
 *
roŸ
, 
u32
 
size
)

989 
	`•ö_lock
(&
roŸ
->
accou¡ög_lock
);

990 
	`båfs_£t_roŸ_u£d
(&
roŸ
->
roŸ_ôem
,

991 
	`båfs_roŸ_u£d
(&
roŸ
->
roŸ_ôem
Ë+ 
size
);

992 
	`•ö_u∆ock
(&
roŸ
->
accou¡ög_lock
);

993 
	}
}

995 
	$roŸ_sub_u£d
(
båfs_roŸ
 *
roŸ
, 
u32
 
size
)

997 
	`•ö_lock
(&
roŸ
->
accou¡ög_lock
);

998 
	`båfs_£t_roŸ_u£d
(&
roŸ
->
roŸ_ôem
,

999 
	`båfs_roŸ_u£d
(&
roŸ
->
roŸ_ôem
Ë- 
size
);

1000 
	`•ö_u∆ock
(&
roŸ
->
accou¡ög_lock
);

1001 
	}
}

1006 
exã¡_buf„r
 *
	$båfs_ªad_node_¶Ÿ
(
exã¡_buf„r
 *
∑ª¡
,

1007 
¶Ÿ
)

1009 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
∑ª¡
);

1010 
båfs_åì_∑ª¡_check
 
check
 = { 0 };

1011 
exã¡_buf„r
 *
eb
;

1013 i‡(
¶Ÿ
 < 0 || slŸ >
	`båfs_hódî_ƒôems
(
∑ª¡
))

1014  
	`ERR_PTR
(-
ENOENT
);

1016 
	`ASSERT
(
Àvñ
);

1018 
check
.
Àvñ
 =Üevel - 1;

1019 
check
.
å™sid
 = 
	`båfs_node_±r_gíî©i⁄
(
∑ª¡
, 
¶Ÿ
);

1020 
check
.
ow√r_roŸ
 = 
	`båfs_hódî_ow√r
(
∑ª¡
);

1021 
check
.
has_fú°_key
 = 
åue
;

1022 
	`båfs_node_key_to_˝u
(
∑ª¡
, &
check
.
fú°_key
, 
¶Ÿ
);

1024 
eb
 = 
	`ªad_åì_block
(
∑ª¡
->
fs_öfo
, 
	`båfs_node_block±r
’¨ít, 
¶Ÿ
),

1025 &
check
);

1026 i‡(
	`IS_ERR
(
eb
))

1027  
eb
;

1028 i‡(!
	`exã¡_buf„r_u±od©e
(
eb
)) {

1029 
	`‰ì_exã¡_buf„r
(
eb
);

1030  
	`ERR_PTR
(-
EIO
);

1033  
eb
;

1034 
	}
}

1041 
noölöe
 
	$bÆ™˚_Àvñ
(
båfs_å™s_h™dÀ
 *
å™s
,

1042 
båfs_roŸ
 *
roŸ
,

1043 
båfs_∑th
 *
∑th
, 
Àvñ
)

1045 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1046 
exã¡_buf„r
 *
right
 = 
NULL
;

1047 
exã¡_buf„r
 *
mid
;

1048 
exã¡_buf„r
 *
À·
 = 
NULL
;

1049 
exã¡_buf„r
 *
∑ª¡
 = 
NULL
;

1050 
ªt
 = 0;

1051 
wªt
;

1052 
p¶Ÿ
;

1053 
‹ig_¶Ÿ
 = 
∑th
->
¶Ÿs
[
Àvñ
];

1054 
u64
 
‹ig_±r
;

1056 
	`ASSERT
(
Àvñ
 > 0);

1058 
mid
 = 
∑th
->
nodes
[
Àvñ
];

1060 
	`WARN_ON
(
∑th
->
locks
[
Àvñ
] !
BTRFS_WRITE_LOCK
);

1061 
	`WARN_ON
(
	`båfs_hódî_gíî©i⁄
(
mid
Ë!
å™s
->
å™sid
);

1063 
‹ig_±r
 = 
	`båfs_node_block±r
(
mid
, 
‹ig_¶Ÿ
);

1065 i‡(
Àvñ
 < 
BTRFS_MAX_LEVEL
 - 1) {

1066 
∑ª¡
 = 
∑th
->
nodes
[
Àvñ
 + 1];

1067 
p¶Ÿ
 = 
∑th
->
¶Ÿs
[
Àvñ
 + 1];

1074 i‡(!
∑ª¡
) {

1075 
exã¡_buf„r
 *
chûd
;

1077 i‡(
	`båfs_hódî_ƒôems
(
mid
) != 1)

1081 
chûd
 = 
	`båfs_ªad_node_¶Ÿ
(
mid
, 0);

1082 i‡(
	`IS_ERR
(
chûd
)) {

1083 
ªt
 = 
	`PTR_ERR
(
chûd
);

1084 
out
;

1087 
	`båfs_åì_lock
(
chûd
);

1088 
ªt
 = 
	`båfs_cow_block
(
å™s
, 
roŸ
, 
chûd
, 
mid
, 0, &child,

1089 
BTRFS_NESTING_COW
);

1090 i‡(
ªt
) {

1091 
	`båfs_åì_u∆ock
(
chûd
);

1092 
	`‰ì_exã¡_buf„r
(
chûd
);

1093 
out
;

1096 
ªt
 = 
	`båfs_åì_mod_log_ö£π_roŸ
(
roŸ
->
node
, 
chûd
, 
åue
);

1097 i‡(
ªt
 < 0) {

1098 
	`båfs_åì_u∆ock
(
chûd
);

1099 
	`‰ì_exã¡_buf„r
(
chûd
);

1100 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1101 
out
;

1103 
	`rcu_assign_poöãr
(
roŸ
->
node
, 
chûd
);

1105 
	`add_roŸ_to_dúty_li°
(
roŸ
);

1106 
	`båfs_åì_u∆ock
(
chûd
);

1108 
∑th
->
locks
[
Àvñ
] = 0;

1109 
∑th
->
nodes
[
Àvñ
] = 
NULL
;

1110 
	`båfs_˛ór_buf„r_dúty
(
å™s
, 
mid
);

1111 
	`båfs_åì_u∆ock
(
mid
);

1113 
	`‰ì_exã¡_buf„r
(
mid
);

1115 
	`roŸ_sub_u£d
(
roŸ
, 
mid
->
Àn
);

1116 
	`båfs_‰ì_åì_block
(
å™s
, 
	`båfs_roŸ_id
(
roŸ
), 
mid
, 0, 1);

1118 
	`‰ì_exã¡_buf„r_°Æe
(
mid
);

1121 i‡(
	`båfs_hódî_ƒôems
(
mid
) >

1122 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_öfo
) / 4)

1125 i‡(
p¶Ÿ
) {

1126 
À·
 = 
	`båfs_ªad_node_¶Ÿ
(
∑ª¡
, 
p¶Ÿ
 - 1);

1127 i‡(
	`IS_ERR
(
À·
)) {

1128 
ªt
 = 
	`PTR_ERR
(
À·
);

1129 
À·
 = 
NULL
;

1130 
out
;

1133 
	`__båfs_åì_lock
(
À·
, 
BTRFS_NESTING_LEFT
);

1134 
wªt
 = 
	`båfs_cow_block
(
å™s
, 
roŸ
, 
À·
,

1135 
∑ª¡
, 
p¶Ÿ
 - 1, &
À·
,

1136 
BTRFS_NESTING_LEFT_COW
);

1137 i‡(
wªt
) {

1138 
ªt
 = 
wªt
;

1139 
out
;

1143 i‡(
p¶Ÿ
 + 1 < 
	`båfs_hódî_ƒôems
(
∑ª¡
)) {

1144 
right
 = 
	`båfs_ªad_node_¶Ÿ
(
∑ª¡
, 
p¶Ÿ
 + 1);

1145 i‡(
	`IS_ERR
(
right
)) {

1146 
ªt
 = 
	`PTR_ERR
(
right
);

1147 
right
 = 
NULL
;

1148 
out
;

1151 
	`__båfs_åì_lock
(
right
, 
BTRFS_NESTING_RIGHT
);

1152 
wªt
 = 
	`båfs_cow_block
(
å™s
, 
roŸ
, 
right
,

1153 
∑ª¡
, 
p¶Ÿ
 + 1, &
right
,

1154 
BTRFS_NESTING_RIGHT_COW
);

1155 i‡(
wªt
) {

1156 
ªt
 = 
wªt
;

1157 
out
;

1162 i‡(
À·
) {

1163 
‹ig_¶Ÿ
 +
	`båfs_hódî_ƒôems
(
À·
);

1164 
wªt
 = 
	`push_node_À·
(
å™s
, 
À·
, 
mid
, 1);

1165 i‡(
wªt
 < 0)

1166 
ªt
 = 
wªt
;

1172 i‡(
right
) {

1173 
wªt
 = 
	`push_node_À·
(
å™s
, 
mid
, 
right
, 1);

1174 i‡(
wªt
 < 0 && wªà!-
ENOSPC
)

1175 
ªt
 = 
wªt
;

1176 i‡(
	`båfs_hódî_ƒôems
(
right
) == 0) {

1177 
	`båfs_˛ór_buf„r_dúty
(
å™s
, 
right
);

1178 
	`båfs_åì_u∆ock
(
right
);

1179 
ªt
 = 
	`båfs_dñ_±r
(
å™s
, 
roŸ
, 
∑th
, 
Àvñ
 + 1, 
p¶Ÿ
 + 1);

1180 i‡(
ªt
 < 0) {

1181 
	`‰ì_exã¡_buf„r_°Æe
(
right
);

1182 
right
 = 
NULL
;

1183 
out
;

1185 
	`roŸ_sub_u£d
(
roŸ
, 
right
->
Àn
);

1186 
	`båfs_‰ì_åì_block
(
å™s
, 
	`båfs_roŸ_id
(
roŸ
), 
right
,

1188 
	`‰ì_exã¡_buf„r_°Æe
(
right
);

1189 
right
 = 
NULL
;

1191 
båfs_disk_key
 
right_key
;

1192 
	`båfs_node_key
(
right
, &
right_key
, 0);

1193 
ªt
 = 
	`båfs_åì_mod_log_ö£π_key
(
∑ª¡
, 
p¶Ÿ
 + 1,

1194 
BTRFS_MOD_LOG_KEY_REPLACE
);

1195 i‡(
ªt
 < 0) {

1196 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1197 
out
;

1199 
	`båfs_£t_node_key
(
∑ª¡
, &
right_key
, 
p¶Ÿ
 + 1);

1200 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑ª¡
);

1203 i‡(
	`båfs_hódî_ƒôems
(
mid
) == 1) {

1213 i‡(
	`u∆ikñy
(!
À·
)) {

1214 
	`båfs_¸ô
(
fs_öfo
,

1216 
∑ª¡
->
°¨t
, 
	`båfs_hódî_Àvñ
(parent),

1217 
mid
->
°¨t
, 
	`båfs_roŸ_id
(
roŸ
));

1218 
ªt
 = -
EUCLEAN
;

1219 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1220 
out
;

1222 
wªt
 = 
	`bÆ™˚_node_right
(
å™s
, 
mid
, 
À·
);

1223 i‡(
wªt
 < 0) {

1224 
ªt
 = 
wªt
;

1225 
out
;

1227 i‡(
wªt
 == 1) {

1228 
wªt
 = 
	`push_node_À·
(
å™s
, 
À·
, 
mid
, 1);

1229 i‡(
wªt
 < 0)

1230 
ªt
 = 
wªt
;

1232 
	`BUG_ON
(
wªt
 == 1);

1234 i‡(
	`båfs_hódî_ƒôems
(
mid
) == 0) {

1235 
	`båfs_˛ór_buf„r_dúty
(
å™s
, 
mid
);

1236 
	`båfs_åì_u∆ock
(
mid
);

1237 
ªt
 = 
	`båfs_dñ_±r
(
å™s
, 
roŸ
, 
∑th
, 
Àvñ
 + 1, 
p¶Ÿ
);

1238 i‡(
ªt
 < 0) {

1239 
	`‰ì_exã¡_buf„r_°Æe
(
mid
);

1240 
mid
 = 
NULL
;

1241 
out
;

1243 
	`roŸ_sub_u£d
(
roŸ
, 
mid
->
Àn
);

1244 
	`båfs_‰ì_åì_block
(
å™s
, 
	`båfs_roŸ_id
(
roŸ
), 
mid
, 0, 1);

1245 
	`‰ì_exã¡_buf„r_°Æe
(
mid
);

1246 
mid
 = 
NULL
;

1249 
båfs_disk_key
 
mid_key
;

1250 
	`båfs_node_key
(
mid
, &
mid_key
, 0);

1251 
ªt
 = 
	`båfs_åì_mod_log_ö£π_key
(
∑ª¡
, 
p¶Ÿ
,

1252 
BTRFS_MOD_LOG_KEY_REPLACE
);

1253 i‡(
ªt
 < 0) {

1254 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1255 
out
;

1257 
	`båfs_£t_node_key
(
∑ª¡
, &
mid_key
, 
p¶Ÿ
);

1258 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑ª¡
);

1262 i‡(
À·
) {

1263 i‡(
	`båfs_hódî_ƒôems
(
À·
Ë> 
‹ig_¶Ÿ
) {

1264 
	`©omic_öc
(&
À·
->
ªfs
);

1266 
∑th
->
nodes
[
Àvñ
] = 
À·
;

1267 
∑th
->
¶Ÿs
[
Àvñ
 + 1] -= 1;

1268 
∑th
->
¶Ÿs
[
Àvñ
] = 
‹ig_¶Ÿ
;

1269 i‡(
mid
) {

1270 
	`båfs_åì_u∆ock
(
mid
);

1271 
	`‰ì_exã¡_buf„r
(
mid
);

1274 
‹ig_¶Ÿ
 -
	`båfs_hódî_ƒôems
(
À·
);

1275 
∑th
->
¶Ÿs
[
Àvñ
] = 
‹ig_¶Ÿ
;

1279 i‡(
‹ig_±r
 !=

1280 
	`båfs_node_block±r
(
∑th
->
nodes
[
Àvñ
],Ö©h->
¶Ÿs
[level]))

1281 
	`BUG
();

1282 
out
:

1283 i‡(
right
) {

1284 
	`båfs_åì_u∆ock
(
right
);

1285 
	`‰ì_exã¡_buf„r
(
right
);

1287 i‡(
À·
) {

1288 i‡(
∑th
->
nodes
[
Àvñ
] !
À·
)

1289 
	`båfs_åì_u∆ock
(
À·
);

1290 
	`‰ì_exã¡_buf„r
(
À·
);

1292  
ªt
;

1293 
	}
}

1299 
noölöe
 
	$push_nodes_f‹_ö£π
(
båfs_å™s_h™dÀ
 *
å™s
,

1300 
båfs_roŸ
 *
roŸ
,

1301 
båfs_∑th
 *
∑th
, 
Àvñ
)

1303 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1304 
exã¡_buf„r
 *
right
 = 
NULL
;

1305 
exã¡_buf„r
 *
mid
;

1306 
exã¡_buf„r
 *
À·
 = 
NULL
;

1307 
exã¡_buf„r
 *
∑ª¡
 = 
NULL
;

1308 
ªt
 = 0;

1309 
wªt
;

1310 
p¶Ÿ
;

1311 
‹ig_¶Ÿ
 = 
∑th
->
¶Ÿs
[
Àvñ
];

1313 i‡(
Àvñ
 == 0)

1316 
mid
 = 
∑th
->
nodes
[
Àvñ
];

1317 
	`WARN_ON
(
	`båfs_hódî_gíî©i⁄
(
mid
Ë!
å™s
->
å™sid
);

1319 i‡(
Àvñ
 < 
BTRFS_MAX_LEVEL
 - 1) {

1320 
∑ª¡
 = 
∑th
->
nodes
[
Àvñ
 + 1];

1321 
p¶Ÿ
 = 
∑th
->
¶Ÿs
[
Àvñ
 + 1];

1324 i‡(!
∑ª¡
)

1328 i‡(
p¶Ÿ
) {

1329 
u32
 
À·_ƒ
;

1331 
À·
 = 
	`båfs_ªad_node_¶Ÿ
(
∑ª¡
, 
p¶Ÿ
 - 1);

1332 i‡(
	`IS_ERR
(
À·
))

1333  
	`PTR_ERR
(
À·
);

1335 
	`__båfs_åì_lock
(
À·
, 
BTRFS_NESTING_LEFT
);

1337 
À·_ƒ
 = 
	`båfs_hódî_ƒôems
(
À·
);

1338 i‡(
À·_ƒ
 >
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_öfo
) - 1) {

1339 
wªt
 = 1;

1341 
ªt
 = 
	`båfs_cow_block
(
å™s
, 
roŸ
, 
À·
, 
∑ª¡
,

1342 
p¶Ÿ
 - 1, &
À·
,

1343 
BTRFS_NESTING_LEFT_COW
);

1344 i‡(
ªt
)

1345 
wªt
 = 1;

1347 
wªt
 = 
	`push_node_À·
(
å™s
, 
À·
, 
mid
, 0);

1350 i‡(
wªt
 < 0)

1351 
ªt
 = 
wªt
;

1352 i‡(
wªt
 == 0) {

1353 
båfs_disk_key
 
disk_key
;

1354 
‹ig_¶Ÿ
 +
À·_ƒ
;

1355 
	`båfs_node_key
(
mid
, &
disk_key
, 0);

1356 
ªt
 = 
	`båfs_åì_mod_log_ö£π_key
(
∑ª¡
, 
p¶Ÿ
,

1357 
BTRFS_MOD_LOG_KEY_REPLACE
);

1358 i‡(
ªt
 < 0) {

1359 
	`båfs_åì_u∆ock
(
À·
);

1360 
	`‰ì_exã¡_buf„r
(
À·
);

1361 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1362  
ªt
;

1364 
	`båfs_£t_node_key
(
∑ª¡
, &
disk_key
, 
p¶Ÿ
);

1365 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑ª¡
);

1366 i‡(
	`båfs_hódî_ƒôems
(
À·
Ë> 
‹ig_¶Ÿ
) {

1367 
∑th
->
nodes
[
Àvñ
] = 
À·
;

1368 
∑th
->
¶Ÿs
[
Àvñ
 + 1] -= 1;

1369 
∑th
->
¶Ÿs
[
Àvñ
] = 
‹ig_¶Ÿ
;

1370 
	`båfs_åì_u∆ock
(
mid
);

1371 
	`‰ì_exã¡_buf„r
(
mid
);

1373 
‹ig_¶Ÿ
 -=

1374 
	`båfs_hódî_ƒôems
(
À·
);

1375 
∑th
->
¶Ÿs
[
Àvñ
] = 
‹ig_¶Ÿ
;

1376 
	`båfs_åì_u∆ock
(
À·
);

1377 
	`‰ì_exã¡_buf„r
(
À·
);

1381 
	`båfs_åì_u∆ock
(
À·
);

1382 
	`‰ì_exã¡_buf„r
(
À·
);

1388 i‡(
p¶Ÿ
 + 1 < 
	`båfs_hódî_ƒôems
(
∑ª¡
)) {

1389 
u32
 
right_ƒ
;

1391 
right
 = 
	`båfs_ªad_node_¶Ÿ
(
∑ª¡
, 
p¶Ÿ
 + 1);

1392 i‡(
	`IS_ERR
(
right
))

1393  
	`PTR_ERR
(
right
);

1395 
	`__båfs_åì_lock
(
right
, 
BTRFS_NESTING_RIGHT
);

1397 
right_ƒ
 = 
	`båfs_hódî_ƒôems
(
right
);

1398 i‡(
right_ƒ
 >
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_öfo
) - 1) {

1399 
wªt
 = 1;

1401 
ªt
 = 
	`båfs_cow_block
(
å™s
, 
roŸ
, 
right
,

1402 
∑ª¡
, 
p¶Ÿ
 + 1,

1403 &
right
, 
BTRFS_NESTING_RIGHT_COW
);

1404 i‡(
ªt
)

1405 
wªt
 = 1;

1407 
wªt
 = 
	`bÆ™˚_node_right
(
å™s
, 
right
, 
mid
);

1410 i‡(
wªt
 < 0)

1411 
ªt
 = 
wªt
;

1412 i‡(
wªt
 == 0) {

1413 
båfs_disk_key
 
disk_key
;

1415 
	`båfs_node_key
(
right
, &
disk_key
, 0);

1416 
ªt
 = 
	`båfs_åì_mod_log_ö£π_key
(
∑ª¡
, 
p¶Ÿ
 + 1,

1417 
BTRFS_MOD_LOG_KEY_REPLACE
);

1418 i‡(
ªt
 < 0) {

1419 
	`båfs_åì_u∆ock
(
right
);

1420 
	`‰ì_exã¡_buf„r
(
right
);

1421 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1422  
ªt
;

1424 
	`båfs_£t_node_key
(
∑ª¡
, &
disk_key
, 
p¶Ÿ
 + 1);

1425 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑ª¡
);

1427 i‡(
	`båfs_hódî_ƒôems
(
mid
Ë<
‹ig_¶Ÿ
) {

1428 
∑th
->
nodes
[
Àvñ
] = 
right
;

1429 
∑th
->
¶Ÿs
[
Àvñ
 + 1] += 1;

1430 
∑th
->
¶Ÿs
[
Àvñ
] = 
‹ig_¶Ÿ
 -

1431 
	`båfs_hódî_ƒôems
(
mid
);

1432 
	`båfs_åì_u∆ock
(
mid
);

1433 
	`‰ì_exã¡_buf„r
(
mid
);

1435 
	`båfs_åì_u∆ock
(
right
);

1436 
	`‰ì_exã¡_buf„r
(
right
);

1440 
	`båfs_åì_u∆ock
(
right
);

1441 
	`‰ì_exã¡_buf„r
(
right
);

1444 
	}
}

1450 
	$ªada_f‹_£¨ch
(
båfs_fs_öfo
 *
fs_öfo
,

1451 
båfs_∑th
 *
∑th
,

1452 
Àvñ
, 
¶Ÿ
, 
u64
 
obje˘id
)

1454 
exã¡_buf„r
 *
node
;

1455 
båfs_disk_key
 
disk_key
;

1456 
u32
 
ƒôems
;

1457 
u64
 
£¨ch
;

1458 
u64
 
èrgë
;

1459 
u64
 
ƒód
 = 0;

1460 
u64
 
ƒód_max
;

1461 
u32
 
ƒ
;

1462 
u32
 
blocksize
;

1463 
u32
 
nsˇn
 = 0;

1465 i‡(
Àvñ
 !1 && 
∑th
->
ªada
 !
READA_FORWARD_ALWAYS
)

1468 i‡(!
∑th
->
nodes
[
Àvñ
])

1471 
node
 = 
∑th
->
nodes
[
Àvñ
];

1478 i‡(
∑th
->
ªada
 =
READA_FORWARD_ALWAYS
) {

1479 i‡(
Àvñ
 > 1)

1480 
ƒód_max
 = 
node
->
fs_öfo
->
nodesize
;

1482 
ƒód_max
 = 
SZ_128K
;

1484 
ƒód_max
 = 
SZ_64K
;

1487 
£¨ch
 = 
	`båfs_node_block±r
(
node
, 
¶Ÿ
);

1488 
blocksize
 = 
fs_öfo
->
nodesize
;

1489 i‡(
∑th
->
ªada
 !
READA_FORWARD_ALWAYS
) {

1490 
exã¡_buf„r
 *
eb
;

1492 
eb
 = 
	`föd_exã¡_buf„r
(
fs_öfo
, 
£¨ch
);

1493 i‡(
eb
) {

1494 
	`‰ì_exã¡_buf„r
(
eb
);

1499 
èrgë
 = 
£¨ch
;

1501 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
node
);

1502 
ƒ
 = 
¶Ÿ
;

1505 i‡(
∑th
->
ªada
 =
READA_BACK
) {

1506 i‡(
ƒ
 == 0)

1508 
ƒ
--;

1509 } i‡(
∑th
->
ªada
 =
READA_FORWARD
 ||

1510 
∑th
->
ªada
 =
READA_FORWARD_ALWAYS
) {

1511 
ƒ
++;

1512 i‡(
ƒ
 >
ƒôems
)

1515 i‡(
∑th
->
ªada
 =
READA_BACK
 && 
obje˘id
) {

1516 
	`båfs_node_key
(
node
, &
disk_key
, 
ƒ
);

1517 i‡(
	`båfs_disk_key_obje˘id
(&
disk_key
Ë!
obje˘id
)

1520 
£¨ch
 = 
	`båfs_node_block±r
(
node
, 
ƒ
);

1521 i‡(
∑th
->
ªada
 =
READA_FORWARD_ALWAYS
 ||

1522 (
£¨ch
 <
èrgë
 &&Åarget - search <= 65536) ||

1523 (
£¨ch
 > 
èrgë
 && search -Åarget <= 65536)) {

1524 
	`båfs_ªadahód_node_chûd
(
node
, 
ƒ
);

1525 
ƒód
 +
blocksize
;

1527 
nsˇn
++;

1528 i‡(
ƒód
 > 
ƒód_max
 || 
nsˇn
 > 32)

1531 
	}
}

1533 
noölöe
 
	$ªada_f‹_bÆ™˚
(
båfs_∑th
 *
∑th
, 
Àvñ
)

1535 
exã¡_buf„r
 *
∑ª¡
;

1536 
¶Ÿ
;

1537 
ƒôems
;

1539 
∑ª¡
 = 
∑th
->
nodes
[
Àvñ
 + 1];

1540 i‡(!
∑ª¡
)

1543 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑ª¡
);

1544 
¶Ÿ
 = 
∑th
->
¶Ÿs
[
Àvñ
 + 1];

1546 i‡(
¶Ÿ
 > 0)

1547 
	`båfs_ªadahód_node_chûd
(
∑ª¡
, 
¶Ÿ
 - 1);

1548 i‡(
¶Ÿ
 + 1 < 
ƒôems
)

1549 
	`båfs_ªadahód_node_chûd
(
∑ª¡
, 
¶Ÿ
 + 1);

1550 
	}
}

1566 
noölöe
 
	$u∆ock_up
(
båfs_∑th
 *
∑th
, 
Àvñ
,

1567 
lowe°_u∆ock
, 
mö_wrôe_lock_Àvñ
,

1568 *
wrôe_lock_Àvñ
)

1570 
i
;

1571 
skù_Àvñ
 = 
Àvñ
;

1572 
boﬁ
 
check_skù
 = 
åue
;

1574 
i
 = 
Àvñ
; i < 
BTRFS_MAX_LEVEL
; i++) {

1575 i‡(!
∑th
->
nodes
[
i
])

1577 i‡(!
∑th
->
locks
[
i
])

1580 i‡(
check_skù
) {

1581 i‡(
∑th
->
¶Ÿs
[
i
] == 0) {

1582 
skù_Àvñ
 = 
i
 + 1;

1586 i‡(
∑th
->
kìp_locks
) {

1587 
u32
 
ƒôems
;

1589 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[
i
]);

1590 i‡(
ƒôems
 < 1 || 
∑th
->
¶Ÿs
[
i
] >=Çritems - 1) {

1591 
skù_Àvñ
 = 
i
 + 1;

1597 i‡(
i
 >
lowe°_u∆ock
 && i > 
skù_Àvñ
) {

1598 
check_skù
 = 
Ál£
;

1599 
	`båfs_åì_u∆ock_rw
(
∑th
->
nodes
[
i
],Ö©h->
locks
[i]);

1600 
∑th
->
locks
[
i
] = 0;

1601 i‡(
wrôe_lock_Àvñ
 &&

1602 
i
 > 
mö_wrôe_lock_Àvñ
 &&

1603 
i
 <*
wrôe_lock_Àvñ
) {

1604 *
wrôe_lock_Àvñ
 = 
i
 - 1;

1608 
	}
}

1620 
	$ªad_block_f‹_£¨ch
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
p
,

1621 
exã¡_buf„r
 **
eb_ªt
, 
Àvñ
, 
¶Ÿ
,

1622 c⁄° 
båfs_key
 *
key
)

1624 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1625 
båfs_åì_∑ª¡_check
 
check
 = { 0 };

1626 
u64
 
blockƒ
;

1627 
u64
 
gí
;

1628 
exã¡_buf„r
 *
tmp
;

1629 
ªt
;

1630 
∑ª¡_Àvñ
;

1631 
boﬁ
 
u∆ock_up
;

1633 
u∆ock_up
 = ((
Àvñ
 + 1 < 
BTRFS_MAX_LEVEL
Ë&& 
p
->
locks
[level + 1]);

1634 
blockƒ
 = 
	`båfs_node_block±r
(*
eb_ªt
, 
¶Ÿ
);

1635 
gí
 = 
	`båfs_node_±r_gíî©i⁄
(*
eb_ªt
, 
¶Ÿ
);

1636 
∑ª¡_Àvñ
 = 
	`båfs_hódî_Àvñ
(*
eb_ªt
);

1637 
	`båfs_node_key_to_˝u
(*
eb_ªt
, &
check
.
fú°_key
, 
¶Ÿ
);

1638 
check
.
has_fú°_key
 = 
åue
;

1639 
check
.
Àvñ
 = 
∑ª¡_Àvñ
 - 1;

1640 
check
.
å™sid
 = 
gí
;

1641 
check
.
ow√r_roŸ
 = 
roŸ
->
roŸ_key
.
obje˘id
;

1650 
tmp
 = 
	`föd_exã¡_buf„r
(
fs_öfo
, 
blockƒ
);

1651 i‡(
tmp
) {

1652 i‡(
p
->
ªada
 =
READA_FORWARD_ALWAYS
)

1653 
	`ªada_f‹_£¨ch
(
fs_öfo
, 
p
, 
Àvñ
, 
¶Ÿ
, 
key
->
obje˘id
);

1656 i‡(
	`båfs_buf„r_u±od©e
(
tmp
, 
gí
, 1) > 0) {

1662 i‡(
	`båfs_vîify_Àvñ_key
(
tmp
,

1663 
∑ª¡_Àvñ
 - 1, &
check
.
fú°_key
, 
gí
)) {

1664 
	`‰ì_exã¡_buf„r
(
tmp
);

1665  -
EUCLEAN
;

1667 *
eb_ªt
 = 
tmp
;

1671 i‡(
p
->
nowaô
) {

1672 
	`‰ì_exã¡_buf„r
(
tmp
);

1673  -
EAGAIN
;

1676 i‡(
u∆ock_up
)

1677 
	`båfs_u∆ock_up_ß„
(
p
, 
Àvñ
 + 1);

1680 
ªt
 = 
	`båfs_ªad_exã¡_buf„r
(
tmp
, &
check
);

1681 i‡(
ªt
) {

1682 
	`‰ì_exã¡_buf„r
(
tmp
);

1683 
	`båfs_ªÀa£_∑th
(
p
);

1684  -
EIO
;

1686 i‡(
	`båfs_check_eb_ow√r
(
tmp
, 
roŸ
->
roŸ_key
.
obje˘id
)) {

1687 
	`‰ì_exã¡_buf„r
(
tmp
);

1688 
	`båfs_ªÀa£_∑th
(
p
);

1689  -
EUCLEAN
;

1692 i‡(
u∆ock_up
)

1693 
ªt
 = -
EAGAIN
;

1695 
out
;

1696 } i‡(
p
->
nowaô
) {

1697  -
EAGAIN
;

1700 i‡(
u∆ock_up
) {

1701 
	`båfs_u∆ock_up_ß„
(
p
, 
Àvñ
 + 1);

1702 
ªt
 = -
EAGAIN
;

1704 
ªt
 = 0;

1707 i‡(
p
->
ªada
 !
READA_NONE
)

1708 
	`ªada_f‹_£¨ch
(
fs_öfo
, 
p
, 
Àvñ
, 
¶Ÿ
, 
key
->
obje˘id
);

1710 
tmp
 = 
	`ªad_åì_block
(
fs_öfo
, 
blockƒ
, &
check
);

1711 i‡(
	`IS_ERR
(
tmp
)) {

1712 
	`båfs_ªÀa£_∑th
(
p
);

1713  
	`PTR_ERR
(
tmp
);

1721 i‡(!
	`exã¡_buf„r_u±od©e
(
tmp
))

1722 
ªt
 = -
EIO
;

1724 
out
:

1725 i‡(
ªt
 == 0) {

1726 *
eb_ªt
 = 
tmp
;

1728 
	`‰ì_exã¡_buf„r
(
tmp
);

1729 
	`båfs_ªÀa£_∑th
(
p
);

1732  
ªt
;

1733 
	}
}

1745 
	$£tup_nodes_f‹_£¨ch
(
båfs_å™s_h™dÀ
 *
å™s
,

1746 
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
p
,

1747 
exã¡_buf„r
 *
b
, 
Àvñ
, 
ös_Àn
,

1748 *
wrôe_lock_Àvñ
)

1750 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1751 
ªt
 = 0;

1753 i‡((
p
->
£¨ch_f‹_•lô
 || 
ös_Àn
 > 0Ë&& 
	`båfs_hódî_ƒôems
(
b
) >=

1754 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_öfo
) - 3) {

1756 i‡(*
wrôe_lock_Àvñ
 < 
Àvñ
 + 1) {

1757 *
wrôe_lock_Àvñ
 = 
Àvñ
 + 1;

1758 
	`båfs_ªÀa£_∑th
(
p
);

1759  -
EAGAIN
;

1762 
	`ªada_f‹_bÆ™˚
(
p
, 
Àvñ
);

1763 
ªt
 = 
	`•lô_node
(
å™s
, 
roŸ
, 
p
, 
Àvñ
);

1765 
b
 = 
p
->
nodes
[
Àvñ
];

1766 } i‡(
ös_Àn
 < 0 && 
	`båfs_hódî_ƒôems
(
b
) <

1767 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_öfo
) / 2) {

1769 i‡(*
wrôe_lock_Àvñ
 < 
Àvñ
 + 1) {

1770 *
wrôe_lock_Àvñ
 = 
Àvñ
 + 1;

1771 
	`båfs_ªÀa£_∑th
(
p
);

1772  -
EAGAIN
;

1775 
	`ªada_f‹_bÆ™˚
(
p
, 
Àvñ
);

1776 
ªt
 = 
	`bÆ™˚_Àvñ
(
å™s
, 
roŸ
, 
p
, 
Àvñ
);

1777 i‡(
ªt
)

1778  
ªt
;

1780 
b
 = 
p
->
nodes
[
Àvñ
];

1781 i‡(!
b
) {

1782 
	`båfs_ªÀa£_∑th
(
p
);

1783  -
EAGAIN
;

1785 
	`BUG_ON
(
	`båfs_hódî_ƒôems
(
b
) == 1);

1787  
ªt
;

1788 
	}
}

1790 
	$båfs_föd_ôem
(
båfs_roŸ
 *
fs_roŸ
, 
båfs_∑th
 *
∑th
,

1791 
u64
 
iobje˘id
, u64 
ioff
, 
u8
 
key_ty≥
,

1792 
båfs_key
 *
found_key
)

1794 
ªt
;

1795 
båfs_key
 
key
;

1796 
exã¡_buf„r
 *
eb
;

1798 
	`ASSERT
(
∑th
);

1799 
	`ASSERT
(
found_key
);

1801 
key
.
ty≥
 = 
key_ty≥
;

1802 
key
.
obje˘id
 = 
iobje˘id
;

1803 
key
.
off£t
 = 
ioff
;

1805 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
fs_roŸ
, &
key
, 
∑th
, 0, 0);

1806 i‡(
ªt
 < 0)

1807  
ªt
;

1809 
eb
 = 
∑th
->
nodes
[0];

1810 i‡(
ªt
 && 
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
(
eb
)) {

1811 
ªt
 = 
	`båfs_√xt_Àaf
(
fs_roŸ
, 
∑th
);

1812 i‡(
ªt
)

1813  
ªt
;

1814 
eb
 = 
∑th
->
nodes
[0];

1817 
	`båfs_ôem_key_to_˝u
(
eb
, 
found_key
, 
∑th
->
¶Ÿs
[0]);

1818 i‡(
found_key
->
ty≥
 !
key
.type ||

1819 
found_key
->
obje˘id
 !
key
.objectid)

1823 
	}
}

1825 
exã¡_buf„r
 *
	$båfs_£¨ch_¶Ÿ_gë_roŸ
(
båfs_roŸ
 *
roŸ
,

1826 
båfs_∑th
 *
p
,

1827 
wrôe_lock_Àvñ
)

1829 
exã¡_buf„r
 *
b
;

1830 
roŸ_lock
 = 0;

1831 
Àvñ
 = 0;

1833 i‡(
p
->
£¨ch_commô_roŸ
) {

1834 
b
 = 
roŸ
->
commô_roŸ
;

1835 
	`©omic_öc
(&
b
->
ªfs
);

1836 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
b
);

1841 
	`ASSERT
(
p
->
skù_lockög
 == 1);

1843 
out
;

1846 i‡(
p
->
skù_lockög
) {

1847 
b
 = 
	`båfs_roŸ_node
(
roŸ
);

1848 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
b
);

1849 
out
;

1853 
roŸ_lock
 = 
BTRFS_READ_LOCK
;

1859 i‡(
wrôe_lock_Àvñ
 < 
BTRFS_MAX_LEVEL
) {

1864 i‡(
p
->
nowaô
) {

1865 
b
 = 
	`båfs_åy_ªad_lock_roŸ_node
(
roŸ
);

1866 i‡(
	`IS_ERR
(
b
))

1867  
b
;

1869 
b
 = 
	`båfs_ªad_lock_roŸ_node
(
roŸ
);

1871 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
b
);

1872 i‡(
Àvñ
 > 
wrôe_lock_Àvñ
)

1873 
out
;

1876 
	`båfs_åì_ªad_u∆ock
(
b
);

1877 
	`‰ì_exã¡_buf„r
(
b
);

1880 
b
 = 
	`båfs_lock_roŸ_node
(
roŸ
);

1881 
roŸ_lock
 = 
BTRFS_WRITE_LOCK
;

1884 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
b
);

1886 
out
:

1891 i‡(!
	`exã¡_buf„r_u±od©e
(
b
)) {

1892 i‡(
roŸ_lock
)

1893 
	`båfs_åì_u∆ock_rw
(
b
, 
roŸ_lock
);

1894 
	`‰ì_exã¡_buf„r
(
b
);

1895  
	`ERR_PTR
(-
EIO
);

1898 
p
->
nodes
[
Àvñ
] = 
b
;

1899 i‡(!
p
->
skù_lockög
)

1900 
p
->
locks
[
Àvñ
] = 
roŸ_lock
;

1904  
b
;

1905 
	}
}

1919 
	$föish_√ed_commô_£m_£¨ch
(
båfs_∑th
 *
∑th
)

1921 c⁄° 
i
 = 
∑th
->
lowe°_Àvñ
;

1922 c⁄° 
¶Ÿ
 = 
∑th
->
¶Ÿs
[
i
];

1923 
exã¡_buf„r
 *
lowe°
 = 
∑th
->
nodes
[
i
];

1924 
exã¡_buf„r
 *
˛⁄e
;

1926 
	`ASSERT
(
∑th
->
√ed_commô_£m
);

1928 i‡(!
lowe°
)

1931 
	`lockdï_as£π_hñd_ªad
(&
lowe°
->
fs_öfo
->
commô_roŸ_£m
);

1933 
˛⁄e
 = 
	`båfs_˛⁄e_exã¡_buf„r
(
lowe°
);

1934 i‡(!
˛⁄e
)

1935  -
ENOMEM
;

1937 
	`båfs_ªÀa£_∑th
(
∑th
);

1938 
∑th
->
nodes
[
i
] = 
˛⁄e
;

1939 
∑th
->
¶Ÿs
[
i
] = 
¶Ÿ
;

1942 
	}
}

1944 
ölöe
 
	$£¨ch_f‹_key_¶Ÿ
(
exã¡_buf„r
 *
eb
,

1945 
£¨ch_low_¶Ÿ
,

1946 c⁄° 
båfs_key
 *
key
,

1947 
¥ev_cmp
,

1948 *
¶Ÿ
)

1957 i‡(
¥ev_cmp
 == 0) {

1958 *
¶Ÿ
 = 0;

1962  
	`båfs_bö_£¨ch
(
eb
, 
£¨ch_low_¶Ÿ
, 
key
, 
¶Ÿ
);

1963 
	}
}

1965 
	$£¨ch_Àaf
(
båfs_å™s_h™dÀ
 *
å™s
,

1966 
båfs_roŸ
 *
roŸ
,

1967 c⁄° 
båfs_key
 *
key
,

1968 
båfs_∑th
 *
∑th
,

1969 
ös_Àn
,

1970 
¥ev_cmp
)

1972 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

1973 
Àaf_‰ì_•a˚
 = -1;

1974 
£¨ch_low_¶Ÿ
 = 0;

1975 
ªt
;

1976 
boﬁ
 
do_bö_£¨ch
 = 
åue
;

1985 i‡(
ös_Àn
 > 0) {

1990 
Àaf_‰ì_•a˚
 = 
	`båfs_Àaf_‰ì_•a˚
(
Àaf
);

1996 i‡(
∑th
->
locks
[1] && 
Àaf_‰ì_•a˚
 >
ös_Àn
) {

1997 
båfs_disk_key
 
fú°_key
;

1999 
	`ASSERT
(
	`båfs_hódî_ƒôems
(
Àaf
) > 0);

2000 
	`båfs_ôem_key
(
Àaf
, &
fú°_key
, 0);

2009 
ªt
 = 
	`comp_keys
(&
fú°_key
, 
key
);

2010 i‡(
ªt
 < 0) {

2023 
	`båfs_u∆ock_up_ß„
(
∑th
, 1);

2024 
£¨ch_low_¶Ÿ
 = 1;

2040 i‡(
ªt
 == 0)

2041 
	`båfs_u∆ock_up_ß„
(
∑th
, 1);

2047 
do_bö_£¨ch
 = 
Ál£
;

2048 
∑th
->
¶Ÿs
[0] = 0;

2053 i‡(
do_bö_£¨ch
) {

2054 
ªt
 = 
	`£¨ch_f‹_key_¶Ÿ
(
Àaf
, 
£¨ch_low_¶Ÿ
, 
key
,

2055 
¥ev_cmp
, &
∑th
->
¶Ÿs
[0]);

2056 i‡(
ªt
 < 0)

2057  
ªt
;

2060 i‡(
ös_Àn
 > 0) {

2070 i‡(
ªt
 =0 && !
∑th
->
£¨ch_f‹_exãnsi⁄
) {

2071 
	`ASSERT
(
ös_Àn
 >(
båfs_ôem
));

2072 
ös_Àn
 -(
båfs_ôem
);

2075 
	`ASSERT
(
Àaf_‰ì_•a˚
 >= 0);

2077 i‡(
Àaf_‰ì_•a˚
 < 
ös_Àn
) {

2078 
îr
;

2080 
îr
 = 
	`•lô_Àaf
(
å™s
, 
roŸ
, 
key
, 
∑th
, 
ös_Àn
,

2081 (
ªt
 == 0));

2082 
	`ASSERT
(
îr
 <= 0);

2083 i‡(
	`WARN_ON
(
îr
 > 0))

2084 
îr
 = -
EUCLEAN
;

2085 i‡(
îr
)

2086 
ªt
 = 
îr
;

2090  
ªt
;

2091 
	}
}

2124 
	$båfs_£¨ch_¶Ÿ
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
,

2125 c⁄° 
båfs_key
 *
key
, 
båfs_∑th
 *
p
,

2126 
ös_Àn
, 
cow
)

2128 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

2129 
exã¡_buf„r
 *
b
;

2130 
¶Ÿ
;

2131 
ªt
;

2132 
îr
;

2133 
Àvñ
;

2134 
lowe°_u∆ock
 = 1;

2136 
wrôe_lock_Àvñ
 = 0;

2137 
u8
 
lowe°_Àvñ
 = 0;

2138 
mö_wrôe_lock_Àvñ
;

2139 
¥ev_cmp
;

2141 
	`might_¶ìp
();

2143 
lowe°_Àvñ
 = 
p
->lowest_level;

2144 
	`WARN_ON
(
lowe°_Àvñ
 && 
ös_Àn
 > 0);

2145 
	`WARN_ON
(
p
->
nodes
[0] !
NULL
);

2146 
	`BUG_ON
(!
cow
 && 
ös_Àn
);

2153 
	`ASSERT
(!
p
->
nowaô
 || !
cow
);

2155 i‡(
ös_Àn
 < 0) {

2156 
lowe°_u∆ock
 = 2;

2162 
wrôe_lock_Àvñ
 = 2;

2163 } i‡(
ös_Àn
 > 0) {

2168 
wrôe_lock_Àvñ
 = 1;

2171 i‡(!
cow
)

2172 
wrôe_lock_Àvñ
 = -1;

2174 i‡(
cow
 && (
p
->
kìp_locks
 ||Ö->
lowe°_Àvñ
))

2175 
wrôe_lock_Àvñ
 = 
BTRFS_MAX_LEVEL
;

2177 
mö_wrôe_lock_Àvñ
 = 
wrôe_lock_Àvñ
;

2179 i‡(
p
->
√ed_commô_£m
) {

2180 
	`ASSERT
(
p
->
£¨ch_commô_roŸ
);

2181 i‡(
p
->
nowaô
) {

2182 i‡(!
	`down_ªad_åylock
(&
fs_öfo
->
commô_roŸ_£m
))

2183  -
EAGAIN
;

2185 
	`down_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

2189 
agaö
:

2190 
¥ev_cmp
 = -1;

2191 
b
 = 
	`båfs_£¨ch_¶Ÿ_gë_roŸ
(
roŸ
, 
p
, 
wrôe_lock_Àvñ
);

2192 i‡(
	`IS_ERR
(
b
)) {

2193 
ªt
 = 
	`PTR_ERR
(
b
);

2194 
d⁄e
;

2197 
b
) {

2198 
dec
 = 0;

2200 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
b
);

2202 i‡(
cow
) {

2203 
boﬁ
 
œ°_Àvñ
 = (
Àvñ
 =(
BTRFS_MAX_LEVEL
 - 1));

2210 i‡(!
	`should_cow_block
(
å™s
, 
roŸ
, 
b
))

2211 
cow_d⁄e
;

2217 i‡(
Àvñ
 > 
wrôe_lock_Àvñ
 ||

2218 (
Àvñ
 + 1 > 
wrôe_lock_Àvñ
 &&

2219 
Àvñ
 + 1 < 
BTRFS_MAX_LEVEL
 &&

2220 
p
->
nodes
[
Àvñ
 + 1])) {

2221 
wrôe_lock_Àvñ
 = 
Àvñ
 + 1;

2222 
	`båfs_ªÀa£_∑th
(
p
);

2223 
agaö
;

2226 i‡(
œ°_Àvñ
)

2227 
îr
 = 
	`båfs_cow_block
(
å™s
, 
roŸ
, 
b
, 
NULL
, 0,

2228 &
b
,

2229 
BTRFS_NESTING_COW
);

2231 
îr
 = 
	`båfs_cow_block
(
å™s
, 
roŸ
, 
b
,

2232 
p
->
nodes
[
Àvñ
 + 1],

2233 
p
->
¶Ÿs
[
Àvñ
 + 1], &
b
,

2234 
BTRFS_NESTING_COW
);

2235 i‡(
îr
) {

2236 
ªt
 = 
îr
;

2237 
d⁄e
;

2240 
cow_d⁄e
:

2241 
p
->
nodes
[
Àvñ
] = 
b
;

2254 i‡(!
ös_Àn
 && !
p
->
kìp_locks
) {

2255 
u
 = 
Àvñ
 + 1;

2257 i‡(
u
 < 
BTRFS_MAX_LEVEL
 && 
p
->
locks
[u]) {

2258 
	`båfs_åì_u∆ock_rw
(
p
->
nodes
[
u
],Ö->
locks
[u]);

2259 
p
->
locks
[
u
] = 0;

2263 i‡(
Àvñ
 == 0) {

2264 i‡(
ös_Àn
 > 0)

2265 
	`ASSERT
(
wrôe_lock_Àvñ
 >= 1);

2267 
ªt
 = 
	`£¨ch_Àaf
(
å™s
, 
roŸ
, 
key
, 
p
, 
ös_Àn
, 
¥ev_cmp
);

2268 i‡(!
p
->
£¨ch_f‹_•lô
)

2269 
	`u∆ock_up
(
p
, 
Àvñ
, 
lowe°_u∆ock
,

2270 
mö_wrôe_lock_Àvñ
, 
NULL
);

2271 
d⁄e
;

2274 
ªt
 = 
	`£¨ch_f‹_key_¶Ÿ
(
b
, 0, 
key
, 
¥ev_cmp
, &
¶Ÿ
);

2275 i‡(
ªt
 < 0)

2276 
d⁄e
;

2277 
¥ev_cmp
 = 
ªt
;

2279 i‡(
ªt
 && 
¶Ÿ
 > 0) {

2280 
dec
 = 1;

2281 
¶Ÿ
--;

2283 
p
->
¶Ÿs
[
Àvñ
] = 
¶Ÿ
;

2284 
îr
 = 
	`£tup_nodes_f‹_£¨ch
(
å™s
, 
roŸ
, 
p
, 
b
, 
Àvñ
, 
ös_Àn
,

2285 &
wrôe_lock_Àvñ
);

2286 i‡(
îr
 =-
EAGAIN
)

2287 
agaö
;

2288 i‡(
îr
) {

2289 
ªt
 = 
îr
;

2290 
d⁄e
;

2292 
b
 = 
p
->
nodes
[
Àvñ
];

2293 
¶Ÿ
 = 
p
->
¶Ÿs
[
Àvñ
];

2300 i‡(
¶Ÿ
 =0 && 
ös_Àn
 && 
wrôe_lock_Àvñ
 < 
Àvñ
 + 1) {

2301 
wrôe_lock_Àvñ
 = 
Àvñ
 + 1;

2302 
	`båfs_ªÀa£_∑th
(
p
);

2303 
agaö
;

2306 
	`u∆ock_up
(
p
, 
Àvñ
, 
lowe°_u∆ock
, 
mö_wrôe_lock_Àvñ
,

2307 &
wrôe_lock_Àvñ
);

2309 i‡(
Àvñ
 =
lowe°_Àvñ
) {

2310 i‡(
dec
)

2311 
p
->
¶Ÿs
[
Àvñ
]++;

2312 
d⁄e
;

2315 
îr
 = 
	`ªad_block_f‹_£¨ch
(
roŸ
, 
p
, &
b
, 
Àvñ
, 
¶Ÿ
, 
key
);

2316 i‡(
îr
 =-
EAGAIN
)

2317 
agaö
;

2318 i‡(
îr
) {

2319 
ªt
 = 
îr
;

2320 
d⁄e
;

2323 i‡(!
p
->
skù_lockög
) {

2324 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
b
);

2326 
	`båfs_maybe_ª£t_lockdï_˛ass
(
roŸ
, 
b
);

2328 i‡(
Àvñ
 <
wrôe_lock_Àvñ
) {

2329 
	`båfs_åì_lock
(
b
);

2330 
p
->
locks
[
Àvñ
] = 
BTRFS_WRITE_LOCK
;

2332 i‡(
p
->
nowaô
) {

2333 i‡(!
	`båfs_åy_åì_ªad_lock
(
b
)) {

2334 
	`‰ì_exã¡_buf„r
(
b
);

2335 
ªt
 = -
EAGAIN
;

2336 
d⁄e
;

2339 
	`båfs_åì_ªad_lock
(
b
);

2341 
p
->
locks
[
Àvñ
] = 
BTRFS_READ_LOCK
;

2343 
p
->
nodes
[
Àvñ
] = 
b
;

2346 
ªt
 = 1;

2347 
d⁄e
:

2348 i‡(
ªt
 < 0 && !
p
->
skù_ªÀa£_⁄_îr‹
)

2349 
	`båfs_ªÀa£_∑th
(
p
);

2351 i‡(
p
->
√ed_commô_£m
) {

2352 
ªt2
;

2354 
ªt2
 = 
	`föish_√ed_commô_£m_£¨ch
(
p
);

2355 
	`up_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

2356 i‡(
ªt2
)

2357 
ªt
 = 
ªt2
;

2360  
ªt
;

2361 
	}
}

2362 
ALLOW_ERROR_INJECTION
(
båfs_£¨ch_¶Ÿ
, 
ERRNO
);

2375 
	$båfs_£¨ch_ﬁd_¶Ÿ
(
båfs_roŸ
 *
roŸ
, c⁄° 
båfs_key
 *
key
,

2376 
båfs_∑th
 *
p
, 
u64
 
time_£q
)

2378 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

2379 
exã¡_buf„r
 *
b
;

2380 
¶Ÿ
;

2381 
ªt
;

2382 
îr
;

2383 
Àvñ
;

2384 
lowe°_u∆ock
 = 1;

2385 
u8
 
lowe°_Àvñ
 = 0;

2387 
lowe°_Àvñ
 = 
p
->lowest_level;

2388 
	`WARN_ON
(
p
->
nodes
[0] !
NULL
);

2389 
	`ASSERT
(!
p
->
nowaô
);

2391 i‡(
p
->
£¨ch_commô_roŸ
) {

2392 
	`BUG_ON
(
time_£q
);

2393  
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, 
key
, 
p
, 0, 0);

2396 
agaö
:

2397 
b
 = 
	`båfs_gë_ﬁd_roŸ
(
roŸ
, 
time_£q
);

2398 i‡(!
b
) {

2399 
ªt
 = -
EIO
;

2400 
d⁄e
;

2402 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
b
);

2403 
p
->
locks
[
Àvñ
] = 
BTRFS_READ_LOCK
;

2405 
b
) {

2406 
dec
 = 0;

2408 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
b
);

2409 
p
->
nodes
[
Àvñ
] = 
b
;

2417 
	`båfs_u∆ock_up_ß„
(
p
, 
Àvñ
 + 1);

2419 
ªt
 = 
	`båfs_bö_£¨ch
(
b
, 0, 
key
, &
¶Ÿ
);

2420 i‡(
ªt
 < 0)

2421 
d⁄e
;

2423 i‡(
Àvñ
 == 0) {

2424 
p
->
¶Ÿs
[
Àvñ
] = 
¶Ÿ
;

2425 
	`u∆ock_up
(
p
, 
Àvñ
, 
lowe°_u∆ock
, 0, 
NULL
);

2426 
d⁄e
;

2429 i‡(
ªt
 && 
¶Ÿ
 > 0) {

2430 
dec
 = 1;

2431 
¶Ÿ
--;

2433 
p
->
¶Ÿs
[
Àvñ
] = 
¶Ÿ
;

2434 
	`u∆ock_up
(
p
, 
Àvñ
, 
lowe°_u∆ock
, 0, 
NULL
);

2436 i‡(
Àvñ
 =
lowe°_Àvñ
) {

2437 i‡(
dec
)

2438 
p
->
¶Ÿs
[
Àvñ
]++;

2439 
d⁄e
;

2442 
îr
 = 
	`ªad_block_f‹_£¨ch
(
roŸ
, 
p
, &
b
, 
Àvñ
, 
¶Ÿ
, 
key
);

2443 i‡(
îr
 =-
EAGAIN
)

2444 
agaö
;

2445 i‡(
îr
) {

2446 
ªt
 = 
îr
;

2447 
d⁄e
;

2450 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
b
);

2451 
	`båfs_åì_ªad_lock
(
b
);

2452 
b
 = 
	`båfs_åì_mod_log_ªwöd
(
fs_öfo
, 
p
, b, 
time_£q
);

2453 i‡(!
b
) {

2454 
ªt
 = -
ENOMEM
;

2455 
d⁄e
;

2457 
p
->
locks
[
Àvñ
] = 
BTRFS_READ_LOCK
;

2458 
p
->
nodes
[
Àvñ
] = 
b
;

2460 
ªt
 = 1;

2461 
d⁄e
:

2462 i‡(
ªt
 < 0)

2463 
	`båfs_ªÀa£_∑th
(
p
);

2465  
ªt
;

2466 
	}
}

2477 
	$båfs_¥ev_Àaf
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
)

2479 
båfs_key
 
key
;

2480 
båfs_key
 
‹ig_key
;

2481 
båfs_disk_key
 
found_key
;

2482 
ªt
;

2484 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
, 0);

2485 
‹ig_key
 = 
key
;

2487 i‡(
key
.
off£t
 > 0) {

2488 
key
.
off£t
--;

2489 } i‡(
key
.
ty≥
 > 0) {

2490 
key
.
ty≥
--;

2491 
key
.
off£t
 = (
u64
)-1;

2492 } i‡(
key
.
obje˘id
 > 0) {

2493 
key
.
obje˘id
--;

2494 
key
.
ty≥
 = (
u8
)-1;

2495 
key
.
off£t
 = (
u64
)-1;

2500 
	`båfs_ªÀa£_∑th
(
∑th
);

2501 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

2502 i‡(
ªt
 <= 0)

2503  
ªt
;

2516 i‡(
∑th
->
¶Ÿs
[0] < 
	`båfs_hódî_ƒôems
’©h->
nodes
[0])) {

2517 
	`båfs_ôem_key
(
∑th
->
nodes
[0], &
found_key
,Ö©h->
¶Ÿs
[0]);

2518 
ªt
 = 
	`comp_keys
(&
found_key
, &
‹ig_key
);

2519 i‡(
ªt
 == 0) {

2520 i‡(
∑th
->
¶Ÿs
[0] > 0) {

2521 
∑th
->
¶Ÿs
[0]--;

2532 
	`båfs_ôem_key
(
∑th
->
nodes
[0], &
found_key
, 0);

2533 
ªt
 = 
	`comp_keys
(&
found_key
, &
key
);

2544 i‡(
ªt
 <= 0)

2547 
	}
}

2561 
	$båfs_£¨ch_¶Ÿ_f‹_ªad
(
båfs_roŸ
 *
roŸ
,

2562 c⁄° 
båfs_key
 *
key
,

2563 
båfs_∑th
 *
p
, 
föd_highî
,

2564 
ªtu∫_™y
)

2566 
ªt
;

2567 
exã¡_buf„r
 *
Àaf
;

2569 
agaö
:

2570 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, 
key
, 
p
, 0, 0);

2571 i‡(
ªt
 <= 0)

2572  
ªt
;

2580 
Àaf
 = 
p
->
nodes
[0];

2582 i‡(
föd_highî
) {

2583 i‡(
p
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
(
Àaf
)) {

2584 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
p
);

2585 i‡(
ªt
 <= 0)

2586  
ªt
;

2587 i‡(!
ªtu∫_™y
)

2593 
ªtu∫_™y
 = 0;

2594 
föd_highî
 = 0;

2595 
	`båfs_ªÀa£_∑th
(
p
);

2596 
agaö
;

2599 i‡(
p
->
¶Ÿs
[0] == 0) {

2600 
ªt
 = 
	`båfs_¥ev_Àaf
(
roŸ
, 
p
);

2601 i‡(
ªt
 < 0)

2602  
ªt
;

2603 i‡(!
ªt
) {

2604 
Àaf
 = 
p
->
nodes
[0];

2605 i‡(
p
->
¶Ÿs
[0] =
	`båfs_hódî_ƒôems
(
Àaf
))

2606 
p
->
¶Ÿs
[0]--;

2609 i‡(!
ªtu∫_™y
)

2615 
ªtu∫_™y
 = 0;

2616 
föd_highî
 = 1;

2617 
	`båfs_ªÀa£_∑th
(
p
);

2618 
agaö
;

2620 --
p
->
¶Ÿs
[0];

2624 
	}
}

2632 
	$båfs_£¨ch_backw¨ds
(
båfs_roŸ
 *
roŸ
, 
båfs_key
 *
key
,

2633 
båfs_∑th
 *
∑th
)

2635 
ªt
;

2637 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, 
key
, 
∑th
, 0, 0);

2638 i‡(
ªt
 > 0)

2639 
ªt
 = 
	`båfs_¥evious_ôem
(
roŸ
, 
∑th
, 
key
->
obje˘id
, key->
ty≥
);

2641 i‡(
ªt
 == 0)

2642 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], 
key
,Ö©h->
¶Ÿs
[0]);

2644  
ªt
;

2645 
	}
}

2658 
	$båfs_gë_√xt_vÆid_ôem
(
båfs_roŸ
 *
roŸ
, 
båfs_key
 *
key
,

2659 
båfs_∑th
 *
∑th
)

2661 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
’©h->
nodes
[0])) {

2662 
ªt
;

2664 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

2665 i‡(
ªt
)

2666  
ªt
;

2669 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], 
key
,Ö©h->
¶Ÿs
[0]);

2671 
	}
}

2681 
	$fixup_low_keys
(
båfs_å™s_h™dÀ
 *
å™s
,

2682 
båfs_∑th
 *
∑th
,

2683 
båfs_disk_key
 *
key
, 
Àvñ
)

2685 
i
;

2686 
exã¡_buf„r
 *
t
;

2687 
ªt
;

2689 
i
 = 
Àvñ
; i < 
BTRFS_MAX_LEVEL
; i++) {

2690 
t¶Ÿ
 = 
∑th
->
¶Ÿs
[
i
];

2692 i‡(!
∑th
->
nodes
[
i
])

2694 
t
 = 
∑th
->
nodes
[
i
];

2695 
ªt
 = 
	`båfs_åì_mod_log_ö£π_key
(
t
, 
t¶Ÿ
,

2696 
BTRFS_MOD_LOG_KEY_REPLACE
);

2697 
	`BUG_ON
(
ªt
 < 0);

2698 
	`båfs_£t_node_key
(
t
, 
key
, 
t¶Ÿ
);

2699 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑th
->
nodes
[
i
]);

2700 i‡(
t¶Ÿ
 != 0)

2703 
	}
}

2711 
	$båfs_£t_ôem_key_ß„
(
båfs_å™s_h™dÀ
 *
å™s
,

2712 
båfs_∑th
 *
∑th
,

2713 c⁄° 
båfs_key
 *
√w_key
)

2715 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2716 
båfs_disk_key
 
disk_key
;

2717 
exã¡_buf„r
 *
eb
;

2718 
¶Ÿ
;

2720 
eb
 = 
∑th
->
nodes
[0];

2721 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

2722 i‡(
¶Ÿ
 > 0) {

2723 
	`båfs_ôem_key
(
eb
, &
disk_key
, 
¶Ÿ
 - 1);

2724 i‡(
	`u∆ikñy
(
	`comp_keys
(&
disk_key
, 
√w_key
) >= 0)) {

2725 
	`båfs_¥öt_Àaf
(
eb
);

2726 
	`båfs_¸ô
(
fs_öfo
,

2728 
¶Ÿ
, 
	`båfs_disk_key_obje˘id
(&
disk_key
),

2729 
	`båfs_disk_key_ty≥
(&
disk_key
),

2730 
	`båfs_disk_key_off£t
(&
disk_key
),

2731 
√w_key
->
obje˘id
,Çew_key->
ty≥
,

2732 
√w_key
->
off£t
);

2733 
	`BUG
();

2736 i‡(
¶Ÿ
 < 
	`båfs_hódî_ƒôems
(
eb
) - 1) {

2737 
	`båfs_ôem_key
(
eb
, &
disk_key
, 
¶Ÿ
 + 1);

2738 i‡(
	`u∆ikñy
(
	`comp_keys
(&
disk_key
, 
√w_key
) <= 0)) {

2739 
	`båfs_¥öt_Àaf
(
eb
);

2740 
	`båfs_¸ô
(
fs_öfo
,

2742 
¶Ÿ
, 
	`båfs_disk_key_obje˘id
(&
disk_key
),

2743 
	`båfs_disk_key_ty≥
(&
disk_key
),

2744 
	`båfs_disk_key_off£t
(&
disk_key
),

2745 
√w_key
->
obje˘id
,Çew_key->
ty≥
,

2746 
√w_key
->
off£t
);

2747 
	`BUG
();

2751 
	`båfs_˝u_key_to_disk
(&
disk_key
, 
√w_key
);

2752 
	`båfs_£t_ôem_key
(
eb
, &
disk_key
, 
¶Ÿ
);

2753 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
eb
);

2754 i‡(
¶Ÿ
 == 0)

2755 
	`fixup_low_keys
(
å™s
, 
∑th
, &
disk_key
, 1);

2756 
	}
}

2778 
boﬁ
 
	$check_siblög_keys
(
exã¡_buf„r
 *
À·
,

2779 
exã¡_buf„r
 *
right
)

2781 
båfs_key
 
À·_œ°
;

2782 
båfs_key
 
right_fú°
;

2783 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
À·
);

2784 
ƒ_À·
 = 
	`båfs_hódî_ƒôems
(
À·
);

2785 
ƒ_right
 = 
	`båfs_hódî_ƒôems
(
right
);

2788 i‡(!
ƒ_À·
 || !
ƒ_right
)

2789  
Ál£
;

2791 i‡(
Àvñ
) {

2792 
	`båfs_node_key_to_˝u
(
À·
, &
À·_œ°
, 
ƒ_À·
 - 1);

2793 
	`båfs_node_key_to_˝u
(
right
, &
right_fú°
, 0);

2795 
	`båfs_ôem_key_to_˝u
(
À·
, &
À·_œ°
, 
ƒ_À·
 - 1);

2796 
	`båfs_ôem_key_to_˝u
(
right
, &
right_fú°
, 0);

2799 i‡(
	`u∆ikñy
(
	`båfs_comp_˝u_keys
(&
À·_œ°
, &
right_fú°
) >= 0)) {

2800 
	`båfs_¸ô
(
À·
->
fs_öfo
, "leftÉxtent buffer:");

2801 
	`båfs_¥öt_åì
(
À·
, 
Ál£
);

2802 
	`båfs_¸ô
(
À·
->
fs_öfo
, "rightÉxtent buffer:");

2803 
	`båfs_¥öt_åì
(
right
, 
Ál£
);

2804 
	`båfs_¸ô
(
À·
->
fs_öfo
,

2806 
À·_œ°
.
obje˘id
,Üe·_œ°.
ty≥
,

2807 
À·_œ°
.
off£t
, 
right_fú°
.
obje˘id
,

2808 
right_fú°
.
ty≥
,Ñight_fú°.
off£t
);

2809  
åue
;

2811  
Ál£
;

2812 
	}
}

2821 
	$push_node_À·
(
båfs_å™s_h™dÀ
 *
å™s
,

2822 
exã¡_buf„r
 *
d°
,

2823 
exã¡_buf„r
 *
§c
, 
em±y
)

2825 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2826 
push_ôems
 = 0;

2827 
§c_ƒôems
;

2828 
d°_ƒôems
;

2829 
ªt
 = 0;

2831 
§c_ƒôems
 = 
	`båfs_hódî_ƒôems
(
§c
);

2832 
d°_ƒôems
 = 
	`båfs_hódî_ƒôems
(
d°
);

2833 
push_ôems
 = 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_öfo
Ë- 
d°_ƒôems
;

2834 
	`WARN_ON
(
	`båfs_hódî_gíî©i⁄
(
§c
Ë!
å™s
->
å™sid
);

2835 
	`WARN_ON
(
	`båfs_hódî_gíî©i⁄
(
d°
Ë!
å™s
->
å™sid
);

2837 i‡(!
em±y
 && 
§c_ƒôems
 <= 8)

2840 i‡(
push_ôems
 <= 0)

2843 i‡(
em±y
) {

2844 
push_ôems
 = 
	`mö
(
§c_ƒôems
,Öush_items);

2845 i‡(
push_ôems
 < 
§c_ƒôems
) {

2849 i‡(
§c_ƒôems
 - 
push_ôems
 < 8) {

2850 i‡(
push_ôems
 <= 8)

2852 
push_ôems
 -= 8;

2856 
push_ôems
 = 
	`mö
(
§c_ƒôems
 - 8,Öush_items);

2859 i‡(
	`check_siblög_keys
(
d°
, 
§c
)) {

2860 
ªt
 = -
EUCLEAN
;

2861 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2862  
ªt
;

2864 
ªt
 = 
	`båfs_åì_mod_log_eb_c›y
(
d°
, 
§c
, 
d°_ƒôems
, 0, 
push_ôems
);

2865 i‡(
ªt
) {

2866 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2867  
ªt
;

2869 
	`c›y_exã¡_buf„r
(
d°
, 
§c
,

2870 
	`båfs_node_key_±r_off£t
(
d°
, 
d°_ƒôems
),

2871 
	`båfs_node_key_±r_off£t
(
§c
, 0),

2872 
push_ôems
 * (
båfs_key_±r
));

2874 i‡(
push_ôems
 < 
§c_ƒôems
) {

2879 
	`memmove_exã¡_buf„r
(
§c
, 
	`båfs_node_key_±r_off£t
(src, 0),

2880 
	`båfs_node_key_±r_off£t
(
§c
, 
push_ôems
),

2881 (
§c_ƒôems
 - 
push_ôems
) *

2882 (
båfs_key_±r
));

2884 
	`båfs_£t_hódî_ƒôems
(
§c
, 
§c_ƒôems
 - 
push_ôems
);

2885 
	`båfs_£t_hódî_ƒôems
(
d°
, 
d°_ƒôems
 + 
push_ôems
);

2886 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
§c
);

2887 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
d°
);

2889  
ªt
;

2890 
	}
}

2901 
	$bÆ™˚_node_right
(
båfs_å™s_h™dÀ
 *
å™s
,

2902 
exã¡_buf„r
 *
d°
,

2903 
exã¡_buf„r
 *
§c
)

2905 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2906 
push_ôems
 = 0;

2907 
max_push
;

2908 
§c_ƒôems
;

2909 
d°_ƒôems
;

2910 
ªt
 = 0;

2912 
	`WARN_ON
(
	`båfs_hódî_gíî©i⁄
(
§c
Ë!
å™s
->
å™sid
);

2913 
	`WARN_ON
(
	`båfs_hódî_gíî©i⁄
(
d°
Ë!
å™s
->
å™sid
);

2915 
§c_ƒôems
 = 
	`båfs_hódî_ƒôems
(
§c
);

2916 
d°_ƒôems
 = 
	`båfs_hódî_ƒôems
(
d°
);

2917 
push_ôems
 = 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_öfo
Ë- 
d°_ƒôems
;

2918 i‡(
push_ôems
 <= 0)

2921 i‡(
§c_ƒôems
 < 4)

2924 
max_push
 = 
§c_ƒôems
 / 2 + 1;

2926 i‡(
max_push
 >
§c_ƒôems
)

2929 i‡(
max_push
 < 
push_ôems
)

2930 
push_ôems
 = 
max_push
;

2933 i‡(
	`check_siblög_keys
(
§c
, 
d°
)) {

2934 
ªt
 = -
EUCLEAN
;

2935 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2936  
ªt
;

2943 
	`memmove_exã¡_buf„r
(
d°
, 
	`båfs_node_key_±r_off£t
(d°, 
push_ôems
),

2944 
	`båfs_node_key_±r_off£t
(
d°
, 0),

2945 (
d°_ƒôems
) *

2946 (
båfs_key_±r
));

2948 
ªt
 = 
	`båfs_åì_mod_log_eb_c›y
(
d°
, 
§c
, 0, 
§c_ƒôems
 - 
push_ôems
,

2949 
push_ôems
);

2950 i‡(
ªt
) {

2951 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2952  
ªt
;

2954 
	`c›y_exã¡_buf„r
(
d°
, 
§c
,

2955 
	`båfs_node_key_±r_off£t
(
d°
, 0),

2956 
	`båfs_node_key_±r_off£t
(
§c
, 
§c_ƒôems
 - 
push_ôems
),

2957 
push_ôems
 * (
båfs_key_±r
));

2959 
	`båfs_£t_hódî_ƒôems
(
§c
, 
§c_ƒôems
 - 
push_ôems
);

2960 
	`båfs_£t_hódî_ƒôems
(
d°
, 
d°_ƒôems
 + 
push_ôems
);

2962 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
§c
);

2963 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
d°
);

2965  
ªt
;

2966 
	}
}

2975 
noölöe
 
	$ö£π_√w_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

2976 
båfs_roŸ
 *
roŸ
,

2977 
båfs_∑th
 *
∑th
, 
Àvñ
)

2979 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

2980 
u64
 
lowî_gí
;

2981 
exã¡_buf„r
 *
lowî
;

2982 
exã¡_buf„r
 *
c
;

2983 
exã¡_buf„r
 *
ﬁd
;

2984 
båfs_disk_key
 
lowî_key
;

2985 
ªt
;

2987 
	`BUG_ON
(
∑th
->
nodes
[
Àvñ
]);

2988 
	`BUG_ON
(
∑th
->
nodes
[
Àvñ
-1] !
roŸ
->
node
);

2990 
lowî
 = 
∑th
->
nodes
[
Àvñ
-1];

2991 i‡(
Àvñ
 == 1)

2992 
	`båfs_ôem_key
(
lowî
, &
lowî_key
, 0);

2994 
	`båfs_node_key
(
lowî
, &
lowî_key
, 0);

2996 
c
 = 
	`båfs_Æloc_åì_block
(
å™s
, 
roŸ
, 0,ÑoŸ->
roŸ_key
.
obje˘id
,

2997 &
lowî_key
, 
Àvñ
, 
roŸ
->
node
->
°¨t
, 0,

2998 
BTRFS_NESTING_NEW_ROOT
);

2999 i‡(
	`IS_ERR
(
c
))

3000  
	`PTR_ERR
(
c
);

3002 
	`roŸ_add_u£d
(
roŸ
, 
fs_öfo
->
nodesize
);

3004 
	`båfs_£t_hódî_ƒôems
(
c
, 1);

3005 
	`båfs_£t_node_key
(
c
, &
lowî_key
, 0);

3006 
	`båfs_£t_node_block±r
(
c
, 0, 
lowî
->
°¨t
);

3007 
lowî_gí
 = 
	`båfs_hódî_gíî©i⁄
(
lowî
);

3008 
	`WARN_ON
(
lowî_gí
 !
å™s
->
å™sid
);

3010 
	`båfs_£t_node_±r_gíî©i⁄
(
c
, 0, 
lowî_gí
);

3012 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
c
);

3014 
ﬁd
 = 
roŸ
->
node
;

3015 
ªt
 = 
	`båfs_åì_mod_log_ö£π_roŸ
(
roŸ
->
node
, 
c
, 
Ál£
);

3016 i‡(
ªt
 < 0) {

3017 
	`båfs_‰ì_åì_block
(
å™s
, 
	`båfs_roŸ_id
(
roŸ
), 
c
, 0, 1);

3018 
	`båfs_åì_u∆ock
(
c
);

3019 
	`‰ì_exã¡_buf„r
(
c
);

3020  
ªt
;

3022 
	`rcu_assign_poöãr
(
roŸ
->
node
, 
c
);

3025 
	`‰ì_exã¡_buf„r
(
ﬁd
);

3027 
	`add_roŸ_to_dúty_li°
(
roŸ
);

3028 
	`©omic_öc
(&
c
->
ªfs
);

3029 
∑th
->
nodes
[
Àvñ
] = 
c
;

3030 
∑th
->
locks
[
Àvñ
] = 
BTRFS_WRITE_LOCK
;

3031 
∑th
->
¶Ÿs
[
Àvñ
] = 0;

3033 
	}
}

3042 
	$ö£π_±r
(
båfs_å™s_h™dÀ
 *
å™s
,

3043 
båfs_∑th
 *
∑th
,

3044 
båfs_disk_key
 *
key
, 
u64
 
byãƒ
,

3045 
¶Ÿ
, 
Àvñ
)

3047 
exã¡_buf„r
 *
lowî
;

3048 
ƒôems
;

3049 
ªt
;

3051 
	`BUG_ON
(!
∑th
->
nodes
[
Àvñ
]);

3052 
	`båfs_as£π_åì_wrôe_locked
(
∑th
->
nodes
[
Àvñ
]);

3053 
lowî
 = 
∑th
->
nodes
[
Àvñ
];

3054 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
lowî
);

3055 
	`BUG_ON
(
¶Ÿ
 > 
ƒôems
);

3056 
	`BUG_ON
(
ƒôems
 =
	`BTRFS_NODEPTRS_PER_BLOCK
(
å™s
->
fs_öfo
));

3057 i‡(
¶Ÿ
 !
ƒôems
) {

3058 i‡(
Àvñ
) {

3059 
ªt
 = 
	`båfs_åì_mod_log_ö£π_move
(
lowî
, 
¶Ÿ
 + 1,

3060 
¶Ÿ
, 
ƒôems
 - slot);

3061 i‡(
ªt
 < 0) {

3062 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3063  
ªt
;

3066 
	`memmove_exã¡_buf„r
(
lowî
,

3067 
	`båfs_node_key_±r_off£t
(
lowî
, 
¶Ÿ
 + 1),

3068 
	`båfs_node_key_±r_off£t
(
lowî
, 
¶Ÿ
),

3069 (
ƒôems
 - 
¶Ÿ
Ë* (
båfs_key_±r
));

3071 i‡(
Àvñ
) {

3072 
ªt
 = 
	`båfs_åì_mod_log_ö£π_key
(
lowî
, 
¶Ÿ
,

3073 
BTRFS_MOD_LOG_KEY_ADD
);

3074 i‡(
ªt
 < 0) {

3075 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3076  
ªt
;

3079 
	`båfs_£t_node_key
(
lowî
, 
key
, 
¶Ÿ
);

3080 
	`båfs_£t_node_block±r
(
lowî
, 
¶Ÿ
, 
byãƒ
);

3081 
	`WARN_ON
(
å™s
->
å™sid
 == 0);

3082 
	`båfs_£t_node_±r_gíî©i⁄
(
lowî
, 
¶Ÿ
, 
å™s
->
å™sid
);

3083 
	`båfs_£t_hódî_ƒôems
(
lowî
, 
ƒôems
 + 1);

3084 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
lowî
);

3087 
	}
}

3098 
noölöe
 
	$•lô_node
(
båfs_å™s_h™dÀ
 *
å™s
,

3099 
båfs_roŸ
 *
roŸ
,

3100 
båfs_∑th
 *
∑th
, 
Àvñ
)

3102 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

3103 
exã¡_buf„r
 *
c
;

3104 
exã¡_buf„r
 *
•lô
;

3105 
båfs_disk_key
 
disk_key
;

3106 
mid
;

3107 
ªt
;

3108 
u32
 
c_ƒôems
;

3110 
c
 = 
∑th
->
nodes
[
Àvñ
];

3111 
	`WARN_ON
(
	`båfs_hódî_gíî©i⁄
(
c
Ë!
å™s
->
å™sid
);

3112 i‡(
c
 =
roŸ
->
node
) {

3123 
ªt
 = 
	`ö£π_√w_roŸ
(
å™s
, 
roŸ
, 
∑th
, 
Àvñ
 + 1);

3124 i‡(
ªt
)

3125  
ªt
;

3127 
ªt
 = 
	`push_nodes_f‹_ö£π
(
å™s
, 
roŸ
, 
∑th
, 
Àvñ
);

3128 
c
 = 
∑th
->
nodes
[
Àvñ
];

3129 i‡(!
ªt
 && 
	`båfs_hódî_ƒôems
(
c
) <

3130 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_öfo
) - 3)

3132 i‡(
ªt
 < 0)

3133  
ªt
;

3136 
c_ƒôems
 = 
	`båfs_hódî_ƒôems
(
c
);

3137 
mid
 = (
c_ƒôems
 + 1) / 2;

3138 
	`båfs_node_key
(
c
, &
disk_key
, 
mid
);

3140 
•lô
 = 
	`båfs_Æloc_åì_block
(
å™s
, 
roŸ
, 0,ÑoŸ->
roŸ_key
.
obje˘id
,

3141 &
disk_key
, 
Àvñ
, 
c
->
°¨t
, 0,

3142 
BTRFS_NESTING_SPLIT
);

3143 i‡(
	`IS_ERR
(
•lô
))

3144  
	`PTR_ERR
(
•lô
);

3146 
	`roŸ_add_u£d
(
roŸ
, 
fs_öfo
->
nodesize
);

3147 
	`ASSERT
(
	`båfs_hódî_Àvñ
(
c
Ë=
Àvñ
);

3149 
ªt
 = 
	`båfs_åì_mod_log_eb_c›y
(
•lô
, 
c
, 0, 
mid
, 
c_ƒôems
 - mid);

3150 i‡(
ªt
) {

3151 
	`båfs_åì_u∆ock
(
•lô
);

3152 
	`‰ì_exã¡_buf„r
(
•lô
);

3153 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3154  
ªt
;

3156 
	`c›y_exã¡_buf„r
(
•lô
, 
c
,

3157 
	`båfs_node_key_±r_off£t
(
•lô
, 0),

3158 
	`båfs_node_key_±r_off£t
(
c
, 
mid
),

3159 (
c_ƒôems
 - 
mid
Ë* (
båfs_key_±r
));

3160 
	`båfs_£t_hódî_ƒôems
(
•lô
, 
c_ƒôems
 - 
mid
);

3161 
	`båfs_£t_hódî_ƒôems
(
c
, 
mid
);

3163 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
c
);

3164 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
•lô
);

3166 
ªt
 = 
	`ö£π_±r
(
å™s
, 
∑th
, &
disk_key
, 
•lô
->
°¨t
,

3167 
∑th
->
¶Ÿs
[
Àvñ
 + 1] + 1,Üevel + 1);

3168 i‡(
ªt
 < 0) {

3169 
	`båfs_åì_u∆ock
(
•lô
);

3170 
	`‰ì_exã¡_buf„r
(
•lô
);

3171  
ªt
;

3174 i‡(
∑th
->
¶Ÿs
[
Àvñ
] >
mid
) {

3175 
∑th
->
¶Ÿs
[
Àvñ
] -
mid
;

3176 
	`båfs_åì_u∆ock
(
c
);

3177 
	`‰ì_exã¡_buf„r
(
c
);

3178 
∑th
->
nodes
[
Àvñ
] = 
•lô
;

3179 
∑th
->
¶Ÿs
[
Àvñ
 + 1] += 1;

3181 
	`båfs_åì_u∆ock
(
•lô
);

3182 
	`‰ì_exã¡_buf„r
(
•lô
);

3185 
	}
}

3192 
	$Àaf_•a˚_u£d
(c⁄° 
exã¡_buf„r
 *
l
, 
°¨t
, 
ƒ
)

3194 
d©a_Àn
;

3195 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
l
);

3196 
íd
 = 
	`mö
(
ƒôems
, 
°¨t
 + 
ƒ
) - 1;

3198 i‡(!
ƒ
)

3200 
d©a_Àn
 = 
	`båfs_ôem_off£t
(
l
, 
°¨t
Ë+ 
	`båfs_ôem_size
(l, start);

3201 
d©a_Àn
 = d©a_À¿- 
	`båfs_ôem_off£t
(
l
, 
íd
);

3202 
d©a_Àn
 +(
båfs_ôem
Ë* 
ƒ
;

3203 
	`WARN_ON
(
d©a_Àn
 < 0);

3204  
d©a_Àn
;

3205 
	}
}

3212 
	$båfs_Àaf_‰ì_•a˚
(c⁄° 
exã¡_buf„r
 *
Àaf
)

3214 
båfs_fs_öfo
 *
fs_öfo
 = 
Àaf
->fs_info;

3215 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

3216 
ªt
;

3218 
ªt
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
Ë- 
	`Àaf_•a˚_u£d
(
Àaf
, 0, 
ƒôems
);

3219 i‡(
ªt
 < 0) {

3220 
	`båfs_¸ô
(
fs_öfo
,

3222 
ªt
,

3223 (Ë
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
),

3224 
	`Àaf_•a˚_u£d
(
Àaf
, 0, 
ƒôems
),Çritems);

3226  
ªt
;

3227 
	}
}

3233 
noölöe
 
	$__push_Àaf_right
(
båfs_å™s_h™dÀ
 *
å™s
,

3234 
båfs_∑th
 *
∑th
,

3235 
d©a_size
, 
em±y
,

3236 
exã¡_buf„r
 *
right
,

3237 
‰ì_•a˚
, 
u32
 
À·_ƒôems
,

3238 
u32
 
mö_¶Ÿ
)

3240 
båfs_fs_öfo
 *
fs_öfo
 = 
right
->fs_info;

3241 
exã¡_buf„r
 *
À·
 = 
∑th
->
nodes
[0];

3242 
exã¡_buf„r
 *
uµî
 = 
∑th
->
nodes
[1];

3243 
båfs_m≠_tokí
 
tokí
;

3244 
båfs_disk_key
 
disk_key
;

3245 
¶Ÿ
;

3246 
u32
 
i
;

3247 
push_•a˚
 = 0;

3248 
push_ôems
 = 0;

3249 
u32
 
ƒ
;

3250 
u32
 
right_ƒôems
;

3251 
u32
 
d©a_íd
;

3252 
u32
 
this_ôem_size
;

3254 i‡(
em±y
)

3255 
ƒ
 = 0;

3257 
ƒ
 = 
	`max_t
(
u32
, 1, 
mö_¶Ÿ
);

3259 i‡(
∑th
->
¶Ÿs
[0] >
À·_ƒôems
)

3260 
push_•a˚
 +
d©a_size
;

3262 
¶Ÿ
 = 
∑th
->
¶Ÿs
[1];

3263 
i
 = 
À·_ƒôems
 - 1;

3264 
i
 >
ƒ
) {

3265 i‡(!
em±y
 && 
push_ôems
 > 0) {

3266 i‡(
∑th
->
¶Ÿs
[0] > 
i
)

3268 i‡(
∑th
->
¶Ÿs
[0] =
i
) {

3269 
•a˚
 = 
	`båfs_Àaf_‰ì_•a˚
(
À·
);

3271 i‡(
•a˚
 + 
push_•a˚
 * 2 > 
‰ì_•a˚
)

3276 i‡(
∑th
->
¶Ÿs
[0] =
i
)

3277 
push_•a˚
 +
d©a_size
;

3279 
this_ôem_size
 = 
	`båfs_ôem_size
(
À·
, 
i
);

3280 i‡(
this_ôem_size
 + (
båfs_ôem
) +

3281 
push_•a˚
 > 
‰ì_•a˚
)

3284 
push_ôems
++;

3285 
push_•a˚
 +
this_ôem_size
 + (
båfs_ôem
);

3286 i‡(
i
 == 0)

3288 
i
--;

3291 i‡(
push_ôems
 == 0)

3292 
out_u∆ock
;

3294 
	`WARN_ON
(!
em±y
 && 
push_ôems
 =
À·_ƒôems
);

3297 
right_ƒôems
 = 
	`båfs_hódî_ƒôems
(
right
);

3299 
push_•a˚
 = 
	`båfs_ôem_d©a_íd
(
À·
, 
À·_ƒôems
 - 
push_ôems
);

3300 
push_•a˚
 -
	`Àaf_d©a_íd
(
À·
);

3303 
d©a_íd
 = 
	`Àaf_d©a_íd
(
right
);

3304 
	`memmove_Àaf_d©a
(
right
, 
d©a_íd
 - 
push_•a˚
, data_end,

3305 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
Ë- 
d©a_íd
);

3308 
	`c›y_Àaf_d©a
(
right
, 
À·
, 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
Ë- 
push_•a˚
,

3309 
	`Àaf_d©a_íd
(
À·
), 
push_•a˚
);

3311 
	`memmove_Àaf_ôems
(
right
, 
push_ôems
, 0, 
right_ƒôems
);

3314 
	`c›y_Àaf_ôems
(
right
, 
À·
, 0, 
À·_ƒôems
 - 
push_ôems
,Öush_items);

3317 
	`båfs_öô_m≠_tokí
(&
tokí
, 
right
);

3318 
right_ƒôems
 +
push_ôems
;

3319 
	`båfs_£t_hódî_ƒôems
(
right
, 
right_ƒôems
);

3320 
push_•a˚
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
);

3321 
i
 = 0; i < 
right_ƒôems
; i++) {

3322 
push_•a˚
 -
	`båfs_tokí_ôem_size
(&
tokí
, 
i
);

3323 
	`båfs_£t_tokí_ôem_off£t
(&
tokí
, 
i
, 
push_•a˚
);

3326 
À·_ƒôems
 -
push_ôems
;

3327 
	`båfs_£t_hódî_ƒôems
(
À·
, 
À·_ƒôems
);

3329 i‡(
À·_ƒôems
)

3330 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
À·
);

3332 
	`båfs_˛ór_buf„r_dúty
(
å™s
, 
À·
);

3334 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
right
);

3336 
	`båfs_ôem_key
(
right
, &
disk_key
, 0);

3337 
	`båfs_£t_node_key
(
uµî
, &
disk_key
, 
¶Ÿ
 + 1);

3338 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
uµî
);

3341 i‡(
∑th
->
¶Ÿs
[0] >
À·_ƒôems
) {

3342 
∑th
->
¶Ÿs
[0] -
À·_ƒôems
;

3343 i‡(
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0]) == 0)

3344 
	`båfs_˛ór_buf„r_dúty
(
å™s
, 
∑th
->
nodes
[0]);

3345 
	`båfs_åì_u∆ock
(
∑th
->
nodes
[0]);

3346 
	`‰ì_exã¡_buf„r
(
∑th
->
nodes
[0]);

3347 
∑th
->
nodes
[0] = 
right
;

3348 
∑th
->
¶Ÿs
[1] += 1;

3350 
	`båfs_åì_u∆ock
(
right
);

3351 
	`‰ì_exã¡_buf„r
(
right
);

3355 
out_u∆ock
:

3356 
	`båfs_åì_u∆ock
(
right
);

3357 
	`‰ì_exã¡_buf„r
(
right
);

3359 
	}
}

3371 
	$push_Àaf_right
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ


3372 *
roŸ
, 
båfs_∑th
 *
∑th
,

3373 
mö_d©a_size
, 
d©a_size
,

3374 
em±y
, 
u32
 
mö_¶Ÿ
)

3376 
exã¡_buf„r
 *
À·
 = 
∑th
->
nodes
[0];

3377 
exã¡_buf„r
 *
right
;

3378 
exã¡_buf„r
 *
uµî
;

3379 
¶Ÿ
;

3380 
‰ì_•a˚
;

3381 
u32
 
À·_ƒôems
;

3382 
ªt
;

3384 i‡(!
∑th
->
nodes
[1])

3387 
¶Ÿ
 = 
∑th
->
¶Ÿs
[1];

3388 
uµî
 = 
∑th
->
nodes
[1];

3389 i‡(
¶Ÿ
 >
	`båfs_hódî_ƒôems
(
uµî
) - 1)

3392 
	`båfs_as£π_åì_wrôe_locked
(
∑th
->
nodes
[1]);

3394 
right
 = 
	`båfs_ªad_node_¶Ÿ
(
uµî
, 
¶Ÿ
 + 1);

3395 i‡(
	`IS_ERR
(
right
))

3396  
	`PTR_ERR
(
right
);

3398 
	`__båfs_åì_lock
(
right
, 
BTRFS_NESTING_RIGHT
);

3400 
‰ì_•a˚
 = 
	`båfs_Àaf_‰ì_•a˚
(
right
);

3401 i‡(
‰ì_•a˚
 < 
d©a_size
)

3402 
out_u∆ock
;

3404 
ªt
 = 
	`båfs_cow_block
(
å™s
, 
roŸ
, 
right
, 
uµî
,

3405 
¶Ÿ
 + 1, &
right
, 
BTRFS_NESTING_RIGHT_COW
);

3406 i‡(
ªt
)

3407 
out_u∆ock
;

3409 
À·_ƒôems
 = 
	`båfs_hódî_ƒôems
(
À·
);

3410 i‡(
À·_ƒôems
 == 0)

3411 
out_u∆ock
;

3413 i‡(
	`check_siblög_keys
(
À·
, 
right
)) {

3414 
ªt
 = -
EUCLEAN
;

3415 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3416 
	`båfs_åì_u∆ock
(
right
);

3417 
	`‰ì_exã¡_buf„r
(
right
);

3418  
ªt
;

3420 i‡(
∑th
->
¶Ÿs
[0] =
À·_ƒôems
 && !
em±y
) {

3425 
	`båfs_åì_u∆ock
(
À·
);

3426 
	`‰ì_exã¡_buf„r
(
À·
);

3427 
∑th
->
nodes
[0] = 
right
;

3428 
∑th
->
¶Ÿs
[0] = 0;

3429 
∑th
->
¶Ÿs
[1]++;

3433  
	`__push_Àaf_right
(
å™s
, 
∑th
, 
mö_d©a_size
, 
em±y
, 
right
,

3434 
‰ì_•a˚
, 
À·_ƒôems
, 
mö_¶Ÿ
);

3435 
out_u∆ock
:

3436 
	`båfs_åì_u∆ock
(
right
);

3437 
	`‰ì_exã¡_buf„r
(
right
);

3439 
	}
}

3449 
noölöe
 
	$__push_Àaf_À·
(
båfs_å™s_h™dÀ
 *
å™s
,

3450 
båfs_∑th
 *
∑th
, 
d©a_size
,

3451 
em±y
, 
exã¡_buf„r
 *
À·
,

3452 
‰ì_•a˚
, 
u32
 
right_ƒôems
,

3453 
u32
 
max_¶Ÿ
)

3455 
båfs_fs_öfo
 *
fs_öfo
 = 
À·
->fs_info;

3456 
båfs_disk_key
 
disk_key
;

3457 
exã¡_buf„r
 *
right
 = 
∑th
->
nodes
[0];

3458 
i
;

3459 
push_•a˚
 = 0;

3460 
push_ôems
 = 0;

3461 
u32
 
ﬁd_À·_ƒôems
;

3462 
u32
 
ƒ
;

3463 
ªt
 = 0;

3464 
u32
 
this_ôem_size
;

3465 
u32
 
ﬁd_À·_ôem_size
;

3466 
båfs_m≠_tokí
 
tokí
;

3468 i‡(
em±y
)

3469 
ƒ
 = 
	`mö
(
right_ƒôems
, 
max_¶Ÿ
);

3471 
ƒ
 = 
	`mö
(
right_ƒôems
 - 1, 
max_¶Ÿ
);

3473 
i
 = 0; i < 
ƒ
; i++) {

3474 i‡(!
em±y
 && 
push_ôems
 > 0) {

3475 i‡(
∑th
->
¶Ÿs
[0] < 
i
)

3477 i‡(
∑th
->
¶Ÿs
[0] =
i
) {

3478 
•a˚
 = 
	`båfs_Àaf_‰ì_•a˚
(
right
);

3480 i‡(
•a˚
 + 
push_•a˚
 * 2 > 
‰ì_•a˚
)

3485 i‡(
∑th
->
¶Ÿs
[0] =
i
)

3486 
push_•a˚
 +
d©a_size
;

3488 
this_ôem_size
 = 
	`båfs_ôem_size
(
right
, 
i
);

3489 i‡(
this_ôem_size
 + (
båfs_ôem
Ë+ 
push_•a˚
 >

3490 
‰ì_•a˚
)

3493 
push_ôems
++;

3494 
push_•a˚
 +
this_ôem_size
 + (
båfs_ôem
);

3497 i‡(
push_ôems
 == 0) {

3498 
ªt
 = 1;

3499 
out
;

3501 
	`WARN_ON
(!
em±y
 && 
push_ôems
 =
	`båfs_hódî_ƒôems
(
right
));

3504 
	`c›y_Àaf_ôems
(
À·
, 
right
, 
	`båfs_hódî_ƒôems
÷e·), 0, 
push_ôems
);

3506 
push_•a˚
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
) -

3507 
	`båfs_ôem_off£t
(
right
, 
push_ôems
 - 1);

3509 
	`c›y_Àaf_d©a
(
À·
, 
right
, 
	`Àaf_d©a_íd
÷e·Ë- 
push_•a˚
,

3510 
	`båfs_ôem_off£t
(
right
, 
push_ôems
 - 1), 
push_•a˚
);

3511 
ﬁd_À·_ƒôems
 = 
	`båfs_hódî_ƒôems
(
À·
);

3512 
	`BUG_ON
(
ﬁd_À·_ƒôems
 <= 0);

3514 
	`båfs_öô_m≠_tokí
(&
tokí
, 
À·
);

3515 
ﬁd_À·_ôem_size
 = 
	`båfs_ôem_off£t
(
À·
, 
ﬁd_À·_ƒôems
 - 1);

3516 
i
 = 
ﬁd_À·_ƒôems
; i < old_À·_ƒôem†+ 
push_ôems
; i++) {

3517 
u32
 
ioff
;

3519 
ioff
 = 
	`båfs_tokí_ôem_off£t
(&
tokí
, 
i
);

3520 
	`båfs_£t_tokí_ôem_off£t
(&
tokí
, 
i
,

3521 
ioff
 - (
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
Ë- 
ﬁd_À·_ôem_size
));

3523 
	`båfs_£t_hódî_ƒôems
(
À·
, 
ﬁd_À·_ƒôems
 + 
push_ôems
);

3526 i‡(
push_ôems
 > 
right_ƒôems
)

3527 
	`WARN
(1, 
KERN_CRIT
 "push iãm†%dÇ∏%u\n", 
push_ôems
,

3528 
right_ƒôems
);

3530 i‡(
push_ôems
 < 
right_ƒôems
) {

3531 
push_•a˚
 = 
	`båfs_ôem_off£t
(
right
, 
push_ôems
 - 1) -

3532 
	`Àaf_d©a_íd
(
right
);

3533 
	`memmove_Àaf_d©a
(
right
,

3534 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
Ë- 
push_•a˚
,

3535 
	`Àaf_d©a_íd
(
right
), 
push_•a˚
);

3537 
	`memmove_Àaf_ôems
(
right
, 0, 
push_ôems
,

3538 
	`båfs_hódî_ƒôems
(
right
Ë- 
push_ôems
);

3541 
	`båfs_öô_m≠_tokí
(&
tokí
, 
right
);

3542 
right_ƒôems
 -
push_ôems
;

3543 
	`båfs_£t_hódî_ƒôems
(
right
, 
right_ƒôems
);

3544 
push_•a˚
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
);

3545 
i
 = 0; i < 
right_ƒôems
; i++) {

3546 
push_•a˚
 =Öush_•a˚ - 
	`båfs_tokí_ôem_size
(&
tokí
, 
i
);

3547 
	`båfs_£t_tokí_ôem_off£t
(&
tokí
, 
i
, 
push_•a˚
);

3550 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
À·
);

3551 i‡(
right_ƒôems
)

3552 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
right
);

3554 
	`båfs_˛ór_buf„r_dúty
(
å™s
, 
right
);

3556 
	`båfs_ôem_key
(
right
, &
disk_key
, 0);

3557 
	`fixup_low_keys
(
å™s
, 
∑th
, &
disk_key
, 1);

3560 i‡(
∑th
->
¶Ÿs
[0] < 
push_ôems
) {

3561 
∑th
->
¶Ÿs
[0] +
ﬁd_À·_ƒôems
;

3562 
	`båfs_åì_u∆ock
(
∑th
->
nodes
[0]);

3563 
	`‰ì_exã¡_buf„r
(
∑th
->
nodes
[0]);

3564 
∑th
->
nodes
[0] = 
À·
;

3565 
∑th
->
¶Ÿs
[1] -= 1;

3567 
	`båfs_åì_u∆ock
(
À·
);

3568 
	`‰ì_exã¡_buf„r
(
À·
);

3569 
∑th
->
¶Ÿs
[0] -
push_ôems
;

3571 
	`BUG_ON
(
∑th
->
¶Ÿs
[0] < 0);

3572  
ªt
;

3573 
out
:

3574 
	`båfs_åì_u∆ock
(
À·
);

3575 
	`‰ì_exã¡_buf„r
(
À·
);

3576  
ªt
;

3577 
	}
}

3587 
	$push_Àaf_À·
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ


3588 *
roŸ
, 
båfs_∑th
 *
∑th
, 
mö_d©a_size
,

3589 
d©a_size
, 
em±y
, 
u32
 
max_¶Ÿ
)

3591 
exã¡_buf„r
 *
right
 = 
∑th
->
nodes
[0];

3592 
exã¡_buf„r
 *
À·
;

3593 
¶Ÿ
;

3594 
‰ì_•a˚
;

3595 
u32
 
right_ƒôems
;

3596 
ªt
 = 0;

3598 
¶Ÿ
 = 
∑th
->
¶Ÿs
[1];

3599 i‡(
¶Ÿ
 == 0)

3601 i‡(!
∑th
->
nodes
[1])

3604 
right_ƒôems
 = 
	`båfs_hódî_ƒôems
(
right
);

3605 i‡(
right_ƒôems
 == 0)

3608 
	`båfs_as£π_åì_wrôe_locked
(
∑th
->
nodes
[1]);

3610 
À·
 = 
	`båfs_ªad_node_¶Ÿ
(
∑th
->
nodes
[1], 
¶Ÿ
 - 1);

3611 i‡(
	`IS_ERR
(
À·
))

3612  
	`PTR_ERR
(
À·
);

3614 
	`__båfs_åì_lock
(
À·
, 
BTRFS_NESTING_LEFT
);

3616 
‰ì_•a˚
 = 
	`båfs_Àaf_‰ì_•a˚
(
À·
);

3617 i‡(
‰ì_•a˚
 < 
d©a_size
) {

3618 
ªt
 = 1;

3619 
out
;

3622 
ªt
 = 
	`båfs_cow_block
(
å™s
, 
roŸ
, 
À·
,

3623 
∑th
->
nodes
[1], 
¶Ÿ
 - 1, &
À·
,

3624 
BTRFS_NESTING_LEFT_COW
);

3625 i‡(
ªt
) {

3627 i‡(
ªt
 =-
ENOSPC
)

3628 
ªt
 = 1;

3629 
out
;

3632 i‡(
	`check_siblög_keys
(
À·
, 
right
)) {

3633 
ªt
 = -
EUCLEAN
;

3634 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3635 
out
;

3637  
	`__push_Àaf_À·
(
å™s
, 
∑th
, 
mö_d©a_size
, 
em±y
, 
À·
,

3638 
‰ì_•a˚
, 
right_ƒôems
, 
max_¶Ÿ
);

3639 
out
:

3640 
	`båfs_åì_u∆ock
(
À·
);

3641 
	`‰ì_exã¡_buf„r
(
À·
);

3642  
ªt
;

3643 
	}
}

3649 
noölöe
 
	$c›y_f‹_•lô
(
båfs_å™s_h™dÀ
 *
å™s
,

3650 
båfs_∑th
 *
∑th
,

3651 
exã¡_buf„r
 *
l
,

3652 
exã¡_buf„r
 *
right
,

3653 
¶Ÿ
, 
mid
, 
ƒôems
)

3655 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

3656 
d©a_c›y_size
;

3657 
π_d©a_off
;

3658 
i
;

3659 
ªt
;

3660 
båfs_disk_key
 
disk_key
;

3661 
båfs_m≠_tokí
 
tokí
;

3663 
ƒôems
 =Çrôem†- 
mid
;

3664 
	`båfs_£t_hódî_ƒôems
(
right
, 
ƒôems
);

3665 
d©a_c›y_size
 = 
	`båfs_ôem_d©a_íd
(
l
, 
mid
Ë- 
	`Àaf_d©a_íd
(l);

3667 
	`c›y_Àaf_ôems
(
right
, 
l
, 0, 
mid
, 
ƒôems
);

3669 
	`c›y_Àaf_d©a
(
right
, 
l
, 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
Ë- 
d©a_c›y_size
,

3670 
	`Àaf_d©a_íd
(
l
), 
d©a_c›y_size
);

3672 
π_d©a_off
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
Ë- 
	`båfs_ôem_d©a_íd
(
l
, 
mid
);

3674 
	`båfs_öô_m≠_tokí
(&
tokí
, 
right
);

3675 
i
 = 0; i < 
ƒôems
; i++) {

3676 
u32
 
ioff
;

3678 
ioff
 = 
	`båfs_tokí_ôem_off£t
(&
tokí
, 
i
);

3679 
	`båfs_£t_tokí_ôem_off£t
(&
tokí
, 
i
, 
ioff
 + 
π_d©a_off
);

3682 
	`båfs_£t_hódî_ƒôems
(
l
, 
mid
);

3683 
	`båfs_ôem_key
(
right
, &
disk_key
, 0);

3684 
ªt
 = 
	`ö£π_±r
(
å™s
, 
∑th
, &
disk_key
, 
right
->
°¨t
,Ö©h->
¶Ÿs
[1] + 1, 1);

3685 i‡(
ªt
 < 0)

3686  
ªt
;

3688 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
right
);

3689 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
l
);

3690 
	`BUG_ON
(
∑th
->
¶Ÿs
[0] !
¶Ÿ
);

3692 i‡(
mid
 <
¶Ÿ
) {

3693 
	`båfs_åì_u∆ock
(
∑th
->
nodes
[0]);

3694 
	`‰ì_exã¡_buf„r
(
∑th
->
nodes
[0]);

3695 
∑th
->
nodes
[0] = 
right
;

3696 
∑th
->
¶Ÿs
[0] -
mid
;

3697 
∑th
->
¶Ÿs
[1] += 1;

3699 
	`båfs_åì_u∆ock
(
right
);

3700 
	`‰ì_exã¡_buf„r
(
right
);

3703 
	`BUG_ON
(
∑th
->
¶Ÿs
[0] < 0);

3706 
	}
}

3718 
noölöe
 
	$push_f‹_doubÀ_•lô
(
båfs_å™s_h™dÀ
 *
å™s
,

3719 
båfs_roŸ
 *
roŸ
,

3720 
båfs_∑th
 *
∑th
,

3721 
d©a_size
)

3723 
ªt
;

3724 
¥ogªss
 = 0;

3725 
¶Ÿ
;

3726 
u32
 
ƒôems
;

3727 
•a˚_√eded
 = 
d©a_size
;

3729 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

3730 i‡(
¶Ÿ
 < 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0]))

3731 
•a˚_√eded
 -
	`båfs_Àaf_‰ì_•a˚
(
∑th
->
nodes
[0]);

3737 
ªt
 = 
	`push_Àaf_right
(
å™s
, 
roŸ
, 
∑th
, 1, 
•a˚_√eded
, 0, 
¶Ÿ
);

3738 i‡(
ªt
 < 0)

3739  
ªt
;

3741 i‡(
ªt
 == 0)

3742 
¥ogªss
++;

3744 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0]);

3749 i‡(
∑th
->
¶Ÿs
[0] =0 ||Ö©h->¶Ÿs[0] =
ƒôems
)

3752 i‡(
	`båfs_Àaf_‰ì_•a˚
(
∑th
->
nodes
[0]Ë>
d©a_size
)

3756 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

3757 
•a˚_√eded
 = 
d©a_size
;

3758 i‡(
¶Ÿ
 > 0)

3759 
•a˚_√eded
 -
	`båfs_Àaf_‰ì_•a˚
(
∑th
->
nodes
[0]);

3760 
ªt
 = 
	`push_Àaf_À·
(
å™s
, 
roŸ
, 
∑th
, 1, 
•a˚_√eded
, 0, 
¶Ÿ
);

3761 i‡(
ªt
 < 0)

3762  
ªt
;

3764 i‡(
ªt
 == 0)

3765 
¥ogªss
++;

3767 i‡(
¥ogªss
)

3770 
	}
}

3778 
noölöe
 
	$•lô_Àaf
(
båfs_å™s_h™dÀ
 *
å™s
,

3779 
båfs_roŸ
 *
roŸ
,

3780 c⁄° 
båfs_key
 *
ös_key
,

3781 
båfs_∑th
 *
∑th
, 
d©a_size
,

3782 
exãnd
)

3784 
båfs_disk_key
 
disk_key
;

3785 
exã¡_buf„r
 *
l
;

3786 
u32
 
ƒôems
;

3787 
mid
;

3788 
¶Ÿ
;

3789 
exã¡_buf„r
 *
right
;

3790 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

3791 
ªt
 = 0;

3792 
wªt
;

3793 
•lô
;

3794 
num_doubÀs
 = 0;

3795 
åõd_avoid_doubÀ
 = 0;

3797 
l
 = 
∑th
->
nodes
[0];

3798 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

3799 i‡(
exãnd
 && 
d©a_size
 + 
	`båfs_ôem_size
(
l
, 
¶Ÿ
) +

3800 (
båfs_ôem
Ë> 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
))

3801  -
EOVERFLOW
;

3804 i‡(
d©a_size
 && 
∑th
->
nodes
[1]) {

3805 
•a˚_√eded
 = 
d©a_size
;

3807 i‡(
¶Ÿ
 < 
	`båfs_hódî_ƒôems
(
l
))

3808 
•a˚_√eded
 -
	`båfs_Àaf_‰ì_•a˚
(
l
);

3810 
wªt
 = 
	`push_Àaf_right
(
å™s
, 
roŸ
, 
∑th
, 
•a˚_√eded
,

3811 
•a˚_√eded
, 0, 0);

3812 i‡(
wªt
 < 0)

3813  
wªt
;

3814 i‡(
wªt
) {

3815 
•a˚_√eded
 = 
d©a_size
;

3816 i‡(
¶Ÿ
 > 0)

3817 
•a˚_√eded
 -
	`båfs_Àaf_‰ì_•a˚
(
l
);

3818 
wªt
 = 
	`push_Àaf_À·
(
å™s
, 
roŸ
, 
∑th
, 
•a˚_√eded
,

3819 
•a˚_√eded
, 0, (
u32
)-1);

3820 i‡(
wªt
 < 0)

3821  
wªt
;

3823 
l
 = 
∑th
->
nodes
[0];

3826 i‡(
	`båfs_Àaf_‰ì_•a˚
(
l
Ë>
d©a_size
)

3830 i‡(!
∑th
->
nodes
[1]) {

3831 
ªt
 = 
	`ö£π_√w_roŸ
(
å™s
, 
roŸ
, 
∑th
, 1);

3832 i‡(
ªt
)

3833  
ªt
;

3835 
agaö
:

3836 
•lô
 = 1;

3837 
l
 = 
∑th
->
nodes
[0];

3838 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

3839 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
l
);

3840 
mid
 = (
ƒôems
 + 1) / 2;

3842 i‡(
mid
 <
¶Ÿ
) {

3843 i‡(
ƒôems
 == 1 ||

3844 
	`Àaf_•a˚_u£d
(
l
, 
mid
, 
ƒôems
 - midË+ 
d©a_size
 >

3845 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
)) {

3846 i‡(
¶Ÿ
 >
ƒôems
) {

3847 
•lô
 = 0;

3849 
mid
 = 
¶Ÿ
;

3850 i‡(
mid
 !
ƒôems
 &&

3851 
	`Àaf_•a˚_u£d
(
l
, 
mid
, 
ƒôems
 - mid) +

3852 
d©a_size
 > 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
)) {

3853 i‡(
d©a_size
 && !
åõd_avoid_doubÀ
)

3854 
push_f‹_doubÀ
;

3855 
•lô
 = 2;

3860 i‡(
	`Àaf_•a˚_u£d
(
l
, 0, 
mid
Ë+ 
d©a_size
 >

3861 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
)) {

3862 i‡(!
exãnd
 && 
d©a_size
 && 
¶Ÿ
 == 0) {

3863 
•lô
 = 0;

3864 } i‡((
exãnd
 || !
d©a_size
Ë&& 
¶Ÿ
 == 0) {

3865 
mid
 = 1;

3867 
mid
 = 
¶Ÿ
;

3868 i‡(
mid
 !
ƒôems
 &&

3869 
	`Àaf_•a˚_u£d
(
l
, 
mid
, 
ƒôems
 - mid) +

3870 
d©a_size
 > 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
)) {

3871 i‡(
d©a_size
 && !
åõd_avoid_doubÀ
)

3872 
push_f‹_doubÀ
;

3873 
•lô
 = 2;

3879 i‡(
•lô
 == 0)

3880 
	`båfs_˝u_key_to_disk
(&
disk_key
, 
ös_key
);

3882 
	`båfs_ôem_key
(
l
, &
disk_key
, 
mid
);

3892 
right
 = 
	`båfs_Æloc_åì_block
(
å™s
, 
roŸ
, 0,ÑoŸ->
roŸ_key
.
obje˘id
,

3893 &
disk_key
, 0, 
l
->
°¨t
, 0,

3894 
num_doubÀs
 ? 
BTRFS_NESTING_NEW_ROOT
 :

3895 
BTRFS_NESTING_SPLIT
);

3896 i‡(
	`IS_ERR
(
right
))

3897  
	`PTR_ERR
(
right
);

3899 
	`roŸ_add_u£d
(
roŸ
, 
fs_öfo
->
nodesize
);

3901 i‡(
•lô
 == 0) {

3902 i‡(
mid
 <
¶Ÿ
) {

3903 
	`båfs_£t_hódî_ƒôems
(
right
, 0);

3904 
ªt
 = 
	`ö£π_±r
(
å™s
, 
∑th
, &
disk_key
,

3905 
right
->
°¨t
, 
∑th
->
¶Ÿs
[1] + 1, 1);

3906 i‡(
ªt
 < 0) {

3907 
	`båfs_åì_u∆ock
(
right
);

3908 
	`‰ì_exã¡_buf„r
(
right
);

3909  
ªt
;

3911 
	`båfs_åì_u∆ock
(
∑th
->
nodes
[0]);

3912 
	`‰ì_exã¡_buf„r
(
∑th
->
nodes
[0]);

3913 
∑th
->
nodes
[0] = 
right
;

3914 
∑th
->
¶Ÿs
[0] = 0;

3915 
∑th
->
¶Ÿs
[1] += 1;

3917 
	`båfs_£t_hódî_ƒôems
(
right
, 0);

3918 
ªt
 = 
	`ö£π_±r
(
å™s
, 
∑th
, &
disk_key
,

3919 
right
->
°¨t
, 
∑th
->
¶Ÿs
[1], 1);

3920 i‡(
ªt
 < 0) {

3921 
	`båfs_åì_u∆ock
(
right
);

3922 
	`‰ì_exã¡_buf„r
(
right
);

3923  
ªt
;

3925 
	`båfs_åì_u∆ock
(
∑th
->
nodes
[0]);

3926 
	`‰ì_exã¡_buf„r
(
∑th
->
nodes
[0]);

3927 
∑th
->
nodes
[0] = 
right
;

3928 
∑th
->
¶Ÿs
[0] = 0;

3929 i‡(
∑th
->
¶Ÿs
[1] == 0)

3930 
	`fixup_low_keys
(
å™s
, 
∑th
, &
disk_key
, 1);

3937  
ªt
;

3940 
ªt
 = 
	`c›y_f‹_•lô
(
å™s
, 
∑th
, 
l
, 
right
, 
¶Ÿ
, 
mid
, 
ƒôems
);

3941 i‡(
ªt
 < 0) {

3942 
	`båfs_åì_u∆ock
(
right
);

3943 
	`‰ì_exã¡_buf„r
(
right
);

3944  
ªt
;

3947 i‡(
•lô
 == 2) {

3948 
	`BUG_ON
(
num_doubÀs
 != 0);

3949 
num_doubÀs
++;

3950 
agaö
;

3955 
push_f‹_doubÀ
:

3956 
	`push_f‹_doubÀ_•lô
(
å™s
, 
roŸ
, 
∑th
, 
d©a_size
);

3957 
åõd_avoid_doubÀ
 = 1;

3958 i‡(
	`båfs_Àaf_‰ì_•a˚
(
∑th
->
nodes
[0]Ë>
d©a_size
)

3960 
agaö
;

3961 
	}
}

3963 
noölöe
 
	$£tup_Àaf_f‹_•lô
(
båfs_å™s_h™dÀ
 *
å™s
,

3964 
båfs_roŸ
 *
roŸ
,

3965 
båfs_∑th
 *
∑th
, 
ös_Àn
)

3967 
båfs_key
 
key
;

3968 
exã¡_buf„r
 *
Àaf
;

3969 
båfs_fûe_exã¡_ôem
 *
fi
;

3970 
u64
 
exã¡_Àn
 = 0;

3971 
u32
 
ôem_size
;

3972 
ªt
;

3974 
Àaf
 = 
∑th
->
nodes
[0];

3975 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

3977 
	`BUG_ON
(
key
.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
 &&

3978 
key
.
ty≥
 !
BTRFS_EXTENT_CSUM_KEY
);

3980 i‡(
	`båfs_Àaf_‰ì_•a˚
(
Àaf
Ë>
ös_Àn
)

3983 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

3984 i‡(
key
.
ty≥
 =
BTRFS_EXTENT_DATA_KEY
) {

3985 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

3986 
båfs_fûe_exã¡_ôem
);

3987 
exã¡_Àn
 = 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
fi
);

3989 
	`båfs_ªÀa£_∑th
(
∑th
);

3991 
∑th
->
kìp_locks
 = 1;

3992 
∑th
->
£¨ch_f‹_•lô
 = 1;

3993 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, 0, 1);

3994 
∑th
->
£¨ch_f‹_•lô
 = 0;

3995 i‡(
ªt
 > 0)

3996 
ªt
 = -
EAGAIN
;

3997 i‡(
ªt
 < 0)

3998 
îr
;

4000 
ªt
 = -
EAGAIN
;

4001 
Àaf
 = 
∑th
->
nodes
[0];

4003 i‡(
ôem_size
 !
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]))

4004 
îr
;

4007 i‡(
	`båfs_Àaf_‰ì_•a˚
(
∑th
->
nodes
[0]Ë>
ös_Àn
)

4008 
îr
;

4010 i‡(
key
.
ty≥
 =
BTRFS_EXTENT_DATA_KEY
) {

4011 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

4012 
båfs_fûe_exã¡_ôem
);

4013 i‡(
exã¡_Àn
 !
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
fi
))

4014 
îr
;

4017 
ªt
 = 
	`•lô_Àaf
(
å™s
, 
roŸ
, &
key
, 
∑th
, 
ös_Àn
, 1);

4018 i‡(
ªt
)

4019 
îr
;

4021 
∑th
->
kìp_locks
 = 0;

4022 
	`båfs_u∆ock_up_ß„
(
∑th
, 1);

4024 
îr
:

4025 
∑th
->
kìp_locks
 = 0;

4026  
ªt
;

4027 
	}
}

4029 
noölöe
 
	$•lô_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

4030 
båfs_∑th
 *
∑th
,

4031 c⁄° 
båfs_key
 *
√w_key
,

4032 
•lô_off£t
)

4034 
exã¡_buf„r
 *
Àaf
;

4035 
‹ig_¶Ÿ
, 
¶Ÿ
;

4036 *
buf
;

4037 
u32
 
ƒôems
;

4038 
u32
 
ôem_size
;

4039 
u32
 
‹ig_off£t
;

4040 
båfs_disk_key
 
disk_key
;

4042 
Àaf
 = 
∑th
->
nodes
[0];

4047 i‡(
	`WARN_ON
(
	`båfs_Àaf_‰ì_•a˚
(
Àaf
Ë< (
båfs_ôem
)))

4048  -
ENOSPC
;

4050 
‹ig_¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

4051 
‹ig_off£t
 = 
	`båfs_ôem_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

4052 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

4054 
buf
 = 
	`kmÆloc
(
ôem_size
, 
GFP_NOFS
);

4055 i‡(!
buf
)

4056  -
ENOMEM
;

4058 
	`ªad_exã¡_buf„r
(
Àaf
, 
buf
, 
	`båfs_ôem_±r_off£t
(leaf,

4059 
∑th
->
¶Ÿs
[0]), 
ôem_size
);

4061 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0] + 1;

4062 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

4063 i‡(
¶Ÿ
 !
ƒôems
) {

4065 
	`memmove_Àaf_ôems
(
Àaf
, 
¶Ÿ
 + 1, slŸ, 
ƒôems
 - slot);

4068 
	`båfs_˝u_key_to_disk
(&
disk_key
, 
√w_key
);

4069 
	`båfs_£t_ôem_key
(
Àaf
, &
disk_key
, 
¶Ÿ
);

4071 
	`båfs_£t_ôem_off£t
(
Àaf
, 
¶Ÿ
, 
‹ig_off£t
);

4072 
	`båfs_£t_ôem_size
(
Àaf
, 
¶Ÿ
, 
ôem_size
 - 
•lô_off£t
);

4074 
	`båfs_£t_ôem_off£t
(
Àaf
, 
‹ig_¶Ÿ
,

4075 
‹ig_off£t
 + 
ôem_size
 - 
•lô_off£t
);

4076 
	`båfs_£t_ôem_size
(
Àaf
, 
‹ig_¶Ÿ
, 
•lô_off£t
);

4078 
	`båfs_£t_hódî_ƒôems
(
Àaf
, 
ƒôems
 + 1);

4081 
	`wrôe_exã¡_buf„r
(
Àaf
, 
buf
,

4082 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]),

4083 
•lô_off£t
);

4086 
	`wrôe_exã¡_buf„r
(
Àaf
, 
buf
 + 
•lô_off£t
,

4087 
	`båfs_ôem_±r_off£t
(
Àaf
, 
¶Ÿ
),

4088 
ôem_size
 - 
•lô_off£t
);

4089 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

4091 
	`BUG_ON
(
	`båfs_Àaf_‰ì_•a˚
(
Àaf
) < 0);

4092 
	`k‰ì
(
buf
);

4094 
	}
}

4111 
	$båfs_•lô_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

4112 
båfs_roŸ
 *
roŸ
,

4113 
båfs_∑th
 *
∑th
,

4114 c⁄° 
båfs_key
 *
√w_key
,

4115 
•lô_off£t
)

4117 
ªt
;

4118 
ªt
 = 
	`£tup_Àaf_f‹_•lô
(
å™s
, 
roŸ
, 
∑th
,

4119 (
båfs_ôem
));

4120 i‡(
ªt
)

4121  
ªt
;

4123 
ªt
 = 
	`•lô_ôem
(
å™s
, 
∑th
, 
√w_key
, 
•lô_off£t
);

4124  
ªt
;

4125 
	}
}

4133 
	$båfs_åunˇã_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

4134 
båfs_∑th
 *
∑th
, 
u32
 
√w_size
, 
‰om_íd
)

4136 
¶Ÿ
;

4137 
exã¡_buf„r
 *
Àaf
;

4138 
u32
 
ƒôems
;

4139 
d©a_íd
;

4140 
ﬁd_d©a_°¨t
;

4141 
ﬁd_size
;

4142 
size_diff
;

4143 
i
;

4144 
båfs_m≠_tokí
 
tokí
;

4146 
Àaf
 = 
∑th
->
nodes
[0];

4147 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

4149 
ﬁd_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

4150 i‡(
ﬁd_size
 =
√w_size
)

4153 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

4154 
d©a_íd
 = 
	`Àaf_d©a_íd
(
Àaf
);

4156 
ﬁd_d©a_°¨t
 = 
	`båfs_ôem_off£t
(
Àaf
, 
¶Ÿ
);

4158 
size_diff
 = 
ﬁd_size
 - 
√w_size
;

4160 
	`BUG_ON
(
¶Ÿ
 < 0);

4161 
	`BUG_ON
(
¶Ÿ
 >
ƒôems
);

4167 
	`båfs_öô_m≠_tokí
(&
tokí
, 
Àaf
);

4168 
i
 = 
¶Ÿ
; i < 
ƒôems
; i++) {

4169 
u32
 
ioff
;

4171 
ioff
 = 
	`båfs_tokí_ôem_off£t
(&
tokí
, 
i
);

4172 
	`båfs_£t_tokí_ôem_off£t
(&
tokí
, 
i
, 
ioff
 + 
size_diff
);

4176 i‡(
‰om_íd
) {

4177 
	`memmove_Àaf_d©a
(
Àaf
, 
d©a_íd
 + 
size_diff
, data_end,

4178 
ﬁd_d©a_°¨t
 + 
√w_size
 - 
d©a_íd
);

4180 
båfs_disk_key
 
disk_key
;

4181 
u64
 
off£t
;

4183 
	`båfs_ôem_key
(
Àaf
, &
disk_key
, 
¶Ÿ
);

4185 i‡(
	`båfs_disk_key_ty≥
(&
disk_key
Ë=
BTRFS_EXTENT_DATA_KEY
) {

4186 
±r
;

4187 
båfs_fûe_exã¡_ôem
 *
fi
;

4189 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
,

4190 
båfs_fûe_exã¡_ôem
);

4191 
fi
 = (
båfs_fûe_exã¡_ôem
 *)(

4192 ()
fi
 - 
size_diff
);

4194 i‡(
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
fi
) ==

4195 
BTRFS_FILE_EXTENT_INLINE
) {

4196 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
¶Ÿ
);

4197 
	`memmove_exã¡_buf„r
(
Àaf
, 
±r
,

4198 ()
fi
,

4199 
BTRFS_FILE_EXTENT_INLINE_DATA_START
);

4203 
	`memmove_Àaf_d©a
(
Àaf
, 
d©a_íd
 + 
size_diff
, data_end,

4204 
ﬁd_d©a_°¨t
 - 
d©a_íd
);

4206 
off£t
 = 
	`båfs_disk_key_off£t
(&
disk_key
);

4207 
	`båfs_£t_disk_key_off£t
(&
disk_key
, 
off£t
 + 
size_diff
);

4208 
	`båfs_£t_ôem_key
(
Àaf
, &
disk_key
, 
¶Ÿ
);

4209 i‡(
¶Ÿ
 == 0)

4210 
	`fixup_low_keys
(
å™s
, 
∑th
, &
disk_key
, 1);

4213 
	`båfs_£t_ôem_size
(
Àaf
, 
¶Ÿ
, 
√w_size
);

4214 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

4216 i‡(
	`båfs_Àaf_‰ì_•a˚
(
Àaf
) < 0) {

4217 
	`båfs_¥öt_Àaf
(
Àaf
);

4218 
	`BUG
();

4220 
	}
}

4225 
	$båfs_exãnd_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

4226 
båfs_∑th
 *
∑th
, 
u32
 
d©a_size
)

4228 
¶Ÿ
;

4229 
exã¡_buf„r
 *
Àaf
;

4230 
u32
 
ƒôems
;

4231 
d©a_íd
;

4232 
ﬁd_d©a
;

4233 
ﬁd_size
;

4234 
i
;

4235 
båfs_m≠_tokí
 
tokí
;

4237 
Àaf
 = 
∑th
->
nodes
[0];

4239 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

4240 
d©a_íd
 = 
	`Àaf_d©a_íd
(
Àaf
);

4242 i‡(
	`båfs_Àaf_‰ì_•a˚
(
Àaf
Ë< 
d©a_size
) {

4243 
	`båfs_¥öt_Àaf
(
Àaf
);

4244 
	`BUG
();

4246 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

4247 
ﬁd_d©a
 = 
	`båfs_ôem_d©a_íd
(
Àaf
, 
¶Ÿ
);

4249 
	`BUG_ON
(
¶Ÿ
 < 0);

4250 i‡(
¶Ÿ
 >
ƒôems
) {

4251 
	`båfs_¥öt_Àaf
(
Àaf
);

4252 
	`båfs_¸ô
(
Àaf
->
fs_öfo
, "slot %dÅooÜarge,Çritems %d",

4253 
¶Ÿ
, 
ƒôems
);

4254 
	`BUG
();

4261 
	`båfs_öô_m≠_tokí
(&
tokí
, 
Àaf
);

4262 
i
 = 
¶Ÿ
; i < 
ƒôems
; i++) {

4263 
u32
 
ioff
;

4265 
ioff
 = 
	`båfs_tokí_ôem_off£t
(&
tokí
, 
i
);

4266 
	`båfs_£t_tokí_ôem_off£t
(&
tokí
, 
i
, 
ioff
 - 
d©a_size
);

4270 
	`memmove_Àaf_d©a
(
Àaf
, 
d©a_íd
 - 
d©a_size
, data_end,

4271 
ﬁd_d©a
 - 
d©a_íd
);

4273 
d©a_íd
 = 
ﬁd_d©a
;

4274 
ﬁd_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

4275 
	`båfs_£t_ôem_size
(
Àaf
, 
¶Ÿ
, 
ﬁd_size
 + 
d©a_size
);

4276 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

4278 i‡(
	`båfs_Àaf_‰ì_•a˚
(
Àaf
) < 0) {

4279 
	`båfs_¥öt_Àaf
(
Àaf
);

4280 
	`BUG
();

4282 
	}
}

4295 
	$£tup_ôems_f‹_ö£π
(
båfs_å™s_h™dÀ
 *
å™s
,

4296 
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
,

4297 c⁄° 
båfs_ôem_b©ch
 *
b©ch
)

4299 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4300 
i
;

4301 
u32
 
ƒôems
;

4302 
d©a_íd
;

4303 
båfs_disk_key
 
disk_key
;

4304 
exã¡_buf„r
 *
Àaf
;

4305 
¶Ÿ
;

4306 
båfs_m≠_tokí
 
tokí
;

4307 
u32
 
tŸÆ_size
;

4314 i‡(
∑th
->
¶Ÿs
[0] == 0) {

4315 
	`båfs_˝u_key_to_disk
(&
disk_key
, &
b©ch
->
keys
[0]);

4316 
	`fixup_low_keys
(
å™s
, 
∑th
, &
disk_key
, 1);

4318 
	`båfs_u∆ock_up_ß„
(
∑th
, 1);

4320 
Àaf
 = 
∑th
->
nodes
[0];

4321 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

4323 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

4324 
d©a_íd
 = 
	`Àaf_d©a_íd
(
Àaf
);

4325 
tŸÆ_size
 = 
b©ch
->
tŸÆ_d©a_size
 + (b©ch->
ƒ
 * (
båfs_ôem
));

4327 i‡(
	`båfs_Àaf_‰ì_•a˚
(
Àaf
Ë< 
tŸÆ_size
) {

4328 
	`båfs_¥öt_Àaf
(
Àaf
);

4329 
	`båfs_¸ô
(
fs_öfo
, "notÉnough freespaceÇeed %u have %d",

4330 
tŸÆ_size
, 
	`båfs_Àaf_‰ì_•a˚
(
Àaf
));

4331 
	`BUG
();

4334 
	`båfs_öô_m≠_tokí
(&
tokí
, 
Àaf
);

4335 i‡(
¶Ÿ
 !
ƒôems
) {

4336 
ﬁd_d©a
 = 
	`båfs_ôem_d©a_íd
(
Àaf
, 
¶Ÿ
);

4338 i‡(
ﬁd_d©a
 < 
d©a_íd
) {

4339 
	`båfs_¥öt_Àaf
(
Àaf
);

4340 
	`båfs_¸ô
(
fs_öfo
,

4342 
¶Ÿ
, 
ﬁd_d©a
, 
d©a_íd
);

4343 
	`BUG
();

4349 
i
 = 
¶Ÿ
; i < 
ƒôems
; i++) {

4350 
u32
 
ioff
;

4352 
ioff
 = 
	`båfs_tokí_ôem_off£t
(&
tokí
, 
i
);

4353 
	`båfs_£t_tokí_ôem_off£t
(&
tokí
, 
i
,

4354 
ioff
 - 
b©ch
->
tŸÆ_d©a_size
);

4357 
	`memmove_Àaf_ôems
(
Àaf
, 
¶Ÿ
 + 
b©ch
->
ƒ
, slŸ, 
ƒôems
 - slot);

4360 
	`memmove_Àaf_d©a
(
Àaf
, 
d©a_íd
 - 
b©ch
->
tŸÆ_d©a_size
,

4361 
d©a_íd
, 
ﬁd_d©a
 - data_end);

4362 
d©a_íd
 = 
ﬁd_d©a
;

4366 
i
 = 0; i < 
b©ch
->
ƒ
; i++) {

4367 
	`båfs_˝u_key_to_disk
(&
disk_key
, &
b©ch
->
keys
[
i
]);

4368 
	`båfs_£t_ôem_key
(
Àaf
, &
disk_key
, 
¶Ÿ
 + 
i
);

4369 
d©a_íd
 -
b©ch
->
d©a_sizes
[
i
];

4370 
	`båfs_£t_tokí_ôem_off£t
(&
tokí
, 
¶Ÿ
 + 
i
, 
d©a_íd
);

4371 
	`båfs_£t_tokí_ôem_size
(&
tokí
, 
¶Ÿ
 + 
i
, 
b©ch
->
d©a_sizes
[i]);

4374 
	`båfs_£t_hódî_ƒôems
(
Àaf
, 
ƒôems
 + 
b©ch
->
ƒ
);

4375 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

4377 i‡(
	`båfs_Àaf_‰ì_•a˚
(
Àaf
) < 0) {

4378 
	`båfs_¥öt_Àaf
(
Àaf
);

4379 
	`BUG
();

4381 
	}
}

4392 
	$båfs_£tup_ôem_f‹_ö£π
(
båfs_å™s_h™dÀ
 *
å™s
,

4393 
båfs_roŸ
 *
roŸ
,

4394 
båfs_∑th
 *
∑th
,

4395 c⁄° 
båfs_key
 *
key
,

4396 
u32
 
d©a_size
)

4398 
båfs_ôem_b©ch
 
b©ch
;

4400 
b©ch
.
keys
 = 
key
;

4401 
b©ch
.
d©a_sizes
 = &
d©a_size
;

4402 
b©ch
.
tŸÆ_d©a_size
 = 
d©a_size
;

4403 
b©ch
.
ƒ
 = 1;

4405 
	`£tup_ôems_f‹_ö£π
(
å™s
, 
roŸ
, 
∑th
, &
b©ch
);

4406 
	}
}

4412 
	$båfs_ö£π_em±y_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

4413 
båfs_roŸ
 *
roŸ
,

4414 
båfs_∑th
 *
∑th
,

4415 c⁄° 
båfs_ôem_b©ch
 *
b©ch
)

4417 
ªt
 = 0;

4418 
¶Ÿ
;

4419 
u32
 
tŸÆ_size
;

4421 
tŸÆ_size
 = 
b©ch
->
tŸÆ_d©a_size
 + (b©ch->
ƒ
 * (
båfs_ôem
));

4422 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
b©ch
->
keys
[0], 
∑th
, 
tŸÆ_size
, 1);

4423 i‡(
ªt
 == 0)

4424  -
EEXIST
;

4425 i‡(
ªt
 < 0)

4426  
ªt
;

4428 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

4429 
	`BUG_ON
(
¶Ÿ
 < 0);

4431 
	`£tup_ôems_f‹_ö£π
(
å™s
, 
roŸ
, 
∑th
, 
b©ch
);

4433 
	}
}

4439 
	$båfs_ö£π_ôem
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
,

4440 c⁄° 
båfs_key
 *
˝u_key
, *
d©a
,

4441 
u32
 
d©a_size
)

4443 
ªt
 = 0;

4444 
båfs_∑th
 *
∑th
;

4445 
exã¡_buf„r
 *
Àaf
;

4446 
±r
;

4448 
∑th
 = 
	`båfs_Æloc_∑th
();

4449 i‡(!
∑th
)

4450  -
ENOMEM
;

4451 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, 
˝u_key
, 
d©a_size
);

4452 i‡(!
ªt
) {

4453 
Àaf
 = 
∑th
->
nodes
[0];

4454 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

4455 
	`wrôe_exã¡_buf„r
(
Àaf
, 
d©a
, 
±r
, 
d©a_size
);

4456 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

4458 
	`båfs_‰ì_∑th
(
∑th
);

4459  
ªt
;

4460 
	}
}

4470 
	$båfs_du∂iˇã_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

4471 
båfs_roŸ
 *
roŸ
,

4472 
båfs_∑th
 *
∑th
,

4473 c⁄° 
båfs_key
 *
√w_key
)

4475 
exã¡_buf„r
 *
Àaf
;

4476 
ªt
;

4477 
u32
 
ôem_size
;

4479 
Àaf
 = 
∑th
->
nodes
[0];

4480 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

4481 
ªt
 = 
	`£tup_Àaf_f‹_•lô
(
å™s
, 
roŸ
, 
∑th
,

4482 
ôem_size
 + (
båfs_ôem
));

4483 i‡(
ªt
)

4484  
ªt
;

4486 
∑th
->
¶Ÿs
[0]++;

4487 
	`båfs_£tup_ôem_f‹_ö£π
(
å™s
, 
roŸ
, 
∑th
, 
√w_key
, 
ôem_size
);

4488 
Àaf
 = 
∑th
->
nodes
[0];

4489 
	`mem˝y_exã¡_buf„r
(
Àaf
,

4490 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]),

4491 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0] - 1),

4492 
ôem_size
);

4494 
	}
}

4504 
	$båfs_dñ_±r
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
,

4505 
båfs_∑th
 *
∑th
, 
Àvñ
, 
¶Ÿ
)

4507 
exã¡_buf„r
 *
∑ª¡
 = 
∑th
->
nodes
[
Àvñ
];

4508 
u32
 
ƒôems
;

4509 
ªt
;

4511 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑ª¡
);

4512 i‡(
¶Ÿ
 !
ƒôems
 - 1) {

4513 i‡(
Àvñ
) {

4514 
ªt
 = 
	`båfs_åì_mod_log_ö£π_move
(
∑ª¡
, 
¶Ÿ
,

4515 
¶Ÿ
 + 1, 
ƒôems
 - slot - 1);

4516 i‡(
ªt
 < 0) {

4517 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4518  
ªt
;

4521 
	`memmove_exã¡_buf„r
(
∑ª¡
,

4522 
	`båfs_node_key_±r_off£t
(
∑ª¡
, 
¶Ÿ
),

4523 
	`båfs_node_key_±r_off£t
(
∑ª¡
, 
¶Ÿ
 + 1),

4524 (
båfs_key_±r
) *

4525 (
ƒôems
 - 
¶Ÿ
 - 1));

4526 } i‡(
Àvñ
) {

4527 
ªt
 = 
	`båfs_åì_mod_log_ö£π_key
(
∑ª¡
, 
¶Ÿ
,

4528 
BTRFS_MOD_LOG_KEY_REMOVE
);

4529 i‡(
ªt
 < 0) {

4530 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4531  
ªt
;

4535 
ƒôems
--;

4536 
	`båfs_£t_hódî_ƒôems
(
∑ª¡
, 
ƒôems
);

4537 i‡(
ƒôems
 =0 && 
∑ª¡
 =
roŸ
->
node
) {

4538 
	`BUG_ON
(
	`båfs_hódî_Àvñ
(
roŸ
->
node
) != 1);

4540 
	`båfs_£t_hódî_Àvñ
(
roŸ
->
node
, 0);

4541 } i‡(
¶Ÿ
 == 0) {

4542 
båfs_disk_key
 
disk_key
;

4544 
	`båfs_node_key
(
∑ª¡
, &
disk_key
, 0);

4545 
	`fixup_low_keys
(
å™s
, 
∑th
, &
disk_key
, 
Àvñ
 + 1);

4547 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑ª¡
);

4549 
	}
}

4561 
noölöe
 
	$båfs_dñ_Àaf
(
båfs_å™s_h™dÀ
 *
å™s
,

4562 
båfs_roŸ
 *
roŸ
,

4563 
båfs_∑th
 *
∑th
,

4564 
exã¡_buf„r
 *
Àaf
)

4566 
ªt
;

4568 
	`WARN_ON
(
	`båfs_hódî_gíî©i⁄
(
Àaf
Ë!
å™s
->
å™sid
);

4569 
ªt
 = 
	`båfs_dñ_±r
(
å™s
, 
roŸ
, 
∑th
, 1,Ö©h->
¶Ÿs
[1]);

4570 i‡(
ªt
 < 0)

4571  
ªt
;

4577 
	`båfs_u∆ock_up_ß„
(
∑th
, 0);

4579 
	`roŸ_sub_u£d
(
roŸ
, 
Àaf
->
Àn
);

4581 
	`©omic_öc
(&
Àaf
->
ªfs
);

4582 
	`båfs_‰ì_åì_block
(
å™s
, 
	`båfs_roŸ_id
(
roŸ
), 
Àaf
, 0, 1);

4583 
	`‰ì_exã¡_buf„r_°Æe
(
Àaf
);

4585 
	}
}

4590 
	$båfs_dñ_ôems
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
,

4591 
båfs_∑th
 *
∑th
, 
¶Ÿ
, 
ƒ
)

4593 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4594 
exã¡_buf„r
 *
Àaf
;

4595 
ªt
 = 0;

4596 
wªt
;

4597 
u32
 
ƒôems
;

4599 
Àaf
 = 
∑th
->
nodes
[0];

4600 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

4602 i‡(
¶Ÿ
 + 
ƒ
 !
ƒôems
) {

4603 c⁄° 
u32
 
œ°_off
 = 
	`båfs_ôem_off£t
(
Àaf
, 
¶Ÿ
 + 
ƒ
 - 1);

4604 c⁄° 
d©a_íd
 = 
	`Àaf_d©a_íd
(
Àaf
);

4605 
båfs_m≠_tokí
 
tokí
;

4606 
u32
 
dsize
 = 0;

4607 
i
;

4609 
i
 = 0; i < 
ƒ
; i++)

4610 
dsize
 +
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
 + 
i
);

4612 
	`memmove_Àaf_d©a
(
Àaf
, 
d©a_íd
 + 
dsize
, data_end,

4613 
œ°_off
 - 
d©a_íd
);

4615 
	`båfs_öô_m≠_tokí
(&
tokí
, 
Àaf
);

4616 
i
 = 
¶Ÿ
 + 
ƒ
; i < 
ƒôems
; i++) {

4617 
u32
 
ioff
;

4619 
ioff
 = 
	`båfs_tokí_ôem_off£t
(&
tokí
, 
i
);

4620 
	`båfs_£t_tokí_ôem_off£t
(&
tokí
, 
i
, 
ioff
 + 
dsize
);

4623 
	`memmove_Àaf_ôems
(
Àaf
, 
¶Ÿ
, slŸ + 
ƒ
, 
ƒôems
 - slot -Çr);

4625 
	`båfs_£t_hódî_ƒôems
(
Àaf
, 
ƒôems
 - 
ƒ
);

4626 
ƒôems
 -
ƒ
;

4629 i‡(
ƒôems
 == 0) {

4630 i‡(
Àaf
 =
roŸ
->
node
) {

4631 
	`båfs_£t_hódî_Àvñ
(
Àaf
, 0);

4633 
	`båfs_˛ór_buf„r_dúty
(
å™s
, 
Àaf
);

4634 
ªt
 = 
	`båfs_dñ_Àaf
(
å™s
, 
roŸ
, 
∑th
, 
Àaf
);

4635 i‡(
ªt
 < 0)

4636  
ªt
;

4639 
u£d
 = 
	`Àaf_•a˚_u£d
(
Àaf
, 0, 
ƒôems
);

4640 i‡(
¶Ÿ
 == 0) {

4641 
båfs_disk_key
 
disk_key
;

4643 
	`båfs_ôem_key
(
Àaf
, &
disk_key
, 0);

4644 
	`fixup_low_keys
(
å™s
, 
∑th
, &
disk_key
, 1);

4655 i‡(
u£d
 < 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
) / 3) {

4656 
u32
 
mö_push_•a˚
;

4662 
¶Ÿ
 = 
∑th
->
¶Ÿs
[1];

4663 
	`©omic_öc
(&
Àaf
->
ªfs
);

4668 
mö_push_•a˚
 = (
båfs_ôem
) +

4669 
	`båfs_ôem_size
(
Àaf
, 0);

4670 
wªt
 = 
	`push_Àaf_À·
(
å™s
, 
roŸ
, 
∑th
, 0,

4671 
mö_push_•a˚
, 1, (
u32
)-1);

4672 i‡(
wªt
 < 0 && wªà!-
ENOSPC
)

4673 
ªt
 = 
wªt
;

4675 i‡(
∑th
->
nodes
[0] =
Àaf
 &&

4676 
	`båfs_hódî_ƒôems
(
Àaf
)) {

4687 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

4688 
mö_push_•a˚
 = 
	`Àaf_•a˚_u£d
(
Àaf
, 0, 
ƒôems
);

4689 
wªt
 = 
	`push_Àaf_right
(
å™s
, 
roŸ
, 
∑th
, 0,

4690 
mö_push_•a˚
, 1, 0);

4691 i‡(
wªt
 < 0 && wªà!-
ENOSPC
)

4692 
ªt
 = 
wªt
;

4695 i‡(
	`båfs_hódî_ƒôems
(
Àaf
) == 0) {

4696 
∑th
->
¶Ÿs
[1] = 
¶Ÿ
;

4697 
ªt
 = 
	`båfs_dñ_Àaf
(
å™s
, 
roŸ
, 
∑th
, 
Àaf
);

4698 i‡(
ªt
 < 0)

4699  
ªt
;

4700 
	`‰ì_exã¡_buf„r
(
Àaf
);

4701 
ªt
 = 0;

4708 i‡(
∑th
->
nodes
[0] =
Àaf
)

4709 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

4710 
	`‰ì_exã¡_buf„r
(
Àaf
);

4713 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

4716  
ªt
;

4717 
	}
}

4738 
	$båfs_£¨ch_f‹w¨d
(
båfs_roŸ
 *
roŸ
, 
båfs_key
 *
mö_key
,

4739 
båfs_∑th
 *
∑th
,

4740 
u64
 
mö_å™s
)

4742 
exã¡_buf„r
 *
cur
;

4743 
båfs_key
 
found_key
;

4744 
¶Ÿ
;

4745 
§ë
;

4746 
u32
 
ƒôems
;

4747 
Àvñ
;

4748 
ªt
 = 1;

4749 
kìp_locks
 = 
∑th
->keep_locks;

4751 
	`ASSERT
(!
∑th
->
nowaô
);

4752 
∑th
->
kìp_locks
 = 1;

4753 
agaö
:

4754 
cur
 = 
	`båfs_ªad_lock_roŸ_node
(
roŸ
);

4755 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
cur
);

4756 
	`WARN_ON
(
∑th
->
nodes
[
Àvñ
]);

4757 
∑th
->
nodes
[
Àvñ
] = 
cur
;

4758 
∑th
->
locks
[
Àvñ
] = 
BTRFS_READ_LOCK
;

4760 i‡(
	`båfs_hódî_gíî©i⁄
(
cur
Ë< 
mö_å™s
) {

4761 
ªt
 = 1;

4762 
out
;

4765 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
cur
);

4766 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
cur
);

4767 
§ë
 = 
	`båfs_bö_£¨ch
(
cur
, 0, 
mö_key
, &
¶Ÿ
);

4768 i‡(
§ë
 < 0) {

4769 
ªt
 = 
§ë
;

4770 
out
;

4774 i‡(
Àvñ
 =
∑th
->
lowe°_Àvñ
) {

4775 i‡(
¶Ÿ
 >
ƒôems
)

4776 
föd_√xt_key
;

4777 
ªt
 = 0;

4778 
∑th
->
¶Ÿs
[
Àvñ
] = 
¶Ÿ
;

4779 
	`båfs_ôem_key_to_˝u
(
cur
, &
found_key
, 
¶Ÿ
);

4780 
out
;

4782 i‡(
§ë
 && 
¶Ÿ
 > 0)

4783 
¶Ÿ
--;

4788 
¶Ÿ
 < 
ƒôems
) {

4789 
u64
 
gí
;

4791 
gí
 = 
	`båfs_node_±r_gíî©i⁄
(
cur
, 
¶Ÿ
);

4792 i‡(
gí
 < 
mö_å™s
) {

4793 
¶Ÿ
++;

4798 
föd_√xt_key
:

4803 i‡(
¶Ÿ
 >
ƒôems
) {

4804 
∑th
->
¶Ÿs
[
Àvñ
] = 
¶Ÿ
;

4805 
§ë
 = 
	`båfs_föd_√xt_key
(
roŸ
, 
∑th
, 
mö_key
, 
Àvñ
,

4806 
mö_å™s
);

4807 i‡(
§ë
 == 0) {

4808 
	`båfs_ªÀa£_∑th
(
∑th
);

4809 
agaö
;

4811 
out
;

4815 
	`båfs_node_key_to_˝u
(
cur
, &
found_key
, 
¶Ÿ
);

4816 
∑th
->
¶Ÿs
[
Àvñ
] = 
¶Ÿ
;

4817 i‡(
Àvñ
 =
∑th
->
lowe°_Àvñ
) {

4818 
ªt
 = 0;

4819 
out
;

4821 
cur
 = 
	`båfs_ªad_node_¶Ÿ
(cur, 
¶Ÿ
);

4822 i‡(
	`IS_ERR
(
cur
)) {

4823 
ªt
 = 
	`PTR_ERR
(
cur
);

4824 
out
;

4827 
	`båfs_åì_ªad_lock
(
cur
);

4829 
∑th
->
locks
[
Àvñ
 - 1] = 
BTRFS_READ_LOCK
;

4830 
∑th
->
nodes
[
Àvñ
 - 1] = 
cur
;

4831 
	`u∆ock_up
(
∑th
, 
Àvñ
, 1, 0, 
NULL
);

4833 
out
:

4834 
∑th
->
kìp_locks
 = keep_locks;

4835 i‡(
ªt
 == 0) {

4836 
	`båfs_u∆ock_up_ß„
(
∑th
,Ö©h->
lowe°_Àvñ
 + 1);

4837 
	`mem˝y
(
mö_key
, &
found_key
, (found_key));

4839  
ªt
;

4840 
	}
}

4853 
	$båfs_föd_√xt_key
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
,

4854 
båfs_key
 *
key
, 
Àvñ
, 
u64
 
mö_å™s
)

4856 
¶Ÿ
;

4857 
exã¡_buf„r
 *
c
;

4859 
	`WARN_ON
(!
∑th
->
kìp_locks
 && !∑th->
skù_lockög
);

4860 
Àvñ
 < 
BTRFS_MAX_LEVEL
) {

4861 i‡(!
∑th
->
nodes
[
Àvñ
])

4864 
¶Ÿ
 = 
∑th
->
¶Ÿs
[
Àvñ
] + 1;

4865 
c
 = 
∑th
->
nodes
[
Àvñ
];

4866 
√xt
:

4867 i‡(
¶Ÿ
 >
	`båfs_hódî_ƒôems
(
c
)) {

4868 
ªt
;

4869 
‹ig_lowe°
;

4870 
båfs_key
 
cur_key
;

4871 i‡(
Àvñ
 + 1 >
BTRFS_MAX_LEVEL
 ||

4872 !
∑th
->
nodes
[
Àvñ
 + 1])

4875 i‡(
∑th
->
locks
[
Àvñ
 + 1] ||Ö©h->
skù_lockög
) {

4876 
Àvñ
++;

4880 
¶Ÿ
 = 
	`båfs_hódî_ƒôems
(
c
) - 1;

4881 i‡(
Àvñ
 == 0)

4882 
	`båfs_ôem_key_to_˝u
(
c
, &
cur_key
, 
¶Ÿ
);

4884 
	`båfs_node_key_to_˝u
(
c
, &
cur_key
, 
¶Ÿ
);

4886 
‹ig_lowe°
 = 
∑th
->
lowe°_Àvñ
;

4887 
	`båfs_ªÀa£_∑th
(
∑th
);

4888 
∑th
->
lowe°_Àvñ
 = 
Àvñ
;

4889 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
cur_key
, 
∑th
,

4891 
∑th
->
lowe°_Àvñ
 = 
‹ig_lowe°
;

4892 i‡(
ªt
 < 0)

4893  
ªt
;

4895 
c
 = 
∑th
->
nodes
[
Àvñ
];

4896 
¶Ÿ
 = 
∑th
->
¶Ÿs
[
Àvñ
];

4897 i‡(
ªt
 == 0)

4898 
¶Ÿ
++;

4899 
√xt
;

4902 i‡(
Àvñ
 == 0)

4903 
	`båfs_ôem_key_to_˝u
(
c
, 
key
, 
¶Ÿ
);

4905 
u64
 
gí
 = 
	`båfs_node_±r_gíî©i⁄
(
c
, 
¶Ÿ
);

4907 i‡(
gí
 < 
mö_å™s
) {

4908 
¶Ÿ
++;

4909 
√xt
;

4911 
	`båfs_node_key_to_˝u
(
c
, 
key
, 
¶Ÿ
);

4916 
	}
}

4918 
	$båfs_√xt_ﬁd_Àaf
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
,

4919 
u64
 
time_£q
)

4921 
¶Ÿ
;

4922 
Àvñ
;

4923 
exã¡_buf„r
 *
c
;

4924 
exã¡_buf„r
 *
√xt
;

4925 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4926 
båfs_key
 
key
;

4927 
boﬁ
 
√ed_commô_£m
 = 
Ál£
;

4928 
u32
 
ƒôems
;

4929 
ªt
;

4930 
i
;

4936 i‡(
time_£q
)

4937 
	`ASSERT
(!
∑th
->
nowaô
);

4939 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0]);

4940 i‡(
ƒôems
 == 0)

4943 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
, 
ƒôems
 - 1);

4944 
agaö
:

4945 
Àvñ
 = 1;

4946 
√xt
 = 
NULL
;

4947 
	`båfs_ªÀa£_∑th
(
∑th
);

4949 
∑th
->
kìp_locks
 = 1;

4951 i‡(
time_£q
) {

4952 
ªt
 = 
	`båfs_£¨ch_ﬁd_¶Ÿ
(
roŸ
, &
key
, 
∑th
, 
time_£q
);

4954 i‡(
∑th
->
√ed_commô_£m
) {

4955 
∑th
->
√ed_commô_£m
 = 0;

4956 
√ed_commô_£m
 = 
åue
;

4957 i‡(
∑th
->
nowaô
) {

4958 i‡(!
	`down_ªad_åylock
(&
fs_öfo
->
commô_roŸ_£m
)) {

4959 
ªt
 = -
EAGAIN
;

4960 
d⁄e
;

4963 
	`down_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

4966 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

4968 
∑th
->
kìp_locks
 = 0;

4970 i‡(
ªt
 < 0)

4971 
d⁄e
;

4973 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0]);

4980 i‡(
ƒôems
 > 0 && 
∑th
->
¶Ÿs
[0] <Çritems - 1) {

4981 i‡(
ªt
 == 0)

4982 
∑th
->
¶Ÿs
[0]++;

4983 
ªt
 = 0;

4984 
d⁄e
;

5000 i‡(
ƒôems
 > 0 && 
ªt
 > 0 && 
∑th
->
¶Ÿs
[0] ==Çritems - 1) {

5001 
ªt
 = 0;

5002 
d⁄e
;

5005 
Àvñ
 < 
BTRFS_MAX_LEVEL
) {

5006 i‡(!
∑th
->
nodes
[
Àvñ
]) {

5007 
ªt
 = 1;

5008 
d⁄e
;

5011 
¶Ÿ
 = 
∑th
->
¶Ÿs
[
Àvñ
] + 1;

5012 
c
 = 
∑th
->
nodes
[
Àvñ
];

5013 i‡(
¶Ÿ
 >
	`båfs_hódî_ƒôems
(
c
)) {

5014 
Àvñ
++;

5015 i‡(
Àvñ
 =
BTRFS_MAX_LEVEL
) {

5016 
ªt
 = 1;

5017 
d⁄e
;

5028 
i
 = 0; i < 
Àvñ
; i++) {

5029 i‡(
∑th
->
locks
[
Àvñ
]) {

5030 
	`båfs_åì_ªad_u∆ock
(
∑th
->
nodes
[
i
]);

5031 
∑th
->
locks
[
i
] = 0;

5033 
	`‰ì_exã¡_buf„r
(
∑th
->
nodes
[
i
]);

5034 
∑th
->
nodes
[
i
] = 
NULL
;

5037 
√xt
 = 
c
;

5038 
ªt
 = 
	`ªad_block_f‹_£¨ch
(
roŸ
, 
∑th
, &
√xt
, 
Àvñ
,

5039 
¶Ÿ
, &
key
);

5040 i‡(
ªt
 =-
EAGAIN
 && !
∑th
->
nowaô
)

5041 
agaö
;

5043 i‡(
ªt
 < 0) {

5044 
	`båfs_ªÀa£_∑th
(
∑th
);

5045 
d⁄e
;

5048 i‡(!
∑th
->
skù_lockög
) {

5049 
ªt
 = 
	`båfs_åy_åì_ªad_lock
(
√xt
);

5050 i‡(!
ªt
 && 
∑th
->
nowaô
) {

5051 
ªt
 = -
EAGAIN
;

5052 
d⁄e
;

5054 i‡(!
ªt
 && 
time_£q
) {

5062 
	`‰ì_exã¡_buf„r
(
√xt
);

5063 
	`båfs_ªÀa£_∑th
(
∑th
);

5064 
	`c⁄d_ªsched
();

5065 
agaö
;

5067 i‡(!
ªt
)

5068 
	`båfs_åì_ªad_lock
(
√xt
);

5072 
∑th
->
¶Ÿs
[
Àvñ
] = 
¶Ÿ
;

5074 
Àvñ
--;

5075 
∑th
->
nodes
[
Àvñ
] = 
√xt
;

5076 
∑th
->
¶Ÿs
[
Àvñ
] = 0;

5077 i‡(!
∑th
->
skù_lockög
)

5078 
∑th
->
locks
[
Àvñ
] = 
BTRFS_READ_LOCK
;

5079 i‡(!
Àvñ
)

5082 
ªt
 = 
	`ªad_block_f‹_£¨ch
(
roŸ
, 
∑th
, &
√xt
, 
Àvñ
,

5083 0, &
key
);

5084 i‡(
ªt
 =-
EAGAIN
 && !
∑th
->
nowaô
)

5085 
agaö
;

5087 i‡(
ªt
 < 0) {

5088 
	`båfs_ªÀa£_∑th
(
∑th
);

5089 
d⁄e
;

5092 i‡(!
∑th
->
skù_lockög
) {

5093 i‡(
∑th
->
nowaô
) {

5094 i‡(!
	`båfs_åy_åì_ªad_lock
(
√xt
)) {

5095 
ªt
 = -
EAGAIN
;

5096 
d⁄e
;

5099 
	`båfs_åì_ªad_lock
(
√xt
);

5103 
ªt
 = 0;

5104 
d⁄e
:

5105 
	`u∆ock_up
(
∑th
, 0, 1, 0, 
NULL
);

5106 i‡(
√ed_commô_£m
) {

5107 
ªt2
;

5109 
∑th
->
√ed_commô_£m
 = 1;

5110 
ªt2
 = 
	`föish_√ed_commô_£m_£¨ch
(
∑th
);

5111 
	`up_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

5112 i‡(
ªt2
)

5113 
ªt
 = 
ªt2
;

5116  
ªt
;

5117 
	}
}

5119 
	$båfs_√xt_ﬁd_ôem
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
, 
u64
 
time_£q
)

5121 
∑th
->
¶Ÿs
[0]++;

5122 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
’©h->
nodes
[0]))

5123  
	`båfs_√xt_ﬁd_Àaf
(
roŸ
, 
∑th
, 
time_£q
);

5125 
	}
}

5133 
	$båfs_¥evious_ôem
(
båfs_roŸ
 *
roŸ
,

5134 
båfs_∑th
 *
∑th
, 
u64
 
mö_obje˘id
,

5135 
ty≥
)

5137 
båfs_key
 
found_key
;

5138 
exã¡_buf„r
 *
Àaf
;

5139 
u32
 
ƒôems
;

5140 
ªt
;

5143 i‡(
∑th
->
¶Ÿs
[0] == 0) {

5144 
ªt
 = 
	`båfs_¥ev_Àaf
(
roŸ
, 
∑th
);

5145 i‡(
ªt
 != 0)

5146  
ªt
;

5148 
∑th
->
¶Ÿs
[0]--;

5150 
Àaf
 = 
∑th
->
nodes
[0];

5151 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

5152 i‡(
ƒôems
 == 0)

5154 i‡(
∑th
->
¶Ÿs
[0] =
ƒôems
)

5155 
∑th
->
¶Ÿs
[0]--;

5157 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0]);

5158 i‡(
found_key
.
obje˘id
 < 
mö_obje˘id
)

5160 i‡(
found_key
.
ty≥
 ==Åype)

5162 i‡(
found_key
.
obje˘id
 =
mö_obje˘id
 &&

5163 
found_key
.
ty≥
 <Åype)

5167 
	}
}

5175 
	$båfs_¥evious_exã¡_ôem
(
båfs_roŸ
 *
roŸ
,

5176 
båfs_∑th
 *
∑th
, 
u64
 
mö_obje˘id
)

5178 
båfs_key
 
found_key
;

5179 
exã¡_buf„r
 *
Àaf
;

5180 
u32
 
ƒôems
;

5181 
ªt
;

5184 i‡(
∑th
->
¶Ÿs
[0] == 0) {

5185 
ªt
 = 
	`båfs_¥ev_Àaf
(
roŸ
, 
∑th
);

5186 i‡(
ªt
 != 0)

5187  
ªt
;

5189 
∑th
->
¶Ÿs
[0]--;

5191 
Àaf
 = 
∑th
->
nodes
[0];

5192 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

5193 i‡(
ƒôems
 == 0)

5195 i‡(
∑th
->
¶Ÿs
[0] =
ƒôems
)

5196 
∑th
->
¶Ÿs
[0]--;

5198 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0]);

5199 i‡(
found_key
.
obje˘id
 < 
mö_obje˘id
)

5201 i‡(
found_key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 ||

5202 
found_key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
)

5204 i‡(
found_key
.
obje˘id
 =
mö_obje˘id
 &&

5205 
found_key
.
ty≥
 < 
BTRFS_EXTENT_ITEM_KEY
)

5209 
	}
}

5211 
__öô
 
	$båfs_˘ªe_öô
()

5213 
båfs_∑th_ˇchï
 = 
	`kmem_ˇche_¸óã
("btrfs_path",

5214 (
båfs_∑th
), 0,

5215 
SLAB_MEM_SPREAD
, 
NULL
);

5216 i‡(!
båfs_∑th_ˇchï
)

5217  -
ENOMEM
;

5219 
	}
}

5221 
__cﬁd
 
	$båfs_˘ªe_exô
()

5223 
	`kmem_ˇche_de°roy
(
båfs_∑th_ˇchï
);

5224 
	}
}

	@ctree.h

6 #i‚de‡
BTRFS_CTREE_H


7 
	#BTRFS_CTREE_H


	)

9 
	~<löux/mm.h
>

10 
	~<löux/sched/sig«l.h
>

11 
	~<löux/highmem.h
>

12 
	~<löux/fs.h
>

13 
	~<löux/rw£m.h
>

14 
	~<löux/£m≠h‹e.h
>

15 
	~<löux/com∂ëi⁄.h
>

16 
	~<löux/backög-dev.h
>

17 
	~<löux/waô.h
>

18 
	~<löux/¶ab.h
>

19 
	~<åa˚/evíts/båfs.h
>

20 
	~<asm/u«lig√d.h
>

21 
	~<löux/∑gem≠.h
>

22 
	~<löux/båfs.h
>

23 
	~<löux/båfs_åì.h
>

24 
	~<löux/w‹kqueue.h
>

25 
	~<löux/£curôy.h
>

26 
	~<löux/sizes.h
>

27 
	~<löux/dy«mic_debug.h
>

28 
	~<löux/ªfcou¡.h
>

29 
	~<löux/¸c32c.h
>

30 
	~<löux/iom≠.h
>

31 
	~<löux/fs¸y±.h
>

32 
	~"exã¡-io-åì.h
"

33 
	~"exã¡_io.h
"

34 
	~"exã¡_m≠.h
"

35 
	~"async-thªad.h
"

36 
	~"block-rsv.h
"

37 
	~"lockög.h
"

38 
	~"misc.h
"

39 
	~"fs.h
"

41 
	gbåfs_å™s_h™dÀ
;

42 
	gbåfs_å™ß˘i⁄
;

43 
	gbåfs_≥ndög_¢≠shŸ
;

44 
	gbåfs_dñayed_ªf_roŸ
;

45 
	gbåfs_•a˚_öfo
;

46 
	gbåfs_block_group
;

47 
	gbåfs_‹dîed_sum
;

48 
	gbåfs_ªf
;

49 
	gbåfs_bio
;

50 
	gbåfs_io˘l_ícoded_io_¨gs
;

51 
	gbåfs_devi˚
;

52 
	gbåfs_fs_devi˚s
;

53 
	gbåfs_bÆ™˚_c⁄åﬁ
;

54 
	gbåfs_dñayed_roŸ
;

55 
	gªloc_c⁄åﬁ
;

59 
	mREADA_NONE
,

60 
	mREADA_BACK
,

61 
	mREADA_FORWARD
,

75 
	mREADA_FORWARD_ALWAYS
,

86 
	sbåfs_∑th
 {

87 
exã¡_buf„r
 *
	mnodes
[
BTRFS_MAX_LEVEL
];

88 
	m¶Ÿs
[
BTRFS_MAX_LEVEL
];

90 
u8
 
	mlocks
[
BTRFS_MAX_LEVEL
];

91 
u8
 
	mªada
;

93 
u8
 
	mlowe°_Àvñ
;

99 
	m£¨ch_f‹_•lô
:1;

100 
	mkìp_locks
:1;

101 
	mskù_lockög
:1;

102 
	m£¨ch_commô_roŸ
:1;

103 
	m√ed_commô_£m
:1;

104 
	mskù_ªÀa£_⁄_îr‹
:1;

110 
	m£¨ch_f‹_exãnsi⁄
:1;

112 
	mnowaô
:1;

125 
	mBTRFS_ROOT_IN_TRANS_SETUP
,

147 
	mBTRFS_ROOT_SHAREABLE
,

148 
	mBTRFS_ROOT_TRACK_DIRTY
,

149 
	mBTRFS_ROOT_IN_RADIX
,

150 
	mBTRFS_ROOT_ORPHAN_ITEM_INSERTED
,

151 
	mBTRFS_ROOT_DEFRAG_RUNNING
,

152 
	mBTRFS_ROOT_FORCE_COW
,

153 
	mBTRFS_ROOT_MULTI_LOG_TASKS
,

154 
	mBTRFS_ROOT_DIRTY
,

155 
	mBTRFS_ROOT_DELETING
,

162 
	mBTRFS_ROOT_DEAD_RELOC_TREE
,

164 
	mBTRFS_ROOT_DEAD_TREE
,

166 
	mBTRFS_ROOT_HAS_LOG_TREE
,

168 
	mBTRFS_ROOT_QGROUP_FLUSHING
,

170 
	mBTRFS_ROOT_ORPHAN_CLEANUP
,

172 
	mBTRFS_ROOT_UNFINISHED_DROP
,

174 
	mBTRFS_ROOT_RESET_LOCKDEP_CLASS
,

181 
	sbåfs_qgroup_sw≠≥d_blocks
 {

182 
•ölock_t
 
	mlock
;

184 
boﬁ
 
	msw≠≥d
;

185 
rb_roŸ
 
	mblocks
[
BTRFS_MAX_LEVEL
];

192 
	sbåfs_roŸ
 {

193 
rb_node
 
	mrb_node
;

195 
exã¡_buf„r
 *
	mnode
;

197 
exã¡_buf„r
 *
	mcommô_roŸ
;

198 
båfs_roŸ
 *
	mlog_roŸ
;

199 
båfs_roŸ
 *
	mªloc_roŸ
;

201 
	m°©e
;

202 
båfs_roŸ_ôem
 
	mroŸ_ôem
;

203 
båfs_key
 
	mroŸ_key
;

204 
båfs_fs_öfo
 *
	mfs_öfo
;

205 
exã¡_io_åì
 
	mdúty_log_∑ges
;

207 
muãx
 
	mobje˘id_muãx
;

209 
•ölock_t
 
	maccou¡ög_lock
;

210 
båfs_block_rsv
 *
	mblock_rsv
;

212 
muãx
 
	mlog_muãx
;

213 
waô_queue_hód_t
 
	mlog_wrôî_waô
;

214 
waô_queue_hód_t
 
	mlog_commô_waô
[2];

215 
li°_hód
 
	mlog_˘xs
[2];

217 
©omic_t
 
	mlog_wrôîs
;

218 
©omic_t
 
	mlog_commô
[2];

220 
©omic_t
 
	mlog_b©ch
;

221 
	mlog_å™sid
;

223 
	mlog_å™sid_commôãd
;

225 
	mœ°_log_commô
;

226 
pid_t
 
	mlog_°¨t_pid
;

228 
u64
 
	mœ°_å™s
;

230 
u32
 
	mty≥
;

232 
u64
 
	m‰ì_obje˘id
;

234 
båfs_key
 
	mde‰ag_¥ogªss
;

235 
båfs_key
 
	mde‰ag_max
;

238 
li°_hód
 
	mdúty_li°
;

240 
li°_hód
 
	mroŸ_li°
;

242 
•ölock_t
 
	mlog_exã¡s_lock
[2];

243 
li°_hód
 
	mlogged_li°
[2];

245 
•ölock_t
 
	möode_lock
;

247 
rb_roŸ
 
	möode_åì
;

253 
ødix_åì_roŸ
 
	mdñayed_nodes_åì
;

258 
dev_t
 
	m™⁄_dev
;

260 
•ölock_t
 
	mroŸ_ôem_lock
;

261 
ªfcou¡_t
 
	mªfs
;

263 
muãx
 
	mdñÆloc_muãx
;

264 
•ölock_t
 
	mdñÆloc_lock
;

270 
li°_hód
 
	mdñÆloc_öodes
;

271 
li°_hód
 
	mdñÆloc_roŸ
;

272 
u64
 
	mƒ_dñÆloc_öodes
;

274 
muãx
 
	m‹dîed_exã¡_muãx
;

279 
•ölock_t
 
	m‹dîed_exã¡_lock
;

286 
li°_hód
 
	m‹dîed_exã¡s
;

287 
li°_hód
 
	m‹dîed_roŸ
;

288 
u64
 
	mƒ_‹dîed_exã¡s
;

296 
li°_hód
 
	mªloc_dúty_li°
;

302 
	m£nd_ö_¥ogªss
;

308 
	mdedu≥_ö_¥ogªss
;

310 
båfs_dªw_lock
 
	m¢≠shŸ_lock
;

312 
©omic_t
 
	m¢≠shŸ_f‹˚_cow
;

315 
•ölock_t
 
	mqgroup_mëa_rsv_lock
;

316 
u64
 
	mqgroup_mëa_rsv_≥πøns
;

317 
u64
 
	mqgroup_mëa_rsv_¥óŒoc
;

318 
waô_queue_hód_t
 
	mqgroup_Êush_waô
;

321 
©omic_t
 
	mƒ_sw≠fûes
;

324 
båfs_qgroup_sw≠≥d_blocks
 
	msw≠≥d_blocks
;

327 
exã¡_io_åì
 
	mlog_csum_ønge
;

329 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


330 
u64
 
	mÆloc_byãƒ
;

333 #ifde‡
CONFIG_BTRFS_DEBUG


334 
li°_hód
 
	mÀak_li°
;

338 
ölöe
 
boﬁ
 
	$båfs_roŸ_ªad⁄ly
(c⁄° 
båfs_roŸ
 *
roŸ
)

341  (
roŸ
->
roŸ_ôem
.
Êags
 & 
	`˝u_to_À64
(
BTRFS_ROOT_SUBVOL_RDONLY
)) != 0;

342 
	}
}

344 
ölöe
 
boﬁ
 
	$båfs_roŸ_dód
(c⁄° 
båfs_roŸ
 *
roŸ
)

347  (
roŸ
->
roŸ_ôem
.
Êags
 & 
	`˝u_to_À64
(
BTRFS_ROOT_SUBVOL_DEAD
)) != 0;

348 
	}
}

350 
ölöe
 
u64
 
	$båfs_roŸ_id
(c⁄° 
båfs_roŸ
 *
roŸ
)

352  
roŸ
->
roŸ_key
.
obje˘id
;

353 
	}
}

359 
	sbåfs_ª∂a˚_exã¡_öfo
 {

360 
u64
 
	mdisk_off£t
;

361 
u64
 
	mdisk_Àn
;

362 
u64
 
	md©a_off£t
;

363 
u64
 
	md©a_Àn
;

364 
u64
 
	mfûe_off£t
;

366 *
	mexã¡_buf
;

372 
boﬁ
 
	mis_√w_exã¡
;

374 
boﬁ
 
	mupd©e_times
;

376 
	mqgroup_ª£rved
;

384 
	mö£πi⁄s
;

388 
	sbåfs_dr›_exã¡s_¨gs
 {

398 
båfs_∑th
 *
	m∑th
;

400 
u64
 
	m°¨t
;

402 
u64
 
	míd
;

404 
boﬁ
 
	mdr›_ˇche
;

413 
boﬁ
 
	mª∂a˚_exã¡
;

418 
u32
 
	mexã¡_ôem_size
;

427 
u64
 
	mdr›_íd
;

432 
u64
 
	mbyãs_found
;

441 
boﬁ
 
	mexã¡_ö£πed
;

444 
	sbåfs_fûe_¥iv©e
 {

445 *
	mfûldú_buf
;

446 
u64
 
	mœ°_ödex
;

447 
exã¡_°©e
 *
	mŒ£ek_ˇched_°©e
;

450 
ölöe
 
u32
 
	$BTRFS_LEAF_DATA_SIZE
(c⁄° 
båfs_fs_öfo
 *
öfo
)

452  
öfo
->
nodesize
 - (
båfs_hódî
);

453 
	}
}

455 
ölöe
 
u32
 
	$BTRFS_MAX_ITEM_SIZE
(c⁄° 
båfs_fs_öfo
 *
öfo
)

457  
	`BTRFS_LEAF_DATA_SIZE
(
öfo
Ë- (
båfs_ôem
);

458 
	}
}

460 
ölöe
 
u32
 
	$BTRFS_NODEPTRS_PER_BLOCK
(c⁄° 
båfs_fs_öfo
 *
öfo
)

462  
	`BTRFS_LEAF_DATA_SIZE
(
öfo
Ë/ (
båfs_key_±r
);

463 
	}
}

465 
ölöe
 
u32
 
	$BTRFS_MAX_XATTR_SIZE
(c⁄° 
båfs_fs_öfo
 *
öfo
)

467  
	`BTRFS_MAX_ITEM_SIZE
(
öfo
Ë- (
båfs_dú_ôem
);

468 
	}
}

470 
	#BTRFS_BYTES_TO_BLKS
(
fs_öfo
, 
byãs
) \

471 ((
byãs
Ë>> (
fs_öfo
)->
£˘‹size_bôs
)

	)

473 
ölöe
 
u32
 
	$båfs_¸c32c
(
u32
 
¸c
, c⁄° *
addªss
, 
Àngth
)

475  
	`¸c32c
(
¸c
, 
addªss
, 
Àngth
);

476 
	}
}

478 
ölöe
 
	$båfs_¸c32c_föÆ
(
u32
 
¸c
, 
u8
 *
ªsu…
)

480 
	`put_u«lig√d_À32
(~
¸c
, 
ªsu…
);

481 
	}
}

483 
ölöe
 
u64
 
	$båfs_«me_hash
(c⁄° *
«me
, 
Àn
)

485  
	`¸c32c
((
u32
)~1, 
«me
, 
Àn
);

486 
	}
}

491 
ölöe
 
u64
 
	$båfs_exåef_hash
(
u64
 
∑ª¡_obje˘id
, c⁄° *
«me
,

492 
Àn
)

494  (
u64
Ë
	`¸c32c
(
∑ª¡_obje˘id
, 
«me
, 
Àn
);

495 
	}
}

497 
ölöe
 
gÂ_t
 
	$båfs_Æloc_wrôe_mask
(
addªss_•a˚
 *
m≠pög
)

499  
	`m≠pög_gÂ_c⁄°øöt
(
m≠pög
, ~
__GFP_FS
);

500 
	}
}

502 
båfs_îr‹_u≈ö_exã¡_ønge
(
båfs_fs_öfo
 *
fs_öfo
,

503 
u64
 
°¨t
, u64 
íd
);

504 
båfs_disˇrd_exã¡
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
byãƒ
,

505 
u64
 
num_byãs
, u64 *
a˘uÆ_byãs
);

506 
båfs_åim_fs
(
båfs_fs_öfo
 *
fs_öfo
, 
f°rim_ønge
 *
ønge
);

509 
__öô
 
båfs_˘ªe_öô
();

510 
__cﬁd
 
båfs_˘ªe_exô
();

512 
båfs_bö_£¨ch
(
exã¡_buf„r
 *
eb
, 
fú°_¶Ÿ
,

513 c⁄° 
båfs_key
 *
key
, *
¶Ÿ
);

515 
__puª
 
båfs_comp_˝u_keys
(c⁄° 
båfs_key
 *
k1
, c⁄° båfs_key *
k2
);

516 
båfs_¥evious_ôem
(
båfs_roŸ
 *
roŸ
,

517 
båfs_∑th
 *
∑th
, 
u64
 
mö_obje˘id
,

518 
ty≥
);

519 
båfs_¥evious_exã¡_ôem
(
båfs_roŸ
 *
roŸ
,

520 
båfs_∑th
 *
∑th
, 
u64
 
mö_obje˘id
);

521 
båfs_£t_ôem_key_ß„
(
båfs_å™s_h™dÀ
 *
å™s
,

522 
båfs_∑th
 *
∑th
,

523 c⁄° 
båfs_key
 *
√w_key
);

524 
exã¡_buf„r
 *
båfs_roŸ_node
(
båfs_roŸ
 *
roŸ
);

525 
båfs_föd_√xt_key
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
,

526 
båfs_key
 *
key
, 
lowe°_Àvñ
,

527 
u64
 
mö_å™s
);

528 
båfs_£¨ch_f‹w¨d
(
båfs_roŸ
 *
roŸ
, 
båfs_key
 *
mö_key
,

529 
båfs_∑th
 *
∑th
,

530 
u64
 
mö_å™s
);

531 
exã¡_buf„r
 *
båfs_ªad_node_¶Ÿ
(exã¡_buf„∏*
∑ª¡
,

532 
¶Ÿ
);

534 
båfs_cow_block
(
båfs_å™s_h™dÀ
 *
å™s
,

535 
båfs_roŸ
 *
roŸ
, 
exã¡_buf„r
 *
buf
,

536 
exã¡_buf„r
 *
∑ª¡
, 
∑ª¡_¶Ÿ
,

537 
exã¡_buf„r
 **
cow_ªt
,

538 
båfs_lock_√°ög
 
√°
);

539 
båfs_c›y_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

540 
båfs_roŸ
 *
roŸ
,

541 
exã¡_buf„r
 *
buf
,

542 
exã¡_buf„r
 **
cow_ªt
, 
u64
 
√w_roŸ_obje˘id
);

543 
båfs_block_ˇn_be_sh¨ed
(
båfs_å™s_h™dÀ
 *
å™s
,

544 
båfs_roŸ
 *
roŸ
,

545 
exã¡_buf„r
 *
buf
);

546 
båfs_dñ_±r
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
,

547 
båfs_∑th
 *
∑th
, 
Àvñ
, 
¶Ÿ
);

548 
båfs_exãnd_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

549 
båfs_∑th
 *
∑th
, 
u32
 
d©a_size
);

550 
båfs_åunˇã_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

551 
båfs_∑th
 *
∑th
, 
u32
 
√w_size
, 
‰om_íd
);

552 
båfs_•lô_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

553 
båfs_roŸ
 *
roŸ
,

554 
båfs_∑th
 *
∑th
,

555 c⁄° 
båfs_key
 *
√w_key
,

556 
•lô_off£t
);

557 
båfs_du∂iˇã_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

558 
båfs_roŸ
 *
roŸ
,

559 
båfs_∑th
 *
∑th
,

560 c⁄° 
båfs_key
 *
√w_key
);

561 
båfs_föd_ôem
(
båfs_roŸ
 *
fs_roŸ
, 
båfs_∑th
 *
∑th
,

562 
u64
 
öum
, u64 
ioff
, 
u8
 
key_ty≥
, 
båfs_key
 *
found_key
);

563 
båfs_£¨ch_¶Ÿ
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
,

564 c⁄° 
båfs_key
 *
key
, 
båfs_∑th
 *
p
,

565 
ös_Àn
, 
cow
);

566 
båfs_£¨ch_ﬁd_¶Ÿ
(
båfs_roŸ
 *
roŸ
, c⁄° 
båfs_key
 *
key
,

567 
båfs_∑th
 *
p
, 
u64
 
time_£q
);

568 
båfs_£¨ch_¶Ÿ_f‹_ªad
(
båfs_roŸ
 *
roŸ
,

569 c⁄° 
båfs_key
 *
key
,

570 
båfs_∑th
 *
p
, 
föd_highî
,

571 
ªtu∫_™y
);

572 
båfs_ªÆloc_node
(
båfs_å™s_h™dÀ
 *
å™s
,

573 
båfs_roŸ
 *
roŸ
, 
exã¡_buf„r
 *
∑ª¡
,

574 
°¨t_¶Ÿ
, 
u64
 *
œ°_ªt
,

575 
båfs_key
 *
¥ogªss
);

576 
båfs_ªÀa£_∑th
(
båfs_∑th
 *
p
);

577 
båfs_∑th
 *
båfs_Æloc_∑th
();

578 
båfs_‰ì_∑th
(
båfs_∑th
 *
p
);

580 
båfs_dñ_ôems
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
,

581 
båfs_∑th
 *
∑th
, 
¶Ÿ
, 
ƒ
);

582 
ölöe
 
	$båfs_dñ_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

583 
båfs_roŸ
 *
roŸ
,

584 
båfs_∑th
 *
∑th
)

586  
	`båfs_dñ_ôems
(
å™s
, 
roŸ
, 
∑th
,Ö©h->
¶Ÿs
[0], 1);

587 
	}
}

593 
	sbåfs_ôem_b©ch
 {

598 c⁄° 
båfs_key
 *
	mkeys
;

600 c⁄° 
u32
 *
	md©a_sizes
;

610 
u32
 
	mtŸÆ_d©a_size
;

612 
	mƒ
;

615 
båfs_£tup_ôem_f‹_ö£π
(
båfs_å™s_h™dÀ
 *
å™s
,

616 
båfs_roŸ
 *
roŸ
,

617 
båfs_∑th
 *
∑th
,

618 c⁄° 
båfs_key
 *
key
,

619 
u32
 
d©a_size
);

620 
båfs_ö£π_ôem
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
,

621 c⁄° 
båfs_key
 *
key
, *
d©a
, 
u32
 
d©a_size
);

622 
båfs_ö£π_em±y_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

623 
båfs_roŸ
 *
roŸ
,

624 
båfs_∑th
 *
∑th
,

625 c⁄° 
båfs_ôem_b©ch
 *
b©ch
);

627 
ölöe
 
	$båfs_ö£π_em±y_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

628 
båfs_roŸ
 *
roŸ
,

629 
båfs_∑th
 *
∑th
,

630 c⁄° 
båfs_key
 *
key
,

631 
u32
 
d©a_size
)

633 
båfs_ôem_b©ch
 
b©ch
;

635 
b©ch
.
keys
 = 
key
;

636 
b©ch
.
d©a_sizes
 = &
d©a_size
;

637 
b©ch
.
tŸÆ_d©a_size
 = 
d©a_size
;

638 
b©ch
.
ƒ
 = 1;

640  
	`båfs_ö£π_em±y_ôems
(
å™s
, 
roŸ
, 
∑th
, &
b©ch
);

641 
	}
}

643 
båfs_√xt_ﬁd_Àaf
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
,

644 
u64
 
time_£q
);

646 
båfs_£¨ch_backw¨ds
(
båfs_roŸ
 *
roŸ
, 
båfs_key
 *
key
,

647 
båfs_∑th
 *
∑th
);

649 
båfs_gë_√xt_vÆid_ôem
(
båfs_roŸ
 *
roŸ
, 
båfs_key
 *
key
,

650 
båfs_∑th
 *
∑th
);

671 
	#båfs_f‹_óch_¶Ÿ
(
roŸ
, 
key
, 
found_key
, 
∑th
, 
ôî_ªt
) \

672 
ôî_ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, (
roŸ
), (
key
), (
∑th
), 0, 0); \

673 (
ôî_ªt
) >= 0 && \

674 (
ôî_ªt
 = 
	`båfs_gë_√xt_vÆid_ôem
((
roŸ
), (
found_key
), (
∑th
))) == 0; \

675 (
∑th
)->
¶Ÿs
[0]++ \

676 )

	)

678 
båfs_√xt_ﬁd_ôem
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
, 
u64
 
time_£q
);

686 
ölöe
 
	$båfs_√xt_Àaf
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
)

688  
	`båfs_√xt_ﬁd_Àaf
(
roŸ
, 
∑th
, 0);

689 
	}
}

691 
ölöe
 
	$båfs_√xt_ôem
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
p
)

693  
	`båfs_√xt_ﬁd_ôem
(
roŸ
, 
p
, 0);

694 
	}
}

695 
båfs_Àaf_‰ì_•a˚
(c⁄° 
exã¡_buf„r
 *
Àaf
);

697 
ölöe
 
	$is_f°ªe
(
u64
 
roŸid
)

699 i‡(
roŸid
 =
BTRFS_FS_TREE_OBJECTID
 ||

700 ((
s64
)
roŸid
 >(s64)
BTRFS_FIRST_FREE_OBJECTID
 &&

701 !
	`båfs_qgroup_Àvñ
(
roŸid
)))

704 
	}
}

706 
ölöe
 
boﬁ
 
	$båfs_is_d©a_ªloc_roŸ
(c⁄° 
båfs_roŸ
 *
roŸ
)

708  
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_DATA_RELOC_TREE_OBJECTID
;

709 
	}
}

711 
u16
 
båfs_csum_ty≥_size
(u16 
ty≥
);

712 
båfs_su≥r_csum_size
(c⁄° 
båfs_su≥r_block
 *
s
);

713 c⁄° *
båfs_su≥r_csum_«me
(
u16
 
csum_ty≥
);

714 c⁄° *
båfs_su≥r_csum_drivî
(
u16
 
csum_ty≥
);

715 
size_t
 
__©åibuã_c⁄°__
 
båfs_gë_num_csums
();

723 
	#PageOrdîed
(
∑ge
Ë
	`PagePriv©e2
’age)

	)

724 
	#SëPageOrdîed
(
∑ge
Ë
	`SëPagePriv©e2
’age)

	)

725 
	#CÀ¨PageOrdîed
(
∑ge
Ë
	`CÀ¨PagePriv©e2
’age)

	)

726 
	#fﬁio_ã°_‹dîed
(
fﬁio
Ë
	`fﬁio_ã°_¥iv©e_2
(fﬁio)

	)

727 
	#fﬁio_£t_‹dîed
(
fﬁio
Ë
	`fﬁio_£t_¥iv©e_2
(fﬁio)

	)

728 
	#fﬁio_˛ór_‹dîed
(
fﬁio
Ë
	`fﬁio_˛ór_¥iv©e_2
(fﬁio)

	)

	@defrag.c

6 
	~<löux/sched.h
>

7 
	~"˘ªe.h
"

8 
	~"disk-io.h
"

9 
	~"¥öt-åì.h
"

10 
	~"å™ß˘i⁄.h
"

11 
	~"lockög.h
"

12 
	~"ac˚ss‹s.h
"

13 
	~"mesßges.h
"

14 
	~"dñÆloc-•a˚.h
"

15 
	~"sub∑ge.h
"

16 
	~"de‰ag.h
"

17 
	~"fûe-ôem.h
"

18 
	~"su≥r.h
"

20 
kmem_ˇche
 *
	gbåfs_öode_de‰ag_ˇchï
;

26 
	söode_de‰ag
 {

27 
rb_node
 
	mrb_node
;

29 
u64
 
	möo
;

34 
u64
 
	må™sid
;

37 
u64
 
	mroŸ
;

46 
u32
 
	mexã¡_thªsh
;

49 
	$__com∑ª_öode_de‰ag
(
öode_de‰ag
 *
de‰ag1
,

50 
öode_de‰ag
 *
de‰ag2
)

52 i‡(
de‰ag1
->
roŸ
 > 
de‰ag2
->root)

54 i‡(
de‰ag1
->
roŸ
 < 
de‰ag2
->root)

56 i‡(
de‰ag1
->
öo
 > 
de‰ag2
->ino)

58 i‡(
de‰ag1
->
öo
 < 
de‰ag2
->ino)

62 
	}
}

73 
	$__båfs_add_öode_de‰ag
(
båfs_öode
 *
öode
,

74 
öode_de‰ag
 *
de‰ag
)

76 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

77 
öode_de‰ag
 *
íåy
;

78 
rb_node
 **
p
;

79 
rb_node
 *
∑ª¡
 = 
NULL
;

80 
ªt
;

82 
p
 = &
fs_öfo
->
de‰ag_öodes
.
rb_node
;

83 *
p
) {

84 
∑ª¡
 = *
p
;

85 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
öode_de‰ag
, 
rb_node
);

87 
ªt
 = 
	`__com∑ª_öode_de‰ag
(
de‰ag
, 
íåy
);

88 i‡(
ªt
 < 0)

89 
p
 = &
∑ª¡
->
rb_À·
;

90 i‡(
ªt
 > 0)

91 
p
 = &
∑ª¡
->
rb_right
;

98 i‡(
de‰ag
->
å™sid
 < 
íåy
->transid)

99 
íåy
->
å™sid
 = 
de‰ag
->transid;

100 
íåy
->
exã¡_thªsh
 = 
	`mö
(
de‰ag
->extent_thresh,

101 
íåy
->
exã¡_thªsh
);

102  -
EEXIST
;

105 
	`£t_bô
(
BTRFS_INODE_IN_DEFRAG
, &
öode
->
ru¡ime_Êags
);

106 
	`rb_lök_node
(&
de‰ag
->
rb_node
, 
∑ª¡
, 
p
);

107 
	`rb_ö£π_cﬁ‹
(&
de‰ag
->
rb_node
, &
fs_öfo
->
de‰ag_öodes
);

109 
	}
}

111 
ölöe
 
	$__√ed_auto_de‰ag
(
båfs_fs_öfo
 *
fs_öfo
)

113 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
AUTO_DEFRAG
))

116 i‡(
	`båfs_fs_˛osög
(
fs_öfo
))

120 
	}
}

125 
	$båfs_add_öode_de‰ag
(
båfs_å™s_h™dÀ
 *
å™s
,

126 
båfs_öode
 *
öode
, 
u32
 
exã¡_thªsh
)

128 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

129 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

130 
öode_de‰ag
 *
de‰ag
;

131 
u64
 
å™sid
;

132 
ªt
;

134 i‡(!
	`__√ed_auto_de‰ag
(
fs_öfo
))

137 i‡(
	`ã°_bô
(
BTRFS_INODE_IN_DEFRAG
, &
öode
->
ru¡ime_Êags
))

140 i‡(
å™s
)

141 
å™sid
 = 
å™s
->transid;

143 
å™sid
 = 
öode
->
roŸ
->
œ°_å™s
;

145 
de‰ag
 = 
	`kmem_ˇche_zÆloc
(
båfs_öode_de‰ag_ˇchï
, 
GFP_NOFS
);

146 i‡(!
de‰ag
)

147  -
ENOMEM
;

149 
de‰ag
->
öo
 = 
	`båfs_öo
(
öode
);

150 
de‰ag
->
å™sid
 =Åransid;

151 
de‰ag
->
roŸ
 =ÑoŸ->
roŸ_key
.
obje˘id
;

152 
de‰ag
->
exã¡_thªsh
 =Éxtent_thresh;

154 
	`•ö_lock
(&
fs_öfo
->
de‰ag_öodes_lock
);

155 i‡(!
	`ã°_bô
(
BTRFS_INODE_IN_DEFRAG
, &
öode
->
ru¡ime_Êags
)) {

161 
ªt
 = 
	`__båfs_add_öode_de‰ag
(
öode
, 
de‰ag
);

162 i‡(
ªt
)

163 
	`kmem_ˇche_‰ì
(
båfs_öode_de‰ag_ˇchï
, 
de‰ag
);

165 
	`kmem_ˇche_‰ì
(
båfs_öode_de‰ag_ˇchï
, 
de‰ag
);

167 
	`•ö_u∆ock
(&
fs_öfo
->
de‰ag_öodes_lock
);

169 
	}
}

175 
öode_de‰ag
 *
	$båfs_pick_de‰ag_öode
(

176 
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
roŸ
, u64 
öo
)

178 
öode_de‰ag
 *
íåy
 = 
NULL
;

179 
öode_de‰ag
 
tmp
;

180 
rb_node
 *
p
;

181 
rb_node
 *
∑ª¡
 = 
NULL
;

182 
ªt
;

184 
tmp
.
öo
 = ino;

185 
tmp
.
roŸ
 =Ñoot;

187 
	`•ö_lock
(&
fs_öfo
->
de‰ag_öodes_lock
);

188 
p
 = 
fs_öfo
->
de‰ag_öodes
.
rb_node
;

189 
p
) {

190 
∑ª¡
 = 
p
;

191 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
öode_de‰ag
, 
rb_node
);

193 
ªt
 = 
	`__com∑ª_öode_de‰ag
(&
tmp
, 
íåy
);

194 i‡(
ªt
 < 0)

195 
p
 = 
∑ª¡
->
rb_À·
;

196 i‡(
ªt
 > 0)

197 
p
 = 
∑ª¡
->
rb_right
;

199 
out
;

202 i‡(
∑ª¡
 && 
	`__com∑ª_öode_de‰ag
(&
tmp
, 
íåy
) > 0) {

203 
∑ª¡
 = 
	`rb_√xt
(parent);

204 i‡(
∑ª¡
)

205 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
öode_de‰ag
, 
rb_node
);

207 
íåy
 = 
NULL
;

209 
out
:

210 i‡(
íåy
)

211 
	`rb_îa£
(
∑ª¡
, &
fs_öfo
->
de‰ag_öodes
);

212 
	`•ö_u∆ock
(&
fs_öfo
->
de‰ag_öodes_lock
);

213  
íåy
;

214 
	}
}

216 
	$båfs_˛ónup_de‰ag_öodes
(
båfs_fs_öfo
 *
fs_öfo
)

218 
öode_de‰ag
 *
de‰ag
;

219 
rb_node
 *
node
;

221 
	`•ö_lock
(&
fs_öfo
->
de‰ag_öodes_lock
);

222 
node
 = 
	`rb_fú°
(&
fs_öfo
->
de‰ag_öodes
);

223 
node
) {

224 
	`rb_îa£
(
node
, &
fs_öfo
->
de‰ag_öodes
);

225 
de‰ag
 = 
	`rb_íåy
(
node
, 
öode_de‰ag
, 
rb_node
);

226 
	`kmem_ˇche_‰ì
(
båfs_öode_de‰ag_ˇchï
, 
de‰ag
);

228 
	`c⁄d_ªsched_lock
(&
fs_öfo
->
de‰ag_öodes_lock
);

230 
node
 = 
	`rb_fú°
(&
fs_öfo
->
de‰ag_öodes
);

232 
	`•ö_u∆ock
(&
fs_öfo
->
de‰ag_öodes_lock
);

233 
	}
}

235 
	#BTRFS_DEFRAG_BATCH
 1024

	)

237 
	$__båfs_run_de‰ag_öode
(
båfs_fs_öfo
 *
fs_öfo
,

238 
öode_de‰ag
 *
de‰ag
)

240 
båfs_roŸ
 *
öode_roŸ
;

241 
öode
 *inode;

242 
båfs_io˘l_de‰ag_ønge_¨gs
 
ønge
;

243 
ªt
 = 0;

244 
u64
 
cur
 = 0;

246 
agaö
:

247 i‡(
	`ã°_bô
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_öfo
->
fs_°©e
))

248 
˛ónup
;

249 i‡(!
	`__√ed_auto_de‰ag
(
fs_öfo
))

250 
˛ónup
;

253 
öode_roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
de‰ag
->
roŸ
, 
åue
);

254 i‡(
	`IS_ERR
(
öode_roŸ
)) {

255 
ªt
 = 
	`PTR_ERR
(
öode_roŸ
);

256 
˛ónup
;

259 
öode
 = 
	`båfs_igë
(
fs_öfo
->
sb
, 
de‰ag
->
öo
, 
öode_roŸ
);

260 
	`båfs_put_roŸ
(
öode_roŸ
);

261 i‡(
	`IS_ERR
(
öode
)) {

262 
ªt
 = 
	`PTR_ERR
(
öode
);

263 
˛ónup
;

266 i‡(
cur
 >
	`i_size_ªad
(
öode
)) {

267 
	`ùut
(
öode
);

268 
˛ónup
;

272 
	`˛ór_bô
(
BTRFS_INODE_IN_DEFRAG
, &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
);

273 
	`mem£t
(&
ønge
, 0, (range));

274 
ønge
.
Àn
 = (
u64
)-1;

275 
ønge
.
°¨t
 = 
cur
;

276 
ønge
.
exã¡_thªsh
 = 
de‰ag
->extent_thresh;

278 
	`sb_°¨t_wrôe
(
fs_öfo
->
sb
);

279 
ªt
 = 
	`båfs_de‰ag_fûe
(
öode
, 
NULL
, &
ønge
, 
de‰ag
->
å™sid
,

280 
BTRFS_DEFRAG_BATCH
);

281 
	`sb_íd_wrôe
(
fs_öfo
->
sb
);

282 
	`ùut
(
öode
);

284 i‡(
ªt
 < 0)

285 
˛ónup
;

287 
cur
 = 
	`max
(cu∏+ 
fs_öfo
->
£˘‹size
, 
ønge
.
°¨t
);

288 
agaö
;

290 
˛ónup
:

291 
	`kmem_ˇche_‰ì
(
båfs_öode_de‰ag_ˇchï
, 
de‰ag
);

292  
ªt
;

293 
	}
}

298 
	$båfs_run_de‰ag_öodes
(
båfs_fs_öfo
 *
fs_öfo
)

300 
öode_de‰ag
 *
de‰ag
;

301 
u64
 
fú°_öo
 = 0;

302 
u64
 
roŸ_obje˘id
 = 0;

304 
	`©omic_öc
(&
fs_öfo
->
de‰ag_ru¬ög
);

307 i‡(
	`ã°_bô
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_öfo
->
fs_°©e
))

310 i‡(!
	`__√ed_auto_de‰ag
(
fs_öfo
))

314 
de‰ag
 = 
	`båfs_pick_de‰ag_öode
(
fs_öfo
, 
roŸ_obje˘id
, 
fú°_öo
);

315 i‡(!
de‰ag
) {

316 i‡(
roŸ_obje˘id
 || 
fú°_öo
) {

317 
roŸ_obje˘id
 = 0;

318 
fú°_öo
 = 0;

325 
fú°_öo
 = 
de‰ag
->
öo
 + 1;

326 
roŸ_obje˘id
 = 
de‰ag
->
roŸ
;

328 
	`__båfs_run_de‰ag_öode
(
fs_öfo
, 
de‰ag
);

330 
	`©omic_dec
(&
fs_öfo
->
de‰ag_ru¬ög
);

336 
	`wake_up
(&
fs_öfo
->
å™ß˘i⁄_waô
);

338 
	}
}

346 
	$båfs_de‰ag_Àaves
(
båfs_å™s_h™dÀ
 *
å™s
,

347 
båfs_roŸ
 *
roŸ
)

349 
båfs_∑th
 *
∑th
 = 
NULL
;

350 
båfs_key
 
key
;

351 
ªt
 = 0;

352 
wªt
;

353 
Àvñ
;

354 
√xt_key_ªt
 = 0;

355 
u64
 
œ°_ªt
 = 0;

357 i‡(!
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
))

358 
out
;

360 
∑th
 = 
	`båfs_Æloc_∑th
();

361 i‡(!
∑th
) {

362 
ªt
 = -
ENOMEM
;

363 
out
;

366 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
roŸ
->
node
);

368 i‡(
Àvñ
 == 0)

369 
out
;

371 i‡(
roŸ
->
de‰ag_¥ogªss
.
obje˘id
 == 0) {

372 
exã¡_buf„r
 *
roŸ_node
;

373 
u32
 
ƒôems
;

375 
roŸ_node
 = 
	`båfs_lock_roŸ_node
(
roŸ
);

376 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
roŸ_node
);

377 
roŸ
->
de‰ag_max
.
obje˘id
 = 0;

379 
	`båfs_node_key_to_˝u
(
roŸ_node
, &
roŸ
->
de‰ag_max
,

380 
ƒôems
 - 1);

381 
	`båfs_åì_u∆ock
(
roŸ_node
);

382 
	`‰ì_exã¡_buf„r
(
roŸ_node
);

383 
	`mem£t
(&
key
, 0, (key));

385 
	`mem˝y
(&
key
, &
roŸ
->
de‰ag_¥ogªss
, (key));

388 
∑th
->
kìp_locks
 = 1;

390 
ªt
 = 
	`båfs_£¨ch_f‹w¨d
(
roŸ
, &
key
, 
∑th
, 
BTRFS_OLDEST_GENERATION
);

391 i‡(
ªt
 < 0)

392 
out
;

393 i‡(
ªt
 > 0) {

394 
ªt
 = 0;

395 
out
;

397 
	`båfs_ªÀa£_∑th
(
∑th
);

403 
∑th
->
lowe°_Àvñ
 = 1;

404 
wªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, 0, 1);

406 i‡(
wªt
 < 0) {

407 
ªt
 = 
wªt
;

408 
out
;

410 i‡(!
∑th
->
nodes
[1]) {

411 
ªt
 = 0;

412 
out
;

419 
	`BUG_ON
(
∑th
->
locks
[1] == 0);

420 
ªt
 = 
	`båfs_ªÆloc_node
(
å™s
, 
roŸ
,

421 
∑th
->
nodes
[1], 0,

422 &
œ°_ªt
,

423 &
roŸ
->
de‰ag_¥ogªss
);

424 i‡(
ªt
) {

425 
	`WARN_ON
(
ªt
 =-
EAGAIN
);

426 
out
;

437 
∑th
->
¶Ÿs
[1] = 
	`båfs_hódî_ƒôems
’©h->
nodes
[1]);

438 
√xt_key_ªt
 = 
	`båfs_föd_√xt_key
(
roŸ
, 
∑th
, &
key
, 1,

439 
BTRFS_OLDEST_GENERATION
);

440 i‡(
√xt_key_ªt
 == 0) {

441 
	`mem˝y
(&
roŸ
->
de‰ag_¥ogªss
, &
key
, (key));

442 
ªt
 = -
EAGAIN
;

444 
out
:

445 
	`båfs_‰ì_∑th
(
∑th
);

446 i‡(
ªt
 =-
EAGAIN
) {

447 i‡(
roŸ
->
de‰ag_max
.
obje˘id
 >ÑoŸ->
de‰ag_¥ogªss
.objectid)

448 
d⁄e
;

449 i‡(
roŸ
->
de‰ag_max
.
ty≥
 >ÑoŸ->
de‰ag_¥ogªss
.type)

450 
d⁄e
;

451 i‡(
roŸ
->
de‰ag_max
.
off£t
 >ÑoŸ->
de‰ag_¥ogªss
.offset)

452 
d⁄e
;

453 
ªt
 = 0;

455 
d⁄e
:

456 i‡(
ªt
 !-
EAGAIN
)

457 
	`mem£t
(&
roŸ
->
de‰ag_¥ogªss
, 0,

458 (
roŸ
->
de‰ag_¥ogªss
));

460  
ªt
;

461 
	}
}

482 
exã¡_m≠
 *
	$de‰ag_gë_exã¡
(
båfs_öode
 *
öode
,

483 
u64
 
°¨t
, u64 
√wî_th™
)

485 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

486 
båfs_fûe_exã¡_ôem
 *
fi
;

487 
båfs_∑th
 
∑th
 = { 0 };

488 
exã¡_m≠
 *
em
;

489 
båfs_key
 
key
;

490 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

491 
ªt
;

493 
em
 = 
	`Æloc_exã¡_m≠
();

494 i‡(!
em
) {

495 
ªt
 = -
ENOMEM
;

496 
îr
;

499 
key
.
obje˘id
 = 
öo
;

500 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

501 
key
.
off£t
 = 
°¨t
;

503 i‡(
√wî_th™
) {

504 
ªt
 = 
	`båfs_£¨ch_f‹w¨d
(
roŸ
, &
key
, &
∑th
, 
√wî_th™
);

505 i‡(
ªt
 < 0)

506 
îr
;

508 i‡(
ªt
 > 0)

509 
nŸ_found
;

511 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, &
∑th
, 0, 0);

512 i‡(
ªt
 < 0)

513 
îr
;

515 i‡(
∑th
.
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
’©h.
nodes
[0])) {

521 
	`ASSERT
(
	`båfs_hódî_ƒôems
(
∑th
.
nodes
[0]));

522 
∑th
.
¶Ÿs
[0] = 
	`båfs_hódî_ƒôems
’©h.
nodes
[0]) - 1;

524 
	`båfs_ôem_key_to_˝u
(
∑th
.
nodes
[0], &
key
,Ö©h.
¶Ÿs
[0]);

526 i‡(
key
.
obje˘id
 =
öo
 && key.
ty≥
 =
BTRFS_EXTENT_DATA_KEY
 &&

527 
key
.
off£t
 =
°¨t
)

528 
ôî©e
;

531 i‡(
∑th
.
¶Ÿs
[0] > 0) {

532 
	`båfs_ôem_key_to_˝u
(
∑th
.
nodes
[0], &
key
,Ö©h.
¶Ÿs
[0]);

533 i‡(
key
.
obje˘id
 =
öo
 && key.
ty≥
 =
BTRFS_EXTENT_DATA_KEY
)

534 
∑th
.
¶Ÿs
[0]--;

537 
ôî©e
:

539 
åue
) {

540 
u64
 
exã¡_íd
;

542 i‡(
∑th
.
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
’©h.
nodes
[0]))

543 
√xt
;

545 
	`båfs_ôem_key_to_˝u
(
∑th
.
nodes
[0], &
key
,Ö©h.
¶Ÿs
[0]);

552 i‡(
	`WARN_ON
(
key
.
obje˘id
 < 
öo
Ë|| key.
ty≥
 < 
BTRFS_EXTENT_DATA_KEY
)

553 
√xt
;

556 i‡(
key
.
obje˘id
 > 
öo
 || key.
ty≥
 > 
BTRFS_EXTENT_DATA_KEY
)

557 
nŸ_found
;

565 i‡(
key
.
off£t
 > 
°¨t
) {

566 
em
->
°¨t
 = start;

567 
em
->
‹ig_°¨t
 = 
°¨t
;

568 
em
->
block_°¨t
 = 
EXTENT_MAP_HOLE
;

569 
em
->
Àn
 = 
key
.
off£t
 - 
°¨t
;

573 
fi
 = 
	`båfs_ôem_±r
(
∑th
.
nodes
[0],Ö©h.
¶Ÿs
[0],

574 
båfs_fûe_exã¡_ôem
);

575 
exã¡_íd
 = 
	`båfs_fûe_exã¡_íd
(&
∑th
);

583 i‡(
exã¡_íd
 <
°¨t
)

584 
√xt
;

587 
	`båfs_exã¡_ôem_to_exã¡_m≠
(
öode
, &
∑th
, 
fi
, 
em
);

589 
√xt
:

590 
ªt
 = 
	`båfs_√xt_ôem
(
roŸ
, &
∑th
);

591 i‡(
ªt
 < 0)

592 
îr
;

593 i‡(
ªt
 > 0)

594 
nŸ_found
;

596 
	`båfs_ªÀa£_∑th
(&
∑th
);

597  
em
;

599 
nŸ_found
:

600 
	`båfs_ªÀa£_∑th
(&
∑th
);

601 
	`‰ì_exã¡_m≠
(
em
);

602  
NULL
;

604 
îr
:

605 
	`båfs_ªÀa£_∑th
(&
∑th
);

606 
	`‰ì_exã¡_m≠
(
em
);

607  
	`ERR_PTR
(
ªt
);

608 
	}
}

610 
exã¡_m≠
 *
	$de‰ag_lookup_exã¡
(
öode
 *öode, 
u64
 
°¨t
,

611 
u64
 
√wî_th™
, 
boﬁ
 
locked
)

613 
exã¡_m≠_åì
 *
em_åì
 = &
	`BTRFS_I
(
öode
)->
exã¡_åì
;

614 
exã¡_io_åì
 *
io_åì
 = &
	`BTRFS_I
(
öode
)->io_tree;

615 
exã¡_m≠
 *
em
;

616 c⁄° 
u32
 
£˘‹size
 = 
	`BTRFS_I
(
öode
)->
roŸ
->
fs_öfo
->sectorsize;

622 
	`ªad_lock
(&
em_åì
->
lock
);

623 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 
°¨t
, 
£˘‹size
);

624 
	`ªad_u∆ock
(&
em_åì
->
lock
);

634 i‡(
em
 && 
	`ã°_bô
(
EXTENT_FLAG_MERGED
, &em->
Êags
) &&

635 
√wî_th™
 && 
em
->
gíî©i⁄
 >=Çewer_than) {

636 
	`‰ì_exã¡_m≠
(
em
);

637 
em
 = 
NULL
;

640 i‡(!
em
) {

641 
exã¡_°©e
 *
ˇched
 = 
NULL
;

642 
u64
 
íd
 = 
°¨t
 + 
£˘‹size
 - 1;

645 i‡(!
locked
)

646 
	`lock_exã¡
(
io_åì
, 
°¨t
, 
íd
, &
ˇched
);

647 
em
 = 
	`de‰ag_gë_exã¡
(
	`BTRFS_I
(
öode
), 
°¨t
, 
√wî_th™
);

648 i‡(!
locked
)

649 
	`u∆ock_exã¡
(
io_åì
, 
°¨t
, 
íd
, &
ˇched
);

651 i‡(
	`IS_ERR
(
em
))

652  
NULL
;

655  
em
;

656 
	}
}

658 
u32
 
	$gë_exã¡_max_ˇ∑côy
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

659 c⁄° 
exã¡_m≠
 *
em
)

661 i‡(
	`ã°_bô
(
EXTENT_FLAG_COMPRESSED
, &
em
->
Êags
))

662  
BTRFS_MAX_COMPRESSED
;

663  
fs_öfo
->
max_exã¡_size
;

664 
	}
}

666 
boﬁ
 
	$de‰ag_check_√xt_exã¡
(
öode
 *öode, 
exã¡_m≠
 *
em
,

667 
u32
 
exã¡_thªsh
, 
u64
 
√wî_th™
, 
boﬁ
 
locked
)

669 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

670 
exã¡_m≠
 *
√xt
;

671 
boﬁ
 
ªt
 = 
Ál£
;

674 i‡(
em
->
°¨t
 +Ém->
Àn
 >
	`i_size_ªad
(
öode
))

675  
Ál£
;

683 
√xt
 = 
	`de‰ag_lookup_exã¡
(
öode
, 
em
->
°¨t
 +Ém->
Àn
, 
√wî_th™
, 
locked
);

685 i‡(!
√xt
 ||Çext->
block_°¨t
 >
EXTENT_MAP_LAST_BYTE
)

686 
out
;

687 i‡(
	`ã°_bô
(
EXTENT_FLAG_PREALLOC
, &
√xt
->
Êags
))

688 
out
;

693 i‡(
√xt
->
Àn
 >
	`gë_exã¡_max_ˇ∑côy
(
fs_öfo
, 
em
))

694 
out
;

696 i‡(
√xt
->
gíî©i⁄
 < 
√wî_th™
)

697 
out
;

699 i‡(
√xt
->
Àn
 >
exã¡_thªsh
)

700 
out
;

702 
ªt
 = 
åue
;

703 
out
:

704 
	`‰ì_exã¡_m≠
(
√xt
);

705  
ªt
;

706 
	}
}

720 
∑ge
 *
	$de‰ag_¥ï¨e_⁄e_∑ge
(
båfs_öode
 *
öode
, 
pgoff_t
 
ödex
)

722 
addªss_•a˚
 *
m≠pög
 = 
öode
->
vfs_öode
.
i_m≠pög
;

723 
gÂ_t
 
mask
 = 
	`båfs_Æloc_wrôe_mask
(
m≠pög
);

724 
u64
 
∑ge_°¨t
 = (u64)
ödex
 << 
PAGE_SHIFT
;

725 
u64
 
∑ge_íd
 = 
∑ge_°¨t
 + 
PAGE_SIZE
 - 1;

726 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

727 
∑ge
 *page;

728 
ªt
;

730 
agaö
:

731 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
m≠pög
, 
ödex
, 
mask
);

732 i‡(!
∑ge
)

733  
	`ERR_PTR
(-
ENOMEM
);

743 i‡(
	`PageCompound
(
∑ge
)) {

744 
	`u∆ock_∑ge
(
∑ge
);

745 
	`put_∑ge
(
∑ge
);

746  
	`ERR_PTR
(-
ETXTBSY
);

749 
ªt
 = 
	`£t_∑ge_exã¡_m≠≥d
(
∑ge
);

750 i‡(
ªt
 < 0) {

751 
	`u∆ock_∑ge
(
∑ge
);

752 
	`put_∑ge
(
∑ge
);

753  
	`ERR_PTR
(
ªt
);

758 
båfs_‹dîed_exã¡
 *
‹dîed
;

760 
	`lock_exã¡
(&
öode
->
io_åì
, 
∑ge_°¨t
, 
∑ge_íd
, &
ˇched_°©e
);

761 
‹dîed
 = 
	`båfs_lookup_‹dîed_ønge
(
öode
, 
∑ge_°¨t
, 
PAGE_SIZE
);

762 
	`u∆ock_exã¡
(&
öode
->
io_åì
, 
∑ge_°¨t
, 
∑ge_íd
,

763 &
ˇched_°©e
);

764 i‡(!
‹dîed
)

767 
	`u∆ock_∑ge
(
∑ge
);

768 
	`båfs_°¨t_‹dîed_exã¡
(
‹dîed
);

769 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

770 
	`lock_∑ge
(
∑ge
);

775 i‡(
∑ge
->
m≠pög
 !m≠pög || !
	`PagePriv©e
(page)) {

776 
	`u∆ock_∑ge
(
∑ge
);

777 
	`put_∑ge
(
∑ge
);

778 
agaö
;

786 i‡(!
	`PageU±od©e
(
∑ge
)) {

787 
	`båfs_ªad_fﬁio
(
NULL
, 
	`∑ge_fﬁio
(
∑ge
));

788 
	`lock_∑ge
(
∑ge
);

789 i‡(
∑ge
->
m≠pög
 !m≠pög || !
	`PagePriv©e
(page)) {

790 
	`u∆ock_∑ge
(
∑ge
);

791 
	`put_∑ge
(
∑ge
);

792 
agaö
;

794 i‡(!
	`PageU±od©e
(
∑ge
)) {

795 
	`u∆ock_∑ge
(
∑ge
);

796 
	`put_∑ge
(
∑ge
);

797  
	`ERR_PTR
(-
EIO
);

800  
∑ge
;

801 
	}
}

803 
	sde‰ag_èrgë_ønge
 {

804 
li°_hód
 
	mli°
;

805 
u64
 
	m°¨t
;

806 
u64
 
	mÀn
;

823 
	$de‰ag_cﬁÀ˘_èrgës
(
båfs_öode
 *
öode
,

824 
u64
 
°¨t
, u64 
Àn
, 
u32
 
exã¡_thªsh
,

825 
u64
 
√wî_th™
, 
boﬁ
 
do_com¥ess
,

826 
boﬁ
 
locked
, 
li°_hód
 *
èrgë_li°
,

827 
u64
 *
œ°_sˇ¬ed_ªt
)

829 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

830 
boﬁ
 
œ°_is_èrgë
 = 
Ál£
;

831 
u64
 
cur
 = 
°¨t
;

832 
ªt
 = 0;

834 
cur
 < 
°¨t
 + 
Àn
) {

835 
exã¡_m≠
 *
em
;

836 
de‰ag_èrgë_ønge
 *
√w
;

837 
boﬁ
 
√xt_mîgóbÀ
 = 
åue
;

838 
u64
 
ønge_Àn
;

840 
œ°_is_èrgë
 = 
Ál£
;

841 
em
 = 
	`de‰ag_lookup_exã¡
(&
öode
->
vfs_öode
, 
cur
, 
√wî_th™
, 
locked
);

842 i‡(!
em
)

851 i‡(
em
->
block_°¨t
 =
EXTENT_MAP_INLINE
 &&

852 
em
->
Àn
 <
öode
->
roŸ
->
fs_öfo
->
max_ölöe
)

853 
√xt
;

856 i‡(
em
->
block_°¨t
 =
EXTENT_MAP_HOLE
 ||

857 
em
->
block_°¨t
 =
EXTENT_MAP_DELALLOC
 ||

858 
	`ã°_bô
(
EXTENT_FLAG_PREALLOC
, &
em
->
Êags
))

859 
√xt
;

862 i‡(
em
->
gíî©i⁄
 < 
√wî_th™
)

863 
√xt
;

866 i‡(
em
->
gíî©i⁄
 =(
u64
)-1)

867 
√xt
;

873 
ønge_Àn
 = 
em
->
Àn
 - (
cur
 -Ém->
°¨t
);

894 i‡(
	`ã°_ønge_bô
(&
öode
->
io_åì
, 
cur
, cu∏+ 
ønge_Àn
 - 1,

895 
EXTENT_DELALLOC
, 0, 
NULL
))

896 
√xt
;

902 i‡(
do_com¥ess
)

903 
add
;

906 i‡(
ønge_Àn
 >
exã¡_thªsh
)

907 
√xt
;

913 i‡(
em
->
Àn
 >
	`gë_exã¡_max_ˇ∑côy
(
fs_öfo
,Ém))

914 
√xt
;

922 i‡(
em
->
block_°¨t
 =
EXTENT_MAP_INLINE
)

923 
add
;

925 
√xt_mîgóbÀ
 = 
	`de‰ag_check_√xt_exã¡
(&
öode
->
vfs_öode
, 
em
,

926 
exã¡_thªsh
, 
√wî_th™
, 
locked
);

927 i‡(!
√xt_mîgóbÀ
) {

928 
de‰ag_èrgë_ønge
 *
œ°
;

931 i‡(
	`li°_em±y
(
èrgë_li°
))

932 
√xt
;

933 
œ°
 = 
	`li°_íåy
(
èrgë_li°
->
¥ev
,

934 
de‰ag_èrgë_ønge
, 
li°
);

936 i‡(
œ°
->
°¨t
 +Üa°->
Àn
 !
cur
)

937 
√xt
;

942 
add
:

943 
œ°_is_èrgë
 = 
åue
;

944 
ønge_Àn
 = 
	`mö
(
	`exã¡_m≠_íd
(
em
), 
°¨t
 + 
Àn
Ë- 
cur
;

949 i‡(!
	`li°_em±y
(
èrgë_li°
)) {

950 
de‰ag_èrgë_ønge
 *
œ°
;

952 
œ°
 = 
	`li°_íåy
(
èrgë_li°
->
¥ev
,

953 
de‰ag_èrgë_ønge
, 
li°
);

954 
	`ASSERT
(
œ°
->
°¨t
 +Üa°->
Àn
 <
cur
);

955 i‡(
œ°
->
°¨t
 +Üa°->
Àn
 =
cur
) {

957 
œ°
->
Àn
 +
ønge_Àn
;

958 
√xt
;

964 
√w
 = 
	`kmÆloc
((*√w), 
GFP_NOFS
);

965 i‡(!
√w
) {

966 
	`‰ì_exã¡_m≠
(
em
);

967 
ªt
 = -
ENOMEM
;

970 
√w
->
°¨t
 = 
cur
;

971 
√w
->
Àn
 = 
ønge_Àn
;

972 
	`li°_add_èû
(&
√w
->
li°
, 
èrgë_li°
);

974 
√xt
:

975 
cur
 = 
	`exã¡_m≠_íd
(
em
);

976 
	`‰ì_exã¡_m≠
(
em
);

978 i‡(
ªt
 < 0) {

979 
de‰ag_èrgë_ønge
 *
íåy
;

980 
de‰ag_èrgë_ønge
 *
tmp
;

982 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
tmp
, 
èrgë_li°
, 
li°
) {

983 
	`li°_dñ_öô
(&
íåy
->
li°
);

984 
	`k‰ì
(
íåy
);

987 i‡(!
ªt
 && 
œ°_sˇ¬ed_ªt
) {

993 i‡(!
œ°_is_èrgë
)

994 *
œ°_sˇ¬ed_ªt
 = 
	`max
(
cur
, *last_scanned_ret);

996 *
œ°_sˇ¬ed_ªt
 = 
	`max
(
°¨t
 + 
Àn
, *last_scanned_ret);

998  
ªt
;

999 
	}
}

1001 
	#CLUSTER_SIZE
 (
SZ_256K
)

	)

1002 
°©ic_as£π
(
PAGE_ALIGNED
(
CLUSTER_SIZE
));

1020 
	$de‰ag_⁄e_locked_èrgë
(
båfs_öode
 *
öode
,

1021 
de‰ag_èrgë_ønge
 *
èrgë
,

1022 
∑ge
 **
∑ges
, 
ƒ_∑ges
,

1023 
exã¡_°©e
 **
ˇched_°©e
)

1025 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

1026 
exã¡_ch™ge£t
 *
d©a_ª£rved
 = 
NULL
;

1027 c⁄° 
u64
 
°¨t
 = 
èrgë
->start;

1028 c⁄° 
u64
 
Àn
 = 
èrgë
->len;

1029 
œ°_ödex
 = (
°¨t
 + 
Àn
 - 1Ë>> 
PAGE_SHIFT
;

1030 
°¨t_ödex
 = 
°¨t
 >> 
PAGE_SHIFT
;

1031 
fú°_ödex
 = 
	`∑ge_ödex
(
∑ges
[0]);

1032 
ªt
 = 0;

1033 
i
;

1035 
	`ASSERT
(
œ°_ödex
 - 
fú°_ödex
 + 1 <
ƒ_∑ges
);

1037 
ªt
 = 
	`båfs_dñÆloc_ª£rve_•a˚
(
öode
, &
d©a_ª£rved
, 
°¨t
, 
Àn
);

1038 i‡(
ªt
 < 0)

1039  
ªt
;

1040 
	`˛ór_exã¡_bô
(&
öode
->
io_åì
, 
°¨t
, sèπ + 
Àn
 - 1,

1041 
EXTENT_DELALLOC
 | 
EXTENT_DO_ACCOUNTING
 |

1042 
EXTENT_DEFRAG
, 
ˇched_°©e
);

1043 
	`£t_exã¡_bô
(&
öode
->
io_åì
, 
°¨t
, sèπ + 
Àn
 - 1,

1044 
EXTENT_DELALLOC
 | 
EXTENT_DEFRAG
, 
ˇched_°©e
);

1047 
i
 = 
°¨t_ödex
 - 
fú°_ödex
; i <
œ°_ödex
 - first_index; i++) {

1048 
	`CÀ¨PageChecked
(
∑ges
[
i
]);

1049 
	`båfs_∑ge_˛amp_£t_dúty
(
fs_öfo
, 
∑ges
[
i
], 
°¨t
, 
Àn
);

1051 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
öode
, 
Àn
);

1052 
	`exã¡_ch™ge£t_‰ì
(
d©a_ª£rved
);

1054  
ªt
;

1055 
	}
}

1057 
	$de‰ag_⁄e_ønge
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, 
u32
 
Àn
,

1058 
u32
 
exã¡_thªsh
, 
u64
 
√wî_th™
, 
boﬁ
 
do_com¥ess
,

1059 
u64
 *
œ°_sˇ¬ed_ªt
)

1061 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

1062 
de‰ag_èrgë_ønge
 *
íåy
;

1063 
de‰ag_èrgë_ønge
 *
tmp
;

1064 
	`LIST_HEAD
(
èrgë_li°
);

1065 
∑ge
 **
∑ges
;

1066 c⁄° 
u32
 
£˘‹size
 = 
öode
->
roŸ
->
fs_öfo
->sectorsize;

1067 
u64
 
œ°_ödex
 = (
°¨t
 + 
Àn
 - 1Ë>> 
PAGE_SHIFT
;

1068 
u64
 
°¨t_ödex
 = 
°¨t
 >> 
PAGE_SHIFT
;

1069 
ƒ_∑ges
 = 
œ°_ödex
 - 
°¨t_ödex
 + 1;

1070 
ªt
 = 0;

1071 
i
;

1073 
	`ASSERT
(
ƒ_∑ges
 <
CLUSTER_SIZE
 / 
PAGE_SIZE
);

1074 
	`ASSERT
(
	`IS_ALIGNED
(
°¨t
, 
£˘‹size
Ë&& IS_ALIGNED(
Àn
, sectorsize));

1076 
∑ges
 = 
	`kˇŒoc
(
ƒ_∑ges
, (
∑ge
 *), 
GFP_NOFS
);

1077 i‡(!
∑ges
)

1078  -
ENOMEM
;

1081 
i
 = 0; i < 
ƒ_∑ges
; i++) {

1082 
∑ges
[
i
] = 
	`de‰ag_¥ï¨e_⁄e_∑ge
(
öode
, 
°¨t_ödex
 + i);

1083 i‡(
	`IS_ERR
(
∑ges
[
i
])) {

1084 
ªt
 = 
	`PTR_ERR
(
∑ges
[
i
]);

1085 
∑ges
[
i
] = 
NULL
;

1086 
‰ì_∑ges
;

1089 
i
 = 0; i < 
ƒ_∑ges
; i++)

1090 
	`waô_⁄_∑ge_wrôeback
(
∑ges
[
i
]);

1093 
	`lock_exã¡
(&
öode
->
io_åì
, 
°¨t_ödex
 << 
PAGE_SHIFT
,

1094 (
œ°_ödex
 << 
PAGE_SHIFT
Ë+ 
PAGE_SIZE
 - 1,

1095 &
ˇched_°©e
);

1103 
ªt
 = 
	`de‰ag_cﬁÀ˘_èrgës
(
öode
, 
°¨t
, 
Àn
, 
exã¡_thªsh
,

1104 
√wî_th™
, 
do_com¥ess
, 
åue
,

1105 &
èrgë_li°
, 
œ°_sˇ¬ed_ªt
);

1106 i‡(
ªt
 < 0)

1107 
u∆ock_exã¡
;

1109 
	`li°_f‹_óch_íåy
(
íåy
, &
èrgë_li°
, 
li°
) {

1110 
ªt
 = 
	`de‰ag_⁄e_locked_èrgë
(
öode
, 
íåy
, 
∑ges
, 
ƒ_∑ges
,

1111 &
ˇched_°©e
);

1112 i‡(
ªt
 < 0)

1116 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
tmp
, &
èrgë_li°
, 
li°
) {

1117 
	`li°_dñ_öô
(&
íåy
->
li°
);

1118 
	`k‰ì
(
íåy
);

1120 
u∆ock_exã¡
:

1121 
	`u∆ock_exã¡
(&
öode
->
io_åì
, 
°¨t_ödex
 << 
PAGE_SHIFT
,

1122 (
œ°_ödex
 << 
PAGE_SHIFT
Ë+ 
PAGE_SIZE
 - 1,

1123 &
ˇched_°©e
);

1124 
‰ì_∑ges
:

1125 
i
 = 0; i < 
ƒ_∑ges
; i++) {

1126 i‡(
∑ges
[
i
]) {

1127 
	`u∆ock_∑ge
(
∑ges
[
i
]);

1128 
	`put_∑ge
(
∑ges
[
i
]);

1131 
	`k‰ì
(
∑ges
);

1132  
ªt
;

1133 
	}
}

1135 
	$de‰ag_⁄e_˛u°î
(
båfs_öode
 *
öode
,

1136 
fûe_ø_°©e
 *
ø
,

1137 
u64
 
°¨t
, 
u32
 
Àn
, u32 
exã¡_thªsh
,

1138 
u64
 
√wî_th™
, 
boﬁ
 
do_com¥ess
,

1139 *
£˘‹s_de‰agged
,

1140 
max_£˘‹s
,

1141 
u64
 *
œ°_sˇ¬ed_ªt
)

1143 c⁄° 
u32
 
£˘‹size
 = 
öode
->
roŸ
->
fs_öfo
->sectorsize;

1144 
de‰ag_èrgë_ønge
 *
íåy
;

1145 
de‰ag_èrgë_ønge
 *
tmp
;

1146 
	`LIST_HEAD
(
èrgë_li°
);

1147 
ªt
;

1149 
ªt
 = 
	`de‰ag_cﬁÀ˘_èrgës
(
öode
, 
°¨t
, 
Àn
, 
exã¡_thªsh
,

1150 
√wî_th™
, 
do_com¥ess
, 
Ál£
,

1151 &
èrgë_li°
, 
NULL
);

1152 i‡(
ªt
 < 0)

1153 
out
;

1155 
	`li°_f‹_óch_íåy
(
íåy
, &
èrgë_li°
, 
li°
) {

1156 
u32
 
ønge_Àn
 = 
íåy
->
Àn
;

1159 i‡(
max_£˘‹s
 && *
£˘‹s_de‰agged
 >= max_sectors) {

1160 
ªt
 = 1;

1164 i‡(
max_£˘‹s
)

1165 
ønge_Àn
 = 
	`mö_t
(
u32
,Ñange_len,

1166 (
max_£˘‹s
 - *
£˘‹s_de‰agged
Ë* 
£˘‹size
);

1174 i‡(
íåy
->
°¨t
 + 
ønge_Àn
 <*
œ°_sˇ¬ed_ªt
)

1177 i‡(
ø
)

1178 
	`∑ge_ˇche_sync_ªadahód
(
öode
->
vfs_öode
.
i_m≠pög
,

1179 
ø
, 
NULL
, 
íåy
->
°¨t
 >> 
PAGE_SHIFT
,

1180 ((
íåy
->
°¨t
 + 
ønge_Àn
 - 1Ë>> 
PAGE_SHIFT
) -

1181 (
íåy
->
°¨t
 >> 
PAGE_SHIFT
) + 1);

1188 
ªt
 = 
	`de‰ag_⁄e_ønge
(
öode
, 
íåy
->
°¨t
, 
ønge_Àn
,

1189 
exã¡_thªsh
, 
√wî_th™
, 
do_com¥ess
,

1190 
œ°_sˇ¬ed_ªt
);

1191 i‡(
ªt
 < 0)

1193 *
£˘‹s_de‰agged
 +
ønge_Àn
 >>

1194 
öode
->
roŸ
->
fs_öfo
->
£˘‹size_bôs
;

1196 
out
:

1197 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
tmp
, &
èrgë_li°
, 
li°
) {

1198 
	`li°_dñ_öô
(&
íåy
->
li°
);

1199 
	`k‰ì
(
íåy
);

1201 i‡(
ªt
 >= 0)

1202 *
œ°_sˇ¬ed_ªt
 = 
	`max
(*œ°_sˇ¬ed_ªt, 
°¨t
 + 
Àn
);

1203  
ªt
;

1204 
	}
}

1222 
	$båfs_de‰ag_fûe
(
öode
 *öode, 
fûe_ø_°©e
 *
ø
,

1223 
båfs_io˘l_de‰ag_ønge_¨gs
 *
ønge
,

1224 
u64
 
√wî_th™
, 
max_to_de‰ag
)

1226 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

1227 
£˘‹s_de‰agged
 = 0;

1228 
u64
 
isize
 = 
	`i_size_ªad
(
öode
);

1229 
u64
 
cur
;

1230 
u64
 
œ°_byã
;

1231 
boﬁ
 
do_com¥ess
 = (
ønge
->
Êags
 & 
BTRFS_DEFRAG_RANGE_COMPRESS
);

1232 
boﬁ
 
ø_Æloˇãd
 = 
Ál£
;

1233 
com¥ess_ty≥
 = 
BTRFS_COMPRESS_ZLIB
;

1234 
ªt
 = 0;

1235 
u32
 
exã¡_thªsh
 = 
ønge
->extent_thresh;

1236 
pgoff_t
 
°¨t_ödex
;

1238 i‡(
isize
 == 0)

1241 i‡(
ønge
->
°¨t
 >
isize
)

1242  -
EINVAL
;

1244 i‡(
do_com¥ess
) {

1245 i‡(
ønge
->
com¥ess_ty≥
 >
BTRFS_NR_COMPRESS_TYPES
)

1246  -
EINVAL
;

1247 i‡(
ønge
->
com¥ess_ty≥
)

1248 
com¥ess_ty≥
 = 
ønge
->compress_type;

1251 i‡(
exã¡_thªsh
 == 0)

1252 
exã¡_thªsh
 = 
SZ_256K
;

1254 i‡(
ønge
->
°¨t
 +Ñ™ge->
Àn
 >Ñange->start) {

1256 
œ°_byã
 = 
	`mö
(
isize
, 
ønge
->
°¨t
 +Ñ™ge->
Àn
);

1259 
œ°_byã
 = 
isize
;

1263 
cur
 = 
	`round_down
(
ønge
->
°¨t
, 
fs_öfo
->
£˘‹size
);

1264 
œ°_byã
 = 
	`round_up
÷a°_byã, 
fs_öfo
->
£˘‹size
) - 1;

1271 i‡(!
ø
) {

1272 
ø_Æloˇãd
 = 
åue
;

1273 
ø
 = 
	`kzÆloc
((*ø), 
GFP_KERNEL
);

1274 i‡(
ø
)

1275 
	`fûe_ø_°©e_öô
(
ø
, 
öode
->
i_m≠pög
);

1282 
°¨t_ödex
 = 
cur
 >> 
PAGE_SHIFT
;

1283 i‡(
°¨t_ödex
 < 
öode
->
i_m≠pög
->
wrôeback_ödex
)

1284 
öode
->
i_m≠pög
->
wrôeback_ödex
 = 
°¨t_ödex
;

1286 
cur
 < 
œ°_byã
) {

1287 c⁄° 
¥ev_£˘‹s_de‰agged
 = 
£˘‹s_de‰agged
;

1288 
u64
 
œ°_sˇ¬ed
 = 
cur
;

1289 
u64
 
˛u°î_íd
;

1291 i‡(
	`båfs_de‰ag_ˇn˚Œed
(
fs_öfo
)) {

1292 
ªt
 = -
EAGAIN
;

1297 
˛u°î_íd
 = (((
cur
 >> 
PAGE_SHIFT
) +

1298 (
SZ_256K
 >> 
PAGE_SHIFT
)) << PAGE_SHIFT) - 1;

1299 
˛u°î_íd
 = 
	`mö
(˛u°î_íd, 
œ°_byã
);

1301 
	`båfs_öode_lock
(
	`BTRFS_I
(
öode
), 0);

1302 i‡(
	`IS_SWAPFILE
(
öode
)) {

1303 
ªt
 = -
ETXTBSY
;

1304 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 0);

1307 i‡(!(
öode
->
i_sb
->
s_Êags
 & 
SB_ACTIVE
)) {

1308 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 0);

1311 i‡(
do_com¥ess
)

1312 
	`BTRFS_I
(
öode
)->
de‰ag_com¥ess
 = 
com¥ess_ty≥
;

1313 
ªt
 = 
	`de‰ag_⁄e_˛u°î
(
	`BTRFS_I
(
öode
), 
ø
, 
cur
,

1314 
˛u°î_íd
 + 1 - 
cur
, 
exã¡_thªsh
,

1315 
√wî_th™
, 
do_com¥ess
, &
£˘‹s_de‰agged
,

1316 
max_to_de‰ag
, &
œ°_sˇ¬ed
);

1318 i‡(
£˘‹s_de‰agged
 > 
¥ev_£˘‹s_de‰agged
)

1319 
	`bÆ™˚_dúty_∑ges_øãlimôed
(
öode
->
i_m≠pög
);

1321 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 0);

1322 i‡(
ªt
 < 0)

1324 
cur
 = 
	`max
(
˛u°î_íd
 + 1, 
œ°_sˇ¬ed
);

1325 i‡(
ªt
 > 0) {

1326 
ªt
 = 0;

1329 
	`c⁄d_ªsched
();

1332 i‡(
ø_Æloˇãd
)

1333 
	`k‰ì
(
ø
);

1338 
ønge
->
°¨t
 = 
cur
;

1339 i‡(
£˘‹s_de‰agged
) {

1344 i‡(
ønge
->
Êags
 & 
BTRFS_DEFRAG_RANGE_START_IO
) {

1345 
	`fûem≠_Êush
(
öode
->
i_m≠pög
);

1346 i‡(
	`ã°_bô
(
BTRFS_INODE_HAS_ASYNC_EXTENT
,

1347 &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
))

1348 
	`fûem≠_Êush
(
öode
->
i_m≠pög
);

1350 i‡(
ønge
->
com¥ess_ty≥
 =
BTRFS_COMPRESS_LZO
)

1351 
	`båfs_£t_fs_öcom∑t
(
fs_öfo
, 
COMPRESS_LZO
);

1352 i‡(
ønge
->
com¥ess_ty≥
 =
BTRFS_COMPRESS_ZSTD
)

1353 
	`båfs_£t_fs_öcom∑t
(
fs_öfo
, 
COMPRESS_ZSTD
);

1354 
ªt
 = 
£˘‹s_de‰agged
;

1356 i‡(
do_com¥ess
) {

1357 
	`båfs_öode_lock
(
	`BTRFS_I
(
öode
), 0);

1358 
	`BTRFS_I
(
öode
)->
de‰ag_com¥ess
 = 
BTRFS_COMPRESS_NONE
;

1359 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 0);

1361  
ªt
;

1362 
	}
}

1364 
__cﬁd
 
	$båfs_auto_de‰ag_exô
()

1366 
	`kmem_ˇche_de°roy
(
båfs_öode_de‰ag_ˇchï
);

1367 
	}
}

1369 
__öô
 
	$båfs_auto_de‰ag_öô
()

1371 
båfs_öode_de‰ag_ˇchï
 = 
	`kmem_ˇche_¸óã
("btrfs_inode_defrag",

1372 (
öode_de‰ag
), 0,

1373 
SLAB_MEM_SPREAD
,

1374 
NULL
);

1375 i‡(!
båfs_öode_de‰ag_ˇchï
)

1376  -
ENOMEM
;

1379 
	}
}

	@defrag.h

3 #i‚de‡
BTRFS_DEFRAG_H


4 
	#BTRFS_DEFRAG_H


	)

6 
båfs_de‰ag_fûe
(
öode
 *öode, 
fûe_ø_°©e
 *
ø
,

7 
båfs_io˘l_de‰ag_ønge_¨gs
 *
ønge
,

8 
u64
 
√wî_th™
, 
max_to_de‰ag
);

9 
__öô
 
båfs_auto_de‰ag_öô
();

10 
__cﬁd
 
båfs_auto_de‰ag_exô
();

11 
båfs_add_öode_de‰ag
(
båfs_å™s_h™dÀ
 *
å™s
,

12 
båfs_öode
 *
öode
, 
u32
 
exã¡_thªsh
);

13 
båfs_run_de‰ag_öodes
(
båfs_fs_öfo
 *
fs_öfo
);

14 
båfs_˛ónup_de‰ag_öodes
(
båfs_fs_öfo
 *
fs_öfo
);

15 
båfs_de‰ag_Àaves
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
);

17 
ölöe
 
	$båfs_de‰ag_ˇn˚Œed
(
båfs_fs_öfo
 *
fs_öfo
)

19  
	`sig«l_≥ndög
(
cuºít
);

20 
	}
}

	@delalloc-space.c

3 
	~"mesßges.h
"

4 
	~"˘ªe.h
"

5 
	~"dñÆloc-•a˚.h
"

6 
	~"block-rsv.h
"

7 
	~"båfs_öode.h
"

8 
	~"•a˚-öfo.h
"

9 
	~"å™ß˘i⁄.h
"

10 
	~"qgroup.h
"

11 
	~"block-group.h
"

12 
	~"fs.h
"

116 
	$båfs_Æloc_d©a_chunk_⁄dem™d
(
båfs_öode
 *
öode
, 
u64
 
byãs
)

118 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

119 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

120 
båfs_ª£rve_Êush_íum
 
Êush
 = 
BTRFS_RESERVE_FLUSH_DATA
;

123 
byãs
 = 
	`ALIGN
(byãs, 
fs_öfo
->
£˘‹size
);

125 i‡(
	`båfs_is_‰ì_•a˚_öode
(
öode
))

126 
Êush
 = 
BTRFS_RESERVE_FLUSH_FREE_SPACE_INODE
;

128  
	`båfs_ª£rve_d©a_byãs
(
fs_öfo
, 
byãs
, 
Êush
);

129 
	}
}

131 
	$båfs_check_d©a_‰ì_•a˚
(
båfs_öode
 *
öode
,

132 
exã¡_ch™ge£t
 **
ª£rved
, 
u64
 
°¨t
,

133 
u64
 
Àn
, 
boﬁ
 
noÊush
)

135 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

136 
båfs_ª£rve_Êush_íum
 
Êush
 = 
BTRFS_RESERVE_FLUSH_DATA
;

137 
ªt
;

140 
Àn
 = 
	`round_up
(
°¨t
 +Üí, 
fs_öfo
->
£˘‹size
) -

141 
	`round_down
(
°¨t
, 
fs_öfo
->
£˘‹size
);

142 
°¨t
 = 
	`round_down
(°¨t, 
fs_öfo
->
£˘‹size
);

144 i‡(
noÊush
)

145 
Êush
 = 
BTRFS_RESERVE_NO_FLUSH
;

146 i‡(
	`båfs_is_‰ì_•a˚_öode
(
öode
))

147 
Êush
 = 
BTRFS_RESERVE_FLUSH_FREE_SPACE_INODE
;

149 
ªt
 = 
	`båfs_ª£rve_d©a_byãs
(
fs_öfo
, 
Àn
, 
Êush
);

150 i‡(
ªt
 < 0)

151  
ªt
;

154 
ªt
 = 
	`båfs_qgroup_ª£rve_d©a
(
öode
, 
ª£rved
, 
°¨t
, 
Àn
);

155 i‡(
ªt
 < 0) {

156 
	`båfs_‰ì_ª£rved_d©a_•a˚_noquŸa
(
fs_öfo
, 
Àn
);

157 
	`exã¡_ch™ge£t_‰ì
(*
ª£rved
);

158 *
ª£rved
 = 
NULL
;

160 
ªt
 = 0;

162  
ªt
;

163 
	}
}

173 
	$båfs_‰ì_ª£rved_d©a_•a˚_noquŸa
(
båfs_fs_öfo
 *
fs_öfo
,

174 
u64
 
Àn
)

176 
båfs_•a˚_öfo
 *
d©a_söfo
;

178 
	`ASSERT
(
	`IS_ALIGNED
(
Àn
, 
fs_öfo
->
£˘‹size
));

180 
d©a_söfo
 = 
fs_öfo
->data_sinfo;

181 
	`båfs_•a˚_öfo_‰ì_byãs_may_u£
(
fs_öfo
, 
d©a_söfo
, 
Àn
);

182 
	}
}

191 
	$båfs_‰ì_ª£rved_d©a_•a˚
(
båfs_öode
 *
öode
,

192 
exã¡_ch™ge£t
 *
ª£rved
, 
u64
 
°¨t
, u64 
Àn
)

194 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

197 
Àn
 = 
	`round_up
(
°¨t
 +Üí, 
fs_öfo
->
£˘‹size
) -

198 
	`round_down
(
°¨t
, 
fs_öfo
->
£˘‹size
);

199 
°¨t
 = 
	`round_down
(°¨t, 
fs_öfo
->
£˘‹size
);

201 
	`båfs_‰ì_ª£rved_d©a_•a˚_noquŸa
(
fs_öfo
, 
Àn
);

202 
	`båfs_qgroup_‰ì_d©a
(
öode
, 
ª£rved
, 
°¨t
, 
Àn
, 
NULL
);

203 
	}
}

218 
	$båfs_öode_rsv_ªÀa£
(
båfs_öode
 *
öode
, 
boﬁ
 
qgroup_‰ì
)

220 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

221 
båfs_block_rsv
 *
block_rsv
 = &
öode
->block_rsv;

222 
u64
 
ªÀa£d
 = 0;

223 
u64
 
qgroup_to_ªÀa£
 = 0;

230 
ªÀa£d
 = 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, 
block_rsv
, 0,

231 &
qgroup_to_ªÀa£
);

232 i‡(
ªÀa£d
 > 0)

233 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, "delalloc",

234 
	`båfs_öo
(
öode
), 
ªÀa£d
, 0);

235 i‡(
qgroup_‰ì
)

236 
	`båfs_qgroup_‰ì_mëa_¥óŒoc
(
öode
->
roŸ
, 
qgroup_to_ªÀa£
);

238 
	`båfs_qgroup_c⁄vît_ª£rved_mëa
(
öode
->
roŸ
,

239 
qgroup_to_ªÀa£
);

240 
	}
}

242 
	$båfs_ˇlcuœã_öode_block_rsv_size
(
båfs_fs_öfo
 *
fs_öfo
,

243 
båfs_öode
 *
öode
)

245 
båfs_block_rsv
 *
block_rsv
 = &
öode
->block_rsv;

246 
u64
 
ª£rve_size
 = 0;

247 
u64
 
qgroup_rsv_size
 = 0;

248 
u64
 
csum_Àaves
;

249 
out°™dög_exã¡s
;

251 
	`lockdï_as£π_hñd
(&
öode
->
lock
);

252 
out°™dög_exã¡s
 = 
öode
->outstanding_extents;

258 i‡(
out°™dög_exã¡s
) {

259 
ª£rve_size
 = 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
,

260 
out°™dög_exã¡s
);

261 
ª£rve_size
 +
	`båfs_ˇlc_mëad©a_size
(
fs_öfo
, 1);

263 
csum_Àaves
 = 
	`båfs_csum_byãs_to_Àaves
(
fs_öfo
,

264 
öode
->
csum_byãs
);

265 
ª£rve_size
 +
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
,

266 
csum_Àaves
);

273 
qgroup_rsv_size
 = (
u64
)
out°™dög_exã¡s
 * 
fs_öfo
->
nodesize
;

275 
	`•ö_lock
(&
block_rsv
->
lock
);

276 
block_rsv
->
size
 = 
ª£rve_size
;

277 
block_rsv
->
qgroup_rsv_size
 = qgroup_rsv_size;

278 
	`•ö_u∆ock
(&
block_rsv
->
lock
);

279 
	}
}

281 
	$ˇlc_öode_ª£rv©i⁄s
(
båfs_fs_öfo
 *
fs_öfo
,

282 
u64
 
num_byãs
, u64 
disk_num_byãs
,

283 
u64
 *
mëa_ª£rve
, u64 *
qgroup_ª£rve
)

285 
u64
 
ƒ_exã¡s
 = 
	`cou¡_max_exã¡s
(
fs_öfo
, 
num_byãs
);

286 
u64
 
csum_Àaves
 = 
	`båfs_csum_byãs_to_Àaves
(
fs_öfo
, 
disk_num_byãs
);

287 
u64
 
öode_upd©e
 = 
	`båfs_ˇlc_mëad©a_size
(
fs_öfo
, 1);

289 *
mëa_ª£rve
 = 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
,

290 
ƒ_exã¡s
 + 
csum_Àaves
);

296 *
mëa_ª£rve
 +
öode_upd©e
;

297 *
qgroup_ª£rve
 = 
ƒ_exã¡s
 * 
fs_öfo
->
nodesize
;

298 
	}
}

300 
	$båfs_dñÆloc_ª£rve_mëad©a
(
båfs_öode
 *
öode
, 
u64
 
num_byãs
,

301 
u64
 
disk_num_byãs
, 
boﬁ
 
noÊush
)

303 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

304 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

305 
båfs_block_rsv
 *
block_rsv
 = &
öode
->block_rsv;

306 
u64
 
mëa_ª£rve
, 
qgroup_ª£rve
;

307 
ƒ_exã¡s
;

308 
båfs_ª£rve_Êush_íum
 
Êush
 = 
BTRFS_RESERVE_FLUSH_ALL
;

309 
ªt
 = 0;

320 i‡(
noÊush
 || 
	`båfs_is_‰ì_•a˚_öode
(
öode
)) {

321 
Êush
 = 
BTRFS_RESERVE_NO_FLUSH
;

323 i‡(
cuºít
->
jou∫Æ_öfo
)

324 
Êush
 = 
BTRFS_RESERVE_FLUSH_LIMIT
;

327 
num_byãs
 = 
	`ALIGN
“um_byãs, 
fs_öfo
->
£˘‹size
);

328 
disk_num_byãs
 = 
	`ALIGN
(disk_num_byãs, 
fs_öfo
->
£˘‹size
);

340 
	`ˇlc_öode_ª£rv©i⁄s
(
fs_öfo
, 
num_byãs
, 
disk_num_byãs
,

341 &
mëa_ª£rve
, &
qgroup_ª£rve
);

342 
ªt
 = 
	`båfs_qgroup_ª£rve_mëa_¥óŒoc
(
roŸ
, 
qgroup_ª£rve
, 
åue
,

343 
noÊush
);

344 i‡(
ªt
)

345  
ªt
;

346 
ªt
 = 
	`båfs_ª£rve_mëad©a_byãs
(
fs_öfo
, 
block_rsv
, 
mëa_ª£rve
, 
Êush
);

347 i‡(
ªt
) {

348 
	`båfs_qgroup_‰ì_mëa_¥óŒoc
(
roŸ
, 
qgroup_ª£rve
);

349  
ªt
;

358 
ƒ_exã¡s
 = 
	`cou¡_max_exã¡s
(
fs_öfo
, 
num_byãs
);

359 
	`•ö_lock
(&
öode
->
lock
);

360 
	`båfs_mod_out°™dög_exã¡s
(
öode
, 
ƒ_exã¡s
);

361 
öode
->
csum_byãs
 +
disk_num_byãs
;

362 
	`båfs_ˇlcuœã_öode_block_rsv_size
(
fs_öfo
, 
öode
);

363 
	`•ö_u∆ock
(&
öode
->
lock
);

366 
	`båfs_block_rsv_add_byãs
(
block_rsv
, 
mëa_ª£rve
, 
Ál£
);

367 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
roŸ
->
fs_öfo
, "delalloc",

368 
	`båfs_öo
(
öode
), 
mëa_ª£rve
, 1);

370 
	`•ö_lock
(&
block_rsv
->
lock
);

371 
block_rsv
->
qgroup_rsv_ª£rved
 +
qgroup_ª£rve
;

372 
	`•ö_u∆ock
(&
block_rsv
->
lock
);

375 
	}
}

388 
	$båfs_dñÆloc_ªÀa£_mëad©a
(
båfs_öode
 *
öode
, 
u64
 
num_byãs
,

389 
boﬁ
 
qgroup_‰ì
)

391 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

393 
num_byãs
 = 
	`ALIGN
“um_byãs, 
fs_öfo
->
£˘‹size
);

394 
	`•ö_lock
(&
öode
->
lock
);

395 
öode
->
csum_byãs
 -
num_byãs
;

396 
	`båfs_ˇlcuœã_öode_block_rsv_size
(
fs_öfo
, 
öode
);

397 
	`•ö_u∆ock
(&
öode
->
lock
);

399 i‡(
	`båfs_is_ã°ög
(
fs_öfo
))

402 
	`båfs_öode_rsv_ªÀa£
(
öode
, 
qgroup_‰ì
);

403 
	}
}

417 
	$båfs_dñÆloc_ªÀa£_exã¡s
(
båfs_öode
 *
öode
, 
u64
 
num_byãs
)

419 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

420 
num_exã¡s
;

422 
	`•ö_lock
(&
öode
->
lock
);

423 
num_exã¡s
 = 
	`cou¡_max_exã¡s
(
fs_öfo
, 
num_byãs
);

424 
	`båfs_mod_out°™dög_exã¡s
(
öode
, -
num_exã¡s
);

425 
	`båfs_ˇlcuœã_öode_block_rsv_size
(
fs_öfo
, 
öode
);

426 
	`•ö_u∆ock
(&
öode
->
lock
);

428 i‡(
	`båfs_is_ã°ög
(
fs_öfo
))

431 
	`båfs_öode_rsv_ªÀa£
(
öode
, 
åue
);

432 
	}
}

459 
	$båfs_dñÆloc_ª£rve_•a˚
(
båfs_öode
 *
öode
,

460 
exã¡_ch™ge£t
 **
ª£rved
, 
u64
 
°¨t
, u64 
Àn
)

462 
ªt
;

464 
ªt
 = 
	`båfs_check_d©a_‰ì_•a˚
(
öode
, 
ª£rved
, 
°¨t
, 
Àn
, 
Ál£
);

465 i‡(
ªt
 < 0)

466  
ªt
;

467 
ªt
 = 
	`båfs_dñÆloc_ª£rve_mëad©a
(
öode
, 
Àn
,Üí, 
Ál£
);

468 i‡(
ªt
 < 0) {

469 
	`båfs_‰ì_ª£rved_d©a_•a˚
(
öode
, *
ª£rved
, 
°¨t
, 
Àn
);

470 
	`exã¡_ch™ge£t_‰ì
(*
ª£rved
);

471 *
ª£rved
 = 
NULL
;

473  
ªt
;

474 
	}
}

490 
	$båfs_dñÆloc_ªÀa£_•a˚
(
båfs_öode
 *
öode
,

491 
exã¡_ch™ge£t
 *
ª£rved
,

492 
u64
 
°¨t
, u64 
Àn
, 
boﬁ
 
qgroup_‰ì
)

494 
	`båfs_dñÆloc_ªÀa£_mëad©a
(
öode
, 
Àn
, 
qgroup_‰ì
);

495 
	`båfs_‰ì_ª£rved_d©a_•a˚
(
öode
, 
ª£rved
, 
°¨t
, 
Àn
);

496 
	}
}

	@delalloc-space.h

3 #i‚de‡
BTRFS_DELALLOC_SPACE_H


4 
	#BTRFS_DELALLOC_SPACE_H


	)

6 
	gexã¡_ch™ge£t
;

8 
båfs_Æloc_d©a_chunk_⁄dem™d
(
båfs_öode
 *
öode
, 
u64
 
byãs
);

9 
båfs_check_d©a_‰ì_•a˚
(
båfs_öode
 *
öode
,

10 
exã¡_ch™ge£t
 **
ª£rved
, 
u64
 
°¨t
, u64 
Àn
,

11 
boﬁ
 
noÊush
);

12 
båfs_‰ì_ª£rved_d©a_•a˚
(
båfs_öode
 *
öode
,

13 
exã¡_ch™ge£t
 *
ª£rved
, 
u64
 
°¨t
, u64 
Àn
);

14 
båfs_dñÆloc_ªÀa£_•a˚
(
båfs_öode
 *
öode
,

15 
exã¡_ch™ge£t
 *
ª£rved
,

16 
u64
 
°¨t
, u64 
Àn
, 
boﬁ
 
qgroup_‰ì
);

17 
båfs_‰ì_ª£rved_d©a_•a˚_noquŸa
(
båfs_fs_öfo
 *
fs_öfo
,

18 
u64
 
Àn
);

19 
båfs_dñÆloc_ªÀa£_mëad©a
(
båfs_öode
 *
öode
, 
u64
 
num_byãs
,

20 
boﬁ
 
qgroup_‰ì
);

21 
båfs_dñÆloc_ª£rve_•a˚
(
båfs_öode
 *
öode
,

22 
exã¡_ch™ge£t
 **
ª£rved
, 
u64
 
°¨t
, u64 
Àn
);

23 
båfs_dñÆloc_ª£rve_mëad©a
(
båfs_öode
 *
öode
, 
u64
 
num_byãs
,

24 
u64
 
disk_num_byãs
, 
boﬁ
 
noÊush
);

25 
båfs_dñÆloc_ªÀa£_exã¡s
(
båfs_öode
 *
öode
, 
u64
 
num_byãs
);

	@delayed-inode.c

7 
	~<löux/¶ab.h
>

8 
	~<löux/ivîsi⁄.h
>

9 
	~"˘ªe.h
"

10 
	~"fs.h
"

11 
	~"mesßges.h
"

12 
	~"misc.h
"

13 
	~"dñayed-öode.h
"

14 
	~"disk-io.h
"

15 
	~"å™ß˘i⁄.h
"

16 
	~"qgroup.h
"

17 
	~"lockög.h
"

18 
	~"öode-ôem.h
"

19 
	~"•a˚-öfo.h
"

20 
	~"ac˚ss‹s.h
"

21 
	~"fûe-ôem.h
"

22 
	~"su≥r.h
"

24 
	#BTRFS_DELAYED_WRITEBACK
 512

	)

25 
	#BTRFS_DELAYED_BACKGROUND
 128

	)

26 
	#BTRFS_DELAYED_BATCH
 16

	)

28 
kmem_ˇche
 *
	gdñayed_node_ˇche
;

30 
__öô
 
	$båfs_dñayed_öode_öô
()

32 
dñayed_node_ˇche
 = 
	`kmem_ˇche_¸óã
("btrfs_delayed_node",

33 (
båfs_dñayed_node
),

35 
SLAB_MEM_SPREAD
,

36 
NULL
);

37 i‡(!
dñayed_node_ˇche
)

38  -
ENOMEM
;

40 
	}
}

42 
__cﬁd
 
	$båfs_dñayed_öode_exô
()

44 
	`kmem_ˇche_de°roy
(
dñayed_node_ˇche
);

45 
	}
}

47 
ölöe
 
	$båfs_öô_dñayed_node
(

48 
båfs_dñayed_node
 *
dñayed_node
,

49 
båfs_roŸ
 *
roŸ
, 
u64
 
öode_id
)

51 
dñayed_node
->
roŸ
 =Ñoot;

52 
dñayed_node
->
öode_id
 = inode_id;

53 
	`ªfcou¡_£t
(&
dñayed_node
->
ªfs
, 0);

54 
dñayed_node
->
ös_roŸ
 = 
RB_ROOT_CACHED
;

55 
dñayed_node
->
dñ_roŸ
 = 
RB_ROOT_CACHED
;

56 
	`muãx_öô
(&
dñayed_node
->
muãx
);

57 
	`INIT_LIST_HEAD
(&
dñayed_node
->
n_li°
);

58 
	`INIT_LIST_HEAD
(&
dñayed_node
->
p_li°
);

59 
	}
}

61 
båfs_dñayed_node
 *
	$båfs_gë_dñayed_node
(

62 
båfs_öode
 *btrfs_inode)

64 
båfs_roŸ
 *
roŸ
 = 
båfs_öode
->root;

65 
u64
 
öo
 = 
	`båfs_öo
(
båfs_öode
);

66 
båfs_dñayed_node
 *
node
;

68 
node
 = 
	`READ_ONCE
(
båfs_öode
->
dñayed_node
);

69 i‡(
node
) {

70 
	`ªfcou¡_öc
(&
node
->
ªfs
);

71  
node
;

74 
	`•ö_lock
(&
roŸ
->
öode_lock
);

75 
node
 = 
	`ødix_åì_lookup
(&
roŸ
->
dñayed_nodes_åì
, 
öo
);

77 i‡(
node
) {

78 i‡(
båfs_öode
->
dñayed_node
) {

79 
	`ªfcou¡_öc
(&
node
->
ªfs
);

80 
	`BUG_ON
(
båfs_öode
->
dñayed_node
 !
node
);

81 
	`•ö_u∆ock
(&
roŸ
->
öode_lock
);

82  
node
;

101 i‡(
	`ªfcou¡_öc_nŸ_zîo
(&
node
->
ªfs
)) {

102 
	`ªfcou¡_öc
(&
node
->
ªfs
);

103 
båfs_öode
->
dñayed_node
 = 
node
;

105 
node
 = 
NULL
;

108 
	`•ö_u∆ock
(&
roŸ
->
öode_lock
);

109  
node
;

111 
	`•ö_u∆ock
(&
roŸ
->
öode_lock
);

113  
NULL
;

114 
	}
}

117 
båfs_dñayed_node
 *
	$båfs_gë_‹_¸óã_dñayed_node
(

118 
båfs_öode
 *btrfs_inode)

120 
båfs_dñayed_node
 *
node
;

121 
båfs_roŸ
 *
roŸ
 = 
båfs_öode
->root;

122 
u64
 
öo
 = 
	`båfs_öo
(
båfs_öode
);

123 
ªt
;

125 
agaö
:

126 
node
 = 
	`båfs_gë_dñayed_node
(
båfs_öode
);

127 i‡(
node
)

128  
node
;

130 
node
 = 
	`kmem_ˇche_zÆloc
(
dñayed_node_ˇche
, 
GFP_NOFS
);

131 i‡(!
node
)

132  
	`ERR_PTR
(-
ENOMEM
);

133 
	`båfs_öô_dñayed_node
(
node
, 
roŸ
, 
öo
);

136 
	`ªfcou¡_£t
(&
node
->
ªfs
, 2);

138 
ªt
 = 
	`ødix_åì_¥ñﬂd
(
GFP_NOFS
);

139 i‡(
ªt
) {

140 
	`kmem_ˇche_‰ì
(
dñayed_node_ˇche
, 
node
);

141  
	`ERR_PTR
(
ªt
);

144 
	`•ö_lock
(&
roŸ
->
öode_lock
);

145 
ªt
 = 
	`ødix_åì_ö£π
(&
roŸ
->
dñayed_nodes_åì
, 
öo
, 
node
);

146 i‡(
ªt
 =-
EEXIST
) {

147 
	`•ö_u∆ock
(&
roŸ
->
öode_lock
);

148 
	`kmem_ˇche_‰ì
(
dñayed_node_ˇche
, 
node
);

149 
	`ødix_åì_¥ñﬂd_íd
();

150 
agaö
;

152 
båfs_öode
->
dñayed_node
 = 
node
;

153 
	`•ö_u∆ock
(&
roŸ
->
öode_lock
);

154 
	`ødix_åì_¥ñﬂd_íd
();

156  
node
;

157 
	}
}

164 
	$båfs_queue_dñayed_node
(
båfs_dñayed_roŸ
 *
roŸ
,

165 
båfs_dñayed_node
 *
node
,

166 
mod
)

168 
	`•ö_lock
(&
roŸ
->
lock
);

169 i‡(
	`ã°_bô
(
BTRFS_DELAYED_NODE_IN_LIST
, &
node
->
Êags
)) {

170 i‡(!
	`li°_em±y
(&
node
->
p_li°
))

171 
	`li°_move_èû
(&
node
->
p_li°
, &
roŸ
->
¥ï¨e_li°
);

172 i‡(
mod
)

173 
	`li°_add_èû
(&
node
->
p_li°
, &
roŸ
->
¥ï¨e_li°
);

175 
	`li°_add_èû
(&
node
->
n_li°
, &
roŸ
->
node_li°
);

176 
	`li°_add_èû
(&
node
->
p_li°
, &
roŸ
->
¥ï¨e_li°
);

177 
	`ªfcou¡_öc
(&
node
->
ªfs
);

178 
roŸ
->
nodes
++;

179 
	`£t_bô
(
BTRFS_DELAYED_NODE_IN_LIST
, &
node
->
Êags
);

181 
	`•ö_u∆ock
(&
roŸ
->
lock
);

182 
	}
}

185 
	$båfs_dequeue_dñayed_node
(
båfs_dñayed_roŸ
 *
roŸ
,

186 
båfs_dñayed_node
 *
node
)

188 
	`•ö_lock
(&
roŸ
->
lock
);

189 i‡(
	`ã°_bô
(
BTRFS_DELAYED_NODE_IN_LIST
, &
node
->
Êags
)) {

190 
roŸ
->
nodes
--;

191 
	`ªfcou¡_dec
(&
node
->
ªfs
);

192 
	`li°_dñ_öô
(&
node
->
n_li°
);

193 i‡(!
	`li°_em±y
(&
node
->
p_li°
))

194 
	`li°_dñ_öô
(&
node
->
p_li°
);

195 
	`˛ór_bô
(
BTRFS_DELAYED_NODE_IN_LIST
, &
node
->
Êags
);

197 
	`•ö_u∆ock
(&
roŸ
->
lock
);

198 
	}
}

200 
båfs_dñayed_node
 *
	$båfs_fú°_dñayed_node
(

201 
båfs_dñayed_roŸ
 *
dñayed_roŸ
)

203 
li°_hód
 *
p
;

204 
båfs_dñayed_node
 *
node
 = 
NULL
;

206 
	`•ö_lock
(&
dñayed_roŸ
->
lock
);

207 i‡(
	`li°_em±y
(&
dñayed_roŸ
->
node_li°
))

208 
out
;

210 
p
 = 
dñayed_roŸ
->
node_li°
.
√xt
;

211 
node
 = 
	`li°_íåy
(
p
, 
båfs_dñayed_node
, 
n_li°
);

212 
	`ªfcou¡_öc
(&
node
->
ªfs
);

213 
out
:

214 
	`•ö_u∆ock
(&
dñayed_roŸ
->
lock
);

216  
node
;

217 
	}
}

219 
båfs_dñayed_node
 *
	$båfs_√xt_dñayed_node
(

220 
båfs_dñayed_node
 *
node
)

222 
båfs_dñayed_roŸ
 *
dñayed_roŸ
;

223 
li°_hód
 *
p
;

224 
båfs_dñayed_node
 *
√xt
 = 
NULL
;

226 
dñayed_roŸ
 = 
node
->
roŸ
->
fs_öfo
->delayed_root;

227 
	`•ö_lock
(&
dñayed_roŸ
->
lock
);

228 i‡(!
	`ã°_bô
(
BTRFS_DELAYED_NODE_IN_LIST
, &
node
->
Êags
)) {

230 i‡(
	`li°_em±y
(&
dñayed_roŸ
->
node_li°
))

231 
out
;

232 
p
 = 
dñayed_roŸ
->
node_li°
.
√xt
;

233 } i‡(
	`li°_is_œ°
(&
node
->
n_li°
, &
dñayed_roŸ
->
node_li°
))

234 
out
;

236 
p
 = 
node
->
n_li°
.
√xt
;

238 
√xt
 = 
	`li°_íåy
(
p
, 
båfs_dñayed_node
, 
n_li°
);

239 
	`ªfcou¡_öc
(&
√xt
->
ªfs
);

240 
out
:

241 
	`•ö_u∆ock
(&
dñayed_roŸ
->
lock
);

243  
√xt
;

244 
	}
}

246 
	$__båfs_ªÀa£_dñayed_node
(

247 
båfs_dñayed_node
 *
dñayed_node
,

248 
mod
)

250 
båfs_dñayed_roŸ
 *
dñayed_roŸ
;

252 i‡(!
dñayed_node
)

255 
dñayed_roŸ
 = 
dñayed_node
->
roŸ
->
fs_öfo
->delayed_root;

257 
	`muãx_lock
(&
dñayed_node
->
muãx
);

258 i‡(
dñayed_node
->
cou¡
)

259 
	`båfs_queue_dñayed_node
(
dñayed_roŸ
, 
dñayed_node
, 
mod
);

261 
	`båfs_dequeue_dñayed_node
(
dñayed_roŸ
, 
dñayed_node
);

262 
	`muãx_u∆ock
(&
dñayed_node
->
muãx
);

264 i‡(
	`ªfcou¡_dec_™d_ã°
(&
dñayed_node
->
ªfs
)) {

265 
båfs_roŸ
 *
roŸ
 = 
dñayed_node
->root;

267 
	`•ö_lock
(&
roŸ
->
öode_lock
);

272 
	`ASSERT
(
	`ªfcou¡_ªad
(&
dñayed_node
->
ªfs
) == 0);

273 
	`ødix_åì_dñëe
(&
roŸ
->
dñayed_nodes_åì
,

274 
dñayed_node
->
öode_id
);

275 
	`•ö_u∆ock
(&
roŸ
->
öode_lock
);

276 
	`kmem_ˇche_‰ì
(
dñayed_node_ˇche
, 
dñayed_node
);

278 
	}
}

280 
ölöe
 
	$båfs_ªÀa£_dñayed_node
(
båfs_dñayed_node
 *
node
)

282 
	`__båfs_ªÀa£_dñayed_node
(
node
, 0);

283 
	}
}

285 
båfs_dñayed_node
 *
	$båfs_fú°_¥ï¨ed_dñayed_node
(

286 
båfs_dñayed_roŸ
 *
dñayed_roŸ
)

288 
li°_hód
 *
p
;

289 
båfs_dñayed_node
 *
node
 = 
NULL
;

291 
	`•ö_lock
(&
dñayed_roŸ
->
lock
);

292 i‡(
	`li°_em±y
(&
dñayed_roŸ
->
¥ï¨e_li°
))

293 
out
;

295 
p
 = 
dñayed_roŸ
->
¥ï¨e_li°
.
√xt
;

296 
	`li°_dñ_öô
(
p
);

297 
node
 = 
	`li°_íåy
(
p
, 
båfs_dñayed_node
, 
p_li°
);

298 
	`ªfcou¡_öc
(&
node
->
ªfs
);

299 
out
:

300 
	`•ö_u∆ock
(&
dñayed_roŸ
->
lock
);

302  
node
;

303 
	}
}

305 
ölöe
 
	$båfs_ªÀa£_¥ï¨ed_dñayed_node
(

306 
båfs_dñayed_node
 *
node
)

308 
	`__båfs_ªÀa£_dñayed_node
(
node
, 1);

309 
	}
}

311 
båfs_dñayed_ôem
 *
	$båfs_Æloc_dñayed_ôem
(
u16
 
d©a_Àn
,

312 
båfs_dñayed_node
 *
node
,

313 
båfs_dñayed_ôem_ty≥
 
ty≥
)

315 
båfs_dñayed_ôem
 *
ôem
;

317 
ôem
 = 
	`kmÆloc
(
	`°ru˘_size
(ôem, 
d©a
, 
d©a_Àn
), 
GFP_NOFS
);

318 i‡(
ôem
) {

319 
ôem
->
d©a_Àn
 = data_len;

320 
ôem
->
ty≥
 =Åype;

321 
ôem
->
byãs_ª£rved
 = 0;

322 
ôem
->
dñayed_node
 = 
node
;

323 
	`RB_CLEAR_NODE
(&
ôem
->
rb_node
);

324 
	`INIT_LIST_HEAD
(&
ôem
->
log_li°
);

325 
ôem
->
logged
 = 
Ál£
;

326 
	`ªfcou¡_£t
(&
ôem
->
ªfs
, 1);

328  
ôem
;

329 
	}
}

339 
båfs_dñayed_ôem
 *
	$__båfs_lookup_dñayed_ôem
(

340 
rb_roŸ
 *
roŸ
,

341 
u64
 
ödex
)

343 
rb_node
 *
node
 = 
roŸ
->rb_node;

344 
båfs_dñayed_ôem
 *
dñayed_ôem
 = 
NULL
;

346 
node
) {

347 
dñayed_ôem
 = 
	`rb_íåy
(
node
, 
båfs_dñayed_ôem
,

348 
rb_node
);

349 i‡(
dñayed_ôem
->
ödex
 < index)

350 
node
 =Çode->
rb_right
;

351 i‡(
dñayed_ôem
->
ödex
 > index)

352 
node
 =Çode->
rb_À·
;

354  
dñayed_ôem
;

357  
NULL
;

358 
	}
}

360 
	$__båfs_add_dñayed_ôem
(
båfs_dñayed_node
 *
dñayed_node
,

361 
båfs_dñayed_ôem
 *
ös
)

363 
rb_node
 **
p
, *
node
;

364 
rb_node
 *
∑ª¡_node
 = 
NULL
;

365 
rb_roŸ_ˇched
 *
roŸ
;

366 
båfs_dñayed_ôem
 *
ôem
;

367 
boﬁ
 
À·mo°
 = 
åue
;

369 i‡(
ös
->
ty≥
 =
BTRFS_DELAYED_INSERTION_ITEM
)

370 
roŸ
 = &
dñayed_node
->
ös_roŸ
;

372 
roŸ
 = &
dñayed_node
->
dñ_roŸ
;

374 
p
 = &
roŸ
->
rb_roŸ
.
rb_node
;

375 
node
 = &
ös
->
rb_node
;

377 *
p
) {

378 
∑ª¡_node
 = *
p
;

379 
ôem
 = 
	`rb_íåy
(
∑ª¡_node
, 
båfs_dñayed_ôem
,

380 
rb_node
);

382 i‡(
ôem
->
ödex
 < 
ös
->index) {

383 
p
 = &(*p)->
rb_right
;

384 
À·mo°
 = 
Ál£
;

385 } i‡(
ôem
->
ödex
 > 
ös
->index) {

386 
p
 = &(*p)->
rb_À·
;

388  -
EEXIST
;

392 
	`rb_lök_node
(
node
, 
∑ª¡_node
, 
p
);

393 
	`rb_ö£π_cﬁ‹_ˇched
(
node
, 
roŸ
, 
À·mo°
);

395 i‡(
ös
->
ty≥
 =
BTRFS_DELAYED_INSERTION_ITEM
 &&

396 
ös
->
ödex
 >
dñayed_node
->
ödex_˙t
)

397 
dñayed_node
->
ödex_˙t
 = 
ös
->
ödex
 + 1;

399 
dñayed_node
->
cou¡
++;

400 
	`©omic_öc
(&
dñayed_node
->
roŸ
->
fs_öfo
->
dñayed_roŸ
->
ôems
);

402 
	}
}

404 
	$föish_⁄e_ôem
(
båfs_dñayed_roŸ
 *
dñayed_roŸ
)

406 
£q
 = 
	`©omic_öc_ªtu∫
(&
dñayed_roŸ
->
ôems_£q
);

409 i‡((
	`©omic_dec_ªtu∫
(&
dñayed_roŸ
->
ôems
) <

410 
BTRFS_DELAYED_BACKGROUND
 || 
£q
 % 
BTRFS_DELAYED_BATCH
 == 0))

411 
	`c⁄d_wake_up_nomb
(&
dñayed_roŸ
->
waô
);

412 
	}
}

414 
	$__båfs_ªmove_dñayed_ôem
(
båfs_dñayed_ôem
 *
dñayed_ôem
)

416 
båfs_dñayed_node
 *
dñayed_node
 = 
dñayed_ôem
->delayed_node;

417 
rb_roŸ_ˇched
 *
roŸ
;

418 
båfs_dñayed_roŸ
 *
dñayed_roŸ
;

421 i‡(
	`RB_EMPTY_NODE
(&
dñayed_ôem
->
rb_node
))

425 
	`lockdï_as£π_hñd
(&
dñayed_node
->
muãx
);

427 
dñayed_roŸ
 = 
dñayed_node
->
roŸ
->
fs_öfo
->delayed_root;

429 
	`BUG_ON
(!
dñayed_roŸ
);

431 i‡(
dñayed_ôem
->
ty≥
 =
BTRFS_DELAYED_INSERTION_ITEM
)

432 
roŸ
 = &
dñayed_node
->
ös_roŸ
;

434 
roŸ
 = &
dñayed_node
->
dñ_roŸ
;

436 
	`rb_îa£_ˇched
(&
dñayed_ôem
->
rb_node
, 
roŸ
);

437 
	`RB_CLEAR_NODE
(&
dñayed_ôem
->
rb_node
);

438 
dñayed_node
->
cou¡
--;

440 
	`föish_⁄e_ôem
(
dñayed_roŸ
);

441 
	}
}

443 
	$båfs_ªÀa£_dñayed_ôem
(
båfs_dñayed_ôem
 *
ôem
)

445 i‡(
ôem
) {

446 
	`__båfs_ªmove_dñayed_ôem
(
ôem
);

447 i‡(
	`ªfcou¡_dec_™d_ã°
(&
ôem
->
ªfs
))

448 
	`k‰ì
(
ôem
);

450 
	}
}

452 
båfs_dñayed_ôem
 *
	$__båfs_fú°_dñayed_ö£πi⁄_ôem
(

453 
båfs_dñayed_node
 *
dñayed_node
)

455 
rb_node
 *
p
;

456 
båfs_dñayed_ôem
 *
ôem
 = 
NULL
;

458 
p
 = 
	`rb_fú°_ˇched
(&
dñayed_node
->
ös_roŸ
);

459 i‡(
p
)

460 
ôem
 = 
	`rb_íåy
(
p
, 
båfs_dñayed_ôem
, 
rb_node
);

462  
ôem
;

463 
	}
}

465 
båfs_dñayed_ôem
 *
	$__båfs_fú°_dñayed_dñëi⁄_ôem
(

466 
båfs_dñayed_node
 *
dñayed_node
)

468 
rb_node
 *
p
;

469 
båfs_dñayed_ôem
 *
ôem
 = 
NULL
;

471 
p
 = 
	`rb_fú°_ˇched
(&
dñayed_node
->
dñ_roŸ
);

472 i‡(
p
)

473 
ôem
 = 
	`rb_íåy
(
p
, 
båfs_dñayed_ôem
, 
rb_node
);

475  
ôem
;

476 
	}
}

478 
båfs_dñayed_ôem
 *
	$__båfs_√xt_dñayed_ôem
(

479 
båfs_dñayed_ôem
 *
ôem
)

481 
rb_node
 *
p
;

482 
båfs_dñayed_ôem
 *
√xt
 = 
NULL
;

484 
p
 = 
	`rb_√xt
(&
ôem
->
rb_node
);

485 i‡(
p
)

486 
√xt
 = 
	`rb_íåy
(
p
, 
båfs_dñayed_ôem
, 
rb_node
);

488  
√xt
;

489 
	}
}

491 
	$båfs_dñayed_ôem_ª£rve_mëad©a
(
båfs_å™s_h™dÀ
 *
å™s
,

492 
båfs_dñayed_ôem
 *
ôem
)

494 
båfs_block_rsv
 *
§c_rsv
;

495 
båfs_block_rsv
 *
d°_rsv
;

496 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

497 
u64
 
num_byãs
;

498 
ªt
;

500 i‡(!
å™s
->
byãs_ª£rved
)

503 
§c_rsv
 = 
å™s
->
block_rsv
;

504 
d°_rsv
 = &
fs_öfo
->
dñayed_block_rsv
;

506 
num_byãs
 = 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
, 1);

513 
ªt
 = 
	`båfs_block_rsv_migøã
(
§c_rsv
, 
d°_rsv
, 
num_byãs
, 
åue
);

514 i‡(!
ªt
) {

515 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, "delayed_item",

516 
ôem
->
dñayed_node
->
öode_id
,

517 
num_byãs
, 1);

523 i‡(
ôem
->
ty≥
 =
BTRFS_DELAYED_DELETION_ITEM
)

524 
ôem
->
byãs_ª£rved
 = 
num_byãs
;

527  
ªt
;

528 
	}
}

530 
	$båfs_dñayed_ôem_ªÀa£_mëad©a
(
båfs_roŸ
 *
roŸ
,

531 
båfs_dñayed_ôem
 *
ôem
)

533 
båfs_block_rsv
 *
rsv
;

534 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

536 i‡(!
ôem
->
byãs_ª£rved
)

539 
rsv
 = &
fs_öfo
->
dñayed_block_rsv
;

544 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, "delayed_item",

545 
ôem
->
dñayed_node
->
öode_id
,

546 
ôem
->
byãs_ª£rved
, 0);

547 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, 
rsv
, 
ôem
->
byãs_ª£rved
, 
NULL
);

548 
	}
}

550 
	$båfs_dñayed_ôem_ªÀa£_Àaves
(
båfs_dñayed_node
 *
node
,

551 
num_Àaves
)

553 
båfs_fs_öfo
 *
fs_öfo
 = 
node
->
roŸ
->fs_info;

554 c⁄° 
u64
 
byãs
 = 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
, 
num_Àaves
);

557 i‡(
	`ã°_bô
(
BTRFS_FS_LOG_RECOVERING
, &
fs_öfo
->
Êags
))

560 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, "dñayed_ôem", 
node
->
öode_id
,

561 
byãs
, 0);

562 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, &fs_öfo->
dñayed_block_rsv
, 
byãs
, 
NULL
);

563 
	}
}

565 
	$båfs_dñayed_öode_ª£rve_mëad©a
(

566 
båfs_å™s_h™dÀ
 *
å™s
,

567 
båfs_roŸ
 *
roŸ
,

568 
båfs_dñayed_node
 *
node
)

570 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

571 
båfs_block_rsv
 *
§c_rsv
;

572 
båfs_block_rsv
 *
d°_rsv
;

573 
u64
 
num_byãs
;

574 
ªt
;

576 
§c_rsv
 = 
å™s
->
block_rsv
;

577 
d°_rsv
 = &
fs_öfo
->
dñayed_block_rsv
;

579 
num_byãs
 = 
	`båfs_ˇlc_mëad©a_size
(
fs_öfo
, 1);

590 i‡(!
§c_rsv
 || (!
å™s
->
byãs_ª£rved
 &&

591 
§c_rsv
->
ty≥
 !
BTRFS_BLOCK_RSV_DELALLOC
)) {

592 
ªt
 = 
	`båfs_qgroup_ª£rve_mëa
(
roŸ
, 
num_byãs
,

593 
BTRFS_QGROUP_RSV_META_PREALLOC
, 
åue
);

594 i‡(
ªt
 < 0)

595  
ªt
;

596 
ªt
 = 
	`båfs_block_rsv_add
(
fs_öfo
, 
d°_rsv
, 
num_byãs
,

597 
BTRFS_RESERVE_NO_FLUSH
);

599 
	`ASSERT
(
ªt
 =0 ||Ñë =-
ENOSPC
);

600 i‡(
ªt
)

601 
	`båfs_qgroup_‰ì_mëa_¥óŒoc
(
roŸ
, 
num_byãs
);

603 
ªt
 = 
	`båfs_block_rsv_migøã
(
§c_rsv
, 
d°_rsv
, 
num_byãs
, 
åue
);

606 i‡(!
ªt
) {

607 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, "delayed_inode",

608 
node
->
öode_id
, 
num_byãs
, 1);

609 
node
->
byãs_ª£rved
 = 
num_byãs
;

612  
ªt
;

613 
	}
}

615 
	$båfs_dñayed_öode_ªÀa£_mëad©a
(
båfs_fs_öfo
 *
fs_öfo
,

616 
båfs_dñayed_node
 *
node
,

617 
boﬁ
 
qgroup_‰ì
)

619 
båfs_block_rsv
 *
rsv
;

621 i‡(!
node
->
byãs_ª£rved
)

624 
rsv
 = &
fs_öfo
->
dñayed_block_rsv
;

625 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, "delayed_inode",

626 
node
->
öode_id
,Çode->
byãs_ª£rved
, 0);

627 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, 
rsv
, 
node
->
byãs_ª£rved
, 
NULL
);

628 i‡(
qgroup_‰ì
)

629 
	`båfs_qgroup_‰ì_mëa_¥óŒoc
(
node
->
roŸ
,

630 
node
->
byãs_ª£rved
);

632 
	`båfs_qgroup_c⁄vît_ª£rved_mëa
(
node
->
roŸ
,

633 
node
->
byãs_ª£rved
);

634 
node
->
byãs_ª£rved
 = 0;

635 
	}
}

647 
	$båfs_ö£π_dñayed_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

648 
båfs_roŸ
 *
roŸ
,

649 
båfs_∑th
 *
∑th
,

650 
båfs_dñayed_ôem
 *
fú°_ôem
)

652 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

653 
båfs_dñayed_node
 *
node
 = 
fú°_ôem
->
dñayed_node
;

654 
	`LIST_HEAD
(
ôem_li°
);

655 
båfs_dñayed_ôem
 *
cuº
;

656 
båfs_dñayed_ôem
 *
√xt
;

657 c⁄° 
max_size
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
);

658 
båfs_ôem_b©ch
 
b©ch
;

659 
båfs_key
 
fú°_key
;

660 c⁄° 
u32
 
fú°_d©a_size
 = 
fú°_ôem
->
d©a_Àn
;

661 
tŸÆ_size
;

662 *
ös_d©a
 = 
NULL
;

663 
ªt
;

664 
boﬁ
 
c⁄töuous_keys_⁄ly
 = 
Ál£
;

666 
	`lockdï_as£π_hñd
(&
node
->
muãx
);

677 i‡(
	`ã°_bô
(
BTRFS_FS_LOG_RECOVERING
, &
fs_öfo
->
Êags
))

678 
c⁄töuous_keys_⁄ly
 = 
åue
;

686 
	`ASSERT
(
fú°_ôem
->
byãs_ª£rved
 == 0);

688 
	`li°_add_èû
(&
fú°_ôem
->
åì_li°
, &
ôem_li°
);

689 
b©ch
.
tŸÆ_d©a_size
 = 
fú°_d©a_size
;

690 
b©ch
.
ƒ
 = 1;

691 
tŸÆ_size
 = 
fú°_d©a_size
 + (
båfs_ôem
);

692 
cuº
 = 
fú°_ôem
;

694 
åue
) {

695 
√xt_size
;

697 
√xt
 = 
	`__båfs_√xt_dñayed_ôem
(
cuº
);

698 i‡(!
√xt
)

705 i‡(
c⁄töuous_keys_⁄ly
 && (
√xt
->
ödex
 !
cuº
->index + 1))

708 
	`ASSERT
(
√xt
->
byãs_ª£rved
 == 0);

710 
√xt_size
 = 
√xt
->
d©a_Àn
 + (
båfs_ôem
);

711 i‡(
tŸÆ_size
 + 
√xt_size
 > 
max_size
)

714 
	`li°_add_èû
(&
√xt
->
åì_li°
, &
ôem_li°
);

715 
b©ch
.
ƒ
++;

716 
tŸÆ_size
 +
√xt_size
;

717 
b©ch
.
tŸÆ_d©a_size
 +
√xt
->
d©a_Àn
;

718 
cuº
 = 
√xt
;

721 i‡(
b©ch
.
ƒ
 == 1) {

722 
fú°_key
.
obje˘id
 = 
node
->
öode_id
;

723 
fú°_key
.
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

724 
fú°_key
.
off£t
 = 
fú°_ôem
->
ödex
;

725 
b©ch
.
keys
 = &
fú°_key
;

726 
b©ch
.
d©a_sizes
 = &
fú°_d©a_size
;

728 
båfs_key
 *
ös_keys
;

729 
u32
 *
ös_sizes
;

730 
i
 = 0;

732 
ös_d©a
 = 
	`kmÆloc
(
b©ch
.
ƒ
 * (
u32
) +

733 
b©ch
.
ƒ
 * (
båfs_key
), 
GFP_NOFS
);

734 i‡(!
ös_d©a
) {

735 
ªt
 = -
ENOMEM
;

736 
out
;

738 
ös_sizes
 = (
u32
 *)
ös_d©a
;

739 
ös_keys
 = (
båfs_key
 *)(
ös_d©a
 + 
b©ch
.
ƒ
 * (
u32
));

740 
b©ch
.
keys
 = 
ös_keys
;

741 
b©ch
.
d©a_sizes
 = 
ös_sizes
;

742 
	`li°_f‹_óch_íåy
(
cuº
, &
ôem_li°
, 
åì_li°
) {

743 
ös_keys
[
i
].
obje˘id
 = 
node
->
öode_id
;

744 
ös_keys
[
i
].
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

745 
ös_keys
[
i
].
off£t
 = 
cuº
->
ödex
;

746 
ös_sizes
[
i
] = 
cuº
->
d©a_Àn
;

747 
i
++;

751 
ªt
 = 
	`båfs_ö£π_em±y_ôems
(
å™s
, 
roŸ
, 
∑th
, &
b©ch
);

752 i‡(
ªt
)

753 
out
;

755 
	`li°_f‹_óch_íåy
(
cuº
, &
ôem_li°
, 
åì_li°
) {

756 *
d©a_±r
;

758 
d©a_±r
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0], );

759 
	`wrôe_exã¡_buf„r
(
∑th
->
nodes
[0], &
cuº
->
d©a
,

760 ()
d©a_±r
, 
cuº
->
d©a_Àn
);

761 
∑th
->
¶Ÿs
[0]++;

769 
	`båfs_ªÀa£_∑th
(
∑th
);

771 
	`ASSERT
(
node
->
ödex_ôem_Àaves
 > 0);

783 i‡(
√xt
 && !
c⁄töuous_keys_⁄ly
) {

790 
	`båfs_dñayed_ôem_ªÀa£_Àaves
(
node
, 1);

791 
node
->
ödex_ôem_Àaves
--;

792 } i‡(!
√xt
) {

800 
	`båfs_dñayed_ôem_ªÀa£_Àaves
(
node
,Çode->
ödex_ôem_Àaves
);

801 
node
->
ödex_ôem_Àaves
 = 0;

804 
	`li°_f‹_óch_íåy_ß„
(
cuº
, 
√xt
, &
ôem_li°
, 
åì_li°
) {

805 
	`li°_dñ
(&
cuº
->
åì_li°
);

806 
	`båfs_ªÀa£_dñayed_ôem
(
cuº
);

808 
out
:

809 
	`k‰ì
(
ös_d©a
);

810  
ªt
;

811 
	}
}

813 
	$båfs_ö£π_dñayed_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

814 
båfs_∑th
 *
∑th
,

815 
båfs_roŸ
 *
roŸ
,

816 
båfs_dñayed_node
 *
node
)

818 
ªt
 = 0;

820 
ªt
 == 0) {

821 
båfs_dñayed_ôem
 *
cuº
;

823 
	`muãx_lock
(&
node
->
muãx
);

824 
cuº
 = 
	`__båfs_fú°_dñayed_ö£πi⁄_ôem
(
node
);

825 i‡(!
cuº
) {

826 
	`muãx_u∆ock
(&
node
->
muãx
);

829 
ªt
 = 
	`båfs_ö£π_dñayed_ôem
(
å™s
, 
roŸ
, 
∑th
, 
cuº
);

830 
	`muãx_u∆ock
(&
node
->
muãx
);

833  
ªt
;

834 
	}
}

836 
	$båfs_b©ch_dñëe_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

837 
båfs_roŸ
 *
roŸ
,

838 
båfs_∑th
 *
∑th
,

839 
båfs_dñayed_ôem
 *
ôem
)

841 c⁄° 
u64
 
öo
 = 
ôem
->
dñayed_node
->
öode_id
;

842 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

843 
båfs_dñayed_ôem
 *
cuº
, *
√xt
;

844 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

845 
	`LIST_HEAD
(
b©ch_li°
);

846 
nôems
, 
¶Ÿ
, 
œ°_¶Ÿ
;

847 
ªt
;

848 
u64
 
tŸÆ_ª£rved_size
 = 
ôem
->
byãs_ª£rved
;

850 
	`ASSERT
(
Àaf
 !
NULL
);

852 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

853 
œ°_¶Ÿ
 = 
	`båfs_hódî_ƒôems
(
Àaf
) - 1;

858 
	`ASSERT
(
¶Ÿ
 <
œ°_¶Ÿ
);

859 i‡(
	`WARN_ON
(
¶Ÿ
 > 
œ°_¶Ÿ
))

860  -
ENOENT
;

862 
nôems
 = 1;

863 
cuº
 = 
ôem
;

864 
	`li°_add_èû
(&
cuº
->
åì_li°
, &
b©ch_li°
);

871 
¶Ÿ
 < 
œ°_¶Ÿ
) {

872 
båfs_key
 
key
;

874 
√xt
 = 
	`__båfs_√xt_dñayed_ôem
(
cuº
);

875 i‡(!
√xt
)

878 
¶Ÿ
++;

879 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

880 i‡(
key
.
obje˘id
 !
öo
 ||

881 
key
.
ty≥
 !
BTRFS_DIR_INDEX_KEY
 ||

882 
key
.
off£t
 !
√xt
->
ödex
)

884 
nôems
++;

885 
cuº
 = 
√xt
;

886 
	`li°_add_èû
(&
cuº
->
åì_li°
, &
b©ch_li°
);

887 
tŸÆ_ª£rved_size
 +
cuº
->
byãs_ª£rved
;

890 
ªt
 = 
	`båfs_dñ_ôems
(
å™s
, 
roŸ
, 
∑th
,Ö©h->
¶Ÿs
[0], 
nôems
);

891 i‡(
ªt
)

892  
ªt
;

895 i‡(
tŸÆ_ª£rved_size
 > 0) {

900 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, "dñayed_ôem", 
öo
,

901 
tŸÆ_ª£rved_size
, 0);

902 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, &fs_öfo->
dñayed_block_rsv
,

903 
tŸÆ_ª£rved_size
, 
NULL
);

906 
	`li°_f‹_óch_íåy_ß„
(
cuº
, 
√xt
, &
b©ch_li°
, 
åì_li°
) {

907 
	`li°_dñ
(&
cuº
->
åì_li°
);

908 
	`båfs_ªÀa£_dñayed_ôem
(
cuº
);

912 
	}
}

914 
	$båfs_dñëe_dñayed_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

915 
båfs_∑th
 *
∑th
,

916 
båfs_roŸ
 *
roŸ
,

917 
båfs_dñayed_node
 *
node
)

919 
båfs_key
 
key
;

920 
ªt
 = 0;

922 
key
.
obje˘id
 = 
node
->
öode_id
;

923 
key
.
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

925 
ªt
 == 0) {

926 
båfs_dñayed_ôem
 *
ôem
;

928 
	`muãx_lock
(&
node
->
muãx
);

929 
ôem
 = 
	`__båfs_fú°_dñayed_dñëi⁄_ôem
(
node
);

930 i‡(!
ôem
) {

931 
	`muãx_u∆ock
(&
node
->
muãx
);

935 
key
.
off£t
 = 
ôem
->
ödex
;

936 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

937 i‡(
ªt
 > 0) {

952 
	`båfs_ªÀa£_∑th
(
∑th
);

953 
	`båfs_ªÀa£_dñayed_ôem
(
ôem
);

954 
ªt
 = 0;

955 } i‡(
ªt
 == 0) {

956 
ªt
 = 
	`båfs_b©ch_dñëe_ôems
(
å™s
, 
roŸ
, 
∑th
, 
ôem
);

957 
	`båfs_ªÀa£_∑th
(
∑th
);

967 
	`muãx_u∆ock
(&
node
->
muãx
);

970  
ªt
;

971 
	}
}

973 
	$båfs_ªÀa£_dñayed_öode
(
båfs_dñayed_node
 *
dñayed_node
)

975 
båfs_dñayed_roŸ
 *
dñayed_roŸ
;

977 i‡(
dñayed_node
 &&

978 
	`ã°_bô
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
dñayed_node
->
Êags
)) {

979 
	`BUG_ON
(!
dñayed_node
->
roŸ
);

980 
	`˛ór_bô
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
dñayed_node
->
Êags
);

981 
dñayed_node
->
cou¡
--;

983 
dñayed_roŸ
 = 
dñayed_node
->
roŸ
->
fs_öfo
->delayed_root;

984 
	`föish_⁄e_ôem
(
dñayed_roŸ
);

986 
	}
}

988 
	$båfs_ªÀa£_dñayed_úef
(
båfs_dñayed_node
 *
dñayed_node
)

991 i‡(
	`ã°_™d_˛ór_bô
(
BTRFS_DELAYED_NODE_DEL_IREF
, &
dñayed_node
->
Êags
)) {

992 
båfs_dñayed_roŸ
 *
dñayed_roŸ
;

994 
	`ASSERT
(
dñayed_node
->
roŸ
);

995 
dñayed_node
->
cou¡
--;

997 
dñayed_roŸ
 = 
dñayed_node
->
roŸ
->
fs_öfo
->delayed_root;

998 
	`föish_⁄e_ôem
(
dñayed_roŸ
);

1000 
	}
}

1002 
	$__båfs_upd©e_dñayed_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

1003 
båfs_roŸ
 *
roŸ
,

1004 
båfs_∑th
 *
∑th
,

1005 
båfs_dñayed_node
 *
node
)

1007 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1008 
båfs_key
 
key
;

1009 
båfs_öode_ôem
 *
öode_ôem
;

1010 
exã¡_buf„r
 *
Àaf
;

1011 
mod
;

1012 
ªt
;

1014 
key
.
obje˘id
 = 
node
->
öode_id
;

1015 
key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

1016 
key
.
off£t
 = 0;

1018 i‡(
	`ã°_bô
(
BTRFS_DELAYED_NODE_DEL_IREF
, &
node
->
Êags
))

1019 
mod
 = -1;

1021 
mod
 = 1;

1023 
ªt
 = 
	`båfs_lookup_öode
(
å™s
, 
roŸ
, 
∑th
, &
key
, 
mod
);

1024 i‡(
ªt
 > 0)

1025 
ªt
 = -
ENOENT
;

1026 i‡(
ªt
 < 0)

1027 
out
;

1029 
Àaf
 = 
∑th
->
nodes
[0];

1030 
öode_ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

1031 
båfs_öode_ôem
);

1032 
	`wrôe_exã¡_buf„r
(
Àaf
, &
node
->
öode_ôem
, ()inode_item,

1033 (
båfs_öode_ôem
));

1034 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

1036 i‡(!
	`ã°_bô
(
BTRFS_DELAYED_NODE_DEL_IREF
, &
node
->
Êags
))

1037 
out
;

1039 
∑th
->
¶Ÿs
[0]++;

1040 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
(
Àaf
))

1041 
£¨ch
;

1042 
agaö
:

1043 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

1044 i‡(
key
.
obje˘id
 !
node
->
öode_id
)

1045 
out
;

1047 i‡(
key
.
ty≥
 !
BTRFS_INODE_REF_KEY
 &&

1048 
key
.
ty≥
 !
BTRFS_INODE_EXTREF_KEY
)

1049 
out
;

1056 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

1057 
out
:

1058 
	`båfs_ªÀa£_dñayed_úef
(
node
);

1059 
	`båfs_ªÀa£_∑th
(
∑th
);

1060 
îr_out
:

1061 
	`båfs_dñayed_öode_ªÀa£_mëad©a
(
fs_öfo
, 
node
, (
ªt
 < 0));

1062 
	`båfs_ªÀa£_dñayed_öode
(
node
);

1069 i‡(
ªt
 &&Ñë !-
ENOENT
)

1070 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1072  
ªt
;

1074 
£¨ch
:

1075 
	`båfs_ªÀa£_∑th
(
∑th
);

1077 
key
.
ty≥
 = 
BTRFS_INODE_EXTREF_KEY
;

1078 
key
.
off£t
 = -1;

1080 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

1081 i‡(
ªt
 < 0)

1082 
îr_out
;

1083 
	`ASSERT
(
ªt
);

1085 
ªt
 = 0;

1086 
Àaf
 = 
∑th
->
nodes
[0];

1087 
∑th
->
¶Ÿs
[0]--;

1088 
agaö
;

1089 
	}
}

1091 
ölöe
 
	$båfs_upd©e_dñayed_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

1092 
båfs_roŸ
 *
roŸ
,

1093 
båfs_∑th
 *
∑th
,

1094 
båfs_dñayed_node
 *
node
)

1096 
ªt
;

1098 
	`muãx_lock
(&
node
->
muãx
);

1099 i‡(!
	`ã°_bô
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
node
->
Êags
)) {

1100 
	`muãx_u∆ock
(&
node
->
muãx
);

1104 
ªt
 = 
	`__båfs_upd©e_dñayed_öode
(
å™s
, 
roŸ
, 
∑th
, 
node
);

1105 
	`muãx_u∆ock
(&
node
->
muãx
);

1106  
ªt
;

1107 
	}
}

1109 
ölöe
 

1110 
	$__båfs_commô_öode_dñayed_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

1111 
båfs_∑th
 *
∑th
,

1112 
båfs_dñayed_node
 *
node
)

1114 
ªt
;

1116 
ªt
 = 
	`båfs_ö£π_dñayed_ôems
(
å™s
, 
∑th
, 
node
->
roŸ
,Çode);

1117 i‡(
ªt
)

1118  
ªt
;

1120 
ªt
 = 
	`båfs_dñëe_dñayed_ôems
(
å™s
, 
∑th
, 
node
->
roŸ
,Çode);

1121 i‡(
ªt
)

1122  
ªt
;

1124 
ªt
 = 
	`båfs_upd©e_dñayed_öode
(
å™s
, 
node
->
roŸ
, 
∑th
,Çode);

1125  
ªt
;

1126 
	}
}

1134 
	$__båfs_run_dñayed_ôems
(
båfs_å™s_h™dÀ
 *
å™s
, 
ƒ
)

1136 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1137 
båfs_dñayed_roŸ
 *
dñayed_roŸ
;

1138 
båfs_dñayed_node
 *
cuº_node
, *
¥ev_node
;

1139 
båfs_∑th
 *
∑th
;

1140 
båfs_block_rsv
 *
block_rsv
;

1141 
ªt
 = 0;

1142 
boﬁ
 
cou¡
 = (
ƒ
 > 0);

1144 i‡(
	`TRANS_ABORTED
(
å™s
))

1145  -
EIO
;

1147 
∑th
 = 
	`båfs_Æloc_∑th
();

1148 i‡(!
∑th
)

1149  -
ENOMEM
;

1151 
block_rsv
 = 
å™s
->block_rsv;

1152 
å™s
->
block_rsv
 = &
fs_öfo
->
dñayed_block_rsv
;

1154 
dñayed_roŸ
 = 
fs_öfo
->delayed_root;

1156 
cuº_node
 = 
	`båfs_fú°_dñayed_node
(
dñayed_roŸ
);

1157 
cuº_node
 && (!
cou¡
 || 
ƒ
--)) {

1158 
ªt
 = 
	`__båfs_commô_öode_dñayed_ôems
(
å™s
, 
∑th
,

1159 
cuº_node
);

1160 i‡(
ªt
) {

1161 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1165 
¥ev_node
 = 
cuº_node
;

1166 
cuº_node
 = 
	`båfs_√xt_dñayed_node
(curr_node);

1173 
	`ASSERT
(
∑th
->
nodes
[0] =
NULL
);

1174 
	`båfs_ªÀa£_dñayed_node
(
¥ev_node
);

1184 
	`båfs_‰ì_∑th
(
∑th
);

1186 i‡(
cuº_node
)

1187 
	`båfs_ªÀa£_dñayed_node
(
cuº_node
);

1188 
å™s
->
block_rsv
 = block_rsv;

1190  
ªt
;

1191 
	}
}

1193 
	$båfs_run_dñayed_ôems
(
båfs_å™s_h™dÀ
 *
å™s
)

1195  
	`__båfs_run_dñayed_ôems
(
å™s
, -1);

1196 
	}
}

1198 
	$båfs_run_dñayed_ôems_ƒ
(
båfs_å™s_h™dÀ
 *
å™s
, 
ƒ
)

1200  
	`__båfs_run_dñayed_ôems
(
å™s
, 
ƒ
);

1201 
	}
}

1203 
	$båfs_commô_öode_dñayed_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

1204 
båfs_öode
 *
öode
)

1206 
båfs_dñayed_node
 *
dñayed_node
 = 
	`båfs_gë_dñayed_node
(
öode
);

1207 
båfs_∑th
 *
∑th
;

1208 
båfs_block_rsv
 *
block_rsv
;

1209 
ªt
;

1211 i‡(!
dñayed_node
)

1214 
	`muãx_lock
(&
dñayed_node
->
muãx
);

1215 i‡(!
dñayed_node
->
cou¡
) {

1216 
	`muãx_u∆ock
(&
dñayed_node
->
muãx
);

1217 
	`båfs_ªÀa£_dñayed_node
(
dñayed_node
);

1220 
	`muãx_u∆ock
(&
dñayed_node
->
muãx
);

1222 
∑th
 = 
	`båfs_Æloc_∑th
();

1223 i‡(!
∑th
) {

1224 
	`båfs_ªÀa£_dñayed_node
(
dñayed_node
);

1225  -
ENOMEM
;

1228 
block_rsv
 = 
å™s
->block_rsv;

1229 
å™s
->
block_rsv
 = &
dñayed_node
->
roŸ
->
fs_öfo
->
dñayed_block_rsv
;

1231 
ªt
 = 
	`__båfs_commô_öode_dñayed_ôems
(
å™s
, 
∑th
, 
dñayed_node
);

1233 
	`båfs_ªÀa£_dñayed_node
(
dñayed_node
);

1234 
	`båfs_‰ì_∑th
(
∑th
);

1235 
å™s
->
block_rsv
 = block_rsv;

1237  
ªt
;

1238 
	}
}

1240 
	$båfs_commô_öode_dñayed_öode
(
båfs_öode
 *
öode
)

1242 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

1243 
båfs_å™s_h™dÀ
 *
å™s
;

1244 
båfs_dñayed_node
 *
dñayed_node
 = 
	`båfs_gë_dñayed_node
(
öode
);

1245 
båfs_∑th
 *
∑th
;

1246 
båfs_block_rsv
 *
block_rsv
;

1247 
ªt
;

1249 i‡(!
dñayed_node
)

1252 
	`muãx_lock
(&
dñayed_node
->
muãx
);

1253 i‡(!
	`ã°_bô
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
dñayed_node
->
Êags
)) {

1254 
	`muãx_u∆ock
(&
dñayed_node
->
muãx
);

1255 
	`båfs_ªÀa£_dñayed_node
(
dñayed_node
);

1258 
	`muãx_u∆ock
(&
dñayed_node
->
muãx
);

1260 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
dñayed_node
->
roŸ
);

1261 i‡(
	`IS_ERR
(
å™s
)) {

1262 
ªt
 = 
	`PTR_ERR
(
å™s
);

1263 
out
;

1266 
∑th
 = 
	`båfs_Æloc_∑th
();

1267 i‡(!
∑th
) {

1268 
ªt
 = -
ENOMEM
;

1269 
å™s_out
;

1272 
block_rsv
 = 
å™s
->block_rsv;

1273 
å™s
->
block_rsv
 = &
fs_öfo
->
dñayed_block_rsv
;

1275 
	`muãx_lock
(&
dñayed_node
->
muãx
);

1276 i‡(
	`ã°_bô
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
dñayed_node
->
Êags
))

1277 
ªt
 = 
	`__båfs_upd©e_dñayed_öode
(
å™s
, 
dñayed_node
->
roŸ
,

1278 
∑th
, 
dñayed_node
);

1280 
ªt
 = 0;

1281 
	`muãx_u∆ock
(&
dñayed_node
->
muãx
);

1283 
	`båfs_‰ì_∑th
(
∑th
);

1284 
å™s
->
block_rsv
 = block_rsv;

1285 
å™s_out
:

1286 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1287 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

1288 
out
:

1289 
	`båfs_ªÀa£_dñayed_node
(
dñayed_node
);

1291  
ªt
;

1292 
	}
}

1294 
	$båfs_ªmove_dñayed_node
(
båfs_öode
 *
öode
)

1296 
båfs_dñayed_node
 *
dñayed_node
;

1298 
dñayed_node
 = 
	`READ_ONCE
(
öode
->delayed_node);

1299 i‡(!
dñayed_node
)

1302 
öode
->
dñayed_node
 = 
NULL
;

1303 
	`båfs_ªÀa£_dñayed_node
(
dñayed_node
);

1304 
	}
}

1306 
	sbåfs_async_dñayed_w‹k
 {

1307 
båfs_dñayed_roŸ
 *
	mdñayed_roŸ
;

1308 
	mƒ
;

1309 
båfs_w‹k
 
	mw‹k
;

1312 
	$båfs_async_run_dñayed_roŸ
(
båfs_w‹k
 *
w‹k
)

1314 
båfs_async_dñayed_w‹k
 *
async_w‹k
;

1315 
båfs_dñayed_roŸ
 *
dñayed_roŸ
;

1316 
båfs_å™s_h™dÀ
 *
å™s
;

1317 
båfs_∑th
 *
∑th
;

1318 
båfs_dñayed_node
 *
dñayed_node
 = 
NULL
;

1319 
båfs_roŸ
 *
roŸ
;

1320 
båfs_block_rsv
 *
block_rsv
;

1321 
tŸÆ_d⁄e
 = 0;

1323 
async_w‹k
 = 
	`c⁄èöî_of
(
w‹k
, 
båfs_async_dñayed_w‹k
, work);

1324 
dñayed_roŸ
 = 
async_w‹k
->delayed_root;

1326 
∑th
 = 
	`båfs_Æloc_∑th
();

1327 i‡(!
∑th
)

1328 
out
;

1331 i‡(
	`©omic_ªad
(&
dñayed_roŸ
->
ôems
) <

1332 
BTRFS_DELAYED_BACKGROUND
 / 2)

1335 
dñayed_node
 = 
	`båfs_fú°_¥ï¨ed_dñayed_node
(
dñayed_roŸ
);

1336 i‡(!
dñayed_node
)

1339 
roŸ
 = 
dñayed_node
->root;

1341 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
roŸ
);

1342 i‡(
	`IS_ERR
(
å™s
)) {

1343 
	`båfs_ªÀa£_∑th
(
∑th
);

1344 
	`båfs_ªÀa£_¥ï¨ed_dñayed_node
(
dñayed_node
);

1345 
tŸÆ_d⁄e
++;

1349 
block_rsv
 = 
å™s
->block_rsv;

1350 
å™s
->
block_rsv
 = &
roŸ
->
fs_öfo
->
dñayed_block_rsv
;

1352 
	`__båfs_commô_öode_dñayed_ôems
(
å™s
, 
∑th
, 
dñayed_node
);

1354 
å™s
->
block_rsv
 = block_rsv;

1355 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1356 
	`båfs_båì_bÆ™˚_dúty_nodñay
(
roŸ
->
fs_öfo
);

1358 
	`båfs_ªÀa£_∑th
(
∑th
);

1359 
	`båfs_ªÀa£_¥ï¨ed_dñayed_node
(
dñayed_node
);

1360 
tŸÆ_d⁄e
++;

1362 } (
async_w‹k
->
ƒ
 =0 && 
tŸÆ_d⁄e
 < 
BTRFS_DELAYED_WRITEBACK
)

1363 || 
tŸÆ_d⁄e
 < 
async_w‹k
->
ƒ
);

1365 
	`båfs_‰ì_∑th
(
∑th
);

1366 
out
:

1367 
	`wake_up
(&
dñayed_roŸ
->
waô
);

1368 
	`k‰ì
(
async_w‹k
);

1369 
	}
}

1372 
	$båfs_wq_run_dñayed_node
(
båfs_dñayed_roŸ
 *
dñayed_roŸ
,

1373 
båfs_fs_öfo
 *
fs_öfo
, 
ƒ
)

1375 
båfs_async_dñayed_w‹k
 *
async_w‹k
;

1377 
async_w‹k
 = 
	`kmÆloc
((*async_w‹k), 
GFP_NOFS
);

1378 i‡(!
async_w‹k
)

1379  -
ENOMEM
;

1381 
async_w‹k
->
dñayed_roŸ
 = delayed_root;

1382 
	`båfs_öô_w‹k
(&
async_w‹k
->
w‹k
, 
båfs_async_run_dñayed_roŸ
, 
NULL
,

1383 
NULL
);

1384 
async_w‹k
->
ƒ
 =Çr;

1386 
	`båfs_queue_w‹k
(
fs_öfo
->
dñayed_w‹kîs
, &
async_w‹k
->
w‹k
);

1388 
	}
}

1390 
	$båfs_as£π_dñayed_roŸ_em±y
(
båfs_fs_öfo
 *
fs_öfo
)

1392 
	`WARN_ON
(
	`båfs_fú°_dñayed_node
(
fs_öfo
->
dñayed_roŸ
));

1393 
	}
}

1395 
	$could_íd_waô
(
båfs_dñayed_roŸ
 *
dñayed_roŸ
, 
£q
)

1397 
vÆ
 = 
	`©omic_ªad
(&
dñayed_roŸ
->
ôems_£q
);

1399 i‡(
vÆ
 < 
£q
 || vÆ >£q + 
BTRFS_DELAYED_BATCH
)

1402 i‡(
	`©omic_ªad
(&
dñayed_roŸ
->
ôems
Ë< 
BTRFS_DELAYED_BACKGROUND
)

1406 
	}
}

1408 
	$båfs_bÆ™˚_dñayed_ôems
(
båfs_fs_öfo
 *
fs_öfo
)

1410 
båfs_dñayed_roŸ
 *
dñayed_roŸ
 = 
fs_öfo
->delayed_root;

1412 i‡((
	`©omic_ªad
(&
dñayed_roŸ
->
ôems
Ë< 
BTRFS_DELAYED_BACKGROUND
) ||

1413 
	`båfs_w‹kqueue_n‹mÆ_c⁄ge°ed
(
fs_öfo
->
dñayed_w‹kîs
))

1416 i‡(
	`©omic_ªad
(&
dñayed_roŸ
->
ôems
Ë>
BTRFS_DELAYED_WRITEBACK
) {

1417 
£q
;

1418 
ªt
;

1420 
£q
 = 
	`©omic_ªad
(&
dñayed_roŸ
->
ôems_£q
);

1422 
ªt
 = 
	`båfs_wq_run_dñayed_node
(
dñayed_roŸ
, 
fs_öfo
, 0);

1423 i‡(
ªt
)

1426 
	`waô_evít_öãºu±ibÀ
(
dñayed_roŸ
->
waô
,

1427 
	`could_íd_waô
(
dñayed_roŸ
, 
£q
));

1431 
	`båfs_wq_run_dñayed_node
(
dñayed_roŸ
, 
fs_öfo
, 
BTRFS_DELAYED_BATCH
);

1432 
	}
}

1434 
	$båfs_ªÀa£_dú_ödex_ôem_•a˚
(
båfs_å™s_h™dÀ
 *
å™s
)

1436 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1437 c⁄° 
u64
 
byãs
 = 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
, 1);

1439 i‡(
	`ã°_bô
(
BTRFS_FS_LOG_RECOVERING
, &
fs_öfo
->
Êags
))

1449 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, "transaction",

1450 
å™s
->
å™sid
, 
byãs
, 0);

1451 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, 
å™s
->
block_rsv
, 
byãs
, 
NULL
);

1452 
	`ASSERT
(
å™s
->
byãs_ª£rved
 >
byãs
);

1453 
å™s
->
byãs_ª£rved
 -
byãs
;

1454 
	}
}

1457 
	$båfs_ö£π_dñayed_dú_ödex
(
båfs_å™s_h™dÀ
 *
å™s
,

1458 c⁄° *
«me
, 
«me_Àn
,

1459 
båfs_öode
 *
dú
,

1460 
båfs_disk_key
 *
disk_key
, 
u8
 
Êags
,

1461 
u64
 
ödex
)

1463 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1464 c⁄° 
Àaf_d©a_size
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
);

1465 
båfs_dñayed_node
 *
dñayed_node
;

1466 
båfs_dñayed_ôem
 *
dñayed_ôem
;

1467 
båfs_dú_ôem
 *
dú_ôem
;

1468 
boﬁ
 
ª£rve_Àaf_•a˚
;

1469 
u32
 
d©a_Àn
;

1470 
ªt
;

1472 
dñayed_node
 = 
	`båfs_gë_‹_¸óã_dñayed_node
(
dú
);

1473 i‡(
	`IS_ERR
(
dñayed_node
))

1474  
	`PTR_ERR
(
dñayed_node
);

1476 
dñayed_ôem
 = 
	`båfs_Æloc_dñayed_ôem
((*
dú_ôem
Ë+ 
«me_Àn
,

1477 
dñayed_node
,

1478 
BTRFS_DELAYED_INSERTION_ITEM
);

1479 i‡(!
dñayed_ôem
) {

1480 
ªt
 = -
ENOMEM
;

1481 
ªÀa£_node
;

1484 
dñayed_ôem
->
ödex
 = index;

1486 
dú_ôem
 = (
båfs_dú_ôem
 *)
dñayed_ôem
->
d©a
;

1487 
dú_ôem
->
loˇti⁄
 = *
disk_key
;

1488 
	`båfs_£t_°ack_dú_å™sid
(
dú_ôem
, 
å™s
->
å™sid
);

1489 
	`båfs_£t_°ack_dú_d©a_Àn
(
dú_ôem
, 0);

1490 
	`båfs_£t_°ack_dú_«me_Àn
(
dú_ôem
, 
«me_Àn
);

1491 
	`båfs_£t_°ack_dú_Êags
(
dú_ôem
, 
Êags
);

1492 
	`mem˝y
((*)(
dú_ôem
 + 1), 
«me
, 
«me_Àn
);

1494 
d©a_Àn
 = 
dñayed_ôem
->d©a_À¿+ (
båfs_ôem
);

1496 
	`muãx_lock
(&
dñayed_node
->
muãx
);

1506 
ªt
 = 
	`__båfs_add_dñayed_ôem
(
dñayed_node
, 
dñayed_ôem
);

1507 i‡(
	`u∆ikñy
(
ªt
)) {

1508 
	`båfs_îr
(
å™s
->
fs_öfo
,

1510 
«me_Àn
, 
«me
, 
ödex
, 
	`båfs_roŸ_id
(
dñayed_node
->
roŸ
),

1511 
dñayed_node
->
öode_id
, 
dú
->
ödex_˙t
,

1512 
dñayed_node
->
ödex_˙t
, 
ªt
);

1513 
	`båfs_ªÀa£_dñayed_ôem
(
dñayed_ôem
);

1514 
	`båfs_ªÀa£_dú_ödex_ôem_•a˚
(
å™s
);

1515 
	`muãx_u∆ock
(&
dñayed_node
->
muãx
);

1516 
ªÀa£_node
;

1519 i‡(
dñayed_node
->
ödex_ôem_Àaves
 == 0 ||

1520 
dñayed_node
->
cuº_ödex_b©ch_size
 + 
d©a_Àn
 > 
Àaf_d©a_size
) {

1521 
dñayed_node
->
cuº_ödex_b©ch_size
 = 
d©a_Àn
;

1522 
ª£rve_Àaf_•a˚
 = 
åue
;

1524 
dñayed_node
->
cuº_ödex_b©ch_size
 +
d©a_Àn
;

1525 
ª£rve_Àaf_•a˚
 = 
Ál£
;

1528 i‡(
ª£rve_Àaf_•a˚
) {

1529 
ªt
 = 
	`båfs_dñayed_ôem_ª£rve_mëad©a
(
å™s
, 
dñayed_ôem
);

1535 i‡(
	`WARN_ON
(
ªt
)) {

1536 
	`båfs_ªÀa£_dñayed_ôem
(
dñayed_ôem
);

1537 
	`muãx_u∆ock
(&
dñayed_node
->
muãx
);

1538 
ªÀa£_node
;

1541 
dñayed_node
->
ödex_ôem_Àaves
++;

1543 
	`båfs_ªÀa£_dú_ödex_ôem_•a˚
(
å™s
);

1545 
	`muãx_u∆ock
(&
dñayed_node
->
muãx
);

1547 
ªÀa£_node
:

1548 
	`båfs_ªÀa£_dñayed_node
(
dñayed_node
);

1549  
ªt
;

1550 
	}
}

1552 
	$båfs_dñëe_dñayed_ö£πi⁄_ôem
(
båfs_fs_öfo
 *
fs_öfo
,

1553 
båfs_dñayed_node
 *
node
,

1554 
u64
 
ödex
)

1556 
båfs_dñayed_ôem
 *
ôem
;

1558 
	`muãx_lock
(&
node
->
muãx
);

1559 
ôem
 = 
	`__båfs_lookup_dñayed_ôem
(&
node
->
ös_roŸ
.
rb_roŸ
, 
ödex
);

1560 i‡(!
ôem
) {

1561 
	`muãx_u∆ock
(&
node
->
muãx
);

1571 
	`ASSERT
(
ôem
->
byãs_ª£rved
 == 0);

1572 
	`ASSERT
(
node
->
ödex_ôem_Àaves
 > 0);

1581 i‡(
node
->
ödex_ôem_Àaves
 == 1) {

1582 c⁄° 
u32
 
d©a_Àn
 = 
ôem
->d©a_À¿+ (
båfs_ôem
);

1584 
	`ASSERT
(
node
->
cuº_ödex_b©ch_size
 >
d©a_Àn
);

1585 
node
->
cuº_ödex_b©ch_size
 -
d©a_Àn
;

1588 
	`båfs_ªÀa£_dñayed_ôem
(
ôem
);

1591 i‡(
	`RB_EMPTY_ROOT
(&
node
->
ös_roŸ
.
rb_roŸ
)) {

1592 
	`båfs_dñayed_ôem_ªÀa£_Àaves
(
node
,Çode->
ödex_ôem_Àaves
);

1593 
node
->
ödex_ôem_Àaves
 = 0;

1596 
	`muãx_u∆ock
(&
node
->
muãx
);

1598 
	}
}

1600 
	$båfs_dñëe_dñayed_dú_ödex
(
båfs_å™s_h™dÀ
 *
å™s
,

1601 
båfs_öode
 *
dú
, 
u64
 
ödex
)

1603 
båfs_dñayed_node
 *
node
;

1604 
båfs_dñayed_ôem
 *
ôem
;

1605 
ªt
;

1607 
node
 = 
	`båfs_gë_‹_¸óã_dñayed_node
(
dú
);

1608 i‡(
	`IS_ERR
(
node
))

1609  
	`PTR_ERR
(
node
);

1611 
ªt
 = 
	`båfs_dñëe_dñayed_ö£πi⁄_ôem
(
å™s
->
fs_öfo
, 
node
, 
ödex
);

1612 i‡(!
ªt
)

1613 
íd
;

1615 
ôem
 = 
	`båfs_Æloc_dñayed_ôem
(0, 
node
, 
BTRFS_DELAYED_DELETION_ITEM
);

1616 i‡(!
ôem
) {

1617 
ªt
 = -
ENOMEM
;

1618 
íd
;

1621 
ôem
->
ödex
 = index;

1623 
ªt
 = 
	`båfs_dñayed_ôem_ª£rve_mëad©a
(
å™s
, 
ôem
);

1628 i‡(
ªt
 < 0) {

1629 
	`båfs_îr
(
å™s
->
fs_öfo
,

1631 
	`båfs_ªÀa£_dñayed_ôem
(
ôem
);

1632 
íd
;

1635 
	`muãx_lock
(&
node
->
muãx
);

1636 
ªt
 = 
	`__båfs_add_dñayed_ôem
(
node
, 
ôem
);

1637 i‡(
	`u∆ikñy
(
ªt
)) {

1638 
	`båfs_îr
(
å™s
->
fs_öfo
,

1640 
ödex
, 
node
->
roŸ
->
roŸ_key
.
obje˘id
,

1641 
node
->
öode_id
, 
ªt
);

1642 
	`båfs_dñayed_ôem_ªÀa£_mëad©a
(
dú
->
roŸ
, 
ôem
);

1643 
	`båfs_ªÀa£_dñayed_ôem
(
ôem
);

1645 
	`muãx_u∆ock
(&
node
->
muãx
);

1646 
íd
:

1647 
	`båfs_ªÀa£_dñayed_node
(
node
);

1648  
ªt
;

1649 
	}
}

1652 
	$båfs_öode_dñayed_dú_ödex_cou¡
(
båfs_öode
 *
öode
)

1655 
öode
 *
cur_öode
 = &öode->
vfs_öode
;

1656 
båfs_fs_öfo
 *
cur_fs_öfo
 = 
	`båfs_sb
(
cur_öode
->
i_sb
);

1658 
öode
 *
loˇl_öode
;

1659 
båfs_öode
 *
b_loˇl_öode
;

1661 
b_loˇl_öode
 = 
öode
;

1663 i‡((
cur_öode
->
assocüãd_öode
Ë&& (cur_öode->
has_ªmŸe
 == 0)) {

1665 
loˇl_öode
 = 
cur_öode
->
assocüãd_öode
;

1666 
b_loˇl_öode
 = 
	`BTRFS_I
(
loˇl_öode
);

1668 
b_loˇl_öode
 = 
öode
;

1672 
båfs_dñayed_node
 *
dñayed_node
 = 
	`båfs_gë_dñayed_node
(
b_loˇl_öode
);

1676 i‡(!
dñayed_node
) {

1678  -
ENOENT
;

1685 i‡(!
dñayed_node
->
ödex_˙t
) {

1686 
	`båfs_ªÀa£_dñayed_node
(
dñayed_node
);

1687  -
EINVAL
;

1691 
b_loˇl_öode
->
ödex_˙t
 = 
dñayed_node
->index_cnt;

1692 
	`båfs_ªÀa£_dñayed_node
(
dñayed_node
);

1694 
	}
}

1696 
boﬁ
 
	$båfs_ªaddú_gë_dñayed_ôems
(
öode
 *inode,

1697 
u64
 
œ°_ödex
,

1698 
li°_hód
 *
ös_li°
,

1699 
li°_hód
 *
dñ_li°
)

1701 
båfs_dñayed_node
 *
dñayed_node
;

1702 
båfs_dñayed_ôem
 *
ôem
;

1704 
dñayed_node
 = 
	`båfs_gë_dñayed_node
(
	`BTRFS_I
(
öode
));

1705 i‡(!
dñayed_node
)

1706  
Ál£
;

1712 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
BTRFS_ILOCK_SHARED
);

1713 
	`båfs_öode_lock
(
	`BTRFS_I
(
öode
), 0);

1715 
	`muãx_lock
(&
dñayed_node
->
muãx
);

1716 
ôem
 = 
	`__båfs_fú°_dñayed_ö£πi⁄_ôem
(
dñayed_node
);

1717 
ôem
 && iãm->
ödex
 <
œ°_ödex
) {

1718 
	`ªfcou¡_öc
(&
ôem
->
ªfs
);

1719 
	`li°_add_èû
(&
ôem
->
ªaddú_li°
, 
ös_li°
);

1720 
ôem
 = 
	`__båfs_√xt_dñayed_ôem
(item);

1723 
ôem
 = 
	`__båfs_fú°_dñayed_dñëi⁄_ôem
(
dñayed_node
);

1724 
ôem
 && iãm->
ödex
 <
œ°_ödex
) {

1725 
	`ªfcou¡_öc
(&
ôem
->
ªfs
);

1726 
	`li°_add_èû
(&
ôem
->
ªaddú_li°
, 
dñ_li°
);

1727 
ôem
 = 
	`__båfs_√xt_dñayed_ôem
(item);

1729 
	`muãx_u∆ock
(&
dñayed_node
->
muãx
);

1739 
	`ªfcou¡_dec
(&
dñayed_node
->
ªfs
);

1741  
åue
;

1742 
	}
}

1744 
	$båfs_ªaddú_put_dñayed_ôems
(
öode
 *inode,

1745 
li°_hód
 *
ös_li°
,

1746 
li°_hód
 *
dñ_li°
)

1748 
båfs_dñayed_ôem
 *
cuº
, *
√xt
;

1750 
	`li°_f‹_óch_íåy_ß„
(
cuº
, 
√xt
, 
ös_li°
, 
ªaddú_li°
) {

1751 
	`li°_dñ
(&
cuº
->
ªaddú_li°
);

1752 i‡(
	`ªfcou¡_dec_™d_ã°
(&
cuº
->
ªfs
))

1753 
	`k‰ì
(
cuº
);

1756 
	`li°_f‹_óch_íåy_ß„
(
cuº
, 
√xt
, 
dñ_li°
, 
ªaddú_li°
) {

1757 
	`li°_dñ
(&
cuº
->
ªaddú_li°
);

1758 i‡(
	`ªfcou¡_dec_™d_ã°
(&
cuº
->
ªfs
))

1759 
	`k‰ì
(
cuº
);

1766 
	`downgøde_wrôe
(&
öode
->
i_rw£m
);

1767 
	}
}

1769 
	$båfs_should_dñëe_dú_ödex
(
li°_hód
 *
dñ_li°
,

1770 
u64
 
ödex
)

1772 
båfs_dñayed_ôem
 *
cuº
;

1773 
ªt
 = 0;

1775 
	`li°_f‹_óch_íåy
(
cuº
, 
dñ_li°
, 
ªaddú_li°
) {

1776 i‡(
cuº
->
ödex
 > index)

1778 i‡(
cuº
->
ödex
 == index) {

1779 
ªt
 = 1;

1783  
ªt
;

1784 
	}
}

1790 
	$båfs_ªaddú_dñayed_dú_ödex
(
dú_c⁄ãxt
 *
˘x
,

1791 
li°_hód
 *
ös_li°
)

1793 
båfs_dú_ôem
 *
di
;

1794 
båfs_dñayed_ôem
 *
cuº
, *
√xt
;

1795 
båfs_key
 
loˇti⁄
;

1796 *
«me
;

1797 
«me_Àn
;

1798 
ovî
 = 0;

1799 
d_ty≥
;

1806 
	`li°_f‹_óch_íåy_ß„
(
cuº
, 
√xt
, 
ös_li°
, 
ªaddú_li°
) {

1807 
	`li°_dñ
(&
cuº
->
ªaddú_li°
);

1809 i‡(
cuº
->
ödex
 < 
˘x
->
pos
) {

1810 i‡(
	`ªfcou¡_dec_™d_ã°
(&
cuº
->
ªfs
))

1811 
	`k‰ì
(
cuº
);

1815 
˘x
->
pos
 = 
cuº
->
ödex
;

1817 
di
 = (
båfs_dú_ôem
 *)
cuº
->
d©a
;

1818 
«me
 = (*)(
di
 + 1);

1819 
«me_Àn
 = 
	`båfs_°ack_dú_«me_Àn
(
di
);

1821 
d_ty≥
 = 
	`fs_·y≥_to_dty≥
(
	`båfs_dú_Êags_to_·y≥
(
di
->
ty≥
));

1822 
	`båfs_disk_key_to_˝u
(&
loˇti⁄
, &
di
->location);

1824 
ovî
 = !
	`dú_emô
(
˘x
, 
«me
, 
«me_Àn
,

1825 
loˇti⁄
.
obje˘id
, 
d_ty≥
);

1827 i‡(
	`ªfcou¡_dec_™d_ã°
(&
cuº
->
ªfs
))

1828 
	`k‰ì
(
cuº
);

1830 i‡(
ovî
)

1832 
˘x
->
pos
++;

1835 
	}
}

1837 
	$fûl_°ack_öode_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

1838 
båfs_öode_ôem
 *
öode_ôem
,

1839 
öode
 *inode)

1841 
u64
 
Êags
;

1843 
	`båfs_£t_°ack_öode_uid
(
öode_ôem
, 
	`i_uid_ªad
(
öode
));

1844 
	`båfs_£t_°ack_öode_gid
(
öode_ôem
, 
	`i_gid_ªad
(
öode
));

1845 
	`båfs_£t_°ack_öode_size
(
öode_ôem
, 
	`BTRFS_I
(
öode
)->
disk_i_size
);

1846 
	`båfs_£t_°ack_öode_mode
(
öode_ôem
, 
öode
->
i_mode
);

1847 
	`båfs_£t_°ack_öode_∆ök
(
öode_ôem
, 
öode
->
i_∆ök
);

1848 
	`båfs_£t_°ack_öode_nbyãs
(
öode_ôem
, 
	`öode_gë_byãs
(
öode
));

1849 
	`båfs_£t_°ack_öode_gíî©i⁄
(
öode_ôem
,

1850 
	`BTRFS_I
(
öode
)->
gíî©i⁄
);

1851 
	`båfs_£t_°ack_öode_£quí˚
(
öode_ôem
,

1852 
	`öode_≥ek_ivîsi⁄
(
öode
));

1853 
	`båfs_£t_°ack_öode_å™sid
(
öode_ôem
, 
å™s
->
å™sid
);

1854 
	`båfs_£t_°ack_öode_rdev
(
öode_ôem
, 
öode
->
i_rdev
);

1855 
Êags
 = 
	`båfs_öode_comböe_Êags
(
	`BTRFS_I
(
öode
)->flags,

1856 
	`BTRFS_I
(
öode
)->
ro_Êags
);

1857 
	`båfs_£t_°ack_öode_Êags
(
öode_ôem
, 
Êags
);

1858 
	`båfs_£t_°ack_öode_block_group
(
öode_ôem
, 0);

1860 
	`båfs_£t_°ack_time•ec_£c
(&
öode_ôem
->
©ime
,

1861 
öode
->
i_©ime
.
tv_£c
);

1862 
	`båfs_£t_°ack_time•ec_n£c
(&
öode_ôem
->
©ime
,

1863 
öode
->
i_©ime
.
tv_n£c
);

1865 
	`båfs_£t_°ack_time•ec_£c
(&
öode_ôem
->
mtime
,

1866 
öode
->
i_mtime
.
tv_£c
);

1867 
	`båfs_£t_°ack_time•ec_n£c
(&
öode_ôem
->
mtime
,

1868 
öode
->
i_mtime
.
tv_n£c
);

1870 
	`båfs_£t_°ack_time•ec_£c
(&
öode_ôem
->
˘ime
,

1871 
	`öode_gë_˘ime
(
öode
).
tv_£c
);

1872 
	`båfs_£t_°ack_time•ec_n£c
(&
öode_ôem
->
˘ime
,

1873 
	`öode_gë_˘ime
(
öode
).
tv_n£c
);

1875 
	`båfs_£t_°ack_time•ec_£c
(&
öode_ôem
->
Ÿime
,

1876 
	`BTRFS_I
(
öode
)->
i_Ÿime
.
tv_£c
);

1877 
	`båfs_£t_°ack_time•ec_n£c
(&
öode_ôem
->
Ÿime
,

1878 
	`BTRFS_I
(
öode
)->
i_Ÿime
.
tv_n£c
);

1879 
	}
}

1881 
	$båfs_fûl_öode
(
öode
 *öode, 
u32
 *
rdev
)

1883 
båfs_fs_öfo
 *
fs_öfo
 = 
	`BTRFS_I
(
öode
)->
roŸ
->fs_info;

1884 
båfs_dñayed_node
 *
dñayed_node
;

1885 
båfs_öode_ôem
 *
öode_ôem
;

1887 
dñayed_node
 = 
	`båfs_gë_dñayed_node
(
	`BTRFS_I
(
öode
));

1888 i‡(!
dñayed_node
)

1889  -
ENOENT
;

1891 
	`muãx_lock
(&
dñayed_node
->
muãx
);

1892 i‡(!
	`ã°_bô
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
dñayed_node
->
Êags
)) {

1893 
	`muãx_u∆ock
(&
dñayed_node
->
muãx
);

1894 
	`båfs_ªÀa£_dñayed_node
(
dñayed_node
);

1895  -
ENOENT
;

1898 
öode_ôem
 = &
dñayed_node
->inode_item;

1900 
	`i_uid_wrôe
(
öode
, 
	`båfs_°ack_öode_uid
(
öode_ôem
));

1901 
	`i_gid_wrôe
(
öode
, 
	`båfs_°ack_öode_gid
(
öode_ôem
));

1902 
	`båfs_i_size_wrôe
(
	`BTRFS_I
(
öode
), 
	`båfs_°ack_öode_size
(
öode_ôem
));

1903 
	`båfs_öode_£t_fûe_exã¡_ønge
(
	`BTRFS_I
(
öode
), 0,

1904 
	`round_up
(
	`i_size_ªad
(
öode
), 
fs_öfo
->
£˘‹size
));

1905 
öode
->
i_mode
 = 
	`båfs_°ack_öode_mode
(
öode_ôem
);

1906 
	`£t_∆ök
(
öode
, 
	`båfs_°ack_öode_∆ök
(
öode_ôem
));

1907 
	`öode_£t_byãs
(
öode
, 
	`båfs_°ack_öode_nbyãs
(
öode_ôem
));

1908 
	`BTRFS_I
(
öode
)->
gíî©i⁄
 = 
	`båfs_°ack_öode_gíî©i⁄
(
öode_ôem
);

1909 
	`BTRFS_I
(
öode
)->
œ°_å™s
 = 
	`båfs_°ack_öode_å™sid
(
öode_ôem
);

1911 
	`öode_£t_ivîsi⁄_quîõd
(
öode
,

1912 
	`båfs_°ack_öode_£quí˚
(
öode_ôem
));

1913 
öode
->
i_rdev
 = 0;

1914 *
rdev
 = 
	`båfs_°ack_öode_rdev
(
öode_ôem
);

1915 
	`båfs_öode_•lô_Êags
(
	`båfs_°ack_öode_Êags
(
öode_ôem
),

1916 &
	`BTRFS_I
(
öode
)->
Êags
, &BTRFS_I(öode)->
ro_Êags
);

1918 
öode
->
i_©ime
.
tv_£c
 = 
	`båfs_°ack_time•ec_£c
(&
öode_ôem
->
©ime
);

1919 
öode
->
i_©ime
.
tv_n£c
 = 
	`båfs_°ack_time•ec_n£c
(&
öode_ôem
->
©ime
);

1921 
öode
->
i_mtime
.
tv_£c
 = 
	`båfs_°ack_time•ec_£c
(&
öode_ôem
->
mtime
);

1922 
öode
->
i_mtime
.
tv_n£c
 = 
	`båfs_°ack_time•ec_n£c
(&
öode_ôem
->
mtime
);

1924 
	`öode_£t_˘ime
(
öode
, 
	`båfs_°ack_time•ec_£c
(&
öode_ôem
->
˘ime
),

1925 
	`båfs_°ack_time•ec_n£c
(&
öode_ôem
->
˘ime
));

1927 
	`BTRFS_I
(
öode
)->
i_Ÿime
.
tv_£c
 =

1928 
	`båfs_°ack_time•ec_£c
(&
öode_ôem
->
Ÿime
);

1929 
	`BTRFS_I
(
öode
)->
i_Ÿime
.
tv_n£c
 =

1930 
	`båfs_°ack_time•ec_n£c
(&
öode_ôem
->
Ÿime
);

1932 
öode
->
i_gíî©i⁄
 = 
	`BTRFS_I
(öode)->
gíî©i⁄
;

1933 
	`BTRFS_I
(
öode
)->
ödex_˙t
 = (
u64
)-1;

1935 
	`muãx_u∆ock
(&
dñayed_node
->
muãx
);

1936 
	`båfs_ªÀa£_dñayed_node
(
dñayed_node
);

1938 
	}
}

1940 
	$båfs_dñayed_upd©e_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

1941 
båfs_roŸ
 *
roŸ
,

1942 
båfs_öode
 *
öode
)

1944 
båfs_dñayed_node
 *
dñayed_node
;

1945 
ªt
 = 0;

1947 
dñayed_node
 = 
	`båfs_gë_‹_¸óã_dñayed_node
(
öode
);

1948 i‡(
	`IS_ERR
(
dñayed_node
))

1949  
	`PTR_ERR
(
dñayed_node
);

1951 
	`muãx_lock
(&
dñayed_node
->
muãx
);

1952 i‡(
	`ã°_bô
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
dñayed_node
->
Êags
)) {

1953 
	`fûl_°ack_öode_ôem
(
å™s
, &
dñayed_node
->
öode_ôem
,

1954 &
öode
->
vfs_öode
);

1955 
ªÀa£_node
;

1958 
ªt
 = 
	`båfs_dñayed_öode_ª£rve_mëad©a
(
å™s
, 
roŸ
, 
dñayed_node
);

1959 i‡(
ªt
)

1960 
ªÀa£_node
;

1962 
	`fûl_°ack_öode_ôem
(
å™s
, &
dñayed_node
->
öode_ôem
, &
öode
->
vfs_öode
);

1963 
	`£t_bô
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
dñayed_node
->
Êags
);

1964 
dñayed_node
->
cou¡
++;

1965 
	`©omic_öc
(&
roŸ
->
fs_öfo
->
dñayed_roŸ
->
ôems
);

1966 
ªÀa£_node
:

1967 
	`muãx_u∆ock
(&
dñayed_node
->
muãx
);

1968 
	`båfs_ªÀa£_dñayed_node
(
dñayed_node
);

1969  
ªt
;

1970 
	}
}

1972 
	$båfs_dñayed_dñëe_öode_ªf
(
båfs_öode
 *
öode
)

1974 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

1975 
båfs_dñayed_node
 *
dñayed_node
;

1982 i‡(
	`ã°_bô
(
BTRFS_FS_LOG_RECOVERING
, &
fs_öfo
->
Êags
))

1983  -
EAGAIN
;

1985 
dñayed_node
 = 
	`båfs_gë_‹_¸óã_dñayed_node
(
öode
);

1986 i‡(
	`IS_ERR
(
dñayed_node
))

1987  
	`PTR_ERR
(
dñayed_node
);

2003 
	`muãx_lock
(&
dñayed_node
->
muãx
);

2004 i‡(
	`ã°_bô
(
BTRFS_DELAYED_NODE_DEL_IREF
, &
dñayed_node
->
Êags
))

2005 
ªÀa£_node
;

2007 
	`£t_bô
(
BTRFS_DELAYED_NODE_DEL_IREF
, &
dñayed_node
->
Êags
);

2008 
dñayed_node
->
cou¡
++;

2009 
	`©omic_öc
(&
fs_öfo
->
dñayed_roŸ
->
ôems
);

2010 
ªÀa£_node
:

2011 
	`muãx_u∆ock
(&
dñayed_node
->
muãx
);

2012 
	`båfs_ªÀa£_dñayed_node
(
dñayed_node
);

2014 
	}
}

2016 
	$__båfs_kûl_dñayed_node
(
båfs_dñayed_node
 *
dñayed_node
)

2018 
båfs_roŸ
 *
roŸ
 = 
dñayed_node
->root;

2019 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

2020 
båfs_dñayed_ôem
 *
cuº_ôem
, *
¥ev_ôem
;

2022 
	`muãx_lock
(&
dñayed_node
->
muãx
);

2023 
cuº_ôem
 = 
	`__båfs_fú°_dñayed_ö£πi⁄_ôem
(
dñayed_node
);

2024 
cuº_ôem
) {

2025 
¥ev_ôem
 = 
cuº_ôem
;

2026 
cuº_ôem
 = 
	`__båfs_√xt_dñayed_ôem
(
¥ev_ôem
);

2027 
	`båfs_ªÀa£_dñayed_ôem
(
¥ev_ôem
);

2030 i‡(
dñayed_node
->
ödex_ôem_Àaves
 > 0) {

2031 
	`båfs_dñayed_ôem_ªÀa£_Àaves
(
dñayed_node
,

2032 
dñayed_node
->
ödex_ôem_Àaves
);

2033 
dñayed_node
->
ödex_ôem_Àaves
 = 0;

2036 
cuº_ôem
 = 
	`__båfs_fú°_dñayed_dñëi⁄_ôem
(
dñayed_node
);

2037 
cuº_ôem
) {

2038 
	`båfs_dñayed_ôem_ªÀa£_mëad©a
(
roŸ
, 
cuº_ôem
);

2039 
¥ev_ôem
 = 
cuº_ôem
;

2040 
cuº_ôem
 = 
	`__båfs_√xt_dñayed_ôem
(
¥ev_ôem
);

2041 
	`båfs_ªÀa£_dñayed_ôem
(
¥ev_ôem
);

2044 
	`båfs_ªÀa£_dñayed_úef
(
dñayed_node
);

2046 i‡(
	`ã°_bô
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
dñayed_node
->
Êags
)) {

2047 
	`båfs_dñayed_öode_ªÀa£_mëad©a
(
fs_öfo
, 
dñayed_node
, 
Ál£
);

2048 
	`båfs_ªÀa£_dñayed_öode
(
dñayed_node
);

2050 
	`muãx_u∆ock
(&
dñayed_node
->
muãx
);

2051 
	}
}

2053 
	$båfs_kûl_dñayed_öode_ôems
(
båfs_öode
 *
öode
)

2055 
båfs_dñayed_node
 *
dñayed_node
;

2057 
dñayed_node
 = 
	`båfs_gë_dñayed_node
(
öode
);

2058 i‡(!
dñayed_node
)

2061 
	`__båfs_kûl_dñayed_node
(
dñayed_node
);

2062 
	`båfs_ªÀa£_dñayed_node
(
dñayed_node
);

2063 
	}
}

2065 
	$båfs_kûl_Æl_dñayed_nodes
(
båfs_roŸ
 *
roŸ
)

2067 
u64
 
öode_id
 = 0;

2068 
båfs_dñayed_node
 *
dñayed_nodes
[8];

2069 
i
, 
n
;

2072 
	`•ö_lock
(&
roŸ
->
öode_lock
);

2073 
n
 = 
	`ødix_åì_g™g_lookup
(&
roŸ
->
dñayed_nodes_åì
,

2074 (**)
dñayed_nodes
, 
öode_id
,

2075 
	`ARRAY_SIZE
(
dñayed_nodes
));

2076 i‡(!
n
) {

2077 
	`•ö_u∆ock
(&
roŸ
->
öode_lock
);

2081 
öode_id
 = 
dñayed_nodes
[
n
 - 1]->inode_id + 1;

2082 
i
 = 0; i < 
n
; i++) {

2087 i‡(!
	`ªfcou¡_öc_nŸ_zîo
(&
dñayed_nodes
[
i
]->
ªfs
))

2088 
dñayed_nodes
[
i
] = 
NULL
;

2090 
	`•ö_u∆ock
(&
roŸ
->
öode_lock
);

2092 
i
 = 0; i < 
n
; i++) {

2093 i‡(!
dñayed_nodes
[
i
])

2095 
	`__båfs_kûl_dñayed_node
(
dñayed_nodes
[
i
]);

2096 
	`båfs_ªÀa£_dñayed_node
(
dñayed_nodes
[
i
]);

2099 
	}
}

2101 
	$båfs_de°roy_dñayed_öodes
(
båfs_fs_öfo
 *
fs_öfo
)

2103 
båfs_dñayed_node
 *
cuº_node
, *
¥ev_node
;

2105 
cuº_node
 = 
	`båfs_fú°_dñayed_node
(
fs_öfo
->
dñayed_roŸ
);

2106 
cuº_node
) {

2107 
	`__båfs_kûl_dñayed_node
(
cuº_node
);

2109 
¥ev_node
 = 
cuº_node
;

2110 
cuº_node
 = 
	`båfs_√xt_dñayed_node
(curr_node);

2111 
	`båfs_ªÀa£_dñayed_node
(
¥ev_node
);

2113 
	}
}

2115 
	$båfs_log_gë_dñayed_ôems
(
båfs_öode
 *
öode
,

2116 
li°_hód
 *
ös_li°
,

2117 
li°_hód
 *
dñ_li°
)

2119 
båfs_dñayed_node
 *
node
;

2120 
båfs_dñayed_ôem
 *
ôem
;

2122 
node
 = 
	`båfs_gë_dñayed_node
(
öode
);

2123 i‡(!
node
)

2126 
	`muãx_lock
(&
node
->
muãx
);

2127 
ôem
 = 
	`__båfs_fú°_dñayed_ö£πi⁄_ôem
(
node
);

2128 
ôem
) {

2152 i‡(!
ôem
->
logged
 && 
	`li°_em±y
(&ôem->
log_li°
)) {

2153 
	`ªfcou¡_öc
(&
ôem
->
ªfs
);

2154 
	`li°_add_èû
(&
ôem
->
log_li°
, 
ös_li°
);

2156 
ôem
 = 
	`__båfs_√xt_dñayed_ôem
(item);

2159 
ôem
 = 
	`__båfs_fú°_dñayed_dñëi⁄_ôem
(
node
);

2160 
ôem
) {

2162 i‡(!
ôem
->
logged
 && 
	`li°_em±y
(&ôem->
log_li°
)) {

2163 
	`ªfcou¡_öc
(&
ôem
->
ªfs
);

2164 
	`li°_add_èû
(&
ôem
->
log_li°
, 
dñ_li°
);

2166 
ôem
 = 
	`__båfs_√xt_dñayed_ôem
(item);

2168 
	`muãx_u∆ock
(&
node
->
muãx
);

2179 
	`ASSERT
(
	`ªfcou¡_ªad
(&
node
->
ªfs
) > 1);

2180 
	`ªfcou¡_dec
(&
node
->
ªfs
);

2181 
	}
}

2183 
	$båfs_log_put_dñayed_ôems
(
båfs_öode
 *
öode
,

2184 
li°_hód
 *
ös_li°
,

2185 
li°_hód
 *
dñ_li°
)

2187 
båfs_dñayed_node
 *
node
;

2188 
båfs_dñayed_ôem
 *
ôem
;

2189 
båfs_dñayed_ôem
 *
√xt
;

2191 
node
 = 
	`båfs_gë_dñayed_node
(
öode
);

2192 i‡(!
node
)

2195 
	`muãx_lock
(&
node
->
muãx
);

2197 
	`li°_f‹_óch_íåy_ß„
(
ôem
, 
√xt
, 
ös_li°
, 
log_li°
) {

2198 
ôem
->
logged
 = 
åue
;

2199 
	`li°_dñ_öô
(&
ôem
->
log_li°
);

2200 i‡(
	`ªfcou¡_dec_™d_ã°
(&
ôem
->
ªfs
))

2201 
	`k‰ì
(
ôem
);

2204 
	`li°_f‹_óch_íåy_ß„
(
ôem
, 
√xt
, 
dñ_li°
, 
log_li°
) {

2205 
ôem
->
logged
 = 
åue
;

2206 
	`li°_dñ_öô
(&
ôem
->
log_li°
);

2207 i‡(
	`ªfcou¡_dec_™d_ã°
(&
ôem
->
ªfs
))

2208 
	`k‰ì
(
ôem
);

2211 
	`muãx_u∆ock
(&
node
->
muãx
);

2222 
	`ASSERT
(
	`ªfcou¡_ªad
(&
node
->
ªfs
) > 1);

2223 
	`ªfcou¡_dec
(&
node
->
ªfs
);

2224 
	}
}

	@delayed-inode.h

7 #i‚de‡
BTRFS_DELAYED_INODE_H


8 
	#BTRFS_DELAYED_INODE_H


	)

10 
	~<löux/rbåì.h
>

11 
	~<löux/•ölock.h
>

12 
	~<löux/muãx.h
>

13 
	~<löux/li°.h
>

14 
	~<löux/waô.h
>

15 
	~<löux/©omic.h
>

16 
	~<löux/ªfcou¡.h
>

17 
	~"˘ªe.h
"

19 
	ebåfs_dñayed_ôem_ty≥
 {

20 
	mBTRFS_DELAYED_INSERTION_ITEM
,

21 
	mBTRFS_DELAYED_DELETION_ITEM


24 
	sbåfs_dñayed_roŸ
 {

25 
•ölock_t
 
	mlock
;

26 
li°_hód
 
	mnode_li°
;

32 
li°_hód
 
	m¥ï¨e_li°
;

33 
©omic_t
 
	môems
;

34 
©omic_t
 
	môems_£q
;

35 
	mnodes
;

36 
waô_queue_hód_t
 
	mwaô
;

39 
	#BTRFS_DELAYED_NODE_IN_LIST
 0

	)

40 
	#BTRFS_DELAYED_NODE_INODE_DIRTY
 1

	)

41 
	#BTRFS_DELAYED_NODE_DEL_IREF
 2

	)

43 
	sbåfs_dñayed_node
 {

44 
u64
 
	möode_id
;

45 
u64
 
	mbyãs_ª£rved
;

46 
båfs_roŸ
 *
	mroŸ
;

48 
li°_hód
 
	mn_li°
;

53 
li°_hód
 
	mp_li°
;

54 
rb_roŸ_ˇched
 
	mös_roŸ
;

55 
rb_roŸ_ˇched
 
	mdñ_roŸ
;

56 
muãx
 
	mmuãx
;

57 
båfs_öode_ôem
 
	möode_ôem
;

58 
ªfcou¡_t
 
	mªfs
;

59 
u64
 
	mödex_˙t
;

60 
	mÊags
;

61 
	mcou¡
;

66 
u32
 
	mcuº_ödex_b©ch_size
;

72 
u32
 
	mödex_ôem_Àaves
;

75 
	sbåfs_dñayed_ôem
 {

76 
rb_node
 
	mrb_node
;

78 
u64
 
	mödex
;

79 
li°_hód
 
	måì_li°
;

80 
li°_hód
 
	mªaddú_li°
;

86 
li°_hód
 
	mlog_li°
;

87 
u64
 
	mbyãs_ª£rved
;

88 
båfs_dñayed_node
 *
	mdñayed_node
;

89 
ªfcou¡_t
 
	mªfs
;

90 
båfs_dñayed_ôem_ty≥
 
	mty≥
:8;

95 
boﬁ
 
	mlogged
;

97 
u16
 
	md©a_Àn
;

98 
	md©a
[] 
__cou¡ed_by
(
d©a_Àn
);

101 
ölöe
 
	$båfs_öô_dñayed_roŸ
(

102 
båfs_dñayed_roŸ
 *
dñayed_roŸ
)

104 
	`©omic_£t
(&
dñayed_roŸ
->
ôems
, 0);

105 
	`©omic_£t
(&
dñayed_roŸ
->
ôems_£q
, 0);

106 
dñayed_roŸ
->
nodes
 = 0;

107 
	`•ö_lock_öô
(&
dñayed_roŸ
->
lock
);

108 
	`öô_waôqueue_hód
(&
dñayed_roŸ
->
waô
);

109 
	`INIT_LIST_HEAD
(&
dñayed_roŸ
->
node_li°
);

110 
	`INIT_LIST_HEAD
(&
dñayed_roŸ
->
¥ï¨e_li°
);

111 
	}
}

113 
båfs_ö£π_dñayed_dú_ödex
(
båfs_å™s_h™dÀ
 *
å™s
,

114 c⁄° *
«me
, 
«me_Àn
,

115 
båfs_öode
 *
dú
,

116 
båfs_disk_key
 *
disk_key
, 
u8
 
Êags
,

117 
u64
 
ödex
);

119 
båfs_dñëe_dñayed_dú_ödex
(
båfs_å™s_h™dÀ
 *
å™s
,

120 
båfs_öode
 *
dú
, 
u64
 
ödex
);

122 
båfs_öode_dñayed_dú_ödex_cou¡
(
båfs_öode
 *
öode
);

124 
båfs_run_dñayed_ôems
(
båfs_å™s_h™dÀ
 *
å™s
);

125 
båfs_run_dñayed_ôems_ƒ
(
båfs_å™s_h™dÀ
 *
å™s
, 
ƒ
);

127 
båfs_bÆ™˚_dñayed_ôems
(
båfs_fs_öfo
 *
fs_öfo
);

129 
båfs_commô_öode_dñayed_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

130 
båfs_öode
 *
öode
);

132 
båfs_ªmove_dñayed_node
(
båfs_öode
 *
öode
);

133 
båfs_kûl_dñayed_öode_ôems
(
båfs_öode
 *
öode
);

134 
båfs_commô_öode_dñayed_öode
(
båfs_öode
 *
öode
);

137 
båfs_dñayed_upd©e_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

138 
båfs_roŸ
 *
roŸ
,

139 
båfs_öode
 *
öode
);

140 
båfs_fûl_öode
(
öode
 *öode, 
u32
 *
rdev
);

141 
båfs_dñayed_dñëe_öode_ªf
(
båfs_öode
 *
öode
);

144 
båfs_kûl_Æl_dñayed_nodes
(
båfs_roŸ
 *
roŸ
);

147 
båfs_de°roy_dñayed_öodes
(
båfs_fs_öfo
 *
fs_öfo
);

150 
boﬁ
 
båfs_ªaddú_gë_dñayed_ôems
(
öode
 *inode,

151 
u64
 
œ°_ödex
,

152 
li°_hód
 *
ös_li°
,

153 
li°_hód
 *
dñ_li°
);

154 
båfs_ªaddú_put_dñayed_ôems
(
öode
 *inode,

155 
li°_hód
 *
ös_li°
,

156 
li°_hód
 *
dñ_li°
);

157 
båfs_should_dñëe_dú_ödex
(
li°_hód
 *
dñ_li°
,

158 
u64
 
ödex
);

159 
båfs_ªaddú_dñayed_dú_ödex
(
dú_c⁄ãxt
 *
˘x
,

160 
li°_hód
 *
ös_li°
);

163 
båfs_log_gë_dñayed_ôems
(
båfs_öode
 *
öode
,

164 
li°_hód
 *
ös_li°
,

165 
li°_hód
 *
dñ_li°
);

166 
båfs_log_put_dñayed_ôems
(
båfs_öode
 *
öode
,

167 
li°_hód
 *
ös_li°
,

168 
li°_hód
 *
dñ_li°
);

171 
__öô
 
båfs_dñayed_öode_öô
();

172 
__cﬁd
 
båfs_dñayed_öode_exô
();

175 
båfs_as£π_dñayed_roŸ_em±y
(
båfs_fs_öfo
 *
fs_öfo
);

	@delayed-ref.c

6 
	~<löux/sched.h
>

7 
	~<löux/¶ab.h
>

8 
	~<löux/s‹t.h
>

9 
	~"mesßges.h
"

10 
	~"˘ªe.h
"

11 
	~"dñayed-ªf.h
"

12 
	~"å™ß˘i⁄.h
"

13 
	~"qgroup.h
"

14 
	~"•a˚-öfo.h
"

15 
	~"åì-mod-log.h
"

16 
	~"fs.h
"

18 
kmem_ˇche
 *
	gbåfs_dñayed_ªf_hód_ˇchï
;

19 
kmem_ˇche
 *
	gbåfs_dñayed_åì_ªf_ˇchï
;

20 
kmem_ˇche
 *
	gbåfs_dñayed_d©a_ªf_ˇchï
;

21 
kmem_ˇche
 *
	gbåfs_dñayed_exã¡_›_ˇchï
;

31 
boﬁ
 
	$båfs_check_•a˚_f‹_dñayed_ªfs
(
båfs_fs_öfo
 *
fs_öfo
)

33 
båfs_block_rsv
 *
dñayed_ªfs_rsv
 = &
fs_öfo
->delayed_refs_rsv;

34 
båfs_block_rsv
 *
globÆ_rsv
 = &
fs_öfo
->
globÆ_block_rsv
;

35 
boﬁ
 
ªt
 = 
Ál£
;

36 
u64
 
ª£rved
;

38 
	`•ö_lock
(&
globÆ_rsv
->
lock
);

39 
ª£rved
 = 
globÆ_rsv
->reserved;

40 
	`•ö_u∆ock
(&
globÆ_rsv
->
lock
);

48 
	`•ö_lock
(&
dñayed_ªfs_rsv
->
lock
);

49 
ª£rved
 +
dñayed_ªfs_rsv
->reserved;

50 i‡(
dñayed_ªfs_rsv
->
size
 >
ª£rved
)

51 
ªt
 = 
åue
;

52 
	`•ö_u∆ock
(&
dñayed_ªfs_rsv
->
lock
);

53  
ªt
;

54 
	}
}

65 
	$båfs_dñayed_ªfs_rsv_ªÀa£
(
båfs_fs_öfo
 *
fs_öfo
, 
ƒ
)

67 
båfs_block_rsv
 *
block_rsv
 = &
fs_öfo
->
dñayed_ªfs_rsv
;

68 c⁄° 
u64
 
num_byãs
 = 
	`båfs_ˇlc_dñayed_ªf_byãs
(
fs_öfo
, 
ƒ
);

69 
u64
 
ªÀa£d
 = 0;

71 
ªÀa£d
 = 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, 
block_rsv
, 
num_byãs
, 
NULL
);

72 i‡(
ªÀa£d
)

73 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, "delayed_refs_rsv",

74 0, 
ªÀa£d
, 0);

75 
	}
}

83 
	$båfs_upd©e_dñayed_ªfs_rsv
(
båfs_å™s_h™dÀ
 *
å™s
)

85 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

86 
båfs_block_rsv
 *
dñayed_rsv
 = &
fs_öfo
->
dñayed_ªfs_rsv
;

87 
u64
 
num_byãs
;

89 i‡(!
å™s
->
dñayed_ªf_upd©es
)

92 
num_byãs
 = 
	`båfs_ˇlc_dñayed_ªf_byãs
(
fs_öfo
,

93 
å™s
->
dñayed_ªf_upd©es
);

95 
	`•ö_lock
(&
dñayed_rsv
->
lock
);

96 
dñayed_rsv
->
size
 +
num_byãs
;

97 
dñayed_rsv
->
fuŒ
 = 
Ál£
;

98 
	`•ö_u∆ock
(&
dñayed_rsv
->
lock
);

99 
å™s
->
dñayed_ªf_upd©es
 = 0;

100 
	}
}

111 
	$båfs_migøã_to_dñayed_ªfs_rsv
(
båfs_fs_öfo
 *
fs_öfo
,

112 
u64
 
num_byãs
)

114 
båfs_block_rsv
 *
dñayed_ªfs_rsv
 = &
fs_öfo
->delayed_refs_rsv;

115 
u64
 
to_‰ì
 = 0;

117 
	`•ö_lock
(&
dñayed_ªfs_rsv
->
lock
);

118 i‡(
dñayed_ªfs_rsv
->
size
 > dñayed_ªfs_rsv->
ª£rved
) {

119 
u64
 
dñè
 = 
dñayed_ªfs_rsv
->
size
 -

120 
dñayed_ªfs_rsv
->
ª£rved
;

121 i‡(
num_byãs
 > 
dñè
) {

122 
to_‰ì
 = 
num_byãs
 - 
dñè
;

123 
num_byãs
 = 
dñè
;

126 
to_‰ì
 = 
num_byãs
;

127 
num_byãs
 = 0;

130 i‡(
num_byãs
)

131 
dñayed_ªfs_rsv
->
ª£rved
 +
num_byãs
;

132 i‡(
dñayed_ªfs_rsv
->
ª£rved
 >dñayed_ªfs_rsv->
size
)

133 
dñayed_ªfs_rsv
->
fuŒ
 = 
åue
;

134 
	`•ö_u∆ock
(&
dñayed_ªfs_rsv
->
lock
);

136 i‡(
num_byãs
)

137 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, "delayed_refs_rsv",

138 0, 
num_byãs
, 1);

139 i‡(
to_‰ì
)

140 
	`båfs_•a˚_öfo_‰ì_byãs_may_u£
(
fs_öfo
,

141 
dñayed_ªfs_rsv
->
•a˚_öfo
, 
to_‰ì
);

142 
	}
}

153 
	$båfs_dñayed_ªfs_rsv_ªfûl
(
båfs_fs_öfo
 *
fs_öfo
,

154 
båfs_ª£rve_Êush_íum
 
Êush
)

156 
båfs_block_rsv
 *
block_rsv
 = &
fs_öfo
->
dñayed_ªfs_rsv
;

157 
u64
 
limô
 = 
	`båfs_ˇlc_dñayed_ªf_byãs
(
fs_öfo
, 1);

158 
u64
 
num_byãs
 = 0;

159 
u64
 
ªfûÀd_byãs
;

160 
u64
 
to_‰ì
;

161 
ªt
 = -
ENOSPC
;

163 
	`•ö_lock
(&
block_rsv
->
lock
);

164 i‡(
block_rsv
->
ª£rved
 < block_rsv->
size
) {

165 
num_byãs
 = 
block_rsv
->
size
 - block_rsv->
ª£rved
;

166 
num_byãs
 = 
	`mö
“um_byãs, 
limô
);

168 
	`•ö_u∆ock
(&
block_rsv
->
lock
);

170 i‡(!
num_byãs
)

173 
ªt
 = 
	`båfs_ª£rve_mëad©a_byãs
(
fs_öfo
, 
block_rsv
, 
num_byãs
, 
Êush
);

174 i‡(
ªt
)

175  
ªt
;

181 
	`•ö_lock
(&
block_rsv
->
lock
);

182 i‡(
block_rsv
->
ª£rved
 < block_rsv->
size
) {

183 
u64
 
√eded
 = 
block_rsv
->
size
 - block_rsv->
ª£rved
;

185 i‡(
num_byãs
 >
√eded
) {

186 
block_rsv
->
ª£rved
 +
√eded
;

187 
block_rsv
->
fuŒ
 = 
åue
;

188 
to_‰ì
 = 
num_byãs
 - 
√eded
;

189 
ªfûÀd_byãs
 = 
√eded
;

191 
block_rsv
->
ª£rved
 +
num_byãs
;

192 
to_‰ì
 = 0;

193 
ªfûÀd_byãs
 = 
num_byãs
;

196 
to_‰ì
 = 
num_byãs
;

197 
ªfûÀd_byãs
 = 0;

199 
	`•ö_u∆ock
(&
block_rsv
->
lock
);

201 i‡(
to_‰ì
 > 0)

202 
	`båfs_•a˚_öfo_‰ì_byãs_may_u£
(
fs_öfo
, 
block_rsv
->
•a˚_öfo
,

203 
to_‰ì
);

205 i‡(
ªfûÀd_byãs
 > 0)

206 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, "delayed_refs_rsv", 0,

207 
ªfûÀd_byãs
, 1);

209 
	}
}

214 
	$comp_åì_ªfs
(
båfs_dñayed_åì_ªf
 *
ªf1
,

215 
båfs_dñayed_åì_ªf
 *
ªf2
)

217 i‡(
ªf1
->
node
.
ty≥
 =
BTRFS_TREE_BLOCK_REF_KEY
) {

218 i‡(
ªf1
->
roŸ
 < 
ªf2
->root)

220 i‡(
ªf1
->
roŸ
 > 
ªf2
->root)

223 i‡(
ªf1
->
∑ª¡
 < 
ªf2
->parent)

225 i‡(
ªf1
->
∑ª¡
 > 
ªf2
->parent)

229 
	}
}

234 
	$comp_d©a_ªfs
(
båfs_dñayed_d©a_ªf
 *
ªf1
,

235 
båfs_dñayed_d©a_ªf
 *
ªf2
)

237 i‡(
ªf1
->
node
.
ty≥
 =
BTRFS_EXTENT_DATA_REF_KEY
) {

238 i‡(
ªf1
->
roŸ
 < 
ªf2
->root)

240 i‡(
ªf1
->
roŸ
 > 
ªf2
->root)

242 i‡(
ªf1
->
obje˘id
 < 
ªf2
->objectid)

244 i‡(
ªf1
->
obje˘id
 > 
ªf2
->objectid)

246 i‡(
ªf1
->
off£t
 < 
ªf2
->offset)

248 i‡(
ªf1
->
off£t
 > 
ªf2
->offset)

251 i‡(
ªf1
->
∑ª¡
 < 
ªf2
->parent)

253 i‡(
ªf1
->
∑ª¡
 > 
ªf2
->parent)

257 
	}
}

259 
	$comp_ªfs
(
båfs_dñayed_ªf_node
 *
ªf1
,

260 
båfs_dñayed_ªf_node
 *
ªf2
,

261 
boﬁ
 
check_£q
)

263 
ªt
 = 0;

265 i‡(
ªf1
->
ty≥
 < 
ªf2
->type)

267 i‡(
ªf1
->
ty≥
 > 
ªf2
->type)

269 i‡(
ªf1
->
ty≥
 =
BTRFS_TREE_BLOCK_REF_KEY
 ||

270 
ªf1
->
ty≥
 =
BTRFS_SHARED_BLOCK_REF_KEY
)

271 
ªt
 = 
	`comp_åì_ªfs
(
	`båfs_dñayed_node_to_åì_ªf
(
ªf1
),

272 
	`båfs_dñayed_node_to_åì_ªf
(
ªf2
));

274 
ªt
 = 
	`comp_d©a_ªfs
(
	`båfs_dñayed_node_to_d©a_ªf
(
ªf1
),

275 
	`båfs_dñayed_node_to_d©a_ªf
(
ªf2
));

276 i‡(
ªt
)

277  
ªt
;

278 i‡(
check_£q
) {

279 i‡(
ªf1
->
£q
 < 
ªf2
->seq)

281 i‡(
ªf1
->
£q
 > 
ªf2
->seq)

285 
	}
}

288 
båfs_dñayed_ªf_hód
 *
	$håì_ö£π
(
rb_roŸ_ˇched
 *
roŸ
,

289 
rb_node
 *
node
)

291 
rb_node
 **
p
 = &
roŸ
->
rb_roŸ
.rb_node;

292 
rb_node
 *
∑ª¡_node
 = 
NULL
;

293 
båfs_dñayed_ªf_hód
 *
íåy
;

294 
båfs_dñayed_ªf_hód
 *
ös
;

295 
u64
 
byãƒ
;

296 
boﬁ
 
À·mo°
 = 
åue
;

298 
ös
 = 
	`rb_íåy
(
node
, 
båfs_dñayed_ªf_hód
, 
hªf_node
);

299 
byãƒ
 = 
ös
->bytenr;

300 *
p
) {

301 
∑ª¡_node
 = *
p
;

302 
íåy
 = 
	`rb_íåy
(
∑ª¡_node
, 
båfs_dñayed_ªf_hód
,

303 
hªf_node
);

305 i‡(
byãƒ
 < 
íåy
->bytenr) {

306 
p
 = &(*p)->
rb_À·
;

307 } i‡(
byãƒ
 > 
íåy
->bytenr) {

308 
p
 = &(*p)->
rb_right
;

309 
À·mo°
 = 
Ál£
;

311  
íåy
;

315 
	`rb_lök_node
(
node
, 
∑ª¡_node
, 
p
);

316 
	`rb_ö£π_cﬁ‹_ˇched
(
node
, 
roŸ
, 
À·mo°
);

317  
NULL
;

318 
	}
}

320 
båfs_dñayed_ªf_node
* 
	$åì_ö£π
(
rb_roŸ_ˇched
 *
roŸ
,

321 
båfs_dñayed_ªf_node
 *
ös
)

323 
rb_node
 **
p
 = &
roŸ
->
rb_roŸ
.rb_node;

324 
rb_node
 *
node
 = &
ös
->
ªf_node
;

325 
rb_node
 *
∑ª¡_node
 = 
NULL
;

326 
båfs_dñayed_ªf_node
 *
íåy
;

327 
boﬁ
 
À·mo°
 = 
åue
;

329 *
p
) {

330 
comp
;

332 
∑ª¡_node
 = *
p
;

333 
íåy
 = 
	`rb_íåy
(
∑ª¡_node
, 
båfs_dñayed_ªf_node
,

334 
ªf_node
);

335 
comp
 = 
	`comp_ªfs
(
ös
, 
íåy
, 
åue
);

336 i‡(
comp
 < 0) {

337 
p
 = &(*p)->
rb_À·
;

338 } i‡(
comp
 > 0) {

339 
p
 = &(*p)->
rb_right
;

340 
À·mo°
 = 
Ál£
;

342  
íåy
;

346 
	`rb_lök_node
(
node
, 
∑ª¡_node
, 
p
);

347 
	`rb_ö£π_cﬁ‹_ˇched
(
node
, 
roŸ
, 
À·mo°
);

348  
NULL
;

349 
	}
}

351 
båfs_dñayed_ªf_hód
 *
	$föd_fú°_ªf_hód
(

352 
båfs_dñayed_ªf_roŸ
 *
dr
)

354 
rb_node
 *
n
;

355 
båfs_dñayed_ªf_hód
 *
íåy
;

357 
n
 = 
	`rb_fú°_ˇched
(&
dr
->
hªf_roŸ
);

358 i‡(!
n
)

359  
NULL
;

361 
íåy
 = 
	`rb_íåy
(
n
, 
båfs_dñayed_ªf_hód
, 
hªf_node
);

363  
íåy
;

364 
	}
}

371 
båfs_dñayed_ªf_hód
 *
	$föd_ªf_hód
(

372 
båfs_dñayed_ªf_roŸ
 *
dr
, 
u64
 
byãƒ
,

373 
boﬁ
 
ªtu∫_biggî
)

375 
rb_roŸ
 *
roŸ
 = &
dr
->
hªf_roŸ
.rb_root;

376 
rb_node
 *
n
;

377 
båfs_dñayed_ªf_hód
 *
íåy
;

379 
n
 = 
roŸ
->
rb_node
;

380 
íåy
 = 
NULL
;

381 
n
) {

382 
íåy
 = 
	`rb_íåy
(
n
, 
båfs_dñayed_ªf_hód
, 
hªf_node
);

384 i‡(
byãƒ
 < 
íåy
->bytenr)

385 
n
 =Ç->
rb_À·
;

386 i‡(
byãƒ
 > 
íåy
->bytenr)

387 
n
 =Ç->
rb_right
;

389  
íåy
;

391 i‡(
íåy
 && 
ªtu∫_biggî
) {

392 i‡(
byãƒ
 > 
íåy
->bytenr) {

393 
n
 = 
	`rb_√xt
(&
íåy
->
hªf_node
);

394 i‡(!
n
)

395  
NULL
;

396 
íåy
 = 
	`rb_íåy
(
n
, 
båfs_dñayed_ªf_hód
,

397 
hªf_node
);

399  
íåy
;

401  
NULL
;

402 
	}
}

404 
	$båfs_dñayed_ªf_lock
(
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
,

405 
båfs_dñayed_ªf_hód
 *
hód
)

407 
	`lockdï_as£π_hñd
(&
dñayed_ªfs
->
lock
);

408 i‡(
	`muãx_åylock
(&
hód
->
muãx
))

411 
	`ªfcou¡_öc
(&
hód
->
ªfs
);

412 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

414 
	`muãx_lock
(&
hód
->
muãx
);

415 
	`•ö_lock
(&
dñayed_ªfs
->
lock
);

416 i‡(
	`RB_EMPTY_NODE
(&
hód
->
hªf_node
)) {

417 
	`muãx_u∆ock
(&
hód
->
muãx
);

418 
	`båfs_put_dñayed_ªf_hód
(
hód
);

419  -
EAGAIN
;

421 
	`båfs_put_dñayed_ªf_hód
(
hód
);

423 
	}
}

425 
ölöe
 
	$dr›_dñayed_ªf
(
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
,

426 
båfs_dñayed_ªf_hód
 *
hód
,

427 
båfs_dñayed_ªf_node
 *
ªf
)

429 
	`lockdï_as£π_hñd
(&
hód
->
lock
);

430 
	`rb_îa£_ˇched
(&
ªf
->
ªf_node
, &
hód
->
ªf_åì
);

431 
	`RB_CLEAR_NODE
(&
ªf
->
ªf_node
);

432 i‡(!
	`li°_em±y
(&
ªf
->
add_li°
))

433 
	`li°_dñ
(&
ªf
->
add_li°
);

434 
	`båfs_put_dñayed_ªf
(
ªf
);

435 
	`©omic_dec
(&
dñayed_ªfs
->
num_íåõs
);

436 
	}
}

438 
boﬁ
 
	$mîge_ªf
(
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
,

439 
båfs_dñayed_ªf_hód
 *
hód
,

440 
båfs_dñayed_ªf_node
 *
ªf
,

441 
u64
 
£q
)

443 
båfs_dñayed_ªf_node
 *
√xt
;

444 
rb_node
 *
node
 = 
	`rb_√xt
(&
ªf
->
ªf_node
);

445 
boﬁ
 
d⁄e
 = 
Ál£
;

447 !
d⁄e
 && 
node
) {

448 
mod
;

450 
√xt
 = 
	`rb_íåy
(
node
, 
båfs_dñayed_ªf_node
, 
ªf_node
);

451 
node
 = 
	`rb_√xt
(node);

452 i‡(
£q
 && 
√xt
->seq >= seq)

454 i‡(
	`comp_ªfs
(
ªf
, 
√xt
, 
Ál£
))

457 i‡(
ªf
->
a˘i⁄
 =
√xt
->action) {

458 
mod
 = 
√xt
->
ªf_mod
;

460 i‡(
ªf
->
ªf_mod
 < 
√xt
->ref_mod) {

461 
	`sw≠
(
ªf
, 
√xt
);

462 
d⁄e
 = 
åue
;

464 
mod
 = -
√xt
->
ªf_mod
;

467 
	`dr›_dñayed_ªf
(
dñayed_ªfs
, 
hód
, 
√xt
);

468 
ªf
->
ªf_mod
 +
mod
;

469 i‡(
ªf
->
ªf_mod
 == 0) {

470 
	`dr›_dñayed_ªf
(
dñayed_ªfs
, 
hód
, 
ªf
);

471 
d⁄e
 = 
åue
;

476 
	`WARN_ON
(
ªf
->
ty≥
 =
BTRFS_TREE_BLOCK_REF_KEY
 ||

477 
ªf
->
ty≥
 =
BTRFS_SHARED_BLOCK_REF_KEY
);

481  
d⁄e
;

482 
	}
}

484 
	$båfs_mîge_dñayed_ªfs
(
båfs_fs_öfo
 *
fs_öfo
,

485 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
,

486 
båfs_dñayed_ªf_hód
 *
hód
)

488 
båfs_dñayed_ªf_node
 *
ªf
;

489 
rb_node
 *
node
;

490 
u64
 
£q
 = 0;

492 
	`lockdï_as£π_hñd
(&
hód
->
lock
);

494 i‡(
	`RB_EMPTY_ROOT
(&
hód
->
ªf_åì
.
rb_roŸ
))

498 i‡(
hód
->
is_d©a
)

501 
£q
 = 
	`båfs_åì_mod_log_lowe°_£q
(
fs_öfo
);

502 
agaö
:

503 
node
 = 
	`rb_fú°_ˇched
(&
hód
->
ªf_åì
);Çode;

504 
node
 = 
	`rb_√xt
(node)) {

505 
ªf
 = 
	`rb_íåy
(
node
, 
båfs_dñayed_ªf_node
, 
ªf_node
);

506 i‡(
£q
 && 
ªf
->seq >= seq)

508 i‡(
	`mîge_ªf
(
dñayed_ªfs
, 
hód
, 
ªf
, 
£q
))

509 
agaö
;

511 
	}
}

513 
	$båfs_check_dñayed_£q
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
£q
)

515 
ªt
 = 0;

516 
u64
 
mö_£q
 = 
	`båfs_åì_mod_log_lowe°_£q
(
fs_öfo
);

518 i‡(
mö_£q
 !0 && 
£q
 >= min_seq) {

519 
	`båfs_debug
(
fs_öfo
,

521 
£q
, 
mö_£q
);

522 
ªt
 = 1;

525  
ªt
;

526 
	}
}

528 
båfs_dñayed_ªf_hód
 *
	$båfs_£À˘_ªf_hód
(

529 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
)

531 
båfs_dñayed_ªf_hód
 *
hód
;

533 
	`lockdï_as£π_hñd
(&
dñayed_ªfs
->
lock
);

534 
agaö
:

535 
hód
 = 
	`föd_ªf_hód
(
dñayed_ªfs
, dñayed_ªfs->
run_dñayed_°¨t
,

536 
åue
);

537 i‡(!
hód
 && 
dñayed_ªfs
->
run_dñayed_°¨t
 != 0) {

538 
dñayed_ªfs
->
run_dñayed_°¨t
 = 0;

539 
hód
 = 
	`föd_fú°_ªf_hód
(
dñayed_ªfs
);

541 i‡(!
hód
)

542  
NULL
;

544 
hód
->
¥o˚ssög
) {

545 
rb_node
 *
node
;

547 
node
 = 
	`rb_√xt
(&
hód
->
hªf_node
);

548 i‡(!
node
) {

549 i‡(
dñayed_ªfs
->
run_dñayed_°¨t
 == 0)

550  
NULL
;

551 
dñayed_ªfs
->
run_dñayed_°¨t
 = 0;

552 
agaö
;

554 
hód
 = 
	`rb_íåy
(
node
, 
båfs_dñayed_ªf_hód
,

555 
hªf_node
);

558 
hód
->
¥o˚ssög
 = 
åue
;

559 
	`WARN_ON
(
dñayed_ªfs
->
num_hóds_ªady
 == 0);

560 
dñayed_ªfs
->
num_hóds_ªady
--;

561 
dñayed_ªfs
->
run_dñayed_°¨t
 = 
hód
->
byãƒ
 +

562 
hód
->
num_byãs
;

563  
hód
;

564 
	}
}

566 
	$båfs_dñëe_ªf_hód
(
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
,

567 
båfs_dñayed_ªf_hód
 *
hód
)

569 
	`lockdï_as£π_hñd
(&
dñayed_ªfs
->
lock
);

570 
	`lockdï_as£π_hñd
(&
hód
->
lock
);

572 
	`rb_îa£_ˇched
(&
hód
->
hªf_node
, &
dñayed_ªfs
->
hªf_roŸ
);

573 
	`RB_CLEAR_NODE
(&
hód
->
hªf_node
);

574 
	`©omic_dec
(&
dñayed_ªfs
->
num_íåõs
);

575 
dñayed_ªfs
->
num_hóds
--;

576 i‡(!
hód
->
¥o˚ssög
)

577 
dñayed_ªfs
->
num_hóds_ªady
--;

578 
	}
}

587 
boﬁ
 
	$ö£π_dñayed_ªf
(
båfs_dñayed_ªf_roŸ
 *
roŸ
,

588 
båfs_dñayed_ªf_hód
 *
hªf
,

589 
båfs_dñayed_ªf_node
 *
ªf
)

591 
båfs_dñayed_ªf_node
 *
exi°
;

592 
mod
;

594 
	`•ö_lock
(&
hªf
->
lock
);

595 
exi°
 = 
	`åì_ö£π
(&
hªf
->
ªf_åì
, 
ªf
);

596 i‡(!
exi°
) {

597 i‡(
ªf
->
a˘i⁄
 =
BTRFS_ADD_DELAYED_REF
)

598 
	`li°_add_èû
(&
ªf
->
add_li°
, &
hªf
->
ªf_add_li°
);

599 
	`©omic_öc
(&
roŸ
->
num_íåõs
);

600 
	`•ö_u∆ock
(&
hªf
->
lock
);

601  
Ál£
;

605 i‡(
exi°
->
a˘i⁄
 =
ªf
->action) {

606 
mod
 = 
ªf
->
ªf_mod
;

609 i‡(
exi°
->
ªf_mod
 < 
ªf
->ref_mod) {

610 
exi°
->
a˘i⁄
 = 
ªf
->action;

611 
mod
 = -
exi°
->
ªf_mod
;

612 
exi°
->
ªf_mod
 = 
ªf
->ref_mod;

613 i‡(
ªf
->
a˘i⁄
 =
BTRFS_ADD_DELAYED_REF
)

614 
	`li°_add_èû
(&
exi°
->
add_li°
,

615 &
hªf
->
ªf_add_li°
);

616 i‡(
ªf
->
a˘i⁄
 =
BTRFS_DROP_DELAYED_REF
) {

617 
	`ASSERT
(!
	`li°_em±y
(&
exi°
->
add_li°
));

618 
	`li°_dñ
(&
exi°
->
add_li°
);

620 
	`ASSERT
(0);

623 
mod
 = -
ªf
->
ªf_mod
;

625 
exi°
->
ªf_mod
 +
mod
;

628 i‡(
exi°
->
ªf_mod
 == 0)

629 
	`dr›_dñayed_ªf
(
roŸ
, 
hªf
, 
exi°
);

630 
	`•ö_u∆ock
(&
hªf
->
lock
);

631  
åue
;

632 
	}
}

638 
noölöe
 
	$upd©e_exi°ög_hód_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

639 
båfs_dñayed_ªf_hód
 *
exi°ög
,

640 
båfs_dñayed_ªf_hód
 *
upd©e
)

642 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
 =

643 &
å™s
->
å™ß˘i⁄
->
dñayed_ªfs
;

644 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

645 
ﬁd_ªf_mod
;

647 
	`BUG_ON
(
exi°ög
->
is_d©a
 !
upd©e
->is_data);

649 
	`•ö_lock
(&
exi°ög
->
lock
);

650 i‡(
upd©e
->
mu°_ö£π_ª£rved
) {

658 
exi°ög
->
mu°_ö£π_ª£rved
 = 
upd©e
->must_insert_reserved;

664 
exi°ög
->
num_byãs
 = 
upd©e
->num_bytes;

668 i‡(
upd©e
->
exã¡_›
) {

669 i‡(!
exi°ög
->
exã¡_›
) {

670 
exi°ög
->
exã¡_›
 = 
upd©e
->extent_op;

672 i‡(
upd©e
->
exã¡_›
->
upd©e_key
) {

673 
	`mem˝y
(&
exi°ög
->
exã¡_›
->
key
,

674 &
upd©e
->
exã¡_›
->
key
,

675 (
upd©e
->
exã¡_›
->
key
));

676 
exi°ög
->
exã¡_›
->
upd©e_key
 = 
åue
;

678 i‡(
upd©e
->
exã¡_›
->
upd©e_Êags
) {

679 
exi°ög
->
exã¡_›
->
Êags_to_£t
 |=

680 
upd©e
->
exã¡_›
->
Êags_to_£t
;

681 
exi°ög
->
exã¡_›
->
upd©e_Êags
 = 
åue
;

683 
	`båfs_‰ì_dñayed_exã¡_›
(
upd©e
->
exã¡_›
);

691 
ﬁd_ªf_mod
 = 
exi°ög
->
tŸÆ_ªf_mod
;

692 
exi°ög
->
ªf_mod
 +
upd©e
->ref_mod;

693 
exi°ög
->
tŸÆ_ªf_mod
 +
upd©e
->
ªf_mod
;

699 i‡(
exi°ög
->
is_d©a
) {

700 
u64
 
csum_Àaves
 =

701 
	`båfs_csum_byãs_to_Àaves
(
fs_öfo
,

702 
exi°ög
->
num_byãs
);

704 i‡(
exi°ög
->
tŸÆ_ªf_mod
 >0 && 
ﬁd_ªf_mod
 < 0) {

705 
dñayed_ªfs
->
≥ndög_csums
 -
exi°ög
->
num_byãs
;

706 
	`båfs_dñayed_ªfs_rsv_ªÀa£
(
fs_öfo
, 
csum_Àaves
);

708 i‡(
exi°ög
->
tŸÆ_ªf_mod
 < 0 && 
ﬁd_ªf_mod
 >= 0) {

709 
dñayed_ªfs
->
≥ndög_csums
 +
exi°ög
->
num_byãs
;

710 
å™s
->
dñayed_ªf_upd©es
 +
csum_Àaves
;

714 
	`•ö_u∆ock
(&
exi°ög
->
lock
);

715 
	}
}

717 
	$öô_dñayed_ªf_hód
(
båfs_dñayed_ªf_hód
 *
hód_ªf
,

718 
båfs_qgroup_exã¡_ªc‹d
 *
qªc‹d
,

719 
u64
 
byãƒ
, u64 
num_byãs
, u64 
ªf_roŸ
,

720 
u64
 
ª£rved
, 
a˘i⁄
, 
boﬁ
 
is_d©a
,

721 
boﬁ
 
is_sy°em
)

723 
cou¡_mod
 = 1;

724 
boﬁ
 
mu°_ö£π_ª£rved
 = 
Ál£
;

727 
	`BUG_ON
(!
is_d©a
 && 
ª£rved
);

729 
a˘i⁄
) {

730 
BTRFS_UPDATE_DELAYED_HEAD
:

731 
cou¡_mod
 = 0;

733 
BTRFS_DROP_DELAYED_REF
:

738 
cou¡_mod
 = -1;

740 
BTRFS_ADD_DELAYED_EXTENT
:

753 
mu°_ö£π_ª£rved
 = 
åue
;

757 
	`ªfcou¡_£t
(&
hód_ªf
->
ªfs
, 1);

758 
hód_ªf
->
byãƒ
 = bytenr;

759 
hód_ªf
->
num_byãs
 =Çum_bytes;

760 
hód_ªf
->
ªf_mod
 = 
cou¡_mod
;

761 
hód_ªf
->
mu°_ö£π_ª£rved
 = must_insert_reserved;

762 
hód_ªf
->
is_d©a
 = is_data;

763 
hód_ªf
->
is_sy°em
 = is_system;

764 
hód_ªf
->
ªf_åì
 = 
RB_ROOT_CACHED
;

765 
	`INIT_LIST_HEAD
(&
hód_ªf
->
ªf_add_li°
);

766 
	`RB_CLEAR_NODE
(&
hód_ªf
->
hªf_node
);

767 
hód_ªf
->
¥o˚ssög
 = 
Ál£
;

768 
hód_ªf
->
tŸÆ_ªf_mod
 = 
cou¡_mod
;

769 
	`•ö_lock_öô
(&
hód_ªf
->
lock
);

770 
	`muãx_öô
(&
hód_ªf
->
muãx
);

772 i‡(
qªc‹d
) {

773 i‡(
ªf_roŸ
 && 
ª£rved
) {

774 
qªc‹d
->
d©a_rsv
 = 
ª£rved
;

775 
qªc‹d
->
d©a_rsv_ª‰oŸ
 = 
ªf_roŸ
;

777 
qªc‹d
->
byãƒ
 = bytenr;

778 
qªc‹d
->
num_byãs
 =Çum_bytes;

779 
qªc‹d
->
ﬁd_roŸs
 = 
NULL
;

781 
	}
}

788 
noölöe
 
båfs_dñayed_ªf_hód
 *

789 
	$add_dñayed_ªf_hód
(
båfs_å™s_h™dÀ
 *
å™s
,

790 
båfs_dñayed_ªf_hód
 *
hód_ªf
,

791 
båfs_qgroup_exã¡_ªc‹d
 *
qªc‹d
,

792 
a˘i⁄
, 
boﬁ
 *
qªc‹d_ö£πed_ªt
)

794 
båfs_dñayed_ªf_hód
 *
exi°ög
;

795 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
;

796 
boﬁ
 
qªc‹d_ö£πed
 = 
Ál£
;

798 
dñayed_ªfs
 = &
å™s
->
å™ß˘i⁄
->delayed_refs;

801 i‡(
qªc‹d
) {

802 i‡(
	`båfs_qgroup_åa˚_exã¡_nﬁock
(
å™s
->
fs_öfo
,

803 
dñayed_ªfs
, 
qªc‹d
))

804 
	`k‰ì
(
qªc‹d
);

806 
qªc‹d_ö£πed
 = 
åue
;

809 
	`åa˚_add_dñayed_ªf_hód
(
å™s
->
fs_öfo
, 
hód_ªf
, 
a˘i⁄
);

811 
exi°ög
 = 
	`håì_ö£π
(&
dñayed_ªfs
->
hªf_roŸ
,

812 &
hód_ªf
->
hªf_node
);

813 i‡(
exi°ög
) {

814 
	`upd©e_exi°ög_hód_ªf
(
å™s
, 
exi°ög
, 
hód_ªf
);

819 
	`kmem_ˇche_‰ì
(
båfs_dñayed_ªf_hód_ˇchï
, 
hód_ªf
);

820 
hód_ªf
 = 
exi°ög
;

822 i‡(
hód_ªf
->
is_d©a
 && hód_ªf->
ªf_mod
 < 0) {

823 
dñayed_ªfs
->
≥ndög_csums
 +
hód_ªf
->
num_byãs
;

824 
å™s
->
dñayed_ªf_upd©es
 +=

825 
	`båfs_csum_byãs_to_Àaves
(
å™s
->
fs_öfo
,

826 
hód_ªf
->
num_byãs
);

828 
dñayed_ªfs
->
num_hóds
++;

829 
dñayed_ªfs
->
num_hóds_ªady
++;

830 
	`©omic_öc
(&
dñayed_ªfs
->
num_íåõs
);

831 
å™s
->
dñayed_ªf_upd©es
++;

833 i‡(
qªc‹d_ö£πed_ªt
)

834 *
qªc‹d_ö£πed_ªt
 = 
qªc‹d_ö£πed
;

836  
hód_ªf
;

837 
	}
}

864 
	$öô_dñayed_ªf_comm⁄
(
båfs_fs_öfo
 *
fs_öfo
,

865 
båfs_dñayed_ªf_node
 *
ªf
,

866 
u64
 
byãƒ
, u64 
num_byãs
, u64 
ªf_roŸ
,

867 
a˘i⁄
, 
u8
 
ªf_ty≥
)

869 
u64
 
£q
 = 0;

871 i‡(
a˘i⁄
 =
BTRFS_ADD_DELAYED_EXTENT
)

872 
a˘i⁄
 = 
BTRFS_ADD_DELAYED_REF
;

874 i‡(
	`is_f°ªe
(
ªf_roŸ
))

875 
£q
 = 
	`©omic64_ªad
(&
fs_öfo
->
åì_mod_£q
);

877 
	`ªfcou¡_£t
(&
ªf
->
ªfs
, 1);

878 
ªf
->
byãƒ
 = bytenr;

879 
ªf
->
num_byãs
 =Çum_bytes;

880 
ªf
->
ªf_mod
 = 1;

881 
ªf
->
a˘i⁄
 =áction;

882 
ªf
->
£q
 = seq;

883 
ªf
->
ty≥
 = 
ªf_ty≥
;

884 
	`RB_CLEAR_NODE
(&
ªf
->
ªf_node
);

885 
	`INIT_LIST_HEAD
(&
ªf
->
add_li°
);

886 
	}
}

893 
	$båfs_add_dñayed_åì_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

894 
båfs_ªf
 *
gíîic_ªf
,

895 
båfs_dñayed_exã¡_›
 *
exã¡_›
)

897 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

898 
båfs_dñayed_åì_ªf
 *
ªf
;

899 
båfs_dñayed_ªf_hód
 *
hód_ªf
;

900 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
;

901 
båfs_qgroup_exã¡_ªc‹d
 *
ªc‹d
 = 
NULL
;

902 
boﬁ
 
qªc‹d_ö£πed
;

903 
boﬁ
 
is_sy°em
;

904 
boﬁ
 
mîged
;

905 
a˘i⁄
 = 
gíîic_ªf
->action;

906 
Àvñ
 = 
gíîic_ªf
->
åì_ªf
.level;

907 
u64
 
byãƒ
 = 
gíîic_ªf
->bytenr;

908 
u64
 
num_byãs
 = 
gíîic_ªf
->
Àn
;

909 
u64
 
∑ª¡
 = 
gíîic_ªf
->parent;

910 
u8
 
ªf_ty≥
;

912 
is_sy°em
 = (
gíîic_ªf
->
åì_ªf
.
ownög_roŸ
 =
BTRFS_CHUNK_TREE_OBJECTID
);

914 
	`ASSERT
(
gíîic_ªf
->
ty≥
 =
BTRFS_REF_METADATA
 && gíîic_ªf->
a˘i⁄
);

915 
ªf
 = 
	`kmem_ˇche_Æloc
(
båfs_dñayed_åì_ªf_ˇchï
, 
GFP_NOFS
);

916 i‡(!
ªf
)

917  -
ENOMEM
;

919 
hód_ªf
 = 
	`kmem_ˇche_Æloc
(
båfs_dñayed_ªf_hód_ˇchï
, 
GFP_NOFS
);

920 i‡(!
hód_ªf
) {

921 
	`kmem_ˇche_‰ì
(
båfs_dñayed_åì_ªf_ˇchï
, 
ªf
);

922  -
ENOMEM
;

925 i‡(
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
) &&

926 !
gíîic_ªf
->
skù_qgroup
) {

927 
ªc‹d
 = 
	`kzÆloc
((*ªc‹d), 
GFP_NOFS
);

928 i‡(!
ªc‹d
) {

929 
	`kmem_ˇche_‰ì
(
båfs_dñayed_åì_ªf_ˇchï
, 
ªf
);

930 
	`kmem_ˇche_‰ì
(
båfs_dñayed_ªf_hód_ˇchï
, 
hód_ªf
);

931  -
ENOMEM
;

935 i‡(
∑ª¡
)

936 
ªf_ty≥
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

938 
ªf_ty≥
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

940 
	`öô_dñayed_ªf_comm⁄
(
fs_öfo
, &
ªf
->
node
, 
byãƒ
, 
num_byãs
,

941 
gíîic_ªf
->
åì_ªf
.
ownög_roŸ
, 
a˘i⁄
,

942 
ªf_ty≥
);

943 
ªf
->
roŸ
 = 
gíîic_ªf
->
åì_ªf
.
ownög_roŸ
;

944 
ªf
->
∑ª¡
 =Öarent;

945 
ªf
->
Àvñ
 =Üevel;

947 
	`öô_dñayed_ªf_hód
(
hód_ªf
, 
ªc‹d
, 
byãƒ
, 
num_byãs
,

948 
gíîic_ªf
->
åì_ªf
.
ownög_roŸ
, 0, 
a˘i⁄
,

949 
Ál£
, 
is_sy°em
);

950 
hód_ªf
->
exã¡_›
 =Éxtent_op;

952 
dñayed_ªfs
 = &
å™s
->
å™ß˘i⁄
->delayed_refs;

953 
	`•ö_lock
(&
dñayed_ªfs
->
lock
);

959 
hód_ªf
 = 
	`add_dñayed_ªf_hód
(
å™s
, hód_ªf, 
ªc‹d
,

960 
a˘i⁄
, &
qªc‹d_ö£πed
);

962 
mîged
 = 
	`ö£π_dñayed_ªf
(
dñayed_ªfs
, 
hód_ªf
, &
ªf
->
node
);

963 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

969 
	`båfs_upd©e_dñayed_ªfs_rsv
(
å™s
);

971 
	`åa˚_add_dñayed_åì_ªf
(
fs_öfo
, &
ªf
->
node
,Ñef,

972 
a˘i⁄
 =
BTRFS_ADD_DELAYED_EXTENT
 ?

973 
BTRFS_ADD_DELAYED_REF
 : 
a˘i⁄
);

974 i‡(
mîged
)

975 
	`kmem_ˇche_‰ì
(
båfs_dñayed_åì_ªf_ˇchï
, 
ªf
);

977 i‡(
qªc‹d_ö£πed
)

978 
	`båfs_qgroup_åa˚_exã¡_po°
(
å™s
, 
ªc‹d
);

981 
	}
}

986 
	$båfs_add_dñayed_d©a_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

987 
båfs_ªf
 *
gíîic_ªf
,

988 
u64
 
ª£rved
)

990 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

991 
båfs_dñayed_d©a_ªf
 *
ªf
;

992 
båfs_dñayed_ªf_hód
 *
hód_ªf
;

993 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
;

994 
båfs_qgroup_exã¡_ªc‹d
 *
ªc‹d
 = 
NULL
;

995 
boﬁ
 
qªc‹d_ö£πed
;

996 
a˘i⁄
 = 
gíîic_ªf
->action;

997 
boﬁ
 
mîged
;

998 
u64
 
byãƒ
 = 
gíîic_ªf
->bytenr;

999 
u64
 
num_byãs
 = 
gíîic_ªf
->
Àn
;

1000 
u64
 
∑ª¡
 = 
gíîic_ªf
->parent;

1001 
u64
 
ªf_roŸ
 = 
gíîic_ªf
->
d©a_ªf
.
ownög_roŸ
;

1002 
u64
 
ow√r
 = 
gíîic_ªf
->
d©a_ªf
.
öo
;

1003 
u64
 
off£t
 = 
gíîic_ªf
->
d©a_ªf
.offset;

1004 
u8
 
ªf_ty≥
;

1006 
	`ASSERT
(
gíîic_ªf
->
ty≥
 =
BTRFS_REF_DATA
 && 
a˘i⁄
);

1007 
ªf
 = 
	`kmem_ˇche_Æloc
(
båfs_dñayed_d©a_ªf_ˇchï
, 
GFP_NOFS
);

1008 i‡(!
ªf
)

1009  -
ENOMEM
;

1011 i‡(
∑ª¡
)

1012 
ªf_ty≥
 = 
BTRFS_SHARED_DATA_REF_KEY
;

1014 
ªf_ty≥
 = 
BTRFS_EXTENT_DATA_REF_KEY
;

1015 
	`öô_dñayed_ªf_comm⁄
(
fs_öfo
, &
ªf
->
node
, 
byãƒ
, 
num_byãs
,

1016 
ªf_roŸ
, 
a˘i⁄
, 
ªf_ty≥
);

1017 
ªf
->
roŸ
 = 
ªf_roŸ
;

1018 
ªf
->
∑ª¡
 =Öarent;

1019 
ªf
->
obje˘id
 = 
ow√r
;

1020 
ªf
->
off£t
 = offset;

1023 
hód_ªf
 = 
	`kmem_ˇche_Æloc
(
båfs_dñayed_ªf_hód_ˇchï
, 
GFP_NOFS
);

1024 i‡(!
hód_ªf
) {

1025 
	`kmem_ˇche_‰ì
(
båfs_dñayed_d©a_ªf_ˇchï
, 
ªf
);

1026  -
ENOMEM
;

1029 i‡(
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
) &&

1030 !
gíîic_ªf
->
skù_qgroup
) {

1031 
ªc‹d
 = 
	`kzÆloc
((*ªc‹d), 
GFP_NOFS
);

1032 i‡(!
ªc‹d
) {

1033 
	`kmem_ˇche_‰ì
(
båfs_dñayed_d©a_ªf_ˇchï
, 
ªf
);

1034 
	`kmem_ˇche_‰ì
(
båfs_dñayed_ªf_hód_ˇchï
,

1035 
hód_ªf
);

1036  -
ENOMEM
;

1040 
	`öô_dñayed_ªf_hód
(
hód_ªf
, 
ªc‹d
, 
byãƒ
, 
num_byãs
, 
ªf_roŸ
,

1041 
ª£rved
, 
a˘i⁄
, 
åue
, 
Ál£
);

1042 
hód_ªf
->
exã¡_›
 = 
NULL
;

1044 
dñayed_ªfs
 = &
å™s
->
å™ß˘i⁄
->delayed_refs;

1045 
	`•ö_lock
(&
dñayed_ªfs
->
lock
);

1051 
hód_ªf
 = 
	`add_dñayed_ªf_hód
(
å™s
, hód_ªf, 
ªc‹d
,

1052 
a˘i⁄
, &
qªc‹d_ö£πed
);

1054 
mîged
 = 
	`ö£π_dñayed_ªf
(
dñayed_ªfs
, 
hód_ªf
, &
ªf
->
node
);

1055 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

1061 
	`båfs_upd©e_dñayed_ªfs_rsv
(
å™s
);

1063 
	`åa˚_add_dñayed_d©a_ªf
(
å™s
->
fs_öfo
, &
ªf
->
node
,Ñef,

1064 
a˘i⁄
 =
BTRFS_ADD_DELAYED_EXTENT
 ?

1065 
BTRFS_ADD_DELAYED_REF
 : 
a˘i⁄
);

1066 i‡(
mîged
)

1067 
	`kmem_ˇche_‰ì
(
båfs_dñayed_d©a_ªf_ˇchï
, 
ªf
);

1070 i‡(
qªc‹d_ö£πed
)

1071  
	`båfs_qgroup_åa˚_exã¡_po°
(
å™s
, 
ªc‹d
);

1073 
	}
}

1075 
	$båfs_add_dñayed_exã¡_›
(
båfs_å™s_h™dÀ
 *
å™s
,

1076 
u64
 
byãƒ
, u64 
num_byãs
,

1077 
båfs_dñayed_exã¡_›
 *
exã¡_›
)

1079 
båfs_dñayed_ªf_hód
 *
hód_ªf
;

1080 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
;

1082 
hód_ªf
 = 
	`kmem_ˇche_Æloc
(
båfs_dñayed_ªf_hód_ˇchï
, 
GFP_NOFS
);

1083 i‡(!
hód_ªf
)

1084  -
ENOMEM
;

1086 
	`öô_dñayed_ªf_hód
(
hód_ªf
, 
NULL
, 
byãƒ
, 
num_byãs
, 0, 0,

1087 
BTRFS_UPDATE_DELAYED_HEAD
, 
Ál£
, false);

1088 
hód_ªf
->
exã¡_›
 =Éxtent_op;

1090 
dñayed_ªfs
 = &
å™s
->
å™ß˘i⁄
->delayed_refs;

1091 
	`•ö_lock
(&
dñayed_ªfs
->
lock
);

1093 
	`add_dñayed_ªf_hód
(
å™s
, 
hód_ªf
, 
NULL
, 
BTRFS_UPDATE_DELAYED_HEAD
,

1094 
NULL
);

1096 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

1102 
	`båfs_upd©e_dñayed_ªfs_rsv
(
å™s
);

1104 
	}
}

1110 
båfs_dñayed_ªf_hód
 *

1111 
	$båfs_föd_dñayed_ªf_hód
(
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
, 
u64
 
byãƒ
)

1113 
	`lockdï_as£π_hñd
(&
dñayed_ªfs
->
lock
);

1115  
	`föd_ªf_hód
(
dñayed_ªfs
, 
byãƒ
, 
Ál£
);

1116 
	}
}

1118 
__cﬁd
 
	$båfs_dñayed_ªf_exô
()

1120 
	`kmem_ˇche_de°roy
(
båfs_dñayed_ªf_hód_ˇchï
);

1121 
	`kmem_ˇche_de°roy
(
båfs_dñayed_åì_ªf_ˇchï
);

1122 
	`kmem_ˇche_de°roy
(
båfs_dñayed_d©a_ªf_ˇchï
);

1123 
	`kmem_ˇche_de°roy
(
båfs_dñayed_exã¡_›_ˇchï
);

1124 
	}
}

1126 
__öô
 
	$båfs_dñayed_ªf_öô
()

1128 
båfs_dñayed_ªf_hód_ˇchï
 = 
	`kmem_ˇche_¸óã
(

1130 (
båfs_dñayed_ªf_hód
), 0,

1131 
SLAB_MEM_SPREAD
, 
NULL
);

1132 i‡(!
båfs_dñayed_ªf_hód_ˇchï
)

1133 
Áû
;

1135 
båfs_dñayed_åì_ªf_ˇchï
 = 
	`kmem_ˇche_¸óã
(

1137 (
båfs_dñayed_åì_ªf
), 0,

1138 
SLAB_MEM_SPREAD
, 
NULL
);

1139 i‡(!
båfs_dñayed_åì_ªf_ˇchï
)

1140 
Áû
;

1142 
båfs_dñayed_d©a_ªf_ˇchï
 = 
	`kmem_ˇche_¸óã
(

1144 (
båfs_dñayed_d©a_ªf
), 0,

1145 
SLAB_MEM_SPREAD
, 
NULL
);

1146 i‡(!
båfs_dñayed_d©a_ªf_ˇchï
)

1147 
Áû
;

1149 
båfs_dñayed_exã¡_›_ˇchï
 = 
	`kmem_ˇche_¸óã
(

1151 (
båfs_dñayed_exã¡_›
), 0,

1152 
SLAB_MEM_SPREAD
, 
NULL
);

1153 i‡(!
båfs_dñayed_exã¡_›_ˇchï
)

1154 
Áû
;

1157 
Áû
:

1158 
	`båfs_dñayed_ªf_exô
();

1159  -
ENOMEM
;

1160 
	}
}

	@delayed-ref.h

6 #i‚de‡
BTRFS_DELAYED_REF_H


7 
	#BTRFS_DELAYED_REF_H


	)

9 
	~<löux/ªfcou¡.h
>

12 
	#BTRFS_ADD_DELAYED_REF
 1

	)

13 
	#BTRFS_DROP_DELAYED_REF
 2

	)

14 
	#BTRFS_ADD_DELAYED_EXTENT
 3

	)

15 
	#BTRFS_UPDATE_DELAYED_HEAD
 4

	)

17 
	sbåfs_dñayed_ªf_node
 {

18 
rb_node
 
	mªf_node
;

24 
li°_hód
 
	madd_li°
;

27 
u64
 
	mbyãƒ
;

30 
u64
 
	mnum_byãs
;

33 
u64
 
	m£q
;

36 
ªfcou¡_t
 
	mªfs
;

47 
	mªf_mod
;

49 
	ma˘i⁄
:8;

50 
	mty≥
:8;

53 
	sbåfs_dñayed_exã¡_›
 {

54 
båfs_disk_key
 
	mkey
;

55 
u8
 
	mÀvñ
;

56 
boﬁ
 
	mupd©e_key
;

57 
boﬁ
 
	mupd©e_Êags
;

58 
u64
 
	mÊags_to_£t
;

67 
	sbåfs_dñayed_ªf_hód
 {

68 
u64
 
	mbyãƒ
;

69 
u64
 
	mnum_byãs
;

75 
rb_node
 
	mhªf_node
;

80 
muãx
 
	mmuãx
;

82 
ªfcou¡_t
 
	mªfs
;

85 
•ölock_t
 
	mlock
;

86 
rb_roŸ_ˇched
 
	mªf_åì
;

88 
li°_hód
 
	mªf_add_li°
;

90 
båfs_dñayed_exã¡_›
 *
	mexã¡_›
;

97 
	mtŸÆ_ªf_mod
;

105 
	mªf_mod
;

119 
boﬁ
 
	mmu°_ö£π_ª£rved
;

120 
boﬁ
 
	mis_d©a
;

121 
boﬁ
 
	mis_sy°em
;

122 
boﬁ
 
	m¥o˚ssög
;

125 
	sbåfs_dñayed_åì_ªf
 {

126 
båfs_dñayed_ªf_node
 
	mnode
;

127 
u64
 
	mroŸ
;

128 
u64
 
	m∑ª¡
;

129 
	mÀvñ
;

132 
	sbåfs_dñayed_d©a_ªf
 {

133 
båfs_dñayed_ªf_node
 
	mnode
;

134 
u64
 
	mroŸ
;

135 
u64
 
	m∑ª¡
;

136 
u64
 
	mobje˘id
;

137 
u64
 
	moff£t
;

140 
	ebåfs_dñayed_ªf_Êags
 {

142 
	mBTRFS_DELAYED_REFS_FLUSHING
,

145 
	sbåfs_dñayed_ªf_roŸ
 {

147 
rb_roŸ_ˇched
 
	mhªf_roŸ
;

150 
rb_roŸ
 
	mdúty_exã¡_roŸ
;

153 
•ölock_t
 
	mlock
;

158 
©omic_t
 
	mnum_íåõs
;

161 
	mnum_hóds
;

164 
	mnum_hóds_ªady
;

166 
u64
 
	m≥ndög_csums
;

168 
	mÊags
;

170 
u64
 
	mrun_dñayed_°¨t
;

178 
u64
 
	mqgroup_to_skù
;

181 
	ebåfs_ªf_ty≥
 {

182 
	mBTRFS_REF_NOT_SET
,

183 
	mBTRFS_REF_DATA
,

184 
	mBTRFS_REF_METADATA
,

185 
	mBTRFS_REF_LAST
,

188 
	sbåfs_d©a_ªf
 {

192 
u64
 
	mownög_roŸ
;

195 
u64
 
	möo
;

203 
u64
 
	moff£t
;

206 
	sbåfs_åì_ªf
 {

212 
	mÀvñ
;

219 
u64
 
	mownög_roŸ
;

224 
	sbåfs_ªf
 {

225 
båfs_ªf_ty≥
 
	mty≥
;

226 
	ma˘i⁄
;

234 
boﬁ
 
	mskù_qgroup
;

236 #ifde‡
CONFIG_BTRFS_FS_REF_VERIFY


238 
u64
 
	mªÆ_roŸ
;

240 
u64
 
	mbyãƒ
;

241 
u64
 
	mÀn
;

244 
u64
 
	m∑ª¡
;

246 
båfs_d©a_ªf
 
	md©a_ªf
;

247 
båfs_åì_ªf
 
	måì_ªf
;

251 
kmem_ˇche
 *
båfs_dñayed_ªf_hód_ˇchï
;

252 
kmem_ˇche
 *
båfs_dñayed_åì_ªf_ˇchï
;

253 
kmem_ˇche
 *
båfs_dñayed_d©a_ªf_ˇchï
;

254 
kmem_ˇche
 *
båfs_dñayed_exã¡_›_ˇchï
;

256 
__öô
 
båfs_dñayed_ªf_öô
();

257 
__cﬁd
 
båfs_dñayed_ªf_exô
();

259 
ölöe
 
u64
 
	$båfs_ˇlc_dñayed_ªf_byãs
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

260 
num_dñayed_ªfs
)

262 
u64
 
num_byãs
;

264 
num_byãs
 = 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
, 
num_dñayed_ªfs
);

274 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
FREE_SPACE_TREE
))

275 
num_byãs
 *= 2;

277  
num_byãs
;

278 
	}
}

280 
ölöe
 
	$båfs_öô_gíîic_ªf
(
båfs_ªf
 *
gíîic_ªf
,

281 
a˘i⁄
, 
u64
 
byãƒ
, u64 
Àn
, u64 
∑ª¡
)

283 
gíîic_ªf
->
a˘i⁄
 =áction;

284 
gíîic_ªf
->
byãƒ
 = bytenr;

285 
gíîic_ªf
->
Àn
 =Üen;

286 
gíîic_ªf
->
∑ª¡
 =Öarent;

287 
	}
}

289 
ölöe
 
	$båfs_öô_åì_ªf
(
båfs_ªf
 *
gíîic_ªf
,

290 
Àvñ
, 
u64
 
roŸ
, u64 
mod_roŸ
, 
boﬁ
 
skù_qgroup
)

292 #ifde‡
CONFIG_BTRFS_FS_REF_VERIFY


294 
gíîic_ªf
->
ªÆ_roŸ
 = 
mod_roŸ
 ?: 
roŸ
;

296 
gíîic_ªf
->
åì_ªf
.
Àvñ
 =Üevel;

297 
gíîic_ªf
->
åì_ªf
.
ownög_roŸ
 = 
roŸ
;

298 
gíîic_ªf
->
ty≥
 = 
BTRFS_REF_METADATA
;

299 i‡(
skù_qgroup
 || !(
	`is_f°ªe
(
roŸ
) &&

300 (!
mod_roŸ
 || 
	`is_f°ªe
(mod_root))))

301 
gíîic_ªf
->
skù_qgroup
 = 
åue
;

303 
gíîic_ªf
->
skù_qgroup
 = 
Ál£
;

305 
	}
}

307 
ölöe
 
	$båfs_öô_d©a_ªf
(
båfs_ªf
 *
gíîic_ªf
,

308 
u64
 
ªf_roŸ
, u64 
öo
, u64 
off£t
, u64 
mod_roŸ
,

309 
boﬁ
 
skù_qgroup
)

311 #ifde‡
CONFIG_BTRFS_FS_REF_VERIFY


313 
gíîic_ªf
->
ªÆ_roŸ
 = 
mod_roŸ
 ?: 
ªf_roŸ
;

315 
gíîic_ªf
->
d©a_ªf
.
ownög_roŸ
 = 
ªf_roŸ
;

316 
gíîic_ªf
->
d©a_ªf
.
öo
 = ino;

317 
gíîic_ªf
->
d©a_ªf
.
off£t
 = offset;

318 
gíîic_ªf
->
ty≥
 = 
BTRFS_REF_DATA
;

319 i‡(
skù_qgroup
 || !(
	`is_f°ªe
(
ªf_roŸ
) &&

320 (!
mod_roŸ
 || 
	`is_f°ªe
(mod_root))))

321 
gíîic_ªf
->
skù_qgroup
 = 
åue
;

323 
gíîic_ªf
->
skù_qgroup
 = 
Ál£
;

324 
	}
}

326 
ölöe
 
båfs_dñayed_exã¡_›
 *

327 
	$båfs_Æloc_dñayed_exã¡_›
()

329  
	`kmem_ˇche_Æloc
(
båfs_dñayed_exã¡_›_ˇchï
, 
GFP_NOFS
);

330 
	}
}

332 
ölöe
 

333 
	$båfs_‰ì_dñayed_exã¡_›
(
båfs_dñayed_exã¡_›
 *
›
)

335 i‡(
›
)

336 
	`kmem_ˇche_‰ì
(
båfs_dñayed_exã¡_›_ˇchï
, 
›
);

337 
	}
}

339 
ölöe
 
	$båfs_put_dñayed_ªf
(
båfs_dñayed_ªf_node
 *
ªf
)

341 
	`WARN_ON
(
	`ªfcou¡_ªad
(&
ªf
->
ªfs
) == 0);

342 i‡(
	`ªfcou¡_dec_™d_ã°
(&
ªf
->
ªfs
)) {

343 
	`WARN_ON
(!
	`RB_EMPTY_NODE
(&
ªf
->
ªf_node
));

344 
ªf
->
ty≥
) {

345 
BTRFS_TREE_BLOCK_REF_KEY
:

346 
BTRFS_SHARED_BLOCK_REF_KEY
:

347 
	`kmem_ˇche_‰ì
(
båfs_dñayed_åì_ªf_ˇchï
, 
ªf
);

349 
BTRFS_EXTENT_DATA_REF_KEY
:

350 
BTRFS_SHARED_DATA_REF_KEY
:

351 
	`kmem_ˇche_‰ì
(
båfs_dñayed_d©a_ªf_ˇchï
, 
ªf
);

354 
	`BUG
();

357 
	}
}

359 
ölöe
 
u64
 
	$båfs_ªf_hód_to_•a˚_Êags
(

360 
båfs_dñayed_ªf_hód
 *
hód_ªf
)

362 i‡(
hód_ªf
->
is_d©a
)

363  
BTRFS_BLOCK_GROUP_DATA
;

364 i‡(
hód_ªf
->
is_sy°em
)

365  
BTRFS_BLOCK_GROUP_SYSTEM
;

366  
BTRFS_BLOCK_GROUP_METADATA
;

367 
	}
}

369 
ölöe
 
	$båfs_put_dñayed_ªf_hód
(
båfs_dñayed_ªf_hód
 *
hód
)

371 i‡(
	`ªfcou¡_dec_™d_ã°
(&
hód
->
ªfs
))

372 
	`kmem_ˇche_‰ì
(
båfs_dñayed_ªf_hód_ˇchï
, 
hód
);

373 
	}
}

375 
båfs_add_dñayed_åì_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

376 
båfs_ªf
 *
gíîic_ªf
,

377 
båfs_dñayed_exã¡_›
 *
exã¡_›
);

378 
båfs_add_dñayed_d©a_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

379 
båfs_ªf
 *
gíîic_ªf
,

380 
u64
 
ª£rved
);

381 
båfs_add_dñayed_exã¡_›
(
båfs_å™s_h™dÀ
 *
å™s
,

382 
u64
 
byãƒ
, u64 
num_byãs
,

383 
båfs_dñayed_exã¡_›
 *
exã¡_›
);

384 
båfs_mîge_dñayed_ªfs
(
båfs_fs_öfo
 *
fs_öfo
,

385 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
,

386 
båfs_dñayed_ªf_hód
 *
hód
);

388 
båfs_dñayed_ªf_hód
 *

389 
båfs_föd_dñayed_ªf_hód
(
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
,

390 
u64
 
byãƒ
);

391 
båfs_dñayed_ªf_lock
(
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
,

392 
båfs_dñayed_ªf_hód
 *
hód
);

393 
ölöe
 
	$båfs_dñayed_ªf_u∆ock
(
båfs_dñayed_ªf_hód
 *
hód
)

395 
	`muãx_u∆ock
(&
hód
->
muãx
);

396 
	}
}

397 
båfs_dñëe_ªf_hód
(
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
,

398 
båfs_dñayed_ªf_hód
 *
hód
);

400 
båfs_dñayed_ªf_hód
 *
båfs_£À˘_ªf_hód
(

401 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
);

403 
båfs_check_dñayed_£q
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
£q
);

405 
båfs_dñayed_ªfs_rsv_ªÀa£
(
båfs_fs_öfo
 *
fs_öfo
, 
ƒ
);

406 
båfs_upd©e_dñayed_ªfs_rsv
(
båfs_å™s_h™dÀ
 *
å™s
);

407 
båfs_dñayed_ªfs_rsv_ªfûl
(
båfs_fs_öfo
 *
fs_öfo
,

408 
båfs_ª£rve_Êush_íum
 
Êush
);

409 
båfs_migøã_to_dñayed_ªfs_rsv
(
båfs_fs_öfo
 *
fs_öfo
,

410 
u64
 
num_byãs
);

411 
boﬁ
 
båfs_check_•a˚_f‹_dñayed_ªfs
(
båfs_fs_öfo
 *
fs_öfo
);

416 
ölöe
 
båfs_dñayed_åì_ªf
 *

417 
	$båfs_dñayed_node_to_åì_ªf
(
båfs_dñayed_ªf_node
 *
node
)

419  
	`c⁄èöî_of
(
node
, 
båfs_dñayed_åì_ªf
,Çode);

420 
	}
}

422 
ölöe
 
båfs_dñayed_d©a_ªf
 *

423 
	$båfs_dñayed_node_to_d©a_ªf
(
båfs_dñayed_ªf_node
 *
node
)

425  
	`c⁄èöî_of
(
node
, 
båfs_dñayed_d©a_ªf
,Çode);

426 
	}
}

	@dev-replace.c

6 
	~<löux/sched.h
>

7 
	~<löux/bio.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/blkdev.h
>

10 
	~<löux/kthªad.h
>

11 
	~<löux/m©h64.h
>

12 
	~"misc.h
"

13 
	~"˘ªe.h
"

14 
	~"exã¡_m≠.h
"

15 
	~"disk-io.h
"

16 
	~"å™ß˘i⁄.h
"

17 
	~"¥öt-åì.h
"

18 
	~"vﬁumes.h
"

19 
	~"async-thªad.h
"

20 
	~"check-öãgrôy.h
"

21 
	~"dev-ª∂a˚.h
"

22 
	~"sysfs.h
"

23 
	~"z⁄ed.h
"

24 
	~"block-group.h
"

25 
	~"fs.h
"

26 
	~"ac˚ss‹s.h
"

27 
	~"s¸ub.h
"

69 
båfs_dev_ª∂a˚_föishög
(
båfs_fs_öfo
 *
fs_öfo
,

70 
s¸ub_ªt
);

71 
båfs_dev_ª∂a˚_kthªad
(*
d©a
);

73 
	$båfs_öô_dev_ª∂a˚
(
båfs_fs_öfo
 *
fs_öfo
)

75 
båfs_dev_lookup_¨gs
 
¨gs
 = { .
devid
 = 
BTRFS_DEV_REPLACE_DEVID
 };

76 
båfs_key
 
key
;

77 
båfs_roŸ
 *
dev_roŸ
 = 
fs_öfo
->dev_root;

78 
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
 = &
fs_öfo
->dev_replace;

79 
exã¡_buf„r
 *
eb
;

80 
¶Ÿ
;

81 
ªt
 = 0;

82 
båfs_∑th
 *
∑th
 = 
NULL
;

83 
ôem_size
;

84 
båfs_dev_ª∂a˚_ôem
 *
±r
;

85 
u64
 
§c_devid
;

87 i‡(!
dev_roŸ
)

90 
∑th
 = 
	`båfs_Æloc_∑th
();

91 i‡(!
∑th
) {

92 
ªt
 = -
ENOMEM
;

93 
out
;

96 
key
.
obje˘id
 = 0;

97 
key
.
ty≥
 = 
BTRFS_DEV_REPLACE_KEY
;

98 
key
.
off£t
 = 0;

99 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
dev_roŸ
, &
key
, 
∑th
, 0, 0);

100 i‡(
ªt
) {

101 
no_vÆid_dev_ª∂a˚_íåy_found
:

106 i‡(
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, &
¨gs
)) {

107 
	`båfs_îr
(
fs_öfo
,

109 
ªt
 = -
EUCLEAN
;

110 
out
;

112 
ªt
 = 0;

113 
dev_ª∂a˚
->
ª∂a˚_°©e
 =

114 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
;

115 
dev_ª∂a˚
->
c⁄t_ªadög_‰om_§cdev_mode
 =

116 
BTRFS_DEV_REPLACE_ITEM_CONT_READING_FROM_SRCDEV_MODE_ALWAYS
;

117 
dev_ª∂a˚
->
time_°¨ãd
 = 0;

118 
dev_ª∂a˚
->
time_°›≥d
 = 0;

119 
	`©omic64_£t
(&
dev_ª∂a˚
->
num_wrôe_îr‹s
, 0);

120 
	`©omic64_£t
(&
dev_ª∂a˚
->
num_unc‹ª˘abÀ_ªad_îr‹s
, 0);

121 
dev_ª∂a˚
->
curs‹_À·
 = 0;

122 
dev_ª∂a˚
->
commôãd_curs‹_À·
 = 0;

123 
dev_ª∂a˚
->
curs‹_À·_œ°_wrôe_of_ôem
 = 0;

124 
dev_ª∂a˚
->
curs‹_right
 = 0;

125 
dev_ª∂a˚
->
§cdev
 = 
NULL
;

126 
dev_ª∂a˚
->
tgtdev
 = 
NULL
;

127 
dev_ª∂a˚
->
is_vÆid
 = 0;

128 
dev_ª∂a˚
->
ôem_√eds_wrôeback
 = 0;

129 
out
;

131 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

132 
eb
 = 
∑th
->
nodes
[0];

133 
ôem_size
 = 
	`båfs_ôem_size
(
eb
, 
¶Ÿ
);

134 
±r
 = 
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
, 
båfs_dev_ª∂a˚_ôem
);

136 i‡(
ôem_size
 !(
båfs_dev_ª∂a˚_ôem
)) {

137 
	`båfs_w¨n
(
fs_öfo
,

139 
no_vÆid_dev_ª∂a˚_íåy_found
;

142 
§c_devid
 = 
	`båfs_dev_ª∂a˚_§c_devid
(
eb
, 
±r
);

143 
dev_ª∂a˚
->
c⁄t_ªadög_‰om_§cdev_mode
 =

144 
	`båfs_dev_ª∂a˚_c⁄t_ªadög_‰om_§cdev_mode
(
eb
, 
±r
);

145 
dev_ª∂a˚
->
ª∂a˚_°©e
 = 
	`båfs_dev_ª∂a˚_ª∂a˚_°©e
(
eb
, 
±r
);

146 
dev_ª∂a˚
->
time_°¨ãd
 = 
	`båfs_dev_ª∂a˚_time_°¨ãd
(
eb
, 
±r
);

147 
dev_ª∂a˚
->
time_°›≥d
 =

148 
	`båfs_dev_ª∂a˚_time_°›≥d
(
eb
, 
±r
);

149 
	`©omic64_£t
(&
dev_ª∂a˚
->
num_wrôe_îr‹s
,

150 
	`båfs_dev_ª∂a˚_num_wrôe_îr‹s
(
eb
, 
±r
));

151 
	`©omic64_£t
(&
dev_ª∂a˚
->
num_unc‹ª˘abÀ_ªad_îr‹s
,

152 
	`båfs_dev_ª∂a˚_num_unc‹ª˘abÀ_ªad_îr‹s
(
eb
, 
±r
));

153 
dev_ª∂a˚
->
curs‹_À·
 = 
	`båfs_dev_ª∂a˚_curs‹_À·
(
eb
, 
±r
);

154 
dev_ª∂a˚
->
commôãd_curs‹_À·
 = dev_ª∂a˚->
curs‹_À·
;

155 
dev_ª∂a˚
->
curs‹_À·_œ°_wrôe_of_ôem
 = dev_ª∂a˚->
curs‹_À·
;

156 
dev_ª∂a˚
->
curs‹_right
 = 
	`båfs_dev_ª∂a˚_curs‹_right
(
eb
, 
±r
);

157 
dev_ª∂a˚
->
is_vÆid
 = 1;

159 
dev_ª∂a˚
->
ôem_√eds_wrôeback
 = 0;

160 
dev_ª∂a˚
->
ª∂a˚_°©e
) {

161 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

162 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

163 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

168 i‡(
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, &
¨gs
)) {

169 
	`båfs_îr
(
fs_öfo
,

171 
ªt
 = -
EUCLEAN
;

173 
dev_ª∂a˚
->
§cdev
 = 
NULL
;

174 
dev_ª∂a˚
->
tgtdev
 = 
NULL
;

177 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

178 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

179 
dev_ª∂a˚
->
tgtdev
 = 
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, &
¨gs
);

180 
¨gs
.
devid
 = 
§c_devid
;

181 
dev_ª∂a˚
->
§cdev
 = 
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, &
¨gs
);

187 i‡(!
dev_ª∂a˚
->
§cdev
 &&

188 !
	`båfs_ã°_›t
(
fs_öfo
, 
DEGRADED
)) {

189 
ªt
 = -
EIO
;

190 
	`båfs_w¨n
(
fs_öfo
,

192 
	`båfs_w¨n
(
fs_öfo
,

194 
§c_devid
);

196 i‡(!
dev_ª∂a˚
->
tgtdev
 &&

197 !
	`båfs_ã°_›t
(
fs_öfo
, 
DEGRADED
)) {

198 
ªt
 = -
EIO
;

199 
	`båfs_w¨n
(
fs_öfo
,

201 
	`båfs_w¨n
(
fs_öfo
,

203 
BTRFS_DEV_REPLACE_DEVID
);

205 i‡(
dev_ª∂a˚
->
tgtdev
) {

206 i‡(
dev_ª∂a˚
->
§cdev
) {

207 
dev_ª∂a˚
->
tgtdev
->
tŸÆ_byãs
 =

208 
dev_ª∂a˚
->
§cdev
->
tŸÆ_byãs
;

209 
dev_ª∂a˚
->
tgtdev
->
disk_tŸÆ_byãs
 =

210 
dev_ª∂a˚
->
§cdev
->
disk_tŸÆ_byãs
;

211 
dev_ª∂a˚
->
tgtdev
->
commô_tŸÆ_byãs
 =

212 
dev_ª∂a˚
->
§cdev
->
commô_tŸÆ_byãs
;

213 
dev_ª∂a˚
->
tgtdev
->
byãs_u£d
 =

214 
dev_ª∂a˚
->
§cdev
->
byãs_u£d
;

215 
dev_ª∂a˚
->
tgtdev
->
commô_byãs_u£d
 =

216 
dev_ª∂a˚
->
§cdev
->
commô_byãs_u£d
;

218 
	`£t_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
,

219 &
dev_ª∂a˚
->
tgtdev
->
dev_°©e
);

221 
	`WARN_ON
(
fs_öfo
->
fs_devi˚s
->
rw_devi˚s
 == 0);

222 
dev_ª∂a˚
->
tgtdev
->
io_width
 = 
fs_öfo
->
£˘‹size
;

223 
dev_ª∂a˚
->
tgtdev
->
io_Æign
 = 
fs_öfo
->
£˘‹size
;

224 
dev_ª∂a˚
->
tgtdev
->
£˘‹_size
 = 
fs_öfo
->
£˘‹size
;

225 
dev_ª∂a˚
->
tgtdev
->
fs_öfo
 = fs_info;

226 
	`£t_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
,

227 &
dev_ª∂a˚
->
tgtdev
->
dev_°©e
);

232 
out
:

233 
	`båfs_‰ì_∑th
(
∑th
);

234  
ªt
;

235 
	}
}

243 
	$båfs_öô_dev_ª∂a˚_tgtdev
(
båfs_fs_öfo
 *
fs_öfo
,

244 c⁄° *
devi˚_∑th
,

245 
båfs_devi˚
 *
§cdev
,

246 
båfs_devi˚
 **
devi˚_out
)

248 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

249 
båfs_devi˚
 *
devi˚
;

250 
block_devi˚
 *
bdev
;

251 
u64
 
devid
 = 
BTRFS_DEV_REPLACE_DEVID
;

252 
ªt
 = 0;

254 *
devi˚_out
 = 
NULL
;

255 i‡(
§cdev
->
fs_devi˚s
->
£edög
) {

256 
	`båfs_îr
(
fs_öfo
, "the filesystem isá seed filesystem!");

257  -
EINVAL
;

260 
bdev
 = 
	`blkdev_gë_by_∑th
(
devi˚_∑th
, 
BLK_OPEN_WRITE
,

261 
fs_öfo
->
bdev_hﬁdî
, 
NULL
);

262 i‡(
	`IS_ERR
(
bdev
)) {

263 
	`båfs_îr
(
fs_öfo
, "èrgë devi˚ %†i†övÆid!", 
devi˚_∑th
);

264  
	`PTR_ERR
(
bdev
);

267 i‡(!
	`båfs_check_devi˚_z⁄e_ty≥
(
fs_öfo
, 
bdev
)) {

268 
	`båfs_îr
(
fs_öfo
,

270 
ªt
 = -
EINVAL
;

271 
îr‹
;

274 
	`sync_blockdev
(
bdev
);

276 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

277 i‡(
devi˚
->
bdev
 == bdev) {

278 
	`båfs_îr
(
fs_öfo
,

280 
ªt
 = -
EEXIST
;

281 
îr‹
;

286 i‡(
	`bdev_ƒ_byãs
(
bdev
Ë< 
	`båfs_devi˚_gë_tŸÆ_byãs
(
§cdev
)) {

287 
	`båfs_îr
(
fs_öfo
,

289 
ªt
 = -
EINVAL
;

290 
îr‹
;

294 
devi˚
 = 
	`båfs_Æloc_devi˚
(
NULL
, &
devid
, NULL, 
devi˚_∑th
);

295 i‡(
	`IS_ERR
(
devi˚
)) {

296 
ªt
 = 
	`PTR_ERR
(
devi˚
);

297 
îr‹
;

300 
ªt
 = 
	`lookup_bdev
(
devi˚_∑th
, &
devi˚
->
devt
);

301 i‡(
ªt
)

302 
îr‹
;

304 
	`£t_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
);

305 
devi˚
->
gíî©i⁄
 = 0;

306 
devi˚
->
io_width
 = 
fs_öfo
->
£˘‹size
;

307 
devi˚
->
io_Æign
 = 
fs_öfo
->
£˘‹size
;

308 
devi˚
->
£˘‹_size
 = 
fs_öfo
->
£˘‹size
;

309 
devi˚
->
tŸÆ_byãs
 = 
	`båfs_devi˚_gë_tŸÆ_byãs
(
§cdev
);

310 
devi˚
->
disk_tŸÆ_byãs
 = 
	`båfs_devi˚_gë_disk_tŸÆ_byãs
(
§cdev
);

311 
devi˚
->
byãs_u£d
 = 
	`båfs_devi˚_gë_byãs_u£d
(
§cdev
);

312 
devi˚
->
commô_tŸÆ_byãs
 = 
§cdev
->commit_total_bytes;

313 
devi˚
->
commô_byãs_u£d
 = devi˚->
byãs_u£d
;

314 
devi˚
->
fs_öfo
 = fs_info;

315 
devi˚
->
bdev
 = bdev;

316 
	`£t_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
devi˚
->
dev_°©e
);

317 
	`£t_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
);

318 
devi˚
->
hﬁdî
 = 
fs_öfo
->
bdev_hﬁdî
;

319 
devi˚
->
dev_°©s_vÆid
 = 1;

320 
	`£t_blocksize
(
devi˚
->
bdev
, 
BTRFS_BDEV_BLOCKSIZE
);

321 
devi˚
->
fs_devi˚s
 = fs_devices;

323 
ªt
 = 
	`båfs_gë_dev_z⁄e_öfo
(
devi˚
, 
Ál£
);

324 i‡(
ªt
)

325 
îr‹
;

327 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

328 
	`li°_add
(&
devi˚
->
dev_li°
, &
fs_devi˚s
->
devi˚s
);

329 
fs_devi˚s
->
num_devi˚s
++;

330 
fs_devi˚s
->
›í_devi˚s
++;

331 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

333 *
devi˚_out
 = 
devi˚
;

336 
îr‹
:

337 
	`blkdev_put
(
bdev
, 
fs_öfo
->
bdev_hﬁdî
);

338  
ªt
;

339 
	}
}

345 
	$båfs_run_dev_ª∂a˚
(
båfs_å™s_h™dÀ
 *
å™s
)

347 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

348 
ªt
;

349 
båfs_roŸ
 *
dev_roŸ
 = 
fs_öfo
->dev_root;

350 
båfs_∑th
 *
∑th
;

351 
båfs_key
 
key
;

352 
exã¡_buf„r
 *
eb
;

353 
båfs_dev_ª∂a˚_ôem
 *
±r
;

354 
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
 = &
fs_öfo
->dev_replace;

356 
	`down_ªad
(&
dev_ª∂a˚
->
rw£m
);

357 i‡(!
dev_ª∂a˚
->
is_vÆid
 ||

358 !
dev_ª∂a˚
->
ôem_√eds_wrôeback
) {

359 
	`up_ªad
(&
dev_ª∂a˚
->
rw£m
);

362 
	`up_ªad
(&
dev_ª∂a˚
->
rw£m
);

364 
key
.
obje˘id
 = 0;

365 
key
.
ty≥
 = 
BTRFS_DEV_REPLACE_KEY
;

366 
key
.
off£t
 = 0;

368 
∑th
 = 
	`båfs_Æloc_∑th
();

369 i‡(!
∑th
) {

370 
ªt
 = -
ENOMEM
;

371 
out
;

373 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
dev_roŸ
, &
key
, 
∑th
, -1, 1);

374 i‡(
ªt
 < 0) {

375 
	`båfs_w¨n
(
fs_öfo
,

377 
ªt
);

378 
out
;

381 i‡(
ªt
 == 0 &&

382 
	`båfs_ôem_size
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0]Ë< (*
±r
)) {

394 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
dev_roŸ
, 
∑th
);

395 i‡(
ªt
 != 0) {

396 
	`båfs_w¨n
(
fs_öfo
,

398 
ªt
);

399 
out
;

401 
ªt
 = 1;

404 i‡(
ªt
 == 1) {

406 
	`båfs_ªÀa£_∑th
(
∑th
);

407 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
dev_roŸ
, 
∑th
,

408 &
key
, (*
±r
));

409 i‡(
ªt
 < 0) {

410 
	`båfs_w¨n
(
fs_öfo
,

411 "ö£π dev_ª∂a˚ iãm faûed %d!", 
ªt
);

412 
out
;

416 
eb
 = 
∑th
->
nodes
[0];

417 
±r
 = 
	`båfs_ôem_±r
(
eb
, 
∑th
->
¶Ÿs
[0],

418 
båfs_dev_ª∂a˚_ôem
);

420 
	`down_wrôe
(&
dev_ª∂a˚
->
rw£m
);

421 i‡(
dev_ª∂a˚
->
§cdev
)

422 
	`båfs_£t_dev_ª∂a˚_§c_devid
(
eb
, 
±r
,

423 
dev_ª∂a˚
->
§cdev
->
devid
);

425 
	`båfs_£t_dev_ª∂a˚_§c_devid
(
eb
, 
±r
, (
u64
)-1);

426 
	`båfs_£t_dev_ª∂a˚_c⁄t_ªadög_‰om_§cdev_mode
(
eb
, 
±r
,

427 
dev_ª∂a˚
->
c⁄t_ªadög_‰om_§cdev_mode
);

428 
	`båfs_£t_dev_ª∂a˚_ª∂a˚_°©e
(
eb
, 
±r
,

429 
dev_ª∂a˚
->
ª∂a˚_°©e
);

430 
	`båfs_£t_dev_ª∂a˚_time_°¨ãd
(
eb
, 
±r
, 
dev_ª∂a˚
->
time_°¨ãd
);

431 
	`båfs_£t_dev_ª∂a˚_time_°›≥d
(
eb
, 
±r
, 
dev_ª∂a˚
->
time_°›≥d
);

432 
	`båfs_£t_dev_ª∂a˚_num_wrôe_îr‹s
(
eb
, 
±r
,

433 
	`©omic64_ªad
(&
dev_ª∂a˚
->
num_wrôe_îr‹s
));

434 
	`båfs_£t_dev_ª∂a˚_num_unc‹ª˘abÀ_ªad_îr‹s
(
eb
, 
±r
,

435 
	`©omic64_ªad
(&
dev_ª∂a˚
->
num_unc‹ª˘abÀ_ªad_îr‹s
));

436 
dev_ª∂a˚
->
curs‹_À·_œ°_wrôe_of_ôem
 =

437 
dev_ª∂a˚
->
curs‹_À·
;

438 
	`båfs_£t_dev_ª∂a˚_curs‹_À·
(
eb
, 
±r
,

439 
dev_ª∂a˚
->
curs‹_À·_œ°_wrôe_of_ôem
);

440 
	`båfs_£t_dev_ª∂a˚_curs‹_right
(
eb
, 
±r
,

441 
dev_ª∂a˚
->
curs‹_right
);

442 
dev_ª∂a˚
->
ôem_√eds_wrôeback
 = 0;

443 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

445 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
eb
);

447 
out
:

448 
	`båfs_‰ì_∑th
(
∑th
);

450  
ªt
;

451 
	}
}

453 
	$m¨k_block_group_to_c›y
(
båfs_fs_öfo
 *
fs_öfo
,

454 
båfs_devi˚
 *
§c_dev
)

456 
båfs_∑th
 *
∑th
;

457 
båfs_key
 
key
;

458 
båfs_key
 
found_key
;

459 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
dev_roŸ
;

460 
båfs_dev_exã¡
 *
dev_exã¡
 = 
NULL
;

461 
båfs_block_group
 *
ˇche
;

462 
båfs_å™s_h™dÀ
 *
å™s
;

463 
ôî_ªt
 = 0;

464 
ªt
 = 0;

465 
u64
 
chunk_off£t
;

468 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

471 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

474 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

475 
fs_öfo
->
ru¬ög_å™ß˘i⁄
 &&

476 !
	`li°_em±y
(&
fs_öfo
->
ru¬ög_å™ß˘i⁄
->
dev_upd©e_li°
)) {

477 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

478 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

479 
å™s
 = 
	`båfs_©èch_å™ß˘i⁄
(
roŸ
);

480 i‡(
	`IS_ERR
(
å™s
)) {

481 
ªt
 = 
	`PTR_ERR
(
å™s
);

482 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

483 i‡(
ªt
 =-
ENOENT
) {

484 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

487 
u∆ock
;

491 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

492 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

493 i‡(
ªt
)

494 
u∆ock
;

496 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

498 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

500 
∑th
 = 
	`båfs_Æloc_∑th
();

501 i‡(!
∑th
) {

502 
ªt
 = -
ENOMEM
;

503 
u∆ock
;

506 
∑th
->
ªada
 = 
READA_FORWARD
;

507 
∑th
->
£¨ch_commô_roŸ
 = 1;

508 
∑th
->
skù_lockög
 = 1;

510 
key
.
obje˘id
 = 
§c_dev
->
devid
;

511 
key
.
ty≥
 = 
BTRFS_DEV_EXTENT_KEY
;

512 
key
.
off£t
 = 0;

514 
	`båfs_f‹_óch_¶Ÿ
(
roŸ
, &
key
, &
found_key
, 
∑th
, 
ôî_ªt
) {

515 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

517 i‡(
found_key
.
obje˘id
 !
§c_dev
->
devid
)

520 i‡(
found_key
.
ty≥
 !
BTRFS_DEV_EXTENT_KEY
)

523 i‡(
found_key
.
off£t
 < 
key
.offset)

526 
dev_exã¡
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_dev_exã¡
);

528 
chunk_off£t
 = 
	`båfs_dev_exã¡_chunk_off£t
(
Àaf
, 
dev_exã¡
);

530 
ˇche
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
chunk_off£t
);

531 i‡(!
ˇche
)

534 
	`£t_bô
(
BLOCK_GROUP_FLAG_TO_COPY
, &
ˇche
->
ru¡ime_Êags
);

535 
	`båfs_put_block_group
(
ˇche
);

537 i‡(
ôî_ªt
 < 0)

538 
ªt
 = 
ôî_ªt
;

540 
	`båfs_‰ì_∑th
(
∑th
);

541 
u∆ock
:

542 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

544  
ªt
;

545 
	}
}

547 
boﬁ
 
	$båfs_föish_block_group_to_c›y
(
båfs_devi˚
 *
§cdev
,

548 
båfs_block_group
 *
ˇche
,

549 
u64
 
physiˇl
)

551 
båfs_fs_öfo
 *
fs_öfo
 = 
ˇche
->fs_info;

552 
exã¡_m≠
 *
em
;

553 
m≠_lookup
 *
m≠
;

554 
u64
 
chunk_off£t
 = 
ˇche
->
°¨t
;

555 
num_exã¡s
, 
cur_exã¡
;

556 
i
;

559 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

560  
åue
;

562 
	`•ö_lock
(&
ˇche
->
lock
);

563 i‡(
	`ã°_bô
(
BLOCK_GROUP_FLAG_REMOVED
, &
ˇche
->
ru¡ime_Êags
)) {

564 
	`•ö_u∆ock
(&
ˇche
->
lock
);

565  
åue
;

567 
	`•ö_u∆ock
(&
ˇche
->
lock
);

569 
em
 = 
	`båfs_gë_chunk_m≠
(
fs_öfo
, 
chunk_off£t
, 1);

570 
	`ASSERT
(!
	`IS_ERR
(
em
));

571 
m≠
 = 
em
->
m≠_lookup
;

573 
num_exã¡s
 = 0;

574 
cur_exã¡
 = 0;

575 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

577 i‡(
§cdev
 !
m≠
->
°rùes
[
i
].
dev
)

580 
num_exã¡s
++;

581 i‡(
physiˇl
 =
m≠
->
°rùes
[
i
].physical)

582 
cur_exã¡
 = 
i
;

585 
	`‰ì_exã¡_m≠
(
em
);

587 i‡(
num_exã¡s
 > 1 && 
cur_exã¡
 <Çum_extents - 1) {

592  
Ál£
;

596 
	`˛ór_bô
(
BLOCK_GROUP_FLAG_TO_COPY
, &
ˇche
->
ru¡ime_Êags
);

598  
åue
;

599 
	}
}

601 
	$båfs_dev_ª∂a˚_°¨t
(
båfs_fs_öfo
 *
fs_öfo
,

602 c⁄° *
tgtdev_«me
, 
u64
 
§cdevid
, c⁄° *
§cdev_«me
,

603 
ªad_§c
)

605 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
dev_roŸ
;

606 
båfs_å™s_h™dÀ
 *
å™s
;

607 
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
 = &
fs_öfo
->dev_replace;

608 
ªt
;

609 
båfs_devi˚
 *
tgt_devi˚
 = 
NULL
;

610 
båfs_devi˚
 *
§c_devi˚
 = 
NULL
;

612 
§c_devi˚
 = 
	`båfs_föd_devi˚_by_dev•ec
(
fs_öfo
, 
§cdevid
,

613 
§cdev_«me
);

614 i‡(
	`IS_ERR
(
§c_devi˚
))

615  
	`PTR_ERR
(
§c_devi˚
);

617 i‡(
	`båfs_pö√d_by_sw≠fûe
(
fs_öfo
, 
§c_devi˚
)) {

618 
	`båfs_w¨n_ö_rcu
(
fs_öfo
,

620 
	`båfs_dev_«me
(
§c_devi˚
), src_devi˚->
devid
);

621  -
ETXTBSY
;

628 
å™s
 = 
	`båfs_©èch_å™ß˘i⁄
(
roŸ
);

629 i‡(!
	`IS_ERR
(
å™s
)) {

630 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

631 i‡(
ªt
)

632  
ªt
;

633 } i‡(
	`PTR_ERR
(
å™s
Ë!-
ENOENT
) {

634  
	`PTR_ERR
(
å™s
);

637 
ªt
 = 
	`båfs_öô_dev_ª∂a˚_tgtdev
(
fs_öfo
, 
tgtdev_«me
,

638 
§c_devi˚
, &
tgt_devi˚
);

639 i‡(
ªt
)

640  
ªt
;

642 
ªt
 = 
	`m¨k_block_group_to_c›y
(
fs_öfo
, 
§c_devi˚
);

643 i‡(
ªt
)

644  
ªt
;

646 
	`down_wrôe
(&
dev_ª∂a˚
->
rw£m
);

647 
dev_ª∂a˚
->
ª∂a˚_°©e
) {

648 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

649 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

650 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

652 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

653 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

654 
	`ASSERT
(0);

655 
ªt
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_ALREADY_STARTED
;

656 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

657 
Àave
;

660 
dev_ª∂a˚
->
c⁄t_ªadög_‰om_§cdev_mode
 = 
ªad_§c
;

661 
dev_ª∂a˚
->
§cdev
 = 
§c_devi˚
;

662 
dev_ª∂a˚
->
tgtdev
 = 
tgt_devi˚
;

664 
	`båfs_öfo_ö_rcu
(
fs_öfo
,

666 
	`båfs_dev_«me
(
§c_devi˚
),

667 
§c_devi˚
->
devid
,

668 
	`båfs_dev_«me
(
tgt_devi˚
));

674 
dev_ª∂a˚
->
ª∂a˚_°©e
 = 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
;

675 
dev_ª∂a˚
->
time_°¨ãd
 = 
	`ktime_gë_ªÆ_£c⁄ds
();

676 
dev_ª∂a˚
->
curs‹_À·
 = 0;

677 
dev_ª∂a˚
->
commôãd_curs‹_À·
 = 0;

678 
dev_ª∂a˚
->
curs‹_À·_œ°_wrôe_of_ôem
 = 0;

679 
dev_ª∂a˚
->
curs‹_right
 = 0;

680 
dev_ª∂a˚
->
is_vÆid
 = 1;

681 
dev_ª∂a˚
->
ôem_√eds_wrôeback
 = 1;

682 
	`©omic64_£t
(&
dev_ª∂a˚
->
num_wrôe_îr‹s
, 0);

683 
	`©omic64_£t
(&
dev_ª∂a˚
->
num_unc‹ª˘abÀ_ªad_îr‹s
, 0);

684 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

686 
ªt
 = 
	`båfs_sysfs_add_devi˚
(
tgt_devi˚
);

687 i‡(
ªt
)

688 
	`båfs_îr
(
fs_öfo
, "kobjádd dev faûed %d", 
ªt
);

690 
	`båfs_waô_‹dîed_roŸs
(
fs_öfo
, 
U64_MAX
, 0, (
u64
)-1);

698 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 1);

699 i‡(
	`IS_ERR
(
å™s
)) {

700 
ªt
 = 
	`PTR_ERR
(
å™s
);

701 
	`down_wrôe
(&
dev_ª∂a˚
->
rw£m
);

702 
dev_ª∂a˚
->
ª∂a˚_°©e
 =

703 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
;

704 
dev_ª∂a˚
->
§cdev
 = 
NULL
;

705 
dev_ª∂a˚
->
tgtdev
 = 
NULL
;

706 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

707 
Àave
;

710 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

711 
	`WARN_ON
(
ªt
);

714 
ªt
 = 
	`båfs_s¸ub_dev
(
fs_öfo
, 
§c_devi˚
->
devid
, 0,

715 
	`båfs_devi˚_gë_tŸÆ_byãs
(
§c_devi˚
),

716 &
dev_ª∂a˚
->
s¸ub_¥ogªss
, 0, 1);

718 
ªt
 = 
	`båfs_dev_ª∂a˚_föishög
(
fs_öfo
,Ñet);

719 i‡(
ªt
 =-
EINPROGRESS
)

720 
ªt
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_SCRUB_INPROGRESS
;

722  
ªt
;

724 
Àave
:

725 
	`båfs_de°roy_dev_ª∂a˚_tgtdev
(
tgt_devi˚
);

726  
ªt
;

727 
	}
}

729 
	$båfs_dev_ª∂a˚_by_io˘l
(
båfs_fs_öfo
 *
fs_öfo
,

730 
båfs_io˘l_dev_ª∂a˚_¨gs
 *
¨gs
)

732 
ªt
;

734 
¨gs
->
°¨t
.
c⁄t_ªadög_‰om_§cdev_mode
) {

735 
BTRFS_IOCTL_DEV_REPLACE_CONT_READING_FROM_SRCDEV_MODE_ALWAYS
:

736 
BTRFS_IOCTL_DEV_REPLACE_CONT_READING_FROM_SRCDEV_MODE_AVOID
:

739  -
EINVAL
;

742 i‡((
¨gs
->
°¨t
.
§cdevid
 =0 &&árgs->°¨t.
§cdev_«me
[0] == '\0') ||

743 
¨gs
->
°¨t
.
tgtdev_«me
[0] == '\0')

744  -
EINVAL
;

746 
ªt
 = 
	`båfs_dev_ª∂a˚_°¨t
(
fs_öfo
, 
¨gs
->
°¨t
.
tgtdev_«me
,

747 
¨gs
->
°¨t
.
§cdevid
,

748 
¨gs
->
°¨t
.
§cdev_«me
,

749 
¨gs
->
°¨t
.
c⁄t_ªadög_‰om_§cdev_mode
);

750 
¨gs
->
ªsu…
 = 
ªt
;

752 i‡(
ªt
 =
BTRFS_IOCTL_DEV_REPLACE_RESULT_SCRUB_INPROGRESS
 ||

753 
ªt
 =
BTRFS_IOCTL_DEV_REPLACE_RESULT_NO_ERROR
)

756  
ªt
;

757 
	}
}

762 
	$båfs_rm_dev_ª∂a˚_blocked
(
båfs_fs_öfo
 *
fs_öfo
)

764 
	`£t_bô
(
BTRFS_FS_STATE_DEV_REPLACING
, &
fs_öfo
->
fs_°©e
);

765 
	`waô_evít
(
fs_öfo
->
dev_ª∂a˚
.
ª∂a˚_waô
, !
	`≥r˝u_cou¡î_sum
(

766 &
fs_öfo
->
dev_ª∂a˚
.
bio_cou¡î
));

767 
	}
}

772 
	$båfs_rm_dev_ª∂a˚_unblocked
(
båfs_fs_öfo
 *
fs_öfo
)

774 
	`˛ór_bô
(
BTRFS_FS_STATE_DEV_REPLACING
, &
fs_öfo
->
fs_°©e
);

775 
	`wake_up
(&
fs_öfo
->
dev_ª∂a˚
.
ª∂a˚_waô
);

776 
	}
}

784 
	$båfs_£t_èrgë_Æloc_°©e
(
båfs_devi˚
 *
§cdev
,

785 
båfs_devi˚
 *
tgtdev
)

787 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

788 
u64
 
°¨t
 = 0;

789 
u64
 
found_°¨t
;

790 
u64
 
found_íd
;

791 
ªt
 = 0;

793 
	`lockdï_as£π_hñd
(&
§cdev
->
fs_öfo
->
chunk_muãx
);

795 
	`föd_fú°_exã¡_bô
(&
§cdev
->
Æloc_°©e
, 
°¨t
,

796 &
found_°¨t
, &
found_íd
,

797 
CHUNK_ALLOCATED
, &
ˇched_°©e
)) {

798 
ªt
 = 
	`£t_exã¡_bô
(&
tgtdev
->
Æloc_°©e
, 
found_°¨t
,

799 
found_íd
, 
CHUNK_ALLOCATED
, 
NULL
);

800 i‡(
ªt
)

802 
°¨t
 = 
found_íd
 + 1;

805 
	`‰ì_exã¡_°©e
(
ˇched_°©e
);

806  
ªt
;

807 
	}
}

809 
	$båfs_dev_ª∂a˚_upd©e_devi˚_ö_m≠pög_åì
(

810 
båfs_fs_öfo
 *
fs_öfo
,

811 
båfs_devi˚
 *
§cdev
,

812 
båfs_devi˚
 *
tgtdev
)

814 
exã¡_m≠_åì
 *
em_åì
 = &
fs_öfo
->
m≠pög_åì
;

815 
exã¡_m≠
 *
em
;

816 
m≠_lookup
 *
m≠
;

817 
u64
 
°¨t
 = 0;

818 
i
;

820 
	`wrôe_lock
(&
em_åì
->
lock
);

822 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 
°¨t
, (
u64
)-1);

823 i‡(!
em
)

825 
m≠
 = 
em
->
m≠_lookup
;

826 
i
 = 0; i < 
m≠
->
num_°rùes
; i++)

827 i‡(
§cdev
 =
m≠
->
°rùes
[
i
].
dev
)

828 
m≠
->
°rùes
[
i
].
dev
 = 
tgtdev
;

829 
°¨t
 = 
em
->°¨à+Ém->
Àn
;

830 
	`‰ì_exã¡_m≠
(
em
);

831 } 
°¨t
);

832 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

833 
	}
}

835 
	$båfs_dev_ª∂a˚_föishög
(
båfs_fs_öfo
 *
fs_öfo
,

836 
s¸ub_ªt
)

838 
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
 = &
fs_öfo
->dev_replace;

839 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

840 
båfs_devi˚
 *
tgt_devi˚
;

841 
båfs_devi˚
 *
§c_devi˚
;

842 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
åì_roŸ
;

843 
u8
 
uuid_tmp
[
BTRFS_UUID_SIZE
];

844 
båfs_å™s_h™dÀ
 *
å™s
;

845 
ªt
 = 0;

848 
	`muãx_lock
(&
dev_ª∂a˚
->
lock_föishög_ˇn˚l_unmou¡
);

850 
	`down_ªad
(&
dev_ª∂a˚
->
rw£m
);

852 i‡(
dev_ª∂a˚
->
ª∂a˚_°©e
 !=

853 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
) {

854 
	`up_ªad
(&
dev_ª∂a˚
->
rw£m
);

855 
	`muãx_u∆ock
(&
dev_ª∂a˚
->
lock_föishög_ˇn˚l_unmou¡
);

859 
tgt_devi˚
 = 
dev_ª∂a˚
->
tgtdev
;

860 
§c_devi˚
 = 
dev_ª∂a˚
->
§cdev
;

861 
	`up_ªad
(&
dev_ª∂a˚
->
rw£m
);

867 
ªt
 = 
	`båfs_°¨t_dñÆloc_roŸs
(
fs_öfo
, 
LONG_MAX
, 
Ál£
);

868 i‡(
ªt
) {

869 
	`muãx_u∆ock
(&
dev_ª∂a˚
->
lock_föishög_ˇn˚l_unmou¡
);

870  
ªt
;

872 
	`båfs_waô_‹dîed_roŸs
(
fs_öfo
, 
U64_MAX
, 0, (
u64
)-1);

880 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

881 i‡(
	`IS_ERR
(
å™s
)) {

882 
	`muãx_u∆ock
(&
dev_ª∂a˚
->
lock_föishög_ˇn˚l_unmou¡
);

883  
	`PTR_ERR
(
å™s
);

885 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

886 
	`WARN_ON
(
ªt
);

889 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

891 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

893 i‡(!
	`li°_em±y
(&
§c_devi˚
->
po°_commô_li°
)) {

894 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

895 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

901 
	`down_wrôe
(&
dev_ª∂a˚
->
rw£m
);

902 
dev_ª∂a˚
->
ª∂a˚_°©e
 =

903 
s¸ub_ªt
 ? 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED


904 : 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
;

905 
dev_ª∂a˚
->
tgtdev
 = 
NULL
;

906 
dev_ª∂a˚
->
§cdev
 = 
NULL
;

907 
dev_ª∂a˚
->
time_°›≥d
 = 
	`ktime_gë_ªÆ_£c⁄ds
();

908 
dev_ª∂a˚
->
ôem_√eds_wrôeback
 = 1;

914 i‡(!
s¸ub_ªt
) {

915 
s¸ub_ªt
 = 
	`båfs_£t_èrgë_Æloc_°©e
(
§c_devi˚
, 
tgt_devi˚
);

916 i‡(
s¸ub_ªt
)

917 
îr‹
;

918 
	`båfs_dev_ª∂a˚_upd©e_devi˚_ö_m≠pög_åì
(
fs_öfo
,

919 
§c_devi˚
,

920 
tgt_devi˚
);

922 i‡(
s¸ub_ªt
 !-
ECANCELED
)

923 
	`båfs_îr_ö_rcu
(
fs_öfo
,

925 
	`båfs_dev_«me
(
§c_devi˚
),

926 
§c_devi˚
->
devid
,

927 
	`båfs_dev_«me
(
tgt_devi˚
), 
s¸ub_ªt
);

928 
îr‹
:

929 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

930 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

931 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

932 
	`båfs_rm_dev_ª∂a˚_blocked
(
fs_öfo
);

933 i‡(
tgt_devi˚
)

934 
	`båfs_de°roy_dev_ª∂a˚_tgtdev
(
tgt_devi˚
);

935 
	`båfs_rm_dev_ª∂a˚_unblocked
(
fs_öfo
);

936 
	`muãx_u∆ock
(&
dev_ª∂a˚
->
lock_föishög_ˇn˚l_unmou¡
);

938  
s¸ub_ªt
;

941 
	`båfs_öfo_ö_rcu
(
fs_öfo
,

943 
	`båfs_dev_«me
(
§c_devi˚
),

944 
§c_devi˚
->
devid
,

945 
	`båfs_dev_«me
(
tgt_devi˚
));

946 
	`˛ór_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
tgt_devi˚
->
dev_°©e
);

947 
tgt_devi˚
->
devid
 = 
§c_devi˚
->devid;

948 
§c_devi˚
->
devid
 = 
BTRFS_DEV_REPLACE_DEVID
;

949 
	`mem˝y
(
uuid_tmp
, 
tgt_devi˚
->
uuid
, (uuid_tmp));

950 
	`mem˝y
(
tgt_devi˚
->
uuid
, 
§c_devi˚
->uuid, (tgt_device->uuid));

951 
	`mem˝y
(
§c_devi˚
->
uuid
, 
uuid_tmp
, (src_device->uuid));

952 
	`båfs_devi˚_£t_tŸÆ_byãs
(
tgt_devi˚
, 
§c_devi˚
->
tŸÆ_byãs
);

953 
	`båfs_devi˚_£t_disk_tŸÆ_byãs
(
tgt_devi˚
,

954 
§c_devi˚
->
disk_tŸÆ_byãs
);

955 
	`båfs_devi˚_£t_byãs_u£d
(
tgt_devi˚
, 
§c_devi˚
->
byãs_u£d
);

956 
tgt_devi˚
->
commô_byãs_u£d
 = 
§c_devi˚
->
byãs_u£d
;

958 
	`båfs_assign_√xt_a˘ive_devi˚
(
§c_devi˚
, 
tgt_devi˚
);

960 
	`li°_add
(&
tgt_devi˚
->
dev_Æloc_li°
, &
fs_devi˚s
->
Æloc_li°
);

961 
fs_devi˚s
->
rw_devi˚s
++;

963 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

964 
	`båfs_rm_dev_ª∂a˚_blocked
(
fs_öfo
);

966 
	`båfs_rm_dev_ª∂a˚_ªmove_§cdev
(
§c_devi˚
);

968 
	`båfs_rm_dev_ª∂a˚_unblocked
(
fs_öfo
);

974 
	`©omic_öc
(&
tgt_devi˚
->
dev_°©s_c˙t
);

983 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

984 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

987 
	`båfs_sysfs_ªmove_devi˚
(
§c_devi˚
);

988 
	`båfs_sysfs_upd©e_devid
(
tgt_devi˚
);

989 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
§c_devi˚
->
dev_°©e
))

990 
	`båfs_s¸©ch_su≥rblocks
(
fs_öfo
, 
§c_devi˚
->
bdev
,

991 
§c_devi˚
->
«me
->
°r
);

994 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

995 i‡(!
	`IS_ERR
(
å™s
))

996 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

998 
	`muãx_u∆ock
(&
dev_ª∂a˚
->
lock_föishög_ˇn˚l_unmou¡
);

1000 
	`båfs_rm_dev_ª∂a˚_‰ì_§cdev
(
§c_devi˚
);

1003 
	}
}

1010 
u64
 
	$båfs_dev_ª∂a˚_¥ogªss
(
båfs_fs_öfo
 *
fs_öfo
)

1012 
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
 = &
fs_öfo
->dev_replace;

1013 
u64
 
ªt
 = 0;

1015 
dev_ª∂a˚
->
ª∂a˚_°©e
) {

1016 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

1017 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

1018 
ªt
 = 0;

1020 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

1021 
ªt
 = 1000;

1023 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

1024 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

1025 
ªt
 = 
	`div64_u64
(
dev_ª∂a˚
->
curs‹_À·
,

1026 
	`div_u64
(
	`båfs_devi˚_gë_tŸÆ_byãs
(

1027 
dev_ª∂a˚
->
§cdev
), 1000));

1031  
ªt
;

1032 
	}
}

1034 
	$båfs_dev_ª∂a˚_°©us
(
båfs_fs_öfo
 *
fs_öfo
,

1035 
båfs_io˘l_dev_ª∂a˚_¨gs
 *
¨gs
)

1037 
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
 = &
fs_öfo
->dev_replace;

1039 
	`down_ªad
(&
dev_ª∂a˚
->
rw£m
);

1042 
¨gs
->
ªsu…
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_NO_ERROR
;

1043 
¨gs
->
°©us
.
ª∂a˚_°©e
 = 
dev_ª∂a˚
->replace_state;

1044 
¨gs
->
°©us
.
time_°¨ãd
 = 
dev_ª∂a˚
->time_started;

1045 
¨gs
->
°©us
.
time_°›≥d
 = 
dev_ª∂a˚
->time_stopped;

1046 
¨gs
->
°©us
.
num_wrôe_îr‹s
 =

1047 
	`©omic64_ªad
(&
dev_ª∂a˚
->
num_wrôe_îr‹s
);

1048 
¨gs
->
°©us
.
num_unc‹ª˘abÀ_ªad_îr‹s
 =

1049 
	`©omic64_ªad
(&
dev_ª∂a˚
->
num_unc‹ª˘abÀ_ªad_îr‹s
);

1050 
¨gs
->
°©us
.
¥ogªss_1000
 = 
	`båfs_dev_ª∂a˚_¥ogªss
(
fs_öfo
);

1051 
	`up_ªad
(&
dev_ª∂a˚
->
rw£m
);

1052 
	}
}

1054 
	$båfs_dev_ª∂a˚_ˇn˚l
(
båfs_fs_öfo
 *
fs_öfo
)

1056 
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
 = &
fs_öfo
->dev_replace;

1057 
båfs_devi˚
 *
tgt_devi˚
 = 
NULL
;

1058 
båfs_devi˚
 *
§c_devi˚
 = 
NULL
;

1059 
båfs_å™s_h™dÀ
 *
å™s
;

1060 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
åì_roŸ
;

1061 
ªsu…
;

1062 
ªt
;

1064 i‡(
	`sb_rd⁄ly
(
fs_öfo
->
sb
))

1065  -
EROFS
;

1067 
	`muãx_lock
(&
dev_ª∂a˚
->
lock_föishög_ˇn˚l_unmou¡
);

1068 
	`down_wrôe
(&
dev_ª∂a˚
->
rw£m
);

1069 
dev_ª∂a˚
->
ª∂a˚_°©e
) {

1070 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

1071 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

1072 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

1073 
ªsu…
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_NOT_STARTED
;

1074 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

1076 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

1077 
tgt_devi˚
 = 
dev_ª∂a˚
->
tgtdev
;

1078 
§c_devi˚
 = 
dev_ª∂a˚
->
§cdev
;

1079 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

1080 
ªt
 = 
	`båfs_s¸ub_ˇn˚l
(
fs_öfo
);

1081 i‡(
ªt
 < 0) {

1082 
ªsu…
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_NOT_STARTED
;

1084 
ªsu…
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_NO_ERROR
;

1089 
	`båfs_öfo_ö_rcu
(
fs_öfo
,

1091 
	`båfs_dev_«me
(
§c_devi˚
), src_devi˚->
devid
,

1092 
	`båfs_dev_«me
(
tgt_devi˚
));

1095 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

1100 
ªsu…
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_NO_ERROR
;

1101 
tgt_devi˚
 = 
dev_ª∂a˚
->
tgtdev
;

1102 
§c_devi˚
 = 
dev_ª∂a˚
->
§cdev
;

1103 
dev_ª∂a˚
->
tgtdev
 = 
NULL
;

1104 
dev_ª∂a˚
->
§cdev
 = 
NULL
;

1105 
dev_ª∂a˚
->
ª∂a˚_°©e
 =

1106 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
;

1107 
dev_ª∂a˚
->
time_°›≥d
 = 
	`ktime_gë_ªÆ_£c⁄ds
();

1108 
dev_ª∂a˚
->
ôem_√eds_wrôeback
 = 1;

1110 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

1113 
	`båfs_s¸ub_ˇn˚l
(
fs_öfo
);

1115 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

1116 i‡(
	`IS_ERR
(
å™s
)) {

1117 
	`muãx_u∆ock
(&
dev_ª∂a˚
->
lock_föishög_ˇn˚l_unmou¡
);

1118  
	`PTR_ERR
(
å™s
);

1120 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

1121 
	`WARN_ON
(
ªt
);

1123 
	`båfs_öfo_ö_rcu
(
fs_öfo
,

1125 
	`båfs_dev_«me
(
§c_devi˚
), src_devi˚->
devid
,

1126 
	`båfs_dev_«me
(
tgt_devi˚
));

1128 i‡(
tgt_devi˚
)

1129 
	`båfs_de°roy_dev_ª∂a˚_tgtdev
(
tgt_devi˚
);

1132 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

1133 
ªsu…
 = -
EINVAL
;

1136 
	`muãx_u∆ock
(&
dev_ª∂a˚
->
lock_föishög_ˇn˚l_unmou¡
);

1137  
ªsu…
;

1138 
	}
}

1140 
	$båfs_dev_ª∂a˚_su•íd_f‹_unmou¡
(
båfs_fs_öfo
 *
fs_öfo
)

1142 
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
 = &
fs_öfo
->dev_replace;

1144 
	`muãx_lock
(&
dev_ª∂a˚
->
lock_föishög_ˇn˚l_unmou¡
);

1145 
	`down_wrôe
(&
dev_ª∂a˚
->
rw£m
);

1147 
dev_ª∂a˚
->
ª∂a˚_°©e
) {

1148 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

1149 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

1150 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

1151 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

1153 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

1154 
dev_ª∂a˚
->
ª∂a˚_°©e
 =

1155 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
;

1156 
dev_ª∂a˚
->
time_°›≥d
 = 
	`ktime_gë_ªÆ_£c⁄ds
();

1157 
dev_ª∂a˚
->
ôem_√eds_wrôeback
 = 1;

1158 
	`båfs_öfo
(
fs_öfo
, "suspending dev_replace for unmount");

1162 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

1163 
	`muãx_u∆ock
(&
dev_ª∂a˚
->
lock_föishög_ˇn˚l_unmou¡
);

1164 
	}
}

1167 
	$båfs_ªsume_dev_ª∂a˚_async
(
båfs_fs_öfo
 *
fs_öfo
)

1169 
èsk_°ru˘
 *
èsk
;

1170 
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
 = &
fs_öfo
->dev_replace;

1172 
	`down_wrôe
(&
dev_ª∂a˚
->
rw£m
);

1174 
dev_ª∂a˚
->
ª∂a˚_°©e
) {

1175 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

1176 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

1177 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

1178 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

1180 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

1182 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

1183 
dev_ª∂a˚
->
ª∂a˚_°©e
 =

1184 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
;

1187 i‡(!
dev_ª∂a˚
->
tgtdev
 || !dev_ª∂a˚->tgtdev->
bdev
) {

1188 
	`båfs_öfo
(
fs_öfo
,

1190 
	`båfs_öfo
(
fs_öfo
,

1192 
dev_ª∂a˚
->
ª∂a˚_°©e
 =

1193 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
;

1194 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

1197 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

1204 i‡(!
	`båfs_ex˛›_°¨t
(
fs_öfo
, 
BTRFS_EXCLOP_DEV_REPLACE
)) {

1205 
	`down_wrôe
(&
dev_ª∂a˚
->
rw£m
);

1206 
dev_ª∂a˚
->
ª∂a˚_°©e
 =

1207 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
;

1208 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

1209 
	`båfs_öfo
(
fs_öfo
,

1214 
èsk
 = 
	`kthªad_run
(
båfs_dev_ª∂a˚_kthªad
, 
fs_öfo
, "btrfs-devrepl");

1215  
	`PTR_ERR_OR_ZERO
(
èsk
);

1216 
	}
}

1218 
	$båfs_dev_ª∂a˚_kthªad
(*
d©a
)

1220 
båfs_fs_öfo
 *
fs_öfo
 = 
d©a
;

1221 
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
 = &
fs_öfo
->dev_replace;

1222 
u64
 
¥ogªss
;

1223 
ªt
;

1225 
¥ogªss
 = 
	`båfs_dev_ª∂a˚_¥ogªss
(
fs_öfo
);

1226 
¥ogªss
 = 
	`div_u64
(progress, 10);

1227 
	`båfs_öfo_ö_rcu
(
fs_öfo
,

1229 
	`båfs_dev_«me
(
dev_ª∂a˚
->
§cdev
),

1230 
dev_ª∂a˚
->
§cdev
->
devid
,

1231 
	`båfs_dev_«me
(
dev_ª∂a˚
->
tgtdev
),

1232 ()
¥ogªss
);

1234 
ªt
 = 
	`båfs_s¸ub_dev
(
fs_öfo
, 
dev_ª∂a˚
->
§cdev
->
devid
,

1235 
dev_ª∂a˚
->
commôãd_curs‹_À·
,

1236 
	`båfs_devi˚_gë_tŸÆ_byãs
(
dev_ª∂a˚
->
§cdev
),

1237 &
dev_ª∂a˚
->
s¸ub_¥ogªss
, 0, 1);

1238 
ªt
 = 
	`båfs_dev_ª∂a˚_föishög
(
fs_öfo
,Ñet);

1239 
	`WARN_ON
(
ªt
 &&Ñë !-
ECANCELED
);

1241 
	`båfs_ex˛›_föish
(
fs_öfo
);

1243 
	}
}

1245 
__puª
 
	$båfs_dev_ª∂a˚_is_⁄goög
(
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
)

1247 i‡(!
dev_ª∂a˚
->
is_vÆid
)

1250 
dev_ª∂a˚
->
ª∂a˚_°©e
) {

1251 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

1252 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

1253 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

1255 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

1256 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

1270 
	}
}

1272 
	$båfs_bio_cou¡î_sub
(
båfs_fs_öfo
 *
fs_öfo
, 
s64
 
amou¡
)

1274 
	`≥r˝u_cou¡î_sub
(&
fs_öfo
->
dev_ª∂a˚
.
bio_cou¡î
, 
amou¡
);

1275 
	`c⁄d_wake_up_nomb
(&
fs_öfo
->
dev_ª∂a˚
.
ª∂a˚_waô
);

1276 
	}
}

1278 
	$båfs_bio_cou¡î_öc_blocked
(
båfs_fs_öfo
 *
fs_öfo
)

1281 
	`≥r˝u_cou¡î_öc
(&
fs_öfo
->
dev_ª∂a˚
.
bio_cou¡î
);

1282 i‡(
	`likñy
(!
	`ã°_bô
(
BTRFS_FS_STATE_DEV_REPLACING
,

1283 &
fs_öfo
->
fs_°©e
)))

1286 
	`båfs_bio_cou¡î_dec
(
fs_öfo
);

1287 
	`waô_evít
(
fs_öfo
->
dev_ª∂a˚
.
ª∂a˚_waô
,

1288 !
	`ã°_bô
(
BTRFS_FS_STATE_DEV_REPLACING
,

1289 &
fs_öfo
->
fs_°©e
));

1291 
	}
}

	@dev-replace.h

6 #i‚de‡
BTRFS_DEV_REPLACE_H


7 
	#BTRFS_DEV_REPLACE_H


	)

9 
	gbåfs_io˘l_dev_ª∂a˚_¨gs
;

10 
	gbåfs_fs_öfo
;

11 
	gbåfs_å™s_h™dÀ
;

12 
	gbåfs_dev_ª∂a˚
;

13 
	gbåfs_block_group
;

15 
båfs_öô_dev_ª∂a˚
(
båfs_fs_öfo
 *
fs_öfo
);

16 
båfs_run_dev_ª∂a˚
(
båfs_å™s_h™dÀ
 *
å™s
);

17 
båfs_dev_ª∂a˚_by_io˘l
(
båfs_fs_öfo
 *
fs_öfo
,

18 
båfs_io˘l_dev_ª∂a˚_¨gs
 *
¨gs
);

19 
båfs_dev_ª∂a˚_°©us
(
båfs_fs_öfo
 *
fs_öfo
,

20 
båfs_io˘l_dev_ª∂a˚_¨gs
 *
¨gs
);

21 
båfs_dev_ª∂a˚_ˇn˚l
(
båfs_fs_öfo
 *
fs_öfo
);

22 
båfs_dev_ª∂a˚_su•íd_f‹_unmou¡
(
båfs_fs_öfo
 *
fs_öfo
);

23 
båfs_ªsume_dev_ª∂a˚_async
(
båfs_fs_öfo
 *
fs_öfo
);

24 
__puª
 
båfs_dev_ª∂a˚_is_⁄goög
(
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
);

25 
boﬁ
 
båfs_föish_block_group_to_c›y
(
båfs_devi˚
 *
§cdev
,

26 
båfs_block_group
 *
ˇche
,

27 
u64
 
physiˇl
);

28 
båfs_bio_cou¡î_öc_blocked
(
båfs_fs_öfo
 *
fs_öfo
);

29 
båfs_bio_cou¡î_sub
(
båfs_fs_öfo
 *
fs_öfo
, 
s64
 
amou¡
);

31 
ölöe
 
	$båfs_bio_cou¡î_dec
(
båfs_fs_öfo
 *
fs_öfo
)

33 
	`båfs_bio_cou¡î_sub
(
fs_öfo
, 1);

34 
	}
}

	@dir-item.c

6 
	~"mesßges.h
"

7 
	~"˘ªe.h
"

8 
	~"disk-io.h
"

9 
	~"å™ß˘i⁄.h
"

10 
	~"ac˚ss‹s.h
"

11 
	~"dú-ôem.h
"

21 
båfs_dú_ôem
 *
	$ö£π_wôh_ovîÊow
(
båfs_å™s_h™dÀ


22 *
å™s
,

23 
båfs_roŸ
 *
roŸ
,

24 
båfs_∑th
 *
∑th
,

25 
båfs_key
 *
˝u_key
,

26 
u32
 
d©a_size
,

27 c⁄° *
«me
,

28 
«me_Àn
)

30 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

31 
ªt
;

32 *
±r
;

33 
exã¡_buf„r
 *
Àaf
;

35 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, 
˝u_key
, 
d©a_size
);

36 i‡(
ªt
 =-
EEXIST
) {

37 
båfs_dú_ôem
 *
di
;

38 
di
 = 
	`båfs_m©ch_dú_ôem_«me
(
fs_öfo
, 
∑th
, 
«me
, 
«me_Àn
);

39 i‡(
di
)

40  
	`ERR_PTR
(-
EEXIST
);

41 
	`båfs_exãnd_ôem
(
å™s
, 
∑th
, 
d©a_size
);

42 } i‡(
ªt
 < 0)

43  
	`ERR_PTR
(
ªt
);

44 
	`WARN_ON
(
ªt
 > 0);

45 
Àaf
 = 
∑th
->
nodes
[0];

46 
±r
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], );

47 
	`ASSERT
(
d©a_size
 <
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]));

48 
±r
 +
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]Ë- 
d©a_size
;

49  (
båfs_dú_ôem
 *)
±r
;

50 
	}
}

56 
	$båfs_ö£π_x©å_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

57 
båfs_roŸ
 *
roŸ
,

58 
båfs_∑th
 *
∑th
, 
u64
 
obje˘id
,

59 c⁄° *
«me
, 
u16
 
«me_Àn
,

60 c⁄° *
d©a
, 
u16
 
d©a_Àn
)

62 
ªt
 = 0;

63 
båfs_dú_ôem
 *
dú_ôem
;

64 
«me_±r
, 
d©a_±r
;

65 
båfs_key
 
key
, 
loˇti⁄
;

66 
båfs_disk_key
 
disk_key
;

67 
exã¡_buf„r
 *
Àaf
;

68 
u32
 
d©a_size
;

70 i‡(
«me_Àn
 + 
d©a_Àn
 > 
	`BTRFS_MAX_XATTR_SIZE
(
roŸ
->
fs_öfo
))

71  -
ENOSPC
;

73 
key
.
obje˘id
 = objectid;

74 
key
.
ty≥
 = 
BTRFS_XATTR_ITEM_KEY
;

75 
key
.
off£t
 = 
	`båfs_«me_hash
(
«me
, 
«me_Àn
);

77 
d©a_size
 = (*
dú_ôem
Ë+ 
«me_Àn
 + 
d©a_Àn
;

78 
dú_ôem
 = 
	`ö£π_wôh_ovîÊow
(
å™s
, 
roŸ
, 
∑th
, &
key
, 
d©a_size
,

79 
«me
, 
«me_Àn
);

80 i‡(
	`IS_ERR
(
dú_ôem
))

81  
	`PTR_ERR
(
dú_ôem
);

82 
	`mem£t
(&
loˇti⁄
, 0, (location));

84 
Àaf
 = 
∑th
->
nodes
[0];

85 
	`båfs_˝u_key_to_disk
(&
disk_key
, &
loˇti⁄
);

86 
	`båfs_£t_dú_ôem_key
(
Àaf
, 
dú_ôem
, &
disk_key
);

87 
	`båfs_£t_dú_Êags
(
Àaf
, 
dú_ôem
, 
BTRFS_FT_XATTR
);

88 
	`båfs_£t_dú_«me_Àn
(
Àaf
, 
dú_ôem
, 
«me_Àn
);

89 
	`båfs_£t_dú_å™sid
(
Àaf
, 
dú_ôem
, 
å™s
->
å™sid
);

90 
	`båfs_£t_dú_d©a_Àn
(
Àaf
, 
dú_ôem
, 
d©a_Àn
);

91 
«me_±r
 = ()(
dú_ôem
 + 1);

92 
d©a_±r
 = ()((*)
«me_±r
 + 
«me_Àn
);

94 
	`wrôe_exã¡_buf„r
(
Àaf
, 
«me
, 
«me_±r
, 
«me_Àn
);

95 
	`wrôe_exã¡_buf„r
(
Àaf
, 
d©a
, 
d©a_±r
, 
d©a_Àn
);

96 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑th
->
nodes
[0]);

98  
ªt
;

99 
	}
}

109 
	$båfs_ö£π_dú_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

110 c⁄° 
fs¸y±_°r
 *
«me
, 
båfs_öode
 *
dú
,

111 
båfs_key
 *
loˇti⁄
, 
u8
 
ty≥
, 
u64
 
ödex
)

113 
ªt
 = 0;

114 
ªt2
 = 0;

115 
båfs_roŸ
 *
roŸ
 = 
dú
->root;

116 
båfs_∑th
 *
∑th
;

117 
båfs_dú_ôem
 *
dú_ôem
;

118 
exã¡_buf„r
 *
Àaf
;

119 
«me_±r
;

120 
båfs_key
 
key
;

121 
båfs_disk_key
 
disk_key
;

122 
u32
 
d©a_size
;

124 
key
.
obje˘id
 = 
	`båfs_öo
(
dú
);

125 
key
.
ty≥
 = 
BTRFS_DIR_ITEM_KEY
;

126 
key
.
off£t
 = 
	`båfs_«me_hash
(
«me
->«me,Çame->
Àn
);

128 
∑th
 = 
	`båfs_Æloc_∑th
();

129 i‡(!
∑th
)

130  -
ENOMEM
;

132 
	`båfs_˝u_key_to_disk
(&
disk_key
, 
loˇti⁄
);

134 
d©a_size
 = (*
dú_ôem
Ë+ 
«me
->
Àn
;

135 
dú_ôem
 = 
	`ö£π_wôh_ovîÊow
(
å™s
, 
roŸ
, 
∑th
, &
key
, 
d©a_size
,

136 
«me
->«me,Çame->
Àn
);

137 i‡(
	`IS_ERR
(
dú_ôem
)) {

138 
ªt
 = 
	`PTR_ERR
(
dú_ôem
);

139 i‡(
ªt
 =-
EEXIST
)

140 
£c⁄d_ö£π
;

141 
out_‰ì
;

144 i‡(
	`IS_ENCRYPTED
(&
dú
->
vfs_öode
))

145 
ty≥
 |
BTRFS_FT_ENCRYPTED
;

147 
Àaf
 = 
∑th
->
nodes
[0];

148 
	`båfs_£t_dú_ôem_key
(
Àaf
, 
dú_ôem
, &
disk_key
);

149 
	`båfs_£t_dú_Êags
(
Àaf
, 
dú_ôem
, 
ty≥
);

150 
	`båfs_£t_dú_d©a_Àn
(
Àaf
, 
dú_ôem
, 0);

151 
	`båfs_£t_dú_«me_Àn
(
Àaf
, 
dú_ôem
, 
«me
->
Àn
);

152 
	`båfs_£t_dú_å™sid
(
Àaf
, 
dú_ôem
, 
å™s
->
å™sid
);

153 
«me_±r
 = ()(
dú_ôem
 + 1);

155 
	`wrôe_exã¡_buf„r
(
Àaf
, 
«me
->«me, 
«me_±r
,Çame->
Àn
);

156 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

158 
£c⁄d_ö£π
:

160 i‡(
roŸ
 =roŸ->
fs_öfo
->
åì_roŸ
) {

161 
ªt
 = 0;

162 
out_‰ì
;

164 
	`båfs_ªÀa£_∑th
(
∑th
);

166 
ªt2
 = 
	`båfs_ö£π_dñayed_dú_ödex
(
å™s
, 
«me
->«me,Çame->
Àn
, 
dú
,

167 &
disk_key
, 
ty≥
, 
ödex
);

168 
out_‰ì
:

169 
	`båfs_‰ì_∑th
(
∑th
);

170 i‡(
ªt
)

171  
ªt
;

172 i‡(
ªt2
)

173  
ªt2
;

175 
	}
}

177 
båfs_dú_ôem
 *
	$båfs_lookup_m©ch_dú
(

178 
båfs_å™s_h™dÀ
 *
å™s
,

179 
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
,

180 
båfs_key
 *
key
, c⁄° *
«me
,

181 
«me_Àn
, 
mod
)

183 c⁄° 
ös_Àn
 = (
mod
 < 0 ? -1 : 0);

184 c⁄° 
cow
 = (
mod
 != 0);

185 
ªt
;

187 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, 
key
, 
∑th
, 
ös_Àn
, 
cow
);

188 i‡(
ªt
 < 0)

189  
	`ERR_PTR
(
ªt
);

190 i‡(
ªt
 > 0)

191  
	`ERR_PTR
(-
ENOENT
);

193  
	`båfs_m©ch_dú_ôem_«me
(
roŸ
->
fs_öfo
, 
∑th
, 
«me
, 
«me_Àn
);

194 
	}
}

212 
båfs_dú_ôem
 *
	$båfs_lookup_dú_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

213 
båfs_roŸ
 *
roŸ
,

214 
båfs_∑th
 *
∑th
, 
u64
 
dú
,

215 c⁄° 
fs¸y±_°r
 *
«me
,

216 
mod
)

218 
båfs_key
 
key
;

219 
båfs_dú_ôem
 *
di
;

221 
key
.
obje˘id
 = 
dú
;

222 
key
.
ty≥
 = 
BTRFS_DIR_ITEM_KEY
;

223 
key
.
off£t
 = 
	`båfs_«me_hash
(
«me
->«me,Çame->
Àn
);

225 
di
 = 
	`båfs_lookup_m©ch_dú
(
å™s
, 
roŸ
, 
∑th
, &
key
, 
«me
->name,

226 
«me
->
Àn
, 
mod
);

227 i‡(
	`IS_ERR
(
di
Ë&& 
	`PTR_ERR
(diË=-
ENOENT
)

228  
NULL
;

230  
di
;

231 
	}
}

233 
	$båfs_check_dú_ôem_cﬁlisi⁄
(
båfs_roŸ
 *
roŸ
, 
u64
 
dú
,

234 c⁄° 
fs¸y±_°r
 *
«me
)

236 
ªt
;

237 
båfs_key
 
key
;

238 
båfs_dú_ôem
 *
di
;

239 
d©a_size
;

240 
exã¡_buf„r
 *
Àaf
;

241 
¶Ÿ
;

242 
båfs_∑th
 *
∑th
;

244 
∑th
 = 
	`båfs_Æloc_∑th
();

245 i‡(!
∑th
)

246  -
ENOMEM
;

248 
key
.
obje˘id
 = 
dú
;

249 
key
.
ty≥
 = 
BTRFS_DIR_ITEM_KEY
;

250 
key
.
off£t
 = 
	`båfs_«me_hash
(
«me
->«me,Çame->
Àn
);

252 
di
 = 
	`båfs_lookup_m©ch_dú
(
NULL
, 
roŸ
, 
∑th
, &
key
, 
«me
->name,

253 
«me
->
Àn
, 0);

254 i‡(
	`IS_ERR
(
di
)) {

255 
ªt
 = 
	`PTR_ERR
(
di
);

257 i‡(
ªt
 =-
ENOENT
) {

258 
ªt
 = 0;

259 
out
;

262 i‡(
ªt
 < 0)

263 
out
;

267 i‡(
di
) {

269 
ªt
 = -
EEXIST
;

270 
out
;

274 
d©a_size
 = (*
di
Ë+ 
«me
->
Àn
;

275 
Àaf
 = 
∑th
->
nodes
[0];

276 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

277 i‡(
d©a_size
 + 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
) +

278 (
båfs_ôem
Ë> 
	`BTRFS_LEAF_DATA_SIZE
(
roŸ
->
fs_öfo
)) {

279 
ªt
 = -
EOVERFLOW
;

282 
ªt
 = 0;

284 
out
:

285 
	`båfs_‰ì_∑th
(
∑th
);

286  
ªt
;

287 
	}
}

307 
båfs_dú_ôem
 *

308 
	$båfs_lookup_dú_ödex_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

309 
båfs_roŸ
 *
roŸ
,

310 
båfs_∑th
 *
∑th
, 
u64
 
dú
,

311 
u64
 
ödex
, c⁄° 
fs¸y±_°r
 *
«me
, 
mod
)

313 
båfs_dú_ôem
 *
di
;

314 
båfs_key
 
key
;

316 
key
.
obje˘id
 = 
dú
;

317 
key
.
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

318 
key
.
off£t
 = 
ödex
;

320 
di
 = 
	`båfs_lookup_m©ch_dú
(
å™s
, 
roŸ
, 
∑th
, &
key
, 
«me
->name,

321 
«me
->
Àn
, 
mod
);

322 i‡(
di
 =
	`ERR_PTR
(-
ENOENT
))

323  
NULL
;

325  
di
;

326 
	}
}

328 
båfs_dú_ôem
 *

329 
	$båfs_£¨ch_dú_ödex_ôem
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
,

330 
u64
 
dúid
, c⁄° 
fs¸y±_°r
 *
«me
)

332 
båfs_dú_ôem
 *
di
;

333 
båfs_key
 
key
;

334 
ªt
;

336 
key
.
obje˘id
 = 
dúid
;

337 
key
.
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

338 
key
.
off£t
 = 0;

340 
	`båfs_f‹_óch_¶Ÿ
(
roŸ
, &
key
, &key, 
∑th
, 
ªt
) {

341 i‡(
key
.
obje˘id
 !
dúid
 || key.
ty≥
 !
BTRFS_DIR_INDEX_KEY
)

344 
di
 = 
	`båfs_m©ch_dú_ôem_«me
(
roŸ
->
fs_öfo
, 
∑th
,

345 
«me
->«me,Çame->
Àn
);

346 i‡(
di
)

347  
di
;

350 i‡(
ªt
 > 0)

351 
ªt
 = 0;

353  
	`ERR_PTR
(
ªt
);

354 
	}
}

356 
båfs_dú_ôem
 *
	$båfs_lookup_x©å
(
båfs_å™s_h™dÀ
 *
å™s
,

357 
båfs_roŸ
 *
roŸ
,

358 
båfs_∑th
 *
∑th
, 
u64
 
dú
,

359 c⁄° *
«me
, 
u16
 
«me_Àn
,

360 
mod
)

362 
båfs_key
 
key
;

363 
båfs_dú_ôem
 *
di
;

365 
key
.
obje˘id
 = 
dú
;

366 
key
.
ty≥
 = 
BTRFS_XATTR_ITEM_KEY
;

367 
key
.
off£t
 = 
	`båfs_«me_hash
(
«me
, 
«me_Àn
);

369 
di
 = 
	`båfs_lookup_m©ch_dú
(
å™s
, 
roŸ
, 
∑th
, &
key
, 
«me
, 
«me_Àn
, 
mod
);

370 i‡(
	`IS_ERR
(
di
Ë&& 
	`PTR_ERR
(diË=-
ENOENT
)

371  
NULL
;

373  
di
;

374 
	}
}

381 
båfs_dú_ôem
 *
	$båfs_m©ch_dú_ôem_«me
(
båfs_fs_öfo
 *
fs_öfo
,

382 
båfs_∑th
 *
∑th
,

383 c⁄° *
«me
, 
«me_Àn
)

385 
båfs_dú_ôem
 *
dú_ôem
;

386 
«me_±r
;

387 
u32
 
tŸÆ_Àn
;

388 
u32
 
cur
 = 0;

389 
u32
 
this_Àn
;

390 
exã¡_buf„r
 *
Àaf
;

392 
Àaf
 = 
∑th
->
nodes
[0];

393 
dú_ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_dú_ôem
);

395 
tŸÆ_Àn
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

396 
cur
 < 
tŸÆ_Àn
) {

397 
this_Àn
 = (*
dú_ôem
) +

398 
	`båfs_dú_«me_Àn
(
Àaf
, 
dú_ôem
) +

399 
	`båfs_dú_d©a_Àn
(
Àaf
, 
dú_ôem
);

400 
«me_±r
 = ()(
dú_ôem
 + 1);

402 i‡(
	`båfs_dú_«me_Àn
(
Àaf
, 
dú_ôem
Ë=
«me_Àn
 &&

403 
	`memcmp_exã¡_buf„r
(
Àaf
, 
«me
, 
«me_±r
, 
«me_Àn
) == 0)

404  
dú_ôem
;

406 
cur
 +
this_Àn
;

407 
dú_ôem
 = (
båfs_dú_ôem
 *)((*)dir_item +

408 
this_Àn
);

410  
NULL
;

411 
	}
}

417 
	$båfs_dñëe_⁄e_dú_«me
(
båfs_å™s_h™dÀ
 *
å™s
,

418 
båfs_roŸ
 *
roŸ
,

419 
båfs_∑th
 *
∑th
,

420 
båfs_dú_ôem
 *
di
)

423 
exã¡_buf„r
 *
Àaf
;

424 
u32
 
sub_ôem_Àn
;

425 
u32
 
ôem_Àn
;

426 
ªt
 = 0;

428 
Àaf
 = 
∑th
->
nodes
[0];

429 
sub_ôem_Àn
 = (*
di
Ë+ 
	`båfs_dú_«me_Àn
(
Àaf
, di) +

430 
	`båfs_dú_d©a_Àn
(
Àaf
, 
di
);

431 
ôem_Àn
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

432 i‡(
sub_ôem_Àn
 =
ôem_Àn
) {

433 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

436 
±r
 = ()
di
;

437 
°¨t
;

439 
°¨t
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

440 
	`memmove_exã¡_buf„r
(
Àaf
, 
±r
,Öå + 
sub_ôem_Àn
,

441 
ôem_Àn
 - (
±r
 + 
sub_ôem_Àn
 - 
°¨t
));

442 
	`båfs_åunˇã_ôem
(
å™s
, 
∑th
, 
ôem_Àn
 - 
sub_ôem_Àn
, 1);

444  
ªt
;

445 
	}
}

	@dir-item.h

3 #i‚de‡
BTRFS_DIR_ITEM_H


4 
	#BTRFS_DIR_ITEM_H


	)

6 
båfs_check_dú_ôem_cﬁlisi⁄
(
båfs_roŸ
 *
roŸ
, 
u64
 
dú
,

7 c⁄° 
fs¸y±_°r
 *
«me
);

8 
båfs_ö£π_dú_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

9 c⁄° 
fs¸y±_°r
 *
«me
, 
båfs_öode
 *
dú
,

10 
båfs_key
 *
loˇti⁄
, 
u8
 
ty≥
, 
u64
 
ödex
);

11 
båfs_dú_ôem
 *
båfs_lookup_dú_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

12 
båfs_roŸ
 *
roŸ
,

13 
båfs_∑th
 *
∑th
, 
u64
 
dú
,

14 c⁄° 
fs¸y±_°r
 *
«me
, 
mod
);

15 
båfs_dú_ôem
 *
båfs_lookup_dú_ödex_ôem
(

16 
båfs_å™s_h™dÀ
 *
å™s
,

17 
båfs_roŸ
 *
roŸ
,

18 
båfs_∑th
 *
∑th
, 
u64
 
dú
,

19 
u64
 
ödex
, c⁄° 
fs¸y±_°r
 *
«me
, 
mod
);

20 
båfs_dú_ôem
 *
båfs_£¨ch_dú_ödex_ôem
(
båfs_roŸ
 *
roŸ
,

21 
båfs_∑th
 *
∑th
, 
u64
 
dúid
,

22 c⁄° 
fs¸y±_°r
 *
«me
);

23 
båfs_dñëe_⁄e_dú_«me
(
båfs_å™s_h™dÀ
 *
å™s
,

24 
båfs_roŸ
 *
roŸ
,

25 
båfs_∑th
 *
∑th
,

26 
båfs_dú_ôem
 *
di
);

27 
båfs_ö£π_x©å_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

28 
båfs_roŸ
 *
roŸ
,

29 
båfs_∑th
 *
∑th
, 
u64
 
obje˘id
,

30 c⁄° *
«me
, 
u16
 
«me_Àn
,

31 c⁄° *
d©a
, 
u16
 
d©a_Àn
);

32 
båfs_dú_ôem
 *
båfs_lookup_x©å
(
båfs_å™s_h™dÀ
 *
å™s
,

33 
båfs_roŸ
 *
roŸ
,

34 
båfs_∑th
 *
∑th
, 
u64
 
dú
,

35 c⁄° *
«me
, 
u16
 
«me_Àn
,

36 
mod
);

37 
båfs_dú_ôem
 *
båfs_m©ch_dú_ôem_«me
(
båfs_fs_öfo
 *
fs_öfo
,

38 
båfs_∑th
 *
∑th
,

39 c⁄° *
«me
,

40 
«me_Àn
);

	@discard.c

3 
	~<löux/jiffõs.h
>

4 
	~<löux/kî√l.h
>

5 
	~<löux/ktime.h
>

6 
	~<löux/li°.h
>

7 
	~<löux/m©h64.h
>

8 
	~<löux/sizes.h
>

9 
	~<löux/w‹kqueue.h
>

10 
	~"˘ªe.h
"

11 
	~"block-group.h
"

12 
	~"disˇrd.h
"

13 
	~"‰ì-•a˚-ˇche.h
"

14 
	~"fs.h
"

56 
	#BTRFS_DISCARD_DELAY
 (120ULL * 
NSEC_PER_SEC
)

	)

57 
	#BTRFS_DISCARD_UNUSED_DELAY
 (10ULL * 
NSEC_PER_SEC
)

	)

59 
	#BTRFS_DISCARD_MIN_DELAY_MSEC
 (1UL)

	)

60 
	#BTRFS_DISCARD_MAX_DELAY_MSEC
 (1000UL)

	)

61 
	#BTRFS_DISCARD_MAX_IOPS
 (1000U)

	)

64 
	gdisˇrd_möÀn
[
BTRFS_NR_DISCARD_LISTS
] = {

66 
BTRFS_ASYNC_DISCARD_MAX_FILTER
,

67 
BTRFS_ASYNC_DISCARD_MIN_FILTER


70 
li°_hód
 *
	$gë_disˇrd_li°
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
,

71 
båfs_block_group
 *
block_group
)

73  &
disˇrd_˘l
->
disˇrd_li°
[
block_group
->
disˇrd_ödex
];

74 
	}
}

83 
boﬁ
 
	$båfs_run_disˇrd_w‹k
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
)

85 
båfs_fs_öfo
 *
fs_öfo
 = 
	`c⁄èöî_of
(
disˇrd_˘l
,

86 
båfs_fs_öfo
,

87 
disˇrd_˘l
);

89  (!(
fs_öfo
->
sb
->
s_Êags
 & 
SB_RDONLY
) &&

90 
	`ã°_bô
(
BTRFS_FS_DISCARD_RUNNING
, &
fs_öfo
->
Êags
));

91 
	}
}

93 
	$__add_to_disˇrd_li°
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
,

94 
båfs_block_group
 *
block_group
)

96 
	`lockdï_as£π_hñd
(&
disˇrd_˘l
->
lock
);

97 i‡(!
	`båfs_run_disˇrd_w‹k
(
disˇrd_˘l
))

100 i‡(
	`li°_em±y
(&
block_group
->
disˇrd_li°
) ||

101 
block_group
->
disˇrd_ödex
 =
BTRFS_DISCARD_INDEX_UNUSED
) {

102 i‡(
block_group
->
disˇrd_ödex
 =
BTRFS_DISCARD_INDEX_UNUSED
)

103 
block_group
->
disˇrd_ödex
 = 
BTRFS_DISCARD_INDEX_START
;

104 
block_group
->
disˇrd_ñigibÀ_time
 = (
	`ktime_gë_ns
() +

105 
BTRFS_DISCARD_DELAY
);

106 
block_group
->
disˇrd_°©e
 = 
BTRFS_DISCARD_RESET_CURSOR
;

108 i‡(
	`li°_em±y
(&
block_group
->
disˇrd_li°
))

109 
	`båfs_gë_block_group
(
block_group
);

111 
	`li°_move_èû
(&
block_group
->
disˇrd_li°
,

112 
	`gë_disˇrd_li°
(
disˇrd_˘l
, 
block_group
));

113 
	}
}

115 
	$add_to_disˇrd_li°
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
,

116 
båfs_block_group
 *
block_group
)

118 i‡(!
	`båfs_is_block_group_d©a_⁄ly
(
block_group
))

121 
	`•ö_lock
(&
disˇrd_˘l
->
lock
);

122 
	`__add_to_disˇrd_li°
(
disˇrd_˘l
, 
block_group
);

123 
	`•ö_u∆ock
(&
disˇrd_˘l
->
lock
);

124 
	}
}

126 
	$add_to_disˇrd_unu£d_li°
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
,

127 
båfs_block_group
 *
block_group
)

129 
boﬁ
 
queued
;

131 
	`•ö_lock
(&
disˇrd_˘l
->
lock
);

133 
queued
 = !
	`li°_em±y
(&
block_group
->
disˇrd_li°
);

135 i‡(!
	`båfs_run_disˇrd_w‹k
(
disˇrd_˘l
)) {

136 
	`•ö_u∆ock
(&
disˇrd_˘l
->
lock
);

140 
	`li°_dñ_öô
(&
block_group
->
disˇrd_li°
);

142 
block_group
->
disˇrd_ödex
 = 
BTRFS_DISCARD_INDEX_UNUSED
;

143 
block_group
->
disˇrd_ñigibÀ_time
 = (
	`ktime_gë_ns
() +

144 
BTRFS_DISCARD_UNUSED_DELAY
);

145 
block_group
->
disˇrd_°©e
 = 
BTRFS_DISCARD_RESET_CURSOR
;

146 i‡(!
queued
)

147 
	`båfs_gë_block_group
(
block_group
);

148 
	`li°_add_èû
(&
block_group
->
disˇrd_li°
,

149 &
disˇrd_˘l
->
disˇrd_li°
[
BTRFS_DISCARD_INDEX_UNUSED
]);

151 
	`•ö_u∆ock
(&
disˇrd_˘l
->
lock
);

152 
	}
}

154 
boﬁ
 
	$ªmove_‰om_disˇrd_li°
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
,

155 
båfs_block_group
 *
block_group
)

157 
boﬁ
 
ru¬ög
 = 
Ál£
;

158 
boﬁ
 
queued
 = 
Ál£
;

160 
	`•ö_lock
(&
disˇrd_˘l
->
lock
);

162 i‡(
block_group
 =
disˇrd_˘l
->block_group) {

163 
ru¬ög
 = 
åue
;

164 
disˇrd_˘l
->
block_group
 = 
NULL
;

167 
block_group
->
disˇrd_ñigibÀ_time
 = 0;

168 
queued
 = !
	`li°_em±y
(&
block_group
->
disˇrd_li°
);

169 
	`li°_dñ_öô
(&
block_group
->
disˇrd_li°
);

176 i‡(
queued
 && !
ru¬ög
)

177 
	`båfs_put_block_group
(
block_group
);

179 
	`•ö_u∆ock
(&
disˇrd_˘l
->
lock
);

181  
ru¬ög
;

182 
	}
}

193 
båfs_block_group
 *
	$föd_√xt_block_group
(

194 
båfs_disˇrd_˘l
 *
disˇrd_˘l
,

195 
u64
 
now
)

197 
båfs_block_group
 *
ªt_block_group
 = 
NULL
, *
block_group
;

198 
i
;

200 
i
 = 0; i < 
BTRFS_NR_DISCARD_LISTS
; i++) {

201 
li°_hód
 *
disˇrd_li°
 = &
disˇrd_˘l
->disˇrd_li°[
i
];

203 i‡(!
	`li°_em±y
(
disˇrd_li°
)) {

204 
block_group
 = 
	`li°_fú°_íåy
(
disˇrd_li°
,

205 
båfs_block_group
,

206 
disˇrd_li°
);

208 i‡(!
ªt_block_group
)

209 
ªt_block_group
 = 
block_group
;

211 i‡(
ªt_block_group
->
disˇrd_ñigibÀ_time
 < 
now
)

214 i‡(
ªt_block_group
->
disˇrd_ñigibÀ_time
 >

215 
block_group
->
disˇrd_ñigibÀ_time
)

216 
ªt_block_group
 = 
block_group
;

220  
ªt_block_group
;

221 
	}
}

237 
båfs_block_group
 *
	$≥ek_disˇrd_li°
(

238 
båfs_disˇrd_˘l
 *
disˇrd_˘l
,

239 
båfs_disˇrd_°©e
 *
disˇrd_°©e
,

240 *
disˇrd_ödex
, 
u64
 
now
)

242 
båfs_block_group
 *
block_group
;

244 
	`•ö_lock
(&
disˇrd_˘l
->
lock
);

245 
agaö
:

246 
block_group
 = 
	`föd_√xt_block_group
(
disˇrd_˘l
, 
now
);

248 i‡(
block_group
 && 
now
 >block_group->
disˇrd_ñigibÀ_time
) {

249 i‡(
block_group
->
disˇrd_ödex
 =
BTRFS_DISCARD_INDEX_UNUSED
 &&

250 
block_group
->
u£d
 != 0) {

251 i‡(
	`båfs_is_block_group_d©a_⁄ly
(
block_group
)) {

252 
	`__add_to_disˇrd_li°
(
disˇrd_˘l
, 
block_group
);

254 
	`li°_dñ_öô
(&
block_group
->
disˇrd_li°
);

255 
	`båfs_put_block_group
(
block_group
);

257 
agaö
;

259 i‡(
block_group
->
disˇrd_°©e
 =
BTRFS_DISCARD_RESET_CURSOR
) {

260 
block_group
->
disˇrd_curs‹
 = block_group->
°¨t
;

261 
block_group
->
disˇrd_°©e
 = 
BTRFS_DISCARD_EXTENTS
;

263 
disˇrd_˘l
->
block_group
 = block_group;

265 i‡(
block_group
) {

266 *
disˇrd_°©e
 = 
block_group
->discard_state;

267 *
disˇrd_ödex
 = 
block_group
->discard_index;

269 
	`•ö_u∆ock
(&
disˇrd_˘l
->
lock
);

271  
block_group
;

272 
	}
}

285 
	$båfs_disˇrd_check_fûãr
(
båfs_block_group
 *
block_group
,

286 
u64
 
byãs
)

288 
båfs_disˇrd_˘l
 *
disˇrd_˘l
;

290 i‡(!
block_group
 ||

291 !
	`båfs_ã°_›t
(
block_group
->
fs_öfo
, 
DISCARD_ASYNC
))

294 
disˇrd_˘l
 = &
block_group
->
fs_öfo
->discard_ctl;

296 i‡(
block_group
->
disˇrd_ödex
 > 
BTRFS_DISCARD_INDEX_START
 &&

297 
byãs
 >
disˇrd_möÀn
[
block_group
->
disˇrd_ödex
 - 1]) {

298 
i
;

300 
	`ªmove_‰om_disˇrd_li°
(
disˇrd_˘l
, 
block_group
);

302 
i
 = 
BTRFS_DISCARD_INDEX_START
; i < 
BTRFS_NR_DISCARD_LISTS
;

303 
i
++) {

304 i‡(
byãs
 >
disˇrd_möÀn
[
i
]) {

305 
block_group
->
disˇrd_ödex
 = 
i
;

306 
	`add_to_disˇrd_li°
(
disˇrd_˘l
, 
block_group
);

311 
	}
}

322 
	$båfs_upd©e_disˇrd_ödex
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
,

323 
båfs_block_group
 *
block_group
)

325 
block_group
->
disˇrd_ödex
++;

326 i‡(
block_group
->
disˇrd_ödex
 =
BTRFS_NR_DISCARD_LISTS
) {

327 
block_group
->
disˇrd_ödex
 = 1;

331 
	`add_to_disˇrd_li°
(
disˇrd_˘l
, 
block_group
);

332 
	}
}

343 
	$båfs_disˇrd_ˇn˚l_w‹k
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
,

344 
båfs_block_group
 *
block_group
)

346 i‡(
	`ªmove_‰om_disˇrd_li°
(
disˇrd_˘l
, 
block_group
)) {

347 
	`ˇn˚l_dñayed_w‹k_sync
(&
disˇrd_˘l
->
w‹k
);

348 
	`båfs_disˇrd_scheduÀ_w‹k
(
disˇrd_˘l
, 
åue
);

350 
	}
}

360 
	$båfs_disˇrd_queue_w‹k
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
,

361 
båfs_block_group
 *
block_group
)

363 i‡(!
block_group
 || !
	`båfs_ã°_›t
(block_group->
fs_öfo
, 
DISCARD_ASYNC
))

366 i‡(
block_group
->
u£d
 == 0)

367 
	`add_to_disˇrd_unu£d_li°
(
disˇrd_˘l
, 
block_group
);

369 
	`add_to_disˇrd_li°
(
disˇrd_˘l
, 
block_group
);

371 i‡(!
	`dñayed_w‹k_≥ndög
(&
disˇrd_˘l
->
w‹k
))

372 
	`båfs_disˇrd_scheduÀ_w‹k
(
disˇrd_˘l
, 
Ál£
);

373 
	}
}

375 
	$__båfs_disˇrd_scheduÀ_w‹k
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
,

376 
u64
 
now
, 
boﬁ
 
ovîride
)

378 
båfs_block_group
 *
block_group
;

380 i‡(!
	`båfs_run_disˇrd_w‹k
(
disˇrd_˘l
))

382 i‡(!
ovîride
 && 
	`dñayed_w‹k_≥ndög
(&
disˇrd_˘l
->
w‹k
))

385 
block_group
 = 
	`föd_√xt_block_group
(
disˇrd_˘l
, 
now
);

386 i‡(
block_group
) {

387 
u64
 
dñay
 = 
disˇrd_˘l
->
dñay_ms
 * 
NSEC_PER_MSEC
;

388 
u32
 
kbps_limô
 = 
	`READ_ONCE
(
disˇrd_˘l
->kbps_limit);

395 i‡(
kbps_limô
 && 
disˇrd_˘l
->
¥ev_disˇrd
) {

396 
u64
 
bps_limô
 = ((u64)
kbps_limô
Ë* 
SZ_1K
;

397 
u64
 
bps_dñay
 = 
	`div64_u64
(
disˇrd_˘l
->
¥ev_disˇrd
 *

398 
NSEC_PER_SEC
, 
bps_limô
);

400 
dñay
 = 
	`max
(dñay, 
bps_dñay
);

407 i‡(
now
 < 
block_group
->
disˇrd_ñigibÀ_time
) {

408 
u64
 
bg_timeout
 = 
block_group
->
disˇrd_ñigibÀ_time
 - 
now
;

410 
dñay
 = 
	`max
(dñay, 
bg_timeout
);

413 i‡(
ovîride
 && 
disˇrd_˘l
->
¥ev_disˇrd
) {

414 
u64
 
ñ≠£d
 = 
now
 - 
disˇrd_˘l
->
¥ev_disˇrd_time
;

416 i‡(
dñay
 > 
ñ≠£d
)

417 
dñay
 -
ñ≠£d
;

419 
dñay
 = 0;

422 
	`mod_dñayed_w‹k
(
disˇrd_˘l
->
disˇrd_w‹kîs
,

423 &
disˇrd_˘l
->
w‹k
, 
	`n£cs_to_jiffõs
(
dñay
));

425 
	}
}

437 
	$båfs_disˇrd_scheduÀ_w‹k
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
,

438 
boﬁ
 
ovîride
)

440 c⁄° 
u64
 
now
 = 
	`ktime_gë_ns
();

442 
	`•ö_lock
(&
disˇrd_˘l
->
lock
);

443 
	`__båfs_disˇrd_scheduÀ_w‹k
(
disˇrd_˘l
, 
now
, 
ovîride
);

444 
	`•ö_u∆ock
(&
disˇrd_˘l
->
lock
);

445 
	}
}

458 
	$båfs_föish_disˇrd_∑ss
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
,

459 
båfs_block_group
 *
block_group
)

461 
	`ªmove_‰om_disˇrd_li°
(
disˇrd_˘l
, 
block_group
);

463 i‡(
block_group
->
u£d
 == 0) {

464 i‡(
	`båfs_is_‰ì_•a˚_åimmed
(
block_group
))

465 
	`båfs_m¨k_bg_unu£d
(
block_group
);

467 
	`add_to_disˇrd_unu£d_li°
(
disˇrd_˘l
, 
block_group
);

469 
	`båfs_upd©e_disˇrd_ödex
(
disˇrd_˘l
, 
block_group
);

471 
	}
}

482 
	$båfs_disˇrd_w‹k‚
(
w‹k_°ru˘
 *
w‹k
)

484 
båfs_disˇrd_˘l
 *
disˇrd_˘l
;

485 
båfs_block_group
 *
block_group
;

486 
båfs_disˇrd_°©e
 
disˇrd_°©e
;

487 
disˇrd_ödex
 = 0;

488 
u64
 
åimmed
 = 0;

489 
u64
 
möÀn
 = 0;

490 
u64
 
now
 = 
	`ktime_gë_ns
();

492 
disˇrd_˘l
 = 
	`c⁄èöî_of
(
w‹k
, 
båfs_disˇrd_˘l
, work.work);

494 
block_group
 = 
	`≥ek_disˇrd_li°
(
disˇrd_˘l
, &
disˇrd_°©e
,

495 &
disˇrd_ödex
, 
now
);

496 i‡(!
block_group
 || !
	`båfs_run_disˇrd_w‹k
(
disˇrd_˘l
))

498 i‡(
now
 < 
block_group
->
disˇrd_ñigibÀ_time
) {

499 
	`båfs_disˇrd_scheduÀ_w‹k
(
disˇrd_˘l
, 
Ál£
);

504 
möÀn
 = 
disˇrd_möÀn
[
disˇrd_ödex
];

506 i‡(
disˇrd_°©e
 =
BTRFS_DISCARD_BITMAPS
) {

507 
u64
 
maxÀn
 = 0;

515 i‡(
disˇrd_ödex
 !
BTRFS_DISCARD_INDEX_UNUSED
)

516 
maxÀn
 = 
disˇrd_möÀn
[
disˇrd_ödex
 - 1];

518 
	`båfs_åim_block_group_bôm≠s
(
block_group
, &
åimmed
,

519 
block_group
->
disˇrd_curs‹
,

520 
	`båfs_block_group_íd
(
block_group
),

521 
möÀn
, 
maxÀn
, 
åue
);

522 
disˇrd_˘l
->
disˇrd_bôm≠_byãs
 +
åimmed
;

524 
	`båfs_åim_block_group_exã¡s
(
block_group
, &
åimmed
,

525 
block_group
->
disˇrd_curs‹
,

526 
	`båfs_block_group_íd
(
block_group
),

527 
möÀn
, 
åue
);

528 
disˇrd_˘l
->
disˇrd_exã¡_byãs
 +
åimmed
;

532 i‡(
block_group
->
disˇrd_curs‹
 >
	`båfs_block_group_íd
(block_group)) {

533 i‡(
disˇrd_°©e
 =
BTRFS_DISCARD_BITMAPS
) {

534 
	`båfs_föish_disˇrd_∑ss
(
disˇrd_˘l
, 
block_group
);

536 
block_group
->
disˇrd_curs‹
 = block_group->
°¨t
;

537 
	`•ö_lock
(&
disˇrd_˘l
->
lock
);

538 i‡(
block_group
->
disˇrd_°©e
 !=

539 
BTRFS_DISCARD_RESET_CURSOR
)

540 
block_group
->
disˇrd_°©e
 =

541 
BTRFS_DISCARD_BITMAPS
;

542 
	`•ö_u∆ock
(&
disˇrd_˘l
->
lock
);

546 
now
 = 
	`ktime_gë_ns
();

547 
	`•ö_lock
(&
disˇrd_˘l
->
lock
);

548 
disˇrd_˘l
->
¥ev_disˇrd
 = 
åimmed
;

549 
disˇrd_˘l
->
¥ev_disˇrd_time
 = 
now
;

557 i‡(
disˇrd_˘l
->
block_group
 =
NULL
)

558 
	`båfs_put_block_group
(
block_group
);

559 
disˇrd_˘l
->
block_group
 = 
NULL
;

560 
	`__båfs_disˇrd_scheduÀ_w‹k
(
disˇrd_˘l
, 
now
, 
Ál£
);

561 
	`•ö_u∆ock
(&
disˇrd_˘l
->
lock
);

562 
	}
}

573 
	$båfs_disˇrd_ˇlc_dñay
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
)

575 
s32
 
disˇrdabÀ_exã¡s
;

576 
s64
 
disˇrdabÀ_byãs
;

577 
u32
 
i›s_limô
;

578 
mö_dñay
 = 
BTRFS_DISCARD_MIN_DELAY_MSEC
;

579 
dñay
;

581 
disˇrdabÀ_exã¡s
 = 
	`©omic_ªad
(&
disˇrd_˘l
->discardable_extents);

582 i‡(!
disˇrdabÀ_exã¡s
)

585 
	`•ö_lock
(&
disˇrd_˘l
->
lock
);

594 i‡(
disˇrdabÀ_exã¡s
 < 0)

595 
	`©omic_add
(-
disˇrdabÀ_exã¡s
,

596 &
disˇrd_˘l
->
disˇrdabÀ_exã¡s
);

598 
disˇrdabÀ_byãs
 = 
	`©omic64_ªad
(&
disˇrd_˘l
->discardable_bytes);

599 i‡(
disˇrdabÀ_byãs
 < 0)

600 
	`©omic64_add
(-
disˇrdabÀ_byãs
,

601 &
disˇrd_˘l
->
disˇrdabÀ_byãs
);

603 i‡(
disˇrdabÀ_exã¡s
 <= 0) {

604 
	`•ö_u∆ock
(&
disˇrd_˘l
->
lock
);

608 
i›s_limô
 = 
	`READ_ONCE
(
disˇrd_˘l
->iops_limit);

610 i‡(
i›s_limô
) {

611 
dñay
 = 
MSEC_PER_SEC
 / 
i›s_limô
;

617 
dñay
 = 0;

618 
mö_dñay
 = 0;

621 
dñay
 = 
	`˛amp
(dñay, 
mö_dñay
, 
BTRFS_DISCARD_MAX_DELAY_MSEC
);

622 
disˇrd_˘l
->
dñay_ms
 = 
dñay
;

624 
	`•ö_u∆ock
(&
disˇrd_˘l
->
lock
);

625 
	}
}

636 
	$båfs_disˇrd_upd©e_disˇrdabÀ
(
båfs_block_group
 *
block_group
)

638 
båfs_‰ì_•a˚_˘l
 *
˘l
;

639 
båfs_disˇrd_˘l
 *
disˇrd_˘l
;

640 
s32
 
exã¡s_dñè
;

641 
s64
 
byãs_dñè
;

643 i‡(!
block_group
 ||

644 !
	`båfs_ã°_›t
(
block_group
->
fs_öfo
, 
DISCARD_ASYNC
) ||

645 !
	`båfs_is_block_group_d©a_⁄ly
(
block_group
))

648 
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

649 
disˇrd_˘l
 = &
block_group
->
fs_öfo
->discard_ctl;

651 
	`lockdï_as£π_hñd
(&
˘l
->
åì_lock
);

652 
exã¡s_dñè
 = 
˘l
->
disˇrdabÀ_exã¡s
[
BTRFS_STAT_CURR
] -

653 
˘l
->
disˇrdabÀ_exã¡s
[
BTRFS_STAT_PREV
];

654 i‡(
exã¡s_dñè
) {

655 
	`©omic_add
(
exã¡s_dñè
, &
disˇrd_˘l
->
disˇrdabÀ_exã¡s
);

656 
˘l
->
disˇrdabÀ_exã¡s
[
BTRFS_STAT_PREV
] =

657 
˘l
->
disˇrdabÀ_exã¡s
[
BTRFS_STAT_CURR
];

660 
byãs_dñè
 = 
˘l
->
disˇrdabÀ_byãs
[
BTRFS_STAT_CURR
] -

661 
˘l
->
disˇrdabÀ_byãs
[
BTRFS_STAT_PREV
];

662 i‡(
byãs_dñè
) {

663 
	`©omic64_add
(
byãs_dñè
, &
disˇrd_˘l
->
disˇrdabÀ_byãs
);

664 
˘l
->
disˇrdabÀ_byãs
[
BTRFS_STAT_PREV
] =

665 
˘l
->
disˇrdabÀ_byãs
[
BTRFS_STAT_CURR
];

667 
	}
}

680 
	$båfs_disˇrd_pu¡_unu£d_bgs_li°
(
båfs_fs_öfo
 *
fs_öfo
)

682 
båfs_block_group
 *
block_group
, *
√xt
;

684 
	`•ö_lock
(&
fs_öfo
->
unu£d_bgs_lock
);

686 
	`li°_f‹_óch_íåy_ß„
(
block_group
, 
√xt
, &
fs_öfo
->
unu£d_bgs
,

687 
bg_li°
) {

688 
	`li°_dñ_öô
(&
block_group
->
bg_li°
);

689 
	`båfs_disˇrd_queue_w‹k
(&
fs_öfo
->
disˇrd_˘l
, 
block_group
);

694 
	`båfs_put_block_group
(
block_group
);

696 
	`•ö_u∆ock
(&
fs_öfo
->
unu£d_bgs_lock
);

697 
	}
}

710 
	$båfs_disˇrd_purge_li°
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
)

712 
båfs_block_group
 *
block_group
, *
√xt
;

713 
i
;

715 
	`•ö_lock
(&
disˇrd_˘l
->
lock
);

716 
i
 = 0; i < 
BTRFS_NR_DISCARD_LISTS
; i++) {

717 
	`li°_f‹_óch_íåy_ß„
(
block_group
, 
√xt
,

718 &
disˇrd_˘l
->
disˇrd_li°
[
i
],

719 
disˇrd_li°
) {

720 
	`li°_dñ_öô
(&
block_group
->
disˇrd_li°
);

721 
	`•ö_u∆ock
(&
disˇrd_˘l
->
lock
);

722 i‡(
block_group
->
u£d
 == 0)

723 
	`båfs_m¨k_bg_unu£d
(
block_group
);

724 
	`•ö_lock
(&
disˇrd_˘l
->
lock
);

725 
	`båfs_put_block_group
(
block_group
);

728 
	`•ö_u∆ock
(&
disˇrd_˘l
->
lock
);

729 
	}
}

731 
	$båfs_disˇrd_ªsume
(
båfs_fs_öfo
 *
fs_öfo
)

733 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
DISCARD_ASYNC
)) {

734 
	`båfs_disˇrd_˛ónup
(
fs_öfo
);

738 
	`båfs_disˇrd_pu¡_unu£d_bgs_li°
(
fs_öfo
);

740 
	`£t_bô
(
BTRFS_FS_DISCARD_RUNNING
, &
fs_öfo
->
Êags
);

741 
	}
}

743 
	$båfs_disˇrd_°›
(
båfs_fs_öfo
 *
fs_öfo
)

745 
	`˛ór_bô
(
BTRFS_FS_DISCARD_RUNNING
, &
fs_öfo
->
Êags
);

746 
	}
}

748 
	$båfs_disˇrd_öô
(
båfs_fs_öfo
 *
fs_öfo
)

750 
båfs_disˇrd_˘l
 *
disˇrd_˘l
 = &
fs_öfo
->discard_ctl;

751 
i
;

753 
	`•ö_lock_öô
(&
disˇrd_˘l
->
lock
);

754 
	`INIT_DELAYED_WORK
(&
disˇrd_˘l
->
w‹k
, 
båfs_disˇrd_w‹k‚
);

756 
i
 = 0; i < 
BTRFS_NR_DISCARD_LISTS
; i++)

757 
	`INIT_LIST_HEAD
(&
disˇrd_˘l
->
disˇrd_li°
[
i
]);

759 
disˇrd_˘l
->
¥ev_disˇrd
 = 0;

760 
disˇrd_˘l
->
¥ev_disˇrd_time
 = 0;

761 
	`©omic_£t
(&
disˇrd_˘l
->
disˇrdabÀ_exã¡s
, 0);

762 
	`©omic64_£t
(&
disˇrd_˘l
->
disˇrdabÀ_byãs
, 0);

763 
disˇrd_˘l
->
max_disˇrd_size
 = 
BTRFS_ASYNC_DISCARD_DEFAULT_MAX_SIZE
;

764 
disˇrd_˘l
->
dñay_ms
 = 
BTRFS_DISCARD_MAX_DELAY_MSEC
;

765 
disˇrd_˘l
->
i›s_limô
 = 
BTRFS_DISCARD_MAX_IOPS
;

766 
disˇrd_˘l
->
kbps_limô
 = 0;

767 
disˇrd_˘l
->
disˇrd_exã¡_byãs
 = 0;

768 
disˇrd_˘l
->
disˇrd_bôm≠_byãs
 = 0;

769 
	`©omic64_£t
(&
disˇrd_˘l
->
disˇrd_byãs_ßved
, 0);

770 
	}
}

772 
	$båfs_disˇrd_˛ónup
(
båfs_fs_öfo
 *
fs_öfo
)

774 
	`båfs_disˇrd_°›
(
fs_öfo
);

775 
	`ˇn˚l_dñayed_w‹k_sync
(&
fs_öfo
->
disˇrd_˘l
.
w‹k
);

776 
	`båfs_disˇrd_purge_li°
(&
fs_öfo
->
disˇrd_˘l
);

777 
	}
}

	@discard.h

3 #i‚de‡
BTRFS_DISCARD_H


4 
	#BTRFS_DISCARD_H


	)

6 
	~<löux/sizes.h
>

8 
	gbåfs_fs_öfo
;

9 
	gbåfs_disˇrd_˘l
;

10 
	gbåfs_block_group
;

13 
	#BTRFS_ASYNC_DISCARD_DEFAULT_MAX_SIZE
 (
SZ_64M
)

	)

14 
	#BTRFS_ASYNC_DISCARD_MAX_FILTER
 (
SZ_1M
)

	)

15 
	#BTRFS_ASYNC_DISCARD_MIN_FILTER
 (
SZ_32K
)

	)

18 
båfs_disˇrd_check_fûãr
(
båfs_block_group
 *
block_group
, 
u64
 
byãs
);

21 
båfs_disˇrd_ˇn˚l_w‹k
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
,

22 
båfs_block_group
 *
block_group
);

23 
båfs_disˇrd_queue_w‹k
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
,

24 
båfs_block_group
 *
block_group
);

25 
båfs_disˇrd_scheduÀ_w‹k
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
,

26 
boﬁ
 
ovîride
);

29 
båfs_disˇrd_ˇlc_dñay
(
båfs_disˇrd_˘l
 *
disˇrd_˘l
);

30 
båfs_disˇrd_upd©e_disˇrdabÀ
(
båfs_block_group
 *
block_group
);

33 
båfs_disˇrd_pu¡_unu£d_bgs_li°
(
båfs_fs_öfo
 *
fs_öfo
);

34 
båfs_disˇrd_ªsume
(
båfs_fs_öfo
 *
fs_öfo
);

35 
båfs_disˇrd_°›
(
båfs_fs_öfo
 *
fs_öfo
);

36 
båfs_disˇrd_öô
(
båfs_fs_öfo
 *
fs_öfo
);

37 
båfs_disˇrd_˛ónup
(
båfs_fs_öfo
 *
fs_öfo
);

	@disk-io.c

6 
	~<löux/fs.h
>

7 
	~<löux/blkdev.h
>

8 
	~<löux/ødix-åì.h
>

9 
	~<löux/wrôeback.h
>

10 
	~<löux/w‹kqueue.h
>

11 
	~<löux/kthªad.h
>

12 
	~<löux/¶ab.h
>

13 
	~<löux/migøã.h
>

14 
	~<löux/øãlimô.h
>

15 
	~<löux/uuid.h
>

16 
	~<löux/£m≠h‹e.h
>

17 
	~<löux/îr‹-öje˘i⁄.h
>

18 
	~<löux/¸c32c.h
>

19 
	~<löux/sched/mm.h
>

20 
	~<asm/u«lig√d.h
>

21 
	~<¸y±o/hash.h
>

22 
	~"˘ªe.h
"

23 
	~"disk-io.h
"

24 
	~"å™ß˘i⁄.h
"

25 
	~"båfs_öode.h
"

26 
	~"bio.h
"

27 
	~"¥öt-åì.h
"

28 
	~"lockög.h
"

29 
	~"åì-log.h
"

30 
	~"‰ì-•a˚-ˇche.h
"

31 
	~"‰ì-•a˚-åì.h
"

32 
	~"check-öãgrôy.h
"

33 
	~"rcu-°rög.h
"

34 
	~"dev-ª∂a˚.h
"

35 
	~"øid56.h
"

36 
	~"sysfs.h
"

37 
	~"qgroup.h
"

38 
	~"com¥essi⁄.h
"

39 
	~"åì-checkî.h
"

40 
	~"ªf-vîify.h
"

41 
	~"block-group.h
"

42 
	~"disˇrd.h
"

43 
	~"•a˚-öfo.h
"

44 
	~"z⁄ed.h
"

45 
	~"sub∑ge.h
"

46 
	~"fs.h
"

47 
	~"ac˚ss‹s.h
"

48 
	~"exã¡-åì.h
"

49 
	~"roŸ-åì.h
"

50 
	~"de‰ag.h
"

51 
	~"uuid-åì.h
"

52 
	~"ªloˇti⁄.h
"

53 
	~"s¸ub.h
"

54 
	~"su≥r.h
"

56 
	#BTRFS_SUPER_FLAG_SUPP
 (
BTRFS_HEADER_FLAG_WRITTEN
 |\

57 
BTRFS_HEADER_FLAG_RELOC
 |\

58 
BTRFS_SUPER_FLAG_ERROR
 |\

59 
BTRFS_SUPER_FLAG_SEEDING
 |\

60 
BTRFS_SUPER_FLAG_METADUMP
 |\

61 
BTRFS_SUPER_FLAG_METADUMP_V2
)

	)

63 
båfs_˛ónup_å™ß˘i⁄
(
båfs_fs_öfo
 *
fs_öfo
);

64 
båfs_îr‹_commô_su≥r
(
båfs_fs_öfo
 *
fs_öfo
);

66 
	$båfs_‰ì_csum_hash
(
båfs_fs_öfo
 *
fs_öfo
)

68 i‡(
fs_öfo
->
csum_shash
)

69 
	`¸y±o_‰ì_shash
(
fs_öfo
->
csum_shash
);

70 
	}
}

75 
	$csum_åì_block
(
exã¡_buf„r
 *
buf
, 
u8
 *
ªsu…
)

77 
båfs_fs_öfo
 *
fs_öfo
 = 
buf
->fs_info;

78 c⁄° 
num_∑ges
 = 
	`num_exã¡_∑ges
(
buf
);

79 c⁄° 
fú°_∑ge_∑π
 = 
	`mö_t
(
u32
, 
PAGE_SIZE
, 
fs_öfo
->
nodesize
);

80 
	`SHASH_DESC_ON_STACK
(
shash
, 
fs_öfo
->
csum_shash
);

81 *
kaddr
;

82 
i
;

84 
shash
->
tfm
 = 
fs_öfo
->
csum_shash
;

85 
	`¸y±o_shash_öô
(
shash
);

86 
kaddr
 = 
	`∑ge_addªss
(
buf
->
∑ges
[0]Ë+ 
	`off£t_ö_∑ge
(buf->
°¨t
);

87 
	`¸y±o_shash_upd©e
(
shash
, 
kaddr
 + 
BTRFS_CSUM_SIZE
,

88 
fú°_∑ge_∑π
 - 
BTRFS_CSUM_SIZE
);

90 
i
 = 1; i < 
num_∑ges
 && 
INLINE_EXTENT_BUFFER_PAGES
 > 1; i++) {

91 
kaddr
 = 
	`∑ge_addªss
(
buf
->
∑ges
[
i
]);

92 
	`¸y±o_shash_upd©e
(
shash
, 
kaddr
, 
PAGE_SIZE
);

94 
	`mem£t
(
ªsu…
, 0, 
BTRFS_CSUM_SIZE
);

95 
	`¸y±o_shash_föÆ
(
shash
, 
ªsu…
);

96 
	}
}

104 
	$båfs_buf„r_u±od©e
(
exã¡_buf„r
 *
eb
, 
u64
 
∑ª¡_å™sid
, 
©omic
)

106 i‡(!
	`exã¡_buf„r_u±od©e
(
eb
))

109 i‡(!
∑ª¡_å™sid
 || 
	`båfs_hódî_gíî©i⁄
(
eb
) ==Öarent_transid)

112 i‡(
©omic
)

113  -
EAGAIN
;

115 i‡(!
	`exã¡_buf„r_u±od©e
(
eb
) ||

116 
	`båfs_hódî_gíî©i⁄
(
eb
Ë!
∑ª¡_å™sid
) {

117 
	`båfs_îr_æ
(
eb
->
fs_öfo
,

119 
eb
->
°¨t
,Éb->
ªad_múr‹
,

120 
∑ª¡_å™sid
, 
	`båfs_hódî_gíî©i⁄
(
eb
));

121 
	`˛ór_exã¡_buf„r_u±od©e
(
eb
);

125 
	}
}

127 
boﬁ
 
	$båfs_suµ‹ãd_su≥r_csum
(
u16
 
csum_ty≥
)

129 
csum_ty≥
) {

130 
BTRFS_CSUM_TYPE_CRC32
:

131 
BTRFS_CSUM_TYPE_XXHASH
:

132 
BTRFS_CSUM_TYPE_SHA256
:

133 
BTRFS_CSUM_TYPE_BLAKE2
:

134  
åue
;

136  
Ál£
;

138 
	}
}

144 
	$båfs_check_su≥r_csum
(
båfs_fs_öfo
 *
fs_öfo
,

145 c⁄° 
båfs_su≥r_block
 *
disk_sb
)

147 
ªsu…
[
BTRFS_CSUM_SIZE
];

148 
	`SHASH_DESC_ON_STACK
(
shash
, 
fs_öfo
->
csum_shash
);

150 
shash
->
tfm
 = 
fs_öfo
->
csum_shash
;

157 
	`¸y±o_shash_dige°
(
shash
, (c⁄° 
u8
 *)
disk_sb
 + 
BTRFS_CSUM_SIZE
,

158 
BTRFS_SUPER_INFO_SIZE
 - 
BTRFS_CSUM_SIZE
, 
ªsu…
);

160 i‡(
	`memcmp
(
disk_sb
->
csum
, 
ªsu…
, 
fs_öfo
->
csum_size
))

164 
	}
}

166 
	$båfs_ª∑ú_eb_io_Áûuª
(c⁄° 
exã¡_buf„r
 *
eb
,

167 
múr‹_num
)

169 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

170 
i
, 
num_∑ges
 = 
	`num_exã¡_∑ges
(
eb
);

171 
ªt
 = 0;

173 i‡(
	`sb_rd⁄ly
(
fs_öfo
->
sb
))

174  -
EROFS
;

176 
i
 = 0; i < 
num_∑ges
; i++) {

177 
∑ge
 *
p
 = 
eb
->
∑ges
[
i
];

178 
u64
 
°¨t
 = 
	`max_t
(u64, 
eb
->°¨t, 
	`∑ge_off£t
(
p
));

179 
u64
 
íd
 = 
	`mö_t
(u64, 
eb
->
°¨t
 +Éb->
Àn
, 
	`∑ge_off£t
(
p
Ë+ 
PAGE_SIZE
);

180 
u32
 
Àn
 = 
íd
 - 
°¨t
;

182 
ªt
 = 
	`båfs_ª∑ú_io_Áûuª
(
fs_öfo
, 0, 
°¨t
, 
Àn
,

183 
°¨t
, 
p
, 
	`off£t_ö_∑ge
(°¨t), 
múr‹_num
);

184 i‡(
ªt
)

188  
ªt
;

189 
	}
}

198 
	$båfs_ªad_exã¡_buf„r
(
exã¡_buf„r
 *
eb
,

199 
båfs_åì_∑ª¡_check
 *
check
)

201 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

202 
Áûed
 = 0;

203 
ªt
;

204 
num_c›õs
 = 0;

205 
múr‹_num
 = 0;

206 
Áûed_múr‹
 = 0;

208 
	`ASSERT
(
check
);

211 
	`˛ór_bô
(
EXTENT_BUFFER_CORRUPT
, &
eb
->
bÊags
);

212 
ªt
 = 
	`ªad_exã¡_buf„r_∑ges
(
eb
, 
WAIT_COMPLETE
, 
múr‹_num
, 
check
);

213 i‡(!
ªt
)

216 
num_c›õs
 = 
	`båfs_num_c›õs
(
fs_öfo
,

217 
eb
->
°¨t
,Éb->
Àn
);

218 i‡(
num_c›õs
 == 1)

221 i‡(!
Áûed_múr‹
) {

222 
Áûed
 = 1;

223 
Áûed_múr‹
 = 
eb
->
ªad_múr‹
;

226 
múr‹_num
++;

227 i‡(
múr‹_num
 =
Áûed_múr‹
)

228 
múr‹_num
++;

230 i‡(
múr‹_num
 > 
num_c›õs
)

234 i‡(
Áûed
 && !
ªt
 && 
Áûed_múr‹
)

235 
	`båfs_ª∑ú_eb_io_Áûuª
(
eb
, 
Áûed_múr‹
);

237  
ªt
;

238 
	}
}

243 
blk_°©us_t
 
	$båì_csum_⁄e_bio
(
båfs_bio
 *
bbio
)

245 
exã¡_buf„r
 *
eb
 = 
bbio
->
¥iv©e
;

246 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

247 
u64
 
found_°¨t
 = 
	`båfs_hódî_byãƒ
(
eb
);

248 
u8
 
ªsu…
[
BTRFS_CSUM_SIZE
];

249 
ªt
;

252 i‡(
	`WARN_ON_ONCE
(
bbio
->
fûe_off£t
 !
eb
->
°¨t
))

253  
BLK_STS_IOERR
;

254 i‡(
	`WARN_ON_ONCE
(
bbio
->
bio
.
bi_ôî
.
bi_size
 !
eb
->
Àn
))

255  
BLK_STS_IOERR
;

257 i‡(
	`ã°_bô
(
EXTENT_BUFFER_NO_CHECK
, &
eb
->
bÊags
)) {

258 
	`WARN_ON_ONCE
(
found_°¨t
 != 0);

259  
BLK_STS_OK
;

262 i‡(
	`WARN_ON_ONCE
(
found_°¨t
 !
eb
->
°¨t
))

263  
BLK_STS_IOERR
;

264 i‡(
	`WARN_ON
(!
	`båfs_∑ge_ã°_u±od©e
(
fs_öfo
, 
eb
->
∑ges
[0],Éb->
°¨t
,

265 
eb
->
Àn
)))

266  
BLK_STS_IOERR
;

268 
	`ASSERT
(
	`memcmp_exã¡_buf„r
(
eb
, 
fs_öfo
->
fs_devi˚s
->
mëad©a_uuid
,

269 
	`off£tof
(
båfs_hódî
, 
fsid
),

270 
BTRFS_FSID_SIZE
) == 0);

271 
	`csum_åì_block
(
eb
, 
ªsu…
);

273 i‡(
	`båfs_hódî_Àvñ
(
eb
))

274 
ªt
 = 
	`båfs_check_node
(
eb
);

276 
ªt
 = 
	`båfs_check_Àaf
(
eb
);

278 i‡(
ªt
 < 0)

279 
îr‹
;

285 i‡(
	`u∆ikñy
(
	`båfs_hódî_gíî©i⁄
(
eb
Ë<
fs_öfo
->
œ°_å™s_commôãd
)) {

286 
ªt
 = -
EUCLEAN
;

287 
	`båfs_îr
(
fs_öfo
,

289 
eb
->
°¨t
, 
	`båfs_hódî_gíî©i⁄
(eb),

290 
fs_öfo
->
œ°_å™s_commôãd
);

291 
îr‹
;

293 
	`wrôe_exã¡_buf„r
(
eb
, 
ªsu…
, 0, 
fs_öfo
->
csum_size
);

294  
BLK_STS_OK
;

296 
îr‹
:

297 
	`båfs_¥öt_åì
(
eb
, 0);

298 
	`båfs_îr
(
fs_öfo
, "block=%llu writeÅimeÅree block corruption detected",

299 
eb
->
°¨t
);

306 
	`WARN_ON
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
) ||

307 
	`båfs_hódî_ow√r
(
eb
Ë=
BTRFS_TREE_LOG_OBJECTID
);

308  
	`î∫o_to_blk_°©us
(
ªt
);

309 
	}
}

311 
boﬁ
 
	$check_åì_block_fsid
(
exã¡_buf„r
 *
eb
)

313 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

314 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devi˚s, *
£ed_devs
;

315 
u8
 
fsid
[
BTRFS_FSID_SIZE
];

317 
	`ªad_exã¡_buf„r
(
eb
, 
fsid
, 
	`off£tof
(
båfs_hódî
, fsid),

318 
BTRFS_FSID_SIZE
);

325 i‡(
	`memcmp
(
fsid
, 
fs_öfo
->
fs_devi˚s
->
mëad©a_uuid
, 
BTRFS_FSID_SIZE
) == 0)

326  
Ál£
;

328 
	`li°_f‹_óch_íåy
(
£ed_devs
, &
fs_devi˚s
->
£ed_li°
, seed_list)

329 i‡(!
	`memcmp
(
fsid
, 
£ed_devs
->fsid, 
BTRFS_FSID_SIZE
))

330  
Ál£
;

332  
åue
;

333 
	}
}

336 
	$båfs_vÆid©e_exã¡_buf„r
(
exã¡_buf„r
 *
eb
,

337 
båfs_åì_∑ª¡_check
 *
check
)

339 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

340 
u64
 
found_°¨t
;

341 c⁄° 
u32
 
csum_size
 = 
fs_öfo
->csum_size;

342 
u8
 
found_Àvñ
;

343 
u8
 
ªsu…
[
BTRFS_CSUM_SIZE
];

344 c⁄° 
u8
 *
hódî_csum
;

345 
ªt
 = 0;

347 
	`ASSERT
(
check
);

349 
found_°¨t
 = 
	`båfs_hódî_byãƒ
(
eb
);

350 i‡(
found_°¨t
 !
eb
->
°¨t
) {

351 
	`båfs_îr_æ
(
fs_öfo
,

353 
eb
->
ªad_múr‹
,Éb->
°¨t
, 
found_°¨t
);

354 
ªt
 = -
EIO
;

355 
out
;

357 i‡(
	`check_åì_block_fsid
(
eb
)) {

358 
	`båfs_îr_æ
(
fs_öfo
, "bad fsid onÜogical %llu mirror %u",

359 
eb
->
°¨t
,Éb->
ªad_múr‹
);

360 
ªt
 = -
EIO
;

361 
out
;

363 
found_Àvñ
 = 
	`båfs_hódî_Àvñ
(
eb
);

364 i‡(
found_Àvñ
 >
BTRFS_MAX_LEVEL
) {

365 
	`båfs_îr
(
fs_öfo
,

367 
eb
->
ªad_múr‹
, 
	`båfs_hódî_Àvñ
”b),Éb->
°¨t
);

368 
ªt
 = -
EIO
;

369 
out
;

372 
	`csum_åì_block
(
eb
, 
ªsu…
);

373 
hódî_csum
 = 
	`∑ge_addªss
(
eb
->
∑ges
[0]) +

374 
	`gë_eb_off£t_ö_∑ge
(
eb
, 
	`off£tof
(
båfs_hódî
, 
csum
));

376 i‡(
	`memcmp
(
ªsu…
, 
hódî_csum
, 
csum_size
) != 0) {

377 
	`båfs_w¨n_æ
(
fs_öfo
,

378 "checksum vîify faûed o¿logiˇ»%Œu múr‹ %u w™ãd " 
CSUM_FMT
 " found " CSUM_FMT "Üevel %d",

379 
eb
->
°¨t
,Éb->
ªad_múr‹
,

380 
	`CSUM_FMT_VALUE
(
csum_size
, 
hódî_csum
),

381 
	`CSUM_FMT_VALUE
(
csum_size
, 
ªsu…
),

382 
	`båfs_hódî_Àvñ
(
eb
));

383 
ªt
 = -
EUCLEAN
;

384 
out
;

387 i‡(
found_Àvñ
 !
check
->
Àvñ
) {

388 
	`båfs_îr
(
fs_öfo
,

390 
eb
->
°¨t
,Éb->
ªad_múr‹
, 
check
->
Àvñ
, 
found_Àvñ
);

391 
ªt
 = -
EIO
;

392 
out
;

394 i‡(
	`u∆ikñy
(
check
->
å™sid
 &&

395 
	`båfs_hódî_gíî©i⁄
(
eb
Ë!
check
->
å™sid
)) {

396 
	`båfs_îr_æ
(
eb
->
fs_öfo
,

398 
eb
->
°¨t
,Éb->
ªad_múr‹
, 
check
->
å™sid
,

399 
	`båfs_hódî_gíî©i⁄
(
eb
));

400 
ªt
 = -
EIO
;

401 
out
;

403 i‡(
check
->
has_fú°_key
) {

404 
båfs_key
 *
ex≥˘_key
 = &
check
->
fú°_key
;

405 
båfs_key
 
found_key
;

407 i‡(
found_Àvñ
)

408 
	`båfs_node_key_to_˝u
(
eb
, &
found_key
, 0);

410 
	`båfs_ôem_key_to_˝u
(
eb
, &
found_key
, 0);

411 i‡(
	`u∆ikñy
(
	`båfs_comp_˝u_keys
(
ex≥˘_key
, &
found_key
))) {

412 
	`båfs_îr
(
fs_öfo
,

414 
eb
->
°¨t
, 
check
->
å™sid
,

415 
ex≥˘_key
->
obje˘id
,

416 
ex≥˘_key
->
ty≥
,Éx≥˘_key->
off£t
,

417 
found_key
.
obje˘id
, found_key.
ty≥
,

418 
found_key
.
off£t
);

419 
ªt
 = -
EUCLEAN
;

420 
out
;

423 i‡(
check
->
ow√r_roŸ
) {

424 
ªt
 = 
	`båfs_check_eb_ow√r
(
eb
, 
check
->
ow√r_roŸ
);

425 i‡(
ªt
 < 0)

426 
out
;

434 i‡(
found_Àvñ
 =0 && 
	`båfs_check_Àaf
(
eb
)) {

435 
	`£t_bô
(
EXTENT_BUFFER_CORRUPT
, &
eb
->
bÊags
);

436 
ªt
 = -
EIO
;

439 i‡(
found_Àvñ
 > 0 && 
	`båfs_check_node
(
eb
))

440 
ªt
 = -
EIO
;

442 i‡(
ªt
)

443 
	`båfs_îr
(
fs_öfo
,

445 
eb
->
°¨t
,Éb->
ªad_múr‹
);

446 
out
:

447  
ªt
;

448 
	}
}

450 #ifde‡
CONFIG_MIGRATION


451 
	$båì_migøã_fﬁio
(
addªss_•a˚
 *
m≠pög
,

452 
fﬁio
 *
d°
, fﬁiÿ*
§c
, 
migøã_mode
 
mode
)

458 i‡(
	`fﬁio_ã°_dúty
(
§c
))

459  -
EAGAIN
;

464 i‡(
	`fﬁio_gë_¥iv©e
(
§c
) &&

465 !
	`fûem≠_ªÀa£_fﬁio
(
§c
, 
GFP_KERNEL
))

466  -
EAGAIN
;

467  
	`migøã_fﬁio
(
m≠pög
, 
d°
, 
§c
, 
mode
);

468 
	}
}

470 
	#båì_migøã_fﬁio
 
NULL


	)

473 
	$båì_wrôïages
(
addªss_•a˚
 *
m≠pög
,

474 
wrôeback_c⁄åﬁ
 *
wbc
)

476 
båfs_fs_öfo
 *
fs_öfo
;

477 
ªt
;

479 i‡(
wbc
->
sync_mode
 =
WB_SYNC_NONE
) {

481 i‡(
wbc
->
f‹_kupd©e
)

484 
fs_öfo
 = 
	`BTRFS_I
(
m≠pög
->
ho°
)->
roŸ
->fs_info;

486 
ªt
 = 
	`__≥r˝u_cou¡î_com∑ª
(&
fs_öfo
->
dúty_mëad©a_byãs
,

487 
BTRFS_DIRTY_METADATA_THRESH
,

488 
fs_öfo
->
dúty_mëad©a_b©ch
);

489 i‡(
ªt
 < 0)

492  
	`båì_wrôe_ˇche_∑ges
(
m≠pög
, 
wbc
);

493 
	}
}

495 
boﬁ
 
	$båì_ªÀa£_fﬁio
(
fﬁio
 *fﬁio, 
gÂ_t
 
gÂ_Êags
)

497 i‡(
	`fﬁio_ã°_wrôeback
(
fﬁio
Ë|| 
	`fﬁio_ã°_dúty
(folio))

498  
Ál£
;

500  
	`åy_ªÀa£_exã¡_buf„r
(&
fﬁio
->
∑ge
);

501 
	}
}

503 
	$båì_övÆid©e_fﬁio
(
fﬁio
 *fﬁio, 
size_t
 
off£t
,

504 
size_t
 
Àngth
)

506 
exã¡_io_åì
 *
åì
;

507 
åì
 = &
	`BTRFS_I
(
fﬁio
->
m≠pög
->
ho°
)->
io_åì
;

508 
	`exã¡_övÆid©e_fﬁio
(
åì
, 
fﬁio
, 
off£t
);

509 
	`båì_ªÀa£_fﬁio
(
fﬁio
, 
GFP_NOFS
);

510 i‡(
	`fﬁio_gë_¥iv©e
(
fﬁio
)) {

511 
	`båfs_w¨n
(
	`BTRFS_I
(
fﬁio
->
m≠pög
->
ho°
)->
roŸ
->
fs_öfo
,

513 ()
	`fﬁio_pos
(
fﬁio
));

514 
	`fﬁio_dëach_¥iv©e
(
fﬁio
);

516 
	}
}

518 #ifde‡
DEBUG


519 
boﬁ
 
	$båì_dúty_fﬁio
(
addªss_•a˚
 *
m≠pög
,

520 
fﬁio
 *folio)

522 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
m≠pög
->
ho°
->
i_sb
);

523 
båfs_sub∑ge_öfo
 *
•i
 = 
fs_öfo
->
sub∑ge_öfo
;

524 
båfs_sub∑ge
 *
sub∑ge
;

525 
exã¡_buf„r
 *
eb
;

526 
cur_bô
 = 0;

527 
u64
 
∑ge_°¨t
 = 
	`fﬁio_pos
(
fﬁio
);

529 i‡(
fs_öfo
->
£˘‹size
 =
PAGE_SIZE
) {

530 
eb
 = 
	`fﬁio_gë_¥iv©e
(
fﬁio
);

531 
	`BUG_ON
(!
eb
);

532 
	`BUG_ON
(!
	`ã°_bô
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bÊags
));

533 
	`BUG_ON
(!
	`©omic_ªad
(&
eb
->
ªfs
));

534 
	`båfs_as£π_åì_wrôe_locked
(
eb
);

535  
	`fûem≠_dúty_fﬁio
(
m≠pög
, 
fﬁio
);

538 
	`ASSERT
(
•i
);

539 
sub∑ge
 = 
	`fﬁio_gë_¥iv©e
(
fﬁio
);

541 
cur_bô
 = 
•i
->
dúty_off£t
;

542 
cur_bô
 < 
•i
->
dúty_off£t
 + spi->
bôm≠_ƒ_bôs
;

543 
cur_bô
++) {

544 
Êags
;

545 
u64
 
cur
;

547 
	`•ö_lock_úqßve
(&
sub∑ge
->
lock
, 
Êags
);

548 i‡(!
	`ã°_bô
(
cur_bô
, 
sub∑ge
->
bôm≠s
)) {

549 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
);

552 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
);

553 
cur
 = 
∑ge_°¨t
 + 
cur_bô
 * 
fs_öfo
->
£˘‹size
;

555 
eb
 = 
	`föd_exã¡_buf„r
(
fs_öfo
, 
cur
);

556 
	`ASSERT
(
eb
);

557 
	`ASSERT
(
	`ã°_bô
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bÊags
));

558 
	`ASSERT
(
	`©omic_ªad
(&
eb
->
ªfs
));

559 
	`båfs_as£π_åì_wrôe_locked
(
eb
);

560 
	`‰ì_exã¡_buf„r
(
eb
);

562 
cur_bô
 +(
fs_öfo
->
nodesize
 >> fs_öfo->
£˘‹size_bôs
) - 1;

564  
	`fûem≠_dúty_fﬁio
(
m≠pög
, 
fﬁio
);

565 
	}
}

567 
	#båì_dúty_fﬁio
 
fûem≠_dúty_fﬁio


	)

570 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gbåì_a›s
 = {

571 .
wrôïages
 = 
båì_wrôïages
,

572 .
	gªÀa£_fﬁio
 = 
båì_ªÀa£_fﬁio
,

573 .
	gövÆid©e_fﬁio
 = 
båì_övÆid©e_fﬁio
,

574 .
	gmigøã_fﬁio
 = 
båì_migøã_fﬁio
,

575 .
	gdúty_fﬁio
 = 
båì_dúty_fﬁio
,

578 
exã¡_buf„r
 *
	$båfs_föd_¸óã_åì_block
(

579 
båfs_fs_öfo
 *
fs_öfo
,

580 
u64
 
byãƒ
, u64 
ow√r_roŸ
,

581 
Àvñ
)

583 i‡(
	`båfs_is_ã°ög
(
fs_öfo
))

584  
	`Æloc_ã°_exã¡_buf„r
(
fs_öfo
, 
byãƒ
);

585  
	`Æloc_exã¡_buf„r
(
fs_öfo
, 
byãƒ
, 
ow√r_roŸ
, 
Àvñ
);

586 
	}
}

595 
exã¡_buf„r
 *
	$ªad_åì_block
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
byãƒ
,

596 
båfs_åì_∑ª¡_check
 *
check
)

598 
exã¡_buf„r
 *
buf
 = 
NULL
;

599 
ªt
;

601 
	`ASSERT
(
check
);

603 
buf
 = 
	`båfs_föd_¸óã_åì_block
(
fs_öfo
, 
byãƒ
, 
check
->
ow√r_roŸ
,

604 
check
->
Àvñ
);

605 i‡(
	`IS_ERR
(
buf
))

606  
buf
;

608 
ªt
 = 
	`båfs_ªad_exã¡_buf„r
(
buf
, 
check
);

609 i‡(
ªt
) {

610 
	`‰ì_exã¡_buf„r_°Æe
(
buf
);

611  
	`ERR_PTR
(
ªt
);

613 i‡(
	`båfs_check_eb_ow√r
(
buf
, 
check
->
ow√r_roŸ
)) {

614 
	`‰ì_exã¡_buf„r_°Æe
(
buf
);

615  
	`ERR_PTR
(-
EUCLEAN
);

617  
buf
;

619 
	}
}

621 
	$__£tup_roŸ
(
båfs_roŸ
 *
roŸ
, 
båfs_fs_öfo
 *
fs_öfo
,

622 
u64
 
obje˘id
)

624 
boﬁ
 
dummy
 = 
	`ã°_bô
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_öfo
->
fs_°©e
);

626 
	`mem£t
(&
roŸ
->
roŸ_key
, 0, (root->root_key));

627 
	`mem£t
(&
roŸ
->
roŸ_ôem
, 0, (root->root_item));

628 
	`mem£t
(&
roŸ
->
de‰ag_¥ogªss
, 0, (root->defrag_progress));

629 
roŸ
->
fs_öfo
 = fs_info;

630 
roŸ
->
roŸ_key
.
obje˘id
 = objectid;

631 
roŸ
->
node
 = 
NULL
;

632 
roŸ
->
commô_roŸ
 = 
NULL
;

633 
roŸ
->
°©e
 = 0;

634 
	`RB_CLEAR_NODE
(&
roŸ
->
rb_node
);

636 
roŸ
->
œ°_å™s
 = 0;

637 
roŸ
->
‰ì_obje˘id
 = 0;

638 
roŸ
->
ƒ_dñÆloc_öodes
 = 0;

639 
roŸ
->
ƒ_‹dîed_exã¡s
 = 0;

640 
roŸ
->
öode_åì
 = 
RB_ROOT
;

641 
	`INIT_RADIX_TREE
(&
roŸ
->
dñayed_nodes_åì
, 
GFP_ATOMIC
);

643 
	`båfs_öô_roŸ_block_rsv
(
roŸ
);

645 
	`INIT_LIST_HEAD
(&
roŸ
->
dúty_li°
);

646 
	`INIT_LIST_HEAD
(&
roŸ
->
roŸ_li°
);

647 
	`INIT_LIST_HEAD
(&
roŸ
->
dñÆloc_öodes
);

648 
	`INIT_LIST_HEAD
(&
roŸ
->
dñÆloc_roŸ
);

649 
	`INIT_LIST_HEAD
(&
roŸ
->
‹dîed_exã¡s
);

650 
	`INIT_LIST_HEAD
(&
roŸ
->
‹dîed_roŸ
);

651 
	`INIT_LIST_HEAD
(&
roŸ
->
ªloc_dúty_li°
);

652 
	`INIT_LIST_HEAD
(&
roŸ
->
logged_li°
[0]);

653 
	`INIT_LIST_HEAD
(&
roŸ
->
logged_li°
[1]);

654 
	`•ö_lock_öô
(&
roŸ
->
öode_lock
);

655 
	`•ö_lock_öô
(&
roŸ
->
dñÆloc_lock
);

656 
	`•ö_lock_öô
(&
roŸ
->
‹dîed_exã¡_lock
);

657 
	`•ö_lock_öô
(&
roŸ
->
accou¡ög_lock
);

658 
	`•ö_lock_öô
(&
roŸ
->
log_exã¡s_lock
[0]);

659 
	`•ö_lock_öô
(&
roŸ
->
log_exã¡s_lock
[1]);

660 
	`•ö_lock_öô
(&
roŸ
->
qgroup_mëa_rsv_lock
);

661 
	`muãx_öô
(&
roŸ
->
obje˘id_muãx
);

662 
	`muãx_öô
(&
roŸ
->
log_muãx
);

663 
	`muãx_öô
(&
roŸ
->
‹dîed_exã¡_muãx
);

664 
	`muãx_öô
(&
roŸ
->
dñÆloc_muãx
);

665 
	`öô_waôqueue_hód
(&
roŸ
->
qgroup_Êush_waô
);

666 
	`öô_waôqueue_hód
(&
roŸ
->
log_wrôî_waô
);

667 
	`öô_waôqueue_hód
(&
roŸ
->
log_commô_waô
[0]);

668 
	`öô_waôqueue_hód
(&
roŸ
->
log_commô_waô
[1]);

669 
	`INIT_LIST_HEAD
(&
roŸ
->
log_˘xs
[0]);

670 
	`INIT_LIST_HEAD
(&
roŸ
->
log_˘xs
[1]);

671 
	`©omic_£t
(&
roŸ
->
log_commô
[0], 0);

672 
	`©omic_£t
(&
roŸ
->
log_commô
[1], 0);

673 
	`©omic_£t
(&
roŸ
->
log_wrôîs
, 0);

674 
	`©omic_£t
(&
roŸ
->
log_b©ch
, 0);

675 
	`ªfcou¡_£t
(&
roŸ
->
ªfs
, 1);

676 
	`©omic_£t
(&
roŸ
->
¢≠shŸ_f‹˚_cow
, 0);

677 
	`©omic_£t
(&
roŸ
->
ƒ_sw≠fûes
, 0);

678 
roŸ
->
log_å™sid
 = 0;

679 
roŸ
->
log_å™sid_commôãd
 = -1;

680 
roŸ
->
œ°_log_commô
 = 0;

681 
roŸ
->
™⁄_dev
 = 0;

682 i‡(!
dummy
) {

683 
	`exã¡_io_åì_öô
(
fs_öfo
, &
roŸ
->
dúty_log_∑ges
,

684 
IO_TREE_ROOT_DIRTY_LOG_PAGES
);

685 
	`exã¡_io_åì_öô
(
fs_öfo
, &
roŸ
->
log_csum_ønge
,

686 
IO_TREE_LOG_CSUM_RANGE
);

689 
	`•ö_lock_öô
(&
roŸ
->
roŸ_ôem_lock
);

690 
	`båfs_qgroup_öô_sw≠≥d_blocks
(&
roŸ
->
sw≠≥d_blocks
);

691 #ifde‡
CONFIG_BTRFS_DEBUG


692 
	`INIT_LIST_HEAD
(&
roŸ
->
Àak_li°
);

693 
	`•ö_lock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

694 
	`li°_add_èû
(&
roŸ
->
Àak_li°
, &
fs_öfo
->
Æloˇãd_roŸs
);

695 
	`•ö_u∆ock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

697 
	}
}

699 
båfs_roŸ
 *
	$båfs_Æloc_roŸ
(
båfs_fs_öfo
 *
fs_öfo
,

700 
u64
 
obje˘id
, 
gÂ_t
 
Êags
)

702 
båfs_roŸ
 *
roŸ
 = 
	`kzÆloc
((*roŸ), 
Êags
);

703 i‡(
roŸ
)

704 
	`__£tup_roŸ
(
roŸ
, 
fs_öfo
, 
obje˘id
);

705  
roŸ
;

706 
	}
}

708 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


710 
båfs_roŸ
 *
	$båfs_Æloc_dummy_roŸ
(
båfs_fs_öfo
 *
fs_öfo
)

712 
båfs_roŸ
 *
roŸ
;

714 i‡(!
fs_öfo
)

715  
	`ERR_PTR
(-
EINVAL
);

717 
roŸ
 = 
	`båfs_Æloc_roŸ
(
fs_öfo
, 
BTRFS_ROOT_TREE_OBJECTID
, 
GFP_KERNEL
);

718 i‡(!
roŸ
)

719  
	`ERR_PTR
(-
ENOMEM
);

722 
roŸ
->
Æloc_byãƒ
 = 0;

724  
roŸ
;

725 
	}
}

728 
	$globÆ_roŸ_cmp
(
rb_node
 *
a_node
, c⁄° rb_nodê*
b_node
)

730 c⁄° 
båfs_roŸ
 *
a
 = 
	`rb_íåy
(
a_node
, båfs_roŸ, 
rb_node
);

731 c⁄° 
båfs_roŸ
 *
b
 = 
	`rb_íåy
(
b_node
, båfs_roŸ, 
rb_node
);

733  
	`båfs_comp_˝u_keys
(&
a
->
roŸ_key
, &
b
->root_key);

734 
	}
}

736 
	$globÆ_roŸ_key_cmp
(c⁄° *
k
, c⁄° 
rb_node
 *
node
)

738 c⁄° 
båfs_key
 *
key
 = 
k
;

739 c⁄° 
båfs_roŸ
 *
roŸ
 = 
	`rb_íåy
(
node
, båfs_roŸ, 
rb_node
);

741  
	`båfs_comp_˝u_keys
(
key
, &
roŸ
->
roŸ_key
);

742 
	}
}

744 
	$båfs_globÆ_roŸ_ö£π
(
båfs_roŸ
 *
roŸ
)

746 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

747 
rb_node
 *
tmp
;

748 
ªt
 = 0;

750 
	`wrôe_lock
(&
fs_öfo
->
globÆ_roŸ_lock
);

751 
tmp
 = 
	`rb_föd_add
(&
roŸ
->
rb_node
, &
fs_öfo
->
globÆ_roŸ_åì
, 
globÆ_roŸ_cmp
);

752 
	`wrôe_u∆ock
(&
fs_öfo
->
globÆ_roŸ_lock
);

754 i‡(
tmp
) {

755 
ªt
 = -
EEXIST
;

756 
	`båfs_w¨n
(
fs_öfo
, "globalÑoot %llu %lluálreadyÉxists",

757 
roŸ
->
roŸ_key
.
obje˘id
,ÑoŸ->roŸ_key.
off£t
);

759  
ªt
;

760 
	}
}

762 
	$båfs_globÆ_roŸ_dñëe
(
båfs_roŸ
 *
roŸ
)

764 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

766 
	`wrôe_lock
(&
fs_öfo
->
globÆ_roŸ_lock
);

767 
	`rb_îa£
(&
roŸ
->
rb_node
, &
fs_öfo
->
globÆ_roŸ_åì
);

768 
	`wrôe_u∆ock
(&
fs_öfo
->
globÆ_roŸ_lock
);

769 
	}
}

771 
båfs_roŸ
 *
	$båfs_globÆ_roŸ
(
båfs_fs_öfo
 *
fs_öfo
,

772 
båfs_key
 *
key
)

774 
rb_node
 *
node
;

775 
båfs_roŸ
 *
roŸ
 = 
NULL
;

777 
	`ªad_lock
(&
fs_öfo
->
globÆ_roŸ_lock
);

778 
node
 = 
	`rb_föd
(
key
, &
fs_öfo
->
globÆ_roŸ_åì
, 
globÆ_roŸ_key_cmp
);

779 i‡(
node
)

780 
roŸ
 = 
	`c⁄èöî_of
(
node
, 
båfs_roŸ
, 
rb_node
);

781 
	`ªad_u∆ock
(&
fs_öfo
->
globÆ_roŸ_lock
);

783  
roŸ
;

784 
	}
}

786 
u64
 
	$båfs_globÆ_roŸ_id
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
byãƒ
)

788 
båfs_block_group
 *
block_group
;

789 
u64
 
ªt
;

791 i‡(!
	`båfs_fs_öcom∑t
(
fs_öfo
, 
EXTENT_TREE_V2
))

794 i‡(
byãƒ
)

795 
block_group
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
byãƒ
);

797 
block_group
 = 
	`båfs_lookup_fú°_block_group
(
fs_öfo
, 
byãƒ
);

798 
	`ASSERT
(
block_group
);

799 i‡(!
block_group
)

801 
ªt
 = 
block_group
->
globÆ_roŸ_id
;

802 
	`båfs_put_block_group
(
block_group
);

804  
ªt
;

805 
	}
}

807 
båfs_roŸ
 *
	$båfs_csum_roŸ
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
byãƒ
)

809 
båfs_key
 
key
 = {

810 .
obje˘id
 = 
BTRFS_CSUM_TREE_OBJECTID
,

811 .
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
,

812 .
off£t
 = 
	`båfs_globÆ_roŸ_id
(
fs_öfo
, 
byãƒ
),

815  
	`båfs_globÆ_roŸ
(
fs_öfo
, &
key
);

816 
	}
}

818 
båfs_roŸ
 *
	$båfs_exã¡_roŸ
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
byãƒ
)

820 
båfs_key
 
key
 = {

821 .
obje˘id
 = 
BTRFS_EXTENT_TREE_OBJECTID
,

822 .
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
,

823 .
off£t
 = 
	`båfs_globÆ_roŸ_id
(
fs_öfo
, 
byãƒ
),

826  
	`båfs_globÆ_roŸ
(
fs_öfo
, &
key
);

827 
	}
}

829 
båfs_roŸ
 *
	$båfs_block_group_roŸ
(
båfs_fs_öfo
 *
fs_öfo
)

831 i‡(
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
BLOCK_GROUP_TREE
))

832  
fs_öfo
->
block_group_roŸ
;

833  
	`båfs_exã¡_roŸ
(
fs_öfo
, 0);

834 
	}
}

836 
båfs_roŸ
 *
	$båfs_¸óã_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

837 
u64
 
obje˘id
)

839 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

840 
exã¡_buf„r
 *
Àaf
;

841 
båfs_roŸ
 *
åì_roŸ
 = 
fs_öfo
->tree_root;

842 
båfs_roŸ
 *
roŸ
;

843 
båfs_key
 
key
;

844 
nofs_Êag
;

845 
ªt
 = 0;

851 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

852 
roŸ
 = 
	`båfs_Æloc_roŸ
(
fs_öfo
, 
obje˘id
, 
GFP_KERNEL
);

853 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

854 i‡(!
roŸ
)

855  
	`ERR_PTR
(-
ENOMEM
);

857 
roŸ
->
roŸ_key
.
obje˘id
 = objectid;

858 
roŸ
->
roŸ_key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

859 
roŸ
->
roŸ_key
.
off£t
 = 0;

861 
Àaf
 = 
	`båfs_Æloc_åì_block
(
å™s
, 
roŸ
, 0, 
obje˘id
, 
NULL
, 0, 0, 0,

862 
BTRFS_NESTING_NORMAL
);

863 i‡(
	`IS_ERR
(
Àaf
)) {

864 
ªt
 = 
	`PTR_ERR
(
Àaf
);

865 
Àaf
 = 
NULL
;

866 
Áû
;

869 
roŸ
->
node
 = 
Àaf
;

870 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

872 
roŸ
->
commô_roŸ
 = 
	`båfs_roŸ_node
(root);

873 
	`£t_bô
(
BTRFS_ROOT_TRACK_DIRTY
, &
roŸ
->
°©e
);

875 
	`båfs_£t_roŸ_Êags
(&
roŸ
->
roŸ_ôem
, 0);

876 
	`båfs_£t_roŸ_limô
(&
roŸ
->
roŸ_ôem
, 0);

877 
	`båfs_£t_roŸ_byãƒ
(&
roŸ
->
roŸ_ôem
, 
Àaf
->
°¨t
);

878 
	`båfs_£t_roŸ_gíî©i⁄
(&
roŸ
->
roŸ_ôem
, 
å™s
->
å™sid
);

879 
	`båfs_£t_roŸ_Àvñ
(&
roŸ
->
roŸ_ôem
, 0);

880 
	`båfs_£t_roŸ_ªfs
(&
roŸ
->
roŸ_ôem
, 1);

881 
	`båfs_£t_roŸ_u£d
(&
roŸ
->
roŸ_ôem
, 
Àaf
->
Àn
);

882 
	`båfs_£t_roŸ_œ°_¢≠shŸ
(&
roŸ
->
roŸ_ôem
, 0);

883 
	`båfs_£t_roŸ_dúid
(&
roŸ
->
roŸ_ôem
, 0);

884 i‡(
	`is_f°ªe
(
obje˘id
))

885 
	`gíî©e_øndom_guid
(
roŸ
->
roŸ_ôem
.
uuid
);

887 
	`exp‹t_guid
(
roŸ
->
roŸ_ôem
.
uuid
, &
guid_nuŒ
);

888 
	`båfs_£t_roŸ_dr›_Àvñ
(&
roŸ
->
roŸ_ôem
, 0);

890 
	`båfs_åì_u∆ock
(
Àaf
);

892 
key
.
obje˘id
 = objectid;

893 
key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

894 
key
.
off£t
 = 0;

895 
ªt
 = 
	`båfs_ö£π_roŸ
(
å™s
, 
åì_roŸ
, &
key
, &
roŸ
->
roŸ_ôem
);

896 i‡(
ªt
)

897 
Áû
;

899  
roŸ
;

901 
Áû
:

902 
	`båfs_put_roŸ
(
roŸ
);

904  
	`ERR_PTR
(
ªt
);

905 
	}
}

907 
båfs_roŸ
 *
	$Æloc_log_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

908 
båfs_fs_öfo
 *
fs_öfo
)

910 
båfs_roŸ
 *
roŸ
;

912 
roŸ
 = 
	`båfs_Æloc_roŸ
(
fs_öfo
, 
BTRFS_TREE_LOG_OBJECTID
, 
GFP_NOFS
);

913 i‡(!
roŸ
)

914  
	`ERR_PTR
(-
ENOMEM
);

916 
roŸ
->
roŸ_key
.
obje˘id
 = 
BTRFS_TREE_LOG_OBJECTID
;

917 
roŸ
->
roŸ_key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

918 
roŸ
->
roŸ_key
.
off£t
 = 
BTRFS_TREE_LOG_OBJECTID
;

920  
roŸ
;

921 
	}
}

923 
	$båfs_Æloc_log_åì_node
(
båfs_å™s_h™dÀ
 *
å™s
,

924 
båfs_roŸ
 *
roŸ
)

926 
exã¡_buf„r
 *
Àaf
;

938 
Àaf
 = 
	`båfs_Æloc_åì_block
(
å™s
, 
roŸ
, 0, 
BTRFS_TREE_LOG_OBJECTID
,

939 
NULL
, 0, 0, 0, 
BTRFS_NESTING_NORMAL
);

940 i‡(
	`IS_ERR
(
Àaf
))

941  
	`PTR_ERR
(
Àaf
);

943 
roŸ
->
node
 = 
Àaf
;

945 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
roŸ
->
node
);

946 
	`båfs_åì_u∆ock
(
roŸ
->
node
);

949 
	}
}

951 
	$båfs_öô_log_roŸ_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

952 
båfs_fs_öfo
 *
fs_öfo
)

954 
båfs_roŸ
 *
log_roŸ
;

956 
log_roŸ
 = 
	`Æloc_log_åì
(
å™s
, 
fs_öfo
);

957 i‡(
	`IS_ERR
(
log_roŸ
))

958  
	`PTR_ERR
(
log_roŸ
);

960 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
)) {

961 
ªt
 = 
	`båfs_Æloc_log_åì_node
(
å™s
, 
log_roŸ
);

963 i‡(
ªt
) {

964 
	`båfs_put_roŸ
(
log_roŸ
);

965  
ªt
;

969 
	`WARN_ON
(
fs_öfo
->
log_roŸ_åì
);

970 
fs_öfo
->
log_roŸ_åì
 = 
log_roŸ
;

972 
	}
}

974 
	$båfs_add_log_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

975 
båfs_roŸ
 *
roŸ
)

977 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

978 
båfs_roŸ
 *
log_roŸ
;

979 
båfs_öode_ôem
 *
öode_ôem
;

980 
ªt
;

982 
log_roŸ
 = 
	`Æloc_log_åì
(
å™s
, 
fs_öfo
);

983 i‡(
	`IS_ERR
(
log_roŸ
))

984  
	`PTR_ERR
(
log_roŸ
);

986 
ªt
 = 
	`båfs_Æloc_log_åì_node
(
å™s
, 
log_roŸ
);

987 i‡(
ªt
) {

988 
	`båfs_put_roŸ
(
log_roŸ
);

989  
ªt
;

992 
log_roŸ
->
œ°_å™s
 = 
å™s
->
å™sid
;

993 
log_roŸ
->
roŸ_key
.
off£t
 = 
roŸ
->roŸ_key.
obje˘id
;

995 
öode_ôem
 = &
log_roŸ
->
roŸ_ôem
.
öode
;

996 
	`båfs_£t_°ack_öode_gíî©i⁄
(
öode_ôem
, 1);

997 
	`båfs_£t_°ack_öode_size
(
öode_ôem
, 3);

998 
	`båfs_£t_°ack_öode_∆ök
(
öode_ôem
, 1);

999 
	`båfs_£t_°ack_öode_nbyãs
(
öode_ôem
,

1000 
fs_öfo
->
nodesize
);

1001 
	`båfs_£t_°ack_öode_mode
(
öode_ôem
, 
S_IFDIR
 | 0755);

1003 
	`båfs_£t_roŸ_node
(&
log_roŸ
->
roŸ_ôem
,Üog_roŸ->
node
);

1005 
	`WARN_ON
(
roŸ
->
log_roŸ
);

1006 
roŸ
->
log_roŸ
 =Üog_root;

1007 
roŸ
->
log_å™sid
 = 0;

1008 
roŸ
->
log_å™sid_commôãd
 = -1;

1009 
roŸ
->
œ°_log_commô
 = 0;

1011 
	}
}

1013 
båfs_roŸ
 *
	$ªad_åì_roŸ_∑th
(
båfs_roŸ
 *
åì_roŸ
,

1014 
båfs_∑th
 *
∑th
,

1015 
båfs_key
 *
key
)

1017 
båfs_roŸ
 *
roŸ
;

1018 
båfs_åì_∑ª¡_check
 
check
 = { 0 };

1019 
båfs_fs_öfo
 *
fs_öfo
 = 
åì_roŸ
->fs_info;

1020 
u64
 
gíî©i⁄
;

1021 
ªt
;

1022 
Àvñ
;

1024 
roŸ
 = 
	`båfs_Æloc_roŸ
(
fs_öfo
, 
key
->
obje˘id
, 
GFP_NOFS
);

1025 i‡(!
roŸ
)

1026  
	`ERR_PTR
(-
ENOMEM
);

1028 
ªt
 = 
	`båfs_föd_roŸ
(
åì_roŸ
, 
key
, 
∑th
,

1029 &
roŸ
->
roŸ_ôem
, &roŸ->
roŸ_key
);

1030 i‡(
ªt
) {

1031 i‡(
ªt
 > 0)

1032 
ªt
 = -
ENOENT
;

1033 
Áû
;

1036 
gíî©i⁄
 = 
	`båfs_roŸ_gíî©i⁄
(&
roŸ
->
roŸ_ôem
);

1037 
Àvñ
 = 
	`båfs_roŸ_Àvñ
(&
roŸ
->
roŸ_ôem
);

1038 
check
.
Àvñ
 =Üevel;

1039 
check
.
å™sid
 = 
gíî©i⁄
;

1040 
check
.
ow√r_roŸ
 = 
key
->
obje˘id
;

1041 
roŸ
->
node
 = 
	`ªad_åì_block
(
fs_öfo
, 
	`båfs_roŸ_byãƒ
(&roŸ->
roŸ_ôem
),

1042 &
check
);

1043 i‡(
	`IS_ERR
(
roŸ
->
node
)) {

1044 
ªt
 = 
	`PTR_ERR
(
roŸ
->
node
);

1045 
roŸ
->
node
 = 
NULL
;

1046 
Áû
;

1048 i‡(!
	`båfs_buf„r_u±od©e
(
roŸ
->
node
, 
gíî©i⁄
, 0)) {

1049 
ªt
 = -
EIO
;

1050 
Áû
;

1057 i‡(!
	`ã°_bô
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_öfo
->
fs_°©e
) &&

1058 
roŸ
->
roŸ_key
.
obje˘id
 !
BTRFS_TREE_LOG_OBJECTID
 &&

1059 
roŸ
->
roŸ_key
.
obje˘id
 !
BTRFS_TREE_RELOC_OBJECTID
 &&

1060 
roŸ
->
roŸ_key
.
obje˘id
 !
	`båfs_hódî_ow√r
‘oŸ->
node
)) {

1061 
	`båfs_¸ô
(
fs_öfo
,

1063 
roŸ
->
roŸ_key
.
obje˘id
,ÑoŸ->
node
->
°¨t
,

1064 
	`båfs_hódî_ow√r
(
roŸ
->
node
),

1065 
roŸ
->
roŸ_key
.
obje˘id
);

1066 
ªt
 = -
EUCLEAN
;

1067 
Áû
;

1069 
roŸ
->
commô_roŸ
 = 
	`båfs_roŸ_node
(root);

1070  
roŸ
;

1071 
Áû
:

1072 
	`båfs_put_roŸ
(
roŸ
);

1073  
	`ERR_PTR
(
ªt
);

1074 
	}
}

1076 
båfs_roŸ
 *
	$båfs_ªad_åì_roŸ
(
båfs_roŸ
 *
åì_roŸ
,

1077 
båfs_key
 *
key
)

1079 
båfs_roŸ
 *
roŸ
;

1080 
båfs_∑th
 *
∑th
;

1082 
∑th
 = 
	`båfs_Æloc_∑th
();

1083 i‡(!
∑th
)

1084  
	`ERR_PTR
(-
ENOMEM
);

1085 
roŸ
 = 
	`ªad_åì_roŸ_∑th
(
åì_roŸ
, 
∑th
, 
key
);

1086 
	`båfs_‰ì_∑th
(
∑th
);

1088  
roŸ
;

1089 
	}
}

1096 
	$båfs_öô_fs_roŸ
(
båfs_roŸ
 *
roŸ
, 
dev_t
 
™⁄_dev
)

1098 
ªt
;

1100 
	`båfs_dªw_lock_öô
(&
roŸ
->
¢≠shŸ_lock
);

1102 i‡(
roŸ
->
roŸ_key
.
obje˘id
 !
BTRFS_TREE_LOG_OBJECTID
 &&

1103 !
	`båfs_is_d©a_ªloc_roŸ
(
roŸ
) &&

1104 
	`is_f°ªe
(
roŸ
->
roŸ_key
.
obje˘id
)) {

1105 
	`£t_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
);

1106 
	`båfs_check_™d_öô_roŸ_ôem
(&
roŸ
->
roŸ_ôem
);

1113 i‡(
	`is_f°ªe
(
roŸ
->
roŸ_key
.
obje˘id
) &&

1114 
	`båfs_roŸ_ªfs
(&
roŸ
->
roŸ_ôem
) > 0) {

1115 i‡(!
™⁄_dev
) {

1116 
ªt
 = 
	`gë_™⁄_bdev
(&
roŸ
->
™⁄_dev
);

1117 i‡(
ªt
)

1118 
Áû
;

1120 
roŸ
->
™⁄_dev
 =ánon_dev;

1124 
	`muãx_lock
(&
roŸ
->
obje˘id_muãx
);

1125 
ªt
 = 
	`båfs_öô_roŸ_‰ì_obje˘id
(
roŸ
);

1126 i‡(
ªt
) {

1127 
	`muãx_u∆ock
(&
roŸ
->
obje˘id_muãx
);

1128 
Áû
;

1131 
	`ASSERT
(
roŸ
->
‰ì_obje˘id
 <
BTRFS_LAST_FREE_OBJECTID
);

1133 
	`muãx_u∆ock
(&
roŸ
->
obje˘id_muãx
);

1136 
Áû
:

1138  
ªt
;

1139 
	}
}

1141 
båfs_roŸ
 *
	$båfs_lookup_fs_roŸ
(
båfs_fs_öfo
 *
fs_öfo
,

1142 
u64
 
roŸ_id
)

1144 
båfs_roŸ
 *
roŸ
;

1146 
	`•ö_lock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

1147 
roŸ
 = 
	`ødix_åì_lookup
(&
fs_öfo
->
fs_roŸs_ødix
,

1148 ()
roŸ_id
);

1149 
roŸ
 = 
	`båfs_gøb_roŸ
(root);

1150 
	`•ö_u∆ock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

1151  
roŸ
;

1152 
	}
}

1154 
båfs_roŸ
 *
	$båfs_gë_globÆ_roŸ
(
båfs_fs_öfo
 *
fs_öfo
,

1155 
u64
 
obje˘id
)

1157 
båfs_key
 
key
 = {

1158 .
obje˘id
 = objectid,

1159 .
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
,

1160 .
off£t
 = 0,

1163 
obje˘id
) {

1164 
BTRFS_ROOT_TREE_OBJECTID
:

1165  
	`båfs_gøb_roŸ
(
fs_öfo
->
åì_roŸ
);

1166 
BTRFS_EXTENT_TREE_OBJECTID
:

1167  
	`båfs_gøb_roŸ
(
	`båfs_globÆ_roŸ
(
fs_öfo
, &
key
));

1168 
BTRFS_CHUNK_TREE_OBJECTID
:

1169  
	`båfs_gøb_roŸ
(
fs_öfo
->
chunk_roŸ
);

1170 
BTRFS_DEV_TREE_OBJECTID
:

1171  
	`båfs_gøb_roŸ
(
fs_öfo
->
dev_roŸ
);

1172 
BTRFS_CSUM_TREE_OBJECTID
:

1173  
	`båfs_gøb_roŸ
(
	`båfs_globÆ_roŸ
(
fs_öfo
, &
key
));

1174 
BTRFS_QUOTA_TREE_OBJECTID
:

1175  
	`båfs_gøb_roŸ
(
fs_öfo
->
quŸa_roŸ
);

1176 
BTRFS_UUID_TREE_OBJECTID
:

1177  
	`båfs_gøb_roŸ
(
fs_öfo
->
uuid_roŸ
);

1178 
BTRFS_BLOCK_GROUP_TREE_OBJECTID
:

1179  
	`båfs_gøb_roŸ
(
fs_öfo
->
block_group_roŸ
);

1180 
BTRFS_FREE_SPACE_TREE_OBJECTID
:

1181  
	`båfs_gøb_roŸ
(
	`båfs_globÆ_roŸ
(
fs_öfo
, &
key
));

1183  
NULL
;

1185 
	}
}

1187 
	$båfs_ö£π_fs_roŸ
(
båfs_fs_öfo
 *
fs_öfo
,

1188 
båfs_roŸ
 *
roŸ
)

1190 
ªt
;

1192 
ªt
 = 
	`ødix_åì_¥ñﬂd
(
GFP_NOFS
);

1193 i‡(
ªt
)

1194  
ªt
;

1196 
	`•ö_lock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

1197 
ªt
 = 
	`ødix_åì_ö£π
(&
fs_öfo
->
fs_roŸs_ødix
,

1198 ()
roŸ
->
roŸ_key
.
obje˘id
,

1199 
roŸ
);

1200 i‡(
ªt
 == 0) {

1201 
	`båfs_gøb_roŸ
(
roŸ
);

1202 
	`£t_bô
(
BTRFS_ROOT_IN_RADIX
, &
roŸ
->
°©e
);

1204 
	`•ö_u∆ock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

1205 
	`ødix_åì_¥ñﬂd_íd
();

1207  
ªt
;

1208 
	}
}

1210 
	$båfs_check_Àaked_roŸs
(
båfs_fs_öfo
 *
fs_öfo
)

1212 #ifde‡
CONFIG_BTRFS_DEBUG


1213 
båfs_roŸ
 *
roŸ
;

1215 !
	`li°_em±y
(&
fs_öfo
->
Æloˇãd_roŸs
)) {

1216 
buf
[
BTRFS_ROOT_NAME_BUF_LEN
];

1218 
roŸ
 = 
	`li°_fú°_íåy
(&
fs_öfo
->
Æloˇãd_roŸs
,

1219 
båfs_roŸ
, 
Àak_li°
);

1220 
	`båfs_îr
(
fs_öfo
, "leakedÑoot %sÑefcount %d",

1221 
	`båfs_roŸ_«me
(&
roŸ
->
roŸ_key
, 
buf
),

1222 
	`ªfcou¡_ªad
(&
roŸ
->
ªfs
));

1223 
	`ªfcou¡_ªad
(&
roŸ
->
ªfs
) > 1)

1224 
	`båfs_put_roŸ
(
roŸ
);

1225 
	`båfs_put_roŸ
(
roŸ
);

1228 
	}
}

1230 
	$‰ì_globÆ_roŸs
(
båfs_fs_öfo
 *
fs_öfo
)

1232 
båfs_roŸ
 *
roŸ
;

1233 
rb_node
 *
node
;

1235 (
node
 = 
	`rb_fú°_po°‹dî
(&
fs_öfo
->
globÆ_roŸ_åì
)Ë!
NULL
) {

1236 
roŸ
 = 
	`rb_íåy
(
node
, 
båfs_roŸ
, 
rb_node
);

1237 
	`rb_îa£
(&
roŸ
->
rb_node
, &
fs_öfo
->
globÆ_roŸ_åì
);

1238 
	`båfs_put_roŸ
(
roŸ
);

1240 
	}
}

1242 
	$båfs_‰ì_fs_öfo
(
båfs_fs_öfo
 *
fs_öfo
)

1244 
	`≥r˝u_cou¡î_de°roy
(&
fs_öfo
->
dúty_mëad©a_byãs
);

1245 
	`≥r˝u_cou¡î_de°roy
(&
fs_öfo
->
dñÆloc_byãs
);

1246 
	`≥r˝u_cou¡î_de°roy
(&
fs_öfo
->
‹dîed_byãs
);

1247 
	`≥r˝u_cou¡î_de°roy
(&
fs_öfo
->
dev_ª∂a˚
.
bio_cou¡î
);

1248 
	`båfs_‰ì_csum_hash
(
fs_öfo
);

1249 
	`båfs_‰ì_°rùe_hash_èbÀ
(
fs_öfo
);

1250 
	`båfs_‰ì_ªf_ˇche
(
fs_öfo
);

1251 
	`k‰ì
(
fs_öfo
->
bÆ™˚_˘l
);

1252 
	`k‰ì
(
fs_öfo
->
dñayed_roŸ
);

1253 
	`‰ì_globÆ_roŸs
(
fs_öfo
);

1254 
	`båfs_put_roŸ
(
fs_öfo
->
åì_roŸ
);

1255 
	`båfs_put_roŸ
(
fs_öfo
->
chunk_roŸ
);

1256 
	`båfs_put_roŸ
(
fs_öfo
->
dev_roŸ
);

1257 
	`båfs_put_roŸ
(
fs_öfo
->
quŸa_roŸ
);

1258 
	`båfs_put_roŸ
(
fs_öfo
->
uuid_roŸ
);

1259 
	`båfs_put_roŸ
(
fs_öfo
->
fs_roŸ
);

1260 
	`båfs_put_roŸ
(
fs_öfo
->
d©a_ªloc_roŸ
);

1261 
	`båfs_put_roŸ
(
fs_öfo
->
block_group_roŸ
);

1262 
	`båfs_check_Àaked_roŸs
(
fs_öfo
);

1263 
	`båfs_exã¡_buf„r_Àak_debug_check
(
fs_öfo
);

1264 
	`k‰ì
(
fs_öfo
->
su≥r_c›y
);

1265 
	`k‰ì
(
fs_öfo
->
su≥r_f‹_commô
);

1266 
	`k‰ì
(
fs_öfo
->
sub∑ge_öfo
);

1267 
	`kv‰ì
(
fs_öfo
);

1268 
	}
}

1289 
båfs_roŸ
 *
	$båfs_gë_roŸ_ªf
(
båfs_fs_öfo
 *
fs_öfo
,

1290 
u64
 
obje˘id
, 
dev_t
 
™⁄_dev
,

1291 
boﬁ
 
check_ªf
)

1293 
båfs_roŸ
 *
roŸ
;

1294 
båfs_∑th
 *
∑th
;

1295 
båfs_key
 
key
;

1296 
ªt
;

1298 
roŸ
 = 
	`båfs_gë_globÆ_roŸ
(
fs_öfo
, 
obje˘id
);

1299 i‡(
roŸ
)

1300  
roŸ
;

1309 i‡(!
	`is_f°ªe
(
obje˘id
Ë&& obje˘id !
BTRFS_DATA_RELOC_TREE_OBJECTID
)

1310  
	`ERR_PTR
(-
ENOENT
);

1311 
agaö
:

1312 
roŸ
 = 
	`båfs_lookup_fs_roŸ
(
fs_öfo
, 
obje˘id
);

1313 i‡(
roŸ
) {

1315 
	`ASSERT
(!
™⁄_dev
);

1316 i‡(
check_ªf
 && 
	`båfs_roŸ_ªfs
(&
roŸ
->
roŸ_ôem
) == 0) {

1317 
	`båfs_put_roŸ
(
roŸ
);

1318  
	`ERR_PTR
(-
ENOENT
);

1320  
roŸ
;

1323 
key
.
obje˘id
 = objectid;

1324 
key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

1325 
key
.
off£t
 = (
u64
)-1;

1326 
roŸ
 = 
	`båfs_ªad_åì_roŸ
(
fs_öfo
->
åì_roŸ
, &
key
);

1327 i‡(
	`IS_ERR
(
roŸ
))

1328  
roŸ
;

1330 i‡(
check_ªf
 && 
	`båfs_roŸ_ªfs
(&
roŸ
->
roŸ_ôem
) == 0) {

1331 
ªt
 = -
ENOENT
;

1332 
Áû
;

1335 
ªt
 = 
	`båfs_öô_fs_roŸ
(
roŸ
, 
™⁄_dev
);

1336 i‡(
ªt
)

1337 
Áû
;

1339 
∑th
 = 
	`båfs_Æloc_∑th
();

1340 i‡(!
∑th
) {

1341 
ªt
 = -
ENOMEM
;

1342 
Áû
;

1344 
key
.
obje˘id
 = 
BTRFS_ORPHAN_OBJECTID
;

1345 
key
.
ty≥
 = 
BTRFS_ORPHAN_ITEM_KEY
;

1346 
key
.
off£t
 = 
obje˘id
;

1348 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
fs_öfo
->
åì_roŸ
, &
key
, 
∑th
, 0, 0);

1349 
	`båfs_‰ì_∑th
(
∑th
);

1350 i‡(
ªt
 < 0)

1351 
Áû
;

1352 i‡(
ªt
 == 0)

1353 
	`£t_bô
(
BTRFS_ROOT_ORPHAN_ITEM_INSERTED
, &
roŸ
->
°©e
);

1355 
ªt
 = 
	`båfs_ö£π_fs_roŸ
(
fs_öfo
, 
roŸ
);

1356 i‡(
ªt
) {

1357 i‡(
ªt
 =-
EEXIST
) {

1358 
	`båfs_put_roŸ
(
roŸ
);

1359 
agaö
;

1361 
Áû
;

1363  
roŸ
;

1364 
Áû
:

1371 i‡(
™⁄_dev
)

1372 
roŸ
->
™⁄_dev
 = 0;

1373 
	`båfs_put_roŸ
(
roŸ
);

1374  
	`ERR_PTR
(
ªt
);

1375 
	}
}

1384 
båfs_roŸ
 *
	$båfs_gë_fs_roŸ
(
båfs_fs_öfo
 *
fs_öfo
,

1385 
u64
 
obje˘id
, 
boﬁ
 
check_ªf
)

1387  
	`båfs_gë_roŸ_ªf
(
fs_öfo
, 
obje˘id
, 0, 
check_ªf
);

1388 
	}
}

1398 
båfs_roŸ
 *
	$båfs_gë_√w_fs_roŸ
(
båfs_fs_öfo
 *
fs_öfo
,

1399 
u64
 
obje˘id
, 
dev_t
 
™⁄_dev
)

1401  
	`båfs_gë_roŸ_ªf
(
fs_öfo
, 
obje˘id
, 
™⁄_dev
, 
åue
);

1402 
	}
}

1418 
båfs_roŸ
 *
	$båfs_gë_fs_roŸ_commô_roŸ
(
båfs_fs_öfo
 *
fs_öfo
,

1419 
båfs_∑th
 *
∑th
,

1420 
u64
 
obje˘id
)

1422 
båfs_roŸ
 *
roŸ
;

1423 
båfs_key
 
key
;

1425 
	`ASSERT
(
∑th
->
£¨ch_commô_roŸ
 &&Ö©h->
skù_lockög
);

1433 
roŸ
 = 
	`båfs_gë_globÆ_roŸ
(
fs_öfo
, 
obje˘id
);

1434 i‡(
roŸ
)

1435  
roŸ
;

1437 
roŸ
 = 
	`båfs_lookup_fs_roŸ
(
fs_öfo
, 
obje˘id
);

1438 i‡(
roŸ
)

1439  
roŸ
;

1441 
key
.
obje˘id
 = objectid;

1442 
key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

1443 
key
.
off£t
 = (
u64
)-1;

1444 
roŸ
 = 
	`ªad_åì_roŸ_∑th
(
fs_öfo
->
åì_roŸ
, 
∑th
, &
key
);

1445 
	`båfs_ªÀa£_∑th
(
∑th
);

1447  
roŸ
;

1448 
	}
}

1450 
	$˛ó√r_kthªad
(*
¨g
)

1452 
båfs_fs_öfo
 *
fs_öfo
 = 
¨g
;

1453 
agaö
;

1456 
agaö
 = 0;

1458 
	`£t_bô
(
BTRFS_FS_CLEANER_RUNNING
, &
fs_öfo
->
Êags
);

1461 i‡(
	`båfs_√ed_˛ó√r_¶ìp
(
fs_öfo
))

1462 
¶ìp
;

1468 i‡(!
	`ã°_bô
(
BTRFS_FS_OPEN
, &
fs_öfo
->
Êags
))

1469 
¶ìp
;

1471 i‡(!
	`muãx_åylock
(&
fs_öfo
->
˛ó√r_muãx
))

1472 
¶ìp
;

1478 i‡(
	`båfs_√ed_˛ó√r_¶ìp
(
fs_öfo
)) {

1479 
	`muãx_u∆ock
(&
fs_öfo
->
˛ó√r_muãx
);

1480 
¶ìp
;

1483 i‡(
	`ã°_™d_˛ór_bô
(
BTRFS_FS_FEATURE_CHANGED
, &
fs_öfo
->
Êags
))

1484 
	`båfs_sysfs_„©uª_upd©e
(
fs_öfo
);

1486 
	`båfs_run_dñayed_ùuts
(
fs_öfo
);

1488 
agaö
 = 
	`båfs_˛ón_⁄e_dñëed_¢≠shŸ
(
fs_öfo
);

1489 
	`muãx_u∆ock
(&
fs_öfo
->
˛ó√r_muãx
);

1495 
	`båfs_run_de‰ag_öodes
(
fs_öfo
);

1505 
	`båfs_dñëe_unu£d_bgs
(
fs_öfo
);

1512 
	`båfs_ª˛aim_bgs
(
fs_öfo
);

1513 
¶ìp
:

1514 
	`˛ór_™d_wake_up_bô
(
BTRFS_FS_CLEANER_RUNNING
, &
fs_öfo
->
Êags
);

1515 i‡(
	`kthªad_should_∑rk
())

1516 
	`kthªad_∑rkme
();

1517 i‡(
	`kthªad_should_°›
())

1519 i‡(!
agaö
) {

1520 
	`£t_cuºít_°©e
(
TASK_INTERRUPTIBLE
);

1521 
	`scheduÀ
();

1522 
	`__£t_cuºít_°©e
(
TASK_RUNNING
);

1525 
	}
}

1527 
	$å™ß˘i⁄_kthªad
(*
¨g
)

1529 
båfs_roŸ
 *
roŸ
 = 
¨g
;

1530 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1531 
båfs_å™s_h™dÀ
 *
å™s
;

1532 
båfs_å™ß˘i⁄
 *
cur
;

1533 
u64
 
å™sid
;

1534 
time64_t
 
dñè
;

1535 
dñay
;

1536 
boﬁ
 
ˇ¬Ÿ_commô
;

1539 
ˇ¬Ÿ_commô
 = 
Ál£
;

1540 
dñay
 = 
	`m£cs_to_jiffõs
(
fs_öfo
->
commô_öãrvÆ
 * 1000);

1541 
	`muãx_lock
(&
fs_öfo
->
å™ß˘i⁄_kthªad_muãx
);

1543 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

1544 
cur
 = 
fs_öfo
->
ru¬ög_å™ß˘i⁄
;

1545 i‡(!
cur
) {

1546 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

1547 
¶ìp
;

1550 
dñè
 = 
	`ktime_gë_£c⁄ds
(Ë- 
cur
->
°¨t_time
;

1551 i‡(!
	`ã°_™d_˛ór_bô
(
BTRFS_FS_COMMIT_TRANS
, &
fs_öfo
->
Êags
) &&

1552 
cur
->
°©e
 < 
TRANS_STATE_COMMIT_PREP
 &&

1553 
dñè
 < 
fs_öfo
->
commô_öãrvÆ
) {

1554 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

1555 
dñay
 -
	`m£cs_to_jiffõs
((
dñè
 - 1) * 1000);

1556 
dñay
 = 
	`mö
(delay,

1557 
	`m£cs_to_jiffõs
(
fs_öfo
->
commô_öãrvÆ
 * 1000));

1558 
¶ìp
;

1560 
å™sid
 = 
cur
->transid;

1561 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

1564 
å™s
 = 
	`båfs_©èch_å™ß˘i⁄
(
roŸ
);

1565 i‡(
	`IS_ERR
(
å™s
)) {

1566 i‡(
	`PTR_ERR
(
å™s
Ë!-
ENOENT
)

1567 
ˇ¬Ÿ_commô
 = 
åue
;

1568 
¶ìp
;

1570 i‡(
å™sid
 =
å™s
->transid) {

1571 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

1573 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1575 
¶ìp
:

1576 
	`wake_up_¥o˚ss
(
fs_öfo
->
˛ó√r_kthªad
);

1577 
	`muãx_u∆ock
(&
fs_öfo
->
å™ß˘i⁄_kthªad_muãx
);

1579 i‡(
	`BTRFS_FS_ERROR
(
fs_öfo
))

1580 
	`båfs_˛ónup_å™ß˘i⁄
(
fs_öfo
);

1581 i‡(!
	`kthªad_should_°›
() &&

1582 (!
	`båfs_å™ß˘i⁄_blocked
(
fs_öfo
) ||

1583 
ˇ¬Ÿ_commô
))

1584 
	`scheduÀ_timeout_öãºu±ibÀ
(
dñay
);

1585 } !
	`kthªad_should_°›
());

1587 
	}
}

1598 
	$föd_√we°_su≥r_backup
(
båfs_fs_öfo
 *
öfo
)

1600 c⁄° 
u64
 
√we°_gí
 = 
	`båfs_su≥r_gíî©i⁄
(
öfo
->
su≥r_c›y
);

1601 
u64
 
cur
;

1602 
båfs_roŸ_backup
 *
roŸ_backup
;

1603 
i
;

1605 
i
 = 0; i < 
BTRFS_NUM_BACKUP_ROOTS
; i++) {

1606 
roŸ_backup
 = 
öfo
->
su≥r_c›y
->
su≥r_roŸs
 + 
i
;

1607 
cur
 = 
	`båfs_backup_åì_roŸ_gí
(
roŸ_backup
);

1608 i‡(
cur
 =
√we°_gí
)

1609  
i
;

1612  -
EINVAL
;

1613 
	}
}

1620 
	$backup_su≥r_roŸs
(
båfs_fs_öfo
 *
öfo
)

1622 c⁄° 
√xt_backup
 = 
öfo
->
backup_roŸ_ödex
;

1623 
båfs_roŸ_backup
 *
roŸ_backup
;

1625 
roŸ_backup
 = 
öfo
->
su≥r_f‹_commô
->
su≥r_roŸs
 + 
√xt_backup
;

1631 
	`mem£t
(
roŸ_backup
, 0, (*root_backup));

1633 
öfo
->
backup_roŸ_ödex
 = (
√xt_backup
 + 1Ë% 
BTRFS_NUM_BACKUP_ROOTS
;

1635 
	`båfs_£t_backup_åì_roŸ
(
roŸ_backup
, 
öfo
->
åì_roŸ
->
node
->
°¨t
);

1636 
	`båfs_£t_backup_åì_roŸ_gí
(
roŸ_backup
,

1637 
	`båfs_hódî_gíî©i⁄
(
öfo
->
åì_roŸ
->
node
));

1639 
	`båfs_£t_backup_åì_roŸ_Àvñ
(
roŸ_backup
,

1640 
	`båfs_hódî_Àvñ
(
öfo
->
åì_roŸ
->
node
));

1642 
	`båfs_£t_backup_chunk_roŸ
(
roŸ_backup
, 
öfo
->
chunk_roŸ
->
node
->
°¨t
);

1643 
	`båfs_£t_backup_chunk_roŸ_gí
(
roŸ_backup
,

1644 
	`båfs_hódî_gíî©i⁄
(
öfo
->
chunk_roŸ
->
node
));

1645 
	`båfs_£t_backup_chunk_roŸ_Àvñ
(
roŸ_backup
,

1646 
	`båfs_hódî_Àvñ
(
öfo
->
chunk_roŸ
->
node
));

1648 i‡(!
	`båfs_fs_com∑t_ro
(
öfo
, 
BLOCK_GROUP_TREE
)) {

1649 
båfs_roŸ
 *
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
öfo
, 0);

1650 
båfs_roŸ
 *
csum_roŸ
 = 
	`båfs_csum_roŸ
(
öfo
, 0);

1652 
	`båfs_£t_backup_exã¡_roŸ
(
roŸ_backup
,

1653 
exã¡_roŸ
->
node
->
°¨t
);

1654 
	`båfs_£t_backup_exã¡_roŸ_gí
(
roŸ_backup
,

1655 
	`båfs_hódî_gíî©i⁄
(
exã¡_roŸ
->
node
));

1656 
	`båfs_£t_backup_exã¡_roŸ_Àvñ
(
roŸ_backup
,

1657 
	`båfs_hódî_Àvñ
(
exã¡_roŸ
->
node
));

1659 
	`båfs_£t_backup_csum_roŸ
(
roŸ_backup
, 
csum_roŸ
->
node
->
°¨t
);

1660 
	`båfs_£t_backup_csum_roŸ_gí
(
roŸ_backup
,

1661 
	`båfs_hódî_gíî©i⁄
(
csum_roŸ
->
node
));

1662 
	`båfs_£t_backup_csum_roŸ_Àvñ
(
roŸ_backup
,

1663 
	`båfs_hódî_Àvñ
(
csum_roŸ
->
node
));

1670 i‡(
öfo
->
fs_roŸ
 && info->fs_roŸ->
node
) {

1671 
	`båfs_£t_backup_fs_roŸ
(
roŸ_backup
,

1672 
öfo
->
fs_roŸ
->
node
->
°¨t
);

1673 
	`båfs_£t_backup_fs_roŸ_gí
(
roŸ_backup
,

1674 
	`båfs_hódî_gíî©i⁄
(
öfo
->
fs_roŸ
->
node
));

1675 
	`båfs_£t_backup_fs_roŸ_Àvñ
(
roŸ_backup
,

1676 
	`båfs_hódî_Àvñ
(
öfo
->
fs_roŸ
->
node
));

1679 
	`båfs_£t_backup_dev_roŸ
(
roŸ_backup
, 
öfo
->
dev_roŸ
->
node
->
°¨t
);

1680 
	`båfs_£t_backup_dev_roŸ_gí
(
roŸ_backup
,

1681 
	`båfs_hódî_gíî©i⁄
(
öfo
->
dev_roŸ
->
node
));

1682 
	`båfs_£t_backup_dev_roŸ_Àvñ
(
roŸ_backup
,

1683 
	`båfs_hódî_Àvñ
(
öfo
->
dev_roŸ
->
node
));

1685 
	`båfs_£t_backup_tŸÆ_byãs
(
roŸ_backup
,

1686 
	`båfs_su≥r_tŸÆ_byãs
(
öfo
->
su≥r_c›y
));

1687 
	`båfs_£t_backup_byãs_u£d
(
roŸ_backup
,

1688 
	`båfs_su≥r_byãs_u£d
(
öfo
->
su≥r_c›y
));

1689 
	`båfs_£t_backup_num_devi˚s
(
roŸ_backup
,

1690 
	`båfs_su≥r_num_devi˚s
(
öfo
->
su≥r_c›y
));

1696 
	`mem˝y
(&
öfo
->
su≥r_c›y
->
su≥r_roŸs
,

1697 &
öfo
->
su≥r_f‹_commô
->
su≥r_roŸs
,

1698 (*
roŸ_backup
Ë* 
BTRFS_NUM_BACKUP_ROOTS
);

1699 
	}
}

1710 
	$ªad_backup_roŸ
(
båfs_fs_öfo
 *
fs_öfo
, 
u8
 
¥i‹ôy
)

1712 
backup_ödex
 = 
	`föd_√we°_su≥r_backup
(
fs_öfo
);

1713 
båfs_su≥r_block
 *
su≥r
 = 
fs_öfo
->
su≥r_c›y
;

1714 
båfs_roŸ_backup
 *
roŸ_backup
;

1716 i‡(
¥i‹ôy
 < 
BTRFS_NUM_BACKUP_ROOTS
 && 
backup_ödex
 >= 0) {

1717 i‡(
¥i‹ôy
 == 0)

1718  
backup_ödex
;

1720 
backup_ödex
 = backup_ödex + 
BTRFS_NUM_BACKUP_ROOTS
 - 
¥i‹ôy
;

1721 
backup_ödex
 %
BTRFS_NUM_BACKUP_ROOTS
;

1723  -
EINVAL
;

1726 
roŸ_backup
 = 
su≥r
->
su≥r_roŸs
 + 
backup_ödex
;

1728 
	`båfs_£t_su≥r_gíî©i⁄
(
su≥r
,

1729 
	`båfs_backup_åì_roŸ_gí
(
roŸ_backup
));

1730 
	`båfs_£t_su≥r_roŸ
(
su≥r
, 
	`båfs_backup_åì_roŸ
(
roŸ_backup
));

1731 
	`båfs_£t_su≥r_roŸ_Àvñ
(
su≥r
,

1732 
	`båfs_backup_åì_roŸ_Àvñ
(
roŸ_backup
));

1733 
	`båfs_£t_su≥r_byãs_u£d
(
su≥r
, 
	`båfs_backup_byãs_u£d
(
roŸ_backup
));

1739 
	`båfs_£t_su≥r_tŸÆ_byãs
(
su≥r
, 
	`båfs_backup_tŸÆ_byãs
(
roŸ_backup
));

1740 
	`båfs_£t_su≥r_num_devi˚s
(
su≥r
, 
	`båfs_backup_num_devi˚s
(
roŸ_backup
));

1742  
backup_ödex
;

1743 
	}
}

1746 
	$båfs_°›_Æl_w‹kîs
(
båfs_fs_öfo
 *
fs_öfo
)

1748 
	`båfs_de°roy_w‹kqueue
(
fs_öfo
->
fixup_w‹kîs
);

1749 
	`båfs_de°roy_w‹kqueue
(
fs_öfo
->
dñÆloc_w‹kîs
);

1750 
	`båfs_de°roy_w‹kqueue
(
fs_öfo
->
w‹kîs
);

1751 i‡(
fs_öfo
->
ídio_w‹kîs
)

1752 
	`de°roy_w‹kqueue
(
fs_öfo
->
ídio_w‹kîs
);

1753 i‡(
fs_öfo
->
rmw_w‹kîs
)

1754 
	`de°roy_w‹kqueue
(
fs_öfo
->
rmw_w‹kîs
);

1755 i‡(
fs_öfo
->
com¥es£d_wrôe_w‹kîs
)

1756 
	`de°roy_w‹kqueue
(
fs_öfo
->
com¥es£d_wrôe_w‹kîs
);

1757 
	`båfs_de°roy_w‹kqueue
(
fs_öfo
->
ídio_wrôe_w‹kîs
);

1758 
	`båfs_de°roy_w‹kqueue
(
fs_öfo
->
ídio_‰ì•a˚_w‹kî
);

1759 
	`båfs_de°roy_w‹kqueue
(
fs_öfo
->
dñayed_w‹kîs
);

1760 
	`båfs_de°roy_w‹kqueue
(
fs_öfo
->
ˇchög_w‹kîs
);

1761 
	`båfs_de°roy_w‹kqueue
(
fs_öfo
->
Êush_w‹kîs
);

1762 
	`båfs_de°roy_w‹kqueue
(
fs_öfo
->
qgroup_ªsˇn_w‹kîs
);

1763 i‡(
fs_öfo
->
disˇrd_˘l
.
disˇrd_w‹kîs
)

1764 
	`de°roy_w‹kqueue
(
fs_öfo
->
disˇrd_˘l
.
disˇrd_w‹kîs
);

1770 i‡(
fs_öfo
->
ídio_mëa_w‹kîs
)

1771 
	`de°roy_w‹kqueue
(
fs_öfo
->
ídio_mëa_w‹kîs
);

1772 
	}
}

1774 
	$‰ì_roŸ_exã¡_buf„rs
(
båfs_roŸ
 *
roŸ
)

1776 i‡(
roŸ
) {

1777 
	`‰ì_exã¡_buf„r
(
roŸ
->
node
);

1778 
	`‰ì_exã¡_buf„r
(
roŸ
->
commô_roŸ
);

1779 
roŸ
->
node
 = 
NULL
;

1780 
roŸ
->
commô_roŸ
 = 
NULL
;

1782 
	}
}

1784 
	$‰ì_globÆ_roŸ_poöãrs
(
båfs_fs_öfo
 *
fs_öfo
)

1786 
båfs_roŸ
 *
roŸ
, *
tmp
;

1788 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
roŸ
, 
tmp
,

1789 &
fs_öfo
->
globÆ_roŸ_åì
,

1790 
rb_node
)

1791 
	`‰ì_roŸ_exã¡_buf„rs
(
roŸ
);

1792 
	}
}

1795 
	$‰ì_roŸ_poöãrs
(
båfs_fs_öfo
 *
öfo
, 
boﬁ
 
‰ì_chunk_roŸ
)

1797 
	`‰ì_roŸ_exã¡_buf„rs
(
öfo
->
åì_roŸ
);

1799 
	`‰ì_globÆ_roŸ_poöãrs
(
öfo
);

1800 
	`‰ì_roŸ_exã¡_buf„rs
(
öfo
->
dev_roŸ
);

1801 
	`‰ì_roŸ_exã¡_buf„rs
(
öfo
->
quŸa_roŸ
);

1802 
	`‰ì_roŸ_exã¡_buf„rs
(
öfo
->
uuid_roŸ
);

1803 
	`‰ì_roŸ_exã¡_buf„rs
(
öfo
->
fs_roŸ
);

1804 
	`‰ì_roŸ_exã¡_buf„rs
(
öfo
->
d©a_ªloc_roŸ
);

1805 
	`‰ì_roŸ_exã¡_buf„rs
(
öfo
->
block_group_roŸ
);

1806 i‡(
‰ì_chunk_roŸ
)

1807 
	`‰ì_roŸ_exã¡_buf„rs
(
öfo
->
chunk_roŸ
);

1808 
	}
}

1810 
	$båfs_put_roŸ
(
båfs_roŸ
 *
roŸ
)

1812 i‡(!
roŸ
)

1815 i‡(
	`ªfcou¡_dec_™d_ã°
(&
roŸ
->
ªfs
)) {

1816 
	`WARN_ON
(!
	`RB_EMPTY_ROOT
(&
roŸ
->
öode_åì
));

1817 
	`WARN_ON
(
	`ã°_bô
(
BTRFS_ROOT_DEAD_RELOC_TREE
, &
roŸ
->
°©e
));

1818 i‡(
roŸ
->
™⁄_dev
)

1819 
	`‰ì_™⁄_bdev
(
roŸ
->
™⁄_dev
);

1820 
	`‰ì_roŸ_exã¡_buf„rs
(
roŸ
);

1821 #ifde‡
CONFIG_BTRFS_DEBUG


1822 
	`•ö_lock
(&
roŸ
->
fs_öfo
->
fs_roŸs_ødix_lock
);

1823 
	`li°_dñ_öô
(&
roŸ
->
Àak_li°
);

1824 
	`•ö_u∆ock
(&
roŸ
->
fs_öfo
->
fs_roŸs_ødix_lock
);

1826 
	`k‰ì
(
roŸ
);

1828 
	}
}

1830 
	$båfs_‰ì_fs_roŸs
(
båfs_fs_öfo
 *
fs_öfo
)

1832 
ªt
;

1833 
båfs_roŸ
 *
g™g
[8];

1834 
i
;

1836 !
	`li°_em±y
(&
fs_öfo
->
dód_roŸs
)) {

1837 
g™g
[0] = 
	`li°_íåy
(
fs_öfo
->
dód_roŸs
.
√xt
,

1838 
båfs_roŸ
, 
roŸ_li°
);

1839 
	`li°_dñ
(&
g™g
[0]->
roŸ_li°
);

1841 i‡(
	`ã°_bô
(
BTRFS_ROOT_IN_RADIX
, &
g™g
[0]->
°©e
))

1842 
	`båfs_dr›_™d_‰ì_fs_roŸ
(
fs_öfo
, 
g™g
[0]);

1843 
	`båfs_put_roŸ
(
g™g
[0]);

1847 
ªt
 = 
	`ødix_åì_g™g_lookup
(&
fs_öfo
->
fs_roŸs_ødix
,

1848 (**)
g™g
, 0,

1849 
	`ARRAY_SIZE
(
g™g
));

1850 i‡(!
ªt
)

1852 
i
 = 0; i < 
ªt
; i++)

1853 
	`båfs_dr›_™d_‰ì_fs_roŸ
(
fs_öfo
, 
g™g
[
i
]);

1855 
	}
}

1857 
	$båfs_öô_s¸ub
(
båfs_fs_öfo
 *
fs_öfo
)

1859 
	`muãx_öô
(&
fs_öfo
->
s¸ub_lock
);

1860 
	`©omic_£t
(&
fs_öfo
->
s¸ubs_ru¬ög
, 0);

1861 
	`©omic_£t
(&
fs_öfo
->
s¸ub_∑u£_ªq
, 0);

1862 
	`©omic_£t
(&
fs_öfo
->
s¸ubs_∑u£d
, 0);

1863 
	`©omic_£t
(&
fs_öfo
->
s¸ub_ˇn˚l_ªq
, 0);

1864 
	`öô_waôqueue_hód
(&
fs_öfo
->
s¸ub_∑u£_waô
);

1865 
	`ªfcou¡_£t
(&
fs_öfo
->
s¸ub_w‹kîs_ªf˙t
, 0);

1866 
	}
}

1868 
	$båfs_öô_bÆ™˚
(
båfs_fs_öfo
 *
fs_öfo
)

1870 
	`•ö_lock_öô
(&
fs_öfo
->
bÆ™˚_lock
);

1871 
	`muãx_öô
(&
fs_öfo
->
bÆ™˚_muãx
);

1872 
	`©omic_£t
(&
fs_öfo
->
bÆ™˚_∑u£_ªq
, 0);

1873 
	`©omic_£t
(&
fs_öfo
->
bÆ™˚_ˇn˚l_ªq
, 0);

1874 
fs_öfo
->
bÆ™˚_˘l
 = 
NULL
;

1875 
	`öô_waôqueue_hód
(&
fs_öfo
->
bÆ™˚_waô_q
);

1876 
	`©omic_£t
(&
fs_öfo
->
ªloc_ˇn˚l_ªq
, 0);

1877 
	}
}

1879 
	$båfs_öô_båì_öode
(
su≥r_block
 *
sb
)

1881 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
sb
);

1882 
hash
 = 
	`båfs_öode_hash
(
BTRFS_BTREE_INODE_OBJECTID
,

1883 
fs_öfo
->
åì_roŸ
);

1884 
öode
 *inode;

1886 
öode
 = 
	`√w_öode
(
sb
);

1887 i‡(!
öode
)

1888  -
ENOMEM
;

1890 
öode
->
i_öo
 = 
BTRFS_BTREE_INODE_OBJECTID
;

1891 
	`£t_∆ök
(
öode
, 1);

1897 
öode
->
i_size
 = 
OFFSET_MAX
;

1898 
öode
->
i_m≠pög
->
a_›s
 = &
båì_a›s
;

1899 
	`m≠pög_£t_gÂ_mask
(
öode
->
i_m≠pög
, 
GFP_NOFS
);

1901 
	`RB_CLEAR_NODE
(&
	`BTRFS_I
(
öode
)->
rb_node
);

1902 
	`exã¡_io_åì_öô
(
fs_öfo
, &
	`BTRFS_I
(
öode
)->
io_åì
,

1903 
IO_TREE_BTREE_INODE_IO
);

1904 
	`exã¡_m≠_åì_öô
(&
	`BTRFS_I
(
öode
)->
exã¡_åì
);

1906 
	`BTRFS_I
(
öode
)->
roŸ
 = 
	`båfs_gøb_roŸ
(
fs_öfo
->
åì_roŸ
);

1907 
	`BTRFS_I
(
öode
)->
loˇti⁄
.
obje˘id
 = 
BTRFS_BTREE_INODE_OBJECTID
;

1908 
	`BTRFS_I
(
öode
)->
loˇti⁄
.
ty≥
 = 0;

1909 
	`BTRFS_I
(
öode
)->
loˇti⁄
.
off£t
 = 0;

1910 
	`£t_bô
(
BTRFS_INODE_DUMMY
, &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
);

1911 
	`__ö£π_öode_hash
(
öode
, 
hash
);

1912 
fs_öfo
->
båì_öode
 = 
öode
;

1915 
	}
}

1917 
	$båfs_öô_dev_ª∂a˚_locks
(
båfs_fs_öfo
 *
fs_öfo
)

1919 
	`muãx_öô
(&
fs_öfo
->
dev_ª∂a˚
.
lock_föishög_ˇn˚l_unmou¡
);

1920 
	`öô_rw£m
(&
fs_öfo
->
dev_ª∂a˚
.
rw£m
);

1921 
	`öô_waôqueue_hód
(&
fs_öfo
->
dev_ª∂a˚
.
ª∂a˚_waô
);

1922 
	}
}

1924 
	$båfs_öô_qgroup
(
båfs_fs_öfo
 *
fs_öfo
)

1926 
	`•ö_lock_öô
(&
fs_öfo
->
qgroup_lock
);

1927 
	`muãx_öô
(&
fs_öfo
->
qgroup_io˘l_lock
);

1928 
fs_öfo
->
qgroup_åì
 = 
RB_ROOT
;

1929 
	`INIT_LIST_HEAD
(&
fs_öfo
->
dúty_qgroups
);

1930 
fs_öfo
->
qgroup_£q
 = 1;

1931 
fs_öfo
->
qgroup_uli°
 = 
NULL
;

1932 
fs_öfo
->
qgroup_ªsˇn_ru¬ög
 = 
Ál£
;

1933 
fs_öfo
->
qgroup_dr›_subåì_thªs
 = 
BTRFS_MAX_LEVEL
;

1934 
	`muãx_öô
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

1935 
	}
}

1937 
	$båfs_öô_w‹kqueues
(
båfs_fs_öfo
 *
fs_öfo
)

1939 
u32
 
max_a˘ive
 = 
fs_öfo
->
thªad_poﬁ_size
;

1940 
Êags
 = 
WQ_MEM_RECLAIM
 | 
WQ_FREEZABLE
 | 
WQ_UNBOUND
;

1941 
‹dîed_Êags
 = 
WQ_MEM_RECLAIM
 | 
WQ_FREEZABLE
;

1943 
fs_öfo
->
w‹kîs
 =

1944 
	`båfs_Æloc_w‹kqueue
(
fs_öfo
, "w‹kî", 
Êags
, 
max_a˘ive
, 16);

1946 
fs_öfo
->
dñÆloc_w‹kîs
 =

1947 
	`båfs_Æloc_w‹kqueue
(
fs_öfo
, "delalloc",

1948 
Êags
, 
max_a˘ive
, 2);

1950 
fs_öfo
->
Êush_w‹kîs
 =

1951 
	`båfs_Æloc_w‹kqueue
(
fs_öfo
, "flush_delalloc",

1952 
Êags
, 
max_a˘ive
, 0);

1954 
fs_öfo
->
ˇchög_w‹kîs
 =

1955 
	`båfs_Æloc_w‹kqueue
(
fs_öfo
, "ˇche", 
Êags
, 
max_a˘ive
, 0);

1957 
fs_öfo
->
fixup_w‹kîs
 =

1958 
	`båfs_Æloc_‹dîed_w‹kqueue
(
fs_öfo
, "fixup", 
‹dîed_Êags
);

1960 
fs_öfo
->
ídio_w‹kîs
 =

1961 
	`Æloc_w‹kqueue
("båfs-ídio", 
Êags
, 
max_a˘ive
);

1962 
fs_öfo
->
ídio_mëa_w‹kîs
 =

1963 
	`Æloc_w‹kqueue
("båfs-ídio-mëa", 
Êags
, 
max_a˘ive
);

1964 
fs_öfo
->
rmw_w‹kîs
 = 
	`Æloc_w‹kqueue
("båfs-rmw", 
Êags
, 
max_a˘ive
);

1965 
fs_öfo
->
ídio_wrôe_w‹kîs
 =

1966 
	`båfs_Æloc_w‹kqueue
(
fs_öfo
, "ídio-wrôe", 
Êags
,

1967 
max_a˘ive
, 2);

1968 
fs_öfo
->
com¥es£d_wrôe_w‹kîs
 =

1969 
	`Æloc_w‹kqueue
("båfs-com¥es£d-wrôe", 
Êags
, 
max_a˘ive
);

1970 
fs_öfo
->
ídio_‰ì•a˚_w‹kî
 =

1971 
	`båfs_Æloc_w‹kqueue
(
fs_öfo
, "‰ì•a˚-wrôe", 
Êags
,

1972 
max_a˘ive
, 0);

1973 
fs_öfo
->
dñayed_w‹kîs
 =

1974 
	`båfs_Æloc_w‹kqueue
(
fs_öfo
, "dñayed-mëa", 
Êags
,

1975 
max_a˘ive
, 0);

1976 
fs_öfo
->
qgroup_ªsˇn_w‹kîs
 =

1977 
	`båfs_Æloc_‹dîed_w‹kqueue
(
fs_öfo
, "qgroup-rescan",

1978 
‹dîed_Êags
);

1979 
fs_öfo
->
disˇrd_˘l
.
disˇrd_w‹kîs
 =

1980 
	`Æloc_‹dîed_w‹kqueue
("båfs_disˇrd", 
WQ_FREEZABLE
);

1982 i‡(!(
fs_öfo
->
w‹kîs
 &&

1983 
fs_öfo
->
dñÆloc_w‹kîs
 && fs_öfo->
Êush_w‹kîs
 &&

1984 
fs_öfo
->
ídio_w‹kîs
 && fs_öfo->
ídio_mëa_w‹kîs
 &&

1985 
fs_öfo
->
com¥es£d_wrôe_w‹kîs
 &&

1986 
fs_öfo
->
ídio_wrôe_w‹kîs
 &&

1987 
fs_öfo
->
ídio_‰ì•a˚_w‹kî
 && fs_öfo->
rmw_w‹kîs
 &&

1988 
fs_öfo
->
ˇchög_w‹kîs
 && fs_öfo->
fixup_w‹kîs
 &&

1989 
fs_öfo
->
dñayed_w‹kîs
 && fs_öfo->
qgroup_ªsˇn_w‹kîs
 &&

1990 
fs_öfo
->
disˇrd_˘l
.
disˇrd_w‹kîs
)) {

1991  -
ENOMEM
;

1995 
	}
}

1997 
	$båfs_öô_csum_hash
(
båfs_fs_öfo
 *
fs_öfo
, 
u16
 
csum_ty≥
)

1999 
¸y±o_shash
 *
csum_shash
;

2000 c⁄° *
csum_drivî
 = 
	`båfs_su≥r_csum_drivî
(
csum_ty≥
);

2002 
csum_shash
 = 
	`¸y±o_Æloc_shash
(
csum_drivî
, 0, 0);

2004 i‡(
	`IS_ERR
(
csum_shash
)) {

2005 
	`båfs_îr
(
fs_öfo
, "errorállocating %s hash for checksum",

2006 
csum_drivî
);

2007  
	`PTR_ERR
(
csum_shash
);

2010 
fs_öfo
->
csum_shash
 = csum_shash;

2017 
csum_ty≥
) {

2018 
BTRFS_CSUM_TYPE_CRC32
:

2019 i‡(!
	`°r°r
(
	`¸y±o_shash_drivî_«me
(
csum_shash
), "generic"))

2020 
	`£t_bô
(
BTRFS_FS_CSUM_IMPL_FAST
, &
fs_öfo
->
Êags
);

2022 
BTRFS_CSUM_TYPE_XXHASH
:

2023 
	`£t_bô
(
BTRFS_FS_CSUM_IMPL_FAST
, &
fs_öfo
->
Êags
);

2029 
	`båfs_öfo
(
fs_öfo
, "using %s (%s) checksumálgorithm",

2030 
	`båfs_su≥r_csum_«me
(
csum_ty≥
),

2031 
	`¸y±o_shash_drivî_«me
(
csum_shash
));

2033 
	}
}

2035 
	$båfs_ª∂ay_log
(
båfs_fs_öfo
 *
fs_öfo
,

2036 
båfs_fs_devi˚s
 *
fs_devi˚s
)

2038 
ªt
;

2039 
båfs_åì_∑ª¡_check
 
check
 = { 0 };

2040 
båfs_roŸ
 *
log_åì_roŸ
;

2041 
båfs_su≥r_block
 *
disk_su≥r
 = 
fs_öfo
->
su≥r_c›y
;

2042 
u64
 
byãƒ
 = 
	`båfs_su≥r_log_roŸ
(
disk_su≥r
);

2043 
Àvñ
 = 
	`båfs_su≥r_log_roŸ_Àvñ
(
disk_su≥r
);

2045 i‡(
fs_devi˚s
->
rw_devi˚s
 == 0) {

2046 
	`båfs_w¨n
(
fs_öfo
, "logÑeplayÑequired on RO media");

2047  -
EIO
;

2050 
log_åì_roŸ
 = 
	`båfs_Æloc_roŸ
(
fs_öfo
, 
BTRFS_TREE_LOG_OBJECTID
,

2051 
GFP_KERNEL
);

2052 i‡(!
log_åì_roŸ
)

2053  -
ENOMEM
;

2055 
check
.
Àvñ
 =Üevel;

2056 
check
.
å™sid
 = 
fs_öfo
->
gíî©i⁄
 + 1;

2057 
check
.
ow√r_roŸ
 = 
BTRFS_TREE_LOG_OBJECTID
;

2058 
log_åì_roŸ
->
node
 = 
	`ªad_åì_block
(
fs_öfo
, 
byãƒ
, &
check
);

2059 i‡(
	`IS_ERR
(
log_åì_roŸ
->
node
)) {

2060 
	`båfs_w¨n
(
fs_öfo
, "failedÅoÑeadÜogÅree");

2061 
ªt
 = 
	`PTR_ERR
(
log_åì_roŸ
->
node
);

2062 
log_åì_roŸ
->
node
 = 
NULL
;

2063 
	`båfs_put_roŸ
(
log_åì_roŸ
);

2064  
ªt
;

2066 i‡(!
	`exã¡_buf„r_u±od©e
(
log_åì_roŸ
->
node
)) {

2067 
	`båfs_îr
(
fs_öfo
, "failedÅoÑeadÜogÅree");

2068 
	`båfs_put_roŸ
(
log_åì_roŸ
);

2069  -
EIO
;

2073 
ªt
 = 
	`båfs_ªcovî_log_åìs
(
log_åì_roŸ
);

2074 i‡(
ªt
) {

2075 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
ªt
,

2077 
	`båfs_put_roŸ
(
log_åì_roŸ
);

2078  
ªt
;

2081 i‡(
	`sb_rd⁄ly
(
fs_öfo
->
sb
)) {

2082 
ªt
 = 
	`båfs_commô_su≥r
(
fs_öfo
);

2083 i‡(
ªt
)

2084  
ªt
;

2088 
	}
}

2090 
	$lﬂd_globÆ_roŸs_obje˘id
(
båfs_roŸ
 *
åì_roŸ
,

2091 
båfs_∑th
 *
∑th
, 
u64
 
obje˘id
,

2092 c⁄° *
«me
)

2094 
båfs_fs_öfo
 *
fs_öfo
 = 
åì_roŸ
->fs_info;

2095 
båfs_roŸ
 *
roŸ
;

2096 
u64
 
max_globÆ_id
 = 0;

2097 
ªt
;

2098 
båfs_key
 
key
 = {

2099 .
obje˘id
 = objectid,

2100 .
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
,

2101 .
off£t
 = 0,

2103 
boﬁ
 
found
 = 
Ál£
;

2106 i‡(
obje˘id
 =
BTRFS_CSUM_TREE_OBJECTID
 &&

2107 
	`båfs_ã°_›t
(
fs_öfo
, 
IGNOREDATACSUMS
)) {

2108 
	`£t_bô
(
BTRFS_FS_STATE_NO_CSUMS
, &
fs_öfo
->
fs_°©e
);

2113 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
åì_roŸ
, &
key
, 
∑th
, 0, 0);

2114 i‡(
ªt
 < 0)

2117 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
’©h->
nodes
[0])) {

2118 
ªt
 = 
	`båfs_√xt_Àaf
(
åì_roŸ
, 
∑th
);

2119 i‡(
ªt
) {

2120 i‡(
ªt
 > 0)

2121 
ªt
 = 0;

2125 
ªt
 = 0;

2127 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

2128 i‡(
key
.
obje˘id
 != objectid)

2130 
	`båfs_ªÀa£_∑th
(
∑th
);

2136 i‡(
obje˘id
 =
BTRFS_EXTENT_TREE_OBJECTID
)

2137 
max_globÆ_id
 = 
	`max
(max_globÆ_id, 
key
.
off£t
);

2139 
found
 = 
åue
;

2140 
roŸ
 = 
	`ªad_åì_roŸ_∑th
(
åì_roŸ
, 
∑th
, &
key
);

2141 i‡(
	`IS_ERR
(
roŸ
)) {

2142 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
IGNOREBADROOTS
))

2143 
ªt
 = 
	`PTR_ERR
(
roŸ
);

2146 
	`£t_bô
(
BTRFS_ROOT_TRACK_DIRTY
, &
roŸ
->
°©e
);

2147 
ªt
 = 
	`båfs_globÆ_roŸ_ö£π
(
roŸ
);

2148 i‡(
ªt
) {

2149 
	`båfs_put_roŸ
(
roŸ
);

2152 
key
.
off£t
++;

2154 
	`båfs_ªÀa£_∑th
(
∑th
);

2156 i‡(
obje˘id
 =
BTRFS_EXTENT_TREE_OBJECTID
)

2157 
fs_öfo
->
ƒ_globÆ_roŸs
 = 
max_globÆ_id
 + 1;

2159 i‡(!
found
 || 
ªt
) {

2160 i‡(
obje˘id
 =
BTRFS_CSUM_TREE_OBJECTID
)

2161 
	`£t_bô
(
BTRFS_FS_STATE_NO_CSUMS
, &
fs_öfo
->
fs_°©e
);

2163 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
IGNOREBADROOTS
))

2164 
ªt
 =Ñë ?Ñë : -
ENOENT
;

2166 
ªt
 = 0;

2167 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿlﬂdÑoŸ %s", 
«me
);

2169  
ªt
;

2170 
	}
}

2172 
	$lﬂd_globÆ_roŸs
(
båfs_roŸ
 *
åì_roŸ
)

2174 
båfs_∑th
 *
∑th
;

2175 
ªt
 = 0;

2177 
∑th
 = 
	`båfs_Æloc_∑th
();

2178 i‡(!
∑th
)

2179  -
ENOMEM
;

2181 
ªt
 = 
	`lﬂd_globÆ_roŸs_obje˘id
(
åì_roŸ
, 
∑th
,

2182 
BTRFS_EXTENT_TREE_OBJECTID
, "extent");

2183 i‡(
ªt
)

2184 
out
;

2185 
ªt
 = 
	`lﬂd_globÆ_roŸs_obje˘id
(
åì_roŸ
, 
∑th
,

2186 
BTRFS_CSUM_TREE_OBJECTID
, "csum");

2187 i‡(
ªt
)

2188 
out
;

2189 i‡(!
	`båfs_fs_com∑t_ro
(
åì_roŸ
->
fs_öfo
, 
FREE_SPACE_TREE
))

2190 
out
;

2191 
ªt
 = 
	`lﬂd_globÆ_roŸs_obje˘id
(
åì_roŸ
, 
∑th
,

2192 
BTRFS_FREE_SPACE_TREE_OBJECTID
,

2194 
out
:

2195 
	`båfs_‰ì_∑th
(
∑th
);

2196  
ªt
;

2197 
	}
}

2199 
	$båfs_ªad_roŸs
(
båfs_fs_öfo
 *
fs_öfo
)

2201 
båfs_roŸ
 *
åì_roŸ
 = 
fs_öfo
->tree_root;

2202 
båfs_roŸ
 *
roŸ
;

2203 
båfs_key
 
loˇti⁄
;

2204 
ªt
;

2206 
	`BUG_ON
(!
fs_öfo
->
åì_roŸ
);

2208 
ªt
 = 
	`lﬂd_globÆ_roŸs
(
åì_roŸ
);

2209 i‡(
ªt
)

2210  
ªt
;

2212 
loˇti⁄
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

2213 
loˇti⁄
.
off£t
 = 0;

2215 i‡(
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
BLOCK_GROUP_TREE
)) {

2216 
loˇti⁄
.
obje˘id
 = 
BTRFS_BLOCK_GROUP_TREE_OBJECTID
;

2217 
roŸ
 = 
	`båfs_ªad_åì_roŸ
(
åì_roŸ
, &
loˇti⁄
);

2218 i‡(
	`IS_ERR
(
roŸ
)) {

2219 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
IGNOREBADROOTS
)) {

2220 
ªt
 = 
	`PTR_ERR
(
roŸ
);

2221 
out
;

2224 
	`£t_bô
(
BTRFS_ROOT_TRACK_DIRTY
, &
roŸ
->
°©e
);

2225 
fs_öfo
->
block_group_roŸ
 = 
roŸ
;

2229 
loˇti⁄
.
obje˘id
 = 
BTRFS_DEV_TREE_OBJECTID
;

2230 
roŸ
 = 
	`båfs_ªad_åì_roŸ
(
åì_roŸ
, &
loˇti⁄
);

2231 i‡(
	`IS_ERR
(
roŸ
)) {

2232 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
IGNOREBADROOTS
)) {

2233 
ªt
 = 
	`PTR_ERR
(
roŸ
);

2234 
out
;

2237 
	`£t_bô
(
BTRFS_ROOT_TRACK_DIRTY
, &
roŸ
->
°©e
);

2238 
fs_öfo
->
dev_roŸ
 = 
roŸ
;

2241 
ªt
 = 
	`båfs_öô_devi˚s_œã
(
fs_öfo
);

2242 i‡(
ªt
)

2243 
out
;

2249 
roŸ
 = 
	`båfs_gë_fs_roŸ
(
åì_roŸ
->
fs_öfo
,

2250 
BTRFS_DATA_RELOC_TREE_OBJECTID
, 
åue
);

2251 i‡(
	`IS_ERR
(
roŸ
)) {

2252 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
IGNOREBADROOTS
)) {

2253 
ªt
 = 
	`PTR_ERR
(
roŸ
);

2254 
out
;

2257 
	`£t_bô
(
BTRFS_ROOT_TRACK_DIRTY
, &
roŸ
->
°©e
);

2258 
fs_öfo
->
d©a_ªloc_roŸ
 = 
roŸ
;

2261 
loˇti⁄
.
obje˘id
 = 
BTRFS_QUOTA_TREE_OBJECTID
;

2262 
roŸ
 = 
	`båfs_ªad_åì_roŸ
(
åì_roŸ
, &
loˇti⁄
);

2263 i‡(!
	`IS_ERR
(
roŸ
)) {

2264 
	`£t_bô
(
BTRFS_ROOT_TRACK_DIRTY
, &
roŸ
->
°©e
);

2265 
	`£t_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
);

2266 
fs_öfo
->
quŸa_roŸ
 = 
roŸ
;

2269 
loˇti⁄
.
obje˘id
 = 
BTRFS_UUID_TREE_OBJECTID
;

2270 
roŸ
 = 
	`båfs_ªad_åì_roŸ
(
åì_roŸ
, &
loˇti⁄
);

2271 i‡(
	`IS_ERR
(
roŸ
)) {

2272 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
IGNOREBADROOTS
)) {

2273 
ªt
 = 
	`PTR_ERR
(
roŸ
);

2274 i‡(
ªt
 !-
ENOENT
)

2275 
out
;

2278 
	`£t_bô
(
BTRFS_ROOT_TRACK_DIRTY
, &
roŸ
->
°©e
);

2279 
fs_öfo
->
uuid_roŸ
 = 
roŸ
;

2283 
out
:

2284 
	`båfs_w¨n
(
fs_öfo
, "failedÅoÑeadÑoot (objectid=%llu): %d",

2285 
loˇti⁄
.
obje˘id
, 
ªt
);

2286  
ªt
;

2287 
	}
}

2299 
	$båfs_vÆid©e_su≥r
(
båfs_fs_öfo
 *
fs_öfo
,

2300 
båfs_su≥r_block
 *
sb
, 
múr‹_num
)

2302 
u64
 
nodesize
 = 
	`båfs_su≥r_nodesize
(
sb
);

2303 
u64
 
£˘‹size
 = 
	`båfs_su≥r_£˘‹size
(
sb
);

2304 
ªt
 = 0;

2306 i‡(
	`båfs_su≥r_magic
(
sb
Ë!
BTRFS_MAGIC
) {

2307 
	`båfs_îr
(
fs_öfo
, "no valid FS found");

2308 
ªt
 = -
EINVAL
;

2310 i‡(
	`båfs_su≥r_Êags
(
sb
Ë& ~
BTRFS_SUPER_FLAG_SUPP
) {

2311 
	`båfs_îr
(
fs_öfo
, "unrecognized or unsupported super flag: %llu",

2312 
	`båfs_su≥r_Êags
(
sb
Ë& ~
BTRFS_SUPER_FLAG_SUPP
);

2313 
ªt
 = -
EINVAL
;

2315 i‡(
	`båfs_su≥r_roŸ_Àvñ
(
sb
Ë>
BTRFS_MAX_LEVEL
) {

2316 
	`båfs_îr
(
fs_öfo
, "tree_rootÜevelÅoo big: %d >= %d",

2317 
	`båfs_su≥r_roŸ_Àvñ
(
sb
), 
BTRFS_MAX_LEVEL
);

2318 
ªt
 = -
EINVAL
;

2320 i‡(
	`båfs_su≥r_chunk_roŸ_Àvñ
(
sb
Ë>
BTRFS_MAX_LEVEL
) {

2321 
	`båfs_îr
(
fs_öfo
, "chunk_rootÜevelÅoo big: %d >= %d",

2322 
	`båfs_su≥r_chunk_roŸ_Àvñ
(
sb
), 
BTRFS_MAX_LEVEL
);

2323 
ªt
 = -
EINVAL
;

2325 i‡(
	`båfs_su≥r_log_roŸ_Àvñ
(
sb
Ë>
BTRFS_MAX_LEVEL
) {

2326 
	`båfs_îr
(
fs_öfo
, "log_rootÜevelÅoo big: %d >= %d",

2327 
	`båfs_su≥r_log_roŸ_Àvñ
(
sb
), 
BTRFS_MAX_LEVEL
);

2328 
ªt
 = -
EINVAL
;

2335 i‡(!
	`is_powî_of_2
(
£˘‹size
) || sectorsize < 4096 ||

2336 
£˘‹size
 > 
BTRFS_MAX_METADATA_BLOCKSIZE
) {

2337 
	`båfs_îr
(
fs_öfo
, "övÆid se˘‹sizê%Œu", 
£˘‹size
);

2338 
ªt
 = -
EINVAL
;

2349 i‡(
£˘‹size
 > 
PAGE_SIZE
 || (£˘‹sizê!
SZ_4K
 && sectorsize != PAGE_SIZE)) {

2350 
	`båfs_îr
(
fs_öfo
,

2352 
£˘‹size
, 
PAGE_SIZE
);

2353 
ªt
 = -
EINVAL
;

2356 i‡(!
	`is_powî_of_2
(
nodesize
Ë||Çodesizê< 
£˘‹size
 ||

2357 
nodesize
 > 
BTRFS_MAX_METADATA_BLOCKSIZE
) {

2358 
	`båfs_îr
(
fs_öfo
, "övÆidÇodesizê%Œu", 
nodesize
);

2359 
ªt
 = -
EINVAL
;

2361 i‡(
nodesize
 !
	`À32_to_˝u
(
sb
->
__unu£d_Àafsize
)) {

2362 
	`båfs_îr
(
fs_öfo
, "invalidÜeafsize %u, should be %llu",

2363 
	`À32_to_˝u
(
sb
->
__unu£d_Àafsize
), 
nodesize
);

2364 
ªt
 = -
EINVAL
;

2368 i‡(!
	`IS_ALIGNED
(
	`båfs_su≥r_roŸ
(
sb
), 
£˘‹size
)) {

2369 
	`båfs_w¨n
(
fs_öfo
, "tree_root block unaligned: %llu",

2370 
	`båfs_su≥r_roŸ
(
sb
));

2371 
ªt
 = -
EINVAL
;

2373 i‡(!
	`IS_ALIGNED
(
	`båfs_su≥r_chunk_roŸ
(
sb
), 
£˘‹size
)) {

2374 
	`båfs_w¨n
(
fs_öfo
, "chunk_root block unaligned: %llu",

2375 
	`båfs_su≥r_chunk_roŸ
(
sb
));

2376 
ªt
 = -
EINVAL
;

2378 i‡(!
	`IS_ALIGNED
(
	`båfs_su≥r_log_roŸ
(
sb
), 
£˘‹size
)) {

2379 
	`båfs_w¨n
(
fs_öfo
, "log_root block unaligned: %llu",

2380 
	`båfs_su≥r_log_roŸ
(
sb
));

2381 
ªt
 = -
EINVAL
;

2384 i‡(
	`memcmp
(
fs_öfo
->
fs_devi˚s
->
fsid
, 
sb
->fsid, 
BTRFS_FSID_SIZE
) != 0) {

2385 
	`båfs_îr
(
fs_öfo
,

2387 
sb
->
fsid
, 
fs_öfo
->
fs_devi˚s
->fsid);

2388 
ªt
 = -
EINVAL
;

2391 i‡(
	`memcmp
(
fs_öfo
->
fs_devi˚s
->
mëad©a_uuid
, 
	`båfs_sb_fsid_±r
(
sb
),

2392 
BTRFS_FSID_SIZE
) != 0) {

2393 
	`båfs_îr
(
fs_öfo
,

2395 
	`båfs_sb_fsid_±r
(
sb
), 
fs_öfo
->
fs_devi˚s
->
mëad©a_uuid
);

2396 
ªt
 = -
EINVAL
;

2399 i‡(
	`memcmp
(
fs_öfo
->
fs_devi˚s
->
mëad©a_uuid
, 
sb
->
dev_ôem
.
fsid
,

2400 
BTRFS_FSID_SIZE
) != 0) {

2401 
	`båfs_îr
(
fs_öfo
,

2403 
fs_öfo
->
fs_devi˚s
->
mëad©a_uuid
, 
sb
->
dev_ôem
.
fsid
);

2404 
ªt
 = -
EINVAL
;

2411 i‡(
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
BLOCK_GROUP_TREE
) &&

2412 (!
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE_VALID
) ||

2413 !
	`båfs_fs_öcom∑t
(
fs_öfo
, 
NO_HOLES
))) {

2414 
	`båfs_îr
(
fs_öfo
,

2416 
ªt
 = -
EINVAL
;

2423 i‡(
	`båfs_su≥r_byãs_u£d
(
sb
Ë< 6 * 
	`båfs_su≥r_nodesize
(sb)) {

2424 
	`båfs_îr
(
fs_öfo
, "bytes_used isÅoo small %llu",

2425 
	`båfs_su≥r_byãs_u£d
(
sb
));

2426 
ªt
 = -
EINVAL
;

2428 i‡(!
	`is_powî_of_2
(
	`båfs_su≥r_°rùesize
(
sb
))) {

2429 
	`båfs_îr
(
fs_öfo
, "invalid stripesize %u",

2430 
	`båfs_su≥r_°rùesize
(
sb
));

2431 
ªt
 = -
EINVAL
;

2433 i‡(
	`båfs_su≥r_num_devi˚s
(
sb
) > (1UL << 31))

2434 
	`båfs_w¨n
(
fs_öfo
, "suspiciousÇumber of devices: %llu",

2435 
	`båfs_su≥r_num_devi˚s
(
sb
));

2436 i‡(
	`båfs_su≥r_num_devi˚s
(
sb
) == 0) {

2437 
	`båfs_îr
(
fs_öfo
, "number of devices is 0");

2438 
ªt
 = -
EINVAL
;

2441 i‡(
múr‹_num
 >= 0 &&

2442 
	`båfs_su≥r_byãƒ
(
sb
Ë!
	`båfs_sb_off£t
(
múr‹_num
)) {

2443 
	`båfs_îr
(
fs_öfo
, "super offset mismatch %llu != %u",

2444 
	`båfs_su≥r_byãƒ
(
sb
), 
BTRFS_SUPER_INFO_OFFSET
);

2445 
ªt
 = -
EINVAL
;

2452 i‡(
	`båfs_su≥r_sys_¨øy_size
(
sb
Ë> 
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
) {

2453 
	`båfs_îr
(
fs_öfo
, "system chunkárrayÅoo big %u > %u",

2454 
	`båfs_su≥r_sys_¨øy_size
(
sb
),

2455 
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
);

2456 
ªt
 = -
EINVAL
;

2458 i‡(
	`båfs_su≥r_sys_¨øy_size
(
sb
Ë< (
båfs_disk_key
)

2459 + (
båfs_chunk
)) {

2460 
	`båfs_îr
(
fs_öfo
, "system chunkárrayÅoo small %u < %zu",

2461 
	`båfs_su≥r_sys_¨øy_size
(
sb
),

2462 (
båfs_disk_key
)

2463 + (
båfs_chunk
));

2464 
ªt
 = -
EINVAL
;

2471 i‡(
	`båfs_su≥r_gíî©i⁄
(
sb
Ë< 
	`båfs_su≥r_chunk_roŸ_gíî©i⁄
(sb))

2472 
	`båfs_w¨n
(
fs_öfo
,

2474 
	`båfs_su≥r_gíî©i⁄
(
sb
),

2475 
	`båfs_su≥r_chunk_roŸ_gíî©i⁄
(
sb
));

2476 i‡(
	`båfs_su≥r_gíî©i⁄
(
sb
Ë< 
	`båfs_su≥r_ˇche_gíî©i⁄
(sb)

2477 && 
	`båfs_su≥r_ˇche_gíî©i⁄
(
sb
Ë!(
u64
)-1)

2478 
	`båfs_w¨n
(
fs_öfo
,

2480 
	`båfs_su≥r_gíî©i⁄
(
sb
),

2481 
	`båfs_su≥r_ˇche_gíî©i⁄
(
sb
));

2483  
ªt
;

2484 
	}
}

2487 
	$båfs_vÆid©e_su≥r_∑πôi⁄
(
båfs_fs_öfo
 *
fs_öfo
,

2488 
båfs_su≥r_block
 *
sb
, 
múr‹_num
, 
∑πôi⁄_‹dî
)

2490 
u64
 
nodesize
 = 
	`båfs_su≥r_nodesize
(
sb
);

2491 
u64
 
£˘‹size
 = 
	`båfs_su≥r_£˘‹size
(
sb
);

2492 
ªt
 = 0;

2494 i‡(
	`båfs_su≥r_magic
(
sb
Ë!
BTRFS_MAGIC
) {

2495 
	`båfs_îr
(
fs_öfo
, "no valid FS found");

2496 
ªt
 = -
EINVAL
;

2498 i‡(
	`båfs_su≥r_Êags
(
sb
Ë& ~
BTRFS_SUPER_FLAG_SUPP
) {

2499 
	`båfs_îr
(
fs_öfo
, "unrecognized or unsupported super flag: %llu",

2500 
	`båfs_su≥r_Êags
(
sb
Ë& ~
BTRFS_SUPER_FLAG_SUPP
);

2501 
ªt
 = -
EINVAL
;

2503 i‡(
	`båfs_su≥r_roŸ_Àvñ
(
sb
Ë>
BTRFS_MAX_LEVEL
) {

2504 
	`båfs_îr
(
fs_öfo
, "tree_rootÜevelÅoo big: %d >= %d",

2505 
	`båfs_su≥r_roŸ_Àvñ
(
sb
), 
BTRFS_MAX_LEVEL
);

2506 
ªt
 = -
EINVAL
;

2508 i‡(
	`båfs_su≥r_chunk_roŸ_Àvñ
(
sb
Ë>
BTRFS_MAX_LEVEL
) {

2509 
	`båfs_îr
(
fs_öfo
, "chunk_rootÜevelÅoo big: %d >= %d",

2510 
	`båfs_su≥r_chunk_roŸ_Àvñ
(
sb
), 
BTRFS_MAX_LEVEL
);

2511 
ªt
 = -
EINVAL
;

2513 i‡(
	`båfs_su≥r_log_roŸ_Àvñ
(
sb
Ë>
BTRFS_MAX_LEVEL
) {

2514 
	`båfs_îr
(
fs_öfo
, "log_rootÜevelÅoo big: %d >= %d",

2515 
	`båfs_su≥r_log_roŸ_Àvñ
(
sb
), 
BTRFS_MAX_LEVEL
);

2516 
ªt
 = -
EINVAL
;

2523 i‡(!
	`is_powî_of_2
(
£˘‹size
) || sectorsize < 4096 ||

2524 
£˘‹size
 > 
BTRFS_MAX_METADATA_BLOCKSIZE
) {

2525 
	`båfs_îr
(
fs_öfo
, "övÆid se˘‹sizê%Œu", 
£˘‹size
);

2526 
ªt
 = -
EINVAL
;

2537 i‡(
£˘‹size
 > 
PAGE_SIZE
 || (£˘‹sizê!
SZ_4K
 && sectorsize != PAGE_SIZE)) {

2538 
	`båfs_îr
(
fs_öfo
,

2540 
£˘‹size
, 
PAGE_SIZE
);

2541 
ªt
 = -
EINVAL
;

2544 i‡(!
	`is_powî_of_2
(
nodesize
Ë||Çodesizê< 
£˘‹size
 ||

2545 
nodesize
 > 
BTRFS_MAX_METADATA_BLOCKSIZE
) {

2546 
	`båfs_îr
(
fs_öfo
, "övÆidÇodesizê%Œu", 
nodesize
);

2547 
ªt
 = -
EINVAL
;

2549 i‡(
nodesize
 !
	`À32_to_˝u
(
sb
->
__unu£d_Àafsize
)) {

2550 
	`båfs_îr
(
fs_öfo
, "invalidÜeafsize %u, should be %llu",

2551 
	`À32_to_˝u
(
sb
->
__unu£d_Àafsize
), 
nodesize
);

2552 
ªt
 = -
EINVAL
;

2556 i‡(!
	`IS_ALIGNED
(
	`båfs_su≥r_roŸ
(
sb
), 
£˘‹size
)) {

2557 
	`båfs_w¨n
(
fs_öfo
, "tree_root block unaligned: %llu",

2558 
	`båfs_su≥r_roŸ
(
sb
));

2559 
ªt
 = -
EINVAL
;

2561 i‡(!
	`IS_ALIGNED
(
	`båfs_su≥r_chunk_roŸ
(
sb
), 
£˘‹size
)) {

2562 
	`båfs_w¨n
(
fs_öfo
, "chunk_root block unaligned: %llu",

2563 
	`båfs_su≥r_chunk_roŸ
(
sb
));

2564 
ªt
 = -
EINVAL
;

2566 i‡(!
	`IS_ALIGNED
(
	`båfs_su≥r_log_roŸ
(
sb
), 
£˘‹size
)) {

2567 
	`båfs_w¨n
(
fs_öfo
, "log_root block unaligned: %llu",

2568 
	`båfs_su≥r_log_roŸ
(
sb
));

2569 
ªt
 = -
EINVAL
;

2572 i‡(
	`memcmp
(
fs_öfo
->
fs_devi˚s
->
fsid
, 
sb
->fsid, 
BTRFS_FSID_SIZE
) != 0) {

2573 
	`båfs_îr
(
fs_öfo
,

2575 
sb
->
fsid
, 
fs_öfo
->
fs_devi˚s
->fsid);

2576 
ªt
 = -
EINVAL
;

2579 i‡(
	`memcmp
(
fs_öfo
->
fs_devi˚s
->
mëad©a_uuid
, 
	`båfs_sb_fsid_±r
(
sb
),

2580 
BTRFS_FSID_SIZE
) != 0) {

2581 
	`båfs_îr
(
fs_öfo
,

2583 
	`båfs_sb_fsid_±r
(
sb
), 
fs_öfo
->
fs_devi˚s
->
mëad©a_uuid
);

2584 
ªt
 = -
EINVAL
;

2587 i‡(
	`memcmp
(
fs_öfo
->
fs_devi˚s
->
mëad©a_uuid
, 
sb
->
dev_ôem
.
fsid
,

2588 
BTRFS_FSID_SIZE
) != 0) {

2589 
	`båfs_îr
(
fs_öfo
,

2591 
fs_öfo
->
fs_devi˚s
->
mëad©a_uuid
, 
sb
->
dev_ôem
.
fsid
);

2592 
ªt
 = -
EINVAL
;

2599 i‡(
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
BLOCK_GROUP_TREE
) &&

2600 (!
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE_VALID
) ||

2601 !
	`båfs_fs_öcom∑t
(
fs_öfo
, 
NO_HOLES
))) {

2602 
	`båfs_îr
(
fs_öfo
,

2604 
ªt
 = -
EINVAL
;

2611 i‡(
	`båfs_su≥r_byãs_u£d
(
sb
Ë< 6 * 
	`båfs_su≥r_nodesize
(sb)) {

2612 
	`båfs_îr
(
fs_öfo
, "bytes_used isÅoo small %llu",

2613 
	`båfs_su≥r_byãs_u£d
(
sb
));

2614 
ªt
 = -
EINVAL
;

2616 i‡(!
	`is_powî_of_2
(
	`båfs_su≥r_°rùesize
(
sb
))) {

2617 
	`båfs_îr
(
fs_öfo
, "invalid stripesize %u",

2618 
	`båfs_su≥r_°rùesize
(
sb
));

2619 
ªt
 = -
EINVAL
;

2621 i‡(
	`båfs_su≥r_num_devi˚s
(
sb
) > (1UL << 31))

2622 
	`båfs_w¨n
(
fs_öfo
, "suspiciousÇumber of devices: %llu",

2623 
	`båfs_su≥r_num_devi˚s
(
sb
));

2624 i‡(
	`båfs_su≥r_num_devi˚s
(
sb
) == 0) {

2625 
	`båfs_îr
(
fs_öfo
, "number of devices is 0");

2626 
ªt
 = -
EINVAL
;

2629 
u64
 
sb_off£t
 = 
BTRFS_SUPER_INFO_SIZE
 * 
∑πôi⁄_‹dî
;

2630 i‡(
múr‹_num
 >= 0 &&

2631 
	`båfs_su≥r_byãƒ
(
sb
Ë!
	`båfs_sb_off£t_∑πôi⁄
(
múr‹_num
, 
sb_off£t
)) {

2632 
	`båfs_îr
(
fs_öfo
, "super offset mismatch %llu != %u",

2633 
	`båfs_su≥r_byãƒ
(
sb
), 
BTRFS_SUPER_INFO_OFFSET
);

2634 
ªt
 = -
EINVAL
;

2641 i‡(
	`båfs_su≥r_sys_¨øy_size
(
sb
Ë> 
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
) {

2642 
	`båfs_îr
(
fs_öfo
, "system chunkárrayÅoo big %u > %u",

2643 
	`båfs_su≥r_sys_¨øy_size
(
sb
),

2644 
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
);

2645 
ªt
 = -
EINVAL
;

2647 i‡(
	`båfs_su≥r_sys_¨øy_size
(
sb
Ë< (
båfs_disk_key
)

2648 + (
båfs_chunk
)) {

2649 
	`båfs_îr
(
fs_öfo
, "system chunkárrayÅoo small %u < %zu",

2650 
	`båfs_su≥r_sys_¨øy_size
(
sb
),

2651 (
båfs_disk_key
)

2652 + (
båfs_chunk
));

2653 
ªt
 = -
EINVAL
;

2660 i‡(
	`båfs_su≥r_gíî©i⁄
(
sb
Ë< 
	`båfs_su≥r_chunk_roŸ_gíî©i⁄
(sb))

2661 
	`båfs_w¨n
(
fs_öfo
,

2663 
	`båfs_su≥r_gíî©i⁄
(
sb
),

2664 
	`båfs_su≥r_chunk_roŸ_gíî©i⁄
(
sb
));

2665 i‡(
	`båfs_su≥r_gíî©i⁄
(
sb
Ë< 
	`båfs_su≥r_ˇche_gíî©i⁄
(sb)

2666 && 
	`båfs_su≥r_ˇche_gíî©i⁄
(
sb
Ë!(
u64
)-1)

2667 
	`båfs_w¨n
(
fs_öfo
,

2669 
	`båfs_su≥r_gíî©i⁄
(
sb
),

2670 
	`båfs_su≥r_ˇche_gíî©i⁄
(
sb
));

2672  
ªt
;

2673 
	}
}

2680 
	$båfs_vÆid©e_mou¡_su≥r
(
båfs_fs_öfo
 *
fs_öfo
)

2682  
	`båfs_vÆid©e_su≥r
(
fs_öfo
, fs_öfo->
su≥r_c›y
, 0);

2683 
	}
}

2686 
	$båfs_vÆid©e_mou¡_su≥r_∑πôi⁄
(
båfs_fs_öfo
 *
fs_öfo
, 
∑πôi⁄_‹dî
)

2688  
	`båfs_vÆid©e_su≥r_∑πôi⁄
(
fs_öfo
, fs_öfo->
su≥r_c›y
, 0, 
∑πôi⁄_‹dî
);

2689 
	}
}

2697 
	$båfs_vÆid©e_wrôe_su≥r
(
båfs_fs_öfo
 *
fs_öfo
,

2698 
båfs_su≥r_block
 *
sb
)

2700 
ªt
;

2702 
ªt
 = 
	`båfs_vÆid©e_su≥r
(
fs_öfo
, 
sb
, -1);

2703 i‡(
ªt
 < 0)

2704 
out
;

2705 i‡(!
	`båfs_suµ‹ãd_su≥r_csum
(
	`båfs_su≥r_csum_ty≥
(
sb
))) {

2706 
ªt
 = -
EUCLEAN
;

2707 
	`båfs_îr
(
fs_öfo
, "invalid csumÅype, has %u want %u",

2708 
	`båfs_su≥r_csum_ty≥
(
sb
), 
BTRFS_CSUM_TYPE_CRC32
);

2709 
out
;

2711 i‡(
	`båfs_su≥r_öcom∑t_Êags
(
sb
Ë& ~
BTRFS_FEATURE_INCOMPAT_SUPP
) {

2712 
ªt
 = -
EUCLEAN
;

2713 
	`båfs_îr
(
fs_öfo
,

2715 
	`båfs_su≥r_öcom∑t_Êags
(
sb
),

2716 ()
BTRFS_FEATURE_INCOMPAT_SUPP
);

2717 
out
;

2719 
out
:

2720 i‡(
ªt
 < 0)

2721 
	`båfs_îr
(
fs_öfo
,

2723  
ªt
;

2724 
	}
}

2726 
	$lﬂd_su≥r_roŸ
(
båfs_roŸ
 *
roŸ
, 
u64
 
byãƒ
, u64 
gí
, 
Àvñ
)

2728 
båfs_åì_∑ª¡_check
 
check
 = {

2729 .
Àvñ
 =Üevel,

2730 .
å™sid
 = 
gí
,

2731 .
ow√r_roŸ
 = 
roŸ
->
roŸ_key
.
obje˘id


2733 
ªt
 = 0;

2735 
roŸ
->
node
 = 
	`ªad_åì_block
‘oŸ->
fs_öfo
, 
byãƒ
, &
check
);

2736 i‡(
	`IS_ERR
(
roŸ
->
node
)) {

2737 
ªt
 = 
	`PTR_ERR
(
roŸ
->
node
);

2738 
roŸ
->
node
 = 
NULL
;

2739  
ªt
;

2741 i‡(!
	`exã¡_buf„r_u±od©e
(
roŸ
->
node
)) {

2742 
	`‰ì_exã¡_buf„r
(
roŸ
->
node
);

2743 
roŸ
->
node
 = 
NULL
;

2744  -
EIO
;

2747 
	`båfs_£t_roŸ_node
(&
roŸ
->
roŸ_ôem
,ÑoŸ->
node
);

2748 
roŸ
->
commô_roŸ
 = 
	`båfs_roŸ_node
(root);

2749 
	`båfs_£t_roŸ_ªfs
(&
roŸ
->
roŸ_ôem
, 1);

2750  
ªt
;

2751 
	}
}

2753 
	$lﬂd_imp‹è¡_roŸs
(
båfs_fs_öfo
 *
fs_öfo
)

2755 
båfs_su≥r_block
 *
sb
 = 
fs_öfo
->
su≥r_c›y
;

2756 
u64
 
gí
, 
byãƒ
;

2757 
Àvñ
, 
ªt
;

2759 
byãƒ
 = 
	`båfs_su≥r_roŸ
(
sb
);

2760 
gí
 = 
	`båfs_su≥r_gíî©i⁄
(
sb
);

2761 
Àvñ
 = 
	`båfs_su≥r_roŸ_Àvñ
(
sb
);

2762 
ªt
 = 
	`lﬂd_su≥r_roŸ
(
fs_öfo
->
åì_roŸ
, 
byãƒ
, 
gí
, 
Àvñ
);

2763 i‡(
ªt
) {

2764 
	`båfs_w¨n
(
fs_öfo
, "couldn'tÑeadÅreeÑoot");

2765  
ªt
;

2768 
	}
}

2770 
__cﬁd
 
	$öô_åì_roŸs
(
båfs_fs_öfo
 *
fs_öfo
)

2772 
backup_ödex
 = 
	`föd_√we°_su≥r_backup
(
fs_öfo
);

2773 
båfs_su≥r_block
 *
sb
 = 
fs_öfo
->
su≥r_c›y
;

2774 
båfs_roŸ
 *
åì_roŸ
 = 
fs_öfo
->tree_root;

2775 
boﬁ
 
h™dÀ_îr‹
 = 
Ál£
;

2776 
ªt
 = 0;

2777 
i
;

2779 
i
 = 0; i < 
BTRFS_NUM_BACKUP_ROOTS
; i++) {

2780 i‡(
h™dÀ_îr‹
) {

2781 i‡(!
	`IS_ERR
(
åì_roŸ
->
node
))

2782 
	`‰ì_exã¡_buf„r
(
åì_roŸ
->
node
);

2783 
åì_roŸ
->
node
 = 
NULL
;

2785 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
USEBACKUPROOT
))

2788 
	`‰ì_roŸ_poöãrs
(
fs_öfo
, 0);

2794 
	`båfs_£t_su≥r_log_roŸ
(
sb
, 0);

2797 
	`båfs_£t_›t
(
fs_öfo
->
mou¡_›t
, 
CLEAR_CACHE
);

2799 
	`båfs_w¨n
(
fs_öfo
, "åyÅÿlﬂd backu∞roŸ†¶Ÿ %d", 
i
);

2800 
ªt
 = 
	`ªad_backup_roŸ
(
fs_öfo
, 
i
);

2801 
backup_ödex
 = 
ªt
;

2802 i‡(
ªt
 < 0)

2803  
ªt
;

2806 
ªt
 = 
	`lﬂd_imp‹è¡_roŸs
(
fs_öfo
);

2807 i‡(
ªt
) {

2808 
h™dÀ_îr‹
 = 
åue
;

2816 
ªt
 = 
	`båfs_öô_roŸ_‰ì_obje˘id
(
åì_roŸ
);

2817 i‡(
ªt
 < 0) {

2818 
h™dÀ_îr‹
 = 
åue
;

2822 
	`ASSERT
(
åì_roŸ
->
‰ì_obje˘id
 <
BTRFS_LAST_FREE_OBJECTID
);

2824 
ªt
 = 
	`båfs_ªad_roŸs
(
fs_öfo
);

2825 i‡(
ªt
 < 0) {

2826 
h™dÀ_îr‹
 = 
åue
;

2831 
fs_öfo
->
gíî©i⁄
 = 
	`båfs_hódî_gíî©i⁄
(
åì_roŸ
->
node
);

2832 
fs_öfo
->
œ°_å™s_commôãd
 = fs_öfo->
gíî©i⁄
;

2833 
fs_öfo
->
œ°_ªloc_å™s
 = 0;

2836 i‡(
backup_ödex
 < 0) {

2837 
fs_öfo
->
backup_roŸ_ödex
 = 0;

2839 
fs_öfo
->
backup_roŸ_ödex
 = 
backup_ödex
 + 1;

2840 
fs_öfo
->
backup_roŸ_ödex
 %
BTRFS_NUM_BACKUP_ROOTS
;

2845  
ªt
;

2846 
	}
}

2848 
	$båfs_öô_fs_öfo
(
båfs_fs_öfo
 *
fs_öfo
)

2850 
	`INIT_RADIX_TREE
(&
fs_öfo
->
fs_roŸs_ødix
, 
GFP_ATOMIC
);

2851 
	`INIT_RADIX_TREE
(&
fs_öfo
->
buf„r_ødix
, 
GFP_ATOMIC
);

2852 
	`INIT_LIST_HEAD
(&
fs_öfo
->
å™s_li°
);

2853 
	`INIT_LIST_HEAD
(&
fs_öfo
->
dód_roŸs
);

2854 
	`INIT_LIST_HEAD
(&
fs_öfo
->
dñayed_ùuts
);

2855 
	`INIT_LIST_HEAD
(&
fs_öfo
->
dñÆloc_roŸs
);

2856 
	`INIT_LIST_HEAD
(&
fs_öfo
->
ˇchög_block_groups
);

2857 
	`•ö_lock_öô
(&
fs_öfo
->
dñÆloc_roŸ_lock
);

2858 
	`•ö_lock_öô
(&
fs_öfo
->
å™s_lock
);

2859 
	`•ö_lock_öô
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

2860 
	`•ö_lock_öô
(&
fs_öfo
->
dñayed_ùut_lock
);

2861 
	`•ö_lock_öô
(&
fs_öfo
->
de‰ag_öodes_lock
);

2862 
	`•ö_lock_öô
(&
fs_öfo
->
su≥r_lock
);

2863 
	`•ö_lock_öô
(&
fs_öfo
->
buf„r_lock
);

2864 
	`•ö_lock_öô
(&
fs_öfo
->
unu£d_bgs_lock
);

2865 
	`•ö_lock_öô
(&
fs_öfo
->
åìlog_bg_lock
);

2866 
	`•ö_lock_öô
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

2867 
	`•ö_lock_öô
(&
fs_öfo
->
ªloˇti⁄_bg_lock
);

2868 
	`rwlock_öô
(&
fs_öfo
->
åì_mod_log_lock
);

2869 
	`rwlock_öô
(&
fs_öfo
->
globÆ_roŸ_lock
);

2870 
	`muãx_öô
(&
fs_öfo
->
unu£d_bg_u≈ö_muãx
);

2871 
	`muãx_öô
(&
fs_öfo
->
ª˛aim_bgs_lock
);

2872 
	`muãx_öô
(&
fs_öfo
->
ªloc_muãx
);

2873 
	`muãx_öô
(&
fs_öfo
->
dñÆloc_roŸ_muãx
);

2874 
	`muãx_öô
(&
fs_öfo
->
z⁄ed_mëa_io_lock
);

2875 
	`muãx_öô
(&
fs_öfo
->
z⁄ed_d©a_ªloc_io_lock
);

2876 
	`£qlock_öô
(&
fs_öfo
->
¥ofûes_lock
);

2878 
	`båfs_lockdï_öô_m≠
(
fs_öfo
, 
båfs_å™s_num_wrôîs
);

2879 
	`båfs_lockdï_öô_m≠
(
fs_öfo
, 
båfs_å™s_num_extwrôîs
);

2880 
	`båfs_lockdï_öô_m≠
(
fs_öfo
, 
båfs_å™s_≥ndög_‹dîed
);

2881 
	`båfs_lockdï_öô_m≠
(
fs_öfo
, 
båfs_‹dîed_exã¡
);

2882 
	`båfs_°©e_lockdï_öô_m≠
(
fs_öfo
, 
båfs_å™s_commô_¥ï
,

2883 
BTRFS_LOCKDEP_TRANS_COMMIT_PREP
);

2884 
	`båfs_°©e_lockdï_öô_m≠
(
fs_öfo
, 
båfs_å™s_unblocked
,

2885 
BTRFS_LOCKDEP_TRANS_UNBLOCKED
);

2886 
	`båfs_°©e_lockdï_öô_m≠
(
fs_öfo
, 
båfs_å™s_su≥r_commôãd
,

2887 
BTRFS_LOCKDEP_TRANS_SUPER_COMMITTED
);

2888 
	`båfs_°©e_lockdï_öô_m≠
(
fs_öfo
, 
båfs_å™s_com∂ëed
,

2889 
BTRFS_LOCKDEP_TRANS_COMPLETED
);

2891 
	`INIT_LIST_HEAD
(&
fs_öfo
->
dúty_cow⁄ly_roŸs
);

2892 
	`INIT_LIST_HEAD
(&
fs_öfo
->
•a˚_öfo
);

2893 
	`INIT_LIST_HEAD
(&
fs_öfo
->
åì_mod_£q_li°
);

2894 
	`INIT_LIST_HEAD
(&
fs_öfo
->
unu£d_bgs
);

2895 
	`INIT_LIST_HEAD
(&
fs_öfo
->
ª˛aim_bgs
);

2896 
	`INIT_LIST_HEAD
(&
fs_öfo
->
z⁄e_a˘ive_bgs
);

2897 #ifde‡
CONFIG_BTRFS_DEBUG


2898 
	`INIT_LIST_HEAD
(&
fs_öfo
->
Æloˇãd_roŸs
);

2899 
	`INIT_LIST_HEAD
(&
fs_öfo
->
Æloˇãd_ebs
);

2900 
	`•ö_lock_öô
(&
fs_öfo
->
eb_Àak_lock
);

2902 
	`exã¡_m≠_åì_öô
(&
fs_öfo
->
m≠pög_åì
);

2903 
	`båfs_öô_block_rsv
(&
fs_öfo
->
globÆ_block_rsv
,

2904 
BTRFS_BLOCK_RSV_GLOBAL
);

2905 
	`båfs_öô_block_rsv
(&
fs_öfo
->
å™s_block_rsv
, 
BTRFS_BLOCK_RSV_TRANS
);

2906 
	`båfs_öô_block_rsv
(&
fs_öfo
->
chunk_block_rsv
, 
BTRFS_BLOCK_RSV_CHUNK
);

2907 
	`båfs_öô_block_rsv
(&
fs_öfo
->
em±y_block_rsv
, 
BTRFS_BLOCK_RSV_EMPTY
);

2908 
	`båfs_öô_block_rsv
(&
fs_öfo
->
dñayed_block_rsv
,

2909 
BTRFS_BLOCK_RSV_DELOPS
);

2910 
	`båfs_öô_block_rsv
(&
fs_öfo
->
dñayed_ªfs_rsv
,

2911 
BTRFS_BLOCK_RSV_DELREFS
);

2913 
	`©omic_£t
(&
fs_öfo
->
async_dñÆloc_∑ges
, 0);

2914 
	`©omic_£t
(&
fs_öfo
->
de‰ag_ru¬ög
, 0);

2915 
	`©omic_£t
(&
fs_öfo
->
ƒ_dñayed_ùuts
, 0);

2916 
	`©omic64_£t
(&
fs_öfo
->
åì_mod_£q
, 0);

2917 
fs_öfo
->
globÆ_roŸ_åì
 = 
RB_ROOT
;

2918 
fs_öfo
->
max_ölöe
 = 
BTRFS_DEFAULT_MAX_INLINE
;

2919 
fs_öfo
->
mëad©a_øtio
 = 0;

2920 
fs_öfo
->
de‰ag_öodes
 = 
RB_ROOT
;

2921 
	`©omic64_£t
(&
fs_öfo
->
‰ì_chunk_•a˚
, 0);

2922 
fs_öfo
->
åì_mod_log
 = 
RB_ROOT
;

2923 
fs_öfo
->
commô_öãrvÆ
 = 
BTRFS_DEFAULT_COMMIT_INTERVAL
;

2924 
	`båfs_öô_ªf_vîify
(
fs_öfo
);

2926 
fs_öfo
->
thªad_poﬁ_size
 = 
	`mö_t
(,

2927 
	`num_⁄löe_˝us
() + 2, 8);

2929 
	`INIT_LIST_HEAD
(&
fs_öfo
->
‹dîed_roŸs
);

2930 
	`•ö_lock_öô
(&
fs_öfo
->
‹dîed_roŸ_lock
);

2932 
	`båfs_öô_s¸ub
(
fs_öfo
);

2933 #ifde‡
CONFIG_BTRFS_FS_CHECK_INTEGRITY


2934 
fs_öfo
->
check_öãgrôy_¥öt_mask
 = 0;

2936 
	`båfs_öô_bÆ™˚
(
fs_öfo
);

2937 
	`båfs_öô_async_ª˛aim_w‹k
(
fs_öfo
);

2939 
	`rwlock_öô
(&
fs_öfo
->
block_group_ˇche_lock
);

2940 
fs_öfo
->
block_group_ˇche_åì
 = 
RB_ROOT_CACHED
;

2942 
	`exã¡_io_åì_öô
(
fs_öfo
, &fs_öfo->
ex˛uded_exã¡s
,

2943 
IO_TREE_FS_EXCLUDED_EXTENTS
);

2945 
	`muãx_öô
(&
fs_öfo
->
‹dîed_›î©i⁄s_muãx
);

2946 
	`muãx_öô
(&
fs_öfo
->
åì_log_muãx
);

2947 
	`muãx_öô
(&
fs_öfo
->
chunk_muãx
);

2948 
	`muãx_öô
(&
fs_öfo
->
å™ß˘i⁄_kthªad_muãx
);

2949 
	`muãx_öô
(&
fs_öfo
->
˛ó√r_muãx
);

2950 
	`muãx_öô
(&
fs_öfo
->
ro_block_group_muãx
);

2951 
	`öô_rw£m
(&
fs_öfo
->
commô_roŸ_£m
);

2952 
	`öô_rw£m
(&
fs_öfo
->
˛ónup_w‹k_£m
);

2953 
	`öô_rw£m
(&
fs_öfo
->
subvﬁ_£m
);

2954 
	`£ma_öô
(&
fs_öfo
->
uuid_åì_ªsˇn_£m
, 1);

2956 
	`båfs_öô_dev_ª∂a˚_locks
(
fs_öfo
);

2957 
	`båfs_öô_qgroup
(
fs_öfo
);

2958 
	`båfs_disˇrd_öô
(
fs_öfo
);

2960 
	`båfs_öô_‰ì_˛u°î
(&
fs_öfo
->
mëa_Æloc_˛u°î
);

2961 
	`båfs_öô_‰ì_˛u°î
(&
fs_öfo
->
d©a_Æloc_˛u°î
);

2963 
	`öô_waôqueue_hód
(&
fs_öfo
->
å™ß˘i⁄_thrŸée
);

2964 
	`öô_waôqueue_hód
(&
fs_öfo
->
å™ß˘i⁄_waô
);

2965 
	`öô_waôqueue_hód
(&
fs_öfo
->
å™ß˘i⁄_blocked_waô
);

2966 
	`öô_waôqueue_hód
(&
fs_öfo
->
async_submô_waô
);

2967 
	`öô_waôqueue_hód
(&
fs_öfo
->
dñayed_ùuts_waô
);

2970 
fs_öfo
->
nodesize
 = 4096;

2971 
fs_öfo
->
£˘‹size
 = 4096;

2972 
fs_öfo
->
£˘‹size_bôs
 = 
	`ûog2
(4096);

2973 
fs_öfo
->
°rùesize
 = 4096;

2975 
fs_öfo
->
max_exã¡_size
 = 
BTRFS_MAX_EXTENT_SIZE
;

2977 
	`•ö_lock_öô
(&
fs_öfo
->
sw≠fûe_pös_lock
);

2978 
fs_öfo
->
sw≠fûe_pös
 = 
RB_ROOT
;

2980 
fs_öfo
->
bg_ª˛aim_thªshﬁd
 = 
BTRFS_DEFAULT_RECLAIM_THRESH
;

2981 
	`INIT_WORK
(&
fs_öfo
->
ª˛aim_bgs_w‹k
, 
båfs_ª˛aim_bgs_w‹k
);

2982 
	}
}

2984 
	$öô_mou¡_fs_öfo
(
båfs_fs_öfo
 *
fs_öfo
, 
su≥r_block
 *
sb
)

2986 
ªt
;

2988 
fs_öfo
->
sb
 = sb;

2989 
sb
->
s_blocksize
 = 
BTRFS_BDEV_BLOCKSIZE
;

2990 
sb
->
s_blocksize_bôs
 = 
	`blksize_bôs
(
BTRFS_BDEV_BLOCKSIZE
);

2992 
ªt
 = 
	`≥r˝u_cou¡î_öô
(&
fs_öfo
->
‹dîed_byãs
, 0, 
GFP_KERNEL
);

2993 i‡(
ªt
)

2994  
ªt
;

2996 
ªt
 = 
	`≥r˝u_cou¡î_öô
(&
fs_öfo
->
dúty_mëad©a_byãs
, 0, 
GFP_KERNEL
);

2997 i‡(
ªt
)

2998  
ªt
;

3000 
fs_öfo
->
dúty_mëad©a_b©ch
 = 
PAGE_SIZE
 *

3001 (1 + 
	`ûog2
(
ƒ_˝u_ids
));

3003 
ªt
 = 
	`≥r˝u_cou¡î_öô
(&
fs_öfo
->
dñÆloc_byãs
, 0, 
GFP_KERNEL
);

3004 i‡(
ªt
)

3005  
ªt
;

3007 
ªt
 = 
	`≥r˝u_cou¡î_öô
(&
fs_öfo
->
dev_ª∂a˚
.
bio_cou¡î
, 0,

3008 
GFP_KERNEL
);

3009 i‡(
ªt
)

3010  
ªt
;

3012 
fs_öfo
->
dñayed_roŸ
 = 
	`kmÆloc
((
båfs_dñayed_roŸ
),

3013 
GFP_KERNEL
);

3014 i‡(!
fs_öfo
->
dñayed_roŸ
)

3015  -
ENOMEM
;

3016 
	`båfs_öô_dñayed_roŸ
(
fs_öfo
->
dñayed_roŸ
);

3018 i‡(
	`sb_rd⁄ly
(
sb
))

3019 
	`£t_bô
(
BTRFS_FS_STATE_RO
, &
fs_öfo
->
fs_°©e
);

3021  
	`båfs_Æloc_°rùe_hash_èbÀ
(
fs_öfo
);

3022 
	}
}

3024 
	$båfs_uuid_ªsˇn_kthªad
(*
d©a
)

3026 
båfs_fs_öfo
 *
fs_öfo
 = 
d©a
;

3027 
ªt
;

3034 
ªt
 = 
	`båfs_uuid_åì_ôî©e
(
fs_öfo
);

3035 i‡(
ªt
 < 0) {

3036 i‡(
ªt
 !-
EINTR
)

3037 
	`båfs_w¨n
(
fs_öfo
, "iterating uuid_tree failed %d",

3038 
ªt
);

3039 
	`up
(&
fs_öfo
->
uuid_åì_ªsˇn_£m
);

3040  
ªt
;

3042  
	`båfs_uuid_sˇn_kthªad
(
d©a
);

3043 
	}
}

3045 
	$båfs_check_uuid_åì
(
båfs_fs_öfo
 *
fs_öfo
)

3047 
èsk_°ru˘
 *
èsk
;

3049 
	`down
(&
fs_öfo
->
uuid_åì_ªsˇn_£m
);

3050 
èsk
 = 
	`kthªad_run
(
båfs_uuid_ªsˇn_kthªad
, 
fs_öfo
, "btrfs-uuid");

3051 i‡(
	`IS_ERR
(
èsk
)) {

3053 
	`båfs_w¨n
(
fs_öfo
, "failedÅo start uuid_rescanÅask");

3054 
	`up
(&
fs_öfo
->
uuid_åì_ªsˇn_£m
);

3055  
	`PTR_ERR
(
èsk
);

3059 
	}
}

3061 
	$båfs_˛ónup_fs_roŸs
(
båfs_fs_öfo
 *
fs_öfo
)

3063 
u64
 
roŸ_obje˘id
 = 0;

3064 
båfs_roŸ
 *
g™g
[8];

3065 
i
 = 0;

3066 
îr
 = 0;

3067 
ªt
 = 0;

3070 
	`•ö_lock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

3071 
ªt
 = 
	`ødix_åì_g™g_lookup
(&
fs_öfo
->
fs_roŸs_ødix
,

3072 (**)
g™g
, 
roŸ_obje˘id
,

3073 
	`ARRAY_SIZE
(
g™g
));

3074 i‡(!
ªt
) {

3075 
	`•ö_u∆ock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

3078 
roŸ_obje˘id
 = 
g™g
[
ªt
 - 1]->
roŸ_key
.
obje˘id
 + 1;

3080 
i
 = 0; i < 
ªt
; i++) {

3082 i‡(
	`båfs_roŸ_ªfs
(&
g™g
[
i
]->
roŸ_ôem
) == 0) {

3083 
g™g
[
i
] = 
NULL
;

3087 
g™g
[
i
] = 
	`båfs_gøb_roŸ
(gang[i]);

3089 
	`•ö_u∆ock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

3091 
i
 = 0; i < 
ªt
; i++) {

3092 i‡(!
g™g
[
i
])

3094 
roŸ_obje˘id
 = 
g™g
[
i
]->
roŸ_key
.
obje˘id
;

3095 
îr
 = 
	`båfs_‹ph™_˛ónup
(
g™g
[
i
]);

3096 i‡(
îr
)

3097 
out
;

3098 
	`båfs_put_roŸ
(
g™g
[
i
]);

3100 
roŸ_obje˘id
++;

3102 
out
:

3104 ; 
i
 < 
ªt
; i++) {

3105 i‡(
g™g
[
i
])

3106 
	`båfs_put_roŸ
(
g™g
[
i
]);

3108  
îr
;

3109 
	}
}

3116 
	$båfs_˛ór_⁄eshŸ_›ti⁄s
(
båfs_fs_öfo
 *
fs_öfo
)

3118 
	`båfs_˛ór_›t
(
fs_öfo
->
mou¡_›t
, 
USEBACKUPROOT
);

3119 
	`båfs_˛ór_›t
(
fs_öfo
->
mou¡_›t
, 
CLEAR_CACHE
);

3120 
	}
}

3126 
	$båfs_°¨t_¥e_rw_mou¡
(
båfs_fs_öfo
 *
fs_öfo
)

3128 
ªt
;

3129 c⁄° 
boﬁ
 
ˇche_›t
 = 
	`båfs_ã°_›t
(
fs_öfo
, 
SPACE_CACHE
);

3130 
boﬁ
 
ªbuûd_‰ì_•a˚_åì
 = 
Ál£
;

3132 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
CLEAR_CACHE
) &&

3133 
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE
)) {

3134 
ªbuûd_‰ì_•a˚_åì
 = 
åue
;

3135 } i‡(
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE
) &&

3136 !
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE_VALID
)) {

3137 
	`båfs_w¨n
(
fs_öfo
, "free spaceÅree is invalid");

3138 
ªbuûd_‰ì_•a˚_åì
 = 
åue
;

3141 i‡(
ªbuûd_‰ì_•a˚_åì
) {

3142 
	`båfs_öfo
(
fs_öfo
, "rebuilding free spaceÅree");

3143 
ªt
 = 
	`båfs_ªbuûd_‰ì_•a˚_åì
(
fs_öfo
);

3144 i‡(
ªt
) {

3145 
	`båfs_w¨n
(
fs_öfo
,

3146 "ÁûedÅÿªbuûd fªê•a˚Åªe: %d", 
ªt
);

3147 
out
;

3151 i‡(
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE
) &&

3152 !
	`båfs_ã°_›t
(
fs_öfo
, 
FREE_SPACE_TREE
)) {

3153 
	`båfs_öfo
(
fs_öfo
, "disabling free spaceÅree");

3154 
ªt
 = 
	`båfs_dñëe_‰ì_•a˚_åì
(
fs_öfo
);

3155 i‡(
ªt
) {

3156 
	`båfs_w¨n
(
fs_öfo
,

3157 "ÁûedÅÿdißbÀ fªê•a˚Åªe: %d", 
ªt
);

3158 
out
;

3173 
ªt
 = 
	`båfs_föd_‹ph™_roŸs
(
fs_öfo
);

3174 i‡(
ªt
)

3175 
out
;

3177 
ªt
 = 
	`båfs_˛ónup_fs_roŸs
(
fs_öfo
);

3178 i‡(
ªt
)

3179 
out
;

3181 
	`down_ªad
(&
fs_öfo
->
˛ónup_w‹k_£m
);

3182 i‡((
ªt
 = 
	`båfs_‹ph™_˛ónup
(
fs_öfo
->
fs_roŸ
)) ||

3183 (
ªt
 = 
	`båfs_‹ph™_˛ónup
(
fs_öfo
->
åì_roŸ
))) {

3184 
	`up_ªad
(&
fs_öfo
->
˛ónup_w‹k_£m
);

3185 
out
;

3187 
	`up_ªad
(&
fs_öfo
->
˛ónup_w‹k_£m
);

3189 
	`muãx_lock
(&
fs_öfo
->
˛ó√r_muãx
);

3190 
ªt
 = 
	`båfs_ªcovî_ªloˇti⁄
(
fs_öfo
);

3191 
	`muãx_u∆ock
(&
fs_öfo
->
˛ó√r_muãx
);

3192 i‡(
ªt
 < 0) {

3193 
	`båfs_w¨n
(
fs_öfo
, "ÁûedÅÿªcovîÑñoˇti⁄: %d", 
ªt
);

3194 
out
;

3197 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
FREE_SPACE_TREE
) &&

3198 !
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE
)) {

3199 
	`båfs_öfo
(
fs_öfo
, "creating free spaceÅree");

3200 
ªt
 = 
	`båfs_¸óã_‰ì_•a˚_åì
(
fs_öfo
);

3201 i‡(
ªt
) {

3202 
	`båfs_w¨n
(
fs_öfo
,

3203 "ÁûedÅÿ¸óã fªê•a˚Åªe: %d", 
ªt
);

3204 
out
;

3208 i‡(
ˇche_›t
 !
	`båfs_‰ì_•a˚_ˇche_v1_a˘ive
(
fs_öfo
)) {

3209 
ªt
 = 
	`båfs_£t_‰ì_•a˚_ˇche_v1_a˘ive
(
fs_öfo
, 
ˇche_›t
);

3210 i‡(
ªt
)

3211 
out
;

3214 
ªt
 = 
	`båfs_ªsume_bÆ™˚_async
(
fs_öfo
);

3215 i‡(
ªt
)

3216 
out
;

3218 
ªt
 = 
	`båfs_ªsume_dev_ª∂a˚_async
(
fs_öfo
);

3219 i‡(
ªt
) {

3220 
	`båfs_w¨n
(
fs_öfo
, "failedÅoÑesume dev_replace");

3221 
out
;

3224 
	`båfs_qgroup_ªsˇn_ªsume
(
fs_öfo
);

3226 i‡(!
fs_öfo
->
uuid_roŸ
) {

3227 
	`båfs_öfo
(
fs_öfo
, "creating UUIDÅree");

3228 
ªt
 = 
	`båfs_¸óã_uuid_åì
(
fs_öfo
);

3229 i‡(
ªt
) {

3230 
	`båfs_w¨n
(
fs_öfo
,

3231 "ÁûedÅÿ¸óãÅhêUUIDÅªê%d", 
ªt
);

3232 
out
;

3236 
out
:

3237  
ªt
;

3238 
	}
}

3255 
	$båfs_check_„©uªs
(
båfs_fs_öfo
 *
fs_öfo
, 
boﬁ
 
is_rw_mou¡
)

3257 
båfs_su≥r_block
 *
disk_su≥r
 = 
fs_öfo
->
su≥r_c›y
;

3258 
u64
 
öcom∑t
 = 
	`båfs_su≥r_öcom∑t_Êags
(
disk_su≥r
);

3259 c⁄° 
u64
 
com∑t_ro
 = 
	`båfs_su≥r_com∑t_ro_Êags
(
disk_su≥r
);

3260 c⁄° 
u64
 
com∑t_ro_unsuµ
 = (
com∑t_ro
 & ~
BTRFS_FEATURE_COMPAT_RO_SUPP
);

3262 i‡(
öcom∑t
 & ~
BTRFS_FEATURE_INCOMPAT_SUPP
) {

3263 
	`båfs_îr
(
fs_öfo
,

3265 
öcom∑t
);

3266  -
EINVAL
;

3270 i‡((
öcom∑t
 & 
BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
) &&

3271 (
fs_öfo
->
£˘‹size
 !fs_öfo->
nodesize
)) {

3272 
	`båfs_îr
(
fs_öfo
,

3274 
fs_öfo
->
nodesize
, fs_öfo->
£˘‹size
);

3275  -
EINVAL
;

3279 
öcom∑t
 |
BTRFS_FEATURE_INCOMPAT_MIXED_BACKREF
;

3282 i‡(
fs_öfo
->
com¥ess_ty≥
 =
BTRFS_COMPRESS_LZO
)

3283 
öcom∑t
 |
BTRFS_FEATURE_INCOMPAT_COMPRESS_LZO
;

3284 i‡(
fs_öfo
->
com¥ess_ty≥
 =
BTRFS_COMPRESS_ZSTD
)

3285 
öcom∑t
 |
BTRFS_FEATURE_INCOMPAT_COMPRESS_ZSTD
;

3291 i‡(
	`båfs_su≥r_nodesize
(
disk_su≥r
Ë> 
PAGE_SIZE
)

3292 
öcom∑t
 |
BTRFS_FEATURE_INCOMPAT_BIG_METADATA
;

3294 i‡(
com∑t_ro_unsuµ
 && 
is_rw_mou¡
) {

3295 
	`båfs_îr
(
fs_öfo
,

3297 
com∑t_ro
);

3298  -
EINVAL
;

3306 i‡(
com∑t_ro_unsuµ
 && 
	`båfs_su≥r_log_roŸ
(
disk_su≥r
) &&

3307 !
	`båfs_ã°_›t
(
fs_öfo
, 
NOLOGREPLAY
)) {

3308 
	`båfs_îr
(
fs_öfo
,

3310 
com∑t_ro
);

3311  -
EINVAL
;

3318 i‡(
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
BLOCK_GROUP_TREE
) &&

3319 (!
	`båfs_fs_öcom∑t
(
fs_öfo
, 
NO_HOLES
) ||

3320 !
	`båfs_ã°_›t
(
fs_öfo
, 
FREE_SPACE_TREE
))) {

3321 
	`båfs_îr
(
fs_öfo
,

3323  -
EINVAL
;

3333 i‡(
fs_öfo
->
£˘‹size
 < 
PAGE_SIZE
 && 
	`båfs_ã°_›t
(fs_öfo, 
SPACE_CACHE
)) {

3334 
	`båfs_w¨n
(
fs_öfo
,

3336 
PAGE_SIZE
, 
fs_öfo
->
£˘‹size
);

3337  -
EINVAL
;

3341 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

3342 
	`båfs_£t_su≥r_öcom∑t_Êags
(
disk_su≥r
, 
öcom∑t
);

3343 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

3346 
	}
}

3348 
__cﬁd
 
	$›í_˘ªe
(
su≥r_block
 *
sb
, 
båfs_fs_devi˚s
 *
fs_devi˚s
,

3349 *
›ti⁄s
)

3351 
u32
 
£˘‹size
;

3352 
u32
 
nodesize
;

3353 
u32
 
°rùesize
;

3354 
u64
 
gíî©i⁄
;

3355 
u64
 
„©uªs
;

3356 
u16
 
csum_ty≥
;

3357 
båfs_su≥r_block
 *
disk_su≥r
;

3358 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
sb
);

3359 
båfs_roŸ
 *
åì_roŸ
;

3360 
båfs_roŸ
 *
chunk_roŸ
;

3361 
ªt
;

3362 
Àvñ
;

3364 
ªt
 = 
	`öô_mou¡_fs_öfo
(
fs_öfo
, 
sb
);

3365 i‡(
ªt
)

3366 
Áû
;

3369 
åì_roŸ
 = 
	`båfs_Æloc_roŸ
(
fs_öfo
, 
BTRFS_ROOT_TREE_OBJECTID
,

3370 
GFP_KERNEL
);

3371 
fs_öfo
->
åì_roŸ
 =Åree_root;

3372 
chunk_roŸ
 = 
	`båfs_Æloc_roŸ
(
fs_öfo
, 
BTRFS_CHUNK_TREE_OBJECTID
,

3373 
GFP_KERNEL
);

3374 
fs_öfo
->
chunk_roŸ
 = chunk_root;

3375 i‡(!
åì_roŸ
 || !
chunk_roŸ
) {

3376 
ªt
 = -
ENOMEM
;

3377 
Áû
;

3380 
ªt
 = 
	`båfs_öô_båì_öode
(
sb
);

3381 i‡(
ªt
)

3382 
Áû
;

3384 
	`övÆid©e_bdev
(
fs_devi˚s
->
œã°_dev
->
bdev
);

3389 
disk_su≥r
 = 
	`båfs_ªad_dev_su≥r
(
fs_devi˚s
->
œã°_dev
->
bdev
);

3390 i‡(
	`IS_ERR
(
disk_su≥r
)) {

3391 
ªt
 = 
	`PTR_ERR
(
disk_su≥r
);

3392 
Áû_Æloc
;

3395 
	`båfs_öfo
(
fs_öfo
, "fú° mou¡ o‡fûesy°em %pU", 
disk_su≥r
->
fsid
);

3400 
csum_ty≥
 = 
	`båfs_su≥r_csum_ty≥
(
disk_su≥r
);

3401 i‡(!
	`båfs_suµ‹ãd_su≥r_csum
(
csum_ty≥
)) {

3402 
	`båfs_îr
(
fs_öfo
, "unsupported checksumálgorithm: %u",

3403 
csum_ty≥
);

3404 
ªt
 = -
EINVAL
;

3405 
	`båfs_ªÀa£_disk_su≥r
(
disk_su≥r
);

3406 
Áû_Æloc
;

3409 
fs_öfo
->
csum_size
 = 
	`båfs_su≥r_csum_size
(
disk_su≥r
);

3411 
ªt
 = 
	`båfs_öô_csum_hash
(
fs_öfo
, 
csum_ty≥
);

3412 i‡(
ªt
) {

3413 
	`båfs_ªÀa£_disk_su≥r
(
disk_su≥r
);

3414 
Áû_Æloc
;

3421 i‡(
	`båfs_check_su≥r_csum
(
fs_öfo
, 
disk_su≥r
)) {

3422 
	`båfs_îr
(
fs_öfo
, "superblock checksum mismatch");

3423 
ªt
 = -
EINVAL
;

3424 
	`båfs_ªÀa£_disk_su≥r
(
disk_su≥r
);

3425 
Áû_Æloc
;

3433 
	`mem˝y
(
fs_öfo
->
su≥r_c›y
, 
disk_su≥r
, (*fs_info->super_copy));

3434 
	`båfs_ªÀa£_disk_su≥r
(
disk_su≥r
);

3436 
disk_su≥r
 = 
fs_öfo
->
su≥r_c›y
;

3439 
„©uªs
 = 
	`båfs_su≥r_Êags
(
disk_su≥r
);

3440 i‡(
„©uªs
 & 
BTRFS_SUPER_FLAG_CHANGING_FSID_V2
) {

3441 
„©uªs
 &~
BTRFS_SUPER_FLAG_CHANGING_FSID_V2
;

3442 
	`båfs_£t_su≥r_Êags
(
disk_su≥r
, 
„©uªs
);

3443 
	`båfs_öfo
(
fs_öfo
,

3447 
	`mem˝y
(
fs_öfo
->
su≥r_f‹_commô
, fs_öfo->
su≥r_c›y
,

3448 (*
fs_öfo
->
su≥r_f‹_commô
));

3450 
ªt
 = 
	`båfs_vÆid©e_mou¡_su≥r
(
fs_öfo
);

3451 i‡(
ªt
) {

3452 
	`båfs_îr
(
fs_öfo
, "superblock contains fatalÉrrors");

3453 
ªt
 = -
EINVAL
;

3454 
Áû_Æloc
;

3457 i‡(!
	`båfs_su≥r_roŸ
(
disk_su≥r
)) {

3458 
	`båfs_îr
(
fs_öfo
, "invalid superblockÅreeÑoot bytenr");

3459 
ªt
 = -
EINVAL
;

3460 
Áû_Æloc
;

3464 i‡(
	`båfs_su≥r_Êags
(
disk_su≥r
Ë& 
BTRFS_SUPER_FLAG_ERROR
)

3465 
	`WRITE_ONCE
(
fs_öfo
->
fs_îr‹
, -
EUCLEAN
);

3471 
fs_öfo
->
com¥ess_ty≥
 = 
BTRFS_COMPRESS_ZLIB
;

3475 
nodesize
 = 
	`båfs_su≥r_nodesize
(
disk_su≥r
);

3476 
£˘‹size
 = 
	`båfs_su≥r_£˘‹size
(
disk_su≥r
);

3477 
°rùesize
 = 
£˘‹size
;

3478 
fs_öfo
->
dúty_mëad©a_b©ch
 = 
nodesize
 * (1 + 
	`ûog2
(
ƒ_˝u_ids
));

3479 
fs_öfo
->
dñÆloc_b©ch
 = 
£˘‹size
 * 512 * (1 + 
	`ûog2
(
ƒ_˝u_ids
));

3481 
fs_öfo
->
nodesize
 =Çodesize;

3482 
fs_öfo
->
£˘‹size
 = sectorsize;

3483 
fs_öfo
->
£˘‹size_bôs
 = 
	`ûog2
(
£˘‹size
);

3484 
fs_öfo
->
csums_≥r_Àaf
 = 
	`BTRFS_MAX_ITEM_SIZE
(fs_öfoË/ fs_öfo->
csum_size
;

3485 
fs_öfo
->
°rùesize
 = stripesize;

3487 
ªt
 = 
	`båfs_∑r£_›ti⁄s
(
fs_öfo
, 
›ti⁄s
, 
sb
->
s_Êags
);

3488 i‡(
ªt
)

3489 
Áû_Æloc
;

3491 
ªt
 = 
	`båfs_check_„©uªs
(
fs_öfo
, !
	`sb_rd⁄ly
(
sb
));

3492 i‡(
ªt
 < 0)

3493 
Áû_Æloc
;

3495 i‡(
£˘‹size
 < 
PAGE_SIZE
) {

3496 
båfs_sub∑ge_öfo
 *
sub∑ge_öfo
;

3504 
	`båfs_˛ór_›t
(
fs_öfo
->
mou¡_›t
, 
SPACE_CACHE
);

3505 
	`båfs_£t_™d_öfo
(
fs_öfo
, 
FREE_SPACE_TREE
,

3507 
£˘‹size
, 
PAGE_SIZE
);

3509 
	`båfs_w¨n
(
fs_öfo
,

3511 
£˘‹size
, 
PAGE_SIZE
);

3512 
sub∑ge_öfo
 = 
	`kzÆloc
((*sub∑ge_öfo), 
GFP_KERNEL
);

3513 i‡(!
sub∑ge_öfo
) {

3514 
ªt
 = -
ENOMEM
;

3515 
Áû_Æloc
;

3517 
	`båfs_öô_sub∑ge_öfo
(
sub∑ge_öfo
, 
£˘‹size
);

3518 
fs_öfo
->
sub∑ge_öfo
 = subpage_info;

3521 
ªt
 = 
	`båfs_öô_w‹kqueues
(
fs_öfo
);

3522 i‡(
ªt
)

3523 
Áû_sb_buf„r
;

3525 
sb
->
s_bdi
->
ø_∑ges
 *
	`båfs_su≥r_num_devi˚s
(
disk_su≥r
);

3526 
sb
->
s_bdi
->
ø_∑ges
 = 
	`max
(sb->s_bdi->ø_∑ges, 
SZ_4M
 / 
PAGE_SIZE
);

3528 
sb
->
s_blocksize
 = 
£˘‹size
;

3529 
sb
->
s_blocksize_bôs
 = 
	`blksize_bôs
(
£˘‹size
);

3530 
	`mem˝y
(&
sb
->
s_uuid
, 
fs_öfo
->
fs_devi˚s
->
fsid
, 
BTRFS_FSID_SIZE
);

3532 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

3533 
ªt
 = 
	`båfs_ªad_sys_¨øy
(
fs_öfo
);

3534 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

3535 i‡(
ªt
) {

3536 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿªadÅhêsy°emáºay: %d", 
ªt
);

3537 
Áû_sb_buf„r
;

3540 
gíî©i⁄
 = 
	`båfs_su≥r_chunk_roŸ_gíî©i⁄
(
disk_su≥r
);

3541 
Àvñ
 = 
	`båfs_su≥r_chunk_roŸ_Àvñ
(
disk_su≥r
);

3542 
ªt
 = 
	`lﬂd_su≥r_roŸ
(
chunk_roŸ
, 
	`båfs_su≥r_chunk_roŸ
(
disk_su≥r
),

3543 
gíî©i⁄
, 
Àvñ
);

3544 i‡(
ªt
) {

3545 
	`båfs_îr
(
fs_öfo
, "failedÅoÑead chunkÑoot");

3546 
Áû_åì_roŸs
;

3549 
	`ªad_exã¡_buf„r
(
chunk_roŸ
->
node
, 
fs_öfo
->
chunk_åì_uuid
,

3550 
	`off£tof
(
båfs_hódî
, 
chunk_åì_uuid
),

3551 
BTRFS_UUID_SIZE
);

3553 
ªt
 = 
	`båfs_ªad_chunk_åì
(
fs_öfo
);

3554 i‡(
ªt
) {

3555 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿªad chunkÅªe: %d", 
ªt
);

3556 
Áû_åì_roŸs
;

3566 
	`båfs_‰ì_exåa_devids
(
fs_devi˚s
);

3567 i‡(!
fs_devi˚s
->
œã°_dev
->
bdev
) {

3568 
	`båfs_îr
(
fs_öfo
, "failedÅoÑead devices");

3569 
ªt
 = -
EIO
;

3570 
Áû_åì_roŸs
;

3573 
ªt
 = 
	`öô_åì_roŸs
(
fs_öfo
);

3574 i‡(
ªt
)

3575 
Áû_åì_roŸs
;

3582 
ªt
 = 
	`båfs_gë_dev_z⁄e_öfo_Æl_devi˚s
(
fs_öfo
);

3583 i‡(
ªt
) {

3584 
	`båfs_îr
(
fs_öfo
,

3585 "z⁄ed: faûedÅÿªad devi˚ z⁄êöfo: %d", 
ªt
);

3586 
Áû_block_groups
;

3597 i‡(
fs_öfo
->
uuid_roŸ
 && !
	`båfs_ã°_›t
(fs_öfo, 
RESCAN_UUID_TREE
) &&

3598 
fs_öfo
->
gíî©i⁄
 =
	`båfs_su≥r_uuid_åì_gíî©i⁄
(
disk_su≥r
))

3599 
	`£t_bô
(
BTRFS_FS_UPDATE_UUID_TREE_GEN
, &
fs_öfo
->
Êags
);

3601 
ªt
 = 
	`båfs_vîify_dev_exã¡s
(
fs_öfo
);

3602 i‡(
ªt
) {

3603 
	`båfs_îr
(
fs_öfo
,

3605 
ªt
);

3606 
Áû_block_groups
;

3608 
ªt
 = 
	`båfs_ªcovî_bÆ™˚
(
fs_öfo
);

3609 i‡(
ªt
) {

3610 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿªcovî bÆ™˚: %d", 
ªt
);

3611 
Áû_block_groups
;

3614 
ªt
 = 
	`båfs_öô_dev_°©s
(
fs_öfo
);

3615 i‡(
ªt
) {

3616 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿöô dev_°©s: %d", 
ªt
);

3617 
Áû_block_groups
;

3620 
ªt
 = 
	`båfs_öô_dev_ª∂a˚
(
fs_öfo
);

3621 i‡(
ªt
) {

3622 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿöô dev_ª∂a˚: %d", 
ªt
);

3623 
Áû_block_groups
;

3626 
ªt
 = 
	`båfs_check_z⁄ed_mode
(
fs_öfo
);

3627 i‡(
ªt
) {

3628 
	`båfs_îr
(
fs_öfo
, "failedÅo initialize zoned mode: %d",

3629 
ªt
);

3630 
Áû_block_groups
;

3633 
ªt
 = 
	`båfs_sysfs_add_fsid
(
fs_devi˚s
);

3634 i‡(
ªt
) {

3635 
	`båfs_îr
(
fs_öfo
, "failedÅo init sysfs fsid interface: %d",

3636 
ªt
);

3637 
Áû_block_groups
;

3640 
ªt
 = 
	`båfs_sysfs_add_mou¡ed
(
fs_öfo
);

3641 i‡(
ªt
) {

3642 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿöô sysf†öãrÁ˚: %d", 
ªt
);

3643 
Áû_fsdev_sysfs
;

3646 
ªt
 = 
	`båfs_öô_•a˚_öfo
(
fs_öfo
);

3647 i‡(
ªt
) {

3648 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿöôülizê•a˚ info: %d", 
ªt
);

3649 
Áû_sysfs
;

3652 
ªt
 = 
	`båfs_ªad_block_groups
(
fs_öfo
);

3653 i‡(
ªt
) {

3654 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿªad block groups: %d", 
ªt
);

3655 
Áû_sysfs
;

3658 
	`båfs_‰ì_z⁄e_ˇche
(
fs_öfo
);

3660 
	`båfs_check_a˘ive_z⁄e_ª£rv©i⁄
(
fs_öfo
);

3662 i‡(!
	`sb_rd⁄ly
(
sb
Ë&& 
fs_öfo
->
fs_devi˚s
->
missög_devi˚s
 &&

3663 !
	`båfs_check_rw_degødabÀ
(
fs_öfo
, 
NULL
)) {

3664 
	`båfs_w¨n
(
fs_öfo
,

3666 
ªt
 = -
EINVAL
;

3667 
Áû_sysfs
;

3670 
fs_öfo
->
˛ó√r_kthªad
 = 
	`kthªad_run
(cleaner_kthread, fs_info,

3672 i‡(
	`IS_ERR
(
fs_öfo
->
˛ó√r_kthªad
)) {

3673 
ªt
 = 
	`PTR_ERR
(
fs_öfo
->
˛ó√r_kthªad
);

3674 
Áû_sysfs
;

3677 
fs_öfo
->
å™ß˘i⁄_kthªad
 = 
	`kthªad_run
(transaction_kthread,

3678 
åì_roŸ
,

3680 i‡(
	`IS_ERR
(
fs_öfo
->
å™ß˘i⁄_kthªad
)) {

3681 
ªt
 = 
	`PTR_ERR
(
fs_öfo
->
å™ß˘i⁄_kthªad
);

3682 
Áû_˛ó√r
;

3685 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
NOSSD
) &&

3686 !
fs_öfo
->
fs_devi˚s
->
rŸ©ög
) {

3687 
	`båfs_£t_™d_öfo
(
fs_öfo
, 
SSD
, "enabling ssd optimizations");

3699 i‡(!(
	`båfs_ã°_›t
(
fs_öfo
, 
DISCARD_SYNC
) ||

3700 
	`båfs_ã°_›t
(
fs_öfo
, 
DISCARD_ASYNC
) ||

3701 
	`båfs_ã°_›t
(
fs_öfo
, 
NODISCARD
)) &&

3702 
fs_öfo
->
fs_devi˚s
->
disˇrdabÀ
 &&

3703 !
	`båfs_is_z⁄ed
(
fs_öfo
)) {

3704 
	`båfs_£t_™d_öfo
(
fs_öfo
, 
DISCARD_ASYNC
,

3708 #ifde‡
CONFIG_BTRFS_FS_CHECK_INTEGRITY


3709 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
CHECK_INTEGRITY
)) {

3710 
ªt
 = 
	`båfsic_mou¡
(
fs_öfo
, 
fs_devi˚s
,

3711 
	`båfs_ã°_›t
(
fs_öfo
,

3712 
CHECK_INTEGRITY_DATA
) ? 1 : 0,

3713 
fs_öfo
->
check_öãgrôy_¥öt_mask
);

3714 i‡(
ªt
)

3715 
	`båfs_w¨n
(
fs_öfo
,

3717 
ªt
);

3720 
ªt
 = 
	`båfs_ªad_qgroup_c⁄fig
(
fs_öfo
);

3721 i‡(
ªt
)

3722 
Áû_å™s_kthªad
;

3724 i‡(
	`båfs_buûd_ªf_åì
(
fs_öfo
))

3725 
	`båfs_îr
(
fs_öfo
, "couldn't buildÑefÅree");

3728 i‡(
	`båfs_su≥r_log_roŸ
(
disk_su≥r
) != 0 &&

3729 !
	`båfs_ã°_›t
(
fs_öfo
, 
NOLOGREPLAY
)) {

3730 
	`båfs_öfo
(
fs_öfo
, "startÅree-logÑeplay");

3731 
ªt
 = 
	`båfs_ª∂ay_log
(
fs_öfo
, 
fs_devi˚s
);

3732 i‡(
ªt
)

3733 
Áû_qgroup
;

3736 
fs_öfo
->
fs_roŸ
 = 
	`båfs_gë_fs_roŸ
(fs_öfo, 
BTRFS_FS_TREE_OBJECTID
, 
åue
);

3737 i‡(
	`IS_ERR
(
fs_öfo
->
fs_roŸ
)) {

3738 
ªt
 = 
	`PTR_ERR
(
fs_öfo
->
fs_roŸ
);

3739 
	`båfs_w¨n
(
fs_öfo
, "ÁûedÅÿªad f†åì: %d", 
ªt
);

3740 
fs_öfo
->
fs_roŸ
 = 
NULL
;

3741 
Áû_qgroup
;

3744 i‡(
	`sb_rd⁄ly
(
sb
))

3745 
˛ór_⁄eshŸ
;

3747 
ªt
 = 
	`båfs_°¨t_¥e_rw_mou¡
(
fs_öfo
);

3748 i‡(
ªt
) {

3749 
	`˛o£_˘ªe
(
fs_öfo
);

3750  
ªt
;

3752 
	`båfs_disˇrd_ªsume
(
fs_öfo
);

3754 i‡(
fs_öfo
->
uuid_roŸ
 &&

3755 (
	`båfs_ã°_›t
(
fs_öfo
, 
RESCAN_UUID_TREE
) ||

3756 
fs_öfo
->
gíî©i⁄
 !
	`båfs_su≥r_uuid_åì_gíî©i⁄
(
disk_su≥r
))) {

3757 
	`båfs_öfo
(
fs_öfo
, "checking UUIDÅree");

3758 
ªt
 = 
	`båfs_check_uuid_åì
(
fs_öfo
);

3759 i‡(
ªt
) {

3760 
	`båfs_w¨n
(
fs_öfo
,

3761 "ÁûedÅÿcheckÅhêUUIDÅªe: %d", 
ªt
);

3762 
	`˛o£_˘ªe
(
fs_öfo
);

3763  
ªt
;

3767 
	`£t_bô
(
BTRFS_FS_OPEN
, &
fs_öfo
->
Êags
);

3770 i‡(
	`ã°_bô
(
BTRFS_FS_UNFINISHED_DROPS
, &
fs_öfo
->
Êags
))

3771 
	`wake_up_¥o˚ss
(
fs_öfo
->
˛ó√r_kthªad
);

3773 
˛ór_⁄eshŸ
:

3774 
	`båfs_˛ór_⁄eshŸ_›ti⁄s
(
fs_öfo
);

3777 
Áû_qgroup
:

3778 
	`båfs_‰ì_qgroup_c⁄fig
(
fs_öfo
);

3779 
Áû_å™s_kthªad
:

3780 
	`kthªad_°›
(
fs_öfo
->
å™ß˘i⁄_kthªad
);

3781 
	`båfs_˛ónup_å™ß˘i⁄
(
fs_öfo
);

3782 
	`båfs_‰ì_fs_roŸs
(
fs_öfo
);

3783 
Áû_˛ó√r
:

3784 
	`kthªad_°›
(
fs_öfo
->
˛ó√r_kthªad
);

3790 
	`fûem≠_wrôe_™d_waô
(
fs_öfo
->
båì_öode
->
i_m≠pög
);

3792 
Áû_sysfs
:

3793 
	`båfs_sysfs_ªmove_mou¡ed
(
fs_öfo
);

3795 
Áû_fsdev_sysfs
:

3796 
	`båfs_sysfs_ªmove_fsid
(
fs_öfo
->
fs_devi˚s
);

3798 
Áû_block_groups
:

3799 
	`båfs_put_block_group_ˇche
(
fs_öfo
);

3801 
Áû_åì_roŸs
:

3802 i‡(
fs_öfo
->
d©a_ªloc_roŸ
)

3803 
	`båfs_dr›_™d_‰ì_fs_roŸ
(
fs_öfo
, fs_öfo->
d©a_ªloc_roŸ
);

3804 
	`‰ì_roŸ_poöãrs
(
fs_öfo
, 
åue
);

3805 
	`övÆid©e_öode_∑ges2
(
fs_öfo
->
båì_öode
->
i_m≠pög
);

3807 
Áû_sb_buf„r
:

3808 
	`båfs_°›_Æl_w‹kîs
(
fs_öfo
);

3809 
	`båfs_‰ì_block_groups
(
fs_öfo
);

3810 
Áû_Æloc
:

3811 
	`båfs_m≠pög_åì_‰ì
(&
fs_öfo
->
m≠pög_åì
);

3813 
	`ùut
(
fs_öfo
->
båì_öode
);

3814 
Áû
:

3815 
	`båfs_˛o£_devi˚s
(
fs_öfo
->
fs_devi˚s
);

3816 
	`ASSERT
(
ªt
 < 0);

3817  
ªt
;

3818 
	}
}

3819 
ALLOW_ERROR_INJECTION
(
›í_˘ªe
, 
ERRNO
);

3822 
__cﬁd
 
	$›í_˘ªe_∑πôi⁄
(
su≥r_block
 *
sb
, 
båfs_fs_devi˚s
 *
fs_devi˚s
,

3823 *
›ti⁄s
, 
∑πôi⁄_‹dî
)

3825 
u32
 
£˘‹size
;

3826 
u32
 
nodesize
;

3827 
u32
 
°rùesize
;

3828 
u64
 
gíî©i⁄
;

3829 
u64
 
„©uªs
;

3830 
u16
 
csum_ty≥
;

3831 
båfs_su≥r_block
 *
disk_su≥r
;

3832 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
sb
);

3833 
båfs_roŸ
 *
åì_roŸ
;

3834 
båfs_roŸ
 *
chunk_roŸ
;

3835 
ªt
;

3836 
Àvñ
;

3838 
ªt
 = 
	`öô_mou¡_fs_öfo
(
fs_öfo
, 
sb
);

3839 i‡(
ªt
)

3840 
Áû
;

3843 
åì_roŸ
 = 
	`båfs_Æloc_roŸ
(
fs_öfo
, 
BTRFS_ROOT_TREE_OBJECTID
,

3844 
GFP_KERNEL
);

3845 
fs_öfo
->
åì_roŸ
 =Åree_root;

3846 
chunk_roŸ
 = 
	`båfs_Æloc_roŸ
(
fs_öfo
, 
BTRFS_CHUNK_TREE_OBJECTID
,

3847 
GFP_KERNEL
);

3848 
fs_öfo
->
chunk_roŸ
 = chunk_root;

3849 i‡(!
åì_roŸ
 || !
chunk_roŸ
) {

3850 
ªt
 = -
ENOMEM
;

3851 
Áû
;

3854 
ªt
 = 
	`båfs_öô_båì_öode
(
sb
);

3855 i‡(
ªt
)

3856 
Áû
;

3858 
	`övÆid©e_bdev
(
fs_devi˚s
->
œã°_dev
->
bdev
);

3863 
disk_su≥r
 = 
	`båfs_ªad_dev_su≥r_∑πôi⁄
(
fs_devi˚s
->
œã°_dev
->
bdev
, 
∑πôi⁄_‹dî
);

3864 i‡(
	`IS_ERR
(
disk_su≥r
)) {

3865 
ªt
 = 
	`PTR_ERR
(
disk_su≥r
);

3866 
Áû_Æloc
;

3869 
	`båfs_öfo
(
fs_öfo
, "fú° mou¡ o‡fûesy°em %pU", 
disk_su≥r
->
fsid
);

3874 
csum_ty≥
 = 
	`båfs_su≥r_csum_ty≥
(
disk_su≥r
);

3875 i‡(!
	`båfs_suµ‹ãd_su≥r_csum
(
csum_ty≥
)) {

3876 
	`båfs_îr
(
fs_öfo
, "unsupported checksumálgorithm: %u",

3877 
csum_ty≥
);

3878 
ªt
 = -
EINVAL
;

3879 
	`båfs_ªÀa£_disk_su≥r
(
disk_su≥r
);

3880 
Áû_Æloc
;

3883 
fs_öfo
->
csum_size
 = 
	`båfs_su≥r_csum_size
(
disk_su≥r
);

3885 
ªt
 = 
	`båfs_öô_csum_hash
(
fs_öfo
, 
csum_ty≥
);

3886 i‡(
ªt
) {

3887 
	`båfs_ªÀa£_disk_su≥r
(
disk_su≥r
);

3888 
Áû_Æloc
;

3895 i‡(
	`båfs_check_su≥r_csum
(
fs_öfo
, 
disk_su≥r
)) {

3896 
	`båfs_îr
(
fs_öfo
, "superblock checksum mismatch");

3897 
ªt
 = -
EINVAL
;

3898 
	`båfs_ªÀa£_disk_su≥r
(
disk_su≥r
);

3899 
Áû_Æloc
;

3907 
	`mem˝y
(
fs_öfo
->
su≥r_c›y
, 
disk_su≥r
, (*fs_info->super_copy));

3908 
	`båfs_ªÀa£_disk_su≥r
(
disk_su≥r
);

3910 
disk_su≥r
 = 
fs_öfo
->
su≥r_c›y
;

3913 
„©uªs
 = 
	`båfs_su≥r_Êags
(
disk_su≥r
);

3914 i‡(
„©uªs
 & 
BTRFS_SUPER_FLAG_CHANGING_FSID_V2
) {

3915 
„©uªs
 &~
BTRFS_SUPER_FLAG_CHANGING_FSID_V2
;

3916 
	`båfs_£t_su≥r_Êags
(
disk_su≥r
, 
„©uªs
);

3917 
	`båfs_öfo
(
fs_öfo
,

3921 
	`mem˝y
(
fs_öfo
->
su≥r_f‹_commô
, fs_öfo->
su≥r_c›y
,

3922 (*
fs_öfo
->
su≥r_f‹_commô
));

3924 
ªt
 = 
	`båfs_vÆid©e_mou¡_su≥r_∑πôi⁄
(
fs_öfo
, 
∑πôi⁄_‹dî
);

3925 i‡(
ªt
) {

3926 
	`båfs_îr
(
fs_öfo
, "superblock contains fatalÉrrors");

3927 
ªt
 = -
EINVAL
;

3928 
Áû_Æloc
;

3931 i‡(!
	`båfs_su≥r_roŸ
(
disk_su≥r
)) {

3932 
	`båfs_îr
(
fs_öfo
, "invalid superblockÅreeÑoot bytenr");

3933 
ªt
 = -
EINVAL
;

3934 
Áû_Æloc
;

3938 i‡(
	`båfs_su≥r_Êags
(
disk_su≥r
Ë& 
BTRFS_SUPER_FLAG_ERROR
)

3939 
	`WRITE_ONCE
(
fs_öfo
->
fs_îr‹
, -
EUCLEAN
);

3945 
fs_öfo
->
com¥ess_ty≥
 = 
BTRFS_COMPRESS_ZLIB
;

3949 
nodesize
 = 
	`båfs_su≥r_nodesize
(
disk_su≥r
);

3950 
£˘‹size
 = 
	`båfs_su≥r_£˘‹size
(
disk_su≥r
);

3951 
°rùesize
 = 
£˘‹size
;

3952 
fs_öfo
->
dúty_mëad©a_b©ch
 = 
nodesize
 * (1 + 
	`ûog2
(
ƒ_˝u_ids
));

3953 
fs_öfo
->
dñÆloc_b©ch
 = 
£˘‹size
 * 512 * (1 + 
	`ûog2
(
ƒ_˝u_ids
));

3955 
fs_öfo
->
nodesize
 =Çodesize;

3956 
fs_öfo
->
£˘‹size
 = sectorsize;

3957 
fs_öfo
->
£˘‹size_bôs
 = 
	`ûog2
(
£˘‹size
);

3958 
fs_öfo
->
csums_≥r_Àaf
 = 
	`BTRFS_MAX_ITEM_SIZE
(fs_öfoË/ fs_öfo->
csum_size
;

3959 
fs_öfo
->
°rùesize
 = stripesize;

3961 
ªt
 = 
	`båfs_∑r£_›ti⁄s
(
fs_öfo
, 
›ti⁄s
, 
sb
->
s_Êags
);

3962 i‡(
ªt
)

3963 
Áû_Æloc
;

3965 
ªt
 = 
	`båfs_check_„©uªs
(
fs_öfo
, !
	`sb_rd⁄ly
(
sb
));

3966 i‡(
ªt
 < 0)

3967 
Áû_Æloc
;

3969 i‡(
£˘‹size
 < 
PAGE_SIZE
) {

3970 
båfs_sub∑ge_öfo
 *
sub∑ge_öfo
;

3978 
	`båfs_˛ór_›t
(
fs_öfo
->
mou¡_›t
, 
SPACE_CACHE
);

3979 
	`båfs_£t_™d_öfo
(
fs_öfo
, 
FREE_SPACE_TREE
,

3981 
£˘‹size
, 
PAGE_SIZE
);

3983 
	`båfs_w¨n
(
fs_öfo
,

3985 
£˘‹size
, 
PAGE_SIZE
);

3986 
sub∑ge_öfo
 = 
	`kzÆloc
((*sub∑ge_öfo), 
GFP_KERNEL
);

3987 i‡(!
sub∑ge_öfo
) {

3988 
ªt
 = -
ENOMEM
;

3989 
Áû_Æloc
;

3991 
	`båfs_öô_sub∑ge_öfo
(
sub∑ge_öfo
, 
£˘‹size
);

3992 
fs_öfo
->
sub∑ge_öfo
 = subpage_info;

3995 
ªt
 = 
	`båfs_öô_w‹kqueues
(
fs_öfo
);

3996 i‡(
ªt
)

3997 
Áû_sb_buf„r
;

3999 
sb
->
s_bdi
->
ø_∑ges
 *
	`båfs_su≥r_num_devi˚s
(
disk_su≥r
);

4000 
sb
->
s_bdi
->
ø_∑ges
 = 
	`max
(sb->s_bdi->ø_∑ges, 
SZ_4M
 / 
PAGE_SIZE
);

4002 
sb
->
s_blocksize
 = 
£˘‹size
;

4003 
sb
->
s_blocksize_bôs
 = 
	`blksize_bôs
(
£˘‹size
);

4004 
	`mem˝y
(&
sb
->
s_uuid
, 
fs_öfo
->
fs_devi˚s
->
fsid
, 
BTRFS_FSID_SIZE
);

4006 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

4007 
ªt
 = 
	`båfs_ªad_sys_¨øy
(
fs_öfo
);

4008 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

4009 i‡(
ªt
) {

4010 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿªadÅhêsy°emáºay: %d", 
ªt
);

4011 
Áû_sb_buf„r
;

4014 
gíî©i⁄
 = 
	`båfs_su≥r_chunk_roŸ_gíî©i⁄
(
disk_su≥r
);

4015 
Àvñ
 = 
	`båfs_su≥r_chunk_roŸ_Àvñ
(
disk_su≥r
);

4016 
ªt
 = 
	`lﬂd_su≥r_roŸ
(
chunk_roŸ
, 
	`båfs_su≥r_chunk_roŸ
(
disk_su≥r
),

4017 
gíî©i⁄
, 
Àvñ
);

4018 i‡(
ªt
) {

4019 
	`båfs_îr
(
fs_öfo
, "failedÅoÑead chunkÑoot");

4020 
Áû_åì_roŸs
;

4023 
	`ªad_exã¡_buf„r
(
chunk_roŸ
->
node
, 
fs_öfo
->
chunk_åì_uuid
,

4024 
	`off£tof
(
båfs_hódî
, 
chunk_åì_uuid
),

4025 
BTRFS_UUID_SIZE
);

4027 
ªt
 = 
	`båfs_ªad_chunk_åì_∑πôi⁄
(
fs_öfo
, 
∑πôi⁄_‹dî
);

4028 i‡(
ªt
) {

4029 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿªad chunkÅªe: %d", 
ªt
);

4030 
Áû_åì_roŸs
;

4040 
	`båfs_‰ì_exåa_devids
(
fs_devi˚s
);

4041 i‡(!
fs_devi˚s
->
œã°_dev
->
bdev
) {

4042 
	`båfs_îr
(
fs_öfo
, "failedÅoÑead devices");

4043 
ªt
 = -
EIO
;

4044 
Áû_åì_roŸs
;

4047 
ªt
 = 
	`öô_åì_roŸs
(
fs_öfo
);

4048 i‡(
ªt
)

4049 
Áû_åì_roŸs
;

4056 
ªt
 = 
	`båfs_gë_dev_z⁄e_öfo_Æl_devi˚s
(
fs_öfo
);

4057 i‡(
ªt
) {

4058 
	`båfs_îr
(
fs_öfo
,

4059 "z⁄ed: faûedÅÿªad devi˚ z⁄êöfo: %d", 
ªt
);

4060 
Áû_block_groups
;

4071 i‡(
fs_öfo
->
uuid_roŸ
 && !
	`båfs_ã°_›t
(fs_öfo, 
RESCAN_UUID_TREE
) &&

4072 
fs_öfo
->
gíî©i⁄
 =
	`båfs_su≥r_uuid_åì_gíî©i⁄
(
disk_su≥r
))

4073 
	`£t_bô
(
BTRFS_FS_UPDATE_UUID_TREE_GEN
, &
fs_öfo
->
Êags
);

4075 
ªt
 = 
	`båfs_vîify_dev_exã¡s
(
fs_öfo
);

4076 i‡(
ªt
) {

4077 
	`båfs_îr
(
fs_öfo
,

4079 
ªt
);

4080 
Áû_block_groups
;

4082 
ªt
 = 
	`båfs_ªcovî_bÆ™˚
(
fs_öfo
);

4083 i‡(
ªt
) {

4084 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿªcovî bÆ™˚: %d", 
ªt
);

4085 
Áû_block_groups
;

4088 
ªt
 = 
	`båfs_öô_dev_°©s
(
fs_öfo
);

4089 i‡(
ªt
) {

4090 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿöô dev_°©s: %d", 
ªt
);

4091 
Áû_block_groups
;

4094 
ªt
 = 
	`båfs_öô_dev_ª∂a˚
(
fs_öfo
);

4095 i‡(
ªt
) {

4096 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿöô dev_ª∂a˚: %d", 
ªt
);

4097 
Áû_block_groups
;

4100 
ªt
 = 
	`båfs_check_z⁄ed_mode
(
fs_öfo
);

4101 i‡(
ªt
) {

4102 
	`båfs_îr
(
fs_öfo
, "failedÅo initialize zoned mode: %d",

4103 
ªt
);

4104 
Áû_block_groups
;

4107 
ªt
 = 
	`båfs_sysfs_add_fsid
(
fs_devi˚s
);

4108 i‡(
ªt
) {

4109 
	`båfs_îr
(
fs_öfo
, "failedÅo init sysfs fsid interface: %d",

4110 
ªt
);

4111 
Áû_block_groups
;

4114 
ªt
 = 
	`båfs_sysfs_add_mou¡ed
(
fs_öfo
);

4115 i‡(
ªt
) {

4116 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿöô sysf†öãrÁ˚: %d", 
ªt
);

4117 
Áû_fsdev_sysfs
;

4120 
ªt
 = 
	`båfs_öô_•a˚_öfo
(
fs_öfo
);

4121 i‡(
ªt
) {

4122 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿöôülizê•a˚ info: %d", 
ªt
);

4123 
Áû_sysfs
;

4126 
ªt
 = 
	`båfs_ªad_block_groups
(
fs_öfo
);

4127 i‡(
ªt
) {

4128 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿªad block groups: %d", 
ªt
);

4129 
Áû_sysfs
;

4132 
	`båfs_‰ì_z⁄e_ˇche
(
fs_öfo
);

4134 
	`båfs_check_a˘ive_z⁄e_ª£rv©i⁄
(
fs_öfo
);

4136 i‡(!
	`sb_rd⁄ly
(
sb
Ë&& 
fs_öfo
->
fs_devi˚s
->
missög_devi˚s
 &&

4137 !
	`båfs_check_rw_degødabÀ
(
fs_öfo
, 
NULL
)) {

4138 
	`båfs_w¨n
(
fs_öfo
,

4140 
ªt
 = -
EINVAL
;

4141 
Áû_sysfs
;

4144 
fs_öfo
->
˛ó√r_kthªad
 = 
	`kthªad_run
(cleaner_kthread, fs_info,

4146 i‡(
	`IS_ERR
(
fs_öfo
->
˛ó√r_kthªad
)) {

4147 
ªt
 = 
	`PTR_ERR
(
fs_öfo
->
˛ó√r_kthªad
);

4148 
Áû_sysfs
;

4151 
fs_öfo
->
å™ß˘i⁄_kthªad
 = 
	`kthªad_run
(transaction_kthread,

4152 
åì_roŸ
,

4154 i‡(
	`IS_ERR
(
fs_öfo
->
å™ß˘i⁄_kthªad
)) {

4155 
ªt
 = 
	`PTR_ERR
(
fs_öfo
->
å™ß˘i⁄_kthªad
);

4156 
Áû_˛ó√r
;

4159 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
NOSSD
) &&

4160 !
fs_öfo
->
fs_devi˚s
->
rŸ©ög
) {

4161 
	`båfs_£t_™d_öfo
(
fs_öfo
, 
SSD
, "enabling ssd optimizations");

4173 i‡(!(
	`båfs_ã°_›t
(
fs_öfo
, 
DISCARD_SYNC
) ||

4174 
	`båfs_ã°_›t
(
fs_öfo
, 
DISCARD_ASYNC
) ||

4175 
	`båfs_ã°_›t
(
fs_öfo
, 
NODISCARD
)) &&

4176 
fs_öfo
->
fs_devi˚s
->
disˇrdabÀ
 &&

4177 !
	`båfs_is_z⁄ed
(
fs_öfo
)) {

4178 
	`båfs_£t_™d_öfo
(
fs_öfo
, 
DISCARD_ASYNC
,

4182 #ifde‡
CONFIG_BTRFS_FS_CHECK_INTEGRITY


4183 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
CHECK_INTEGRITY
)) {

4184 
ªt
 = 
	`båfsic_mou¡
(
fs_öfo
, 
fs_devi˚s
,

4185 
	`båfs_ã°_›t
(
fs_öfo
,

4186 
CHECK_INTEGRITY_DATA
) ? 1 : 0,

4187 
fs_öfo
->
check_öãgrôy_¥öt_mask
);

4188 i‡(
ªt
)

4189 
	`båfs_w¨n
(
fs_öfo
,

4191 
ªt
);

4194 
ªt
 = 
	`båfs_ªad_qgroup_c⁄fig
(
fs_öfo
);

4195 i‡(
ªt
)

4196 
Áû_å™s_kthªad
;

4198 i‡(
	`båfs_buûd_ªf_åì
(
fs_öfo
))

4199 
	`båfs_îr
(
fs_öfo
, "couldn't buildÑefÅree");

4202 i‡(
	`båfs_su≥r_log_roŸ
(
disk_su≥r
) != 0 &&

4203 !
	`båfs_ã°_›t
(
fs_öfo
, 
NOLOGREPLAY
)) {

4204 
	`båfs_öfo
(
fs_öfo
, "startÅree-logÑeplay");

4205 
ªt
 = 
	`båfs_ª∂ay_log
(
fs_öfo
, 
fs_devi˚s
);

4206 i‡(
ªt
)

4207 
Áû_qgroup
;

4210 
fs_öfo
->
fs_roŸ
 = 
	`båfs_gë_fs_roŸ
(fs_öfo, 
BTRFS_FS_TREE_OBJECTID
, 
åue
);

4211 i‡(
	`IS_ERR
(
fs_öfo
->
fs_roŸ
)) {

4212 
ªt
 = 
	`PTR_ERR
(
fs_öfo
->
fs_roŸ
);

4213 
	`båfs_w¨n
(
fs_öfo
, "ÁûedÅÿªad f†åì: %d", 
ªt
);

4214 
fs_öfo
->
fs_roŸ
 = 
NULL
;

4215 
Áû_qgroup
;

4218 i‡(
	`sb_rd⁄ly
(
sb
))

4219 
˛ór_⁄eshŸ
;

4221 
ªt
 = 
	`båfs_°¨t_¥e_rw_mou¡
(
fs_öfo
);

4222 i‡(
ªt
) {

4223 
	`˛o£_˘ªe
(
fs_öfo
);

4224  
ªt
;

4226 
	`båfs_disˇrd_ªsume
(
fs_öfo
);

4228 i‡(
fs_öfo
->
uuid_roŸ
 &&

4229 (
	`båfs_ã°_›t
(
fs_öfo
, 
RESCAN_UUID_TREE
) ||

4230 
fs_öfo
->
gíî©i⁄
 !
	`båfs_su≥r_uuid_åì_gíî©i⁄
(
disk_su≥r
))) {

4231 
	`båfs_öfo
(
fs_öfo
, "checking UUIDÅree");

4232 
ªt
 = 
	`båfs_check_uuid_åì
(
fs_öfo
);

4233 i‡(
ªt
) {

4234 
	`båfs_w¨n
(
fs_öfo
,

4235 "ÁûedÅÿcheckÅhêUUIDÅªe: %d", 
ªt
);

4236 
	`˛o£_˘ªe
(
fs_öfo
);

4237  
ªt
;

4241 
	`£t_bô
(
BTRFS_FS_OPEN
, &
fs_öfo
->
Êags
);

4244 i‡(
	`ã°_bô
(
BTRFS_FS_UNFINISHED_DROPS
, &
fs_öfo
->
Êags
))

4245 
	`wake_up_¥o˚ss
(
fs_öfo
->
˛ó√r_kthªad
);

4247 
˛ór_⁄eshŸ
:

4248 
	`båfs_˛ór_⁄eshŸ_›ti⁄s
(
fs_öfo
);

4251 
Áû_qgroup
:

4252 
	`båfs_‰ì_qgroup_c⁄fig
(
fs_öfo
);

4253 
Áû_å™s_kthªad
:

4254 
	`kthªad_°›
(
fs_öfo
->
å™ß˘i⁄_kthªad
);

4255 
	`båfs_˛ónup_å™ß˘i⁄
(
fs_öfo
);

4256 
	`båfs_‰ì_fs_roŸs
(
fs_öfo
);

4257 
Áû_˛ó√r
:

4258 
	`kthªad_°›
(
fs_öfo
->
˛ó√r_kthªad
);

4264 
	`fûem≠_wrôe_™d_waô
(
fs_öfo
->
båì_öode
->
i_m≠pög
);

4266 
Áû_sysfs
:

4267 
	`båfs_sysfs_ªmove_mou¡ed
(
fs_öfo
);

4269 
Áû_fsdev_sysfs
:

4270 
	`båfs_sysfs_ªmove_fsid
(
fs_öfo
->
fs_devi˚s
);

4272 
Áû_block_groups
:

4273 
	`båfs_put_block_group_ˇche
(
fs_öfo
);

4275 
Áû_åì_roŸs
:

4276 i‡(
fs_öfo
->
d©a_ªloc_roŸ
)

4277 
	`båfs_dr›_™d_‰ì_fs_roŸ
(
fs_öfo
, fs_öfo->
d©a_ªloc_roŸ
);

4278 
	`‰ì_roŸ_poöãrs
(
fs_öfo
, 
åue
);

4279 
	`övÆid©e_öode_∑ges2
(
fs_öfo
->
båì_öode
->
i_m≠pög
);

4281 
Áû_sb_buf„r
:

4282 
	`båfs_°›_Æl_w‹kîs
(
fs_öfo
);

4283 
	`båfs_‰ì_block_groups
(
fs_öfo
);

4284 
Áû_Æloc
:

4285 
	`båfs_m≠pög_åì_‰ì
(&
fs_öfo
->
m≠pög_åì
);

4287 
	`ùut
(
fs_öfo
->
båì_öode
);

4288 
Áû
:

4289 
	`båfs_˛o£_devi˚s
(
fs_öfo
->
fs_devi˚s
);

4290 
	`ASSERT
(
ªt
 < 0);

4291  
ªt
;

4292 
	}
}

4293 
ALLOW_ERROR_INJECTION
(
›í_˘ªe_∑πôi⁄
, 
ERRNO
);

4296 
	$båfs_íd_su≥r_wrôe
(
bio
 *bio)

4298 
båfs_devi˚
 *
devi˚
 = 
bio
->
bi_¥iv©e
;

4299 
bio_vec
 *
bvec
;

4300 
bvec_ôî_Æl
 
ôî_Æl
;

4301 
∑ge
 *page;

4303 
	`bio_f‹_óch_£gmít_Æl
(
bvec
, 
bio
, 
ôî_Æl
) {

4304 
∑ge
 = 
bvec
->
bv_∑ge
;

4306 i‡(
bio
->
bi_°©us
) {

4307 
	`båfs_w¨n_æ_ö_rcu
(
devi˚
->
fs_öfo
,

4309 
	`båfs_dev_«me
(
devi˚
),

4310 
	`blk_°©us_to_î∫o
(
bio
->
bi_°©us
));

4311 
	`CÀ¨PageU±od©e
(
∑ge
);

4312 
	`SëPageEº‹
(
∑ge
);

4313 
	`båfs_dev_°©_öc_™d_¥öt
(
devi˚
,

4314 
BTRFS_DEV_STAT_WRITE_ERRS
);

4316 
	`SëPageU±od©e
(
∑ge
);

4319 
	`put_∑ge
(
∑ge
);

4320 
	`u∆ock_∑ge
(
∑ge
);

4323 
	`bio_put
(
bio
);

4324 
	}
}

4326 
båfs_su≥r_block
 *
	$båfs_ªad_dev_⁄e_su≥r
(
block_devi˚
 *
bdev
,

4327 
c›y_num
, 
boﬁ
 
dr›_ˇche
)

4329 
båfs_su≥r_block
 *
su≥r
;

4330 
∑ge
 *page;

4331 
u64
 
byãƒ
, 
byãƒ_‹ig
;

4332 
addªss_•a˚
 *
m≠pög
 = 
bdev
->
bd_öode
->
i_m≠pög
;

4333 
ªt
;

4335 
byãƒ_‹ig
 = 
	`båfs_sb_off£t
(
c›y_num
);

4336 
ªt
 = 
	`båfs_sb_log_loˇti⁄_bdev
(
bdev
, 
c›y_num
, 
READ
, &
byãƒ
);

4337 i‡(
ªt
 =-
ENOENT
)

4338  
	`ERR_PTR
(-
EINVAL
);

4339 i‡(
ªt
)

4340  
	`ERR_PTR
(
ªt
);

4342 i‡(
byãƒ
 + 
BTRFS_SUPER_INFO_SIZE
 >
	`bdev_ƒ_byãs
(
bdev
))

4343  
	`ERR_PTR
(-
EINVAL
);

4345 i‡(
dr›_ˇche
) {

4347 
	`ASSERT
(
c›y_num
 == 0);

4353 
	`övÆid©e_öode_∑ges2_ønge
(
m≠pög
,

4354 
byãƒ
 >> 
PAGE_SHIFT
,

4355 (
byãƒ
 + 
BTRFS_SUPER_INFO_SIZE
Ë>> 
PAGE_SHIFT
);

4358 
∑ge
 = 
	`ªad_ˇche_∑ge_gÂ
(
m≠pög
, 
byãƒ
 >> 
PAGE_SHIFT
, 
GFP_NOFS
);

4359 i‡(
	`IS_ERR
(
∑ge
))

4360  
	`ERR_CAST
(
∑ge
);

4362 
su≥r
 = 
	`∑ge_addªss
(
∑ge
);

4363 i‡(
	`båfs_su≥r_magic
(
su≥r
Ë!
BTRFS_MAGIC
) {

4364 
	`båfs_ªÀa£_disk_su≥r
(
su≥r
);

4365  
	`ERR_PTR
(-
ENODATA
);

4368 i‡(
	`båfs_su≥r_byãƒ
(
su≥r
Ë!
byãƒ_‹ig
) {

4369 
	`båfs_ªÀa£_disk_su≥r
(
su≥r
);

4370  
	`ERR_PTR
(-
EINVAL
);

4373  
su≥r
;

4374 
	}
}

4377 
båfs_su≥r_block
 *
	$båfs_ªad_dev_⁄e_su≥r_∑πôi⁄
(
block_devi˚
 *
bdev
,

4378 
c›y_num
, 
boﬁ
 
dr›_ˇche
, 
∑πôi⁄_‹dî
)

4380 
båfs_su≥r_block
 *
su≥r
;

4381 
∑ge
 *page;

4382 
u64
 
byãƒ
, 
byãƒ_‹ig
;

4383 
addªss_•a˚
 *
m≠pög
 = 
bdev
->
bd_öode
->
i_m≠pög
;

4384 
ªt
;

4385 
u64
 
sb_off£t
 = 
BTRFS_SUPER_INFO_SIZE
 * 
∑πôi⁄_‹dî
;

4386 
byãƒ_‹ig
 = 
	`båfs_sb_off£t_∑πôi⁄
(
c›y_num
, 
sb_off£t
);

4388 
ªt
 = 
	`båfs_sb_log_loˇti⁄_bdev_∑πôi⁄
(
bdev
, 
c›y_num
, 
READ
, &
byãƒ
, 
sb_off£t
);

4391 i‡(
ªt
 =-
ENOENT
)

4392  
	`ERR_PTR
(-
EINVAL
);

4393 i‡(
ªt
)

4394  
	`ERR_PTR
(
ªt
);

4396 i‡(
byãƒ
 + 
BTRFS_SUPER_INFO_SIZE
 >
	`bdev_ƒ_byãs
(
bdev
))

4397  
	`ERR_PTR
(-
EINVAL
);

4399 i‡(
dr›_ˇche
) {

4401 
	`ASSERT
(
c›y_num
 == 0);

4407 
	`övÆid©e_öode_∑ges2_ønge
(
m≠pög
,

4408 
byãƒ
 >> 
PAGE_SHIFT
,

4409 (
byãƒ
 + 
BTRFS_SUPER_INFO_SIZE
Ë>> 
PAGE_SHIFT
);

4412 
∑ge
 = 
	`ªad_ˇche_∑ge_gÂ
(
m≠pög
, 
byãƒ
 >> 
PAGE_SHIFT
, 
GFP_NOFS
);

4413 i‡(
	`IS_ERR
(
∑ge
))

4414  
	`ERR_CAST
(
∑ge
);

4416 
su≥r
 = 
	`∑ge_addªss
(
∑ge
);

4417 i‡(
	`båfs_su≥r_magic
(
su≥r
Ë!
BTRFS_MAGIC
) {

4418 
	`båfs_ªÀa£_disk_su≥r
(
su≥r
);

4419  
	`ERR_PTR
(-
ENODATA
);

4422 i‡(
	`båfs_su≥r_byãƒ
(
su≥r
Ë!
byãƒ_‹ig
) {

4423 
	`båfs_ªÀa£_disk_su≥r
(
su≥r
);

4424  
	`ERR_PTR
(-
EINVAL
);

4427  
su≥r
;

4428 
	}
}

4431 
båfs_su≥r_block
 *
	$båfs_ªad_dev_su≥r
(
block_devi˚
 *
bdev
)

4433 
båfs_su≥r_block
 *
su≥r
, *
œã°
 = 
NULL
;

4434 
i
;

4435 
u64
 
å™sid
 = 0;

4442 
i
 = 0; i < 1; i++) {

4443 
su≥r
 = 
	`båfs_ªad_dev_⁄e_su≥r
(
bdev
, 
i
, 
Ál£
);

4444 i‡(
	`IS_ERR
(
su≥r
))

4447 i‡(!
œã°
 || 
	`båfs_su≥r_gíî©i⁄
(
su≥r
Ë> 
å™sid
) {

4448 i‡(
œã°
)

4449 
	`båfs_ªÀa£_disk_su≥r
(
su≥r
);

4451 
œã°
 = 
su≥r
;

4452 
å™sid
 = 
	`båfs_su≥r_gíî©i⁄
(
su≥r
);

4456  
su≥r
;

4457 
	}
}

4460 
båfs_su≥r_block
 *
	$båfs_ªad_dev_su≥r_∑πôi⁄
(
block_devi˚
 *
bdev
, 
∑πôi⁄_‹dî
)

4462 
båfs_su≥r_block
 *
su≥r
, *
œã°
 = 
NULL
;

4463 
i
;

4464 
u64
 
å™sid
 = 0;

4471 
i
 = 0; i < 1; i++) {

4472 
su≥r
 = 
	`båfs_ªad_dev_⁄e_su≥r_∑πôi⁄
(
bdev
, 
i
, 
Ál£
, 
∑πôi⁄_‹dî
);

4473 i‡(
	`IS_ERR
(
su≥r
))

4476 i‡(!
œã°
 || 
	`båfs_su≥r_gíî©i⁄
(
su≥r
Ë> 
å™sid
) {

4477 i‡(
œã°
)

4478 
	`båfs_ªÀa£_disk_su≥r
(
su≥r
);

4480 
œã°
 = 
su≥r
;

4481 
å™sid
 = 
	`båfs_su≥r_gíî©i⁄
(
su≥r
);

4484 i‡(
	`IS_ERR
(
su≥r
))

4485 
	`¥ötk
(
KERN_ERR
 "btrfs_read_dev_super_partition: super isÉrror\n");

4486  
su≥r
;

4487 
	}
}

4500 
	$wrôe_dev_su≥rs
(
båfs_devi˚
 *
devi˚
,

4501 
båfs_su≥r_block
 *
sb
, 
max_múr‹s
)

4503 
båfs_fs_öfo
 *
fs_öfo
 = 
devi˚
->fs_info;

4504 
addªss_•a˚
 *
m≠pög
 = 
devi˚
->
bdev
->
bd_öode
->
i_m≠pög
;

4505 
	`SHASH_DESC_ON_STACK
(
shash
, 
fs_öfo
->
csum_shash
);

4506 
i
;

4507 
îr‹s
 = 0;

4508 
ªt
;

4509 
u64
 
byãƒ
, 
byãƒ_‹ig
;

4511 i‡(
max_múr‹s
 == 0)

4512 
max_múr‹s
 = 
BTRFS_SUPER_MIRROR_MAX
;

4514 
shash
->
tfm
 = 
fs_öfo
->
csum_shash
;

4516 
u64
 
sb_byãƒ_‰om_fs_öfo
 = 
fs_öfo
->
su≥r_c›y
->
byãƒ
;

4518 
u64
 
sb_off£t
 = 0;

4519 i‡(
sb_byãƒ_‰om_fs_öfo
 < 
BTRFS_SUPER_INFO_OFFSET_1
)

4520 
sb_off£t
 = 
sb_byãƒ_‰om_fs_öfo
 - 
BTRFS_SUPER_INFO_OFFSET
;

4521 i‡(
sb_byãƒ_‰om_fs_öfo
 < 
BTRFS_SUPER_INFO_OFFSET_2
)

4522 
sb_off£t
 = 
sb_byãƒ_‰om_fs_öfo
 - 
BTRFS_SUPER_INFO_OFFSET_1
;

4524 
sb_off£t
 = 
sb_byãƒ_‰om_fs_öfo
 - 
BTRFS_SUPER_INFO_OFFSET_2
;

4526 
i
 = 0; i < 
max_múr‹s
; i++) {

4527 
∑ge
 *page;

4528 
bio
 *bio;

4529 
båfs_su≥r_block
 *
disk_su≥r
;

4533 
byãƒ_‹ig
 = 
	`båfs_sb_off£t_∑πôi⁄
(
i
, 
sb_off£t
);

4534 
ªt
 = 
	`båfs_sb_log_loˇti⁄_∑πôi⁄
(
devi˚
, 
i
, 
WRITE
, &
byãƒ
, 
sb_off£t
);

4535 i‡(
ªt
 =-
ENOENT
) {

4537 } i‡(
ªt
 < 0) {

4538 
	`båfs_îr
(
devi˚
->
fs_öfo
,

4540 
i
);

4541 
îr‹s
++;

4544 i‡(
byãƒ
 + 
BTRFS_SUPER_INFO_SIZE
 >=

4545 
devi˚
->
∑πôi⁄_íd
)

4548 
	`båfs_£t_su≥r_byãƒ
(
sb
, 
byãƒ_‹ig
);

4550 
	`¸y±o_shash_dige°
(
shash
, (c⁄° *)
sb
 + 
BTRFS_CSUM_SIZE
,

4551 
BTRFS_SUPER_INFO_SIZE
 - 
BTRFS_CSUM_SIZE
,

4552 
sb
->
csum
);

4554 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
m≠pög
, 
byãƒ
 >> 
PAGE_SHIFT
,

4555 
GFP_NOFS
);

4556 i‡(!
∑ge
) {

4557 
	`båfs_îr
(
devi˚
->
fs_öfo
,

4559 
byãƒ
);

4560 
îr‹s
++;

4565 
	`gë_∑ge
(
∑ge
);

4567 
disk_su≥r
 = 
	`∑ge_addªss
(
∑ge
);

4568 
	`mem˝y
(
disk_su≥r
, 
sb
, 
BTRFS_SUPER_INFO_SIZE
);

4575 
bio
 = 
	`bio_Æloc
(
devi˚
->
bdev
, 1,

4576 
REQ_OP_WRITE
 | 
REQ_SYNC
 | 
REQ_META
 | 
REQ_PRIO
,

4577 
GFP_NOFS
);

4578 
bio
->
bi_ôî
.
bi_£˘‹
 = 
byãƒ
 >> 
SECTOR_SHIFT
;

4579 
bio
->
bi_¥iv©e
 = 
devi˚
;

4580 
bio
->
bi_íd_io
 = 
båfs_íd_su≥r_wrôe
;

4581 
	`__bio_add_∑ge
(
bio
, 
∑ge
, 
BTRFS_SUPER_INFO_SIZE
,

4582 
	`off£t_ö_∑ge
(
byãƒ
));

4589 i‡(
i
 =0 && !
	`båfs_ã°_›t
(
devi˚
->
fs_öfo
, 
NOBARRIER
))

4590 
bio
->
bi_›f
 |
REQ_FUA
;

4592 
	`båfsic_check_bio
(
bio
);

4593 
	`submô_bio
(
bio
);

4595 i‡(
	`båfs_adv™˚_sb_log
(
devi˚
, 
i
))

4596 
îr‹s
++;

4598  
îr‹s
 < 
i
 ? 0 : -1;

4599 
	}
}

4608 
	$waô_dev_su≥rs
(
båfs_devi˚
 *
devi˚
, 
max_múr‹s
)

4610 
i
;

4611 
îr‹s
 = 0;

4612 
boﬁ
 
¥im¨y_Áûed
 = 
Ál£
;

4613 
ªt
;

4614 
u64
 
byãƒ
;

4616 i‡(
max_múr‹s
 == 0)

4617 
max_múr‹s
 = 
BTRFS_SUPER_MIRROR_MAX
;

4619 
båfs_fs_öfo
 *
fs_öfo
 = 
devi˚
->fs_info;

4620 
u64
 
sb_byãƒ_‰om_fs_öfo
 = 
fs_öfo
->
su≥r_c›y
->
byãƒ
;

4622 
u64
 
sb_off£t
 = 0;

4623 i‡(
sb_byãƒ_‰om_fs_öfo
 < 
BTRFS_SUPER_INFO_OFFSET_1
)

4624 
sb_off£t
 = 
sb_byãƒ_‰om_fs_öfo
 - 
BTRFS_SUPER_INFO_OFFSET
;

4625 i‡(
sb_byãƒ_‰om_fs_öfo
 < 
BTRFS_SUPER_INFO_OFFSET_2
)

4626 
sb_off£t
 = 
sb_byãƒ_‰om_fs_öfo
 - 
BTRFS_SUPER_INFO_OFFSET_1
;

4628 
sb_off£t
 = 
sb_byãƒ_‰om_fs_öfo
 - 
BTRFS_SUPER_INFO_OFFSET_2
;

4631 
i
 = 0; i < 
max_múr‹s
; i++) {

4632 
∑ge
 *page;

4634 
ªt
 = 
	`båfs_sb_log_loˇti⁄_∑πôi⁄
(
devi˚
, 
i
, 
WRITE
, &
byãƒ
, 
sb_off£t
);

4635 i‡(
ªt
 =-
ENOENT
) {

4637 } i‡(
ªt
 < 0) {

4638 
îr‹s
++;

4639 i‡(
i
 == 0)

4640 
¥im¨y_Áûed
 = 
åue
;

4643 i‡(
byãƒ
 + 
BTRFS_SUPER_INFO_SIZE
 >=

4644 
devi˚
->
commô_tŸÆ_byãs
)

4647 
∑ge
 = 
	`föd_gë_∑ge
(
devi˚
->
bdev
->
bd_öode
->
i_m≠pög
,

4648 
byãƒ
 >> 
PAGE_SHIFT
);

4649 i‡(!
∑ge
) {

4650 
îr‹s
++;

4651 i‡(
i
 == 0)

4652 
¥im¨y_Áûed
 = 
åue
;

4656 
	`waô_⁄_∑ge_locked
(
∑ge
);

4657 i‡(
	`PageEº‹
(
∑ge
)) {

4658 
îr‹s
++;

4659 i‡(
i
 == 0)

4660 
¥im¨y_Áûed
 = 
åue
;

4664 
	`put_∑ge
(
∑ge
);

4667 
	`put_∑ge
(
∑ge
);

4671 i‡(
¥im¨y_Áûed
) {

4672 
	`båfs_îr
(
devi˚
->
fs_öfo
, "error writingÖrimary super blockÅo device %llu",

4673 
devi˚
->
devid
);

4677  
îr‹s
 < 
i
 ? 0 : -1;

4678 
	}
}

4684 
	$båfs_íd_em±y_b¨rõr
(
bio
 *bio)

4686 
	`bio_unöô
(
bio
);

4687 
	`com∂ëe
(
bio
->
bi_¥iv©e
);

4688 
	}
}

4694 
	$wrôe_dev_Êush
(
båfs_devi˚
 *
devi˚
)

4696 
bio
 *biÿ&
devi˚
->
Êush_bio
;

4698 
devi˚
->
œ°_Êush_îr‹
 = 
BLK_STS_OK
;

4700 #i‚de‡
CONFIG_BTRFS_FS_CHECK_INTEGRITY


4711 i‡(!
	`bdev_wrôe_ˇche
(
devi˚
->
bdev
))

4715 
	`bio_öô
(
bio
, 
devi˚
->
bdev
, 
NULL
, 0,

4716 
REQ_OP_WRITE
 | 
REQ_SYNC
 | 
REQ_PREFLUSH
);

4717 
bio
->
bi_íd_io
 = 
båfs_íd_em±y_b¨rõr
;

4718 
	`öô_com∂ëi⁄
(&
devi˚
->
Êush_waô
);

4719 
bio
->
bi_¥iv©e
 = &
devi˚
->
Êush_waô
;

4721 
	`båfsic_check_bio
(
bio
);

4722 
	`submô_bio
(
bio
);

4723 
	`£t_bô
(
BTRFS_DEV_STATE_FLUSH_SENT
, &
devi˚
->
dev_°©e
);

4724 
	}
}

4730 
boﬁ
 
	$waô_dev_Êush
(
båfs_devi˚
 *
devi˚
)

4732 
bio
 *biÿ&
devi˚
->
Êush_bio
;

4734 i‡(!
	`ã°_™d_˛ór_bô
(
BTRFS_DEV_STATE_FLUSH_SENT
, &
devi˚
->
dev_°©e
))

4735  
Ál£
;

4737 
	`waô_f‹_com∂ëi⁄_io
(&
devi˚
->
Êush_waô
);

4739 i‡(
bio
->
bi_°©us
) {

4740 
devi˚
->
œ°_Êush_îr‹
 = 
bio
->
bi_°©us
;

4741 
	`båfs_dev_°©_öc_™d_¥öt
(
devi˚
, 
BTRFS_DEV_STAT_FLUSH_ERRS
);

4742  
åue
;

4745  
Ál£
;

4746 
	}
}

4752 
	$b¨rõr_Æl_devi˚s
(
båfs_fs_öfo
 *
öfo
)

4754 
li°_hód
 *
hód
;

4755 
båfs_devi˚
 *
dev
;

4756 
îr‹s_waô
 = 0;

4758 
	`lockdï_as£π_hñd
(&
öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

4760 
hód
 = &
öfo
->
fs_devi˚s
->
devi˚s
;

4761 
	`li°_f‹_óch_íåy
(
dev
, 
hód
, 
dev_li°
) {

4762 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
, &
dev
->
dev_°©e
))

4764 i‡(!
dev
->
bdev
)

4766 i‡(!
	`ã°_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
dev
->
dev_°©e
) ||

4767 !
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
dev
->
dev_°©e
))

4770 
	`wrôe_dev_Êush
(
dev
);

4774 
	`li°_f‹_óch_íåy
(
dev
, 
hód
, 
dev_li°
) {

4775 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
, &
dev
->
dev_°©e
))

4777 i‡(!
dev
->
bdev
) {

4778 
îr‹s_waô
++;

4781 i‡(!
	`ã°_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
dev
->
dev_°©e
) ||

4782 !
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
dev
->
dev_°©e
))

4785 i‡(
	`waô_dev_Êush
(
dev
))

4786 
îr‹s_waô
++;

4793 i‡(
îr‹s_waô
 && !
	`båfs_check_rw_degødabÀ
(
öfo
, 
NULL
))

4794  -
EIO
;

4797 
	}
}

4799 
	$båfs_gë_num_tﬁî©ed_disk_b¨rõr_Áûuªs
(
u64
 
Êags
)

4801 
øid_ty≥
;

4802 
mö_tﬁî©ed
 = 
INT_MAX
;

4804 i‡((
Êags
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) == 0 ||

4805 (
Êags
 & 
BTRFS_AVAIL_ALLOC_BIT_SINGLE
))

4806 
mö_tﬁî©ed
 = 
	`mö_t
(, min_tolerated,

4807 
båfs_øid_¨øy
[
BTRFS_RAID_SINGLE
].

4808 
tﬁî©ed_Áûuªs
);

4810 
øid_ty≥
 = 0;Ñaid_ty≥ < 
BTRFS_NR_RAID_TYPES
;Ñaid_type++) {

4811 i‡(
øid_ty≥
 =
BTRFS_RAID_SINGLE
)

4813 i‡(!(
Êags
 & 
båfs_øid_¨øy
[
øid_ty≥
].
bg_Êag
))

4815 
mö_tﬁî©ed
 = 
	`mö_t
(, min_tolerated,

4816 
båfs_øid_¨øy
[
øid_ty≥
].

4817 
tﬁî©ed_Áûuªs
);

4820 i‡(
mö_tﬁî©ed
 =
INT_MAX
) {

4821 
	`¥_w¨n
("BTRFS: unknow¿øid fœg: %Œu", 
Êags
);

4822 
mö_tﬁî©ed
 = 0;

4825  
mö_tﬁî©ed
;

4826 
	}
}

4828 
	$wrôe_Æl_su≥rs
(
båfs_fs_öfo
 *
fs_öfo
, 
max_múr‹s
)

4830 
li°_hód
 *
hód
;

4831 
båfs_devi˚
 *
dev
;

4832 
båfs_su≥r_block
 *
sb
;

4833 
båfs_dev_ôem
 *
dev_ôem
;

4834 
ªt
;

4835 
do_b¨rõrs
;

4836 
max_îr‹s
;

4837 
tŸÆ_îr‹s
 = 0;

4838 
u64
 
Êags
;

4840 
do_b¨rõrs
 = !
	`båfs_ã°_›t
(
fs_öfo
, 
NOBARRIER
);

4847 i‡(
max_múr‹s
 == 0)

4848 
	`backup_su≥r_roŸs
(
fs_öfo
);

4850 
sb
 = 
fs_öfo
->
su≥r_f‹_commô
;

4851 
dev_ôem
 = &
sb
->dev_item;

4853 
	`muãx_lock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

4854 
hód
 = &
fs_öfo
->
fs_devi˚s
->
devi˚s
;

4855 
max_îr‹s
 = 
	`båfs_su≥r_num_devi˚s
(
fs_öfo
->
su≥r_c›y
) - 1;

4857 i‡(
do_b¨rõrs
) {

4858 
ªt
 = 
	`b¨rõr_Æl_devi˚s
(
fs_öfo
);

4859 i‡(
ªt
) {

4860 
	`muãx_u∆ock
(

4861 &
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

4862 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
ªt
,

4864  
ªt
;

4868 
	`li°_f‹_óch_íåy
(
dev
, 
hód
, 
dev_li°
) {

4869 i‡(!
dev
->
bdev
) {

4870 
tŸÆ_îr‹s
++;

4873 i‡(!
	`ã°_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
dev
->
dev_°©e
) ||

4874 !
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
dev
->
dev_°©e
))

4877 
	`båfs_£t_°ack_devi˚_gíî©i⁄
(
dev_ôem
, 0);

4878 
	`båfs_£t_°ack_devi˚_ty≥
(
dev_ôem
, 
dev
->
ty≥
);

4879 
	`båfs_£t_°ack_devi˚_id
(
dev_ôem
, 
dev
->
devid
);

4880 
	`båfs_£t_°ack_devi˚_tŸÆ_byãs
(
dev_ôem
,

4881 
dev
->
commô_tŸÆ_byãs
);

4882 
	`båfs_£t_°ack_devi˚_byãs_u£d
(
dev_ôem
,

4883 
dev
->
commô_byãs_u£d
);

4884 
	`båfs_£t_°ack_devi˚_io_Æign
(
dev_ôem
, 
dev
->
io_Æign
);

4885 
	`båfs_£t_°ack_devi˚_io_width
(
dev_ôem
, 
dev
->
io_width
);

4886 
	`båfs_£t_°ack_devi˚_£˘‹_size
(
dev_ôem
, 
dev
->
£˘‹_size
);

4887 
	`mem˝y
(
dev_ôem
->
uuid
, 
dev
->uuid, 
BTRFS_UUID_SIZE
);

4888 
	`mem˝y
(
dev_ôem
->
fsid
, 
dev
->
fs_devi˚s
->
mëad©a_uuid
,

4889 
BTRFS_FSID_SIZE
);

4891 
Êags
 = 
	`båfs_su≥r_Êags
(
sb
);

4892 
	`båfs_£t_su≥r_Êags
(
sb
, 
Êags
 | 
BTRFS_HEADER_FLAG_WRITTEN
);

4894 
ªt
 = 
	`båfs_vÆid©e_wrôe_su≥r
(
fs_öfo
, 
sb
);

4895 i‡(
ªt
 < 0) {

4896 
	`muãx_u∆ock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

4897 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, -
EUCLEAN
,

4899  -
EUCLEAN
;

4902 
ªt
 = 
	`wrôe_dev_su≥rs
(
dev
, 
sb
, 
max_múr‹s
);

4903 i‡(
ªt
)

4904 
tŸÆ_îr‹s
++;

4906 i‡(
tŸÆ_îr‹s
 > 
max_îr‹s
) {

4907 
	`båfs_îr
(
fs_öfo
, "%dÉrrors while writing supers",

4908 
tŸÆ_îr‹s
);

4909 
	`muãx_u∆ock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

4912 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, -
EIO
,

4914 
tŸÆ_îr‹s
);

4915  -
EIO
;

4918 
tŸÆ_îr‹s
 = 0;

4919 
	`li°_f‹_óch_íåy
(
dev
, 
hód
, 
dev_li°
) {

4920 i‡(!
dev
->
bdev
)

4922 i‡(!
	`ã°_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
dev
->
dev_°©e
) ||

4923 !
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
dev
->
dev_°©e
))

4926 
ªt
 = 
	`waô_dev_su≥rs
(
dev
, 
max_múr‹s
);

4927 i‡(
ªt
)

4928 
tŸÆ_îr‹s
++;

4930 
	`muãx_u∆ock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

4931 i‡(
tŸÆ_îr‹s
 > 
max_îr‹s
) {

4932 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, -
EIO
,

4934 
tŸÆ_îr‹s
);

4935  -
EIO
;

4938 
	}
}

4941 
	$båfs_dr›_™d_‰ì_fs_roŸ
(
båfs_fs_öfo
 *
fs_öfo
,

4942 
båfs_roŸ
 *
roŸ
)

4944 
boﬁ
 
dr›_ªf
 = 
Ál£
;

4946 
	`•ö_lock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

4947 
	`ødix_åì_dñëe
(&
fs_öfo
->
fs_roŸs_ødix
,

4948 ()
roŸ
->
roŸ_key
.
obje˘id
);

4949 i‡(
	`ã°_™d_˛ór_bô
(
BTRFS_ROOT_IN_RADIX
, &
roŸ
->
°©e
))

4950 
dr›_ªf
 = 
åue
;

4951 
	`•ö_u∆ock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

4953 i‡(
	`BTRFS_FS_ERROR
(
fs_öfo
)) {

4954 
	`ASSERT
(
roŸ
->
log_roŸ
 =
NULL
);

4955 i‡(
roŸ
->
ªloc_roŸ
) {

4956 
	`båfs_put_roŸ
(
roŸ
->
ªloc_roŸ
);

4957 
roŸ
->
ªloc_roŸ
 = 
NULL
;

4961 i‡(
dr›_ªf
)

4962 
	`båfs_put_roŸ
(
roŸ
);

4963 
	}
}

4965 
	$båfs_commô_su≥r
(
båfs_fs_öfo
 *
fs_öfo
)

4967 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
åì_roŸ
;

4968 
båfs_å™s_h™dÀ
 *
å™s
;

4970 
	`muãx_lock
(&
fs_öfo
->
˛ó√r_muãx
);

4971 
	`båfs_run_dñayed_ùuts
(
fs_öfo
);

4972 
	`muãx_u∆ock
(&
fs_öfo
->
˛ó√r_muãx
);

4973 
	`wake_up_¥o˚ss
(
fs_öfo
->
˛ó√r_kthªad
);

4976 
	`down_wrôe
(&
fs_öfo
->
˛ónup_w‹k_£m
);

4977 
	`up_wrôe
(&
fs_öfo
->
˛ónup_w‹k_£m
);

4979 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
roŸ
);

4980 i‡(
	`IS_ERR
(
å™s
))

4981  
	`PTR_ERR
(
å™s
);

4982  
	`båfs_commô_å™ß˘i⁄
(
å™s
);

4983 
	}
}

4985 
	$w¨n_about_uncommôãd_å™s
(
båfs_fs_öfo
 *
fs_öfo
)

4987 
båfs_å™ß˘i⁄
 *
å™s
;

4988 
båfs_å™ß˘i⁄
 *
tmp
;

4989 
boﬁ
 
found
 = 
Ál£
;

4991 i‡(
	`li°_em±y
(&
fs_öfo
->
å™s_li°
))

4998 
	`ASSERT
(
	`ã°_bô
(
BTRFS_FS_CLOSING_DONE
, &
fs_öfo
->
Êags
));

4999 
	`li°_f‹_óch_íåy_ß„
(
å™s
, 
tmp
, &
fs_öfo
->
å™s_li°
, 
li°
) {

5000 
exã¡_°©e
 *
ˇched
 = 
NULL
;

5001 
u64
 
dúty_byãs
 = 0;

5002 
u64
 
cur
 = 0;

5003 
u64
 
found_°¨t
;

5004 
u64
 
found_íd
;

5006 
found
 = 
åue
;

5007 
	`föd_fú°_exã¡_bô
(&
å™s
->
dúty_∑ges
, 
cur
,

5008 &
found_°¨t
, &
found_íd
, 
EXTENT_DIRTY
, &
ˇched
)) {

5009 
dúty_byãs
 +
found_íd
 + 1 - 
found_°¨t
;

5010 
cur
 = 
found_íd
 + 1;

5012 
	`båfs_w¨n
(
fs_öfo
,

5014 
å™s
->
å™sid
, 
dúty_byãs
);

5015 
	`båfs_˛ónup_⁄e_å™ß˘i⁄
(
å™s
, 
fs_öfo
);

5017 i‡(
å™s
 =
fs_öfo
->
ru¬ög_å™ß˘i⁄
)

5018 
fs_öfo
->
ru¬ög_å™ß˘i⁄
 = 
NULL
;

5019 
	`li°_dñ_öô
(&
å™s
->
li°
);

5021 
	`båfs_put_å™ß˘i⁄
(
å™s
);

5022 
	`åa˚_båfs_å™ß˘i⁄_commô
(
fs_öfo
);

5024 
	`ASSERT
(!
found
);

5025 
	}
}

5027 
__cﬁd
 
	$˛o£_˘ªe
(
båfs_fs_öfo
 *
fs_öfo
)

5029 
ªt
;

5031 
	`£t_bô
(
BTRFS_FS_CLOSING_START
, &
fs_öfo
->
Êags
);

5042 
	`båfs_wake_unföished_dr›
(
fs_öfo
);

5053 
	`ˇn˚l_w‹k_sync
(&
fs_öfo
->
ª˛aim_bgs_w‹k
);

5060 
	`kthªad_∑rk
(
fs_öfo
->
˛ó√r_kthªad
);

5063 
	`båfs_qgroup_waô_f‹_com∂ëi⁄
(
fs_öfo
, 
Ál£
);

5066 
	`down
(&
fs_öfo
->
uuid_åì_ªsˇn_£m
);

5068 
	`up
(&
fs_öfo
->
uuid_åì_ªsˇn_£m
);

5071 
	`båfs_∑u£_bÆ™˚
(
fs_öfo
);

5073 
	`båfs_dev_ª∂a˚_su•íd_f‹_unmou¡
(
fs_öfo
);

5075 
	`båfs_s¸ub_ˇn˚l
(
fs_öfo
);

5078 
	`waô_evít
(
fs_öfo
->
å™ß˘i⁄_waô
,

5079 (
	`©omic_ªad
(&
fs_öfo
->
de‰ag_ru¬ög
) == 0));

5082 
	`båfs_˛ónup_de‰ag_öodes
(
fs_öfo
);

5104 
	`båfs_Êush_w‹kqueue
(
fs_öfo
->
ídio_wrôe_w‹kîs
);

5106 
	`båfs_Êush_w‹kqueue
(
fs_öfo
->
ídio_‰ì•a˚_w‹kî
);

5107 
	`båfs_run_dñayed_ùuts
(
fs_öfo
);

5109 
	`ˇn˚l_w‹k_sync
(&
fs_öfo
->
async_ª˛aim_w‹k
);

5110 
	`ˇn˚l_w‹k_sync
(&
fs_öfo
->
async_d©a_ª˛aim_w‹k
);

5111 
	`ˇn˚l_w‹k_sync
(&
fs_öfo
->
¥ìm±_ª˛aim_w‹k
);

5114 
	`båfs_disˇrd_˛ónup
(
fs_öfo
);

5116 i‡(!
	`sb_rd⁄ly
(
fs_öfo
->
sb
)) {

5121 
	`båfs_dñëe_unu£d_bgs
(
fs_öfo
);

5134 
	`båfs_Êush_w‹kqueue
(
fs_öfo
->
dñayed_w‹kîs
);

5136 
ªt
 = 
	`båfs_commô_su≥r
(
fs_öfo
);

5137 i‡(
ªt
)

5138 
	`båfs_îr
(
fs_öfo
, "commô su≥∏ªà%d", 
ªt
);

5141 i‡(
	`BTRFS_FS_ERROR
(
fs_öfo
))

5142 
	`båfs_îr‹_commô_su≥r
(
fs_öfo
);

5144 
	`kthªad_°›
(
fs_öfo
->
å™ß˘i⁄_kthªad
);

5145 
	`kthªad_°›
(
fs_öfo
->
˛ó√r_kthªad
);

5147 
	`ASSERT
(
	`li°_em±y
(&
fs_öfo
->
dñayed_ùuts
));

5148 
	`£t_bô
(
BTRFS_FS_CLOSING_DONE
, &
fs_öfo
->
Êags
);

5150 i‡(
	`båfs_check_quŸa_Àak
(
fs_öfo
)) {

5151 
	`WARN_ON
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
));

5152 
	`båfs_îr
(
fs_öfo
, "qgroupÑeserved spaceÜeaked");

5155 
	`båfs_‰ì_qgroup_c⁄fig
(
fs_öfo
);

5156 
	`ASSERT
(
	`li°_em±y
(&
fs_öfo
->
dñÆloc_roŸs
));

5158 i‡(
	`≥r˝u_cou¡î_sum
(&
fs_öfo
->
dñÆloc_byãs
)) {

5159 
	`båfs_öfo
(
fs_öfo
, "at unmount delalloc count %lld",

5160 
	`≥r˝u_cou¡î_sum
(&
fs_öfo
->
dñÆloc_byãs
));

5163 i‡(
	`≥r˝u_cou¡î_sum
(&
fs_öfo
->
‹dîed_byãs
))

5164 
	`båfs_öfo
(
fs_öfo
, "at unmount dio bytes count %lld",

5165 
	`≥r˝u_cou¡î_sum
(&
fs_öfo
->
‹dîed_byãs
));

5167 
	`båfs_sysfs_ªmove_mou¡ed
(
fs_öfo
);

5168 
	`båfs_sysfs_ªmove_fsid
(
fs_öfo
->
fs_devi˚s
);

5170 
	`båfs_put_block_group_ˇche
(
fs_öfo
);

5176 
	`övÆid©e_öode_∑ges2
(
fs_öfo
->
båì_öode
->
i_m≠pög
);

5177 
	`båfs_°›_Æl_w‹kîs
(
fs_öfo
);

5180 
	`w¨n_about_uncommôãd_å™s
(
fs_öfo
);

5182 
	`˛ór_bô
(
BTRFS_FS_OPEN
, &
fs_öfo
->
Êags
);

5183 
	`‰ì_roŸ_poöãrs
(
fs_öfo
, 
åue
);

5184 
	`båfs_‰ì_fs_roŸs
(
fs_öfo
);

5193 
	`båfs_‰ì_block_groups
(
fs_öfo
);

5195 
	`ùut
(
fs_öfo
->
båì_öode
);

5197 #ifde‡
CONFIG_BTRFS_FS_CHECK_INTEGRITY


5198 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
CHECK_INTEGRITY
))

5199 
	`båfsic_unmou¡
(
fs_öfo
->
fs_devi˚s
);

5202 
	`båfs_m≠pög_åì_‰ì
(&
fs_öfo
->
m≠pög_åì
);

5203 
	`båfs_˛o£_devi˚s
(
fs_öfo
->
fs_devi˚s
);

5204 
	}
}

5206 
	$båfs_m¨k_buf„r_dúty
(
båfs_å™s_h™dÀ
 *
å™s
,

5207 
exã¡_buf„r
 *
buf
)

5209 
båfs_fs_öfo
 *
fs_öfo
 = 
buf
->fs_info;

5210 
u64
 
å™sid
 = 
	`båfs_hódî_gíî©i⁄
(
buf
);

5212 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


5218 i‡(
	`u∆ikñy
(
	`ã°_bô
(
EXTENT_BUFFER_UNMAPPED
, &
buf
->
bÊags
)))

5222 
	`ASSERT
(
å™s
->
å™sid
 =
fs_öfo
->
gíî©i⁄
);

5223 
	`båfs_as£π_åì_wrôe_locked
(
buf
);

5224 i‡(
å™sid
 !
fs_öfo
->
gíî©i⁄
) {

5225 
	`WARN
(1, 
KERN_CRIT
 "btrfsÅransid mismatch buffer %llu, found %lluÑunning %llu\n",

5226 
buf
->
°¨t
, 
å™sid
, 
fs_öfo
->
gíî©i⁄
);

5227 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, -
EUCLEAN
);

5229 
	`£t_exã¡_buf„r_dúty
(
buf
);

5230 #ifde‡
CONFIG_BTRFS_FS_CHECK_INTEGRITY


5235 i‡(
	`båfs_hódî_Àvñ
(
buf
Ë=0 && 
	`båfs_check_Àaf
(buf)) {

5236 
	`båfs_¥öt_Àaf
(
buf
);

5237 
	`ASSERT
(0);

5240 
	}
}

5242 
	$__båfs_båì_bÆ™˚_dúty
(
båfs_fs_öfo
 *
fs_öfo
,

5243 
Êush_dñayed
)

5249 
ªt
;

5251 i‡(
cuºít
->
Êags
 & 
PF_MEMALLOC
)

5254 i‡(
Êush_dñayed
)

5255 
	`båfs_bÆ™˚_dñayed_ôems
(
fs_öfo
);

5257 
ªt
 = 
	`__≥r˝u_cou¡î_com∑ª
(&
fs_öfo
->
dúty_mëad©a_byãs
,

5258 
BTRFS_DIRTY_METADATA_THRESH
,

5259 
fs_öfo
->
dúty_mëad©a_b©ch
);

5260 i‡(
ªt
 > 0) {

5261 
	`bÆ™˚_dúty_∑ges_øãlimôed
(
fs_öfo
->
båì_öode
->
i_m≠pög
);

5263 
	}
}

5265 
	$båfs_båì_bÆ™˚_dúty
(
båfs_fs_öfo
 *
fs_öfo
)

5267 
	`__båfs_båì_bÆ™˚_dúty
(
fs_öfo
, 1);

5268 
	}
}

5270 
	$båfs_båì_bÆ™˚_dúty_nodñay
(
båfs_fs_öfo
 *
fs_öfo
)

5272 
	`__båfs_båì_bÆ™˚_dúty
(
fs_öfo
, 0);

5273 
	}
}

5275 
	$båfs_îr‹_commô_su≥r
(
båfs_fs_öfo
 *
fs_öfo
)

5278 
	`båfs_˛ónup_å™ß˘i⁄
(
fs_öfo
);

5280 
	`muãx_lock
(&
fs_öfo
->
˛ó√r_muãx
);

5281 
	`båfs_run_dñayed_ùuts
(
fs_öfo
);

5282 
	`muãx_u∆ock
(&
fs_öfo
->
˛ó√r_muãx
);

5284 
	`down_wrôe
(&
fs_öfo
->
˛ónup_w‹k_£m
);

5285 
	`up_wrôe
(&
fs_öfo
->
˛ónup_w‹k_£m
);

5286 
	}
}

5288 
	$båfs_dr›_Æl_logs
(
båfs_fs_öfo
 *
fs_öfo
)

5290 
båfs_roŸ
 *
g™g
[8];

5291 
u64
 
roŸ_obje˘id
 = 0;

5292 
ªt
;

5294 
	`•ö_lock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

5295 (
ªt
 = 
	`ødix_åì_g™g_lookup
(&
fs_öfo
->
fs_roŸs_ødix
,

5296 (**)
g™g
, 
roŸ_obje˘id
,

5297 
	`ARRAY_SIZE
(
g™g
))) != 0) {

5298 
i
;

5300 
i
 = 0; i < 
ªt
; i++)

5301 
g™g
[
i
] = 
	`båfs_gøb_roŸ
(gang[i]);

5302 
	`•ö_u∆ock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

5304 
i
 = 0; i < 
ªt
; i++) {

5305 i‡(!
g™g
[
i
])

5307 
roŸ_obje˘id
 = 
g™g
[
i
]->
roŸ_key
.
obje˘id
;

5308 
	`båfs_‰ì_log
(
NULL
, 
g™g
[
i
]);

5309 
	`båfs_put_roŸ
(
g™g
[
i
]);

5311 
roŸ_obje˘id
++;

5312 
	`•ö_lock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

5314 
	`•ö_u∆ock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

5315 
	`båfs_‰ì_log_roŸ_åì
(
NULL
, 
fs_öfo
);

5316 
	}
}

5318 
	$båfs_de°roy_‹dîed_exã¡s
(
båfs_roŸ
 *
roŸ
)

5320 
båfs_‹dîed_exã¡
 *
‹dîed
;

5322 
	`•ö_lock
(&
roŸ
->
‹dîed_exã¡_lock
);

5327 
	`li°_f‹_óch_íåy
(
‹dîed
, &
roŸ
->
‹dîed_exã¡s
,

5328 
roŸ_exã¡_li°
)

5329 
	`£t_bô
(
BTRFS_ORDERED_IOERR
, &
‹dîed
->
Êags
);

5330 
	`•ö_u∆ock
(&
roŸ
->
‹dîed_exã¡_lock
);

5331 
	}
}

5333 
	$båfs_de°roy_Æl_‹dîed_exã¡s
(
båfs_fs_öfo
 *
fs_öfo
)

5335 
båfs_roŸ
 *
roŸ
;

5336 
	`LIST_HEAD
(
•li˚
);

5338 
	`•ö_lock
(&
fs_öfo
->
‹dîed_roŸ_lock
);

5339 
	`li°_•li˚_öô
(&
fs_öfo
->
‹dîed_roŸs
, &
•li˚
);

5340 !
	`li°_em±y
(&
•li˚
)) {

5341 
roŸ
 = 
	`li°_fú°_íåy
(&
•li˚
, 
båfs_roŸ
,

5342 
‹dîed_roŸ
);

5343 
	`li°_move_èû
(&
roŸ
->
‹dîed_roŸ
,

5344 &
fs_öfo
->
‹dîed_roŸs
);

5346 
	`•ö_u∆ock
(&
fs_öfo
->
‹dîed_roŸ_lock
);

5347 
	`båfs_de°roy_‹dîed_exã¡s
(
roŸ
);

5349 
	`c⁄d_ªsched
();

5350 
	`•ö_lock
(&
fs_öfo
->
‹dîed_roŸ_lock
);

5352 
	`•ö_u∆ock
(&
fs_öfo
->
‹dîed_roŸ_lock
);

5360 
	`båfs_waô_‹dîed_roŸs
(
fs_öfo
, 
U64_MAX
, 0, (
u64
)-1);

5361 
	}
}

5363 
	$båfs_de°roy_dñayed_ªfs
(
båfs_å™ß˘i⁄
 *
å™s
,

5364 
båfs_fs_öfo
 *
fs_öfo
)

5366 
rb_node
 *
node
;

5367 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
;

5368 
båfs_dñayed_ªf_node
 *
ªf
;

5370 
dñayed_ªfs
 = &
å™s
->delayed_refs;

5372 
	`•ö_lock
(&
dñayed_ªfs
->
lock
);

5373 i‡(
	`©omic_ªad
(&
dñayed_ªfs
->
num_íåõs
) == 0) {

5374 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

5375 
	`båfs_debug
(
fs_öfo
, "delayed_refs has NOÉntry");

5379 (
node
 = 
	`rb_fú°_ˇched
(&
dñayed_ªfs
->
hªf_roŸ
)Ë!
NULL
) {

5380 
båfs_dñayed_ªf_hód
 *
hód
;

5381 
rb_node
 *
n
;

5382 
boﬁ
 
pö_byãs
 = 
Ál£
;

5384 
hód
 = 
	`rb_íåy
(
node
, 
båfs_dñayed_ªf_hód
,

5385 
hªf_node
);

5386 i‡(
	`båfs_dñayed_ªf_lock
(
dñayed_ªfs
, 
hód
))

5389 
	`•ö_lock
(&
hód
->
lock
);

5390 (
n
 = 
	`rb_fú°_ˇched
(&
hód
->
ªf_åì
)Ë!
NULL
) {

5391 
ªf
 = 
	`rb_íåy
(
n
, 
båfs_dñayed_ªf_node
,

5392 
ªf_node
);

5393 
	`rb_îa£_ˇched
(&
ªf
->
ªf_node
, &
hód
->
ªf_åì
);

5394 
	`RB_CLEAR_NODE
(&
ªf
->
ªf_node
);

5395 i‡(!
	`li°_em±y
(&
ªf
->
add_li°
))

5396 
	`li°_dñ
(&
ªf
->
add_li°
);

5397 
	`©omic_dec
(&
dñayed_ªfs
->
num_íåõs
);

5398 
	`båfs_put_dñayed_ªf
(
ªf
);

5400 i‡(
hód
->
mu°_ö£π_ª£rved
)

5401 
pö_byãs
 = 
åue
;

5402 
	`båfs_‰ì_dñayed_exã¡_›
(
hód
->
exã¡_›
);

5403 
	`båfs_dñëe_ªf_hód
(
dñayed_ªfs
, 
hód
);

5404 
	`•ö_u∆ock
(&
hód
->
lock
);

5405 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

5406 
	`muãx_u∆ock
(&
hód
->
muãx
);

5408 i‡(
pö_byãs
) {

5409 
båfs_block_group
 *
ˇche
;

5411 
ˇche
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
hód
->
byãƒ
);

5412 
	`BUG_ON
(!
ˇche
);

5414 
	`•ö_lock
(&
ˇche
->
•a˚_öfo
->
lock
);

5415 
	`•ö_lock
(&
ˇche
->
lock
);

5416 
ˇche
->
pö√d
 +
hód
->
num_byãs
;

5417 
	`båfs_•a˚_öfo_upd©e_byãs_pö√d
(
fs_öfo
,

5418 
ˇche
->
•a˚_öfo
, 
hód
->
num_byãs
);

5419 
ˇche
->
ª£rved
 -
hód
->
num_byãs
;

5420 
ˇche
->
•a˚_öfo
->
byãs_ª£rved
 -
hód
->
num_byãs
;

5421 
	`•ö_u∆ock
(&
ˇche
->
lock
);

5422 
	`•ö_u∆ock
(&
ˇche
->
•a˚_öfo
->
lock
);

5424 
	`båfs_put_block_group
(
ˇche
);

5426 
	`båfs_îr‹_u≈ö_exã¡_ønge
(
fs_öfo
, 
hód
->
byãƒ
,

5427 
hód
->
byãƒ
 + hód->
num_byãs
 - 1);

5429 
	`båfs_˛ónup_ªf_hód_accou¡ög
(
fs_öfo
, 
dñayed_ªfs
, 
hód
);

5430 
	`båfs_put_dñayed_ªf_hód
(
hód
);

5431 
	`c⁄d_ªsched
();

5432 
	`•ö_lock
(&
dñayed_ªfs
->
lock
);

5434 
	`båfs_qgroup_de°roy_exã¡_ªc‹ds
(
å™s
);

5436 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

5437 
	}
}

5439 
	$båfs_de°roy_dñÆloc_öodes
(
båfs_roŸ
 *
roŸ
)

5441 
båfs_öode
 *btrfs_inode;

5442 
	`LIST_HEAD
(
•li˚
);

5444 
	`•ö_lock
(&
roŸ
->
dñÆloc_lock
);

5445 
	`li°_•li˚_öô
(&
roŸ
->
dñÆloc_öodes
, &
•li˚
);

5447 !
	`li°_em±y
(&
•li˚
)) {

5448 
öode
 *öodê
NULL
;

5449 
båfs_öode
 = 
	`li°_fú°_íåy
(&
•li˚
, btrfs_inode,

5450 
dñÆloc_öodes
);

5451 
	`__båfs_dñ_dñÆloc_öode
(
roŸ
, 
båfs_öode
);

5452 
	`•ö_u∆ock
(&
roŸ
->
dñÆloc_lock
);

5458 
öode
 = 
	`igøb
(&
båfs_öode
->
vfs_öode
);

5459 i‡(
öode
) {

5460 
nofs_Êag
;

5462 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

5463 
	`övÆid©e_öode_∑ges2
(
öode
->
i_m≠pög
);

5464 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

5465 
	`ùut
(
öode
);

5467 
	`•ö_lock
(&
roŸ
->
dñÆloc_lock
);

5469 
	`•ö_u∆ock
(&
roŸ
->
dñÆloc_lock
);

5470 
	}
}

5472 
	$båfs_de°roy_Æl_dñÆloc_öodes
(
båfs_fs_öfo
 *
fs_öfo
)

5474 
båfs_roŸ
 *
roŸ
;

5475 
	`LIST_HEAD
(
•li˚
);

5477 
	`•ö_lock
(&
fs_öfo
->
dñÆloc_roŸ_lock
);

5478 
	`li°_•li˚_öô
(&
fs_öfo
->
dñÆloc_roŸs
, &
•li˚
);

5479 !
	`li°_em±y
(&
•li˚
)) {

5480 
roŸ
 = 
	`li°_fú°_íåy
(&
•li˚
, 
båfs_roŸ
,

5481 
dñÆloc_roŸ
);

5482 
roŸ
 = 
	`båfs_gøb_roŸ
(root);

5483 
	`BUG_ON
(!
roŸ
);

5484 
	`•ö_u∆ock
(&
fs_öfo
->
dñÆloc_roŸ_lock
);

5486 
	`båfs_de°roy_dñÆloc_öodes
(
roŸ
);

5487 
	`båfs_put_roŸ
(
roŸ
);

5489 
	`•ö_lock
(&
fs_öfo
->
dñÆloc_roŸ_lock
);

5491 
	`•ö_u∆ock
(&
fs_öfo
->
dñÆloc_roŸ_lock
);

5492 
	}
}

5494 
	$båfs_de°roy_m¨ked_exã¡s
(
båfs_fs_öfo
 *
fs_öfo
,

5495 
exã¡_io_åì
 *
dúty_∑ges
,

5496 
m¨k
)

5498 
exã¡_buf„r
 *
eb
;

5499 
u64
 
°¨t
 = 0;

5500 
u64
 
íd
;

5502 
	`föd_fú°_exã¡_bô
(
dúty_∑ges
, 
°¨t
, &°¨t, &
íd
,

5503 
m¨k
, 
NULL
)) {

5504 
	`˛ór_exã¡_bôs
(
dúty_∑ges
, 
°¨t
, 
íd
, 
m¨k
);

5505 
°¨t
 <
íd
) {

5506 
eb
 = 
	`föd_exã¡_buf„r
(
fs_öfo
, 
°¨t
);

5507 
°¨t
 +
fs_öfo
->
nodesize
;

5508 i‡(!
eb
)

5511 
	`båfs_åì_lock
(
eb
);

5512 
	`waô_⁄_exã¡_buf„r_wrôeback
(
eb
);

5513 
	`båfs_˛ór_buf„r_dúty
(
NULL
, 
eb
);

5514 
	`båfs_åì_u∆ock
(
eb
);

5516 
	`‰ì_exã¡_buf„r_°Æe
(
eb
);

5519 
	}
}

5521 
	$båfs_de°roy_pö√d_exã¡
(
båfs_fs_öfo
 *
fs_öfo
,

5522 
exã¡_io_åì
 *
u≈ö
)

5524 
u64
 
°¨t
;

5525 
u64
 
íd
;

5528 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

5536 
	`muãx_lock
(&
fs_öfo
->
unu£d_bg_u≈ö_muãx
);

5537 i‡(!
	`föd_fú°_exã¡_bô
(
u≈ö
, 0, &
°¨t
, &
íd
,

5538 
EXTENT_DIRTY
, &
ˇched_°©e
)) {

5539 
	`muãx_u∆ock
(&
fs_öfo
->
unu£d_bg_u≈ö_muãx
);

5543 
	`˛ór_exã¡_dúty
(
u≈ö
, 
°¨t
, 
íd
, &
ˇched_°©e
);

5544 
	`‰ì_exã¡_°©e
(
ˇched_°©e
);

5545 
	`båfs_îr‹_u≈ö_exã¡_ønge
(
fs_öfo
, 
°¨t
, 
íd
);

5546 
	`muãx_u∆ock
(&
fs_öfo
->
unu£d_bg_u≈ö_muãx
);

5547 
	`c⁄d_ªsched
();

5549 
	}
}

5551 
	$båfs_˛ónup_bg_io
(
båfs_block_group
 *
ˇche
)

5553 
öode
 *inode;

5555 
öode
 = 
ˇche
->
io_˘l
.inode;

5556 i‡(
öode
) {

5557 
nofs_Êag
;

5559 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

5560 
	`övÆid©e_öode_∑ges2
(
öode
->
i_m≠pög
);

5561 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

5563 
	`BTRFS_I
(
öode
)->
gíî©i⁄
 = 0;

5564 
ˇche
->
io_˘l
.
öode
 = 
NULL
;

5565 
	`ùut
(
öode
);

5567 
	`ASSERT
(
ˇche
->
io_˘l
.
∑ges
 =
NULL
);

5568 
	`båfs_put_block_group
(
ˇche
);

5569 
	}
}

5571 
	$båfs_˛ónup_dúty_bgs
(
båfs_å™ß˘i⁄
 *
cur_å™s
,

5572 
båfs_fs_öfo
 *
fs_öfo
)

5574 
båfs_block_group
 *
ˇche
;

5576 
	`•ö_lock
(&
cur_å™s
->
dúty_bgs_lock
);

5577 !
	`li°_em±y
(&
cur_å™s
->
dúty_bgs
)) {

5578 
ˇche
 = 
	`li°_fú°_íåy
(&
cur_å™s
->
dúty_bgs
,

5579 
båfs_block_group
,

5580 
dúty_li°
);

5582 i‡(!
	`li°_em±y
(&
ˇche
->
io_li°
)) {

5583 
	`•ö_u∆ock
(&
cur_å™s
->
dúty_bgs_lock
);

5584 
	`li°_dñ_öô
(&
ˇche
->
io_li°
);

5585 
	`båfs_˛ónup_bg_io
(
ˇche
);

5586 
	`•ö_lock
(&
cur_å™s
->
dúty_bgs_lock
);

5589 
	`li°_dñ_öô
(&
ˇche
->
dúty_li°
);

5590 
	`•ö_lock
(&
ˇche
->
lock
);

5591 
ˇche
->
disk_ˇche_°©e
 = 
BTRFS_DC_ERROR
;

5592 
	`•ö_u∆ock
(&
ˇche
->
lock
);

5594 
	`•ö_u∆ock
(&
cur_å™s
->
dúty_bgs_lock
);

5595 
	`båfs_put_block_group
(
ˇche
);

5596 
	`båfs_dñayed_ªfs_rsv_ªÀa£
(
fs_öfo
, 1);

5597 
	`•ö_lock
(&
cur_å™s
->
dúty_bgs_lock
);

5599 
	`•ö_u∆ock
(&
cur_å™s
->
dúty_bgs_lock
);

5605 !
	`li°_em±y
(&
cur_å™s
->
io_bgs
)) {

5606 
ˇche
 = 
	`li°_fú°_íåy
(&
cur_å™s
->
io_bgs
,

5607 
båfs_block_group
,

5608 
io_li°
);

5610 
	`li°_dñ_öô
(&
ˇche
->
io_li°
);

5611 
	`•ö_lock
(&
ˇche
->
lock
);

5612 
ˇche
->
disk_ˇche_°©e
 = 
BTRFS_DC_ERROR
;

5613 
	`•ö_u∆ock
(&
ˇche
->
lock
);

5614 
	`båfs_˛ónup_bg_io
(
ˇche
);

5616 
	}
}

5618 
	$båfs_˛ónup_⁄e_å™ß˘i⁄
(
båfs_å™ß˘i⁄
 *
cur_å™s
,

5619 
båfs_fs_öfo
 *
fs_öfo
)

5621 
båfs_devi˚
 *
dev
, *
tmp
;

5623 
	`båfs_˛ónup_dúty_bgs
(
cur_å™s
, 
fs_öfo
);

5624 
	`ASSERT
(
	`li°_em±y
(&
cur_å™s
->
dúty_bgs
));

5625 
	`ASSERT
(
	`li°_em±y
(&
cur_å™s
->
io_bgs
));

5627 
	`li°_f‹_óch_íåy_ß„
(
dev
, 
tmp
, &
cur_å™s
->
dev_upd©e_li°
,

5628 
po°_commô_li°
) {

5629 
	`li°_dñ_öô
(&
dev
->
po°_commô_li°
);

5632 
	`båfs_de°roy_dñayed_ªfs
(
cur_å™s
, 
fs_öfo
);

5634 
cur_å™s
->
°©e
 = 
TRANS_STATE_COMMIT_START
;

5635 
	`wake_up
(&
fs_öfo
->
å™ß˘i⁄_blocked_waô
);

5637 
cur_å™s
->
°©e
 = 
TRANS_STATE_UNBLOCKED
;

5638 
	`wake_up
(&
fs_öfo
->
å™ß˘i⁄_waô
);

5640 
	`båfs_de°roy_dñayed_öodes
(
fs_öfo
);

5642 
	`båfs_de°roy_m¨ked_exã¡s
(
fs_öfo
, &
cur_å™s
->
dúty_∑ges
,

5643 
EXTENT_DIRTY
);

5644 
	`båfs_de°roy_pö√d_exã¡
(
fs_öfo
, &
cur_å™s
->
pö√d_exã¡s
);

5646 
cur_å™s
->
°©e
 =
TRANS_STATE_COMPLETED
;

5647 
	`wake_up
(&
cur_å™s
->
commô_waô
);

5648 
	}
}

5650 
	$båfs_˛ónup_å™ß˘i⁄
(
båfs_fs_öfo
 *
fs_öfo
)

5652 
båfs_å™ß˘i⁄
 *
t
;

5654 
	`muãx_lock
(&
fs_öfo
->
å™ß˘i⁄_kthªad_muãx
);

5656 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

5657 !
	`li°_em±y
(&
fs_öfo
->
å™s_li°
)) {

5658 
t
 = 
	`li°_fú°_íåy
(&
fs_öfo
->
å™s_li°
,

5659 
båfs_å™ß˘i⁄
, 
li°
);

5660 i‡(
t
->
°©e
 >
TRANS_STATE_COMMIT_PREP
) {

5661 
	`ªfcou¡_öc
(&
t
->
u£_cou¡
);

5662 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

5663 
	`båfs_waô_f‹_commô
(
fs_öfo
, 
t
->
å™sid
);

5664 
	`båfs_put_å™ß˘i⁄
(
t
);

5665 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

5668 i‡(
t
 =
fs_öfo
->
ru¬ög_å™ß˘i⁄
) {

5669 
t
->
°©e
 = 
TRANS_STATE_COMMIT_DOING
;

5670 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

5675 
	`waô_evít
(
t
->
wrôî_waô
,

5676 
	`©omic_ªad
(&
t
->
num_wrôîs
) == 0);

5678 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

5680 
	`båfs_˛ónup_⁄e_å™ß˘i⁄
(
t
, 
fs_öfo
);

5682 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

5683 i‡(
t
 =
fs_öfo
->
ru¬ög_å™ß˘i⁄
)

5684 
fs_öfo
->
ru¬ög_å™ß˘i⁄
 = 
NULL
;

5685 
	`li°_dñ_öô
(&
t
->
li°
);

5686 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

5688 
	`båfs_put_å™ß˘i⁄
(
t
);

5689 
	`åa˚_båfs_å™ß˘i⁄_commô
(
fs_öfo
);

5690 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

5692 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

5693 
	`båfs_de°roy_Æl_‹dîed_exã¡s
(
fs_öfo
);

5694 
	`båfs_de°roy_dñayed_öodes
(
fs_öfo
);

5695 
	`båfs_as£π_dñayed_roŸ_em±y
(
fs_öfo
);

5696 
	`båfs_de°roy_Æl_dñÆloc_öodes
(
fs_öfo
);

5697 
	`båfs_dr›_Æl_logs
(
fs_öfo
);

5698 
	`muãx_u∆ock
(&
fs_öfo
->
å™ß˘i⁄_kthªad_muãx
);

5701 
	}
}

5703 
	$båfs_öô_roŸ_‰ì_obje˘id
(
båfs_roŸ
 *
roŸ
)

5705 
båfs_∑th
 *
∑th
;

5706 
ªt
;

5707 
exã¡_buf„r
 *
l
;

5708 
båfs_key
 
£¨ch_key
;

5709 
båfs_key
 
found_key
;

5710 
¶Ÿ
;

5712 
∑th
 = 
	`båfs_Æloc_∑th
();

5713 i‡(!
∑th
)

5714  -
ENOMEM
;

5716 
£¨ch_key
.
obje˘id
 = 
BTRFS_LAST_FREE_OBJECTID
;

5717 
£¨ch_key
.
ty≥
 = -1;

5718 
£¨ch_key
.
off£t
 = (
u64
)-1;

5719 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
£¨ch_key
, 
∑th
, 0, 0);

5720 i‡(
ªt
 < 0)

5721 
îr‹
;

5722 
	`BUG_ON
(
ªt
 == 0);

5723 i‡(
∑th
->
¶Ÿs
[0] > 0) {

5724 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0] - 1;

5725 
l
 = 
∑th
->
nodes
[0];

5726 
	`båfs_ôem_key_to_˝u
(
l
, &
found_key
, 
¶Ÿ
);

5727 
roŸ
->
‰ì_obje˘id
 = 
	`max_t
(
u64
, 
found_key
.
obje˘id
 + 1,

5728 
BTRFS_FIRST_FREE_OBJECTID
);

5730 
roŸ
->
‰ì_obje˘id
 = 
BTRFS_FIRST_FREE_OBJECTID
;

5732 
ªt
 = 0;

5733 
îr‹
:

5734 
	`båfs_‰ì_∑th
(
∑th
);

5735  
ªt
;

5736 
	}
}

5738 
	$båfs_gë_‰ì_obje˘id
(
båfs_roŸ
 *
roŸ
, 
u64
 *
obje˘id
)

5740 
ªt
;

5741 
	`muãx_lock
(&
roŸ
->
obje˘id_muãx
);

5743 i‡(
	`u∆ikñy
(
roŸ
->
‰ì_obje˘id
 >
BTRFS_LAST_FREE_OBJECTID
)) {

5744 
	`båfs_w¨n
(
roŸ
->
fs_öfo
,

5746 
roŸ
->
roŸ_key
.
obje˘id
);

5747 
ªt
 = -
ENOSPC
;

5748 
out
;

5751 *
obje˘id
 = 
roŸ
->
‰ì_obje˘id
++;

5752 
ªt
 = 0;

5753 
out
:

5754 
	`muãx_u∆ock
(&
roŸ
->
obje˘id_muãx
);

5755  
ªt
;

5756 
	}
}

	@disk-io.h

6 #i‚de‡
BTRFS_DISK_IO_H


7 
	#BTRFS_DISK_IO_H


	)

9 
	#BTRFS_SUPER_MIRROR_MAX
 3

	)

10 
	#BTRFS_SUPER_MIRROR_SHIFT
 12

	)

18 
	#BTRFS_BDEV_BLOCKSIZE
 (4096)

	)

20 
ölöe
 
u64
 
	$båfs_sb_off£t
(
múr‹
)

22 
u64
 
°¨t
 = 
SZ_16K
;

23 i‡(
múr‹
)

24  
°¨t
 << (
BTRFS_SUPER_MIRROR_SHIFT
 * 
múr‹
);

25  
BTRFS_SUPER_INFO_OFFSET
;

26 
	}
}

29 
ölöe
 
u64
 
	$båfs_sb_off£t_∑πôi⁄
(
múr‹
, 
u64
 
sb_off£t
)

31 i‡–
múr‹
 == 1 )

32  
BTRFS_SUPER_INFO_OFFSET_1
 + 
sb_off£t
;

33 i‡–
múr‹
 == 2 )

34  
BTRFS_SUPER_INFO_OFFSET_2
 + 
sb_off£t
;

35  
BTRFS_SUPER_INFO_OFFSET
 + 
sb_off£t
;

36 
	}
}

38 
	gbåfs_devi˚
;

39 
	gbåfs_fs_devi˚s
;

40 
	gbåfs_åì_∑ª¡_check
;

42 
båfs_check_Àaked_roŸs
(
båfs_fs_öfo
 *
fs_öfo
);

43 
båfs_öô_fs_öfo
(
båfs_fs_öfo
 *
fs_öfo
);

44 
exã¡_buf„r
 *
ªad_åì_block
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
byãƒ
,

45 
båfs_åì_∑ª¡_check
 *
check
);

46 
exã¡_buf„r
 *
båfs_föd_¸óã_åì_block
(

47 
båfs_fs_öfo
 *
fs_öfo
,

48 
u64
 
byãƒ
, u64 
ow√r_roŸ
,

49 
Àvñ
);

50 
båfs_˛ór_buf„r_dúty
(
båfs_å™s_h™dÀ
 *
å™s
,

51 
exã¡_buf„r
 *
buf
);

52 
båfs_˛ór_⁄eshŸ_›ti⁄s
(
båfs_fs_öfo
 *
fs_öfo
);

53 
båfs_°¨t_¥e_rw_mou¡
(
båfs_fs_öfo
 *
fs_öfo
);

54 
båfs_check_su≥r_csum
(
båfs_fs_öfo
 *
fs_öfo
,

55 c⁄° 
båfs_su≥r_block
 *
disk_sb
);

56 
__cﬁd
 
›í_˘ªe
(
su≥r_block
 *
sb
,

57 
båfs_fs_devi˚s
 *
fs_devi˚s
,

58 *
›ti⁄s
);

59 
__cﬁd
 
›í_˘ªe_∑πôi⁄
(
su≥r_block
 *
sb
, 
båfs_fs_devi˚s
 *
fs_devi˚s
,

60 *
›ti⁄s
, 
∑πôi⁄_‹dî
);

61 
__cﬁd
 
˛o£_˘ªe
(
båfs_fs_öfo
 *
fs_öfo
);

62 
båfs_vÆid©e_su≥r
(
båfs_fs_öfo
 *
fs_öfo
,

63 
båfs_su≥r_block
 *
sb
, 
múr‹_num
);

64 
båfs_check_„©uªs
(
båfs_fs_öfo
 *
fs_öfo
, 
boﬁ
 
is_rw_mou¡
);

65 
wrôe_Æl_su≥rs
(
båfs_fs_öfo
 *
fs_öfo
, 
max_múr‹s
);

66 
båfs_su≥r_block
 *
båfs_ªad_dev_su≥r
(
block_devi˚
 *
bdev
);

67 
båfs_su≥r_block
 *
båfs_ªad_dev_su≥r_∑πôi⁄
(
block_devi˚
 *
bdev
, 
∑πôi⁄_‹dî
);

68 
båfs_su≥r_block
 *
båfs_ªad_dev_⁄e_su≥r
(
block_devi˚
 *
bdev
,

69 
c›y_num
, 
boﬁ
 
dr›_ˇche
);

70 
båfs_su≥r_block
 *
båfs_ªad_dev_⁄e_su≥r_∑πôi⁄
(
block_devi˚
 *
bdev
,

71 
c›y_num
, 
boﬁ
 
dr›_ˇche
, 
∑πôi⁄_‹dî
);

72 
båfs_commô_su≥r
(
båfs_fs_öfo
 *
fs_öfo
);

73 
båfs_roŸ
 *
båfs_ªad_åì_roŸ
(båfs_roŸ *
åì_roŸ
,

74 
båfs_key
 *
key
);

75 
båfs_ö£π_fs_roŸ
(
båfs_fs_öfo
 *
fs_öfo
,

76 
båfs_roŸ
 *
roŸ
);

77 
båfs_‰ì_fs_roŸs
(
båfs_fs_öfo
 *
fs_öfo
);

79 
båfs_roŸ
 *
båfs_gë_fs_roŸ
(
båfs_fs_öfo
 *
fs_öfo
,

80 
u64
 
obje˘id
, 
boﬁ
 
check_ªf
);

81 
båfs_roŸ
 *
båfs_gë_√w_fs_roŸ
(
båfs_fs_öfo
 *
fs_öfo
,

82 
u64
 
obje˘id
, 
dev_t
 
™⁄_dev
);

83 
båfs_roŸ
 *
båfs_gë_fs_roŸ_commô_roŸ
(
båfs_fs_öfo
 *
fs_öfo
,

84 
båfs_∑th
 *
∑th
,

85 
u64
 
obje˘id
);

86 
båfs_globÆ_roŸ_ö£π
(
båfs_roŸ
 *
roŸ
);

87 
båfs_globÆ_roŸ_dñëe
(
båfs_roŸ
 *
roŸ
);

88 
båfs_roŸ
 *
båfs_globÆ_roŸ
(
båfs_fs_öfo
 *
fs_öfo
,

89 
båfs_key
 *
key
);

90 
båfs_roŸ
 *
båfs_csum_roŸ
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
byãƒ
);

91 
båfs_roŸ
 *
båfs_exã¡_roŸ
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
byãƒ
);

92 
båfs_roŸ
 *
båfs_block_group_roŸ
(
båfs_fs_öfo
 *
fs_öfo
);

94 
båfs_‰ì_fs_öfo
(
båfs_fs_öfo
 *
fs_öfo
);

95 
båfs_båì_bÆ™˚_dúty
(
båfs_fs_öfo
 *
fs_öfo
);

96 
båfs_båì_bÆ™˚_dúty_nodñay
(
båfs_fs_öfo
 *
fs_öfo
);

97 
båfs_dr›_™d_‰ì_fs_roŸ
(
båfs_fs_öfo
 *
fs_öfo
,

98 
båfs_roŸ
 *
roŸ
);

99 
båfs_vÆid©e_exã¡_buf„r
(
exã¡_buf„r
 *
eb
,

100 
båfs_åì_∑ª¡_check
 *
check
);

101 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


102 
båfs_roŸ
 *
båfs_Æloc_dummy_roŸ
(
båfs_fs_öfo
 *
fs_öfo
);

112 
ölöe
 
båfs_roŸ
 *
	$båfs_gøb_roŸ
(
båfs_roŸ
 *
roŸ
)

114 i‡(!
roŸ
)

115  
NULL
;

116 i‡(
	`ªfcou¡_öc_nŸ_zîo
(&
roŸ
->
ªfs
))

117  
roŸ
;

118  
NULL
;

119 
	}
}

121 
båfs_put_roŸ
(
båfs_roŸ
 *
roŸ
);

122 
båfs_m¨k_buf„r_dúty
(
båfs_å™s_h™dÀ
 *
å™s
,

123 
exã¡_buf„r
 *
buf
);

124 
båfs_buf„r_u±od©e
(
exã¡_buf„r
 *
buf
, 
u64
 
∑ª¡_å™sid
,

125 
©omic
);

126 
båfs_ªad_exã¡_buf„r
(
exã¡_buf„r
 *
buf
,

127 
båfs_åì_∑ª¡_check
 *
check
);

129 
blk_°©us_t
 
båì_csum_⁄e_bio
(
båfs_bio
 *
bbio
);

130 
båfs_Æloc_log_åì_node
(
båfs_å™s_h™dÀ
 *
å™s
,

131 
båfs_roŸ
 *
roŸ
);

132 
båfs_öô_log_roŸ_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

133 
båfs_fs_öfo
 *
fs_öfo
);

134 
båfs_add_log_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

135 
båfs_roŸ
 *
roŸ
);

136 
båfs_˛ónup_dúty_bgs
(
båfs_å™ß˘i⁄
 *
å™s
,

137 
båfs_fs_öfo
 *
fs_öfo
);

138 
båfs_˛ónup_⁄e_å™ß˘i⁄
(
båfs_å™ß˘i⁄
 *
å™s
,

139 
båfs_fs_öfo
 *
fs_öfo
);

140 
båfs_roŸ
 *
båfs_¸óã_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

141 
u64
 
obje˘id
);

142 
båfs_gë_num_tﬁî©ed_disk_b¨rõr_Áûuªs
(
u64
 
Êags
);

143 
båfs_gë_‰ì_obje˘id
(
båfs_roŸ
 *
roŸ
, 
u64
 *
obje˘id
);

144 
båfs_öô_roŸ_‰ì_obje˘id
(
båfs_roŸ
 *
roŸ
);

	@export.c

3 
	~<löux/fs.h
>

4 
	~<löux/ty≥s.h
>

5 
	~"˘ªe.h
"

6 
	~"disk-io.h
"

7 
	~"båfs_öode.h
"

8 
	~"¥öt-åì.h
"

9 
	~"exp‹t.h
"

10 
	~"ac˚ss‹s.h
"

11 
	~"su≥r.h
"

13 
	#BTRFS_FID_SIZE_NON_CONNECTABLE
 (
	`off£tof
(
båfs_fid
, \

14 
∑ª¡_obje˘id
Ë/ 4)

	)

15 
	#BTRFS_FID_SIZE_CONNECTABLE
 (
	`off£tof
(
båfs_fid
, \

16 
∑ª¡_roŸ_obje˘id
Ë/ 4)

	)

17 
	#BTRFS_FID_SIZE_CONNECTABLE_ROOT
 ((
båfs_fid
Ë/ 4)

	)

19 
	$båfs_ícode_fh
(
öode
 *öode, 
u32
 *
fh
, *
max_Àn
,

20 
öode
 *
∑ª¡
)

22 
båfs_fid
 *
fid
 = (båfs_fid *)
fh
;

23 
Àn
 = *
max_Àn
;

24 
ty≥
;

26 i‡(
∑ª¡
 && (
Àn
 < 
BTRFS_FID_SIZE_CONNECTABLE
)) {

27 *
max_Àn
 = 
BTRFS_FID_SIZE_CONNECTABLE
;

28  
FILEID_INVALID
;

29 } i‡(
Àn
 < 
BTRFS_FID_SIZE_NON_CONNECTABLE
) {

30 *
max_Àn
 = 
BTRFS_FID_SIZE_NON_CONNECTABLE
;

31  
FILEID_INVALID
;

34 
Àn
 = 
BTRFS_FID_SIZE_NON_CONNECTABLE
;

35 
ty≥
 = 
FILEID_BTRFS_WITHOUT_PARENT
;

37 
fid
->
obje˘id
 = 
	`båfs_öo
(
	`BTRFS_I
(
öode
));

38 
fid
->
roŸ_obje˘id
 = 
	`BTRFS_I
(
öode
)->
roŸ
->
roŸ_key
.
obje˘id
;

39 
fid
->
gí
 = 
öode
->
i_gíî©i⁄
;

41 i‡(
∑ª¡
) {

42 
u64
 
∑ª¡_roŸ_id
;

44 
fid
->
∑ª¡_obje˘id
 = 
	`BTRFS_I
(
∑ª¡
)->
loˇti⁄
.
obje˘id
;

45 
fid
->
∑ª¡_gí
 = 
∑ª¡
->
i_gíî©i⁄
;

46 
∑ª¡_roŸ_id
 = 
	`BTRFS_I
(
∑ª¡
)->
roŸ
->
roŸ_key
.
obje˘id
;

48 i‡(
∑ª¡_roŸ_id
 !
fid
->
roŸ_obje˘id
) {

49 
fid
->
∑ª¡_roŸ_obje˘id
 = 
∑ª¡_roŸ_id
;

50 
Àn
 = 
BTRFS_FID_SIZE_CONNECTABLE_ROOT
;

51 
ty≥
 = 
FILEID_BTRFS_WITH_PARENT_ROOT
;

53 
Àn
 = 
BTRFS_FID_SIZE_CONNECTABLE
;

54 
ty≥
 = 
FILEID_BTRFS_WITH_PARENT
;

58 *
max_Àn
 = 
Àn
;

59  
ty≥
;

60 
	}
}

74 
díåy
 *
	$båfs_gë_díåy
(
su≥r_block
 *
sb
, 
u64
 
obje˘id
,

75 
u64
 
roŸ_obje˘id
, u64 
gíî©i⁄
)

77 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
sb
);

78 
båfs_roŸ
 *
roŸ
;

79 
öode
 *inode;

81 i‡(
obje˘id
 < 
BTRFS_FIRST_FREE_OBJECTID
)

82  
	`ERR_PTR
(-
ESTALE
);

84 
roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
roŸ_obje˘id
, 
åue
);

85 i‡(
	`IS_ERR
(
roŸ
))

86  
	`ERR_CAST
(
roŸ
);

88 
öode
 = 
	`båfs_igë
(
sb
, 
obje˘id
, 
roŸ
);

89 
	`båfs_put_roŸ
(
roŸ
);

90 i‡(
	`IS_ERR
(
öode
))

91  
	`ERR_CAST
(
öode
);

93 i‡(
gíî©i⁄
 !0 && gíî©i⁄ !
öode
->
i_gíî©i⁄
) {

94 
	`ùut
(
öode
);

95  
	`ERR_PTR
(-
ESTALE
);

98  
	`d_obèö_Æüs
(
öode
);

99 
	}
}

101 
díåy
 *
	$båfs_fh_to_∑ª¡
(
su≥r_block
 *
sb
, 
fid
 *
fh
,

102 
fh_Àn
, 
fh_ty≥
)

104 
båfs_fid
 *
fid
 = (båfs_fid *Ë
fh
;

105 
u64
 
obje˘id
, 
roŸ_obje˘id
;

106 
u32
 
gíî©i⁄
;

108 i‡(
fh_ty≥
 =
FILEID_BTRFS_WITH_PARENT
) {

109 i‡(
fh_Àn
 < 
BTRFS_FID_SIZE_CONNECTABLE
)

110  
NULL
;

111 
roŸ_obje˘id
 = 
fid
->root_objectid;

112 } i‡(
fh_ty≥
 =
FILEID_BTRFS_WITH_PARENT_ROOT
) {

113 i‡(
fh_Àn
 < 
BTRFS_FID_SIZE_CONNECTABLE_ROOT
)

114  
NULL
;

115 
roŸ_obje˘id
 = 
fid
->
∑ª¡_roŸ_obje˘id
;

117  
NULL
;

119 
obje˘id
 = 
fid
->
∑ª¡_obje˘id
;

120 
gíî©i⁄
 = 
fid
->
∑ª¡_gí
;

122  
	`båfs_gë_díåy
(
sb
, 
obje˘id
, 
roŸ_obje˘id
, 
gíî©i⁄
);

123 
	}
}

125 
díåy
 *
	$båfs_fh_to_díåy
(
su≥r_block
 *
sb
, 
fid
 *
fh
,

126 
fh_Àn
, 
fh_ty≥
)

128 
båfs_fid
 *
fid
 = (båfs_fid *Ë
fh
;

129 
u64
 
obje˘id
, 
roŸ_obje˘id
;

130 
u32
 
gíî©i⁄
;

132 i‡((
fh_ty≥
 !
FILEID_BTRFS_WITH_PARENT
 ||

133 
fh_Àn
 < 
BTRFS_FID_SIZE_CONNECTABLE
) &&

134 (
fh_ty≥
 !
FILEID_BTRFS_WITH_PARENT_ROOT
 ||

135 
fh_Àn
 < 
BTRFS_FID_SIZE_CONNECTABLE_ROOT
) &&

136 (
fh_ty≥
 !
FILEID_BTRFS_WITHOUT_PARENT
 ||

137 
fh_Àn
 < 
BTRFS_FID_SIZE_NON_CONNECTABLE
))

138  
NULL
;

140 
obje˘id
 = 
fid
->objectid;

141 
roŸ_obje˘id
 = 
fid
->root_objectid;

142 
gíî©i⁄
 = 
fid
->
gí
;

144  
	`båfs_gë_díåy
(
sb
, 
obje˘id
, 
roŸ_obje˘id
, 
gíî©i⁄
);

145 
	}
}

147 
díåy
 *
	$båfs_gë_∑ª¡
(
díåy
 *
chûd
)

149 
öode
 *
dú
 = 
	`d_öode
(
chûd
);

150 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
dú
->
i_sb
);

151 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
dú
)->root;

152 
båfs_∑th
 *
∑th
;

153 
exã¡_buf„r
 *
Àaf
;

154 
båfs_roŸ_ªf
 *
ªf
;

155 
båfs_key
 
key
;

156 
båfs_key
 
found_key
;

157 
ªt
;

159 
∑th
 = 
	`båfs_Æloc_∑th
();

160 i‡(!
∑th
)

161  
	`ERR_PTR
(-
ENOMEM
);

163 i‡(
	`båfs_öo
(
	`BTRFS_I
(
dú
)Ë=
BTRFS_FIRST_FREE_OBJECTID
) {

164 
key
.
obje˘id
 = 
roŸ
->
roŸ_key
.objectid;

165 
key
.
ty≥
 = 
BTRFS_ROOT_BACKREF_KEY
;

166 
key
.
off£t
 = (
u64
)-1;

167 
roŸ
 = 
fs_öfo
->
åì_roŸ
;

169 
key
.
obje˘id
 = 
	`båfs_öo
(
	`BTRFS_I
(
dú
));

170 
key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

171 
key
.
off£t
 = (
u64
)-1;

174 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

175 i‡(
ªt
 < 0)

176 
Áû
;

178 
	`BUG_ON
(
ªt
 == 0);

179 i‡(
∑th
->
¶Ÿs
[0] == 0) {

180 
ªt
 = -
ENOENT
;

181 
Áû
;

184 
∑th
->
¶Ÿs
[0]--;

185 
Àaf
 = 
∑th
->
nodes
[0];

187 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0]);

188 i‡(
found_key
.
obje˘id
 !
key
.obje˘id || found_key.
ty≥
 != key.type) {

189 
ªt
 = -
ENOENT
;

190 
Áû
;

193 i‡(
found_key
.
ty≥
 =
BTRFS_ROOT_BACKREF_KEY
) {

194 
ªf
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

195 
båfs_roŸ_ªf
);

196 
key
.
obje˘id
 = 
	`båfs_roŸ_ªf_dúid
(
Àaf
, 
ªf
);

198 
key
.
obje˘id
 = 
found_key
.
off£t
;

200 
	`båfs_‰ì_∑th
(
∑th
);

202 i‡(
found_key
.
ty≥
 =
BTRFS_ROOT_BACKREF_KEY
) {

203  
	`båfs_gë_díåy
(
fs_öfo
->
sb
, 
key
.
obje˘id
,

204 
found_key
.
off£t
, 0);

207  
	`d_obèö_Æüs
(
	`båfs_igë
(
fs_öfo
->
sb
, 
key
.
obje˘id
, 
roŸ
));

208 
Áû
:

209 
	`båfs_‰ì_∑th
(
∑th
);

210  
	`ERR_PTR
(
ªt
);

211 
	}
}

213 
	$båfs_gë_«me
(
díåy
 *
∑ª¡
, *
«me
,

214 
díåy
 *
chûd
)

216 
öode
 *öodê
	`d_öode
(
chûd
);

217 
öode
 *
dú
 = 
	`d_öode
(
∑ª¡
);

218 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

219 
båfs_∑th
 *
∑th
;

220 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
dú
)->root;

221 
båfs_öode_ªf
 *
úef
;

222 
båfs_roŸ_ªf
 *
ºef
;

223 
exã¡_buf„r
 *
Àaf
;

224 
«me_±r
;

225 
båfs_key
 
key
;

226 
«me_Àn
;

227 
ªt
;

228 
u64
 
öo
;

230 i‡(!
	`S_ISDIR
(
dú
->
i_mode
))

231  -
EINVAL
;

233 
öo
 = 
	`båfs_öo
(
	`BTRFS_I
(
öode
));

235 
∑th
 = 
	`båfs_Æloc_∑th
();

236 i‡(!
∑th
)

237  -
ENOMEM
;

239 i‡(
öo
 =
BTRFS_FIRST_FREE_OBJECTID
) {

240 
key
.
obje˘id
 = 
	`BTRFS_I
(
öode
)->
roŸ
->
roŸ_key
.objectid;

241 
key
.
ty≥
 = 
BTRFS_ROOT_BACKREF_KEY
;

242 
key
.
off£t
 = (
u64
)-1;

243 
roŸ
 = 
fs_öfo
->
åì_roŸ
;

245 
key
.
obje˘id
 = 
öo
;

246 
key
.
off£t
 = 
	`båfs_öo
(
	`BTRFS_I
(
dú
));

247 
key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

250 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

251 i‡(
ªt
 < 0) {

252 
	`båfs_‰ì_∑th
(
∑th
);

253  
ªt
;

254 } i‡(
ªt
 > 0) {

255 i‡(
öo
 =
BTRFS_FIRST_FREE_OBJECTID
) {

256 
∑th
->
¶Ÿs
[0]--;

258 
	`båfs_‰ì_∑th
(
∑th
);

259  -
ENOENT
;

262 
Àaf
 = 
∑th
->
nodes
[0];

264 i‡(
öo
 =
BTRFS_FIRST_FREE_OBJECTID
) {

265 
ºef
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

266 
båfs_roŸ_ªf
);

267 
«me_±r
 = ()(
ºef
 + 1);

268 
«me_Àn
 = 
	`båfs_roŸ_ªf_«me_Àn
(
Àaf
, 
ºef
);

270 
úef
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

271 
båfs_öode_ªf
);

272 
«me_±r
 = ()(
úef
 + 1);

273 
«me_Àn
 = 
	`båfs_öode_ªf_«me_Àn
(
Àaf
, 
úef
);

276 
	`ªad_exã¡_buf„r
(
Àaf
, 
«me
, 
«me_±r
, 
«me_Àn
);

277 
	`båfs_‰ì_∑th
(
∑th
);

283 
«me
[
«me_Àn
] = '\0';

286 
	}
}

288 c⁄° 
exp‹t_›î©i⁄s
 
	gbåfs_exp‹t_›s
 = {

289 .
ícode_fh
 = 
båfs_ícode_fh
,

290 .
	gfh_to_díåy
 = 
båfs_fh_to_díåy
,

291 .
	gfh_to_∑ª¡
 = 
båfs_fh_to_∑ª¡
,

292 .
	ggë_∑ª¡
 = 
båfs_gë_∑ª¡
,

293 .
	ggë_«me
 = 
båfs_gë_«me
,

	@export.h

3 #i‚de‡
BTRFS_EXPORT_H


4 
	#BTRFS_EXPORT_H


	)

6 
	~<löux/exp‹tfs.h
>

8 c⁄° 
exp‹t_›î©i⁄s
 
båfs_exp‹t_›s
;

10 
	sbåfs_fid
 {

11 
u64
 
	mobje˘id
;

12 
u64
 
	mroŸ_obje˘id
;

13 
u32
 
	mgí
;

15 
u64
 
	m∑ª¡_obje˘id
;

16 
u32
 
	m∑ª¡_gí
;

18 
u64
 
	m∑ª¡_roŸ_obje˘id
;

19 } 
__©åibuã__
 ((
∑cked
));

21 
díåy
 *
båfs_gë_díåy
(
su≥r_block
 *
sb
, 
u64
 
obje˘id
,

22 
u64
 
roŸ_obje˘id
, u64 
gíî©i⁄
);

23 
díåy
 *
båfs_gë_∑ª¡
(díåy *
chûd
);

	@extent-io-tree.c

3 
	~<löux/¶ab.h
>

4 
	~<åa˚/evíts/båfs.h
>

5 
	~"mesßges.h
"

6 
	~"˘ªe.h
"

7 
	~"exã¡-io-åì.h
"

8 
	~"båfs_öode.h
"

9 
	~"misc.h
"

11 
kmem_ˇche
 *
	gexã¡_°©e_ˇche
;

13 
ölöe
 
boﬁ
 
	$exã¡_°©e_ö_åì
(c⁄° 
exã¡_°©e
 *
°©e
)

15  !
	`RB_EMPTY_NODE
(&
°©e
->
rb_node
);

16 
	}
}

18 #ifde‡
CONFIG_BTRFS_DEBUG


19 
LIST_HEAD
(
°©es
);

20 
DEFINE_SPINLOCK
(
Àak_lock
);

22 
ölöe
 
	$båfs_Àak_debug_add_°©e
(
exã¡_°©e
 *
°©e
)

24 
Êags
;

26 
	`•ö_lock_úqßve
(&
Àak_lock
, 
Êags
);

27 
	`li°_add
(&
°©e
->
Àak_li°
, &
°©es
);

28 
	`•ö_u∆ock_úqª°‹e
(&
Àak_lock
, 
Êags
);

29 
	}
}

31 
ölöe
 
	$båfs_Àak_debug_dñ_°©e
(
exã¡_°©e
 *
°©e
)

33 
Êags
;

35 
	`•ö_lock_úqßve
(&
Àak_lock
, 
Êags
);

36 
	`li°_dñ
(&
°©e
->
Àak_li°
);

37 
	`•ö_u∆ock_úqª°‹e
(&
Àak_lock
, 
Êags
);

38 
	}
}

40 
ölöe
 
	$båfs_exã¡_°©e_Àak_debug_check
()

42 
exã¡_°©e
 *
°©e
;

44 !
	`li°_em±y
(&
°©es
)) {

45 
°©e
 = 
	`li°_íåy
(
°©es
.
√xt
, 
exã¡_°©e
, 
Àak_li°
);

46 
	`¥_îr
("BTRFS: stateÜeak: start %lluÉnd %llu state %u inÅree %dÑefs %d\n",

47 
°©e
->
°¨t
, sèã->
íd
, state->state,

48 
	`exã¡_°©e_ö_åì
(
°©e
),

49 
	`ªfcou¡_ªad
(&
°©e
->
ªfs
));

50 
	`li°_dñ
(&
°©e
->
Àak_li°
);

51 
	`kmem_ˇche_‰ì
(
exã¡_°©e_ˇche
, 
°©e
);

53 
	}
}

55 
	#båfs_debug_check_exã¡_io_ønge
(
åì
, 
°¨t
, 
íd
) \

56 
	`__båfs_debug_check_exã¡_io_ønge
(
__func__
, (
åì
), (
°¨t
), (
íd
))

	)

57 
ölöe
 
	$__båfs_debug_check_exã¡_io_ønge
(c⁄° *
ˇŒî
,

58 
exã¡_io_åì
 *
åì
,

59 
u64
 
°¨t
, u64 
íd
)

61 
båfs_öode
 *
öode
 = 
åì
->inode;

62 
u64
 
isize
;

64 i‡(!
öode
)

67 
isize
 = 
	`i_size_ªad
(&
öode
->
vfs_öode
);

68 i‡(
íd
 >
PAGE_SIZE
 && (íd % 2Ë=0 &&Énd !
isize
 - 1) {

69 
	`båfs_debug_æ
(
öode
->
roŸ
->
fs_öfo
,

71 
ˇŒî
, 
	`båfs_öo
(
öode
), 
isize
, 
°¨t
, 
íd
);

73 
	}
}

75 
	#båfs_Àak_debug_add_°©e
(
°©e
Ëdÿ{} 0)

	)

76 
	#båfs_Àak_debug_dñ_°©e
(
°©e
Ëdÿ{} 0)

	)

77 
	#båfs_exã¡_°©e_Àak_debug_check
(Ëdÿ{} 0)

	)

78 
	#båfs_debug_check_exã¡_io_ønge
(
c
, 
s
, 
e
Ëdÿ{} 0)

	)

88 
lock_˛ass_key
 
	gfûe_exã¡_åì_˛ass
;

90 
	såì_íåy
 {

91 
u64
 
	m°¨t
;

92 
u64
 
	míd
;

93 
rb_node
 
	mrb_node
;

96 
	$exã¡_io_åì_öô
(
båfs_fs_öfo
 *
fs_öfo
,

97 
exã¡_io_åì
 *
åì
, 
ow√r
)

99 
åì
->
fs_öfo
 = fs_info;

100 
åì
->
°©e
 = 
RB_ROOT
;

101 
	`•ö_lock_öô
(&
åì
->
lock
);

102 
åì
->
öode
 = 
NULL
;

103 
åì
->
ow√r
 = owner;

104 i‡(
ow√r
 =
IO_TREE_INODE_FILE_EXTENT
)

105 
	`lockdï_£t_˛ass
(&
åì
->
lock
, &
fûe_exã¡_åì_˛ass
);

106 
	}
}

108 
	$exã¡_io_åì_ªÀa£
(
exã¡_io_åì
 *
åì
)

110 
	`•ö_lock
(&
åì
->
lock
);

116 
	`smp_mb
();

117 !
	`RB_EMPTY_ROOT
(&
åì
->
°©e
)) {

118 
rb_node
 *
node
;

119 
exã¡_°©e
 *
°©e
;

121 
node
 = 
	`rb_fú°
(&
åì
->
°©e
);

122 
°©e
 = 
	`rb_íåy
(
node
, 
exã¡_°©e
, 
rb_node
);

123 
	`rb_îa£
(&
°©e
->
rb_node
, &
åì
->state);

124 
	`RB_CLEAR_NODE
(&
°©e
->
rb_node
);

129 
	`ASSERT
(!
	`waôqueue_a˘ive
(&
°©e
->
wq
));

130 
	`‰ì_exã¡_°©e
(
°©e
);

132 
	`c⁄d_ªsched_lock
(&
åì
->
lock
);

134 
	`•ö_u∆ock
(&
åì
->
lock
);

135 
	}
}

137 
exã¡_°©e
 *
	$Æloc_exã¡_°©e
(
gÂ_t
 
mask
)

139 
exã¡_°©e
 *
°©e
;

145 
mask
 &~(
__GFP_DMA32
|
__GFP_HIGHMEM
);

146 
°©e
 = 
	`kmem_ˇche_Æloc
(
exã¡_°©e_ˇche
, 
mask
);

147 i‡(!
°©e
)

148  
°©e
;

149 
°©e
->state = 0;

150 
	`RB_CLEAR_NODE
(&
°©e
->
rb_node
);

151 
	`båfs_Àak_debug_add_°©e
(
°©e
);

152 
	`ªfcou¡_£t
(&
°©e
->
ªfs
, 1);

153 
	`öô_waôqueue_hód
(&
°©e
->
wq
);

154 
	`åa˚_Æloc_exã¡_°©e
(
°©e
, 
mask
, 
_RET_IP_
);

155  
°©e
;

156 
	}
}

158 
exã¡_°©e
 *
	$Æloc_exã¡_°©e_©omic
(
exã¡_°©e
 *
¥óŒoc
)

160 i‡(!
¥óŒoc
)

161 
¥óŒoc
 = 
	`Æloc_exã¡_°©e
(
GFP_ATOMIC
);

163  
¥óŒoc
;

164 
	}
}

166 
	$‰ì_exã¡_°©e
(
exã¡_°©e
 *
°©e
)

168 i‡(!
°©e
)

170 i‡(
	`ªfcou¡_dec_™d_ã°
(&
°©e
->
ªfs
)) {

171 
	`WARN_ON
(
	`exã¡_°©e_ö_åì
(
°©e
));

172 
	`båfs_Àak_debug_dñ_°©e
(
°©e
);

173 
	`åa˚_‰ì_exã¡_°©e
(
°©e
, 
_RET_IP_
);

174 
	`kmem_ˇche_‰ì
(
exã¡_°©e_ˇche
, 
°©e
);

176 
	}
}

178 
	$add_exã¡_ch™ge£t
(
exã¡_°©e
 *
°©e
, 
u32
 
bôs
,

179 
exã¡_ch™ge£t
 *
ch™ge£t
,

180 
£t
)

182 
ªt
;

184 i‡(!
ch™ge£t
)

186 i‡(
£t
 && (
°©e
->°©ê& 
bôs
) == bits)

188 i‡(!
£t
 && (
°©e
->°©ê& 
bôs
) == 0)

190 
ch™ge£t
->
byãs_ch™ged
 +
°©e
->
íd
 - sèã->
°¨t
 + 1;

191 
ªt
 = 
	`uli°_add
(&
ch™ge£t
->
ønge_ch™ged
, 
°©e
->
°¨t
, sèã->
íd
,

192 
GFP_ATOMIC
);

193  
ªt
;

194 
	}
}

196 
ölöe
 
exã¡_°©e
 *
	$√xt_°©e
(
exã¡_°©e
 *
°©e
)

198 
rb_node
 *
√xt
 = 
	`rb_√xt
(&
°©e
->rb_node);

200 i‡(
√xt
)

201  
	`rb_íåy
(
√xt
, 
exã¡_°©e
, 
rb_node
);

203  
NULL
;

204 
	}
}

206 
ölöe
 
exã¡_°©e
 *
	$¥ev_°©e
(
exã¡_°©e
 *
°©e
)

208 
rb_node
 *
√xt
 = 
	`rb_¥ev
(&
°©e
->rb_node);

210 i‡(
√xt
)

211  
	`rb_íåy
(
√xt
, 
exã¡_°©e
, 
rb_node
);

213  
NULL
;

214 
	}
}

233 
ölöe
 
exã¡_°©e
 *
	$åì_£¨ch_f‹_ö£π
(
exã¡_io_åì
 *
åì
,

234 
u64
 
off£t
,

235 
rb_node
 ***
node_ªt
,

236 
rb_node
 **
∑ª¡_ªt
)

238 
rb_roŸ
 *
roŸ
 = &
åì
->
°©e
;

239 
rb_node
 **
node
 = &
roŸ
->rb_node;

240 
rb_node
 *
¥ev
 = 
NULL
;

241 
exã¡_°©e
 *
íåy
 = 
NULL
;

243 *
node
) {

244 
¥ev
 = *
node
;

245 
íåy
 = 
	`rb_íåy
(
¥ev
, 
exã¡_°©e
, 
rb_node
);

247 i‡(
off£t
 < 
íåy
->
°¨t
)

248 
node
 = &(*node)->
rb_À·
;

249 i‡(
off£t
 > 
íåy
->
íd
)

250 
node
 = &(*node)->
rb_right
;

252  
íåy
;

255 i‡(
node_ªt
)

256 *
node_ªt
 = 
node
;

257 i‡(
∑ª¡_ªt
)

258 *
∑ª¡_ªt
 = 
¥ev
;

261 
íåy
 && 
off£t
 >É¡ry->
íd
)

262 
íåy
 = 
	`√xt_°©e
(entry);

264  
íåy
;

265 
	}
}

279 
exã¡_°©e
 *
	$åì_£¨ch_¥ev_√xt
(
exã¡_io_åì
 *
åì
,

280 
u64
 
off£t
,

281 
exã¡_°©e
 **
¥ev_ªt
,

282 
exã¡_°©e
 **
√xt_ªt
)

284 
rb_roŸ
 *
roŸ
 = &
åì
->
°©e
;

285 
rb_node
 **
node
 = &
roŸ
->rb_node;

286 
exã¡_°©e
 *
‹ig_¥ev
;

287 
exã¡_°©e
 *
íåy
 = 
NULL
;

289 
	`ASSERT
(
¥ev_ªt
);

290 
	`ASSERT
(
√xt_ªt
);

292 *
node
) {

293 
íåy
 = 
	`rb_íåy
(*
node
, 
exã¡_°©e
, 
rb_node
);

295 i‡(
off£t
 < 
íåy
->
°¨t
)

296 
node
 = &(*node)->
rb_À·
;

297 i‡(
off£t
 > 
íåy
->
íd
)

298 
node
 = &(*node)->
rb_right
;

300  
íåy
;

303 
‹ig_¥ev
 = 
íåy
;

304 
íåy
 && 
off£t
 >É¡ry->
íd
)

305 
íåy
 = 
	`√xt_°©e
(entry);

306 *
√xt_ªt
 = 
íåy
;

307 
íåy
 = 
‹ig_¥ev
;

309 
íåy
 && 
off£t
 <É¡ry->
°¨t
)

310 
íåy
 = 
	`¥ev_°©e
(entry);

311 *
¥ev_ªt
 = 
íåy
;

313  
NULL
;

314 
	}
}

319 
ölöe
 
exã¡_°©e
 *
	$åì_£¨ch
(
exã¡_io_åì
 *
åì
, 
u64
 
off£t
)

321  
	`åì_£¨ch_f‹_ö£π
(
åì
, 
off£t
, 
NULL
, NULL);

322 
	}
}

324 
	$exã¡_io_åì_∑nic
(
exã¡_io_åì
 *
åì
, 
îr
)

326 
	`båfs_∑nic
(
åì
->
fs_öfo
, 
îr
,

328 
	}
}

339 
	$mîge_°©e
(
exã¡_io_åì
 *
åì
, 
exã¡_°©e
 *
°©e
)

341 
exã¡_°©e
 *
Ÿhî
;

343 i‡(
°©e
->°©ê& (
EXTENT_LOCKED
 | 
EXTENT_BOUNDARY
))

346 
Ÿhî
 = 
	`¥ev_°©e
(
°©e
);

347 i‡(
Ÿhî
 && othî->
íd
 =
°©e
->
°¨t
 - 1 &&

348 
Ÿhî
->
°©e
 == state->state) {

349 i‡(
åì
->
öode
)

350 
	`båfs_mîge_dñÆloc_exã¡
(
åì
->
öode
, 
°©e
, 
Ÿhî
);

351 
°©e
->
°¨t
 = 
Ÿhî
->start;

352 
	`rb_îa£
(&
Ÿhî
->
rb_node
, &
åì
->
°©e
);

353 
	`RB_CLEAR_NODE
(&
Ÿhî
->
rb_node
);

354 
	`‰ì_exã¡_°©e
(
Ÿhî
);

356 
Ÿhî
 = 
	`√xt_°©e
(
°©e
);

357 i‡(
Ÿhî
 && othî->
°¨t
 =
°©e
->
íd
 + 1 &&

358 
Ÿhî
->
°©e
 == state->state) {

359 i‡(
åì
->
öode
)

360 
	`båfs_mîge_dñÆloc_exã¡
(
åì
->
öode
, 
°©e
, 
Ÿhî
);

361 
°©e
->
íd
 = 
Ÿhî
->end;

362 
	`rb_îa£
(&
Ÿhî
->
rb_node
, &
åì
->
°©e
);

363 
	`RB_CLEAR_NODE
(&
Ÿhî
->
rb_node
);

364 
	`‰ì_exã¡_°©e
(
Ÿhî
);

366 
	}
}

368 
	$£t_°©e_bôs
(
exã¡_io_åì
 *
åì
,

369 
exã¡_°©e
 *
°©e
,

370 
u32
 
bôs
, 
exã¡_ch™ge£t
 *
ch™ge£t
)

372 
u32
 
bôs_to_£t
 = 
bôs
 & ~
EXTENT_CTLBITS
;

373 
ªt
;

375 i‡(
åì
->
öode
)

376 
	`båfs_£t_dñÆloc_exã¡
(
åì
->
öode
, 
°©e
, 
bôs
);

378 
ªt
 = 
	`add_exã¡_ch™ge£t
(
°©e
, 
bôs_to_£t
, 
ch™ge£t
, 1);

379 
	`BUG_ON
(
ªt
 < 0);

380 
°©e
->°©ê|
bôs_to_£t
;

381 
	}
}

393 
	$ö£π_°©e
(
exã¡_io_åì
 *
åì
,

394 
exã¡_°©e
 *
°©e
,

395 
u32
 
bôs
, 
exã¡_ch™ge£t
 *
ch™ge£t
)

397 
rb_node
 **
node
;

398 
rb_node
 *
∑ª¡
 = 
NULL
;

399 c⁄° 
u64
 
íd
 = 
°©e
->end;

401 
	`£t_°©e_bôs
(
åì
, 
°©e
, 
bôs
, 
ch™ge£t
);

403 
node
 = &
åì
->
°©e
.
rb_node
;

404 *
node
) {

405 
exã¡_°©e
 *
íåy
;

407 
∑ª¡
 = *
node
;

408 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
exã¡_°©e
, 
rb_node
);

410 i‡(
íd
 < 
íåy
->
°¨t
) {

411 
node
 = &(*node)->
rb_À·
;

412 } i‡(
íd
 > 
íåy
->end) {

413 
node
 = &(*node)->
rb_right
;

415 
	`båfs_îr
(
åì
->
fs_öfo
,

417 
íåy
->
°¨t
,É¡ry->
íd
, 
°©e
->start,Énd);

418  -
EEXIST
;

422 
	`rb_lök_node
(&
°©e
->
rb_node
, 
∑ª¡
, 
node
);

423 
	`rb_ö£π_cﬁ‹
(&
°©e
->
rb_node
, &
åì
->state);

425 
	`mîge_°©e
(
åì
, 
°©e
);

427 
	}
}

432 
	$ö£π_°©e_Á°
(
exã¡_io_åì
 *
åì
,

433 
exã¡_°©e
 *
°©e
, 
rb_node
 **
node
,

434 
rb_node
 *
∑ª¡
, 
bôs
,

435 
exã¡_ch™ge£t
 *
ch™ge£t
)

437 
	`£t_°©e_bôs
(
åì
, 
°©e
, 
bôs
, 
ch™ge£t
);

438 
	`rb_lök_node
(&
°©e
->
rb_node
, 
∑ª¡
, 
node
);

439 
	`rb_ö£π_cﬁ‹
(&
°©e
->
rb_node
, &
åì
->state);

440 
	`mîge_°©e
(
åì
, 
°©e
);

441 
	}
}

457 
	$•lô_°©e
(
exã¡_io_åì
 *
åì
, 
exã¡_°©e
 *
‹ig
,

458 
exã¡_°©e
 *
¥óŒoc
, 
u64
 
•lô
)

460 
rb_node
 *
∑ª¡
 = 
NULL
;

461 
rb_node
 **
node
;

463 i‡(
åì
->
öode
)

464 
	`båfs_•lô_dñÆloc_exã¡
(
åì
->
öode
, 
‹ig
, 
•lô
);

466 
¥óŒoc
->
°¨t
 = 
‹ig
->start;

467 
¥óŒoc
->
íd
 = 
•lô
 - 1;

468 
¥óŒoc
->
°©e
 = 
‹ig
->state;

469 
‹ig
->
°¨t
 = 
•lô
;

471 
∑ª¡
 = &
‹ig
->
rb_node
;

472 
node
 = &
∑ª¡
;

473 *
node
) {

474 
exã¡_°©e
 *
íåy
;

476 
∑ª¡
 = *
node
;

477 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
exã¡_°©e
, 
rb_node
);

479 i‡(
¥óŒoc
->
íd
 < 
íåy
->
°¨t
) {

480 
node
 = &(*node)->
rb_À·
;

481 } i‡(
¥óŒoc
->
íd
 > 
íåy
->end) {

482 
node
 = &(*node)->
rb_right
;

484 
	`‰ì_exã¡_°©e
(
¥óŒoc
);

485  -
EEXIST
;

489 
	`rb_lök_node
(&
¥óŒoc
->
rb_node
, 
∑ª¡
, 
node
);

490 
	`rb_ö£π_cﬁ‹
(&
¥óŒoc
->
rb_node
, &
åì
->
°©e
);

493 
	}
}

502 
exã¡_°©e
 *
	$˛ór_°©e_bô
(
exã¡_io_åì
 *
åì
,

503 
exã¡_°©e
 *
°©e
,

504 
u32
 
bôs
, 
wake
,

505 
exã¡_ch™ge£t
 *
ch™ge£t
)

507 
exã¡_°©e
 *
√xt
;

508 
u32
 
bôs_to_˛ór
 = 
bôs
 & ~
EXTENT_CTLBITS
;

509 
ªt
;

511 i‡(
åì
->
öode
)

512 
	`båfs_˛ór_dñÆloc_exã¡
(
åì
->
öode
, 
°©e
, 
bôs
);

514 
ªt
 = 
	`add_exã¡_ch™ge£t
(
°©e
, 
bôs_to_˛ór
, 
ch™ge£t
, 0);

515 
	`BUG_ON
(
ªt
 < 0);

516 
°©e
->°©ê&~
bôs_to_˛ór
;

517 i‡(
wake
)

518 
	`wake_up
(&
°©e
->
wq
);

519 i‡(
°©e
->state == 0) {

520 
√xt
 = 
	`√xt_°©e
(
°©e
);

521 i‡(
	`exã¡_°©e_ö_åì
(
°©e
)) {

522 
	`rb_îa£
(&
°©e
->
rb_node
, &
åì
->state);

523 
	`RB_CLEAR_NODE
(&
°©e
->
rb_node
);

524 
	`‰ì_exã¡_°©e
(
°©e
);

526 
	`WARN_ON
(1);

529 
	`mîge_°©e
(
åì
, 
°©e
);

530 
√xt
 = 
	`√xt_°©e
(
°©e
);

532  
√xt
;

533 
	}
}

539 
	$£t_gÂ_mask_‰om_bôs
(
u32
 *
bôs
, 
gÂ_t
 *
mask
)

541 *
mask
 = (*
bôs
 & 
EXTENT_NOWAIT
 ? 
GFP_NOWAIT
 : 
GFP_NOFS
);

542 *
bôs
 &
EXTENT_NOWAIT
 - 1;

543 
	}
}

557 
	$__˛ór_exã¡_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

558 
u32
 
bôs
, 
exã¡_°©e
 **
ˇched_°©e
,

559 
exã¡_ch™ge£t
 *
ch™ge£t
)

561 
exã¡_°©e
 *
°©e
;

562 
exã¡_°©e
 *
ˇched
;

563 
exã¡_°©e
 *
¥óŒoc
 = 
NULL
;

564 
u64
 
œ°_íd
;

565 
îr
;

566 
˛ór
 = 0;

567 
wake
;

568 
dñëe
 = (
bôs
 & 
EXTENT_CLEAR_ALL_BITS
);

569 
gÂ_t
 
mask
;

571 
	`£t_gÂ_mask_‰om_bôs
(&
bôs
, &
mask
);

572 
	`båfs_debug_check_exã¡_io_ønge
(
åì
, 
°¨t
, 
íd
);

573 
	`åa˚_båfs_˛ór_exã¡_bô
(
åì
, 
°¨t
, 
íd
 - sèπ + 1, 
bôs
);

575 i‡(
dñëe
)

576 
bôs
 |~
EXTENT_CTLBITS
;

578 i‡(
bôs
 & 
EXTENT_DELALLOC
)

579 
bôs
 |
EXTENT_NORESERVE
;

581 
wake
 = (
bôs
 & 
EXTENT_LOCKED
) ? 1 : 0;

582 i‡(
bôs
 & (
EXTENT_LOCKED
 | 
EXTENT_BOUNDARY
))

583 
˛ór
 = 1;

584 
agaö
:

585 i‡(!
¥óŒoc
) {

593 
¥óŒoc
 = 
	`Æloc_exã¡_°©e
(
mask
);

596 
	`•ö_lock
(&
åì
->
lock
);

597 i‡(
ˇched_°©e
) {

598 
ˇched
 = *
ˇched_°©e
;

600 i‡(
˛ór
) {

601 *
ˇched_°©e
 = 
NULL
;

602 
ˇched_°©e
 = 
NULL
;

605 i‡(
ˇched
 && 
	`exã¡_°©e_ö_åì
(cached) &&

606 
ˇched
->
°¨t
 <°¨à&& cached->
íd
 > start) {

607 i‡(
˛ór
)

608 
	`ªfcou¡_dec
(&
ˇched
->
ªfs
);

609 
°©e
 = 
ˇched
;

610 
hô_√xt
;

612 i‡(
˛ór
)

613 
	`‰ì_exã¡_°©e
(
ˇched
);

617 
°©e
 = 
	`åì_£¨ch
(
åì
, 
°¨t
);

618 i‡(!
°©e
)

619 
out
;

620 
hô_√xt
:

621 i‡(
°©e
->
°¨t
 > 
íd
)

622 
out
;

623 
	`WARN_ON
(
°©e
->
íd
 < 
°¨t
);

624 
œ°_íd
 = 
°©e
->
íd
;

627 i‡(!(
°©e
->°©ê& 
bôs
)) {

628 
°©e
 = 
	`√xt_°©e
(state);

629 
√xt
;

647 i‡(
°©e
->
°¨t
 < start) {

648 
¥óŒoc
 = 
	`Æloc_exã¡_°©e_©omic
(prealloc);

649 i‡(!
¥óŒoc
)

650 
£¨ch_agaö
;

651 
îr
 = 
	`•lô_°©e
(
åì
, 
°©e
, 
¥óŒoc
, 
°¨t
);

652 i‡(
îr
)

653 
	`exã¡_io_åì_∑nic
(
åì
, 
îr
);

655 
¥óŒoc
 = 
NULL
;

656 i‡(
îr
)

657 
out
;

658 i‡(
°©e
->
íd
 <=Énd) {

659 
°©e
 = 
	`˛ór_°©e_bô
(
åì
, sèã, 
bôs
, 
wake
, 
ch™ge£t
);

660 
√xt
;

662 
£¨ch_agaö
;

669 i‡(
°©e
->
°¨t
 <
íd
 && state->end >Énd) {

670 
¥óŒoc
 = 
	`Æloc_exã¡_°©e_©omic
(prealloc);

671 i‡(!
¥óŒoc
)

672 
£¨ch_agaö
;

673 
îr
 = 
	`•lô_°©e
(
åì
, 
°©e
, 
¥óŒoc
, 
íd
 + 1);

674 i‡(
îr
)

675 
	`exã¡_io_åì_∑nic
(
åì
, 
îr
);

677 i‡(
wake
)

678 
	`wake_up
(&
°©e
->
wq
);

680 
	`˛ór_°©e_bô
(
åì
, 
¥óŒoc
, 
bôs
, 
wake
, 
ch™ge£t
);

682 
¥óŒoc
 = 
NULL
;

683 
out
;

686 
°©e
 = 
	`˛ór_°©e_bô
(
åì
, sèã, 
bôs
, 
wake
, 
ch™ge£t
);

687 
√xt
:

688 i‡(
œ°_íd
 =(
u64
)-1)

689 
out
;

690 
°¨t
 = 
œ°_íd
 + 1;

691 i‡(
°¨t
 <
íd
 && 
°©e
 && !
	`√ed_ªsched
())

692 
hô_√xt
;

694 
£¨ch_agaö
:

695 i‡(
°¨t
 > 
íd
)

696 
out
;

697 
	`•ö_u∆ock
(&
åì
->
lock
);

698 i‡(
	`gÂÊags_Ælow_blockög
(
mask
))

699 
	`c⁄d_ªsched
();

700 
agaö
;

702 
out
:

703 
	`•ö_u∆ock
(&
åì
->
lock
);

704 i‡(
¥óŒoc
)

705 
	`‰ì_exã¡_°©e
(
¥óŒoc
);

709 
	}
}

711 
	$waô_⁄_°©e
(
exã¡_io_åì
 *
åì
,

712 
exã¡_°©e
 *
°©e
)

713 
	`__ªÀa£s
(
åì
->
lock
)

714 
	`__acquúes
(
åì
->
lock
)

716 
	`DEFINE_WAIT
(
waô
);

717 
	`¥ï¨e_to_waô
(&
°©e
->
wq
, &
waô
, 
TASK_UNINTERRUPTIBLE
);

718 
	`•ö_u∆ock
(&
åì
->
lock
);

719 
	`scheduÀ
();

720 
	`•ö_lock
(&
åì
->
lock
);

721 
	`föish_waô
(&
°©e
->
wq
, &
waô
);

722 
	}
}

729 
	$waô_exã¡_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
, 
u32
 
bôs
,

730 
exã¡_°©e
 **
ˇched_°©e
)

732 
exã¡_°©e
 *
°©e
;

734 
	`båfs_debug_check_exã¡_io_ønge
(
åì
, 
°¨t
, 
íd
);

736 
	`•ö_lock
(&
åì
->
lock
);

737 
agaö
:

742 i‡(
ˇched_°©e
 && *cached_state) {

743 
°©e
 = *
ˇched_°©e
;

744 i‡(
	`exã¡_°©e_ö_åì
(
°©e
) &&

745 
°©e
->
°¨t
 <°¨à&& sèπ < sèã->
íd
)

746 
¥o˚ss_node
;

753 
°©e
 = 
	`åì_£¨ch
(
åì
, 
°¨t
);

754 
¥o˚ss_node
:

755 i‡(!
°©e
)

757 i‡(
°©e
->
°¨t
 > 
íd
)

758 
out
;

760 i‡(
°©e
->°©ê& 
bôs
) {

761 
°¨t
 = 
°©e
->start;

762 
	`ªfcou¡_öc
(&
°©e
->
ªfs
);

763 
	`waô_⁄_°©e
(
åì
, 
°©e
);

764 
	`‰ì_exã¡_°©e
(
°©e
);

765 
agaö
;

767 
°¨t
 = 
°©e
->
íd
 + 1;

769 i‡(
°¨t
 > 
íd
)

772 i‡(!
	`c⁄d_ªsched_lock
(&
åì
->
lock
)) {

773 
°©e
 = 
	`√xt_°©e
(state);

774 
¥o˚ss_node
;

777 
out
:

779 i‡(
ˇched_°©e
 && *cached_state) {

780 
°©e
 = *
ˇched_°©e
;

781 *
ˇched_°©e
 = 
NULL
;

782 
	`‰ì_exã¡_°©e
(
°©e
);

784 
	`•ö_u∆ock
(&
åì
->
lock
);

785 
	}
}

787 
	$ˇche_°©e_if_Êags
(
exã¡_°©e
 *
°©e
,

788 
exã¡_°©e
 **
ˇched_±r
,

789 
Êags
)

791 i‡(
ˇched_±r
 && !(*cached_ptr)) {

792 i‡(!
Êags
 || (
°©e
->state & flags)) {

793 *
ˇched_±r
 = 
°©e
;

794 
	`ªfcou¡_öc
(&
°©e
->
ªfs
);

797 
	}
}

799 
	$ˇche_°©e
(
exã¡_°©e
 *
°©e
,

800 
exã¡_°©e
 **
ˇched_±r
)

802  
	`ˇche_°©e_if_Êags
(
°©e
, 
ˇched_±r
,

803 
EXTENT_LOCKED
 | 
EXTENT_BOUNDARY
);

804 
	}
}

811 
exã¡_°©e
 *
	$föd_fú°_exã¡_bô_°©e
(
exã¡_io_åì
 *
åì
,

812 
u64
 
°¨t
, 
u32
 
bôs
)

814 
exã¡_°©e
 *
°©e
;

820 
°©e
 = 
	`åì_£¨ch
(
åì
, 
°¨t
);

821 
°©e
) {

822 i‡(
°©e
->
íd
 >
°¨t
 && (°©e->°©ê& 
bôs
))

823  
°©e
;

824 
°©e
 = 
	`√xt_°©e
(state);

826  
NULL
;

827 
	}
}

837 
boﬁ
 
	$föd_fú°_exã¡_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
,

838 
u64
 *
°¨t_ªt
, u64 *
íd_ªt
, 
u32
 
bôs
,

839 
exã¡_°©e
 **
ˇched_°©e
)

841 
exã¡_°©e
 *
°©e
;

842 
boﬁ
 
ªt
 = 
Ál£
;

844 
	`•ö_lock
(&
åì
->
lock
);

845 i‡(
ˇched_°©e
 && *cached_state) {

846 
°©e
 = *
ˇched_°©e
;

847 i‡(
°©e
->
íd
 =
°¨t
 - 1 && 
	`exã¡_°©e_ö_åì
(state)) {

848 (
°©e
 = 
	`√xt_°©e
(°©e)Ë!
NULL
) {

849 i‡(
°©e
->°©ê& 
bôs
)

850 
gŸ_ô
;

852 
	`‰ì_exã¡_°©e
(*
ˇched_°©e
);

853 *
ˇched_°©e
 = 
NULL
;

854 
out
;

856 
	`‰ì_exã¡_°©e
(*
ˇched_°©e
);

857 *
ˇched_°©e
 = 
NULL
;

860 
°©e
 = 
	`föd_fú°_exã¡_bô_°©e
(
åì
, 
°¨t
, 
bôs
);

861 
gŸ_ô
:

862 i‡(
°©e
) {

863 
	`ˇche_°©e_if_Êags
(
°©e
, 
ˇched_°©e
, 0);

864 *
°¨t_ªt
 = 
°©e
->
°¨t
;

865 *
íd_ªt
 = 
°©e
->
íd
;

866 
ªt
 = 
åue
;

868 
out
:

869 
	`•ö_u∆ock
(&
åì
->
lock
);

870  
ªt
;

871 
	}
}

889 
	$föd_c⁄tiguous_exã¡_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
,

890 
u64
 *
°¨t_ªt
, u64 *
íd_ªt
, 
u32
 
bôs
)

892 
exã¡_°©e
 *
°©e
;

893 
ªt
 = 1;

895 
	`•ö_lock
(&
åì
->
lock
);

896 
°©e
 = 
	`föd_fú°_exã¡_bô_°©e
(
åì
, 
°¨t
, 
bôs
);

897 i‡(
°©e
) {

898 *
°¨t_ªt
 = 
°©e
->
°¨t
;

899 *
íd_ªt
 = 
°©e
->
íd
;

900 (
°©e
 = 
	`√xt_°©e
(°©e)Ë!
NULL
) {

901 i‡(
°©e
->
°¨t
 > (*
íd_ªt
 + 1))

903 *
íd_ªt
 = 
°©e
->
íd
;

905 
ªt
 = 0;

907 
	`•ö_u∆ock
(&
åì
->
lock
);

908  
ªt
;

909 
	}
}

917 
boﬁ
 
	$båfs_föd_dñÆloc_ønge
(
exã¡_io_åì
 *
åì
, 
u64
 *
°¨t
,

918 
u64
 *
íd
, u64 
max_byãs
,

919 
exã¡_°©e
 **
ˇched_°©e
)

921 
exã¡_°©e
 *
°©e
;

922 
u64
 
cur_°¨t
 = *
°¨t
;

923 
boﬁ
 
found
 = 
Ál£
;

924 
u64
 
tŸÆ_byãs
 = 0;

926 
	`•ö_lock
(&
åì
->
lock
);

932 
°©e
 = 
	`åì_£¨ch
(
åì
, 
cur_°¨t
);

933 i‡(!
°©e
) {

934 *
íd
 = (
u64
)-1;

935 
out
;

938 
°©e
) {

939 i‡(
found
 && (
°©e
->
°¨t
 !
cur_°¨t
 ||

940 (
°©e
->°©ê& 
EXTENT_BOUNDARY
))) {

941 
out
;

943 i‡(!(
°©e
->°©ê& 
EXTENT_DELALLOC
)) {

944 i‡(!
found
)

945 *
íd
 = 
°©e
->end;

946 
out
;

948 i‡(!
found
) {

949 *
°¨t
 = 
°©e
->start;

950 *
ˇched_°©e
 = 
°©e
;

951 
	`ªfcou¡_öc
(&
°©e
->
ªfs
);

953 
found
 = 
åue
;

954 *
íd
 = 
°©e
->end;

955 
cur_°¨t
 = 
°©e
->
íd
 + 1;

956 
tŸÆ_byãs
 +
°©e
->
íd
 - sèã->
°¨t
 + 1;

957 i‡(
tŸÆ_byãs
 >
max_byãs
)

959 
°©e
 = 
	`√xt_°©e
(state);

961 
out
:

962 
	`•ö_u∆ock
(&
åì
->
lock
);

963  
found
;

964 
	}
}

980 
	$__£t_exã¡_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

981 
u32
 
bôs
, 
u64
 *
Áûed_°¨t
,

982 
exã¡_°©e
 **
Áûed_°©e
,

983 
exã¡_°©e
 **
ˇched_°©e
,

984 
exã¡_ch™ge£t
 *
ch™ge£t
)

986 
exã¡_°©e
 *
°©e
;

987 
exã¡_°©e
 *
¥óŒoc
 = 
NULL
;

988 
rb_node
 **
p
 = 
NULL
;

989 
rb_node
 *
∑ª¡
 = 
NULL
;

990 
îr
 = 0;

991 
u64
 
œ°_°¨t
;

992 
u64
 
œ°_íd
;

993 
u32
 
ex˛usive_bôs
 = (
bôs
 & 
EXTENT_LOCKED
);

994 
gÂ_t
 
mask
;

996 
	`£t_gÂ_mask_‰om_bôs
(&
bôs
, &
mask
);

997 
	`båfs_debug_check_exã¡_io_ønge
(
åì
, 
°¨t
, 
íd
);

998 
	`åa˚_båfs_£t_exã¡_bô
(
åì
, 
°¨t
, 
íd
 - sèπ + 1, 
bôs
);

1000 i‡(
ex˛usive_bôs
)

1001 
	`ASSERT
(
Áûed_°¨t
);

1003 
	`ASSERT
(
Áûed_°¨t
 =
NULL
 && 
Áûed_°©e
 == NULL);

1004 
agaö
:

1005 i‡(!
¥óŒoc
) {

1013 
¥óŒoc
 = 
	`Æloc_exã¡_°©e
(
mask
);

1016 
	`•ö_lock
(&
åì
->
lock
);

1017 i‡(
ˇched_°©e
 && *cached_state) {

1018 
°©e
 = *
ˇched_°©e
;

1019 i‡(
°©e
->
°¨t
 <°¨à&& sèã->
íd
 > start &&

1020 
	`exã¡_°©e_ö_åì
(
°©e
))

1021 
hô_√xt
;

1027 
°©e
 = 
	`åì_£¨ch_f‹_ö£π
(
åì
, 
°¨t
, &
p
, &
∑ª¡
);

1028 i‡(!
°©e
) {

1029 
¥óŒoc
 = 
	`Æloc_exã¡_°©e_©omic
(prealloc);

1030 i‡(!
¥óŒoc
)

1031 
£¨ch_agaö
;

1032 
¥óŒoc
->
°¨t
 = start;

1033 
¥óŒoc
->
íd
 =Énd;

1034 
	`ö£π_°©e_Á°
(
åì
, 
¥óŒoc
, 
p
, 
∑ª¡
, 
bôs
, 
ch™ge£t
);

1035 
	`ˇche_°©e
(
¥óŒoc
, 
ˇched_°©e
);

1036 
¥óŒoc
 = 
NULL
;

1037 
out
;

1039 
hô_√xt
:

1040 
œ°_°¨t
 = 
°©e
->
°¨t
;

1041 
œ°_íd
 = 
°©e
->
íd
;

1049 i‡(
°©e
->
°¨t
 =°¨à&& sèã->
íd
 <=Énd) {

1050 i‡(
°©e
->°©ê& 
ex˛usive_bôs
) {

1051 *
Áûed_°¨t
 = 
°©e
->
°¨t
;

1052 
	`ˇche_°©e
(
°©e
, 
Áûed_°©e
);

1053 
îr
 = -
EEXIST
;

1054 
out
;

1057 
	`£t_°©e_bôs
(
åì
, 
°©e
, 
bôs
, 
ch™ge£t
);

1058 
	`ˇche_°©e
(
°©e
, 
ˇched_°©e
);

1059 
	`mîge_°©e
(
åì
, 
°©e
);

1060 i‡(
œ°_íd
 =(
u64
)-1)

1061 
out
;

1062 
°¨t
 = 
œ°_íd
 + 1;

1063 
°©e
 = 
	`√xt_°©e
(state);

1064 i‡(
°¨t
 < 
íd
 && 
°©e
 && state->start == start &&

1065 !
	`√ed_ªsched
())

1066 
hô_√xt
;

1067 
£¨ch_agaö
;

1085 i‡(
°©e
->
°¨t
 < start) {

1086 i‡(
°©e
->°©ê& 
ex˛usive_bôs
) {

1087 *
Áûed_°¨t
 = 
°¨t
;

1088 
	`ˇche_°©e
(
°©e
, 
Áûed_°©e
);

1089 
îr
 = -
EEXIST
;

1090 
out
;

1097 i‡((
°©e
->°©ê& 
bôs
) == bits) {

1098 
°¨t
 = 
°©e
->
íd
 + 1;

1099 
	`ˇche_°©e
(
°©e
, 
ˇched_°©e
);

1100 
£¨ch_agaö
;

1103 
¥óŒoc
 = 
	`Æloc_exã¡_°©e_©omic
(prealloc);

1104 i‡(!
¥óŒoc
)

1105 
£¨ch_agaö
;

1106 
îr
 = 
	`•lô_°©e
(
åì
, 
°©e
, 
¥óŒoc
, 
°¨t
);

1107 i‡(
îr
)

1108 
	`exã¡_io_åì_∑nic
(
åì
, 
îr
);

1110 
¥óŒoc
 = 
NULL
;

1111 i‡(
îr
)

1112 
out
;

1113 i‡(
°©e
->
íd
 <=Énd) {

1114 
	`£t_°©e_bôs
(
åì
, 
°©e
, 
bôs
, 
ch™ge£t
);

1115 
	`ˇche_°©e
(
°©e
, 
ˇched_°©e
);

1116 
	`mîge_°©e
(
åì
, 
°©e
);

1117 i‡(
œ°_íd
 =(
u64
)-1)

1118 
out
;

1119 
°¨t
 = 
œ°_íd
 + 1;

1120 
°©e
 = 
	`√xt_°©e
(state);

1121 i‡(
°¨t
 < 
íd
 && 
°©e
 && state->start == start &&

1122 !
	`√ed_ªsched
())

1123 
hô_√xt
;

1125 
£¨ch_agaö
;

1134 i‡(
°©e
->
°¨t
 > start) {

1135 
u64
 
this_íd
;

1136 i‡(
íd
 < 
œ°_°¨t
)

1137 
this_íd
 = 
íd
;

1139 
this_íd
 = 
œ°_°¨t
 - 1;

1141 
¥óŒoc
 = 
	`Æloc_exã¡_°©e_©omic
(prealloc);

1142 i‡(!
¥óŒoc
)

1143 
£¨ch_agaö
;

1149 
¥óŒoc
->
°¨t
 = start;

1150 
¥óŒoc
->
íd
 = 
this_íd
;

1151 
îr
 = 
	`ö£π_°©e
(
åì
, 
¥óŒoc
, 
bôs
, 
ch™ge£t
);

1152 i‡(
îr
)

1153 
	`exã¡_io_åì_∑nic
(
åì
, 
îr
);

1155 
	`ˇche_°©e
(
¥óŒoc
, 
ˇched_°©e
);

1156 
¥óŒoc
 = 
NULL
;

1157 
°¨t
 = 
this_íd
 + 1;

1158 
£¨ch_agaö
;

1166 i‡(
°©e
->
°¨t
 <
íd
 && state->end >Énd) {

1167 i‡(
°©e
->°©ê& 
ex˛usive_bôs
) {

1168 *
Áûed_°¨t
 = 
°¨t
;

1169 
	`ˇche_°©e
(
°©e
, 
Áûed_°©e
);

1170 
îr
 = -
EEXIST
;

1171 
out
;

1174 
¥óŒoc
 = 
	`Æloc_exã¡_°©e_©omic
(prealloc);

1175 i‡(!
¥óŒoc
)

1176 
£¨ch_agaö
;

1177 
îr
 = 
	`•lô_°©e
(
åì
, 
°©e
, 
¥óŒoc
, 
íd
 + 1);

1178 i‡(
îr
)

1179 
	`exã¡_io_åì_∑nic
(
åì
, 
îr
);

1181 
	`£t_°©e_bôs
(
åì
, 
¥óŒoc
, 
bôs
, 
ch™ge£t
);

1182 
	`ˇche_°©e
(
¥óŒoc
, 
ˇched_°©e
);

1183 
	`mîge_°©e
(
åì
, 
¥óŒoc
);

1184 
¥óŒoc
 = 
NULL
;

1185 
out
;

1188 
£¨ch_agaö
:

1189 i‡(
°¨t
 > 
íd
)

1190 
out
;

1191 
	`•ö_u∆ock
(&
åì
->
lock
);

1192 i‡(
	`gÂÊags_Ælow_blockög
(
mask
))

1193 
	`c⁄d_ªsched
();

1194 
agaö
;

1196 
out
:

1197 
	`•ö_u∆ock
(&
åì
->
lock
);

1198 i‡(
¥óŒoc
)

1199 
	`‰ì_exã¡_°©e
(
¥óŒoc
);

1201  
îr
;

1203 
	}
}

1205 
	$£t_exã¡_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

1206 
u32
 
bôs
, 
exã¡_°©e
 **
ˇched_°©e
)

1208  
	`__£t_exã¡_bô
(
åì
, 
°¨t
, 
íd
, 
bôs
, 
NULL
, NULL,

1209 
ˇched_°©e
, 
NULL
);

1210 
	}
}

1230 
	$c⁄vît_exã¡_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

1231 
u32
 
bôs
, u32 
˛ór_bôs
,

1232 
exã¡_°©e
 **
ˇched_°©e
)

1234 
exã¡_°©e
 *
°©e
;

1235 
exã¡_°©e
 *
¥óŒoc
 = 
NULL
;

1236 
rb_node
 **
p
 = 
NULL
;

1237 
rb_node
 *
∑ª¡
 = 
NULL
;

1238 
îr
 = 0;

1239 
u64
 
œ°_°¨t
;

1240 
u64
 
œ°_íd
;

1241 
boﬁ
 
fú°_ôî©i⁄
 = 
åue
;

1243 
	`båfs_debug_check_exã¡_io_ønge
(
åì
, 
°¨t
, 
íd
);

1244 
	`åa˚_båfs_c⁄vît_exã¡_bô
(
åì
, 
°¨t
, 
íd
 - sèπ + 1, 
bôs
,

1245 
˛ór_bôs
);

1247 
agaö
:

1248 i‡(!
¥óŒoc
) {

1256 
¥óŒoc
 = 
	`Æloc_exã¡_°©e
(
GFP_NOFS
);

1257 i‡(!
¥óŒoc
 && !
fú°_ôî©i⁄
)

1258  -
ENOMEM
;

1261 
	`•ö_lock
(&
åì
->
lock
);

1262 i‡(
ˇched_°©e
 && *cached_state) {

1263 
°©e
 = *
ˇched_°©e
;

1264 i‡(
°©e
->
°¨t
 <°¨à&& sèã->
íd
 > start &&

1265 
	`exã¡_°©e_ö_åì
(
°©e
))

1266 
hô_√xt
;

1273 
°©e
 = 
	`åì_£¨ch_f‹_ö£π
(
åì
, 
°¨t
, &
p
, &
∑ª¡
);

1274 i‡(!
°©e
) {

1275 
¥óŒoc
 = 
	`Æloc_exã¡_°©e_©omic
(prealloc);

1276 i‡(!
¥óŒoc
) {

1277 
îr
 = -
ENOMEM
;

1278 
out
;

1280 
¥óŒoc
->
°¨t
 = start;

1281 
¥óŒoc
->
íd
 =Énd;

1282 
	`ö£π_°©e_Á°
(
åì
, 
¥óŒoc
, 
p
, 
∑ª¡
, 
bôs
, 
NULL
);

1283 
	`ˇche_°©e
(
¥óŒoc
, 
ˇched_°©e
);

1284 
¥óŒoc
 = 
NULL
;

1285 
out
;

1287 
hô_√xt
:

1288 
œ°_°¨t
 = 
°©e
->
°¨t
;

1289 
œ°_íd
 = 
°©e
->
íd
;

1297 i‡(
°©e
->
°¨t
 =°¨à&& sèã->
íd
 <=Énd) {

1298 
	`£t_°©e_bôs
(
åì
, 
°©e
, 
bôs
, 
NULL
);

1299 
	`ˇche_°©e
(
°©e
, 
ˇched_°©e
);

1300 
°©e
 = 
	`˛ór_°©e_bô
(
åì
, sèã, 
˛ór_bôs
, 0, 
NULL
);

1301 i‡(
œ°_íd
 =(
u64
)-1)

1302 
out
;

1303 
°¨t
 = 
œ°_íd
 + 1;

1304 i‡(
°¨t
 < 
íd
 && 
°©e
 && state->start == start &&

1305 !
	`√ed_ªsched
())

1306 
hô_√xt
;

1307 
£¨ch_agaö
;

1325 i‡(
°©e
->
°¨t
 < start) {

1326 
¥óŒoc
 = 
	`Æloc_exã¡_°©e_©omic
(prealloc);

1327 i‡(!
¥óŒoc
) {

1328 
îr
 = -
ENOMEM
;

1329 
out
;

1331 
îr
 = 
	`•lô_°©e
(
åì
, 
°©e
, 
¥óŒoc
, 
°¨t
);

1332 i‡(
îr
)

1333 
	`exã¡_io_åì_∑nic
(
åì
, 
îr
);

1334 
¥óŒoc
 = 
NULL
;

1335 i‡(
îr
)

1336 
out
;

1337 i‡(
°©e
->
íd
 <=Énd) {

1338 
	`£t_°©e_bôs
(
åì
, 
°©e
, 
bôs
, 
NULL
);

1339 
	`ˇche_°©e
(
°©e
, 
ˇched_°©e
);

1340 
°©e
 = 
	`˛ór_°©e_bô
(
åì
, sèã, 
˛ór_bôs
, 0, 
NULL
);

1341 i‡(
œ°_íd
 =(
u64
)-1)

1342 
out
;

1343 
°¨t
 = 
œ°_íd
 + 1;

1344 i‡(
°¨t
 < 
íd
 && 
°©e
 && state->start == start &&

1345 !
	`√ed_ªsched
())

1346 
hô_√xt
;

1348 
£¨ch_agaö
;

1357 i‡(
°©e
->
°¨t
 > start) {

1358 
u64
 
this_íd
;

1359 i‡(
íd
 < 
œ°_°¨t
)

1360 
this_íd
 = 
íd
;

1362 
this_íd
 = 
œ°_°¨t
 - 1;

1364 
¥óŒoc
 = 
	`Æloc_exã¡_°©e_©omic
(prealloc);

1365 i‡(!
¥óŒoc
) {

1366 
îr
 = -
ENOMEM
;

1367 
out
;

1374 
¥óŒoc
->
°¨t
 = start;

1375 
¥óŒoc
->
íd
 = 
this_íd
;

1376 
îr
 = 
	`ö£π_°©e
(
åì
, 
¥óŒoc
, 
bôs
, 
NULL
);

1377 i‡(
îr
)

1378 
	`exã¡_io_åì_∑nic
(
åì
, 
îr
);

1379 
	`ˇche_°©e
(
¥óŒoc
, 
ˇched_°©e
);

1380 
¥óŒoc
 = 
NULL
;

1381 
°¨t
 = 
this_íd
 + 1;

1382 
£¨ch_agaö
;

1390 i‡(
°©e
->
°¨t
 <
íd
 && state->end >Énd) {

1391 
¥óŒoc
 = 
	`Æloc_exã¡_°©e_©omic
(prealloc);

1392 i‡(!
¥óŒoc
) {

1393 
îr
 = -
ENOMEM
;

1394 
out
;

1397 
îr
 = 
	`•lô_°©e
(
åì
, 
°©e
, 
¥óŒoc
, 
íd
 + 1);

1398 i‡(
îr
)

1399 
	`exã¡_io_åì_∑nic
(
åì
, 
îr
);

1401 
	`£t_°©e_bôs
(
åì
, 
¥óŒoc
, 
bôs
, 
NULL
);

1402 
	`ˇche_°©e
(
¥óŒoc
, 
ˇched_°©e
);

1403 
	`˛ór_°©e_bô
(
åì
, 
¥óŒoc
, 
˛ór_bôs
, 0, 
NULL
);

1404 
¥óŒoc
 = 
NULL
;

1405 
out
;

1408 
£¨ch_agaö
:

1409 i‡(
°¨t
 > 
íd
)

1410 
out
;

1411 
	`•ö_u∆ock
(&
åì
->
lock
);

1412 
	`c⁄d_ªsched
();

1413 
fú°_ôî©i⁄
 = 
Ál£
;

1414 
agaö
;

1416 
out
:

1417 
	`•ö_u∆ock
(&
åì
->
lock
);

1418 i‡(
¥óŒoc
)

1419 
	`‰ì_exã¡_°©e
(
¥óŒoc
);

1421  
îr
;

1422 
	}
}

1439 
	$föd_fú°_˛ór_exã¡_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
,

1440 
u64
 *
°¨t_ªt
, u64 *
íd_ªt
, 
u32
 
bôs
)

1442 
exã¡_°©e
 *
°©e
;

1443 
exã¡_°©e
 *
¥ev
 = 
NULL
, *
√xt
 = NULL;

1445 
	`•ö_lock
(&
åì
->
lock
);

1449 
°©e
 = 
	`åì_£¨ch_¥ev_√xt
(
åì
, 
°¨t
, &
¥ev
, &
√xt
);

1450 i‡(!
°©e
 && !
√xt
 && !
¥ev
) {

1455 *
°¨t_ªt
 = 0;

1456 *
íd_ªt
 = -1;

1457 
out
;

1458 } i‡(!
°©e
 && !
√xt
) {

1463 *
°¨t_ªt
 = 
¥ev
->
íd
 + 1;

1464 *
íd_ªt
 = -1;

1465 
out
;

1466 } i‡(!
°©e
) {

1467 
°©e
 = 
√xt
;

1474 i‡(
	`ö_ønge
(
°¨t
, 
°©e
->°¨t, sèã->
íd
 - state->start + 1)) {

1475 i‡(
°©e
->°©ê& 
bôs
) {

1481 
°¨t
 = 
°©e
->
íd
 + 1;

1492 *
°¨t_ªt
 = 
°©e
->
°¨t
;

1507 i‡(
¥ev
)

1508 *
°¨t_ªt
 = 
¥ev
->
íd
 + 1;

1510 *
°¨t_ªt
 = 0;

1519 
°©e
) {

1520 i‡(
°©e
->
íd
 >
°¨t
 && !(°©e->°©ê& 
bôs
)) {

1521 *
íd_ªt
 = 
°©e
->
íd
;

1523 *
íd_ªt
 = 
°©e
->
°¨t
 - 1;

1526 
°©e
 = 
	`√xt_°©e
(state);

1528 
out
:

1529 
	`•ö_u∆ock
(&
åì
->
lock
);

1530 
	}
}

1557 
u64
 
	$cou¡_ønge_bôs
(
exã¡_io_åì
 *
åì
,

1558 
u64
 *
°¨t
, u64 
£¨ch_íd
, u64 
max_byãs
,

1559 
u32
 
bôs
, 
c⁄tig
,

1560 
exã¡_°©e
 **
ˇched_°©e
)

1562 
exã¡_°©e
 *
°©e
 = 
NULL
;

1563 
exã¡_°©e
 *
ˇched
;

1564 
u64
 
cur_°¨t
 = *
°¨t
;

1565 
u64
 
tŸÆ_byãs
 = 0;

1566 
u64
 
œ°
 = 0;

1567 
found
 = 0;

1569 i‡(
	`WARN_ON
(
£¨ch_íd
 < 
cur_°¨t
))

1572 
	`•ö_lock
(&
åì
->
lock
);

1574 i‡(!
ˇched_°©e
 || !*cached_state)

1575 
£¨ch
;

1577 
ˇched
 = *
ˇched_°©e
;

1579 i‡(!
	`exã¡_°©e_ö_åì
(
ˇched
))

1580 
£¨ch
;

1582 i‡(
ˇched
->
°¨t
 <
cur_°¨t
 && cur_°¨à<ˇched->
íd
) {

1583 
°©e
 = 
ˇched
;

1584 } i‡(
ˇched
->
°¨t
 > 
cur_°¨t
) {

1585 
exã¡_°©e
 *
¥ev
;

1594 
¥ev
 = 
	`¥ev_°©e
(
ˇched
);

1595 i‡(!
¥ev
)

1596 
°©e
 = 
ˇched
;

1597 i‡(
¥ev
->
°¨t
 <
cur_°¨t
 && cur_°¨à<¥ev->
íd
)

1598 
°©e
 = 
¥ev
;

1605 
£¨ch
:

1606 i‡(!
°©e
)

1607 
°©e
 = 
	`åì_£¨ch
(
åì
, 
cur_°¨t
);

1609 
°©e
) {

1610 i‡(
°©e
->
°¨t
 > 
£¨ch_íd
)

1612 i‡(
c⁄tig
 && 
found
 && 
°©e
->
°¨t
 > 
œ°
 + 1)

1614 i‡(
°©e
->
íd
 >
cur_°¨t
 && (°©e->°©ê& 
bôs
) == bits) {

1615 
tŸÆ_byãs
 +
	`mö
(
£¨ch_íd
, 
°©e
->
íd
) + 1 -

1616 
	`max
(
cur_°¨t
, 
°©e
->
°¨t
);

1617 i‡(
tŸÆ_byãs
 >
max_byãs
)

1619 i‡(!
found
) {

1620 *
°¨t
 = 
	`max
(
cur_°¨t
, 
°©e
->start);

1621 
found
 = 1;

1623 
œ°
 = 
°©e
->
íd
;

1624 } i‡(
c⁄tig
 && 
found
) {

1627 
°©e
 = 
	`√xt_°©e
(state);

1630 i‡(
ˇched_°©e
) {

1631 
	`‰ì_exã¡_°©e
(*
ˇched_°©e
);

1632 *
ˇched_°©e
 = 
°©e
;

1633 i‡(
°©e
)

1634 
	`ªfcou¡_öc
(&
°©e
->
ªfs
);

1637 
	`•ö_u∆ock
(&
åì
->
lock
);

1639  
tŸÆ_byãs
;

1640 
	}
}

1647 
	$ã°_ønge_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

1648 
u32
 
bôs
, 
fûÀd
, 
exã¡_°©e
 *
ˇched
)

1650 
exã¡_°©e
 *
°©e
 = 
NULL
;

1651 
bô£t
 = 0;

1653 
	`•ö_lock
(&
åì
->
lock
);

1654 i‡(
ˇched
 && 
	`exã¡_°©e_ö_åì
(ˇchedË&& cached->
°¨t
 <= start &&

1655 
ˇched
->
íd
 > 
°¨t
)

1656 
°©e
 = 
ˇched
;

1658 
°©e
 = 
	`åì_£¨ch
(
åì
, 
°¨t
);

1659 
°©e
 && 
°¨t
 <
íd
) {

1660 i‡(
fûÀd
 && 
°©e
->
°¨t
 > start) {

1661 
bô£t
 = 0;

1665 i‡(
°©e
->
°¨t
 > 
íd
)

1668 i‡(
°©e
->°©ê& 
bôs
) {

1669 
bô£t
 = 1;

1670 i‡(!
fûÀd
)

1672 } i‡(
fûÀd
) {

1673 
bô£t
 = 0;

1677 i‡(
°©e
->
íd
 =(
u64
)-1)

1680 
°¨t
 = 
°©e
->
íd
 + 1;

1681 i‡(
°¨t
 > 
íd
)

1683 
°©e
 = 
	`√xt_°©e
(state);

1687 i‡(
fûÀd
 && !
°©e
)

1688 
bô£t
 = 0;

1689 
	`•ö_u∆ock
(&
åì
->
lock
);

1690  
bô£t
;

1691 
	}
}

1694 
	$£t_ªc‹d_exã¡_bôs
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

1695 
u32
 
bôs
, 
exã¡_ch™ge£t
 *
ch™ge£t
)

1703 
	`ASSERT
(!(
bôs
 & 
EXTENT_LOCKED
));

1705  
	`__£t_exã¡_bô
(
åì
, 
°¨t
, 
íd
, 
bôs
, 
NULL
, NULL, NULL, 
ch™ge£t
);

1706 
	}
}

1708 
	$˛ór_ªc‹d_exã¡_bôs
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

1709 
u32
 
bôs
, 
exã¡_ch™ge£t
 *
ch™ge£t
)

1715 
	`ASSERT
(!(
bôs
 & 
EXTENT_LOCKED
));

1717  
	`__˛ór_exã¡_bô
(
åì
, 
°¨t
, 
íd
, 
bôs
, 
NULL
, 
ch™ge£t
);

1718 
	}
}

1720 
	$åy_lock_exã¡
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

1721 
exã¡_°©e
 **
ˇched
)

1723 
îr
;

1724 
u64
 
Áûed_°¨t
;

1726 
îr
 = 
	`__£t_exã¡_bô
(
åì
, 
°¨t
, 
íd
, 
EXTENT_LOCKED
, &
Áûed_°¨t
,

1727 
NULL
, 
ˇched
, NULL);

1728 i‡(
îr
 =-
EEXIST
) {

1729 i‡(
Áûed_°¨t
 > 
°¨t
)

1730 
	`˛ór_exã¡_bô
(
åì
, 
°¨t
, 
Áûed_°¨t
 - 1,

1731 
EXTENT_LOCKED
, 
ˇched
);

1735 
	}
}

1741 
	$lock_exã¡
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

1742 
exã¡_°©e
 **
ˇched_°©e
)

1744 
exã¡_°©e
 *
Áûed_°©e
 = 
NULL
;

1745 
îr
;

1746 
u64
 
Áûed_°¨t
;

1748 
îr
 = 
	`__£t_exã¡_bô
(
åì
, 
°¨t
, 
íd
, 
EXTENT_LOCKED
, &
Áûed_°¨t
,

1749 &
Áûed_°©e
, 
ˇched_°©e
, 
NULL
);

1750 
îr
 =-
EEXIST
) {

1751 i‡(
Áûed_°¨t
 !
°¨t
)

1752 
	`˛ór_exã¡_bô
(
åì
, 
°¨t
, 
Áûed_°¨t
 - 1,

1753 
EXTENT_LOCKED
, 
ˇched_°©e
);

1755 
	`waô_exã¡_bô
(
åì
, 
Áûed_°¨t
, 
íd
, 
EXTENT_LOCKED
,

1756 &
Áûed_°©e
);

1757 
îr
 = 
	`__£t_exã¡_bô
(
åì
, 
°¨t
, 
íd
, 
EXTENT_LOCKED
,

1758 &
Áûed_°¨t
, &
Áûed_°©e
,

1759 
ˇched_°©e
, 
NULL
);

1761  
îr
;

1762 
	}
}

1764 
__cﬁd
 
	$exã¡_°©e_‰ì_ˇchï
()

1766 
	`båfs_exã¡_°©e_Àak_debug_check
();

1767 
	`kmem_ˇche_de°roy
(
exã¡_°©e_ˇche
);

1768 
	}
}

1770 
__öô
 
	$exã¡_°©e_öô_ˇchï
()

1772 
exã¡_°©e_ˇche
 = 
	`kmem_ˇche_¸óã
("btrfs_extent_state",

1773 (
exã¡_°©e
), 0,

1774 
SLAB_MEM_SPREAD
, 
NULL
);

1775 i‡(!
exã¡_°©e_ˇche
)

1776  -
ENOMEM
;

1779 
	}
}

	@extent-io-tree.h

3 #i‚de‡
BTRFS_EXTENT_IO_TREE_H


4 
	#BTRFS_EXTENT_IO_TREE_H


	)

6 
	~"misc.h
"

8 
	gexã¡_ch™ge£t
;

12 
ENUM_BIT
(
EXTENT_DIRTY
),

13 
ENUM_BIT
(
EXTENT_UPTODATE
),

14 
ENUM_BIT
(
EXTENT_LOCKED
),

15 
ENUM_BIT
(
EXTENT_NEW
),

16 
ENUM_BIT
(
EXTENT_DELALLOC
),

17 
ENUM_BIT
(
EXTENT_DEFRAG
),

18 
ENUM_BIT
(
EXTENT_BOUNDARY
),

19 
ENUM_BIT
(
EXTENT_NODATASUM
),

20 
ENUM_BIT
(
EXTENT_CLEAR_META_RESV
),

21 
ENUM_BIT
(
EXTENT_NEED_WAIT
),

22 
ENUM_BIT
(
EXTENT_NORESERVE
),

23 
ENUM_BIT
(
EXTENT_QGROUP_RESERVED
),

24 
ENUM_BIT
(
EXTENT_CLEAR_DATA_RESV
),

32 
ENUM_BIT
(
EXTENT_DELALLOC_NEW
),

40 
ENUM_BIT
(
EXTENT_ADD_INODE_BYTES
),

45 
ENUM_BIT
(
EXTENT_CLEAR_ALL_BITS
),

54 
ENUM_BIT
(
EXTENT_NOWAIT
)

57 
	#EXTENT_DO_ACCOUNTING
 (
EXTENT_CLEAR_META_RESV
 | \

58 
EXTENT_CLEAR_DATA_RESV
)

	)

59 
	#EXTENT_CTLBITS
 (
EXTENT_DO_ACCOUNTING
 | \

60 
EXTENT_ADD_INODE_BYTES
 | \

61 
EXTENT_CLEAR_ALL_BITS
)

	)

69 
	#CHUNK_ALLOCATED
 
EXTENT_DIRTY


	)

70 
	#CHUNK_TRIMMED
 
EXTENT_DEFRAG


	)

71 
	#CHUNK_STATE_MASK
 (
CHUNK_ALLOCATED
 | \

72 
CHUNK_TRIMMED
)

	)

75 
	mIO_TREE_FS_PINNED_EXTENTS
,

76 
	mIO_TREE_FS_EXCLUDED_EXTENTS
,

77 
	mIO_TREE_BTREE_INODE_IO
,

78 
	mIO_TREE_INODE_IO
,

79 
	mIO_TREE_RELOC_BLOCKS
,

80 
	mIO_TREE_TRANS_DIRTY_PAGES
,

81 
	mIO_TREE_ROOT_DIRTY_LOG_PAGES
,

82 
	mIO_TREE_INODE_FILE_EXTENT
,

83 
	mIO_TREE_LOG_CSUM_RANGE
,

84 
	mIO_TREE_SELFTEST
,

85 
	mIO_TREE_DEVICE_ALLOC_STATE
,

88 
	sexã¡_io_åì
 {

89 
rb_roŸ
 
	m°©e
;

90 
båfs_fs_öfo
 *
	mfs_öfo
;

92 
båfs_öode
 *
	möode
;

95 
u8
 
	mow√r
;

97 
•ölock_t
 
	mlock
;

100 
	sexã¡_°©e
 {

101 
u64
 
	m°¨t
;

102 
u64
 
	míd
;

103 
rb_node
 
	mrb_node
;

106 
waô_queue_hód_t
 
	mwq
;

107 
ªfcou¡_t
 
	mªfs
;

108 
u32
 
	m°©e
;

110 #ifde‡
CONFIG_BTRFS_DEBUG


111 
li°_hód
 
	mÀak_li°
;

115 
exã¡_io_åì_öô
(
båfs_fs_öfo
 *
fs_öfo
,

116 
exã¡_io_åì
 *
åì
, 
ow√r
);

117 
exã¡_io_åì_ªÀa£
(
exã¡_io_åì
 *
åì
);

119 
lock_exã¡
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

120 
exã¡_°©e
 **
ˇched
);

122 
åy_lock_exã¡
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

123 
exã¡_°©e
 **
ˇched
);

125 
__öô
 
exã¡_°©e_öô_ˇchï
();

126 
__cﬁd
 
exã¡_°©e_‰ì_ˇchï
();

128 
u64
 
cou¡_ønge_bôs
(
exã¡_io_åì
 *
åì
,

129 
u64
 *
°¨t
, u64 
£¨ch_íd
,

130 
u64
 
max_byãs
, 
u32
 
bôs
, 
c⁄tig
,

131 
exã¡_°©e
 **
ˇched_°©e
);

133 
‰ì_exã¡_°©e
(
exã¡_°©e
 *
°©e
);

134 
ã°_ønge_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

135 
u32
 
bôs
, 
fûÀd
, 
exã¡_°©e
 *
ˇched_°©e
);

136 
˛ór_ªc‹d_exã¡_bôs
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

137 
u32
 
bôs
, 
exã¡_ch™ge£t
 *
ch™ge£t
);

138 
__˛ór_exã¡_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

139 
u32
 
bôs
, 
exã¡_°©e
 **
ˇched
,

140 
exã¡_ch™ge£t
 *
ch™ge£t
);

142 
ölöe
 
	$˛ór_exã¡_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
,

143 
u64
 
íd
, 
u32
 
bôs
,

144 
exã¡_°©e
 **
ˇched
)

146  
	`__˛ór_exã¡_bô
(
åì
, 
°¨t
, 
íd
, 
bôs
, 
ˇched
, 
NULL
);

147 
	}
}

149 
ölöe
 
	$u∆ock_exã¡
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

150 
exã¡_°©e
 **
ˇched
)

152  
	`__˛ór_exã¡_bô
(
åì
, 
°¨t
, 
íd
, 
EXTENT_LOCKED
, 
ˇched
, 
NULL
);

153 
	}
}

155 
ölöe
 
	$˛ór_exã¡_bôs
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
,

156 
u64
 
íd
, 
u32
 
bôs
)

158  
	`˛ór_exã¡_bô
(
åì
, 
°¨t
, 
íd
, 
bôs
, 
NULL
);

159 
	}
}

161 
£t_ªc‹d_exã¡_bôs
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

162 
u32
 
bôs
, 
exã¡_ch™ge£t
 *
ch™ge£t
);

163 
£t_exã¡_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

164 
u32
 
bôs
, 
exã¡_°©e
 **
ˇched_°©e
);

166 
ölöe
 
	$˛ór_exã¡_u±od©e
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
,

167 
u64
 
íd
, 
exã¡_°©e
 **
ˇched_°©e
)

169  
	`__˛ór_exã¡_bô
(
åì
, 
°¨t
, 
íd
, 
EXTENT_UPTODATE
,

170 
ˇched_°©e
, 
NULL
);

171 
	}
}

173 
ölöe
 
	$˛ór_exã¡_dúty
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
,

174 
u64
 
íd
, 
exã¡_°©e
 **
ˇched
)

176  
	`˛ór_exã¡_bô
(
åì
, 
°¨t
, 
íd
,

177 
EXTENT_DIRTY
 | 
EXTENT_DELALLOC
 |

178 
EXTENT_DO_ACCOUNTING
, 
ˇched
);

179 
	}
}

181 
c⁄vît_exã¡_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
,

182 
u32
 
bôs
, u32 
˛ór_bôs
,

183 
exã¡_°©e
 **
ˇched_°©e
);

185 
boﬁ
 
föd_fú°_exã¡_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
,

186 
u64
 *
°¨t_ªt
, u64 *
íd_ªt
, 
u32
 
bôs
,

187 
exã¡_°©e
 **
ˇched_°©e
);

188 
föd_fú°_˛ór_exã¡_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
,

189 
u64
 *
°¨t_ªt
, u64 *
íd_ªt
, 
u32
 
bôs
);

190 
föd_c⁄tiguous_exã¡_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
,

191 
u64
 *
°¨t_ªt
, u64 *
íd_ªt
, 
u32
 
bôs
);

192 
boﬁ
 
båfs_föd_dñÆloc_ønge
(
exã¡_io_åì
 *
åì
, 
u64
 *
°¨t
,

193 
u64
 *
íd
, u64 
max_byãs
,

194 
exã¡_°©e
 **
ˇched_°©e
);

195 
waô_exã¡_bô
(
exã¡_io_åì
 *
åì
, 
u64
 
°¨t
, u64 
íd
, 
u32
 
bôs
,

196 
exã¡_°©e
 **
ˇched_°©e
);

	@extent-tree.c

6 
	~<löux/sched.h
>

7 
	~<löux/sched/sig«l.h
>

8 
	~<löux/∑gem≠.h
>

9 
	~<löux/wrôeback.h
>

10 
	~<löux/blkdev.h
>

11 
	~<löux/s‹t.h
>

12 
	~<löux/rcupd©e.h
>

13 
	~<löux/kthªad.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/øãlimô.h
>

16 
	~<löux/≥r˝u_cou¡î.h
>

17 
	~<löux/lockdï.h
>

18 
	~<löux/¸c32c.h
>

19 
	~"˘ªe.h
"

20 
	~"exã¡-åì.h
"

21 
	~"åì-log.h
"

22 
	~"disk-io.h
"

23 
	~"¥öt-åì.h
"

24 
	~"vﬁumes.h
"

25 
	~"øid56.h
"

26 
	~"lockög.h
"

27 
	~"‰ì-•a˚-ˇche.h
"

28 
	~"‰ì-•a˚-åì.h
"

29 
	~"sysfs.h
"

30 
	~"qgroup.h
"

31 
	~"ªf-vîify.h
"

32 
	~"•a˚-öfo.h
"

33 
	~"block-rsv.h
"

34 
	~"dñÆloc-•a˚.h
"

35 
	~"disˇrd.h
"

36 
	~"rcu-°rög.h
"

37 
	~"z⁄ed.h
"

38 
	~"dev-ª∂a˚.h
"

39 
	~"fs.h
"

40 
	~"ac˚ss‹s.h
"

41 
	~"roŸ-åì.h
"

42 
	~"fûe-ôem.h
"

43 
	~"‹ph™.h
"

44 
	~"åì-checkî.h
"

46 #unde‡
SCRAMBLE_DELAYED_REFS


49 
__båfs_‰ì_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

50 
båfs_dñayed_ªf_node
 *
node
, 
u64
 
∑ª¡
,

51 
u64
 
roŸ_obje˘id
, u64 
ow√r_obje˘id
,

52 
u64
 
ow√r_off£t
, 
ªfs_to_dr›
,

53 
båfs_dñayed_exã¡_›
 *
exåa_›
);

54 
__run_dñayed_exã¡_›
(
båfs_dñayed_exã¡_›
 *
exã¡_›
,

55 
exã¡_buf„r
 *
Àaf
,

56 
båfs_exã¡_ôem
 *
ei
);

57 
Æloc_ª£rved_fûe_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

58 
u64
 
∑ª¡
, u64 
roŸ_obje˘id
,

59 
u64
 
Êags
, u64 
ow√r
, u64 
off£t
,

60 
båfs_key
 *
ös
, 
ªf_mod
);

61 
Æloc_ª£rved_åì_block
(
båfs_å™s_h™dÀ
 *
å™s
,

62 
båfs_dñayed_ªf_node
 *
node
,

63 
båfs_dñayed_exã¡_›
 *
exã¡_›
);

64 
föd_√xt_key
(
båfs_∑th
 *
∑th
, 
Àvñ
,

65 
båfs_key
 *
key
);

67 
	$block_group_bôs
(
båfs_block_group
 *
ˇche
, 
u64
 
bôs
)

69  (
ˇche
->
Êags
 & 
bôs
) == bits;

70 
	}
}

73 
	$båfs_lookup_d©a_exã¡
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
°¨t
, u64 
Àn
)

75 
båfs_roŸ
 *
roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
, 
°¨t
);

76 
ªt
;

77 
båfs_key
 
key
;

78 
båfs_∑th
 *
∑th
;

80 
∑th
 = 
	`båfs_Æloc_∑th
();

81 i‡(!
∑th
)

82  -
ENOMEM
;

84 
key
.
obje˘id
 = 
°¨t
;

85 
key
.
off£t
 = 
Àn
;

86 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

87 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

88 
	`båfs_‰ì_∑th
(
∑th
);

89  
ªt
;

90 
	}
}

101 
	$båfs_lookup_exã¡_öfo
(
båfs_å™s_h™dÀ
 *
å™s
,

102 
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
byãƒ
,

103 
u64
 
off£t
, 
mëad©a
, u64 *
ªfs
, u64 *
Êags
)

105 
båfs_roŸ
 *
exã¡_roŸ
;

106 
båfs_dñayed_ªf_hód
 *
hód
;

107 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
;

108 
båfs_∑th
 *
∑th
;

109 
båfs_exã¡_ôem
 *
ei
;

110 
exã¡_buf„r
 *
Àaf
;

111 
båfs_key
 
key
;

112 
u32
 
ôem_size
;

113 
u64
 
num_ªfs
;

114 
u64
 
exã¡_Êags
;

115 
ªt
;

121 i‡(
mëad©a
 && !
	`båfs_fs_öcom∑t
(
fs_öfo
, 
SKINNY_METADATA
)) {

122 
off£t
 = 
fs_öfo
->
nodesize
;

123 
mëad©a
 = 0;

126 
∑th
 = 
	`båfs_Æloc_∑th
();

127 i‡(!
∑th
)

128  -
ENOMEM
;

130 i‡(!
å™s
) {

131 
∑th
->
skù_lockög
 = 1;

132 
∑th
->
£¨ch_commô_roŸ
 = 1;

135 
£¨ch_agaö
:

136 
key
.
obje˘id
 = 
byãƒ
;

137 
key
.
off£t
 = offset;

138 i‡(
mëad©a
)

139 
key
.
ty≥
 = 
BTRFS_METADATA_ITEM_KEY
;

141 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

143 
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
, 
byãƒ
);

144 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
exã¡_roŸ
, &
key
, 
∑th
, 0, 0);

145 i‡(
ªt
 < 0)

146 
out_‰ì
;

148 i‡(
ªt
 > 0 && 
mëad©a
 && 
key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
) {

149 i‡(
∑th
->
¶Ÿs
[0]) {

150 
∑th
->
¶Ÿs
[0]--;

151 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,

152 
∑th
->
¶Ÿs
[0]);

153 i‡(
key
.
obje˘id
 =
byãƒ
 &&

154 
key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 &&

155 
key
.
off£t
 =
fs_öfo
->
nodesize
)

156 
ªt
 = 0;

160 i‡(
ªt
 == 0) {

161 
Àaf
 = 
∑th
->
nodes
[0];

162 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

163 i‡(
ôem_size
 >(*
ei
)) {

164 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

165 
båfs_exã¡_ôem
);

166 
num_ªfs
 = 
	`båfs_exã¡_ªfs
(
Àaf
, 
ei
);

167 
exã¡_Êags
 = 
	`båfs_exã¡_Êags
(
Àaf
, 
ei
);

169 
ªt
 = -
EUCLEAN
;

170 
	`båfs_îr
(
fs_öfo
,

172 
ôem_size
, (*
ei
));

173 i‡(
å™s
)

174 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

176 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
ªt
, 
NULL
);

178 
out_‰ì
;

181 
	`BUG_ON
(
num_ªfs
 == 0);

183 
num_ªfs
 = 0;

184 
exã¡_Êags
 = 0;

185 
ªt
 = 0;

188 i‡(!
å™s
)

189 
out
;

191 
dñayed_ªfs
 = &
å™s
->
å™ß˘i⁄
->delayed_refs;

192 
	`•ö_lock
(&
dñayed_ªfs
->
lock
);

193 
hód
 = 
	`båfs_föd_dñayed_ªf_hód
(
dñayed_ªfs
, 
byãƒ
);

194 i‡(
hód
) {

195 i‡(!
	`muãx_åylock
(&
hód
->
muãx
)) {

196 
	`ªfcou¡_öc
(&
hód
->
ªfs
);

197 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

199 
	`båfs_ªÀa£_∑th
(
∑th
);

205 
	`muãx_lock
(&
hód
->
muãx
);

206 
	`muãx_u∆ock
(&
hód
->
muãx
);

207 
	`båfs_put_dñayed_ªf_hód
(
hód
);

208 
£¨ch_agaö
;

210 
	`•ö_lock
(&
hód
->
lock
);

211 i‡(
hód
->
exã¡_›
 && hód->exã¡_›->
upd©e_Êags
)

212 
exã¡_Êags
 |
hód
->
exã¡_›
->
Êags_to_£t
;

214 
	`BUG_ON
(
num_ªfs
 == 0);

216 
num_ªfs
 +
hód
->
ªf_mod
;

217 
	`•ö_u∆ock
(&
hód
->
lock
);

218 
	`muãx_u∆ock
(&
hód
->
muãx
);

220 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

221 
out
:

222 
	`WARN_ON
(
num_ªfs
 == 0);

223 i‡(
ªfs
)

224 *
ªfs
 = 
num_ªfs
;

225 i‡(
Êags
)

226 *
Êags
 = 
exã¡_Êags
;

227 
out_‰ì
:

228 
	`båfs_‰ì_∑th
(
∑th
);

229  
ªt
;

230 
	}
}

343 
	$båfs_gë_exã¡_ölöe_ªf_ty≥
(c⁄° 
exã¡_buf„r
 *
eb
,

344 
båfs_exã¡_ölöe_ªf
 *
úef
,

345 
båfs_ölöe_ªf_ty≥
 
is_d©a
)

347 
ty≥
 = 
	`båfs_exã¡_ölöe_ªf_ty≥
(
eb
, 
úef
);

348 
u64
 
off£t
 = 
	`båfs_exã¡_ölöe_ªf_off£t
(
eb
, 
úef
);

350 i‡(
ty≥
 =
BTRFS_TREE_BLOCK_REF_KEY
 ||

351 
ty≥
 =
BTRFS_SHARED_BLOCK_REF_KEY
 ||

352 
ty≥
 =
BTRFS_SHARED_DATA_REF_KEY
 ||

353 
ty≥
 =
BTRFS_EXTENT_DATA_REF_KEY
) {

354 i‡(
is_d©a
 =
BTRFS_REF_TYPE_BLOCK
) {

355 i‡(
ty≥
 =
BTRFS_TREE_BLOCK_REF_KEY
)

356  
ty≥
;

357 i‡(
ty≥
 =
BTRFS_SHARED_BLOCK_REF_KEY
) {

358 
	`ASSERT
(
eb
->
fs_öfo
);

363 i‡(
off£t
 &&

364 
	`IS_ALIGNED
(
off£t
, 
eb
->
fs_öfo
->
£˘‹size
))

365  
ty≥
;

367 } i‡(
is_d©a
 =
BTRFS_REF_TYPE_DATA
) {

368 i‡(
ty≥
 =
BTRFS_EXTENT_DATA_REF_KEY
)

369  
ty≥
;

370 i‡(
ty≥
 =
BTRFS_SHARED_DATA_REF_KEY
) {

371 
	`ASSERT
(
eb
->
fs_öfo
);

376 i‡(
off£t
 &&

377 
	`IS_ALIGNED
(
off£t
, 
eb
->
fs_öfo
->
£˘‹size
))

378  
ty≥
;

381 
	`ASSERT
(
is_d©a
 =
BTRFS_REF_TYPE_ANY
);

382  
ty≥
;

386 
	`WARN_ON
(1);

387 
	`båfs_¥öt_Àaf
(
eb
);

388 
	`båfs_îr
(
eb
->
fs_öfo
,

390 
eb
->
°¨t
, ()
úef
, 
ty≥
);

392  
BTRFS_REF_TYPE_INVALID
;

393 
	}
}

395 
u64
 
	$hash_exã¡_d©a_ªf
(
u64
 
roŸ_obje˘id
, u64 
ow√r
, u64 
off£t
)

397 
u32
 
high_¸c
 = ~(u32)0;

398 
u32
 
low_¸c
 = ~(u32)0;

399 
__À64
 
Ànum
;

401 
Ànum
 = 
	`˝u_to_À64
(
roŸ_obje˘id
);

402 
high_¸c
 = 
	`båfs_¸c32c
(high_¸c, &
Ànum
, (lenum));

403 
Ànum
 = 
	`˝u_to_À64
(
ow√r
);

404 
low_¸c
 = 
	`båfs_¸c32c
÷ow_¸c, &
Ànum
, (lenum));

405 
Ànum
 = 
	`˝u_to_À64
(
off£t
);

406 
low_¸c
 = 
	`båfs_¸c32c
÷ow_¸c, &
Ànum
, (lenum));

408  ((
u64
)
high_¸c
 << 31Ë^ (u64)
low_¸c
;

409 
	}
}

411 
u64
 
	$hash_exã¡_d©a_ªf_ôem
(
exã¡_buf„r
 *
Àaf
,

412 
båfs_exã¡_d©a_ªf
 *
ªf
)

414  
	`hash_exã¡_d©a_ªf
(
	`båfs_exã¡_d©a_ªf_roŸ
(
Àaf
, 
ªf
),

415 
	`båfs_exã¡_d©a_ªf_obje˘id
(
Àaf
, 
ªf
),

416 
	`båfs_exã¡_d©a_ªf_off£t
(
Àaf
, 
ªf
));

417 
	}
}

419 
	$m©ch_exã¡_d©a_ªf
(
exã¡_buf„r
 *
Àaf
,

420 
båfs_exã¡_d©a_ªf
 *
ªf
,

421 
u64
 
roŸ_obje˘id
, u64 
ow√r
, u64 
off£t
)

423 i‡(
	`båfs_exã¡_d©a_ªf_roŸ
(
Àaf
, 
ªf
Ë!
roŸ_obje˘id
 ||

424 
	`båfs_exã¡_d©a_ªf_obje˘id
(
Àaf
, 
ªf
Ë!
ow√r
 ||

425 
	`båfs_exã¡_d©a_ªf_off£t
(
Àaf
, 
ªf
Ë!
off£t
)

428 
	}
}

430 
noölöe
 
	$lookup_exã¡_d©a_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

431 
båfs_∑th
 *
∑th
,

432 
u64
 
byãƒ
, u64 
∑ª¡
,

433 
u64
 
roŸ_obje˘id
,

434 
u64
 
ow√r
, u64 
off£t
)

436 
båfs_roŸ
 *
roŸ
 = 
	`båfs_exã¡_roŸ
(
å™s
->
fs_öfo
, 
byãƒ
);

437 
båfs_key
 
key
;

438 
båfs_exã¡_d©a_ªf
 *
ªf
;

439 
exã¡_buf„r
 *
Àaf
;

440 
u32
 
ƒôems
;

441 
ªt
;

442 
ªcow
;

443 
îr
 = -
ENOENT
;

445 
key
.
obje˘id
 = 
byãƒ
;

446 i‡(
∑ª¡
) {

447 
key
.
ty≥
 = 
BTRFS_SHARED_DATA_REF_KEY
;

448 
key
.
off£t
 = 
∑ª¡
;

450 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_REF_KEY
;

451 
key
.
off£t
 = 
	`hash_exã¡_d©a_ªf
(
roŸ_obje˘id
,

452 
ow√r
, 
off£t
);

454 
agaö
:

455 
ªcow
 = 0;

456 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

457 i‡(
ªt
 < 0) {

458 
îr
 = 
ªt
;

459 
Áû
;

462 i‡(
∑ª¡
) {

463 i‡(!
ªt
)

465 
Áû
;

468 
Àaf
 = 
∑th
->
nodes
[0];

469 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

471 i‡(
∑th
->
¶Ÿs
[0] >
ƒôems
) {

472 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

473 i‡(
ªt
 < 0)

474 
îr
 = 
ªt
;

475 i‡(
ªt
)

476 
Áû
;

478 
Àaf
 = 
∑th
->
nodes
[0];

479 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

480 
ªcow
 = 1;

483 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

484 i‡(
key
.
obje˘id
 !
byãƒ
 ||

485 
key
.
ty≥
 !
BTRFS_EXTENT_DATA_REF_KEY
)

486 
Áû
;

488 
ªf
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

489 
båfs_exã¡_d©a_ªf
);

491 i‡(
	`m©ch_exã¡_d©a_ªf
(
Àaf
, 
ªf
, 
roŸ_obje˘id
,

492 
ow√r
, 
off£t
)) {

493 i‡(
ªcow
) {

494 
	`båfs_ªÀa£_∑th
(
∑th
);

495 
agaö
;

497 
îr
 = 0;

500 
∑th
->
¶Ÿs
[0]++;

502 
Áû
:

503  
îr
;

504 
	}
}

506 
noölöe
 
	$ö£π_exã¡_d©a_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

507 
båfs_∑th
 *
∑th
,

508 
u64
 
byãƒ
, u64 
∑ª¡
,

509 
u64
 
roŸ_obje˘id
, u64 
ow√r
,

510 
u64
 
off£t
, 
ªfs_to_add
)

512 
båfs_roŸ
 *
roŸ
 = 
	`båfs_exã¡_roŸ
(
å™s
->
fs_öfo
, 
byãƒ
);

513 
båfs_key
 
key
;

514 
exã¡_buf„r
 *
Àaf
;

515 
u32
 
size
;

516 
u32
 
num_ªfs
;

517 
ªt
;

519 
key
.
obje˘id
 = 
byãƒ
;

520 i‡(
∑ª¡
) {

521 
key
.
ty≥
 = 
BTRFS_SHARED_DATA_REF_KEY
;

522 
key
.
off£t
 = 
∑ª¡
;

523 
size
 = (
båfs_sh¨ed_d©a_ªf
);

525 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_REF_KEY
;

526 
key
.
off£t
 = 
	`hash_exã¡_d©a_ªf
(
roŸ_obje˘id
,

527 
ow√r
, 
off£t
);

528 
size
 = (
båfs_exã¡_d©a_ªf
);

531 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
, 
size
);

532 i‡(
ªt
 &&Ñë !-
EEXIST
)

533 
Áû
;

535 
Àaf
 = 
∑th
->
nodes
[0];

536 i‡(
∑ª¡
) {

537 
båfs_sh¨ed_d©a_ªf
 *
ªf
;

538 
ªf
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

539 
båfs_sh¨ed_d©a_ªf
);

540 i‡(
ªt
 == 0) {

541 
	`båfs_£t_sh¨ed_d©a_ªf_cou¡
(
Àaf
, 
ªf
, 
ªfs_to_add
);

543 
num_ªfs
 = 
	`båfs_sh¨ed_d©a_ªf_cou¡
(
Àaf
, 
ªf
);

544 
num_ªfs
 +
ªfs_to_add
;

545 
	`båfs_£t_sh¨ed_d©a_ªf_cou¡
(
Àaf
, 
ªf
, 
num_ªfs
);

548 
båfs_exã¡_d©a_ªf
 *
ªf
;

549 
ªt
 =-
EEXIST
) {

550 
ªf
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

551 
båfs_exã¡_d©a_ªf
);

552 i‡(
	`m©ch_exã¡_d©a_ªf
(
Àaf
, 
ªf
, 
roŸ_obje˘id
,

553 
ow√r
, 
off£t
))

555 
	`båfs_ªÀa£_∑th
(
∑th
);

556 
key
.
off£t
++;

557 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
,

558 
size
);

559 i‡(
ªt
 &&Ñë !-
EEXIST
)

560 
Áû
;

562 
Àaf
 = 
∑th
->
nodes
[0];

564 
ªf
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

565 
båfs_exã¡_d©a_ªf
);

566 i‡(
ªt
 == 0) {

567 
	`båfs_£t_exã¡_d©a_ªf_roŸ
(
Àaf
, 
ªf
,

568 
roŸ_obje˘id
);

569 
	`båfs_£t_exã¡_d©a_ªf_obje˘id
(
Àaf
, 
ªf
, 
ow√r
);

570 
	`båfs_£t_exã¡_d©a_ªf_off£t
(
Àaf
, 
ªf
, 
off£t
);

571 
	`båfs_£t_exã¡_d©a_ªf_cou¡
(
Àaf
, 
ªf
, 
ªfs_to_add
);

573 
num_ªfs
 = 
	`båfs_exã¡_d©a_ªf_cou¡
(
Àaf
, 
ªf
);

574 
num_ªfs
 +
ªfs_to_add
;

575 
	`båfs_£t_exã¡_d©a_ªf_cou¡
(
Àaf
, 
ªf
, 
num_ªfs
);

578 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

579 
ªt
 = 0;

580 
Áû
:

581 
	`båfs_ªÀa£_∑th
(
∑th
);

582  
ªt
;

583 
	}
}

585 
noölöe
 
	$ªmove_exã¡_d©a_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

586 
båfs_roŸ
 *
roŸ
,

587 
båfs_∑th
 *
∑th
,

588 
ªfs_to_dr›
)

590 
båfs_key
 
key
;

591 
båfs_exã¡_d©a_ªf
 *
ªf1
 = 
NULL
;

592 
båfs_sh¨ed_d©a_ªf
 *
ªf2
 = 
NULL
;

593 
exã¡_buf„r
 *
Àaf
;

594 
u32
 
num_ªfs
 = 0;

595 
ªt
 = 0;

597 
Àaf
 = 
∑th
->
nodes
[0];

598 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

600 i‡(
key
.
ty≥
 =
BTRFS_EXTENT_DATA_REF_KEY
) {

601 
ªf1
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

602 
båfs_exã¡_d©a_ªf
);

603 
num_ªfs
 = 
	`båfs_exã¡_d©a_ªf_cou¡
(
Àaf
, 
ªf1
);

604 } i‡(
key
.
ty≥
 =
BTRFS_SHARED_DATA_REF_KEY
) {

605 
ªf2
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

606 
båfs_sh¨ed_d©a_ªf
);

607 
num_ªfs
 = 
	`båfs_sh¨ed_d©a_ªf_cou¡
(
Àaf
, 
ªf2
);

609 
	`båfs_îr
(
å™s
->
fs_öfo
,

611 
key
.
obje˘id
, key.
ty≥
, key.
off£t
);

612 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, -
EUCLEAN
);

613  -
EUCLEAN
;

616 
	`BUG_ON
(
num_ªfs
 < 
ªfs_to_dr›
);

617 
num_ªfs
 -
ªfs_to_dr›
;

619 i‡(
num_ªfs
 == 0) {

620 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

622 i‡(
key
.
ty≥
 =
BTRFS_EXTENT_DATA_REF_KEY
)

623 
	`båfs_£t_exã¡_d©a_ªf_cou¡
(
Àaf
, 
ªf1
, 
num_ªfs
);

624 i‡(
key
.
ty≥
 =
BTRFS_SHARED_DATA_REF_KEY
)

625 
	`båfs_£t_sh¨ed_d©a_ªf_cou¡
(
Àaf
, 
ªf2
, 
num_ªfs
);

626 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

628  
ªt
;

629 
	}
}

631 
noölöe
 
u32
 
	$exã¡_d©a_ªf_cou¡
(
båfs_∑th
 *
∑th
,

632 
båfs_exã¡_ölöe_ªf
 *
úef
)

634 
båfs_key
 
key
;

635 
exã¡_buf„r
 *
Àaf
;

636 
båfs_exã¡_d©a_ªf
 *
ªf1
;

637 
båfs_sh¨ed_d©a_ªf
 *
ªf2
;

638 
u32
 
num_ªfs
 = 0;

639 
ty≥
;

641 
Àaf
 = 
∑th
->
nodes
[0];

642 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

644 i‡(
úef
) {

649 
ty≥
 = 
	`båfs_gë_exã¡_ölöe_ªf_ty≥
(
Àaf
, 
úef
, 
BTRFS_REF_TYPE_DATA
);

650 
	`ASSERT
(
ty≥
 !
BTRFS_REF_TYPE_INVALID
);

651 i‡(
ty≥
 =
BTRFS_EXTENT_DATA_REF_KEY
) {

652 
ªf1
 = (
båfs_exã¡_d©a_ªf
 *)(&
úef
->
off£t
);

653 
num_ªfs
 = 
	`båfs_exã¡_d©a_ªf_cou¡
(
Àaf
, 
ªf1
);

655 
ªf2
 = (
båfs_sh¨ed_d©a_ªf
 *)(
úef
 + 1);

656 
num_ªfs
 = 
	`båfs_sh¨ed_d©a_ªf_cou¡
(
Àaf
, 
ªf2
);

658 } i‡(
key
.
ty≥
 =
BTRFS_EXTENT_DATA_REF_KEY
) {

659 
ªf1
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

660 
båfs_exã¡_d©a_ªf
);

661 
num_ªfs
 = 
	`båfs_exã¡_d©a_ªf_cou¡
(
Àaf
, 
ªf1
);

662 } i‡(
key
.
ty≥
 =
BTRFS_SHARED_DATA_REF_KEY
) {

663 
ªf2
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

664 
båfs_sh¨ed_d©a_ªf
);

665 
num_ªfs
 = 
	`båfs_sh¨ed_d©a_ªf_cou¡
(
Àaf
, 
ªf2
);

667 
	`WARN_ON
(1);

669  
num_ªfs
;

670 
	}
}

672 
noölöe
 
	$lookup_åì_block_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

673 
båfs_∑th
 *
∑th
,

674 
u64
 
byãƒ
, u64 
∑ª¡
,

675 
u64
 
roŸ_obje˘id
)

677 
båfs_roŸ
 *
roŸ
 = 
	`båfs_exã¡_roŸ
(
å™s
->
fs_öfo
, 
byãƒ
);

678 
båfs_key
 
key
;

679 
ªt
;

681 
key
.
obje˘id
 = 
byãƒ
;

682 i‡(
∑ª¡
) {

683 
key
.
ty≥
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

684 
key
.
off£t
 = 
∑ª¡
;

686 
key
.
ty≥
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

687 
key
.
off£t
 = 
roŸ_obje˘id
;

690 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

691 i‡(
ªt
 > 0)

692 
ªt
 = -
ENOENT
;

693  
ªt
;

694 
	}
}

696 
noölöe
 
	$ö£π_åì_block_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

697 
båfs_∑th
 *
∑th
,

698 
u64
 
byãƒ
, u64 
∑ª¡
,

699 
u64
 
roŸ_obje˘id
)

701 
båfs_roŸ
 *
roŸ
 = 
	`båfs_exã¡_roŸ
(
å™s
->
fs_öfo
, 
byãƒ
);

702 
båfs_key
 
key
;

703 
ªt
;

705 
key
.
obje˘id
 = 
byãƒ
;

706 i‡(
∑ª¡
) {

707 
key
.
ty≥
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

708 
key
.
off£t
 = 
∑ª¡
;

710 
key
.
ty≥
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

711 
key
.
off£t
 = 
roŸ_obje˘id
;

714 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
, 0);

715 
	`båfs_ªÀa£_∑th
(
∑th
);

716  
ªt
;

717 
	}
}

719 
ölöe
 
	$exã¡_ªf_ty≥
(
u64
 
∑ª¡
, u64 
ow√r
)

721 
ty≥
;

722 i‡(
ow√r
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

723 i‡(
∑ª¡
 > 0)

724 
ty≥
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

726 
ty≥
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

728 i‡(
∑ª¡
 > 0)

729 
ty≥
 = 
BTRFS_SHARED_DATA_REF_KEY
;

731 
ty≥
 = 
BTRFS_EXTENT_DATA_REF_KEY
;

733  
ty≥
;

734 
	}
}

736 
	$föd_√xt_key
(
båfs_∑th
 *
∑th
, 
Àvñ
,

737 
båfs_key
 *
key
)

740 ; 
Àvñ
 < 
BTRFS_MAX_LEVEL
;Üevel++) {

741 i‡(!
∑th
->
nodes
[
Àvñ
])

743 i‡(
∑th
->
¶Ÿs
[
Àvñ
] + 1 >=

744 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[
Àvñ
]))

746 i‡(
Àvñ
 == 0)

747 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[
Àvñ
], 
key
,

748 
∑th
->
¶Ÿs
[
Àvñ
] + 1);

750 
	`båfs_node_key_to_˝u
(
∑th
->
nodes
[
Àvñ
], 
key
,

751 
∑th
->
¶Ÿs
[
Àvñ
] + 1);

755 
	}
}

770 
noölöe_f‹_°ack


771 
	$lookup_ölöe_exã¡_backªf
(
båfs_å™s_h™dÀ
 *
å™s
,

772 
båfs_∑th
 *
∑th
,

773 
båfs_exã¡_ölöe_ªf
 **
ªf_ªt
,

774 
u64
 
byãƒ
, u64 
num_byãs
,

775 
u64
 
∑ª¡
, u64 
roŸ_obje˘id
,

776 
u64
 
ow√r
, u64 
off£t
, 
ö£π
)

778 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

779 
båfs_roŸ
 *
roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
, 
byãƒ
);

780 
båfs_key
 
key
;

781 
exã¡_buf„r
 *
Àaf
;

782 
båfs_exã¡_ôem
 *
ei
;

783 
båfs_exã¡_ölöe_ªf
 *
úef
;

784 
u64
 
Êags
;

785 
u64
 
ôem_size
;

786 
±r
;

787 
íd
;

788 
exåa_size
;

789 
ty≥
;

790 
w™t
;

791 
ªt
;

792 
îr
 = 0;

793 
boﬁ
 
sköny_mëad©a
 = 
	`båfs_fs_öcom∑t
(
fs_öfo
, 
SKINNY_METADATA
);

794 
√eded
;

796 
key
.
obje˘id
 = 
byãƒ
;

797 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

798 
key
.
off£t
 = 
num_byãs
;

800 
w™t
 = 
	`exã¡_ªf_ty≥
(
∑ª¡
, 
ow√r
);

801 i‡(
ö£π
) {

802 
exåa_size
 = 
	`båfs_exã¡_ölöe_ªf_size
(
w™t
);

803 
∑th
->
£¨ch_f‹_exãnsi⁄
 = 1;

804 
∑th
->
kìp_locks
 = 1;

806 
exåa_size
 = -1;

812 i‡(
sköny_mëad©a
 && 
ow√r
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

813 
key
.
ty≥
 = 
BTRFS_METADATA_ITEM_KEY
;

814 
key
.
off£t
 = 
ow√r
;

817 
agaö
:

818 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, 
exåa_size
, 1);

819 i‡(
ªt
 < 0) {

820 
îr
 = 
ªt
;

821 
out
;

828 i‡(
ªt
 > 0 && 
sköny_mëad©a
) {

829 
sköny_mëad©a
 = 
Ál£
;

830 i‡(
∑th
->
¶Ÿs
[0]) {

831 
∑th
->
¶Ÿs
[0]--;

832 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,

833 
∑th
->
¶Ÿs
[0]);

834 i‡(
key
.
obje˘id
 =
byãƒ
 &&

835 
key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 &&

836 
key
.
off£t
 =
num_byãs
)

837 
ªt
 = 0;

839 i‡(
ªt
) {

840 
key
.
obje˘id
 = 
byãƒ
;

841 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

842 
key
.
off£t
 = 
num_byãs
;

843 
	`båfs_ªÀa£_∑th
(
∑th
);

844 
agaö
;

848 i‡(
ªt
 && !
ö£π
) {

849 
îr
 = -
ENOENT
;

850 
out
;

851 } i‡(
	`WARN_ON
(
ªt
)) {

852 
	`båfs_¥öt_Àaf
(
∑th
->
nodes
[0]);

853 
	`båfs_îr
(
fs_öfo
,

855 
byãƒ
, 
num_byãs
, 
∑ª¡
, 
roŸ_obje˘id
, 
ow√r
,

856 
off£t
);

857 
îr
 = -
EIO
;

858 
out
;

861 
Àaf
 = 
∑th
->
nodes
[0];

862 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

863 i‡(
	`u∆ikñy
(
ôem_size
 < (*
ei
))) {

864 
îr
 = -
EUCLEAN
;

865 
	`båfs_îr
(
fs_öfo
,

867 
ôem_size
, (*
ei
));

868 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
îr
);

869 
out
;

872 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_exã¡_ôem
);

873 
Êags
 = 
	`båfs_exã¡_Êags
(
Àaf
, 
ei
);

875 
±r
 = ()(
ei
 + 1);

876 
íd
 = ()
ei
 + 
ôem_size
;

878 i‡(
Êags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
 && !
sköny_mëad©a
) {

879 
±r
 +(
båfs_åì_block_öfo
);

880 
	`BUG_ON
(
±r
 > 
íd
);

883 i‡(
ow√r
 >
BTRFS_FIRST_FREE_OBJECTID
)

884 
√eded
 = 
BTRFS_REF_TYPE_DATA
;

886 
√eded
 = 
BTRFS_REF_TYPE_BLOCK
;

888 
îr
 = -
ENOENT
;

890 i‡(
±r
 >
íd
) {

891 i‡(
±r
 > 
íd
) {

892 
îr
 = -
EUCLEAN
;

893 
	`båfs_¥öt_Àaf
(
∑th
->
nodes
[0]);

894 
	`båfs_¸ô
(
fs_öfo
,

896 
∑th
->
¶Ÿs
[0], 
roŸ_obje˘id
, 
ow√r
, 
off£t
, 
∑ª¡
);

900 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)
±r
;

901 
ty≥
 = 
	`båfs_gë_exã¡_ölöe_ªf_ty≥
(
Àaf
, 
úef
, 
√eded
);

902 i‡(
ty≥
 =
BTRFS_REF_TYPE_INVALID
) {

903 
îr
 = -
EUCLEAN
;

904 
out
;

907 i‡(
w™t
 < 
ty≥
)

909 i‡(
w™t
 > 
ty≥
) {

910 
±r
 +
	`båfs_exã¡_ölöe_ªf_size
(
ty≥
);

914 i‡(
ty≥
 =
BTRFS_EXTENT_DATA_REF_KEY
) {

915 
båfs_exã¡_d©a_ªf
 *
dªf
;

916 
dªf
 = (
båfs_exã¡_d©a_ªf
 *)(&
úef
->
off£t
);

917 i‡(
	`m©ch_exã¡_d©a_ªf
(
Àaf
, 
dªf
, 
roŸ_obje˘id
,

918 
ow√r
, 
off£t
)) {

919 
îr
 = 0;

922 i‡(
	`hash_exã¡_d©a_ªf_ôem
(
Àaf
, 
dªf
) <

923 
	`hash_exã¡_d©a_ªf
(
roŸ_obje˘id
, 
ow√r
, 
off£t
))

926 
u64
 
ªf_off£t
;

927 
ªf_off£t
 = 
	`båfs_exã¡_ölöe_ªf_off£t
(
Àaf
, 
úef
);

928 i‡(
∑ª¡
 > 0) {

929 i‡(
∑ª¡
 =
ªf_off£t
) {

930 
îr
 = 0;

933 i‡(
ªf_off£t
 < 
∑ª¡
)

936 i‡(
roŸ_obje˘id
 =
ªf_off£t
) {

937 
îr
 = 0;

940 i‡(
ªf_off£t
 < 
roŸ_obje˘id
)

944 
±r
 +
	`båfs_exã¡_ölöe_ªf_size
(
ty≥
);

946 i‡(
îr
 =-
ENOENT
 && 
ö£π
) {

947 i‡(
ôem_size
 + 
exåa_size
 >=

948 
	`BTRFS_MAX_EXTENT_ITEM_SIZE
(
roŸ
)) {

949 
îr
 = -
EAGAIN
;

950 
out
;

958 i‡(
	`föd_√xt_key
(
∑th
, 0, &
key
) == 0 &&

959 
key
.
obje˘id
 =
byãƒ
 &&

960 
key
.
ty≥
 < 
BTRFS_BLOCK_GROUP_ITEM_KEY
) {

961 
îr
 = -
EAGAIN
;

962 
out
;

965 *
ªf_ªt
 = (
båfs_exã¡_ölöe_ªf
 *)
±r
;

966 
out
:

967 i‡(
ö£π
) {

968 
∑th
->
kìp_locks
 = 0;

969 
∑th
->
£¨ch_f‹_exãnsi⁄
 = 0;

970 
	`båfs_u∆ock_up_ß„
(
∑th
, 1);

972  
îr
;

973 
	}
}

978 
noölöe_f‹_°ack


979 
	$£tup_ölöe_exã¡_backªf
(
båfs_å™s_h™dÀ
 *
å™s
,

980 
båfs_∑th
 *
∑th
,

981 
båfs_exã¡_ölöe_ªf
 *
úef
,

982 
u64
 
∑ª¡
, u64 
roŸ_obje˘id
,

983 
u64
 
ow√r
, u64 
off£t
, 
ªfs_to_add
,

984 
båfs_dñayed_exã¡_›
 *
exã¡_›
)

986 
exã¡_buf„r
 *
Àaf
;

987 
båfs_exã¡_ôem
 *
ei
;

988 
±r
;

989 
íd
;

990 
ôem_off£t
;

991 
u64
 
ªfs
;

992 
size
;

993 
ty≥
;

995 
Àaf
 = 
∑th
->
nodes
[0];

996 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_exã¡_ôem
);

997 
ôem_off£t
 = ()
úef
 - ()
ei
;

999 
ty≥
 = 
	`exã¡_ªf_ty≥
(
∑ª¡
, 
ow√r
);

1000 
size
 = 
	`båfs_exã¡_ölöe_ªf_size
(
ty≥
);

1002 
	`båfs_exãnd_ôem
(
å™s
, 
∑th
, 
size
);

1004 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_exã¡_ôem
);

1005 
ªfs
 = 
	`båfs_exã¡_ªfs
(
Àaf
, 
ei
);

1006 
ªfs
 +
ªfs_to_add
;

1007 
	`båfs_£t_exã¡_ªfs
(
Àaf
, 
ei
, 
ªfs
);

1008 i‡(
exã¡_›
)

1009 
	`__run_dñayed_exã¡_›
(
exã¡_›
, 
Àaf
, 
ei
);

1011 
±r
 = ()
ei
 + 
ôem_off£t
;

1012 
íd
 = ()
ei
 + 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

1013 i‡(
±r
 < 
íd
 - 
size
)

1014 
	`memmove_exã¡_buf„r
(
Àaf
, 
±r
 + 
size
,Ötr,

1015 
íd
 - 
size
 - 
±r
);

1017 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)
±r
;

1018 
	`båfs_£t_exã¡_ölöe_ªf_ty≥
(
Àaf
, 
úef
, 
ty≥
);

1019 i‡(
ty≥
 =
BTRFS_EXTENT_DATA_REF_KEY
) {

1020 
båfs_exã¡_d©a_ªf
 *
dªf
;

1021 
dªf
 = (
båfs_exã¡_d©a_ªf
 *)(&
úef
->
off£t
);

1022 
	`båfs_£t_exã¡_d©a_ªf_roŸ
(
Àaf
, 
dªf
, 
roŸ_obje˘id
);

1023 
	`båfs_£t_exã¡_d©a_ªf_obje˘id
(
Àaf
, 
dªf
, 
ow√r
);

1024 
	`båfs_£t_exã¡_d©a_ªf_off£t
(
Àaf
, 
dªf
, 
off£t
);

1025 
	`båfs_£t_exã¡_d©a_ªf_cou¡
(
Àaf
, 
dªf
, 
ªfs_to_add
);

1026 } i‡(
ty≥
 =
BTRFS_SHARED_DATA_REF_KEY
) {

1027 
båfs_sh¨ed_d©a_ªf
 *
§ef
;

1028 
§ef
 = (
båfs_sh¨ed_d©a_ªf
 *)(
úef
 + 1);

1029 
	`båfs_£t_sh¨ed_d©a_ªf_cou¡
(
Àaf
, 
§ef
, 
ªfs_to_add
);

1030 
	`båfs_£t_exã¡_ölöe_ªf_off£t
(
Àaf
, 
úef
, 
∑ª¡
);

1031 } i‡(
ty≥
 =
BTRFS_SHARED_BLOCK_REF_KEY
) {

1032 
	`båfs_£t_exã¡_ölöe_ªf_off£t
(
Àaf
, 
úef
, 
∑ª¡
);

1034 
	`båfs_£t_exã¡_ölöe_ªf_off£t
(
Àaf
, 
úef
, 
roŸ_obje˘id
);

1036 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

1037 
	}
}

1039 
	$lookup_exã¡_backªf
(
båfs_å™s_h™dÀ
 *
å™s
,

1040 
båfs_∑th
 *
∑th
,

1041 
båfs_exã¡_ölöe_ªf
 **
ªf_ªt
,

1042 
u64
 
byãƒ
, u64 
num_byãs
, u64 
∑ª¡
,

1043 
u64
 
roŸ_obje˘id
, u64 
ow√r
, u64 
off£t
)

1045 
ªt
;

1047 
ªt
 = 
	`lookup_ölöe_exã¡_backªf
(
å™s
, 
∑th
, 
ªf_ªt
, 
byãƒ
,

1048 
num_byãs
, 
∑ª¡
, 
roŸ_obje˘id
,

1049 
ow√r
, 
off£t
, 0);

1050 i‡(
ªt
 !-
ENOENT
)

1051  
ªt
;

1053 
	`båfs_ªÀa£_∑th
(
∑th
);

1054 *
ªf_ªt
 = 
NULL
;

1056 i‡(
ow√r
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

1057 
ªt
 = 
	`lookup_åì_block_ªf
(
å™s
, 
∑th
, 
byãƒ
, 
∑ª¡
,

1058 
roŸ_obje˘id
);

1060 
ªt
 = 
	`lookup_exã¡_d©a_ªf
(
å™s
, 
∑th
, 
byãƒ
, 
∑ª¡
,

1061 
roŸ_obje˘id
, 
ow√r
, 
off£t
);

1063  
ªt
;

1064 
	}
}

1069 
noölöe_f‹_°ack
 
	$upd©e_ölöe_exã¡_backªf
(

1070 
båfs_å™s_h™dÀ
 *
å™s
,

1071 
båfs_∑th
 *
∑th
,

1072 
båfs_exã¡_ölöe_ªf
 *
úef
,

1073 
ªfs_to_mod
,

1074 
båfs_dñayed_exã¡_›
 *
exã¡_›
)

1076 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

1077 
båfs_fs_öfo
 *
fs_öfo
 = 
Àaf
->fs_info;

1078 
båfs_exã¡_ôem
 *
ei
;

1079 
båfs_exã¡_d©a_ªf
 *
dªf
 = 
NULL
;

1080 
båfs_sh¨ed_d©a_ªf
 *
§ef
 = 
NULL
;

1081 
±r
;

1082 
íd
;

1083 
u32
 
ôem_size
;

1084 
size
;

1085 
ty≥
;

1086 
u64
 
ªfs
;

1088 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_exã¡_ôem
);

1089 
ªfs
 = 
	`båfs_exã¡_ªfs
(
Àaf
, 
ei
);

1090 i‡(
	`u∆ikñy
(
ªfs_to_mod
 < 0 && 
ªfs
 +Ñefs_to_mod <= 0)) {

1091 
båfs_key
 
key
;

1092 
u32
 
exã¡_size
;

1094 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

1095 i‡(
key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
)

1096 
exã¡_size
 = 
fs_öfo
->
nodesize
;

1098 
exã¡_size
 = 
key
.
off£t
;

1099 
	`båfs_¥öt_Àaf
(
Àaf
);

1100 
	`båfs_îr
(
fs_öfo
,

1102 
key
.
obje˘id
, 
exã¡_size
, 
ªfs_to_mod
, 
ªfs
);

1103  -
EUCLEAN
;

1105 
ªfs
 +
ªfs_to_mod
;

1106 
	`båfs_£t_exã¡_ªfs
(
Àaf
, 
ei
, 
ªfs
);

1107 i‡(
exã¡_›
)

1108 
	`__run_dñayed_exã¡_›
(
exã¡_›
, 
Àaf
, 
ei
);

1110 
ty≥
 = 
	`båfs_gë_exã¡_ölöe_ªf_ty≥
(
Àaf
, 
úef
, 
BTRFS_REF_TYPE_ANY
);

1115 i‡(
	`u∆ikñy
(
ty≥
 =
BTRFS_REF_TYPE_INVALID
))

1116  -
EUCLEAN
;

1118 i‡(
ty≥
 =
BTRFS_EXTENT_DATA_REF_KEY
) {

1119 
dªf
 = (
båfs_exã¡_d©a_ªf
 *)(&
úef
->
off£t
);

1120 
ªfs
 = 
	`båfs_exã¡_d©a_ªf_cou¡
(
Àaf
, 
dªf
);

1121 } i‡(
ty≥
 =
BTRFS_SHARED_DATA_REF_KEY
) {

1122 
§ef
 = (
båfs_sh¨ed_d©a_ªf
 *)(
úef
 + 1);

1123 
ªfs
 = 
	`båfs_sh¨ed_d©a_ªf_cou¡
(
Àaf
, 
§ef
);

1125 
ªfs
 = 1;

1134 i‡(
	`u∆ikñy
(
ªfs_to_mod
 != -1)) {

1135 
båfs_key
 
key
;

1137 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

1139 
	`båfs_¥öt_Àaf
(
Àaf
);

1140 
	`båfs_îr
(
fs_öfo
,

1142 
key
.
obje˘id
, 
ªfs_to_mod
);

1143  -
EUCLEAN
;

1147 i‡(
	`u∆ikñy
(
ªfs_to_mod
 < 0 && 
ªfs
 < -refs_to_mod)) {

1148 
båfs_key
 
key
;

1149 
u32
 
exã¡_size
;

1151 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

1152 i‡(
key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
)

1153 
exã¡_size
 = 
fs_öfo
->
nodesize
;

1155 
exã¡_size
 = 
key
.
off£t
;

1156 
	`båfs_¥öt_Àaf
(
Àaf
);

1157 
	`båfs_îr
(
fs_öfo
,

1159 ()
úef
, 
key
.
obje˘id
, 
exã¡_size
,

1160 
ªfs_to_mod
, 
ªfs
);

1161  -
EUCLEAN
;

1163 
ªfs
 +
ªfs_to_mod
;

1165 i‡(
ªfs
 > 0) {

1166 i‡(
ty≥
 =
BTRFS_EXTENT_DATA_REF_KEY
)

1167 
	`båfs_£t_exã¡_d©a_ªf_cou¡
(
Àaf
, 
dªf
, 
ªfs
);

1169 
	`båfs_£t_sh¨ed_d©a_ªf_cou¡
(
Àaf
, 
§ef
, 
ªfs
);

1171 
size
 = 
	`båfs_exã¡_ölöe_ªf_size
(
ty≥
);

1172 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

1173 
±r
 = ()
úef
;

1174 
íd
 = ()
ei
 + 
ôem_size
;

1175 i‡(
±r
 + 
size
 < 
íd
)

1176 
	`memmove_exã¡_buf„r
(
Àaf
, 
±r
,Öå + 
size
,

1177 
íd
 - 
±r
 - 
size
);

1178 
ôem_size
 -
size
;

1179 
	`båfs_åunˇã_ôem
(
å™s
, 
∑th
, 
ôem_size
, 1);

1181 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

1183 
	}
}

1185 
noölöe_f‹_°ack


1186 
	$ö£π_ölöe_exã¡_backªf
(
båfs_å™s_h™dÀ
 *
å™s
,

1187 
båfs_∑th
 *
∑th
,

1188 
u64
 
byãƒ
, u64 
num_byãs
, u64 
∑ª¡
,

1189 
u64
 
roŸ_obje˘id
, u64 
ow√r
,

1190 
u64
 
off£t
, 
ªfs_to_add
,

1191 
båfs_dñayed_exã¡_›
 *
exã¡_›
)

1193 
båfs_exã¡_ölöe_ªf
 *
úef
;

1194 
ªt
;

1196 
ªt
 = 
	`lookup_ölöe_exã¡_backªf
(
å™s
, 
∑th
, &
úef
, 
byãƒ
,

1197 
num_byãs
, 
∑ª¡
, 
roŸ_obje˘id
,

1198 
ow√r
, 
off£t
, 1);

1199 i‡(
ªt
 == 0) {

1204 i‡(
ow√r
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

1205 
	`båfs_¥öt_Àaf
(
∑th
->
nodes
[0]);

1206 
	`båfs_¸ô
(
å™s
->
fs_öfo
,

1208 
byãƒ
, 
num_byãs
, 
roŸ_obje˘id
, 
∑th
->
¶Ÿs
[0]);

1209  -
EUCLEAN
;

1211 
ªt
 = 
	`upd©e_ölöe_exã¡_backªf
(
å™s
, 
∑th
, 
úef
,

1212 
ªfs_to_add
, 
exã¡_›
);

1213 } i‡(
ªt
 =-
ENOENT
) {

1214 
	`£tup_ölöe_exã¡_backªf
(
å™s
, 
∑th
, 
úef
, 
∑ª¡
,

1215 
roŸ_obje˘id
, 
ow√r
, 
off£t
,

1216 
ªfs_to_add
, 
exã¡_›
);

1217 
ªt
 = 0;

1219  
ªt
;

1220 
	}
}

1222 
	$ªmove_exã¡_backªf
(
båfs_å™s_h™dÀ
 *
å™s
,

1223 
båfs_roŸ
 *
roŸ
,

1224 
båfs_∑th
 *
∑th
,

1225 
båfs_exã¡_ölöe_ªf
 *
úef
,

1226 
ªfs_to_dr›
, 
is_d©a
)

1228 
ªt
 = 0;

1230 
	`BUG_ON
(!
is_d©a
 && 
ªfs_to_dr›
 != 1);

1231 i‡(
úef
)

1232 
ªt
 = 
	`upd©e_ölöe_exã¡_backªf
(
å™s
, 
∑th
, 
úef
,

1233 -
ªfs_to_dr›
, 
NULL
);

1234 i‡(
is_d©a
)

1235 
ªt
 = 
	`ªmove_exã¡_d©a_ªf
(
å™s
, 
roŸ
, 
∑th
, 
ªfs_to_dr›
);

1237 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

1238  
ªt
;

1239 
	}
}

1241 
	$båfs_issue_disˇrd
(
block_devi˚
 *
bdev
, 
u64
 
°¨t
, u64 
Àn
,

1242 
u64
 *
disˇrded_byãs
)

1244 
j
, 
ªt
 = 0;

1245 
u64
 
byãs_À·
, 
íd
;

1246 
u64
 
Æig√d_°¨t
 = 
	`ALIGN
(
°¨t
, 1 << 
SECTOR_SHIFT
);

1248 i‡(
	`WARN_ON
(
°¨t
 !
Æig√d_°¨t
)) {

1249 
Àn
 -
Æig√d_°¨t
 - 
°¨t
;

1250 
Àn
 = 
	`round_down
÷í, 1 << 
SECTOR_SHIFT
);

1251 
°¨t
 = 
Æig√d_°¨t
;

1254 *
disˇrded_byãs
 = 0;

1256 i‡(!
Àn
)

1259 
íd
 = 
°¨t
 + 
Àn
;

1260 
byãs_À·
 = 
Àn
;

1263 
j
 = 0; j < 
BTRFS_SUPER_MIRROR_MAX
; j++) {

1264 
u64
 
sb_°¨t
 = 
	`båfs_sb_off£t
(
j
);

1265 
u64
 
sb_íd
 = 
sb_°¨t
 + 
BTRFS_SUPER_INFO_SIZE
;

1266 
u64
 
size
 = 
sb_°¨t
 - 
°¨t
;

1268 i‡(!
	`ö_ønge
(
sb_°¨t
, 
°¨t
, 
byãs_À·
) &&

1269 !
	`ö_ønge
(
sb_íd
, 
°¨t
, 
byãs_À·
) &&

1270 !
	`ö_ønge
(
°¨t
, 
sb_°¨t
, 
BTRFS_SUPER_INFO_SIZE
))

1277 i‡(
sb_°¨t
 <
°¨t
) {

1278 
°¨t
 +
sb_íd
 - start;

1279 i‡(
°¨t
 > 
íd
) {

1280 
byãs_À·
 = 0;

1283 
byãs_À·
 = 
íd
 - 
°¨t
;

1287 i‡(
size
) {

1288 
ªt
 = 
	`blkdev_issue_disˇrd
(
bdev
, 
°¨t
 >> 
SECTOR_SHIFT
,

1289 
size
 >> 
SECTOR_SHIFT
,

1290 
GFP_NOFS
);

1291 i‡(!
ªt
)

1292 *
disˇrded_byãs
 +
size
;

1293 i‡(
ªt
 !-
EOPNOTSUPP
)

1294  
ªt
;

1297 
°¨t
 = 
sb_íd
;

1298 i‡(
°¨t
 > 
íd
) {

1299 
byãs_À·
 = 0;

1302 
byãs_À·
 = 
íd
 - 
°¨t
;

1305 i‡(
byãs_À·
) {

1306 
ªt
 = 
	`blkdev_issue_disˇrd
(
bdev
, 
°¨t
 >> 
SECTOR_SHIFT
,

1307 
byãs_À·
 >> 
SECTOR_SHIFT
,

1308 
GFP_NOFS
);

1309 i‡(!
ªt
)

1310 *
disˇrded_byãs
 +
byãs_À·
;

1312  
ªt
;

1313 
	}
}

1315 
	$do_disˇrd_exã¡
(
båfs_disˇrd_°rùe
 *
°rùe
, 
u64
 *
byãs
)

1317 
båfs_devi˚
 *
dev
 = 
°rùe
->dev;

1318 
båfs_fs_öfo
 *
fs_öfo
 = 
dev
->fs_info;

1319 
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
 = &
fs_öfo
->dev_replace;

1320 
u64
 
phys
 = 
°rùe
->
physiˇl
;

1321 
u64
 
Àn
 = 
°rùe
->
Àngth
;

1322 
u64
 
disˇrded
 = 0;

1323 
ªt
 = 0;

1326 i‡(
	`båfs_ˇn_z⁄e_ª£t
(
dev
, 
phys
, 
Àn
)) {

1327 
u64
 
§c_disc
;

1329 
ªt
 = 
	`båfs_ª£t_devi˚_z⁄e
(
dev
, 
phys
, 
Àn
, &
disˇrded
);

1330 i‡(
ªt
)

1331 
out
;

1333 i‡(!
	`båfs_dev_ª∂a˚_is_⁄goög
(
dev_ª∂a˚
) ||

1334 
dev
 !
dev_ª∂a˚
->
§cdev
)

1335 
out
;

1337 
§c_disc
 = 
disˇrded
;

1340 
ªt
 = 
	`båfs_ª£t_devi˚_z⁄e
(
dev_ª∂a˚
->
tgtdev
, 
phys
, 
Àn
,

1341 &
disˇrded
);

1342 
disˇrded
 +
§c_disc
;

1343 } i‡(
	`bdev_max_disˇrd_£˘‹s
(
°rùe
->
dev
->
bdev
)) {

1344 
ªt
 = 
	`båfs_issue_disˇrd
(
dev
->
bdev
, 
phys
, 
Àn
, &
disˇrded
);

1346 
ªt
 = 0;

1347 *
byãs
 = 0;

1350 
out
:

1351 *
byãs
 = 
disˇrded
;

1352  
ªt
;

1353 
	}
}

1355 
	$båfs_disˇrd_exã¡
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
byãƒ
,

1356 
u64
 
num_byãs
, u64 *
a˘uÆ_byãs
)

1358 
ªt
 = 0;

1359 
u64
 
disˇrded_byãs
 = 0;

1360 
u64
 
íd
 = 
byãƒ
 + 
num_byãs
;

1361 
u64
 
cur
 = 
byãƒ
;

1367 
	`båfs_bio_cou¡î_öc_blocked
(
fs_öfo
);

1368 
cur
 < 
íd
) {

1369 
båfs_disˇrd_°rùe
 *
°rùes
;

1370 
num_°rùes
;

1371 
i
;

1373 
num_byãs
 = 
íd
 - 
cur
;

1374 
°rùes
 = 
	`båfs_m≠_disˇrd
(
fs_öfo
, 
cur
, &
num_byãs
, &
num_°rùes
);

1375 i‡(
	`IS_ERR
(
°rùes
)) {

1376 
ªt
 = 
	`PTR_ERR
(
°rùes
);

1377 i‡(
ªt
 =-
EOPNOTSUPP
)

1378 
ªt
 = 0;

1382 
i
 = 0; i < 
num_°rùes
; i++) {

1383 
båfs_disˇrd_°rùe
 *
°rùe
 = 
°rùes
 + 
i
;

1384 
u64
 
byãs
;

1386 i‡(!
°rùe
->
dev
->
bdev
) {

1387 
	`ASSERT
(
	`båfs_ã°_›t
(
fs_öfo
, 
DEGRADED
));

1391 i‡(!
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
,

1392 &
°rùe
->
dev
->
dev_°©e
))

1395 
ªt
 = 
	`do_disˇrd_exã¡
(
°rùe
, &
byãs
);

1396 i‡(
ªt
) {

1401 i‡(
ªt
 !-
EOPNOTSUPP
)

1403 
ªt
 = 0;

1405 
disˇrded_byãs
 +
byãs
;

1408 
	`k‰ì
(
°rùes
);

1409 i‡(
ªt
)

1411 
cur
 +
num_byãs
;

1413 
	`båfs_bio_cou¡î_dec
(
fs_öfo
);

1414 i‡(
a˘uÆ_byãs
)

1415 *
a˘uÆ_byãs
 = 
disˇrded_byãs
;

1416  
ªt
;

1417 
	}
}

1420 
	$båfs_öc_exã¡_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

1421 
båfs_ªf
 *
gíîic_ªf
)

1423 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1424 
ªt
;

1426 
	`ASSERT
(
gíîic_ªf
->
ty≥
 !
BTRFS_REF_NOT_SET
 &&

1427 
gíîic_ªf
->
a˘i⁄
);

1428 
	`BUG_ON
(
gíîic_ªf
->
ty≥
 =
BTRFS_REF_METADATA
 &&

1429 
gíîic_ªf
->
åì_ªf
.
ownög_roŸ
 =
BTRFS_TREE_LOG_OBJECTID
);

1431 i‡(
gíîic_ªf
->
ty≥
 =
BTRFS_REF_METADATA
)

1432 
ªt
 = 
	`båfs_add_dñayed_åì_ªf
(
å™s
, 
gíîic_ªf
, 
NULL
);

1434 
ªt
 = 
	`båfs_add_dñayed_d©a_ªf
(
å™s
, 
gíîic_ªf
, 0);

1436 
	`båfs_ªf_åì_mod
(
fs_öfo
, 
gíîic_ªf
);

1438  
ªt
;

1439 
	}
}

1478 
	$__båfs_öc_exã¡_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

1479 
båfs_dñayed_ªf_node
 *
node
,

1480 
u64
 
∑ª¡
, u64 
roŸ_obje˘id
,

1481 
u64
 
ow√r
, u64 
off£t
, 
ªfs_to_add
,

1482 
båfs_dñayed_exã¡_›
 *
exã¡_›
)

1484 
båfs_∑th
 *
∑th
;

1485 
exã¡_buf„r
 *
Àaf
;

1486 
båfs_exã¡_ôem
 *
ôem
;

1487 
båfs_key
 
key
;

1488 
u64
 
byãƒ
 = 
node
->bytenr;

1489 
u64
 
num_byãs
 = 
node
->num_bytes;

1490 
u64
 
ªfs
;

1491 
ªt
;

1493 
∑th
 = 
	`båfs_Æloc_∑th
();

1494 i‡(!
∑th
)

1495  -
ENOMEM
;

1498 
ªt
 = 
	`ö£π_ölöe_exã¡_backªf
(
å™s
, 
∑th
, 
byãƒ
, 
num_byãs
,

1499 
∑ª¡
, 
roŸ_obje˘id
, 
ow√r
,

1500 
off£t
, 
ªfs_to_add
, 
exã¡_›
);

1501 i‡((
ªt
 < 0 &&Ñë !-
EAGAIN
) || !ret)

1502 
out
;

1509 
Àaf
 = 
∑th
->
nodes
[0];

1510 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

1511 
ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_exã¡_ôem
);

1512 
ªfs
 = 
	`båfs_exã¡_ªfs
(
Àaf
, 
ôem
);

1513 
	`båfs_£t_exã¡_ªfs
(
Àaf
, 
ôem
, 
ªfs
 + 
ªfs_to_add
);

1514 i‡(
exã¡_›
)

1515 
	`__run_dñayed_exã¡_›
(
exã¡_›
, 
Àaf
, 
ôem
);

1517 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

1518 
	`båfs_ªÀa£_∑th
(
∑th
);

1521 i‡(
ow√r
 < 
BTRFS_FIRST_FREE_OBJECTID
)

1522 
ªt
 = 
	`ö£π_åì_block_ªf
(
å™s
, 
∑th
, 
byãƒ
, 
∑ª¡
,

1523 
roŸ_obje˘id
);

1525 
ªt
 = 
	`ö£π_exã¡_d©a_ªf
(
å™s
, 
∑th
, 
byãƒ
, 
∑ª¡
,

1526 
roŸ_obje˘id
, 
ow√r
, 
off£t
,

1527 
ªfs_to_add
);

1529 i‡(
ªt
)

1530 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1531 
out
:

1532 
	`båfs_‰ì_∑th
(
∑th
);

1533  
ªt
;

1534 
	}
}

1536 
	$run_dñayed_d©a_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

1537 
båfs_dñayed_ªf_node
 *
node
,

1538 
båfs_dñayed_exã¡_›
 *
exã¡_›
,

1539 
boﬁ
 
ö£π_ª£rved
)

1541 
ªt
 = 0;

1542 
båfs_dñayed_d©a_ªf
 *
ªf
;

1543 
båfs_key
 
ös
;

1544 
u64
 
∑ª¡
 = 0;

1545 
u64
 
ªf_roŸ
 = 0;

1546 
u64
 
Êags
 = 0;

1548 
ös
.
obje˘id
 = 
node
->
byãƒ
;

1549 
ös
.
off£t
 = 
node
->
num_byãs
;

1550 
ös
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

1552 
ªf
 = 
	`båfs_dñayed_node_to_d©a_ªf
(
node
);

1553 
	`åa˚_run_dñayed_d©a_ªf
(
å™s
->
fs_öfo
, 
node
, 
ªf
,Çode->
a˘i⁄
);

1555 i‡(
node
->
ty≥
 =
BTRFS_SHARED_DATA_REF_KEY
)

1556 
∑ª¡
 = 
ªf
->parent;

1557 
ªf_roŸ
 = 
ªf
->
roŸ
;

1559 i‡(
node
->
a˘i⁄
 =
BTRFS_ADD_DELAYED_REF
 && 
ö£π_ª£rved
) {

1560 i‡(
exã¡_›
)

1561 
Êags
 |
exã¡_›
->
Êags_to_£t
;

1562 
ªt
 = 
	`Æloc_ª£rved_fûe_exã¡
(
å™s
, 
∑ª¡
, 
ªf_roŸ
,

1563 
Êags
, 
ªf
->
obje˘id
,

1564 
ªf
->
off£t
, &
ös
,

1565 
node
->
ªf_mod
);

1566 } i‡(
node
->
a˘i⁄
 =
BTRFS_ADD_DELAYED_REF
) {

1567 
ªt
 = 
	`__båfs_öc_exã¡_ªf
(
å™s
, 
node
, 
∑ª¡
, 
ªf_roŸ
,

1568 
ªf
->
obje˘id
,Ñef->
off£t
,

1569 
node
->
ªf_mod
, 
exã¡_›
);

1570 } i‡(
node
->
a˘i⁄
 =
BTRFS_DROP_DELAYED_REF
) {

1571 
ªt
 = 
	`__båfs_‰ì_exã¡
(
å™s
, 
node
, 
∑ª¡
,

1572 
ªf_roŸ
, 
ªf
->
obje˘id
,

1573 
ªf
->
off£t
, 
node
->
ªf_mod
,

1574 
exã¡_›
);

1576 
	`BUG
();

1578  
ªt
;

1579 
	}
}

1581 
	$__run_dñayed_exã¡_›
(
båfs_dñayed_exã¡_›
 *
exã¡_›
,

1582 
exã¡_buf„r
 *
Àaf
,

1583 
båfs_exã¡_ôem
 *
ei
)

1585 
u64
 
Êags
 = 
	`båfs_exã¡_Êags
(
Àaf
, 
ei
);

1586 i‡(
exã¡_›
->
upd©e_Êags
) {

1587 
Êags
 |
exã¡_›
->
Êags_to_£t
;

1588 
	`båfs_£t_exã¡_Êags
(
Àaf
, 
ei
, 
Êags
);

1591 i‡(
exã¡_›
->
upd©e_key
) {

1592 
båfs_åì_block_öfo
 *
bi
;

1593 
	`BUG_ON
(!(
Êags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
));

1594 
bi
 = (
båfs_åì_block_öfo
 *)(
ei
 + 1);

1595 
	`båfs_£t_åì_block_key
(
Àaf
, 
bi
, &
exã¡_›
->
key
);

1597 
	}
}

1599 
	$run_dñayed_exã¡_›
(
båfs_å™s_h™dÀ
 *
å™s
,

1600 
båfs_dñayed_ªf_hód
 *
hód
,

1601 
båfs_dñayed_exã¡_›
 *
exã¡_›
)

1603 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1604 
båfs_roŸ
 *
roŸ
;

1605 
båfs_key
 
key
;

1606 
båfs_∑th
 *
∑th
;

1607 
båfs_exã¡_ôem
 *
ei
;

1608 
exã¡_buf„r
 *
Àaf
;

1609 
u32
 
ôem_size
;

1610 
ªt
;

1611 
îr
 = 0;

1612 
mëad©a
 = 1;

1614 i‡(
	`TRANS_ABORTED
(
å™s
))

1617 i‡(!
	`båfs_fs_öcom∑t
(
fs_öfo
, 
SKINNY_METADATA
))

1618 
mëad©a
 = 0;

1620 
∑th
 = 
	`båfs_Æloc_∑th
();

1621 i‡(!
∑th
)

1622  -
ENOMEM
;

1624 
key
.
obje˘id
 = 
hód
->
byãƒ
;

1626 i‡(
mëad©a
) {

1627 
key
.
ty≥
 = 
BTRFS_METADATA_ITEM_KEY
;

1628 
key
.
off£t
 = 
exã¡_›
->
Àvñ
;

1630 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

1631 
key
.
off£t
 = 
hód
->
num_byãs
;

1634 
roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
, 
key
.
obje˘id
);

1635 
agaö
:

1636 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, 0, 1);

1637 i‡(
ªt
 < 0) {

1638 
îr
 = 
ªt
;

1639 
out
;

1641 i‡(
ªt
 > 0) {

1642 i‡(
mëad©a
) {

1643 i‡(
∑th
->
¶Ÿs
[0] > 0) {

1644 
∑th
->
¶Ÿs
[0]--;

1645 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,

1646 
∑th
->
¶Ÿs
[0]);

1647 i‡(
key
.
obje˘id
 =
hód
->
byãƒ
 &&

1648 
key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 &&

1649 
key
.
off£t
 =
hód
->
num_byãs
)

1650 
ªt
 = 0;

1652 i‡(
ªt
 > 0) {

1653 
	`båfs_ªÀa£_∑th
(
∑th
);

1654 
mëad©a
 = 0;

1656 
key
.
obje˘id
 = 
hód
->
byãƒ
;

1657 
key
.
off£t
 = 
hód
->
num_byãs
;

1658 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

1659 
agaö
;

1662 
îr
 = -
EUCLEAN
;

1663 
	`båfs_îr
(
fs_öfo
,

1665 
hód
->
byãƒ
, hód->
num_byãs
, 
exã¡_›
->
Àvñ
);

1666 
out
;

1670 
Àaf
 = 
∑th
->
nodes
[0];

1671 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

1673 i‡(
	`u∆ikñy
(
ôem_size
 < (*
ei
))) {

1674 
îr
 = -
EUCLEAN
;

1675 
	`båfs_îr
(
fs_öfo
,

1677 
ôem_size
, (*
ei
));

1678 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
îr
);

1679 
out
;

1682 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_exã¡_ôem
);

1683 
	`__run_dñayed_exã¡_›
(
exã¡_›
, 
Àaf
, 
ei
);

1685 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

1686 
out
:

1687 
	`båfs_‰ì_∑th
(
∑th
);

1688  
îr
;

1689 
	}
}

1691 
	$run_dñayed_åì_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

1692 
båfs_dñayed_ªf_node
 *
node
,

1693 
båfs_dñayed_exã¡_›
 *
exã¡_›
,

1694 
boﬁ
 
ö£π_ª£rved
)

1696 
ªt
 = 0;

1697 
båfs_dñayed_åì_ªf
 *
ªf
;

1698 
u64
 
∑ª¡
 = 0;

1699 
u64
 
ªf_roŸ
 = 0;

1701 
ªf
 = 
	`båfs_dñayed_node_to_åì_ªf
(
node
);

1702 
	`åa˚_run_dñayed_åì_ªf
(
å™s
->
fs_öfo
, 
node
, 
ªf
,Çode->
a˘i⁄
);

1704 i‡(
node
->
ty≥
 =
BTRFS_SHARED_BLOCK_REF_KEY
)

1705 
∑ª¡
 = 
ªf
->parent;

1706 
ªf_roŸ
 = 
ªf
->
roŸ
;

1708 i‡(
	`u∆ikñy
(
node
->
ªf_mod
 != 1)) {

1709 
	`båfs_îr
(
å™s
->
fs_öfo
,

1711 
node
->
byãƒ
,Çode->
ªf_mod
,Çode->
a˘i⁄
, 
ªf_roŸ
,

1712 
∑ª¡
);

1713  -
EUCLEAN
;

1715 i‡(
node
->
a˘i⁄
 =
BTRFS_ADD_DELAYED_REF
 && 
ö£π_ª£rved
) {

1716 
	`BUG_ON
(!
exã¡_›
 || !exã¡_›->
upd©e_Êags
);

1717 
ªt
 = 
	`Æloc_ª£rved_åì_block
(
å™s
, 
node
, 
exã¡_›
);

1718 } i‡(
node
->
a˘i⁄
 =
BTRFS_ADD_DELAYED_REF
) {

1719 
ªt
 = 
	`__båfs_öc_exã¡_ªf
(
å™s
, 
node
, 
∑ª¡
, 
ªf_roŸ
,

1720 
ªf
->
Àvñ
, 0, 1, 
exã¡_›
);

1721 } i‡(
node
->
a˘i⁄
 =
BTRFS_DROP_DELAYED_REF
) {

1722 
ªt
 = 
	`__båfs_‰ì_exã¡
(
å™s
, 
node
, 
∑ª¡
, 
ªf_roŸ
,

1723 
ªf
->
Àvñ
, 0, 1, 
exã¡_›
);

1725 
	`BUG
();

1727  
ªt
;

1728 
	}
}

1731 
	$run_⁄e_dñayed_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

1732 
båfs_dñayed_ªf_node
 *
node
,

1733 
båfs_dñayed_exã¡_›
 *
exã¡_›
,

1734 
boﬁ
 
ö£π_ª£rved
)

1736 
ªt
 = 0;

1738 i‡(
	`TRANS_ABORTED
(
å™s
)) {

1739 i‡(
ö£π_ª£rved
)

1740 
	`båfs_pö_exã¡
(
å™s
, 
node
->
byãƒ
,Çode->
num_byãs
, 1);

1744 i‡(
node
->
ty≥
 =
BTRFS_TREE_BLOCK_REF_KEY
 ||

1745 
node
->
ty≥
 =
BTRFS_SHARED_BLOCK_REF_KEY
)

1746 
ªt
 = 
	`run_dñayed_åì_ªf
(
å™s
, 
node
, 
exã¡_›
,

1747 
ö£π_ª£rved
);

1748 i‡(
node
->
ty≥
 =
BTRFS_EXTENT_DATA_REF_KEY
 ||

1749 
node
->
ty≥
 =
BTRFS_SHARED_DATA_REF_KEY
)

1750 
ªt
 = 
	`run_dñayed_d©a_ªf
(
å™s
, 
node
, 
exã¡_›
,

1751 
ö£π_ª£rved
);

1753 
	`BUG
();

1754 i‡(
ªt
 && 
ö£π_ª£rved
)

1755 
	`båfs_pö_exã¡
(
å™s
, 
node
->
byãƒ
,Çode->
num_byãs
, 1);

1756 i‡(
ªt
 < 0)

1757 
	`båfs_îr
(
å™s
->
fs_öfo
,

1759 
node
->
byãƒ
,Çode->
num_byãs
,Çode->
ty≥
,

1760 
node
->
a˘i⁄
,Çode->
ªf_mod
, 
ªt
);

1761  
ªt
;

1762 
	}
}

1764 
ölöe
 
båfs_dñayed_ªf_node
 *

1765 
	$£À˘_dñayed_ªf
(
båfs_dñayed_ªf_hód
 *
hód
)

1767 
båfs_dñayed_ªf_node
 *
ªf
;

1769 i‡(
	`RB_EMPTY_ROOT
(&
hód
->
ªf_åì
.
rb_roŸ
))

1770  
NULL
;

1778 i‡(!
	`li°_em±y
(&
hód
->
ªf_add_li°
))

1779  
	`li°_fú°_íåy
(&
hód
->
ªf_add_li°
,

1780 
båfs_dñayed_ªf_node
, 
add_li°
);

1782 
ªf
 = 
	`rb_íåy
(
	`rb_fú°_ˇched
(&
hód
->
ªf_åì
),

1783 
båfs_dñayed_ªf_node
, 
ªf_node
);

1784 
	`ASSERT
(
	`li°_em±y
(&
ªf
->
add_li°
));

1785  
ªf
;

1786 
	}
}

1788 
	$un£À˘_dñayed_ªf_hód
(
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
,

1789 
båfs_dñayed_ªf_hód
 *
hód
)

1791 
	`•ö_lock
(&
dñayed_ªfs
->
lock
);

1792 
hód
->
¥o˚ssög
 = 
Ál£
;

1793 
dñayed_ªfs
->
num_hóds_ªady
++;

1794 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

1795 
	`båfs_dñayed_ªf_u∆ock
(
hód
);

1796 
	}
}

1798 
båfs_dñayed_exã¡_›
 *
	$˛ónup_exã¡_›
(

1799 
båfs_dñayed_ªf_hód
 *
hód
)

1801 
båfs_dñayed_exã¡_›
 *
exã¡_›
 = 
hód
->extent_op;

1803 i‡(!
exã¡_›
)

1804  
NULL
;

1806 i‡(
hód
->
mu°_ö£π_ª£rved
) {

1807 
hód
->
exã¡_›
 = 
NULL
;

1808 
	`båfs_‰ì_dñayed_exã¡_›
(
exã¡_›
);

1809  
NULL
;

1811  
exã¡_›
;

1812 
	}
}

1814 
	$run_™d_˛ónup_exã¡_›
(
båfs_å™s_h™dÀ
 *
å™s
,

1815 
båfs_dñayed_ªf_hód
 *
hód
)

1817 
båfs_dñayed_exã¡_›
 *
exã¡_›
;

1818 
ªt
;

1820 
exã¡_›
 = 
	`˛ónup_exã¡_›
(
hód
);

1821 i‡(!
exã¡_›
)

1823 
hód
->
exã¡_›
 = 
NULL
;

1824 
	`•ö_u∆ock
(&
hód
->
lock
);

1825 
ªt
 = 
	`run_dñayed_exã¡_›
(
å™s
, 
hód
, 
exã¡_›
);

1826 
	`båfs_‰ì_dñayed_exã¡_›
(
exã¡_›
);

1827  
ªt
 ?Ñet : 1;

1828 
	}
}

1830 
	$båfs_˛ónup_ªf_hód_accou¡ög
(
båfs_fs_öfo
 *
fs_öfo
,

1831 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
,

1832 
båfs_dñayed_ªf_hód
 *
hód
)

1834 
ƒ_ôems
 = 1;

1840 i‡(
hód
->
tŸÆ_ªf_mod
 < 0 && hód->
is_d©a
) {

1841 
	`•ö_lock
(&
dñayed_ªfs
->
lock
);

1842 
dñayed_ªfs
->
≥ndög_csums
 -
hód
->
num_byãs
;

1843 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

1844 
ƒ_ôems
 +
	`båfs_csum_byãs_to_Àaves
(
fs_öfo
, 
hód
->
num_byãs
);

1847 
	`båfs_dñayed_ªfs_rsv_ªÀa£
(
fs_öfo
, 
ƒ_ôems
);

1848 
	}
}

1850 
	$˛ónup_ªf_hód
(
båfs_å™s_h™dÀ
 *
å™s
,

1851 
båfs_dñayed_ªf_hód
 *
hód
)

1854 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1855 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
;

1856 
ªt
;

1858 
dñayed_ªfs
 = &
å™s
->
å™ß˘i⁄
->delayed_refs;

1860 
ªt
 = 
	`run_™d_˛ónup_exã¡_›
(
å™s
, 
hód
);

1861 i‡(
ªt
 < 0) {

1862 
	`un£À˘_dñayed_ªf_hód
(
dñayed_ªfs
, 
hód
);

1863 
	`båfs_debug
(
fs_öfo
, "run_dñayed_exã¡_›Ñëu∫ed %d", 
ªt
);

1864  
ªt
;

1865 } i‡(
ªt
) {

1866  
ªt
;

1873 
	`•ö_u∆ock
(&
hód
->
lock
);

1874 
	`•ö_lock
(&
dñayed_ªfs
->
lock
);

1875 
	`•ö_lock
(&
hód
->
lock
);

1876 i‡(!
	`RB_EMPTY_ROOT
(&
hód
->
ªf_åì
.
rb_roŸ
Ë|| hód->
exã¡_›
) {

1877 
	`•ö_u∆ock
(&
hód
->
lock
);

1878 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

1881 
	`båfs_dñëe_ªf_hód
(
dñayed_ªfs
, 
hód
);

1882 
	`•ö_u∆ock
(&
hód
->
lock
);

1883 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

1885 i‡(
hód
->
mu°_ö£π_ª£rved
) {

1886 
	`båfs_pö_exã¡
(
å™s
, 
hód
->
byãƒ
, hód->
num_byãs
, 1);

1887 i‡(
hód
->
is_d©a
) {

1888 
båfs_roŸ
 *
csum_roŸ
;

1890 
csum_roŸ
 = 
	`båfs_csum_roŸ
(
fs_öfo
, 
hód
->
byãƒ
);

1891 
ªt
 = 
	`båfs_dñ_csums
(
å™s
, 
csum_roŸ
, 
hód
->
byãƒ
,

1892 
hód
->
num_byãs
);

1896 
	`båfs_˛ónup_ªf_hód_accou¡ög
(
fs_öfo
, 
dñayed_ªfs
, 
hód
);

1898 
	`åa˚_run_dñayed_ªf_hód
(
fs_öfo
, 
hód
, 0);

1899 
	`båfs_dñayed_ªf_u∆ock
(
hód
);

1900 
	`båfs_put_dñayed_ªf_hód
(
hód
);

1901  
ªt
;

1902 
	}
}

1904 
båfs_dñayed_ªf_hód
 *
	$båfs_obèö_ªf_hód
(

1905 
båfs_å™s_h™dÀ
 *
å™s
)

1907 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
 =

1908 &
å™s
->
å™ß˘i⁄
->
dñayed_ªfs
;

1909 
båfs_dñayed_ªf_hód
 *
hód
 = 
NULL
;

1910 
ªt
;

1912 
	`•ö_lock
(&
dñayed_ªfs
->
lock
);

1913 
hód
 = 
	`båfs_£À˘_ªf_hód
(
dñayed_ªfs
);

1914 i‡(!
hód
) {

1915 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

1916  
hód
;

1923 
ªt
 = 
	`båfs_dñayed_ªf_lock
(
dñayed_ªfs
, 
hód
);

1924 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

1931 i‡(
ªt
 =-
EAGAIN
)

1932 
hód
 = 
	`ERR_PTR
(-
EAGAIN
);

1934  
hód
;

1935 
	}
}

1937 
	$båfs_run_dñayed_ªfs_f‹_hód
(
båfs_å™s_h™dÀ
 *
å™s
,

1938 
båfs_dñayed_ªf_hód
 *
locked_ªf
)

1940 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1941 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
;

1942 
båfs_dñayed_exã¡_›
 *
exã¡_›
;

1943 
båfs_dñayed_ªf_node
 *
ªf
;

1944 
boﬁ
 
mu°_ö£π_ª£rved
;

1945 
ªt
;

1947 
dñayed_ªfs
 = &
å™s
->
å™ß˘i⁄
->delayed_refs;

1949 
	`lockdï_as£π_hñd
(&
locked_ªf
->
muãx
);

1950 
	`lockdï_as£π_hñd
(&
locked_ªf
->
lock
);

1952 (
ªf
 = 
	`£À˘_dñayed_ªf
(
locked_ªf
))) {

1953 i‡(
ªf
->
£q
 &&

1954 
	`båfs_check_dñayed_£q
(
fs_öfo
, 
ªf
->
£q
)) {

1955 
	`•ö_u∆ock
(&
locked_ªf
->
lock
);

1956 
	`un£À˘_dñayed_ªf_hód
(
dñayed_ªfs
, 
locked_ªf
);

1957  -
EAGAIN
;

1960 
	`rb_îa£_ˇched
(&
ªf
->
ªf_node
, &
locked_ªf
->
ªf_åì
);

1961 
	`RB_CLEAR_NODE
(&
ªf
->
ªf_node
);

1962 i‡(!
	`li°_em±y
(&
ªf
->
add_li°
))

1963 
	`li°_dñ
(&
ªf
->
add_li°
);

1968 
ªf
->
a˘i⁄
) {

1969 
BTRFS_ADD_DELAYED_REF
:

1970 
BTRFS_ADD_DELAYED_EXTENT
:

1971 
locked_ªf
->
ªf_mod
 -
ªf
->ref_mod;

1973 
BTRFS_DROP_DELAYED_REF
:

1974 
locked_ªf
->
ªf_mod
 +
ªf
->ref_mod;

1977 
	`WARN_ON
(1);

1979 
	`©omic_dec
(&
dñayed_ªfs
->
num_íåõs
);

1985 
mu°_ö£π_ª£rved
 = 
locked_ªf
->must_insert_reserved;

1986 
locked_ªf
->
mu°_ö£π_ª£rved
 = 
Ál£
;

1988 
exã¡_›
 = 
locked_ªf
->extent_op;

1989 
locked_ªf
->
exã¡_›
 = 
NULL
;

1990 
	`•ö_u∆ock
(&
locked_ªf
->
lock
);

1992 
ªt
 = 
	`run_⁄e_dñayed_ªf
(
å™s
, 
ªf
, 
exã¡_›
,

1993 
mu°_ö£π_ª£rved
);

1995 
	`båfs_‰ì_dñayed_exã¡_›
(
exã¡_›
);

1996 i‡(
ªt
) {

1997 
	`un£À˘_dñayed_ªf_hód
(
dñayed_ªfs
, 
locked_ªf
);

1998 
	`båfs_put_dñayed_ªf
(
ªf
);

1999  
ªt
;

2002 
	`båfs_put_dñayed_ªf
(
ªf
);

2003 
	`c⁄d_ªsched
();

2005 
	`•ö_lock
(&
locked_ªf
->
lock
);

2006 
	`båfs_mîge_dñayed_ªfs
(
fs_öfo
, 
dñayed_ªfs
, 
locked_ªf
);

2010 
	}
}

2016 
noölöe
 
	$__båfs_run_dñayed_ªfs
(
båfs_å™s_h™dÀ
 *
å™s
,

2017 
ƒ
)

2019 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2020 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
;

2021 
båfs_dñayed_ªf_hód
 *
locked_ªf
 = 
NULL
;

2022 
ªt
;

2023 
cou¡
 = 0;

2025 
dñayed_ªfs
 = &
å™s
->
å™ß˘i⁄
->delayed_refs;

2027 i‡(!
locked_ªf
) {

2028 
locked_ªf
 = 
	`båfs_obèö_ªf_hód
(
å™s
);

2029 i‡(
	`IS_ERR_OR_NULL
(
locked_ªf
)) {

2030 i‡(
	`PTR_ERR
(
locked_ªf
Ë=-
EAGAIN
) {

2036 
cou¡
++;

2050 
	`•ö_lock
(&
locked_ªf
->
lock
);

2051 
	`båfs_mîge_dñayed_ªfs
(
fs_öfo
, 
dñayed_ªfs
, 
locked_ªf
);

2053 
ªt
 = 
	`båfs_run_dñayed_ªfs_f‹_hód
(
å™s
, 
locked_ªf
);

2054 i‡(
ªt
 < 0 &&Ñë !-
EAGAIN
) {

2059  
ªt
;

2060 } i‡(!
ªt
) {

2065 
ªt
 = 
	`˛ónup_ªf_hód
(
å™s
, 
locked_ªf
);

2066 i‡(
ªt
 > 0 ) {

2068 
ªt
 = 0;

2070 } i‡(
ªt
) {

2071  
ªt
;

2080 
locked_ªf
 = 
NULL
;

2081 
	`c⁄d_ªsched
();

2082 } (
ƒ
 !-1 && 
cou¡
 <ÇrË|| 
locked_ªf
);

2085 
	}
}

2087 #ifde‡
SCRAMBLE_DELAYED_REFS


2093 
u64
 
	$föd_middÀ
(
rb_roŸ
 *
roŸ
)

2095 
rb_node
 *
n
 = 
roŸ
->rb_node;

2096 
båfs_dñayed_ªf_node
 *
íåy
;

2097 
Æt
 = 1;

2098 
u64
 
middÀ
;

2099 
u64
 
fú°
 = 0, 
œ°
 = 0;

2101 
n
 = 
	`rb_fú°
(
roŸ
);

2102 i‡(
n
) {

2103 
íåy
 = 
	`rb_íåy
(
n
, 
båfs_dñayed_ªf_node
, 
rb_node
);

2104 
fú°
 = 
íåy
->
byãƒ
;

2106 
n
 = 
	`rb_œ°
(
roŸ
);

2107 i‡(
n
) {

2108 
íåy
 = 
	`rb_íåy
(
n
, 
båfs_dñayed_ªf_node
, 
rb_node
);

2109 
œ°
 = 
íåy
->
byãƒ
;

2111 
n
 = 
roŸ
->
rb_node
;

2113 
n
) {

2114 
íåy
 = 
	`rb_íåy
(
n
, 
båfs_dñayed_ªf_node
, 
rb_node
);

2115 
	`WARN_ON
(!
íåy
->
ö_åì
);

2117 
middÀ
 = 
íåy
->
byãƒ
;

2119 i‡(
Æt
)

2120 
n
 =Ç->
rb_À·
;

2122 
n
 =Ç->
rb_right
;

2124 
Æt
 = 1 -ált;

2126  
middÀ
;

2127 
	}
}

2140 
	$båfs_run_dñayed_ªfs
(
båfs_å™s_h™dÀ
 *
å™s
,

2141 
cou¡
)

2143 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2144 
rb_node
 *
node
;

2145 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
;

2146 
båfs_dñayed_ªf_hód
 *
hód
;

2147 
ªt
;

2148 
run_Æl
 = 
cou¡
 == ()-1;

2151 i‡(
	`TRANS_ABORTED
(
å™s
))

2154 i‡(
	`ã°_bô
(
BTRFS_FS_CREATING_FREE_SPACE_TREE
, &
fs_öfo
->
Êags
))

2157 
dñayed_ªfs
 = &
å™s
->
å™ß˘i⁄
->delayed_refs;

2158 i‡(
cou¡
 == 0)

2159 
cou¡
 = 
dñayed_ªfs
->
num_hóds_ªady
;

2161 
agaö
:

2162 #ifde‡
SCRAMBLE_DELAYED_REFS


2163 
dñayed_ªfs
->
run_dñayed_°¨t
 = 
	`föd_middÀ
(&dñayed_ªfs->
roŸ
);

2165 
ªt
 = 
	`__båfs_run_dñayed_ªfs
(
å™s
, 
cou¡
);

2166 i‡(
ªt
 < 0) {

2167 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2168  
ªt
;

2171 i‡(
run_Æl
) {

2172 
	`båfs_¸óã_≥ndög_block_groups
(
å™s
);

2174 
	`•ö_lock
(&
dñayed_ªfs
->
lock
);

2175 
node
 = 
	`rb_fú°_ˇched
(&
dñayed_ªfs
->
hªf_roŸ
);

2176 i‡(!
node
) {

2177 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

2178 
out
;

2180 
hód
 = 
	`rb_íåy
(
node
, 
båfs_dñayed_ªf_hód
,

2181 
hªf_node
);

2182 
	`ªfcou¡_öc
(&
hód
->
ªfs
);

2183 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

2186 
	`muãx_lock
(&
hód
->
muãx
);

2187 
	`muãx_u∆ock
(&
hód
->
muãx
);

2189 
	`båfs_put_dñayed_ªf_hód
(
hód
);

2190 
	`c⁄d_ªsched
();

2191 
agaö
;

2193 
out
:

2195 
	}
}

2197 
	$båfs_£t_disk_exã¡_Êags
(
båfs_å™s_h™dÀ
 *
å™s
,

2198 
exã¡_buf„r
 *
eb
, 
u64
 
Êags
)

2200 
båfs_dñayed_exã¡_›
 *
exã¡_›
;

2201 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
eb
);

2202 
ªt
;

2204 
exã¡_›
 = 
	`båfs_Æloc_dñayed_exã¡_›
();

2205 i‡(!
exã¡_›
)

2206  -
ENOMEM
;

2208 
exã¡_›
->
Êags_to_£t
 = 
Êags
;

2209 
exã¡_›
->
upd©e_Êags
 = 
åue
;

2210 
exã¡_›
->
upd©e_key
 = 
Ál£
;

2211 
exã¡_›
->
Àvñ
 =Üevel;

2213 
ªt
 = 
	`båfs_add_dñayed_exã¡_›
(
å™s
, 
eb
->
°¨t
,Éb->
Àn
, 
exã¡_›
);

2214 i‡(
ªt
)

2215 
	`båfs_‰ì_dñayed_exã¡_›
(
exã¡_›
);

2216  
ªt
;

2217 
	}
}

2219 
noölöe
 
	$check_dñayed_ªf
(
båfs_roŸ
 *
roŸ
,

2220 
båfs_∑th
 *
∑th
,

2221 
u64
 
obje˘id
, u64 
off£t
, u64 
byãƒ
)

2223 
båfs_dñayed_ªf_hód
 *
hód
;

2224 
båfs_dñayed_ªf_node
 *
ªf
;

2225 
båfs_dñayed_d©a_ªf
 *
d©a_ªf
;

2226 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
;

2227 
båfs_å™ß˘i⁄
 *
cur_å™s
;

2228 
rb_node
 *
node
;

2229 
ªt
 = 0;

2231 
	`•ö_lock
(&
roŸ
->
fs_öfo
->
å™s_lock
);

2232 
cur_å™s
 = 
roŸ
->
fs_öfo
->
ru¬ög_å™ß˘i⁄
;

2233 i‡(
cur_å™s
)

2234 
	`ªfcou¡_öc
(&
cur_å™s
->
u£_cou¡
);

2235 
	`•ö_u∆ock
(&
roŸ
->
fs_öfo
->
å™s_lock
);

2236 i‡(!
cur_å™s
)

2239 
dñayed_ªfs
 = &
cur_å™s
->delayed_refs;

2240 
	`•ö_lock
(&
dñayed_ªfs
->
lock
);

2241 
hód
 = 
	`båfs_föd_dñayed_ªf_hód
(
dñayed_ªfs
, 
byãƒ
);

2242 i‡(!
hód
) {

2243 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

2244 
	`båfs_put_å™ß˘i⁄
(
cur_å™s
);

2248 i‡(!
	`muãx_åylock
(&
hód
->
muãx
)) {

2249 i‡(
∑th
->
nowaô
) {

2250 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

2251 
	`båfs_put_å™ß˘i⁄
(
cur_å™s
);

2252  -
EAGAIN
;

2255 
	`ªfcou¡_öc
(&
hód
->
ªfs
);

2256 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

2258 
	`båfs_ªÀa£_∑th
(
∑th
);

2264 
	`muãx_lock
(&
hód
->
muãx
);

2265 
	`muãx_u∆ock
(&
hód
->
muãx
);

2266 
	`båfs_put_dñayed_ªf_hód
(
hód
);

2267 
	`båfs_put_å™ß˘i⁄
(
cur_å™s
);

2268  -
EAGAIN
;

2270 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

2272 
	`•ö_lock
(&
hód
->
lock
);

2277 
node
 = 
	`rb_fú°_ˇched
(&
hód
->
ªf_åì
);Çode;

2278 
node
 = 
	`rb_√xt
(node)) {

2279 
ªf
 = 
	`rb_íåy
(
node
, 
båfs_dñayed_ªf_node
, 
ªf_node
);

2281 i‡(
ªf
->
ty≥
 !
BTRFS_EXTENT_DATA_REF_KEY
) {

2282 
ªt
 = 1;

2286 
d©a_ªf
 = 
	`båfs_dñayed_node_to_d©a_ªf
(
ªf
);

2292 i‡(
d©a_ªf
->
roŸ
 !roŸ->
roŸ_key
.
obje˘id
 ||

2293 
d©a_ªf
->
obje˘id
 != objectid ||

2294 
d©a_ªf
->
off£t
 != offset) {

2295 
ªt
 = 1;

2299 
	`•ö_u∆ock
(&
hód
->
lock
);

2300 
	`muãx_u∆ock
(&
hód
->
muãx
);

2301 
	`båfs_put_å™ß˘i⁄
(
cur_å™s
);

2302  
ªt
;

2303 
	}
}

2305 
noölöe
 
	$check_commôãd_ªf
(
båfs_roŸ
 *
roŸ
,

2306 
båfs_∑th
 *
∑th
,

2307 
u64
 
obje˘id
, u64 
off£t
, u64 
byãƒ
,

2308 
boﬁ
 
°ri˘
)

2310 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

2311 
båfs_roŸ
 *
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
, 
byãƒ
);

2312 
exã¡_buf„r
 *
Àaf
;

2313 
båfs_exã¡_d©a_ªf
 *
ªf
;

2314 
båfs_exã¡_ölöe_ªf
 *
úef
;

2315 
båfs_exã¡_ôem
 *
ei
;

2316 
båfs_key
 
key
;

2317 
u32
 
ôem_size
;

2318 
ty≥
;

2319 
ªt
;

2321 
key
.
obje˘id
 = 
byãƒ
;

2322 
key
.
off£t
 = (
u64
)-1;

2323 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

2325 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
exã¡_roŸ
, &
key
, 
∑th
, 0, 0);

2326 i‡(
ªt
 < 0)

2327 
out
;

2328 
	`BUG_ON
(
ªt
 == 0);

2330 
ªt
 = -
ENOENT
;

2331 i‡(
∑th
->
¶Ÿs
[0] == 0)

2332 
out
;

2334 
∑th
->
¶Ÿs
[0]--;

2335 
Àaf
 = 
∑th
->
nodes
[0];

2336 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

2338 i‡(
key
.
obje˘id
 !
byãƒ
 || key.
ty≥
 !
BTRFS_EXTENT_ITEM_KEY
)

2339 
out
;

2341 
ªt
 = 1;

2342 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

2343 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_exã¡_ôem
);

2346 i‡(
ôem_size
 !(*
ei
) +

2347 
	`båfs_exã¡_ölöe_ªf_size
(
BTRFS_EXTENT_DATA_REF_KEY
))

2348 
out
;

2354 i‡(!
°ri˘
 &&

2355 (
	`båfs_exã¡_gíî©i⁄
(
Àaf
, 
ei
) <=

2356 
	`båfs_roŸ_œ°_¢≠shŸ
(&
roŸ
->
roŸ_ôem
)))

2357 
out
;

2359 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)(
ei
 + 1);

2362 
ty≥
 = 
	`båfs_gë_exã¡_ölöe_ªf_ty≥
(
Àaf
, 
úef
, 
BTRFS_REF_TYPE_DATA
);

2363 i‡(
ty≥
 !
BTRFS_EXTENT_DATA_REF_KEY
)

2364 
out
;

2366 
ªf
 = (
båfs_exã¡_d©a_ªf
 *)(&
úef
->
off£t
);

2367 i‡(
	`båfs_exã¡_ªfs
(
Àaf
, 
ei
) !=

2368 
	`båfs_exã¡_d©a_ªf_cou¡
(
Àaf
, 
ªf
) ||

2369 
	`båfs_exã¡_d©a_ªf_roŸ
(
Àaf
, 
ªf
) !=

2370 
roŸ
->
roŸ_key
.
obje˘id
 ||

2371 
	`båfs_exã¡_d©a_ªf_obje˘id
(
Àaf
, 
ªf
Ë!
obje˘id
 ||

2372 
	`båfs_exã¡_d©a_ªf_off£t
(
Àaf
, 
ªf
Ë!
off£t
)

2373 
out
;

2375 
ªt
 = 0;

2376 
out
:

2377  
ªt
;

2378 
	}
}

2380 
	$båfs_¸oss_ªf_exi°
(
båfs_roŸ
 *
roŸ
, 
u64
 
obje˘id
, u64 
off£t
,

2381 
u64
 
byãƒ
, 
boﬁ
 
°ri˘
, 
båfs_∑th
 *
∑th
)

2383 
ªt
;

2386 
ªt
 = 
	`check_commôãd_ªf
(
roŸ
, 
∑th
, 
obje˘id
,

2387 
off£t
, 
byãƒ
, 
°ri˘
);

2388 i‡(
ªt
 &&Ñë !-
ENOENT
)

2389 
out
;

2391 
ªt
 = 
	`check_dñayed_ªf
(
roŸ
, 
∑th
, 
obje˘id
, 
off£t
, 
byãƒ
);

2392 } 
ªt
 =-
EAGAIN
);

2394 
out
:

2395 
	`båfs_ªÀa£_∑th
(
∑th
);

2396 i‡(
	`båfs_is_d©a_ªloc_roŸ
(
roŸ
))

2397 
	`WARN_ON
(
ªt
 > 0);

2398  
ªt
;

2399 
	}
}

2401 
	$__båfs_mod_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

2402 
båfs_roŸ
 *
roŸ
,

2403 
exã¡_buf„r
 *
buf
,

2404 
fuŒ_backªf
, 
öc
)

2406 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

2407 
u64
 
byãƒ
;

2408 
u64
 
num_byãs
;

2409 
u64
 
∑ª¡
;

2410 
u64
 
ªf_roŸ
;

2411 
u32
 
ƒôems
;

2412 
båfs_key
 
key
;

2413 
båfs_fûe_exã¡_ôem
 *
fi
;

2414 
båfs_ªf
 
gíîic_ªf
 = { 0 };

2415 
boﬁ
 
f‹_ªloc
 = 
	`båfs_hódî_Êag
(
buf
, 
BTRFS_HEADER_FLAG_RELOC
);

2416 
i
;

2417 
a˘i⁄
;

2418 
Àvñ
;

2419 
ªt
 = 0;

2421 i‡(
	`båfs_is_ã°ög
(
fs_öfo
))

2424 
ªf_roŸ
 = 
	`båfs_hódî_ow√r
(
buf
);

2425 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
buf
);

2426 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
buf
);

2428 i‡(!
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
Ë&& 
Àvñ
 == 0)

2431 i‡(
fuŒ_backªf
)

2432 
∑ª¡
 = 
buf
->
°¨t
;

2434 
∑ª¡
 = 0;

2435 i‡(
öc
)

2436 
a˘i⁄
 = 
BTRFS_ADD_DELAYED_REF
;

2438 
a˘i⁄
 = 
BTRFS_DROP_DELAYED_REF
;

2440 
i
 = 0; i < 
ƒôems
; i++) {

2441 i‡(
Àvñ
 == 0) {

2442 
	`båfs_ôem_key_to_˝u
(
buf
, &
key
, 
i
);

2443 i‡(
key
.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

2445 
fi
 = 
	`båfs_ôem_±r
(
buf
, 
i
,

2446 
båfs_fûe_exã¡_ôem
);

2447 i‡(
	`båfs_fûe_exã¡_ty≥
(
buf
, 
fi
) ==

2448 
BTRFS_FILE_EXTENT_INLINE
)

2450 
byãƒ
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
buf
, 
fi
);

2451 i‡(
byãƒ
 == 0)

2454 
num_byãs
 = 
	`båfs_fûe_exã¡_disk_num_byãs
(
buf
, 
fi
);

2455 
key
.
off£t
 -
	`båfs_fûe_exã¡_off£t
(
buf
, 
fi
);

2456 
	`båfs_öô_gíîic_ªf
(&
gíîic_ªf
, 
a˘i⁄
, 
byãƒ
,

2457 
num_byãs
, 
∑ª¡
);

2458 
	`båfs_öô_d©a_ªf
(&
gíîic_ªf
, 
ªf_roŸ
, 
key
.
obje˘id
,

2459 
key
.
off£t
, 
roŸ
->
roŸ_key
.
obje˘id
,

2460 
f‹_ªloc
);

2461 i‡(
öc
)

2462 
ªt
 = 
	`båfs_öc_exã¡_ªf
(
å™s
, &
gíîic_ªf
);

2464 
ªt
 = 
	`båfs_‰ì_exã¡
(
å™s
, &
gíîic_ªf
);

2465 i‡(
ªt
)

2466 
Áû
;

2468 
byãƒ
 = 
	`båfs_node_block±r
(
buf
, 
i
);

2469 
num_byãs
 = 
fs_öfo
->
nodesize
;

2470 
	`båfs_öô_gíîic_ªf
(&
gíîic_ªf
, 
a˘i⁄
, 
byãƒ
,

2471 
num_byãs
, 
∑ª¡
);

2472 
	`båfs_öô_åì_ªf
(&
gíîic_ªf
, 
Àvñ
 - 1, 
ªf_roŸ
,

2473 
roŸ
->
roŸ_key
.
obje˘id
, 
f‹_ªloc
);

2474 i‡(
öc
)

2475 
ªt
 = 
	`båfs_öc_exã¡_ªf
(
å™s
, &
gíîic_ªf
);

2477 
ªt
 = 
	`båfs_‰ì_exã¡
(
å™s
, &
gíîic_ªf
);

2478 i‡(
ªt
)

2479 
Áû
;

2483 
Áû
:

2484  
ªt
;

2485 
	}
}

2487 
	$båfs_öc_ªf
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
,

2488 
exã¡_buf„r
 *
buf
, 
fuŒ_backªf
)

2490  
	`__båfs_mod_ªf
(
å™s
, 
roŸ
, 
buf
, 
fuŒ_backªf
, 1);

2491 
	}
}

2493 
	$båfs_dec_ªf
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
,

2494 
exã¡_buf„r
 *
buf
, 
fuŒ_backªf
)

2496  
	`__båfs_mod_ªf
(
å™s
, 
roŸ
, 
buf
, 
fuŒ_backªf
, 0);

2497 
	}
}

2499 
u64
 
	$gë_Æloc_¥ofûe_by_roŸ
(
båfs_roŸ
 *
roŸ
, 
d©a
)

2501 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

2502 
u64
 
Êags
;

2503 
u64
 
ªt
;

2505 i‡(
d©a
)

2506 
Êags
 = 
BTRFS_BLOCK_GROUP_DATA
;

2507 i‡(
roŸ
 =
fs_öfo
->
chunk_roŸ
)

2508 
Êags
 = 
BTRFS_BLOCK_GROUP_SYSTEM
;

2510 
Êags
 = 
BTRFS_BLOCK_GROUP_METADATA
;

2512 
ªt
 = 
	`båfs_gë_Æloc_¥ofûe
(
fs_öfo
, 
Êags
);

2513  
ªt
;

2514 
	}
}

2516 
u64
 
	$fú°_logiˇl_byã
(
båfs_fs_öfo
 *
fs_öfo
)

2518 
rb_node
 *
À·mo°
;

2519 
u64
 
byãƒ
 = 0;

2521 
	`ªad_lock
(&
fs_öfo
->
block_group_ˇche_lock
);

2523 
À·mo°
 = 
	`rb_fú°_ˇched
(&
fs_öfo
->
block_group_ˇche_åì
);

2524 i‡(
À·mo°
) {

2525 
båfs_block_group
 *
bg
;

2527 
bg
 = 
	`rb_íåy
(
À·mo°
, 
båfs_block_group
, 
ˇche_node
);

2528 
byãƒ
 = 
bg
->
°¨t
;

2530 
	`ªad_u∆ock
(&
fs_öfo
->
block_group_ˇche_lock
);

2532  
byãƒ
;

2533 
	}
}

2535 
	$pö_down_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

2536 
båfs_block_group
 *
ˇche
,

2537 
u64
 
byãƒ
, u64 
num_byãs
, 
ª£rved
)

2539 
båfs_fs_öfo
 *
fs_öfo
 = 
ˇche
->fs_info;

2541 
	`•ö_lock
(&
ˇche
->
•a˚_öfo
->
lock
);

2542 
	`•ö_lock
(&
ˇche
->
lock
);

2543 
ˇche
->
pö√d
 +
num_byãs
;

2544 
	`båfs_•a˚_öfo_upd©e_byãs_pö√d
(
fs_öfo
, 
ˇche
->
•a˚_öfo
,

2545 
num_byãs
);

2546 i‡(
ª£rved
) {

2547 
ˇche
->
ª£rved
 -
num_byãs
;

2548 
ˇche
->
•a˚_öfo
->
byãs_ª£rved
 -
num_byãs
;

2550 
	`•ö_u∆ock
(&
ˇche
->
lock
);

2551 
	`•ö_u∆ock
(&
ˇche
->
•a˚_öfo
->
lock
);

2553 
	`£t_exã¡_bô
(&
å™s
->
å™ß˘i⁄
->
pö√d_exã¡s
, 
byãƒ
,

2554 
byãƒ
 + 
num_byãs
 - 1, 
EXTENT_DIRTY
, 
NULL
);

2556 
	}
}

2558 
	$båfs_pö_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

2559 
u64
 
byãƒ
, u64 
num_byãs
, 
ª£rved
)

2561 
båfs_block_group
 *
ˇche
;

2563 
ˇche
 = 
	`båfs_lookup_block_group
(
å™s
->
fs_öfo
, 
byãƒ
);

2564 
	`BUG_ON
(!
ˇche
);

2566 
	`pö_down_exã¡
(
å™s
, 
ˇche
, 
byãƒ
, 
num_byãs
, 
ª£rved
);

2568 
	`båfs_put_block_group
(
ˇche
);

2570 
	}
}

2575 
	$båfs_pö_exã¡_f‹_log_ª∂ay
(
båfs_å™s_h™dÀ
 *
å™s
,

2576 
u64
 
byãƒ
, u64 
num_byãs
)

2578 
båfs_block_group
 *
ˇche
;

2579 
ªt
;

2581 
ˇche
 = 
	`båfs_lookup_block_group
(
å™s
->
fs_öfo
, 
byãƒ
);

2582 i‡(!
ˇche
)

2583  -
EINVAL
;

2589 
ªt
 = 
	`båfs_ˇche_block_group
(
ˇche
, 
åue
);

2590 i‡(
ªt
)

2591 
out
;

2593 
	`pö_down_exã¡
(
å™s
, 
ˇche
, 
byãƒ
, 
num_byãs
, 0);

2596 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
ˇche
, 
byãƒ
, 
num_byãs
);

2597 
out
:

2598 
	`båfs_put_block_group
(
ˇche
);

2599  
ªt
;

2600 
	}
}

2602 
	$__ex˛ude_logged_exã¡
(
båfs_fs_öfo
 *
fs_öfo
,

2603 
u64
 
°¨t
, u64 
num_byãs
)

2605 
ªt
;

2606 
båfs_block_group
 *
block_group
;

2608 
block_group
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
°¨t
);

2609 i‡(!
block_group
)

2610  -
EINVAL
;

2612 
ªt
 = 
	`båfs_ˇche_block_group
(
block_group
, 
åue
);

2613 i‡(
ªt
)

2614 
out
;

2616 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
block_group
, 
°¨t
, 
num_byãs
);

2617 
out
:

2618 
	`båfs_put_block_group
(
block_group
);

2619  
ªt
;

2620 
	}
}

2622 
	$båfs_ex˛ude_logged_exã¡s
(
exã¡_buf„r
 *
eb
)

2624 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

2625 
båfs_fûe_exã¡_ôem
 *
ôem
;

2626 
båfs_key
 
key
;

2627 
found_ty≥
;

2628 
i
;

2629 
ªt
 = 0;

2631 i‡(!
	`båfs_fs_öcom∑t
(
fs_öfo
, 
MIXED_GROUPS
))

2634 
i
 = 0; i < 
	`båfs_hódî_ƒôems
(
eb
); i++) {

2635 
	`båfs_ôem_key_to_˝u
(
eb
, &
key
, 
i
);

2636 i‡(
key
.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

2638 
ôem
 = 
	`båfs_ôem_±r
(
eb
, 
i
, 
båfs_fûe_exã¡_ôem
);

2639 
found_ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
eb
, 
ôem
);

2640 i‡(
found_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
)

2642 i‡(
	`båfs_fûe_exã¡_disk_byãƒ
(
eb
, 
ôem
) == 0)

2644 
key
.
obje˘id
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
eb
, 
ôem
);

2645 
key
.
off£t
 = 
	`båfs_fûe_exã¡_disk_num_byãs
(
eb
, 
ôem
);

2646 
ªt
 = 
	`__ex˛ude_logged_exã¡
(
fs_öfo
, 
key
.
obje˘id
, key.
off£t
);

2647 i‡(
ªt
)

2651  
ªt
;

2652 
	}
}

2655 
	$båfs_öc_block_group_ª£rv©i⁄s
(
båfs_block_group
 *
bg
)

2657 
	`©omic_öc
(&
bg
->
ª£rv©i⁄s
);

2658 
	}
}

2664 
båfs_‰ì_˛u°î
 *

2665 
	$„tch_˛u°î_öfo
(
båfs_fs_öfo
 *
fs_öfo
,

2666 
båfs_•a˚_öfo
 *
•a˚_öfo
, 
u64
 *
em±y_˛u°î
)

2668 
båfs_‰ì_˛u°î
 *
ªt
 = 
NULL
;

2670 *
em±y_˛u°î
 = 0;

2671 i‡(
	`båfs_mixed_•a˚_öfo
(
•a˚_öfo
))

2672  
ªt
;

2674 i‡(
•a˚_öfo
->
Êags
 & 
BTRFS_BLOCK_GROUP_METADATA
) {

2675 
ªt
 = &
fs_öfo
->
mëa_Æloc_˛u°î
;

2676 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
SSD
))

2677 *
em±y_˛u°î
 = 
SZ_2M
;

2679 *
em±y_˛u°î
 = 
SZ_64K
;

2680 } i‡((
•a˚_öfo
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
) &&

2681 
	`båfs_ã°_›t
(
fs_öfo
, 
SSD_SPREAD
)) {

2682 *
em±y_˛u°î
 = 
SZ_2M
;

2683 
ªt
 = &
fs_öfo
->
d©a_Æloc_˛u°î
;

2686  
ªt
;

2687 
	}
}

2689 
	$u≈ö_exã¡_ønge
(
båfs_fs_öfo
 *
fs_öfo
,

2690 
u64
 
°¨t
, u64 
íd
,

2691 c⁄° 
boﬁ
 
ªtu∫_‰ì_•a˚
)

2693 
båfs_block_group
 *
ˇche
 = 
NULL
;

2694 
båfs_•a˚_öfo
 *
•a˚_öfo
;

2695 
båfs_block_rsv
 *
globÆ_rsv
 = &
fs_öfo
->
globÆ_block_rsv
;

2696 
båfs_‰ì_˛u°î
 *
˛u°î
 = 
NULL
;

2697 
u64
 
Àn
;

2698 
u64
 
tŸÆ_u≈ö√d
 = 0;

2699 
u64
 
em±y_˛u°î
 = 0;

2700 
boﬁ
 
ªad⁄ly
;

2702 
°¨t
 <
íd
) {

2703 
ªad⁄ly
 = 
Ál£
;

2704 i‡(!
ˇche
 ||

2705 
°¨t
 >
ˇche
->°¨à+ cache->
Àngth
) {

2706 i‡(
ˇche
)

2707 
	`båfs_put_block_group
(
ˇche
);

2708 
tŸÆ_u≈ö√d
 = 0;

2709 
ˇche
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
°¨t
);

2710 
	`BUG_ON
(!
ˇche
);

2712 
˛u°î
 = 
	`„tch_˛u°î_öfo
(
fs_öfo
,

2713 
ˇche
->
•a˚_öfo
,

2714 &
em±y_˛u°î
);

2715 
em±y_˛u°î
 <<= 1;

2718 
Àn
 = 
ˇche
->
°¨t
 + cache->
Àngth
 - start;

2719 
Àn
 = 
	`mö
÷í, 
íd
 + 1 - 
°¨t
);

2721 i‡(
ªtu∫_‰ì_•a˚
)

2722 
	`båfs_add_‰ì_•a˚
(
ˇche
, 
°¨t
, 
Àn
);

2724 
°¨t
 +
Àn
;

2725 
tŸÆ_u≈ö√d
 +
Àn
;

2726 
•a˚_öfo
 = 
ˇche
->space_info;

2734 i‡(
˛u°î
 && clu°î->
‰agmíãd
 &&

2735 
tŸÆ_u≈ö√d
 > 
em±y_˛u°î
) {

2736 
	`•ö_lock
(&
˛u°î
->
lock
);

2737 
˛u°î
->
‰agmíãd
 = 0;

2738 
	`•ö_u∆ock
(&
˛u°î
->
lock
);

2741 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

2742 
	`•ö_lock
(&
ˇche
->
lock
);

2743 
ˇche
->
pö√d
 -
Àn
;

2744 
	`båfs_•a˚_öfo_upd©e_byãs_pö√d
(
fs_öfo
, 
•a˚_öfo
, -
Àn
);

2745 
•a˚_öfo
->
max_exã¡_size
 = 0;

2746 i‡(
ˇche
->
ro
) {

2747 
•a˚_öfo
->
byãs_ªad⁄ly
 +
Àn
;

2748 
ªad⁄ly
 = 
åue
;

2749 } i‡(
	`båfs_is_z⁄ed
(
fs_öfo
)) {

2751 
•a˚_öfo
->
byãs_z⁄e_unußbÀ
 +
Àn
;

2752 
ªad⁄ly
 = 
åue
;

2754 
	`•ö_u∆ock
(&
ˇche
->
lock
);

2755 i‡(!
ªad⁄ly
 && 
ªtu∫_‰ì_•a˚
 &&

2756 
globÆ_rsv
->
•a˚_öfo
 == space_info) {

2757 
	`•ö_lock
(&
globÆ_rsv
->
lock
);

2758 i‡(!
globÆ_rsv
->
fuŒ
) {

2759 
u64
 
to_add
 = 
	`mö
(
Àn
, 
globÆ_rsv
->
size
 -

2760 
globÆ_rsv
->
ª£rved
);

2762 
globÆ_rsv
->
ª£rved
 +
to_add
;

2763 
	`båfs_•a˚_öfo_upd©e_byãs_may_u£
(
fs_öfo
,

2764 
•a˚_öfo
, 
to_add
);

2765 i‡(
globÆ_rsv
->
ª£rved
 >globÆ_rsv->
size
)

2766 
globÆ_rsv
->
fuŒ
 = 1;

2767 
Àn
 -
to_add
;

2769 
	`•ö_u∆ock
(&
globÆ_rsv
->
lock
);

2772 i‡(!
ªad⁄ly
 && 
ªtu∫_‰ì_•a˚
 && 
Àn
)

2773 
	`båfs_åy_gø¡ög_tickës
(
fs_öfo
, 
•a˚_öfo
);

2774 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

2777 i‡(
ˇche
)

2778 
	`båfs_put_block_group
(
ˇche
);

2780 
	}
}

2782 
	$båfs_föish_exã¡_commô
(
båfs_å™s_h™dÀ
 *
å™s
)

2784 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2785 
båfs_block_group
 *
block_group
, *
tmp
;

2786 
li°_hód
 *
dñëed_bgs
;

2787 
exã¡_io_åì
 *
u≈ö
;

2788 
u64
 
°¨t
;

2789 
u64
 
íd
;

2790 
ªt
;

2792 
u≈ö
 = &
å™s
->
å™ß˘i⁄
->
pö√d_exã¡s
;

2794 !
	`TRANS_ABORTED
(
å™s
)) {

2795 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

2797 
	`muãx_lock
(&
fs_öfo
->
unu£d_bg_u≈ö_muãx
);

2798 i‡(!
	`föd_fú°_exã¡_bô
(
u≈ö
, 0, &
°¨t
, &
íd
,

2799 
EXTENT_DIRTY
, &
ˇched_°©e
)) {

2800 
	`muãx_u∆ock
(&
fs_öfo
->
unu£d_bg_u≈ö_muãx
);

2804 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
DISCARD_SYNC
))

2805 
ªt
 = 
	`båfs_disˇrd_exã¡
(
fs_öfo
, 
°¨t
,

2806 
íd
 + 1 - 
°¨t
, 
NULL
);

2808 
	`˛ór_exã¡_dúty
(
u≈ö
, 
°¨t
, 
íd
, &
ˇched_°©e
);

2809 
	`u≈ö_exã¡_ønge
(
fs_öfo
, 
°¨t
, 
íd
, 
åue
);

2810 
	`muãx_u∆ock
(&
fs_öfo
->
unu£d_bg_u≈ö_muãx
);

2811 
	`‰ì_exã¡_°©e
(
ˇched_°©e
);

2812 
	`c⁄d_ªsched
();

2815 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
DISCARD_ASYNC
)) {

2816 
	`båfs_disˇrd_ˇlc_dñay
(&
fs_öfo
->
disˇrd_˘l
);

2817 
	`båfs_disˇrd_scheduÀ_w‹k
(&
fs_öfo
->
disˇrd_˘l
, 
åue
);

2825 
dñëed_bgs
 = &
å™s
->
å™ß˘i⁄
->deleted_bgs;

2826 
	`li°_f‹_óch_íåy_ß„
(
block_group
, 
tmp
, 
dñëed_bgs
, 
bg_li°
) {

2827 
u64
 
åimmed
 = 0;

2829 
ªt
 = -
EROFS
;

2830 i‡(!
	`TRANS_ABORTED
(
å™s
))

2831 
ªt
 = 
	`båfs_disˇrd_exã¡
(
fs_öfo
,

2832 
block_group
->
°¨t
,

2833 
block_group
->
Àngth
,

2834 &
åimmed
);

2836 
	`li°_dñ_öô
(&
block_group
->
bg_li°
);

2837 
	`båfs_un‰ìze_block_group
(
block_group
);

2838 
	`båfs_put_block_group
(
block_group
);

2840 i‡(
ªt
) {

2841 c⁄° *
îr°r
 = 
	`båfs_decode_îr‹
(
ªt
);

2842 
	`båfs_w¨n
(
fs_öfo
,

2844 
ªt
, 
îr°r
);

2849 
	}
}

2851 
	$do_‰ì_exã¡_accou¡ög
(
båfs_å™s_h™dÀ
 *
å™s
,

2852 
u64
 
byãƒ
, u64 
num_byãs
, 
boﬁ
 
is_d©a
)

2854 
ªt
;

2856 i‡(
is_d©a
) {

2857 
båfs_roŸ
 *
csum_roŸ
;

2859 
csum_roŸ
 = 
	`båfs_csum_roŸ
(
å™s
->
fs_öfo
, 
byãƒ
);

2860 
ªt
 = 
	`båfs_dñ_csums
(
å™s
, 
csum_roŸ
, 
byãƒ
, 
num_byãs
);

2861 i‡(
ªt
) {

2862 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2863  
ªt
;

2867 
ªt
 = 
	`add_to_‰ì_•a˚_åì
(
å™s
, 
byãƒ
, 
num_byãs
);

2868 i‡(
ªt
) {

2869 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2870  
ªt
;

2873 
ªt
 = 
	`båfs_upd©e_block_group
(
å™s
, 
byãƒ
, 
num_byãs
, 
Ál£
);

2874 i‡(
ªt
)

2875 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2877  
ªt
;

2878 
	}
}

2880 
	#ab‹t_™d_dump
(
å™s
, 
∑th
, 
fmt
, 
¨gs
...) \

2882 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, -
EUCLEAN
); \

2883 
	`båfs_¥öt_Àaf
(
∑th
->
nodes
[0]); \

2884 
	`båfs_¸ô
(
å™s
->
fs_öfo
, 
fmt
, ##
¨gs
); \

2885 })

	)

2946 
	$__båfs_‰ì_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

2947 
båfs_dñayed_ªf_node
 *
node
, 
u64
 
∑ª¡
,

2948 
u64
 
roŸ_obje˘id
, u64 
ow√r_obje˘id
,

2949 
u64
 
ow√r_off£t
, 
ªfs_to_dr›
,

2950 
båfs_dñayed_exã¡_›
 *
exã¡_›
)

2952 
båfs_fs_öfo
 *
öfo
 = 
å™s
->
fs_öfo
;

2953 
båfs_key
 
key
;

2954 
båfs_∑th
 *
∑th
;

2955 
båfs_roŸ
 *
exã¡_roŸ
;

2956 
exã¡_buf„r
 *
Àaf
;

2957 
båfs_exã¡_ôem
 *
ei
;

2958 
båfs_exã¡_ölöe_ªf
 *
úef
;

2959 
ªt
;

2960 
is_d©a
;

2961 
exã¡_¶Ÿ
 = 0;

2962 
found_exã¡
 = 0;

2963 
num_to_dñ
 = 1;

2964 
u32
 
ôem_size
;

2965 
u64
 
ªfs
;

2966 
u64
 
byãƒ
 = 
node
->bytenr;

2967 
u64
 
num_byãs
 = 
node
->num_bytes;

2968 
boﬁ
 
sköny_mëad©a
 = 
	`båfs_fs_öcom∑t
(
öfo
, 
SKINNY_METADATA
);

2970 
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
öfo
, 
byãƒ
);

2971 
	`ASSERT
(
exã¡_roŸ
);

2973 
∑th
 = 
	`båfs_Æloc_∑th
();

2974 i‡(!
∑th
)

2975  -
ENOMEM
;

2977 
is_d©a
 = 
ow√r_obje˘id
 >
BTRFS_FIRST_FREE_OBJECTID
;

2979 i‡(!
is_d©a
 && 
ªfs_to_dr›
 != 1) {

2980 
	`båfs_¸ô
(
öfo
,

2982 
node
->
byãƒ
, 
ªfs_to_dr›
);

2983 
ªt
 = -
EINVAL
;

2984 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2985 
out
;

2988 i‡(
is_d©a
)

2989 
sköny_mëad©a
 = 
Ál£
;

2991 
ªt
 = 
	`lookup_exã¡_backªf
(
å™s
, 
∑th
, &
úef
, 
byãƒ
, 
num_byãs
,

2992 
∑ª¡
, 
roŸ_obje˘id
, 
ow√r_obje˘id
,

2993 
ow√r_off£t
);

2994 i‡(
ªt
 == 0) {

3002 
exã¡_¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

3003 
exã¡_¶Ÿ
 >= 0) {

3004 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,

3005 
exã¡_¶Ÿ
);

3006 i‡(
key
.
obje˘id
 !
byãƒ
)

3008 i‡(
key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 &&

3009 
key
.
off£t
 =
num_byãs
) {

3010 
found_exã¡
 = 1;

3013 i‡(
key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
 &&

3014 
key
.
off£t
 =
ow√r_obje˘id
) {

3015 
found_exã¡
 = 1;

3020 i‡(
∑th
->
¶Ÿs
[0] - 
exã¡_¶Ÿ
 > 5)

3022 
exã¡_¶Ÿ
--;

3025 i‡(!
found_exã¡
) {

3026 i‡(
úef
) {

3027 
	`ab‹t_™d_dump
(
å™s
, 
∑th
,

3029 
∑th
->
¶Ÿs
[0]);

3030 
ªt
 = -
EUCLEAN
;

3031 
out
;

3034 
ªt
 = 
	`ªmove_exã¡_backªf
(
å™s
, 
exã¡_roŸ
, 
∑th
,

3035 
NULL
, 
ªfs_to_dr›
, 
is_d©a
);

3036 i‡(
ªt
) {

3037 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3038 
out
;

3040 
	`båfs_ªÀa£_∑th
(
∑th
);

3043 
key
.
obje˘id
 = 
byãƒ
;

3044 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

3045 
key
.
off£t
 = 
num_byãs
;

3047 i‡(!
is_d©a
 && 
sköny_mëad©a
) {

3048 
key
.
ty≥
 = 
BTRFS_METADATA_ITEM_KEY
;

3049 
key
.
off£t
 = 
ow√r_obje˘id
;

3052 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
exã¡_roŸ
,

3053 &
key
, 
∑th
, -1, 1);

3054 i‡(
ªt
 > 0 && 
sköny_mëad©a
 && 
∑th
->
¶Ÿs
[0]) {

3059 
∑th
->
¶Ÿs
[0]--;

3060 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,

3061 
∑th
->
¶Ÿs
[0]);

3062 i‡(
key
.
obje˘id
 =
byãƒ
 &&

3063 
key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 &&

3064 
key
.
off£t
 =
num_byãs
)

3065 
ªt
 = 0;

3068 i‡(
ªt
 > 0 && 
sköny_mëad©a
) {

3069 
sköny_mëad©a
 = 
Ál£
;

3070 
key
.
obje˘id
 = 
byãƒ
;

3071 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

3072 
key
.
off£t
 = 
num_byãs
;

3073 
	`båfs_ªÀa£_∑th
(
∑th
);

3074 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
exã¡_roŸ
,

3075 &
key
, 
∑th
, -1, 1);

3078 i‡(
ªt
) {

3079 i‡(
ªt
 > 0)

3080 
	`båfs_¥öt_Àaf
(
∑th
->
nodes
[0]);

3081 
	`båfs_îr
(
öfo
,

3083 
ªt
, 
byãƒ
, 
∑th
->
¶Ÿs
[0]);

3085 i‡(
ªt
 < 0) {

3086 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3087 
out
;

3089 
exã¡_¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

3091 } i‡(
	`WARN_ON
(
ªt
 =-
ENOENT
)) {

3092 
	`ab‹t_™d_dump
(
å™s
, 
∑th
,

3094 
byãƒ
, 
∑ª¡
, 
roŸ_obje˘id
, 
ow√r_obje˘id
,

3095 
ow√r_off£t
, 
∑th
->
¶Ÿs
[0]);

3096 
out
;

3098 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3099 
out
;

3102 
Àaf
 = 
∑th
->
nodes
[0];

3103 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
exã¡_¶Ÿ
);

3104 i‡(
	`u∆ikñy
(
ôem_size
 < (*
ei
))) {

3105 
ªt
 = -
EUCLEAN
;

3106 
	`båfs_îr
(
å™s
->
fs_öfo
,

3108 
ôem_size
, (*
ei
));

3109 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3110 
out
;

3112 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
exã¡_¶Ÿ
,

3113 
båfs_exã¡_ôem
);

3114 i‡(
ow√r_obje˘id
 < 
BTRFS_FIRST_FREE_OBJECTID
 &&

3115 
key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
) {

3116 
båfs_åì_block_öfo
 *
bi
;

3118 i‡(
ôem_size
 < (*
ei
Ë+ (*
bi
)) {

3119 
	`ab‹t_™d_dump
(
å™s
, 
∑th
,

3121 
key
.
obje˘id
, key.
ty≥
, key.
off£t
,

3122 
∑th
->
¶Ÿs
[0], 
ow√r_obje˘id
, 
ôem_size
,

3123 (*
ei
Ë+ (*
bi
));

3124 
ªt
 = -
EUCLEAN
;

3125 
out
;

3127 
bi
 = (
båfs_åì_block_öfo
 *)(
ei
 + 1);

3128 
	`WARN_ON
(
ow√r_obje˘id
 !
	`båfs_åì_block_Àvñ
(
Àaf
, 
bi
));

3131 
ªfs
 = 
	`båfs_exã¡_ªfs
(
Àaf
, 
ei
);

3132 i‡(
ªfs
 < 
ªfs_to_dr›
) {

3133 
	`ab‹t_™d_dump
(
å™s
, 
∑th
,

3135 
ªfs_to_dr›
, 
ªfs
, 
byãƒ
, 
∑th
->
¶Ÿs
[0]);

3136 
ªt
 = -
EUCLEAN
;

3137 
out
;

3139 
ªfs
 -
ªfs_to_dr›
;

3141 i‡(
ªfs
 > 0) {

3142 i‡(
exã¡_›
)

3143 
	`__run_dñayed_exã¡_›
(
exã¡_›
, 
Àaf
, 
ei
);

3148 i‡(
úef
) {

3149 i‡(!
found_exã¡
) {

3150 
	`ab‹t_™d_dump
(
å™s
, 
∑th
,

3152 
∑th
->
¶Ÿs
[0]);

3153 
ªt
 = -
EUCLEAN
;

3154 
out
;

3157 
	`båfs_£t_exã¡_ªfs
(
Àaf
, 
ei
, 
ªfs
);

3158 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

3160 i‡(
found_exã¡
) {

3161 
ªt
 = 
	`ªmove_exã¡_backªf
(
å™s
, 
exã¡_roŸ
, 
∑th
,

3162 
úef
, 
ªfs_to_dr›
, 
is_d©a
);

3163 i‡(
ªt
) {

3164 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3165 
out
;

3170 i‡(
found_exã¡
) {

3171 i‡(
is_d©a
 && 
ªfs_to_dr›
 !=

3172 
	`exã¡_d©a_ªf_cou¡
(
∑th
, 
úef
)) {

3173 
	`ab‹t_™d_dump
(
å™s
, 
∑th
,

3175 
	`exã¡_d©a_ªf_cou¡
(
∑th
, 
úef
),

3176 
ªfs_to_dr›
, 
∑th
->
¶Ÿs
[0]);

3177 
ªt
 = -
EUCLEAN
;

3178 
out
;

3180 i‡(
úef
) {

3181 i‡(
∑th
->
¶Ÿs
[0] !
exã¡_¶Ÿ
) {

3182 
	`ab‹t_™d_dump
(
å™s
, 
∑th
,

3184 
key
.
obje˘id
, key.
ty≥
,

3185 
key
.
off£t
, 
∑th
->
¶Ÿs
[0]);

3186 
ªt
 = -
EUCLEAN
;

3187 
out
;

3196 i‡(
∑th
->
¶Ÿs
[0] !
exã¡_¶Ÿ
 + 1) {

3197 
	`ab‹t_™d_dump
(
å™s
, 
∑th
,

3199 
∑th
->
¶Ÿs
[0]);

3200 
ªt
 = -
EUCLEAN
;

3201 
out
;

3203 
∑th
->
¶Ÿs
[0] = 
exã¡_¶Ÿ
;

3204 
num_to_dñ
 = 2;

3208 
ªt
 = 
	`båfs_dñ_ôems
(
å™s
, 
exã¡_roŸ
, 
∑th
,Ö©h->
¶Ÿs
[0],

3209 
num_to_dñ
);

3210 i‡(
ªt
) {

3211 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3212 
out
;

3214 
	`båfs_ªÀa£_∑th
(
∑th
);

3216 
ªt
 = 
	`do_‰ì_exã¡_accou¡ög
(
å™s
, 
byãƒ
, 
num_byãs
, 
is_d©a
);

3218 
	`båfs_ªÀa£_∑th
(
∑th
);

3220 
out
:

3221 
	`båfs_‰ì_∑th
(
∑th
);

3222  
ªt
;

3223 
	}
}

3231 
noölöe
 
	$check_ªf_˛ónup
(
båfs_å™s_h™dÀ
 *
å™s
,

3232 
u64
 
byãƒ
)

3234 
båfs_dñayed_ªf_hód
 *
hód
;

3235 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
;

3236 
ªt
 = 0;

3238 
dñayed_ªfs
 = &
å™s
->
å™ß˘i⁄
->delayed_refs;

3239 
	`•ö_lock
(&
dñayed_ªfs
->
lock
);

3240 
hód
 = 
	`båfs_föd_dñayed_ªf_hód
(
dñayed_ªfs
, 
byãƒ
);

3241 i‡(!
hód
)

3242 
out_dñayed_u∆ock
;

3244 
	`•ö_lock
(&
hód
->
lock
);

3245 i‡(!
	`RB_EMPTY_ROOT
(&
hód
->
ªf_åì
.
rb_roŸ
))

3246 
out
;

3248 i‡(
	`˛ónup_exã¡_›
(
hód
Ë!
NULL
)

3249 
out
;

3255 i‡(!
	`muãx_åylock
(&
hód
->
muãx
))

3256 
out
;

3258 
	`båfs_dñëe_ªf_hód
(
dñayed_ªfs
, 
hód
);

3259 
hód
->
¥o˚ssög
 = 
Ál£
;

3261 
	`•ö_u∆ock
(&
hód
->
lock
);

3262 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

3264 
	`BUG_ON
(
hód
->
exã¡_›
);

3265 i‡(
hód
->
mu°_ö£π_ª£rved
)

3266 
ªt
 = 1;

3268 
	`båfs_˛ónup_ªf_hód_accou¡ög
(
å™s
->
fs_öfo
, 
dñayed_ªfs
, 
hód
);

3269 
	`muãx_u∆ock
(&
hód
->
muãx
);

3270 
	`båfs_put_dñayed_ªf_hód
(
hód
);

3271  
ªt
;

3272 
out
:

3273 
	`•ö_u∆ock
(&
hód
->
lock
);

3275 
out_dñayed_u∆ock
:

3276 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

3278 
	}
}

3280 
	$båfs_‰ì_åì_block
(
båfs_å™s_h™dÀ
 *
å™s
,

3281 
u64
 
roŸ_id
,

3282 
exã¡_buf„r
 *
buf
,

3283 
u64
 
∑ª¡
, 
œ°_ªf
)

3285 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

3286 
båfs_ªf
 
gíîic_ªf
 = { 0 };

3287 
ªt
;

3289 
	`båfs_öô_gíîic_ªf
(&
gíîic_ªf
, 
BTRFS_DROP_DELAYED_REF
,

3290 
buf
->
°¨t
, buf->
Àn
, 
∑ª¡
);

3291 
	`båfs_öô_åì_ªf
(&
gíîic_ªf
, 
	`båfs_hódî_Àvñ
(
buf
),

3292 
roŸ_id
, 0, 
Ál£
);

3294 i‡(
roŸ_id
 !
BTRFS_TREE_LOG_OBJECTID
) {

3295 
	`båfs_ªf_åì_mod
(
fs_öfo
, &
gíîic_ªf
);

3296 
ªt
 = 
	`båfs_add_dñayed_åì_ªf
(
å™s
, &
gíîic_ªf
, 
NULL
);

3297 
	`BUG_ON
(
ªt
);

3300 i‡(
œ°_ªf
 && 
	`båfs_hódî_gíî©i⁄
(
buf
Ë=
å™s
->
å™sid
) {

3301 
båfs_block_group
 *
ˇche
;

3302 
boﬁ
 
mu°_pö
 = 
Ál£
;

3304 i‡(
roŸ_id
 !
BTRFS_TREE_LOG_OBJECTID
) {

3305 
ªt
 = 
	`check_ªf_˛ónup
(
å™s
, 
buf
->
°¨t
);

3306 i‡(!
ªt
) {

3307 
	`båfs_ªdúty_li°_add
(
å™s
->
å™ß˘i⁄
, 
buf
);

3308 
out
;

3312 
ˇche
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
buf
->
°¨t
);

3314 i‡(
	`båfs_hódî_Êag
(
buf
, 
BTRFS_HEADER_FLAG_WRITTEN
)) {

3315 
	`pö_down_exã¡
(
å™s
, 
ˇche
, 
buf
->
°¨t
, buf->
Àn
, 1);

3316 
	`båfs_put_block_group
(
ˇche
);

3317 
out
;

3336 i‡(
	`ã°_bô
(
BTRFS_FS_TREE_MOD_LOG_USERS
, &
fs_öfo
->
Êags
))

3337 
mu°_pö
 = 
åue
;

3339 i‡(
mu°_pö
 || 
	`båfs_is_z⁄ed
(
fs_öfo
)) {

3340 
	`båfs_ªdúty_li°_add
(
å™s
->
å™ß˘i⁄
, 
buf
);

3341 
	`pö_down_exã¡
(
å™s
, 
ˇche
, 
buf
->
°¨t
, buf->
Àn
, 1);

3342 
	`båfs_put_block_group
(
ˇche
);

3343 
out
;

3346 
	`WARN_ON
(
	`ã°_bô
(
EXTENT_BUFFER_DIRTY
, &
buf
->
bÊags
));

3348 
	`båfs_add_‰ì_•a˚
(
ˇche
, 
buf
->
°¨t
, buf->
Àn
);

3349 
	`båfs_‰ì_ª£rved_byãs
(
ˇche
, 
buf
->
Àn
, 0);

3350 
	`båfs_put_block_group
(
ˇche
);

3351 
	`åa˚_båfs_ª£rved_exã¡_‰ì
(
fs_öfo
, 
buf
->
°¨t
, buf->
Àn
);

3353 
out
:

3354 i‡(
œ°_ªf
) {

3359 
	`˛ór_bô
(
EXTENT_BUFFER_CORRUPT
, &
buf
->
bÊags
);

3361 
	}
}

3364 
	$båfs_‰ì_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_ªf
 *
ªf
)

3366 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

3367 
ªt
;

3369 i‡(
	`båfs_is_ã°ög
(
fs_öfo
))

3376 i‡((
ªf
->
ty≥
 =
BTRFS_REF_METADATA
 &&

3377 
ªf
->
åì_ªf
.
ownög_roŸ
 =
BTRFS_TREE_LOG_OBJECTID
) ||

3378 (
ªf
->
ty≥
 =
BTRFS_REF_DATA
 &&

3379 
ªf
->
d©a_ªf
.
ownög_roŸ
 =
BTRFS_TREE_LOG_OBJECTID
)) {

3381 
	`båfs_pö_exã¡
(
å™s
, 
ªf
->
byãƒ
,Ñef->
Àn
, 1);

3382 
ªt
 = 0;

3383 } i‡(
ªf
->
ty≥
 =
BTRFS_REF_METADATA
) {

3384 
ªt
 = 
	`båfs_add_dñayed_åì_ªf
(
å™s
, 
ªf
, 
NULL
);

3386 
ªt
 = 
	`båfs_add_dñayed_d©a_ªf
(
å™s
, 
ªf
, 0);

3389 i‡(!((
ªf
->
ty≥
 =
BTRFS_REF_METADATA
 &&

3390 
ªf
->
åì_ªf
.
ownög_roŸ
 =
BTRFS_TREE_LOG_OBJECTID
) ||

3391 (
ªf
->
ty≥
 =
BTRFS_REF_DATA
 &&

3392 
ªf
->
d©a_ªf
.
ownög_roŸ
 =
BTRFS_TREE_LOG_OBJECTID
)))

3393 
	`båfs_ªf_åì_mod
(
fs_öfo
, 
ªf
);

3395  
ªt
;

3396 
	}
}

3398 
	ebåfs_lo›_ty≥
 {

3403 
	mLOOP_CACHING_NOWAIT
,

3409 
	mLOOP_CACHING_WAIT
,

3415 
	mLOOP_UNSET_SIZE_CLASS
,

3420 
	mLOOP_ALLOC_CHUNK
,

3425 
	mLOOP_WRONG_SIZE_CLASS
,

3431 
	mLOOP_NO_EMPTY_SIZE
,

3434 
ölöe
 

3435 
	$båfs_lock_block_group
(
båfs_block_group
 *
ˇche
,

3436 
dñÆloc
)

3438 i‡(
dñÆloc
)

3439 
	`down_ªad
(&
ˇche
->
d©a_rw£m
);

3440 
	}
}

3442 
ölöe
 
	$båfs_gøb_block_group
(
båfs_block_group
 *
ˇche
,

3443 
dñÆloc
)

3445 
	`båfs_gë_block_group
(
ˇche
);

3446 i‡(
dñÆloc
)

3447 
	`down_ªad
(&
ˇche
->
d©a_rw£m
);

3448 
	}
}

3450 
båfs_block_group
 *
	$båfs_lock_˛u°î
(

3451 
båfs_block_group
 *
block_group
,

3452 
båfs_‰ì_˛u°î
 *
˛u°î
,

3453 
dñÆloc
)

3454 
	`__acquúes
(&
˛u°î
->
ªfûl_lock
)

3456 
båfs_block_group
 *
u£d_bg
 = 
NULL
;

3458 
	`•ö_lock
(&
˛u°î
->
ªfûl_lock
);

3460 
u£d_bg
 = 
˛u°î
->
block_group
;

3461 i‡(!
u£d_bg
)

3462  
NULL
;

3464 i‡(
u£d_bg
 =
block_group
)

3465  
u£d_bg
;

3467 
	`båfs_gë_block_group
(
u£d_bg
);

3469 i‡(!
dñÆloc
)

3470  
u£d_bg
;

3472 i‡(
	`down_ªad_åylock
(&
u£d_bg
->
d©a_rw£m
))

3473  
u£d_bg
;

3475 
	`•ö_u∆ock
(&
˛u°î
->
ªfûl_lock
);

3478 
	`down_ªad_√°ed
(&
u£d_bg
->
d©a_rw£m
, 
SINGLE_DEPTH_NESTING
);

3480 
	`•ö_lock
(&
˛u°î
->
ªfûl_lock
);

3481 i‡(
u£d_bg
 =
˛u°î
->
block_group
)

3482  
u£d_bg
;

3484 
	`up_ªad
(&
u£d_bg
->
d©a_rw£m
);

3485 
	`båfs_put_block_group
(
u£d_bg
);

3487 
	}
}

3489 
ölöe
 

3490 
	$båfs_ªÀa£_block_group
(
båfs_block_group
 *
ˇche
,

3491 
dñÆloc
)

3493 i‡(
dñÆloc
)

3494 
	`up_ªad
(&
ˇche
->
d©a_rw£m
);

3495 
	`båfs_put_block_group
(
ˇche
);

3496 
	}
}

3505 
	$föd_‰ì_exã¡_˛u°îed
(
båfs_block_group
 *
bg
,

3506 
föd_‰ì_exã¡_˘l
 *
f„_˘l
,

3507 
båfs_block_group
 **
˛u°î_bg_ªt
)

3509 
båfs_block_group
 *
˛u°î_bg
;

3510 
båfs_‰ì_˛u°î
 *
œ°_±r
 = 
f„_˘l
->last_ptr;

3511 
u64
 
Æig√d_˛u°î
;

3512 
u64
 
off£t
;

3513 
ªt
;

3515 
˛u°î_bg
 = 
	`båfs_lock_˛u°î
(
bg
, 
œ°_±r
, 
f„_˘l
->
dñÆloc
);

3516 i‡(!
˛u°î_bg
)

3517 
ªfûl_˛u°î
;

3518 i‡(
˛u°î_bg
 !
bg
 && (˛u°î_bg->
ro
 ||

3519 !
	`block_group_bôs
(
˛u°î_bg
, 
f„_˘l
->
Êags
)))

3520 
ªÀa£_˛u°î
;

3522 
off£t
 = 
	`båfs_Æloc_‰om_˛u°î
(
˛u°î_bg
, 
œ°_±r
,

3523 
f„_˘l
->
num_byãs
, 
˛u°î_bg
->
°¨t
,

3524 &
f„_˘l
->
max_exã¡_size
);

3525 i‡(
off£t
) {

3527 
	`•ö_u∆ock
(&
œ°_±r
->
ªfûl_lock
);

3528 
	`åa˚_båfs_ª£rve_exã¡_˛u°î
(
˛u°î_bg
, 
f„_˘l
);

3529 *
˛u°î_bg_ªt
 = 
˛u°î_bg
;

3530 
f„_˘l
->
found_off£t
 = 
off£t
;

3533 
	`WARN_ON
(
œ°_±r
->
block_group
 !
˛u°î_bg
);

3535 
ªÀa£_˛u°î
:

3547 i‡(
f„_˘l
->
lo›
 >
LOOP_NO_EMPTY_SIZE
 && 
˛u°î_bg
 !
bg
) {

3548 
	`•ö_u∆ock
(&
œ°_±r
->
ªfûl_lock
);

3549 
	`båfs_ªÀa£_block_group
(
˛u°î_bg
, 
f„_˘l
->
dñÆloc
);

3550  -
ENOENT
;

3554 
	`båfs_ªtu∫_˛u°î_to_‰ì_•a˚
(
NULL
, 
œ°_±r
);

3556 i‡(
˛u°î_bg
 !
bg
)

3557 
	`båfs_ªÀa£_block_group
(
˛u°î_bg
, 
f„_˘l
->
dñÆloc
);

3559 
ªfûl_˛u°î
:

3560 i‡(
f„_˘l
->
lo›
 >
LOOP_NO_EMPTY_SIZE
) {

3561 
	`•ö_u∆ock
(&
œ°_±r
->
ªfûl_lock
);

3562  -
ENOENT
;

3565 
Æig√d_˛u°î
 = 
	`max_t
(
u64
,

3566 
f„_˘l
->
em±y_˛u°î
 + f„_˘l->
em±y_size
,

3567 
bg
->
fuŒ_°rùe_Àn
);

3568 
ªt
 = 
	`båfs_föd_•a˚_˛u°î
(
bg
, 
œ°_±r
, 
f„_˘l
->
£¨ch_°¨t
,

3569 
f„_˘l
->
num_byãs
, 
Æig√d_˛u°î
);

3570 i‡(
ªt
 == 0) {

3572 
off£t
 = 
	`båfs_Æloc_‰om_˛u°î
(
bg
, 
œ°_±r
,

3573 
f„_˘l
->
num_byãs
, f„_˘l->
£¨ch_°¨t
,

3574 &
f„_˘l
->
max_exã¡_size
);

3575 i‡(
off£t
) {

3577 
	`•ö_u∆ock
(&
œ°_±r
->
ªfûl_lock
);

3578 
f„_˘l
->
found_off£t
 = 
off£t
;

3579 
	`åa˚_båfs_ª£rve_exã¡_˛u°î
(
bg
, 
f„_˘l
);

3588 
	`båfs_ªtu∫_˛u°î_to_‰ì_•a˚
(
NULL
, 
œ°_±r
);

3589 
	`•ö_u∆ock
(&
œ°_±r
->
ªfûl_lock
);

3591 
	}
}

3597 
	$föd_‰ì_exã¡_un˛u°îed
(
båfs_block_group
 *
bg
,

3598 
föd_‰ì_exã¡_˘l
 *
f„_˘l
)

3600 
båfs_‰ì_˛u°î
 *
œ°_±r
 = 
f„_˘l
->last_ptr;

3601 
u64
 
off£t
;

3608 i‡(
	`u∆ikñy
(
œ°_±r
)) {

3609 
	`•ö_lock
(&
œ°_±r
->
lock
);

3610 
œ°_±r
->
‰agmíãd
 = 1;

3611 
	`•ö_u∆ock
(&
œ°_±r
->
lock
);

3613 i‡(
f„_˘l
->
ˇched
) {

3614 
båfs_‰ì_•a˚_˘l
 *
‰ì_•a˚_˘l
;

3616 
‰ì_•a˚_˘l
 = 
bg
->free_space_ctl;

3617 
	`•ö_lock
(&
‰ì_•a˚_˘l
->
åì_lock
);

3618 i‡(
‰ì_•a˚_˘l
->
‰ì_•a˚
 <

3619 
f„_˘l
->
num_byãs
 + f„_˘l->
em±y_˛u°î
 +

3620 
f„_˘l
->
em±y_size
) {

3621 
f„_˘l
->
tŸÆ_‰ì_•a˚
 = 
	`max_t
(
u64
,

3622 
f„_˘l
->
tŸÆ_‰ì_•a˚
,

3623 
‰ì_•a˚_˘l
->
‰ì_•a˚
);

3624 
	`•ö_u∆ock
(&
‰ì_•a˚_˘l
->
åì_lock
);

3627 
	`•ö_u∆ock
(&
‰ì_•a˚_˘l
->
åì_lock
);

3630 
off£t
 = 
	`båfs_föd_•a˚_f‹_Æloc
(
bg
, 
f„_˘l
->
£¨ch_°¨t
,

3631 
f„_˘l
->
num_byãs
, f„_˘l->
em±y_size
,

3632 &
f„_˘l
->
max_exã¡_size
);

3633 i‡(!
off£t
)

3635 
f„_˘l
->
found_off£t
 = 
off£t
;

3637 
	}
}

3639 
	$do_Æloˇti⁄_˛u°îed
(
båfs_block_group
 *
block_group
,

3640 
föd_‰ì_exã¡_˘l
 *
f„_˘l
,

3641 
båfs_block_group
 **
bg_ªt
)

3643 
ªt
;

3646 i‡(
f„_˘l
->
œ°_±r
 && f„_˘l->
u£_˛u°î
) {

3647 
ªt
 = 
	`föd_‰ì_exã¡_˛u°îed
(
block_group
, 
f„_˘l
, 
bg_ªt
);

3648 i‡(
ªt
 >= 0)

3649  
ªt
;

3653  
	`föd_‰ì_exã¡_un˛u°îed
(
block_group
, 
f„_˘l
);

3654 
	}
}

3677 
	$do_Æloˇti⁄_z⁄ed
(
båfs_block_group
 *
block_group
,

3678 
föd_‰ì_exã¡_˘l
 *
f„_˘l
,

3679 
båfs_block_group
 **
bg_ªt
)

3681 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

3682 
båfs_•a˚_öfo
 *
•a˚_öfo
 = 
block_group
->space_info;

3683 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

3684 
u64
 
°¨t
 = 
block_group
->start;

3685 
u64
 
num_byãs
 = 
f„_˘l
->num_bytes;

3686 
u64
 
avaû
;

3687 
u64
 
byãƒ
 = 
block_group
->
°¨t
;

3688 
u64
 
log_byãƒ
;

3689 
u64
 
d©a_ªloc_byãƒ
;

3690 
ªt
 = 0;

3691 
boﬁ
 
skù
 = 
Ál£
;

3693 
	`ASSERT
(
	`båfs_is_z⁄ed
(
block_group
->
fs_öfo
));

3699 
	`•ö_lock
(&
fs_öfo
->
åìlog_bg_lock
);

3700 
log_byãƒ
 = 
fs_öfo
->
åìlog_bg
;

3701 i‡(
log_byãƒ
 && ((
f„_˘l
->
f‹_åìlog
 && 
byãƒ
 !=Üog_bytenr) ||

3702 (!
f„_˘l
->
f‹_åìlog
 && 
byãƒ
 =
log_byãƒ
)))

3703 
skù
 = 
åue
;

3704 
	`•ö_u∆ock
(&
fs_öfo
->
åìlog_bg_lock
);

3705 i‡(
skù
)

3712 
	`•ö_lock
(&
fs_öfo
->
ªloˇti⁄_bg_lock
);

3713 
d©a_ªloc_byãƒ
 = 
fs_öfo
->
d©a_ªloc_bg
;

3714 i‡(
d©a_ªloc_byãƒ
 &&

3715 ((
f„_˘l
->
f‹_d©a_ªloc
 && 
byãƒ
 !
d©a_ªloc_byãƒ
) ||

3716 (!
f„_˘l
->
f‹_d©a_ªloc
 && 
byãƒ
 =
d©a_ªloc_byãƒ
)))

3717 
skù
 = 
åue
;

3718 
	`•ö_u∆ock
(&
fs_öfo
->
ªloˇti⁄_bg_lock
);

3719 i‡(
skù
)

3723 
	`•ö_lock
(&
block_group
->
lock
);

3724 i‡(
block_group
->
ro
 || 
	`båfs_z⁄ed_bg_is_fuŒ
(block_group)) {

3725 
ªt
 = 1;

3731 
	`•ö_u∆ock
(&
block_group
->
lock
);

3734 i‡(!
ªt
 && (
block_group
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
) &&

3735 !
	`båfs_z⁄e_a˘iv©e
(
block_group
)) {

3736 
ªt
 = 1;

3743 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

3744 
	`•ö_lock
(&
block_group
->
lock
);

3745 
	`•ö_lock
(&
fs_öfo
->
åìlog_bg_lock
);

3746 
	`•ö_lock
(&
fs_öfo
->
ªloˇti⁄_bg_lock
);

3748 i‡(
ªt
)

3749 
out
;

3751 
	`ASSERT
(!
f„_˘l
->
f‹_åìlog
 ||

3752 
block_group
->
°¨t
 =
fs_öfo
->
åìlog_bg
 ||

3753 
fs_öfo
->
åìlog_bg
 == 0);

3754 
	`ASSERT
(!
f„_˘l
->
f‹_d©a_ªloc
 ||

3755 
block_group
->
°¨t
 =
fs_öfo
->
d©a_ªloc_bg
 ||

3756 
fs_öfo
->
d©a_ªloc_bg
 == 0);

3758 i‡(
block_group
->
ro
 ||

3759 (!
f„_˘l
->
f‹_d©a_ªloc
 &&

3760 
	`ã°_bô
(
BLOCK_GROUP_FLAG_ZONED_DATA_RELOC
, &
block_group
->
ru¡ime_Êags
))) {

3761 
ªt
 = 1;

3762 
out
;

3769 i‡(
f„_˘l
->
f‹_åìlog
 && !
fs_öfo
->
åìlog_bg
 &&

3770 (
block_group
->
u£d
 || block_group->
ª£rved
)) {

3771 
ªt
 = 1;

3772 
out
;

3779 i‡(
f„_˘l
->
f‹_d©a_ªloc
 && !
fs_öfo
->
d©a_ªloc_bg
 &&

3780 (
block_group
->
u£d
 || block_group->
ª£rved
)) {

3781 
ªt
 = 1;

3782 
out
;

3785 
	`WARN_ON_ONCE
(
block_group
->
Æloc_off£t
 > block_group->
z⁄e_ˇ∑côy
);

3786 
avaû
 = 
block_group
->
z⁄e_ˇ∑côy
 - block_group->
Æloc_off£t
;

3787 i‡(
avaû
 < 
num_byãs
) {

3788 i‡(
f„_˘l
->
max_exã¡_size
 < 
avaû
) {

3793 
f„_˘l
->
max_exã¡_size
 = 
avaû
;

3794 
f„_˘l
->
tŸÆ_‰ì_•a˚
 = 
avaû
;

3796 
ªt
 = 1;

3797 
out
;

3800 i‡(
f„_˘l
->
f‹_åìlog
 && !
fs_öfo
->
åìlog_bg
)

3801 
fs_öfo
->
åìlog_bg
 = 
block_group
->
°¨t
;

3803 i‡(
f„_˘l
->
f‹_d©a_ªloc
) {

3804 i‡(!
fs_öfo
->
d©a_ªloc_bg
)

3805 
fs_öfo
->
d©a_ªloc_bg
 = 
block_group
->
°¨t
;

3821 
	`£t_bô
(
BLOCK_GROUP_FLAG_ZONED_DATA_RELOC
, &
block_group
->
ru¡ime_Êags
);

3824 
f„_˘l
->
found_off£t
 = 
°¨t
 + 
block_group
->
Æloc_off£t
;

3825 
block_group
->
Æloc_off£t
 +
num_byãs
;

3826 
	`•ö_lock
(&
˘l
->
åì_lock
);

3827 
˘l
->
‰ì_•a˚
 -
num_byãs
;

3828 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3835 
f„_˘l
->
£¨ch_°¨t
 = f„_˘l->
found_off£t
;

3837 
out
:

3838 i‡(
ªt
 && 
f„_˘l
->
f‹_åìlog
)

3839 
fs_öfo
->
åìlog_bg
 = 0;

3840 i‡(
ªt
 && 
f„_˘l
->
f‹_d©a_ªloc
)

3841 
fs_öfo
->
d©a_ªloc_bg
 = 0;

3842 
	`•ö_u∆ock
(&
fs_öfo
->
ªloˇti⁄_bg_lock
);

3843 
	`•ö_u∆ock
(&
fs_öfo
->
åìlog_bg_lock
);

3844 
	`•ö_u∆ock
(&
block_group
->
lock
);

3845 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

3846  
ªt
;

3847 
	}
}

3849 
	$do_Æloˇti⁄
(
båfs_block_group
 *
block_group
,

3850 
föd_‰ì_exã¡_˘l
 *
f„_˘l
,

3851 
båfs_block_group
 **
bg_ªt
)

3853 
f„_˘l
->
pﬁicy
) {

3854 
BTRFS_EXTENT_ALLOC_CLUSTERED
:

3855  
	`do_Æloˇti⁄_˛u°îed
(
block_group
, 
f„_˘l
, 
bg_ªt
);

3856 
BTRFS_EXTENT_ALLOC_ZONED
:

3857  
	`do_Æloˇti⁄_z⁄ed
(
block_group
, 
f„_˘l
, 
bg_ªt
);

3859 
	`BUG
();

3861 
	}
}

3863 
	$ªÀa£_block_group
(
båfs_block_group
 *
block_group
,

3864 
föd_‰ì_exã¡_˘l
 *
f„_˘l
,

3865 
dñÆloc
)

3867 
f„_˘l
->
pﬁicy
) {

3868 
BTRFS_EXTENT_ALLOC_CLUSTERED
:

3869 
f„_˘l
->
ªåy_unˇched
 = 
Ál£
;

3871 
BTRFS_EXTENT_ALLOC_ZONED
:

3875 
	`BUG
();

3878 
	`BUG_ON
(
	`båfs_bg_Êags_to_øid_ödex
(
block_group
->
Êags
) !=

3879 
f„_˘l
->
ödex
);

3880 
	`båfs_ªÀa£_block_group
(
block_group
, 
dñÆloc
);

3881 
	}
}

3883 
	$found_exã¡_˛u°îed
(
föd_‰ì_exã¡_˘l
 *
f„_˘l
,

3884 
båfs_key
 *
ös
)

3886 
båfs_‰ì_˛u°î
 *
œ°_±r
 = 
f„_˘l
->last_ptr;

3888 i‡(!
f„_˘l
->
u£_˛u°î
 && 
œ°_±r
) {

3889 
	`•ö_lock
(&
œ°_±r
->
lock
);

3890 
œ°_±r
->
wödow_°¨t
 = 
ös
->
obje˘id
;

3891 
	`•ö_u∆ock
(&
œ°_±r
->
lock
);

3893 
	}
}

3895 
	$found_exã¡
(
föd_‰ì_exã¡_˘l
 *
f„_˘l
,

3896 
båfs_key
 *
ös
)

3898 
f„_˘l
->
pﬁicy
) {

3899 
BTRFS_EXTENT_ALLOC_CLUSTERED
:

3900 
	`found_exã¡_˛u°îed
(
f„_˘l
, 
ös
);

3902 
BTRFS_EXTENT_ALLOC_ZONED
:

3906 
	`BUG
();

3908 
	}
}

3910 
	$ˇn_Æloˇã_chunk_z⁄ed
(
båfs_fs_öfo
 *
fs_öfo
,

3911 
föd_‰ì_exã¡_˘l
 *
f„_˘l
)

3914 i‡(!(
f„_˘l
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
))

3918 i‡(
	`båfs_ˇn_a˘iv©e_z⁄e
(
fs_öfo
->
fs_devi˚s
, 
f„_˘l
->
Êags
))

3928 i‡(
f„_˘l
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
) {

3929 
ªt
 = 
	`båfs_z⁄e_föish_⁄e_bg
(
fs_öfo
);

3931 i‡(
ªt
 == 1)

3933 i‡(
ªt
 < 0)

3934  
ªt
;

3942 i‡(
f„_˘l
->
max_exã¡_size
 >f„_˘l->
mö_Æloc_size
)

3943  -
ENOSPC
;

3952 i‡(
f„_˘l
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
)

3953  -
EAGAIN
;

3961 
	}
}

3963 
	$ˇn_Æloˇã_chunk
(
båfs_fs_öfo
 *
fs_öfo
,

3964 
föd_‰ì_exã¡_˘l
 *
f„_˘l
)

3966 
f„_˘l
->
pﬁicy
) {

3967 
BTRFS_EXTENT_ALLOC_CLUSTERED
:

3969 
BTRFS_EXTENT_ALLOC_ZONED
:

3970  
	`ˇn_Æloˇã_chunk_z⁄ed
(
fs_öfo
, 
f„_˘l
);

3972 
	`BUG
();

3974 
	}
}

3981 
	$föd_‰ì_exã¡_upd©e_lo›
(
båfs_fs_öfo
 *
fs_öfo
,

3982 
båfs_key
 *
ös
,

3983 
föd_‰ì_exã¡_˘l
 *
f„_˘l
,

3984 
boﬁ
 
fuŒ_£¨ch
)

3986 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
chunk_roŸ
;

3987 
ªt
;

3989 i‡((
f„_˘l
->
lo›
 =
LOOP_CACHING_NOWAIT
) &&

3990 
f„_˘l
->
have_ˇchög_bg
 && !f„_˘l->
‹ig_have_ˇchög_bg
)

3991 
f„_˘l
->
‹ig_have_ˇchög_bg
 = 
åue
;

3993 i‡(
ös
->
obje˘id
) {

3994 
	`found_exã¡
(
f„_˘l
, 
ös
);

3998 i‡(
f„_˘l
->
lo›
 >
LOOP_CACHING_WAIT
 && f„_˘l->
have_ˇchög_bg
)

4001 
f„_˘l
->
ödex
++;

4002 i‡(
f„_˘l
->
ödex
 < 
BTRFS_NR_RAID_TYPES
)

4006 i‡(
f„_˘l
->
lo›
 < 
LOOP_NO_EMPTY_SIZE
) {

4007 
f„_˘l
->
ödex
 = 0;

4013 i‡(
f„_˘l
->
lo›
 =
LOOP_CACHING_NOWAIT
 &&

4014 (!
f„_˘l
->
‹ig_have_ˇchög_bg
 && 
fuŒ_£¨ch
))

4015 
f„_˘l
->
lo›
++;

4016 
f„_˘l
->
lo›
++;

4018 i‡(
f„_˘l
->
lo›
 =
LOOP_ALLOC_CHUNK
) {

4019 
båfs_å™s_h™dÀ
 *
å™s
;

4020 
exi°
 = 0;

4023 
ªt
 = 
	`ˇn_Æloˇã_chunk
(
fs_öfo
, 
f„_˘l
);

4024 i‡(
ªt
)

4025  
ªt
;

4027 
å™s
 = 
cuºít
->
jou∫Æ_öfo
;

4028 i‡(
å™s
)

4029 
exi°
 = 1;

4031 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
roŸ
);

4033 i‡(
	`IS_ERR
(
å™s
)) {

4034 
ªt
 = 
	`PTR_ERR
(
å™s
);

4035  
ªt
;

4038 
ªt
 = 
	`båfs_chunk_Æloc
(
å™s
, 
f„_˘l
->
Êags
,

4039 
CHUNK_ALLOC_FORCE_FOR_EXTENT
);

4042 i‡(
ªt
 =-
ENOSPC
) {

4043 
ªt
 = 0;

4044 
f„_˘l
->
lo›
++;

4046 i‡(
ªt
 < 0)

4047 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4049 
ªt
 = 0;

4050 i‡(!
exi°
)

4051 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

4052 i‡(
ªt
)

4053  
ªt
;

4056 i‡(
f„_˘l
->
lo›
 =
LOOP_NO_EMPTY_SIZE
) {

4057 i‡(
f„_˘l
->
pﬁicy
 !
BTRFS_EXTENT_ALLOC_CLUSTERED
)

4058  -
ENOSPC
;

4064 i‡(
f„_˘l
->
em±y_size
 == 0 &&

4065 
f„_˘l
->
em±y_˛u°î
 == 0)

4066  -
ENOSPC
;

4067 
f„_˘l
->
em±y_size
 = 0;

4068 
f„_˘l
->
em±y_˛u°î
 = 0;

4072  -
ENOSPC
;

4073 
	}
}

4075 
boﬁ
 
	$föd_‰ì_exã¡_check_size_˛ass
(
föd_‰ì_exã¡_˘l
 *
f„_˘l
,

4076 
båfs_block_group
 *
bg
)

4078 i‡(
f„_˘l
->
pﬁicy
 =
BTRFS_EXTENT_ALLOC_ZONED
)

4079  
åue
;

4080 i‡(!
	`båfs_block_group_should_u£_size_˛ass
(
bg
))

4081  
åue
;

4082 i‡(
f„_˘l
->
lo›
 >
LOOP_WRONG_SIZE_CLASS
)

4083  
åue
;

4084 i‡(
f„_˘l
->
lo›
 >
LOOP_UNSET_SIZE_CLASS
 &&

4085 
bg
->
size_˛ass
 =
BTRFS_BG_SZ_NONE
)

4086  
åue
;

4087  
f„_˘l
->
size_˛ass
 =
bg
->size_class;

4088 
	}
}

4090 
	$¥ï¨e_Æloˇti⁄_˛u°îed
(
båfs_fs_öfo
 *
fs_öfo
,

4091 
föd_‰ì_exã¡_˘l
 *
f„_˘l
,

4092 
båfs_•a˚_öfo
 *
•a˚_öfo
,

4093 
båfs_key
 *
ös
)

4105 i‡(
•a˚_öfo
->
max_exã¡_size
) {

4106 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

4107 i‡(
•a˚_öfo
->
max_exã¡_size
 &&

4108 
f„_˘l
->
num_byãs
 > 
•a˚_öfo
->
max_exã¡_size
) {

4109 
ös
->
off£t
 = 
•a˚_öfo
->
max_exã¡_size
;

4110 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

4111  -
ENOSPC
;

4112 } i‡(
•a˚_öfo
->
max_exã¡_size
) {

4113 
f„_˘l
->
u£_˛u°î
 = 
Ál£
;

4115 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

4118 
f„_˘l
->
œ°_±r
 = 
	`„tch_˛u°î_öfo
(
fs_öfo
, 
•a˚_öfo
,

4119 &
f„_˘l
->
em±y_˛u°î
);

4120 i‡(
f„_˘l
->
œ°_±r
) {

4121 
båfs_‰ì_˛u°î
 *
œ°_±r
 = 
f„_˘l
->last_ptr;

4123 
	`•ö_lock
(&
œ°_±r
->
lock
);

4124 i‡(
œ°_±r
->
block_group
)

4125 
f„_˘l
->
höt_byã
 = 
œ°_±r
->
wödow_°¨t
;

4126 i‡(
œ°_±r
->
‰agmíãd
) {

4132 
f„_˘l
->
höt_byã
 = 
œ°_±r
->
wödow_°¨t
;

4133 
f„_˘l
->
u£_˛u°î
 = 
Ál£
;

4135 
	`•ö_u∆ock
(&
œ°_±r
->
lock
);

4139 
	}
}

4141 
	$¥ï¨e_Æloˇti⁄
(
båfs_fs_öfo
 *
fs_öfo
,

4142 
föd_‰ì_exã¡_˘l
 *
f„_˘l
,

4143 
båfs_•a˚_öfo
 *
•a˚_öfo
,

4144 
båfs_key
 *
ös
)

4146 
f„_˘l
->
pﬁicy
) {

4147 
BTRFS_EXTENT_ALLOC_CLUSTERED
:

4148  
	`¥ï¨e_Æloˇti⁄_˛u°îed
(
fs_öfo
, 
f„_˘l
,

4149 
•a˚_öfo
, 
ös
);

4150 
BTRFS_EXTENT_ALLOC_ZONED
:

4151 i‡(
f„_˘l
->
f‹_åìlog
) {

4152 
	`•ö_lock
(&
fs_öfo
->
åìlog_bg_lock
);

4153 i‡(
fs_öfo
->
åìlog_bg
)

4154 
f„_˘l
->
höt_byã
 = 
fs_öfo
->
åìlog_bg
;

4155 
	`•ö_u∆ock
(&
fs_öfo
->
åìlog_bg_lock
);

4157 i‡(
f„_˘l
->
f‹_d©a_ªloc
) {

4158 
	`•ö_lock
(&
fs_öfo
->
ªloˇti⁄_bg_lock
);

4159 i‡(
fs_öfo
->
d©a_ªloc_bg
)

4160 
f„_˘l
->
höt_byã
 = 
fs_öfo
->
d©a_ªloc_bg
;

4161 
	`•ö_u∆ock
(&
fs_öfo
->
ªloˇti⁄_bg_lock
);

4165 
	`BUG
();

4167 
	}
}

4194 
noölöe
 
	$föd_‰ì_exã¡
(
båfs_roŸ
 *
roŸ
,

4195 
båfs_key
 *
ös
,

4196 
föd_‰ì_exã¡_˘l
 *
f„_˘l
)

4198 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4199 
ªt
 = 0;

4200 
ˇche_block_group_îr‹
 = 0;

4201 
båfs_block_group
 *
block_group
 = 
NULL
;

4202 
båfs_•a˚_öfo
 *
•a˚_öfo
;

4203 
boﬁ
 
fuŒ_£¨ch
 = 
Ál£
;

4205 
	`WARN_ON
(
f„_˘l
->
num_byãs
 < 
fs_öfo
->
£˘‹size
);

4207 
f„_˘l
->
£¨ch_°¨t
 = 0;

4209 
f„_˘l
->
em±y_˛u°î
 = 0;

4210 
f„_˘l
->
œ°_±r
 = 
NULL
;

4211 
f„_˘l
->
u£_˛u°î
 = 
åue
;

4212 
f„_˘l
->
have_ˇchög_bg
 = 
Ál£
;

4213 
f„_˘l
->
‹ig_have_ˇchög_bg
 = 
Ál£
;

4214 
f„_˘l
->
ödex
 = 
	`båfs_bg_Êags_to_øid_ödex
(f„_˘l->
Êags
);

4215 
f„_˘l
->
lo›
 = 0;

4216 
f„_˘l
->
ªåy_unˇched
 = 
Ál£
;

4217 
f„_˘l
->
ˇched
 = 0;

4218 
f„_˘l
->
max_exã¡_size
 = 0;

4219 
f„_˘l
->
tŸÆ_‰ì_•a˚
 = 0;

4220 
f„_˘l
->
found_off£t
 = 0;

4221 
f„_˘l
->
pﬁicy
 = 
BTRFS_EXTENT_ALLOC_CLUSTERED
;

4222 
f„_˘l
->
size_˛ass
 = 
	`båfs_ˇlc_block_group_size_˛ass
(f„_˘l->
num_byãs
);

4224 i‡(
	`båfs_is_z⁄ed
(
fs_öfo
))

4225 
f„_˘l
->
pﬁicy
 = 
BTRFS_EXTENT_ALLOC_ZONED
;

4227 
ös
->
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

4228 
ös
->
obje˘id
 = 0;

4229 
ös
->
off£t
 = 0;

4231 
	`åa˚_föd_‰ì_exã¡
(
roŸ
, 
f„_˘l
);

4233 
•a˚_öfo
 = 
	`båfs_föd_•a˚_öfo
(
fs_öfo
, 
f„_˘l
->
Êags
);

4234 i‡(!
•a˚_öfo
) {

4235 
	`båfs_îr
(
fs_öfo
, "Nÿ•a˚ infÿf‹ %Œu", 
f„_˘l
->
Êags
);

4236  -
ENOSPC
;

4239 
ªt
 = 
	`¥ï¨e_Æloˇti⁄
(
fs_öfo
, 
f„_˘l
, 
•a˚_öfo
, 
ös
);

4240 i‡(
ªt
 < 0)

4241  
ªt
;

4243 
f„_˘l
->
£¨ch_°¨t
 = 
	`max
(ffe_ctl->search_start,

4244 
	`fú°_logiˇl_byã
(
fs_öfo
));

4245 
f„_˘l
->
£¨ch_°¨t
 = 
	`max
(f„_˘l->£¨ch_°¨t, f„_˘l->
höt_byã
);

4246 i‡(
f„_˘l
->
£¨ch_°¨t
 =f„_˘l->
höt_byã
) {

4247 
block_group
 = 
	`båfs_lookup_block_group
(
fs_öfo
,

4248 
f„_˘l
->
£¨ch_°¨t
);

4256 i‡(
block_group
 && 
	`block_group_bôs
(block_group, 
f„_˘l
->
Êags
) &&

4257 
block_group
->
ˇched
 !
BTRFS_CACHE_NO
) {

4258 
	`down_ªad
(&
•a˚_öfo
->
groups_£m
);

4259 i‡(
	`li°_em±y
(&
block_group
->
li°
) ||

4260 
block_group
->
ro
) {

4267 
	`båfs_put_block_group
(
block_group
);

4268 
	`up_ªad
(&
•a˚_öfo
->
groups_£m
);

4270 
f„_˘l
->
ödex
 = 
	`båfs_bg_Êags_to_øid_ödex
(

4271 
block_group
->
Êags
);

4272 
	`båfs_lock_block_group
(
block_group
,

4273 
f„_˘l
->
dñÆloc
);

4274 
f„_˘l
->
höãd
 = 
åue
;

4275 
have_block_group
;

4277 } i‡(
block_group
) {

4278 
	`båfs_put_block_group
(
block_group
);

4281 
£¨ch
:

4282 
	`åa˚_föd_‰ì_exã¡_£¨ch_lo›
(
roŸ
, 
f„_˘l
);

4283 
f„_˘l
->
have_ˇchög_bg
 = 
Ál£
;

4284 i‡(
f„_˘l
->
ödex
 =
	`båfs_bg_Êags_to_øid_ödex
(f„_˘l->
Êags
) ||

4285 
f„_˘l
->
ödex
 == 0)

4286 
fuŒ_£¨ch
 = 
åue
;

4287 
	`down_ªad
(&
•a˚_öfo
->
groups_£m
);

4288 
	`li°_f‹_óch_íåy
(
block_group
,

4289 &
•a˚_öfo
->
block_groups
[
f„_˘l
->
ödex
], 
li°
) {

4290 
båfs_block_group
 *
bg_ªt
;

4292 
f„_˘l
->
höãd
 = 
Ál£
;

4294 i‡(
	`u∆ikñy
(
block_group
->
ro
)) {

4295 i‡(
f„_˘l
->
f‹_åìlog
)

4296 
	`båfs_˛ór_åìlog_bg
(
block_group
);

4297 i‡(
f„_˘l
->
f‹_d©a_ªloc
)

4298 
	`båfs_˛ór_d©a_ªloc_bg
(
block_group
);

4302 
	`båfs_gøb_block_group
(
block_group
, 
f„_˘l
->
dñÆloc
);

4303 
f„_˘l
->
£¨ch_°¨t
 = 
block_group
->
°¨t
;

4310 i‡(!
	`block_group_bôs
(
block_group
, 
f„_˘l
->
Êags
)) {

4311 
u64
 
exåa
 = 
BTRFS_BLOCK_GROUP_DUP
 |

4312 
BTRFS_BLOCK_GROUP_RAID1_MASK
 |

4313 
BTRFS_BLOCK_GROUP_RAID56_MASK
 |

4314 
BTRFS_BLOCK_GROUP_RAID10
;

4321 i‡((
f„_˘l
->
Êags
 & 
exåa
Ë&& !(
block_group
->flags &Éxtra))

4322 
lo›
;

4329 
	`båfs_ªÀa£_block_group
(
block_group
, 
f„_˘l
->
dñÆloc
);

4333 
have_block_group
:

4334 
	`åa˚_föd_‰ì_exã¡_have_block_group
(
roŸ
, 
f„_˘l
, 
block_group
);

4335 
f„_˘l
->
ˇched
 = 
	`båfs_block_group_d⁄e
(
block_group
);

4336 i‡(
	`u∆ikñy
(!
f„_˘l
->
ˇched
)) {

4337 
f„_˘l
->
have_ˇchög_bg
 = 
åue
;

4338 
ªt
 = 
	`båfs_ˇche_block_group
(
block_group
, 
Ál£
);

4347 i‡(
ªt
 < 0) {

4348 i‡(!
ˇche_block_group_îr‹
)

4349 
ˇche_block_group_îr‹
 = 
ªt
;

4350 
ªt
 = 0;

4351 
lo›
;

4353 
ªt
 = 0;

4356 i‡(
	`u∆ikñy
(
block_group
->
ˇched
 =
BTRFS_CACHE_ERROR
)) {

4357 i‡(!
ˇche_block_group_îr‹
)

4358 
ˇche_block_group_îr‹
 = -
EIO
;

4359 
lo›
;

4362 i‡(!
	`föd_‰ì_exã¡_check_size_˛ass
(
f„_˘l
, 
block_group
))

4363 
lo›
;

4365 
bg_ªt
 = 
NULL
;

4366 
ªt
 = 
	`do_Æloˇti⁄
(
block_group
, 
f„_˘l
, &
bg_ªt
);

4367 i‡(
ªt
 > 0)

4368 
lo›
;

4370 i‡(
bg_ªt
 && bg_ªà!
block_group
) {

4371 
	`båfs_ªÀa£_block_group
(
block_group
, 
f„_˘l
->
dñÆloc
);

4372 
block_group
 = 
bg_ªt
;

4376 
f„_˘l
->
£¨ch_°¨t
 = 
	`round_up
(f„_˘l->
found_off£t
,

4377 
fs_öfo
->
°rùesize
);

4380 i‡(
f„_˘l
->
£¨ch_°¨t
 + f„_˘l->
num_byãs
 >

4381 
block_group
->
°¨t
 + block_group->
Àngth
) {

4382 
	`båfs_add_‰ì_•a˚_unu£d
(
block_group
,

4383 
f„_˘l
->
found_off£t
,

4384 
f„_˘l
->
num_byãs
);

4385 
lo›
;

4388 i‡(
f„_˘l
->
found_off£t
 < f„_˘l->
£¨ch_°¨t
)

4389 
	`båfs_add_‰ì_•a˚_unu£d
(
block_group
,

4390 
f„_˘l
->
found_off£t
,

4391 
f„_˘l
->
£¨ch_°¨t
 - f„_˘l->
found_off£t
);

4393 
ªt
 = 
	`båfs_add_ª£rved_byãs
(
block_group
, 
f„_˘l
->
øm_byãs
,

4394 
f„_˘l
->
num_byãs
,

4395 
f„_˘l
->
dñÆloc
,

4396 
f„_˘l
->
lo›
 >
LOOP_WRONG_SIZE_CLASS
);

4397 i‡(
ªt
 =-
EAGAIN
) {

4398 
	`båfs_add_‰ì_•a˚_unu£d
(
block_group
,

4399 
f„_˘l
->
found_off£t
,

4400 
f„_˘l
->
num_byãs
);

4401 
lo›
;

4403 
	`båfs_öc_block_group_ª£rv©i⁄s
(
block_group
);

4406 
ös
->
obje˘id
 = 
f„_˘l
->
£¨ch_°¨t
;

4407 
ös
->
off£t
 = 
f„_˘l
->
num_byãs
;

4409 
	`åa˚_båfs_ª£rve_exã¡
(
block_group
, 
f„_˘l
);

4410 
	`båfs_ªÀa£_block_group
(
block_group
, 
f„_˘l
->
dñÆloc
);

4412 
lo›
:

4413 i‡(!
f„_˘l
->
ˇched
 && f„_˘l->
lo›
 > 
LOOP_CACHING_NOWAIT
 &&

4414 !
f„_˘l
->
ªåy_unˇched
) {

4415 
f„_˘l
->
ªåy_unˇched
 = 
åue
;

4416 
	`båfs_waô_block_group_ˇche_¥ogªss
(
block_group
,

4417 
f„_˘l
->
num_byãs
 +

4418 
f„_˘l
->
em±y_˛u°î
 +

4419 
f„_˘l
->
em±y_size
);

4420 
have_block_group
;

4422 
	`ªÀa£_block_group
(
block_group
, 
f„_˘l
, f„_˘l->
dñÆloc
);

4423 
	`c⁄d_ªsched
();

4425 
	`up_ªad
(&
•a˚_öfo
->
groups_£m
);

4427 
ªt
 = 
	`föd_‰ì_exã¡_upd©e_lo›
(
fs_öfo
, 
ös
, 
f„_˘l
, 
fuŒ_£¨ch
);

4428 i‡(
ªt
 > 0)

4429 
£¨ch
;

4431 i‡(
ªt
 =-
ENOSPC
 && !
ˇche_block_group_îr‹
) {

4436 i‡(!
f„_˘l
->
max_exã¡_size
)

4437 
f„_˘l
->
max_exã¡_size
 = f„_˘l->
tŸÆ_‰ì_•a˚
;

4438 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

4439 
•a˚_öfo
->
max_exã¡_size
 = 
f„_˘l
->max_extent_size;

4440 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

4441 
ös
->
off£t
 = 
f„_˘l
->
max_exã¡_size
;

4442 } i‡(
ªt
 =-
ENOSPC
) {

4443 
ªt
 = 
ˇche_block_group_îr‹
;

4445  
ªt
;

4446 
	}
}

4493 
	$båfs_ª£rve_exã¡
(
båfs_roŸ
 *
roŸ
, 
u64
 
øm_byãs
,

4494 
u64
 
num_byãs
, u64 
mö_Æloc_size
,

4495 
u64
 
em±y_size
, u64 
höt_byã
,

4496 
båfs_key
 *
ös
, 
is_d©a
, 
dñÆloc
)

4498 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4499 
föd_‰ì_exã¡_˘l
 
f„_˘l
 = {};

4500 
boﬁ
 
föÆ_åõd
 = 
num_byãs
 =
mö_Æloc_size
;

4501 
u64
 
Êags
;

4502 
ªt
;

4503 
boﬁ
 
f‹_åìlog
 = (
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_LOG_OBJECTID
);

4504 
boﬁ
 
f‹_d©a_ªloc
 = (
	`båfs_is_d©a_ªloc_roŸ
(
roŸ
Ë&& 
is_d©a
);

4506 
Êags
 = 
	`gë_Æloc_¥ofûe_by_roŸ
(
roŸ
, 
is_d©a
);

4507 
agaö
:

4508 
	`WARN_ON
(
num_byãs
 < 
fs_öfo
->
£˘‹size
);

4510 
f„_˘l
.
øm_byãs
 =Ñam_bytes;

4511 
f„_˘l
.
num_byãs
 =Çum_bytes;

4512 
f„_˘l
.
mö_Æloc_size
 = min_alloc_size;

4513 
f„_˘l
.
em±y_size
 =Émpty_size;

4514 
f„_˘l
.
Êags
 = flags;

4515 
f„_˘l
.
dñÆloc
 = delalloc;

4516 
f„_˘l
.
höt_byã
 = hint_byte;

4517 
f„_˘l
.
f‹_åìlog
 = for_treelog;

4518 
f„_˘l
.
f‹_d©a_ªloc
 = for_data_reloc;

4520 
ªt
 = 
	`föd_‰ì_exã¡
(
roŸ
, 
ös
, &
f„_˘l
);

4521 i‡(!
ªt
 && !
is_d©a
) {

4522 
	`båfs_dec_block_group_ª£rv©i⁄s
(
fs_öfo
, 
ös
->
obje˘id
);

4523 } i‡(
ªt
 =-
ENOSPC
) {

4524 i‡(!
föÆ_åõd
 && 
ös
->
off£t
) {

4525 
num_byãs
 = 
	`mö
“um_byã†>> 1, 
ös
->
off£t
);

4526 
num_byãs
 = 
	`round_down
(num_bytes,

4527 
fs_öfo
->
£˘‹size
);

4528 
num_byãs
 = 
	`max
“um_byãs, 
mö_Æloc_size
);

4529 
øm_byãs
 = 
num_byãs
;

4530 i‡(
num_byãs
 =
mö_Æloc_size
)

4531 
föÆ_åõd
 = 
åue
;

4532 
agaö
;

4533 } i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
ENOSPC_DEBUG
)) {

4534 
båfs_•a˚_öfo
 *
söfo
;

4536 
söfo
 = 
	`båfs_föd_•a˚_öfo
(
fs_öfo
, 
Êags
);

4537 
	`båfs_îr
(
fs_öfo
,

4539 
Êags
, 
num_byãs
, 
f‹_åìlog
, 
f‹_d©a_ªloc
);

4540 i‡(
söfo
)

4541 
	`båfs_dump_•a˚_öfo
(
fs_öfo
, 
söfo
,

4542 
num_byãs
, 1);

4546  
ªt
;

4547 
	}
}

4549 
	$båfs_‰ì_ª£rved_exã¡
(
båfs_fs_öfo
 *
fs_öfo
,

4550 
u64
 
°¨t
, u64 
Àn
, 
dñÆloc
)

4552 
båfs_block_group
 *
ˇche
;

4554 
ˇche
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
°¨t
);

4555 i‡(!
ˇche
) {

4556 
	`båfs_îr
(
fs_öfo
, "UnableÅo find block group for %llu",

4557 
°¨t
);

4558  -
ENOSPC
;

4561 
	`båfs_add_‰ì_•a˚
(
ˇche
, 
°¨t
, 
Àn
);

4562 
	`båfs_‰ì_ª£rved_byãs
(
ˇche
, 
Àn
, 
dñÆloc
);

4563 
	`åa˚_båfs_ª£rved_exã¡_‰ì
(
fs_öfo
, 
°¨t
, 
Àn
);

4565 
	`båfs_put_block_group
(
ˇche
);

4567 
	}
}

4569 
	$båfs_pö_ª£rved_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
°¨t
,

4570 
u64
 
Àn
)

4572 
båfs_block_group
 *
ˇche
;

4573 
ªt
 = 0;

4575 
ˇche
 = 
	`båfs_lookup_block_group
(
å™s
->
fs_öfo
, 
°¨t
);

4576 i‡(!
ˇche
) {

4577 
	`båfs_îr
(
å™s
->
fs_öfo
, "unableÅo find block group for %llu",

4578 
°¨t
);

4579  -
ENOSPC
;

4582 
ªt
 = 
	`pö_down_exã¡
(
å™s
, 
ˇche
, 
°¨t
, 
Àn
, 1);

4583 
	`båfs_put_block_group
(
ˇche
);

4584  
ªt
;

4585 
	}
}

4587 
	$Æloc_ª£rved_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
byãƒ
,

4588 
u64
 
num_byãs
)

4590 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

4591 
ªt
;

4593 
ªt
 = 
	`ªmove_‰om_‰ì_•a˚_åì
(
å™s
, 
byãƒ
, 
num_byãs
);

4594 i‡(
ªt
)

4595  
ªt
;

4597 
ªt
 = 
	`båfs_upd©e_block_group
(
å™s
, 
byãƒ
, 
num_byãs
, 
åue
);

4598 i‡(
ªt
) {

4599 
	`ASSERT
(!
ªt
);

4600 
	`båfs_îr
(
fs_öfo
, "update block group failed for %llu %llu",

4601 
byãƒ
, 
num_byãs
);

4602  
ªt
;

4605 
	`åa˚_båfs_ª£rved_exã¡_Æloc
(
fs_öfo
, 
byãƒ
, 
num_byãs
);

4607 
	}
}

4609 
	$Æloc_ª£rved_fûe_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

4610 
u64
 
∑ª¡
, u64 
roŸ_obje˘id
,

4611 
u64
 
Êags
, u64 
ow√r
, u64 
off£t
,

4612 
båfs_key
 *
ös
, 
ªf_mod
)

4614 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

4615 
båfs_roŸ
 *
exã¡_roŸ
;

4616 
ªt
;

4617 
båfs_exã¡_ôem
 *
exã¡_ôem
;

4618 
båfs_exã¡_ölöe_ªf
 *
úef
;

4619 
båfs_∑th
 *
∑th
;

4620 
exã¡_buf„r
 *
Àaf
;

4621 
ty≥
;

4622 
u32
 
size
;

4624 i‡(
∑ª¡
 > 0)

4625 
ty≥
 = 
BTRFS_SHARED_DATA_REF_KEY
;

4627 
ty≥
 = 
BTRFS_EXTENT_DATA_REF_KEY
;

4629 
size
 = (*
exã¡_ôem
Ë+ 
	`båfs_exã¡_ölöe_ªf_size
(
ty≥
);

4631 
∑th
 = 
	`båfs_Æloc_∑th
();

4632 i‡(!
∑th
)

4633  -
ENOMEM
;

4635 
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
, 
ös
->
obje˘id
);

4636 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
exã¡_roŸ
, 
∑th
, 
ös
, 
size
);

4637 i‡(
ªt
) {

4638 
	`båfs_‰ì_∑th
(
∑th
);

4639  
ªt
;

4642 
Àaf
 = 
∑th
->
nodes
[0];

4643 
exã¡_ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

4644 
båfs_exã¡_ôem
);

4645 
	`båfs_£t_exã¡_ªfs
(
Àaf
, 
exã¡_ôem
, 
ªf_mod
);

4646 
	`båfs_£t_exã¡_gíî©i⁄
(
Àaf
, 
exã¡_ôem
, 
å™s
->
å™sid
);

4647 
	`båfs_£t_exã¡_Êags
(
Àaf
, 
exã¡_ôem
,

4648 
Êags
 | 
BTRFS_EXTENT_FLAG_DATA
);

4650 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)(
exã¡_ôem
 + 1);

4651 
	`båfs_£t_exã¡_ölöe_ªf_ty≥
(
Àaf
, 
úef
, 
ty≥
);

4652 i‡(
∑ª¡
 > 0) {

4653 
båfs_sh¨ed_d©a_ªf
 *
ªf
;

4654 
ªf
 = (
båfs_sh¨ed_d©a_ªf
 *)(
úef
 + 1);

4655 
	`båfs_£t_exã¡_ölöe_ªf_off£t
(
Àaf
, 
úef
, 
∑ª¡
);

4656 
	`båfs_£t_sh¨ed_d©a_ªf_cou¡
(
Àaf
, 
ªf
, 
ªf_mod
);

4658 
båfs_exã¡_d©a_ªf
 *
ªf
;

4659 
ªf
 = (
båfs_exã¡_d©a_ªf
 *)(&
úef
->
off£t
);

4660 
	`båfs_£t_exã¡_d©a_ªf_roŸ
(
Àaf
, 
ªf
, 
roŸ_obje˘id
);

4661 
	`båfs_£t_exã¡_d©a_ªf_obje˘id
(
Àaf
, 
ªf
, 
ow√r
);

4662 
	`båfs_£t_exã¡_d©a_ªf_off£t
(
Àaf
, 
ªf
, 
off£t
);

4663 
	`båfs_£t_exã¡_d©a_ªf_cou¡
(
Àaf
, 
ªf
, 
ªf_mod
);

4666 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑th
->
nodes
[0]);

4667 
	`båfs_‰ì_∑th
(
∑th
);

4669  
	`Æloc_ª£rved_exã¡
(
å™s
, 
ös
->
obje˘id
, ins->
off£t
);

4670 
	}
}

4672 
	$Æloc_ª£rved_åì_block
(
båfs_å™s_h™dÀ
 *
å™s
,

4673 
båfs_dñayed_ªf_node
 *
node
,

4674 
båfs_dñayed_exã¡_›
 *
exã¡_›
)

4676 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

4677 
båfs_roŸ
 *
exã¡_roŸ
;

4678 
ªt
;

4679 
båfs_exã¡_ôem
 *
exã¡_ôem
;

4680 
båfs_key
 
exã¡_key
;

4681 
båfs_åì_block_öfo
 *
block_öfo
;

4682 
båfs_exã¡_ölöe_ªf
 *
úef
;

4683 
båfs_∑th
 *
∑th
;

4684 
exã¡_buf„r
 *
Àaf
;

4685 
båfs_dñayed_åì_ªf
 *
ªf
;

4686 
u32
 
size
 = (*
exã¡_ôem
Ë+ (*
úef
);

4687 
u64
 
Êags
 = 
exã¡_›
->
Êags_to_£t
;

4688 
boﬁ
 
sköny_mëad©a
 = 
	`båfs_fs_öcom∑t
(
fs_öfo
, 
SKINNY_METADATA
);

4690 
ªf
 = 
	`båfs_dñayed_node_to_åì_ªf
(
node
);

4692 
exã¡_key
.
obje˘id
 = 
node
->
byãƒ
;

4693 i‡(
sköny_mëad©a
) {

4694 
exã¡_key
.
off£t
 = 
ªf
->
Àvñ
;

4695 
exã¡_key
.
ty≥
 = 
BTRFS_METADATA_ITEM_KEY
;

4697 
exã¡_key
.
off£t
 = 
node
->
num_byãs
;

4698 
exã¡_key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

4699 
size
 +(*
block_öfo
);

4702 
∑th
 = 
	`båfs_Æloc_∑th
();

4703 i‡(!
∑th
)

4704  -
ENOMEM
;

4706 
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
, 
exã¡_key
.
obje˘id
);

4707 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
exã¡_roŸ
, 
∑th
, &
exã¡_key
,

4708 
size
);

4709 i‡(
ªt
) {

4710 
	`båfs_‰ì_∑th
(
∑th
);

4711  
ªt
;

4714 
Àaf
 = 
∑th
->
nodes
[0];

4715 
exã¡_ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

4716 
båfs_exã¡_ôem
);

4717 
	`båfs_£t_exã¡_ªfs
(
Àaf
, 
exã¡_ôem
, 1);

4718 
	`båfs_£t_exã¡_gíî©i⁄
(
Àaf
, 
exã¡_ôem
, 
å™s
->
å™sid
);

4719 
	`båfs_£t_exã¡_Êags
(
Àaf
, 
exã¡_ôem
,

4720 
Êags
 | 
BTRFS_EXTENT_FLAG_TREE_BLOCK
);

4722 i‡(
sköny_mëad©a
) {

4723 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)(
exã¡_ôem
 + 1);

4725 
block_öfo
 = (
båfs_åì_block_öfo
 *)(
exã¡_ôem
 + 1);

4726 
	`båfs_£t_åì_block_key
(
Àaf
, 
block_öfo
, &
exã¡_›
->
key
);

4727 
	`båfs_£t_åì_block_Àvñ
(
Àaf
, 
block_öfo
, 
ªf
->
Àvñ
);

4728 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)(
block_öfo
 + 1);

4731 i‡(
node
->
ty≥
 =
BTRFS_SHARED_BLOCK_REF_KEY
) {

4732 
	`båfs_£t_exã¡_ölöe_ªf_ty≥
(
Àaf
, 
úef
,

4733 
BTRFS_SHARED_BLOCK_REF_KEY
);

4734 
	`båfs_£t_exã¡_ölöe_ªf_off£t
(
Àaf
, 
úef
, 
ªf
->
∑ª¡
);

4736 
	`båfs_£t_exã¡_ölöe_ªf_ty≥
(
Àaf
, 
úef
,

4737 
BTRFS_TREE_BLOCK_REF_KEY
);

4738 
	`båfs_£t_exã¡_ölöe_ªf_off£t
(
Àaf
, 
úef
, 
ªf
->
roŸ
);

4741 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

4742 
	`båfs_‰ì_∑th
(
∑th
);

4744  
	`Æloc_ª£rved_exã¡
(
å™s
, 
node
->
byãƒ
, 
fs_öfo
->
nodesize
);

4745 
	}
}

4747 
	$båfs_Æloc_ª£rved_fûe_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

4748 
båfs_roŸ
 *
roŸ
, 
u64
 
ow√r
,

4749 
u64
 
off£t
, u64 
øm_byãs
,

4750 
båfs_key
 *
ös
)

4752 
båfs_ªf
 
gíîic_ªf
 = { 0 };

4754 
	`BUG_ON
(
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_LOG_OBJECTID
);

4756 
	`båfs_öô_gíîic_ªf
(&
gíîic_ªf
, 
BTRFS_ADD_DELAYED_EXTENT
,

4757 
ös
->
obje˘id
, ins->
off£t
, 0);

4758 
	`båfs_öô_d©a_ªf
(&
gíîic_ªf
, 
roŸ
->
roŸ_key
.
obje˘id
, 
ow√r
,

4759 
off£t
, 0, 
Ál£
);

4760 
	`båfs_ªf_åì_mod
(
roŸ
->
fs_öfo
, &
gíîic_ªf
);

4762  
	`båfs_add_dñayed_d©a_ªf
(
å™s
, &
gíîic_ªf
, 
øm_byãs
);

4763 
	}
}

4770 
	$båfs_Æloc_logged_fûe_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

4771 
u64
 
roŸ_obje˘id
, u64 
ow√r
, u64 
off£t
,

4772 
båfs_key
 *
ös
)

4774 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

4775 
ªt
;

4776 
båfs_block_group
 *
block_group
;

4777 
båfs_•a˚_öfo
 *
•a˚_öfo
;

4783 i‡(!
	`båfs_fs_öcom∑t
(
fs_öfo
, 
MIXED_GROUPS
)) {

4784 
ªt
 = 
	`__ex˛ude_logged_exã¡
(
fs_öfo
, 
ös
->
obje˘id
,

4785 
ös
->
off£t
);

4786 i‡(
ªt
)

4787  
ªt
;

4790 
block_group
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
ös
->
obje˘id
);

4791 i‡(!
block_group
)

4792  -
EINVAL
;

4794 
•a˚_öfo
 = 
block_group
->space_info;

4795 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

4796 
	`•ö_lock
(&
block_group
->
lock
);

4797 
•a˚_öfo
->
byãs_ª£rved
 +
ös
->
off£t
;

4798 
block_group
->
ª£rved
 +
ös
->
off£t
;

4799 
	`•ö_u∆ock
(&
block_group
->
lock
);

4800 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

4802 
ªt
 = 
	`Æloc_ª£rved_fûe_exã¡
(
å™s
, 0, 
roŸ_obje˘id
, 0, 
ow√r
,

4803 
off£t
, 
ös
, 1);

4804 i‡(
ªt
)

4805 
	`båfs_pö_exã¡
(
å™s
, 
ös
->
obje˘id
, ins->
off£t
, 1);

4806 
	`båfs_put_block_group
(
block_group
);

4807  
ªt
;

4808 
	}
}

4810 
exã¡_buf„r
 *

4811 
	$båfs_öô_√w_buf„r
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
,

4812 
u64
 
byãƒ
, 
Àvñ
, u64 
ow√r
,

4813 
båfs_lock_√°ög
 
√°
)

4815 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4816 
exã¡_buf„r
 *
buf
;

4817 
u64
 
lockdï_ow√r
 = 
ow√r
;

4819 
buf
 = 
	`båfs_föd_¸óã_åì_block
(
fs_öfo
, 
byãƒ
, 
ow√r
, 
Àvñ
);

4820 i‡(
	`IS_ERR
(
buf
))

4821  
buf
;

4828 i‡(
buf
->
lock_ow√r
 =
cuºít
->
pid
) {

4829 
	`båfs_îr_æ
(
fs_öfo
,

4831 
buf
->
°¨t
, 
	`båfs_hódî_ow√r
(buf), 
cuºít
->
pid
);

4832 
	`‰ì_exã¡_buf„r
(
buf
);

4833  
	`ERR_PTR
(-
EUCLEAN
);

4846 i‡(
lockdï_ow√r
 =
BTRFS_TREE_RELOC_OBJECTID
 &&

4847 !
	`ã°_bô
(
BTRFS_ROOT_RESET_LOCKDEP_CLASS
, &
roŸ
->
°©e
))

4848 
lockdï_ow√r
 = 
BTRFS_FS_TREE_OBJECTID
;

4851 
	`båfs_£t_hódî_gíî©i⁄
(
buf
, 
å™s
->
å™sid
);

4858 
	`båfs_£t_buf„r_lockdï_˛ass
(
lockdï_ow√r
, 
buf
, 
Àvñ
);

4860 
	`__båfs_åì_lock
(
buf
, 
√°
);

4861 
	`båfs_˛ór_buf„r_dúty
(
å™s
, 
buf
);

4862 
	`˛ór_bô
(
EXTENT_BUFFER_STALE
, &
buf
->
bÊags
);

4863 
	`˛ór_bô
(
EXTENT_BUFFER_NO_CHECK
, &
buf
->
bÊags
);

4865 
	`£t_exã¡_buf„r_u±od©e
(
buf
);

4867 
	`memzîo_exã¡_buf„r
(
buf
, 0, (
båfs_hódî
));

4868 
	`båfs_£t_hódî_Àvñ
(
buf
, 
Àvñ
);

4869 
	`båfs_£t_hódî_byãƒ
(
buf
, buf->
°¨t
);

4870 
	`båfs_£t_hódî_gíî©i⁄
(
buf
, 
å™s
->
å™sid
);

4871 
	`båfs_£t_hódî_backªf_ªv
(
buf
, 
BTRFS_MIXED_BACKREF_REV
);

4872 
	`båfs_£t_hódî_ow√r
(
buf
, 
ow√r
);

4873 
	`wrôe_exã¡_buf„r_fsid
(
buf
, 
fs_öfo
->
fs_devi˚s
->
mëad©a_uuid
);

4874 
	`wrôe_exã¡_buf„r_chunk_åì_uuid
(
buf
, 
fs_öfo
->
chunk_åì_uuid
);

4875 i‡(
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_LOG_OBJECTID
) {

4876 
buf
->
log_ödex
 = 
roŸ
->
log_å™sid
 % 2;

4881 i‡(
buf
->
log_ödex
 == 0)

4882 
	`£t_exã¡_bô
(&
roŸ
->
dúty_log_∑ges
, 
buf
->
°¨t
,

4883 
buf
->
°¨t
 + buf->
Àn
 - 1,

4884 
EXTENT_DIRTY
, 
NULL
);

4886 
	`£t_exã¡_bô
(&
roŸ
->
dúty_log_∑ges
, 
buf
->
°¨t
,

4887 
buf
->
°¨t
 + buf->
Àn
 - 1,

4888 
EXTENT_NEW
, 
NULL
);

4890 
buf
->
log_ödex
 = -1;

4891 
	`£t_exã¡_bô
(&
å™s
->
å™ß˘i⁄
->
dúty_∑ges
, 
buf
->
°¨t
,

4892 
buf
->
°¨t
 + buf->
Àn
 - 1, 
EXTENT_DIRTY
, 
NULL
);

4895  
buf
;

4896 
	}
}

4902 
exã¡_buf„r
 *
	$båfs_Æloc_åì_block
(
båfs_å™s_h™dÀ
 *
å™s
,

4903 
båfs_roŸ
 *
roŸ
,

4904 
u64
 
∑ª¡
, u64 
roŸ_obje˘id
,

4905 c⁄° 
båfs_disk_key
 *
key
,

4906 
Àvñ
, 
u64
 
höt
,

4907 
u64
 
em±y_size
,

4908 
båfs_lock_√°ög
 
√°
)

4910 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4911 
båfs_key
 
ös
;

4912 
båfs_block_rsv
 *
block_rsv
;

4913 
exã¡_buf„r
 *
buf
;

4914 
båfs_dñayed_exã¡_›
 *
exã¡_›
;

4915 
båfs_ªf
 
gíîic_ªf
 = { 0 };

4916 
u64
 
Êags
 = 0;

4917 
ªt
;

4918 
u32
 
blocksize
 = 
fs_öfo
->
nodesize
;

4919 
boﬁ
 
sköny_mëad©a
 = 
	`båfs_fs_öcom∑t
(
fs_öfo
, 
SKINNY_METADATA
);

4921 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


4922 i‡(
	`båfs_is_ã°ög
(
fs_öfo
)) {

4923 
buf
 = 
	`båfs_öô_√w_buf„r
(
å™s
, 
roŸ
,ÑoŸ->
Æloc_byãƒ
,

4924 
Àvñ
, 
roŸ_obje˘id
, 
√°
);

4925 i‡(!
	`IS_ERR
(
buf
))

4926 
roŸ
->
Æloc_byãƒ
 +
blocksize
;

4927  
buf
;

4931 
block_rsv
 = 
	`båfs_u£_block_rsv
(
å™s
, 
roŸ
, 
blocksize
);

4932 i‡(
	`IS_ERR
(
block_rsv
))

4933  
	`ERR_CAST
(
block_rsv
);

4935 
ªt
 = 
	`båfs_ª£rve_exã¡
(
roŸ
, 
blocksize
, blocksize, blocksize,

4936 
em±y_size
, 
höt
, &
ös
, 0, 0);

4937 i‡(
ªt
)

4938 
out_unu£
;

4940 
buf
 = 
	`båfs_öô_√w_buf„r
(
å™s
, 
roŸ
, 
ös
.
obje˘id
, 
Àvñ
,

4941 
roŸ_obje˘id
, 
√°
);

4942 i‡(
	`IS_ERR
(
buf
)) {

4943 
ªt
 = 
	`PTR_ERR
(
buf
);

4944 
out_‰ì_ª£rved
;

4947 i‡(
roŸ_obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
) {

4948 i‡(
∑ª¡
 == 0)

4949 
∑ª¡
 = 
ös
.
obje˘id
;

4950 
Êags
 |
BTRFS_BLOCK_FLAG_FULL_BACKREF
;

4952 
	`BUG_ON
(
∑ª¡
 > 0);

4954 i‡(
roŸ_obje˘id
 !
BTRFS_TREE_LOG_OBJECTID
) {

4955 
exã¡_›
 = 
	`båfs_Æloc_dñayed_exã¡_›
();

4956 i‡(!
exã¡_›
) {

4957 
ªt
 = -
ENOMEM
;

4958 
out_‰ì_buf
;

4960 i‡(
key
)

4961 
	`mem˝y
(&
exã¡_›
->
key
, key, (extent_op->key));

4963 
	`mem£t
(&
exã¡_›
->
key
, 0, (extent_op->key));

4964 
exã¡_›
->
Êags_to_£t
 = 
Êags
;

4965 
exã¡_›
->
upd©e_key
 = 
sköny_mëad©a
 ? 
Ál£
 : 
åue
;

4966 
exã¡_›
->
upd©e_Êags
 = 
åue
;

4967 
exã¡_›
->
Àvñ
 =Üevel;

4969 
	`båfs_öô_gíîic_ªf
(&
gíîic_ªf
, 
BTRFS_ADD_DELAYED_EXTENT
,

4970 
ös
.
obje˘id
, ins.
off£t
, 
∑ª¡
);

4971 
	`båfs_öô_åì_ªf
(&
gíîic_ªf
, 
Àvñ
, 
roŸ_obje˘id
,

4972 
roŸ
->
roŸ_key
.
obje˘id
, 
Ál£
);

4973 
	`båfs_ªf_åì_mod
(
fs_öfo
, &
gíîic_ªf
);

4974 
ªt
 = 
	`båfs_add_dñayed_åì_ªf
(
å™s
, &
gíîic_ªf
, 
exã¡_›
);

4975 i‡(
ªt
)

4976 
out_‰ì_dñayed
;

4978  
buf
;

4980 
out_‰ì_dñayed
:

4981 
	`båfs_‰ì_dñayed_exã¡_›
(
exã¡_›
);

4982 
out_‰ì_buf
:

4983 
	`båfs_åì_u∆ock
(
buf
);

4984 
	`‰ì_exã¡_buf„r
(
buf
);

4985 
out_‰ì_ª£rved
:

4986 
	`båfs_‰ì_ª£rved_exã¡
(
fs_öfo
, 
ös
.
obje˘id
, ins.
off£t
, 0);

4987 
out_unu£
:

4988 
	`båfs_unu£_block_rsv
(
fs_öfo
, 
block_rsv
, 
blocksize
);

4989  
	`ERR_PTR
(
ªt
);

4990 
	}
}

4992 
	swÆk_c⁄åﬁ
 {

4993 
u64
 
	mªfs
[
BTRFS_MAX_LEVEL
];

4994 
u64
 
	mÊags
[
BTRFS_MAX_LEVEL
];

4995 
båfs_key
 
	mupd©e_¥ogªss
;

4996 
båfs_key
 
	mdr›_¥ogªss
;

4997 
	mdr›_Àvñ
;

4998 
	m°age
;

4999 
	mÀvñ
;

5000 
	msh¨ed_Àvñ
;

5001 
	mupd©e_ªf
;

5002 
	mkìp_locks
;

5003 
	mªada_¶Ÿ
;

5004 
	mªada_cou¡
;

5005 
	mª°¨ãd
;

5008 
	#DROP_REFERENCE
 1

	)

5009 
	#UPDATE_BACKREF
 2

	)

5011 
noölöe
 
	$ªada_wÆk_down
(
båfs_å™s_h™dÀ
 *
å™s
,

5012 
båfs_roŸ
 *
roŸ
,

5013 
wÆk_c⁄åﬁ
 *
wc
,

5014 
båfs_∑th
 *
∑th
)

5016 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

5017 
u64
 
byãƒ
;

5018 
u64
 
gíî©i⁄
;

5019 
u64
 
ªfs
;

5020 
u64
 
Êags
;

5021 
u32
 
ƒôems
;

5022 
båfs_key
 
key
;

5023 
exã¡_buf„r
 *
eb
;

5024 
ªt
;

5025 
¶Ÿ
;

5026 
ƒód
 = 0;

5028 i‡(
∑th
->
¶Ÿs
[
wc
->
Àvñ
] < wc->
ªada_¶Ÿ
) {

5029 
wc
->
ªada_cou¡
 = wc->reada_count * 2 / 3;

5030 
wc
->
ªada_cou¡
 = 
	`max
(wc->reada_count, 2);

5032 
wc
->
ªada_cou¡
 = wc->reada_count * 3 / 2;

5033 
wc
->
ªada_cou¡
 = 
	`mö_t
(, wc->reada_count,

5034 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_öfo
));

5037 
eb
 = 
∑th
->
nodes
[
wc
->
Àvñ
];

5038 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
eb
);

5040 
¶Ÿ
 = 
∑th
->
¶Ÿs
[
wc
->
Àvñ
]; slŸ < 
ƒôems
; slot++) {

5041 i‡(
ƒód
 >
wc
->
ªada_cou¡
)

5044 
	`c⁄d_ªsched
();

5045 
byãƒ
 = 
	`båfs_node_block±r
(
eb
, 
¶Ÿ
);

5046 
gíî©i⁄
 = 
	`båfs_node_±r_gíî©i⁄
(
eb
, 
¶Ÿ
);

5048 i‡(
¶Ÿ
 =
∑th
->
¶Ÿs
[
wc
->
Àvñ
])

5049 
ªada
;

5051 i‡(
wc
->
°age
 =
UPDATE_BACKREF
 &&

5052 
gíî©i⁄
 <
roŸ
->
roŸ_key
.
off£t
)

5056 
ªt
 = 
	`båfs_lookup_exã¡_öfo
(
å™s
, 
fs_öfo
, 
byãƒ
,

5057 
wc
->
Àvñ
 - 1, 1, &
ªfs
,

5058 &
Êags
);

5060 i‡(
ªt
 < 0)

5062 
	`BUG_ON
(
ªfs
 == 0);

5064 i‡(
wc
->
°age
 =
DROP_REFERENCE
) {

5065 i‡(
ªfs
 == 1)

5066 
ªada
;

5068 i‡(
wc
->
Àvñ
 == 1 &&

5069 (
Êags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
))

5071 i‡(!
wc
->
upd©e_ªf
 ||

5072 
gíî©i⁄
 <
roŸ
->
roŸ_key
.
off£t
)

5074 
	`båfs_node_key_to_˝u
(
eb
, &
key
, 
¶Ÿ
);

5075 
ªt
 = 
	`båfs_comp_˝u_keys
(&
key
,

5076 &
wc
->
upd©e_¥ogªss
);

5077 i‡(
ªt
 < 0)

5080 i‡(
wc
->
Àvñ
 == 1 &&

5081 (
Êags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
))

5084 
ªada
:

5085 
	`båfs_ªadahód_node_chûd
(
eb
, 
¶Ÿ
);

5086 
ƒód
++;

5088 
wc
->
ªada_¶Ÿ
 = 
¶Ÿ
;

5089 
	}
}

5099 
noölöe
 
	$wÆk_down_¥oc
(
båfs_å™s_h™dÀ
 *
å™s
,

5100 
båfs_roŸ
 *
roŸ
,

5101 
båfs_∑th
 *
∑th
,

5102 
wÆk_c⁄åﬁ
 *
wc
, 
lookup_öfo
)

5104 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

5105 
Àvñ
 = 
wc
->level;

5106 
exã¡_buf„r
 *
eb
 = 
∑th
->
nodes
[
Àvñ
];

5107 
u64
 
Êag
 = 
BTRFS_BLOCK_FLAG_FULL_BACKREF
;

5108 
ªt
;

5110 i‡(
wc
->
°age
 =
UPDATE_BACKREF
 &&

5111 
	`båfs_hódî_ow√r
(
eb
Ë!
roŸ
->
roŸ_key
.
obje˘id
)

5118 i‡(
lookup_öfo
 &&

5119 ((
wc
->
°age
 =
DROP_REFERENCE
 && wc->
ªfs
[
Àvñ
] != 1) ||

5120 (
wc
->
°age
 =
UPDATE_BACKREF
 && !(wc->
Êags
[
Àvñ
] & 
Êag
)))) {

5121 
	`BUG_ON
(!
∑th
->
locks
[
Àvñ
]);

5122 
ªt
 = 
	`båfs_lookup_exã¡_öfo
(
å™s
, 
fs_öfo
,

5123 
eb
->
°¨t
, 
Àvñ
, 1,

5124 &
wc
->
ªfs
[
Àvñ
],

5125 &
wc
->
Êags
[
Àvñ
]);

5126 
	`BUG_ON
(
ªt
 =-
ENOMEM
);

5127 i‡(
ªt
)

5128  
ªt
;

5129 
	`BUG_ON
(
wc
->
ªfs
[
Àvñ
] == 0);

5132 i‡(
wc
->
°age
 =
DROP_REFERENCE
) {

5133 i‡(
wc
->
ªfs
[
Àvñ
] > 1)

5136 i‡(
∑th
->
locks
[
Àvñ
] && !
wc
->
kìp_locks
) {

5137 
	`båfs_åì_u∆ock_rw
(
eb
, 
∑th
->
locks
[
Àvñ
]);

5138 
∑th
->
locks
[
Àvñ
] = 0;

5144 i‡(!(
wc
->
Êags
[
Àvñ
] & 
Êag
)) {

5145 
	`BUG_ON
(!
∑th
->
locks
[
Àvñ
]);

5146 
ªt
 = 
	`båfs_öc_ªf
(
å™s
, 
roŸ
, 
eb
, 1);

5147 
	`BUG_ON
(
ªt
);

5148 
ªt
 = 
	`båfs_dec_ªf
(
å™s
, 
roŸ
, 
eb
, 0);

5149 
	`BUG_ON
(
ªt
);

5150 
ªt
 = 
	`båfs_£t_disk_exã¡_Êags
(
å™s
, 
eb
, 
Êag
);

5151 
	`BUG_ON
(
ªt
);

5152 
wc
->
Êags
[
Àvñ
] |
Êag
;

5159 i‡(
∑th
->
locks
[
Àvñ
] &&Üevel > 0) {

5160 
	`båfs_åì_u∆ock_rw
(
eb
, 
∑th
->
locks
[
Àvñ
]);

5161 
∑th
->
locks
[
Àvñ
] = 0;

5164 
	}
}

5170 
	$check_ªf_exi°s
(
båfs_å™s_h™dÀ
 *
å™s
,

5171 
båfs_roŸ
 *
roŸ
, 
u64
 
byãƒ
, u64 
∑ª¡
,

5172 
Àvñ
)

5174 
båfs_∑th
 *
∑th
;

5175 
båfs_exã¡_ölöe_ªf
 *
úef
;

5176 
ªt
;

5178 
∑th
 = 
	`båfs_Æloc_∑th
();

5179 i‡(!
∑th
)

5180  -
ENOMEM
;

5182 
ªt
 = 
	`lookup_exã¡_backªf
(
å™s
, 
∑th
, &
úef
, 
byãƒ
,

5183 
roŸ
->
fs_öfo
->
nodesize
, 
∑ª¡
,

5184 
roŸ
->
roŸ_key
.
obje˘id
, 
Àvñ
, 0);

5185 
	`båfs_‰ì_∑th
(
∑th
);

5186 i‡(
ªt
 =-
ENOENT
)

5188 i‡(
ªt
 < 0)

5189  
ªt
;

5191 
	}
}

5206 
noölöe
 
	$do_wÆk_down
(
båfs_å™s_h™dÀ
 *
å™s
,

5207 
båfs_roŸ
 *
roŸ
,

5208 
båfs_∑th
 *
∑th
,

5209 
wÆk_c⁄åﬁ
 *
wc
, *
lookup_öfo
)

5211 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

5212 
u64
 
byãƒ
;

5213 
u64
 
gíî©i⁄
;

5214 
u64
 
∑ª¡
;

5215 
båfs_åì_∑ª¡_check
 
check
 = { 0 };

5216 
båfs_key
 
key
;

5217 
båfs_ªf
 
ªf
 = { 0 };

5218 
exã¡_buf„r
 *
√xt
;

5219 
Àvñ
 = 
wc
->level;

5220 
ªada
 = 0;

5221 
ªt
 = 0;

5222 
boﬁ
 
√ed_accou¡
 = 
Ál£
;

5224 
gíî©i⁄
 = 
	`båfs_node_±r_gíî©i⁄
(
∑th
->
nodes
[
Àvñ
],

5225 
∑th
->
¶Ÿs
[
Àvñ
]);

5231 i‡(
wc
->
°age
 =
UPDATE_BACKREF
 &&

5232 
gíî©i⁄
 <
roŸ
->
roŸ_key
.
off£t
) {

5233 *
lookup_öfo
 = 1;

5237 
byãƒ
 = 
	`båfs_node_block±r
(
∑th
->
nodes
[
Àvñ
],Ö©h->
¶Ÿs
[level]);

5239 
check
.
Àvñ
 =Üevel - 1;

5240 
check
.
å™sid
 = 
gíî©i⁄
;

5241 
check
.
ow√r_roŸ
 = 
roŸ
->
roŸ_key
.
obje˘id
;

5242 
check
.
has_fú°_key
 = 
åue
;

5243 
	`båfs_node_key_to_˝u
(
∑th
->
nodes
[
Àvñ
], &
check
.
fú°_key
,

5244 
∑th
->
¶Ÿs
[
Àvñ
]);

5246 
√xt
 = 
	`föd_exã¡_buf„r
(
fs_öfo
, 
byãƒ
);

5247 i‡(!
√xt
) {

5248 
√xt
 = 
	`båfs_föd_¸óã_åì_block
(
fs_öfo
, 
byãƒ
,

5249 
roŸ
->
roŸ_key
.
obje˘id
, 
Àvñ
 - 1);

5250 i‡(
	`IS_ERR
(
√xt
))

5251  
	`PTR_ERR
(
√xt
);

5252 
ªada
 = 1;

5254 
	`båfs_åì_lock
(
√xt
);

5256 
ªt
 = 
	`båfs_lookup_exã¡_öfo
(
å™s
, 
fs_öfo
, 
byãƒ
, 
Àvñ
 - 1, 1,

5257 &
wc
->
ªfs
[
Àvñ
 - 1],

5258 &
wc
->
Êags
[
Àvñ
 - 1]);

5259 i‡(
ªt
 < 0)

5260 
out_u∆ock
;

5262 i‡(
	`u∆ikñy
(
wc
->
ªfs
[
Àvñ
 - 1] == 0)) {

5263 
	`båfs_îr
(
fs_öfo
, "MissingÑeferences.");

5264 
ªt
 = -
EIO
;

5265 
out_u∆ock
;

5267 *
lookup_öfo
 = 0;

5269 i‡(
wc
->
°age
 =
DROP_REFERENCE
) {

5270 i‡(
wc
->
ªfs
[
Àvñ
 - 1] > 1) {

5271 
√ed_accou¡
 = 
åue
;

5272 i‡(
Àvñ
 == 1 &&

5273 (
wc
->
Êags
[0] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
))

5274 
skù
;

5276 i‡(!
wc
->
upd©e_ªf
 ||

5277 
gíî©i⁄
 <
roŸ
->
roŸ_key
.
off£t
)

5278 
skù
;

5280 
	`båfs_node_key_to_˝u
(
∑th
->
nodes
[
Àvñ
], &
key
,

5281 
∑th
->
¶Ÿs
[
Àvñ
]);

5282 
ªt
 = 
	`båfs_comp_˝u_keys
(&
key
, &
wc
->
upd©e_¥ogªss
);

5283 i‡(
ªt
 < 0)

5284 
skù
;

5286 
wc
->
°age
 = 
UPDATE_BACKREF
;

5287 
wc
->
sh¨ed_Àvñ
 = 
Àvñ
 - 1;

5290 i‡(
Àvñ
 == 1 &&

5291 (
wc
->
Êags
[0] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
))

5292 
skù
;

5295 i‡(!
	`båfs_buf„r_u±od©e
(
√xt
, 
gíî©i⁄
, 0)) {

5296 
	`båfs_åì_u∆ock
(
√xt
);

5297 
	`‰ì_exã¡_buf„r
(
√xt
);

5298 
√xt
 = 
NULL
;

5299 *
lookup_öfo
 = 1;

5302 i‡(!
√xt
) {

5303 i‡(
ªada
 && 
Àvñ
 == 1)

5304 
	`ªada_wÆk_down
(
å™s
, 
roŸ
, 
wc
, 
∑th
);

5305 
√xt
 = 
	`ªad_åì_block
(
fs_öfo
, 
byãƒ
, &
check
);

5306 i‡(
	`IS_ERR
(
√xt
)) {

5307  
	`PTR_ERR
(
√xt
);

5308 } i‡(!
	`exã¡_buf„r_u±od©e
(
√xt
)) {

5309 
	`‰ì_exã¡_buf„r
(
√xt
);

5310  -
EIO
;

5312 
	`båfs_åì_lock
(
√xt
);

5315 
Àvñ
--;

5316 
	`ASSERT
(
Àvñ
 =
	`båfs_hódî_Àvñ
(
√xt
));

5317 i‡(
Àvñ
 !
	`båfs_hódî_Àvñ
(
√xt
)) {

5318 
	`båfs_îr
(
roŸ
->
fs_öfo
, "mismatchedÜevel");

5319 
ªt
 = -
EIO
;

5320 
out_u∆ock
;

5322 
∑th
->
nodes
[
Àvñ
] = 
√xt
;

5323 
∑th
->
¶Ÿs
[
Àvñ
] = 0;

5324 
∑th
->
locks
[
Àvñ
] = 
BTRFS_WRITE_LOCK
;

5325 
wc
->
Àvñ
 =Üevel;

5326 i‡(
wc
->
Àvñ
 == 1)

5327 
wc
->
ªada_¶Ÿ
 = 0;

5329 
skù
:

5330 
wc
->
ªfs
[
Àvñ
 - 1] = 0;

5331 
wc
->
Êags
[
Àvñ
 - 1] = 0;

5332 i‡(
wc
->
°age
 =
DROP_REFERENCE
) {

5333 i‡(
wc
->
Êags
[
Àvñ
] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
) {

5334 
∑ª¡
 = 
∑th
->
nodes
[
Àvñ
]->
°¨t
;

5336 
	`ASSERT
(
roŸ
->
roŸ_key
.
obje˘id
 ==

5337 
	`båfs_hódî_ow√r
(
∑th
->
nodes
[
Àvñ
]));

5338 i‡(
roŸ
->
roŸ_key
.
obje˘id
 !=

5339 
	`båfs_hódî_ow√r
(
∑th
->
nodes
[
Àvñ
])) {

5340 
	`båfs_îr
(
roŸ
->
fs_öfo
,

5342 
ªt
 = -
EIO
;

5343 
out_u∆ock
;

5345 
∑ª¡
 = 0;

5354 i‡(
wc
->
ª°¨ãd
) {

5355 
ªt
 = 
	`check_ªf_exi°s
(
å™s
, 
roŸ
, 
byãƒ
, 
∑ª¡
,

5356 
Àvñ
 - 1);

5357 i‡(
ªt
 < 0)

5358 
out_u∆ock
;

5359 i‡(
ªt
 == 0)

5360 
no_dñëe
;

5361 
ªt
 = 0;

5362 
wc
->
ª°¨ãd
 = 0;

5370 i‡(
roŸ
->
roŸ_key
.
obje˘id
 !
BTRFS_TREE_RELOC_OBJECTID
 &&

5371 
√ed_accou¡
) {

5372 
ªt
 = 
	`båfs_qgroup_åa˚_subåì
(
å™s
, 
√xt
,

5373 
gíî©i⁄
, 
Àvñ
 - 1);

5374 i‡(
ªt
) {

5375 
	`båfs_îr_æ
(
fs_öfo
,

5377 
ªt
);

5387 
wc
->
dr›_Àvñ
 = 
Àvñ
;

5388 
	`föd_√xt_key
(
∑th
, 
Àvñ
, &
wc
->
dr›_¥ogªss
);

5390 
	`båfs_öô_gíîic_ªf
(&
ªf
, 
BTRFS_DROP_DELAYED_REF
, 
byãƒ
,

5391 
fs_öfo
->
nodesize
, 
∑ª¡
);

5392 
	`båfs_öô_åì_ªf
(&
ªf
, 
Àvñ
 - 1, 
roŸ
->
roŸ_key
.
obje˘id
,

5393 0, 
Ál£
);

5394 
ªt
 = 
	`båfs_‰ì_exã¡
(
å™s
, &
ªf
);

5395 i‡(
ªt
)

5396 
out_u∆ock
;

5398 
no_dñëe
:

5399 *
lookup_öfo
 = 1;

5400 
ªt
 = 1;

5402 
out_u∆ock
:

5403 
	`båfs_åì_u∆ock
(
√xt
);

5404 
	`‰ì_exã¡_buf„r
(
√xt
);

5406  
ªt
;

5407 
	}
}

5421 
noölöe
 
	$wÆk_up_¥oc
(
båfs_å™s_h™dÀ
 *
å™s
,

5422 
båfs_roŸ
 *
roŸ
,

5423 
båfs_∑th
 *
∑th
,

5424 
wÆk_c⁄åﬁ
 *
wc
)

5426 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

5427 
ªt
;

5428 
Àvñ
 = 
wc
->level;

5429 
exã¡_buf„r
 *
eb
 = 
∑th
->
nodes
[
Àvñ
];

5430 
u64
 
∑ª¡
 = 0;

5432 i‡(
wc
->
°age
 =
UPDATE_BACKREF
) {

5433 
	`BUG_ON
(
wc
->
sh¨ed_Àvñ
 < 
Àvñ
);

5434 i‡(
Àvñ
 < 
wc
->
sh¨ed_Àvñ
)

5435 
out
;

5437 
ªt
 = 
	`föd_√xt_key
(
∑th
, 
Àvñ
 + 1, &
wc
->
upd©e_¥ogªss
);

5438 i‡(
ªt
 > 0)

5439 
wc
->
upd©e_ªf
 = 0;

5441 
wc
->
°age
 = 
DROP_REFERENCE
;

5442 
wc
->
sh¨ed_Àvñ
 = -1;

5443 
∑th
->
¶Ÿs
[
Àvñ
] = 0;

5450 i‡(!
∑th
->
locks
[
Àvñ
]) {

5451 
	`BUG_ON
(
Àvñ
 == 0);

5452 
	`båfs_åì_lock
(
eb
);

5453 
∑th
->
locks
[
Àvñ
] = 
BTRFS_WRITE_LOCK
;

5455 
ªt
 = 
	`båfs_lookup_exã¡_öfo
(
å™s
, 
fs_öfo
,

5456 
eb
->
°¨t
, 
Àvñ
, 1,

5457 &
wc
->
ªfs
[
Àvñ
],

5458 &
wc
->
Êags
[
Àvñ
]);

5459 i‡(
ªt
 < 0) {

5460 
	`båfs_åì_u∆ock_rw
(
eb
, 
∑th
->
locks
[
Àvñ
]);

5461 
∑th
->
locks
[
Àvñ
] = 0;

5462  
ªt
;

5464 
	`BUG_ON
(
wc
->
ªfs
[
Àvñ
] == 0);

5465 i‡(
wc
->
ªfs
[
Àvñ
] == 1) {

5466 
	`båfs_åì_u∆ock_rw
(
eb
, 
∑th
->
locks
[
Àvñ
]);

5467 
∑th
->
locks
[
Àvñ
] = 0;

5474 
	`BUG_ON
(
wc
->
ªfs
[
Àvñ
] > 1 && !
∑th
->
locks
[level]);

5476 i‡(
wc
->
ªfs
[
Àvñ
] == 1) {

5477 i‡(
Àvñ
 == 0) {

5478 i‡(
wc
->
Êags
[
Àvñ
] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
)

5479 
ªt
 = 
	`båfs_dec_ªf
(
å™s
, 
roŸ
, 
eb
, 1);

5481 
ªt
 = 
	`båfs_dec_ªf
(
å™s
, 
roŸ
, 
eb
, 0);

5482 
	`BUG_ON
(
ªt
);

5483 i‡(
	`is_f°ªe
(
roŸ
->
roŸ_key
.
obje˘id
)) {

5484 
ªt
 = 
	`båfs_qgroup_åa˚_Àaf_ôems
(
å™s
, 
eb
);

5485 i‡(
ªt
) {

5486 
	`båfs_îr_æ
(
fs_öfo
,

5488 
ªt
);

5493 i‡(!
∑th
->
locks
[
Àvñ
]) {

5494 
	`båfs_åì_lock
(
eb
);

5495 
∑th
->
locks
[
Àvñ
] = 
BTRFS_WRITE_LOCK
;

5497 
	`båfs_˛ór_buf„r_dúty
(
å™s
, 
eb
);

5500 i‡(
eb
 =
roŸ
->
node
) {

5501 i‡(
wc
->
Êags
[
Àvñ
] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
)

5502 
∑ª¡
 = 
eb
->
°¨t
;

5503 i‡(
roŸ
->
roŸ_key
.
obje˘id
 !
	`båfs_hódî_ow√r
(
eb
))

5504 
ow√r_mism©ch
;

5506 i‡(
wc
->
Êags
[
Àvñ
 + 1] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
)

5507 
∑ª¡
 = 
∑th
->
nodes
[
Àvñ
 + 1]->
°¨t
;

5508 i‡(
roŸ
->
roŸ_key
.
obje˘id
 !=

5509 
	`båfs_hódî_ow√r
(
∑th
->
nodes
[
Àvñ
 + 1]))

5510 
ow√r_mism©ch
;

5513 
	`båfs_‰ì_åì_block
(
å™s
, 
	`båfs_roŸ_id
(
roŸ
), 
eb
, 
∑ª¡
,

5514 
wc
->
ªfs
[
Àvñ
] == 1);

5515 
out
:

5516 
wc
->
ªfs
[
Àvñ
] = 0;

5517 
wc
->
Êags
[
Àvñ
] = 0;

5520 
ow√r_mism©ch
:

5521 
	`båfs_îr_æ
(
fs_öfo
, "unexpectedÅree owner, have %lluÉxpect %llu",

5522 
	`båfs_hódî_ow√r
(
eb
), 
roŸ
->
roŸ_key
.
obje˘id
);

5523  -
EUCLEAN
;

5524 
	}
}

5526 
noölöe
 
	$wÆk_down_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

5527 
båfs_roŸ
 *
roŸ
,

5528 
båfs_∑th
 *
∑th
,

5529 
wÆk_c⁄åﬁ
 *
wc
)

5531 
Àvñ
 = 
wc
->level;

5532 
lookup_öfo
 = 1;

5533 
ªt
 = 0;

5535 
Àvñ
 >= 0) {

5536 
ªt
 = 
	`wÆk_down_¥oc
(
å™s
, 
roŸ
, 
∑th
, 
wc
, 
lookup_öfo
);

5537 i‡(
ªt
)

5540 i‡(
Àvñ
 == 0)

5543 i‡(
∑th
->
¶Ÿs
[
Àvñ
] >=

5544 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[
Àvñ
]))

5547 
ªt
 = 
	`do_wÆk_down
(
å™s
, 
roŸ
, 
∑th
, 
wc
, &
lookup_öfo
);

5548 i‡(
ªt
 > 0) {

5549 
∑th
->
¶Ÿs
[
Àvñ
]++;

5551 } i‡(
ªt
 < 0)

5553 
Àvñ
 = 
wc
->level;

5555  (
ªt
 == 1) ? 0 :Ñet;

5556 
	}
}

5558 
noölöe
 
	$wÆk_up_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

5559 
båfs_roŸ
 *
roŸ
,

5560 
båfs_∑th
 *
∑th
,

5561 
wÆk_c⁄åﬁ
 *
wc
, 
max_Àvñ
)

5563 
Àvñ
 = 
wc
->level;

5564 
ªt
;

5566 
∑th
->
¶Ÿs
[
Àvñ
] = 
	`båfs_hódî_ƒôems
’©h->
nodes
[level]);

5567 
Àvñ
 < 
max_Àvñ
 && 
∑th
->
nodes
[level]) {

5568 
wc
->
Àvñ
 =Üevel;

5569 i‡(
∑th
->
¶Ÿs
[
Àvñ
] + 1 <

5570 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[
Àvñ
])) {

5571 
∑th
->
¶Ÿs
[
Àvñ
]++;

5574 
ªt
 = 
	`wÆk_up_¥oc
(
å™s
, 
roŸ
, 
∑th
, 
wc
);

5575 i‡(
ªt
 > 0)

5577 i‡(
ªt
 < 0)

5578  
ªt
;

5580 i‡(
∑th
->
locks
[
Àvñ
]) {

5581 
	`båfs_åì_u∆ock_rw
(
∑th
->
nodes
[
Àvñ
],

5582 
∑th
->
locks
[
Àvñ
]);

5583 
∑th
->
locks
[
Àvñ
] = 0;

5585 
	`‰ì_exã¡_buf„r
(
∑th
->
nodes
[
Àvñ
]);

5586 
∑th
->
nodes
[
Àvñ
] = 
NULL
;

5587 
Àvñ
++;

5591 
	}
}

5606 
	$båfs_dr›_¢≠shŸ
(
båfs_roŸ
 *
roŸ
, 
upd©e_ªf
, 
f‹_ªloc
)

5608 c⁄° 
boﬁ
 
is_ªloc_roŸ
 = (
roŸ
->
roŸ_key
.
obje˘id
 ==

5609 
BTRFS_TREE_RELOC_OBJECTID
);

5610 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

5611 
båfs_∑th
 *
∑th
;

5612 
båfs_å™s_h™dÀ
 *
å™s
;

5613 
båfs_roŸ
 *
åì_roŸ
 = 
fs_öfo
->tree_root;

5614 
båfs_roŸ_ôem
 *
roŸ_ôem
 = &
roŸ
->root_item;

5615 
wÆk_c⁄åﬁ
 *
wc
;

5616 
båfs_key
 
key
;

5617 
îr
 = 0;

5618 
ªt
;

5619 
Àvñ
;

5620 
boﬁ
 
roŸ_dr›≥d
 = 
Ál£
;

5621 
boﬁ
 
unföished_dr›
 = 
Ál£
;

5623 
	`båfs_debug
(
fs_öfo
, "Dr› subvﬁumê%Œu", 
roŸ
->
roŸ_key
.
obje˘id
);

5625 
∑th
 = 
	`båfs_Æloc_∑th
();

5626 i‡(!
∑th
) {

5627 
îr
 = -
ENOMEM
;

5628 
out
;

5631 
wc
 = 
	`kzÆloc
((*wc), 
GFP_NOFS
);

5632 i‡(!
wc
) {

5633 
	`båfs_‰ì_∑th
(
∑th
);

5634 
îr
 = -
ENOMEM
;

5635 
out
;

5642 i‡(
f‹_ªloc
)

5643 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
åì_roŸ
);

5645 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
åì_roŸ
, 0);

5646 i‡(
	`IS_ERR
(
å™s
)) {

5647 
îr
 = 
	`PTR_ERR
(
å™s
);

5648 
out_‰ì
;

5651 
îr
 = 
	`båfs_run_dñayed_ôems
(
å™s
);

5652 i‡(
îr
)

5653 
out_íd_å™s
;

5663 
	`£t_bô
(
BTRFS_ROOT_DELETING
, &
roŸ
->
°©e
);

5664 
unföished_dr›
 = 
	`ã°_bô
(
BTRFS_ROOT_UNFINISHED_DROP
, &
roŸ
->
°©e
);

5666 i‡(
	`båfs_disk_key_obje˘id
(&
roŸ_ôem
->
dr›_¥ogªss
) == 0) {

5667 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
roŸ
->
node
);

5668 
∑th
->
nodes
[
Àvñ
] = 
	`båfs_lock_roŸ_node
(
roŸ
);

5669 
∑th
->
¶Ÿs
[
Àvñ
] = 0;

5670 
∑th
->
locks
[
Àvñ
] = 
BTRFS_WRITE_LOCK
;

5671 
	`mem£t
(&
wc
->
upd©e_¥ogªss
, 0,

5672 (
wc
->
upd©e_¥ogªss
));

5674 
	`båfs_disk_key_to_˝u
(&
key
, &
roŸ_ôem
->
dr›_¥ogªss
);

5675 
	`mem˝y
(&
wc
->
upd©e_¥ogªss
, &
key
,

5676 (
wc
->
upd©e_¥ogªss
));

5678 
Àvñ
 = 
	`båfs_roŸ_dr›_Àvñ
(
roŸ_ôem
);

5679 
	`BUG_ON
(
Àvñ
 == 0);

5680 
∑th
->
lowe°_Àvñ
 = 
Àvñ
;

5681 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

5682 
∑th
->
lowe°_Àvñ
 = 0;

5683 i‡(
ªt
 < 0) {

5684 
îr
 = 
ªt
;

5685 
out_íd_å™s
;

5687 
	`WARN_ON
(
ªt
 > 0);

5693 
	`båfs_u∆ock_up_ß„
(
∑th
, 0);

5695 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
roŸ
->
node
);

5697 
	`båfs_åì_lock
(
∑th
->
nodes
[
Àvñ
]);

5698 
∑th
->
locks
[
Àvñ
] = 
BTRFS_WRITE_LOCK
;

5700 
ªt
 = 
	`båfs_lookup_exã¡_öfo
(
å™s
, 
fs_öfo
,

5701 
∑th
->
nodes
[
Àvñ
]->
°¨t
,

5702 
Àvñ
, 1, &
wc
->
ªfs
[level],

5703 &
wc
->
Êags
[
Àvñ
]);

5704 i‡(
ªt
 < 0) {

5705 
îr
 = 
ªt
;

5706 
out_íd_å™s
;

5708 
	`BUG_ON
(
wc
->
ªfs
[
Àvñ
] == 0);

5710 i‡(
Àvñ
 =
	`båfs_roŸ_dr›_Àvñ
(
roŸ_ôem
))

5713 
	`båfs_åì_u∆ock
(
∑th
->
nodes
[
Àvñ
]);

5714 
∑th
->
locks
[
Àvñ
] = 0;

5715 
	`WARN_ON
(
wc
->
ªfs
[
Àvñ
] != 1);

5716 
Àvñ
--;

5720 
wc
->
ª°¨ãd
 = 
	`ã°_bô
(
BTRFS_ROOT_DEAD_TREE
, &
roŸ
->
°©e
);

5721 
wc
->
Àvñ
 =Üevel;

5722 
wc
->
sh¨ed_Àvñ
 = -1;

5723 
wc
->
°age
 = 
DROP_REFERENCE
;

5724 
wc
->
upd©e_ªf
 = update_ref;

5725 
wc
->
kìp_locks
 = 0;

5726 
wc
->
ªada_cou¡
 = 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_öfo
);

5730 
ªt
 = 
	`wÆk_down_åì
(
å™s
, 
roŸ
, 
∑th
, 
wc
);

5731 i‡(
ªt
 < 0) {

5732 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

5733 
îr
 = 
ªt
;

5737 
ªt
 = 
	`wÆk_up_åì
(
å™s
, 
roŸ
, 
∑th
, 
wc
, 
BTRFS_MAX_LEVEL
);

5738 i‡(
ªt
 < 0) {

5739 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

5740 
îr
 = 
ªt
;

5744 i‡(
ªt
 > 0) {

5745 
	`BUG_ON
(
wc
->
°age
 !
DROP_REFERENCE
);

5749 i‡(
wc
->
°age
 =
DROP_REFERENCE
) {

5750 
wc
->
dr›_Àvñ
 = wc->
Àvñ
;

5751 
	`båfs_node_key_to_˝u
(
∑th
->
nodes
[
wc
->
dr›_Àvñ
],

5752 &
wc
->
dr›_¥ogªss
,

5753 
∑th
->
¶Ÿs
[
wc
->
dr›_Àvñ
]);

5755 
	`båfs_˝u_key_to_disk
(&
roŸ_ôem
->
dr›_¥ogªss
,

5756 &
wc
->
dr›_¥ogªss
);

5757 
	`båfs_£t_roŸ_dr›_Àvñ
(
roŸ_ôem
, 
wc
->
dr›_Àvñ
);

5759 
	`BUG_ON
(
wc
->
Àvñ
 == 0);

5760 i‡(
	`båfs_should_íd_å™ß˘i⁄
(
å™s
) ||

5761 (!
f‹_ªloc
 && 
	`båfs_√ed_˛ó√r_¶ìp
(
fs_öfo
))) {

5762 
ªt
 = 
	`båfs_upd©e_roŸ
(
å™s
, 
åì_roŸ
,

5763 &
roŸ
->
roŸ_key
,

5764 
roŸ_ôem
);

5765 i‡(
ªt
) {

5766 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

5767 
îr
 = 
ªt
;

5768 
out_íd_å™s
;

5771 i‡(!
is_ªloc_roŸ
)

5772 
	`båfs_£t_œ°_roŸ_dr›_gí
(
fs_öfo
, 
å™s
->
å™sid
);

5774 
	`båfs_íd_å™ß˘i⁄_thrŸée
(
å™s
);

5775 i‡(!
f‹_ªloc
 && 
	`båfs_√ed_˛ó√r_¶ìp
(
fs_öfo
)) {

5776 
	`båfs_debug
(
fs_öfo
,

5778 
îr
 = -
EAGAIN
;

5779 
out_‰ì
;

5787 i‡(
f‹_ªloc
)

5788 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
åì_roŸ
);

5790 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
åì_roŸ
, 0);

5791 i‡(
	`IS_ERR
(
å™s
)) {

5792 
îr
 = 
	`PTR_ERR
(
å™s
);

5793 
out_‰ì
;

5797 
	`båfs_ªÀa£_∑th
(
∑th
);

5798 i‡(
îr
)

5799 
out_íd_å™s
;

5801 
ªt
 = 
	`båfs_dñ_roŸ
(
å™s
, &
roŸ
->
roŸ_key
);

5802 i‡(
ªt
) {

5803 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

5804 
îr
 = 
ªt
;

5805 
out_íd_å™s
;

5808 i‡(!
is_ªloc_roŸ
) {

5809 
ªt
 = 
	`båfs_föd_roŸ
(
åì_roŸ
, &
roŸ
->
roŸ_key
, 
∑th
,

5810 
NULL
, NULL);

5811 i‡(
ªt
 < 0) {

5812 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

5813 
îr
 = 
ªt
;

5814 
out_íd_å™s
;

5815 } i‡(
ªt
 > 0) {

5821 
	`båfs_dñ_‹ph™_ôem
(
å™s
, 
åì_roŸ
,

5822 
roŸ
->
roŸ_key
.
obje˘id
);

5831 
	`båfs_qgroup_c⁄vît_ª£rved_mëa
(
roŸ
, 
INT_MAX
);

5832 
	`båfs_qgroup_‰ì_mëa_Æl_≥πøns
(
roŸ
);

5834 i‡(
	`ã°_bô
(
BTRFS_ROOT_IN_RADIX
, &
roŸ
->
°©e
))

5835 
	`båfs_add_dr›≥d_roŸ
(
å™s
, 
roŸ
);

5837 
	`båfs_put_roŸ
(
roŸ
);

5838 
roŸ_dr›≥d
 = 
åue
;

5839 
out_íd_å™s
:

5840 i‡(!
is_ªloc_roŸ
)

5841 
	`båfs_£t_œ°_roŸ_dr›_gí
(
fs_öfo
, 
å™s
->
å™sid
);

5843 
	`båfs_íd_å™ß˘i⁄_thrŸée
(
å™s
);

5844 
out_‰ì
:

5845 
	`k‰ì
(
wc
);

5846 
	`båfs_‰ì_∑th
(
∑th
);

5847 
out
:

5852 i‡(!
îr
 && 
unföished_dr›
)

5853 
	`båfs_maybe_wake_unföished_dr›
(
fs_öfo
);

5862 i‡(!
f‹_ªloc
 && !
roŸ_dr›≥d
)

5863 
	`båfs_add_dód_roŸ
(
roŸ
);

5864  
îr
;

5865 
	}
}

5873 
	$båfs_dr›_subåì
(
båfs_å™s_h™dÀ
 *
å™s
,

5874 
båfs_roŸ
 *
roŸ
,

5875 
exã¡_buf„r
 *
node
,

5876 
exã¡_buf„r
 *
∑ª¡
)

5878 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

5879 
båfs_∑th
 *
∑th
;

5880 
wÆk_c⁄åﬁ
 *
wc
;

5881 
Àvñ
;

5882 
∑ª¡_Àvñ
;

5883 
ªt
 = 0;

5884 
wªt
;

5886 
	`BUG_ON
(
roŸ
->
roŸ_key
.
obje˘id
 !
BTRFS_TREE_RELOC_OBJECTID
);

5888 
∑th
 = 
	`båfs_Æloc_∑th
();

5889 i‡(!
∑th
)

5890  -
ENOMEM
;

5892 
wc
 = 
	`kzÆloc
((*wc), 
GFP_NOFS
);

5893 i‡(!
wc
) {

5894 
	`båfs_‰ì_∑th
(
∑th
);

5895  -
ENOMEM
;

5898 
	`båfs_as£π_åì_wrôe_locked
(
∑ª¡
);

5899 
∑ª¡_Àvñ
 = 
	`båfs_hódî_Àvñ
(
∑ª¡
);

5900 
	`©omic_öc
(&
∑ª¡
->
ªfs
);

5901 
∑th
->
nodes
[
∑ª¡_Àvñ
] = 
∑ª¡
;

5902 
∑th
->
¶Ÿs
[
∑ª¡_Àvñ
] = 
	`båfs_hódî_ƒôems
(
∑ª¡
);

5904 
	`båfs_as£π_åì_wrôe_locked
(
node
);

5905 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
node
);

5906 
∑th
->
nodes
[
Àvñ
] = 
node
;

5907 
∑th
->
¶Ÿs
[
Àvñ
] = 0;

5908 
∑th
->
locks
[
Àvñ
] = 
BTRFS_WRITE_LOCK
;

5910 
wc
->
ªfs
[
∑ª¡_Àvñ
] = 1;

5911 
wc
->
Êags
[
∑ª¡_Àvñ
] = 
BTRFS_BLOCK_FLAG_FULL_BACKREF
;

5912 
wc
->
Àvñ
 =Üevel;

5913 
wc
->
sh¨ed_Àvñ
 = -1;

5914 
wc
->
°age
 = 
DROP_REFERENCE
;

5915 
wc
->
upd©e_ªf
 = 0;

5916 
wc
->
kìp_locks
 = 1;

5917 
wc
->
ªada_cou¡
 = 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_öfo
);

5920 
wªt
 = 
	`wÆk_down_åì
(
å™s
, 
roŸ
, 
∑th
, 
wc
);

5921 i‡(
wªt
 < 0) {

5922 
ªt
 = 
wªt
;

5926 
wªt
 = 
	`wÆk_up_åì
(
å™s
, 
roŸ
, 
∑th
, 
wc
, 
∑ª¡_Àvñ
);

5927 i‡(
wªt
 < 0)

5928 
ªt
 = 
wªt
;

5929 i‡(
wªt
 != 0)

5933 
	`k‰ì
(
wc
);

5934 
	`båfs_‰ì_∑th
(
∑th
);

5935  
ªt
;

5936 
	}
}

5938 
	$båfs_îr‹_u≈ö_exã¡_ønge
(
båfs_fs_öfo
 *
fs_öfo
,

5939 
u64
 
°¨t
, u64 
íd
)

5941  
	`u≈ö_exã¡_ønge
(
fs_öfo
, 
°¨t
, 
íd
, 
Ál£
);

5942 
	}
}

5964 
	$båfs_åim_‰ì_exã¡s
(
båfs_devi˚
 *
devi˚
, 
u64
 *
åimmed
)

5966 
u64
 
°¨t
 = 
BTRFS_DEVICE_RANGE_RESERVED
, 
Àn
 = 0, 
íd
 = 0;

5967 
ªt
;

5969 *
åimmed
 = 0;

5972 i‡(!
	`bdev_max_disˇrd_£˘‹s
(
devi˚
->
bdev
))

5976 i‡(!
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
))

5980 i‡(
devi˚
->
tŸÆ_byãs
 <devi˚->
byãs_u£d
)

5983 
ªt
 = 0;

5986 
båfs_fs_öfo
 *
fs_öfo
 = 
devi˚
->fs_info;

5987 
u64
 
byãs
;

5989 
ªt
 = 
	`muãx_lock_öãºu±ibÀ
(&
fs_öfo
->
chunk_muãx
);

5990 i‡(
ªt
)

5993 
	`föd_fú°_˛ór_exã¡_bô
(&
devi˚
->
Æloc_°©e
, 
°¨t
,

5994 &
°¨t
, &
íd
,

5995 
CHUNK_TRIMMED
 | 
CHUNK_ALLOCATED
);

5998 i‡(
°¨t
 > 
devi˚
->
tŸÆ_byãs
) {

5999 
	`WARN_ON
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
));

6000 
	`båfs_w¨n_ö_rcu
(
fs_öfo
,

6002 
°¨t
, 
íd
 - start + 1,

6003 
	`båfs_dev_«me
(
devi˚
),

6004 
devi˚
->
tŸÆ_byãs
);

6005 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

6006 
ªt
 = 0;

6011 
°¨t
 = 
	`max_t
(
u64
, sèπ, 
BTRFS_DEVICE_RANGE_RESERVED
);

6018 
íd
 = 
	`mö
”nd, 
devi˚
->
tŸÆ_byãs
 - 1);

6020 
Àn
 = 
íd
 - 
°¨t
 + 1;

6023 i‡(!
Àn
) {

6024 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

6025 
ªt
 = 0;

6029 
ªt
 = 
	`båfs_issue_disˇrd
(
devi˚
->
bdev
, 
°¨t
, 
Àn
,

6030 &
byãs
);

6031 i‡(!
ªt
)

6032 
	`£t_exã¡_bô
(&
devi˚
->
Æloc_°©e
, 
°¨t
,

6033 
°¨t
 + 
byãs
 - 1, 
CHUNK_TRIMMED
, 
NULL
);

6034 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

6036 i‡(
ªt
)

6039 
°¨t
 +
Àn
;

6040 *
åimmed
 +
byãs
;

6042 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

6043 
ªt
 = -
ERESTARTSYS
;

6047 
	`c⁄d_ªsched
();

6050  
ªt
;

6051 
	}
}

6062 
	$båfs_åim_fs
(
båfs_fs_öfo
 *
fs_öfo
, 
f°rim_ønge
 *
ønge
)

6064 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

6065 
båfs_block_group
 *
ˇche
 = 
NULL
;

6066 
båfs_devi˚
 *
devi˚
;

6067 
u64
 
group_åimmed
;

6068 
u64
 
ønge_íd
 = 
U64_MAX
;

6069 
u64
 
°¨t
;

6070 
u64
 
íd
;

6071 
u64
 
åimmed
 = 0;

6072 
u64
 
bg_Áûed
 = 0;

6073 
u64
 
dev_Áûed
 = 0;

6074 
bg_ªt
 = 0;

6075 
dev_ªt
 = 0;

6076 
ªt
 = 0;

6078 i‡(
ønge
->
°¨t
 =
U64_MAX
)

6079  -
EINVAL
;

6085 i‡(
ønge
->
Àn
 !
U64_MAX
 &&

6086 
	`check_add_ovîÊow
(
ønge
->
°¨t
,Ñ™ge->
Àn
, &
ønge_íd
))

6087  -
EINVAL
;

6089 
ˇche
 = 
	`båfs_lookup_fú°_block_group
(
fs_öfo
, 
ønge
->
°¨t
);

6090 ; 
ˇche
; cachê
	`båfs_√xt_block_group
(cache)) {

6091 i‡(
ˇche
->
°¨t
 >
ønge_íd
) {

6092 
	`båfs_put_block_group
(
ˇche
);

6096 
°¨t
 = 
	`max
(
ønge
->°¨t, 
ˇche
->start);

6097 
íd
 = 
	`mö
(
ønge_íd
, 
ˇche
->
°¨t
 + cache->
Àngth
);

6099 i‡(
íd
 - 
°¨t
 >
ønge
->
möÀn
) {

6100 i‡(!
	`båfs_block_group_d⁄e
(
ˇche
)) {

6101 
ªt
 = 
	`båfs_ˇche_block_group
(
ˇche
, 
åue
);

6102 i‡(
ªt
) {

6103 
bg_Áûed
++;

6104 
bg_ªt
 = 
ªt
;

6108 
ªt
 = 
	`båfs_åim_block_group
(
ˇche
,

6109 &
group_åimmed
,

6110 
°¨t
,

6111 
íd
,

6112 
ønge
->
möÀn
);

6114 
åimmed
 +
group_åimmed
;

6115 i‡(
ªt
) {

6116 
bg_Áûed
++;

6117 
bg_ªt
 = 
ªt
;

6123 i‡(
bg_Áûed
)

6124 
	`båfs_w¨n
(
fs_öfo
,

6126 
bg_Áûed
, 
bg_ªt
);

6128 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

6129 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

6130 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
, &
devi˚
->
dev_°©e
))

6133 
ªt
 = 
	`båfs_åim_‰ì_exã¡s
(
devi˚
, &
group_åimmed
);

6134 i‡(
ªt
) {

6135 
dev_Áûed
++;

6136 
dev_ªt
 = 
ªt
;

6140 
åimmed
 +
group_åimmed
;

6142 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

6144 i‡(
dev_Áûed
)

6145 
	`båfs_w¨n
(
fs_öfo
,

6147 
dev_Áûed
, 
dev_ªt
);

6148 
ønge
->
Àn
 = 
åimmed
;

6149 i‡(
bg_ªt
)

6150  
bg_ªt
;

6151  
dev_ªt
;

6152 
	}
}

	@extent-tree.h

3 #i‚de‡
BTRFS_EXTENT_TREE_H


4 
	#BTRFS_EXTENT_TREE_H


	)

6 
	~"misc.h
"

7 
	~"block-group.h
"

9 
	gbåfs_‰ì_˛u°î
;

11 
	ebåfs_exã¡_Æloˇti⁄_pﬁicy
 {

12 
	mBTRFS_EXTENT_ALLOC_CLUSTERED
,

13 
	mBTRFS_EXTENT_ALLOC_ZONED
,

16 
	sföd_‰ì_exã¡_˘l
 {

18 
u64
 
	møm_byãs
;

19 
u64
 
	mnum_byãs
;

20 
u64
 
	mmö_Æloc_size
;

21 
u64
 
	mem±y_size
;

22 
u64
 
	mÊags
;

23 
	mdñÆloc
;

26 
u64
 
	m£¨ch_°¨t
;

29 
u64
 
	mem±y_˛u°î
;

30 
båfs_‰ì_˛u°î
 *
	mœ°_±r
;

31 
boﬁ
 
	mu£_˛u°î
;

33 
boﬁ
 
	mhave_ˇchög_bg
;

34 
boﬁ
 
	m‹ig_have_ˇchög_bg
;

37 
boﬁ
 
	mf‹_åìlog
;

40 
boﬁ
 
	mf‹_d©a_ªloc
;

43 
	mödex
;

48 
	mlo›
;

55 
boﬁ
 
	mªåy_unˇched
;

58 
	mˇched
;

61 
u64
 
	mmax_exã¡_size
;

64 
u64
 
	mtŸÆ_‰ì_•a˚
;

67 
u64
 
	mfound_off£t
;

70 
u64
 
	mhöt_byã
;

73 
båfs_exã¡_Æloˇti⁄_pﬁicy
 
	mpﬁicy
;

76 
boﬁ
 
	mhöãd
;

79 
båfs_block_group_size_˛ass
 
	msize_˛ass
;

82 
	ebåfs_ölöe_ªf_ty≥
 {

83 
	mBTRFS_REF_TYPE_INVALID
,

84 
	mBTRFS_REF_TYPE_BLOCK
,

85 
	mBTRFS_REF_TYPE_DATA
,

86 
	mBTRFS_REF_TYPE_ANY
,

89 
båfs_gë_exã¡_ölöe_ªf_ty≥
(c⁄° 
exã¡_buf„r
 *
eb
,

90 
båfs_exã¡_ölöe_ªf
 *
úef
,

91 
båfs_ölöe_ªf_ty≥
 
is_d©a
);

92 
u64
 
hash_exã¡_d©a_ªf
(u64 
roŸ_obje˘id
, u64 
ow√r
, u64 
off£t
);

94 
båfs_run_dñayed_ªfs
(
båfs_å™s_h™dÀ
 *
å™s
, 
cou¡
);

95 
båfs_˛ónup_ªf_hód_accou¡ög
(
båfs_fs_öfo
 *
fs_öfo
,

96 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
,

97 
båfs_dñayed_ªf_hód
 *
hód
);

98 
båfs_lookup_d©a_exã¡
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
°¨t
, u64 
Àn
);

99 
båfs_lookup_exã¡_öfo
(
båfs_å™s_h™dÀ
 *
å™s
,

100 
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
byãƒ
,

101 
u64
 
off£t
, 
mëad©a
, u64 *
ªfs
, u64 *
Êags
);

102 
båfs_pö_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
byãƒ
, u64 
num
,

103 
ª£rved
);

104 
båfs_pö_exã¡_f‹_log_ª∂ay
(
båfs_å™s_h™dÀ
 *
å™s
,

105 
u64
 
byãƒ
, u64 
num_byãs
);

106 
båfs_ex˛ude_logged_exã¡s
(
exã¡_buf„r
 *
eb
);

107 
båfs_¸oss_ªf_exi°
(
båfs_roŸ
 *
roŸ
,

108 
u64
 
obje˘id
, u64 
off£t
, u64 
byãƒ
, 
boﬁ
 
°ri˘
,

109 
båfs_∑th
 *
∑th
);

110 
exã¡_buf„r
 *
båfs_Æloc_åì_block
(
båfs_å™s_h™dÀ
 *
å™s
,

111 
båfs_roŸ
 *
roŸ
,

112 
u64
 
∑ª¡
, u64 
roŸ_obje˘id
,

113 c⁄° 
båfs_disk_key
 *
key
,

114 
Àvñ
, 
u64
 
höt
,

115 
u64
 
em±y_size
,

116 
båfs_lock_√°ög
 
√°
);

117 
båfs_‰ì_åì_block
(
båfs_å™s_h™dÀ
 *
å™s
,

118 
u64
 
roŸ_id
,

119 
exã¡_buf„r
 *
buf
,

120 
u64
 
∑ª¡
, 
œ°_ªf
);

121 
båfs_Æloc_ª£rved_fûe_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

122 
båfs_roŸ
 *
roŸ
, 
u64
 
ow√r
,

123 
u64
 
off£t
, u64 
øm_byãs
,

124 
båfs_key
 *
ös
);

125 
båfs_Æloc_logged_fûe_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

126 
u64
 
roŸ_obje˘id
, u64 
ow√r
, u64 
off£t
,

127 
båfs_key
 *
ös
);

128 
båfs_ª£rve_exã¡
(
båfs_roŸ
 *
roŸ
, 
u64
 
øm_byãs
, u64 
num_byãs
,

129 
u64
 
mö_Æloc_size
, u64 
em±y_size
, u64 
höt_byã
,

130 
båfs_key
 *
ös
, 
is_d©a
, 
dñÆloc
);

131 
båfs_öc_ªf
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
,

132 
exã¡_buf„r
 *
buf
, 
fuŒ_backªf
);

133 
båfs_dec_ªf
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
,

134 
exã¡_buf„r
 *
buf
, 
fuŒ_backªf
);

135 
båfs_£t_disk_exã¡_Êags
(
båfs_å™s_h™dÀ
 *
å™s
,

136 
exã¡_buf„r
 *
eb
, 
u64
 
Êags
);

137 
båfs_‰ì_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_ªf
 *
ªf
);

139 
båfs_‰ì_ª£rved_exã¡
(
båfs_fs_öfo
 *
fs_öfo
,

140 
u64
 
°¨t
, u64 
Àn
, 
dñÆloc
);

141 
båfs_pö_ª£rved_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
°¨t
, u64 
Àn
);

142 
båfs_föish_exã¡_commô
(
båfs_å™s_h™dÀ
 *
å™s
);

143 
båfs_öc_exã¡_ªf
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_ªf
 *
gíîic_ªf
);

144 
__mu°_check
 
båfs_dr›_¢≠shŸ
(
båfs_roŸ
 *
roŸ
, 
upd©e_ªf
,

145 
f‹_ªloc
);

146 
båfs_dr›_subåì
(
båfs_å™s_h™dÀ
 *
å™s
,

147 
båfs_roŸ
 *
roŸ
,

148 
exã¡_buf„r
 *
node
,

149 
exã¡_buf„r
 *
∑ª¡
);

	@extent_io.c

3 
	~<löux/bô›s.h
>

4 
	~<löux/¶ab.h
>

5 
	~<löux/bio.h
>

6 
	~<löux/mm.h
>

7 
	~<löux/∑gem≠.h
>

8 
	~<löux/∑ge-Êags.h
>

9 
	~<löux/sched/mm.h
>

10 
	~<löux/•ölock.h
>

11 
	~<löux/blkdev.h
>

12 
	~<löux/sw≠.h
>

13 
	~<löux/wrôeback.h
>

14 
	~<löux/∑gevec.h
>

15 
	~<löux/¥e„tch.h
>

16 
	~<löux/fsvîôy.h
>

17 
	~"misc.h
"

18 
	~"exã¡_io.h
"

19 
	~"exã¡-io-åì.h
"

20 
	~"exã¡_m≠.h
"

21 
	~"˘ªe.h
"

22 
	~"båfs_öode.h
"

23 
	~"bio.h
"

24 
	~"check-öãgrôy.h
"

25 
	~"lockög.h
"

26 
	~"rcu-°rög.h
"

27 
	~"backªf.h
"

28 
	~"disk-io.h
"

29 
	~"sub∑ge.h
"

30 
	~"z⁄ed.h
"

31 
	~"block-group.h
"

32 
	~"com¥essi⁄.h
"

33 
	~"fs.h
"

34 
	~"ac˚ss‹s.h
"

35 
	~"fûe-ôem.h
"

36 
	~"fûe.h
"

37 
	~"dev-ª∂a˚.h
"

38 
	~"su≥r.h
"

39 
	~"å™ß˘i⁄.h
"

41 
kmem_ˇche
 *
	gexã¡_buf„r_ˇche
;

43 #ifde‡
CONFIG_BTRFS_DEBUG


44 
ölöe
 
	$båfs_Àak_debug_add_eb
(
exã¡_buf„r
 *
eb
)

46 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

47 
Êags
;

49 
	`•ö_lock_úqßve
(&
fs_öfo
->
eb_Àak_lock
, 
Êags
);

50 
	`li°_add
(&
eb
->
Àak_li°
, &
fs_öfo
->
Æloˇãd_ebs
);

51 
	`•ö_u∆ock_úqª°‹e
(&
fs_öfo
->
eb_Àak_lock
, 
Êags
);

52 
	}
}

54 
ölöe
 
	$båfs_Àak_debug_dñ_eb
(
exã¡_buf„r
 *
eb
)

56 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

57 
Êags
;

59 
	`•ö_lock_úqßve
(&
fs_öfo
->
eb_Àak_lock
, 
Êags
);

60 
	`li°_dñ
(&
eb
->
Àak_li°
);

61 
	`•ö_u∆ock_úqª°‹e
(&
fs_öfo
->
eb_Àak_lock
, 
Êags
);

62 
	}
}

64 
	$båfs_exã¡_buf„r_Àak_debug_check
(
båfs_fs_öfo
 *
fs_öfo
)

66 
exã¡_buf„r
 *
eb
;

67 
Êags
;

73 i‡(!
fs_öfo
->
Æloˇãd_ebs
.
√xt
)

76 
	`WARN_ON
(!
	`li°_em±y
(&
fs_öfo
->
Æloˇãd_ebs
));

77 
	`•ö_lock_úqßve
(&
fs_öfo
->
eb_Àak_lock
, 
Êags
);

78 !
	`li°_em±y
(&
fs_öfo
->
Æloˇãd_ebs
)) {

79 
eb
 = 
	`li°_fú°_íåy
(&
fs_öfo
->
Æloˇãd_ebs
,

80 
exã¡_buf„r
, 
Àak_li°
);

81 
	`¥_îr
(

83 
eb
->
°¨t
,Éb->
Àn
, 
	`©omic_ªad
(&eb->
ªfs
),Éb->
bÊags
,

84 
	`båfs_hódî_ow√r
(
eb
));

85 
	`li°_dñ
(&
eb
->
Àak_li°
);

86 
	`kmem_ˇche_‰ì
(
exã¡_buf„r_ˇche
, 
eb
);

88 
	`•ö_u∆ock_úqª°‹e
(&
fs_öfo
->
eb_Àak_lock
, 
Êags
);

89 
	}
}

91 
	#båfs_Àak_debug_add_eb
(
eb
Ëdÿ{} 0)

	)

92 
	#båfs_Àak_debug_dñ_eb
(
eb
Ëdÿ{} 0)

	)

99 
	sbåfs_bio_˘æ
 {

100 
båfs_bio
 *
	mbbio
;

101 
båfs_com¥essi⁄_ty≥
 
	mcom¥ess_ty≥
;

102 
u32
 
	mÀn_to_€_bound¨y
;

103 
blk_›f_t
 
	m›f
;

104 
båfs_bio_íd_io_t
 
	míd_io_func
;

105 
wrôeback_c⁄åﬁ
 *
	mwbc
;

108 
	$submô_⁄e_bio
(
båfs_bio_˘æ
 *
bio_˘æ
)

110 
båfs_bio
 *
bbio
 = 
bio_˘æ
->bbio;

112 i‡(!
bbio
)

116 
	`ASSERT
(
bbio
->
bio
.
bi_ôî
.
bi_size
);

118 i‡(
	`båfs_›
(&
bbio
->
bio
Ë=
BTRFS_MAP_READ
 &&

119 
bio_˘æ
->
com¥ess_ty≥
 !
BTRFS_COMPRESS_NONE
)

120 
	`båfs_submô_com¥es£d_ªad
(
bbio
);

122 
	`båfs_submô_bio
(
bbio
, 0);

125 
bio_˘æ
->
bbio
 = 
NULL
;

126 
	}
}

131 
	$submô_wrôe_bio
(
båfs_bio_˘æ
 *
bio_˘æ
, 
ªt
)

133 
båfs_bio
 *
bbio
 = 
bio_˘æ
->bbio;

135 i‡(!
bbio
)

138 i‡(
ªt
) {

139 
	`ASSERT
(
ªt
 < 0);

140 
	`båfs_bio_íd_io
(
bbio
, 
	`î∫o_to_blk_°©us
(
ªt
));

142 
bio_˘æ
->
bbio
 = 
NULL
;

144 
	`submô_⁄e_bio
(
bio_˘æ
);

146 
	}
}

148 
__öô
 
	$exã¡_buf„r_öô_ˇchï
()

150 
exã¡_buf„r_ˇche
 = 
	`kmem_ˇche_¸óã
("btrfs_extent_buffer",

151 (
exã¡_buf„r
), 0,

152 
SLAB_MEM_SPREAD
, 
NULL
);

153 i‡(!
exã¡_buf„r_ˇche
)

154  -
ENOMEM
;

157 
	}
}

159 
__cﬁd
 
	$exã¡_buf„r_‰ì_ˇchï
()

165 
	`rcu_b¨rõr
();

166 
	`kmem_ˇche_de°roy
(
exã¡_buf„r_ˇche
);

167 
	}
}

169 
	$exã¡_ønge_˛ór_dúty_f‹_io
(
öode
 *öode, 
u64
 
°¨t
, u64 
íd
)

171 
ödex
 = 
°¨t
 >> 
PAGE_SHIFT
;

172 
íd_ödex
 = 
íd
 >> 
PAGE_SHIFT
;

173 
∑ge
 *page;

175 
ödex
 <
íd_ödex
) {

176 
∑ge
 = 
	`föd_gë_∑ge
(
öode
->
i_m≠pög
, 
ödex
);

177 
	`BUG_ON
(!
∑ge
);

178 
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
);

179 
	`put_∑ge
(
∑ge
);

180 
ödex
++;

182 
	}
}

184 
	$¥o˚ss_⁄e_∑ge
(
båfs_fs_öfo
 *
fs_öfo
,

185 
∑ge
 *∑ge, ∑gê*
locked_∑ge
,

186 
∑ge_›s
, 
u64
 
°¨t
, u64 
íd
)

188 
u32
 
Àn
;

190 
	`ASSERT
(
íd
 + 1 - 
°¨t
 !0 &&Énd + 1 - sèπ < 
U32_MAX
);

191 
Àn
 = 
íd
 + 1 - 
°¨t
;

193 i‡(
∑ge_›s
 & 
PAGE_SET_ORDERED
)

194 
	`båfs_∑ge_˛amp_£t_‹dîed
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

195 i‡(
∑ge_›s
 & 
PAGE_START_WRITEBACK
) {

196 
	`båfs_∑ge_˛amp_˛ór_dúty
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

197 
	`båfs_∑ge_˛amp_£t_wrôeback
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

199 i‡(
∑ge_›s
 & 
PAGE_END_WRITEBACK
)

200 
	`båfs_∑ge_˛amp_˛ór_wrôeback
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

202 i‡(
∑ge
 !
locked_∑ge
 && (
∑ge_›s
 & 
PAGE_UNLOCK
))

203 
	`båfs_∑ge_íd_wrôî_lock
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

204 
	}
}

206 
	$__¥o˚ss_∑ges_c⁄tig
(
addªss_•a˚
 *
m≠pög
,

207 
∑ge
 *
locked_∑ge
, 
u64
 
°¨t
, u64 
íd
,

208 
∑ge_›s
)

210 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
m≠pög
->
ho°
->
i_sb
);

211 
pgoff_t
 
°¨t_ödex
 = 
°¨t
 >> 
PAGE_SHIFT
;

212 
pgoff_t
 
íd_ödex
 = 
íd
 >> 
PAGE_SHIFT
;

213 
pgoff_t
 
ödex
 = 
°¨t_ödex
;

214 
fﬁio_b©ch
 
fb©ch
;

215 
i
;

217 
	`fﬁio_b©ch_öô
(&
fb©ch
);

218 
ödex
 <
íd_ödex
) {

219 
found_fﬁios
;

221 
found_fﬁios
 = 
	`fûem≠_gë_fﬁios_c⁄tig
(
m≠pög
, &
ödex
,

222 
íd_ödex
, &
fb©ch
);

223 
i
 = 0; i < 
found_fﬁios
; i++) {

224 
fﬁio
 *fﬁiÿ
fb©ch
.
fﬁios
[
i
];

226 
	`¥o˚ss_⁄e_∑ge
(
fs_öfo
, &
fﬁio
->
∑ge
, 
locked_∑ge
,

227 
∑ge_›s
, 
°¨t
, 
íd
);

229 
	`fﬁio_b©ch_ªÀa£
(&
fb©ch
);

230 
	`c⁄d_ªsched
();

232 
	}
}

234 
noölöe
 
	$__u∆ock_f‹_dñÆloc
(
öode
 *inode,

235 
∑ge
 *
locked_∑ge
,

236 
u64
 
°¨t
, u64 
íd
)

238 
ödex
 = 
°¨t
 >> 
PAGE_SHIFT
;

239 
íd_ödex
 = 
íd
 >> 
PAGE_SHIFT
;

241 
	`ASSERT
(
locked_∑ge
);

242 i‡(
ödex
 =
locked_∑ge
->ödex && 
íd_ödex
 == index)

245 
	`__¥o˚ss_∑ges_c⁄tig
(
öode
->
i_m≠pög
, 
locked_∑ge
, 
°¨t
, 
íd
,

246 
PAGE_UNLOCK
);

247 
	}
}

249 
noölöe
 
	$lock_dñÆloc_∑ges
(
öode
 *inode,

250 
∑ge
 *
locked_∑ge
,

251 
u64
 
°¨t
,

252 
u64
 
íd
)

254 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

255 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

256 
pgoff_t
 
°¨t_ödex
 = 
°¨t
 >> 
PAGE_SHIFT
;

257 
pgoff_t
 
íd_ödex
 = 
íd
 >> 
PAGE_SHIFT
;

258 
pgoff_t
 
ödex
 = 
°¨t_ödex
;

259 
u64
 
¥o˚s£d_íd
 = 
°¨t
;

260 
fﬁio_b©ch
 
fb©ch
;

262 i‡(
ödex
 =
locked_∑ge
->ödex && index =
íd_ödex
)

265 
	`fﬁio_b©ch_öô
(&
fb©ch
);

266 
ödex
 <
íd_ödex
) {

267 
found_fﬁios
, 
i
;

269 
found_fﬁios
 = 
	`fûem≠_gë_fﬁios_c⁄tig
(
m≠pög
, &
ödex
,

270 
íd_ödex
, &
fb©ch
);

271 i‡(
found_fﬁios
 == 0)

272 
out
;

274 
i
 = 0; i < 
found_fﬁios
; i++) {

275 
∑ge
 *∑gê&
fb©ch
.
fﬁios
[
i
]->page;

276 
u32
 
Àn
 = 
íd
 + 1 - 
°¨t
;

278 i‡(
∑ge
 =
locked_∑ge
)

281 i‡(
	`båfs_∑ge_°¨t_wrôî_lock
(
fs_öfo
, 
∑ge
, 
°¨t
,

282 
Àn
))

283 
out
;

285 i‡(!
	`PageDúty
(
∑ge
Ë||Öage->
m≠pög
 != mapping) {

286 
	`båfs_∑ge_íd_wrôî_lock
(
fs_öfo
, 
∑ge
, 
°¨t
,

287 
Àn
);

288 
out
;

291 
¥o˚s£d_íd
 = 
	`∑ge_off£t
(
∑ge
Ë+ 
PAGE_SIZE
 - 1;

293 
	`fﬁio_b©ch_ªÀa£
(&
fb©ch
);

294 
	`c⁄d_ªsched
();

298 
out
:

299 
	`fﬁio_b©ch_ªÀa£
(&
fb©ch
);

300 i‡(
¥o˚s£d_íd
 > 
°¨t
)

301 
	`__u∆ock_f‹_dñÆloc
(
öode
, 
locked_∑ge
, 
°¨t
, 
¥o˚s£d_íd
);

302  -
EAGAIN
;

303 
	}
}

320 
EXPORT_FOR_TESTS


321 
noölöe_f‹_°ack
 
boﬁ
 
	$föd_lock_dñÆloc_ønge
(
öode
 *inode,

322 
∑ge
 *
locked_∑ge
, 
u64
 *
°¨t
,

323 
u64
 *
íd
)

325 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

326 
exã¡_io_åì
 *
åì
 = &
	`BTRFS_I
(
öode
)->
io_åì
;

327 c⁄° 
u64
 
‹ig_°¨t
 = *
°¨t
;

328 c⁄° 
u64
 
‹ig_íd
 = *
íd
;

330 
u64
 
max_byãs
 = 
fs_öfo
 ? fs_öfo->
max_exã¡_size
 : 
BTRFS_MAX_EXTENT_SIZE
;

331 
u64
 
dñÆloc_°¨t
;

332 
u64
 
dñÆloc_íd
;

333 
boﬁ
 
found
;

334 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

335 
ªt
;

336 
lo›s
 = 0;

339 
	`ASSERT
(
‹ig_íd
 > 
‹ig_°¨t
);

342 
	`ASSERT
(!(
‹ig_°¨t
 >
	`∑ge_off£t
(
locked_∑ge
Ë+ 
PAGE_SIZE
 ||

343 
‹ig_íd
 <
	`∑ge_off£t
(
locked_∑ge
)));

344 
agaö
:

346 
dñÆloc_°¨t
 = *
°¨t
;

347 
dñÆloc_íd
 = 0;

348 
found
 = 
	`båfs_föd_dñÆloc_ønge
(
åì
, &
dñÆloc_°¨t
, &
dñÆloc_íd
,

349 
max_byãs
, &
ˇched_°©e
);

350 i‡(!
found
 || 
dñÆloc_íd
 <*
°¨t
 || 
dñÆloc_°¨t
 > 
‹ig_íd
) {

351 *
°¨t
 = 
dñÆloc_°¨t
;

354 *
íd
 = 
	`mö
(
dñÆloc_íd
, 
‹ig_íd
);

355 
	`‰ì_exã¡_°©e
(
ˇched_°©e
);

356  
Ál£
;

364 i‡(
dñÆloc_°¨t
 < *
°¨t
)

365 
dñÆloc_°¨t
 = *
°¨t
;

370 i‡(
dñÆloc_íd
 + 1 - 
dñÆloc_°¨t
 > 
max_byãs
)

371 
dñÆloc_íd
 = 
dñÆloc_°¨t
 + 
max_byãs
 - 1;

374 
ªt
 = 
	`lock_dñÆloc_∑ges
(
öode
, 
locked_∑ge
,

375 
dñÆloc_°¨t
, 
dñÆloc_íd
);

376 
	`ASSERT
(!
ªt
 ||Ñë =-
EAGAIN
);

377 i‡(
ªt
 =-
EAGAIN
) {

381 
	`‰ì_exã¡_°©e
(
ˇched_°©e
);

382 
ˇched_°©e
 = 
NULL
;

383 i‡(!
lo›s
) {

384 
max_byãs
 = 
PAGE_SIZE
;

385 
lo›s
 = 1;

386 
agaö
;

388 
found
 = 
Ál£
;

389 
out_Áûed
;

394 
	`lock_exã¡
(
åì
, 
dñÆloc_°¨t
, 
dñÆloc_íd
, &
ˇched_°©e
);

397 
ªt
 = 
	`ã°_ønge_bô
(
åì
, 
dñÆloc_°¨t
, 
dñÆloc_íd
,

398 
EXTENT_DELALLOC
, 1, 
ˇched_°©e
);

399 i‡(!
ªt
) {

400 
	`u∆ock_exã¡
(
åì
, 
dñÆloc_°¨t
, 
dñÆloc_íd
,

401 &
ˇched_°©e
);

402 
	`__u∆ock_f‹_dñÆloc
(
öode
, 
locked_∑ge
,

403 
dñÆloc_°¨t
, 
dñÆloc_íd
);

404 
	`c⁄d_ªsched
();

405 
agaö
;

407 
	`‰ì_exã¡_°©e
(
ˇched_°©e
);

408 *
°¨t
 = 
dñÆloc_°¨t
;

409 *
íd
 = 
dñÆloc_íd
;

410 
out_Áûed
:

411  
found
;

412 
	}
}

414 
	$exã¡_˛ór_u∆ock_dñÆloc
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
,

415 
∑ge
 *
locked_∑ge
,

416 
u32
 
˛ór_bôs
, 
∑ge_›s
)

418 
	`˛ór_exã¡_bô
(&
öode
->
io_åì
, 
°¨t
, 
íd
, 
˛ór_bôs
, 
NULL
);

420 
	`__¥o˚ss_∑ges_c⁄tig
(
öode
->
vfs_öode
.
i_m≠pög
, 
locked_∑ge
,

421 
°¨t
, 
íd
, 
∑ge_›s
);

422 
	}
}

424 
boﬁ
 
	$båfs_vîify_∑ge
(
∑ge
 *∑ge, 
u64
 
°¨t
)

426 i‡(!
	`fsvîôy_a˘ive
(
∑ge
->
m≠pög
->
ho°
) ||

427 
	`PageU±od©e
(
∑ge
) ||

428 
°¨t
 >
	`i_size_ªad
(
∑ge
->
m≠pög
->
ho°
))

429  
åue
;

430  
	`fsvîôy_vîify_∑ge
(
∑ge
);

431 
	}
}

433 
	$íd_∑ge_ªad
(
∑ge
 *∑ge, 
boﬁ
 
u±od©e
, 
u64
 
°¨t
, 
u32
 
Àn
)

435 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
∑ge
->
m≠pög
->
ho°
->
i_sb
);

437 
	`ASSERT
(
	`∑ge_off£t
(
∑ge
Ë<
°¨t
 &&

438 
°¨t
 + 
Àn
 <
	`∑ge_off£t
(
∑ge
Ë+ 
PAGE_SIZE
);

440 i‡(
u±od©e
 && 
	`båfs_vîify_∑ge
(
∑ge
, 
°¨t
))

441 
	`båfs_∑ge_£t_u±od©e
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

443 
	`båfs_∑ge_˛ór_u±od©e
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

445 i‡(!
	`båfs_is_sub∑ge
(
fs_öfo
, 
∑ge
))

446 
	`u∆ock_∑ge
(
∑ge
);

448 
	`båfs_sub∑ge_íd_ªadî
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

449 
	}
}

460 
	$íd_bio_exã¡_wrôïage
(
båfs_bio
 *
bbio
)

462 
bio
 *biÿ&
bbio
->bio;

463 
îr‹
 = 
	`blk_°©us_to_î∫o
(
bio
->
bi_°©us
);

464 
bio_vec
 *
bvec
;

465 
bvec_ôî_Æl
 
ôî_Æl
;

467 
	`ASSERT
(!
	`bio_Êagged
(
bio
, 
BIO_CLONED
));

468 
	`bio_f‹_óch_£gmít_Æl
(
bvec
, 
bio
, 
ôî_Æl
) {

469 
∑ge
 *∑gê
bvec
->
bv_∑ge
;

470 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

471 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

472 c⁄° 
u32
 
£˘‹size
 = 
fs_öfo
->sectorsize;

473 
u64
 
°¨t
 = 
	`∑ge_off£t
(
∑ge
Ë+ 
bvec
->
bv_off£t
;

474 
u32
 
Àn
 = 
bvec
->
bv_Àn
;

477 i‡(!
	`IS_ALIGNED
(
bvec
->
bv_off£t
, 
£˘‹size
))

478 
	`båfs_îr
(
fs_öfo
,

480 
bvec
->
bv_off£t
, bvec->
bv_Àn
);

481 i‡(!
	`IS_ALIGNED
(
bvec
->
bv_Àn
, 
£˘‹size
))

482 
	`båfs_öfo
(
fs_öfo
,

484 
bvec
->
bv_off£t
, bvec->
bv_Àn
);

486 
	`båfs_föish_‹dîed_exã¡
(
bbio
->
‹dîed
, 
∑ge
, 
°¨t
, 
Àn
, !
îr‹
);

487 i‡(
îr‹
)

488 
	`m≠pög_£t_îr‹
(
∑ge
->
m≠pög
, 
îr‹
);

489 
	`båfs_∑ge_˛ór_wrôeback
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

492 
	`bio_put
(
bio
);

493 
	}
}

501 
	s¥o˚s£d_exã¡
 {

502 
båfs_öode
 *
	möode
;

504 
u64
 
	m°¨t
;

506 
u64
 
	míd
;

507 
boﬁ
 
	mu±od©e
;

521 
	$ídio_ªad∑ge_ªÀa£_exã¡
(
¥o˚s£d_exã¡
 *
¥o˚s£d
,

522 
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
,

523 
boﬁ
 
u±od©e
)

525 
exã¡_°©e
 *
ˇched
 = 
NULL
;

526 
exã¡_io_åì
 *
åì
;

529 i‡(!
¥o˚s£d
->
öode
)

530 
upd©e
;

543 i‡(
¥o˚s£d
->
öode
 =öodê&&Öro˚s£d->
u±od©e
 == uptodate &&

544 
¥o˚s£d
->
íd
 + 1 >
°¨t
 &&Énd >=Örocessed->end) {

545 
¥o˚s£d
->
íd
 =Énd;

549 
åì
 = &
¥o˚s£d
->
öode
->
io_åì
;

554 
	`u∆ock_exã¡
(
åì
, 
¥o˚s£d
->
°¨t
,Öro˚s£d->
íd
, &
ˇched
);

556 
upd©e
:

558 
¥o˚s£d
->
öode
 = inode;

559 
¥o˚s£d
->
°¨t
 = start;

560 
¥o˚s£d
->
íd
 =Énd;

561 
¥o˚s£d
->
u±od©e
 = uptodate;

562 
	}
}

564 
	$begö_∑ge_ªad
(
båfs_fs_öfo
 *
fs_öfo
, 
∑ge
 *page)

566 
	`ASSERT
(
	`PageLocked
(
∑ge
));

567 i‡(!
	`båfs_is_sub∑ge
(
fs_öfo
, 
∑ge
))

570 
	`ASSERT
(
	`PagePriv©e
(
∑ge
));

571 
	`båfs_sub∑ge_°¨t_ªadî
(
fs_öfo
, 
∑ge
, 
	`∑ge_off£t
’age), 
PAGE_SIZE
);

572 
	}
}

585 
	$íd_bio_exã¡_ªad∑ge
(
båfs_bio
 *
bbio
)

587 
bio
 *biÿ&
bbio
->bio;

588 
bio_vec
 *
bvec
;

589 
¥o˚s£d_exã¡
 
¥o˚s£d
 = { 0 };

594 
u32
 
bio_off£t
 = 0;

595 
bvec_ôî_Æl
 
ôî_Æl
;

597 
	`ASSERT
(!
	`bio_Êagged
(
bio
, 
BIO_CLONED
));

598 
	`bio_f‹_óch_£gmít_Æl
(
bvec
, 
bio
, 
ôî_Æl
) {

599 
boﬁ
 
u±od©e
 = !
bio
->
bi_°©us
;

600 
∑ge
 *∑gê
bvec
->
bv_∑ge
;

601 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

602 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

603 c⁄° 
u32
 
£˘‹size
 = 
fs_öfo
->sectorsize;

604 
u64
 
°¨t
;

605 
u64
 
íd
;

606 
u32
 
Àn
;

608 
	`båfs_debug
(
fs_öfo
,

610 
bio
->
bi_ôî
.
bi_£˘‹
, bio->
bi_°©us
,

611 
bbio
->
múr‹_num
);

620 i‡(!
	`IS_ALIGNED
(
bvec
->
bv_off£t
, 
£˘‹size
))

621 
	`båfs_îr
(
fs_öfo
,

623 
bvec
->
bv_off£t
, bvec->
bv_Àn
);

624 i‡(!
	`IS_ALIGNED
(
bvec
->
bv_off£t
 + bvec->
bv_Àn
,

625 
£˘‹size
))

626 
	`båfs_öfo
(
fs_öfo
,

628 
bvec
->
bv_off£t
, bvec->
bv_Àn
);

630 
°¨t
 = 
	`∑ge_off£t
(
∑ge
Ë+ 
bvec
->
bv_off£t
;

631 
íd
 = 
°¨t
 + 
bvec
->
bv_Àn
 - 1;

632 
Àn
 = 
bvec
->
bv_Àn
;

634 i‡(
	`likñy
(
u±od©e
)) {

635 
loff_t
 
i_size
 = 
	`i_size_ªad
(
öode
);

636 
pgoff_t
 
íd_ödex
 = 
i_size
 >> 
PAGE_SHIFT
;

647 i‡(
∑ge
->
ödex
 =
íd_ödex
 && 
i_size
 <
íd
) {

648 
u32
 
zîo_°¨t
 = 
	`max
(
	`off£t_ö_∑ge
(
i_size
),

649 
	`off£t_ö_∑ge
(
°¨t
));

651 
	`zîo_u£r_£gmít
(
∑ge
, 
zîo_°¨t
,

652 
	`off£t_ö_∑ge
(
íd
) + 1);

657 
	`íd_∑ge_ªad
(
∑ge
, 
u±od©e
, 
°¨t
, 
Àn
);

658 
	`ídio_ªad∑ge_ªÀa£_exã¡
(&
¥o˚s£d
, 
	`BTRFS_I
(
öode
),

659 
°¨t
, 
íd
, 
u±od©e
);

661 
	`ASSERT
(
bio_off£t
 + 
Àn
 > bio_offset);

662 
bio_off£t
 +
Àn
;

666 
	`ídio_ªad∑ge_ªÀa£_exã¡
(&
¥o˚s£d
, 
NULL
, 0, 0, 
Ál£
);

667 
	`bio_put
(
bio
);

668 
	}
}

681 
	$båfs_Æloc_∑ge_¨øy
(
ƒ_∑ges
, 
∑ge
 **
∑ge_¨øy
)

683 
Æloˇãd
;

685 
Æloˇãd
 = 0;áŒoˇãd < 
ƒ_∑ges
;) {

686 
œ°
 = 
Æloˇãd
;

688 
Æloˇãd
 = 
	`Æloc_∑ges_bulk_¨øy
(
GFP_NOFS
, 
ƒ_∑ges
, 
∑ge_¨øy
);

690 i‡(
Æloˇãd
 =
ƒ_∑ges
)

698 i‡(
Æloˇãd
 =
œ°
) {

699 
i
 = 0; i < 
Æloˇãd
; i++) {

700 
	`__‰ì_∑ge
(
∑ge_¨øy
[
i
]);

701 
∑ge_¨øy
[
i
] = 
NULL
;

703  -
ENOMEM
;

706 
	`memÆloc_ªåy_waô
(
GFP_NOFS
);

709 
	}
}

711 
boﬁ
 
	$båfs_bio_is_c⁄tig
(
båfs_bio_˘æ
 *
bio_˘æ
,

712 
∑ge
 *∑ge, 
u64
 
disk_byãƒ
,

713 
pg_off£t
)

715 
bio
 *biÿ&
bio_˘æ
->
bbio
->bio;

716 
bio_vec
 *
bvec
 = 
	`bio_œ°_bvec_Æl
(
bio
);

717 c⁄° 
£˘‹_t
 
£˘‹
 = 
disk_byãƒ
 >> 
SECTOR_SHIFT
;

719 i‡(
bio_˘æ
->
com¥ess_ty≥
 !
BTRFS_COMPRESS_NONE
) {

724  
bio
->
bi_ôî
.
bi_£˘‹
 =
£˘‹
;

738  
	`bio_íd_£˘‹
(
bio
Ë=
£˘‹
 &&

739 
	`∑ge_off£t
(
bvec
->
bv_∑ge
Ë+ bvec->
bv_off£t
 + bvec->
bv_Àn
 ==

740 
	`∑ge_off£t
(
∑ge
Ë+ 
pg_off£t
;

741 
	}
}

743 
	$Æloc_√w_bio
(
båfs_öode
 *
öode
,

744 
båfs_bio_˘æ
 *
bio_˘æ
,

745 
u64
 
disk_byãƒ
, u64 
fûe_off£t
)

747 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

748 
båfs_bio
 *
bbio
;

750 
bbio
 = 
	`båfs_bio_Æloc
(
BIO_MAX_VECS
, 
bio_˘æ
->
›f
, 
fs_öfo
,

751 
bio_˘æ
->
íd_io_func
, 
NULL
);

752 
bbio
->
bio
.
bi_ôî
.
bi_£˘‹
 = 
disk_byãƒ
 >> 
SECTOR_SHIFT
;

753 
bbio
->
öode
 = inode;

754 
bbio
->
fûe_off£t
 = file_offset;

755 
bio_˘æ
->
bbio
 = bbio;

756 
bio_˘æ
->
Àn_to_€_bound¨y
 = 
U32_MAX
;

759 i‡(
bio_˘æ
->
wbc
) {

760 
båfs_‹dîed_exã¡
 *
‹dîed
;

762 
‹dîed
 = 
	`båfs_lookup_‹dîed_exã¡
(
öode
, 
fûe_off£t
);

763 i‡(
‹dîed
) {

764 
bio_˘æ
->
Àn_to_€_bound¨y
 = 
	`mö_t
(
u32
, 
U32_MAX
,

765 
‹dîed
->
fûe_off£t
 +

766 
‹dîed
->
disk_num_byãs
 - 
fûe_off£t
);

767 
bbio
->
‹dîed
 = ordered;

776 
	`bio_£t_dev
(&
bbio
->
bio
, 
fs_öfo
->
fs_devi˚s
->
œã°_dev
->
bdev
);

777 
	`wbc_öô_bio
(
bio_˘æ
->
wbc
, &
bbio
->
bio
);

779 
	}
}

793 
	$submô_exã¡_∑ge
(
båfs_bio_˘æ
 *
bio_˘æ
,

794 
u64
 
disk_byãƒ
, 
∑ge
 *page,

795 
size_t
 
size
, 
pg_off£t
)

797 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
∑ge
->
m≠pög
->
ho°
);

799 
	`ASSERT
(
pg_off£t
 + 
size
 <
PAGE_SIZE
);

800 
	`ASSERT
(
bio_˘æ
->
íd_io_func
);

802 i‡(
bio_˘æ
->
bbio
 &&

803 !
	`båfs_bio_is_c⁄tig
(
bio_˘æ
, 
∑ge
, 
disk_byãƒ
, 
pg_off£t
))

804 
	`submô_⁄e_bio
(
bio_˘æ
);

807 
u32
 
Àn
 = 
size
;

810 i‡(!
bio_˘æ
->
bbio
) {

811 
	`Æloc_√w_bio
(
öode
, 
bio_˘æ
, 
disk_byãƒ
,

812 
	`∑ge_off£t
(
∑ge
Ë+ 
pg_off£t
);

816 i‡(
Àn
 > 
bio_˘æ
->
Àn_to_€_bound¨y
) {

817 
	`ASSERT
(
bio_˘æ
->
com¥ess_ty≥
 =
BTRFS_COMPRESS_NONE
);

818 
	`ASSERT
(
	`is_d©a_öode
(&
öode
->
vfs_öode
));

819 
Àn
 = 
bio_˘æ
->
Àn_to_€_bound¨y
;

822 i‡(
	`bio_add_∑ge
(&
bio_˘æ
->
bbio
->
bio
, 
∑ge
, 
Àn
, 
pg_off£t
) !=Üen) {

824 
	`submô_⁄e_bio
(
bio_˘æ
);

828 i‡(
bio_˘æ
->
wbc
)

829 
	`wbc_accou¡_cgroup_ow√r
(
bio_˘æ
->
wbc
, 
∑ge
, 
Àn
);

831 
size
 -
Àn
;

832 
pg_off£t
 +
Àn
;

833 
disk_byãƒ
 +
Àn
;

856 i‡(
bio_˘æ
->
Àn_to_€_bound¨y
 !
U32_MAX
)

857 
bio_˘æ
->
Àn_to_€_bound¨y
 -
Àn
;

860 i‡(
bio_˘æ
->
Àn_to_€_bound¨y
 == 0)

861 
	`submô_⁄e_bio
(
bio_˘æ
);

862 } 
size
);

863 
	}
}

865 
	$©èch_exã¡_buf„r_∑ge
(
exã¡_buf„r
 *
eb
,

866 
∑ge
 *page,

867 
båfs_sub∑ge
 *
¥óŒoc
)

869 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

870 
ªt
 = 0;

878 i‡(
∑ge
->
m≠pög
)

879 
	`lockdï_as£π_hñd
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

881 i‡(
fs_öfo
->
nodesize
 >
PAGE_SIZE
) {

882 i‡(!
	`PagePriv©e
(
∑ge
))

883 
	`©èch_∑ge_¥iv©e
(
∑ge
, 
eb
);

885 
	`WARN_ON
(
∑ge
->
¥iv©e
 !()
eb
);

890 i‡(
	`PagePriv©e
(
∑ge
)) {

891 
	`båfs_‰ì_sub∑ge
(
¥óŒoc
);

895 i‡(
¥óŒoc
)

897 
	`©èch_∑ge_¥iv©e
(
∑ge
, 
¥óŒoc
);

900 
ªt
 = 
	`båfs_©èch_sub∑ge
(
fs_öfo
, 
∑ge
,

901 
BTRFS_SUBPAGE_METADATA
);

902  
ªt
;

903 
	}
}

905 
	$£t_∑ge_exã¡_m≠≥d
(
∑ge
 *page)

907 
båfs_fs_öfo
 *
fs_öfo
;

909 
	`ASSERT
(
∑ge
->
m≠pög
);

911 i‡(
	`PagePriv©e
(
∑ge
))

914 
fs_öfo
 = 
	`båfs_sb
(
∑ge
->
m≠pög
->
ho°
->
i_sb
);

916 i‡(
	`båfs_is_sub∑ge
(
fs_öfo
, 
∑ge
))

917  
	`båfs_©èch_sub∑ge
(
fs_öfo
, 
∑ge
, 
BTRFS_SUBPAGE_DATA
);

919 
	`©èch_∑ge_¥iv©e
(
∑ge
, (*)
EXTENT_PAGE_PRIVATE
);

921 
	}
}

923 
	$˛ór_∑ge_exã¡_m≠≥d
(
∑ge
 *page)

925 
båfs_fs_öfo
 *
fs_öfo
;

927 
	`ASSERT
(
∑ge
->
m≠pög
);

929 i‡(!
	`PagePriv©e
(
∑ge
))

932 
fs_öfo
 = 
	`båfs_sb
(
∑ge
->
m≠pög
->
ho°
->
i_sb
);

933 i‡(
	`båfs_is_sub∑ge
(
fs_öfo
, 
∑ge
))

934  
	`båfs_dëach_sub∑ge
(
fs_öfo
, 
∑ge
);

936 
	`dëach_∑ge_¥iv©e
(
∑ge
);

937 
	}
}

939 
exã¡_m≠
 *

940 
	$__gë_exã¡_m≠
(
öode
 *öode, 
∑ge
 *∑ge, 
size_t
 
pg_off£t
,

941 
u64
 
°¨t
, u64 
Àn
, 
exã¡_m≠
 **
em_ˇched
)

943 
exã¡_m≠
 *
em
;

945 i‡(
em_ˇched
 && *em_cached) {

946 
em
 = *
em_ˇched
;

947 i‡(
	`exã¡_m≠_ö_åì
(
em
Ë&& 
°¨t
 >=Ém->start &&

948 
°¨t
 < 
	`exã¡_m≠_íd
(
em
)) {

949 
	`ªfcou¡_öc
(&
em
->
ªfs
);

950  
em
;

953 
	`‰ì_exã¡_m≠
(
em
);

954 *
em_ˇched
 = 
NULL
;

957 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
∑ge
, 
pg_off£t
, 
°¨t
, 
Àn
);

958 i‡(
em_ˇched
 && !
	`IS_ERR
(
em
)) {

959 
	`BUG_ON
(*
em_ˇched
);

960 
	`ªfcou¡_öc
(&
em
->
ªfs
);

961 *
em_ˇched
 = 
em
;

963  
em
;

964 
	}
}

972 
	$båfs_do_ªad∑ge
(
∑ge
 *∑ge, 
exã¡_m≠
 **
em_ˇched
,

973 
båfs_bio_˘æ
 *
bio_˘æ
, 
u64
 *
¥ev_em_°¨t
)

975 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

976 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

977 
u64
 
°¨t
 = 
	`∑ge_off£t
(
∑ge
);

978 c⁄° 
u64
 
íd
 = 
°¨t
 + 
PAGE_SIZE
 - 1;

979 
u64
 
cur
 = 
°¨t
;

980 
u64
 
exã¡_off£t
;

981 
u64
 
œ°_byã
 = 
	`i_size_ªad
(
öode
);

982 
u64
 
block_°¨t
;

983 
exã¡_m≠
 *
em
;

984 
ªt
 = 0;

985 
size_t
 
pg_off£t
 = 0;

986 
size_t
 
iosize
;

987 
size_t
 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

988 
exã¡_io_åì
 *
åì
 = &
	`BTRFS_I
(
öode
)->
io_åì
;

990 
ªt
 = 
	`£t_∑ge_exã¡_m≠≥d
(
∑ge
);

991 i‡(
ªt
 < 0) {

992 
	`u∆ock_exã¡
(
åì
, 
°¨t
, 
íd
, 
NULL
);

993 
	`u∆ock_∑ge
(
∑ge
);

994  
ªt
;

997 i‡(
∑ge
->
ödex
 =
œ°_byã
 >> 
PAGE_SHIFT
) {

998 
size_t
 
zîo_off£t
 = 
	`off£t_ö_∑ge
(
œ°_byã
);

1000 i‡(
zîo_off£t
) {

1001 
iosize
 = 
PAGE_SIZE
 - 
zîo_off£t
;

1002 
	`memzîo_∑ge
(
∑ge
, 
zîo_off£t
, 
iosize
);

1005 
bio_˘æ
->
íd_io_func
 = 
íd_bio_exã¡_ªad∑ge
;

1006 
	`begö_∑ge_ªad
(
fs_öfo
, 
∑ge
);

1007 
cur
 <
íd
) {

1008 
båfs_com¥essi⁄_ty≥
 
com¥ess_ty≥
 = 
BTRFS_COMPRESS_NONE
;

1009 
boﬁ
 
f‹˚_bio_submô
 = 
Ál£
;

1010 
u64
 
disk_byãƒ
;

1012 
	`ASSERT
(
	`IS_ALIGNED
(
cur
, 
fs_öfo
->
£˘‹size
));

1013 i‡(
cur
 >
œ°_byã
) {

1014 
iosize
 = 
PAGE_SIZE
 - 
pg_off£t
;

1015 
	`memzîo_∑ge
(
∑ge
, 
pg_off£t
, 
iosize
);

1016 
	`u∆ock_exã¡
(
åì
, 
cur
, cu∏+ 
iosize
 - 1, 
NULL
);

1017 
	`íd_∑ge_ªad
(
∑ge
, 
åue
, 
cur
, 
iosize
);

1020 
em
 = 
	`__gë_exã¡_m≠
(
öode
, 
∑ge
, 
pg_off£t
, 
cur
,

1021 
íd
 - 
cur
 + 1, 
em_ˇched
);

1022 i‡(
	`IS_ERR
(
em
)) {

1023 
	`u∆ock_exã¡
(
åì
, 
cur
, 
íd
, 
NULL
);

1024 
	`íd_∑ge_ªad
(
∑ge
, 
Ál£
, 
cur
, 
íd
 + 1 - cur);

1025  
	`PTR_ERR
(
em
);

1027 
exã¡_off£t
 = 
cur
 - 
em
->
°¨t
;

1028 
	`BUG_ON
(
	`exã¡_m≠_íd
(
em
Ë<
cur
);

1029 
	`BUG_ON
(
íd
 < 
cur
);

1031 i‡(
	`ã°_bô
(
EXTENT_FLAG_COMPRESSED
, &
em
->
Êags
))

1032 
com¥ess_ty≥
 = 
em
->compress_type;

1034 
iosize
 = 
	`mö
(
	`exã¡_m≠_íd
(
em
Ë- 
cur
, 
íd
 - cur + 1);

1035 
iosize
 = 
	`ALIGN
(iosize, 
blocksize
);

1036 i‡(
com¥ess_ty≥
 !
BTRFS_COMPRESS_NONE
)

1037 
disk_byãƒ
 = 
em
->
block_°¨t
;

1039 
disk_byãƒ
 = 
em
->
block_°¨t
 + 
exã¡_off£t
;

1040 
block_°¨t
 = 
em
->block_start;

1041 i‡(
	`ã°_bô
(
EXTENT_FLAG_PREALLOC
, &
em
->
Êags
))

1042 
block_°¨t
 = 
EXTENT_MAP_HOLE
;

1078 i‡(
	`ã°_bô
(
EXTENT_FLAG_COMPRESSED
, &
em
->
Êags
) &&

1079 
¥ev_em_°¨t
 && *¥ev_em_°¨à!(
u64
)-1 &&

1080 *
¥ev_em_°¨t
 !
em
->
°¨t
)

1081 
f‹˚_bio_submô
 = 
åue
;

1083 i‡(
¥ev_em_°¨t
)

1084 *
¥ev_em_°¨t
 = 
em
->
°¨t
;

1086 
	`‰ì_exã¡_m≠
(
em
);

1087 
em
 = 
NULL
;

1090 i‡(
block_°¨t
 =
EXTENT_MAP_HOLE
) {

1091 
	`memzîo_∑ge
(
∑ge
, 
pg_off£t
, 
iosize
);

1093 
	`u∆ock_exã¡
(
åì
, 
cur
, cu∏+ 
iosize
 - 1, 
NULL
);

1094 
	`íd_∑ge_ªad
(
∑ge
, 
åue
, 
cur
, 
iosize
);

1095 
cur
 = cu∏+ 
iosize
;

1096 
pg_off£t
 +
iosize
;

1100 i‡(
block_°¨t
 =
EXTENT_MAP_INLINE
) {

1101 
	`u∆ock_exã¡
(
åì
, 
cur
, cu∏+ 
iosize
 - 1, 
NULL
);

1102 
	`íd_∑ge_ªad
(
∑ge
, 
åue
, 
cur
, 
iosize
);

1103 
cur
 = cu∏+ 
iosize
;

1104 
pg_off£t
 +
iosize
;

1108 i‡(
bio_˘æ
->
com¥ess_ty≥
 != compress_type) {

1109 
	`submô_⁄e_bio
(
bio_˘æ
);

1110 
bio_˘æ
->
com¥ess_ty≥
 = compress_type;

1113 i‡(
f‹˚_bio_submô
)

1114 
	`submô_⁄e_bio
(
bio_˘æ
);

1115 
	`submô_exã¡_∑ge
(
bio_˘æ
, 
disk_byãƒ
, 
∑ge
, 
iosize
,

1116 
pg_off£t
);

1117 
cur
 = cu∏+ 
iosize
;

1118 
pg_off£t
 +
iosize
;

1122 
	}
}

1124 
	$båfs_ªad_fﬁio
(
fûe
 *fûe, 
fﬁio
 *folio)

1126 
∑ge
 *∑gê&
fﬁio
->page;

1127 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
∑ge
->
m≠pög
->
ho°
);

1128 
u64
 
°¨t
 = 
	`∑ge_off£t
(
∑ge
);

1129 
u64
 
íd
 = 
°¨t
 + 
PAGE_SIZE
 - 1;

1130 
båfs_bio_˘æ
 
bio_˘æ
 = { .
›f
 = 
REQ_OP_READ
 };

1131 
ªt
;

1133 
	`båfs_lock_™d_Êush_‹dîed_ønge
(
öode
, 
°¨t
, 
íd
, 
NULL
);

1135 
ªt
 = 
	`båfs_do_ªad∑ge
(
∑ge
, 
NULL
, &
bio_˘æ
, NULL);

1140 
	`submô_⁄e_bio
(&
bio_˘æ
);

1141  
ªt
;

1142 
	}
}

1144 
ölöe
 
	$c⁄tiguous_ªad∑ges
(
∑ge
 *
∑ges
[], 
ƒ_∑ges
,

1145 
u64
 
°¨t
, u64 
íd
,

1146 
exã¡_m≠
 **
em_ˇched
,

1147 
båfs_bio_˘æ
 *
bio_˘æ
,

1148 
u64
 *
¥ev_em_°¨t
)

1150 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
∑ges
[0]->
m≠pög
->
ho°
);

1151 
ödex
;

1153 
	`båfs_lock_™d_Êush_‹dîed_ønge
(
öode
, 
°¨t
, 
íd
, 
NULL
);

1155 
ödex
 = 0; index < 
ƒ_∑ges
; index++) {

1156 
	`båfs_do_ªad∑ge
(
∑ges
[
ödex
], 
em_ˇched
, 
bio_˘æ
,

1157 
¥ev_em_°¨t
);

1158 
	`put_∑ge
(
∑ges
[
ödex
]);

1160 
	}
}

1172 
noölöe_f‹_°ack
 
	$wrôïage_dñÆloc
(
båfs_öode
 *
öode
,

1173 
∑ge
 *∑ge, 
wrôeback_c⁄åﬁ
 *
wbc
)

1175 c⁄° 
u64
 
∑ge_°¨t
 = 
	`∑ge_off£t
(
∑ge
);

1176 c⁄° 
u64
 
∑ge_íd
 = 
∑ge_°¨t
 + 
PAGE_SIZE
 - 1;

1177 
u64
 
dñÆloc_°¨t
 = 
∑ge_°¨t
;

1178 
u64
 
dñÆloc_íd
 = 
∑ge_íd
;

1179 
u64
 
dñÆloc_to_wrôe
 = 0;

1180 
ªt
 = 0;

1182 
dñÆloc_°¨t
 < 
∑ge_íd
) {

1183 
dñÆloc_íd
 = 
∑ge_íd
;

1184 i‡(!
	`föd_lock_dñÆloc_ønge
(&
öode
->
vfs_öode
, 
∑ge
,

1185 &
dñÆloc_°¨t
, &
dñÆloc_íd
)) {

1186 
dñÆloc_°¨t
 = 
dñÆloc_íd
 + 1;

1190 
ªt
 = 
	`båfs_run_dñÆloc_ønge
(
öode
, 
∑ge
, 
dñÆloc_°¨t
,

1191 
dñÆloc_íd
, 
wbc
);

1192 i‡(
ªt
 < 0)

1193  
ªt
;

1195 
dñÆloc_°¨t
 = 
dñÆloc_íd
 + 1;

1202 
dñÆloc_to_wrôe
 +=

1203 
	`DIV_ROUND_UP
(
dñÆloc_íd
 + 1 - 
∑ge_°¨t
, 
PAGE_SIZE
);

1209 i‡(
ªt
 == 1) {

1210 
wbc
->
ƒ_to_wrôe
 -
dñÆloc_to_wrôe
;

1214 i‡(
wbc
->
ƒ_to_wrôe
 < 
dñÆloc_to_wrôe
) {

1215 
thªsh
 = 8192;

1217 i‡(
dñÆloc_to_wrôe
 < 
thªsh
 * 2)

1218 
thªsh
 = 
dñÆloc_to_wrôe
;

1219 
wbc
->
ƒ_to_wrôe
 = 
	`mö_t
(
u64
, 
dñÆloc_to_wrôe
,

1220 
thªsh
);

1224 
	}
}

1241 
	$föd_√xt_dúty_byã
(
båfs_fs_öfo
 *
fs_öfo
,

1242 
∑ge
 *∑ge, 
u64
 *
°¨t
, u64 *
íd
)

1244 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

1245 
båfs_sub∑ge_öfo
 *
•i
 = 
fs_öfo
->
sub∑ge_öfo
;

1246 
u64
 
‹ig_°¨t
 = *
°¨t
;

1248 
Êags
;

1249 
ønge_°¨t_bô
;

1250 
ønge_íd_bô
;

1256 i‡(!
	`båfs_is_sub∑ge
(
fs_öfo
, 
∑ge
)) {

1257 *
°¨t
 = 
	`∑ge_off£t
(
∑ge
);

1258 *
íd
 = 
	`∑ge_off£t
(
∑ge
Ë+ 
PAGE_SIZE
;

1262 
ønge_°¨t_bô
 = 
•i
->
dúty_off£t
 +

1263 (
	`off£t_ö_∑ge
(
‹ig_°¨t
Ë>> 
fs_öfo
->
£˘‹size_bôs
);

1266 
	`•ö_lock_úqßve
(&
sub∑ge
->
lock
, 
Êags
);

1267 
	`bôm≠_√xt_£t_ªgi⁄
(
sub∑ge
->
bôm≠s
, &
ønge_°¨t_bô
, &
ønge_íd_bô
,

1268 
•i
->
dúty_off£t
 + spi->
bôm≠_ƒ_bôs
);

1269 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
);

1271 
ønge_°¨t_bô
 -
•i
->
dúty_off£t
;

1272 
ønge_íd_bô
 -
•i
->
dúty_off£t
;

1274 *
°¨t
 = 
	`∑ge_off£t
(
∑ge
Ë+ 
ønge_°¨t_bô
 * 
fs_öfo
->
£˘‹size
;

1275 *
íd
 = 
	`∑ge_off£t
(
∑ge
Ë+ 
ønge_íd_bô
 * 
fs_öfo
->
£˘‹size
;

1276 
	}
}

1286 
noölöe_f‹_°ack
 
	$__exã¡_wrôïage_io
(
båfs_öode
 *
öode
,

1287 
∑ge
 *page,

1288 
båfs_bio_˘æ
 *
bio_˘æ
,

1289 
loff_t
 
i_size
,

1290 *
ƒ_ªt
)

1292 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

1293 
u64
 
cur
 = 
	`∑ge_off£t
(
∑ge
);

1294 
u64
 
íd
 = 
cur
 + 
PAGE_SIZE
 - 1;

1295 
u64
 
exã¡_off£t
;

1296 
u64
 
block_°¨t
;

1297 
exã¡_m≠
 *
em
;

1298 
ªt
 = 0;

1299 
ƒ
 = 0;

1301 
ªt
 = 
	`båfs_wrôïage_cow_fixup
(
∑ge
);

1302 i‡(
ªt
) {

1304 
	`ªdúty_∑ge_f‹_wrôïage
(
bio_˘æ
->
wbc
, 
∑ge
);

1305 
	`u∆ock_∑ge
(
∑ge
);

1309 
bio_˘æ
->
íd_io_func
 = 
íd_bio_exã¡_wrôïage
;

1310 
cur
 <
íd
) {

1311 
u32
 
Àn
 = 
íd
 - 
cur
 + 1;

1312 
u64
 
disk_byãƒ
;

1313 
u64
 
em_íd
;

1314 
u64
 
dúty_ønge_°¨t
 = 
cur
;

1315 
u64
 
dúty_ønge_íd
;

1316 
u32
 
iosize
;

1318 i‡(
cur
 >
i_size
) {

1319 
	`båfs_m¨k_‹dîed_io_föished
(
öode
, 
∑ge
, 
cur
, 
Àn
,

1320 
åue
);

1329 
	`båfs_∑ge_˛ór_dúty
(
fs_öfo
, 
∑ge
, 
cur
, 
Àn
);

1333 
	`föd_√xt_dúty_byã
(
fs_öfo
, 
∑ge
, &
dúty_ønge_°¨t
,

1334 &
dúty_ønge_íd
);

1335 i‡(
cur
 < 
dúty_ønge_°¨t
) {

1336 
cur
 = 
dúty_ønge_°¨t
;

1340 
em
 = 
	`båfs_gë_exã¡
(
öode
, 
NULL
, 0, 
cur
, 
Àn
);

1341 i‡(
	`IS_ERR
(
em
)) {

1342 
ªt
 = 
	`PTR_ERR_OR_ZERO
(
em
);

1343 
out_îr‹
;

1346 
exã¡_off£t
 = 
cur
 - 
em
->
°¨t
;

1347 
em_íd
 = 
	`exã¡_m≠_íd
(
em
);

1348 
	`ASSERT
(
cur
 <
em_íd
);

1349 
	`ASSERT
(
cur
 < 
íd
);

1350 
	`ASSERT
(
	`IS_ALIGNED
(
em
->
°¨t
, 
fs_öfo
->
£˘‹size
));

1351 
	`ASSERT
(
	`IS_ALIGNED
(
em
->
Àn
, 
fs_öfo
->
£˘‹size
));

1353 
block_°¨t
 = 
em
->block_start;

1354 
disk_byãƒ
 = 
em
->
block_°¨t
 + 
exã¡_off£t
;

1356 
	`ASSERT
(!
	`ã°_bô
(
EXTENT_FLAG_COMPRESSED
, &
em
->
Êags
));

1357 
	`ASSERT
(
block_°¨t
 !
EXTENT_MAP_HOLE
);

1358 
	`ASSERT
(
block_°¨t
 !
EXTENT_MAP_INLINE
);

1364 
iosize
 = 
	`mö
(mö(
em_íd
, 
íd
 + 1), 
dúty_ønge_íd
Ë- 
cur
;

1365 
	`‰ì_exã¡_m≠
(
em
);

1366 
em
 = 
NULL
;

1368 
	`båfs_£t_ønge_wrôeback
(
öode
, 
cur
, cu∏+ 
iosize
 - 1);

1369 i‡(!
	`PageWrôeback
(
∑ge
)) {

1370 
	`båfs_îr
(
öode
->
roŸ
->
fs_öfo
,

1372 
∑ge
->
ödex
, 
cur
, 
íd
);

1381 
	`båfs_∑ge_˛ór_dúty
(
fs_öfo
, 
∑ge
, 
cur
, 
iosize
);

1383 
	`submô_exã¡_∑ge
(
bio_˘æ
, 
disk_byãƒ
, 
∑ge
, 
iosize
,

1384 
cur
 - 
	`∑ge_off£t
(
∑ge
));

1385 
cur
 +
iosize
;

1386 
ƒ
++;

1389 
	`båfs_∑ge_as£π_nŸ_dúty
(
fs_öfo
, 
∑ge
);

1390 *
ƒ_ªt
 = 
ƒ
;

1393 
out_îr‹
:

1398 *
ƒ_ªt
 = 
ƒ
;

1399  
ªt
;

1400 
	}
}

1411 
	$__exã¡_wrôïage
(
∑ge
 *∑ge, 
båfs_bio_˘æ
 *
bio_˘æ
)

1413 
fﬁio
 *fﬁiÿ
	`∑ge_fﬁio
(
∑ge
);

1414 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

1415 c⁄° 
u64
 
∑ge_°¨t
 = 
	`∑ge_off£t
(
∑ge
);

1416 
ªt
;

1417 
ƒ
 = 0;

1418 
size_t
 
pg_off£t
;

1419 
loff_t
 
i_size
 = 
	`i_size_ªad
(
öode
);

1420 
íd_ödex
 = 
i_size
 >> 
PAGE_SHIFT
;

1422 
	`åa˚___exã¡_wrôïage
(
∑ge
, 
öode
, 
bio_˘æ
->
wbc
);

1424 
	`WARN_ON
(!
	`PageLocked
(
∑ge
));

1426 
pg_off£t
 = 
	`off£t_ö_∑ge
(
i_size
);

1427 i‡(
∑ge
->
ödex
 > 
íd_ödex
 ||

1428 (
∑ge
->
ödex
 =
íd_ödex
 && !
pg_off£t
)) {

1429 
	`fﬁio_övÆid©e
(
fﬁio
, 0, 
	`fﬁio_size
(folio));

1430 
	`fﬁio_u∆ock
(
fﬁio
);

1434 i‡(
∑ge
->
ödex
 =
íd_ödex
)

1435 
	`memzîo_∑ge
(
∑ge
, 
pg_off£t
, 
PAGE_SIZE
 -Ög_offset);

1437 
ªt
 = 
	`£t_∑ge_exã¡_m≠≥d
(
∑ge
);

1438 i‡(
ªt
 < 0)

1439 
d⁄e
;

1441 
ªt
 = 
	`wrôïage_dñÆloc
(
	`BTRFS_I
(
öode
), 
∑ge
, 
bio_˘æ
->
wbc
);

1442 i‡(
ªt
 == 1)

1444 i‡(
ªt
)

1445 
d⁄e
;

1447 
ªt
 = 
	`__exã¡_wrôïage_io
(
	`BTRFS_I
(
öode
), 
∑ge
, 
bio_˘æ
, 
i_size
, &
ƒ
);

1448 i‡(
ªt
 == 1)

1451 
bio_˘æ
->
wbc
->
ƒ_to_wrôe
--;

1453 
d⁄e
:

1454 i‡(
ƒ
 == 0) {

1456 
	`£t_∑ge_wrôeback
(
∑ge
);

1457 
	`íd_∑ge_wrôeback
(
∑ge
);

1459 i‡(
ªt
) {

1460 
	`båfs_m¨k_‹dîed_io_föished
(
	`BTRFS_I
(
öode
), 
∑ge
, 
∑ge_°¨t
,

1461 
PAGE_SIZE
, !
ªt
);

1462 
	`m≠pög_£t_îr‹
(
∑ge
->
m≠pög
, 
ªt
);

1464 
	`u∆ock_∑ge
(
∑ge
);

1465 
	`ASSERT
(
ªt
 <= 0);

1466  
ªt
;

1467 
	}
}

1469 
	$waô_⁄_exã¡_buf„r_wrôeback
(
exã¡_buf„r
 *
eb
)

1471 
	`waô_⁄_bô_io
(&
eb
->
bÊags
, 
EXTENT_BUFFER_WRITEBACK
,

1472 
TASK_UNINTERRUPTIBLE
);

1473 
	}
}

1482 
noölöe_f‹_°ack
 
boﬁ
 
	$lock_exã¡_buf„r_f‹_io
(
exã¡_buf„r
 *
eb
,

1483 
wrôeback_c⁄åﬁ
 *
wbc
)

1485 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

1486 
boﬁ
 
ªt
 = 
Ál£
;

1488 
	`båfs_åì_lock
(
eb
);

1489 
	`ã°_bô
(
EXTENT_BUFFER_WRITEBACK
, &
eb
->
bÊags
)) {

1490 
	`båfs_åì_u∆ock
(
eb
);

1491 i‡(
wbc
->
sync_mode
 !
WB_SYNC_ALL
)

1492  
Ál£
;

1493 
	`waô_⁄_exã¡_buf„r_wrôeback
(
eb
);

1494 
	`båfs_åì_lock
(
eb
);

1502 
	`•ö_lock
(&
eb
->
ªfs_lock
);

1503 i‡(
	`ã°_™d_˛ór_bô
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bÊags
)) {

1504 
	`£t_bô
(
EXTENT_BUFFER_WRITEBACK
, &
eb
->
bÊags
);

1505 
	`•ö_u∆ock
(&
eb
->
ªfs_lock
);

1506 
	`båfs_£t_hódî_Êag
(
eb
, 
BTRFS_HEADER_FLAG_WRITTEN
);

1507 
	`≥r˝u_cou¡î_add_b©ch
(&
fs_öfo
->
dúty_mëad©a_byãs
,

1508 -
eb
->
Àn
,

1509 
fs_öfo
->
dúty_mëad©a_b©ch
);

1510 
ªt
 = 
åue
;

1512 
	`•ö_u∆ock
(&
eb
->
ªfs_lock
);

1514 
	`båfs_åì_u∆ock
(
eb
);

1515  
ªt
;

1516 
	}
}

1518 
	$£t_båì_i€º
(
exã¡_buf„r
 *
eb
)

1520 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

1522 
	`£t_bô
(
EXTENT_BUFFER_WRITE_ERR
, &
eb
->
bÊags
);

1528 
	`˛ór_bô
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bÊags
);

1536 
	`m≠pög_£t_îr‹
(
eb
->
fs_öfo
->
båì_öode
->
i_m≠pög
, -
EIO
);

1576 
eb
->
log_ödex
) {

1578 
	`£t_bô
(
BTRFS_FS_BTREE_ERR
, &
fs_öfo
->
Êags
);

1581 
	`£t_bô
(
BTRFS_FS_LOG1_ERR
, &
fs_öfo
->
Êags
);

1584 
	`£t_bô
(
BTRFS_FS_LOG2_ERR
, &
fs_öfo
->
Êags
);

1587 
	`BUG
();

1589 
	}
}

1595 
exã¡_buf„r
 *
	$föd_exã¡_buf„r_nﬁock
(

1596 
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
°¨t
)

1598 
exã¡_buf„r
 *
eb
;

1600 
	`rcu_ªad_lock
();

1601 
eb
 = 
	`ødix_åì_lookup
(&
fs_öfo
->
buf„r_ødix
,

1602 
°¨t
 >> 
fs_öfo
->
£˘‹size_bôs
);

1603 i‡(
eb
 && 
	`©omic_öc_nŸ_zîo
(&eb->
ªfs
)) {

1604 
	`rcu_ªad_u∆ock
();

1605  
eb
;

1607 
	`rcu_ªad_u∆ock
();

1608  
NULL
;

1609 
	}
}

1611 
	$exã¡_buf„r_wrôe_íd_io
(
båfs_bio
 *
bbio
)

1613 
exã¡_buf„r
 *
eb
 = 
bbio
->
¥iv©e
;

1614 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

1615 
boﬁ
 
u±od©e
 = !
bbio
->
bio
.
bi_°©us
;

1616 
bvec_ôî_Æl
 
ôî_Æl
;

1617 
bio_vec
 *
bvec
;

1618 
u32
 
bio_off£t
 = 0;

1620 i‡(!
u±od©e
)

1621 
	`£t_båì_i€º
(
eb
);

1623 
	`bio_f‹_óch_£gmít_Æl
(
bvec
, &
bbio
->
bio
, 
ôî_Æl
) {

1624 
u64
 
°¨t
 = 
eb
->°¨à+ 
bio_off£t
;

1625 
∑ge
 *∑gê
bvec
->
bv_∑ge
;

1626 
u32
 
Àn
 = 
bvec
->
bv_Àn
;

1628 
	`båfs_∑ge_˛ór_wrôeback
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

1629 
bio_off£t
 +
Àn
;

1632 
	`˛ór_bô
(
EXTENT_BUFFER_WRITEBACK
, &
eb
->
bÊags
);

1633 
	`smp_mb__a·î_©omic
();

1634 
	`wake_up_bô
(&
eb
->
bÊags
, 
EXTENT_BUFFER_WRITEBACK
);

1636 
	`bio_put
(&
bbio
->
bio
);

1637 
	}
}

1639 
	$¥ï¨e_eb_wrôe
(
exã¡_buf„r
 *
eb
)

1641 
u32
 
ƒôems
;

1642 
°¨t
;

1643 
íd
;

1645 
	`˛ór_bô
(
EXTENT_BUFFER_WRITE_ERR
, &
eb
->
bÊags
);

1648 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
eb
);

1649 i‡(
	`båfs_hódî_Àvñ
(
eb
) > 0) {

1650 
íd
 = 
	`båfs_node_key_±r_off£t
(
eb
, 
ƒôems
);

1651 
	`memzîo_exã¡_buf„r
(
eb
, 
íd
,Éb->
Àn
 -Énd);

1657 
°¨t
 = 
	`båfs_ôem_ƒ_off£t
(
eb
, 
ƒôems
);

1658 
íd
 = 
	`båfs_ôem_ƒ_off£t
(
eb
, 0);

1659 i‡(
ƒôems
 == 0)

1660 
íd
 +
	`BTRFS_LEAF_DATA_SIZE
(
eb
->
fs_öfo
);

1662 
íd
 +
	`båfs_ôem_off£t
(
eb
, 
ƒôems
 - 1);

1663 
	`memzîo_exã¡_buf„r
(
eb
, 
°¨t
, 
íd
 - start);

1665 
	}
}

1667 
noölöe_f‹_°ack
 
	$wrôe_⁄e_eb
(
exã¡_buf„r
 *
eb
,

1668 
wrôeback_c⁄åﬁ
 *
wbc
)

1670 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

1671 
båfs_bio
 *
bbio
;

1673 
	`¥ï¨e_eb_wrôe
(
eb
);

1675 
bbio
 = 
	`båfs_bio_Æloc
(
INLINE_EXTENT_BUFFER_PAGES
,

1676 
REQ_OP_WRITE
 | 
REQ_META
 | 
	`wbc_to_wrôe_Êags
(
wbc
),

1677 
eb
->
fs_öfo
, 
exã¡_buf„r_wrôe_íd_io
,Éb);

1678 
bbio
->
bio
.
bi_ôî
.
bi_£˘‹
 = 
eb
->
°¨t
 >> 
SECTOR_SHIFT
;

1679 
	`bio_£t_dev
(&
bbio
->
bio
, 
fs_öfo
->
fs_devi˚s
->
œã°_dev
->
bdev
);

1680 
	`wbc_öô_bio
(
wbc
, &
bbio
->
bio
);

1681 
bbio
->
öode
 = 
	`BTRFS_I
(
eb
->
fs_öfo
->
båì_öode
);

1682 
bbio
->
fûe_off£t
 = 
eb
->
°¨t
;

1683 i‡(
fs_öfo
->
nodesize
 < 
PAGE_SIZE
) {

1684 
∑ge
 *
p
 = 
eb
->
∑ges
[0];

1686 
	`lock_∑ge
(
p
);

1687 
	`båfs_sub∑ge_£t_wrôeback
(
fs_öfo
, 
p
, 
eb
->
°¨t
,Éb->
Àn
);

1688 i‡(
	`båfs_sub∑ge_˛ór_™d_ã°_dúty
(
fs_öfo
, 
p
, 
eb
->
°¨t
,

1689 
eb
->
Àn
)) {

1690 
	`˛ór_∑ge_dúty_f‹_io
(
p
);

1691 
wbc
->
ƒ_to_wrôe
--;

1693 
	`__bio_add_∑ge
(&
bbio
->
bio
, 
p
, 
eb
->
Àn
,Éb->
°¨t
 - 
	`∑ge_off£t
(p));

1694 
	`wbc_accou¡_cgroup_ow√r
(
wbc
, 
p
, 
eb
->
Àn
);

1695 
	`u∆ock_∑ge
(
p
);

1697 
i
 = 0; i < 
	`num_exã¡_∑ges
(
eb
); i++) {

1698 
∑ge
 *
p
 = 
eb
->
∑ges
[
i
];

1700 
	`lock_∑ge
(
p
);

1701 
	`˛ór_∑ge_dúty_f‹_io
(
p
);

1702 
	`£t_∑ge_wrôeback
(
p
);

1703 
	`__bio_add_∑ge
(&
bbio
->
bio
, 
p
, 
PAGE_SIZE
, 0);

1704 
	`wbc_accou¡_cgroup_ow√r
(
wbc
, 
p
, 
PAGE_SIZE
);

1705 
wbc
->
ƒ_to_wrôe
--;

1706 
	`u∆ock_∑ge
(
p
);

1709 
	`båfs_submô_bio
(
bbio
, 0);

1710 
	}
}

1726 
	$submô_eb_sub∑ge
(
∑ge
 *∑ge, 
wrôeback_c⁄åﬁ
 *
wbc
)

1728 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
∑ge
->
m≠pög
->
ho°
->
i_sb
);

1729 
submôãd
 = 0;

1730 
u64
 
∑ge_°¨t
 = 
	`∑ge_off£t
(
∑ge
);

1731 
bô_°¨t
 = 0;

1732 
£˘‹s_≥r_node
 = 
fs_öfo
->
nodesize
 >> fs_öfo->
£˘‹size_bôs
;

1735 
bô_°¨t
 < 
fs_öfo
->
sub∑ge_öfo
->
bôm≠_ƒ_bôs
) {

1736 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

1737 
exã¡_buf„r
 *
eb
;

1738 
Êags
;

1739 
u64
 
°¨t
;

1745 
	`•ö_lock
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

1746 i‡(!
	`PagePriv©e
(
∑ge
)) {

1747 
	`•ö_u∆ock
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

1750 
	`•ö_lock_úqßve
(&
sub∑ge
->
lock
, 
Êags
);

1751 i‡(!
	`ã°_bô
(
bô_°¨t
 + 
fs_öfo
->
sub∑ge_öfo
->
dúty_off£t
,

1752 
sub∑ge
->
bôm≠s
)) {

1753 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
);

1754 
	`•ö_u∆ock
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

1755 
bô_°¨t
++;

1759 
°¨t
 = 
∑ge_°¨t
 + 
bô_°¨t
 * 
fs_öfo
->
£˘‹size
;

1760 
bô_°¨t
 +
£˘‹s_≥r_node
;

1766 
eb
 = 
	`föd_exã¡_buf„r_nﬁock
(
fs_öfo
, 
°¨t
);

1767 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
);

1768 
	`•ö_u∆ock
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

1775 i‡(!
eb
)

1778 i‡(
	`lock_exã¡_buf„r_f‹_io
(
eb
, 
wbc
)) {

1779 
	`wrôe_⁄e_eb
(
eb
, 
wbc
);

1780 
submôãd
++;

1782 
	`‰ì_exã¡_buf„r
(
eb
);

1784  
submôãd
;

1785 
	}
}

1807 
	$submô_eb_∑ge
(
∑ge
 *∑ge, 
båfs_eb_wrôe_c⁄ãxt
 *
˘x
)

1809 
wrôeback_c⁄åﬁ
 *
wbc
 = 
˘x
->wbc;

1810 
addªss_•a˚
 *
m≠pög
 = 
∑ge
->mapping;

1811 
exã¡_buf„r
 *
eb
;

1812 
ªt
;

1814 i‡(!
	`PagePriv©e
(
∑ge
))

1817 i‡(
	`båfs_sb
(
∑ge
->
m≠pög
->
ho°
->
i_sb
)->
nodesize
 < 
PAGE_SIZE
)

1818  
	`submô_eb_sub∑ge
(
∑ge
, 
wbc
);

1820 
	`•ö_lock
(&
m≠pög
->
¥iv©e_lock
);

1821 i‡(!
	`PagePriv©e
(
∑ge
)) {

1822 
	`•ö_u∆ock
(&
m≠pög
->
¥iv©e_lock
);

1826 
eb
 = (
exã¡_buf„r
 *)
∑ge
->
¥iv©e
;

1832 i‡(
	`WARN_ON
(!
eb
)) {

1833 
	`•ö_u∆ock
(&
m≠pög
->
¥iv©e_lock
);

1837 i‡(
eb
 =
˘x
->eb) {

1838 
	`•ö_u∆ock
(&
m≠pög
->
¥iv©e_lock
);

1841 
ªt
 = 
	`©omic_öc_nŸ_zîo
(&
eb
->
ªfs
);

1842 
	`•ö_u∆ock
(&
m≠pög
->
¥iv©e_lock
);

1843 i‡(!
ªt
)

1846 
˘x
->
eb
 =Éb;

1848 
ªt
 = 
	`båfs_check_mëa_wrôe_poöãr
(
eb
->
fs_öfo
, 
˘x
);

1849 i‡(
ªt
) {

1850 i‡(
ªt
 =-
EBUSY
)

1851 
ªt
 = 0;

1852 
	`‰ì_exã¡_buf„r
(
eb
);

1853  
ªt
;

1856 i‡(!
	`lock_exã¡_buf„r_f‹_io
(
eb
, 
wbc
)) {

1857 
	`‰ì_exã¡_buf„r
(
eb
);

1861 i‡(
˘x
->
z⁄ed_bg
) {

1863 
	`båfs_scheduÀ_z⁄e_föish_bg
(
˘x
->
z⁄ed_bg
, 
eb
);

1864 
˘x
->
z⁄ed_bg
->
mëa_wrôe_poöãr
 +
eb
->
Àn
;

1866 
	`wrôe_⁄e_eb
(
eb
, 
wbc
);

1867 
	`‰ì_exã¡_buf„r
(
eb
);

1869 
	}
}

1871 
	$båì_wrôe_ˇche_∑ges
(
addªss_•a˚
 *
m≠pög
,

1872 
wrôeback_c⁄åﬁ
 *
wbc
)

1874 
båfs_eb_wrôe_c⁄ãxt
 
˘x
 = { .
wbc
 = wbc };

1875 
båfs_fs_öfo
 *
fs_öfo
 = 
	`BTRFS_I
(
m≠pög
->
ho°
)->
roŸ
->fs_info;

1876 
ªt
 = 0;

1877 
d⁄e
 = 0;

1878 
ƒ_to_wrôe_d⁄e
 = 0;

1879 
fﬁio_b©ch
 
fb©ch
;

1880 
ƒ_fﬁios
;

1881 
pgoff_t
 
ödex
;

1882 
pgoff_t
 
íd
;

1883 
sˇ¬ed
 = 0;

1884 
xa_m¨k_t
 
èg
;

1886 
	`fﬁio_b©ch_öô
(&
fb©ch
);

1887 i‡(
wbc
->
ønge_cy˛ic
) {

1888 
ödex
 = 
m≠pög
->
wrôeback_ödex
;

1889 
íd
 = -1;

1894 
sˇ¬ed
 = (
ödex
 == 0);

1896 
ödex
 = 
wbc
->
ønge_°¨t
 >> 
PAGE_SHIFT
;

1897 
íd
 = 
wbc
->
ønge_íd
 >> 
PAGE_SHIFT
;

1898 
sˇ¬ed
 = 1;

1900 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
)

1901 
èg
 = 
PAGECACHE_TAG_TOWRITE
;

1903 
èg
 = 
PAGECACHE_TAG_DIRTY
;

1904 
	`båfs_z⁄ed_mëa_io_lock
(
fs_öfo
);

1905 
ªåy
:

1906 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
)

1907 
	`èg_∑ges_f‹_wrôeback
(
m≠pög
, 
ödex
, 
íd
);

1908 !
d⁄e
 && !
ƒ_to_wrôe_d⁄e
 && (
ödex
 <
íd
) &&

1909 (
ƒ_fﬁios
 = 
	`fûem≠_gë_fﬁios_èg
(
m≠pög
, &
ödex
, 
íd
,

1910 
èg
, &
fb©ch
))) {

1911 
i
;

1913 
i
 = 0; i < 
ƒ_fﬁios
; i++) {

1914 
fﬁio
 *fﬁiÿ
fb©ch
.
fﬁios
[
i
];

1916 
ªt
 = 
	`submô_eb_∑ge
(&
fﬁio
->
∑ge
, &
˘x
);

1917 i‡(
ªt
 == 0)

1919 i‡(
ªt
 < 0) {

1920 
d⁄e
 = 1;

1929 
ƒ_to_wrôe_d⁄e
 = 
wbc
->
ƒ_to_wrôe
 <= 0;

1931 
	`fﬁio_b©ch_ªÀa£
(&
fb©ch
);

1932 
	`c⁄d_ªsched
();

1934 i‡(!
sˇ¬ed
 && !
d⁄e
) {

1939 
sˇ¬ed
 = 1;

1940 
ödex
 = 0;

1941 
ªåy
;

1973 i‡(
ªt
 > 0)

1974 
ªt
 = 0;

1975 i‡(!
ªt
 && 
	`BTRFS_FS_ERROR
(
fs_öfo
))

1976 
ªt
 = -
EROFS
;

1978 i‡(
˘x
.
z⁄ed_bg
)

1979 
	`båfs_put_block_group
(
˘x
.
z⁄ed_bg
);

1980 
	`båfs_z⁄ed_mëa_io_u∆ock
(
fs_öfo
);

1981  
ªt
;

1982 
	}
}

1999 
	$exã¡_wrôe_ˇche_∑ges
(
addªss_•a˚
 *
m≠pög
,

2000 
båfs_bio_˘æ
 *
bio_˘æ
)

2002 
wrôeback_c⁄åﬁ
 *
wbc
 = 
bio_˘æ
->wbc;

2003 
öode
 *öodê
m≠pög
->
ho°
;

2004 
ªt
 = 0;

2005 
d⁄e
 = 0;

2006 
ƒ_to_wrôe_d⁄e
 = 0;

2007 
fﬁio_b©ch
 
fb©ch
;

2008 
ƒ_fﬁios
;

2009 
pgoff_t
 
ödex
;

2010 
pgoff_t
 
íd
;

2011 
pgoff_t
 
d⁄e_ödex
;

2012 
ønge_whﬁe
 = 0;

2013 
sˇ¬ed
 = 0;

2014 
xa_m¨k_t
 
èg
;

2025 i‡(!
	`igøb
(
öode
))

2028 
	`fﬁio_b©ch_öô
(&
fb©ch
);

2029 i‡(
wbc
->
ønge_cy˛ic
) {

2030 
ödex
 = 
m≠pög
->
wrôeback_ödex
;

2031 
íd
 = -1;

2036 
sˇ¬ed
 = (
ödex
 == 0);

2038 
ödex
 = 
wbc
->
ønge_°¨t
 >> 
PAGE_SHIFT
;

2039 
íd
 = 
wbc
->
ønge_íd
 >> 
PAGE_SHIFT
;

2040 i‡(
wbc
->
ønge_°¨t
 =0 && wbc->
ønge_íd
 =
LLONG_MAX
)

2041 
ønge_whﬁe
 = 1;

2042 
sˇ¬ed
 = 1;

2052 i‡(
ønge_whﬁe
 && 
wbc
->
ƒ_to_wrôe
 =
LONG_MAX
 &&

2053 
	`ã°_™d_˛ór_bô
(
BTRFS_INODE_SNAPSHOT_FLUSH
,

2054 &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
))

2055 
wbc
->
ègged_wrôïages
 = 1;

2057 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
 || wbc->
ègged_wrôïages
)

2058 
èg
 = 
PAGECACHE_TAG_TOWRITE
;

2060 
èg
 = 
PAGECACHE_TAG_DIRTY
;

2061 
ªåy
:

2062 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
 || wbc->
ègged_wrôïages
)

2063 
	`èg_∑ges_f‹_wrôeback
(
m≠pög
, 
ödex
, 
íd
);

2064 
d⁄e_ödex
 = 
ödex
;

2065 !
d⁄e
 && !
ƒ_to_wrôe_d⁄e
 && (
ödex
 <
íd
) &&

2066 (
ƒ_fﬁios
 = 
	`fûem≠_gë_fﬁios_èg
(
m≠pög
, &
ödex
,

2067 
íd
, 
èg
, &
fb©ch
))) {

2068 
i
;

2070 
i
 = 0; i < 
ƒ_fﬁios
; i++) {

2071 
fﬁio
 *fﬁiÿ
fb©ch
.
fﬁios
[
i
];

2073 
d⁄e_ödex
 = 
	`fﬁio_√xt_ödex
(
fﬁio
);

2081 i‡(!
	`fﬁio_åylock
(
fﬁio
)) {

2082 
	`submô_wrôe_bio
(
bio_˘æ
, 0);

2083 
	`fﬁio_lock
(
fﬁio
);

2086 i‡(
	`u∆ikñy
(
fﬁio
->
m≠pög
 != mapping)) {

2087 
	`fﬁio_u∆ock
(
fﬁio
);

2091 i‡(!
	`fﬁio_ã°_dúty
(
fﬁio
)) {

2093 
	`fﬁio_u∆ock
(
fﬁio
);

2097 i‡(
wbc
->
sync_mode
 !
WB_SYNC_NONE
) {

2098 i‡(
	`fﬁio_ã°_wrôeback
(
fﬁio
))

2099 
	`submô_wrôe_bio
(
bio_˘æ
, 0);

2100 
	`fﬁio_waô_wrôeback
(
fﬁio
);

2103 i‡(
	`fﬁio_ã°_wrôeback
(
fﬁio
) ||

2104 !
	`fﬁio_˛ór_dúty_f‹_io
(
fﬁio
)) {

2105 
	`fﬁio_u∆ock
(
fﬁio
);

2109 
ªt
 = 
	`__exã¡_wrôïage
(&
fﬁio
->
∑ge
, 
bio_˘æ
);

2110 i‡(
ªt
 < 0) {

2111 
d⁄e
 = 1;

2120 
ƒ_to_wrôe_d⁄e
 = (
wbc
->
sync_mode
 =
WB_SYNC_NONE
 &&

2121 
wbc
->
ƒ_to_wrôe
 <= 0);

2123 
	`fﬁio_b©ch_ªÀa£
(&
fb©ch
);

2124 
	`c⁄d_ªsched
();

2126 i‡(!
sˇ¬ed
 && !
d⁄e
) {

2131 
sˇ¬ed
 = 1;

2132 
ödex
 = 0;

2140 
	`submô_wrôe_bio
(
bio_˘æ
, 0);

2141 
ªåy
;

2144 i‡(
wbc
->
ønge_cy˛ic
 || (wbc->
ƒ_to_wrôe
 > 0 && 
ønge_whﬁe
))

2145 
m≠pög
->
wrôeback_ödex
 = 
d⁄e_ödex
;

2147 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
öode
));

2148  
ªt
;

2149 
	}
}

2156 
	$exã¡_wrôe_locked_ønge
(
öode
 *öode, 
∑ge
 *
locked_∑ge
,

2157 
u64
 
°¨t
, u64 
íd
, 
wrôeback_c⁄åﬁ
 *
wbc
,

2158 
boﬁ
 
∑ges_dúty
)

2160 
boﬁ
 
found_îr‹
 = 
Ál£
;

2161 
ªt
 = 0;

2162 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

2163 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

2164 c⁄° 
u32
 
£˘‹size
 = 
fs_öfo
->sectorsize;

2165 
loff_t
 
i_size
 = 
	`i_size_ªad
(
öode
);

2166 
u64
 
cur
 = 
°¨t
;

2167 
båfs_bio_˘æ
 
bio_˘æ
 = {

2168 .
wbc
 = wbc,

2169 .
›f
 = 
REQ_OP_WRITE
 | 
	`wbc_to_wrôe_Êags
(
wbc
),

2172 i‡(
wbc
->
no_cgroup_ow√r
)

2173 
bio_˘æ
.
›f
 |
REQ_BTRFS_CGROUP_PUNT
;

2175 
	`ASSERT
(
	`IS_ALIGNED
(
°¨t
, 
£˘‹size
Ë&& IS_ALIGNED(
íd
 + 1, sectorsize));

2177 
cur
 <
íd
) {

2178 
u64
 
cur_íd
 = 
	`mö
(
	`round_down
(
cur
, 
PAGE_SIZE
Ë+ PAGE_SIZE - 1, 
íd
);

2179 
u32
 
cur_Àn
 = 
cur_íd
 + 1 - 
cur
;

2180 
∑ge
 *page;

2181 
ƒ
 = 0;

2183 
∑ge
 = 
	`föd_gë_∑ge
(
m≠pög
, 
cur
 >> 
PAGE_SHIFT
);

2184 
	`ASSERT
(
	`PageLocked
(
∑ge
));

2185 i‡(
∑ges_dúty
 && 
∑ge
 !
locked_∑ge
) {

2186 
	`ASSERT
(
	`PageDúty
(
∑ge
));

2187 
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
);

2190 
ªt
 = 
	`__exã¡_wrôïage_io
(
	`BTRFS_I
(
öode
), 
∑ge
, &
bio_˘æ
,

2191 
i_size
, &
ƒ
);

2192 i‡(
ªt
 == 1)

2193 
√xt_∑ge
;

2196 i‡(
ƒ
 == 0) {

2197 
	`£t_∑ge_wrôeback
(
∑ge
);

2198 
	`íd_∑ge_wrôeback
(
∑ge
);

2200 i‡(
ªt
) {

2201 
	`båfs_m¨k_‹dîed_io_föished
(
	`BTRFS_I
(
öode
), 
∑ge
,

2202 
cur
, 
cur_Àn
, !
ªt
);

2203 
	`m≠pög_£t_îr‹
(
∑ge
->
m≠pög
, 
ªt
);

2205 
	`båfs_∑ge_u∆ock_wrôî
(
fs_öfo
, 
∑ge
, 
cur
, 
cur_Àn
);

2206 i‡(
ªt
 < 0)

2207 
found_îr‹
 = 
åue
;

2208 
√xt_∑ge
:

2209 
	`put_∑ge
(
∑ge
);

2210 
cur
 = 
cur_íd
 + 1;

2213 
	`submô_wrôe_bio
(&
bio_˘æ
, 
found_îr‹
 ? 
ªt
 : 0);

2214 
	}
}

2216 
	$exã¡_wrôïages
(
addªss_•a˚
 *
m≠pög
,

2217 
wrôeback_c⁄åﬁ
 *
wbc
)

2219 
öode
 *öodê
m≠pög
->
ho°
;

2220 
ªt
 = 0;

2221 
båfs_bio_˘æ
 
bio_˘æ
 = {

2222 .
wbc
 = wbc,

2223 .
›f
 = 
REQ_OP_WRITE
 | 
	`wbc_to_wrôe_Êags
(
wbc
),

2230 
	`båfs_z⁄ed_d©a_ªloc_lock
(
	`BTRFS_I
(
öode
));

2231 
ªt
 = 
	`exã¡_wrôe_ˇche_∑ges
(
m≠pög
, &
bio_˘æ
);

2232 
	`submô_wrôe_bio
(&
bio_˘æ
, 
ªt
);

2233 
	`båfs_z⁄ed_d©a_ªloc_u∆ock
(
	`BTRFS_I
(
öode
));

2234  
ªt
;

2235 
	}
}

2237 
	$exã¡_ªadahód
(
ªadahód_c⁄åﬁ
 *
øc
)

2239 
båfs_bio_˘æ
 
bio_˘æ
 = { .
›f
 = 
REQ_OP_READ
 | 
REQ_RAHEAD
 };

2240 
∑ge
 *
∑gïoﬁ
[16];

2241 
exã¡_m≠
 *
em_ˇched
 = 
NULL
;

2242 
u64
 
¥ev_em_°¨t
 = (u64)-1;

2243 
ƒ
;

2245 (
ƒ
 = 
	`ªadahód_∑ge_b©ch
(
øc
, 
∑gïoﬁ
))) {

2246 
u64
 
c⁄tig_°¨t
 = 
	`ªadahód_pos
(
øc
);

2247 
u64
 
c⁄tig_íd
 = 
c⁄tig_°¨t
 + 
	`ªadahód_b©ch_Àngth
(
øc
) - 1;

2249 
	`c⁄tiguous_ªad∑ges
(
∑gïoﬁ
, 
ƒ
, 
c⁄tig_°¨t
, 
c⁄tig_íd
,

2250 &
em_ˇched
, &
bio_˘æ
, &
¥ev_em_°¨t
);

2253 i‡(
em_ˇched
)

2254 
	`‰ì_exã¡_m≠
(
em_ˇched
);

2255 
	`submô_⁄e_bio
(&
bio_˘æ
);

2256 
	}
}

2263 
	$exã¡_övÆid©e_fﬁio
(
exã¡_io_åì
 *
åì
,

2264 
fﬁio
 *fﬁio, 
size_t
 
off£t
)

2266 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

2267 
u64
 
°¨t
 = 
	`fﬁio_pos
(
fﬁio
);

2268 
u64
 
íd
 = 
°¨t
 + 
	`fﬁio_size
(
fﬁio
) - 1;

2269 
size_t
 
blocksize
 = 
fﬁio
->
m≠pög
->
ho°
->
i_sb
->
s_blocksize
;

2272 
	`ASSERT
(
åì
->
ow√r
 =
IO_TREE_BTREE_INODE_IO
);

2274 
°¨t
 +
	`ALIGN
(
off£t
, 
blocksize
);

2275 i‡(
°¨t
 > 
íd
)

2278 
	`lock_exã¡
(
åì
, 
°¨t
, 
íd
, &
ˇched_°©e
);

2279 
	`fﬁio_waô_wrôeback
(
fﬁio
);

2286 
	`u∆ock_exã¡
(
åì
, 
°¨t
, 
íd
, &
ˇched_°©e
);

2288 
	}
}

2295 
	$åy_ªÀa£_exã¡_°©e
(
exã¡_io_åì
 *
åì
,

2296 
∑ge
 *∑ge, 
gÂ_t
 
mask
)

2298 
u64
 
°¨t
 = 
	`∑ge_off£t
(
∑ge
);

2299 
u64
 
íd
 = 
°¨t
 + 
PAGE_SIZE
 - 1;

2300 
ªt
 = 1;

2302 i‡(
	`ã°_ønge_bô
(
åì
, 
°¨t
, 
íd
, 
EXTENT_LOCKED
, 0, 
NULL
)) {

2303 
ªt
 = 0;

2305 
u32
 
˛ór_bôs
 = ~(
EXTENT_LOCKED
 | 
EXTENT_NODATASUM
 |

2306 
EXTENT_DELALLOC_NEW
 | 
EXTENT_CTLBITS
 |

2307 
EXTENT_QGROUP_RESERVED
);

2315 
ªt
 = 
	`__˛ór_exã¡_bô
(
åì
, 
°¨t
, 
íd
, 
˛ór_bôs
, 
NULL
, NULL);

2320 i‡(
ªt
 < 0)

2321 
ªt
 = 0;

2323 
ªt
 = 1;

2325  
ªt
;

2326 
	}
}

2333 
	$åy_ªÀa£_exã¡_m≠pög
(
∑ge
 *∑ge, 
gÂ_t
 
mask
)

2335 
exã¡_m≠
 *
em
;

2336 
u64
 
°¨t
 = 
	`∑ge_off£t
(
∑ge
);

2337 
u64
 
íd
 = 
°¨t
 + 
PAGE_SIZE
 - 1;

2338 
båfs_öode
 *båfs_öodê
	`BTRFS_I
(
∑ge
->
m≠pög
->
ho°
);

2339 
exã¡_io_åì
 *
åì
 = &
båfs_öode
->
io_åì
;

2340 
exã¡_m≠_åì
 *
m≠
 = &
båfs_öode
->
exã¡_åì
;

2342 i‡(
	`gÂÊags_Ælow_blockög
(
mask
) &&

2343 
∑ge
->
m≠pög
->
ho°
->
i_size
 > 
SZ_16M
) {

2344 
u64
 
Àn
;

2345 
°¨t
 <
íd
) {

2346 
båfs_fs_öfo
 *
fs_öfo
;

2347 
u64
 
cur_gí
;

2349 
Àn
 = 
íd
 - 
°¨t
 + 1;

2350 
	`wrôe_lock
(&
m≠
->
lock
);

2351 
em
 = 
	`lookup_exã¡_m≠pög
(
m≠
, 
°¨t
, 
Àn
);

2352 i‡(!
em
) {

2353 
	`wrôe_u∆ock
(&
m≠
->
lock
);

2356 i‡(
	`ã°_bô
(
EXTENT_FLAG_PINNED
, &
em
->
Êags
) ||

2357 
em
->
°¨t
 != start) {

2358 
	`wrôe_u∆ock
(&
m≠
->
lock
);

2359 
	`‰ì_exã¡_m≠
(
em
);

2362 i‡(
	`ã°_ønge_bô
(
åì
, 
em
->
°¨t
,

2363 
	`exã¡_m≠_íd
(
em
) - 1,

2364 
EXTENT_LOCKED
, 0, 
NULL
))

2365 
√xt
;

2372 i‡(
	`li°_em±y
(&
em
->
li°
) ||

2373 
	`ã°_bô
(
EXTENT_FLAG_LOGGING
, &
em
->
Êags
))

2374 
ªmove_em
;

2382 
fs_öfo
 = 
båfs_öode
->
roŸ
->fs_info;

2383 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

2384 
cur_gí
 = 
fs_öfo
->
gíî©i⁄
;

2385 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

2386 i‡(
em
->
gíî©i⁄
 >
cur_gí
)

2387 
√xt
;

2388 
ªmove_em
:

2397 
	`ªmove_exã¡_m≠pög
(
m≠
, 
em
);

2399 
	`‰ì_exã¡_m≠
(
em
);

2400 
√xt
:

2401 
°¨t
 = 
	`exã¡_m≠_íd
(
em
);

2402 
	`wrôe_u∆ock
(&
m≠
->
lock
);

2405 
	`‰ì_exã¡_m≠
(
em
);

2407 
	`c⁄d_ªsched
();

2410  
	`åy_ªÀa£_exã¡_°©e
(
åì
, 
∑ge
, 
mask
);

2411 
	}
}

2418 
	sfõm≠_ˇche
 {

2419 
u64
 
	moff£t
;

2420 
u64
 
	mphys
;

2421 
u64
 
	mÀn
;

2422 
u32
 
	mÊags
;

2423 
boﬁ
 
	mˇched
;

2436 
	$emô_fõm≠_exã¡
(
fõm≠_exã¡_öfo
 *
fõöfo
,

2437 
fõm≠_ˇche
 *
ˇche
,

2438 
u64
 
off£t
, u64 
phys
, u64 
Àn
, 
u32
 
Êags
)

2440 
ªt
 = 0;

2443 
	`ASSERT
((
Êags
 & 
FIEMAP_EXTENT_LAST
) == 0);

2445 i‡(!
ˇche
->
ˇched
)

2446 
assign
;

2455 i‡(
ˇche
->
off£t
 + cache->
Àn
 > offset) {

2456 
	`WARN_ON
(1);

2457  -
EINVAL
;

2470 i‡(
ˇche
->
off£t
 + cache->
Àn
 == offset &&

2471 
ˇche
->
phys
 + cache->
Àn
 ==Öhys &&

2472 
ˇche
->
Êags
 == flags) {

2473 
ˇche
->
Àn
 +=Üen;

2478 
ªt
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
, 
ˇche
->
off£t
, cache->
phys
,

2479 
ˇche
->
Àn
, cache->
Êags
);

2480 
ˇche
->
ˇched
 = 
Ál£
;

2481 i‡(
ªt
)

2482  
ªt
;

2483 
assign
:

2484 
ˇche
->
ˇched
 = 
åue
;

2485 
ˇche
->
off£t
 = offset;

2486 
ˇche
->
phys
 =Öhys;

2487 
ˇche
->
Àn
 =Üen;

2488 
ˇche
->
Êags
 = flags;

2491 
	}
}

2504 
	$emô_œ°_fõm≠_ˇche
(
fõm≠_exã¡_öfo
 *
fõöfo
,

2505 
fõm≠_ˇche
 *
ˇche
)

2507 
ªt
;

2509 i‡(!
ˇche
->
ˇched
)

2512 
ªt
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
, 
ˇche
->
off£t
, cache->
phys
,

2513 
ˇche
->
Àn
, cache->
Êags
);

2514 
ˇche
->
ˇched
 = 
Ál£
;

2515 i‡(
ªt
 > 0)

2516 
ªt
 = 0;

2517  
ªt
;

2518 
	}
}

2520 
	$fõm≠_√xt_Àaf_ôem
(
båfs_öode
 *
öode
, 
båfs_∑th
 *
∑th
)

2522 
exã¡_buf„r
 *
˛⁄e
;

2523 
båfs_key
 
key
;

2524 
¶Ÿ
;

2525 
ªt
;

2527 
∑th
->
¶Ÿs
[0]++;

2528 i‡(
∑th
->
¶Ÿs
[0] < 
	`båfs_hódî_ƒôems
’©h->
nodes
[0]))

2531 
ªt
 = 
	`båfs_√xt_Àaf
(
öode
->
roŸ
, 
∑th
);

2532 i‡(
ªt
 != 0)

2533  
ªt
;

2539 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

2540 i‡(
key
.
obje˘id
 !
	`båfs_öo
(
öode
Ë|| key.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

2544 
˛⁄e
 = 
	`båfs_˛⁄e_exã¡_buf„r
(
∑th
->
nodes
[0]);

2545 i‡(!
˛⁄e
)

2546  -
ENOMEM
;

2548 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

2549 
	`båfs_ªÀa£_∑th
(
∑th
);

2550 
∑th
->
nodes
[0] = 
˛⁄e
;

2551 
∑th
->
¶Ÿs
[0] = 
¶Ÿ
;

2554 
	}
}

2561 
	$fõm≠_£¨ch_¶Ÿ
(
båfs_öode
 *
öode
, 
båfs_∑th
 *
∑th
,

2562 
u64
 
fûe_off£t
)

2564 c⁄° 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

2565 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

2566 
exã¡_buf„r
 *
˛⁄e
;

2567 
båfs_key
 
key
;

2568 
¶Ÿ
;

2569 
ªt
;

2571 
key
.
obje˘id
 = 
öo
;

2572 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

2573 
key
.
off£t
 = 
fûe_off£t
;

2575 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

2576 i‡(
ªt
 < 0)

2577  
ªt
;

2579 i‡(
ªt
 > 0 && 
∑th
->
¶Ÿs
[0] > 0) {

2580 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0] - 1);

2581 i‡(
key
.
obje˘id
 =
öo
 && key.
ty≥
 =
BTRFS_EXTENT_DATA_KEY
)

2582 
∑th
->
¶Ÿs
[0]--;

2585 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
’©h->
nodes
[0])) {

2586 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

2587 i‡(
ªt
 != 0)

2588  
ªt
;

2590 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

2591 i‡(
key
.
obje˘id
 !
öo
 || key.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

2611 
˛⁄e
 = 
	`båfs_˛⁄e_exã¡_buf„r
(
∑th
->
nodes
[0]);

2612 i‡(!
˛⁄e
)

2613  -
ENOMEM
;

2615 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

2616 
	`båfs_ªÀa£_∑th
(
∑th
);

2617 
∑th
->
nodes
[0] = 
˛⁄e
;

2618 
∑th
->
¶Ÿs
[0] = 
¶Ÿ
;

2621 
	}
}

2628 
	$fõm≠_¥o˚ss_hﬁe
(
båfs_öode
 *
öode
,

2629 
fõm≠_exã¡_öfo
 *
fõöfo
,

2630 
fõm≠_ˇche
 *
ˇche
,

2631 
exã¡_°©e
 **
dñÆloc_ˇched_°©e
,

2632 
båfs_backªf_sh¨e_check_˘x
 *
backªf_˘x
,

2633 
u64
 
disk_byãƒ
, u64 
exã¡_off£t
,

2634 
u64
 
exã¡_gí
,

2635 
u64
 
°¨t
, u64 
íd
)

2637 c⁄° 
u64
 
i_size
 = 
	`i_size_ªad
(&
öode
->
vfs_öode
);

2638 
u64
 
cur_off£t
 = 
°¨t
;

2639 
u64
 
œ°_dñÆloc_íd
 = 0;

2640 
u32
 
¥óŒoc_Êags
 = 
FIEMAP_EXTENT_UNWRITTEN
;

2641 
boﬁ
 
checked_exã¡_sh¨ed
 = 
Ál£
;

2642 
ªt
;

2648 
cur_off£t
 < 
íd
 && cur_off£à< 
i_size
) {

2649 
u64
 
dñÆloc_°¨t
;

2650 
u64
 
dñÆloc_íd
;

2651 
u64
 
¥óŒoc_°¨t
;

2652 
u64
 
¥óŒoc_Àn
 = 0;

2653 
boﬁ
 
dñÆloc
;

2655 
dñÆloc
 = 
	`båfs_föd_dñÆloc_ö_ønge
(
öode
, 
cur_off£t
, 
íd
,

2656 
dñÆloc_ˇched_°©e
,

2657 &
dñÆloc_°¨t
,

2658 &
dñÆloc_íd
);

2659 i‡(!
dñÆloc
)

2666 i‡(
disk_byãƒ
 != 0) {

2667 i‡(
œ°_dñÆloc_íd
 == 0) {

2668 
¥óŒoc_°¨t
 = 
°¨t
;

2669 
¥óŒoc_Àn
 = 
dñÆloc_°¨t
 - 
°¨t
;

2671 
¥óŒoc_°¨t
 = 
œ°_dñÆloc_íd
 + 1;

2672 
¥óŒoc_Àn
 = 
dñÆloc_°¨t
 - 
¥óŒoc_°¨t
;

2676 i‡(
¥óŒoc_Àn
 > 0) {

2677 i‡(!
checked_exã¡_sh¨ed
 && 
fõöfo
->
fi_exã¡s_max
) {

2678 
ªt
 = 
	`båfs_is_d©a_exã¡_sh¨ed
(
öode
,

2679 
disk_byãƒ
,

2680 
exã¡_gí
,

2681 
backªf_˘x
);

2682 i‡(
ªt
 < 0)

2683  
ªt
;

2684 i‡(
ªt
 > 0)

2685 
¥óŒoc_Êags
 |
FIEMAP_EXTENT_SHARED
;

2687 
checked_exã¡_sh¨ed
 = 
åue
;

2689 
ªt
 = 
	`emô_fõm≠_exã¡
(
fõöfo
, 
ˇche
, 
¥óŒoc_°¨t
,

2690 
disk_byãƒ
 + 
exã¡_off£t
,

2691 
¥óŒoc_Àn
, 
¥óŒoc_Êags
);

2692 i‡(
ªt
)

2693  
ªt
;

2694 
exã¡_off£t
 +
¥óŒoc_Àn
;

2697 
ªt
 = 
	`emô_fõm≠_exã¡
(
fõöfo
, 
ˇche
, 
dñÆloc_°¨t
, 0,

2698 
dñÆloc_íd
 + 1 - 
dñÆloc_°¨t
,

2699 
FIEMAP_EXTENT_DELALLOC
 |

2700 
FIEMAP_EXTENT_UNKNOWN
);

2701 i‡(
ªt
)

2702  
ªt
;

2704 
œ°_dñÆloc_íd
 = 
dñÆloc_íd
;

2705 
cur_off£t
 = 
dñÆloc_íd
 + 1;

2706 
exã¡_off£t
 +
cur_off£t
 - 
dñÆloc_°¨t
;

2707 
	`c⁄d_ªsched
();

2714 i‡(
disk_byãƒ
 !0 && 
œ°_dñÆloc_íd
 < 
íd
) {

2715 
u64
 
¥óŒoc_°¨t
;

2716 
u64
 
¥óŒoc_Àn
;

2718 i‡(
œ°_dñÆloc_íd
 == 0) {

2719 
¥óŒoc_°¨t
 = 
°¨t
;

2720 
¥óŒoc_Àn
 = 
íd
 + 1 - 
°¨t
;

2722 
¥óŒoc_°¨t
 = 
œ°_dñÆloc_íd
 + 1;

2723 
¥óŒoc_Àn
 = 
íd
 + 1 - 
¥óŒoc_°¨t
;

2726 i‡(!
checked_exã¡_sh¨ed
 && 
fõöfo
->
fi_exã¡s_max
) {

2727 
ªt
 = 
	`båfs_is_d©a_exã¡_sh¨ed
(
öode
,

2728 
disk_byãƒ
,

2729 
exã¡_gí
,

2730 
backªf_˘x
);

2731 i‡(
ªt
 < 0)

2732  
ªt
;

2733 i‡(
ªt
 > 0)

2734 
¥óŒoc_Êags
 |
FIEMAP_EXTENT_SHARED
;

2736 
ªt
 = 
	`emô_fõm≠_exã¡
(
fõöfo
, 
ˇche
, 
¥óŒoc_°¨t
,

2737 
disk_byãƒ
 + 
exã¡_off£t
,

2738 
¥óŒoc_Àn
, 
¥óŒoc_Êags
);

2739 i‡(
ªt
)

2740  
ªt
;

2744 
	}
}

2746 
	$fõm≠_föd_œ°_exã¡_off£t
(
båfs_öode
 *
öode
,

2747 
båfs_∑th
 *
∑th
,

2748 
u64
 *
œ°_exã¡_íd_ªt
)

2750 c⁄° 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

2751 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

2752 
exã¡_buf„r
 *
Àaf
;

2753 
båfs_fûe_exã¡_ôem
 *
ei
;

2754 
båfs_key
 
key
;

2755 
u64
 
disk_byãƒ
;

2756 
ªt
;

2762 
ªt
 = 
	`båfs_lookup_fûe_exã¡
(
NULL
, 
roŸ
, 
∑th
, 
öo
, (
u64
)-1, 0);

2764 
	`ASSERT
(
ªt
 != 0);

2765 i‡(
ªt
 < 0)

2766  
ªt
;

2774 
	`ASSERT
(
∑th
->
¶Ÿs
[0] > 0);

2775 
∑th
->
¶Ÿs
[0]--;

2776 
Àaf
 = 
∑th
->
nodes
[0];

2777 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

2778 i‡(
key
.
obje˘id
 !
öo
 || key.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
) {

2780 *
œ°_exã¡_íd_ªt
 = 0;

2789 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_fûe_exã¡_ôem
);

2790 i‡(
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
ei
Ë=
BTRFS_FILE_EXTENT_INLINE
) {

2791 *
œ°_exã¡_íd_ªt
 = 
	`båfs_fûe_exã¡_íd
(
∑th
);

2802 
disk_byãƒ
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
ei
);

2803 
disk_byãƒ
 == 0) {

2804 
ªt
 = 
	`båfs_¥evious_ôem
(
roŸ
, 
∑th
, 
öo
, 
BTRFS_EXTENT_DATA_KEY
);

2805 i‡(
ªt
 < 0) {

2806  
ªt
;

2807 } i‡(
ªt
 > 0) {

2809 *
œ°_exã¡_íd_ªt
 = 0;

2812 
Àaf
 = 
∑th
->
nodes
[0];

2813 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

2814 
båfs_fûe_exã¡_ôem
);

2815 
disk_byãƒ
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
ei
);

2818 *
œ°_exã¡_íd_ªt
 = 
	`båfs_fûe_exã¡_íd
(
∑th
);

2820 
	}
}

2822 
	$exã¡_fõm≠
(
båfs_öode
 *
öode
, 
fõm≠_exã¡_öfo
 *
fõöfo
,

2823 
u64
 
°¨t
, u64 
Àn
)

2825 c⁄° 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

2826 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

2827 
exã¡_°©e
 *
dñÆloc_ˇched_°©e
 = 
NULL
;

2828 
båfs_∑th
 *
∑th
;

2829 
fõm≠_ˇche
 
ˇche
 = { 0 };

2830 
båfs_backªf_sh¨e_check_˘x
 *
backªf_˘x
;

2831 
u64
 
œ°_exã¡_íd
;

2832 
u64
 
¥ev_exã¡_íd
;

2833 
u64
 
lock°¨t
;

2834 
u64
 
lockíd
;

2835 
boﬁ
 
°›≥d
 = 
Ál£
;

2836 
ªt
;

2838 
backªf_˘x
 = 
	`båfs_Æloc_backªf_sh¨e_check_˘x
();

2839 
∑th
 = 
	`båfs_Æloc_∑th
();

2840 i‡(!
backªf_˘x
 || !
∑th
) {

2841 
ªt
 = -
ENOMEM
;

2842 
out
;

2845 
lock°¨t
 = 
	`round_down
(
°¨t
, 
öode
->
roŸ
->
fs_öfo
->
£˘‹size
);

2846 
lockíd
 = 
	`round_up
(
°¨t
 + 
Àn
, 
öode
->
roŸ
->
fs_öfo
->
£˘‹size
);

2847 
¥ev_exã¡_íd
 = 
lock°¨t
;

2849 
	`båfs_öode_lock
(
öode
, 
BTRFS_ILOCK_SHARED
);

2850 
	`lock_exã¡
(&
öode
->
io_åì
, 
lock°¨t
, 
lockíd
, &
ˇched_°©e
);

2852 
ªt
 = 
	`fõm≠_föd_œ°_exã¡_off£t
(
öode
, 
∑th
, &
œ°_exã¡_íd
);

2853 i‡(
ªt
 < 0)

2854 
out_u∆ock
;

2855 
	`båfs_ªÀa£_∑th
(
∑th
);

2857 
∑th
->
ªada
 = 
READA_FORWARD
;

2858 
ªt
 = 
	`fõm≠_£¨ch_¶Ÿ
(
öode
, 
∑th
, 
lock°¨t
);

2859 i‡(
ªt
 < 0) {

2860 
out_u∆ock
;

2861 } i‡(
ªt
 > 0) {

2866 
ªt
 = 0;

2867 
check_eof_dñÆloc
;

2870 
¥ev_exã¡_íd
 < 
lockíd
) {

2871 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

2872 
båfs_fûe_exã¡_ôem
 *
ei
;

2873 
båfs_key
 
key
;

2874 
u64
 
exã¡_íd
;

2875 
u64
 
exã¡_Àn
;

2876 
u64
 
exã¡_off£t
 = 0;

2877 
u64
 
exã¡_gí
;

2878 
u64
 
disk_byãƒ
 = 0;

2879 
u64
 
Êags
 = 0;

2880 
exã¡_ty≥
;

2881 
u8
 
com¥essi⁄
;

2883 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

2884 i‡(
key
.
obje˘id
 !
öo
 || key.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

2887 
exã¡_íd
 = 
	`båfs_fûe_exã¡_íd
(
∑th
);

2893 i‡(
exã¡_íd
 <
lock°¨t
)

2894 
√xt_ôem
;

2896 
backªf_˘x
->
cuº_Àaf_byãƒ
 = 
Àaf
->
°¨t
;

2899 i‡(
¥ev_exã¡_íd
 < 
key
.
off£t
) {

2900 c⁄° 
u64
 
ønge_íd
 = 
	`mö
(
key
.
off£t
, 
lockíd
) - 1;

2902 
ªt
 = 
	`fõm≠_¥o˚ss_hﬁe
(
öode
, 
fõöfo
, &
ˇche
,

2903 &
dñÆloc_ˇched_°©e
,

2904 
backªf_˘x
, 0, 0, 0,

2905 
¥ev_exã¡_íd
, 
ønge_íd
);

2906 i‡(
ªt
 < 0) {

2907 
out_u∆ock
;

2908 } i‡(
ªt
 > 0) {

2910 
°›≥d
 = 
åue
;

2915 i‡(
key
.
off£t
 >
lockíd
) {

2916 
°›≥d
 = 
åue
;

2921 
exã¡_Àn
 = 
exã¡_íd
 - 
key
.
off£t
;

2922 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

2923 
båfs_fûe_exã¡_ôem
);

2924 
com¥essi⁄
 = 
	`båfs_fûe_exã¡_com¥essi⁄
(
Àaf
, 
ei
);

2925 
exã¡_ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
ei
);

2926 
exã¡_gí
 = 
	`båfs_fûe_exã¡_gíî©i⁄
(
Àaf
, 
ei
);

2928 i‡(
exã¡_ty≥
 !
BTRFS_FILE_EXTENT_INLINE
) {

2929 
disk_byãƒ
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
ei
);

2930 i‡(
com¥essi⁄
 =
BTRFS_COMPRESS_NONE
)

2931 
exã¡_off£t
 = 
	`båfs_fûe_exã¡_off£t
(
Àaf
, 
ei
);

2934 i‡(
com¥essi⁄
 !
BTRFS_COMPRESS_NONE
)

2935 
Êags
 |
FIEMAP_EXTENT_ENCODED
;

2937 i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
) {

2938 
Êags
 |
FIEMAP_EXTENT_DATA_INLINE
;

2939 
Êags
 |
FIEMAP_EXTENT_NOT_ALIGNED
;

2940 
ªt
 = 
	`emô_fõm≠_exã¡
(
fõöfo
, &
ˇche
, 
key
.
off£t
, 0,

2941 
exã¡_Àn
, 
Êags
);

2942 } i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
) {

2943 
ªt
 = 
	`fõm≠_¥o˚ss_hﬁe
(
öode
, 
fõöfo
, &
ˇche
,

2944 &
dñÆloc_ˇched_°©e
,

2945 
backªf_˘x
,

2946 
disk_byãƒ
, 
exã¡_off£t
,

2947 
exã¡_gí
, 
key
.
off£t
,

2948 
exã¡_íd
 - 1);

2949 } i‡(
disk_byãƒ
 == 0) {

2951 
ªt
 = 
	`fõm≠_¥o˚ss_hﬁe
(
öode
, 
fõöfo
, &
ˇche
,

2952 &
dñÆloc_ˇched_°©e
,

2953 
backªf_˘x
, 0, 0, 0,

2954 
key
.
off£t
, 
exã¡_íd
 - 1);

2957 i‡(
fõöfo
->
fi_exã¡s_max
) {

2958 
ªt
 = 
	`båfs_is_d©a_exã¡_sh¨ed
(
öode
,

2959 
disk_byãƒ
,

2960 
exã¡_gí
,

2961 
backªf_˘x
);

2962 i‡(
ªt
 < 0)

2963 
out_u∆ock
;

2964 i‡(
ªt
 > 0)

2965 
Êags
 |
FIEMAP_EXTENT_SHARED
;

2968 
ªt
 = 
	`emô_fõm≠_exã¡
(
fõöfo
, &
ˇche
, 
key
.
off£t
,

2969 
disk_byãƒ
 + 
exã¡_off£t
,

2970 
exã¡_Àn
, 
Êags
);

2973 i‡(
ªt
 < 0) {

2974 
out_u∆ock
;

2975 } i‡(
ªt
 > 0) {

2977 
°›≥d
 = 
åue
;

2981 
¥ev_exã¡_íd
 = 
exã¡_íd
;

2982 
√xt_ôem
:

2983 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

2984 
ªt
 = -
EINTR
;

2985 
out_u∆ock
;

2988 
ªt
 = 
	`fõm≠_√xt_Àaf_ôem
(
öode
, 
∑th
);

2989 i‡(
ªt
 < 0) {

2990 
out_u∆ock
;

2991 } i‡(
ªt
 > 0) {

2995 
	`c⁄d_ªsched
();

2998 
check_eof_dñÆloc
:

3006 
	`båfs_‰ì_∑th
(
∑th
);

3007 
∑th
 = 
NULL
;

3009 i‡(!
°›≥d
 && 
¥ev_exã¡_íd
 < 
lockíd
) {

3010 
ªt
 = 
	`fõm≠_¥o˚ss_hﬁe
(
öode
, 
fõöfo
, &
ˇche
,

3011 &
dñÆloc_ˇched_°©e
, 
backªf_˘x
,

3012 0, 0, 0, 
¥ev_exã¡_íd
, 
lockíd
 - 1);

3013 i‡(
ªt
 < 0)

3014 
out_u∆ock
;

3015 
¥ev_exã¡_íd
 = 
lockíd
;

3018 i‡(
ˇche
.
ˇched
 && cache.
off£t
 + cache.
Àn
 >
œ°_exã¡_íd
) {

3019 c⁄° 
u64
 
i_size
 = 
	`i_size_ªad
(&
öode
->
vfs_öode
);

3021 i‡(
¥ev_exã¡_íd
 < 
i_size
) {

3022 
u64
 
dñÆloc_°¨t
;

3023 
u64
 
dñÆloc_íd
;

3024 
boﬁ
 
dñÆloc
;

3026 
dñÆloc
 = 
	`båfs_föd_dñÆloc_ö_ønge
(
öode
,

3027 
¥ev_exã¡_íd
,

3028 
i_size
 - 1,

3029 &
dñÆloc_ˇched_°©e
,

3030 &
dñÆloc_°¨t
,

3031 &
dñÆloc_íd
);

3032 i‡(!
dñÆloc
)

3033 
ˇche
.
Êags
 |
FIEMAP_EXTENT_LAST
;

3035 
ˇche
.
Êags
 |
FIEMAP_EXTENT_LAST
;

3039 
ªt
 = 
	`emô_œ°_fõm≠_ˇche
(
fõöfo
, &
ˇche
);

3041 
out_u∆ock
:

3042 
	`u∆ock_exã¡
(&
öode
->
io_åì
, 
lock°¨t
, 
lockíd
, &
ˇched_°©e
);

3043 
	`båfs_öode_u∆ock
(
öode
, 
BTRFS_ILOCK_SHARED
);

3044 
out
:

3045 
	`‰ì_exã¡_°©e
(
dñÆloc_ˇched_°©e
);

3046 
	`båfs_‰ì_backªf_sh¨e_˘x
(
backªf_˘x
);

3047 
	`båfs_‰ì_∑th
(
∑th
);

3048  
ªt
;

3049 
	}
}

3051 
	$__‰ì_exã¡_buf„r
(
exã¡_buf„r
 *
eb
)

3053 
	`kmem_ˇche_‰ì
(
exã¡_buf„r_ˇche
, 
eb
);

3054 
	}
}

3056 
	$exã¡_buf„r_undî_io
(c⁄° 
exã¡_buf„r
 *
eb
)

3058  (
	`ã°_bô
(
EXTENT_BUFFER_WRITEBACK
, &
eb
->
bÊags
) ||

3059 
	`ã°_bô
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bÊags
));

3060 
	}
}

3062 
boﬁ
 
	$∑ge_ønge_has_eb
(
båfs_fs_öfo
 *
fs_öfo
, 
∑ge
 *page)

3064 
båfs_sub∑ge
 *
sub∑ge
;

3066 
	`lockdï_as£π_hñd
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

3068 i‡(
	`PagePriv©e
(
∑ge
)) {

3069 
sub∑ge
 = (
båfs_sub∑ge
 *)
∑ge
->
¥iv©e
;

3070 i‡(
	`©omic_ªad
(&
sub∑ge
->
eb_ªfs
))

3071  
åue
;

3076 i‡(
	`©omic_ªad
(&
sub∑ge
->
ªadîs
))

3077  
åue
;

3079  
Ál£
;

3080 
	}
}

3082 
	$dëach_exã¡_buf„r_∑ge
(
exã¡_buf„r
 *
eb
, 
∑ge
 *page)

3084 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

3085 c⁄° 
boﬁ
 
m≠≥d
 = !
	`ã°_bô
(
EXTENT_BUFFER_UNMAPPED
, &
eb
->
bÊags
);

3091 i‡(
m≠≥d
)

3092 
	`•ö_lock
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

3094 i‡(!
	`PagePriv©e
(
∑ge
)) {

3095 i‡(
m≠≥d
)

3096 
	`•ö_u∆ock
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

3100 i‡(
fs_öfo
->
nodesize
 >
PAGE_SIZE
) {

3108 i‡(
	`PagePriv©e
(
∑ge
) &&

3109 
∑ge
->
¥iv©e
 =()
eb
) {

3110 
	`BUG_ON
(
	`ã°_bô
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bÊags
));

3111 
	`BUG_ON
(
	`PageDúty
(
∑ge
));

3112 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

3117 
	`dëach_∑ge_¥iv©e
(
∑ge
);

3119 i‡(
m≠≥d
)

3120 
	`•ö_u∆ock
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

3129 i‡(!
m≠≥d
) {

3130 
	`båfs_dëach_sub∑ge
(
fs_öfo
, 
∑ge
);

3134 
	`båfs_∑ge_dec_eb_ªfs
(
fs_öfo
, 
∑ge
);

3140 i‡(!
	`∑ge_ønge_has_eb
(
fs_öfo
, 
∑ge
))

3141 
	`båfs_dëach_sub∑ge
(
fs_öfo
, 
∑ge
);

3143 
	`•ö_u∆ock
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

3144 
	}
}

3147 
	$båfs_ªÀa£_exã¡_buf„r_∑ges
(
exã¡_buf„r
 *
eb
)

3149 
i
;

3150 
num_∑ges
;

3152 
	`ASSERT
(!
	`exã¡_buf„r_undî_io
(
eb
));

3154 
num_∑ges
 = 
	`num_exã¡_∑ges
(
eb
);

3155 
i
 = 0; i < 
num_∑ges
; i++) {

3156 
∑ge
 *∑gê
eb
->
∑ges
[
i
];

3158 i‡(!
∑ge
)

3161 
	`dëach_exã¡_buf„r_∑ge
(
eb
, 
∑ge
);

3164 
	`put_∑ge
(
∑ge
);

3166 
	}
}

3171 
ölöe
 
	$båfs_ªÀa£_exã¡_buf„r
(
exã¡_buf„r
 *
eb
)

3173 
	`båfs_ªÀa£_exã¡_buf„r_∑ges
(
eb
);

3174 
	`båfs_Àak_debug_dñ_eb
(
eb
);

3175 
	`__‰ì_exã¡_buf„r
(
eb
);

3176 
	}
}

3178 
exã¡_buf„r
 *

3179 
	$__Æloc_exã¡_buf„r
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
°¨t
,

3180 
Àn
)

3182 
exã¡_buf„r
 *
eb
 = 
NULL
;

3184 
eb
 = 
	`kmem_ˇche_zÆloc
(
exã¡_buf„r_ˇche
, 
GFP_NOFS
|
__GFP_NOFAIL
);

3185 
eb
->
°¨t
 = start;

3186 
eb
->
Àn
 =Üen;

3187 
eb
->
fs_öfo
 = fs_info;

3188 
	`öô_rw£m
(&
eb
->
lock
);

3190 
	`båfs_Àak_debug_add_eb
(
eb
);

3192 
	`•ö_lock_öô
(&
eb
->
ªfs_lock
);

3193 
	`©omic_£t
(&
eb
->
ªfs
, 1);

3195 
	`ASSERT
(
Àn
 <
BTRFS_MAX_METADATA_BLOCKSIZE
);

3197  
eb
;

3198 
	}
}

3200 
exã¡_buf„r
 *
	$båfs_˛⁄e_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
§c
)

3202 
i
;

3203 
exã¡_buf„r
 *
√w
;

3204 
num_∑ges
 = 
	`num_exã¡_∑ges
(
§c
);

3205 
ªt
;

3207 
√w
 = 
	`__Æloc_exã¡_buf„r
(
§c
->
fs_öfo
, src->
°¨t
, src->
Àn
);

3208 i‡(
√w
 =
NULL
)

3209  
NULL
;

3216 
	`£t_bô
(
EXTENT_BUFFER_UNMAPPED
, &
√w
->
bÊags
);

3218 
ªt
 = 
	`båfs_Æloc_∑ge_¨øy
(
num_∑ges
, 
√w
->
∑ges
);

3219 i‡(
ªt
) {

3220 
	`båfs_ªÀa£_exã¡_buf„r
(
√w
);

3221  
NULL
;

3224 
i
 = 0; i < 
num_∑ges
; i++) {

3225 
ªt
;

3226 
∑ge
 *
p
 = 
√w
->
∑ges
[
i
];

3228 
ªt
 = 
	`©èch_exã¡_buf„r_∑ge
(
√w
, 
p
, 
NULL
);

3229 i‡(
ªt
 < 0) {

3230 
	`båfs_ªÀa£_exã¡_buf„r
(
√w
);

3231  
NULL
;

3233 
	`WARN_ON
(
	`PageDúty
(
p
));

3235 
	`c›y_exã¡_buf„r_fuŒ
(
√w
, 
§c
);

3236 
	`£t_exã¡_buf„r_u±od©e
(
√w
);

3238  
√w
;

3239 
	}
}

3241 
exã¡_buf„r
 *
	$__Æloc_dummy_exã¡_buf„r
(
båfs_fs_öfo
 *
fs_öfo
,

3242 
u64
 
°¨t
, 
Àn
)

3244 
exã¡_buf„r
 *
eb
;

3245 
num_∑ges
;

3246 
i
;

3247 
ªt
;

3249 
eb
 = 
	`__Æloc_exã¡_buf„r
(
fs_öfo
, 
°¨t
, 
Àn
);

3250 i‡(!
eb
)

3251  
NULL
;

3253 
num_∑ges
 = 
	`num_exã¡_∑ges
(
eb
);

3254 
ªt
 = 
	`båfs_Æloc_∑ge_¨øy
(
num_∑ges
, 
eb
->
∑ges
);

3255 i‡(
ªt
)

3256 
îr
;

3258 
i
 = 0; i < 
num_∑ges
; i++) {

3259 
∑ge
 *
p
 = 
eb
->
∑ges
[
i
];

3261 
ªt
 = 
	`©èch_exã¡_buf„r_∑ge
(
eb
, 
p
, 
NULL
);

3262 i‡(
ªt
 < 0)

3263 
îr
;

3266 
	`£t_exã¡_buf„r_u±od©e
(
eb
);

3267 
	`båfs_£t_hódî_ƒôems
(
eb
, 0);

3268 
	`£t_bô
(
EXTENT_BUFFER_UNMAPPED
, &
eb
->
bÊags
);

3270  
eb
;

3271 
îr
:

3272 
i
 = 0; i < 
num_∑ges
; i++) {

3273 i‡(
eb
->
∑ges
[
i
]) {

3274 
	`dëach_exã¡_buf„r_∑ge
(
eb
,Éb->
∑ges
[
i
]);

3275 
	`__‰ì_∑ge
(
eb
->
∑ges
[
i
]);

3278 
	`__‰ì_exã¡_buf„r
(
eb
);

3279  
NULL
;

3280 
	}
}

3282 
exã¡_buf„r
 *
	$Æloc_dummy_exã¡_buf„r
(
båfs_fs_öfo
 *
fs_öfo
,

3283 
u64
 
°¨t
)

3285  
	`__Æloc_dummy_exã¡_buf„r
(
fs_öfo
, 
°¨t
, fs_öfo->
nodesize
);

3286 
	}
}

3288 
	$check_buf„r_åì_ªf
(
exã¡_buf„r
 *
eb
)

3290 
ªfs
;

3314 
ªfs
 = 
	`©omic_ªad
(&
eb
->refs);

3315 i‡(
ªfs
 >2 && 
	`ã°_bô
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bÊags
))

3318 
	`•ö_lock
(&
eb
->
ªfs_lock
);

3319 i‡(!
	`ã°_™d_£t_bô
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bÊags
))

3320 
	`©omic_öc
(&
eb
->
ªfs
);

3321 
	`•ö_u∆ock
(&
eb
->
ªfs_lock
);

3322 
	}
}

3324 
	$m¨k_exã¡_buf„r_ac˚s£d
(
exã¡_buf„r
 *
eb
,

3325 
∑ge
 *
ac˚s£d
)

3327 
num_∑ges
, 
i
;

3329 
	`check_buf„r_åì_ªf
(
eb
);

3331 
num_∑ges
 = 
	`num_exã¡_∑ges
(
eb
);

3332 
i
 = 0; i < 
num_∑ges
; i++) {

3333 
∑ge
 *
p
 = 
eb
->
∑ges
[
i
];

3335 i‡(
p
 !
ac˚s£d
)

3336 
	`m¨k_∑ge_ac˚s£d
(
p
);

3338 
	}
}

3340 
exã¡_buf„r
 *
	$föd_exã¡_buf„r
(
båfs_fs_öfo
 *
fs_öfo
,

3341 
u64
 
°¨t
)

3343 
exã¡_buf„r
 *
eb
;

3345 
eb
 = 
	`föd_exã¡_buf„r_nﬁock
(
fs_öfo
, 
°¨t
);

3346 i‡(!
eb
)

3347  
NULL
;

3361 i‡(
	`ã°_bô
(
EXTENT_BUFFER_STALE
, &
eb
->
bÊags
)) {

3362 
	`•ö_lock
(&
eb
->
ªfs_lock
);

3363 
	`•ö_u∆ock
(&
eb
->
ªfs_lock
);

3365 
	`m¨k_exã¡_buf„r_ac˚s£d
(
eb
, 
NULL
);

3366  
eb
;

3367 
	}
}

3369 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


3370 
exã¡_buf„r
 *
	$Æloc_ã°_exã¡_buf„r
(
båfs_fs_öfo
 *
fs_öfo
,

3371 
u64
 
°¨t
)

3373 
exã¡_buf„r
 *
eb
, *
exi°s
 = 
NULL
;

3374 
ªt
;

3376 
eb
 = 
	`föd_exã¡_buf„r
(
fs_öfo
, 
°¨t
);

3377 i‡(
eb
)

3378  
eb
;

3379 
eb
 = 
	`Æloc_dummy_exã¡_buf„r
(
fs_öfo
, 
°¨t
);

3380 i‡(!
eb
)

3381  
	`ERR_PTR
(-
ENOMEM
);

3382 
eb
->
fs_öfo
 = fs_info;

3383 
agaö
:

3384 
ªt
 = 
	`ødix_åì_¥ñﬂd
(
GFP_NOFS
);

3385 i‡(
ªt
) {

3386 
exi°s
 = 
	`ERR_PTR
(
ªt
);

3387 
‰ì_eb
;

3389 
	`•ö_lock
(&
fs_öfo
->
buf„r_lock
);

3390 
ªt
 = 
	`ødix_åì_ö£π
(&
fs_öfo
->
buf„r_ødix
,

3391 
°¨t
 >> 
fs_öfo
->
£˘‹size_bôs
, 
eb
);

3392 
	`•ö_u∆ock
(&
fs_öfo
->
buf„r_lock
);

3393 
	`ødix_åì_¥ñﬂd_íd
();

3394 i‡(
ªt
 =-
EEXIST
) {

3395 
exi°s
 = 
	`föd_exã¡_buf„r
(
fs_öfo
, 
°¨t
);

3396 i‡(
exi°s
)

3397 
‰ì_eb
;

3399 
agaö
;

3401 
	`check_buf„r_åì_ªf
(
eb
);

3402 
	`£t_bô
(
EXTENT_BUFFER_IN_TREE
, &
eb
->
bÊags
);

3404  
eb
;

3405 
‰ì_eb
:

3406 
	`båfs_ªÀa£_exã¡_buf„r
(
eb
);

3407  
exi°s
;

3408 
	}
}

3411 
exã¡_buf„r
 *
	$gøb_exã¡_buf„r
(

3412 
båfs_fs_öfo
 *
fs_öfo
, 
∑ge
 *page)

3414 
exã¡_buf„r
 *
exi°s
;

3421 i‡(
fs_öfo
->
nodesize
 < 
PAGE_SIZE
)

3422  
NULL
;

3425 i‡(!
	`PagePriv©e
(
∑ge
))

3426  
NULL
;

3434 
exi°s
 = (
exã¡_buf„r
 *)
∑ge
->
¥iv©e
;

3435 i‡(
	`©omic_öc_nŸ_zîo
(&
exi°s
->
ªfs
))

3436  
exi°s
;

3438 
	`WARN_ON
(
	`PageDúty
(
∑ge
));

3439 
	`dëach_∑ge_¥iv©e
(
∑ge
);

3440  
NULL
;

3441 
	}
}

3443 
	$check_eb_Æignmít
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
°¨t
)

3445 i‡(!
	`IS_ALIGNED
(
°¨t
, 
fs_öfo
->
£˘‹size
)) {

3446 
	`båfs_îr
(
fs_öfo
, "badÅªêblock sèπ %Œu", 
°¨t
);

3447  -
EINVAL
;

3450 i‡(
fs_öfo
->
nodesize
 < 
PAGE_SIZE
 &&

3451 
	`off£t_ö_∑ge
(
°¨t
Ë+ 
fs_öfo
->
nodesize
 > 
PAGE_SIZE
) {

3452 
	`båfs_îr
(
fs_öfo
,

3454 
°¨t
, 
fs_öfo
->
nodesize
);

3455  -
EINVAL
;

3457 i‡(
fs_öfo
->
nodesize
 >
PAGE_SIZE
 &&

3458 !
	`PAGE_ALIGNED
(
°¨t
)) {

3459 
	`båfs_îr
(
fs_öfo
,

3461 
°¨t
, 
fs_öfo
->
nodesize
);

3462  -
EINVAL
;

3465 
	}
}

3467 
exã¡_buf„r
 *
	$Æloc_exã¡_buf„r
(
båfs_fs_öfo
 *
fs_öfo
,

3468 
u64
 
°¨t
, u64 
ow√r_roŸ
, 
Àvñ
)

3470 
Àn
 = 
fs_öfo
->
nodesize
;

3471 
num_∑ges
;

3472 
i
;

3473 
ödex
 = 
°¨t
 >> 
PAGE_SHIFT
;

3474 
exã¡_buf„r
 *
eb
;

3475 
exã¡_buf„r
 *
exi°s
 = 
NULL
;

3476 
∑ge
 *
p
;

3477 
addªss_•a˚
 *
m≠pög
 = 
fs_öfo
->
båì_öode
->
i_m≠pög
;

3478 
båfs_sub∑ge
 *
¥óŒoc
 = 
NULL
;

3479 
u64
 
lockdï_ow√r
 = 
ow√r_roŸ
;

3480 
u±od©e
 = 1;

3481 
ªt
;

3483 i‡(
	`check_eb_Æignmít
(
fs_öfo
, 
°¨t
))

3484  
	`ERR_PTR
(-
EINVAL
);

3486 #i‡
BITS_PER_LONG
 == 32

3487 i‡(
°¨t
 >
MAX_LFS_FILESIZE
) {

3488 
	`båfs_îr_æ
(
fs_öfo
,

3489 "exã¡ buf„∏%Œu i†bey⁄d 32bôÖagêˇchêlimô", 
°¨t
);

3490 
	`båfs_îr_32bô_limô
(
fs_öfo
);

3491  
	`ERR_PTR
(-
EOVERFLOW
);

3493 i‡(
°¨t
 >
BTRFS_32BIT_EARLY_WARN_THRESHOLD
)

3494 
	`båfs_w¨n_32bô_limô
(
fs_öfo
);

3497 
eb
 = 
	`föd_exã¡_buf„r
(
fs_öfo
, 
°¨t
);

3498 i‡(
eb
)

3499  
eb
;

3501 
eb
 = 
	`__Æloc_exã¡_buf„r
(
fs_öfo
, 
°¨t
, 
Àn
);

3502 i‡(!
eb
)

3503  
	`ERR_PTR
(-
ENOMEM
);

3509 i‡(
lockdï_ow√r
 =
BTRFS_TREE_RELOC_OBJECTID
)

3510 
lockdï_ow√r
 = 
BTRFS_FS_TREE_OBJECTID
;

3512 
	`båfs_£t_buf„r_lockdï_˛ass
(
lockdï_ow√r
, 
eb
, 
Àvñ
);

3514 
num_∑ges
 = 
	`num_exã¡_∑ges
(
eb
);

3523 i‡(
fs_öfo
->
nodesize
 < 
PAGE_SIZE
) {

3524 
¥óŒoc
 = 
	`båfs_Æloc_sub∑ge
(
fs_öfo
, 
BTRFS_SUBPAGE_METADATA
);

3525 i‡(
	`IS_ERR
(
¥óŒoc
)) {

3526 
exi°s
 = 
	`ERR_CAST
(
¥óŒoc
);

3527 
‰ì_eb
;

3531 
i
 = 0; i < 
num_∑ges
; i++, 
ödex
++) {

3532 
p
 = 
	`föd_‹_¸óã_∑ge
(
m≠pög
, 
ödex
, 
GFP_NOFS
|
__GFP_NOFAIL
);

3533 i‡(!
p
) {

3534 
exi°s
 = 
	`ERR_PTR
(-
ENOMEM
);

3535 
	`båfs_‰ì_sub∑ge
(
¥óŒoc
);

3536 
‰ì_eb
;

3539 
	`•ö_lock
(&
m≠pög
->
¥iv©e_lock
);

3540 
exi°s
 = 
	`gøb_exã¡_buf„r
(
fs_öfo
, 
p
);

3541 i‡(
exi°s
) {

3542 
	`•ö_u∆ock
(&
m≠pög
->
¥iv©e_lock
);

3543 
	`u∆ock_∑ge
(
p
);

3544 
	`put_∑ge
(
p
);

3545 
	`m¨k_exã¡_buf„r_ac˚s£d
(
exi°s
, 
p
);

3546 
	`båfs_‰ì_sub∑ge
(
¥óŒoc
);

3547 
‰ì_eb
;

3550 
ªt
 = 
	`©èch_exã¡_buf„r_∑ge
(
eb
, 
p
, 
¥óŒoc
);

3551 
	`ASSERT
(!
ªt
);

3561 
	`båfs_∑ge_öc_eb_ªfs
(
fs_öfo
, 
p
);

3562 
	`•ö_u∆ock
(&
m≠pög
->
¥iv©e_lock
);

3564 
	`WARN_ON
(
	`båfs_∑ge_ã°_dúty
(
fs_öfo
, 
p
, 
eb
->
°¨t
,Éb->
Àn
));

3565 
eb
->
∑ges
[
i
] = 
p
;

3566 i‡(!
	`båfs_∑ge_ã°_u±od©e
(
fs_öfo
, 
p
, 
eb
->
°¨t
,Éb->
Àn
))

3567 
u±od©e
 = 0;

3577 i‡(
u±od©e
)

3578 
	`£t_bô
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bÊags
);

3579 
agaö
:

3580 
ªt
 = 
	`ødix_åì_¥ñﬂd
(
GFP_NOFS
);

3581 i‡(
ªt
) {

3582 
exi°s
 = 
	`ERR_PTR
(
ªt
);

3583 
‰ì_eb
;

3586 
	`•ö_lock
(&
fs_öfo
->
buf„r_lock
);

3587 
ªt
 = 
	`ødix_åì_ö£π
(&
fs_öfo
->
buf„r_ødix
,

3588 
°¨t
 >> 
fs_öfo
->
£˘‹size_bôs
, 
eb
);

3589 
	`•ö_u∆ock
(&
fs_öfo
->
buf„r_lock
);

3590 
	`ødix_åì_¥ñﬂd_íd
();

3591 i‡(
ªt
 =-
EEXIST
) {

3592 
exi°s
 = 
	`föd_exã¡_buf„r
(
fs_öfo
, 
°¨t
);

3593 i‡(
exi°s
)

3594 
‰ì_eb
;

3596 
agaö
;

3599 
	`check_buf„r_åì_ªf
(
eb
);

3600 
	`£t_bô
(
EXTENT_BUFFER_IN_TREE
, &
eb
->
bÊags
);

3607 
i
 = 0; i < 
num_∑ges
; i++)

3608 
	`u∆ock_∑ge
(
eb
->
∑ges
[
i
]);

3609  
eb
;

3611 
‰ì_eb
:

3612 
	`WARN_ON
(!
	`©omic_dec_™d_ã°
(&
eb
->
ªfs
));

3613 
i
 = 0; i < 
num_∑ges
; i++) {

3614 i‡(
eb
->
∑ges
[
i
])

3615 
	`u∆ock_∑ge
(
eb
->
∑ges
[
i
]);

3618 
	`båfs_ªÀa£_exã¡_buf„r
(
eb
);

3619  
exi°s
;

3620 
	}
}

3622 
ölöe
 
	$båfs_ªÀa£_exã¡_buf„r_rcu
(
rcu_hód
 *
hód
)

3624 
exã¡_buf„r
 *
eb
 =

3625 
	`c⁄èöî_of
(
hód
, 
exã¡_buf„r
, 
rcu_hód
);

3627 
	`__‰ì_exã¡_buf„r
(
eb
);

3628 
	}
}

3630 
	$ªÀa£_exã¡_buf„r
(
exã¡_buf„r
 *
eb
)

3631 
	`__ªÀa£s
(&
eb
->
ªfs_lock
)

3633 
	`lockdï_as£π_hñd
(&
eb
->
ªfs_lock
);

3635 
	`WARN_ON
(
	`©omic_ªad
(&
eb
->
ªfs
) == 0);

3636 i‡(
	`©omic_dec_™d_ã°
(&
eb
->
ªfs
)) {

3637 i‡(
	`ã°_™d_˛ór_bô
(
EXTENT_BUFFER_IN_TREE
, &
eb
->
bÊags
)) {

3638 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

3640 
	`•ö_u∆ock
(&
eb
->
ªfs_lock
);

3642 
	`•ö_lock
(&
fs_öfo
->
buf„r_lock
);

3643 
	`ødix_åì_dñëe
(&
fs_öfo
->
buf„r_ødix
,

3644 
eb
->
°¨t
 >> 
fs_öfo
->
£˘‹size_bôs
);

3645 
	`•ö_u∆ock
(&
fs_öfo
->
buf„r_lock
);

3647 
	`•ö_u∆ock
(&
eb
->
ªfs_lock
);

3650 
	`båfs_Àak_debug_dñ_eb
(
eb
);

3652 
	`båfs_ªÀa£_exã¡_buf„r_∑ges
(
eb
);

3653 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


3654 i‡(
	`u∆ikñy
(
	`ã°_bô
(
EXTENT_BUFFER_UNMAPPED
, &
eb
->
bÊags
))) {

3655 
	`__‰ì_exã¡_buf„r
(
eb
);

3659 
	`ˇŒ_rcu
(&
eb
->
rcu_hód
, 
båfs_ªÀa£_exã¡_buf„r_rcu
);

3662 
	`•ö_u∆ock
(&
eb
->
ªfs_lock
);

3665 
	}
}

3667 
	$‰ì_exã¡_buf„r
(
exã¡_buf„r
 *
eb
)

3669 
ªfs
;

3670 i‡(!
eb
)

3673 
ªfs
 = 
	`©omic_ªad
(&
eb
->refs);

3675 i‡((!
	`ã°_bô
(
EXTENT_BUFFER_UNMAPPED
, &
eb
->
bÊags
Ë&& 
ªfs
 <= 3)

3676 || (
	`ã°_bô
(
EXTENT_BUFFER_UNMAPPED
, &
eb
->
bÊags
) &&

3677 
ªfs
 == 1))

3679 i‡(
	`©omic_åy_cmpxchg
(&
eb
->
ªfs
, &refs,Ñefs - 1))

3683 
	`•ö_lock
(&
eb
->
ªfs_lock
);

3684 i‡(
	`©omic_ªad
(&
eb
->
ªfs
) == 2 &&

3685 
	`ã°_bô
(
EXTENT_BUFFER_STALE
, &
eb
->
bÊags
) &&

3686 !
	`exã¡_buf„r_undî_io
(
eb
) &&

3687 
	`ã°_™d_˛ór_bô
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bÊags
))

3688 
	`©omic_dec
(&
eb
->
ªfs
);

3694 
	`ªÀa£_exã¡_buf„r
(
eb
);

3695 
	}
}

3697 
	$‰ì_exã¡_buf„r_°Æe
(
exã¡_buf„r
 *
eb
)

3699 i‡(!
eb
)

3702 
	`•ö_lock
(&
eb
->
ªfs_lock
);

3703 
	`£t_bô
(
EXTENT_BUFFER_STALE
, &
eb
->
bÊags
);

3705 i‡(
	`©omic_ªad
(&
eb
->
ªfs
Ë=2 && !
	`exã¡_buf„r_undî_io
(eb) &&

3706 
	`ã°_™d_˛ór_bô
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bÊags
))

3707 
	`©omic_dec
(&
eb
->
ªfs
);

3708 
	`ªÀa£_exã¡_buf„r
(
eb
);

3709 
	}
}

3711 
	$båì_˛ór_∑ge_dúty
(
∑ge
 *page)

3713 
	`ASSERT
(
	`PageDúty
(
∑ge
));

3714 
	`ASSERT
(
	`PageLocked
(
∑ge
));

3715 
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
);

3716 
	`xa_lock_úq
(&
∑ge
->
m≠pög
->
i_∑ges
);

3717 i‡(!
	`PageDúty
(
∑ge
))

3718 
	`__xa_˛ór_m¨k
(&
∑ge
->
m≠pög
->
i_∑ges
,

3719 
	`∑ge_ödex
(
∑ge
), 
PAGECACHE_TAG_DIRTY
);

3720 
	`xa_u∆ock_úq
(&
∑ge
->
m≠pög
->
i_∑ges
);

3721 
	}
}

3723 
	$˛ór_sub∑ge_exã¡_buf„r_dúty
(c⁄° 
exã¡_buf„r
 *
eb
)

3725 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

3726 
∑ge
 *∑gê
eb
->
∑ges
[0];

3727 
boﬁ
 
œ°
;

3730 
	`lock_∑ge
(
∑ge
);

3731 
œ°
 = 
	`båfs_sub∑ge_˛ór_™d_ã°_dúty
(
fs_öfo
, 
∑ge
, 
eb
->
°¨t
,

3732 
eb
->
Àn
);

3733 i‡(
œ°
)

3734 
	`båì_˛ór_∑ge_dúty
(
∑ge
);

3735 
	`u∆ock_∑ge
(
∑ge
);

3736 
	`WARN_ON
(
	`©omic_ªad
(&
eb
->
ªfs
) == 0);

3737 
	}
}

3739 
	$båfs_˛ór_buf„r_dúty
(
båfs_å™s_h™dÀ
 *
å™s
,

3740 
exã¡_buf„r
 *
eb
)

3742 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

3743 
i
;

3744 
num_∑ges
;

3745 
∑ge
 *page;

3747 
	`båfs_as£π_åì_wrôe_locked
(
eb
);

3749 i‡(
å™s
 && 
	`båfs_hódî_gíî©i⁄
(
eb
Ë!å™s->
å™sid
)

3752 i‡(!
	`ã°_™d_˛ór_bô
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bÊags
))

3755 
	`≥r˝u_cou¡î_add_b©ch
(&
fs_öfo
->
dúty_mëad©a_byãs
, -
eb
->
Àn
,

3756 
fs_öfo
->
dúty_mëad©a_b©ch
);

3758 i‡(
eb
->
fs_öfo
->
nodesize
 < 
PAGE_SIZE
)

3759  
	`˛ór_sub∑ge_exã¡_buf„r_dúty
(
eb
);

3761 
num_∑ges
 = 
	`num_exã¡_∑ges
(
eb
);

3763 
i
 = 0; i < 
num_∑ges
; i++) {

3764 
∑ge
 = 
eb
->
∑ges
[
i
];

3765 i‡(!
	`PageDúty
(
∑ge
))

3767 
	`lock_∑ge
(
∑ge
);

3768 
	`båì_˛ór_∑ge_dúty
(
∑ge
);

3769 
	`u∆ock_∑ge
(
∑ge
);

3771 
	`WARN_ON
(
	`©omic_ªad
(&
eb
->
ªfs
) == 0);

3772 
	}
}

3774 
	$£t_exã¡_buf„r_dúty
(
exã¡_buf„r
 *
eb
)

3776 
i
;

3777 
num_∑ges
;

3778 
boﬁ
 
was_dúty
;

3780 
	`check_buf„r_åì_ªf
(
eb
);

3782 
was_dúty
 = 
	`ã°_™d_£t_bô
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bÊags
);

3784 
num_∑ges
 = 
	`num_exã¡_∑ges
(
eb
);

3785 
	`WARN_ON
(
	`©omic_ªad
(&
eb
->
ªfs
) == 0);

3786 
	`WARN_ON
(!
	`ã°_bô
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bÊags
));

3788 i‡(!
was_dúty
) {

3789 
boﬁ
 
sub∑ge
 = 
eb
->
fs_öfo
->
nodesize
 < 
PAGE_SIZE
;

3802 i‡(
sub∑ge
)

3803 
	`lock_∑ge
(
eb
->
∑ges
[0]);

3804 
i
 = 0; i < 
num_∑ges
; i++)

3805 
	`båfs_∑ge_£t_dúty
(
eb
->
fs_öfo
,Éb->
∑ges
[
i
],

3806 
eb
->
°¨t
,Éb->
Àn
);

3807 i‡(
sub∑ge
)

3808 
	`u∆ock_∑ge
(
eb
->
∑ges
[0]);

3809 
	`≥r˝u_cou¡î_add_b©ch
(&
eb
->
fs_öfo
->
dúty_mëad©a_byãs
,

3810 
eb
->
Àn
,

3811 
eb
->
fs_öfo
->
dúty_mëad©a_b©ch
);

3813 #ifde‡
CONFIG_BTRFS_DEBUG


3814 
i
 = 0; i < 
num_∑ges
; i++)

3815 
	`ASSERT
(
	`PageDúty
(
eb
->
∑ges
[
i
]));

3817 
	}
}

3819 
	$˛ór_exã¡_buf„r_u±od©e
(
exã¡_buf„r
 *
eb
)

3821 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

3822 
∑ge
 *page;

3823 
num_∑ges
;

3824 
i
;

3826 
	`˛ór_bô
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bÊags
);

3827 
num_∑ges
 = 
	`num_exã¡_∑ges
(
eb
);

3828 
i
 = 0; i < 
num_∑ges
; i++) {

3829 
∑ge
 = 
eb
->
∑ges
[
i
];

3830 i‡(!
∑ge
)

3837 i‡(
fs_öfo
->
nodesize
 >
PAGE_SIZE
)

3838 
	`CÀ¨PageU±od©e
(
∑ge
);

3840 
	`båfs_sub∑ge_˛ór_u±od©e
(
fs_öfo
, 
∑ge
, 
eb
->
°¨t
,

3841 
eb
->
Àn
);

3843 
	}
}

3845 
	$£t_exã¡_buf„r_u±od©e
(
exã¡_buf„r
 *
eb
)

3847 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

3848 
∑ge
 *page;

3849 
num_∑ges
;

3850 
i
;

3852 
	`£t_bô
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bÊags
);

3853 
num_∑ges
 = 
	`num_exã¡_∑ges
(
eb
);

3854 
i
 = 0; i < 
num_∑ges
; i++) {

3855 
∑ge
 = 
eb
->
∑ges
[
i
];

3861 i‡(
fs_öfo
->
nodesize
 >
PAGE_SIZE
)

3862 
	`SëPageU±od©e
(
∑ge
);

3864 
	`båfs_sub∑ge_£t_u±od©e
(
fs_öfo
, 
∑ge
, 
eb
->
°¨t
,

3865 
eb
->
Àn
);

3867 
	}
}

3869 
	$exã¡_buf„r_ªad_íd_io
(
båfs_bio
 *
bbio
)

3871 
exã¡_buf„r
 *
eb
 = 
bbio
->
¥iv©e
;

3872 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

3873 
boﬁ
 
u±od©e
 = !
bbio
->
bio
.
bi_°©us
;

3874 
bvec_ôî_Æl
 
ôî_Æl
;

3875 
bio_vec
 *
bvec
;

3876 
u32
 
bio_off£t
 = 0;

3878 
eb
->
ªad_múr‹
 = 
bbio
->
múr‹_num
;

3880 i‡(
u±od©e
 &&

3881 
	`båfs_vÆid©e_exã¡_buf„r
(
eb
, &
bbio
->
∑ª¡_check
) < 0)

3882 
u±od©e
 = 
Ál£
;

3884 i‡(
u±od©e
) {

3885 
	`£t_exã¡_buf„r_u±od©e
(
eb
);

3887 
	`˛ór_exã¡_buf„r_u±od©e
(
eb
);

3888 
	`£t_bô
(
EXTENT_BUFFER_READ_ERR
, &
eb
->
bÊags
);

3891 
	`bio_f‹_óch_£gmít_Æl
(
bvec
, &
bbio
->
bio
, 
ôî_Æl
) {

3892 
u64
 
°¨t
 = 
eb
->°¨à+ 
bio_off£t
;

3893 
∑ge
 *∑gê
bvec
->
bv_∑ge
;

3894 
u32
 
Àn
 = 
bvec
->
bv_Àn
;

3896 i‡(
u±od©e
)

3897 
	`båfs_∑ge_£t_u±od©e
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

3899 
	`båfs_∑ge_˛ór_u±od©e
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

3901 
bio_off£t
 +
Àn
;

3904 
	`˛ór_bô
(
EXTENT_BUFFER_READING
, &
eb
->
bÊags
);

3905 
	`smp_mb__a·î_©omic
();

3906 
	`wake_up_bô
(&
eb
->
bÊags
, 
EXTENT_BUFFER_READING
);

3907 
	`‰ì_exã¡_buf„r
(
eb
);

3909 
	`bio_put
(&
bbio
->
bio
);

3910 
	}
}

3912 
	$ªad_exã¡_buf„r_∑ges
(
exã¡_buf„r
 *
eb
, 
waô
, 
múr‹_num
,

3913 
båfs_åì_∑ª¡_check
 *
check
)

3915 
num_∑ges
 = 
	`num_exã¡_∑ges
(
eb
), 
i
;

3916 
båfs_bio
 *
bbio
;

3918 i‡(
	`ã°_bô
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bÊags
))

3926 i‡(
	`u∆ikñy
(
	`ã°_bô
(
EXTENT_BUFFER_WRITE_ERR
, &
eb
->
bÊags
)))

3927  -
EIO
;

3930 i‡(
	`ã°_™d_£t_bô
(
EXTENT_BUFFER_READING
, &
eb
->
bÊags
))

3931 
d⁄e
;

3933 
	`˛ór_bô
(
EXTENT_BUFFER_READ_ERR
, &
eb
->
bÊags
);

3934 
eb
->
ªad_múr‹
 = 0;

3935 
	`check_buf„r_åì_ªf
(
eb
);

3936 
	`©omic_öc
(&
eb
->
ªfs
);

3938 
bbio
 = 
	`båfs_bio_Æloc
(
INLINE_EXTENT_BUFFER_PAGES
,

3939 
REQ_OP_READ
 | 
REQ_META
, 
eb
->
fs_öfo
,

3940 
exã¡_buf„r_ªad_íd_io
, 
eb
);

3941 
bbio
->
bio
.
bi_ôî
.
bi_£˘‹
 = 
eb
->
°¨t
 >> 
SECTOR_SHIFT
;

3942 
bbio
->
öode
 = 
	`BTRFS_I
(
eb
->
fs_öfo
->
båì_öode
);

3943 
bbio
->
fûe_off£t
 = 
eb
->
°¨t
;

3944 
	`mem˝y
(&
bbio
->
∑ª¡_check
, 
check
, (*check));

3945 i‡(
eb
->
fs_öfo
->
nodesize
 < 
PAGE_SIZE
) {

3946 
	`__bio_add_∑ge
(&
bbio
->
bio
, 
eb
->
∑ges
[0],Éb->
Àn
,

3947 
eb
->
°¨t
 - 
	`∑ge_off£t
”b->
∑ges
[0]));

3949 
i
 = 0; i < 
num_∑ges
; i++)

3950 
	`__bio_add_∑ge
(&
bbio
->
bio
, 
eb
->
∑ges
[
i
], 
PAGE_SIZE
, 0);

3952 
	`båfs_submô_bio
(
bbio
, 
múr‹_num
);

3954 
d⁄e
:

3955 i‡(
waô
 =
WAIT_COMPLETE
) {

3956 
	`waô_⁄_bô_io
(&
eb
->
bÊags
, 
EXTENT_BUFFER_READING
, 
TASK_UNINTERRUPTIBLE
);

3957 i‡(!
	`ã°_bô
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bÊags
))

3958  -
EIO
;

3962 
	}
}

3964 
boﬁ
 
	$ªp‹t_eb_ønge
(c⁄° 
exã¡_buf„r
 *
eb
, 
°¨t
,

3965 
Àn
)

3967 
	`båfs_w¨n
(
eb
->
fs_öfo
,

3969 
eb
->
°¨t
,Éb->
Àn
, start,Üen);

3970 
	`WARN_ON
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
));

3972  
åue
;

3973 
	}
}

3982 
ölöe
 
	$check_eb_ønge
(c⁄° 
exã¡_buf„r
 *
eb
,

3983 
°¨t
, 
Àn
)

3985 
off£t
;

3988 i‡(
	`u∆ikñy
(
	`check_add_ovîÊow
(
°¨t
, 
Àn
, &
off£t
Ë|| off£à> 
eb
->len))

3989  
	`ªp‹t_eb_ønge
(
eb
, 
°¨t
, 
Àn
);

3991  
Ál£
;

3992 
	}
}

3994 
	$ªad_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
eb
, *
d°v
,

3995 
°¨t
, 
Àn
)

3997 
size_t
 
cur
;

3998 
size_t
 
off£t
;

3999 
∑ge
 *page;

4000 *
kaddr
;

4001 *
d°
 = (*)
d°v
;

4002 
i
 = 
	`gë_eb_∑ge_ödex
(
°¨t
);

4004 i‡(
	`check_eb_ønge
(
eb
, 
°¨t
, 
Àn
)) {

4009 
	`mem£t
(
d°v
, 0, 
Àn
);

4013 
off£t
 = 
	`gë_eb_off£t_ö_∑ge
(
eb
, 
°¨t
);

4015 
Àn
 > 0) {

4016 
∑ge
 = 
eb
->
∑ges
[
i
];

4018 
cur
 = 
	`mö
(
Àn
, (
PAGE_SIZE
 - 
off£t
));

4019 
kaddr
 = 
	`∑ge_addªss
(
∑ge
);

4020 
	`mem˝y
(
d°
, 
kaddr
 + 
off£t
, 
cur
);

4022 
d°
 +
cur
;

4023 
Àn
 -
cur
;

4024 
off£t
 = 0;

4025 
i
++;

4027 
	}
}

4029 
	$ªad_exã¡_buf„r_to_u£r_noÁu…
(c⁄° 
exã¡_buf„r
 *
eb
,

4030 
__u£r
 *
d°v
,

4031 
°¨t
, 
Àn
)

4033 
size_t
 
cur
;

4034 
size_t
 
off£t
;

4035 
∑ge
 *page;

4036 *
kaddr
;

4037 
__u£r
 *
d°
 = (__u£∏*)
d°v
;

4038 
i
 = 
	`gë_eb_∑ge_ödex
(
°¨t
);

4039 
ªt
 = 0;

4041 
	`WARN_ON
(
°¨t
 > 
eb
->
Àn
);

4042 
	`WARN_ON
(
°¨t
 + 
Àn
 > 
eb
->start +Éb->len);

4044 
off£t
 = 
	`gë_eb_off£t_ö_∑ge
(
eb
, 
°¨t
);

4046 
Àn
 > 0) {

4047 
∑ge
 = 
eb
->
∑ges
[
i
];

4049 
cur
 = 
	`mö
(
Àn
, (
PAGE_SIZE
 - 
off£t
));

4050 
kaddr
 = 
	`∑ge_addªss
(
∑ge
);

4051 i‡(
	`c›y_to_u£r_noÁu…
(
d°
, 
kaddr
 + 
off£t
, 
cur
)) {

4052 
ªt
 = -
EFAULT
;

4056 
d°
 +
cur
;

4057 
Àn
 -
cur
;

4058 
off£t
 = 0;

4059 
i
++;

4062  
ªt
;

4063 
	}
}

4065 
	$memcmp_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
eb
, c⁄° *
±rv
,

4066 
°¨t
, 
Àn
)

4068 
size_t
 
cur
;

4069 
size_t
 
off£t
;

4070 
∑ge
 *page;

4071 *
kaddr
;

4072 *
±r
 = (*)
±rv
;

4073 
i
 = 
	`gë_eb_∑ge_ödex
(
°¨t
);

4074 
ªt
 = 0;

4076 i‡(
	`check_eb_ønge
(
eb
, 
°¨t
, 
Àn
))

4077  -
EINVAL
;

4079 
off£t
 = 
	`gë_eb_off£t_ö_∑ge
(
eb
, 
°¨t
);

4081 
Àn
 > 0) {

4082 
∑ge
 = 
eb
->
∑ges
[
i
];

4084 
cur
 = 
	`mö
(
Àn
, (
PAGE_SIZE
 - 
off£t
));

4086 
kaddr
 = 
	`∑ge_addªss
(
∑ge
);

4087 
ªt
 = 
	`memcmp
(
±r
, 
kaddr
 + 
off£t
, 
cur
);

4088 i‡(
ªt
)

4091 
±r
 +
cur
;

4092 
Àn
 -
cur
;

4093 
off£t
 = 0;

4094 
i
++;

4096  
ªt
;

4097 
	}
}

4105 
	$as£π_eb_∑ge_u±od©e
(c⁄° 
exã¡_buf„r
 *
eb
,

4106 
∑ge
 *page)

4108 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

4118 i‡(
	`ã°_bô
(
EXTENT_BUFFER_WRITE_ERR
, &
eb
->
bÊags
))

4121 i‡(
fs_öfo
->
nodesize
 < 
PAGE_SIZE
) {

4122 i‡(
	`WARN_ON
(!
	`båfs_sub∑ge_ã°_u±od©e
(
fs_öfo
, 
∑ge
,

4123 
eb
->
°¨t
,Éb->
Àn
)))

4124 
	`båfs_sub∑ge_dump_bôm≠
(
fs_öfo
, 
∑ge
, 
eb
->
°¨t
,Éb->
Àn
);

4126 
	`WARN_ON
(!
	`PageU±od©e
(
∑ge
));

4128 
	}
}

4130 
	$__wrôe_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
eb
,

4131 c⁄° *
§cv
, 
°¨t
,

4132 
Àn
, 
boﬁ
 
u£_memmove
)

4134 
size_t
 
cur
;

4135 
size_t
 
off£t
;

4136 
∑ge
 *page;

4137 *
kaddr
;

4138 *
§c
 = (*)
§cv
;

4139 
i
 = 
	`gë_eb_∑ge_ödex
(
°¨t
);

4141 c⁄° 
boﬁ
 
check_u±od©e
 = !
	`ã°_bô
(
EXTENT_BUFFER_UNMAPPED
, &
eb
->
bÊags
);

4143 
	`WARN_ON
(
	`ã°_bô
(
EXTENT_BUFFER_NO_CHECK
, &
eb
->
bÊags
));

4145 i‡(
	`check_eb_ønge
(
eb
, 
°¨t
, 
Àn
))

4148 
off£t
 = 
	`gë_eb_off£t_ö_∑ge
(
eb
, 
°¨t
);

4150 
Àn
 > 0) {

4151 
∑ge
 = 
eb
->
∑ges
[
i
];

4152 i‡(
check_u±od©e
)

4153 
	`as£π_eb_∑ge_u±od©e
(
eb
, 
∑ge
);

4155 
cur
 = 
	`mö
(
Àn
, 
PAGE_SIZE
 - 
off£t
);

4156 
kaddr
 = 
	`∑ge_addªss
(
∑ge
);

4157 i‡(
u£_memmove
)

4158 
	`memmove
(
kaddr
 + 
off£t
, 
§c
, 
cur
);

4160 
	`mem˝y
(
kaddr
 + 
off£t
, 
§c
, 
cur
);

4162 
§c
 +
cur
;

4163 
Àn
 -
cur
;

4164 
off£t
 = 0;

4165 
i
++;

4167 
	}
}

4169 
	$wrôe_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
eb
, c⁄° *
§cv
,

4170 
°¨t
, 
Àn
)

4172  
	`__wrôe_exã¡_buf„r
(
eb
, 
§cv
, 
°¨t
, 
Àn
, 
Ál£
);

4173 
	}
}

4175 
	$mem£t_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
eb
, 
c
,

4176 
°¨t
, 
Àn
)

4178 
cur
 = 
°¨t
;

4180 
cur
 < 
°¨t
 + 
Àn
) {

4181 
ödex
 = 
	`gë_eb_∑ge_ödex
(
cur
);

4182 
off£t
 = 
	`gë_eb_off£t_ö_∑ge
(
eb
, 
cur
);

4183 
cur_Àn
 = 
	`mö
(
°¨t
 + 
Àn
 - 
cur
, 
PAGE_SIZE
 - 
off£t
);

4184 
∑ge
 *∑gê
eb
->
∑ges
[
ödex
];

4186 
	`as£π_eb_∑ge_u±od©e
(
eb
, 
∑ge
);

4187 
	`mem£t
(
	`∑ge_addªss
(
∑ge
Ë+ 
off£t
, 
c
, 
cur_Àn
);

4189 
cur
 +
cur_Àn
;

4191 
	}
}

4193 
	$memzîo_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
eb
, 
°¨t
,

4194 
Àn
)

4196 i‡(
	`check_eb_ønge
(
eb
, 
°¨t
, 
Àn
))

4198  
	`mem£t_exã¡_buf„r
(
eb
, 0, 
°¨t
, 
Àn
);

4199 
	}
}

4201 
	$c›y_exã¡_buf„r_fuŒ
(c⁄° 
exã¡_buf„r
 *
d°
,

4202 c⁄° 
exã¡_buf„r
 *
§c
)

4204 
cur
 = 0;

4206 
	`ASSERT
(
d°
->
Àn
 =
§c
->len);

4208 
cur
 < 
§c
->
Àn
) {

4209 
ödex
 = 
	`gë_eb_∑ge_ödex
(
cur
);

4210 
off£t
 = 
	`gë_eb_off£t_ö_∑ge
(
§c
, 
cur
);

4211 
cur_Àn
 = 
	`mö
(
§c
->
Àn
, 
PAGE_SIZE
 - 
off£t
);

4212 *
addr
 = 
	`∑ge_addªss
(
§c
->
∑ges
[
ödex
]Ë+ 
off£t
;

4214 
	`wrôe_exã¡_buf„r
(
d°
, 
addr
, 
cur
, 
cur_Àn
);

4216 
cur
 +
cur_Àn
;

4218 
	}
}

4220 
	$c›y_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
d°
,

4221 c⁄° 
exã¡_buf„r
 *
§c
,

4222 
d°_off£t
, 
§c_off£t
,

4223 
Àn
)

4225 
u64
 
d°_Àn
 = 
d°
->
Àn
;

4226 
size_t
 
cur
;

4227 
size_t
 
off£t
;

4228 
∑ge
 *page;

4229 *
kaddr
;

4230 
i
 = 
	`gë_eb_∑ge_ödex
(
d°_off£t
);

4232 i‡(
	`check_eb_ønge
(
d°
, 
d°_off£t
, 
Àn
) ||

4233 
	`check_eb_ønge
(
§c
, 
§c_off£t
, 
Àn
))

4236 
	`WARN_ON
(
§c
->
Àn
 !
d°_Àn
);

4238 
off£t
 = 
	`gë_eb_off£t_ö_∑ge
(
d°
, 
d°_off£t
);

4240 
Àn
 > 0) {

4241 
∑ge
 = 
d°
->
∑ges
[
i
];

4242 
	`as£π_eb_∑ge_u±od©e
(
d°
, 
∑ge
);

4244 
cur
 = 
	`mö
(
Àn
, ()(
PAGE_SIZE
 - 
off£t
));

4246 
kaddr
 = 
	`∑ge_addªss
(
∑ge
);

4247 
	`ªad_exã¡_buf„r
(
§c
, 
kaddr
 + 
off£t
, 
§c_off£t
, 
cur
);

4249 
§c_off£t
 +
cur
;

4250 
Àn
 -
cur
;

4251 
off£t
 = 0;

4252 
i
++;

4254 
	}
}

4269 
ölöe
 
	$eb_bôm≠_off£t
(c⁄° 
exã¡_buf„r
 *
eb
,

4270 
°¨t
, 
ƒ
,

4271 *
∑ge_ödex
,

4272 
size_t
 *
∑ge_off£t
)

4274 
size_t
 
byã_off£t
 = 
	`BIT_BYTE
(
ƒ
);

4275 
size_t
 
off£t
;

4282 
off£t
 = 
°¨t
 + 
	`off£t_ö_∑ge
(
eb
->°¨tË+ 
byã_off£t
;

4284 *
∑ge_ödex
 = 
off£t
 >> 
PAGE_SHIFT
;

4285 *
∑ge_off£t
 = 
	`off£t_ö_∑ge
(
off£t
);

4286 
	}
}

4295 
	$exã¡_buf„r_ã°_bô
(c⁄° 
exã¡_buf„r
 *
eb
, 
°¨t
,

4296 
ƒ
)

4298 
u8
 *
kaddr
;

4299 
∑ge
 *page;

4300 
i
;

4301 
size_t
 
off£t
;

4303 
	`eb_bôm≠_off£t
(
eb
, 
°¨t
, 
ƒ
, &
i
, &
off£t
);

4304 
∑ge
 = 
eb
->
∑ges
[
i
];

4305 
	`as£π_eb_∑ge_u±od©e
(
eb
, 
∑ge
);

4306 
kaddr
 = 
	`∑ge_addªss
(
∑ge
);

4307  1U & (
kaddr
[
off£t
] >> (
ƒ
 & (
BITS_PER_BYTE
 - 1)));

4308 
	}
}

4310 
u8
 *
	$exã¡_buf„r_gë_byã
(c⁄° 
exã¡_buf„r
 *
eb
, 
byãƒ
)

4312 
ödex
 = 
	`gë_eb_∑ge_ödex
(
byãƒ
);

4314 i‡(
	`check_eb_ønge
(
eb
, 
byãƒ
, 1))

4315  
NULL
;

4316  
	`∑ge_addªss
(
eb
->
∑ges
[
ödex
]Ë+ 
	`gë_eb_off£t_ö_∑ge
”b, 
byãƒ
);

4317 
	}
}

4327 
	$exã¡_buf„r_bôm≠_£t
(c⁄° 
exã¡_buf„r
 *
eb
, 
°¨t
,

4328 
pos
, 
Àn
)

4330 
fú°_byã
 = 
°¨t
 + 
	`BIT_BYTE
(
pos
);

4331 
œ°_byã
 = 
°¨t
 + 
	`BIT_BYTE
(
pos
 + 
Àn
 - 1);

4332 c⁄° 
boﬁ
 
ßme_byã
 = (
fú°_byã
 =
œ°_byã
);

4333 
u8
 
mask
 = 
	`BITMAP_FIRST_BYTE_MASK
(
pos
);

4334 
u8
 *
kaddr
;

4336 i‡(
ßme_byã
)

4337 
mask
 &
	`BITMAP_LAST_BYTE_MASK
(
pos
 + 
Àn
);

4340 
kaddr
 = 
	`exã¡_buf„r_gë_byã
(
eb
, 
fú°_byã
);

4341 *
kaddr
 |
mask
;

4342 i‡(
ßme_byã
)

4346 
	`ASSERT
(
fú°_byã
 + 1 <
œ°_byã
);

4347 
	`mem£t_exã¡_buf„r
(
eb
, 0xff, 
fú°_byã
 + 1, 
œ°_byã
 - first_byte - 1);

4350 
kaddr
 = 
	`exã¡_buf„r_gë_byã
(
eb
, 
œ°_byã
);

4351 *
kaddr
 |
	`BITMAP_LAST_BYTE_MASK
(
pos
 + 
Àn
);

4352 
	}
}

4363 
	$exã¡_buf„r_bôm≠_˛ór
(c⁄° 
exã¡_buf„r
 *
eb
,

4364 
°¨t
, 
pos
,

4365 
Àn
)

4367 
fú°_byã
 = 
°¨t
 + 
	`BIT_BYTE
(
pos
);

4368 
œ°_byã
 = 
°¨t
 + 
	`BIT_BYTE
(
pos
 + 
Àn
 - 1);

4369 c⁄° 
boﬁ
 
ßme_byã
 = (
fú°_byã
 =
œ°_byã
);

4370 
u8
 
mask
 = 
	`BITMAP_FIRST_BYTE_MASK
(
pos
);

4371 
u8
 *
kaddr
;

4373 i‡(
ßme_byã
)

4374 
mask
 &
	`BITMAP_LAST_BYTE_MASK
(
pos
 + 
Àn
);

4377 
kaddr
 = 
	`exã¡_buf„r_gë_byã
(
eb
, 
fú°_byã
);

4378 *
kaddr
 &~
mask
;

4379 i‡(
ßme_byã
)

4383 
	`ASSERT
(
fú°_byã
 + 1 <
œ°_byã
);

4384 
	`mem£t_exã¡_buf„r
(
eb
, 0, 
fú°_byã
 + 1, 
œ°_byã
 - first_byte - 1);

4387 
kaddr
 = 
	`exã¡_buf„r_gë_byã
(
eb
, 
œ°_byã
);

4388 *
kaddr
 &~
	`BITMAP_LAST_BYTE_MASK
(
pos
 + 
Àn
);

4389 
	}
}

4391 
ölöe
 
boﬁ
 
	$¨ós_ovîœp
(
§c
, 
d°
, 
Àn
)

4393 
di°™˚
 = (
§c
 > 
d°
) ? src - dst : dst - src;

4394  
di°™˚
 < 
Àn
;

4395 
	}
}

4397 
	$mem˝y_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
d°
,

4398 
d°_off£t
, 
§c_off£t
,

4399 
Àn
)

4401 
cur_off
 = 0;

4403 i‡(
	`check_eb_ønge
(
d°
, 
d°_off£t
, 
Àn
) ||

4404 
	`check_eb_ønge
(
d°
, 
§c_off£t
, 
Àn
))

4407 
cur_off
 < 
Àn
) {

4408 
cur_§c
 = 
cur_off
 + 
§c_off£t
;

4409 
pg_ödex
 = 
	`gë_eb_∑ge_ödex
(
cur_§c
);

4410 
pg_off
 = 
	`gë_eb_off£t_ö_∑ge
(
d°
, 
cur_§c
);

4411 
cur_Àn
 = 
	`mö
(
§c_off£t
 + 
Àn
 - 
cur_§c
,

4412 
PAGE_SIZE
 - 
pg_off
);

4413 *
§c_addr
 = 
	`∑ge_addªss
(
d°
->
∑ges
[
pg_ödex
]Ë+ 
pg_off
;

4414 c⁄° 
boﬁ
 
u£_memmove
 = 
	`¨ós_ovîœp
(
§c_off£t
 + 
cur_off
,

4415 
d°_off£t
 + 
cur_off
, 
cur_Àn
);

4417 
	`__wrôe_exã¡_buf„r
(
d°
, 
§c_addr
, 
d°_off£t
 + 
cur_off
, 
cur_Àn
,

4418 
u£_memmove
);

4419 
cur_off
 +
cur_Àn
;

4421 
	}
}

4423 
	$memmove_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
d°
,

4424 
d°_off£t
, 
§c_off£t
,

4425 
Àn
)

4427 
d°_íd
 = 
d°_off£t
 + 
Àn
 - 1;

4428 
§c_íd
 = 
§c_off£t
 + 
Àn
 - 1;

4430 i‡(
	`check_eb_ønge
(
d°
, 
d°_off£t
, 
Àn
) ||

4431 
	`check_eb_ønge
(
d°
, 
§c_off£t
, 
Àn
))

4434 i‡(
d°_off£t
 < 
§c_off£t
) {

4435 
	`mem˝y_exã¡_buf„r
(
d°
, 
d°_off£t
, 
§c_off£t
, 
Àn
);

4439 
Àn
 > 0) {

4440 
§c_i
;

4441 
size_t
 
cur
;

4442 
size_t
 
d°_off_ö_∑ge
;

4443 
size_t
 
§c_off_ö_∑ge
;

4444 *
§c_addr
;

4445 
boﬁ
 
u£_memmove
;

4447 
§c_i
 = 
	`gë_eb_∑ge_ödex
(
§c_íd
);

4449 
d°_off_ö_∑ge
 = 
	`gë_eb_off£t_ö_∑ge
(
d°
, 
d°_íd
);

4450 
§c_off_ö_∑ge
 = 
	`gë_eb_off£t_ö_∑ge
(
d°
, 
§c_íd
);

4452 
cur
 = 
	`mö_t
(, 
Àn
, 
§c_off_ö_∑ge
 + 1);

4453 
cur
 = 
	`mö
(cur, 
d°_off_ö_∑ge
 + 1);

4455 
§c_addr
 = 
	`∑ge_addªss
(
d°
->
∑ges
[
§c_i
]Ë+ 
§c_off_ö_∑ge
 -

4456 
cur
 + 1;

4457 
u£_memmove
 = 
	`¨ós_ovîœp
(
§c_íd
 - 
cur
 + 1, 
d°_íd
 - cur + 1,

4458 
cur
);

4460 
	`__wrôe_exã¡_buf„r
(
d°
, 
§c_addr
, 
d°_íd
 - 
cur
 + 1, cur,

4461 
u£_memmove
);

4463 
d°_íd
 -
cur
;

4464 
§c_íd
 -
cur
;

4465 
Àn
 -
cur
;

4467 
	}
}

4469 
	#GANG_LOOKUP_SIZE
 16

	)

4470 
exã¡_buf„r
 *
	$gë_√xt_exã¡_buf„r
(

4471 
båfs_fs_öfo
 *
fs_öfo
, 
∑ge
 *∑ge, 
u64
 
byãƒ
)

4473 
exã¡_buf„r
 *
g™g
[
GANG_LOOKUP_SIZE
];

4474 
exã¡_buf„r
 *
found
 = 
NULL
;

4475 
u64
 
∑ge_°¨t
 = 
	`∑ge_off£t
(
∑ge
);

4476 
u64
 
cur
 = 
∑ge_°¨t
;

4478 
	`ASSERT
(
	`ö_ønge
(
byãƒ
, 
∑ge_°¨t
, 
PAGE_SIZE
));

4479 
	`lockdï_as£π_hñd
(&
fs_öfo
->
buf„r_lock
);

4481 
cur
 < 
∑ge_°¨t
 + 
PAGE_SIZE
) {

4482 
ªt
;

4483 
i
;

4485 
ªt
 = 
	`ødix_åì_g™g_lookup
(&
fs_öfo
->
buf„r_ødix
,

4486 (**)
g™g
, 
cur
 >> 
fs_öfo
->
£˘‹size_bôs
,

4487 
	`mö_t
(, 
GANG_LOOKUP_SIZE
,

4488 
PAGE_SIZE
 / 
fs_öfo
->
nodesize
));

4489 i‡(
ªt
 == 0)

4490 
out
;

4491 
i
 = 0; i < 
ªt
; i++) {

4493 i‡(
g™g
[
i
]->
°¨t
 >
∑ge_°¨t
 + 
PAGE_SIZE
)

4494 
out
;

4496 i‡(
g™g
[
i
]->
°¨t
 >
byãƒ
) {

4497 
found
 = 
g™g
[
i
];

4498 
out
;

4501 
cur
 = 
g™g
[
ªt
 - 1]->
°¨t
 + g™g[ªà- 1]->
Àn
;

4503 
out
:

4504  
found
;

4505 
	}
}

4507 
	$åy_ªÀa£_sub∑ge_exã¡_buf„r
(
∑ge
 *page)

4509 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
∑ge
->
m≠pög
->
ho°
->
i_sb
);

4510 
u64
 
cur
 = 
	`∑ge_off£t
(
∑ge
);

4511 c⁄° 
u64
 
íd
 = 
	`∑ge_off£t
(
∑ge
Ë+ 
PAGE_SIZE
;

4512 
ªt
;

4514 
cur
 < 
íd
) {

4515 
exã¡_buf„r
 *
eb
 = 
NULL
;

4525 
	`•ö_lock
(&
fs_öfo
->
buf„r_lock
);

4526 
eb
 = 
	`gë_√xt_exã¡_buf„r
(
fs_öfo
, 
∑ge
, 
cur
);

4527 i‡(!
eb
) {

4529 
	`•ö_u∆ock
(&
fs_öfo
->
buf„r_lock
);

4532 
cur
 = 
eb
->
°¨t
 +Éb->
Àn
;

4538 
	`•ö_lock
(&
eb
->
ªfs_lock
);

4539 i‡(
	`©omic_ªad
(&
eb
->
ªfs
Ë!1 || 
	`exã¡_buf„r_undî_io
(eb)) {

4540 
	`•ö_u∆ock
(&
eb
->
ªfs_lock
);

4541 
	`•ö_u∆ock
(&
fs_öfo
->
buf„r_lock
);

4544 
	`•ö_u∆ock
(&
fs_öfo
->
buf„r_lock
);

4551 i‡(!
	`ã°_™d_˛ór_bô
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bÊags
)) {

4552 
	`•ö_u∆ock
(&
eb
->
ªfs_lock
);

4561 
	`ªÀa£_exã¡_buf„r
(
eb
);

4567 
	`•ö_lock
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

4568 i‡(!
	`PagePriv©e
(
∑ge
))

4569 
ªt
 = 1;

4571 
ªt
 = 0;

4572 
	`•ö_u∆ock
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

4573  
ªt
;

4575 
	}
}

4577 
	$åy_ªÀa£_exã¡_buf„r
(
∑ge
 *page)

4579 
exã¡_buf„r
 *
eb
;

4581 i‡(
	`båfs_sb
(
∑ge
->
m≠pög
->
ho°
->
i_sb
)->
nodesize
 < 
PAGE_SIZE
)

4582  
	`åy_ªÀa£_sub∑ge_exã¡_buf„r
(
∑ge
);

4588 
	`•ö_lock
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

4589 i‡(!
	`PagePriv©e
(
∑ge
)) {

4590 
	`•ö_u∆ock
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

4594 
eb
 = (
exã¡_buf„r
 *)
∑ge
->
¥iv©e
;

4595 
	`BUG_ON
(!
eb
);

4602 
	`•ö_lock
(&
eb
->
ªfs_lock
);

4603 i‡(
	`©omic_ªad
(&
eb
->
ªfs
Ë!1 || 
	`exã¡_buf„r_undî_io
(eb)) {

4604 
	`•ö_u∆ock
(&
eb
->
ªfs_lock
);

4605 
	`•ö_u∆ock
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

4608 
	`•ö_u∆ock
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

4614 i‡(!
	`ã°_™d_˛ór_bô
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bÊags
)) {

4615 
	`•ö_u∆ock
(&
eb
->
ªfs_lock
);

4619  
	`ªÀa£_exã¡_buf„r
(
eb
);

4620 
	}
}

4634 
	$båfs_ªadahód_åì_block
(
båfs_fs_öfo
 *
fs_öfo
,

4635 
u64
 
byãƒ
, u64 
ow√r_roŸ
, u64 
gí
, 
Àvñ
)

4637 
båfs_åì_∑ª¡_check
 
check
 = {

4638 .
has_fú°_key
 = 0,

4639 .
Àvñ
 =Üevel,

4640 .
å™sid
 = 
gí


4642 
exã¡_buf„r
 *
eb
;

4643 
ªt
;

4645 
eb
 = 
	`båfs_föd_¸óã_åì_block
(
fs_öfo
, 
byãƒ
, 
ow√r_roŸ
, 
Àvñ
);

4646 i‡(
	`IS_ERR
(
eb
))

4649 i‡(
	`båfs_buf„r_u±od©e
(
eb
, 
gí
, 1)) {

4650 
	`‰ì_exã¡_buf„r
(
eb
);

4654 
ªt
 = 
	`ªad_exã¡_buf„r_∑ges
(
eb
, 
WAIT_NONE
, 0, &
check
);

4655 i‡(
ªt
 < 0)

4656 
	`‰ì_exã¡_buf„r_°Æe
(
eb
);

4658 
	`‰ì_exã¡_buf„r
(
eb
);

4659 
	}
}

4669 
	$båfs_ªadahód_node_chûd
(
exã¡_buf„r
 *
node
, 
¶Ÿ
)

4671 
	`båfs_ªadahód_åì_block
(
node
->
fs_öfo
,

4672 
	`båfs_node_block±r
(
node
, 
¶Ÿ
),

4673 
	`båfs_hódî_ow√r
(
node
),

4674 
	`båfs_node_±r_gíî©i⁄
(
node
, 
¶Ÿ
),

4675 
	`båfs_hódî_Àvñ
(
node
) - 1);

4676 
	}
}

	@extent_io.h

3 #i‚de‡
BTRFS_EXTENT_IO_H


4 
	#BTRFS_EXTENT_IO_H


	)

6 
	~<löux/rbåì.h
>

7 
	~<löux/ªfcou¡.h
>

8 
	~<löux/fõm≠.h
>

9 
	~<löux/båfs_åì.h
>

10 
	~"com¥essi⁄.h
"

11 
	~"uli°.h
"

12 
	~"misc.h
"

14 
	gbåfs_å™s_h™dÀ
;

17 
	mEXTENT_BUFFER_UPTODATE
,

18 
	mEXTENT_BUFFER_DIRTY
,

19 
	mEXTENT_BUFFER_CORRUPT
,

21 
	mEXTENT_BUFFER_READAHEAD
,

22 
	mEXTENT_BUFFER_TREE_REF
,

23 
	mEXTENT_BUFFER_STALE
,

24 
	mEXTENT_BUFFER_WRITEBACK
,

26 
	mEXTENT_BUFFER_READ_ERR
,

27 
	mEXTENT_BUFFER_UNMAPPED
,

28 
	mEXTENT_BUFFER_IN_TREE
,

30 
	mEXTENT_BUFFER_WRITE_ERR
,

31 
	mEXTENT_BUFFER_NO_CHECK
,

33 
	mEXTENT_BUFFER_READING
,

38 
ENUM_BIT
(
PAGE_UNLOCK
),

40 
ENUM_BIT
(
PAGE_START_WRITEBACK
),

41 
ENUM_BIT
(
PAGE_END_WRITEBACK
),

42 
ENUM_BIT
(
PAGE_SET_ORDERED
),

49 
	#EXTENT_PAGE_PRIVATE
 1

	)

58 
	#BIT_BYTE
(
ƒ
Ë(“rË/ 
BITS_PER_BYTE
)

	)

59 
	#BYTE_MASK
 ((1 << 
BITS_PER_BYTE
Ë- 1)

	)

60 
	#BITMAP_FIRST_BYTE_MASK
(
°¨t
) \

61 ((
BYTE_MASK
 << ((
°¨t
Ë& (
BITS_PER_BYTE
 - 1))Ë& BYTE_MASK)

	)

62 
	#BITMAP_LAST_BYTE_MASK
(
nbôs
) \

63 (
BYTE_MASK
 >> (-(
nbôs
Ë& (
BITS_PER_BYTE
 - 1)))

	)

65 
	gbåfs_roŸ
;

66 
	gbåfs_öode
;

67 
	gbåfs_fs_öfo
;

68 
	gexã¡_io_åì
;

69 
	gbåfs_åì_∑ª¡_check
;

71 
__öô
 
exã¡_buf„r_öô_ˇchï
();

72 
__cﬁd
 
exã¡_buf„r_‰ì_ˇchï
();

74 
	#INLINE_EXTENT_BUFFER_PAGES
 (
BTRFS_MAX_METADATA_BLOCKSIZE
 / 
PAGE_SIZE
)

	)

75 
	sexã¡_buf„r
 {

76 
u64
 
	m°¨t
;

77 
	mÀn
;

78 
	mbÊags
;

79 
båfs_fs_öfo
 *
	mfs_öfo
;

80 
•ölock_t
 
	mªfs_lock
;

81 
©omic_t
 
	mªfs
;

82 
	mªad_múr‹
;

83 
rcu_hód
 
	mrcu_hód
;

84 
pid_t
 
	mlock_ow√r
;

86 
s8
 
	mlog_ödex
;

88 
rw_£m≠h‹e
 
	mlock
;

90 
∑ge
 *
	m∑ges
[
INLINE_EXTENT_BUFFER_PAGES
];

91 #ifde‡
CONFIG_BTRFS_DEBUG


92 
li°_hód
 
	mÀak_li°
;

96 
	sbåfs_eb_wrôe_c⁄ãxt
 {

97 
wrôeback_c⁄åﬁ
 *
	mwbc
;

98 
exã¡_buf„r
 *
	meb
;

100 
båfs_block_group
 *
	mz⁄ed_bg
;

111 
ölöe
 
size_t
 
	$gë_eb_off£t_ö_∑ge
(c⁄° 
exã¡_buf„r
 *
eb
,

112 
off£t
)

121  
	`off£t_ö_∑ge
(
off£t
 + 
eb
->
°¨t
);

122 
	}
}

124 
ölöe
 
	$gë_eb_∑ge_ödex
(
off£t
)

133  
off£t
 >> 
PAGE_SHIFT
;

134 
	}
}

139 
	sexã¡_ch™ge£t
 {

141 
u64
 
	mbyãs_ch™ged
;

144 
uli°
 
	mønge_ch™ged
;

147 
ölöe
 
	$exã¡_ch™ge£t_öô
(
exã¡_ch™ge£t
 *
ch™ge£t
)

149 
ch™ge£t
->
byãs_ch™ged
 = 0;

150 
	`uli°_öô
(&
ch™ge£t
->
ønge_ch™ged
);

151 
	}
}

153 
ölöe
 
exã¡_ch™ge£t
 *
	$exã¡_ch™ge£t_Æloc
()

155 
exã¡_ch™ge£t
 *
ªt
;

157 
ªt
 = 
	`kmÆloc
((*ªt), 
GFP_KERNEL
);

158 i‡(!
ªt
)

159  
NULL
;

161 
	`exã¡_ch™ge£t_öô
(
ªt
);

162  
ªt
;

163 
	}
}

165 
ölöe
 
	$exã¡_ch™ge£t_ªÀa£
(
exã¡_ch™ge£t
 *
ch™ge£t
)

167 i‡(!
ch™ge£t
)

169 
ch™ge£t
->
byãs_ch™ged
 = 0;

170 
	`uli°_ªÀa£
(&
ch™ge£t
->
ønge_ch™ged
);

171 
	}
}

173 
ölöe
 
	$exã¡_ch™ge£t_‰ì
(
exã¡_ch™ge£t
 *
ch™ge£t
)

175 i‡(!
ch™ge£t
)

177 
	`exã¡_ch™ge£t_ªÀa£
(
ch™ge£t
);

178 
	`k‰ì
(
ch™ge£t
);

179 
	}
}

181 
	gexã¡_m≠_åì
;

183 
åy_ªÀa£_exã¡_m≠pög
(
∑ge
 *∑ge, 
gÂ_t
 
mask
);

184 
åy_ªÀa£_exã¡_buf„r
(
∑ge
 *page);

186 
båfs_ªad_fﬁio
(
fûe
 *fûe, 
fﬁio
 *folio);

187 
exã¡_wrôe_locked_ønge
(
öode
 *öode, 
∑ge
 *
locked_∑ge
,

188 
u64
 
°¨t
, u64 
íd
, 
wrôeback_c⁄åﬁ
 *
wbc
,

189 
boﬁ
 
∑ges_dúty
);

190 
exã¡_wrôïages
(
addªss_•a˚
 *
m≠pög
,

191 
wrôeback_c⁄åﬁ
 *
wbc
);

192 
båì_wrôe_ˇche_∑ges
(
addªss_•a˚
 *
m≠pög
,

193 
wrôeback_c⁄åﬁ
 *
wbc
);

194 
exã¡_ªadahód
(
ªadahód_c⁄åﬁ
 *
øc
);

195 
exã¡_fõm≠
(
båfs_öode
 *
öode
, 
fõm≠_exã¡_öfo
 *
fõöfo
,

196 
u64
 
°¨t
, u64 
Àn
);

197 
£t_∑ge_exã¡_m≠≥d
(
∑ge
 *page);

198 
˛ór_∑ge_exã¡_m≠≥d
(
∑ge
 *page);

200 
exã¡_buf„r
 *
Æloc_exã¡_buf„r
(
båfs_fs_öfo
 *
fs_öfo
,

201 
u64
 
°¨t
, u64 
ow√r_roŸ
, 
Àvñ
);

202 
exã¡_buf„r
 *
__Æloc_dummy_exã¡_buf„r
(
båfs_fs_öfo
 *
fs_öfo
,

203 
u64
 
°¨t
, 
Àn
);

204 
exã¡_buf„r
 *
Æloc_dummy_exã¡_buf„r
(
båfs_fs_öfo
 *
fs_öfo
,

205 
u64
 
°¨t
);

206 
exã¡_buf„r
 *
båfs_˛⁄e_exã¡_buf„r
(c⁄° exã¡_buf„∏*
§c
);

207 
exã¡_buf„r
 *
föd_exã¡_buf„r
(
båfs_fs_öfo
 *
fs_öfo
,

208 
u64
 
°¨t
);

209 
‰ì_exã¡_buf„r
(
exã¡_buf„r
 *
eb
);

210 
‰ì_exã¡_buf„r_°Æe
(
exã¡_buf„r
 *
eb
);

211 
	#WAIT_NONE
 0

	)

212 
	#WAIT_COMPLETE
 1

	)

213 
	#WAIT_PAGE_LOCK
 2

	)

214 
ªad_exã¡_buf„r_∑ges
(
exã¡_buf„r
 *
eb
, 
waô
, 
múr‹_num
,

215 
båfs_åì_∑ª¡_check
 *
∑ª¡_check
);

216 
waô_⁄_exã¡_buf„r_wrôeback
(
exã¡_buf„r
 *
eb
);

217 
båfs_ªadahód_åì_block
(
båfs_fs_öfo
 *
fs_öfo
,

218 
u64
 
byãƒ
, u64 
ow√r_roŸ
, u64 
gí
, 
Àvñ
);

219 
båfs_ªadahód_node_chûd
(
exã¡_buf„r
 *
node
, 
¶Ÿ
);

221 
ölöe
 
	$num_exã¡_∑ges
(c⁄° 
exã¡_buf„r
 *
eb
)

230  (
eb
->
Àn
 >> 
PAGE_SHIFT
) ?: 1;

231 
	}
}

233 
ölöe
 
	$exã¡_buf„r_u±od©e
(c⁄° 
exã¡_buf„r
 *
eb
)

235  
	`ã°_bô
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bÊags
);

236 
	}
}

238 
memcmp_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
eb
, c⁄° *
±rv
,

239 
°¨t
, 
Àn
);

240 
ªad_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
eb
, *
d°
,

241 
°¨t
,

242 
Àn
);

243 
ªad_exã¡_buf„r_to_u£r_noÁu…
(c⁄° 
exã¡_buf„r
 *
eb
,

244 
__u£r
 *
d°
, 
°¨t
,

245 
Àn
);

246 
wrôe_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
eb
, c⁄° *
§c
,

247 
°¨t
, 
Àn
);

249 
ölöe
 
	$wrôe_exã¡_buf„r_chunk_åì_uuid
(

250 c⁄° 
exã¡_buf„r
 *
eb
, c⁄° *
chunk_åì_uuid
)

252 
	`wrôe_exã¡_buf„r
(
eb
, 
chunk_åì_uuid
,

253 
	`off£tof
(
båfs_hódî
, 
chunk_åì_uuid
),

254 
BTRFS_FSID_SIZE
);

255 
	}
}

257 
ölöe
 
	$wrôe_exã¡_buf„r_fsid
(c⁄° 
exã¡_buf„r
 *
eb
,

258 c⁄° *
fsid
)

260 
	`wrôe_exã¡_buf„r
(
eb
, 
fsid
, 
	`off£tof
(
båfs_hódî
, fsid),

261 
BTRFS_FSID_SIZE
);

262 
	}
}

264 
c›y_exã¡_buf„r_fuŒ
(c⁄° 
exã¡_buf„r
 *
d°
,

265 c⁄° 
exã¡_buf„r
 *
§c
);

266 
c›y_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
d°
,

267 c⁄° 
exã¡_buf„r
 *
§c
,

268 
d°_off£t
, 
§c_off£t
,

269 
Àn
);

270 
mem˝y_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
d°
,

271 
d°_off£t
, 
§c_off£t
,

272 
Àn
);

273 
memmove_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
d°
,

274 
d°_off£t
, 
§c_off£t
,

275 
Àn
);

276 
memzîo_exã¡_buf„r
(c⁄° 
exã¡_buf„r
 *
eb
, 
°¨t
,

277 
Àn
);

278 
exã¡_buf„r_ã°_bô
(c⁄° 
exã¡_buf„r
 *
eb
, 
°¨t
,

279 
pos
);

280 
exã¡_buf„r_bôm≠_£t
(c⁄° 
exã¡_buf„r
 *
eb
, 
°¨t
,

281 
pos
, 
Àn
);

282 
exã¡_buf„r_bôm≠_˛ór
(c⁄° 
exã¡_buf„r
 *
eb
,

283 
°¨t
, 
pos
,

284 
Àn
);

285 
£t_exã¡_buf„r_dúty
(
exã¡_buf„r
 *
eb
);

286 
£t_exã¡_buf„r_u±od©e
(
exã¡_buf„r
 *
eb
);

287 
˛ór_exã¡_buf„r_u±od©e
(
exã¡_buf„r
 *
eb
);

288 
exã¡_ønge_˛ór_dúty_f‹_io
(
öode
 *öode, 
u64
 
°¨t
, u64 
íd
);

289 
exã¡_˛ór_u∆ock_dñÆloc
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
,

290 
∑ge
 *
locked_∑ge
,

291 
u32
 
bôs_to_˛ór
, 
∑ge_›s
);

292 
exã¡_övÆid©e_fﬁio
(
exã¡_io_åì
 *
åì
,

293 
fﬁio
 *fﬁio, 
size_t
 
off£t
);

294 
båfs_˛ór_buf„r_dúty
(
båfs_å™s_h™dÀ
 *
å™s
,

295 
exã¡_buf„r
 *
buf
);

297 
båfs_Æloc_∑ge_¨øy
(
ƒ_∑ges
, 
∑ge
 **
∑ge_¨øy
);

299 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


300 
boﬁ
 
föd_lock_dñÆloc_ønge
(
öode
 *inode,

301 
∑ge
 *
locked_∑ge
, 
u64
 *
°¨t
,

302 
u64
 *
íd
);

304 
exã¡_buf„r
 *
Æloc_ã°_exã¡_buf„r
(
båfs_fs_öfo
 *
fs_öfo
,

305 
u64
 
°¨t
);

307 #ifde‡
CONFIG_BTRFS_DEBUG


308 
båfs_exã¡_buf„r_Àak_debug_check
(
båfs_fs_öfo
 *
fs_öfo
);

310 
	#båfs_exã¡_buf„r_Àak_debug_check
(
fs_öfo
Ëdÿ{} 0)

	)

	@extent_map.c

3 
	~<löux/îr.h
>

4 
	~<löux/¶ab.h
>

5 
	~<löux/•ölock.h
>

6 
	~"mesßges.h
"

7 
	~"˘ªe.h
"

8 
	~"vﬁumes.h
"

9 
	~"exã¡_m≠.h
"

10 
	~"com¥essi⁄.h
"

11 
	~"båfs_öode.h
"

14 
kmem_ˇche
 *
	gexã¡_m≠_ˇche
;

16 
__öô
 
	$exã¡_m≠_öô
()

18 
exã¡_m≠_ˇche
 = 
	`kmem_ˇche_¸óã
("btrfs_extent_map",

19 (
exã¡_m≠
), 0,

20 
SLAB_MEM_SPREAD
, 
NULL
);

21 i‡(!
exã¡_m≠_ˇche
)

22  -
ENOMEM
;

24 
	}
}

26 
__cﬁd
 
	$exã¡_m≠_exô
()

28 
	`kmem_ˇche_de°roy
(
exã¡_m≠_ˇche
);

29 
	}
}

35 
	$exã¡_m≠_åì_öô
(
exã¡_m≠_åì
 *
åì
)

37 
åì
->
m≠
 = 
RB_ROOT_CACHED
;

38 
	`INIT_LIST_HEAD
(&
åì
->
modifõd_exã¡s
);

39 
	`rwlock_öô
(&
åì
->
lock
);

40 
	}
}

46 
exã¡_m≠
 *
	$Æloc_exã¡_m≠
()

48 
exã¡_m≠
 *
em
;

49 
em
 = 
	`kmem_ˇche_zÆloc
(
exã¡_m≠_ˇche
, 
GFP_NOFS
);

50 i‡(!
em
)

51  
NULL
;

52 
	`RB_CLEAR_NODE
(&
em
->
rb_node
);

53 
em
->
com¥ess_ty≥
 = 
BTRFS_COMPRESS_NONE
;

54 
	`ªfcou¡_£t
(&
em
->
ªfs
, 1);

55 
	`INIT_LIST_HEAD
(&
em
->
li°
);

56  
em
;

57 
	}
}

63 
	$‰ì_exã¡_m≠
(
exã¡_m≠
 *
em
)

65 i‡(!
em
)

67 i‡(
	`ªfcou¡_dec_™d_ã°
(&
em
->
ªfs
)) {

68 
	`WARN_ON
(
	`exã¡_m≠_ö_åì
(
em
));

69 
	`WARN_ON
(!
	`li°_em±y
(&
em
->
li°
));

70 i‡(
	`ã°_bô
(
EXTENT_FLAG_FS_MAPPING
, &
em
->
Êags
))

71 
	`k‰ì
(
em
->
m≠_lookup
);

72 
	`kmem_ˇche_‰ì
(
exã¡_m≠_ˇche
, 
em
);

74 
	}
}

77 
u64
 
	$ønge_íd
(
u64
 
°¨t
, u64 
Àn
)

79 i‡(
°¨t
 + 
Àn
 < start)

80  (
u64
)-1;

81  
°¨t
 + 
Àn
;

82 
	}
}

84 
	$åì_ö£π
(
rb_roŸ_ˇched
 *
roŸ
, 
exã¡_m≠
 *
em
)

86 
rb_node
 **
p
 = &
roŸ
->
rb_roŸ
.rb_node;

87 
rb_node
 *
∑ª¡
 = 
NULL
;

88 
exã¡_m≠
 *
íåy
 = 
NULL
;

89 
rb_node
 *
‹ig_∑ª¡
 = 
NULL
;

90 
u64
 
íd
 = 
	`ønge_íd
(
em
->
°¨t
,Ém->
Àn
);

91 
boﬁ
 
À·mo°
 = 
åue
;

93 *
p
) {

94 
∑ª¡
 = *
p
;

95 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
exã¡_m≠
, 
rb_node
);

97 i‡(
em
->
°¨t
 < 
íåy
->start) {

98 
p
 = &(*p)->
rb_À·
;

99 } i‡(
em
->
°¨t
 >
	`exã¡_m≠_íd
(
íåy
)) {

100 
p
 = &(*p)->
rb_right
;

101 
À·mo°
 = 
Ál£
;

103  -
EEXIST
;

107 
‹ig_∑ª¡
 = 
∑ª¡
;

108 
∑ª¡
 && 
em
->
°¨t
 >
	`exã¡_m≠_íd
(
íåy
)) {

109 
∑ª¡
 = 
	`rb_√xt
(parent);

110 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
exã¡_m≠
, 
rb_node
);

112 i‡(
∑ª¡
)

113 i‡(
íd
 > 
íåy
->
°¨t
 && 
em
->°¨à< 
	`exã¡_m≠_íd
(entry))

114  -
EEXIST
;

116 
∑ª¡
 = 
‹ig_∑ª¡
;

117 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
exã¡_m≠
, 
rb_node
);

118 
∑ª¡
 && 
em
->
°¨t
 < 
íåy
->start) {

119 
∑ª¡
 = 
	`rb_¥ev
(parent);

120 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
exã¡_m≠
, 
rb_node
);

122 i‡(
∑ª¡
)

123 i‡(
íd
 > 
íåy
->
°¨t
 && 
em
->°¨à< 
	`exã¡_m≠_íd
(entry))

124  -
EEXIST
;

126 
	`rb_lök_node
(&
em
->
rb_node
, 
‹ig_∑ª¡
, 
p
);

127 
	`rb_ö£π_cﬁ‹_ˇched
(&
em
->
rb_node
, 
roŸ
, 
À·mo°
);

129 
	}
}

135 
rb_node
 *
	$__åì_£¨ch
(
rb_roŸ
 *
roŸ
, 
u64
 
off£t
,

136 
rb_node
 **
¥ev_‹_√xt_ªt
)

138 
rb_node
 *
n
 = 
roŸ
->rb_node;

139 
rb_node
 *
¥ev
 = 
NULL
;

140 
rb_node
 *
‹ig_¥ev
 = 
NULL
;

141 
exã¡_m≠
 *
íåy
;

142 
exã¡_m≠
 *
¥ev_íåy
 = 
NULL
;

144 
	`ASSERT
(
¥ev_‹_√xt_ªt
);

146 
n
) {

147 
íåy
 = 
	`rb_íåy
(
n
, 
exã¡_m≠
, 
rb_node
);

148 
¥ev
 = 
n
;

149 
¥ev_íåy
 = 
íåy
;

151 i‡(
off£t
 < 
íåy
->
°¨t
)

152 
n
 =Ç->
rb_À·
;

153 i‡(
off£t
 >
	`exã¡_m≠_íd
(
íåy
))

154 
n
 =Ç->
rb_right
;

156  
n
;

159 
‹ig_¥ev
 = 
¥ev
;

160 
¥ev
 && 
off£t
 >
	`exã¡_m≠_íd
(
¥ev_íåy
)) {

161 
¥ev
 = 
	`rb_√xt
(prev);

162 
¥ev_íåy
 = 
	`rb_íåy
(
¥ev
, 
exã¡_m≠
, 
rb_node
);

169 i‡(
¥ev
) {

170 *
¥ev_‹_√xt_ªt
 = 
¥ev
;

171  
NULL
;

174 
¥ev
 = 
‹ig_¥ev
;

175 
¥ev_íåy
 = 
	`rb_íåy
(
¥ev
, 
exã¡_m≠
, 
rb_node
);

176 
¥ev
 && 
off£t
 < 
¥ev_íåy
->
°¨t
) {

177 
¥ev
 = 
	`rb_¥ev
(prev);

178 
¥ev_íåy
 = 
	`rb_íåy
(
¥ev
, 
exã¡_m≠
, 
rb_node
);

180 *
¥ev_‹_√xt_ªt
 = 
¥ev
;

182  
NULL
;

183 
	}
}

186 
	$mîgabÀ_m≠s
(
exã¡_m≠
 *
¥ev
, exã¡_m≠ *
√xt
)

188 i‡(
	`ã°_bô
(
EXTENT_FLAG_PINNED
, &
¥ev
->
Êags
))

195 i‡(
	`ã°_bô
(
EXTENT_FLAG_COMPRESSED
, &
¥ev
->
Êags
))

198 i‡(
	`ã°_bô
(
EXTENT_FLAG_LOGGING
, &
¥ev
->
Êags
) ||

199 
	`ã°_bô
(
EXTENT_FLAG_LOGGING
, &
√xt
->
Êags
))

207 i‡(!
	`li°_em±y
(&
¥ev
->
li°
Ë|| !li°_em±y(&
√xt
->list))

210 
	`ASSERT
(
√xt
->
block_°¨t
 !
EXTENT_MAP_DELALLOC
 &&

211 
¥ev
->
block_°¨t
 !
EXTENT_MAP_DELALLOC
);

213 i‡(
¥ev
->
m≠_lookup
 || 
√xt
->map_lookup)

214 
	`ASSERT
(
	`ã°_bô
(
EXTENT_FLAG_FS_MAPPING
, &
¥ev
->
Êags
) &&

215 
	`ã°_bô
(
EXTENT_FLAG_FS_MAPPING
, &
√xt
->
Êags
));

217 i‡(
	`exã¡_m≠_íd
(
¥ev
Ë=
√xt
->
°¨t
 &&

218 
¥ev
->
Êags
 =
√xt
->flags &&

219 
¥ev
->
m≠_lookup
 =
√xt
->map_lookup &&

220 ((
√xt
->
block_°¨t
 =
EXTENT_MAP_HOLE
 &&

221 
¥ev
->
block_°¨t
 =
EXTENT_MAP_HOLE
) ||

222 (
√xt
->
block_°¨t
 =
EXTENT_MAP_INLINE
 &&

223 
¥ev
->
block_°¨t
 =
EXTENT_MAP_INLINE
) ||

224 (
√xt
->
block_°¨t
 < 
EXTENT_MAP_LAST_BYTE
 - 1 &&

225 
√xt
->
block_°¨t
 =
	`exã¡_m≠_block_íd
(
¥ev
)))) {

229 
	}
}

231 
	$åy_mîge_m≠
(
exã¡_m≠_åì
 *
åì
, 
exã¡_m≠
 *
em
)

233 
exã¡_m≠
 *
mîge
 = 
NULL
;

234 
rb_node
 *
rb
;

244 i‡(
	`ªfcou¡_ªad
(&
em
->
ªfs
) > 2)

247 i‡(
em
->
°¨t
 != 0) {

248 
rb
 = 
	`rb_¥ev
(&
em
->
rb_node
);

249 i‡(
rb
)

250 
mîge
 = 
	`rb_íåy
(
rb
, 
exã¡_m≠
, 
rb_node
);

251 i‡(
rb
 && 
	`mîgabÀ_m≠s
(
mîge
, 
em
)) {

252 
em
->
°¨t
 = 
mîge
->start;

253 
em
->
‹ig_°¨t
 = 
mîge
->orig_start;

254 
em
->
Àn
 +
mîge
->len;

255 
em
->
block_Àn
 +
mîge
->block_len;

256 
em
->
block_°¨t
 = 
mîge
->block_start;

257 
em
->
mod_Àn
 = (em->mod_À¿+Ém->
mod_°¨t
Ë- 
mîge
->mod_start;

258 
em
->
mod_°¨t
 = 
mîge
->mod_start;

259 
em
->
gíî©i⁄
 = 
	`max
”m->gíî©i⁄, 
mîge
->generation);

260 
	`£t_bô
(
EXTENT_FLAG_MERGED
, &
em
->
Êags
);

262 
	`rb_îa£_ˇched
(&
mîge
->
rb_node
, &
åì
->
m≠
);

263 
	`RB_CLEAR_NODE
(&
mîge
->
rb_node
);

264 
	`‰ì_exã¡_m≠
(
mîge
);

268 
rb
 = 
	`rb_√xt
(&
em
->
rb_node
);

269 i‡(
rb
)

270 
mîge
 = 
	`rb_íåy
(
rb
, 
exã¡_m≠
, 
rb_node
);

271 i‡(
rb
 && 
	`mîgabÀ_m≠s
(
em
, 
mîge
)) {

272 
em
->
Àn
 +
mîge
->len;

273 
em
->
block_Àn
 +
mîge
->block_len;

274 
	`rb_îa£_ˇched
(&
mîge
->
rb_node
, &
åì
->
m≠
);

275 
	`RB_CLEAR_NODE
(&
mîge
->
rb_node
);

276 
em
->
mod_Àn
 = (
mîge
->
mod_°¨t
 + merge->mod_len) -Ém->mod_start;

277 
em
->
gíî©i⁄
 = 
	`max
”m->gíî©i⁄, 
mîge
->generation);

278 
	`£t_bô
(
EXTENT_FLAG_MERGED
, &
em
->
Êags
);

279 
	`‰ì_exã¡_m≠
(
mîge
);

281 
	}
}

295 
	$u≈ö_exã¡_ˇche
(
exã¡_m≠_åì
 *
åì
, 
u64
 
°¨t
, u64 
Àn
,

296 
u64
 
gí
)

298 
ªt
 = 0;

299 
exã¡_m≠
 *
em
;

300 
boﬁ
 
¥óŒoc
 = 
Ál£
;

302 
	`wrôe_lock
(&
åì
->
lock
);

303 
em
 = 
	`lookup_exã¡_m≠pög
(
åì
, 
°¨t
, 
Àn
);

305 
	`WARN_ON
(!
em
 ||Ém->
°¨t
 != start);

307 i‡(!
em
)

308 
out
;

310 
em
->
gíî©i⁄
 = 
gí
;

311 
	`˛ór_bô
(
EXTENT_FLAG_PINNED
, &
em
->
Êags
);

312 
em
->
mod_°¨t
 =Ém->
°¨t
;

313 
em
->
mod_Àn
 =Ém->
Àn
;

315 i‡(
	`ã°_bô
(
EXTENT_FLAG_FILLING
, &
em
->
Êags
)) {

316 
¥óŒoc
 = 
åue
;

317 
	`˛ór_bô
(
EXTENT_FLAG_FILLING
, &
em
->
Êags
);

320 
	`åy_mîge_m≠
(
åì
, 
em
);

322 i‡(
¥óŒoc
) {

323 
em
->
mod_°¨t
 =Ém->
°¨t
;

324 
em
->
mod_Àn
 =Ém->
Àn
;

327 
	`‰ì_exã¡_m≠
(
em
);

328 
out
:

329 
	`wrôe_u∆ock
(&
åì
->
lock
);

330  
ªt
;

332 
	}
}

334 
	$˛ór_em_loggög
(
exã¡_m≠_åì
 *
åì
, 
exã¡_m≠
 *
em
)

336 
	`lockdï_as£π_hñd_wrôe
(&
åì
->
lock
);

338 
	`˛ór_bô
(
EXTENT_FLAG_LOGGING
, &
em
->
Êags
);

339 i‡(
	`exã¡_m≠_ö_åì
(
em
))

340 
	`åy_mîge_m≠
(
åì
, 
em
);

341 
	}
}

343 
ölöe
 
	$£tup_exã¡_m≠pög
(
exã¡_m≠_åì
 *
åì
,

344 
exã¡_m≠
 *
em
,

345 
modifõd
)

347 
	`ªfcou¡_öc
(&
em
->
ªfs
);

348 
em
->
mod_°¨t
 =Ém->
°¨t
;

349 
em
->
mod_Àn
 =Ém->
Àn
;

351 i‡(
modifõd
)

352 
	`li°_move
(&
em
->
li°
, &
åì
->
modifõd_exã¡s
);

354 
	`åy_mîge_m≠
(
åì
, 
em
);

355 
	}
}

357 
	$exã¡_m≠_devi˚_£t_bôs
(
exã¡_m≠
 *
em
, 
bôs
)

359 
m≠_lookup
 *
m≠
 = 
em
->map_lookup;

360 
u64
 
°rùe_size
 = 
em
->
‹ig_block_Àn
;

361 
i
;

363 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

364 
båfs_io_°rùe
 *
°rùe
 = &
m≠
->
°rùes
[
i
];

365 
båfs_devi˚
 *
devi˚
 = 
°rùe
->
dev
;

367 
	`£t_exã¡_bô
(&
devi˚
->
Æloc_°©e
, 
°rùe
->
physiˇl
,

368 
°rùe
->
physiˇl
 + 
°rùe_size
 - 1,

369 
bôs
 | 
EXTENT_NOWAIT
, 
NULL
);

371 
	}
}

373 
	$exã¡_m≠_devi˚_˛ór_bôs
(
exã¡_m≠
 *
em
, 
bôs
)

375 
m≠_lookup
 *
m≠
 = 
em
->map_lookup;

376 
u64
 
°rùe_size
 = 
em
->
‹ig_block_Àn
;

377 
i
;

379 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

380 
båfs_io_°rùe
 *
°rùe
 = &
m≠
->
°rùes
[
i
];

381 
båfs_devi˚
 *
devi˚
 = 
°rùe
->
dev
;

383 
	`__˛ór_exã¡_bô
(&
devi˚
->
Æloc_°©e
, 
°rùe
->
physiˇl
,

384 
°rùe
->
physiˇl
 + 
°rùe_size
 - 1,

385 
bôs
 | 
EXTENT_NOWAIT
,

386 
NULL
, NULL);

388 
	}
}

403 
	$add_exã¡_m≠pög
(
exã¡_m≠_åì
 *
åì
,

404 
exã¡_m≠
 *
em
, 
modifõd
)

406 
ªt
 = 0;

408 
	`lockdï_as£π_hñd_wrôe
(&
åì
->
lock
);

410 
ªt
 = 
	`åì_ö£π
(&
åì
->
m≠
, 
em
);

411 i‡(
ªt
)

412 
out
;

414 
	`£tup_exã¡_m≠pög
(
åì
, 
em
, 
modifõd
);

415 i‡(
	`ã°_bô
(
EXTENT_FLAG_FS_MAPPING
, &
em
->
Êags
)) {

416 
	`exã¡_m≠_devi˚_£t_bôs
(
em
, 
CHUNK_ALLOCATED
);

417 
	`exã¡_m≠_devi˚_˛ór_bôs
(
em
, 
CHUNK_TRIMMED
);

419 
out
:

420  
ªt
;

421 
	}
}

423 
exã¡_m≠
 *

424 
	$__lookup_exã¡_m≠pög
(
exã¡_m≠_åì
 *
åì
,

425 
u64
 
°¨t
, u64 
Àn
, 
°ri˘
)

427 
exã¡_m≠
 *
em
;

428 
rb_node
 *rb_node;

429 
rb_node
 *
¥ev_‹_√xt
 = 
NULL
;

430 
u64
 
íd
 = 
	`ønge_íd
(
°¨t
, 
Àn
);

432 
rb_node
 = 
	`__åì_£¨ch
(&
åì
->
m≠
.
rb_roŸ
, 
°¨t
, &
¥ev_‹_√xt
);

433 i‡(!
rb_node
) {

434 i‡(
¥ev_‹_√xt
)

435 
rb_node
 = 
¥ev_‹_√xt
;

437  
NULL
;

440 
em
 = 
	`rb_íåy
(
rb_node
, 
exã¡_m≠
,Ñb_node);

442 i‡(
°ri˘
 && !(
íd
 > 
em
->
°¨t
 && sèπ < 
	`exã¡_m≠_íd
(em)))

443  
NULL
;

445 
	`ªfcou¡_öc
(&
em
->
ªfs
);

446  
em
;

447 
	}
}

461 
exã¡_m≠
 *
	$lookup_exã¡_m≠pög
(
exã¡_m≠_åì
 *
åì
,

462 
u64
 
°¨t
, u64 
Àn
)

464  
	`__lookup_exã¡_m≠pög
(
åì
, 
°¨t
, 
Àn
, 1);

465 
	}
}

479 
exã¡_m≠
 *
	$£¨ch_exã¡_m≠pög
(
exã¡_m≠_åì
 *
åì
,

480 
u64
 
°¨t
, u64 
Àn
)

482  
	`__lookup_exã¡_m≠pög
(
åì
, 
°¨t
, 
Àn
, 0);

483 
	}
}

494 
	$ªmove_exã¡_m≠pög
(
exã¡_m≠_åì
 *
åì
, 
exã¡_m≠
 *
em
)

496 
	`lockdï_as£π_hñd_wrôe
(&
åì
->
lock
);

498 
	`WARN_ON
(
	`ã°_bô
(
EXTENT_FLAG_PINNED
, &
em
->
Êags
));

499 
	`rb_îa£_ˇched
(&
em
->
rb_node
, &
åì
->
m≠
);

500 i‡(!
	`ã°_bô
(
EXTENT_FLAG_LOGGING
, &
em
->
Êags
))

501 
	`li°_dñ_öô
(&
em
->
li°
);

502 i‡(
	`ã°_bô
(
EXTENT_FLAG_FS_MAPPING
, &
em
->
Êags
))

503 
	`exã¡_m≠_devi˚_˛ór_bôs
(
em
, 
CHUNK_ALLOCATED
);

504 
	`RB_CLEAR_NODE
(&
em
->
rb_node
);

505 
	}
}

507 
	$ª∂a˚_exã¡_m≠pög
(
exã¡_m≠_åì
 *
åì
,

508 
exã¡_m≠
 *
cur
,

509 
exã¡_m≠
 *
√w
,

510 
modifõd
)

512 
	`lockdï_as£π_hñd_wrôe
(&
åì
->
lock
);

514 
	`WARN_ON
(
	`ã°_bô
(
EXTENT_FLAG_PINNED
, &
cur
->
Êags
));

515 
	`ASSERT
(
	`exã¡_m≠_ö_åì
(
cur
));

516 i‡(!
	`ã°_bô
(
EXTENT_FLAG_LOGGING
, &
cur
->
Êags
))

517 
	`li°_dñ_öô
(&
cur
->
li°
);

518 
	`rb_ª∂a˚_node_ˇched
(&
cur
->
rb_node
, &
√w
->rb_node, &
åì
->
m≠
);

519 
	`RB_CLEAR_NODE
(&
cur
->
rb_node
);

521 
	`£tup_exã¡_m≠pög
(
åì
, 
√w
, 
modifõd
);

522 
	}
}

524 
exã¡_m≠
 *
	$√xt_exã¡_m≠
(c⁄° 
exã¡_m≠
 *
em
)

526 
rb_node
 *
√xt
;

528 
√xt
 = 
	`rb_√xt
(&
em
->
rb_node
);

529 i‡(!
√xt
)

530  
NULL
;

531  
	`c⁄èöî_of
(
√xt
, 
exã¡_m≠
, 
rb_node
);

532 
	}
}

534 
exã¡_m≠
 *
	$¥ev_exã¡_m≠
(
exã¡_m≠
 *
em
)

536 
rb_node
 *
¥ev
;

538 
¥ev
 = 
	`rb_¥ev
(&
em
->
rb_node
);

539 i‡(!
¥ev
)

540  
NULL
;

541  
	`c⁄èöî_of
(
¥ev
, 
exã¡_m≠
, 
rb_node
);

542 
	}
}

550 
noölöe
 
	$mîge_exã¡_m≠pög
(
exã¡_m≠_åì
 *
em_åì
,

551 
exã¡_m≠
 *
exi°ög
,

552 
exã¡_m≠
 *
em
,

553 
u64
 
m≠_°¨t
)

555 
exã¡_m≠
 *
¥ev
;

556 
exã¡_m≠
 *
√xt
;

557 
u64
 
°¨t
;

558 
u64
 
íd
;

559 
u64
 
°¨t_diff
;

561 
	`BUG_ON
(
m≠_°¨t
 < 
em
->
°¨t
 || m≠_°¨à>
	`exã¡_m≠_íd
(em));

563 i‡(
exi°ög
->
°¨t
 > 
m≠_°¨t
) {

564 
√xt
 = 
exi°ög
;

565 
¥ev
 = 
	`¥ev_exã¡_m≠
(
√xt
);

567 
¥ev
 = 
exi°ög
;

568 
√xt
 = 
	`√xt_exã¡_m≠
(
¥ev
);

571 
°¨t
 = 
¥ev
 ? 
	`exã¡_m≠_íd
’ªvË: 
em
->start;

572 
°¨t
 = 
	`max_t
(
u64
, sèπ, 
em
->start);

573 
íd
 = 
√xt
 ?Çext->
°¨t
 : 
	`exã¡_m≠_íd
(
em
);

574 
íd
 = 
	`mö_t
(
u64
,Énd, 
	`exã¡_m≠_íd
(
em
));

575 
°¨t_diff
 = 
°¨t
 - 
em
->start;

576 
em
->
°¨t
 = start;

577 
em
->
Àn
 = 
íd
 - 
°¨t
;

578 i‡(
em
->
block_°¨t
 < 
EXTENT_MAP_LAST_BYTE
 &&

579 !
	`ã°_bô
(
EXTENT_FLAG_COMPRESSED
, &
em
->
Êags
)) {

580 
em
->
block_°¨t
 +
°¨t_diff
;

581 
em
->
block_Àn
 =Ém->
Àn
;

583  
	`add_exã¡_m≠pög
(
em_åì
, 
em
, 0);

584 
	}
}

607 
	$båfs_add_exã¡_m≠pög
(
båfs_fs_öfo
 *
fs_öfo
,

608 
exã¡_m≠_åì
 *
em_åì
,

609 
exã¡_m≠
 **
em_ö
, 
u64
 
°¨t
, u64 
Àn
)

611 
ªt
;

612 
exã¡_m≠
 *
em
 = *
em_ö
;

618 i‡(
em
->
block_°¨t
 =
EXTENT_MAP_INLINE
)

619 
	`ASSERT
(
em
->
°¨t
 == 0);

621 
ªt
 = 
	`add_exã¡_m≠pög
(
em_åì
, 
em
, 0);

626 i‡(
ªt
 =-
EEXIST
) {

627 
exã¡_m≠
 *
exi°ög
;

629 
ªt
 = 0;

631 
exi°ög
 = 
	`£¨ch_exã¡_m≠pög
(
em_åì
, 
°¨t
, 
Àn
);

633 
	`åa˚_båfs_h™dÀ_em_exi°
(
fs_öfo
, 
exi°ög
, 
em
, 
°¨t
, 
Àn
);

639 i‡(
°¨t
 >
exi°ög
->start &&

640 
°¨t
 < 
	`exã¡_m≠_íd
(
exi°ög
)) {

641 
	`‰ì_exã¡_m≠
(
em
);

642 *
em_ö
 = 
exi°ög
;

643 
ªt
 = 0;

645 
u64
 
‹ig_°¨t
 = 
em
->
°¨t
;

646 
u64
 
‹ig_Àn
 = 
em
->
Àn
;

652 
ªt
 = 
	`mîge_exã¡_m≠pög
(
em_åì
, 
exi°ög
,

653 
em
, 
°¨t
);

654 i‡(
ªt
) {

655 
	`‰ì_exã¡_m≠
(
em
);

656 *
em_ö
 = 
NULL
;

657 
	`WARN_ONCE
(
ªt
,

659 
ªt
, 
exi°ög
->
°¨t
,Éxi°ög->
Àn
,

660 
‹ig_°¨t
, 
‹ig_Àn
);

662 
	`‰ì_exã¡_m≠
(
exi°ög
);

666 
	`ASSERT
(
ªt
 =0 ||Ñë =-
EEXIST
);

667  
ªt
;

668 
	}
}

675 
	$dr›_Æl_exã¡_m≠s_Á°
(
exã¡_m≠_åì
 *
åì
)

677 
	`wrôe_lock
(&
åì
->
lock
);

678 !
	`RB_EMPTY_ROOT
(&
åì
->
m≠
.
rb_roŸ
)) {

679 
exã¡_m≠
 *
em
;

680 
rb_node
 *
node
;

682 
node
 = 
	`rb_fú°_ˇched
(&
åì
->
m≠
);

683 
em
 = 
	`rb_íåy
(
node
, 
exã¡_m≠
, 
rb_node
);

684 
	`˛ór_bô
(
EXTENT_FLAG_PINNED
, &
em
->
Êags
);

685 
	`˛ór_bô
(
EXTENT_FLAG_LOGGING
, &
em
->
Êags
);

686 
	`ªmove_exã¡_m≠pög
(
åì
, 
em
);

687 
	`‰ì_exã¡_m≠
(
em
);

688 
	`c⁄d_ªsched_rwlock_wrôe
(&
åì
->
lock
);

690 
	`wrôe_u∆ock
(&
åì
->
lock
);

691 
	}
}

707 
	$båfs_dr›_exã¡_m≠_ønge
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
,

708 
boﬁ
 
skù_pö√d
)

710 
exã¡_m≠
 *
•lô
;

711 
exã¡_m≠
 *
•lô2
;

712 
exã¡_m≠
 *
em
;

713 
exã¡_m≠_åì
 *
em_åì
 = &
öode
->
exã¡_åì
;

714 
u64
 
Àn
 = 
íd
 - 
°¨t
 + 1;

716 
	`WARN_ON
(
íd
 < 
°¨t
);

717 i‡(
íd
 =(
u64
)-1) {

718 i‡(
°¨t
 =0 && !
skù_pö√d
) {

719 
	`dr›_Æl_exã¡_m≠s_Á°
(
em_åì
);

722 
Àn
 = (
u64
)-1;

725 
íd
++;

736 
•lô
 = 
	`Æloc_exã¡_m≠
();

737 
•lô2
 = 
	`Æloc_exã¡_m≠
();

739 
	`wrôe_lock
(&
em_åì
->
lock
);

740 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 
°¨t
, 
Àn
);

742 
em
) {

744 c⁄° 
u64
 
em_íd
 = 
	`exã¡_m≠_íd
(
em
);

745 
exã¡_m≠
 *
√xt_em
 = 
NULL
;

746 
u64
 
gí
;

747 
Êags
;

748 
boﬁ
 
modifõd
;

749 
boﬁ
 
com¥es£d
;

751 i‡(
em_íd
 < 
íd
) {

752 
√xt_em
 = 
	`√xt_exã¡_m≠
(
em
);

753 i‡(
√xt_em
) {

754 i‡(
√xt_em
->
°¨t
 < 
íd
)

755 
	`ªfcou¡_öc
(&
√xt_em
->
ªfs
);

757 
√xt_em
 = 
NULL
;

761 i‡(
skù_pö√d
 && 
	`ã°_bô
(
EXTENT_FLAG_PINNED
, &
em
->
Êags
)) {

762 
°¨t
 = 
em_íd
;

763 
√xt
;

766 
Êags
 = 
em
->flags;

767 
	`˛ór_bô
(
EXTENT_FLAG_PINNED
, &
em
->
Êags
);

773 
	`˛ór_bô
(
EXTENT_FLAG_LOGGING
, &
Êags
);

774 
modifõd
 = !
	`li°_em±y
(&
em
->
li°
);

780 i‡(
em
->
°¨t
 >°¨à&& 
em_íd
 <
íd
)

781 
ªmove_em
;

783 
gí
 = 
em
->
gíî©i⁄
;

784 
com¥es£d
 = 
	`ã°_bô
(
EXTENT_FLAG_COMPRESSED
, &
em
->
Êags
);

786 i‡(
em
->
°¨t
 < start) {

787 i‡(!
•lô
) {

788 
•lô
 = 
•lô2
;

789 
•lô2
 = 
NULL
;

790 i‡(!
•lô
)

791 
ªmove_em
;

793 
•lô
->
°¨t
 = 
em
->start;

794 
•lô
->
Àn
 = 
°¨t
 - 
em
->start;

796 i‡(
em
->
block_°¨t
 < 
EXTENT_MAP_LAST_BYTE
) {

797 
•lô
->
‹ig_°¨t
 = 
em
->orig_start;

798 
•lô
->
block_°¨t
 = 
em
->block_start;

800 i‡(
com¥es£d
)

801 
•lô
->
block_Àn
 = 
em
->block_len;

803 
•lô
->
block_Àn
 = s∂ô->
Àn
;

804 
•lô
->
‹ig_block_Àn
 = 
	`max
(•lô->
block_Àn
,

805 
em
->
‹ig_block_Àn
);

806 
•lô
->
øm_byãs
 = 
em
->ram_bytes;

808 
•lô
->
‹ig_°¨t
 = s∂ô->
°¨t
;

809 
•lô
->
block_Àn
 = 0;

810 
•lô
->
block_°¨t
 = 
em
->block_start;

811 
•lô
->
‹ig_block_Àn
 = 0;

812 
•lô
->
øm_byãs
 = s∂ô->
Àn
;

815 
•lô
->
gíî©i⁄
 = 
gí
;

816 
•lô
->
Êags
 = flags;

817 
•lô
->
com¥ess_ty≥
 = 
em
->compress_type;

818 
	`ª∂a˚_exã¡_m≠pög
(
em_åì
, 
em
, 
•lô
, 
modifõd
);

819 
	`‰ì_exã¡_m≠
(
•lô
);

820 
•lô
 = 
•lô2
;

821 
•lô2
 = 
NULL
;

823 i‡(
em_íd
 > 
íd
) {

824 i‡(!
•lô
) {

825 
•lô
 = 
•lô2
;

826 
•lô2
 = 
NULL
;

827 i‡(!
•lô
)

828 
ªmove_em
;

830 
•lô
->
°¨t
 = 
íd
;

831 
•lô
->
Àn
 = 
em_íd
 - 
íd
;

832 
•lô
->
block_°¨t
 = 
em
->block_start;

833 
•lô
->
Êags
 = flags;

834 
•lô
->
com¥ess_ty≥
 = 
em
->compress_type;

835 
•lô
->
gíî©i⁄
 = 
gí
;

837 i‡(
em
->
block_°¨t
 < 
EXTENT_MAP_LAST_BYTE
) {

838 
•lô
->
‹ig_block_Àn
 = 
	`max
(
em
->
block_Àn
,

839 
em
->
‹ig_block_Àn
);

841 
•lô
->
øm_byãs
 = 
em
->ram_bytes;

842 i‡(
com¥es£d
) {

843 
•lô
->
block_Àn
 = 
em
->block_len;

844 
•lô
->
‹ig_°¨t
 = 
em
->orig_start;

846 c⁄° 
u64
 
diff
 = 
°¨t
 + 
Àn
 - 
em
->start;

848 
•lô
->
block_Àn
 = s∂ô->
Àn
;

849 
•lô
->
block_°¨t
 +
diff
;

850 
•lô
->
‹ig_°¨t
 = 
em
->orig_start;

853 
•lô
->
øm_byãs
 = s∂ô->
Àn
;

854 
•lô
->
‹ig_°¨t
 = s∂ô->
°¨t
;

855 
•lô
->
block_Àn
 = 0;

856 
•lô
->
‹ig_block_Àn
 = 0;

859 i‡(
	`exã¡_m≠_ö_åì
(
em
)) {

860 
	`ª∂a˚_exã¡_m≠pög
(
em_åì
, 
em
, 
•lô
,

861 
modifõd
);

863 
ªt
;

865 
ªt
 = 
	`add_exã¡_m≠pög
(
em_åì
, 
•lô
,

866 
modifõd
);

868 
	`ASSERT
(
ªt
 == 0);

869 i‡(
	`WARN_ON
(
ªt
 !0Ë&& 
modifõd
)

870 
	`båfs_£t_öode_fuŒ_sync
(
öode
);

872 
	`‰ì_exã¡_m≠
(
•lô
);

873 
•lô
 = 
NULL
;

875 
ªmove_em
:

876 i‡(
	`exã¡_m≠_ö_åì
(
em
)) {

897 i‡((
em
->
°¨t
 < sèπ || 
em_íd
 > 
íd
Ë&& 
modifõd
) {

898 
	`ASSERT
(!
•lô
);

899 
	`båfs_£t_öode_fuŒ_sync
(
öode
);

901 
	`ªmove_exã¡_m≠pög
(
em_åì
, 
em
);

908 
	`‰ì_exã¡_m≠
(
em
);

909 
√xt
:

911 
	`‰ì_exã¡_m≠
(
em
);

913 
em
 = 
√xt_em
;

916 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

918 
	`‰ì_exã¡_m≠
(
•lô
);

919 
	`‰ì_exã¡_m≠
(
•lô2
);

920 
	}
}

935 
	$båfs_ª∂a˚_exã¡_m≠_ønge
(
båfs_öode
 *
öode
,

936 
exã¡_m≠
 *
√w_em
,

937 
boﬁ
 
modifõd
)

939 c⁄° 
u64
 
íd
 = 
√w_em
->
°¨t
 +Çew_em->
Àn
 - 1;

940 
exã¡_m≠_åì
 *
åì
 = &
öode
->
exã¡_åì
;

941 
ªt
;

943 
	`ASSERT
(!
	`exã¡_m≠_ö_åì
(
√w_em
));

954 
	`båfs_dr›_exã¡_m≠_ønge
(
öode
, 
√w_em
->
°¨t
, 
íd
, 
Ál£
);

955 
	`wrôe_lock
(&
åì
->
lock
);

956 
ªt
 = 
	`add_exã¡_m≠pög
(
åì
, 
√w_em
, 
modifõd
);

957 
	`wrôe_u∆ock
(&
åì
->
lock
);

958 } 
ªt
 =-
EEXIST
);

960  
ªt
;

961 
	}
}

969 
	$•lô_exã¡_m≠
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
Àn
, u64 
¥e
,

970 
u64
 
√w_logiˇl
)

972 
exã¡_m≠_åì
 *
em_åì
 = &
öode
->
exã¡_åì
;

973 
exã¡_m≠
 *
em
;

974 
exã¡_m≠
 *
•lô_¥e
 = 
NULL
;

975 
exã¡_m≠
 *
•lô_mid
 = 
NULL
;

976 
ªt
 = 0;

977 
Êags
;

979 
	`ASSERT
(
¥e
 != 0);

980 
	`ASSERT
(
¥e
 < 
Àn
);

982 
•lô_¥e
 = 
	`Æloc_exã¡_m≠
();

983 i‡(!
•lô_¥e
)

984  -
ENOMEM
;

985 
•lô_mid
 = 
	`Æloc_exã¡_m≠
();

986 i‡(!
•lô_mid
) {

987 
ªt
 = -
ENOMEM
;

988 
out_‰ì_¥e
;

991 
	`lock_exã¡
(&
öode
->
io_åì
, 
°¨t
, sèπ + 
Àn
 - 1, 
NULL
);

992 
	`wrôe_lock
(&
em_åì
->
lock
);

993 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 
°¨t
, 
Àn
);

994 i‡(!
em
) {

995 
ªt
 = -
EIO
;

996 
out_u∆ock
;

999 
	`ASSERT
(
em
->
Àn
 ==Üen);

1000 
	`ASSERT
(!
	`ã°_bô
(
EXTENT_FLAG_COMPRESSED
, &
em
->
Êags
));

1001 
	`ASSERT
(
em
->
block_°¨t
 < 
EXTENT_MAP_LAST_BYTE
);

1002 
	`ASSERT
(
	`ã°_bô
(
EXTENT_FLAG_PINNED
, &
em
->
Êags
));

1003 
	`ASSERT
(!
	`ã°_bô
(
EXTENT_FLAG_LOGGING
, &
em
->
Êags
));

1004 
	`ASSERT
(!
	`li°_em±y
(&
em
->
li°
));

1006 
Êags
 = 
em
->flags;

1007 
	`˛ór_bô
(
EXTENT_FLAG_PINNED
, &
em
->
Êags
);

1010 
•lô_¥e
->
°¨t
 = 
em
->start;

1011 
•lô_¥e
->
Àn
 = 
¥e
;

1012 
•lô_¥e
->
‹ig_°¨t
 = s∂ô_¥e->
°¨t
;

1013 
•lô_¥e
->
block_°¨t
 = 
√w_logiˇl
;

1014 
•lô_¥e
->
block_Àn
 = s∂ô_¥e->
Àn
;

1015 
•lô_¥e
->
‹ig_block_Àn
 = s∂ô_¥e->
block_Àn
;

1016 
•lô_¥e
->
øm_byãs
 = s∂ô_¥e->
Àn
;

1017 
•lô_¥e
->
Êags
 = flags;

1018 
•lô_¥e
->
com¥ess_ty≥
 = 
em
->compress_type;

1019 
•lô_¥e
->
gíî©i⁄
 = 
em
->generation;

1021 
	`ª∂a˚_exã¡_m≠pög
(
em_åì
, 
em
, 
•lô_¥e
, 1);

1029 
•lô_mid
->
°¨t
 = 
em
->°¨à+ 
¥e
;

1030 
•lô_mid
->
Àn
 = 
em
->À¿- 
¥e
;

1031 
•lô_mid
->
‹ig_°¨t
 = s∂ô_mid->
°¨t
;

1032 
•lô_mid
->
block_°¨t
 = 
em
->block_°¨à+ 
¥e
;

1033 
•lô_mid
->
block_Àn
 = s∂ô_mid->
Àn
;

1034 
•lô_mid
->
‹ig_block_Àn
 = s∂ô_mid->
block_Àn
;

1035 
•lô_mid
->
øm_byãs
 = s∂ô_mid->
Àn
;

1036 
•lô_mid
->
Êags
 = flags;

1037 
•lô_mid
->
com¥ess_ty≥
 = 
em
->compress_type;

1038 
•lô_mid
->
gíî©i⁄
 = 
em
->generation;

1039 
	`add_exã¡_m≠pög
(
em_åì
, 
•lô_mid
, 1);

1042 
	`‰ì_exã¡_m≠
(
em
);

1044 
	`‰ì_exã¡_m≠
(
em
);

1046 
out_u∆ock
:

1047 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

1048 
	`u∆ock_exã¡
(&
öode
->
io_åì
, 
°¨t
, sèπ + 
Àn
 - 1, 
NULL
);

1049 
	`‰ì_exã¡_m≠
(
•lô_mid
);

1050 
out_‰ì_¥e
:

1051 
	`‰ì_exã¡_m≠
(
•lô_¥e
);

1052  
ªt
;

1053 
	}
}

	@extent_map.h

3 #i‚de‡
BTRFS_EXTENT_MAP_H


4 
	#BTRFS_EXTENT_MAP_H


	)

6 
	~<löux/rbåì.h
>

7 
	~<löux/ªfcou¡.h
>

9 
	#EXTENT_MAP_LAST_BYTE
 ((
u64
)-4)

	)

10 
	#EXTENT_MAP_HOLE
 ((
u64
)-3)

	)

11 
	#EXTENT_MAP_INLINE
 ((
u64
)-2)

	)

13 
	#EXTENT_MAP_DELALLOC
 ((
u64
)-1)

	)

18 
	mEXTENT_FLAG_PINNED
,

19 
	mEXTENT_FLAG_COMPRESSED
,

21 
	mEXTENT_FLAG_PREALLOC
,

23 
	mEXTENT_FLAG_LOGGING
,

25 
	mEXTENT_FLAG_FILLING
,

27 
	mEXTENT_FLAG_FS_MAPPING
,

29 
	mEXTENT_FLAG_MERGED
,

32 
	sexã¡_m≠
 {

33 
rb_node
 
	mrb_node
;

36 
u64
 
	m°¨t
;

37 
u64
 
	mÀn
;

38 
u64
 
	mmod_°¨t
;

39 
u64
 
	mmod_Àn
;

40 
u64
 
	m‹ig_°¨t
;

41 
u64
 
	m‹ig_block_Àn
;

42 
u64
 
	møm_byãs
;

43 
u64
 
	mblock_°¨t
;

44 
u64
 
	mblock_Àn
;

51 
u64
 
	mgíî©i⁄
;

52 
	mÊags
;

54 
m≠_lookup
 *
	mm≠_lookup
;

55 
ªfcou¡_t
 
	mªfs
;

56 
	mcom¥ess_ty≥
;

57 
li°_hód
 
	mli°
;

60 
	sexã¡_m≠_åì
 {

61 
rb_roŸ_ˇched
 
	mm≠
;

62 
li°_hód
 
	mmodifõd_exã¡s
;

63 
rwlock_t
 
	mlock
;

66 
	gbåfs_öode
;

68 
ölöe
 
	$exã¡_m≠_ö_åì
(c⁄° 
exã¡_m≠
 *
em
)

70  !
	`RB_EMPTY_NODE
(&
em
->
rb_node
);

71 
	}
}

73 
ölöe
 
u64
 
	$exã¡_m≠_íd
(
exã¡_m≠
 *
em
)

75 i‡(
em
->
°¨t
 +Ém->
Àn
 <Ém->start)

76  (
u64
)-1;

77  
em
->
°¨t
 +Ém->
Àn
;

78 
	}
}

80 
ölöe
 
u64
 
	$exã¡_m≠_block_íd
(
exã¡_m≠
 *
em
)

82 i‡(
em
->
block_°¨t
 +Ém->
block_Àn
 <Ém->block_start)

83  (
u64
)-1;

84  
em
->
block_°¨t
 +Ém->
block_Àn
;

85 
	}
}

87 
exã¡_m≠_åì_öô
(
exã¡_m≠_åì
 *
åì
);

88 
exã¡_m≠
 *
lookup_exã¡_m≠pög
(
exã¡_m≠_åì
 *
åì
,

89 
u64
 
°¨t
, u64 
Àn
);

90 
add_exã¡_m≠pög
(
exã¡_m≠_åì
 *
åì
,

91 
exã¡_m≠
 *
em
, 
modifõd
);

92 
ªmove_exã¡_m≠pög
(
exã¡_m≠_åì
 *
åì
, 
exã¡_m≠
 *
em
);

93 
•lô_exã¡_m≠
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
Àn
, u64 
¥e
,

94 
u64
 
√w_logiˇl
);

96 
exã¡_m≠
 *
Æloc_exã¡_m≠
();

97 
‰ì_exã¡_m≠
(
exã¡_m≠
 *
em
);

98 
__öô
 
exã¡_m≠_öô
();

99 
__cﬁd
 
exã¡_m≠_exô
();

100 
u≈ö_exã¡_ˇche
(
exã¡_m≠_åì
 *
åì
, 
u64
 
°¨t
, u64 
Àn
, u64 
gí
);

101 
˛ór_em_loggög
(
exã¡_m≠_åì
 *
åì
, 
exã¡_m≠
 *
em
);

102 
exã¡_m≠
 *
£¨ch_exã¡_m≠pög
(
exã¡_m≠_åì
 *
åì
,

103 
u64
 
°¨t
, u64 
Àn
);

104 
båfs_add_exã¡_m≠pög
(
båfs_fs_öfo
 *
fs_öfo
,

105 
exã¡_m≠_åì
 *
em_åì
,

106 
exã¡_m≠
 **
em_ö
, 
u64
 
°¨t
, u64 
Àn
);

107 
båfs_dr›_exã¡_m≠_ønge
(
båfs_öode
 *
öode
,

108 
u64
 
°¨t
, u64 
íd
,

109 
boﬁ
 
skù_pö√d
);

110 
båfs_ª∂a˚_exã¡_m≠_ønge
(
båfs_öode
 *
öode
,

111 
exã¡_m≠
 *
√w_em
,

112 
boﬁ
 
modifõd
);

	@file-item.c

6 
	~<löux/bio.h
>

7 
	~<löux/¶ab.h
>

8 
	~<löux/∑gem≠.h
>

9 
	~<löux/highmem.h
>

10 
	~<löux/sched/mm.h
>

11 
	~<¸y±o/hash.h
>

12 
	~"mesßges.h
"

13 
	~"misc.h
"

14 
	~"˘ªe.h
"

15 
	~"disk-io.h
"

16 
	~"å™ß˘i⁄.h
"

17 
	~"bio.h
"

18 
	~"¥öt-åì.h
"

19 
	~"com¥essi⁄.h
"

20 
	~"fs.h
"

21 
	~"ac˚ss‹s.h
"

22 
	~"fûe-ôem.h
"

23 
	~"su≥r.h
"

25 
	#__MAX_CSUM_ITEMS
(
r
, 
size
Ë(()(((
	`BTRFS_LEAF_DATA_SIZE
(r) - \

26 (
båfs_ôem
) * 2) / \

27 
size
Ë- 1))

	)

29 
	#MAX_CSUM_ITEMS
(
r
, 
size
Ë(
	`mö_t
(
u32
, 
	`__MAX_CSUM_ITEMS
(r, size), \

30 
PAGE_SIZE
))

	)

49 
	$båfs_öode_ß„_disk_i_size_wrôe
(
båfs_öode
 *
öode
, 
u64
 
√w_i_size
)

51 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

52 
u64
 
°¨t
, 
íd
, 
i_size
;

53 
ªt
;

55 
	`•ö_lock
(&
öode
->
lock
);

56 
i_size
 = 
√w_i_size
 ?: 
	`i_size_ªad
(&
öode
->
vfs_öode
);

57 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
NO_HOLES
)) {

58 
öode
->
disk_i_size
 = 
i_size
;

59 
out_u∆ock
;

62 
ªt
 = 
	`föd_c⁄tiguous_exã¡_bô
(&
öode
->
fûe_exã¡_åì
, 0, &
°¨t
,

63 &
íd
, 
EXTENT_DIRTY
);

64 i‡(!
ªt
 && 
°¨t
 == 0)

65 
i_size
 = 
	`mö
(i_size, 
íd
 + 1);

67 
i_size
 = 0;

68 
öode
->
disk_i_size
 = 
i_size
;

69 
out_u∆ock
:

70 
	`•ö_u∆ock
(&
öode
->
lock
);

71 
	}
}

87 
	$båfs_öode_£t_fûe_exã¡_ønge
(
båfs_öode
 *
öode
, 
u64
 
°¨t
,

88 
u64
 
Àn
)

90 i‡(
Àn
 == 0)

93 
	`ASSERT
(
	`IS_ALIGNED
(
°¨t
 + 
Àn
, 
öode
->
roŸ
->
fs_öfo
->
£˘‹size
));

95 i‡(
	`båfs_fs_öcom∑t
(
öode
->
roŸ
->
fs_öfo
, 
NO_HOLES
))

97  
	`£t_exã¡_bô
(&
öode
->
fûe_exã¡_åì
, 
°¨t
, sèπ + 
Àn
 - 1,

98 
EXTENT_DIRTY
, 
NULL
);

99 
	}
}

115 
	$båfs_öode_˛ór_fûe_exã¡_ønge
(
båfs_öode
 *
öode
, 
u64
 
°¨t
,

116 
u64
 
Àn
)

118 i‡(
Àn
 == 0)

121 
	`ASSERT
(
	`IS_ALIGNED
(
°¨t
 + 
Àn
, 
öode
->
roŸ
->
fs_öfo
->
£˘‹size
) ||

122 
Àn
 =(
u64
)-1);

124 i‡(
	`båfs_fs_öcom∑t
(
öode
->
roŸ
->
fs_öfo
, 
NO_HOLES
))

126  
	`˛ór_exã¡_bô
(&
öode
->
fûe_exã¡_åì
, 
°¨t
,

127 
°¨t
 + 
Àn
 - 1, 
EXTENT_DIRTY
, 
NULL
);

128 
	}
}

130 
size_t
 
	$byãs_to_csum_size
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, 
u32
 
byãs
)

132 
	`ASSERT
(
	`IS_ALIGNED
(
byãs
, 
fs_öfo
->
£˘‹size
));

134  (
byãs
 >> 
fs_öfo
->
£˘‹size_bôs
Ë* fs_öfo->
csum_size
;

135 
	}
}

137 
size_t
 
	$csum_size_to_byãs
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, 
u32
 
csum_size
)

139 
	`ASSERT
(
	`IS_ALIGNED
(
csum_size
, 
fs_öfo
->csum_size));

141  (
csum_size
 / 
fs_öfo
->csum_sizeË<< fs_öfo->
£˘‹size_bôs
;

142 
	}
}

144 
ölöe
 
u32
 
	$max_‹dîed_sum_byãs
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
)

146 
u32
 
max_csum_size
 = 
	`round_down
(
PAGE_SIZE
 - (
båfs_‹dîed_sum
),

147 
fs_öfo
->
csum_size
);

149  
	`csum_size_to_byãs
(
fs_öfo
, 
max_csum_size
);

150 
	}
}

156 
	$båfs_‹dîed_sum_size
(
båfs_fs_öfo
 *
fs_öfo
, 
byãs
)

158  (
båfs_‹dîed_sum
Ë+ 
	`byãs_to_csum_size
(
fs_öfo
, 
byãs
);

159 
	}
}

161 
	$båfs_ö£π_hﬁe_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

162 
båfs_roŸ
 *
roŸ
,

163 
u64
 
obje˘id
, u64 
pos
, u64 
num_byãs
)

165 
ªt
 = 0;

166 
båfs_fûe_exã¡_ôem
 *
ôem
;

167 
båfs_key
 
fûe_key
;

168 
båfs_∑th
 *
∑th
;

169 
exã¡_buf„r
 *
Àaf
;

171 
∑th
 = 
	`båfs_Æloc_∑th
();

172 i‡(!
∑th
)

173  -
ENOMEM
;

174 
fûe_key
.
obje˘id
 = objectid;

175 
fûe_key
.
off£t
 = 
pos
;

176 
fûe_key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

178 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
fûe_key
,

179 (*
ôem
));

180 i‡(
ªt
 < 0)

181 
out
;

182 
	`BUG_ON
(
ªt
);

183 
Àaf
 = 
∑th
->
nodes
[0];

184 
ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

185 
båfs_fûe_exã¡_ôem
);

186 
	`båfs_£t_fûe_exã¡_disk_byãƒ
(
Àaf
, 
ôem
, 0);

187 
	`båfs_£t_fûe_exã¡_disk_num_byãs
(
Àaf
, 
ôem
, 0);

188 
	`båfs_£t_fûe_exã¡_off£t
(
Àaf
, 
ôem
, 0);

189 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
ôem
, 
num_byãs
);

190 
	`båfs_£t_fûe_exã¡_øm_byãs
(
Àaf
, 
ôem
, 
num_byãs
);

191 
	`båfs_£t_fûe_exã¡_gíî©i⁄
(
Àaf
, 
ôem
, 
å™s
->
å™sid
);

192 
	`båfs_£t_fûe_exã¡_ty≥
(
Àaf
, 
ôem
, 
BTRFS_FILE_EXTENT_REG
);

193 
	`båfs_£t_fûe_exã¡_com¥essi⁄
(
Àaf
, 
ôem
, 0);

194 
	`båfs_£t_fûe_exã¡_í¸y±i⁄
(
Àaf
, 
ôem
, 0);

195 
	`båfs_£t_fûe_exã¡_Ÿhî_ícodög
(
Àaf
, 
ôem
, 0);

197 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

198 
out
:

199 
	`båfs_‰ì_∑th
(
∑th
);

200  
ªt
;

201 
	}
}

203 
båfs_csum_ôem
 *

204 
	$båfs_lookup_csum
(
båfs_å™s_h™dÀ
 *
å™s
,

205 
båfs_roŸ
 *
roŸ
,

206 
båfs_∑th
 *
∑th
,

207 
u64
 
byãƒ
, 
cow
)

209 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

210 
ªt
;

211 
båfs_key
 
fûe_key
;

212 
båfs_key
 
found_key
;

213 
båfs_csum_ôem
 *
ôem
;

214 
exã¡_buf„r
 *
Àaf
;

215 
u64
 
csum_off£t
 = 0;

216 c⁄° 
u32
 
csum_size
 = 
fs_öfo
->csum_size;

217 
csums_ö_ôem
;

219 
fûe_key
.
obje˘id
 = 
BTRFS_EXTENT_CSUM_OBJECTID
;

220 
fûe_key
.
off£t
 = 
byãƒ
;

221 
fûe_key
.
ty≥
 = 
BTRFS_EXTENT_CSUM_KEY
;

222 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
fûe_key
, 
∑th
, 0, 
cow
);

223 i‡(
ªt
 < 0)

224 
Áû
;

225 
Àaf
 = 
∑th
->
nodes
[0];

226 i‡(
ªt
 > 0) {

227 
ªt
 = 1;

228 i‡(
∑th
->
¶Ÿs
[0] == 0)

229 
Áû
;

230 
∑th
->
¶Ÿs
[0]--;

231 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0]);

232 i‡(
found_key
.
ty≥
 !
BTRFS_EXTENT_CSUM_KEY
)

233 
Áû
;

235 
csum_off£t
 = (
byãƒ
 - 
found_key
.
off£t
) >>

236 
fs_öfo
->
£˘‹size_bôs
;

237 
csums_ö_ôem
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

238 
csums_ö_ôem
 /
csum_size
;

240 i‡(
csum_off£t
 =
csums_ö_ôem
) {

241 
ªt
 = -
EFBIG
;

242 
Áû
;

243 } i‡(
csum_off£t
 > 
csums_ö_ôem
) {

244 
Áû
;

247 
ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_csum_ôem
);

248 
ôem
 = (
båfs_csum_ôem
 *)((*)item +

249 
csum_off£t
 * 
csum_size
);

250  
ôem
;

251 
Áû
:

252 i‡(
ªt
 > 0)

253 
ªt
 = -
ENOENT
;

254  
	`ERR_PTR
(
ªt
);

255 
	}
}

257 
	$båfs_lookup_fûe_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

258 
båfs_roŸ
 *
roŸ
,

259 
båfs_∑th
 *
∑th
, 
u64
 
obje˘id
,

260 
u64
 
off£t
, 
mod
)

262 
båfs_key
 
fûe_key
;

263 
ös_Àn
 = 
mod
 < 0 ? -1 : 0;

264 
cow
 = 
mod
 != 0;

266 
fûe_key
.
obje˘id
 = objectid;

267 
fûe_key
.
off£t
 = offset;

268 
fûe_key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

270  
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
fûe_key
, 
∑th
, 
ös_Àn
, 
cow
);

271 
	}
}

282 
	$£¨ch_csum_åì
(
båfs_fs_öfo
 *
fs_öfo
,

283 
båfs_∑th
 *
∑th
, 
u64
 
disk_byãƒ
,

284 
u64
 
Àn
, 
u8
 *
d°
)

286 
båfs_roŸ
 *
csum_roŸ
;

287 
båfs_csum_ôem
 *
ôem
 = 
NULL
;

288 
båfs_key
 
key
;

289 c⁄° 
u32
 
£˘‹size
 = 
fs_öfo
->sectorsize;

290 c⁄° 
u32
 
csum_size
 = 
fs_öfo
->csum_size;

291 
u32
 
ôemsize
;

292 
ªt
;

293 
u64
 
csum_°¨t
;

294 
u64
 
csum_Àn
;

296 
	`ASSERT
(
	`IS_ALIGNED
(
disk_byãƒ
, 
£˘‹size
) &&

297 
	`IS_ALIGNED
(
Àn
, 
£˘‹size
));

300 i‡(
∑th
->
nodes
[0]) {

301 
ôem
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

302 
båfs_csum_ôem
);

303 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

304 
ôemsize
 = 
	`båfs_ôem_size
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0]);

306 
csum_°¨t
 = 
key
.
off£t
;

307 
csum_Àn
 = (
ôemsize
 / 
csum_size
Ë* 
£˘‹size
;

309 i‡(
	`ö_ønge
(
disk_byãƒ
, 
csum_°¨t
, 
csum_Àn
))

310 
found
;

314 
	`båfs_ªÀa£_∑th
(
∑th
);

315 
csum_roŸ
 = 
	`båfs_csum_roŸ
(
fs_öfo
, 
disk_byãƒ
);

316 
ôem
 = 
	`båfs_lookup_csum
(
NULL
, 
csum_roŸ
, 
∑th
, 
disk_byãƒ
, 0);

317 i‡(
	`IS_ERR
(
ôem
)) {

318 
ªt
 = 
	`PTR_ERR
(
ôem
);

319 
out
;

321 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

322 
ôemsize
 = 
	`båfs_ôem_size
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0]);

324 
csum_°¨t
 = 
key
.
off£t
;

325 
csum_Àn
 = (
ôemsize
 / 
csum_size
Ë* 
£˘‹size
;

326 
	`ASSERT
(
	`ö_ønge
(
disk_byãƒ
, 
csum_°¨t
, 
csum_Àn
));

328 
found
:

329 
ªt
 = (
	`mö
(
csum_°¨t
 + 
csum_Àn
, 
disk_byãƒ
 + 
Àn
) -

330 
disk_byãƒ
Ë>> 
fs_öfo
->
£˘‹size_bôs
;

331 
	`ªad_exã¡_buf„r
(
∑th
->
nodes
[0], 
d°
, ()
ôem
,

332 
ªt
 * 
csum_size
);

333 
out
:

334 i‡(
ªt
 =-
ENOENT
 ||Ñë =-
EFBIG
)

335 
ªt
 = 0;

336  
ªt
;

337 
	}
}

344 
blk_°©us_t
 
	$båfs_lookup_bio_sums
(
båfs_bio
 *
bbio
)

346 
båfs_öode
 *
öode
 = 
bbio
->inode;

347 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

348 
bio
 *biÿ&
bbio
->bio;

349 
båfs_∑th
 *
∑th
;

350 c⁄° 
u32
 
£˘‹size
 = 
fs_öfo
->sectorsize;

351 c⁄° 
u32
 
csum_size
 = 
fs_öfo
->csum_size;

352 
u32
 
‹ig_Àn
 = 
bio
->
bi_ôî
.
bi_size
;

353 
u64
 
‹ig_disk_byãƒ
 = 
bio
->
bi_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
;

354 c⁄° 
nblocks
 = 
‹ig_Àn
 >> 
fs_öfo
->
£˘‹size_bôs
;

355 
blk_°©us_t
 
ªt
 = 
BLK_STS_OK
;

356 
u32
 
bio_off£t
 = 0;

358 i‡((
öode
->
Êags
 & 
BTRFS_INODE_NODATASUM
) ||

359 
	`ã°_bô
(
BTRFS_FS_STATE_NO_CSUMS
, &
fs_öfo
->
fs_°©e
))

360  
BLK_STS_OK
;

374 
	`ASSERT
(
	`bio_›
(
bio
Ë=
REQ_OP_READ
);

375 
∑th
 = 
	`båfs_Æloc_∑th
();

376 i‡(!
∑th
)

377  
BLK_STS_RESOURCE
;

379 i‡(
nblocks
 * 
csum_size
 > 
BTRFS_BIO_INLINE_CSUM_SIZE
) {

380 
bbio
->
csum
 = 
	`kmÆloc_¨øy
(
nblocks
, 
csum_size
, 
GFP_NOFS
);

381 i‡(!
bbio
->
csum
) {

382 
	`båfs_‰ì_∑th
(
∑th
);

383  
BLK_STS_RESOURCE
;

386 
bbio
->
csum
 = bbio->
csum_ölöe
;

393 i‡(
nblocks
 > 
fs_öfo
->
csums_≥r_Àaf
)

394 
∑th
->
ªada
 = 
READA_FORWARD
;

402 i‡(
	`båfs_is_‰ì_•a˚_öode
(
öode
)) {

403 
∑th
->
£¨ch_commô_roŸ
 = 1;

404 
∑th
->
skù_lockög
 = 1;

407 
bio_off£t
 < 
‹ig_Àn
) {

408 
cou¡
;

409 
u64
 
cur_disk_byãƒ
 = 
‹ig_disk_byãƒ
 + 
bio_off£t
;

410 
u8
 *
csum_d°
 = 
bbio
->
csum
 +

411 (
bio_off£t
 >> 
fs_öfo
->
£˘‹size_bôs
Ë* 
csum_size
;

413 
cou¡
 = 
	`£¨ch_csum_åì
(
fs_öfo
, 
∑th
, 
cur_disk_byãƒ
,

414 
‹ig_Àn
 - 
bio_off£t
, 
csum_d°
);

415 i‡(
cou¡
 < 0) {

416 
ªt
 = 
	`î∫o_to_blk_°©us
(
cou¡
);

417 i‡(
bbio
->
csum
 !bbio->
csum_ölöe
)

418 
	`k‰ì
(
bbio
->
csum
);

419 
bbio
->
csum
 = 
NULL
;

433 i‡(
cou¡
 == 0) {

434 
	`mem£t
(
csum_d°
, 0, 
csum_size
);

435 
cou¡
 = 1;

437 i‡(
öode
->
roŸ
->
roŸ_key
.
obje˘id
 ==

438 
BTRFS_DATA_RELOC_TREE_OBJECTID
) {

439 
u64
 
fûe_off£t
 = 
bbio
->fûe_off£à+ 
bio_off£t
;

441 
	`£t_exã¡_bô
(&
öode
->
io_åì
, 
fûe_off£t
,

442 
fûe_off£t
 + 
£˘‹size
 - 1,

443 
EXTENT_NODATASUM
, 
NULL
);

445 
	`båfs_w¨n_æ
(
fs_öfo
,

447 
cur_disk_byãƒ
, cur_disk_byãƒ + 
£˘‹size
);

450 
bio_off£t
 +
cou¡
 * 
£˘‹size
;

453 
	`båfs_‰ì_∑th
(
∑th
);

454  
ªt
;

455 
	}
}

457 
	$båfs_lookup_csums_li°
(
båfs_roŸ
 *
roŸ
, 
u64
 
°¨t
, u64 
íd
,

458 
li°_hód
 *
li°
, 
£¨ch_commô
,

459 
boﬁ
 
nowaô
)

461 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

462 
båfs_key
 
key
;

463 
båfs_∑th
 *
∑th
;

464 
exã¡_buf„r
 *
Àaf
;

465 
båfs_‹dîed_sum
 *
sums
;

466 
båfs_csum_ôem
 *
ôem
;

467 
	`LIST_HEAD
(
tm∂i°
);

468 
ªt
;

470 
	`ASSERT
(
	`IS_ALIGNED
(
°¨t
, 
fs_öfo
->
£˘‹size
) &&

471 
	`IS_ALIGNED
(
íd
 + 1, 
fs_öfo
->
£˘‹size
));

473 
∑th
 = 
	`båfs_Æloc_∑th
();

474 i‡(!
∑th
)

475  -
ENOMEM
;

477 
∑th
->
nowaô
 =Çowait;

478 i‡(
£¨ch_commô
) {

479 
∑th
->
skù_lockög
 = 1;

480 
∑th
->
ªada
 = 
READA_FORWARD
;

481 
∑th
->
£¨ch_commô_roŸ
 = 1;

484 
key
.
obje˘id
 = 
BTRFS_EXTENT_CSUM_OBJECTID
;

485 
key
.
off£t
 = 
°¨t
;

486 
key
.
ty≥
 = 
BTRFS_EXTENT_CSUM_KEY
;

488 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

489 i‡(
ªt
 < 0)

490 
Áû
;

491 i‡(
ªt
 > 0 && 
∑th
->
¶Ÿs
[0] > 0) {

492 
Àaf
 = 
∑th
->
nodes
[0];

493 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0] - 1);

510 i‡(
key
.
obje˘id
 =
BTRFS_EXTENT_CSUM_OBJECTID
 &&

511 
key
.
ty≥
 =
BTRFS_EXTENT_CSUM_KEY
) {

512 i‡(
	`byãs_to_csum_size
(
fs_öfo
, 
°¨t
 - 
key
.
off£t
) <

513 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0] - 1))

514 
∑th
->
¶Ÿs
[0]--;

518 
°¨t
 <
íd
) {

519 
u64
 
csum_íd
;

521 
Àaf
 = 
∑th
->
nodes
[0];

522 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
(
Àaf
)) {

523 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

524 i‡(
ªt
 < 0)

525 
Áû
;

526 i‡(
ªt
 > 0)

528 
Àaf
 = 
∑th
->
nodes
[0];

531 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

532 i‡(
key
.
obje˘id
 !
BTRFS_EXTENT_CSUM_OBJECTID
 ||

533 
key
.
ty≥
 !
BTRFS_EXTENT_CSUM_KEY
 ||

534 
key
.
off£t
 > 
íd
)

537 i‡(
key
.
off£t
 > 
°¨t
)

538 
°¨t
 = 
key
.
off£t
;

540 
csum_íd
 = 
key
.
off£t
 + 
	`csum_size_to_byãs
(
fs_öfo
,

541 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]));

542 i‡(
csum_íd
 <
°¨t
) {

543 
∑th
->
¶Ÿs
[0]++;

547 
csum_íd
 = 
	`mö
(csum_íd, 
íd
 + 1);

548 
ôem
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

549 
båfs_csum_ôem
);

550 
°¨t
 < 
csum_íd
) {

551 
off£t
;

552 
size_t
 
size
;

554 
size
 = 
	`mö_t
(
size_t
, 
csum_íd
 - 
°¨t
,

555 
	`max_‹dîed_sum_byãs
(
fs_öfo
));

556 
sums
 = 
	`kzÆloc
(
	`båfs_‹dîed_sum_size
(
fs_öfo
, 
size
),

557 
GFP_NOFS
);

558 i‡(!
sums
) {

559 
ªt
 = -
ENOMEM
;

560 
Áû
;

563 
sums
->
logiˇl
 = 
°¨t
;

564 
sums
->
Àn
 = 
size
;

566 
off£t
 = 
	`byãs_to_csum_size
(
fs_öfo
, 
°¨t
 - 
key
.offset);

568 
	`ªad_exã¡_buf„r
(
∑th
->
nodes
[0],

569 
sums
->sums,

570 (()
ôem
Ë+ 
off£t
,

571 
	`byãs_to_csum_size
(
fs_öfo
, 
size
));

573 
°¨t
 +
size
;

574 
	`li°_add_èû
(&
sums
->
li°
, &
tm∂i°
);

576 
∑th
->
¶Ÿs
[0]++;

578 
ªt
 = 0;

579 
Áû
:

580 
ªt
 < 0 && !
	`li°_em±y
(&
tm∂i°
)) {

581 
sums
 = 
	`li°_íåy
(
tm∂i°
.
√xt
, 
båfs_‹dîed_sum
, 
li°
);

582 
	`li°_dñ
(&
sums
->
li°
);

583 
	`k‰ì
(
sums
);

585 
	`li°_•li˚_èû
(&
tm∂i°
, 
li°
);

587 
	`båfs_‰ì_∑th
(
∑th
);

588  
ªt
;

589 
	}
}

600 
	$båfs_lookup_csums_bôm≠
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
,

601 
u64
 
°¨t
, u64 
íd
, 
u8
 *
csum_buf
,

602 *
csum_bôm≠
)

604 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

605 
båfs_key
 
key
;

606 
exã¡_buf„r
 *
Àaf
;

607 
båfs_csum_ôem
 *
ôem
;

608 c⁄° 
u64
 
‹ig_°¨t
 = 
°¨t
;

609 
boﬁ
 
‰ì_∑th
 = 
Ál£
;

610 
ªt
;

612 
	`ASSERT
(
	`IS_ALIGNED
(
°¨t
, 
fs_öfo
->
£˘‹size
) &&

613 
	`IS_ALIGNED
(
íd
 + 1, 
fs_öfo
->
£˘‹size
));

615 i‡(!
∑th
) {

616 
∑th
 = 
	`båfs_Æloc_∑th
();

617 i‡(!
∑th
)

618  -
ENOMEM
;

619 
‰ì_∑th
 = 
åue
;

623 i‡(
∑th
->
nodes
[0]) {

624 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

626 i‡(
key
.
obje˘id
 =
BTRFS_EXTENT_CSUM_OBJECTID
 &&

627 
key
.
ty≥
 =
BTRFS_EXTENT_CSUM_KEY
 &&

628 
key
.
off£t
 <
°¨t
)

629 
£¨ch_f‹w¨d
;

630 
	`båfs_ªÀa£_∑th
(
∑th
);

633 
key
.
obje˘id
 = 
BTRFS_EXTENT_CSUM_OBJECTID
;

634 
key
.
ty≥
 = 
BTRFS_EXTENT_CSUM_KEY
;

635 
key
.
off£t
 = 
°¨t
;

637 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

638 i‡(
ªt
 < 0)

639 
Áû
;

640 i‡(
ªt
 > 0 && 
∑th
->
¶Ÿs
[0] > 0) {

641 
Àaf
 = 
∑th
->
nodes
[0];

642 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0] - 1);

659 i‡(
key
.
obje˘id
 =
BTRFS_EXTENT_CSUM_OBJECTID
 &&

660 
key
.
ty≥
 =
BTRFS_EXTENT_CSUM_KEY
) {

661 i‡(
	`byãs_to_csum_size
(
fs_öfo
, 
°¨t
 - 
key
.
off£t
) <

662 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0] - 1))

663 
∑th
->
¶Ÿs
[0]--;

667 
£¨ch_f‹w¨d
:

668 
°¨t
 <
íd
) {

669 
u64
 
csum_íd
;

671 
Àaf
 = 
∑th
->
nodes
[0];

672 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
(
Àaf
)) {

673 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

674 i‡(
ªt
 < 0)

675 
Áû
;

676 i‡(
ªt
 > 0)

678 
Àaf
 = 
∑th
->
nodes
[0];

681 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

682 i‡(
key
.
obje˘id
 !
BTRFS_EXTENT_CSUM_OBJECTID
 ||

683 
key
.
ty≥
 !
BTRFS_EXTENT_CSUM_KEY
 ||

684 
key
.
off£t
 > 
íd
)

687 i‡(
key
.
off£t
 > 
°¨t
)

688 
°¨t
 = 
key
.
off£t
;

690 
csum_íd
 = 
key
.
off£t
 + 
	`csum_size_to_byãs
(
fs_öfo
,

691 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]));

692 i‡(
csum_íd
 <
°¨t
) {

693 
∑th
->
¶Ÿs
[0]++;

697 
csum_íd
 = 
	`mö
(csum_íd, 
íd
 + 1);

698 
ôem
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

699 
båfs_csum_ôem
);

700 
°¨t
 < 
csum_íd
) {

701 
off£t
;

702 
size_t
 
size
;

703 
u8
 *
csum_de°
 = 
csum_buf
 + 
	`byãs_to_csum_size
(
fs_öfo
,

704 
°¨t
 - 
‹ig_°¨t
);

706 
size
 = 
	`mö_t
(
size_t
, 
csum_íd
 - 
°¨t
, 
íd
 + 1 - start);

708 
off£t
 = 
	`byãs_to_csum_size
(
fs_öfo
, 
°¨t
 - 
key
.offset);

710 
	`ªad_exã¡_buf„r
(
∑th
->
nodes
[0], 
csum_de°
,

711 (()
ôem
Ë+ 
off£t
,

712 
	`byãs_to_csum_size
(
fs_öfo
, 
size
));

714 
	`bôm≠_£t
(
csum_bôm≠
,

715 (
°¨t
 - 
‹ig_°¨t
Ë>> 
fs_öfo
->
£˘‹size_bôs
,

716 
size
 >> 
fs_öfo
->
£˘‹size_bôs
);

718 
°¨t
 +
size
;

720 
∑th
->
¶Ÿs
[0]++;

722 
ªt
 = 0;

723 
Áû
:

724 i‡(
‰ì_∑th
)

725 
	`båfs_‰ì_∑th
(
∑th
);

726  
ªt
;

727 
	}
}

732 
blk_°©us_t
 
	$båfs_csum_⁄e_bio
(
båfs_bio
 *
bbio
)

734 
båfs_‹dîed_exã¡
 *
‹dîed
 = 
bbio
->ordered;

735 
båfs_öode
 *
öode
 = 
bbio
->inode;

736 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

737 
	`SHASH_DESC_ON_STACK
(
shash
, 
fs_öfo
->
csum_shash
);

738 
bio
 *biÿ&
bbio
->bio;

739 
båfs_‹dîed_sum
 *
sums
;

740 *
d©a
;

741 
bvec_ôî
 
ôî
;

742 
bio_vec
 
bvec
;

743 
ödex
;

744 
blockcou¡
;

745 
i
;

746 
nofs_Êag
;

748 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

749 
sums
 = 
	`kvzÆloc
(
	`båfs_‹dîed_sum_size
(
fs_öfo
, 
bio
->
bi_ôî
.
bi_size
),

750 
GFP_KERNEL
);

751 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

753 i‡(!
sums
)

754  
BLK_STS_RESOURCE
;

756 
sums
->
Àn
 = 
bio
->
bi_ôî
.
bi_size
;

757 
	`INIT_LIST_HEAD
(&
sums
->
li°
);

759 
sums
->
logiˇl
 = 
bio
->
bi_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
;

760 
ödex
 = 0;

762 
shash
->
tfm
 = 
fs_öfo
->
csum_shash
;

764 
	`bio_f‹_óch_£gmít
(
bvec
, 
bio
, 
ôî
) {

765 
blockcou¡
 = 
	`BTRFS_BYTES_TO_BLKS
(
fs_öfo
,

766 
bvec
.
bv_Àn
 + 
fs_öfo
->
£˘‹size


769 
i
 = 0; i < 
blockcou¡
; i++) {

770 
d©a
 = 
	`bvec_km≠_loˇl
(&
bvec
);

771 
	`¸y±o_shash_dige°
(
shash
,

772 
d©a
 + (
i
 * 
fs_öfo
->
£˘‹size
),

773 
fs_öfo
->
£˘‹size
,

774 
sums
->sum†+ 
ödex
);

775 
	`kunm≠_loˇl
(
d©a
);

776 
ödex
 +
fs_öfo
->
csum_size
;

781 
bbio
->
sums
 = sums;

782 
	`båfs_add_‹dîed_sum
(
‹dîed
, 
sums
);

784 
	}
}

791 
blk_°©us_t
 
	$båfs_Æloc_dummy_sum
(
båfs_bio
 *
bbio
)

793 
bbio
->
sums
 = 
	`kmÆloc
((*bbio->sums), 
GFP_NOFS
);

794 i‡(!
bbio
->
sums
)

795  
BLK_STS_RESOURCE
;

796 
bbio
->
sums
->
Àn
 = bbio->
bio
.
bi_ôî
.
bi_size
;

797 
bbio
->
sums
->
logiˇl
 = bbio->
bio
.
bi_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
;

798 
	`båfs_add_‹dîed_sum
(
bbio
->
‹dîed
, bbio->
sums
);

800 
	}
}

814 
noölöe
 
	$åunˇã_⁄e_csum
(
båfs_å™s_h™dÀ
 *
å™s
,

815 
båfs_∑th
 *
∑th
,

816 
båfs_key
 *
key
,

817 
u64
 
byãƒ
, u64 
Àn
)

819 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

820 
exã¡_buf„r
 *
Àaf
;

821 c⁄° 
u32
 
csum_size
 = 
fs_öfo
->csum_size;

822 
u64
 
csum_íd
;

823 
u64
 
íd_byã
 = 
byãƒ
 + 
Àn
;

824 
u32
 
blocksize_bôs
 = 
fs_öfo
->
£˘‹size_bôs
;

826 
Àaf
 = 
∑th
->
nodes
[0];

827 
csum_íd
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]Ë/ 
csum_size
;

828 
csum_íd
 <<
blocksize_bôs
;

829 
csum_íd
 +
key
->
off£t
;

831 i‡(
key
->
off£t
 < 
byãƒ
 && 
csum_íd
 <
íd_byã
) {

838 
u32
 
√w_size
 = (
byãƒ
 - 
key
->
off£t
Ë>> 
blocksize_bôs
;

839 
√w_size
 *
csum_size
;

840 
	`båfs_åunˇã_ôem
(
å™s
, 
∑th
, 
√w_size
, 1);

841 } i‡(
key
->
off£t
 >
byãƒ
 && 
csum_íd
 > 
íd_byã
 &&

842 
íd_byã
 > 
key
->
off£t
) {

849 
u32
 
√w_size
 = (
csum_íd
 - 
íd_byã
Ë>> 
blocksize_bôs
;

850 
√w_size
 *
csum_size
;

852 
	`båfs_åunˇã_ôem
(
å™s
, 
∑th
, 
√w_size
, 0);

854 
key
->
off£t
 = 
íd_byã
;

855 
	`båfs_£t_ôem_key_ß„
(
å™s
, 
∑th
, 
key
);

857 
	`BUG
();

859 
	}
}

864 
	$båfs_dñ_csums
(
båfs_å™s_h™dÀ
 *
å™s
,

865 
båfs_roŸ
 *
roŸ
, 
u64
 
byãƒ
, u64 
Àn
)

867 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

868 
båfs_∑th
 *
∑th
;

869 
båfs_key
 
key
;

870 
u64
 
íd_byã
 = 
byãƒ
 + 
Àn
;

871 
u64
 
csum_íd
;

872 
exã¡_buf„r
 *
Àaf
;

873 
ªt
 = 0;

874 c⁄° 
u32
 
csum_size
 = 
fs_öfo
->csum_size;

875 
u32
 
blocksize_bôs
 = 
fs_öfo
->
£˘‹size_bôs
;

877 
	`ASSERT
(
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_CSUM_TREE_OBJECTID
 ||

878 
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_LOG_OBJECTID
);

880 
∑th
 = 
	`båfs_Æloc_∑th
();

881 i‡(!
∑th
)

882  -
ENOMEM
;

885 
key
.
obje˘id
 = 
BTRFS_EXTENT_CSUM_OBJECTID
;

886 
key
.
off£t
 = 
íd_byã
 - 1;

887 
key
.
ty≥
 = 
BTRFS_EXTENT_CSUM_KEY
;

889 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

890 i‡(
ªt
 > 0) {

891 
ªt
 = 0;

892 i‡(
∑th
->
¶Ÿs
[0] == 0)

894 
∑th
->
¶Ÿs
[0]--;

895 } i‡(
ªt
 < 0) {

899 
Àaf
 = 
∑th
->
nodes
[0];

900 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

902 i‡(
key
.
obje˘id
 !
BTRFS_EXTENT_CSUM_OBJECTID
 ||

903 
key
.
ty≥
 !
BTRFS_EXTENT_CSUM_KEY
) {

907 i‡(
key
.
off£t
 >
íd_byã
)

910 
csum_íd
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]Ë/ 
csum_size
;

911 
csum_íd
 <<
blocksize_bôs
;

912 
csum_íd
 +
key
.
off£t
;

915 i‡(
csum_íd
 <
byãƒ
)

919 i‡(
key
.
off£t
 >
byãƒ
 && 
csum_íd
 <
íd_byã
) {

920 
dñ_ƒ
 = 1;

927 i‡(
key
.
off£t
 > 
byãƒ
 && 
∑th
->
¶Ÿs
[0] > 0) {

928 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0] - 1;

930 
¶Ÿ
 >= 0) {

931 
båfs_key
 
pk
;

933 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
pk
, 
¶Ÿ
);

934 i‡(
pk
.
off£t
 < 
byãƒ
 ||

935 
pk
.
ty≥
 !
BTRFS_EXTENT_CSUM_KEY
 ||

936 
pk
.
obje˘id
 !=

937 
BTRFS_EXTENT_CSUM_OBJECTID
)

939 
∑th
->
¶Ÿs
[0] = 
¶Ÿ
;

940 
dñ_ƒ
++;

941 
key
.
off£t
 = 
pk
.offset;

942 
¶Ÿ
--;

945 
ªt
 = 
	`båfs_dñ_ôems
(
å™s
, 
roŸ
, 
∑th
,

946 
∑th
->
¶Ÿs
[0], 
dñ_ƒ
);

947 i‡(
ªt
)

949 i‡(
key
.
off£t
 =
byãƒ
)

951 } i‡(
key
.
off£t
 < 
byãƒ
 && 
csum_íd
 > 
íd_byã
) {

952 
off£t
;

953 
shi·_Àn
;

954 
ôem_off£t
;

973 
off£t
 = (
byãƒ
 - 
key
.off£tË>> 
blocksize_bôs
;

974 
off£t
 *
csum_size
;

976 
shi·_Àn
 = (
Àn
 >> 
blocksize_bôs
Ë* 
csum_size
;

978 
ôem_off£t
 = 
	`båfs_ôem_±r_off£t
(
Àaf
,

979 
∑th
->
¶Ÿs
[0]);

981 
	`memzîo_exã¡_buf„r
(
Àaf
, 
ôem_off£t
 + 
off£t
,

982 
shi·_Àn
);

983 
key
.
off£t
 = 
byãƒ
;

989 
ªt
 = 
	`båfs_•lô_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
, 
off£t
);

990 i‡(
ªt
 &&Ñë !-
EAGAIN
) {

991 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

994 
ªt
 = 0;

996 
key
.
off£t
 = 
íd_byã
 - 1;

998 
	`åunˇã_⁄e_csum
(
å™s
, 
∑th
, &
key
, 
byãƒ
, 
Àn
);

999 i‡(
key
.
off£t
 < 
byãƒ
)

1002 
	`båfs_ªÀa£_∑th
(
∑th
);

1004 
	`båfs_‰ì_∑th
(
∑th
);

1005  
ªt
;

1006 
	}
}

1008 
	$föd_√xt_csum_off£t
(
båfs_roŸ
 *
roŸ
,

1009 
båfs_∑th
 *
∑th
,

1010 
u64
 *
√xt_off£t
)

1012 c⁄° 
u32
 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0]);

1013 
båfs_key
 
found_key
;

1014 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0] + 1;

1015 
ªt
;

1017 i‡(
ƒôems
 =0 || 
¶Ÿ
 >=Çritems) {

1018 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

1019 i‡(
ªt
 < 0) {

1020  
ªt
;

1021 } i‡(
ªt
 > 0) {

1022 *
√xt_off£t
 = (
u64
)-1;

1025 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

1028 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
found_key
, 
¶Ÿ
);

1030 i‡(
found_key
.
obje˘id
 !
BTRFS_EXTENT_CSUM_OBJECTID
 ||

1031 
found_key
.
ty≥
 !
BTRFS_EXTENT_CSUM_KEY
)

1032 *
√xt_off£t
 = (
u64
)-1;

1034 *
√xt_off£t
 = 
found_key
.
off£t
;

1037 
	}
}

1039 
	$båfs_csum_fûe_blocks
(
båfs_å™s_h™dÀ
 *
å™s
,

1040 
båfs_roŸ
 *
roŸ
,

1041 
båfs_‹dîed_sum
 *
sums
)

1043 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1044 
båfs_key
 
fûe_key
;

1045 
båfs_key
 
found_key
;

1046 
båfs_∑th
 *
∑th
;

1047 
båfs_csum_ôem
 *
ôem
;

1048 
båfs_csum_ôem
 *
ôem_íd
;

1049 
exã¡_buf„r
 *
Àaf
 = 
NULL
;

1050 
u64
 
√xt_off£t
;

1051 
u64
 
tŸÆ_byãs
 = 0;

1052 
u64
 
csum_off£t
;

1053 
u64
 
byãƒ
;

1054 
u32
 
ös_size
;

1055 
ödex
 = 0;

1056 
found_√xt
;

1057 
ªt
;

1058 c⁄° 
u32
 
csum_size
 = 
fs_öfo
->csum_size;

1060 
∑th
 = 
	`båfs_Æloc_∑th
();

1061 i‡(!
∑th
)

1062  -
ENOMEM
;

1063 
agaö
:

1064 
√xt_off£t
 = (
u64
)-1;

1065 
found_√xt
 = 0;

1066 
byãƒ
 = 
sums
->
logiˇl
 + 
tŸÆ_byãs
;

1067 
fûe_key
.
obje˘id
 = 
BTRFS_EXTENT_CSUM_OBJECTID
;

1068 
fûe_key
.
off£t
 = 
byãƒ
;

1069 
fûe_key
.
ty≥
 = 
BTRFS_EXTENT_CSUM_KEY
;

1071 
ôem
 = 
	`båfs_lookup_csum
(
å™s
, 
roŸ
, 
∑th
, 
byãƒ
, 1);

1072 i‡(!
	`IS_ERR
(
ôem
)) {

1073 
ªt
 = 0;

1074 
Àaf
 = 
∑th
->
nodes
[0];

1075 
ôem_íd
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

1076 
båfs_csum_ôem
);

1077 
ôem_íd
 = (
båfs_csum_ôem
 *)((*)item_end +

1078 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]));

1079 
found
;

1081 
ªt
 = 
	`PTR_ERR
(
ôem
);

1082 i‡(
ªt
 !-
EFBIG
 &&Ñë !-
ENOENT
)

1083 
out
;

1085 i‡(
ªt
 =-
EFBIG
) {

1086 
u32
 
ôem_size
;

1088 
Àaf
 = 
∑th
->
nodes
[0];

1089 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

1090 i‡((
ôem_size
 / 
csum_size
) >=

1091 
	`MAX_CSUM_ITEMS
(
fs_öfo
, 
csum_size
)) {

1093 
ö£π
;

1097 
ªt
 = 
	`föd_√xt_csum_off£t
(
roŸ
, 
∑th
, &
√xt_off£t
);

1098 i‡(
ªt
 < 0)

1099 
out
;

1100 
found_√xt
 = 1;

1101 
ö£π
;

1114 i‡(
	`båfs_Àaf_‰ì_•a˚
(
Àaf
Ë>
csum_size
) {

1115 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0]);

1116 
csum_off£t
 = (
byãƒ
 - 
found_key
.
off£t
) >>

1117 
fs_öfo
->
£˘‹size_bôs
;

1118 
exãnd_csum
;

1121 
	`båfs_ªÀa£_∑th
(
∑th
);

1122 
∑th
->
£¨ch_f‹_exãnsi⁄
 = 1;

1123 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
fûe_key
, 
∑th
,

1124 
csum_size
, 1);

1125 
∑th
->
£¨ch_f‹_exãnsi⁄
 = 0;

1126 i‡(
ªt
 < 0)

1127 
out
;

1129 i‡(
ªt
 > 0) {

1130 i‡(
∑th
->
¶Ÿs
[0] == 0)

1131 
ö£π
;

1132 
∑th
->
¶Ÿs
[0]--;

1135 
Àaf
 = 
∑th
->
nodes
[0];

1136 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0]);

1137 
csum_off£t
 = (
byãƒ
 - 
found_key
.
off£t
Ë>> 
fs_öfo
->
£˘‹size_bôs
;

1139 i‡(
found_key
.
ty≥
 !
BTRFS_EXTENT_CSUM_KEY
 ||

1140 
found_key
.
obje˘id
 !
BTRFS_EXTENT_CSUM_OBJECTID
 ||

1141 
csum_off£t
 >
	`MAX_CSUM_ITEMS
(
fs_öfo
, 
csum_size
)) {

1142 
ö£π
;

1145 
exãnd_csum
:

1146 i‡(
csum_off£t
 =
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]) /

1147 
csum_size
) {

1148 
exãnd_ƒ
;

1149 
u64
 
tmp
;

1150 
u32
 
diff
;

1152 
tmp
 = 
sums
->
Àn
 - 
tŸÆ_byãs
;

1153 
tmp
 >>
fs_öfo
->
£˘‹size_bôs
;

1154 
	`WARN_ON
(
tmp
 < 1);

1155 
exãnd_ƒ
 = 
	`max_t
(, 1, 
tmp
);

1178 i‡(
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_LOG_OBJECTID
) {

1179 i‡(
∑th
->
¶Ÿs
[0] + 1 >=

1180 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0])) {

1181 
ªt
 = 
	`föd_√xt_csum_off£t
(
roŸ
, 
∑th
, &
√xt_off£t
);

1182 i‡(
ªt
 < 0)

1183 
out
;

1184 
found_√xt
 = 1;

1185 
ö£π
;

1188 
ªt
 = 
	`föd_√xt_csum_off£t
(
roŸ
, 
∑th
, &
√xt_off£t
);

1189 i‡(
ªt
 < 0)

1190 
out
;

1192 
tmp
 = (
√xt_off£t
 - 
byãƒ
Ë>> 
fs_öfo
->
£˘‹size_bôs
;

1193 i‡(
tmp
 <
INT_MAX
)

1194 
exãnd_ƒ
 = 
	`mö_t
(,Éxãnd_ƒ, 
tmp
);

1197 
diff
 = (
csum_off£t
 + 
exãnd_ƒ
Ë* 
csum_size
;

1198 
diff
 = 
	`mö
(diff,

1199 
	`MAX_CSUM_ITEMS
(
fs_öfo
, 
csum_size
) * csum_size);

1201 
diff
 = dif‡- 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

1202 
diff
 = 
	`mö_t
(
u32
, 
	`båfs_Àaf_‰ì_•a˚
(
Àaf
), diff);

1203 
diff
 /
csum_size
;

1204 
diff
 *
csum_size
;

1206 
	`båfs_exãnd_ôem
(
å™s
, 
∑th
, 
diff
);

1207 
ªt
 = 0;

1208 
csum
;

1211 
ö£π
:

1212 
	`båfs_ªÀa£_∑th
(
∑th
);

1213 
csum_off£t
 = 0;

1214 i‡(
found_√xt
) {

1215 
u64
 
tmp
;

1217 
tmp
 = 
sums
->
Àn
 - 
tŸÆ_byãs
;

1218 
tmp
 >>
fs_öfo
->
£˘‹size_bôs
;

1219 
tmp
 = 
	`mö
—mp, (
√xt_off£t
 - 
fûe_key
.
off£t
) >>

1220 
fs_öfo
->
£˘‹size_bôs
);

1222 
tmp
 = 
	`max_t
(
u64
, 1,Åmp);

1223 
tmp
 = 
	`mö_t
(
u64
,Åmp, 
	`MAX_CSUM_ITEMS
(
fs_öfo
, 
csum_size
));

1224 
ös_size
 = 
csum_size
 * 
tmp
;

1226 
ös_size
 = 
csum_size
;

1228 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
fûe_key
,

1229 
ös_size
);

1230 i‡(
ªt
 < 0)

1231 
out
;

1232 i‡(
	`WARN_ON
(
ªt
 != 0))

1233 
out
;

1234 
Àaf
 = 
∑th
->
nodes
[0];

1235 
csum
:

1236 
ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_csum_ôem
);

1237 
ôem_íd
 = (
båfs_csum_ôem
 *)((*)
ôem
 +

1238 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]));

1239 
ôem
 = (
båfs_csum_ôem
 *)((*)item +

1240 
csum_off£t
 * 
csum_size
);

1241 
found
:

1242 
ös_size
 = (
u32
)(
sums
->
Àn
 - 
tŸÆ_byãs
Ë>> 
fs_öfo
->
£˘‹size_bôs
;

1243 
ös_size
 *
csum_size
;

1244 
ös_size
 = 
	`mö_t
(
u32
, ()
ôem_íd
 - ()
ôem
,

1245 
ös_size
);

1246 
	`wrôe_exã¡_buf„r
(
Àaf
, 
sums
->sum†+ 
ödex
, ()
ôem
,

1247 
ös_size
);

1249 
ödex
 +
ös_size
;

1250 
ös_size
 /
csum_size
;

1251 
tŸÆ_byãs
 +
ös_size
 * 
fs_öfo
->
£˘‹size
;

1253 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑th
->
nodes
[0]);

1254 i‡(
tŸÆ_byãs
 < 
sums
->
Àn
) {

1255 
	`båfs_ªÀa£_∑th
(
∑th
);

1256 
	`c⁄d_ªsched
();

1257 
agaö
;

1259 
out
:

1260 
	`båfs_‰ì_∑th
(
∑th
);

1261  
ªt
;

1262 
	}
}

1264 
	$båfs_exã¡_ôem_to_exã¡_m≠
(
båfs_öode
 *
öode
,

1265 c⁄° 
båfs_∑th
 *
∑th
,

1266 
båfs_fûe_exã¡_ôem
 *
fi
,

1267 
exã¡_m≠
 *
em
)

1269 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

1270 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

1271 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

1272 c⁄° 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

1273 
båfs_key
 
key
;

1274 
u64
 
exã¡_°¨t
, 
exã¡_íd
;

1275 
u64
 
byãƒ
;

1276 
u8
 
ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
fi
);

1277 
com¥ess_ty≥
 = 
	`båfs_fûe_exã¡_com¥essi⁄
(
Àaf
, 
fi
);

1279 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

1280 
exã¡_°¨t
 = 
key
.
off£t
;

1281 
exã¡_íd
 = 
	`båfs_fûe_exã¡_íd
(
∑th
);

1282 
em
->
øm_byãs
 = 
	`båfs_fûe_exã¡_øm_byãs
(
Àaf
, 
fi
);

1283 
em
->
gíî©i⁄
 = 
	`båfs_fûe_exã¡_gíî©i⁄
(
Àaf
, 
fi
);

1284 i‡(
ty≥
 =
BTRFS_FILE_EXTENT_REG
 ||

1285 
ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
) {

1286 
em
->
°¨t
 = 
exã¡_°¨t
;

1287 
em
->
Àn
 = 
exã¡_íd
 - 
exã¡_°¨t
;

1288 
em
->
‹ig_°¨t
 = 
exã¡_°¨t
 -

1289 
	`båfs_fûe_exã¡_off£t
(
Àaf
, 
fi
);

1290 
em
->
‹ig_block_Àn
 = 
	`båfs_fûe_exã¡_disk_num_byãs
(
Àaf
, 
fi
);

1291 
byãƒ
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
fi
);

1292 i‡(
byãƒ
 == 0) {

1293 
em
->
block_°¨t
 = 
EXTENT_MAP_HOLE
;

1296 i‡(
com¥ess_ty≥
 !
BTRFS_COMPRESS_NONE
) {

1297 
	`£t_bô
(
EXTENT_FLAG_COMPRESSED
, &
em
->
Êags
);

1298 
em
->
com¥ess_ty≥
 = compress_type;

1299 
em
->
block_°¨t
 = 
byãƒ
;

1300 
em
->
block_Àn
 =Ém->
‹ig_block_Àn
;

1302 
byãƒ
 +
	`båfs_fûe_exã¡_off£t
(
Àaf
, 
fi
);

1303 
em
->
block_°¨t
 = 
byãƒ
;

1304 
em
->
block_Àn
 =Ém->
Àn
;

1305 i‡(
ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
)

1306 
	`£t_bô
(
EXTENT_FLAG_PREALLOC
, &
em
->
Êags
);

1308 } i‡(
ty≥
 =
BTRFS_FILE_EXTENT_INLINE
) {

1309 
em
->
block_°¨t
 = 
EXTENT_MAP_INLINE
;

1310 
em
->
°¨t
 = 
exã¡_°¨t
;

1311 
em
->
Àn
 = 
exã¡_íd
 - 
exã¡_°¨t
;

1316 
em
->
‹ig_°¨t
 = 
EXTENT_MAP_HOLE
;

1317 
em
->
block_Àn
 = (
u64
)-1;

1318 
em
->
com¥ess_ty≥
 = compress_type;

1319 i‡(
com¥ess_ty≥
 !
BTRFS_COMPRESS_NONE
)

1320 
	`£t_bô
(
EXTENT_FLAG_COMPRESSED
, &
em
->
Êags
);

1322 
	`båfs_îr
(
fs_öfo
,

1324 "roŸ %Œu", 
ty≥
, 
	`båfs_öo
(
öode
), 
exã¡_°¨t
,

1325 
roŸ
->
roŸ_key
.
obje˘id
);

1327 
	}
}

1334 
u64
 
	$båfs_fûe_exã¡_íd
(c⁄° 
båfs_∑th
 *
∑th
)

1336 c⁄° 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

1337 c⁄° 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

1338 
båfs_fûe_exã¡_ôem
 *
fi
;

1339 
båfs_key
 
key
;

1340 
u64
 
íd
;

1342 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

1343 
	`ASSERT
(
key
.
ty≥
 =
BTRFS_EXTENT_DATA_KEY
);

1344 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_fûe_exã¡_ôem
);

1346 i‡(
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
fi
Ë=
BTRFS_FILE_EXTENT_INLINE
) {

1347 
íd
 = 
	`båfs_fûe_exã¡_øm_byãs
(
Àaf
, 
fi
);

1348 
íd
 = 
	`ALIGN
(
key
.
off£t
 +Énd, 
Àaf
->
fs_öfo
->
£˘‹size
);

1350 
íd
 = 
key
.
off£t
 + 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
fi
);

1353  
íd
;

1354 
	}
}

	@file-item.h

3 #i‚de‡
BTRFS_FILE_ITEM_H


4 
	#BTRFS_FILE_ITEM_H


	)

6 
	~"ac˚ss‹s.h
"

8 
	#BTRFS_FILE_EXTENT_INLINE_DATA_START
 \

9 (
	`off£tof
(
båfs_fûe_exã¡_ôem
, 
disk_byãƒ
))

	)

11 
ölöe
 
u32
 
	$BTRFS_MAX_INLINE_DATA_SIZE
(c⁄° 
båfs_fs_öfo
 *
öfo
)

13  
	`BTRFS_MAX_ITEM_SIZE
(
öfo
Ë- 
BTRFS_FILE_EXTENT_INLINE_DATA_START
;

14 
	}
}

21 
ölöe
 
u32
 
	$båfs_fûe_exã¡_ölöe_ôem_Àn
(

22 c⁄° 
exã¡_buf„r
 *
eb
,

23 
ƒ
)

25  
	`båfs_ôem_size
(
eb
, 
ƒ
Ë- 
BTRFS_FILE_EXTENT_INLINE_DATA_START
;

26 
	}
}

28 
ölöe
 
	$båfs_fûe_exã¡_ölöe_°¨t
(

29 c⁄° 
båfs_fûe_exã¡_ôem
 *
e
)

31  ()
e
 + 
BTRFS_FILE_EXTENT_INLINE_DATA_START
;

32 
	}
}

34 
ölöe
 
u32
 
	$båfs_fûe_exã¡_ˇlc_ölöe_size
(
u32
 
d©asize
)

36  
BTRFS_FILE_EXTENT_INLINE_DATA_START
 + 
d©asize
;

37 
	}
}

39 
båfs_dñ_csums
(
båfs_å™s_h™dÀ
 *
å™s
,

40 
båfs_roŸ
 *
roŸ
, 
u64
 
byãƒ
, u64 
Àn
);

41 
blk_°©us_t
 
båfs_lookup_bio_sums
(
båfs_bio
 *
bbio
);

42 
båfs_ö£π_hﬁe_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

43 
båfs_roŸ
 *
roŸ
, 
u64
 
obje˘id
, u64 
pos
,

44 
u64
 
num_byãs
);

45 
båfs_lookup_fûe_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

46 
båfs_roŸ
 *
roŸ
,

47 
båfs_∑th
 *
∑th
, 
u64
 
obje˘id
,

48 
u64
 
byãƒ
, 
mod
);

49 
båfs_csum_fûe_blocks
(
båfs_å™s_h™dÀ
 *
å™s
,

50 
båfs_roŸ
 *
roŸ
,

51 
båfs_‹dîed_sum
 *
sums
);

52 
blk_°©us_t
 
båfs_csum_⁄e_bio
(
båfs_bio
 *
bbio
);

53 
blk_°©us_t
 
båfs_Æloc_dummy_sum
(
båfs_bio
 *
bbio
);

54 
båfs_lookup_csums_ønge
(
båfs_roŸ
 *
roŸ
, 
u64
 
°¨t
, u64 
íd
,

55 
li°_hód
 *
li°
, 
£¨ch_commô
,

56 
boﬁ
 
nowaô
);

57 
båfs_lookup_csums_li°
(
båfs_roŸ
 *
roŸ
, 
u64
 
°¨t
, u64 
íd
,

58 
li°_hód
 *
li°
, 
£¨ch_commô
,

59 
boﬁ
 
nowaô
);

60 
båfs_lookup_csums_bôm≠
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
,

61 
u64
 
°¨t
, u64 
íd
, 
u8
 *
csum_buf
,

62 *
csum_bôm≠
);

63 
båfs_exã¡_ôem_to_exã¡_m≠
(
båfs_öode
 *
öode
,

64 c⁄° 
båfs_∑th
 *
∑th
,

65 
båfs_fûe_exã¡_ôem
 *
fi
,

66 
exã¡_m≠
 *
em
);

67 
båfs_öode_˛ór_fûe_exã¡_ønge
(
båfs_öode
 *
öode
, 
u64
 
°¨t
,

68 
u64
 
Àn
);

69 
båfs_öode_£t_fûe_exã¡_ønge
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
Àn
);

70 
båfs_öode_ß„_disk_i_size_wrôe
(
båfs_öode
 *
öode
, 
u64
 
√w_i_size
);

71 
u64
 
båfs_fûe_exã¡_íd
(c⁄° 
båfs_∑th
 *
∑th
);

	@file.c

6 
	~<löux/fs.h
>

7 
	~<löux/∑gem≠.h
>

8 
	~<löux/time.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/°rög.h
>

11 
	~<löux/backög-dev.h
>

12 
	~<löux/ÁŒoc.h
>

13 
	~<löux/wrôeback.h
>

14 
	~<löux/com∑t.h
>

15 
	~<löux/¶ab.h
>

16 
	~<löux/båfs.h
>

17 
	~<löux/uio.h
>

18 
	~<löux/ivîsi⁄.h
>

19 
	~<löux/fsvîôy.h
>

20 
	~"˘ªe.h
"

21 
	~"disk-io.h
"

22 
	~"å™ß˘i⁄.h
"

23 
	~"båfs_öode.h
"

24 
	~"¥öt-åì.h
"

25 
	~"åì-log.h
"

26 
	~"lockög.h
"

27 
	~"vﬁumes.h
"

28 
	~"qgroup.h
"

29 
	~"com¥essi⁄.h
"

30 
	~"dñÆloc-•a˚.h
"

31 
	~"ªÊök.h
"

32 
	~"sub∑ge.h
"

33 
	~"fs.h
"

34 
	~"ac˚ss‹s.h
"

35 
	~"exã¡-åì.h
"

36 
	~"fûe-ôem.h
"

37 
	~"io˘l.h
"

38 
	~"fûe.h
"

39 
	~"su≥r.h
"

40 
	~"mm/fûem≠.h
"

44 
noölöe
 
	$båfs_c›y_‰om_u£r
(
loff_t
 
pos
, 
size_t
 
wrôe_byãs
,

45 
∑ge
 **
¥ï¨ed_∑ges
,

46 
iov_ôî
 *
i
)

48 
size_t
 
c›õd
 = 0;

49 
size_t
 
tŸÆ_c›õd
 = 0;

50 
pg
 = 0;

51 
off£t
 = 
	`off£t_ö_∑ge
(
pos
);

53 
wrôe_byãs
 > 0) {

54 
size_t
 
cou¡
 = 
	`mö_t
(size_t,

55 
PAGE_SIZE
 - 
off£t
, 
wrôe_byãs
);

56 
∑ge
 *∑gê
¥ï¨ed_∑ges
[
pg
];

60 
c›õd
 = 
	`c›y_∑ge_‰om_ôî_©omic
(
∑ge
, 
off£t
, 
cou¡
, 
i
);

63 
	`Êush_dˇche_∑ge
(
∑ge
);

74 i‡(
	`u∆ikñy
(
c›õd
 < 
cou¡
)) {

75 i‡(!
	`PageU±od©e
(
∑ge
)) {

76 
	`iov_ôî_ªvît
(
i
, 
c›õd
);

77 
c›õd
 = 0;

79 i‡(!
c›õd
)

83 
wrôe_byãs
 -
c›õd
;

84 
tŸÆ_c›õd
 +
c›õd
;

85 
off£t
 +
c›õd
;

86 i‡(
off£t
 =
PAGE_SIZE
) {

87 
pg
++;

88 
off£t
 = 0;

91  
tŸÆ_c›õd
;

92 
	}
}

97 
	$båfs_dr›_∑ges
(
båfs_fs_öfo
 *
fs_öfo
,

98 
∑ge
 **
∑ges
, 
size_t
 
num_∑ges
,

99 
u64
 
pos
, u64 
c›õd
)

101 
size_t
 
i
;

102 
u64
 
block_°¨t
 = 
	`round_down
(
pos
, 
fs_öfo
->
£˘‹size
);

103 
u64
 
block_Àn
 = 
	`round_up
(
pos
 + 
c›õd
, 
fs_öfo
->
£˘‹size
Ë- 
block_°¨t
;

105 
	`ASSERT
(
block_Àn
 <
U32_MAX
);

106 
i
 = 0; i < 
num_∑ges
; i++) {

113 
	`båfs_∑ge_˛amp_˛ór_checked
(
fs_öfo
, 
∑ges
[
i
], 
block_°¨t
,

114 
block_Àn
);

115 
	`u∆ock_∑ge
(
∑ges
[
i
]);

116 
	`put_∑ge
(
∑ges
[
i
]);

118 
	}
}

127 
	$båfs_dúty_∑ges
(
båfs_öode
 *
öode
, 
∑ge
 **
∑ges
,

128 
size_t
 
num_∑ges
, 
loff_t
 
pos
, size_à
wrôe_byãs
,

129 
exã¡_°©e
 **
ˇched
, 
boﬁ
 
n‹e£rve
)

131 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

132 
îr
 = 0;

133 
i
;

134 
u64
 
num_byãs
;

135 
u64
 
°¨t_pos
;

136 
u64
 
íd_of_œ°_block
;

137 
u64
 
íd_pos
 = 
pos
 + 
wrôe_byãs
;

138 
loff_t
 
isize
 = 
	`i_size_ªad
(&
öode
->
vfs_öode
);

139 
exåa_bôs
 = 0;

141 i‡(
wrôe_byãs
 == 0)

144 i‡(
n‹e£rve
)

145 
exåa_bôs
 |
EXTENT_NORESERVE
;

147 
°¨t_pos
 = 
	`round_down
(
pos
, 
fs_öfo
->
£˘‹size
);

148 
num_byãs
 = 
	`round_up
(
wrôe_byãs
 + 
pos
 - 
°¨t_pos
,

149 
fs_öfo
->
£˘‹size
);

150 
	`ASSERT
(
num_byãs
 <
U32_MAX
);

152 
íd_of_œ°_block
 = 
°¨t_pos
 + 
num_byãs
 - 1;

158 
	`˛ór_exã¡_bô
(&
öode
->
io_åì
, 
°¨t_pos
, 
íd_of_œ°_block
,

159 
EXTENT_DELALLOC
 | 
EXTENT_DO_ACCOUNTING
 | 
EXTENT_DEFRAG
,

160 
ˇched
);

162 
îr
 = 
	`båfs_£t_exã¡_dñÆloc
(
öode
, 
°¨t_pos
, 
íd_of_œ°_block
,

163 
exåa_bôs
, 
ˇched
);

164 i‡(
îr
)

165  
îr
;

167 
i
 = 0; i < 
num_∑ges
; i++) {

168 
∑ge
 *
p
 = 
∑ges
[
i
];

170 
	`båfs_∑ge_˛amp_£t_u±od©e
(
fs_öfo
, 
p
, 
°¨t_pos
, 
num_byãs
);

171 
	`båfs_∑ge_˛amp_˛ór_checked
(
fs_öfo
, 
p
, 
°¨t_pos
, 
num_byãs
);

172 
	`båfs_∑ge_˛amp_£t_dúty
(
fs_öfo
, 
p
, 
°¨t_pos
, 
num_byãs
);

180 i‡(
íd_pos
 > 
isize
)

181 
	`i_size_wrôe
(&
öode
->
vfs_öode
, 
íd_pos
);

183 
	}
}

200 
	$båfs_dr›_exã¡s
(
båfs_å™s_h™dÀ
 *
å™s
,

201 
båfs_roŸ
 *
roŸ
, 
båfs_öode
 *
öode
,

202 
båfs_dr›_exã¡s_¨gs
 *
¨gs
)

204 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

205 
exã¡_buf„r
 *
Àaf
;

206 
båfs_fûe_exã¡_ôem
 *
fi
;

207 
båfs_ªf
 
ªf
 = { 0 };

208 
båfs_key
 
key
;

209 
båfs_key
 
√w_key
;

210 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

211 
u64
 
£¨ch_°¨t
 = 
¨gs
->
°¨t
;

212 
u64
 
disk_byãƒ
 = 0;

213 
u64
 
num_byãs
 = 0;

214 
u64
 
exã¡_off£t
 = 0;

215 
u64
 
exã¡_íd
 = 0;

216 
u64
 
œ°_íd
 = 
¨gs
->
°¨t
;

217 
dñ_ƒ
 = 0;

218 
dñ_¶Ÿ
 = 0;

219 
exã¡_ty≥
;

220 
ªcow
;

221 
ªt
;

222 
modify_åì
 = -1;

223 
upd©e_ªfs
;

224 
found
 = 0;

225 
båfs_∑th
 *
∑th
 = 
¨gs
->path;

227 
¨gs
->
byãs_found
 = 0;

228 
¨gs
->
exã¡_ö£πed
 = 
Ál£
;

231 
	`ASSERT
(!(
¨gs
->
ª∂a˚_exã¡
 && !¨gs->
∑th
));

233 i‡(!
∑th
) {

234 
∑th
 = 
	`båfs_Æloc_∑th
();

235 i‡(!
∑th
) {

236 
ªt
 = -
ENOMEM
;

237 
out
;

241 i‡(
¨gs
->
dr›_ˇche
)

242 
	`båfs_dr›_exã¡_m≠_ønge
(
öode
, 
¨gs
->
°¨t
,árgs->
íd
 - 1, 
Ál£
);

244 i‡(
¨gs
->
°¨t
 >
öode
->
disk_i_size
 && !¨gs->
ª∂a˚_exã¡
)

245 
modify_åì
 = 0;

247 
upd©e_ªfs
 = (
roŸ
->
roŸ_key
.
obje˘id
 !
BTRFS_TREE_LOG_OBJECTID
);

249 
ªcow
 = 0;

250 
ªt
 = 
	`båfs_lookup_fûe_exã¡
(
å™s
, 
roŸ
, 
∑th
, 
öo
,

251 
£¨ch_°¨t
, 
modify_åì
);

252 i‡(
ªt
 < 0)

254 i‡(
ªt
 > 0 && 
∑th
->
¶Ÿs
[0] > 0 && 
£¨ch_°¨t
 =
¨gs
->
°¨t
) {

255 
Àaf
 = 
∑th
->
nodes
[0];

256 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0] - 1);

257 i‡(
key
.
obje˘id
 =
öo
 &&

258 
key
.
ty≥
 =
BTRFS_EXTENT_DATA_KEY
)

259 
∑th
->
¶Ÿs
[0]--;

261 
ªt
 = 0;

262 
√xt_¶Ÿ
:

263 
Àaf
 = 
∑th
->
nodes
[0];

264 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
(
Àaf
)) {

265 
	`BUG_ON
(
dñ_ƒ
 > 0);

266 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

267 i‡(
ªt
 < 0)

269 i‡(
ªt
 > 0) {

270 
ªt
 = 0;

273 
Àaf
 = 
∑th
->
nodes
[0];

274 
ªcow
 = 1;

277 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

279 i‡(
key
.
obje˘id
 > 
öo
)

281 i‡(
	`WARN_ON_ONCE
(
key
.
obje˘id
 < 
öo
) ||

282 
key
.
ty≥
 < 
BTRFS_EXTENT_DATA_KEY
) {

283 
	`ASSERT
(
dñ_ƒ
 == 0);

284 
∑th
->
¶Ÿs
[0]++;

285 
√xt_¶Ÿ
;

287 i‡(
key
.
ty≥
 > 
BTRFS_EXTENT_DATA_KEY
 || key.
off£t
 >
¨gs
->
íd
)

290 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

291 
båfs_fûe_exã¡_ôem
);

292 
exã¡_ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
fi
);

294 i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_REG
 ||

295 
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
) {

296 
disk_byãƒ
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
fi
);

297 
num_byãs
 = 
	`båfs_fûe_exã¡_disk_num_byãs
(
Àaf
, 
fi
);

298 
exã¡_off£t
 = 
	`båfs_fûe_exã¡_off£t
(
Àaf
, 
fi
);

299 
exã¡_íd
 = 
key
.
off£t
 +

300 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
fi
);

301 } i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
) {

302 
exã¡_íd
 = 
key
.
off£t
 +

303 
	`båfs_fûe_exã¡_øm_byãs
(
Àaf
, 
fi
);

306 
	`BUG
();

318 i‡(
exã¡_íd
 =
key
.
off£t
 &&Éxã¡_íd >
£¨ch_°¨t
) {

319 
œ°_íd
 = 
exã¡_íd
;

320 
dñëe_exã¡_ôem
;

323 i‡(
exã¡_íd
 <
£¨ch_°¨t
) {

324 
∑th
->
¶Ÿs
[0]++;

325 
√xt_¶Ÿ
;

328 
found
 = 1;

329 
£¨ch_°¨t
 = 
	`max
(
key
.
off£t
, 
¨gs
->
°¨t
);

330 i‡(
ªcow
 || !
modify_åì
) {

331 
modify_åì
 = -1;

332 
	`båfs_ªÀa£_∑th
(
∑th
);

340 i‡(
¨gs
->
°¨t
 > 
key
.
off£t
 &&árgs->
íd
 < 
exã¡_íd
) {

341 
	`BUG_ON
(
dñ_ƒ
 > 0);

342 i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
) {

343 
ªt
 = -
EOPNOTSUPP
;

347 
	`mem˝y
(&
√w_key
, &
key
, (new_key));

348 
√w_key
.
off£t
 = 
¨gs
->
°¨t
;

349 
ªt
 = 
	`båfs_du∂iˇã_ôem
(
å™s
, 
roŸ
, 
∑th
,

350 &
√w_key
);

351 i‡(
ªt
 =-
EAGAIN
) {

352 
	`båfs_ªÀa£_∑th
(
∑th
);

355 i‡(
ªt
 < 0)

358 
Àaf
 = 
∑th
->
nodes
[0];

359 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0] - 1,

360 
båfs_fûe_exã¡_ôem
);

361 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
fi
,

362 
¨gs
->
°¨t
 - 
key
.
off£t
);

364 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

365 
båfs_fûe_exã¡_ôem
);

367 
exã¡_off£t
 +
¨gs
->
°¨t
 - 
key
.
off£t
;

368 
	`båfs_£t_fûe_exã¡_off£t
(
Àaf
, 
fi
, 
exã¡_off£t
);

369 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
fi
,

370 
exã¡_íd
 - 
¨gs
->
°¨t
);

371 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

373 i‡(
upd©e_ªfs
 && 
disk_byãƒ
 > 0) {

374 
	`båfs_öô_gíîic_ªf
(&
ªf
,

375 
BTRFS_ADD_DELAYED_REF
,

376 
disk_byãƒ
, 
num_byãs
, 0);

377 
	`båfs_öô_d©a_ªf
(&
ªf
,

378 
roŸ
->
roŸ_key
.
obje˘id
,

379 
√w_key
.
obje˘id
,

380 
¨gs
->
°¨t
 - 
exã¡_off£t
,

381 0, 
Ál£
);

382 
ªt
 = 
	`båfs_öc_exã¡_ªf
(
å™s
, &
ªf
);

383 i‡(
ªt
) {

384 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

388 
key
.
off£t
 = 
¨gs
->
°¨t
;

394 
œ°_íd
 = 
exã¡_íd
;

400 i‡(
¨gs
->
°¨t
 <
key
.
off£t
 &&árgs->
íd
 < 
exã¡_íd
) {

401 i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
) {

402 
ªt
 = -
EOPNOTSUPP
;

406 
	`mem˝y
(&
√w_key
, &
key
, (new_key));

407 
√w_key
.
off£t
 = 
¨gs
->
íd
;

408 
	`båfs_£t_ôem_key_ß„
(
å™s
, 
∑th
, &
√w_key
);

410 
exã¡_off£t
 +
¨gs
->
íd
 - 
key
.
off£t
;

411 
	`båfs_£t_fûe_exã¡_off£t
(
Àaf
, 
fi
, 
exã¡_off£t
);

412 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
fi
,

413 
exã¡_íd
 - 
¨gs
->
íd
);

414 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

415 i‡(
upd©e_ªfs
 && 
disk_byãƒ
 > 0)

416 
¨gs
->
byãs_found
 +¨gs->
íd
 - 
key
.
off£t
;

420 
£¨ch_°¨t
 = 
exã¡_íd
;

425 i‡(
¨gs
->
°¨t
 > 
key
.
off£t
 &&árgs->
íd
 >
exã¡_íd
) {

426 
	`BUG_ON
(
dñ_ƒ
 > 0);

427 i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
) {

428 
ªt
 = -
EOPNOTSUPP
;

432 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
fi
,

433 
¨gs
->
°¨t
 - 
key
.
off£t
);

434 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

435 i‡(
upd©e_ªfs
 && 
disk_byãƒ
 > 0)

436 
¨gs
->
byãs_found
 +
exã¡_íd
 -árgs->
°¨t
;

437 i‡(
¨gs
->
íd
 =
exã¡_íd
)

440 
∑th
->
¶Ÿs
[0]++;

441 
√xt_¶Ÿ
;

448 i‡(
¨gs
->
°¨t
 <
key
.
off£t
 &&árgs->
íd
 >
exã¡_íd
) {

449 
dñëe_exã¡_ôem
:

450 i‡(
dñ_ƒ
 == 0) {

451 
dñ_¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

452 
dñ_ƒ
 = 1;

454 
	`BUG_ON
(
dñ_¶Ÿ
 + 
dñ_ƒ
 !
∑th
->
¶Ÿs
[0]);

455 
dñ_ƒ
++;

458 i‡(
upd©e_ªfs
 &&

459 
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
) {

460 
¨gs
->
byãs_found
 +
exã¡_íd
 - 
key
.
off£t
;

461 
exã¡_íd
 = 
	`ALIGN
(extent_end,

462 
fs_öfo
->
£˘‹size
);

463 } i‡(
upd©e_ªfs
 && 
disk_byãƒ
 > 0) {

464 
	`båfs_öô_gíîic_ªf
(&
ªf
,

465 
BTRFS_DROP_DELAYED_REF
,

466 
disk_byãƒ
, 
num_byãs
, 0);

467 
	`båfs_öô_d©a_ªf
(&
ªf
,

468 
roŸ
->
roŸ_key
.
obje˘id
,

469 
key
.
obje˘id
,

470 
key
.
off£t
 - 
exã¡_off£t
, 0,

471 
Ál£
);

472 
ªt
 = 
	`båfs_‰ì_exã¡
(
å™s
, &
ªf
);

473 i‡(
ªt
) {

474 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

477 
¨gs
->
byãs_found
 +
exã¡_íd
 - 
key
.
off£t
;

480 i‡(
¨gs
->
íd
 =
exã¡_íd
)

483 i‡(
∑th
->
¶Ÿs
[0] + 1 < 
	`båfs_hódî_ƒôems
(
Àaf
)) {

484 
∑th
->
¶Ÿs
[0]++;

485 
√xt_¶Ÿ
;

488 
ªt
 = 
	`båfs_dñ_ôems
(
å™s
, 
roŸ
, 
∑th
, 
dñ_¶Ÿ
,

489 
dñ_ƒ
);

490 i‡(
ªt
) {

491 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

495 
dñ_ƒ
 = 0;

496 
dñ_¶Ÿ
 = 0;

498 
	`båfs_ªÀa£_∑th
(
∑th
);

502 
	`BUG
();

505 i‡(!
ªt
 && 
dñ_ƒ
 > 0) {

512 
∑th
->
¶Ÿs
[0] = 
dñ_¶Ÿ
;

513 
ªt
 = 
	`båfs_dñ_ôems
(
å™s
, 
roŸ
, 
∑th
, 
dñ_¶Ÿ
, 
dñ_ƒ
);

514 i‡(
ªt
)

515 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

518 
Àaf
 = 
∑th
->
nodes
[0];

524 i‡(!
ªt
 && 
¨gs
->
ª∂a˚_exã¡
 &&

525 
∑th
->
locks
[0] =
BTRFS_WRITE_LOCK
 &&

526 
	`båfs_Àaf_‰ì_•a˚
(
Àaf
) >=

527 (
båfs_ôem
Ë+ 
¨gs
->
exã¡_ôem_size
) {

529 
key
.
obje˘id
 = 
öo
;

530 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

531 
key
.
off£t
 = 
¨gs
->
°¨t
;

532 i‡(!
dñ_ƒ
 && 
∑th
->
¶Ÿs
[0] < 
	`båfs_hódî_ƒôems
(
Àaf
)) {

533 
båfs_key
 
¶Ÿ_key
;

535 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
¶Ÿ_key
, 
∑th
->
¶Ÿs
[0]);

536 i‡(
	`båfs_comp_˝u_keys
(&
key
, &
¶Ÿ_key
) > 0)

537 
∑th
->
¶Ÿs
[0]++;

539 
	`båfs_£tup_ôem_f‹_ö£π
(
å™s
, 
roŸ
, 
∑th
, &
key
,

540 
¨gs
->
exã¡_ôem_size
);

541 
¨gs
->
exã¡_ö£πed
 = 
åue
;

544 i‡(!
¨gs
->
∑th
)

545 
	`båfs_‰ì_∑th
(
∑th
);

546 i‡(!
¨gs
->
exã¡_ö£πed
)

547 
	`båfs_ªÀa£_∑th
(
∑th
);

548 
out
:

549 
¨gs
->
dr›_íd
 = 
found
 ? 
	`mö
◊rgs->
íd
, 
œ°_íd
) :árgs->end;

551  
ªt
;

552 
	}
}

554 
	$exã¡_mîgóbÀ
(
exã¡_buf„r
 *
Àaf
, 
¶Ÿ
,

555 
u64
 
obje˘id
, u64 
byãƒ
, u64 
‹ig_off£t
,

556 
u64
 *
°¨t
, u64 *
íd
)

558 
båfs_fûe_exã¡_ôem
 *
fi
;

559 
båfs_key
 
key
;

560 
u64
 
exã¡_íd
;

562 i‡(
¶Ÿ
 < 0 || slŸ >
	`båfs_hódî_ƒôems
(
Àaf
))

565 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

566 i‡(
key
.
obje˘id
 !obje˘id || key.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

569 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_fûe_exã¡_ôem
);

570 i‡(
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
fi
Ë!
BTRFS_FILE_EXTENT_REG
 ||

571 
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
fi
Ë!
byãƒ
 ||

572 
	`båfs_fûe_exã¡_off£t
(
Àaf
, 
fi
Ë!
key
.
off£t
 - 
‹ig_off£t
 ||

573 
	`båfs_fûe_exã¡_com¥essi⁄
(
Àaf
, 
fi
) ||

574 
	`båfs_fûe_exã¡_í¸y±i⁄
(
Àaf
, 
fi
) ||

575 
	`båfs_fûe_exã¡_Ÿhî_ícodög
(
Àaf
, 
fi
))

578 
exã¡_íd
 = 
key
.
off£t
 + 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
fi
);

579 i‡((*
°¨t
 && *°¨à!
key
.
off£t
Ë|| (*
íd
 && *íd !
exã¡_íd
))

582 *
°¨t
 = 
key
.
off£t
;

583 *
íd
 = 
exã¡_íd
;

585 
	}
}

594 
	$båfs_m¨k_exã¡_wrôãn
(
båfs_å™s_h™dÀ
 *
å™s
,

595 
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
)

597 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

598 
exã¡_buf„r
 *
Àaf
;

599 
båfs_∑th
 *
∑th
;

600 
båfs_fûe_exã¡_ôem
 *
fi
;

601 
båfs_ªf
 
ªf
 = { 0 };

602 
båfs_key
 
key
;

603 
båfs_key
 
√w_key
;

604 
u64
 
byãƒ
;

605 
u64
 
num_byãs
;

606 
u64
 
exã¡_íd
;

607 
u64
 
‹ig_off£t
;

608 
u64
 
Ÿhî_°¨t
;

609 
u64
 
Ÿhî_íd
;

610 
u64
 
•lô
;

611 
dñ_ƒ
 = 0;

612 
dñ_¶Ÿ
 = 0;

613 
ªcow
;

614 
ªt
 = 0;

615 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

617 
∑th
 = 
	`båfs_Æloc_∑th
();

618 i‡(!
∑th
)

619  -
ENOMEM
;

620 
agaö
:

621 
ªcow
 = 0;

622 
•lô
 = 
°¨t
;

623 
key
.
obje˘id
 = 
öo
;

624 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

625 
key
.
off£t
 = 
•lô
;

627 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

628 i‡(
ªt
 < 0)

629 
out
;

630 i‡(
ªt
 > 0 && 
∑th
->
¶Ÿs
[0] > 0)

631 
∑th
->
¶Ÿs
[0]--;

633 
Àaf
 = 
∑th
->
nodes
[0];

634 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

635 i‡(
key
.
obje˘id
 !
öo
 ||

636 
key
.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
) {

637 
ªt
 = -
EINVAL
;

638 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

639 
out
;

641 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

642 
båfs_fûe_exã¡_ôem
);

643 i‡(
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
fi
Ë!
BTRFS_FILE_EXTENT_PREALLOC
) {

644 
ªt
 = -
EINVAL
;

645 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

646 
out
;

648 
exã¡_íd
 = 
key
.
off£t
 + 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
fi
);

649 i‡(
key
.
off£t
 > 
°¨t
 || 
exã¡_íd
 < 
íd
) {

650 
ªt
 = -
EINVAL
;

651 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

652 
out
;

655 
byãƒ
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
fi
);

656 
num_byãs
 = 
	`båfs_fûe_exã¡_disk_num_byãs
(
Àaf
, 
fi
);

657 
‹ig_off£t
 = 
key
.
off£t
 - 
	`båfs_fûe_exã¡_off£t
(
Àaf
, 
fi
);

658 
	`mem˝y
(&
√w_key
, &
key
, (new_key));

660 i‡(
°¨t
 =
key
.
off£t
 && 
íd
 < 
exã¡_íd
) {

661 
Ÿhî_°¨t
 = 0;

662 
Ÿhî_íd
 = 
°¨t
;

663 i‡(
	`exã¡_mîgóbÀ
(
Àaf
, 
∑th
->
¶Ÿs
[0] - 1,

664 
öo
, 
byãƒ
, 
‹ig_off£t
,

665 &
Ÿhî_°¨t
, &
Ÿhî_íd
)) {

666 
√w_key
.
off£t
 = 
íd
;

667 
	`båfs_£t_ôem_key_ß„
(
å™s
, 
∑th
, &
√w_key
);

668 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

669 
båfs_fûe_exã¡_ôem
);

670 
	`båfs_£t_fûe_exã¡_gíî©i⁄
(
Àaf
, 
fi
,

671 
å™s
->
å™sid
);

672 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
fi
,

673 
exã¡_íd
 - 
íd
);

674 
	`båfs_£t_fûe_exã¡_off£t
(
Àaf
, 
fi
,

675 
íd
 - 
‹ig_off£t
);

676 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0] - 1,

677 
båfs_fûe_exã¡_ôem
);

678 
	`båfs_£t_fûe_exã¡_gíî©i⁄
(
Àaf
, 
fi
,

679 
å™s
->
å™sid
);

680 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
fi
,

681 
íd
 - 
Ÿhî_°¨t
);

682 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

683 
out
;

687 i‡(
°¨t
 > 
key
.
off£t
 && 
íd
 =
exã¡_íd
) {

688 
Ÿhî_°¨t
 = 
íd
;

689 
Ÿhî_íd
 = 0;

690 i‡(
	`exã¡_mîgóbÀ
(
Àaf
, 
∑th
->
¶Ÿs
[0] + 1,

691 
öo
, 
byãƒ
, 
‹ig_off£t
,

692 &
Ÿhî_°¨t
, &
Ÿhî_íd
)) {

693 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

694 
båfs_fûe_exã¡_ôem
);

695 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
fi
,

696 
°¨t
 - 
key
.
off£t
);

697 
	`båfs_£t_fûe_exã¡_gíî©i⁄
(
Àaf
, 
fi
,

698 
å™s
->
å™sid
);

699 
∑th
->
¶Ÿs
[0]++;

700 
√w_key
.
off£t
 = 
°¨t
;

701 
	`båfs_£t_ôem_key_ß„
(
å™s
, 
∑th
, &
√w_key
);

703 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

704 
båfs_fûe_exã¡_ôem
);

705 
	`båfs_£t_fûe_exã¡_gíî©i⁄
(
Àaf
, 
fi
,

706 
å™s
->
å™sid
);

707 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
fi
,

708 
Ÿhî_íd
 - 
°¨t
);

709 
	`båfs_£t_fûe_exã¡_off£t
(
Àaf
, 
fi
,

710 
°¨t
 - 
‹ig_off£t
);

711 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

712 
out
;

716 
°¨t
 > 
key
.
off£t
 || 
íd
 < 
exã¡_íd
) {

717 i‡(
key
.
off£t
 =
°¨t
)

718 
•lô
 = 
íd
;

720 
√w_key
.
off£t
 = 
•lô
;

721 
ªt
 = 
	`båfs_du∂iˇã_ôem
(
å™s
, 
roŸ
, 
∑th
, &
√w_key
);

722 i‡(
ªt
 =-
EAGAIN
) {

723 
	`båfs_ªÀa£_∑th
(
∑th
);

724 
agaö
;

726 i‡(
ªt
 < 0) {

727 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

728 
out
;

731 
Àaf
 = 
∑th
->
nodes
[0];

732 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0] - 1,

733 
båfs_fûe_exã¡_ôem
);

734 
	`båfs_£t_fûe_exã¡_gíî©i⁄
(
Àaf
, 
fi
, 
å™s
->
å™sid
);

735 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
fi
,

736 
•lô
 - 
key
.
off£t
);

738 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

739 
båfs_fûe_exã¡_ôem
);

741 
	`båfs_£t_fûe_exã¡_gíî©i⁄
(
Àaf
, 
fi
, 
å™s
->
å™sid
);

742 
	`båfs_£t_fûe_exã¡_off£t
(
Àaf
, 
fi
, 
•lô
 - 
‹ig_off£t
);

743 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
fi
,

744 
exã¡_íd
 - 
•lô
);

745 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

747 
	`båfs_öô_gíîic_ªf
(&
ªf
, 
BTRFS_ADD_DELAYED_REF
, 
byãƒ
,

748 
num_byãs
, 0);

749 
	`båfs_öô_d©a_ªf
(&
ªf
, 
roŸ
->
roŸ_key
.
obje˘id
, 
öo
,

750 
‹ig_off£t
, 0, 
Ál£
);

751 
ªt
 = 
	`båfs_öc_exã¡_ªf
(
å™s
, &
ªf
);

752 i‡(
ªt
) {

753 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

754 
out
;

757 i‡(
•lô
 =
°¨t
) {

758 
key
.
off£t
 = 
°¨t
;

760 i‡(
°¨t
 !
key
.
off£t
) {

761 
ªt
 = -
EINVAL
;

762 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

763 
out
;

765 
∑th
->
¶Ÿs
[0]--;

766 
exã¡_íd
 = 
íd
;

768 
ªcow
 = 1;

771 
Ÿhî_°¨t
 = 
íd
;

772 
Ÿhî_íd
 = 0;

773 
	`båfs_öô_gíîic_ªf
(&
ªf
, 
BTRFS_DROP_DELAYED_REF
, 
byãƒ
,

774 
num_byãs
, 0);

775 
	`båfs_öô_d©a_ªf
(&
ªf
, 
roŸ
->
roŸ_key
.
obje˘id
, 
öo
, 
‹ig_off£t
,

776 0, 
Ál£
);

777 i‡(
	`exã¡_mîgóbÀ
(
Àaf
, 
∑th
->
¶Ÿs
[0] + 1,

778 
öo
, 
byãƒ
, 
‹ig_off£t
,

779 &
Ÿhî_°¨t
, &
Ÿhî_íd
)) {

780 i‡(
ªcow
) {

781 
	`båfs_ªÀa£_∑th
(
∑th
);

782 
agaö
;

784 
exã¡_íd
 = 
Ÿhî_íd
;

785 
dñ_¶Ÿ
 = 
∑th
->
¶Ÿs
[0] + 1;

786 
dñ_ƒ
++;

787 
ªt
 = 
	`båfs_‰ì_exã¡
(
å™s
, &
ªf
);

788 i‡(
ªt
) {

789 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

790 
out
;

793 
Ÿhî_°¨t
 = 0;

794 
Ÿhî_íd
 = 
°¨t
;

795 i‡(
	`exã¡_mîgóbÀ
(
Àaf
, 
∑th
->
¶Ÿs
[0] - 1,

796 
öo
, 
byãƒ
, 
‹ig_off£t
,

797 &
Ÿhî_°¨t
, &
Ÿhî_íd
)) {

798 i‡(
ªcow
) {

799 
	`båfs_ªÀa£_∑th
(
∑th
);

800 
agaö
;

802 
key
.
off£t
 = 
Ÿhî_°¨t
;

803 
dñ_¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

804 
dñ_ƒ
++;

805 
ªt
 = 
	`båfs_‰ì_exã¡
(
å™s
, &
ªf
);

806 i‡(
ªt
) {

807 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

808 
out
;

811 i‡(
dñ_ƒ
 == 0) {

812 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

813 
båfs_fûe_exã¡_ôem
);

814 
	`båfs_£t_fûe_exã¡_ty≥
(
Àaf
, 
fi
,

815 
BTRFS_FILE_EXTENT_REG
);

816 
	`båfs_£t_fûe_exã¡_gíî©i⁄
(
Àaf
, 
fi
, 
å™s
->
å™sid
);

817 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

819 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
dñ_¶Ÿ
 - 1,

820 
båfs_fûe_exã¡_ôem
);

821 
	`båfs_£t_fûe_exã¡_ty≥
(
Àaf
, 
fi
,

822 
BTRFS_FILE_EXTENT_REG
);

823 
	`båfs_£t_fûe_exã¡_gíî©i⁄
(
Àaf
, 
fi
, 
å™s
->
å™sid
);

824 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
fi
,

825 
exã¡_íd
 - 
key
.
off£t
);

826 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

828 
ªt
 = 
	`båfs_dñ_ôems
(
å™s
, 
roŸ
, 
∑th
, 
dñ_¶Ÿ
, 
dñ_ƒ
);

829 i‡(
ªt
 < 0) {

830 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

831 
out
;

834 
out
:

835 
	`båfs_‰ì_∑th
(
∑th
);

836  
ªt
;

837 
	}
}

843 
	$¥ï¨e_u±od©e_∑ge
(
öode
 *inode,

844 
∑ge
 *∑ge, 
u64
 
pos
,

845 
boﬁ
 
f‹˚_u±od©e
)

847 
fﬁio
 *fﬁiÿ
	`∑ge_fﬁio
(
∑ge
);

848 
ªt
 = 0;

850 i‡(((
pos
 & (
PAGE_SIZE
 - 1)Ë|| 
f‹˚_u±od©e
) &&

851 !
	`PageU±od©e
(
∑ge
)) {

852 
ªt
 = 
	`båfs_ªad_fﬁio
(
NULL
, 
fﬁio
);

853 i‡(
ªt
)

854  
ªt
;

855 
	`lock_∑ge
(
∑ge
);

856 i‡(!
	`PageU±od©e
(
∑ge
)) {

857 
	`u∆ock_∑ge
(
∑ge
);

858  -
EIO
;

871 i‡(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
 || !
	`PagePriv©e
(page)) {

872 
	`u∆ock_∑ge
(
∑ge
);

873  -
EAGAIN
;

877 
	}
}

879 
fgf_t
 
	$gë_¥ï¨e_fgp_Êags
(
boﬁ
 
nowaô
)

881 
fgf_t
 
fgp_Êags
 = 
FGP_LOCK
 | 
FGP_ACCESSED
 | 
FGP_CREAT
;

883 i‡(
nowaô
)

884 
fgp_Êags
 |
FGP_NOWAIT
;

886  
fgp_Êags
;

887 
	}
}

889 
gÂ_t
 
	$gë_¥ï¨e_gÂ_Êags
(
öode
 *öode, 
boﬁ
 
nowaô
)

891 
gÂ_t
 
gÂ
;

893 
gÂ
 = 
	`båfs_Æloc_wrôe_mask
(
öode
->
i_m≠pög
);

894 i‡(
nowaô
) {

895 
gÂ
 &~
__GFP_DIRECT_RECLAIM
;

896 
gÂ
 |
GFP_NOWAIT
;

899  
gÂ
;

900 
	}
}

905 
noölöe
 
	$¥ï¨e_∑ges
(
öode
 *öode, 
∑ge
 **
∑ges
,

906 
size_t
 
num_∑ges
, 
loff_t
 
pos
,

907 
size_t
 
wrôe_byãs
, 
boﬁ
 
f‹˚_u±od©e
,

908 
boﬁ
 
nowaô
)

910 
i
;

911 
ödex
 = 
pos
 >> 
PAGE_SHIFT
;

912 
gÂ_t
 
mask
 = 
	`gë_¥ï¨e_gÂ_Êags
(
öode
, 
nowaô
);

913 
fgf_t
 
fgp_Êags
 = 
	`gë_¥ï¨e_fgp_Êags
(
nowaô
);

914 
îr
 = 0;

915 
Áûi
;

917 
i
 = 0; i < 
num_∑ges
; i++) {

918 
agaö
:

919 
∑ges
[
i
] = 
	`∑geˇche_gë_∑ge
(
öode
->
i_m≠pög
, 
ödex
 + i,

920 
fgp_Êags
, 
mask
 | 
__GFP_WRITE
);

921 i‡(!
∑ges
[
i
]) {

922 
Áûi
 = 
i
 - 1;

923 i‡(
nowaô
)

924 
îr
 = -
EAGAIN
;

926 
îr
 = -
ENOMEM
;

927 
Áû
;

930 
îr
 = 
	`£t_∑ge_exã¡_m≠≥d
(
∑ges
[
i
]);

931 i‡(
îr
 < 0) {

932 
Áûi
 = 
i
;

933 
Áû
;

936 i‡(
i
 == 0)

937 
îr
 = 
	`¥ï¨e_u±od©e_∑ge
(
öode
, 
∑ges
[
i
], 
pos
,

938 
f‹˚_u±od©e
);

939 i‡(!
îr
 && 
i
 =
num_∑ges
 - 1)

940 
îr
 = 
	`¥ï¨e_u±od©e_∑ge
(
öode
, 
∑ges
[
i
],

941 
pos
 + 
wrôe_byãs
, 
Ál£
);

942 i‡(
îr
) {

943 
	`put_∑ge
(
∑ges
[
i
]);

944 i‡(!
nowaô
 && 
îr
 =-
EAGAIN
) {

945 
îr
 = 0;

946 
agaö
;

948 
Áûi
 = 
i
 - 1;

949 
Áû
;

951 
	`waô_⁄_∑ge_wrôeback
(
∑ges
[
i
]);

955 
Áû
:

956 
Áûi
 >= 0) {

957 
	`u∆ock_∑ge
(
∑ges
[
Áûi
]);

958 
	`put_∑ge
(
∑ges
[
Áûi
]);

959 
Áûi
--;

961  
îr
;

963 
	}
}

975 
noölöe
 

976 
	$lock_™d_˛ónup_exã¡_if_√ed
(
båfs_öode
 *
öode
, 
∑ge
 **
∑ges
,

977 
size_t
 
num_∑ges
, 
loff_t
 
pos
,

978 
size_t
 
wrôe_byãs
,

979 
u64
 *
lock°¨t
, u64 *
lockíd
, 
boﬁ
 
nowaô
,

980 
exã¡_°©e
 **
ˇched_°©e
)

982 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

983 
u64
 
°¨t_pos
;

984 
u64
 
œ°_pos
;

985 
i
;

986 
ªt
 = 0;

988 
°¨t_pos
 = 
	`round_down
(
pos
, 
fs_öfo
->
£˘‹size
);

989 
œ°_pos
 = 
	`round_up
(
pos
 + 
wrôe_byãs
, 
fs_öfo
->
£˘‹size
) - 1;

991 i‡(
°¨t_pos
 < 
öode
->
vfs_öode
.
i_size
) {

992 
båfs_‹dîed_exã¡
 *
‹dîed
;

994 i‡(
nowaô
) {

995 i‡(!
	`åy_lock_exã¡
(&
öode
->
io_åì
, 
°¨t_pos
, 
œ°_pos
,

996 
ˇched_°©e
)) {

997 
i
 = 0; i < 
num_∑ges
; i++) {

998 
	`u∆ock_∑ge
(
∑ges
[
i
]);

999 
	`put_∑ge
(
∑ges
[
i
]);

1000 
∑ges
[
i
] = 
NULL
;

1003  -
EAGAIN
;

1006 
	`lock_exã¡
(&
öode
->
io_åì
, 
°¨t_pos
, 
œ°_pos
, 
ˇched_°©e
);

1009 
‹dîed
 = 
	`båfs_lookup_‹dîed_ønge
(
öode
, 
°¨t_pos
,

1010 
œ°_pos
 - 
°¨t_pos
 + 1);

1011 i‡(
‹dîed
 &&

1012 
‹dîed
->
fûe_off£t
 + ordîed->
num_byãs
 > 
°¨t_pos
 &&

1013 
‹dîed
->
fûe_off£t
 <
œ°_pos
) {

1014 
	`u∆ock_exã¡
(&
öode
->
io_åì
, 
°¨t_pos
, 
œ°_pos
,

1015 
ˇched_°©e
);

1016 
i
 = 0; i < 
num_∑ges
; i++) {

1017 
	`u∆ock_∑ge
(
∑ges
[
i
]);

1018 
	`put_∑ge
(
∑ges
[
i
]);

1020 
	`båfs_°¨t_‹dîed_exã¡
(
‹dîed
);

1021 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

1022  -
EAGAIN
;

1024 i‡(
‹dîed
)

1025 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

1027 *
lock°¨t
 = 
°¨t_pos
;

1028 *
lockíd
 = 
œ°_pos
;

1029 
ªt
 = 1;

1036 
i
 = 0; i < 
num_∑ges
; i++)

1037 
	`WARN_ON
(!
	`PageLocked
(
∑ges
[
i
]));

1039  
ªt
;

1040 
	}
}

1061 
	$båfs_check_nocow_lock
(
båfs_öode
 *
öode
, 
loff_t
 
pos
,

1062 
size_t
 *
wrôe_byãs
, 
boﬁ
 
nowaô
)

1064 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

1065 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

1066 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

1067 
u64
 
lock°¨t
, 
lockíd
;

1068 
u64
 
num_byãs
;

1069 
ªt
;

1071 i‡(!(
öode
->
Êags
 & (
BTRFS_INODE_NODATACOW
 | 
BTRFS_INODE_PREALLOC
)))

1074 i‡(!
	`båfs_dªw_åy_wrôe_lock
(&
roŸ
->
¢≠shŸ_lock
))

1075  -
EAGAIN
;

1077 
lock°¨t
 = 
	`round_down
(
pos
, 
fs_öfo
->
£˘‹size
);

1078 
lockíd
 = 
	`round_up
(
pos
 + *
wrôe_byãs
,

1079 
fs_öfo
->
£˘‹size
) - 1;

1080 
num_byãs
 = 
lockíd
 - 
lock°¨t
 + 1;

1082 i‡(
nowaô
) {

1083 i‡(!
	`båfs_åy_lock_‹dîed_ønge
(
öode
, 
lock°¨t
, 
lockíd
,

1084 &
ˇched_°©e
)) {

1085 
	`båfs_dªw_wrôe_u∆ock
(&
roŸ
->
¢≠shŸ_lock
);

1086  -
EAGAIN
;

1089 
	`båfs_lock_™d_Êush_‹dîed_ønge
(
öode
, 
lock°¨t
, 
lockíd
,

1090 &
ˇched_°©e
);

1092 
ªt
 = 
	`ˇn_nocow_exã¡
(&
öode
->
vfs_öode
, 
lock°¨t
, &
num_byãs
,

1093 
NULL
, NULL, NULL, 
nowaô
, 
Ál£
);

1094 i‡(
ªt
 <= 0)

1095 
	`båfs_dªw_wrôe_u∆ock
(&
roŸ
->
¢≠shŸ_lock
);

1097 *
wrôe_byãs
 = 
	`mö_t
(
size_t
, *write_bytes ,

1098 
num_byãs
 - 
pos
 + 
lock°¨t
);

1099 
	`u∆ock_exã¡
(&
öode
->
io_åì
, 
lock°¨t
, 
lockíd
, &
ˇched_°©e
);

1101  
ªt
;

1102 
	}
}

1104 
	$båfs_check_nocow_u∆ock
(
båfs_öode
 *
öode
)

1106 
	`båfs_dªw_wrôe_u∆ock
(&
öode
->
roŸ
->
¢≠shŸ_lock
);

1107 
	}
}

1109 
	$upd©e_time_f‹_wrôe
(
öode
 *inode)

1111 
time•ec64
 
now
, 
˘ime
;

1113 i‡(
	`IS_NOCMTIME
(
öode
))

1116 
now
 = 
	`cuºít_time
(
öode
);

1117 i‡(!
	`time•ec64_equÆ
(&
öode
->
i_mtime
, &
now
))

1118 
öode
->
i_mtime
 = 
now
;

1120 
˘ime
 = 
	`öode_gë_˘ime
(
öode
);

1121 i‡(!
	`time•ec64_equÆ
(&
˘ime
, &
now
))

1122 
	`öode_£t_˘ime_to_ts
(
öode
, 
now
);

1124 i‡(
	`IS_I_VERSION
(
öode
))

1125 
	`öode_öc_ivîsi⁄
(
öode
);

1126 
	}
}

1128 
	$båfs_wrôe_check
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
,

1129 
size_t
 
cou¡
)

1131 
fûe
 *fûê
iocb
->
ki_fûp
;

1132 
öode
 *öodê
	`fûe_öode
(
fûe
);

1133 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

1134 
loff_t
 
pos
 = 
iocb
->
ki_pos
;

1135 
ªt
;

1136 
loff_t
 
ﬁdsize
;

1137 
loff_t
 
°¨t_pos
;

1145 i‡((
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) &&

1146 !(
	`BTRFS_I
(
öode
)->
Êags
 & (
BTRFS_INODE_NODATACOW
 | 
BTRFS_INODE_PREALLOC
)))

1147  -
EAGAIN
;

1149 
ªt
 = 
	`fûe_ªmove_¥ivs
(
fûe
);

1150 i‡(
ªt
)

1151  
ªt
;

1159 
	`upd©e_time_f‹_wrôe
(
öode
);

1161 
°¨t_pos
 = 
	`round_down
(
pos
, 
fs_öfo
->
£˘‹size
);

1162 
ﬁdsize
 = 
	`i_size_ªad
(
öode
);

1163 i‡(
°¨t_pos
 > 
ﬁdsize
) {

1165 
loff_t
 
íd_pos
 = 
	`round_up
(
pos
 + 
cou¡
, 
fs_öfo
->
£˘‹size
);

1167 
ªt
 = 
	`båfs_c⁄t_ex∑nd
(
	`BTRFS_I
(
öode
), 
ﬁdsize
, 
íd_pos
);

1168 i‡(
ªt
)

1169  
ªt
;

1173 
	}
}

1175 
noölöe
 
ssize_t
 
	$båfs_buf„ªd_wrôe
(
kiocb
 *
iocb
,

1176 
iov_ôî
 *
i
)

1178 
fûe
 *fûê
iocb
->
ki_fûp
;

1179 
loff_t
 
pos
;

1180 
öode
 *öodê
	`fûe_öode
(
fûe
);

1181 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

1182 
∑ge
 **
∑ges
 = 
NULL
;

1183 
exã¡_ch™ge£t
 *
d©a_ª£rved
 = 
NULL
;

1184 
u64
 
ªÀa£_byãs
 = 0;

1185 
u64
 
lock°¨t
;

1186 
u64
 
lockíd
;

1187 
size_t
 
num_wrôãn
 = 0;

1188 
ƒ±rs
;

1189 
ssize_t
 
ªt
;

1190 
boﬁ
 
⁄ly_ªÀa£_mëad©a
 = 
Ál£
;

1191 
boﬁ
 
f‹˚_∑ge_u±od©e
 = 
Ál£
;

1192 
loff_t
 
ﬁd_isize
 = 
	`i_size_ªad
(
öode
);

1193 
ûock_Êags
 = 0;

1194 c⁄° 
boﬁ
 
nowaô
 = (
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
);

1195 
bdp_Êags
 = (
nowaô
 ? 
BDP_ASYNC
 : 0);

1197 i‡(
nowaô
)

1198 
ûock_Êags
 |
BTRFS_ILOCK_TRY
;

1201 
ªt
 = 
	`båfs_öode_lock
(
	`BTRFS_I
(
öode
), 
ûock_Êags
);

1202 i‡(
ªt
 < 0)

1203  
ªt
;

1213 
ªt
 = 
	`gíîic_wrôe_checks
(
iocb
, 
i
);

1214 i‡(
ªt
 <= 0)

1215 
out
;

1217 
ªt
 = 
	`båfs_wrôe_check
(
iocb
, 
i
,Ñet);

1218 i‡(
ªt
 < 0)

1219 
out
;

1221 
pos
 = 
iocb
->
ki_pos
;

1222 
ƒ±rs
 = 
	`mö
(
	`DIV_ROUND_UP
(
	`iov_ôî_cou¡
(
i
), 
PAGE_SIZE
),

1223 
PAGE_SIZE
 / ((
∑ge
 *)));

1224 
ƒ±rs
 = 
	`mö
“Ωås, 
cuºít
->
ƒ_dútõd_∑u£
 - cuºít->
ƒ_dútõd
);

1225 
ƒ±rs
 = 
	`max
(nrptrs, 8);

1226 
∑ges
 = 
	`kmÆloc_¨øy
(
ƒ±rs
, (
∑ge
 *), 
GFP_KERNEL
);

1227 i‡(!
∑ges
) {

1228 
ªt
 = -
ENOMEM
;

1229 
out
;

1232 
	`iov_ôî_cou¡
(
i
) > 0) {

1233 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

1234 
size_t
 
off£t
 = 
	`off£t_ö_∑ge
(
pos
);

1235 
size_t
 
£˘‹_off£t
;

1236 
size_t
 
wrôe_byãs
 = 
	`mö
(
	`iov_ôî_cou¡
(
i
),

1237 
ƒ±rs
 * (
size_t
)
PAGE_SIZE
 -

1238 
off£t
);

1239 
size_t
 
num_∑ges
;

1240 
size_t
 
ª£rve_byãs
;

1241 
size_t
 
dúty_∑ges
;

1242 
size_t
 
c›õd
;

1243 
size_t
 
dúty_£˘‹s
;

1244 
size_t
 
num_£˘‹s
;

1245 
exã¡s_locked
;

1251 i‡(
	`u∆ikñy
(
	`Áu…_ö_iov_ôî_ªadabÀ
(
i
, 
wrôe_byãs
))) {

1252 
ªt
 = -
EFAULT
;

1256 
⁄ly_ªÀa£_mëad©a
 = 
Ál£
;

1257 
£˘‹_off£t
 = 
pos
 & (
fs_öfo
->
£˘‹size
 - 1);

1259 
	`exã¡_ch™ge£t_ªÀa£
(
d©a_ª£rved
);

1260 
ªt
 = 
	`båfs_check_d©a_‰ì_•a˚
(
	`BTRFS_I
(
öode
),

1261 &
d©a_ª£rved
, 
pos
,

1262 
wrôe_byãs
, 
nowaô
);

1263 i‡(
ªt
 < 0) {

1264 
ˇn_nocow
;

1266 i‡(
nowaô
 && (
ªt
 =-
ENOSPC
 ||Ñë =-
EAGAIN
)) {

1267 
ªt
 = -
EAGAIN
;

1276 
ˇn_nocow
 = 
	`båfs_check_nocow_lock
(
	`BTRFS_I
(
öode
), 
pos
,

1277 &
wrôe_byãs
, 
nowaô
);

1278 i‡(
ˇn_nocow
 < 0)

1279 
ªt
 = 
ˇn_nocow
;

1280 i‡(
ˇn_nocow
 > 0)

1281 
ªt
 = 0;

1282 i‡(
ªt
)

1284 
⁄ly_ªÀa£_mëad©a
 = 
åue
;

1287 
num_∑ges
 = 
	`DIV_ROUND_UP
(
wrôe_byãs
 + 
off£t
, 
PAGE_SIZE
);

1288 
	`WARN_ON
(
num_∑ges
 > 
ƒ±rs
);

1289 
ª£rve_byãs
 = 
	`round_up
(
wrôe_byãs
 + 
£˘‹_off£t
,

1290 
fs_öfo
->
£˘‹size
);

1291 
	`WARN_ON
(
ª£rve_byãs
 == 0);

1292 
ªt
 = 
	`båfs_dñÆloc_ª£rve_mëad©a
(
	`BTRFS_I
(
öode
),

1293 
ª£rve_byãs
,

1294 
ª£rve_byãs
, 
nowaô
);

1295 i‡(
ªt
) {

1296 i‡(!
⁄ly_ªÀa£_mëad©a
)

1297 
	`båfs_‰ì_ª£rved_d©a_•a˚
(
	`BTRFS_I
(
öode
),

1298 
d©a_ª£rved
, 
pos
,

1299 
wrôe_byãs
);

1301 
	`båfs_check_nocow_u∆ock
(
	`BTRFS_I
(
öode
));

1303 i‡(
nowaô
 && 
ªt
 =-
ENOSPC
)

1304 
ªt
 = -
EAGAIN
;

1308 
ªÀa£_byãs
 = 
ª£rve_byãs
;

1309 
agaö
:

1310 
ªt
 = 
	`bÆ™˚_dúty_∑ges_øãlimôed_Êags
(
öode
->
i_m≠pög
, 
bdp_Êags
);

1311 i‡(
ªt
) {

1312 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
	`BTRFS_I
(
öode
), 
ª£rve_byãs
);

1321 
ªt
 = 
	`¥ï¨e_∑ges
(
öode
, 
∑ges
, 
num_∑ges
,

1322 
pos
, 
wrôe_byãs
, 
f‹˚_∑ge_u±od©e
, 
Ál£
);

1323 i‡(
ªt
) {

1324 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
	`BTRFS_I
(
öode
),

1325 
ª£rve_byãs
);

1329 
exã¡s_locked
 = 
	`lock_™d_˛ónup_exã¡_if_√ed
(

1330 
	`BTRFS_I
(
öode
), 
∑ges
,

1331 
num_∑ges
, 
pos
, 
wrôe_byãs
, &
lock°¨t
,

1332 &
lockíd
, 
nowaô
, &
ˇched_°©e
);

1333 i‡(
exã¡s_locked
 < 0) {

1334 i‡(!
nowaô
 && 
exã¡s_locked
 =-
EAGAIN
)

1335 
agaö
;

1337 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
	`BTRFS_I
(
öode
),

1338 
ª£rve_byãs
);

1339 
ªt
 = 
exã¡s_locked
;

1343 
c›õd
 = 
	`båfs_c›y_‰om_u£r
(
pos
, 
wrôe_byãs
, 
∑ges
, 
i
);

1345 
num_£˘‹s
 = 
	`BTRFS_BYTES_TO_BLKS
(
fs_öfo
, 
ª£rve_byãs
);

1346 
dúty_£˘‹s
 = 
	`round_up
(
c›õd
 + 
£˘‹_off£t
,

1347 
fs_öfo
->
£˘‹size
);

1348 
dúty_£˘‹s
 = 
	`BTRFS_BYTES_TO_BLKS
(
fs_öfo
, dirty_sectors);

1354 i‡(
c›õd
 < 
wrôe_byãs
)

1355 
ƒ±rs
 = 1;

1357 i‡(
c›õd
 == 0) {

1358 
f‹˚_∑ge_u±od©e
 = 
åue
;

1359 
dúty_£˘‹s
 = 0;

1360 
dúty_∑ges
 = 0;

1362 
f‹˚_∑ge_u±od©e
 = 
Ál£
;

1363 
dúty_∑ges
 = 
	`DIV_ROUND_UP
(
c›õd
 + 
off£t
,

1364 
PAGE_SIZE
);

1367 i‡(
num_£˘‹s
 > 
dúty_£˘‹s
) {

1369 
ªÀa£_byãs
 -
dúty_£˘‹s
 << 
fs_öfo
->
£˘‹size_bôs
;

1370 i‡(
⁄ly_ªÀa£_mëad©a
) {

1371 
	`båfs_dñÆloc_ªÀa£_mëad©a
(
	`BTRFS_I
(
öode
),

1372 
ªÀa£_byãs
, 
åue
);

1374 
u64
 
__pos
;

1376 
__pos
 = 
	`round_down
(
pos
,

1377 
fs_öfo
->
£˘‹size
) +

1378 (
dúty_∑ges
 << 
PAGE_SHIFT
);

1379 
	`båfs_dñÆloc_ªÀa£_•a˚
(
	`BTRFS_I
(
öode
),

1380 
d©a_ª£rved
, 
__pos
,

1381 
ªÀa£_byãs
, 
åue
);

1385 
ªÀa£_byãs
 = 
	`round_up
(
c›õd
 + 
£˘‹_off£t
,

1386 
fs_öfo
->
£˘‹size
);

1388 
ªt
 = 
	`båfs_dúty_∑ges
(
	`BTRFS_I
(
öode
), 
∑ges
,

1389 
dúty_∑ges
, 
pos
, 
c›õd
,

1390 &
ˇched_°©e
, 
⁄ly_ªÀa£_mëad©a
);

1399 i‡(
exã¡s_locked
)

1400 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
lock°¨t
,

1401 
lockíd
, &
ˇched_°©e
);

1403 
	`‰ì_exã¡_°©e
(
ˇched_°©e
);

1405 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
	`BTRFS_I
(
öode
), 
ª£rve_byãs
);

1406 i‡(
ªt
) {

1407 
	`båfs_dr›_∑ges
(
fs_öfo
, 
∑ges
, 
num_∑ges
, 
pos
, 
c›õd
);

1411 
ªÀa£_byãs
 = 0;

1412 i‡(
⁄ly_ªÀa£_mëad©a
)

1413 
	`båfs_check_nocow_u∆ock
(
	`BTRFS_I
(
öode
));

1415 
	`båfs_dr›_∑ges
(
fs_öfo
, 
∑ges
, 
num_∑ges
, 
pos
, 
c›õd
);

1417 
	`c⁄d_ªsched
();

1419 
pos
 +
c›õd
;

1420 
num_wrôãn
 +
c›õd
;

1423 
	`k‰ì
(
∑ges
);

1425 i‡(
ªÀa£_byãs
) {

1426 i‡(
⁄ly_ªÀa£_mëad©a
) {

1427 
	`båfs_check_nocow_u∆ock
(
	`BTRFS_I
(
öode
));

1428 
	`båfs_dñÆloc_ªÀa£_mëad©a
(
	`BTRFS_I
(
öode
),

1429 
ªÀa£_byãs
, 
åue
);

1431 
	`båfs_dñÆloc_ªÀa£_•a˚
(
	`BTRFS_I
(
öode
),

1432 
d©a_ª£rved
,

1433 
	`round_down
(
pos
, 
fs_öfo
->
£˘‹size
),

1434 
ªÀa£_byãs
, 
åue
);

1438 
	`exã¡_ch™ge£t_‰ì
(
d©a_ª£rved
);

1439 i‡(
num_wrôãn
 > 0) {

1440 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁd_isize
, 
iocb
->
ki_pos
);

1441 
iocb
->
ki_pos
 +
num_wrôãn
;

1443 
out
:

1444 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
ûock_Êags
);

1446  
num_wrôãn
 ?Çum_wrôã¿: 
ªt
;

1447 
	}
}

1449 
ssize_t
 
	$check_dúe˘_IO
(
båfs_fs_öfo
 *
fs_öfo
,

1450 c⁄° 
iov_ôî
 *
ôî
, 
loff_t
 
off£t
)

1452 c⁄° 
u32
 
blocksize_mask
 = 
fs_öfo
->
£˘‹size
 - 1;

1454 i‡(
off£t
 & 
blocksize_mask
)

1455  -
EINVAL
;

1457 i‡(
	`iov_ôî_Æignmít
(
ôî
Ë& 
blocksize_mask
)

1458  -
EINVAL
;

1461 
	}
}

1463 
ssize_t
 
	$båfs_dúe˘_wrôe
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

1465 
fûe
 *fûê
iocb
->
ki_fûp
;

1466 
öode
 *öodê
	`fûe_öode
(
fûe
);

1467 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

1468 
loff_t
 
pos
;

1469 
ssize_t
 
wrôãn
 = 0;

1470 
ssize_t
 
wrôãn_buf„ªd
;

1471 
size_t
 
¥ev_À·
 = 0;

1472 
loff_t
 
ídbyã
;

1473 
ssize_t
 
îr
;

1474 
ûock_Êags
 = 0;

1475 
iom≠_dio
 *
dio
;

1477 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
)

1478 
ûock_Êags
 |
BTRFS_ILOCK_TRY
;

1486 i‡(
iocb
->
ki_pos
 + 
	`iov_ôî_cou¡
(
‰om
Ë<
	`i_size_ªad
(
öode
Ë&& 
	`IS_NOSEC
(inode))

1487 
ûock_Êags
 |
BTRFS_ILOCK_SHARED
;

1489 
ªlock
:

1490 
îr
 = 
	`båfs_öode_lock
(
	`BTRFS_I
(
öode
), 
ûock_Êags
);

1491 i‡(
îr
 < 0)

1492  
îr
;

1495 i‡((
ûock_Êags
 & 
BTRFS_ILOCK_SHARED
Ë&& !
	`IS_NOSEC
(
öode
)) {

1496 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
ûock_Êags
);

1497 
ûock_Êags
 &~
BTRFS_ILOCK_SHARED
;

1498 
ªlock
;

1501 
îr
 = 
	`gíîic_wrôe_checks
(
iocb
, 
‰om
);

1502 i‡(
îr
 <= 0) {

1503 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
ûock_Êags
);

1504  
îr
;

1507 
îr
 = 
	`båfs_wrôe_check
(
iocb
, 
‰om
,Érr);

1508 i‡(
îr
 < 0) {

1509 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
ûock_Êags
);

1510 
out
;

1513 
pos
 = 
iocb
->
ki_pos
;

1518 i‡((
ûock_Êags
 & 
BTRFS_ILOCK_SHARED
) &&

1519 
pos
 + 
	`iov_ôî_cou¡
(
‰om
Ë> 
	`i_size_ªad
(
öode
)) {

1520 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
ûock_Êags
);

1521 
ûock_Êags
 &~
BTRFS_ILOCK_SHARED
;

1522 
ªlock
;

1525 i‡(
	`check_dúe˘_IO
(
fs_öfo
, 
‰om
, 
pos
)) {

1526 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
ûock_Êags
);

1527 
buf„ªd
;

1548 
‰om
->
noÁu…
 = 
åue
;

1549 
dio
 = 
	`båfs_dio_wrôe
(
iocb
, 
‰om
, 
wrôãn
);

1550 
‰om
->
noÁu…
 = 
Ál£
;

1557 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
ûock_Êags
);

1559 i‡(
	`IS_ERR_OR_NULL
(
dio
))

1560 
îr
 = 
	`PTR_ERR_OR_ZERO
(
dio
);

1562 
îr
 = 
	`iom≠_dio_com∂ëe
(
dio
);

1565 i‡(
îr
 > 0)

1566 
wrôãn
 = 
îr
;

1568 i‡(
	`iov_ôî_cou¡
(
‰om
Ë> 0 && (
îr
 =-
EFAULT
 ||Érr > 0)) {

1569 c⁄° 
size_t
 
À·
 = 
	`iov_ôî_cou¡
(
‰om
);

1584 i‡(
À·
 =
¥ev_À·
) {

1585 
îr
 = -
ENOTBLK
;

1587 
	`Áu…_ö_iov_ôî_ªadabÀ
(
‰om
, 
À·
);

1588 
¥ev_À·
 = 
À·
;

1589 
ªlock
;

1597 i‡((
îr
 < 0 &&Éº !-
ENOTBLK
Ë|| !
	`iov_ôî_cou¡
(
‰om
))

1598 
out
;

1600 
buf„ªd
:

1607 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

1608 
îr
 = -
EAGAIN
;

1609 
out
;

1612 
pos
 = 
iocb
->
ki_pos
;

1613 
wrôãn_buf„ªd
 = 
	`båfs_buf„ªd_wrôe
(
iocb
, 
‰om
);

1614 i‡(
wrôãn_buf„ªd
 < 0) {

1615 
îr
 = 
wrôãn_buf„ªd
;

1616 
out
;

1622 
ídbyã
 = 
pos
 + 
wrôãn_buf„ªd
 - 1;

1623 
îr
 = 
	`båfs_fd©awrôe_ønge
(
öode
, 
pos
, 
ídbyã
);

1624 i‡(
îr
)

1625 
out
;

1626 
îr
 = 
	`fûem≠_fd©awaô_ønge
(
öode
->
i_m≠pög
, 
pos
, 
ídbyã
);

1627 i‡(
îr
)

1628 
out
;

1629 
wrôãn
 +
wrôãn_buf„ªd
;

1630 
iocb
->
ki_pos
 = 
pos
 + 
wrôãn_buf„ªd
;

1631 
	`övÆid©e_m≠pög_∑ges
(
fûe
->
f_m≠pög
, 
pos
 >> 
PAGE_SHIFT
,

1632 
ídbyã
 >> 
PAGE_SHIFT
);

1633 
out
:

1634  
îr
 < 0 ?Éº : 
wrôãn
;

1635 
	}
}

1637 
ssize_t
 
	$båfs_ícoded_wrôe
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
,

1638 c⁄° 
båfs_io˘l_ícoded_io_¨gs
 *
ícoded
)

1640 
fûe
 *fûê
iocb
->
ki_fûp
;

1641 
öode
 *öodê
	`fûe_öode
(
fûe
);

1642 
loff_t
 
cou¡
;

1643 
ssize_t
 
ªt
;

1645 
	`båfs_öode_lock
(
	`BTRFS_I
(
öode
), 0);

1646 
cou¡
 = 
ícoded
->
Àn
;

1647 
ªt
 = 
	`gíîic_wrôe_checks_cou¡
(
iocb
, &
cou¡
);

1648 i‡(
ªt
 =0 && 
cou¡
 !
ícoded
->
Àn
) {

1653 
ªt
 = -
EFBIG
;

1655 i‡(
ªt
 || 
ícoded
->
Àn
 == 0)

1656 
out
;

1658 
ªt
 = 
	`båfs_wrôe_check
(
iocb
, 
‰om
, 
ícoded
->
Àn
);

1659 i‡(
ªt
 < 0)

1660 
out
;

1662 
ªt
 = 
	`båfs_do_ícoded_wrôe
(
iocb
, 
‰om
, 
ícoded
);

1663 
out
:

1664 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 0);

1665  
ªt
;

1666 
	}
}

1668 
ssize_t
 
	$båfs_do_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
,

1669 c⁄° 
båfs_io˘l_ícoded_io_¨gs
 *
ícoded
)

1671 
fûe
 *fûê
iocb
->
ki_fûp
;

1672 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
	`fûe_öode
(
fûe
));

1673 
ssize_t
 
num_wrôãn
, 
num_sync
;

1680 i‡(
	`BTRFS_FS_ERROR
(
öode
->
roŸ
->
fs_öfo
))

1681  -
EROFS
;

1683 i‡(
ícoded
 && (
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
))

1684  -
EOPNOTSUPP
;

1686 i‡(
ícoded
) {

1687 
num_wrôãn
 = 
	`båfs_ícoded_wrôe
(
iocb
, 
‰om
, 
ícoded
);

1688 
num_sync
 = 
ícoded
->
Àn
;

1689 } i‡(
iocb
->
ki_Êags
 & 
IOCB_DIRECT
) {

1690 
num_wrôãn
 = 
	`båfs_dúe˘_wrôe
(
iocb
, 
‰om
);

1691 
num_sync
 = 
num_wrôãn
;

1693 
num_wrôãn
 = 
	`båfs_buf„ªd_wrôe
(
iocb
, 
‰om
);

1694 
num_sync
 = 
num_wrôãn
;

1697 
	`båfs_£t_öode_œ°_sub_å™s
(
öode
);

1699 i‡(
num_sync
 > 0) {

1700 
num_sync
 = 
	`gíîic_wrôe_sync
(
iocb
,Çum_sync);

1701 i‡(
num_sync
 < 0)

1702 
num_wrôãn
 = 
num_sync
;

1705  
num_wrôãn
;

1706 
	}
}

1708 
ssize_t
 
	$båfs_fûe_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

1710  
	`båfs_do_wrôe_ôî
(
iocb
, 
‰om
, 
NULL
);

1711 
	}
}

1713 
	$båfs_ªÀa£_fûe
(
öode
 *öode, 
fûe
 *
fûp
)

1715 
båfs_fûe_¥iv©e
 *
¥iv©e
 = 
fûp
->
¥iv©e_d©a
;

1717 
öode
 *
f_öode
 = 
	`fûe_öode
(
fûp
);

1720 i‡(
¥iv©e
) {

1721 
	`k‰ì
(
¥iv©e
->
fûldú_buf
);

1722 
	`‰ì_exã¡_°©e
(
¥iv©e
->
Œ£ek_ˇched_°©e
);

1723 
	`k‰ì
(
¥iv©e
);

1724 
fûp
->
¥iv©e_d©a
 = 
NULL
;

1738 i‡(
	`ã°_™d_˛ór_bô
(
BTRFS_INODE_FLUSH_ON_CLOSE
,

1739 &
	`BTRFS_I
(
f_öode
)->
ru¡ime_Êags
))

1740 
	`fûem≠_Êush
(
f_öode
->
i_m≠pög
);

1742 
	}
}

1744 
	$°¨t_‹dîed_›s
(
öode
 *öode, 
loff_t
 
°¨t
,Üoff_à
íd
)

1746 
ªt
;

1747 
blk_∂ug
 
∂ug
;

1755 
	`blk_°¨t_∂ug
(&
∂ug
);

1756 
ªt
 = 
	`båfs_fd©awrôe_ønge
(
öode
, 
°¨t
, 
íd
);

1757 
	`blk_föish_∂ug
(&
∂ug
);

1759  
ªt
;

1760 
	}
}

1762 
ölöe
 
boﬁ
 
	$skù_öode_loggög
(c⁄° 
båfs_log_˘x
 *
˘x
)

1764 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
˘x
->inode);

1765 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

1767 i‡(
	`båfs_öode_ö_log
(
öode
, 
fs_öfo
->
gíî©i⁄
) &&

1768 
	`li°_em±y
(&
˘x
->
‹dîed_exã¡s
))

1769  
åue
;

1778 i‡(
öode
->
œ°_å™s
 <
fs_öfo
->
œ°_å™s_commôãd
 &&

1779 (
	`ã°_bô
(
BTRFS_INODE_NEEDS_FULL_SYNC
, &
öode
->
ru¡ime_Êags
) ||

1780 
	`li°_em±y
(&
˘x
->
‹dîed_exã¡s
)))

1781  
åue
;

1783  
Ál£
;

1784 
	}
}

1797 
	$båfs_sync_fûe
(
fûe
 *fûe, 
loff_t
 
°¨t
,Üoff_à
íd
, 
d©async
)

1799 
díåy
 *díåy = 
	`fûe_díåy
(
fûe
);

1800 
öode
 *öodê
	`d_öode
(
díåy
);

1801 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

1802 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

1803 
båfs_å™s_h™dÀ
 *
å™s
;

1804 
båfs_log_˘x
 
˘x
;

1805 
ªt
 = 0, 
îr
;

1806 
u64
 
Àn
;

1807 
boﬁ
 
fuŒ_sync
;

1809 
	`åa˚_båfs_sync_fûe
(
fûe
, 
d©async
);

1811 
	`båfs_öô_log_˘x
(&
˘x
, 
öode
);

1821 
°¨t
 = 0;

1822 
íd
 = 
LLONG_MAX
;

1823 
Àn
 = (
u64
)
LLONG_MAX
 + 1;

1831 
ªt
 = 
	`°¨t_‹dîed_›s
(
öode
, 
°¨t
, 
íd
);

1832 i‡(
ªt
)

1833 
out
;

1835 
	`båfs_öode_lock
(
	`BTRFS_I
(
öode
), 
BTRFS_ILOCK_MMAP
);

1837 
	`©omic_öc
(&
roŸ
->
log_b©ch
);

1857 
ªt
 = 
	`°¨t_‹dîed_›s
(
öode
, 
°¨t
, 
íd
);

1858 i‡(
ªt
) {

1859 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
BTRFS_ILOCK_MMAP
);

1860 
out
;

1871 
fuŒ_sync
 = 
	`ã°_bô
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

1872 &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
);

1889 i‡(
fuŒ_sync
 || 
	`båfs_is_z⁄ed
(
fs_öfo
)) {

1890 
ªt
 = 
	`båfs_waô_‹dîed_ønge
(
öode
, 
°¨t
, 
Àn
);

1897 
	`båfs_gë_‹dîed_exã¡s_f‹_loggög
(
	`BTRFS_I
(
öode
),

1898 &
˘x
.
‹dîed_exã¡s
);

1899 
ªt
 = 
	`fûem≠_fd©awaô_ønge
(
öode
->
i_m≠pög
, 
°¨t
, 
íd
);

1902 i‡(
ªt
)

1903 
out_ªÀa£_exã¡s
;

1905 
	`©omic_öc
(&
roŸ
->
log_b©ch
);

1907 
	`smp_mb
();

1908 i‡(
	`skù_öode_loggög
(&
˘x
)) {

1914 
	`˛ór_bô
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

1915 &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
);

1923 
ªt
 = 
	`fûem≠_check_wb_îr
(
öode
->
i_m≠pög
, 
fûe
->
f_wb_îr
);

1924 
out_ªÀa£_exã¡s
;

1938 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

1939 i‡(
	`IS_ERR
(
å™s
)) {

1940 
ªt
 = 
	`PTR_ERR
(
å™s
);

1941 
out_ªÀa£_exã¡s
;

1943 
å™s
->
ö_fsync
 = 
åue
;

1945 
ªt
 = 
	`båfs_log_díåy_ß„
(
å™s
, 
díåy
, &
˘x
);

1946 
	`båfs_ªÀa£_log_˘x_exã¡s
(&
˘x
);

1947 i‡(
ªt
 < 0) {

1949 
ªt
 = 
BTRFS_LOG_FORCE_COMMIT
;

1962 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
BTRFS_ILOCK_MMAP
);

1964 i‡(
ªt
 =
BTRFS_NO_LOG_SYNC
) {

1965 
ªt
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1966 
out
;

1970 i‡(!
ªt
) {

1971 
ªt
 = 
	`båfs_sync_log
(
å™s
, 
roŸ
, &
˘x
);

1972 i‡(!
ªt
) {

1973 
ªt
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1974 
out
;

1990 i‡(!
fuŒ_sync
) {

1991 
ªt
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1992 i‡(
ªt
)

1993 
out
;

1994 
ªt
 = 
	`båfs_waô_‹dîed_ønge
(
öode
, 
°¨t
, 
Àn
);

1995 i‡(
ªt
)

1996 
out
;

2004 
å™s
 = 
	`båfs_©èch_å™ß˘i⁄_b¨rõr
(
roŸ
);

2005 i‡(
	`IS_ERR
(
å™s
)) {

2006 
ªt
 = 
	`PTR_ERR
(
å™s
);

2013 i‡(
ªt
 =-
ENOENT
)

2014 
ªt
 = 0;

2015 
out
;

2019 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

2020 
out
:

2021 
	`ASSERT
(
	`li°_em±y
(&
˘x
.
li°
));

2022 
	`ASSERT
(
	`li°_em±y
(&
˘x
.
c⁄Êi˘_öodes
));

2023 
îr
 = 
	`fûe_check_™d_adv™˚_wb_îr
(
fûe
);

2024 i‡(!
ªt
)

2025 
ªt
 = 
îr
;

2026  
ªt
 > 0 ? -
EIO
 :Ñet;

2028 
out_ªÀa£_exã¡s
:

2029 
	`båfs_ªÀa£_log_˘x_exã¡s
(&
˘x
);

2030 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
BTRFS_ILOCK_MMAP
);

2031 
out
;

2032 
	}
}

2034 c⁄° 
vm_›î©i⁄s_°ru˘
 
	gbåfs_fûe_vm_›s
 = {

2035 .
Áu…
 = 
fûem≠_Áu…
,

2036 .
	gm≠_∑ges
 = 
fûem≠_m≠_∑ges
,

2037 .
	g∑ge_mkwrôe
 = 
båfs_∑ge_mkwrôe
,

2040 
	$båfs_fûe_mm≠
(
fûe
 *
fûp
, 
vm_¨ó_°ru˘
 *
vma
)

2042 
addªss_•a˚
 *
m≠pög
 = 
fûp
->
f_m≠pög
;

2044 
öode
 *
f_öode
;

2045 
f_öode
 = 
	`fûe_öode
(
fûp
);

2048 
m≠pög
 = 
f_öode
->
i_m≠pög
;

2052 i‡(!
m≠pög
->
a_›s
->
ªad_fﬁio
)

2053  -
ENOEXEC
;

2055 
	`fûe_ac˚s£d
(
fûp
);

2056 
vma
->
vm_›s
 = &
båfs_fûe_vm_›s
;

2059 
	}
}

2061 
	$hﬁe_mîgóbÀ
(
båfs_öode
 *
öode
, 
exã¡_buf„r
 *
Àaf
,

2062 
¶Ÿ
, 
u64
 
°¨t
, u64 
íd
)

2064 
båfs_fûe_exã¡_ôem
 *
fi
;

2065 
båfs_key
 
key
;

2067 i‡(
¶Ÿ
 < 0 || slŸ >
	`båfs_hódî_ƒôems
(
Àaf
))

2070 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

2071 i‡(
key
.
obje˘id
 !
	`båfs_öo
(
öode
) ||

2072 
key
.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

2075 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_fûe_exã¡_ôem
);

2077 i‡(
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
fi
Ë!
BTRFS_FILE_EXTENT_REG
)

2080 i‡(
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
fi
))

2083 i‡(
key
.
off£t
 =
íd
)

2085 i‡(
key
.
off£t
 + 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
fi
Ë=
°¨t
)

2088 
	}
}

2090 
	$fûl_hﬁes
(
båfs_å™s_h™dÀ
 *
å™s
,

2091 
båfs_öode
 *
öode
,

2092 
båfs_∑th
 *
∑th
, 
u64
 
off£t
, u64 
íd
)

2094 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2095 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

2096 
exã¡_buf„r
 *
Àaf
;

2097 
båfs_fûe_exã¡_ôem
 *
fi
;

2098 
exã¡_m≠
 *
hﬁe_em
;

2099 
båfs_key
 
key
;

2100 
ªt
;

2102 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
NO_HOLES
))

2103 
out
;

2105 
key
.
obje˘id
 = 
	`båfs_öo
(
öode
);

2106 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

2107 
key
.
off£t
 = offset;

2109 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, 0, 1);

2110 i‡(
ªt
 <= 0) {

2115 i‡(
ªt
 == 0)

2116 
ªt
 = -
EINVAL
;

2117  
ªt
;

2120 
Àaf
 = 
∑th
->
nodes
[0];

2121 i‡(
	`hﬁe_mîgóbÀ
(
öode
, 
Àaf
, 
∑th
->
¶Ÿs
[0] - 1, 
off£t
, 
íd
)) {

2122 
u64
 
num_byãs
;

2124 
∑th
->
¶Ÿs
[0]--;

2125 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

2126 
båfs_fûe_exã¡_ôem
);

2127 
num_byãs
 = 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
fi
) +

2128 
íd
 - 
off£t
;

2129 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
fi
, 
num_byãs
);

2130 
	`båfs_£t_fûe_exã¡_øm_byãs
(
Àaf
, 
fi
, 
num_byãs
);

2131 
	`båfs_£t_fûe_exã¡_off£t
(
Àaf
, 
fi
, 0);

2132 
	`båfs_£t_fûe_exã¡_gíî©i⁄
(
Àaf
, 
fi
, 
å™s
->
å™sid
);

2133 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

2134 
out
;

2137 i‡(
	`hﬁe_mîgóbÀ
(
öode
, 
Àaf
, 
∑th
->
¶Ÿs
[0], 
off£t
, 
íd
)) {

2138 
u64
 
num_byãs
;

2140 
key
.
off£t
 = offset;

2141 
	`båfs_£t_ôem_key_ß„
(
å™s
, 
∑th
, &
key
);

2142 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

2143 
båfs_fûe_exã¡_ôem
);

2144 
num_byãs
 = 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
fi
Ë+ 
íd
 -

2145 
off£t
;

2146 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
fi
, 
num_byãs
);

2147 
	`båfs_£t_fûe_exã¡_øm_byãs
(
Àaf
, 
fi
, 
num_byãs
);

2148 
	`båfs_£t_fûe_exã¡_off£t
(
Àaf
, 
fi
, 0);

2149 
	`båfs_£t_fûe_exã¡_gíî©i⁄
(
Àaf
, 
fi
, 
å™s
->
å™sid
);

2150 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

2151 
out
;

2153 
	`båfs_ªÀa£_∑th
(
∑th
);

2155 
ªt
 = 
	`båfs_ö£π_hﬁe_exã¡
(
å™s
, 
roŸ
, 
	`båfs_öo
(
öode
), 
off£t
,

2156 
íd
 - 
off£t
);

2157 i‡(
ªt
)

2158  
ªt
;

2160 
out
:

2161 
	`båfs_ªÀa£_∑th
(
∑th
);

2163 
hﬁe_em
 = 
	`Æloc_exã¡_m≠
();

2164 i‡(!
hﬁe_em
) {

2165 
	`båfs_dr›_exã¡_m≠_ønge
(
öode
, 
off£t
, 
íd
 - 1, 
Ál£
);

2166 
	`båfs_£t_öode_fuŒ_sync
(
öode
);

2168 
hﬁe_em
->
°¨t
 = 
off£t
;

2169 
hﬁe_em
->
Àn
 = 
íd
 - 
off£t
;

2170 
hﬁe_em
->
øm_byãs
 = hﬁe_em->
Àn
;

2171 
hﬁe_em
->
‹ig_°¨t
 = 
off£t
;

2173 
hﬁe_em
->
block_°¨t
 = 
EXTENT_MAP_HOLE
;

2174 
hﬁe_em
->
block_Àn
 = 0;

2175 
hﬁe_em
->
‹ig_block_Àn
 = 0;

2176 
hﬁe_em
->
com¥ess_ty≥
 = 
BTRFS_COMPRESS_NONE
;

2177 
hﬁe_em
->
gíî©i⁄
 = 
å™s
->
å™sid
;

2179 
ªt
 = 
	`båfs_ª∂a˚_exã¡_m≠_ønge
(
öode
, 
hﬁe_em
, 
åue
);

2180 
	`‰ì_exã¡_m≠
(
hﬁe_em
);

2181 i‡(
ªt
)

2182 
	`båfs_£t_öode_fuŒ_sync
(
öode
);

2186 
	}
}

2194 
	$föd_fú°_n⁄_hﬁe
(
båfs_öode
 *
öode
, 
u64
 *
°¨t
, u64 *
Àn
)

2196 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

2197 
exã¡_m≠
 *
em
;

2198 
ªt
 = 0;

2200 
em
 = 
	`båfs_gë_exã¡
(
öode
, 
NULL
, 0,

2201 
	`round_down
(*
°¨t
, 
fs_öfo
->
£˘‹size
),

2202 
	`round_up
(*
Àn
, 
fs_öfo
->
£˘‹size
));

2203 i‡(
	`IS_ERR
(
em
))

2204  
	`PTR_ERR
(
em
);

2207 i‡(
em
->
block_°¨t
 =
EXTENT_MAP_HOLE
) {

2208 
ªt
 = 1;

2209 *
Àn
 = 
em
->
°¨t
 +Ém->len > *start + *len ?

2210 0 : *
°¨t
 + *
Àn
 - 
em
->start -Ém->len;

2211 *
°¨t
 = 
em
->°¨à+Ém->
Àn
;

2213 
	`‰ì_exã¡_m≠
(
em
);

2214  
ªt
;

2215 
	}
}

2217 
	$båfs_punch_hﬁe_lock_ønge
(
öode
 *inode,

2218 c⁄° 
u64
 
lock°¨t
,

2219 c⁄° 
u64
 
lockíd
,

2220 
exã¡_°©e
 **
ˇched_°©e
)

2230 c⁄° 
u64
 
∑ge_lock°¨t
 = 
	`round_up
(
lock°¨t
, 
PAGE_SIZE
);

2231 c⁄° 
u64
 
∑ge_lockíd
 = 
	`round_down
(
lockíd
 + 1, 
PAGE_SIZE
) - 1;

2234 
	`åunˇã_∑geˇche_ønge
(
öode
, 
lock°¨t
, 
lockíd
);

2236 
	`lock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
lock°¨t
, 
lockíd
,

2237 
ˇched_°©e
);

2248 i‡(!
	`fûem≠_ønge_has_∑ge
(
öode
->
i_m≠pög
, 
∑ge_lock°¨t
,

2249 
∑ge_lockíd
))

2252 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
lock°¨t
, 
lockíd
,

2253 
ˇched_°©e
);

2256 
	`båfs_as£π_öode_ønge_˛ón
(
	`BTRFS_I
(
öode
), 
lock°¨t
, 
lockíd
);

2257 
	}
}

2259 
	$båfs_ö£π_ª∂a˚_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

2260 
båfs_öode
 *
öode
,

2261 
båfs_∑th
 *
∑th
,

2262 
båfs_ª∂a˚_exã¡_öfo
 *
exã¡_öfo
,

2263 c⁄° 
u64
 
ª∂a˚_Àn
,

2264 c⁄° 
u64
 
byãs_to_dr›
)

2266 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2267 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

2268 
båfs_fûe_exã¡_ôem
 *
exã¡
;

2269 
exã¡_buf„r
 *
Àaf
;

2270 
båfs_key
 
key
;

2271 
¶Ÿ
;

2272 
båfs_ªf
 
ªf
 = { 0 };

2273 
ªt
;

2275 i‡(
ª∂a˚_Àn
 == 0)

2278 i‡(
exã¡_öfo
->
disk_off£t
 == 0 &&

2279 
	`båfs_fs_öcom∑t
(
fs_öfo
, 
NO_HOLES
)) {

2280 
	`båfs_upd©e_öode_byãs
(
öode
, 0, 
byãs_to_dr›
);

2284 
key
.
obje˘id
 = 
	`båfs_öo
(
öode
);

2285 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

2286 
key
.
off£t
 = 
exã¡_öfo
->
fûe_off£t
;

2287 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
,

2288 (
båfs_fûe_exã¡_ôem
));

2289 i‡(
ªt
)

2290  
ªt
;

2291 
Àaf
 = 
∑th
->
nodes
[0];

2292 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

2293 
	`wrôe_exã¡_buf„r
(
Àaf
, 
exã¡_öfo
->
exã¡_buf
,

2294 
	`båfs_ôem_±r_off£t
(
Àaf
, 
¶Ÿ
),

2295 (
båfs_fûe_exã¡_ôem
));

2296 
exã¡
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_fûe_exã¡_ôem
);

2297 
	`ASSERT
(
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
exã¡
Ë!
BTRFS_FILE_EXTENT_INLINE
);

2298 
	`båfs_£t_fûe_exã¡_off£t
(
Àaf
, 
exã¡
, 
exã¡_öfo
->
d©a_off£t
);

2299 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
exã¡
, 
ª∂a˚_Àn
);

2300 i‡(
exã¡_öfo
->
is_√w_exã¡
)

2301 
	`båfs_£t_fûe_exã¡_gíî©i⁄
(
Àaf
, 
exã¡
, 
å™s
->
å™sid
);

2302 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

2303 
	`båfs_ªÀa£_∑th
(
∑th
);

2305 
ªt
 = 
	`båfs_öode_£t_fûe_exã¡_ønge
(
öode
, 
exã¡_öfo
->
fûe_off£t
,

2306 
ª∂a˚_Àn
);

2307 i‡(
ªt
)

2308  
ªt
;

2311 i‡(
exã¡_öfo
->
disk_off£t
 == 0) {

2312 
	`båfs_upd©e_öode_byãs
(
öode
, 0, 
byãs_to_dr›
);

2316 
	`båfs_upd©e_öode_byãs
(
öode
, 
ª∂a˚_Àn
, 
byãs_to_dr›
);

2318 i‡(
exã¡_öfo
->
is_√w_exã¡
 &&Éxã¡_öfo->
ö£πi⁄s
 == 0) {

2319 
key
.
obje˘id
 = 
exã¡_öfo
->
disk_off£t
;

2320 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

2321 
key
.
off£t
 = 
exã¡_öfo
->
disk_Àn
;

2322 
ªt
 = 
	`båfs_Æloc_ª£rved_fûe_exã¡
(
å™s
, 
roŸ
,

2323 
	`båfs_öo
(
öode
),

2324 
exã¡_öfo
->
fûe_off£t
,

2325 
exã¡_öfo
->
qgroup_ª£rved
,

2326 &
key
);

2328 
u64
 
ªf_off£t
;

2330 
	`båfs_öô_gíîic_ªf
(&
ªf
, 
BTRFS_ADD_DELAYED_REF
,

2331 
exã¡_öfo
->
disk_off£t
,

2332 
exã¡_öfo
->
disk_Àn
, 0);

2333 
ªf_off£t
 = 
exã¡_öfo
->
fûe_off£t
 -Éxã¡_öfo->
d©a_off£t
;

2334 
	`båfs_öô_d©a_ªf
(&
ªf
, 
roŸ
->
roŸ_key
.
obje˘id
,

2335 
	`båfs_öo
(
öode
), 
ªf_off£t
, 0, 
Ál£
);

2336 
ªt
 = 
	`båfs_öc_exã¡_ªf
(
å™s
, &
ªf
);

2339 
exã¡_öfo
->
ö£πi⁄s
++;

2341  
ªt
;

2342 
	}
}

2353 
	$båfs_ª∂a˚_fûe_exã¡s
(
båfs_öode
 *
öode
,

2354 
båfs_∑th
 *
∑th
, c⁄° 
u64
 
°¨t
,

2355 c⁄° 
u64
 
íd
,

2356 
båfs_ª∂a˚_exã¡_öfo
 *
exã¡_öfo
,

2357 
båfs_å™s_h™dÀ
 **
å™s_out
)

2359 
båfs_dr›_exã¡s_¨gs
 
dr›_¨gs
 = { 0 };

2360 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

2361 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

2362 
u64
 
mö_size
 = 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
, 1);

2363 
u64
 
öo_size
 = 
	`round_up
(
öode
->
vfs_öode
.
i_size
, 
fs_öfo
->
£˘‹size
);

2364 
båfs_å™s_h™dÀ
 *
å™s
 = 
NULL
;

2365 
båfs_block_rsv
 *
rsv
;

2366 
rsv_cou¡
;

2367 
u64
 
cur_off£t
;

2368 
u64
 
Àn
 = 
íd
 - 
°¨t
;

2369 
ªt
 = 0;

2371 i‡(
íd
 <
°¨t
)

2372  -
EINVAL
;

2374 
rsv
 = 
	`båfs_Æloc_block_rsv
(
fs_öfo
, 
BTRFS_BLOCK_RSV_TEMP
);

2375 i‡(!
rsv
) {

2376 
ªt
 = -
ENOMEM
;

2377 
out
;

2379 
rsv
->
size
 = 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
, 1);

2380 
rsv
->
ÁûÁ°
 = 
åue
;

2388 i‡(!
	`båfs_fs_öcom∑t
(
fs_öfo
, 
NO_HOLES
Ë|| 
exã¡_öfo
)

2389 
rsv_cou¡
 = 3;

2391 
rsv_cou¡
 = 2;

2393 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 
rsv_cou¡
);

2394 i‡(
	`IS_ERR
(
å™s
)) {

2395 
ªt
 = 
	`PTR_ERR
(
å™s
);

2396 
å™s
 = 
NULL
;

2397 
out_‰ì
;

2400 
ªt
 = 
	`båfs_block_rsv_migøã
(&
fs_öfo
->
å™s_block_rsv
, 
rsv
,

2401 
mö_size
, 
Ál£
);

2402 i‡(
	`WARN_ON
(
ªt
))

2403 
out_å™s
;

2404 
å™s
->
block_rsv
 = 
rsv
;

2406 
cur_off£t
 = 
°¨t
;

2407 
dr›_¨gs
.
∑th
 =Öath;

2408 
dr›_¨gs
.
íd
 =Énd + 1;

2409 
dr›_¨gs
.
dr›_ˇche
 = 
åue
;

2410 
cur_off£t
 < 
íd
) {

2411 
dr›_¨gs
.
°¨t
 = 
cur_off£t
;

2412 
ªt
 = 
	`båfs_dr›_exã¡s
(
å™s
, 
roŸ
, 
öode
, &
dr›_¨gs
);

2414 i‡(!
exã¡_öfo
)

2415 
	`båfs_upd©e_öode_byãs
(
öode
, 0,

2416 
dr›_¨gs
.
byãs_found
);

2417 i‡(
ªt
 !-
ENOSPC
) {

2426 i‡(
ªt
 &&

2427 (
ªt
 !-
EOPNOTSUPP
 ||

2428 (
exã¡_öfo
 &&Éxã¡_öfo->
is_√w_exã¡
)))

2429 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2433 
å™s
->
block_rsv
 = &
fs_öfo
->
å™s_block_rsv
;

2435 i‡(!
exã¡_öfo
 && 
cur_off£t
 < 
dr›_¨gs
.
dr›_íd
 &&

2436 
cur_off£t
 < 
öo_size
) {

2437 
ªt
 = 
	`fûl_hﬁes
(
å™s
, 
öode
, 
∑th
, 
cur_off£t
,

2438 
dr›_¨gs
.
dr›_íd
);

2439 i‡(
ªt
) {

2446 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2449 } i‡(!
exã¡_öfo
 && 
cur_off£t
 < 
dr›_¨gs
.
dr›_íd
) {

2456 
ªt
 = 
	`båfs_öode_˛ór_fûe_exã¡_ønge
(
öode
,

2457 
cur_off£t
,

2458 
dr›_¨gs
.
dr›_íd
 - 
cur_off£t
);

2459 i‡(
ªt
) {

2465 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2470 i‡(
exã¡_öfo
 &&

2471 
dr›_¨gs
.
dr›_íd
 > 
exã¡_öfo
->
fûe_off£t
) {

2472 
u64
 
ª∂a˚_Àn
 = 
dr›_¨gs
.
dr›_íd
 -

2473 
exã¡_öfo
->
fûe_off£t
;

2475 
ªt
 = 
	`båfs_ö£π_ª∂a˚_exã¡
(
å™s
, 
öode
, 
∑th
,

2476 
exã¡_öfo
, 
ª∂a˚_Àn
,

2477 
dr›_¨gs
.
byãs_found
);

2478 i‡(
ªt
) {

2479 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2482 
exã¡_öfo
->
d©a_Àn
 -
ª∂a˚_Àn
;

2483 
exã¡_öfo
->
d©a_off£t
 +
ª∂a˚_Àn
;

2484 
exã¡_öfo
->
fûe_off£t
 +
ª∂a˚_Àn
;

2499 
	`öode_öc_ivîsi⁄
(&
öode
->
vfs_öode
);

2501 i‡(!
exã¡_öfo
 ||Éxã¡_öfo->
upd©e_times
)

2502 
öode
->
vfs_öode
.
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(&inode->vfs_inode);

2504 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
öode
);

2505 i‡(
ªt
)

2508 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

2509 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

2511 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 
rsv_cou¡
);

2512 i‡(
	`IS_ERR
(
å™s
)) {

2513 
ªt
 = 
	`PTR_ERR
(
å™s
);

2514 
å™s
 = 
NULL
;

2518 
ªt
 = 
	`båfs_block_rsv_migøã
(&
fs_öfo
->
å™s_block_rsv
,

2519 
rsv
, 
mö_size
, 
Ál£
);

2520 i‡(
	`WARN_ON
(
ªt
))

2522 
å™s
->
block_rsv
 = 
rsv
;

2524 
cur_off£t
 = 
dr›_¨gs
.
dr›_íd
;

2525 
Àn
 = 
íd
 - 
cur_off£t
;

2526 i‡(!
exã¡_öfo
 && 
Àn
) {

2527 
ªt
 = 
	`föd_fú°_n⁄_hﬁe
(
öode
, &
cur_off£t
, &
Àn
);

2528 i‡(
	`u∆ikñy
(
ªt
 < 0))

2530 i‡(
ªt
 && !
Àn
) {

2531 
ªt
 = 0;

2543 i‡(
exã¡_öfo
 && !exã¡_öfo->
is_√w_exã¡
)

2544 
	`båfs_£t_öode_fuŒ_sync
(
öode
);

2546 i‡(
ªt
)

2547 
out_å™s
;

2549 
å™s
->
block_rsv
 = &
fs_öfo
->
å™s_block_rsv
;

2561 i‡(
dr›_¨gs
.
dr›_íd
 <
íd
)

2562 
dr›_¨gs
.
dr›_íd
 = 
íd
 + 1;

2568 i‡(!
exã¡_öfo
 && 
cur_off£t
 < 
öo_size
 &&

2569 
cur_off£t
 < 
dr›_¨gs
.
dr›_íd
) {

2570 
ªt
 = 
	`fûl_hﬁes
(
å™s
, 
öode
, 
∑th
, 
cur_off£t
,

2571 
dr›_¨gs
.
dr›_íd
);

2572 i‡(
ªt
) {

2574 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2575 
out_å™s
;

2577 } i‡(!
exã¡_öfo
 && 
cur_off£t
 < 
dr›_¨gs
.
dr›_íd
) {

2579 
ªt
 = 
	`båfs_öode_˛ór_fûe_exã¡_ønge
(
öode
, 
cur_off£t
,

2580 
dr›_¨gs
.
dr›_íd
 - 
cur_off£t
);

2581 i‡(
ªt
) {

2582 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2583 
out_å™s
;

2587 i‡(
exã¡_öfo
) {

2588 
ªt
 = 
	`båfs_ö£π_ª∂a˚_exã¡
(
å™s
, 
öode
, 
∑th
,

2589 
exã¡_öfo
,Éxã¡_öfo->
d©a_Àn
,

2590 
dr›_¨gs
.
byãs_found
);

2591 i‡(
ªt
) {

2592 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2593 
out_å™s
;

2597 
out_å™s
:

2598 i‡(!
å™s
)

2599 
out_‰ì
;

2601 
å™s
->
block_rsv
 = &
fs_öfo
->
å™s_block_rsv
;

2602 i‡(
ªt
)

2603 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

2605 *
å™s_out
 = 
å™s
;

2606 
out_‰ì
:

2607 
	`båfs_‰ì_block_rsv
(
fs_öfo
, 
rsv
);

2608 
out
:

2609  
ªt
;

2610 
	}
}

2612 
	$båfs_punch_hﬁe
(
fûe
 *fûe, 
loff_t
 
off£t
,Üoff_à
Àn
)

2614 
öode
 *öodê
	`fûe_öode
(
fûe
);

2615 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

2616 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

2617 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

2618 
båfs_∑th
 *
∑th
;

2619 
båfs_å™s_h™dÀ
 *
å™s
 = 
NULL
;

2620 
u64
 
lock°¨t
;

2621 
u64
 
lockíd
;

2622 
u64
 
èû_°¨t
;

2623 
u64
 
èû_Àn
;

2624 
u64
 
‹ig_°¨t
 = 
off£t
;

2625 
ªt
 = 0;

2626 
boﬁ
 
ßme_block
;

2627 
u64
 
öo_size
;

2628 
boﬁ
 
åunˇãd_block
 = 
Ál£
;

2629 
boﬁ
 
upd©ed_öode
 = 
Ál£
;

2631 
	`båfs_öode_lock
(
	`BTRFS_I
(
öode
), 
BTRFS_ILOCK_MMAP
);

2633 
ªt
 = 
	`båfs_waô_‹dîed_ønge
(
öode
, 
off£t
, 
Àn
);

2634 i‡(
ªt
)

2635 
out_⁄ly_muãx
;

2637 
öo_size
 = 
	`round_up
(
öode
->
i_size
, 
fs_öfo
->
£˘‹size
);

2638 
ªt
 = 
	`föd_fú°_n⁄_hﬁe
(
	`BTRFS_I
(
öode
), &
off£t
, &
Àn
);

2639 i‡(
ªt
 < 0)

2640 
out_⁄ly_muãx
;

2641 i‡(
ªt
 && !
Àn
) {

2643 
ªt
 = 0;

2644 
out_⁄ly_muãx
;

2647 
ªt
 = 
	`fûe_modifõd
(
fûe
);

2648 i‡(
ªt
)

2649 
out_⁄ly_muãx
;

2651 
lock°¨t
 = 
	`round_up
(
off£t
, 
fs_öfo
->
£˘‹size
);

2652 
lockíd
 = 
	`round_down
(
off£t
 + 
Àn
, 
fs_öfo
->
£˘‹size
) - 1;

2653 
ßme_block
 = (
	`BTRFS_BYTES_TO_BLKS
(
fs_öfo
, 
off£t
))

2654 =(
	`BTRFS_BYTES_TO_BLKS
(
fs_öfo
, 
off£t
 + 
Àn
 - 1));

2663 i‡(
ßme_block
 && 
Àn
 < 
fs_öfo
->
£˘‹size
) {

2664 i‡(
off£t
 < 
öo_size
) {

2665 
åunˇãd_block
 = 
åue
;

2666 
ªt
 = 
	`båfs_åunˇã_block
(
	`BTRFS_I
(
öode
), 
off£t
, 
Àn
,

2669 
ªt
 = 0;

2671 
out_⁄ly_muãx
;

2675 i‡(
off£t
 < 
öo_size
) {

2676 
åunˇãd_block
 = 
åue
;

2677 
ªt
 = 
	`båfs_åunˇã_block
(
	`BTRFS_I
(
öode
), 
off£t
, 0, 0);

2678 i‡(
ªt
) {

2679 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
BTRFS_ILOCK_MMAP
);

2680  
ªt
;

2688 i‡(
off£t
 =
‹ig_°¨t
) {

2690 
Àn
 = 
off£t
 +Üí - 
lock°¨t
;

2691 
off£t
 = 
lock°¨t
;

2692 
ªt
 = 
	`föd_fú°_n⁄_hﬁe
(
	`BTRFS_I
(
öode
), &
off£t
, &
Àn
);

2693 i‡(
ªt
 < 0)

2694 
out_⁄ly_muãx
;

2695 i‡(
ªt
 && !
Àn
) {

2696 
ªt
 = 0;

2697 
out_⁄ly_muãx
;

2699 
lock°¨t
 = 
off£t
;

2703 
èû_°¨t
 = 
lockíd
 + 1;

2704 
èû_Àn
 = 
off£t
 + 
Àn
 - 
èû_°¨t
;

2705 i‡(
èû_Àn
) {

2706 
ªt
 = 
	`föd_fú°_n⁄_hﬁe
(
	`BTRFS_I
(
öode
), &
èû_°¨t
, &
èû_Àn
);

2707 i‡(
	`u∆ikñy
(
ªt
 < 0))

2708 
out_⁄ly_muãx
;

2709 i‡(!
ªt
) {

2711 i‡(
èû_°¨t
 + 
èû_Àn
 < 
öo_size
) {

2712 
åunˇãd_block
 = 
åue
;

2713 
ªt
 = 
	`båfs_åunˇã_block
(
	`BTRFS_I
(
öode
),

2714 
èû_°¨t
 + 
èû_Àn
,

2716 i‡(
ªt
)

2717 
out_⁄ly_muãx
;

2722 i‡(
lockíd
 < 
lock°¨t
) {

2723 
ªt
 = 0;

2724 
out_⁄ly_muãx
;

2727 
	`båfs_punch_hﬁe_lock_ønge
(
öode
, 
lock°¨t
, 
lockíd
, &
ˇched_°©e
);

2729 
∑th
 = 
	`båfs_Æloc_∑th
();

2730 i‡(!
∑th
) {

2731 
ªt
 = -
ENOMEM
;

2732 
out
;

2735 
ªt
 = 
	`båfs_ª∂a˚_fûe_exã¡s
(
	`BTRFS_I
(
öode
), 
∑th
, 
lock°¨t
,

2736 
lockíd
, 
NULL
, &
å™s
);

2737 
	`båfs_‰ì_∑th
(
∑th
);

2738 i‡(
ªt
)

2739 
out
;

2741 
	`ASSERT
(
å™s
 !
NULL
);

2742 
	`öode_öc_ivîsi⁄
(
öode
);

2743 
öode
->
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(inode);

2744 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

2745 
upd©ed_öode
 = 
åue
;

2746 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

2747 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

2748 
out
:

2749 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
lock°¨t
, 
lockíd
,

2750 &
ˇched_°©e
);

2751 
out_⁄ly_muãx
:

2752 i‡(!
upd©ed_öode
 && 
åunˇãd_block
 && !
ªt
) {

2760 
time•ec64
 
now
 = 
	`öode_£t_˘ime_cuºít
(
öode
);

2762 
	`öode_öc_ivîsi⁄
(
öode
);

2763 
öode
->
i_mtime
 = 
now
;

2764 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 1);

2765 i‡(
	`IS_ERR
(
å™s
)) {

2766 
ªt
 = 
	`PTR_ERR
(
å™s
);

2768 
ªt2
;

2770 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

2771 
ªt2
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

2772 i‡(!
ªt
)

2773 
ªt
 = 
ªt2
;

2776 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
BTRFS_ILOCK_MMAP
);

2777  
ªt
;

2778 
	}
}

2781 
	sÁŒoc_ønge
 {

2782 
li°_hód
 
	mli°
;

2783 
u64
 
	m°¨t
;

2784 
u64
 
	mÀn
;

2793 
	$add_ÁŒoc_ønge
(
li°_hód
 *
hód
, 
u64
 
°¨t
, u64 
Àn
)

2795 
ÁŒoc_ønge
 *
ønge
 = 
NULL
;

2797 i‡(!
	`li°_em±y
(
hód
)) {

2802 
ønge
 = 
	`li°_œ°_íåy
(
hód
, 
ÁŒoc_ønge
, 
li°
);

2803 i‡(
ønge
->
°¨t
 +Ñ™ge->
Àn
 == start) {

2804 
ønge
->
Àn
 +=Üen;

2809 
ønge
 = 
	`kmÆloc
((*ønge), 
GFP_KERNEL
);

2810 i‡(!
ønge
)

2811  -
ENOMEM
;

2812 
ønge
->
°¨t
 = start;

2813 
ønge
->
Àn
 =Üen;

2814 
	`li°_add_èû
(&
ønge
->
li°
, 
hód
);

2816 
	}
}

2818 
	$båfs_ÁŒoˇã_upd©e_isize
(
öode
 *inode,

2819 c⁄° 
u64
 
íd
,

2820 c⁄° 
mode
)

2822 
båfs_å™s_h™dÀ
 *
å™s
;

2823 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

2824 
ªt
;

2825 
ªt2
;

2827 i‡(
mode
 & 
FALLOC_FL_KEEP_SIZE
 || 
íd
 <
	`i_size_ªad
(
öode
))

2830 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 1);

2831 i‡(
	`IS_ERR
(
å™s
))

2832  
	`PTR_ERR
(
å™s
);

2834 
	`öode_£t_˘ime_cuºít
(
öode
);

2835 
	`i_size_wrôe
(
öode
, 
íd
);

2836 
	`båfs_öode_ß„_disk_i_size_wrôe
(
	`BTRFS_I
(
öode
), 0);

2837 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

2838 
ªt2
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

2840  
ªt
 ?Ñë : 
ªt2
;

2841 
	}
}

2844 
	mRANGE_BOUNDARY_WRITTEN_EXTENT
,

2845 
	mRANGE_BOUNDARY_PREALLOC_EXTENT
,

2846 
	mRANGE_BOUNDARY_HOLE
,

2849 
	$båfs_zîo_ønge_check_ønge_bound¨y
(
båfs_öode
 *
öode
,

2850 
u64
 
off£t
)

2852 c⁄° 
u64
 
£˘‹size
 = 
öode
->
roŸ
->
fs_öfo
->sectorsize;

2853 
exã¡_m≠
 *
em
;

2854 
ªt
;

2856 
off£t
 = 
	`round_down
(off£t, 
£˘‹size
);

2857 
em
 = 
	`båfs_gë_exã¡
(
öode
, 
NULL
, 0, 
off£t
, 
£˘‹size
);

2858 i‡(
	`IS_ERR
(
em
))

2859  
	`PTR_ERR
(
em
);

2861 i‡(
em
->
block_°¨t
 =
EXTENT_MAP_HOLE
)

2862 
ªt
 = 
RANGE_BOUNDARY_HOLE
;

2863 i‡(
	`ã°_bô
(
EXTENT_FLAG_PREALLOC
, &
em
->
Êags
))

2864 
ªt
 = 
RANGE_BOUNDARY_PREALLOC_EXTENT
;

2866 
ªt
 = 
RANGE_BOUNDARY_WRITTEN_EXTENT
;

2868 
	`‰ì_exã¡_m≠
(
em
);

2869  
ªt
;

2870 
	}
}

2872 
	$båfs_zîo_ønge
(
öode
 *inode,

2873 
loff_t
 
off£t
,

2874 
loff_t
 
Àn
,

2875 c⁄° 
mode
)

2877 
båfs_fs_öfo
 *
fs_öfo
 = 
	`BTRFS_I
(
öode
)->
roŸ
->fs_info;

2878 
exã¡_m≠
 *
em
;

2879 
exã¡_ch™ge£t
 *
d©a_ª£rved
 = 
NULL
;

2880 
ªt
;

2881 
u64
 
Æloc_höt
 = 0;

2882 c⁄° 
u64
 
£˘‹size
 = 
fs_öfo
->sectorsize;

2883 
u64
 
Æloc_°¨t
 = 
	`round_down
(
off£t
, 
£˘‹size
);

2884 
u64
 
Æloc_íd
 = 
	`round_up
(
off£t
 + 
Àn
, 
£˘‹size
);

2885 
u64
 
byãs_to_ª£rve
 = 0;

2886 
boﬁ
 
•a˚_ª£rved
 = 
Ál£
;

2888 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
Æloc_°¨t
,

2889 
Æloc_íd
 - 
Æloc_°¨t
);

2890 i‡(
	`IS_ERR
(
em
)) {

2891 
ªt
 = 
	`PTR_ERR
(
em
);

2892 
out
;

2903 i‡(
em
->
°¨t
 <
Æloc_°¨t
 &&

2904 
	`ã°_bô
(
EXTENT_FLAG_PREALLOC
, &
em
->
Êags
)) {

2905 c⁄° 
u64
 
em_íd
 = 
em
->
°¨t
 +Ém->
Àn
;

2907 i‡(
em_íd
 >
off£t
 + 
Àn
) {

2913 
	`‰ì_exã¡_m≠
(
em
);

2914 
ªt
 = 
	`båfs_ÁŒoˇã_upd©e_isize
(
öode
, 
off£t
 + 
Àn
,

2915 
mode
);

2916 
out
;

2922 
Æloc_°¨t
 = 
em_íd
;

2923 
	`ASSERT
(
	`IS_ALIGNED
(
Æloc_°¨t
, 
£˘‹size
));

2924 
Àn
 = 
off£t
 +Üí - 
Æloc_°¨t
;

2925 
off£t
 = 
Æloc_°¨t
;

2926 
Æloc_höt
 = 
em
->
block_°¨t
 +Ém->
Àn
;

2928 
	`‰ì_exã¡_m≠
(
em
);

2930 i‡(
	`BTRFS_BYTES_TO_BLKS
(
fs_öfo
, 
off£t
) ==

2931 
	`BTRFS_BYTES_TO_BLKS
(
fs_öfo
, 
off£t
 + 
Àn
 - 1)) {

2932 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
Æloc_°¨t
,

2933 
£˘‹size
);

2934 i‡(
	`IS_ERR
(
em
)) {

2935 
ªt
 = 
	`PTR_ERR
(
em
);

2936 
out
;

2939 i‡(
	`ã°_bô
(
EXTENT_FLAG_PREALLOC
, &
em
->
Êags
)) {

2940 
	`‰ì_exã¡_m≠
(
em
);

2941 
ªt
 = 
	`båfs_ÁŒoˇã_upd©e_isize
(
öode
, 
off£t
 + 
Àn
,

2942 
mode
);

2943 
out
;

2945 i‡(
Àn
 < 
£˘‹size
 && 
em
->
block_°¨t
 !
EXTENT_MAP_HOLE
) {

2946 
	`‰ì_exã¡_m≠
(
em
);

2947 
ªt
 = 
	`båfs_åunˇã_block
(
	`BTRFS_I
(
öode
), 
off£t
, 
Àn
,

2949 i‡(!
ªt
)

2950 
ªt
 = 
	`båfs_ÁŒoˇã_upd©e_isize
(
öode
,

2951 
off£t
 + 
Àn
,

2952 
mode
);

2953  
ªt
;

2955 
	`‰ì_exã¡_m≠
(
em
);

2956 
Æloc_°¨t
 = 
	`round_down
(
off£t
, 
£˘‹size
);

2957 
Æloc_íd
 = 
Æloc_°¨t
 + 
£˘‹size
;

2958 
ª£rve_•a˚
;

2961 
Æloc_°¨t
 = 
	`round_up
(
off£t
, 
£˘‹size
);

2962 
Æloc_íd
 = 
	`round_down
(
off£t
 + 
Àn
, 
£˘‹size
);

2970 i‡(!
	`IS_ALIGNED
(
off£t
, 
£˘‹size
)) {

2971 
ªt
 = 
	`båfs_zîo_ønge_check_ønge_bound¨y
(
	`BTRFS_I
(
öode
),

2972 
off£t
);

2973 i‡(
ªt
 < 0)

2974 
out
;

2975 i‡(
ªt
 =
RANGE_BOUNDARY_HOLE
) {

2976 
Æloc_°¨t
 = 
	`round_down
(
off£t
, 
£˘‹size
);

2977 
ªt
 = 0;

2978 } i‡(
ªt
 =
RANGE_BOUNDARY_WRITTEN_EXTENT
) {

2979 
ªt
 = 
	`båfs_åunˇã_block
(
	`BTRFS_I
(
öode
), 
off£t
, 0, 0);

2980 i‡(
ªt
)

2981 
out
;

2983 
ªt
 = 0;

2987 i‡(!
	`IS_ALIGNED
(
off£t
 + 
Àn
, 
£˘‹size
)) {

2988 
ªt
 = 
	`båfs_zîo_ønge_check_ønge_bound¨y
(
	`BTRFS_I
(
öode
),

2989 
off£t
 + 
Àn
);

2990 i‡(
ªt
 < 0)

2991 
out
;

2992 i‡(
ªt
 =
RANGE_BOUNDARY_HOLE
) {

2993 
Æloc_íd
 = 
	`round_up
(
off£t
 + 
Àn
, 
£˘‹size
);

2994 
ªt
 = 0;

2995 } i‡(
ªt
 =
RANGE_BOUNDARY_WRITTEN_EXTENT
) {

2996 
ªt
 = 
	`båfs_åunˇã_block
(
	`BTRFS_I
(
öode
), 
off£t
 + 
Àn
,

2998 i‡(
ªt
)

2999 
out
;

3001 
ªt
 = 0;

3005 
ª£rve_•a˚
:

3006 i‡(
Æloc_°¨t
 < 
Æloc_íd
) {

3007 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

3008 c⁄° 
u64
 
lock°¨t
 = 
Æloc_°¨t
;

3009 c⁄° 
u64
 
lockíd
 = 
Æloc_íd
 - 1;

3011 
byãs_to_ª£rve
 = 
Æloc_íd
 - 
Æloc_°¨t
;

3012 
ªt
 = 
	`båfs_Æloc_d©a_chunk_⁄dem™d
(
	`BTRFS_I
(
öode
),

3013 
byãs_to_ª£rve
);

3014 i‡(
ªt
 < 0)

3015 
out
;

3016 
•a˚_ª£rved
 = 
åue
;

3017 
	`båfs_punch_hﬁe_lock_ønge
(
öode
, 
lock°¨t
, 
lockíd
,

3018 &
ˇched_°©e
);

3019 
ªt
 = 
	`båfs_qgroup_ª£rve_d©a
(
	`BTRFS_I
(
öode
), &
d©a_ª£rved
,

3020 
Æloc_°¨t
, 
byãs_to_ª£rve
);

3021 i‡(
ªt
) {

3022 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
lock°¨t
,

3023 
lockíd
, &
ˇched_°©e
);

3024 
out
;

3026 
ªt
 = 
	`båfs_¥óŒoc_fûe_ønge
(
öode
, 
mode
, 
Æloc_°¨t
,

3027 
Æloc_íd
 - 
Æloc_°¨t
,

3028 
	`i_blocksize
(
öode
),

3029 
off£t
 + 
Àn
, &
Æloc_höt
);

3030 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
lock°¨t
, 
lockíd
,

3031 &
ˇched_°©e
);

3033 i‡(
ªt
) {

3034 
•a˚_ª£rved
 = 
Ál£
;

3035 
out
;

3038 
ªt
 = 
	`båfs_ÁŒoˇã_upd©e_isize
(
öode
, 
off£t
 + 
Àn
, 
mode
);

3039 
out
:

3040 i‡(
ªt
 && 
•a˚_ª£rved
)

3041 
	`båfs_‰ì_ª£rved_d©a_•a˚
(
	`BTRFS_I
(
öode
), 
d©a_ª£rved
,

3042 
Æloc_°¨t
, 
byãs_to_ª£rve
);

3043 
	`exã¡_ch™ge£t_‰ì
(
d©a_ª£rved
);

3045  
ªt
;

3046 
	}
}

3048 
	$båfs_ÁŒoˇã
(
fûe
 *fûe, 
mode
,

3049 
loff_t
 
off£t
,Üoff_à
Àn
)

3051 
öode
 *öodê
	`fûe_öode
(
fûe
);

3052 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

3053 
exã¡_ch™ge£t
 *
d©a_ª£rved
 = 
NULL
;

3054 
ÁŒoc_ønge
 *
ønge
;

3055 
ÁŒoc_ønge
 *
tmp
;

3056 
	`LIST_HEAD
(
ª£rve_li°
);

3057 
u64
 
cur_off£t
;

3058 
u64
 
œ°_byã
;

3059 
u64
 
Æloc_°¨t
;

3060 
u64
 
Æloc_íd
;

3061 
u64
 
Æloc_höt
 = 0;

3062 
u64
 
locked_íd
;

3063 
u64
 
a˘uÆ_íd
 = 0;

3064 
u64
 
d©a_•a˚_√eded
 = 0;

3065 
u64
 
d©a_•a˚_ª£rved
 = 0;

3066 
u64
 
qgroup_ª£rved
 = 0;

3067 
exã¡_m≠
 *
em
;

3068 
blocksize
 = 
	`BTRFS_I
(
öode
)->
roŸ
->
fs_öfo
->
£˘‹size
;

3069 
ªt
;

3072 i‡(
	`båfs_is_z⁄ed
(
	`båfs_sb
(
öode
->
i_sb
)))

3073  -
EOPNOTSUPP
;

3075 
Æloc_°¨t
 = 
	`round_down
(
off£t
, 
blocksize
);

3076 
Æloc_íd
 = 
	`round_up
(
off£t
 + 
Àn
, 
blocksize
);

3077 
cur_off£t
 = 
Æloc_°¨t
;

3080 i‡(
mode
 & ~(
FALLOC_FL_KEEP_SIZE
 | 
FALLOC_FL_PUNCH_HOLE
 |

3081 
FALLOC_FL_ZERO_RANGE
))

3082  -
EOPNOTSUPP
;

3084 i‡(
mode
 & 
FALLOC_FL_PUNCH_HOLE
)

3085  
	`båfs_punch_hﬁe
(
fûe
, 
off£t
, 
Àn
);

3087 
	`båfs_öode_lock
(
	`BTRFS_I
(
öode
), 
BTRFS_ILOCK_MMAP
);

3089 i‡(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
Ë&& 
off£t
 + 
Àn
 > 
öode
->
i_size
) {

3090 
ªt
 = 
	`öode_√wsize_ok
(
öode
, 
off£t
 + 
Àn
);

3091 i‡(
ªt
)

3092 
out
;

3095 
ªt
 = 
	`fûe_modifõd
(
fûe
);

3096 i‡(
ªt
)

3097 
out
;

3106 i‡(
Æloc_°¨t
 > 
öode
->
i_size
) {

3107 
ªt
 = 
	`båfs_c⁄t_ex∑nd
(
	`BTRFS_I
(
öode
), 
	`i_size_ªad
(inode),

3108 
Æloc_°¨t
);

3109 i‡(
ªt
)

3110 
out
;

3111 } i‡(
off£t
 + 
Àn
 > 
öode
->
i_size
) {

3117 
ªt
 = 
	`båfs_åunˇã_block
(
	`BTRFS_I
(
öode
), inode->
i_size
, 0, 0);

3118 i‡(
ªt
)

3119 
out
;

3130 
ªt
 = 
	`båfs_waô_‹dîed_ønge
(
öode
, 
Æloc_°¨t
,

3131 
Æloc_íd
 - 
Æloc_°¨t
);

3132 i‡(
ªt
)

3133 
out
;

3135 i‡(
mode
 & 
FALLOC_FL_ZERO_RANGE
) {

3136 
ªt
 = 
	`båfs_zîo_ønge
(
öode
, 
off£t
, 
Àn
, 
mode
);

3137 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
BTRFS_ILOCK_MMAP
);

3138  
ªt
;

3141 
locked_íd
 = 
Æloc_íd
 - 1;

3142 
	`lock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
Æloc_°¨t
, 
locked_íd
,

3143 &
ˇched_°©e
);

3145 
	`båfs_as£π_öode_ønge_˛ón
(
	`BTRFS_I
(
öode
), 
Æloc_°¨t
, 
locked_íd
);

3148 
cur_off£t
 < 
Æloc_íd
) {

3149 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
cur_off£t
,

3150 
Æloc_íd
 - 
cur_off£t
);

3151 i‡(
	`IS_ERR
(
em
)) {

3152 
ªt
 = 
	`PTR_ERR
(
em
);

3155 
œ°_byã
 = 
	`mö
(
	`exã¡_m≠_íd
(
em
), 
Æloc_íd
);

3156 
a˘uÆ_íd
 = 
	`mö_t
(
u64
, 
	`exã¡_m≠_íd
(
em
), 
off£t
 + 
Àn
);

3157 
œ°_byã
 = 
	`ALIGN
÷a°_byã, 
blocksize
);

3158 i‡(
em
->
block_°¨t
 =
EXTENT_MAP_HOLE
 ||

3159 (
cur_off£t
 >
öode
->
i_size
 &&

3160 !
	`ã°_bô
(
EXTENT_FLAG_PREALLOC
, &
em
->
Êags
))) {

3161 c⁄° 
u64
 
ønge_Àn
 = 
œ°_byã
 - 
cur_off£t
;

3163 
ªt
 = 
	`add_ÁŒoc_ønge
(&
ª£rve_li°
, 
cur_off£t
, 
ønge_Àn
);

3164 i‡(
ªt
 < 0) {

3165 
	`‰ì_exã¡_m≠
(
em
);

3168 
ªt
 = 
	`båfs_qgroup_ª£rve_d©a
(
	`BTRFS_I
(
öode
),

3169 &
d©a_ª£rved
, 
cur_off£t
, 
ønge_Àn
);

3170 i‡(
ªt
 < 0) {

3171 
	`‰ì_exã¡_m≠
(
em
);

3174 
qgroup_ª£rved
 +
ønge_Àn
;

3175 
d©a_•a˚_√eded
 +
ønge_Àn
;

3177 
	`‰ì_exã¡_m≠
(
em
);

3178 
cur_off£t
 = 
œ°_byã
;

3181 i‡(!
ªt
 && 
d©a_•a˚_√eded
 > 0) {

3186 
ªt
 = 
	`båfs_Æloc_d©a_chunk_⁄dem™d
(
	`BTRFS_I
(
öode
),

3187 
d©a_•a˚_√eded
);

3188 i‡(!
ªt
)

3189 
d©a_•a˚_ª£rved
 = 
d©a_•a˚_√eded
;

3196 
	`li°_f‹_óch_íåy_ß„
(
ønge
, 
tmp
, &
ª£rve_li°
, 
li°
) {

3197 i‡(!
ªt
) {

3198 
ªt
 = 
	`båfs_¥óŒoc_fûe_ønge
(
öode
, 
mode
,

3199 
ønge
->
°¨t
,

3200 
ønge
->
Àn
, 
	`i_blocksize
(
öode
),

3201 
off£t
 + 
Àn
, &
Æloc_höt
);

3206 
d©a_•a˚_ª£rved
 -
ønge
->
Àn
;

3207 
qgroup_ª£rved
 -
ønge
->
Àn
;

3208 } i‡(
d©a_•a˚_ª£rved
 > 0) {

3209 
	`båfs_‰ì_ª£rved_d©a_•a˚
(
	`BTRFS_I
(
öode
),

3210 
d©a_ª£rved
, 
ønge
->
°¨t
,

3211 
ønge
->
Àn
);

3212 
d©a_•a˚_ª£rved
 -
ønge
->
Àn
;

3213 
qgroup_ª£rved
 -
ønge
->
Àn
;

3214 } i‡(
qgroup_ª£rved
 > 0) {

3215 
	`båfs_qgroup_‰ì_d©a
(
	`BTRFS_I
(
öode
), 
d©a_ª£rved
,

3216 
ønge
->
°¨t
,Ñ™ge->
Àn
, 
NULL
);

3217 
qgroup_ª£rved
 -
ønge
->
Àn
;

3219 
	`li°_dñ
(&
ønge
->
li°
);

3220 
	`k‰ì
(
ønge
);

3222 i‡(
ªt
 < 0)

3223 
out_u∆ock
;

3229 
ªt
 = 
	`båfs_ÁŒoˇã_upd©e_isize
(
öode
, 
a˘uÆ_íd
, 
mode
);

3230 
out_u∆ock
:

3231 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
Æloc_°¨t
, 
locked_íd
,

3232 &
ˇched_°©e
);

3233 
out
:

3234 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
BTRFS_ILOCK_MMAP
);

3235 
	`exã¡_ch™ge£t_‰ì
(
d©a_ª£rved
);

3236  
ªt
;

3237 
	}
}

3245 
boﬁ
 
	$föd_dñÆloc_subønge
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
,

3246 
exã¡_°©e
 **
ˇched_°©e
,

3247 
boﬁ
 *
£¨ch_io_åì
,

3248 
u64
 *
dñÆloc_°¨t_ªt
, u64 *
dñÆloc_íd_ªt
)

3250 
u64
 
Àn
 = 
íd
 + 1 - 
°¨t
;

3251 
u64
 
dñÆloc_Àn
 = 0;

3252 
båfs_‹dîed_exã¡
 *
€
;

3253 
u64
 
€_°¨t
;

3254 
u64
 
€_íd
;

3261 i‡(*
£¨ch_io_åì
) {

3262 
	`•ö_lock
(&
öode
->
lock
);

3263 i‡(
öode
->
dñÆloc_byãs
 > 0) {

3264 
	`•ö_u∆ock
(&
öode
->
lock
);

3265 *
dñÆloc_°¨t_ªt
 = 
°¨t
;

3266 
dñÆloc_Àn
 = 
	`cou¡_ønge_bôs
(&
öode
->
io_åì
,

3267 
dñÆloc_°¨t_ªt
, 
íd
,

3268 
Àn
, 
EXTENT_DELALLOC
, 1,

3269 
ˇched_°©e
);

3271 
	`•ö_u∆ock
(&
öode
->
lock
);

3275 i‡(
dñÆloc_Àn
 > 0) {

3280 *
dñÆloc_íd_ªt
 = *
dñÆloc_°¨t_ªt
 + 
dñÆloc_Àn
 - 1;

3282 i‡(*
dñÆloc_°¨t_ªt
 =
°¨t
) {

3284 i‡(*
dñÆloc_íd_ªt
 =
íd
)

3285  
åue
;

3287 
°¨t
 = *
dñÆloc_íd_ªt
 + 1;

3288 
Àn
 = 
íd
 + 1 - 
°¨t
;

3292 *
£¨ch_io_åì
 = 
Ál£
;

3316 
€
 = 
	`båfs_lookup_fú°_‹dîed_ønge
(
öode
, 
°¨t
, 
Àn
);

3317 i‡(!
€
)

3318  (
dñÆloc_Àn
 > 0);

3321 
€_°¨t
 = 
	`max
(
€
->
fûe_off£t
, 
°¨t
);

3322 
€_íd
 = 
	`mö
(
€
->
fûe_off£t
 + oe->
num_byãs
 - 1, 
íd
);

3324 
	`båfs_put_‹dîed_exã¡
(
€
);

3327 i‡(
dñÆloc_Àn
 == 0) {

3328 *
dñÆloc_°¨t_ªt
 = 
€_°¨t
;

3329 *
dñÆloc_íd_ªt
 = 
€_íd
;

3330  
åue
;

3338 i‡(
€_°¨t
 < *
dñÆloc_°¨t_ªt
) {

3339 i‡(
€_íd
 < *
dñÆloc_°¨t_ªt
)

3340 *
dñÆloc_íd_ªt
 = 
€_íd
;

3341 *
dñÆloc_°¨t_ªt
 = 
€_°¨t
;

3342 } i‡(*
dñÆloc_íd_ªt
 + 1 =
€_°¨t
) {

3343 *
dñÆloc_íd_ªt
 = 
€_íd
;

3346  
åue
;

3347 
	}
}

3369 
boﬁ
 
	$båfs_föd_dñÆloc_ö_ønge
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
,

3370 
exã¡_°©e
 **
ˇched_°©e
,

3371 
u64
 *
dñÆloc_°¨t_ªt
, u64 *
dñÆloc_íd_ªt
)

3373 
u64
 
cur_off£t
 = 
	`round_down
(
°¨t
, 
öode
->
roŸ
->
fs_öfo
->
£˘‹size
);

3374 
u64
 
¥ev_dñÆloc_íd
 = 0;

3375 
boﬁ
 
£¨ch_io_åì
 = 
åue
;

3376 
boﬁ
 
ªt
 = 
Ál£
;

3378 
cur_off£t
 <
íd
) {

3379 
u64
 
dñÆloc_°¨t
;

3380 
u64
 
dñÆloc_íd
;

3381 
boﬁ
 
dñÆloc
;

3383 
dñÆloc
 = 
	`föd_dñÆloc_subønge
(
öode
, 
cur_off£t
, 
íd
,

3384 
ˇched_°©e
, &
£¨ch_io_åì
,

3385 &
dñÆloc_°¨t
,

3386 &
dñÆloc_íd
);

3387 i‡(!
dñÆloc
)

3390 i‡(
¥ev_dñÆloc_íd
 == 0) {

3392 *
dñÆloc_°¨t_ªt
 = 
	`max
(
dñÆloc_°¨t
, 
°¨t
);

3393 *
dñÆloc_íd_ªt
 = 
dñÆloc_íd
;

3394 
ªt
 = 
åue
;

3395 } i‡(
dñÆloc_°¨t
 =
¥ev_dñÆloc_íd
 + 1) {

3397 *
dñÆloc_íd_ªt
 = 
dñÆloc_íd
;

3403 
¥ev_dñÆloc_íd
 = 
dñÆloc_íd
;

3404 
cur_off£t
 = 
dñÆloc_íd
 + 1;

3405 
	`c⁄d_ªsched
();

3408  
ªt
;

3409 
	}
}

3429 
boﬁ
 
	$föd_desúed_exã¡_ö_hﬁe
(
båfs_öode
 *
öode
, 
whí˚
,

3430 
exã¡_°©e
 **
ˇched_°©e
,

3431 
u64
 
°¨t
, u64 
íd
, u64 *
°¨t_ªt
)

3433 
u64
 
dñÆloc_°¨t
;

3434 
u64
 
dñÆloc_íd
;

3435 
boﬁ
 
dñÆloc
;

3437 
dñÆloc
 = 
	`båfs_föd_dñÆloc_ö_ønge
(
öode
, 
°¨t
, 
íd
, 
ˇched_°©e
,

3438 &
dñÆloc_°¨t
, &
dñÆloc_íd
);

3439 i‡(
dñÆloc
 && 
whí˚
 =
SEEK_DATA
) {

3440 *
°¨t_ªt
 = 
dñÆloc_°¨t
;

3441  
åue
;

3444 i‡(
dñÆloc
 && 
whí˚
 =
SEEK_HOLE
) {

3449 i‡(
°¨t
 < 
dñÆloc_°¨t
) {

3450 *
°¨t_ªt
 = 
°¨t
;

3451  
åue
;

3459 i‡(
dñÆloc_íd
 < 
íd
) {

3460 *
°¨t_ªt
 = 
dñÆloc_íd
 + 1;

3461  
åue
;

3465  
Ál£
;

3468 i‡(!
dñÆloc
 && 
whí˚
 =
SEEK_HOLE
) {

3469 *
°¨t_ªt
 = 
°¨t
;

3470  
åue
;

3477  
Ál£
;

3478 
	}
}

3480 
loff_t
 
	$föd_desúed_exã¡
(
fûe
 *fûe, 
loff_t
 
off£t
, 
whí˚
)

3482 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
fûe
->
f_m≠pög
->
ho°
);

3483 
båfs_fûe_¥iv©e
 *
¥iv©e
 = 
fûe
->
¥iv©e_d©a
;

3484 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

3485 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

3486 
exã¡_°©e
 **
dñÆloc_ˇched_°©e
;

3487 c⁄° 
loff_t
 
i_size
 = 
	`i_size_ªad
(&
öode
->
vfs_öode
);

3488 c⁄° 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

3489 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

3490 
båfs_∑th
 *
∑th
;

3491 
båfs_key
 
key
;

3492 
u64
 
œ°_exã¡_íd
;

3493 
u64
 
lock°¨t
;

3494 
u64
 
lockíd
;

3495 
u64
 
°¨t
;

3496 
ªt
;

3497 
boﬁ
 
found
 = 
Ál£
;

3499 i‡(
i_size
 =0 || 
off£t
 >= i_size)

3500  -
ENXIO
;

3506 i‡(
whí˚
 =
SEEK_HOLE
 &&

3507 !(
öode
->
Êags
 & 
BTRFS_INODE_PREALLOC
) &&

3508 
	`öode_gë_byãs
(&
öode
->
vfs_öode
Ë=
i_size
)

3509  
i_size
;

3511 i‡(!
¥iv©e
) {

3512 
¥iv©e
 = 
	`kzÆloc
((*¥iv©e), 
GFP_KERNEL
);

3519 
fûe
->
¥iv©e_d©a
 = 
¥iv©e
;

3522 i‡(
¥iv©e
)

3523 
dñÆloc_ˇched_°©e
 = &
¥iv©e
->
Œ£ek_ˇched_°©e
;

3525 
dñÆloc_ˇched_°©e
 = 
NULL
;

3531 
°¨t
 = 
	`max_t
(
loff_t
, 0, 
off£t
);

3533 
lock°¨t
 = 
	`round_down
(
°¨t
, 
fs_öfo
->
£˘‹size
);

3534 
lockíd
 = 
	`round_up
(
i_size
, 
fs_öfo
->
£˘‹size
);

3535 i‡(
lockíd
 <
lock°¨t
)

3536 
lockíd
 = 
lock°¨t
 + 
fs_öfo
->
£˘‹size
;

3537 
lockíd
--;

3539 
∑th
 = 
	`båfs_Æloc_∑th
();

3540 i‡(!
∑th
)

3541  -
ENOMEM
;

3542 
∑th
->
ªada
 = 
READA_FORWARD
;

3544 
key
.
obje˘id
 = 
öo
;

3545 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

3546 
key
.
off£t
 = 
°¨t
;

3548 
œ°_exã¡_íd
 = 
lock°¨t
;

3550 
	`lock_exã¡
(&
öode
->
io_åì
, 
lock°¨t
, 
lockíd
, &
ˇched_°©e
);

3552 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

3553 i‡(
ªt
 < 0) {

3554 
out
;

3555 } i‡(
ªt
 > 0 && 
∑th
->
¶Ÿs
[0] > 0) {

3556 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0] - 1);

3557 i‡(
key
.
obje˘id
 =
öo
 && key.
ty≥
 =
BTRFS_EXTENT_DATA_KEY
)

3558 
∑th
->
¶Ÿs
[0]--;

3561 
°¨t
 < 
i_size
) {

3562 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

3563 
båfs_fûe_exã¡_ôem
 *
exã¡
;

3564 
u64
 
exã¡_íd
;

3565 
u8
 
ty≥
;

3567 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
(
Àaf
)) {

3568 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

3569 i‡(
ªt
 < 0)

3570 
out
;

3571 i‡(
ªt
 > 0)

3574 
Àaf
 = 
∑th
->
nodes
[0];

3577 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

3578 i‡(
key
.
obje˘id
 !
öo
 || key.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

3581 
exã¡_íd
 = 
	`båfs_fûe_exã¡_íd
(
∑th
);

3587 i‡(
exã¡_íd
 <
°¨t
) {

3588 
∑th
->
¶Ÿs
[0]++;

3593 i‡(
œ°_exã¡_íd
 < 
key
.
off£t
) {

3594 
u64
 
£¨ch_°¨t
 = 
œ°_exã¡_íd
;

3595 
u64
 
found_°¨t
;

3601 i‡(
°¨t
 =
off£t
)

3602 
£¨ch_°¨t
 = 
off£t
;

3604 
found
 = 
	`föd_desúed_exã¡_ö_hﬁe
(
öode
, 
whí˚
,

3605 
dñÆloc_ˇched_°©e
,

3606 
£¨ch_°¨t
,

3607 
key
.
off£t
 - 1,

3608 &
found_°¨t
);

3609 i‡(
found
) {

3610 
°¨t
 = 
found_°¨t
;

3619 
exã¡
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

3620 
båfs_fûe_exã¡_ôem
);

3621 
ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
exã¡
);

3628 i‡(
ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
 ||

3629 (
ty≥
 =
BTRFS_FILE_EXTENT_REG
 &&

3630 
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
exã¡
) == 0)) {

3635 
u64
 
£¨ch_°¨t
 = 
key
.
off£t
;

3636 
u64
 
found_°¨t
;

3642 i‡(
°¨t
 =
off£t
)

3643 
£¨ch_°¨t
 = 
off£t
;

3645 
found
 = 
	`föd_desúed_exã¡_ö_hﬁe
(
öode
, 
whí˚
,

3646 
dñÆloc_ˇched_°©e
,

3647 
£¨ch_°¨t
,

3648 
exã¡_íd
 - 1,

3649 &
found_°¨t
);

3650 i‡(
found
) {

3651 
°¨t
 = 
found_°¨t
;

3665 i‡(
whí˚
 =
SEEK_DATA
) {

3666 
°¨t
 = 
	`max_t
(
u64
, 
key
.
off£t
, offset);

3667 
found
 = 
åue
;

3676 
°¨t
 = 
exã¡_íd
;

3677 
œ°_exã¡_íd
 = 
exã¡_íd
;

3678 
∑th
->
¶Ÿs
[0]++;

3679 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

3680 
ªt
 = -
EINTR
;

3681 
out
;

3683 
	`c⁄d_ªsched
();

3687 i‡(!
found
 && 
°¨t
 < 
i_size
) {

3688 
found
 = 
	`föd_desúed_exã¡_ö_hﬁe
(
öode
, 
whí˚
,

3689 
dñÆloc_ˇched_°©e
, 
°¨t
,

3690 
i_size
 - 1, &
°¨t
);

3691 i‡(!
found
)

3692 
°¨t
 = 
i_size
;

3695 
out
:

3696 
	`u∆ock_exã¡
(&
öode
->
io_åì
, 
lock°¨t
, 
lockíd
, &
ˇched_°©e
);

3697 
	`båfs_‰ì_∑th
(
∑th
);

3699 i‡(
ªt
 < 0)

3700  
ªt
;

3702 i‡(
whí˚
 =
SEEK_DATA
 && 
°¨t
 >
i_size
)

3703  -
ENXIO
;

3705  
	`mö_t
(
loff_t
, 
°¨t
, 
i_size
);

3706 
	}
}

3708 
loff_t
 
	$båfs_fûe_Œ£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
whí˚
)

3710 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

3711 
öode
 *
f_öode
;

3727 
whí˚
) {

3729  
	`gíîic_fûe_Œ£ek
(
fûe
, 
off£t
, 
whí˚
);

3730 
SEEK_DATA
:

3731 
SEEK_HOLE
:

3732 
	`båfs_öode_lock
(
	`BTRFS_I
(
öode
), 
BTRFS_ILOCK_SHARED
);

3734 
off£t
 = 
	`föd_desúed_exã¡
(
fûe
, off£t, 
whí˚
);

3735 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
BTRFS_ILOCK_SHARED
);

3739 i‡(
off£t
 < 0)

3740  
off£t
;

3742  
	`vfs_£ços
(
fûe
, 
off£t
, 
öode
->
i_sb
->
s_maxbyãs
);

3743 
	}
}

3745 
	$båfs_fûe_›í
(
öode
 *öode, 
fûe
 *
fûp
)

3747 
ªt
;

3798 
fûp
->
f_mode
 |
FMODE_NOWAIT
 | 
FMODE_BUF_RASYNC
 | 
FMODE_BUF_WASYNC
 |

3799 
FMODE_CAN_ODIRECT
;

3801 
ªt
 = 
	`fsvîôy_fûe_›í
(
öode
, 
fûp
);

3802 i‡(
ªt
) {

3804  
ªt
;

3807  
	`gíîic_fûe_›í
(
öode
, 
fûp
);

3808 
	}
}

3810 
	$check_dúe˘_ªad
(
båfs_fs_öfo
 *
fs_öfo
,

3811 c⁄° 
iov_ôî
 *
ôî
, 
loff_t
 
off£t
)

3813 
ªt
;

3814 
i
, 
£g
;

3816 
ªt
 = 
	`check_dúe˘_IO
(
fs_öfo
, 
ôî
, 
off£t
);

3817 i‡(
ªt
 < 0)

3818  
ªt
;

3820 i‡(!
	`ôî_is_iovec
(
ôî
))

3823 
£g
 = 0; seg < 
ôî
->
ƒ_£gs
; seg++) {

3824 
i
 = 
£g
 + 1; i < 
ôî
->
ƒ_£gs
; i++) {

3825 c⁄° 
iovec
 *
iov1
 = 
	`ôî_iov
(
ôî
Ë+ 
£g
;

3826 c⁄° 
iovec
 *
iov2
 = 
	`ôî_iov
(
ôî
Ë+ 
i
;

3828 i‡(
iov1
->
iov_ba£
 =
iov2
->iov_base)

3829  -
EINVAL
;

3833 
	}
}

3835 
ssize_t
 
	$båfs_dúe˘_ªad
(
kiocb
 *
iocb
, 
iov_ôî
 *
to
)

3837 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

3838 
size_t
 
¥ev_À·
 = 0;

3839 
ssize_t
 
ªad
 = 0;

3840 
ssize_t
 
ªt
;

3842 i‡(
	`fsvîôy_a˘ive
(
öode
))

3845 i‡(
	`check_dúe˘_ªad
(
	`båfs_sb
(
öode
->
i_sb
), 
to
, 
iocb
->
ki_pos
))

3848 
	`båfs_öode_lock
(
	`BTRFS_I
(
öode
), 
BTRFS_ILOCK_SHARED
);

3849 
agaö
:

3865 
	`∑geÁu…_dißbÀ
();

3866 
to
->
noÁu…
 = 
åue
;

3867 
ªt
 = 
	`båfs_dio_ªad
(
iocb
, 
to
, 
ªad
);

3868 
to
->
noÁu…
 = 
Ál£
;

3869 
	`∑geÁu…_íabÀ
();

3872 i‡(
ªt
 > 0)

3873 
ªad
 = 
ªt
;

3875 i‡(
	`iov_ôî_cou¡
(
to
Ë> 0 && (
ªt
 =-
EFAULT
 ||Ñet > 0)) {

3876 c⁄° 
size_t
 
À·
 = 
	`iov_ôî_cou¡
(
to
);

3878 i‡(
À·
 =
¥ev_À·
) {

3885 
ªt
 = 
ªad
;

3892 
	`Áu…_ö_iov_ôî_wrôóbÀ
(
to
, 
À·
);

3893 
¥ev_À·
 = 
À·
;

3894 
agaö
;

3897 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 
BTRFS_ILOCK_SHARED
);

3898  
ªt
 < 0 ?Ñë : 
ªad
;

3899 
	}
}

3901 
ssize_t
 
	$båfs_fûe_ªad_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
to
)

3903 
ssize_t
 
ªt
 = 0;

3906 
fûe
 *fûê
iocb
->
ki_fûp
;

3907 
addªss_•a˚
 *
m≠pög
 = 
fûe
->
f_m≠pög
;

3908 
öode
 *
f_öode
 = 
fûe
->f_inode;

3909 
ªmŸe
 = 
f_öode
->
has_ªmŸe
;

3939 i‡(
iocb
->
ki_Êags
 & 
IOCB_DIRECT
) {

3940 
ªt
 = 
	`båfs_dúe˘_ªad
(
iocb
, 
to
);

3941 i‡(
ªt
 < 0 || !
	`iov_ôî_cou¡
(
to
) ||

3942 
iocb
->
ki_pos
 >
	`i_size_ªad
(
	`fûe_öode
(iocb->
ki_fûp
)))

3944  
ªt
;

3948  
	`båfs_fûem≠_ªad
(
iocb
, 
to
, 
ªt
);

3949 
	}
}

3951 c⁄° 
fûe_›î©i⁄s
 
	gbåfs_fûe_›î©i⁄s
 = {

3952 .
Œ£ek
 = 
båfs_fûe_Œ£ek
,

3953 .
	gªad_ôî
 = 
båfs_fûe_ªad_ôî
,

3954 .
	g•li˚_ªad
 = 
fûem≠_•li˚_ªad
,

3955 .
	gwrôe_ôî
 = 
båfs_fûe_wrôe_ôî
,

3956 .
	g•li˚_wrôe
 = 
ôî_fûe_•li˚_wrôe
,

3957 .
	gmm≠
 = 
båfs_fûe_mm≠
,

3958 .
	g›í
 = 
båfs_fûe_›í
,

3959 .
	gªÀa£
 = 
båfs_ªÀa£_fûe
,

3960 .
	ggë_unm≠≥d_¨ó
 = 
thp_gë_unm≠≥d_¨ó
,

3961 .
	gfsync
 = 
båfs_sync_fûe
,

3962 .
	gÁŒoˇã
 = 
båfs_ÁŒoˇã
,

3963 .
	gu∆ocked_io˘l
 = 
båfs_io˘l
,

3964 #ifde‡
CONFIG_COMPAT


3965 .
	gcom∑t_io˘l
 = 
båfs_com∑t_io˘l
,

3967 .
	gªm≠_fûe_ønge
 = 
båfs_ªm≠_fûe_ønge
,

3970 
	$båfs_fd©awrôe_ønge
(
öode
 *öode, 
loff_t
 
°¨t
,Üoff_à
íd
)

3972 
ªt
;

3988 
ªt
 = 
	`fûem≠_fd©awrôe_ønge
(
öode
->
i_m≠pög
, 
°¨t
, 
íd
);

3989 i‡(!
ªt
 && 
	`ã°_bô
(
BTRFS_INODE_HAS_ASYNC_EXTENT
,

3990 &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
))

3991 
ªt
 = 
	`fûem≠_fd©awrôe_ønge
(
öode
->
i_m≠pög
, 
°¨t
, 
íd
);

3993  
ªt
;

3994 
	}
}

	@file.h

3 #i‚de‡
BTRFS_FILE_H


4 
	#BTRFS_FILE_H


	)

6 c⁄° 
fûe_›î©i⁄s
 
båfs_fûe_›î©i⁄s
;

8 
båfs_sync_fûe
(
fûe
 *fûe, 
loff_t
 
°¨t
,Üoff_à
íd
, 
d©async
);

9 
båfs_dr›_exã¡s
(
båfs_å™s_h™dÀ
 *
å™s
,

10 
båfs_roŸ
 *
roŸ
, 
båfs_öode
 *
öode
,

11 
båfs_dr›_exã¡s_¨gs
 *
¨gs
);

12 
båfs_ª∂a˚_fûe_exã¡s
(
båfs_öode
 *
öode
,

13 
båfs_∑th
 *
∑th
, c⁄° 
u64
 
°¨t
,

14 c⁄° 
u64
 
íd
,

15 
båfs_ª∂a˚_exã¡_öfo
 *
exã¡_öfo
,

16 
båfs_å™s_h™dÀ
 **
å™s_out
);

17 
båfs_m¨k_exã¡_wrôãn
(
båfs_å™s_h™dÀ
 *
å™s
,

18 
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
);

19 
ssize_t
 
båfs_do_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
,

20 c⁄° 
båfs_io˘l_ícoded_io_¨gs
 *
ícoded
);

21 
båfs_ªÀa£_fûe
(
öode
 *öode, 
fûe
 *file);

22 
båfs_dúty_∑ges
(
båfs_öode
 *
öode
, 
∑ge
 **
∑ges
,

23 
size_t
 
num_∑ges
, 
loff_t
 
pos
, size_à
wrôe_byãs
,

24 
exã¡_°©e
 **
ˇched
, 
boﬁ
 
n‹e£rve
);

25 
båfs_fd©awrôe_ønge
(
öode
 *öode, 
loff_t
 
°¨t
,Üoff_à
íd
);

26 
båfs_check_nocow_lock
(
båfs_öode
 *
öode
, 
loff_t
 
pos
,

27 
size_t
 *
wrôe_byãs
, 
boﬁ
 
nowaô
);

28 
båfs_check_nocow_u∆ock
(
båfs_öode
 *
öode
);

29 
boﬁ
 
båfs_föd_dñÆloc_ö_ønge
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
,

30 
exã¡_°©e
 **
ˇched_°©e
,

31 
u64
 *
dñÆloc_°¨t_ªt
, u64 *
dñÆloc_íd_ªt
);

	@free-space-cache.c

6 
	~<löux/∑gem≠.h
>

7 
	~<löux/sched.h
>

8 
	~<löux/sched/sig«l.h
>

9 
	~<löux/¶ab.h
>

10 
	~<löux/m©h64.h
>

11 
	~<löux/øãlimô.h
>

12 
	~<löux/îr‹-öje˘i⁄.h
>

13 
	~<löux/sched/mm.h
>

14 
	~"˘ªe.h
"

15 
	~"fs.h
"

16 
	~"mesßges.h
"

17 
	~"misc.h
"

18 
	~"‰ì-•a˚-ˇche.h
"

19 
	~"å™ß˘i⁄.h
"

20 
	~"disk-io.h
"

21 
	~"exã¡_io.h
"

22 
	~"vﬁumes.h
"

23 
	~"•a˚-öfo.h
"

24 
	~"dñÆloc-•a˚.h
"

25 
	~"block-group.h
"

26 
	~"disˇrd.h
"

27 
	~"sub∑ge.h
"

28 
	~"öode-ôem.h
"

29 
	~"ac˚ss‹s.h
"

30 
	~"fûe-ôem.h
"

31 
	~"fûe.h
"

32 
	~"su≥r.h
"

34 
	#BITS_PER_BITMAP
 (
PAGE_SIZE
 * 8UL)

	)

35 
	#MAX_CACHE_BYTES_PER_GIG
 
SZ_64K


	)

36 
	#FORCE_EXTENT_THRESHOLD
 
SZ_1M


	)

38 
kmem_ˇche
 *
	gbåfs_‰ì_•a˚_ˇchï
;

39 
kmem_ˇche
 *
	gbåfs_‰ì_•a˚_bôm≠_ˇchï
;

41 
	sbåfs_åim_ønge
 {

42 
u64
 
	m°¨t
;

43 
u64
 
	mbyãs
;

44 
li°_hód
 
	mli°
;

47 
lök_‰ì_•a˚
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

48 
båfs_‰ì_•a˚
 *
öfo
);

49 
u∆ök_‰ì_•a˚
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

50 
båfs_‰ì_•a˚
 *
öfo
, 
boﬁ
 
upd©e_°©
);

51 
£¨ch_bôm≠
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

52 
båfs_‰ì_•a˚
 *
bôm≠_öfo
, 
u64
 *
off£t
,

53 
u64
 *
byãs
, 
boﬁ
 
f‹_Æloc
);

54 
‰ì_bôm≠
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

55 
båfs_‰ì_•a˚
 *
bôm≠_öfo
);

56 
bôm≠_˛ór_bôs
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

57 
båfs_‰ì_•a˚
 *
öfo
, 
u64
 
off£t
,

58 
u64
 
byãs
, 
boﬁ
 
upd©e_°©s
);

60 
	$__båfs_ªmove_‰ì_•a˚_ˇche
(
båfs_‰ì_•a˚_˘l
 *
˘l
)

62 
båfs_‰ì_•a˚
 *
öfo
;

63 
rb_node
 *
node
;

65 (
node
 = 
	`rb_œ°
(&
˘l
->
‰ì_•a˚_off£t
)Ë!
NULL
) {

66 
öfo
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
, 
off£t_ödex
);

67 i‡(!
öfo
->
bôm≠
) {

68 
	`u∆ök_‰ì_•a˚
(
˘l
, 
öfo
, 
åue
);

69 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
öfo
);

71 
	`‰ì_bôm≠
(
˘l
, 
öfo
);

74 
	`c⁄d_ªsched_lock
(&
˘l
->
åì_lock
);

76 
	}
}

78 
öode
 *
	$__lookup_‰ì_•a˚_öode
(
båfs_roŸ
 *
roŸ
,

79 
båfs_∑th
 *
∑th
,

80 
u64
 
off£t
)

82 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

83 
båfs_key
 
key
;

84 
båfs_key
 
loˇti⁄
;

85 
båfs_disk_key
 
disk_key
;

86 
båfs_‰ì_•a˚_hódî
 *
hódî
;

87 
exã¡_buf„r
 *
Àaf
;

88 
öode
 *öodê
NULL
;

89 
nofs_Êag
;

90 
ªt
;

92 
key
.
obje˘id
 = 
BTRFS_FREE_SPACE_OBJECTID
;

93 
key
.
off£t
 = offset;

94 
key
.
ty≥
 = 0;

96 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

97 i‡(
ªt
 < 0)

98  
	`ERR_PTR
(
ªt
);

99 i‡(
ªt
 > 0) {

100 
	`båfs_ªÀa£_∑th
(
∑th
);

101  
	`ERR_PTR
(-
ENOENT
);

104 
Àaf
 = 
∑th
->
nodes
[0];

105 
hódî
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

106 
båfs_‰ì_•a˚_hódî
);

107 
	`båfs_‰ì_•a˚_key
(
Àaf
, 
hódî
, &
disk_key
);

108 
	`båfs_disk_key_to_˝u
(&
loˇti⁄
, &
disk_key
);

109 
	`båfs_ªÀa£_∑th
(
∑th
);

115 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

116 
öode
 = 
	`båfs_igë_∑th
(
fs_öfo
->
sb
, 
loˇti⁄
.
obje˘id
, 
roŸ
, 
∑th
);

117 
	`båfs_ªÀa£_∑th
(
∑th
);

118 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

119 i‡(
	`IS_ERR
(
öode
))

120  
öode
;

122 
	`m≠pög_£t_gÂ_mask
(
öode
->
i_m≠pög
,

123 
	`m≠pög_gÂ_c⁄°øöt
(
öode
->
i_m≠pög
,

124 ~(
__GFP_FS
 | 
__GFP_HIGHMEM
)));

126  
öode
;

127 
	}
}

129 
öode
 *
	$lookup_‰ì_•a˚_öode
(
båfs_block_group
 *
block_group
,

130 
båfs_∑th
 *
∑th
)

132 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

133 
öode
 *öodê
NULL
;

134 
u32
 
Êags
 = 
BTRFS_INODE_NODATASUM
 | 
BTRFS_INODE_NODATACOW
;

136 
	`•ö_lock
(&
block_group
->
lock
);

137 i‡(
block_group
->
öode
)

138 
öode
 = 
	`igøb
(
block_group
->inode);

139 
	`•ö_u∆ock
(&
block_group
->
lock
);

140 i‡(
öode
)

141  
öode
;

143 
öode
 = 
	`__lookup_‰ì_•a˚_öode
(
fs_öfo
->
åì_roŸ
, 
∑th
,

144 
block_group
->
°¨t
);

145 i‡(
	`IS_ERR
(
öode
))

146  
öode
;

148 
	`•ö_lock
(&
block_group
->
lock
);

149 i‡(!((
	`BTRFS_I
(
öode
)->
Êags
 & flags) == flags)) {

150 
	`båfs_öfo
(
fs_öfo
, "Old style space inode found, converting.");

151 
	`BTRFS_I
(
öode
)->
Êags
 |
BTRFS_INODE_NODATASUM
 |

152 
BTRFS_INODE_NODATACOW
;

153 
block_group
->
disk_ˇche_°©e
 = 
BTRFS_DC_CLEAR
;

156 i‡(!
	`ã°_™d_£t_bô
(
BLOCK_GROUP_FLAG_IREF
, &
block_group
->
ru¡ime_Êags
))

157 
block_group
->
öode
 = 
	`igøb
(inode);

158 
	`•ö_u∆ock
(&
block_group
->
lock
);

160  
öode
;

161 
	}
}

163 
	$__¸óã_‰ì_•a˚_öode
(
båfs_roŸ
 *
roŸ
,

164 
båfs_å™s_h™dÀ
 *
å™s
,

165 
båfs_∑th
 *
∑th
,

166 
u64
 
öo
, u64 
off£t
)

168 
båfs_key
 
key
;

169 
båfs_disk_key
 
disk_key
;

170 
båfs_‰ì_•a˚_hódî
 *
hódî
;

171 
båfs_öode_ôem
 *
öode_ôem
;

172 
exã¡_buf„r
 *
Àaf
;

174 c⁄° 
u64
 
Êags
 = 
BTRFS_INODE_NOCOMPRESS
 | 
BTRFS_INODE_PREALLOC
 |

175 
BTRFS_INODE_NODATASUM
 | 
BTRFS_INODE_NODATACOW
;

176 
ªt
;

178 
ªt
 = 
	`båfs_ö£π_em±y_öode
(
å™s
, 
roŸ
, 
∑th
, 
öo
);

179 i‡(
ªt
)

180  
ªt
;

182 
Àaf
 = 
∑th
->
nodes
[0];

183 
öode_ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

184 
båfs_öode_ôem
);

185 
	`båfs_ôem_key
(
Àaf
, &
disk_key
, 
∑th
->
¶Ÿs
[0]);

186 
	`memzîo_exã¡_buf„r
(
Àaf
, ()
öode_ôem
,

187 (*
öode_ôem
));

188 
	`båfs_£t_öode_gíî©i⁄
(
Àaf
, 
öode_ôem
, 
å™s
->
å™sid
);

189 
	`båfs_£t_öode_size
(
Àaf
, 
öode_ôem
, 0);

190 
	`båfs_£t_öode_nbyãs
(
Àaf
, 
öode_ôem
, 0);

191 
	`båfs_£t_öode_uid
(
Àaf
, 
öode_ôem
, 0);

192 
	`båfs_£t_öode_gid
(
Àaf
, 
öode_ôem
, 0);

193 
	`båfs_£t_öode_mode
(
Àaf
, 
öode_ôem
, 
S_IFREG
 | 0600);

194 
	`båfs_£t_öode_Êags
(
Àaf
, 
öode_ôem
, 
Êags
);

195 
	`båfs_£t_öode_∆ök
(
Àaf
, 
öode_ôem
, 1);

196 
	`båfs_£t_öode_å™sid
(
Àaf
, 
öode_ôem
, 
å™s
->
å™sid
);

197 
	`båfs_£t_öode_block_group
(
Àaf
, 
öode_ôem
, 
off£t
);

198 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

199 
	`båfs_ªÀa£_∑th
(
∑th
);

201 
key
.
obje˘id
 = 
BTRFS_FREE_SPACE_OBJECTID
;

202 
key
.
off£t
 = offset;

203 
key
.
ty≥
 = 0;

204 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
,

205 (
båfs_‰ì_•a˚_hódî
));

206 i‡(
ªt
 < 0) {

207 
	`båfs_ªÀa£_∑th
(
∑th
);

208  
ªt
;

211 
Àaf
 = 
∑th
->
nodes
[0];

212 
hódî
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

213 
båfs_‰ì_•a˚_hódî
);

214 
	`memzîo_exã¡_buf„r
(
Àaf
, ()
hódî
, (*header));

215 
	`båfs_£t_‰ì_•a˚_key
(
Àaf
, 
hódî
, &
disk_key
);

216 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

217 
	`båfs_ªÀa£_∑th
(
∑th
);

220 
	}
}

222 
	$¸óã_‰ì_•a˚_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

223 
båfs_block_group
 *
block_group
,

224 
båfs_∑th
 *
∑th
)

226 
ªt
;

227 
u64
 
öo
;

229 
ªt
 = 
	`båfs_gë_‰ì_obje˘id
(
å™s
->
fs_öfo
->
åì_roŸ
, &
öo
);

230 i‡(
ªt
 < 0)

231  
ªt
;

233  
	`__¸óã_‰ì_•a˚_öode
(
å™s
->
fs_öfo
->
åì_roŸ
,Åøns, 
∑th
,

234 
öo
, 
block_group
->
°¨t
);

235 
	}
}

242 
	$båfs_ªmove_‰ì_•a˚_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

243 
öode
 *inode,

244 
båfs_block_group
 *
block_group
)

246 
båfs_∑th
 *
∑th
;

247 
båfs_key
 
key
;

248 
ªt
 = 0;

250 
∑th
 = 
	`båfs_Æloc_∑th
();

251 i‡(!
∑th
)

252  -
ENOMEM
;

254 i‡(!
öode
)

255 
öode
 = 
	`lookup_‰ì_•a˚_öode
(
block_group
, 
∑th
);

256 i‡(
	`IS_ERR
(
öode
)) {

257 i‡(
	`PTR_ERR
(
öode
Ë!-
ENOENT
)

258 
ªt
 = 
	`PTR_ERR
(
öode
);

259 
out
;

261 
ªt
 = 
	`båfs_‹ph™_add
(
å™s
, 
	`BTRFS_I
(
öode
));

262 i‡(
ªt
) {

263 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
öode
));

264 
out
;

266 
	`˛ór_∆ök
(
öode
);

268 
	`•ö_lock
(&
block_group
->
lock
);

269 i‡(
	`ã°_™d_˛ór_bô
(
BLOCK_GROUP_FLAG_IREF
, &
block_group
->
ru¡ime_Êags
)) {

270 
block_group
->
öode
 = 
NULL
;

271 
	`•ö_u∆ock
(&
block_group
->
lock
);

272 
	`ùut
(
öode
);

274 
	`•ö_u∆ock
(&
block_group
->
lock
);

277 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
öode
));

279 
key
.
obje˘id
 = 
BTRFS_FREE_SPACE_OBJECTID
;

280 
key
.
ty≥
 = 0;

281 
key
.
off£t
 = 
block_group
->
°¨t
;

282 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
,Åøns->
fs_öfo
->
åì_roŸ
, &
key
, 
∑th
,

284 i‡(
ªt
) {

285 i‡(
ªt
 > 0)

286 
ªt
 = 0;

287 
out
;

289 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
,Åøns->
fs_öfo
->
åì_roŸ
, 
∑th
);

290 
out
:

291 
	`båfs_‰ì_∑th
(
∑th
);

292  
ªt
;

293 
	}
}

295 
	$båfs_åunˇã_‰ì_•a˚_ˇche
(
båfs_å™s_h™dÀ
 *
å™s
,

296 
båfs_block_group
 *
block_group
,

297 
öode
 *
vfs_öode
)

299 
båfs_åunˇã_c⁄åﬁ
 
c⁄åﬁ
 = {

300 .
öode
 = 
	`BTRFS_I
(
vfs_öode
),

301 .
√w_size
 = 0,

302 .
öo
 = 
	`båfs_öo
(
	`BTRFS_I
(
vfs_öode
)),

303 .
mö_ty≥
 = 
BTRFS_EXTENT_DATA_KEY
,

304 .
˛ór_exã¡_ønge
 = 
åue
,

306 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
vfs_öode
);

307 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

308 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

309 
ªt
 = 0;

310 
boﬁ
 
locked
 = 
Ál£
;

312 i‡(
block_group
) {

313 
båfs_∑th
 *
∑th
 = 
	`båfs_Æloc_∑th
();

315 i‡(!
∑th
) {

316 
ªt
 = -
ENOMEM
;

317 
Áû
;

319 
locked
 = 
åue
;

320 
	`muãx_lock
(&
å™s
->
å™ß˘i⁄
->
ˇche_wrôe_muãx
);

321 i‡(!
	`li°_em±y
(&
block_group
->
io_li°
)) {

322 
	`li°_dñ_öô
(&
block_group
->
io_li°
);

324 
	`båfs_waô_ˇche_io
(
å™s
, 
block_group
, 
∑th
);

325 
	`båfs_put_block_group
(
block_group
);

332 
	`•ö_lock
(&
block_group
->
lock
);

333 
block_group
->
disk_ˇche_°©e
 = 
BTRFS_DC_CLEAR
;

334 
	`•ö_u∆ock
(&
block_group
->
lock
);

335 
	`båfs_‰ì_∑th
(
∑th
);

338 
	`båfs_i_size_wrôe
(
öode
, 0);

339 
	`åunˇã_∑geˇche
(
vfs_öode
, 0);

341 
	`lock_exã¡
(&
öode
->
io_åì
, 0, (
u64
)-1, &
ˇched_°©e
);

342 
	`båfs_dr›_exã¡_m≠_ønge
(
öode
, 0, (
u64
)-1, 
Ál£
);

348 
ªt
 = 
	`båfs_åunˇã_öode_ôems
(
å™s
, 
roŸ
, &
c⁄åﬁ
);

350 
	`öode_sub_byãs
(&
öode
->
vfs_öode
, 
c⁄åﬁ
.
sub_byãs
);

351 
	`båfs_öode_ß„_disk_i_size_wrôe
(
öode
, 
c⁄åﬁ
.
œ°_size
);

353 
	`u∆ock_exã¡
(&
öode
->
io_åì
, 0, (
u64
)-1, &
ˇched_°©e
);

354 i‡(
ªt
)

355 
Áû
;

357 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
öode
);

359 
Áû
:

360 i‡(
locked
)

361 
	`muãx_u∆ock
(&
å™s
->
å™ß˘i⁄
->
ˇche_wrôe_muãx
);

362 i‡(
ªt
)

363 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

365  
ªt
;

366 
	}
}

368 
	$ªadahód_ˇche
(
öode
 *inode)

370 
fûe_ø_°©e
 
ø
;

371 
œ°_ödex
;

373 
	`fûe_ø_°©e_öô
(&
ø
, 
öode
->
i_m≠pög
);

374 
œ°_ödex
 = (
	`i_size_ªad
(
öode
Ë- 1Ë>> 
PAGE_SHIFT
;

376 
	`∑ge_ˇche_sync_ªadahód
(
öode
->
i_m≠pög
, &
ø
, 
NULL
, 0, 
œ°_ödex
);

377 
	}
}

379 
	$io_˘l_öô
(
båfs_io_˘l
 *
io_˘l
, 
öode
 *inode,

380 
wrôe
)

382 
num_∑ges
;

384 
num_∑ges
 = 
	`DIV_ROUND_UP
(
	`i_size_ªad
(
öode
), 
PAGE_SIZE
);

387 i‡(
wrôe
 && (
num_∑ges
 * (
u32
Ë+ (
u64
)Ë> 
PAGE_SIZE
)

388  -
ENOSPC
;

390 
	`mem£t
(
io_˘l
, 0, (
båfs_io_˘l
));

392 
io_˘l
->
∑ges
 = 
	`kˇŒoc
(
num_∑ges
, (
∑ge
 *), 
GFP_NOFS
);

393 i‡(!
io_˘l
->
∑ges
)

394  -
ENOMEM
;

396 
io_˘l
->
num_∑ges
 =Çum_pages;

397 
io_˘l
->
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

398 
io_˘l
->
öode
 = inode;

401 
	}
}

402 
ALLOW_ERROR_INJECTION
(
io_˘l_öô
, 
ERRNO
);

404 
	$io_˘l_‰ì
(
båfs_io_˘l
 *
io_˘l
)

406 
	`k‰ì
(
io_˘l
->
∑ges
);

407 
io_˘l
->
∑ges
 = 
NULL
;

408 
	}
}

410 
	$io_˘l_unm≠_∑ge
(
båfs_io_˘l
 *
io_˘l
)

412 i‡(
io_˘l
->
cur
) {

413 
io_˘l
->
cur
 = 
NULL
;

414 
io_˘l
->
‹ig
 = 
NULL
;

416 
	}
}

418 
	$io_˘l_m≠_∑ge
(
båfs_io_˘l
 *
io_˘l
, 
˛ór
)

420 
	`ASSERT
(
io_˘l
->
ödex
 < io_˘l->
num_∑ges
);

421 
io_˘l
->
∑ge
 = io_˘l->
∑ges
[io_˘l->
ödex
++];

422 
io_˘l
->
cur
 = 
	`∑ge_addªss
(io_˘l->
∑ge
);

423 
io_˘l
->
‹ig
 = io_˘l->
cur
;

424 
io_˘l
->
size
 = 
PAGE_SIZE
;

425 i‡(
˛ór
)

426 
	`˛ór_∑ge
(
io_˘l
->
cur
);

427 
	}
}

429 
	$io_˘l_dr›_∑ges
(
båfs_io_˘l
 *
io_˘l
)

431 
i
;

433 
	`io_˘l_unm≠_∑ge
(
io_˘l
);

435 
i
 = 0; i < 
io_˘l
->
num_∑ges
; i++) {

436 i‡(
io_˘l
->
∑ges
[
i
]) {

437 
	`båfs_∑ge_˛ór_checked
(
io_˘l
->
fs_öfo
,

438 
io_˘l
->
∑ges
[
i
],

439 
	`∑ge_off£t
(
io_˘l
->
∑ges
[
i
]),

440 
PAGE_SIZE
);

441 
	`u∆ock_∑ge
(
io_˘l
->
∑ges
[
i
]);

442 
	`put_∑ge
(
io_˘l
->
∑ges
[
i
]);

445 
	}
}

447 
	$io_˘l_¥ï¨e_∑ges
(
båfs_io_˘l
 *
io_˘l
, 
boﬁ
 
u±od©e
)

449 
∑ge
 *page;

450 
öode
 *öodê
io_˘l
->inode;

451 
gÂ_t
 
mask
 = 
	`båfs_Æloc_wrôe_mask
(
öode
->
i_m≠pög
);

452 
i
;

454 
i
 = 0; i < 
io_˘l
->
num_∑ges
; i++) {

455 
ªt
;

457 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
i
, 
mask
);

458 i‡(!
∑ge
) {

459 
	`io_˘l_dr›_∑ges
(
io_˘l
);

460  -
ENOMEM
;

463 
ªt
 = 
	`£t_∑ge_exã¡_m≠≥d
(
∑ge
);

464 i‡(
ªt
 < 0) {

465 
	`u∆ock_∑ge
(
∑ge
);

466 
	`put_∑ge
(
∑ge
);

467 
	`io_˘l_dr›_∑ges
(
io_˘l
);

468  
ªt
;

471 
io_˘l
->
∑ges
[
i
] = 
∑ge
;

472 i‡(
u±od©e
 && !
	`PageU±od©e
(
∑ge
)) {

473 
	`båfs_ªad_fﬁio
(
NULL
, 
	`∑ge_fﬁio
(
∑ge
));

474 
	`lock_∑ge
(
∑ge
);

475 i‡(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
) {

476 
	`båfs_îr
(
	`BTRFS_I
(
öode
)->
roŸ
->
fs_öfo
,

478 
	`io_˘l_dr›_∑ges
(
io_˘l
);

479  -
EIO
;

481 i‡(!
	`PageU±od©e
(
∑ge
)) {

482 
	`båfs_îr
(
	`BTRFS_I
(
öode
)->
roŸ
->
fs_öfo
,

484 
	`io_˘l_dr›_∑ges
(
io_˘l
);

485  -
EIO
;

490 
i
 = 0; i < 
io_˘l
->
num_∑ges
; i++)

491 
	`˛ór_∑ge_dúty_f‹_io
(
io_˘l
->
∑ges
[
i
]);

494 
	}
}

496 
	$io_˘l_£t_gíî©i⁄
(
båfs_io_˘l
 *
io_˘l
, 
u64
 
gíî©i⁄
)

498 
	`io_˘l_m≠_∑ge
(
io_˘l
, 1);

504 
io_˘l
->
cur
 +((
u32
Ë* io_˘l->
num_∑ges
);

505 
io_˘l
->
size
 -(
u64
Ë+ ((
u32
Ë* io_˘l->
num_∑ges
);

507 
	`put_u«lig√d_À64
(
gíî©i⁄
, 
io_˘l
->
cur
);

508 
io_˘l
->
cur
 +(
u64
);

509 
	}
}

511 
	$io_˘l_check_gíî©i⁄
(
båfs_io_˘l
 *
io_˘l
, 
u64
 
gíî©i⁄
)

513 
u64
 
ˇche_gí
;

519 
io_˘l
->
cur
 +(
u32
Ë* io_˘l->
num_∑ges
;

520 
io_˘l
->
size
 -(
u64
Ë+ ((
u32
Ë* io_˘l->
num_∑ges
);

522 
ˇche_gí
 = 
	`gë_u«lig√d_À64
(
io_˘l
->
cur
);

523 i‡(
ˇche_gí
 !
gíî©i⁄
) {

524 
	`båfs_îr_æ
(
io_˘l
->
fs_öfo
,

526 
ˇche_gí
, 
gíî©i⁄
);

527 
	`io_˘l_unm≠_∑ge
(
io_˘l
);

528  -
EIO
;

530 
io_˘l
->
cur
 +(
u64
);

532 
	}
}

534 
	$io_˘l_£t_¸c
(
båfs_io_˘l
 *
io_˘l
, 
ödex
)

536 
u32
 *
tmp
;

537 
u32
 
¸c
 = ~(u32)0;

538 
off£t
 = 0;

540 i‡(
ödex
 == 0)

541 
off£t
 = (
u32
Ë* 
io_˘l
->
num_∑ges
;

543 
¸c
 = 
	`båfs_¸c32c
(¸c, 
io_˘l
->
‹ig
 + 
off£t
, 
PAGE_SIZE
 - offset);

544 
	`båfs_¸c32c_föÆ
(
¸c
, (
u8
 *)&crc);

545 
	`io_˘l_unm≠_∑ge
(
io_˘l
);

546 
tmp
 = 
	`∑ge_addªss
(
io_˘l
->
∑ges
[0]);

547 
tmp
 +
ödex
;

548 *
tmp
 = 
¸c
;

549 
	}
}

551 
	$io_˘l_check_¸c
(
båfs_io_˘l
 *
io_˘l
, 
ödex
)

553 
u32
 *
tmp
, 
vÆ
;

554 
u32
 
¸c
 = ~(u32)0;

555 
off£t
 = 0;

557 i‡(
ödex
 == 0)

558 
off£t
 = (
u32
Ë* 
io_˘l
->
num_∑ges
;

560 
tmp
 = 
	`∑ge_addªss
(
io_˘l
->
∑ges
[0]);

561 
tmp
 +
ödex
;

562 
vÆ
 = *
tmp
;

564 
	`io_˘l_m≠_∑ge
(
io_˘l
, 0);

565 
¸c
 = 
	`båfs_¸c32c
(¸c, 
io_˘l
->
‹ig
 + 
off£t
, 
PAGE_SIZE
 - offset);

566 
	`båfs_¸c32c_föÆ
(
¸c
, (
u8
 *)&crc);

567 i‡(
vÆ
 !
¸c
) {

568 
	`båfs_îr_æ
(
io_˘l
->
fs_öfo
,

570 
	`io_˘l_unm≠_∑ge
(
io_˘l
);

571  -
EIO
;

575 
	}
}

577 
	$io_˘l_add_íåy
(
båfs_io_˘l
 *
io_˘l
, 
u64
 
off£t
, u64 
byãs
,

578 *
bôm≠
)

580 
båfs_‰ì_•a˚_íåy
 *
íåy
;

582 i‡(!
io_˘l
->
cur
)

583  -
ENOSPC
;

585 
íåy
 = 
io_˘l
->
cur
;

586 
	`put_u«lig√d_À64
(
off£t
, &
íåy
->offset);

587 
	`put_u«lig√d_À64
(
byãs
, &
íåy
->bytes);

588 
íåy
->
ty≥
 = (
bôm≠
Ë? 
BTRFS_FREE_SPACE_BITMAP
 :

589 
BTRFS_FREE_SPACE_EXTENT
;

590 
io_˘l
->
cur
 +(
båfs_‰ì_•a˚_íåy
);

591 
io_˘l
->
size
 -(
båfs_‰ì_•a˚_íåy
);

593 i‡(
io_˘l
->
size
 >(
båfs_‰ì_•a˚_íåy
))

596 
	`io_˘l_£t_¸c
(
io_˘l
, io_˘l->
ödex
 - 1);

599 i‡(
io_˘l
->
ödex
 >io_˘l->
num_∑ges
)

603 
	`io_˘l_m≠_∑ge
(
io_˘l
, 1);

605 
	}
}

607 
	$io_˘l_add_bôm≠
(
båfs_io_˘l
 *
io_˘l
, *
bôm≠
)

609 i‡(!
io_˘l
->
cur
)

610  -
ENOSPC
;

616 i‡(
io_˘l
->
cur
 !io_˘l->
‹ig
) {

617 
	`io_˘l_£t_¸c
(
io_˘l
, io_˘l->
ödex
 - 1);

618 i‡(
io_˘l
->
ödex
 >io_˘l->
num_∑ges
)

619  -
ENOSPC
;

620 
	`io_˘l_m≠_∑ge
(
io_˘l
, 0);

623 
	`c›y_∑ge
(
io_˘l
->
cur
, 
bôm≠
);

624 
	`io_˘l_£t_¸c
(
io_˘l
, io_˘l->
ödex
 - 1);

625 i‡(
io_˘l
->
ödex
 < io_˘l->
num_∑ges
)

626 
	`io_˘l_m≠_∑ge
(
io_˘l
, 0);

628 
	}
}

630 
	$io_˘l_zîo_ªmaöög_∑ges
(
båfs_io_˘l
 *
io_˘l
)

636 i‡(
io_˘l
->
cur
 !io_˘l->
‹ig
)

637 
	`io_˘l_£t_¸c
(
io_˘l
, io_˘l->
ödex
 - 1);

639 
	`io_˘l_unm≠_∑ge
(
io_˘l
);

641 
io_˘l
->
ödex
 < io_˘l->
num_∑ges
) {

642 
	`io_˘l_m≠_∑ge
(
io_˘l
, 1);

643 
	`io_˘l_£t_¸c
(
io_˘l
, io_˘l->
ödex
 - 1);

645 
	}
}

647 
	$io_˘l_ªad_íåy
(
båfs_io_˘l
 *
io_˘l
,

648 
båfs_‰ì_•a˚
 *
íåy
, 
u8
 *
ty≥
)

650 
båfs_‰ì_•a˚_íåy
 *
e
;

651 
ªt
;

653 i‡(!
io_˘l
->
cur
) {

654 
ªt
 = 
	`io_˘l_check_¸c
(
io_˘l
, io_˘l->
ödex
);

655 i‡(
ªt
)

656  
ªt
;

659 
e
 = 
io_˘l
->
cur
;

660 
íåy
->
off£t
 = 
	`gë_u«lig√d_À64
(&
e
->offset);

661 
íåy
->
byãs
 = 
	`gë_u«lig√d_À64
(&
e
->bytes);

662 *
ty≥
 = 
e
->type;

663 
io_˘l
->
cur
 +(
båfs_‰ì_•a˚_íåy
);

664 
io_˘l
->
size
 -(
båfs_‰ì_•a˚_íåy
);

666 i‡(
io_˘l
->
size
 >(
båfs_‰ì_•a˚_íåy
))

669 
	`io_˘l_unm≠_∑ge
(
io_˘l
);

672 
	}
}

674 
	$io_˘l_ªad_bôm≠
(
båfs_io_˘l
 *
io_˘l
,

675 
båfs_‰ì_•a˚
 *
íåy
)

677 
ªt
;

679 
ªt
 = 
	`io_˘l_check_¸c
(
io_˘l
, io_˘l->
ödex
);

680 i‡(
ªt
)

681  
ªt
;

683 
	`c›y_∑ge
(
íåy
->
bôm≠
, 
io_˘l
->
cur
);

684 
	`io_˘l_unm≠_∑ge
(
io_˘l
);

687 
	}
}

689 
	$ªˇlcuœã_thªshﬁds
(
båfs_‰ì_•a˚_˘l
 *
˘l
)

691 
båfs_block_group
 *
block_group
 = 
˘l
->block_group;

692 
u64
 
max_byãs
;

693 
u64
 
bôm≠_byãs
;

694 
u64
 
exã¡_byãs
;

695 
u64
 
size
 = 
block_group
->
Àngth
;

696 
u64
 
byãs_≥r_bg
 = 
BITS_PER_BITMAP
 * 
˘l
->
unô
;

697 
u64
 
max_bôm≠s
 = 
	`div64_u64
(
size
 + 
byãs_≥r_bg
 - 1, bytes_per_bg);

699 
max_bôm≠s
 = 
	`max_t
(
u64
, max_bitmaps, 1);

701 i‡(
˘l
->
tŸÆ_bôm≠s
 > 
max_bôm≠s
)

702 
	`båfs_îr
(
block_group
->
fs_öfo
,

704 
block_group
->
°¨t
, block_group->
Àngth
,

705 
˘l
->
tŸÆ_bôm≠s
, cé->
unô
, 
max_bôm≠s
,

706 
byãs_≥r_bg
);

707 
	`ASSERT
(
˘l
->
tŸÆ_bôm≠s
 <
max_bôm≠s
);

715 i‡(
size
 < 
SZ_1G
)

716 
max_byãs
 = 
MAX_CACHE_BYTES_PER_GIG
;

718 
max_byãs
 = 
MAX_CACHE_BYTES_PER_GIG
 * 
	`div_u64
(
size
, 
SZ_1G
);

720 
bôm≠_byãs
 = 
˘l
->
tŸÆ_bôm≠s
 * cé->
unô
;

726 
exã¡_byãs
 = 
max_byãs
 - 
bôm≠_byãs
;

727 
exã¡_byãs
 = 
	`mö_t
(
u64
,Éxã¡_byãs, 
max_byãs
 >> 1);

729 
˘l
->
exã¡s_thªsh
 =

730 
	`div_u64
(
exã¡_byãs
, (
båfs_‰ì_•a˚
));

731 
	}
}

733 
	$__lﬂd_‰ì_•a˚_ˇche
(
båfs_roŸ
 *
roŸ
, 
öode
 *inode,

734 
båfs_‰ì_•a˚_˘l
 *
˘l
,

735 
båfs_∑th
 *
∑th
, 
u64
 
off£t
)

737 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

738 
båfs_‰ì_•a˚_hódî
 *
hódî
;

739 
exã¡_buf„r
 *
Àaf
;

740 
båfs_io_˘l
 
io_˘l
;

741 
båfs_key
 
key
;

742 
båfs_‰ì_•a˚
 *
e
, *
n
;

743 
	`LIST_HEAD
(
bôm≠s
);

744 
u64
 
num_íåõs
;

745 
u64
 
num_bôm≠s
;

746 
u64
 
gíî©i⁄
;

747 
u8
 
ty≥
;

748 
ªt
 = 0;

751 i‡(!
	`i_size_ªad
(
öode
))

754 
key
.
obje˘id
 = 
BTRFS_FREE_SPACE_OBJECTID
;

755 
key
.
off£t
 = offset;

756 
key
.
ty≥
 = 0;

758 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

759 i‡(
ªt
 < 0)

761 i‡(
ªt
 > 0) {

762 
	`båfs_ªÀa£_∑th
(
∑th
);

766 
ªt
 = -1;

768 
Àaf
 = 
∑th
->
nodes
[0];

769 
hódî
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

770 
båfs_‰ì_•a˚_hódî
);

771 
num_íåõs
 = 
	`båfs_‰ì_•a˚_íåõs
(
Àaf
, 
hódî
);

772 
num_bôm≠s
 = 
	`båfs_‰ì_•a˚_bôm≠s
(
Àaf
, 
hódî
);

773 
gíî©i⁄
 = 
	`båfs_‰ì_•a˚_gíî©i⁄
(
Àaf
, 
hódî
);

774 
	`båfs_ªÀa£_∑th
(
∑th
);

776 i‡(!
	`BTRFS_I
(
öode
)->
gíî©i⁄
) {

777 
	`båfs_öfo
(
fs_öfo
,

779 
off£t
);

783 i‡(
	`BTRFS_I
(
öode
)->
gíî©i⁄
 != generation) {

784 
	`båfs_îr
(
fs_öfo
,

786 
	`BTRFS_I
(
öode
)->
gíî©i⁄
, generation);

790 i‡(!
num_íåõs
)

793 
ªt
 = 
	`io_˘l_öô
(&
io_˘l
, 
öode
, 0);

794 i‡(
ªt
)

795  
ªt
;

797 
	`ªadahód_ˇche
(
öode
);

799 
ªt
 = 
	`io_˘l_¥ï¨e_∑ges
(&
io_˘l
, 
åue
);

800 i‡(
ªt
)

801 
out
;

803 
ªt
 = 
	`io_˘l_check_¸c
(&
io_˘l
, 0);

804 i‡(
ªt
)

805 
‰ì_ˇche
;

807 
ªt
 = 
	`io_˘l_check_gíî©i⁄
(&
io_˘l
, 
gíî©i⁄
);

808 i‡(
ªt
)

809 
‰ì_ˇche
;

811 
num_íåõs
) {

812 
e
 = 
	`kmem_ˇche_zÆloc
(
båfs_‰ì_•a˚_ˇchï
,

813 
GFP_NOFS
);

814 i‡(!
e
) {

815 
ªt
 = -
ENOMEM
;

816 
‰ì_ˇche
;

819 
ªt
 = 
	`io_˘l_ªad_íåy
(&
io_˘l
, 
e
, &
ty≥
);

820 i‡(
ªt
) {

821 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
e
);

822 
‰ì_ˇche
;

825 i‡(!
e
->
byãs
) {

826 
ªt
 = -1;

827 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
e
);

828 
‰ì_ˇche
;

831 i‡(
ty≥
 =
BTRFS_FREE_SPACE_EXTENT
) {

832 
	`•ö_lock
(&
˘l
->
åì_lock
);

833 
ªt
 = 
	`lök_‰ì_•a˚
(
˘l
, 
e
);

834 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

835 i‡(
ªt
) {

836 
	`båfs_îr
(
fs_öfo
,

838 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
e
);

839 
‰ì_ˇche
;

842 
	`ASSERT
(
num_bôm≠s
);

843 
num_bôm≠s
--;

844 
e
->
bôm≠
 = 
	`kmem_ˇche_zÆloc
(

845 
båfs_‰ì_•a˚_bôm≠_ˇchï
, 
GFP_NOFS
);

846 i‡(!
e
->
bôm≠
) {

847 
ªt
 = -
ENOMEM
;

848 
	`kmem_ˇche_‰ì
(

849 
båfs_‰ì_•a˚_ˇchï
, 
e
);

850 
‰ì_ˇche
;

852 
	`•ö_lock
(&
˘l
->
åì_lock
);

853 
ªt
 = 
	`lök_‰ì_•a˚
(
˘l
, 
e
);

854 i‡(
ªt
) {

855 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

856 
	`båfs_îr
(
fs_öfo
,

858 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
e
);

859 
‰ì_ˇche
;

861 
˘l
->
tŸÆ_bôm≠s
++;

862 
	`ªˇlcuœã_thªshﬁds
(
˘l
);

863 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

864 
	`li°_add_èû
(&
e
->
li°
, &
bôm≠s
);

867 
num_íåõs
--;

870 
	`io_˘l_unm≠_∑ge
(&
io_˘l
);

876 
	`li°_f‹_óch_íåy_ß„
(
e
, 
n
, &
bôm≠s
, 
li°
) {

877 
	`li°_dñ_öô
(&
e
->
li°
);

878 
ªt
 = 
	`io_˘l_ªad_bôm≠
(&
io_˘l
, 
e
);

879 i‡(
ªt
)

880 
‰ì_ˇche
;

883 
	`io_˘l_dr›_∑ges
(&
io_˘l
);

884 
ªt
 = 1;

885 
out
:

886 
	`io_˘l_‰ì
(&
io_˘l
);

887  
ªt
;

888 
‰ì_ˇche
:

889 
	`io_˘l_dr›_∑ges
(&
io_˘l
);

891 
	`•ö_lock
(&
˘l
->
åì_lock
);

892 
	`__båfs_ªmove_‰ì_•a˚_ˇche
(
˘l
);

893 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

894 
out
;

895 
	}
}

897 
	$c›y_‰ì_•a˚_ˇche
(
båfs_block_group
 *
block_group
,

898 
båfs_‰ì_•a˚_˘l
 *
˘l
)

900 
båfs_‰ì_•a˚
 *
öfo
;

901 
rb_node
 *
n
;

902 
ªt
 = 0;

904 !
ªt
 && (
n
 = 
	`rb_fú°
(&
˘l
->
‰ì_•a˚_off£t
)Ë!
NULL
) {

905 
öfo
 = 
	`rb_íåy
(
n
, 
båfs_‰ì_•a˚
, 
off£t_ödex
);

906 i‡(!
öfo
->
bôm≠
) {

907 c⁄° 
u64
 
off£t
 = 
öfo
->offset;

908 c⁄° 
u64
 
byãs
 = 
öfo
->bytes;

910 
	`u∆ök_‰ì_•a˚
(
˘l
, 
öfo
, 
åue
);

911 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

912 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
öfo
);

913 
ªt
 = 
	`båfs_add_‰ì_•a˚
(
block_group
, 
off£t
, 
byãs
);

914 
	`•ö_lock
(&
˘l
->
åì_lock
);

916 
u64
 
off£t
 = 
öfo
->offset;

917 
u64
 
byãs
 = 
˘l
->
unô
;

919 
ªt
 = 
	`£¨ch_bôm≠
(
˘l
, 
öfo
, &
off£t
, &
byãs
, 
Ál£
);

920 i‡(
ªt
 == 0) {

921 
	`bôm≠_˛ór_bôs
(
˘l
, 
öfo
, 
off£t
, 
byãs
, 
åue
);

922 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

923 
ªt
 = 
	`båfs_add_‰ì_•a˚
(
block_group
, 
off£t
,

924 
byãs
);

925 
	`•ö_lock
(&
˘l
->
åì_lock
);

927 
	`‰ì_bôm≠
(
˘l
, 
öfo
);

928 
ªt
 = 0;

931 
	`c⁄d_ªsched_lock
(&
˘l
->
åì_lock
);

933  
ªt
;

934 
	}
}

936 
lock_˛ass_key
 
	gbåfs_‰ì_•a˚_öode_key
;

938 
	$lﬂd_‰ì_•a˚_ˇche
(
båfs_block_group
 *
block_group
)

940 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

941 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

942 
båfs_‰ì_•a˚_˘l
 
tmp_˘l
 = {};

943 
öode
 *inode;

944 
båfs_∑th
 *
∑th
;

945 
ªt
 = 0;

946 
boﬁ
 
m©ched
;

947 
u64
 
u£d
 = 
block_group
->used;

954 
	`båfs_öô_‰ì_•a˚_˘l
(
block_group
, &
tmp_˘l
);

960 
	`•ö_lock
(&
block_group
->
lock
);

961 i‡(
block_group
->
disk_ˇche_°©e
 !
BTRFS_DC_WRITTEN
) {

962 
	`•ö_u∆ock
(&
block_group
->
lock
);

965 
	`•ö_u∆ock
(&
block_group
->
lock
);

967 
∑th
 = 
	`båfs_Æloc_∑th
();

968 i‡(!
∑th
)

970 
∑th
->
£¨ch_commô_roŸ
 = 1;

971 
∑th
->
skù_lockög
 = 1;

992 
öode
 = 
	`lookup_‰ì_•a˚_öode
(
block_group
, 
∑th
);

993 i‡(
	`IS_ERR
(
öode
)) {

994 
	`båfs_‰ì_∑th
(
∑th
);

999 
	`•ö_lock
(&
block_group
->
lock
);

1000 i‡(
block_group
->
disk_ˇche_°©e
 !
BTRFS_DC_WRITTEN
) {

1001 
	`•ö_u∆ock
(&
block_group
->
lock
);

1002 
	`båfs_‰ì_∑th
(
∑th
);

1003 
out
;

1005 
	`•ö_u∆ock
(&
block_group
->
lock
);

1012 
	`lockdï_£t_˛ass
(&(&
öode
->
i_d©a
)->
övÆid©e_lock
,

1013 &
båfs_‰ì_•a˚_öode_key
);

1015 
ªt
 = 
	`__lﬂd_‰ì_•a˚_ˇche
(
fs_öfo
->
åì_roŸ
, 
öode
, &
tmp_˘l
,

1016 
∑th
, 
block_group
->
°¨t
);

1017 
	`båfs_‰ì_∑th
(
∑th
);

1018 i‡(
ªt
 <= 0)

1019 
out
;

1021 
m©ched
 = (
tmp_˘l
.
‰ì_•a˚
 =(
block_group
->
Àngth
 - 
u£d
 -

1022 
block_group
->
byãs_su≥r
));

1024 i‡(
m©ched
) {

1025 
	`•ö_lock
(&
tmp_˘l
.
åì_lock
);

1026 
ªt
 = 
	`c›y_‰ì_•a˚_ˇche
(
block_group
, &
tmp_˘l
);

1027 
	`•ö_u∆ock
(&
tmp_˘l
.
åì_lock
);

1032 i‡(
ªt
 == 0)

1033 
ªt
 = 1;

1039 
	`•ö_lock
(&
tmp_˘l
.
åì_lock
);

1040 
	`__båfs_ªmove_‰ì_•a˚_ˇche
(&
tmp_˘l
);

1041 
	`•ö_u∆ock
(&
tmp_˘l
.
åì_lock
);

1042 
	`båfs_w¨n
(
fs_öfo
,

1044 
block_group
->
°¨t
);

1045 
ªt
 = -1;

1047 
out
:

1048 i‡(
ªt
 < 0) {

1050 
	`•ö_lock
(&
block_group
->
lock
);

1051 
block_group
->
disk_ˇche_°©e
 = 
BTRFS_DC_CLEAR
;

1052 
	`•ö_u∆ock
(&
block_group
->
lock
);

1053 
ªt
 = 0;

1055 
	`båfs_w¨n
(
fs_öfo
,

1057 
block_group
->
°¨t
);

1060 
	`•ö_lock
(&
˘l
->
åì_lock
);

1061 
	`båfs_disˇrd_upd©e_disˇrdabÀ
(
block_group
);

1062 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

1063 
	`ùut
(
öode
);

1064  
ªt
;

1065 
	}
}

1067 
noölöe_f‹_°ack


1068 
	$wrôe_ˇche_exã¡_íåõs
(
båfs_io_˘l
 *
io_˘l
,

1069 
båfs_‰ì_•a˚_˘l
 *
˘l
,

1070 
båfs_block_group
 *
block_group
,

1071 *
íåõs
, *
bôm≠s
,

1072 
li°_hód
 *
bôm≠_li°
)

1074 
ªt
;

1075 
båfs_‰ì_˛u°î
 *
˛u°î
 = 
NULL
;

1076 
båfs_‰ì_˛u°î
 *
˛u°î_locked
 = 
NULL
;

1077 
rb_node
 *
node
 = 
	`rb_fú°
(&
˘l
->
‰ì_•a˚_off£t
);

1078 
båfs_åim_ønge
 *
åim_íåy
;

1081 i‡(
block_group
 && !
	`li°_em±y
(&block_group->
˛u°î_li°
)) {

1082 
˛u°î
 = 
	`li°_íåy
(
block_group
->
˛u°î_li°
.
√xt
,

1083 
båfs_‰ì_˛u°î
,

1084 
block_group_li°
);

1087 i‡(!
node
 && 
˛u°î
) {

1088 
˛u°î_locked
 = 
˛u°î
;

1089 
	`•ö_lock
(&
˛u°î_locked
->
lock
);

1090 
node
 = 
	`rb_fú°
(&
˛u°î
->
roŸ
);

1091 
˛u°î
 = 
NULL
;

1095 
node
) {

1096 
båfs_‰ì_•a˚
 *
e
;

1098 
e
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
, 
off£t_ödex
);

1099 *
íåõs
 += 1;

1101 
ªt
 = 
	`io_˘l_add_íåy
(
io_˘l
, 
e
->
off£t
,É->
byãs
,

1102 
e
->
bôm≠
);

1103 i‡(
ªt
)

1104 
Áû
;

1106 i‡(
e
->
bôm≠
) {

1107 
	`li°_add_èû
(&
e
->
li°
, 
bôm≠_li°
);

1108 *
bôm≠s
 += 1;

1110 
node
 = 
	`rb_√xt
(node);

1111 i‡(!
node
 && 
˛u°î
) {

1112 
node
 = 
	`rb_fú°
(&
˛u°î
->
roŸ
);

1113 
˛u°î_locked
 = 
˛u°î
;

1114 
	`•ö_lock
(&
˛u°î_locked
->
lock
);

1115 
˛u°î
 = 
NULL
;

1118 i‡(
˛u°î_locked
) {

1119 
	`•ö_u∆ock
(&
˛u°î_locked
->
lock
);

1120 
˛u°î_locked
 = 
NULL
;

1129 
	`li°_f‹_óch_íåy
(
åim_íåy
, &
˘l
->
åimmög_ønges
, 
li°
) {

1130 
ªt
 = 
	`io_˘l_add_íåy
(
io_˘l
, 
åim_íåy
->
°¨t
,

1131 
åim_íåy
->
byãs
, 
NULL
);

1132 i‡(
ªt
)

1133 
Áû
;

1134 *
íåõs
 += 1;

1138 
Áû
:

1139 i‡(
˛u°î_locked
)

1140 
	`•ö_u∆ock
(&
˛u°î_locked
->
lock
);

1141  -
ENOSPC
;

1142 
	}
}

1144 
noölöe_f‹_°ack
 

1145 
	$upd©e_ˇche_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

1146 
båfs_roŸ
 *
roŸ
,

1147 
öode
 *inode,

1148 
båfs_∑th
 *
∑th
, 
u64
 
off£t
,

1149 
íåõs
, 
bôm≠s
)

1151 
båfs_key
 
key
;

1152 
båfs_‰ì_•a˚_hódî
 *
hódî
;

1153 
exã¡_buf„r
 *
Àaf
;

1154 
ªt
;

1156 
key
.
obje˘id
 = 
BTRFS_FREE_SPACE_OBJECTID
;

1157 
key
.
off£t
 = offset;

1158 
key
.
ty≥
 = 0;

1160 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, 0, 1);

1161 i‡(
ªt
 < 0) {

1162 
	`˛ór_exã¡_bô
(&
	`BTRFS_I
(
öode
)->
io_åì
, 0, inode->
i_size
 - 1,

1163 
EXTENT_DELALLOC
, 
NULL
);

1164 
Áû
;

1166 
Àaf
 = 
∑th
->
nodes
[0];

1167 i‡(
ªt
 > 0) {

1168 
båfs_key
 
found_key
;

1169 
	`ASSERT
(
∑th
->
¶Ÿs
[0]);

1170 
∑th
->
¶Ÿs
[0]--;

1171 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0]);

1172 i‡(
found_key
.
obje˘id
 !
BTRFS_FREE_SPACE_OBJECTID
 ||

1173 
found_key
.
off£t
 != offset) {

1174 
	`˛ór_exã¡_bô
(&
	`BTRFS_I
(
öode
)->
io_åì
, 0,

1175 
öode
->
i_size
 - 1, 
EXTENT_DELALLOC
,

1176 
NULL
);

1177 
	`båfs_ªÀa£_∑th
(
∑th
);

1178 
Áû
;

1182 
	`BTRFS_I
(
öode
)->
gíî©i⁄
 = 
å™s
->
å™sid
;

1183 
hódî
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

1184 
båfs_‰ì_•a˚_hódî
);

1185 
	`båfs_£t_‰ì_•a˚_íåõs
(
Àaf
, 
hódî
, 
íåõs
);

1186 
	`båfs_£t_‰ì_•a˚_bôm≠s
(
Àaf
, 
hódî
, 
bôm≠s
);

1187 
	`båfs_£t_‰ì_•a˚_gíî©i⁄
(
Àaf
, 
hódî
, 
å™s
->
å™sid
);

1188 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

1189 
	`båfs_ªÀa£_∑th
(
∑th
);

1193 
Áû
:

1195 
	}
}

1197 
noölöe_f‹_°ack
 
	$wrôe_pö√d_exã¡_íåõs
(

1198 
båfs_å™s_h™dÀ
 *
å™s
,

1199 
båfs_block_group
 *
block_group
,

1200 
båfs_io_˘l
 *
io_˘l
,

1201 *
íåõs
)

1203 
u64
 
°¨t
, 
exã¡_°¨t
, 
exã¡_íd
, 
Àn
;

1204 
exã¡_io_åì
 *
u≈ö
 = 
NULL
;

1205 
ªt
;

1207 i‡(!
block_group
)

1217 
u≈ö
 = &
å™s
->
å™ß˘i⁄
->
pö√d_exã¡s
;

1219 
°¨t
 = 
block_group
->start;

1221 
°¨t
 < 
block_group
->°¨à+ block_group->
Àngth
) {

1222 i‡(!
	`föd_fú°_exã¡_bô
(
u≈ö
, 
°¨t
,

1223 &
exã¡_°¨t
, &
exã¡_íd
,

1224 
EXTENT_DIRTY
, 
NULL
))

1228 i‡(
exã¡_°¨t
 >
block_group
->
°¨t
 + block_group->
Àngth
)

1231 
exã¡_°¨t
 = 
	`max
”xã¡_°¨t, 
°¨t
);

1232 
exã¡_íd
 = 
	`mö
(
block_group
->
°¨t
 + block_group->
Àngth
,

1233 
exã¡_íd
 + 1);

1234 
Àn
 = 
exã¡_íd
 - 
exã¡_°¨t
;

1236 *
íåõs
 += 1;

1237 
ªt
 = 
	`io_˘l_add_íåy
(
io_˘l
, 
exã¡_°¨t
, 
Àn
, 
NULL
);

1238 i‡(
ªt
)

1239  -
ENOSPC
;

1241 
°¨t
 = 
exã¡_íd
;

1245 
	}
}

1247 
noölöe_f‹_°ack
 

1248 
	$wrôe_bôm≠_íåõs
(
båfs_io_˘l
 *
io_˘l
, 
li°_hód
 *
bôm≠_li°
)

1250 
båfs_‰ì_•a˚
 *
íåy
, *
√xt
;

1251 
ªt
;

1254 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
√xt
, 
bôm≠_li°
, 
li°
) {

1255 
ªt
 = 
	`io_˘l_add_bôm≠
(
io_˘l
, 
íåy
->
bôm≠
);

1256 i‡(
ªt
)

1257  -
ENOSPC
;

1258 
	`li°_dñ_öô
(&
íåy
->
li°
);

1262 
	}
}

1264 
	$Êush_dúty_ˇche
(
öode
 *inode)

1266 
ªt
;

1268 
ªt
 = 
	`båfs_waô_‹dîed_ønge
(
öode
, 0, (
u64
)-1);

1269 i‡(
ªt
)

1270 
	`˛ór_exã¡_bô
(&
	`BTRFS_I
(
öode
)->
io_åì
, 0, inode->
i_size
 - 1,

1271 
EXTENT_DELALLOC
, 
NULL
);

1273  
ªt
;

1274 
	}
}

1276 
noölöe_f‹_°ack


1277 
	$˛ónup_bôm≠_li°
(
li°_hód
 *
bôm≠_li°
)

1279 
båfs_‰ì_•a˚
 *
íåy
, *
√xt
;

1281 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
√xt
, 
bôm≠_li°
, 
li°
)

1282 
	`li°_dñ_öô
(&
íåy
->
li°
);

1283 
	}
}

1285 
noölöe_f‹_°ack


1286 
	$˛ónup_wrôe_ˇche_ío•c
(
öode
 *inode,

1287 
båfs_io_˘l
 *
io_˘l
,

1288 
exã¡_°©e
 **
ˇched_°©e
)

1290 
	`io_˘l_dr›_∑ges
(
io_˘l
);

1291 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 0, 
	`i_size_ªad
(inode) - 1,

1292 
ˇched_°©e
);

1293 
	}
}

1295 
	$__båfs_waô_ˇche_io
(
båfs_roŸ
 *
roŸ
,

1296 
båfs_å™s_h™dÀ
 *
å™s
,

1297 
båfs_block_group
 *
block_group
,

1298 
båfs_io_˘l
 *
io_˘l
,

1299 
båfs_∑th
 *
∑th
, 
u64
 
off£t
)

1301 
ªt
;

1302 
öode
 *öodê
io_˘l
->inode;

1304 i‡(!
öode
)

1308 
ªt
 = 
	`Êush_dúty_ˇche
(
öode
);

1309 i‡(
ªt
)

1310 
out
;

1313 
ªt
 = 
	`upd©e_ˇche_ôem
(
å™s
, 
roŸ
, 
öode
, 
∑th
, 
off£t
,

1314 
io_˘l
->
íåõs
, io_˘l->
bôm≠s
);

1315 
out
:

1316 i‡(
ªt
) {

1317 
	`övÆid©e_öode_∑ges2
(
öode
->
i_m≠pög
);

1318 
	`BTRFS_I
(
öode
)->
gíî©i⁄
 = 0;

1319 i‡(
block_group
)

1320 
	`båfs_debug
(
roŸ
->
fs_öfo
,

1322 
block_group
->
°¨t
, 
ªt
);

1324 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

1326 i‡(
block_group
) {

1328 
	`•ö_lock
(&
å™s
->
å™ß˘i⁄
->
dúty_bgs_lock
);

1331 
	`•ö_lock
(&
block_group
->
lock
);

1338 i‡(!
ªt
 && 
	`li°_em±y
(&
block_group
->
dúty_li°
))

1339 
block_group
->
disk_ˇche_°©e
 = 
BTRFS_DC_WRITTEN
;

1340 i‡(
ªt
)

1341 
block_group
->
disk_ˇche_°©e
 = 
BTRFS_DC_ERROR
;

1343 
	`•ö_u∆ock
(&
block_group
->
lock
);

1344 
	`•ö_u∆ock
(&
å™s
->
å™ß˘i⁄
->
dúty_bgs_lock
);

1345 
io_˘l
->
öode
 = 
NULL
;

1346 
	`ùut
(
öode
);

1349  
ªt
;

1351 
	}
}

1353 
	$båfs_waô_ˇche_io
(
båfs_å™s_h™dÀ
 *
å™s
,

1354 
båfs_block_group
 *
block_group
,

1355 
båfs_∑th
 *
∑th
)

1357  
	`__båfs_waô_ˇche_io
(
block_group
->
fs_öfo
->
åì_roŸ
, 
å™s
,

1358 
block_group
, &block_group->
io_˘l
,

1359 
∑th
, 
block_group
->
°¨t
);

1360 
	}
}

1376 
	$__båfs_wrôe_out_ˇche
(
båfs_roŸ
 *
roŸ
, 
öode
 *inode,

1377 
båfs_‰ì_•a˚_˘l
 *
˘l
,

1378 
båfs_block_group
 *
block_group
,

1379 
båfs_io_˘l
 *
io_˘l
,

1380 
båfs_å™s_h™dÀ
 *
å™s
)

1382 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

1383 
	`LIST_HEAD
(
bôm≠_li°
);

1384 
íåõs
 = 0;

1385 
bôm≠s
 = 0;

1386 
ªt
;

1387 
mu°_ùut
 = 0;

1389 i‡(!
	`i_size_ªad
(
öode
))

1390  -
EIO
;

1392 
	`WARN_ON
(
io_˘l
->
∑ges
);

1393 
ªt
 = 
	`io_˘l_öô
(
io_˘l
, 
öode
, 1);

1394 i‡(
ªt
)

1395  
ªt
;

1397 i‡(
block_group
 && (block_group->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
)) {

1398 
	`down_wrôe
(&
block_group
->
d©a_rw£m
);

1399 
	`•ö_lock
(&
block_group
->
lock
);

1400 i‡(
block_group
->
dñÆloc_byãs
) {

1401 
block_group
->
disk_ˇche_°©e
 = 
BTRFS_DC_WRITTEN
;

1402 
	`•ö_u∆ock
(&
block_group
->
lock
);

1403 
	`up_wrôe
(&
block_group
->
d©a_rw£m
);

1404 
	`BTRFS_I
(
öode
)->
gíî©i⁄
 = 0;

1405 
ªt
 = 0;

1406 
mu°_ùut
 = 1;

1407 
out
;

1409 
	`•ö_u∆ock
(&
block_group
->
lock
);

1413 
ªt
 = 
	`io_˘l_¥ï¨e_∑ges
(
io_˘l
, 
Ál£
);

1414 i‡(
ªt
)

1415 
out_u∆ock
;

1417 
	`lock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 0, 
	`i_size_ªad
(inode) - 1,

1418 &
ˇched_°©e
);

1420 
	`io_˘l_£t_gíî©i⁄
(
io_˘l
, 
å™s
->
å™sid
);

1422 
	`muãx_lock
(&
˘l
->
ˇche_wrôeout_muãx
);

1424 
	`•ö_lock
(&
˘l
->
åì_lock
);

1425 
ªt
 = 
	`wrôe_ˇche_exã¡_íåõs
(
io_˘l
, 
˘l
,

1426 
block_group
, &
íåõs
, &
bôm≠s
,

1427 &
bôm≠_li°
);

1428 i‡(
ªt
)

1429 
out_no•c_locked
;

1439 
ªt
 = 
	`wrôe_pö√d_exã¡_íåõs
(
å™s
, 
block_group
, 
io_˘l
, &
íåõs
);

1440 i‡(
ªt
)

1441 
out_no•c_locked
;

1448 
ªt
 = 
	`wrôe_bôm≠_íåõs
(
io_˘l
, &
bôm≠_li°
);

1449 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

1450 
	`muãx_u∆ock
(&
˘l
->
ˇche_wrôeout_muãx
);

1451 i‡(
ªt
)

1452 
out_no•c
;

1455 
	`io_˘l_zîo_ªmaöög_∑ges
(
io_˘l
);

1458 
ªt
 = 
	`båfs_dúty_∑ges
(
	`BTRFS_I
(
öode
), 
io_˘l
->
∑ges
,

1459 
io_˘l
->
num_∑ges
, 0, 
	`i_size_ªad
(
öode
),

1460 &
ˇched_°©e
, 
Ál£
);

1461 i‡(
ªt
)

1462 
out_no•c
;

1464 i‡(
block_group
 && (block_group->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
))

1465 
	`up_wrôe
(&
block_group
->
d©a_rw£m
);

1470 
	`io_˘l_dr›_∑ges
(
io_˘l
);

1471 
	`io_˘l_‰ì
(
io_˘l
);

1473 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 0, 
	`i_size_ªad
(inode) - 1,

1474 &
ˇched_°©e
);

1481 
io_˘l
->
íåõs
 =Éntries;

1482 
io_˘l
->
bôm≠s
 = bitmaps;

1484 
ªt
 = 
	`båfs_fd©awrôe_ønge
(
öode
, 0, (
u64
)-1);

1485 i‡(
ªt
)

1486 
out
;

1490 
out_no•c_locked
:

1491 
	`˛ónup_bôm≠_li°
(&
bôm≠_li°
);

1492 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

1493 
	`muãx_u∆ock
(&
˘l
->
ˇche_wrôeout_muãx
);

1495 
out_no•c
:

1496 
	`˛ónup_wrôe_ˇche_ío•c
(
öode
, 
io_˘l
, &
ˇched_°©e
);

1498 
out_u∆ock
:

1499 i‡(
block_group
 && (block_group->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
))

1500 
	`up_wrôe
(&
block_group
->
d©a_rw£m
);

1502 
out
:

1503 
io_˘l
->
öode
 = 
NULL
;

1504 
	`io_˘l_‰ì
(
io_˘l
);

1505 i‡(
ªt
) {

1506 
	`övÆid©e_öode_∑ges2
(
öode
->
i_m≠pög
);

1507 
	`BTRFS_I
(
öode
)->
gíî©i⁄
 = 0;

1509 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

1510 i‡(
mu°_ùut
)

1511 
	`ùut
(
öode
);

1512  
ªt
;

1513 
	}
}

1515 
	$båfs_wrôe_out_ˇche
(
båfs_å™s_h™dÀ
 *
å™s
,

1516 
båfs_block_group
 *
block_group
,

1517 
båfs_∑th
 *
∑th
)

1519 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1520 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

1521 
öode
 *inode;

1522 
ªt
 = 0;

1524 
	`•ö_lock
(&
block_group
->
lock
);

1525 i‡(
block_group
->
disk_ˇche_°©e
 < 
BTRFS_DC_SETUP
) {

1526 
	`•ö_u∆ock
(&
block_group
->
lock
);

1529 
	`•ö_u∆ock
(&
block_group
->
lock
);

1531 
öode
 = 
	`lookup_‰ì_•a˚_öode
(
block_group
, 
∑th
);

1532 i‡(
	`IS_ERR
(
öode
))

1535 
ªt
 = 
	`__båfs_wrôe_out_ˇche
(
fs_öfo
->
åì_roŸ
, 
öode
, 
˘l
,

1536 
block_group
, &block_group->
io_˘l
, 
å™s
);

1537 i‡(
ªt
) {

1538 
	`båfs_debug
(
fs_öfo
,

1540 
block_group
->
°¨t
, 
ªt
);

1541 
	`•ö_lock
(&
block_group
->
lock
);

1542 
block_group
->
disk_ˇche_°©e
 = 
BTRFS_DC_ERROR
;

1543 
	`•ö_u∆ock
(&
block_group
->
lock
);

1545 
block_group
->
io_˘l
.
öode
 = 
NULL
;

1546 
	`ùut
(
öode
);

1554  
ªt
;

1555 
	}
}

1557 
ölöe
 
	$off£t_to_bô
(
u64
 
bôm≠_°¨t
, 
u32
 
unô
,

1558 
u64
 
off£t
)

1560 
	`ASSERT
(
off£t
 >
bôm≠_°¨t
);

1561 
off£t
 -
bôm≠_°¨t
;

1562  ()(
	`div_u64
(
off£t
, 
unô
));

1563 
	}
}

1565 
ölöe
 
	$byãs_to_bôs
(
u64
 
byãs
, 
u32
 
unô
)

1567  ()(
	`div_u64
(
byãs
, 
unô
));

1568 
	}
}

1570 
ölöe
 
u64
 
	$off£t_to_bôm≠
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

1571 
u64
 
off£t
)

1573 
u64
 
bôm≠_°¨t
;

1574 
u64
 
byãs_≥r_bôm≠
;

1576 
byãs_≥r_bôm≠
 = 
BITS_PER_BITMAP
 * 
˘l
->
unô
;

1577 
bôm≠_°¨t
 = 
off£t
 - 
˘l
->
°¨t
;

1578 
bôm≠_°¨t
 = 
	`div64_u64
(bôm≠_°¨t, 
byãs_≥r_bôm≠
);

1579 
bôm≠_°¨t
 *
byãs_≥r_bôm≠
;

1580 
bôm≠_°¨t
 +
˘l
->
°¨t
;

1582  
bôm≠_°¨t
;

1583 
	}
}

1585 
	$åì_ö£π_off£t
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

1586 
båfs_‰ì_˛u°î
 *
˛u°î
,

1587 
båfs_‰ì_•a˚
 *
√w_íåy
)

1589 
rb_roŸ
 *
roŸ
;

1590 
rb_node
 **
p
;

1591 
rb_node
 *
∑ª¡
 = 
NULL
;

1593 
	`lockdï_as£π_hñd
(&
˘l
->
åì_lock
);

1595 i‡(
˛u°î
) {

1596 
	`lockdï_as£π_hñd
(&
˛u°î
->
lock
);

1597 
roŸ
 = &
˛u°î
->root;

1599 
roŸ
 = &
˘l
->
‰ì_•a˚_off£t
;

1602 
p
 = &
roŸ
->
rb_node
;

1604 *
p
) {

1605 
båfs_‰ì_•a˚
 *
öfo
;

1607 
∑ª¡
 = *
p
;

1608 
öfo
 = 
	`rb_íåy
(
∑ª¡
, 
båfs_‰ì_•a˚
, 
off£t_ödex
);

1610 i‡(
√w_íåy
->
off£t
 < 
öfo
->offset) {

1611 
p
 = &(*p)->
rb_À·
;

1612 } i‡(
√w_íåy
->
off£t
 > 
öfo
->offset) {

1613 
p
 = &(*p)->
rb_right
;

1628 i‡(
√w_íåy
->
bôm≠
) {

1629 i‡(
öfo
->
bôm≠
) {

1630 
	`WARN_ON_ONCE
(1);

1631  -
EEXIST
;

1633 
p
 = &(*p)->
rb_right
;

1635 i‡(!
öfo
->
bôm≠
) {

1636 
	`WARN_ON_ONCE
(1);

1637  -
EEXIST
;

1639 
p
 = &(*p)->
rb_À·
;

1644 
	`rb_lök_node
(&
√w_íåy
->
off£t_ödex
, 
∑ª¡
, 
p
);

1645 
	`rb_ö£π_cﬁ‹
(&
√w_íåy
->
off£t_ödex
, 
roŸ
);

1648 
	}
}

1674 
ölöe
 
u64
 
	$gë_max_exã¡_size
(c⁄° 
båfs_‰ì_•a˚
 *
íåy
)

1676 i‡(
íåy
->
bôm≠
 &&É¡ry->
max_exã¡_size
)

1677  
íåy
->
max_exã¡_size
;

1678  
íåy
->
byãs
;

1679 
	}
}

1685 
boﬁ
 
	$íåy_Àss
(
rb_node
 *
node
, c⁄° rb_nodê*
∑ª¡
)

1687 c⁄° 
båfs_‰ì_•a˚
 *
íåy
, *
exi°
;

1689 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
, 
byãs_ödex
);

1690 
exi°
 = 
	`rb_íåy
(
∑ª¡
, 
båfs_‰ì_•a˚
, 
byãs_ödex
);

1691  
	`gë_max_exã¡_size
(
exi°
Ë< gë_max_exã¡_size(
íåy
);

1692 
	}
}

1701 
båfs_‰ì_•a˚
 *

1702 
	$åì_£¨ch_off£t
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

1703 
u64
 
off£t
, 
bôm≠_⁄ly
, 
fuzzy
)

1705 
rb_node
 *
n
 = 
˘l
->
‰ì_•a˚_off£t
.rb_node;

1706 
båfs_‰ì_•a˚
 *
íåy
 = 
NULL
, *
¥ev
 = NULL;

1708 
	`lockdï_as£π_hñd
(&
˘l
->
åì_lock
);

1711 
n
) {

1712 
íåy
 = 
	`rb_íåy
(
n
, 
båfs_‰ì_•a˚
, 
off£t_ödex
);

1713 
¥ev
 = 
íåy
;

1715 i‡(
off£t
 < 
íåy
->offset)

1716 
n
 =Ç->
rb_À·
;

1717 i‡(
off£t
 > 
íåy
->offset)

1718 
n
 =Ç->
rb_right
;

1722 
íåy
 = 
NULL
;

1725 i‡(
bôm≠_⁄ly
) {

1726 i‡(!
íåy
)

1727  
NULL
;

1728 i‡(
íåy
->
bôm≠
)

1729  
íåy
;

1735 
n
 = 
	`rb_√xt
(n);

1736 i‡(!
n
)

1737  
NULL
;

1738 
íåy
 = 
	`rb_íåy
(
n
, 
båfs_‰ì_•a˚
, 
off£t_ödex
);

1739 i‡(
íåy
->
off£t
 != offset)

1740  
NULL
;

1742 
	`WARN_ON
(!
íåy
->
bôm≠
);

1743  
íåy
;

1744 } i‡(
íåy
) {

1745 i‡(
íåy
->
bôm≠
) {

1750 
n
 = 
	`rb_¥ev
(&
íåy
->
off£t_ödex
);

1751 i‡(
n
) {

1752 
¥ev
 = 
	`rb_íåy
(
n
, 
båfs_‰ì_•a˚
,

1753 
off£t_ödex
);

1754 i‡(!
¥ev
->
bôm≠
 &&

1755 
¥ev
->
off£t
 +Öªv->
byãs
 > offset)

1756 
íåy
 = 
¥ev
;

1759  
íåy
;

1762 i‡(!
¥ev
)

1763  
NULL
;

1766 
íåy
 = 
¥ev
;

1767 i‡(
íåy
->
off£t
 > offset) {

1768 
n
 = 
	`rb_¥ev
(&
íåy
->
off£t_ödex
);

1769 i‡(
n
) {

1770 
íåy
 = 
	`rb_íåy
(
n
, 
båfs_‰ì_•a˚
,

1771 
off£t_ödex
);

1772 
	`ASSERT
(
íåy
->
off£t
 <= offset);

1774 i‡(
fuzzy
)

1775  
íåy
;

1777  
NULL
;

1781 i‡(
íåy
->
bôm≠
) {

1782 
n
 = 
	`rb_¥ev
(&
íåy
->
off£t_ödex
);

1783 i‡(
n
) {

1784 
¥ev
 = 
	`rb_íåy
(
n
, 
båfs_‰ì_•a˚
,

1785 
off£t_ödex
);

1786 i‡(!
¥ev
->
bôm≠
 &&

1787 
¥ev
->
off£t
 +Öªv->
byãs
 > offset)

1788  
¥ev
;

1790 i‡(
íåy
->
off£t
 + 
BITS_PER_BITMAP
 * 
˘l
->
unô
 > offset)

1791  
íåy
;

1792 } i‡(
íåy
->
off£t
 +É¡ry->
byãs
 > offset)

1793  
íåy
;

1795 i‡(!
fuzzy
)

1796  
NULL
;

1799 
n
 = 
	`rb_√xt
(&
íåy
->
off£t_ödex
);

1800 i‡(!
n
)

1801  
NULL
;

1802 
íåy
 = 
	`rb_íåy
(
n
, 
båfs_‰ì_•a˚
, 
off£t_ödex
);

1803 i‡(
íåy
->
bôm≠
) {

1804 i‡(
íåy
->
off£t
 + 
BITS_PER_BITMAP
 *

1805 
˘l
->
unô
 > 
off£t
)

1808 i‡(
íåy
->
off£t
 +É¡ry->
byãs
 > offset)

1812  
íåy
;

1813 
	}
}

1815 
ölöe
 
	$u∆ök_‰ì_•a˚
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

1816 
båfs_‰ì_•a˚
 *
öfo
,

1817 
boﬁ
 
upd©e_°©
)

1819 
	`lockdï_as£π_hñd
(&
˘l
->
åì_lock
);

1821 
	`rb_îa£
(&
öfo
->
off£t_ödex
, &
˘l
->
‰ì_•a˚_off£t
);

1822 
	`rb_îa£_ˇched
(&
öfo
->
byãs_ödex
, &
˘l
->
‰ì_•a˚_byãs
);

1823 
˘l
->
‰ì_exã¡s
--;

1825 i‡(!
öfo
->
bôm≠
 && !
	`båfs_‰ì_•a˚_åimmed
(info)) {

1826 
˘l
->
disˇrdabÀ_exã¡s
[
BTRFS_STAT_CURR
]--;

1827 
˘l
->
disˇrdabÀ_byãs
[
BTRFS_STAT_CURR
] -
öfo
->
byãs
;

1830 i‡(
upd©e_°©
)

1831 
˘l
->
‰ì_•a˚
 -
öfo
->
byãs
;

1832 
	}
}

1834 
	$lök_‰ì_•a˚
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

1835 
båfs_‰ì_•a˚
 *
öfo
)

1837 
ªt
 = 0;

1839 
	`lockdï_as£π_hñd
(&
˘l
->
åì_lock
);

1841 
	`ASSERT
(
öfo
->
byãs
 || info->
bôm≠
);

1842 
ªt
 = 
	`åì_ö£π_off£t
(
˘l
, 
NULL
, 
öfo
);

1843 i‡(
ªt
)

1844  
ªt
;

1846 
	`rb_add_ˇched
(&
öfo
->
byãs_ödex
, &
˘l
->
‰ì_•a˚_byãs
, 
íåy_Àss
);

1848 i‡(!
öfo
->
bôm≠
 && !
	`båfs_‰ì_•a˚_åimmed
(info)) {

1849 
˘l
->
disˇrdabÀ_exã¡s
[
BTRFS_STAT_CURR
]++;

1850 
˘l
->
disˇrdabÀ_byãs
[
BTRFS_STAT_CURR
] +
öfo
->
byãs
;

1853 
˘l
->
‰ì_•a˚
 +
öfo
->
byãs
;

1854 
˘l
->
‰ì_exã¡s
++;

1855  
ªt
;

1856 
	}
}

1858 
	$ªlök_bôm≠_íåy
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

1859 
båfs_‰ì_•a˚
 *
öfo
)

1861 
	`ASSERT
(
öfo
->
bôm≠
);

1867 i‡(
	`RB_EMPTY_NODE
(&
öfo
->
byãs_ödex
))

1870 
	`lockdï_as£π_hñd
(&
˘l
->
åì_lock
);

1872 
	`rb_îa£_ˇched
(&
öfo
->
byãs_ödex
, &
˘l
->
‰ì_•a˚_byãs
);

1873 
	`rb_add_ˇched
(&
öfo
->
byãs_ödex
, &
˘l
->
‰ì_•a˚_byãs
, 
íåy_Àss
);

1874 
	}
}

1876 
ölöe
 
	$bôm≠_˛ór_bôs
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

1877 
båfs_‰ì_•a˚
 *
öfo
,

1878 
u64
 
off£t
, u64 
byãs
, 
boﬁ
 
upd©e_°©
)

1880 
°¨t
, 
cou¡
, 
íd
;

1881 
exã¡_dñè
 = -1;

1883 
°¨t
 = 
	`off£t_to_bô
(
öfo
->
off£t
, 
˘l
->
unô
, offset);

1884 
cou¡
 = 
	`byãs_to_bôs
(
byãs
, 
˘l
->
unô
);

1885 
íd
 = 
°¨t
 + 
cou¡
;

1886 
	`ASSERT
(
íd
 <
BITS_PER_BITMAP
);

1888 
	`bôm≠_˛ór
(
öfo
->
bôm≠
, 
°¨t
, 
cou¡
);

1890 
öfo
->
byãs
 -= bytes;

1891 i‡(
öfo
->
max_exã¡_size
 > 
˘l
->
unô
)

1892 
öfo
->
max_exã¡_size
 = 0;

1894 
	`ªlök_bôm≠_íåy
(
˘l
, 
öfo
);

1896 i‡(
°¨t
 && 
	`ã°_bô
(°¨à- 1, 
öfo
->
bôm≠
))

1897 
exã¡_dñè
++;

1899 i‡(
íd
 < 
BITS_PER_BITMAP
 && 
	`ã°_bô
”nd, 
öfo
->
bôm≠
))

1900 
exã¡_dñè
++;

1902 
öfo
->
bôm≠_exã¡s
 +
exã¡_dñè
;

1903 i‡(!
	`båfs_‰ì_•a˚_åimmed
(
öfo
)) {

1904 
˘l
->
disˇrdabÀ_exã¡s
[
BTRFS_STAT_CURR
] +
exã¡_dñè
;

1905 
˘l
->
disˇrdabÀ_byãs
[
BTRFS_STAT_CURR
] -
byãs
;

1908 i‡(
upd©e_°©
)

1909 
˘l
->
‰ì_•a˚
 -
byãs
;

1910 
	}
}

1912 
	$bôm≠_£t_bôs
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

1913 
båfs_‰ì_•a˚
 *
öfo
, 
u64
 
off£t
,

1914 
u64
 
byãs
)

1916 
°¨t
, 
cou¡
, 
íd
;

1917 
exã¡_dñè
 = 1;

1919 
°¨t
 = 
	`off£t_to_bô
(
öfo
->
off£t
, 
˘l
->
unô
, offset);

1920 
cou¡
 = 
	`byãs_to_bôs
(
byãs
, 
˘l
->
unô
);

1921 
íd
 = 
°¨t
 + 
cou¡
;

1922 
	`ASSERT
(
íd
 <
BITS_PER_BITMAP
);

1924 
	`bôm≠_£t
(
öfo
->
bôm≠
, 
°¨t
, 
cou¡
);

1930 
öfo
->
max_exã¡_size
 = 0;

1931 
öfo
->
byãs
 += bytes;

1932 
˘l
->
‰ì_•a˚
 +
byãs
;

1934 
	`ªlök_bôm≠_íåy
(
˘l
, 
öfo
);

1936 i‡(
°¨t
 && 
	`ã°_bô
(°¨à- 1, 
öfo
->
bôm≠
))

1937 
exã¡_dñè
--;

1939 i‡(
íd
 < 
BITS_PER_BITMAP
 && 
	`ã°_bô
”nd, 
öfo
->
bôm≠
))

1940 
exã¡_dñè
--;

1942 
öfo
->
bôm≠_exã¡s
 +
exã¡_dñè
;

1943 i‡(!
	`båfs_‰ì_•a˚_åimmed
(
öfo
)) {

1944 
˘l
->
disˇrdabÀ_exã¡s
[
BTRFS_STAT_CURR
] +
exã¡_dñè
;

1945 
˘l
->
disˇrdabÀ_byãs
[
BTRFS_STAT_CURR
] +
byãs
;

1947 
	}
}

1953 
	$£¨ch_bôm≠
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

1954 
båfs_‰ì_•a˚
 *
bôm≠_öfo
, 
u64
 *
off£t
,

1955 
u64
 *
byãs
, 
boﬁ
 
f‹_Æloc
)

1957 
found_bôs
 = 0;

1958 
max_bôs
 = 0;

1959 
bôs
, 
i
;

1960 
√xt_zîo
;

1961 
exã¡_bôs
;

1967 i‡(
f‹_Æloc
 &&

1968 
bôm≠_öfo
->
max_exã¡_size
 &&

1969 
bôm≠_öfo
->
max_exã¡_size
 < *
byãs
) {

1970 *
byãs
 = 
bôm≠_öfo
->
max_exã¡_size
;

1974 
i
 = 
	`off£t_to_bô
(
bôm≠_öfo
->
off£t
, 
˘l
->
unô
,

1975 
	`max_t
(
u64
, *
off£t
, 
bôm≠_öfo
->offset));

1976 
bôs
 = 
	`byãs_to_bôs
(*
byãs
, 
˘l
->
unô
);

1978 
	`f‹_óch_£t_bô_‰om
(
i
, 
bôm≠_öfo
->
bôm≠
, 
BITS_PER_BITMAP
) {

1979 i‡(
f‹_Æloc
 && 
bôs
 == 1) {

1980 
found_bôs
 = 1;

1983 
√xt_zîo
 = 
	`föd_√xt_zîo_bô
(
bôm≠_öfo
->
bôm≠
,

1984 
BITS_PER_BITMAP
, 
i
);

1985 
exã¡_bôs
 = 
√xt_zîo
 - 
i
;

1986 i‡(
exã¡_bôs
 >
bôs
) {

1987 
found_bôs
 = 
exã¡_bôs
;

1989 } i‡(
exã¡_bôs
 > 
max_bôs
) {

1990 
max_bôs
 = 
exã¡_bôs
;

1992 
i
 = 
√xt_zîo
;

1995 i‡(
found_bôs
) {

1996 *
off£t
 = (
u64
)(
i
 * 
˘l
->
unô
Ë+ 
bôm≠_öfo
->offset;

1997 *
byãs
 = (
u64
)(
found_bôs
Ë* 
˘l
->
unô
;

2001 *
byãs
 = (
u64
)(
max_bôs
Ë* 
˘l
->
unô
;

2002 
bôm≠_öfo
->
max_exã¡_size
 = *
byãs
;

2003 
	`ªlök_bôm≠_íåy
(
˘l
, 
bôm≠_öfo
);

2005 
	}
}

2008 
båfs_‰ì_•a˚
 *

2009 
	$föd_‰ì_•a˚
(
båfs_‰ì_•a˚_˘l
 *
˘l
, 
u64
 *
off£t
, u64 *
byãs
,

2010 
Æign
, 
u64
 *
max_exã¡_size
, 
boﬁ
 
u£_byãs_ödex
)

2012 
båfs_‰ì_•a˚
 *
íåy
;

2013 
rb_node
 *
node
;

2014 
u64
 
tmp
;

2015 
u64
 
Æign_off
;

2016 
ªt
;

2018 i‡(!
˘l
->
‰ì_•a˚_off£t
.
rb_node
)

2019 
out
;

2020 
agaö
:

2021 i‡(
u£_byãs_ödex
) {

2022 
node
 = 
	`rb_fú°_ˇched
(&
˘l
->
‰ì_•a˚_byãs
);

2024 
íåy
 = 
	`åì_£¨ch_off£t
(
˘l
, 
	`off£t_to_bôm≠
(˘l, *
off£t
),

2026 i‡(!
íåy
)

2027 
out
;

2028 
node
 = &
íåy
->
off£t_ödex
;

2031 ; 
node
;Çodê
	`rb_√xt
(node)) {

2032 i‡(
u£_byãs_ödex
)

2033 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
,

2034 
byãs_ödex
);

2036 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
,

2037 
off£t_ödex
);

2047 i‡(
íåy
->
byãs
 < *bytes) {

2048 *
max_exã¡_size
 = 
	`max
(
	`gë_max_exã¡_size
(
íåy
),

2049 *
max_exã¡_size
);

2050 i‡(
u£_byãs_ödex
)

2058 i‡(*
byãs
 >
Æign
) {

2059 
tmp
 = 
íåy
->
off£t
 - 
˘l
->
°¨t
 + 
Æign
 - 1;

2060 
tmp
 = 
	`div64_u64
—mp, 
Æign
);

2061 
tmp
 =Åm∞* 
Æign
 + 
˘l
->
°¨t
;

2062 
Æign_off
 = 
tmp
 - 
íåy
->
off£t
;

2064 
Æign_off
 = 0;

2065 
tmp
 = 
íåy
->
off£t
;

2075 i‡(
íåy
->
byãs
 < *byã†+ 
Æign_off
) {

2076 *
max_exã¡_size
 = 
	`max
(
	`gë_max_exã¡_size
(
íåy
),

2077 *
max_exã¡_size
);

2081 i‡(
íåy
->
bôm≠
) {

2082 
rb_node
 *
ﬁd_√xt
 = 
	`rb_√xt
(
node
);

2083 
u64
 
size
 = *
byãs
;

2085 
ªt
 = 
	`£¨ch_bôm≠
(
˘l
, 
íåy
, &
tmp
, &
size
, 
åue
);

2086 i‡(!
ªt
) {

2087 *
off£t
 = 
tmp
;

2088 *
byãs
 = 
size
;

2089  
íåy
;

2091 *
max_exã¡_size
 =

2092 
	`max
(
	`gë_max_exã¡_size
(
íåy
),

2093 *
max_exã¡_size
);

2102 i‡(
u£_byãs_ödex
 && 
ﬁd_√xt
 !
	`rb_√xt
(
node
))

2103 
agaö
;

2107 *
off£t
 = 
tmp
;

2108 *
byãs
 = 
íåy
->byã†- 
Æign_off
;

2109  
íåy
;

2111 
out
:

2112  
NULL
;

2113 
	}
}

2115 
	$add_√w_bôm≠
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

2116 
båfs_‰ì_•a˚
 *
öfo
, 
u64
 
off£t
)

2118 
öfo
->
off£t
 = 
	`off£t_to_bôm≠
(
˘l
, offset);

2119 
öfo
->
byãs
 = 0;

2120 
öfo
->
bôm≠_exã¡s
 = 0;

2121 
	`INIT_LIST_HEAD
(&
öfo
->
li°
);

2122 
	`lök_‰ì_•a˚
(
˘l
, 
öfo
);

2123 
˘l
->
tŸÆ_bôm≠s
++;

2124 
	`ªˇlcuœã_thªshﬁds
(
˘l
);

2125 
	}
}

2127 
	$‰ì_bôm≠
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

2128 
båfs_‰ì_•a˚
 *
bôm≠_öfo
)

2136 i‡(
bôm≠_öfo
->
byãs
 && !
	`båfs_‰ì_•a˚_åimmed
(bitmap_info)) {

2137 
˘l
->
disˇrdabÀ_exã¡s
[
BTRFS_STAT_CURR
] -=

2138 
bôm≠_öfo
->
bôm≠_exã¡s
;

2139 
˘l
->
disˇrdabÀ_byãs
[
BTRFS_STAT_CURR
] -
bôm≠_öfo
->
byãs
;

2142 
	`u∆ök_‰ì_•a˚
(
˘l
, 
bôm≠_öfo
, 
åue
);

2143 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_bôm≠_ˇchï
, 
bôm≠_öfo
->
bôm≠
);

2144 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
bôm≠_öfo
);

2145 
˘l
->
tŸÆ_bôm≠s
--;

2146 
	`ªˇlcuœã_thªshﬁds
(
˘l
);

2147 
	}
}

2149 
noölöe
 
	$ªmove_‰om_bôm≠
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

2150 
båfs_‰ì_•a˚
 *
bôm≠_öfo
,

2151 
u64
 *
off£t
, u64 *
byãs
)

2153 
u64
 
íd
;

2154 
u64
 
£¨ch_°¨t
, 
£¨ch_byãs
;

2155 
ªt
;

2157 
agaö
:

2158 
íd
 = 
bôm≠_öfo
->
off£t
 + (
u64
)(
BITS_PER_BITMAP
 * 
˘l
->
unô
) - 1;

2166 
£¨ch_°¨t
 = *
off£t
;

2167 
£¨ch_byãs
 = 
˘l
->
unô
;

2168 
£¨ch_byãs
 = 
	`mö
(£¨ch_byãs, 
íd
 - 
£¨ch_°¨t
 + 1);

2169 
ªt
 = 
	`£¨ch_bôm≠
(
˘l
, 
bôm≠_öfo
, &
£¨ch_°¨t
, &
£¨ch_byãs
,

2170 
Ál£
);

2171 i‡(
ªt
 < 0 || 
£¨ch_°¨t
 !*
off£t
)

2172  -
EINVAL
;

2175 
£¨ch_byãs
 = 
	`mö
(£¨ch_byãs, *
byãs
);

2178 
£¨ch_byãs
 = 
	`mö
(£¨ch_byãs, 
íd
 - 
£¨ch_°¨t
 + 1);

2180 
	`bôm≠_˛ór_bôs
(
˘l
, 
bôm≠_öfo
, 
£¨ch_°¨t
, 
£¨ch_byãs
, 
åue
);

2181 *
off£t
 +
£¨ch_byãs
;

2182 *
byãs
 -
£¨ch_byãs
;

2184 i‡(*
byãs
) {

2185 
rb_node
 *
√xt
 = 
	`rb_√xt
(&
bôm≠_öfo
->
off£t_ödex
);

2186 i‡(!
bôm≠_öfo
->
byãs
)

2187 
	`‰ì_bôm≠
(
˘l
, 
bôm≠_öfo
);

2193 i‡(!
√xt
)

2194  -
EINVAL
;

2196 
bôm≠_öfo
 = 
	`rb_íåy
(
√xt
, 
båfs_‰ì_•a˚
,

2197 
off£t_ödex
);

2203 i‡(!
bôm≠_öfo
->
bôm≠
)

2204  -
EAGAIN
;

2212 
£¨ch_°¨t
 = *
off£t
;

2213 
£¨ch_byãs
 = 
˘l
->
unô
;

2214 
ªt
 = 
	`£¨ch_bôm≠
(
˘l
, 
bôm≠_öfo
, &
£¨ch_°¨t
,

2215 &
£¨ch_byãs
, 
Ál£
);

2216 i‡(
ªt
 < 0 || 
£¨ch_°¨t
 !*
off£t
)

2217  -
EAGAIN
;

2219 
agaö
;

2220 } i‡(!
bôm≠_öfo
->
byãs
)

2221 
	`‰ì_bôm≠
(
˘l
, 
bôm≠_öfo
);

2224 
	}
}

2226 
u64
 
	$add_byãs_to_bôm≠
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

2227 
båfs_‰ì_•a˚
 *
öfo
, 
u64
 
off£t
,

2228 
u64
 
byãs
, 
båfs_åim_°©e
 
åim_°©e
)

2230 
u64
 
byãs_to_£t
 = 0;

2231 
u64
 
íd
;

2237 i‡(
åim_°©e
 =
BTRFS_TRIM_STATE_UNTRIMMED
) {

2238 i‡(
	`båfs_‰ì_•a˚_åimmed
(
öfo
)) {

2239 
˘l
->
disˇrdabÀ_exã¡s
[
BTRFS_STAT_CURR
] +=

2240 
öfo
->
bôm≠_exã¡s
;

2241 
˘l
->
disˇrdabÀ_byãs
[
BTRFS_STAT_CURR
] +
öfo
->
byãs
;

2243 
öfo
->
åim_°©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

2246 
íd
 = 
öfo
->
off£t
 + (
u64
)(
BITS_PER_BITMAP
 * 
˘l
->
unô
);

2248 
byãs_to_£t
 = 
	`mö
(
íd
 - 
off£t
, 
byãs
);

2250 
	`bôm≠_£t_bôs
(
˘l
, 
öfo
, 
off£t
, 
byãs_to_£t
);

2252  
byãs_to_£t
;

2254 
	}
}

2256 
boﬁ
 
	$u£_bôm≠
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

2257 
båfs_‰ì_•a˚
 *
öfo
)

2259 
båfs_block_group
 *
block_group
 = 
˘l
->block_group;

2260 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

2261 
boﬁ
 
f‹˚d
 = 
Ál£
;

2263 #ifde‡
CONFIG_BTRFS_DEBUG


2264 i‡(
	`båfs_should_‰agmít_‰ì_•a˚
(
block_group
))

2265 
f‹˚d
 = 
åue
;

2269 i‡(!
f‹˚d
 && 
öfo
->
byãs
 >
FORCE_EXTENT_THRESHOLD
)

2270  
Ál£
;

2276 i‡(!
f‹˚d
 && 
˘l
->
‰ì_exã¡s
 < cé->
exã¡s_thªsh
) {

2284 i‡(
öfo
->
byãs
 <
fs_öfo
->
£˘‹size
 * 8) {

2285 i‡(
˘l
->
‰ì_exã¡s
 * 3 <˘l->
exã¡s_thªsh
)

2286  
Ál£
;

2288  
Ál£
;

2300 i‡(((
BITS_PER_BITMAP
 * 
˘l
->
unô
Ë>> 1Ë> 
block_group
->
Àngth
)

2301  
Ál£
;

2303  
åue
;

2304 
	}
}

2306 c⁄° 
båfs_‰ì_•a˚_›
 
	g‰ì_•a˚_›
 = {

2307 .
u£_bôm≠
 = use_bitmap,

2310 
	$ö£π_öto_bôm≠
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

2311 
båfs_‰ì_•a˚
 *
öfo
)

2313 
båfs_‰ì_•a˚
 *
bôm≠_öfo
;

2314 
båfs_block_group
 *
block_group
 = 
NULL
;

2315 
added
 = 0;

2316 
u64
 
byãs
, 
off£t
, 
byãs_added
;

2317 
båfs_åim_°©e
 
åim_°©e
;

2318 
ªt
;

2320 
byãs
 = 
öfo
->bytes;

2321 
off£t
 = 
öfo
->offset;

2322 
åim_°©e
 = 
öfo
->trim_state;

2324 i‡(!
˘l
->
›
->
	`u£_bôm≠
(˘l, 
öfo
))

2327 i‡(
˘l
->
›
 =&
‰ì_•a˚_›
)

2328 
block_group
 = 
˘l
->block_group;

2329 
agaö
:

2335 i‡(
block_group
 && !
	`li°_em±y
(&block_group->
˛u°î_li°
)) {

2336 
båfs_‰ì_˛u°î
 *
˛u°î
;

2337 
rb_node
 *
node
;

2338 
båfs_‰ì_•a˚
 *
íåy
;

2340 
˛u°î
 = 
	`li°_íåy
(
block_group
->
˛u°î_li°
.
√xt
,

2341 
båfs_‰ì_˛u°î
,

2342 
block_group_li°
);

2343 
	`•ö_lock
(&
˛u°î
->
lock
);

2344 
node
 = 
	`rb_fú°
(&
˛u°î
->
roŸ
);

2345 i‡(!
node
) {

2346 
	`•ö_u∆ock
(&
˛u°î
->
lock
);

2347 
no_˛u°î_bôm≠
;

2350 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
, 
off£t_ödex
);

2351 i‡(!
íåy
->
bôm≠
) {

2352 
	`•ö_u∆ock
(&
˛u°î
->
lock
);

2353 
no_˛u°î_bôm≠
;

2356 i‡(
íåy
->
off£t
 =
	`off£t_to_bôm≠
(
˘l
, offset)) {

2357 
byãs_added
 = 
	`add_byãs_to_bôm≠
(
˘l
, 
íåy
, 
off£t
,

2358 
byãs
, 
åim_°©e
);

2359 
byãs
 -
byãs_added
;

2360 
off£t
 +
byãs_added
;

2362 
	`•ö_u∆ock
(&
˛u°î
->
lock
);

2363 i‡(!
byãs
) {

2364 
ªt
 = 1;

2365 
out
;

2369 
no_˛u°î_bôm≠
:

2370 
bôm≠_öfo
 = 
	`åì_£¨ch_off£t
(
˘l
, 
	`off£t_to_bôm≠
(˘l, 
off£t
),

2372 i‡(!
bôm≠_öfo
) {

2373 
	`ASSERT
(
added
 == 0);

2374 
√w_bôm≠
;

2377 
byãs_added
 = 
	`add_byãs_to_bôm≠
(
˘l
, 
bôm≠_öfo
, 
off£t
, 
byãs
,

2378 
åim_°©e
);

2379 
byãs
 -
byãs_added
;

2380 
off£t
 +
byãs_added
;

2381 
added
 = 0;

2383 i‡(!
byãs
) {

2384 
ªt
 = 1;

2385 
out
;

2387 
agaö
;

2389 
√w_bôm≠
:

2390 i‡(
öfo
 && info->
bôm≠
) {

2391 
	`add_√w_bôm≠
(
˘l
, 
öfo
, 
off£t
);

2392 
added
 = 1;

2393 
öfo
 = 
NULL
;

2394 
agaö
;

2396 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

2399 i‡(!
öfo
) {

2400 
öfo
 = 
	`kmem_ˇche_zÆloc
(
båfs_‰ì_•a˚_ˇchï
,

2401 
GFP_NOFS
);

2402 i‡(!
öfo
) {

2403 
	`•ö_lock
(&
˘l
->
åì_lock
);

2404 
ªt
 = -
ENOMEM
;

2405 
out
;

2410 
öfo
->
bôm≠
 = 
	`kmem_ˇche_zÆloc
(
båfs_‰ì_•a˚_bôm≠_ˇchï
,

2411 
GFP_NOFS
);

2412 
öfo
->
åim_°©e
 = 
BTRFS_TRIM_STATE_TRIMMED
;

2413 
	`•ö_lock
(&
˘l
->
åì_lock
);

2414 i‡(!
öfo
->
bôm≠
) {

2415 
ªt
 = -
ENOMEM
;

2416 
out
;

2418 
agaö
;

2421 
out
:

2422 i‡(
öfo
) {

2423 i‡(
öfo
->
bôm≠
)

2424 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_bôm≠_ˇchï
,

2425 
öfo
->
bôm≠
);

2426 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
öfo
);

2429  
ªt
;

2430 
	}
}

2448 
boﬁ
 
	$åy_mîge_‰ì_•a˚
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

2449 
båfs_‰ì_•a˚
 *
öfo
, 
boﬁ
 
upd©e_°©
)

2451 
båfs_‰ì_•a˚
 *
À·_öfo
 = 
NULL
;

2452 
båfs_‰ì_•a˚
 *
right_öfo
;

2453 
boﬁ
 
mîged
 = 
Ál£
;

2454 
u64
 
off£t
 = 
öfo
->offset;

2455 
u64
 
byãs
 = 
öfo
->bytes;

2456 c⁄° 
boﬁ
 
is_åimmed
 = 
	`båfs_‰ì_•a˚_åimmed
(
öfo
);

2457 
rb_node
 *
right_¥ev
 = 
NULL
;

2464 
right_öfo
 = 
	`åì_£¨ch_off£t
(
˘l
, 
off£t
 + 
byãs
, 0, 0);

2465 i‡(
right_öfo
)

2466 
right_¥ev
 = 
	`rb_¥ev
(&
right_öfo
->
off£t_ödex
);

2468 i‡(
right_¥ev
)

2469 
À·_öfo
 = 
	`rb_íåy
(
right_¥ev
, 
båfs_‰ì_•a˚
, 
off£t_ödex
);

2470 i‡(!
right_öfo
)

2471 
À·_öfo
 = 
	`åì_£¨ch_off£t
(
˘l
, 
off£t
 - 1, 0, 0);

2474 i‡(
right_öfo
 && !right_öfo->
bôm≠
 &&

2475 (!
is_åimmed
 || 
	`båfs_‰ì_•a˚_åimmed
(
right_öfo
))) {

2476 
	`u∆ök_‰ì_•a˚
(
˘l
, 
right_öfo
, 
upd©e_°©
);

2477 
öfo
->
byãs
 +
right_öfo
->bytes;

2478 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
right_öfo
);

2479 
mîged
 = 
åue
;

2483 i‡(
À·_öfo
 && !À·_öfo->
bôm≠
 &&

2484 
À·_öfo
->
off£t
 +Üe·_öfo->
byãs
 == offset &&

2485 (!
is_åimmed
 || 
	`båfs_‰ì_•a˚_åimmed
(
À·_öfo
))) {

2486 
	`u∆ök_‰ì_•a˚
(
˘l
, 
À·_öfo
, 
upd©e_°©
);

2487 
öfo
->
off£t
 = 
À·_öfo
->offset;

2488 
öfo
->
byãs
 +
À·_öfo
->bytes;

2489 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
À·_öfo
);

2490 
mîged
 = 
åue
;

2493  
mîged
;

2494 
	}
}

2496 
boﬁ
 
	$°ól_‰om_bôm≠_to_íd
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

2497 
båfs_‰ì_•a˚
 *
öfo
,

2498 
boﬁ
 
upd©e_°©
)

2500 
båfs_‰ì_•a˚
 *
bôm≠
;

2501 
i
;

2502 
j
;

2503 c⁄° 
u64
 
íd
 = 
öfo
->
off£t
 + info->
byãs
;

2504 c⁄° 
u64
 
bôm≠_off£t
 = 
	`off£t_to_bôm≠
(
˘l
, 
íd
);

2505 
u64
 
byãs
;

2507 
bôm≠
 = 
	`åì_£¨ch_off£t
(
˘l
, 
bôm≠_off£t
, 1, 0);

2508 i‡(!
bôm≠
)

2509  
Ál£
;

2511 
i
 = 
	`off£t_to_bô
(
bôm≠
->
off£t
, 
˘l
->
unô
, 
íd
);

2512 
j
 = 
	`föd_√xt_zîo_bô
(
bôm≠
->bôm≠, 
BITS_PER_BITMAP
, 
i
);

2513 i‡(
j
 =
i
)

2514  
Ál£
;

2515 
byãs
 = (
j
 - 
i
Ë* 
˘l
->
unô
;

2516 
öfo
->
byãs
 += bytes;

2519 i‡(!
	`båfs_‰ì_•a˚_åimmed
(
bôm≠
))

2520 
öfo
->
åim_°©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

2522 
	`bôm≠_˛ór_bôs
(
˘l
, 
bôm≠
, 
íd
, 
byãs
, 
upd©e_°©
);

2524 i‡(!
bôm≠
->
byãs
)

2525 
	`‰ì_bôm≠
(
˘l
, 
bôm≠
);

2527  
åue
;

2528 
	}
}

2530 
boﬁ
 
	$°ól_‰om_bôm≠_to_‰⁄t
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

2531 
båfs_‰ì_•a˚
 *
öfo
,

2532 
boﬁ
 
upd©e_°©
)

2534 
båfs_‰ì_•a˚
 *
bôm≠
;

2535 
u64
 
bôm≠_off£t
;

2536 
i
;

2537 
j
;

2538 
¥ev_j
;

2539 
u64
 
byãs
;

2541 
bôm≠_off£t
 = 
	`off£t_to_bôm≠
(
˘l
, 
öfo
->
off£t
);

2543 i‡(
bôm≠_off£t
 =
öfo
->
off£t
) {

2544 i‡(
öfo
->
off£t
 == 0)

2545  
Ál£
;

2546 
bôm≠_off£t
 = 
	`off£t_to_bôm≠
(
˘l
, 
öfo
->
off£t
 - 1);

2549 
bôm≠
 = 
	`åì_£¨ch_off£t
(
˘l
, 
bôm≠_off£t
, 1, 0);

2550 i‡(!
bôm≠
)

2551  
Ál£
;

2553 
i
 = 
	`off£t_to_bô
(
bôm≠
->
off£t
, 
˘l
->
unô
, 
öfo
->offset) - 1;

2554 
j
 = 0;

2555 
¥ev_j
 = ()-1;

2556 
	`f‹_óch_˛ór_bô_‰om
(
j
, 
bôm≠
->bôm≠, 
BITS_PER_BITMAP
) {

2557 i‡(
j
 > 
i
)

2559 
¥ev_j
 = 
j
;

2561 i‡(
¥ev_j
 =
i
)

2562  
Ál£
;

2564 i‡(
¥ev_j
 == ()-1)

2565 
byãs
 = (
i
 + 1Ë* 
˘l
->
unô
;

2567 
byãs
 = (
i
 - 
¥ev_j
Ë* 
˘l
->
unô
;

2569 
öfo
->
off£t
 -
byãs
;

2570 
öfo
->
byãs
 += bytes;

2573 i‡(!
	`båfs_‰ì_•a˚_åimmed
(
bôm≠
))

2574 
öfo
->
åim_°©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

2576 
	`bôm≠_˛ór_bôs
(
˘l
, 
bôm≠
, 
öfo
->
off£t
, 
byãs
, 
upd©e_°©
);

2578 i‡(!
bôm≠
->
byãs
)

2579 
	`‰ì_bôm≠
(
˘l
, 
bôm≠
);

2581  
åue
;

2582 
	}
}

2595 
	$°ól_‰om_bôm≠
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

2596 
båfs_‰ì_•a˚
 *
öfo
,

2597 
boﬁ
 
upd©e_°©
)

2603 
	`ASSERT
(!
öfo
->
bôm≠
);

2604 
	`ASSERT
(
	`RB_EMPTY_NODE
(&
öfo
->
off£t_ödex
));

2606 i‡(
˘l
->
tŸÆ_bôm≠s
 > 0) {

2607 
boﬁ
 
°ﬁe_íd
;

2608 
boﬁ
 
°ﬁe_‰⁄t
 = 
Ál£
;

2610 
°ﬁe_íd
 = 
	`°ól_‰om_bôm≠_to_íd
(
˘l
, 
öfo
, 
upd©e_°©
);

2611 i‡(
˘l
->
tŸÆ_bôm≠s
 > 0)

2612 
°ﬁe_‰⁄t
 = 
	`°ól_‰om_bôm≠_to_‰⁄t
(
˘l
, 
öfo
,

2613 
upd©e_°©
);

2615 i‡(
°ﬁe_íd
 || 
°ﬁe_‰⁄t
)

2616 
	`åy_mîge_‰ì_•a˚
(
˘l
, 
öfo
, 
upd©e_°©
);

2618 
	}
}

2620 
	$__båfs_add_‰ì_•a˚
(
båfs_block_group
 *
block_group
,

2621 
u64
 
off£t
, u64 
byãs
,

2622 
båfs_åim_°©e
 
åim_°©e
)

2624 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

2625 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

2626 
båfs_‰ì_•a˚
 *
öfo
;

2627 
ªt
 = 0;

2628 
u64
 
fûãr_byãs
 = 
byãs
;

2630 
	`ASSERT
(!
	`båfs_is_z⁄ed
(
fs_öfo
));

2632 
öfo
 = 
	`kmem_ˇche_zÆloc
(
båfs_‰ì_•a˚_ˇchï
, 
GFP_NOFS
);

2633 i‡(!
öfo
)

2634  -
ENOMEM
;

2636 
öfo
->
off£t
 = offset;

2637 
öfo
->
byãs
 = bytes;

2638 
öfo
->
åim_°©e
 =Årim_state;

2639 
	`RB_CLEAR_NODE
(&
öfo
->
off£t_ödex
);

2640 
	`RB_CLEAR_NODE
(&
öfo
->
byãs_ödex
);

2642 
	`•ö_lock
(&
˘l
->
åì_lock
);

2644 i‡(
	`åy_mîge_‰ì_•a˚
(
˘l
, 
öfo
, 
åue
))

2645 
lök
;

2652 
ªt
 = 
	`ö£π_öto_bôm≠
(
˘l
, 
öfo
);

2653 i‡(
ªt
 < 0) {

2654 
out
;

2655 } i‡(
ªt
) {

2656 
ªt
 = 0;

2657 
out
;

2659 
lök
:

2666 
	`°ól_‰om_bôm≠
(
˘l
, 
öfo
, 
åue
);

2668 
fûãr_byãs
 = 
	`max
(fûãr_byãs, 
öfo
->
byãs
);

2670 
ªt
 = 
	`lök_‰ì_•a˚
(
˘l
, 
öfo
);

2671 i‡(
ªt
)

2672 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
öfo
);

2673 
out
:

2674 
	`båfs_disˇrd_upd©e_disˇrdabÀ
(
block_group
);

2675 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

2677 i‡(
ªt
) {

2678 
	`båfs_¸ô
(
fs_öfo
, "u«bÀÅÿadd fªê•a˚ :%d", 
ªt
);

2679 
	`ASSERT
(
ªt
 !-
EEXIST
);

2682 i‡(
åim_°©e
 !
BTRFS_TRIM_STATE_TRIMMED
) {

2683 
	`båfs_disˇrd_check_fûãr
(
block_group
, 
fûãr_byãs
);

2684 
	`båfs_disˇrd_queue_w‹k
(&
fs_öfo
->
disˇrd_˘l
, 
block_group
);

2687  
ªt
;

2688 
	}
}

2690 
	$__båfs_add_‰ì_•a˚_z⁄ed
(
båfs_block_group
 *
block_group
,

2691 
u64
 
byãƒ
, u64 
size
, 
boﬁ
 
u£d
)

2693 
båfs_•a˚_öfo
 *
söfo
 = 
block_group
->
•a˚_öfo
;

2694 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

2695 
u64
 
off£t
 = 
byãƒ
 - 
block_group
->
°¨t
;

2696 
u64
 
to_‰ì
, 
to_unußbÀ
;

2697 
bg_ª˛aim_thªshﬁd
 = 0;

2698 
boﬁ
 
öôül
 = (
size
 =
block_group
->
Àngth
);

2699 
u64
 
ª˛aimabÀ_unußbÀ
;

2701 
	`WARN_ON
(!
öôül
 && 
off£t
 + 
size
 > 
block_group
->
z⁄e_ˇ∑côy
);

2703 i‡(!
öôül
)

2704 
bg_ª˛aim_thªshﬁd
 = 
	`READ_ONCE
(
söfo
->bg_reclaim_threshold);

2706 
	`•ö_lock
(&
˘l
->
åì_lock
);

2707 i‡(!
u£d
)

2708 
to_‰ì
 = 
size
;

2709 i‡(
öôül
)

2710 
to_‰ì
 = 
block_group
->
z⁄e_ˇ∑côy
;

2711 i‡(
off£t
 >
block_group
->
Æloc_off£t
)

2712 
to_‰ì
 = 
size
;

2713 i‡(
off£t
 + 
size
 <
block_group
->
Æloc_off£t
)

2714 
to_‰ì
 = 0;

2716 
to_‰ì
 = 
off£t
 + 
size
 - 
block_group
->
Æloc_off£t
;

2717 
to_unußbÀ
 = 
size
 - 
to_‰ì
;

2719 
˘l
->
‰ì_•a˚
 +
to_‰ì
;

2724 i‡(!
block_group
->
ro
)

2725 
block_group
->
z⁄e_unußbÀ
 +
to_unußbÀ
;

2726 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

2727 i‡(!
u£d
) {

2728 
	`•ö_lock
(&
block_group
->
lock
);

2729 
block_group
->
Æloc_off£t
 -
size
;

2730 
	`•ö_u∆ock
(&
block_group
->
lock
);

2733 
ª˛aimabÀ_unußbÀ
 = 
block_group
->
z⁄e_unußbÀ
 -

2734 (
block_group
->
Àngth
 - block_group->
z⁄e_ˇ∑côy
);

2736 i‡(
block_group
->
z⁄e_unußbÀ
 =block_group->
Àngth
) {

2737 
	`båfs_m¨k_bg_unu£d
(
block_group
);

2738 } i‡(
bg_ª˛aim_thªshﬁd
 &&

2739 
ª˛aimabÀ_unußbÀ
 >=

2740 
	`mu…_≥rc
(
block_group
->
z⁄e_ˇ∑côy
, 
bg_ª˛aim_thªshﬁd
)) {

2741 
	`båfs_m¨k_bg_to_ª˛aim
(
block_group
);

2745 
	}
}

2747 
	$båfs_add_‰ì_•a˚
(
båfs_block_group
 *
block_group
,

2748 
u64
 
byãƒ
, u64 
size
)

2750 
båfs_åim_°©e
 
åim_°©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

2752 i‡(
	`båfs_is_z⁄ed
(
block_group
->
fs_öfo
))

2753  
	`__båfs_add_‰ì_•a˚_z⁄ed
(
block_group
, 
byãƒ
, 
size
,

2754 
åue
);

2756 i‡(
	`båfs_ã°_›t
(
block_group
->
fs_öfo
, 
DISCARD_SYNC
))

2757 
åim_°©e
 = 
BTRFS_TRIM_STATE_TRIMMED
;

2759  
	`__båfs_add_‰ì_•a˚
(
block_group
, 
byãƒ
, 
size
, 
åim_°©e
);

2760 
	}
}

2762 
	$båfs_add_‰ì_•a˚_unu£d
(
båfs_block_group
 *
block_group
,

2763 
u64
 
byãƒ
, u64 
size
)

2765 i‡(
	`båfs_is_z⁄ed
(
block_group
->
fs_öfo
))

2766  
	`__båfs_add_‰ì_•a˚_z⁄ed
(
block_group
, 
byãƒ
, 
size
,

2767 
Ál£
);

2769  
	`båfs_add_‰ì_•a˚
(
block_group
, 
byãƒ
, 
size
);

2770 
	}
}

2777 
	$båfs_add_‰ì_•a˚_async_åimmed
(
båfs_block_group
 *
block_group
,

2778 
u64
 
byãƒ
, u64 
size
)

2780 
båfs_åim_°©e
 
åim_°©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

2782 i‡(
	`båfs_is_z⁄ed
(
block_group
->
fs_öfo
))

2783  
	`__båfs_add_‰ì_•a˚_z⁄ed
(
block_group
, 
byãƒ
, 
size
,

2784 
åue
);

2786 i‡(
	`båfs_ã°_›t
(
block_group
->
fs_öfo
, 
DISCARD_SYNC
) ||

2787 
	`båfs_ã°_›t
(
block_group
->
fs_öfo
, 
DISCARD_ASYNC
))

2788 
åim_°©e
 = 
BTRFS_TRIM_STATE_TRIMMED
;

2790  
	`__båfs_add_‰ì_•a˚
(
block_group
, 
byãƒ
, 
size
, 
åim_°©e
);

2791 
	}
}

2793 
	$båfs_ªmove_‰ì_•a˚
(
båfs_block_group
 *
block_group
,

2794 
u64
 
off£t
, u64 
byãs
)

2796 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

2797 
båfs_‰ì_•a˚
 *
öfo
;

2798 
ªt
;

2799 
boﬁ
 
ª_£¨ch
 = 
Ál£
;

2801 i‡(
	`båfs_is_z⁄ed
(
block_group
->
fs_öfo
)) {

2813 i‡(
block_group
->
°¨t
 + block_group->
Æloc_off£t
 <

2814 
off£t
 + 
byãs
) {

2815 
block_group
->
Æloc_off£t
 =

2816 
off£t
 + 
byãs
 - 
block_group
->
°¨t
;

2821 
	`•ö_lock
(&
˘l
->
åì_lock
);

2823 
agaö
:

2824 
ªt
 = 0;

2825 i‡(!
byãs
)

2826 
out_lock
;

2828 
öfo
 = 
	`åì_£¨ch_off£t
(
˘l
, 
off£t
, 0, 0);

2829 i‡(!
öfo
) {

2834 
öfo
 = 
	`åì_£¨ch_off£t
(
˘l
, 
	`off£t_to_bôm≠
(˘l, 
off£t
),

2836 i‡(!
öfo
) {

2842 
	`WARN_ON
(
ª_£¨ch
);

2843 
out_lock
;

2847 
ª_£¨ch
 = 
Ál£
;

2848 i‡(!
öfo
->
bôm≠
) {

2849 
	`u∆ök_‰ì_•a˚
(
˘l
, 
öfo
, 
åue
);

2850 i‡(
off£t
 =
öfo
->offset) {

2851 
u64
 
to_‰ì
 = 
	`mö
(
byãs
, 
öfo
->bytes);

2853 
öfo
->
byãs
 -
to_‰ì
;

2854 
öfo
->
off£t
 +
to_‰ì
;

2855 i‡(
öfo
->
byãs
) {

2856 
ªt
 = 
	`lök_‰ì_•a˚
(
˘l
, 
öfo
);

2857 
	`WARN_ON
(
ªt
);

2859 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
öfo
);

2862 
off£t
 +
to_‰ì
;

2863 
byãs
 -
to_‰ì
;

2864 
agaö
;

2866 
u64
 
ﬁd_íd
 = 
öfo
->
byãs
 + info->
off£t
;

2868 
öfo
->
byãs
 = 
off£t
 - info->offset;

2869 
ªt
 = 
	`lök_‰ì_•a˚
(
˘l
, 
öfo
);

2870 
	`WARN_ON
(
ªt
);

2871 i‡(
ªt
)

2872 
out_lock
;

2875 i‡(
ﬁd_íd
 < 
off£t
 + 
byãs
) {

2876 
byãs
 -
ﬁd_íd
 - 
off£t
;

2877 
off£t
 = 
ﬁd_íd
;

2878 
agaö
;

2879 } i‡(
ﬁd_íd
 =
off£t
 + 
byãs
) {

2881 
out_lock
;

2883 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

2885 
ªt
 = 
	`__båfs_add_‰ì_•a˚
(
block_group
,

2886 
off£t
 + 
byãs
,

2887 
ﬁd_íd
 - (
off£t
 + 
byãs
),

2888 
öfo
->
åim_°©e
);

2889 
	`WARN_ON
(
ªt
);

2890 
out
;

2894 
ªt
 = 
	`ªmove_‰om_bôm≠
(
˘l
, 
öfo
, &
off£t
, &
byãs
);

2895 i‡(
ªt
 =-
EAGAIN
) {

2896 
ª_£¨ch
 = 
åue
;

2897 
agaö
;

2899 
out_lock
:

2900 
	`båfs_disˇrd_upd©e_disˇrdabÀ
(
block_group
);

2901 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

2902 
out
:

2903  
ªt
;

2904 
	}
}

2906 
	$båfs_dump_‰ì_•a˚
(
båfs_block_group
 *
block_group
,

2907 
u64
 
byãs
)

2909 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

2910 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

2911 
båfs_‰ì_•a˚
 *
öfo
;

2912 
rb_node
 *
n
;

2913 
cou¡
 = 0;

2919 i‡(
	`båfs_is_z⁄ed
(
fs_öfo
)) {

2920 
	`båfs_öfo
(
fs_öfo
, "free space %lluáctive %d",

2921 
block_group
->
z⁄e_ˇ∑côy
 - block_group->
Æloc_off£t
,

2922 
	`ã°_bô
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
,

2923 &
block_group
->
ru¡ime_Êags
));

2927 
	`•ö_lock
(&
˘l
->
åì_lock
);

2928 
n
 = 
	`rb_fú°
(&
˘l
->
‰ì_•a˚_off£t
);Ç;Ç = 
	`rb_√xt
(n)) {

2929 
öfo
 = 
	`rb_íåy
(
n
, 
båfs_‰ì_•a˚
, 
off£t_ödex
);

2930 i‡(
öfo
->
byãs
 >byã†&& !
block_group
->
ro
)

2931 
cou¡
++;

2932 
	`båfs_¸ô
(
fs_öfo
, "entry offset %llu, bytes %llu, bitmap %s",

2933 
öfo
->
off£t
, info->
byãs
,

2934 (
öfo
->
bôm≠
) ? "yes" : "no");

2936 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

2937 
	`båfs_öfo
(
fs_öfo
, "block group has cluster?: %s",

2938 
	`li°_em±y
(&
block_group
->
˛u°î_li°
) ? "no" : "yes");

2939 
	`båfs_öfo
(
fs_öfo
,

2941 
cou¡
, 
byãs
);

2942 
	}
}

2944 
	$båfs_öô_‰ì_•a˚_˘l
(
båfs_block_group
 *
block_group
,

2945 
båfs_‰ì_•a˚_˘l
 *
˘l
)

2947 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

2949 
	`•ö_lock_öô
(&
˘l
->
åì_lock
);

2950 
˘l
->
unô
 = 
fs_öfo
->
£˘‹size
;

2951 
˘l
->
°¨t
 = 
block_group
->start;

2952 
˘l
->
block_group
 = block_group;

2953 
˘l
->
›
 = &
‰ì_•a˚_›
;

2954 
˘l
->
‰ì_•a˚_byãs
 = 
RB_ROOT_CACHED
;

2955 
	`INIT_LIST_HEAD
(&
˘l
->
åimmög_ønges
);

2956 
	`muãx_öô
(&
˘l
->
ˇche_wrôeout_muãx
);

2963 
˘l
->
exã¡s_thªsh
 = (
SZ_32K
 / 2Ë/ (
båfs_‰ì_•a˚
);

2964 
	}
}

2972 
	$__båfs_ªtu∫_˛u°î_to_‰ì_•a˚
(

2973 
båfs_block_group
 *
block_group
,

2974 
båfs_‰ì_˛u°î
 *
˛u°î
)

2976 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

2977 
rb_node
 *
node
;

2979 
	`lockdï_as£π_hñd
(&
˘l
->
åì_lock
);

2981 
	`•ö_lock
(&
˛u°î
->
lock
);

2982 i‡(
˛u°î
->
block_group
 != block_group) {

2983 
	`•ö_u∆ock
(&
˛u°î
->
lock
);

2987 
˛u°î
->
block_group
 = 
NULL
;

2988 
˛u°î
->
wödow_°¨t
 = 0;

2989 
	`li°_dñ_öô
(&
˛u°î
->
block_group_li°
);

2991 
node
 = 
	`rb_fú°
(&
˛u°î
->
roŸ
);

2992 
node
) {

2993 
båfs_‰ì_•a˚
 *
íåy
;

2995 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
, 
off£t_ödex
);

2996 
node
 = 
	`rb_√xt
(&
íåy
->
off£t_ödex
);

2997 
	`rb_îa£
(&
íåy
->
off£t_ödex
, &
˛u°î
->
roŸ
);

2998 
	`RB_CLEAR_NODE
(&
íåy
->
off£t_ödex
);

3000 i‡(!
íåy
->
bôm≠
) {

3002 i‡(!
	`båfs_‰ì_•a˚_åimmed
(
íåy
)) {

3003 
˘l
->
disˇrdabÀ_exã¡s
[
BTRFS_STAT_CURR
]--;

3004 
˘l
->
disˇrdabÀ_byãs
[
BTRFS_STAT_CURR
] -=

3005 
íåy
->
byãs
;

3008 
	`åy_mîge_‰ì_•a˚
(
˘l
, 
íåy
, 
Ál£
);

3009 
	`°ól_‰om_bôm≠
(
˘l
, 
íåy
, 
Ál£
);

3012 i‡(!
	`båfs_‰ì_•a˚_åimmed
(
íåy
)) {

3013 
˘l
->
disˇrdabÀ_exã¡s
[
BTRFS_STAT_CURR
]++;

3014 
˘l
->
disˇrdabÀ_byãs
[
BTRFS_STAT_CURR
] +=

3015 
íåy
->
byãs
;

3018 
	`åì_ö£π_off£t
(
˘l
, 
NULL
, 
íåy
);

3019 
	`rb_add_ˇched
(&
íåy
->
byãs_ödex
, &
˘l
->
‰ì_•a˚_byãs
,

3020 
íåy_Àss
);

3022 
˛u°î
->
roŸ
 = 
RB_ROOT
;

3023 
	`•ö_u∆ock
(&
˛u°î
->
lock
);

3024 
	`båfs_put_block_group
(
block_group
);

3025 
	}
}

3027 
	$båfs_ªmove_‰ì_•a˚_ˇche
(
båfs_block_group
 *
block_group
)

3029 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

3030 
båfs_‰ì_˛u°î
 *
˛u°î
;

3031 
li°_hód
 *
hód
;

3033 
	`•ö_lock
(&
˘l
->
åì_lock
);

3034 (
hód
 = 
block_group
->
˛u°î_li°
.
√xt
) !=

3035 &
block_group
->
˛u°î_li°
) {

3036 
˛u°î
 = 
	`li°_íåy
(
hód
, 
båfs_‰ì_˛u°î
,

3037 
block_group_li°
);

3039 
	`WARN_ON
(
˛u°î
->
block_group
 != block_group);

3040 
	`__båfs_ªtu∫_˛u°î_to_‰ì_•a˚
(
block_group
, 
˛u°î
);

3042 
	`c⁄d_ªsched_lock
(&
˘l
->
åì_lock
);

3044 
	`__båfs_ªmove_‰ì_•a˚_ˇche
(
˘l
);

3045 
	`båfs_disˇrd_upd©e_disˇrdabÀ
(
block_group
);

3046 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3048 
	}
}

3053 
boﬁ
 
	$båfs_is_‰ì_•a˚_åimmed
(
båfs_block_group
 *
block_group
)

3055 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

3056 
båfs_‰ì_•a˚
 *
öfo
;

3057 
rb_node
 *
node
;

3058 
boﬁ
 
ªt
 = 
åue
;

3060 
	`•ö_lock
(&
˘l
->
åì_lock
);

3061 
node
 = 
	`rb_fú°
(&
˘l
->
‰ì_•a˚_off£t
);

3063 
node
) {

3064 
öfo
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
, 
off£t_ödex
);

3066 i‡(!
	`båfs_‰ì_•a˚_åimmed
(
öfo
)) {

3067 
ªt
 = 
Ál£
;

3071 
node
 = 
	`rb_√xt
(node);

3074 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3075  
ªt
;

3076 
	}
}

3078 
u64
 
	$båfs_föd_•a˚_f‹_Æloc
(
båfs_block_group
 *
block_group
,

3079 
u64
 
off£t
, u64 
byãs
, u64 
em±y_size
,

3080 
u64
 *
max_exã¡_size
)

3082 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

3083 
båfs_disˇrd_˘l
 *
disˇrd_˘l
 =

3084 &
block_group
->
fs_öfo
->
disˇrd_˘l
;

3085 
båfs_‰ì_•a˚
 *
íåy
 = 
NULL
;

3086 
u64
 
byãs_£¨ch
 = 
byãs
 + 
em±y_size
;

3087 
u64
 
ªt
 = 0;

3088 
u64
 
Æign_g≠
 = 0;

3089 
u64
 
Æign_g≠_Àn
 = 0;

3090 
båfs_åim_°©e
 
Æign_g≠_åim_°©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

3091 
boﬁ
 
u£_byãs_ödex
 = (
off£t
 =
block_group
->
°¨t
);

3093 
	`ASSERT
(!
	`båfs_is_z⁄ed
(
block_group
->
fs_öfo
));

3095 
	`•ö_lock
(&
˘l
->
åì_lock
);

3096 
íåy
 = 
	`föd_‰ì_•a˚
(
˘l
, &
off£t
, &
byãs_£¨ch
,

3097 
block_group
->
fuŒ_°rùe_Àn
, 
max_exã¡_size
,

3098 
u£_byãs_ödex
);

3099 i‡(!
íåy
)

3100 
out
;

3102 
ªt
 = 
off£t
;

3103 i‡(
íåy
->
bôm≠
) {

3104 
	`bôm≠_˛ór_bôs
(
˘l
, 
íåy
, 
off£t
, 
byãs
, 
åue
);

3106 i‡(!
	`båfs_‰ì_•a˚_åimmed
(
íåy
))

3107 
	`©omic64_add
(
byãs
, &
disˇrd_˘l
->
disˇrd_byãs_ßved
);

3109 i‡(!
íåy
->
byãs
)

3110 
	`‰ì_bôm≠
(
˘l
, 
íåy
);

3112 
	`u∆ök_‰ì_•a˚
(
˘l
, 
íåy
, 
åue
);

3113 
Æign_g≠_Àn
 = 
off£t
 - 
íåy
->offset;

3114 
Æign_g≠
 = 
íåy
->
off£t
;

3115 
Æign_g≠_åim_°©e
 = 
íåy
->
åim_°©e
;

3117 i‡(!
	`båfs_‰ì_•a˚_åimmed
(
íåy
))

3118 
	`©omic64_add
(
byãs
, &
disˇrd_˘l
->
disˇrd_byãs_ßved
);

3120 
íåy
->
off£t
 = off£à+ 
byãs
;

3121 
	`WARN_ON
(
íåy
->
byãs
 < byã†+ 
Æign_g≠_Àn
);

3123 
íåy
->
byãs
 -byã†+ 
Æign_g≠_Àn
;

3124 i‡(!
íåy
->
byãs
)

3125 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
íåy
);

3127 
	`lök_‰ì_•a˚
(
˘l
, 
íåy
);

3129 
out
:

3130 
	`båfs_disˇrd_upd©e_disˇrdabÀ
(
block_group
);

3131 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3133 i‡(
Æign_g≠_Àn
)

3134 
	`__båfs_add_‰ì_•a˚
(
block_group
, 
Æign_g≠
, 
Æign_g≠_Àn
,

3135 
Æign_g≠_åim_°©e
);

3136  
ªt
;

3137 
	}
}

3147 
	$båfs_ªtu∫_˛u°î_to_‰ì_•a˚
(

3148 
båfs_block_group
 *
block_group
,

3149 
båfs_‰ì_˛u°î
 *
˛u°î
)

3151 
båfs_‰ì_•a˚_˘l
 *
˘l
;

3154 
	`•ö_lock
(&
˛u°î
->
lock
);

3155 i‡(!
block_group
) {

3156 
block_group
 = 
˛u°î
->block_group;

3157 i‡(!
block_group
) {

3158 
	`•ö_u∆ock
(&
˛u°î
->
lock
);

3161 } i‡(
˛u°î
->
block_group
 != block_group) {

3163 
	`•ö_u∆ock
(&
˛u°î
->
lock
);

3166 
	`båfs_gë_block_group
(
block_group
);

3167 
	`•ö_u∆ock
(&
˛u°î
->
lock
);

3169 
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

3172 
	`•ö_lock
(&
˘l
->
åì_lock
);

3173 
	`__båfs_ªtu∫_˛u°î_to_‰ì_•a˚
(
block_group
, 
˛u°î
);

3174 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3176 
	`båfs_disˇrd_queue_w‹k
(&
block_group
->
fs_öfo
->
disˇrd_˘l
, block_group);

3179 
	`båfs_put_block_group
(
block_group
);

3180 
	}
}

3182 
u64
 
	$båfs_Æloc_‰om_bôm≠
(
båfs_block_group
 *
block_group
,

3183 
båfs_‰ì_˛u°î
 *
˛u°î
,

3184 
båfs_‰ì_•a˚
 *
íåy
,

3185 
u64
 
byãs
, u64 
mö_°¨t
,

3186 
u64
 *
max_exã¡_size
)

3188 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

3189 
îr
;

3190 
u64
 
£¨ch_°¨t
 = 
˛u°î
->
wödow_°¨t
;

3191 
u64
 
£¨ch_byãs
 = 
byãs
;

3192 
u64
 
ªt
 = 0;

3194 
£¨ch_°¨t
 = 
mö_°¨t
;

3195 
£¨ch_byãs
 = 
byãs
;

3197 
îr
 = 
	`£¨ch_bôm≠
(
˘l
, 
íåy
, &
£¨ch_°¨t
, &
£¨ch_byãs
, 
åue
);

3198 i‡(
îr
) {

3199 *
max_exã¡_size
 = 
	`max
(
	`gë_max_exã¡_size
(
íåy
),

3200 *
max_exã¡_size
);

3204 
ªt
 = 
£¨ch_°¨t
;

3205 
	`bôm≠_˛ór_bôs
(
˘l
, 
íåy
, 
ªt
, 
byãs
, 
Ál£
);

3207  
ªt
;

3208 
	}
}

3215 
u64
 
	$båfs_Æloc_‰om_˛u°î
(
båfs_block_group
 *
block_group
,

3216 
båfs_‰ì_˛u°î
 *
˛u°î
, 
u64
 
byãs
,

3217 
u64
 
mö_°¨t
, u64 *
max_exã¡_size
)

3219 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

3220 
båfs_disˇrd_˘l
 *
disˇrd_˘l
 =

3221 &
block_group
->
fs_öfo
->
disˇrd_˘l
;

3222 
båfs_‰ì_•a˚
 *
íåy
 = 
NULL
;

3223 
rb_node
 *
node
;

3224 
u64
 
ªt
 = 0;

3226 
	`ASSERT
(!
	`båfs_is_z⁄ed
(
block_group
->
fs_öfo
));

3228 
	`•ö_lock
(&
˛u°î
->
lock
);

3229 i‡(
byãs
 > 
˛u°î
->
max_size
)

3230 
out
;

3232 i‡(
˛u°î
->
block_group
 != block_group)

3233 
out
;

3235 
node
 = 
	`rb_fú°
(&
˛u°î
->
roŸ
);

3236 i‡(!
node
)

3237 
out
;

3239 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
, 
off£t_ödex
);

3241 i‡(
íåy
->
byãs
 < bytes)

3242 *
max_exã¡_size
 = 
	`max
(
	`gë_max_exã¡_size
(
íåy
),

3243 *
max_exã¡_size
);

3245 i‡(
íåy
->
byãs
 < bytes ||

3246 (!
íåy
->
bôm≠
 &&É¡ry->
off£t
 < 
mö_°¨t
)) {

3247 
node
 = 
	`rb_√xt
(&
íåy
->
off£t_ödex
);

3248 i‡(!
node
)

3250 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
,

3251 
off£t_ödex
);

3255 i‡(
íåy
->
bôm≠
) {

3256 
ªt
 = 
	`båfs_Æloc_‰om_bôm≠
(
block_group
,

3257 
˛u°î
, 
íåy
, 
byãs
,

3258 
˛u°î
->
wödow_°¨t
,

3259 
max_exã¡_size
);

3260 i‡(
ªt
 == 0) {

3261 
node
 = 
	`rb_√xt
(&
íåy
->
off£t_ödex
);

3262 i‡(!
node
)

3264 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
,

3265 
off£t_ödex
);

3268 
˛u°î
->
wödow_°¨t
 +
byãs
;

3270 
ªt
 = 
íåy
->
off£t
;

3272 
íåy
->
off£t
 +
byãs
;

3273 
íåy
->
byãs
 -= bytes;

3278 
out
:

3279 
	`•ö_u∆ock
(&
˛u°î
->
lock
);

3281 i‡(!
ªt
)

3284 
	`•ö_lock
(&
˘l
->
åì_lock
);

3286 i‡(!
	`båfs_‰ì_•a˚_åimmed
(
íåy
))

3287 
	`©omic64_add
(
byãs
, &
disˇrd_˘l
->
disˇrd_byãs_ßved
);

3289 
˘l
->
‰ì_•a˚
 -
byãs
;

3290 i‡(!
íåy
->
bôm≠
 && !
	`båfs_‰ì_•a˚_åimmed
(entry))

3291 
˘l
->
disˇrdabÀ_byãs
[
BTRFS_STAT_CURR
] -
byãs
;

3293 
	`•ö_lock
(&
˛u°î
->
lock
);

3294 i‡(
íåy
->
byãs
 == 0) {

3295 
	`rb_îa£
(&
íåy
->
off£t_ödex
, &
˛u°î
->
roŸ
);

3296 
˘l
->
‰ì_exã¡s
--;

3297 i‡(
íåy
->
bôm≠
) {

3298 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_bôm≠_ˇchï
,

3299 
íåy
->
bôm≠
);

3300 
˘l
->
tŸÆ_bôm≠s
--;

3301 
	`ªˇlcuœã_thªshﬁds
(
˘l
);

3302 } i‡(!
	`båfs_‰ì_•a˚_åimmed
(
íåy
)) {

3303 
˘l
->
disˇrdabÀ_exã¡s
[
BTRFS_STAT_CURR
]--;

3305 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
íåy
);

3308 
	`•ö_u∆ock
(&
˛u°î
->
lock
);

3309 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3311  
ªt
;

3312 
	}
}

3314 
	$båfs_bôm≠_˛u°î
(
båfs_block_group
 *
block_group
,

3315 
båfs_‰ì_•a˚
 *
íåy
,

3316 
båfs_‰ì_˛u°î
 *
˛u°î
,

3317 
u64
 
off£t
, u64 
byãs
,

3318 
u64
 
c⁄t1_byãs
, u64 
mö_byãs
)

3320 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

3321 
√xt_zîo
;

3322 
i
;

3323 
w™t_bôs
;

3324 
mö_bôs
;

3325 
found_bôs
;

3326 
max_bôs
 = 0;

3327 
°¨t
 = 0;

3328 
tŸÆ_found
 = 0;

3329 
ªt
;

3331 
	`lockdï_as£π_hñd
(&
˘l
->
åì_lock
);

3333 
i
 = 
	`off£t_to_bô
(
íåy
->
off£t
, 
˘l
->
unô
,

3334 
	`max_t
(
u64
, 
off£t
, 
íåy
->offset));

3335 
w™t_bôs
 = 
	`byãs_to_bôs
(
byãs
, 
˘l
->
unô
);

3336 
mö_bôs
 = 
	`byãs_to_bôs
(
mö_byãs
, 
˘l
->
unô
);

3342 i‡(
íåy
->
max_exã¡_size
 &&

3343 
íåy
->
max_exã¡_size
 < 
c⁄t1_byãs
)

3344  -
ENOSPC
;

3345 
agaö
:

3346 
found_bôs
 = 0;

3347 
	`f‹_óch_£t_bô_‰om
(
i
, 
íåy
->
bôm≠
, 
BITS_PER_BITMAP
) {

3348 
√xt_zîo
 = 
	`föd_√xt_zîo_bô
(
íåy
->
bôm≠
,

3349 
BITS_PER_BITMAP
, 
i
);

3350 i‡(
√xt_zîo
 - 
i
 >
mö_bôs
) {

3351 
found_bôs
 = 
√xt_zîo
 - 
i
;

3352 i‡(
found_bôs
 > 
max_bôs
)

3353 
max_bôs
 = 
found_bôs
;

3356 i‡(
√xt_zîo
 - 
i
 > 
max_bôs
)

3357 
max_bôs
 = 
√xt_zîo
 - 
i
;

3358 
i
 = 
√xt_zîo
;

3361 i‡(!
found_bôs
) {

3362 
íåy
->
max_exã¡_size
 = (
u64
)
max_bôs
 * 
˘l
->
unô
;

3363  -
ENOSPC
;

3366 i‡(!
tŸÆ_found
) {

3367 
°¨t
 = 
i
;

3368 
˛u°î
->
max_size
 = 0;

3371 
tŸÆ_found
 +
found_bôs
;

3373 i‡(
˛u°î
->
max_size
 < 
found_bôs
 * 
˘l
->
unô
)

3374 
˛u°î
->
max_size
 = 
found_bôs
 * 
˘l
->
unô
;

3376 i‡(
tŸÆ_found
 < 
w™t_bôs
 || 
˛u°î
->
max_size
 < 
c⁄t1_byãs
) {

3377 
i
 = 
√xt_zîo
 + 1;

3378 
agaö
;

3381 
˛u°î
->
wödow_°¨t
 = 
°¨t
 * 
˘l
->
unô
 + 
íåy
->
off£t
;

3382 
	`rb_îa£
(&
íåy
->
off£t_ödex
, &
˘l
->
‰ì_•a˚_off£t
);

3383 
	`rb_îa£_ˇched
(&
íåy
->
byãs_ödex
, &
˘l
->
‰ì_•a˚_byãs
);

3392 
	`RB_CLEAR_NODE
(&
íåy
->
byãs_ödex
);

3394 
ªt
 = 
	`åì_ö£π_off£t
(
˘l
, 
˛u°î
, 
íåy
);

3395 
	`ASSERT
(!
ªt
);

3397 
	`åa˚_båfs_£tup_˛u°î
(
block_group
, 
˛u°î
,

3398 
tŸÆ_found
 * 
˘l
->
unô
, 1);

3400 
	}
}

3407 
noölöe
 

3408 
	$£tup_˛u°î_no_bôm≠
(
båfs_block_group
 *
block_group
,

3409 
båfs_‰ì_˛u°î
 *
˛u°î
,

3410 
li°_hód
 *
bôm≠s
, 
u64
 
off£t
, u64 
byãs
,

3411 
u64
 
c⁄t1_byãs
, u64 
mö_byãs
)

3413 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

3414 
båfs_‰ì_•a˚
 *
fú°
 = 
NULL
;

3415 
båfs_‰ì_•a˚
 *
íåy
 = 
NULL
;

3416 
båfs_‰ì_•a˚
 *
œ°
;

3417 
rb_node
 *
node
;

3418 
u64
 
wödow_‰ì
;

3419 
u64
 
max_exã¡
;

3420 
u64
 
tŸÆ_size
 = 0;

3422 
	`lockdï_as£π_hñd
(&
˘l
->
åì_lock
);

3424 
íåy
 = 
	`åì_£¨ch_off£t
(
˘l
, 
off£t
, 0, 1);

3425 i‡(!
íåy
)

3426  -
ENOSPC
;

3432 
íåy
->
bôm≠
 ||É¡ry->
byãs
 < 
mö_byãs
) {

3433 i‡(
íåy
->
bôm≠
 && 
	`li°_em±y
(&íåy->
li°
))

3434 
	`li°_add_èû
(&
íåy
->
li°
, 
bôm≠s
);

3435 
node
 = 
	`rb_√xt
(&
íåy
->
off£t_ödex
);

3436 i‡(!
node
)

3437  -
ENOSPC
;

3438 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
, 
off£t_ödex
);

3441 
wödow_‰ì
 = 
íåy
->
byãs
;

3442 
max_exã¡
 = 
íåy
->
byãs
;

3443 
fú°
 = 
íåy
;

3444 
œ°
 = 
íåy
;

3446 
node
 = 
	`rb_√xt
(&
íåy
->
off£t_ödex
);Çode;

3447 
node
 = 
	`rb_√xt
(&
íåy
->
off£t_ödex
)) {

3448 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
, 
off£t_ödex
);

3450 i‡(
íåy
->
bôm≠
) {

3451 i‡(
	`li°_em±y
(&
íåy
->
li°
))

3452 
	`li°_add_èû
(&
íåy
->
li°
, 
bôm≠s
);

3456 i‡(
íåy
->
byãs
 < 
mö_byãs
)

3459 
œ°
 = 
íåy
;

3460 
wödow_‰ì
 +
íåy
->
byãs
;

3461 i‡(
íåy
->
byãs
 > 
max_exã¡
)

3462 
max_exã¡
 = 
íåy
->
byãs
;

3465 i‡(
wödow_‰ì
 < 
byãs
 || 
max_exã¡
 < 
c⁄t1_byãs
)

3466  -
ENOSPC
;

3468 
˛u°î
->
wödow_°¨t
 = 
fú°
->
off£t
;

3470 
node
 = &
fú°
->
off£t_ödex
;

3477 
ªt
;

3479 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
, 
off£t_ödex
);

3480 
node
 = 
	`rb_√xt
(&
íåy
->
off£t_ödex
);

3481 i‡(
íåy
->
bôm≠
 ||É¡ry->
byãs
 < 
mö_byãs
)

3484 
	`rb_îa£
(&
íåy
->
off£t_ödex
, &
˘l
->
‰ì_•a˚_off£t
);

3485 
	`rb_îa£_ˇched
(&
íåy
->
byãs_ödex
, &
˘l
->
‰ì_•a˚_byãs
);

3486 
ªt
 = 
	`åì_ö£π_off£t
(
˘l
, 
˛u°î
, 
íåy
);

3487 
tŸÆ_size
 +
íåy
->
byãs
;

3488 
	`ASSERT
(!
ªt
);

3489 } 
node
 && 
íåy
 !
œ°
);

3491 
˛u°î
->
max_size
 = 
max_exã¡
;

3492 
	`åa˚_båfs_£tup_˛u°î
(
block_group
, 
˛u°î
, 
tŸÆ_size
, 0);

3494 
	}
}

3500 
noölöe
 

3501 
	$£tup_˛u°î_bôm≠
(
båfs_block_group
 *
block_group
,

3502 
båfs_‰ì_˛u°î
 *
˛u°î
,

3503 
li°_hód
 *
bôm≠s
, 
u64
 
off£t
, u64 
byãs
,

3504 
u64
 
c⁄t1_byãs
, u64 
mö_byãs
)

3506 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

3507 
båfs_‰ì_•a˚
 *
íåy
 = 
NULL
;

3508 
ªt
 = -
ENOSPC
;

3509 
u64
 
bôm≠_off£t
 = 
	`off£t_to_bôm≠
(
˘l
, 
off£t
);

3511 i‡(
˘l
->
tŸÆ_bôm≠s
 == 0)

3512  -
ENOSPC
;

3518 i‡(!
	`li°_em±y
(
bôm≠s
))

3519 
íåy
 = 
	`li°_fú°_íåy
(
bôm≠s
, 
båfs_‰ì_•a˚
, 
li°
);

3521 i‡(!
íåy
 ||É¡ry->
off£t
 !
bôm≠_off£t
) {

3522 
íåy
 = 
	`åì_£¨ch_off£t
(
˘l
, 
bôm≠_off£t
, 1, 0);

3523 i‡(
íåy
 && 
	`li°_em±y
(&íåy->
li°
))

3524 
	`li°_add
(&
íåy
->
li°
, 
bôm≠s
);

3527 
	`li°_f‹_óch_íåy
(
íåy
, 
bôm≠s
, 
li°
) {

3528 i‡(
íåy
->
byãs
 < bytes)

3530 
ªt
 = 
	`båfs_bôm≠_˛u°î
(
block_group
, 
íåy
, 
˛u°î
, 
off£t
,

3531 
byãs
, 
c⁄t1_byãs
, 
mö_byãs
);

3532 i‡(!
ªt
)

3540  -
ENOSPC
;

3541 
	}
}

3551 
	$båfs_föd_•a˚_˛u°î
(
båfs_block_group
 *
block_group
,

3552 
båfs_‰ì_˛u°î
 *
˛u°î
,

3553 
u64
 
off£t
, u64 
byãs
, u64 
em±y_size
)

3555 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

3556 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

3557 
båfs_‰ì_•a˚
 *
íåy
, *
tmp
;

3558 
	`LIST_HEAD
(
bôm≠s
);

3559 
u64
 
mö_byãs
;

3560 
u64
 
c⁄t1_byãs
;

3561 
ªt
;

3569 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
SSD_SPREAD
)) {

3570 
c⁄t1_byãs
 = 
byãs
 + 
em±y_size
;

3571 
mö_byãs
 = 
c⁄t1_byãs
;

3572 } i‡(
block_group
->
Êags
 & 
BTRFS_BLOCK_GROUP_METADATA
) {

3573 
c⁄t1_byãs
 = 
byãs
;

3574 
mö_byãs
 = 
fs_öfo
->
£˘‹size
;

3576 
c⁄t1_byãs
 = 
	`max
(
byãs
, (byã†+ 
em±y_size
) >> 2);

3577 
mö_byãs
 = 
fs_öfo
->
£˘‹size
;

3580 
	`•ö_lock
(&
˘l
->
åì_lock
);

3586 i‡(
˘l
->
‰ì_•a˚
 < 
byãs
) {

3587 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3588  -
ENOSPC
;

3591 
	`•ö_lock
(&
˛u°î
->
lock
);

3594 i‡(
˛u°î
->
block_group
) {

3595 
ªt
 = 0;

3596 
out
;

3599 
	`åa˚_båfs_föd_˛u°î
(
block_group
, 
off£t
, 
byãs
, 
em±y_size
,

3600 
mö_byãs
);

3602 
ªt
 = 
	`£tup_˛u°î_no_bôm≠
(
block_group
, 
˛u°î
, &
bôm≠s
, 
off£t
,

3603 
byãs
 + 
em±y_size
,

3604 
c⁄t1_byãs
, 
mö_byãs
);

3605 i‡(
ªt
)

3606 
ªt
 = 
	`£tup_˛u°î_bôm≠
(
block_group
, 
˛u°î
, &
bôm≠s
,

3607 
off£t
, 
byãs
 + 
em±y_size
,

3608 
c⁄t1_byãs
, 
mö_byãs
);

3611 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
tmp
, &
bôm≠s
, 
li°
)

3612 
	`li°_dñ_öô
(&
íåy
->
li°
);

3614 i‡(!
ªt
) {

3615 
	`båfs_gë_block_group
(
block_group
);

3616 
	`li°_add_èû
(&
˛u°î
->
block_group_li°
,

3617 &
block_group
->
˛u°î_li°
);

3618 
˛u°î
->
block_group
 = block_group;

3620 
	`åa˚_båfs_Áûed_˛u°î_£tup
(
block_group
);

3622 
out
:

3623 
	`•ö_u∆ock
(&
˛u°î
->
lock
);

3624 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3626  
ªt
;

3627 
	}
}

3632 
	$båfs_öô_‰ì_˛u°î
(
båfs_‰ì_˛u°î
 *
˛u°î
)

3634 
	`•ö_lock_öô
(&
˛u°î
->
lock
);

3635 
	`•ö_lock_öô
(&
˛u°î
->
ªfûl_lock
);

3636 
˛u°î
->
roŸ
 = 
RB_ROOT
;

3637 
˛u°î
->
max_size
 = 0;

3638 
˛u°î
->
‰agmíãd
 = 
Ál£
;

3639 
	`INIT_LIST_HEAD
(&
˛u°î
->
block_group_li°
);

3640 
˛u°î
->
block_group
 = 
NULL
;

3641 
	}
}

3643 
	$do_åimmög
(
båfs_block_group
 *
block_group
,

3644 
u64
 *
tŸÆ_åimmed
, u64 
°¨t
, u64 
byãs
,

3645 
u64
 
ª£rved_°¨t
, u64 
ª£rved_byãs
,

3646 
båfs_åim_°©e
 
ª£rved_åim_°©e
,

3647 
båfs_åim_ønge
 *
åim_íåy
)

3649 
båfs_•a˚_öfo
 *
•a˚_öfo
 = 
block_group
->space_info;

3650 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

3651 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

3652 
ªt
;

3653 
upd©e
 = 0;

3654 c⁄° 
u64
 
íd
 = 
°¨t
 + 
byãs
;

3655 c⁄° 
u64
 
ª£rved_íd
 = 
ª£rved_°¨t
 + 
ª£rved_byãs
;

3656 
båfs_åim_°©e
 
åim_°©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

3657 
u64
 
åimmed
 = 0;

3659 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

3660 
	`•ö_lock
(&
block_group
->
lock
);

3661 i‡(!
block_group
->
ro
) {

3662 
block_group
->
ª£rved
 +
ª£rved_byãs
;

3663 
•a˚_öfo
->
byãs_ª£rved
 +
ª£rved_byãs
;

3664 
upd©e
 = 1;

3666 
	`•ö_u∆ock
(&
block_group
->
lock
);

3667 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

3669 
ªt
 = 
	`båfs_disˇrd_exã¡
(
fs_öfo
, 
°¨t
, 
byãs
, &
åimmed
);

3670 i‡(!
ªt
) {

3671 *
tŸÆ_åimmed
 +
åimmed
;

3672 
åim_°©e
 = 
BTRFS_TRIM_STATE_TRIMMED
;

3675 
	`muãx_lock
(&
˘l
->
ˇche_wrôeout_muãx
);

3676 i‡(
ª£rved_°¨t
 < 
°¨t
)

3677 
	`__båfs_add_‰ì_•a˚
(
block_group
, 
ª£rved_°¨t
,

3678 
°¨t
 - 
ª£rved_°¨t
,

3679 
ª£rved_åim_°©e
);

3680 i‡(
íd
 < 
ª£rved_íd
)

3681 
	`__båfs_add_‰ì_•a˚
(
block_group
, 
íd
, 
ª£rved_íd
 -Énd,

3682 
ª£rved_åim_°©e
);

3683 
	`__båfs_add_‰ì_•a˚
(
block_group
, 
°¨t
, 
byãs
, 
åim_°©e
);

3684 
	`li°_dñ
(&
åim_íåy
->
li°
);

3685 
	`muãx_u∆ock
(&
˘l
->
ˇche_wrôeout_muãx
);

3687 i‡(
upd©e
) {

3688 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

3689 
	`•ö_lock
(&
block_group
->
lock
);

3690 i‡(
block_group
->
ro
)

3691 
•a˚_öfo
->
byãs_ªad⁄ly
 +
ª£rved_byãs
;

3692 
block_group
->
ª£rved
 -
ª£rved_byãs
;

3693 
•a˚_öfo
->
byãs_ª£rved
 -
ª£rved_byãs
;

3694 
	`•ö_u∆ock
(&
block_group
->
lock
);

3695 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

3698  
ªt
;

3699 
	}
}

3704 
	$åim_no_bôm≠
(
båfs_block_group
 *
block_group
,

3705 
u64
 *
tŸÆ_åimmed
, u64 
°¨t
, u64 
íd
, u64 
möÀn
,

3706 
boﬁ
 
async
)

3708 
båfs_disˇrd_˘l
 *
disˇrd_˘l
 =

3709 &
block_group
->
fs_öfo
->
disˇrd_˘l
;

3710 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

3711 
båfs_‰ì_•a˚
 *
íåy
;

3712 
rb_node
 *
node
;

3713 
ªt
 = 0;

3714 
u64
 
exã¡_°¨t
;

3715 
u64
 
exã¡_byãs
;

3716 
båfs_åim_°©e
 
exã¡_åim_°©e
;

3717 
u64
 
byãs
;

3718 c⁄° 
u64
 
max_disˇrd_size
 = 
	`READ_ONCE
(
disˇrd_˘l
->max_discard_size);

3720 
°¨t
 < 
íd
) {

3721 
båfs_åim_ønge
 
åim_íåy
;

3723 
	`muãx_lock
(&
˘l
->
ˇche_wrôeout_muãx
);

3724 
	`•ö_lock
(&
˘l
->
åì_lock
);

3726 i‡(
˘l
->
‰ì_•a˚
 < 
möÀn
)

3727 
out_u∆ock
;

3729 
íåy
 = 
	`åì_£¨ch_off£t
(
˘l
, 
°¨t
, 0, 1);

3730 i‡(!
íåy
)

3731 
out_u∆ock
;

3734 
íåy
->
bôm≠
 ||

3735 (
async
 && 
	`båfs_‰ì_•a˚_åimmed
(
íåy
))) {

3736 
node
 = 
	`rb_√xt
(&
íåy
->
off£t_ödex
);

3737 i‡(!
node
)

3738 
out_u∆ock
;

3739 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
,

3740 
off£t_ödex
);

3743 i‡(
íåy
->
off£t
 >
íd
)

3744 
out_u∆ock
;

3746 
exã¡_°¨t
 = 
íåy
->
off£t
;

3747 
exã¡_byãs
 = 
íåy
->
byãs
;

3748 
exã¡_åim_°©e
 = 
íåy
->
åim_°©e
;

3749 i‡(
async
) {

3750 
°¨t
 = 
íåy
->
off£t
;

3751 
byãs
 = 
íåy
->bytes;

3752 i‡(
byãs
 < 
möÀn
) {

3753 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3754 
	`muãx_u∆ock
(&
˘l
->
ˇche_wrôeout_muãx
);

3755 
√xt
;

3757 
	`u∆ök_‰ì_•a˚
(
˘l
, 
íåy
, 
åue
);

3763 i‡(
max_disˇrd_size
 &&

3764 
byãs
 >(
max_disˇrd_size
 +

3765 
BTRFS_ASYNC_DISCARD_MIN_FILTER
)) {

3766 
byãs
 = 
max_disˇrd_size
;

3767 
exã¡_byãs
 = 
max_disˇrd_size
;

3768 
íåy
->
off£t
 +
max_disˇrd_size
;

3769 
íåy
->
byãs
 -
max_disˇrd_size
;

3770 
	`lök_‰ì_•a˚
(
˘l
, 
íåy
);

3772 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
íåy
);

3775 
°¨t
 = 
	`max
(°¨t, 
exã¡_°¨t
);

3776 
byãs
 = 
	`mö
(
exã¡_°¨t
 + 
exã¡_byãs
, 
íd
Ë- 
°¨t
;

3777 i‡(
byãs
 < 
möÀn
) {

3778 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3779 
	`muãx_u∆ock
(&
˘l
->
ˇche_wrôeout_muãx
);

3780 
√xt
;

3783 
	`u∆ök_‰ì_•a˚
(
˘l
, 
íåy
, 
åue
);

3784 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
íåy
);

3787 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3788 
åim_íåy
.
°¨t
 = 
exã¡_°¨t
;

3789 
åim_íåy
.
byãs
 = 
exã¡_byãs
;

3790 
	`li°_add_èû
(&
åim_íåy
.
li°
, &
˘l
->
åimmög_ønges
);

3791 
	`muãx_u∆ock
(&
˘l
->
ˇche_wrôeout_muãx
);

3793 
ªt
 = 
	`do_åimmög
(
block_group
, 
tŸÆ_åimmed
, 
°¨t
, 
byãs
,

3794 
exã¡_°¨t
, 
exã¡_byãs
, 
exã¡_åim_°©e
,

3795 &
åim_íåy
);

3796 i‡(
ªt
) {

3797 
block_group
->
disˇrd_curs‹
 = 
°¨t
 + 
byãs
;

3800 
√xt
:

3801 
°¨t
 +
byãs
;

3802 
block_group
->
disˇrd_curs‹
 = 
°¨t
;

3803 i‡(
async
 && *
tŸÆ_åimmed
)

3806 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

3807 
ªt
 = -
ERESTARTSYS
;

3811 
	`c⁄d_ªsched
();

3814  
ªt
;

3816 
out_u∆ock
:

3817 
block_group
->
disˇrd_curs‹
 = 
	`båfs_block_group_íd
(block_group);

3818 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3819 
	`muãx_u∆ock
(&
˘l
->
ˇche_wrôeout_muãx
);

3821  
ªt
;

3822 
	}
}

3838 
	$ª£t_åimmög_bôm≠
(
båfs_‰ì_•a˚_˘l
 *
˘l
, 
u64
 
off£t
)

3840 
båfs_‰ì_•a˚
 *
íåy
;

3842 
	`•ö_lock
(&
˘l
->
åì_lock
);

3843 
íåy
 = 
	`åì_£¨ch_off£t
(
˘l
, 
off£t
, 1, 0);

3844 i‡(
íåy
) {

3845 i‡(
	`båfs_‰ì_•a˚_åimmed
(
íåy
)) {

3846 
˘l
->
disˇrdabÀ_exã¡s
[
BTRFS_STAT_CURR
] +=

3847 
íåy
->
bôm≠_exã¡s
;

3848 
˘l
->
disˇrdabÀ_byãs
[
BTRFS_STAT_CURR
] +
íåy
->
byãs
;

3850 
íåy
->
åim_°©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

3853 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3854 
	}
}

3856 
	$íd_åimmög_bôm≠
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

3857 
båfs_‰ì_•a˚
 *
íåy
)

3859 i‡(
	`båfs_‰ì_•a˚_åimmög_bôm≠
(
íåy
)) {

3860 
íåy
->
åim_°©e
 = 
BTRFS_TRIM_STATE_TRIMMED
;

3861 
˘l
->
disˇrdabÀ_exã¡s
[
BTRFS_STAT_CURR
] -=

3862 
íåy
->
bôm≠_exã¡s
;

3863 
˘l
->
disˇrdabÀ_byãs
[
BTRFS_STAT_CURR
] -
íåy
->
byãs
;

3865 
	}
}

3870 
	$åim_bôm≠s
(
båfs_block_group
 *
block_group
,

3871 
u64
 *
tŸÆ_åimmed
, u64 
°¨t
, u64 
íd
, u64 
möÀn
,

3872 
u64
 
maxÀn
, 
boﬁ
 
async
)

3874 
båfs_disˇrd_˘l
 *
disˇrd_˘l
 =

3875 &
block_group
->
fs_öfo
->
disˇrd_˘l
;

3876 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

3877 
båfs_‰ì_•a˚
 *
íåy
;

3878 
ªt
 = 0;

3879 
ªt2
;

3880 
u64
 
byãs
;

3881 
u64
 
off£t
 = 
	`off£t_to_bôm≠
(
˘l
, 
°¨t
);

3882 c⁄° 
u64
 
max_disˇrd_size
 = 
	`READ_ONCE
(
disˇrd_˘l
->max_discard_size);

3884 
off£t
 < 
íd
) {

3885 
boﬁ
 
√xt_bôm≠
 = 
Ál£
;

3886 
båfs_åim_ønge
 
åim_íåy
;

3888 
	`muãx_lock
(&
˘l
->
ˇche_wrôeout_muãx
);

3889 
	`•ö_lock
(&
˘l
->
åì_lock
);

3891 i‡(
˘l
->
‰ì_•a˚
 < 
möÀn
) {

3892 
block_group
->
disˇrd_curs‹
 =

3893 
	`båfs_block_group_íd
(
block_group
);

3894 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3895 
	`muãx_u∆ock
(&
˘l
->
ˇche_wrôeout_muãx
);

3899 
íåy
 = 
	`åì_£¨ch_off£t
(
˘l
, 
off£t
, 1, 0);

3908 i‡(!
íåy
 || (
async
 && 
möÀn
 && 
°¨t
 =
off£t
 &&

3909 
	`båfs_‰ì_•a˚_åimmed
(
íåy
))) {

3910 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3911 
	`muãx_u∆ock
(&
˘l
->
ˇche_wrôeout_muãx
);

3912 
√xt_bôm≠
 = 
åue
;

3913 
√xt
;

3922 i‡(
°¨t
 =
off£t
)

3923 
íåy
->
åim_°©e
 = 
BTRFS_TRIM_STATE_TRIMMING
;

3925 
byãs
 = 
möÀn
;

3926 
ªt2
 = 
	`£¨ch_bôm≠
(
˘l
, 
íåy
, &
°¨t
, &
byãs
, 
Ál£
);

3927 i‡(
ªt2
 || 
°¨t
 >
íd
) {

3932 i‡(
ªt2
 && 
möÀn
 <
BTRFS_ASYNC_DISCARD_MIN_FILTER
)

3933 
	`íd_åimmög_bôm≠
(
˘l
, 
íåy
);

3935 
íåy
->
åim_°©e
 = 
BTRFS_TRIM_STATE_UNTRIMMED
;

3936 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3937 
	`muãx_u∆ock
(&
˘l
->
ˇche_wrôeout_muãx
);

3938 
√xt_bôm≠
 = 
åue
;

3939 
√xt
;

3946 i‡(
async
 && *
tŸÆ_åimmed
) {

3947 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3948 
	`muãx_u∆ock
(&
˘l
->
ˇche_wrôeout_muãx
);

3949 
out
;

3952 
byãs
 = 
	`mö
(byãs, 
íd
 - 
°¨t
);

3953 i‡(
byãs
 < 
möÀn
 || (
async
 && 
maxÀn
 && bytes > maxlen)) {

3954 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3955 
	`muãx_u∆ock
(&
˘l
->
ˇche_wrôeout_muãx
);

3956 
√xt
;

3965 i‡(
async
 &&

3966 
max_disˇrd_size
 &&

3967 
byãs
 > (
max_disˇrd_size
 + 
möÀn
))

3968 
byãs
 = 
max_disˇrd_size
;

3970 
	`bôm≠_˛ór_bôs
(
˘l
, 
íåy
, 
°¨t
, 
byãs
, 
åue
);

3971 i‡(
íåy
->
byãs
 == 0)

3972 
	`‰ì_bôm≠
(
˘l
, 
íåy
);

3974 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

3975 
åim_íåy
.
°¨t
 = start;

3976 
åim_íåy
.
byãs
 = bytes;

3977 
	`li°_add_èû
(&
åim_íåy
.
li°
, &
˘l
->
åimmög_ønges
);

3978 
	`muãx_u∆ock
(&
˘l
->
ˇche_wrôeout_muãx
);

3980 
ªt
 = 
	`do_åimmög
(
block_group
, 
tŸÆ_åimmed
, 
°¨t
, 
byãs
,

3981 
°¨t
, 
byãs
, 0, &
åim_íåy
);

3982 i‡(
ªt
) {

3983 
	`ª£t_åimmög_bôm≠
(
˘l
, 
off£t
);

3984 
block_group
->
disˇrd_curs‹
 =

3985 
	`båfs_block_group_íd
(
block_group
);

3988 
√xt
:

3989 i‡(
√xt_bôm≠
) {

3990 
off£t
 +
BITS_PER_BITMAP
 * 
˘l
->
unô
;

3991 
°¨t
 = 
off£t
;

3993 
°¨t
 +
byãs
;

3995 
block_group
->
disˇrd_curs‹
 = 
°¨t
;

3997 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

3998 i‡(
°¨t
 !
off£t
)

3999 
	`ª£t_åimmög_bôm≠
(
˘l
, 
off£t
);

4000 
ªt
 = -
ERESTARTSYS
;

4004 
	`c⁄d_ªsched
();

4007 i‡(
off£t
 >
íd
)

4008 
block_group
->
disˇrd_curs‹
 = 
íd
;

4010 
out
:

4011  
ªt
;

4012 
	}
}

4014 
	$båfs_åim_block_group
(
båfs_block_group
 *
block_group
,

4015 
u64
 *
åimmed
, u64 
°¨t
, u64 
íd
, u64 
möÀn
)

4017 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
block_group
->
‰ì_•a˚_˘l
;

4018 
ªt
;

4019 
u64
 
ªm
 = 0;

4021 
	`ASSERT
(!
	`båfs_is_z⁄ed
(
block_group
->
fs_öfo
));

4023 *
åimmed
 = 0;

4025 
	`•ö_lock
(&
block_group
->
lock
);

4026 i‡(
	`ã°_bô
(
BLOCK_GROUP_FLAG_REMOVED
, &
block_group
->
ru¡ime_Êags
)) {

4027 
	`•ö_u∆ock
(&
block_group
->
lock
);

4030 
	`båfs_‰ìze_block_group
(
block_group
);

4031 
	`•ö_u∆ock
(&
block_group
->
lock
);

4033 
ªt
 = 
	`åim_no_bôm≠
(
block_group
, 
åimmed
, 
°¨t
, 
íd
, 
möÀn
, 
Ál£
);

4034 i‡(
ªt
)

4035 
out
;

4037 
ªt
 = 
	`åim_bôm≠s
(
block_group
, 
åimmed
, 
°¨t
, 
íd
, 
möÀn
, 0, 
Ál£
);

4038 
	`div64_u64_ªm
(
íd
, 
BITS_PER_BITMAP
 * 
˘l
->
unô
, &
ªm
);

4040 i‡(
ªm
)

4041 
	`ª£t_åimmög_bôm≠
(
˘l
, 
	`off£t_to_bôm≠
(˘l, 
íd
));

4042 
out
:

4043 
	`båfs_un‰ìze_block_group
(
block_group
);

4044  
ªt
;

4045 
	}
}

4047 
	$båfs_åim_block_group_exã¡s
(
båfs_block_group
 *
block_group
,

4048 
u64
 *
åimmed
, u64 
°¨t
, u64 
íd
, u64 
möÀn
,

4049 
boﬁ
 
async
)

4051 
ªt
;

4053 *
åimmed
 = 0;

4055 
	`•ö_lock
(&
block_group
->
lock
);

4056 i‡(
	`ã°_bô
(
BLOCK_GROUP_FLAG_REMOVED
, &
block_group
->
ru¡ime_Êags
)) {

4057 
	`•ö_u∆ock
(&
block_group
->
lock
);

4060 
	`båfs_‰ìze_block_group
(
block_group
);

4061 
	`•ö_u∆ock
(&
block_group
->
lock
);

4063 
ªt
 = 
	`åim_no_bôm≠
(
block_group
, 
åimmed
, 
°¨t
, 
íd
, 
möÀn
, 
async
);

4064 
	`båfs_un‰ìze_block_group
(
block_group
);

4066  
ªt
;

4067 
	}
}

4069 
	$båfs_åim_block_group_bôm≠s
(
båfs_block_group
 *
block_group
,

4070 
u64
 *
åimmed
, u64 
°¨t
, u64 
íd
, u64 
möÀn
,

4071 
u64
 
maxÀn
, 
boﬁ
 
async
)

4073 
ªt
;

4075 *
åimmed
 = 0;

4077 
	`•ö_lock
(&
block_group
->
lock
);

4078 i‡(
	`ã°_bô
(
BLOCK_GROUP_FLAG_REMOVED
, &
block_group
->
ru¡ime_Êags
)) {

4079 
	`•ö_u∆ock
(&
block_group
->
lock
);

4082 
	`båfs_‰ìze_block_group
(
block_group
);

4083 
	`•ö_u∆ock
(&
block_group
->
lock
);

4085 
ªt
 = 
	`åim_bôm≠s
(
block_group
, 
åimmed
, 
°¨t
, 
íd
, 
möÀn
, 
maxÀn
,

4086 
async
);

4088 
	`båfs_un‰ìze_block_group
(
block_group
);

4090  
ªt
;

4091 
	}
}

4093 
boﬁ
 
	$båfs_‰ì_•a˚_ˇche_v1_a˘ive
(
båfs_fs_öfo
 *
fs_öfo
)

4095  
	`båfs_su≥r_ˇche_gíî©i⁄
(
fs_öfo
->
su≥r_c›y
);

4096 
	}
}

4098 
	$˛ónup_‰ì_•a˚_ˇche_v1
(
båfs_fs_öfo
 *
fs_öfo
,

4099 
båfs_å™s_h™dÀ
 *
å™s
)

4101 
båfs_block_group
 *
block_group
;

4102 
rb_node
 *
node
;

4103 
ªt
 = 0;

4105 
	`båfs_öfo
(
fs_öfo
, "cleaning free space cache v1");

4107 
node
 = 
	`rb_fú°_ˇched
(&
fs_öfo
->
block_group_ˇche_åì
);

4108 
node
) {

4109 
block_group
 = 
	`rb_íåy
(
node
, 
båfs_block_group
, 
ˇche_node
);

4110 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚_öode
(
å™s
, 
NULL
, 
block_group
);

4111 i‡(
ªt
)

4112 
out
;

4113 
node
 = 
	`rb_√xt
(node);

4115 
out
:

4116  
ªt
;

4117 
	}
}

4119 
	$båfs_£t_‰ì_•a˚_ˇche_v1_a˘ive
(
båfs_fs_öfo
 *
fs_öfo
, 
boﬁ
 
a˘ive
)

4121 
båfs_å™s_h™dÀ
 *
å™s
;

4122 
ªt
;

4132 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
fs_öfo
->
åì_roŸ
, 0);

4133 i‡(
	`IS_ERR
(
å™s
))

4134  
	`PTR_ERR
(
å™s
);

4136 i‡(!
a˘ive
) {

4137 
	`£t_bô
(
BTRFS_FS_CLEANUP_SPACE_CACHE_V1
, &
fs_öfo
->
Êags
);

4138 
ªt
 = 
	`˛ónup_‰ì_•a˚_ˇche_v1
(
fs_öfo
, 
å™s
);

4139 i‡(
ªt
) {

4140 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4141 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

4142 
out
;

4146 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

4147 
out
:

4148 
	`˛ór_bô
(
BTRFS_FS_CLEANUP_SPACE_CACHE_V1
, &
fs_öfo
->
Êags
);

4150  
ªt
;

4151 
	}
}

4153 
__öô
 
	$båfs_‰ì_•a˚_öô
()

4155 
båfs_‰ì_•a˚_ˇchï
 = 
	`kmem_ˇche_¸óã
("btrfs_free_space",

4156 (
båfs_‰ì_•a˚
), 0,

4157 
SLAB_MEM_SPREAD
, 
NULL
);

4158 i‡(!
båfs_‰ì_•a˚_ˇchï
)

4159  -
ENOMEM
;

4161 
båfs_‰ì_•a˚_bôm≠_ˇchï
 = 
	`kmem_ˇche_¸óã
("btrfs_free_space_bitmap",

4162 
PAGE_SIZE
, PAGE_SIZE,

4163 
SLAB_MEM_SPREAD
, 
NULL
);

4164 i‡(!
båfs_‰ì_•a˚_bôm≠_ˇchï
) {

4165 
	`kmem_ˇche_de°roy
(
båfs_‰ì_•a˚_ˇchï
);

4166  -
ENOMEM
;

4170 
	}
}

4172 
__cﬁd
 
	$båfs_‰ì_•a˚_exô
()

4174 
	`kmem_ˇche_de°roy
(
båfs_‰ì_•a˚_ˇchï
);

4175 
	`kmem_ˇche_de°roy
(
båfs_‰ì_•a˚_bôm≠_ˇchï
);

4176 
	}
}

4178 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


4185 
	$ã°_add_‰ì_•a˚_íåy
(
båfs_block_group
 *
ˇche
,

4186 
u64
 
off£t
, u64 
byãs
, 
boﬁ
 
bôm≠
)

4188 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
ˇche
->
‰ì_•a˚_˘l
;

4189 
båfs_‰ì_•a˚
 *
öfo
 = 
NULL
, *
bôm≠_öfo
;

4190 *
m≠
 = 
NULL
;

4191 
båfs_åim_°©e
 
åim_°©e
 = 
BTRFS_TRIM_STATE_TRIMMED
;

4192 
u64
 
byãs_added
;

4193 
ªt
;

4195 
agaö
:

4196 i‡(!
öfo
) {

4197 
öfo
 = 
	`kmem_ˇche_zÆloc
(
båfs_‰ì_•a˚_ˇchï
, 
GFP_NOFS
);

4198 i‡(!
öfo
)

4199  -
ENOMEM
;

4202 i‡(!
bôm≠
) {

4203 
	`•ö_lock
(&
˘l
->
åì_lock
);

4204 
öfo
->
off£t
 = offset;

4205 
öfo
->
byãs
 = bytes;

4206 
öfo
->
max_exã¡_size
 = 0;

4207 
ªt
 = 
	`lök_‰ì_•a˚
(
˘l
, 
öfo
);

4208 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

4209 i‡(
ªt
)

4210 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
öfo
);

4211  
ªt
;

4214 i‡(!
m≠
) {

4215 
m≠
 = 
	`kmem_ˇche_zÆloc
(
båfs_‰ì_•a˚_bôm≠_ˇchï
, 
GFP_NOFS
);

4216 i‡(!
m≠
) {

4217 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
öfo
);

4218  -
ENOMEM
;

4222 
	`•ö_lock
(&
˘l
->
åì_lock
);

4223 
bôm≠_öfo
 = 
	`åì_£¨ch_off£t
(
˘l
, 
	`off£t_to_bôm≠
(˘l, 
off£t
),

4225 i‡(!
bôm≠_öfo
) {

4226 
öfo
->
bôm≠
 = 
m≠
;

4227 
m≠
 = 
NULL
;

4228 
	`add_√w_bôm≠
(
˘l
, 
öfo
, 
off£t
);

4229 
bôm≠_öfo
 = 
öfo
;

4230 
öfo
 = 
NULL
;

4233 
byãs_added
 = 
	`add_byãs_to_bôm≠
(
˘l
, 
bôm≠_öfo
, 
off£t
, 
byãs
,

4234 
åim_°©e
);

4236 
byãs
 -
byãs_added
;

4237 
off£t
 +
byãs_added
;

4238 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

4240 i‡(
byãs
)

4241 
agaö
;

4243 i‡(
öfo
)

4244 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_ˇchï
, 
öfo
);

4245 i‡(
m≠
)

4246 
	`kmem_ˇche_‰ì
(
båfs_‰ì_•a˚_bôm≠_ˇchï
, 
m≠
);

4248 
	}
}

4255 
	$ã°_check_exi°s
(
båfs_block_group
 *
ˇche
,

4256 
u64
 
off£t
, u64 
byãs
)

4258 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
ˇche
->
‰ì_•a˚_˘l
;

4259 
båfs_‰ì_•a˚
 *
öfo
;

4260 
ªt
 = 0;

4262 
	`•ö_lock
(&
˘l
->
åì_lock
);

4263 
öfo
 = 
	`åì_£¨ch_off£t
(
˘l
, 
off£t
, 0, 0);

4264 i‡(!
öfo
) {

4265 
öfo
 = 
	`åì_£¨ch_off£t
(
˘l
, 
	`off£t_to_bôm≠
(˘l, 
off£t
),

4267 i‡(!
öfo
)

4268 
out
;

4271 
have_öfo
:

4272 i‡(
öfo
->
bôm≠
) {

4273 
u64
 
bô_off
, 
bô_byãs
;

4274 
rb_node
 *
n
;

4275 
båfs_‰ì_•a˚
 *
tmp
;

4277 
bô_off
 = 
off£t
;

4278 
bô_byãs
 = 
˘l
->
unô
;

4279 
ªt
 = 
	`£¨ch_bôm≠
(
˘l
, 
öfo
, &
bô_off
, &
bô_byãs
, 
Ál£
);

4280 i‡(!
ªt
) {

4281 i‡(
bô_off
 =
off£t
) {

4282 
ªt
 = 1;

4283 
out
;

4284 } i‡(
bô_off
 > 
off£t
 &&

4285 
off£t
 + 
byãs
 > 
bô_off
) {

4286 
ªt
 = 1;

4287 
out
;

4291 
n
 = 
	`rb_¥ev
(&
öfo
->
off£t_ödex
);

4292 
n
) {

4293 
tmp
 = 
	`rb_íåy
(
n
, 
båfs_‰ì_•a˚
,

4294 
off£t_ödex
);

4295 i‡(
tmp
->
off£t
 +Åmp->
byãs
 < offset)

4297 i‡(
off£t
 + 
byãs
 < 
tmp
->offset) {

4298 
n
 = 
	`rb_¥ev
(&
tmp
->
off£t_ödex
);

4301 
öfo
 = 
tmp
;

4302 
have_öfo
;

4305 
n
 = 
	`rb_√xt
(&
öfo
->
off£t_ödex
);

4306 
n
) {

4307 
tmp
 = 
	`rb_íåy
(
n
, 
båfs_‰ì_•a˚
,

4308 
off£t_ödex
);

4309 i‡(
off£t
 + 
byãs
 < 
tmp
->offset)

4311 i‡(
tmp
->
off£t
 +Åmp->
byãs
 < offset) {

4312 
n
 = 
	`rb_√xt
(&
tmp
->
off£t_ödex
);

4315 
öfo
 = 
tmp
;

4316 
have_öfo
;

4319 
ªt
 = 0;

4320 
out
;

4323 i‡(
öfo
->
off£t
 == offset) {

4324 
ªt
 = 1;

4325 
out
;

4328 i‡(
off£t
 > 
öfo
->off£à&& off£à< info->off£à+ info->
byãs
)

4329 
ªt
 = 1;

4330 
out
:

4331 
	`•ö_u∆ock
(&
˘l
->
åì_lock
);

4332  
ªt
;

4333 
	}
}

	@free-space-cache.h

6 #i‚de‡
BTRFS_FREE_SPACE_CACHE_H


7 
	#BTRFS_FREE_SPACE_CACHE_H


	)

17 
	ebåfs_åim_°©e
 {

18 
	mBTRFS_TRIM_STATE_UNTRIMMED
,

19 
	mBTRFS_TRIM_STATE_TRIMMED
,

20 
	mBTRFS_TRIM_STATE_TRIMMING
,

23 
	sbåfs_‰ì_•a˚
 {

24 
rb_node
 
	moff£t_ödex
;

25 
rb_node
 
	mbyãs_ödex
;

26 
u64
 
	moff£t
;

27 
u64
 
	mbyãs
;

28 
u64
 
	mmax_exã¡_size
;

29 *
	mbôm≠
;

30 
li°_hód
 
	mli°
;

31 
båfs_åim_°©e
 
	måim_°©e
;

32 
s32
 
	mbôm≠_exã¡s
;

35 
ölöe
 
boﬁ
 
	$båfs_‰ì_•a˚_åimmed
(
båfs_‰ì_•a˚
 *
öfo
)

37  (
öfo
->
åim_°©e
 =
BTRFS_TRIM_STATE_TRIMMED
);

38 
	}
}

40 
ölöe
 
boﬁ
 
	$båfs_‰ì_•a˚_åimmög_bôm≠
(

41 
båfs_‰ì_•a˚
 *
öfo
)

43  (
öfo
->
åim_°©e
 =
BTRFS_TRIM_STATE_TRIMMING
);

44 
	}
}

52 
	mBTRFS_STAT_CURR
,

53 
	mBTRFS_STAT_PREV
,

54 
	mBTRFS_STAT_NR_ENTRIES
,

57 
	sbåfs_‰ì_•a˚_˘l
 {

58 
•ölock_t
 
	måì_lock
;

59 
rb_roŸ
 
	m‰ì_•a˚_off£t
;

60 
rb_roŸ_ˇched
 
	m‰ì_•a˚_byãs
;

61 
u64
 
	m‰ì_•a˚
;

62 
	mexã¡s_thªsh
;

63 
	m‰ì_exã¡s
;

64 
	mtŸÆ_bôm≠s
;

65 
	munô
;

66 
u64
 
	m°¨t
;

67 
s32
 
	mdisˇrdabÀ_exã¡s
[
BTRFS_STAT_NR_ENTRIES
];

68 
s64
 
	mdisˇrdabÀ_byãs
[
BTRFS_STAT_NR_ENTRIES
];

69 c⁄° 
båfs_‰ì_•a˚_›
 *
	m›
;

70 
båfs_block_group
 *
	mblock_group
;

71 
muãx
 
	mˇche_wrôeout_muãx
;

72 
li°_hód
 
	måimmög_ønges
;

75 
	sbåfs_‰ì_•a˚_›
 {

76 
boﬁ
 (*
u£_bôm≠
)(
båfs_‰ì_•a˚_˘l
 *
	m˘l
,

77 
båfs_‰ì_•a˚
 *
	möfo
);

80 
	sbåfs_io_˘l
 {

81 *
	mcur
, *
	m‹ig
;

82 
∑ge
 *
	m∑ge
;

83 
∑ge
 **
	m∑ges
;

84 
båfs_fs_öfo
 *
	mfs_öfo
;

85 
öode
 *
	möode
;

86 
	msize
;

87 
	mödex
;

88 
	mnum_∑ges
;

89 
	míåõs
;

90 
	mbôm≠s
;

93 
__öô
 
båfs_‰ì_•a˚_öô
();

94 
__cﬁd
 
båfs_‰ì_•a˚_exô
();

95 
öode
 *
lookup_‰ì_•a˚_öode
(
båfs_block_group
 *
block_group
,

96 
båfs_∑th
 *
∑th
);

97 
¸óã_‰ì_•a˚_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

98 
båfs_block_group
 *
block_group
,

99 
båfs_∑th
 *
∑th
);

100 
båfs_ªmove_‰ì_•a˚_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

101 
öode
 *inode,

102 
båfs_block_group
 *
block_group
);

104 
båfs_åunˇã_‰ì_•a˚_ˇche
(
båfs_å™s_h™dÀ
 *
å™s
,

105 
båfs_block_group
 *
block_group
,

106 
öode
 *inode);

107 
lﬂd_‰ì_•a˚_ˇche
(
båfs_block_group
 *
block_group
);

108 
båfs_waô_ˇche_io
(
båfs_å™s_h™dÀ
 *
å™s
,

109 
båfs_block_group
 *
block_group
,

110 
båfs_∑th
 *
∑th
);

111 
båfs_wrôe_out_ˇche
(
båfs_å™s_h™dÀ
 *
å™s
,

112 
båfs_block_group
 *
block_group
,

113 
båfs_∑th
 *
∑th
);

115 
båfs_öô_‰ì_•a˚_˘l
(
båfs_block_group
 *
block_group
,

116 
båfs_‰ì_•a˚_˘l
 *
˘l
);

117 
__båfs_add_‰ì_•a˚
(
båfs_block_group
 *
block_group
, 
u64
 
byãƒ
,

118 
u64
 
size
, 
båfs_åim_°©e
 
åim_°©e
);

119 
båfs_add_‰ì_•a˚
(
båfs_block_group
 *
block_group
,

120 
u64
 
byãƒ
, u64 
size
);

121 
båfs_add_‰ì_•a˚_unu£d
(
båfs_block_group
 *
block_group
,

122 
u64
 
byãƒ
, u64 
size
);

123 
båfs_add_‰ì_•a˚_async_åimmed
(
båfs_block_group
 *
block_group
,

124 
u64
 
byãƒ
, u64 
size
);

125 
båfs_ªmove_‰ì_•a˚
(
båfs_block_group
 *
block_group
,

126 
u64
 
byãƒ
, u64 
size
);

127 
båfs_ªmove_‰ì_•a˚_ˇche
(
båfs_block_group
 *
block_group
);

128 
boﬁ
 
båfs_is_‰ì_•a˚_åimmed
(
båfs_block_group
 *
block_group
);

129 
u64
 
båfs_föd_•a˚_f‹_Æloc
(
båfs_block_group
 *
block_group
,

130 
u64
 
off£t
, u64 
byãs
, u64 
em±y_size
,

131 
u64
 *
max_exã¡_size
);

132 
båfs_dump_‰ì_•a˚
(
båfs_block_group
 *
block_group
,

133 
u64
 
byãs
);

134 
båfs_föd_•a˚_˛u°î
(
båfs_block_group
 *
block_group
,

135 
båfs_‰ì_˛u°î
 *
˛u°î
,

136 
u64
 
off£t
, u64 
byãs
, u64 
em±y_size
);

137 
båfs_öô_‰ì_˛u°î
(
båfs_‰ì_˛u°î
 *
˛u°î
);

138 
u64
 
båfs_Æloc_‰om_˛u°î
(
båfs_block_group
 *
block_group
,

139 
båfs_‰ì_˛u°î
 *
˛u°î
, 
u64
 
byãs
,

140 
u64
 
mö_°¨t
, u64 *
max_exã¡_size
);

141 
båfs_ªtu∫_˛u°î_to_‰ì_•a˚
(

142 
båfs_block_group
 *
block_group
,

143 
båfs_‰ì_˛u°î
 *
˛u°î
);

144 
båfs_åim_block_group
(
båfs_block_group
 *
block_group
,

145 
u64
 *
åimmed
, u64 
°¨t
, u64 
íd
, u64 
möÀn
);

146 
båfs_åim_block_group_exã¡s
(
båfs_block_group
 *
block_group
,

147 
u64
 *
åimmed
, u64 
°¨t
, u64 
íd
, u64 
möÀn
,

148 
boﬁ
 
async
);

149 
båfs_åim_block_group_bôm≠s
(
båfs_block_group
 *
block_group
,

150 
u64
 *
åimmed
, u64 
°¨t
, u64 
íd
, u64 
möÀn
,

151 
u64
 
maxÀn
, 
boﬁ
 
async
);

153 
boﬁ
 
båfs_‰ì_•a˚_ˇche_v1_a˘ive
(
båfs_fs_öfo
 *
fs_öfo
);

154 
båfs_£t_‰ì_•a˚_ˇche_v1_a˘ive
(
båfs_fs_öfo
 *
fs_öfo
, 
boﬁ
 
a˘ive
);

156 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


157 
ã°_add_‰ì_•a˚_íåy
(
båfs_block_group
 *
ˇche
,

158 
u64
 
off£t
, u64 
byãs
, 
boﬁ
 
bôm≠
);

159 
ã°_check_exi°s
(
båfs_block_group
 *
ˇche
, 
u64
 
off£t
, u64 
byãs
);

	@free-space-tree.c

6 
	~<löux/kî√l.h
>

7 
	~<löux/sched/mm.h
>

8 
	~"mesßges.h
"

9 
	~"˘ªe.h
"

10 
	~"disk-io.h
"

11 
	~"lockög.h
"

12 
	~"‰ì-•a˚-åì.h
"

13 
	~"å™ß˘i⁄.h
"

14 
	~"block-group.h
"

15 
	~"fs.h
"

16 
	~"ac˚ss‹s.h
"

17 
	~"exã¡-åì.h
"

18 
	~"roŸ-åì.h
"

20 
__add_block_group_‰ì_•a˚
(
båfs_å™s_h™dÀ
 *
å™s
,

21 
båfs_block_group
 *
block_group
,

22 
båfs_∑th
 *
∑th
);

24 
båfs_roŸ
 *
	$båfs_‰ì_•a˚_roŸ
(

25 
båfs_block_group
 *
block_group
)

27 
båfs_key
 
key
 = {

28 .
obje˘id
 = 
BTRFS_FREE_SPACE_TREE_OBJECTID
,

29 .
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
,

30 .
off£t
 = 0,

33 i‡(
	`båfs_fs_öcom∑t
(
block_group
->
fs_öfo
, 
EXTENT_TREE_V2
))

34 
key
.
off£t
 = 
block_group
->
globÆ_roŸ_id
;

35  
	`båfs_globÆ_roŸ
(
block_group
->
fs_öfo
, &
key
);

36 
	}
}

38 
	$£t_‰ì_•a˚_åì_thªshﬁds
(
båfs_block_group
 *
ˇche
)

40 
u32
 
bôm≠_ønge
;

41 
size_t
 
bôm≠_size
;

42 
u64
 
num_bôm≠s
, 
tŸÆ_bôm≠_size
;

44 i‡(
	`WARN_ON
(
ˇche
->
Àngth
 == 0))

45 
	`båfs_w¨n
(
ˇche
->
fs_öfo
, "block group %lluÜength is zero",

46 
ˇche
->
°¨t
);

52 
bôm≠_ønge
 = 
ˇche
->
fs_öfo
->
£˘‹size
 * 
BTRFS_FREE_SPACE_BITMAP_BITS
;

53 
num_bôm≠s
 = 
	`div_u64
(
ˇche
->
Àngth
 + 
bôm≠_ønge
 - 1, bitmap_range);

54 
bôm≠_size
 = (
båfs_ôem
Ë+ 
BTRFS_FREE_SPACE_BITMAP_SIZE
;

55 
tŸÆ_bôm≠_size
 = 
num_bôm≠s
 * 
bôm≠_size
;

56 
ˇche
->
bôm≠_high_thªsh
 = 
	`div_u64
(
tŸÆ_bôm≠_size
,

57 (
båfs_ôem
));

63 i‡(
ˇche
->
bôm≠_high_thªsh
 > 100)

64 
ˇche
->
bôm≠_low_thªsh
 = cache->
bôm≠_high_thªsh
 - 100;

66 
ˇche
->
bôm≠_low_thªsh
 = 0;

67 
	}
}

69 
	$add_√w_‰ì_•a˚_öfo
(
båfs_å™s_h™dÀ
 *
å™s
,

70 
båfs_block_group
 *
block_group
,

71 
båfs_∑th
 *
∑th
)

73 
båfs_roŸ
 *
roŸ
 = 
	`båfs_‰ì_•a˚_roŸ
(
block_group
);

74 
båfs_‰ì_•a˚_öfo
 *
öfo
;

75 
båfs_key
 
key
;

76 
exã¡_buf„r
 *
Àaf
;

77 
ªt
;

79 
key
.
obje˘id
 = 
block_group
->
°¨t
;

80 
key
.
ty≥
 = 
BTRFS_FREE_SPACE_INFO_KEY
;

81 
key
.
off£t
 = 
block_group
->
Àngth
;

83 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
, (*
öfo
));

84 i‡(
ªt
)

85 
out
;

87 
Àaf
 = 
∑th
->
nodes
[0];

88 
öfo
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

89 
båfs_‰ì_•a˚_öfo
);

90 
	`båfs_£t_‰ì_•a˚_exã¡_cou¡
(
Àaf
, 
öfo
, 0);

91 
	`båfs_£t_‰ì_•a˚_Êags
(
Àaf
, 
öfo
, 0);

92 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

94 
ªt
 = 0;

95 
out
:

96 
	`båfs_ªÀa£_∑th
(
∑th
);

97  
ªt
;

98 
	}
}

100 
EXPORT_FOR_TESTS


101 
båfs_‰ì_•a˚_öfo
 *
	$£¨ch_‰ì_•a˚_öfo
(

102 
båfs_å™s_h™dÀ
 *
å™s
,

103 
båfs_block_group
 *
block_group
,

104 
båfs_∑th
 *
∑th
, 
cow
)

106 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

107 
båfs_roŸ
 *
roŸ
 = 
	`båfs_‰ì_•a˚_roŸ
(
block_group
);

108 
båfs_key
 
key
;

109 
ªt
;

111 
key
.
obje˘id
 = 
block_group
->
°¨t
;

112 
key
.
ty≥
 = 
BTRFS_FREE_SPACE_INFO_KEY
;

113 
key
.
off£t
 = 
block_group
->
Àngth
;

115 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, 0, 
cow
);

116 i‡(
ªt
 < 0)

117  
	`ERR_PTR
(
ªt
);

118 i‡(
ªt
 != 0) {

119 
	`båfs_w¨n
(
fs_öfo
, "missing free space info for %llu",

120 
block_group
->
°¨t
);

121 
	`ASSERT
(0);

122  
	`ERR_PTR
(-
ENOENT
);

125  
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

126 
båfs_‰ì_•a˚_öfo
);

127 
	}
}

133 
	$båfs_£¨ch_¥ev_¶Ÿ
(
båfs_å™s_h™dÀ
 *
å™s
,

134 
båfs_roŸ
 *
roŸ
,

135 
båfs_key
 *
key
, 
båfs_∑th
 *
p
,

136 
ös_Àn
, 
cow
)

138 
ªt
;

140 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, 
key
, 
p
, 
ös_Àn
, 
cow
);

141 i‡(
ªt
 < 0)

142  
ªt
;

144 i‡(
ªt
 == 0) {

145 
	`ASSERT
(0);

146  -
EIO
;

149 i‡(
p
->
¶Ÿs
[0] == 0) {

150 
	`ASSERT
(0);

151  -
EIO
;

153 
p
->
¶Ÿs
[0]--;

156 
	}
}

158 
ölöe
 
u32
 
	$‰ì_•a˚_bôm≠_size
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

159 
u64
 
size
)

161  
	`DIV_ROUND_UP
(
size
 >> 
fs_öfo
->
£˘‹size_bôs
, 
BITS_PER_BYTE
);

162 
	}
}

164 *
	$Æloc_bôm≠
(
u32
 
bôm≠_size
)

166 *
ªt
;

167 
nofs_Êag
;

168 
u32
 
bôm≠_rounded_size
 = 
	`round_up
(
bôm≠_size
, ());

178 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

179 
ªt
 = 
	`kvzÆloc
(
bôm≠_rounded_size
, 
GFP_KERNEL
);

180 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

181  
ªt
;

182 
	}
}

184 
	$À_bôm≠_£t
(*
m≠
, 
°¨t
, 
Àn
)

186 
u8
 *
p
 = ((u8 *)
m≠
Ë+ 
	`BIT_BYTE
(
°¨t
);

187 c⁄° 
size
 = 
°¨t
 + 
Àn
;

188 
bôs_to_£t
 = 
BITS_PER_BYTE
 - (
°¨t
 % BITS_PER_BYTE);

189 
u8
 
mask_to_£t
 = 
	`BITMAP_FIRST_BYTE_MASK
(
°¨t
);

191 
Àn
 - 
bôs_to_£t
 >= 0) {

192 *
p
 |
mask_to_£t
;

193 
Àn
 -
bôs_to_£t
;

194 
bôs_to_£t
 = 
BITS_PER_BYTE
;

195 
mask_to_£t
 = ~0;

196 
p
++;

198 i‡(
Àn
) {

199 
mask_to_£t
 &
	`BITMAP_LAST_BYTE_MASK
(
size
);

200 *
p
 |
mask_to_£t
;

202 
	}
}

204 
EXPORT_FOR_TESTS


205 
	$c⁄vît_‰ì_•a˚_to_bôm≠s
(
båfs_å™s_h™dÀ
 *
å™s
,

206 
båfs_block_group
 *
block_group
,

207 
båfs_∑th
 *
∑th
)

209 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

210 
båfs_roŸ
 *
roŸ
 = 
	`båfs_‰ì_•a˚_roŸ
(
block_group
);

211 
båfs_‰ì_•a˚_öfo
 *
öfo
;

212 
båfs_key
 
key
, 
found_key
;

213 
exã¡_buf„r
 *
Àaf
;

214 *
bôm≠
;

215 *
bôm≠_curs‹
;

216 
u64
 
°¨t
, 
íd
;

217 
u64
 
bôm≠_ønge
, 
i
;

218 
u32
 
bôm≠_size
, 
Êags
, 
ex≥˘ed_exã¡_cou¡
;

219 
u32
 
exã¡_cou¡
 = 0;

220 
d⁄e
 = 0, 
ƒ
;

221 
ªt
;

223 
bôm≠_size
 = 
	`‰ì_•a˚_bôm≠_size
(
fs_öfo
, 
block_group
->
Àngth
);

224 
bôm≠
 = 
	`Æloc_bôm≠
(
bôm≠_size
);

225 i‡(!
bôm≠
) {

226 
ªt
 = -
ENOMEM
;

227 
out
;

230 
°¨t
 = 
block_group
->start;

231 
íd
 = 
block_group
->
°¨t
 + block_group->
Àngth
;

233 
key
.
obje˘id
 = 
íd
 - 1;

234 
key
.
ty≥
 = (
u8
)-1;

235 
key
.
off£t
 = (
u64
)-1;

237 !
d⁄e
) {

238 
ªt
 = 
	`båfs_£¨ch_¥ev_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

239 i‡(
ªt
)

240 
out
;

242 
Àaf
 = 
∑th
->
nodes
[0];

243 
ƒ
 = 0;

244 
∑th
->
¶Ÿs
[0]++;

245 
∑th
->
¶Ÿs
[0] > 0) {

246 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0] - 1);

248 i‡(
found_key
.
ty≥
 =
BTRFS_FREE_SPACE_INFO_KEY
) {

249 
	`ASSERT
(
found_key
.
obje˘id
 =
block_group
->
°¨t
);

250 
	`ASSERT
(
found_key
.
off£t
 =
block_group
->
Àngth
);

251 
d⁄e
 = 1;

253 } i‡(
found_key
.
ty≥
 =
BTRFS_FREE_SPACE_EXTENT_KEY
) {

254 
u64
 
fú°
, 
œ°
;

256 
	`ASSERT
(
found_key
.
obje˘id
 >
°¨t
);

257 
	`ASSERT
(
found_key
.
obje˘id
 < 
íd
);

258 
	`ASSERT
(
found_key
.
obje˘id
 + found_key.
off£t
 <
íd
);

260 
fú°
 = 
	`div_u64
(
found_key
.
obje˘id
 - 
°¨t
,

261 
fs_öfo
->
£˘‹size
);

262 
œ°
 = 
	`div_u64
(
found_key
.
obje˘id
 + found_key.
off£t
 - 
°¨t
,

263 
fs_öfo
->
£˘‹size
);

264 
	`À_bôm≠_£t
(
bôm≠
, 
fú°
, 
œ°
 - first);

266 
exã¡_cou¡
++;

267 
ƒ
++;

268 
∑th
->
¶Ÿs
[0]--;

270 
	`ASSERT
(0);

274 
ªt
 = 
	`båfs_dñ_ôems
(
å™s
, 
roŸ
, 
∑th
,Ö©h->
¶Ÿs
[0], 
ƒ
);

275 i‡(
ªt
)

276 
out
;

277 
	`båfs_ªÀa£_∑th
(
∑th
);

280 
öfo
 = 
	`£¨ch_‰ì_•a˚_öfo
(
å™s
, 
block_group
, 
∑th
, 1);

281 i‡(
	`IS_ERR
(
öfo
)) {

282 
ªt
 = 
	`PTR_ERR
(
öfo
);

283 
out
;

285 
Àaf
 = 
∑th
->
nodes
[0];

286 
Êags
 = 
	`båfs_‰ì_•a˚_Êags
(
Àaf
, 
öfo
);

287 
Êags
 |
BTRFS_FREE_SPACE_USING_BITMAPS
;

288 
	`båfs_£t_‰ì_•a˚_Êags
(
Àaf
, 
öfo
, 
Êags
);

289 
ex≥˘ed_exã¡_cou¡
 = 
	`båfs_‰ì_•a˚_exã¡_cou¡
(
Àaf
, 
öfo
);

290 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

291 
	`båfs_ªÀa£_∑th
(
∑th
);

293 i‡(
exã¡_cou¡
 !
ex≥˘ed_exã¡_cou¡
) {

294 
	`båfs_îr
(
fs_öfo
,

296 
block_group
->
°¨t
, 
exã¡_cou¡
,

297 
ex≥˘ed_exã¡_cou¡
);

298 
	`ASSERT
(0);

299 
ªt
 = -
EIO
;

300 
out
;

303 
bôm≠_curs‹
 = (*)
bôm≠
;

304 
bôm≠_ønge
 = 
fs_öfo
->
£˘‹size
 * 
BTRFS_FREE_SPACE_BITMAP_BITS
;

305 
i
 = 
°¨t
;

306 
i
 < 
íd
) {

307 
±r
;

308 
u64
 
exã¡_size
;

309 
u32
 
d©a_size
;

311 
exã¡_size
 = 
	`mö
(
íd
 - 
i
, 
bôm≠_ønge
);

312 
d©a_size
 = 
	`‰ì_•a˚_bôm≠_size
(
fs_öfo
, 
exã¡_size
);

314 
key
.
obje˘id
 = 
i
;

315 
key
.
ty≥
 = 
BTRFS_FREE_SPACE_BITMAP_KEY
;

316 
key
.
off£t
 = 
exã¡_size
;

318 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
,

319 
d©a_size
);

320 i‡(
ªt
)

321 
out
;

323 
Àaf
 = 
∑th
->
nodes
[0];

324 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

325 
	`wrôe_exã¡_buf„r
(
Àaf
, 
bôm≠_curs‹
, 
±r
,

326 
d©a_size
);

327 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

328 
	`båfs_ªÀa£_∑th
(
∑th
);

330 
i
 +
exã¡_size
;

331 
bôm≠_curs‹
 +
d©a_size
;

334 
ªt
 = 0;

335 
out
:

336 
	`kv‰ì
(
bôm≠
);

337 i‡(
ªt
)

338 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

339  
ªt
;

340 
	}
}

342 
EXPORT_FOR_TESTS


343 
	$c⁄vît_‰ì_•a˚_to_exã¡s
(
båfs_å™s_h™dÀ
 *
å™s
,

344 
båfs_block_group
 *
block_group
,

345 
båfs_∑th
 *
∑th
)

347 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

348 
båfs_roŸ
 *
roŸ
 = 
	`båfs_‰ì_•a˚_roŸ
(
block_group
);

349 
båfs_‰ì_•a˚_öfo
 *
öfo
;

350 
båfs_key
 
key
, 
found_key
;

351 
exã¡_buf„r
 *
Àaf
;

352 *
bôm≠
;

353 
u64
 
°¨t
, 
íd
;

354 
u32
 
bôm≠_size
, 
Êags
, 
ex≥˘ed_exã¡_cou¡
;

355 
ƒbôs
, 
°¨t_bô
, 
íd_bô
;

356 
u32
 
exã¡_cou¡
 = 0;

357 
d⁄e
 = 0, 
ƒ
;

358 
ªt
;

360 
bôm≠_size
 = 
	`‰ì_•a˚_bôm≠_size
(
fs_öfo
, 
block_group
->
Àngth
);

361 
bôm≠
 = 
	`Æloc_bôm≠
(
bôm≠_size
);

362 i‡(!
bôm≠
) {

363 
ªt
 = -
ENOMEM
;

364 
out
;

367 
°¨t
 = 
block_group
->start;

368 
íd
 = 
block_group
->
°¨t
 + block_group->
Àngth
;

370 
key
.
obje˘id
 = 
íd
 - 1;

371 
key
.
ty≥
 = (
u8
)-1;

372 
key
.
off£t
 = (
u64
)-1;

374 !
d⁄e
) {

375 
ªt
 = 
	`båfs_£¨ch_¥ev_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

376 i‡(
ªt
)

377 
out
;

379 
Àaf
 = 
∑th
->
nodes
[0];

380 
ƒ
 = 0;

381 
∑th
->
¶Ÿs
[0]++;

382 
∑th
->
¶Ÿs
[0] > 0) {

383 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0] - 1);

385 i‡(
found_key
.
ty≥
 =
BTRFS_FREE_SPACE_INFO_KEY
) {

386 
	`ASSERT
(
found_key
.
obje˘id
 =
block_group
->
°¨t
);

387 
	`ASSERT
(
found_key
.
off£t
 =
block_group
->
Àngth
);

388 
d⁄e
 = 1;

390 } i‡(
found_key
.
ty≥
 =
BTRFS_FREE_SPACE_BITMAP_KEY
) {

391 
±r
;

392 *
bôm≠_curs‹
;

393 
u32
 
bôm≠_pos
, 
d©a_size
;

395 
	`ASSERT
(
found_key
.
obje˘id
 >
°¨t
);

396 
	`ASSERT
(
found_key
.
obje˘id
 < 
íd
);

397 
	`ASSERT
(
found_key
.
obje˘id
 + found_key.
off£t
 <
íd
);

399 
bôm≠_pos
 = 
	`div_u64
(
found_key
.
obje˘id
 - 
°¨t
,

400 
fs_öfo
->
£˘‹size
 *

401 
BITS_PER_BYTE
);

402 
bôm≠_curs‹
 = ((*)
bôm≠
Ë+ 
bôm≠_pos
;

403 
d©a_size
 = 
	`‰ì_•a˚_bôm≠_size
(
fs_öfo
,

404 
found_key
.
off£t
);

406 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0] - 1);

407 
	`ªad_exã¡_buf„r
(
Àaf
, 
bôm≠_curs‹
, 
±r
,

408 
d©a_size
);

410 
ƒ
++;

411 
∑th
->
¶Ÿs
[0]--;

413 
	`ASSERT
(0);

417 
ªt
 = 
	`båfs_dñ_ôems
(
å™s
, 
roŸ
, 
∑th
,Ö©h->
¶Ÿs
[0], 
ƒ
);

418 i‡(
ªt
)

419 
out
;

420 
	`båfs_ªÀa£_∑th
(
∑th
);

423 
öfo
 = 
	`£¨ch_‰ì_•a˚_öfo
(
å™s
, 
block_group
, 
∑th
, 1);

424 i‡(
	`IS_ERR
(
öfo
)) {

425 
ªt
 = 
	`PTR_ERR
(
öfo
);

426 
out
;

428 
Àaf
 = 
∑th
->
nodes
[0];

429 
Êags
 = 
	`båfs_‰ì_•a˚_Êags
(
Àaf
, 
öfo
);

430 
Êags
 &~
BTRFS_FREE_SPACE_USING_BITMAPS
;

431 
	`båfs_£t_‰ì_•a˚_Êags
(
Àaf
, 
öfo
, 
Êags
);

432 
ex≥˘ed_exã¡_cou¡
 = 
	`båfs_‰ì_•a˚_exã¡_cou¡
(
Àaf
, 
öfo
);

433 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

434 
	`båfs_ªÀa£_∑th
(
∑th
);

436 
ƒbôs
 = 
block_group
->
Àngth
 >> block_group->
fs_öfo
->
£˘‹size_bôs
;

437 
°¨t_bô
 = 
	`föd_√xt_bô_À
(
bôm≠
, 
ƒbôs
, 0);

439 
°¨t_bô
 < 
ƒbôs
) {

440 
íd_bô
 = 
	`föd_√xt_zîo_bô_À
(
bôm≠
, 
ƒbôs
, 
°¨t_bô
);

441 
	`ASSERT
(
°¨t_bô
 < 
íd_bô
);

443 
key
.
obje˘id
 = 
°¨t
 + 
°¨t_bô
 * 
block_group
->
fs_öfo
->
£˘‹size
;

444 
key
.
ty≥
 = 
BTRFS_FREE_SPACE_EXTENT_KEY
;

445 
key
.
off£t
 = (
íd_bô
 - 
°¨t_bô
Ë* 
block_group
->
fs_öfo
->
£˘‹size
;

447 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
, 0);

448 i‡(
ªt
)

449 
out
;

450 
	`båfs_ªÀa£_∑th
(
∑th
);

452 
exã¡_cou¡
++;

454 
°¨t_bô
 = 
	`föd_√xt_bô_À
(
bôm≠
, 
ƒbôs
, 
íd_bô
);

457 i‡(
exã¡_cou¡
 !
ex≥˘ed_exã¡_cou¡
) {

458 
	`båfs_îr
(
fs_öfo
,

460 
block_group
->
°¨t
, 
exã¡_cou¡
,

461 
ex≥˘ed_exã¡_cou¡
);

462 
	`ASSERT
(0);

463 
ªt
 = -
EIO
;

464 
out
;

467 
ªt
 = 0;

468 
out
:

469 
	`kv‰ì
(
bôm≠
);

470 i‡(
ªt
)

471 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

472  
ªt
;

473 
	}
}

475 
	$upd©e_‰ì_•a˚_exã¡_cou¡
(
båfs_å™s_h™dÀ
 *
å™s
,

476 
båfs_block_group
 *
block_group
,

477 
båfs_∑th
 *
∑th
,

478 
√w_exã¡s
)

480 
båfs_‰ì_•a˚_öfo
 *
öfo
;

481 
u32
 
Êags
;

482 
u32
 
exã¡_cou¡
;

483 
ªt
 = 0;

485 i‡(
√w_exã¡s
 == 0)

488 
öfo
 = 
	`£¨ch_‰ì_•a˚_öfo
(
å™s
, 
block_group
, 
∑th
, 1);

489 i‡(
	`IS_ERR
(
öfo
)) {

490 
ªt
 = 
	`PTR_ERR
(
öfo
);

491 
out
;

493 
Êags
 = 
	`båfs_‰ì_•a˚_Êags
(
∑th
->
nodes
[0], 
öfo
);

494 
exã¡_cou¡
 = 
	`båfs_‰ì_•a˚_exã¡_cou¡
(
∑th
->
nodes
[0], 
öfo
);

496 
exã¡_cou¡
 +
√w_exã¡s
;

497 
	`båfs_£t_‰ì_•a˚_exã¡_cou¡
(
∑th
->
nodes
[0], 
öfo
, 
exã¡_cou¡
);

498 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑th
->
nodes
[0]);

499 
	`båfs_ªÀa£_∑th
(
∑th
);

501 i‡(!(
Êags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) &&

502 
exã¡_cou¡
 > 
block_group
->
bôm≠_high_thªsh
) {

503 
ªt
 = 
	`c⁄vît_‰ì_•a˚_to_bôm≠s
(
å™s
, 
block_group
, 
∑th
);

504 } i‡((
Êags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) &&

505 
exã¡_cou¡
 < 
block_group
->
bôm≠_low_thªsh
) {

506 
ªt
 = 
	`c⁄vît_‰ì_•a˚_to_exã¡s
(
å™s
, 
block_group
, 
∑th
);

509 
out
:

510  
ªt
;

511 
	}
}

513 
EXPORT_FOR_TESTS


514 
	$‰ì_•a˚_ã°_bô
(
båfs_block_group
 *
block_group
,

515 
båfs_∑th
 *
∑th
, 
u64
 
off£t
)

517 
exã¡_buf„r
 *
Àaf
;

518 
båfs_key
 
key
;

519 
u64
 
found_°¨t
, 
found_íd
;

520 
±r
, 
i
;

522 
Àaf
 = 
∑th
->
nodes
[0];

523 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

524 
	`ASSERT
(
key
.
ty≥
 =
BTRFS_FREE_SPACE_BITMAP_KEY
);

526 
found_°¨t
 = 
key
.
obje˘id
;

527 
found_íd
 = 
key
.
obje˘id
 + key.
off£t
;

528 
	`ASSERT
(
off£t
 >
found_°¨t
 && off£à< 
found_íd
);

530 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

531 
i
 = 
	`div_u64
(
off£t
 - 
found_°¨t
,

532 
block_group
->
fs_öfo
->
£˘‹size
);

533  !!
	`exã¡_buf„r_ã°_bô
(
Àaf
, 
±r
, 
i
);

534 
	}
}

536 
	$‰ì_•a˚_£t_bôs
(
båfs_å™s_h™dÀ
 *
å™s
,

537 
båfs_block_group
 *
block_group
,

538 
båfs_∑th
 *
∑th
, 
u64
 *
°¨t
, u64 *
size
,

539 
bô
)

541 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

542 
exã¡_buf„r
 *
Àaf
;

543 
båfs_key
 
key
;

544 
u64
 
íd
 = *
°¨t
 + *
size
;

545 
u64
 
found_°¨t
, 
found_íd
;

546 
±r
, 
fú°
, 
œ°
;

548 
Àaf
 = 
∑th
->
nodes
[0];

549 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

550 
	`ASSERT
(
key
.
ty≥
 =
BTRFS_FREE_SPACE_BITMAP_KEY
);

552 
found_°¨t
 = 
key
.
obje˘id
;

553 
found_íd
 = 
key
.
obje˘id
 + key.
off£t
;

554 
	`ASSERT
(*
°¨t
 >
found_°¨t
 && *°¨à< 
found_íd
);

555 
	`ASSERT
(
íd
 > 
found_°¨t
);

557 i‡(
íd
 > 
found_íd
)

558 
íd
 = 
found_íd
;

560 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

561 
fú°
 = (*
°¨t
 - 
found_°¨t
Ë>> 
fs_öfo
->
£˘‹size_bôs
;

562 
œ°
 = (
íd
 - 
found_°¨t
Ë>> 
fs_öfo
->
£˘‹size_bôs
;

563 i‡(
bô
)

564 
	`exã¡_buf„r_bôm≠_£t
(
Àaf
, 
±r
, 
fú°
, 
œ°
 - first);

566 
	`exã¡_buf„r_bôm≠_˛ór
(
Àaf
, 
±r
, 
fú°
, 
œ°
 - first);

567 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

569 *
size
 -
íd
 - *
°¨t
;

570 *
°¨t
 = 
íd
;

571 
	}
}

579 
	$‰ì_•a˚_√xt_bôm≠
(
båfs_å™s_h™dÀ
 *
å™s
,

580 
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
p
)

582 
båfs_key
 
key
;

584 i‡(
p
->
¶Ÿs
[0] + 1 < 
	`båfs_hódî_ƒôems
’->
nodes
[0])) {

585 
p
->
¶Ÿs
[0]++;

589 
	`båfs_ôem_key_to_˝u
(
p
->
nodes
[0], &
key
,Ö->
¶Ÿs
[0]);

590 
	`båfs_ªÀa£_∑th
(
p
);

592 
key
.
obje˘id
 +key.
off£t
;

593 
key
.
ty≥
 = (
u8
)-1;

594 
key
.
off£t
 = (
u64
)-1;

596  
	`båfs_£¨ch_¥ev_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
p
, 0, 1);

597 
	}
}

604 
	$modify_‰ì_•a˚_bôm≠
(
båfs_å™s_h™dÀ
 *
å™s
,

605 
båfs_block_group
 *
block_group
,

606 
båfs_∑th
 *
∑th
,

607 
u64
 
°¨t
, u64 
size
, 
ªmove
)

609 
båfs_roŸ
 *
roŸ
 = 
	`båfs_‰ì_•a˚_roŸ
(
block_group
);

610 
båfs_key
 
key
;

611 
u64
 
íd
 = 
°¨t
 + 
size
;

612 
u64
 
cur_°¨t
, 
cur_size
;

613 
¥ev_bô
, 
√xt_bô
;

614 
√w_exã¡s
;

615 
ªt
;

621 i‡(
°¨t
 > 
block_group
->start) {

622 
u64
 
¥ev_block
 = 
°¨t
 - 
block_group
->
fs_öfo
->
£˘‹size
;

624 
key
.
obje˘id
 = 
¥ev_block
;

625 
key
.
ty≥
 = (
u8
)-1;

626 
key
.
off£t
 = (
u64
)-1;

628 
ªt
 = 
	`båfs_£¨ch_¥ev_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, 0, 1);

629 i‡(
ªt
)

630 
out
;

632 
¥ev_bô
 = 
	`‰ì_•a˚_ã°_bô
(
block_group
, 
∑th
, 
¥ev_block
);

635 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

636 i‡(
°¨t
 >
key
.
obje˘id
 + key.
off£t
) {

637 
ªt
 = 
	`‰ì_•a˚_√xt_bôm≠
(
å™s
, 
roŸ
, 
∑th
);

638 i‡(
ªt
)

639 
out
;

642 
key
.
obje˘id
 = 
°¨t
;

643 
key
.
ty≥
 = (
u8
)-1;

644 
key
.
off£t
 = (
u64
)-1;

646 
ªt
 = 
	`båfs_£¨ch_¥ev_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, 0, 1);

647 i‡(
ªt
)

648 
out
;

650 
¥ev_bô
 = -1;

657 
cur_°¨t
 = 
°¨t
;

658 
cur_size
 = 
size
;

660 
	`‰ì_•a˚_£t_bôs
(
å™s
, 
block_group
, 
∑th
, &
cur_°¨t
, &
cur_size
,

661 !
ªmove
);

662 i‡(
cur_size
 == 0)

664 
ªt
 = 
	`‰ì_•a˚_√xt_bôm≠
(
å™s
, 
roŸ
, 
∑th
);

665 i‡(
ªt
)

666 
out
;

673 i‡(
íd
 < 
block_group
->
°¨t
 + block_group->
Àngth
) {

675 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

676 i‡(
íd
 >
key
.
obje˘id
 + key.
off£t
) {

677 
ªt
 = 
	`‰ì_•a˚_√xt_bôm≠
(
å™s
, 
roŸ
, 
∑th
);

678 i‡(
ªt
)

679 
out
;

682 
√xt_bô
 = 
	`‰ì_•a˚_ã°_bô
(
block_group
, 
∑th
, 
íd
);

684 
√xt_bô
 = -1;

687 i‡(
ªmove
) {

688 
√w_exã¡s
 = -1;

689 i‡(
¥ev_bô
 == 1) {

691 
√w_exã¡s
++;

693 i‡(
√xt_bô
 == 1) {

695 
√w_exã¡s
++;

698 
√w_exã¡s
 = 1;

699 i‡(
¥ev_bô
 == 1) {

701 
√w_exã¡s
--;

703 i‡(
√xt_bô
 == 1) {

705 
√w_exã¡s
--;

709 
	`båfs_ªÀa£_∑th
(
∑th
);

710 
ªt
 = 
	`upd©e_‰ì_•a˚_exã¡_cou¡
(
å™s
, 
block_group
, 
∑th
,

711 
√w_exã¡s
);

713 
out
:

714  
ªt
;

715 
	}
}

717 
	$ªmove_‰ì_•a˚_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

718 
båfs_block_group
 *
block_group
,

719 
båfs_∑th
 *
∑th
,

720 
u64
 
°¨t
, u64 
size
)

722 
båfs_roŸ
 *
roŸ
 = 
	`båfs_‰ì_•a˚_roŸ
(
block_group
);

723 
båfs_key
 
key
;

724 
u64
 
found_°¨t
, 
found_íd
;

725 
u64
 
íd
 = 
°¨t
 + 
size
;

726 
√w_exã¡s
 = -1;

727 
ªt
;

729 
key
.
obje˘id
 = 
°¨t
;

730 
key
.
ty≥
 = (
u8
)-1;

731 
key
.
off£t
 = (
u64
)-1;

733 
ªt
 = 
	`båfs_£¨ch_¥ev_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

734 i‡(
ªt
)

735 
out
;

737 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

739 
	`ASSERT
(
key
.
ty≥
 =
BTRFS_FREE_SPACE_EXTENT_KEY
);

741 
found_°¨t
 = 
key
.
obje˘id
;

742 
found_íd
 = 
key
.
obje˘id
 + key.
off£t
;

743 
	`ASSERT
(
°¨t
 >
found_°¨t
 && 
íd
 <
found_íd
);

765 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

766 i‡(
ªt
)

767 
out
;

770 i‡(
°¨t
 > 
found_°¨t
) {

771 
key
.
obje˘id
 = 
found_°¨t
;

772 
key
.
ty≥
 = 
BTRFS_FREE_SPACE_EXTENT_KEY
;

773 
key
.
off£t
 = 
°¨t
 - 
found_°¨t
;

775 
	`båfs_ªÀa£_∑th
(
∑th
);

776 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
, 0);

777 i‡(
ªt
)

778 
out
;

779 
√w_exã¡s
++;

783 i‡(
íd
 < 
found_íd
) {

784 
key
.
obje˘id
 = 
íd
;

785 
key
.
ty≥
 = 
BTRFS_FREE_SPACE_EXTENT_KEY
;

786 
key
.
off£t
 = 
found_íd
 - 
íd
;

788 
	`båfs_ªÀa£_∑th
(
∑th
);

789 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
, 0);

790 i‡(
ªt
)

791 
out
;

792 
√w_exã¡s
++;

795 
	`båfs_ªÀa£_∑th
(
∑th
);

796 
ªt
 = 
	`upd©e_‰ì_•a˚_exã¡_cou¡
(
å™s
, 
block_group
, 
∑th
,

797 
√w_exã¡s
);

799 
out
:

800  
ªt
;

801 
	}
}

803 
EXPORT_FOR_TESTS


804 
	$__ªmove_‰om_‰ì_•a˚_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

805 
båfs_block_group
 *
block_group
,

806 
båfs_∑th
 *
∑th
, 
u64
 
°¨t
, u64 
size
)

808 
båfs_‰ì_•a˚_öfo
 *
öfo
;

809 
u32
 
Êags
;

810 
ªt
;

812 i‡(
	`ã°_bô
(
BLOCK_GROUP_FLAG_NEEDS_FREE_SPACE
, &
block_group
->
ru¡ime_Êags
)) {

813 
ªt
 = 
	`__add_block_group_‰ì_•a˚
(
å™s
, 
block_group
, 
∑th
);

814 i‡(
ªt
)

815  
ªt
;

818 
öfo
 = 
	`£¨ch_‰ì_•a˚_öfo
(
NULL
, 
block_group
, 
∑th
, 0);

819 i‡(
	`IS_ERR
(
öfo
))

820  
	`PTR_ERR
(
öfo
);

821 
Êags
 = 
	`båfs_‰ì_•a˚_Êags
(
∑th
->
nodes
[0], 
öfo
);

822 
	`båfs_ªÀa£_∑th
(
∑th
);

824 i‡(
Êags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) {

825  
	`modify_‰ì_•a˚_bôm≠
(
å™s
, 
block_group
, 
∑th
,

826 
°¨t
, 
size
, 1);

828  
	`ªmove_‰ì_•a˚_exã¡
(
å™s
, 
block_group
, 
∑th
,

829 
°¨t
, 
size
);

831 
	}
}

833 
	$ªmove_‰om_‰ì_•a˚_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

834 
u64
 
°¨t
, u64 
size
)

836 
båfs_block_group
 *
block_group
;

837 
båfs_∑th
 *
∑th
;

838 
ªt
;

840 i‡(!
	`båfs_fs_com∑t_ro
(
å™s
->
fs_öfo
, 
FREE_SPACE_TREE
))

843 
∑th
 = 
	`båfs_Æloc_∑th
();

844 i‡(!
∑th
) {

845 
ªt
 = -
ENOMEM
;

846 
out
;

849 
block_group
 = 
	`båfs_lookup_block_group
(
å™s
->
fs_öfo
, 
°¨t
);

850 i‡(!
block_group
) {

851 
	`ASSERT
(0);

852 
ªt
 = -
ENOENT
;

853 
out
;

856 
	`muãx_lock
(&
block_group
->
‰ì_•a˚_lock
);

857 
ªt
 = 
	`__ªmove_‰om_‰ì_•a˚_åì
(
å™s
, 
block_group
, 
∑th
, 
°¨t
,

858 
size
);

859 
	`muãx_u∆ock
(&
block_group
->
‰ì_•a˚_lock
);

861 
	`båfs_put_block_group
(
block_group
);

862 
out
:

863 
	`båfs_‰ì_∑th
(
∑th
);

864 i‡(
ªt
)

865 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

866  
ªt
;

867 
	}
}

869 
	$add_‰ì_•a˚_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

870 
båfs_block_group
 *
block_group
,

871 
båfs_∑th
 *
∑th
,

872 
u64
 
°¨t
, u64 
size
)

874 
båfs_roŸ
 *
roŸ
 = 
	`båfs_‰ì_•a˚_roŸ
(
block_group
);

875 
båfs_key
 
key
, 
√w_key
;

876 
u64
 
found_°¨t
, 
found_íd
;

877 
u64
 
íd
 = 
°¨t
 + 
size
;

878 
√w_exã¡s
 = 1;

879 
ªt
;

899 
√w_key
.
obje˘id
 = 
°¨t
;

900 
√w_key
.
ty≥
 = 
BTRFS_FREE_SPACE_EXTENT_KEY
;

901 
√w_key
.
off£t
 = 
size
;

904 i‡(
°¨t
 =
block_group
->start)

905 
right
;

906 
key
.
obje˘id
 = 
°¨t
 - 1;

907 
key
.
ty≥
 = (
u8
)-1;

908 
key
.
off£t
 = (
u64
)-1;

910 
ªt
 = 
	`båfs_£¨ch_¥ev_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

911 i‡(
ªt
)

912 
out
;

914 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

916 i‡(
key
.
ty≥
 !
BTRFS_FREE_SPACE_EXTENT_KEY
) {

917 
	`ASSERT
(
key
.
ty≥
 =
BTRFS_FREE_SPACE_INFO_KEY
);

918 
	`båfs_ªÀa£_∑th
(
∑th
);

919 
right
;

922 
found_°¨t
 = 
key
.
obje˘id
;

923 
found_íd
 = 
key
.
obje˘id
 + key.
off£t
;

924 
	`ASSERT
(
found_°¨t
 >
block_group
->
°¨t
 &&

925 
found_íd
 > 
block_group
->
°¨t
);

926 
	`ASSERT
(
found_°¨t
 < 
°¨t
 && 
found_íd
 <= start);

932 i‡(
found_íd
 =
°¨t
) {

933 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

934 i‡(
ªt
)

935 
out
;

936 
√w_key
.
obje˘id
 = 
found_°¨t
;

937 
√w_key
.
off£t
 +
key
.offset;

938 
√w_exã¡s
--;

940 
	`båfs_ªÀa£_∑th
(
∑th
);

942 
right
:

944 i‡(
íd
 =
block_group
->
°¨t
 + block_group->
Àngth
)

945 
ö£π
;

946 
key
.
obje˘id
 = 
íd
;

947 
key
.
ty≥
 = (
u8
)-1;

948 
key
.
off£t
 = (
u64
)-1;

950 
ªt
 = 
	`båfs_£¨ch_¥ev_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

951 i‡(
ªt
)

952 
out
;

954 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

956 i‡(
key
.
ty≥
 !
BTRFS_FREE_SPACE_EXTENT_KEY
) {

957 
	`ASSERT
(
key
.
ty≥
 =
BTRFS_FREE_SPACE_INFO_KEY
);

958 
	`båfs_ªÀa£_∑th
(
∑th
);

959 
ö£π
;

962 
found_°¨t
 = 
key
.
obje˘id
;

963 
found_íd
 = 
key
.
obje˘id
 + key.
off£t
;

964 
	`ASSERT
(
found_°¨t
 >
block_group
->
°¨t
 &&

965 
found_íd
 > 
block_group
->
°¨t
);

966 
	`ASSERT
((
found_°¨t
 < 
°¨t
 && 
found_íd
 <= start) ||

967 (
found_°¨t
 >
íd
 && 
found_íd
 >Énd));

973 i‡(
found_°¨t
 =
íd
) {

974 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

975 i‡(
ªt
)

976 
out
;

977 
√w_key
.
off£t
 +
key
.offset;

978 
√w_exã¡s
--;

980 
	`båfs_ªÀa£_∑th
(
∑th
);

982 
ö£π
:

984 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
√w_key
, 0);

985 i‡(
ªt
)

986 
out
;

988 
	`båfs_ªÀa£_∑th
(
∑th
);

989 
ªt
 = 
	`upd©e_‰ì_•a˚_exã¡_cou¡
(
å™s
, 
block_group
, 
∑th
,

990 
√w_exã¡s
);

992 
out
:

993  
ªt
;

994 
	}
}

996 
EXPORT_FOR_TESTS


997 
	$__add_to_‰ì_•a˚_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

998 
båfs_block_group
 *
block_group
,

999 
båfs_∑th
 *
∑th
, 
u64
 
°¨t
, u64 
size
)

1001 
båfs_‰ì_•a˚_öfo
 *
öfo
;

1002 
u32
 
Êags
;

1003 
ªt
;

1005 i‡(
	`ã°_bô
(
BLOCK_GROUP_FLAG_NEEDS_FREE_SPACE
, &
block_group
->
ru¡ime_Êags
)) {

1006 
ªt
 = 
	`__add_block_group_‰ì_•a˚
(
å™s
, 
block_group
, 
∑th
);

1007 i‡(
ªt
)

1008  
ªt
;

1011 
öfo
 = 
	`£¨ch_‰ì_•a˚_öfo
(
NULL
, 
block_group
, 
∑th
, 0);

1012 i‡(
	`IS_ERR
(
öfo
))

1013  
	`PTR_ERR
(
öfo
);

1014 
Êags
 = 
	`båfs_‰ì_•a˚_Êags
(
∑th
->
nodes
[0], 
öfo
);

1015 
	`båfs_ªÀa£_∑th
(
∑th
);

1017 i‡(
Êags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) {

1018  
	`modify_‰ì_•a˚_bôm≠
(
å™s
, 
block_group
, 
∑th
,

1019 
°¨t
, 
size
, 0);

1021  
	`add_‰ì_•a˚_exã¡
(
å™s
, 
block_group
, 
∑th
, 
°¨t
,

1022 
size
);

1024 
	}
}

1026 
	$add_to_‰ì_•a˚_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

1027 
u64
 
°¨t
, u64 
size
)

1029 
båfs_block_group
 *
block_group
;

1030 
båfs_∑th
 *
∑th
;

1031 
ªt
;

1033 i‡(!
	`båfs_fs_com∑t_ro
(
å™s
->
fs_öfo
, 
FREE_SPACE_TREE
))

1036 
∑th
 = 
	`båfs_Æloc_∑th
();

1037 i‡(!
∑th
) {

1038 
ªt
 = -
ENOMEM
;

1039 
out
;

1042 
block_group
 = 
	`båfs_lookup_block_group
(
å™s
->
fs_öfo
, 
°¨t
);

1043 i‡(!
block_group
) {

1044 
	`ASSERT
(0);

1045 
ªt
 = -
ENOENT
;

1046 
out
;

1049 
	`muãx_lock
(&
block_group
->
‰ì_•a˚_lock
);

1050 
ªt
 = 
	`__add_to_‰ì_•a˚_åì
(
å™s
, 
block_group
, 
∑th
, 
°¨t
, 
size
);

1051 
	`muãx_u∆ock
(&
block_group
->
‰ì_•a˚_lock
);

1053 
	`båfs_put_block_group
(
block_group
);

1054 
out
:

1055 
	`båfs_‰ì_∑th
(
∑th
);

1056 i‡(
ªt
)

1057 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1058  
ªt
;

1059 
	}
}

1066 
	$p›uœã_‰ì_•a˚_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

1067 
båfs_block_group
 *
block_group
)

1069 
båfs_roŸ
 *
exã¡_roŸ
;

1070 
båfs_∑th
 *
∑th
, *
∑th2
;

1071 
båfs_key
 
key
;

1072 
u64
 
°¨t
, 
íd
;

1073 
ªt
;

1075 
∑th
 = 
	`båfs_Æloc_∑th
();

1076 i‡(!
∑th
)

1077  -
ENOMEM
;

1078 
∑th
->
ªada
 = 
READA_FORWARD
;

1080 
∑th2
 = 
	`båfs_Æloc_∑th
();

1081 i‡(!
∑th2
) {

1082 
	`båfs_‰ì_∑th
(
∑th
);

1083  -
ENOMEM
;

1086 
ªt
 = 
	`add_√w_‰ì_•a˚_öfo
(
å™s
, 
block_group
, 
∑th2
);

1087 i‡(
ªt
)

1088 
out
;

1090 
	`muãx_lock
(&
block_group
->
‰ì_•a˚_lock
);

1099 
key
.
obje˘id
 = 
block_group
->
°¨t
;

1100 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

1101 
key
.
off£t
 = 0;

1103 
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
å™s
->
fs_öfo
, 
key
.
obje˘id
);

1104 
ªt
 = 
	`båfs_£¨ch_¶Ÿ_f‹_ªad
(
exã¡_roŸ
, &
key
, 
∑th
, 1, 0);

1105 i‡(
ªt
 < 0)

1106 
out_locked
;

1107 
	`ASSERT
(
ªt
 == 0);

1109 
°¨t
 = 
block_group
->start;

1110 
íd
 = 
block_group
->
°¨t
 + block_group->
Àngth
;

1112 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

1114 i‡(
key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 ||

1115 
key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
) {

1116 i‡(
key
.
obje˘id
 >
íd
)

1119 i‡(
°¨t
 < 
key
.
obje˘id
) {

1120 
ªt
 = 
	`__add_to_‰ì_•a˚_åì
(
å™s
,

1121 
block_group
,

1122 
∑th2
, 
°¨t
,

1123 
key
.
obje˘id
 -

1124 
°¨t
);

1125 i‡(
ªt
)

1126 
out_locked
;

1128 
°¨t
 = 
key
.
obje˘id
;

1129 i‡(
key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
)

1130 
°¨t
 +
å™s
->
fs_öfo
->
nodesize
;

1132 
°¨t
 +
key
.
off£t
;

1133 } i‡(
key
.
ty≥
 =
BTRFS_BLOCK_GROUP_ITEM_KEY
) {

1134 i‡(
key
.
obje˘id
 !
block_group
->
°¨t
)

1138 
ªt
 = 
	`båfs_√xt_ôem
(
exã¡_roŸ
, 
∑th
);

1139 i‡(
ªt
 < 0)

1140 
out_locked
;

1141 i‡(
ªt
)

1144 i‡(
°¨t
 < 
íd
) {

1145 
ªt
 = 
	`__add_to_‰ì_•a˚_åì
(
å™s
, 
block_group
, 
∑th2
,

1146 
°¨t
, 
íd
 - start);

1147 i‡(
ªt
)

1148 
out_locked
;

1151 
ªt
 = 0;

1152 
out_locked
:

1153 
	`muãx_u∆ock
(&
block_group
->
‰ì_•a˚_lock
);

1154 
out
:

1155 
	`båfs_‰ì_∑th
(
∑th2
);

1156 
	`båfs_‰ì_∑th
(
∑th
);

1157  
ªt
;

1158 
	}
}

1160 
	$båfs_¸óã_‰ì_•a˚_åì
(
båfs_fs_öfo
 *
fs_öfo
)

1162 
båfs_å™s_h™dÀ
 *
å™s
;

1163 
båfs_roŸ
 *
åì_roŸ
 = 
fs_öfo
->tree_root;

1164 
båfs_roŸ
 *
‰ì_•a˚_roŸ
;

1165 
båfs_block_group
 *
block_group
;

1166 
rb_node
 *
node
;

1167 
ªt
;

1169 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
åì_roŸ
, 0);

1170 i‡(
	`IS_ERR
(
å™s
))

1171  
	`PTR_ERR
(
å™s
);

1173 
	`£t_bô
(
BTRFS_FS_CREATING_FREE_SPACE_TREE
, &
fs_öfo
->
Êags
);

1174 
	`£t_bô
(
BTRFS_FS_FREE_SPACE_TREE_UNTRUSTED
, &
fs_öfo
->
Êags
);

1175 
‰ì_•a˚_roŸ
 = 
	`båfs_¸óã_åì
(
å™s
,

1176 
BTRFS_FREE_SPACE_TREE_OBJECTID
);

1177 i‡(
	`IS_ERR
(
‰ì_•a˚_roŸ
)) {

1178 
ªt
 = 
	`PTR_ERR
(
‰ì_•a˚_roŸ
);

1179 
ab‹t
;

1181 
ªt
 = 
	`båfs_globÆ_roŸ_ö£π
(
‰ì_•a˚_roŸ
);

1182 i‡(
ªt
) {

1183 
	`båfs_put_roŸ
(
‰ì_•a˚_roŸ
);

1184 
ab‹t
;

1187 
node
 = 
	`rb_fú°_ˇched
(&
fs_öfo
->
block_group_ˇche_åì
);

1188 
node
) {

1189 
block_group
 = 
	`rb_íåy
(
node
, 
båfs_block_group
,

1190 
ˇche_node
);

1191 
ªt
 = 
	`p›uœã_‰ì_•a˚_åì
(
å™s
, 
block_group
);

1192 i‡(
ªt
)

1193 
ab‹t
;

1194 
node
 = 
	`rb_√xt
(node);

1197 
	`båfs_£t_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE
);

1198 
	`båfs_£t_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE_VALID
);

1199 
	`˛ór_bô
(
BTRFS_FS_CREATING_FREE_SPACE_TREE
, &
fs_öfo
->
Êags
);

1200 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

1206 
	`˛ór_bô
(
BTRFS_FS_FREE_SPACE_TREE_UNTRUSTED
, &
fs_öfo
->
Êags
);

1207  
ªt
;

1209 
ab‹t
:

1210 
	`˛ór_bô
(
BTRFS_FS_CREATING_FREE_SPACE_TREE
, &
fs_öfo
->
Êags
);

1211 
	`˛ór_bô
(
BTRFS_FS_FREE_SPACE_TREE_UNTRUSTED
, &
fs_öfo
->
Êags
);

1212 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1213 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1214  
ªt
;

1215 
	}
}

1217 
	$˛ór_‰ì_•a˚_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

1218 
båfs_roŸ
 *
roŸ
)

1220 
båfs_∑th
 *
∑th
;

1221 
båfs_key
 
key
;

1222 
ƒ
;

1223 
ªt
;

1225 
∑th
 = 
	`båfs_Æloc_∑th
();

1226 i‡(!
∑th
)

1227  -
ENOMEM
;

1229 
key
.
obje˘id
 = 0;

1230 
key
.
ty≥
 = 0;

1231 
key
.
off£t
 = 0;

1234 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

1235 i‡(
ªt
 < 0)

1236 
out
;

1238 
ƒ
 = 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0]);

1239 i‡(!
ƒ
)

1242 
∑th
->
¶Ÿs
[0] = 0;

1243 
ªt
 = 
	`båfs_dñ_ôems
(
å™s
, 
roŸ
, 
∑th
, 0, 
ƒ
);

1244 i‡(
ªt
)

1245 
out
;

1247 
	`båfs_ªÀa£_∑th
(
∑th
);

1250 
ªt
 = 0;

1251 
out
:

1252 
	`båfs_‰ì_∑th
(
∑th
);

1253  
ªt
;

1254 
	}
}

1256 
	$båfs_dñëe_‰ì_•a˚_åì
(
båfs_fs_öfo
 *
fs_öfo
)

1258 
båfs_å™s_h™dÀ
 *
å™s
;

1259 
båfs_roŸ
 *
åì_roŸ
 = 
fs_öfo
->tree_root;

1260 
båfs_key
 
key
 = {

1261 .
obje˘id
 = 
BTRFS_FREE_SPACE_TREE_OBJECTID
,

1262 .
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
,

1263 .
off£t
 = 0,

1265 
båfs_roŸ
 *
‰ì_•a˚_roŸ
 = 
	`båfs_globÆ_roŸ
(
fs_öfo
, &
key
);

1266 
ªt
;

1268 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
åì_roŸ
, 0);

1269 i‡(
	`IS_ERR
(
å™s
))

1270  
	`PTR_ERR
(
å™s
);

1272 
	`båfs_˛ór_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE
);

1273 
	`båfs_˛ór_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE_VALID
);

1275 
ªt
 = 
	`˛ór_‰ì_•a˚_åì
(
å™s
, 
‰ì_•a˚_roŸ
);

1276 i‡(
ªt
)

1277 
ab‹t
;

1279 
ªt
 = 
	`båfs_dñ_roŸ
(
å™s
, &
‰ì_•a˚_roŸ
->
roŸ_key
);

1280 i‡(
ªt
)

1281 
ab‹t
;

1283 
	`båfs_globÆ_roŸ_dñëe
(
‰ì_•a˚_roŸ
);

1285 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

1286 
	`li°_dñ
(&
‰ì_•a˚_roŸ
->
dúty_li°
);

1287 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

1289 
	`båfs_åì_lock
(
‰ì_•a˚_roŸ
->
node
);

1290 
	`båfs_˛ór_buf„r_dúty
(
å™s
, 
‰ì_•a˚_roŸ
->
node
);

1291 
	`båfs_åì_u∆ock
(
‰ì_•a˚_roŸ
->
node
);

1292 
	`båfs_‰ì_åì_block
(
å™s
, 
	`båfs_roŸ_id
(
‰ì_•a˚_roŸ
),

1293 
‰ì_•a˚_roŸ
->
node
, 0, 1);

1295 
	`båfs_put_roŸ
(
‰ì_•a˚_roŸ
);

1297  
	`båfs_commô_å™ß˘i⁄
(
å™s
);

1299 
ab‹t
:

1300 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1301 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1302  
ªt
;

1303 
	}
}

1305 
	$båfs_ªbuûd_‰ì_•a˚_åì
(
båfs_fs_öfo
 *
fs_öfo
)

1307 
båfs_å™s_h™dÀ
 *
å™s
;

1308 
båfs_key
 
key
 = {

1309 .
obje˘id
 = 
BTRFS_FREE_SPACE_TREE_OBJECTID
,

1310 .
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
,

1311 .
off£t
 = 0,

1313 
båfs_roŸ
 *
‰ì_•a˚_roŸ
 = 
	`båfs_globÆ_roŸ
(
fs_öfo
, &
key
);

1314 
rb_node
 *
node
;

1315 
ªt
;

1317 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
‰ì_•a˚_roŸ
, 1);

1318 i‡(
	`IS_ERR
(
å™s
))

1319  
	`PTR_ERR
(
å™s
);

1321 
	`£t_bô
(
BTRFS_FS_CREATING_FREE_SPACE_TREE
, &
fs_öfo
->
Êags
);

1322 
	`£t_bô
(
BTRFS_FS_FREE_SPACE_TREE_UNTRUSTED
, &
fs_öfo
->
Êags
);

1324 
ªt
 = 
	`˛ór_‰ì_•a˚_åì
(
å™s
, 
‰ì_•a˚_roŸ
);

1325 i‡(
ªt
)

1326 
ab‹t
;

1328 
node
 = 
	`rb_fú°_ˇched
(&
fs_öfo
->
block_group_ˇche_åì
);

1329 
node
) {

1330 
båfs_block_group
 *
block_group
;

1332 
block_group
 = 
	`rb_íåy
(
node
, 
båfs_block_group
,

1333 
ˇche_node
);

1334 
ªt
 = 
	`p›uœã_‰ì_•a˚_åì
(
å™s
, 
block_group
);

1335 i‡(
ªt
)

1336 
ab‹t
;

1337 
node
 = 
	`rb_√xt
(node);

1340 
	`båfs_£t_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE
);

1341 
	`båfs_£t_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE_VALID
);

1342 
	`˛ór_bô
(
BTRFS_FS_CREATING_FREE_SPACE_TREE
, &
fs_öfo
->
Êags
);

1344 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

1345 
	`˛ór_bô
(
BTRFS_FS_FREE_SPACE_TREE_UNTRUSTED
, &
fs_öfo
->
Êags
);

1346  
ªt
;

1347 
ab‹t
:

1348 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1349 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1350  
ªt
;

1351 
	}
}

1353 
	$__add_block_group_‰ì_•a˚
(
båfs_å™s_h™dÀ
 *
å™s
,

1354 
båfs_block_group
 *
block_group
,

1355 
båfs_∑th
 *
∑th
)

1357 
ªt
;

1359 
	`˛ór_bô
(
BLOCK_GROUP_FLAG_NEEDS_FREE_SPACE
, &
block_group
->
ru¡ime_Êags
);

1361 
ªt
 = 
	`add_√w_‰ì_•a˚_öfo
(
å™s
, 
block_group
, 
∑th
);

1362 i‡(
ªt
)

1363  
ªt
;

1365  
	`__add_to_‰ì_•a˚_åì
(
å™s
, 
block_group
, 
∑th
,

1366 
block_group
->
°¨t
,

1367 
block_group
->
Àngth
);

1368 
	}
}

1370 
	$add_block_group_‰ì_•a˚
(
båfs_å™s_h™dÀ
 *
å™s
,

1371 
båfs_block_group
 *
block_group
)

1373 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1374 
båfs_∑th
 *
∑th
 = 
NULL
;

1375 
ªt
 = 0;

1377 i‡(!
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE
))

1380 
	`muãx_lock
(&
block_group
->
‰ì_•a˚_lock
);

1381 i‡(!
	`ã°_bô
(
BLOCK_GROUP_FLAG_NEEDS_FREE_SPACE
, &
block_group
->
ru¡ime_Êags
))

1382 
out
;

1384 
∑th
 = 
	`båfs_Æloc_∑th
();

1385 i‡(!
∑th
) {

1386 
ªt
 = -
ENOMEM
;

1387 
out
;

1390 
ªt
 = 
	`__add_block_group_‰ì_•a˚
(
å™s
, 
block_group
, 
∑th
);

1392 
out
:

1393 
	`båfs_‰ì_∑th
(
∑th
);

1394 
	`muãx_u∆ock
(&
block_group
->
‰ì_•a˚_lock
);

1395 i‡(
ªt
)

1396 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1397  
ªt
;

1398 
	}
}

1400 
	$ªmove_block_group_‰ì_•a˚
(
båfs_å™s_h™dÀ
 *
å™s
,

1401 
båfs_block_group
 *
block_group
)

1403 
båfs_roŸ
 *
roŸ
 = 
	`båfs_‰ì_•a˚_roŸ
(
block_group
);

1404 
båfs_∑th
 *
∑th
;

1405 
båfs_key
 
key
, 
found_key
;

1406 
exã¡_buf„r
 *
Àaf
;

1407 
u64
 
°¨t
, 
íd
;

1408 
d⁄e
 = 0, 
ƒ
;

1409 
ªt
;

1411 i‡(!
	`båfs_fs_com∑t_ro
(
å™s
->
fs_öfo
, 
FREE_SPACE_TREE
))

1414 i‡(
	`ã°_bô
(
BLOCK_GROUP_FLAG_NEEDS_FREE_SPACE
, &
block_group
->
ru¡ime_Êags
)) {

1419 
∑th
 = 
	`båfs_Æloc_∑th
();

1420 i‡(!
∑th
) {

1421 
ªt
 = -
ENOMEM
;

1422 
out
;

1425 
°¨t
 = 
block_group
->start;

1426 
íd
 = 
block_group
->
°¨t
 + block_group->
Àngth
;

1428 
key
.
obje˘id
 = 
íd
 - 1;

1429 
key
.
ty≥
 = (
u8
)-1;

1430 
key
.
off£t
 = (
u64
)-1;

1432 !
d⁄e
) {

1433 
ªt
 = 
	`båfs_£¨ch_¥ev_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

1434 i‡(
ªt
)

1435 
out
;

1437 
Àaf
 = 
∑th
->
nodes
[0];

1438 
ƒ
 = 0;

1439 
∑th
->
¶Ÿs
[0]++;

1440 
∑th
->
¶Ÿs
[0] > 0) {

1441 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0] - 1);

1443 i‡(
found_key
.
ty≥
 =
BTRFS_FREE_SPACE_INFO_KEY
) {

1444 
	`ASSERT
(
found_key
.
obje˘id
 =
block_group
->
°¨t
);

1445 
	`ASSERT
(
found_key
.
off£t
 =
block_group
->
Àngth
);

1446 
d⁄e
 = 1;

1447 
ƒ
++;

1448 
∑th
->
¶Ÿs
[0]--;

1450 } i‡(
found_key
.
ty≥
 =
BTRFS_FREE_SPACE_EXTENT_KEY
 ||

1451 
found_key
.
ty≥
 =
BTRFS_FREE_SPACE_BITMAP_KEY
) {

1452 
	`ASSERT
(
found_key
.
obje˘id
 >
°¨t
);

1453 
	`ASSERT
(
found_key
.
obje˘id
 < 
íd
);

1454 
	`ASSERT
(
found_key
.
obje˘id
 + found_key.
off£t
 <
íd
);

1455 
ƒ
++;

1456 
∑th
->
¶Ÿs
[0]--;

1458 
	`ASSERT
(0);

1462 
ªt
 = 
	`båfs_dñ_ôems
(
å™s
, 
roŸ
, 
∑th
,Ö©h->
¶Ÿs
[0], 
ƒ
);

1463 i‡(
ªt
)

1464 
out
;

1465 
	`båfs_ªÀa£_∑th
(
∑th
);

1468 
ªt
 = 0;

1469 
out
:

1470 
	`båfs_‰ì_∑th
(
∑th
);

1471 i‡(
ªt
)

1472 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1473  
ªt
;

1474 
	}
}

1476 
	$lﬂd_‰ì_•a˚_bôm≠s
(
båfs_ˇchög_c⁄åﬁ
 *
ˇchög_˘l
,

1477 
båfs_∑th
 *
∑th
,

1478 
u32
 
ex≥˘ed_exã¡_cou¡
)

1480 
båfs_block_group
 *
block_group
;

1481 
båfs_fs_öfo
 *
fs_öfo
;

1482 
båfs_roŸ
 *
roŸ
;

1483 
båfs_key
 
key
;

1484 
¥ev_bô
 = 0, 
bô
;

1486 
u64
 
exã¡_°¨t
 = 0;

1487 
u64
 
íd
, 
off£t
;

1488 
u64
 
tŸÆ_found
 = 0;

1489 
u32
 
exã¡_cou¡
 = 0;

1490 
ªt
;

1492 
block_group
 = 
ˇchög_˘l
->block_group;

1493 
fs_öfo
 = 
block_group
->fs_info;

1494 
roŸ
 = 
	`båfs_‰ì_•a˚_roŸ
(
block_group
);

1496 
íd
 = 
block_group
->
°¨t
 + block_group->
Àngth
;

1499 
ªt
 = 
	`båfs_√xt_ôem
(
roŸ
, 
∑th
);

1500 i‡(
ªt
 < 0)

1501 
out
;

1502 i‡(
ªt
)

1505 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

1507 i‡(
key
.
ty≥
 =
BTRFS_FREE_SPACE_INFO_KEY
)

1510 
	`ASSERT
(
key
.
ty≥
 =
BTRFS_FREE_SPACE_BITMAP_KEY
);

1511 
	`ASSERT
(
key
.
obje˘id
 < 
íd
 && key.obje˘id + key.
off£t
 <=Énd);

1513 
off£t
 = 
key
.
obje˘id
;

1514 
off£t
 < 
key
.
obje˘id
 + key.offset) {

1515 
bô
 = 
	`‰ì_•a˚_ã°_bô
(
block_group
, 
∑th
, 
off£t
);

1516 i‡(
¥ev_bô
 =0 && 
bô
 == 1) {

1517 
exã¡_°¨t
 = 
off£t
;

1518 } i‡(
¥ev_bô
 =1 && 
bô
 == 0) {

1519 
u64
 
•a˚_added
;

1521 
ªt
 = 
	`båfs_add_√w_‰ì_•a˚
(
block_group
,

1522 
exã¡_°¨t
,

1523 
off£t
,

1524 &
•a˚_added
);

1525 i‡(
ªt
)

1526 
out
;

1527 
tŸÆ_found
 +
•a˚_added
;

1528 i‡(
tŸÆ_found
 > 
CACHING_CTL_WAKE_UP
) {

1529 
tŸÆ_found
 = 0;

1530 
	`wake_up
(&
ˇchög_˘l
->
waô
);

1532 
exã¡_cou¡
++;

1534 
¥ev_bô
 = 
bô
;

1535 
off£t
 +
fs_öfo
->
£˘‹size
;

1538 i‡(
¥ev_bô
 == 1) {

1539 
ªt
 = 
	`båfs_add_√w_‰ì_•a˚
(
block_group
, 
exã¡_°¨t
, 
íd
, 
NULL
);

1540 i‡(
ªt
)

1541 
out
;

1542 
exã¡_cou¡
++;

1545 i‡(
exã¡_cou¡
 !
ex≥˘ed_exã¡_cou¡
) {

1546 
	`båfs_îr
(
fs_öfo
,

1548 
block_group
->
°¨t
, 
exã¡_cou¡
,

1549 
ex≥˘ed_exã¡_cou¡
);

1550 
	`ASSERT
(0);

1551 
ªt
 = -
EIO
;

1552 
out
;

1555 
ªt
 = 0;

1556 
out
:

1557  
ªt
;

1558 
	}
}

1560 
	$lﬂd_‰ì_•a˚_exã¡s
(
båfs_ˇchög_c⁄åﬁ
 *
ˇchög_˘l
,

1561 
båfs_∑th
 *
∑th
,

1562 
u32
 
ex≥˘ed_exã¡_cou¡
)

1564 
båfs_block_group
 *
block_group
;

1565 
båfs_fs_öfo
 *
fs_öfo
;

1566 
båfs_roŸ
 *
roŸ
;

1567 
båfs_key
 
key
;

1568 
u64
 
íd
;

1569 
u64
 
tŸÆ_found
 = 0;

1570 
u32
 
exã¡_cou¡
 = 0;

1571 
ªt
;

1573 
block_group
 = 
ˇchög_˘l
->block_group;

1574 
fs_öfo
 = 
block_group
->fs_info;

1575 
roŸ
 = 
	`båfs_‰ì_•a˚_roŸ
(
block_group
);

1577 
íd
 = 
block_group
->
°¨t
 + block_group->
Àngth
;

1580 
u64
 
•a˚_added
;

1582 
ªt
 = 
	`båfs_√xt_ôem
(
roŸ
, 
∑th
);

1583 i‡(
ªt
 < 0)

1584 
out
;

1585 i‡(
ªt
)

1588 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

1590 i‡(
key
.
ty≥
 =
BTRFS_FREE_SPACE_INFO_KEY
)

1593 
	`ASSERT
(
key
.
ty≥
 =
BTRFS_FREE_SPACE_EXTENT_KEY
);

1594 
	`ASSERT
(
key
.
obje˘id
 < 
íd
 && key.obje˘id + key.
off£t
 <=Énd);

1596 
ªt
 = 
	`båfs_add_√w_‰ì_•a˚
(
block_group
, 
key
.
obje˘id
,

1597 
key
.
obje˘id
 + key.
off£t
,

1598 &
•a˚_added
);

1599 i‡(
ªt
)

1600 
out
;

1601 
tŸÆ_found
 +
•a˚_added
;

1602 i‡(
tŸÆ_found
 > 
CACHING_CTL_WAKE_UP
) {

1603 
tŸÆ_found
 = 0;

1604 
	`wake_up
(&
ˇchög_˘l
->
waô
);

1606 
exã¡_cou¡
++;

1609 i‡(
exã¡_cou¡
 !
ex≥˘ed_exã¡_cou¡
) {

1610 
	`båfs_îr
(
fs_öfo
,

1612 
block_group
->
°¨t
, 
exã¡_cou¡
,

1613 
ex≥˘ed_exã¡_cou¡
);

1614 
	`ASSERT
(0);

1615 
ªt
 = -
EIO
;

1616 
out
;

1619 
ªt
 = 0;

1620 
out
:

1621  
ªt
;

1622 
	}
}

1624 
	$lﬂd_‰ì_•a˚_åì
(
båfs_ˇchög_c⁄åﬁ
 *
ˇchög_˘l
)

1626 
båfs_block_group
 *
block_group
;

1627 
båfs_‰ì_•a˚_öfo
 *
öfo
;

1628 
båfs_∑th
 *
∑th
;

1629 
u32
 
exã¡_cou¡
, 
Êags
;

1630 
ªt
;

1632 
block_group
 = 
ˇchög_˘l
->block_group;

1634 
∑th
 = 
	`båfs_Æloc_∑th
();

1635 i‡(!
∑th
)

1636  -
ENOMEM
;

1642 
∑th
->
skù_lockög
 = 1;

1643 
∑th
->
£¨ch_commô_roŸ
 = 1;

1644 
∑th
->
ªada
 = 
READA_FORWARD
;

1646 
öfo
 = 
	`£¨ch_‰ì_•a˚_öfo
(
NULL
, 
block_group
, 
∑th
, 0);

1647 i‡(
	`IS_ERR
(
öfo
)) {

1648 
ªt
 = 
	`PTR_ERR
(
öfo
);

1649 
out
;

1651 
exã¡_cou¡
 = 
	`båfs_‰ì_•a˚_exã¡_cou¡
(
∑th
->
nodes
[0], 
öfo
);

1652 
Êags
 = 
	`båfs_‰ì_•a˚_Êags
(
∑th
->
nodes
[0], 
öfo
);

1659 i‡(
Êags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
)

1660 
ªt
 = 
	`lﬂd_‰ì_•a˚_bôm≠s
(
ˇchög_˘l
, 
∑th
, 
exã¡_cou¡
);

1662 
ªt
 = 
	`lﬂd_‰ì_•a˚_exã¡s
(
ˇchög_˘l
, 
∑th
, 
exã¡_cou¡
);

1664 
out
:

1665 
	`båfs_‰ì_∑th
(
∑th
);

1666  
ªt
;

1667 
	}
}

	@free-space-tree.h

6 #i‚de‡
BTRFS_FREE_SPACE_TREE_H


7 
	#BTRFS_FREE_SPACE_TREE_H


	)

9 
	gbåfs_ˇchög_c⁄åﬁ
;

16 
	#BTRFS_FREE_SPACE_BITMAP_SIZE
 256

	)

17 
	#BTRFS_FREE_SPACE_BITMAP_BITS
 (
BTRFS_FREE_SPACE_BITMAP_SIZE
 * 
BITS_PER_BYTE
)

	)

19 
£t_‰ì_•a˚_åì_thªshﬁds
(
båfs_block_group
 *
block_group
);

20 
båfs_¸óã_‰ì_•a˚_åì
(
båfs_fs_öfo
 *
fs_öfo
);

21 
båfs_dñëe_‰ì_•a˚_åì
(
båfs_fs_öfo
 *
fs_öfo
);

22 
båfs_ªbuûd_‰ì_•a˚_åì
(
båfs_fs_öfo
 *
fs_öfo
);

23 
lﬂd_‰ì_•a˚_åì
(
båfs_ˇchög_c⁄åﬁ
 *
ˇchög_˘l
);

24 
add_block_group_‰ì_•a˚
(
båfs_å™s_h™dÀ
 *
å™s
,

25 
båfs_block_group
 *
block_group
);

26 
ªmove_block_group_‰ì_•a˚
(
båfs_å™s_h™dÀ
 *
å™s
,

27 
båfs_block_group
 *
block_group
);

28 
add_to_‰ì_•a˚_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

29 
u64
 
°¨t
, u64 
size
);

30 
ªmove_‰om_‰ì_•a˚_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

31 
u64
 
°¨t
, u64 
size
);

33 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


34 
båfs_‰ì_•a˚_öfo
 *

35 
£¨ch_‰ì_•a˚_öfo
(
båfs_å™s_h™dÀ
 *
å™s
,

36 
båfs_block_group
 *
block_group
,

37 
båfs_∑th
 *
∑th
, 
cow
);

38 
__add_to_‰ì_•a˚_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

39 
båfs_block_group
 *
block_group
,

40 
båfs_∑th
 *
∑th
, 
u64
 
°¨t
, u64 
size
);

41 
__ªmove_‰om_‰ì_•a˚_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

42 
båfs_block_group
 *
block_group
,

43 
båfs_∑th
 *
∑th
, 
u64
 
°¨t
, u64 
size
);

44 
c⁄vît_‰ì_•a˚_to_bôm≠s
(
båfs_å™s_h™dÀ
 *
å™s
,

45 
båfs_block_group
 *
block_group
,

46 
båfs_∑th
 *
∑th
);

47 
c⁄vît_‰ì_•a˚_to_exã¡s
(
båfs_å™s_h™dÀ
 *
å™s
,

48 
båfs_block_group
 *
block_group
,

49 
båfs_∑th
 *
∑th
);

50 
‰ì_•a˚_ã°_bô
(
båfs_block_group
 *
block_group
,

51 
båfs_∑th
 *
∑th
, 
u64
 
off£t
);

	@fs.c

3 
	~"mesßges.h
"

4 
	~"˘ªe.h
"

5 
	~"fs.h
"

6 
	~"ac˚ss‹s.h
"

8 
	$__båfs_£t_fs_öcom∑t
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
Êag
,

9 c⁄° *
«me
)

11 
båfs_su≥r_block
 *
disk_su≥r
;

12 
u64
 
„©uªs
;

14 
disk_su≥r
 = 
fs_öfo
->
su≥r_c›y
;

15 
„©uªs
 = 
	`båfs_su≥r_öcom∑t_Êags
(
disk_su≥r
);

16 i‡(!(
„©uªs
 & 
Êag
)) {

17 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

18 
„©uªs
 = 
	`båfs_su≥r_öcom∑t_Êags
(
disk_su≥r
);

19 i‡(!(
„©uªs
 & 
Êag
)) {

20 
„©uªs
 |
Êag
;

21 
	`båfs_£t_su≥r_öcom∑t_Êags
(
disk_su≥r
, 
„©uªs
);

22 
	`båfs_öfo
(
fs_öfo
,

24 
«me
, 
Êag
);

26 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

27 
	`£t_bô
(
BTRFS_FS_FEATURE_CHANGED
, &
fs_öfo
->
Êags
);

29 
	}
}

31 
	$__båfs_˛ór_fs_öcom∑t
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
Êag
,

32 c⁄° *
«me
)

34 
båfs_su≥r_block
 *
disk_su≥r
;

35 
u64
 
„©uªs
;

37 
disk_su≥r
 = 
fs_öfo
->
su≥r_c›y
;

38 
„©uªs
 = 
	`båfs_su≥r_öcom∑t_Êags
(
disk_su≥r
);

39 i‡(
„©uªs
 & 
Êag
) {

40 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

41 
„©uªs
 = 
	`båfs_su≥r_öcom∑t_Êags
(
disk_su≥r
);

42 i‡(
„©uªs
 & 
Êag
) {

43 
„©uªs
 &~
Êag
;

44 
	`båfs_£t_su≥r_öcom∑t_Êags
(
disk_su≥r
, 
„©uªs
);

45 
	`båfs_öfo
(
fs_öfo
,

47 
«me
, 
Êag
);

49 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

50 
	`£t_bô
(
BTRFS_FS_FEATURE_CHANGED
, &
fs_öfo
->
Êags
);

52 
	}
}

54 
	$__båfs_£t_fs_com∑t_ro
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
Êag
,

55 c⁄° *
«me
)

57 
båfs_su≥r_block
 *
disk_su≥r
;

58 
u64
 
„©uªs
;

60 
disk_su≥r
 = 
fs_öfo
->
su≥r_c›y
;

61 
„©uªs
 = 
	`båfs_su≥r_com∑t_ro_Êags
(
disk_su≥r
);

62 i‡(!(
„©uªs
 & 
Êag
)) {

63 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

64 
„©uªs
 = 
	`båfs_su≥r_com∑t_ro_Êags
(
disk_su≥r
);

65 i‡(!(
„©uªs
 & 
Êag
)) {

66 
„©uªs
 |
Êag
;

67 
	`båfs_£t_su≥r_com∑t_ro_Êags
(
disk_su≥r
, 
„©uªs
);

68 
	`båfs_öfo
(
fs_öfo
,

70 
«me
, 
Êag
);

72 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

73 
	`£t_bô
(
BTRFS_FS_FEATURE_CHANGED
, &
fs_öfo
->
Êags
);

75 
	}
}

77 
	$__båfs_˛ór_fs_com∑t_ro
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
Êag
,

78 c⁄° *
«me
)

80 
båfs_su≥r_block
 *
disk_su≥r
;

81 
u64
 
„©uªs
;

83 
disk_su≥r
 = 
fs_öfo
->
su≥r_c›y
;

84 
„©uªs
 = 
	`båfs_su≥r_com∑t_ro_Êags
(
disk_su≥r
);

85 i‡(
„©uªs
 & 
Êag
) {

86 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

87 
„©uªs
 = 
	`båfs_su≥r_com∑t_ro_Êags
(
disk_su≥r
);

88 i‡(
„©uªs
 & 
Êag
) {

89 
„©uªs
 &~
Êag
;

90 
	`båfs_£t_su≥r_com∑t_ro_Êags
(
disk_su≥r
, 
„©uªs
);

91 
	`båfs_öfo
(
fs_öfo
,

93 
«me
, 
Êag
);

95 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

96 
	`£t_bô
(
BTRFS_FS_FEATURE_CHANGED
, &
fs_öfo
->
Êags
);

98 
	}
}

	@fs.h

3 #i‚de‡
BTRFS_FS_H


4 
	#BTRFS_FS_H


	)

6 
	~<löux/blkdev.h
>

7 
	~<löux/fs.h
>

8 
	~<löux/båfs_åì.h
>

9 
	~<löux/sizes.h
>

10 
	~"exã¡-io-åì.h
"

11 
	~"exã¡_m≠.h
"

12 
	~"async-thªad.h
"

13 
	~"block-rsv.h
"

15 
	#BTRFS_MAX_EXTENT_SIZE
 
SZ_128M


	)

17 
	#BTRFS_OLDEST_GENERATION
 0ULL

	)

19 
	#BTRFS_EMPTY_DIR_SIZE
 0

	)

21 
	#BTRFS_DIRTY_METADATA_THRESH
 
SZ_32M


	)

23 
	#BTRFS_SUPER_INFO_OFFSET
 
SZ_64K


	)

24 
	#BTRFS_SUPER_INFO_SIZE
 4096

	)

25 
°©ic_as£π
((
båfs_su≥r_block
Ë=
BTRFS_SUPER_INFO_SIZE
);

28 
	#BTRFS_SUPER_INFO_OFFSET_1
 (339968)

	)

29 
	#BTRFS_SUPER_INFO_OFFSET_2
 (679936)

	)

30 
	#BTRFS_SUPER_INFO_COUNT
 64

	)

42 
	#BTRFS_UNLINK_METADATA_UNITS
 6

	)

49 
	#BTRFS_DEVICE_RANGE_RESERVED
 (
SZ_1M
)

	)

58 
	mBTRFS_FS_STATE_REMOUNTING
,

60 
	mBTRFS_FS_STATE_RO
,

62 
	mBTRFS_FS_STATE_TRANS_ABORTED
,

67 
	mBTRFS_FS_STATE_DEV_REPLACING
,

69 
	mBTRFS_FS_STATE_DUMMY_FS_INFO
,

71 
	mBTRFS_FS_STATE_NO_CSUMS
,

74 
	mBTRFS_FS_STATE_LOG_CLEANUP_ERROR
,

76 
	mBTRFS_FS_STATE_COUNT


80 
	mBTRFS_FS_CLOSING_START
,

81 
	mBTRFS_FS_CLOSING_DONE
,

82 
	mBTRFS_FS_LOG_RECOVERING
,

83 
	mBTRFS_FS_OPEN
,

84 
	mBTRFS_FS_QUOTA_ENABLED
,

85 
	mBTRFS_FS_UPDATE_UUID_TREE_GEN
,

86 
	mBTRFS_FS_CREATING_FREE_SPACE_TREE
,

87 
	mBTRFS_FS_BTREE_ERR
,

88 
	mBTRFS_FS_LOG1_ERR
,

89 
	mBTRFS_FS_LOG2_ERR
,

90 
	mBTRFS_FS_QUOTA_OVERRIDE
,

92 
	mBTRFS_FS_FROZEN
,

97 
	mBTRFS_FS_BALANCE_RUNNING
,

103 
	mBTRFS_FS_RELOC_RUNNING
,

106 
	mBTRFS_FS_CLEANER_RUNNING
,

112 
	mBTRFS_FS_CSUM_IMPL_FAST
,

115 
	mBTRFS_FS_DISCARD_RUNNING
,

118 
	mBTRFS_FS_CLEANUP_SPACE_CACHE_V1
,

121 
	mBTRFS_FS_FREE_SPACE_TREE_UNTRUSTED
,

124 
	mBTRFS_FS_TREE_MOD_LOG_USERS
,

127 
	mBTRFS_FS_COMMIT_TRANS
,

130 
	mBTRFS_FS_UNFINISHED_DROPS
,

133 
	mBTRFS_FS_NEED_ZONE_FINISH
,

136 
	mBTRFS_FS_NEED_TRANS_COMMIT
,

139 
	mBTRFS_FS_ACTIVE_ZONE_TRACKING
,

145 
	mBTRFS_FS_FEATURE_CHANGED
,

147 #i‡
BITS_PER_LONG
 == 32

149 
	mBTRFS_FS_32BIT_ERROR
,

150 
	mBTRFS_FS_32BIT_WARN
,

160 
	mBTRFS_MOUNT_NODATASUM
 = (1UL << 0),

161 
	mBTRFS_MOUNT_NODATACOW
 = (1UL << 1),

162 
	mBTRFS_MOUNT_NOBARRIER
 = (1UL << 2),

163 
	mBTRFS_MOUNT_SSD
 = (1UL << 3),

164 
	mBTRFS_MOUNT_DEGRADED
 = (1UL << 4),

165 
	mBTRFS_MOUNT_COMPRESS
 = (1UL << 5),

166 
	mBTRFS_MOUNT_NOTREELOG
 = (1UL << 6),

167 
	mBTRFS_MOUNT_FLUSHONCOMMIT
 = (1UL << 7),

168 
	mBTRFS_MOUNT_SSD_SPREAD
 = (1UL << 8),

169 
	mBTRFS_MOUNT_NOSSD
 = (1UL << 9),

170 
	mBTRFS_MOUNT_DISCARD_SYNC
 = (1UL << 10),

171 
	mBTRFS_MOUNT_FORCE_COMPRESS
 = (1UL << 11),

172 
	mBTRFS_MOUNT_SPACE_CACHE
 = (1UL << 12),

173 
	mBTRFS_MOUNT_CLEAR_CACHE
 = (1UL << 13),

174 
	mBTRFS_MOUNT_USER_SUBVOL_RM_ALLOWED
 = (1UL << 14),

175 
	mBTRFS_MOUNT_ENOSPC_DEBUG
 = (1UL << 15),

176 
	mBTRFS_MOUNT_AUTO_DEFRAG
 = (1UL << 16),

177 
	mBTRFS_MOUNT_USEBACKUPROOT
 = (1UL << 17),

178 
	mBTRFS_MOUNT_SKIP_BALANCE
 = (1UL << 18),

179 
	mBTRFS_MOUNT_CHECK_INTEGRITY
 = (1UL << 19),

180 
	mBTRFS_MOUNT_CHECK_INTEGRITY_DATA
 = (1UL << 20),

181 
	mBTRFS_MOUNT_PANIC_ON_FATAL_ERROR
 = (1UL << 21),

182 
	mBTRFS_MOUNT_RESCAN_UUID_TREE
 = (1UL << 22),

183 
	mBTRFS_MOUNT_FRAGMENT_DATA
 = (1UL << 23),

184 
	mBTRFS_MOUNT_FRAGMENT_METADATA
 = (1UL << 24),

185 
	mBTRFS_MOUNT_FREE_SPACE_TREE
 = (1UL << 25),

186 
	mBTRFS_MOUNT_NOLOGREPLAY
 = (1UL << 26),

187 
	mBTRFS_MOUNT_REF_VERIFY
 = (1UL << 27),

188 
	mBTRFS_MOUNT_DISCARD_ASYNC
 = (1UL << 28),

189 
	mBTRFS_MOUNT_IGNOREBADROOTS
 = (1UL << 29),

190 
	mBTRFS_MOUNT_IGNOREDATACSUMS
 = (1UL << 30),

191 
	mBTRFS_MOUNT_NODISCARD
 = (1UL << 31),

198 
	#BTRFS_FEATURE_COMPAT_SUPP
 0ULL

	)

199 
	#BTRFS_FEATURE_COMPAT_SAFE_SET
 0ULL

	)

200 
	#BTRFS_FEATURE_COMPAT_SAFE_CLEAR
 0ULL

	)

202 
	#BTRFS_FEATURE_COMPAT_RO_SUPP
 \

203 (
BTRFS_FEATURE_COMPAT_RO_FREE_SPACE_TREE
 | \

204 
BTRFS_FEATURE_COMPAT_RO_FREE_SPACE_TREE_VALID
 | \

205 
BTRFS_FEATURE_COMPAT_RO_VERITY
 | \

206 
BTRFS_FEATURE_COMPAT_RO_BLOCK_GROUP_TREE
)

	)

208 
	#BTRFS_FEATURE_COMPAT_RO_SAFE_SET
 0ULL

	)

209 
	#BTRFS_FEATURE_COMPAT_RO_SAFE_CLEAR
 0ULL

	)

211 
	#BTRFS_FEATURE_INCOMPAT_SUPP_STABLE
 \

212 (
BTRFS_FEATURE_INCOMPAT_MIXED_BACKREF
 | \

213 
BTRFS_FEATURE_INCOMPAT_DEFAULT_SUBVOL
 | \

214 
BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
 | \

215 
BTRFS_FEATURE_INCOMPAT_BIG_METADATA
 | \

216 
BTRFS_FEATURE_INCOMPAT_COMPRESS_LZO
 | \

217 
BTRFS_FEATURE_INCOMPAT_COMPRESS_ZSTD
 | \

218 
BTRFS_FEATURE_INCOMPAT_RAID56
 | \

219 
BTRFS_FEATURE_INCOMPAT_EXTENDED_IREF
 | \

220 
BTRFS_FEATURE_INCOMPAT_SKINNY_METADATA
 | \

221 
BTRFS_FEATURE_INCOMPAT_NO_HOLES
 | \

222 
BTRFS_FEATURE_INCOMPAT_METADATA_UUID
 | \

223 
BTRFS_FEATURE_INCOMPAT_RAID1C34
 | \

224 
BTRFS_FEATURE_INCOMPAT_ZONED
)

	)

226 #ifde‡
CONFIG_BTRFS_DEBUG


231 
	#BTRFS_FEATURE_INCOMPAT_SUPP
 \

232 (
BTRFS_FEATURE_INCOMPAT_SUPP_STABLE
 | \

233 
BTRFS_FEATURE_INCOMPAT_EXTENT_TREE_V2
)

	)

237 
	#BTRFS_FEATURE_INCOMPAT_SUPP
 \

238 (
BTRFS_FEATURE_INCOMPAT_SUPP_STABLE
)

	)

242 
	#BTRFS_FEATURE_INCOMPAT_SAFE_SET
 \

243 (
BTRFS_FEATURE_INCOMPAT_EXTENDED_IREF
)

	)

244 
	#BTRFS_FEATURE_INCOMPAT_SAFE_CLEAR
 0ULL

	)

246 
	#BTRFS_DEFAULT_COMMIT_INTERVAL
 (30)

	)

247 
	#BTRFS_DEFAULT_MAX_INLINE
 (2048)

	)

249 
	sbåfs_dev_ª∂a˚
 {

251 
u64
 
	mª∂a˚_°©e
;

253 
time64_t
 
	mtime_°¨ãd
;

255 
time64_t
 
	mtime_°›≥d
;

256 
©omic64_t
 
	mnum_wrôe_îr‹s
;

257 
©omic64_t
 
	mnum_unc‹ª˘abÀ_ªad_îr‹s
;

259 
u64
 
	mcurs‹_À·
;

260 
u64
 
	mcommôãd_curs‹_À·
;

261 
u64
 
	mcurs‹_À·_œ°_wrôe_of_ôem
;

262 
u64
 
	mcurs‹_right
;

265 
u64
 
	mc⁄t_ªadög_‰om_§cdev_mode
;

267 
	mis_vÆid
;

268 
	môem_√eds_wrôeback
;

269 
båfs_devi˚
 *
	m§cdev
;

270 
båfs_devi˚
 *
	mtgtdev
;

272 
muãx
 
	mlock_föishög_ˇn˚l_unmou¡
;

273 
rw_£m≠h‹e
 
	mrw£m
;

275 
båfs_s¸ub_¥ogªss
 
	ms¸ub_¥ogªss
;

277 
≥r˝u_cou¡î
 
	mbio_cou¡î
;

278 
waô_queue_hód_t
 
	mª∂a˚_waô
;

286 
	sbåfs_‰ì_˛u°î
 {

287 
•ölock_t
 
	mlock
;

288 
•ölock_t
 
	mªfûl_lock
;

289 
rb_roŸ
 
	mroŸ
;

292 
u64
 
	mmax_size
;

295 
u64
 
	mwödow_°¨t
;

298 
boﬁ
 
	m‰agmíãd
;

300 
båfs_block_group
 *
	mblock_group
;

306 
li°_hód
 
	mblock_group_li°
;

317 
	#BTRFS_NR_DISCARD_LISTS
 3

	)

318 
	#BTRFS_DISCARD_INDEX_UNUSED
 0

	)

319 
	#BTRFS_DISCARD_INDEX_START
 1

	)

321 
	sbåfs_disˇrd_˘l
 {

322 
w‹kqueue_°ru˘
 *
	mdisˇrd_w‹kîs
;

323 
dñayed_w‹k
 
	mw‹k
;

324 
•ölock_t
 
	mlock
;

325 
båfs_block_group
 *
	mblock_group
;

326 
li°_hód
 
	mdisˇrd_li°
[
BTRFS_NR_DISCARD_LISTS
];

327 
u64
 
	m¥ev_disˇrd
;

328 
u64
 
	m¥ev_disˇrd_time
;

329 
©omic_t
 
	mdisˇrdabÀ_exã¡s
;

330 
©omic64_t
 
	mdisˇrdabÀ_byãs
;

331 
u64
 
	mmax_disˇrd_size
;

332 
u64
 
	mdñay_ms
;

333 
u32
 
	mi›s_limô
;

334 
u32
 
	mkbps_limô
;

335 
u64
 
	mdisˇrd_exã¡_byãs
;

336 
u64
 
	mdisˇrd_bôm≠_byãs
;

337 
©omic64_t
 
	mdisˇrd_byãs_ßved
;

343 
	ebåfs_ex˛usive_›î©i⁄
 {

344 
	mBTRFS_EXCLOP_NONE
,

345 
	mBTRFS_EXCLOP_BALANCE_PAUSED
,

346 
	mBTRFS_EXCLOP_BALANCE
,

347 
	mBTRFS_EXCLOP_DEV_ADD
,

348 
	mBTRFS_EXCLOP_DEV_REMOVE
,

349 
	mBTRFS_EXCLOP_DEV_REPLACE
,

350 
	mBTRFS_EXCLOP_RESIZE
,

351 
	mBTRFS_EXCLOP_SWAP_ACTIVATE
,

355 
	sbåfs_commô_°©s
 {

357 
u64
 
	mcommô_cou¡
;

359 
u64
 
	mmax_commô_dur
;

361 
u64
 
	mœ°_commô_dur
;

363 
u64
 
	mtŸÆ_commô_dur
;

367 
	sbåfs_fs_öfo
 {

369 
	mid
;

370 
båfs_fs_öfo
 *
	mfs_öfo_¨øy
[
BTRFS_SUPER_INFO_COUNT
];

371 
u8
 
	mchunk_åì_uuid
[
BTRFS_UUID_SIZE
];

372 
	mÊags
;

373 
båfs_roŸ
 *
	måì_roŸ
;

374 
båfs_roŸ
 *
	mchunk_roŸ
;

375 
båfs_roŸ
 *
	mdev_roŸ
;

376 
båfs_roŸ
 *
	mfs_roŸ
;

377 
båfs_roŸ
 *
	mquŸa_roŸ
;

378 
båfs_roŸ
 *
	muuid_roŸ
;

379 
båfs_roŸ
 *
	md©a_ªloc_roŸ
;

380 
båfs_roŸ
 *
	mblock_group_roŸ
;

383 
båfs_roŸ
 *
	mlog_roŸ_åì
;

386 
rwlock_t
 
	mglobÆ_roŸ_lock
;

387 
rb_roŸ
 
	mglobÆ_roŸ_åì
;

389 
•ölock_t
 
	mfs_roŸs_ødix_lock
;

390 
ødix_åì_roŸ
 
	mfs_roŸs_ødix
;

393 
rwlock_t
 
	mblock_group_ˇche_lock
;

394 
rb_roŸ_ˇched
 
	mblock_group_ˇche_åì
;

397 
©omic64_t
 
	m‰ì_chunk_•a˚
;

400 
exã¡_io_åì
 
	mex˛uded_exã¡s
;

403 
exã¡_m≠_åì
 
	mm≠pög_åì
;

409 
båfs_block_rsv
 
	mglobÆ_block_rsv
;

411 
båfs_block_rsv
 
	må™s_block_rsv
;

413 
båfs_block_rsv
 
	mchunk_block_rsv
;

415 
båfs_block_rsv
 
	mdñayed_block_rsv
;

417 
båfs_block_rsv
 
	mdñayed_ªfs_rsv
;

419 
båfs_block_rsv
 
	mem±y_block_rsv
;

421 
u64
 
	mgíî©i⁄
;

422 
u64
 
	mœ°_å™s_commôãd
;

428 
u64
 
	mœ°_ªloc_å™s
;

434 
u64
 
	mœ°_å™s_log_fuŒ_commô
;

435 
	mmou¡_›t
;

437 
	mcom¥ess_ty≥
:4;

438 
	mcom¥ess_Àvñ
;

439 
u32
 
	mcommô_öãrvÆ
;

446 
u64
 
	mmax_ölöe
;

448 
båfs_å™ß˘i⁄
 *
	mru¬ög_å™ß˘i⁄
;

449 
waô_queue_hód_t
 
	må™ß˘i⁄_thrŸée
;

450 
waô_queue_hód_t
 
	må™ß˘i⁄_waô
;

451 
waô_queue_hód_t
 
	må™ß˘i⁄_blocked_waô
;

452 
waô_queue_hód_t
 
	masync_submô_waô
;

464 
•ölock_t
 
	msu≥r_lock
;

465 
båfs_su≥r_block
 *
	msu≥r_c›y
;

466 
båfs_su≥r_block
 *
	msu≥r_f‹_commô
;

467 
su≥r_block
 *
	msb
;

468 
öode
 *
	mbåì_öode
;

469 
muãx
 
	måì_log_muãx
;

470 
muãx
 
	må™ß˘i⁄_kthªad_muãx
;

471 
muãx
 
	m˛ó√r_muãx
;

472 
muãx
 
	mchunk_muãx
;

478 
muãx
 
	mro_block_group_muãx
;

484 
båfs_°rùe_hash_èbÀ
 *
	m°rùe_hash_èbÀ
;

493 
muãx
 
	m‹dîed_›î©i⁄s_muãx
;

495 
rw_£m≠h‹e
 
	mcommô_roŸ_£m
;

497 
rw_£m≠h‹e
 
	m˛ónup_w‹k_£m
;

499 
rw_£m≠h‹e
 
	msubvﬁ_£m
;

501 
•ölock_t
 
	må™s_lock
;

506 
muãx
 
	mªloc_muãx
;

508 
li°_hód
 
	må™s_li°
;

509 
li°_hód
 
	mdód_roŸs
;

510 
li°_hód
 
	mˇchög_block_groups
;

512 
•ölock_t
 
	mdñayed_ùut_lock
;

513 
li°_hód
 
	mdñayed_ùuts
;

514 
©omic_t
 
	mƒ_dñayed_ùuts
;

515 
waô_queue_hód_t
 
	mdñayed_ùuts_waô
;

517 
©omic64_t
 
	måì_mod_£q
;

520 
rwlock_t
 
	måì_mod_log_lock
;

521 
rb_roŸ
 
	måì_mod_log
;

522 
li°_hód
 
	måì_mod_£q_li°
;

524 
©omic_t
 
	masync_dñÆloc_∑ges
;

527 
•ölock_t
 
	m‹dîed_roŸ_lock
;

536 
li°_hód
 
	m‹dîed_roŸs
;

538 
muãx
 
	mdñÆloc_roŸ_muãx
;

539 
•ölock_t
 
	mdñÆloc_roŸ_lock
;

541 
li°_hód
 
	mdñÆloc_roŸs
;

552 
båfs_w‹kqueue
 *
	mw‹kîs
;

553 
båfs_w‹kqueue
 *
	mdñÆloc_w‹kîs
;

554 
båfs_w‹kqueue
 *
	mÊush_w‹kîs
;

555 
w‹kqueue_°ru˘
 *
	mídio_w‹kîs
;

556 
w‹kqueue_°ru˘
 *
	mídio_mëa_w‹kîs
;

557 
w‹kqueue_°ru˘
 *
	mrmw_w‹kîs
;

558 
w‹kqueue_°ru˘
 *
	mcom¥es£d_wrôe_w‹kîs
;

559 
båfs_w‹kqueue
 *
	mídio_wrôe_w‹kîs
;

560 
båfs_w‹kqueue
 *
	mídio_‰ì•a˚_w‹kî
;

561 
båfs_w‹kqueue
 *
	mˇchög_w‹kîs
;

568 
båfs_w‹kqueue
 *
	mfixup_w‹kîs
;

569 
båfs_w‹kqueue
 *
	mdñayed_w‹kîs
;

571 
èsk_°ru˘
 *
	må™ß˘i⁄_kthªad
;

572 
èsk_°ru˘
 *
	m˛ó√r_kthªad
;

573 
u32
 
	mthªad_poﬁ_size
;

575 
kobje˘
 *
	m•a˚_öfo_kobj
;

576 
kobje˘
 *
	mqgroups_kobj
;

577 
kobje˘
 *
	mdisˇrd_kobj
;

580 
≥r˝u_cou¡î
 
	mdúty_mëad©a_byãs
;

581 
≥r˝u_cou¡î
 
	mdñÆloc_byãs
;

582 
≥r˝u_cou¡î
 
	m‹dîed_byãs
;

583 
s32
 
	mdúty_mëad©a_b©ch
;

584 
s32
 
	mdñÆloc_b©ch
;

587 
li°_hód
 
	mdúty_cow⁄ly_roŸs
;

589 
båfs_fs_devi˚s
 *
	mfs_devi˚s
;

596 
li°_hód
 
	m•a˚_öfo
;

598 
båfs_•a˚_öfo
 *
	md©a_söfo
;

600 
ªloc_c⁄åﬁ
 *
	mªloc_˘l
;

603 
båfs_‰ì_˛u°î
 
	md©a_Æloc_˛u°î
;

606 
båfs_‰ì_˛u°î
 
	mmëa_Æloc_˛u°î
;

609 
•ölock_t
 
	mde‰ag_öodes_lock
;

610 
rb_roŸ
 
	mde‰ag_öodes
;

611 
©omic_t
 
	mde‰ag_ru¬ög
;

614 
£qlock_t
 
	m¥ofûes_lock
;

620 
u64
 
	mavaû_d©a_Æloc_bôs
;

621 
u64
 
	mavaû_mëad©a_Æloc_bôs
;

622 
u64
 
	mavaû_sy°em_Æloc_bôs
;

625 
•ölock_t
 
	mbÆ™˚_lock
;

626 
muãx
 
	mbÆ™˚_muãx
;

627 
©omic_t
 
	mbÆ™˚_∑u£_ªq
;

628 
©omic_t
 
	mbÆ™˚_ˇn˚l_ªq
;

629 
båfs_bÆ™˚_c⁄åﬁ
 *
	mbÆ™˚_˘l
;

630 
waô_queue_hód_t
 
	mbÆ™˚_waô_q
;

633 
©omic_t
 
	mªloc_ˇn˚l_ªq
;

635 
u32
 
	md©a_chunk_Æloˇti⁄s
;

636 
u32
 
	mmëad©a_øtio
;

638 *
	mbdev_hﬁdî
;

641 
muãx
 
	ms¸ub_lock
;

642 
©omic_t
 
	ms¸ubs_ru¬ög
;

643 
©omic_t
 
	ms¸ub_∑u£_ªq
;

644 
©omic_t
 
	ms¸ubs_∑u£d
;

645 
©omic_t
 
	ms¸ub_ˇn˚l_ªq
;

646 
waô_queue_hód_t
 
	ms¸ub_∑u£_waô
;

651 
ªfcou¡_t
 
	ms¸ub_w‹kîs_ªf˙t
;

652 
w‹kqueue_°ru˘
 *
	ms¸ub_w‹kîs
;

653 
båfs_sub∑ge_öfo
 *
	msub∑ge_öfo
;

655 
båfs_disˇrd_˘l
 
	mdisˇrd_˘l
;

657 #ifde‡
CONFIG_BTRFS_FS_CHECK_INTEGRITY


658 
u32
 
	mcheck_öãgrôy_¥öt_mask
;

661 
u64
 
	mqgroup_Êags
;

664 
rb_roŸ
 
	mqgroup_åì
;

665 
•ölock_t
 
	mqgroup_lock
;

671 
uli°
 *
	mqgroup_uli°
;

677 
muãx
 
	mqgroup_io˘l_lock
;

680 
li°_hód
 
	mdúty_qgroups
;

683 
u64
 
	mqgroup_£q
;

687 
muãx
 
	mqgroup_ªsˇn_lock
;

688 
båfs_key
 
	mqgroup_ªsˇn_¥ogªss
;

689 
båfs_w‹kqueue
 *
	mqgroup_ªsˇn_w‹kîs
;

690 
com∂ëi⁄
 
	mqgroup_ªsˇn_com∂ëi⁄
;

691 
båfs_w‹k
 
	mqgroup_ªsˇn_w‹k
;

693 
boﬁ
 
	mqgroup_ªsˇn_ru¬ög
;

694 
u8
 
	mqgroup_dr›_subåì_thªs
;

700 
	mfs_îr‹
;

703 
	mfs_°©e
;

705 
båfs_dñayed_roŸ
 *
	mdñayed_roŸ
;

708 
•ölock_t
 
	mbuf„r_lock
;

710 
ødix_åì_roŸ
 
	mbuf„r_ødix
;

713 
	mbackup_roŸ_ödex
;

716 
båfs_dev_ª∂a˚
 
	mdev_ª∂a˚
;

718 
£m≠h‹e
 
	muuid_åì_ªsˇn_£m
;

721 
w‹k_°ru˘
 
	masync_ª˛aim_w‹k
;

722 
w‹k_°ru˘
 
	masync_d©a_ª˛aim_w‹k
;

723 
w‹k_°ru˘
 
	m¥ìm±_ª˛aim_w‹k
;

726 
w‹k_°ru˘
 
	mª˛aim_bgs_w‹k
;

727 
li°_hód
 
	mª˛aim_bgs
;

728 
	mbg_ª˛aim_thªshﬁd
;

730 
•ölock_t
 
	munu£d_bgs_lock
;

731 
li°_hód
 
	munu£d_bgs
;

732 
muãx
 
	munu£d_bg_u≈ö_muãx
;

734 
muãx
 
	mª˛aim_bgs_lock
;

737 
u32
 
	mnodesize
;

738 
u32
 
	m£˘‹size
;

740 
u32
 
	m£˘‹size_bôs
;

741 
u32
 
	mcsum_size
;

742 
u32
 
	mcsums_≥r_Àaf
;

743 
u32
 
	m°rùesize
;

749 
u64
 
	mmax_exã¡_size
;

752 
•ölock_t
 
	msw≠fûe_pös_lock
;

753 
rb_roŸ
 
	msw≠fûe_pös
;

755 
¸y±o_shash
 *
	mcsum_shash
;

758 
båfs_ex˛usive_›î©i⁄
 
	mex˛usive_›î©i⁄
;

764 
u64
 
	mz⁄e_size
;

767 
queue_limôs
 
	mlimôs
;

768 
u64
 
	mmax_z⁄e_≠≥nd_size
;

770 
muãx
 
	mz⁄ed_mëa_io_lock
;

771 
•ölock_t
 
	måìlog_bg_lock
;

772 
u64
 
	måìlog_bg
;

778 
•ölock_t
 
	mªloˇti⁄_bg_lock
;

779 
u64
 
	md©a_ªloc_bg
;

780 
muãx
 
	mz⁄ed_d©a_ªloc_io_lock
;

782 
båfs_block_group
 *
	ma˘ive_mëa_bg
;

783 
båfs_block_group
 *
	ma˘ive_sy°em_bg
;

785 
u64
 
	mƒ_globÆ_roŸs
;

787 
•ölock_t
 
	mz⁄e_a˘ive_bgs_lock
;

788 
li°_hód
 
	mz⁄e_a˘ive_bgs
;

791 
båfs_commô_°©s
 
	mcommô_°©s
;

798 
u64
 
	mœ°_roŸ_dr›_gí
;

804 
lockdï_m≠
 
	mbåfs_å™s_num_wrôîs_m≠
;

805 
lockdï_m≠
 
	mbåfs_å™s_num_extwrôîs_m≠
;

806 
lockdï_m≠
 
	mbåfs_°©e_ch™ge_m≠
[4];

807 
lockdï_m≠
 
	mbåfs_å™s_≥ndög_‹dîed_m≠
;

808 
lockdï_m≠
 
	mbåfs_‹dîed_exã¡_m≠
;

810 #ifde‡
CONFIG_BTRFS_FS_REF_VERIFY


811 
•ölock_t
 
	mªf_vîify_lock
;

812 
rb_roŸ
 
	mblock_åì
;

815 #ifde‡
CONFIG_BTRFS_DEBUG


816 
kobje˘
 *
	mdebug_kobj
;

817 
li°_hód
 
	mÆloˇãd_roŸs
;

819 
•ölock_t
 
	meb_Àak_lock
;

820 
li°_hód
 
	mÆloˇãd_ebs
;

824 
ölöe
 
	$båfs_£t_œ°_roŸ_dr›_gí
(
båfs_fs_öfo
 *
fs_öfo
,

825 
u64
 
gí
)

827 
	`WRITE_ONCE
(
fs_öfo
->
œ°_roŸ_dr›_gí
, 
gí
);

828 
	}
}

830 
ölöe
 
u64
 
	$båfs_gë_œ°_roŸ_dr›_gí
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
)

832  
	`READ_ONCE
(
fs_öfo
->
œ°_roŸ_dr›_gí
);

833 
	}
}

839 
ölöe
 
u64
 
	$båfs_csum_byãs_to_Àaves
(

840 c⁄° 
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
csum_byãs
)

842 c⁄° 
u64
 
num_csums
 = 
csum_byãs
 >> 
fs_öfo
->
£˘‹size_bôs
;

844  
	`DIV_ROUND_UP_ULL
(
num_csums
, 
fs_öfo
->
csums_≥r_Àaf
);

845 
	}
}

851 
ölöe
 
u64
 
	$båfs_ˇlc_ö£π_mëad©a_size
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

852 
num_ôems
)

854  (
u64
)
fs_öfo
->
nodesize
 * 
BTRFS_MAX_LEVEL
 * 2 * 
num_ôems
;

855 
	}
}

861 
ölöe
 
u64
 
	$båfs_ˇlc_mëad©a_size
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

862 
num_ôems
)

864  (
u64
)
fs_öfo
->
nodesize
 * 
BTRFS_MAX_LEVEL
 * 
num_ôems
;

865 
	}
}

867 
	#BTRFS_MAX_EXTENT_ITEM_SIZE
(
r
Ë((
	`BTRFS_LEAF_DATA_SIZE
‘->
fs_öfo
) >> 4) - \

868 (
båfs_ôem
))

	)

870 
ölöe
 
boﬁ
 
	$båfs_is_z⁄ed
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
)

872  
	`IS_ENABLED
(
CONFIG_BLK_DEV_ZONED
Ë&& 
fs_öfo
->
z⁄e_size
 > 0;

873 
	}
}

878 
ölöe
 
u32
 
	$cou¡_max_exã¡s
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
size
)

880 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


881 i‡(!
fs_öfo
)

882  
	`div_u64
(
size
 + 
BTRFS_MAX_EXTENT_SIZE
 - 1, BTRFS_MAX_EXTENT_SIZE);

885  
	`div_u64
(
size
 + 
fs_öfo
->
max_exã¡_size
 - 1, fs_info->max_extent_size);

886 
	}
}

888 
boﬁ
 
båfs_ex˛›_°¨t
(
båfs_fs_öfo
 *
fs_öfo
,

889 
båfs_ex˛usive_›î©i⁄
 
ty≥
);

890 
boﬁ
 
båfs_ex˛›_°¨t_åy_lock
(
båfs_fs_öfo
 *
fs_öfo
,

891 
båfs_ex˛usive_›î©i⁄
 
ty≥
);

892 
båfs_ex˛›_°¨t_u∆ock
(
båfs_fs_öfo
 *
fs_öfo
);

893 
båfs_ex˛›_föish
(
båfs_fs_öfo
 *
fs_öfo
);

894 
båfs_ex˛›_bÆ™˚
(
båfs_fs_öfo
 *
fs_öfo
,

895 
båfs_ex˛usive_›î©i⁄
 
›
);

898 
__båfs_£t_fs_öcom∑t
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
Êag
,

899 c⁄° *
«me
);

900 
__båfs_˛ór_fs_öcom∑t
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
Êag
,

901 c⁄° *
«me
);

902 
__båfs_£t_fs_com∑t_ro
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
Êag
,

903 c⁄° *
«me
);

904 
__båfs_˛ór_fs_com∑t_ro
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
Êag
,

905 c⁄° *
«me
);

907 
	#__båfs_fs_öcom∑t
(
fs_öfo
, 
Êags
) \

908 (!!(
	`båfs_su≥r_öcom∑t_Êags
((
fs_öfo
)->
su≥r_c›y
Ë& (
Êags
)))

	)

910 
	#__båfs_fs_com∑t_ro
(
fs_öfo
, 
Êags
) \

911 (!!(
	`båfs_su≥r_com∑t_ro_Êags
((
fs_öfo
)->
su≥r_c›y
Ë& (
Êags
)))

	)

913 
	#båfs_£t_fs_öcom∑t
(
__fs_öfo
, 
›t
) \

914 
	`__båfs_£t_fs_öcom∑t
((
__fs_öfo
), 
BTRFS_FEATURE_INCOMPAT_
##
›t
, #›t)

	)

916 
	#båfs_˛ór_fs_öcom∑t
(
__fs_öfo
, 
›t
) \

917 
	`__båfs_˛ór_fs_öcom∑t
((
__fs_öfo
), 
BTRFS_FEATURE_INCOMPAT_
##
›t
, #›t)

	)

919 
	#båfs_fs_öcom∑t
(
fs_öfo
, 
›t
) \

920 
	`__båfs_fs_öcom∑t
((
fs_öfo
), 
BTRFS_FEATURE_INCOMPAT_
##
›t
)

	)

922 
	#båfs_£t_fs_com∑t_ro
(
__fs_öfo
, 
›t
) \

923 
	`__båfs_£t_fs_com∑t_ro
((
__fs_öfo
), 
BTRFS_FEATURE_COMPAT_RO_
##
›t
, #›t)

	)

925 
	#båfs_˛ór_fs_com∑t_ro
(
__fs_öfo
, 
›t
) \

926 
	`__båfs_˛ór_fs_com∑t_ro
((
__fs_öfo
), 
BTRFS_FEATURE_COMPAT_RO_
##
›t
, #›t)

	)

928 
	#båfs_fs_com∑t_ro
(
fs_öfo
, 
›t
) \

929 
	`__båfs_fs_com∑t_ro
((
fs_öfo
), 
BTRFS_FEATURE_COMPAT_RO_
##
›t
)

	)

931 
	#båfs_˛ór_›t
(
o
, 
›t
Ë((oË&~
BTRFS_MOUNT_
##›t)

	)

932 
	#båfs_£t_›t
(
o
, 
›t
Ë((oË|
BTRFS_MOUNT_
##›t)

	)

933 
	#båfs_øw_ã°_›t
(
o
, 
›t
Ë((oË& 
BTRFS_MOUNT_
##›t)

	)

934 
	#båfs_ã°_›t
(
fs_öfo
, 
›t
Ë((fs_öfo)->
mou¡_›t
 & \

935 
BTRFS_MOUNT_
##
›t
)

	)

937 
	#båfs_£t_™d_öfo
(
fs_öfo
, 
›t
, 
fmt
, 
¨gs
...) \

939 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
›t
)) \

940 
	`båfs_öfo
(
fs_öfo
, 
fmt
, ##
¨gs
); \

941 
	`båfs_£t_›t
(
fs_öfo
->
mou¡_›t
, 
›t
); \

942 } 0)

	)

944 
	#båfs_˛ór_™d_öfo
(
fs_öfo
, 
›t
, 
fmt
, 
¨gs
...) \

946 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
›t
)) \

947 
	`båfs_öfo
(
fs_öfo
, 
fmt
, ##
¨gs
); \

948 
	`båfs_˛ór_›t
(
fs_öfo
->
mou¡_›t
, 
›t
); \

949 } 0)

	)

951 
ölöe
 
	$båfs_fs_˛osög
(
båfs_fs_öfo
 *
fs_öfo
)

954 i‡(
	`ã°_bô
(
BTRFS_FS_CLOSING_START
, &
fs_öfo
->
Êags
)) {

955 i‡(
	`ã°_bô
(
BTRFS_FS_CLOSING_DONE
, &
fs_öfo
->
Êags
))

960 
	}
}

970 
ölöe
 
	$båfs_√ed_˛ó√r_¶ìp
(
båfs_fs_öfo
 *
fs_öfo
)

972  
	`ã°_bô
(
BTRFS_FS_STATE_RO
, &
fs_öfo
->
fs_°©e
) ||

973 
	`båfs_fs_˛osög
(
fs_öfo
);

974 
	}
}

976 
ölöe
 
	$båfs_wake_unföished_dr›
(
båfs_fs_öfo
 *
fs_öfo
)

978 
	`˛ór_™d_wake_up_bô
(
BTRFS_FS_UNFINISHED_DROPS
, &
fs_öfo
->
Êags
);

979 
	}
}

981 
	#BTRFS_FS_ERROR
(
fs_öfo
Ë(
	`READ_ONCE
((fs_öfo)->
fs_îr‹
))

	)

983 
	#BTRFS_FS_LOG_CLEANUP_ERROR
(
fs_öfo
) \

984 (
	`u∆ikñy
(
	`ã°_bô
(
BTRFS_FS_STATE_LOG_CLEANUP_ERROR
, \

985 &(
fs_öfo
)->
fs_°©e
)))

	)

987 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


989 
	#EXPORT_FOR_TESTS


	)

991 
ölöe
 
	$båfs_is_ã°ög
(
båfs_fs_öfo
 *
fs_öfo
)

993  
	`ã°_bô
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_öfo
->
fs_°©e
);

994 
	}
}

996 
båfs_ã°_de°roy_öode
(
öode
 *inode);

1000 
	#EXPORT_FOR_TESTS
 

	)

1002 
ölöe
 
	$båfs_is_ã°ög
(
båfs_fs_öfo
 *
fs_öfo
)

1005 
	}
}

	@inode-item.c

6 
	~"˘ªe.h
"

7 
	~"fs.h
"

8 
	~"mesßges.h
"

9 
	~"öode-ôem.h
"

10 
	~"disk-io.h
"

11 
	~"å™ß˘i⁄.h
"

12 
	~"¥öt-åì.h
"

13 
	~"•a˚-öfo.h
"

14 
	~"ac˚ss‹s.h
"

15 
	~"exã¡-åì.h
"

16 
	~"fûe-ôem.h
"

18 
båfs_öode_ªf
 *
	$båfs_föd_«me_ö_backªf
(
exã¡_buf„r
 *
Àaf
,

19 
¶Ÿ
,

20 c⁄° 
fs¸y±_°r
 *
«me
)

22 
båfs_öode_ªf
 *
ªf
;

23 
±r
;

24 
«me_±r
;

25 
u32
 
ôem_size
;

26 
u32
 
cur_off£t
 = 0;

27 
Àn
;

29 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

30 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
¶Ÿ
);

31 
cur_off£t
 < 
ôem_size
) {

32 
ªf
 = (
båfs_öode_ªf
 *)(
±r
 + 
cur_off£t
);

33 
Àn
 = 
	`båfs_öode_ªf_«me_Àn
(
Àaf
, 
ªf
);

34 
«me_±r
 = ()(
ªf
 + 1);

35 
cur_off£t
 +
Àn
 + (*
ªf
);

36 i‡(
Àn
 !
«me
->len)

38 i‡(
	`memcmp_exã¡_buf„r
(
Àaf
, 
«me
->«me, 
«me_±r
,

39 
«me
->
Àn
) == 0)

40  
ªf
;

42  
NULL
;

43 
	}
}

45 
båfs_öode_exåef
 *
	$båfs_föd_«me_ö_ext_backªf
(

46 
exã¡_buf„r
 *
Àaf
, 
¶Ÿ
, 
u64
 
ªf_obje˘id
,

47 c⁄° 
fs¸y±_°r
 *
«me
)

49 
båfs_öode_exåef
 *
exåef
;

50 
±r
;

51 
«me_±r
;

52 
u32
 
ôem_size
;

53 
u32
 
cur_off£t
 = 0;

54 
ªf_«me_Àn
;

56 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

57 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
¶Ÿ
);

65 
cur_off£t
 < 
ôem_size
) {

66 
exåef
 = (
båfs_öode_exåef
 *Ë(
±r
 + 
cur_off£t
);

67 
«me_±r
 = ()(&
exåef
->
«me
);

68 
ªf_«me_Àn
 = 
	`båfs_öode_exåef_«me_Àn
(
Àaf
, 
exåef
);

70 i‡(
ªf_«me_Àn
 =
«me
->
Àn
 &&

71 
	`båfs_öode_exåef_∑ª¡
(
Àaf
, 
exåef
Ë=
ªf_obje˘id
 &&

72 (
	`memcmp_exã¡_buf„r
(
Àaf
, 
«me
->«me, 
«me_±r
,

73 
«me
->
Àn
) == 0))

74  
exåef
;

76 
cur_off£t
 +
ªf_«me_Àn
 + (*
exåef
);

78  
NULL
;

79 
	}
}

82 
båfs_öode_exåef
 *

83 
	$båfs_lookup_öode_exåef
(
båfs_å™s_h™dÀ
 *
å™s
,

84 
båfs_roŸ
 *
roŸ
,

85 
båfs_∑th
 *
∑th
,

86 c⁄° 
fs¸y±_°r
 *
«me
,

87 
u64
 
öode_obje˘id
, u64 
ªf_obje˘id
, 
ös_Àn
,

88 
cow
)

90 
ªt
;

91 
båfs_key
 
key
;

93 
key
.
obje˘id
 = 
öode_obje˘id
;

94 
key
.
ty≥
 = 
BTRFS_INODE_EXTREF_KEY
;

95 
key
.
off£t
 = 
	`båfs_exåef_hash
(
ªf_obje˘id
, 
«me
->«me,Çame->
Àn
);

97 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, 
ös_Àn
, 
cow
);

98 i‡(
ªt
 < 0)

99  
	`ERR_PTR
(
ªt
);

100 i‡(
ªt
 > 0)

101  
NULL
;

102  
	`båfs_föd_«me_ö_ext_backªf
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

103 
ªf_obje˘id
, 
«me
);

105 
	}
}

107 
	$båfs_dñ_öode_exåef
(
båfs_å™s_h™dÀ
 *
å™s
,

108 
båfs_roŸ
 *
roŸ
,

109 c⁄° 
fs¸y±_°r
 *
«me
,

110 
u64
 
öode_obje˘id
, u64 
ªf_obje˘id
,

111 
u64
 *
ödex
)

113 
båfs_∑th
 *
∑th
;

114 
båfs_key
 
key
;

115 
båfs_öode_exåef
 *
exåef
;

116 
exã¡_buf„r
 *
Àaf
;

117 
ªt
;

118 
dñ_Àn
 = 
«me
->
Àn
 + (*
exåef
);

119 
±r
;

120 
ôem_°¨t
;

121 
u32
 
ôem_size
;

123 
key
.
obje˘id
 = 
öode_obje˘id
;

124 
key
.
ty≥
 = 
BTRFS_INODE_EXTREF_KEY
;

125 
key
.
off£t
 = 
	`båfs_exåef_hash
(
ªf_obje˘id
, 
«me
->«me,Çame->
Àn
);

127 
∑th
 = 
	`båfs_Æloc_∑th
();

128 i‡(!
∑th
)

129  -
ENOMEM
;

131 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

132 i‡(
ªt
 > 0)

133 
ªt
 = -
ENOENT
;

134 i‡(
ªt
 < 0)

135 
out
;

142 
exåef
 = 
	`båfs_föd_«me_ö_ext_backªf
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

143 
ªf_obje˘id
, 
«me
);

144 i‡(!
exåef
) {

145 
	`båfs_h™dÀ_fs_îr‹
(
roŸ
->
fs_öfo
, -
ENOENT
, 
NULL
);

146 
ªt
 = -
EROFS
;

147 
out
;

150 
Àaf
 = 
∑th
->
nodes
[0];

151 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

152 i‡(
ödex
)

153 *
ödex
 = 
	`båfs_öode_exåef_ödex
(
Àaf
, 
exåef
);

155 i‡(
dñ_Àn
 =
ôem_size
) {

160 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

161 
out
;

164 
±r
 = ()
exåef
;

165 
ôem_°¨t
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

167 
	`memmove_exã¡_buf„r
(
Àaf
, 
±r
,Öå + 
dñ_Àn
,

168 
ôem_size
 - (
±r
 + 
dñ_Àn
 - 
ôem_°¨t
));

170 
	`båfs_åunˇã_ôem
(
å™s
, 
∑th
, 
ôem_size
 - 
dñ_Àn
, 1);

172 
out
:

173 
	`båfs_‰ì_∑th
(
∑th
);

175  
ªt
;

176 
	}
}

178 
	$båfs_dñ_öode_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

179 
båfs_roŸ
 *
roŸ
, c⁄° 
fs¸y±_°r
 *
«me
,

180 
u64
 
öode_obje˘id
, u64 
ªf_obje˘id
, u64 *
ödex
)

182 
båfs_∑th
 *
∑th
;

183 
båfs_key
 
key
;

184 
båfs_öode_ªf
 *
ªf
;

185 
exã¡_buf„r
 *
Àaf
;

186 
±r
;

187 
ôem_°¨t
;

188 
u32
 
ôem_size
;

189 
u32
 
sub_ôem_Àn
;

190 
ªt
;

191 
£¨ch_ext_ªfs
 = 0;

192 
dñ_Àn
 = 
«me
->
Àn
 + (*
ªf
);

194 
key
.
obje˘id
 = 
öode_obje˘id
;

195 
key
.
off£t
 = 
ªf_obje˘id
;

196 
key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

198 
∑th
 = 
	`båfs_Æloc_∑th
();

199 i‡(!
∑th
)

200  -
ENOMEM
;

202 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

203 i‡(
ªt
 > 0) {

204 
ªt
 = -
ENOENT
;

205 
£¨ch_ext_ªfs
 = 1;

206 
out
;

207 } i‡(
ªt
 < 0) {

208 
out
;

211 
ªf
 = 
	`båfs_föd_«me_ö_backªf
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0], 
«me
);

212 i‡(!
ªf
) {

213 
ªt
 = -
ENOENT
;

214 
£¨ch_ext_ªfs
 = 1;

215 
out
;

217 
Àaf
 = 
∑th
->
nodes
[0];

218 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

220 i‡(
ödex
)

221 *
ödex
 = 
	`båfs_öode_ªf_ödex
(
Àaf
, 
ªf
);

223 i‡(
dñ_Àn
 =
ôem_size
) {

224 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

225 
out
;

227 
±r
 = ()
ªf
;

228 
sub_ôem_Àn
 = 
«me
->
Àn
 + (*
ªf
);

229 
ôem_°¨t
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

230 
	`memmove_exã¡_buf„r
(
Àaf
, 
±r
,Öå + 
sub_ôem_Àn
,

231 
ôem_size
 - (
±r
 + 
sub_ôem_Àn
 - 
ôem_°¨t
));

232 
	`båfs_åunˇã_ôem
(
å™s
, 
∑th
, 
ôem_size
 - 
sub_ôem_Àn
, 1);

233 
out
:

234 
	`båfs_‰ì_∑th
(
∑th
);

236 i‡(
£¨ch_ext_ªfs
) {

242  
	`båfs_dñ_öode_exåef
(
å™s
, 
roŸ
, 
«me
,

243 
öode_obje˘id
, 
ªf_obje˘id
, 
ödex
);

246  
ªt
;

247 
	}
}

254 
	$båfs_ö£π_öode_exåef
(
båfs_å™s_h™dÀ
 *
å™s
,

255 
båfs_roŸ
 *
roŸ
,

256 c⁄° 
fs¸y±_°r
 *
«me
,

257 
u64
 
öode_obje˘id
, u64 
ªf_obje˘id
,

258 
u64
 
ödex
)

260 
båfs_öode_exåef
 *
exåef
;

261 
ªt
;

262 
ös_Àn
 = 
«me
->
Àn
 + (*
exåef
);

263 
±r
;

264 
båfs_∑th
 *
∑th
;

265 
båfs_key
 
key
;

266 
exã¡_buf„r
 *
Àaf
;

268 
key
.
obje˘id
 = 
öode_obje˘id
;

269 
key
.
ty≥
 = 
BTRFS_INODE_EXTREF_KEY
;

270 
key
.
off£t
 = 
	`båfs_exåef_hash
(
ªf_obje˘id
, 
«me
->«me,Çame->
Àn
);

272 
∑th
 = 
	`båfs_Æloc_∑th
();

273 i‡(!
∑th
)

274  -
ENOMEM
;

276 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
,

277 
ös_Àn
);

278 i‡(
ªt
 =-
EEXIST
) {

279 i‡(
	`båfs_föd_«me_ö_ext_backªf
(
∑th
->
nodes
[0],

280 
∑th
->
¶Ÿs
[0],

281 
ªf_obje˘id
,

282 
«me
))

283 
out
;

285 
	`båfs_exãnd_ôem
(
å™s
, 
∑th
, 
ös_Àn
);

286 
ªt
 = 0;

288 i‡(
ªt
 < 0)

289 
out
;

291 
Àaf
 = 
∑th
->
nodes
[0];

292 
±r
 = ()
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], );

293 
±r
 +
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]Ë- 
ös_Àn
;

294 
exåef
 = (
båfs_öode_exåef
 *)
±r
;

296 
	`båfs_£t_öode_exåef_«me_Àn
(
∑th
->
nodes
[0], 
exåef
, 
«me
->
Àn
);

297 
	`båfs_£t_öode_exåef_ödex
(
∑th
->
nodes
[0], 
exåef
, 
ödex
);

298 
	`båfs_£t_öode_exåef_∑ª¡
(
∑th
->
nodes
[0], 
exåef
, 
ªf_obje˘id
);

300 
±r
 = ()&
exåef
->
«me
;

301 
	`wrôe_exã¡_buf„r
(
∑th
->
nodes
[0], 
«me
->«me, 
±r
,Çame->
Àn
);

302 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑th
->
nodes
[0]);

304 
out
:

305 
	`båfs_‰ì_∑th
(
∑th
);

306  
ªt
;

307 
	}
}

310 
	$båfs_ö£π_öode_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

311 
båfs_roŸ
 *
roŸ
, c⁄° 
fs¸y±_°r
 *
«me
,

312 
u64
 
öode_obje˘id
, u64 
ªf_obje˘id
, u64 
ödex
)

314 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

315 
båfs_∑th
 *
∑th
;

316 
båfs_key
 
key
;

317 
båfs_öode_ªf
 *
ªf
;

318 
±r
;

319 
ªt
;

320 
ös_Àn
 = 
«me
->
Àn
 + (*
ªf
);

322 
key
.
obje˘id
 = 
öode_obje˘id
;

323 
key
.
off£t
 = 
ªf_obje˘id
;

324 
key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

326 
∑th
 = 
	`båfs_Æloc_∑th
();

327 i‡(!
∑th
)

328  -
ENOMEM
;

330 
∑th
->
skù_ªÀa£_⁄_îr‹
 = 1;

331 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
,

332 
ös_Àn
);

333 i‡(
ªt
 =-
EEXIST
) {

334 
u32
 
ﬁd_size
;

335 
ªf
 = 
	`båfs_föd_«me_ö_backªf
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

336 
«me
);

337 i‡(
ªf
)

338 
out
;

340 
ﬁd_size
 = 
	`båfs_ôem_size
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0]);

341 
	`båfs_exãnd_ôem
(
å™s
, 
∑th
, 
ös_Àn
);

342 
ªf
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

343 
båfs_öode_ªf
);

344 
ªf
 = (
båfs_öode_ªf
 *)((Ïe‡+ 
ﬁd_size
);

345 
	`båfs_£t_öode_ªf_«me_Àn
(
∑th
->
nodes
[0], 
ªf
, 
«me
->
Àn
);

346 
	`båfs_£t_öode_ªf_ödex
(
∑th
->
nodes
[0], 
ªf
, 
ödex
);

347 
±r
 = ()(
ªf
 + 1);

348 
ªt
 = 0;

349 } i‡(
ªt
 < 0) {

350 i‡(
ªt
 =-
EOVERFLOW
) {

351 i‡(
	`båfs_föd_«me_ö_backªf
(
∑th
->
nodes
[0],

352 
∑th
->
¶Ÿs
[0],

353 
«me
))

354 
ªt
 = -
EEXIST
;

356 
ªt
 = -
EMLINK
;

358 
out
;

360 
ªf
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

361 
båfs_öode_ªf
);

362 
	`båfs_£t_öode_ªf_«me_Àn
(
∑th
->
nodes
[0], 
ªf
, 
«me
->
Àn
);

363 
	`båfs_£t_öode_ªf_ödex
(
∑th
->
nodes
[0], 
ªf
, 
ödex
);

364 
±r
 = ()(
ªf
 + 1);

366 
	`wrôe_exã¡_buf„r
(
∑th
->
nodes
[0], 
«me
->«me, 
±r
,Çame->
Àn
);

367 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑th
->
nodes
[0]);

369 
out
:

370 
	`båfs_‰ì_∑th
(
∑th
);

372 i‡(
ªt
 =-
EMLINK
) {

373 
båfs_su≥r_block
 *
disk_su≥r
 = 
fs_öfo
->
su≥r_c›y
;

376 i‡(
	`båfs_su≥r_öcom∑t_Êags
(
disk_su≥r
)

377 & 
BTRFS_FEATURE_INCOMPAT_EXTENDED_IREF
)

378 
ªt
 = 
	`båfs_ö£π_öode_exåef
(
å™s
, 
roŸ
, 
«me
,

379 
öode_obje˘id
,

380 
ªf_obje˘id
, 
ödex
);

383  
ªt
;

384 
	}
}

386 
	$båfs_ö£π_em±y_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

387 
båfs_roŸ
 *
roŸ
,

388 
båfs_∑th
 *
∑th
, 
u64
 
obje˘id
)

390 
båfs_key
 
key
;

391 
ªt
;

392 
key
.
obje˘id
 = objectid;

393 
key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

394 
key
.
off£t
 = 0;

396 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
,

397 (
båfs_öode_ôem
));

398  
ªt
;

399 
	}
}

401 
	$båfs_lookup_öode
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ


402 *
roŸ
, 
båfs_∑th
 *
∑th
,

403 
båfs_key
 *
loˇti⁄
, 
mod
)

405 
ös_Àn
 = 
mod
 < 0 ? -1 : 0;

406 
cow
 = 
mod
 != 0;

407 
ªt
;

408 
¶Ÿ
;

409 
exã¡_buf„r
 *
Àaf
;

410 
båfs_key
 
found_key
;

412 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, 
loˇti⁄
, 
∑th
, 
ös_Àn
, 
cow
);

413 i‡(
ªt
 > 0 && 
loˇti⁄
->
ty≥
 =
BTRFS_ROOT_ITEM_KEY
 &&

414 
loˇti⁄
->
off£t
 =(
u64
)-1 && 
∑th
->
¶Ÿs
[0] != 0) {

415 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0] - 1;

416 
Àaf
 = 
∑th
->
nodes
[0];

417 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
¶Ÿ
);

418 i‡(
found_key
.
obje˘id
 =
loˇti⁄
->objectid &&

419 
found_key
.
ty≥
 =
loˇti⁄
->type) {

420 
∑th
->
¶Ÿs
[0]--;

424  
ªt
;

425 
	}
}

427 
ölöe
 
	$båfs_åa˚_åunˇã
(
båfs_öode
 *
öode
,

428 
exã¡_buf„r
 *
Àaf
,

429 
båfs_fûe_exã¡_ôem
 *
fi
,

430 
u64
 
off£t
, 
exã¡_ty≥
, 
¶Ÿ
)

432 i‡(!
öode
)

434 i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
)

435 
	`åa˚_båfs_åunˇã_show_fi_ölöe
(
öode
, 
Àaf
, 
fi
, 
¶Ÿ
,

436 
off£t
);

438 
	`åa˚_båfs_åunˇã_show_fi_ªguœr
(
öode
, 
Àaf
, 
fi
, 
off£t
);

439 
	}
}

459 
	$båfs_åunˇã_öode_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

460 
båfs_roŸ
 *
roŸ
,

461 
båfs_åunˇã_c⁄åﬁ
 *
c⁄åﬁ
)

463 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

464 
båfs_∑th
 *
∑th
;

465 
exã¡_buf„r
 *
Àaf
;

466 
båfs_fûe_exã¡_ôem
 *
fi
;

467 
båfs_key
 
key
;

468 
båfs_key
 
found_key
;

469 
u64
 
√w_size
 = 
c⁄åﬁ
->new_size;

470 
u64
 
exã¡_num_byãs
 = 0;

471 
u64
 
exã¡_off£t
 = 0;

472 
u64
 
ôem_íd
 = 0;

473 
u32
 
found_ty≥
 = (
u8
)-1;

474 
dñ_ôem
;

475 
≥ndög_dñ_ƒ
 = 0;

476 
≥ndög_dñ_¶Ÿ
 = 0;

477 
exã¡_ty≥
 = -1;

478 
ªt
;

479 
u64
 
byãs_dñëed
 = 0;

480 
boﬁ
 
be_ni˚
 = 
Ál£
;

482 
	`ASSERT
(
c⁄åﬁ
->
öode
 || !c⁄åﬁ->
˛ór_exã¡_ønge
);

483 
	`ASSERT
(
√w_size
 =0 || 
c⁄åﬁ
->
mö_ty≥
 =
BTRFS_EXTENT_DATA_KEY
);

485 
c⁄åﬁ
->
œ°_size
 = 
√w_size
;

486 
c⁄åﬁ
->
sub_byãs
 = 0;

492 i‡(
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
))

493 
be_ni˚
 = 
åue
;

495 
∑th
 = 
	`båfs_Æloc_∑th
();

496 i‡(!
∑th
)

497  -
ENOMEM
;

498 
∑th
->
ªada
 = 
READA_BACK
;

500 
key
.
obje˘id
 = 
c⁄åﬁ
->
öo
;

501 
key
.
off£t
 = (
u64
)-1;

502 
key
.
ty≥
 = (
u8
)-1;

504 
£¨ch_agaö
:

510 i‡(
be_ni˚
 && 
byãs_dñëed
 > 
SZ_32M
 &&

511 
	`båfs_should_íd_å™ß˘i⁄
(
å™s
)) {

512 
ªt
 = -
EAGAIN
;

513 
out
;

516 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

517 i‡(
ªt
 < 0)

518 
out
;

520 i‡(
ªt
 > 0) {

521 
ªt
 = 0;

523 i‡(
∑th
->
¶Ÿs
[0] == 0)

524 
out
;

525 
∑th
->
¶Ÿs
[0]--;

529 
u64
 
˛ór_°¨t
 = 0, 
˛ór_Àn
 = 0, 
exã¡_°¨t
 = 0;

530 
boﬁ
 
ªfûl_dñayed_ªfs_rsv
 = 
Ál£
;

532 
fi
 = 
NULL
;

533 
Àaf
 = 
∑th
->
nodes
[0];

534 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0]);

535 
found_ty≥
 = 
found_key
.
ty≥
;

537 i‡(
found_key
.
obje˘id
 !
c⁄åﬁ
->
öo
)

540 i‡(
found_ty≥
 < 
c⁄åﬁ
->
mö_ty≥
)

543 
ôem_íd
 = 
found_key
.
off£t
;

544 i‡(
found_ty≥
 =
BTRFS_EXTENT_DATA_KEY
) {

545 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

546 
båfs_fûe_exã¡_ôem
);

547 
exã¡_ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
fi
);

548 i‡(
exã¡_ty≥
 !
BTRFS_FILE_EXTENT_INLINE
)

549 
ôem_íd
 +=

550 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
fi
);

551 i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
)

552 
ôem_íd
 +
	`båfs_fûe_exã¡_øm_byãs
(
Àaf
, 
fi
);

554 
	`båfs_åa˚_åunˇã
(
c⁄åﬁ
->
öode
, 
Àaf
, 
fi
,

555 
found_key
.
off£t
, 
exã¡_ty≥
,

556 
∑th
->
¶Ÿs
[0]);

557 
ôem_íd
--;

559 i‡(
found_ty≥
 > 
c⁄åﬁ
->
mö_ty≥
) {

560 
dñ_ôem
 = 1;

562 i‡(
ôem_íd
 < 
√w_size
)

564 i‡(
found_key
.
off£t
 >
√w_size
)

565 
dñ_ôem
 = 1;

567 
dñ_ôem
 = 0;

571 i‡(
found_ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

572 
dñëe
;

574 
c⁄åﬁ
->
exã¡s_found
++;

576 i‡(
exã¡_ty≥
 !
BTRFS_FILE_EXTENT_INLINE
) {

577 
u64
 
num_dec
;

579 
˛ór_°¨t
 = 
found_key
.
off£t
;

580 
exã¡_°¨t
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
fi
);

581 i‡(!
dñ_ôem
) {

582 
u64
 
‹ig_num_byãs
 =

583 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
fi
);

584 
exã¡_num_byãs
 = 
	`ALIGN
(
√w_size
 -

585 
found_key
.
off£t
,

586 
fs_öfo
->
£˘‹size
);

587 
˛ór_°¨t
 = 
	`ALIGN
(
√w_size
, 
fs_öfo
->
£˘‹size
);

589 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
fi
,

590 
exã¡_num_byãs
);

591 
num_dec
 = (
‹ig_num_byãs
 - 
exã¡_num_byãs
);

592 i‡(
exã¡_°¨t
 != 0)

593 
c⁄åﬁ
->
sub_byãs
 +
num_dec
;

594 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

596 
exã¡_num_byãs
 =

597 
	`båfs_fûe_exã¡_disk_num_byãs
(
Àaf
, 
fi
);

598 
exã¡_off£t
 = 
found_key
.
off£t
 -

599 
	`båfs_fûe_exã¡_off£t
(
Àaf
, 
fi
);

602 
num_dec
 = 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
fi
);

603 i‡(
exã¡_°¨t
 != 0)

604 
c⁄åﬁ
->
sub_byãs
 +
num_dec
;

606 
˛ór_Àn
 = 
num_dec
;

607 } i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
) {

612 i‡(!
dñ_ôem
 &&

613 
	`båfs_fûe_exã¡_í¸y±i⁄
(
Àaf
, 
fi
) == 0 &&

614 
	`båfs_fûe_exã¡_Ÿhî_ícodög
(
Àaf
, 
fi
) == 0 &&

615 
	`båfs_fûe_exã¡_com¥essi⁄
(
Àaf
, 
fi
) == 0) {

616 
u32
 
size
 = (u32)(
√w_size
 - 
found_key
.
off£t
);

618 
	`båfs_£t_fûe_exã¡_øm_byãs
(
Àaf
, 
fi
, 
size
);

619 
size
 = 
	`båfs_fûe_exã¡_ˇlc_ölöe_size
(size);

620 
	`båfs_åunˇã_ôem
(
å™s
, 
∑th
, 
size
, 1);

621 } i‡(!
dñ_ôem
) {

626 
ªt
 = 
BTRFS_NEED_TRUNCATE_BLOCK
;

634 
˛ór_Àn
 = 
fs_öfo
->
£˘‹size
;

637 
c⁄åﬁ
->
sub_byãs
 +
ôem_íd
 + 1 - 
√w_size
;

639 
dñëe
:

645 i‡(
c⁄åﬁ
->
˛ór_exã¡_ønge
) {

646 
ªt
 = 
	`båfs_öode_˛ór_fûe_exã¡_ønge
(
c⁄åﬁ
->
öode
,

647 
˛ór_°¨t
, 
˛ór_Àn
);

648 i‡(
ªt
) {

649 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

654 i‡(
dñ_ôem
) {

655 
	`ASSERT
(!
≥ndög_dñ_ƒ
 ||

656 ((
∑th
->
¶Ÿs
[0] + 1Ë=
≥ndög_dñ_¶Ÿ
));

658 
c⁄åﬁ
->
œ°_size
 = 
found_key
.
off£t
;

659 i‡(!
≥ndög_dñ_ƒ
) {

661 
≥ndög_dñ_¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

662 
≥ndög_dñ_ƒ
 = 1;

663 } i‡(
∑th
->
¶Ÿs
[0] + 1 =
≥ndög_dñ_¶Ÿ
) {

665 
≥ndög_dñ_ƒ
++;

666 
≥ndög_dñ_¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

669 
c⁄åﬁ
->
œ°_size
 = 
√w_size
;

673 i‡(
dñ_ôem
 && 
exã¡_°¨t
 !0 && !
c⁄åﬁ
->
skù_ªf_upd©es
) {

674 
båfs_ªf
 
ªf
 = { 0 };

676 
byãs_dñëed
 +
exã¡_num_byãs
;

678 
	`båfs_öô_gíîic_ªf
(&
ªf
, 
BTRFS_DROP_DELAYED_REF
,

679 
exã¡_°¨t
, 
exã¡_num_byãs
, 0);

680 
	`båfs_öô_d©a_ªf
(&
ªf
, 
	`båfs_hódî_ow√r
(
Àaf
),

681 
c⁄åﬁ
->
öo
, 
exã¡_off£t
,

682 
roŸ
->
roŸ_key
.
obje˘id
, 
Ál£
);

683 
ªt
 = 
	`båfs_‰ì_exã¡
(
å™s
, &
ªf
);

684 i‡(
ªt
) {

685 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

688 i‡(
be_ni˚
 && 
	`båfs_check_•a˚_f‹_dñayed_ªfs
(
fs_öfo
))

689 
ªfûl_dñayed_ªfs_rsv
 = 
åue
;

692 i‡(
found_ty≥
 =
BTRFS_INODE_ITEM_KEY
)

695 i‡(
∑th
->
¶Ÿs
[0] == 0 ||

696 
∑th
->
¶Ÿs
[0] !
≥ndög_dñ_¶Ÿ
 ||

697 
ªfûl_dñayed_ªfs_rsv
) {

698 i‡(
≥ndög_dñ_ƒ
) {

699 
ªt
 = 
	`båfs_dñ_ôems
(
å™s
, 
roŸ
, 
∑th
,

700 
≥ndög_dñ_¶Ÿ
,

701 
≥ndög_dñ_ƒ
);

702 i‡(
ªt
) {

703 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

706 
≥ndög_dñ_ƒ
 = 0;

708 
	`båfs_ªÀa£_∑th
(
∑th
);

720 i‡(
ªfûl_dñayed_ªfs_rsv
) {

721 
ªt
 = 
	`båfs_dñayed_ªfs_rsv_ªfûl
(
fs_öfo
,

722 
BTRFS_RESERVE_NO_FLUSH
);

723 i‡(
ªt
) {

724 
ªt
 = -
EAGAIN
;

728 
£¨ch_agaö
;

730 
∑th
->
¶Ÿs
[0]--;

733 
out
:

734 i‡(
ªt
 >0 && 
≥ndög_dñ_ƒ
) {

735 
îr
;

737 
îr
 = 
	`båfs_dñ_ôems
(
å™s
, 
roŸ
, 
∑th
, 
≥ndög_dñ_¶Ÿ
,

738 
≥ndög_dñ_ƒ
);

739 i‡(
îr
) {

740 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
îr
);

741 
ªt
 = 
îr
;

745 
	`ASSERT
(
c⁄åﬁ
->
œ°_size
 >
√w_size
);

746 i‡(!
ªt
 && 
c⁄åﬁ
->
œ°_size
 > 
√w_size
)

747 
c⁄åﬁ
->
œ°_size
 = 
√w_size
;

749 
	`båfs_‰ì_∑th
(
∑th
);

750  
ªt
;

751 
	}
}

	@inode-item.h

3 #i‚de‡
BTRFS_INODE_ITEM_H


4 
	#BTRFS_INODE_ITEM_H


	)

6 
	~<löux/ty≥s.h
>

8 
	gbåfs_å™s_h™dÀ
;

9 
	gbåfs_roŸ
;

10 
	gbåfs_∑th
;

11 
	gbåfs_key
;

12 
	gbåfs_öode_exåef
;

13 
	gbåfs_öode
;

14 
	gexã¡_buf„r
;

20 
	#BTRFS_NEED_TRUNCATE_BLOCK
 1

	)

22 
	sbåfs_åunˇã_c⁄åﬁ
 {

27 
båfs_öode
 *
	möode
;

30 
u64
 
	m√w_size
;

33 
u64
 
	mexã¡s_found
;

36 
u64
 
	mœ°_size
;

39 
u64
 
	msub_byãs
;

42 
u64
 
	möo
;

48 
u32
 
	mmö_ty≥
;

54 
boﬁ
 
	mskù_ªf_upd©es
;

60 
boﬁ
 
	m˛ór_exã¡_ønge
;

67 
ölöe
 
u64
 
	$båfs_öode_comböe_Êags
(
u32
 
Êags
, u32 
ro_Êags
)

69  (
Êags
 | ((
u64
)
ro_Êags
 << 32));

70 
	}
}

72 
ölöe
 
	$båfs_öode_•lô_Êags
(
u64
 
öode_ôem_Êags
,

73 
u32
 *
Êags
, u32 *
ro_Êags
)

75 *
Êags
 = (
u32
)
öode_ôem_Êags
;

76 *
ro_Êags
 = (
u32
)(
öode_ôem_Êags
 >> 32);

77 
	}
}

79 
båfs_åunˇã_öode_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

80 
båfs_roŸ
 *
roŸ
,

81 
båfs_åunˇã_c⁄åﬁ
 *
c⁄åﬁ
);

82 
båfs_ö£π_öode_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

83 
båfs_roŸ
 *
roŸ
, c⁄° 
fs¸y±_°r
 *
«me
,

84 
u64
 
öode_obje˘id
, u64 
ªf_obje˘id
, u64 
ödex
);

85 
båfs_dñ_öode_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

86 
båfs_roŸ
 *
roŸ
, c⁄° 
fs¸y±_°r
 *
«me
,

87 
u64
 
öode_obje˘id
, u64 
ªf_obje˘id
, u64 *
ödex
);

88 
båfs_ö£π_em±y_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

89 
båfs_roŸ
 *
roŸ
,

90 
båfs_∑th
 *
∑th
, 
u64
 
obje˘id
);

91 
båfs_lookup_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

92 
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
,

93 
båfs_key
 *
loˇti⁄
, 
mod
);

95 
båfs_öode_exåef
 *
båfs_lookup_öode_exåef
(

96 
båfs_å™s_h™dÀ
 *
å™s
,

97 
båfs_roŸ
 *
roŸ
,

98 
båfs_∑th
 *
∑th
,

99 c⁄° 
fs¸y±_°r
 *
«me
,

100 
u64
 
öode_obje˘id
, u64 
ªf_obje˘id
, 
ös_Àn
,

101 
cow
);

103 
båfs_öode_ªf
 *
båfs_föd_«me_ö_backªf
(
exã¡_buf„r
 *
Àaf
,

104 
¶Ÿ
,

105 c⁄° 
fs¸y±_°r
 *
«me
);

106 
båfs_öode_exåef
 *
båfs_föd_«me_ö_ext_backªf
(

107 
exã¡_buf„r
 *
Àaf
, 
¶Ÿ
, 
u64
 
ªf_obje˘id
,

108 c⁄° 
fs¸y±_°r
 *
«me
);

	@inode.c

6 
	~<¸y±o/hash.h
>

7 
	~<löux/kî√l.h
>

8 
	~<löux/bio.h
>

9 
	~<löux/blk-cgroup.h
>

10 
	~<löux/fûe.h
>

11 
	~<löux/fs.h
>

12 
	~<löux/∑gem≠.h
>

13 
	~<löux/highmem.h
>

14 
	~<löux/time.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/°rög.h
>

17 
	~<löux/backög-dev.h
>

18 
	~<löux/wrôeback.h
>

19 
	~<löux/com∑t.h
>

20 
	~<löux/x©å.h
>

21 
	~<löux/posix_a˛.h
>

22 
	~<löux/ÁŒoc.h
>

23 
	~<löux/¶ab.h
>

24 
	~<löux/øãlimô.h
>

25 
	~<löux/båfs.h
>

26 
	~<löux/blkdev.h
>

27 
	~<löux/posix_a˛_x©å.h
>

28 
	~<löux/uio.h
>

29 
	~<löux/magic.h
>

30 
	~<löux/ivîsi⁄.h
>

31 
	~<löux/sw≠.h
>

32 
	~<löux/migøã.h
>

33 
	~<löux/sched/mm.h
>

34 
	~<löux/iom≠.h
>

35 
	~<asm/u«lig√d.h
>

36 
	~<löux/fsvîôy.h
>

37 
	~<löux/«mei.h
>

38 
	~"misc.h
"

39 
	~"˘ªe.h
"

40 
	~"disk-io.h
"

41 
	~"å™ß˘i⁄.h
"

42 
	~"båfs_öode.h
"

43 
	~"¥öt-åì.h
"

44 
	~"‹dîed-d©a.h
"

45 
	~"x©å.h
"

46 
	~"åì-log.h
"

47 
	~"bio.h
"

48 
	~"com¥essi⁄.h
"

49 
	~"lockög.h
"

50 
	~"‰ì-•a˚-ˇche.h
"

51 
	~"¥›s.h
"

52 
	~"qgroup.h
"

53 
	~"dñÆloc-•a˚.h
"

54 
	~"block-group.h
"

55 
	~"•a˚-öfo.h
"

56 
	~"z⁄ed.h
"

57 
	~"sub∑ge.h
"

58 
	~"öode-ôem.h
"

59 
	~"fs.h
"

60 
	~"ac˚ss‹s.h
"

61 
	~"exã¡-åì.h
"

62 
	~"roŸ-åì.h
"

63 
	~"de‰ag.h
"

64 
	~"dú-ôem.h
"

65 
	~"fûe-ôem.h
"

66 
	~"uuid-åì.h
"

67 
	~"io˘l.h
"

68 
	~"fûe.h
"

69 
	~"a˛.h
"

70 
	~"ªloˇti⁄.h
"

71 
	~"vîôy.h
"

72 
	~"su≥r.h
"

73 
	~"‹ph™.h
"

74 
	~"backªf.h
"

75 
	~<löux/ty≥s.h
>

77 
båfs_fs_öfo
 *
globÆ_fs_öfo_li°
[
BTRFS_SUPER_INFO_COUNT
];

78 
©omic_t
 
	gglobÆ_¸óã_cou¡
 = 
ATOMIC_INIT
(0);

80 
	sbåfs_igë_¨gs
 {

81 
u64
 
	möo
;

82 
båfs_roŸ
 *
	mroŸ
;

85 
	sbåfs_dio_d©a
 {

86 
ssize_t
 
	msubmôãd
;

87 
exã¡_ch™ge£t
 *
	md©a_ª£rved
;

88 
båfs_‹dîed_exã¡
 *
	m‹dîed
;

89 
boﬁ
 
	md©a_•a˚_ª£rved
;

90 
boﬁ
 
	mnocow_d⁄e
;

93 
	sbåfs_dio_¥iv©e
 {

95 
u64
 
	mfûe_off£t
;

96 
u32
 
	mbyãs
;

99 
båfs_bio
 
	mbbio
;

102 
bio_£t
 
	gbåfs_dio_bio£t
;

104 
	sbåfs_ª«me_˘x
 {

106 
u64
 
	mödex
;

113 
	sd©a_ªloc_w¨n
 {

114 
båfs_∑th
 
	m∑th
;

115 
båfs_fs_öfo
 *
	mfs_öfo
;

116 
u64
 
	mexã¡_ôem_size
;

117 
u64
 
	mlogiˇl
;

118 
	mmúr‹_num
;

121 c⁄° 
öode_›î©i⁄s
 
	gbåfs_dú_öode_›î©i⁄s
;

122 c⁄° 
öode_›î©i⁄s
 
	gbåfs_symlök_öode_›î©i⁄s
;

123 c⁄° 
öode_›î©i⁄s
 
	gbåfs_•ecül_öode_›î©i⁄s
;

124 c⁄° 
öode_›î©i⁄s
 
	gbåfs_fûe_öode_›î©i⁄s
;

125 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gbåfs_a›s
;

126 c⁄° 
fûe_›î©i⁄s
 
	gbåfs_dú_fûe_›î©i⁄s
;

128 
kmem_ˇche
 *
	gbåfs_öode_ˇchï
;

130 
båfs_£tsize
(
öode
 *öode, 
üâr
 *
©å
);

131 
båfs_åunˇã
(
båfs_öode
 *
öode
, 
boﬁ
 
skù_wrôeback
);

133 
noölöe
 
run_dñÆloc_cow
(
båfs_öode
 *
öode
,

134 
∑ge
 *
locked_∑ge
, 
u64
 
°¨t
,

135 
u64
 
íd
, 
wrôeback_c⁄åﬁ
 *
wbc
,

136 
boﬁ
 
∑ges_dúty
);

137 
exã¡_m≠
 *
¸óã_io_em
(
båfs_öode
 *
öode
, 
u64
 
°¨t
,

138 
u64
 
Àn
, u64 
‹ig_°¨t
, u64 
block_°¨t
,

139 
u64
 
block_Àn
, u64 
‹ig_block_Àn
,

140 
u64
 
øm_byãs
, 
com¥ess_ty≥
,

141 
ty≥
);

143 
	$d©a_ªloc_¥öt_w¨nög_öode
(
u64
 
öum
, u64 
off£t
, u64 
num_byãs
,

144 
u64
 
roŸ
, *
w¨n_˘x
)

146 
d©a_ªloc_w¨n
 *
w¨n
 = 
w¨n_˘x
;

147 
båfs_fs_öfo
 *
fs_öfo
 = 
w¨n
->fs_info;

148 
exã¡_buf„r
 *
eb
;

149 
båfs_öode_ôem
 *
öode_ôem
;

150 
öode_fs_∑ths
 *
ù©h
 = 
NULL
;

151 
båfs_roŸ
 *
loˇl_roŸ
;

152 
båfs_key
 
key
;

153 
nofs_Êag
;

154 
u32
 
∆ök
;

155 
ªt
;

157 
loˇl_roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
roŸ
, 
åue
);

158 i‡(
	`IS_ERR
(
loˇl_roŸ
)) {

159 
ªt
 = 
	`PTR_ERR
(
loˇl_roŸ
);

160 
îr
;

164 
key
.
obje˘id
 = 
öum
;

165 
key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

166 
key
.
off£t
 = 0;

168 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
loˇl_roŸ
, &
key
, &
w¨n
->
∑th
, 0, 0);

169 i‡(
ªt
) {

170 
	`båfs_put_roŸ
(
loˇl_roŸ
);

171 
	`båfs_ªÀa£_∑th
(&
w¨n
->
∑th
);

172 
îr
;

175 
eb
 = 
w¨n
->
∑th
.
nodes
[0];

176 
öode_ôem
 = 
	`båfs_ôem_±r
(
eb
, 
w¨n
->
∑th
.
¶Ÿs
[0], 
båfs_öode_ôem
);

177 
∆ök
 = 
	`båfs_öode_∆ök
(
eb
, 
öode_ôem
);

178 
	`båfs_ªÀa£_∑th
(&
w¨n
->
∑th
);

180 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

181 
ù©h
 = 
	`öô_ù©h
(4096, 
loˇl_roŸ
, &
w¨n
->
∑th
);

182 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

183 i‡(
	`IS_ERR
(
ù©h
)) {

184 
	`båfs_put_roŸ
(
loˇl_roŸ
);

185 
ªt
 = 
	`PTR_ERR
(
ù©h
);

186 
ù©h
 = 
NULL
;

191 
	`båfs_w¨n
(
fs_öfo
,

193 
w¨n
->
logiˇl
, w¨n->
múr‹_num
, 
roŸ
, 
öum
, 
off£t
);

194  
ªt
;

196 
ªt
 = 
	`∑ths_‰om_öode
(
öum
, 
ù©h
);

197 i‡(
ªt
 < 0)

198 
îr
;

204 
i
 = 0; i < 
ù©h
->
f•©h
->
ñem_˙t
; i++) {

205 
	`båfs_w¨n
(
fs_öfo
,

207 
w¨n
->
logiˇl
, w¨n->
múr‹_num
, 
roŸ
, 
öum
, 
off£t
,

208 
fs_öfo
->
£˘‹size
, 
∆ök
,

209 (*)()
ù©h
->
f•©h
->
vÆ
[
i
]);

212 
	`båfs_put_roŸ
(
loˇl_roŸ
);

213 
	`‰ì_ù©h
(
ù©h
);

216 
îr
:

217 
	`båfs_w¨n
(
fs_öfo
,

219 
w¨n
->
logiˇl
, w¨n->
múr‹_num
, 
roŸ
, 
öum
, 
off£t
, 
ªt
);

221 
	`‰ì_ù©h
(
ù©h
);

222  
ªt
;

223 
	}
}

231 
	$¥öt_d©a_ªloc_îr‹
(c⁄° 
båfs_öode
 *
öode
, 
u64
 
fûe_off
,

232 c⁄° 
u8
 *
csum
, c⁄° u8 *
csum_ex≥˘ed
,

233 
múr‹_num
)

235 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

236 
båfs_∑th
 
∑th
 = { 0 };

237 
båfs_key
 
found_key
 = { 0 };

238 
exã¡_buf„r
 *
eb
;

239 
båfs_exã¡_ôem
 *
ei
;

240 c⁄° 
u32
 
csum_size
 = 
fs_öfo
->csum_size;

241 
u64
 
logiˇl
;

242 
u64
 
Êags
;

243 
u32
 
ôem_size
;

244 
ªt
;

246 
	`muãx_lock
(&
fs_öfo
->
ªloc_muãx
);

247 
logiˇl
 = 
	`båfs_gë_ªloc_bg_byãƒ
(
fs_öfo
);

248 
	`muãx_u∆ock
(&
fs_öfo
->
ªloc_muãx
);

250 i‡(
logiˇl
 =
U64_MAX
) {

251 
	`båfs_w¨n_æ
(
fs_öfo
, "has dataÑelocÅree butÇoÑunningÑelocation");

252 
	`båfs_w¨n_æ
(
fs_öfo
,

253 "csum faûedÑoŸ %Œd inÿ%Œu of‡%Œu csum " 
CSUM_FMT
 "Éxpected csum " CSUM_FMT " mirror %d",

254 
öode
->
roŸ
->
roŸ_key
.
obje˘id
, 
	`båfs_öo
(öode), 
fûe_off
,

255 
	`CSUM_FMT_VALUE
(
csum_size
, 
csum
),

256 
	`CSUM_FMT_VALUE
(
csum_size
, 
csum_ex≥˘ed
),

257 
múr‹_num
);

261 
logiˇl
 +
fûe_off
;

262 
	`båfs_w¨n_æ
(
fs_öfo
,

263 "csum faûedÑoŸ %Œd inÿ%Œu of‡%ŒuÜogiˇ»%Œu csum " 
CSUM_FMT
 "Éxpected csum " CSUM_FMT " mirror %d",

264 
öode
->
roŸ
->
roŸ_key
.
obje˘id
,

265 
	`båfs_öo
(
öode
), 
fûe_off
, 
logiˇl
,

266 
	`CSUM_FMT_VALUE
(
csum_size
, 
csum
),

267 
	`CSUM_FMT_VALUE
(
csum_size
, 
csum_ex≥˘ed
),

268 
múr‹_num
);

270 
ªt
 = 
	`exã¡_‰om_logiˇl
(
fs_öfo
, 
logiˇl
, &
∑th
, &
found_key
, &
Êags
);

271 i‡(
ªt
 < 0) {

272 
	`båfs_îr_æ
(
fs_öfo
, "failedÅoÜookupÉxtent item forÜogical %llu: %d",

273 
logiˇl
, 
ªt
);

276 
eb
 = 
∑th
.
nodes
[0];

277 
ei
 = 
	`båfs_ôem_±r
(
eb
, 
∑th
.
¶Ÿs
[0], 
båfs_exã¡_ôem
);

278 
ôem_size
 = 
	`båfs_ôem_size
(
eb
, 
∑th
.
¶Ÿs
[0]);

279 i‡(
Êags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

280 
±r
 = 0;

281 
u64
 
ªf_roŸ
;

282 
u8
 
ªf_Àvñ
;

284 
åue
) {

285 
ªt
 = 
	`åì_backªf_f‹_exã¡
(&
±r
, 
eb
, &
found_key
, 
ei
,

286 
ôem_size
, &
ªf_roŸ
,

287 &
ªf_Àvñ
);

288 i‡(
ªt
 < 0) {

289 
	`båfs_w¨n_æ
(
fs_öfo
,

291 
logiˇl
, 
ªt
);

294 i‡(
ªt
 > 0)

297 
	`båfs_w¨n_æ
(
fs_öfo
,

299 
logiˇl
, 
múr‹_num
,

300 (
ªf_Àvñ
 ? "node" : "leaf"),

301 
ªf_Àvñ
, 
ªf_roŸ
);

303 
	`båfs_ªÀa£_∑th
(&
∑th
);

305 
båfs_backªf_wÆk_˘x
 
˘x
 = { 0 };

306 
d©a_ªloc_w¨n
 
ªloc_w¨n
 = { 0 };

308 
	`båfs_ªÀa£_∑th
(&
∑th
);

310 
˘x
.
byãƒ
 = 
found_key
.
obje˘id
;

311 
˘x
.
exã¡_ôem_pos
 = 
logiˇl
 - 
found_key
.
obje˘id
;

312 
˘x
.
fs_öfo
 = fs_info;

314 
ªloc_w¨n
.
logiˇl
 =Üogical;

315 
ªloc_w¨n
.
exã¡_ôem_size
 = 
found_key
.
off£t
;

316 
ªloc_w¨n
.
múr‹_num
 = mirror_num;

317 
ªloc_w¨n
.
fs_öfo
 = fs_info;

319 
	`ôî©e_exã¡_öodes
(&
˘x
, 
åue
,

320 
d©a_ªloc_¥öt_w¨nög_öode
, &
ªloc_w¨n
);

322 
	}
}

324 
__cﬁd
 
	$båfs_¥öt_d©a_csum_îr‹
(
båfs_öode
 *
öode
,

325 
u64
 
logiˇl_°¨t
, 
u8
 *
csum
, u8 *
csum_ex≥˘ed
, 
múr‹_num
)

327 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

328 c⁄° 
u32
 
csum_size
 = 
roŸ
->
fs_öfo
->csum_size;

331 i‡(
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_DATA_RELOC_TREE_OBJECTID
)

332  
	`¥öt_d©a_ªloc_îr‹
(
öode
, 
logiˇl_°¨t
, 
csum
,

333 
csum_ex≥˘ed
, 
múr‹_num
);

355 
	}
}

367 
	$båfs_öode_lock
(
båfs_öode
 *
öode
, 
ûock_Êags
)

369 i‡(
ûock_Êags
 & 
BTRFS_ILOCK_SHARED
) {

370 i‡(
ûock_Êags
 & 
BTRFS_ILOCK_TRY
) {

371 i‡(!
	`öode_åylock_sh¨ed
(&
öode
->
vfs_öode
))

372  -
EAGAIN
;

376 
	`öode_lock_sh¨ed
(&
öode
->
vfs_öode
);

378 i‡(
ûock_Êags
 & 
BTRFS_ILOCK_TRY
) {

379 i‡(!
	`öode_åylock
(&
öode
->
vfs_öode
))

380  -
EAGAIN
;

384 
	`öode_lock
(&
öode
->
vfs_öode
);

386 i‡(
ûock_Êags
 & 
BTRFS_ILOCK_MMAP
)

387 
	`down_wrôe
(&
öode
->
i_mm≠_lock
);

389 
	}
}

397 
	$båfs_öode_u∆ock
(
båfs_öode
 *
öode
, 
ûock_Êags
)

399 i‡(
ûock_Êags
 & 
BTRFS_ILOCK_MMAP
)

400 
	`up_wrôe
(&
öode
->
i_mm≠_lock
);

401 i‡(
ûock_Êags
 & 
BTRFS_ILOCK_SHARED
)

402 
	`öode_u∆ock_sh¨ed
(&
öode
->
vfs_öode
);

404 
	`öode_u∆ock
(&
öode
->
vfs_öode
);

405 
	}
}

417 
ölöe
 
	$båfs_˛ónup_‹dîed_exã¡s
(
båfs_öode
 *
öode
,

418 
∑ge
 *
locked_∑ge
,

419 
u64
 
off£t
, u64 
byãs
)

421 
ödex
 = 
off£t
 >> 
PAGE_SHIFT
;

422 
íd_ödex
 = (
off£t
 + 
byãs
 - 1Ë>> 
PAGE_SHIFT
;

423 
u64
 
∑ge_°¨t
 = 0, 
∑ge_íd
 = 0;

424 
∑ge
 *page;

426 i‡(
locked_∑ge
) {

427 
∑ge_°¨t
 = 
	`∑ge_off£t
(
locked_∑ge
);

428 
∑ge_íd
 = 
∑ge_°¨t
 + 
PAGE_SIZE
 - 1;

431 
ödex
 <
íd_ödex
) {

442 i‡(
locked_∑ge
 && 
ödex
 =(
∑ge_°¨t
 >> 
PAGE_SHIFT
)) {

443 
ödex
++;

446 
∑ge
 = 
	`föd_gë_∑ge
(
öode
->
vfs_öode
.
i_m≠pög
, 
ödex
);

447 
ödex
++;

448 i‡(!
∑ge
)

456 
	`båfs_∑ge_˛amp_˛ór_‹dîed
(
öode
->
roŸ
->
fs_öfo
, 
∑ge
,

457 
off£t
, 
byãs
);

458 
	`put_∑ge
(
∑ge
);

461 i‡(
locked_∑ge
) {

463 i‡(
byãs
 + 
off£t
 <
∑ge_°¨t
 + 
PAGE_SIZE
)

471 i‡(
∑ge_°¨t
 >
off£t
 && 
∑ge_íd
 <(off£à+ 
byãs
 - 1)) {

472 
byãs
 = 
off£t
 + byã†- 
	`∑ge_off£t
(
locked_∑ge
Ë- 
PAGE_SIZE
;

473 
off£t
 = 
	`∑ge_off£t
(
locked_∑ge
Ë+ 
PAGE_SIZE
;

477  
	`båfs_m¨k_‹dîed_io_föished
(
öode
, 
NULL
, 
off£t
, 
byãs
, 
Ál£
);

478 
	}
}

480 
båfs_dúty_öode
(
båfs_öode
 *
öode
);

482 
	$båfs_öô_öode_£curôy
(
båfs_å™s_h™dÀ
 *
å™s
,

483 
båfs_√w_öode_¨gs
 *
¨gs
)

485 
îr
;

487 i‡(
¨gs
->
deÁu…_a˛
) {

488 
îr
 = 
	`__båfs_£t_a˛
(
å™s
, 
¨gs
->
öode
,árgs->
deÁu…_a˛
,

489 
ACL_TYPE_DEFAULT
);

490 i‡(
îr
)

491  
îr
;

493 i‡(
¨gs
->
a˛
) {

494 
îr
 = 
	`__båfs_£t_a˛
(
å™s
, 
¨gs
->
öode
,árgs->
a˛
, 
ACL_TYPE_ACCESS
);

495 i‡(
îr
)

496  
îr
;

498 i‡(!
¨gs
->
deÁu…_a˛
 && !¨gs->
a˛
)

499 
	`ˇche_no_a˛
(
¨gs
->
öode
);

500  
	`båfs_x©å_£curôy_öô
(
å™s
, 
¨gs
->
öode
,árgs->
dú
,

501 &
¨gs
->
díåy
->
d_«me
);

502 
	}
}

509 
	$ö£π_ölöe_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

510 
båfs_∑th
 *
∑th
,

511 
båfs_öode
 *
öode
, 
boﬁ
 
exã¡_ö£πed
,

512 
size_t
 
size
, size_à
com¥es£d_size
,

513 
com¥ess_ty≥
,

514 
∑ge
 **
com¥es£d_∑ges
,

515 
boﬁ
 
upd©e_i_size
)

517 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

518 
exã¡_buf„r
 *
Àaf
;

519 
∑ge
 *∑gê
NULL
;

520 *
kaddr
;

521 
±r
;

522 
båfs_fûe_exã¡_ôem
 *
ei
;

523 
ªt
;

524 
size_t
 
cur_size
 = 
size
;

525 
u64
 
i_size
;

527 
	`ASSERT
((
com¥es£d_size
 > 0 && 
com¥es£d_∑ges
) ||

528 (
com¥es£d_size
 =0 && !
com¥es£d_∑ges
));

530 i‡(
com¥es£d_size
 && 
com¥es£d_∑ges
)

531 
cur_size
 = 
com¥es£d_size
;

533 i‡(!
exã¡_ö£πed
) {

534 
båfs_key
 
key
;

535 
size_t
 
d©asize
;

537 
key
.
obje˘id
 = 
	`båfs_öo
(
öode
);

538 
key
.
off£t
 = 0;

539 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

541 
d©asize
 = 
	`båfs_fûe_exã¡_ˇlc_ölöe_size
(
cur_size
);

542 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
,

543 
d©asize
);

544 i‡(
ªt
)

545 
Áû
;

547 
Àaf
 = 
∑th
->
nodes
[0];

548 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

549 
båfs_fûe_exã¡_ôem
);

550 
	`båfs_£t_fûe_exã¡_gíî©i⁄
(
Àaf
, 
ei
, 
å™s
->
å™sid
);

551 
	`båfs_£t_fûe_exã¡_ty≥
(
Àaf
, 
ei
, 
BTRFS_FILE_EXTENT_INLINE
);

552 
	`båfs_£t_fûe_exã¡_í¸y±i⁄
(
Àaf
, 
ei
, 0);

553 
	`båfs_£t_fûe_exã¡_Ÿhî_ícodög
(
Àaf
, 
ei
, 0);

554 
	`båfs_£t_fûe_exã¡_øm_byãs
(
Àaf
, 
ei
, 
size
);

555 
±r
 = 
	`båfs_fûe_exã¡_ölöe_°¨t
(
ei
);

557 i‡(
com¥ess_ty≥
 !
BTRFS_COMPRESS_NONE
) {

558 
∑ge
 *
˝age
;

559 
i
 = 0;

560 
com¥es£d_size
 > 0) {

561 
˝age
 = 
com¥es£d_∑ges
[
i
];

562 
cur_size
 = 
	`mö_t
(, 
com¥es£d_size
,

563 
PAGE_SIZE
);

565 
kaddr
 = 
	`km≠_loˇl_∑ge
(
˝age
);

566 
	`wrôe_exã¡_buf„r
(
Àaf
, 
kaddr
, 
±r
, 
cur_size
);

567 
	`kunm≠_loˇl
(
kaddr
);

569 
i
++;

570 
±r
 +
cur_size
;

571 
com¥es£d_size
 -
cur_size
;

573 
	`båfs_£t_fûe_exã¡_com¥essi⁄
(
Àaf
, 
ei
,

574 
com¥ess_ty≥
);

576 
∑ge
 = 
	`föd_gë_∑ge
(
öode
->
vfs_öode
.
i_m≠pög
, 0);

577 
	`båfs_£t_fûe_exã¡_com¥essi⁄
(
Àaf
, 
ei
, 0);

578 
kaddr
 = 
	`km≠_loˇl_∑ge
(
∑ge
);

579 
	`wrôe_exã¡_buf„r
(
Àaf
, 
kaddr
, 
±r
, 
size
);

580 
	`kunm≠_loˇl
(
kaddr
);

581 
	`put_∑ge
(
∑ge
);

583 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

584 
	`båfs_ªÀa£_∑th
(
∑th
);

590 
ªt
 = 
	`båfs_öode_£t_fûe_exã¡_ønge
(
öode
, 0,

591 
	`ALIGN
(
size
, 
roŸ
->
fs_öfo
->
£˘‹size
));

592 i‡(
ªt
)

593 
Áû
;

602 
i_size
 = 
	`i_size_ªad
(&
öode
->
vfs_öode
);

603 i‡(
upd©e_i_size
 && 
size
 > 
i_size
) {

604 
	`i_size_wrôe
(&
öode
->
vfs_öode
, 
size
);

605 
i_size
 = 
size
;

607 
öode
->
disk_i_size
 = 
i_size
;

609 
Áû
:

610  
ªt
;

611 
	}
}

619 
noölöe
 
	$cow_fûe_ønge_ölöe
(
båfs_öode
 *
öode
, 
u64
 
size
,

620 
size_t
 
com¥es£d_size
,

621 
com¥ess_ty≥
,

622 
∑ge
 **
com¥es£d_∑ges
,

623 
boﬁ
 
upd©e_i_size
)

625 
båfs_dr›_exã¡s_¨gs
 
dr›_¨gs
 = { 0 };

626 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

627 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

628 
båfs_å™s_h™dÀ
 *
å™s
;

629 
u64
 
d©a_Àn
 = (
com¥es£d_size
 ?: 
size
);

630 
ªt
;

631 
båfs_∑th
 *
∑th
;

639 i‡(
size
 < 
	`i_size_ªad
(&
öode
->
vfs_öode
) ||

640 
size
 > 
fs_öfo
->
£˘‹size
 ||

641 
d©a_Àn
 > 
	`BTRFS_MAX_INLINE_DATA_SIZE
(
fs_öfo
) ||

642 
d©a_Àn
 > 
fs_öfo
->
max_ölöe
)

645 
∑th
 = 
	`båfs_Æloc_∑th
();

646 i‡(!
∑th
)

647  -
ENOMEM
;

649 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
roŸ
);

650 i‡(
	`IS_ERR
(
å™s
)) {

651 
	`båfs_‰ì_∑th
(
∑th
);

652  
	`PTR_ERR
(
å™s
);

654 
å™s
->
block_rsv
 = &
öode
->block_rsv;

656 
dr›_¨gs
.
∑th
 =Öath;

657 
dr›_¨gs
.
°¨t
 = 0;

658 
dr›_¨gs
.
íd
 = 
fs_öfo
->
£˘‹size
;

659 
dr›_¨gs
.
dr›_ˇche
 = 
åue
;

660 
dr›_¨gs
.
ª∂a˚_exã¡
 = 
åue
;

661 
dr›_¨gs
.
exã¡_ôem_size
 = 
	`båfs_fûe_exã¡_ˇlc_ölöe_size
(
d©a_Àn
);

662 
ªt
 = 
	`båfs_dr›_exã¡s
(
å™s
, 
roŸ
, 
öode
, &
dr›_¨gs
);

663 i‡(
ªt
) {

664 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

665 
out
;

668 
ªt
 = 
	`ö£π_ölöe_exã¡
(
å™s
, 
∑th
, 
öode
, 
dr›_¨gs
.
exã¡_ö£πed
,

669 
size
, 
com¥es£d_size
, 
com¥ess_ty≥
,

670 
com¥es£d_∑ges
, 
upd©e_i_size
);

671 i‡(
ªt
 &&Ñë !-
ENOSPC
) {

672 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

673 
out
;

674 } i‡(
ªt
 =-
ENOSPC
) {

675 
ªt
 = 1;

676 
out
;

679 
	`båfs_upd©e_öode_byãs
(
öode
, 
size
, 
dr›_¨gs
.
byãs_found
);

680 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
öode
);

681 i‡(
ªt
 &&Ñë !-
ENOSPC
) {

682 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

683 
out
;

684 } i‡(
ªt
 =-
ENOSPC
) {

685 
ªt
 = 1;

686 
out
;

689 
	`båfs_£t_öode_fuŒ_sync
(
öode
);

690 
out
:

697 
	`båfs_qgroup_‰ì_d©a
(
öode
, 
NULL
, 0, 
PAGE_SIZE
, NULL);

698 
	`båfs_‰ì_∑th
(
∑th
);

699 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

700  
ªt
;

701 
	}
}

703 
	sasync_exã¡
 {

704 
u64
 
	m°¨t
;

705 
u64
 
	møm_size
;

706 
u64
 
	mcom¥es£d_size
;

707 
∑ge
 **
	m∑ges
;

708 
	mƒ_∑ges
;

709 
	mcom¥ess_ty≥
;

710 
li°_hód
 
	mli°
;

713 
	sasync_chunk
 {

714 
båfs_öode
 *
	möode
;

715 
∑ge
 *
	mlocked_∑ge
;

716 
u64
 
	m°¨t
;

717 
u64
 
	míd
;

718 
blk_›f_t
 
	mwrôe_Êags
;

719 
li°_hód
 
	mexã¡s
;

720 
cgroup_subsys_°©e
 *
	mblkcg_css
;

721 
båfs_w‹k
 
	mw‹k
;

722 
async_cow
 *
	masync_cow
;

725 
	sasync_cow
 {

726 
©omic_t
 
	mnum_chunks
;

727 
async_chunk
 
	mchunks
[];

730 
noölöe
 
	$add_async_exã¡
(
async_chunk
 *
cow
,

731 
u64
 
°¨t
, u64 
øm_size
,

732 
u64
 
com¥es£d_size
,

733 
∑ge
 **
∑ges
,

734 
ƒ_∑ges
,

735 
com¥ess_ty≥
)

737 
async_exã¡
 *async_extent;

739 
async_exã¡
 = 
	`kmÆloc
((*async_exã¡), 
GFP_NOFS
);

740 
	`BUG_ON
(!
async_exã¡
);

741 
async_exã¡
->
°¨t
 = start;

742 
async_exã¡
->
øm_size
 =Ñam_size;

743 
async_exã¡
->
com¥es£d_size
 = compressed_size;

744 
async_exã¡
->
∑ges
 =Öages;

745 
async_exã¡
->
ƒ_∑ges
 =Çr_pages;

746 
async_exã¡
->
com¥ess_ty≥
 = compress_type;

747 
	`li°_add_èû
(&
async_exã¡
->
li°
, &
cow
->
exã¡s
);

749 
	}
}

755 
ölöe
 
	$öode_√ed_com¥ess
(
båfs_öode
 *
öode
, 
u64
 
°¨t
,

756 
u64
 
íd
)

758 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

760 i‡(!
	`båfs_öode_ˇn_com¥ess
(
öode
)) {

761 
	`WARN
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
),

762 
KERN_ERR
 "BTRFS: unexpected compression for ino %llu\n",

763 
	`båfs_öo
(
öode
));

792 i‡(
fs_öfo
->
£˘‹size
 < 
PAGE_SIZE
) {

793 i‡(!
	`PAGE_ALIGNED
(
°¨t
) ||

794 !
	`PAGE_ALIGNED
(
íd
 + 1))

799 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
FORCE_COMPRESS
))

802 i‡(
öode
->
de‰ag_com¥ess
)

805 i‡(
öode
->
Êags
 & 
BTRFS_INODE_NOCOMPRESS
)

807 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
COMPRESS
) ||

808 
öode
->
Êags
 & 
BTRFS_INODE_COMPRESS
 ||

809 
öode
->
¥›_com¥ess
)

810  
	`båfs_com¥ess_heuri°ic
(&
öode
->
vfs_öode
, 
°¨t
, 
íd
);

812 
	}
}

814 
ölöe
 
	$öode_should_de‰ag
(
båfs_öode
 *
öode
,

815 
u64
 
°¨t
, u64 
íd
, u64 
num_byãs
, 
u32
 
smÆl_wrôe
)

818 i‡(
num_byãs
 < 
smÆl_wrôe
 &&

819 (
°¨t
 > 0 || 
íd
 + 1 < 
öode
->
disk_i_size
))

820 
	`båfs_add_öode_de‰ag
(
NULL
, 
öode
, 
smÆl_wrôe
);

821 
	}
}

836 
	$com¥ess_fûe_ønge
(
båfs_w‹k
 *
w‹k
)

838 
async_chunk
 *async_chunk =

839 
	`c⁄èöî_of
(
w‹k
, 
async_chunk
, work);

840 
båfs_öode
 *
öode
 = 
async_chunk
->inode;

841 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

842 
addªss_•a˚
 *
m≠pög
 = 
öode
->
vfs_öode
.
i_m≠pög
;

843 
u64
 
blocksize
 = 
fs_öfo
->
£˘‹size
;

844 
u64
 
°¨t
 = 
async_chunk
->start;

845 
u64
 
íd
 = 
async_chunk
->end;

846 
u64
 
a˘uÆ_íd
;

847 
u64
 
i_size
;

848 
ªt
 = 0;

849 
∑ge
 **
∑ges
;

850 
ƒ_∑ges
;

851 
tŸÆ_com¥es£d
 = 0;

852 
tŸÆ_ö
 = 0;

853 
poff
;

854 
i
;

855 
com¥ess_ty≥
 = 
fs_öfo
->compress_type;

857 
	`öode_should_de‰ag
(
öode
, 
°¨t
, 
íd
,Énd - sèπ + 1, 
SZ_16K
);

864 
	`exã¡_ønge_˛ór_dúty_f‹_io
(&
öode
->
vfs_öode
, 
°¨t
, 
íd
);

875 
	`b¨rõr
();

876 
i_size
 = 
	`i_size_ªad
(&
öode
->
vfs_öode
);

877 
	`b¨rõr
();

878 
a˘uÆ_íd
 = 
	`mö_t
(
u64
, 
i_size
, 
íd
 + 1);

879 
agaö
:

880 
∑ges
 = 
NULL
;

881 
ƒ_∑ges
 = (
íd
 >> 
PAGE_SHIFT
Ë- (
°¨t
 >> PAGE_SHIFT) + 1;

882 
ƒ_∑ges
 = 
	`mö_t
(,Çr_∑ges, 
BTRFS_MAX_COMPRESSED_PAGES
);

894 i‡(
a˘uÆ_íd
 <
°¨t
)

895 
˛ónup_™d_baû_uncom¥es£d
;

897 
tŸÆ_com¥es£d
 = 
a˘uÆ_íd
 - 
°¨t
;

903 i‡(
tŸÆ_com¥es£d
 <
blocksize
 &&

904 (
°¨t
 > 0 || 
íd
 + 1 < 
öode
->
disk_i_size
))

905 
˛ónup_™d_baû_uncom¥es£d
;

912 i‡(
blocksize
 < 
PAGE_SIZE
) {

913 i‡(!
	`PAGE_ALIGNED
(
°¨t
) ||

914 !
	`PAGE_ALIGNED
(
	`round_up
(
a˘uÆ_íd
, 
blocksize
)))

915 
˛ónup_™d_baû_uncom¥es£d
;

918 
tŸÆ_com¥es£d
 = 
	`mö_t
(,Åotal_compressed,

919 
BTRFS_MAX_UNCOMPRESSED
);

920 
tŸÆ_ö
 = 0;

921 
ªt
 = 0;

928 i‡(!
	`öode_√ed_com¥ess
(
öode
, 
°¨t
, 
íd
))

929 
˛ónup_™d_baû_uncom¥es£d
;

931 
∑ges
 = 
	`kˇŒoc
(
ƒ_∑ges
, (
∑ge
 *), 
GFP_NOFS
);

932 i‡(!
∑ges
) {

937 
˛ónup_™d_baû_uncom¥es£d
;

940 i‡(
öode
->
de‰ag_com¥ess
)

941 
com¥ess_ty≥
 = 
öode
->
de‰ag_com¥ess
;

942 i‡(
öode
->
¥›_com¥ess
)

943 
com¥ess_ty≥
 = 
öode
->
¥›_com¥ess
;

946 
ªt
 = 
	`båfs_com¥ess_∑ges
(
com¥ess_ty≥
 | (
fs_öfo
->
com¥ess_Àvñ
 << 4),

947 
m≠pög
, 
°¨t
, 
∑ges
, &
ƒ_∑ges
, &
tŸÆ_ö
,

948 &
tŸÆ_com¥es£d
);

949 i‡(
ªt
)

950 
m¨k_öcom¥essibÀ
;

956 
poff
 = 
	`off£t_ö_∑ge
(
tŸÆ_com¥es£d
);

957 i‡(
poff
)

958 
	`memzîo_∑ge
(
∑ges
[
ƒ_∑ges
 - 1], 
poff
, 
PAGE_SIZE
 -Öoff);

969 i‡(
°¨t
 =0 && 
fs_öfo
->
£˘‹size
 =
PAGE_SIZE
) {

970 i‡(
tŸÆ_ö
 < 
a˘uÆ_íd
) {

971 
ªt
 = 
	`cow_fûe_ønge_ölöe
(
öode
, 
a˘uÆ_íd
, 0,

972 
BTRFS_COMPRESS_NONE
, 
NULL
,

973 
Ál£
);

975 
ªt
 = 
	`cow_fûe_ønge_ölöe
(
öode
, 
a˘uÆ_íd
,

976 
tŸÆ_com¥es£d
,

977 
com¥ess_ty≥
, 
∑ges
,

978 
Ál£
);

980 i‡(
ªt
 <= 0) {

981 
˛ór_Êags
 = 
EXTENT_DELALLOC
 |

982 
EXTENT_DELALLOC_NEW
 | 
EXTENT_DEFRAG
 |

983 
EXTENT_DO_ACCOUNTING
;

985 i‡(
ªt
 < 0)

986 
	`m≠pög_£t_îr‹
(
m≠pög
, -
EIO
);

998 
	`exã¡_˛ór_u∆ock_dñÆloc
(
öode
, 
°¨t
, 
íd
,

999 
NULL
,

1000 
˛ór_Êags
,

1001 
PAGE_UNLOCK
 |

1002 
PAGE_START_WRITEBACK
 |

1003 
PAGE_END_WRITEBACK
);

1004 
‰ì_∑ges
;

1012 
tŸÆ_com¥es£d
 = 
	`ALIGN
—ŸÆ_com¥es£d, 
blocksize
);

1019 
tŸÆ_ö
 = 
	`round_up
—ŸÆ_ö, 
fs_öfo
->
£˘‹size
);

1020 i‡(
tŸÆ_com¥es£d
 + 
blocksize
 > 
tŸÆ_ö
)

1021 
m¨k_öcom¥essibÀ
;

1027 
	`add_async_exã¡
(
async_chunk
, 
°¨t
, 
tŸÆ_ö
, 
tŸÆ_com¥es£d
, 
∑ges
,

1028 
ƒ_∑ges
, 
com¥ess_ty≥
);

1029 i‡(
°¨t
 + 
tŸÆ_ö
 < 
íd
) {

1030 
°¨t
 +
tŸÆ_ö
;

1031 
	`c⁄d_ªsched
();

1032 
agaö
;

1036 
m¨k_öcom¥essibÀ
:

1037 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
FORCE_COMPRESS
Ë&& !
öode
->
¥›_com¥ess
)

1038 
öode
->
Êags
 |
BTRFS_INODE_NOCOMPRESS
;

1039 
˛ónup_™d_baû_uncom¥es£d
:

1040 
	`add_async_exã¡
(
async_chunk
, 
°¨t
, 
íd
 - sèπ + 1, 0, 
NULL
, 0,

1041 
BTRFS_COMPRESS_NONE
);

1042 
‰ì_∑ges
:

1043 i‡(
∑ges
) {

1044 
i
 = 0; i < 
ƒ_∑ges
; i++) {

1045 
	`WARN_ON
(
∑ges
[
i
]->
m≠pög
);

1046 
	`put_∑ge
(
∑ges
[
i
]);

1048 
	`k‰ì
(
∑ges
);

1050 
	}
}

1052 
	$‰ì_async_exã¡_∑ges
(
async_exã¡
 *async_extent)

1054 
i
;

1056 i‡(!
async_exã¡
->
∑ges
)

1059 
i
 = 0; i < 
async_exã¡
->
ƒ_∑ges
; i++) {

1060 
	`WARN_ON
(
async_exã¡
->
∑ges
[
i
]->
m≠pög
);

1061 
	`put_∑ge
(
async_exã¡
->
∑ges
[
i
]);

1063 
	`k‰ì
(
async_exã¡
->
∑ges
);

1064 
async_exã¡
->
ƒ_∑ges
 = 0;

1065 
async_exã¡
->
∑ges
 = 
NULL
;

1066 
	}
}

1068 
	$submô_uncom¥es£d_ønge
(
båfs_öode
 *
öode
,

1069 
async_exã¡
 *async_extent,

1070 
∑ge
 *
locked_∑ge
)

1072 
u64
 
°¨t
 = 
async_exã¡
->start;

1073 
u64
 
íd
 = 
async_exã¡
->
°¨t
 +ásync_exã¡->
øm_size
 - 1;

1074 
ªt
;

1075 
wrôeback_c⁄åﬁ
 
wbc
 = {

1076 .
sync_mode
 = 
WB_SYNC_ALL
,

1077 .
ønge_°¨t
 = 
°¨t
,

1078 .
ønge_íd
 = 
íd
,

1079 .
no_cgroup_ow√r
 = 1,

1082 
	`wbc_©èch_fd©awrôe_öode
(&
wbc
, &
öode
->
vfs_öode
);

1083 
ªt
 = 
	`run_dñÆloc_cow
(
öode
, 
locked_∑ge
, 
°¨t
, 
íd
, &
wbc
, 
Ál£
);

1084 
	`wbc_dëach_öode
(&
wbc
);

1085 i‡(
ªt
 < 0) {

1086 
	`båfs_˛ónup_‹dîed_exã¡s
(
öode
, 
locked_∑ge
, 
°¨t
, 
íd
 - start + 1);

1087 i‡(
locked_∑ge
) {

1088 c⁄° 
u64
 
∑ge_°¨t
 = 
	`∑ge_off£t
(
locked_∑ge
);

1090 
	`£t_∑ge_wrôeback
(
locked_∑ge
);

1091 
	`íd_∑ge_wrôeback
(
locked_∑ge
);

1092 
	`båfs_m¨k_‹dîed_io_föished
(
öode
, 
locked_∑ge
,

1093 
∑ge_°¨t
, 
PAGE_SIZE
,

1094 !
ªt
);

1095 
	`m≠pög_£t_îr‹
(
locked_∑ge
->
m≠pög
, 
ªt
);

1096 
	`u∆ock_∑ge
(
locked_∑ge
);

1099 
	}
}

1101 
	$submô_⁄e_async_exã¡
(
async_chunk
 *async_chunk,

1102 
async_exã¡
 *async_extent,

1103 
u64
 *
Æloc_höt
)

1105 
båfs_öode
 *
öode
 = 
async_chunk
->inode;

1106 
exã¡_io_åì
 *
io_åì
 = &
öode
->io_tree;

1107 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

1108 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1109 
båfs_‹dîed_exã¡
 *
‹dîed
;

1110 
båfs_key
 
ös
;

1111 
∑ge
 *
locked_∑ge
 = 
NULL
;

1112 
exã¡_m≠
 *
em
;

1113 
ªt
 = 0;

1114 
u64
 
°¨t
 = 
async_exã¡
->start;

1115 
u64
 
íd
 = 
async_exã¡
->
°¨t
 +ásync_exã¡->
øm_size
 - 1;

1117 i‡(
async_chunk
->
blkcg_css
)

1118 
	`kthªad_assocüã_blkcg
(
async_chunk
->
blkcg_css
);

1124 i‡(
async_chunk
->
locked_∑ge
) {

1125 
u64
 
locked_∑ge_°¨t
 = 
	`∑ge_off£t
(
async_chunk
->
locked_∑ge
);

1126 
u64
 
locked_∑ge_íd
 = 
locked_∑ge_°¨t
 + 
PAGE_SIZE
 - 1;

1128 i‡(!(
°¨t
 >
locked_∑ge_íd
 || 
íd
 <
locked_∑ge_°¨t
))

1129 
locked_∑ge
 = 
async_chunk
->locked_page;

1131 
	`lock_exã¡
(
io_åì
, 
°¨t
, 
íd
, 
NULL
);

1133 i‡(
async_exã¡
->
com¥ess_ty≥
 =
BTRFS_COMPRESS_NONE
) {

1134 
	`submô_uncom¥es£d_ønge
(
öode
, 
async_exã¡
, 
locked_∑ge
);

1135 
d⁄e
;

1138 
ªt
 = 
	`båfs_ª£rve_exã¡
(
roŸ
, 
async_exã¡
->
øm_size
,

1139 
async_exã¡
->
com¥es£d_size
,

1140 
async_exã¡
->
com¥es£d_size
,

1141 0, *
Æloc_höt
, &
ös
, 1, 1);

1142 i‡(
ªt
) {

1150 
out_‰ì
;

1154 
em
 = 
	`¸óã_io_em
(
öode
, 
°¨t
,

1155 
async_exã¡
->
øm_size
,

1156 
°¨t
,

1157 
ös
.
obje˘id
,

1158 
ös
.
off£t
,

1159 
ös
.
off£t
,

1160 
async_exã¡
->
øm_size
,

1161 
async_exã¡
->
com¥ess_ty≥
,

1162 
BTRFS_ORDERED_COMPRESSED
);

1163 i‡(
	`IS_ERR
(
em
)) {

1164 
ªt
 = 
	`PTR_ERR
(
em
);

1165 
out_‰ì_ª£rve
;

1167 
	`‰ì_exã¡_m≠
(
em
);

1169 
‹dîed
 = 
	`båfs_Æloc_‹dîed_exã¡
(
öode
, 
°¨t
,

1170 
async_exã¡
->
øm_size
,

1171 
async_exã¡
->
øm_size
,

1172 
ös
.
obje˘id
,

1173 
ös
.
off£t
,

1175 1 << 
BTRFS_ORDERED_COMPRESSED
,

1176 
async_exã¡
->
com¥ess_ty≥
);

1177 i‡(
	`IS_ERR
(
‹dîed
)) {

1178 
	`båfs_dr›_exã¡_m≠_ønge
(
öode
, 
°¨t
, 
íd
, 
Ál£
);

1179 
ªt
 = 
	`PTR_ERR
(
‹dîed
);

1180 
out_‰ì_ª£rve
;

1182 
	`båfs_dec_block_group_ª£rv©i⁄s
(
fs_öfo
, 
ös
.
obje˘id
);

1185 
	`exã¡_˛ór_u∆ock_dñÆloc
(
öode
, 
°¨t
, 
íd
,

1186 
NULL
, 
EXTENT_LOCKED
 | 
EXTENT_DELALLOC
,

1187 
PAGE_UNLOCK
 | 
PAGE_START_WRITEBACK
);

1188 
	`båfs_submô_com¥es£d_wrôe
(
‹dîed
,

1189 
async_exã¡
->
∑ges
,

1190 
async_exã¡
->
ƒ_∑ges
,

1191 
async_chunk
->
wrôe_Êags
, 
åue
);

1192 *
Æloc_höt
 = 
ös
.
obje˘id
 + ins.
off£t
;

1193 
d⁄e
:

1194 i‡(
async_chunk
->
blkcg_css
)

1195 
	`kthªad_assocüã_blkcg
(
NULL
);

1196 
	`k‰ì
(
async_exã¡
);

1199 
out_‰ì_ª£rve
:

1200 
	`båfs_dec_block_group_ª£rv©i⁄s
(
fs_öfo
, 
ös
.
obje˘id
);

1201 
	`båfs_‰ì_ª£rved_exã¡
(
fs_öfo
, 
ös
.
obje˘id
, ins.
off£t
, 1);

1202 
out_‰ì
:

1203 
	`m≠pög_£t_îr‹
(
öode
->
vfs_öode
.
i_m≠pög
, -
EIO
);

1204 
	`exã¡_˛ór_u∆ock_dñÆloc
(
öode
, 
°¨t
, 
íd
,

1205 
NULL
, 
EXTENT_LOCKED
 | 
EXTENT_DELALLOC
 |

1206 
EXTENT_DELALLOC_NEW
 |

1207 
EXTENT_DEFRAG
 | 
EXTENT_DO_ACCOUNTING
,

1208 
PAGE_UNLOCK
 | 
PAGE_START_WRITEBACK
 |

1209 
PAGE_END_WRITEBACK
);

1210 
	`‰ì_async_exã¡_∑ges
(
async_exã¡
);

1211 i‡(
async_chunk
->
blkcg_css
)

1212 
	`kthªad_assocüã_blkcg
(
NULL
);

1213 
	`båfs_debug
(
fs_öfo
,

1215 
roŸ
->
roŸ_key
.
obje˘id
, 
	`båfs_öo
(
öode
), 
°¨t
,

1216 
async_exã¡
->
øm_size
, 
ªt
);

1217 
	`k‰ì
(
async_exã¡
);

1218 
	}
}

1220 
u64
 
	$gë_exã¡_Æloˇti⁄_höt
(
båfs_öode
 *
öode
, 
u64
 
°¨t
,

1221 
u64
 
num_byãs
)

1223 
exã¡_m≠_åì
 *
em_åì
 = &
öode
->
exã¡_åì
;

1224 
exã¡_m≠
 *
em
;

1225 
u64
 
Æloc_höt
 = 0;

1227 
	`ªad_lock
(&
em_åì
->
lock
);

1228 
em
 = 
	`£¨ch_exã¡_m≠pög
(
em_åì
, 
°¨t
, 
num_byãs
);

1229 i‡(
em
) {

1235 i‡(
em
->
block_°¨t
 >
EXTENT_MAP_LAST_BYTE
) {

1236 
	`‰ì_exã¡_m≠
(
em
);

1237 
em
 = 
	`£¨ch_exã¡_m≠pög
(
em_åì
, 0, 0);

1238 i‡(
em
 &&Ém->
block_°¨t
 < 
EXTENT_MAP_LAST_BYTE
)

1239 
Æloc_höt
 = 
em
->
block_°¨t
;

1240 i‡(
em
)

1241 
	`‰ì_exã¡_m≠
(
em
);

1243 
Æloc_höt
 = 
em
->
block_°¨t
;

1244 
	`‰ì_exã¡_m≠
(
em
);

1247 
	`ªad_u∆ock
(&
em_åì
->
lock
);

1249  
Æloc_höt
;

1250 
	}
}

1280 
noölöe
 
	$cow_fûe_ønge
(
båfs_öode
 *
öode
,

1281 
∑ge
 *
locked_∑ge
, 
u64
 
°¨t
, u64 
íd
,

1282 
u64
 *
d⁄e_off£t
,

1283 
boﬁ
 
kìp_locked
, boﬁ 
no_ölöe
)

1285 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

1286 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1287 
u64
 
Æloc_höt
 = 0;

1288 
u64
 
‹ig_°¨t
 = 
°¨t
;

1289 
u64
 
num_byãs
;

1290 
øm_size
;

1291 
u64
 
cur_Æloc_size
 = 0;

1292 
u64
 
mö_Æloc_size
;

1293 
u64
 
blocksize
 = 
fs_öfo
->
£˘‹size
;

1294 
båfs_key
 
ös
;

1295 
exã¡_m≠
 *
em
;

1296 
˛ór_bôs
;

1297 
∑ge_›s
;

1298 
boﬁ
 
exã¡_ª£rved
 = 
Ál£
;

1299 
ªt
 = 0;

1301 i‡(
	`båfs_is_‰ì_•a˚_öode
(
öode
)) {

1302 
ªt
 = -
EINVAL
;

1303 
out_u∆ock
;

1306 
num_byãs
 = 
	`ALIGN
(
íd
 - 
°¨t
 + 1, 
blocksize
);

1307 
num_byãs
 = 
	`max
(
blocksize
,Çum_bytes);

1308 
	`ASSERT
(
num_byãs
 <
	`båfs_su≥r_tŸÆ_byãs
(
fs_öfo
->
su≥r_c›y
));

1310 
	`öode_should_de‰ag
(
öode
, 
°¨t
, 
íd
, 
num_byãs
, 
SZ_64K
);

1322 i‡(
°¨t
 =0 && 
fs_öfo
->
£˘‹size
 =
PAGE_SIZE
 && !
no_ölöe
) {

1323 
u64
 
a˘uÆ_íd
 = 
	`mö_t
(u64, 
	`i_size_ªad
(&
öode
->
vfs_öode
),

1324 
íd
 + 1);

1327 
ªt
 = 
	`cow_fûe_ønge_ölöe
(
öode
, 
a˘uÆ_íd
, 0,

1328 
BTRFS_COMPRESS_NONE
, 
NULL
, 
Ál£
);

1329 i‡(
ªt
 == 0) {

1336 
	`exã¡_˛ór_u∆ock_dñÆloc
(
öode
, 
°¨t
, 
íd
,

1337 
locked_∑ge
,

1338 
EXTENT_LOCKED
 | 
EXTENT_DELALLOC
 |

1339 
EXTENT_DELALLOC_NEW
 | 
EXTENT_DEFRAG
 |

1340 
EXTENT_DO_ACCOUNTING
, 
PAGE_UNLOCK
 |

1341 
PAGE_START_WRITEBACK
 | 
PAGE_END_WRITEBACK
);

1354 
	`u∆ock_∑ge
(
locked_∑ge
);

1355 
ªt
 = 1;

1356 
d⁄e
;

1357 } i‡(
ªt
 < 0) {

1358 
out_u∆ock
;

1362 
Æloc_höt
 = 
	`gë_exã¡_Æloˇti⁄_höt
(
öode
, 
°¨t
, 
num_byãs
);

1375 i‡(
	`båfs_is_d©a_ªloc_roŸ
(
roŸ
))

1376 
mö_Æloc_size
 = 
num_byãs
;

1378 
mö_Æloc_size
 = 
fs_öfo
->
£˘‹size
;

1380 
num_byãs
 > 0) {

1381 
båfs_‹dîed_exã¡
 *
‹dîed
;

1383 
cur_Æloc_size
 = 
num_byãs
;

1384 
ªt
 = 
	`båfs_ª£rve_exã¡
(
roŸ
, 
cur_Æloc_size
, cur_alloc_size,

1385 
mö_Æloc_size
, 0, 
Æloc_höt
,

1386 &
ös
, 1, 1);

1387 i‡(
ªt
 =-
EAGAIN
) {

1399 
	`ASSERT
(
	`båfs_is_z⁄ed
(
fs_öfo
));

1400 i‡(
°¨t
 =
‹ig_°¨t
) {

1401 
	`waô_⁄_bô_io
(&
öode
->
roŸ
->
fs_öfo
->
Êags
,

1402 
BTRFS_FS_NEED_ZONE_FINISH
,

1403 
TASK_UNINTERRUPTIBLE
);

1406 i‡(
d⁄e_off£t
) {

1407 *
d⁄e_off£t
 = 
°¨t
 - 1;

1410 
ªt
 = -
ENOSPC
;

1412 i‡(
ªt
 < 0)

1413 
out_u∆ock
;

1414 
cur_Æloc_size
 = 
ös
.
off£t
;

1415 
exã¡_ª£rved
 = 
åue
;

1417 
øm_size
 = 
ös
.
off£t
;

1420 
em
 = 
	`¸óã_io_em
(
öode
, 
°¨t
, 
ös
.
off£t
,

1421 
°¨t
,

1422 
ös
.
obje˘id
,

1423 
ös
.
off£t
,

1424 
ös
.
off£t
,

1425 
øm_size
,

1426 
BTRFS_COMPRESS_NONE
,

1427 
BTRFS_ORDERED_REGULAR
 );

1428 i‡(
	`IS_ERR
(
em
)) {

1429 
ªt
 = 
	`PTR_ERR
(
em
);

1430 
out_ª£rve
;

1432 
	`‰ì_exã¡_m≠
(
em
);

1434 
‹dîed
 = 
	`båfs_Æloc_‹dîed_exã¡
(
öode
, 
°¨t
, 
øm_size
,

1435 
øm_size
, 
ös
.
obje˘id
, 
cur_Æloc_size
,

1436 0, 1 << 
BTRFS_ORDERED_REGULAR
,

1437 
BTRFS_COMPRESS_NONE
);

1438 i‡(
	`IS_ERR
(
‹dîed
)) {

1439 
ªt
 = 
	`PTR_ERR
(
‹dîed
);

1440 
out_dr›_exã¡_ˇche
;

1443 i‡(
	`båfs_is_d©a_ªloc_roŸ
(
roŸ
)) {

1444 
ªt
 = 
	`båfs_ªloc_˛⁄e_csums
(
‹dîed
);

1457 i‡(
ªt
)

1458 
	`båfs_dr›_exã¡_m≠_ønge
(
öode
, 
°¨t
,

1459 
°¨t
 + 
øm_size
 - 1,

1460 
Ál£
);

1462 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

1464 
	`båfs_dec_block_group_ª£rv©i⁄s
(
fs_öfo
, 
ös
.
obje˘id
);

1474 
∑ge_›s
 = (
kìp_locked
 ? 0 : 
PAGE_UNLOCK
);

1475 
∑ge_›s
 |
PAGE_SET_ORDERED
;

1477 
	`exã¡_˛ór_u∆ock_dñÆloc
(
öode
, 
°¨t
, sèπ + 
øm_size
 - 1,

1478 
locked_∑ge
,

1479 
EXTENT_LOCKED
 | 
EXTENT_DELALLOC
,

1480 
∑ge_›s
);

1481 i‡(
num_byãs
 < 
cur_Æloc_size
)

1482 
num_byãs
 = 0;

1484 
num_byãs
 -
cur_Æloc_size
;

1485 
Æloc_höt
 = 
ös
.
obje˘id
 + ins.
off£t
;

1486 
°¨t
 +
cur_Æloc_size
;

1487 
exã¡_ª£rved
 = 
Ál£
;

1494 i‡(
ªt
)

1495 
out_u∆ock
;

1497 
d⁄e
:

1498 i‡(
d⁄e_off£t
)

1499 *
d⁄e_off£t
 = 
íd
;

1500  
ªt
;

1502 
out_dr›_exã¡_ˇche
:

1503 
	`båfs_dr›_exã¡_m≠_ønge
(
öode
, 
°¨t
, sèπ + 
øm_size
 - 1, 
Ál£
);

1504 
out_ª£rve
:

1505 
	`båfs_dec_block_group_ª£rv©i⁄s
(
fs_öfo
, 
ös
.
obje˘id
);

1506 
	`båfs_‰ì_ª£rved_exã¡
(
fs_öfo
, 
ös
.
obje˘id
, ins.
off£t
, 1);

1507 
out_u∆ock
:

1517 
˛ór_bôs
 = 
EXTENT_LOCKED
 | 
EXTENT_DELALLOC
 | 
EXTENT_DELALLOC_NEW
 |

1518 
EXTENT_DEFRAG
 | 
EXTENT_CLEAR_META_RESV
;

1519 
∑ge_›s
 = 
PAGE_UNLOCK
 | 
PAGE_START_WRITEBACK
 | 
PAGE_END_WRITEBACK
;

1533 i‡(
kìp_locked
 && 
‹ig_°¨t
 < 
°¨t
) {

1534 i‡(!
locked_∑ge
)

1535 
	`m≠pög_£t_îr‹
(
öode
->
vfs_öode
.
i_m≠pög
, 
ªt
);

1536 
	`exã¡_˛ór_u∆ock_dñÆloc
(
öode
, 
‹ig_°¨t
, 
°¨t
 - 1,

1537 
locked_∑ge
, 0, 
∑ge_›s
);

1550 i‡(
exã¡_ª£rved
) {

1551 
	`exã¡_˛ór_u∆ock_dñÆloc
(
öode
, 
°¨t
,

1552 
°¨t
 + 
cur_Æloc_size
 - 1,

1553 
locked_∑ge
,

1554 
˛ór_bôs
,

1555 
∑ge_›s
);

1556 
°¨t
 +
cur_Æloc_size
;

1565 i‡(
°¨t
 < 
íd
) {

1566 
˛ór_bôs
 |
EXTENT_CLEAR_DATA_RESV
;

1567 
	`exã¡_˛ór_u∆ock_dñÆloc
(
öode
, 
°¨t
, 
íd
, 
locked_∑ge
,

1568 
˛ór_bôs
, 
∑ge_›s
);

1570  
ªt
;

1571 
	}
}

1578 
noölöe
 
	$submô_com¥es£d_exã¡s
(
båfs_w‹k
 *
w‹k
)

1580 
async_chunk
 *async_chunk = 
	`c⁄èöî_of
(
w‹k
, async_chunk,

1581 
w‹k
);

1582 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_w‹k_ow√r
(
w‹k
);

1583 
async_exã¡
 *async_extent;

1584 
ƒ_∑ges
;

1585 
u64
 
Æloc_höt
 = 0;

1587 
ƒ_∑ges
 = (
async_chunk
->
íd
 -ásync_chunk->
°¨t
 + 
PAGE_SIZE
) >>

1588 
PAGE_SHIFT
;

1590 !
	`li°_em±y
(&
async_chunk
->
exã¡s
)) {

1591 
async_exã¡
 = 
	`li°_íåy
(
async_chunk
->
exã¡s
.
√xt
,

1592 
async_exã¡
, 
li°
);

1593 
	`li°_dñ
(&
async_exã¡
->
li°
);

1594 
	`submô_⁄e_async_exã¡
(
async_chunk
, 
async_exã¡
, &
Æloc_höt
);

1598 i‡(
	`©omic_sub_ªtu∫
(
ƒ_∑ges
, &
fs_öfo
->
async_dñÆloc_∑ges
) <

1599 5 * 
SZ_1M
)

1600 
	`c⁄d_wake_up_nomb
(&
fs_öfo
->
async_submô_waô
);

1601 
	}
}

1603 
noölöe
 
	$async_cow_‰ì
(
båfs_w‹k
 *
w‹k
)

1605 
async_chunk
 *async_chunk;

1606 
async_cow
 *async_cow;

1608 
async_chunk
 = 
	`c⁄èöî_of
(
w‹k
, async_chunk, work);

1609 
	`båfs_add_dñayed_ùut
(
async_chunk
->
öode
);

1610 i‡(
async_chunk
->
blkcg_css
)

1611 
	`css_put
(
async_chunk
->
blkcg_css
);

1613 
async_cow
 = 
async_chunk
->async_cow;

1614 i‡(
	`©omic_dec_™d_ã°
(&
async_cow
->
num_chunks
))

1615 
	`kv‰ì
(
async_cow
);

1616 
	}
}

1618 
boﬁ
 
	$run_dñÆloc_com¥es£d
(
båfs_öode
 *
öode
,

1619 
∑ge
 *
locked_∑ge
, 
u64
 
°¨t
,

1620 
u64
 
íd
, 
wrôeback_c⁄åﬁ
 *
wbc
)

1622 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

1623 
cgroup_subsys_°©e
 *
blkcg_css
 = 
	`wbc_blkcg_css
(
wbc
);

1624 
async_cow
 *
˘x
;

1625 
async_chunk
 *async_chunk;

1626 
ƒ_∑ges
;

1627 
u64
 
num_chunks
 = 
	`DIV_ROUND_UP
(
íd
 - 
°¨t
, 
SZ_512K
);

1628 
i
;

1629 
nofs_Êag
;

1630 c⁄° 
blk_›f_t
 
wrôe_Êags
 = 
	`wbc_to_wrôe_Êags
(
wbc
);

1632 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

1633 
˘x
 = 
	`kvmÆloc
(
	`°ru˘_size
(˘x, 
chunks
, 
num_chunks
), 
GFP_KERNEL
);

1634 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

1635 i‡(!
˘x
)

1636  
Ál£
;

1638 
	`u∆ock_exã¡
(&
öode
->
io_åì
, 
°¨t
, 
íd
, 
NULL
);

1639 
	`£t_bô
(
BTRFS_INODE_HAS_ASYNC_EXTENT
, &
öode
->
ru¡ime_Êags
);

1641 
async_chunk
 = 
˘x
->
chunks
;

1642 
	`©omic_£t
(&
˘x
->
num_chunks
,Çum_chunks);

1644 
i
 = 0; i < 
num_chunks
; i++) {

1645 
u64
 
cur_íd
 = 
	`mö
(
íd
, 
°¨t
 + 
SZ_512K
 - 1);

1651 
	`ihﬁd
(&
öode
->
vfs_öode
);

1652 
async_chunk
[
i
].
async_cow
 = 
˘x
;

1653 
async_chunk
[
i
].
öode
 = inode;

1654 
async_chunk
[
i
].
°¨t
 = start;

1655 
async_chunk
[
i
].
íd
 = 
cur_íd
;

1656 
async_chunk
[
i
].
wrôe_Êags
 = write_flags;

1657 
	`INIT_LIST_HEAD
(&
async_chunk
[
i
].
exã¡s
);

1668 i‡(
locked_∑ge
) {

1678 
	`wbc_accou¡_cgroup_ow√r
(
wbc
, 
locked_∑ge
,

1679 
cur_íd
 - 
°¨t
);

1680 
async_chunk
[
i
].
locked_∑ge
 =Üocked_page;

1681 
locked_∑ge
 = 
NULL
;

1683 
async_chunk
[
i
].
locked_∑ge
 = 
NULL
;

1686 i‡(
blkcg_css
 !
blkcg_roŸ_css
) {

1687 
	`css_gë
(
blkcg_css
);

1688 
async_chunk
[
i
].
blkcg_css
 = blkcg_css;

1689 
async_chunk
[
i
].
wrôe_Êags
 |
REQ_BTRFS_CGROUP_PUNT
;

1691 
async_chunk
[
i
].
blkcg_css
 = 
NULL
;

1694 
	`båfs_öô_w‹k
(&
async_chunk
[
i
].
w‹k
, 
com¥ess_fûe_ønge
,

1695 
submô_com¥es£d_exã¡s
, 
async_cow_‰ì
);

1697 
ƒ_∑ges
 = 
	`DIV_ROUND_UP
(
cur_íd
 - 
°¨t
, 
PAGE_SIZE
);

1698 
	`©omic_add
(
ƒ_∑ges
, &
fs_öfo
->
async_dñÆloc_∑ges
);

1700 
	`båfs_queue_w‹k
(
fs_öfo
->
dñÆloc_w‹kîs
, &
async_chunk
[
i
].
w‹k
);

1702 
°¨t
 = 
cur_íd
 + 1;

1704  
åue
;

1705 
	}
}

1711 
noölöe
 
	$run_dñÆloc_cow
(
båfs_öode
 *
öode
,

1712 
∑ge
 *
locked_∑ge
, 
u64
 
°¨t
,

1713 
u64
 
íd
, 
wrôeback_c⁄åﬁ
 *
wbc
,

1714 
boﬁ
 
∑ges_dúty
)

1716 
u64
 
d⁄e_off£t
 = 
íd
;

1717 
ªt
;

1719 
°¨t
 <
íd
) {

1720 
ªt
 = 
	`cow_fûe_ønge
(
öode
, 
locked_∑ge
, 
°¨t
, 
íd
, &
d⁄e_off£t
,

1721 
åue
, 
Ál£
);

1722 i‡(
ªt
)

1723  
ªt
;

1724 
	`exã¡_wrôe_locked_ønge
(&
öode
->
vfs_öode
, 
locked_∑ge
, 
°¨t
,

1725 
d⁄e_off£t
, 
wbc
, 
∑ges_dúty
);

1726 
°¨t
 = 
d⁄e_off£t
 + 1;

1730 
	}
}

1732 
noölöe
 
	$csum_exi°_ö_ønge
(
båfs_fs_öfo
 *
fs_öfo
,

1733 
u64
 
byãƒ
, u64 
num_byãs
, 
boﬁ
 
nowaô
)

1735 
båfs_roŸ
 *
csum_roŸ
 = 
	`båfs_csum_roŸ
(
fs_öfo
, 
byãƒ
);

1736 
båfs_‹dîed_sum
 *
sums
;

1737 
ªt
;

1738 
	`LIST_HEAD
(
li°
);

1740 
ªt
 = 
	`båfs_lookup_csums_li°
(
csum_roŸ
, 
byãƒ
, byãƒ + 
num_byãs
 - 1,

1741 &
li°
, 0, 
nowaô
);

1742 i‡(
ªt
 =0 && 
	`li°_em±y
(&
li°
))

1745 !
	`li°_em±y
(&
li°
)) {

1746 
sums
 = 
	`li°_íåy
(
li°
.
√xt
, 
båfs_‹dîed_sum
,Üist);

1747 
	`li°_dñ
(&
sums
->
li°
);

1748 
	`k‰ì
(
sums
);

1750 i‡(
ªt
 < 0)

1751  
ªt
;

1753 
	}
}

1755 
	$ÁŒback_to_cow
(
båfs_öode
 *
öode
, 
∑ge
 *
locked_∑ge
,

1756 c⁄° 
u64
 
°¨t
, c⁄° u64 
íd
)

1758 c⁄° 
boﬁ
 
is_•a˚_öo
 = 
	`båfs_is_‰ì_•a˚_öode
(
öode
);

1759 c⁄° 
boﬁ
 
is_ªloc_öo
 = 
	`båfs_is_d©a_ªloc_roŸ
(
öode
->
roŸ
);

1760 c⁄° 
u64
 
ønge_byãs
 = 
íd
 + 1 - 
°¨t
;

1761 
exã¡_io_åì
 *
io_åì
 = &
öode
->io_tree;

1762 
u64
 
ønge_°¨t
 = 
°¨t
;

1763 
u64
 
cou¡
;

1764 
ªt
;

1798 
cou¡
 = 
	`cou¡_ønge_bôs
(
io_åì
, &
ønge_°¨t
, 
íd
, 
ønge_byãs
,

1799 
EXTENT_NORESERVE
, 0, 
NULL
);

1800 i‡(
cou¡
 > 0 || 
is_•a˚_öo
 || 
is_ªloc_öo
) {

1801 
u64
 
byãs
 = 
cou¡
;

1802 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

1803 
båfs_•a˚_öfo
 *
söfo
 = 
fs_öfo
->
d©a_söfo
;

1805 i‡(
is_•a˚_öo
 || 
is_ªloc_öo
)

1806 
byãs
 = 
ønge_byãs
;

1808 
	`•ö_lock
(&
söfo
->
lock
);

1809 
	`båfs_•a˚_öfo_upd©e_byãs_may_u£
(
fs_öfo
, 
söfo
, 
byãs
);

1810 
	`•ö_u∆ock
(&
söfo
->
lock
);

1812 i‡(
cou¡
 > 0)

1813 
	`˛ór_exã¡_bô
(
io_åì
, 
°¨t
, 
íd
, 
EXTENT_NORESERVE
,

1814 
NULL
);

1822 
ªt
 = 
	`cow_fûe_ønge
(
öode
, 
locked_∑ge
, 
°¨t
, 
íd
, 
NULL
, 
Ál£
, 
åue
);

1823 
	`ASSERT
(
ªt
 != 1);

1824  
ªt
;

1825 
	}
}

1827 
	sˇn_nocow_fûe_exã¡_¨gs
 {

1831 
u64
 
	m°¨t
;

1833 
u64
 
	míd
;

1834 
boﬁ
 
	mwrôeback_∑th
;

1835 
boﬁ
 
	m°ri˘
;

1840 
boﬁ
 
	m‰ì_∑th
;

1844 
u64
 
	mdisk_byãƒ
;

1845 
u64
 
	mdisk_num_byãs
;

1846 
u64
 
	mexã¡_off£t
;

1848 
u64
 
	mnum_byãs
;

1860 
	$ˇn_nocow_fûe_exã¡
(
båfs_∑th
 *
∑th
,

1861 
båfs_key
 *
key
,

1862 
båfs_öode
 *
öode
,

1863 
ˇn_nocow_fûe_exã¡_¨gs
 *
¨gs
)

1865 c⁄° 
boﬁ
 
is_‰ì•a˚_öode
 = 
	`båfs_is_‰ì_•a˚_öode
(
öode
);

1866 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

1867 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

1868 
båfs_fûe_exã¡_ôem
 *
fi
;

1869 
u64
 
exã¡_íd
;

1870 
u8
 
exã¡_ty≥
;

1871 
ˇn_nocow
 = 0;

1872 
ªt
 = 0;

1873 
boﬁ
 
nowaô
 = 
∑th
->nowait;

1875 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_fûe_exã¡_ôem
);

1876 
exã¡_ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
fi
);

1878 i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
)

1879 
out
;

1882 
¨gs
->
disk_byãƒ
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
fi
);

1883 
¨gs
->
disk_num_byãs
 = 
	`båfs_fûe_exã¡_disk_num_byãs
(
Àaf
, 
fi
);

1884 
¨gs
->
exã¡_off£t
 = 
	`båfs_fûe_exã¡_off£t
(
Àaf
, 
fi
);

1886 i‡(!(
öode
->
Êags
 & 
BTRFS_INODE_NODATACOW
) &&

1887 
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_REG
)

1888 
out
;

1895 i‡(!
¨gs
->
°ri˘
 &&

1896 
	`båfs_fûe_exã¡_gíî©i⁄
(
Àaf
, 
fi
) <=

1897 
	`båfs_roŸ_œ°_¢≠shŸ
(&
roŸ
->
roŸ_ôem
))

1898 
out
;

1901 i‡(
¨gs
->
disk_byãƒ
 == 0)

1902 
out
;

1905 i‡(
	`båfs_fûe_exã¡_com¥essi⁄
(
Àaf
, 
fi
) ||

1906 
	`båfs_fûe_exã¡_í¸y±i⁄
(
Àaf
, 
fi
) ||

1907 
	`båfs_fûe_exã¡_Ÿhî_ícodög
(
Àaf
, 
fi
))

1908 
out
;

1910 
exã¡_íd
 = 
	`båfs_fûe_exã¡_íd
(
∑th
);

1917 
	`båfs_ªÀa£_∑th
(
∑th
);

1919 
ªt
 = 
	`båfs_¸oss_ªf_exi°
(
roŸ
, 
	`båfs_öo
(
öode
),

1920 
key
->
off£t
 - 
¨gs
->
exã¡_off£t
,

1921 
¨gs
->
disk_byãƒ
,árgs->
°ri˘
, 
∑th
);

1922 
	`WARN_ON_ONCE
(
ªt
 > 0 && 
is_‰ì•a˚_öode
);

1923 i‡(
ªt
 != 0)

1924 
out
;

1926 i‡(
¨gs
->
‰ì_∑th
) {

1933 
	`båfs_‰ì_∑th
(
∑th
);

1934 
∑th
 = 
NULL
;

1938 i‡(
¨gs
->
wrôeback_∑th
 && !
is_‰ì•a˚_öode
 &&

1939 
	`©omic_ªad
(&
roŸ
->
¢≠shŸ_f‹˚_cow
))

1940 
out
;

1942 
¨gs
->
disk_byãƒ
 +¨gs->
exã¡_off£t
;

1943 
¨gs
->
disk_byãƒ
 +¨gs->
°¨t
 - 
key
->
off£t
;

1944 
¨gs
->
num_byãs
 = 
	`mö
◊rgs->
íd
 + 1, 
exã¡_íd
Ë-árgs->
°¨t
;

1950 
ªt
 = 
	`csum_exi°_ö_ønge
(
roŸ
->
fs_öfo
, 
¨gs
->
disk_byãƒ
,árgs->
num_byãs
,

1951 
nowaô
);

1952 
	`WARN_ON_ONCE
(
ªt
 > 0 && 
is_‰ì•a˚_öode
);

1953 i‡(
ªt
 != 0)

1954 
out
;

1956 
ˇn_nocow
 = 1;

1957 
out
:

1958 i‡(
¨gs
->
‰ì_∑th
 && 
∑th
)

1959 
	`båfs_‰ì_∑th
(
∑th
);

1961  
ªt
 < 0 ?Ñë : 
ˇn_nocow
;

1962 
	}
}

1971 
noölöe
 
	$run_dñÆloc_nocow
(
båfs_öode
 *
öode
,

1972 
∑ge
 *
locked_∑ge
,

1973 c⁄° 
u64
 
°¨t
, c⁄° u64 
íd
)

1975 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

1976 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

1977 
båfs_∑th
 *
∑th
;

1978 
u64
 
cow_°¨t
 = (u64)-1;

1979 
u64
 
cur_off£t
 = 
°¨t
;

1980 
ªt
;

1981 
boﬁ
 
check_¥ev
 = 
åue
;

1982 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

1983 
ˇn_nocow_fûe_exã¡_¨gs
 
nocow_¨gs
 = { 0 };

1990 
	`ASSERT
(!
	`båfs_is_z⁄ed
(
fs_öfo
Ë|| 
	`båfs_is_d©a_ªloc_roŸ
(
roŸ
));

1992 
∑th
 = 
	`båfs_Æloc_∑th
();

1993 i‡(!
∑th
) {

1994 
ªt
 = -
ENOMEM
;

1995 
îr‹
;

1998 
nocow_¨gs
.
íd
 =Énd;

1999 
nocow_¨gs
.
wrôeback_∑th
 = 
åue
;

2002 
båfs_block_group
 *
nocow_bg
 = 
NULL
;

2003 
båfs_‹dîed_exã¡
 *
‹dîed
;

2004 
båfs_key
 
found_key
;

2005 
båfs_fûe_exã¡_ôem
 *
fi
;

2006 
exã¡_buf„r
 *
Àaf
;

2007 
u64
 
exã¡_íd
;

2008 
u64
 
øm_byãs
;

2009 
u64
 
nocow_íd
;

2010 
exã¡_ty≥
;

2011 
boﬁ
 
is_¥óŒoc
;

2013 
ªt
 = 
	`båfs_lookup_fûe_exã¡
(
NULL
, 
roŸ
, 
∑th
, 
öo
,

2014 
cur_off£t
, 0);

2015 i‡(
ªt
 < 0)

2016 
îr‹
;

2023 i‡(
ªt
 > 0 && 
∑th
->
¶Ÿs
[0] > 0 && 
check_¥ev
) {

2024 
Àaf
 = 
∑th
->
nodes
[0];

2025 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
,

2026 
∑th
->
¶Ÿs
[0] - 1);

2027 i‡(
found_key
.
obje˘id
 =
öo
 &&

2028 
found_key
.
ty≥
 =
BTRFS_EXTENT_DATA_KEY
)

2029 
∑th
->
¶Ÿs
[0]--;

2031 
check_¥ev
 = 
Ál£
;

2032 
√xt_¶Ÿ
:

2034 
Àaf
 = 
∑th
->
nodes
[0];

2035 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
(
Àaf
)) {

2036 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

2037 i‡(
ªt
 < 0)

2038 
îr‹
;

2039 i‡(
ªt
 > 0)

2041 
Àaf
 = 
∑th
->
nodes
[0];

2044 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0]);

2047 i‡(
found_key
.
obje˘id
 > 
öo
)

2053 i‡(
	`WARN_ON_ONCE
(
found_key
.
obje˘id
 < 
öo
) ||

2054 
found_key
.
ty≥
 < 
BTRFS_EXTENT_DATA_KEY
) {

2055 
∑th
->
¶Ÿs
[0]++;

2056 
√xt_¶Ÿ
;

2060 i‡(
found_key
.
ty≥
 > 
BTRFS_EXTENT_DATA_KEY
 ||

2061 
found_key
.
off£t
 > 
íd
)

2068 i‡(
found_key
.
off£t
 > 
cur_off£t
) {

2069 
exã¡_íd
 = 
found_key
.
off£t
;

2070 
exã¡_ty≥
 = 0;

2071 
mu°_cow
;

2078 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

2079 
båfs_fûe_exã¡_ôem
);

2080 
exã¡_ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
fi
);

2082 
	`ASSERT
(
exã¡_ty≥
 < 
BTRFS_NR_FILE_EXTENT_TYPES
);

2083 i‡(
	`WARN_ON
(
exã¡_ty≥
 >
BTRFS_NR_FILE_EXTENT_TYPES
)) {

2084 
ªt
 = -
EUCLEAN
;

2085 
îr‹
;

2087 
øm_byãs
 = 
	`båfs_fûe_exã¡_øm_byãs
(
Àaf
, 
fi
);

2088 
exã¡_íd
 = 
	`båfs_fûe_exã¡_íd
(
∑th
);

2094 i‡(
exã¡_íd
 <
cur_off£t
) {

2095 
∑th
->
¶Ÿs
[0]++;

2096 
√xt_¶Ÿ
;

2099 
nocow_¨gs
.
°¨t
 = 
cur_off£t
;

2100 
ªt
 = 
	`ˇn_nocow_fûe_exã¡
(
∑th
, &
found_key
, 
öode
, &
nocow_¨gs
);

2101 i‡(
ªt
 < 0)

2102 
îr‹
;

2103 i‡(
ªt
 == 0)

2104 
mu°_cow
;

2106 
ªt
 = 0;

2107 
nocow_bg
 = 
	`båfs_öc_nocow_wrôîs
(
fs_öfo
, 
nocow_¨gs
.
disk_byãƒ
);

2108 i‡(!
nocow_bg
) {

2109 
mu°_cow
:

2117 i‡(
cow_°¨t
 =(
u64
)-1)

2118 
cow_°¨t
 = 
cur_off£t
;

2119 
cur_off£t
 = 
exã¡_íd
;

2120 i‡(
cur_off£t
 > 
íd
)

2122 i‡(!
∑th
->
nodes
[0])

2124 
∑th
->
¶Ÿs
[0]++;

2125 
√xt_¶Ÿ
;

2133 i‡(
cow_°¨t
 !(
u64
)-1) {

2134 
ªt
 = 
	`ÁŒback_to_cow
(
öode
, 
locked_∑ge
,

2135 
cow_°¨t
, 
found_key
.
off£t
 - 1);

2136 
cow_°¨t
 = (
u64
)-1;

2137 i‡(
ªt
) {

2138 
	`båfs_dec_nocow_wrôîs
(
nocow_bg
);

2139 
îr‹
;

2143 
nocow_íd
 = 
cur_off£t
 + 
nocow_¨gs
.
num_byãs
 - 1;

2144 
is_¥óŒoc
 = 
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
;

2145 i‡(
is_¥óŒoc
) {

2146 
u64
 
‹ig_°¨t
 = 
found_key
.
off£t
 - 
nocow_¨gs
.
exã¡_off£t
;

2147 
exã¡_m≠
 *
em
;

2149 
em
 = 
	`¸óã_io_em
(
öode
, 
cur_off£t
, 
nocow_¨gs
.
num_byãs
,

2150 
‹ig_°¨t
,

2151 
nocow_¨gs
.
disk_byãƒ
,

2152 
nocow_¨gs
.
num_byãs
,

2153 
nocow_¨gs
.
disk_num_byãs
,

2154 
øm_byãs
, 
BTRFS_COMPRESS_NONE
,

2155 
BTRFS_ORDERED_PREALLOC
);

2156 i‡(
	`IS_ERR
(
em
)) {

2157 
	`båfs_dec_nocow_wrôîs
(
nocow_bg
);

2158 
ªt
 = 
	`PTR_ERR
(
em
);

2159 
îr‹
;

2161 
	`‰ì_exã¡_m≠
(
em
);

2164 
‹dîed
 = 
	`båfs_Æloc_‹dîed_exã¡
(
öode
, 
cur_off£t
,

2165 
nocow_¨gs
.
num_byãs
,Çocow_args.num_bytes,

2166 
nocow_¨gs
.
disk_byãƒ
,Çocow_¨gs.
num_byãs
, 0,

2167 
is_¥óŒoc


2168 ? (1 << 
BTRFS_ORDERED_PREALLOC
)

2169 : (1 << 
BTRFS_ORDERED_NOCOW
),

2170 
BTRFS_COMPRESS_NONE
);

2171 
	`båfs_dec_nocow_wrôîs
(
nocow_bg
);

2172 i‡(
	`IS_ERR
(
‹dîed
)) {

2173 i‡(
is_¥óŒoc
) {

2174 
	`båfs_dr›_exã¡_m≠_ønge
(
öode
, 
cur_off£t
,

2175 
nocow_íd
, 
Ál£
);

2177 
ªt
 = 
	`PTR_ERR
(
‹dîed
);

2178 
îr‹
;

2181 i‡(
	`båfs_is_d©a_ªloc_roŸ
(
roŸ
))

2187 
ªt
 = 
	`båfs_ªloc_˛⁄e_csums
(
‹dîed
);

2188 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

2190 
	`exã¡_˛ór_u∆ock_dñÆloc
(
öode
, 
cur_off£t
, 
nocow_íd
,

2191 
locked_∑ge
, 
EXTENT_LOCKED
 |

2192 
EXTENT_DELALLOC
 |

2193 
EXTENT_CLEAR_DATA_RESV
,

2194 
PAGE_UNLOCK
 | 
PAGE_SET_ORDERED
);

2196 
cur_off£t
 = 
exã¡_íd
;

2203 i‡(
ªt
)

2204 
îr‹
;

2205 i‡(
cur_off£t
 > 
íd
)

2208 
	`båfs_ªÀa£_∑th
(
∑th
);

2210 i‡(
cur_off£t
 <
íd
 && 
cow_°¨t
 =(
u64
)-1)

2211 
cow_°¨t
 = 
cur_off£t
;

2213 i‡(
cow_°¨t
 !(
u64
)-1) {

2214 
cur_off£t
 = 
íd
;

2215 
ªt
 = 
	`ÁŒback_to_cow
(
öode
, 
locked_∑ge
, 
cow_°¨t
, 
íd
);

2216 
cow_°¨t
 = (
u64
)-1;

2217 i‡(
ªt
)

2218 
îr‹
;

2221 
	`båfs_‰ì_∑th
(
∑th
);

2224 
îr‹
:

2230 i‡(
cow_°¨t
 !(
u64
)-1)

2231 
cur_off£t
 = 
cow_°¨t
;

2232 i‡(
cur_off£t
 < 
íd
)

2233 
	`exã¡_˛ór_u∆ock_dñÆloc
(
öode
, 
cur_off£t
, 
íd
,

2234 
locked_∑ge
, 
EXTENT_LOCKED
 |

2235 
EXTENT_DELALLOC
 | 
EXTENT_DEFRAG
 |

2236 
EXTENT_DO_ACCOUNTING
, 
PAGE_UNLOCK
 |

2237 
PAGE_START_WRITEBACK
 |

2238 
PAGE_END_WRITEBACK
);

2239 
	`båfs_‰ì_∑th
(
∑th
);

2240  
ªt
;

2241 
	}
}

2243 
boﬁ
 
	$should_nocow
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
)

2245 i‡(
öode
->
Êags
 & (
BTRFS_INODE_NODATACOW
 | 
BTRFS_INODE_PREALLOC
)) {

2246 i‡(
öode
->
de‰ag_byãs
 &&

2247 
	`ã°_ønge_bô
(&
öode
->
io_åì
, 
°¨t
, 
íd
, 
EXTENT_DEFRAG
,

2248 0, 
NULL
))

2249  
Ál£
;

2250  
åue
;

2252  
Ál£
;

2253 
	}
}

2259 
	$båfs_run_dñÆloc_ønge
(
båfs_öode
 *
öode
, 
∑ge
 *
locked_∑ge
,

2260 
u64
 
°¨t
, u64 
íd
, 
wrôeback_c⁄åﬁ
 *
wbc
)

2262 c⁄° 
boﬁ
 
z⁄ed
 = 
	`båfs_is_z⁄ed
(
öode
->
roŸ
->
fs_öfo
);

2263 
ªt
;

2269 
	`ASSERT
(!(
íd
 <
	`∑ge_off£t
(
locked_∑ge
) ||

2270 
°¨t
 >
	`∑ge_off£t
(
locked_∑ge
Ë+ 
PAGE_SIZE
));

2272 i‡(
	`should_nocow
(
öode
, 
°¨t
, 
íd
)) {

2273 
ªt
 = 
	`run_dñÆloc_nocow
(
öode
, 
locked_∑ge
, 
°¨t
, 
íd
);

2274 
out
;

2277 i‡(
	`båfs_öode_ˇn_com¥ess
(
öode
) &&

2278 
	`öode_√ed_com¥ess
(
öode
, 
°¨t
, 
íd
) &&

2279 
	`run_dñÆloc_com¥es£d
(
öode
, 
locked_∑ge
, 
°¨t
, 
íd
, 
wbc
))

2282 i‡(
z⁄ed
)

2283 
ªt
 = 
	`run_dñÆloc_cow
(
öode
, 
locked_∑ge
, 
°¨t
, 
íd
, 
wbc
,

2284 
åue
);

2286 
ªt
 = 
	`cow_fûe_ønge
(
öode
, 
locked_∑ge
, 
°¨t
, 
íd
, 
NULL
,

2287 
Ál£
, false);

2289 
out
:

2290 i‡(
ªt
 < 0)

2291 
	`båfs_˛ónup_‹dîed_exã¡s
(
öode
, 
locked_∑ge
, 
°¨t
,

2292 
íd
 - 
°¨t
 + 1);

2293  
ªt
;

2294 
	}
}

2296 
	$båfs_•lô_dñÆloc_exã¡
(
båfs_öode
 *
öode
,

2297 
exã¡_°©e
 *
‹ig
, 
u64
 
•lô
)

2299 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

2300 
u64
 
size
;

2303 i‡(!(
‹ig
->
°©e
 & 
EXTENT_DELALLOC
))

2306 
size
 = 
‹ig
->
íd
 - orig->
°¨t
 + 1;

2307 i‡(
size
 > 
fs_öfo
->
max_exã¡_size
) {

2308 
u32
 
num_exã¡s
;

2309 
u64
 
√w_size
;

2315 
√w_size
 = 
‹ig
->
íd
 - 
•lô
 + 1;

2316 
num_exã¡s
 = 
	`cou¡_max_exã¡s
(
fs_öfo
, 
√w_size
);

2317 
√w_size
 = 
•lô
 - 
‹ig
->
°¨t
;

2318 
num_exã¡s
 +
	`cou¡_max_exã¡s
(
fs_öfo
, 
√w_size
);

2319 i‡(
	`cou¡_max_exã¡s
(
fs_öfo
, 
size
Ë>
num_exã¡s
)

2323 
	`•ö_lock
(&
öode
->
lock
);

2324 
	`båfs_mod_out°™dög_exã¡s
(
öode
, 1);

2325 
	`•ö_u∆ock
(&
öode
->
lock
);

2326 
	}
}

2333 
	$båfs_mîge_dñÆloc_exã¡
(
båfs_öode
 *
öode
, 
exã¡_°©e
 *
√w
,

2334 
exã¡_°©e
 *
Ÿhî
)

2336 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

2337 
u64
 
√w_size
, 
ﬁd_size
;

2338 
u32
 
num_exã¡s
;

2341 i‡(!(
Ÿhî
->
°©e
 & 
EXTENT_DELALLOC
))

2344 i‡(
√w
->
°¨t
 > 
Ÿhî
->start)

2345 
√w_size
 = 
√w
->
íd
 - 
Ÿhî
->
°¨t
 + 1;

2347 
√w_size
 = 
Ÿhî
->
íd
 - 
√w
->
°¨t
 + 1;

2350 i‡(
√w_size
 <
fs_öfo
->
max_exã¡_size
) {

2351 
	`•ö_lock
(&
öode
->
lock
);

2352 
	`båfs_mod_out°™dög_exã¡s
(
öode
, -1);

2353 
	`•ö_u∆ock
(&
öode
->
lock
);

2375 
ﬁd_size
 = 
Ÿhî
->
íd
 - othî->
°¨t
 + 1;

2376 
num_exã¡s
 = 
	`cou¡_max_exã¡s
(
fs_öfo
, 
ﬁd_size
);

2377 
ﬁd_size
 = 
√w
->
íd
 -Çew->
°¨t
 + 1;

2378 
num_exã¡s
 +
	`cou¡_max_exã¡s
(
fs_öfo
, 
ﬁd_size
);

2379 i‡(
	`cou¡_max_exã¡s
(
fs_öfo
, 
√w_size
Ë>
num_exã¡s
)

2382 
	`•ö_lock
(&
öode
->
lock
);

2383 
	`båfs_mod_out°™dög_exã¡s
(
öode
, -1);

2384 
	`•ö_u∆ock
(&
öode
->
lock
);

2385 
	}
}

2387 
	$båfs_add_dñÆloc_öodes
(
båfs_roŸ
 *
roŸ
,

2388 
båfs_öode
 *
öode
)

2390 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

2392 
	`•ö_lock
(&
roŸ
->
dñÆloc_lock
);

2393 i‡(
	`li°_em±y
(&
öode
->
dñÆloc_öodes
)) {

2394 
	`li°_add_èû
(&
öode
->
dñÆloc_öodes
, &
roŸ
->delalloc_inodes);

2395 
	`£t_bô
(
BTRFS_INODE_IN_DELALLOC_LIST
, &
öode
->
ru¡ime_Êags
);

2396 
roŸ
->
ƒ_dñÆloc_öodes
++;

2397 i‡(
roŸ
->
ƒ_dñÆloc_öodes
 == 1) {

2398 
	`•ö_lock
(&
fs_öfo
->
dñÆloc_roŸ_lock
);

2399 
	`BUG_ON
(!
	`li°_em±y
(&
roŸ
->
dñÆloc_roŸ
));

2400 
	`li°_add_èû
(&
roŸ
->
dñÆloc_roŸ
,

2401 &
fs_öfo
->
dñÆloc_roŸs
);

2402 
	`•ö_u∆ock
(&
fs_öfo
->
dñÆloc_roŸ_lock
);

2405 
	`•ö_u∆ock
(&
roŸ
->
dñÆloc_lock
);

2406 
	}
}

2408 
	$__båfs_dñ_dñÆloc_öode
(
båfs_roŸ
 *
roŸ
,

2409 
båfs_öode
 *
öode
)

2411 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

2413 i‡(!
	`li°_em±y
(&
öode
->
dñÆloc_öodes
)) {

2414 
	`li°_dñ_öô
(&
öode
->
dñÆloc_öodes
);

2415 
	`˛ór_bô
(
BTRFS_INODE_IN_DELALLOC_LIST
,

2416 &
öode
->
ru¡ime_Êags
);

2417 
roŸ
->
ƒ_dñÆloc_öodes
--;

2418 i‡(!
roŸ
->
ƒ_dñÆloc_öodes
) {

2419 
	`ASSERT
(
	`li°_em±y
(&
roŸ
->
dñÆloc_öodes
));

2420 
	`•ö_lock
(&
fs_öfo
->
dñÆloc_roŸ_lock
);

2421 
	`BUG_ON
(
	`li°_em±y
(&
roŸ
->
dñÆloc_roŸ
));

2422 
	`li°_dñ_öô
(&
roŸ
->
dñÆloc_roŸ
);

2423 
	`•ö_u∆ock
(&
fs_öfo
->
dñÆloc_roŸ_lock
);

2426 
	}
}

2428 
	$båfs_dñ_dñÆloc_öode
(
båfs_roŸ
 *
roŸ
,

2429 
båfs_öode
 *
öode
)

2431 
	`•ö_lock
(&
roŸ
->
dñÆloc_lock
);

2432 
	`__båfs_dñ_dñÆloc_öode
(
roŸ
, 
öode
);

2433 
	`•ö_u∆ock
(&
roŸ
->
dñÆloc_lock
);

2434 
	}
}

2440 
	$båfs_£t_dñÆloc_exã¡
(
båfs_öode
 *
öode
, 
exã¡_°©e
 *
°©e
,

2441 
u32
 
bôs
)

2443 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

2445 i‡((
bôs
 & 
EXTENT_DEFRAG
Ë&& !(bô†& 
EXTENT_DELALLOC
))

2446 
	`WARN_ON
(1);

2452 i‡(!(
°©e
->°©ê& 
EXTENT_DELALLOC
Ë&& (
bôs
 & EXTENT_DELALLOC)) {

2453 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

2454 
u64
 
Àn
 = 
°©e
->
íd
 + 1 - sèã->
°¨t
;

2455 
u32
 
num_exã¡s
 = 
	`cou¡_max_exã¡s
(
fs_öfo
, 
Àn
);

2456 
boﬁ
 
do_li°
 = !
	`båfs_is_‰ì_•a˚_öode
(
öode
);

2458 
	`•ö_lock
(&
öode
->
lock
);

2459 
	`båfs_mod_out°™dög_exã¡s
(
öode
, 
num_exã¡s
);

2460 
	`•ö_u∆ock
(&
öode
->
lock
);

2463 i‡(
	`båfs_is_ã°ög
(
fs_öfo
))

2466 
	`≥r˝u_cou¡î_add_b©ch
(&
fs_öfo
->
dñÆloc_byãs
, 
Àn
,

2467 
fs_öfo
->
dñÆloc_b©ch
);

2468 
	`•ö_lock
(&
öode
->
lock
);

2469 
öode
->
dñÆloc_byãs
 +
Àn
;

2470 i‡(
bôs
 & 
EXTENT_DEFRAG
)

2471 
öode
->
de‰ag_byãs
 +
Àn
;

2472 i‡(
do_li°
 && !
	`ã°_bô
(
BTRFS_INODE_IN_DELALLOC_LIST
,

2473 &
öode
->
ru¡ime_Êags
))

2474 
	`båfs_add_dñÆloc_öodes
(
roŸ
, 
öode
);

2475 
	`•ö_u∆ock
(&
öode
->
lock
);

2478 i‡(!(
°©e
->°©ê& 
EXTENT_DELALLOC_NEW
) &&

2479 (
bôs
 & 
EXTENT_DELALLOC_NEW
)) {

2480 
	`•ö_lock
(&
öode
->
lock
);

2481 
öode
->
√w_dñÆloc_byãs
 +
°©e
->
íd
 + 1 - sèã->
°¨t
;

2482 
	`•ö_u∆ock
(&
öode
->
lock
);

2484 
	}
}

2490 
	$båfs_˛ór_dñÆloc_exã¡
(
båfs_öode
 *
öode
,

2491 
exã¡_°©e
 *
°©e
, 
u32
 
bôs
)

2493 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

2494 
u64
 
Àn
 = 
°©e
->
íd
 + 1 - sèã->
°¨t
;

2495 
u32
 
num_exã¡s
 = 
	`cou¡_max_exã¡s
(
fs_öfo
, 
Àn
);

2497 i‡((
°©e
->°©ê& 
EXTENT_DEFRAG
Ë&& (
bôs
 & EXTENT_DEFRAG)) {

2498 
	`•ö_lock
(&
öode
->
lock
);

2499 
öode
->
de‰ag_byãs
 -
Àn
;

2500 
	`•ö_u∆ock
(&
öode
->
lock
);

2508 i‡((
°©e
->°©ê& 
EXTENT_DELALLOC
Ë&& (
bôs
 & EXTENT_DELALLOC)) {

2509 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

2510 
boﬁ
 
do_li°
 = !
	`båfs_is_‰ì_•a˚_öode
(
öode
);

2512 
	`•ö_lock
(&
öode
->
lock
);

2513 
	`båfs_mod_out°™dög_exã¡s
(
öode
, -
num_exã¡s
);

2514 
	`•ö_u∆ock
(&
öode
->
lock
);

2521 i‡(
bôs
 & 
EXTENT_CLEAR_META_RESV
 &&

2522 
roŸ
 !
fs_öfo
->
åì_roŸ
)

2523 
	`båfs_dñÆloc_ªÀa£_mëad©a
(
öode
, 
Àn
, 
Ál£
);

2526 i‡(
	`båfs_is_ã°ög
(
fs_öfo
))

2529 i‡(!
	`båfs_is_d©a_ªloc_roŸ
(
roŸ
) &&

2530 
do_li°
 && !(
°©e
->°©ê& 
EXTENT_NORESERVE
) &&

2531 (
bôs
 & 
EXTENT_CLEAR_DATA_RESV
))

2532 
	`båfs_‰ì_ª£rved_d©a_•a˚_noquŸa
(
fs_öfo
, 
Àn
);

2534 
	`≥r˝u_cou¡î_add_b©ch
(&
fs_öfo
->
dñÆloc_byãs
, -
Àn
,

2535 
fs_öfo
->
dñÆloc_b©ch
);

2536 
	`•ö_lock
(&
öode
->
lock
);

2537 
öode
->
dñÆloc_byãs
 -
Àn
;

2538 i‡(
do_li°
 && 
öode
->
dñÆloc_byãs
 == 0 &&

2539 
	`ã°_bô
(
BTRFS_INODE_IN_DELALLOC_LIST
,

2540 &
öode
->
ru¡ime_Êags
))

2541 
	`båfs_dñ_dñÆloc_öode
(
roŸ
, 
öode
);

2542 
	`•ö_u∆ock
(&
öode
->
lock
);

2545 i‡((
°©e
->°©ê& 
EXTENT_DELALLOC_NEW
) &&

2546 (
bôs
 & 
EXTENT_DELALLOC_NEW
)) {

2547 
	`•ö_lock
(&
öode
->
lock
);

2548 
	`ASSERT
(
öode
->
√w_dñÆloc_byãs
 >
Àn
);

2549 
öode
->
√w_dñÆloc_byãs
 -
Àn
;

2550 i‡(
bôs
 & 
EXTENT_ADD_INODE_BYTES
)

2551 
	`öode_add_byãs
(&
öode
->
vfs_öode
, 
Àn
);

2552 
	`•ö_u∆ock
(&
öode
->
lock
);

2554 
	}
}

2556 
	$båfs_exåa˘_‹dîed_exã¡
(
båfs_bio
 *
bbio
,

2557 
båfs_‹dîed_exã¡
 *
‹dîed
)

2559 
u64
 
°¨t
 = (u64)
bbio
->
bio
.
bi_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
;

2560 
u64
 
Àn
 = 
bbio
->
bio
.
bi_ôî
.
bi_size
;

2561 
båfs_‹dîed_exã¡
 *
√w
;

2562 
ªt
;

2565 i‡(
	`WARN_ON_ONCE
(
°¨t
 !
‹dîed
->
disk_byãƒ
))

2566  -
EINVAL
;

2569 i‡(
‹dîed
->
disk_num_byãs
 =
Àn
) {

2570 
	`ªfcou¡_öc
(&
‹dîed
->
ªfs
);

2571 
bbio
->
‹dîed
 = ordered;

2579 i‡(!
	`ã°_bô
(
BTRFS_ORDERED_NOCOW
, &
‹dîed
->
Êags
)) {

2580 
ªt
 = 
	`•lô_exã¡_m≠
(
bbio
->
öode
, bbio->
fûe_off£t
,

2581 
‹dîed
->
num_byãs
, 
Àn
,

2582 
‹dîed
->
disk_byãƒ
);

2583 i‡(
ªt
)

2584  
ªt
;

2587 
√w
 = 
	`båfs_•lô_‹dîed_exã¡
(
‹dîed
, 
Àn
);

2588 i‡(
	`IS_ERR
(
√w
))

2589  
	`PTR_ERR
(
√w
);

2590 
bbio
->
‹dîed
 = 
√w
;

2592 
	}
}

2598 
	$add_≥ndög_csums
(
båfs_å™s_h™dÀ
 *
å™s
,

2599 
li°_hód
 *
li°
)

2601 
båfs_‹dîed_sum
 *
sum
;

2602 
båfs_roŸ
 *
csum_roŸ
 = 
NULL
;

2603 
ªt
;

2605 
	`li°_f‹_óch_íåy
(
sum
, 
li°
,Üist) {

2606 
å™s
->
addög_csums
 = 
åue
;

2607 i‡(!
csum_roŸ
)

2608 
csum_roŸ
 = 
	`båfs_csum_roŸ
(
å™s
->
fs_öfo
,

2609 
sum
->
logiˇl
);

2610 
ªt
 = 
	`båfs_csum_fûe_blocks
(
å™s
, 
csum_roŸ
, 
sum
);

2611 
å™s
->
addög_csums
 = 
Ál£
;

2612 i‡(
ªt
)

2613  
ªt
;

2616 
	}
}

2618 
	$båfs_föd_√w_dñÆloc_byãs
(
båfs_öode
 *
öode
,

2619 c⁄° 
u64
 
°¨t
,

2620 c⁄° 
u64
 
Àn
,

2621 
exã¡_°©e
 **
ˇched_°©e
)

2623 
u64
 
£¨ch_°¨t
 = 
°¨t
;

2624 c⁄° 
u64
 
íd
 = 
°¨t
 + 
Àn
 - 1;

2626 
£¨ch_°¨t
 < 
íd
) {

2627 c⁄° 
u64
 
£¨ch_Àn
 = 
íd
 - 
£¨ch_°¨t
 + 1;

2628 
exã¡_m≠
 *
em
;

2629 
u64
 
em_Àn
;

2630 
ªt
 = 0;

2632 
em
 = 
	`båfs_gë_exã¡
(
öode
, 
NULL
, 0, 
£¨ch_°¨t
, 
£¨ch_Àn
);

2633 i‡(
	`IS_ERR
(
em
))

2634  
	`PTR_ERR
(
em
);

2636 i‡(
em
->
block_°¨t
 !
EXTENT_MAP_HOLE
)

2637 
√xt
;

2639 
em_Àn
 = 
em
->
Àn
;

2640 i‡(
em
->
°¨t
 < 
£¨ch_°¨t
)

2641 
em_Àn
 -
£¨ch_°¨t
 - 
em
->
°¨t
;

2642 i‡(
em_Àn
 > 
£¨ch_Àn
)

2643 
em_Àn
 = 
£¨ch_Àn
;

2645 
ªt
 = 
	`£t_exã¡_bô
(&
öode
->
io_åì
, 
£¨ch_°¨t
,

2646 
£¨ch_°¨t
 + 
em_Àn
 - 1,

2647 
EXTENT_DELALLOC_NEW
, 
ˇched_°©e
);

2648 
√xt
:

2649 
£¨ch_°¨t
 = 
	`exã¡_m≠_íd
(
em
);

2650 
	`‰ì_exã¡_m≠
(
em
);

2651 i‡(
ªt
)

2652  
ªt
;

2655 
	}
}

2657 
	$båfs_£t_exã¡_dñÆloc
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
,

2658 
exåa_bôs
,

2659 
exã¡_°©e
 **
ˇched_°©e
)

2661 
	`WARN_ON
(
	`PAGE_ALIGNED
(
íd
));

2663 i‡(
°¨t
 >
	`i_size_ªad
(&
öode
->
vfs_öode
) &&

2664 !(
öode
->
Êags
 & 
BTRFS_INODE_PREALLOC
)) {

2669 
exåa_bôs
 |
EXTENT_DELALLOC_NEW
;

2671 
ªt
;

2673 
ªt
 = 
	`båfs_föd_√w_dñÆloc_byãs
(
öode
, 
°¨t
,

2674 
íd
 + 1 - 
°¨t
,

2675 
ˇched_°©e
);

2676 i‡(
ªt
)

2677  
ªt
;

2680  
	`£t_exã¡_bô
(&
öode
->
io_åì
, 
°¨t
, 
íd
,

2681 
EXTENT_DELALLOC
 | 
exåa_bôs
, 
ˇched_°©e
);

2682 
	}
}

2685 
	sbåfs_wrôïage_fixup
 {

2686 
∑ge
 *
	m∑ge
;

2687 
båfs_öode
 *
	möode
;

2688 
båfs_w‹k
 
	mw‹k
;

2691 
	$båfs_wrôïage_fixup_w‹kî
(
båfs_w‹k
 *
w‹k
)

2693 
båfs_wrôïage_fixup
 *
fixup
 =

2694 
	`c⁄èöî_of
(
w‹k
, 
båfs_wrôïage_fixup
, work);

2695 
båfs_‹dîed_exã¡
 *
‹dîed
;

2696 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

2697 
exã¡_ch™ge£t
 *
d©a_ª£rved
 = 
NULL
;

2698 
∑ge
 *∑gê
fixup
->page;

2699 
båfs_öode
 *
öode
 = 
fixup
->inode;

2700 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

2701 
u64
 
∑ge_°¨t
 = 
	`∑ge_off£t
(
∑ge
);

2702 
u64
 
∑ge_íd
 = 
	`∑ge_off£t
(
∑ge
Ë+ 
PAGE_SIZE
 - 1;

2703 
ªt
 = 0;

2704 
boﬁ
 
‰ì_dñÆloc_•a˚
 = 
åue
;

2710 
ªt
 = 
	`båfs_dñÆloc_ª£rve_•a˚
(
öode
, &
d©a_ª£rved
, 
∑ge_°¨t
,

2711 
PAGE_SIZE
);

2712 
agaö
:

2713 
	`lock_∑ge
(
∑ge
);

2720 i‡(!
∑ge
->
m≠pög
 || !
	`PageDúty
’ageË|| !
	`PageChecked
(page)) {

2738 i‡(!
ªt
) {

2739 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
öode
, 
PAGE_SIZE
);

2740 
	`båfs_dñÆloc_ªÀa£_•a˚
(
öode
, 
d©a_ª£rved
,

2741 
∑ge_°¨t
, 
PAGE_SIZE
,

2742 
åue
);

2744 
ªt
 = 0;

2745 
out_∑ge
;

2752 i‡(
ªt
)

2753 
out_∑ge
;

2755 
	`lock_exã¡
(&
öode
->
io_åì
, 
∑ge_°¨t
, 
∑ge_íd
, &
ˇched_°©e
);

2758 i‡(
	`PageOrdîed
(
∑ge
))

2759 
out_ª£rved
;

2761 
‹dîed
 = 
	`båfs_lookup_‹dîed_ønge
(
öode
, 
∑ge_°¨t
, 
PAGE_SIZE
);

2762 i‡(
‹dîed
) {

2763 
	`u∆ock_exã¡
(&
öode
->
io_åì
, 
∑ge_°¨t
, 
∑ge_íd
,

2764 &
ˇched_°©e
);

2765 
	`u∆ock_∑ge
(
∑ge
);

2766 
	`båfs_°¨t_‹dîed_exã¡
(
‹dîed
);

2767 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

2768 
agaö
;

2771 
ªt
 = 
	`båfs_£t_exã¡_dñÆloc
(
öode
, 
∑ge_°¨t
, 
∑ge_íd
, 0,

2772 &
ˇched_°©e
);

2773 i‡(
ªt
)

2774 
out_ª£rved
;

2783 
	`BUG_ON
(!
	`PageDúty
(
∑ge
));

2784 
‰ì_dñÆloc_•a˚
 = 
Ál£
;

2785 
out_ª£rved
:

2786 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
öode
, 
PAGE_SIZE
);

2787 i‡(
‰ì_dñÆloc_•a˚
)

2788 
	`båfs_dñÆloc_ªÀa£_•a˚
(
öode
, 
d©a_ª£rved
, 
∑ge_°¨t
,

2789 
PAGE_SIZE
, 
åue
);

2790 
	`u∆ock_exã¡
(&
öode
->
io_åì
, 
∑ge_°¨t
, 
∑ge_íd
, &
ˇched_°©e
);

2791 
out_∑ge
:

2792 i‡(
ªt
) {

2797 
	`m≠pög_£t_îr‹
(
∑ge
->
m≠pög
, 
ªt
);

2798 
	`båfs_m¨k_‹dîed_io_föished
(
öode
, 
∑ge
, 
∑ge_°¨t
,

2799 
PAGE_SIZE
, !
ªt
);

2800 
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
);

2802 
	`båfs_∑ge_˛ór_checked
(
fs_öfo
, 
∑ge
, 
∑ge_°¨t
, 
PAGE_SIZE
);

2803 
	`u∆ock_∑ge
(
∑ge
);

2804 
	`put_∑ge
(
∑ge
);

2805 
	`k‰ì
(
fixup
);

2806 
	`exã¡_ch™ge£t_‰ì
(
d©a_ª£rved
);

2812 
	`båfs_add_dñayed_ùut
(
öode
);

2813 
	}
}

2826 
	$båfs_wrôïage_cow_fixup
(
∑ge
 *page)

2828 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

2829 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

2830 
båfs_wrôïage_fixup
 *
fixup
;

2833 i‡(
	`PageOrdîed
(
∑ge
))

2843 i‡(
	`PageChecked
(
∑ge
))

2844  -
EAGAIN
;

2846 
fixup
 = 
	`kzÆloc
((*fixup), 
GFP_NOFS
);

2847 i‡(!
fixup
)

2848  -
EAGAIN
;

2856 
	`ihﬁd
(
öode
);

2857 
	`båfs_∑ge_£t_checked
(
fs_öfo
, 
∑ge
, 
	`∑ge_off£t
’age), 
PAGE_SIZE
);

2858 
	`gë_∑ge
(
∑ge
);

2859 
	`båfs_öô_w‹k
(&
fixup
->
w‹k
, 
båfs_wrôïage_fixup_w‹kî
, 
NULL
, NULL);

2860 
fixup
->
∑ge
 =Öage;

2861 
fixup
->
öode
 = 
	`BTRFS_I
(inode);

2862 
	`båfs_queue_w‹k
(
fs_öfo
->
fixup_w‹kîs
, &
fixup
->
w‹k
);

2864  -
EAGAIN
;

2865 
	}
}

2867 
	$ö£π_ª£rved_fûe_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

2868 
båfs_öode
 *
öode
, 
u64
 
fûe_pos
,

2869 
båfs_fûe_exã¡_ôem
 *
°ack_fi
,

2870 c⁄° 
boﬁ
 
upd©e_öode_byãs
,

2871 
u64
 
qgroup_ª£rved
)

2873 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

2874 c⁄° 
u64
 
£˘‹size
 = 
roŸ
->
fs_öfo
->sectorsize;

2875 
båfs_∑th
 *
∑th
;

2876 
exã¡_buf„r
 *
Àaf
;

2877 
båfs_key
 
ös
;

2878 
u64
 
disk_num_byãs
 = 
	`båfs_°ack_fûe_exã¡_disk_num_byãs
(
°ack_fi
);

2879 
u64
 
disk_byãƒ
 = 
	`båfs_°ack_fûe_exã¡_disk_byãƒ
(
°ack_fi
);

2880 
u64
 
off£t
 = 
	`båfs_°ack_fûe_exã¡_off£t
(
°ack_fi
);

2881 
u64
 
num_byãs
 = 
	`båfs_°ack_fûe_exã¡_num_byãs
(
°ack_fi
);

2882 
u64
 
øm_byãs
 = 
	`båfs_°ack_fûe_exã¡_øm_byãs
(
°ack_fi
);

2883 
båfs_dr›_exã¡s_¨gs
 
dr›_¨gs
 = { 0 };

2884 
ªt
;

2886 
∑th
 = 
	`båfs_Æloc_∑th
();

2887 i‡(!
∑th
)

2888  -
ENOMEM
;

2899 
dr›_¨gs
.
∑th
 =Öath;

2900 
dr›_¨gs
.
°¨t
 = 
fûe_pos
;

2901 
dr›_¨gs
.
íd
 = 
fûe_pos
 + 
num_byãs
;

2902 
dr›_¨gs
.
ª∂a˚_exã¡
 = 
åue
;

2903 
dr›_¨gs
.
exã¡_ôem_size
 = (*
°ack_fi
);

2904 
ªt
 = 
	`båfs_dr›_exã¡s
(
å™s
, 
roŸ
, 
öode
, &
dr›_¨gs
);

2905 i‡(
ªt
)

2906 
out
;

2908 i‡(!
dr›_¨gs
.
exã¡_ö£πed
) {

2909 
ös
.
obje˘id
 = 
	`båfs_öo
(
öode
);

2910 
ös
.
off£t
 = 
fûe_pos
;

2911 
ös
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

2913 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
ös
,

2914 (*
°ack_fi
));

2915 i‡(
ªt
)

2916 
out
;

2918 
Àaf
 = 
∑th
->
nodes
[0];

2919 
	`båfs_£t_°ack_fûe_exã¡_gíî©i⁄
(
°ack_fi
, 
å™s
->
å™sid
);

2920 
	`wrôe_exã¡_buf„r
(
Àaf
, 
°ack_fi
,

2921 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]),

2922 (
båfs_fûe_exã¡_ôem
));

2924 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

2925 
	`båfs_ªÀa£_∑th
(
∑th
);

2934 i‡(
fûe_pos
 =0 && !
	`IS_ALIGNED
(
dr›_¨gs
.
byãs_found
, 
£˘‹size
)) {

2935 
u64
 
ölöe_size
 = 
	`round_down
(
dr›_¨gs
.
byãs_found
, 
£˘‹size
);

2937 
ölöe_size
 = 
dr›_¨gs
.
byãs_found
 - inline_size;

2938 
	`båfs_upd©e_öode_byãs
(
öode
, 
£˘‹size
, 
ölöe_size
);

2939 
dr›_¨gs
.
byãs_found
 -
ölöe_size
;

2940 
num_byãs
 -
£˘‹size
;

2943 i‡(
upd©e_öode_byãs
)

2944 
	`båfs_upd©e_öode_byãs
(
öode
, 
num_byãs
, 
dr›_¨gs
.
byãs_found
);

2946 
ös
.
obje˘id
 = 
disk_byãƒ
;

2947 
ös
.
off£t
 = 
disk_num_byãs
;

2948 
ös
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

2950 
ªt
 = 
	`båfs_öode_£t_fûe_exã¡_ønge
(
öode
, 
fûe_pos
, 
øm_byãs
);

2951 i‡(
ªt
)

2952 
out
;

2954 
ªt
 = 
	`båfs_Æloc_ª£rved_fûe_exã¡
(
å™s
, 
roŸ
, 
	`båfs_öo
(
öode
),

2955 
fûe_pos
 - 
off£t
,

2956 
qgroup_ª£rved
, &
ös
);

2957 
out
:

2958 
	`båfs_‰ì_∑th
(
∑th
);

2960  
ªt
;

2961 
	}
}

2963 
	$båfs_ªÀa£_dñÆloc_byãs
(
båfs_fs_öfo
 *
fs_öfo
,

2964 
u64
 
°¨t
, u64 
Àn
)

2966 
båfs_block_group
 *
ˇche
;

2968 
ˇche
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
°¨t
);

2969 
	`ASSERT
(
ˇche
);

2971 
	`•ö_lock
(&
ˇche
->
lock
);

2972 
ˇche
->
dñÆloc_byãs
 -
Àn
;

2973 
	`•ö_u∆ock
(&
ˇche
->
lock
);

2975 
	`båfs_put_block_group
(
ˇche
);

2976 
	}
}

2978 
	$ö£π_‹dîed_exã¡_fûe_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

2979 
båfs_‹dîed_exã¡
 *
€
)

2981 
båfs_fûe_exã¡_ôem
 
°ack_fi
;

2982 
boﬁ
 
upd©e_öode_byãs
;

2983 
u64
 
num_byãs
 = 
€
->num_bytes;

2984 
u64
 
øm_byãs
 = 
€
->ram_bytes;

2986 
	`mem£t
(&
°ack_fi
, 0, (stack_fi));

2987 
	`båfs_£t_°ack_fûe_exã¡_ty≥
(&
°ack_fi
, 
BTRFS_FILE_EXTENT_REG
);

2988 
	`båfs_£t_°ack_fûe_exã¡_disk_byãƒ
(&
°ack_fi
, 
€
->
disk_byãƒ
);

2989 
	`båfs_£t_°ack_fûe_exã¡_disk_num_byãs
(&
°ack_fi
,

2990 
€
->
disk_num_byãs
);

2991 
	`båfs_£t_°ack_fûe_exã¡_off£t
(&
°ack_fi
, 
€
->
off£t
);

2992 i‡(
	`ã°_bô
(
BTRFS_ORDERED_TRUNCATED
, &
€
->
Êags
)) {

2993 
num_byãs
 = 
€
->
åunˇãd_Àn
;

2994 
øm_byãs
 = 
num_byãs
;

2996 
	`båfs_£t_°ack_fûe_exã¡_num_byãs
(&
°ack_fi
, 
num_byãs
);

2997 
	`båfs_£t_°ack_fûe_exã¡_øm_byãs
(&
°ack_fi
, 
øm_byãs
);

2998 
	`båfs_£t_°ack_fûe_exã¡_com¥essi⁄
(&
°ack_fi
, 
€
->
com¥ess_ty≥
);

3007 
upd©e_öode_byãs
 = 
	`ã°_bô
(
BTRFS_ORDERED_DIRECT
, &
€
->
Êags
) ||

3008 
	`ã°_bô
(
BTRFS_ORDERED_ENCODED
, &
€
->
Êags
) ||

3009 
	`ã°_bô
(
BTRFS_ORDERED_TRUNCATED
, &
€
->
Êags
);

3011  
	`ö£π_ª£rved_fûe_exã¡
(
å™s
, 
	`BTRFS_I
(
€
->
öode
),

3012 
€
->
fûe_off£t
, &
°ack_fi
,

3013 
upd©e_öode_byãs
, 
€
->
qgroup_rsv
);

3014 
	}
}

3021 
	$båfs_föish_⁄e_‹dîed
(
båfs_‹dîed_exã¡
 *
‹dîed_exã¡
)

3023 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
‹dîed_exã¡
->inode);

3024 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

3025 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

3026 
båfs_å™s_h™dÀ
 *
å™s
 = 
NULL
;

3027 
exã¡_io_åì
 *
io_åì
 = &
öode
->io_tree;

3028 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

3029 
u64
 
°¨t
, 
íd
;

3030 
com¥ess_ty≥
 = 0;

3031 
ªt
 = 0;

3032 
u64
 
logiˇl_Àn
 = 
‹dîed_exã¡
->
num_byãs
;

3033 
boﬁ
 
‰ì•a˚_öode
;

3034 
boﬁ
 
åunˇãd
 = 
Ál£
;

3035 
boﬁ
 
˛ór_ª£rved_exã¡
 = 
åue
;

3036 
˛ór_bôs
 = 
EXTENT_DEFRAG
;

3038 
°¨t
 = 
‹dîed_exã¡
->
fûe_off£t
;

3039 
íd
 = 
°¨t
 + 
‹dîed_exã¡
->
num_byãs
 - 1;

3041 i‡(!
	`ã°_bô
(
BTRFS_ORDERED_NOCOW
, &
‹dîed_exã¡
->
Êags
) &&

3042 !
	`ã°_bô
(
BTRFS_ORDERED_PREALLOC
, &
‹dîed_exã¡
->
Êags
) &&

3043 !
	`ã°_bô
(
BTRFS_ORDERED_DIRECT
, &
‹dîed_exã¡
->
Êags
) &&

3044 !
	`ã°_bô
(
BTRFS_ORDERED_ENCODED
, &
‹dîed_exã¡
->
Êags
))

3045 
˛ór_bôs
 |
EXTENT_DELALLOC_NEW
;

3047 
‰ì•a˚_öode
 = 
	`båfs_is_‰ì_•a˚_öode
(
öode
);

3048 i‡(!
‰ì•a˚_öode
)

3049 
	`båfs_lockdï_acquúe
(
fs_öfo
, 
båfs_‹dîed_exã¡
);

3051 i‡(
	`ã°_bô
(
BTRFS_ORDERED_IOERR
, &
‹dîed_exã¡
->
Êags
)) {

3052 
ªt
 = -
EIO
;

3053 
out
;

3056 i‡(
	`båfs_is_z⁄ed
(
fs_öfo
))

3057 
	`båfs_z⁄e_föish_ídio
(
fs_öfo
, 
‹dîed_exã¡
->
disk_byãƒ
,

3058 
‹dîed_exã¡
->
disk_num_byãs
);

3060 i‡(
	`ã°_bô
(
BTRFS_ORDERED_TRUNCATED
, &
‹dîed_exã¡
->
Êags
)) {

3061 
åunˇãd
 = 
åue
;

3062 
logiˇl_Àn
 = 
‹dîed_exã¡
->
åunˇãd_Àn
;

3064 i‡(!
logiˇl_Àn
)

3065 
out
;

3068 i‡(
	`ã°_bô
(
BTRFS_ORDERED_NOCOW
, &
‹dîed_exã¡
->
Êags
)) {

3069 
	`BUG_ON
(!
	`li°_em±y
(&
‹dîed_exã¡
->
li°
));

3071 
	`båfs_öode_ß„_disk_i_size_wrôe
(
öode
, 0);

3072 i‡(
‰ì•a˚_öode
)

3073 
å™s
 = 
	`båfs_joö_å™ß˘i⁄_•a˚ˇche
(
roŸ
);

3075 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
roŸ
);

3076 i‡(
	`IS_ERR
(
å™s
)) {

3077 
ªt
 = 
	`PTR_ERR
(
å™s
);

3078 
å™s
 = 
NULL
;

3079 
out
;

3081 
å™s
->
block_rsv
 = &
öode
->block_rsv;

3082 
ªt
 = 
	`båfs_upd©e_öode_ÁŒback
(
å™s
, 
roŸ
, 
öode
);

3083 i‡(
ªt
)

3084 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3085 
out
;

3088 
˛ór_bôs
 |
EXTENT_LOCKED
;

3089 
	`lock_exã¡
(
io_åì
, 
°¨t
, 
íd
, &
ˇched_°©e
);

3091 i‡(
‰ì•a˚_öode
)

3092 
å™s
 = 
	`båfs_joö_å™ß˘i⁄_•a˚ˇche
(
roŸ
);

3094 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
roŸ
);

3095 i‡(
	`IS_ERR
(
å™s
)) {

3096 
ªt
 = 
	`PTR_ERR
(
å™s
);

3097 
å™s
 = 
NULL
;

3098 
out
;

3101 
å™s
->
block_rsv
 = &
öode
->block_rsv;

3103 i‡(
	`ã°_bô
(
BTRFS_ORDERED_COMPRESSED
, &
‹dîed_exã¡
->
Êags
))

3104 
com¥ess_ty≥
 = 
‹dîed_exã¡
->compress_type;

3105 i‡(
	`ã°_bô
(
BTRFS_ORDERED_PREALLOC
, &
‹dîed_exã¡
->
Êags
)) {

3106 
	`BUG_ON
(
com¥ess_ty≥
);

3107 
ªt
 = 
	`båfs_m¨k_exã¡_wrôãn
(
å™s
, 
öode
,

3108 
‹dîed_exã¡
->
fûe_off£t
,

3109 
‹dîed_exã¡
->
fûe_off£t
 +

3110 
logiˇl_Àn
);

3111 
	`båfs_z⁄ed_ªÀa£_d©a_ªloc_bg
(
fs_öfo
, 
‹dîed_exã¡
->
disk_byãƒ
,

3112 
‹dîed_exã¡
->
disk_num_byãs
);

3114 
	`BUG_ON
(
roŸ
 =
fs_öfo
->
åì_roŸ
);

3115 
ªt
 = 
	`ö£π_‹dîed_exã¡_fûe_exã¡
(
å™s
, 
‹dîed_exã¡
);

3116 i‡(!
ªt
) {

3117 
˛ór_ª£rved_exã¡
 = 
Ál£
;

3118 
	`båfs_ªÀa£_dñÆloc_byãs
(
fs_öfo
,

3119 
‹dîed_exã¡
->
disk_byãƒ
,

3120 
‹dîed_exã¡
->
disk_num_byãs
);

3123 
	`u≈ö_exã¡_ˇche
(&
öode
->
exã¡_åì
, 
‹dîed_exã¡
->
fûe_off£t
,

3124 
‹dîed_exã¡
->
num_byãs
, 
å™s
->
å™sid
);

3125 i‡(
ªt
 < 0) {

3126 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3127 
out
;

3130 
ªt
 = 
	`add_≥ndög_csums
(
å™s
, &
‹dîed_exã¡
->
li°
);

3131 i‡(
ªt
) {

3132 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3133 
out
;

3141 i‡((
˛ór_bôs
 & 
EXTENT_DELALLOC_NEW
) &&

3142 !
	`ã°_bô
(
BTRFS_ORDERED_TRUNCATED
, &
‹dîed_exã¡
->
Êags
))

3143 
	`˛ór_exã¡_bô
(&
öode
->
io_åì
, 
°¨t
, 
íd
,

3144 
EXTENT_DELALLOC_NEW
 | 
EXTENT_ADD_INODE_BYTES
,

3145 &
ˇched_°©e
);

3147 
	`båfs_öode_ß„_disk_i_size_wrôe
(
öode
, 0);

3148 
ªt
 = 
	`båfs_upd©e_öode_ÁŒback
(
å™s
, 
roŸ
, 
öode
);

3149 i‡(
ªt
) {

3150 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3151 
out
;

3153 
ªt
 = 0;

3154 
out
:

3155 
	`˛ór_exã¡_bô
(&
öode
->
io_åì
, 
°¨t
, 
íd
, 
˛ór_bôs
,

3156 &
ˇched_°©e
);

3158 i‡(
å™s
)

3159 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

3161 i‡(
ªt
 || 
åunˇãd
) {

3162 
u64
 
unwrôãn_°¨t
 = 
°¨t
;

3172 i‡(
ªt
 && !
	`ã°_™d_£t_bô
(
BTRFS_ORDERED_IOERR
,

3173 &
‹dîed_exã¡
->
Êags
))

3174 
	`m≠pög_£t_îr‹
(
‹dîed_exã¡
->
öode
->
i_m≠pög
, -
EIO
);

3176 i‡(
åunˇãd
)

3177 
unwrôãn_°¨t
 +
logiˇl_Àn
;

3178 
	`˛ór_exã¡_u±od©e
(
io_åì
, 
unwrôãn_°¨t
, 
íd
, 
NULL
);

3181 
	`båfs_dr›_exã¡_m≠_ønge
(
öode
, 
unwrôãn_°¨t
, 
íd
, 
Ál£
);

3193 i‡((
ªt
 || !
logiˇl_Àn
) &&

3194 
˛ór_ª£rved_exã¡
 &&

3195 !
	`ã°_bô
(
BTRFS_ORDERED_NOCOW
, &
‹dîed_exã¡
->
Êags
) &&

3196 !
	`ã°_bô
(
BTRFS_ORDERED_PREALLOC
, &
‹dîed_exã¡
->
Êags
)) {

3201 i‡(
ªt
 && 
	`båfs_ã°_›t
(
fs_öfo
, 
DISCARD_SYNC
))

3202 
	`båfs_disˇrd_exã¡
(
fs_öfo
,

3203 
‹dîed_exã¡
->
disk_byãƒ
,

3204 
‹dîed_exã¡
->
disk_num_byãs
,

3205 
NULL
);

3206 
	`båfs_‰ì_ª£rved_exã¡
(
fs_öfo
,

3207 
‹dîed_exã¡
->
disk_byãƒ
,

3208 
‹dîed_exã¡
->
disk_num_byãs
, 1);

3213 
	`båfs_qgroup_‰ì_ª‰oŸ
(
fs_öfo
, 
öode
->
roŸ
->
roŸ_key
.
obje˘id
,

3214 
‹dîed_exã¡
->
qgroup_rsv
,

3215 
BTRFS_QGROUP_RSV_DATA
);

3223 
	`båfs_ªmove_‹dîed_exã¡
(
öode
, 
‹dîed_exã¡
);

3226 
	`båfs_put_‹dîed_exã¡
(
‹dîed_exã¡
);

3228 
	`båfs_put_‹dîed_exã¡
(
‹dîed_exã¡
);

3230  
ªt
;

3231 
	}
}

3233 
	$båfs_föish_‹dîed_io
(
båfs_‹dîed_exã¡
 *
‹dîed
)

3235 i‡(
	`båfs_is_z⁄ed
(
	`båfs_sb
(
‹dîed
->
öode
->
i_sb
)) &&

3236 !
	`ã°_bô
(
BTRFS_ORDERED_IOERR
, &
‹dîed
->
Êags
))

3237 
	`båfs_föish_‹dîed_z⁄ed
(
‹dîed
);

3238  
	`båfs_föish_⁄e_‹dîed
(
‹dîed
);

3239 
	}
}

3245 
	$båfs_check_£˘‹_csum
(
båfs_fs_öfo
 *
fs_öfo
, 
∑ge
 *page,

3246 
u32
 
pgoff
, 
u8
 *
csum
, c⁄° u8 * c⁄° 
csum_ex≥˘ed
)

3248 
	`SHASH_DESC_ON_STACK
(
shash
, 
fs_öfo
->
csum_shash
);

3249 *
kaddr
;

3251 
	`ASSERT
(
pgoff
 + 
fs_öfo
->
£˘‹size
 <
PAGE_SIZE
);

3253 
shash
->
tfm
 = 
fs_öfo
->
csum_shash
;

3255 
kaddr
 = 
	`km≠_loˇl_∑ge
(
∑ge
Ë+ 
pgoff
;

3256 
	`¸y±o_shash_dige°
(
shash
, 
kaddr
, 
fs_öfo
->
£˘‹size
, 
csum
);

3257 
	`kunm≠_loˇl
(
kaddr
);

3259 i‡(
	`memcmp
(
csum
, 
csum_ex≥˘ed
, 
fs_öfo
->
csum_size
)) {

3261  -
EIO
;

3264 
	}
}

3279 
boﬁ
 
	$båfs_d©a_csum_ok
(
båfs_bio
 *
bbio
, 
båfs_devi˚
 *
dev
,

3280 
u32
 
bio_off£t
, 
bio_vec
 *
bv
)

3282 
båfs_öode
 *
öode
 = 
bbio
->inode;

3283 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

3284 
u64
 
fûe_off£t
 = 
bbio
->fûe_off£à+ 
bio_off£t
;

3285 
u64
 
íd
 = 
fûe_off£t
 + 
bv
->
bv_Àn
 - 1;

3286 
u8
 *
csum_ex≥˘ed
;

3287 
u8
 
csum
[
BTRFS_CSUM_SIZE
];

3289 
	`ASSERT
(
bv
->
bv_Àn
 =
fs_öfo
->
£˘‹size
);

3291 i‡(!
bbio
->
csum
)

3292  
åue
;

3294 i‡(
	`båfs_is_d©a_ªloc_roŸ
(
öode
->
roŸ
) &&

3295 
	`ã°_ønge_bô
(&
öode
->
io_åì
, 
fûe_off£t
, 
íd
, 
EXTENT_NODATASUM
,

3296 1, 
NULL
)) {

3298 
	`˛ór_exã¡_bôs
(&
öode
->
io_åì
, 
fûe_off£t
, 
íd
,

3299 
EXTENT_NODATASUM
);

3300  
åue
;

3304 
csum_ex≥˘ed
 = 
bbio
->
csum
 + (
bio_off£t
 >> 
fs_öfo
->
£˘‹size_bôs
) *

3305 
fs_öfo
->
csum_size
;

3306 i‡(
	`båfs_check_£˘‹_csum
(
fs_öfo
, 
bv
->
bv_∑ge
, bv->
bv_off£t
, 
csum
,

3307 
csum_ex≥˘ed
)) {

3309 
zîoô
;

3312  
åue
;

3314 
zîoô
:

3315 
	`båfs_¥öt_d©a_csum_îr‹
(
öode
, 
fûe_off£t
, 
csum
, 
csum_ex≥˘ed
,

3316 
bbio
->
múr‹_num
);

3317 i‡(
dev
)

3318 
	`båfs_dev_°©_öc_™d_¥öt
(
dev
, 
BTRFS_DEV_STAT_CORRUPTION_ERRS
);

3319 
	`memzîo_bvec
(
bv
);

3320  
Ál£
;

3321 
	}
}

3333 
	$båfs_add_dñayed_ùut
(
båfs_öode
 *
öode
)

3335 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

3336 
Êags
;

3338 i‡(
	`©omic_add_u∆ess
(&
öode
->
vfs_öode
.
i_cou¡
, -1, 1))

3341 
	`©omic_öc
(&
fs_öfo
->
ƒ_dñayed_ùuts
);

3347 
	`•ö_lock_úqßve
(&
fs_öfo
->
dñayed_ùut_lock
, 
Êags
);

3348 
	`ASSERT
(
	`li°_em±y
(&
öode
->
dñayed_ùut
));

3349 
	`li°_add_èû
(&
öode
->
dñayed_ùut
, &
fs_öfo
->
dñayed_ùuts
);

3350 
	`•ö_u∆ock_úqª°‹e
(&
fs_öfo
->
dñayed_ùut_lock
, 
Êags
);

3351 i‡(!
	`ã°_bô
(
BTRFS_FS_CLEANER_RUNNING
, &
fs_öfo
->
Êags
))

3352 
	`wake_up_¥o˚ss
(
fs_öfo
->
˛ó√r_kthªad
);

3353 
	}
}

3355 
	$run_dñayed_ùut_locked
(
båfs_fs_öfo
 *
fs_öfo
,

3356 
båfs_öode
 *
öode
)

3358 
	`li°_dñ_öô
(&
öode
->
dñayed_ùut
);

3359 
	`•ö_u∆ock_úq
(&
fs_öfo
->
dñayed_ùut_lock
);

3360 
	`ùut
(&
öode
->
vfs_öode
);

3361 i‡(
	`©omic_dec_™d_ã°
(&
fs_öfo
->
ƒ_dñayed_ùuts
))

3362 
	`wake_up
(&
fs_öfo
->
dñayed_ùuts_waô
);

3363 
	`•ö_lock_úq
(&
fs_öfo
->
dñayed_ùut_lock
);

3364 
	}
}

3366 
	$båfs_run_dñayed_ùut
(
båfs_fs_öfo
 *
fs_öfo
,

3367 
båfs_öode
 *
öode
)

3369 i‡(!
	`li°_em±y
(&
öode
->
dñayed_ùut
)) {

3370 
	`•ö_lock_úq
(&
fs_öfo
->
dñayed_ùut_lock
);

3371 i‡(!
	`li°_em±y
(&
öode
->
dñayed_ùut
))

3372 
	`run_dñayed_ùut_locked
(
fs_öfo
, 
öode
);

3373 
	`•ö_u∆ock_úq
(&
fs_öfo
->
dñayed_ùut_lock
);

3375 
	}
}

3377 
	$båfs_run_dñayed_ùuts
(
båfs_fs_öfo
 *
fs_öfo
)

3385 
	`•ö_lock_úq
(&
fs_öfo
->
dñayed_ùut_lock
);

3386 !
	`li°_em±y
(&
fs_öfo
->
dñayed_ùuts
)) {

3387 
båfs_öode
 *
öode
;

3389 
öode
 = 
	`li°_fú°_íåy
(&
fs_öfo
->
dñayed_ùuts
,

3390 
båfs_öode
, 
dñayed_ùut
);

3391 
	`run_dñayed_ùut_locked
(
fs_öfo
, 
öode
);

3392 i‡(
	`√ed_ªsched
()) {

3393 
	`•ö_u∆ock_úq
(&
fs_öfo
->
dñayed_ùut_lock
);

3394 
	`c⁄d_ªsched
();

3395 
	`•ö_lock_úq
(&
fs_öfo
->
dñayed_ùut_lock
);

3398 
	`•ö_u∆ock_úq
(&
fs_öfo
->
dñayed_ùut_lock
);

3399 
	}
}

3413 
	$båfs_waô_⁄_dñayed_ùuts
(
båfs_fs_öfo
 *
fs_öfo
)

3415 
ªt
 = 
	`waô_evít_kûœbÀ
(
fs_öfo
->
dñayed_ùuts_waô
,

3416 
	`©omic_ªad
(&
fs_öfo
->
ƒ_dñayed_ùuts
) == 0);

3417 i‡(
ªt
)

3418  -
EINTR
;

3420 
	}
}

3426 
	$båfs_‹ph™_add
(
båfs_å™s_h™dÀ
 *
å™s
,

3427 
båfs_öode
 *
öode
)

3429 
ªt
;

3431 
ªt
 = 
	`båfs_ö£π_‹ph™_ôem
(
å™s
, 
öode
->
roŸ
, 
	`båfs_öo
(inode));

3432 i‡(
ªt
 &&Ñë !-
EEXIST
) {

3433 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3434  
ªt
;

3438 
	}
}

3444 
	$båfs_‹ph™_dñ
(
båfs_å™s_h™dÀ
 *
å™s
,

3445 
båfs_öode
 *
öode
)

3447  
	`båfs_dñ_‹ph™_ôem
(
å™s
, 
öode
->
roŸ
, 
	`båfs_öo
(inode));

3448 
	}
}

3454 
	$båfs_‹ph™_˛ónup
(
båfs_roŸ
 *
roŸ
)

3456 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

3457 
båfs_∑th
 *
∑th
;

3458 
exã¡_buf„r
 *
Àaf
;

3459 
båfs_key
 
key
, 
found_key
;

3460 
båfs_å™s_h™dÀ
 *
å™s
;

3461 
öode
 *inode;

3462 
u64
 
œ°_obje˘id
 = 0;

3463 
ªt
 = 0, 
ƒ_u∆ök
 = 0;

3465 i‡(
	`ã°_™d_£t_bô
(
BTRFS_ROOT_ORPHAN_CLEANUP
, &
roŸ
->
°©e
))

3468 
∑th
 = 
	`båfs_Æloc_∑th
();

3469 i‡(!
∑th
) {

3470 
ªt
 = -
ENOMEM
;

3471 
out
;

3473 
∑th
->
ªada
 = 
READA_BACK
;

3475 
key
.
obje˘id
 = 
BTRFS_ORPHAN_OBJECTID
;

3476 
key
.
ty≥
 = 
BTRFS_ORPHAN_ITEM_KEY
;

3477 
key
.
off£t
 = (
u64
)-1;

3480 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

3481 i‡(
ªt
 < 0)

3482 
out
;

3489 i‡(
ªt
 > 0) {

3490 
ªt
 = 0;

3491 i‡(
∑th
->
¶Ÿs
[0] == 0)

3493 
∑th
->
¶Ÿs
[0]--;

3497 
Àaf
 = 
∑th
->
nodes
[0];

3498 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0]);

3501 i‡(
found_key
.
obje˘id
 !
BTRFS_ORPHAN_OBJECTID
)

3503 i‡(
found_key
.
ty≥
 !
BTRFS_ORPHAN_ITEM_KEY
)

3507 
	`båfs_ªÀa£_∑th
(
∑th
);

3515 i‡(
found_key
.
off£t
 =
œ°_obje˘id
) {

3523 
	`båfs_îr
(
fs_öfo
,

3525 
ªt
 = 
	`BTRFS_FS_ERROR
(
fs_öfo
Ë?: -
EINVAL
;

3526 
out
;

3529 
œ°_obje˘id
 = 
found_key
.
off£t
;

3531 
found_key
.
obje˘id
 = found_key.
off£t
;

3532 
found_key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

3533 
found_key
.
off£t
 = 0;

3534 
öode
 = 
	`båfs_igë
(
fs_öfo
->
sb
, 
œ°_obje˘id
, 
roŸ
);

3535 i‡(
	`IS_ERR
(
öode
)) {

3536 
ªt
 = 
	`PTR_ERR
(
öode
);

3537 
öode
 = 
NULL
;

3538 i‡(
ªt
 !-
ENOENT
)

3539 
out
;

3542 i‡(!
öode
 && 
roŸ
 =
fs_öfo
->
åì_roŸ
) {

3543 
båfs_roŸ
 *
dód_roŸ
;

3544 
is_dód_roŸ
 = 0;

3562 
	`•ö_lock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

3563 
dód_roŸ
 = 
	`ødix_åì_lookup
(&
fs_öfo
->
fs_roŸs_ødix
,

3564 ()
found_key
.
obje˘id
);

3565 i‡(
dód_roŸ
 && 
	`båfs_roŸ_ªfs
(&dód_roŸ->
roŸ_ôem
) == 0)

3566 
is_dód_roŸ
 = 1;

3567 
	`•ö_u∆ock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

3569 i‡(
is_dód_roŸ
) {

3571 
key
.
off£t
 = 
found_key
.
obje˘id
 - 1;

3603 i‡(!
öode
 || inode->
i_∆ök
) {

3604 i‡(
öode
) {

3605 
ªt
 = 
	`båfs_dr›_vîôy_ôems
(
	`BTRFS_I
(
öode
));

3606 
	`ùut
(
öode
);

3607 
öode
 = 
NULL
;

3608 i‡(
ªt
)

3609 
out
;

3611 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 1);

3612 i‡(
	`IS_ERR
(
å™s
)) {

3613 
ªt
 = 
	`PTR_ERR
(
å™s
);

3614 
out
;

3616 
	`båfs_debug
(
fs_öfo
, "auto deleting %Lu",

3617 
found_key
.
obje˘id
);

3618 
ªt
 = 
	`båfs_dñ_‹ph™_ôem
(
å™s
, 
roŸ
,

3619 
found_key
.
obje˘id
);

3620 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

3621 i‡(
ªt
)

3622 
out
;

3626 
ƒ_u∆ök
++;

3629 
	`ùut
(
öode
);

3632 
	`båfs_ªÀa£_∑th
(
∑th
);

3634 i‡(
	`ã°_bô
(
BTRFS_ROOT_ORPHAN_ITEM_INSERTED
, &
roŸ
->
°©e
)) {

3635 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
roŸ
);

3636 i‡(!
	`IS_ERR
(
å™s
))

3637 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

3640 i‡(
ƒ_u∆ök
)

3641 
	`båfs_debug
(
fs_öfo
, "u∆öked %d oΩh™s", 
ƒ_u∆ök
);

3643 
out
:

3644 i‡(
ªt
)

3645 
	`båfs_îr
(
fs_öfo
, "couldÇŸ dÿ‹ph™ cÀ™u∞%d", 
ªt
);

3646 
	`båfs_‰ì_∑th
(
∑th
);

3647  
ªt
;

3648 
	}
}

3656 
noölöe
 
	$a˛s_a·î_öode_ôem
(
exã¡_buf„r
 *
Àaf
,

3657 
¶Ÿ
, 
u64
 
obje˘id
,

3658 *
fú°_x©å_¶Ÿ
)

3660 
u32
 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

3661 
båfs_key
 
found_key
;

3662 
u64
 
x©å_ac˚ss
 = 0;

3663 
u64
 
x©å_deÁu…
 = 0;

3664 
sˇ¬ed
 = 0;

3666 i‡(!
x©å_ac˚ss
) {

3667 
x©å_ac˚ss
 = 
	`båfs_«me_hash
(
XATTR_NAME_POSIX_ACL_ACCESS
,

3668 
	`°æí
(
XATTR_NAME_POSIX_ACL_ACCESS
));

3669 
x©å_deÁu…
 = 
	`båfs_«me_hash
(
XATTR_NAME_POSIX_ACL_DEFAULT
,

3670 
	`°æí
(
XATTR_NAME_POSIX_ACL_DEFAULT
));

3673 
¶Ÿ
++;

3674 *
fú°_x©å_¶Ÿ
 = -1;

3675 
¶Ÿ
 < 
ƒôems
) {

3676 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
¶Ÿ
);

3679 i‡(
found_key
.
obje˘id
 != objectid)

3683 i‡(
found_key
.
ty≥
 =
BTRFS_XATTR_ITEM_KEY
) {

3684 i‡(*
fú°_x©å_¶Ÿ
 == -1)

3685 *
fú°_x©å_¶Ÿ
 = 
¶Ÿ
;

3686 i‡(
found_key
.
off£t
 =
x©å_ac˚ss
 ||

3687 
found_key
.
off£t
 =
x©å_deÁu…
)

3695 i‡(
found_key
.
ty≥
 > 
BTRFS_XATTR_ITEM_KEY
)

3698 
¶Ÿ
++;

3699 
sˇ¬ed
++;

3707 i‡(
sˇ¬ed
 >= 8)

3714 i‡(*
fú°_x©å_¶Ÿ
 == -1)

3715 *
fú°_x©å_¶Ÿ
 = 
¶Ÿ
;

3717 
	}
}

3722 
	$båfs_ªad_locked_öode
(
öode
 *inode,

3723 
båfs_∑th
 *
ö_∑th
)

3725 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

3726 
båfs_∑th
 *
∑th
 = 
ö_∑th
;

3727 
exã¡_buf„r
 *
Àaf
;

3728 
båfs_öode_ôem
 *
öode_ôem
;

3729 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

3730 
båfs_key
 
loˇti⁄
;

3731 
±r
;

3732 
maybe_a˛s
;

3733 
u32
 
rdev
;

3734 
ªt
;

3735 
boﬁ
 
fûÀd
 = 
Ál£
;

3736 
fú°_x©å_¶Ÿ
;

3738 
ªt
 = 
	`båfs_fûl_öode
(
öode
, &
rdev
);

3739 i‡(!
ªt
)

3740 
fûÀd
 = 
åue
;

3742 i‡(!
∑th
) {

3743 
∑th
 = 
	`båfs_Æloc_∑th
();

3744 i‡(!
∑th
)

3745  -
ENOMEM
;

3748 
	`mem˝y
(&
loˇti⁄
, &
	`BTRFS_I
(
öode
)->location, (location));

3750 
ªt
 = 
	`båfs_lookup_öode
(
NULL
, 
roŸ
, 
∑th
, &
loˇti⁄
, 0);

3751 i‡(
ªt
) {

3752 i‡(
∑th
 !
ö_∑th
)

3753 
	`båfs_‰ì_∑th
(
∑th
);

3754  
ªt
;

3757 
Àaf
 = 
∑th
->
nodes
[0];

3759 i‡(
fûÀd
)

3760 
ˇche_ödex
;

3762 
öode_ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

3763 
båfs_öode_ôem
);

3764 
öode
->
i_mode
 = 
	`båfs_öode_mode
(
Àaf
, 
öode_ôem
);

3765 
	`£t_∆ök
(
öode
, 
	`båfs_öode_∆ök
(
Àaf
, 
öode_ôem
));

3766 
	`i_uid_wrôe
(
öode
, 
	`båfs_öode_uid
(
Àaf
, 
öode_ôem
));

3767 
	`i_gid_wrôe
(
öode
, 
	`båfs_öode_gid
(
Àaf
, 
öode_ôem
));

3768 
	`båfs_i_size_wrôe
(
	`BTRFS_I
(
öode
), 
	`båfs_öode_size
(
Àaf
, 
öode_ôem
));

3769 
	`båfs_öode_£t_fûe_exã¡_ønge
(
	`BTRFS_I
(
öode
), 0,

3770 
	`round_up
(
	`i_size_ªad
(
öode
), 
fs_öfo
->
£˘‹size
));

3772 
öode
->
i_©ime
.
tv_£c
 = 
	`båfs_time•ec_£c
(
Àaf
, &
öode_ôem
->
©ime
);

3773 
öode
->
i_©ime
.
tv_n£c
 = 
	`båfs_time•ec_n£c
(
Àaf
, &
öode_ôem
->
©ime
);

3775 
öode
->
i_mtime
.
tv_£c
 = 
	`båfs_time•ec_£c
(
Àaf
, &
öode_ôem
->
mtime
);

3776 
öode
->
i_mtime
.
tv_n£c
 = 
	`båfs_time•ec_n£c
(
Àaf
, &
öode_ôem
->
mtime
);

3778 
	`öode_£t_˘ime
(
öode
, 
	`båfs_time•ec_£c
(
Àaf
, &
öode_ôem
->
˘ime
),

3779 
	`båfs_time•ec_n£c
(
Àaf
, &
öode_ôem
->
˘ime
));

3781 
	`BTRFS_I
(
öode
)->
i_Ÿime
.
tv_£c
 =

3782 
	`båfs_time•ec_£c
(
Àaf
, &
öode_ôem
->
Ÿime
);

3783 
	`BTRFS_I
(
öode
)->
i_Ÿime
.
tv_n£c
 =

3784 
	`båfs_time•ec_n£c
(
Àaf
, &
öode_ôem
->
Ÿime
);

3786 
	`öode_£t_byãs
(
öode
, 
	`båfs_öode_nbyãs
(
Àaf
, 
öode_ôem
));

3787 
	`BTRFS_I
(
öode
)->
gíî©i⁄
 = 
	`båfs_öode_gíî©i⁄
(
Àaf
, 
öode_ôem
);

3788 
	`BTRFS_I
(
öode
)->
œ°_å™s
 = 
	`båfs_öode_å™sid
(
Àaf
, 
öode_ôem
);

3790 
	`öode_£t_ivîsi⁄_quîõd
(
öode
,

3791 
	`båfs_öode_£quí˚
(
Àaf
, 
öode_ôem
));

3792 
öode
->
i_gíî©i⁄
 = 
	`BTRFS_I
(öode)->
gíî©i⁄
;

3793 
öode
->
i_rdev
 = 0;

3794 
rdev
 = 
	`båfs_öode_rdev
(
Àaf
, 
öode_ôem
);

3796 
	`BTRFS_I
(
öode
)->
ödex_˙t
 = (
u64
)-1;

3797 
	`båfs_öode_•lô_Êags
(
	`båfs_öode_Êags
(
Àaf
, 
öode_ôem
),

3798 &
	`BTRFS_I
(
öode
)->
Êags
, &BTRFS_I(öode)->
ro_Êags
);

3800 
ˇche_ödex
:

3810 i‡(
	`BTRFS_I
(
öode
)->
œ°_å™s
 =
fs_öfo
->
gíî©i⁄
)

3811 
	`£t_bô
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

3812 &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
);

3841 
	`BTRFS_I
(
öode
)->
œ°_u∆ök_å™s
 = BTRFS_I(öode)->
œ°_å™s
;

3849 
	`BTRFS_I
(
öode
)->
œ°_ªÊök_å™s
 = BTRFS_I(öode)->
œ°_å™s
;

3851 
∑th
->
¶Ÿs
[0]++;

3852 i‡(
öode
->
i_∆ök
 != 1 ||

3853 
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
(
Àaf
))

3854 
ˇche_a˛
;

3856 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
loˇti⁄
, 
∑th
->
¶Ÿs
[0]);

3857 i‡(
loˇti⁄
.
obje˘id
 !
	`båfs_öo
(
	`BTRFS_I
(
öode
)))

3858 
ˇche_a˛
;

3860 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

3861 i‡(
loˇti⁄
.
ty≥
 =
BTRFS_INODE_REF_KEY
) {

3862 
båfs_öode_ªf
 *
ªf
;

3864 
ªf
 = (
båfs_öode_ªf
 *)
±r
;

3865 
	`BTRFS_I
(
öode
)->
dú_ödex
 = 
	`båfs_öode_ªf_ödex
(
Àaf
, 
ªf
);

3866 } i‡(
loˇti⁄
.
ty≥
 =
BTRFS_INODE_EXTREF_KEY
) {

3867 
båfs_öode_exåef
 *
exåef
;

3869 
exåef
 = (
båfs_öode_exåef
 *)
±r
;

3870 
	`BTRFS_I
(
öode
)->
dú_ödex
 = 
	`båfs_öode_exåef_ödex
(
Àaf
,

3871 
exåef
);

3873 
ˇche_a˛
:

3878 
maybe_a˛s
 = 
	`a˛s_a·î_öode_ôem
(
Àaf
, 
∑th
->
¶Ÿs
[0],

3879 
	`båfs_öo
(
	`BTRFS_I
(
öode
)), &
fú°_x©å_¶Ÿ
);

3880 i‡(
fú°_x©å_¶Ÿ
 != -1) {

3881 
∑th
->
¶Ÿs
[0] = 
fú°_x©å_¶Ÿ
;

3882 
ªt
 = 
	`båfs_lﬂd_öode_¥›s
(
öode
, 
∑th
);

3883 i‡(
ªt
)

3884 
	`båfs_îr
(
fs_öfo
,

3886 
	`båfs_öo
(
	`BTRFS_I
(
öode
)),

3887 
roŸ
->
roŸ_key
.
obje˘id
, 
ªt
);

3889 i‡(
∑th
 !
ö_∑th
)

3890 
	`båfs_‰ì_∑th
(
∑th
);

3892 i‡(!
maybe_a˛s
)

3893 
	`ˇche_no_a˛
(
öode
);

3895 
öode
->
i_mode
 & 
S_IFMT
) {

3896 
S_IFREG
:

3897 
öode
->
i_m≠pög
->
a_›s
 = &
båfs_a›s
;

3898 
öode
->
i_f›
 = &
båfs_fûe_›î©i⁄s
;

3899 
öode
->
i_›
 = &
båfs_fûe_öode_›î©i⁄s
;

3901 
S_IFDIR
:

3902 
öode
->
i_f›
 = &
båfs_dú_fûe_›î©i⁄s
;

3903 
öode
->
i_›
 = &
båfs_dú_öode_›î©i⁄s
;

3905 
S_IFLNK
:

3906 
öode
->
i_›
 = &
båfs_symlök_öode_›î©i⁄s
;

3907 
	`öode_nohighmem
(
öode
);

3908 
öode
->
i_m≠pög
->
a_›s
 = &
båfs_a›s
;

3911 
öode
->
i_›
 = &
båfs_•ecül_öode_›î©i⁄s
;

3912 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
, 
rdev
);

3916 
	`båfs_sync_öode_Êags_to_i_Êags
(
öode
);

3918 
	}
}

3923 
	$fûl_öode_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

3924 
exã¡_buf„r
 *
Àaf
,

3925 
båfs_öode_ôem
 *
ôem
,

3926 
öode
 *inode)

3928 
båfs_m≠_tokí
 
tokí
;

3929 
u64
 
Êags
;

3931 
	`båfs_öô_m≠_tokí
(&
tokí
, 
Àaf
);

3933 
	`båfs_£t_tokí_öode_uid
(&
tokí
, 
ôem
, 
	`i_uid_ªad
(
öode
));

3934 
	`båfs_£t_tokí_öode_gid
(&
tokí
, 
ôem
, 
	`i_gid_ªad
(
öode
));

3935 
	`båfs_£t_tokí_öode_size
(&
tokí
, 
ôem
, 
	`BTRFS_I
(
öode
)->
disk_i_size
);

3936 
	`båfs_£t_tokí_öode_mode
(&
tokí
, 
ôem
, 
öode
->
i_mode
);

3937 
	`båfs_£t_tokí_öode_∆ök
(&
tokí
, 
ôem
, 
öode
->
i_∆ök
);

3939 
	`båfs_£t_tokí_time•ec_£c
(&
tokí
, &
ôem
->
©ime
,

3940 
öode
->
i_©ime
.
tv_£c
);

3941 
	`båfs_£t_tokí_time•ec_n£c
(&
tokí
, &
ôem
->
©ime
,

3942 
öode
->
i_©ime
.
tv_n£c
);

3944 
	`båfs_£t_tokí_time•ec_£c
(&
tokí
, &
ôem
->
mtime
,

3945 
öode
->
i_mtime
.
tv_£c
);

3946 
	`båfs_£t_tokí_time•ec_n£c
(&
tokí
, &
ôem
->
mtime
,

3947 
öode
->
i_mtime
.
tv_n£c
);

3949 
	`båfs_£t_tokí_time•ec_£c
(&
tokí
, &
ôem
->
˘ime
,

3950 
	`öode_gë_˘ime
(
öode
).
tv_£c
);

3951 
	`båfs_£t_tokí_time•ec_n£c
(&
tokí
, &
ôem
->
˘ime
,

3952 
	`öode_gë_˘ime
(
öode
).
tv_n£c
);

3954 
	`båfs_£t_tokí_time•ec_£c
(&
tokí
, &
ôem
->
Ÿime
,

3955 
	`BTRFS_I
(
öode
)->
i_Ÿime
.
tv_£c
);

3956 
	`båfs_£t_tokí_time•ec_n£c
(&
tokí
, &
ôem
->
Ÿime
,

3957 
	`BTRFS_I
(
öode
)->
i_Ÿime
.
tv_n£c
);

3959 
	`båfs_£t_tokí_öode_nbyãs
(&
tokí
, 
ôem
, 
	`öode_gë_byãs
(
öode
));

3960 
	`båfs_£t_tokí_öode_gíî©i⁄
(&
tokí
, 
ôem
,

3961 
	`BTRFS_I
(
öode
)->
gíî©i⁄
);

3962 
	`båfs_£t_tokí_öode_£quí˚
(&
tokí
, 
ôem
, 
	`öode_≥ek_ivîsi⁄
(
öode
));

3963 
	`båfs_£t_tokí_öode_å™sid
(&
tokí
, 
ôem
, 
å™s
->
å™sid
);

3964 
	`båfs_£t_tokí_öode_rdev
(&
tokí
, 
ôem
, 
öode
->
i_rdev
);

3965 
Êags
 = 
	`båfs_öode_comböe_Êags
(
	`BTRFS_I
(
öode
)->flags,

3966 
	`BTRFS_I
(
öode
)->
ro_Êags
);

3967 
	`båfs_£t_tokí_öode_Êags
(&
tokí
, 
ôem
, 
Êags
);

3968 
	`båfs_£t_tokí_öode_block_group
(&
tokí
, 
ôem
, 0);

3969 
	}
}

3974 
noölöe
 
	$båfs_upd©e_öode_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

3975 
båfs_roŸ
 *
roŸ
,

3976 
båfs_öode
 *
öode
)

3978 
båfs_öode_ôem
 *
öode_ôem
;

3979 
båfs_∑th
 *
∑th
;

3980 
exã¡_buf„r
 *
Àaf
;

3981 
ªt
;

3983 
∑th
 = 
	`båfs_Æloc_∑th
();

3984 i‡(!
∑th
)

3985  -
ENOMEM
;

3987 
ªt
 = 
	`båfs_lookup_öode
(
å™s
, 
roŸ
, 
∑th
, &
öode
->
loˇti⁄
, 1);

3988 i‡(
ªt
) {

3989 i‡(
ªt
 > 0)

3990 
ªt
 = -
ENOENT
;

3991 
Áûed
;

3994 
Àaf
 = 
∑th
->
nodes
[0];

3995 
öode_ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

3996 
båfs_öode_ôem
);

3998 
	`fûl_öode_ôem
(
å™s
, 
Àaf
, 
öode_ôem
, &
öode
->
vfs_öode
);

3999 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

4000 
	`båfs_£t_öode_œ°_å™s
(
å™s
, 
öode
);

4001 
ªt
 = 0;

4002 
Áûed
:

4003 
	`båfs_‰ì_∑th
(
∑th
);

4004  
ªt
;

4005 
	}
}

4010 
noölöe
 
	$båfs_upd©e_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

4011 
båfs_roŸ
 *
roŸ
,

4012 
båfs_öode
 *
öode
)

4014 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4015 
ªt
;

4024 i‡(!
	`båfs_is_‰ì_•a˚_öode
(
öode
)

4025 && !
	`båfs_is_d©a_ªloc_roŸ
(
roŸ
)

4026 && !
	`ã°_bô
(
BTRFS_FS_LOG_RECOVERING
, &
fs_öfo
->
Êags
)) {

4027 
	`båfs_upd©e_roŸ_times
(
å™s
, 
roŸ
);

4029 
ªt
 = 
	`båfs_dñayed_upd©e_öode
(
å™s
, 
roŸ
, 
öode
);

4030 i‡(!
ªt
)

4031 
	`båfs_£t_öode_œ°_å™s
(
å™s
, 
öode
);

4032  
ªt
;

4035  
	`båfs_upd©e_öode_ôem
(
å™s
, 
roŸ
, 
öode
);

4036 
	}
}

4038 
	$båfs_upd©e_öode_ÁŒback
(
båfs_å™s_h™dÀ
 *
å™s
,

4039 
båfs_roŸ
 *
roŸ
, 
båfs_öode
 *
öode
)

4041 
ªt
;

4043 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
öode
);

4044 i‡(
ªt
 =-
ENOSPC
)

4045  
	`båfs_upd©e_öode_ôem
(
å™s
, 
roŸ
, 
öode
);

4046  
ªt
;

4047 
	}
}

4055 
	$__båfs_u∆ök_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

4056 
båfs_öode
 *
dú
,

4057 
båfs_öode
 *
öode
,

4058 c⁄° 
fs¸y±_°r
 *
«me
,

4059 
båfs_ª«me_˘x
 *
ª«me_˘x
)

4061 
båfs_roŸ
 *
roŸ
 = 
dú
->root;

4062 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4063 
båfs_∑th
 *
∑th
;

4064 
ªt
 = 0;

4065 
båfs_dú_ôem
 *
di
;

4066 
u64
 
ödex
;

4068 
u64
 
dú_öo
 = 
	`båfs_öo
(
dú
);

4070 
båfs_öode
 *
loˇl_öode
;

4071 
öode
 *
v_öode
 = &öode->
vfs_öode
;

4072 
båfs_fs_öfo
 *
fs_öfo_öode
 = 
	`båfs_sb
(
v_öode
->
i_sb
);

4073 i‡((
v_öode
->
assocüãd_öode
Ë&& (v_öode->
has_ªmŸe
 == 0)) {

4075 
loˇl_öode
 = 
	`BTRFS_I
(
v_öode
->
assocüãd_öode
);

4077 
loˇl_öode
 = 
öode
;

4079 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

4084 
∑th
 = 
	`båfs_Æloc_∑th
();

4085 i‡(!
∑th
) {

4086 
ªt
 = -
ENOMEM
;

4087 
out
;

4090 
di
 = 
	`båfs_lookup_dú_ôem
(
å™s
, 
roŸ
, 
∑th
, 
dú_öo
, 
«me
, -1);

4091 i‡(
	`IS_ERR_OR_NULL
(
di
)) {

4092 
ªt
 = 
di
 ? 
	`PTR_ERR
(diË: -
ENOENT
;

4093 
îr
;

4095 
ªt
 = 
	`båfs_dñëe_⁄e_dú_«me
(
å™s
, 
roŸ
, 
∑th
, 
di
);

4096 i‡(
ªt
)

4097 
îr
;

4098 
	`båfs_ªÀa£_∑th
(
∑th
);

4111 i‡(
loˇl_öode
->
dú_ödex
) {

4112 
ªt
 = 
	`båfs_dñayed_dñëe_öode_ªf
(
loˇl_öode
);

4113 i‡(!
ªt
) {

4114 
ödex
 = 
loˇl_öode
->
dú_ödex
;

4115 
skù_backªf
;

4119 
ªt
 = 
	`båfs_dñ_öode_ªf
(
å™s
, 
roŸ
, 
«me
, 
öo
, 
dú_öo
, &
ödex
);

4120 i‡(
ªt
) {

4121 
	`båfs_öfo
(
fs_öfo
,

4123 
«me
->
Àn
,Çame->«me, 
öo
, 
dú_öo
);

4124 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4125 
îr
;

4127 
skù_backªf
:

4128 i‡(
ª«me_˘x
)

4129 
ª«me_˘x
->
ödex
 = index;

4131 
ªt
 = 
	`båfs_dñëe_dñayed_dú_ödex
(
å™s
, 
dú
, 
ödex
);

4132 i‡(
ªt
) {

4133 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4134 
îr
;

4143 i‡(!
ª«me_˘x
) {

4145 
	`båfs_dñ_öode_ªf_ö_log
(
å™s
, 
roŸ
, 
«me
, 
loˇl_öode
, 
dú_öo
);

4146 
	`båfs_dñ_dú_íåõs_ö_log
(
å™s
, 
roŸ
, 
«me
, 
dú
, 
ödex
);

4159 
	`båfs_run_dñayed_ùut
(
fs_öfo
, 
loˇl_öode
);

4160 
îr
:

4161 
	`båfs_‰ì_∑th
(
∑th
);

4162 i‡(
ªt
)

4163 
out
;

4165 
	`båfs_i_size_wrôe
(
dú
, dú->
vfs_öode
.
i_size
 - 
«me
->
Àn
 * 2);

4167 
	`öode_öc_ivîsi⁄
(&
loˇl_öode
->
vfs_öode
);

4168 
	`öode_öc_ivîsi⁄
(&
dú
->
vfs_öode
);

4170 
	`öode_£t_˘ime_cuºít
(&
loˇl_öode
->
vfs_öode
);

4171 
dú
->
vfs_öode
.
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(&dir->vfs_inode);

4172 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
dú
);

4173 
out
:

4174  
ªt
;

4175 
	}
}

4177 
	$båfs_u∆ök_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

4178 
båfs_öode
 *
dú
, båfs_öodê*
öode
,

4179 c⁄° 
fs¸y±_°r
 *
«me
)

4181 
ªt
;

4183 
ªt
 = 
	`__båfs_u∆ök_öode
(
å™s
, 
dú
, 
öode
, 
«me
, 
NULL
);

4184 i‡(!
ªt
) {

4185 
	`dr›_∆ök
(&
öode
->
vfs_öode
);

4186 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
öode
->
roŸ
, inode);

4188  
ªt
;

4189 
	}
}

4199 
båfs_å™s_h™dÀ
 *
	$__u∆ök_°¨t_å™s
(
båfs_öode
 *
dú
)

4201 
båfs_roŸ
 *
roŸ
 = 
dú
->root;

4203  
	`båfs_°¨t_å™ß˘i⁄_ÁŒback_globÆ_rsv
(
roŸ
,

4204 
BTRFS_UNLINK_METADATA_UNITS
);

4205 
	}
}

4208 
	$båfs_u∆ök
(
öode
 *
dú
, 
díåy
 *dentry)

4210 
båfs_å™s_h™dÀ
 *
å™s
;

4211 
öode
 *öodê
	`d_öode
(
díåy
);

4217 
öode
 *
loˇl_öode
;

4218 i‡((
öode
->
assocüãd_öode
Ë&& (öode->
has_ªmŸe
 == 0))

4219 
loˇl_öode
 = 
öode
->
assocüãd_öode
;

4220 i‡(
loˇl_öode
)

4221 
öode
 = 
loˇl_öode
;

4225 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

4226 
fs_id
 = 
fs_öfo
->
id
;

4228 
	`¥ötk
(
KERN_INFO
 "båfs_u∆ök: Inodêo‡f†%d, díåy->öodêo‡f†%d", 
dú
->
fs_id
, 
öode
->fs_id);

4229 
ªt
;

4230 
fs¸y±_«me
 
‚ame
;

4232 
ªt
 = 
	`fs¸y±_£tup_fûíame
(
dú
, &
díåy
->
d_«me
, 1, &
‚ame
);

4233 i‡(
ªt
)

4234  
ªt
;

4238 
å™s
 = 
	`__u∆ök_°¨t_å™s
(
	`BTRFS_I
(
dú
));

4239 i‡(
	`IS_ERR
(
å™s
)) {

4240 
ªt
 = 
	`PTR_ERR
(
å™s
);

4241 
fs¸y±_‰ì
;

4245 
	`båfs_ªc‹d_u∆ök_dú
(
å™s
, 
	`BTRFS_I
(
dú
), BTRFS_I(
öode
),

4246 
Ál£
);

4249 
ªt
 = 
	`båfs_u∆ök_öode
(
å™s
, 
	`BTRFS_I
(
dú
), BTRFS_I(
öode
),

4250 &
‚ame
.
disk_«me
);

4252 i‡(
ªt
)

4253 
íd_å™s
;

4255 i‡(
öode
->
i_∆ök
 == 0) {

4256 
ªt
 = 
	`båfs_‹ph™_add
(
å™s
, 
	`BTRFS_I
(
öode
));

4257 i‡(
ªt
)

4258 
íd_å™s
;

4261 
íd_å™s
:

4262 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

4263 
	`båfs_båì_bÆ™˚_dúty
(
	`BTRFS_I
(
dú
)->
roŸ
->
fs_öfo
);

4264 
fs¸y±_‰ì
:

4265 
	`fs¸y±_‰ì_fûíame
(&
‚ame
);

4266  
ªt
;

4267 
	}
}

4269 
	$båfs_u∆ök_subvﬁ
(
båfs_å™s_h™dÀ
 *
å™s
,

4270 
båfs_öode
 *
dú
, 
díåy
 *dentry)

4272 
båfs_roŸ
 *
roŸ
 = 
dú
->root;

4273 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
	`d_öode
(
díåy
));

4274 
båfs_∑th
 *
∑th
;

4275 
exã¡_buf„r
 *
Àaf
;

4276 
båfs_dú_ôem
 *
di
;

4277 
båfs_key
 
key
;

4278 
u64
 
ödex
;

4279 
ªt
;

4280 
u64
 
obje˘id
;

4281 
u64
 
dú_öo
 = 
	`båfs_öo
(
dú
);

4282 
fs¸y±_«me
 
‚ame
;

4284 
ªt
 = 
	`fs¸y±_£tup_fûíame
(&
dú
->
vfs_öode
, &
díåy
->
d_«me
, 1, &
‚ame
);

4285 i‡(
ªt
)

4286  
ªt
;

4290 i‡(
	`båfs_öo
(
öode
Ë=
BTRFS_FIRST_FREE_OBJECTID
) {

4291 
obje˘id
 = 
öode
->
roŸ
->
roŸ_key
.objectid;

4292 } i‡(
	`båfs_öo
(
öode
Ë=
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
) {

4293 
obje˘id
 = 
öode
->
loˇti⁄
.objectid;

4295 
	`WARN_ON
(1);

4296 
	`fs¸y±_‰ì_fûíame
(&
‚ame
);

4297  -
EINVAL
;

4300 
∑th
 = 
	`båfs_Æloc_∑th
();

4301 i‡(!
∑th
) {

4302 
ªt
 = -
ENOMEM
;

4303 
out
;

4306 
di
 = 
	`båfs_lookup_dú_ôem
(
å™s
, 
roŸ
, 
∑th
, 
dú_öo
,

4307 &
‚ame
.
disk_«me
, -1);

4308 i‡(
	`IS_ERR_OR_NULL
(
di
)) {

4309 
ªt
 = 
di
 ? 
	`PTR_ERR
(diË: -
ENOENT
;

4310 
out
;

4313 
Àaf
 = 
∑th
->
nodes
[0];

4314 
	`båfs_dú_ôem_key_to_˝u
(
Àaf
, 
di
, &
key
);

4315 
	`WARN_ON
(
key
.
ty≥
 !
BTRFS_ROOT_ITEM_KEY
 || key.
obje˘id
 != objectid);

4316 
ªt
 = 
	`båfs_dñëe_⁄e_dú_«me
(
å™s
, 
roŸ
, 
∑th
, 
di
);

4317 i‡(
ªt
) {

4318 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4319 
out
;

4321 
	`båfs_ªÀa£_∑th
(
∑th
);

4332 i‡(
	`båfs_öo
(
öode
Ë=
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
) {

4333 
di
 = 
	`båfs_£¨ch_dú_ödex_ôem
(
roŸ
, 
∑th
, 
dú_öo
, &
‚ame
.
disk_«me
);

4334 i‡(
	`IS_ERR_OR_NULL
(
di
)) {

4335 i‡(!
di
)

4336 
ªt
 = -
ENOENT
;

4338 
ªt
 = 
	`PTR_ERR
(
di
);

4339 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4340 
out
;

4343 
Àaf
 = 
∑th
->
nodes
[0];

4344 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

4345 
ödex
 = 
key
.
off£t
;

4346 
	`båfs_ªÀa£_∑th
(
∑th
);

4348 
ªt
 = 
	`båfs_dñ_roŸ_ªf
(
å™s
, 
obje˘id
,

4349 
roŸ
->
roŸ_key
.
obje˘id
, 
dú_öo
,

4350 &
ödex
, &
‚ame
.
disk_«me
);

4351 i‡(
ªt
) {

4352 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4353 
out
;

4357 
ªt
 = 
	`båfs_dñëe_dñayed_dú_ödex
(
å™s
, 
dú
, 
ödex
);

4358 i‡(
ªt
) {

4359 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4360 
out
;

4363 
	`båfs_i_size_wrôe
(
dú
, dú->
vfs_öode
.
i_size
 - 
‚ame
.
disk_«me
.
Àn
 * 2);

4364 
	`öode_öc_ivîsi⁄
(&
dú
->
vfs_öode
);

4365 
dú
->
vfs_öode
.
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(&dir->vfs_inode);

4366 
ªt
 = 
	`båfs_upd©e_öode_ÁŒback
(
å™s
, 
roŸ
, 
dú
);

4367 i‡(
ªt
)

4368 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4369 
out
:

4370 
	`båfs_‰ì_∑th
(
∑th
);

4371 
	`fs¸y±_‰ì_fûíame
(&
‚ame
);

4372  
ªt
;

4373 
	}
}

4379 
noölöe
 
	$may_de°roy_subvﬁ
(
båfs_roŸ
 *
roŸ
)

4381 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4382 
båfs_∑th
 *
∑th
;

4383 
båfs_dú_ôem
 *
di
;

4384 
båfs_key
 
key
;

4385 
fs¸y±_°r
 
«me
 = 
	`FSTR_INIT
("default", 7);

4386 
u64
 
dú_id
;

4387 
ªt
;

4389 
∑th
 = 
	`båfs_Æloc_∑th
();

4390 i‡(!
∑th
)

4391  -
ENOMEM
;

4394 
dú_id
 = 
	`båfs_su≥r_roŸ_dú
(
fs_öfo
->
su≥r_c›y
);

4395 
di
 = 
	`båfs_lookup_dú_ôem
(
NULL
, 
fs_öfo
->
åì_roŸ
, 
∑th
,

4396 
dú_id
, &
«me
, 0);

4397 i‡(
di
 && !
	`IS_ERR
(di)) {

4398 
	`båfs_dú_ôem_key_to_˝u
(
∑th
->
nodes
[0], 
di
, &
key
);

4399 i‡(
key
.
obje˘id
 =
roŸ
->
roŸ_key
.objectid) {

4400 
ªt
 = -
EPERM
;

4401 
	`båfs_îr
(
fs_öfo
,

4403 
key
.
obje˘id
);

4404 
out
;

4406 
	`båfs_ªÀa£_∑th
(
∑th
);

4409 
key
.
obje˘id
 = 
roŸ
->
roŸ_key
.objectid;

4410 
key
.
ty≥
 = 
BTRFS_ROOT_REF_KEY
;

4411 
key
.
off£t
 = (
u64
)-1;

4413 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
fs_öfo
->
åì_roŸ
, &
key
, 
∑th
, 0, 0);

4414 i‡(
ªt
 < 0)

4415 
out
;

4416 
	`BUG_ON
(
ªt
 == 0);

4418 
ªt
 = 0;

4419 i‡(
∑th
->
¶Ÿs
[0] > 0) {

4420 
∑th
->
¶Ÿs
[0]--;

4421 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

4422 i‡(
key
.
obje˘id
 =
roŸ
->
roŸ_key
.objectid &&

4423 
key
.
ty≥
 =
BTRFS_ROOT_REF_KEY
)

4424 
ªt
 = -
ENOTEMPTY
;

4426 
out
:

4427 
	`båfs_‰ì_∑th
(
∑th
);

4428  
ªt
;

4429 
	}
}

4432 
	$båfs_¥u√_díåõs
(
båfs_roŸ
 *
roŸ
)

4434 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4435 
rb_node
 *
node
;

4436 
rb_node
 *
¥ev
;

4437 
båfs_öode
 *
íåy
;

4438 
öode
 *inode;

4439 
u64
 
obje˘id
 = 0;

4441 i‡(!
	`BTRFS_FS_ERROR
(
fs_öfo
))

4442 
	`WARN_ON
(
	`båfs_roŸ_ªfs
(&
roŸ
->
roŸ_ôem
) != 0);

4444 
	`•ö_lock
(&
roŸ
->
öode_lock
);

4445 
agaö
:

4446 
node
 = 
roŸ
->
öode_åì
.
rb_node
;

4447 
¥ev
 = 
NULL
;

4448 
node
) {

4449 
¥ev
 = 
node
;

4450 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_öode
, 
rb_node
);

4452 i‡(
obje˘id
 < 
	`båfs_öo
(
íåy
))

4453 
node
 =Çode->
rb_À·
;

4454 i‡(
obje˘id
 > 
	`båfs_öo
(
íåy
))

4455 
node
 =Çode->
rb_right
;

4459 i‡(!
node
) {

4460 
¥ev
) {

4461 
íåy
 = 
	`rb_íåy
(
¥ev
, 
båfs_öode
, 
rb_node
);

4462 i‡(
obje˘id
 <
	`båfs_öo
(
íåy
)) {

4463 
node
 = 
¥ev
;

4466 
¥ev
 = 
	`rb_√xt
(prev);

4469 
node
) {

4470 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_öode
, 
rb_node
);

4471 
obje˘id
 = 
	`båfs_öo
(
íåy
) + 1;

4472 
öode
 = 
	`igøb
(&
íåy
->
vfs_öode
);

4473 i‡(
öode
) {

4474 
	`•ö_u∆ock
(&
roŸ
->
öode_lock
);

4475 i‡(
	`©omic_ªad
(&
öode
->
i_cou¡
) > 1)

4476 
	`d_¥u√_Æü£s
(
öode
);

4481 
	`ùut
(
öode
);

4482 
	`c⁄d_ªsched
();

4483 
	`•ö_lock
(&
roŸ
->
öode_lock
);

4484 
agaö
;

4487 i‡(
	`c⁄d_ªsched_lock
(&
roŸ
->
öode_lock
))

4488 
agaö
;

4490 
node
 = 
	`rb_√xt
(node);

4492 
	`•ö_u∆ock
(&
roŸ
->
öode_lock
);

4493 
	}
}

4495 
	$båfs_dñëe_subvﬁume
(
båfs_öode
 *
dú
, 
díåy
 *dentry)

4497 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
díåy
->
d_sb
);

4498 
båfs_roŸ
 *
roŸ
 = 
dú
->root;

4499 
öode
 *öodê
	`d_öode
(
díåy
);

4500 
båfs_roŸ
 *
de°
 = 
	`BTRFS_I
(
öode
)->
roŸ
;

4501 
båfs_å™s_h™dÀ
 *
å™s
;

4502 
båfs_block_rsv
 
block_rsv
;

4503 
u64
 
roŸ_Êags
;

4504 
ªt
;

4511 
	`•ö_lock
(&
de°
->
roŸ_ôem_lock
);

4512 i‡(
de°
->
£nd_ö_¥ogªss
) {

4513 
	`•ö_u∆ock
(&
de°
->
roŸ_ôem_lock
);

4514 
	`båfs_w¨n
(
fs_öfo
,

4516 
de°
->
roŸ_key
.
obje˘id
);

4517  -
EPERM
;

4519 i‡(
	`©omic_ªad
(&
de°
->
ƒ_sw≠fûes
)) {

4520 
	`•ö_u∆ock
(&
de°
->
roŸ_ôem_lock
);

4521 
	`båfs_w¨n
(
fs_öfo
,

4523 
roŸ
->
roŸ_key
.
obje˘id
);

4524  -
EPERM
;

4526 
roŸ_Êags
 = 
	`båfs_roŸ_Êags
(&
de°
->
roŸ_ôem
);

4527 
	`båfs_£t_roŸ_Êags
(&
de°
->
roŸ_ôem
,

4528 
roŸ_Êags
 | 
BTRFS_ROOT_SUBVOL_DEAD
);

4529 
	`•ö_u∆ock
(&
de°
->
roŸ_ôem_lock
);

4531 
	`down_wrôe
(&
fs_öfo
->
subvﬁ_£m
);

4533 
ªt
 = 
	`may_de°roy_subvﬁ
(
de°
);

4534 i‡(
ªt
)

4535 
out_up_wrôe
;

4537 
	`båfs_öô_block_rsv
(&
block_rsv
, 
BTRFS_BLOCK_RSV_TEMP
);

4543 
ªt
 = 
	`båfs_subvﬁume_ª£rve_mëad©a
(
roŸ
, &
block_rsv
, 5, 
åue
);

4544 i‡(
ªt
)

4545 
out_up_wrôe
;

4547 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

4548 i‡(
	`IS_ERR
(
å™s
)) {

4549 
ªt
 = 
	`PTR_ERR
(
å™s
);

4550 
out_ªÀa£
;

4552 
å™s
->
block_rsv
 = &block_rsv;

4553 
å™s
->
byãs_ª£rved
 = 
block_rsv
.
size
;

4555 
	`båfs_ªc‹d_¢≠shŸ_de°roy
(
å™s
, 
dú
);

4557 
ªt
 = 
	`båfs_u∆ök_subvﬁ
(
å™s
, 
dú
, 
díåy
);

4558 i‡(
ªt
) {

4559 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4560 
out_íd_å™s
;

4563 
ªt
 = 
	`båfs_ªc‹d_roŸ_ö_å™s
(
å™s
, 
de°
);

4564 i‡(
ªt
) {

4565 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4566 
out_íd_å™s
;

4569 
	`mem£t
(&
de°
->
roŸ_ôem
.
dr›_¥ogªss
, 0,

4570 (
de°
->
roŸ_ôem
.
dr›_¥ogªss
));

4571 
	`båfs_£t_roŸ_dr›_Àvñ
(&
de°
->
roŸ_ôem
, 0);

4572 
	`båfs_£t_roŸ_ªfs
(&
de°
->
roŸ_ôem
, 0);

4574 i‡(!
	`ã°_™d_£t_bô
(
BTRFS_ROOT_ORPHAN_ITEM_INSERTED
, &
de°
->
°©e
)) {

4575 
ªt
 = 
	`båfs_ö£π_‹ph™_ôem
(
å™s
,

4576 
fs_öfo
->
åì_roŸ
,

4577 
de°
->
roŸ_key
.
obje˘id
);

4578 i‡(
ªt
) {

4579 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4580 
out_íd_å™s
;

4584 
ªt
 = 
	`båfs_uuid_åì_ªmove
(
å™s
, 
de°
->
roŸ_ôem
.
uuid
,

4585 
BTRFS_UUID_KEY_SUBVOL
,

4586 
de°
->
roŸ_key
.
obje˘id
);

4587 i‡(
ªt
 &&Ñë !-
ENOENT
) {

4588 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4589 
out_íd_å™s
;

4591 i‡(!
	`båfs_is_em±y_uuid
(
de°
->
roŸ_ôem
.
ª˚ived_uuid
)) {

4592 
ªt
 = 
	`båfs_uuid_åì_ªmove
(
å™s
,

4593 
de°
->
roŸ_ôem
.
ª˚ived_uuid
,

4594 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
,

4595 
de°
->
roŸ_key
.
obje˘id
);

4596 i‡(
ªt
 &&Ñë !-
ENOENT
) {

4597 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4598 
out_íd_å™s
;

4602 
	`‰ì_™⁄_bdev
(
de°
->
™⁄_dev
);

4603 
de°
->
™⁄_dev
 = 0;

4604 
out_íd_å™s
:

4605 
å™s
->
block_rsv
 = 
NULL
;

4606 
å™s
->
byãs_ª£rved
 = 0;

4607 
ªt
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

4608 
öode
->
i_Êags
 |
S_DEAD
;

4609 
out_ªÀa£
:

4610 
	`båfs_subvﬁume_ªÀa£_mëad©a
(
roŸ
, &
block_rsv
);

4611 
out_up_wrôe
:

4612 
	`up_wrôe
(&
fs_öfo
->
subvﬁ_£m
);

4613 i‡(
ªt
) {

4614 
	`•ö_lock
(&
de°
->
roŸ_ôem_lock
);

4615 
roŸ_Êags
 = 
	`båfs_roŸ_Êags
(&
de°
->
roŸ_ôem
);

4616 
	`båfs_£t_roŸ_Êags
(&
de°
->
roŸ_ôem
,

4617 
roŸ_Êags
 & ~
BTRFS_ROOT_SUBVOL_DEAD
);

4618 
	`•ö_u∆ock
(&
de°
->
roŸ_ôem_lock
);

4620 
	`d_övÆid©e
(
díåy
);

4621 
	`båfs_¥u√_díåõs
(
de°
);

4622 
	`ASSERT
(
de°
->
£nd_ö_¥ogªss
 == 0);

4625  
ªt
;

4626 
	}
}

4628 
	$båfs_rmdú
(
öode
 *
dú
, 
díåy
 *dentry)

4630 
öode
 *öodê
	`d_öode
(
díåy
);

4631 
båfs_fs_öfo
 *
fs_öfo
 = 
	`BTRFS_I
(
öode
)->
roŸ
->fs_info;

4632 
îr
 = 0;

4633 
båfs_å™s_h™dÀ
 *
å™s
;

4634 
u64
 
œ°_u∆ök_å™s
;

4635 
fs¸y±_«me
 
‚ame
;

4637 i‡(
öode
->
i_size
 > 
BTRFS_EMPTY_DIR_SIZE
)

4638  -
ENOTEMPTY
;

4639 i‡(
	`båfs_öo
(
	`BTRFS_I
(
öode
)Ë=
BTRFS_FIRST_FREE_OBJECTID
) {

4640 i‡(
	`u∆ikñy
(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
EXTENT_TREE_V2
))) {

4641 
	`båfs_îr
(
fs_öfo
,

4643  -
EOPNOTSUPP
;

4645  
	`båfs_dñëe_subvﬁume
(
	`BTRFS_I
(
dú
), 
díåy
);

4648 
îr
 = 
	`fs¸y±_£tup_fûíame
(
dú
, &
díåy
->
d_«me
, 1, &
‚ame
);

4649 i‡(
îr
)

4650  
îr
;

4654 
å™s
 = 
	`__u∆ök_°¨t_å™s
(
	`BTRFS_I
(
dú
));

4655 i‡(
	`IS_ERR
(
å™s
)) {

4656 
îr
 = 
	`PTR_ERR
(
å™s
);

4657 
out_nŸøns
;

4660 i‡(
	`u∆ikñy
(
	`båfs_öo
(
	`BTRFS_I
(
öode
)Ë=
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
)) {

4661 
îr
 = 
	`båfs_u∆ök_subvﬁ
(
å™s
, 
	`BTRFS_I
(
dú
), 
díåy
);

4662 
out
;

4665 
îr
 = 
	`båfs_‹ph™_add
(
å™s
, 
	`BTRFS_I
(
öode
));

4666 i‡(
îr
)

4667 
out
;

4669 
œ°_u∆ök_å™s
 = 
	`BTRFS_I
(
öode
)->last_unlink_trans;

4672 
îr
 = 
	`båfs_u∆ök_öode
(
å™s
, 
	`BTRFS_I
(
dú
), BTRFS_I(
	`d_öode
(
díåy
)),

4673 &
‚ame
.
disk_«me
);

4674 i‡(!
îr
) {

4675 
	`båfs_i_size_wrôe
(
	`BTRFS_I
(
öode
), 0);

4687 i‡(
œ°_u∆ök_å™s
 >
å™s
->
å™sid
)

4688 
	`BTRFS_I
(
dú
)->
œ°_u∆ök_å™s
 =Üast_unlink_trans;

4690 
out
:

4691 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

4692 
out_nŸøns
:

4693 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

4694 
	`fs¸y±_‰ì_fûíame
(&
‚ame
);

4696  
îr
;

4697 
	}
}

4710 
	$båfs_åunˇã_block
(
båfs_öode
 *
öode
, 
loff_t
 
‰om
,Üoff_à
Àn
,

4711 
‰⁄t
)

4713 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

4714 
addªss_•a˚
 *
m≠pög
 = 
öode
->
vfs_öode
.
i_m≠pög
;

4715 
exã¡_io_åì
 *
io_åì
 = &
öode
->io_tree;

4716 
båfs_‹dîed_exã¡
 *
‹dîed
;

4717 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

4718 
exã¡_ch™ge£t
 *
d©a_ª£rved
 = 
NULL
;

4719 
boﬁ
 
⁄ly_ªÀa£_mëad©a
 = 
Ál£
;

4720 
u32
 
blocksize
 = 
fs_öfo
->
£˘‹size
;

4721 
pgoff_t
 
ödex
 = 
‰om
 >> 
PAGE_SHIFT
;

4722 
off£t
 = 
‰om
 & (
blocksize
 - 1);

4723 
∑ge
 *page;

4724 
gÂ_t
 
mask
 = 
	`båfs_Æloc_wrôe_mask
(
m≠pög
);

4725 
size_t
 
wrôe_byãs
 = 
blocksize
;

4726 
ªt
 = 0;

4727 
u64
 
block_°¨t
;

4728 
u64
 
block_íd
;

4730 i‡(
	`IS_ALIGNED
(
off£t
, 
blocksize
) &&

4731 (!
Àn
 || 
	`IS_ALIGNED
÷í, 
blocksize
)))

4732 
out
;

4734 
block_°¨t
 = 
	`round_down
(
‰om
, 
blocksize
);

4735 
block_íd
 = 
block_°¨t
 + 
blocksize
 - 1;

4737 
ªt
 = 
	`båfs_check_d©a_‰ì_•a˚
(
öode
, &
d©a_ª£rved
, 
block_°¨t
,

4738 
blocksize
, 
Ál£
);

4739 i‡(
ªt
 < 0) {

4740 i‡(
	`båfs_check_nocow_lock
(
öode
, 
block_°¨t
, &
wrôe_byãs
, 
Ál£
) > 0) {

4742 
⁄ly_ªÀa£_mëad©a
 = 
åue
;

4744 
out
;

4747 
ªt
 = 
	`båfs_dñÆloc_ª£rve_mëad©a
(
öode
, 
blocksize
, blocksize, 
Ál£
);

4748 i‡(
ªt
 < 0) {

4749 i‡(!
⁄ly_ªÀa£_mëad©a
)

4750 
	`båfs_‰ì_ª£rved_d©a_•a˚
(
öode
, 
d©a_ª£rved
,

4751 
block_°¨t
, 
blocksize
);

4752 
out
;

4754 
agaö
:

4755 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
m≠pög
, 
ödex
, 
mask
);

4756 i‡(!
∑ge
) {

4757 
	`båfs_dñÆloc_ªÀa£_•a˚
(
öode
, 
d©a_ª£rved
, 
block_°¨t
,

4758 
blocksize
, 
åue
);

4759 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
öode
, 
blocksize
);

4760 
ªt
 = -
ENOMEM
;

4761 
out
;

4764 i‡(!
	`PageU±od©e
(
∑ge
)) {

4765 
ªt
 = 
	`båfs_ªad_fﬁio
(
NULL
, 
	`∑ge_fﬁio
(
∑ge
));

4766 
	`lock_∑ge
(
∑ge
);

4767 i‡(
∑ge
->
m≠pög
 != mapping) {

4768 
	`u∆ock_∑ge
(
∑ge
);

4769 
	`put_∑ge
(
∑ge
);

4770 
agaö
;

4772 i‡(!
	`PageU±od©e
(
∑ge
)) {

4773 
ªt
 = -
EIO
;

4774 
out_u∆ock
;

4784 
ªt
 = 
	`£t_∑ge_exã¡_m≠≥d
(
∑ge
);

4785 i‡(
ªt
 < 0)

4786 
out_u∆ock
;

4788 
	`waô_⁄_∑ge_wrôeback
(
∑ge
);

4790 
	`lock_exã¡
(
io_åì
, 
block_°¨t
, 
block_íd
, &
ˇched_°©e
);

4792 
‹dîed
 = 
	`båfs_lookup_‹dîed_exã¡
(
öode
, 
block_°¨t
);

4793 i‡(
‹dîed
) {

4794 
	`u∆ock_exã¡
(
io_åì
, 
block_°¨t
, 
block_íd
, &
ˇched_°©e
);

4795 
	`u∆ock_∑ge
(
∑ge
);

4796 
	`put_∑ge
(
∑ge
);

4797 
	`båfs_°¨t_‹dîed_exã¡
(
‹dîed
);

4798 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

4799 
agaö
;

4802 
	`˛ór_exã¡_bô
(&
öode
->
io_åì
, 
block_°¨t
, 
block_íd
,

4803 
EXTENT_DELALLOC
 | 
EXTENT_DO_ACCOUNTING
 | 
EXTENT_DEFRAG
,

4804 &
ˇched_°©e
);

4806 
ªt
 = 
	`båfs_£t_exã¡_dñÆloc
(
öode
, 
block_°¨t
, 
block_íd
, 0,

4807 &
ˇched_°©e
);

4808 i‡(
ªt
) {

4809 
	`u∆ock_exã¡
(
io_åì
, 
block_°¨t
, 
block_íd
, &
ˇched_°©e
);

4810 
out_u∆ock
;

4813 i‡(
off£t
 !
blocksize
) {

4814 i‡(!
Àn
)

4815 
Àn
 = 
blocksize
 - 
off£t
;

4816 i‡(
‰⁄t
)

4817 
	`memzîo_∑ge
(
∑ge
, (
block_°¨t
 - 
	`∑ge_off£t
(page)),

4818 
off£t
);

4820 
	`memzîo_∑ge
(
∑ge
, (
block_°¨t
 - 
	`∑ge_off£t
’age)Ë+ 
off£t
,

4821 
Àn
);

4823 
	`båfs_∑ge_˛ór_checked
(
fs_öfo
, 
∑ge
, 
block_°¨t
,

4824 
block_íd
 + 1 - 
block_°¨t
);

4825 
	`båfs_∑ge_£t_dúty
(
fs_öfo
, 
∑ge
, 
block_°¨t
, 
block_íd
 + 1 - block_start);

4826 
	`u∆ock_exã¡
(
io_åì
, 
block_°¨t
, 
block_íd
, &
ˇched_°©e
);

4828 i‡(
⁄ly_ªÀa£_mëad©a
)

4829 
	`£t_exã¡_bô
(&
öode
->
io_åì
, 
block_°¨t
, 
block_íd
,

4830 
EXTENT_NORESERVE
, 
NULL
);

4832 
out_u∆ock
:

4833 i‡(
ªt
) {

4834 i‡(
⁄ly_ªÀa£_mëad©a
)

4835 
	`båfs_dñÆloc_ªÀa£_mëad©a
(
öode
, 
blocksize
, 
åue
);

4837 
	`båfs_dñÆloc_ªÀa£_•a˚
(
öode
, 
d©a_ª£rved
,

4838 
block_°¨t
, 
blocksize
, 
åue
);

4840 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
öode
, 
blocksize
);

4841 
	`u∆ock_∑ge
(
∑ge
);

4842 
	`put_∑ge
(
∑ge
);

4843 
out
:

4844 i‡(
⁄ly_ªÀa£_mëad©a
)

4845 
	`båfs_check_nocow_u∆ock
(
öode
);

4846 
	`exã¡_ch™ge£t_‰ì
(
d©a_ª£rved
);

4847  
ªt
;

4848 
	}
}

4850 
	$maybe_ö£π_hﬁe
(
båfs_roŸ
 *
roŸ
, 
båfs_öode
 *
öode
,

4851 
u64
 
off£t
, u64 
Àn
)

4853 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4854 
båfs_å™s_h™dÀ
 *
å™s
;

4855 
båfs_dr›_exã¡s_¨gs
 
dr›_¨gs
 = { 0 };

4856 
ªt
;

4864 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
NO_HOLES
))

4872 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 3);

4873 i‡(
	`IS_ERR
(
å™s
))

4874  
	`PTR_ERR
(
å™s
);

4876 
dr›_¨gs
.
°¨t
 = 
off£t
;

4877 
dr›_¨gs
.
íd
 = 
off£t
 + 
Àn
;

4878 
dr›_¨gs
.
dr›_ˇche
 = 
åue
;

4880 
ªt
 = 
	`båfs_dr›_exã¡s
(
å™s
, 
roŸ
, 
öode
, &
dr›_¨gs
);

4881 i‡(
ªt
) {

4882 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4883 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

4884  
ªt
;

4887 
ªt
 = 
	`båfs_ö£π_hﬁe_exã¡
(
å™s
, 
roŸ
, 
	`båfs_öo
(
öode
), 
off£t
, 
Àn
);

4888 i‡(
ªt
) {

4889 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4891 
	`båfs_upd©e_öode_byãs
(
öode
, 0, 
dr›_¨gs
.
byãs_found
);

4892 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
öode
);

4894 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

4895  
ªt
;

4896 
	}
}

4904 
	$båfs_c⁄t_ex∑nd
(
båfs_öode
 *
öode
, 
loff_t
 
ﬁdsize
,Üoff_à
size
)

4906 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

4907 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4908 
exã¡_io_åì
 *
io_åì
 = &
öode
->io_tree;

4909 
exã¡_m≠
 *
em
 = 
NULL
;

4910 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

4911 
u64
 
hﬁe_°¨t
 = 
	`ALIGN
(
ﬁdsize
, 
fs_öfo
->
£˘‹size
);

4912 
u64
 
block_íd
 = 
	`ALIGN
(
size
, 
fs_öfo
->
£˘‹size
);

4913 
u64
 
œ°_byã
;

4914 
u64
 
cur_off£t
;

4915 
u64
 
hﬁe_size
;

4916 
îr
 = 0;

4923 
îr
 = 
	`båfs_åunˇã_block
(
öode
, 
ﬁdsize
, 0, 0);

4924 i‡(
îr
)

4925  
îr
;

4927 i‡(
size
 <
hﬁe_°¨t
)

4930 
	`båfs_lock_™d_Êush_‹dîed_ønge
(
öode
, 
hﬁe_°¨t
, 
block_íd
 - 1,

4931 &
ˇched_°©e
);

4932 
cur_off£t
 = 
hﬁe_°¨t
;

4934 
em
 = 
	`båfs_gë_exã¡
(
öode
, 
NULL
, 0, 
cur_off£t
,

4935 
block_íd
 - 
cur_off£t
);

4936 i‡(
	`IS_ERR
(
em
)) {

4937 
îr
 = 
	`PTR_ERR
(
em
);

4938 
em
 = 
NULL
;

4941 
œ°_byã
 = 
	`mö
(
	`exã¡_m≠_íd
(
em
), 
block_íd
);

4942 
œ°_byã
 = 
	`ALIGN
÷a°_byã, 
fs_öfo
->
£˘‹size
);

4943 
hﬁe_size
 = 
œ°_byã
 - 
cur_off£t
;

4945 i‡(!
	`ã°_bô
(
EXTENT_FLAG_PREALLOC
, &
em
->
Êags
)) {

4946 
exã¡_m≠
 *
hﬁe_em
;

4948 
îr
 = 
	`maybe_ö£π_hﬁe
(
roŸ
, 
öode
, 
cur_off£t
,

4949 
hﬁe_size
);

4950 i‡(
îr
)

4953 
îr
 = 
	`båfs_öode_£t_fûe_exã¡_ønge
(
öode
,

4954 
cur_off£t
, 
hﬁe_size
);

4955 i‡(
îr
)

4958 
hﬁe_em
 = 
	`Æloc_exã¡_m≠
();

4959 i‡(!
hﬁe_em
) {

4960 
	`båfs_dr›_exã¡_m≠_ønge
(
öode
, 
cur_off£t
,

4961 
cur_off£t
 + 
hﬁe_size
 - 1,

4962 
Ál£
);

4963 
	`båfs_£t_öode_fuŒ_sync
(
öode
);

4964 
√xt
;

4966 
hﬁe_em
->
°¨t
 = 
cur_off£t
;

4967 
hﬁe_em
->
Àn
 = 
hﬁe_size
;

4968 
hﬁe_em
->
‹ig_°¨t
 = 
cur_off£t
;

4970 
hﬁe_em
->
block_°¨t
 = 
EXTENT_MAP_HOLE
;

4971 
hﬁe_em
->
block_Àn
 = 0;

4972 
hﬁe_em
->
‹ig_block_Àn
 = 0;

4973 
hﬁe_em
->
øm_byãs
 = 
hﬁe_size
;

4974 
hﬁe_em
->
com¥ess_ty≥
 = 
BTRFS_COMPRESS_NONE
;

4975 
hﬁe_em
->
gíî©i⁄
 = 
fs_öfo
->generation;

4977 
îr
 = 
	`båfs_ª∂a˚_exã¡_m≠_ønge
(
öode
, 
hﬁe_em
, 
åue
);

4978 
	`‰ì_exã¡_m≠
(
hﬁe_em
);

4980 
îr
 = 
	`båfs_öode_£t_fûe_exã¡_ønge
(
öode
,

4981 
cur_off£t
, 
hﬁe_size
);

4982 i‡(
îr
)

4985 
√xt
:

4986 
	`‰ì_exã¡_m≠
(
em
);

4987 
em
 = 
NULL
;

4988 
cur_off£t
 = 
œ°_byã
;

4989 i‡(
cur_off£t
 >
block_íd
)

4992 
	`‰ì_exã¡_m≠
(
em
);

4993 
	`u∆ock_exã¡
(
io_åì
, 
hﬁe_°¨t
, 
block_íd
 - 1, &
ˇched_°©e
);

4994  
îr
;

4995 
	}
}

4997 
	$båfs_£tsize
(
öode
 *öode, 
üâr
 *
©å
)

4999 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

5000 
båfs_å™s_h™dÀ
 *
å™s
;

5001 
loff_t
 
ﬁdsize
 = 
	`i_size_ªad
(
öode
);

5002 
loff_t
 
√wsize
 = 
©å
->
ü_size
;

5003 
mask
 = 
©å
->
ü_vÆid
;

5004 
ªt
;

5012 i‡(
√wsize
 !
ﬁdsize
) {

5013 
	`öode_öc_ivîsi⁄
(
öode
);

5014 i‡(!(
mask
 & (
ATTR_CTIME
 | 
ATTR_MTIME
))) {

5015 
öode
->
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(inode);

5019 i‡(
√wsize
 > 
ﬁdsize
) {

5027 
	`båfs_dªw_wrôe_lock
(&
roŸ
->
¢≠shŸ_lock
);

5028 
ªt
 = 
	`båfs_c⁄t_ex∑nd
(
	`BTRFS_I
(
öode
), 
ﬁdsize
, 
√wsize
);

5029 i‡(
ªt
) {

5030 
	`båfs_dªw_wrôe_u∆ock
(&
roŸ
->
¢≠shŸ_lock
);

5031  
ªt
;

5034 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 1);

5035 i‡(
	`IS_ERR
(
å™s
)) {

5036 
	`båfs_dªw_wrôe_u∆ock
(&
roŸ
->
¢≠shŸ_lock
);

5037  
	`PTR_ERR
(
å™s
);

5040 
	`i_size_wrôe
(
öode
, 
√wsize
);

5041 
	`båfs_öode_ß„_disk_i_size_wrôe
(
	`BTRFS_I
(
öode
), 0);

5042 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁdsize
, 
√wsize
);

5043 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

5044 
	`båfs_dªw_wrôe_u∆ock
(&
roŸ
->
¢≠shŸ_lock
);

5045 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

5047 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

5049 i‡(
	`båfs_is_z⁄ed
(
fs_öfo
)) {

5050 
ªt
 = 
	`båfs_waô_‹dîed_ønge
(
öode
,

5051 
	`ALIGN
(
√wsize
, 
fs_öfo
->
£˘‹size
),

5052 (
u64
)-1);

5053 i‡(
ªt
)

5054  
ªt
;

5062 i‡(
√wsize
 == 0)

5063 
	`£t_bô
(
BTRFS_INODE_FLUSH_ON_CLOSE
,

5064 &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
);

5066 
	`åunˇã_£tsize
(
öode
, 
√wsize
);

5068 
	`öode_dio_waô
(
öode
);

5070 
ªt
 = 
	`båfs_åunˇã
(
	`BTRFS_I
(
öode
), 
√wsize
 =
ﬁdsize
);

5071 i‡(
ªt
 && 
öode
->
i_∆ök
) {

5072 
îr
;

5080 
îr
 = 
	`båfs_waô_‹dîed_ønge
(
öode
, 0, (
u64
)-1);

5081 i‡(
îr
)

5082  
îr
;

5083 
	`i_size_wrôe
(
öode
, 
	`BTRFS_I
(öode)->
disk_i_size
);

5087  
ªt
;

5088 
	}
}

5090 
	$båfs_£èâr
(
m¡_idm≠
 *
idm≠
, 
díåy
 *dentry,

5091 
üâr
 *
©å
)

5093 
	`¥ötk
(
KERN_INFO
 "btrfs_setattr: Called...\n");

5094 
öode
 *öodê
	`d_öode
(
díåy
);

5095 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

5096 
îr
;

5098 i‡(
	`båfs_roŸ_ªad⁄ly
(
roŸ
))

5099  -
EROFS
;

5101 
îr
 = 
	`£èâr_¥ï¨e
(
idm≠
, 
díåy
, 
©å
);

5102 i‡(
îr
)

5103  
îr
;

5105 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë&& (
©å
->
ü_vÆid
 & 
ATTR_SIZE
)) {

5106 
îr
 = 
	`båfs_£tsize
(
öode
, 
©å
);

5107 i‡(
îr
)

5108  
îr
;

5111 i‡(
©å
->
ü_vÆid
) {

5112 
	`£èâr_c›y
(
idm≠
, 
öode
, 
©å
);

5113 
	`öode_öc_ivîsi⁄
(
öode
);

5114 
îr
 = 
	`båfs_dúty_öode
(
	`BTRFS_I
(
öode
));

5116 i‡(!
îr
 && 
©å
->
ü_vÆid
 & 
ATTR_MODE
)

5117 
îr
 = 
	`posix_a˛_chmod
(
idm≠
, 
díåy
, 
öode
->
i_mode
);

5120  
îr
;

5121 
	}
}

5136 
	$evi˘_öode_åunˇã_∑ges
(
öode
 *inode)

5138 
exã¡_io_åì
 *
io_åì
 = &
	`BTRFS_I
(
öode
)->io_tree;

5139 
rb_node
 *
node
;

5141 
	`ASSERT
(
öode
->
i_°©e
 & 
I_FREEING
);

5142 
	`åunˇã_öode_∑ges_föÆ
(&
öode
->
i_d©a
);

5144 
	`båfs_dr›_exã¡_m≠_ønge
(
	`BTRFS_I
(
öode
), 0, (
u64
)-1, 
Ál£
);

5162 
	`•ö_lock
(&
io_åì
->
lock
);

5163 !
	`RB_EMPTY_ROOT
(&
io_åì
->
°©e
)) {

5164 
exã¡_°©e
 *
°©e
;

5165 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

5166 
u64
 
°¨t
;

5167 
u64
 
íd
;

5168 
°©e_Êags
;

5170 
node
 = 
	`rb_fú°
(&
io_åì
->
°©e
);

5171 
°©e
 = 
	`rb_íåy
(
node
, 
exã¡_°©e
, 
rb_node
);

5172 
°¨t
 = 
°©e
->start;

5173 
íd
 = 
°©e
->end;

5174 
°©e_Êags
 = 
°©e
->state;

5175 
	`•ö_u∆ock
(&
io_åì
->
lock
);

5177 
	`lock_exã¡
(
io_åì
, 
°¨t
, 
íd
, &
ˇched_°©e
);

5187 i‡(
°©e_Êags
 & 
EXTENT_DELALLOC
)

5188 
	`båfs_qgroup_‰ì_d©a
(
	`BTRFS_I
(
öode
), 
NULL
, 
°¨t
,

5189 
íd
 - 
°¨t
 + 1, 
NULL
);

5191 
	`˛ór_exã¡_bô
(
io_åì
, 
°¨t
, 
íd
,

5192 
EXTENT_CLEAR_ALL_BITS
 | 
EXTENT_DO_ACCOUNTING
,

5193 &
ˇched_°©e
);

5195 
	`c⁄d_ªsched
();

5196 
	`•ö_lock
(&
io_åì
->
lock
);

5198 
	`•ö_u∆ock
(&
io_åì
->
lock
);

5199 
	}
}

5201 
båfs_å™s_h™dÀ
 *
	$evi˘_ªfûl_™d_joö
(
båfs_roŸ
 *
roŸ
,

5202 
båfs_block_rsv
 *
rsv
)

5204 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

5205 
båfs_å™s_h™dÀ
 *
å™s
;

5206 
u64
 
dñayed_ªfs_exåa
 = 
	`båfs_ˇlc_dñayed_ªf_byãs
(
fs_öfo
, 1);

5207 
ªt
;

5223 
ªt
 = 
	`båfs_block_rsv_ªfûl
(
fs_öfo
, 
rsv
,Ñsv->
size
 + 
dñayed_ªfs_exåa
,

5224 
BTRFS_RESERVE_FLUSH_EVICT
);

5225 i‡(
ªt
) {

5226 
ªt
 = 
	`båfs_block_rsv_ªfûl
(
fs_öfo
, 
rsv
,Ñsv->
size
,

5227 
BTRFS_RESERVE_FLUSH_EVICT
);

5228 i‡(
ªt
) {

5229 
	`båfs_w¨n
(
fs_öfo
,

5231  
	`ERR_PTR
(-
ENOSPC
);

5233 
dñayed_ªfs_exåa
 = 0;

5236 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
roŸ
);

5237 i‡(
	`IS_ERR
(
å™s
))

5238  
å™s
;

5240 i‡(
dñayed_ªfs_exåa
) {

5241 
å™s
->
block_rsv
 = &
fs_öfo
->
å™s_block_rsv
;

5242 
å™s
->
byãs_ª£rved
 = 
dñayed_ªfs_exåa
;

5243 
	`båfs_block_rsv_migøã
(
rsv
, 
å™s
->
block_rsv
,

5244 
dñayed_ªfs_exåa
, 
åue
);

5246  
å™s
;

5247 
	}
}

5249 
	$båfs_evi˘_öode
(
öode
 *inode)

5251 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

5252 
båfs_å™s_h™dÀ
 *
å™s
;

5253 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

5254 
båfs_block_rsv
 *
rsv
 = 
NULL
;

5255 
ªt
;

5257 
	`åa˚_båfs_öode_evi˘
(
öode
);

5259 i‡(!
roŸ
) {

5260 
	`fsvîôy_˛ónup_öode
(
öode
);

5261 
	`˛ór_öode
(
öode
);

5265 
	`evi˘_öode_åunˇã_∑ges
(
öode
);

5267 i‡(
öode
->
i_∆ök
 &&

5268 ((
	`båfs_roŸ_ªfs
(&
roŸ
->
roŸ_ôem
) != 0 &&

5269 
roŸ
->
roŸ_key
.
obje˘id
 !
BTRFS_ROOT_TREE_OBJECTID
) ||

5270 
	`båfs_is_‰ì_•a˚_öode
(
	`BTRFS_I
(
öode
))))

5271 
out
;

5273 i‡(
	`is_bad_öode
(
öode
))

5274 
out
;

5276 i‡(
	`ã°_bô
(
BTRFS_FS_LOG_RECOVERING
, &
fs_öfo
->
Êags
))

5277 
out
;

5279 i‡(
öode
->
i_∆ök
 > 0) {

5280 
	`BUG_ON
(
	`båfs_roŸ_ªfs
(&
roŸ
->
roŸ_ôem
) != 0 &&

5281 
roŸ
->
roŸ_key
.
obje˘id
 !
BTRFS_ROOT_TREE_OBJECTID
);

5282 
out
;

5289 
ªt
 = 
	`båfs_commô_öode_dñayed_öode
(
	`BTRFS_I
(
öode
));

5290 i‡(
ªt
)

5291 
out
;

5299 
	`båfs_kûl_dñayed_öode_ôems
(
	`BTRFS_I
(
öode
));

5301 
rsv
 = 
	`båfs_Æloc_block_rsv
(
fs_öfo
, 
BTRFS_BLOCK_RSV_TEMP
);

5302 i‡(!
rsv
)

5303 
out
;

5304 
rsv
->
size
 = 
	`båfs_ˇlc_mëad©a_size
(
fs_öfo
, 1);

5305 
rsv
->
ÁûÁ°
 = 
åue
;

5307 
	`båfs_i_size_wrôe
(
	`BTRFS_I
(
öode
), 0);

5310 
båfs_åunˇã_c⁄åﬁ
 
c⁄åﬁ
 = {

5311 .
öode
 = 
	`BTRFS_I
(inode),

5312 .
öo
 = 
	`båfs_öo
(
	`BTRFS_I
(
öode
)),

5313 .
√w_size
 = 0,

5314 .
mö_ty≥
 = 0,

5317 
å™s
 = 
	`evi˘_ªfûl_™d_joö
(
roŸ
, 
rsv
);

5318 i‡(
	`IS_ERR
(
å™s
))

5319 
out
;

5321 
å™s
->
block_rsv
 = 
rsv
;

5323 
ªt
 = 
	`båfs_åunˇã_öode_ôems
(
å™s
, 
roŸ
, &
c⁄åﬁ
);

5324 
å™s
->
block_rsv
 = &
fs_öfo
->
å™s_block_rsv
;

5325 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

5331 
	`båfs_båì_bÆ™˚_dúty_nodñay
(
fs_öfo
);

5332 i‡(
ªt
 &&Ñë !-
ENOSPC
 &&Ñë !-
EAGAIN
)

5333 
out
;

5334 i‡(!
ªt
)

5347 
å™s
 = 
	`evi˘_ªfûl_™d_joö
(
roŸ
, 
rsv
);

5348 i‡(!
	`IS_ERR
(
å™s
)) {

5349 
å™s
->
block_rsv
 = 
rsv
;

5350 
	`båfs_‹ph™_dñ
(
å™s
, 
	`BTRFS_I
(
öode
));

5351 
å™s
->
block_rsv
 = &
fs_öfo
->
å™s_block_rsv
;

5352 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

5355 
out
:

5356 
	`båfs_‰ì_block_rsv
(
fs_öfo
, 
rsv
);

5362 
	`båfs_ªmove_dñayed_node
(
	`BTRFS_I
(
öode
));

5363 
	`fsvîôy_˛ónup_öode
(
öode
);

5364 
	`˛ór_öode
(
öode
);

5365 
	}
}

5374 
	$båfs_öode_by_«me
(
båfs_öode
 *
dú
, 
díåy
 *dentry,

5375 
båfs_key
 *
loˇti⁄
, 
u8
 *
ty≥
)

5377 
båfs_dú_ôem
 *
di
;

5378 
båfs_∑th
 *
∑th
;

5379 
båfs_roŸ
 *
roŸ
 = 
dú
->root;

5380 
ªt
 = 0;

5381 
fs¸y±_«me
 
‚ame
;

5384 
öode
 *
dú_öode
 = &
dú
->
vfs_öode
;

5385 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
dú_öode
->
i_sb
);

5389 
∑th
 = 
	`båfs_Æloc_∑th
();

5390 i‡(!
∑th
)

5391  -
ENOMEM
;

5393 
ªt
 = 
	`fs¸y±_£tup_fûíame
(&
dú
->
vfs_öode
, &
díåy
->
d_«me
, 1, &
‚ame
);

5394 i‡(
ªt
 < 0)

5395 
out
;

5400 
	`ASSERT
(
ªt
 == 0);

5404 
di
 = 
	`båfs_lookup_dú_ôem
(
NULL
, 
roŸ
, 
∑th
, 
	`båfs_öo
(
dú
),

5405 &
‚ame
.
disk_«me
, 0);

5406 i‡(
	`IS_ERR_OR_NULL
(
di
)) {

5407 
ªt
 = 
di
 ? 
	`PTR_ERR
(diË: -
ENOENT
;

5408 
out
;

5411 
	`båfs_dú_ôem_key_to_˝u
(
∑th
->
nodes
[0], 
di
, 
loˇti⁄
);

5412 i‡(
loˇti⁄
->
ty≥
 !
BTRFS_INODE_ITEM_KEY
 &&

5413 
loˇti⁄
->
ty≥
 !
BTRFS_ROOT_ITEM_KEY
) {

5414 
ªt
 = -
EUCLEAN
;

5415 
	`båfs_w¨n
(
roŸ
->
fs_öfo
,

5417 
__func__
, 
‚ame
.
disk_«me
.
«me
, 
	`båfs_öo
(
dú
),

5418 
loˇti⁄
->
obje˘id
,Üoˇti⁄->
ty≥
,Üoˇti⁄->
off£t
);

5420 i‡(!
ªt
)

5421 *
ty≥
 = 
	`båfs_dú_·y≥
(
∑th
->
nodes
[0], 
di
);

5422 
out
:

5423 
	`fs¸y±_‰ì_fûíame
(&
‚ame
);

5424 
	`båfs_‰ì_∑th
(
∑th
);

5425  
ªt
;

5426 
	}
}

5433 
	$fixup_åì_roŸ_loˇti⁄
(
båfs_fs_öfo
 *
fs_öfo
,

5434 
båfs_öode
 *
dú
,

5435 
díåy
 *dentry,

5436 
båfs_key
 *
loˇti⁄
,

5437 
båfs_roŸ
 **
sub_roŸ
)

5439 
båfs_∑th
 *
∑th
;

5440 
båfs_roŸ
 *
√w_roŸ
;

5441 
båfs_roŸ_ªf
 *
ªf
;

5442 
exã¡_buf„r
 *
Àaf
;

5443 
båfs_key
 
key
;

5444 
ªt
;

5445 
îr
 = 0;

5446 
fs¸y±_«me
 
‚ame
;

5448 
ªt
 = 
	`fs¸y±_£tup_fûíame
(&
dú
->
vfs_öode
, &
díåy
->
d_«me
, 0, &
‚ame
);

5449 i‡(
ªt
)

5450  
ªt
;

5452 
∑th
 = 
	`båfs_Æloc_∑th
();

5453 i‡(!
∑th
) {

5454 
îr
 = -
ENOMEM
;

5455 
out
;

5458 
îr
 = -
ENOENT
;

5459 
key
.
obje˘id
 = 
dú
->
roŸ
->
roŸ_key
.objectid;

5460 
key
.
ty≥
 = 
BTRFS_ROOT_REF_KEY
;

5461 
key
.
off£t
 = 
loˇti⁄
->
obje˘id
;

5463 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
fs_öfo
->
åì_roŸ
, &
key
, 
∑th
, 0, 0);

5464 i‡(
ªt
) {

5465 i‡(
ªt
 < 0)

5466 
îr
 = 
ªt
;

5467 
out
;

5470 
Àaf
 = 
∑th
->
nodes
[0];

5471 
ªf
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_roŸ_ªf
);

5472 i‡(
	`båfs_roŸ_ªf_dúid
(
Àaf
, 
ªf
Ë!
	`båfs_öo
(
dú
) ||

5473 
	`båfs_roŸ_ªf_«me_Àn
(
Àaf
, 
ªf
Ë!
‚ame
.
disk_«me
.
Àn
)

5474 
out
;

5476 
ªt
 = 
	`memcmp_exã¡_buf„r
(
Àaf
, 
‚ame
.
disk_«me
.
«me
,

5477 ()(
ªf
 + 1), 
‚ame
.
disk_«me
.
Àn
);

5478 i‡(
ªt
)

5479 
out
;

5481 
	`båfs_ªÀa£_∑th
(
∑th
);

5483 
√w_roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
loˇti⁄
->
obje˘id
, 
åue
);

5484 i‡(
	`IS_ERR
(
√w_roŸ
)) {

5485 
îr
 = 
	`PTR_ERR
(
√w_roŸ
);

5486 
out
;

5489 *
sub_roŸ
 = 
√w_roŸ
;

5490 
loˇti⁄
->
obje˘id
 = 
	`båfs_roŸ_dúid
(&
√w_roŸ
->
roŸ_ôem
);

5491 
loˇti⁄
->
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

5492 
loˇti⁄
->
off£t
 = 0;

5493 
îr
 = 0;

5494 
out
:

5495 
	`båfs_‰ì_∑th
(
∑th
);

5496 
	`fs¸y±_‰ì_fûíame
(&
‚ame
);

5497  
îr
;

5498 
	}
}

5500 
	$öode_åì_add
(
båfs_öode
 *
öode
)

5502 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

5503 
båfs_öode
 *
íåy
;

5504 
rb_node
 **
p
;

5505 
rb_node
 *
∑ª¡
;

5506 
rb_node
 *
√w
 = &
öode
->rb_node;

5507 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

5509 i‡(
	`öode_unhashed
(&
öode
->
vfs_öode
))

5511 
∑ª¡
 = 
NULL
;

5512 
	`•ö_lock
(&
roŸ
->
öode_lock
);

5513 
p
 = &
roŸ
->
öode_åì
.
rb_node
;

5514 *
p
) {

5515 
∑ª¡
 = *
p
;

5516 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
båfs_öode
, 
rb_node
);

5518 i‡(
öo
 < 
	`båfs_öo
(
íåy
))

5519 
p
 = &
∑ª¡
->
rb_À·
;

5520 i‡(
öo
 > 
	`båfs_öo
(
íåy
))

5521 
p
 = &
∑ª¡
->
rb_right
;

5523 
	`WARN_ON
(!(
íåy
->
vfs_öode
.
i_°©e
 &

5524 (
I_WILL_FREE
 | 
I_FREEING
)));

5525 
	`rb_ª∂a˚_node
(
∑ª¡
, 
√w
, &
roŸ
->
öode_åì
);

5526 
	`RB_CLEAR_NODE
(
∑ª¡
);

5527 
	`•ö_u∆ock
(&
roŸ
->
öode_lock
);

5531 
	`rb_lök_node
(
√w
, 
∑ª¡
, 
p
);

5532 
	`rb_ö£π_cﬁ‹
(
√w
, &
roŸ
->
öode_åì
);

5533 
	`•ö_u∆ock
(&
roŸ
->
öode_lock
);

5534 
	}
}

5536 
	$öode_åì_dñ
(
båfs_öode
 *
öode
)

5538 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

5539 
em±y
 = 0;

5541 
	`•ö_lock
(&
roŸ
->
öode_lock
);

5542 i‡(!
	`RB_EMPTY_NODE
(&
öode
->
rb_node
)) {

5543 
	`rb_îa£
(&
öode
->
rb_node
, &
roŸ
->
öode_åì
);

5544 
	`RB_CLEAR_NODE
(&
öode
->
rb_node
);

5545 
em±y
 = 
	`RB_EMPTY_ROOT
(&
roŸ
->
öode_åì
);

5547 
	`•ö_u∆ock
(&
roŸ
->
öode_lock
);

5549 i‡(
em±y
 && 
	`båfs_roŸ_ªfs
(&
roŸ
->
roŸ_ôem
) == 0) {

5550 
	`•ö_lock
(&
roŸ
->
öode_lock
);

5551 
em±y
 = 
	`RB_EMPTY_ROOT
(&
roŸ
->
öode_åì
);

5552 
	`•ö_u∆ock
(&
roŸ
->
öode_lock
);

5553 i‡(
em±y
)

5554 
	`båfs_add_dód_roŸ
(
roŸ
);

5556 
	}
}

5559 
	$båfs_öô_locked_öode
(
öode
 *öode, *
p
)

5561 
båfs_igë_¨gs
 *
¨gs
 = 
p
;

5563 
öode
->
i_öo
 = 
¨gs
->
öo
;

5564 
	`BTRFS_I
(
öode
)->
loˇti⁄
.
obje˘id
 = 
¨gs
->
öo
;

5565 
	`BTRFS_I
(
öode
)->
loˇti⁄
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

5566 
	`BTRFS_I
(
öode
)->
loˇti⁄
.
off£t
 = 0;

5567 
	`BTRFS_I
(
öode
)->
roŸ
 = 
	`båfs_gøb_roŸ
(
¨gs
->root);

5568 
	`BUG_ON
(
¨gs
->
roŸ
 && !
	`BTRFS_I
(
öode
)->root);

5570 i‡(
¨gs
->
roŸ
 &&árgs->roŸ =¨gs->roŸ->
fs_öfo
->
åì_roŸ
 &&

5571 
¨gs
->
öo
 !
BTRFS_BTREE_INODE_OBJECTID
)

5572 
	`£t_bô
(
BTRFS_INODE_FREE_SPACE_INODE
,

5573 &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
);

5575 
	}
}

5577 
	$båfs_föd_a˘‹
(
öode
 *öode, *
›aque
)

5579 
båfs_igë_¨gs
 *
¨gs
 = 
›aque
;

5581  
¨gs
->
öo
 =
	`BTRFS_I
(
öode
)->
loˇti⁄
.
obje˘id
 &&

5582 
¨gs
->
roŸ
 =
	`BTRFS_I
(
öode
)->root;

5583 
	}
}

5585 
öode
 *
	$båfs_igë_locked
(
su≥r_block
 *
s
, 
u64
 
öo
,

5586 
båfs_roŸ
 *
roŸ
)

5588 
öode
 *inode;

5589 
båfs_igë_¨gs
 
¨gs
;

5590 
hashvÆ
 = 
	`båfs_öode_hash
(
öo
, 
roŸ
);

5592 
¨gs
.
öo
 = ino;

5593 
¨gs
.
roŸ
 =Ñoot;

5595 
öode
 = 
	`igë5_locked
(
s
, 
hashvÆ
, 
båfs_föd_a˘‹
,

5596 
båfs_öô_locked_öode
,

5597 (*)&
¨gs
);

5598  
öode
;

5599 
	}
}

5607 
öode
 *
	$båfs_igë_∑th
(
su≥r_block
 *
s
, 
u64
 
öo
,

5608 
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
)

5610 
öode
 *inode;

5612 
öode
 = 
	`båfs_igë_locked
(
s
, 
öo
, 
roŸ
);

5613 i‡(!
öode
)

5614  
	`ERR_PTR
(-
ENOMEM
);

5616 i‡(
öode
->
i_°©e
 & 
I_NEW
) {

5617 
ªt
;

5619 
ªt
 = 
	`båfs_ªad_locked_öode
(
öode
, 
∑th
);

5620 i‡(!
ªt
) {

5621 
	`öode_åì_add
(
	`BTRFS_I
(
öode
));

5622 
	`u∆ock_√w_öode
(
öode
);

5624 
	`igë_Áûed
(
öode
);

5630 i‡(
ªt
 > 0)

5631 
ªt
 = -
ENOENT
;

5632 
öode
 = 
	`ERR_PTR
(
ªt
);

5636  
öode
;

5637 
	}
}

5639 
öode
 *
	$båfs_igë
(
su≥r_block
 *
s
, 
u64
 
öo
, 
båfs_roŸ
 *
roŸ
)

5641  
	`båfs_igë_∑th
(
s
, 
öo
, 
roŸ
, 
NULL
);

5642 
	}
}

5644 
öode
 *
	$√w_sim∂e_dú
(
öode
 *
dú
,

5645 
båfs_key
 *
key
,

5646 
båfs_roŸ
 *
roŸ
)

5648 
öode
 *öodê
	`√w_öode
(
dú
->
i_sb
);

5650 i‡(!
öode
)

5651  
	`ERR_PTR
(-
ENOMEM
);

5653 
	`BTRFS_I
(
öode
)->
roŸ
 = 
	`båfs_gøb_roŸ
(root);

5654 
	`mem˝y
(&
	`BTRFS_I
(
öode
)->
loˇti⁄
, 
key
, (*key));

5655 
	`£t_bô
(
BTRFS_INODE_DUMMY
, &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
);

5657 
öode
->
i_öo
 = 
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
;

5662 
öode
->
i_›
 = &
sim∂e_dú_öode_›î©i⁄s
;

5663 
öode
->
i_›Êags
 &~
IOP_XATTR
;

5664 
öode
->
i_f›
 = &
sim∂e_dú_›î©i⁄s
;

5665 
öode
->
i_mode
 = 
S_IFDIR
 | 
S_IRUGO
 | 
S_IWUSR
 | 
S_IXUGO
;

5666 
öode
->
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(inode);

5667 
öode
->
i_©ime
 = 
dú
->i_atime;

5668 
	`BTRFS_I
(
öode
)->
i_Ÿime
 = inode->
i_mtime
;

5669 
öode
->
i_uid
 = 
dú
->i_uid;

5670 
öode
->
i_gid
 = 
dú
->i_gid;

5672  
öode
;

5673 
	}
}

5675 
°©ic_as£π
(
BTRFS_FT_UNKNOWN
 =
FT_UNKNOWN
);

5676 
°©ic_as£π
(
BTRFS_FT_REG_FILE
 =
FT_REG_FILE
);

5677 
°©ic_as£π
(
BTRFS_FT_DIR
 =
FT_DIR
);

5678 
°©ic_as£π
(
BTRFS_FT_CHRDEV
 =
FT_CHRDEV
);

5679 
°©ic_as£π
(
BTRFS_FT_BLKDEV
 =
FT_BLKDEV
);

5680 
°©ic_as£π
(
BTRFS_FT_FIFO
 =
FT_FIFO
);

5681 
°©ic_as£π
(
BTRFS_FT_SOCK
 =
FT_SOCK
);

5682 
°©ic_as£π
(
BTRFS_FT_SYMLINK
 =
FT_SYMLINK
);

5684 
ölöe
 
u8
 
	$båfs_öode_ty≥
(
öode
 *inode)

5686  
	`fs_umode_to_·y≥
(
öode
->
i_mode
);

5687 
	}
}

5689 
öode
 *
	$båfs_lookup_díåy
(
öode
 *
dú
, 
díåy
 *dentry)

5691 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
dú
->
i_sb
);

5692 
öode
 *inode;

5693 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
dú
)->root;

5694 
båfs_roŸ
 *
sub_roŸ
 = 
roŸ
;

5695 
båfs_key
 
loˇti⁄
;

5696 
u8
 
di_ty≥
 = 0;

5697 
ªt
 = 0;

5699 i‡(
díåy
->
d_«me
.
Àn
 > 
BTRFS_NAME_LEN
)

5700  
	`ERR_PTR
(-
ENAMETOOLONG
);

5702 
ªt
 = 
	`båfs_öode_by_«me
(
	`BTRFS_I
(
dú
), 
díåy
, &
loˇti⁄
, &
di_ty≥
);

5703 i‡(
ªt
 < 0)

5704  
	`ERR_PTR
(
ªt
);

5706 i‡(
loˇti⁄
.
ty≥
 =
BTRFS_INODE_ITEM_KEY
) {

5707 
öode
 = 
	`båfs_igë
(
dú
->
i_sb
, 
loˇti⁄
.
obje˘id
, 
roŸ
);

5708 i‡(
	`IS_ERR
(
öode
))

5709  
öode
;

5712 i‡(
	`båfs_öode_ty≥
(
öode
Ë!
di_ty≥
) {

5713 
	`båfs_¸ô
(
fs_öfo
,

5715 
öode
->
i_mode
, 
	`båfs_öode_ty≥
(inode),

5716 
di_ty≥
);

5717 
	`ùut
(
öode
);

5718  
	`ERR_PTR
(-
EUCLEAN
);

5720  
öode
;

5723 
ªt
 = 
	`fixup_åì_roŸ_loˇti⁄
(
fs_öfo
, 
	`BTRFS_I
(
dú
), 
díåy
,

5724 &
loˇti⁄
, &
sub_roŸ
);

5725 i‡(
ªt
 < 0) {

5726 i‡(
ªt
 !-
ENOENT
)

5727 
öode
 = 
	`ERR_PTR
(
ªt
);

5729 
öode
 = 
	`√w_sim∂e_dú
(
dú
, &
loˇti⁄
, 
roŸ
);

5731 
öode
 = 
	`båfs_igë
(
dú
->
i_sb
, 
loˇti⁄
.
obje˘id
, 
sub_roŸ
);

5732 
	`båfs_put_roŸ
(
sub_roŸ
);

5734 i‡(
	`IS_ERR
(
öode
))

5735  
öode
;

5737 
	`down_ªad
(&
fs_öfo
->
˛ónup_w‹k_£m
);

5738 i‡(!
	`sb_rd⁄ly
(
öode
->
i_sb
))

5739 
ªt
 = 
	`båfs_‹ph™_˛ónup
(
sub_roŸ
);

5740 
	`up_ªad
(&
fs_öfo
->
˛ónup_w‹k_£m
);

5741 i‡(
ªt
) {

5742 
	`ùut
(
öode
);

5743 
öode
 = 
	`ERR_PTR
(
ªt
);

5747  
öode
;

5748 
	}
}

5750 
öode
 *
	$båfs_lookup_díåy_mfs
(
öode
 *
dú
, 
díåy
 *dentry)

5753 
öode
 *
ªmŸe_dú
;

5770 
öode
 *
‹ig_dú
 = 
dú
;

5771 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
‹ig_dú
->
i_sb
);

5774 
öode
 *inode;

5775 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
‹ig_dú
)->root;

5776 
båfs_roŸ
 *
sub_roŸ
 = 
roŸ
;

5777 
båfs_key
 
loˇti⁄
;

5778 
u8
 
di_ty≥
 = 0;

5779 
ªt
 = 0;

5781 
öode
 *
mfs_dú
 = 
dú
;

5782 
díåy
 *
mfs_díåy
;

5784 
mfs_díåy
 = 
díåy
;

5817 i‡(
díåy
->
d_«me
.
Àn
 > 
BTRFS_NAME_LEN
)

5818  
	`ERR_PTR
(-
ENAMETOOLONG
);

5820 
ªt
 = 
	`båfs_öode_by_«me
(
	`BTRFS_I
(
‹ig_dú
), 
mfs_díåy
, &
loˇti⁄
, &
di_ty≥
);

5821 i‡(
ªt
 < 0) {

5823  
	`ERR_PTR
(
ªt
);

5825 
	`¥ötk
(
KERN_INFO
 "btrfs_lookup_dentry_mfs: Pass btrfs_inode_by_name\n");

5827 i‡(
loˇti⁄
.
ty≥
 =
BTRFS_INODE_ITEM_KEY
) {

5828 
öode
 = 
	`båfs_igë
(
‹ig_dú
->
i_sb
, 
loˇti⁄
.
obje˘id
, 
roŸ
);

5829 i‡(
	`IS_ERR
(
öode
))

5830  
öode
;

5833 i‡(
	`båfs_öode_ty≥
(
öode
Ë!
di_ty≥
) {

5834 
	`båfs_¸ô
(
fs_öfo
,

5836 
öode
->
i_mode
, 
	`båfs_öode_ty≥
(inode),

5837 
di_ty≥
);

5838 
	`ùut
(
öode
);

5839  
	`ERR_PTR
(-
EUCLEAN
);

5842  
öode
;

5845 
ªt
 = 
	`fixup_åì_roŸ_loˇti⁄
(
fs_öfo
, 
	`BTRFS_I
(
‹ig_dú
), 
mfs_díåy
,

5846 &
loˇti⁄
, &
sub_roŸ
);

5847 i‡(
ªt
 < 0) {

5848 i‡(
ªt
 !-
ENOENT
) {

5850 
öode
 = 
	`ERR_PTR
(
ªt
);

5853 
öode
 = 
	`√w_sim∂e_dú
(
‹ig_dú
, &
loˇti⁄
, 
roŸ
);

5855 
öode
 = 
	`båfs_igë
(
‹ig_dú
->
i_sb
, 
loˇti⁄
.
obje˘id
, 
sub_roŸ
);

5856 
	`båfs_put_roŸ
(
sub_roŸ
);

5858 i‡(
	`IS_ERR
(
öode
))

5859  
öode
;

5861 
	`down_ªad
(&
fs_öfo
->
˛ónup_w‹k_£m
);

5862 i‡(!
	`sb_rd⁄ly
(
öode
->
i_sb
))

5863 
ªt
 = 
	`båfs_‹ph™_˛ónup
(
sub_roŸ
);

5864 
	`up_ªad
(&
fs_öfo
->
˛ónup_w‹k_£m
);

5865 i‡(
ªt
) {

5866 
	`ùut
(
öode
);

5867 
öode
 = 
	`ERR_PTR
(
ªt
);

5871  
öode
;

5872 
	}
}

5874 
	$båfs_díåy_dñëe
(c⁄° 
díåy
 *dentry)

5876 
båfs_roŸ
 *
roŸ
;

5877 
öode
 *öodê
	`d_öode
(
díåy
);

5879 i‡(!
öode
 && !
	`IS_ROOT
(
díåy
))

5880 
öode
 = 
	`d_öode
(
díåy
->
d_∑ª¡
);

5882 i‡(
öode
) {

5883 
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

5884 i‡(
	`båfs_roŸ_ªfs
(&
roŸ
->
roŸ_ôem
) == 0)

5887 i‡(
	`båfs_öo
(
	`BTRFS_I
(
öode
)Ë=
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
)

5891 
	}
}

5894 
båfs_fs_öfo
 *
	$båfs_fs_∂a˚mít_round_robö
(
öode
 *
‹ig_dú
, 
cou¡_ödex
) {

5895 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
‹ig_dú
->
i_sb
);

5896 
loˇl_id
 = 
fs_öfo
->
id
;

5897 
båfs_fs_öfo
 *
assig√d_fs_öfo
;

5899 
º_ödex
 = 
cou¡_ödex
 % 
BTRFS_SUPER_INFO_COUNT
;

5901 
assig√d_fs_öfo
 = 
globÆ_fs_öfo_li°
[
º_ödex
];

5903  
assig√d_fs_öfo
;

5904 
	}
}

5908 
båfs_fs_öfo
 *
	$båfs_fs_∂a˚mít
(
öode
 *
‹ig_dú
) {

5909 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
‹ig_dú
->
i_sb
);

5910 
loˇl_id
 = 
fs_öfo
->
id
;

5911 
båfs_fs_öfo
 *
assig√d_fs_öfo
;

5914 
˝u_id
 = 
	`smp_¥o˚ss‹_id
();

5915 i‡(
˝u_id
 !
loˇl_id
)

5916 
assig√d_fs_öfo
 = 
globÆ_fs_öfo_li°
[
˝u_id
];

5918 
assig√d_fs_öfo
 = 
fs_öfo
;

5923  
assig√d_fs_öfo
;

5924 
	}
}

5927 
öode
 *
	$båfs_m≠_mfsdú
(
båfs_fs_öfo
 *
fs_öfo
) {

5928 
su≥r_block
 *
sb
 = 
fs_öfo
->sb;

5929 
díåy
 *
mfs_roŸ
 = 
sb
->
s_roŸ
;

5930 
öode
 *
mfs_öode
 = 
mfs_roŸ
->
d_öode
;

5932  
mfs_öode
;

5933 
	}
}

5936 
	$båfs_gë_devi˚_id
(
öode
 *
cur_öode
) {

5937 
ªt
;

5938 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
cur_öode
->
i_sb
);

5939 
ªt
 = 
fs_öfo
->
id
;

5941  
ªt
;

5942 
	}
}

5944 
díåy
 *
	$båfs_lookup
(
öode
 *
dú
, 
díåy
 *dentry,

5945 
Êags
)

5947 
	`¥ötk
(
KERN_INFO
 "btrfs_lookup: Called...\n");

5948 
öode
 *öodê
	`båfs_lookup_díåy
(
dú
, 
díåy
);

5950 i‡(
öode
 =
	`ERR_PTR
(-
ENOENT
))

5951 
öode
 = 
NULL
;

5952  
	`d_•li˚_Æüs
(
öode
, 
díåy
);

5953 
	}
}

5956 
díåy
 *
	$båfs_lookup_mfs
(
öode
 *
dú
, 
díåy
 *dentry,

5957 
Êags
)

5959 
	`¥ötk
(
KERN_INFO
 "båfs_lookup_mfs: CÆÀd wôh dú inodê‰om fs_id %dánd díåy from fs_id %d...\n", 
dú
->
fs_id
, 
díåy
->fs_id);

5960 
öode
 *öodê
	`båfs_lookup_díåy_mfs
(
dú
, 
díåy
);

5987 i‡(
öode
 =
	`ERR_PTR
(-
ENOENT
))

5988 
öode
 = 
NULL
;

5989  
	`d_•li˚_Æüs
(
öode
, 
díåy
);

5990 
	}
}

5996 
	$båfs_£t_öode_ödex_cou¡
(
båfs_öode
 *
öode
)

5998 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

5999 
båfs_key
 
key
, 
found_key
;

6000 
båfs_∑th
 *
∑th
;

6001 
exã¡_buf„r
 *
Àaf
;

6002 
ªt
;

6004 
key
.
obje˘id
 = 
	`båfs_öo
(
öode
);

6005 
key
.
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

6006 
key
.
off£t
 = (
u64
)-1;

6008 
∑th
 = 
	`båfs_Æloc_∑th
();

6009 i‡(!
∑th
)

6010  -
ENOMEM
;

6012 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

6013 i‡(
ªt
 < 0)

6014 
out
;

6016 i‡(
ªt
 == 0)

6017 
out
;

6018 
ªt
 = 0;

6020 i‡(
∑th
->
¶Ÿs
[0] == 0) {

6021 
öode
->
ödex_˙t
 = 
BTRFS_DIR_START_INDEX
;

6022 
out
;

6025 
∑th
->
¶Ÿs
[0]--;

6027 
Àaf
 = 
∑th
->
nodes
[0];

6028 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0]);

6030 i‡(
found_key
.
obje˘id
 !
	`båfs_öo
(
öode
) ||

6031 
found_key
.
ty≥
 !
BTRFS_DIR_INDEX_KEY
) {

6032 
öode
->
ödex_˙t
 = 
BTRFS_DIR_START_INDEX
;

6033 
out
;

6036 
öode
->
ödex_˙t
 = 
found_key
.
off£t
 + 1;

6037 
out
:

6038 
	`båfs_‰ì_∑th
(
∑th
);

6039  
ªt
;

6040 
	}
}

6042 
	$båfs_gë_dú_œ°_ödex
(
båfs_öode
 *
dú
, 
u64
 *
ödex
)

6044 
ªt
 = 0;

6046 
	`båfs_öode_lock
(
dú
, 0);

6047 i‡(
dú
->
ödex_˙t
 =(
u64
)-1) {

6048 
ªt
 = 
	`båfs_öode_dñayed_dú_ödex_cou¡
(
dú
);

6049 i‡(
ªt
) {

6050 
ªt
 = 
	`båfs_£t_öode_ödex_cou¡
(
dú
);

6051 i‡(
ªt
) {

6052 
	`¥ötk
(
KERN_INFO
 "btrfs_get_dir_last_index: DoneÖath\n");

6053 
out
;

6059 *
ödex
 = 
dú
->
ödex_˙t
 - 1;

6060 
out
:

6061 
	`båfs_öode_u∆ock
(
dú
, 0);

6063  
ªt
;

6064 
	}
}

6075 
	$båfs_›ídú
(
öode
 *öode, 
fûe
 *file)

6077 
båfs_fûe_¥iv©e
 *
¥iv©e
;

6078 
u64
 
œ°_ödex
;

6079 
ªt
;

6081 
öode
 *
f_öode
 = 
fûe
->f_inode;

6090 
	`¥ötk
(
KERN_INFO
 "btrfs_opendir: calledánd got f_inode from file...\n");

6100 
ªt
 = 
	`båfs_gë_dú_œ°_ödex
(
	`BTRFS_I
(
f_öode
), &
œ°_ödex
);

6101 i‡(
ªt
)

6102  
ªt
;

6104 
¥iv©e
 = 
	`kzÆloc
((
båfs_fûe_¥iv©e
), 
GFP_KERNEL
);

6105 i‡(!
¥iv©e
)

6106  -
ENOMEM
;

6107 
¥iv©e
->
œ°_ödex
 =Üast_index;

6108 
¥iv©e
->
fûldú_buf
 = 
	`kzÆloc
(
PAGE_SIZE
, 
GFP_KERNEL
);

6109 i‡(!
¥iv©e
->
fûldú_buf
) {

6110 
	`k‰ì
(
¥iv©e
);

6111  -
ENOMEM
;

6113 
fûe
->
¥iv©e_d©a
 = 
¥iv©e
;

6115 
	}
}

6117 
	$båfs_›ídú_mfs
(
öode
 *öode, 
fûe
 *file)

6119 
båfs_fûe_¥iv©e
 *
¥iv©e
;

6120 
u64
 
œ°_ödex
;

6121 
ªt
;

6141 
is_loˇl_dú
 = 
öode
->is_local_dir;

6142 
	`¥ötk
(
KERN_INFO
 "båfs_›ídú_mfs: CÆÀd o≥¿thi†öodêwôhÜoˇl_dú = %d\n", 
is_loˇl_dú
);

6144 
ªt
 = 
	`båfs_gë_dú_œ°_ödex
(
	`BTRFS_I
(
öode
), &
œ°_ödex
);

6146 i‡(
ªt
)

6147  
ªt
;

6149 
¥iv©e
 = 
	`kzÆloc
((
båfs_fûe_¥iv©e
), 
GFP_KERNEL
);

6150 i‡(!
¥iv©e
)

6151  -
ENOMEM
;

6152 
¥iv©e
->
œ°_ödex
 =Üast_index;

6153 
¥iv©e
->
fûldú_buf
 = 
	`kzÆloc
(
PAGE_SIZE
, 
GFP_KERNEL
);

6154 i‡(!
¥iv©e
->
fûldú_buf
) {

6155 
	`k‰ì
(
¥iv©e
);

6156  -
ENOMEM
;

6158 
fûe
->
¥iv©e_d©a
 = 
¥iv©e
;

6160 
	}
}

6162 
loff_t
 
	$båfs_dú_Œ£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
whí˚
)

6164 
	`¥ötk
(
KERN_INFO
 "btrfs_dir_llseek: Called...\n");

6165 
båfs_fûe_¥iv©e
 *
¥iv©e
 = 
fûe
->
¥iv©e_d©a
;

6166 
ªt
;

6168 
ªt
 = 
	`båfs_gë_dú_œ°_ödex
(
	`BTRFS_I
(
	`fûe_öode
(
fûe
)),

6169 &
¥iv©e
->
œ°_ödex
);

6170 i‡(
ªt
)

6171  
ªt
;

6173  
	`gíîic_fûe_Œ£ek
(
fûe
, 
off£t
, 
whí˚
);

6174 
	}
}

6176 
	sdú_íåy
 {

6177 
u64
 
	möo
;

6178 
u64
 
	moff£t
;

6179 
	mty≥
;

6180 
	m«me_Àn
;

6183 
	$båfs_fûldú
(*
addr
, 
íåõs
, 
dú_c⁄ãxt
 *
˘x
)

6185 
íåõs
--) {

6186 
dú_íåy
 *
íåy
 = 
addr
;

6187 *
«me
 = (*)(
íåy
 + 1);

6189 
˘x
->
pos
 = 
	`gë_u«lig√d
(&
íåy
->
off£t
);

6190 i‡(!
	`dú_emô
(
˘x
, 
«me
, 
	`gë_u«lig√d
(&
íåy
->
«me_Àn
),

6191 
	`gë_u«lig√d
(&
íåy
->
öo
),

6192 
	`gë_u«lig√d
(&
íåy
->
ty≥
)))

6194 
addr
 +(
dú_íåy
) +

6195 
	`gë_u«lig√d
(&
íåy
->
«me_Àn
);

6196 
˘x
->
pos
++;

6199 
	}
}

6201 
	$båfs_ªÆ_ªaddú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
)

6203 
	`¥ötk
(
KERN_INFO
 "btrfs_real_readdir: Called...\n");

6205 
öode
 *öodê
	`fûe_öode
(
fûe
);

6206 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

6207 
båfs_fûe_¥iv©e
 *
¥iv©e
 = 
fûe
->
¥iv©e_d©a
;

6208 
båfs_dú_ôem
 *
di
;

6209 
båfs_key
 
key
;

6210 
båfs_key
 
found_key
;

6211 
båfs_∑th
 *
∑th
;

6212 *
addr
;

6213 
	`LIST_HEAD
(
ös_li°
);

6214 
	`LIST_HEAD
(
dñ_li°
);

6215 
ªt
;

6216 *
«me_±r
;

6217 
«me_Àn
;

6218 
íåõs
 = 0;

6219 
tŸÆ_Àn
 = 0;

6220 
boﬁ
 
put
 = 
Ál£
;

6221 
båfs_key
 
loˇti⁄
;

6223 i‡(!
	`dú_emô_dŸs
(
fûe
, 
˘x
))

6226 
∑th
 = 
	`båfs_Æloc_∑th
();

6227 i‡(!
∑th
)

6228  -
ENOMEM
;

6230 
addr
 = 
¥iv©e
->
fûldú_buf
;

6231 
∑th
->
ªada
 = 
READA_FORWARD
;

6233 
put
 = 
	`båfs_ªaddú_gë_dñayed_ôems
(
öode
, 
¥iv©e
->
œ°_ödex
,

6234 &
ös_li°
, &
dñ_li°
);

6236 
agaö
:

6237 
key
.
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

6238 
key
.
off£t
 = 
˘x
->
pos
;

6239 
key
.
obje˘id
 = 
	`båfs_öo
(
	`BTRFS_I
(
öode
));

6241 
	`båfs_f‹_óch_¶Ÿ
(
roŸ
, &
key
, &
found_key
, 
∑th
, 
ªt
) {

6242 
dú_íåy
 *
íåy
;

6243 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

6244 
u8
 
·y≥
;

6246 i‡(
found_key
.
obje˘id
 !
key
.objectid)

6248 i‡(
found_key
.
ty≥
 !
BTRFS_DIR_INDEX_KEY
)

6250 i‡(
found_key
.
off£t
 < 
˘x
->
pos
)

6252 i‡(
found_key
.
off£t
 > 
¥iv©e
->
œ°_ödex
)

6254 i‡(
	`båfs_should_dñëe_dú_ödex
(&
dñ_li°
, 
found_key
.
off£t
))

6256 
di
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_dú_ôem
);

6257 
«me_Àn
 = 
	`båfs_dú_«me_Àn
(
Àaf
, 
di
);

6258 i‡((
tŸÆ_Àn
 + (
dú_íåy
Ë+ 
«me_Àn
) >=

6259 
PAGE_SIZE
) {

6260 
	`båfs_ªÀa£_∑th
(
∑th
);

6261 
ªt
 = 
	`båfs_fûldú
(
¥iv©e
->
fûldú_buf
, 
íåõs
, 
˘x
);

6262 i‡(
ªt
)

6263 
n›os
;

6264 
addr
 = 
¥iv©e
->
fûldú_buf
;

6265 
íåõs
 = 0;

6266 
tŸÆ_Àn
 = 0;

6267 
agaö
;

6270 
·y≥
 = 
	`båfs_dú_Êags_to_·y≥
(
	`båfs_dú_Êags
(
Àaf
, 
di
));

6271 
íåy
 = 
addr
;

6272 
«me_±r
 = (*)(
íåy
 + 1);

6273 
	`ªad_exã¡_buf„r
(
Àaf
, 
«me_±r
,

6274 ()(
di
 + 1), 
«me_Àn
);

6275 
	`put_u«lig√d
(
«me_Àn
, &
íåy
->name_len);

6276 
	`put_u«lig√d
(
	`fs_·y≥_to_dty≥
(
·y≥
), &
íåy
->
ty≥
);

6277 
	`båfs_dú_ôem_key_to_˝u
(
Àaf
, 
di
, &
loˇti⁄
);

6278 
	`put_u«lig√d
(
loˇti⁄
.
obje˘id
, &
íåy
->
öo
);

6279 
	`put_u«lig√d
(
found_key
.
off£t
, &
íåy
->offset);

6280 
íåõs
++;

6281 
addr
 +(
dú_íåy
Ë+ 
«me_Àn
;

6282 
tŸÆ_Àn
 +(
dú_íåy
Ë+ 
«me_Àn
;

6285 i‡(
ªt
 < 0)

6286 
îr
;

6288 
	`båfs_ªÀa£_∑th
(
∑th
);

6290 
ªt
 = 
	`båfs_fûldú
(
¥iv©e
->
fûldú_buf
, 
íåõs
, 
˘x
);

6291 i‡(
ªt
)

6292 
n›os
;

6294 
ªt
 = 
	`båfs_ªaddú_dñayed_dú_ödex
(
˘x
, &
ös_li°
);

6295 i‡(
ªt
)

6296 
n›os
;

6315 i‡(
˘x
->
pos
 >
INT_MAX
)

6316 
˘x
->
pos
 = 
LLONG_MAX
;

6318 
˘x
->
pos
 = 
INT_MAX
;

6319 
n›os
:

6320 
ªt
 = 0;

6321 
îr
:

6322 i‡(
put
)

6323 
	`båfs_ªaddú_put_dñayed_ôems
(
öode
, &
ös_li°
, &
dñ_li°
);

6324 
	`båfs_‰ì_∑th
(
∑th
);

6325  
ªt
;

6326 
	}
}

6334 
	$båfs_dúty_öode
(
båfs_öode
 *
öode
)

6336 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

6337 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

6338 
båfs_å™s_h™dÀ
 *
å™s
;

6339 
ªt
;

6341 i‡(
	`ã°_bô
(
BTRFS_INODE_DUMMY
, &
öode
->
ru¡ime_Êags
))

6344 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
roŸ
);

6345 i‡(
	`IS_ERR
(
å™s
))

6346  
	`PTR_ERR
(
å™s
);

6348 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
öode
);

6349 i‡(
ªt
 && (ªà=-
ENOSPC
 ||Ñë =-
EDQUOT
)) {

6351 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

6352 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 1);

6353 i‡(
	`IS_ERR
(
å™s
))

6354  
	`PTR_ERR
(
å™s
);

6356 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
öode
);

6358 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

6359 i‡(
öode
->
dñayed_node
)

6360 
	`båfs_bÆ™˚_dñayed_ôems
(
fs_öfo
);

6362  
ªt
;

6363 
	}
}

6369 
	$båfs_upd©e_time
(
öode
 *öode, 
Êags
)

6371 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

6372 
boﬁ
 
dúty
 = 
Êags
 & ~
S_VERSION
;

6374 i‡(
	`båfs_roŸ_ªad⁄ly
(
roŸ
))

6375  -
EROFS
;

6377 
dúty
 = 
	`öode_upd©e_time°amps
(
öode
, 
Êags
);

6378  
dúty
 ? 
	`båfs_dúty_öode
(
	`BTRFS_I
(
öode
)) : 0;

6379 
	}
}

6385 
	$båfs_£t_öode_ödex
(
båfs_öode
 *
dú
, 
u64
 *
ödex
)

6387 
ªt
 = 0;

6389 i‡(
dú
->
ödex_˙t
 =(
u64
)-1) {

6390 
ªt
 = 
	`båfs_öode_dñayed_dú_ödex_cou¡
(
dú
);

6391 i‡(
ªt
) {

6392 
ªt
 = 
	`båfs_£t_öode_ödex_cou¡
(
dú
);

6393 i‡(
ªt
)

6394  
ªt
;

6398 *
ödex
 = 
dú
->
ödex_˙t
;

6399 
dú
->
ödex_˙t
++;

6401  
ªt
;

6402 
	}
}

6404 
	$båfs_£t_öode_ödex_mfs
(
båfs_öode
 *
dú
, båfs_öodê*
loˇl_dú
, 
u64
 *
ödex
, u64 *
loˇl_ödex
)

6406 
ªt
 = 0;

6409 i‡(
loˇl_dú
->
ödex_˙t
 =(
u64
)-1) {

6410 
ªt
 = 
	`båfs_öode_dñayed_dú_ödex_cou¡
(
loˇl_dú
);

6411 i‡(
ªt
) {

6413 
ªt
 = 
	`båfs_£t_öode_ödex_cou¡
(
dú
);

6414 i‡(
ªt
)

6415  
ªt
;

6419 *
ödex
 = 
dú
->
ödex_˙t
;

6420 *
loˇl_ödex
 = 
loˇl_dú
->
ödex_˙t
;

6421 
loˇl_dú
->
ödex_˙t
++;

6422 
dú
->
ödex_˙t
++;

6424  
ªt
;

6425 
	}
}

6427 
	$båfs_ö£π_öode_locked
(
öode
 *inode)

6429 
båfs_igë_¨gs
 
¨gs
;

6431 
¨gs
.
öo
 = 
	`BTRFS_I
(
öode
)->
loˇti⁄
.
obje˘id
;

6432 
¨gs
.
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

6434  
	`ö£π_öode_locked4
(
öode
,

6435 
	`båfs_öode_hash
(
öode
->
i_öo
, 
	`BTRFS_I
(öode)->
roŸ
),

6436 
båfs_föd_a˘‹
, &
¨gs
);

6437 
	}
}

6439 
	$båfs_√w_öode_¥ï¨e
(
båfs_√w_öode_¨gs
 *
¨gs
,

6440 *
å™s_num_ôems
)

6442 
öode
 *
dú
 = 
¨gs
->dir;

6443 
öode
 *öodê
¨gs
->inode;

6444 
ªt
;

6446 i‡(!
¨gs
->
‹ph™
) {

6447 
ªt
 = 
	`fs¸y±_£tup_fûíame
(
dú
, &
¨gs
->
díåy
->
d_«me
, 0,

6448 &
¨gs
->
‚ame
);

6449 i‡(
ªt
)

6450  
ªt
;

6453 
ªt
 = 
	`posix_a˛_¸óã
(
dú
, &
öode
->
i_mode
, &
¨gs
->
deÁu…_a˛
, &¨gs->
a˛
);

6454 i‡(
ªt
) {

6455 
	`fs¸y±_‰ì_fûíame
(&
¨gs
->
‚ame
);

6456  
ªt
;

6460 *
å™s_num_ôems
 = 1;

6462 i‡(
	`BTRFS_I
(
dú
)->
¥›_com¥ess
)

6463 (*
å™s_num_ôems
)++;

6465 i‡(
¨gs
->
deÁu…_a˛
)

6466 (*
å™s_num_ôems
)++;

6468 i‡(
¨gs
->
a˛
)

6469 (*
å™s_num_ôems
)++;

6470 #ifde‡
CONFIG_SECURITY


6472 i‡(
dú
->
i_£curôy
)

6473 (*
å™s_num_ôems
)++;

6475 i‡(
¨gs
->
‹ph™
) {

6477 (*
å™s_num_ôems
)++;

6488 *
å™s_num_ôems
 += 3;

6491 
	}
}

6493 
	$båfs_√w_öode_¨gs_de°roy
(
båfs_√w_öode_¨gs
 *
¨gs
)

6495 
	`posix_a˛_ªÀa£
(
¨gs
->
a˛
);

6496 
	`posix_a˛_ªÀa£
(
¨gs
->
deÁu…_a˛
);

6497 
	`fs¸y±_‰ì_fûíame
(&
¨gs
->
‚ame
);

6498 
	}
}

6505 
	$båfs_öhîô_iÊags
(
båfs_öode
 *
öode
, båfs_öodê*
dú
)

6507 
Êags
;

6509 
Êags
 = 
dú
->flags;

6511 i‡(
Êags
 & 
BTRFS_INODE_NOCOMPRESS
) {

6512 
öode
->
Êags
 &~
BTRFS_INODE_COMPRESS
;

6513 
öode
->
Êags
 |
BTRFS_INODE_NOCOMPRESS
;

6514 } i‡(
Êags
 & 
BTRFS_INODE_COMPRESS
) {

6515 
öode
->
Êags
 &~
BTRFS_INODE_NOCOMPRESS
;

6516 
öode
->
Êags
 |
BTRFS_INODE_COMPRESS
;

6519 i‡(
Êags
 & 
BTRFS_INODE_NODATACOW
) {

6520 
öode
->
Êags
 |
BTRFS_INODE_NODATACOW
;

6521 i‡(
	`S_ISREG
(
öode
->
vfs_öode
.
i_mode
))

6522 
öode
->
Êags
 |
BTRFS_INODE_NODATASUM
;

6525 
	`båfs_sync_öode_Êags_to_i_Êags
(&
öode
->
vfs_öode
);

6526 
	}
}

6528 
	$båfs_¸óã_√w_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

6529 
båfs_√w_öode_¨gs
 *
¨gs
)

6531 
öode
 *
dú
 = 
¨gs
->dir;

6532 
öode
 *öodê
¨gs
->inode;

6533 c⁄° 
fs¸y±_°r
 *
«me
 = 
¨gs
->
‹ph™
 ? 
NULL
 : &¨gs->
‚ame
.
disk_«me
;

6534 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
dú
->
i_sb
);

6535 
båfs_roŸ
 *
roŸ
;

6536 
båfs_öode_ôem
 *
öode_ôem
;

6537 
båfs_key
 *
loˇti⁄
;

6538 
båfs_∑th
 *
∑th
;

6539 
u64
 
obje˘id
;

6540 
båfs_öode_ªf
 *
ªf
;

6541 
båfs_key
 
key
[2];

6542 
u32
 
sizes
[2];

6543 
båfs_ôem_b©ch
 
b©ch
;

6544 
±r
;

6545 
ªt
;

6548 
∑th
 = 
	`båfs_Æloc_∑th
();

6549 i‡(!
∑th
)

6550  -
ENOMEM
;

6552 i‡(!
¨gs
->
subvﬁ
)

6553 
	`BTRFS_I
(
öode
)->
roŸ
 = 
	`båfs_gøb_roŸ
(BTRFS_I(
dú
)->root);

6554 
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

6556 
ªt
 = 
	`båfs_gë_‰ì_obje˘id
(
roŸ
, &
obje˘id
);

6557 i‡(
ªt
)

6558 
out
;

6559 
öode
->
i_öo
 = 
obje˘id
;

6561 i‡(
¨gs
->
‹ph™
) {

6566 
	`£t_∆ök
(
öode
, 0);

6568 
	`åa˚_båfs_öode_ªque°
(
dú
);

6570 
ªt
 = 
	`båfs_£t_öode_ödex
(
	`BTRFS_I
(
dú
), &BTRFS_I(
öode
)->
dú_ödex
);

6571 i‡(
ªt
)

6572 
out
;

6575 
	`BTRFS_I
(
öode
)->
ödex_˙t
 = 
BTRFS_DIR_START_INDEX
;

6576 
	`BTRFS_I
(
öode
)->
gíî©i⁄
 = 
å™s
->
å™sid
;

6577 
öode
->
i_gíî©i⁄
 = 
	`BTRFS_I
(öode)->
gíî©i⁄
;

6584 i‡(!
¨gs
->
subvﬁ
)

6585 
	`båfs_öhîô_iÊags
(
	`BTRFS_I
(
öode
), BTRFS_I(
dú
));

6587 i‡(
	`S_ISREG
(
öode
->
i_mode
)) {

6588 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
NODATASUM
))

6589 
	`BTRFS_I
(
öode
)->
Êags
 |
BTRFS_INODE_NODATASUM
;

6590 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
NODATACOW
))

6591 
	`BTRFS_I
(
öode
)->
Êags
 |
BTRFS_INODE_NODATACOW
 |

6592 
BTRFS_INODE_NODATASUM
;

6595 
loˇti⁄
 = &
	`BTRFS_I
(
öode
)->location;

6596 
loˇti⁄
->
obje˘id
 = objectid;

6597 
loˇti⁄
->
off£t
 = 0;

6598 
loˇti⁄
->
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

6600 
ªt
 = 
	`båfs_ö£π_öode_locked
(
öode
);

6601 i‡(
ªt
 < 0) {

6602 i‡(!
¨gs
->
‹ph™
)

6603 
	`BTRFS_I
(
dú
)->
ödex_˙t
--;

6604 
out
;

6613 
	`båfs_£t_öode_fuŒ_sync
(
	`BTRFS_I
(
öode
));

6615 
key
[0].
obje˘id
 = objectid;

6616 
key
[0].
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

6617 
key
[0].
off£t
 = 0;

6619 
sizes
[0] = (
båfs_öode_ôem
);

6621 i‡(!
¨gs
->
‹ph™
) {

6628 
key
[1].
obje˘id
 = objectid;

6629 
key
[1].
ty≥
 = 
BTRFS_INODE_REF_KEY
;

6630 i‡(
¨gs
->
subvﬁ
) {

6631 
key
[1].
off£t
 = 
obje˘id
;

6632 
sizes
[1] = 2 + (*
ªf
);

6634 
key
[1].
off£t
 = 
	`båfs_öo
(
	`BTRFS_I
(
dú
));

6635 
sizes
[1] = 
«me
->
Àn
 + (*
ªf
);

6639 
b©ch
.
keys
 = &
key
[0];

6640 
b©ch
.
d©a_sizes
 = &
sizes
[0];

6641 
b©ch
.
tŸÆ_d©a_size
 = 
sizes
[0] + (
¨gs
->
‹ph™
 ? 0 : sizes[1]);

6642 
b©ch
.
ƒ
 = 
¨gs
->
‹ph™
 ? 1 : 2;

6643 
ªt
 = 
	`båfs_ö£π_em±y_ôems
(
å™s
, 
roŸ
, 
∑th
, &
b©ch
);

6644 i‡(
ªt
 != 0) {

6645 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

6646 
disˇrd
;

6649 
öode
->
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(inode);

6650 
öode
->
i_©ime
 = inode->
i_mtime
;

6651 
	`BTRFS_I
(
öode
)->
i_Ÿime
 = inode->
i_mtime
;

6658 
öode_ôem
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

6659 
båfs_öode_ôem
);

6660 
	`memzîo_exã¡_buf„r
(
∑th
->
nodes
[0], ()
öode_ôem
,

6661 (*
öode_ôem
));

6662 
	`fûl_öode_ôem
(
å™s
, 
∑th
->
nodes
[0], 
öode_ôem
, 
öode
);

6664 i‡(!
¨gs
->
‹ph™
) {

6665 
ªf
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0] + 1,

6666 
båfs_öode_ªf
);

6667 
±r
 = ()(
ªf
 + 1);

6668 i‡(
¨gs
->
subvﬁ
) {

6669 
	`båfs_£t_öode_ªf_«me_Àn
(
∑th
->
nodes
[0], 
ªf
, 2);

6670 
	`båfs_£t_öode_ªf_ödex
(
∑th
->
nodes
[0], 
ªf
, 0);

6671 
	`wrôe_exã¡_buf„r
(
∑th
->
nodes
[0], "..", 
±r
, 2);

6673 
	`båfs_£t_öode_ªf_«me_Àn
(
∑th
->
nodes
[0], 
ªf
,

6674 
«me
->
Àn
);

6675 
	`båfs_£t_öode_ªf_ödex
(
∑th
->
nodes
[0], 
ªf
,

6676 
	`BTRFS_I
(
öode
)->
dú_ödex
);

6677 
	`wrôe_exã¡_buf„r
(
∑th
->
nodes
[0], 
«me
->«me, 
±r
,

6678 
«me
->
Àn
);

6682 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑th
->
nodes
[0]);

6688 
	`båfs_‰ì_∑th
(
∑th
);

6689 
∑th
 = 
NULL
;

6691 i‡(
¨gs
->
subvﬁ
) {

6692 
öode
 *
∑ª¡
;

6698 
∑ª¡
 = 
	`båfs_igë
(
fs_öfo
->
sb
, 
BTRFS_FIRST_FREE_OBJECTID
,

6699 
	`BTRFS_I
(
dú
)->
roŸ
);

6700 i‡(
	`IS_ERR
(
∑ª¡
)) {

6701 
ªt
 = 
	`PTR_ERR
(
∑ª¡
);

6703 
ªt
 = 
	`båfs_öode_öhîô_¥›s
(
å™s
, 
öode
, 
∑ª¡
);

6704 
	`ùut
(
∑ª¡
);

6707 
ªt
 = 
	`båfs_öode_öhîô_¥›s
(
å™s
, 
öode
, 
dú
);

6709 i‡(
ªt
) {

6710 
	`båfs_îr
(
fs_öfo
,

6712 
	`båfs_öo
(
	`BTRFS_I
(
öode
)), 
roŸ
->
roŸ_key
.
obje˘id
,

6713 
ªt
);

6720 i‡(!
¨gs
->
subvﬁ
) {

6721 
ªt
 = 
	`båfs_öô_öode_£curôy
(
å™s
, 
¨gs
);

6722 i‡(
ªt
) {

6723 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

6724 
disˇrd
;

6728 
	`öode_åì_add
(
	`BTRFS_I
(
öode
));

6730 
	`åa˚_båfs_öode_√w
(
öode
);

6731 
	`båfs_£t_öode_œ°_å™s
(
å™s
, 
	`BTRFS_I
(
öode
));

6733 
	`båfs_upd©e_roŸ_times
(
å™s
, 
roŸ
);

6735 i‡(
¨gs
->
‹ph™
) {

6736 
ªt
 = 
	`båfs_‹ph™_add
(
å™s
, 
	`BTRFS_I
(
öode
));

6738 
ªt
 = 
	`båfs_add_lök
(
å™s
, 
	`BTRFS_I
(
dú
), BTRFS_I(
öode
), 
«me
,

6739 0, 
	`BTRFS_I
(
öode
)->
dú_ödex
);

6741 i‡(
ªt
) {

6742 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

6743 
disˇrd
;

6748 
disˇrd
:

6753 
	`ihﬁd
(
öode
);

6754 
	`disˇrd_√w_öode
(
öode
);

6755 
out
:

6756 
	`båfs_‰ì_∑th
(
∑th
);

6757  
ªt
;

6758 
	}
}

6760 
	$båfs_¸óã_√w_öode_mfs
(
båfs_å™s_h™dÀ
 *
å™s
,

6761 
båfs_√w_öode_¨gs
 *
¨gs
)

6763 
öode
 *
dú
 = 
¨gs
->dir;

6764 
öode
 *
loˇl_dú
 = 
¨gs
->local_dir;

6765 
öode
 *öodê
¨gs
->inode;

6766 
öode
 *
loˇl_öode
 = 
¨gs
->local_inode;

6768 c⁄° 
fs¸y±_°r
 *
«me
 = 
¨gs
->
‹ph™
 ? 
NULL
 : &¨gs->
‚ame
.
disk_«me
;

6769 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
dú
->
i_sb
);

6770 
båfs_roŸ
 *
roŸ
;

6771 
båfs_öode_ôem
 *
öode_ôem
;

6772 
båfs_key
 *
loˇti⁄
;

6773 
båfs_∑th
 *
∑th
;

6774 
u64
 
obje˘id
;

6775 
båfs_öode_ªf
 *
ªf
;

6776 
båfs_key
 
key
[2];

6777 
u32
 
sizes
[2];

6778 
båfs_ôem_b©ch
 
b©ch
;

6779 
±r
;

6780 
ªt
;

6782 
∑th
 = 
	`båfs_Æloc_∑th
();

6783 i‡(!
∑th
)

6784  -
ENOMEM
;

6786 i‡(!
¨gs
->
subvﬁ
)

6787 
	`BTRFS_I
(
öode
)->
roŸ
 = 
	`båfs_gøb_roŸ
(BTRFS_I(
dú
)->root);

6788 
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

6790 
ªt
 = 
	`båfs_gë_‰ì_obje˘id
(
roŸ
, &
obje˘id
);

6791 i‡(
ªt
)

6792 
out
;

6793 
öode
->
i_öo
 = 
obje˘id
;

6795 i‡(
¨gs
->
‹ph™
) {

6800 
	`£t_∆ök
(
öode
, 0);

6802 
	`åa˚_båfs_öode_ªque°
(
dú
);

6804 
ªt
 = 
	`båfs_£t_öode_ödex_mfs
(
	`BTRFS_I
(
dú
), BTRFS_I(
loˇl_dú
), &BTRFS_I(
öode
)->
dú_ödex
, &BTRFS_I(
loˇl_öode
)->dir_index);

6805 i‡(
ªt
)

6806 
out
;

6809 
	`BTRFS_I
(
öode
)->
ödex_˙t
 = 
BTRFS_DIR_START_INDEX
;

6810 
	`BTRFS_I
(
öode
)->
gíî©i⁄
 = 
å™s
->
å™sid
;

6811 
öode
->
i_gíî©i⁄
 = 
	`BTRFS_I
(öode)->
gíî©i⁄
;

6818 i‡(!
¨gs
->
subvﬁ
)

6819 
	`båfs_öhîô_iÊags
(
	`BTRFS_I
(
öode
), BTRFS_I(
dú
));

6821 i‡(
	`S_ISREG
(
öode
->
i_mode
)) {

6822 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
NODATASUM
))

6823 
	`BTRFS_I
(
öode
)->
Êags
 |
BTRFS_INODE_NODATASUM
;

6824 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
NODATACOW
))

6825 
	`BTRFS_I
(
öode
)->
Êags
 |
BTRFS_INODE_NODATACOW
 |

6826 
BTRFS_INODE_NODATASUM
;

6829 
loˇti⁄
 = &
	`BTRFS_I
(
öode
)->location;

6830 
loˇti⁄
->
obje˘id
 = objectid;

6831 
loˇti⁄
->
off£t
 = 0;

6832 
loˇti⁄
->
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

6834 
ªt
 = 
	`båfs_ö£π_öode_locked
(
öode
);

6835 i‡(
ªt
 < 0) {

6836 i‡(!
¨gs
->
‹ph™
)

6837 
	`BTRFS_I
(
dú
)->
ödex_˙t
--;

6838 
out
;

6847 
	`båfs_£t_öode_fuŒ_sync
(
	`BTRFS_I
(
öode
));

6849 
key
[0].
obje˘id
 = objectid;

6850 
key
[0].
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

6851 
key
[0].
off£t
 = 0;

6853 
sizes
[0] = (
båfs_öode_ôem
);

6855 i‡(!
¨gs
->
‹ph™
) {

6862 
key
[1].
obje˘id
 = objectid;

6863 
key
[1].
ty≥
 = 
BTRFS_INODE_REF_KEY
;

6864 i‡(
¨gs
->
subvﬁ
) {

6865 
key
[1].
off£t
 = 
obje˘id
;

6866 
sizes
[1] = 2 + (*
ªf
);

6868 
key
[1].
off£t
 = 
	`båfs_öo
(
	`BTRFS_I
(
dú
));

6869 
sizes
[1] = 
«me
->
Àn
 + (*
ªf
);

6873 
b©ch
.
keys
 = &
key
[0];

6874 
b©ch
.
d©a_sizes
 = &
sizes
[0];

6875 
b©ch
.
tŸÆ_d©a_size
 = 
sizes
[0] + (
¨gs
->
‹ph™
 ? 0 : sizes[1]);

6876 
b©ch
.
ƒ
 = 
¨gs
->
‹ph™
 ? 1 : 2;

6877 
ªt
 = 
	`båfs_ö£π_em±y_ôems
(
å™s
, 
roŸ
, 
∑th
, &
b©ch
);

6878 i‡(
ªt
 != 0) {

6879 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

6880 
disˇrd
;

6883 
öode
->
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(inode);

6884 
öode
->
i_©ime
 = inode->
i_mtime
;

6885 
	`BTRFS_I
(
öode
)->
i_Ÿime
 = inode->
i_mtime
;

6892 
öode_ôem
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

6893 
båfs_öode_ôem
);

6894 
	`memzîo_exã¡_buf„r
(
∑th
->
nodes
[0], ()
öode_ôem
,

6895 (*
öode_ôem
));

6896 
	`fûl_öode_ôem
(
å™s
, 
∑th
->
nodes
[0], 
öode_ôem
, 
öode
);

6898 i‡(!
¨gs
->
‹ph™
) {

6899 
ªf
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0] + 1,

6900 
båfs_öode_ªf
);

6901 
±r
 = ()(
ªf
 + 1);

6902 i‡(
¨gs
->
subvﬁ
) {

6903 
	`båfs_£t_öode_ªf_«me_Àn
(
∑th
->
nodes
[0], 
ªf
, 2);

6904 
	`båfs_£t_öode_ªf_ödex
(
∑th
->
nodes
[0], 
ªf
, 0);

6905 
	`wrôe_exã¡_buf„r
(
∑th
->
nodes
[0], "..", 
±r
, 2);

6907 
	`båfs_£t_öode_ªf_«me_Àn
(
∑th
->
nodes
[0], 
ªf
,

6908 
«me
->
Àn
);

6909 
	`båfs_£t_öode_ªf_ödex
(
∑th
->
nodes
[0], 
ªf
,

6910 
	`BTRFS_I
(
öode
)->
dú_ödex
);

6911 
	`wrôe_exã¡_buf„r
(
∑th
->
nodes
[0], 
«me
->«me, 
±r
,

6912 
«me
->
Àn
);

6916 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑th
->
nodes
[0]);

6922 
	`båfs_‰ì_∑th
(
∑th
);

6923 
∑th
 = 
NULL
;

6925 i‡(
¨gs
->
subvﬁ
) {

6926 
öode
 *
∑ª¡
;

6932 
∑ª¡
 = 
	`båfs_igë
(
fs_öfo
->
sb
, 
BTRFS_FIRST_FREE_OBJECTID
,

6933 
	`BTRFS_I
(
dú
)->
roŸ
);

6934 i‡(
	`IS_ERR
(
∑ª¡
)) {

6935 
ªt
 = 
	`PTR_ERR
(
∑ª¡
);

6937 
ªt
 = 
	`båfs_öode_öhîô_¥›s
(
å™s
, 
öode
, 
∑ª¡
);

6938 
	`ùut
(
∑ª¡
);

6941 
ªt
 = 
	`båfs_öode_öhîô_¥›s
(
å™s
, 
öode
, 
dú
);

6943 i‡(
ªt
) {

6944 
	`båfs_îr
(
fs_öfo
,

6946 
	`båfs_öo
(
	`BTRFS_I
(
öode
)), 
roŸ
->
roŸ_key
.
obje˘id
,

6947 
ªt
);

6954 i‡(!
¨gs
->
subvﬁ
) {

6955 
ªt
 = 
	`båfs_öô_öode_£curôy
(
å™s
, 
¨gs
);

6956 i‡(
ªt
) {

6957 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

6958 
disˇrd
;

6962 
	`öode_åì_add
(
	`BTRFS_I
(
öode
));

6964 
	`åa˚_båfs_öode_√w
(
öode
);

6965 
	`båfs_£t_öode_œ°_å™s
(
å™s
, 
	`BTRFS_I
(
öode
));

6967 
	`båfs_upd©e_roŸ_times
(
å™s
, 
roŸ
);

6969 i‡(
¨gs
->
‹ph™
) {

6970 
ªt
 = 
	`båfs_‹ph™_add
(
å™s
, 
	`BTRFS_I
(
öode
));

6972 
ªt
 = 
	`båfs_add_lök
(
å™s
, 
	`BTRFS_I
(
dú
), BTRFS_I(
öode
), 
«me
,

6973 0, 
	`BTRFS_I
(
öode
)->
dú_ödex
);

6975 i‡(
ªt
) {

6976 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

6977 
disˇrd
;

6982 
disˇrd
:

6987 
	`ihﬁd
(
öode
);

6988 
	`disˇrd_√w_öode
(
öode
);

6989 
out
:

6990 
	`båfs_‰ì_∑th
(
∑th
);

6991  
ªt
;

6992 
	}
}

7000 
	$båfs_add_lök
(
båfs_å™s_h™dÀ
 *
å™s
,

7001 
båfs_öode
 *
∑ª¡_öode
, båfs_öodê*
öode
,

7002 c⁄° 
fs¸y±_°r
 *
«me
, 
add_backªf
, 
u64
 
ödex
)

7004 
ªt
 = 0;

7005 
båfs_key
 
key
;

7006 
båfs_roŸ
 *
roŸ
 = 
∑ª¡_öode
->root;

7007 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

7008 
u64
 
∑ª¡_öo
 = 
	`båfs_öo
(
∑ª¡_öode
);

7010 i‡(
	`u∆ikñy
(
öo
 =
BTRFS_FIRST_FREE_OBJECTID
)) {

7011 
	`mem˝y
(&
key
, &
öode
->
roŸ
->
roŸ_key
, (key));

7013 
key
.
obje˘id
 = 
öo
;

7014 
key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

7015 
key
.
off£t
 = 0;

7018 i‡(
	`u∆ikñy
(
öo
 =
BTRFS_FIRST_FREE_OBJECTID
)) {

7019 
ªt
 = 
	`båfs_add_roŸ_ªf
(
å™s
, 
key
.
obje˘id
,

7020 
roŸ
->
roŸ_key
.
obje˘id
, 
∑ª¡_öo
,

7021 
ödex
, 
«me
);

7022 } i‡(
add_backªf
) {

7023 
ªt
 = 
	`båfs_ö£π_öode_ªf
(
å™s
, 
roŸ
, 
«me
,

7024 
öo
, 
∑ª¡_öo
, 
ödex
);

7028 i‡(
ªt
)

7029  
ªt
;

7031 
ªt
 = 
	`båfs_ö£π_dú_ôem
(
å™s
, 
«me
, 
∑ª¡_öode
, &
key
,

7032 
	`båfs_öode_ty≥
(&
öode
->
vfs_öode
), 
ödex
);

7033 i‡(
ªt
 =-
EEXIST
 ||Ñë =-
EOVERFLOW
)

7034 
Áû_dú_ôem
;

7035 i‡(
ªt
) {

7036 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

7037  
ªt
;

7040 
	`båfs_i_size_wrôe
(
∑ª¡_öode
,Ö¨ít_öode->
vfs_öode
.
i_size
 +

7041 
«me
->
Àn
 * 2);

7042 
	`öode_öc_ivîsi⁄
(&
∑ª¡_öode
->
vfs_öode
);

7049 i‡(!
	`ã°_bô
(
BTRFS_FS_LOG_RECOVERING
, &
roŸ
->
fs_öfo
->
Êags
))

7050 
∑ª¡_öode
->
vfs_öode
.
i_mtime
 =

7051 
	`öode_£t_˘ime_cuºít
(&
∑ª¡_öode
->
vfs_öode
);

7053 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
∑ª¡_öode
);

7054 i‡(
ªt
)

7055 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

7056  
ªt
;

7058 
Áû_dú_ôem
:

7059 i‡(
	`u∆ikñy
(
öo
 =
BTRFS_FIRST_FREE_OBJECTID
)) {

7060 
u64
 
loˇl_ödex
;

7061 
îr
;

7062 
îr
 = 
	`båfs_dñ_roŸ_ªf
(
å™s
, 
key
.
obje˘id
,

7063 
roŸ
->
roŸ_key
.
obje˘id
, 
∑ª¡_öo
,

7064 &
loˇl_ödex
, 
«me
);

7065 i‡(
îr
)

7066 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
îr
);

7067 } i‡(
add_backªf
) {

7068 
u64
 
loˇl_ödex
;

7069 
îr
;

7071 
îr
 = 
	`båfs_dñ_öode_ªf
(
å™s
, 
roŸ
, 
«me
, 
öo
, 
∑ª¡_öo
,

7072 &
loˇl_ödex
);

7073 i‡(
îr
)

7074 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
îr
);

7078  
ªt
;

7079 
	}
}

7081 
	$båfs_¸óã_comm⁄
(
öode
 *
dú
, 
díåy
 *dentry,

7082 
öode
 *inode)

7084 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
dú
->
i_sb
);

7085 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
dú
)->root;

7086 
båfs_√w_öode_¨gs
 
√w_öode_¨gs
 = {

7087 .
dú
 = dir,

7088 .
díåy
 = dentry,

7089 .
öode
 = inode,

7091 
å™s_num_ôems
;

7092 
båfs_å™s_h™dÀ
 *
å™s
;

7093 
îr
;

7095 
îr
 = 
	`båfs_√w_öode_¥ï¨e
(&
√w_öode_¨gs
, &
å™s_num_ôems
);

7096 i‡(
îr
)

7097 
out_öode
;

7100 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 
å™s_num_ôems
);

7101 i‡(
	`IS_ERR
(
å™s
)) {

7102 
îr
 = 
	`PTR_ERR
(
å™s
);

7103 
out_√w_öode_¨gs
;

7106 
îr
 = 
	`båfs_¸óã_√w_öode
(
å™s
, &
√w_öode_¨gs
);

7107 i‡(!
îr
)

7108 
	`d_ö°™tüã_√w
(
díåy
, 
öode
);

7110 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

7111 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

7112 
out_√w_öode_¨gs
:

7113 
	`båfs_√w_öode_¨gs_de°roy
(&
√w_öode_¨gs
);

7114 
out_öode
:

7115 i‡(
îr
)

7116 
	`ùut
(
öode
);

7117  
îr
;

7118 
	}
}

7121 
	$båfs_¸óã_comm⁄_mfs
(
öode
 *
dú
, öodê*
loˇl_dú
, 
díåy
 *dentry,

7122 
öode
 *öode, öodê*
loˇl_öode
)

7124 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
dú
->
i_sb
);

7125 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
dú
)->root;

7126 
båfs_√w_öode_¨gs
 
√w_öode_¨gs
 = {

7127 .
dú
 = dir,

7128 .
has_loˇl_dú
 = 1,

7129 .
loˇl_dú
 =Üocal_dir,

7130 .
díåy
 = dentry,

7131 .
öode
 = inode,

7132 .
loˇl_öode
 =Üocal_inode,

7134 
å™s_num_ôems
;

7135 
båfs_å™s_h™dÀ
 *
å™s
;

7136 
îr
;

7138 
îr
 = 
	`båfs_√w_öode_¥ï¨e
(&
√w_öode_¨gs
, &
å™s_num_ôems
);

7139 i‡(
îr
)

7140 
out_öode
;

7142 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 
å™s_num_ôems
);

7143 i‡(
	`IS_ERR
(
å™s
)) {

7144 
îr
 = 
	`PTR_ERR
(
å™s
);

7145 
out_√w_öode_¨gs
;

7148 
îr
 = 
	`båfs_¸óã_√w_öode_mfs
(
å™s
, &
√w_öode_¨gs
);

7149 i‡(!
îr
)

7150 
	`d_ö°™tüã_√w
(
díåy
, 
öode
);

7152 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

7153 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

7154 
out_√w_öode_¨gs
:

7155 
	`båfs_√w_öode_¨gs_de°roy
(&
√w_öode_¨gs
);

7156 
out_öode
:

7157 i‡(
îr
)

7158 
	`ùut
(
öode
);

7159  
îr
;

7160 
	}
}

7162 
	$båfs_mknod
(
m¡_idm≠
 *
idm≠
, 
öode
 *
dú
,

7163 
díåy
 *díåy, 
umode_t
 
mode
, 
dev_t
 
rdev
)

7165 
öode
 *inode;

7166 
	`¥ötk
(
KERN_INFO
 "btrfs_mknod: Called...\n");

7168 
öode
 = 
	`√w_öode
(
dú
->
i_sb
);

7169 i‡(!
öode
)

7170  -
ENOMEM
;

7171 
	`öode_öô_ow√r
(
idm≠
, 
öode
, 
dú
, 
mode
);

7172 
öode
->
i_›
 = &
båfs_•ecül_öode_›î©i⁄s
;

7173 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
, 
rdev
);

7174  
	`båfs_¸óã_comm⁄
(
dú
, 
díåy
, 
öode
);

7175 
	}
}

7177 
	$båfs_¸óã
(
m¡_idm≠
 *
idm≠
, 
öode
 *
dú
,

7178 
díåy
 *díåy, 
umode_t
 
mode
, 
boﬁ
 
ex˛
)

7180 
öode
 *inode;

7182 
öode
 = 
	`√w_öode
(
dú
->
i_sb
);

7183 i‡(!
öode
)

7184  -
ENOMEM
;

7185 
	`öode_öô_ow√r
(
idm≠
, 
öode
, 
dú
, 
mode
);

7186 
öode
->
i_f›
 = &
båfs_fûe_›î©i⁄s
;

7187 
öode
->
i_›
 = &
båfs_fûe_öode_›î©i⁄s
;

7188 
öode
->
i_m≠pög
->
a_›s
 = &
båfs_a›s
;

7189  
	`båfs_¸óã_comm⁄
(
dú
, 
díåy
, 
öode
);

7190 
	}
}

7193 
	$båfs_¸óã_mfs
(
m¡_idm≠
 *
idm≠
, 
öode
 *
‹ig_dú
,

7194 
díåy
 *díåy, 
umode_t
 
mode
, 
boﬁ
 
ex˛
)

7196 
öode
 *öode, *
mfs_dú
, *
dú
;

7197 
díåy
 *
ªmŸe_díåy
;

7198 
∑th
 
ªmŸe_∑th
;

7199 
m¡_idm≠
 *
ªmŸe_idm≠
;

7200 
ªt
;

7201 
loˇl_devi˚
, 
ªmŸe_devi˚
;

7207 
q°r
 *
d«me
 = &
díåy
->
d_«me
;

7208 *
«me
 = 
d«me
->name;

7211 i‡(
díåy
->
ªmŸe
 == 1) {

7216 i‡(
díåy
->
assocüãd_díåy
) {

7222 
	`©omic_öc
(&
globÆ_¸óã_cou¡
);

7223 
cou¡_ödex
 = 
	`©omic_ªad
(&
globÆ_¸óã_cou¡
);

7225 
båfs_fs_öfo
 *
assig√d_fs
 = 
	`båfs_fs_∂a˚mít_round_robö
(
‹ig_dú
, 
cou¡_ödex
);

7227 
mfs_dú
 = 
	`båfs_m≠_mfsdú
(
assig√d_fs
);

7228 
loˇl_devi˚
 = 
	`båfs_gë_devi˚_id
(
‹ig_dú
);

7229 
ªmŸe_devi˚
 = 
assig√d_fs
->
id
;

7232 i‡(
ªmŸe_devi˚
 =
loˇl_devi˚
) {

7233 
öode
 = 
	`√w_öode
(
‹ig_dú
->
i_sb
);

7234 i‡(!
öode
)

7235  -
ENOMEM
;

7236 
	`öode_öô_ow√r
(
idm≠
, 
öode
, 
‹ig_dú
, 
mode
);

7237 
öode
->
i_f›
 = &
båfs_fûe_›î©i⁄s
;

7238 
öode
->
i_›
 = &
båfs_fûe_öode_›î©i⁄s
;

7239 
öode
->
i_m≠pög
->
a_›s
 = &
båfs_a›s
;

7240 
ªt
 = 
	`båfs_¸óã_comm⁄
(
‹ig_dú
, 
díåy
, 
öode
);

7241 
öode
->
has_ªmŸe
 = 2;

7245 
ªmŸe_díåy
 = 
	`kîn_∑th_¸óã
(
AT_FDCWD
, 
«me
, &
ªmŸe_∑th
, 0);

7246 i‡(
	`IS_ERR
(
ªmŸe_díåy
))

7247 
ªt
 = 
	`PTR_ERR
(
ªmŸe_díåy
);

7248 
ªmŸe_díåy
->
ªmŸe
 = 1;

7249 
ªmŸe_díåy
->
d_«me
 = 
díåy
->d_name;

7250 
ªmŸe_idm≠
 = 
	`m¡_idm≠
(
ªmŸe_∑th
.
m¡
);

7251 
ªmŸe_díåy
->
ˇŒed_‰om_FS
 = 1;

7252 
öode
 = 
	`√w_öode
(
mfs_dú
->
i_sb
);

7253 i‡(!
öode
)

7254  -
ENOMEM
;

7255 
mfs_dú
->
has_loˇl_dú
 = 1;

7256 
mfs_dú
->
assocüãd_dú_öode
 = 
‹ig_dú
;

7257 
	`öode_öô_ow√r
(
ªmŸe_idm≠
, 
öode
, 
mfs_dú
, 
mode
);

7258 
öode
->
i_f›
 = &
båfs_fûe_›î©i⁄s
;

7259 
öode
->
i_›
 = &
båfs_fûe_öode_›î©i⁄s
;

7260 
öode
->
i_m≠pög
->
a_›s
 = &
båfs_a›s
;

7261 
öode
->
fs_id
 = 
ªmŸe_devi˚
;

7264 
öode
 *
loˇl_öode
 = 
	`√w_öode
(
‹ig_dú
->
i_sb
);

7265 i‡(!
loˇl_öode
)

7266  -
ENOMEM
;

7267 
	`öode_öô_ow√r
(
idm≠
, 
loˇl_öode
, 
‹ig_dú
, 
mode
);

7268 
loˇl_öode
->
i_f›
 = &
båfs_fûe_›î©i⁄s
;

7269 
loˇl_öode
->
i_›
 = &
båfs_fûe_öode_›î©i⁄s
;

7270 
loˇl_öode
->
i_m≠pög
->
a_›s
 = &
båfs_a›s
;

7271 
loˇl_öode
->
assocüãd_fs_id
 = 
ªmŸe_devi˚
;

7272 
ªt
 = 
	`båfs_¸óã_comm⁄
(
‹ig_dú
, 
díåy
, 
loˇl_öode
);

7273 
loˇl_öode
->
has_ªmŸe
 = 1;

7274 
loˇl_öode
->
assocüãd_öode
 = 
öode
;

7275 
öode
->
assocüãd_öode
 = 
loˇl_öode
;

7276 
díåy
->
ªmŸe
 = 0;

7277 
öode
->
has_ªmŸe
 = 0;

7279 
ªt
 = 
	`båfs_¸óã_comm⁄_mfs
(
mfs_dú
, 
‹ig_dú
, 
ªmŸe_díåy
, 
öode
, 
loˇl_öode
);

7283 
	`d⁄e_∑th_¸óã
(&
ªmŸe_∑th
, 
ªmŸe_díåy
);

7284 
öode
->
assocüãd_dú_öode
 = 
‹ig_dú
;

7287 
díåy
->
assocüãd_díåy
 = 
ªmŸe_díåy
;

7288 
díåy
->
assocüãd_∑th
 = &
ªmŸe_∑th
;

7289 
ªmŸe_díåy
->
assocüãd_díåy
 = 
díåy
;

7300  
ªt
;

7301 
	}
}

7305 
	$båfs_lök
(
díåy
 *
ﬁd_díåy
, 
öode
 *
dú
,

7306 
díåy
 *dentry)

7308 
båfs_å™s_h™dÀ
 *
å™s
 = 
NULL
;

7309 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
dú
)->root;

7310 
öode
 *öodê
	`d_öode
(
ﬁd_díåy
);

7311 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

7312 
fs¸y±_«me
 
‚ame
;

7313 
u64
 
ödex
;

7314 
îr
;

7315 
dr›_öode
 = 0;

7317 
	`¥ötk
(
KERN_INFO
 "btrfs_linked: Called...\n");

7319 i‡(
roŸ
->
roŸ_key
.
obje˘id
 !
	`BTRFS_I
(
öode
)->root->root_key.objectid)

7320  -
EXDEV
;

7322 i‡(
öode
->
i_∆ök
 >
BTRFS_LINK_MAX
)

7323  -
EMLINK
;

7325 
îr
 = 
	`fs¸y±_£tup_fûíame
(
dú
, &
díåy
->
d_«me
, 0, &
‚ame
);

7326 i‡(
îr
)

7327 
Áû
;

7329 
îr
 = 
	`båfs_£t_öode_ödex
(
	`BTRFS_I
(
dú
), &
ödex
);

7330 i‡(
îr
)

7331 
Áû
;

7339 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 
öode
->
i_∆ök
 ? 5 : 6);

7340 i‡(
	`IS_ERR
(
å™s
)) {

7341 
îr
 = 
	`PTR_ERR
(
å™s
);

7342 
å™s
 = 
NULL
;

7343 
Áû
;

7347 
	`BTRFS_I
(
öode
)->
dú_ödex
 = 0ULL;

7348 
	`öc_∆ök
(
öode
);

7349 
	`öode_öc_ivîsi⁄
(
öode
);

7350 
	`öode_£t_˘ime_cuºít
(
öode
);

7351 
	`ihﬁd
(
öode
);

7352 
	`£t_bô
(
BTRFS_INODE_COPY_EVERYTHING
, &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
);

7354 
îr
 = 
	`båfs_add_lök
(
å™s
, 
	`BTRFS_I
(
dú
), BTRFS_I(
öode
),

7355 &
‚ame
.
disk_«me
, 1, 
ödex
);

7357 i‡(
îr
) {

7358 
dr›_öode
 = 1;

7360 
díåy
 *
∑ª¡
 = díåy->
d_∑ª¡
;

7362 
îr
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

7363 i‡(
îr
)

7364 
Áû
;

7365 i‡(
öode
->
i_∆ök
 == 1) {

7370 
îr
 = 
	`båfs_‹ph™_dñ
(
å™s
, 
	`BTRFS_I
(
öode
));

7371 i‡(
îr
)

7372 
Áû
;

7374 
	`d_ö°™tüã
(
díåy
, 
öode
);

7375 
	`båfs_log_√w_«me
(
å™s
, 
ﬁd_díåy
, 
NULL
, 0, 
∑ª¡
);

7378 
Áû
:

7379 
	`fs¸y±_‰ì_fûíame
(&
‚ame
);

7380 i‡(
å™s
)

7381 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

7382 i‡(
dr›_öode
) {

7383 
	`öode_dec_lök_cou¡
(
öode
);

7384 
	`ùut
(
öode
);

7386 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

7387  
îr
;

7388 
	}
}

7390 
	$båfs_mkdú
(
m¡_idm≠
 *
idm≠
, 
öode
 *
dú
,

7391 
díåy
 *díåy, 
umode_t
 
mode
)

7393 
öode
 *inode;

7394 
	`¥ötk
(
KERN_INFO
 "btrfs_mkdir: Called...\n");

7396 
öode
 = 
	`√w_öode
(
dú
->
i_sb
);

7397 i‡(!
öode
)

7398  -
ENOMEM
;

7399 
	`öode_öô_ow√r
(
idm≠
, 
öode
, 
dú
, 
S_IFDIR
 | 
mode
);

7400 
öode
->
i_›
 = &
båfs_dú_öode_›î©i⁄s
;

7401 
öode
->
i_f›
 = &
båfs_dú_fûe_›î©i⁄s
;

7402  
	`båfs_¸óã_comm⁄
(
dú
, 
díåy
, 
öode
);

7403 
	}
}

7405 
	$båfs_mkdú_mfs
(
m¡_idm≠
 *
idm≠
, 
öode
 *
dú
,

7406 
díåy
 *díåy, 
umode_t
 
mode
)

7408 
öode
 *inode;

7410 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
dú
->
i_sb
);

7411 
fs_id
 = 
fs_öfo
->
id
;

7412 
	`¥ötk
(
KERN_INFO
 "btrfs_mkdir_mfs did createáÜocal directory...\n ");

7414 
öode
 = 
	`√w_öode
(
dú
->
i_sb
);

7415 i‡(!
öode
)

7416  -
ENOMEM
;

7417 
	`öode_öô_ow√r
(
idm≠
, 
öode
, 
dú
, 
S_IFDIR
 | 
mode
);

7418 
öode
->
i_›
 = &
båfs_dú_öode_›î©i⁄s
;

7419 
öode
->
i_f›
 = &
båfs_dú_fûe_›î©i⁄s
;

7421 
öode
->
is_loˇl_dú
 = 1;

7422 
öode
->
has_ªmŸe
 = 2;

7423 
díåy
->
is_dú
 = 1;

7424  
	`båfs_¸óã_comm⁄
(
dú
, 
díåy
, 
öode
);

7425 
	}
}

7427 
noölöe
 
	$uncom¥ess_ölöe
(
båfs_∑th
 *
∑th
,

7428 
∑ge
 *page,

7429 
båfs_fûe_exã¡_ôem
 *
ôem
)

7431 
ªt
;

7432 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

7433 *
tmp
;

7434 
size_t
 
max_size
;

7435 
ölöe_size
;

7436 
±r
;

7437 
com¥ess_ty≥
;

7439 
com¥ess_ty≥
 = 
	`båfs_fûe_exã¡_com¥essi⁄
(
Àaf
, 
ôem
);

7440 
max_size
 = 
	`båfs_fûe_exã¡_øm_byãs
(
Àaf
, 
ôem
);

7441 
ölöe_size
 = 
	`båfs_fûe_exã¡_ölöe_ôem_Àn
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

7442 
tmp
 = 
	`kmÆloc
(
ölöe_size
, 
GFP_NOFS
);

7443 i‡(!
tmp
)

7444  -
ENOMEM
;

7445 
±r
 = 
	`båfs_fûe_exã¡_ölöe_°¨t
(
ôem
);

7447 
	`ªad_exã¡_buf„r
(
Àaf
, 
tmp
, 
±r
, 
ölöe_size
);

7449 
max_size
 = 
	`mö_t
(, 
PAGE_SIZE
, max_size);

7450 
ªt
 = 
	`båfs_decom¥ess
(
com¥ess_ty≥
, 
tmp
, 
∑ge
, 0, 
ölöe_size
, 
max_size
);

7460 i‡(
max_size
 < 
PAGE_SIZE
)

7461 
	`memzîo_∑ge
(
∑ge
, 
max_size
, 
PAGE_SIZE
 - max_size);

7462 
	`k‰ì
(
tmp
);

7463  
ªt
;

7464 
	}
}

7466 
	$ªad_ölöe_exã¡
(
båfs_öode
 *
öode
, 
båfs_∑th
 *
∑th
,

7467 
∑ge
 *page)

7469 
båfs_fûe_exã¡_ôem
 *
fi
;

7470 *
kaddr
;

7471 
size_t
 
c›y_size
;

7473 i‡(!
∑ge
 || 
	`PageU±od©e
(page))

7476 
	`ASSERT
(
	`∑ge_off£t
(
∑ge
) == 0);

7478 
fi
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

7479 
båfs_fûe_exã¡_ôem
);

7480 i‡(
	`båfs_fûe_exã¡_com¥essi⁄
(
∑th
->
nodes
[0], 
fi
Ë!
BTRFS_COMPRESS_NONE
)

7481  
	`uncom¥ess_ölöe
(
∑th
, 
∑ge
, 
fi
);

7483 
c›y_size
 = 
	`mö_t
(
u64
, 
PAGE_SIZE
,

7484 
	`båfs_fûe_exã¡_øm_byãs
(
∑th
->
nodes
[0], 
fi
));

7485 
kaddr
 = 
	`km≠_loˇl_∑ge
(
∑ge
);

7486 
	`ªad_exã¡_buf„r
(
∑th
->
nodes
[0], 
kaddr
,

7487 
	`båfs_fûe_exã¡_ölöe_°¨t
(
fi
), 
c›y_size
);

7488 
	`kunm≠_loˇl
(
kaddr
);

7489 i‡(
c›y_size
 < 
PAGE_SIZE
)

7490 
	`memzîo_∑ge
(
∑ge
, 
c›y_size
, 
PAGE_SIZE
 - copy_size);

7492 
	}
}

7512 
exã¡_m≠
 *
	$båfs_gë_exã¡
(
båfs_öode
 *
öode
,

7513 
∑ge
 *∑ge, 
size_t
 
pg_off£t
,

7514 
u64
 
°¨t
, u64 
Àn
)

7516 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

7517 
ªt
 = 0;

7518 
u64
 
exã¡_°¨t
 = 0;

7519 
u64
 
exã¡_íd
 = 0;

7520 
u64
 
obje˘id
 = 
	`båfs_öo
(
öode
);

7521 
exã¡_ty≥
 = -1;

7522 
båfs_∑th
 *
∑th
 = 
NULL
;

7523 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

7524 
båfs_fûe_exã¡_ôem
 *
ôem
;

7525 
exã¡_buf„r
 *
Àaf
;

7526 
båfs_key
 
found_key
;

7527 
exã¡_m≠
 *
em
 = 
NULL
;

7528 
exã¡_m≠_åì
 *
em_åì
 = &
öode
->
exã¡_åì
;

7530 
	`ªad_lock
(&
em_åì
->
lock
);

7531 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 
°¨t
, 
Àn
);

7532 
	`ªad_u∆ock
(&
em_åì
->
lock
);

7534 i‡(
em
) {

7535 i‡(
em
->
°¨t
 > sèπ ||Ém->°¨à+Ém->
Àn
 <= start)

7536 
	`‰ì_exã¡_m≠
(
em
);

7537 i‡(
em
->
block_°¨t
 =
EXTENT_MAP_INLINE
 && 
∑ge
)

7538 
	`‰ì_exã¡_m≠
(
em
);

7540 
out
;

7542 
em
 = 
	`Æloc_exã¡_m≠
();

7543 i‡(!
em
) {

7544 
ªt
 = -
ENOMEM
;

7545 
out
;

7547 
em
->
°¨t
 = 
EXTENT_MAP_HOLE
;

7548 
em
->
‹ig_°¨t
 = 
EXTENT_MAP_HOLE
;

7549 
em
->
Àn
 = (
u64
)-1;

7550 
em
->
block_Àn
 = (
u64
)-1;

7552 
∑th
 = 
	`båfs_Æloc_∑th
();

7553 i‡(!
∑th
) {

7554 
ªt
 = -
ENOMEM
;

7555 
out
;

7559 
∑th
->
ªada
 = 
READA_FORWARD
;

7566 i‡(
	`båfs_is_‰ì_•a˚_öode
(
öode
)) {

7567 
∑th
->
£¨ch_commô_roŸ
 = 1;

7568 
∑th
->
skù_lockög
 = 1;

7571 
ªt
 = 
	`båfs_lookup_fûe_exã¡
(
NULL
, 
roŸ
, 
∑th
, 
obje˘id
, 
°¨t
, 0);

7572 i‡(
ªt
 < 0) {

7573 
out
;

7574 } i‡(
ªt
 > 0) {

7575 i‡(
∑th
->
¶Ÿs
[0] == 0)

7576 
nŸ_found
;

7577 
∑th
->
¶Ÿs
[0]--;

7578 
ªt
 = 0;

7581 
Àaf
 = 
∑th
->
nodes
[0];

7582 
ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

7583 
båfs_fûe_exã¡_ôem
);

7584 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0]);

7585 i‡(
found_key
.
obje˘id
 != objectid ||

7586 
found_key
.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
) {

7593 
exã¡_íd
 = 
°¨t
;

7594 
√xt
;

7597 
exã¡_ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
ôem
);

7598 
exã¡_°¨t
 = 
found_key
.
off£t
;

7599 
exã¡_íd
 = 
	`båfs_fûe_exã¡_íd
(
∑th
);

7600 i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_REG
 ||

7601 
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
) {

7603 i‡(!
	`S_ISREG
(
öode
->
vfs_öode
.
i_mode
)) {

7604 
ªt
 = -
EUCLEAN
;

7605 
	`båfs_¸ô
(
fs_öfo
,

7607 
	`båfs_öo
(
öode
));

7608 
out
;

7610 
	`åa˚_båfs_gë_exã¡_show_fi_ªguœr
(
öode
, 
Àaf
, 
ôem
,

7611 
exã¡_°¨t
);

7612 } i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
) {

7613 
	`åa˚_båfs_gë_exã¡_show_fi_ölöe
(
öode
, 
Àaf
, 
ôem
,

7614 
∑th
->
¶Ÿs
[0],

7615 
exã¡_°¨t
);

7617 
√xt
:

7618 i‡(
°¨t
 >
exã¡_íd
) {

7619 
∑th
->
¶Ÿs
[0]++;

7620 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
(
Àaf
)) {

7621 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

7622 i‡(
ªt
 < 0)

7623 
out
;

7624 i‡(
ªt
 > 0)

7625 
nŸ_found
;

7627 
Àaf
 = 
∑th
->
nodes
[0];

7629 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0]);

7630 i‡(
found_key
.
obje˘id
 != objectid ||

7631 
found_key
.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

7632 
nŸ_found
;

7633 i‡(
°¨t
 + 
Àn
 <
found_key
.
off£t
)

7634 
nŸ_found
;

7635 i‡(
°¨t
 > 
found_key
.
off£t
)

7636 
√xt
;

7639 
em
->
°¨t
 = start;

7640 
em
->
‹ig_°¨t
 = 
°¨t
;

7641 
em
->
Àn
 = 
found_key
.
off£t
 - 
°¨t
;

7642 
em
->
block_°¨t
 = 
EXTENT_MAP_HOLE
;

7643 
ö£π
;

7646 
	`båfs_exã¡_ôem_to_exã¡_m≠
(
öode
, 
∑th
, 
ôem
, 
em
);

7648 i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_REG
 ||

7649 
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
) {

7650 
ö£π
;

7651 } i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
) {

7657 
	`ASSERT
(
pg_off£t
 == 0);

7658 
	`ASSERT
(
exã¡_°¨t
 == 0);

7659 
	`ASSERT
(
em
->
°¨t
 == 0);

7667 
	`ASSERT
(
em
->
block_°¨t
 =
EXTENT_MAP_INLINE
);

7668 
	`ASSERT
(
em
->
Àn
 =
fs_öfo
->
£˘‹size
);

7670 
ªt
 = 
	`ªad_ölöe_exã¡
(
öode
, 
∑th
, 
∑ge
);

7671 i‡(
ªt
 < 0)

7672 
out
;

7673 
ö£π
;

7675 
nŸ_found
:

7676 
em
->
°¨t
 = start;

7677 
em
->
‹ig_°¨t
 = 
°¨t
;

7678 
em
->
Àn
 =Üen;

7679 
em
->
block_°¨t
 = 
EXTENT_MAP_HOLE
;

7680 
ö£π
:

7681 
ªt
 = 0;

7682 
	`båfs_ªÀa£_∑th
(
∑th
);

7683 i‡(
em
->
°¨t
 > sèπ || 
	`exã¡_m≠_íd
(em) <= start) {

7684 
	`båfs_îr
(
fs_öfo
,

7686 
em
->
°¨t
,Ém->
Àn
, start,Üen);

7687 
ªt
 = -
EIO
;

7688 
out
;

7691 
	`wrôe_lock
(&
em_åì
->
lock
);

7692 
ªt
 = 
	`båfs_add_exã¡_m≠pög
(
fs_öfo
, 
em_åì
, &
em
, 
°¨t
, 
Àn
);

7693 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

7694 
out
:

7695 
	`båfs_‰ì_∑th
(
∑th
);

7697 
	`åa˚_båfs_gë_exã¡
(
roŸ
, 
öode
, 
em
);

7699 i‡(
ªt
) {

7700 
	`‰ì_exã¡_m≠
(
em
);

7701  
	`ERR_PTR
(
ªt
);

7703  
em
;

7704 
	}
}

7706 
exã¡_m≠
 *
	$båfs_¸óã_dio_exã¡
(
båfs_öode
 *
öode
,

7707 
båfs_dio_d©a
 *
dio_d©a
,

7708 c⁄° 
u64
 
°¨t
,

7709 c⁄° 
u64
 
Àn
,

7710 c⁄° 
u64
 
‹ig_°¨t
,

7711 c⁄° 
u64
 
block_°¨t
,

7712 c⁄° 
u64
 
block_Àn
,

7713 c⁄° 
u64
 
‹ig_block_Àn
,

7714 c⁄° 
u64
 
øm_byãs
,

7715 c⁄° 
ty≥
)

7717 
exã¡_m≠
 *
em
 = 
NULL
;

7718 
båfs_‹dîed_exã¡
 *
‹dîed
;

7720 i‡(
ty≥
 !
BTRFS_ORDERED_NOCOW
) {

7721 
em
 = 
	`¸óã_io_em
(
öode
, 
°¨t
, 
Àn
, 
‹ig_°¨t
, 
block_°¨t
,

7722 
block_Àn
, 
‹ig_block_Àn
, 
øm_byãs
,

7723 
BTRFS_COMPRESS_NONE
,

7724 
ty≥
);

7725 i‡(
	`IS_ERR
(
em
))

7726 
out
;

7728 
‹dîed
 = 
	`båfs_Æloc_‹dîed_exã¡
(
öode
, 
°¨t
, 
Àn
,Üen,

7729 
block_°¨t
, 
block_Àn
, 0,

7730 (1 << 
ty≥
) |

7731 (1 << 
BTRFS_ORDERED_DIRECT
),

7732 
BTRFS_COMPRESS_NONE
);

7733 i‡(
	`IS_ERR
(
‹dîed
)) {

7734 i‡(
em
) {

7735 
	`‰ì_exã¡_m≠
(
em
);

7736 
	`båfs_dr›_exã¡_m≠_ønge
(
öode
, 
°¨t
,

7737 
°¨t
 + 
Àn
 - 1, 
Ál£
);

7739 
em
 = 
	`ERR_CAST
(
‹dîed
);

7741 
	`ASSERT
(!
dio_d©a
->
‹dîed
);

7742 
dio_d©a
->
‹dîed
 = ordered;

7744 
out
:

7746  
em
;

7747 
	}
}

7749 
exã¡_m≠
 *
	$båfs_√w_exã¡_dúe˘
(
båfs_öode
 *
öode
,

7750 
båfs_dio_d©a
 *
dio_d©a
,

7751 
u64
 
°¨t
, u64 
Àn
)

7753 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

7754 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

7755 
exã¡_m≠
 *
em
;

7756 
båfs_key
 
ös
;

7757 
u64
 
Æloc_höt
;

7758 
ªt
;

7760 
Æloc_höt
 = 
	`gë_exã¡_Æloˇti⁄_höt
(
öode
, 
°¨t
, 
Àn
);

7761 
agaö
:

7762 
ªt
 = 
	`båfs_ª£rve_exã¡
(
roŸ
, 
Àn
,Üí, 
fs_öfo
->
£˘‹size
,

7763 0, 
Æloc_höt
, &
ös
, 1, 1);

7764 i‡(
ªt
 =-
EAGAIN
) {

7765 
	`ASSERT
(
	`båfs_is_z⁄ed
(
fs_öfo
));

7766 
	`waô_⁄_bô_io
(&
öode
->
roŸ
->
fs_öfo
->
Êags
, 
BTRFS_FS_NEED_ZONE_FINISH
,

7767 
TASK_UNINTERRUPTIBLE
);

7768 
agaö
;

7770 i‡(
ªt
)

7771  
	`ERR_PTR
(
ªt
);

7773 
em
 = 
	`båfs_¸óã_dio_exã¡
(
öode
, 
dio_d©a
, 
°¨t
, 
ös
.
off£t
, start,

7774 
ös
.
obje˘id
, ins.
off£t
, ins.offset,

7775 
ös
.
off£t
, 
BTRFS_ORDERED_REGULAR
);

7776 
	`båfs_dec_block_group_ª£rv©i⁄s
(
fs_öfo
, 
ös
.
obje˘id
);

7777 i‡(
	`IS_ERR
(
em
))

7778 
	`båfs_‰ì_ª£rved_exã¡
(
fs_öfo
, 
ös
.
obje˘id
, ins.
off£t
,

7781  
em
;

7782 
	}
}

7784 
boﬁ
 
	$båfs_exã¡_ªad⁄ly
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
byãƒ
)

7786 
båfs_block_group
 *
block_group
;

7787 
boﬁ
 
ªad⁄ly
 = 
Ál£
;

7789 
block_group
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
byãƒ
);

7790 i‡(!
block_group
 || block_group->
ro
)

7791 
ªad⁄ly
 = 
åue
;

7792 i‡(
block_group
)

7793 
	`båfs_put_block_group
(
block_group
);

7794  
ªad⁄ly
;

7795 
	}
}

7817 
noölöe
 
	$ˇn_nocow_exã¡
(
öode
 *öode, 
u64
 
off£t
, u64 *
Àn
,

7818 
u64
 *
‹ig_°¨t
, u64 *
‹ig_block_Àn
,

7819 
u64
 *
øm_byãs
, 
boﬁ
 
nowaô
, boﬁ 
°ri˘
)

7821 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

7822 
ˇn_nocow_fûe_exã¡_¨gs
 
nocow_¨gs
 = { 0 };

7823 
båfs_∑th
 *
∑th
;

7824 
ªt
;

7825 
exã¡_buf„r
 *
Àaf
;

7826 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

7827 
exã¡_io_åì
 *
io_åì
 = &
	`BTRFS_I
(
öode
)->io_tree;

7828 
båfs_fûe_exã¡_ôem
 *
fi
;

7829 
båfs_key
 
key
;

7830 
found_ty≥
;

7832 
∑th
 = 
	`båfs_Æloc_∑th
();

7833 i‡(!
∑th
)

7834  -
ENOMEM
;

7835 
∑th
->
nowaô
 =Çowait;

7837 
ªt
 = 
	`båfs_lookup_fûe_exã¡
(
NULL
, 
roŸ
, 
∑th
,

7838 
	`båfs_öo
(
	`BTRFS_I
(
öode
)), 
off£t
, 0);

7839 i‡(
ªt
 < 0)

7840 
out
;

7842 i‡(
ªt
 == 1) {

7843 i‡(
∑th
->
¶Ÿs
[0] == 0) {

7845 
ªt
 = 0;

7846 
out
;

7848 
∑th
->
¶Ÿs
[0]--;

7850 
ªt
 = 0;

7851 
Àaf
 = 
∑th
->
nodes
[0];

7852 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

7853 i‡(
key
.
obje˘id
 !
	`båfs_öo
(
	`BTRFS_I
(
öode
)) ||

7854 
key
.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
) {

7856 
out
;

7859 i‡(
key
.
off£t
 > offset) {

7861 
out
;

7864 i‡(
	`båfs_fûe_exã¡_íd
(
∑th
Ë<
off£t
)

7865 
out
;

7867 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_fûe_exã¡_ôem
);

7868 
found_ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
fi
);

7869 i‡(
øm_byãs
)

7870 *
øm_byãs
 = 
	`båfs_fûe_exã¡_øm_byãs
(
Àaf
, 
fi
);

7872 
nocow_¨gs
.
°¨t
 = 
off£t
;

7873 
nocow_¨gs
.
íd
 = 
off£t
 + *
Àn
 - 1;

7874 
nocow_¨gs
.
°ri˘
 = strict;

7875 
nocow_¨gs
.
‰ì_∑th
 = 
åue
;

7877 
ªt
 = 
	`ˇn_nocow_fûe_exã¡
(
∑th
, &
key
, 
	`BTRFS_I
(
öode
), &
nocow_¨gs
);

7879 
∑th
 = 
NULL
;

7881 i‡(
ªt
 != 1) {

7883 
ªt
 = 0;

7884 
out
;

7887 
ªt
 = 0;

7888 i‡(
	`båfs_exã¡_ªad⁄ly
(
fs_öfo
, 
nocow_¨gs
.
disk_byãƒ
))

7889 
out
;

7891 i‡(!(
	`BTRFS_I
(
öode
)->
Êags
 & 
BTRFS_INODE_NODATACOW
) &&

7892 
found_ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
) {

7893 
u64
 
ønge_íd
;

7895 
ønge_íd
 = 
	`round_up
(
off£t
 + 
nocow_¨gs
.
num_byãs
,

7896 
roŸ
->
fs_öfo
->
£˘‹size
) - 1;

7897 
ªt
 = 
	`ã°_ønge_bô
(
io_åì
, 
off£t
, 
ønge_íd
,

7898 
EXTENT_DELALLOC
, 0, 
NULL
);

7899 i‡(
ªt
) {

7900 
ªt
 = -
EAGAIN
;

7901 
out
;

7905 i‡(
‹ig_°¨t
)

7906 *
‹ig_°¨t
 = 
key
.
off£t
 - 
nocow_¨gs
.
exã¡_off£t
;

7907 i‡(
‹ig_block_Àn
)

7908 *
‹ig_block_Àn
 = 
nocow_¨gs
.
disk_num_byãs
;

7910 *
Àn
 = 
nocow_¨gs
.
num_byãs
;

7911 
ªt
 = 1;

7912 
out
:

7913 
	`båfs_‰ì_∑th
(
∑th
);

7914  
ªt
;

7915 
	}
}

7917 
	$lock_exã¡_dúe˘
(
öode
 *öode, 
u64
 
lock°¨t
, u64 
lockíd
,

7918 
exã¡_°©e
 **
ˇched_°©e
,

7919 
iom≠_Êags
)

7921 c⁄° 
boﬁ
 
wrôög
 = (
iom≠_Êags
 & 
IOMAP_WRITE
);

7922 c⁄° 
boﬁ
 
nowaô
 = (
iom≠_Êags
 & 
IOMAP_NOWAIT
);

7923 
exã¡_io_åì
 *
io_åì
 = &
	`BTRFS_I
(
öode
)->io_tree;

7924 
båfs_‹dîed_exã¡
 *
‹dîed
;

7925 
ªt
 = 0;

7928 i‡(
nowaô
) {

7929 i‡(!
	`åy_lock_exã¡
(
io_åì
, 
lock°¨t
, 
lockíd
,

7930 
ˇched_°©e
))

7931  -
EAGAIN
;

7933 
	`lock_exã¡
(
io_åì
, 
lock°¨t
, 
lockíd
, 
ˇched_°©e
);

7940 
‹dîed
 = 
	`båfs_lookup_‹dîed_ønge
(
	`BTRFS_I
(
öode
), 
lock°¨t
,

7941 
lockíd
 - 
lock°¨t
 + 1);

7950 i‡(!
‹dîed
 &&

7951 (!
wrôög
 || !
	`fûem≠_ønge_has_∑ge
(
öode
->
i_m≠pög
,

7952 
lock°¨t
, 
lockíd
)))

7955 
	`u∆ock_exã¡
(
io_åì
, 
lock°¨t
, 
lockíd
, 
ˇched_°©e
);

7957 i‡(
‹dîed
) {

7958 i‡(
nowaô
) {

7959 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

7960 
ªt
 = -
EAGAIN
;

7978 i‡(
wrôög
 ||

7979 
	`ã°_bô
(
BTRFS_ORDERED_DIRECT
, &
‹dîed
->
Êags
))

7980 
	`båfs_°¨t_‹dîed_exã¡
(
‹dîed
);

7982 
ªt
 = 
nowaô
 ? -
EAGAIN
 : -
ENOTBLK
;

7983 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

7998 
ªt
 = 
nowaô
 ? -
EAGAIN
 : -
ENOTBLK
;

8001 i‡(
ªt
)

8004 
	`c⁄d_ªsched
();

8007  
ªt
;

8008 
	}
}

8011 
exã¡_m≠
 *
	$¸óã_io_em
(
båfs_öode
 *
öode
, 
u64
 
°¨t
,

8012 
u64
 
Àn
, u64 
‹ig_°¨t
, u64 
block_°¨t
,

8013 
u64
 
block_Àn
, u64 
‹ig_block_Àn
,

8014 
u64
 
øm_byãs
, 
com¥ess_ty≥
,

8015 
ty≥
)

8017 
exã¡_m≠
 *
em
;

8018 
ªt
;

8020 
	`ASSERT
(
ty≥
 =
BTRFS_ORDERED_PREALLOC
 ||

8021 
ty≥
 =
BTRFS_ORDERED_COMPRESSED
 ||

8022 
ty≥
 =
BTRFS_ORDERED_NOCOW
 ||

8023 
ty≥
 =
BTRFS_ORDERED_REGULAR
);

8025 
em
 = 
	`Æloc_exã¡_m≠
();

8026 i‡(!
em
)

8027  
	`ERR_PTR
(-
ENOMEM
);

8029 
em
->
°¨t
 = start;

8030 
em
->
‹ig_°¨t
 = orig_start;

8031 
em
->
Àn
 =Üen;

8032 
em
->
block_Àn
 = block_len;

8033 
em
->
block_°¨t
 = block_start;

8034 
em
->
‹ig_block_Àn
 = orig_block_len;

8035 
em
->
øm_byãs
 =Ñam_bytes;

8036 
em
->
gíî©i⁄
 = -1;

8037 
	`£t_bô
(
EXTENT_FLAG_PINNED
, &
em
->
Êags
);

8038 i‡(
ty≥
 =
BTRFS_ORDERED_PREALLOC
) {

8039 
	`£t_bô
(
EXTENT_FLAG_FILLING
, &
em
->
Êags
);

8040 } i‡(
ty≥
 =
BTRFS_ORDERED_COMPRESSED
) {

8041 
	`£t_bô
(
EXTENT_FLAG_COMPRESSED
, &
em
->
Êags
);

8042 
em
->
com¥ess_ty≥
 = compress_type;

8045 
ªt
 = 
	`båfs_ª∂a˚_exã¡_m≠_ønge
(
öode
, 
em
, 
åue
);

8046 i‡(
ªt
) {

8047 
	`‰ì_exã¡_m≠
(
em
);

8048  
	`ERR_PTR
(
ªt
);

8052  
em
;

8053 
	}
}

8056 
	$båfs_gë_blocks_dúe˘_wrôe
(
exã¡_m≠
 **
m≠
,

8057 
öode
 *inode,

8058 
båfs_dio_d©a
 *
dio_d©a
,

8059 
u64
 
°¨t
, u64 *
À≈
,

8060 
iom≠_Êags
)

8062 c⁄° 
boﬁ
 
nowaô
 = (
iom≠_Êags
 & 
IOMAP_NOWAIT
);

8063 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

8064 
exã¡_m≠
 *
em
 = *
m≠
;

8065 
ty≥
;

8066 
u64
 
block_°¨t
, 
‹ig_°¨t
, 
‹ig_block_Àn
, 
øm_byãs
;

8067 
båfs_block_group
 *
bg
;

8068 
boﬁ
 
ˇn_nocow
 = 
Ál£
;

8069 
boﬁ
 
•a˚_ª£rved
 = 
Ál£
;

8070 
u64
 
Àn
 = *
À≈
;

8071 
u64
 
¥ev_Àn
;

8072 
ªt
 = 0;

8083 i‡(
	`ã°_bô
(
EXTENT_FLAG_PREALLOC
, &
em
->
Êags
) ||

8084 ((
	`BTRFS_I
(
öode
)->
Êags
 & 
BTRFS_INODE_NODATACOW
) &&

8085 
em
->
block_°¨t
 !
EXTENT_MAP_HOLE
)) {

8086 i‡(
	`ã°_bô
(
EXTENT_FLAG_PREALLOC
, &
em
->
Êags
))

8087 
ty≥
 = 
BTRFS_ORDERED_PREALLOC
;

8089 
ty≥
 = 
BTRFS_ORDERED_NOCOW
;

8090 
Àn
 = 
	`mö
÷í, 
em
->À¿- (
°¨t
 -Ém->start));

8091 
block_°¨t
 = 
em
->block_°¨à+ (
°¨t
 -Ém->start);

8093 i‡(
	`ˇn_nocow_exã¡
(
öode
, 
°¨t
, &
Àn
, &
‹ig_°¨t
,

8094 &
‹ig_block_Àn
, &
øm_byãs
, 
Ál£
, false) == 1) {

8095 
bg
 = 
	`båfs_öc_nocow_wrôîs
(
fs_öfo
, 
block_°¨t
);

8096 i‡(
bg
)

8097 
ˇn_nocow
 = 
åue
;

8101 
¥ev_Àn
 = 
Àn
;

8102 i‡(
ˇn_nocow
) {

8103 
exã¡_m≠
 *
em2
;

8106 
ªt
 = 
	`båfs_dñÆloc_ª£rve_mëad©a
(
	`BTRFS_I
(
öode
), 
Àn
,Üen,

8107 
nowaô
);

8108 i‡(
ªt
 < 0) {

8110 
	`‰ì_exã¡_m≠
(
em
);

8111 *
m≠
 = 
NULL
;

8112 
	`båfs_dec_nocow_wrôîs
(
bg
);

8113 i‡(
nowaô
 && (
ªt
 =-
ENOSPC
 ||Ñë =-
EDQUOT
))

8114 
ªt
 = -
EAGAIN
;

8115 
out
;

8117 
•a˚_ª£rved
 = 
åue
;

8119 
em2
 = 
	`båfs_¸óã_dio_exã¡
(
	`BTRFS_I
(
öode
), 
dio_d©a
, 
°¨t
, 
Àn
,

8120 
‹ig_°¨t
, 
block_°¨t
,

8121 
Àn
, 
‹ig_block_Àn
,

8122 
øm_byãs
, 
ty≥
);

8123 
	`båfs_dec_nocow_wrôîs
(
bg
);

8124 i‡(
ty≥
 =
BTRFS_ORDERED_PREALLOC
) {

8125 
	`‰ì_exã¡_m≠
(
em
);

8126 *
m≠
 = 
em2
;

8127 
em
 = 
em2
;

8130 i‡(
	`IS_ERR
(
em2
)) {

8131 
ªt
 = 
	`PTR_ERR
(
em2
);

8132 
out
;

8135 
dio_d©a
->
nocow_d⁄e
 = 
åue
;

8138 
	`‰ì_exã¡_m≠
(
em
);

8139 *
m≠
 = 
NULL
;

8141 i‡(
nowaô
) {

8142 
ªt
 = -
EAGAIN
;

8143 
out
;

8150 i‡(!
dio_d©a
->
d©a_•a˚_ª£rved
) {

8151 
ªt
 = -
ENOSPC
;

8152 
out
;

8159 
ªt
 = 
	`båfs_dñÆloc_ª£rve_mëad©a
(
	`BTRFS_I
(
öode
), 
Àn
,Üen,

8160 
Ál£
);

8161 i‡(
ªt
 < 0)

8162 
out
;

8163 
•a˚_ª£rved
 = 
åue
;

8165 
em
 = 
	`båfs_√w_exã¡_dúe˘
(
	`BTRFS_I
(
öode
), 
dio_d©a
, 
°¨t
, 
Àn
);

8166 i‡(
	`IS_ERR
(
em
)) {

8167 
ªt
 = 
	`PTR_ERR
(
em
);

8168 
out
;

8170 *
m≠
 = 
em
;

8171 
Àn
 = 
	`mö
÷í, 
em
->À¿- (
°¨t
 -Ém->start));

8172 i‡(
Àn
 < 
¥ev_Àn
)

8173 
	`båfs_dñÆloc_ªÀa£_mëad©a
(
	`BTRFS_I
(
öode
),

8174 
¥ev_Àn
 - 
Àn
, 
åue
);

8181 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
	`BTRFS_I
(
öode
), 
¥ev_Àn
);

8187 i‡(
°¨t
 + 
Àn
 > 
	`i_size_ªad
(
öode
))

8188 
	`i_size_wrôe
(
öode
, 
°¨t
 + 
Àn
);

8189 
out
:

8190 i‡(
ªt
 && 
•a˚_ª£rved
) {

8191 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
	`BTRFS_I
(
öode
), 
Àn
);

8192 
	`båfs_dñÆloc_ªÀa£_mëad©a
(
	`BTRFS_I
(
öode
), 
Àn
, 
åue
);

8194 *
À≈
 = 
Àn
;

8195  
ªt
;

8196 
	}
}

8198 
	$båfs_dio_iom≠_begö
(
öode
 *öode, 
loff_t
 
°¨t
,

8199 
loff_t
 
Àngth
, 
Êags
, 
iom≠
 *iomap,

8200 
iom≠
 *
§cm≠
)

8202 
iom≠_ôî
 *
ôî
 = 
	`c⁄èöî_of
(
iom≠
, iomap_iter, iomap);

8203 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

8204 
exã¡_m≠
 *
em
;

8205 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

8206 
båfs_dio_d©a
 *
dio_d©a
 = 
ôî
->
¥iv©e
;

8207 
u64
 
lock°¨t
, 
lockíd
;

8208 c⁄° 
boﬁ
 
wrôe
 = !!(
Êags
 & 
IOMAP_WRITE
);

8209 
ªt
 = 0;

8210 
u64
 
Àn
 = 
Àngth
;

8211 c⁄° 
u64
 
d©a_Æloc_Àn
 = 
Àngth
;

8212 
boﬁ
 
u∆ock_exã¡s
 = 
Ál£
;

8225 i‡(!
wrôe
 && (
Êags
 & 
IOMAP_NOWAIT
Ë&& 
Àngth
 > 
PAGE_SIZE
)

8226  -
EAGAIN
;

8232 i‡(!
wrôe
)

8233 
Àn
 = 
	`mö_t
(
u64
,Üí, 
fs_öfo
->
£˘‹size
 * 
BTRFS_MAX_BIO_SECTORS
);

8235 
lock°¨t
 = 
°¨t
;

8236 
lockíd
 = 
°¨t
 + 
Àn
 - 1;

8256 i‡(
	`ã°_bô
(
BTRFS_INODE_HAS_ASYNC_EXTENT
,

8257 &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
)) {

8258 i‡(
Êags
 & 
IOMAP_NOWAIT
) {

8259 i‡(
	`fûem≠_ønge_√eds_wrôeback
(
öode
->
i_m≠pög
,

8260 
lock°¨t
, 
lockíd
))

8261  -
EAGAIN
;

8263 
ªt
 = 
	`fûem≠_fd©awrôe_ønge
(
öode
->
i_m≠pög
, 
°¨t
,

8264 
°¨t
 + 
Àngth
 - 1);

8265 i‡(
ªt
)

8266  
ªt
;

8270 
	`mem£t
(
dio_d©a
, 0, (*dio_data));

8281 i‡(
wrôe
 && !(
Êags
 & 
IOMAP_NOWAIT
)) {

8282 
ªt
 = 
	`båfs_check_d©a_‰ì_•a˚
(
	`BTRFS_I
(
öode
),

8283 &
dio_d©a
->
d©a_ª£rved
,

8284 
°¨t
, 
d©a_Æloc_Àn
, 
Ál£
);

8285 i‡(!
ªt
)

8286 
dio_d©a
->
d©a_•a˚_ª£rved
 = 
åue
;

8287 i‡(
ªt
 && !(
	`BTRFS_I
(
öode
)->
Êags
 &

8288 (
BTRFS_INODE_NODATACOW
 | 
BTRFS_INODE_PREALLOC
)))

8289 
îr
;

8297 
ªt
 = 
	`lock_exã¡_dúe˘
(
öode
, 
lock°¨t
, 
lockíd
, &
ˇched_°©e
, 
Êags
);

8298 i‡(
ªt
 < 0)

8299 
îr
;

8301 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
°¨t
, 
Àn
);

8302 i‡(
	`IS_ERR
(
em
)) {

8303 
ªt
 = 
	`PTR_ERR
(
em
);

8304 
u∆ock_îr
;

8321 i‡(
	`ã°_bô
(
EXTENT_FLAG_COMPRESSED
, &
em
->
Êags
) ||

8322 
em
->
block_°¨t
 =
EXTENT_MAP_INLINE
) {

8323 
	`‰ì_exã¡_m≠
(
em
);

8336 
ªt
 = (
Êags
 & 
IOMAP_NOWAIT
Ë? -
EAGAIN
 : -
ENOTBLK
;

8337 
u∆ock_îr
;

8340 
Àn
 = 
	`mö
÷í, 
em
->À¿- (
°¨t
 -Ém->start));

8363 i‡((
Êags
 & 
IOMAP_NOWAIT
Ë&& 
Àn
 < 
Àngth
) {

8364 
	`‰ì_exã¡_m≠
(
em
);

8365 
ªt
 = -
EAGAIN
;

8366 
u∆ock_îr
;

8369 i‡(
wrôe
) {

8370 
ªt
 = 
	`båfs_gë_blocks_dúe˘_wrôe
(&
em
, 
öode
, 
dio_d©a
,

8371 
°¨t
, &
Àn
, 
Êags
);

8372 i‡(
ªt
 < 0)

8373 
u∆ock_îr
;

8374 
u∆ock_exã¡s
 = 
åue
;

8376 
Àn
 = 
	`mö
÷í, 
em
->À¿- (
°¨t
 -Ém->start));

8377 i‡(
dio_d©a
->
d©a_•a˚_ª£rved
) {

8378 
u64
 
ªÀa£_off£t
;

8379 
u64
 
ªÀa£_Àn
 = 0;

8381 i‡(
dio_d©a
->
nocow_d⁄e
) {

8382 
ªÀa£_off£t
 = 
°¨t
;

8383 
ªÀa£_Àn
 = 
d©a_Æloc_Àn
;

8384 } i‡(
Àn
 < 
d©a_Æloc_Àn
) {

8385 
ªÀa£_off£t
 = 
°¨t
 + 
Àn
;

8386 
ªÀa£_Àn
 = 
d©a_Æloc_Àn
 - 
Àn
;

8389 i‡(
ªÀa£_Àn
 > 0)

8390 
	`båfs_‰ì_ª£rved_d©a_•a˚
(
	`BTRFS_I
(
öode
),

8391 
dio_d©a
->
d©a_ª£rved
,

8392 
ªÀa£_off£t
,

8393 
ªÀa£_Àn
);

8400 
lock°¨t
 = 
°¨t
 + 
Àn
;

8401 i‡(
lock°¨t
 < 
lockíd
)

8402 
u∆ock_exã¡s
 = 
åue
;

8405 i‡(
u∆ock_exã¡s
)

8406 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
lock°¨t
, 
lockíd
,

8407 &
ˇched_°©e
);

8409 
	`‰ì_exã¡_°©e
(
ˇched_°©e
);

8416 i‡((
em
->
block_°¨t
 =
EXTENT_MAP_HOLE
) ||

8417 (
	`ã°_bô
(
EXTENT_FLAG_PREALLOC
, &
em
->
Êags
Ë&& !
wrôe
)) {

8418 
iom≠
->
addr
 = 
IOMAP_NULL_ADDR
;

8419 
iom≠
->
ty≥
 = 
IOMAP_HOLE
;

8421 
iom≠
->
addr
 = 
em
->
block_°¨t
 + (
°¨t
 -Ém->start);

8422 
iom≠
->
ty≥
 = 
IOMAP_MAPPED
;

8424 
iom≠
->
off£t
 = 
°¨t
;

8425 
iom≠
->
bdev
 = 
fs_öfo
->
fs_devi˚s
->
œã°_dev
->bdev;

8426 
iom≠
->
Àngth
 = 
Àn
;

8427 
	`‰ì_exã¡_m≠
(
em
);

8431 
u∆ock_îr
:

8432 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
lock°¨t
, 
lockíd
,

8433 &
ˇched_°©e
);

8434 
îr
:

8435 i‡(
dio_d©a
->
d©a_•a˚_ª£rved
) {

8436 
	`båfs_‰ì_ª£rved_d©a_•a˚
(
	`BTRFS_I
(
öode
),

8437 
dio_d©a
->
d©a_ª£rved
,

8438 
°¨t
, 
d©a_Æloc_Àn
);

8439 
	`exã¡_ch™ge£t_‰ì
(
dio_d©a
->
d©a_ª£rved
);

8442  
ªt
;

8443 
	}
}

8445 
	$båfs_dio_iom≠_íd
(
öode
 *öode, 
loff_t
 
pos
,Üoff_à
Àngth
,

8446 
ssize_t
 
wrôãn
, 
Êags
, 
iom≠
 *iomap)

8448 
iom≠_ôî
 *
ôî
 = 
	`c⁄èöî_of
(
iom≠
, iomap_iter, iomap);

8449 
båfs_dio_d©a
 *
dio_d©a
 = 
ôî
->
¥iv©e
;

8450 
size_t
 
submôãd
 = 
dio_d©a
->submitted;

8451 c⁄° 
boﬁ
 
wrôe
 = !!(
Êags
 & 
IOMAP_WRITE
);

8452 
ªt
 = 0;

8454 i‡(!
wrôe
 && (
iom≠
->
ty≥
 =
IOMAP_HOLE
)) {

8456 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
pos
,Öo†+ 
Àngth
 - 1,

8457 
NULL
);

8461 i‡(
submôãd
 < 
Àngth
) {

8462 
pos
 +
submôãd
;

8463 
Àngth
 -
submôãd
;

8464 i‡(
wrôe
)

8465 
	`båfs_föish_‹dîed_exã¡
(
dio_d©a
->
‹dîed
, 
NULL
,

8466 
pos
, 
Àngth
, 
Ál£
);

8468 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
pos
,

8469 
pos
 + 
Àngth
 - 1, 
NULL
);

8470 
ªt
 = -
ENOTBLK
;

8472 i‡(
wrôe
) {

8473 
	`båfs_put_‹dîed_exã¡
(
dio_d©a
->
‹dîed
);

8474 
dio_d©a
->
‹dîed
 = 
NULL
;

8477 i‡(
wrôe
)

8478 
	`exã¡_ch™ge£t_‰ì
(
dio_d©a
->
d©a_ª£rved
);

8479  
ªt
;

8480 
	}
}

8482 
	$båfs_dio_íd_io
(
båfs_bio
 *
bbio
)

8484 
båfs_dio_¥iv©e
 *
dù
 =

8485 
	`c⁄èöî_of
(
bbio
, 
båfs_dio_¥iv©e
, bbio);

8486 
båfs_öode
 *
öode
 = 
bbio
->inode;

8487 
bio
 *biÿ&
bbio
->bio;

8489 i‡(
bio
->
bi_°©us
) {

8490 
	`båfs_w¨n
(
öode
->
roŸ
->
fs_öfo
,

8492 
	`båfs_öo
(
öode
), 
bio
->
bi_›f
,

8493 
dù
->
fûe_off£t
, dù->
byãs
, 
bio
->
bi_°©us
);

8496 i‡(
	`båfs_›
(
bio
Ë=
BTRFS_MAP_WRITE
) {

8497 
	`båfs_föish_‹dîed_exã¡
(
bbio
->
‹dîed
, 
NULL
,

8498 
dù
->
fûe_off£t
, dù->
byãs
,

8499 !
bio
->
bi_°©us
);

8501 
	`u∆ock_exã¡
(&
öode
->
io_åì
, 
dù
->
fûe_off£t
,

8502 
dù
->
fûe_off£t
 + dù->
byãs
 - 1, 
NULL
);

8505 
bbio
->
bio
.
bi_¥iv©e
 = bbio->
¥iv©e
;

8506 
	`iom≠_dio_bio_íd_io
(
bio
);

8507 
	}
}

8509 
	$båfs_dio_submô_io
(c⁄° 
iom≠_ôî
 *
ôî
, 
bio
 *bio,

8510 
loff_t
 
fûe_off£t
)

8512 
båfs_bio
 *
bbio
 = 
	`båfs_bio
(
bio
);

8513 
båfs_dio_¥iv©e
 *
dù
 =

8514 
	`c⁄èöî_of
(
bbio
, 
båfs_dio_¥iv©e
, bbio);

8515 
båfs_dio_d©a
 *
dio_d©a
 = 
ôî
->
¥iv©e
;

8517 
	`båfs_bio_öô
(
bbio
, 
	`BTRFS_I
(
ôî
->
öode
)->
roŸ
->
fs_öfo
,

8518 
båfs_dio_íd_io
, 
bio
->
bi_¥iv©e
);

8519 
bbio
->
öode
 = 
	`BTRFS_I
(
ôî
->inode);

8520 
bbio
->
fûe_off£t
 = file_offset;

8522 
dù
->
fûe_off£t
 = file_offset;

8523 
dù
->
byãs
 = 
bio
->
bi_ôî
.
bi_size
;

8525 
dio_d©a
->
submôãd
 +
bio
->
bi_ôî
.
bi_size
;

8534 i‡(
ôî
->
Êags
 & 
IOMAP_WRITE
) {

8535 
ªt
;

8537 
ªt
 = 
	`båfs_exåa˘_‹dîed_exã¡
(
bbio
, 
dio_d©a
->
‹dîed
);

8538 i‡(
ªt
) {

8539 
	`båfs_föish_‹dîed_exã¡
(
dio_d©a
->
‹dîed
, 
NULL
,

8540 
fûe_off£t
, 
dù
->
byãs
,

8541 !
ªt
);

8542 
bio
->
bi_°©us
 = 
	`î∫o_to_blk_°©us
(
ªt
);

8543 
	`iom≠_dio_bio_íd_io
(
bio
);

8548 
	`båfs_submô_bio
(
bbio
, 0);

8549 
	}
}

8551 c⁄° 
iom≠_›s
 
	gbåfs_dio_iom≠_›s
 = {

8552 .
iom≠_begö
 = 
båfs_dio_iom≠_begö
,

8553 .
	giom≠_íd
 = 
båfs_dio_iom≠_íd
,

8556 c⁄° 
iom≠_dio_›s
 
	gbåfs_dio_›s
 = {

8557 .
submô_io
 = 
båfs_dio_submô_io
,

8558 .
	gbio_£t
 = &
båfs_dio_bio£t
,

8561 
ssize_t
 
	$båfs_dio_ªad
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
, 
size_t
 
d⁄e_bef‹e
)

8563 
båfs_dio_d©a
 
d©a
 = { 0 };

8565  
	`iom≠_dio_rw
(
iocb
, 
ôî
, &
båfs_dio_iom≠_›s
, &
båfs_dio_›s
,

8566 
IOMAP_DIO_PARTIAL
, &
d©a
, 
d⁄e_bef‹e
);

8567 
	}
}

8569 
iom≠_dio
 *
	$båfs_dio_wrôe
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
,

8570 
size_t
 
d⁄e_bef‹e
)

8572 
båfs_dio_d©a
 
d©a
 = { 0 };

8574  
	`__iom≠_dio_rw
(
iocb
, 
ôî
, &
båfs_dio_iom≠_›s
, &
båfs_dio_›s
,

8575 
IOMAP_DIO_PARTIAL
, &
d©a
, 
d⁄e_bef‹e
);

8576 
	}
}

8578 
	$båfs_fõm≠
(
öode
 *öode, 
fõm≠_exã¡_öfo
 *
fõöfo
,

8579 
u64
 
°¨t
, u64 
Àn
)

8581 
ªt
;

8583 
ªt
 = 
	`fõm≠_¥ï
(
öode
, 
fõöfo
, 
°¨t
, &
Àn
, 0);

8584 i‡(
ªt
)

8585  
ªt
;

8600 i‡(
fõöfo
->
fi_Êags
 & 
FIEMAP_FLAG_SYNC
) {

8601 
ªt
 = 
	`båfs_waô_‹dîed_ønge
(
öode
, 0, 
LLONG_MAX
);

8602 i‡(
ªt
)

8603  
ªt
;

8606  
	`exã¡_fõm≠
(
	`BTRFS_I
(
öode
), 
fõöfo
, 
°¨t
, 
Àn
);

8607 
	}
}

8609 
	$båfs_wrôïages
(
addªss_•a˚
 *
m≠pög
,

8610 
wrôeback_c⁄åﬁ
 *
wbc
)

8612  
	`exã¡_wrôïages
(
m≠pög
, 
wbc
);

8613 
	}
}

8615 
	$båfs_ªadahód
(
ªadahód_c⁄åﬁ
 *
øc
)

8617 
	`¥ötk
(
KERN_INFO
 "btrfs_readahead: StartÅoÑead fromÑead_ahead...\n");

8618 
	`exã¡_ªadahód
(
øc
);

8619 
	}
}

8628 
	$waô_sub∑ge_•ölock
(
∑ge
 *page)

8630 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
∑ge
->
m≠pög
->
ho°
->
i_sb
);

8631 
båfs_sub∑ge
 *
sub∑ge
;

8633 i‡(!
	`båfs_is_sub∑ge
(
fs_öfo
, 
∑ge
))

8636 
	`ASSERT
(
	`PagePriv©e
(
∑ge
Ë&&Öage->
¥iv©e
);

8637 
sub∑ge
 = (
båfs_sub∑ge
 *)
∑ge
->
¥iv©e
;

8650 
	`•ö_lock_úq
(&
sub∑ge
->
lock
);

8651 
	`•ö_u∆ock_úq
(&
sub∑ge
->
lock
);

8652 
	}
}

8654 
boﬁ
 
	$__båfs_ªÀa£_fﬁio
(
fﬁio
 *fﬁio, 
gÂ_t
 
gÂ_Êags
)

8656 
ªt
 = 
	`åy_ªÀa£_exã¡_m≠pög
(&
fﬁio
->
∑ge
, 
gÂ_Êags
);

8658 i‡(
ªt
 == 1) {

8659 
	`waô_sub∑ge_•ölock
(&
fﬁio
->
∑ge
);

8660 
	`˛ór_∑ge_exã¡_m≠≥d
(&
fﬁio
->
∑ge
);

8662  
ªt
;

8663 
	}
}

8665 
boﬁ
 
	$båfs_ªÀa£_fﬁio
(
fﬁio
 *fﬁio, 
gÂ_t
 
gÂ_Êags
)

8667 i‡(
	`fﬁio_ã°_wrôeback
(
fﬁio
Ë|| 
	`fﬁio_ã°_dúty
(folio))

8668  
Ál£
;

8669  
	`__båfs_ªÀa£_fﬁio
(
fﬁio
, 
gÂ_Êags
);

8670 
	}
}

8672 #ifde‡
CONFIG_MIGRATION


8673 
	$båfs_migøã_fﬁio
(
addªss_•a˚
 *
m≠pög
,

8674 
fﬁio
 *
d°
, fﬁiÿ*
§c
,

8675 
migøã_mode
 
mode
)

8677 
ªt
 = 
	`fûem≠_migøã_fﬁio
(
m≠pög
, 
d°
, 
§c
, 
mode
);

8679 i‡(
ªt
 !
MIGRATEPAGE_SUCCESS
)

8680  
ªt
;

8682 i‡(
	`fﬁio_ã°_‹dîed
(
§c
)) {

8683 
	`fﬁio_˛ór_‹dîed
(
§c
);

8684 
	`fﬁio_£t_‹dîed
(
d°
);

8687  
MIGRATEPAGE_SUCCESS
;

8688 
	}
}

8690 
	#båfs_migøã_fﬁio
 
NULL


	)

8693 
	$båfs_övÆid©e_fﬁio
(
fﬁio
 *fﬁio, 
size_t
 
off£t
,

8694 
size_t
 
Àngth
)

8696 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
fﬁio
->
m≠pög
->
ho°
);

8697 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

8698 
exã¡_io_åì
 *
åì
 = &
öode
->
io_åì
;

8699 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

8700 
u64
 
∑ge_°¨t
 = 
	`fﬁio_pos
(
fﬁio
);

8701 
u64
 
∑ge_íd
 = 
∑ge_°¨t
 + 
	`fﬁio_size
(
fﬁio
) - 1;

8702 
u64
 
cur
;

8703 
öode_evi˘ög
 = 
öode
->
vfs_öode
.
i_°©e
 & 
I_FREEING
;

8718 
	`fﬁio_waô_wrôeback
(
fﬁio
);

8719 
	`waô_sub∑ge_•ölock
(&
fﬁio
->
∑ge
);

8733 i‡(!(
off£t
 =0 && 
Àngth
 =
	`fﬁio_size
(
fﬁio
))) {

8734 
	`båfs_ªÀa£_fﬁio
(
fﬁio
, 
GFP_NOFS
);

8738 i‡(!
öode_evi˘ög
)

8739 
	`lock_exã¡
(
åì
, 
∑ge_°¨t
, 
∑ge_íd
, &
ˇched_°©e
);

8741 
cur
 = 
∑ge_°¨t
;

8742 
cur
 < 
∑ge_íd
) {

8743 
båfs_‹dîed_exã¡
 *
‹dîed
;

8744 
u64
 
ønge_íd
;

8745 
u32
 
ønge_Àn
;

8746 
u32
 
exåa_Êags
 = 0;

8748 
‹dîed
 = 
	`båfs_lookup_fú°_‹dîed_ønge
(
öode
, 
cur
,

8749 
∑ge_íd
 + 1 - 
cur
);

8750 i‡(!
‹dîed
) {

8751 
ønge_íd
 = 
∑ge_íd
;

8756 
exåa_Êags
 = 
EXTENT_CLEAR_ALL_BITS
;

8757 
√xt
;

8759 i‡(
‹dîed
->
fûe_off£t
 > 
cur
) {

8766 
ønge_íd
 = 
‹dîed
->
fûe_off£t
 - 1;

8767 
exåa_Êags
 = 
EXTENT_CLEAR_ALL_BITS
;

8768 
√xt
;

8771 
ønge_íd
 = 
	`mö
(
‹dîed
->
fûe_off£t
 + ordîed->
num_byãs
 - 1,

8772 
∑ge_íd
);

8773 
	`ASSERT
(
ønge_íd
 + 1 - 
cur
 < 
U32_MAX
);

8774 
ønge_Àn
 = 
ønge_íd
 + 1 - 
cur
;

8775 i‡(!
	`båfs_∑ge_ã°_‹dîed
(
fs_öfo
, &
fﬁio
->
∑ge
, 
cur
, 
ønge_Àn
)) {

8782 
√xt
;

8784 
	`båfs_∑ge_˛ór_‹dîed
(
fs_öfo
, &
fﬁio
->
∑ge
, 
cur
, 
ønge_Àn
);

8794 i‡(!
öode_evi˘ög
)

8795 
	`˛ór_exã¡_bô
(
åì
, 
cur
, 
ønge_íd
,

8796 
EXTENT_DELALLOC
 |

8797 
EXTENT_LOCKED
 | 
EXTENT_DO_ACCOUNTING
 |

8798 
EXTENT_DEFRAG
, &
ˇched_°©e
);

8800 
	`•ö_lock_úq
(&
öode
->
‹dîed_åì
.
lock
);

8801 
	`£t_bô
(
BTRFS_ORDERED_TRUNCATED
, &
‹dîed
->
Êags
);

8802 
‹dîed
->
åunˇãd_Àn
 = 
	`mö
(ordered->truncated_len,

8803 
cur
 - 
‹dîed
->
fûe_off£t
);

8804 
	`•ö_u∆ock_úq
(&
öode
->
‹dîed_åì
.
lock
);

8812 i‡(
	`båfs_dec_ã°_‹dîed_≥ndög
(
öode
, &
‹dîed
,

8813 
cur
, 
ønge_íd
 + 1 - cur)) {

8814 
	`båfs_föish_‹dîed_io
(
‹dîed
);

8819 
exåa_Êags
 = 
EXTENT_CLEAR_ALL_BITS
;

8821 
√xt
:

8822 i‡(
‹dîed
)

8823 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

8839 
	`båfs_qgroup_‰ì_d©a
(
öode
, 
NULL
, 
cur
, 
ønge_íd
 + 1 - cur, NULL);

8840 i‡(!
öode_evi˘ög
) {

8841 
	`˛ór_exã¡_bô
(
åì
, 
cur
, 
ønge_íd
, 
EXTENT_LOCKED
 |

8842 
EXTENT_DELALLOC
 | 
EXTENT_UPTODATE
 |

8843 
EXTENT_DO_ACCOUNTING
 | 
EXTENT_DEFRAG
 |

8844 
exåa_Êags
, &
ˇched_°©e
);

8846 
cur
 = 
ønge_íd
 + 1;

8853 
	`ASSERT
(!
	`fﬁio_ã°_‹dîed
(
fﬁio
));

8854 
	`båfs_∑ge_˛ór_checked
(
fs_öfo
, &
fﬁio
->
∑ge
, 
	`fﬁio_pos
(fﬁio), 
	`fﬁio_size
(folio));

8855 i‡(!
öode_evi˘ög
)

8856 
	`__båfs_ªÀa£_fﬁio
(
fﬁio
, 
GFP_NOFS
);

8857 
	`˛ór_∑ge_exã¡_m≠≥d
(&
fﬁio
->
∑ge
);

8858 
	}
}

8875 
vm_Áu…_t
 
	$båfs_∑ge_mkwrôe
(
vm_Áu…
 *
vmf
)

8877 
∑ge
 *∑gê
vmf
->page;

8878 
öode
 *öodê
	`fûe_öode
(
vmf
->
vma
->
vm_fûe
);

8879 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

8880 
exã¡_io_åì
 *
io_åì
 = &
	`BTRFS_I
(
öode
)->io_tree;

8881 
båfs_‹dîed_exã¡
 *
‹dîed
;

8882 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

8883 
exã¡_ch™ge£t
 *
d©a_ª£rved
 = 
NULL
;

8884 
zîo_°¨t
;

8885 
loff_t
 
size
;

8886 
vm_Áu…_t
 
ªt
;

8887 
ªt2
;

8888 
ª£rved
 = 0;

8889 
u64
 
ª£rved_•a˚
;

8890 
u64
 
∑ge_°¨t
;

8891 
u64
 
∑ge_íd
;

8892 
u64
 
íd
;

8894 
ª£rved_•a˚
 = 
PAGE_SIZE
;

8896 
	`sb_°¨t_∑geÁu…
(
öode
->
i_sb
);

8897 
∑ge_°¨t
 = 
	`∑ge_off£t
(
∑ge
);

8898 
∑ge_íd
 = 
∑ge_°¨t
 + 
PAGE_SIZE
 - 1;

8899 
íd
 = 
∑ge_íd
;

8909 
ªt2
 = 
	`båfs_dñÆloc_ª£rve_•a˚
(
	`BTRFS_I
(
öode
), &
d©a_ª£rved
,

8910 
∑ge_°¨t
, 
ª£rved_•a˚
);

8911 i‡(!
ªt2
) {

8912 
ªt2
 = 
	`fûe_upd©e_time
(
vmf
->
vma
->
vm_fûe
);

8913 
ª£rved
 = 1;

8915 i‡(
ªt2
) {

8916 
ªt
 = 
	`vmf_îr‹
(
ªt2
);

8917 i‡(
ª£rved
)

8918 
out
;

8919 
out_n‹e£rve
;

8922 
ªt
 = 
VM_FAULT_NOPAGE
;

8923 
agaö
:

8924 
	`down_ªad
(&
	`BTRFS_I
(
öode
)->
i_mm≠_lock
);

8925 
	`lock_∑ge
(
∑ge
);

8926 
size
 = 
	`i_size_ªad
(
öode
);

8928 i‡((
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
) ||

8929 (
∑ge_°¨t
 >
size
)) {

8931 
out_u∆ock
;

8933 
	`waô_⁄_∑ge_wrôeback
(
∑ge
);

8935 
	`lock_exã¡
(
io_åì
, 
∑ge_°¨t
, 
∑ge_íd
, &
ˇched_°©e
);

8936 
ªt2
 = 
	`£t_∑ge_exã¡_m≠≥d
(
∑ge
);

8937 i‡(
ªt2
 < 0) {

8938 
ªt
 = 
	`vmf_îr‹
(
ªt2
);

8939 
	`u∆ock_exã¡
(
io_åì
, 
∑ge_°¨t
, 
∑ge_íd
, &
ˇched_°©e
);

8940 
out_u∆ock
;

8947 
‹dîed
 = 
	`båfs_lookup_‹dîed_ønge
(
	`BTRFS_I
(
öode
), 
∑ge_°¨t
,

8948 
PAGE_SIZE
);

8949 i‡(
‹dîed
) {

8950 
	`u∆ock_exã¡
(
io_åì
, 
∑ge_°¨t
, 
∑ge_íd
, &
ˇched_°©e
);

8951 
	`u∆ock_∑ge
(
∑ge
);

8952 
	`up_ªad
(&
	`BTRFS_I
(
öode
)->
i_mm≠_lock
);

8953 
	`båfs_°¨t_‹dîed_exã¡
(
‹dîed
);

8954 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

8955 
agaö
;

8958 i‡(
∑ge
->
ödex
 =((
size
 - 1Ë>> 
PAGE_SHIFT
)) {

8959 
ª£rved_•a˚
 = 
	`round_up
(
size
 - 
∑ge_°¨t
,

8960 
fs_öfo
->
£˘‹size
);

8961 i‡(
ª£rved_•a˚
 < 
PAGE_SIZE
) {

8962 
íd
 = 
∑ge_°¨t
 + 
ª£rved_•a˚
 - 1;

8963 
	`båfs_dñÆloc_ªÀa£_•a˚
(
	`BTRFS_I
(
öode
),

8964 
d©a_ª£rved
, 
∑ge_°¨t
,

8965 
PAGE_SIZE
 - 
ª£rved_•a˚
, 
åue
);

8976 
	`˛ór_exã¡_bô
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
∑ge_°¨t
, 
íd
,

8977 
EXTENT_DELALLOC
 | 
EXTENT_DO_ACCOUNTING
 |

8978 
EXTENT_DEFRAG
, &
ˇched_°©e
);

8980 
ªt2
 = 
	`båfs_£t_exã¡_dñÆloc
(
	`BTRFS_I
(
öode
), 
∑ge_°¨t
, 
íd
, 0,

8981 &
ˇched_°©e
);

8982 i‡(
ªt2
) {

8983 
	`u∆ock_exã¡
(
io_åì
, 
∑ge_°¨t
, 
∑ge_íd
, &
ˇched_°©e
);

8984 
ªt
 = 
VM_FAULT_SIGBUS
;

8985 
out_u∆ock
;

8989 i‡(
∑ge_°¨t
 + 
PAGE_SIZE
 > 
size
)

8990 
zîo_°¨t
 = 
	`off£t_ö_∑ge
(
size
);

8992 
zîo_°¨t
 = 
PAGE_SIZE
;

8994 i‡(
zîo_°¨t
 !
PAGE_SIZE
)

8995 
	`memzîo_∑ge
(
∑ge
, 
zîo_°¨t
, 
PAGE_SIZE
 - zero_start);

8997 
	`båfs_∑ge_˛ór_checked
(
fs_öfo
, 
∑ge
, 
∑ge_°¨t
, 
PAGE_SIZE
);

8998 
	`båfs_∑ge_£t_dúty
(
fs_öfo
, 
∑ge
, 
∑ge_°¨t
, 
íd
 + 1 -Öage_start);

8999 
	`båfs_∑ge_£t_u±od©e
(
fs_öfo
, 
∑ge
, 
∑ge_°¨t
, 
íd
 + 1 -Öage_start);

9001 
	`båfs_£t_öode_œ°_sub_å™s
(
	`BTRFS_I
(
öode
));

9003 
	`u∆ock_exã¡
(
io_åì
, 
∑ge_°¨t
, 
∑ge_íd
, &
ˇched_°©e
);

9004 
	`up_ªad
(&
	`BTRFS_I
(
öode
)->
i_mm≠_lock
);

9006 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
	`BTRFS_I
(
öode
), 
PAGE_SIZE
);

9007 
	`sb_íd_∑geÁu…
(
öode
->
i_sb
);

9008 
	`exã¡_ch™ge£t_‰ì
(
d©a_ª£rved
);

9009  
VM_FAULT_LOCKED
;

9011 
out_u∆ock
:

9012 
	`u∆ock_∑ge
(
∑ge
);

9013 
	`up_ªad
(&
	`BTRFS_I
(
öode
)->
i_mm≠_lock
);

9014 
out
:

9015 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
	`BTRFS_I
(
öode
), 
PAGE_SIZE
);

9016 
	`båfs_dñÆloc_ªÀa£_•a˚
(
	`BTRFS_I
(
öode
), 
d©a_ª£rved
, 
∑ge_°¨t
,

9017 
ª£rved_•a˚
, (
ªt
 != 0));

9018 
out_n‹e£rve
:

9019 
	`sb_íd_∑geÁu…
(
öode
->
i_sb
);

9020 
	`exã¡_ch™ge£t_‰ì
(
d©a_ª£rved
);

9021  
ªt
;

9022 
	}
}

9024 
	$båfs_åunˇã
(
båfs_öode
 *
öode
, 
boﬁ
 
skù_wrôeback
)

9026 
båfs_åunˇã_c⁄åﬁ
 
c⁄åﬁ
 = {

9027 .
öode
 = inode,

9028 .
öo
 = 
	`båfs_öo
(
öode
),

9029 .
mö_ty≥
 = 
BTRFS_EXTENT_DATA_KEY
,

9030 .
˛ór_exã¡_ønge
 = 
åue
,

9032 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

9033 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

9034 
båfs_block_rsv
 *
rsv
;

9035 
ªt
;

9036 
båfs_å™s_h™dÀ
 *
å™s
;

9037 
u64
 
mask
 = 
fs_öfo
->
£˘‹size
 - 1;

9038 c⁄° 
u64
 
mö_size
 = 
	`båfs_ˇlc_mëad©a_size
(
fs_öfo
, 1);

9040 i‡(!
skù_wrôeback
) {

9041 
ªt
 = 
	`båfs_waô_‹dîed_ønge
(&
öode
->
vfs_öode
,

9042 
öode
->
vfs_öode
.
i_size
 & (~
mask
),

9043 (
u64
)-1);

9044 i‡(
ªt
)

9045  
ªt
;

9076 
rsv
 = 
	`båfs_Æloc_block_rsv
(
fs_öfo
, 
BTRFS_BLOCK_RSV_TEMP
);

9077 i‡(!
rsv
)

9078  -
ENOMEM
;

9079 
rsv
->
size
 = 
mö_size
;

9080 
rsv
->
ÁûÁ°
 = 
åue
;

9086 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 2);

9087 i‡(
	`IS_ERR
(
å™s
)) {

9088 
ªt
 = 
	`PTR_ERR
(
å™s
);

9089 
out
;

9093 
ªt
 = 
	`båfs_block_rsv_migøã
(&
fs_öfo
->
å™s_block_rsv
, 
rsv
,

9094 
mö_size
, 
Ál£
);

9100 i‡(
	`WARN_ON
(
ªt
)) {

9101 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

9102 
out
;

9105 
å™s
->
block_rsv
 = 
rsv
;

9108 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

9109 c⁄° 
u64
 
√w_size
 = 
öode
->
vfs_öode
.
i_size
;

9110 c⁄° 
u64
 
lock_°¨t
 = 
	`ALIGN_DOWN
(
√w_size
, 
fs_öfo
->
£˘‹size
);

9112 
c⁄åﬁ
.
√w_size
 =Çew_size;

9113 
	`lock_exã¡
(&
öode
->
io_åì
, 
lock_°¨t
, (
u64
)-1, &
ˇched_°©e
);

9119 
	`båfs_dr›_exã¡_m≠_ønge
(
öode
,

9120 
	`ALIGN
(
√w_size
, 
fs_öfo
->
£˘‹size
),

9121 (
u64
)-1, 
Ál£
);

9123 
ªt
 = 
	`båfs_åunˇã_öode_ôems
(
å™s
, 
roŸ
, &
c⁄åﬁ
);

9125 
	`öode_sub_byãs
(&
öode
->
vfs_öode
, 
c⁄åﬁ
.
sub_byãs
);

9126 
	`båfs_öode_ß„_disk_i_size_wrôe
(
öode
, 
c⁄åﬁ
.
œ°_size
);

9128 
	`u∆ock_exã¡
(&
öode
->
io_åì
, 
lock_°¨t
, (
u64
)-1, &
ˇched_°©e
);

9130 
å™s
->
block_rsv
 = &
fs_öfo
->
å™s_block_rsv
;

9131 i‡(
ªt
 !-
ENOSPC
 &&Ñë !-
EAGAIN
)

9134 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
öode
);

9135 i‡(
ªt
)

9138 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

9139 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

9141 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 2);

9142 i‡(
	`IS_ERR
(
å™s
)) {

9143 
ªt
 = 
	`PTR_ERR
(
å™s
);

9144 
å™s
 = 
NULL
;

9148 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, 
rsv
, -1, 
NULL
);

9149 
ªt
 = 
	`båfs_block_rsv_migøã
(&
fs_öfo
->
å™s_block_rsv
,

9150 
rsv
, 
mö_size
, 
Ál£
);

9156 i‡(
	`WARN_ON
(
ªt
))

9159 
å™s
->
block_rsv
 = 
rsv
;

9168 i‡(
ªt
 =
BTRFS_NEED_TRUNCATE_BLOCK
) {

9169 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

9170 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

9172 
ªt
 = 
	`båfs_åunˇã_block
(
öode
, inode->
vfs_öode
.
i_size
, 0, 0);

9173 i‡(
ªt
)

9174 
out
;

9175 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 1);

9176 i‡(
	`IS_ERR
(
å™s
)) {

9177 
ªt
 = 
	`PTR_ERR
(
å™s
);

9178 
out
;

9180 
	`båfs_öode_ß„_disk_i_size_wrôe
(
öode
, 0);

9183 i‡(
å™s
) {

9184 
ªt2
;

9186 
å™s
->
block_rsv
 = &
fs_öfo
->
å™s_block_rsv
;

9187 
ªt2
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
öode
);

9188 i‡(
ªt2
 && !
ªt
)

9189 
ªt
 = 
ªt2
;

9191 
ªt2
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

9192 i‡(
ªt2
 && !
ªt
)

9193 
ªt
 = 
ªt2
;

9194 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

9196 
out
:

9197 
	`båfs_‰ì_block_rsv
(
fs_öfo
, 
rsv
);

9212 i‡(
c⁄åﬁ
.
exã¡s_found
 > 0)

9213 
	`båfs_£t_öode_fuŒ_sync
(
öode
);

9215  
ªt
;

9216 
	}
}

9218 
öode
 *
	$båfs_√w_subvﬁ_öode
(
m¡_idm≠
 *
idm≠
,

9219 
öode
 *
dú
)

9221 
öode
 *inode;

9223 
öode
 = 
	`√w_öode
(
dú
->
i_sb
);

9224 i‡(
öode
) {

9229 
	`öode_öô_ow√r
(
idm≠
, 
öode
, 
NULL
,

9230 
S_IFDIR
 | (~
	`cuºít_umask
(Ë& 
S_IRWXUGO
));

9231 
öode
->
i_›
 = &
båfs_dú_öode_›î©i⁄s
;

9232 
öode
->
i_f›
 = &
båfs_dú_fûe_›î©i⁄s
;

9234  
öode
;

9235 
	}
}

9237 
öode
 *
	$båfs_Æloc_öode
(
su≥r_block
 *
sb
)

9239 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
sb
);

9240 
båfs_öode
 *
ei
;

9241 
öode
 *inode;

9243 
ei
 = 
	`Æloc_öode_sb
(
sb
, 
båfs_öode_ˇchï
, 
GFP_KERNEL
);

9244 i‡(!
ei
)

9245  
NULL
;

9247 
ei
->
roŸ
 = 
NULL
;

9248 
ei
->
gíî©i⁄
 = 0;

9249 
ei
->
œ°_å™s
 = 0;

9250 
ei
->
œ°_sub_å™s
 = 0;

9251 
ei
->
logged_å™s
 = 0;

9252 
ei
->
dñÆloc_byãs
 = 0;

9253 
ei
->
√w_dñÆloc_byãs
 = 0;

9254 
ei
->
de‰ag_byãs
 = 0;

9255 
ei
->
disk_i_size
 = 0;

9256 
ei
->
Êags
 = 0;

9257 
ei
->
ro_Êags
 = 0;

9258 
ei
->
csum_byãs
 = 0;

9259 
ei
->
ödex_˙t
 = (
u64
)-1;

9260 
ei
->
dú_ödex
 = 0;

9261 
ei
->
œ°_u∆ök_å™s
 = 0;

9262 
ei
->
œ°_ªÊök_å™s
 = 0;

9263 
ei
->
œ°_log_commô
 = 0;

9265 
	`•ö_lock_öô
(&
ei
->
lock
);

9266 
ei
->
out°™dög_exã¡s
 = 0;

9267 i‡(
sb
->
s_magic
 !
BTRFS_TEST_MAGIC
)

9268 
	`båfs_öô_mëad©a_block_rsv
(
fs_öfo
, &
ei
->
block_rsv
,

9269 
BTRFS_BLOCK_RSV_DELALLOC
);

9270 
ei
->
ru¡ime_Êags
 = 0;

9271 
ei
->
¥›_com¥ess
 = 
BTRFS_COMPRESS_NONE
;

9272 
ei
->
de‰ag_com¥ess
 = 
BTRFS_COMPRESS_NONE
;

9274 
ei
->
dñayed_node
 = 
NULL
;

9276 
ei
->
i_Ÿime
.
tv_£c
 = 0;

9277 
ei
->
i_Ÿime
.
tv_n£c
 = 0;

9279 
öode
 = &
ei
->
vfs_öode
;

9280 
	`exã¡_m≠_åì_öô
(&
ei
->
exã¡_åì
);

9281 
	`exã¡_io_åì_öô
(
fs_öfo
, &
ei
->
io_åì
, 
IO_TREE_INODE_IO
);

9282 
ei
->
io_åì
.
öode
 =Éi;

9283 
	`exã¡_io_åì_öô
(
fs_öfo
, &
ei
->
fûe_exã¡_åì
,

9284 
IO_TREE_INODE_FILE_EXTENT
);

9285 
	`muãx_öô
(&
ei
->
log_muãx
);

9286 
	`båfs_‹dîed_öode_åì_öô
(&
ei
->
‹dîed_åì
);

9287 
	`INIT_LIST_HEAD
(&
ei
->
dñÆloc_öodes
);

9288 
	`INIT_LIST_HEAD
(&
ei
->
dñayed_ùut
);

9289 
	`RB_CLEAR_NODE
(&
ei
->
rb_node
);

9290 
	`öô_rw£m
(&
ei
->
i_mm≠_lock
);

9292  
öode
;

9293 
	}
}

9295 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


9296 
	$båfs_ã°_de°roy_öode
(
öode
 *inode)

9298 
	`båfs_dr›_exã¡_m≠_ønge
(
	`BTRFS_I
(
öode
), 0, (
u64
)-1, 
Ál£
);

9299 
	`kmem_ˇche_‰ì
(
båfs_öode_ˇchï
, 
	`BTRFS_I
(
öode
));

9300 
	}
}

9303 
	$båfs_‰ì_öode
(
öode
 *inode)

9305 
	`kmem_ˇche_‰ì
(
båfs_öode_ˇchï
, 
	`BTRFS_I
(
öode
));

9306 
	}
}

9308 
	$båfs_de°roy_öode
(
öode
 *
vfs_öode
)

9310 
båfs_‹dîed_exã¡
 *
‹dîed
;

9311 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
vfs_öode
);

9312 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

9313 
boﬁ
 
‰ì•a˚_öode
;

9315 
	`WARN_ON
(!
	`hli°_em±y
(&
vfs_öode
->
i_díåy
));

9316 
	`WARN_ON
(
vfs_öode
->
i_d©a
.
ƒ∑ges
);

9317 
	`WARN_ON
(
öode
->
block_rsv
.
ª£rved
);

9318 
	`WARN_ON
(
öode
->
block_rsv
.
size
);

9319 
	`WARN_ON
(
öode
->
out°™dög_exã¡s
);

9320 i‡(!
	`S_ISDIR
(
vfs_öode
->
i_mode
)) {

9321 
	`WARN_ON
(
öode
->
dñÆloc_byãs
);

9322 
	`WARN_ON
(
öode
->
√w_dñÆloc_byãs
);

9324 
	`WARN_ON
(
öode
->
csum_byãs
);

9325 
	`WARN_ON
(
öode
->
de‰ag_byãs
);

9332 i‡(!
roŸ
)

9339 
‰ì•a˚_öode
 = 
	`båfs_is_‰ì_•a˚_öode
(
öode
);

9342 
‹dîed
 = 
	`båfs_lookup_fú°_‹dîed_exã¡
(
öode
, (
u64
)-1);

9343 i‡(!
‹dîed
)

9346 
	`båfs_îr
(
roŸ
->
fs_öfo
,

9348 
‹dîed
->
fûe_off£t
, ordîed->
num_byãs
);

9350 i‡(!
‰ì•a˚_öode
)

9351 
	`båfs_lockdï_acquúe
(
roŸ
->
fs_öfo
, 
båfs_‹dîed_exã¡
);

9353 
	`båfs_ªmove_‹dîed_exã¡
(
öode
, 
‹dîed
);

9354 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

9355 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

9358 
	`båfs_qgroup_check_ª£rved_Àak
(
öode
);

9359 
	`öode_åì_dñ
(
öode
);

9360 
	`båfs_dr›_exã¡_m≠_ønge
(
öode
, 0, (
u64
)-1, 
Ál£
);

9361 
	`båfs_öode_˛ór_fûe_exã¡_ønge
(
öode
, 0, (
u64
)-1);

9362 
	`båfs_put_roŸ
(
öode
->
roŸ
);

9363 
	}
}

9365 
	$båfs_dr›_öode
(
öode
 *inode)

9367 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

9369 i‡(
roŸ
 =
NULL
)

9373 i‡(
	`båfs_roŸ_ªfs
(&
roŸ
->
roŸ_ôem
) == 0)

9376  
	`gíîic_dr›_öode
(
öode
);

9377 
	}
}

9379 
	$öô_⁄˚
(*
foo
)

9381 
båfs_öode
 *
ei
 = 
foo
;

9383 
	`öode_öô_⁄˚
(&
ei
->
vfs_öode
);

9384 
	}
}

9386 
__cﬁd
 
	$båfs_de°roy_ˇchï
()

9392 
	`rcu_b¨rõr
();

9393 
	`bio£t_exô
(&
båfs_dio_bio£t
);

9394 
	`kmem_ˇche_de°roy
(
båfs_öode_ˇchï
);

9395 
	}
}

9397 
__öô
 
	$båfs_öô_ˇchï
()

9399 
båfs_öode_ˇchï
 = 
	`kmem_ˇche_¸óã
("btrfs_inode",

9400 (
båfs_öode
), 0,

9401 
SLAB_RECLAIM_ACCOUNT
 | 
SLAB_MEM_SPREAD
 | 
SLAB_ACCOUNT
,

9402 
öô_⁄˚
);

9403 i‡(!
båfs_öode_ˇchï
)

9404 
Áû
;

9406 i‡(
	`bio£t_öô
(&
båfs_dio_bio£t
, 
BIO_POOL_SIZE
,

9407 
	`off£tof
(
båfs_dio_¥iv©e
, 
bbio
.
bio
),

9408 
BIOSET_NEED_BVECS
))

9409 
Áû
;

9412 
Áû
:

9413 
	`båfs_de°roy_ˇchï
();

9414  -
ENOMEM
;

9415 
	}
}

9417 
	$båfs_gë©å
(
m¡_idm≠
 *
idm≠
,

9418 c⁄° 
∑th
 *∑th, 
k°©
 *
°©
,

9419 
u32
 
ªque°_mask
, 
Êags
)

9422 
u64
 
dñÆloc_byãs
;

9423 
u64
 
öode_byãs
;

9425 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

9426 
u32
 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

9429 
	`¥ötk
(
KERN_INFO
 "båfs_gë©å: CÆÀd wôh inodêo‡fs_id %d...\n", 
öode
->
fs_id
);

9431 
u32
 
bi_Êags
 = 
	`BTRFS_I
(
öode
)->
Êags
;

9432 
u32
 
bi_ro_Êags
 = 
	`BTRFS_I
(
öode
)->
ro_Êags
;

9434 
°©
->
ªsu…_mask
 |
STATX_BTIME
;

9435 
°©
->
btime
.
tv_£c
 = 
	`BTRFS_I
(
öode
)->
i_Ÿime
.tv_sec;

9436 
°©
->
btime
.
tv_n£c
 = 
	`BTRFS_I
(
öode
)->
i_Ÿime
.tv_nsec;

9437 i‡(
bi_Êags
 & 
BTRFS_INODE_APPEND
)

9438 
°©
->
©åibuãs
 |
STATX_ATTR_APPEND
;

9439 i‡(
bi_Êags
 & 
BTRFS_INODE_COMPRESS
)

9440 
°©
->
©åibuãs
 |
STATX_ATTR_COMPRESSED
;

9441 i‡(
bi_Êags
 & 
BTRFS_INODE_IMMUTABLE
)

9442 
°©
->
©åibuãs
 |
STATX_ATTR_IMMUTABLE
;

9443 i‡(
bi_Êags
 & 
BTRFS_INODE_NODUMP
)

9444 
°©
->
©åibuãs
 |
STATX_ATTR_NODUMP
;

9445 i‡(
bi_ro_Êags
 & 
BTRFS_INODE_RO_VERITY
)

9446 
°©
->
©åibuãs
 |
STATX_ATTR_VERITY
;

9448 
°©
->
©åibuãs_mask
 |(
STATX_ATTR_APPEND
 |

9449 
STATX_ATTR_COMPRESSED
 |

9450 
STATX_ATTR_IMMUTABLE
 |

9451 
STATX_ATTR_NODUMP
);

9453 
	`gíîic_fûœâr
(
idm≠
, 
ªque°_mask
, 
öode
, 
°©
);

9454 
°©
->
dev
 = 
	`BTRFS_I
(
öode
)->
roŸ
->
™⁄_dev
;

9456 
	`•ö_lock
(&
	`BTRFS_I
(
öode
)->
lock
);

9457 
dñÆloc_byãs
 = 
	`BTRFS_I
(
öode
)->
√w_dñÆloc_byãs
;

9458 
öode_byãs
 = 
	`öode_gë_byãs
(
öode
);

9459 
	`•ö_u∆ock
(&
	`BTRFS_I
(
öode
)->
lock
);

9460 
°©
->
blocks
 = (
	`ALIGN
(
öode_byãs
, 
blocksize
) +

9461 
	`ALIGN
(
dñÆloc_byãs
, 
blocksize
)Ë>> 
SECTOR_SHIFT
;

9463 
	}
}

9465 
	$båfs_ª«me_exch™ge
(
öode
 *
ﬁd_dú
,

9466 
díåy
 *
ﬁd_díåy
,

9467 
öode
 *
√w_dú
,

9468 
díåy
 *
√w_díåy
)

9470 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
ﬁd_dú
->
i_sb
);

9471 
båfs_å™s_h™dÀ
 *
å™s
;

9472 
å™s_num_ôems
;

9473 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
ﬁd_dú
)->root;

9474 
båfs_roŸ
 *
de°
 = 
	`BTRFS_I
(
√w_dú
)->
roŸ
;

9475 
öode
 *
√w_öode
 = 
√w_díåy
->
d_öode
;

9476 
öode
 *
ﬁd_öode
 = 
ﬁd_díåy
->
d_öode
;

9477 
båfs_ª«me_˘x
 
ﬁd_ª«me_˘x
;

9478 
båfs_ª«me_˘x
 
√w_ª«me_˘x
;

9479 
u64
 
ﬁd_öo
 = 
	`båfs_öo
(
	`BTRFS_I
(
ﬁd_öode
));

9480 
u64
 
√w_öo
 = 
	`båfs_öo
(
	`BTRFS_I
(
√w_öode
));

9481 
u64
 
ﬁd_idx
 = 0;

9482 
u64
 
√w_idx
 = 0;

9483 
ªt
;

9484 
ªt2
;

9485 
boﬁ
 
√ed_ab‹t
 = 
Ál£
;

9486 
fs¸y±_«me
 
ﬁd_‚ame
, 
√w_‚ame
;

9487 
fs¸y±_°r
 *
ﬁd_«me
, *
√w_«me
;

9494 i‡(
roŸ
 !
de°
 &&

9495 (
ﬁd_öo
 !
BTRFS_FIRST_FREE_OBJECTID
 ||

9496 
√w_öo
 !
BTRFS_FIRST_FREE_OBJECTID
))

9497  -
EXDEV
;

9499 
ªt
 = 
	`fs¸y±_£tup_fûíame
(
ﬁd_dú
, &
ﬁd_díåy
->
d_«me
, 0, &
ﬁd_‚ame
);

9500 i‡(
ªt
)

9501  
ªt
;

9503 
ªt
 = 
	`fs¸y±_£tup_fûíame
(
√w_dú
, &
√w_díåy
->
d_«me
, 0, &
√w_‚ame
);

9504 i‡(
ªt
) {

9505 
	`fs¸y±_‰ì_fûíame
(&
ﬁd_‚ame
);

9506  
ªt
;

9509 
ﬁd_«me
 = &
ﬁd_‚ame
.
disk_«me
;

9510 
√w_«me
 = &
√w_‚ame
.
disk_«me
;

9513 i‡(
ﬁd_öo
 =
BTRFS_FIRST_FREE_OBJECTID
 ||

9514 
√w_öo
 =
BTRFS_FIRST_FREE_OBJECTID
)

9515 
	`down_ªad
(&
fs_öfo
->
subvﬁ_£m
);

9527 
å™s_num_ôems
 = (
ﬁd_dú
 =
√w_dú
 ? 9 : 10);

9528 i‡(
ﬁd_öo
 =
BTRFS_FIRST_FREE_OBJECTID
) {

9535 
å™s_num_ôems
 += 4;

9542 
å™s_num_ôems
 += 3;

9544 i‡(
√w_öo
 =
BTRFS_FIRST_FREE_OBJECTID
)

9545 
å™s_num_ôems
 += 4;

9547 
å™s_num_ôems
 += 3;

9548 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 
å™s_num_ôems
);

9549 i‡(
	`IS_ERR
(
å™s
)) {

9550 
ªt
 = 
	`PTR_ERR
(
å™s
);

9551 
out_nŸøns
;

9554 i‡(
de°
 !
roŸ
) {

9555 
ªt
 = 
	`båfs_ªc‹d_roŸ_ö_å™s
(
å™s
, 
de°
);

9556 i‡(
ªt
)

9557 
out_Áû
;

9564 
ªt
 = 
	`båfs_£t_öode_ödex
(
	`BTRFS_I
(
√w_dú
), &
ﬁd_idx
);

9565 i‡(
ªt
)

9566 
out_Áû
;

9567 
ªt
 = 
	`båfs_£t_öode_ödex
(
	`BTRFS_I
(
ﬁd_dú
), &
√w_idx
);

9568 i‡(
ªt
)

9569 
out_Áû
;

9571 
	`BTRFS_I
(
ﬁd_öode
)->
dú_ödex
 = 0ULL;

9572 
	`BTRFS_I
(
√w_öode
)->
dú_ödex
 = 0ULL;

9575 i‡(
ﬁd_öo
 =
BTRFS_FIRST_FREE_OBJECTID
) {

9577 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

9579 
ªt
 = 
	`båfs_ö£π_öode_ªf
(
å™s
, 
de°
, 
√w_«me
, 
ﬁd_öo
,

9580 
	`båfs_öo
(
	`BTRFS_I
(
√w_dú
)),

9581 
ﬁd_idx
);

9582 i‡(
ªt
)

9583 
out_Áû
;

9584 
√ed_ab‹t
 = 
åue
;

9588 i‡(
√w_öo
 =
BTRFS_FIRST_FREE_OBJECTID
) {

9590 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

9592 
ªt
 = 
	`båfs_ö£π_öode_ªf
(
å™s
, 
roŸ
, 
ﬁd_«me
, 
√w_öo
,

9593 
	`båfs_öo
(
	`BTRFS_I
(
ﬁd_dú
)),

9594 
√w_idx
);

9595 i‡(
ªt
) {

9596 i‡(
√ed_ab‹t
)

9597 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

9598 
out_Áû
;

9603 
	`öode_öc_ivîsi⁄
(
ﬁd_dú
);

9604 
	`öode_öc_ivîsi⁄
(
√w_dú
);

9605 
	`öode_öc_ivîsi⁄
(
ﬁd_öode
);

9606 
	`öode_öc_ivîsi⁄
(
√w_öode
);

9607 
	`sim∂e_ª«me_time°amp
(
ﬁd_dú
, 
ﬁd_díåy
, 
√w_dú
, 
√w_díåy
);

9609 i‡(
ﬁd_díåy
->
d_∑ª¡
 !
√w_díåy
->d_parent) {

9610 
	`båfs_ªc‹d_u∆ök_dú
(
å™s
, 
	`BTRFS_I
(
ﬁd_dú
),

9611 
	`BTRFS_I
(
ﬁd_öode
), 
åue
);

9612 
	`båfs_ªc‹d_u∆ök_dú
(
å™s
, 
	`BTRFS_I
(
√w_dú
),

9613 
	`BTRFS_I
(
√w_öode
), 
åue
);

9617 i‡(
ﬁd_öo
 =
BTRFS_FIRST_FREE_OBJECTID
) {

9618 
ªt
 = 
	`båfs_u∆ök_subvﬁ
(
å™s
, 
	`BTRFS_I
(
ﬁd_dú
), 
ﬁd_díåy
);

9620 
ªt
 = 
	`__båfs_u∆ök_öode
(
å™s
, 
	`BTRFS_I
(
ﬁd_dú
),

9621 
	`BTRFS_I
(
ﬁd_díåy
->
d_öode
),

9622 
ﬁd_«me
, &
ﬁd_ª«me_˘x
);

9623 i‡(!
ªt
)

9624 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
ﬁd_öode
));

9626 i‡(
ªt
) {

9627 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

9628 
out_Áû
;

9632 i‡(
√w_öo
 =
BTRFS_FIRST_FREE_OBJECTID
) {

9633 
ªt
 = 
	`båfs_u∆ök_subvﬁ
(
å™s
, 
	`BTRFS_I
(
√w_dú
), 
√w_díåy
);

9635 
ªt
 = 
	`__båfs_u∆ök_öode
(
å™s
, 
	`BTRFS_I
(
√w_dú
),

9636 
	`BTRFS_I
(
√w_díåy
->
d_öode
),

9637 
√w_«me
, &
√w_ª«me_˘x
);

9638 i‡(!
ªt
)

9639 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
de°
, 
	`BTRFS_I
(
√w_öode
));

9641 i‡(
ªt
) {

9642 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

9643 
out_Áû
;

9646 
ªt
 = 
	`båfs_add_lök
(
å™s
, 
	`BTRFS_I
(
√w_dú
), BTRFS_I(
ﬁd_öode
),

9647 
√w_«me
, 0, 
ﬁd_idx
);

9648 i‡(
ªt
) {

9649 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

9650 
out_Áû
;

9653 
ªt
 = 
	`båfs_add_lök
(
å™s
, 
	`BTRFS_I
(
ﬁd_dú
), BTRFS_I(
√w_öode
),

9654 
ﬁd_«me
, 0, 
√w_idx
);

9655 i‡(
ªt
) {

9656 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

9657 
out_Áû
;

9660 i‡(
ﬁd_öode
->
i_∆ök
 == 1)

9661 
	`BTRFS_I
(
ﬁd_öode
)->
dú_ödex
 = 
ﬁd_idx
;

9662 i‡(
√w_öode
->
i_∆ök
 == 1)

9663 
	`BTRFS_I
(
√w_öode
)->
dú_ödex
 = 
√w_idx
;

9671 i‡(
ﬁd_öo
 !
BTRFS_FIRST_FREE_OBJECTID
)

9672 
	`båfs_pö_log_å™s
(
roŸ
);

9673 i‡(
√w_öo
 !
BTRFS_FIRST_FREE_OBJECTID
)

9674 
	`båfs_pö_log_å™s
(
de°
);

9677 i‡(
ﬁd_öo
 !
BTRFS_FIRST_FREE_OBJECTID
)

9678 
	`båfs_log_√w_«me
(
å™s
, 
ﬁd_díåy
, 
	`BTRFS_I
(
ﬁd_dú
),

9679 
ﬁd_ª«me_˘x
.
ödex
, 
√w_díåy
->
d_∑ª¡
);

9680 i‡(
√w_öo
 !
BTRFS_FIRST_FREE_OBJECTID
)

9681 
	`båfs_log_√w_«me
(
å™s
, 
√w_díåy
, 
	`BTRFS_I
(
√w_dú
),

9682 
√w_ª«me_˘x
.
ödex
, 
ﬁd_díåy
->
d_∑ª¡
);

9685 i‡(
ﬁd_öo
 !
BTRFS_FIRST_FREE_OBJECTID
)

9686 
	`båfs_íd_log_å™s
(
roŸ
);

9687 i‡(
√w_öo
 !
BTRFS_FIRST_FREE_OBJECTID
)

9688 
	`båfs_íd_log_å™s
(
de°
);

9689 
out_Áû
:

9690 
ªt2
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

9691 
ªt
 =Ñë ?Ñë : 
ªt2
;

9692 
out_nŸøns
:

9693 i‡(
√w_öo
 =
BTRFS_FIRST_FREE_OBJECTID
 ||

9694 
ﬁd_öo
 =
BTRFS_FIRST_FREE_OBJECTID
)

9695 
	`up_ªad
(&
fs_öfo
->
subvﬁ_£m
);

9697 
	`fs¸y±_‰ì_fûíame
(&
√w_‚ame
);

9698 
	`fs¸y±_‰ì_fûíame
(&
ﬁd_‚ame
);

9699  
ªt
;

9700 
	}
}

9702 
öode
 *
	$√w_whôeout_öode
(
m¡_idm≠
 *
idm≠
,

9703 
öode
 *
dú
)

9705 
öode
 *inode;

9707 
öode
 = 
	`√w_öode
(
dú
->
i_sb
);

9708 i‡(
öode
) {

9709 
	`öode_öô_ow√r
(
idm≠
, 
öode
, 
dú
,

9710 
S_IFCHR
 | 
WHITEOUT_MODE
);

9711 
öode
->
i_›
 = &
båfs_•ecül_öode_›î©i⁄s
;

9712 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
, 
WHITEOUT_DEV
);

9714  
öode
;

9715 
	}
}

9717 
	$båfs_ª«me
(
m¡_idm≠
 *
idm≠
,

9718 
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

9719 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
,

9720 
Êags
)

9722 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
ﬁd_dú
->
i_sb
);

9723 
båfs_√w_öode_¨gs
 
whôeout_¨gs
 = {

9724 .
dú
 = 
ﬁd_dú
,

9725 .
díåy
 = 
ﬁd_díåy
,

9727 
båfs_å™s_h™dÀ
 *
å™s
;

9728 
å™s_num_ôems
;

9729 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
ﬁd_dú
)->root;

9730 
båfs_roŸ
 *
de°
 = 
	`BTRFS_I
(
√w_dú
)->
roŸ
;

9731 
öode
 *
√w_öode
 = 
	`d_öode
(
√w_díåy
);

9732 
öode
 *
ﬁd_öode
 = 
	`d_öode
(
ﬁd_díåy
);

9733 
båfs_ª«me_˘x
 
ª«me_˘x
;

9734 
u64
 
ödex
 = 0;

9735 
ªt
;

9736 
ªt2
;

9737 
u64
 
ﬁd_öo
 = 
	`båfs_öo
(
	`BTRFS_I
(
ﬁd_öode
));

9738 
fs¸y±_«me
 
ﬁd_‚ame
, 
√w_‚ame
;

9740 i‡(
	`båfs_öo
(
	`BTRFS_I
(
√w_dú
)Ë=
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
)

9741  -
EPERM
;

9744 i‡(
ﬁd_öo
 !
BTRFS_FIRST_FREE_OBJECTID
 && 
roŸ
 !
de°
)

9745  -
EXDEV
;

9747 i‡(
ﬁd_öo
 =
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
 ||

9748 (
√w_öode
 && 
	`båfs_öo
(
	`BTRFS_I
“ew_öode)Ë=
BTRFS_FIRST_FREE_OBJECTID
))

9749  -
ENOTEMPTY
;

9751 i‡(
	`S_ISDIR
(
ﬁd_öode
->
i_mode
Ë&& 
√w_öode
 &&

9752 
√w_öode
->
i_size
 > 
BTRFS_EMPTY_DIR_SIZE
)

9753  -
ENOTEMPTY
;

9755 
ªt
 = 
	`fs¸y±_£tup_fûíame
(
ﬁd_dú
, &
ﬁd_díåy
->
d_«me
, 0, &
ﬁd_‚ame
);

9756 i‡(
ªt
)

9757  
ªt
;

9759 
ªt
 = 
	`fs¸y±_£tup_fûíame
(
√w_dú
, &
√w_díåy
->
d_«me
, 0, &
√w_‚ame
);

9760 i‡(
ªt
) {

9761 
	`fs¸y±_‰ì_fûíame
(&
ﬁd_‚ame
);

9762  
ªt
;

9766 
ªt
 = 
	`båfs_check_dú_ôem_cﬁlisi⁄
(
de°
, 
√w_dú
->
i_öo
, &
√w_‚ame
.
disk_«me
);

9767 i‡(
ªt
) {

9768 i‡(
ªt
 =-
EEXIST
) {

9771 i‡(
	`WARN_ON
(!
√w_öode
)) {

9772 
out_fs¸y±_«mes
;

9776 
out_fs¸y±_«mes
;

9779 
ªt
 = 0;

9785 i‡(
√w_öode
 && 
	`S_ISREG
(
ﬁd_öode
->
i_mode
Ë&&Çew_öode->
i_size
)

9786 
	`fûem≠_Êush
(
ﬁd_öode
->
i_m≠pög
);

9788 i‡(
Êags
 & 
RENAME_WHITEOUT
) {

9789 
whôeout_¨gs
.
öode
 = 
	`√w_whôeout_öode
(
idm≠
, 
ﬁd_dú
);

9790 i‡(!
whôeout_¨gs
.
öode
) {

9791 
ªt
 = -
ENOMEM
;

9792 
out_fs¸y±_«mes
;

9794 
ªt
 = 
	`båfs_√w_öode_¥ï¨e
(&
whôeout_¨gs
, &
å™s_num_ôems
);

9795 i‡(
ªt
)

9796 
out_whôeout_öode
;

9799 
å™s_num_ôems
 = 1;

9802 i‡(
ﬁd_öo
 =
BTRFS_FIRST_FREE_OBJECTID
) {

9804 
	`down_ªad
(&
fs_öfo
->
subvﬁ_£m
);

9811 
å™s_num_ôems
 += 4;

9818 
å™s_num_ôems
 += 3;

9826 
å™s_num_ôems
 += 4;

9828 i‡(
√w_dú
 !
ﬁd_dú
)

9829 
å™s_num_ôems
++;

9830 i‡(
√w_öode
) {

9838 
å™s_num_ôems
 += 5;

9840 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 
å™s_num_ôems
);

9841 i‡(
	`IS_ERR
(
å™s
)) {

9842 
ªt
 = 
	`PTR_ERR
(
å™s
);

9843 
out_nŸøns
;

9846 i‡(
de°
 !
roŸ
) {

9847 
ªt
 = 
	`båfs_ªc‹d_roŸ_ö_å™s
(
å™s
, 
de°
);

9848 i‡(
ªt
)

9849 
out_Áû
;

9852 
ªt
 = 
	`båfs_£t_öode_ödex
(
	`BTRFS_I
(
√w_dú
), &
ödex
);

9853 i‡(
ªt
)

9854 
out_Áû
;

9856 
	`BTRFS_I
(
ﬁd_öode
)->
dú_ödex
 = 0ULL;

9857 i‡(
	`u∆ikñy
(
ﬁd_öo
 =
BTRFS_FIRST_FREE_OBJECTID
)) {

9859 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

9861 
ªt
 = 
	`båfs_ö£π_öode_ªf
(
å™s
, 
de°
, &
√w_‚ame
.
disk_«me
,

9862 
ﬁd_öo
, 
	`båfs_öo
(
	`BTRFS_I
(
√w_dú
)),

9863 
ödex
);

9864 i‡(
ªt
)

9865 
out_Áû
;

9868 
	`öode_öc_ivîsi⁄
(
ﬁd_dú
);

9869 
	`öode_öc_ivîsi⁄
(
√w_dú
);

9870 
	`öode_öc_ivîsi⁄
(
ﬁd_öode
);

9871 
	`sim∂e_ª«me_time°amp
(
ﬁd_dú
, 
ﬁd_díåy
, 
√w_dú
, 
√w_díåy
);

9873 i‡(
ﬁd_díåy
->
d_∑ª¡
 !
√w_díåy
->d_parent)

9874 
	`båfs_ªc‹d_u∆ök_dú
(
å™s
, 
	`BTRFS_I
(
ﬁd_dú
),

9875 
	`BTRFS_I
(
ﬁd_öode
), 
åue
);

9877 i‡(
	`u∆ikñy
(
ﬁd_öo
 =
BTRFS_FIRST_FREE_OBJECTID
)) {

9878 
ªt
 = 
	`båfs_u∆ök_subvﬁ
(
å™s
, 
	`BTRFS_I
(
ﬁd_dú
), 
ﬁd_díåy
);

9880 
ªt
 = 
	`__båfs_u∆ök_öode
(
å™s
, 
	`BTRFS_I
(
ﬁd_dú
),

9881 
	`BTRFS_I
(
	`d_öode
(
ﬁd_díåy
)),

9882 &
ﬁd_‚ame
.
disk_«me
, &
ª«me_˘x
);

9883 i‡(!
ªt
)

9884 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
ﬁd_öode
));

9886 i‡(
ªt
) {

9887 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

9888 
out_Áû
;

9891 i‡(
√w_öode
) {

9892 
	`öode_öc_ivîsi⁄
(
√w_öode
);

9893 i‡(
	`u∆ikñy
(
	`båfs_öo
(
	`BTRFS_I
(
√w_öode
)) ==

9894 
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
)) {

9895 
ªt
 = 
	`båfs_u∆ök_subvﬁ
(
å™s
, 
	`BTRFS_I
(
√w_dú
), 
√w_díåy
);

9896 
	`BUG_ON
(
√w_öode
->
i_∆ök
 == 0);

9898 
ªt
 = 
	`båfs_u∆ök_öode
(
å™s
, 
	`BTRFS_I
(
√w_dú
),

9899 
	`BTRFS_I
(
	`d_öode
(
√w_díåy
)),

9900 &
√w_‚ame
.
disk_«me
);

9902 i‡(!
ªt
 && 
√w_öode
->
i_∆ök
 == 0)

9903 
ªt
 = 
	`båfs_‹ph™_add
(
å™s
,

9904 
	`BTRFS_I
(
	`d_öode
(
√w_díåy
)));

9905 i‡(
ªt
) {

9906 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

9907 
out_Áû
;

9911 
ªt
 = 
	`båfs_add_lök
(
å™s
, 
	`BTRFS_I
(
√w_dú
), BTRFS_I(
ﬁd_öode
),

9912 &
√w_‚ame
.
disk_«me
, 0, 
ödex
);

9913 i‡(
ªt
) {

9914 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

9915 
out_Áû
;

9918 i‡(
ﬁd_öode
->
i_∆ök
 == 1)

9919 
	`BTRFS_I
(
ﬁd_öode
)->
dú_ödex
 = 
ödex
;

9921 i‡(
ﬁd_öo
 !
BTRFS_FIRST_FREE_OBJECTID
)

9922 
	`båfs_log_√w_«me
(
å™s
, 
ﬁd_díåy
, 
	`BTRFS_I
(
ﬁd_dú
),

9923 
ª«me_˘x
.
ödex
, 
√w_díåy
->
d_∑ª¡
);

9925 i‡(
Êags
 & 
RENAME_WHITEOUT
) {

9926 
ªt
 = 
	`båfs_¸óã_√w_öode
(
å™s
, &
whôeout_¨gs
);

9927 i‡(
ªt
) {

9928 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

9929 
out_Áû
;

9931 
	`u∆ock_√w_öode
(
whôeout_¨gs
.
öode
);

9932 
	`ùut
(
whôeout_¨gs
.
öode
);

9933 
whôeout_¨gs
.
öode
 = 
NULL
;

9936 
out_Áû
:

9937 
ªt2
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

9938 
ªt
 =Ñë ?Ñë : 
ªt2
;

9939 
out_nŸøns
:

9940 i‡(
ﬁd_öo
 =
BTRFS_FIRST_FREE_OBJECTID
)

9941 
	`up_ªad
(&
fs_öfo
->
subvﬁ_£m
);

9942 i‡(
Êags
 & 
RENAME_WHITEOUT
)

9943 
	`båfs_√w_öode_¨gs_de°roy
(&
whôeout_¨gs
);

9944 
out_whôeout_öode
:

9945 i‡(
Êags
 & 
RENAME_WHITEOUT
)

9946 
	`ùut
(
whôeout_¨gs
.
öode
);

9947 
out_fs¸y±_«mes
:

9948 
	`fs¸y±_‰ì_fûíame
(&
ﬁd_‚ame
);

9949 
	`fs¸y±_‰ì_fûíame
(&
√w_‚ame
);

9950  
ªt
;

9951 
	}
}

9953 
	$båfs_ª«me2
(
m¡_idm≠
 *
idm≠
, 
öode
 *
ﬁd_dú
,

9954 
díåy
 *
ﬁd_díåy
, 
öode
 *
√w_dú
,

9955 
díåy
 *
√w_díåy
, 
Êags
)

9957 
ªt
;

9959 i‡(
Êags
 & ~(
RENAME_NOREPLACE
 | 
RENAME_EXCHANGE
 | 
RENAME_WHITEOUT
))

9960  -
EINVAL
;

9962 i‡(
Êags
 & 
RENAME_EXCHANGE
)

9963 
ªt
 = 
	`båfs_ª«me_exch™ge
(
ﬁd_dú
, 
ﬁd_díåy
, 
√w_dú
,

9964 
√w_díåy
);

9966 
ªt
 = 
	`båfs_ª«me
(
idm≠
, 
ﬁd_dú
, 
ﬁd_díåy
, 
√w_dú
,

9967 
√w_díåy
, 
Êags
);

9969 
	`båfs_båì_bÆ™˚_dúty
(
	`BTRFS_I
(
√w_dú
)->
roŸ
->
fs_öfo
);

9971  
ªt
;

9972 
	}
}

9974 
	sbåfs_dñÆloc_w‹k
 {

9975 
öode
 *
	möode
;

9976 
com∂ëi⁄
 
	mcom∂ëi⁄
;

9977 
li°_hód
 
	mli°
;

9978 
båfs_w‹k
 
	mw‹k
;

9981 
	$båfs_run_dñÆloc_w‹k
(
båfs_w‹k
 *
w‹k
)

9983 
båfs_dñÆloc_w‹k
 *
dñÆloc_w‹k
;

9984 
öode
 *inode;

9986 
dñÆloc_w‹k
 = 
	`c⁄èöî_of
(
w‹k
, 
båfs_dñÆloc_w‹k
,

9987 
w‹k
);

9988 
öode
 = 
dñÆloc_w‹k
->inode;

9989 
	`fûem≠_Êush
(
öode
->
i_m≠pög
);

9990 i‡(
	`ã°_bô
(
BTRFS_INODE_HAS_ASYNC_EXTENT
,

9991 &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
))

9992 
	`fûem≠_Êush
(
öode
->
i_m≠pög
);

9994 
	`ùut
(
öode
);

9995 
	`com∂ëe
(&
dñÆloc_w‹k
->
com∂ëi⁄
);

9996 
	}
}

9998 
båfs_dñÆloc_w‹k
 *
	$båfs_Æloc_dñÆloc_w‹k
(
öode
 *inode)

10000 
båfs_dñÆloc_w‹k
 *
w‹k
;

10002 
w‹k
 = 
	`kmÆloc
((*w‹k), 
GFP_NOFS
);

10003 i‡(!
w‹k
)

10004  
NULL
;

10006 
	`öô_com∂ëi⁄
(&
w‹k
->
com∂ëi⁄
);

10007 
	`INIT_LIST_HEAD
(&
w‹k
->
li°
);

10008 
w‹k
->
öode
 = inode;

10009 
	`båfs_öô_w‹k
(&
w‹k
->w‹k, 
båfs_run_dñÆloc_w‹k
, 
NULL
, NULL);

10011  
w‹k
;

10012 
	}
}

10018 
	$°¨t_dñÆloc_öodes
(
båfs_roŸ
 *
roŸ
,

10019 
wrôeback_c⁄åﬁ
 *
wbc
, 
boﬁ
 
¢≠shŸ
,

10020 
boﬁ
 
ö_ª˛aim_c⁄ãxt
)

10022 
båfs_öode
 *
böode
;

10023 
öode
 *inode;

10024 
båfs_dñÆloc_w‹k
 *
w‹k
, *
√xt
;

10025 
	`LIST_HEAD
(
w‹ks
);

10026 
	`LIST_HEAD
(
•li˚
);

10027 
ªt
 = 0;

10028 
boﬁ
 
fuŒ_Êush
 = 
wbc
->
ƒ_to_wrôe
 =
LONG_MAX
;

10030 
	`muãx_lock
(&
roŸ
->
dñÆloc_muãx
);

10031 
	`•ö_lock
(&
roŸ
->
dñÆloc_lock
);

10032 
	`li°_•li˚_öô
(&
roŸ
->
dñÆloc_öodes
, &
•li˚
);

10033 !
	`li°_em±y
(&
•li˚
)) {

10034 
böode
 = 
	`li°_íåy
(
•li˚
.
√xt
, 
båfs_öode
,

10035 
dñÆloc_öodes
);

10037 
	`li°_move_èû
(&
böode
->
dñÆloc_öodes
,

10038 &
roŸ
->
dñÆloc_öodes
);

10040 i‡(
ö_ª˛aim_c⁄ãxt
 &&

10041 
	`ã°_bô
(
BTRFS_INODE_NO_DELALLOC_FLUSH
, &
böode
->
ru¡ime_Êags
))

10044 
öode
 = 
	`igøb
(&
böode
->
vfs_öode
);

10045 i‡(!
öode
) {

10046 
	`c⁄d_ªsched_lock
(&
roŸ
->
dñÆloc_lock
);

10049 
	`•ö_u∆ock
(&
roŸ
->
dñÆloc_lock
);

10051 i‡(
¢≠shŸ
)

10052 
	`£t_bô
(
BTRFS_INODE_SNAPSHOT_FLUSH
,

10053 &
böode
->
ru¡ime_Êags
);

10054 i‡(
fuŒ_Êush
) {

10055 
w‹k
 = 
	`båfs_Æloc_dñÆloc_w‹k
(
öode
);

10056 i‡(!
w‹k
) {

10057 
	`ùut
(
öode
);

10058 
ªt
 = -
ENOMEM
;

10059 
out
;

10061 
	`li°_add_èû
(&
w‹k
->
li°
, &
w‹ks
);

10062 
	`båfs_queue_w‹k
(
roŸ
->
fs_öfo
->
Êush_w‹kîs
,

10063 &
w‹k
->work);

10065 
ªt
 = 
	`fûem≠_fd©awrôe_wbc
(
öode
->
i_m≠pög
, 
wbc
);

10066 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
öode
));

10067 i‡(
ªt
 || 
wbc
->
ƒ_to_wrôe
 <= 0)

10068 
out
;

10070 
	`c⁄d_ªsched
();

10071 
	`•ö_lock
(&
roŸ
->
dñÆloc_lock
);

10073 
	`•ö_u∆ock
(&
roŸ
->
dñÆloc_lock
);

10075 
out
:

10076 
	`li°_f‹_óch_íåy_ß„
(
w‹k
, 
√xt
, &
w‹ks
, 
li°
) {

10077 
	`li°_dñ_öô
(&
w‹k
->
li°
);

10078 
	`waô_f‹_com∂ëi⁄
(&
w‹k
->
com∂ëi⁄
);

10079 
	`k‰ì
(
w‹k
);

10082 i‡(!
	`li°_em±y
(&
•li˚
)) {

10083 
	`•ö_lock
(&
roŸ
->
dñÆloc_lock
);

10084 
	`li°_•li˚_èû
(&
•li˚
, &
roŸ
->
dñÆloc_öodes
);

10085 
	`•ö_u∆ock
(&
roŸ
->
dñÆloc_lock
);

10087 
	`muãx_u∆ock
(&
roŸ
->
dñÆloc_muãx
);

10088  
ªt
;

10089 
	}
}

10091 
	$båfs_°¨t_dñÆloc_¢≠shŸ
(
båfs_roŸ
 *
roŸ
, 
boﬁ
 
ö_ª˛aim_c⁄ãxt
)

10093 
wrôeback_c⁄åﬁ
 
wbc
 = {

10094 .
ƒ_to_wrôe
 = 
LONG_MAX
,

10095 .
sync_mode
 = 
WB_SYNC_NONE
,

10096 .
ønge_°¨t
 = 0,

10097 .
ønge_íd
 = 
LLONG_MAX
,

10099 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

10101 i‡(
	`BTRFS_FS_ERROR
(
fs_öfo
))

10102  -
EROFS
;

10104  
	`°¨t_dñÆloc_öodes
(
roŸ
, &
wbc
, 
åue
, 
ö_ª˛aim_c⁄ãxt
);

10105 
	}
}

10107 
	$båfs_°¨t_dñÆloc_roŸs
(
båfs_fs_öfo
 *
fs_öfo
, 
ƒ
,

10108 
boﬁ
 
ö_ª˛aim_c⁄ãxt
)

10110 
wrôeback_c⁄åﬁ
 
wbc
 = {

10111 .
ƒ_to_wrôe
 = 
ƒ
,

10112 .
sync_mode
 = 
WB_SYNC_NONE
,

10113 .
ønge_°¨t
 = 0,

10114 .
ønge_íd
 = 
LLONG_MAX
,

10116 
båfs_roŸ
 *
roŸ
;

10117 
	`LIST_HEAD
(
•li˚
);

10118 
ªt
;

10120 i‡(
	`BTRFS_FS_ERROR
(
fs_öfo
))

10121  -
EROFS
;

10123 
	`muãx_lock
(&
fs_öfo
->
dñÆloc_roŸ_muãx
);

10124 
	`•ö_lock
(&
fs_öfo
->
dñÆloc_roŸ_lock
);

10125 
	`li°_•li˚_öô
(&
fs_öfo
->
dñÆloc_roŸs
, &
•li˚
);

10126 !
	`li°_em±y
(&
•li˚
)) {

10131 i‡(
ƒ
 =
LONG_MAX
)

10132 
wbc
.
ƒ_to_wrôe
 = 
LONG_MAX
;

10134 
roŸ
 = 
	`li°_fú°_íåy
(&
•li˚
, 
båfs_roŸ
,

10135 
dñÆloc_roŸ
);

10136 
roŸ
 = 
	`båfs_gøb_roŸ
(root);

10137 
	`BUG_ON
(!
roŸ
);

10138 
	`li°_move_èû
(&
roŸ
->
dñÆloc_roŸ
,

10139 &
fs_öfo
->
dñÆloc_roŸs
);

10140 
	`•ö_u∆ock
(&
fs_öfo
->
dñÆloc_roŸ_lock
);

10142 
ªt
 = 
	`°¨t_dñÆloc_öodes
(
roŸ
, &
wbc
, 
Ál£
, 
ö_ª˛aim_c⁄ãxt
);

10143 
	`båfs_put_roŸ
(
roŸ
);

10144 i‡(
ªt
 < 0 || 
wbc
.
ƒ_to_wrôe
 <= 0)

10145 
out
;

10146 
	`•ö_lock
(&
fs_öfo
->
dñÆloc_roŸ_lock
);

10148 
	`•ö_u∆ock
(&
fs_öfo
->
dñÆloc_roŸ_lock
);

10150 
ªt
 = 0;

10151 
out
:

10152 i‡(!
	`li°_em±y
(&
•li˚
)) {

10153 
	`•ö_lock
(&
fs_öfo
->
dñÆloc_roŸ_lock
);

10154 
	`li°_•li˚_èû
(&
•li˚
, &
fs_öfo
->
dñÆloc_roŸs
);

10155 
	`•ö_u∆ock
(&
fs_öfo
->
dñÆloc_roŸ_lock
);

10157 
	`muãx_u∆ock
(&
fs_öfo
->
dñÆloc_roŸ_muãx
);

10158  
ªt
;

10159 
	}
}

10161 
	$båfs_symlök
(
m¡_idm≠
 *
idm≠
, 
öode
 *
dú
,

10162 
díåy
 *díåy, c⁄° *
sym«me
)

10164 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
dú
->
i_sb
);

10165 
båfs_å™s_h™dÀ
 *
å™s
;

10166 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
dú
)->root;

10167 
båfs_∑th
 *
∑th
;

10168 
båfs_key
 
key
;

10169 
öode
 *inode;

10170 
båfs_√w_öode_¨gs
 
√w_öode_¨gs
 = {

10171 .
dú
 = dir,

10172 .
díåy
 = dentry,

10174 
å™s_num_ôems
;

10175 
îr
;

10176 
«me_Àn
;

10177 
d©asize
;

10178 
±r
;

10179 
båfs_fûe_exã¡_ôem
 *
ei
;

10180 
exã¡_buf„r
 *
Àaf
;

10182 
«me_Àn
 = 
	`°æí
(
sym«me
);

10183 i‡(
«me_Àn
 > 
	`BTRFS_MAX_INLINE_DATA_SIZE
(
fs_öfo
))

10184  -
ENAMETOOLONG
;

10186 
öode
 = 
	`√w_öode
(
dú
->
i_sb
);

10187 i‡(!
öode
)

10188  -
ENOMEM
;

10189 
	`öode_öô_ow√r
(
idm≠
, 
öode
, 
dú
, 
S_IFLNK
 | 
S_IRWXUGO
);

10190 
öode
->
i_›
 = &
båfs_symlök_öode_›î©i⁄s
;

10191 
	`öode_nohighmem
(
öode
);

10192 
öode
->
i_m≠pög
->
a_›s
 = &
båfs_a›s
;

10193 
	`båfs_i_size_wrôe
(
	`BTRFS_I
(
öode
), 
«me_Àn
);

10194 
	`öode_£t_byãs
(
öode
, 
«me_Àn
);

10196 
√w_öode_¨gs
.
öode
 = inode;

10197 
îr
 = 
	`båfs_√w_öode_¥ï¨e
(&
√w_öode_¨gs
, &
å™s_num_ôems
);

10198 i‡(
îr
)

10199 
out_öode
;

10201 
å™s_num_ôems
++;

10203 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 
å™s_num_ôems
);

10204 i‡(
	`IS_ERR
(
å™s
)) {

10205 
îr
 = 
	`PTR_ERR
(
å™s
);

10206 
out_√w_öode_¨gs
;

10209 
îr
 = 
	`båfs_¸óã_√w_öode
(
å™s
, &
√w_öode_¨gs
);

10210 i‡(
îr
)

10211 
out
;

10213 
∑th
 = 
	`båfs_Æloc_∑th
();

10214 i‡(!
∑th
) {

10215 
îr
 = -
ENOMEM
;

10216 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
îr
);

10217 
	`disˇrd_√w_öode
(
öode
);

10218 
öode
 = 
NULL
;

10219 
out
;

10221 
key
.
obje˘id
 = 
	`båfs_öo
(
	`BTRFS_I
(
öode
));

10222 
key
.
off£t
 = 0;

10223 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

10224 
d©asize
 = 
	`båfs_fûe_exã¡_ˇlc_ölöe_size
(
«me_Àn
);

10225 
îr
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
,

10226 
d©asize
);

10227 i‡(
îr
) {

10228 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
îr
);

10229 
	`båfs_‰ì_∑th
(
∑th
);

10230 
	`disˇrd_√w_öode
(
öode
);

10231 
öode
 = 
NULL
;

10232 
out
;

10234 
Àaf
 = 
∑th
->
nodes
[0];

10235 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

10236 
båfs_fûe_exã¡_ôem
);

10237 
	`båfs_£t_fûe_exã¡_gíî©i⁄
(
Àaf
, 
ei
, 
å™s
->
å™sid
);

10238 
	`båfs_£t_fûe_exã¡_ty≥
(
Àaf
, 
ei
,

10239 
BTRFS_FILE_EXTENT_INLINE
);

10240 
	`båfs_£t_fûe_exã¡_í¸y±i⁄
(
Àaf
, 
ei
, 0);

10241 
	`båfs_£t_fûe_exã¡_com¥essi⁄
(
Àaf
, 
ei
, 0);

10242 
	`båfs_£t_fûe_exã¡_Ÿhî_ícodög
(
Àaf
, 
ei
, 0);

10243 
	`båfs_£t_fûe_exã¡_øm_byãs
(
Àaf
, 
ei
, 
«me_Àn
);

10245 
±r
 = 
	`båfs_fûe_exã¡_ölöe_°¨t
(
ei
);

10246 
	`wrôe_exã¡_buf„r
(
Àaf
, 
sym«me
, 
±r
, 
«me_Àn
);

10247 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

10248 
	`båfs_‰ì_∑th
(
∑th
);

10250 
	`d_ö°™tüã_√w
(
díåy
, 
öode
);

10251 
îr
 = 0;

10252 
out
:

10253 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

10254 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

10255 
out_√w_öode_¨gs
:

10256 
	`båfs_√w_öode_¨gs_de°roy
(&
√w_öode_¨gs
);

10257 
out_öode
:

10258 i‡(
îr
)

10259 
	`ùut
(
öode
);

10260  
îr
;

10261 
	}
}

10263 
båfs_å™s_h™dÀ
 *
	$ö£π_¥óŒoc_fûe_exã¡
(

10264 
båfs_å™s_h™dÀ
 *
å™s_ö
,

10265 
båfs_öode
 *
öode
,

10266 
båfs_key
 *
ös
,

10267 
u64
 
fûe_off£t
)

10269 
båfs_fûe_exã¡_ôem
 
°ack_fi
;

10270 
båfs_ª∂a˚_exã¡_öfo
 
exã¡_öfo
;

10271 
båfs_å™s_h™dÀ
 *
å™s
 = 
å™s_ö
;

10272 
båfs_∑th
 *
∑th
;

10273 
u64
 
°¨t
 = 
ös
->
obje˘id
;

10274 
u64
 
Àn
 = 
ös
->
off£t
;

10275 
u64
 
qgroup_ªÀa£d
 = 0;

10276 
ªt
;

10278 
	`mem£t
(&
°ack_fi
, 0, (stack_fi));

10280 
	`båfs_£t_°ack_fûe_exã¡_ty≥
(&
°ack_fi
, 
BTRFS_FILE_EXTENT_PREALLOC
);

10281 
	`båfs_£t_°ack_fûe_exã¡_disk_byãƒ
(&
°ack_fi
, 
°¨t
);

10282 
	`båfs_£t_°ack_fûe_exã¡_disk_num_byãs
(&
°ack_fi
, 
Àn
);

10283 
	`båfs_£t_°ack_fûe_exã¡_num_byãs
(&
°ack_fi
, 
Àn
);

10284 
	`båfs_£t_°ack_fûe_exã¡_øm_byãs
(&
°ack_fi
, 
Àn
);

10285 
	`båfs_£t_°ack_fûe_exã¡_com¥essi⁄
(&
°ack_fi
, 
BTRFS_COMPRESS_NONE
);

10288 
ªt
 = 
	`båfs_qgroup_ªÀa£_d©a
(
öode
, 
fûe_off£t
, 
Àn
, &
qgroup_ªÀa£d
);

10289 i‡(
ªt
 < 0)

10290  
	`ERR_PTR
(
ªt
);

10292 i‡(
å™s
) {

10293 
ªt
 = 
	`ö£π_ª£rved_fûe_exã¡
(
å™s
, 
öode
,

10294 
fûe_off£t
, &
°ack_fi
,

10295 
åue
, 
qgroup_ªÀa£d
);

10296 i‡(
ªt
)

10297 
‰ì_qgroup
;

10298  
å™s
;

10301 
exã¡_öfo
.
disk_off£t
 = 
°¨t
;

10302 
exã¡_öfo
.
disk_Àn
 = 
Àn
;

10303 
exã¡_öfo
.
d©a_off£t
 = 0;

10304 
exã¡_öfo
.
d©a_Àn
 = 
Àn
;

10305 
exã¡_öfo
.
fûe_off£t
 = file_offset;

10306 
exã¡_öfo
.
exã¡_buf
 = (*)&
°ack_fi
;

10307 
exã¡_öfo
.
is_√w_exã¡
 = 
åue
;

10308 
exã¡_öfo
.
upd©e_times
 = 
åue
;

10309 
exã¡_öfo
.
qgroup_ª£rved
 = 
qgroup_ªÀa£d
;

10310 
exã¡_öfo
.
ö£πi⁄s
 = 0;

10312 
∑th
 = 
	`båfs_Æloc_∑th
();

10313 i‡(!
∑th
) {

10314 
ªt
 = -
ENOMEM
;

10315 
‰ì_qgroup
;

10318 
ªt
 = 
	`båfs_ª∂a˚_fûe_exã¡s
(
öode
, 
∑th
, 
fûe_off£t
,

10319 
fûe_off£t
 + 
Àn
 - 1, &
exã¡_öfo
,

10320 &
å™s
);

10321 
	`båfs_‰ì_∑th
(
∑th
);

10322 i‡(
ªt
)

10323 
‰ì_qgroup
;

10324  
å™s
;

10326 
‰ì_qgroup
:

10334 
	`båfs_qgroup_‰ì_ª‰oŸ
(
öode
->
roŸ
->
fs_öfo
,

10335 
öode
->
roŸ
->
roŸ_key
.
obje˘id
, 
qgroup_ªÀa£d
,

10336 
BTRFS_QGROUP_RSV_DATA
);

10337  
	`ERR_PTR
(
ªt
);

10338 
	}
}

10340 
	$__båfs_¥óŒoc_fûe_ønge
(
öode
 *öode, 
mode
,

10341 
u64
 
°¨t
, u64 
num_byãs
, u64 
mö_size
,

10342 
loff_t
 
a˘uÆ_Àn
, 
u64
 *
Æloc_höt
,

10343 
båfs_å™s_h™dÀ
 *
å™s
)

10345 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

10346 
exã¡_m≠
 *
em
;

10347 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

10348 
båfs_key
 
ös
;

10349 
u64
 
cur_off£t
 = 
°¨t
;

10350 
u64
 
˛ór_off£t
 = 
°¨t
;

10351 
u64
 
i_size
;

10352 
u64
 
cur_byãs
;

10353 
u64
 
œ°_Æloc
 = (u64)-1;

10354 
ªt
 = 0;

10355 
boﬁ
 
own_å™s
 = 
åue
;

10356 
u64
 
íd
 = 
°¨t
 + 
num_byãs
 - 1;

10358 i‡(
å™s
)

10359 
own_å™s
 = 
Ál£
;

10360 
num_byãs
 > 0) {

10361 
cur_byãs
 = 
	`mö_t
(
u64
, 
num_byãs
, 
SZ_256M
);

10362 
cur_byãs
 = 
	`max
(cur_byãs, 
mö_size
);

10369 
cur_byãs
 = 
	`mö
(cur_byãs, 
œ°_Æloc
);

10370 
ªt
 = 
	`båfs_ª£rve_exã¡
(
roŸ
, 
cur_byãs
, cur_bytes,

10371 
mö_size
, 0, *
Æloc_höt
, &
ös
, 1, 0);

10372 i‡(
ªt
)

10382 
˛ór_off£t
 +
ös
.
off£t
;

10384 
œ°_Æloc
 = 
ös
.
off£t
;

10385 
å™s
 = 
	`ö£π_¥óŒoc_fûe_exã¡
—øns, 
	`BTRFS_I
(
öode
),

10386 &
ös
, 
cur_off£t
);

10393 
	`båfs_dec_block_group_ª£rv©i⁄s
(
fs_öfo
, 
ös
.
obje˘id
);

10394 i‡(
	`IS_ERR
(
å™s
)) {

10395 
ªt
 = 
	`PTR_ERR
(
å™s
);

10396 
	`båfs_‰ì_ª£rved_exã¡
(
fs_öfo
, 
ös
.
obje˘id
,

10397 
ös
.
off£t
, 0);

10401 
em
 = 
	`Æloc_exã¡_m≠
();

10402 i‡(!
em
) {

10403 
	`båfs_dr›_exã¡_m≠_ønge
(
	`BTRFS_I
(
öode
), 
cur_off£t
,

10404 
cur_off£t
 + 
ös
.
off£t
 - 1, 
Ál£
);

10405 
	`båfs_£t_öode_fuŒ_sync
(
	`BTRFS_I
(
öode
));

10406 
√xt
;

10409 
em
->
°¨t
 = 
cur_off£t
;

10410 
em
->
‹ig_°¨t
 = 
cur_off£t
;

10411 
em
->
Àn
 = 
ös
.
off£t
;

10412 
em
->
block_°¨t
 = 
ös
.
obje˘id
;

10413 
em
->
block_Àn
 = 
ös
.
off£t
;

10414 
em
->
‹ig_block_Àn
 = 
ös
.
off£t
;

10415 
em
->
øm_byãs
 = 
ös
.
off£t
;

10416 
	`£t_bô
(
EXTENT_FLAG_PREALLOC
, &
em
->
Êags
);

10417 
em
->
gíî©i⁄
 = 
å™s
->
å™sid
;

10419 
ªt
 = 
	`båfs_ª∂a˚_exã¡_m≠_ønge
(
	`BTRFS_I
(
öode
), 
em
, 
åue
);

10420 
	`‰ì_exã¡_m≠
(
em
);

10421 
√xt
:

10422 
num_byãs
 -
ös
.
off£t
;

10423 
cur_off£t
 +
ös
.
off£t
;

10424 *
Æloc_höt
 = 
ös
.
obje˘id
 + ins.
off£t
;

10426 
	`öode_öc_ivîsi⁄
(
öode
);

10427 
	`öode_£t_˘ime_cuºít
(
öode
);

10428 
	`BTRFS_I
(
öode
)->
Êags
 |
BTRFS_INODE_PREALLOC
;

10429 i‡(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

10430 (
a˘uÆ_Àn
 > 
öode
->
i_size
) &&

10431 (
cur_off£t
 > 
öode
->
i_size
)) {

10432 i‡(
cur_off£t
 > 
a˘uÆ_Àn
)

10433 
i_size
 = 
a˘uÆ_Àn
;

10435 
i_size
 = 
cur_off£t
;

10436 
	`i_size_wrôe
(
öode
, 
i_size
);

10437 
	`båfs_öode_ß„_disk_i_size_wrôe
(
	`BTRFS_I
(
öode
), 0);

10440 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

10442 i‡(
ªt
) {

10443 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

10444 i‡(
own_å™s
)

10445 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

10449 i‡(
own_å™s
) {

10450 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

10451 
å™s
 = 
NULL
;

10454 i‡(
˛ór_off£t
 < 
íd
)

10455 
	`båfs_‰ì_ª£rved_d©a_•a˚
(
	`BTRFS_I
(
öode
), 
NULL
, 
˛ór_off£t
,

10456 
íd
 - 
˛ór_off£t
 + 1);

10457  
ªt
;

10458 
	}
}

10460 
	$båfs_¥óŒoc_fûe_ønge
(
öode
 *öode, 
mode
,

10461 
u64
 
°¨t
, u64 
num_byãs
, u64 
mö_size
,

10462 
loff_t
 
a˘uÆ_Àn
, 
u64
 *
Æloc_höt
)

10464  
	`__båfs_¥óŒoc_fûe_ønge
(
öode
, 
mode
, 
°¨t
, 
num_byãs
,

10465 
mö_size
, 
a˘uÆ_Àn
, 
Æloc_höt
,

10466 
NULL
);

10467 
	}
}

10469 
	$båfs_¥óŒoc_fûe_ønge_å™s
(
öode
 *inode,

10470 
båfs_å™s_h™dÀ
 *
å™s
, 
mode
,

10471 
u64
 
°¨t
, u64 
num_byãs
, u64 
mö_size
,

10472 
loff_t
 
a˘uÆ_Àn
, 
u64
 *
Æloc_höt
)

10474  
	`__båfs_¥óŒoc_fûe_ønge
(
öode
, 
mode
, 
°¨t
, 
num_byãs
,

10475 
mö_size
, 
a˘uÆ_Àn
, 
Æloc_höt
, 
å™s
);

10476 
	}
}

10478 
	$båfs_≥rmissi⁄
(
m¡_idm≠
 *
idm≠
,

10479 
öode
 *öode, 
mask
)

10481 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

10482 
umode_t
 
mode
 = 
öode
->
i_mode
;

10484 i‡(
mask
 & 
MAY_WRITE
 &&

10485 (
	`S_ISREG
(
mode
Ë|| 
	`S_ISDIR
(modeË|| 
	`S_ISLNK
(mode))) {

10486 i‡(
	`båfs_roŸ_ªad⁄ly
(
roŸ
))

10487  -
EROFS
;

10488 i‡(
	`BTRFS_I
(
öode
)->
Êags
 & 
BTRFS_INODE_READONLY
)

10489  -
EACCES
;

10491  
	`gíîic_≥rmissi⁄
(
idm≠
, 
öode
, 
mask
);

10492 
	}
}

10494 
	$båfs_tmpfûe
(
m¡_idm≠
 *
idm≠
, 
öode
 *
dú
,

10495 
fûe
 *fûe, 
umode_t
 
mode
)

10497 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
dú
->
i_sb
);

10498 
båfs_å™s_h™dÀ
 *
å™s
;

10499 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
dú
)->root;

10500 
öode
 *inode;

10501 
båfs_√w_öode_¨gs
 
√w_öode_¨gs
 = {

10502 .
dú
 = dir,

10503 .
díåy
 = 
fûe
->
f_∑th
.dentry,

10504 .
‹ph™
 = 
åue
,

10506 
å™s_num_ôems
;

10507 
ªt
;

10509 
öode
 = 
	`√w_öode
(
dú
->
i_sb
);

10510 i‡(!
öode
)

10511  -
ENOMEM
;

10512 
	`öode_öô_ow√r
(
idm≠
, 
öode
, 
dú
, 
mode
);

10513 
öode
->
i_f›
 = &
båfs_fûe_›î©i⁄s
;

10514 
öode
->
i_›
 = &
båfs_fûe_öode_›î©i⁄s
;

10515 
öode
->
i_m≠pög
->
a_›s
 = &
båfs_a›s
;

10517 
√w_öode_¨gs
.
öode
 = inode;

10518 
ªt
 = 
	`båfs_√w_öode_¥ï¨e
(&
√w_öode_¨gs
, &
å™s_num_ôems
);

10519 i‡(
ªt
)

10520 
out_öode
;

10522 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 
å™s_num_ôems
);

10523 i‡(
	`IS_ERR
(
å™s
)) {

10524 
ªt
 = 
	`PTR_ERR
(
å™s
);

10525 
out_√w_öode_¨gs
;

10528 
ªt
 = 
	`båfs_¸óã_√w_öode
(
å™s
, &
√w_öode_¨gs
);

10537 
	`£t_∆ök
(
öode
, 1);

10539 i‡(!
ªt
) {

10540 
	`d_tmpfûe
(
fûe
, 
öode
);

10541 
	`u∆ock_√w_öode
(
öode
);

10542 
	`m¨k_öode_dúty
(
öode
);

10545 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

10546 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

10547 
out_√w_öode_¨gs
:

10548 
	`båfs_√w_öode_¨gs_de°roy
(&
√w_öode_¨gs
);

10549 
out_öode
:

10550 i‡(
ªt
)

10551 
	`ùut
(
öode
);

10552  
	`föish_›í_sim∂e
(
fûe
, 
ªt
);

10553 
	}
}

10555 
	$båfs_£t_ønge_wrôeback
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
)

10557 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

10558 
ödex
 = 
°¨t
 >> 
PAGE_SHIFT
;

10559 
íd_ödex
 = 
íd
 >> 
PAGE_SHIFT
;

10560 
∑ge
 *page;

10561 
u32
 
Àn
;

10563 
	`ASSERT
(
íd
 + 1 - 
°¨t
 <
U32_MAX
);

10564 
Àn
 = 
íd
 + 1 - 
°¨t
;

10565 
ödex
 <
íd_ödex
) {

10566 
∑ge
 = 
	`föd_gë_∑ge
(
öode
->
vfs_öode
.
i_m≠pög
, 
ödex
);

10567 
	`ASSERT
(
∑ge
);

10569 
	`båfs_∑ge_£t_wrôeback
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

10570 
	`put_∑ge
(
∑ge
);

10571 
ödex
++;

10573 
	}
}

10575 
	$båfs_ícoded_io_com¥essi⁄_‰om_exã¡
(
båfs_fs_öfo
 *
fs_öfo
,

10576 
com¥ess_ty≥
)

10578 
com¥ess_ty≥
) {

10579 
BTRFS_COMPRESS_NONE
:

10580  
BTRFS_ENCODED_IO_COMPRESSION_NONE
;

10581 
BTRFS_COMPRESS_ZLIB
:

10582  
BTRFS_ENCODED_IO_COMPRESSION_ZLIB
;

10583 
BTRFS_COMPRESS_LZO
:

10588 i‡(
fs_öfo
->
£˘‹size
 < 
SZ_4K
 || fs_öfo->£˘‹sizê> 
SZ_64K
)

10589  -
EINVAL
;

10590  
BTRFS_ENCODED_IO_COMPRESSION_LZO_4K
 +

10591 (
fs_öfo
->
£˘‹size_bôs
 - 12);

10592 
BTRFS_COMPRESS_ZSTD
:

10593  
BTRFS_ENCODED_IO_COMPRESSION_ZSTD
;

10595  -
EUCLEAN
;

10597 
	}
}

10599 
ssize_t
 
	$båfs_ícoded_ªad_ölöe
(

10600 
kiocb
 *
iocb
,

10601 
iov_ôî
 *
ôî
, 
u64
 
°¨t
,

10602 
u64
 
lockíd
,

10603 
exã¡_°©e
 **
ˇched_°©e
,

10604 
u64
 
exã¡_°¨t
, 
size_t
 
cou¡
,

10605 
båfs_io˘l_ícoded_io_¨gs
 *
ícoded
,

10606 
boﬁ
 *
u∆ocked
)

10608 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
	`fûe_öode
(
iocb
->
ki_fûp
));

10609 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

10610 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

10611 
exã¡_io_åì
 *
io_åì
 = &
öode
->io_tree;

10612 
båfs_∑th
 *
∑th
;

10613 
exã¡_buf„r
 *
Àaf
;

10614 
båfs_fûe_exã¡_ôem
 *
ôem
;

10615 
u64
 
øm_byãs
;

10616 
±r
;

10617 *
tmp
;

10618 
ssize_t
 
ªt
;

10620 
∑th
 = 
	`båfs_Æloc_∑th
();

10621 i‡(!
∑th
) {

10622 
ªt
 = -
ENOMEM
;

10623 
out
;

10625 
ªt
 = 
	`båfs_lookup_fûe_exã¡
(
NULL
, 
roŸ
, 
∑th
, 
	`båfs_öo
(
öode
),

10626 
exã¡_°¨t
, 0);

10627 i‡(
ªt
) {

10628 i‡(
ªt
 > 0) {

10630 
ªt
 = -
EIO
;

10632 
out
;

10634 
Àaf
 = 
∑th
->
nodes
[0];

10635 
ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_fûe_exã¡_ôem
);

10637 
øm_byãs
 = 
	`båfs_fûe_exã¡_øm_byãs
(
Àaf
, 
ôem
);

10638 
±r
 = 
	`båfs_fûe_exã¡_ölöe_°¨t
(
ôem
);

10640 
ícoded
->
Àn
 = 
	`mö_t
(
u64
, 
exã¡_°¨t
 + 
øm_byãs
,

10641 
öode
->
vfs_öode
.
i_size
Ë- 
iocb
->
ki_pos
;

10642 
ªt
 = 
	`båfs_ícoded_io_com¥essi⁄_‰om_exã¡
(
fs_öfo
,

10643 
	`båfs_fûe_exã¡_com¥essi⁄
(
Àaf
, 
ôem
));

10644 i‡(
ªt
 < 0)

10645 
out
;

10646 
ícoded
->
com¥essi⁄
 = 
ªt
;

10647 i‡(
ícoded
->
com¥essi⁄
) {

10648 
size_t
 
ölöe_size
;

10650 
ölöe_size
 = 
	`båfs_fûe_exã¡_ölöe_ôem_Àn
(
Àaf
,

10651 
∑th
->
¶Ÿs
[0]);

10652 i‡(
ölöe_size
 > 
cou¡
) {

10653 
ªt
 = -
ENOBUFS
;

10654 
out
;

10656 
cou¡
 = 
ölöe_size
;

10657 
ícoded
->
u√ncoded_Àn
 = 
øm_byãs
;

10658 
ícoded
->
u√ncoded_off£t
 = 
iocb
->
ki_pos
 - 
exã¡_°¨t
;

10660 
cou¡
 = 
	`mö_t
(
u64
, cou¡, 
ícoded
->
Àn
);

10661 
ícoded
->
Àn
 = 
cou¡
;

10662 
ícoded
->
u√ncoded_Àn
 = 
cou¡
;

10663 
±r
 +
iocb
->
ki_pos
 - 
exã¡_°¨t
;

10666 
tmp
 = 
	`kmÆloc
(
cou¡
, 
GFP_NOFS
);

10667 i‡(!
tmp
) {

10668 
ªt
 = -
ENOMEM
;

10669 
out
;

10671 
	`ªad_exã¡_buf„r
(
Àaf
, 
tmp
, 
±r
, 
cou¡
);

10672 
	`båfs_ªÀa£_∑th
(
∑th
);

10673 
	`u∆ock_exã¡
(
io_åì
, 
°¨t
, 
lockíd
, 
ˇched_°©e
);

10674 
	`båfs_öode_u∆ock
(
öode
, 
BTRFS_ILOCK_SHARED
);

10675 *
u∆ocked
 = 
åue
;

10677 
ªt
 = 
	`c›y_to_ôî
(
tmp
, 
cou¡
, 
ôî
);

10678 i‡(
ªt
 !
cou¡
)

10679 
ªt
 = -
EFAULT
;

10680 
	`k‰ì
(
tmp
);

10681 
out
:

10682 
	`båfs_‰ì_∑th
(
∑th
);

10683  
ªt
;

10684 
	}
}

10686 
	sbåfs_ícoded_ªad_¥iv©e
 {

10687 
waô_queue_hód_t
 
	mwaô
;

10688 
©omic_t
 
	m≥ndög
;

10689 
blk_°©us_t
 
	m°©us
;

10692 
	$båfs_ícoded_ªad_ídio
(
båfs_bio
 *
bbio
)

10694 
båfs_ícoded_ªad_¥iv©e
 *
¥iv
 = 
bbio
->
¥iv©e
;

10696 i‡(
bbio
->
bio
.
bi_°©us
) {

10705 
	`WRITE_ONCE
(
¥iv
->
°©us
, 
bbio
->
bio
.
bi_°©us
);

10707 i‡(!
	`©omic_dec_ªtu∫
(&
¥iv
->
≥ndög
))

10708 
	`wake_up
(&
¥iv
->
waô
);

10709 
	`bio_put
(&
bbio
->
bio
);

10710 
	}
}

10712 
	$båfs_ícoded_ªad_ªguœr_fûl_∑ges
(
båfs_öode
 *
öode
,

10713 
u64
 
fûe_off£t
, u64 
disk_byãƒ
,

10714 
u64
 
disk_io_size
, 
∑ge
 **
∑ges
)

10716 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

10717 
båfs_ícoded_ªad_¥iv©e
 
¥iv
 = {

10718 .
≥ndög
 = 
	`ATOMIC_INIT
(1),

10720 
i
 = 0;

10721 
båfs_bio
 *
bbio
;

10723 
	`öô_waôqueue_hód
(&
¥iv
.
waô
);

10725 
bbio
 = 
	`båfs_bio_Æloc
(
BIO_MAX_VECS
, 
REQ_OP_READ
, 
fs_öfo
,

10726 
båfs_ícoded_ªad_ídio
, &
¥iv
);

10727 
bbio
->
bio
.
bi_ôî
.
bi_£˘‹
 = 
disk_byãƒ
 >> 
SECTOR_SHIFT
;

10728 
bbio
->
öode
 = inode;

10731 
size_t
 
byãs
 = 
	`mö_t
(
u64
, 
disk_io_size
, 
PAGE_SIZE
);

10733 i‡(
	`bio_add_∑ge
(&
bbio
->
bio
, 
∑ges
[
i
], 
byãs
, 0) < bytes) {

10734 
	`©omic_öc
(&
¥iv
.
≥ndög
);

10735 
	`båfs_submô_bio
(
bbio
, 0);

10737 
bbio
 = 
	`båfs_bio_Æloc
(
BIO_MAX_VECS
, 
REQ_OP_READ
, 
fs_öfo
,

10738 
båfs_ícoded_ªad_ídio
, &
¥iv
);

10739 
bbio
->
bio
.
bi_ôî
.
bi_£˘‹
 = 
disk_byãƒ
 >> 
SECTOR_SHIFT
;

10740 
bbio
->
öode
 = inode;

10744 
i
++;

10745 
disk_byãƒ
 +
byãs
;

10746 
disk_io_size
 -
byãs
;

10747 } 
disk_io_size
);

10749 
	`©omic_öc
(&
¥iv
.
≥ndög
);

10750 
	`båfs_submô_bio
(
bbio
, 0);

10752 i‡(
	`©omic_dec_ªtu∫
(&
¥iv
.
≥ndög
))

10753 
	`io_waô_evít
(
¥iv
.
waô
, !
	`©omic_ªad
(&¥iv.
≥ndög
));

10755  
	`blk_°©us_to_î∫o
(
	`READ_ONCE
(
¥iv
.
°©us
));

10756 
	}
}

10758 
ssize_t
 
	$båfs_ícoded_ªad_ªguœr
(
kiocb
 *
iocb
,

10759 
iov_ôî
 *
ôî
,

10760 
u64
 
°¨t
, u64 
lockíd
,

10761 
exã¡_°©e
 **
ˇched_°©e
,

10762 
u64
 
disk_byãƒ
, u64 
disk_io_size
,

10763 
size_t
 
cou¡
, 
boﬁ
 
com¥es£d
,

10764 
boﬁ
 *
u∆ocked
)

10766 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
	`fûe_öode
(
iocb
->
ki_fûp
));

10767 
exã¡_io_åì
 *
io_åì
 = &
öode
->io_tree;

10768 
∑ge
 **
∑ges
;

10769 
ƒ_∑ges
, 
i
;

10770 
u64
 
cur
;

10771 
size_t
 
∑ge_off£t
;

10772 
ssize_t
 
ªt
;

10774 
ƒ_∑ges
 = 
	`DIV_ROUND_UP
(
disk_io_size
, 
PAGE_SIZE
);

10775 
∑ges
 = 
	`kˇŒoc
(
ƒ_∑ges
, (
∑ge
 *), 
GFP_NOFS
);

10776 i‡(!
∑ges
)

10777  -
ENOMEM
;

10778 
ªt
 = 
	`båfs_Æloc_∑ge_¨øy
(
ƒ_∑ges
, 
∑ges
);

10779 i‡(
ªt
) {

10780 
ªt
 = -
ENOMEM
;

10781 
out
;

10784 
ªt
 = 
	`båfs_ícoded_ªad_ªguœr_fûl_∑ges
(
öode
, 
°¨t
, 
disk_byãƒ
,

10785 
disk_io_size
, 
∑ges
);

10786 i‡(
ªt
)

10787 
out
;

10789 
	`u∆ock_exã¡
(
io_åì
, 
°¨t
, 
lockíd
, 
ˇched_°©e
);

10790 
	`båfs_öode_u∆ock
(
öode
, 
BTRFS_ILOCK_SHARED
);

10791 *
u∆ocked
 = 
åue
;

10793 i‡(
com¥es£d
) {

10794 
i
 = 0;

10795 
∑ge_off£t
 = 0;

10797 
i
 = (
iocb
->
ki_pos
 - 
°¨t
Ë>> 
PAGE_SHIFT
;

10798 
∑ge_off£t
 = (
iocb
->
ki_pos
 - 
°¨t
Ë& (
PAGE_SIZE
 - 1);

10800 
cur
 = 0;

10801 
cur
 < 
cou¡
) {

10802 
size_t
 
byãs
 = 
	`mö_t
(size_t, 
cou¡
 - 
cur
,

10803 
PAGE_SIZE
 - 
∑ge_off£t
);

10805 i‡(
	`c›y_∑ge_to_ôî
(
∑ges
[
i
], 
∑ge_off£t
, 
byãs
,

10806 
ôî
Ë!
byãs
) {

10807 
ªt
 = -
EFAULT
;

10808 
out
;

10810 
i
++;

10811 
cur
 +
byãs
;

10812 
∑ge_off£t
 = 0;

10814 
ªt
 = 
cou¡
;

10815 
out
:

10816 
i
 = 0; i < 
ƒ_∑ges
; i++) {

10817 i‡(
∑ges
[
i
])

10818 
	`__‰ì_∑ge
(
∑ges
[
i
]);

10820 
	`k‰ì
(
∑ges
);

10821  
ªt
;

10822 
	}
}

10824 
ssize_t
 
	$båfs_ícoded_ªad
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
,

10825 
båfs_io˘l_ícoded_io_¨gs
 *
ícoded
)

10827 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
	`fûe_öode
(
iocb
->
ki_fûp
));

10828 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

10829 
exã¡_io_åì
 *
io_åì
 = &
öode
->io_tree;

10830 
ssize_t
 
ªt
;

10831 
size_t
 
cou¡
 = 
	`iov_ôî_cou¡
(
ôî
);

10832 
u64
 
°¨t
, 
lockíd
, 
disk_byãƒ
, 
disk_io_size
;

10833 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

10834 
exã¡_m≠
 *
em
;

10835 
boﬁ
 
u∆ocked
 = 
Ál£
;

10837 
	`fûe_ac˚s£d
(
iocb
->
ki_fûp
);

10839 
	`båfs_öode_lock
(
öode
, 
BTRFS_ILOCK_SHARED
);

10841 i‡(
iocb
->
ki_pos
 >
öode
->
vfs_öode
.
i_size
) {

10842 
	`båfs_öode_u∆ock
(
öode
, 
BTRFS_ILOCK_SHARED
);

10845 
°¨t
 = 
	`ALIGN_DOWN
(
iocb
->
ki_pos
, 
fs_öfo
->
£˘‹size
);

10850 
lockíd
 = 
°¨t
 + 
BTRFS_MAX_UNCOMPRESSED
 - 1;

10853 
båfs_‹dîed_exã¡
 *
‹dîed
;

10855 
ªt
 = 
	`båfs_waô_‹dîed_ønge
(&
öode
->
vfs_öode
, 
°¨t
,

10856 
lockíd
 - 
°¨t
 + 1);

10857 i‡(
ªt
)

10858 
out_u∆ock_öode
;

10859 
	`lock_exã¡
(
io_åì
, 
°¨t
, 
lockíd
, &
ˇched_°©e
);

10860 
‹dîed
 = 
	`båfs_lookup_‹dîed_ønge
(
öode
, 
°¨t
,

10861 
lockíd
 - 
°¨t
 + 1);

10862 i‡(!
‹dîed
)

10864 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

10865 
	`u∆ock_exã¡
(
io_åì
, 
°¨t
, 
lockíd
, &
ˇched_°©e
);

10866 
	`c⁄d_ªsched
();

10869 
em
 = 
	`båfs_gë_exã¡
(
öode
, 
NULL
, 0, 
°¨t
, 
lockíd
 - start + 1);

10870 i‡(
	`IS_ERR
(
em
)) {

10871 
ªt
 = 
	`PTR_ERR
(
em
);

10872 
out_u∆ock_exã¡
;

10875 i‡(
em
->
block_°¨t
 =
EXTENT_MAP_INLINE
) {

10876 
u64
 
exã¡_°¨t
 = 
em
->
°¨t
;

10882 
	`‰ì_exã¡_m≠
(
em
);

10883 
em
 = 
NULL
;

10884 
ªt
 = 
	`båfs_ícoded_ªad_ölöe
(
iocb
, 
ôî
, 
°¨t
, 
lockíd
,

10885 &
ˇched_°©e
, 
exã¡_°¨t
,

10886 
cou¡
, 
ícoded
, &
u∆ocked
);

10887 
out
;

10894 
ícoded
->
Àn
 = 
	`mö_t
(
u64
, 
	`exã¡_m≠_íd
(
em
),

10895 
öode
->
vfs_öode
.
i_size
Ë- 
iocb
->
ki_pos
;

10896 i‡(
em
->
block_°¨t
 =
EXTENT_MAP_HOLE
 ||

10897 
	`ã°_bô
(
EXTENT_FLAG_PREALLOC
, &
em
->
Êags
)) {

10898 
disk_byãƒ
 = 
EXTENT_MAP_HOLE
;

10899 
cou¡
 = 
	`mö_t
(
u64
, cou¡, 
ícoded
->
Àn
);

10900 
ícoded
->
Àn
 = 
cou¡
;

10901 
ícoded
->
u√ncoded_Àn
 = 
cou¡
;

10902 } i‡(
	`ã°_bô
(
EXTENT_FLAG_COMPRESSED
, &
em
->
Êags
)) {

10903 
disk_byãƒ
 = 
em
->
block_°¨t
;

10908 i‡(
em
->
block_Àn
 > 
cou¡
) {

10909 
ªt
 = -
ENOBUFS
;

10910 
out_em
;

10912 
disk_io_size
 = 
em
->
block_Àn
;

10913 
cou¡
 = 
em
->
block_Àn
;

10914 
ícoded
->
u√ncoded_Àn
 = 
em
->
øm_byãs
;

10915 
ícoded
->
u√ncoded_off£t
 = 
iocb
->
ki_pos
 - 
em
->
‹ig_°¨t
;

10916 
ªt
 = 
	`båfs_ícoded_io_com¥essi⁄_‰om_exã¡
(
fs_öfo
,

10917 
em
->
com¥ess_ty≥
);

10918 i‡(
ªt
 < 0)

10919 
out_em
;

10920 
ícoded
->
com¥essi⁄
 = 
ªt
;

10922 
disk_byãƒ
 = 
em
->
block_°¨t
 + (
°¨t
 -Ém->start);

10923 i‡(
ícoded
->
Àn
 > 
cou¡
)

10924 
ícoded
->
Àn
 = 
cou¡
;

10929 
disk_io_size
 = 
	`mö
(
lockíd
 + 1, 
iocb
->
ki_pos
 + 
ícoded
->
Àn
Ë- 
°¨t
;

10930 
cou¡
 = 
°¨t
 + 
disk_io_size
 - 
iocb
->
ki_pos
;

10931 
ícoded
->
Àn
 = 
cou¡
;

10932 
ícoded
->
u√ncoded_Àn
 = 
cou¡
;

10933 
disk_io_size
 = 
	`ALIGN
(disk_io_size, 
fs_öfo
->
£˘‹size
);

10935 
	`‰ì_exã¡_m≠
(
em
);

10936 
em
 = 
NULL
;

10938 i‡(
disk_byãƒ
 =
EXTENT_MAP_HOLE
) {

10939 
	`u∆ock_exã¡
(
io_åì
, 
°¨t
, 
lockíd
, &
ˇched_°©e
);

10940 
	`båfs_öode_u∆ock
(
öode
, 
BTRFS_ILOCK_SHARED
);

10941 
u∆ocked
 = 
åue
;

10942 
ªt
 = 
	`iov_ôî_zîo
(
cou¡
, 
ôî
);

10943 i‡(
ªt
 !
cou¡
)

10944 
ªt
 = -
EFAULT
;

10946 
ªt
 = 
	`båfs_ícoded_ªad_ªguœr
(
iocb
, 
ôî
, 
°¨t
, 
lockíd
,

10947 &
ˇched_°©e
, 
disk_byãƒ
,

10948 
disk_io_size
, 
cou¡
,

10949 
ícoded
->
com¥essi⁄
,

10950 &
u∆ocked
);

10953 
out
:

10954 i‡(
ªt
 >= 0)

10955 
iocb
->
ki_pos
 +
ícoded
->
Àn
;

10956 
out_em
:

10957 
	`‰ì_exã¡_m≠
(
em
);

10958 
out_u∆ock_exã¡
:

10959 i‡(!
u∆ocked
)

10960 
	`u∆ock_exã¡
(
io_åì
, 
°¨t
, 
lockíd
, &
ˇched_°©e
);

10961 
out_u∆ock_öode
:

10962 i‡(!
u∆ocked
)

10963 
	`båfs_öode_u∆ock
(
öode
, 
BTRFS_ILOCK_SHARED
);

10964  
ªt
;

10965 
	}
}

10967 
ssize_t
 
	$båfs_do_ícoded_wrôe
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
,

10968 c⁄° 
båfs_io˘l_ícoded_io_¨gs
 *
ícoded
)

10970 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
	`fûe_öode
(
iocb
->
ki_fûp
));

10971 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

10972 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

10973 
exã¡_io_åì
 *
io_åì
 = &
öode
->io_tree;

10974 
exã¡_ch™ge£t
 *
d©a_ª£rved
 = 
NULL
;

10975 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

10976 
båfs_‹dîed_exã¡
 *
‹dîed
;

10977 
com¥essi⁄
;

10978 
size_t
 
‹ig_cou¡
;

10979 
u64
 
°¨t
, 
íd
;

10980 
u64
 
num_byãs
, 
øm_byãs
, 
disk_num_byãs
;

10981 
ƒ_∑ges
, 
i
;

10982 
∑ge
 **
∑ges
;

10983 
båfs_key
 
ös
;

10984 
boﬁ
 
exã¡_ª£rved
 = 
Ál£
;

10985 
exã¡_m≠
 *
em
;

10986 
ssize_t
 
ªt
;

10988 
ícoded
->
com¥essi⁄
) {

10989 
BTRFS_ENCODED_IO_COMPRESSION_ZLIB
:

10990 
com¥essi⁄
 = 
BTRFS_COMPRESS_ZLIB
;

10992 
BTRFS_ENCODED_IO_COMPRESSION_ZSTD
:

10993 
com¥essi⁄
 = 
BTRFS_COMPRESS_ZSTD
;

10995 
BTRFS_ENCODED_IO_COMPRESSION_LZO_4K
:

10996 
BTRFS_ENCODED_IO_COMPRESSION_LZO_8K
:

10997 
BTRFS_ENCODED_IO_COMPRESSION_LZO_16K
:

10998 
BTRFS_ENCODED_IO_COMPRESSION_LZO_32K
:

10999 
BTRFS_ENCODED_IO_COMPRESSION_LZO_64K
:

11001 i‡(
ícoded
->
com¥essi⁄
 -

11002 
BTRFS_ENCODED_IO_COMPRESSION_LZO_4K
 + 12 !=

11003 
fs_öfo
->
£˘‹size_bôs
)

11004  -
EINVAL
;

11005 
com¥essi⁄
 = 
BTRFS_COMPRESS_LZO
;

11008  -
EINVAL
;

11010 i‡(
ícoded
->
í¸y±i⁄
 !
BTRFS_ENCODED_IO_ENCRYPTION_NONE
)

11011  -
EINVAL
;

11013 
‹ig_cou¡
 = 
	`iov_ôî_cou¡
(
‰om
);

11016 i‡(
ícoded
->
u√ncoded_Àn
 > 
BTRFS_MAX_UNCOMPRESSED
 ||

11017 
‹ig_cou¡
 > 
BTRFS_MAX_COMPRESSED
 || orig_count == 0)

11018  -
EINVAL
;

11033 i‡(
‹ig_cou¡
 >
ícoded
->
u√ncoded_Àn
)

11034  -
EINVAL
;

11037 
°¨t
 = 
iocb
->
ki_pos
;

11038 i‡(!
	`IS_ALIGNED
(
°¨t
, 
fs_öfo
->
£˘‹size
))

11039  -
EINVAL
;

11046 i‡(
°¨t
 + 
ícoded
->
Àn
 < 
öode
->
vfs_öode
.
i_size
 &&

11047 !
	`IS_ALIGNED
(
°¨t
 + 
ícoded
->
Àn
, 
fs_öfo
->
£˘‹size
))

11048  -
EINVAL
;

11051 i‡(!
	`IS_ALIGNED
(
ícoded
->
u√ncoded_off£t
, 
fs_öfo
->
£˘‹size
))

11052  -
EINVAL
;

11054 
num_byãs
 = 
	`ALIGN
(
ícoded
->
Àn
, 
fs_öfo
->
£˘‹size
);

11055 
øm_byãs
 = 
	`ALIGN
(
ícoded
->
u√ncoded_Àn
, 
fs_öfo
->
£˘‹size
);

11056 
íd
 = 
°¨t
 + 
num_byãs
 - 1;

11063 
disk_num_byãs
 = 
	`ALIGN
(
‹ig_cou¡
, 
fs_öfo
->
£˘‹size
);

11064 
ƒ_∑ges
 = 
	`DIV_ROUND_UP
(
disk_num_byãs
, 
PAGE_SIZE
);

11065 
∑ges
 = 
	`kvˇŒoc
(
ƒ_∑ges
, (
∑ge
 *), 
GFP_KERNEL_ACCOUNT
);

11066 i‡(!
∑ges
)

11067  -
ENOMEM
;

11068 
i
 = 0; i < 
ƒ_∑ges
; i++) {

11069 
size_t
 
byãs
 = 
	`mö_t
(size_t, 
PAGE_SIZE
, 
	`iov_ôî_cou¡
(
‰om
));

11070 *
kaddr
;

11072 
∑ges
[
i
] = 
	`Æloc_∑ge
(
GFP_KERNEL_ACCOUNT
);

11073 i‡(!
∑ges
[
i
]) {

11074 
ªt
 = -
ENOMEM
;

11075 
out_∑ges
;

11077 
kaddr
 = 
	`km≠_loˇl_∑ge
(
∑ges
[
i
]);

11078 i‡(
	`c›y_‰om_ôî
(
kaddr
, 
byãs
, 
‰om
) != bytes) {

11079 
	`kunm≠_loˇl
(
kaddr
);

11080 
ªt
 = -
EFAULT
;

11081 
out_∑ges
;

11083 i‡(
byãs
 < 
PAGE_SIZE
)

11084 
	`mem£t
(
kaddr
 + 
byãs
, 0, 
PAGE_SIZE
 - bytes);

11085 
	`kunm≠_loˇl
(
kaddr
);

11089 
båfs_‹dîed_exã¡
 *
‹dîed
;

11091 
ªt
 = 
	`båfs_waô_‹dîed_ønge
(&
öode
->
vfs_öode
, 
°¨t
, 
num_byãs
);

11092 i‡(
ªt
)

11093 
out_∑ges
;

11094 
ªt
 = 
	`övÆid©e_öode_∑ges2_ønge
(
öode
->
vfs_öode
.
i_m≠pög
,

11095 
°¨t
 >> 
PAGE_SHIFT
,

11096 
íd
 >> 
PAGE_SHIFT
);

11097 i‡(
ªt
)

11098 
out_∑ges
;

11099 
	`lock_exã¡
(
io_åì
, 
°¨t
, 
íd
, &
ˇched_°©e
);

11100 
‹dîed
 = 
	`båfs_lookup_‹dîed_ønge
(
öode
, 
°¨t
, 
num_byãs
);

11101 i‡(!
‹dîed
 &&

11102 !
	`fûem≠_ønge_has_∑ge
(
öode
->
vfs_öode
.
i_m≠pög
, 
°¨t
, 
íd
))

11104 i‡(
‹dîed
)

11105 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

11106 
	`u∆ock_exã¡
(
io_åì
, 
°¨t
, 
íd
, &
ˇched_°©e
);

11107 
	`c⁄d_ªsched
();

11114 
ªt
 = 
	`båfs_Æloc_d©a_chunk_⁄dem™d
(
öode
, 
disk_num_byãs
);

11115 i‡(
ªt
)

11116 
out_u∆ock
;

11117 
ªt
 = 
	`båfs_qgroup_ª£rve_d©a
(
öode
, &
d©a_ª£rved
, 
°¨t
, 
num_byãs
);

11118 i‡(
ªt
)

11119 
out_‰ì_d©a_•a˚
;

11120 
ªt
 = 
	`båfs_dñÆloc_ª£rve_mëad©a
(
öode
, 
num_byãs
, 
disk_num_byãs
,

11121 
Ál£
);

11122 i‡(
ªt
)

11123 
out_qgroup_‰ì_d©a
;

11126 i‡(
°¨t
 =0 && 
ícoded
->
u√ncoded_Àn
 =ícoded->
Àn
 &&

11127 
ícoded
->
u√ncoded_off£t
 == 0) {

11128 
ªt
 = 
	`cow_fûe_ønge_ölöe
(
öode
, 
ícoded
->
Àn
, 
‹ig_cou¡
,

11129 
com¥essi⁄
, 
∑ges
, 
åue
);

11130 i‡(
ªt
 <= 0) {

11131 i‡(
ªt
 == 0)

11132 
ªt
 = 
‹ig_cou¡
;

11133 
out_dñÆloc_ªÀa£
;

11137 
ªt
 = 
	`båfs_ª£rve_exã¡
(
roŸ
, 
disk_num_byãs
, disk_num_bytes,

11138 
disk_num_byãs
, 0, 0, &
ös
, 1, 1);

11139 i‡(
ªt
)

11140 
out_dñÆloc_ªÀa£
;

11141 
exã¡_ª£rved
 = 
åue
;

11143 
em
 = 
	`¸óã_io_em
(
öode
, 
°¨t
, 
num_byãs
,

11144 
°¨t
 - 
ícoded
->
u√ncoded_off£t
, 
ös
.
obje˘id
,

11145 
ös
.
off£t
, ins.off£t, 
øm_byãs
, 
com¥essi⁄
,

11146 
BTRFS_ORDERED_COMPRESSED
);

11147 i‡(
	`IS_ERR
(
em
)) {

11148 
ªt
 = 
	`PTR_ERR
(
em
);

11149 
out_‰ì_ª£rved
;

11151 
	`‰ì_exã¡_m≠
(
em
);

11153 
‹dîed
 = 
	`båfs_Æloc_‹dîed_exã¡
(
öode
, 
°¨t
, 
num_byãs
, 
øm_byãs
,

11154 
ös
.
obje˘id
, ins.
off£t
,

11155 
ícoded
->
u√ncoded_off£t
,

11156 (1 << 
BTRFS_ORDERED_ENCODED
) |

11157 (1 << 
BTRFS_ORDERED_COMPRESSED
),

11158 
com¥essi⁄
);

11159 i‡(
	`IS_ERR
(
‹dîed
)) {

11160 
	`båfs_dr›_exã¡_m≠_ønge
(
öode
, 
°¨t
, 
íd
, 
Ál£
);

11161 
ªt
 = 
	`PTR_ERR
(
‹dîed
);

11162 
out_‰ì_ª£rved
;

11164 
	`båfs_dec_block_group_ª£rv©i⁄s
(
fs_öfo
, 
ös
.
obje˘id
);

11166 i‡(
°¨t
 + 
ícoded
->
Àn
 > 
öode
->
vfs_öode
.
i_size
)

11167 
	`i_size_wrôe
(&
öode
->
vfs_öode
, 
°¨t
 + 
ícoded
->
Àn
);

11169 
	`u∆ock_exã¡
(
io_åì
, 
°¨t
, 
íd
, &
ˇched_°©e
);

11171 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
öode
, 
num_byãs
);

11173 
	`båfs_submô_com¥es£d_wrôe
(
‹dîed
, 
∑ges
, 
ƒ_∑ges
, 0, 
Ál£
);

11174 
ªt
 = 
‹ig_cou¡
;

11175 
out
;

11177 
out_‰ì_ª£rved
:

11178 
	`båfs_dec_block_group_ª£rv©i⁄s
(
fs_öfo
, 
ös
.
obje˘id
);

11179 
	`båfs_‰ì_ª£rved_exã¡
(
fs_öfo
, 
ös
.
obje˘id
, ins.
off£t
, 1);

11180 
out_dñÆloc_ªÀa£
:

11181 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
öode
, 
num_byãs
);

11182 
	`båfs_dñÆloc_ªÀa£_mëad©a
(
öode
, 
disk_num_byãs
, 
ªt
 < 0);

11183 
out_qgroup_‰ì_d©a
:

11184 i‡(
ªt
 < 0)

11185 
	`båfs_qgroup_‰ì_d©a
(
öode
, 
d©a_ª£rved
, 
°¨t
, 
num_byãs
, 
NULL
);

11186 
out_‰ì_d©a_•a˚
:

11191 i‡(!
exã¡_ª£rved
)

11192 
	`båfs_‰ì_ª£rved_d©a_•a˚_noquŸa
(
fs_öfo
, 
disk_num_byãs
);

11193 
out_u∆ock
:

11194 
	`u∆ock_exã¡
(
io_åì
, 
°¨t
, 
íd
, &
ˇched_°©e
);

11195 
out_∑ges
:

11196 
i
 = 0; i < 
ƒ_∑ges
; i++) {

11197 i‡(
∑ges
[
i
])

11198 
	`__‰ì_∑ge
(
∑ges
[
i
]);

11200 
	`kv‰ì
(
∑ges
);

11201 
out
:

11202 i‡(
ªt
 >= 0)

11203 
iocb
->
ki_pos
 +
ícoded
->
Àn
;

11204  
ªt
;

11205 
	}
}

11207 #ifde‡
CONFIG_SWAP


11213 
	$båfs_add_sw≠fûe_pö
(
öode
 *öode, *
±r
,

11214 
boﬁ
 
is_block_group
)

11216 
båfs_fs_öfo
 *
fs_öfo
 = 
	`BTRFS_I
(
öode
)->
roŸ
->fs_info;

11217 
båfs_sw≠fûe_pö
 *
•
, *
íåy
;

11218 
rb_node
 **
p
;

11219 
rb_node
 *
∑ª¡
 = 
NULL
;

11221 
•
 = 
	`kmÆloc
((*•), 
GFP_NOFS
);

11222 i‡(!
•
)

11223  -
ENOMEM
;

11224 
•
->
±r
 =Ötr;

11225 
•
->
öode
 = inode;

11226 
•
->
is_block_group
 = is_block_group;

11227 
•
->
bg_exã¡_cou¡
 = 1;

11229 
	`•ö_lock
(&
fs_öfo
->
sw≠fûe_pös_lock
);

11230 
p
 = &
fs_öfo
->
sw≠fûe_pös
.
rb_node
;

11231 *
p
) {

11232 
∑ª¡
 = *
p
;

11233 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
båfs_sw≠fûe_pö
, 
node
);

11234 i‡(
•
->
±r
 < 
íåy
->ptr ||

11235 (
•
->
±r
 =
íåy
->±∏&& sp->
öode
 <Éntry->inode)) {

11236 
p
 = &(*p)->
rb_À·
;

11237 } i‡(
•
->
±r
 > 
íåy
->ptr ||

11238 (
•
->
±r
 =
íåy
->±∏&& sp->
öode
 >Éntry->inode)) {

11239 
p
 = &(*p)->
rb_right
;

11241 i‡(
is_block_group
)

11242 
íåy
->
bg_exã¡_cou¡
++;

11243 
	`•ö_u∆ock
(&
fs_öfo
->
sw≠fûe_pös_lock
);

11244 
	`k‰ì
(
•
);

11248 
	`rb_lök_node
(&
•
->
node
, 
∑ª¡
, 
p
);

11249 
	`rb_ö£π_cﬁ‹
(&
•
->
node
, &
fs_öfo
->
sw≠fûe_pös
);

11250 
	`•ö_u∆ock
(&
fs_öfo
->
sw≠fûe_pös_lock
);

11252 
	}
}

11255 
	$båfs_‰ì_sw≠fûe_pös
(
öode
 *inode)

11257 
båfs_fs_öfo
 *
fs_öfo
 = 
	`BTRFS_I
(
öode
)->
roŸ
->fs_info;

11258 
båfs_sw≠fûe_pö
 *
•
;

11259 
rb_node
 *
node
, *
√xt
;

11261 
	`•ö_lock
(&
fs_öfo
->
sw≠fûe_pös_lock
);

11262 
node
 = 
	`rb_fú°
(&
fs_öfo
->
sw≠fûe_pös
);

11263 
node
) {

11264 
√xt
 = 
	`rb_√xt
(
node
);

11265 
•
 = 
	`rb_íåy
(
node
, 
båfs_sw≠fûe_pö
,Çode);

11266 i‡(
•
->
öode
 == inode) {

11267 
	`rb_îa£
(&
•
->
node
, &
fs_öfo
->
sw≠fûe_pös
);

11268 i‡(
•
->
is_block_group
) {

11269 
	`båfs_dec_block_group_sw≠_exã¡s
(
•
->
±r
,

11270 
•
->
bg_exã¡_cou¡
);

11271 
	`båfs_put_block_group
(
•
->
±r
);

11273 
	`k‰ì
(
•
);

11275 
node
 = 
√xt
;

11277 
	`•ö_u∆ock
(&
fs_öfo
->
sw≠fûe_pös_lock
);

11278 
	}
}

11280 
	sbåfs_sw≠_öfo
 {

11281 
u64
 
	m°¨t
;

11282 
u64
 
	mblock_°¨t
;

11283 
u64
 
	mblock_Àn
;

11284 
u64
 
	mlowe°_µage
;

11285 
u64
 
	mhighe°_µage
;

11286 
	mƒ_∑ges
;

11287 
	mƒ_exã¡s
;

11290 
	$båfs_add_sw≠_exã¡
(
sw≠_öfo_°ru˘
 *
sis
,

11291 
båfs_sw≠_öfo
 *
bsi
)

11293 
ƒ_∑ges
;

11294 
max_∑ges
;

11295 
u64
 
fú°_µage
, 
fú°_µage_ªp‹ãd
, 
√xt_µage
;

11296 
ªt
;

11303 i‡(
bsi
->
ƒ_∑ges
 >
sis
->
max
)

11306 
max_∑ges
 = 
sis
->
max
 - 
bsi
->
ƒ_∑ges
;

11307 
fú°_µage
 = 
	`PAGE_ALIGN
(
bsi
->
block_°¨t
Ë>> 
PAGE_SHIFT
;

11308 
√xt_µage
 = 
	`PAGE_ALIGN_DOWN
(
bsi
->
block_°¨t
 + bsi->
block_Àn
Ë>> 
PAGE_SHIFT
;

11310 i‡(
fú°_µage
 >
√xt_µage
)

11312 
ƒ_∑ges
 = 
√xt_µage
 - 
fú°_µage
;

11313 
ƒ_∑ges
 = 
	`mö
“r_∑ges, 
max_∑ges
);

11315 
fú°_µage_ªp‹ãd
 = 
fú°_µage
;

11316 i‡(
bsi
->
°¨t
 == 0)

11317 
fú°_µage_ªp‹ãd
++;

11318 i‡(
bsi
->
lowe°_µage
 > 
fú°_µage_ªp‹ãd
)

11319 
bsi
->
lowe°_µage
 = 
fú°_µage_ªp‹ãd
;

11320 i‡(
bsi
->
highe°_µage
 < (
√xt_µage
 - 1))

11321 
bsi
->
highe°_µage
 = 
√xt_µage
 - 1;

11323 
ªt
 = 
	`add_sw≠_exã¡
(
sis
, 
bsi
->
ƒ_∑ges
,Çr_∑ges, 
fú°_µage
);

11324 i‡(
ªt
 < 0)

11325  
ªt
;

11326 
bsi
->
ƒ_exã¡s
 +
ªt
;

11327 
bsi
->
ƒ_∑ges
 +=Çr_pages;

11329 
	}
}

11331 
	$båfs_sw≠_dó˘iv©e
(
fûe
 *file)

11333 
öode
 *öodê
	`fûe_öode
(
fûe
);

11335 
	`båfs_‰ì_sw≠fûe_pös
(
öode
);

11336 
	`©omic_dec
(&
	`BTRFS_I
(
öode
)->
roŸ
->
ƒ_sw≠fûes
);

11337 
	}
}

11339 
	$båfs_sw≠_a˘iv©e
(
sw≠_öfo_°ru˘
 *
sis
, 
fûe
 *file,

11340 
£˘‹_t
 *
•™
)

11342 
öode
 *öodê
	`fûe_öode
(
fûe
);

11343 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

11344 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

11345 
exã¡_io_åì
 *
io_åì
 = &
	`BTRFS_I
(
öode
)->io_tree;

11346 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

11347 
exã¡_m≠
 *
em
 = 
NULL
;

11348 
båfs_devi˚
 *
devi˚
 = 
NULL
;

11349 
båfs_sw≠_öfo
 
bsi
 = {

11350 .
lowe°_µage
 = (
£˘‹_t
)-1ULL,

11352 
ªt
 = 0;

11353 
u64
 
isize
;

11354 
u64
 
°¨t
;

11361 
ªt
 = 
	`båfs_waô_‹dîed_ønge
(
öode
, 0, (
u64
)-1);

11362 i‡(
ªt
)

11363  
ªt
;

11368 i‡(
	`BTRFS_I
(
öode
)->
Êags
 & 
BTRFS_INODE_COMPRESS
) {

11369 
	`båfs_w¨n
(
fs_öfo
, "swapfile mustÇot be compressed");

11370  -
EINVAL
;

11372 i‡(!(
	`BTRFS_I
(
öode
)->
Êags
 & 
BTRFS_INODE_NODATACOW
)) {

11373 
	`båfs_w¨n
(
fs_öfo
, "swapfile mustÇot be copy-on-write");

11374  -
EINVAL
;

11376 i‡(!(
	`BTRFS_I
(
öode
)->
Êags
 & 
BTRFS_INODE_NODATASUM
)) {

11377 
	`båfs_w¨n
(
fs_öfo
, "swapfile mustÇot be checksummed");

11378  -
EINVAL
;

11390 i‡(!
	`båfs_ex˛›_°¨t
(
fs_öfo
, 
BTRFS_EXCLOP_SWAP_ACTIVATE
)) {

11391 
	`båfs_w¨n
(
fs_öfo
,

11393  -
EBUSY
;

11403 i‡(!
	`båfs_dªw_åy_wrôe_lock
(&
roŸ
->
¢≠shŸ_lock
)) {

11404 
	`båfs_ex˛›_föish
(
fs_öfo
);

11405 
	`båfs_w¨n
(
fs_öfo
,

11407  -
EINVAL
;

11419 
	`•ö_lock
(&
roŸ
->
roŸ_ôem_lock
);

11420 i‡(
	`båfs_roŸ_dód
(
roŸ
)) {

11421 
	`•ö_u∆ock
(&
roŸ
->
roŸ_ôem_lock
);

11423 
	`båfs_ex˛›_föish
(
fs_öfo
);

11424 
	`båfs_w¨n
(
fs_öfo
,

11426 
roŸ
->
roŸ_key
.
obje˘id
);

11427  -
EPERM
;

11429 
	`©omic_öc
(&
roŸ
->
ƒ_sw≠fûes
);

11430 
	`•ö_u∆ock
(&
roŸ
->
roŸ_ôem_lock
);

11432 
isize
 = 
	`ALIGN_DOWN
(
öode
->
i_size
, 
fs_öfo
->
£˘‹size
);

11434 
	`lock_exã¡
(
io_åì
, 0, 
isize
 - 1, &
ˇched_°©e
);

11435 
°¨t
 = 0;

11436 
°¨t
 < 
isize
) {

11437 
u64
 
logiˇl_block_°¨t
, 
physiˇl_block_°¨t
;

11438 
båfs_block_group
 *
bg
;

11439 
u64
 
Àn
 = 
isize
 - 
°¨t
;

11441 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
°¨t
, 
Àn
);

11442 i‡(
	`IS_ERR
(
em
)) {

11443 
ªt
 = 
	`PTR_ERR
(
em
);

11444 
out
;

11447 i‡(
em
->
block_°¨t
 =
EXTENT_MAP_HOLE
) {

11448 
	`båfs_w¨n
(
fs_öfo
, "swapfile mustÇot have holes");

11449 
ªt
 = -
EINVAL
;

11450 
out
;

11452 i‡(
em
->
block_°¨t
 =
EXTENT_MAP_INLINE
) {

11460 
	`båfs_w¨n
(
fs_öfo
, "swapfile mustÇot be inline");

11461 
ªt
 = -
EINVAL
;

11462 
out
;

11464 i‡(
	`ã°_bô
(
EXTENT_FLAG_COMPRESSED
, &
em
->
Êags
)) {

11465 
	`båfs_w¨n
(
fs_öfo
, "swapfile mustÇot be compressed");

11466 
ªt
 = -
EINVAL
;

11467 
out
;

11470 
logiˇl_block_°¨t
 = 
em
->
block_°¨t
 + (
°¨t
 -Ém->start);

11471 
Àn
 = 
	`mö
÷í, 
em
->À¿- (
°¨t
 -Ém->start));

11472 
	`‰ì_exã¡_m≠
(
em
);

11473 
em
 = 
NULL
;

11475 
ªt
 = 
	`ˇn_nocow_exã¡
(
öode
, 
°¨t
, &
Àn
, 
NULL
, NULL, NULL, 
Ál£
, 
åue
);

11476 i‡(
ªt
 < 0) {

11477 
out
;

11478 } i‡(
ªt
) {

11479 
ªt
 = 0;

11481 
	`båfs_w¨n
(
fs_öfo
,

11483 
ªt
 = -
EINVAL
;

11484 
out
;

11487 
em
 = 
	`båfs_gë_chunk_m≠
(
fs_öfo
, 
logiˇl_block_°¨t
, 
Àn
);

11488 i‡(
	`IS_ERR
(
em
)) {

11489 
ªt
 = 
	`PTR_ERR
(
em
);

11490 
out
;

11493 i‡(
em
->
m≠_lookup
->
ty≥
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) {

11494 
	`båfs_w¨n
(
fs_öfo
,

11496 
ªt
 = -
EINVAL
;

11497 
out
;

11500 i‡(
devi˚
 =
NULL
) {

11501 
devi˚
 = 
em
->
m≠_lookup
->
°rùes
[0].
dev
;

11502 
ªt
 = 
	`båfs_add_sw≠fûe_pö
(
öode
, 
devi˚
, 
Ál£
);

11503 i‡(
ªt
 == 1)

11504 
ªt
 = 0;

11505 i‡(
ªt
)

11506 
out
;

11507 } i‡(
devi˚
 !
em
->
m≠_lookup
->
°rùes
[0].
dev
) {

11508 
	`båfs_w¨n
(
fs_öfo
, "swapfile must be on one device");

11509 
ªt
 = -
EINVAL
;

11510 
out
;

11513 
physiˇl_block_°¨t
 = (
em
->
m≠_lookup
->
°rùes
[0].
physiˇl
 +

11514 (
logiˇl_block_°¨t
 - 
em
->
°¨t
));

11515 
Àn
 = 
	`mö
÷í, 
em
->À¿- (
logiˇl_block_°¨t
 -Ém->
°¨t
));

11516 
	`‰ì_exã¡_m≠
(
em
);

11517 
em
 = 
NULL
;

11519 
bg
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
logiˇl_block_°¨t
);

11520 i‡(!
bg
) {

11521 
	`båfs_w¨n
(
fs_öfo
,

11523 
ªt
 = -
EINVAL
;

11524 
out
;

11527 i‡(!
	`båfs_öc_block_group_sw≠_exã¡s
(
bg
)) {

11528 
	`båfs_w¨n
(
fs_öfo
,

11530 
bg
->
°¨t
,

11531 
	`©omic_ªad
(&
fs_öfo
->
s¸ubs_ru¬ög
) ?

11533 
	`båfs_put_block_group
(
bg
);

11534 
ªt
 = -
EINVAL
;

11535 
out
;

11538 
ªt
 = 
	`båfs_add_sw≠fûe_pö
(
öode
, 
bg
, 
åue
);

11539 i‡(
ªt
) {

11540 
	`båfs_put_block_group
(
bg
);

11541 i‡(
ªt
 == 1)

11542 
ªt
 = 0;

11544 
out
;

11547 i‡(
bsi
.
block_Àn
 &&

11548 
bsi
.
block_°¨t
 + bsi.
block_Àn
 =
physiˇl_block_°¨t
) {

11549 
bsi
.
block_Àn
 +
Àn
;

11551 i‡(
bsi
.
block_Àn
) {

11552 
ªt
 = 
	`båfs_add_sw≠_exã¡
(
sis
, &
bsi
);

11553 i‡(
ªt
)

11554 
out
;

11556 
bsi
.
°¨t
 = start;

11557 
bsi
.
block_°¨t
 = 
physiˇl_block_°¨t
;

11558 
bsi
.
block_Àn
 = 
Àn
;

11561 
°¨t
 +
Àn
;

11564 i‡(
bsi
.
block_Àn
)

11565 
ªt
 = 
	`båfs_add_sw≠_exã¡
(
sis
, &
bsi
);

11567 
out
:

11568 i‡(!
	`IS_ERR_OR_NULL
(
em
))

11569 
	`‰ì_exã¡_m≠
(
em
);

11571 
	`u∆ock_exã¡
(
io_åì
, 0, 
isize
 - 1, &
ˇched_°©e
);

11573 i‡(
ªt
)

11574 
	`båfs_sw≠_dó˘iv©e
(
fûe
);

11576 
	`båfs_dªw_wrôe_u∆ock
(&
roŸ
->
¢≠shŸ_lock
);

11578 
	`båfs_ex˛›_föish
(
fs_öfo
);

11580 i‡(
ªt
)

11581  
ªt
;

11583 i‡(
devi˚
)

11584 
sis
->
bdev
 = 
devi˚
->bdev;

11585 *
•™
 = 
bsi
.
highe°_µage
 - bsi.
lowe°_µage
 + 1;

11586 
sis
->
max
 = 
bsi
.
ƒ_∑ges
;

11587 
sis
->
∑ges
 = 
bsi
.
ƒ_∑ges
 - 1;

11588 
sis
->
highe°_bô
 = 
bsi
.
ƒ_∑ges
 - 1;

11589  
bsi
.
ƒ_exã¡s
;

11590 
	}
}

11592 
	$båfs_sw≠_dó˘iv©e
(
fûe
 *file)

11594 
	}
}

11596 
	$båfs_sw≠_a˘iv©e
(
sw≠_öfo_°ru˘
 *
sis
, 
fûe
 *file,

11597 
£˘‹_t
 *
•™
)

11599  -
EOPNOTSUPP
;

11600 
	}
}

11609 
	$båfs_upd©e_öode_byãs
(
båfs_öode
 *
öode
,

11610 c⁄° 
u64
 
add_byãs
,

11611 c⁄° 
u64
 
dñ_byãs
)

11613 i‡(
add_byãs
 =
dñ_byãs
)

11616 
	`•ö_lock
(&
öode
->
lock
);

11617 i‡(
dñ_byãs
 > 0)

11618 
	`öode_sub_byãs
(&
öode
->
vfs_öode
, 
dñ_byãs
);

11619 i‡(
add_byãs
 > 0)

11620 
	`öode_add_byãs
(&
öode
->
vfs_öode
, 
add_byãs
);

11621 
	`•ö_u∆ock
(&
öode
->
lock
);

11622 
	}
}

11638 
	$båfs_as£π_öode_ønge_˛ón
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
)

11640 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

11641 
båfs_‹dîed_exã¡
 *
‹dîed
;

11643 i‡(!
	`IS_ENABLED
(
CONFIG_BTRFS_ASSERT
))

11646 
‹dîed
 = 
	`båfs_lookup_fú°_‹dîed_ønge
(
öode
, 
°¨t
, 
íd
 + 1 - start);

11647 i‡(
‹dîed
) {

11648 
	`båfs_îr
(
roŸ
->
fs_öfo
,

11650 
°¨t
, 
íd
, 
	`båfs_öo
(
öode
), 
roŸ
->
roŸ_key
.
obje˘id
,

11651 
‹dîed
->
fûe_off£t
,

11652 
‹dîed
->
fûe_off£t
 + ordîed->
num_byãs
 - 1);

11653 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

11656 
	`ASSERT
(
‹dîed
 =
NULL
);

11657 
	}
}

11659 c⁄° 
öode_›î©i⁄s
 
	gbåfs_dú_öode_›î©i⁄s
 = {

11660 .
gë©å
 = 
båfs_gë©å
,

11661 .
	glookup
 = 
båfs_lookup_mfs
,

11662 .
	g¸óã
 = 
båfs_¸óã_mfs
,

11663 .
	gu∆ök
 = 
båfs_u∆ök
,

11664 .
	glök
 = 
båfs_lök
,

11665 .
	gmkdú
 = 
båfs_mkdú_mfs
,

11666 .
	grmdú
 = 
båfs_rmdú
,

11667 .
	gª«me
 = 
båfs_ª«me2
,

11668 .
	gsymlök
 = 
båfs_symlök
,

11669 .
	g£èâr
 = 
båfs_£èâr
,

11670 .
	gmknod
 = 
båfs_mknod
,

11671 .
	gli°x©å
 = 
båfs_li°x©å
,

11672 .
	g≥rmissi⁄
 = 
båfs_≥rmissi⁄
,

11673 .
	ggë_öode_a˛
 = 
båfs_gë_a˛
,

11674 .
	g£t_a˛
 = 
båfs_£t_a˛
,

11675 .
	gupd©e_time
 = 
båfs_upd©e_time
,

11676 .
	gtmpfûe
 = 
båfs_tmpfûe
,

11677 .
	gfûóâr_gë
 = 
båfs_fûóâr_gë
,

11678 .
	gfûóâr_£t
 = 
båfs_fûóâr_£t
,

11681 c⁄° 
fûe_›î©i⁄s
 
	gbåfs_dú_fûe_›î©i⁄s
 = {

11682 .
Œ£ek
 = 
båfs_dú_Œ£ek
,

11683 .
	gªad
 = 
gíîic_ªad_dú
,

11684 .
	gôî©e_sh¨ed
 = 
båfs_ªÆ_ªaddú
,

11685 .
	g›í
 = 
båfs_›ídú_mfs
,

11686 .
	gu∆ocked_io˘l
 = 
båfs_io˘l
,

11687 #ifde‡
CONFIG_COMPAT


11688 .
	gcom∑t_io˘l
 = 
båfs_com∑t_io˘l
,

11690 .
	gªÀa£
 = 
båfs_ªÀa£_fûe
,

11691 .
	gfsync
 = 
båfs_sync_fûe
,

11706 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gbåfs_a›s
 = {

11707 .
ªad_fﬁio
 = 
båfs_ªad_fﬁio
,

11708 .
	gwrôïages
 = 
båfs_wrôïages
,

11709 .
	gªadahód
 = 
båfs_ªadahód
,

11710 .
	gövÆid©e_fﬁio
 = 
båfs_övÆid©e_fﬁio
,

11711 .
	gªÀa£_fﬁio
 = 
båfs_ªÀa£_fﬁio
,

11712 .
	gmigøã_fﬁio
 = 
båfs_migøã_fﬁio
,

11713 .
	gdúty_fﬁio
 = 
fûem≠_dúty_fﬁio
,

11714 .
	gîr‹_ªmove_∑ge
 = 
gíîic_îr‹_ªmove_∑ge
,

11715 .
	gsw≠_a˘iv©e
 = 
båfs_sw≠_a˘iv©e
,

11716 .
	gsw≠_dó˘iv©e
 = 
båfs_sw≠_dó˘iv©e
,

11719 c⁄° 
öode_›î©i⁄s
 
	gbåfs_fûe_öode_›î©i⁄s
 = {

11720 .
gë©å
 = 
båfs_gë©å
,

11721 .
	g£èâr
 = 
båfs_£èâr
,

11722 .
	gli°x©å
 = 
båfs_li°x©å
,

11723 .
	g≥rmissi⁄
 = 
båfs_≥rmissi⁄
,

11724 .
	gfõm≠
 = 
båfs_fõm≠
,

11725 .
	ggë_öode_a˛
 = 
båfs_gë_a˛
,

11726 .
	g£t_a˛
 = 
båfs_£t_a˛
,

11727 .
	gupd©e_time
 = 
båfs_upd©e_time
,

11728 .
	gfûóâr_gë
 = 
båfs_fûóâr_gë
,

11729 .
	gfûóâr_£t
 = 
båfs_fûóâr_£t
,

11731 c⁄° 
öode_›î©i⁄s
 
	gbåfs_•ecül_öode_›î©i⁄s
 = {

11732 .
gë©å
 = 
båfs_gë©å
,

11733 .
	g£èâr
 = 
båfs_£èâr
,

11734 .
	g≥rmissi⁄
 = 
båfs_≥rmissi⁄
,

11735 .
	gli°x©å
 = 
båfs_li°x©å
,

11736 .
	ggë_öode_a˛
 = 
båfs_gë_a˛
,

11737 .
	g£t_a˛
 = 
båfs_£t_a˛
,

11738 .
	gupd©e_time
 = 
båfs_upd©e_time
,

11740 c⁄° 
öode_›î©i⁄s
 
	gbåfs_symlök_öode_›î©i⁄s
 = {

11741 .
gë_lök
 = 
∑ge_gë_lök
,

11742 .
	ggë©å
 = 
båfs_gë©å
,

11743 .
	g£èâr
 = 
båfs_£èâr
,

11744 .
	g≥rmissi⁄
 = 
båfs_≥rmissi⁄
,

11745 .
	gli°x©å
 = 
båfs_li°x©å
,

11746 .
	gupd©e_time
 = 
båfs_upd©e_time
,

11749 c⁄° 
díåy_›î©i⁄s
 
	gbåfs_díåy_›î©i⁄s
 = {

11750 .
d_dñëe
 = 
båfs_díåy_dñëe
,

	@ioctl.c

6 
	~<löux/kî√l.h
>

7 
	~<löux/bio.h
>

8 
	~<löux/fûe.h
>

9 
	~<löux/fs.h
>

10 
	~<löux/f¢Ÿify.h
>

11 
	~<löux/∑gem≠.h
>

12 
	~<löux/highmem.h
>

13 
	~<löux/time.h
>

14 
	~<löux/°rög.h
>

15 
	~<löux/backög-dev.h
>

16 
	~<löux/mou¡.h
>

17 
	~<löux/«mei.h
>

18 
	~<löux/wrôeback.h
>

19 
	~<löux/com∑t.h
>

20 
	~<löux/£curôy.h
>

21 
	~<löux/x©å.h
>

22 
	~<löux/mm.h
>

23 
	~<löux/¶ab.h
>

24 
	~<löux/blkdev.h
>

25 
	~<löux/uuid.h
>

26 
	~<löux/båfs.h
>

27 
	~<löux/uac˚ss.h
>

28 
	~<löux/ivîsi⁄.h
>

29 
	~<löux/fûóâr.h
>

30 
	~<löux/fsvîôy.h
>

31 
	~<löux/sched/xac˘.h
>

32 
	~"˘ªe.h
"

33 
	~"disk-io.h
"

34 
	~"exp‹t.h
"

35 
	~"å™ß˘i⁄.h
"

36 
	~"båfs_öode.h
"

37 
	~"¥öt-åì.h
"

38 
	~"vﬁumes.h
"

39 
	~"lockög.h
"

40 
	~"backªf.h
"

41 
	~"rcu-°rög.h
"

42 
	~"£nd.h
"

43 
	~"dev-ª∂a˚.h
"

44 
	~"¥›s.h
"

45 
	~"sysfs.h
"

46 
	~"qgroup.h
"

47 
	~"åì-log.h
"

48 
	~"com¥essi⁄.h
"

49 
	~"•a˚-öfo.h
"

50 
	~"dñÆloc-•a˚.h
"

51 
	~"block-group.h
"

52 
	~"sub∑ge.h
"

53 
	~"fs.h
"

54 
	~"ac˚ss‹s.h
"

55 
	~"exã¡-åì.h
"

56 
	~"roŸ-åì.h
"

57 
	~"de‰ag.h
"

58 
	~"dú-ôem.h
"

59 
	~"uuid-åì.h
"

60 
	~"io˘l.h
"

61 
	~"fûe.h
"

62 
	~"s¸ub.h
"

63 
	~"su≥r.h
"

65 #ifde‡
CONFIG_64BIT


71 
	sbåfs_io˘l_time•ec_32
 {

72 
__u64
 
	m£c
;

73 
__u32
 
	mn£c
;

74 } 
__©åibuã__
 ((
__∑cked__
));

76 
	sbåfs_io˘l_ª˚ived_subvﬁ_¨gs_32
 {

77 
	muuid
[
BTRFS_UUID_SIZE
];

78 
__u64
 
	m°ønsid
;

79 
__u64
 
	mπønsid
;

80 
båfs_io˘l_time•ec_32
 
	m°ime
;

81 
båfs_io˘l_time•ec_32
 
	mπime
;

82 
__u64
 
	mÊags
;

83 
__u64
 
	mª£rved
[16];

84 } 
__©åibuã__
 ((
__∑cked__
));

86 
	#BTRFS_IOC_SET_RECEIVED_SUBVOL_32
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 37, \

87 
båfs_io˘l_ª˚ived_subvﬁ_¨gs_32
)

	)

90 #i‡
deföed
(
CONFIG_64BIT
Ë&& deföed(
CONFIG_COMPAT
)

91 
	sbåfs_io˘l_£nd_¨gs_32
 {

92 
__s64
 
	m£nd_fd
;

93 
__u64
 
	m˛⁄e_sour˚s_cou¡
;

94 
com∑t_u±r_t
 
	m˛⁄e_sour˚s
;

95 
__u64
 
	m∑ª¡_roŸ
;

96 
__u64
 
	mÊags
;

97 
__u32
 
	mvîsi⁄
;

98 
__u8
 
	mª£rved
[28];

99 } 
__©åibuã__
 ((
__∑cked__
));

101 
	#BTRFS_IOC_SEND_32
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 38, \

102 
båfs_io˘l_£nd_¨gs_32
)

	)

104 
	sbåfs_io˘l_ícoded_io_¨gs_32
 {

105 
com∑t_u±r_t
 
	miov
;

106 
com∑t_ul⁄g_t
 
	miov˙t
;

107 
__s64
 
	moff£t
;

108 
__u64
 
	mÊags
;

109 
__u64
 
	mÀn
;

110 
__u64
 
	mu√ncoded_Àn
;

111 
__u64
 
	mu√ncoded_off£t
;

112 
__u32
 
	mcom¥essi⁄
;

113 
__u32
 
	mí¸y±i⁄
;

114 
__u8
 
	mª£rved
[64];

117 
	#BTRFS_IOC_ENCODED_READ_32
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 64, \

118 
båfs_io˘l_ícoded_io_¨gs_32
)

	)

119 
	#BTRFS_IOC_ENCODED_WRITE_32
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 64, \

120 
båfs_io˘l_ícoded_io_¨gs_32
)

	)

124 
	$båfs_mask_fsÊags_f‹_ty≥
(
öode
 *inode,

125 
Êags
)

127 i‡(
	`S_ISDIR
(
öode
->
i_mode
))

128  
Êags
;

129 i‡(
	`S_ISREG
(
öode
->
i_mode
))

130  
Êags
 & ~
FS_DIRSYNC_FL
;

132  
Êags
 & (
FS_NODUMP_FL
 | 
FS_NOATIME_FL
);

133 
	}
}

139 
	$båfs_öode_Êags_to_fsÊags
(
båfs_öode
 *
böode
)

141 
iÊags
 = 0;

142 
u32
 
Êags
 = 
böode
->flags;

143 
u32
 
ro_Êags
 = 
böode
->ro_flags;

145 i‡(
Êags
 & 
BTRFS_INODE_SYNC
)

146 
iÊags
 |
FS_SYNC_FL
;

147 i‡(
Êags
 & 
BTRFS_INODE_IMMUTABLE
)

148 
iÊags
 |
FS_IMMUTABLE_FL
;

149 i‡(
Êags
 & 
BTRFS_INODE_APPEND
)

150 
iÊags
 |
FS_APPEND_FL
;

151 i‡(
Êags
 & 
BTRFS_INODE_NODUMP
)

152 
iÊags
 |
FS_NODUMP_FL
;

153 i‡(
Êags
 & 
BTRFS_INODE_NOATIME
)

154 
iÊags
 |
FS_NOATIME_FL
;

155 i‡(
Êags
 & 
BTRFS_INODE_DIRSYNC
)

156 
iÊags
 |
FS_DIRSYNC_FL
;

157 i‡(
Êags
 & 
BTRFS_INODE_NODATACOW
)

158 
iÊags
 |
FS_NOCOW_FL
;

159 i‡(
ro_Êags
 & 
BTRFS_INODE_RO_VERITY
)

160 
iÊags
 |
FS_VERITY_FL
;

162 i‡(
Êags
 & 
BTRFS_INODE_NOCOMPRESS
)

163 
iÊags
 |
FS_NOCOMP_FL
;

164 i‡(
Êags
 & 
BTRFS_INODE_COMPRESS
)

165 
iÊags
 |
FS_COMPR_FL
;

167  
iÊags
;

168 
	}
}

173 
	$båfs_sync_öode_Êags_to_i_Êags
(
öode
 *inode)

175 
båfs_öode
 *
böode
 = 
	`BTRFS_I
(
öode
);

176 
√w_Ê
 = 0;

178 i‡(
böode
->
Êags
 & 
BTRFS_INODE_SYNC
)

179 
√w_Ê
 |
S_SYNC
;

180 i‡(
böode
->
Êags
 & 
BTRFS_INODE_IMMUTABLE
)

181 
√w_Ê
 |
S_IMMUTABLE
;

182 i‡(
böode
->
Êags
 & 
BTRFS_INODE_APPEND
)

183 
√w_Ê
 |
S_APPEND
;

184 i‡(
böode
->
Êags
 & 
BTRFS_INODE_NOATIME
)

185 
√w_Ê
 |
S_NOATIME
;

186 i‡(
böode
->
Êags
 & 
BTRFS_INODE_DIRSYNC
)

187 
√w_Ê
 |
S_DIRSYNC
;

188 i‡(
böode
->
ro_Êags
 & 
BTRFS_INODE_RO_VERITY
)

189 
√w_Ê
 |
S_VERITY
;

191 
	`£t_mask_bôs
(&
öode
->
i_Êags
,

192 
S_SYNC
 | 
S_APPEND
 | 
S_IMMUTABLE
 | 
S_NOATIME
 | 
S_DIRSYNC
 |

193 
S_VERITY
, 
√w_Ê
);

194 
	}
}

200 
	$check_fsÊags
(
ﬁd_Êags
, 
Êags
)

202 i‡(
Êags
 & ~(
FS_IMMUTABLE_FL
 | 
FS_APPEND_FL
 | \

203 
FS_NOATIME_FL
 | 
FS_NODUMP_FL
 | \

204 
FS_SYNC_FL
 | 
FS_DIRSYNC_FL
 | \

205 
FS_NOCOMP_FL
 | 
FS_COMPR_FL
 |

206 
FS_NOCOW_FL
))

207  -
EOPNOTSUPP
;

210 i‡((
Êags
 & 
FS_NOCOMP_FL
Ë&& (Êag†& 
FS_COMPR_FL
))

211  -
EINVAL
;

213 i‡((
Êags
 & 
FS_COMPR_FL
Ë&& (Êag†& 
FS_NOCOW_FL
))

214  -
EINVAL
;

217 i‡((
ﬁd_Êags
 & 
FS_NOCOW_FL
Ë&& (
Êags
 & (
FS_COMPR_FL
 | 
FS_NOCOMP_FL
)))

218  -
EINVAL
;

219 i‡((
Êags
 & 
FS_NOCOW_FL
Ë&& (
ﬁd_Êags
 & (
FS_COMPR_FL
 | 
FS_NOCOMP_FL
)))

220  -
EINVAL
;

223 
	}
}

225 
	$check_fsÊags_com∑tibÀ
(
båfs_fs_öfo
 *
fs_öfo
,

226 
Êags
)

228 i‡(
	`båfs_is_z⁄ed
(
fs_öfo
Ë&& (
Êags
 & 
FS_NOCOW_FL
))

229  -
EPERM
;

232 
	}
}

238 
	$båfs_fûóâr_gë
(
díåy
 *díåy, 
fûóâr
 *
Á
)

240 
	`¥ötk
(
KERN_INFO
 "btrfs_fileattr_get: Called...\n");

241 
båfs_öode
 *
böode
 = 
	`BTRFS_I
(
	`d_öode
(
díåy
));

243 
	`fûóâr_fûl_Êags
(
Á
, 
	`båfs_öode_Êags_to_fsÊags
(
böode
));

245 
	}
}

247 
	$båfs_fûóâr_£t
(
m¡_idm≠
 *
idm≠
,

248 
díåy
 *díåy, 
fûóâr
 *
Á
)

250 
	`¥ötk
(
KERN_INFO
 "btrfs_fileattr_set: Called...\n");

251 
öode
 *öodê
	`d_öode
(
díåy
);

252 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

253 
båfs_öode
 *
böode
 = 
	`BTRFS_I
(
öode
);

254 
båfs_roŸ
 *
roŸ
 = 
böode
->root;

255 
båfs_å™s_h™dÀ
 *
å™s
;

256 
fsÊags
, 
ﬁd_fsÊags
;

257 
ªt
;

258 c⁄° *
comp
 = 
NULL
;

259 
u32
 
böode_Êags
;

261 i‡(
	`båfs_roŸ_ªad⁄ly
(
roŸ
))

262  -
EROFS
;

264 i‡(
	`fûóâr_has_fsx
(
Á
))

265  -
EOPNOTSUPP
;

267 
fsÊags
 = 
	`båfs_mask_fsÊags_f‹_ty≥
(
öode
, 
Á
->
Êags
);

268 
ﬁd_fsÊags
 = 
	`båfs_öode_Êags_to_fsÊags
(
böode
);

269 
ªt
 = 
	`check_fsÊags
(
ﬁd_fsÊags
, 
fsÊags
);

270 i‡(
ªt
)

271  
ªt
;

273 
ªt
 = 
	`check_fsÊags_com∑tibÀ
(
fs_öfo
, 
fsÊags
);

274 i‡(
ªt
)

275  
ªt
;

277 
böode_Êags
 = 
böode
->
Êags
;

278 i‡(
fsÊags
 & 
FS_SYNC_FL
)

279 
böode_Êags
 |
BTRFS_INODE_SYNC
;

281 
böode_Êags
 &~
BTRFS_INODE_SYNC
;

282 i‡(
fsÊags
 & 
FS_IMMUTABLE_FL
)

283 
böode_Êags
 |
BTRFS_INODE_IMMUTABLE
;

285 
böode_Êags
 &~
BTRFS_INODE_IMMUTABLE
;

286 i‡(
fsÊags
 & 
FS_APPEND_FL
)

287 
böode_Êags
 |
BTRFS_INODE_APPEND
;

289 
böode_Êags
 &~
BTRFS_INODE_APPEND
;

290 i‡(
fsÊags
 & 
FS_NODUMP_FL
)

291 
böode_Êags
 |
BTRFS_INODE_NODUMP
;

293 
böode_Êags
 &~
BTRFS_INODE_NODUMP
;

294 i‡(
fsÊags
 & 
FS_NOATIME_FL
)

295 
böode_Êags
 |
BTRFS_INODE_NOATIME
;

297 
böode_Êags
 &~
BTRFS_INODE_NOATIME
;

300 i‡(!
Á
->
Êags_vÆid
) {

302 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 1);

303 i‡(
	`IS_ERR
(
å™s
))

304  
	`PTR_ERR
(
å™s
);

305 
upd©e_Êags
;

308 i‡(
fsÊags
 & 
FS_DIRSYNC_FL
)

309 
böode_Êags
 |
BTRFS_INODE_DIRSYNC
;

311 
böode_Êags
 &~
BTRFS_INODE_DIRSYNC
;

312 i‡(
fsÊags
 & 
FS_NOCOW_FL
) {

313 i‡(
	`S_ISREG
(
öode
->
i_mode
)) {

319 i‡(
öode
->
i_size
 == 0)

320 
böode_Êags
 |
BTRFS_INODE_NODATACOW
 |

321 
BTRFS_INODE_NODATASUM
;

323 
böode_Êags
 |
BTRFS_INODE_NODATACOW
;

329 i‡(
	`S_ISREG
(
öode
->
i_mode
)) {

330 i‡(
öode
->
i_size
 == 0)

331 
böode_Êags
 &~(
BTRFS_INODE_NODATACOW
 |

332 
BTRFS_INODE_NODATASUM
);

334 
böode_Êags
 &~
BTRFS_INODE_NODATACOW
;

343 i‡(
fsÊags
 & 
FS_NOCOMP_FL
) {

344 
böode_Êags
 &~
BTRFS_INODE_COMPRESS
;

345 
böode_Êags
 |
BTRFS_INODE_NOCOMPRESS
;

346 } i‡(
fsÊags
 & 
FS_COMPR_FL
) {

348 i‡(
	`IS_SWAPFILE
(
öode
))

349  -
ETXTBSY
;

351 
böode_Êags
 |
BTRFS_INODE_COMPRESS
;

352 
böode_Êags
 &~
BTRFS_INODE_NOCOMPRESS
;

354 
comp
 = 
	`båfs_com¥ess_ty≥2°r
(
fs_öfo
->
com¥ess_ty≥
);

355 i‡(!
comp
 || comp[0] == 0)

356 
comp
 = 
	`båfs_com¥ess_ty≥2°r
(
BTRFS_COMPRESS_ZLIB
);

358 
böode_Êags
 &~(
BTRFS_INODE_COMPRESS
 | 
BTRFS_INODE_NOCOMPRESS
);

365 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 3);

366 i‡(
	`IS_ERR
(
å™s
))

367  
	`PTR_ERR
(
å™s
);

369 i‡(
comp
) {

370 
ªt
 = 
	`båfs_£t_¥›
(
å™s
, 
öode
, "båfs.com¥essi⁄", 
comp
,

371 
	`°æí
(
comp
), 0);

372 i‡(
ªt
) {

373 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

374 
out_íd_å™s
;

377 
ªt
 = 
	`båfs_£t_¥›
(
å™s
, 
öode
, "båfs.com¥essi⁄", 
NULL
,

379 i‡(
ªt
 &&Ñë !-
ENODATA
) {

380 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

381 
out_íd_å™s
;

385 
upd©e_Êags
:

386 
böode
->
Êags
 = 
böode_Êags
;

387 
	`båfs_sync_öode_Êags_to_i_Êags
(
öode
);

388 
	`öode_öc_ivîsi⁄
(
öode
);

389 
	`öode_£t_˘ime_cuºít
(
öode
);

390 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

392 
out_íd_å™s
:

393 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

394  
ªt
;

395 
	}
}

400 
boﬁ
 
	$båfs_ex˛›_°¨t
(
båfs_fs_öfo
 *
fs_öfo
,

401 
båfs_ex˛usive_›î©i⁄
 
ty≥
)

403 
boﬁ
 
ªt
 = 
Ál£
;

405 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

406 i‡(
fs_öfo
->
ex˛usive_›î©i⁄
 =
BTRFS_EXCLOP_NONE
) {

407 
fs_öfo
->
ex˛usive_›î©i⁄
 = 
ty≥
;

408 
ªt
 = 
åue
;

410 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

412  
ªt
;

413 
	}
}

426 
boﬁ
 
	$båfs_ex˛›_°¨t_åy_lock
(
båfs_fs_öfo
 *
fs_öfo
,

427 
båfs_ex˛usive_›î©i⁄
 
ty≥
)

429 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

430 i‡(
fs_öfo
->
ex˛usive_›î©i⁄
 =
ty≥
 ||

431 (
fs_öfo
->
ex˛usive_›î©i⁄
 =
BTRFS_EXCLOP_BALANCE_PAUSED
 &&

432 
ty≥
 =
BTRFS_EXCLOP_DEV_ADD
))

433  
åue
;

435 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

436  
Ál£
;

437 
	}
}

439 
	$båfs_ex˛›_°¨t_u∆ock
(
båfs_fs_öfo
 *
fs_öfo
)

441 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

442 
	}
}

444 
	$båfs_ex˛›_föish
(
båfs_fs_öfo
 *
fs_öfo
)

446 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

447 
	`WRITE_ONCE
(
fs_öfo
->
ex˛usive_›î©i⁄
, 
BTRFS_EXCLOP_NONE
);

448 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

449 
	`sysfs_nŸify
(&
fs_öfo
->
fs_devi˚s
->
fsid_kobj
, 
NULL
, "exclusive_operation");

450 
	}
}

452 
	$båfs_ex˛›_bÆ™˚
(
båfs_fs_öfo
 *
fs_öfo
,

453 
båfs_ex˛usive_›î©i⁄
 
›
)

455 
›
) {

456 
BTRFS_EXCLOP_BALANCE_PAUSED
:

457 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

458 
	`ASSERT
(
fs_öfo
->
ex˛usive_›î©i⁄
 =
BTRFS_EXCLOP_BALANCE
 ||

459 
fs_öfo
->
ex˛usive_›î©i⁄
 =
BTRFS_EXCLOP_DEV_ADD
 ||

460 
fs_öfo
->
ex˛usive_›î©i⁄
 =
BTRFS_EXCLOP_NONE
 ||

461 
fs_öfo
->
ex˛usive_›î©i⁄
 =
BTRFS_EXCLOP_BALANCE_PAUSED
);

462 
fs_öfo
->
ex˛usive_›î©i⁄
 = 
BTRFS_EXCLOP_BALANCE_PAUSED
;

463 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

465 
BTRFS_EXCLOP_BALANCE
:

466 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

467 
	`ASSERT
(
fs_öfo
->
ex˛usive_›î©i⁄
 =
BTRFS_EXCLOP_BALANCE_PAUSED
);

468 
fs_öfo
->
ex˛usive_›î©i⁄
 = 
BTRFS_EXCLOP_BALANCE
;

469 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

472 
	`båfs_w¨n
(
fs_öfo
,

473 "övÆidÉx˛› bÆ™˚ o≥øti⁄ %dÑeque°ed", 
›
);

475 
	}
}

477 
	$båfs_io˘l_gëvîsi⁄
(
öode
 *öode, 
__u£r
 *
¨g
)

479  
	`put_u£r
(
öode
->
i_gíî©i⁄
, 
¨g
);

480 
	}
}

482 
noölöe
 
	$båfs_io˘l_fôrim
(
båfs_fs_öfo
 *
fs_öfo
,

483 
__u£r
 *
¨g
)

485 
båfs_devi˚
 *
devi˚
;

486 
f°rim_ønge
 
ønge
;

487 
u64
 
möÀn
 = 
ULLONG_MAX
;

488 
u64
 
num_devi˚s
 = 0;

489 
ªt
;

491 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

492  -
EPERM
;

499 i‡(
	`båfs_is_z⁄ed
(
fs_öfo
))

500  -
EOPNOTSUPP
;

509 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
NOLOGREPLAY
))

510  -
EROFS
;

512 
	`rcu_ªad_lock
();

513 
	`li°_f‹_óch_íåy_rcu
(
devi˚
, &
fs_öfo
->
fs_devi˚s
->
devi˚s
,

514 
dev_li°
) {

515 i‡(!
devi˚
->
bdev
 || !
	`bdev_max_disˇrd_£˘‹s
(device->bdev))

517 
num_devi˚s
++;

518 
möÀn
 = 
	`mö_t
(
u64
, 
	`bdev_disˇrd_gønuœrôy
(
devi˚
->
bdev
),

519 
möÀn
);

521 
	`rcu_ªad_u∆ock
();

523 i‡(!
num_devi˚s
)

524  -
EOPNOTSUPP
;

525 i‡(
	`c›y_‰om_u£r
(&
ønge
, 
¨g
, (range)))

526  -
EFAULT
;

533 i‡(
ønge
.
Àn
 < 
fs_öfo
->
sb
->
s_blocksize
)

534  -
EINVAL
;

536 
ønge
.
möÀn
 = 
	`max
(range.minlen, minlen);

537 
ªt
 = 
	`båfs_åim_fs
(
fs_öfo
, &
ønge
);

538 i‡(
ªt
 < 0)

539  
ªt
;

541 i‡(
	`c›y_to_u£r
(
¨g
, &
ønge
, (range)))

542  -
EFAULT
;

545 
	}
}

547 
__puª
 
	$båfs_is_em±y_uuid
(
u8
 *
uuid
)

549 
i
;

551 
i
 = 0; i < 
BTRFS_UUID_SIZE
; i++) {

552 i‡(
uuid
[
i
])

556 
	}
}

562 
	$¸óã_subvﬁ_num_ôems
(
båfs_qgroup_öhîô
 *
öhîô
)

576 
num_ôems
 = 7;

578 i‡(
öhîô
) {

580 
num_ôems
 +2 * 
öhîô
->
num_qgroups
;

582  
num_ôems
;

583 
	}
}

585 
noölöe
 
	$¸óã_subvﬁ
(
m¡_idm≠
 *
idm≠
,

586 
öode
 *
dú
, 
díåy
 *dentry,

587 
båfs_qgroup_öhîô
 *
öhîô
)

589 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
dú
->
i_sb
);

590 
båfs_å™s_h™dÀ
 *
å™s
;

591 
båfs_key
 
key
;

592 
båfs_roŸ_ôem
 *
roŸ_ôem
;

593 
båfs_öode_ôem
 *
öode_ôem
;

594 
exã¡_buf„r
 *
Àaf
;

595 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
dú
)->root;

596 
båfs_roŸ
 *
√w_roŸ
;

597 
båfs_block_rsv
 
block_rsv
;

598 
time•ec64
 
cur_time
 = 
	`cuºít_time
(
dú
);

599 
båfs_√w_öode_¨gs
 
√w_öode_¨gs
 = {

600 .
dú
 = dir,

601 .
díåy
 = dentry,

602 .
subvﬁ
 = 
åue
,

604 
å™s_num_ôems
;

605 
ªt
;

606 
dev_t
 
™⁄_dev
;

607 
u64
 
obje˘id
;

609 
roŸ_ôem
 = 
	`kzÆloc
((*roŸ_ôem), 
GFP_KERNEL
);

610 i‡(!
roŸ_ôem
)

611  -
ENOMEM
;

613 
ªt
 = 
	`båfs_gë_‰ì_obje˘id
(
fs_öfo
->
åì_roŸ
, &
obje˘id
);

614 i‡(
ªt
)

615 
out_roŸ_ôem
;

621 i‡(
	`båfs_qgroup_Àvñ
(
obje˘id
)) {

622 
ªt
 = -
ENOSPC
;

623 
out_roŸ_ôem
;

626 
ªt
 = 
	`gë_™⁄_bdev
(&
™⁄_dev
);

627 i‡(
ªt
 < 0)

628 
out_roŸ_ôem
;

630 
√w_öode_¨gs
.
öode
 = 
	`båfs_√w_subvﬁ_öode
(
idm≠
, 
dú
);

631 i‡(!
√w_öode_¨gs
.
öode
) {

632 
ªt
 = -
ENOMEM
;

633 
out_™⁄_dev
;

635 
ªt
 = 
	`båfs_√w_öode_¥ï¨e
(&
√w_öode_¨gs
, &
å™s_num_ôems
);

636 i‡(
ªt
)

637 
out_öode
;

638 
å™s_num_ôems
 +
	`¸óã_subvﬁ_num_ôems
(
öhîô
);

640 
	`båfs_öô_block_rsv
(&
block_rsv
, 
BTRFS_BLOCK_RSV_TEMP
);

641 
ªt
 = 
	`båfs_subvﬁume_ª£rve_mëad©a
(
roŸ
, &
block_rsv
,

642 
å™s_num_ôems
, 
Ál£
);

643 i‡(
ªt
)

644 
out_√w_öode_¨gs
;

646 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

647 i‡(
	`IS_ERR
(
å™s
)) {

648 
ªt
 = 
	`PTR_ERR
(
å™s
);

649 
	`båfs_subvﬁume_ªÀa£_mëad©a
(
roŸ
, &
block_rsv
);

650 
out_√w_öode_¨gs
;

652 
å™s
->
block_rsv
 = &block_rsv;

653 
å™s
->
byãs_ª£rved
 = 
block_rsv
.
size
;

655 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

657 
ªt
 = 
	`båfs_qgroup_öhîô
(
å™s
, 0, 
obje˘id
, 
öhîô
);

658 i‡(
ªt
)

659 
out
;

661 
Àaf
 = 
	`båfs_Æloc_åì_block
(
å™s
, 
roŸ
, 0, 
obje˘id
, 
NULL
, 0, 0, 0,

662 
BTRFS_NESTING_NORMAL
);

663 i‡(
	`IS_ERR
(
Àaf
)) {

664 
ªt
 = 
	`PTR_ERR
(
Àaf
);

665 
out
;

668 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

670 
öode_ôem
 = &
roŸ_ôem
->
öode
;

671 
	`båfs_£t_°ack_öode_gíî©i⁄
(
öode_ôem
, 1);

672 
	`båfs_£t_°ack_öode_size
(
öode_ôem
, 3);

673 
	`båfs_£t_°ack_öode_∆ök
(
öode_ôem
, 1);

674 
	`båfs_£t_°ack_öode_nbyãs
(
öode_ôem
,

675 
fs_öfo
->
nodesize
);

676 
	`båfs_£t_°ack_öode_mode
(
öode_ôem
, 
S_IFDIR
 | 0755);

678 
	`båfs_£t_roŸ_Êags
(
roŸ_ôem
, 0);

679 
	`båfs_£t_roŸ_limô
(
roŸ_ôem
, 0);

680 
	`båfs_£t_°ack_öode_Êags
(
öode_ôem
, 
BTRFS_INODE_ROOT_ITEM_INIT
);

682 
	`båfs_£t_roŸ_byãƒ
(
roŸ_ôem
, 
Àaf
->
°¨t
);

683 
	`båfs_£t_roŸ_gíî©i⁄
(
roŸ_ôem
, 
å™s
->
å™sid
);

684 
	`båfs_£t_roŸ_Àvñ
(
roŸ_ôem
, 0);

685 
	`båfs_£t_roŸ_ªfs
(
roŸ_ôem
, 1);

686 
	`båfs_£t_roŸ_u£d
(
roŸ_ôem
, 
Àaf
->
Àn
);

687 
	`båfs_£t_roŸ_œ°_¢≠shŸ
(
roŸ_ôem
, 0);

689 
	`båfs_£t_roŸ_gíî©i⁄_v2
(
roŸ_ôem
,

690 
	`båfs_roŸ_gíî©i⁄
(
roŸ_ôem
));

691 
	`gíî©e_øndom_guid
(
roŸ_ôem
->
uuid
);

692 
	`båfs_£t_°ack_time•ec_£c
(&
roŸ_ôem
->
Ÿime
, 
cur_time
.
tv_£c
);

693 
	`båfs_£t_°ack_time•ec_n£c
(&
roŸ_ôem
->
Ÿime
, 
cur_time
.
tv_n£c
);

694 
roŸ_ôem
->
˘ime
 =ÑoŸ_ôem->
Ÿime
;

695 
	`båfs_£t_roŸ_˘ønsid
(
roŸ_ôem
, 
å™s
->
å™sid
);

696 
	`båfs_£t_roŸ_Ÿønsid
(
roŸ_ôem
, 
å™s
->
å™sid
);

698 
	`båfs_åì_u∆ock
(
Àaf
);

700 
	`båfs_£t_roŸ_dúid
(
roŸ_ôem
, 
BTRFS_FIRST_FREE_OBJECTID
);

702 
key
.
obje˘id
 = objectid;

703 
key
.
off£t
 = 0;

704 
key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

705 
ªt
 = 
	`båfs_ö£π_roŸ
(
å™s
, 
fs_öfo
->
åì_roŸ
, &
key
,

706 
roŸ_ôem
);

707 i‡(
ªt
) {

715 
	`båfs_åì_lock
(
Àaf
);

716 
	`båfs_˛ór_buf„r_dúty
(
å™s
, 
Àaf
);

717 
	`båfs_åì_u∆ock
(
Àaf
);

718 
	`båfs_‰ì_åì_block
(
å™s
, 
obje˘id
, 
Àaf
, 0, 1);

719 
	`‰ì_exã¡_buf„r
(
Àaf
);

720 
out
;

723 
	`‰ì_exã¡_buf„r
(
Àaf
);

724 
Àaf
 = 
NULL
;

726 
√w_roŸ
 = 
	`båfs_gë_√w_fs_roŸ
(
fs_öfo
, 
obje˘id
, 
™⁄_dev
);

727 i‡(
	`IS_ERR
(
√w_roŸ
)) {

728 
ªt
 = 
	`PTR_ERR
(
√w_roŸ
);

729 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

730 
out
;

733 
™⁄_dev
 = 0;

734 
	`BTRFS_I
(
√w_öode_¨gs
.
öode
)->
roŸ
 = 
√w_roŸ
;

737 
ªt
 = 
	`båfs_ªc‹d_roŸ_ö_å™s
(
å™s
, 
√w_roŸ
);

738 i‡(
ªt
) {

739 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

740 
out
;

743 
ªt
 = 
	`båfs_uuid_åì_add
(
å™s
, 
roŸ_ôem
->
uuid
,

744 
BTRFS_UUID_KEY_SUBVOL
, 
obje˘id
);

745 i‡(
ªt
) {

746 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

747 
out
;

750 
ªt
 = 
	`båfs_¸óã_√w_öode
(
å™s
, &
√w_öode_¨gs
);

751 i‡(
ªt
) {

752 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

753 
out
;

756 
	`d_ö°™tüã_√w
(
díåy
, 
√w_öode_¨gs
.
öode
);

757 
√w_öode_¨gs
.
öode
 = 
NULL
;

759 
out
:

760 
å™s
->
block_rsv
 = 
NULL
;

761 
å™s
->
byãs_ª£rved
 = 0;

762 
	`båfs_subvﬁume_ªÀa£_mëad©a
(
roŸ
, &
block_rsv
);

764 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

765 
out_√w_öode_¨gs
:

766 
	`båfs_√w_öode_¨gs_de°roy
(&
√w_öode_¨gs
);

767 
out_öode
:

768 
	`ùut
(
√w_öode_¨gs
.
öode
);

769 
out_™⁄_dev
:

770 i‡(
™⁄_dev
)

771 
	`‰ì_™⁄_bdev
(
™⁄_dev
);

772 
out_roŸ_ôem
:

773 
	`k‰ì
(
roŸ_ôem
);

774  
ªt
;

775 
	}
}

777 
	$¸óã_¢≠shŸ
(
båfs_roŸ
 *
roŸ
, 
öode
 *
dú
,

778 
díåy
 *díåy, 
boﬁ
 
ªad⁄ly
,

779 
båfs_qgroup_öhîô
 *
öhîô
)

781 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
dú
->
i_sb
);

782 
öode
 *inode;

783 
båfs_≥ndög_¢≠shŸ
 *
≥ndög_¢≠shŸ
;

784 
å™s_num_ôems
;

785 
båfs_å™s_h™dÀ
 *
å™s
;

786 
ªt
;

789 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
EXTENT_TREE_V2
)) {

790 
	`båfs_w¨n
(
fs_öfo
,

792  -
EOPNOTSUPP
;

795 i‡(!
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
))

796  -
EINVAL
;

798 i‡(
	`©omic_ªad
(&
roŸ
->
ƒ_sw≠fûes
)) {

799 
	`båfs_w¨n
(
fs_öfo
,

801  -
ETXTBSY
;

804 
≥ndög_¢≠shŸ
 = 
	`kzÆloc
((*≥ndög_¢≠shŸ), 
GFP_KERNEL
);

805 i‡(!
≥ndög_¢≠shŸ
)

806  -
ENOMEM
;

808 
ªt
 = 
	`gë_™⁄_bdev
(&
≥ndög_¢≠shŸ
->
™⁄_dev
);

809 i‡(
ªt
 < 0)

810 
‰ì_≥ndög
;

811 
≥ndög_¢≠shŸ
->
roŸ_ôem
 = 
	`kzÆloc
((
båfs_roŸ_ôem
),

812 
GFP_KERNEL
);

813 
≥ndög_¢≠shŸ
->
∑th
 = 
	`båfs_Æloc_∑th
();

814 i‡(!
≥ndög_¢≠shŸ
->
roŸ_ôem
 || !≥ndög_¢≠shŸ->
∑th
) {

815 
ªt
 = -
ENOMEM
;

816 
‰ì_≥ndög
;

819 
	`båfs_öô_block_rsv
(&
≥ndög_¢≠shŸ
->
block_rsv
,

820 
BTRFS_BLOCK_RSV_TEMP
);

826 
å™s_num_ôems
 = 
	`¸óã_subvﬁ_num_ôems
(
öhîô
) + 3;

827 
ªt
 = 
	`båfs_subvﬁume_ª£rve_mëad©a
(
	`BTRFS_I
(
dú
)->
roŸ
,

828 &
≥ndög_¢≠shŸ
->
block_rsv
,

829 
å™s_num_ôems
, 
Ál£
);

830 i‡(
ªt
)

831 
‰ì_≥ndög
;

833 
≥ndög_¢≠shŸ
->
díåy
 = dentry;

834 
≥ndög_¢≠shŸ
->
roŸ
 =Ñoot;

835 
≥ndög_¢≠shŸ
->
ªad⁄ly
 =Ñeadonly;

836 
≥ndög_¢≠shŸ
->
dú
 = dir;

837 
≥ndög_¢≠shŸ
->
öhîô
 = inherit;

839 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

840 i‡(
	`IS_ERR
(
å™s
)) {

841 
ªt
 = 
	`PTR_ERR
(
å™s
);

842 
Áû
;

845 
å™s
->
≥ndög_¢≠shŸ
 =Öending_snapshot;

847 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

848 i‡(
ªt
)

849 
Áû
;

851 
ªt
 = 
≥ndög_¢≠shŸ
->
îr‹
;

852 i‡(
ªt
)

853 
Áû
;

855 
ªt
 = 
	`båfs_‹ph™_˛ónup
(
≥ndög_¢≠shŸ
->
¢≠
);

856 i‡(
ªt
)

857 
Áû
;

859 
öode
 = 
	`båfs_lookup_díåy
(
	`d_öode
(
díåy
->
d_∑ª¡
), dentry);

860 i‡(
	`IS_ERR
(
öode
)) {

861 
ªt
 = 
	`PTR_ERR
(
öode
);

862 
Áû
;

865 
	`d_ö°™tüã
(
díåy
, 
öode
);

866 
ªt
 = 0;

867 
≥ndög_¢≠shŸ
->
™⁄_dev
 = 0;

868 
Áû
:

870 i‡(
ªt
 && 
≥ndög_¢≠shŸ
->
¢≠
)

871 
≥ndög_¢≠shŸ
->
¢≠
->
™⁄_dev
 = 0;

872 
	`båfs_put_roŸ
(
≥ndög_¢≠shŸ
->
¢≠
);

873 
	`båfs_subvﬁume_ªÀa£_mëad©a
(
roŸ
, &
≥ndög_¢≠shŸ
->
block_rsv
);

874 
‰ì_≥ndög
:

875 i‡(
≥ndög_¢≠shŸ
->
™⁄_dev
)

876 
	`‰ì_™⁄_bdev
(
≥ndög_¢≠shŸ
->
™⁄_dev
);

877 
	`k‰ì
(
≥ndög_¢≠shŸ
->
roŸ_ôem
);

878 
	`båfs_‰ì_∑th
(
≥ndög_¢≠shŸ
->
∑th
);

879 
	`k‰ì
(
≥ndög_¢≠shŸ
);

881  
ªt
;

882 
	}
}

904 
	$båfs_may_dñëe
(
m¡_idm≠
 *
idm≠
,

905 
öode
 *
dú
, 
díåy
 *
vi˘im
, 
isdú
)

907 
îr‹
;

909 i‡(
	`d_ªÆly_is_√g©ive
(
vi˘im
))

910  -
ENOENT
;

912 
	`BUG_ON
(
	`d_öode
(
vi˘im
->
d_∑ª¡
Ë!
dú
);

913 
	`audô_öode_chûd
(
dú
, 
vi˘im
, 
AUDIT_TYPE_CHILD_DELETE
);

915 
îr‹
 = 
	`öode_≥rmissi⁄
(
idm≠
, 
dú
, 
MAY_WRITE
 | 
MAY_EXEC
);

916 i‡(
îr‹
)

917  
îr‹
;

918 i‡(
	`IS_APPEND
(
dú
))

919  -
EPERM
;

920 i‡(
	`check_°icky
(
idm≠
, 
dú
, 
	`d_öode
(
vi˘im
)) ||

921 
	`IS_APPEND
(
	`d_öode
(
vi˘im
)Ë|| 
	`IS_IMMUTABLE
(d_inode(victim)) ||

922 
	`IS_SWAPFILE
(
	`d_öode
(
vi˘im
)))

923  -
EPERM
;

924 i‡(
isdú
) {

925 i‡(!
	`d_is_dú
(
vi˘im
))

926  -
ENOTDIR
;

927 i‡(
	`IS_ROOT
(
vi˘im
))

928  -
EBUSY
;

929 } i‡(
	`d_is_dú
(
vi˘im
))

930  -
EISDIR
;

931 i‡(
	`IS_DEADDIR
(
dú
))

932  -
ENOENT
;

933 i‡(
vi˘im
->
d_Êags
 & 
DCACHE_NFSFS_RENAMED
)

934  -
EBUSY
;

936 
	}
}

939 
ölöe
 
	$båfs_may_¸óã
(
m¡_idm≠
 *
idm≠
,

940 
öode
 *
dú
, 
díåy
 *
chûd
)

942 i‡(
	`d_ªÆly_is_posôive
(
chûd
))

943  -
EEXIST
;

944 i‡(
	`IS_DEADDIR
(
dú
))

945  -
ENOENT
;

946 i‡(!
	`fsuidgid_has_m≠pög
(
dú
->
i_sb
, 
idm≠
))

947  -
EOVERFLOW
;

948  
	`öode_≥rmissi⁄
(
idm≠
, 
dú
, 
MAY_WRITE
 | 
MAY_EXEC
);

949 
	}
}

956 
noölöe
 
	$båfs_mksubvﬁ
(c⁄° 
∑th
 *
∑ª¡
,

957 
m¡_idm≠
 *
idm≠
,

958 c⁄° *
«me
, 
«mñí
,

959 
båfs_roŸ
 *
¢≠_§c
,

960 
boﬁ
 
ªad⁄ly
,

961 
båfs_qgroup_öhîô
 *
öhîô
)

963 
öode
 *
dú
 = 
	`d_öode
(
∑ª¡
->
díåy
);

964 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
dú
->
i_sb
);

965 
díåy
 *dentry;

966 
fs¸y±_°r
 
«me_°r
 = 
	`FSTR_INIT
((*)
«me
, 
«mñí
);

967 
îr‹
;

969 
îr‹
 = 
	`down_wrôe_kûœbÀ_√°ed
(&
dú
->
i_rw£m
, 
I_MUTEX_PARENT
);

970 i‡(
îr‹
 =-
EINTR
)

971  
îr‹
;

973 
díåy
 = 
	`lookup_⁄e
(
idm≠
, 
«me
, 
∑ª¡
->díåy, 
«mñí
);

974 
îr‹
 = 
	`PTR_ERR
(
díåy
);

975 i‡(
	`IS_ERR
(
díåy
))

976 
out_u∆ock
;

978 
îr‹
 = 
	`båfs_may_¸óã
(
idm≠
, 
dú
, 
díåy
);

979 i‡(
îr‹
)

980 
out_dput
;

986 
îr‹
 = 
	`båfs_check_dú_ôem_cﬁlisi⁄
(
	`BTRFS_I
(
dú
)->
roŸ
,

987 
dú
->
i_öo
, &
«me_°r
);

988 i‡(
îr‹
)

989 
out_dput
;

991 
	`down_ªad
(&
fs_öfo
->
subvﬁ_£m
);

993 i‡(
	`båfs_roŸ_ªfs
(&
	`BTRFS_I
(
dú
)->
roŸ
->
roŸ_ôem
) == 0)

994 
out_up_ªad
;

996 i‡(
¢≠_§c
)

997 
îr‹
 = 
	`¸óã_¢≠shŸ
(
¢≠_§c
, 
dú
, 
díåy
, 
ªad⁄ly
, 
öhîô
);

999 
îr‹
 = 
	`¸óã_subvﬁ
(
idm≠
, 
dú
, 
díåy
, 
öhîô
);

1001 i‡(!
îr‹
)

1002 
	`f¢Ÿify_mkdú
(
dú
, 
díåy
);

1003 
out_up_ªad
:

1004 
	`up_ªad
(&
fs_öfo
->
subvﬁ_£m
);

1005 
out_dput
:

1006 
	`dput
(
díåy
);

1007 
out_u∆ock
:

1008 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
dú
), 0);

1009  
îr‹
;

1010 
	}
}

1012 
noölöe
 
	$båfs_mk¢≠shŸ
(c⁄° 
∑th
 *
∑ª¡
,

1013 
m¡_idm≠
 *
idm≠
,

1014 c⁄° *
«me
, 
«mñí
,

1015 
båfs_roŸ
 *
roŸ
,

1016 
boﬁ
 
ªad⁄ly
,

1017 
båfs_qgroup_öhîô
 *
öhîô
)

1019 
ªt
;

1020 
boﬁ
 
¢≠shŸ_f‹˚_cow
 = 
Ál£
;

1027 
	`båfs_dªw_ªad_lock
(&
roŸ
->
¢≠shŸ_lock
);

1029 
ªt
 = 
	`båfs_°¨t_dñÆloc_¢≠shŸ
(
roŸ
, 
Ál£
);

1030 i‡(
ªt
)

1031 
out
;

1038 
	`©omic_öc
(&
roŸ
->
¢≠shŸ_f‹˚_cow
);

1039 
¢≠shŸ_f‹˚_cow
 = 
åue
;

1041 
	`båfs_waô_‹dîed_exã¡s
(
roŸ
, 
U64_MAX
, 0, (
u64
)-1);

1043 
ªt
 = 
	`båfs_mksubvﬁ
(
∑ª¡
, 
idm≠
, 
«me
, 
«mñí
,

1044 
roŸ
, 
ªad⁄ly
, 
öhîô
);

1045 
out
:

1046 i‡(
¢≠shŸ_f‹˚_cow
)

1047 
	`©omic_dec
(&
roŸ
->
¢≠shŸ_f‹˚_cow
);

1048 
	`båfs_dªw_ªad_u∆ock
(&
roŸ
->
¢≠shŸ_lock
);

1049  
ªt
;

1050 
	}
}

1062 
	$ex˛›_°¨t_‹_ˇn˚l_ªloc
(
båfs_fs_öfo
 *
fs_öfo
,

1063 
båfs_ex˛usive_›î©i⁄
 
ty≥
, 
boﬁ
 
ˇn˚l
)

1065 i‡(!
ˇn˚l
) {

1067 i‡(!
	`båfs_ex˛›_°¨t
(
fs_öfo
, 
ty≥
))

1068  
BTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
;

1074 i‡(
	`båfs_ex˛›_°¨t_åy_lock
(
fs_öfo
, 
ty≥
)) {

1080 
	`©omic_öc
(&
fs_öfo
->
ªloc_ˇn˚l_ªq
);

1081 
	`båfs_ex˛›_°¨t_u∆ock
(
fs_öfo
);

1083 i‡(
	`ã°_bô
(
BTRFS_FS_RELOC_RUNNING
, &
fs_öfo
->
Êags
))

1084 
	`waô_⁄_bô
(&
fs_öfo
->
Êags
, 
BTRFS_FS_RELOC_RUNNING
,

1085 
TASK_INTERRUPTIBLE
);

1087  -
ECANCELED
;

1091  -
ENOTCONN
;

1092 
	}
}

1094 
noölöe
 
	$båfs_io˘l_ªsize
(
fûe
 *file,

1095 
__u£r
 *
¨g
)

1097 
	`BTRFS_DEV_LOOKUP_ARGS
(
¨gs
);

1098 
öode
 *öodê
	`fûe_öode
(
fûe
);

1099 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

1100 
u64
 
√w_size
;

1101 
u64
 
ﬁd_size
;

1102 
u64
 
devid
 = 1;

1103 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

1104 
båfs_io˘l_vﬁ_¨gs
 *
vﬁ_¨gs
;

1105 
båfs_å™s_h™dÀ
 *
å™s
;

1106 
båfs_devi˚
 *
devi˚
 = 
NULL
;

1107 *
size°r
;

1108 *
ªçå
;

1109 *
dev°r
 = 
NULL
;

1110 
ªt
 = 0;

1111 
mod
 = 0;

1112 
boﬁ
 
ˇn˚l
;

1114 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

1115  -
EPERM
;

1117 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

1118 i‡(
ªt
)

1119  
ªt
;

1125 
vﬁ_¨gs
 = 
	`memdup_u£r
(
¨g
, (*vol_args));

1126 i‡(
	`IS_ERR
(
vﬁ_¨gs
)) {

1127 
ªt
 = 
	`PTR_ERR
(
vﬁ_¨gs
);

1128 
out_dr›
;

1130 
vﬁ_¨gs
->
«me
[
BTRFS_PATH_NAME_MAX
] = '\0';

1131 
size°r
 = 
vﬁ_¨gs
->
«me
;

1132 
ˇn˚l
 = (
	`°rcmp
("ˇn˚l", 
size°r
) == 0);

1133 
ªt
 = 
	`ex˛›_°¨t_‹_ˇn˚l_ªloc
(
fs_öfo
, 
BTRFS_EXCLOP_RESIZE
, 
ˇn˚l
);

1134 i‡(
ªt
)

1135 
out_‰ì
;

1138 
dev°r
 = 
	`°rchr
(
size°r
, ':');

1139 i‡(
dev°r
) {

1140 
size°r
 = 
dev°r
 + 1;

1141 *
dev°r
 = '\0';

1142 
dev°r
 = 
vﬁ_¨gs
->
«me
;

1143 
ªt
 = 
	`k°πouŒ
(
dev°r
, 10, &
devid
);

1144 i‡(
ªt
)

1145 
out_föish
;

1146 i‡(!
devid
) {

1147 
ªt
 = -
EINVAL
;

1148 
out_föish
;

1150 
	`båfs_öfo
(
fs_öfo
, "ªsizög devid %Œu", 
devid
);

1153 
¨gs
.
devid
 = devid;

1154 
devi˚
 = 
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, &
¨gs
);

1155 i‡(!
devi˚
) {

1156 
	`båfs_öfo
(
fs_öfo
, "resizer unableÅo find device %llu",

1157 
devid
);

1158 
ªt
 = -
ENODEV
;

1159 
out_föish
;

1162 i‡(!
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
)) {

1163 
	`båfs_öfo
(
fs_öfo
,

1165 
devid
);

1166 
ªt
 = -
EPERM
;

1167 
out_föish
;

1170 i‡(!
	`°rcmp
(
size°r
, "max"))

1171 
√w_size
 = 
	`bdev_ƒ_byãs
(
devi˚
->
bdev
);

1173 i‡(
size°r
[0] == '-') {

1174 
mod
 = -1;

1175 
size°r
++;

1176 } i‡(
size°r
[0] == '+') {

1177 
mod
 = 1;

1178 
size°r
++;

1180 
√w_size
 = 
	`mem∑r£
(
size°r
, &
ªçå
);

1181 i‡(*
ªçå
 !'\0' || 
√w_size
 == 0) {

1182 
ªt
 = -
EINVAL
;

1183 
out_föish
;

1187 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
)) {

1188 
ªt
 = -
EPERM
;

1189 
out_föish
;

1192 
ﬁd_size
 = 
	`båfs_devi˚_gë_tŸÆ_byãs
(
devi˚
);

1194 i‡(
mod
 < 0) {

1195 i‡(
√w_size
 > 
ﬁd_size
) {

1196 
ªt
 = -
EINVAL
;

1197 
out_föish
;

1199 
√w_size
 = 
ﬁd_size
 -Çew_size;

1200 } i‡(
mod
 > 0) {

1201 i‡(
√w_size
 > 
ULLONG_MAX
 - 
ﬁd_size
) {

1202 
ªt
 = -
ERANGE
;

1203 
out_föish
;

1205 
√w_size
 = 
ﬁd_size
 +Çew_size;

1208 i‡(
√w_size
 < 
SZ_256M
) {

1209 
ªt
 = -
EINVAL
;

1210 
out_föish
;

1212 i‡(
√w_size
 > 
	`bdev_ƒ_byãs
(
devi˚
->
bdev
)) {

1213 
ªt
 = -
EFBIG
;

1214 
out_föish
;

1217 
√w_size
 = 
	`round_down
“ew_size, 
fs_öfo
->
£˘‹size
);

1219 i‡(
√w_size
 > 
ﬁd_size
) {

1220 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

1221 i‡(
	`IS_ERR
(
å™s
)) {

1222 
ªt
 = 
	`PTR_ERR
(
å™s
);

1223 
out_föish
;

1225 
ªt
 = 
	`båfs_grow_devi˚
(
å™s
, 
devi˚
, 
√w_size
);

1226 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

1227 } i‡(
√w_size
 < 
ﬁd_size
) {

1228 
ªt
 = 
	`båfs_shrök_devi˚
(
devi˚
, 
√w_size
);

1231 i‡(
ªt
 =0 && 
√w_size
 !
ﬁd_size
)

1232 
	`båfs_öfo_ö_rcu
(
fs_öfo
,

1234 
	`båfs_dev_«me
(
devi˚
), devi˚->
devid
,

1235 
ﬁd_size
, 
√w_size
);

1236 
out_föish
:

1237 
	`båfs_ex˛›_föish
(
fs_öfo
);

1238 
out_‰ì
:

1239 
	`k‰ì
(
vﬁ_¨gs
);

1240 
out_dr›
:

1241 
	`m¡_dr›_wrôe_fûe
(
fûe
);

1242  
ªt
;

1243 
	}
}

1245 
noölöe
 
	$__båfs_io˘l_¢≠_¸óã
(
fûe
 *file,

1246 
m¡_idm≠
 *
idm≠
,

1247 c⁄° *
«me
, 
fd
, 
subvﬁ
,

1248 
boﬁ
 
ªad⁄ly
,

1249 
båfs_qgroup_öhîô
 *
öhîô
)

1251 
«mñí
;

1252 
ªt
 = 0;

1254 i‡(!
	`S_ISDIR
(
	`fûe_öode
(
fûe
)->
i_mode
))

1255  -
ENOTDIR
;

1257 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

1258 i‡(
ªt
)

1259 
out
;

1261 
«mñí
 = 
	`°æí
(
«me
);

1262 i‡(
	`°rchr
(
«me
, '/')) {

1263 
ªt
 = -
EINVAL
;

1264 
out_dr›_wrôe
;

1267 i‡(
«me
[0] == '.' &&

1268 (
«mñí
 =1 || (
«me
[1] == '.' &&Çamelen == 2))) {

1269 
ªt
 = -
EEXIST
;

1270 
out_dr›_wrôe
;

1273 i‡(
subvﬁ
) {

1274 
ªt
 = 
	`båfs_mksubvﬁ
(&
fûe
->
f_∑th
, 
idm≠
, 
«me
,

1275 
«mñí
, 
NULL
, 
ªad⁄ly
, 
öhîô
);

1277 
fd
 
§c
 = 
	`fdgë
(fd);

1278 
öode
 *
§c_öode
;

1279 i‡(!
§c
.
fûe
) {

1280 
ªt
 = -
EINVAL
;

1281 
out_dr›_wrôe
;

1284 
§c_öode
 = 
	`fûe_öode
(
§c
.
fûe
);

1285 i‡(
§c_öode
->
i_sb
 !
	`fûe_öode
(
fûe
)->i_sb) {

1286 
	`båfs_öfo
(
	`BTRFS_I
(
	`fûe_öode
(
fûe
))->
roŸ
->
fs_öfo
,

1288 
ªt
 = -
EXDEV
;

1289 } i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
idm≠
, 
§c_öode
)) {

1294 
ªt
 = -
EPERM
;

1295 } i‡(
	`båfs_öo
(
	`BTRFS_I
(
§c_öode
)Ë!
BTRFS_FIRST_FREE_OBJECTID
) {

1303 
ªt
 = -
EINVAL
;

1305 
ªt
 = 
	`båfs_mk¢≠shŸ
(&
fûe
->
f_∑th
, 
idm≠
,

1306 
«me
, 
«mñí
,

1307 
	`BTRFS_I
(
§c_öode
)->
roŸ
,

1308 
ªad⁄ly
, 
öhîô
);

1310 
	`fdput
(
§c
);

1312 
out_dr›_wrôe
:

1313 
	`m¡_dr›_wrôe_fûe
(
fûe
);

1314 
out
:

1315  
ªt
;

1316 
	}
}

1318 
noölöe
 
	$båfs_io˘l_¢≠_¸óã
(
fûe
 *file,

1319 
__u£r
 *
¨g
, 
subvﬁ
)

1321 
båfs_io˘l_vﬁ_¨gs
 *
vﬁ_¨gs
;

1322 
ªt
;

1324 i‡(!
	`S_ISDIR
(
	`fûe_öode
(
fûe
)->
i_mode
))

1325  -
ENOTDIR
;

1327 
vﬁ_¨gs
 = 
	`memdup_u£r
(
¨g
, (*vol_args));

1328 i‡(
	`IS_ERR
(
vﬁ_¨gs
))

1329  
	`PTR_ERR
(
vﬁ_¨gs
);

1330 
vﬁ_¨gs
->
«me
[
BTRFS_PATH_NAME_MAX
] = '\0';

1332 
ªt
 = 
	`__båfs_io˘l_¢≠_¸óã
(
fûe
, 
	`fûe_m¡_idm≠
(file),

1333 
vﬁ_¨gs
->
«me
, vﬁ_¨gs->
fd
, 
subvﬁ
,

1334 
Ál£
, 
NULL
);

1336 
	`k‰ì
(
vﬁ_¨gs
);

1337  
ªt
;

1338 
	}
}

1340 
noölöe
 
	$båfs_io˘l_¢≠_¸óã_v2
(
fûe
 *file,

1341 
__u£r
 *
¨g
, 
subvﬁ
)

1343 
båfs_io˘l_vﬁ_¨gs_v2
 *
vﬁ_¨gs
;

1344 
ªt
;

1345 
boﬁ
 
ªad⁄ly
 = 
Ál£
;

1346 
båfs_qgroup_öhîô
 *
öhîô
 = 
NULL
;

1348 i‡(!
	`S_ISDIR
(
	`fûe_öode
(
fûe
)->
i_mode
))

1349  -
ENOTDIR
;

1351 
vﬁ_¨gs
 = 
	`memdup_u£r
(
¨g
, (*vol_args));

1352 i‡(
	`IS_ERR
(
vﬁ_¨gs
))

1353  
	`PTR_ERR
(
vﬁ_¨gs
);

1354 
vﬁ_¨gs
->
«me
[
BTRFS_SUBVOL_NAME_MAX
] = '\0';

1356 i‡(
vﬁ_¨gs
->
Êags
 & ~
BTRFS_SUBVOL_CREATE_ARGS_MASK
) {

1357 
ªt
 = -
EOPNOTSUPP
;

1358 
‰ì_¨gs
;

1361 i‡(
vﬁ_¨gs
->
Êags
 & 
BTRFS_SUBVOL_RDONLY
)

1362 
ªad⁄ly
 = 
åue
;

1363 i‡(
vﬁ_¨gs
->
Êags
 & 
BTRFS_SUBVOL_QGROUP_INHERIT
) {

1364 
u64
 
nums
;

1366 i‡(
vﬁ_¨gs
->
size
 < (*
öhîô
) ||

1367 
vﬁ_¨gs
->
size
 > 
PAGE_SIZE
) {

1368 
ªt
 = -
EINVAL
;

1369 
‰ì_¨gs
;

1371 
öhîô
 = 
	`memdup_u£r
(
vﬁ_¨gs
->
qgroup_öhîô
, vﬁ_¨gs->
size
);

1372 i‡(
	`IS_ERR
(
öhîô
)) {

1373 
ªt
 = 
	`PTR_ERR
(
öhîô
);

1374 
‰ì_¨gs
;

1377 i‡(
öhîô
->
num_qgroups
 > 
PAGE_SIZE
 ||

1378 
öhîô
->
num_ªf_c›õs
 > 
PAGE_SIZE
 ||

1379 
öhîô
->
num_ex˛_c›õs
 > 
PAGE_SIZE
) {

1380 
ªt
 = -
EINVAL
;

1381 
‰ì_öhîô
;

1384 
nums
 = 
öhîô
->
num_qgroups
 + 2 * inhîô->
num_ªf_c›õs
 +

1385 2 * 
öhîô
->
num_ex˛_c›õs
;

1386 i‡(
vﬁ_¨gs
->
size
 !
	`°ru˘_size
(
öhîô
, 
qgroups
, 
nums
)) {

1387 
ªt
 = -
EINVAL
;

1388 
‰ì_öhîô
;

1392 
ªt
 = 
	`__båfs_io˘l_¢≠_¸óã
(
fûe
, 
	`fûe_m¡_idm≠
(file),

1393 
vﬁ_¨gs
->
«me
, vﬁ_¨gs->
fd
, 
subvﬁ
,

1394 
ªad⁄ly
, 
öhîô
);

1395 i‡(
ªt
)

1396 
‰ì_öhîô
;

1397 
‰ì_öhîô
:

1398 
	`k‰ì
(
öhîô
);

1399 
‰ì_¨gs
:

1400 
	`k‰ì
(
vﬁ_¨gs
);

1401  
ªt
;

1402 
	}
}

1404 
noölöe
 
	$båfs_io˘l_subvﬁ_gëÊags
(
öode
 *inode,

1405 
__u£r
 *
¨g
)

1407 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

1408 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

1409 
ªt
 = 0;

1410 
u64
 
Êags
 = 0;

1412 i‡(
	`båfs_öo
(
	`BTRFS_I
(
öode
)Ë!
BTRFS_FIRST_FREE_OBJECTID
)

1413  -
EINVAL
;

1415 
	`down_ªad
(&
fs_öfo
->
subvﬁ_£m
);

1416 i‡(
	`båfs_roŸ_ªad⁄ly
(
roŸ
))

1417 
Êags
 |
BTRFS_SUBVOL_RDONLY
;

1418 
	`up_ªad
(&
fs_öfo
->
subvﬁ_£m
);

1420 i‡(
	`c›y_to_u£r
(
¨g
, &
Êags
, (flags)))

1421 
ªt
 = -
EFAULT
;

1423  
ªt
;

1424 
	}
}

1426 
noölöe
 
	$båfs_io˘l_subvﬁ_£tÊags
(
fûe
 *file,

1427 
__u£r
 *
¨g
)

1429 
öode
 *öodê
	`fûe_öode
(
fûe
);

1430 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

1431 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

1432 
båfs_å™s_h™dÀ
 *
å™s
;

1433 
u64
 
roŸ_Êags
;

1434 
u64
 
Êags
;

1435 
ªt
 = 0;

1437 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
	`fûe_m¡_idm≠
(
fûe
), 
öode
))

1438  -
EPERM
;

1440 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

1441 i‡(
ªt
)

1442 
out
;

1444 i‡(
	`båfs_öo
(
	`BTRFS_I
(
öode
)Ë!
BTRFS_FIRST_FREE_OBJECTID
) {

1445 
ªt
 = -
EINVAL
;

1446 
out_dr›_wrôe
;

1449 i‡(
	`c›y_‰om_u£r
(&
Êags
, 
¨g
, (flags))) {

1450 
ªt
 = -
EFAULT
;

1451 
out_dr›_wrôe
;

1454 i‡(
Êags
 & ~
BTRFS_SUBVOL_RDONLY
) {

1455 
ªt
 = -
EOPNOTSUPP
;

1456 
out_dr›_wrôe
;

1459 
	`down_wrôe
(&
fs_öfo
->
subvﬁ_£m
);

1462 i‡(!!(
Êags
 & 
BTRFS_SUBVOL_RDONLY
Ë=
	`båfs_roŸ_ªad⁄ly
(
roŸ
))

1463 
out_dr›_£m
;

1465 
roŸ_Êags
 = 
	`båfs_roŸ_Êags
(&
roŸ
->
roŸ_ôem
);

1466 i‡(
Êags
 & 
BTRFS_SUBVOL_RDONLY
) {

1467 
	`båfs_£t_roŸ_Êags
(&
roŸ
->
roŸ_ôem
,

1468 
roŸ_Êags
 | 
BTRFS_ROOT_SUBVOL_RDONLY
);

1474 
	`•ö_lock
(&
roŸ
->
roŸ_ôem_lock
);

1475 i‡(
roŸ
->
£nd_ö_¥ogªss
 == 0) {

1476 
	`båfs_£t_roŸ_Êags
(&
roŸ
->
roŸ_ôem
,

1477 
roŸ_Êags
 & ~
BTRFS_ROOT_SUBVOL_RDONLY
);

1478 
	`•ö_u∆ock
(&
roŸ
->
roŸ_ôem_lock
);

1480 
	`•ö_u∆ock
(&
roŸ
->
roŸ_ôem_lock
);

1481 
	`båfs_w¨n
(
fs_öfo
,

1483 
roŸ
->
roŸ_key
.
obje˘id
);

1484 
ªt
 = -
EPERM
;

1485 
out_dr›_£m
;

1489 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 1);

1490 i‡(
	`IS_ERR
(
å™s
)) {

1491 
ªt
 = 
	`PTR_ERR
(
å™s
);

1492 
out_ª£t
;

1495 
ªt
 = 
	`båfs_upd©e_roŸ
(
å™s
, 
fs_öfo
->
åì_roŸ
,

1496 &
roŸ
->
roŸ_key
, &roŸ->
roŸ_ôem
);

1497 i‡(
ªt
 < 0) {

1498 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1499 
out_ª£t
;

1502 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

1504 
out_ª£t
:

1505 i‡(
ªt
)

1506 
	`båfs_£t_roŸ_Êags
(&
roŸ
->
roŸ_ôem
, 
roŸ_Êags
);

1507 
out_dr›_£m
:

1508 
	`up_wrôe
(&
fs_öfo
->
subvﬁ_£m
);

1509 
out_dr›_wrôe
:

1510 
	`m¡_dr›_wrôe_fûe
(
fûe
);

1511 
out
:

1512  
ªt
;

1513 
	}
}

1515 
noölöe
 
	$key_ö_sk
(
båfs_key
 *
key
,

1516 
båfs_io˘l_£¨ch_key
 *
sk
)

1518 
båfs_key
 
ã°
;

1519 
ªt
;

1521 
ã°
.
obje˘id
 = 
sk
->
mö_obje˘id
;

1522 
ã°
.
ty≥
 = 
sk
->
mö_ty≥
;

1523 
ã°
.
off£t
 = 
sk
->
mö_off£t
;

1525 
ªt
 = 
	`båfs_comp_˝u_keys
(
key
, &
ã°
);

1526 i‡(
ªt
 < 0)

1529 
ã°
.
obje˘id
 = 
sk
->
max_obje˘id
;

1530 
ã°
.
ty≥
 = 
sk
->
max_ty≥
;

1531 
ã°
.
off£t
 = 
sk
->
max_off£t
;

1533 
ªt
 = 
	`båfs_comp_˝u_keys
(
key
, &
ã°
);

1534 i‡(
ªt
 > 0)

1537 
	}
}

1539 
noölöe
 
	$c›y_to_sk
(
båfs_∑th
 *
∑th
,

1540 
båfs_key
 *
key
,

1541 
båfs_io˘l_£¨ch_key
 *
sk
,

1542 
u64
 *
buf_size
,

1543 
__u£r
 *
ubuf
,

1544 *
sk_off£t
,

1545 *
num_found
)

1547 
u64
 
found_å™sid
;

1548 
exã¡_buf„r
 *
Àaf
;

1549 
båfs_io˘l_£¨ch_hódî
 
sh
;

1550 
båfs_key
 
ã°
;

1551 
ôem_off
;

1552 
ôem_Àn
;

1553 
ƒôems
;

1554 
i
;

1555 
¶Ÿ
;

1556 
ªt
 = 0;

1558 
Àaf
 = 
∑th
->
nodes
[0];

1559 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

1560 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

1562 i‡(
	`båfs_hódî_gíî©i⁄
(
Àaf
Ë> 
sk
->
max_å™sid
) {

1563 
i
 = 
ƒôems
;

1564 
adv™˚_key
;

1566 
found_å™sid
 = 
	`båfs_hódî_gíî©i⁄
(
Àaf
);

1568 
i
 = 
¶Ÿ
; i < 
ƒôems
; i++) {

1569 
ôem_off
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
i
);

1570 
ôem_Àn
 = 
	`båfs_ôem_size
(
Àaf
, 
i
);

1572 
	`båfs_ôem_key_to_˝u
(
Àaf
, 
key
, 
i
);

1573 i‡(!
	`key_ö_sk
(
key
, 
sk
))

1576 i‡((
sh
Ë+ 
ôem_Àn
 > *
buf_size
) {

1577 i‡(*
num_found
) {

1578 
ªt
 = 1;

1579 
out
;

1587 *
buf_size
 = (
sh
Ë+ 
ôem_Àn
;

1588 
ôem_Àn
 = 0;

1589 
ªt
 = -
EOVERFLOW
;

1592 i‡((
sh
Ë+ 
ôem_Àn
 + *
sk_off£t
 > *
buf_size
) {

1593 
ªt
 = 1;

1594 
out
;

1597 
sh
.
obje˘id
 = 
key
->objectid;

1598 
sh
.
off£t
 = 
key
->offset;

1599 
sh
.
ty≥
 = 
key
->type;

1600 
sh
.
Àn
 = 
ôem_Àn
;

1601 
sh
.
å™sid
 = 
found_å™sid
;

1609 i‡(
	`c›y_to_u£r_noÁu…
(
ubuf
 + *
sk_off£t
, &
sh
, (sh))) {

1610 
ªt
 = 0;

1611 
out
;

1614 *
sk_off£t
 +(
sh
);

1616 i‡(
ôem_Àn
) {

1617 
__u£r
 *
up
 = 
ubuf
 + *
sk_off£t
;

1622 i‡(
	`ªad_exã¡_buf„r_to_u£r_noÁu…
(
Àaf
, 
up
,

1623 
ôem_off
, 
ôem_Àn
)) {

1624 
ªt
 = 0;

1625 *
sk_off£t
 -(
sh
);

1626 
out
;

1629 *
sk_off£t
 +
ôem_Àn
;

1631 (*
num_found
)++;

1633 i‡(
ªt
)

1634 
out
;

1636 i‡(*
num_found
 >
sk
->
ƒ_ôems
) {

1637 
ªt
 = 1;

1638 
out
;

1641 
adv™˚_key
:

1642 
ªt
 = 0;

1643 
ã°
.
obje˘id
 = 
sk
->
max_obje˘id
;

1644 
ã°
.
ty≥
 = 
sk
->
max_ty≥
;

1645 
ã°
.
off£t
 = 
sk
->
max_off£t
;

1646 i‡(
	`båfs_comp_˝u_keys
(
key
, &
ã°
) >= 0)

1647 
ªt
 = 1;

1648 i‡(
key
->
off£t
 < (
u64
)-1)

1649 
key
->
off£t
++;

1650 i‡(
key
->
ty≥
 < (
u8
)-1) {

1651 
key
->
off£t
 = 0;

1652 
key
->
ty≥
++;

1653 } i‡(
key
->
obje˘id
 < (
u64
)-1) {

1654 
key
->
off£t
 = 0;

1655 
key
->
ty≥
 = 0;

1656 
key
->
obje˘id
++;

1658 
ªt
 = 1;

1659 
out
:

1669  
ªt
;

1670 
	}
}

1672 
noölöe
 
	$£¨ch_io˘l
(
öode
 *inode,

1673 
båfs_io˘l_£¨ch_key
 *
sk
,

1674 
u64
 *
buf_size
,

1675 
__u£r
 *
ubuf
)

1677 
båfs_fs_öfo
 *
öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

1678 
båfs_roŸ
 *
roŸ
;

1679 
båfs_key
 
key
;

1680 
båfs_∑th
 *
∑th
;

1681 
ªt
;

1682 
num_found
 = 0;

1683 
sk_off£t
 = 0;

1685 i‡(*
buf_size
 < (
båfs_io˘l_£¨ch_hódî
)) {

1686 *
buf_size
 = (
båfs_io˘l_£¨ch_hódî
);

1687  -
EOVERFLOW
;

1690 
∑th
 = 
	`båfs_Æloc_∑th
();

1691 i‡(!
∑th
)

1692  -
ENOMEM
;

1694 i‡(
sk
->
åì_id
 == 0) {

1696 
roŸ
 = 
	`båfs_gøb_roŸ
(
	`BTRFS_I
(
öode
)->root);

1698 
roŸ
 = 
	`båfs_gë_fs_roŸ
(
öfo
, 
sk
->
åì_id
, 
åue
);

1699 i‡(
	`IS_ERR
(
roŸ
)) {

1700 
	`båfs_‰ì_∑th
(
∑th
);

1701  
	`PTR_ERR
(
roŸ
);

1705 
key
.
obje˘id
 = 
sk
->
mö_obje˘id
;

1706 
key
.
ty≥
 = 
sk
->
mö_ty≥
;

1707 
key
.
off£t
 = 
sk
->
mö_off£t
;

1710 
ªt
 = -
EFAULT
;

1715 i‡(
	`Áu…_ö_sub∑ge_wrôóbÀ
(
ubuf
 + 
sk_off£t
,

1716 *
buf_size
 - 
sk_off£t
))

1719 
ªt
 = 
	`båfs_£¨ch_f‹w¨d
(
roŸ
, &
key
, 
∑th
, 
sk
->
mö_å™sid
);

1720 i‡(
ªt
 != 0) {

1721 i‡(
ªt
 > 0)

1722 
ªt
 = 0;

1723 
îr
;

1725 
ªt
 = 
	`c›y_to_sk
(
∑th
, &
key
, 
sk
, 
buf_size
, 
ubuf
,

1726 &
sk_off£t
, &
num_found
);

1727 
	`båfs_ªÀa£_∑th
(
∑th
);

1728 i‡(
ªt
)

1732 i‡(
ªt
 > 0)

1733 
ªt
 = 0;

1734 
îr
:

1735 
sk
->
ƒ_ôems
 = 
num_found
;

1736 
	`båfs_put_roŸ
(
roŸ
);

1737 
	`båfs_‰ì_∑th
(
∑th
);

1738  
ªt
;

1739 
	}
}

1741 
noölöe
 
	$båfs_io˘l_åì_£¨ch
(
öode
 *inode,

1742 
__u£r
 *
¨gp
)

1744 
båfs_io˘l_£¨ch_¨gs
 
__u£r
 *
u¨gs
 = 
¨gp
;

1745 
båfs_io˘l_£¨ch_key
 
sk
;

1746 
ªt
;

1747 
u64
 
buf_size
;

1749 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

1750  -
EPERM
;

1752 i‡(
	`c›y_‰om_u£r
(&
sk
, &
u¨gs
->
key
, (sk)))

1753  -
EFAULT
;

1755 
buf_size
 = (
u¨gs
->
buf
);

1757 
ªt
 = 
	`£¨ch_io˘l
(
öode
, &
sk
, &
buf_size
, 
u¨gs
->
buf
);

1763 i‡(
ªt
 =-
EOVERFLOW
)

1764 
ªt
 = 0;

1766 i‡(
ªt
 =0 && 
	`c›y_to_u£r
(&
u¨gs
->
key
, &
sk
, (sk)))

1767 
ªt
 = -
EFAULT
;

1768  
ªt
;

1769 
	}
}

1771 
noölöe
 
	$båfs_io˘l_åì_£¨ch_v2
(
öode
 *inode,

1772 
__u£r
 *
¨gp
)

1774 
båfs_io˘l_£¨ch_¨gs_v2
 
__u£r
 *
u¨g
 = 
¨gp
;

1775 
båfs_io˘l_£¨ch_¨gs_v2
 
¨gs
;

1776 
ªt
;

1777 
u64
 
buf_size
;

1778 c⁄° 
u64
 
buf_limô
 = 
SZ_16M
;

1780 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

1781  -
EPERM
;

1784 i‡(
	`c›y_‰om_u£r
(&
¨gs
, 
u¨g
, (args)))

1785  -
EFAULT
;

1787 
buf_size
 = 
¨gs
.buf_size;

1790 i‡(
buf_size
 > 
buf_limô
)

1791 
buf_size
 = 
buf_limô
;

1793 
ªt
 = 
	`£¨ch_io˘l
(
öode
, &
¨gs
.
key
, &
buf_size
,

1794 (
__u£r
 *)(&
u¨g
->
buf
[0]));

1795 i‡(
ªt
 =0 && 
	`c›y_to_u£r
(&
u¨g
->
key
, &
¨gs
.key, (args.key)))

1796 
ªt
 = -
EFAULT
;

1797 i‡(
ªt
 =-
EOVERFLOW
 &&

1798 
	`c›y_to_u£r
(&
u¨g
->
buf_size
, &buf_size, (buf_size)))

1799 
ªt
 = -
EFAULT
;

1801  
ªt
;

1802 
	}
}

1808 
noölöe
 
	$båfs_£¨ch_∑th_ö_åì
(
båfs_fs_öfo
 *
öfo
,

1809 
u64
 
åì_id
, u64 
dúid
, *
«me
)

1811 
båfs_roŸ
 *
roŸ
;

1812 
båfs_key
 
key
;

1813 *
±r
;

1814 
ªt
 = -1;

1815 
¶Ÿ
;

1816 
Àn
;

1817 
tŸÆ_Àn
 = 0;

1818 
båfs_öode_ªf
 *
úef
;

1819 
exã¡_buf„r
 *
l
;

1820 
båfs_∑th
 *
∑th
;

1822 i‡(
dúid
 =
BTRFS_FIRST_FREE_OBJECTID
) {

1823 
«me
[0]='\0';

1827 
∑th
 = 
	`båfs_Æloc_∑th
();

1828 i‡(!
∑th
)

1829  -
ENOMEM
;

1831 
±r
 = &
«me
[
BTRFS_INO_LOOKUP_PATH_MAX
 - 1];

1833 
roŸ
 = 
	`båfs_gë_fs_roŸ
(
öfo
, 
åì_id
, 
åue
);

1834 i‡(
	`IS_ERR
(
roŸ
)) {

1835 
ªt
 = 
	`PTR_ERR
(
roŸ
);

1836 
roŸ
 = 
NULL
;

1837 
out
;

1840 
key
.
obje˘id
 = 
dúid
;

1841 
key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

1842 
key
.
off£t
 = (
u64
)-1;

1845 
ªt
 = 
	`båfs_£¨ch_backw¨ds
(
roŸ
, &
key
, 
∑th
);

1846 i‡(
ªt
 < 0)

1847 
out
;

1848 i‡(
ªt
 > 0) {

1849 
ªt
 = -
ENOENT
;

1850 
out
;

1853 
l
 = 
∑th
->
nodes
[0];

1854 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

1856 
úef
 = 
	`båfs_ôem_±r
(
l
, 
¶Ÿ
, 
båfs_öode_ªf
);

1857 
Àn
 = 
	`båfs_öode_ªf_«me_Àn
(
l
, 
úef
);

1858 
±r
 -
Àn
 + 1;

1859 
tŸÆ_Àn
 +
Àn
 + 1;

1860 i‡(
±r
 < 
«me
) {

1861 
ªt
 = -
ENAMETOOLONG
;

1862 
out
;

1865 *(
±r
 + 
Àn
) = '/';

1866 
	`ªad_exã¡_buf„r
(
l
, 
±r
, ()(
úef
 + 1), 
Àn
);

1868 i‡(
key
.
off£t
 =
BTRFS_FIRST_FREE_OBJECTID
)

1871 
	`båfs_ªÀa£_∑th
(
∑th
);

1872 
key
.
obje˘id
 = key.
off£t
;

1873 
key
.
off£t
 = (
u64
)-1;

1874 
dúid
 = 
key
.
obje˘id
;

1876 
	`memmove
(
«me
, 
±r
, 
tŸÆ_Àn
);

1877 
«me
[
tŸÆ_Àn
] = '\0';

1878 
ªt
 = 0;

1879 
out
:

1880 
	`båfs_put_roŸ
(
roŸ
);

1881 
	`båfs_‰ì_∑th
(
∑th
);

1882  
ªt
;

1883 
	}
}

1885 
	$båfs_£¨ch_∑th_ö_åì_u£r
(
m¡_idm≠
 *
idm≠
,

1886 
öode
 *inode,

1887 
båfs_io˘l_öo_lookup_u£r_¨gs
 *
¨gs
)

1889 
båfs_fs_öfo
 *
fs_öfo
 = 
	`BTRFS_I
(
öode
)->
roŸ
->fs_info;

1890 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1891 
båfs_key
 
uµî_limô
 = 
	`BTRFS_I
(
öode
)->
loˇti⁄
;

1892 
u64
 
åìid
 = 
	`BTRFS_I
(
öode
)->
roŸ
->
roŸ_key
.
obje˘id
;

1893 
u64
 
dúid
 = 
¨gs
->dirid;

1894 
ôem_off
;

1895 
ôem_Àn
;

1896 
båfs_öode_ªf
 *
úef
;

1897 
båfs_roŸ_ªf
 *
ºef
;

1898 
båfs_roŸ
 *
roŸ
 = 
NULL
;

1899 
båfs_∑th
 *
∑th
;

1900 
båfs_key
 
key
, 
key2
;

1901 
exã¡_buf„r
 *
Àaf
;

1902 
öode
 *
ãmp_öode
;

1903 *
±r
;

1904 
¶Ÿ
;

1905 
Àn
;

1906 
tŸÆ_Àn
 = 0;

1907 
ªt
;

1909 
∑th
 = 
	`båfs_Æloc_∑th
();

1910 i‡(!
∑th
)

1911  -
ENOMEM
;

1917 i‡(
dúid
 !
uµî_limô
.
obje˘id
) {

1918 
±r
 = &
¨gs
->
∑th
[
BTRFS_INO_LOOKUP_USER_PATH_MAX
 - 1];

1920 
roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
åìid
, 
åue
);

1921 i‡(
	`IS_ERR
(
roŸ
)) {

1922 
ªt
 = 
	`PTR_ERR
(
roŸ
);

1923 
out
;

1926 
key
.
obje˘id
 = 
dúid
;

1927 
key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

1928 
key
.
off£t
 = (
u64
)-1;

1930 
ªt
 = 
	`båfs_£¨ch_backw¨ds
(
roŸ
, &
key
, 
∑th
);

1931 i‡(
ªt
 < 0)

1932 
out_put
;

1933 i‡(
ªt
 > 0) {

1934 
ªt
 = -
ENOENT
;

1935 
out_put
;

1938 
Àaf
 = 
∑th
->
nodes
[0];

1939 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

1941 
úef
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_öode_ªf
);

1942 
Àn
 = 
	`båfs_öode_ªf_«me_Àn
(
Àaf
, 
úef
);

1943 
±r
 -
Àn
 + 1;

1944 
tŸÆ_Àn
 +
Àn
 + 1;

1945 i‡(
±r
 < 
¨gs
->
∑th
) {

1946 
ªt
 = -
ENAMETOOLONG
;

1947 
out_put
;

1950 *(
±r
 + 
Àn
) = '/';

1951 
	`ªad_exã¡_buf„r
(
Àaf
, 
±r
,

1952 ()(
úef
 + 1), 
Àn
);

1955 
ªt
 = 
	`båfs_¥evious_ôem
(
roŸ
, 
∑th
, 
dúid
,

1956 
BTRFS_INODE_ITEM_KEY
);

1957 i‡(
ªt
 < 0) {

1958 
out_put
;

1959 } i‡(
ªt
 > 0) {

1960 
ªt
 = -
ENOENT
;

1961 
out_put
;

1964 
Àaf
 = 
∑th
->
nodes
[0];

1965 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

1966 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key2
, 
¶Ÿ
);

1967 i‡(
key2
.
obje˘id
 !
dúid
) {

1968 
ªt
 = -
ENOENT
;

1969 
out_put
;

1978 
	`båfs_ªÀa£_∑th
(
∑th
);

1979 
ãmp_öode
 = 
	`båfs_igë
(
sb
, 
key2
.
obje˘id
, 
roŸ
);

1980 i‡(
	`IS_ERR
(
ãmp_öode
)) {

1981 
ªt
 = 
	`PTR_ERR
(
ãmp_öode
);

1982 
out_put
;

1984 
ªt
 = 
	`öode_≥rmissi⁄
(
idm≠
, 
ãmp_öode
,

1985 
MAY_READ
 | 
MAY_EXEC
);

1986 
	`ùut
(
ãmp_öode
);

1987 i‡(
ªt
) {

1988 
ªt
 = -
EACCES
;

1989 
out_put
;

1992 i‡(
key
.
off£t
 =
uµî_limô
.
obje˘id
)

1994 i‡(
key
.
obje˘id
 =
BTRFS_FIRST_FREE_OBJECTID
) {

1995 
ªt
 = -
EACCES
;

1996 
out_put
;

1999 
key
.
obje˘id
 = key.
off£t
;

2000 
key
.
off£t
 = (
u64
)-1;

2001 
dúid
 = 
key
.
obje˘id
;

2004 
	`memmove
(
¨gs
->
∑th
, 
±r
, 
tŸÆ_Àn
);

2005 
¨gs
->
∑th
[
tŸÆ_Àn
] = '\0';

2006 
	`båfs_put_roŸ
(
roŸ
);

2007 
roŸ
 = 
NULL
;

2008 
	`båfs_ªÀa£_∑th
(
∑th
);

2012 
key
.
obje˘id
 = 
åìid
;

2013 
key
.
ty≥
 = 
BTRFS_ROOT_REF_KEY
;

2014 
key
.
off£t
 = 
¨gs
->
åìid
;

2015 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
fs_öfo
->
åì_roŸ
, &
key
, 
∑th
, 0, 0);

2016 i‡(
ªt
 < 0) {

2017 
out
;

2018 } i‡(
ªt
 > 0) {

2019 
ªt
 = -
ENOENT
;

2020 
out
;

2023 
Àaf
 = 
∑th
->
nodes
[0];

2024 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

2025 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

2027 
ôem_off
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
¶Ÿ
);

2028 
ôem_Àn
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

2030 
ºef
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_roŸ_ªf
);

2031 i‡(
¨gs
->
dúid
 !
	`båfs_roŸ_ªf_dúid
(
Àaf
, 
ºef
)) {

2032 
ªt
 = -
EINVAL
;

2033 
out
;

2037 
ôem_off
 +(
båfs_roŸ_ªf
);

2038 
ôem_Àn
 -(
båfs_roŸ_ªf
);

2039 
	`ªad_exã¡_buf„r
(
Àaf
, 
¨gs
->
«me
, 
ôem_off
, 
ôem_Àn
);

2040 
¨gs
->
«me
[
ôem_Àn
] = 0;

2042 
out_put
:

2043 
	`båfs_put_roŸ
(
roŸ
);

2044 
out
:

2045 
	`båfs_‰ì_∑th
(
∑th
);

2046  
ªt
;

2047 
	}
}

2049 
noölöe
 
	$båfs_io˘l_öo_lookup
(
båfs_roŸ
 *
roŸ
,

2050 
__u£r
 *
¨gp
)

2052 
båfs_io˘l_öo_lookup_¨gs
 *
¨gs
;

2053 
ªt
 = 0;

2055 
¨gs
 = 
	`memdup_u£r
(
¨gp
, (*args));

2056 i‡(
	`IS_ERR
(
¨gs
))

2057  
	`PTR_ERR
(
¨gs
);

2063 i‡(
¨gs
->
åìid
 == 0)

2064 
¨gs
->
åìid
 = 
roŸ
->
roŸ_key
.
obje˘id
;

2066 i‡(
¨gs
->
obje˘id
 =
BTRFS_FIRST_FREE_OBJECTID
) {

2067 
¨gs
->
«me
[0] = 0;

2068 
out
;

2071 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
)) {

2072 
ªt
 = -
EPERM
;

2073 
out
;

2076 
ªt
 = 
	`båfs_£¨ch_∑th_ö_åì
(
roŸ
->
fs_öfo
,

2077 
¨gs
->
åìid
,árgs->
obje˘id
,

2078 
¨gs
->
«me
);

2080 
out
:

2081 i‡(
ªt
 =0 && 
	`c›y_to_u£r
(
¨gp
, 
¨gs
, (*args)))

2082 
ªt
 = -
EFAULT
;

2084 
	`k‰ì
(
¨gs
);

2085  
ªt
;

2086 
	}
}

2100 
	$båfs_io˘l_öo_lookup_u£r
(
fûe
 *fûe, 
__u£r
 *
¨gp
)

2102 
båfs_io˘l_öo_lookup_u£r_¨gs
 *
¨gs
;

2103 
öode
 *inode;

2104 
ªt
;

2106 
¨gs
 = 
	`memdup_u£r
(
¨gp
, (*args));

2107 i‡(
	`IS_ERR
(
¨gs
))

2108  
	`PTR_ERR
(
¨gs
);

2110 
öode
 = 
	`fûe_öode
(
fûe
);

2112 i‡(
¨gs
->
dúid
 =
BTRFS_FIRST_FREE_OBJECTID
 &&

2113 
	`BTRFS_I
(
öode
)->
loˇti⁄
.
obje˘id
 !
BTRFS_FIRST_FREE_OBJECTID
) {

2118 
	`k‰ì
(
¨gs
);

2119  -
EACCES
;

2122 
ªt
 = 
	`båfs_£¨ch_∑th_ö_åì_u£r
(
	`fûe_m¡_idm≠
(
fûe
), 
öode
, 
¨gs
);

2124 i‡(
ªt
 =0 && 
	`c›y_to_u£r
(
¨gp
, 
¨gs
, (*args)))

2125 
ªt
 = -
EFAULT
;

2127 
	`k‰ì
(
¨gs
);

2128  
ªt
;

2129 
	}
}

2132 
	$båfs_io˘l_gë_subvﬁ_öfo
(
öode
 *öode, 
__u£r
 *
¨gp
)

2134 
båfs_io˘l_gë_subvﬁ_öfo_¨gs
 *
subvﬁ_öfo
;

2135 
båfs_fs_öfo
 *
fs_öfo
;

2136 
båfs_roŸ
 *
roŸ
;

2137 
båfs_∑th
 *
∑th
;

2138 
båfs_key
 
key
;

2139 
båfs_roŸ_ôem
 *
roŸ_ôem
;

2140 
båfs_roŸ_ªf
 *
ºef
;

2141 
exã¡_buf„r
 *
Àaf
;

2142 
ôem_off
;

2143 
ôem_Àn
;

2144 
¶Ÿ
;

2145 
ªt
 = 0;

2147 
∑th
 = 
	`båfs_Æloc_∑th
();

2148 i‡(!
∑th
)

2149  -
ENOMEM
;

2151 
subvﬁ_öfo
 = 
	`kzÆloc
((*subvﬁ_öfo), 
GFP_KERNEL
);

2152 i‡(!
subvﬁ_öfo
) {

2153 
	`båfs_‰ì_∑th
(
∑th
);

2154  -
ENOMEM
;

2157 
fs_öfo
 = 
	`BTRFS_I
(
öode
)->
roŸ
->fs_info;

2160 
key
.
obje˘id
 = 
	`BTRFS_I
(
öode
)->
roŸ
->
roŸ_key
.objectid;

2161 
roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
key
.
obje˘id
, 
åue
);

2162 i‡(
	`IS_ERR
(
roŸ
)) {

2163 
ªt
 = 
	`PTR_ERR
(
roŸ
);

2164 
out_‰ì
;

2166 
roŸ_ôem
 = &
roŸ
->root_item;

2168 
subvﬁ_öfo
->
åìid
 = 
key
.
obje˘id
;

2170 
subvﬁ_öfo
->
gíî©i⁄
 = 
	`båfs_roŸ_gíî©i⁄
(
roŸ_ôem
);

2171 
subvﬁ_öfo
->
Êags
 = 
	`båfs_roŸ_Êags
(
roŸ_ôem
);

2173 
	`mem˝y
(
subvﬁ_öfo
->
uuid
, 
roŸ_ôem
->uuid, 
BTRFS_UUID_SIZE
);

2174 
	`mem˝y
(
subvﬁ_öfo
->
∑ª¡_uuid
, 
roŸ_ôem
->parent_uuid,

2175 
BTRFS_UUID_SIZE
);

2176 
	`mem˝y
(
subvﬁ_öfo
->
ª˚ived_uuid
, 
roŸ_ôem
->received_uuid,

2177 
BTRFS_UUID_SIZE
);

2179 
subvﬁ_öfo
->
˘ønsid
 = 
	`båfs_roŸ_˘ønsid
(
roŸ_ôem
);

2180 
subvﬁ_öfo
->
˘ime
.
£c
 = 
	`båfs_°ack_time•ec_£c
(&
roŸ_ôem
->ctime);

2181 
subvﬁ_öfo
->
˘ime
.
n£c
 = 
	`båfs_°ack_time•ec_n£c
(&
roŸ_ôem
->ctime);

2183 
subvﬁ_öfo
->
Ÿønsid
 = 
	`båfs_roŸ_Ÿønsid
(
roŸ_ôem
);

2184 
subvﬁ_öfo
->
Ÿime
.
£c
 = 
	`båfs_°ack_time•ec_£c
(&
roŸ_ôem
->otime);

2185 
subvﬁ_öfo
->
Ÿime
.
n£c
 = 
	`båfs_°ack_time•ec_n£c
(&
roŸ_ôem
->otime);

2187 
subvﬁ_öfo
->
°ønsid
 = 
	`båfs_roŸ_°ønsid
(
roŸ_ôem
);

2188 
subvﬁ_öfo
->
°ime
.
£c
 = 
	`båfs_°ack_time•ec_£c
(&
roŸ_ôem
->stime);

2189 
subvﬁ_öfo
->
°ime
.
n£c
 = 
	`båfs_°ack_time•ec_n£c
(&
roŸ_ôem
->stime);

2191 
subvﬁ_öfo
->
πønsid
 = 
	`båfs_roŸ_πønsid
(
roŸ_ôem
);

2192 
subvﬁ_öfo
->
πime
.
£c
 = 
	`båfs_°ack_time•ec_£c
(&
roŸ_ôem
->rtime);

2193 
subvﬁ_öfo
->
πime
.
n£c
 = 
	`båfs_°ack_time•ec_n£c
(&
roŸ_ôem
->rtime);

2195 i‡(
key
.
obje˘id
 !
BTRFS_FS_TREE_OBJECTID
) {

2197 
key
.
ty≥
 = 
BTRFS_ROOT_BACKREF_KEY
;

2198 
key
.
off£t
 = 0;

2199 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
fs_öfo
->
åì_roŸ
, &
key
, 
∑th
, 0, 0);

2200 i‡(
ªt
 < 0) {

2201 
out
;

2202 } i‡(
∑th
->
¶Ÿs
[0] >=

2203 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0])) {

2204 
ªt
 = 
	`båfs_√xt_Àaf
(
fs_öfo
->
åì_roŸ
, 
∑th
);

2205 i‡(
ªt
 < 0) {

2206 
out
;

2207 } i‡(
ªt
 > 0) {

2208 
ªt
 = -
EUCLEAN
;

2209 
out
;

2213 
Àaf
 = 
∑th
->
nodes
[0];

2214 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

2215 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

2216 i‡(
key
.
obje˘id
 =
subvﬁ_öfo
->
åìid
 &&

2217 
key
.
ty≥
 =
BTRFS_ROOT_BACKREF_KEY
) {

2218 
subvﬁ_öfo
->
∑ª¡_id
 = 
key
.
off£t
;

2220 
ºef
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_roŸ_ªf
);

2221 
subvﬁ_öfo
->
dúid
 = 
	`båfs_roŸ_ªf_dúid
(
Àaf
, 
ºef
);

2223 
ôem_off
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
¶Ÿ
)

2224 + (
båfs_roŸ_ªf
);

2225 
ôem_Àn
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
)

2226 - (
båfs_roŸ_ªf
);

2227 
	`ªad_exã¡_buf„r
(
Àaf
, 
subvﬁ_öfo
->
«me
,

2228 
ôem_off
, 
ôem_Àn
);

2230 
ªt
 = -
ENOENT
;

2231 
out
;

2235 
	`båfs_‰ì_∑th
(
∑th
);

2236 
∑th
 = 
NULL
;

2237 i‡(
	`c›y_to_u£r
(
¨gp
, 
subvﬁ_öfo
, (*subvol_info)))

2238 
ªt
 = -
EFAULT
;

2240 
out
:

2241 
	`båfs_put_roŸ
(
roŸ
);

2242 
out_‰ì
:

2243 
	`båfs_‰ì_∑th
(
∑th
);

2244 
	`k‰ì
(
subvﬁ_öfo
);

2245  
ªt
;

2246 
	}
}

2252 
	$båfs_io˘l_gë_subvﬁ_roŸªf
(
båfs_roŸ
 *
roŸ
,

2253 
__u£r
 *
¨gp
)

2255 
båfs_io˘l_gë_subvﬁ_roŸªf_¨gs
 *
roŸªfs
;

2256 
båfs_roŸ_ªf
 *
ºef
;

2257 
båfs_∑th
 *
∑th
;

2258 
båfs_key
 
key
;

2259 
exã¡_buf„r
 *
Àaf
;

2260 
u64
 
obje˘id
;

2261 
¶Ÿ
;

2262 
ªt
;

2263 
u8
 
found
;

2265 
∑th
 = 
	`båfs_Æloc_∑th
();

2266 i‡(!
∑th
)

2267  -
ENOMEM
;

2269 
roŸªfs
 = 
	`memdup_u£r
(
¨gp
, (*rootrefs));

2270 i‡(
	`IS_ERR
(
roŸªfs
)) {

2271 
	`båfs_‰ì_∑th
(
∑th
);

2272  
	`PTR_ERR
(
roŸªfs
);

2275 
obje˘id
 = 
roŸ
->
roŸ_key
.objectid;

2276 
key
.
obje˘id
 = objectid;

2277 
key
.
ty≥
 = 
BTRFS_ROOT_REF_KEY
;

2278 
key
.
off£t
 = 
roŸªfs
->
mö_åìid
;

2279 
found
 = 0;

2281 
roŸ
 =ÑoŸ->
fs_öfo
->
åì_roŸ
;

2282 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

2283 i‡(
ªt
 < 0) {

2284 
out
;

2285 } i‡(
∑th
->
¶Ÿs
[0] >=

2286 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0])) {

2287 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

2288 i‡(
ªt
 < 0) {

2289 
out
;

2290 } i‡(
ªt
 > 0) {

2291 
ªt
 = -
EUCLEAN
;

2292 
out
;

2296 
Àaf
 = 
∑th
->
nodes
[0];

2297 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

2299 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

2300 i‡(
key
.
obje˘id
 !obje˘id || key.
ty≥
 !
BTRFS_ROOT_REF_KEY
) {

2301 
ªt
 = 0;

2302 
out
;

2305 i‡(
found
 =
BTRFS_MAX_ROOTREF_BUFFER_NUM
) {

2306 
ªt
 = -
EOVERFLOW
;

2307 
out
;

2310 
ºef
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_roŸ_ªf
);

2311 
roŸªfs
->
roŸªf
[
found
].
åìid
 = 
key
.
off£t
;

2312 
roŸªfs
->
roŸªf
[
found
].
dúid
 =

2313 
	`båfs_roŸ_ªf_dúid
(
Àaf
, 
ºef
);

2314 
found
++;

2316 
ªt
 = 
	`båfs_√xt_ôem
(
roŸ
, 
∑th
);

2317 i‡(
ªt
 < 0) {

2318 
out
;

2319 } i‡(
ªt
 > 0) {

2320 
ªt
 = -
EUCLEAN
;

2321 
out
;

2325 
out
:

2326 
	`båfs_‰ì_∑th
(
∑th
);

2328 i‡(!
ªt
 ||Ñë =-
EOVERFLOW
) {

2329 
roŸªfs
->
num_ôems
 = 
found
;

2331 i‡(
found
)

2332 
roŸªfs
->
mö_åìid
 =

2333 
roŸªfs
->
roŸªf
[
found
 - 1].
åìid
 + 1;

2334 i‡(
	`c›y_to_u£r
(
¨gp
, 
roŸªfs
, (*rootrefs)))

2335 
ªt
 = -
EFAULT
;

2338 
	`k‰ì
(
roŸªfs
);

2340  
ªt
;

2341 
	}
}

2343 
noölöe
 
	$båfs_io˘l_¢≠_de°roy
(
fûe
 *file,

2344 
__u£r
 *
¨g
,

2345 
boﬁ
 
de°roy_v2
)

2347 
díåy
 *
∑ª¡
 = 
fûe
->
f_∑th
.dentry;

2348 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
∑ª¡
->
d_sb
);

2349 
díåy
 *dentry;

2350 
öode
 *
dú
 = 
	`d_öode
(
∑ª¡
);

2351 
öode
 *inode;

2352 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
dú
)->root;

2353 
båfs_roŸ
 *
de°
 = 
NULL
;

2354 
båfs_io˘l_vﬁ_¨gs
 *
vﬁ_¨gs
 = 
NULL
;

2355 
båfs_io˘l_vﬁ_¨gs_v2
 *
vﬁ_¨gs2
 = 
NULL
;

2356 
m¡_idm≠
 *
idm≠
 = 
	`fûe_m¡_idm≠
(
fûe
);

2357 *
subvﬁ_«me
, *
subvﬁ_«me_±r
 = 
NULL
;

2358 
subvﬁ_«mñí
;

2359 
îr
 = 0;

2360 
boﬁ
 
de°roy_∑ª¡
 = 
Ál£
;

2363 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
EXTENT_TREE_V2
)) {

2364 
	`båfs_îr
(
fs_öfo
,

2366  -
EOPNOTSUPP
;

2369 i‡(
de°roy_v2
) {

2370 
vﬁ_¨gs2
 = 
	`memdup_u£r
(
¨g
, (*vol_args2));

2371 i‡(
	`IS_ERR
(
vﬁ_¨gs2
))

2372  
	`PTR_ERR
(
vﬁ_¨gs2
);

2374 i‡(
vﬁ_¨gs2
->
Êags
 & ~
BTRFS_SUBVOL_DELETE_ARGS_MASK
) {

2375 
îr
 = -
EOPNOTSUPP
;

2376 
out
;

2383 i‡(!(
vﬁ_¨gs2
->
Êags
 & 
BTRFS_SUBVOL_SPEC_BY_ID
)) {

2384 
vﬁ_¨gs2
->
«me
[
BTRFS_SUBVOL_NAME_MAX
] = 0;

2385 
subvﬁ_«me
 = 
vﬁ_¨gs2
->
«me
;

2387 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

2388 i‡(
îr
)

2389 
out
;

2391 
öode
 *
ﬁd_dú
;

2393 i‡(
vﬁ_¨gs2
->
subvﬁid
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

2394 
îr
 = -
EINVAL
;

2395 
out
;

2398 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

2399 i‡(
îr
)

2400 
out
;

2402 
díåy
 = 
	`båfs_gë_díåy
(
fs_öfo
->
sb
,

2403 
BTRFS_FIRST_FREE_OBJECTID
,

2404 
vﬁ_¨gs2
->
subvﬁid
, 0);

2405 i‡(
	`IS_ERR
(
díåy
)) {

2406 
îr
 = 
	`PTR_ERR
(
díåy
);

2407 
out_dr›_wrôe
;

2414 
∑ª¡
 = 
	`båfs_gë_∑ª¡
(
díåy
);

2424 
	`dput
(
díåy
);

2425 i‡(
	`IS_ERR
(
∑ª¡
)) {

2426 
îr
 = 
	`PTR_ERR
(
∑ª¡
);

2427 
out_dr›_wrôe
;

2429 
ﬁd_dú
 = 
dú
;

2430 
dú
 = 
	`d_öode
(
∑ª¡
);

2438 
de°roy_∑ª¡
 = 
åue
;

2449 i‡(
ﬁd_dú
 !
dú
 && 
idm≠
 !&
n›_m¡_idm≠
) {

2450 
îr
 = -
EOPNOTSUPP
;

2451 
‰ì_∑ª¡
;

2454 
subvﬁ_«me_±r
 = 
	`båfs_gë_subvﬁ_«me_‰om_obje˘id
(

2455 
fs_öfo
, 
vﬁ_¨gs2
->
subvﬁid
);

2456 i‡(
	`IS_ERR
(
subvﬁ_«me_±r
)) {

2457 
îr
 = 
	`PTR_ERR
(
subvﬁ_«me_±r
);

2458 
‰ì_∑ª¡
;

2461 
subvﬁ_«me
 = (*)
	`kba£«me
(
subvﬁ_«me_±r
);

2464 
vﬁ_¨gs
 = 
	`memdup_u£r
(
¨g
, (*vol_args));

2465 i‡(
	`IS_ERR
(
vﬁ_¨gs
))

2466  
	`PTR_ERR
(
vﬁ_¨gs
);

2468 
vﬁ_¨gs
->
«me
[
BTRFS_PATH_NAME_MAX
] = 0;

2469 
subvﬁ_«me
 = 
vﬁ_¨gs
->
«me
;

2471 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

2472 i‡(
îr
)

2473 
out
;

2476 
subvﬁ_«mñí
 = 
	`°æí
(
subvﬁ_«me
);

2478 i‡(
	`°rchr
(
subvﬁ_«me
, '/') ||

2479 
	`°∫cmp
(
subvﬁ_«me
, "..", 
subvﬁ_«mñí
) == 0) {

2480 
îr
 = -
EINVAL
;

2481 
‰ì_subvﬁ_«me
;

2484 i‡(!
	`S_ISDIR
(
dú
->
i_mode
)) {

2485 
îr
 = -
ENOTDIR
;

2486 
‰ì_subvﬁ_«me
;

2489 
îr
 = 
	`down_wrôe_kûœbÀ_√°ed
(&
dú
->
i_rw£m
, 
I_MUTEX_PARENT
);

2490 i‡(
îr
 =-
EINTR
)

2491 
‰ì_subvﬁ_«me
;

2492 
díåy
 = 
	`lookup_⁄e
(
idm≠
, 
subvﬁ_«me
, 
∑ª¡
, 
subvﬁ_«mñí
);

2493 i‡(
	`IS_ERR
(
díåy
)) {

2494 
îr
 = 
	`PTR_ERR
(
díåy
);

2495 
out_u∆ock_dú
;

2498 i‡(
	`d_ªÆly_is_√g©ive
(
díåy
)) {

2499 
îr
 = -
ENOENT
;

2500 
out_dput
;

2503 
öode
 = 
	`d_öode
(
díåy
);

2504 
de°
 = 
	`BTRFS_I
(
öode
)->
roŸ
;

2505 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
)) {

2519 
îr
 = -
EPERM
;

2520 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
USER_SUBVOL_RM_ALLOWED
))

2521 
out_dput
;

2530 
îr
 = -
EINVAL
;

2531 i‡(
roŸ
 =
de°
)

2532 
out_dput
;

2534 
îr
 = 
	`öode_≥rmissi⁄
(
idm≠
, 
öode
, 
MAY_WRITE
 | 
MAY_EXEC
);

2535 i‡(
îr
)

2536 
out_dput
;

2540 
îr
 = 
	`båfs_may_dñëe
(
idm≠
, 
dú
, 
díåy
, 1);

2541 i‡(
îr
)

2542 
out_dput
;

2544 i‡(
	`båfs_öo
(
	`BTRFS_I
(
öode
)Ë!
BTRFS_FIRST_FREE_OBJECTID
) {

2545 
îr
 = -
EINVAL
;

2546 
out_dput
;

2549 
	`båfs_öode_lock
(
	`BTRFS_I
(
öode
), 0);

2550 
îr
 = 
	`båfs_dñëe_subvﬁume
(
	`BTRFS_I
(
dú
), 
díåy
);

2551 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
öode
), 0);

2552 i‡(!
îr
)

2553 
	`d_dñëe_nŸify
(
dú
, 
díåy
);

2555 
out_dput
:

2556 
	`dput
(
díåy
);

2557 
out_u∆ock_dú
:

2558 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
dú
), 0);

2559 
‰ì_subvﬁ_«me
:

2560 
	`k‰ì
(
subvﬁ_«me_±r
);

2561 
‰ì_∑ª¡
:

2562 i‡(
de°roy_∑ª¡
)

2563 
	`dput
(
∑ª¡
);

2564 
out_dr›_wrôe
:

2565 
	`m¡_dr›_wrôe_fûe
(
fûe
);

2566 
out
:

2567 
	`k‰ì
(
vﬁ_¨gs2
);

2568 
	`k‰ì
(
vﬁ_¨gs
);

2569  
îr
;

2570 
	}
}

2572 
	$båfs_io˘l_de‰ag
(
fûe
 *fûe, 
__u£r
 *
¨gp
)

2574 
öode
 *öodê
	`fûe_öode
(
fûe
);

2575 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

2576 
båfs_io˘l_de‰ag_ønge_¨gs
 
ønge
 = {0};

2577 
ªt
;

2579 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

2580 i‡(
ªt
)

2581  
ªt
;

2583 i‡(
	`båfs_roŸ_ªad⁄ly
(
roŸ
)) {

2584 
ªt
 = -
EROFS
;

2585 
out
;

2588 
öode
->
i_mode
 & 
S_IFMT
) {

2589 
S_IFDIR
:

2590 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
)) {

2591 
ªt
 = -
EPERM
;

2592 
out
;

2594 
ªt
 = 
	`båfs_de‰ag_roŸ
(
roŸ
);

2596 
S_IFREG
:

2602 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
) &&

2603 
	`öode_≥rmissi⁄
(&
n›_m¡_idm≠
, 
öode
, 
MAY_WRITE
)) {

2604 
ªt
 = -
EPERM
;

2605 
out
;

2608 i‡(
¨gp
) {

2609 i‡(
	`c›y_‰om_u£r
(&
ønge
, 
¨gp
, (range))) {

2610 
ªt
 = -
EFAULT
;

2611 
out
;

2614 i‡((
ønge
.
Êags
 & 
BTRFS_DEFRAG_RANGE_COMPRESS
)) {

2615 
ønge
.
Êags
 |
BTRFS_DEFRAG_RANGE_START_IO
;

2616 
ønge
.
exã¡_thªsh
 = (
u32
)-1;

2620 
ønge
.
Àn
 = (
u64
)-1;

2622 
ªt
 = 
	`båfs_de‰ag_fûe
(
	`fûe_öode
(
fûe
), &fûe->
f_ø
,

2623 &
ønge
, 
BTRFS_OLDEST_GENERATION
, 0);

2624 i‡(
ªt
 > 0)

2625 
ªt
 = 0;

2628 
ªt
 = -
EINVAL
;

2630 
out
:

2631 
	`m¡_dr›_wrôe_fûe
(
fûe
);

2632  
ªt
;

2633 
	}
}

2635 
	$båfs_io˘l_add_dev
(
båfs_fs_öfo
 *
fs_öfo
, 
__u£r
 *
¨g
)

2637 
båfs_io˘l_vﬁ_¨gs
 *
vﬁ_¨gs
;

2638 
boﬁ
 
ª°‹e_›
 = 
Ál£
;

2639 
ªt
;

2641 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

2642  -
EPERM
;

2644 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
EXTENT_TREE_V2
)) {

2645 
	`båfs_îr
(
fs_öfo
, "deviceáddÇot supported onÉxtentÅree v2 yet");

2646  -
EINVAL
;

2649 i‡(!
	`båfs_ex˛›_°¨t
(
fs_öfo
, 
BTRFS_EXCLOP_DEV_ADD
)) {

2650 i‡(!
	`båfs_ex˛›_°¨t_åy_lock
(
fs_öfo
, 
BTRFS_EXCLOP_DEV_ADD
))

2651  
BTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
;

2658 
fs_öfo
->
ex˛usive_›î©i⁄
 = 
BTRFS_EXCLOP_DEV_ADD
;

2659 
	`båfs_ex˛›_°¨t_u∆ock
(
fs_öfo
);

2660 
ª°‹e_›
 = 
åue
;

2663 
vﬁ_¨gs
 = 
	`memdup_u£r
(
¨g
, (*vol_args));

2664 i‡(
	`IS_ERR
(
vﬁ_¨gs
)) {

2665 
ªt
 = 
	`PTR_ERR
(
vﬁ_¨gs
);

2666 
out
;

2669 
vﬁ_¨gs
->
«me
[
BTRFS_PATH_NAME_MAX
] = '\0';

2670 
ªt
 = 
	`båfs_öô_√w_devi˚
(
fs_öfo
, 
vﬁ_¨gs
->
«me
);

2672 i‡(!
ªt
)

2673 
	`båfs_öfo
(
fs_öfo
, "diskádded %s", 
vﬁ_¨gs
->
«me
);

2675 
	`k‰ì
(
vﬁ_¨gs
);

2676 
out
:

2677 i‡(
ª°‹e_›
)

2678 
	`båfs_ex˛›_bÆ™˚
(
fs_öfo
, 
BTRFS_EXCLOP_BALANCE_PAUSED
);

2680 
	`båfs_ex˛›_föish
(
fs_öfo
);

2681  
ªt
;

2682 
	}
}

2684 
	$båfs_io˘l_rm_dev_v2
(
fûe
 *fûe, 
__u£r
 *
¨g
)

2686 
	`BTRFS_DEV_LOOKUP_ARGS
(
¨gs
);

2687 
öode
 *öodê
	`fûe_öode
(
fûe
);

2688 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

2689 
båfs_io˘l_vﬁ_¨gs_v2
 *
vﬁ_¨gs
;

2690 
block_devi˚
 *
bdev
 = 
NULL
;

2691 *
hﬁdî
;

2692 
ªt
;

2693 
boﬁ
 
ˇn˚l
 = 
Ál£
;

2695 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

2696  -
EPERM
;

2698 
vﬁ_¨gs
 = 
	`memdup_u£r
(
¨g
, (*vol_args));

2699 i‡(
	`IS_ERR
(
vﬁ_¨gs
))

2700  
	`PTR_ERR
(
vﬁ_¨gs
);

2702 i‡(
vﬁ_¨gs
->
Êags
 & ~
BTRFS_DEVICE_REMOVE_ARGS_MASK
) {

2703 
ªt
 = -
EOPNOTSUPP
;

2704 
out
;

2707 
vﬁ_¨gs
->
«me
[
BTRFS_SUBVOL_NAME_MAX
] = '\0';

2708 i‡(
vﬁ_¨gs
->
Êags
 & 
BTRFS_DEVICE_SPEC_BY_ID
) {

2709 
¨gs
.
devid
 = 
vﬁ_¨gs
->devid;

2710 } i‡(!
	`°rcmp
("ˇn˚l", 
vﬁ_¨gs
->
«me
)) {

2711 
ˇn˚l
 = 
åue
;

2713 
ªt
 = 
	`båfs_gë_dev_¨gs_‰om_∑th
(
fs_öfo
, &
¨gs
, 
vﬁ_¨gs
->
«me
);

2714 i‡(
ªt
)

2715 
out
;

2718 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

2719 i‡(
ªt
)

2720 
out
;

2722 
ªt
 = 
	`ex˛›_°¨t_‹_ˇn˚l_ªloc
(
fs_öfo
, 
BTRFS_EXCLOP_DEV_REMOVE
,

2723 
ˇn˚l
);

2724 i‡(
ªt
)

2725 
îr_dr›
;

2728 
ªt
 = 
	`båfs_rm_devi˚
(
fs_öfo
, &
¨gs
, &
bdev
, &
hﬁdî
);

2730 
	`båfs_ex˛›_föish
(
fs_öfo
);

2732 i‡(!
ªt
) {

2733 i‡(
vﬁ_¨gs
->
Êags
 & 
BTRFS_DEVICE_SPEC_BY_ID
)

2734 
	`båfs_öfo
(
fs_öfo
, "device deleted: id %llu",

2735 
vﬁ_¨gs
->
devid
);

2737 
	`båfs_öfo
(
fs_öfo
, "device deleted: %s",

2738 
vﬁ_¨gs
->
«me
);

2740 
îr_dr›
:

2741 
	`m¡_dr›_wrôe_fûe
(
fûe
);

2742 i‡(
bdev
)

2743 
	`blkdev_put
(
bdev
, 
hﬁdî
);

2744 
out
:

2745 
	`båfs_put_dev_¨gs_‰om_∑th
(&
¨gs
);

2746 
	`k‰ì
(
vﬁ_¨gs
);

2747  
ªt
;

2748 
	}
}

2750 
	$båfs_io˘l_rm_dev
(
fûe
 *fûe, 
__u£r
 *
¨g
)

2752 
	`BTRFS_DEV_LOOKUP_ARGS
(
¨gs
);

2753 
öode
 *öodê
	`fûe_öode
(
fûe
);

2754 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

2755 
båfs_io˘l_vﬁ_¨gs
 *
vﬁ_¨gs
;

2756 
block_devi˚
 *
bdev
 = 
NULL
;

2757 *
hﬁdî
;

2758 
ªt
;

2759 
boﬁ
 
ˇn˚l
 = 
Ál£
;

2761 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

2762  -
EPERM
;

2764 
vﬁ_¨gs
 = 
	`memdup_u£r
(
¨g
, (*vol_args));

2765 i‡(
	`IS_ERR
(
vﬁ_¨gs
))

2766  
	`PTR_ERR
(
vﬁ_¨gs
);

2768 
vﬁ_¨gs
->
«me
[
BTRFS_PATH_NAME_MAX
] = '\0';

2769 i‡(!
	`°rcmp
("ˇn˚l", 
vﬁ_¨gs
->
«me
)) {

2770 
ˇn˚l
 = 
åue
;

2772 
ªt
 = 
	`båfs_gë_dev_¨gs_‰om_∑th
(
fs_öfo
, &
¨gs
, 
vﬁ_¨gs
->
«me
);

2773 i‡(
ªt
)

2774 
out
;

2777 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

2778 i‡(
ªt
)

2779 
out
;

2781 
ªt
 = 
	`ex˛›_°¨t_‹_ˇn˚l_ªloc
(
fs_öfo
, 
BTRFS_EXCLOP_DEV_REMOVE
,

2782 
ˇn˚l
);

2783 i‡(
ªt
 == 0) {

2784 
ªt
 = 
	`båfs_rm_devi˚
(
fs_öfo
, &
¨gs
, &
bdev
, &
hﬁdî
);

2785 i‡(!
ªt
)

2786 
	`båfs_öfo
(
fs_öfo
, "disk dñëed %s", 
vﬁ_¨gs
->
«me
);

2787 
	`båfs_ex˛›_föish
(
fs_öfo
);

2790 
	`m¡_dr›_wrôe_fûe
(
fûe
);

2791 i‡(
bdev
)

2792 
	`blkdev_put
(
bdev
, 
hﬁdî
);

2793 
out
:

2794 
	`båfs_put_dev_¨gs_‰om_∑th
(&
¨gs
);

2795 
	`k‰ì
(
vﬁ_¨gs
);

2796  
ªt
;

2797 
	}
}

2799 
	$båfs_io˘l_fs_öfo
(
båfs_fs_öfo
 *
fs_öfo
,

2800 
__u£r
 *
¨g
)

2802 
båfs_io˘l_fs_öfo_¨gs
 *
fi_¨gs
;

2803 
båfs_devi˚
 *
devi˚
;

2804 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

2805 
u64
 
Êags_ö
;

2806 
ªt
 = 0;

2808 
fi_¨gs
 = 
	`memdup_u£r
(
¨g
, (*fi_args));

2809 i‡(
	`IS_ERR
(
fi_¨gs
))

2810  
	`PTR_ERR
(
fi_¨gs
);

2812 
Êags_ö
 = 
fi_¨gs
->
Êags
;

2813 
	`mem£t
(
fi_¨gs
, 0, (*fi_args));

2815 
	`rcu_ªad_lock
();

2816 
fi_¨gs
->
num_devi˚s
 = 
fs_devi˚s
->num_devices;

2818 
	`li°_f‹_óch_íåy_rcu
(
devi˚
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

2819 i‡(
devi˚
->
devid
 > 
fi_¨gs
->
max_id
)

2820 
fi_¨gs
->
max_id
 = 
devi˚
->
devid
;

2822 
	`rcu_ªad_u∆ock
();

2824 
	`mem˝y
(&
fi_¨gs
->
fsid
, 
fs_devi˚s
->fsid, (fi_args->fsid));

2825 
fi_¨gs
->
nodesize
 = 
fs_öfo
->nodesize;

2826 
fi_¨gs
->
£˘‹size
 = 
fs_öfo
->sectorsize;

2827 
fi_¨gs
->
˛⁄e_Æignmít
 = 
fs_öfo
->
£˘‹size
;

2829 i‡(
Êags_ö
 & 
BTRFS_FS_INFO_FLAG_CSUM_INFO
) {

2830 
fi_¨gs
->
csum_ty≥
 = 
	`båfs_su≥r_csum_ty≥
(
fs_öfo
->
su≥r_c›y
);

2831 
fi_¨gs
->
csum_size
 = 
	`båfs_su≥r_csum_size
(
fs_öfo
->
su≥r_c›y
);

2832 
fi_¨gs
->
Êags
 |
BTRFS_FS_INFO_FLAG_CSUM_INFO
;

2835 i‡(
Êags_ö
 & 
BTRFS_FS_INFO_FLAG_GENERATION
) {

2836 
fi_¨gs
->
gíî©i⁄
 = 
fs_öfo
->generation;

2837 
fi_¨gs
->
Êags
 |
BTRFS_FS_INFO_FLAG_GENERATION
;

2840 i‡(
Êags_ö
 & 
BTRFS_FS_INFO_FLAG_METADATA_UUID
) {

2841 
	`mem˝y
(&
fi_¨gs
->
mëad©a_uuid
, 
fs_devi˚s
->metadata_uuid,

2842 (
fi_¨gs
->
mëad©a_uuid
));

2843 
fi_¨gs
->
Êags
 |
BTRFS_FS_INFO_FLAG_METADATA_UUID
;

2846 i‡(
	`c›y_to_u£r
(
¨g
, 
fi_¨gs
, (*fi_args)))

2847 
ªt
 = -
EFAULT
;

2849 
	`k‰ì
(
fi_¨gs
);

2850  
ªt
;

2851 
	}
}

2853 
	$båfs_io˘l_dev_öfo
(
båfs_fs_öfo
 *
fs_öfo
,

2854 
__u£r
 *
¨g
)

2856 
	`BTRFS_DEV_LOOKUP_ARGS
(
¨gs
);

2857 
båfs_io˘l_dev_öfo_¨gs
 *
di_¨gs
;

2858 
båfs_devi˚
 *
dev
;

2859 
ªt
 = 0;

2861 
di_¨gs
 = 
	`memdup_u£r
(
¨g
, (*di_args));

2862 i‡(
	`IS_ERR
(
di_¨gs
))

2863  
	`PTR_ERR
(
di_¨gs
);

2865 
¨gs
.
devid
 = 
di_¨gs
->devid;

2866 i‡(!
	`båfs_is_em±y_uuid
(
di_¨gs
->
uuid
))

2867 
¨gs
.
uuid
 = 
di_¨gs
->uuid;

2869 
	`rcu_ªad_lock
();

2870 
dev
 = 
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, &
¨gs
);

2871 i‡(!
dev
) {

2872 
ªt
 = -
ENODEV
;

2873 
out
;

2876 
di_¨gs
->
devid
 = 
dev
->devid;

2877 
di_¨gs
->
byãs_u£d
 = 
	`båfs_devi˚_gë_byãs_u£d
(
dev
);

2878 
di_¨gs
->
tŸÆ_byãs
 = 
	`båfs_devi˚_gë_tŸÆ_byãs
(
dev
);

2879 
	`mem˝y
(
di_¨gs
->
uuid
, 
dev
->uuid, (di_args->uuid));

2880 
	`mem˝y
(
di_¨gs
->
fsid
, 
dev
->
fs_devi˚s
->fsid, 
BTRFS_UUID_SIZE
);

2881 i‡(
dev
->
«me
)

2882 
	`°rs˝y
(
di_¨gs
->
∑th
, 
	`båfs_dev_«me
(
dev
), (di_args->path));

2884 
di_¨gs
->
∑th
[0] = '\0';

2886 
out
:

2887 
	`rcu_ªad_u∆ock
();

2888 i‡(
ªt
 =0 && 
	`c›y_to_u£r
(
¨g
, 
di_¨gs
, (*di_args)))

2889 
ªt
 = -
EFAULT
;

2891 
	`k‰ì
(
di_¨gs
);

2892  
ªt
;

2893 
	}
}

2895 
	$båfs_io˘l_deÁu…_subvﬁ
(
fûe
 *fûe, 
__u£r
 *
¨gp
)

2897 
öode
 *öodê
	`fûe_öode
(
fûe
);

2898 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

2899 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

2900 
båfs_roŸ
 *
√w_roŸ
;

2901 
båfs_dú_ôem
 *
di
;

2902 
båfs_å™s_h™dÀ
 *
å™s
;

2903 
båfs_∑th
 *
∑th
 = 
NULL
;

2904 
båfs_disk_key
 
disk_key
;

2905 
fs¸y±_°r
 
«me
 = 
	`FSTR_INIT
("default", 7);

2906 
u64
 
obje˘id
 = 0;

2907 
u64
 
dú_id
;

2908 
ªt
;

2910 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

2911  -
EPERM
;

2913 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

2914 i‡(
ªt
)

2915  
ªt
;

2917 i‡(
	`c›y_‰om_u£r
(&
obje˘id
, 
¨gp
, (objectid))) {

2918 
ªt
 = -
EFAULT
;

2919 
out
;

2922 i‡(!
obje˘id
)

2923 
obje˘id
 = 
BTRFS_FS_TREE_OBJECTID
;

2925 
√w_roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
obje˘id
, 
åue
);

2926 i‡(
	`IS_ERR
(
√w_roŸ
)) {

2927 
ªt
 = 
	`PTR_ERR
(
√w_roŸ
);

2928 
out
;

2930 i‡(!
	`is_f°ªe
(
√w_roŸ
->
roŸ_key
.
obje˘id
)) {

2931 
ªt
 = -
ENOENT
;

2932 
out_‰ì
;

2935 
∑th
 = 
	`båfs_Æloc_∑th
();

2936 i‡(!
∑th
) {

2937 
ªt
 = -
ENOMEM
;

2938 
out_‰ì
;

2941 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 1);

2942 i‡(
	`IS_ERR
(
å™s
)) {

2943 
ªt
 = 
	`PTR_ERR
(
å™s
);

2944 
out_‰ì
;

2947 
dú_id
 = 
	`båfs_su≥r_roŸ_dú
(
fs_öfo
->
su≥r_c›y
);

2948 
di
 = 
	`båfs_lookup_dú_ôem
(
å™s
, 
fs_öfo
->
åì_roŸ
, 
∑th
,

2949 
dú_id
, &
«me
, 1);

2950 i‡(
	`IS_ERR_OR_NULL
(
di
)) {

2951 
	`båfs_ªÀa£_∑th
(
∑th
);

2952 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

2953 
	`båfs_îr
(
fs_öfo
,

2955 
ªt
 = -
ENOENT
;

2956 
out_‰ì
;

2959 
	`båfs_˝u_key_to_disk
(&
disk_key
, &
√w_roŸ
->
roŸ_key
);

2960 
	`båfs_£t_dú_ôem_key
(
∑th
->
nodes
[0], 
di
, &
disk_key
);

2961 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑th
->
nodes
[0]);

2962 
	`båfs_ªÀa£_∑th
(
∑th
);

2964 
	`båfs_£t_fs_öcom∑t
(
fs_öfo
, 
DEFAULT_SUBVOL
);

2965 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

2966 
out_‰ì
:

2967 
	`båfs_put_roŸ
(
√w_roŸ
);

2968 
	`båfs_‰ì_∑th
(
∑th
);

2969 
out
:

2970 
	`m¡_dr›_wrôe_fûe
(
fûe
);

2971  
ªt
;

2972 
	}
}

2974 
	$gë_block_group_öfo
(
li°_hód
 *
groups_li°
,

2975 
båfs_io˘l_•a˚_öfo
 *
•a˚
)

2977 
båfs_block_group
 *
block_group
;

2979 
•a˚
->
tŸÆ_byãs
 = 0;

2980 
•a˚
->
u£d_byãs
 = 0;

2981 
•a˚
->
Êags
 = 0;

2982 
	`li°_f‹_óch_íåy
(
block_group
, 
groups_li°
, 
li°
) {

2983 
•a˚
->
Êags
 = 
block_group
->flags;

2984 
•a˚
->
tŸÆ_byãs
 +
block_group
->
Àngth
;

2985 
•a˚
->
u£d_byãs
 +
block_group
->
u£d
;

2987 
	}
}

2989 
	$båfs_io˘l_•a˚_öfo
(
båfs_fs_öfo
 *
fs_öfo
,

2990 
__u£r
 *
¨g
)

2992 
båfs_io˘l_•a˚_¨gs
 
•a˚_¨gs
 = { 0 };

2993 
båfs_io˘l_•a˚_öfo
 
•a˚
;

2994 
båfs_io˘l_•a˚_öfo
 *
de°
;

2995 
båfs_io˘l_•a˚_öfo
 *
de°_‹ig
;

2996 
båfs_io˘l_•a˚_öfo
 
__u£r
 *
u£r_de°
;

2997 
båfs_•a˚_öfo
 *
öfo
;

2998 c⁄° 
u64
 
ty≥s
[] = {

2999 
BTRFS_BLOCK_GROUP_DATA
,

3000 
BTRFS_BLOCK_GROUP_SYSTEM
,

3001 
BTRFS_BLOCK_GROUP_METADATA
,

3002 
BTRFS_BLOCK_GROUP_DATA
 | 
BTRFS_BLOCK_GROUP_METADATA


3004 
num_ty≥s
 = 4;

3005 
Æloc_size
;

3006 
ªt
 = 0;

3007 
u64
 
¶Ÿ_cou¡
 = 0;

3008 
i
, 
c
;

3010 i‡(
	`c›y_‰om_u£r
(&
•a˚_¨gs
,

3011 (
båfs_io˘l_•a˚_¨gs
 
__u£r
 *)
¨g
,

3012 (
•a˚_¨gs
)))

3013  -
EFAULT
;

3015 
i
 = 0; i < 
num_ty≥s
; i++) {

3016 
båfs_•a˚_öfo
 *
tmp
;

3018 
öfo
 = 
NULL
;

3019 
	`li°_f‹_óch_íåy
(
tmp
, &
fs_öfo
->
•a˚_öfo
, 
li°
) {

3020 i‡(
tmp
->
Êags
 =
ty≥s
[
i
]) {

3021 
öfo
 = 
tmp
;

3026 i‡(!
öfo
)

3029 
	`down_ªad
(&
öfo
->
groups_£m
);

3030 
c
 = 0; c < 
BTRFS_NR_RAID_TYPES
; c++) {

3031 i‡(!
	`li°_em±y
(&
öfo
->
block_groups
[
c
]))

3032 
¶Ÿ_cou¡
++;

3034 
	`up_ªad
(&
öfo
->
groups_£m
);

3040 
¶Ÿ_cou¡
++;

3043 i‡(
•a˚_¨gs
.
•a˚_¶Ÿs
 == 0) {

3044 
•a˚_¨gs
.
tŸÆ_•a˚s
 = 
¶Ÿ_cou¡
;

3045 
out
;

3048 
¶Ÿ_cou¡
 = 
	`mö_t
(
u64
, 
•a˚_¨gs
.
•a˚_¶Ÿs
, slot_count);

3050 
Æloc_size
 = (*
de°
Ë* 
¶Ÿ_cou¡
;

3055 i‡(
Æloc_size
 > 
PAGE_SIZE
)

3056  -
ENOMEM
;

3058 
•a˚_¨gs
.
tŸÆ_•a˚s
 = 0;

3059 
de°
 = 
	`kmÆloc
(
Æloc_size
, 
GFP_KERNEL
);

3060 i‡(!
de°
)

3061  -
ENOMEM
;

3062 
de°_‹ig
 = 
de°
;

3065 
i
 = 0; i < 
num_ty≥s
; i++) {

3066 
båfs_•a˚_öfo
 *
tmp
;

3068 i‡(!
¶Ÿ_cou¡
)

3071 
öfo
 = 
NULL
;

3072 
	`li°_f‹_óch_íåy
(
tmp
, &
fs_öfo
->
•a˚_öfo
, 
li°
) {

3073 i‡(
tmp
->
Êags
 =
ty≥s
[
i
]) {

3074 
öfo
 = 
tmp
;

3079 i‡(!
öfo
)

3081 
	`down_ªad
(&
öfo
->
groups_£m
);

3082 
c
 = 0; c < 
BTRFS_NR_RAID_TYPES
; c++) {

3083 i‡(!
	`li°_em±y
(&
öfo
->
block_groups
[
c
])) {

3084 
	`gë_block_group_öfo
(&
öfo
->
block_groups
[
c
],

3085 &
•a˚
);

3086 
	`mem˝y
(
de°
, &
•a˚
, (space));

3087 
de°
++;

3088 
•a˚_¨gs
.
tŸÆ_•a˚s
++;

3089 
¶Ÿ_cou¡
--;

3091 i‡(!
¶Ÿ_cou¡
)

3094 
	`up_ªad
(&
öfo
->
groups_£m
);

3100 i‡(
¶Ÿ_cou¡
) {

3101 
båfs_block_rsv
 *
block_rsv
 = &
fs_öfo
->
globÆ_block_rsv
;

3103 
	`•ö_lock
(&
block_rsv
->
lock
);

3104 
•a˚
.
tŸÆ_byãs
 = 
block_rsv
->
size
;

3105 
•a˚
.
u£d_byãs
 = 
block_rsv
->
size
 - block_rsv->
ª£rved
;

3106 
	`•ö_u∆ock
(&
block_rsv
->
lock
);

3107 
•a˚
.
Êags
 = 
BTRFS_SPACE_INFO_GLOBAL_RSV
;

3108 
	`mem˝y
(
de°
, &
•a˚
, (space));

3109 
•a˚_¨gs
.
tŸÆ_•a˚s
++;

3112 
u£r_de°
 = (
båfs_io˘l_•a˚_öfo
 
__u£r
 *)

3113 (
¨g
 + (
båfs_io˘l_•a˚_¨gs
));

3115 i‡(
	`c›y_to_u£r
(
u£r_de°
, 
de°_‹ig
, 
Æloc_size
))

3116 
ªt
 = -
EFAULT
;

3118 
	`k‰ì
(
de°_‹ig
);

3119 
out
:

3120 i‡(
ªt
 =0 && 
	`c›y_to_u£r
(
¨g
, &
•a˚_¨gs
, (space_args)))

3121 
ªt
 = -
EFAULT
;

3123  
ªt
;

3124 
	}
}

3126 
noölöe
 
	$båfs_io˘l_°¨t_sync
(
båfs_roŸ
 *
roŸ
,

3127 
__u£r
 *
¨gp
)

3129 
båfs_å™s_h™dÀ
 *
å™s
;

3130 
u64
 
å™sid
;

3137 
	`båfs_‹ph™_˛ónup
(
roŸ
);

3139 
å™s
 = 
	`båfs_©èch_å™ß˘i⁄_b¨rõr
(
roŸ
);

3140 i‡(
	`IS_ERR
(
å™s
)) {

3141 i‡(
	`PTR_ERR
(
å™s
Ë!-
ENOENT
)

3142  
	`PTR_ERR
(
å™s
);

3145 
å™sid
 = 
roŸ
->
fs_öfo
->
œ°_å™s_commôãd
;

3146 
out
;

3148 
å™sid
 = 
å™s
->transid;

3149 
	`båfs_commô_å™ß˘i⁄_async
(
å™s
);

3150 
out
:

3151 i‡(
¨gp
)

3152 i‡(
	`c›y_to_u£r
(
¨gp
, &
å™sid
, (transid)))

3153  -
EFAULT
;

3155 
	}
}

3157 
noölöe
 
	$båfs_io˘l_waô_sync
(
båfs_fs_öfo
 *
fs_öfo
,

3158 
__u£r
 *
¨gp
)

3161 
u64
 
å™sid
 = 0;

3163 i‡(
¨gp
)

3164 i‡(
	`c›y_‰om_u£r
(&
å™sid
, 
¨gp
, (transid)))

3165  -
EFAULT
;

3167  
	`båfs_waô_f‹_commô
(
fs_öfo
, 
å™sid
);

3168 
	}
}

3170 
	$båfs_io˘l_s¸ub
(
fûe
 *fûe, 
__u£r
 *
¨g
)

3172 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
	`fûe_öode
(
fûe
)->
i_sb
);

3173 
båfs_io˘l_s¸ub_¨gs
 *
ß
;

3174 
ªt
;

3176 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

3177  -
EPERM
;

3179 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
EXTENT_TREE_V2
)) {

3180 
	`båfs_îr
(
fs_öfo
, "scrub isÇot supported onÉxtentÅree v2 yet");

3181  -
EINVAL
;

3184 
ß
 = 
	`memdup_u£r
(
¨g
, (*sa));

3185 i‡(
	`IS_ERR
(
ß
))

3186  
	`PTR_ERR
(
ß
);

3188 i‡(
ß
->
Êags
 & ~
BTRFS_SCRUB_SUPPORTED_FLAGS
) {

3189 
ªt
 = -
EOPNOTSUPP
;

3190 
out
;

3193 i‡(!(
ß
->
Êags
 & 
BTRFS_SCRUB_READONLY
)) {

3194 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

3195 i‡(
ªt
)

3196 
out
;

3199 
ªt
 = 
	`båfs_s¸ub_dev
(
fs_öfo
, 
ß
->
devid
, sa->
°¨t
, sa->
íd
,

3200 &
ß
->
¥ogªss
, sa->
Êags
 & 
BTRFS_SCRUB_READONLY
,

3215 i‡(
	`c›y_to_u£r
(
¨g
, 
ß
, (*sa)))

3216 
ªt
 = -
EFAULT
;

3218 i‡(!(
ß
->
Êags
 & 
BTRFS_SCRUB_READONLY
))

3219 
	`m¡_dr›_wrôe_fûe
(
fûe
);

3220 
out
:

3221 
	`k‰ì
(
ß
);

3222  
ªt
;

3223 
	}
}

3225 
	$båfs_io˘l_s¸ub_ˇn˚l
(
båfs_fs_öfo
 *
fs_öfo
)

3227 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

3228  -
EPERM
;

3230  
	`båfs_s¸ub_ˇn˚l
(
fs_öfo
);

3231 
	}
}

3233 
	$båfs_io˘l_s¸ub_¥ogªss
(
båfs_fs_öfo
 *
fs_öfo
,

3234 
__u£r
 *
¨g
)

3236 
båfs_io˘l_s¸ub_¨gs
 *
ß
;

3237 
ªt
;

3239 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

3240  -
EPERM
;

3242 
ß
 = 
	`memdup_u£r
(
¨g
, (*sa));

3243 i‡(
	`IS_ERR
(
ß
))

3244  
	`PTR_ERR
(
ß
);

3246 
ªt
 = 
	`båfs_s¸ub_¥ogªss
(
fs_öfo
, 
ß
->
devid
, &ß->
¥ogªss
);

3248 i‡(
ªt
 =0 && 
	`c›y_to_u£r
(
¨g
, 
ß
, (*sa)))

3249 
ªt
 = -
EFAULT
;

3251 
	`k‰ì
(
ß
);

3252  
ªt
;

3253 
	}
}

3255 
	$båfs_io˘l_gë_dev_°©s
(
båfs_fs_öfo
 *
fs_öfo
,

3256 
__u£r
 *
¨g
)

3258 
båfs_io˘l_gë_dev_°©s
 *
ß
;

3259 
ªt
;

3261 
ß
 = 
	`memdup_u£r
(
¨g
, (*sa));

3262 i‡(
	`IS_ERR
(
ß
))

3263  
	`PTR_ERR
(
ß
);

3265 i‡((
ß
->
Êags
 & 
BTRFS_DEV_STATS_RESET
Ë&& !
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
)) {

3266 
	`k‰ì
(
ß
);

3267  -
EPERM
;

3270 
ªt
 = 
	`båfs_gë_dev_°©s
(
fs_öfo
, 
ß
);

3272 i‡(
ªt
 =0 && 
	`c›y_to_u£r
(
¨g
, 
ß
, (*sa)))

3273 
ªt
 = -
EFAULT
;

3275 
	`k‰ì
(
ß
);

3276  
ªt
;

3277 
	}
}

3279 
	$båfs_io˘l_dev_ª∂a˚
(
båfs_fs_öfo
 *
fs_öfo
,

3280 
__u£r
 *
¨g
)

3282 
båfs_io˘l_dev_ª∂a˚_¨gs
 *
p
;

3283 
ªt
;

3285 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

3286  -
EPERM
;

3288 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
EXTENT_TREE_V2
)) {

3289 
	`båfs_îr
(
fs_öfo
, "deviceÑeplaceÇot supported onÉxtentÅree v2 yet");

3290  -
EINVAL
;

3293 
p
 = 
	`memdup_u£r
(
¨g
, (*p));

3294 i‡(
	`IS_ERR
(
p
))

3295  
	`PTR_ERR
(
p
);

3297 
p
->
cmd
) {

3298 
BTRFS_IOCTL_DEV_REPLACE_CMD_START
:

3299 i‡(
	`sb_rd⁄ly
(
fs_öfo
->
sb
)) {

3300 
ªt
 = -
EROFS
;

3301 
out
;

3303 i‡(!
	`båfs_ex˛›_°¨t
(
fs_öfo
, 
BTRFS_EXCLOP_DEV_REPLACE
)) {

3304 
ªt
 = 
BTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
;

3306 
ªt
 = 
	`båfs_dev_ª∂a˚_by_io˘l
(
fs_öfo
, 
p
);

3307 
	`båfs_ex˛›_föish
(
fs_öfo
);

3310 
BTRFS_IOCTL_DEV_REPLACE_CMD_STATUS
:

3311 
	`båfs_dev_ª∂a˚_°©us
(
fs_öfo
, 
p
);

3312 
ªt
 = 0;

3314 
BTRFS_IOCTL_DEV_REPLACE_CMD_CANCEL
:

3315 
p
->
ªsu…
 = 
	`båfs_dev_ª∂a˚_ˇn˚l
(
fs_öfo
);

3316 
ªt
 = 0;

3319 
ªt
 = -
EINVAL
;

3323 i‡((
ªt
 =0 ||Ñë =-
ECANCELED
Ë&& 
	`c›y_to_u£r
(
¨g
, 
p
, (*p)))

3324 
ªt
 = -
EFAULT
;

3325 
out
:

3326 
	`k‰ì
(
p
);

3327  
ªt
;

3328 
	}
}

3330 
	$båfs_io˘l_öo_to_∑th
(
båfs_roŸ
 *
roŸ
, 
__u£r
 *
¨g
)

3332 
ªt
 = 0;

3333 
i
;

3334 
u64
 
ªl_±r
;

3335 
size
;

3336 
båfs_io˘l_öo_∑th_¨gs
 *
ùa
 = 
NULL
;

3337 
öode_fs_∑ths
 *
ù©h
 = 
NULL
;

3338 
båfs_∑th
 *
∑th
;

3340 i‡(!
	`ˇ∑bÀ
(
CAP_DAC_READ_SEARCH
))

3341  -
EPERM
;

3343 
∑th
 = 
	`båfs_Æloc_∑th
();

3344 i‡(!
∑th
) {

3345 
ªt
 = -
ENOMEM
;

3346 
out
;

3349 
ùa
 = 
	`memdup_u£r
(
¨g
, (*ipa));

3350 i‡(
	`IS_ERR
(
ùa
)) {

3351 
ªt
 = 
	`PTR_ERR
(
ùa
);

3352 
ùa
 = 
NULL
;

3353 
out
;

3356 
size
 = 
	`mö_t
(
u32
, 
ùa
->size, 4096);

3357 
ù©h
 = 
	`öô_ù©h
(
size
, 
roŸ
, 
∑th
);

3358 i‡(
	`IS_ERR
(
ù©h
)) {

3359 
ªt
 = 
	`PTR_ERR
(
ù©h
);

3360 
ù©h
 = 
NULL
;

3361 
out
;

3364 
ªt
 = 
	`∑ths_‰om_öode
(
ùa
->
öum
, 
ù©h
);

3365 i‡(
ªt
 < 0)

3366 
out
;

3368 
i
 = 0; i < 
ù©h
->
f•©h
->
ñem_˙t
; ++i) {

3369 
ªl_±r
 = 
ù©h
->
f•©h
->
vÆ
[
i
] -

3370 (
u64
)()
ù©h
->
f•©h
->
vÆ
;

3371 
ù©h
->
f•©h
->
vÆ
[
i
] = 
ªl_±r
;

3374 
	`båfs_‰ì_∑th
(
∑th
);

3375 
∑th
 = 
NULL
;

3376 
ªt
 = 
	`c›y_to_u£r
((
__u£r
 *)()
ùa
->
f•©h
,

3377 
ù©h
->
f•©h
, 
size
);

3378 i‡(
ªt
) {

3379 
ªt
 = -
EFAULT
;

3380 
out
;

3383 
out
:

3384 
	`båfs_‰ì_∑th
(
∑th
);

3385 
	`‰ì_ù©h
(
ù©h
);

3386 
	`k‰ì
(
ùa
);

3388  
ªt
;

3389 
	}
}

3391 
	$båfs_io˘l_logiˇl_to_öo
(
båfs_fs_öfo
 *
fs_öfo
,

3392 
__u£r
 *
¨g
, 
vîsi⁄
)

3394 
ªt
 = 0;

3395 
size
;

3396 
båfs_io˘l_logiˇl_öo_¨gs
 *
loi
;

3397 
båfs_d©a_c⁄èöî
 *
öodes
 = 
NULL
;

3398 
båfs_∑th
 *
∑th
 = 
NULL
;

3399 
boﬁ
 
ign‹e_off£t
;

3401 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

3402  -
EPERM
;

3404 
loi
 = 
	`memdup_u£r
(
¨g
, (*loi));

3405 i‡(
	`IS_ERR
(
loi
))

3406  
	`PTR_ERR
(
loi
);

3408 i‡(
vîsi⁄
 == 1) {

3409 
ign‹e_off£t
 = 
Ál£
;

3410 
size
 = 
	`mö_t
(
u32
, 
loi
->size, 
SZ_64K
);

3413 i‡(
	`memchr_öv
(
loi
->
ª£rved
, 0, (loi->reserved))) {

3414 
ªt
 = -
EINVAL
;

3415 
out_loi
;

3418 i‡(
loi
->
Êags
 & ~(
BTRFS_LOGICAL_INO_ARGS_IGNORE_OFFSET
)) {

3419 
ªt
 = -
EINVAL
;

3420 
out_loi
;

3422 
ign‹e_off£t
 = 
loi
->
Êags
 & 
BTRFS_LOGICAL_INO_ARGS_IGNORE_OFFSET
;

3423 
size
 = 
	`mö_t
(
u32
, 
loi
->size, 
SZ_16M
);

3426 
öodes
 = 
	`öô_d©a_c⁄èöî
(
size
);

3427 i‡(
	`IS_ERR
(
öodes
)) {

3428 
ªt
 = 
	`PTR_ERR
(
öodes
);

3429 
out_loi
;

3432 
∑th
 = 
	`båfs_Æloc_∑th
();

3433 i‡(!
∑th
) {

3434 
ªt
 = -
ENOMEM
;

3435 
out
;

3437 
ªt
 = 
	`ôî©e_öodes_‰om_logiˇl
(
loi
->
logiˇl
, 
fs_öfo
, 
∑th
,

3438 
öodes
, 
ign‹e_off£t
);

3439 
	`båfs_‰ì_∑th
(
∑th
);

3440 i‡(
ªt
 =-
EINVAL
)

3441 
ªt
 = -
ENOENT
;

3442 i‡(
ªt
 < 0)

3443 
out
;

3445 
ªt
 = 
	`c›y_to_u£r
((
__u£r
 *)()
loi
->
öodes
, inodes,

3446 
size
);

3447 i‡(
ªt
)

3448 
ªt
 = -
EFAULT
;

3450 
out
:

3451 
	`kv‰ì
(
öodes
);

3452 
out_loi
:

3453 
	`k‰ì
(
loi
);

3455  
ªt
;

3456 
	}
}

3458 
	$båfs_upd©e_io˘l_bÆ™˚_¨gs
(
båfs_fs_öfo
 *
fs_öfo
,

3459 
båfs_io˘l_bÆ™˚_¨gs
 *
b¨gs
)

3461 
båfs_bÆ™˚_c⁄åﬁ
 *
b˘l
 = 
fs_öfo
->
bÆ™˚_˘l
;

3463 
b¨gs
->
Êags
 = 
b˘l
->flags;

3465 i‡(
	`ã°_bô
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_öfo
->
Êags
))

3466 
b¨gs
->
°©e
 |
BTRFS_BALANCE_STATE_RUNNING
;

3467 i‡(
	`©omic_ªad
(&
fs_öfo
->
bÆ™˚_∑u£_ªq
))

3468 
b¨gs
->
°©e
 |
BTRFS_BALANCE_STATE_PAUSE_REQ
;

3469 i‡(
	`©omic_ªad
(&
fs_öfo
->
bÆ™˚_ˇn˚l_ªq
))

3470 
b¨gs
->
°©e
 |
BTRFS_BALANCE_STATE_CANCEL_REQ
;

3472 
	`mem˝y
(&
b¨gs
->
d©a
, &
b˘l
->data, (bargs->data));

3473 
	`mem˝y
(&
b¨gs
->
mëa
, &
b˘l
->meta, (bargs->meta));

3474 
	`mem˝y
(&
b¨gs
->
sys
, &
b˘l
->sys, (bargs->sys));

3476 
	`•ö_lock
(&
fs_öfo
->
bÆ™˚_lock
);

3477 
	`mem˝y
(&
b¨gs
->
°©
, &
b˘l
->stat, (bargs->stat));

3478 
	`•ö_u∆ock
(&
fs_öfo
->
bÆ™˚_lock
);

3479 
	}
}

3492 
	$båfs_åy_lock_bÆ™˚
(
båfs_fs_öfo
 *
fs_öfo
, 
boﬁ
 *
ex˛_acquúed
)

3494 
ªt
;

3503 i‡(
	`båfs_ex˛›_°¨t
(
fs_öfo
, 
BTRFS_EXCLOP_BALANCE
)) {

3504 *
ex˛_acquúed
 = 
åue
;

3505 
	`muãx_lock
(&
fs_öfo
->
bÆ™˚_muãx
);

3509 
	`muãx_lock
(&
fs_öfo
->
bÆ™˚_muãx
);

3510 i‡(
fs_öfo
->
bÆ™˚_˘l
) {

3512 i‡(
	`ã°_bô
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_öfo
->
Êags
)) {

3514 
ªt
 = -
EINPROGRESS
;

3515 
out_Áûuª
;

3518 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

3523 
	`muãx_lock
(&
fs_öfo
->
bÆ™˚_muãx
);

3525 i‡(
fs_öfo
->
bÆ™˚_˘l
 &&

3526 !
	`ã°_bô
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_öfo
->
Êags
)) {

3528 *
ex˛_acquúed
 = 
Ál£
;

3534 
ªt
 = 
BTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
;

3535 
out_Áûuª
;

3538 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

3541 
out_Áûuª
:

3542 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

3543 *
ex˛_acquúed
 = 
Ál£
;

3544  
ªt
;

3545 
	}
}

3547 
	$båfs_io˘l_bÆ™˚
(
fûe
 *fûe, 
__u£r
 *
¨g
)

3549 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
	`fûe_öode
(
fûe
))->root;

3550 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

3551 
båfs_io˘l_bÆ™˚_¨gs
 *
b¨gs
;

3552 
båfs_bÆ™˚_c⁄åﬁ
 *
b˘l
;

3553 
boﬁ
 
√ed_u∆ock
 = 
åue
;

3554 
ªt
;

3556 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

3557  -
EPERM
;

3559 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

3560 i‡(
ªt
)

3561  
ªt
;

3563 
b¨gs
 = 
	`memdup_u£r
(
¨g
, (*bargs));

3564 i‡(
	`IS_ERR
(
b¨gs
)) {

3565 
ªt
 = 
	`PTR_ERR
(
b¨gs
);

3566 
b¨gs
 = 
NULL
;

3567 
out
;

3570 
ªt
 = 
	`båfs_åy_lock_bÆ™˚
(
fs_öfo
, &
√ed_u∆ock
);

3571 i‡(
ªt
)

3572 
out
;

3574 
	`lockdï_as£π_hñd
(&
fs_öfo
->
bÆ™˚_muãx
);

3576 i‡(
b¨gs
->
Êags
 & 
BTRFS_BALANCE_RESUME
) {

3577 i‡(!
fs_öfo
->
bÆ™˚_˘l
) {

3578 
ªt
 = -
ENOTCONN
;

3579 
out_u∆ock
;

3582 
b˘l
 = 
fs_öfo
->
bÆ™˚_˘l
;

3583 
	`•ö_lock
(&
fs_öfo
->
bÆ™˚_lock
);

3584 
b˘l
->
Êags
 |
BTRFS_BALANCE_RESUME
;

3585 
	`•ö_u∆ock
(&
fs_öfo
->
bÆ™˚_lock
);

3586 
	`båfs_ex˛›_bÆ™˚
(
fs_öfo
, 
BTRFS_EXCLOP_BALANCE
);

3588 
do_bÆ™˚
;

3591 i‡(
b¨gs
->
Êags
 & ~(
BTRFS_BALANCE_ARGS_MASK
 | 
BTRFS_BALANCE_TYPE_MASK
)) {

3592 
ªt
 = -
EINVAL
;

3593 
out_u∆ock
;

3596 i‡(
fs_öfo
->
bÆ™˚_˘l
) {

3597 
ªt
 = -
EINPROGRESS
;

3598 
out_u∆ock
;

3601 
b˘l
 = 
	`kzÆloc
((*b˘l), 
GFP_KERNEL
);

3602 i‡(!
b˘l
) {

3603 
ªt
 = -
ENOMEM
;

3604 
out_u∆ock
;

3607 
	`mem˝y
(&
b˘l
->
d©a
, &
b¨gs
->data, (bctl->data));

3608 
	`mem˝y
(&
b˘l
->
mëa
, &
b¨gs
->meta, (bctl->meta));

3609 
	`mem˝y
(&
b˘l
->
sys
, &
b¨gs
->sys, (bctl->sys));

3611 
b˘l
->
Êags
 = 
b¨gs
->flags;

3612 
do_bÆ™˚
:

3619 
√ed_u∆ock
 = 
Ál£
;

3621 
ªt
 = 
	`båfs_bÆ™˚
(
fs_öfo
, 
b˘l
, 
b¨gs
);

3622 
b˘l
 = 
NULL
;

3624 i‡(
ªt
 =0 ||Ñë =-
ECANCELED
) {

3625 i‡(
	`c›y_to_u£r
(
¨g
, 
b¨gs
, (*bargs)))

3626 
ªt
 = -
EFAULT
;

3629 
	`k‰ì
(
b˘l
);

3630 
out_u∆ock
:

3631 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

3632 i‡(
√ed_u∆ock
)

3633 
	`båfs_ex˛›_föish
(
fs_öfo
);

3634 
out
:

3635 
	`m¡_dr›_wrôe_fûe
(
fûe
);

3636 
	`k‰ì
(
b¨gs
);

3637  
ªt
;

3638 
	}
}

3640 
	$båfs_io˘l_bÆ™˚_˘l
(
båfs_fs_öfo
 *
fs_öfo
, 
cmd
)

3642 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

3643  -
EPERM
;

3645 
cmd
) {

3646 
BTRFS_BALANCE_CTL_PAUSE
:

3647  
	`båfs_∑u£_bÆ™˚
(
fs_öfo
);

3648 
BTRFS_BALANCE_CTL_CANCEL
:

3649  
	`båfs_ˇn˚l_bÆ™˚
(
fs_öfo
);

3652  -
EINVAL
;

3653 
	}
}

3655 
	$båfs_io˘l_bÆ™˚_¥ogªss
(
båfs_fs_öfo
 *
fs_öfo
,

3656 
__u£r
 *
¨g
)

3658 
båfs_io˘l_bÆ™˚_¨gs
 *
b¨gs
;

3659 
ªt
 = 0;

3661 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

3662  -
EPERM
;

3664 
	`muãx_lock
(&
fs_öfo
->
bÆ™˚_muãx
);

3665 i‡(!
fs_öfo
->
bÆ™˚_˘l
) {

3666 
ªt
 = -
ENOTCONN
;

3667 
out
;

3670 
b¨gs
 = 
	`kzÆloc
((*b¨gs), 
GFP_KERNEL
);

3671 i‡(!
b¨gs
) {

3672 
ªt
 = -
ENOMEM
;

3673 
out
;

3676 
	`båfs_upd©e_io˘l_bÆ™˚_¨gs
(
fs_öfo
, 
b¨gs
);

3678 i‡(
	`c›y_to_u£r
(
¨g
, 
b¨gs
, (*bargs)))

3679 
ªt
 = -
EFAULT
;

3681 
	`k‰ì
(
b¨gs
);

3682 
out
:

3683 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

3684  
ªt
;

3685 
	}
}

3687 
	$båfs_io˘l_quŸa_˘l
(
fûe
 *fûe, 
__u£r
 *
¨g
)

3689 
öode
 *öodê
	`fûe_öode
(
fûe
);

3690 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

3691 
båfs_io˘l_quŸa_˘l_¨gs
 *
ß
;

3692 
ªt
;

3694 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

3695  -
EPERM
;

3697 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

3698 i‡(
ªt
)

3699  
ªt
;

3701 
ß
 = 
	`memdup_u£r
(
¨g
, (*sa));

3702 i‡(
	`IS_ERR
(
ß
)) {

3703 
ªt
 = 
	`PTR_ERR
(
ß
);

3704 
dr›_wrôe
;

3707 
	`down_wrôe
(&
fs_öfo
->
subvﬁ_£m
);

3709 
ß
->
cmd
) {

3710 
BTRFS_QUOTA_CTL_ENABLE
:

3711 
ªt
 = 
	`båfs_quŸa_íabÀ
(
fs_öfo
);

3713 
BTRFS_QUOTA_CTL_DISABLE
:

3714 
ªt
 = 
	`båfs_quŸa_dißbÀ
(
fs_öfo
);

3717 
ªt
 = -
EINVAL
;

3721 
	`k‰ì
(
ß
);

3722 
	`up_wrôe
(&
fs_öfo
->
subvﬁ_£m
);

3723 
dr›_wrôe
:

3724 
	`m¡_dr›_wrôe_fûe
(
fûe
);

3725  
ªt
;

3726 
	}
}

3728 
	$båfs_io˘l_qgroup_assign
(
fûe
 *fûe, 
__u£r
 *
¨g
)

3730 
öode
 *öodê
	`fûe_öode
(
fûe
);

3731 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

3732 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

3733 
båfs_io˘l_qgroup_assign_¨gs
 *
ß
;

3734 
båfs_å™s_h™dÀ
 *
å™s
;

3735 
ªt
;

3736 
îr
;

3738 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

3739  -
EPERM
;

3741 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

3742 i‡(
ªt
)

3743  
ªt
;

3745 
ß
 = 
	`memdup_u£r
(
¨g
, (*sa));

3746 i‡(
	`IS_ERR
(
ß
)) {

3747 
ªt
 = 
	`PTR_ERR
(
ß
);

3748 
dr›_wrôe
;

3751 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
roŸ
);

3752 i‡(
	`IS_ERR
(
å™s
)) {

3753 
ªt
 = 
	`PTR_ERR
(
å™s
);

3754 
out
;

3757 i‡(
ß
->
assign
) {

3758 
ªt
 = 
	`båfs_add_qgroup_ªœti⁄
(
å™s
, 
ß
->
§c
, sa->
d°
);

3760 
ªt
 = 
	`båfs_dñ_qgroup_ªœti⁄
(
å™s
, 
ß
->
§c
, sa->
d°
);

3764 
	`muãx_lock
(&
fs_öfo
->
qgroup_io˘l_lock
);

3765 
îr
 = 
	`båfs_run_qgroups
(
å™s
);

3766 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_io˘l_lock
);

3767 i‡(
îr
 < 0)

3768 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
îr
,

3770 
îr
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

3771 i‡(
îr
 && !
ªt
)

3772 
ªt
 = 
îr
;

3774 
out
:

3775 
	`k‰ì
(
ß
);

3776 
dr›_wrôe
:

3777 
	`m¡_dr›_wrôe_fûe
(
fûe
);

3778  
ªt
;

3779 
	}
}

3781 
	$båfs_io˘l_qgroup_¸óã
(
fûe
 *fûe, 
__u£r
 *
¨g
)

3783 
öode
 *öodê
	`fûe_öode
(
fûe
);

3784 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

3785 
båfs_io˘l_qgroup_¸óã_¨gs
 *
ß
;

3786 
båfs_å™s_h™dÀ
 *
å™s
;

3787 
ªt
;

3788 
îr
;

3790 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

3791  -
EPERM
;

3793 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

3794 i‡(
ªt
)

3795  
ªt
;

3797 
ß
 = 
	`memdup_u£r
(
¨g
, (*sa));

3798 i‡(
	`IS_ERR
(
ß
)) {

3799 
ªt
 = 
	`PTR_ERR
(
ß
);

3800 
dr›_wrôe
;

3803 i‡(!
ß
->
qgroupid
) {

3804 
ªt
 = -
EINVAL
;

3805 
out
;

3808 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
roŸ
);

3809 i‡(
	`IS_ERR
(
å™s
)) {

3810 
ªt
 = 
	`PTR_ERR
(
å™s
);

3811 
out
;

3814 i‡(
ß
->
¸óã
) {

3815 
ªt
 = 
	`båfs_¸óã_qgroup
(
å™s
, 
ß
->
qgroupid
);

3817 
ªt
 = 
	`båfs_ªmove_qgroup
(
å™s
, 
ß
->
qgroupid
);

3820 
îr
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

3821 i‡(
îr
 && !
ªt
)

3822 
ªt
 = 
îr
;

3824 
out
:

3825 
	`k‰ì
(
ß
);

3826 
dr›_wrôe
:

3827 
	`m¡_dr›_wrôe_fûe
(
fûe
);

3828  
ªt
;

3829 
	}
}

3831 
	$båfs_io˘l_qgroup_limô
(
fûe
 *fûe, 
__u£r
 *
¨g
)

3833 
öode
 *öodê
	`fûe_öode
(
fûe
);

3834 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

3835 
båfs_io˘l_qgroup_limô_¨gs
 *
ß
;

3836 
båfs_å™s_h™dÀ
 *
å™s
;

3837 
ªt
;

3838 
îr
;

3839 
u64
 
qgroupid
;

3841 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

3842  -
EPERM
;

3844 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

3845 i‡(
ªt
)

3846  
ªt
;

3848 
ß
 = 
	`memdup_u£r
(
¨g
, (*sa));

3849 i‡(
	`IS_ERR
(
ß
)) {

3850 
ªt
 = 
	`PTR_ERR
(
ß
);

3851 
dr›_wrôe
;

3854 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
roŸ
);

3855 i‡(
	`IS_ERR
(
å™s
)) {

3856 
ªt
 = 
	`PTR_ERR
(
å™s
);

3857 
out
;

3860 
qgroupid
 = 
ß
->qgroupid;

3861 i‡(!
qgroupid
) {

3863 
qgroupid
 = 
roŸ
->
roŸ_key
.
obje˘id
;

3866 
ªt
 = 
	`båfs_limô_qgroup
(
å™s
, 
qgroupid
, &
ß
->
lim
);

3868 
îr
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

3869 i‡(
îr
 && !
ªt
)

3870 
ªt
 = 
îr
;

3872 
out
:

3873 
	`k‰ì
(
ß
);

3874 
dr›_wrôe
:

3875 
	`m¡_dr›_wrôe_fûe
(
fûe
);

3876  
ªt
;

3877 
	}
}

3879 
	$båfs_io˘l_quŸa_ªsˇn
(
fûe
 *fûe, 
__u£r
 *
¨g
)

3881 
öode
 *öodê
	`fûe_öode
(
fûe
);

3882 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

3883 
båfs_io˘l_quŸa_ªsˇn_¨gs
 *
qß
;

3884 
ªt
;

3886 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

3887  -
EPERM
;

3889 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

3890 i‡(
ªt
)

3891  
ªt
;

3893 
qß
 = 
	`memdup_u£r
(
¨g
, (*qsa));

3894 i‡(
	`IS_ERR
(
qß
)) {

3895 
ªt
 = 
	`PTR_ERR
(
qß
);

3896 
dr›_wrôe
;

3899 i‡(
qß
->
Êags
) {

3900 
ªt
 = -
EINVAL
;

3901 
out
;

3904 
ªt
 = 
	`båfs_qgroup_ªsˇn
(
fs_öfo
);

3906 
out
:

3907 
	`k‰ì
(
qß
);

3908 
dr›_wrôe
:

3909 
	`m¡_dr›_wrôe_fûe
(
fûe
);

3910  
ªt
;

3911 
	}
}

3913 
	$båfs_io˘l_quŸa_ªsˇn_°©us
(
båfs_fs_öfo
 *
fs_öfo
,

3914 
__u£r
 *
¨g
)

3916 
båfs_io˘l_quŸa_ªsˇn_¨gs
 
qß
 = {0};

3918 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

3919  -
EPERM
;

3921 i‡(
fs_öfo
->
qgroup_Êags
 & 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
) {

3922 
qß
.
Êags
 = 1;

3923 
qß
.
¥ogªss
 = 
fs_öfo
->
qgroup_ªsˇn_¥ogªss
.
obje˘id
;

3926 i‡(
	`c›y_to_u£r
(
¨g
, &
qß
, (qsa)))

3927  -
EFAULT
;

3930 
	}
}

3932 
	$båfs_io˘l_quŸa_ªsˇn_waô
(
båfs_fs_öfo
 *
fs_öfo
,

3933 
__u£r
 *
¨g
)

3935 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

3936  -
EPERM
;

3938  
	`båfs_qgroup_waô_f‹_com∂ëi⁄
(
fs_öfo
, 
åue
);

3939 
	}
}

3941 
	$_båfs_io˘l_£t_ª˚ived_subvﬁ
(
fûe
 *file,

3942 
m¡_idm≠
 *
idm≠
,

3943 
båfs_io˘l_ª˚ived_subvﬁ_¨gs
 *
ß
)

3945 
öode
 *öodê
	`fûe_öode
(
fûe
);

3946 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

3947 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

3948 
båfs_roŸ_ôem
 *
roŸ_ôem
 = &
roŸ
->root_item;

3949 
båfs_å™s_h™dÀ
 *
å™s
;

3950 
time•ec64
 
˘
 = 
	`cuºít_time
(
öode
);

3951 
ªt
 = 0;

3952 
ª˚ived_uuid_ch™ged
;

3954 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
idm≠
, 
öode
))

3955  -
EPERM
;

3957 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

3958 i‡(
ªt
 < 0)

3959  
ªt
;

3961 
	`down_wrôe
(&
fs_öfo
->
subvﬁ_£m
);

3963 i‡(
	`båfs_öo
(
	`BTRFS_I
(
öode
)Ë!
BTRFS_FIRST_FREE_OBJECTID
) {

3964 
ªt
 = -
EINVAL
;

3965 
out
;

3968 i‡(
	`båfs_roŸ_ªad⁄ly
(
roŸ
)) {

3969 
ªt
 = -
EROFS
;

3970 
out
;

3977 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 3);

3978 i‡(
	`IS_ERR
(
å™s
)) {

3979 
ªt
 = 
	`PTR_ERR
(
å™s
);

3980 
å™s
 = 
NULL
;

3981 
out
;

3984 
ß
->
πønsid
 = 
å™s
->
å™sid
;

3985 
ß
->
πime
.
£c
 = 
˘
.
tv_£c
;

3986 
ß
->
πime
.
n£c
 = 
˘
.
tv_n£c
;

3988 
ª˚ived_uuid_ch™ged
 = 
	`memcmp
(
roŸ_ôem
->
ª˚ived_uuid
, 
ß
->
uuid
,

3989 
BTRFS_UUID_SIZE
);

3990 i‡(
ª˚ived_uuid_ch™ged
 &&

3991 !
	`båfs_is_em±y_uuid
(
roŸ_ôem
->
ª˚ived_uuid
)) {

3992 
ªt
 = 
	`båfs_uuid_åì_ªmove
(
å™s
, 
roŸ_ôem
->
ª˚ived_uuid
,

3993 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
,

3994 
roŸ
->
roŸ_key
.
obje˘id
);

3995 i‡(
ªt
 &&Ñë !-
ENOENT
) {

3996 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3997 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

3998 
out
;

4001 
	`mem˝y
(
roŸ_ôem
->
ª˚ived_uuid
, 
ß
->
uuid
, 
BTRFS_UUID_SIZE
);

4002 
	`båfs_£t_roŸ_°ønsid
(
roŸ_ôem
, 
ß
->
°ønsid
);

4003 
	`båfs_£t_roŸ_πønsid
(
roŸ_ôem
, 
ß
->
πønsid
);

4004 
	`båfs_£t_°ack_time•ec_£c
(&
roŸ_ôem
->
°ime
, 
ß
->°ime.
£c
);

4005 
	`båfs_£t_°ack_time•ec_n£c
(&
roŸ_ôem
->
°ime
, 
ß
->°ime.
n£c
);

4006 
	`båfs_£t_°ack_time•ec_£c
(&
roŸ_ôem
->
πime
, 
ß
->πime.
£c
);

4007 
	`båfs_£t_°ack_time•ec_n£c
(&
roŸ_ôem
->
πime
, 
ß
->πime.
n£c
);

4009 
ªt
 = 
	`båfs_upd©e_roŸ
(
å™s
, 
fs_öfo
->
åì_roŸ
,

4010 &
roŸ
->
roŸ_key
, &roŸ->
roŸ_ôem
);

4011 i‡(
ªt
 < 0) {

4012 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

4013 
out
;

4015 i‡(
ª˚ived_uuid_ch™ged
 && !
	`båfs_is_em±y_uuid
(
ß
->
uuid
)) {

4016 
ªt
 = 
	`båfs_uuid_åì_add
(
å™s
, 
ß
->
uuid
,

4017 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
,

4018 
roŸ
->
roŸ_key
.
obje˘id
);

4019 i‡(
ªt
 < 0 &&Ñë !-
EEXIST
) {

4020 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

4021 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

4022 
out
;

4025 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

4026 
out
:

4027 
	`up_wrôe
(&
fs_öfo
->
subvﬁ_£m
);

4028 
	`m¡_dr›_wrôe_fûe
(
fûe
);

4029  
ªt
;

4030 
	}
}

4032 #ifde‡
CONFIG_64BIT


4033 
	$båfs_io˘l_£t_ª˚ived_subvﬁ_32
(
fûe
 *file,

4034 
__u£r
 *
¨g
)

4036 
båfs_io˘l_ª˚ived_subvﬁ_¨gs_32
 *
¨gs32
 = 
NULL
;

4037 
båfs_io˘l_ª˚ived_subvﬁ_¨gs
 *
¨gs64
 = 
NULL
;

4038 
ªt
 = 0;

4040 
¨gs32
 = 
	`memdup_u£r
(
¨g
, (*args32));

4041 i‡(
	`IS_ERR
(
¨gs32
))

4042  
	`PTR_ERR
(
¨gs32
);

4044 
¨gs64
 = 
	`kmÆloc
((*¨gs64), 
GFP_KERNEL
);

4045 i‡(!
¨gs64
) {

4046 
ªt
 = -
ENOMEM
;

4047 
out
;

4050 
	`mem˝y
(
¨gs64
->
uuid
, 
¨gs32
->uuid, 
BTRFS_UUID_SIZE
);

4051 
¨gs64
->
°ønsid
 = 
¨gs32
->stransid;

4052 
¨gs64
->
πønsid
 = 
¨gs32
->rtransid;

4053 
¨gs64
->
°ime
.
£c
 = 
¨gs32
->stime.sec;

4054 
¨gs64
->
°ime
.
n£c
 = 
¨gs32
->stime.nsec;

4055 
¨gs64
->
πime
.
£c
 = 
¨gs32
->rtime.sec;

4056 
¨gs64
->
πime
.
n£c
 = 
¨gs32
->rtime.nsec;

4057 
¨gs64
->
Êags
 = 
¨gs32
->flags;

4059 
ªt
 = 
	`_båfs_io˘l_£t_ª˚ived_subvﬁ
(
fûe
, 
	`fûe_m¡_idm≠
(fûe), 
¨gs64
);

4060 i‡(
ªt
)

4061 
out
;

4063 
	`mem˝y
(
¨gs32
->
uuid
, 
¨gs64
->uuid, 
BTRFS_UUID_SIZE
);

4064 
¨gs32
->
°ønsid
 = 
¨gs64
->stransid;

4065 
¨gs32
->
πønsid
 = 
¨gs64
->rtransid;

4066 
¨gs32
->
°ime
.
£c
 = 
¨gs64
->stime.sec;

4067 
¨gs32
->
°ime
.
n£c
 = 
¨gs64
->stime.nsec;

4068 
¨gs32
->
πime
.
£c
 = 
¨gs64
->rtime.sec;

4069 
¨gs32
->
πime
.
n£c
 = 
¨gs64
->rtime.nsec;

4070 
¨gs32
->
Êags
 = 
¨gs64
->flags;

4072 
ªt
 = 
	`c›y_to_u£r
(
¨g
, 
¨gs32
, (*args32));

4073 i‡(
ªt
)

4074 
ªt
 = -
EFAULT
;

4076 
out
:

4077 
	`k‰ì
(
¨gs32
);

4078 
	`k‰ì
(
¨gs64
);

4079  
ªt
;

4080 
	}
}

4083 
	$båfs_io˘l_£t_ª˚ived_subvﬁ
(
fûe
 *file,

4084 
__u£r
 *
¨g
)

4086 
båfs_io˘l_ª˚ived_subvﬁ_¨gs
 *
ß
 = 
NULL
;

4087 
ªt
 = 0;

4089 
ß
 = 
	`memdup_u£r
(
¨g
, (*sa));

4090 i‡(
	`IS_ERR
(
ß
))

4091  
	`PTR_ERR
(
ß
);

4093 
ªt
 = 
	`_båfs_io˘l_£t_ª˚ived_subvﬁ
(
fûe
, 
	`fûe_m¡_idm≠
(fûe), 
ß
);

4095 i‡(
ªt
)

4096 
out
;

4098 
ªt
 = 
	`c›y_to_u£r
(
¨g
, 
ß
, (*sa));

4099 i‡(
ªt
)

4100 
ªt
 = -
EFAULT
;

4102 
out
:

4103 
	`k‰ì
(
ß
);

4104  
ªt
;

4105 
	}
}

4107 
	$båfs_io˘l_gë_f¶abñ
(
båfs_fs_öfo
 *
fs_öfo
,

4108 
__u£r
 *
¨g
)

4110 
size_t
 
Àn
;

4111 
ªt
;

4112 
œbñ
[
BTRFS_LABEL_SIZE
];

4114 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

4115 
	`mem˝y
(
œbñ
, 
fs_öfo
->
su≥r_c›y
->œbñ, 
BTRFS_LABEL_SIZE
);

4116 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

4118 
Àn
 = 
	`°∫Àn
(
œbñ
, 
BTRFS_LABEL_SIZE
);

4120 i‡(
Àn
 =
BTRFS_LABEL_SIZE
) {

4121 
	`båfs_w¨n
(
fs_öfo
,

4123 --
Àn
);

4126 
ªt
 = 
	`c›y_to_u£r
(
¨g
, 
œbñ
, 
Àn
);

4128  
ªt
 ? -
EFAULT
 : 0;

4129 
	}
}

4131 
	$båfs_io˘l_£t_f¶abñ
(
fûe
 *fûe, 
__u£r
 *
¨g
)

4133 
öode
 *öodê
	`fûe_öode
(
fûe
);

4134 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

4135 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

4136 
båfs_su≥r_block
 *
su≥r_block
 = 
fs_öfo
->
su≥r_c›y
;

4137 
båfs_å™s_h™dÀ
 *
å™s
;

4138 
œbñ
[
BTRFS_LABEL_SIZE
];

4139 
ªt
;

4141 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

4142  -
EPERM
;

4144 i‡(
	`c›y_‰om_u£r
(
œbñ
, 
¨g
, (label)))

4145  -
EFAULT
;

4147 i‡(
	`°∫Àn
(
œbñ
, 
BTRFS_LABEL_SIZE
) == BTRFS_LABEL_SIZE) {

4148 
	`båfs_îr
(
fs_öfo
,

4150 
BTRFS_LABEL_SIZE
 - 1);

4151  -
EINVAL
;

4154 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

4155 i‡(
ªt
)

4156  
ªt
;

4158 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

4159 i‡(
	`IS_ERR
(
å™s
)) {

4160 
ªt
 = 
	`PTR_ERR
(
å™s
);

4161 
out_u∆ock
;

4164 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

4165 
	`°r˝y
(
su≥r_block
->
œbñ
,Üabel);

4166 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

4167 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

4169 
out_u∆ock
:

4170 
	`m¡_dr›_wrôe_fûe
(
fûe
);

4171  
ªt
;

4172 
	}
}

4174 
	#INIT_FEATURE_FLAGS
(
suffix
) \

4175 { .
com∑t_Êags
 = 
BTRFS_FEATURE_COMPAT_
##
suffix
, \

4176 .
com∑t_ro_Êags
 = 
BTRFS_FEATURE_COMPAT_RO_
##
suffix
, \

4177 .
öcom∑t_Êags
 = 
BTRFS_FEATURE_INCOMPAT_
##
suffix
 }

	)

4179 
	$båfs_io˘l_gë_suµ‹ãd_„©uªs
(
__u£r
 *
¨g
)

4181 c⁄° 
båfs_io˘l_„©uª_Êags
 
„©uªs
[3] = {

4182 
	`INIT_FEATURE_FLAGS
(
SUPP
),

4183 
	`INIT_FEATURE_FLAGS
(
SAFE_SET
),

4184 
	`INIT_FEATURE_FLAGS
(
SAFE_CLEAR
)

4187 i‡(
	`c›y_to_u£r
(
¨g
, &
„©uªs
, (features)))

4188  -
EFAULT
;

4191 
	}
}

4193 
	$båfs_io˘l_gë_„©uªs
(
båfs_fs_öfo
 *
fs_öfo
,

4194 
__u£r
 *
¨g
)

4196 
båfs_su≥r_block
 *
su≥r_block
 = 
fs_öfo
->
su≥r_c›y
;

4197 
båfs_io˘l_„©uª_Êags
 
„©uªs
;

4199 
„©uªs
.
com∑t_Êags
 = 
	`båfs_su≥r_com∑t_Êags
(
su≥r_block
);

4200 
„©uªs
.
com∑t_ro_Êags
 = 
	`båfs_su≥r_com∑t_ro_Êags
(
su≥r_block
);

4201 
„©uªs
.
öcom∑t_Êags
 = 
	`båfs_su≥r_öcom∑t_Êags
(
su≥r_block
);

4203 i‡(
	`c›y_to_u£r
(
¨g
, &
„©uªs
, (features)))

4204  -
EFAULT
;

4207 
	}
}

4209 
	$check_„©uª_bôs
(
båfs_fs_öfo
 *
fs_öfo
,

4210 
båfs_„©uª_£t
 
£t
,

4211 
u64
 
ch™ge_mask
, u64 
Êags
, u64 
suµ‹ãd_Êags
,

4212 
u64
 
ß„_£t
, u64 
ß„_˛ór
)

4214 c⁄° *
ty≥
 = 
	`båfs_„©uª_£t_«me
(
£t
);

4215 *
«mes
;

4216 
u64
 
dißŒowed
, 
unsuµ‹ãd
;

4217 
u64
 
£t_mask
 = 
Êags
 & 
ch™ge_mask
;

4218 
u64
 
˛ór_mask
 = ~
Êags
 & 
ch™ge_mask
;

4220 
unsuµ‹ãd
 = 
£t_mask
 & ~
suµ‹ãd_Êags
;

4221 i‡(
unsuµ‹ãd
) {

4222 
«mes
 = 
	`båfs_¥öèbÀ_„©uªs
(
£t
, 
unsuµ‹ãd
);

4223 i‡(
«mes
) {

4224 
	`båfs_w¨n
(
fs_öfo
,

4226 
«mes
, 
	`°rchr
(names, ',') ? "s" : "");

4227 
	`k‰ì
(
«mes
);

4229 
	`båfs_w¨n
(
fs_öfo
,

4231 
ty≥
, 
unsuµ‹ãd
);

4232  -
EOPNOTSUPP
;

4235 
dißŒowed
 = 
£t_mask
 & ~
ß„_£t
;

4236 i‡(
dißŒowed
) {

4237 
«mes
 = 
	`båfs_¥öèbÀ_„©uªs
(
£t
, 
dißŒowed
);

4238 i‡(
«mes
) {

4239 
	`båfs_w¨n
(
fs_öfo
,

4241 
«mes
, 
	`°rchr
(names, ',') ? "s" : "");

4242 
	`k‰ì
(
«mes
);

4244 
	`båfs_w¨n
(
fs_öfo
,

4246 
ty≥
, 
dißŒowed
);

4247  -
EPERM
;

4250 
dißŒowed
 = 
˛ór_mask
 & ~
ß„_˛ór
;

4251 i‡(
dißŒowed
) {

4252 
«mes
 = 
	`båfs_¥öèbÀ_„©uªs
(
£t
, 
dißŒowed
);

4253 i‡(
«mes
) {

4254 
	`båfs_w¨n
(
fs_öfo
,

4256 
«mes
, 
	`°rchr
(names, ',') ? "s" : "");

4257 
	`k‰ì
(
«mes
);

4259 
	`båfs_w¨n
(
fs_öfo
,

4261 
ty≥
, 
dißŒowed
);

4262  -
EPERM
;

4266 
	}
}

4268 
	#check_„©uª
(
fs_öfo
, 
ch™ge_mask
, 
Êags
, 
mask_ba£
) \

4269 
	`check_„©uª_bôs
(
fs_öfo
, 
FEAT_
##
mask_ba£
, 
ch™ge_mask
, 
Êags
, \

4270 
BTRFS_FEATURE_
 ## 
mask_ba£
 ## 
_SUPP
, \

4271 
BTRFS_FEATURE_
 ## 
mask_ba£
 ## 
_SAFE_SET
, \

4272 
BTRFS_FEATURE_
 ## 
mask_ba£
 ## 
_SAFE_CLEAR
)

	)

4274 
	$båfs_io˘l_£t_„©uªs
(
fûe
 *fûe, 
__u£r
 *
¨g
)

4276 
öode
 *öodê
	`fûe_öode
(
fûe
);

4277 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

4278 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

4279 
båfs_su≥r_block
 *
su≥r_block
 = 
fs_öfo
->
su≥r_c›y
;

4280 
båfs_io˘l_„©uª_Êags
 
Êags
[2];

4281 
båfs_å™s_h™dÀ
 *
å™s
;

4282 
u64
 
√wÊags
;

4283 
ªt
;

4285 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

4286  -
EPERM
;

4288 i‡(
	`c›y_‰om_u£r
(
Êags
, 
¨g
, (flags)))

4289  -
EFAULT
;

4292 i‡(!
Êags
[0].
com∑t_Êags
 && !Êags[0].
com∑t_ro_Êags
 &&

4293 !
Êags
[0].
öcom∑t_Êags
)

4296 
ªt
 = 
	`check_„©uª
(
fs_öfo
, 
Êags
[0].
com∑t_Êags
,

4297 
Êags
[1].
com∑t_Êags
, 
COMPAT
);

4298 i‡(
ªt
)

4299  
ªt
;

4301 
ªt
 = 
	`check_„©uª
(
fs_öfo
, 
Êags
[0].
com∑t_ro_Êags
,

4302 
Êags
[1].
com∑t_ro_Êags
, 
COMPAT_RO
);

4303 i‡(
ªt
)

4304  
ªt
;

4306 
ªt
 = 
	`check_„©uª
(
fs_öfo
, 
Êags
[0].
öcom∑t_Êags
,

4307 
Êags
[1].
öcom∑t_Êags
, 
INCOMPAT
);

4308 i‡(
ªt
)

4309  
ªt
;

4311 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

4312 i‡(
ªt
)

4313  
ªt
;

4315 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

4316 i‡(
	`IS_ERR
(
å™s
)) {

4317 
ªt
 = 
	`PTR_ERR
(
å™s
);

4318 
out_dr›_wrôe
;

4321 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

4322 
√wÊags
 = 
	`båfs_su≥r_com∑t_Êags
(
su≥r_block
);

4323 
√wÊags
 |
Êags
[0].
com∑t_Êags
 & flags[1].compat_flags;

4324 
√wÊags
 &~(
Êags
[0].
com∑t_Êags
 & ~flags[1].compat_flags);

4325 
	`båfs_£t_su≥r_com∑t_Êags
(
su≥r_block
, 
√wÊags
);

4327 
√wÊags
 = 
	`båfs_su≥r_com∑t_ro_Êags
(
su≥r_block
);

4328 
√wÊags
 |
Êags
[0].
com∑t_ro_Êags
 & flags[1].compat_ro_flags;

4329 
√wÊags
 &~(
Êags
[0].
com∑t_ro_Êags
 & ~flags[1].compat_ro_flags);

4330 
	`båfs_£t_su≥r_com∑t_ro_Êags
(
su≥r_block
, 
√wÊags
);

4332 
√wÊags
 = 
	`båfs_su≥r_öcom∑t_Êags
(
su≥r_block
);

4333 
√wÊags
 |
Êags
[0].
öcom∑t_Êags
 & flags[1].incompat_flags;

4334 
√wÊags
 &~(
Êags
[0].
öcom∑t_Êags
 & ~flags[1].incompat_flags);

4335 
	`båfs_£t_su≥r_öcom∑t_Êags
(
su≥r_block
, 
√wÊags
);

4336 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

4338 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

4339 
out_dr›_wrôe
:

4340 
	`m¡_dr›_wrôe_fûe
(
fûe
);

4342  
ªt
;

4343 
	}
}

4345 
	$_båfs_io˘l_£nd
(
öode
 *öode, 
__u£r
 *
¨gp
, 
boﬁ
 
com∑t
)

4347 
båfs_io˘l_£nd_¨gs
 *
¨g
;

4348 
ªt
;

4350 i‡(
com∑t
) {

4351 #i‡
	`deföed
(
CONFIG_64BIT
Ë&& deföed(
CONFIG_COMPAT
)

4352 
båfs_io˘l_£nd_¨gs_32
 
¨gs32
 = { 0 };

4354 
ªt
 = 
	`c›y_‰om_u£r
(&
¨gs32
, 
¨gp
, (args32));

4355 i‡(
ªt
)

4356  -
EFAULT
;

4357 
¨g
 = 
	`kzÆloc
((*¨g), 
GFP_KERNEL
);

4358 i‡(!
¨g
)

4359  -
ENOMEM
;

4360 
¨g
->
£nd_fd
 = 
¨gs32
.send_fd;

4361 
¨g
->
˛⁄e_sour˚s_cou¡
 = 
¨gs32
.clone_sources_count;

4362 
¨g
->
˛⁄e_sour˚s
 = 
	`com∑t_±r
(
¨gs32
.clone_sources);

4363 
¨g
->
∑ª¡_roŸ
 = 
¨gs32
.parent_root;

4364 
¨g
->
Êags
 = 
¨gs32
.flags;

4365 
¨g
->
vîsi⁄
 = 
¨gs32
.version;

4366 
	`mem˝y
(
¨g
->
ª£rved
, 
¨gs32
.reserved,

4367 (
¨gs32
.
ª£rved
));

4369  -
ENOTTY
;

4372 
¨g
 = 
	`memdup_u£r
(
¨gp
, (*arg));

4373 i‡(
	`IS_ERR
(
¨g
))

4374  
	`PTR_ERR
(
¨g
);

4376 
ªt
 = 
	`båfs_io˘l_£nd
(
öode
, 
¨g
);

4377 
	`k‰ì
(
¨g
);

4378  
ªt
;

4379 
	}
}

4381 
	$båfs_io˘l_ícoded_ªad
(
fûe
 *fûe, 
__u£r
 *
¨gp
,

4382 
boﬁ
 
com∑t
)

4384 
båfs_io˘l_ícoded_io_¨gs
 
¨gs
 = { 0 };

4385 
size_t
 
c›y_íd_kî√l
 = 
	`off£to„nd
(
båfs_io˘l_ícoded_io_¨gs
,

4386 
Êags
);

4387 
size_t
 
c›y_íd
;

4388 
iovec
 
iov°ack
[
UIO_FASTIOV
];

4389 
iovec
 *
iov
 = 
iov°ack
;

4390 
iov_ôî
 
ôî
;

4391 
loff_t
 
pos
;

4392 
kiocb
 kiocb;

4393 
ssize_t
 
ªt
;

4395 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
)) {

4396 
ªt
 = -
EPERM
;

4397 
out_ac˘
;

4400 i‡(
com∑t
) {

4401 #i‡
	`deföed
(
CONFIG_64BIT
Ë&& deföed(
CONFIG_COMPAT
)

4402 
båfs_io˘l_ícoded_io_¨gs_32
 
¨gs32
;

4404 
c›y_íd
 = 
	`off£to„nd
(
båfs_io˘l_ícoded_io_¨gs_32
,

4405 
Êags
);

4406 i‡(
	`c›y_‰om_u£r
(&
¨gs32
, 
¨gp
, 
c›y_íd
)) {

4407 
ªt
 = -
EFAULT
;

4408 
out_ac˘
;

4410 
¨gs
.
iov
 = 
	`com∑t_±r
(
¨gs32
.iov);

4411 
¨gs
.
iov˙t
 = 
¨gs32
.iovcnt;

4412 
¨gs
.
off£t
 = 
¨gs32
.offset;

4413 
¨gs
.
Êags
 = 
¨gs32
.flags;

4415  -
ENOTTY
;

4418 
c›y_íd
 = 
c›y_íd_kî√l
;

4419 i‡(
	`c›y_‰om_u£r
(&
¨gs
, 
¨gp
, 
c›y_íd
)) {

4420 
ªt
 = -
EFAULT
;

4421 
out_ac˘
;

4424 i‡(
¨gs
.
Êags
 != 0) {

4425 
ªt
 = -
EINVAL
;

4426 
out_ac˘
;

4429 
ªt
 = 
	`imp‹t_iovec
(
ITER_DEST
, 
¨gs
.
iov
,árgs.
iov˙t
, 
	`ARRAY_SIZE
(
iov°ack
),

4430 &
iov
, &
ôî
);

4431 i‡(
ªt
 < 0)

4432 
out_ac˘
;

4434 i‡(
	`iov_ôî_cou¡
(&
ôî
) == 0) {

4435 
ªt
 = 0;

4436 
out_iov
;

4438 
pos
 = 
¨gs
.
off£t
;

4439 
ªt
 = 
	`rw_vîify_¨ó
(
READ
, 
fûe
, &
pos
, 
¨gs
.
Àn
);

4440 i‡(
ªt
 < 0)

4441 
out_iov
;

4443 
	`öô_sync_kiocb
(&
kiocb
, 
fûe
);

4444 
kiocb
.
ki_pos
 = 
pos
;

4446 
ªt
 = 
	`båfs_ícoded_ªad
(&
kiocb
, &
ôî
, &
¨gs
);

4447 i‡(
ªt
 >= 0) {

4448 
	`f¢Ÿify_ac˚ss
(
fûe
);

4449 i‡(
	`c›y_to_u£r
(
¨gp
 + 
c›y_íd
,

4450 (*)&
¨gs
 + 
c›y_íd_kî√l
,

4451 (
¨gs
Ë- 
c›y_íd_kî√l
))

4452 
ªt
 = -
EFAULT
;

4455 
out_iov
:

4456 
	`k‰ì
(
iov
);

4457 
out_ac˘
:

4458 i‡(
ªt
 > 0)

4459 
	`add_rch¨
(
cuºít
, 
ªt
);

4460 
	`öc_sys¸
(
cuºít
);

4461  
ªt
;

4462 
	}
}

4464 
	$båfs_io˘l_ícoded_wrôe
(
fûe
 *fûe, 
__u£r
 *
¨gp
, 
boﬁ
 
com∑t
)

4466 
båfs_io˘l_ícoded_io_¨gs
 
¨gs
;

4467 
iovec
 
iov°ack
[
UIO_FASTIOV
];

4468 
iovec
 *
iov
 = 
iov°ack
;

4469 
iov_ôî
 
ôî
;

4470 
loff_t
 
pos
;

4471 
kiocb
 kiocb;

4472 
ssize_t
 
ªt
;

4474 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
)) {

4475 
ªt
 = -
EPERM
;

4476 
out_ac˘
;

4479 i‡(!(
fûe
->
f_mode
 & 
FMODE_WRITE
)) {

4480 
ªt
 = -
EBADF
;

4481 
out_ac˘
;

4484 i‡(
com∑t
) {

4485 #i‡
	`deföed
(
CONFIG_64BIT
Ë&& deföed(
CONFIG_COMPAT
)

4486 
båfs_io˘l_ícoded_io_¨gs_32
 
¨gs32
;

4488 i‡(
	`c›y_‰om_u£r
(&
¨gs32
, 
¨gp
, (args32))) {

4489 
ªt
 = -
EFAULT
;

4490 
out_ac˘
;

4492 
¨gs
.
iov
 = 
	`com∑t_±r
(
¨gs32
.iov);

4493 
¨gs
.
iov˙t
 = 
¨gs32
.iovcnt;

4494 
¨gs
.
off£t
 = 
¨gs32
.offset;

4495 
¨gs
.
Êags
 = 
¨gs32
.flags;

4496 
¨gs
.
Àn
 = 
¨gs32
.len;

4497 
¨gs
.
u√ncoded_Àn
 = 
¨gs32
.unencoded_len;

4498 
¨gs
.
u√ncoded_off£t
 = 
¨gs32
.unencoded_offset;

4499 
¨gs
.
com¥essi⁄
 = 
¨gs32
.compression;

4500 
¨gs
.
í¸y±i⁄
 = 
¨gs32
.encryption;

4501 
	`mem˝y
(
¨gs
.
ª£rved
, 
¨gs32
.reserved, (args.reserved));

4503  -
ENOTTY
;

4506 i‡(
	`c›y_‰om_u£r
(&
¨gs
, 
¨gp
, (args))) {

4507 
ªt
 = -
EFAULT
;

4508 
out_ac˘
;

4512 
ªt
 = -
EINVAL
;

4513 i‡(
¨gs
.
Êags
 != 0)

4514 
out_ac˘
;

4515 i‡(
	`memchr_öv
(
¨gs
.
ª£rved
, 0, (args.reserved)))

4516 
out_ac˘
;

4517 i‡(
¨gs
.
com¥essi⁄
 =
BTRFS_ENCODED_IO_COMPRESSION_NONE
 &&

4518 
¨gs
.
í¸y±i⁄
 =
BTRFS_ENCODED_IO_ENCRYPTION_NONE
)

4519 
out_ac˘
;

4520 i‡(
¨gs
.
com¥essi⁄
 >
BTRFS_ENCODED_IO_COMPRESSION_TYPES
 ||

4521 
¨gs
.
í¸y±i⁄
 >
BTRFS_ENCODED_IO_ENCRYPTION_TYPES
)

4522 
out_ac˘
;

4523 i‡(
¨gs
.
u√ncoded_off£t
 >árgs.
u√ncoded_Àn
)

4524 
out_ac˘
;

4525 i‡(
¨gs
.
Àn
 >árgs.
u√ncoded_Àn
 -árgs.
u√ncoded_off£t
)

4526 
out_ac˘
;

4528 
ªt
 = 
	`imp‹t_iovec
(
ITER_SOURCE
, 
¨gs
.
iov
,árgs.
iov˙t
, 
	`ARRAY_SIZE
(
iov°ack
),

4529 &
iov
, &
ôî
);

4530 i‡(
ªt
 < 0)

4531 
out_ac˘
;

4533 
	`fûe_°¨t_wrôe
(
fûe
);

4535 i‡(
	`iov_ôî_cou¡
(&
ôî
) == 0) {

4536 
ªt
 = 0;

4537 
out_íd_wrôe
;

4539 
pos
 = 
¨gs
.
off£t
;

4540 
ªt
 = 
	`rw_vîify_¨ó
(
WRITE
, 
fûe
, &
pos
, 
¨gs
.
Àn
);

4541 i‡(
ªt
 < 0)

4542 
out_íd_wrôe
;

4544 
	`öô_sync_kiocb
(&
kiocb
, 
fûe
);

4545 
ªt
 = 
	`kiocb_£t_rw_Êags
(&
kiocb
, 0);

4546 i‡(
ªt
)

4547 
out_íd_wrôe
;

4548 
kiocb
.
ki_pos
 = 
pos
;

4550 
ªt
 = 
	`båfs_do_wrôe_ôî
(&
kiocb
, &
ôî
, &
¨gs
);

4551 i‡(
ªt
 > 0)

4552 
	`f¢Ÿify_modify
(
fûe
);

4554 
out_íd_wrôe
:

4555 
	`fûe_íd_wrôe
(
fûe
);

4556 
	`k‰ì
(
iov
);

4557 
out_ac˘
:

4558 i‡(
ªt
 > 0)

4559 
	`add_wch¨
(
cuºít
, 
ªt
);

4560 
	`öc_syscw
(
cuºít
);

4561  
ªt
;

4562 
	}
}

4564 
	$båfs_io˘l
(
fûe
 *file, 

4565 
cmd
, 
¨g
)

4567 
öode
 *öodê
	`fûe_öode
(
fûe
);

4568 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

4569 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

4570 
__u£r
 *
¨gp
 = (__u£∏*)
¨g
;

4572 
cmd
) {

4573 
FS_IOC_GETVERSION
:

4574  
	`båfs_io˘l_gëvîsi⁄
(
öode
, 
¨gp
);

4575 
FS_IOC_GETFSLABEL
:

4576  
	`båfs_io˘l_gë_f¶abñ
(
fs_öfo
, 
¨gp
);

4577 
FS_IOC_SETFSLABEL
:

4578  
	`båfs_io˘l_£t_f¶abñ
(
fûe
, 
¨gp
);

4579 
FITRIM
:

4580  
	`båfs_io˘l_fôrim
(
fs_öfo
, 
¨gp
);

4581 
BTRFS_IOC_SNAP_CREATE
:

4582  
	`båfs_io˘l_¢≠_¸óã
(
fûe
, 
¨gp
, 0);

4583 
BTRFS_IOC_SNAP_CREATE_V2
:

4584  
	`båfs_io˘l_¢≠_¸óã_v2
(
fûe
, 
¨gp
, 0);

4585 
BTRFS_IOC_SUBVOL_CREATE
:

4586  
	`båfs_io˘l_¢≠_¸óã
(
fûe
, 
¨gp
, 1);

4587 
BTRFS_IOC_SUBVOL_CREATE_V2
:

4588  
	`båfs_io˘l_¢≠_¸óã_v2
(
fûe
, 
¨gp
, 1);

4589 
BTRFS_IOC_SNAP_DESTROY
:

4590  
	`båfs_io˘l_¢≠_de°roy
(
fûe
, 
¨gp
, 
Ál£
);

4591 
BTRFS_IOC_SNAP_DESTROY_V2
:

4592  
	`båfs_io˘l_¢≠_de°roy
(
fûe
, 
¨gp
, 
åue
);

4593 
BTRFS_IOC_SUBVOL_GETFLAGS
:

4594  
	`båfs_io˘l_subvﬁ_gëÊags
(
öode
, 
¨gp
);

4595 
BTRFS_IOC_SUBVOL_SETFLAGS
:

4596  
	`båfs_io˘l_subvﬁ_£tÊags
(
fûe
, 
¨gp
);

4597 
BTRFS_IOC_DEFAULT_SUBVOL
:

4598  
	`båfs_io˘l_deÁu…_subvﬁ
(
fûe
, 
¨gp
);

4599 
BTRFS_IOC_DEFRAG
:

4600  
	`båfs_io˘l_de‰ag
(
fûe
, 
NULL
);

4601 
BTRFS_IOC_DEFRAG_RANGE
:

4602  
	`båfs_io˘l_de‰ag
(
fûe
, 
¨gp
);

4603 
BTRFS_IOC_RESIZE
:

4604  
	`båfs_io˘l_ªsize
(
fûe
, 
¨gp
);

4605 
BTRFS_IOC_ADD_DEV
:

4606  
	`båfs_io˘l_add_dev
(
fs_öfo
, 
¨gp
);

4607 
BTRFS_IOC_RM_DEV
:

4608  
	`båfs_io˘l_rm_dev
(
fûe
, 
¨gp
);

4609 
BTRFS_IOC_RM_DEV_V2
:

4610  
	`båfs_io˘l_rm_dev_v2
(
fûe
, 
¨gp
);

4611 
BTRFS_IOC_FS_INFO
:

4612  
	`båfs_io˘l_fs_öfo
(
fs_öfo
, 
¨gp
);

4613 
BTRFS_IOC_DEV_INFO
:

4614  
	`båfs_io˘l_dev_öfo
(
fs_öfo
, 
¨gp
);

4615 
BTRFS_IOC_TREE_SEARCH
:

4616  
	`båfs_io˘l_åì_£¨ch
(
öode
, 
¨gp
);

4617 
BTRFS_IOC_TREE_SEARCH_V2
:

4618  
	`båfs_io˘l_åì_£¨ch_v2
(
öode
, 
¨gp
);

4619 
BTRFS_IOC_INO_LOOKUP
:

4620  
	`båfs_io˘l_öo_lookup
(
roŸ
, 
¨gp
);

4621 
BTRFS_IOC_INO_PATHS
:

4622  
	`båfs_io˘l_öo_to_∑th
(
roŸ
, 
¨gp
);

4623 
BTRFS_IOC_LOGICAL_INO
:

4624  
	`båfs_io˘l_logiˇl_to_öo
(
fs_öfo
, 
¨gp
, 1);

4625 
BTRFS_IOC_LOGICAL_INO_V2
:

4626  
	`båfs_io˘l_logiˇl_to_öo
(
fs_öfo
, 
¨gp
, 2);

4627 
BTRFS_IOC_SPACE_INFO
:

4628  
	`båfs_io˘l_•a˚_öfo
(
fs_öfo
, 
¨gp
);

4629 
BTRFS_IOC_SYNC
: {

4630 
ªt
;

4632 
ªt
 = 
	`båfs_°¨t_dñÆloc_roŸs
(
fs_öfo
, 
LONG_MAX
, 
Ál£
);

4633 i‡(
ªt
)

4634  
ªt
;

4635 
ªt
 = 
	`båfs_sync_fs
(
öode
->
i_sb
, 1);

4641 
	`wake_up_¥o˚ss
(
fs_öfo
->
å™ß˘i⁄_kthªad
);

4642  
ªt
;

4644 
BTRFS_IOC_START_SYNC
:

4645  
	`båfs_io˘l_°¨t_sync
(
roŸ
, 
¨gp
);

4646 
BTRFS_IOC_WAIT_SYNC
:

4647  
	`båfs_io˘l_waô_sync
(
fs_öfo
, 
¨gp
);

4648 
BTRFS_IOC_SCRUB
:

4649  
	`båfs_io˘l_s¸ub
(
fûe
, 
¨gp
);

4650 
BTRFS_IOC_SCRUB_CANCEL
:

4651  
	`båfs_io˘l_s¸ub_ˇn˚l
(
fs_öfo
);

4652 
BTRFS_IOC_SCRUB_PROGRESS
:

4653  
	`båfs_io˘l_s¸ub_¥ogªss
(
fs_öfo
, 
¨gp
);

4654 
BTRFS_IOC_BALANCE_V2
:

4655  
	`båfs_io˘l_bÆ™˚
(
fûe
, 
¨gp
);

4656 
BTRFS_IOC_BALANCE_CTL
:

4657  
	`båfs_io˘l_bÆ™˚_˘l
(
fs_öfo
, 
¨g
);

4658 
BTRFS_IOC_BALANCE_PROGRESS
:

4659  
	`båfs_io˘l_bÆ™˚_¥ogªss
(
fs_öfo
, 
¨gp
);

4660 
BTRFS_IOC_SET_RECEIVED_SUBVOL
:

4661  
	`båfs_io˘l_£t_ª˚ived_subvﬁ
(
fûe
, 
¨gp
);

4662 #ifde‡
CONFIG_64BIT


4663 
BTRFS_IOC_SET_RECEIVED_SUBVOL_32
:

4664  
	`båfs_io˘l_£t_ª˚ived_subvﬁ_32
(
fûe
, 
¨gp
);

4666 
BTRFS_IOC_SEND
:

4667  
	`_båfs_io˘l_£nd
(
öode
, 
¨gp
, 
Ál£
);

4668 #i‡
	`deföed
(
CONFIG_64BIT
Ë&& deföed(
CONFIG_COMPAT
)

4669 
BTRFS_IOC_SEND_32
:

4670  
	`_båfs_io˘l_£nd
(
öode
, 
¨gp
, 
åue
);

4672 
BTRFS_IOC_GET_DEV_STATS
:

4673  
	`båfs_io˘l_gë_dev_°©s
(
fs_öfo
, 
¨gp
);

4674 
BTRFS_IOC_QUOTA_CTL
:

4675  
	`båfs_io˘l_quŸa_˘l
(
fûe
, 
¨gp
);

4676 
BTRFS_IOC_QGROUP_ASSIGN
:

4677  
	`båfs_io˘l_qgroup_assign
(
fûe
, 
¨gp
);

4678 
BTRFS_IOC_QGROUP_CREATE
:

4679  
	`båfs_io˘l_qgroup_¸óã
(
fûe
, 
¨gp
);

4680 
BTRFS_IOC_QGROUP_LIMIT
:

4681  
	`båfs_io˘l_qgroup_limô
(
fûe
, 
¨gp
);

4682 
BTRFS_IOC_QUOTA_RESCAN
:

4683  
	`båfs_io˘l_quŸa_ªsˇn
(
fûe
, 
¨gp
);

4684 
BTRFS_IOC_QUOTA_RESCAN_STATUS
:

4685  
	`båfs_io˘l_quŸa_ªsˇn_°©us
(
fs_öfo
, 
¨gp
);

4686 
BTRFS_IOC_QUOTA_RESCAN_WAIT
:

4687  
	`båfs_io˘l_quŸa_ªsˇn_waô
(
fs_öfo
, 
¨gp
);

4688 
BTRFS_IOC_DEV_REPLACE
:

4689  
	`båfs_io˘l_dev_ª∂a˚
(
fs_öfo
, 
¨gp
);

4690 
BTRFS_IOC_GET_SUPPORTED_FEATURES
:

4691  
	`båfs_io˘l_gë_suµ‹ãd_„©uªs
(
¨gp
);

4692 
BTRFS_IOC_GET_FEATURES
:

4693  
	`båfs_io˘l_gë_„©uªs
(
fs_öfo
, 
¨gp
);

4694 
BTRFS_IOC_SET_FEATURES
:

4695  
	`båfs_io˘l_£t_„©uªs
(
fûe
, 
¨gp
);

4696 
BTRFS_IOC_GET_SUBVOL_INFO
:

4697  
	`båfs_io˘l_gë_subvﬁ_öfo
(
öode
, 
¨gp
);

4698 
BTRFS_IOC_GET_SUBVOL_ROOTREF
:

4699  
	`båfs_io˘l_gë_subvﬁ_roŸªf
(
roŸ
, 
¨gp
);

4700 
BTRFS_IOC_INO_LOOKUP_USER
:

4701  
	`båfs_io˘l_öo_lookup_u£r
(
fûe
, 
¨gp
);

4702 
FS_IOC_ENABLE_VERITY
:

4703  
	`fsvîôy_io˘l_íabÀ
(
fûe
, (c⁄° 
__u£r
 *)
¨gp
);

4704 
FS_IOC_MEASURE_VERITY
:

4705  
	`fsvîôy_io˘l_mósuª
(
fûe
, 
¨gp
);

4706 
BTRFS_IOC_ENCODED_READ
:

4707  
	`båfs_io˘l_ícoded_ªad
(
fûe
, 
¨gp
, 
Ál£
);

4708 
BTRFS_IOC_ENCODED_WRITE
:

4709  
	`båfs_io˘l_ícoded_wrôe
(
fûe
, 
¨gp
, 
Ál£
);

4710 #i‡
	`deföed
(
CONFIG_64BIT
Ë&& deföed(
CONFIG_COMPAT
)

4711 
BTRFS_IOC_ENCODED_READ_32
:

4712  
	`båfs_io˘l_ícoded_ªad
(
fûe
, 
¨gp
, 
åue
);

4713 
BTRFS_IOC_ENCODED_WRITE_32
:

4714  
	`båfs_io˘l_ícoded_wrôe
(
fûe
, 
¨gp
, 
åue
);

4718  -
ENOTTY
;

4719 
	}
}

4721 #ifde‡
CONFIG_COMPAT


4722 
	$båfs_com∑t_io˘l
(
fûe
 *fûe, 
cmd
, 
¨g
)

4728 
cmd
) {

4729 
FS_IOC32_GETVERSION
:

4730 
cmd
 = 
FS_IOC_GETVERSION
;

4734  
	`båfs_io˘l
(
fûe
, 
cmd
, (Ë
	`com∑t_±r
(
¨g
));

4735 
	}
}

	@ioctl.h

3 #i‚de‡
BTRFS_IOCTL_H


4 
	#BTRFS_IOCTL_H


	)

6 
båfs_io˘l
(
fûe
 *fûe, 
cmd
, 
¨g
);

7 
båfs_com∑t_io˘l
(
fûe
 *fûe, 
cmd
, 
¨g
);

8 
båfs_fûóâr_gë
(
díåy
 *díåy, 
fûóâr
 *
Á
);

9 
båfs_fûóâr_£t
(
m¡_idm≠
 *
idm≠
,

10 
díåy
 *díåy, 
fûóâr
 *
Á
);

11 
båfs_io˘l_gë_suµ‹ãd_„©uªs
(
__u£r
 *
¨g
);

12 
båfs_sync_öode_Êags_to_i_Êags
(
öode
 *inode);

13 
__puª
 
båfs_is_em±y_uuid
(
u8
 *
uuid
);

14 
båfs_upd©e_io˘l_bÆ™˚_¨gs
(
båfs_fs_öfo
 *
fs_öfo
,

15 
båfs_io˘l_bÆ™˚_¨gs
 *
b¨gs
);

	@locking.c

6 
	~<löux/sched.h
>

7 
	~<löux/∑gem≠.h
>

8 
	~<löux/•ölock.h
>

9 
	~<löux/∑ge-Êags.h
>

10 
	~<asm/bug.h
>

11 
	~"misc.h
"

12 
	~"˘ªe.h
"

13 
	~"exã¡_io.h
"

14 
	~"lockög.h
"

15 
	~"ac˚ss‹s.h
"

40 #ifde‡
CONFIG_DEBUG_LOCK_ALLOC


41 #i‡
BTRFS_MAX_LEVEL
 != 8

45 
	#DEFINE_LEVEL
(
°em
, 
Àvñ
) \

46 .
«mes
[
Àvñ
] = "båfs-" 
°em
 "-0" #Àvñ,

	)

48 
	#DEFINE_NAME
(
°em
) \

49 
	`DEFINE_LEVEL
(
°em
, 0) \

50 
	`DEFINE_LEVEL
(
°em
, 1) \

51 
	`DEFINE_LEVEL
(
°em
, 2) \

52 
	`DEFINE_LEVEL
(
°em
, 3) \

53 
	`DEFINE_LEVEL
(
°em
, 4) \

54 
	`DEFINE_LEVEL
(
°em
, 5) \

55 
	`DEFINE_LEVEL
(
°em
, 6) \

56 
	`DEFINE_LEVEL
(
°em
, 7)

	)

58 
	sbåfs_lockdï_key£t
 {

59 
u64
 
	mid
;

61 
	m«mes
[
BTRFS_MAX_LEVEL
][24];

62 
lock_˛ass_key
 
	mkeys
[
BTRFS_MAX_LEVEL
];

63 } 
	gbåfs_lockdï_key£ts
[] = {

64 { .
id
 = 
BTRFS_ROOT_TREE_OBJECTID
, 
DEFINE_NAME
("root") },

65 { .
	gid
 = 
BTRFS_EXTENT_TREE_OBJECTID
, 
DEFINE_NAME
("extent") },

66 { .
	gid
 = 
BTRFS_CHUNK_TREE_OBJECTID
, 
DEFINE_NAME
("chunk") },

67 { .
	gid
 = 
BTRFS_DEV_TREE_OBJECTID
, 
DEFINE_NAME
("dev") },

68 { .
	gid
 = 
BTRFS_CSUM_TREE_OBJECTID
, 
DEFINE_NAME
("csum") },

69 { .
	gid
 = 
BTRFS_QUOTA_TREE_OBJECTID
, 
DEFINE_NAME
("quota") },

70 { .
	gid
 = 
BTRFS_TREE_LOG_OBJECTID
, 
DEFINE_NAME
("log") },

71 { .
	gid
 = 
BTRFS_TREE_RELOC_OBJECTID
, 
DEFINE_NAME
("treloc") },

72 { .
	gid
 = 
BTRFS_DATA_RELOC_TREE_OBJECTID
, 
DEFINE_NAME
("dreloc") },

73 { .
	gid
 = 
BTRFS_UUID_TREE_OBJECTID
, 
DEFINE_NAME
("uuid") },

74 { .
	gid
 = 
BTRFS_FREE_SPACE_TREE_OBJECTID
, 
DEFINE_NAME
("free-space") },

75 { .
	gid
 = 
BTRFS_BLOCK_GROUP_TREE_OBJECTID
, 
DEFINE_NAME
("block-group") },

76 { .
	gid
 = 0, 
DEFINE_NAME
("tree") },

79 #unde‡
DEFINE_LEVEL


80 #unde‡
DEFINE_NAME


82 
	$båfs_£t_buf„r_lockdï_˛ass
(
u64
 
obje˘id
, 
exã¡_buf„r
 *
eb
, 
Àvñ
)

84 
båfs_lockdï_key£t
 *
ks
;

86 
	`BUG_ON
(
Àvñ
 >
	`ARRAY_SIZE
(
ks
->
keys
));

89 
ks
 = 
båfs_lockdï_key£ts
; ks->
id
; ks++)

90 i‡(
ks
->
id
 =
obje˘id
)

93 
	`lockdï_£t_˛ass_™d_«me
(&
eb
->
lock
, &
ks
->
keys
[
Àvñ
], ks->
«mes
[level]);

94 
	}
}

96 
	$båfs_maybe_ª£t_lockdï_˛ass
(
båfs_roŸ
 *
roŸ
, 
exã¡_buf„r
 *
eb
)

98 i‡(
	`ã°_bô
(
BTRFS_ROOT_RESET_LOCKDEP_CLASS
, &
roŸ
->
°©e
))

99 
	`båfs_£t_buf„r_lockdï_˛ass
(
roŸ
->
roŸ_key
.
obje˘id
,

100 
eb
, 
	`båfs_hódî_Àvñ
(eb));

101 
	}
}

129 
	$__båfs_åì_ªad_lock
(
exã¡_buf„r
 *
eb
, 
båfs_lock_√°ög
 
√°
)

131 
u64
 
°¨t_ns
 = 0;

133 i‡(
	`åa˚_båfs_åì_ªad_lock_íabÀd
())

134 
°¨t_ns
 = 
	`ktime_gë_ns
();

136 
	`down_ªad_√°ed
(&
eb
->
lock
, 
√°
);

137 
	`åa˚_båfs_åì_ªad_lock
(
eb
, 
°¨t_ns
);

138 
	}
}

140 
	$båfs_åì_ªad_lock
(
exã¡_buf„r
 *
eb
)

142 
	`__båfs_åì_ªad_lock
(
eb
, 
BTRFS_NESTING_NORMAL
);

143 
	}
}

150 
	$båfs_åy_åì_ªad_lock
(
exã¡_buf„r
 *
eb
)

152 i‡(
	`down_ªad_åylock
(&
eb
->
lock
)) {

153 
	`åa˚_båfs_åy_åì_ªad_lock
(
eb
);

157 
	}
}

164 
	$båfs_åy_åì_wrôe_lock
(
exã¡_buf„r
 *
eb
)

166 i‡(
	`down_wrôe_åylock
(&
eb
->
lock
)) {

167 
eb
->
lock_ow√r
 = 
cuºít
->
pid
;

168 
	`åa˚_båfs_åy_åì_wrôe_lock
(
eb
);

172 
	}
}

177 
	$båfs_åì_ªad_u∆ock
(
exã¡_buf„r
 *
eb
)

179 
	`åa˚_båfs_åì_ªad_u∆ock
(
eb
);

180 
	`up_ªad
(&
eb
->
lock
);

181 
	}
}

190 
	$__båfs_åì_lock
(
exã¡_buf„r
 *
eb
, 
båfs_lock_√°ög
 
√°
)

191 
	`__acquúes
(&
eb
->
lock
)

193 
u64
 
°¨t_ns
 = 0;

195 i‡(
	`åa˚_båfs_åì_lock_íabÀd
())

196 
°¨t_ns
 = 
	`ktime_gë_ns
();

198 
	`down_wrôe_√°ed
(&
eb
->
lock
, 
√°
);

199 
eb
->
lock_ow√r
 = 
cuºít
->
pid
;

200 
	`åa˚_båfs_åì_lock
(
eb
, 
°¨t_ns
);

201 
	}
}

203 
	$båfs_åì_lock
(
exã¡_buf„r
 *
eb
)

205 
	`__båfs_åì_lock
(
eb
, 
BTRFS_NESTING_NORMAL
);

206 
	}
}

211 
	$båfs_åì_u∆ock
(
exã¡_buf„r
 *
eb
)

213 
	`åa˚_båfs_åì_u∆ock
(
eb
);

214 
eb
->
lock_ow√r
 = 0;

215 
	`up_wrôe
(&
eb
->
lock
);

216 
	}
}

227 
	$båfs_u∆ock_up_ß„
(
båfs_∑th
 *
∑th
, 
Àvñ
)

229 
i
;

231 i‡(
∑th
->
kìp_locks
)

234 
i
 = 
Àvñ
; i < 
BTRFS_MAX_LEVEL
; i++) {

235 i‡(!
∑th
->
nodes
[
i
])

237 i‡(!
∑th
->
locks
[
i
])

239 
	`båfs_åì_u∆ock_rw
(
∑th
->
nodes
[
i
],Ö©h->
locks
[i]);

240 
∑th
->
locks
[
i
] = 0;

242 
	}
}

250 
exã¡_buf„r
 *
	$båfs_lock_roŸ_node
(
båfs_roŸ
 *
roŸ
)

252 
exã¡_buf„r
 *
eb
;

255 
eb
 = 
	`båfs_roŸ_node
(
roŸ
);

257 
	`båfs_maybe_ª£t_lockdï_˛ass
(
roŸ
, 
eb
);

258 
	`båfs_åì_lock
(
eb
);

259 i‡(
eb
 =
roŸ
->
node
)

261 
	`båfs_åì_u∆ock
(
eb
);

262 
	`‰ì_exã¡_buf„r
(
eb
);

264  
eb
;

265 
	}
}

273 
exã¡_buf„r
 *
	$båfs_ªad_lock_roŸ_node
(
båfs_roŸ
 *
roŸ
)

275 
exã¡_buf„r
 *
eb
;

278 
eb
 = 
	`båfs_roŸ_node
(
roŸ
);

280 
	`båfs_maybe_ª£t_lockdï_˛ass
(
roŸ
, 
eb
);

281 
	`båfs_åì_ªad_lock
(
eb
);

282 i‡(
eb
 =
roŸ
->
node
)

284 
	`båfs_åì_ªad_u∆ock
(
eb
);

285 
	`‰ì_exã¡_buf„r
(
eb
);

287  
eb
;

288 
	}
}

297 
exã¡_buf„r
 *
	$båfs_åy_ªad_lock_roŸ_node
(
båfs_roŸ
 *
roŸ
)

299 
exã¡_buf„r
 *
eb
;

302 
eb
 = 
	`båfs_roŸ_node
(
roŸ
);

303 i‡(!
	`båfs_åy_åì_ªad_lock
(
eb
)) {

304 
	`‰ì_exã¡_buf„r
(
eb
);

305  
	`ERR_PTR
(-
EAGAIN
);

307 i‡(
eb
 =
roŸ
->
node
)

309 
	`båfs_åì_ªad_u∆ock
(
eb
);

310 
	`‰ì_exã¡_buf„r
(
eb
);

312  
eb
;

313 
	}
}

329 
	$båfs_dªw_lock_öô
(
båfs_dªw_lock
 *
lock
)

331 
	`©omic_£t
(&
lock
->
ªadîs
, 0);

332 
	`©omic_£t
(&
lock
->
wrôîs
, 0);

333 
	`öô_waôqueue_hód
(&
lock
->
≥ndög_ªadîs
);

334 
	`öô_waôqueue_hód
(&
lock
->
≥ndög_wrôîs
);

335 
	}
}

338 
boﬁ
 
	$båfs_dªw_åy_wrôe_lock
(
båfs_dªw_lock
 *
lock
)

340 i‡(
	`©omic_ªad
(&
lock
->
ªadîs
))

341  
Ál£
;

343 
	`©omic_öc
(&
lock
->
wrôîs
);

346 
	`smp_mb__a·î_©omic
();

347 i‡(
	`©omic_ªad
(&
lock
->
ªadîs
)) {

348 
	`båfs_dªw_wrôe_u∆ock
(
lock
);

349  
Ál£
;

352  
åue
;

353 
	}
}

355 
	$båfs_dªw_wrôe_lock
(
båfs_dªw_lock
 *
lock
)

357 
åue
) {

358 i‡(
	`båfs_dªw_åy_wrôe_lock
(
lock
))

360 
	`waô_evít
(
lock
->
≥ndög_wrôîs
, !
	`©omic_ªad
(&lock->
ªadîs
));

362 
	}
}

364 
	$båfs_dªw_wrôe_u∆ock
(
båfs_dªw_lock
 *
lock
)

366 
	`©omic_dec
(&
lock
->
wrôîs
);

367 
	`c⁄d_wake_up
(&
lock
->
≥ndög_ªadîs
);

368 
	}
}

370 
	$båfs_dªw_ªad_lock
(
båfs_dªw_lock
 *
lock
)

372 
	`©omic_öc
(&
lock
->
ªadîs
);

380 
	`smp_mb__a·î_©omic
();

382 
	`waô_evít
(
lock
->
≥ndög_ªadîs
, 
	`©omic_ªad
(&lock->
wrôîs
) == 0);

383 
	}
}

385 
	$båfs_dªw_ªad_u∆ock
(
båfs_dªw_lock
 *
lock
)

391 i‡(
	`©omic_dec_™d_ã°
(&
lock
->
ªadîs
))

392 
	`wake_up
(&
lock
->
≥ndög_wrôîs
);

393 
	}
}

	@locking.h

6 #i‚de‡
BTRFS_LOCKING_H


7 
	#BTRFS_LOCKING_H


	)

9 
	~<löux/©omic.h
>

10 
	~<löux/waô.h
>

11 
	~<löux/≥r˝u_cou¡î.h
>

12 
	~"exã¡_io.h
"

14 
	#BTRFS_WRITE_LOCK
 1

	)

15 
	#BTRFS_READ_LOCK
 2

	)

22 
	ebåfs_lock_√°ög
 {

23 
	mBTRFS_NESTING_NORMAL
,

31 
	mBTRFS_NESTING_COW
,

42 
	mBTRFS_NESTING_LEFT
,

43 
	mBTRFS_NESTING_RIGHT
,

50 
	mBTRFS_NESTING_LEFT_COW
,

51 
	mBTRFS_NESTING_RIGHT_COW
,

60 
	mBTRFS_NESTING_SPLIT
,

69 
	mBTRFS_NESTING_NEW_ROOT
,

78 
	mBTRFS_NESTING_MAX
,

81 
	ebåfs_lockdï_å™s_°©es
 {

82 
	mBTRFS_LOCKDEP_TRANS_COMMIT_PREP
,

83 
	mBTRFS_LOCKDEP_TRANS_UNBLOCKED
,

84 
	mBTRFS_LOCKDEP_TRANS_SUPER_COMMITTED
,

85 
	mBTRFS_LOCKDEP_TRANS_COMPLETED
,

99 
	#båfs_might_waô_f‹_evít
(
ow√r
, 
lock
) \

101 
	`rw£m_acquúe
(&
ow√r
->
lock
##
_m≠
, 0, 0, 
_THIS_IP_
); \

102 
	`rw£m_ªÀa£
(&
ow√r
->
lock
##
_m≠
, 
_THIS_IP_
); \

103 } 0)

	)

116 
	#båfs_lockdï_acquúe
(
ow√r
, 
lock
) \

117 
	`rw£m_acquúe_ªad
(&
ow√r
->
lock
##
_m≠
, 0, 0, 
_THIS_IP_
)

	)

123 
	#båfs_lockdï_ªÀa£
(
ow√r
, 
lock
) \

124 
	`rw£m_ªÀa£
(&
ow√r
->
lock
##
_m≠
, 
_THIS_IP_
)

	)

130 
	#båfs_might_waô_f‹_°©e
(
ow√r
, 
i
) \

132 
	`rw£m_acquúe
(&
ow√r
->
båfs_°©e_ch™ge_m≠
[
i
], 0, 0, 
_THIS_IP_
); \

133 
	`rw£m_ªÀa£
(&
ow√r
->
båfs_°©e_ch™ge_m≠
[
i
], 
_THIS_IP_
); \

134 } 0)

	)

136 
	#båfs_å™s_°©e_lockdï_acquúe
(
ow√r
, 
i
) \

137 
	`rw£m_acquúe_ªad
(&
ow√r
->
båfs_°©e_ch™ge_m≠
[
i
], 0, 0, 
_THIS_IP_
)

	)

139 
	#båfs_å™s_°©e_lockdï_ªÀa£
(
ow√r
, 
i
) \

140 
	`rw£m_ªÀa£
(&
ow√r
->
båfs_°©e_ch™ge_m≠
[
i
], 
_THIS_IP_
)

	)

143 
	#båfs_lockdï_öô_m≠
(
ow√r
, 
lock
) \

145 
lock_˛ass_key
 
lock
##
_key
; \

146 
	`lockdï_öô_m≠
(&
ow√r
->
lock
##
_m≠
, #lock, &lock##
_key
, 0); \

147 } 0)

	)

150 
	#båfs_°©e_lockdï_öô_m≠
(
ow√r
, 
lock
, 
°©e
) \

152 
lock_˛ass_key
 
lock
##
_key
; \

153 
	`lockdï_öô_m≠
(&
ow√r
->
båfs_°©e_ch™ge_m≠
[
°©e
], #lock, \

154 &
lock
##
_key
, 0); \

155 } 0)

	)

157 
°©ic_as£π
(
BTRFS_NESTING_MAX
 <
MAX_LOCKDEP_SUBCLASSES
,

160 
	gbåfs_∑th
;

162 
__båfs_åì_lock
(
exã¡_buf„r
 *
eb
, 
båfs_lock_√°ög
 
√°
);

163 
båfs_åì_lock
(
exã¡_buf„r
 *
eb
);

164 
båfs_åì_u∆ock
(
exã¡_buf„r
 *
eb
);

166 
__båfs_åì_ªad_lock
(
exã¡_buf„r
 *
eb
, 
båfs_lock_√°ög
 
√°
);

167 
båfs_åì_ªad_lock
(
exã¡_buf„r
 *
eb
);

168 
båfs_åì_ªad_u∆ock
(
exã¡_buf„r
 *
eb
);

169 
båfs_åy_åì_ªad_lock
(
exã¡_buf„r
 *
eb
);

170 
båfs_åy_åì_wrôe_lock
(
exã¡_buf„r
 *
eb
);

171 
exã¡_buf„r
 *
båfs_lock_roŸ_node
(
båfs_roŸ
 *
roŸ
);

172 
exã¡_buf„r
 *
båfs_ªad_lock_roŸ_node
(
båfs_roŸ
 *
roŸ
);

173 
exã¡_buf„r
 *
båfs_åy_ªad_lock_roŸ_node
(
båfs_roŸ
 *
roŸ
);

175 #ifde‡
CONFIG_BTRFS_DEBUG


176 
ölöe
 
	$båfs_as£π_åì_wrôe_locked
(
exã¡_buf„r
 *
eb
)

178 
	`lockdï_as£π_hñd_wrôe
(&
eb
->
lock
);

179 
	}
}

181 
ölöe
 
	$båfs_as£π_åì_wrôe_locked
(
exã¡_buf„r
 *
eb
Ë{ 
	}
}

184 
båfs_u∆ock_up_ß„
(
båfs_∑th
 *
∑th
, 
Àvñ
);

186 
ölöe
 
	$båfs_åì_u∆ock_rw
(
exã¡_buf„r
 *
eb
, 
rw
)

188 i‡(
rw
 =
BTRFS_WRITE_LOCK
)

189 
	`båfs_åì_u∆ock
(
eb
);

190 i‡(
rw
 =
BTRFS_READ_LOCK
)

191 
	`båfs_åì_ªad_u∆ock
(
eb
);

193 
	`BUG
();

194 
	}
}

196 
	sbåfs_dªw_lock
 {

197 
©omic_t
 
	mªadîs
;

198 
©omic_t
 
	mwrôîs
;

199 
waô_queue_hód_t
 
	m≥ndög_wrôîs
;

200 
waô_queue_hód_t
 
	m≥ndög_ªadîs
;

203 
båfs_dªw_lock_öô
(
båfs_dªw_lock
 *
lock
);

204 
båfs_dªw_wrôe_lock
(
båfs_dªw_lock
 *
lock
);

205 
boﬁ
 
båfs_dªw_åy_wrôe_lock
(
båfs_dªw_lock
 *
lock
);

206 
båfs_dªw_wrôe_u∆ock
(
båfs_dªw_lock
 *
lock
);

207 
båfs_dªw_ªad_lock
(
båfs_dªw_lock
 *
lock
);

208 
båfs_dªw_ªad_u∆ock
(
båfs_dªw_lock
 *
lock
);

210 #ifde‡
CONFIG_DEBUG_LOCK_ALLOC


211 
båfs_£t_buf„r_lockdï_˛ass
(
u64
 
obje˘id
, 
exã¡_buf„r
 *
eb
, 
Àvñ
);

212 
båfs_maybe_ª£t_lockdï_˛ass
(
båfs_roŸ
 *
roŸ
, 
exã¡_buf„r
 *
eb
);

214 
ölöe
 
	$båfs_£t_buf„r_lockdï_˛ass
(
u64
 
obje˘id
,

215 
exã¡_buf„r
 *
eb
, 
Àvñ
)

217 
	}
}

218 
ölöe
 
	$båfs_maybe_ª£t_lockdï_˛ass
(
båfs_roŸ
 *
roŸ
,

219 
exã¡_buf„r
 *
eb
)

221 
	}
}

	@lru_cache.c

3 
	~<löux/mm.h
>

4 
	~"Ãu_ˇche.h
"

5 
	~"mesßges.h
"

15 
	$båfs_Ãu_ˇche_öô
(
båfs_Ãu_ˇche
 *
ˇche
, 
max_size
)

17 
	`INIT_LIST_HEAD
(&
ˇche
->
Ãu_li°
);

18 
	`mt_öô
(&
ˇche
->
íåõs
);

19 
ˇche
->
size
 = 0;

20 
ˇche
->
max_size
 = max_size;

21 
	}
}

23 
båfs_Ãu_ˇche_íåy
 *
	$m©ch_íåy
(
li°_hód
 *
hód
, 
u64
 
key
,

24 
u64
 
gí
)

26 
båfs_Ãu_ˇche_íåy
 *
íåy
;

28 
	`li°_f‹_óch_íåy
(
íåy
, 
hód
, 
li°
) {

29 i‡(
íåy
->
key
 =key &&É¡ry->
gí
 == gen)

30  
íåy
;

33  
NULL
;

34 
	}
}

45 
båfs_Ãu_ˇche_íåy
 *
	$båfs_Ãu_ˇche_lookup
(
båfs_Ãu_ˇche
 *
ˇche
,

46 
u64
 
key
, u64 
gí
)

48 
li°_hód
 *
hód
;

49 
båfs_Ãu_ˇche_íåy
 *
íåy
;

51 
hód
 = 
	`måì_lﬂd
(&
ˇche
->
íåõs
, 
key
);

52 i‡(!
hód
)

53  
NULL
;

55 
íåy
 = 
	`m©ch_íåy
(
hód
, 
key
, 
gí
);

56 i‡(
íåy
)

57 
	`li°_move_èû
(&
íåy
->
Ãu_li°
, &
ˇche
->lru_list);

59  
íåy
;

60 
	}
}

70 
	$båfs_Ãu_ˇche_ªmove
(
båfs_Ãu_ˇche
 *
ˇche
,

71 
båfs_Ãu_ˇche_íåy
 *
íåy
)

73 
li°_hód
 *
¥ev
 = 
íåy
->
li°
.prev;

75 
	`ASSERT
(
ˇche
->
size
 > 0);

76 
	`ASSERT
(!
	`måì_em±y
(&
ˇche
->
íåõs
));

78 
	`li°_dñ
(&
íåy
->
li°
);

79 
	`li°_dñ
(&
íåy
->
Ãu_li°
);

81 i‡(
	`li°_em±y
(
¥ev
)) {

82 
li°_hód
 *
hód
;

89 
hód
 = 
	`måì_îa£
(&
ˇche
->
íåõs
, 
íåy
->
key
);

90 
	`ASSERT
(
hód
 =
¥ev
);

91 
	`k‰ì
(
hód
);

94 
	`k‰ì
(
íåy
);

95 
ˇche
->
size
--;

96 
	}
}

106 
	$båfs_Ãu_ˇche_°‹e
(
båfs_Ãu_ˇche
 *
ˇche
,

107 
båfs_Ãu_ˇche_íåy
 *
√w_íåy
,

108 
gÂ_t
 
gÂ
)

110 c⁄° 
u64
 
key
 = 
√w_íåy
->key;

111 
li°_hód
 *
hód
;

112 
ªt
;

114 
hód
 = 
	`kmÆloc
((*hód), 
gÂ
);

115 i‡(!
hód
)

116  -
ENOMEM
;

118 
ªt
 = 
	`måì_ö£π
(&
ˇche
->
íåõs
, 
key
, 
hód
, 
gÂ
);

119 i‡(
ªt
 == 0) {

120 
	`INIT_LIST_HEAD
(
hód
);

121 
	`li°_add_èû
(&
√w_íåy
->
li°
, 
hód
);

122 } i‡(
ªt
 =-
EEXIST
) {

123 
	`k‰ì
(
hód
);

124 
hód
 = 
	`måì_lﬂd
(&
ˇche
->
íåõs
, 
key
);

125 
	`ASSERT
(
hód
 !
NULL
);

126 i‡(
	`m©ch_íåy
(
hód
, 
key
, 
√w_íåy
->
gí
Ë!
NULL
)

127  -
EEXIST
;

128 
	`li°_add_èû
(&
√w_íåy
->
li°
, 
hód
);

129 } i‡(
ªt
 < 0) {

130 
	`k‰ì
(
hód
);

131  
ªt
;

134 i‡(
ˇche
->
max_size
 > 0 && cache->
size
 == cache->max_size) {

135 
båfs_Ãu_ˇche_íåy
 *
Ãu_íåy
;

137 
Ãu_íåy
 = 
	`li°_fú°_íåy
(&
ˇche
->
Ãu_li°
,

138 
båfs_Ãu_ˇche_íåy
,

139 
Ãu_li°
);

140 
	`båfs_Ãu_ˇche_ªmove
(
ˇche
, 
Ãu_íåy
);

143 
	`li°_add_èû
(&
√w_íåy
->
Ãu_li°
, &
ˇche
->lru_list);

144 
ˇche
->
size
++;

147 
	}
}

156 
	$båfs_Ãu_ˇche_˛ór
(
båfs_Ãu_ˇche
 *
ˇche
)

158 
båfs_Ãu_ˇche_íåy
 *
íåy
;

159 
båfs_Ãu_ˇche_íåy
 *
tmp
;

161 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
tmp
, &
ˇche
->
Ãu_li°
,Üru_list)

162 
	`båfs_Ãu_ˇche_ªmove
(
ˇche
, 
íåy
);

164 
	`ASSERT
(
ˇche
->
size
 == 0);

165 
	`ASSERT
(
	`måì_em±y
(&
ˇche
->
íåõs
));

166 
	}
}

	@lru_cache.h

3 #i‚de‡
BTRFS_LRU_CACHE_H


4 
	#BTRFS_LRU_CACHE_H


	)

6 
	~<löux/m≠À_åì.h
>

7 
	~<löux/li°.h
>

17 
	sbåfs_Ãu_ˇche_íåy
 {

18 
li°_hód
 
	mÃu_li°
;

19 
u64
 
	mkey
;

26 
u64
 
	mgí
;

38 
li°_hód
 
	mli°
;

41 
	sbåfs_Ãu_ˇche
 {

42 
li°_hód
 
	mÃu_li°
;

43 
m≠À_åì
 
	míåõs
;

45 
	msize
;

47 
	mmax_size
;

50 
	#båfs_Ãu_ˇche_f‹_óch_íåy_ß„
(
ˇche
, 
íåy
, 
tmp
) \

51 
	`li°_f‹_óch_íåy_ß„_ªvî£
((
íåy
), (
tmp
), &(
ˇche
)->
Ãu_li°
,Üru_li°)

	)

53 
ölöe
 
	$båfs_Ãu_ˇche_size
(c⁄° 
båfs_Ãu_ˇche
 *
ˇche
)

55  
ˇche
->
size
;

56 
	}
}

58 
ölöe
 
båfs_Ãu_ˇche_íåy
 *
	$båfs_Ãu_ˇche_Ãu_íåy
(

59 
båfs_Ãu_ˇche
 *
ˇche
)

61  
	`li°_fú°_íåy_‹_nuŒ
(&
ˇche
->
Ãu_li°
,

62 
båfs_Ãu_ˇche_íåy
, 
Ãu_li°
);

63 
	}
}

65 
båfs_Ãu_ˇche_öô
(
båfs_Ãu_ˇche
 *
ˇche
, 
max_size
);

66 
båfs_Ãu_ˇche_íåy
 *
båfs_Ãu_ˇche_lookup
(
båfs_Ãu_ˇche
 *
ˇche
,

67 
u64
 
key
, u64 
gí
);

68 
båfs_Ãu_ˇche_°‹e
(
båfs_Ãu_ˇche
 *
ˇche
,

69 
båfs_Ãu_ˇche_íåy
 *
√w_íåy
,

70 
gÂ_t
 
gÂ
);

71 
båfs_Ãu_ˇche_ªmove
(
båfs_Ãu_ˇche
 *
ˇche
,

72 
båfs_Ãu_ˇche_íåy
 *
íåy
);

73 
båfs_Ãu_ˇche_˛ór
(
båfs_Ãu_ˇche
 *
ˇche
);

	@lzo.c

6 
	~<löux/kî√l.h
>

7 
	~<löux/¶ab.h
>

8 
	~<löux/mm.h
>

9 
	~<löux/öô.h
>

10 
	~<löux/îr.h
>

11 
	~<löux/sched.h
>

12 
	~<löux/∑gem≠.h
>

13 
	~<löux/bio.h
>

14 
	~<löux/lzo.h
>

15 
	~<löux/ªfcou¡.h
>

16 
	~"mesßges.h
"

17 
	~"com¥essi⁄.h
"

18 
	~"˘ªe.h
"

19 
	~"su≥r.h
"

20 
	~"båfs_öode.h
"

22 
	#LZO_LEN
 4

	)

61 
	#WORKSPACE_BUF_LENGTH
 (
	`lzo1x_w‹°_com¥ess
(
PAGE_SIZE
))

	)

62 
	#WORKSPACE_CBUF_LENGTH
 (
	`lzo1x_w‹°_com¥ess
(
PAGE_SIZE
))

	)

64 
	sw‹k•a˚
 {

65 *
	mmem
;

66 *
	mbuf
;

67 *
	mcbuf
;

68 
li°_hód
 
	mli°
;

71 
w‹k•a˚_m™agî
 
	gwsm
;

73 
	$lzo_‰ì_w‹k•a˚
(
li°_hód
 *
ws
)

75 
w‹k•a˚
 *w‹k•a˚ = 
	`li°_íåy
(
ws
, w‹k•a˚, 
li°
);

77 
	`kv‰ì
(
w‹k•a˚
->
buf
);

78 
	`kv‰ì
(
w‹k•a˚
->
cbuf
);

79 
	`kv‰ì
(
w‹k•a˚
->
mem
);

80 
	`k‰ì
(
w‹k•a˚
);

81 
	}
}

83 
li°_hód
 *
	$lzo_Æloc_w‹k•a˚
(
Àvñ
)

85 
w‹k•a˚
 *workspace;

87 
w‹k•a˚
 = 
	`kzÆloc
((*w‹k•a˚), 
GFP_KERNEL
);

88 i‡(!
w‹k•a˚
)

89  
	`ERR_PTR
(-
ENOMEM
);

91 
w‹k•a˚
->
mem
 = 
	`kvmÆloc
(
LZO1X_MEM_COMPRESS
, 
GFP_KERNEL
 | 
__GFP_NOWARN
);

92 
w‹k•a˚
->
buf
 = 
	`kvmÆloc
(
WORKSPACE_BUF_LENGTH
, 
GFP_KERNEL
 | 
__GFP_NOWARN
);

93 
w‹k•a˚
->
cbuf
 = 
	`kvmÆloc
(
WORKSPACE_CBUF_LENGTH
, 
GFP_KERNEL
 | 
__GFP_NOWARN
);

94 i‡(!
w‹k•a˚
->
mem
 || !w‹k•a˚->
buf
 || !w‹k•a˚->
cbuf
)

95 
Áû
;

97 
	`INIT_LIST_HEAD
(&
w‹k•a˚
->
li°
);

99  &
w‹k•a˚
->
li°
;

100 
Áû
:

101 
	`lzo_‰ì_w‹k•a˚
(&
w‹k•a˚
->
li°
);

102  
	`ERR_PTR
(-
ENOMEM
);

103 
	}
}

105 
ölöe
 
	$wrôe_com¥ess_Àngth
(*
buf
, 
size_t
 
Àn
)

107 
__À32
 
dÀn
;

109 
dÀn
 = 
	`˝u_to_À32
(
Àn
);

110 
	`mem˝y
(
buf
, &
dÀn
, 
LZO_LEN
);

111 
	}
}

113 
ölöe
 
size_t
 
	$ªad_com¥ess_Àngth
(c⁄° *
buf
)

115 
__À32
 
dÀn
;

117 
	`mem˝y
(&
dÀn
, 
buf
, 
LZO_LEN
);

118  
	`À32_to_˝u
(
dÀn
);

119 
	}
}

131 
	$c›y_com¥es£d_d©a_to_∑ge
(*
com¥es£d_d©a
,

132 
size_t
 
com¥es£d_size
,

133 
∑ge
 **
out_∑ges
,

134 
max_ƒ_∑ge
,

135 
u32
 *
cur_out
,

136 c⁄° 
u32
 
£˘‹size
)

138 
u32
 
£˘‹_byãs_À·
;

139 
u32
 
‹ig_out
;

140 
∑ge
 *
cur_∑ge
;

141 *
kaddr
;

143 i‡((*
cur_out
 / 
PAGE_SIZE
Ë>
max_ƒ_∑ge
)

144  -
E2BIG
;

150 
	`ASSERT
((*
cur_out
 / 
£˘‹size
Ë=(*cur_ouà+ 
LZO_LEN
 - 1) / sectorsize);

152 
cur_∑ge
 = 
out_∑ges
[*
cur_out
 / 
PAGE_SIZE
];

154 i‡(!
cur_∑ge
) {

155 
cur_∑ge
 = 
	`Æloc_∑ge
(
GFP_NOFS
);

156 i‡(!
cur_∑ge
)

157  -
ENOMEM
;

158 
out_∑ges
[*
cur_out
 / 
PAGE_SIZE
] = 
cur_∑ge
;

161 
kaddr
 = 
	`km≠_loˇl_∑ge
(
cur_∑ge
);

162 
	`wrôe_com¥ess_Àngth
(
kaddr
 + 
	`off£t_ö_∑ge
(*
cur_out
),

163 
com¥es£d_size
);

164 *
cur_out
 +
LZO_LEN
;

166 
‹ig_out
 = *
cur_out
;

169 *
cur_out
 - 
‹ig_out
 < 
com¥es£d_size
) {

170 
u32
 
c›y_Àn
 = 
	`mö_t
(u32, 
£˘‹size
 - *
cur_out
 % sectorsize,

171 
‹ig_out
 + 
com¥es£d_size
 - *
cur_out
);

173 
	`kunm≠_loˇl
(
kaddr
);

175 i‡((*
cur_out
 / 
PAGE_SIZE
Ë>
max_ƒ_∑ge
)

176  -
E2BIG
;

178 
cur_∑ge
 = 
out_∑ges
[*
cur_out
 / 
PAGE_SIZE
];

180 i‡(!
cur_∑ge
) {

181 
cur_∑ge
 = 
	`Æloc_∑ge
(
GFP_NOFS
);

182 i‡(!
cur_∑ge
)

183  -
ENOMEM
;

184 
out_∑ges
[*
cur_out
 / 
PAGE_SIZE
] = 
cur_∑ge
;

186 
kaddr
 = 
	`km≠_loˇl_∑ge
(
cur_∑ge
);

188 
	`mem˝y
(
kaddr
 + 
	`off£t_ö_∑ge
(*
cur_out
),

189 
com¥es£d_d©a
 + *
cur_out
 - 
‹ig_out
, 
c›y_Àn
);

191 *
cur_out
 +
c›y_Àn
;

198 
£˘‹_byãs_À·
 = 
	`round_up
(*
cur_out
, 
£˘‹size
) - *cur_out;

199 i‡(
£˘‹_byãs_À·
 >
LZO_LEN
 || sector_bytes_left == 0)

200 
out
;

203 
	`mem£t
(
kaddr
 + 
	`off£t_ö_∑ge
(*
cur_out
), 0,

204 
£˘‹_byãs_À·
);

205 *
cur_out
 +
£˘‹_byãs_À·
;

207 
out
:

208 
	`kunm≠_loˇl
(
kaddr
);

210 
	}
}

212 
	$lzo_com¥ess_∑ges
(
li°_hód
 *
ws
, 
addªss_•a˚
 *
m≠pög
,

213 
u64
 
°¨t
, 
∑ge
 **
∑ges
, *
out_∑ges
,

214 *
tŸÆ_ö
, *
tŸÆ_out
)

216 
w‹k•a˚
 *w‹k•a˚ = 
	`li°_íåy
(
ws
, w‹k•a˚, 
li°
);

217 c⁄° 
u32
 
£˘‹size
 = 
	`båfs_sb
(
m≠pög
->
ho°
->
i_sb
)->sectorsize;

218 
∑ge
 *
∑ge_ö
 = 
NULL
;

219 *
sizes_±r
;

220 c⁄° 
max_ƒ_∑ge
 = *
out_∑ges
;

221 
ªt
 = 0;

223 
u64
 
cur_ö
 = 
°¨t
;

225 
u32
 
cur_out
 = 0;

226 
u32
 
Àn
 = *
tŸÆ_out
;

228 
	`ASSERT
(
max_ƒ_∑ge
 > 0);

229 *
out_∑ges
 = 0;

230 *
tŸÆ_out
 = 0;

231 *
tŸÆ_ö
 = 0;

237 
cur_out
 +
LZO_LEN
;

238 
cur_ö
 < 
°¨t
 + 
Àn
) {

239 *
d©a_ö
;

240 c⁄° 
u32
 
£˘‹size_mask
 = 
£˘‹size
 - 1;

241 
u32
 
£˘‹_off
 = (
cur_ö
 - 
°¨t
Ë& 
£˘‹size_mask
;

242 
u32
 
ö_Àn
;

243 
size_t
 
out_Àn
;

246 i‡(!
∑ge_ö
) {

247 
∑ge_ö
 = 
	`föd_gë_∑ge
(
m≠pög
, 
cur_ö
 >> 
PAGE_SHIFT
);

248 
	`ASSERT
(
∑ge_ö
);

252 
ö_Àn
 = 
	`mö_t
(
u32
, 
°¨t
 + 
Àn
 - 
cur_ö
, 
£˘‹size
 - 
£˘‹_off
);

253 
	`ASSERT
(
ö_Àn
);

254 
d©a_ö
 = 
	`km≠_loˇl_∑ge
(
∑ge_ö
);

255 
ªt
 = 
	`lzo1x_1_com¥ess
(
d©a_ö
 +

256 
	`off£t_ö_∑ge
(
cur_ö
), 
ö_Àn
,

257 
w‹k•a˚
->
cbuf
, &
out_Àn
,

258 
w‹k•a˚
->
mem
);

259 
	`kunm≠_loˇl
(
d©a_ö
);

260 i‡(
ªt
 < 0) {

261 
	`¥_debug
("BTRFS:ÜzÿöÜo›Ñëu∫ed %d\n", 
ªt
);

262 
ªt
 = -
EIO
;

263 
out
;

266 
ªt
 = 
	`c›y_com¥es£d_d©a_to_∑ge
(
w‹k•a˚
->
cbuf
, 
out_Àn
,

267 
∑ges
, 
max_ƒ_∑ge
,

268 &
cur_out
, 
£˘‹size
);

269 i‡(
ªt
 < 0)

270 
out
;

272 
cur_ö
 +
ö_Àn
;

278 i‡(
cur_ö
 - 
°¨t
 > 
£˘‹size
 * 2 && cur_ö - sèπ < 
cur_out
) {

279 
ªt
 = -
E2BIG
;

280 
out
;

284 i‡(
	`PAGE_ALIGNED
(
cur_ö
)) {

285 
	`put_∑ge
(
∑ge_ö
);

286 
∑ge_ö
 = 
NULL
;

291 
sizes_±r
 = 
	`km≠_loˇl_∑ge
(
∑ges
[0]);

292 
	`wrôe_com¥ess_Àngth
(
sizes_±r
, 
cur_out
);

293 
	`kunm≠_loˇl
(
sizes_±r
);

295 
ªt
 = 0;

296 *
tŸÆ_out
 = 
cur_out
;

297 *
tŸÆ_ö
 = 
cur_ö
 - 
°¨t
;

298 
out
:

299 i‡(
∑ge_ö
)

300 
	`put_∑ge
(
∑ge_ö
);

301 *
out_∑ges
 = 
	`DIV_ROUND_UP
(
cur_out
, 
PAGE_SIZE
);

302  
ªt
;

303 
	}
}

310 
	$c›y_com¥es£d_£gmít
(
com¥es£d_bio
 *
cb
,

311 *
de°
, 
u32
 
Àn
, u32 *
cur_ö
)

313 
u32
 
‹ig_ö
 = *
cur_ö
;

315 *
cur_ö
 < 
‹ig_ö
 + 
Àn
) {

316 
∑ge
 *
cur_∑ge
;

317 
u32
 
c›y_Àn
 = 
	`mö_t
(u32, 
PAGE_SIZE
 - 
	`off£t_ö_∑ge
(*
cur_ö
),

318 
‹ig_ö
 + 
Àn
 - *
cur_ö
);

320 
	`ASSERT
(
c›y_Àn
);

321 
cur_∑ge
 = 
cb
->
com¥es£d_∑ges
[*
cur_ö
 / 
PAGE_SIZE
];

323 
	`mem˝y_‰om_∑ge
(
de°
 + *
cur_ö
 - 
‹ig_ö
, 
cur_∑ge
,

324 
	`off£t_ö_∑ge
(*
cur_ö
), 
c›y_Àn
);

326 *
cur_ö
 +
c›y_Àn
;

328 
	}
}

330 
	$lzo_decom¥ess_bio
(
li°_hód
 *
ws
, 
com¥es£d_bio
 *
cb
)

332 
w‹k•a˚
 *w‹k•a˚ = 
	`li°_íåy
(
ws
, w‹k•a˚, 
li°
);

333 c⁄° 
båfs_fs_öfo
 *
fs_öfo
 = 
cb
->
bbio
.
öode
->
roŸ
->fs_info;

334 c⁄° 
u32
 
£˘‹size
 = 
fs_öfo
->sectorsize;

335 *
kaddr
;

336 
ªt
;

338 
u32
 
Àn_ö
;

340 
u32
 
cur_ö
 = 0;

342 
u32
 
cur_out
 = 0;

344 
kaddr
 = 
	`km≠_loˇl_∑ge
(
cb
->
com¥es£d_∑ges
[0]);

345 
Àn_ö
 = 
	`ªad_com¥ess_Àngth
(
kaddr
);

346 
	`kunm≠_loˇl
(
kaddr
);

347 
cur_ö
 +
LZO_LEN
;

356 i‡(
Àn_ö
 > 
	`mö_t
(
size_t
, 
BTRFS_MAX_COMPRESSED
, 
cb
->
com¥es£d_Àn
) ||

357 
	`round_up
(
Àn_ö
, 
£˘‹size
Ë< 
cb
->
com¥es£d_Àn
) {

358 
	`båfs_îr
(
fs_öfo
,

360 
Àn_ö
, 
cb
->
com¥es£d_Àn
);

361  -
EUCLEAN
;

365 
cur_ö
 < 
Àn_ö
) {

366 
∑ge
 *
cur_∑ge
;

368 
u32
 
£g_Àn
;

369 
u32
 
£˘‹_byãs_À·
;

370 
size_t
 
out_Àn
 = 
	`lzo1x_w‹°_com¥ess
(
£˘‹size
);

376 
	`ASSERT
(
cur_ö
 / 
£˘‹size
 ==

377 (
cur_ö
 + 
LZO_LEN
 - 1Ë/ 
£˘‹size
);

378 
cur_∑ge
 = 
cb
->
com¥es£d_∑ges
[
cur_ö
 / 
PAGE_SIZE
];

379 
	`ASSERT
(
cur_∑ge
);

380 
kaddr
 = 
	`km≠_loˇl_∑ge
(
cur_∑ge
);

381 
£g_Àn
 = 
	`ªad_com¥ess_Àngth
(
kaddr
 + 
	`off£t_ö_∑ge
(
cur_ö
));

382 
	`kunm≠_loˇl
(
kaddr
);

383 
cur_ö
 +
LZO_LEN
;

385 i‡(
£g_Àn
 > 
WORKSPACE_CBUF_LENGTH
) {

390 
	`båfs_îr
(
fs_öfo
, "unexpectedlyÜargeÜzo segmentÜen %u",

391 
£g_Àn
);

392  -
EIO
;

396 
	`c›y_com¥es£d_£gmít
(
cb
, 
w‹k•a˚
->
cbuf
, 
£g_Àn
, &
cur_ö
);

399 
ªt
 = 
	`lzo1x_decom¥ess_ß„
(
w‹k•a˚
->
cbuf
, 
£g_Àn
,

400 
w‹k•a˚
->
buf
, &
out_Àn
);

401 i‡(
ªt
 !
LZO_E_OK
) {

402 
	`båfs_îr
(
fs_öfo
, "failedÅo decompress");

403  -
EIO
;

407 
ªt
 = 
	`båfs_decom¥ess_buf2∑ge
(
w‹k•a˚
->
buf
, 
out_Àn
, 
cb
, 
cur_out
);

408 
cur_out
 +
out_Àn
;

411 i‡(
ªt
 == 0)

413 
ªt
 = 0;

416 
£˘‹_byãs_À·
 = 
£˘‹size
 - (
cur_ö
 % sectorsize);

417 i‡(
£˘‹_byãs_À·
 >
LZO_LEN
)

421 
cur_ö
 +
£˘‹_byãs_À·
;

425 
	}
}

427 
	$lzo_decom¥ess
(
li°_hód
 *
ws
, c⁄° 
u8
 *
d©a_ö
,

428 
∑ge
 *
de°_∑ge
, 
°¨t_byã
, 
size_t
 
§˛í
,

429 
size_t
 
de°Àn
)

431 
w‹k•a˚
 *w‹k•a˚ = 
	`li°_íåy
(
ws
, w‹k•a˚, 
li°
);

432 
size_t
 
ö_Àn
;

433 
size_t
 
out_Àn
;

434 
size_t
 
max_£gmít_Àn
 = 
WORKSPACE_BUF_LENGTH
;

435 
ªt
 = 0;

436 *
kaddr
;

437 
byãs
;

439 i‡(
§˛í
 < 
LZO_LEN
 || sr˛í > 
max_£gmít_Àn
 + LZO_LEN * 2)

440  -
EUCLEAN
;

442 
ö_Àn
 = 
	`ªad_com¥ess_Àngth
(
d©a_ö
);

443 i‡(
ö_Àn
 !
§˛í
)

444  -
EUCLEAN
;

445 
d©a_ö
 +
LZO_LEN
;

447 
ö_Àn
 = 
	`ªad_com¥ess_Àngth
(
d©a_ö
);

448 i‡(
ö_Àn
 !
§˛í
 - 
LZO_LEN
 * 2) {

449 
ªt
 = -
EUCLEAN
;

450 
out
;

452 
d©a_ö
 +
LZO_LEN
;

454 
out_Àn
 = 
PAGE_SIZE
;

455 
ªt
 = 
	`lzo1x_decom¥ess_ß„
(
d©a_ö
, 
ö_Àn
, 
w‹k•a˚
->
buf
, &
out_Àn
);

456 i‡(
ªt
 !
LZO_E_OK
) {

457 
	`¥_w¨n
("BTRFS: decompress failed!\n");

458 
ªt
 = -
EIO
;

459 
out
;

462 i‡(
out_Àn
 < 
°¨t_byã
) {

463 
ªt
 = -
EIO
;

464 
out
;

471 
de°Àn
 = 
	`mö_t
(, de°Àn, 
PAGE_SIZE
);

472 
byãs
 = 
	`mö_t
(, 
de°Àn
, 
out_Àn
 - 
°¨t_byã
);

474 
kaddr
 = 
	`km≠_loˇl_∑ge
(
de°_∑ge
);

475 
	`mem˝y
(
kaddr
, 
w‹k•a˚
->
buf
 + 
°¨t_byã
, 
byãs
);

482 i‡(
byãs
 < 
de°Àn
)

483 
	`mem£t
(
kaddr
+
byãs
, 0, 
de°Àn
-bytes);

484 
	`kunm≠_loˇl
(
kaddr
);

485 
out
:

486  
ªt
;

487 
	}
}

489 c⁄° 
båfs_com¥ess_›
 
	gbåfs_lzo_com¥ess
 = {

490 .
w‹k•a˚_m™agî
 = &
wsm
,

491 .
	gmax_Àvñ
 = 1,

492 .
	gdeÁu…_Àvñ
 = 1,

	@messages.c

3 
	~"fs.h
"

4 
	~"mesßges.h
"

5 
	~"disˇrd.h
"

6 
	~"å™ß˘i⁄.h
"

7 
	~"•a˚-öfo.h
"

8 
	~"su≥r.h
"

10 #ifde‡
CONFIG_PRINTK


12 
	#STATE_STRING_PREFACE
 ": sèã "

	)

13 
	#STATE_STRING_BUF_LEN
 ((
STATE_STRING_PREFACE
Ë+ 
BTRFS_FS_STATE_COUNT
 + 1)

	)

19 c⁄° 
	gfs_°©e_ch¨s
[] = {

20 [
BTRFS_FS_STATE_REMOUNTING
] = 'M',

21 [
BTRFS_FS_STATE_RO
] = 0,

22 [
BTRFS_FS_STATE_TRANS_ABORTED
] = 'A',

23 [
BTRFS_FS_STATE_DEV_REPLACING
] = 'R',

24 [
BTRFS_FS_STATE_DUMMY_FS_INFO
] = 0,

25 [
BTRFS_FS_STATE_NO_CSUMS
] = 'C',

26 [
BTRFS_FS_STATE_LOG_CLEANUP_ERROR
] = 'L',

29 
	$båfs_°©e_to_°rög
(c⁄° 
båfs_fs_öfo
 *
öfo
, *
buf
)

31 
bô
;

32 
boﬁ
 
°©es_¥öãd
 = 
Ál£
;

33 
fs_°©e
 = 
	`READ_ONCE
(
öfo
->fs_state);

34 *
cuº
 = 
buf
;

36 
	`mem˝y
(
cuº
, 
STATE_STRING_PREFACE
, (STATE_STRING_PREFACE));

37 
cuº
 +(
STATE_STRING_PREFACE
) - 1;

39 i‡(
	`BTRFS_FS_ERROR
(
öfo
)) {

40 *
cuº
++ = 'E';

41 
°©es_¥öãd
 = 
åue
;

44 
	`f‹_óch_£t_bô
(
bô
, &
fs_°©e
, (fs_state)) {

45 
	`WARN_ON_ONCE
(
bô
 >
BTRFS_FS_STATE_COUNT
);

46 i‡((
bô
 < 
BTRFS_FS_STATE_COUNT
Ë&& 
fs_°©e_ch¨s
[bit]) {

47 *
cuº
++ = 
fs_°©e_ch¨s
[
bô
];

48 
°©es_¥öãd
 = 
åue
;

53 i‡(!
°©es_¥öãd
)

54 
cuº
 = 
buf
;

56 *
cuº
++ = 0;

57 
	}
}

75 c⁄° * 
__©åibuã_c⁄°__
 
	$båfs_decode_îr‹
(
î∫o
)

77 *
îr°r
 = "unknown";

79 
î∫o
) {

80 -
ENOENT
:

81 
îr°r
 = "No suchÉntry";

83 -
EIO
:

84 
îr°r
 = "IO failure";

86 -
ENOMEM
:

87 
îr°r
 = "Out of memory";

89 -
EEXIST
:

90 
îr°r
 = "ObjectálreadyÉxists";

92 -
ENOSPC
:

93 
îr°r
 = "No spaceÜeft";

95 -
EROFS
:

96 
îr°r
 = "Readonly filesystem";

98 -
EOPNOTSUPP
:

99 
îr°r
 = "OperationÇot supported";

101 -
EUCLEAN
:

102 
îr°r
 = "Filesystem corrupted";

104 -
EDQUOT
:

105 
îr°r
 = "QuotaÉxceeded";

109  
îr°r
;

110 
	}
}

116 
__cﬁd


117 
	$__båfs_h™dÀ_fs_îr‹
(
båfs_fs_öfo
 *
fs_öfo
, c⁄° *
fun˘i⁄
,

118 
löe
, 
î∫o
, c⁄° *
fmt
, ...)

120 
su≥r_block
 *
sb
 = 
fs_öfo
->sb;

121 #ifde‡
CONFIG_PRINTK


122 
°©e°r
[
STATE_STRING_BUF_LEN
];

123 c⁄° *
îr°r
;

126 #ifde‡
CONFIG_PRINTK_INDEX


127 
	`¥ötk_ödex_subsys_emô
(

128 "BTRFS:Éº‹ (devi˚ %s%sËö %s:%d:Éºno=%d %s", 
KERN_CRIT
, 
fmt
);

135 i‡(
î∫o
 =-
EROFS
 && 
	`sb_rd⁄ly
(
sb
))

138 #ifde‡
CONFIG_PRINTK


139 
îr°r
 = 
	`båfs_decode_îr‹
(
î∫o
);

140 
	`båfs_°©e_to_°rög
(
fs_öfo
, 
°©e°r
);

141 i‡(
fmt
) {

142 
va_f‹m©
 
vaf
;

143 
va_li°
 
¨gs
;

145 
	`va_°¨t
(
¨gs
, 
fmt
);

146 
vaf
.
fmt
 = fmt;

147 
vaf
.
va
 = &
¨gs
;

149 
	`¥_¸ô
("BTRFS:Érror (device %s%s) in %s:%d:Érrno=%d %s (%pV)\n",

150 
sb
->
s_id
, 
°©e°r
, 
fun˘i⁄
, 
löe
, 
î∫o
, 
îr°r
, &
vaf
);

151 
	`va_íd
(
¨gs
);

153 
	`¥_¸ô
("BTRFS:Érror (device %s%s) in %s:%d:Érrno=%d %s\n",

154 
sb
->
s_id
, 
°©e°r
, 
fun˘i⁄
, 
löe
, 
î∫o
, 
îr°r
);

162 
	`WRITE_ONCE
(
fs_öfo
->
fs_îr‹
, 
î∫o
);

165 i‡(!(
sb
->
s_Êags
 & 
SB_BORN
))

168 i‡(
	`sb_rd⁄ly
(
sb
))

171 
	`båfs_disˇrd_°›
(
fs_öfo
);

174 
	`båfs_£t_sb_rd⁄ly
(
sb
);

175 
	`båfs_öfo
(
fs_öfo
, "forcedÑeadonly");

184 
	}
}

186 #ifde‡
CONFIG_PRINTK


187 c⁄° * c⁄° 
	glogty≥s
[] = {

202 
øãlimô_°©e
 
	g¥ötk_limôs
[] = {

203 
RATELIMIT_STATE_INIT
(
¥ötk_limôs
[0], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

204 
RATELIMIT_STATE_INIT
(
¥ötk_limôs
[1], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

205 
RATELIMIT_STATE_INIT
(
¥ötk_limôs
[2], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

206 
RATELIMIT_STATE_INIT
(
¥ötk_limôs
[3], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

207 
RATELIMIT_STATE_INIT
(
¥ötk_limôs
[4], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

208 
RATELIMIT_STATE_INIT
(
¥ötk_limôs
[5], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

209 
RATELIMIT_STATE_INIT
(
¥ötk_limôs
[6], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

210 
RATELIMIT_STATE_INIT
(
¥ötk_limôs
[7], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

213 
__cﬁd
 
	$_båfs_¥ötk
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, c⁄° *
fmt
, ...)

215 
lvl
[
PRINTK_MAX_SINGLE_HEADER_LEN
 + 1] = "\0";

216 
va_f‹m©
 
vaf
;

217 
va_li°
 
¨gs
;

218 
kîn_Àvñ
;

219 c⁄° *
ty≥
 = 
logty≥s
[4];

220 
øãlimô_°©e
 *
øãlimô
 = &
¥ötk_limôs
[4];

222 #ifde‡
CONFIG_PRINTK_INDEX


223 
	`¥ötk_ödex_subsys_emô
("%sBTRFS %†(devi˚ %s): ", 
NULL
, 
fmt
);

226 
	`va_°¨t
(
¨gs
, 
fmt
);

228 (
kîn_Àvñ
 = 
	`¥ötk_gë_Àvñ
(
fmt
)) != 0) {

229 
size_t
 
size
 = 
	`¥ötk_skù_Àvñ
(
fmt
) - fmt;

231 i‡(
kîn_Àvñ
 >= '0' && kern_level <= '7') {

232 
	`mem˝y
(
lvl
, 
fmt
, 
size
);

233 
lvl
[
size
] = '\0';

234 
ty≥
 = 
logty≥s
[
kîn_Àvñ
 - '0'];

235 
øãlimô
 = &
¥ötk_limôs
[
kîn_Àvñ
 - '0'];

237 
fmt
 +
size
;

240 
vaf
.
fmt
 = fmt;

241 
vaf
.
va
 = &
¨gs
;

243 i‡(
	`__øãlimô
(
øãlimô
)) {

244 i‡(
fs_öfo
) {

245 
°©e°r
[
STATE_STRING_BUF_LEN
];

247 
	`båfs_°©e_to_°rög
(
fs_öfo
, 
°©e°r
);

248 
	`_¥ötk
("%sBTRFS %†(devi˚ %s%s): %pV\n", 
lvl
, 
ty≥
,

249 
fs_öfo
->
sb
->
s_id
, 
°©e°r
, &
vaf
);

251 
	`_¥ötk
("%sBTRFS %s: %pV\n", 
lvl
, 
ty≥
, &
vaf
);

255 
	`va_íd
(
¨gs
);

256 
	}
}

259 #i‡
BITS_PER_LONG
 == 32

260 
__cﬁd
 
	$båfs_w¨n_32bô_limô
(
båfs_fs_öfo
 *
fs_öfo
)

262 i‡(!
	`ã°_™d_£t_bô
(
BTRFS_FS_32BIT_WARN
, &
fs_öfo
->
Êags
)) {

263 
	`båfs_w¨n
(
fs_öfo
, "reaching 32bitÜimit forÜogicaláddresses");

264 
	`båfs_w¨n
(
fs_öfo
,

266 
BTRFS_32BIT_MAX_FILE_SIZE
 >> 40);

267 
	`båfs_w¨n
(
fs_öfo
,

270 
	}
}

272 
__cﬁd
 
	$båfs_îr_32bô_limô
(
båfs_fs_öfo
 *
fs_öfo
)

274 i‡(!
	`ã°_™d_£t_bô
(
BTRFS_FS_32BIT_ERROR
, &
fs_öfo
->
Êags
)) {

275 
	`båfs_îr
(
fs_öfo
, "reached 32bitÜimit forÜogicaláddresses");

276 
	`båfs_îr
(
fs_öfo
,

278 
BTRFS_32BIT_MAX_FILE_SIZE
 >> 40);

279 
	`båfs_îr
(
fs_öfo
,

282 
	}
}

289 
__cﬁd


290 
	$__båfs_∑nic
(
båfs_fs_öfo
 *
fs_öfo
, c⁄° *
fun˘i⁄
,

291 
löe
, 
î∫o
, c⁄° *
fmt
, ...)

293 *
s_id
 = "<unknown>";

294 c⁄° *
îr°r
;

295 
va_f‹m©
 
vaf
 = { .
fmt
 = fmt };

296 
va_li°
 
¨gs
;

298 i‡(
fs_öfo
)

299 
s_id
 = 
fs_öfo
->
sb
->s_id;

301 
	`va_°¨t
(
¨gs
, 
fmt
);

302 
vaf
.
va
 = &
¨gs
;

304 
îr°r
 = 
	`båfs_decode_îr‹
(
î∫o
);

305 i‡(
fs_öfo
 && (
	`båfs_ã°_›t
(fs_öfo, 
PANIC_ON_FATAL_ERROR
)))

306 
	`∑nic
(
KERN_CRIT
 "BTRFSÖanic (device %s) in %s:%d: %pV (errno=%d %s)\n",

307 
s_id
, 
fun˘i⁄
, 
löe
, &
vaf
, 
î∫o
, 
îr°r
);

309 
	`båfs_¸ô
(
fs_öfo
, "panic in %s:%d: %pV (errno=%d %s)",

310 
fun˘i⁄
, 
löe
, &
vaf
, 
î∫o
, 
îr°r
);

311 
	`va_íd
(
¨gs
);

313 
	}
}

	@messages.h

3 #i‚de‡
BTRFS_MESSAGES_H


4 
	#BTRFS_MESSAGES_H


	)

6 
	~<löux/ty≥s.h
>

7 
	~<löux/¥ötk.h
>

8 
	~<löux/bug.h
>

10 
	gbåfs_fs_öfo
;

15 #ifde‡
__KERNEL__


17 
ölöe
 
	$__¥ötf
(2, 3Ë
__cﬁd


18 
	$båfs_no_¥ötk
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, c⁄° *
fmt
, ...)

20 
	}
}

24 #ifde‡
CONFIG_PRINTK


26 
	#båfs_¥ötk
(
fs_öfo
, 
fmt
, 
¨gs
...) \

27 
	`_båfs_¥ötk
(
fs_öfo
, 
fmt
, ##
¨gs
)

	)

29 
	$__¥ötf
(2, 3)

30 
__cﬁd


31 
	`_båfs_¥ötk
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, c⁄° *
fmt
, ...);

35 
	#båfs_¥ötk
(
fs_öfo
, 
fmt
, 
¨gs
...) \

36 
	`båfs_no_¥ötk
(
fs_öfo
, 
fmt
, ##
¨gs
)

	)

39 
	#båfs_emîg
(
fs_öfo
, 
fmt
, 
¨gs
...) \

40 
	`båfs_¥ötk
(
fs_öfo
, 
KERN_EMERG
 
fmt
, ##
¨gs
)

	)

41 
	#båfs_Æît
(
fs_öfo
, 
fmt
, 
¨gs
...) \

42 
	`båfs_¥ötk
(
fs_öfo
, 
KERN_ALERT
 
fmt
, ##
¨gs
)

	)

43 
	#båfs_¸ô
(
fs_öfo
, 
fmt
, 
¨gs
...) \

44 
	`båfs_¥ötk
(
fs_öfo
, 
KERN_CRIT
 
fmt
, ##
¨gs
)

	)

45 
	#båfs_îr
(
fs_öfo
, 
fmt
, 
¨gs
...) \

46 
	`båfs_¥ötk
(
fs_öfo
, 
KERN_ERR
 
fmt
, ##
¨gs
)

	)

47 
	#båfs_w¨n
(
fs_öfo
, 
fmt
, 
¨gs
...) \

48 
	`båfs_¥ötk
(
fs_öfo
, 
KERN_WARNING
 
fmt
, ##
¨gs
)

	)

49 
	#båfs_nŸi˚
(
fs_öfo
, 
fmt
, 
¨gs
...) \

50 
	`båfs_¥ötk
(
fs_öfo
, 
KERN_NOTICE
 
fmt
, ##
¨gs
)

	)

51 
	#båfs_öfo
(
fs_öfo
, 
fmt
, 
¨gs
...) \

52 
	`båfs_¥ötk
(
fs_öfo
, 
KERN_INFO
 
fmt
, ##
¨gs
)

	)

57 
	#båfs_emîg_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

58 
	`båfs_¥ötk_ö_rcu
(
fs_öfo
, 
KERN_EMERG
 
fmt
, ##
¨gs
)

	)

59 
	#båfs_Æît_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

60 
	`båfs_¥ötk_ö_rcu
(
fs_öfo
, 
KERN_ALERT
 
fmt
, ##
¨gs
)

	)

61 
	#båfs_¸ô_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

62 
	`båfs_¥ötk_ö_rcu
(
fs_öfo
, 
KERN_CRIT
 
fmt
, ##
¨gs
)

	)

63 
	#båfs_îr_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

64 
	`båfs_¥ötk_ö_rcu
(
fs_öfo
, 
KERN_ERR
 
fmt
, ##
¨gs
)

	)

65 
	#båfs_w¨n_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

66 
	`båfs_¥ötk_ö_rcu
(
fs_öfo
, 
KERN_WARNING
 
fmt
, ##
¨gs
)

	)

67 
	#båfs_nŸi˚_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

68 
	`båfs_¥ötk_ö_rcu
(
fs_öfo
, 
KERN_NOTICE
 
fmt
, ##
¨gs
)

	)

69 
	#båfs_öfo_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

70 
	`båfs_¥ötk_ö_rcu
(
fs_öfo
, 
KERN_INFO
 
fmt
, ##
¨gs
)

	)

75 
	#båfs_emîg_æ_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

76 
	`båfs_¥ötk_æ_ö_rcu
(
fs_öfo
, 
KERN_EMERG
 
fmt
, ##
¨gs
)

	)

77 
	#båfs_Æît_æ_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

78 
	`båfs_¥ötk_æ_ö_rcu
(
fs_öfo
, 
KERN_ALERT
 
fmt
, ##
¨gs
)

	)

79 
	#båfs_¸ô_æ_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

80 
	`båfs_¥ötk_æ_ö_rcu
(
fs_öfo
, 
KERN_CRIT
 
fmt
, ##
¨gs
)

	)

81 
	#båfs_îr_æ_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

82 
	`båfs_¥ötk_æ_ö_rcu
(
fs_öfo
, 
KERN_ERR
 
fmt
, ##
¨gs
)

	)

83 
	#båfs_w¨n_æ_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

84 
	`båfs_¥ötk_æ_ö_rcu
(
fs_öfo
, 
KERN_WARNING
 
fmt
, ##
¨gs
)

	)

85 
	#båfs_nŸi˚_æ_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

86 
	`båfs_¥ötk_æ_ö_rcu
(
fs_öfo
, 
KERN_NOTICE
 
fmt
, ##
¨gs
)

	)

87 
	#båfs_öfo_æ_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

88 
	`båfs_¥ötk_æ_ö_rcu
(
fs_öfo
, 
KERN_INFO
 
fmt
, ##
¨gs
)

	)

93 
	#båfs_emîg_æ
(
fs_öfo
, 
fmt
, 
¨gs
...) \

94 
	`båfs_¥ötk_øãlimôed
(
fs_öfo
, 
KERN_EMERG
 
fmt
, ##
¨gs
)

	)

95 
	#båfs_Æît_æ
(
fs_öfo
, 
fmt
, 
¨gs
...) \

96 
	`båfs_¥ötk_øãlimôed
(
fs_öfo
, 
KERN_ALERT
 
fmt
, ##
¨gs
)

	)

97 
	#båfs_¸ô_æ
(
fs_öfo
, 
fmt
, 
¨gs
...) \

98 
	`båfs_¥ötk_øãlimôed
(
fs_öfo
, 
KERN_CRIT
 
fmt
, ##
¨gs
)

	)

99 
	#båfs_îr_æ
(
fs_öfo
, 
fmt
, 
¨gs
...) \

100 
	`båfs_¥ötk_øãlimôed
(
fs_öfo
, 
KERN_ERR
 
fmt
, ##
¨gs
)

	)

101 
	#båfs_w¨n_æ
(
fs_öfo
, 
fmt
, 
¨gs
...) \

102 
	`båfs_¥ötk_øãlimôed
(
fs_öfo
, 
KERN_WARNING
 
fmt
, ##
¨gs
)

	)

103 
	#båfs_nŸi˚_æ
(
fs_öfo
, 
fmt
, 
¨gs
...) \

104 
	`båfs_¥ötk_øãlimôed
(
fs_öfo
, 
KERN_NOTICE
 
fmt
, ##
¨gs
)

	)

105 
	#båfs_öfo_æ
(
fs_öfo
, 
fmt
, 
¨gs
...) \

106 
	`båfs_¥ötk_øãlimôed
(
fs_öfo
, 
KERN_INFO
 
fmt
, ##
¨gs
)

	)

108 #i‡
	`deföed
(
CONFIG_DYNAMIC_DEBUG
)

109 
	#båfs_debug
(
fs_öfo
, 
fmt
, 
¨gs
...) \

110 
	`_dy«mic_func_ˇŒ_no_desc
(
fmt
, 
båfs_¥ötk
, \

111 
fs_öfo
, 
KERN_DEBUG
 
fmt
, ##
¨gs
)

	)

112 
	#båfs_debug_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

113 
	`_dy«mic_func_ˇŒ_no_desc
(
fmt
, 
båfs_¥ötk_ö_rcu
, \

114 
fs_öfo
, 
KERN_DEBUG
 
fmt
, ##
¨gs
)

	)

115 
	#båfs_debug_æ_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

116 
	`_dy«mic_func_ˇŒ_no_desc
(
fmt
, 
båfs_¥ötk_æ_ö_rcu
, \

117 
fs_öfo
, 
KERN_DEBUG
 
fmt
, ##
¨gs
)

	)

118 
	#båfs_debug_æ
(
fs_öfo
, 
fmt
, 
¨gs
...) \

119 
	`_dy«mic_func_ˇŒ_no_desc
(
fmt
, 
båfs_¥ötk_øãlimôed
, \

120 
fs_öfo
, 
KERN_DEBUG
 
fmt
, ##
¨gs
)

	)

121 #ñi‡
	`deföed
(
DEBUG
)

122 
	#båfs_debug
(
fs_öfo
, 
fmt
, 
¨gs
...) \

123 
	`båfs_¥ötk
(
fs_öfo
, 
KERN_DEBUG
 
fmt
, ##
¨gs
)

	)

124 
	#båfs_debug_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

125 
	`båfs_¥ötk_ö_rcu
(
fs_öfo
, 
KERN_DEBUG
 
fmt
, ##
¨gs
)

	)

126 
	#båfs_debug_æ_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

127 
	`båfs_¥ötk_æ_ö_rcu
(
fs_öfo
, 
KERN_DEBUG
 
fmt
, ##
¨gs
)

	)

128 
	#båfs_debug_æ
(
fs_öfo
, 
fmt
, 
¨gs
...) \

129 
	`båfs_¥ötk_øãlimôed
(
fs_öfo
, 
KERN_DEBUG
 
fmt
, ##
¨gs
)

	)

131 
	#båfs_debug
(
fs_öfo
, 
fmt
, 
¨gs
...) \

132 
	`båfs_no_¥ötk
(
fs_öfo
, 
KERN_DEBUG
 
fmt
, ##
¨gs
)

	)

133 
	#båfs_debug_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

134 
	`båfs_no_¥ötk_ö_rcu
(
fs_öfo
, 
KERN_DEBUG
 
fmt
, ##
¨gs
)

	)

135 
	#båfs_debug_æ_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

136 
	`båfs_no_¥ötk_ö_rcu
(
fs_öfo
, 
KERN_DEBUG
 
fmt
, ##
¨gs
)

	)

137 
	#båfs_debug_æ
(
fs_öfo
, 
fmt
, 
¨gs
...) \

138 
	`båfs_no_¥ötk
(
fs_öfo
, 
KERN_DEBUG
 
fmt
, ##
¨gs
)

	)

141 
	#båfs_¥ötk_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

143 
	`rcu_ªad_lock
(); \

144 
	`båfs_¥ötk
(
fs_öfo
, 
fmt
, ##
¨gs
); \

145 
	`rcu_ªad_u∆ock
(); \

146 
	}
} 0)

	)

148 
	#båfs_no_¥ötk_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

150 
	`rcu_ªad_lock
(); \

151 
	`båfs_no_¥ötk
(
fs_öfo
, 
fmt
, ##
¨gs
); \

152 
	`rcu_ªad_u∆ock
(); \

153 } 0)

	)

155 
	#båfs_¥ötk_øãlimôed
(
fs_öfo
, 
fmt
, 
¨gs
...) \

157 
	`DEFINE_RATELIMIT_STATE
(
_rs
, \

158 
DEFAULT_RATELIMIT_INTERVAL
, \

159 
DEFAULT_RATELIMIT_BURST
); \

160 i‡(
	`__øãlimô
(&
_rs
)) \

161 
	`båfs_¥ötk
(
fs_öfo
, 
fmt
, ##
¨gs
); \

162 } 0)

	)

164 
	#båfs_¥ötk_æ_ö_rcu
(
fs_öfo
, 
fmt
, 
¨gs
...) \

166 
	`rcu_ªad_lock
(); \

167 
	`båfs_¥ötk_øãlimôed
(
fs_öfo
, 
fmt
, ##
¨gs
); \

168 
	`rcu_ªad_u∆ock
(); \

169 } 0)

	)

171 #ifde‡
CONFIG_BTRFS_ASSERT


173 
	#båfs_as£πÁû
(
ex¥
, 
fûe
, 
löe
) ({ \

174 
	`¥_îr
("as£πi⁄ faûed: %s, i¿%s:%d\n", (
ex¥
), (
fûe
), (
löe
)); \

175 
	`BUG
(); \

176 })

	)

178 
	#ASSERT
(
ex¥
) \

179 (
	`likñy
(
ex¥
Ë? ()0 : 
	`båfs_as£πÁû
(#ex¥, 
__FILE__
, 
__LINE__
))

	)

181 
	#ASSERT
(
ex¥
Ë()”x¥)

	)

184 
	$__¥ötf
(5, 6)

185 
__cﬁd


186 
	`__båfs_h™dÀ_fs_îr‹
(
båfs_fs_öfo
 *
fs_öfo
, c⁄° *
fun˘i⁄
,

187 
löe
, 
î∫o
, c⁄° *
fmt
, ...);

189 c⁄° * 
__©åibuã_c⁄°__
 
	`båfs_decode_îr‹
(
î∫o
);

191 
	#båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
î∫o
, 
fmt
, 
¨gs
...) \

192 
	`__båfs_h™dÀ_fs_îr‹
((
fs_öfo
), 
__func__
, 
__LINE__
, \

193 (
î∫o
), 
fmt
, ##
¨gs
)

	)

195 
	$__¥ötf
(5, 6)

196 
__cﬁd


197 
	`__båfs_∑nic
(
båfs_fs_öfo
 *
fs_öfo
, c⁄° *
fun˘i⁄
,

198 
löe
, 
î∫o
, c⁄° *
fmt
, ...);

203 
	#båfs_∑nic
(
fs_öfo
, 
î∫o
, 
fmt
, 
¨gs
...) \

205 
	`__båfs_∑nic
(
fs_öfo
, 
__func__
, 
__LINE__
, 
î∫o
, 
fmt
, ##
¨gs
); \

206 
	`BUG
(); \

207 
	}
} 0)

	)

209 #i‡
BITS_PER_LONG
 == 32

210 
	#BTRFS_32BIT_MAX_FILE_SIZE
 (((
u64
)
ULONG_MAX
 + 1Ë<< 
PAGE_SHIFT
)

	)

217 
	#BTRFS_32BIT_EARLY_WARN_THRESHOLD
 (
BTRFS_32BIT_MAX_FILE_SIZE
 * 5 / 8)

	)

218 
båfs_w¨n_32bô_limô
(
båfs_fs_öfo
 *
fs_öfo
);

219 
båfs_îr_32bô_limô
(
båfs_fs_öfo
 *
fs_öfo
);

	@misc.h

3 #i‚de‡
BTRFS_MISC_H


4 
	#BTRFS_MISC_H


	)

6 
	~<löux/sched.h
>

7 
	~<löux/waô.h
>

8 
	~<löux/m©h64.h
>

9 
	~<löux/rbåì.h
>

14 
	#ENUM_BIT
(
«me
) \

15 
__
 ## 
«me
 ## 
_BIT
, \

16 
«me
 = (1U << 
__
 ##Çamê## 
_BIT
), \

17 
__
 ## 
«me
 ## 
_SEQ
 = __ ##Çamê## 
_BIT


	)

19 
ölöe
 
	$c⁄d_wake_up
(
waô_queue_hód
 *
wq
)

25 i‡(
	`wq_has_¶ì≥r
(
wq
))

26 
	`wake_up
(
wq
);

27 
	}
}

29 
ölöe
 
	$c⁄d_wake_up_nomb
(
waô_queue_hód
 *
wq
)

37 i‡(
	`waôqueue_a˘ive
(
wq
))

38 
	`wake_up
(
wq
);

39 
	}
}

41 
ölöe
 
u64
 
	$mu…_≥rc
(
u64
 
num
, 
u32
 
≥r˚¡
)

43  
	`div_u64
(
num
 * 
≥r˚¡
, 100);

44 
	}
}

46 
ölöe
 
boﬁ
 
	$is_powî_of_two_u64
(
u64
 
n
)

48  
n
 != 0 && (n & (n - 1)) == 0;

49 
	}
}

51 
ölöe
 
boﬁ
 
	$has_sögÀ_bô_£t
(
u64
 
n
)

53  
	`is_powî_of_two_u64
(
n
);

54 
	}
}

62 
	srb_sim∂e_node
 {

63 
rb_node
 
	mrb_node
;

64 
u64
 
	mbyãƒ
;

67 
ölöe
 
rb_node
 *
	$rb_sim∂e_£¨ch
(
rb_roŸ
 *
roŸ
, 
u64
 
byãƒ
)

69 
rb_node
 *
node
 = 
roŸ
->rb_node;

70 
rb_sim∂e_node
 *
íåy
;

72 
node
) {

73 
íåy
 = 
	`rb_íåy
(
node
, 
rb_sim∂e_node
, 
rb_node
);

75 i‡(
byãƒ
 < 
íåy
->bytenr)

76 
node
 =Çode->
rb_À·
;

77 i‡(
byãƒ
 > 
íåy
->bytenr)

78 
node
 =Çode->
rb_right
;

80  
node
;

82  
NULL
;

83 
	}
}

94 
ölöe
 
rb_node
 *
	$rb_sim∂e_£¨ch_fú°
(
rb_roŸ
 *
roŸ
,

95 
u64
 
byãƒ
)

97 
rb_node
 *
node
 = 
roŸ
->rb_node, *
ªt
 = 
NULL
;

98 
rb_sim∂e_node
 *
íåy
, *
ªt_íåy
 = 
NULL
;

100 
node
) {

101 
íåy
 = 
	`rb_íåy
(
node
, 
rb_sim∂e_node
, 
rb_node
);

103 i‡(
byãƒ
 < 
íåy
->bytenr) {

104 i‡(!
ªt
 || 
íåy
->
byãƒ
 < 
ªt_íåy
->bytenr) {

105 
ªt
 = 
node
;

106 
ªt_íåy
 = 
íåy
;

109 
node
 =Çode->
rb_À·
;

110 } i‡(
byãƒ
 > 
íåy
->bytenr) {

111 
node
 =Çode->
rb_right
;

113  
node
;

117  
ªt
;

118 
	}
}

120 
ölöe
 
rb_node
 *
	$rb_sim∂e_ö£π
(
rb_roŸ
 *
roŸ
, 
u64
 
byãƒ
,

121 
rb_node
 *
node
)

123 
rb_node
 **
p
 = &
roŸ
->rb_node;

124 
rb_node
 *
∑ª¡
 = 
NULL
;

125 
rb_sim∂e_node
 *
íåy
;

127 *
p
) {

128 
∑ª¡
 = *
p
;

129 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
rb_sim∂e_node
, 
rb_node
);

131 i‡(
byãƒ
 < 
íåy
->bytenr)

132 
p
 = &(*p)->
rb_À·
;

133 i‡(
byãƒ
 > 
íåy
->bytenr)

134 
p
 = &(*p)->
rb_right
;

136  
∑ª¡
;

139 
	`rb_lök_node
(
node
, 
∑ª¡
, 
p
);

140 
	`rb_ö£π_cﬁ‹
(
node
, 
roŸ
);

141  
NULL
;

142 
	}
}

144 
ölöe
 
boﬁ
 
	$bôm≠_ã°_ønge_Æl_£t
(c⁄° *
addr
,

145 
°¨t
,

146 
nbôs
)

148 
found_zîo
;

150 
found_zîo
 = 
	`föd_√xt_zîo_bô
(
addr
, 
°¨t
 + 
nbôs
, start);

151  (
found_zîo
 =
°¨t
 + 
nbôs
);

152 
	}
}

154 
ölöe
 
boﬁ
 
	$bôm≠_ã°_ønge_Æl_zîo
(c⁄° *
addr
,

155 
°¨t
,

156 
nbôs
)

158 
found_£t
;

160 
found_£t
 = 
	`föd_√xt_bô
(
addr
, 
°¨t
 + 
nbôs
, start);

161  (
found_£t
 =
°¨t
 + 
nbôs
);

162 
	}
}

	@mm/filemap.c

1 
	~<löux/exp‹t.h
>

2 
	~<löux/compûî.h
>

3 
	~<löux/dax.h
>

4 
	~<löux/fs.h
>

5 
	~<löux/sched/sig«l.h
>

6 
	~<löux/uac˚ss.h
>

7 
	~<löux/ˇ∑bûôy.h
>

8 
	~<löux/kî√l_°©.h
>

9 
	~<löux/gÂ.h
>

10 
	~<löux/mm.h
>

11 
	~<löux/sw≠.h
>

12 
	~<löux/sw≠›s.h
>

13 
	~<löux/sysˇŒs.h
>

14 
	~<löux/mm™.h
>

15 
	~<löux/∑gem≠.h
>

16 
	~<löux/fûe.h
>

17 
	~<löux/uio.h
>

18 
	~<löux/îr‹-öje˘i⁄.h
>

19 
	~<löux/hash.h
>

20 
	~<löux/wrôeback.h
>

21 
	~<löux/backög-dev.h
>

22 
	~<löux/∑gevec.h
>

23 
	~<löux/£curôy.h
>

24 
	~<löux/˝u£t.h
>

25 
	~<löux/hugëlb.h
>

26 
	~<löux/memc⁄åﬁ.h
>

27 
	~<löux/shmem_fs.h
>

28 
	~<löux/rm≠.h
>

29 
	~<löux/dñayac˘.h
>

30 
	~<löux/psi.h
>

31 
	~<löux/ømfs.h
>

32 
	~<löux/∑ge_idÀ.h
>

33 
	~<löux/migøã.h
>

34 
	~<löux/pùe_fs_i.h
>

35 
	~<löux/•li˚.h
>

36 
	~<asm/pgÆloc.h
>

37 
	~<asm/ébÊush.h
>

38 
	~"../fs.h
"

39 
	~"../su≥r.h
"

40 
	~"öã∫Æ.h
"

41 
	#CREATE_TRACE_POINTS


	)

42 
	~<åa˚/evíts/fûem≠.h
>

44 
	~<löux/buf„r_hód.h
>

46 
	~<asm/mm™.h
>

77 
ölöe


78 
	$båfs_∑ge_ˇche_sync_ªadahód
(
addªss_•a˚
 *
m≠pög
,

79 
fûe_ø_°©e
 *
ø
, 
fûe
 *fûe, 
pgoff_t
 
ödex
,

80 
ªq_cou¡
)

82 
	`DEFINE_READAHEAD
(
ø˘l
, 
fûe
, 
ø
, 
m≠pög
, 
ödex
);

83 
	`∑ge_ˇche_sync_ø
(&
ø˘l
, 
ªq_cou¡
);

84 
öode
 *
ho°
 = 
m≠pög
->host;

85 
su≥r_block
 *
sb
 = 
ho°
->
i_sb
;

88 
	}
}

91 
boﬁ
 
	$pos_ßme_fﬁio
(
loff_t
 
pos1
,Üoff_à
pos2
, 
fﬁio
 *folio)

93 
shi·
 = 
	`fﬁio_shi·
(
fﬁio
);

95  (
pos1
 >> 
shi·
 =
pos2
 >> shift);

96 
	}
}

101 
	$fûem≠_ªadahód
(
kiocb
 *
iocb
, 
fûe
 *file,

102 
addªss_•a˚
 *
m≠pög
, 
fﬁio
 *folio,

103 
pgoff_t
 
œ°_ödex
)

105 
	`DEFINE_READAHEAD
(
ø˘l
, 
fûe
, &fûe->
f_ø
, 
m≠pög
, 
fﬁio
->
ödex
);

107 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOIO
)

108  -
EAGAIN
;

109 
	`∑ge_ˇche_async_ø
(&
ø˘l
, 
fﬁio
, 
œ°_ödex
 - fﬁio->
ödex
);

111 
	}
}

113 
	$båfs_fûem≠_gë_∑ges
(
kiocb
 *
iocb
, 
size_t
 
cou¡
,

114 
fﬁio_b©ch
 *
fb©ch
, 
boﬁ
 
√ed_u±od©e
)

116 
fûe
 *
fûp
 = 
iocb
->
ki_fûp
;

117 
addªss_•a˚
 *
m≠pög
 = 
fûp
->
f_m≠pög
;

119 
öode
 *
f_öode
;

120 
f_öode
 = 
	`fûe_öode
(
iocb
->
ki_fûp
);

126 i‡(
f_öode
->
has_ªmŸe
 == 0) {

127 
m≠pög
 = 
f_öode
->
i_m≠pög
;

134 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
f_öode
->
i_sb
);

139 
fûe_ø_°©e
 *
ø
 = &
fûp
->
f_ø
;

140 
pgoff_t
 
ödex
 = 
iocb
->
ki_pos
 >> 
PAGE_SHIFT
;

141 
pgoff_t
 
œ°_ödex
;

142 
fﬁio
 *folio;

143 
îr
 = 0;

145 
œ°_ödex
 = 
	`DIV_ROUND_UP
(
iocb
->
ki_pos
 + 
cou¡
, 
PAGE_SIZE
);

146 
ªåy
:

147 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
))

148  -
EINTR
;

150 
	`fûem≠_gë_ªad_b©ch
(
m≠pög
, 
ödex
, 
œ°_ödex
 - 1, 
fb©ch
);

152 i‡(!
	`fﬁio_b©ch_cou¡
(
fb©ch
)) {

153 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOIO
)

154  -
EAGAIN
;

155 
	`båfs_∑ge_ˇche_sync_ªadahód
(
m≠pög
, 
ø
, 
fûp
, 
ödex
, 
œ°_ödex
 - index);

157 
	`fûem≠_gë_ªad_b©ch
(
m≠pög
, 
ödex
, 
œ°_ödex
 - 1, 
fb©ch
);

159 i‡(!
	`fﬁio_b©ch_cou¡
(
fb©ch
)) {

160 i‡(
iocb
->
ki_Êags
 & (
IOCB_NOWAIT
 | 
IOCB_WAITQ
))

161  -
EAGAIN
;

162 
îr
 = 
	`fûem≠_¸óã_fﬁio
(
fûp
, 
m≠pög
,

163 
iocb
->
ki_pos
 >> 
PAGE_SHIFT
, 
fb©ch
);

164 i‡(
îr
 =
AOP_TRUNCATED_PAGE
)

165 
ªåy
;

166  
îr
;

169 
fﬁio
 = 
fb©ch
->
fﬁios
[
	`fﬁio_b©ch_cou¡
(fbatch) - 1];

171 i‡(
	`fﬁio_ã°_ªadahód
(
fﬁio
)) {

173 
îr
 = 
	`fûem≠_ªadahód
(
iocb
, 
fûp
, 
m≠pög
, 
fﬁio
, 
œ°_ödex
);

175 i‡(
îr
)

176 
îr
;

178 i‡(!
	`fﬁio_ã°_u±od©e
(
fﬁio
)) {

179 i‡((
iocb
->
ki_Êags
 & 
IOCB_WAITQ
Ë&& 
	`fﬁio_b©ch_cou¡
(
fb©ch
) > 1)

180 
iocb
->
ki_Êags
 |
IOCB_NOWAIT
;

182 
îr
 = 
	`fûem≠_upd©e_∑ge
(
iocb
, 
m≠pög
, 
cou¡
, 
fﬁio
,

183 
√ed_u±od©e
);

184 i‡(
îr
)

185 
îr
;

188 
îr
:

189 i‡(
îr
 < 0)

190 
	`fﬁio_put
(
fﬁio
);

191 i‡(
	`likñy
(--
fb©ch
->
ƒ
))

193 i‡(
îr
 =
AOP_TRUNCATED_PAGE
)

194 
ªåy
;

195  
îr
;

196 
	}
}

199 
ssize_t
 
	$båfs_fûem≠_ªad
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
,

200 
ssize_t
 
Æªady_ªad
)

202 
fûe
 *
fûp
 = 
iocb
->
ki_fûp
;

203 
fûe_ø_°©e
 *
ø
 = &
fûp
->
f_ø
;

204 
addªss_•a˚
 *
m≠pög
 = 
fûp
->
f_m≠pög
;

205 
öode
 *öodê
m≠pög
->
ho°
;

208 
fﬁio_b©ch
 
fb©ch
;

209 
i
, 
îr‹
 = 0;

210 
boﬁ
 
wrôably_m≠≥d
;

211 
loff_t
 
isize
, 
íd_off£t
;

212 
loff_t
 
œ°_pos
 = 
ø
->
¥ev_pos
;

214 i‡(
	`u∆ikñy
(
iocb
->
ki_pos
 >
öode
->
i_sb
->
s_maxbyãs
))

216 i‡(
	`u∆ikñy
(!
	`iov_ôî_cou¡
(
ôî
)))

221 
	`iov_ôî_åunˇã
(
ôî
, 
öode
->
i_sb
->
s_maxbyãs
);

222 
	`fﬁio_b©ch_öô
(&
fb©ch
);

225 
	`c⁄d_ªsched
();

232 i‡((
iocb
->
ki_Êags
 & 
IOCB_WAITQ
Ë&& 
Æªady_ªad
)

233 
iocb
->
ki_Êags
 |
IOCB_NOWAIT
;

235 i‡(
	`u∆ikñy
(
iocb
->
ki_pos
 >
	`i_size_ªad
(
öode
)))

238 
îr‹
 = 
	`båfs_fûem≠_gë_∑ges
(
iocb
, 
ôî
->
cou¡
, &
fb©ch
, 
Ál£
);

239 i‡(
îr‹
 < 0)

250 
isize
 = 
	`i_size_ªad
(
öode
);

251 i‡(
	`u∆ikñy
(
iocb
->
ki_pos
 >
isize
))

252 
put_fﬁios
;

253 
íd_off£t
 = 
	`mö_t
(
loff_t
, 
isize
, 
iocb
->
ki_pos
 + 
ôî
->
cou¡
);

259 
wrôably_m≠≥d
 = 
	`m≠pög_wrôably_m≠≥d
(
m≠pög
);

265 i‡(!
	`pos_ßme_fﬁio
(
iocb
->
ki_pos
, 
œ°_pos
 - 1,

266 
fb©ch
.
fﬁios
[0]))

267 
	`fﬁio_m¨k_ac˚s£d
(
fb©ch
.
fﬁios
[0]);

269 
i
 = 0; i < 
	`fﬁio_b©ch_cou¡
(&
fb©ch
); i++) {

270 
fﬁio
 *fﬁiÿ
fb©ch
.
fﬁios
[
i
];

271 
size_t
 
fsize
 = 
	`fﬁio_size
(
fﬁio
);

272 
size_t
 
off£t
 = 
iocb
->
ki_pos
 & (
fsize
 - 1);

273 
size_t
 
byãs
 = 
	`mö_t
(
loff_t
, 
íd_off£t
 - 
iocb
->
ki_pos
,

274 
fsize
 - 
off£t
);

275 
size_t
 
c›õd
;

277 i‡(
íd_off£t
 < 
	`fﬁio_pos
(
fﬁio
))

279 i‡(
i
 > 0)

280 
	`fﬁio_m¨k_ac˚s£d
(
fﬁio
);

286 i‡(
wrôably_m≠≥d
)

287 
	`Êush_dˇche_fﬁio
(
fﬁio
);

289 
c›õd
 = 
	`c›y_fﬁio_to_ôî
(
fﬁio
, 
off£t
, 
byãs
, 
ôî
);

290 
Æªady_ªad
 +
c›õd
;

291 
iocb
->
ki_pos
 +
c›õd
;

292 
œ°_pos
 = 
iocb
->
ki_pos
;

294 i‡(
c›õd
 < 
byãs
) {

295 
îr‹
 = -
EFAULT
;

299 
put_fﬁios
:

300 
i
 = 0; i < 
	`fﬁio_b©ch_cou¡
(&
fb©ch
); i++)

301 
	`fﬁio_put
(
fb©ch
.
fﬁios
[
i
]);

302 
	`fﬁio_b©ch_öô
(&
fb©ch
);

303 } 
	`iov_ôî_cou¡
(
ôî
Ë&& 
iocb
->
ki_pos
 < 
isize
 && !
îr‹
);

305 
	`fûe_ac˚s£d
(
fûp
);

306 
ø
->
¥ev_pos
 = 
œ°_pos
;

307  
Æªady_ªad
 ?áÃódy_ªad : 
îr‹
;

308 
	}
}

	@mm/filemap.h

1 #i‚de‡
__FILEMAP_H


2 
	#__FILEMAP_H


	)

4 
båfs_fûem≠_gë_∑ges
(
kiocb
 *
iocb
, 
size_t
 
cou¡
, 
fﬁio_b©ch
 *
fb©ch
, 
boﬁ
 
√ed_u±od©e
);

5 
ssize_t
 
båfs_fûem≠_ªad
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
, ssize_à
Æªady_ªad
);

	@mm/internal.h

7 #i‚de‡
__MM_INTERNAL_H


8 
	#__MM_INTERNAL_H


	)

10 
	~<löux/fs.h
>

11 
	~<löux/mm.h
>

12 
	~<löux/∑gem≠.h
>

13 
	~<löux/rm≠.h
>

14 
	~<löux/åa˚poöt-defs.h
>

16 
	gfﬁio_b©ch
;

24 
	#GFP_RECLAIM_MASK
 (
__GFP_RECLAIM
|
__GFP_HIGH
|
__GFP_IO
|
__GFP_FS
|\

25 
__GFP_NOWARN
|
__GFP_RETRY_MAYFAIL
|
__GFP_NOFAIL
|\

26 
__GFP_NORETRY
|
__GFP_MEMALLOC
|
__GFP_NOMEMALLOC
|\

27 
__GFP_NOLOCKDEP
)

	)

30 
	#GFP_BOOT_MASK
 (
__GFP_BITS_MASK
 & ~(
__GFP_RECLAIM
|
__GFP_IO
|
__GFP_FS
))

	)

33 
	#GFP_CONSTRAINT_MASK
 (
__GFP_HARDWALL
|
__GFP_THISNODE
)

	)

36 
	#GFP_SLAB_BUG_MASK
 (
__GFP_DMA32
|
__GFP_HIGHMEM
|~
__GFP_BITS_MASK
)

	)

42 
	#WARN_ON_ONCE_GFP
(
c⁄d
, 
gÂ
) ({ \

43 
boﬁ
 
	`__£˘i⁄
(".d©a.⁄˚"Ë
__w¨√d
; \

44 
__ªt_w¨n_⁄˚
 = !!(
c⁄d
); \

46 i‡(
	`u∆ikñy
(!(
gÂ
 & 
__GFP_NOWARN
Ë&& 
__ªt_w¨n_⁄˚
 && !
__w¨√d
)) { \

47 
__w¨√d
 = 
åue
; \

48 
	`WARN_ON
(1); \

50 
	`u∆ikñy
(
__ªt_w¨n_⁄˚
); \

51 })

	)

53 
∑ge_wrôeback_öô
();

61 
	#COMPOUND_MAPPED
 0x800000

	)

62 
	#FOLIO_PAGES_MAPPED
 (
COMPOUND_MAPPED
 - 1)

	)

68 
	#SHOW_MEM_FILTER_NODES
 (0x0001uË

	)

74 
ölöe
 
	$fﬁio_ƒ_∑ges_m≠≥d
(
fﬁio
 *folio)

76  
	`©omic_ªad
(&
fﬁio
->
_ƒ_∑ges_m≠≥d
Ë& 
FOLIO_PAGES_MAPPED
;

77 
	}
}

79 
ölöe
 *
	$fﬁio_øw_m≠pög
(
fﬁio
 *folio)

81 
m≠pög
 = ()
fﬁio
->mapping;

83  (*)(
m≠pög
 & ~
PAGE_MAPPING_FLAGS
);

84 
	}
}

86 
__ac˘_ª˛aim_wrôeback
(
pg_d©a_t
 *
pgd©
, 
fﬁio
 *folio,

87 
ƒ_thrŸéed
);

88 
ölöe
 
	$ac˘_ª˛aim_wrôeback
(
fﬁio
 *folio)

90 
pg_d©a_t
 *
pgd©
 = 
	`fﬁio_pgd©
(
fﬁio
);

91 
ƒ_thrŸéed
 = 
	`©omic_ªad
(&
pgd©
->
ƒ_wrôeback_thrŸéed
);

93 i‡(
ƒ_thrŸéed
)

94 
	`__ac˘_ª˛aim_wrôeback
(
pgd©
, 
fﬁio
, 
ƒ_thrŸéed
);

95 
	}
}

97 
ölöe
 
	$wake_thrŸée_isﬁ©ed
(
pg_d©a_t
 *
pgd©
)

99 
waô_queue_hód_t
 *
wqh
;

101 
wqh
 = &
pgd©
->
ª˛aim_waô
[
VMSCAN_THROTTLE_ISOLATED
];

102 i‡(
	`waôqueue_a˘ive
(
wqh
))

103 
	`wake_up
(
wqh
);

104 
	}
}

106 
vm_Áu…_t
 
do_sw≠_∑ge
(
vm_Áu…
 *
vmf
);

107 
fﬁio_rŸ©e_ª˛aimabÀ
(
fﬁio
 *folio);

108 
boﬁ
 
__fﬁio_íd_wrôeback
(
fﬁio
 *folio);

109 
dó˘iv©e_fûe_fﬁio
(
fﬁio
 *folio);

110 
fﬁio_a˘iv©e
(
fﬁio
 *folio);

112 
‰ì_pgèbÀs
(
mmu_g©hî
 *
éb
, 
ma_°©e
 *
mas
,

113 
vm_¨ó_°ru˘
 *
°¨t_vma
, 
Êo‹
,

114 
˚ûög
, 
boﬁ
 
mm_wr_locked
);

115 
pmd_ö°Æl
(
mm_°ru˘
 *
mm
, 
pmd_t
 *
pmd
, 
pgèbÀ_t
 *
±e
);

117 
	gz≠_dëaûs
;

118 
unm≠_∑ge_ønge
(
mmu_g©hî
 *
éb
,

119 
vm_¨ó_°ru˘
 *
vma
,

120 
addr
, 
íd
,

121 
z≠_dëaûs
 *
dëaûs
);

123 
∑ge_ˇche_ø_‹dî
(
ªadahód_c⁄åﬁ
 *, 
fûe_ø_°©e
 *,

124 
‹dî
);

125 
f‹˚_∑ge_ˇche_ø
(
ªadahód_c⁄åﬁ
 *, 
ƒ
);

126 
ölöe
 
	$f‹˚_∑ge_ˇche_ªadahód
(
addªss_•a˚
 *
m≠pög
,

127 
fûe
 *fûe, 
pgoff_t
 
ödex
, 
ƒ_to_ªad
)

129 
	`DEFINE_READAHEAD
(
ø˘l
, 
fûe
, &fûe->
f_ø
, 
m≠pög
, 
ödex
);

130 
	`f‹˚_∑ge_ˇche_ø
(&
ø˘l
, 
ƒ_to_ªad
);

131 
	}
}

133 
föd_lock_íåõs
(
addªss_•a˚
 *
m≠pög
, 
pgoff_t
 *
°¨t
,

134 
pgoff_t
 
íd
, 
fﬁio_b©ch
 *
fb©ch
,Ögoff_à*
ödi˚s
);

135 
föd_gë_íåõs
(
addªss_•a˚
 *
m≠pög
, 
pgoff_t
 *
°¨t
,

136 
pgoff_t
 
íd
, 
fﬁio_b©ch
 *
fb©ch
,Ögoff_à*
ödi˚s
);

137 
fûem≠_‰ì_fﬁio
(
addªss_•a˚
 *
m≠pög
, 
fﬁio
 *folio);

138 
fûem≠_gë_ªad_b©ch
(
addªss_•a˚
 *
m≠pög
, 
pgoff_t
 
ödex
,Ögoff_à
max
, 
fﬁio_b©ch
 *
fb©ch
);

139 
fûem≠_¸óã_fﬁio
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
, 
pgoff_t
 
ödex
, 
fﬁio_b©ch
 *
fb©ch
);

140 
fûem≠_upd©e_∑ge
(
kiocb
 *
iocb
, 
addªss_•a˚
 *
m≠pög
, 
size_t
 
cou¡
, 
fﬁio
 *fﬁio, 
boﬁ
 
√ed_u±od©e
);

142 
åunˇã_öode_fﬁio
(
addªss_•a˚
 *
m≠pög
, 
fﬁio
 *folio);

143 
boﬁ
 
åunˇã_öode_∑πül_fﬁio
(
fﬁio
 *fﬁio, 
loff_t
 
°¨t
,

144 
loff_t
 
íd
);

145 
övÆid©e_öode_∑ge
(
∑ge
 *page);

146 
m≠pög_åy_övÆid©e
(
addªss_•a˚
 *
m≠pög
,

147 
pgoff_t
 
°¨t
,Ögoff_à
íd
, *
ƒ_Áûed
);

160 
ölöe
 
boﬁ
 
	$fﬁio_evi˘abÀ
(
fﬁio
 *folio)

162 
boﬁ
 
ªt
;

165 
	`rcu_ªad_lock
();

166 
ªt
 = !
	`m≠pög_u√vi˘abÀ
(
	`fﬁio_m≠pög
(
fﬁio
)) &&

167 !
	`fﬁio_ã°_mlocked
(
fﬁio
);

168 
	`rcu_ªad_u∆ock
();

169  
ªt
;

170 
	}
}

176 
ölöe
 
	$£t_∑ge_ªfcou¡ed
(
∑ge
 *page)

178 
	`VM_BUG_ON_PAGE
(
	`PageTaû
(
∑ge
),Öage);

179 
	`VM_BUG_ON_PAGE
(
	`∑ge_ªf_cou¡
(
∑ge
),Öage);

180 
	`£t_∑ge_cou¡
(
∑ge
, 1);

181 
	}
}

186 
ölöe
 
boﬁ
 
	$fﬁio_√eds_ªÀa£
(
fﬁio
 *folio)

188 
addªss_•a˚
 *
m≠pög
 = 
	`fﬁio_m≠pög
(
fﬁio
);

190  
	`fﬁio_has_¥iv©e
(
fﬁio
) ||

191 (
m≠pög
 && 
	`m≠pög_ªÀa£_Æways
(mapping));

192 
	}
}

194 
highe°_memm≠_p‚
;

200 
	#MAX_RECLAIM_RETRIES
 16

	)

205 
boﬁ
 
isﬁ©e_Ãu_∑ge
(
∑ge
 *page);

206 
boﬁ
 
fﬁio_isﬁ©e_Ãu
(
fﬁio
 *folio);

207 
putback_Ãu_∑ge
(
∑ge
 *page);

208 
fﬁio_putback_Ãu
(
fﬁio
 *folio);

209 
ª˛aim_thrŸée
(
pg_d©a_t
 *
pgd©
, 
vmsˇn_thrŸée_°©e
 
ªas⁄
);

214 
pmd_t
 *
mm_föd_pmd
(
mm_°ru˘
 *
mm
, 
addªss
);

219 
	#K
(
x
Ë((xË<< (
PAGE_SHIFT
-10))

	)

221 * c⁄° 
z⁄e_«mes
[
MAX_NR_ZONES
];

224 
DECLARE_STATIC_KEY_MAYBE
(
CONFIG_DEBUG_VM
, 
check_∑ges_íabÀd
);

226 
mö_‰ì_kbyãs
;

228 
£tup_≥r_z⁄e_wm¨ks
();

229 
ˇlcuœã_mö_‰ì_kbyãs
();

230 
__memöô
 
öô_≥r_z⁄e_wm¨k_mö
();

231 
∑ge_Æloc_sys˘l_öô
();

246 
	sÆloc_c⁄ãxt
 {

247 
z⁄ñi°
 *
	mz⁄ñi°
;

248 
nodemask_t
 *
	mnodemask
;

249 
z⁄îef
 *
	m¥e„ºed_z⁄îef
;

250 
	mmigøãty≥
;

262 
z⁄e_ty≥
 
	mhighe°_z⁄eidx
;

263 
boﬁ
 
	m•ªad_dúty_∑ges
;

274 
ölöe
 
	$buddy_‹dî
(
∑ge
 *page)

277  
	`∑ge_¥iv©e
(
∑ge
);

278 
	}
}

291 
	#buddy_‹dî_unß„
(
∑ge
Ë
	`READ_ONCE
(
	`∑ge_¥iv©e
’age))

	)

306 
ölöe
 
boﬁ
 
	$∑ge_is_buddy
(
∑ge
 *∑ge, ∑gê*
buddy
,

307 
‹dî
)

309 i‡(!
	`∑ge_is_gu¨d
(
buddy
Ë&& !
	`PageBuddy
(buddy))

310  
Ál£
;

312 i‡(
	`buddy_‹dî
(
buddy
Ë!
‹dî
)

313  
Ál£
;

319 i‡(
	`∑ge_z⁄e_id
(
∑ge
Ë!∑ge_z⁄e_id(
buddy
))

320  
Ál£
;

322 
	`VM_BUG_ON_PAGE
(
	`∑ge_cou¡
(
buddy
) != 0, buddy);

324  
åue
;

325 
	}
}

344 
ölöe
 

345 
	$__föd_buddy_p‚
(
∑ge_p‚
, 
‹dî
)

347  
∑ge_p‚
 ^ (1 << 
‹dî
);

348 
	}
}

364 
ölöe
 
∑ge
 *
	$föd_buddy_∑ge_p‚
(
∑ge
 *page,

365 
p‚
, 
‹dî
, *
buddy_p‚
)

367 
__buddy_p‚
 = 
	`__föd_buddy_p‚
(
p‚
, 
‹dî
);

368 
∑ge
 *
buddy
;

370 
buddy
 = 
∑ge
 + (
__buddy_p‚
 - 
p‚
);

371 i‡(
buddy_p‚
)

372 *
buddy_p‚
 = 
__buddy_p‚
;

374 i‡(
	`∑ge_is_buddy
(
∑ge
, 
buddy
, 
‹dî
))

375  
buddy
;

376  
NULL
;

377 
	}
}

379 
∑ge
 *
__∑geblock_p‚_to_∑ge
(
°¨t_p‚
,

380 
íd_p‚
, 
z⁄e
 *zone);

382 
ölöe
 
∑ge
 *
	$∑geblock_p‚_to_∑ge
(
°¨t_p‚
,

383 
íd_p‚
, 
z⁄e
 *zone)

385 i‡(
z⁄e
->
c⁄tiguous
)

386  
	`p‚_to_∑ge
(
°¨t_p‚
);

388  
	`__∑geblock_p‚_to_∑ge
(
°¨t_p‚
, 
íd_p‚
, 
z⁄e
);

389 
	}
}

391 
£t_z⁄e_c⁄tiguous
(
z⁄e
 *zone);

393 
ölöe
 
	$˛ór_z⁄e_c⁄tiguous
(
z⁄e
 *zone)

395 
z⁄e
->
c⁄tiguous
 = 
Ál£
;

396 
	}
}

398 
__isﬁ©e_‰ì_∑ge
(
∑ge
 *∑ge, 
‹dî
);

399 
__putback_isﬁ©ed_∑ge
(
∑ge
 *∑ge, 
‹dî
,

400 
mt
);

401 
memblock_‰ì_∑ges
(
∑ge
 *∑ge, 
p‚
,

402 
‹dî
);

403 
__‰ì_∑ges_c‹e
(
∑ge
 *∑ge, 
‹dî
);

409 
ölöe
 
	$fﬁio_£t_‹dî
(
fﬁio
 *fﬁio, 
‹dî
)

411 i‡(
	`WARN_ON_ONCE
(!
‹dî
 || !
	`fﬁio_ã°_œrge
(
fﬁio
)))

414 
fﬁio
->
_Êags_1
 = (fﬁio->_Êags_1 & ~0xffULË| 
‹dî
;

415 #ifde‡
CONFIG_64BIT


416 
fﬁio
->
_fﬁio_ƒ_∑ges
 = 1U << 
‹dî
;

418 
	}
}

420 
fﬁio_undo_œrge_rm≠∑bÀ
(
fﬁio
 *folio);

422 
ölöe
 
	$¥ï_compound_hód
(
∑ge
 *∑ge, 
‹dî
)

424 
fﬁio
 *fﬁiÿ(fﬁiÿ*)
∑ge
;

426 
	`fﬁio_£t_‹dî
(
fﬁio
, 
‹dî
);

427 
	`©omic_£t
(&
fﬁio
->
_ítúe_m≠cou¡
, -1);

428 
	`©omic_£t
(&
fﬁio
->
_ƒ_∑ges_m≠≥d
, 0);

429 
	`©omic_£t
(&
fﬁio
->
_pöcou¡
, 0);

430 
	}
}

432 
ölöe
 
	$¥ï_compound_èû
(
∑ge
 *
hód
, 
èû_idx
)

434 
∑ge
 *
p
 = 
hód
 + 
èû_idx
;

436 
p
->
m≠pög
 = 
TAIL_MAPPING
;

437 
	`£t_compound_hód
(
p
, 
hód
);

438 
	`£t_∑ge_¥iv©e
(
p
, 0);

439 
	}
}

441 
¥ï_compound_∑ge
(
∑ge
 *∑ge, 
‹dî
);

443 
po°_Æloc_hook
(
∑ge
 *∑ge, 
‹dî
,

444 
gÂ_t
 
gÂ_Êags
);

445 
u£r_mö_‰ì_kbyãs
;

447 
‰ì_uƒef_∑ge
(
∑ge
 *∑ge, 
‹dî
);

448 
‰ì_uƒef_∑ge_li°
(
li°_hód
 *
li°
);

450 
z⁄e_p˝_ª£t
(
z⁄e
 *zone);

451 
z⁄e_p˝_dißbÀ
(
z⁄e
 *zone);

452 
z⁄e_p˝_íabÀ
(
z⁄e
 *zone);

453 
z⁄e_p˝_öô
(
z⁄e
 *zone);

455 *
memm≠_Æloc
(
phys_addr_t
 
size
,Öhys_addr_à
Æign
,

456 
phys_addr_t
 
mö_addr
,

457 
nid
, 
boﬁ
 
exa˘_nid
);

459 
memm≠_öô_ønge
(, , , ,

460 , 
memöô_c⁄ãxt
, 
vmem_Ætm≠
 *, );

463 
•lô_‰ì_∑ge
(
∑ge
 *
‰ì_∑ge
,

464 
‹dî
, 
•lô_p‚_off£t
);

466 #i‡
deföed
 
CONFIG_COMPACTION
 || deföed 
CONFIG_CMA


478 
	scom∑˘_c⁄åﬁ
 {

479 
li°_hód
 
	m‰ì∑ges
;

480 
li°_hód
 
	mmigøã∑ges
;

481 
	mƒ_‰ì∑ges
;

482 
	mƒ_migøã∑ges
;

483 
	m‰ì_p‚
;

490 
	mmigøã_p‚
;

491 
	mÁ°_°¨t_p‚
;

492 
z⁄e
 *
	mz⁄e
;

493 
	mtŸÆ_migøã_sˇ¬ed
;

494 
	mtŸÆ_‰ì_sˇ¬ed
;

495 
	mÁ°_£¨ch_Áû
;

496 
	m£¨ch_‹dî
;

497 c⁄° 
gÂ_t
 
	mgÂ_mask
;

498 
	m‹dî
;

499 
	mmigøãty≥
;

500 c⁄° 
	mÆloc_Êags
;

501 c⁄° 
	mhighe°_z⁄eidx
;

502 
migøã_mode
 
	mmode
;

503 
boﬁ
 
	mign‹e_skù_höt
;

504 
boﬁ
 
	mno_£t_skù_höt
;

505 
boﬁ
 
	mign‹e_block_suôabÀ
;

506 
boﬁ
 
	mdúe˘_com∑˘i⁄
;

507 
boﬁ
 
	m¥ﬂ˘ive_com∑˘i⁄
;

508 
boﬁ
 
	mwhﬁe_z⁄e
;

509 
boﬁ
 
	mc⁄ãnded
;

510 
boﬁ
 
	mföish_∑geblock
;

515 
boﬁ
 
	mÆloc_c⁄tig
;

522 
	sˇ±uª_c⁄åﬁ
 {

523 
com∑˘_c⁄åﬁ
 *
	mcc
;

524 
∑ge
 *
	m∑ge
;

528 
isﬁ©e_‰ì∑ges_ønge
(
com∑˘_c⁄åﬁ
 *
cc
,

529 
°¨t_p‚
, 
íd_p‚
);

531 
isﬁ©e_migøã∑ges_ønge
(
com∑˘_c⁄åﬁ
 *
cc
,

532 
low_p‚
, 
íd_p‚
);

534 
__Æloc_c⁄tig_migøã_ønge
(
com∑˘_c⁄åﬁ
 *
cc
,

535 
°¨t
, 
íd
);

538 
öô_cma_ª£rved_∑geblock
(
∑ge
 *page);

542 
föd_suôabÀ_ÁŒback
(
‰ì_¨ó
 *
¨ó
, 
‹dî
,

543 
migøãty≥
, 
boﬁ
 
⁄ly_°óœbÀ
, boﬁ *
ˇn_°ól
);

545 
ölöe
 
boﬁ
 
	$‰ì_¨ó_em±y
(
‰ì_¨ó
 *
¨ó
, 
migøãty≥
)

547  
	`li°_em±y
(&
¨ó
->
‰ì_li°
[
migøãty≥
]);

548 
	}
}

557 
ölöe
 
boﬁ
 
	$is_exec_m≠pög
(
vm_Êags_t
 
Êags
)

559  (
Êags
 & (
VM_EXEC
 | 
VM_WRITE
 | 
VM_STACK
)) == VM_EXEC;

560 
	}
}

568 
ölöe
 
boﬁ
 
	$is_°ack_m≠pög
(
vm_Êags_t
 
Êags
)

570  ((
Êags
 & 
VM_STACK
Ë=VM_STACKË|| (Êag†& 
VM_SHADOW_STACK
);

571 
	}
}

576 
ölöe
 
boﬁ
 
	$is_d©a_m≠pög
(
vm_Êags_t
 
Êags
)

578  (
Êags
 & (
VM_WRITE
 | 
VM_SHARED
 | 
VM_STACK
)) == VM_WRITE;

579 
	}
}

582 
™⁄_vma
 *
fﬁio_™⁄_vma
(
fﬁio
 *folio);

584 #ifde‡
CONFIG_MMU


585 
unm≠_m≠pög_fﬁio
(
fﬁio
 *folio);

586 
p›uœã_vma_∑ge_ønge
(
vm_¨ó_°ru˘
 *
vma
,

587 
°¨t
, 
íd
, *
locked
);

588 
Áu…ö_vma_∑ge_ønge
(
vm_¨ó_°ru˘
 *
vma
,

589 
°¨t
, 
íd
,

590 
boﬁ
 
wrôe
, *
locked
);

591 
boﬁ
 
mlock_futuª_ok
(
mm_°ru˘
 *
mm
, 
Êags
,

592 
byãs
);

606 
mlock_fﬁio
(
fﬁio
 *folio);

607 
ölöe
 
	$mlock_vma_fﬁio
(
fﬁio
 *folio,

608 
vm_¨ó_°ru˘
 *
vma
, 
boﬁ
 
compound
)

618 i‡(
	`u∆ikñy
((
vma
->
vm_Êags
 & (
VM_LOCKED
|
VM_SPECIAL
)) == VM_LOCKED) &&

619 (
compound
 || !
	`fﬁio_ã°_œrge
(
fﬁio
)))

620 
	`mlock_fﬁio
(
fﬁio
);

621 
	}
}

623 
mu∆ock_fﬁio
(
fﬁio
 *folio);

624 
ölöe
 
	$mu∆ock_vma_fﬁio
(
fﬁio
 *folio,

625 
vm_¨ó_°ru˘
 *
vma
, 
boﬁ
 
compound
)

627 i‡(
	`u∆ikñy
(
vma
->
vm_Êags
 & 
VM_LOCKED
) &&

628 (
compound
 || !
	`fﬁio_ã°_œrge
(
fﬁio
)))

629 
	`mu∆ock_fﬁio
(
fﬁio
);

630 
	}
}

632 
mlock_√w_fﬁio
(
fﬁio
 *folio);

633 
boﬁ
 
√ed_mlock_døö
(
˝u
);

634 
mlock_døö_loˇl
();

635 
mlock_døö_ªmŸe
(
˝u
);

637 
pmd_t
 
maybe_pmd_mkwrôe
’md_à
pmd
, 
vm_¨ó_°ru˘
 *
vma
);

643 
ölöe
 

644 
	$vma_pgoff_addªss
(
pgoff_t
 
pgoff
, 
ƒ_∑ges
,

645 
vm_¨ó_°ru˘
 *
vma
)

647 
addªss
;

649 i‡(
pgoff
 >
vma
->
vm_pgoff
) {

650 
addªss
 = 
vma
->
vm_°¨t
 +

651 ((
pgoff
 - 
vma
->
vm_pgoff
Ë<< 
PAGE_SHIFT
);

653 i‡(
addªss
 < 
vma
->
vm_°¨t
 ||áddªs†>vma->
vm_íd
)

654 
addªss
 = -
EFAULT
;

655 } i‡(
pgoff
 + 
ƒ_∑ges
 - 1 >
vma
->
vm_pgoff
) {

657 
addªss
 = 
vma
->
vm_°¨t
;

659 
addªss
 = -
EFAULT
;

661  
addªss
;

662 
	}
}

669 
ölöe
 

670 
	$vma_addªss
(
∑ge
 *∑ge, 
vm_¨ó_°ru˘
 *
vma
)

672 
	`VM_BUG_ON_PAGE
(
	`PageKsm
(
∑ge
),Öage);

673  
	`vma_pgoff_addªss
(
	`∑ge_to_pgoff
(
∑ge
), 
	`compound_ƒ
’age), 
vma
);

674 
	}
}

680 
ölöe
 
	$vma_addªss_íd
(
∑ge_vma_m≠≥d_wÆk
 *
pvmw
)

682 
vm_¨ó_°ru˘
 *
vma
 = 
pvmw
->vma;

683 
pgoff_t
 
pgoff
;

684 
addªss
;

687 i‡(
pvmw
->
ƒ_∑ges
 == 1)

688  
pvmw
->
addªss
 + 
PAGE_SIZE
;

690 
pgoff
 = 
pvmw
->pgof‡+Övmw->
ƒ_∑ges
;

691 
addªss
 = 
vma
->
vm_°¨t
 + ((
pgoff
 - vma->
vm_pgoff
Ë<< 
PAGE_SHIFT
);

693 i‡(
addªss
 < 
vma
->
vm_°¨t
 ||áddªs†> vma->
vm_íd
)

694 
addªss
 = 
vma
->
vm_íd
;

695  
addªss
;

696 
	}
}

698 
ölöe
 
fûe
 *
	$maybe_u∆ock_mm≠_f‹_io
(
vm_Áu…
 *
vmf
,

699 
fûe
 *
Âö
)

701 
Êags
 = 
vmf
->flags;

703 i‡(
Âö
)

704  
Âö
;

711 i‡(
	`Áu…_Êag_Ælow_ªåy_fú°
(
Êags
) &&

712 !(
Êags
 & 
FAULT_FLAG_RETRY_NOWAIT
)) {

713 
Âö
 = 
	`gë_fûe
(
vmf
->
vma
->
vm_fûe
);

714 
	`ªÀa£_Áu…_lock
(
vmf
);

716  
Âö
;

717 
	}
}

719 
ölöe
 
	$unm≠_m≠pög_fﬁio
(
fﬁio
 *fﬁioË{ 
	}
}

720 
ölöe
 
	$mlock_√w_fﬁio
(
fﬁio
 *fﬁioË{ 
	}
}

721 
ölöe
 
boﬁ
 
	$√ed_mlock_døö
(
˝u
Ë{  
Ál£
; 
	}
}

722 
ölöe
 
	$mlock_døö_loˇl
(Ë{ 
	}
}

723 
ölöe
 
	$mlock_døö_ªmŸe
(
˝u
Ë{ 
	}
}

724 
ölöe
 
	$vunm≠_ønge_noÊush
(
°¨t
, 
íd
)

726 
	}
}

730 #ifde‡
CONFIG_DEFERRED_STRUCT_PAGE_INIT


731 
DECLARE_STATIC_KEY_TRUE
(
de„ºed_∑ges
);

733 
boﬁ
 
__öô
 
de„ºed_grow_z⁄e
(
z⁄e
 *z⁄e, 
‹dî
);

736 
	emmöô_Àvñ
 {

737 
	mMMINIT_WARNING
,

738 
	mMMINIT_VERIFY
,

739 
	mMMINIT_TRACE


742 #ifde‡
CONFIG_DEBUG_MEMORY_INIT


744 
mmöô_logÀvñ
;

746 
	#mmöô_d¥ötk
(
Àvñ
, 
¥efix
, 
fmt
, 
¨g
...) \

748 i‡(
Àvñ
 < 
mmöô_logÀvñ
) { \

749 i‡(
Àvñ
 <
MMINIT_WARNING
) \

750 
	`¥_w¨n
("mmöô::" 
¥efix
 " " 
fmt
, ##
¨g
); \

752 
	`¥ötk
(
KERN_DEBUG
 "mmöô::" 
¥efix
 " " 
fmt
, ##
¨g
); \

754 } 0)

	)

756 
mmöô_vîify_∑geÊags_œyout
();

757 
mmöô_vîify_z⁄ñi°
();

760 
ölöe
 
	$mmöô_d¥ötk
(
mmöô_Àvñ
 
Àvñ
,

761 c⁄° *
¥efix
, c⁄° *
fmt
, ...)

763 
	}
}

765 
ölöe
 
	$mmöô_vîify_∑geÊags_œyout
()

767 
	}
}

769 
ölöe
 
	$mmöô_vîify_z⁄ñi°
()

771 
	}
}

774 
	#NODE_RECLAIM_NOSCAN
 -2

	)

775 
	#NODE_RECLAIM_FULL
 -1

	)

776 
	#NODE_RECLAIM_SOME
 0

	)

777 
	#NODE_RECLAIM_SUCCESS
 1

	)

779 #ifde‡
CONFIG_NUMA


780 
node_ª˛aim
(
pgli°_d©a
 *, 
gÂ_t
, );

781 
föd_√xt_be°_node
(
node
, 
nodemask_t
 *
u£d_node_mask
);

783 
ölöe
 
	$node_ª˛aim
(
pgli°_d©a
 *
pgd©
, 
gÂ_t
 
mask
,

784 
‹dî
)

786  
NODE_RECLAIM_NOSCAN
;

787 
	}
}

788 
ölöe
 
	$föd_√xt_be°_node
(
node
, 
nodemask_t
 *
u£d_node_mask
)

790  
NUMA_NO_NODE
;

791 
	}
}

797 
hwpois⁄_fûãr
(
∑ge
 *
p
);

799 
u32
 
hwpois⁄_fûãr_dev_maj‹
;

800 
u32
 
hwpois⁄_fûãr_dev_mö‹
;

801 
u64
 
hwpois⁄_fûãr_Êags_mask
;

802 
u64
 
hwpois⁄_fûãr_Êags_vÆue
;

803 
u64
 
hwpois⁄_fûãr_memcg
;

804 
u32
 
hwpois⁄_fûãr_íabÀ
;

806 
__mu°_check
 
vm_mm≠_pgoff
(
fûe
 *, ,

810 
£t_∑geblock_‹dî
();

811 
ª˛aim_∑ges
(
li°_hód
 *
fﬁio_li°
);

812 
ª˛aim_˛ón_∑ges_‰om_li°
(
z⁄e
 *zone,

813 
li°_hód
 *
fﬁio_li°
);

815 
	#ALLOC_WMARK_MIN
 
WMARK_MIN


	)

816 
	#ALLOC_WMARK_LOW
 
WMARK_LOW


	)

817 
	#ALLOC_WMARK_HIGH
 
WMARK_HIGH


	)

818 
	#ALLOC_NO_WATERMARKS
 0x04

	)

821 
	#ALLOC_WMARK_MASK
 (
ALLOC_NO_WATERMARKS
-1)

	)

828 #ifde‡
CONFIG_MMU


829 
	#ALLOC_OOM
 0x08

	)

831 
	#ALLOC_OOM
 
ALLOC_NO_WATERMARKS


	)

834 
	#ALLOC_NON_BLOCK
 0x10

	)

838 
	#ALLOC_MIN_RESERVE
 0x20

	)

841 
	#ALLOC_CPUSET
 0x40

	)

842 
	#ALLOC_CMA
 0x80

	)

843 #ifde‡
CONFIG_ZONE_DMA32


844 
	#ALLOC_NOFRAGMENT
 0x100

	)

846 
	#ALLOC_NOFRAGMENT
 0x0

	)

848 
	#ALLOC_HIGHATOMIC
 0x200

	)

849 
	#ALLOC_KSWAPD
 0x800

	)

852 
	#ALLOC_RESERVES
 (
ALLOC_NON_BLOCK
|
ALLOC_MIN_RESERVE
|
ALLOC_HIGHATOMIC
|
ALLOC_OOM
)

	)

854 
	gâu_Êags
;

855 
	gébÊush_unm≠_b©ch
;

862 
w‹kqueue_°ru˘
 *
mm_≥r˝u_wq
;

864 #ifde‡
CONFIG_ARCH_WANT_BATCHED_UNMAP_TLB_FLUSH


865 
åy_to_unm≠_Êush
();

866 
åy_to_unm≠_Êush_dúty
();

867 
Êush_éb_b©ched_≥ndög
(
mm_°ru˘
 *
mm
);

869 
ölöe
 
	$åy_to_unm≠_Êush
()

871 
	}
}

872 
ölöe
 
	$åy_to_unm≠_Êush_dúty
()

874 
	}
}

875 
ölöe
 
	$Êush_éb_b©ched_≥ndög
(
mm_°ru˘
 *
mm
)

877 
	}
}

880 c⁄° 
åa˚_¥öt_Êags
 
∑geÊag_«mes
[];

881 c⁄° 
åa˚_¥öt_Êags
 
∑gëy≥_«mes
[];

882 c⁄° 
åa˚_¥öt_Êags
 
vmaÊag_«mes
[];

883 c⁄° 
åa˚_¥öt_Êags
 
gÂÊag_«mes
[];

885 
ölöe
 
boﬁ
 
	$is_migøã_high©omic
(
migøãty≥
 migratetype)

887  
migøãty≥
 =
MIGRATE_HIGHATOMIC
;

888 
	}
}

890 
ölöe
 
boﬁ
 
	$is_migøã_high©omic_∑ge
(
∑ge
 *page)

892  
	`gë_∑geblock_migøãty≥
(
∑ge
Ë=
MIGRATE_HIGHATOMIC
;

893 
	}
}

895 
£tup_z⁄e_∑ge£t
(
z⁄e
 *zone);

897 
	smigøti⁄_èrgë_c⁄åﬁ
 {

898 
	mnid
;

899 
nodemask_t
 *
	mnmask
;

900 
gÂ_t
 
	mgÂ_mask
;

906 
size_t
 
•li˚_fﬁio_öto_pùe
(
pùe_öode_öfo
 *
pùe
,

907 
fﬁio
 *fﬁio, 
loff_t
 
Âos
, 
size_t
 
size
);

912 #ifde‡
CONFIG_MMU


913 
__öô
 
vmÆloc_öô
();

914 
__mu°_check
 
vm≠_∑ges_ønge_noÊush
(
addr
, 
íd
,

915 
pg¥Ÿ_t
 
¥Ÿ
, 
∑ge
 **
∑ges
, 
∑ge_shi·
);

917 
ölöe
 
	$vmÆloc_öô
()

919 
	}
}

921 
ölöe


922 
__mu°_check
 
	$vm≠_∑ges_ønge_noÊush
(
addr
, 
íd
,

923 
pg¥Ÿ_t
 
¥Ÿ
, 
∑ge
 **
∑ges
, 
∑ge_shi·
)

925  -
EINVAL
;

926 
	}
}

929 
__mu°_check
 
__vm≠_∑ges_ønge_noÊush
(
addr
,

930 
íd
, 
pg¥Ÿ_t
 
¥Ÿ
,

931 
∑ge
 **
∑ges
, 
∑ge_shi·
);

933 
vunm≠_ønge_noÊush
(
°¨t
, 
íd
);

935 
__vunm≠_ønge_noÊush
(
°¨t
, 
íd
);

937 
numa_migøã_¥ï
(
∑ge
 *∑ge, 
vm_¨ó_°ru˘
 *
vma
,

938 
addr
, 
∑ge_nid
, *
Êags
);

940 
‰ì_z⁄e_devi˚_∑ge
(
∑ge
 *page);

941 
migøã_devi˚_cohîít_∑ge
(
∑ge
 *page);

946 
fﬁio
 *
åy_gøb_fﬁio
(
∑ge
 *∑ge, 
ªfs
, 
Êags
);

947 
__mu°_check
 
åy_gøb_∑ge
(
∑ge
 *∑ge, 
Êags
);

952 
∑ge
 *
fﬁlow_å™s_huge_pmd
(
vm_¨ó_°ru˘
 *
vma
,

953 
addr
, 
pmd_t
 *
pmd
,

954 
Êags
);

958 
	mFOLL_TOUCH
 = 1 << 16,

960 
	mFOLL_TRIED
 = 1 << 17,

962 
	mFOLL_REMOTE
 = 1 << 18,

964 
	mFOLL_PIN
 = 1 << 19,

966 
	mFOLL_FAST_ONLY
 = 1 << 20,

968 
	mFOLL_UNLOCKABLE
 = 1 << 21,

991 
ölöe
 
boﬁ
 
	$gup_mu°_unsh¨e
(
vm_¨ó_°ru˘
 *
vma
,

992 
Êags
, 
∑ge
 *page)

999 i‡((
Êags
 & (
FOLL_WRITE
 | 
FOLL_PIN
)) != FOLL_PIN)

1000  
Ál£
;

1005 i‡(!
	`PageAn⁄
(
∑ge
)) {

1011 i‡(!(
Êags
 & 
FOLL_LONGTERM
))

1012  
Ál£
;

1015 i‡(!
vma
)

1016  
åue
;

1022  
	`is_cow_m≠pög
(
vma
->
vm_Êags
);

1026 i‡(
	`IS_ENABLED
(
CONFIG_HAVE_FAST_GUP
))

1027 
	`smp_rmb
();

1036 i‡(
	`u∆ikñy
(!
	`PageHód
(
∑ge
Ë&& 
	`PageHuge
(page)))

1037 
∑ge
 = 
	`compound_hód
(page);

1043  !
	`PageAn⁄Ex˛usive
(
∑ge
);

1044 
	}
}

1046 
boﬁ
 
múr‹ed_kî√lc‹e
;

1047 
boﬁ
 
memblock_has_múr‹
();

1049 
ölöe
 
boﬁ
 
	$vma_so·_dúty_íabÀd
(
vm_¨ó_°ru˘
 *
vma
)

1057 i‡(!
	`IS_ENABLED
(
CONFIG_MEM_SOFT_DIRTY
))

1058  
Ál£
;

1064  !(
vma
->
vm_Êags
 & 
VM_SOFTDIRTY
);

1065 
	}
}

1067 
ölöe
 
	$vma_ôî_c⁄fig
(
vma_ôî©‹
 *
vmi
,

1068 
ödex
, 
œ°
)

1070 
	`MAS_BUG_ON
(&
vmi
->
mas
, vmi->mas.
node
 !
MAS_START
 &&

1071 (
vmi
->
mas
.
ödex
 > index || vmi->mas.
œ°
 < index));

1072 
	`__mas_£t_ønge
(&
vmi
->
mas
, 
ödex
, 
œ°
 - 1);

1073 
	}
}

1078 
ölöe
 
	$vma_ôî_¥óŒoc
(
vma_ôî©‹
 *
vmi
,

1079 
vm_¨ó_°ru˘
 *
vma
)

1081  
	`mas_¥óŒoˇã
(&
vmi
->
mas
, 
vma
, 
GFP_KERNEL
);

1082 
	}
}

1084 
ölöe
 
	$vma_ôî_˛ór
(
vma_ôî©‹
 *
vmi
)

1086 
	`mas_°‹e_¥óŒoc
(&
vmi
->
mas
, 
NULL
);

1087 
	}
}

1089 
ölöe
 
	$vma_ôî_˛ór_gÂ
(
vma_ôî©‹
 *
vmi
,

1090 
°¨t
, 
íd
, 
gÂ_t
 
gÂ
)

1092 
	`__mas_£t_ønge
(&
vmi
->
mas
, 
°¨t
, 
íd
 - 1);

1093 
	`mas_°‹e_gÂ
(&
vmi
->
mas
, 
NULL
, 
gÂ
);

1094 i‡(
	`u∆ikñy
(
	`mas_is_îr
(&
vmi
->
mas
)))

1095  -
ENOMEM
;

1098 
	}
}

1100 
ölöe
 
vm_¨ó_°ru˘
 *
	$vma_ôî_lﬂd
(
vma_ôî©‹
 *
vmi
)

1102  
	`mas_wÆk
(&
vmi
->
mas
);

1103 
	}
}

1106 
ölöe
 
	$vma_ôî_°‹e
(
vma_ôî©‹
 *
vmi
,

1107 
vm_¨ó_°ru˘
 *
vma
)

1110 #i‡
	`deföed
(
CONFIG_DEBUG_VM_MAPLE_TREE
)

1111 i‡(
	`MAS_WARN_ON
(&
vmi
->
mas
, vmi->mas.
node
 !
MAS_START
 &&

1112 
vmi
->
mas
.
ödex
 > 
vma
->
vm_°¨t
)) {

1113 
	`¥_w¨n
("%lx > %lx\n store vma %lx-%lx\n into slot %lx-%lx\n",

1114 
vmi
->
mas
.
ödex
, 
vma
->
vm_°¨t
, vma->vm_start,

1115 
vma
->
vm_íd
, 
vmi
->
mas
.
ödex
, vmi->mas.
œ°
);

1117 i‡(
	`MAS_WARN_ON
(&
vmi
->
mas
, vmi->mas.
node
 !
MAS_START
 &&

1118 
vmi
->
mas
.
œ°
 < 
vma
->
vm_°¨t
)) {

1119 
	`¥_w¨n
("%lx < %lx\nstore vma %lx-%lx\ninto slot %lx-%lx\n",

1120 
vmi
->
mas
.
œ°
, 
vma
->
vm_°¨t
, vma->vm_°¨t, vma->
vm_íd
,

1121 
vmi
->
mas
.
ödex
, vmi->mas.
œ°
);

1125 i‡(
vmi
->
mas
.
node
 !
MAS_START
 &&

1126 ((
vmi
->
mas
.
ödex
 > 
vma
->
vm_°¨t
Ë|| (vmi->mas.
œ°
 < vma->vm_start)))

1127 
	`vma_ôî_övÆid©e
(
vmi
);

1129 
	`__mas_£t_ønge
(&
vmi
->
mas
, 
vma
->
vm_°¨t
, vma->
vm_íd
 - 1);

1130 
	`mas_°‹e_¥óŒoc
(&
vmi
->
mas
, 
vma
);

1131 
	}
}

1133 
ölöe
 
	$vma_ôî_°‹e_gÂ
(
vma_ôî©‹
 *
vmi
,

1134 
vm_¨ó_°ru˘
 *
vma
, 
gÂ_t
 
gÂ
)

1136 i‡(
vmi
->
mas
.
node
 !
MAS_START
 &&

1137 ((
vmi
->
mas
.
ödex
 > 
vma
->
vm_°¨t
Ë|| (vmi->mas.
œ°
 < vma->vm_start)))

1138 
	`vma_ôî_övÆid©e
(
vmi
);

1140 
	`__mas_£t_ønge
(&
vmi
->
mas
, 
vma
->
vm_°¨t
, vma->
vm_íd
 - 1);

1141 
	`mas_°‹e_gÂ
(&
vmi
->
mas
, 
vma
, 
gÂ
);

1142 i‡(
	`u∆ikñy
(
	`mas_is_îr
(&
vmi
->
mas
)))

1143  -
ENOMEM
;

1146 
	}
}

1151 
	svma_¥ï¨e
 {

1152 
vm_¨ó_°ru˘
 *
	mvma
;

1153 
vm_¨ó_°ru˘
 *
	madj_√xt
;

1154 
fûe
 *
	mfûe
;

1155 
addªss_•a˚
 *
	mm≠pög
;

1156 
™⁄_vma
 *
	m™⁄_vma
;

1157 
vm_¨ó_°ru˘
 *
	mö£π
;

1158 
vm_¨ó_°ru˘
 *
	mªmove
;

1159 
vm_¨ó_°ru˘
 *
	mªmove2
;

	@ordered-data.c

6 
	~<löux/¶ab.h
>

7 
	~<löux/blkdev.h
>

8 
	~<löux/wrôeback.h
>

9 
	~<löux/sched/mm.h
>

10 
	~"mesßges.h
"

11 
	~"misc.h
"

12 
	~"˘ªe.h
"

13 
	~"å™ß˘i⁄.h
"

14 
	~"båfs_öode.h
"

15 
	~"exã¡_io.h
"

16 
	~"disk-io.h
"

17 
	~"com¥essi⁄.h
"

18 
	~"dñÆloc-•a˚.h
"

19 
	~"qgroup.h
"

20 
	~"sub∑ge.h
"

21 
	~"fûe.h
"

22 
	~"su≥r.h
"

24 
kmem_ˇche
 *
	gbåfs_‹dîed_exã¡_ˇche
;

26 
u64
 
	$íåy_íd
(
båfs_‹dîed_exã¡
 *
íåy
)

28 i‡(
íåy
->
fûe_off£t
 +É¡ry->
num_byãs
 <Éntry->file_offset)

29  (
u64
)-1;

30  
íåy
->
fûe_off£t
 +É¡ry->
num_byãs
;

31 
	}
}

36 
rb_node
 *
	$åì_ö£π
(
rb_roŸ
 *
roŸ
, 
u64
 
fûe_off£t
,

37 
rb_node
 *
node
)

39 
rb_node
 **
p
 = &
roŸ
->rb_node;

40 
rb_node
 *
∑ª¡
 = 
NULL
;

41 
båfs_‹dîed_exã¡
 *
íåy
;

43 *
p
) {

44 
∑ª¡
 = *
p
;

45 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
båfs_‹dîed_exã¡
, 
rb_node
);

47 i‡(
fûe_off£t
 < 
íåy
->file_offset)

48 
p
 = &(*p)->
rb_À·
;

49 i‡(
fûe_off£t
 >
	`íåy_íd
(
íåy
))

50 
p
 = &(*p)->
rb_right
;

52  
∑ª¡
;

55 
	`rb_lök_node
(
node
, 
∑ª¡
, 
p
);

56 
	`rb_ö£π_cﬁ‹
(
node
, 
roŸ
);

57  
NULL
;

58 
	}
}

64 
rb_node
 *
	$__åì_£¨ch
(
rb_roŸ
 *
roŸ
, 
u64
 
fûe_off£t
,

65 
rb_node
 **
¥ev_ªt
)

67 
rb_node
 *
n
 = 
roŸ
->rb_node;

68 
rb_node
 *
¥ev
 = 
NULL
;

69 
rb_node
 *
ã°
;

70 
båfs_‹dîed_exã¡
 *
íåy
;

71 
båfs_‹dîed_exã¡
 *
¥ev_íåy
 = 
NULL
;

73 
n
) {

74 
íåy
 = 
	`rb_íåy
(
n
, 
båfs_‹dîed_exã¡
, 
rb_node
);

75 
¥ev
 = 
n
;

76 
¥ev_íåy
 = 
íåy
;

78 i‡(
fûe_off£t
 < 
íåy
->file_offset)

79 
n
 =Ç->
rb_À·
;

80 i‡(
fûe_off£t
 >
	`íåy_íd
(
íåy
))

81 
n
 =Ç->
rb_right
;

83  
n
;

85 i‡(!
¥ev_ªt
)

86  
NULL
;

88 
¥ev
 && 
fûe_off£t
 >
	`íåy_íd
(
¥ev_íåy
)) {

89 
ã°
 = 
	`rb_√xt
(
¥ev
);

90 i‡(!
ã°
)

92 
¥ev_íåy
 = 
	`rb_íåy
(
ã°
, 
båfs_‹dîed_exã¡
,

93 
rb_node
);

94 i‡(
fûe_off£t
 < 
	`íåy_íd
(
¥ev_íåy
))

97 
¥ev
 = 
ã°
;

99 i‡(
¥ev
)

100 
¥ev_íåy
 = 
	`rb_íåy
(
¥ev
, 
båfs_‹dîed_exã¡
,

101 
rb_node
);

102 
¥ev
 && 
fûe_off£t
 < 
	`íåy_íd
(
¥ev_íåy
)) {

103 
ã°
 = 
	`rb_¥ev
(
¥ev
);

104 i‡(!
ã°
)

106 
¥ev_íåy
 = 
	`rb_íåy
(
ã°
, 
båfs_‹dîed_exã¡
,

107 
rb_node
);

108 
¥ev
 = 
ã°
;

110 *
¥ev_ªt
 = 
¥ev
;

111  
NULL
;

112 
	}
}

114 
	$ønge_ovîœps
(
båfs_‹dîed_exã¡
 *
íåy
, 
u64
 
fûe_off£t
,

115 
u64
 
Àn
)

117 i‡(
fûe_off£t
 + 
Àn
 <
íåy
->file_offset ||

118 
íåy
->
fûe_off£t
 +É¡ry->
num_byãs
 <= file_offset)

121 
	}
}

127 
ölöe
 
rb_node
 *
	$åì_£¨ch
(
båfs_‹dîed_öode_åì
 *
åì
,

128 
u64
 
fûe_off£t
)

130 
rb_roŸ
 *
roŸ
 = &
åì
->tree;

131 
rb_node
 *
¥ev
 = 
NULL
;

132 
rb_node
 *
ªt
;

133 
båfs_‹dîed_exã¡
 *
íåy
;

135 i‡(
åì
->
œ°
) {

136 
íåy
 = 
	`rb_íåy
(
åì
->
œ°
, 
båfs_‹dîed_exã¡
,

137 
rb_node
);

138 i‡(
	`ö_ønge
(
fûe_off£t
, 
íåy
->fûe_off£t,É¡ry->
num_byãs
))

139  
åì
->
œ°
;

141 
ªt
 = 
	`__åì_£¨ch
(
roŸ
, 
fûe_off£t
, &
¥ev
);

142 i‡(!
ªt
)

143 
ªt
 = 
¥ev
;

144 i‡(
ªt
)

145 
åì
->
œ°
 = 
ªt
;

146  
ªt
;

147 
	}
}

149 
båfs_‹dîed_exã¡
 *
	$Æloc_‹dîed_exã¡
(

150 
båfs_öode
 *
böode
, 
u64
 
fûe_off£t
, u64 
num_byãs
,

151 
u64
 
øm_byãs
, u64 
disk_byãƒ
, u64 
disk_num_byãs
,

152 
u64
 
off£t
, 
Êags
, 
com¥ess_ty≥
)

154 
båfs_‹dîed_exã¡
 *
íåy
;

155 
ªt
;

156 
u64
 
qgroup_rsv
 = 0;

158 i‡(
Êags
 &

159 ((1 << 
BTRFS_ORDERED_NOCOW
Ë| (1 << 
BTRFS_ORDERED_PREALLOC
))) {

161 
ªt
 = 
	`båfs_qgroup_‰ì_d©a
(
böode
, 
NULL
, 
fûe_off£t
, 
num_byãs
, &
qgroup_rsv
);

162 i‡(
ªt
 < 0)

163  
	`ERR_PTR
(
ªt
);

169 
ªt
 = 
	`båfs_qgroup_ªÀa£_d©a
(
böode
, 
fûe_off£t
, 
num_byãs
, &
qgroup_rsv
);

170 i‡(
ªt
 < 0)

171  
	`ERR_PTR
(
ªt
);

173 
íåy
 = 
	`kmem_ˇche_zÆloc
(
båfs_‹dîed_exã¡_ˇche
, 
GFP_NOFS
);

174 i‡(!
íåy
)

175  
	`ERR_PTR
(-
ENOMEM
);

177 
öode
 *
VFSöode
 = &
böode
->
vfs_öode
;

178 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
VFSöode
->
i_sb
);

179 
båfs_su≥r_block
 *
sb
 = 
fs_öfo
->
su≥r_c›y
;

180 
u64
 
tŸÆ_byãs
 = 
sb
->total_bytes;

181 
u64
 
nodesize
 = 
sb
->nodesize;

184 
íåy
->
fûe_off£t
 = file_offset;

185 
íåy
->
num_byãs
 =Çum_bytes;

186 
íåy
->
øm_byãs
 =Ñam_bytes;

187 
íåy
->
disk_byãƒ
 = disk_bytenr;

188 
íåy
->
disk_num_byãs
 = disk_num_bytes;

189 
íåy
->
off£t
 = offset;

190 
íåy
->
byãs_À·
 = 
num_byãs
;

191 
íåy
->
öode
 = 
	`igøb
(&
böode
->
vfs_öode
);

192 
íåy
->
com¥ess_ty≥
 = compress_type;

193 
íåy
->
åunˇãd_Àn
 = (
u64
)-1;

194 
íåy
->
qgroup_rsv
 = qgroup_rsv;

195 
íåy
->
Êags
 = flags;

196 
	`ªfcou¡_£t
(&
íåy
->
ªfs
, 1);

197 
	`öô_waôqueue_hód
(&
íåy
->
waô
);

198 
	`INIT_LIST_HEAD
(&
íåy
->
li°
);

199 
	`INIT_LIST_HEAD
(&
íåy
->
log_li°
);

200 
	`INIT_LIST_HEAD
(&
íåy
->
roŸ_exã¡_li°
);

201 
	`INIT_LIST_HEAD
(&
íåy
->
w‹k_li°
);

202 
	`öô_com∂ëi⁄
(&
íåy
->
com∂ëi⁄
);

209 
	`•ö_lock
(&
böode
->
lock
);

210 
	`båfs_mod_out°™dög_exã¡s
(
böode
, 1);

211 
	`•ö_u∆ock
(&
böode
->
lock
);

213  
íåy
;

214 
	}
}

216 
	$ö£π_‹dîed_exã¡
(
båfs_‹dîed_exã¡
 *
íåy
)

218 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
íåy
->inode);

219 
båfs_‹dîed_öode_åì
 *
åì
 = &
öode
->
‹dîed_åì
;

220 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

221 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

222 
rb_node
 *
node
;

224 
	`åa˚_båfs_‹dîed_exã¡_add
(
öode
, 
íåy
);

226 
	`≥r˝u_cou¡î_add_b©ch
(&
fs_öfo
->
‹dîed_byãs
, 
íåy
->
num_byãs
,

227 
fs_öfo
->
dñÆloc_b©ch
);

230 
	`ªfcou¡_öc
(&
íåy
->
ªfs
);

232 
	`•ö_lock_úq
(&
åì
->
lock
);

233 
node
 = 
	`åì_ö£π
(&
åì
->åì, 
íåy
->
fûe_off£t
, &íåy->
rb_node
);

234 i‡(
node
)

235 
	`båfs_∑nic
(
fs_öfo
, -
EEXIST
,

237 
íåy
->
fûe_off£t
);

238 
	`•ö_u∆ock_úq
(&
åì
->
lock
);

240 
	`•ö_lock
(&
roŸ
->
‹dîed_exã¡_lock
);

241 
	`li°_add_èû
(&
íåy
->
roŸ_exã¡_li°
,

242 &
roŸ
->
‹dîed_exã¡s
);

243 
roŸ
->
ƒ_‹dîed_exã¡s
++;

244 i‡(
roŸ
->
ƒ_‹dîed_exã¡s
 == 1) {

245 
	`•ö_lock
(&
fs_öfo
->
‹dîed_roŸ_lock
);

246 
	`BUG_ON
(!
	`li°_em±y
(&
roŸ
->
‹dîed_roŸ
));

247 
	`li°_add_èû
(&
roŸ
->
‹dîed_roŸ
, &
fs_öfo
->
‹dîed_roŸs
);

248 
	`•ö_u∆ock
(&
fs_öfo
->
‹dîed_roŸ_lock
);

250 
	`•ö_u∆ock
(&
roŸ
->
‹dîed_exã¡_lock
);

251 
	}
}

272 
båfs_‹dîed_exã¡
 *
	$båfs_Æloc_‹dîed_exã¡
(

273 
båfs_öode
 *
öode
, 
u64
 
fûe_off£t
,

274 
u64
 
num_byãs
, u64 
øm_byãs
, u64 
disk_byãƒ
,

275 
u64
 
disk_num_byãs
, u64 
off£t
, 
Êags
,

276 
com¥ess_ty≥
)

278 
båfs_‹dîed_exã¡
 *
íåy
;

280 
	`ASSERT
((
Êags
 & ~
BTRFS_ORDERED_TYPE_FLAGS
) == 0);

282 
íåy
 = 
	`Æloc_‹dîed_exã¡
(
öode
, 
fûe_off£t
, 
num_byãs
, 
øm_byãs
,

283 
disk_byãƒ
, 
disk_num_byãs
, 
off£t
, 
Êags
,

284 
com¥ess_ty≥
);

285 i‡(!
	`IS_ERR
(
íåy
))

286 
	`ö£π_‹dîed_exã¡
(
íåy
);

287  
íåy
;

288 
	}
}

295 
	$båfs_add_‹dîed_sum
(
båfs_‹dîed_exã¡
 *
íåy
,

296 
båfs_‹dîed_sum
 *
sum
)

298 
båfs_‹dîed_öode_åì
 *
åì
;

300 
åì
 = &
	`BTRFS_I
(
íåy
->
öode
)->
‹dîed_åì
;

301 
	`•ö_lock_úq
(&
åì
->
lock
);

302 
	`li°_add_èû
(&
sum
->
li°
, &
íåy
->list);

303 
	`•ö_u∆ock_úq
(&
åì
->
lock
);

304 
	}
}

306 
	$föish_‹dîed_‚
(
båfs_w‹k
 *
w‹k
)

308 
båfs_‹dîed_exã¡
 *
‹dîed_exã¡
;

310 
‹dîed_exã¡
 = 
	`c⁄èöî_of
(
w‹k
, 
båfs_‹dîed_exã¡
, work);

311 
	`båfs_föish_‹dîed_io
(
‹dîed_exã¡
);

312 
	}
}

314 
boﬁ
 
	$ˇn_föish_‹dîed_exã¡
(
båfs_‹dîed_exã¡
 *
‹dîed
,

315 
∑ge
 *∑ge, 
u64
 
fûe_off£t
,

316 
u64
 
Àn
, 
boﬁ
 
u±od©e
)

318 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
‹dîed
->inode);

319 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

321 
	`lockdï_as£π_hñd
(&
öode
->
‹dîed_åì
.
lock
);

323 i‡(
∑ge
) {

324 
	`ASSERT
(
∑ge
->
m≠pög
);

325 
	`ASSERT
(
	`∑ge_off£t
(
∑ge
Ë<
fûe_off£t
);

326 
	`ASSERT
(
fûe_off£t
 + 
Àn
 <
	`∑ge_off£t
(
∑ge
Ë+ 
PAGE_SIZE
);

334 i‡(!
	`båfs_∑ge_ã°_‹dîed
(
fs_öfo
, 
∑ge
, 
fûe_off£t
, 
Àn
))

335  
Ál£
;

336 
	`båfs_∑ge_˛ór_‹dîed
(
fs_öfo
, 
∑ge
, 
fûe_off£t
, 
Àn
);

340 i‡(
	`WARN_ON_ONCE
(
Àn
 > 
‹dîed
->
byãs_À·
)) {

341 
	`båfs_¸ô
(
fs_öfo
,

343 
öode
->
roŸ
->
roŸ_key
.
obje˘id
, 
	`båfs_öo
(inode),

344 
‹dîed
->
fûe_off£t
, ordîed->
num_byãs
,

345 
Àn
, 
‹dîed
->
byãs_À·
);

346 
‹dîed
->
byãs_À·
 = 0;

348 
‹dîed
->
byãs_À·
 -
Àn
;

351 i‡(!
u±od©e
)

352 
	`£t_bô
(
BTRFS_ORDERED_IOERR
, &
‹dîed
->
Êags
);

354 i‡(
‹dîed
->
byãs_À·
)

355  
Ál£
;

361 
	`£t_bô
(
BTRFS_ORDERED_IO_DONE
, &
‹dîed
->
Êags
);

362 
	`c⁄d_wake_up
(&
‹dîed
->
waô
);

363 
	`ªfcou¡_öc
(&
‹dîed
->
ªfs
);

364 
	`åa˚_båfs_‹dîed_exã¡_m¨k_föished
(
öode
, 
‹dîed
);

365  
åue
;

366 
	}
}

368 
	$båfs_queue_‹dîed_‚
(
båfs_‹dîed_exã¡
 *
‹dîed
)

370 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
‹dîed
->inode);

371 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

372 
båfs_w‹kqueue
 *
wq
 = 
	`båfs_is_‰ì_•a˚_öode
(
öode
) ?

373 
fs_öfo
->
ídio_‰ì•a˚_w‹kî
 : fs_öfo->
ídio_wrôe_w‹kîs
;

375 
	`båfs_öô_w‹k
(&
‹dîed
->
w‹k
, 
föish_‹dîed_‚
, 
NULL
, NULL);

376 
	`båfs_queue_w‹k
(
wq
, &
‹dîed
->
w‹k
);

377 
	}
}

379 
boﬁ
 
	$båfs_föish_‹dîed_exã¡
(
båfs_‹dîed_exã¡
 *
‹dîed
,

380 
∑ge
 *∑ge, 
u64
 
fûe_off£t
, u64 
Àn
,

381 
boﬁ
 
u±od©e
)

383 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
‹dîed
->inode);

384 
Êags
;

385 
boﬁ
 
ªt
;

387 
	`åa˚_båfs_föish_‹dîed_exã¡
(
öode
, 
fûe_off£t
, 
Àn
, 
u±od©e
);

389 
	`•ö_lock_úqßve
(&
öode
->
‹dîed_åì
.
lock
, 
Êags
);

390 
ªt
 = 
	`ˇn_föish_‹dîed_exã¡
(
‹dîed
, 
∑ge
, 
fûe_off£t
, 
Àn
, 
u±od©e
);

391 
	`•ö_u∆ock_úqª°‹e
(&
öode
->
‹dîed_åì
.
lock
, 
Êags
);

393 i‡(
ªt
)

394 
	`båfs_queue_‹dîed_‚
(
‹dîed
);

395  
ªt
;

396 
	}
}

411 
	$båfs_m¨k_‹dîed_io_föished
(
båfs_öode
 *
öode
,

412 
∑ge
 *∑ge, 
u64
 
fûe_off£t
,

413 
u64
 
num_byãs
, 
boﬁ
 
u±od©e
)

415 
båfs_‹dîed_öode_åì
 *
åì
 = &
öode
->
‹dîed_åì
;

416 
rb_node
 *
node
;

417 
båfs_‹dîed_exã¡
 *
íåy
 = 
NULL
;

418 
Êags
;

419 
u64
 
cur
 = 
fûe_off£t
;

421 
	`åa˚_båfs_wrôïage_íd_io_hook
(
öode
, 
fûe_off£t
,

422 
fûe_off£t
 + 
num_byãs
 - 1,

423 
u±od©e
);

425 
	`•ö_lock_úqßve
(&
åì
->
lock
, 
Êags
);

426 
cur
 < 
fûe_off£t
 + 
num_byãs
) {

427 
u64
 
íåy_íd
;

428 
u64
 
íd
;

429 
u32
 
Àn
;

431 
node
 = 
	`åì_£¨ch
(
åì
, 
cur
);

433 i‡(!
node
)

436 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‹dîed_exã¡
, 
rb_node
);

437 
íåy_íd
 = 
íåy
->
fûe_off£t
 +É¡ry->
num_byãs
;

443 i‡(
cur
 >
íåy_íd
) {

444 
node
 = 
	`rb_√xt
(node);

446 i‡(!
node
)

448 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‹dîed_exã¡
,

449 
rb_node
);

452 
cur
 = 
íåy
->
fûe_off£t
;

460 i‡(
cur
 < 
íåy
->
fûe_off£t
) {

461 
cur
 = 
íåy
->
fûe_off£t
;

472 
íd
 = 
	`mö
(
íåy
->
fûe_off£t
 +É¡ry->
num_byãs
,

473 
fûe_off£t
 + 
num_byãs
) - 1;

474 
	`ASSERT
(
íd
 + 1 - 
cur
 < 
U32_MAX
);

475 
Àn
 = 
íd
 + 1 - 
cur
;

477 i‡(
	`ˇn_föish_‹dîed_exã¡
(
íåy
, 
∑ge
, 
cur
, 
Àn
, 
u±od©e
)) {

478 
	`•ö_u∆ock_úqª°‹e
(&
åì
->
lock
, 
Êags
);

479 
	`båfs_queue_‹dîed_‚
(
íåy
);

480 
	`•ö_lock_úqßve
(&
åì
->
lock
, 
Êags
);

482 
cur
 +
Àn
;

484 
	`•ö_u∆ock_úqª°‹e
(&
åì
->
lock
, 
Êags
);

485 
	}
}

504 
boﬁ
 
	$båfs_dec_ã°_‹dîed_≥ndög
(
båfs_öode
 *
öode
,

505 
båfs_‹dîed_exã¡
 **
ˇched
,

506 
u64
 
fûe_off£t
, u64 
io_size
)

508 
båfs_‹dîed_öode_åì
 *
åì
 = &
öode
->
‹dîed_åì
;

509 
rb_node
 *
node
;

510 
båfs_‹dîed_exã¡
 *
íåy
 = 
NULL
;

511 
Êags
;

512 
boﬁ
 
föished
 = 
Ál£
;

514 
	`•ö_lock_úqßve
(&
åì
->
lock
, 
Êags
);

515 i‡(
ˇched
 && *cached) {

516 
íåy
 = *
ˇched
;

517 
have_íåy
;

520 
node
 = 
	`åì_£¨ch
(
åì
, 
fûe_off£t
);

521 i‡(!
node
)

522 
out
;

524 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‹dîed_exã¡
, 
rb_node
);

525 
have_íåy
:

526 i‡(!
	`ö_ønge
(
fûe_off£t
, 
íåy
->fûe_off£t,É¡ry->
num_byãs
))

527 
out
;

529 i‡(
io_size
 > 
íåy
->
byãs_À·
)

530 
	`båfs_¸ô
(
öode
->
roŸ
->
fs_öfo
,

532 
íåy
->
byãs_À·
, 
io_size
);

534 
íåy
->
byãs_À·
 -
io_size
;

536 i‡(
íåy
->
byãs_À·
 == 0) {

541 
föished
 = !
	`ã°_™d_£t_bô
(
BTRFS_ORDERED_IO_DONE
, &
íåy
->
Êags
);

543 
	`c⁄d_wake_up_nomb
(&
íåy
->
waô
);

545 
out
:

546 i‡(
föished
 && 
ˇched
 && 
íåy
) {

547 *
ˇched
 = 
íåy
;

548 
	`ªfcou¡_öc
(&
íåy
->
ªfs
);

549 
	`åa˚_båfs_‹dîed_exã¡_dec_ã°_≥ndög
(
öode
, 
íåy
);

551 
	`•ö_u∆ock_úqª°‹e
(&
åì
->
lock
, 
Êags
);

552  
föished
;

553 
	}
}

559 
	$båfs_put_‹dîed_exã¡
(
båfs_‹dîed_exã¡
 *
íåy
)

561 
li°_hód
 *
cur
;

562 
båfs_‹dîed_sum
 *
sum
;

564 
	`åa˚_båfs_‹dîed_exã¡_put
(
	`BTRFS_I
(
íåy
->
öode
),Éntry);

566 i‡(
	`ªfcou¡_dec_™d_ã°
(&
íåy
->
ªfs
)) {

567 
	`ASSERT
(
	`li°_em±y
(&
íåy
->
roŸ_exã¡_li°
));

568 
	`ASSERT
(
	`li°_em±y
(&
íåy
->
log_li°
));

569 
	`ASSERT
(
	`RB_EMPTY_NODE
(&
íåy
->
rb_node
));

570 i‡(
íåy
->
öode
)

571 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
íåy
->
öode
));

572 !
	`li°_em±y
(&
íåy
->
li°
)) {

573 
cur
 = 
íåy
->
li°
.
√xt
;

574 
sum
 = 
	`li°_íåy
(
cur
, 
båfs_‹dîed_sum
, 
li°
);

575 
	`li°_dñ
(&
sum
->
li°
);

576 
	`kv‰ì
(
sum
);

578 
	`kmem_ˇche_‰ì
(
båfs_‹dîed_exã¡_ˇche
, 
íåy
);

580 
	}
}

586 
	$båfs_ªmove_‹dîed_exã¡
(
båfs_öode
 *btrfs_inode,

587 
båfs_‹dîed_exã¡
 *
íåy
)

589 
båfs_‹dîed_öode_åì
 *
åì
;

590 
båfs_roŸ
 *
roŸ
 = 
båfs_öode
->root;

591 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

592 
rb_node
 *
node
;

593 
boﬁ
 
≥ndög
;

594 
boﬁ
 
‰ì•a˚_öode
;

600 
‰ì•a˚_öode
 = 
	`båfs_is_‰ì_•a˚_öode
(
båfs_öode
);

602 
	`båfs_lockdï_acquúe
(
fs_öfo
, 
båfs_å™s_≥ndög_‹dîed
);

604 
	`•ö_lock
(&
båfs_öode
->
lock
);

605 
	`båfs_mod_out°™dög_exã¡s
(
båfs_öode
, -1);

606 
	`•ö_u∆ock
(&
båfs_öode
->
lock
);

607 i‡(
roŸ
 !
fs_öfo
->
åì_roŸ
) {

608 
u64
 
ªÀa£
;

610 i‡(
	`ã°_bô
(
BTRFS_ORDERED_ENCODED
, &
íåy
->
Êags
))

611 
ªÀa£
 = 
íåy
->
disk_num_byãs
;

613 
ªÀa£
 = 
íåy
->
num_byãs
;

614 
	`båfs_dñÆloc_ªÀa£_mëad©a
(
båfs_öode
, 
ªÀa£
,

615 
	`ã°_bô
(
BTRFS_ORDERED_IOERR
,

616 &
íåy
->
Êags
));

619 
	`≥r˝u_cou¡î_add_b©ch
(&
fs_öfo
->
‹dîed_byãs
, -
íåy
->
num_byãs
,

620 
fs_öfo
->
dñÆloc_b©ch
);

622 
åì
 = &
båfs_öode
->
‹dîed_åì
;

623 
	`•ö_lock_úq
(&
åì
->
lock
);

624 
node
 = &
íåy
->
rb_node
;

625 
	`rb_îa£
(
node
, &
åì
->tree);

626 
	`RB_CLEAR_NODE
(
node
);

627 i‡(
åì
->
œ°
 =
node
)

628 
åì
->
œ°
 = 
NULL
;

629 
	`£t_bô
(
BTRFS_ORDERED_COMPLETE
, &
íåy
->
Êags
);

630 
≥ndög
 = 
	`ã°_™d_˛ór_bô
(
BTRFS_ORDERED_PENDING
, &
íåy
->
Êags
);

631 
	`•ö_u∆ock_úq
(&
åì
->
lock
);

637 i‡(
≥ndög
) {

638 
båfs_å™ß˘i⁄
 *
å™s
;

646 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

647 
å™s
 = 
fs_öfo
->
ru¬ög_å™ß˘i⁄
;

648 i‡(
å™s
)

649 
	`ªfcou¡_öc
(&
å™s
->
u£_cou¡
);

650 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

652 
	`ASSERT
(
å™s
 || 
	`BTRFS_FS_ERROR
(
fs_öfo
));

653 i‡(
å™s
) {

654 i‡(
	`©omic_dec_™d_ã°
(&
å™s
->
≥ndög_‹dîed
))

655 
	`wake_up
(&
å™s
->
≥ndög_waô
);

656 
	`båfs_put_å™ß˘i⁄
(
å™s
);

660 
	`båfs_lockdï_ªÀa£
(
fs_öfo
, 
båfs_å™s_≥ndög_‹dîed
);

662 
	`•ö_lock
(&
roŸ
->
‹dîed_exã¡_lock
);

663 
	`li°_dñ_öô
(&
íåy
->
roŸ_exã¡_li°
);

664 
roŸ
->
ƒ_‹dîed_exã¡s
--;

666 
	`åa˚_båfs_‹dîed_exã¡_ªmove
(
båfs_öode
, 
íåy
);

668 i‡(!
roŸ
->
ƒ_‹dîed_exã¡s
) {

669 
	`•ö_lock
(&
fs_öfo
->
‹dîed_roŸ_lock
);

670 
	`BUG_ON
(
	`li°_em±y
(&
roŸ
->
‹dîed_roŸ
));

671 
	`li°_dñ_öô
(&
roŸ
->
‹dîed_roŸ
);

672 
	`•ö_u∆ock
(&
fs_öfo
->
‹dîed_roŸ_lock
);

674 
	`•ö_u∆ock
(&
roŸ
->
‹dîed_exã¡_lock
);

675 
	`wake_up
(&
íåy
->
waô
);

676 i‡(!
‰ì•a˚_öode
)

677 
	`båfs_lockdï_ªÀa£
(
fs_öfo
, 
båfs_‹dîed_exã¡
);

678 
	}
}

680 
	$båfs_run_‹dîed_exã¡_w‹k
(
båfs_w‹k
 *
w‹k
)

682 
båfs_‹dîed_exã¡
 *
‹dîed
;

684 
‹dîed
 = 
	`c⁄èöî_of
(
w‹k
, 
båfs_‹dîed_exã¡
, 
Êush_w‹k
);

685 
	`båfs_°¨t_‹dîed_exã¡
(
‹dîed
);

686 
	`com∂ëe
(&
‹dîed
->
com∂ëi⁄
);

687 
	}
}

693 
u64
 
	$båfs_waô_‹dîed_exã¡s
(
båfs_roŸ
 *
roŸ
, 
u64
 
ƒ
,

694 c⁄° 
u64
 
ønge_°¨t
, c⁄° u64 
ønge_Àn
)

696 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

697 
	`LIST_HEAD
(
•li˚
);

698 
	`LIST_HEAD
(
skù≥d
);

699 
	`LIST_HEAD
(
w‹ks
);

700 
båfs_‹dîed_exã¡
 *
‹dîed
, *
√xt
;

701 
u64
 
cou¡
 = 0;

702 c⁄° 
u64
 
ønge_íd
 = 
ønge_°¨t
 + 
ønge_Àn
;

704 
	`muãx_lock
(&
roŸ
->
‹dîed_exã¡_muãx
);

705 
	`•ö_lock
(&
roŸ
->
‹dîed_exã¡_lock
);

706 
	`li°_•li˚_öô
(&
roŸ
->
‹dîed_exã¡s
, &
•li˚
);

707 !
	`li°_em±y
(&
•li˚
Ë&& 
ƒ
) {

708 
‹dîed
 = 
	`li°_fú°_íåy
(&
•li˚
, 
båfs_‹dîed_exã¡
,

709 
roŸ_exã¡_li°
);

711 i‡(
ønge_íd
 <
‹dîed
->
disk_byãƒ
 ||

712 
‹dîed
->
disk_byãƒ
 + ordîed->
disk_num_byãs
 <
ønge_°¨t
) {

713 
	`li°_move_èû
(&
‹dîed
->
roŸ_exã¡_li°
, &
skù≥d
);

714 
	`c⁄d_ªsched_lock
(&
roŸ
->
‹dîed_exã¡_lock
);

718 
	`li°_move_èû
(&
‹dîed
->
roŸ_exã¡_li°
,

719 &
roŸ
->
‹dîed_exã¡s
);

720 
	`ªfcou¡_öc
(&
‹dîed
->
ªfs
);

721 
	`•ö_u∆ock
(&
roŸ
->
‹dîed_exã¡_lock
);

723 
	`båfs_öô_w‹k
(&
‹dîed
->
Êush_w‹k
,

724 
båfs_run_‹dîed_exã¡_w‹k
, 
NULL
, NULL);

725 
	`li°_add_èû
(&
‹dîed
->
w‹k_li°
, &
w‹ks
);

726 
	`båfs_queue_w‹k
(
fs_öfo
->
Êush_w‹kîs
, &
‹dîed
->
Êush_w‹k
);

728 
	`c⁄d_ªsched
();

729 
	`•ö_lock
(&
roŸ
->
‹dîed_exã¡_lock
);

730 i‡(
ƒ
 !
U64_MAX
)

731 
ƒ
--;

732 
cou¡
++;

734 
	`li°_•li˚_èû
(&
skù≥d
, &
roŸ
->
‹dîed_exã¡s
);

735 
	`li°_•li˚_èû
(&
•li˚
, &
roŸ
->
‹dîed_exã¡s
);

736 
	`•ö_u∆ock
(&
roŸ
->
‹dîed_exã¡_lock
);

738 
	`li°_f‹_óch_íåy_ß„
(
‹dîed
, 
√xt
, &
w‹ks
, 
w‹k_li°
) {

739 
	`li°_dñ_öô
(&
‹dîed
->
w‹k_li°
);

740 
	`waô_f‹_com∂ëi⁄
(&
‹dîed
->
com∂ëi⁄
);

741 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

742 
	`c⁄d_ªsched
();

744 
	`muãx_u∆ock
(&
roŸ
->
‹dîed_exã¡_muãx
);

746  
cou¡
;

747 
	}
}

749 
	$båfs_waô_‹dîed_roŸs
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
ƒ
,

750 c⁄° 
u64
 
ønge_°¨t
, c⁄° u64 
ønge_Àn
)

752 
båfs_roŸ
 *
roŸ
;

753 
	`LIST_HEAD
(
•li˚
);

754 
u64
 
d⁄e
;

756 
	`muãx_lock
(&
fs_öfo
->
‹dîed_›î©i⁄s_muãx
);

757 
	`•ö_lock
(&
fs_öfo
->
‹dîed_roŸ_lock
);

758 
	`li°_•li˚_öô
(&
fs_öfo
->
‹dîed_roŸs
, &
•li˚
);

759 !
	`li°_em±y
(&
•li˚
Ë&& 
ƒ
) {

760 
roŸ
 = 
	`li°_fú°_íåy
(&
•li˚
, 
båfs_roŸ
,

761 
‹dîed_roŸ
);

762 
roŸ
 = 
	`båfs_gøb_roŸ
(root);

763 
	`BUG_ON
(!
roŸ
);

764 
	`li°_move_èû
(&
roŸ
->
‹dîed_roŸ
,

765 &
fs_öfo
->
‹dîed_roŸs
);

766 
	`•ö_u∆ock
(&
fs_öfo
->
‹dîed_roŸ_lock
);

768 
d⁄e
 = 
	`båfs_waô_‹dîed_exã¡s
(
roŸ
, 
ƒ
,

769 
ønge_°¨t
, 
ønge_Àn
);

770 
	`båfs_put_roŸ
(
roŸ
);

772 
	`•ö_lock
(&
fs_öfo
->
‹dîed_roŸ_lock
);

773 i‡(
ƒ
 !
U64_MAX
) {

774 
ƒ
 -
d⁄e
;

777 
	`li°_•li˚_èû
(&
•li˚
, &
fs_öfo
->
‹dîed_roŸs
);

778 
	`•ö_u∆ock
(&
fs_öfo
->
‹dîed_roŸ_lock
);

779 
	`muãx_u∆ock
(&
fs_öfo
->
‹dîed_›î©i⁄s_muãx
);

780 
	}
}

788 
	$båfs_°¨t_‹dîed_exã¡
(
båfs_‹dîed_exã¡
 *
íåy
)

790 
u64
 
°¨t
 = 
íåy
->
fûe_off£t
;

791 
u64
 
íd
 = 
°¨t
 + 
íåy
->
num_byãs
 - 1;

792 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
íåy
->inode);

793 
boﬁ
 
‰ì•a˚_öode
;

795 
	`åa˚_båfs_‹dîed_exã¡_°¨t
(
öode
, 
íåy
);

801 
‰ì•a˚_öode
 = 
	`båfs_is_‰ì_•a˚_öode
(
öode
);

808 i‡(!
	`ã°_bô
(
BTRFS_ORDERED_DIRECT
, &
íåy
->
Êags
))

809 
	`fûem≠_fd©awrôe_ønge
(
öode
->
vfs_öode
.
i_m≠pög
, 
°¨t
, 
íd
);

811 i‡(!
‰ì•a˚_öode
)

812 
	`båfs_might_waô_f‹_evít
(
öode
->
roŸ
->
fs_öfo
, 
båfs_‹dîed_exã¡
);

813 
	`waô_evít
(
íåy
->
waô
, 
	`ã°_bô
(
BTRFS_ORDERED_COMPLETE
, &íåy->
Êags
));

814 
	}
}

819 
	$båfs_waô_‹dîed_ønge
(
öode
 *öode, 
u64
 
°¨t
, u64 
Àn
)

821 
ªt
 = 0;

822 
ªt_wb
 = 0;

823 
u64
 
íd
;

824 
u64
 
‹ig_íd
;

825 
båfs_‹dîed_exã¡
 *
‹dîed
;

827 i‡(
°¨t
 + 
Àn
 < start) {

828 
‹ig_íd
 = 
OFFSET_MAX
;

830 
‹ig_íd
 = 
°¨t
 + 
Àn
 - 1;

831 i‡(
‹ig_íd
 > 
OFFSET_MAX
)

832 
‹ig_íd
 = 
OFFSET_MAX
;

838 
ªt
 = 
	`båfs_fd©awrôe_ønge
(
öode
, 
°¨t
, 
‹ig_íd
);

839 i‡(
ªt
)

840  
ªt
;

849 
ªt_wb
 = 
	`fûem≠_fd©awaô_ønge
(
öode
->
i_m≠pög
, 
°¨t
, 
‹ig_íd
);

851 
íd
 = 
‹ig_íd
;

853 
‹dîed
 = 
	`båfs_lookup_fú°_‹dîed_exã¡
(
	`BTRFS_I
(
öode
), 
íd
);

854 i‡(!
‹dîed
)

856 i‡(
‹dîed
->
fûe_off£t
 > 
‹ig_íd
) {

857 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

860 i‡(
‹dîed
->
fûe_off£t
 + ordîed->
num_byãs
 <
°¨t
) {

861 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

864 
	`båfs_°¨t_‹dîed_exã¡
(
‹dîed
);

865 
íd
 = 
‹dîed
->
fûe_off£t
;

871 i‡(
	`ã°_bô
(
BTRFS_ORDERED_IOERR
, &
‹dîed
->
Êags
))

872 
ªt
 = -
EIO
;

873 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

874 i‡(
íd
 =0 ||Énd =
°¨t
)

876 
íd
--;

878  
ªt_wb
 ?Ñë_wb : 
ªt
;

879 
	}
}

885 
båfs_‹dîed_exã¡
 *
	$båfs_lookup_‹dîed_exã¡
(
båfs_öode
 *
öode
,

886 
u64
 
fûe_off£t
)

888 
båfs_‹dîed_öode_åì
 *
åì
;

889 
rb_node
 *
node
;

890 
båfs_‹dîed_exã¡
 *
íåy
 = 
NULL
;

891 
Êags
;

893 
åì
 = &
öode
->
‹dîed_åì
;

894 
	`•ö_lock_úqßve
(&
åì
->
lock
, 
Êags
);

895 
node
 = 
	`åì_£¨ch
(
åì
, 
fûe_off£t
);

896 i‡(!
node
)

897 
out
;

899 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‹dîed_exã¡
, 
rb_node
);

900 i‡(!
	`ö_ønge
(
fûe_off£t
, 
íåy
->fûe_off£t,É¡ry->
num_byãs
))

901 
íåy
 = 
NULL
;

902 i‡(
íåy
) {

903 
	`ªfcou¡_öc
(&
íåy
->
ªfs
);

904 
	`åa˚_båfs_‹dîed_exã¡_lookup
(
öode
, 
íåy
);

906 
out
:

907 
	`•ö_u∆ock_úqª°‹e
(&
åì
->
lock
, 
Êags
);

908  
íåy
;

909 
	}
}

914 
båfs_‹dîed_exã¡
 *
	$båfs_lookup_‹dîed_ønge
(

915 
båfs_öode
 *
öode
, 
u64
 
fûe_off£t
, u64 
Àn
)

917 
båfs_‹dîed_öode_åì
 *
åì
;

918 
rb_node
 *
node
;

919 
båfs_‹dîed_exã¡
 *
íåy
 = 
NULL
;

921 
åì
 = &
öode
->
‹dîed_åì
;

922 
	`•ö_lock_úq
(&
åì
->
lock
);

923 
node
 = 
	`åì_£¨ch
(
åì
, 
fûe_off£t
);

924 i‡(!
node
) {

925 
node
 = 
	`åì_£¨ch
(
åì
, 
fûe_off£t
 + 
Àn
);

926 i‡(!
node
)

927 
out
;

931 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‹dîed_exã¡
, 
rb_node
);

932 i‡(
	`ønge_ovîœps
(
íåy
, 
fûe_off£t
, 
Àn
))

935 i‡(
íåy
->
fûe_off£t
 >fûe_off£à+ 
Àn
) {

936 
íåy
 = 
NULL
;

939 
íåy
 = 
NULL
;

940 
node
 = 
	`rb_√xt
(node);

941 i‡(!
node
)

944 
out
:

945 i‡(
íåy
) {

946 
	`ªfcou¡_öc
(&
íåy
->
ªfs
);

947 
	`åa˚_båfs_‹dîed_exã¡_lookup_ønge
(
öode
, 
íåy
);

949 
	`•ö_u∆ock_úq
(&
åì
->
lock
);

950  
íåy
;

951 
	}
}

957 
	$båfs_gë_‹dîed_exã¡s_f‹_loggög
(
båfs_öode
 *
öode
,

958 
li°_hód
 *
li°
)

960 
båfs_‹dîed_öode_åì
 *
åì
 = &
öode
->
‹dîed_åì
;

961 
rb_node
 *
n
;

963 
	`ASSERT
(
	`öode_is_locked
(&
öode
->
vfs_öode
));

965 
	`•ö_lock_úq
(&
åì
->
lock
);

966 
n
 = 
	`rb_fú°
(&
åì
->åì);Ç;Ç = 
	`rb_√xt
(n)) {

967 
båfs_‹dîed_exã¡
 *
‹dîed
;

969 
‹dîed
 = 
	`rb_íåy
(
n
, 
båfs_‹dîed_exã¡
, 
rb_node
);

971 i‡(
	`ã°_bô
(
BTRFS_ORDERED_LOGGED
, &
‹dîed
->
Êags
))

974 
	`ASSERT
(
	`li°_em±y
(&
‹dîed
->
log_li°
));

975 
	`li°_add_èû
(&
‹dîed
->
log_li°
, 
li°
);

976 
	`ªfcou¡_öc
(&
‹dîed
->
ªfs
);

977 
	`åa˚_båfs_‹dîed_exã¡_lookup_f‹_loggög
(
öode
, 
‹dîed
);

979 
	`•ö_u∆ock_úq
(&
åì
->
lock
);

980 
	}
}

986 
båfs_‹dîed_exã¡
 *

987 
	$båfs_lookup_fú°_‹dîed_exã¡
(
båfs_öode
 *
öode
, 
u64
 
fûe_off£t
)

989 
båfs_‹dîed_öode_åì
 *
åì
;

990 
rb_node
 *
node
;

991 
båfs_‹dîed_exã¡
 *
íåy
 = 
NULL
;

993 
åì
 = &
öode
->
‹dîed_åì
;

994 
	`•ö_lock_úq
(&
åì
->
lock
);

995 
node
 = 
	`åì_£¨ch
(
åì
, 
fûe_off£t
);

996 i‡(!
node
)

997 
out
;

999 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‹dîed_exã¡
, 
rb_node
);

1000 
	`ªfcou¡_öc
(&
íåy
->
ªfs
);

1001 
	`åa˚_båfs_‹dîed_exã¡_lookup_fú°
(
öode
, 
íåy
);

1002 
out
:

1003 
	`•ö_u∆ock_úq
(&
åì
->
lock
);

1004  
íåy
;

1005 
	}
}

1016 
båfs_‹dîed_exã¡
 *
	$båfs_lookup_fú°_‹dîed_ønge
(

1017 
båfs_öode
 *
öode
, 
u64
 
fûe_off£t
, u64 
Àn
)

1019 
båfs_‹dîed_öode_åì
 *
åì
 = &
öode
->
‹dîed_åì
;

1020 
rb_node
 *
node
;

1021 
rb_node
 *
cur
;

1022 
rb_node
 *
¥ev
;

1023 
rb_node
 *
√xt
;

1024 
båfs_‹dîed_exã¡
 *
íåy
 = 
NULL
;

1026 
	`•ö_lock_úq
(&
åì
->
lock
);

1027 
node
 = 
åì
->åì.
rb_node
;

1034 
node
) {

1035 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‹dîed_exã¡
, 
rb_node
);

1037 i‡(
fûe_off£t
 < 
íåy
->file_offset) {

1038 
node
 =Çode->
rb_À·
;

1039 } i‡(
fûe_off£t
 >
	`íåy_íd
(
íåy
)) {

1040 
node
 =Çode->
rb_right
;

1046 
out
;

1049 i‡(!
íåy
) {

1051 
out
;

1054 
cur
 = &
íåy
->
rb_node
;

1056 i‡(
íåy
->
fûe_off£t
 < file_offset) {

1057 
¥ev
 = 
cur
;

1058 
√xt
 = 
	`rb_√xt
(
cur
);

1060 
¥ev
 = 
	`rb_¥ev
(
cur
);

1061 
√xt
 = 
cur
;

1063 i‡(
¥ev
) {

1064 
íåy
 = 
	`rb_íåy
(
¥ev
, 
båfs_‹dîed_exã¡
, 
rb_node
);

1065 i‡(
	`ønge_ovîœps
(
íåy
, 
fûe_off£t
, 
Àn
))

1066 
out
;

1068 i‡(
√xt
) {

1069 
íåy
 = 
	`rb_íåy
(
√xt
, 
båfs_‹dîed_exã¡
, 
rb_node
);

1070 i‡(
	`ønge_ovîœps
(
íåy
, 
fûe_off£t
, 
Àn
))

1071 
out
;

1074 
íåy
 = 
NULL
;

1075 
out
:

1076 i‡(
íåy
) {

1077 
	`ªfcou¡_öc
(&
íåy
->
ªfs
);

1078 
	`åa˚_båfs_‹dîed_exã¡_lookup_fú°_ønge
(
öode
, 
íåy
);

1081 
	`•ö_u∆ock_úq
(&
åì
->
lock
);

1082  
íåy
;

1083 
	}
}

1099 
	$båfs_lock_™d_Êush_‹dîed_ønge
(
båfs_öode
 *
öode
, 
u64
 
°¨t
,

1100 
u64
 
íd
,

1101 
exã¡_°©e
 **
ˇched_°©e
)

1103 
båfs_‹dîed_exã¡
 *
‹dîed
;

1104 
exã¡_°©e
 *
ˇche
 = 
NULL
;

1105 
exã¡_°©e
 **
ˇchedp
 = &
ˇche
;

1107 i‡(
ˇched_°©e
)

1108 
ˇchedp
 = 
ˇched_°©e
;

1111 
	`lock_exã¡
(&
öode
->
io_åì
, 
°¨t
, 
íd
, 
ˇchedp
);

1112 
‹dîed
 = 
	`båfs_lookup_‹dîed_ønge
(
öode
, 
°¨t
,

1113 
íd
 - 
°¨t
 + 1);

1114 i‡(!
‹dîed
) {

1120 i‡(!
ˇched_°©e
)

1121 
	`ªfcou¡_dec
(&
ˇche
->
ªfs
);

1124 
	`u∆ock_exã¡
(&
öode
->
io_åì
, 
°¨t
, 
íd
, 
ˇchedp
);

1125 
	`båfs_°¨t_‹dîed_exã¡
(
‹dîed
);

1126 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

1128 
	}
}

1137 
boﬁ
 
	$båfs_åy_lock_‹dîed_ønge
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
,

1138 
exã¡_°©e
 **
ˇched_°©e
)

1140 
båfs_‹dîed_exã¡
 *
‹dîed
;

1142 i‡(!
	`åy_lock_exã¡
(&
öode
->
io_åì
, 
°¨t
, 
íd
, 
ˇched_°©e
))

1143  
Ál£
;

1145 
‹dîed
 = 
	`båfs_lookup_‹dîed_ønge
(
öode
, 
°¨t
, 
íd
 - start + 1);

1146 i‡(!
‹dîed
)

1147  
åue
;

1149 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

1150 
	`u∆ock_exã¡
(&
öode
->
io_åì
, 
°¨t
, 
íd
, 
ˇched_°©e
);

1152  
Ál£
;

1153 
	}
}

1156 
båfs_‹dîed_exã¡
 *
	$båfs_•lô_‹dîed_exã¡
(

1157 
båfs_‹dîed_exã¡
 *
‹dîed
, 
u64
 
Àn
)

1159 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
‹dîed
->inode);

1160 
båfs_‹dîed_öode_åì
 *
åì
 = &
öode
->
‹dîed_åì
;

1161 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

1162 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1163 
u64
 
fûe_off£t
 = 
‹dîed
->file_offset;

1164 
u64
 
disk_byãƒ
 = 
‹dîed
->disk_bytenr;

1165 
Êags
 = 
‹dîed
->flags;

1166 
båfs_‹dîed_sum
 *
sum
, *
tmpsum
;

1167 
båfs_‹dîed_exã¡
 *
√w
;

1168 
rb_node
 *
node
;

1169 
u64
 
off£t
 = 0;

1171 
	`åa˚_båfs_‹dîed_exã¡_•lô
(
öode
, 
‹dîed
);

1173 
	`ASSERT
(!(
Êags
 & (1U << 
BTRFS_ORDERED_COMPRESSED
)));

1179 i‡(
	`WARN_ON_ONCE
(
Àn
 >
‹dîed
->
num_byãs
))

1180  
	`ERR_PTR
(-
EINVAL
);

1182 i‡(
‹dîed
->
byãs_À·
) {

1183 
	`ASSERT
(!(
Êags
 & ~
BTRFS_ORDERED_TYPE_FLAGS
));

1184 i‡(
	`WARN_ON_ONCE
(
‹dîed
->
byãs_À·
 !‹dîed->
disk_num_byãs
))

1185  
	`ERR_PTR
(-
EINVAL
);

1188 i‡(
	`WARN_ON_ONCE
(
‹dîed
->
disk_num_byãs
 !‹dîed->
num_byãs
))

1189  
	`ERR_PTR
(-
EINVAL
);

1191 
√w
 = 
	`Æloc_‹dîed_exã¡
(
öode
, 
fûe_off£t
, 
Àn
,Üí, 
disk_byãƒ
,

1192 
Àn
, 0, 
Êags
, 
‹dîed
->
com¥ess_ty≥
);

1193 i‡(
	`IS_ERR
(
√w
))

1194  
√w
;

1197 
	`ªfcou¡_öc
(&
√w
->
ªfs
);

1199 
	`•ö_lock_úq
(&
roŸ
->
‹dîed_exã¡_lock
);

1200 
	`•ö_lock
(&
åì
->
lock
);

1202 
node
 = &
‹dîed
->
rb_node
;

1203 
	`rb_îa£
(
node
, &
åì
->tree);

1204 
	`RB_CLEAR_NODE
(
node
);

1205 i‡(
åì
->
œ°
 =
node
)

1206 
åì
->
œ°
 = 
NULL
;

1208 
‹dîed
->
fûe_off£t
 +
Àn
;

1209 
‹dîed
->
disk_byãƒ
 +
Àn
;

1210 
‹dîed
->
num_byãs
 -
Àn
;

1211 
‹dîed
->
disk_num_byãs
 -
Àn
;

1213 i‡(
	`ã°_bô
(
BTRFS_ORDERED_IO_DONE
, &
‹dîed
->
Êags
)) {

1214 
	`ASSERT
(
‹dîed
->
byãs_À·
 == 0);

1215 
√w
->
byãs_À·
 = 0;

1217 
‹dîed
->
byãs_À·
 -
Àn
;

1220 i‡(
	`ã°_bô
(
BTRFS_ORDERED_TRUNCATED
, &
‹dîed
->
Êags
)) {

1221 i‡(
‹dîed
->
åunˇãd_Àn
 > 
Àn
) {

1222 
‹dîed
->
åunˇãd_Àn
 -
Àn
;

1224 
√w
->
åunˇãd_Àn
 = 
‹dîed
->truncated_len;

1225 
‹dîed
->
åunˇãd_Àn
 = 0;

1229 
	`li°_f‹_óch_íåy_ß„
(
sum
, 
tmpsum
, &
‹dîed
->
li°
,Üist) {

1230 i‡(
off£t
 =
Àn
)

1232 
	`li°_move_èû
(&
sum
->
li°
, &
√w
->list);

1233 
off£t
 +
sum
->
Àn
;

1237 
node
 = 
	`åì_ö£π
(&
åì
->åì, 
‹dîed
->
fûe_off£t
, &‹dîed->
rb_node
);

1238 i‡(
node
)

1239 
	`båfs_∑nic
(
fs_öfo
, -
EEXIST
,

1241 
‹dîed
->
fûe_off£t
);

1243 
node
 = 
	`åì_ö£π
(&
åì
->åì, 
√w
->
fûe_off£t
, &√w->
rb_node
);

1244 i‡(
node
)

1245 
	`båfs_∑nic
(
fs_öfo
, -
EEXIST
,

1247 
√w
->
fûe_off£t
);

1248 
	`•ö_u∆ock
(&
åì
->
lock
);

1250 
	`li°_add_èû
(&
√w
->
roŸ_exã¡_li°
, &
roŸ
->
‹dîed_exã¡s
);

1251 
roŸ
->
ƒ_‹dîed_exã¡s
++;

1252 
	`•ö_u∆ock_úq
(&
roŸ
->
‹dîed_exã¡_lock
);

1253  
√w
;

1254 
	}
}

1256 
__öô
 
	$‹dîed_d©a_öô
()

1258 
båfs_‹dîed_exã¡_ˇche
 = 
	`kmem_ˇche_¸óã
("btrfs_ordered_extent",

1259 (
båfs_‹dîed_exã¡
), 0,

1260 
SLAB_MEM_SPREAD
,

1261 
NULL
);

1262 i‡(!
båfs_‹dîed_exã¡_ˇche
)

1263  -
ENOMEM
;

1266 
	}
}

1268 
__cﬁd
 
	$‹dîed_d©a_exô
()

1270 
	`kmem_ˇche_de°roy
(
båfs_‹dîed_exã¡_ˇche
);

1271 
	}
}

	@ordered-data.h

6 #i‚de‡
BTRFS_ORDERED_DATA_H


7 
	#BTRFS_ORDERED_DATA_H


	)

10 
	sbåfs_‹dîed_öode_åì
 {

11 
•ölock_t
 
	mlock
;

12 
rb_roŸ
 
	måì
;

13 
rb_node
 *
	mœ°
;

16 
	sbåfs_‹dîed_sum
 {

21 
u64
 
	mlogiˇl
;

22 
u32
 
	mÀn
;

24 
li°_hód
 
	mli°
;

26 
u8
 
	msums
[];

50 
	mBTRFS_ORDERED_REGULAR
,

51 
	mBTRFS_ORDERED_NOCOW
,

52 
	mBTRFS_ORDERED_PREALLOC
,

53 
	mBTRFS_ORDERED_COMPRESSED
,

59 
	mBTRFS_ORDERED_DIRECT
,

64 
	mBTRFS_ORDERED_IO_DONE
,

66 
	mBTRFS_ORDERED_COMPLETE
,

68 
	mBTRFS_ORDERED_IOERR
,

70 
	mBTRFS_ORDERED_TRUNCATED
,

72 
	mBTRFS_ORDERED_LOGGED
,

74 
	mBTRFS_ORDERED_LOGGED_CSUM
,

76 
	mBTRFS_ORDERED_PENDING
,

78 
	mBTRFS_ORDERED_ENCODED
,

82 
	#BTRFS_ORDERED_TYPE_FLAGS
 ((1UL << 
BTRFS_ORDERED_REGULAR
) | \

83 (1UL << 
BTRFS_ORDERED_NOCOW
) | \

84 (1UL << 
BTRFS_ORDERED_PREALLOC
) | \

85 (1UL << 
BTRFS_ORDERED_COMPRESSED
) | \

86 (1UL << 
BTRFS_ORDERED_DIRECT
) | \

87 (1UL << 
BTRFS_ORDERED_ENCODED
))

	)

89 
	sbåfs_‹dîed_exã¡
 {

91 
u64
 
	mfûe_off£t
;

97 
u64
 
	mnum_byãs
;

98 
u64
 
	møm_byãs
;

99 
u64
 
	mdisk_byãƒ
;

100 
u64
 
	mdisk_num_byãs
;

101 
u64
 
	moff£t
;

104 
u64
 
	mbyãs_À·
;

111 
u64
 
	mout°™dög_isize
;

117 
u64
 
	måunˇãd_Àn
;

120 
	mÊags
;

123 
	mcom¥ess_ty≥
;

126 
	mqgroup_rsv
;

129 
ªfcou¡_t
 
	mªfs
;

132 
öode
 *
	möode
;

135 
li°_hód
 
	mli°
;

138 
li°_hód
 
	mlog_li°
;

141 
waô_queue_hód_t
 
	mwaô
;

144 
rb_node
 
	mrb_node
;

147 
li°_hód
 
	mroŸ_exã¡_li°
;

149 
båfs_w‹k
 
	mw‹k
;

151 
com∂ëi⁄
 
	mcom∂ëi⁄
;

152 
båfs_w‹k
 
	mÊush_w‹k
;

153 
li°_hód
 
	mw‹k_li°
;

156 
ölöe
 

157 
	$båfs_‹dîed_öode_åì_öô
(
båfs_‹dîed_öode_åì
 *
t
)

159 
	`•ö_lock_öô
(&
t
->
lock
);

160 
t
->
åì
 = 
RB_ROOT
;

161 
t
->
œ°
 = 
NULL
;

162 
	}
}

164 
båfs_föish_⁄e_‹dîed
(
båfs_‹dîed_exã¡
 *
‹dîed_exã¡
);

165 
båfs_föish_‹dîed_io
(
båfs_‹dîed_exã¡
 *
‹dîed_exã¡
);

167 
båfs_put_‹dîed_exã¡
(
båfs_‹dîed_exã¡
 *
íåy
);

168 
båfs_ªmove_‹dîed_exã¡
(
båfs_öode
 *btrfs_inode,

169 
båfs_‹dîed_exã¡
 *
íåy
);

170 
boﬁ
 
båfs_föish_‹dîed_exã¡
(
båfs_‹dîed_exã¡
 *
‹dîed
,

171 
∑ge
 *∑ge, 
u64
 
fûe_off£t
, u64 
Àn
,

172 
boﬁ
 
u±od©e
);

173 
båfs_m¨k_‹dîed_io_föished
(
båfs_öode
 *
öode
,

174 
∑ge
 *∑ge, 
u64
 
fûe_off£t
,

175 
u64
 
num_byãs
, 
boﬁ
 
u±od©e
);

176 
boﬁ
 
båfs_dec_ã°_‹dîed_≥ndög
(
båfs_öode
 *
öode
,

177 
båfs_‹dîed_exã¡
 **
ˇched
,

178 
u64
 
fûe_off£t
, u64 
io_size
);

179 
båfs_‹dîed_exã¡
 *
båfs_Æloc_‹dîed_exã¡
(

180 
båfs_öode
 *
öode
, 
u64
 
fûe_off£t
,

181 
u64
 
num_byãs
, u64 
øm_byãs
, u64 
disk_byãƒ
,

182 
u64
 
disk_num_byãs
, u64 
off£t
, 
Êags
,

183 
com¥ess_ty≥
);

184 
båfs_add_‹dîed_sum
(
båfs_‹dîed_exã¡
 *
íåy
,

185 
båfs_‹dîed_sum
 *
sum
);

186 
båfs_‹dîed_exã¡
 *
båfs_lookup_‹dîed_exã¡
(
båfs_öode
 *
öode
,

187 
u64
 
fûe_off£t
);

188 
båfs_°¨t_‹dîed_exã¡
(
båfs_‹dîed_exã¡
 *
íåy
);

189 
båfs_waô_‹dîed_ønge
(
öode
 *öode, 
u64
 
°¨t
, u64 
Àn
);

190 
båfs_‹dîed_exã¡
 *

191 
båfs_lookup_fú°_‹dîed_exã¡
(
båfs_öode
 *
öode
, 
u64
 
fûe_off£t
);

192 
båfs_‹dîed_exã¡
 *
båfs_lookup_fú°_‹dîed_ønge
(

193 
båfs_öode
 *
öode
, 
u64
 
fûe_off£t
, u64 
Àn
);

194 
båfs_‹dîed_exã¡
 *
båfs_lookup_‹dîed_ønge
(

195 
båfs_öode
 *
öode
,

196 
u64
 
fûe_off£t
,

197 
u64
 
Àn
);

198 
båfs_gë_‹dîed_exã¡s_f‹_loggög
(
båfs_öode
 *
öode
,

199 
li°_hód
 *
li°
);

200 
u64
 
båfs_waô_‹dîed_exã¡s
(
båfs_roŸ
 *
roŸ
, u64 
ƒ
,

201 c⁄° 
u64
 
ønge_°¨t
, c⁄° u64 
ønge_Àn
);

202 
båfs_waô_‹dîed_roŸs
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
ƒ
,

203 c⁄° 
u64
 
ønge_°¨t
, c⁄° u64 
ønge_Àn
);

204 
båfs_lock_™d_Êush_‹dîed_ønge
(
båfs_öode
 *
öode
, 
u64
 
°¨t
,

205 
u64
 
íd
,

206 
exã¡_°©e
 **
ˇched_°©e
);

207 
boﬁ
 
båfs_åy_lock_‹dîed_ønge
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
íd
,

208 
exã¡_°©e
 **
ˇched_°©e
);

209 
båfs_‹dîed_exã¡
 *
båfs_•lô_‹dîed_exã¡
(

210 
båfs_‹dîed_exã¡
 *
‹dîed
, 
u64
 
Àn
);

211 
__öô
 
‹dîed_d©a_öô
();

212 
__cﬁd
 
‹dîed_d©a_exô
();

	@orphan.c

6 
	~"˘ªe.h
"

7 
	~"disk-io.h
"

8 
	~"‹ph™.h
"

10 
	$båfs_ö£π_‹ph™_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

11 
båfs_roŸ
 *
roŸ
, 
u64
 
off£t
)

13 
båfs_∑th
 *
∑th
;

14 
båfs_key
 
key
;

15 
ªt
 = 0;

17 
key
.
obje˘id
 = 
BTRFS_ORPHAN_OBJECTID
;

18 
key
.
ty≥
 = 
BTRFS_ORPHAN_ITEM_KEY
;

19 
key
.
off£t
 = offset;

21 
∑th
 = 
	`båfs_Æloc_∑th
();

22 i‡(!
∑th
)

23  -
ENOMEM
;

25 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
, 0);

27 
	`båfs_‰ì_∑th
(
∑th
);

28  
ªt
;

29 
	}
}

31 
	$båfs_dñ_‹ph™_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

32 
båfs_roŸ
 *
roŸ
, 
u64
 
off£t
)

34 
båfs_∑th
 *
∑th
;

35 
båfs_key
 
key
;

36 
ªt
 = 0;

38 
key
.
obje˘id
 = 
BTRFS_ORPHAN_OBJECTID
;

39 
key
.
ty≥
 = 
BTRFS_ORPHAN_ITEM_KEY
;

40 
key
.
off£t
 = offset;

42 
∑th
 = 
	`båfs_Æloc_∑th
();

43 i‡(!
∑th
)

44  -
ENOMEM
;

46 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

47 i‡(
ªt
 < 0)

48 
out
;

49 i‡(
ªt
) {

50 
ªt
 = -
ENOENT
;

51 
out
;

54 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

56 
out
:

57 
	`båfs_‰ì_∑th
(
∑th
);

58  
ªt
;

59 
	}
}

	@orphan.h

3 #i‚de‡
BTRFS_ORPHAN_H


4 
	#BTRFS_ORPHAN_H


	)

6 
båfs_ö£π_‹ph™_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

7 
båfs_roŸ
 *
roŸ
, 
u64
 
off£t
);

8 
båfs_dñ_‹ph™_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

9 
båfs_roŸ
 *
roŸ
, 
u64
 
off£t
);

	@print-tree.c

6 
	~"mesßges.h
"

7 
	~"˘ªe.h
"

8 
	~"disk-io.h
"

9 
	~"¥öt-åì.h
"

10 
	~"ac˚ss‹s.h
"

11 
	~"åì-checkî.h
"

13 
	sroŸ_«me_m≠
 {

14 
u64
 
	mid
;

15 
	m«me
[16];

18 c⁄° 
roŸ_«me_m≠
 
	groŸ_m≠
[] = {

19 { 
BTRFS_ROOT_TREE_OBJECTID
, "ROOT_TREE" },

20 { 
BTRFS_EXTENT_TREE_OBJECTID
, "EXTENT_TREE" },

21 { 
BTRFS_CHUNK_TREE_OBJECTID
, "CHUNK_TREE" },

22 { 
BTRFS_DEV_TREE_OBJECTID
, "DEV_TREE" },

23 { 
BTRFS_FS_TREE_OBJECTID
, "FS_TREE" },

24 { 
BTRFS_CSUM_TREE_OBJECTID
, "CSUM_TREE" },

25 { 
BTRFS_TREE_LOG_OBJECTID
, "TREE_LOG" },

26 { 
BTRFS_QUOTA_TREE_OBJECTID
, "QUOTA_TREE" },

27 { 
BTRFS_UUID_TREE_OBJECTID
, "UUID_TREE" },

28 { 
BTRFS_FREE_SPACE_TREE_OBJECTID
, "FREE_SPACE_TREE" },

29 { 
BTRFS_BLOCK_GROUP_TREE_OBJECTID
, "BLOCK_GROUP_TREE" },

30 { 
BTRFS_DATA_RELOC_TREE_OBJECTID
, "DATA_RELOC_TREE" },

33 c⁄° *
	$båfs_roŸ_«me
(c⁄° 
båfs_key
 *
key
, *
buf
)

35 
i
;

37 i‡(
key
->
obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
) {

38 
	`¢¥ötf
(
buf
, 
BTRFS_ROOT_NAME_BUF_LEN
,

39 "TREE_RELOC off£t=%Œu", 
key
->
off£t
);

40  
buf
;

43 
i
 = 0; i < 
	`ARRAY_SIZE
(
roŸ_m≠
); i++) {

44 i‡(
roŸ_m≠
[
i
].
id
 =
key
->
obje˘id
)

45  
roŸ_m≠
[
i
].
«me
;

48 
	`¢¥ötf
(
buf
, 
BTRFS_ROOT_NAME_BUF_LEN
, "%Œu", 
key
->
obje˘id
);

49  
buf
;

50 
	}
}

52 
	$¥öt_chunk
(c⁄° 
exã¡_buf„r
 *
eb
, 
båfs_chunk
 *
chunk
)

54 
num_°rùes
 = 
	`båfs_chunk_num_°rùes
(
eb
, 
chunk
);

55 
i
;

56 
	`¥_öfo
("\t\tchunkÜength %llu owner %lluÅype %lluÇum_stripes %d\n",

57 
	`båfs_chunk_Àngth
(
eb
, 
chunk
), 
	`båfs_chunk_ow√r
(eb, chunk),

58 
	`båfs_chunk_ty≥
(
eb
, 
chunk
), 
num_°rùes
);

59 
i
 = 0 ; i < 
num_°rùes
 ; i++) {

60 
	`¥_öfo
("\t\t\t°rùê%d devid %Œu off£à%Œu\n", 
i
,

61 
	`båfs_°rùe_devid_ƒ
(
eb
, 
chunk
, 
i
),

62 
	`båfs_°rùe_off£t_ƒ
(
eb
, 
chunk
, 
i
));

64 
	}
}

65 
	$¥öt_dev_ôem
(c⁄° 
exã¡_buf„r
 *
eb
,

66 
båfs_dev_ôem
 *
dev_ôem
)

68 
	`¥_öfo
("\t\tdev item devid %lluÅotal_bytes %llu bytes used %llu\n",

69 
	`båfs_devi˚_id
(
eb
, 
dev_ôem
),

70 
	`båfs_devi˚_tŸÆ_byãs
(
eb
, 
dev_ôem
),

71 
	`båfs_devi˚_byãs_u£d
(
eb
, 
dev_ôem
));

72 
	}
}

73 
	$¥öt_exã¡_d©a_ªf
(c⁄° 
exã¡_buf„r
 *
eb
,

74 
båfs_exã¡_d©a_ªf
 *
ªf
)

76 
	`¥_c⁄t
("extent data backrefÑoot %llu objectid %llu offset %llu count %u\n",

77 
	`båfs_exã¡_d©a_ªf_roŸ
(
eb
, 
ªf
),

78 
	`båfs_exã¡_d©a_ªf_obje˘id
(
eb
, 
ªf
),

79 
	`båfs_exã¡_d©a_ªf_off£t
(
eb
, 
ªf
),

80 
	`båfs_exã¡_d©a_ªf_cou¡
(
eb
, 
ªf
));

81 
	}
}

83 
	$¥öt_exã¡_ôem
(c⁄° 
exã¡_buf„r
 *
eb
, 
¶Ÿ
, 
ty≥
)

85 
båfs_exã¡_ôem
 *
ei
;

86 
båfs_exã¡_ölöe_ªf
 *
úef
;

87 
båfs_exã¡_d©a_ªf
 *
dªf
;

88 
båfs_sh¨ed_d©a_ªf
 *
§ef
;

89 
båfs_disk_key
 
key
;

90 
íd
;

91 
±r
;

92 
u32
 
ôem_size
 = 
	`båfs_ôem_size
(
eb
, 
¶Ÿ
);

93 
u64
 
Êags
;

94 
u64
 
off£t
;

95 
ªf_ödex
 = 0;

97 i‡(
	`u∆ikñy
(
ôem_size
 < (*
ei
))) {

98 
	`båfs_îr
(
eb
->
fs_öfo
,

100 
ôem_size
, (*
ei
));

101 
	`båfs_h™dÀ_fs_îr‹
(
eb
->
fs_öfo
, -
EUCLEAN
, 
NULL
);

104 
ei
 = 
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
, 
båfs_exã¡_ôem
);

105 
Êags
 = 
	`båfs_exã¡_Êags
(
eb
, 
ei
);

107 
	`¥_öfo
("\t\textentÑefs %llu gen %llu flags %llu\n",

108 
	`båfs_exã¡_ªfs
(
eb
, 
ei
), 
	`båfs_exã¡_gíî©i⁄
(eb,Éi),

109 
Êags
);

111 i‡((
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
) &&

112 
Êags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

113 
båfs_åì_block_öfo
 *
öfo
;

114 
öfo
 = (
båfs_åì_block_öfo
 *)(
ei
 + 1);

115 
	`båfs_åì_block_key
(
eb
, 
öfo
, &
key
);

116 
	`¥_öfo
("\t\ttree block key (%llu %u %llu)Üevel %d\n",

117 
	`båfs_disk_key_obje˘id
(&
key
), key.
ty≥
,

118 
	`båfs_disk_key_off£t
(&
key
),

119 
	`båfs_åì_block_Àvñ
(
eb
, 
öfo
));

120 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)(
öfo
 + 1);

122 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)(
ei
 + 1);

125 
±r
 = ()
úef
;

126 
íd
 = ()
ei
 + 
ôem_size
;

127 
±r
 < 
íd
) {

128 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)
±r
;

129 
ty≥
 = 
	`båfs_exã¡_ölöe_ªf_ty≥
(
eb
, 
úef
);

130 
off£t
 = 
	`båfs_exã¡_ölöe_ªf_off£t
(
eb
, 
úef
);

131 
	`¥_öfo
("\t\åef#%d: ", 
ªf_ödex
++);

132 
ty≥
) {

133 
BTRFS_TREE_BLOCK_REF_KEY
:

134 
	`¥_c⁄t
("åì block backª‡roŸ %Œu\n", 
off£t
);

136 
BTRFS_SHARED_BLOCK_REF_KEY
:

137 
	`¥_c⁄t
("sh¨ed block backª‡∑ª¡ %Œu\n", 
off£t
);

142 i‡(!
	`IS_ALIGNED
(
off£t
, 
eb
->
fs_öfo
->
£˘‹size
))

143 
	`¥_öfo
(

145 
off£t
, 
eb
->
fs_öfo
->
£˘‹size
);

147 
BTRFS_EXTENT_DATA_REF_KEY
:

148 
dªf
 = (
båfs_exã¡_d©a_ªf
 *)(&
úef
->
off£t
);

149 
	`¥öt_exã¡_d©a_ªf
(
eb
, 
dªf
);

151 
BTRFS_SHARED_DATA_REF_KEY
:

152 
§ef
 = (
båfs_sh¨ed_d©a_ªf
 *)(
úef
 + 1);

153 
	`¥_c⁄t
("shared data backrefÖarent %llu count %u\n",

154 
off£t
, 
	`båfs_sh¨ed_d©a_ªf_cou¡
(
eb
, 
§ef
));

159 i‡(!
	`IS_ALIGNED
(
off£t
, 
eb
->
fs_öfo
->
£˘‹size
))

160 
	`¥_öfo
(

162 
off£t
, 
eb
->
fs_öfo
->
£˘‹size
);

165 
	`¥_c⁄t
("(extent %llu has INVALIDÑefÅype %d)\n",

166 
eb
->
°¨t
, 
ty≥
);

169 
±r
 +
	`båfs_exã¡_ölöe_ªf_size
(
ty≥
);

171 
	`WARN_ON
(
±r
 > 
íd
);

172 
	}
}

174 
	$¥öt_uuid_ôem
(c⁄° 
exã¡_buf„r
 *
l
, 
off£t
,

175 
u32
 
ôem_size
)

177 i‡(!
	`IS_ALIGNED
(
ôem_size
, (
u64
))) {

178 
	`¥_w¨n
("BTRFS: uuid item with illegal size %lu!\n",

179 ()
ôem_size
);

182 
ôem_size
) {

183 
__À64
 
subvﬁ_id
;

185 
	`ªad_exã¡_buf„r
(
l
, &
subvﬁ_id
, 
off£t
, (subvol_id));

186 
	`¥_öfo
("\t\tsubvﬁ_id %Œu\n", 
	`À64_to_˝u
(
subvﬁ_id
));

187 
ôem_size
 -(
u64
);

188 
off£t
 +(
u64
);

190 
	}
}

196 
	$¥öt_eb_ªfs_lock
(c⁄° 
exã¡_buf„r
 *
eb
)

198 #ifde‡
CONFIG_BTRFS_DEBUG


199 
	`båfs_öfo
(
eb
->
fs_öfo
, "refs %uÜock_owner %u current %u",

200 
	`©omic_ªad
(&
eb
->
ªfs
),Éb->
lock_ow√r
, 
cuºít
->
pid
);

202 
	}
}

204 
	$båfs_¥öt_Àaf
(c⁄° 
exã¡_buf„r
 *
l
)

206 
båfs_fs_öfo
 *
fs_öfo
;

207 
i
;

208 
u32
 
ty≥
, 
ƒ
;

209 
båfs_roŸ_ôem
 *
ri
;

210 
båfs_dú_ôem
 *
di
;

211 
båfs_öode_ôem
 *
ii
;

212 
båfs_block_group_ôem
 *
bi
;

213 
båfs_fûe_exã¡_ôem
 *
fi
;

214 
båfs_exã¡_d©a_ªf
 *
dªf
;

215 
båfs_sh¨ed_d©a_ªf
 *
§ef
;

216 
båfs_dev_exã¡
 *
dev_exã¡
;

217 
båfs_key
 
key
;

218 
båfs_key
 
found_key
;

220 i‡(!
l
)

223 
fs_öfo
 = 
l
->fs_info;

224 
ƒ
 = 
	`båfs_hódî_ƒôems
(
l
);

226 
	`båfs_öfo
(
fs_öfo
,

228 
	`båfs_hódî_byãƒ
(
l
), 
	`båfs_hódî_gíî©i⁄
÷), 
ƒ
,

229 
	`båfs_Àaf_‰ì_•a˚
(
l
), 
	`båfs_hódî_ow√r
(l));

230 
	`¥öt_eb_ªfs_lock
(
l
);

231 
i
 = 0 ; i < 
ƒ
 ; i++) {

232 
	`båfs_ôem_key_to_˝u
(
l
, &
key
, 
i
);

233 
ty≥
 = 
key
.type;

234 
	`¥_öfo
("\titem %d key (%llu %u %llu) itemoff %d itemsize %d\n",

235 
i
, 
key
.
obje˘id
, 
ty≥
, key.
off£t
,

236 
	`båfs_ôem_off£t
(
l
, 
i
), 
	`båfs_ôem_size
(l, i));

237 
ty≥
) {

238 
BTRFS_INODE_ITEM_KEY
:

239 
ii
 = 
	`båfs_ôem_±r
(
l
, 
i
, 
båfs_öode_ôem
);

240 
	`¥_öfo
("\t\tinode generation %llu size %llu mode %o\n",

241 
	`båfs_öode_gíî©i⁄
(
l
, 
ii
),

242 
	`båfs_öode_size
(
l
, 
ii
),

243 
	`båfs_öode_mode
(
l
, 
ii
));

245 
BTRFS_DIR_ITEM_KEY
:

246 
di
 = 
	`båfs_ôem_±r
(
l
, 
i
, 
båfs_dú_ôem
);

247 
	`båfs_dú_ôem_key_to_˝u
(
l
, 
di
, &
found_key
);

248 
	`¥_öfo
("\t\tdir oid %llu flags %u\n",

249 
found_key
.
obje˘id
,

250 
	`båfs_dú_Êags
(
l
, 
di
));

252 
BTRFS_ROOT_ITEM_KEY
:

253 
ri
 = 
	`båfs_ôem_±r
(
l
, 
i
, 
båfs_roŸ_ôem
);

254 
	`¥_öfo
("\t\troot data bytenr %lluÑefs %u\n",

255 
	`båfs_disk_roŸ_byãƒ
(
l
, 
ri
),

256 
	`båfs_disk_roŸ_ªfs
(
l
, 
ri
));

258 
BTRFS_EXTENT_ITEM_KEY
:

259 
BTRFS_METADATA_ITEM_KEY
:

260 
	`¥öt_exã¡_ôem
(
l
, 
i
, 
ty≥
);

262 
BTRFS_TREE_BLOCK_REF_KEY
:

263 
	`¥_öfo
("\t\ttree block backref\n");

265 
BTRFS_SHARED_BLOCK_REF_KEY
:

266 
	`¥_öfo
("\t\tshared block backref\n");

268 
BTRFS_EXTENT_DATA_REF_KEY
:

269 
dªf
 = 
	`båfs_ôem_±r
(
l
, 
i
,

270 
båfs_exã¡_d©a_ªf
);

271 
	`¥öt_exã¡_d©a_ªf
(
l
, 
dªf
);

273 
BTRFS_SHARED_DATA_REF_KEY
:

274 
§ef
 = 
	`båfs_ôem_±r
(
l
, 
i
,

275 
båfs_sh¨ed_d©a_ªf
);

276 
	`¥_öfo
("\t\tshared data backref count %u\n",

277 
	`båfs_sh¨ed_d©a_ªf_cou¡
(
l
, 
§ef
));

279 
BTRFS_EXTENT_DATA_KEY
:

280 
fi
 = 
	`båfs_ôem_±r
(
l
, 
i
,

281 
båfs_fûe_exã¡_ôem
);

282 i‡(
	`båfs_fûe_exã¡_ty≥
(
l
, 
fi
) ==

283 
BTRFS_FILE_EXTENT_INLINE
) {

284 
	`¥_öfo
("\t\tinlineÉxtent data size %llu\n",

285 
	`båfs_fûe_exã¡_øm_byãs
(
l
, 
fi
));

288 
	`¥_öfo
("\t\textent data disk bytenr %lluÇr %llu\n",

289 
	`båfs_fûe_exã¡_disk_byãƒ
(
l
, 
fi
),

290 
	`båfs_fûe_exã¡_disk_num_byãs
(
l
, 
fi
));

291 
	`¥_öfo
("\t\textent data offset %lluÇr %lluÑam %llu\n",

292 
	`båfs_fûe_exã¡_off£t
(
l
, 
fi
),

293 
	`båfs_fûe_exã¡_num_byãs
(
l
, 
fi
),

294 
	`båfs_fûe_exã¡_øm_byãs
(
l
, 
fi
));

296 
BTRFS_BLOCK_GROUP_ITEM_KEY
:

297 
bi
 = 
	`båfs_ôem_±r
(
l
, 
i
,

298 
båfs_block_group_ôem
);

299 
	`¥_öfo
(

301 
	`båfs_block_group_u£d
(
l
, 
bi
),

302 
	`båfs_block_group_chunk_obje˘id
(
l
, 
bi
),

303 
	`båfs_block_group_Êags
(
l
, 
bi
));

305 
BTRFS_CHUNK_ITEM_KEY
:

306 
	`¥öt_chunk
(
l
, 
	`båfs_ôem_±r
÷, 
i
,

307 
båfs_chunk
));

309 
BTRFS_DEV_ITEM_KEY
:

310 
	`¥öt_dev_ôem
(
l
, 
	`båfs_ôem_±r
÷, 
i
,

311 
båfs_dev_ôem
));

313 
BTRFS_DEV_EXTENT_KEY
:

314 
dev_exã¡
 = 
	`båfs_ôem_±r
(
l
, 
i
,

315 
båfs_dev_exã¡
);

316 
	`¥_öfo
("\t\tdevÉxtent chunk_tree %llu\n\t\tchunk objectid %llu chunk offset %lluÜength %llu\n",

317 
	`båfs_dev_exã¡_chunk_åì
(
l
, 
dev_exã¡
),

318 
	`båfs_dev_exã¡_chunk_obje˘id
(
l
, 
dev_exã¡
),

319 
	`båfs_dev_exã¡_chunk_off£t
(
l
, 
dev_exã¡
),

320 
	`båfs_dev_exã¡_Àngth
(
l
, 
dev_exã¡
));

322 
BTRFS_PERSISTENT_ITEM_KEY
:

323 
	`¥_öfo
("\t\tpersistent item objectid %llu offset %llu\n",

324 
key
.
obje˘id
, key.
off£t
);

325 
key
.
obje˘id
) {

326 
BTRFS_DEV_STATS_OBJECTID
:

327 
	`¥_öfo
("\t\tdevice stats\n");

330 
	`¥_öfo
("\t\tunknownÖersistent item\n");

333 
BTRFS_TEMPORARY_ITEM_KEY
:

334 
	`¥_öfo
("\t\ttemporary item objectid %llu offset %llu\n",

335 
key
.
obje˘id
, key.
off£t
);

336 
key
.
obje˘id
) {

337 
BTRFS_BALANCE_OBJECTID
:

338 
	`¥_öfo
("\t\tbalance status\n");

341 
	`¥_öfo
("\t\tunknownÅemporary item\n");

344 
BTRFS_DEV_REPLACE_KEY
:

345 
	`¥_öfo
("\t\tdevÑeplace\n");

347 
BTRFS_UUID_KEY_SUBVOL
:

348 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
:

349 
	`¥öt_uuid_ôem
(
l
, 
	`båfs_ôem_±r_off£t
÷, 
i
),

350 
	`båfs_ôem_size
(
l
, 
i
));

354 
	}
}

356 
	$båfs_¥öt_åì
(c⁄° 
exã¡_buf„r
 *
c
, 
boﬁ
 
fﬁlow
)

358 
båfs_fs_öfo
 *
fs_öfo
;

359 
i
; 
u32
 
ƒ
;

360 
båfs_key
 
key
;

361 
Àvñ
;

363 i‡(!
c
)

365 
fs_öfo
 = 
c
->fs_info;

366 
ƒ
 = 
	`båfs_hódî_ƒôems
(
c
);

367 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
c
);

368 i‡(
Àvñ
 == 0) {

369 
	`båfs_¥öt_Àaf
(
c
);

372 
	`båfs_öfo
(
fs_öfo
,

374 
	`båfs_hódî_byãƒ
(
c
), 
Àvñ
, 
	`båfs_hódî_gíî©i⁄
(c),

375 
ƒ
, (
u32
)
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_öfo
) -Çr,

376 
	`båfs_hódî_ow√r
(
c
));

377 
	`¥öt_eb_ªfs_lock
(
c
);

378 
i
 = 0; i < 
ƒ
; i++) {

379 
	`båfs_node_key_to_˝u
(
c
, &
key
, 
i
);

380 
	`¥_öfo
("\tkey %d (%llu %u %llu) block %llu gen %llu\n",

381 
i
, 
key
.
obje˘id
, key.
ty≥
, key.
off£t
,

382 
	`båfs_node_block±r
(
c
, 
i
),

383 
	`båfs_node_±r_gíî©i⁄
(
c
, 
i
));

385 i‡(!
fﬁlow
)

387 
i
 = 0; i < 
ƒ
; i++) {

388 
båfs_åì_∑ª¡_check
 
check
 = {

389 .
Àvñ
 =Üevel - 1,

390 .
å™sid
 = 
	`båfs_node_±r_gíî©i⁄
(
c
, 
i
),

391 .
ow√r_roŸ
 = 
	`båfs_hódî_ow√r
(
c
),

392 .
has_fú°_key
 = 
åue


394 
exã¡_buf„r
 *
√xt
;

396 
	`båfs_node_key_to_˝u
(
c
, &
check
.
fú°_key
, 
i
);

397 
√xt
 = 
	`ªad_åì_block
(
fs_öfo
, 
	`båfs_node_block±r
(
c
, 
i
), &
check
);

398 i‡(
	`IS_ERR
(
√xt
))

400 i‡(!
	`exã¡_buf„r_u±od©e
(
√xt
)) {

401 
	`‰ì_exã¡_buf„r
(
√xt
);

405 i‡(
	`båfs_is_Àaf
(
√xt
) &&

406 
Àvñ
 != 1)

407 
	`BUG
();

408 i‡(
	`båfs_hódî_Àvñ
(
√xt
) !=

409 
Àvñ
 - 1)

410 
	`BUG
();

411 
	`båfs_¥öt_åì
(
√xt
, 
fﬁlow
);

412 
	`‰ì_exã¡_buf„r
(
√xt
);

414 
	}
}

	@print-tree.h

6 #i‚de‡
BTRFS_PRINT_TREE_H


7 
	#BTRFS_PRINT_TREE_H


	)

10 
	#BTRFS_ROOT_NAME_BUF_LEN
 48

	)

12 
båfs_¥öt_Àaf
(c⁄° 
exã¡_buf„r
 *
l
);

13 
båfs_¥öt_åì
(c⁄° 
exã¡_buf„r
 *
c
, 
boﬁ
 
fﬁlow
);

14 c⁄° *
båfs_roŸ_«me
(c⁄° 
båfs_key
 *
key
, *
buf
);

	@props.c

6 
	~<löux/hashèbÀ.h
>

7 
	~"mesßges.h
"

8 
	~"¥›s.h
"

9 
	~"båfs_öode.h
"

10 
	~"å™ß˘i⁄.h
"

11 
	~"˘ªe.h
"

12 
	~"x©å.h
"

13 
	~"com¥essi⁄.h
"

14 
	~"•a˚-öfo.h
"

15 
	~"fs.h
"

16 
	~"ac˚ss‹s.h
"

17 
	~"su≥r.h
"

19 
	#BTRFS_PROP_HANDLERS_HT_BITS
 8

	)

20 
DEFINE_HASHTABLE
(
¥›_h™dÀrs_ht
, 
BTRFS_PROP_HANDLERS_HT_BITS
);

22 
	s¥›_h™dÀr
 {

23 
hli°_node
 
	mnode
;

24 c⁄° *
	mx©å_«me
;

25 (*
	mvÆid©e
)(c⁄° 
båfs_öode
 *
	möode
, c⁄° *
	mvÆue
,

26 
size_t
 
	mÀn
);

27 (*
	m≠∂y
)(
öode
 *
	möode
, c⁄° *
	mvÆue
, 
size_t
 
	mÀn
);

28 c⁄° *(*
	mexåa˘
)(
öode
 *
	möode
);

29 
boﬁ
 (*
ign‹e
)(c⁄° 
båfs_öode
 *
	möode
);

30 
	möhîôabÀ
;

33 c⁄° 
hli°_hód
 *
	$föd_¥›_h™dÀrs_by_hash
(c⁄° 
u64
 
hash
)

35 
hli°_hód
 *
h
;

37 
h
 = &
¥›_h™dÀrs_ht
[
	`hash_mö
(
hash
, 
BTRFS_PROP_HANDLERS_HT_BITS
)];

38 i‡(
	`hli°_em±y
(
h
))

39  
NULL
;

41  
h
;

42 
	}
}

44 c⁄° 
¥›_h™dÀr
 *

45 
	$föd_¥›_h™dÀr
(c⁄° *
«me
,

46 c⁄° 
hli°_hód
 *
h™dÀrs
)

48 
¥›_h™dÀr
 *
h
;

50 i‡(!
h™dÀrs
) {

51 
u64
 
hash
 = 
	`båfs_«me_hash
(
«me
, 
	`°æí
(name));

53 
h™dÀrs
 = 
	`föd_¥›_h™dÀrs_by_hash
(
hash
);

54 i‡(!
h™dÀrs
)

55  
NULL
;

58 
	`hli°_f‹_óch_íåy
(
h
, 
h™dÀrs
, 
node
)

59 i‡(!
	`°rcmp
(
h
->
x©å_«me
, 
«me
))

60  
h
;

62  
NULL
;

63 
	}
}

65 
	$båfs_vÆid©e_¥›
(c⁄° 
båfs_öode
 *
öode
, c⁄° *
«me
,

66 c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
)

68 c⁄° 
¥›_h™dÀr
 *
h™dÀr
;

70 i‡(
	`°æí
(
«me
Ë<
XATTR_BTRFS_PREFIX_LEN
)

71  -
EINVAL
;

73 
h™dÀr
 = 
	`föd_¥›_h™dÀr
(
«me
, 
NULL
);

74 i‡(!
h™dÀr
)

75  -
EINVAL
;

77 i‡(
vÆue_Àn
 == 0)

80  
h™dÀr
->
	`vÆid©e
(
öode
, 
vÆue
, 
vÆue_Àn
);

81 
	}
}

95 
boﬁ
 
	$båfs_ign‹e_¥›
(c⁄° 
båfs_öode
 *
öode
, c⁄° *
«me
)

97 c⁄° 
¥›_h™dÀr
 *
h™dÀr
;

99 
h™dÀr
 = 
	`föd_¥›_h™dÀr
(
«me
, 
NULL
);

100 
	`ASSERT
(
h™dÀr
 !
NULL
);

102  
h™dÀr
->
	`ign‹e
(
öode
);

103 
	}
}

105 
	$båfs_£t_¥›
(
båfs_å™s_h™dÀ
 *
å™s
, 
öode
 *inode,

106 c⁄° *
«me
, c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
,

107 
Êags
)

109 c⁄° 
¥›_h™dÀr
 *
h™dÀr
;

110 
ªt
;

112 
h™dÀr
 = 
	`föd_¥›_h™dÀr
(
«me
, 
NULL
);

113 i‡(!
h™dÀr
)

114  -
EINVAL
;

116 i‡(
vÆue_Àn
 == 0) {

117 
ªt
 = 
	`båfs_£tx©å
(
å™s
, 
öode
, 
h™dÀr
->
x©å_«me
,

118 
NULL
, 0, 
Êags
);

119 i‡(
ªt
)

120  
ªt
;

122 
ªt
 = 
h™dÀr
->
	`≠∂y
(
öode
, 
NULL
, 0);

123 
	`ASSERT
(
ªt
 == 0);

125  
ªt
;

128 
ªt
 = 
	`båfs_£tx©å
(
å™s
, 
öode
, 
h™dÀr
->
x©å_«me
, 
vÆue
,

129 
vÆue_Àn
, 
Êags
);

130 i‡(
ªt
)

131  
ªt
;

132 
ªt
 = 
h™dÀr
->
	`≠∂y
(
öode
, 
vÆue
, 
vÆue_Àn
);

133 i‡(
ªt
) {

134 
	`båfs_£tx©å
(
å™s
, 
öode
, 
h™dÀr
->
x©å_«me
, 
NULL
,

135 0, 
Êags
);

136  
ªt
;

139 
	`£t_bô
(
BTRFS_INODE_HAS_PROPS
, &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
);

142 
	}
}

144 
	$ôî©e_obje˘_¥›s
(
båfs_roŸ
 *
roŸ
,

145 
båfs_∑th
 *
∑th
,

146 
u64
 
obje˘id
,

147 (*
ôî©‹
)(*,

148 c⁄° 
¥›_h™dÀr
 *,

150 
size_t
),

151 *
˘x
)

153 
ªt
;

154 *
«me_buf
 = 
NULL
;

155 *
vÆue_buf
 = 
NULL
;

156 
«me_buf_Àn
 = 0;

157 
vÆue_buf_Àn
 = 0;

160 
båfs_key
 
key
;

161 
båfs_dú_ôem
 *
di
;

162 
exã¡_buf„r
 *
Àaf
;

163 
u32
 
tŸÆ_Àn
, 
cur
, 
this_Àn
;

164 
¶Ÿ
;

165 c⁄° 
hli°_hód
 *
h™dÀrs
;

167 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

168 
Àaf
 = 
∑th
->
nodes
[0];

170 i‡(
¶Ÿ
 >
	`båfs_hódî_ƒôems
(
Àaf
)) {

171 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

172 i‡(
ªt
 < 0)

173 
out
;

174 i‡(
ªt
 > 0)

179 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

180 i‡(
key
.
obje˘id
 != objectid)

182 i‡(
key
.
ty≥
 !
BTRFS_XATTR_ITEM_KEY
)

185 
h™dÀrs
 = 
	`föd_¥›_h™dÀrs_by_hash
(
key
.
off£t
);

186 i‡(!
h™dÀrs
)

187 
√xt_¶Ÿ
;

189 
di
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_dú_ôem
);

190 
cur
 = 0;

191 
tŸÆ_Àn
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

193 
cur
 < 
tŸÆ_Àn
) {

194 
u32
 
«me_Àn
 = 
	`båfs_dú_«me_Àn
(
Àaf
, 
di
);

195 
u32
 
d©a_Àn
 = 
	`båfs_dú_d©a_Àn
(
Àaf
, 
di
);

196 
«me_±r
, 
d©a_±r
;

197 c⁄° 
¥›_h™dÀr
 *
h™dÀr
;

199 
this_Àn
 = (*
di
Ë+ 
«me_Àn
 + 
d©a_Àn
;

200 
«me_±r
 = ()(
di
 + 1);

201 
d©a_±r
 = 
«me_±r
 + 
«me_Àn
;

203 i‡(
«me_Àn
 <
XATTR_BTRFS_PREFIX_LEN
 ||

204 
	`memcmp_exã¡_buf„r
(
Àaf
, 
XATTR_BTRFS_PREFIX
,

205 
«me_±r
,

206 
XATTR_BTRFS_PREFIX_LEN
))

207 
√xt_dú_ôem
;

209 i‡(
«me_Àn
 >
«me_buf_Àn
) {

210 
	`k‰ì
(
«me_buf
);

211 
«me_buf_Àn
 = 
«me_Àn
 + 1;

212 
«me_buf
 = 
	`kmÆloc
(
«me_buf_Àn
, 
GFP_NOFS
);

213 i‡(!
«me_buf
) {

214 
ªt
 = -
ENOMEM
;

215 
out
;

218 
	`ªad_exã¡_buf„r
(
Àaf
, 
«me_buf
, 
«me_±r
, 
«me_Àn
);

219 
«me_buf
[
«me_Àn
] = '\0';

221 
h™dÀr
 = 
	`föd_¥›_h™dÀr
(
«me_buf
, 
h™dÀrs
);

222 i‡(!
h™dÀr
)

223 
√xt_dú_ôem
;

225 i‡(
d©a_Àn
 > 
vÆue_buf_Àn
) {

226 
	`k‰ì
(
vÆue_buf
);

227 
vÆue_buf_Àn
 = 
d©a_Àn
;

228 
vÆue_buf
 = 
	`kmÆloc
(
d©a_Àn
, 
GFP_NOFS
);

229 i‡(!
vÆue_buf
) {

230 
ªt
 = -
ENOMEM
;

231 
out
;

234 
	`ªad_exã¡_buf„r
(
Àaf
, 
vÆue_buf
, 
d©a_±r
, 
d©a_Àn
);

236 
	`ôî©‹
(
˘x
, 
h™dÀr
, 
vÆue_buf
, 
d©a_Àn
);

237 
√xt_dú_ôem
:

238 
cur
 +
this_Àn
;

239 
di
 = (
båfs_dú_ôem
 *)((*Ëdò+ 
this_Àn
);

242 
√xt_¶Ÿ
:

243 
∑th
->
¶Ÿs
[0]++;

246 
ªt
 = 0;

247 
out
:

248 
	`båfs_ªÀa£_∑th
(
∑th
);

249 
	`k‰ì
(
«me_buf
);

250 
	`k‰ì
(
vÆue_buf
);

252  
ªt
;

253 
	}
}

255 
	$öode_¥›_ôî©‹
(*
˘x
,

256 c⁄° 
¥›_h™dÀr
 *
h™dÀr
,

257 c⁄° *
vÆue
,

258 
size_t
 
Àn
)

260 
öode
 *öodê
˘x
;

261 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

262 
ªt
;

264 
ªt
 = 
h™dÀr
->
	`≠∂y
(
öode
, 
vÆue
, 
Àn
);

265 i‡(
	`u∆ikñy
(
ªt
))

266 
	`båfs_w¨n
(
roŸ
->
fs_öfo
,

268 
h™dÀr
->
x©å_«me
, 
	`båfs_öo
(
	`BTRFS_I
(
öode
)),

269 
roŸ
->
roŸ_key
.
obje˘id
, 
ªt
);

271 
	`£t_bô
(
BTRFS_INODE_HAS_PROPS
, &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
);

272 
	}
}

274 
	$båfs_lﬂd_öode_¥›s
(
öode
 *öode, 
båfs_∑th
 *
∑th
)

276 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

277 
u64
 
öo
 = 
	`båfs_öo
(
	`BTRFS_I
(
öode
));

279  
	`ôî©e_obje˘_¥›s
(
roŸ
, 
∑th
, 
öo
, 
öode_¥›_ôî©‹
, 
öode
);

280 
	}
}

282 
	$¥›_com¥essi⁄_vÆid©e
(c⁄° 
båfs_öode
 *
öode
,

283 c⁄° *
vÆue
, 
size_t
 
Àn
)

285 i‡(!
	`båfs_öode_ˇn_com¥ess
(
öode
))

286  -
EINVAL
;

288 i‡(!
vÆue
)

291 i‡(
	`båfs_com¥ess_is_vÆid_ty≥
(
vÆue
, 
Àn
))

294 i‡((
Àn
 =2 && 
	`°∫cmp
("no", 
vÆue
, 2) == 0) ||

295 (
Àn
 =4 && 
	`°∫cmp
("n⁄e", 
vÆue
, 4) == 0))

298  -
EINVAL
;

299 
	}
}

301 
	$¥›_com¥essi⁄_≠∂y
(
öode
 *öode, c⁄° *
vÆue
,

302 
size_t
 
Àn
)

304 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

305 
ty≥
;

308 i‡(
Àn
 == 0) {

309 
	`BTRFS_I
(
öode
)->
Êags
 &~
BTRFS_INODE_COMPRESS
;

310 
	`BTRFS_I
(
öode
)->
Êags
 &~
BTRFS_INODE_NOCOMPRESS
;

311 
	`BTRFS_I
(
öode
)->
¥›_com¥ess
 = 
BTRFS_COMPRESS_NONE
;

316 i‡((
Àn
 =2 && 
	`°∫cmp
("no", 
vÆue
, 2) == 0) ||

317 (
Àn
 =4 && 
	`°∫cmp
("n⁄e", 
vÆue
, 4) == 0)) {

318 
	`BTRFS_I
(
öode
)->
Êags
 |
BTRFS_INODE_NOCOMPRESS
;

319 
	`BTRFS_I
(
öode
)->
Êags
 &~
BTRFS_INODE_COMPRESS
;

320 
	`BTRFS_I
(
öode
)->
¥›_com¥ess
 = 
BTRFS_COMPRESS_NONE
;

325 i‡(!
	`°∫cmp
("lzo", 
vÆue
, 3)) {

326 
ty≥
 = 
BTRFS_COMPRESS_LZO
;

327 
	`båfs_£t_fs_öcom∑t
(
fs_öfo
, 
COMPRESS_LZO
);

328 } i‡(!
	`°∫cmp
("zlib", 
vÆue
, 4)) {

329 
ty≥
 = 
BTRFS_COMPRESS_ZLIB
;

330 } i‡(!
	`°∫cmp
("z°d", 
vÆue
, 4)) {

331 
ty≥
 = 
BTRFS_COMPRESS_ZSTD
;

332 
	`båfs_£t_fs_öcom∑t
(
fs_öfo
, 
COMPRESS_ZSTD
);

334  -
EINVAL
;

337 
	`BTRFS_I
(
öode
)->
Êags
 &~
BTRFS_INODE_NOCOMPRESS
;

338 
	`BTRFS_I
(
öode
)->
Êags
 |
BTRFS_INODE_COMPRESS
;

339 
	`BTRFS_I
(
öode
)->
¥›_com¥ess
 = 
ty≥
;

342 
	}
}

344 
boﬁ
 
	$¥›_com¥essi⁄_ign‹e
(c⁄° 
båfs_öode
 *
öode
)

353 i‡(!
	`S_ISREG
(
öode
->
vfs_öode
.
i_mode
) &&

354 !
	`S_ISDIR
(
öode
->
vfs_öode
.
i_mode
))

355  
åue
;

357  
Ál£
;

358 
	}
}

360 c⁄° *
	$¥›_com¥essi⁄_exåa˘
(
öode
 *inode)

362 
	`BTRFS_I
(
öode
)->
¥›_com¥ess
) {

363 
BTRFS_COMPRESS_ZLIB
:

364 
BTRFS_COMPRESS_LZO
:

365 
BTRFS_COMPRESS_ZSTD
:

366  
	`båfs_com¥ess_ty≥2°r
(
	`BTRFS_I
(
öode
)->
¥›_com¥ess
);

371  
NULL
;

372 
	}
}

374 
¥›_h™dÀr
 
	g¥›_h™dÀrs
[] = {

376 .
x©å_«me
 = 
XATTR_BTRFS_PREFIX
 "compression",

377 .
	gvÆid©e
 = 
¥›_com¥essi⁄_vÆid©e
,

378 .
	g≠∂y
 = 
¥›_com¥essi⁄_≠∂y
,

379 .
	gexåa˘
 = 
¥›_com¥essi⁄_exåa˘
,

380 .
	gign‹e
 = 
¥›_com¥essi⁄_ign‹e
,

381 .
	göhîôabÀ
 = 1

385 
	$båfs_öode_öhîô_¥›s
(
båfs_å™s_h™dÀ
 *
å™s
,

386 
öode
 *öode, öodê*
∑ª¡
)

388 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

389 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

390 
ªt
;

391 
i
;

392 
boﬁ
 
√ed_ª£rve
 = 
Ál£
;

394 i‡(!
	`ã°_bô
(
BTRFS_INODE_HAS_PROPS
,

395 &
	`BTRFS_I
(
∑ª¡
)->
ru¡ime_Êags
))

398 
i
 = 0; i < 
	`ARRAY_SIZE
(
¥›_h™dÀrs
); i++) {

399 c⁄° 
¥›_h™dÀr
 *
h
 = &
¥›_h™dÀrs
[
i
];

400 c⁄° *
vÆue
;

401 
u64
 
num_byãs
 = 0;

403 i‡(!
h
->
öhîôabÀ
)

406 i‡(
h
->
	`ign‹e
(
	`BTRFS_I
(
öode
)))

409 
vÆue
 = 
h
->
	`exåa˘
(
∑ª¡
);

410 i‡(!
vÆue
)

417 
ªt
 = 
h
->
	`vÆid©e
(
	`BTRFS_I
(
öode
), 
vÆue
, 
	`°æí
(value));

418 i‡(
ªt
)

428 i‡(
√ed_ª£rve
) {

429 
num_byãs
 = 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
, 1);

430 
ªt
 = 
	`båfs_block_rsv_add
(
fs_öfo
, 
å™s
->
block_rsv
,

431 
num_byãs
,

432 
BTRFS_RESERVE_NO_FLUSH
);

433 i‡(
ªt
)

434  
ªt
;

437 
ªt
 = 
	`båfs_£tx©å
(
å™s
, 
öode
, 
h
->
x©å_«me
, 
vÆue
,

438 
	`°æí
(
vÆue
), 0);

439 i‡(!
ªt
) {

440 
ªt
 = 
h
->
	`≠∂y
(
öode
, 
vÆue
, 
	`°æí
(value));

441 i‡(
ªt
)

442 
	`båfs_£tx©å
(
å™s
, 
öode
, 
h
->
x©å_«me
,

443 
NULL
, 0, 0);

445 
	`£t_bô
(
BTRFS_INODE_HAS_PROPS
,

446 &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
);

449 i‡(
√ed_ª£rve
) {

450 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, 
å™s
->
block_rsv
,

451 
num_byãs
, 
NULL
);

452 i‡(
ªt
)

453  
ªt
;

455 
√ed_ª£rve
 = 
åue
;

459 
	}
}

461 
__öô
 
	$båfs_¥›s_öô
()

463 
i
;

465 
i
 = 0; i < 
	`ARRAY_SIZE
(
¥›_h™dÀrs
); i++) {

466 
¥›_h™dÀr
 *
p
 = &
¥›_h™dÀrs
[
i
];

467 
u64
 
h
 = 
	`båfs_«me_hash
(
p
->
x©å_«me
, 
	`°æí
(p->xattr_name));

469 
	`hash_add
(
¥›_h™dÀrs_ht
, &
p
->
node
, 
h
);

472 
	}
}

	@props.h

6 #i‚de‡
BTRFS_PROPS_H


7 
	#BTRFS_PROPS_H


	)

9 
	~"˘ªe.h
"

11 
__öô
 
båfs_¥›s_öô
();

13 
båfs_£t_¥›
(
båfs_å™s_h™dÀ
 *
å™s
, 
öode
 *inode,

14 c⁄° *
«me
, c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
,

15 
Êags
);

16 
båfs_vÆid©e_¥›
(c⁄° 
båfs_öode
 *
öode
, c⁄° *
«me
,

17 c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
);

18 
boﬁ
 
båfs_ign‹e_¥›
(c⁄° 
båfs_öode
 *
öode
, c⁄° *
«me
);

20 
båfs_lﬂd_öode_¥›s
(
öode
 *öode, 
båfs_∑th
 *
∑th
);

22 
båfs_öode_öhîô_¥›s
(
båfs_å™s_h™dÀ
 *
å™s
,

23 
öode
 *inode,

24 
öode
 *
dú
);

	@qgroup.c

6 
	~<löux/sched.h
>

7 
	~<löux/∑gem≠.h
>

8 
	~<löux/wrôeback.h
>

9 
	~<löux/blkdev.h
>

10 
	~<löux/rbåì.h
>

11 
	~<löux/¶ab.h
>

12 
	~<löux/w‹kqueue.h
>

13 
	~<löux/båfs.h
>

14 
	~<löux/sched/mm.h
>

16 
	~"˘ªe.h
"

17 
	~"å™ß˘i⁄.h
"

18 
	~"disk-io.h
"

19 
	~"lockög.h
"

20 
	~"uli°.h
"

21 
	~"backªf.h
"

22 
	~"exã¡_io.h
"

23 
	~"qgroup.h
"

24 
	~"block-group.h
"

25 
	~"sysfs.h
"

26 
	~"åì-mod-log.h
"

27 
	~"fs.h
"

28 
	~"ac˚ss‹s.h
"

29 
	~"exã¡-åì.h
"

30 
	~"roŸ-åì.h
"

31 
	~"åì-checkî.h
"

39 
u64
 
	$qgroup_rsv_tŸÆ
(c⁄° 
båfs_qgroup
 *
qgroup
)

41 
u64
 
ªt
 = 0;

42 
i
;

44 
i
 = 0; i < 
BTRFS_QGROUP_RSV_LAST
; i++)

45 
ªt
 +
qgroup
->
rsv
.
vÆues
[
i
];

47  
ªt
;

48 
	}
}

50 #ifde‡
CONFIG_BTRFS_DEBUG


51 c⁄° *
	$qgroup_rsv_ty≥_°r
(
båfs_qgroup_rsv_ty≥
 
ty≥
)

53 i‡(
ty≥
 =
BTRFS_QGROUP_RSV_DATA
)

55 i‡(
ty≥
 =
BTRFS_QGROUP_RSV_META_PERTRANS
)

57 i‡(
ty≥
 =
BTRFS_QGROUP_RSV_META_PREALLOC
)

59  
NULL
;

60 
	}
}

63 
	$qgroup_rsv_add
(
båfs_fs_öfo
 *
fs_öfo
,

64 
båfs_qgroup
 *
qgroup
, 
u64
 
num_byãs
,

65 
båfs_qgroup_rsv_ty≥
 
ty≥
)

67 
	`åa˚_qgroup_upd©e_ª£rve
(
fs_öfo
, 
qgroup
, 
num_byãs
, 
ty≥
);

68 
qgroup
->
rsv
.
vÆues
[
ty≥
] +
num_byãs
;

69 
	}
}

71 
	$qgroup_rsv_ªÀa£
(
båfs_fs_öfo
 *
fs_öfo
,

72 
båfs_qgroup
 *
qgroup
, 
u64
 
num_byãs
,

73 
båfs_qgroup_rsv_ty≥
 
ty≥
)

75 
	`åa˚_qgroup_upd©e_ª£rve
(
fs_öfo
, 
qgroup
, -(
s64
)
num_byãs
, 
ty≥
);

76 i‡(
qgroup
->
rsv
.
vÆues
[
ty≥
] >
num_byãs
) {

77 
qgroup
->
rsv
.
vÆues
[
ty≥
] -
num_byãs
;

80 #ifde‡
CONFIG_BTRFS_DEBUG


81 
	`WARN_RATELIMIT
(1,

83 
qgroup
->
qgroupid
, 
	`qgroup_rsv_ty≥_°r
(
ty≥
),

84 
qgroup
->
rsv
.
vÆues
[
ty≥
], 
num_byãs
);

86 
qgroup
->
rsv
.
vÆues
[
ty≥
] = 0;

87 
	}
}

89 
	$qgroup_rsv_add_by_qgroup
(
båfs_fs_öfo
 *
fs_öfo
,

90 
båfs_qgroup
 *
de°
,

91 
båfs_qgroup
 *
§c
)

93 
i
;

95 
i
 = 0; i < 
BTRFS_QGROUP_RSV_LAST
; i++)

96 
	`qgroup_rsv_add
(
fs_öfo
, 
de°
, 
§c
->
rsv
.
vÆues
[
i
], i);

97 
	}
}

99 
	$qgroup_rsv_ªÀa£_by_qgroup
(
båfs_fs_öfo
 *
fs_öfo
,

100 
båfs_qgroup
 *
de°
,

101 
båfs_qgroup
 *
§c
)

103 
i
;

105 
i
 = 0; i < 
BTRFS_QGROUP_RSV_LAST
; i++)

106 
	`qgroup_rsv_ªÀa£
(
fs_öfo
, 
de°
, 
§c
->
rsv
.
vÆues
[
i
], i);

107 
	}
}

109 
	$båfs_qgroup_upd©e_ﬁd_ªf˙t
(
båfs_qgroup
 *
qg
, 
u64
 
£q
,

110 
mod
)

112 i‡(
qg
->
ﬁd_ªf˙t
 < 
£q
)

113 
qg
->
ﬁd_ªf˙t
 = 
£q
;

114 
qg
->
ﬁd_ªf˙t
 +
mod
;

115 
	}
}

117 
	$båfs_qgroup_upd©e_√w_ªf˙t
(
båfs_qgroup
 *
qg
, 
u64
 
£q
,

118 
mod
)

120 i‡(
qg
->
√w_ªf˙t
 < 
£q
)

121 
qg
->
√w_ªf˙t
 = 
£q
;

122 
qg
->
√w_ªf˙t
 +
mod
;

123 
	}
}

125 
ölöe
 
u64
 
	$båfs_qgroup_gë_ﬁd_ªf˙t
(
båfs_qgroup
 *
qg
, 
u64
 
£q
)

127 i‡(
qg
->
ﬁd_ªf˙t
 < 
£q
)

129  
qg
->
ﬁd_ªf˙t
 - 
£q
;

130 
	}
}

132 
ölöe
 
u64
 
	$båfs_qgroup_gë_√w_ªf˙t
(
båfs_qgroup
 *
qg
, 
u64
 
£q
)

134 i‡(
qg
->
√w_ªf˙t
 < 
£q
)

136  
qg
->
√w_ªf˙t
 - 
£q
;

137 
	}
}

142 
	sbåfs_qgroup_li°
 {

143 
li°_hód
 
	m√xt_group
;

144 
li°_hód
 
	m√xt_membî
;

145 
båfs_qgroup
 *
	mgroup
;

146 
båfs_qgroup
 *
	mmembî
;

149 
ölöe
 
u64
 
	$qgroup_to_aux
(
båfs_qgroup
 *
qg
)

151  (
u64
)(
uöçå_t
)
qg
;

152 
	}
}

154 
ölöe
 
båfs_qgroup
* 
	$unode_aux_to_qgroup
(
uli°_node
 *
n
)

156  (
båfs_qgroup
 *)(
uöçå_t
)
n
->
aux
;

157 
	}
}

160 
qgroup_ªsˇn_öô
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
¥ogªss_obje˘id
,

161 
öô_Êags
);

162 
qgroup_ªsˇn_zîo_åackög
(
båfs_fs_öfo
 *
fs_öfo
);

165 
båfs_qgroup
 *
	$föd_qgroup_rb
(
båfs_fs_öfo
 *
fs_öfo
,

166 
u64
 
qgroupid
)

168 
rb_node
 *
n
 = 
fs_öfo
->
qgroup_åì
.rb_node;

169 
båfs_qgroup
 *
qgroup
;

171 
n
) {

172 
qgroup
 = 
	`rb_íåy
(
n
, 
båfs_qgroup
, 
node
);

173 i‡(
qgroup
->
qgroupid
 < qgroupid)

174 
n
 =Ç->
rb_À·
;

175 i‡(
qgroup
->
qgroupid
 > qgroupid)

176 
n
 =Ç->
rb_right
;

178  
qgroup
;

180  
NULL
;

181 
	}
}

184 
båfs_qgroup
 *
	$add_qgroup_rb
(
båfs_fs_öfo
 *
fs_öfo
,

185 
u64
 
qgroupid
)

187 
rb_node
 **
p
 = &
fs_öfo
->
qgroup_åì
.rb_node;

188 
rb_node
 *
∑ª¡
 = 
NULL
;

189 
båfs_qgroup
 *
qgroup
;

191 *
p
) {

192 
∑ª¡
 = *
p
;

193 
qgroup
 = 
	`rb_íåy
(
∑ª¡
, 
båfs_qgroup
, 
node
);

195 i‡(
qgroup
->
qgroupid
 < qgroupid)

196 
p
 = &(*p)->
rb_À·
;

197 i‡(
qgroup
->
qgroupid
 > qgroupid)

198 
p
 = &(*p)->
rb_right
;

200  
qgroup
;

203 
qgroup
 = 
	`kzÆloc
((*qgroup), 
GFP_ATOMIC
);

204 i‡(!
qgroup
)

205  
	`ERR_PTR
(-
ENOMEM
);

207 
qgroup
->
qgroupid
 = qgroupid;

208 
	`INIT_LIST_HEAD
(&
qgroup
->
groups
);

209 
	`INIT_LIST_HEAD
(&
qgroup
->
membîs
);

210 
	`INIT_LIST_HEAD
(&
qgroup
->
dúty
);

212 
	`rb_lök_node
(&
qgroup
->
node
, 
∑ª¡
, 
p
);

213 
	`rb_ö£π_cﬁ‹
(&
qgroup
->
node
, &
fs_öfo
->
qgroup_åì
);

215  
qgroup
;

216 
	}
}

218 
	$__dñ_qgroup_rb
(
båfs_fs_öfo
 *
fs_öfo
,

219 
båfs_qgroup
 *
qgroup
)

221 
båfs_qgroup_li°
 *
li°
;

223 
	`li°_dñ
(&
qgroup
->
dúty
);

224 !
	`li°_em±y
(&
qgroup
->
groups
)) {

225 
li°
 = 
	`li°_fú°_íåy
(&
qgroup
->
groups
,

226 
båfs_qgroup_li°
, 
√xt_group
);

227 
	`li°_dñ
(&
li°
->
√xt_group
);

228 
	`li°_dñ
(&
li°
->
√xt_membî
);

229 
	`k‰ì
(
li°
);

232 !
	`li°_em±y
(&
qgroup
->
membîs
)) {

233 
li°
 = 
	`li°_fú°_íåy
(&
qgroup
->
membîs
,

234 
båfs_qgroup_li°
, 
√xt_membî
);

235 
	`li°_dñ
(&
li°
->
√xt_group
);

236 
	`li°_dñ
(&
li°
->
√xt_membî
);

237 
	`k‰ì
(
li°
);

239 
	}
}

242 
	$dñ_qgroup_rb
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
qgroupid
)

244 
båfs_qgroup
 *
qgroup
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
qgroupid
);

246 i‡(!
qgroup
)

247  -
ENOENT
;

249 
	`rb_îa£
(&
qgroup
->
node
, &
fs_öfo
->
qgroup_åì
);

250 
	`__dñ_qgroup_rb
(
fs_öfo
, 
qgroup
);

252 
	}
}

263 
	$__add_ªœti⁄_rb
(
båfs_qgroup
 *
membî
, båfs_qgrou∞*
∑ª¡
)

265 
båfs_qgroup_li°
 *
li°
;

267 i‡(!
membî
 || !
∑ª¡
)

268  -
ENOENT
;

270 
li°
 = 
	`kzÆloc
((*li°), 
GFP_ATOMIC
);

271 i‡(!
li°
)

272  -
ENOMEM
;

274 
li°
->
group
 = 
∑ª¡
;

275 
li°
->
membî
 = member;

276 
	`li°_add_èû
(&
li°
->
√xt_group
, &
membî
->
groups
);

277 
	`li°_add_èû
(&
li°
->
√xt_membî
, &
∑ª¡
->
membîs
);

280 
	}
}

291 
	$add_ªœti⁄_rb
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
membîid
, u64 
∑ª¡id
)

293 
båfs_qgroup
 *
membî
;

294 
båfs_qgroup
 *
∑ª¡
;

296 
membî
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
membîid
);

297 
∑ª¡
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
∑ª¡id
);

299  
	`__add_ªœti⁄_rb
(
membî
, 
∑ª¡
);

300 
	}
}

303 
	$dñ_ªœti⁄_rb
(
båfs_fs_öfo
 *
fs_öfo
,

304 
u64
 
membîid
, u64 
∑ª¡id
)

306 
båfs_qgroup
 *
membî
;

307 
båfs_qgroup
 *
∑ª¡
;

308 
båfs_qgroup_li°
 *
li°
;

310 
membî
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
membîid
);

311 
∑ª¡
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
∑ª¡id
);

312 i‡(!
membî
 || !
∑ª¡
)

313  -
ENOENT
;

315 
	`li°_f‹_óch_íåy
(
li°
, &
membî
->
groups
, 
√xt_group
) {

316 i‡(
li°
->
group
 =
∑ª¡
) {

317 
	`li°_dñ
(&
li°
->
√xt_group
);

318 
	`li°_dñ
(&
li°
->
√xt_membî
);

319 
	`k‰ì
(
li°
);

323  -
ENOENT
;

324 
	}
}

326 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


327 
	$båfs_vîify_qgroup_cou¡s
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
qgroupid
,

328 
u64
 
r„r
, u64 
ex˛
)

330 
båfs_qgroup
 *
qgroup
;

332 
qgroup
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
qgroupid
);

333 i‡(!
qgroup
)

334  -
EINVAL
;

335 i‡(
qgroup
->
r„r
 !r„∏|| qgroup->
ex˛
 !=Éxcl)

336  -
EINVAL
;

338 
	}
}

341 
	$qgroup_m¨k_öc⁄si°ít
(
båfs_fs_öfo
 *
fs_öfo
)

343 
fs_öfo
->
qgroup_Êags
 |(
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
 |

344 
BTRFS_QGROUP_RUNTIME_FLAG_CANCEL_RESCAN
 |

345 
BTRFS_QGROUP_RUNTIME_FLAG_NO_ACCOUNTING
);

346 
	}
}

352 
	$båfs_ªad_qgroup_c⁄fig
(
båfs_fs_öfo
 *
fs_öfo
)

354 
båfs_key
 
key
;

355 
båfs_key
 
found_key
;

356 
båfs_roŸ
 *
quŸa_roŸ
 = 
fs_öfo
->quota_root;

357 
båfs_∑th
 *
∑th
 = 
NULL
;

358 
exã¡_buf„r
 *
l
;

359 
¶Ÿ
;

360 
ªt
 = 0;

361 
u64
 
Êags
 = 0;

362 
u64
 
ªsˇn_¥ogªss
 = 0;

364 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
))

367 
fs_öfo
->
qgroup_uli°
 = 
	`uli°_Æloc
(
GFP_KERNEL
);

368 i‡(!
fs_öfo
->
qgroup_uli°
) {

369 
ªt
 = -
ENOMEM
;

370 
out
;

373 
∑th
 = 
	`båfs_Æloc_∑th
();

374 i‡(!
∑th
) {

375 
ªt
 = -
ENOMEM
;

376 
out
;

379 
ªt
 = 
	`båfs_sysfs_add_qgroups
(
fs_öfo
);

380 i‡(
ªt
 < 0)

381 
out
;

383 
fs_öfo
->
qgroup_Êags
 = 0;

388 
key
.
obje˘id
 = 0;

389 
key
.
ty≥
 = 0;

390 
key
.
off£t
 = 0;

391 
ªt
 = 
	`båfs_£¨ch_¶Ÿ_f‹_ªad
(
quŸa_roŸ
, &
key
, 
∑th
, 1, 1);

392 i‡(
ªt
)

393 
out
;

396 
båfs_qgroup
 *
qgroup
;

398 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

399 
l
 = 
∑th
->
nodes
[0];

400 
	`båfs_ôem_key_to_˝u
(
l
, &
found_key
, 
¶Ÿ
);

402 i‡(
found_key
.
ty≥
 =
BTRFS_QGROUP_STATUS_KEY
) {

403 
båfs_qgroup_°©us_ôem
 *
±r
;

405 
±r
 = 
	`båfs_ôem_±r
(
l
, 
¶Ÿ
,

406 
båfs_qgroup_°©us_ôem
);

408 i‡(
	`båfs_qgroup_°©us_vîsi⁄
(
l
, 
±r
) !=

409 
BTRFS_QGROUP_STATUS_VERSION
) {

410 
	`båfs_îr
(
fs_öfo
,

412 
out
;

414 i‡(
	`båfs_qgroup_°©us_gíî©i⁄
(
l
, 
±r
) !=

415 
fs_öfo
->
gíî©i⁄
) {

416 
	`qgroup_m¨k_öc⁄si°ít
(
fs_öfo
);

417 
	`båfs_îr
(
fs_öfo
,

420 
fs_öfo
->
qgroup_Êags
 = 
	`båfs_qgroup_°©us_Êags
(
l
,

421 
±r
);

422 
ªsˇn_¥ogªss
 = 
	`båfs_qgroup_°©us_ªsˇn
(
l
, 
±r
);

423 
√xt1
;

426 i‡(
found_key
.
ty≥
 !
BTRFS_QGROUP_INFO_KEY
 &&

427 
found_key
.
ty≥
 !
BTRFS_QGROUP_LIMIT_KEY
)

428 
√xt1
;

430 
qgroup
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
found_key
.
off£t
);

431 i‡((
qgroup
 && 
found_key
.
ty≥
 =
BTRFS_QGROUP_INFO_KEY
) ||

432 (!
qgroup
 && 
found_key
.
ty≥
 =
BTRFS_QGROUP_LIMIT_KEY
)) {

433 
	`båfs_îr
(
fs_öfo
, "inconsistent qgroup config");

434 
	`qgroup_m¨k_öc⁄si°ít
(
fs_öfo
);

436 i‡(!
qgroup
) {

437 
qgroup
 = 
	`add_qgroup_rb
(
fs_öfo
, 
found_key
.
off£t
);

438 i‡(
	`IS_ERR
(
qgroup
)) {

439 
ªt
 = 
	`PTR_ERR
(
qgroup
);

440 
out
;

443 
ªt
 = 
	`båfs_sysfs_add_⁄e_qgroup
(
fs_öfo
, 
qgroup
);

444 i‡(
ªt
 < 0)

445 
out
;

447 
found_key
.
ty≥
) {

448 
BTRFS_QGROUP_INFO_KEY
: {

449 
båfs_qgroup_öfo_ôem
 *
±r
;

451 
±r
 = 
	`båfs_ôem_±r
(
l
, 
¶Ÿ
,

452 
båfs_qgroup_öfo_ôem
);

453 
qgroup
->
r„r
 = 
	`båfs_qgroup_öfo_r„r
(
l
, 
±r
);

454 
qgroup
->
r„r_cm¥
 = 
	`båfs_qgroup_öfo_r„r_cm¥
(
l
, 
±r
);

455 
qgroup
->
ex˛
 = 
	`båfs_qgroup_öfo_ex˛
(
l
, 
±r
);

456 
qgroup
->
ex˛_cm¥
 = 
	`båfs_qgroup_öfo_ex˛_cm¥
(
l
, 
±r
);

460 
BTRFS_QGROUP_LIMIT_KEY
: {

461 
båfs_qgroup_limô_ôem
 *
±r
;

463 
±r
 = 
	`båfs_ôem_±r
(
l
, 
¶Ÿ
,

464 
båfs_qgroup_limô_ôem
);

465 
qgroup
->
lim_Êags
 = 
	`båfs_qgroup_limô_Êags
(
l
, 
±r
);

466 
qgroup
->
max_r„r
 = 
	`båfs_qgroup_limô_max_r„r
(
l
, 
±r
);

467 
qgroup
->
max_ex˛
 = 
	`båfs_qgroup_limô_max_ex˛
(
l
, 
±r
);

468 
qgroup
->
rsv_r„r
 = 
	`båfs_qgroup_limô_rsv_r„r
(
l
, 
±r
);

469 
qgroup
->
rsv_ex˛
 = 
	`båfs_qgroup_limô_rsv_ex˛
(
l
, 
±r
);

473 
√xt1
:

474 
ªt
 = 
	`båfs_√xt_ôem
(
quŸa_roŸ
, 
∑th
);

475 i‡(
ªt
 < 0)

476 
out
;

477 i‡(
ªt
)

480 
	`båfs_ªÀa£_∑th
(
∑th
);

485 
key
.
obje˘id
 = 0;

486 
key
.
ty≥
 = 
BTRFS_QGROUP_RELATION_KEY
;

487 
key
.
off£t
 = 0;

488 
ªt
 = 
	`båfs_£¨ch_¶Ÿ_f‹_ªad
(
quŸa_roŸ
, &
key
, 
∑th
, 1, 0);

489 i‡(
ªt
)

490 
out
;

492 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

493 
l
 = 
∑th
->
nodes
[0];

494 
	`båfs_ôem_key_to_˝u
(
l
, &
found_key
, 
¶Ÿ
);

496 i‡(
found_key
.
ty≥
 !
BTRFS_QGROUP_RELATION_KEY
)

497 
√xt2
;

499 i‡(
found_key
.
obje˘id
 > found_key.
off£t
) {

502 
√xt2
;

505 
ªt
 = 
	`add_ªœti⁄_rb
(
fs_öfo
, 
found_key
.
obje˘id
,

506 
found_key
.
off£t
);

507 i‡(
ªt
 =-
ENOENT
) {

508 
	`båfs_w¨n
(
fs_öfo
,

510 
found_key
.
obje˘id
, found_key.
off£t
);

511 
ªt
 = 0;

513 i‡(
ªt
)

514 
out
;

515 
√xt2
:

516 
ªt
 = 
	`båfs_√xt_ôem
(
quŸa_roŸ
, 
∑th
);

517 i‡(
ªt
 < 0)

518 
out
;

519 i‡(
ªt
)

522 
out
:

523 
	`båfs_‰ì_∑th
(
∑th
);

524 
fs_öfo
->
qgroup_Êags
 |
Êags
;

525 i‡(!(
fs_öfo
->
qgroup_Êags
 & 
BTRFS_QGROUP_STATUS_FLAG_ON
))

526 
	`˛ór_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
);

527 i‡(
fs_öfo
->
qgroup_Êags
 & 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
 &&

528 
ªt
 >= 0)

529 
ªt
 = 
	`qgroup_ªsˇn_öô
(
fs_öfo
, 
ªsˇn_¥ogªss
, 0);

531 i‡(
ªt
 < 0) {

532 
	`uli°_‰ì
(
fs_öfo
->
qgroup_uli°
);

533 
fs_öfo
->
qgroup_uli°
 = 
NULL
;

534 
fs_öfo
->
qgroup_Êags
 &~
BTRFS_QGROUP_STATUS_FLAG_RESCAN
;

535 
	`båfs_sysfs_dñ_qgroups
(
fs_öfo
);

538  
ªt
 < 0 ?Ñet : 0;

539 
	}
}

548 
boﬁ
 
	$båfs_check_quŸa_Àak
(
båfs_fs_öfo
 *
fs_öfo
)

550 
rb_node
 *
node
;

551 
boﬁ
 
ªt
 = 
Ál£
;

553 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
))

554  
ªt
;

560 
node
 = 
	`rb_fú°
(&
fs_öfo
->
qgroup_åì
);Çode;Çodê
	`rb_√xt
(node)) {

561 
båfs_qgroup
 *
qgroup
;

562 
i
;

564 
qgroup
 = 
	`rb_íåy
(
node
, 
båfs_qgroup
,Çode);

565 
i
 = 0; i < 
BTRFS_QGROUP_RSV_LAST
; i++) {

566 i‡(
qgroup
->
rsv
.
vÆues
[
i
]) {

567 
ªt
 = 
åue
;

568 
	`båfs_w¨n
(
fs_öfo
,

570 
	`båfs_qgroup_Àvñ
(
qgroup
->
qgroupid
),

571 
	`båfs_qgroup_subvﬁid
(
qgroup
->
qgroupid
),

572 
i
, 
qgroup
->
rsv
.
vÆues
[i]);

576  
ªt
;

577 
	}
}

585 
	$båfs_‰ì_qgroup_c⁄fig
(
båfs_fs_öfo
 *
fs_öfo
)

587 
rb_node
 *
n
;

588 
båfs_qgroup
 *
qgroup
;

590 (
n
 = 
	`rb_fú°
(&
fs_öfo
->
qgroup_åì
))) {

591 
qgroup
 = 
	`rb_íåy
(
n
, 
båfs_qgroup
, 
node
);

592 
	`rb_îa£
(
n
, &
fs_öfo
->
qgroup_åì
);

593 
	`__dñ_qgroup_rb
(
fs_öfo
, 
qgroup
);

594 
	`båfs_sysfs_dñ_⁄e_qgroup
(
fs_öfo
, 
qgroup
);

595 
	`k‰ì
(
qgroup
);

602 
	`uli°_‰ì
(
fs_öfo
->
qgroup_uli°
);

603 
fs_öfo
->
qgroup_uli°
 = 
NULL
;

604 
	`båfs_sysfs_dñ_qgroups
(
fs_öfo
);

605 
	}
}

607 
	$add_qgroup_ªœti⁄_ôem
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
§c
,

608 
u64
 
d°
)

610 
ªt
;

611 
båfs_roŸ
 *
quŸa_roŸ
 = 
å™s
->
fs_öfo
->quota_root;

612 
båfs_∑th
 *
∑th
;

613 
båfs_key
 
key
;

615 
∑th
 = 
	`båfs_Æloc_∑th
();

616 i‡(!
∑th
)

617  -
ENOMEM
;

619 
key
.
obje˘id
 = 
§c
;

620 
key
.
ty≥
 = 
BTRFS_QGROUP_RELATION_KEY
;

621 
key
.
off£t
 = 
d°
;

623 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
quŸa_roŸ
, 
∑th
, &
key
, 0);

625 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑th
->
nodes
[0]);

627 
	`båfs_‰ì_∑th
(
∑th
);

628  
ªt
;

629 
	}
}

631 
	$dñ_qgroup_ªœti⁄_ôem
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
§c
,

632 
u64
 
d°
)

634 
ªt
;

635 
båfs_roŸ
 *
quŸa_roŸ
 = 
å™s
->
fs_öfo
->quota_root;

636 
båfs_∑th
 *
∑th
;

637 
båfs_key
 
key
;

639 
∑th
 = 
	`båfs_Æloc_∑th
();

640 i‡(!
∑th
)

641  -
ENOMEM
;

643 
key
.
obje˘id
 = 
§c
;

644 
key
.
ty≥
 = 
BTRFS_QGROUP_RELATION_KEY
;

645 
key
.
off£t
 = 
d°
;

647 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
quŸa_roŸ
, &
key
, 
∑th
, -1, 1);

648 i‡(
ªt
 < 0)

649 
out
;

651 i‡(
ªt
 > 0) {

652 
ªt
 = -
ENOENT
;

653 
out
;

656 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
quŸa_roŸ
, 
∑th
);

657 
out
:

658 
	`båfs_‰ì_∑th
(
∑th
);

659  
ªt
;

660 
	}
}

662 
	$add_qgroup_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

663 
båfs_roŸ
 *
quŸa_roŸ
, 
u64
 
qgroupid
)

665 
ªt
;

666 
båfs_∑th
 *
∑th
;

667 
båfs_qgroup_öfo_ôem
 *
qgroup_öfo
;

668 
båfs_qgroup_limô_ôem
 *
qgroup_limô
;

669 
exã¡_buf„r
 *
Àaf
;

670 
båfs_key
 
key
;

672 i‡(
	`båfs_is_ã°ög
(
quŸa_roŸ
->
fs_öfo
))

675 
∑th
 = 
	`båfs_Æloc_∑th
();

676 i‡(!
∑th
)

677  -
ENOMEM
;

679 
key
.
obje˘id
 = 0;

680 
key
.
ty≥
 = 
BTRFS_QGROUP_INFO_KEY
;

681 
key
.
off£t
 = 
qgroupid
;

689 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
quŸa_roŸ
, 
∑th
, &
key
,

690 (*
qgroup_öfo
));

691 i‡(
ªt
 &&Ñë !-
EEXIST
)

692 
out
;

694 
Àaf
 = 
∑th
->
nodes
[0];

695 
qgroup_öfo
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

696 
båfs_qgroup_öfo_ôem
);

697 
	`båfs_£t_qgroup_öfo_gíî©i⁄
(
Àaf
, 
qgroup_öfo
, 
å™s
->
å™sid
);

698 
	`båfs_£t_qgroup_öfo_r„r
(
Àaf
, 
qgroup_öfo
, 0);

699 
	`båfs_£t_qgroup_öfo_r„r_cm¥
(
Àaf
, 
qgroup_öfo
, 0);

700 
	`båfs_£t_qgroup_öfo_ex˛
(
Àaf
, 
qgroup_öfo
, 0);

701 
	`båfs_£t_qgroup_öfo_ex˛_cm¥
(
Àaf
, 
qgroup_öfo
, 0);

703 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

705 
	`båfs_ªÀa£_∑th
(
∑th
);

707 
key
.
ty≥
 = 
BTRFS_QGROUP_LIMIT_KEY
;

708 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
quŸa_roŸ
, 
∑th
, &
key
,

709 (*
qgroup_limô
));

710 i‡(
ªt
 &&Ñë !-
EEXIST
)

711 
out
;

713 
Àaf
 = 
∑th
->
nodes
[0];

714 
qgroup_limô
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

715 
båfs_qgroup_limô_ôem
);

716 
	`båfs_£t_qgroup_limô_Êags
(
Àaf
, 
qgroup_limô
, 0);

717 
	`båfs_£t_qgroup_limô_max_r„r
(
Àaf
, 
qgroup_limô
, 0);

718 
	`båfs_£t_qgroup_limô_max_ex˛
(
Àaf
, 
qgroup_limô
, 0);

719 
	`båfs_£t_qgroup_limô_rsv_r„r
(
Àaf
, 
qgroup_limô
, 0);

720 
	`båfs_£t_qgroup_limô_rsv_ex˛
(
Àaf
, 
qgroup_limô
, 0);

722 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

724 
ªt
 = 0;

725 
out
:

726 
	`båfs_‰ì_∑th
(
∑th
);

727  
ªt
;

728 
	}
}

730 
	$dñ_qgroup_ôem
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
qgroupid
)

732 
ªt
;

733 
båfs_roŸ
 *
quŸa_roŸ
 = 
å™s
->
fs_öfo
->quota_root;

734 
båfs_∑th
 *
∑th
;

735 
båfs_key
 
key
;

737 
∑th
 = 
	`båfs_Æloc_∑th
();

738 i‡(!
∑th
)

739  -
ENOMEM
;

741 
key
.
obje˘id
 = 0;

742 
key
.
ty≥
 = 
BTRFS_QGROUP_INFO_KEY
;

743 
key
.
off£t
 = 
qgroupid
;

744 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
quŸa_roŸ
, &
key
, 
∑th
, -1, 1);

745 i‡(
ªt
 < 0)

746 
out
;

748 i‡(
ªt
 > 0) {

749 
ªt
 = -
ENOENT
;

750 
out
;

753 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
quŸa_roŸ
, 
∑th
);

754 i‡(
ªt
)

755 
out
;

757 
	`båfs_ªÀa£_∑th
(
∑th
);

759 
key
.
ty≥
 = 
BTRFS_QGROUP_LIMIT_KEY
;

760 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
quŸa_roŸ
, &
key
, 
∑th
, -1, 1);

761 i‡(
ªt
 < 0)

762 
out
;

764 i‡(
ªt
 > 0) {

765 
ªt
 = -
ENOENT
;

766 
out
;

769 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
quŸa_roŸ
, 
∑th
);

771 
out
:

772 
	`båfs_‰ì_∑th
(
∑th
);

773  
ªt
;

774 
	}
}

776 
	$upd©e_qgroup_limô_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

777 
båfs_qgroup
 *
qgroup
)

779 
båfs_roŸ
 *
quŸa_roŸ
 = 
å™s
->
fs_öfo
->quota_root;

780 
båfs_∑th
 *
∑th
;

781 
båfs_key
 
key
;

782 
exã¡_buf„r
 *
l
;

783 
båfs_qgroup_limô_ôem
 *
qgroup_limô
;

784 
ªt
;

785 
¶Ÿ
;

787 
key
.
obje˘id
 = 0;

788 
key
.
ty≥
 = 
BTRFS_QGROUP_LIMIT_KEY
;

789 
key
.
off£t
 = 
qgroup
->
qgroupid
;

791 
∑th
 = 
	`båfs_Æloc_∑th
();

792 i‡(!
∑th
)

793  -
ENOMEM
;

795 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
quŸa_roŸ
, &
key
, 
∑th
, 0, 1);

796 i‡(
ªt
 > 0)

797 
ªt
 = -
ENOENT
;

799 i‡(
ªt
)

800 
out
;

802 
l
 = 
∑th
->
nodes
[0];

803 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

804 
qgroup_limô
 = 
	`båfs_ôem_±r
(
l
, 
¶Ÿ
, 
båfs_qgroup_limô_ôem
);

805 
	`båfs_£t_qgroup_limô_Êags
(
l
, 
qgroup_limô
, 
qgroup
->
lim_Êags
);

806 
	`båfs_£t_qgroup_limô_max_r„r
(
l
, 
qgroup_limô
, 
qgroup
->
max_r„r
);

807 
	`båfs_£t_qgroup_limô_max_ex˛
(
l
, 
qgroup_limô
, 
qgroup
->
max_ex˛
);

808 
	`båfs_£t_qgroup_limô_rsv_r„r
(
l
, 
qgroup_limô
, 
qgroup
->
rsv_r„r
);

809 
	`båfs_£t_qgroup_limô_rsv_ex˛
(
l
, 
qgroup_limô
, 
qgroup
->
rsv_ex˛
);

811 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
l
);

813 
out
:

814 
	`båfs_‰ì_∑th
(
∑th
);

815  
ªt
;

816 
	}
}

818 
	$upd©e_qgroup_öfo_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

819 
båfs_qgroup
 *
qgroup
)

821 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

822 
båfs_roŸ
 *
quŸa_roŸ
 = 
fs_öfo
->quota_root;

823 
båfs_∑th
 *
∑th
;

824 
båfs_key
 
key
;

825 
exã¡_buf„r
 *
l
;

826 
båfs_qgroup_öfo_ôem
 *
qgroup_öfo
;

827 
ªt
;

828 
¶Ÿ
;

830 i‡(
	`båfs_is_ã°ög
(
fs_öfo
))

833 
key
.
obje˘id
 = 0;

834 
key
.
ty≥
 = 
BTRFS_QGROUP_INFO_KEY
;

835 
key
.
off£t
 = 
qgroup
->
qgroupid
;

837 
∑th
 = 
	`båfs_Æloc_∑th
();

838 i‡(!
∑th
)

839  -
ENOMEM
;

841 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
quŸa_roŸ
, &
key
, 
∑th
, 0, 1);

842 i‡(
ªt
 > 0)

843 
ªt
 = -
ENOENT
;

845 i‡(
ªt
)

846 
out
;

848 
l
 = 
∑th
->
nodes
[0];

849 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

850 
qgroup_öfo
 = 
	`båfs_ôem_±r
(
l
, 
¶Ÿ
, 
båfs_qgroup_öfo_ôem
);

851 
	`båfs_£t_qgroup_öfo_gíî©i⁄
(
l
, 
qgroup_öfo
, 
å™s
->
å™sid
);

852 
	`båfs_£t_qgroup_öfo_r„r
(
l
, 
qgroup_öfo
, 
qgroup
->
r„r
);

853 
	`båfs_£t_qgroup_öfo_r„r_cm¥
(
l
, 
qgroup_öfo
, 
qgroup
->
r„r_cm¥
);

854 
	`båfs_£t_qgroup_öfo_ex˛
(
l
, 
qgroup_öfo
, 
qgroup
->
ex˛
);

855 
	`båfs_£t_qgroup_öfo_ex˛_cm¥
(
l
, 
qgroup_öfo
, 
qgroup
->
ex˛_cm¥
);

857 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
l
);

859 
out
:

860 
	`båfs_‰ì_∑th
(
∑th
);

861  
ªt
;

862 
	}
}

864 
	$upd©e_qgroup_°©us_ôem
(
båfs_å™s_h™dÀ
 *
å™s
)

866 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

867 
båfs_roŸ
 *
quŸa_roŸ
 = 
fs_öfo
->quota_root;

868 
båfs_∑th
 *
∑th
;

869 
båfs_key
 
key
;

870 
exã¡_buf„r
 *
l
;

871 
båfs_qgroup_°©us_ôem
 *
±r
;

872 
ªt
;

873 
¶Ÿ
;

875 
key
.
obje˘id
 = 0;

876 
key
.
ty≥
 = 
BTRFS_QGROUP_STATUS_KEY
;

877 
key
.
off£t
 = 0;

879 
∑th
 = 
	`båfs_Æloc_∑th
();

880 i‡(!
∑th
)

881  -
ENOMEM
;

883 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
quŸa_roŸ
, &
key
, 
∑th
, 0, 1);

884 i‡(
ªt
 > 0)

885 
ªt
 = -
ENOENT
;

887 i‡(
ªt
)

888 
out
;

890 
l
 = 
∑th
->
nodes
[0];

891 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

892 
±r
 = 
	`båfs_ôem_±r
(
l
, 
¶Ÿ
, 
båfs_qgroup_°©us_ôem
);

893 
	`båfs_£t_qgroup_°©us_Êags
(
l
, 
±r
, 
fs_öfo
->
qgroup_Êags
 &

894 
BTRFS_QGROUP_STATUS_FLAGS_MASK
);

895 
	`båfs_£t_qgroup_°©us_gíî©i⁄
(
l
, 
±r
, 
å™s
->
å™sid
);

896 
	`båfs_£t_qgroup_°©us_ªsˇn
(
l
, 
±r
,

897 
fs_öfo
->
qgroup_ªsˇn_¥ogªss
.
obje˘id
);

899 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
l
);

901 
out
:

902 
	`båfs_‰ì_∑th
(
∑th
);

903  
ªt
;

904 
	}
}

909 
	$båfs_˛ón_quŸa_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

910 
båfs_roŸ
 *
roŸ
)

912 
båfs_∑th
 *
∑th
;

913 
båfs_key
 
key
;

914 
exã¡_buf„r
 *
Àaf
 = 
NULL
;

915 
ªt
;

916 
ƒ
 = 0;

918 
∑th
 = 
	`båfs_Æloc_∑th
();

919 i‡(!
∑th
)

920  -
ENOMEM
;

922 
key
.
obje˘id
 = 0;

923 
key
.
off£t
 = 0;

924 
key
.
ty≥
 = 0;

927 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

928 i‡(
ªt
 < 0)

929 
out
;

930 
Àaf
 = 
∑th
->
nodes
[0];

931 
ƒ
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

932 i‡(!
ƒ
)

939 
∑th
->
¶Ÿs
[0] = 0;

940 
ªt
 = 
	`båfs_dñ_ôems
(
å™s
, 
roŸ
, 
∑th
, 0, 
ƒ
);

941 i‡(
ªt
)

942 
out
;

944 
	`båfs_ªÀa£_∑th
(
∑th
);

946 
ªt
 = 0;

947 
out
:

948 
	`båfs_‰ì_∑th
(
∑th
);

949  
ªt
;

950 
	}
}

952 
	$båfs_quŸa_íabÀ
(
båfs_fs_öfo
 *
fs_öfo
)

954 
båfs_roŸ
 *
quŸa_roŸ
;

955 
båfs_roŸ
 *
åì_roŸ
 = 
fs_öfo
->tree_root;

956 
båfs_∑th
 *
∑th
 = 
NULL
;

957 
båfs_qgroup_°©us_ôem
 *
±r
;

958 
exã¡_buf„r
 *
Àaf
;

959 
båfs_key
 
key
;

960 
båfs_key
 
found_key
;

961 
båfs_qgroup
 *
qgroup
 = 
NULL
;

962 
båfs_å™s_h™dÀ
 *
å™s
 = 
NULL
;

963 
uli°
 *uli° = 
NULL
;

964 
ªt
 = 0;

965 
¶Ÿ
;

973 
	`lockdï_as£π_hñd_wrôe
(&
fs_öfo
->
subvﬁ_£m
);

975 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
EXTENT_TREE_V2
)) {

976 
	`båfs_îr
(
fs_öfo
,

978  -
EINVAL
;

981 
	`muãx_lock
(&
fs_öfo
->
qgroup_io˘l_lock
);

982 i‡(
fs_öfo
->
quŸa_roŸ
)

983 
out
;

985 
uli°
 = 
	`uli°_Æloc
(
GFP_KERNEL
);

986 i‡(!
uli°
) {

987 
ªt
 = -
ENOMEM
;

988 
out
;

991 
ªt
 = 
	`båfs_sysfs_add_qgroups
(
fs_öfo
);

992 i‡(
ªt
 < 0)

993 
out
;

1008 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1018 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
åì_roŸ
, 2);

1020 
	`muãx_lock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1021 i‡(
	`IS_ERR
(
å™s
)) {

1022 
ªt
 = 
	`PTR_ERR
(
å™s
);

1023 
å™s
 = 
NULL
;

1024 
out
;

1027 i‡(
fs_öfo
->
quŸa_roŸ
)

1028 
out
;

1030 
fs_öfo
->
qgroup_uli°
 = 
uli°
;

1031 
uli°
 = 
NULL
;

1036 
quŸa_roŸ
 = 
	`båfs_¸óã_åì
(
å™s
, 
BTRFS_QUOTA_TREE_OBJECTID
);

1037 i‡(
	`IS_ERR
(
quŸa_roŸ
)) {

1038 
ªt
 = 
	`PTR_ERR
(
quŸa_roŸ
);

1039 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1040 
out
;

1043 
∑th
 = 
	`båfs_Æloc_∑th
();

1044 i‡(!
∑th
) {

1045 
ªt
 = -
ENOMEM
;

1046 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1047 
out_‰ì_roŸ
;

1050 
key
.
obje˘id
 = 0;

1051 
key
.
ty≥
 = 
BTRFS_QGROUP_STATUS_KEY
;

1052 
key
.
off£t
 = 0;

1054 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
quŸa_roŸ
, 
∑th
, &
key
,

1055 (*
±r
));

1056 i‡(
ªt
) {

1057 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1058 
out_‰ì_∑th
;

1061 
Àaf
 = 
∑th
->
nodes
[0];

1062 
±r
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

1063 
båfs_qgroup_°©us_ôem
);

1064 
	`båfs_£t_qgroup_°©us_gíî©i⁄
(
Àaf
, 
±r
, 
å™s
->
å™sid
);

1065 
	`båfs_£t_qgroup_°©us_vîsi⁄
(
Àaf
, 
±r
, 
BTRFS_QGROUP_STATUS_VERSION
);

1066 
fs_öfo
->
qgroup_Êags
 = 
BTRFS_QGROUP_STATUS_FLAG_ON
 |

1067 
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

1068 
	`båfs_£t_qgroup_°©us_Êags
(
Àaf
, 
±r
, 
fs_öfo
->
qgroup_Êags
 &

1069 
BTRFS_QGROUP_STATUS_FLAGS_MASK
);

1070 
	`båfs_£t_qgroup_°©us_ªsˇn
(
Àaf
, 
±r
, 0);

1072 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

1074 
key
.
obje˘id
 = 0;

1075 
key
.
ty≥
 = 
BTRFS_ROOT_REF_KEY
;

1076 
key
.
off£t
 = 0;

1078 
	`båfs_ªÀa£_∑th
(
∑th
);

1079 
ªt
 = 
	`båfs_£¨ch_¶Ÿ_f‹_ªad
(
åì_roŸ
, &
key
, 
∑th
, 1, 0);

1080 i‡(
ªt
 > 0)

1081 
out_add_roŸ
;

1082 i‡(
ªt
 < 0) {

1083 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1084 
out_‰ì_∑th
;

1088 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

1089 
Àaf
 = 
∑th
->
nodes
[0];

1090 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
¶Ÿ
);

1092 i‡(
found_key
.
ty≥
 =
BTRFS_ROOT_REF_KEY
) {

1095 
	`båfs_ªÀa£_∑th
(
∑th
);

1097 
ªt
 = 
	`add_qgroup_ôem
(
å™s
, 
quŸa_roŸ
,

1098 
found_key
.
off£t
);

1099 i‡(
ªt
) {

1100 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1101 
out_‰ì_∑th
;

1104 
qgroup
 = 
	`add_qgroup_rb
(
fs_öfo
, 
found_key
.
off£t
);

1105 i‡(
	`IS_ERR
(
qgroup
)) {

1106 
ªt
 = 
	`PTR_ERR
(
qgroup
);

1107 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1108 
out_‰ì_∑th
;

1110 
ªt
 = 
	`båfs_sysfs_add_⁄e_qgroup
(
fs_öfo
, 
qgroup
);

1111 i‡(
ªt
 < 0) {

1112 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1113 
out_‰ì_∑th
;

1115 
ªt
 = 
	`båfs_£¨ch_¶Ÿ_f‹_ªad
(
åì_roŸ
, &
found_key
,

1116 
∑th
, 1, 0);

1117 i‡(
ªt
 < 0) {

1118 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1119 
out_‰ì_∑th
;

1121 i‡(
ªt
 > 0) {

1130 
ªt
 = 
	`båfs_√xt_ôem
(
åì_roŸ
, 
∑th
);

1131 i‡(
ªt
 < 0) {

1132 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1133 
out_‰ì_∑th
;

1135 i‡(
ªt
)

1139 
out_add_roŸ
:

1140 
	`båfs_ªÀa£_∑th
(
∑th
);

1141 
ªt
 = 
	`add_qgroup_ôem
(
å™s
, 
quŸa_roŸ
, 
BTRFS_FS_TREE_OBJECTID
);

1142 i‡(
ªt
) {

1143 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1144 
out_‰ì_∑th
;

1147 
qgroup
 = 
	`add_qgroup_rb
(
fs_öfo
, 
BTRFS_FS_TREE_OBJECTID
);

1148 i‡(
	`IS_ERR
(
qgroup
)) {

1149 
ªt
 = 
	`PTR_ERR
(
qgroup
);

1150 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1151 
out_‰ì_∑th
;

1153 
ªt
 = 
	`båfs_sysfs_add_⁄e_qgroup
(
fs_öfo
, 
qgroup
);

1154 i‡(
ªt
 < 0) {

1155 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1156 
out_‰ì_∑th
;

1159 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1169 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

1170 
å™s
 = 
NULL
;

1171 
	`muãx_lock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1172 i‡(
ªt
)

1173 
out_‰ì_∑th
;

1180 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

1181 
fs_öfo
->
quŸa_roŸ
 = quota_root;

1182 
	`£t_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
);

1183 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

1185 
ªt
 = 
	`qgroup_ªsˇn_öô
(
fs_öfo
, 0, 1);

1186 i‡(!
ªt
) {

1187 
	`qgroup_ªsˇn_zîo_åackög
(
fs_öfo
);

1188 
fs_öfo
->
qgroup_ªsˇn_ru¬ög
 = 
åue
;

1189 
	`båfs_queue_w‹k
(
fs_öfo
->
qgroup_ªsˇn_w‹kîs
,

1190 &
fs_öfo
->
qgroup_ªsˇn_w‹k
);

1204 
	`ASSERT
(
ªt
 =-
EINPROGRESS
);

1205 
ªt
 = 0;

1208 
out_‰ì_∑th
:

1209 
	`båfs_‰ì_∑th
(
∑th
);

1210 
out_‰ì_roŸ
:

1211 i‡(
ªt
)

1212 
	`båfs_put_roŸ
(
quŸa_roŸ
);

1213 
out
:

1214 i‡(
ªt
) {

1215 
	`uli°_‰ì
(
fs_öfo
->
qgroup_uli°
);

1216 
fs_öfo
->
qgroup_uli°
 = 
NULL
;

1217 
	`båfs_sysfs_dñ_qgroups
(
fs_öfo
);

1219 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1220 i‡(
ªt
 && 
å™s
)

1221 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1222 i‡(
å™s
)

1223 
ªt
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1224 
	`uli°_‰ì
(
uli°
);

1225  
ªt
;

1226 
	}
}

1228 
	$båfs_quŸa_dißbÀ
(
båfs_fs_öfo
 *
fs_öfo
)

1230 
båfs_roŸ
 *
quŸa_roŸ
;

1231 
båfs_å™s_h™dÀ
 *
å™s
 = 
NULL
;

1232 
ªt
 = 0;

1238 
	`lockdï_as£π_hñd_wrôe
(&
fs_öfo
->
subvﬁ_£m
);

1250 
	`muãx_lock
(&
fs_öfo
->
˛ó√r_muãx
);

1252 
	`muãx_lock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1253 i‡(!
fs_öfo
->
quŸa_roŸ
)

1254 
out
;

1262 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1269 
	`˛ór_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
);

1270 
	`båfs_qgroup_waô_f‹_com∂ëi⁄
(
fs_öfo
, 
Ál£
);

1281 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
fs_öfo
->
åì_roŸ
, 1);

1283 
	`muãx_lock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1284 i‡(
	`IS_ERR
(
å™s
)) {

1285 
ªt
 = 
	`PTR_ERR
(
å™s
);

1286 
å™s
 = 
NULL
;

1287 
	`£t_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
);

1288 
out
;

1291 i‡(!
fs_öfo
->
quŸa_roŸ
)

1292 
out
;

1294 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

1295 
quŸa_roŸ
 = 
fs_öfo
->quota_root;

1296 
fs_öfo
->
quŸa_roŸ
 = 
NULL
;

1297 
fs_öfo
->
qgroup_Êags
 &~
BTRFS_QGROUP_STATUS_FLAG_ON
;

1298 
fs_öfo
->
qgroup_dr›_subåì_thªs
 = 
BTRFS_MAX_LEVEL
;

1299 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

1301 
	`båfs_‰ì_qgroup_c⁄fig
(
fs_öfo
);

1303 
ªt
 = 
	`båfs_˛ón_quŸa_åì
(
å™s
, 
quŸa_roŸ
);

1304 i‡(
ªt
) {

1305 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1306 
out
;

1309 
ªt
 = 
	`båfs_dñ_roŸ
(
å™s
, &
quŸa_roŸ
->
roŸ_key
);

1310 i‡(
ªt
) {

1311 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1312 
out
;

1315 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

1316 
	`li°_dñ
(&
quŸa_roŸ
->
dúty_li°
);

1317 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

1319 
	`båfs_åì_lock
(
quŸa_roŸ
->
node
);

1320 
	`båfs_˛ór_buf„r_dúty
(
å™s
, 
quŸa_roŸ
->
node
);

1321 
	`båfs_åì_u∆ock
(
quŸa_roŸ
->
node
);

1322 
	`båfs_‰ì_åì_block
(
å™s
, 
	`båfs_roŸ_id
(
quŸa_roŸ
),

1323 
quŸa_roŸ
->
node
, 0, 1);

1325 
	`båfs_put_roŸ
(
quŸa_roŸ
);

1327 
out
:

1328 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1329 i‡(
ªt
 && 
å™s
)

1330 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1331 i‡(
å™s
)

1332 
ªt
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1333 
	`muãx_u∆ock
(&
fs_öfo
->
˛ó√r_muãx
);

1335  
ªt
;

1336 
	}
}

1338 
	$qgroup_dúty
(
båfs_fs_öfo
 *
fs_öfo
,

1339 
båfs_qgroup
 *
qgroup
)

1341 i‡(
	`li°_em±y
(&
qgroup
->
dúty
))

1342 
	`li°_add
(&
qgroup
->
dúty
, &
fs_öfo
->
dúty_qgroups
);

1343 
	}
}

1359 
	$__qgroup_ex˛_accou¡ög
(
båfs_fs_öfo
 *
fs_öfo
,

1360 
uli°
 *
tmp
, 
u64
 
ªf_roŸ
,

1361 
båfs_qgroup
 *
§c
, 
sign
)

1363 
båfs_qgroup
 *
qgroup
;

1364 
båfs_qgroup_li°
 *
gli°
;

1365 
uli°_node
 *
unode
;

1366 
uli°_ôî©‹
 
uôî
;

1367 
u64
 
num_byãs
 = 
§c
->
ex˛
;

1368 
ªt
 = 0;

1370 
qgroup
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
ªf_roŸ
);

1371 i‡(!
qgroup
)

1372 
out
;

1374 
qgroup
->
r„r
 +
sign
 * 
num_byãs
;

1375 
qgroup
->
r„r_cm¥
 +
sign
 * 
num_byãs
;

1377 
	`WARN_ON
(
sign
 < 0 && 
qgroup
->
ex˛
 < 
num_byãs
);

1378 
qgroup
->
ex˛
 +
sign
 * 
num_byãs
;

1379 
qgroup
->
ex˛_cm¥
 +
sign
 * 
num_byãs
;

1381 i‡(
sign
 > 0)

1382 
	`qgroup_rsv_add_by_qgroup
(
fs_öfo
, 
qgroup
, 
§c
);

1384 
	`qgroup_rsv_ªÀa£_by_qgroup
(
fs_öfo
, 
qgroup
, 
§c
);

1386 
	`qgroup_dúty
(
fs_öfo
, 
qgroup
);

1389 
	`li°_f‹_óch_íåy
(
gli°
, &
qgroup
->
groups
, 
√xt_group
) {

1390 
ªt
 = 
	`uli°_add
(
tmp
, 
gli°
->
group
->
qgroupid
,

1391 
	`qgroup_to_aux
(
gli°
->
group
), 
GFP_ATOMIC
);

1392 i‡(
ªt
 < 0)

1393 
out
;

1397 
	`ULIST_ITER_INIT
(&
uôî
);

1398 (
unode
 = 
	`uli°_√xt
(
tmp
, &
uôî
))) {

1399 
qgroup
 = 
	`unode_aux_to_qgroup
(
unode
);

1400 
qgroup
->
r„r
 +
sign
 * 
num_byãs
;

1401 
qgroup
->
r„r_cm¥
 +
sign
 * 
num_byãs
;

1402 
	`WARN_ON
(
sign
 < 0 && 
qgroup
->
ex˛
 < 
num_byãs
);

1403 
qgroup
->
ex˛
 +
sign
 * 
num_byãs
;

1404 i‡(
sign
 > 0)

1405 
	`qgroup_rsv_add_by_qgroup
(
fs_öfo
, 
qgroup
, 
§c
);

1407 
	`qgroup_rsv_ªÀa£_by_qgroup
(
fs_öfo
, 
qgroup
, 
§c
);

1408 
qgroup
->
ex˛_cm¥
 +
sign
 * 
num_byãs
;

1409 
	`qgroup_dúty
(
fs_öfo
, 
qgroup
);

1412 
	`li°_f‹_óch_íåy
(
gli°
, &
qgroup
->
groups
, 
√xt_group
) {

1413 
ªt
 = 
	`uli°_add
(
tmp
, 
gli°
->
group
->
qgroupid
,

1414 
	`qgroup_to_aux
(
gli°
->
group
), 
GFP_ATOMIC
);

1415 i‡(
ªt
 < 0)

1416 
out
;

1419 
ªt
 = 0;

1420 
out
:

1421  
ªt
;

1422 
	}
}

1436 
	$quick_upd©e_accou¡ög
(
båfs_fs_öfo
 *
fs_öfo
,

1437 
uli°
 *
tmp
, 
u64
 
§c
, u64 
d°
,

1438 
sign
)

1440 
båfs_qgroup
 *
qgroup
;

1441 
ªt
 = 1;

1442 
îr
 = 0;

1444 
qgroup
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
§c
);

1445 i‡(!
qgroup
)

1446 
out
;

1447 i‡(
qgroup
->
ex˛
 =qgroup->
r„r
) {

1448 
ªt
 = 0;

1449 
îr
 = 
	`__qgroup_ex˛_accou¡ög
(
fs_öfo
, 
tmp
, 
d°
,

1450 
qgroup
, 
sign
);

1451 i‡(
îr
 < 0) {

1452 
ªt
 = 
îr
;

1453 
out
;

1456 
out
:

1457 i‡(
ªt
)

1458 
fs_öfo
->
qgroup_Êags
 |
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

1459  
ªt
;

1460 
	}
}

1462 
	$båfs_add_qgroup_ªœti⁄
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
§c
,

1463 
u64
 
d°
)

1465 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1466 
båfs_qgroup
 *
∑ª¡
;

1467 
båfs_qgroup
 *
membî
;

1468 
båfs_qgroup_li°
 *
li°
;

1469 
uli°
 *
tmp
;

1470 
nofs_Êag
;

1471 
ªt
 = 0;

1474 i‡(
	`båfs_qgroup_Àvñ
(
§c
Ë>båfs_qgroup_Àvñ(
d°
))

1475  -
EINVAL
;

1478 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

1479 
tmp
 = 
	`uli°_Æloc
(
GFP_KERNEL
);

1480 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

1481 i‡(!
tmp
)

1482  -
ENOMEM
;

1484 
	`muãx_lock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1485 i‡(!
fs_öfo
->
quŸa_roŸ
) {

1486 
ªt
 = -
ENOTCONN
;

1487 
out
;

1489 
membî
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
§c
);

1490 
∑ª¡
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
d°
);

1491 i‡(!
membî
 || !
∑ª¡
) {

1492 
ªt
 = -
EINVAL
;

1493 
out
;

1497 
	`li°_f‹_óch_íåy
(
li°
, &
membî
->
groups
, 
√xt_group
) {

1498 i‡(
li°
->
group
 =
∑ª¡
) {

1499 
ªt
 = -
EEXIST
;

1500 
out
;

1504 
ªt
 = 
	`add_qgroup_ªœti⁄_ôem
(
å™s
, 
§c
, 
d°
);

1505 i‡(
ªt
)

1506 
out
;

1508 
ªt
 = 
	`add_qgroup_ªœti⁄_ôem
(
å™s
, 
d°
, 
§c
);

1509 i‡(
ªt
) {

1510 
	`dñ_qgroup_ªœti⁄_ôem
(
å™s
, 
§c
, 
d°
);

1511 
out
;

1514 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

1515 
ªt
 = 
	`__add_ªœti⁄_rb
(
membî
, 
∑ª¡
);

1516 i‡(
ªt
 < 0) {

1517 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

1518 
out
;

1520 
ªt
 = 
	`quick_upd©e_accou¡ög
(
fs_öfo
, 
tmp
, 
§c
, 
d°
, 1);

1521 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

1522 
out
:

1523 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1524 
	`uli°_‰ì
(
tmp
);

1525  
ªt
;

1526 
	}
}

1528 
	$__dñ_qgroup_ªœti⁄
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
§c
,

1529 
u64
 
d°
)

1531 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1532 
båfs_qgroup
 *
∑ª¡
;

1533 
båfs_qgroup
 *
membî
;

1534 
båfs_qgroup_li°
 *
li°
;

1535 
uli°
 *
tmp
;

1536 
boﬁ
 
found
 = 
Ál£
;

1537 
nofs_Êag
;

1538 
ªt
 = 0;

1539 
ªt2
;

1542 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

1543 
tmp
 = 
	`uli°_Æloc
(
GFP_KERNEL
);

1544 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

1545 i‡(!
tmp
)

1546  -
ENOMEM
;

1548 i‡(!
fs_öfo
->
quŸa_roŸ
) {

1549 
ªt
 = -
ENOTCONN
;

1550 
out
;

1553 
membî
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
§c
);

1554 
∑ª¡
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
d°
);

1559 i‡(!
membî
 || !
∑ª¡
)

1560 
dñëe_ôem
;

1563 
	`li°_f‹_óch_íåy
(
li°
, &
membî
->
groups
, 
√xt_group
) {

1564 i‡(
li°
->
group
 =
∑ª¡
) {

1565 
found
 = 
åue
;

1570 
dñëe_ôem
:

1571 
ªt
 = 
	`dñ_qgroup_ªœti⁄_ôem
(
å™s
, 
§c
, 
d°
);

1572 i‡(
ªt
 < 0 &&Ñë !-
ENOENT
)

1573 
out
;

1574 
ªt2
 = 
	`dñ_qgroup_ªœti⁄_ôem
(
å™s
, 
d°
, 
§c
);

1575 i‡(
ªt2
 < 0 &&Ñë2 !-
ENOENT
)

1576 
out
;

1579 i‡(!
ªt
 || !
ªt2
)

1580 
ªt
 = 0;

1582 i‡(
found
) {

1583 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

1584 
	`dñ_ªœti⁄_rb
(
fs_öfo
, 
§c
, 
d°
);

1585 
ªt
 = 
	`quick_upd©e_accou¡ög
(
fs_öfo
, 
tmp
, 
§c
, 
d°
, -1);

1586 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

1588 
out
:

1589 
	`uli°_‰ì
(
tmp
);

1590  
ªt
;

1591 
	}
}

1593 
	$båfs_dñ_qgroup_ªœti⁄
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
§c
,

1594 
u64
 
d°
)

1596 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1597 
ªt
 = 0;

1599 
	`muãx_lock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1600 
ªt
 = 
	`__dñ_qgroup_ªœti⁄
(
å™s
, 
§c
, 
d°
);

1601 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1603  
ªt
;

1604 
	}
}

1606 
	$båfs_¸óã_qgroup
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
qgroupid
)

1608 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1609 
båfs_roŸ
 *
quŸa_roŸ
;

1610 
båfs_qgroup
 *
qgroup
;

1611 
ªt
 = 0;

1613 
	`muãx_lock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1614 i‡(!
fs_öfo
->
quŸa_roŸ
) {

1615 
ªt
 = -
ENOTCONN
;

1616 
out
;

1618 
quŸa_roŸ
 = 
fs_öfo
->quota_root;

1619 
qgroup
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
qgroupid
);

1620 i‡(
qgroup
) {

1621 
ªt
 = -
EEXIST
;

1622 
out
;

1625 
ªt
 = 
	`add_qgroup_ôem
(
å™s
, 
quŸa_roŸ
, 
qgroupid
);

1626 i‡(
ªt
)

1627 
out
;

1629 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

1630 
qgroup
 = 
	`add_qgroup_rb
(
fs_öfo
, 
qgroupid
);

1631 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

1633 i‡(
	`IS_ERR
(
qgroup
)) {

1634 
ªt
 = 
	`PTR_ERR
(
qgroup
);

1635 
out
;

1637 
ªt
 = 
	`båfs_sysfs_add_⁄e_qgroup
(
fs_öfo
, 
qgroup
);

1638 
out
:

1639 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1640  
ªt
;

1641 
	}
}

1643 
	$båfs_ªmove_qgroup
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
qgroupid
)

1645 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1646 
båfs_qgroup
 *
qgroup
;

1647 
båfs_qgroup_li°
 *
li°
;

1648 
ªt
 = 0;

1650 
	`muãx_lock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1651 i‡(!
fs_öfo
->
quŸa_roŸ
) {

1652 
ªt
 = -
ENOTCONN
;

1653 
out
;

1656 
qgroup
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
qgroupid
);

1657 i‡(!
qgroup
) {

1658 
ªt
 = -
ENOENT
;

1659 
out
;

1663 i‡(!
	`li°_em±y
(&
qgroup
->
membîs
)) {

1664 
ªt
 = -
EBUSY
;

1665 
out
;

1668 
ªt
 = 
	`dñ_qgroup_ôem
(
å™s
, 
qgroupid
);

1669 i‡(
ªt
 &&Ñë !-
ENOENT
)

1670 
out
;

1672 !
	`li°_em±y
(&
qgroup
->
groups
)) {

1673 
li°
 = 
	`li°_fú°_íåy
(&
qgroup
->
groups
,

1674 
båfs_qgroup_li°
, 
√xt_group
);

1675 
ªt
 = 
	`__dñ_qgroup_ªœti⁄
(
å™s
, 
qgroupid
,

1676 
li°
->
group
->
qgroupid
);

1677 i‡(
ªt
)

1678 
out
;

1681 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

1682 
	`dñ_qgroup_rb
(
fs_öfo
, 
qgroupid
);

1683 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

1690 
	`båfs_sysfs_dñ_⁄e_qgroup
(
fs_öfo
, 
qgroup
);

1691 
	`k‰ì
(
qgroup
);

1692 
out
:

1693 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1694  
ªt
;

1695 
	}
}

1697 
	$båfs_limô_qgroup
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
qgroupid
,

1698 
båfs_qgroup_limô
 *
limô
)

1700 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1701 
båfs_qgroup
 *
qgroup
;

1702 
ªt
 = 0;

1707 c⁄° 
u64
 
CLEAR_VALUE
 = -1;

1709 
	`muãx_lock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1710 i‡(!
fs_öfo
->
quŸa_roŸ
) {

1711 
ªt
 = -
ENOTCONN
;

1712 
out
;

1715 
qgroup
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
qgroupid
);

1716 i‡(!
qgroup
) {

1717 
ªt
 = -
ENOENT
;

1718 
out
;

1721 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

1722 i‡(
limô
->
Êags
 & 
BTRFS_QGROUP_LIMIT_MAX_RFER
) {

1723 i‡(
limô
->
max_r„r
 =
CLEAR_VALUE
) {

1724 
qgroup
->
lim_Êags
 &~
BTRFS_QGROUP_LIMIT_MAX_RFER
;

1725 
limô
->
Êags
 &~
BTRFS_QGROUP_LIMIT_MAX_RFER
;

1726 
qgroup
->
max_r„r
 = 0;

1728 
qgroup
->
max_r„r
 = 
limô
->max_rfer;

1731 i‡(
limô
->
Êags
 & 
BTRFS_QGROUP_LIMIT_MAX_EXCL
) {

1732 i‡(
limô
->
max_ex˛
 =
CLEAR_VALUE
) {

1733 
qgroup
->
lim_Êags
 &~
BTRFS_QGROUP_LIMIT_MAX_EXCL
;

1734 
limô
->
Êags
 &~
BTRFS_QGROUP_LIMIT_MAX_EXCL
;

1735 
qgroup
->
max_ex˛
 = 0;

1737 
qgroup
->
max_ex˛
 = 
limô
->max_excl;

1740 i‡(
limô
->
Êags
 & 
BTRFS_QGROUP_LIMIT_RSV_RFER
) {

1741 i‡(
limô
->
rsv_r„r
 =
CLEAR_VALUE
) {

1742 
qgroup
->
lim_Êags
 &~
BTRFS_QGROUP_LIMIT_RSV_RFER
;

1743 
limô
->
Êags
 &~
BTRFS_QGROUP_LIMIT_RSV_RFER
;

1744 
qgroup
->
rsv_r„r
 = 0;

1746 
qgroup
->
rsv_r„r
 = 
limô
->rsv_rfer;

1749 i‡(
limô
->
Êags
 & 
BTRFS_QGROUP_LIMIT_RSV_EXCL
) {

1750 i‡(
limô
->
rsv_ex˛
 =
CLEAR_VALUE
) {

1751 
qgroup
->
lim_Êags
 &~
BTRFS_QGROUP_LIMIT_RSV_EXCL
;

1752 
limô
->
Êags
 &~
BTRFS_QGROUP_LIMIT_RSV_EXCL
;

1753 
qgroup
->
rsv_ex˛
 = 0;

1755 
qgroup
->
rsv_ex˛
 = 
limô
->rsv_excl;

1758 
qgroup
->
lim_Êags
 |
limô
->
Êags
;

1760 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

1762 
ªt
 = 
	`upd©e_qgroup_limô_ôem
(
å™s
, 
qgroup
);

1763 i‡(
ªt
) {

1764 
	`qgroup_m¨k_öc⁄si°ít
(
fs_öfo
);

1765 
	`båfs_öfo
(
fs_öfo
, "unableÅo update quotaÜimit for %llu",

1766 
qgroupid
);

1769 
out
:

1770 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_io˘l_lock
);

1771  
ªt
;

1772 
	}
}

1774 
	$båfs_qgroup_åa˚_exã¡_nﬁock
(
båfs_fs_öfo
 *
fs_öfo
,

1775 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
,

1776 
båfs_qgroup_exã¡_ªc‹d
 *
ªc‹d
)

1778 
rb_node
 **
p
 = &
dñayed_ªfs
->
dúty_exã¡_roŸ
.rb_node;

1779 
rb_node
 *
∑ª¡_node
 = 
NULL
;

1780 
båfs_qgroup_exã¡_ªc‹d
 *
íåy
;

1781 
u64
 
byãƒ
 = 
ªc‹d
->bytenr;

1783 
	`lockdï_as£π_hñd
(&
dñayed_ªfs
->
lock
);

1784 
	`åa˚_båfs_qgroup_åa˚_exã¡
(
fs_öfo
, 
ªc‹d
);

1786 *
p
) {

1787 
∑ª¡_node
 = *
p
;

1788 
íåy
 = 
	`rb_íåy
(
∑ª¡_node
, 
båfs_qgroup_exã¡_ªc‹d
,

1789 
node
);

1790 i‡(
byãƒ
 < 
íåy
->bytenr) {

1791 
p
 = &(*p)->
rb_À·
;

1792 } i‡(
byãƒ
 > 
íåy
->bytenr) {

1793 
p
 = &(*p)->
rb_right
;

1795 i‡(
ªc‹d
->
d©a_rsv
 && !
íåy
->data_rsv) {

1796 
íåy
->
d©a_rsv
 = 
ªc‹d
->data_rsv;

1797 
íåy
->
d©a_rsv_ª‰oŸ
 =

1798 
ªc‹d
->
d©a_rsv_ª‰oŸ
;

1804 
	`rb_lök_node
(&
ªc‹d
->
node
, 
∑ª¡_node
, 
p
);

1805 
	`rb_ö£π_cﬁ‹
(&
ªc‹d
->
node
, &
dñayed_ªfs
->
dúty_exã¡_roŸ
);

1807 
	}
}

1809 
	$båfs_qgroup_åa˚_exã¡_po°
(
båfs_å™s_h™dÀ
 *
å™s
,

1810 
båfs_qgroup_exã¡_ªc‹d
 *
qªc‹d
)

1812 
båfs_backªf_wÆk_˘x
 
˘x
 = { 0 };

1813 
ªt
;

1834 
	`ASSERT
(
å™s
 !
NULL
);

1836 i‡(
å™s
->
fs_öfo
->
qgroup_Êags
 & 
BTRFS_QGROUP_RUNTIME_FLAG_NO_ACCOUNTING
)

1839 
˘x
.
byãƒ
 = 
qªc‹d
->bytenr;

1840 
˘x
.
fs_öfo
 = 
å™s
->fs_info;

1842 
ªt
 = 
	`båfs_föd_Æl_roŸs
(&
˘x
, 
åue
);

1843 i‡(
ªt
 < 0) {

1844 
	`qgroup_m¨k_öc⁄si°ít
(
å™s
->
fs_öfo
);

1845 
	`båfs_w¨n
(
å™s
->
fs_öfo
,

1847 
ªt
);

1858 
qªc‹d
->
ﬁd_roŸs
 = 
˘x
.
roŸs
;

1860 
	}
}

1862 
	$båfs_qgroup_åa˚_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
byãƒ
,

1863 
u64
 
num_byãs
)

1865 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1866 
båfs_qgroup_exã¡_ªc‹d
 *
ªc‹d
;

1867 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
;

1868 
ªt
;

1870 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
)

1871 || 
byãƒ
 =0 || 
num_byãs
 == 0)

1873 
ªc‹d
 = 
	`kzÆloc
((*ªc‹d), 
GFP_NOFS
);

1874 i‡(!
ªc‹d
)

1875  -
ENOMEM
;

1877 
dñayed_ªfs
 = &
å™s
->
å™ß˘i⁄
->delayed_refs;

1878 
ªc‹d
->
byãƒ
 = bytenr;

1879 
ªc‹d
->
num_byãs
 =Çum_bytes;

1880 
ªc‹d
->
ﬁd_roŸs
 = 
NULL
;

1882 
	`•ö_lock
(&
dñayed_ªfs
->
lock
);

1883 
ªt
 = 
	`båfs_qgroup_åa˚_exã¡_nﬁock
(
fs_öfo
, 
dñayed_ªfs
, 
ªc‹d
);

1884 
	`•ö_u∆ock
(&
dñayed_ªfs
->
lock
);

1885 i‡(
ªt
 > 0) {

1886 
	`k‰ì
(
ªc‹d
);

1889  
	`båfs_qgroup_åa˚_exã¡_po°
(
å™s
, 
ªc‹d
);

1890 
	}
}

1892 
	$båfs_qgroup_åa˚_Àaf_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

1893 
exã¡_buf„r
 *
eb
)

1895 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1896 
ƒ
 = 
	`båfs_hódî_ƒôems
(
eb
);

1897 
i
, 
exã¡_ty≥
, 
ªt
;

1898 
båfs_key
 
key
;

1899 
båfs_fûe_exã¡_ôem
 *
fi
;

1900 
u64
 
byãƒ
, 
num_byãs
;

1903 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
))

1906 
i
 = 0; i < 
ƒ
; i++) {

1907 
	`båfs_ôem_key_to_˝u
(
eb
, &
key
, 
i
);

1909 i‡(
key
.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

1912 
fi
 = 
	`båfs_ôem_±r
(
eb
, 
i
, 
båfs_fûe_exã¡_ôem
);

1914 
exã¡_ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
eb
, 
fi
);

1916 i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
)

1919 
byãƒ
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
eb
, 
fi
);

1920 i‡(!
byãƒ
)

1923 
num_byãs
 = 
	`båfs_fûe_exã¡_disk_num_byãs
(
eb
, 
fi
);

1925 
ªt
 = 
	`båfs_qgroup_åa˚_exã¡
(
å™s
, 
byãƒ
, 
num_byãs
);

1926 i‡(
ªt
)

1927  
ªt
;

1929 
	`c⁄d_ªsched
();

1931 
	}
}

1947 
	$adju°_¶Ÿs_upw¨ds
(
båfs_∑th
 *
∑th
, 
roŸ_Àvñ
)

1949 
Àvñ
 = 0;

1950 
ƒ
, 
¶Ÿ
;

1951 
exã¡_buf„r
 *
eb
;

1953 i‡(
roŸ_Àvñ
 == 0)

1956 
Àvñ
 <
roŸ_Àvñ
) {

1957 
eb
 = 
∑th
->
nodes
[
Àvñ
];

1958 
ƒ
 = 
	`båfs_hódî_ƒôems
(
eb
);

1959 
∑th
->
¶Ÿs
[
Àvñ
]++;

1960 
¶Ÿ
 = 
∑th
->
¶Ÿs
[
Àvñ
];

1961 i‡(
¶Ÿ
 >
ƒ
 || 
Àvñ
 == 0) {

1967 i‡(
Àvñ
 !
roŸ_Àvñ
) {

1968 
	`båfs_åì_u∆ock_rw
(
eb
, 
∑th
->
locks
[
Àvñ
]);

1969 
∑th
->
locks
[
Àvñ
] = 0;

1971 
	`‰ì_exã¡_buf„r
(
eb
);

1972 
∑th
->
nodes
[
Àvñ
] = 
NULL
;

1973 
∑th
->
¶Ÿs
[
Àvñ
] = 0;

1984 
Àvñ
++;

1987 
eb
 = 
∑th
->
nodes
[
roŸ_Àvñ
];

1988 i‡(
∑th
->
¶Ÿs
[
roŸ_Àvñ
] >
	`båfs_hódî_ƒôems
(
eb
))

1992 
	}
}

2040 
	$qgroup_åa˚_exã¡_sw≠
(
båfs_å™s_h™dÀ
* 
å™s
,

2041 
exã¡_buf„r
 *
§c_eb
,

2042 
båfs_∑th
 *
d°_∑th
,

2043 
d°_Àvñ
, 
roŸ_Àvñ
,

2044 
boﬁ
 
åa˚_Àaf
)

2046 
båfs_key
 
key
;

2047 
båfs_∑th
 *
§c_∑th
;

2048 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2049 
u32
 
nodesize
 = 
fs_öfo
->nodesize;

2050 
cur_Àvñ
 = 
roŸ_Àvñ
;

2051 
ªt
;

2053 
	`BUG_ON
(
d°_Àvñ
 > 
roŸ_Àvñ
);

2055 i‡(
	`båfs_hódî_Àvñ
(
§c_eb
Ë!
roŸ_Àvñ
)

2056  -
EINVAL
;

2058 
§c_∑th
 = 
	`båfs_Æloc_∑th
();

2059 i‡(!
§c_∑th
) {

2060 
ªt
 = -
ENOMEM
;

2061 
out
;

2064 i‡(
d°_Àvñ
)

2065 
	`båfs_node_key_to_˝u
(
d°_∑th
->
nodes
[
d°_Àvñ
], &
key
, 0);

2067 
	`båfs_ôem_key_to_˝u
(
d°_∑th
->
nodes
[
d°_Àvñ
], &
key
, 0);

2070 
	`©omic_öc
(&
§c_eb
->
ªfs
);

2071 
§c_∑th
->
nodes
[
roŸ_Àvñ
] = 
§c_eb
;

2072 
§c_∑th
->
¶Ÿs
[
roŸ_Àvñ
] = 
d°_∑th
->slots[root_level];

2073 
§c_∑th
->
locks
[
roŸ_Àvñ
] = 0;

2076 
cur_Àvñ
 >
d°_Àvñ
) {

2077 
båfs_key
 
§c_key
;

2078 
båfs_key
 
d°_key
;

2080 i‡(
§c_∑th
->
nodes
[
cur_Àvñ
] =
NULL
) {

2081 
exã¡_buf„r
 *
eb
;

2082 
∑ª¡_¶Ÿ
;

2084 
eb
 = 
§c_∑th
->
nodes
[
cur_Àvñ
 + 1];

2085 
∑ª¡_¶Ÿ
 = 
§c_∑th
->
¶Ÿs
[
cur_Àvñ
 + 1];

2087 
eb
 = 
	`båfs_ªad_node_¶Ÿ
”b, 
∑ª¡_¶Ÿ
);

2088 i‡(
	`IS_ERR
(
eb
)) {

2089 
ªt
 = 
	`PTR_ERR
(
eb
);

2090 
out
;

2093 
§c_∑th
->
nodes
[
cur_Àvñ
] = 
eb
;

2095 
	`båfs_åì_ªad_lock
(
eb
);

2096 
§c_∑th
->
locks
[
cur_Àvñ
] = 
BTRFS_READ_LOCK
;

2099 
§c_∑th
->
¶Ÿs
[
cur_Àvñ
] = 
d°_∑th
->slots[cur_level];

2100 i‡(
cur_Àvñ
) {

2101 
	`båfs_node_key_to_˝u
(
d°_∑th
->
nodes
[
cur_Àvñ
],

2102 &
d°_key
, 
d°_∑th
->
¶Ÿs
[
cur_Àvñ
]);

2103 
	`båfs_node_key_to_˝u
(
§c_∑th
->
nodes
[
cur_Àvñ
],

2104 &
§c_key
, 
§c_∑th
->
¶Ÿs
[
cur_Àvñ
]);

2106 
	`båfs_ôem_key_to_˝u
(
d°_∑th
->
nodes
[
cur_Àvñ
],

2107 &
d°_key
, 
d°_∑th
->
¶Ÿs
[
cur_Àvñ
]);

2108 
	`båfs_ôem_key_to_˝u
(
§c_∑th
->
nodes
[
cur_Àvñ
],

2109 &
§c_key
, 
§c_∑th
->
¶Ÿs
[
cur_Àvñ
]);

2112 i‡(
	`båfs_comp_˝u_keys
(&
d°_key
, &
§c_key
)) {

2113 
ªt
 = -
ENOENT
;

2114 
out
;

2116 
cur_Àvñ
--;

2123 
ªt
 = 
	`båfs_qgroup_åa˚_exã¡
(
å™s
, 
§c_∑th
->
nodes
[
d°_Àvñ
]->
°¨t
,

2124 
nodesize
);

2125 i‡(
ªt
 < 0)

2126 
out
;

2127 
ªt
 = 
	`båfs_qgroup_åa˚_exã¡
(
å™s
, 
d°_∑th
->
nodes
[
d°_Àvñ
]->
°¨t
,

2128 
nodesize
);

2129 i‡(
ªt
 < 0)

2130 
out
;

2133 i‡(
d°_Àvñ
 =0 && 
åa˚_Àaf
) {

2134 
ªt
 = 
	`båfs_qgroup_åa˚_Àaf_ôems
(
å™s
, 
§c_∑th
->
nodes
[0]);

2135 i‡(
ªt
 < 0)

2136 
out
;

2137 
ªt
 = 
	`båfs_qgroup_åa˚_Àaf_ôems
(
å™s
, 
d°_∑th
->
nodes
[0]);

2139 
out
:

2140 
	`båfs_‰ì_∑th
(
§c_∑th
);

2141  
ªt
;

2142 
	}
}

2166 
	$qgroup_åa˚_√w_subåì_blocks
(
båfs_å™s_h™dÀ
* 
å™s
,

2167 
exã¡_buf„r
 *
§c_eb
,

2168 
båfs_∑th
 *
d°_∑th
,

2169 
cur_Àvñ
, 
roŸ_Àvñ
,

2170 
u64
 
œ°_¢≠shŸ
, 
boﬁ
 
åa˚_Àaf
)

2172 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2173 
exã¡_buf„r
 *
eb
;

2174 
boﬁ
 
√ed_˛ónup
 = 
Ál£
;

2175 
ªt
 = 0;

2176 
i
;

2179 i‡(
cur_Àvñ
 < 0 || cur_Àvñ >
BTRFS_MAX_LEVEL
 - 1 ||

2180 
roŸ_Àvñ
 < 0 ||ÑoŸ_Àvñ >
BTRFS_MAX_LEVEL
 - 1 ||

2181 
roŸ_Àvñ
 < 
cur_Àvñ
) {

2182 
	`båfs_îr_æ
(
fs_öfo
,

2184 
__func__
, 
cur_Àvñ
, 
roŸ_Àvñ
);

2185  -
EUCLEAN
;

2189 i‡(
d°_∑th
->
nodes
[
cur_Àvñ
] =
NULL
) {

2190 
∑ª¡_¶Ÿ
;

2191 
u64
 
chûd_gí
;

2197 i‡(
cur_Àvñ
 =
roŸ_Àvñ
) {

2198 
	`båfs_îr_æ
(
fs_öfo
,

2200 
__func__
, 
roŸ_Àvñ
,ÑoŸ_Àvñ, 
cur_Àvñ
);

2201  -
EUCLEAN
;

2208 
eb
 = 
d°_∑th
->
nodes
[
cur_Àvñ
 + 1];

2209 
∑ª¡_¶Ÿ
 = 
d°_∑th
->
¶Ÿs
[
cur_Àvñ
 + 1];

2210 
chûd_gí
 = 
	`båfs_node_±r_gíî©i⁄
(
eb
, 
∑ª¡_¶Ÿ
);

2213 i‡(
chûd_gí
 < 
œ°_¢≠shŸ
)

2214 
out
;

2216 
eb
 = 
	`båfs_ªad_node_¶Ÿ
”b, 
∑ª¡_¶Ÿ
);

2217 i‡(
	`IS_ERR
(
eb
)) {

2218 
ªt
 = 
	`PTR_ERR
(
eb
);

2219 
out
;

2222 
d°_∑th
->
nodes
[
cur_Àvñ
] = 
eb
;

2223 
d°_∑th
->
¶Ÿs
[
cur_Àvñ
] = 0;

2225 
	`båfs_åì_ªad_lock
(
eb
);

2226 
d°_∑th
->
locks
[
cur_Àvñ
] = 
BTRFS_READ_LOCK
;

2227 
√ed_˛ónup
 = 
åue
;

2231 
ªt
 = 
	`qgroup_åa˚_exã¡_sw≠
(
å™s
, 
§c_eb
, 
d°_∑th
, 
cur_Àvñ
,

2232 
roŸ_Àvñ
, 
åa˚_Àaf
);

2233 i‡(
ªt
 < 0)

2234 
˛ónup
;

2236 
eb
 = 
d°_∑th
->
nodes
[
cur_Àvñ
];

2238 i‡(
cur_Àvñ
 > 0) {

2240 
i
 = 0; i < 
	`båfs_hódî_ƒôems
(
eb
); i++) {

2242 i‡(
	`båfs_node_±r_gíî©i⁄
(
eb
, 
i
Ë< 
œ°_¢≠shŸ
)

2244 
d°_∑th
->
¶Ÿs
[
cur_Àvñ
] = 
i
;

2247 
ªt
 = 
	`qgroup_åa˚_√w_subåì_blocks
(
å™s
, 
§c_eb
,

2248 
d°_∑th
, 
cur_Àvñ
 - 1, 
roŸ_Àvñ
,

2249 
œ°_¢≠shŸ
, 
åa˚_Àaf
);

2250 i‡(
ªt
 < 0)

2251 
˛ónup
;

2255 
˛ónup
:

2256 i‡(
√ed_˛ónup
) {

2258 
	`båfs_åì_u∆ock_rw
(
d°_∑th
->
nodes
[
cur_Àvñ
],

2259 
d°_∑th
->
locks
[
cur_Àvñ
]);

2260 
	`‰ì_exã¡_buf„r
(
d°_∑th
->
nodes
[
cur_Àvñ
]);

2261 
d°_∑th
->
nodes
[
cur_Àvñ
] = 
NULL
;

2262 
d°_∑th
->
¶Ÿs
[
cur_Àvñ
] = 0;

2263 
d°_∑th
->
locks
[
cur_Àvñ
] = 0;

2265 
out
:

2266  
ªt
;

2267 
	}
}

2269 
	$qgroup_åa˚_subåì_sw≠
(
båfs_å™s_h™dÀ
 *
å™s
,

2270 
exã¡_buf„r
 *
§c_eb
,

2271 
exã¡_buf„r
 *
d°_eb
,

2272 
u64
 
œ°_¢≠shŸ
, 
boﬁ
 
åa˚_Àaf
)

2274 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2275 
båfs_∑th
 *
d°_∑th
 = 
NULL
;

2276 
Àvñ
;

2277 
ªt
;

2279 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
))

2283 i‡(
	`båfs_hódî_gíî©i⁄
(
§c_eb
Ë> båfs_hódî_gíî©i⁄(
d°_eb
)) {

2284 
	`båfs_îr_æ
(
fs_öfo
,

2285 "%s: badÖ¨amëî ordî, src_gí=%Œu d°_gí=%Œu", 
__func__
,

2286 
	`båfs_hódî_gíî©i⁄
(
§c_eb
),

2287 
	`båfs_hódî_gíî©i⁄
(
d°_eb
));

2288  -
EUCLEAN
;

2291 i‡(!
	`exã¡_buf„r_u±od©e
(
§c_eb
Ë|| !exã¡_buf„r_u±od©e(
d°_eb
)) {

2292 
ªt
 = -
EIO
;

2293 
out
;

2296 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
d°_eb
);

2297 
d°_∑th
 = 
	`båfs_Æloc_∑th
();

2298 i‡(!
d°_∑th
) {

2299 
ªt
 = -
ENOMEM
;

2300 
out
;

2303 
	`©omic_öc
(&
d°_eb
->
ªfs
);

2304 
d°_∑th
->
nodes
[
Àvñ
] = 
d°_eb
;

2305 
d°_∑th
->
¶Ÿs
[
Àvñ
] = 0;

2306 
d°_∑th
->
locks
[
Àvñ
] = 0;

2309 
ªt
 = 
	`qgroup_åa˚_√w_subåì_blocks
(
å™s
, 
§c_eb
, 
d°_∑th
, 
Àvñ
,

2310 
Àvñ
, 
œ°_¢≠shŸ
, 
åa˚_Àaf
);

2311 i‡(
ªt
 < 0)

2312 
out
;

2313 
ªt
 = 0;

2315 
out
:

2316 
	`båfs_‰ì_∑th
(
d°_∑th
);

2317 i‡(
ªt
 < 0)

2318 
	`qgroup_m¨k_öc⁄si°ít
(
fs_öfo
);

2319  
ªt
;

2320 
	}
}

2322 
	$båfs_qgroup_åa˚_subåì
(
båfs_å™s_h™dÀ
 *
å™s
,

2323 
exã¡_buf„r
 *
roŸ_eb
,

2324 
u64
 
roŸ_gí
, 
roŸ_Àvñ
)

2326 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2327 
ªt
 = 0;

2328 
Àvñ
;

2329 
u8
 
dr›_sub±ªe_thªs
;

2330 
exã¡_buf„r
 *
eb
 = 
roŸ_eb
;

2331 
båfs_∑th
 *
∑th
 = 
NULL
;

2333 
	`BUG_ON
(
roŸ_Àvñ
 < 0 ||ÑoŸ_Àvñ >
BTRFS_MAX_LEVEL
);

2334 
	`BUG_ON
(
roŸ_eb
 =
NULL
);

2336 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
))

2339 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

2340 
dr›_sub±ªe_thªs
 = 
fs_öfo
->
qgroup_dr›_subåì_thªs
;

2341 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

2351 i‡(
roŸ_Àvñ
 >
dr›_sub±ªe_thªs
) {

2352 
	`qgroup_m¨k_öc⁄si°ít
(
fs_öfo
);

2356 i‡(!
	`exã¡_buf„r_u±od©e
(
roŸ_eb
)) {

2357 
båfs_åì_∑ª¡_check
 
check
 = {

2358 .
has_fú°_key
 = 
Ál£
,

2359 .
å™sid
 = 
roŸ_gí
,

2360 .
Àvñ
 = 
roŸ_Àvñ


2363 
ªt
 = 
	`båfs_ªad_exã¡_buf„r
(
roŸ_eb
, &
check
);

2364 i‡(
ªt
)

2365 
out
;

2368 i‡(
roŸ_Àvñ
 == 0) {

2369 
ªt
 = 
	`båfs_qgroup_åa˚_Àaf_ôems
(
å™s
, 
roŸ_eb
);

2370 
out
;

2373 
∑th
 = 
	`båfs_Æloc_∑th
();

2374 i‡(!
∑th
)

2375  -
ENOMEM
;

2386 
	`©omic_öc
(&
roŸ_eb
->
ªfs
);

2387 
∑th
->
nodes
[
roŸ_Àvñ
] = 
roŸ_eb
;

2388 
∑th
->
¶Ÿs
[
roŸ_Àvñ
] = 0;

2389 
∑th
->
locks
[
roŸ_Àvñ
] = 0;

2390 
wÆk_down
:

2391 
Àvñ
 = 
roŸ_Àvñ
;

2392 
Àvñ
 >= 0) {

2393 i‡(
∑th
->
nodes
[
Àvñ
] =
NULL
) {

2394 
∑ª¡_¶Ÿ
;

2395 
u64
 
chûd_byãƒ
;

2401 
eb
 = 
∑th
->
nodes
[
Àvñ
 + 1];

2402 
∑ª¡_¶Ÿ
 = 
∑th
->
¶Ÿs
[
Àvñ
 + 1];

2403 
chûd_byãƒ
 = 
	`båfs_node_block±r
(
eb
, 
∑ª¡_¶Ÿ
);

2405 
eb
 = 
	`båfs_ªad_node_¶Ÿ
”b, 
∑ª¡_¶Ÿ
);

2406 i‡(
	`IS_ERR
(
eb
)) {

2407 
ªt
 = 
	`PTR_ERR
(
eb
);

2408 
out
;

2411 
∑th
->
nodes
[
Àvñ
] = 
eb
;

2412 
∑th
->
¶Ÿs
[
Àvñ
] = 0;

2414 
	`båfs_åì_ªad_lock
(
eb
);

2415 
∑th
->
locks
[
Àvñ
] = 
BTRFS_READ_LOCK
;

2417 
ªt
 = 
	`båfs_qgroup_åa˚_exã¡
(
å™s
, 
chûd_byãƒ
,

2418 
fs_öfo
->
nodesize
);

2419 i‡(
ªt
)

2420 
out
;

2423 i‡(
Àvñ
 == 0) {

2424 
ªt
 = 
	`båfs_qgroup_åa˚_Àaf_ôems
(
å™s
,

2425 
∑th
->
nodes
[
Àvñ
]);

2426 i‡(
ªt
)

2427 
out
;

2430 
ªt
 = 
	`adju°_¶Ÿs_upw¨ds
(
∑th
, 
roŸ_Àvñ
);

2431 i‡(
ªt
)

2435 
wÆk_down
;

2438 
Àvñ
--;

2441 
ªt
 = 0;

2442 
out
:

2443 
	`båfs_‰ì_∑th
(
∑th
);

2445  
ªt
;

2446 
	}
}

2448 
	#UPDATE_NEW
 0

	)

2449 
	#UPDATE_OLD
 1

	)

2453 
	$qgroup_upd©e_ªf˙t
(
båfs_fs_öfo
 *
fs_öfo
,

2454 
uli°
 *
roŸs
, uli° *
tmp
,

2455 
uli°
 *
qgroups
, 
u64
 
£q
, 
upd©e_ﬁd
)

2457 
uli°_node
 *
unode
;

2458 
uli°_ôî©‹
 
uôî
;

2459 
uli°_node
 *
tmp_unode
;

2460 
uli°_ôî©‹
 
tmp_uôî
;

2461 
båfs_qgroup
 *
qg
;

2462 
ªt
 = 0;

2464 i‡(!
roŸs
)

2466 
	`ULIST_ITER_INIT
(&
uôî
);

2467 (
unode
 = 
	`uli°_√xt
(
roŸs
, &
uôî
))) {

2468 
qg
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
unode
->
vÆ
);

2469 i‡(!
qg
)

2472 
	`uli°_ªöô
(
tmp
);

2473 
ªt
 = 
	`uli°_add
(
qgroups
, 
qg
->
qgroupid
, 
	`qgroup_to_aux
(qg),

2474 
GFP_ATOMIC
);

2475 i‡(
ªt
 < 0)

2476  
ªt
;

2477 
ªt
 = 
	`uli°_add
(
tmp
, 
qg
->
qgroupid
, 
	`qgroup_to_aux
(qg), 
GFP_ATOMIC
);

2478 i‡(
ªt
 < 0)

2479  
ªt
;

2480 
	`ULIST_ITER_INIT
(&
tmp_uôî
);

2481 (
tmp_unode
 = 
	`uli°_√xt
(
tmp
, &
tmp_uôî
))) {

2482 
båfs_qgroup_li°
 *
gli°
;

2484 
qg
 = 
	`unode_aux_to_qgroup
(
tmp_unode
);

2485 i‡(
upd©e_ﬁd
)

2486 
	`båfs_qgroup_upd©e_ﬁd_ªf˙t
(
qg
, 
£q
, 1);

2488 
	`båfs_qgroup_upd©e_√w_ªf˙t
(
qg
, 
£q
, 1);

2489 
	`li°_f‹_óch_íåy
(
gli°
, &
qg
->
groups
, 
√xt_group
) {

2490 
ªt
 = 
	`uli°_add
(
qgroups
, 
gli°
->
group
->
qgroupid
,

2491 
	`qgroup_to_aux
(
gli°
->
group
),

2492 
GFP_ATOMIC
);

2493 i‡(
ªt
 < 0)

2494  
ªt
;

2495 
ªt
 = 
	`uli°_add
(
tmp
, 
gli°
->
group
->
qgroupid
,

2496 
	`qgroup_to_aux
(
gli°
->
group
),

2497 
GFP_ATOMIC
);

2498 i‡(
ªt
 < 0)

2499  
ªt
;

2504 
	}
}

2542 
	$qgroup_upd©e_cou¡îs
(
båfs_fs_öfo
 *
fs_öfo
,

2543 
uli°
 *
qgroups
,

2544 
u64
 
ƒ_ﬁd_roŸs
,

2545 
u64
 
ƒ_√w_roŸs
,

2546 
u64
 
num_byãs
, u64 
£q
)

2548 
uli°_node
 *
unode
;

2549 
uli°_ôî©‹
 
uôî
;

2550 
båfs_qgroup
 *
qg
;

2551 
u64
 
cur_√w_cou¡
, 
cur_ﬁd_cou¡
;

2553 
	`ULIST_ITER_INIT
(&
uôî
);

2554 (
unode
 = 
	`uli°_√xt
(
qgroups
, &
uôî
))) {

2555 
boﬁ
 
dúty
 = 
Ál£
;

2557 
qg
 = 
	`unode_aux_to_qgroup
(
unode
);

2558 
cur_ﬁd_cou¡
 = 
	`båfs_qgroup_gë_ﬁd_ªf˙t
(
qg
, 
£q
);

2559 
cur_√w_cou¡
 = 
	`båfs_qgroup_gë_√w_ªf˙t
(
qg
, 
£q
);

2561 
	`åa˚_qgroup_upd©e_cou¡îs
(
fs_öfo
, 
qg
, 
cur_ﬁd_cou¡
,

2562 
cur_√w_cou¡
);

2565 i‡(
cur_ﬁd_cou¡
 =0 && 
cur_√w_cou¡
 > 0) {

2566 
qg
->
r„r
 +
num_byãs
;

2567 
qg
->
r„r_cm¥
 +
num_byãs
;

2568 
dúty
 = 
åue
;

2570 i‡(
cur_ﬁd_cou¡
 > 0 && 
cur_√w_cou¡
 == 0) {

2571 
qg
->
r„r
 -
num_byãs
;

2572 
qg
->
r„r_cm¥
 -
num_byãs
;

2573 
dúty
 = 
åue
;

2578 i‡(
cur_ﬁd_cou¡
 =
ƒ_ﬁd_roŸs
 &&

2579 
cur_√w_cou¡
 < 
ƒ_√w_roŸs
) {

2581 i‡(
cur_ﬁd_cou¡
 != 0) {

2582 
qg
->
ex˛
 -
num_byãs
;

2583 
qg
->
ex˛_cm¥
 -
num_byãs
;

2584 
dúty
 = 
åue
;

2589 i‡(
cur_ﬁd_cou¡
 < 
ƒ_ﬁd_roŸs
 &&

2590 
cur_√w_cou¡
 =
ƒ_√w_roŸs
) {

2592 i‡(
cur_√w_cou¡
 != 0) {

2593 
qg
->
ex˛
 +
num_byãs
;

2594 
qg
->
ex˛_cm¥
 +
num_byãs
;

2595 
dúty
 = 
åue
;

2600 i‡(
cur_ﬁd_cou¡
 =
ƒ_ﬁd_roŸs
 &&

2601 
cur_√w_cou¡
 =
ƒ_√w_roŸs
) {

2602 i‡(
cur_ﬁd_cou¡
 == 0) {

2605 i‡(
cur_√w_cou¡
 != 0) {

2607 
qg
->
ex˛
 +
num_byãs
;

2608 
qg
->
ex˛_cm¥
 +
num_byãs
;

2609 
dúty
 = 
åue
;

2615 i‡(
cur_√w_cou¡
 == 0) {

2617 
qg
->
ex˛
 -
num_byãs
;

2618 
qg
->
ex˛_cm¥
 -
num_byãs
;

2619 
dúty
 = 
åue
;

2625 i‡(
dúty
)

2626 
	`qgroup_dúty
(
fs_öfo
, 
qg
);

2629 
	}
}

2638 
	$maybe_fs_roŸs
(
uli°
 *
roŸs
)

2640 
uli°_node
 *
unode
;

2641 
uli°_ôî©‹
 
uôî
;

2644 i‡(!
roŸs
 ||ÑoŸs->
¬odes
 == 0)

2647 
	`ULIST_ITER_INIT
(&
uôî
);

2648 
unode
 = 
	`uli°_√xt
(
roŸs
, &
uôî
);

2649 i‡(!
unode
)

2657  
	`is_f°ªe
(
unode
->
vÆ
);

2658 
	}
}

2660 
	$båfs_qgroup_accou¡_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
byãƒ
,

2661 
u64
 
num_byãs
, 
uli°
 *
ﬁd_roŸs
,

2662 
uli°
 *
√w_roŸs
)

2664 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2665 
uli°
 *
qgroups
 = 
NULL
;

2666 
uli°
 *
tmp
 = 
NULL
;

2667 
u64
 
£q
;

2668 
u64
 
ƒ_√w_roŸs
 = 0;

2669 
u64
 
ƒ_ﬁd_roŸs
 = 0;

2670 
ªt
 = 0;

2676 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
) ||

2677 
fs_öfo
->
qgroup_Êags
 & 
BTRFS_QGROUP_RUNTIME_FLAG_NO_ACCOUNTING
)

2678 
out_‰ì
;

2680 i‡(
√w_roŸs
) {

2681 i‡(!
	`maybe_fs_roŸs
(
√w_roŸs
))

2682 
out_‰ì
;

2683 
ƒ_√w_roŸs
 = 
√w_roŸs
->
¬odes
;

2685 i‡(
ﬁd_roŸs
) {

2686 i‡(!
	`maybe_fs_roŸs
(
ﬁd_roŸs
))

2687 
out_‰ì
;

2688 
ƒ_ﬁd_roŸs
 = 
ﬁd_roŸs
->
¬odes
;

2692 i‡(
ƒ_ﬁd_roŸs
 =0 && 
ƒ_√w_roŸs
 == 0)

2693 
out_‰ì
;

2695 
	`BUG_ON
(!
fs_öfo
->
quŸa_roŸ
);

2697 
	`åa˚_båfs_qgroup_accou¡_exã¡
(
fs_öfo
, 
å™s
->
å™sid
, 
byãƒ
,

2698 
num_byãs
, 
ƒ_ﬁd_roŸs
, 
ƒ_√w_roŸs
);

2700 
qgroups
 = 
	`uli°_Æloc
(
GFP_NOFS
);

2701 i‡(!
qgroups
) {

2702 
ªt
 = -
ENOMEM
;

2703 
out_‰ì
;

2705 
tmp
 = 
	`uli°_Æloc
(
GFP_NOFS
);

2706 i‡(!
tmp
) {

2707 
ªt
 = -
ENOMEM
;

2708 
out_‰ì
;

2711 
	`muãx_lock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

2712 i‡(
fs_öfo
->
qgroup_Êags
 & 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
) {

2713 i‡(
fs_öfo
->
qgroup_ªsˇn_¥ogªss
.
obje˘id
 <
byãƒ
) {

2714 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

2715 
ªt
 = 0;

2716 
out_‰ì
;

2719 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

2721 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

2722 
£q
 = 
fs_öfo
->
qgroup_£q
;

2725 
ªt
 = 
	`qgroup_upd©e_ªf˙t
(
fs_öfo
, 
ﬁd_roŸs
, 
tmp
, 
qgroups
, 
£q
,

2726 
UPDATE_OLD
);

2727 i‡(
ªt
 < 0)

2728 
out
;

2731 
ªt
 = 
	`qgroup_upd©e_ªf˙t
(
fs_öfo
, 
√w_roŸs
, 
tmp
, 
qgroups
, 
£q
,

2732 
UPDATE_NEW
);

2733 i‡(
ªt
 < 0)

2734 
out
;

2736 
	`qgroup_upd©e_cou¡îs
(
fs_öfo
, 
qgroups
, 
ƒ_ﬁd_roŸs
, 
ƒ_√w_roŸs
,

2737 
num_byãs
, 
£q
);

2742 
fs_öfo
->
qgroup_£q
 +
	`max
(
ƒ_ﬁd_roŸs
, 
ƒ_√w_roŸs
) + 1;

2743 
out
:

2744 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

2745 
out_‰ì
:

2746 
	`uli°_‰ì
(
tmp
);

2747 
	`uli°_‰ì
(
qgroups
);

2748 
	`uli°_‰ì
(
ﬁd_roŸs
);

2749 
	`uli°_‰ì
(
√w_roŸs
);

2750  
ªt
;

2751 
	}
}

2753 
	$båfs_qgroup_accou¡_exã¡s
(
båfs_å™s_h™dÀ
 *
å™s
)

2755 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2756 
båfs_qgroup_exã¡_ªc‹d
 *
ªc‹d
;

2757 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
;

2758 
uli°
 *
√w_roŸs
 = 
NULL
;

2759 
rb_node
 *
node
;

2760 
u64
 
num_dúty_exã¡s
 = 0;

2761 
u64
 
qgroup_to_skù
;

2762 
ªt
 = 0;

2764 
dñayed_ªfs
 = &
å™s
->
å™ß˘i⁄
->delayed_refs;

2765 
qgroup_to_skù
 = 
dñayed_ªfs
->qgroup_to_skip;

2766 (
node
 = 
	`rb_fú°
(&
dñayed_ªfs
->
dúty_exã¡_roŸ
))) {

2767 
ªc‹d
 = 
	`rb_íåy
(
node
, 
båfs_qgroup_exã¡_ªc‹d
,

2768 
node
);

2770 
num_dúty_exã¡s
++;

2771 
	`åa˚_båfs_qgroup_accou¡_exã¡s
(
fs_öfo
, 
ªc‹d
);

2773 i‡(!
ªt
 && !(
fs_öfo
->
qgroup_Êags
 &

2774 
BTRFS_QGROUP_RUNTIME_FLAG_NO_ACCOUNTING
)) {

2775 
båfs_backªf_wÆk_˘x
 
˘x
 = { 0 };

2777 
˘x
.
byãƒ
 = 
ªc‹d
->bytenr;

2778 
˘x
.
fs_öfo
 = fs_info;

2794 i‡(!
ªc‹d
->
ﬁd_roŸs
) {

2796 
ªt
 = 
	`båfs_föd_Æl_roŸs
(&
˘x
, 
Ál£
);

2797 i‡(
ªt
 < 0)

2798 
˛ónup
;

2799 
ªc‹d
->
ﬁd_roŸs
 = 
˘x
.
roŸs
;

2800 
˘x
.
roŸs
 = 
NULL
;

2804 
	`båfs_qgroup_‰ì_ª‰oŸ
(
fs_öfo
,

2805 
ªc‹d
->
d©a_rsv_ª‰oŸ
,

2806 
ªc‹d
->
d©a_rsv
,

2807 
BTRFS_QGROUP_RSV_DATA
);

2813 
˘x
.
å™s
 =Årans;

2814 
˘x
.
time_£q
 = 
BTRFS_SEQ_LAST
;

2815 
ªt
 = 
	`båfs_föd_Æl_roŸs
(&
˘x
, 
Ál£
);

2816 i‡(
ªt
 < 0)

2817 
˛ónup
;

2818 
√w_roŸs
 = 
˘x
.
roŸs
;

2819 i‡(
qgroup_to_skù
) {

2820 
	`uli°_dñ
(
√w_roŸs
, 
qgroup_to_skù
, 0);

2821 
	`uli°_dñ
(
ªc‹d
->
ﬁd_roŸs
, 
qgroup_to_skù
,

2824 
ªt
 = 
	`båfs_qgroup_accou¡_exã¡
(
å™s
, 
ªc‹d
->
byãƒ
,

2825 
ªc‹d
->
num_byãs
,

2826 
ªc‹d
->
ﬁd_roŸs
,

2827 
√w_roŸs
);

2828 
ªc‹d
->
ﬁd_roŸs
 = 
NULL
;

2829 
√w_roŸs
 = 
NULL
;

2831 
˛ónup
:

2832 
	`uli°_‰ì
(
ªc‹d
->
ﬁd_roŸs
);

2833 
	`uli°_‰ì
(
√w_roŸs
);

2834 
√w_roŸs
 = 
NULL
;

2835 
	`rb_îa£
(
node
, &
dñayed_ªfs
->
dúty_exã¡_roŸ
);

2836 
	`k‰ì
(
ªc‹d
);

2839 
	`åa˚_qgroup_num_dúty_exã¡s
(
fs_öfo
, 
å™s
->
å™sid
,

2840 
num_dúty_exã¡s
);

2841  
ªt
;

2842 
	}
}

2848 
	$båfs_run_qgroups
(
båfs_å™s_h™dÀ
 *
å™s
)

2850 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2851 
ªt
 = 0;

2858 i‡(
å™s
->
å™ß˘i⁄
->
°©e
 !
TRANS_STATE_COMMIT_DOING
)

2859 
	`lockdï_as£π_hñd
(&
fs_öfo
->
qgroup_io˘l_lock
);

2861 i‡(!
fs_öfo
->
quŸa_roŸ
)

2862  
ªt
;

2864 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

2865 !
	`li°_em±y
(&
fs_öfo
->
dúty_qgroups
)) {

2866 
båfs_qgroup
 *
qgroup
;

2867 
qgroup
 = 
	`li°_fú°_íåy
(&
fs_öfo
->
dúty_qgroups
,

2868 
båfs_qgroup
, 
dúty
);

2869 
	`li°_dñ_öô
(&
qgroup
->
dúty
);

2870 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

2871 
ªt
 = 
	`upd©e_qgroup_öfo_ôem
(
å™s
, 
qgroup
);

2872 i‡(
ªt
)

2873 
	`qgroup_m¨k_öc⁄si°ít
(
fs_öfo
);

2874 
ªt
 = 
	`upd©e_qgroup_limô_ôem
(
å™s
, 
qgroup
);

2875 i‡(
ªt
)

2876 
	`qgroup_m¨k_öc⁄si°ít
(
fs_öfo
);

2877 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

2879 i‡(
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
))

2880 
fs_öfo
->
qgroup_Êags
 |
BTRFS_QGROUP_STATUS_FLAG_ON
;

2882 
fs_öfo
->
qgroup_Êags
 &~
BTRFS_QGROUP_STATUS_FLAG_ON
;

2883 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

2885 
ªt
 = 
	`upd©e_qgroup_°©us_ôem
(
å™s
);

2886 i‡(
ªt
)

2887 
	`qgroup_m¨k_öc⁄si°ít
(
fs_öfo
);

2889  
ªt
;

2890 
	}
}

2898 
	$båfs_qgroup_öhîô
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
§cid
,

2899 
u64
 
obje˘id
, 
båfs_qgroup_öhîô
 *
öhîô
)

2901 
ªt
 = 0;

2902 
i
;

2903 
u64
 *
i_qgroups
;

2904 
boﬁ
 
commôtög
 = 
Ál£
;

2905 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2906 
båfs_roŸ
 *
quŸa_roŸ
;

2907 
båfs_qgroup
 *
§cgroup
;

2908 
båfs_qgroup
 *
d°group
;

2909 
boﬁ
 
√ed_ªsˇn
 = 
Ál£
;

2910 
u32
 
Àvñ_size
 = 0;

2911 
u64
 
nums
;

2925 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

2926 i‡(
å™s
->
å™ß˘i⁄
->
°©e
 =
TRANS_STATE_COMMIT_DOING
)

2927 
commôtög
 = 
åue
;

2928 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

2930 i‡(!
commôtög
)

2931 
	`muãx_lock
(&
fs_öfo
->
qgroup_io˘l_lock
);

2932 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
))

2933 
out
;

2935 
quŸa_roŸ
 = 
fs_öfo
->quota_root;

2936 i‡(!
quŸa_roŸ
) {

2937 
ªt
 = -
EINVAL
;

2938 
out
;

2941 i‡(
öhîô
) {

2942 
i_qgroups
 = (
u64
 *)(
öhîô
 + 1);

2943 
nums
 = 
öhîô
->
num_qgroups
 + 2 * inhîô->
num_ªf_c›õs
 +

2944 2 * 
öhîô
->
num_ex˛_c›õs
;

2945 
i
 = 0; i < 
nums
; ++i) {

2946 
§cgroup
 = 
	`föd_qgroup_rb
(
fs_öfo
, *
i_qgroups
);

2952 i‡(!
§cgroup
 ||

2953 ((
§cgroup
->
qgroupid
 >> 48Ë<(
obje˘id
 >> 48)))

2954 *
i_qgroups
 = 0ULL;

2956 ++
i_qgroups
;

2963 
ªt
 = 
	`add_qgroup_ôem
(
å™s
, 
quŸa_roŸ
, 
obje˘id
);

2964 i‡(
ªt
)

2965 
out
;

2970 i‡(
öhîô
) {

2971 
i_qgroups
 = (
u64
 *)(
öhîô
 + 1);

2972 
i
 = 0; i < 
öhîô
->
num_qgroups
; ++i, ++
i_qgroups
) {

2973 i‡(*
i_qgroups
 == 0)

2975 
ªt
 = 
	`add_qgroup_ªœti⁄_ôem
(
å™s
, 
obje˘id
,

2976 *
i_qgroups
);

2977 i‡(
ªt
 &&Ñë !-
EEXIST
)

2978 
out
;

2979 
ªt
 = 
	`add_qgroup_ªœti⁄_ôem
(
å™s
, *
i_qgroups
,

2980 
obje˘id
);

2981 i‡(
ªt
 &&Ñë !-
EEXIST
)

2982 
out
;

2984 
ªt
 = 0;

2988 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

2990 
d°group
 = 
	`add_qgroup_rb
(
fs_öfo
, 
obje˘id
);

2991 i‡(
	`IS_ERR
(
d°group
)) {

2992 
ªt
 = 
	`PTR_ERR
(
d°group
);

2993 
u∆ock
;

2996 i‡(
öhîô
 && inhîô->
Êags
 & 
BTRFS_QGROUP_INHERIT_SET_LIMITS
) {

2997 
d°group
->
lim_Êags
 = 
öhîô
->
lim
.
Êags
;

2998 
d°group
->
max_r„r
 = 
öhîô
->
lim
.max_rfer;

2999 
d°group
->
max_ex˛
 = 
öhîô
->
lim
.max_excl;

3000 
d°group
->
rsv_r„r
 = 
öhîô
->
lim
.rsv_rfer;

3001 
d°group
->
rsv_ex˛
 = 
öhîô
->
lim
.rsv_excl;

3003 
	`qgroup_dúty
(
fs_öfo
, 
d°group
);

3006 i‡(
§cid
) {

3007 
§cgroup
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
§cid
);

3008 i‡(!
§cgroup
)

3009 
u∆ock
;

3016 
Àvñ_size
 = 
fs_öfo
->
nodesize
;

3017 
d°group
->
r„r
 = 
§cgroup
->rfer;

3018 
d°group
->
r„r_cm¥
 = 
§cgroup
->rfer_cmpr;

3019 
d°group
->
ex˛
 = 
Àvñ_size
;

3020 
d°group
->
ex˛_cm¥
 = 
Àvñ_size
;

3021 
§cgroup
->
ex˛
 = 
Àvñ_size
;

3022 
§cgroup
->
ex˛_cm¥
 = 
Àvñ_size
;

3025 
d°group
->
lim_Êags
 = 
§cgroup
->lim_flags;

3026 
d°group
->
max_r„r
 = 
§cgroup
->max_rfer;

3027 
d°group
->
max_ex˛
 = 
§cgroup
->max_excl;

3028 
d°group
->
rsv_r„r
 = 
§cgroup
->rsv_rfer;

3029 
d°group
->
rsv_ex˛
 = 
§cgroup
->rsv_excl;

3031 
	`qgroup_dúty
(
fs_öfo
, 
d°group
);

3032 
	`qgroup_dúty
(
fs_öfo
, 
§cgroup
);

3035 i‡(!
öhîô
)

3036 
u∆ock
;

3038 
i_qgroups
 = (
u64
 *)(
öhîô
 + 1);

3039 
i
 = 0; i < 
öhîô
->
num_qgroups
; ++i) {

3040 i‡(*
i_qgroups
) {

3041 
ªt
 = 
	`add_ªœti⁄_rb
(
fs_öfo
, 
obje˘id
, *
i_qgroups
);

3042 i‡(
ªt
)

3043 
u∆ock
;

3045 ++
i_qgroups
;

3051 i‡(
§cid
)

3052 
√ed_ªsˇn
 = 
åue
;

3055 
i
 = 0; i < 
öhîô
->
num_ªf_c›õs
; ++i, 
i_qgroups
 += 2) {

3056 
båfs_qgroup
 *
§c
;

3057 
båfs_qgroup
 *
d°
;

3059 i‡(!
i_qgroups
[0] || !i_qgroups[1])

3062 
§c
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
i_qgroups
[0]);

3063 
d°
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
i_qgroups
[1]);

3065 i‡(!
§c
 || !
d°
) {

3066 
ªt
 = -
EINVAL
;

3067 
u∆ock
;

3070 
d°
->
r„r
 = 
§c
->r„∏- 
Àvñ_size
;

3071 
d°
->
r„r_cm¥
 = 
§c
->r„r_cm¥ - 
Àvñ_size
;

3074 
√ed_ªsˇn
 = 
åue
;

3076 
i
 = 0; i < 
öhîô
->
num_ex˛_c›õs
; ++i, 
i_qgroups
 += 2) {

3077 
båfs_qgroup
 *
§c
;

3078 
båfs_qgroup
 *
d°
;

3080 i‡(!
i_qgroups
[0] || !i_qgroups[1])

3083 
§c
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
i_qgroups
[0]);

3084 
d°
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
i_qgroups
[1]);

3086 i‡(!
§c
 || !
d°
) {

3087 
ªt
 = -
EINVAL
;

3088 
u∆ock
;

3091 
d°
->
ex˛
 = 
§c
->ex˛ + 
Àvñ_size
;

3092 
d°
->
ex˛_cm¥
 = 
§c
->ex˛_cm¥ + 
Àvñ_size
;

3093 
√ed_ªsˇn
 = 
åue
;

3096 
u∆ock
:

3097 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

3098 i‡(!
ªt
)

3099 
ªt
 = 
	`båfs_sysfs_add_⁄e_qgroup
(
fs_öfo
, 
d°group
);

3100 
out
:

3101 i‡(!
commôtög
)

3102 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_io˘l_lock
);

3103 i‡(
√ed_ªsˇn
)

3104 
	`qgroup_m¨k_öc⁄si°ít
(
fs_öfo
);

3105  
ªt
;

3106 
	}
}

3108 
boﬁ
 
	$qgroup_check_limôs
(c⁄° 
båfs_qgroup
 *
qg
, 
u64
 
num_byãs
)

3110 i‡((
qg
->
lim_Êags
 & 
BTRFS_QGROUP_LIMIT_MAX_RFER
) &&

3111 
	`qgroup_rsv_tŸÆ
(
qg
Ë+ (
s64
)qg->
r„r
 + 
num_byãs
 > qg->
max_r„r
)

3112  
Ál£
;

3114 i‡((
qg
->
lim_Êags
 & 
BTRFS_QGROUP_LIMIT_MAX_EXCL
) &&

3115 
	`qgroup_rsv_tŸÆ
(
qg
Ë+ (
s64
)qg->
ex˛
 + 
num_byãs
 > qg->
max_ex˛
)

3116  
Ál£
;

3118  
åue
;

3119 
	}
}

3121 
	$qgroup_ª£rve
(
båfs_roŸ
 *
roŸ
, 
u64
 
num_byãs
, 
boﬁ
 
íf‹˚
,

3122 
båfs_qgroup_rsv_ty≥
 
ty≥
)

3124 
båfs_qgroup
 *
qgroup
;

3125 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

3126 
u64
 
ªf_roŸ
 = 
roŸ
->
roŸ_key
.
obje˘id
;

3127 
ªt
 = 0;

3128 
uli°_node
 *
unode
;

3129 
uli°_ôî©‹
 
uôî
;

3131 i‡(!
	`is_f°ªe
(
ªf_roŸ
))

3134 i‡(
num_byãs
 == 0)

3137 i‡(
	`ã°_bô
(
BTRFS_FS_QUOTA_OVERRIDE
, &
fs_öfo
->
Êags
) &&

3138 
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
))

3139 
íf‹˚
 = 
Ál£
;

3141 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

3142 i‡(!
fs_öfo
->
quŸa_roŸ
)

3143 
out
;

3145 
qgroup
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
ªf_roŸ
);

3146 i‡(!
qgroup
)

3147 
out
;

3153 
	`uli°_ªöô
(
fs_öfo
->
qgroup_uli°
);

3154 
ªt
 = 
	`uli°_add
(
fs_öfo
->
qgroup_uli°
, 
qgroup
->
qgroupid
,

3155 
	`qgroup_to_aux
(
qgroup
), 
GFP_ATOMIC
);

3156 i‡(
ªt
 < 0)

3157 
out
;

3158 
	`ULIST_ITER_INIT
(&
uôî
);

3159 (
unode
 = 
	`uli°_√xt
(
fs_öfo
->
qgroup_uli°
, &
uôî
))) {

3160 
båfs_qgroup
 *
qg
;

3161 
båfs_qgroup_li°
 *
gli°
;

3163 
qg
 = 
	`unode_aux_to_qgroup
(
unode
);

3165 i‡(
íf‹˚
 && !
	`qgroup_check_limôs
(
qg
, 
num_byãs
)) {

3166 
ªt
 = -
EDQUOT
;

3167 
out
;

3170 
	`li°_f‹_óch_íåy
(
gli°
, &
qg
->
groups
, 
√xt_group
) {

3171 
ªt
 = 
	`uli°_add
(
fs_öfo
->
qgroup_uli°
,

3172 
gli°
->
group
->
qgroupid
,

3173 
	`qgroup_to_aux
(
gli°
->
group
), 
GFP_ATOMIC
);

3174 i‡(
ªt
 < 0)

3175 
out
;

3178 
ªt
 = 0;

3182 
	`ULIST_ITER_INIT
(&
uôî
);

3183 (
unode
 = 
	`uli°_√xt
(
fs_öfo
->
qgroup_uli°
, &
uôî
))) {

3184 
båfs_qgroup
 *
qg
;

3186 
qg
 = 
	`unode_aux_to_qgroup
(
unode
);

3188 
	`qgroup_rsv_add
(
fs_öfo
, 
qg
, 
num_byãs
, 
ty≥
);

3191 
out
:

3192 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

3193  
ªt
;

3194 
	}
}

3205 
	$båfs_qgroup_‰ì_ª‰oŸ
(
båfs_fs_öfo
 *
fs_öfo
,

3206 
u64
 
ªf_roŸ
, u64 
num_byãs
,

3207 
båfs_qgroup_rsv_ty≥
 
ty≥
)

3209 
båfs_qgroup
 *
qgroup
;

3210 
uli°_node
 *
unode
;

3211 
uli°_ôî©‹
 
uôî
;

3212 
ªt
 = 0;

3214 i‡(!
	`is_f°ªe
(
ªf_roŸ
))

3217 i‡(
num_byãs
 == 0)

3220 i‡(
num_byãs
 =(
u64
)-1 && 
ty≥
 !
BTRFS_QGROUP_RSV_META_PERTRANS
) {

3221 
	`WARN
(1, "%s: InvÆidÅy≥Åÿ‰ì", 
__func__
);

3224 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

3226 i‡(!
fs_öfo
->
quŸa_roŸ
)

3227 
out
;

3229 
qgroup
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
ªf_roŸ
);

3230 i‡(!
qgroup
)

3231 
out
;

3233 i‡(
num_byãs
 =(
u64
)-1)

3238 
num_byãs
 = 
qgroup
->
rsv
.
vÆues
[
ty≥
];

3240 
	`uli°_ªöô
(
fs_öfo
->
qgroup_uli°
);

3241 
ªt
 = 
	`uli°_add
(
fs_öfo
->
qgroup_uli°
, 
qgroup
->
qgroupid
,

3242 
	`qgroup_to_aux
(
qgroup
), 
GFP_ATOMIC
);

3243 i‡(
ªt
 < 0)

3244 
out
;

3245 
	`ULIST_ITER_INIT
(&
uôî
);

3246 (
unode
 = 
	`uli°_√xt
(
fs_öfo
->
qgroup_uli°
, &
uôî
))) {

3247 
båfs_qgroup
 *
qg
;

3248 
båfs_qgroup_li°
 *
gli°
;

3250 
qg
 = 
	`unode_aux_to_qgroup
(
unode
);

3252 
	`qgroup_rsv_ªÀa£
(
fs_öfo
, 
qg
, 
num_byãs
, 
ty≥
);

3254 
	`li°_f‹_óch_íåy
(
gli°
, &
qg
->
groups
, 
√xt_group
) {

3255 
ªt
 = 
	`uli°_add
(
fs_öfo
->
qgroup_uli°
,

3256 
gli°
->
group
->
qgroupid
,

3257 
	`qgroup_to_aux
(
gli°
->
group
), 
GFP_ATOMIC
);

3258 i‡(
ªt
 < 0)

3259 
out
;

3263 
out
:

3264 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

3265 
	}
}

3271 
boﬁ
 
	$is_œ°_Àaf
(
båfs_∑th
 *
∑th
)

3273 
i
;

3275 
i
 = 1; i < 
BTRFS_MAX_LEVEL
 && 
∑th
->
nodes
[i]; i++) {

3276 i‡(
∑th
->
¶Ÿs
[
i
] !
	`båfs_hódî_ƒôems
’©h->
nodes
[i]) - 1)

3277  
Ál£
;

3279  
åue
;

3280 
	}
}

3286 
	$qgroup_ªsˇn_Àaf
(
båfs_å™s_h™dÀ
 *
å™s
,

3287 
båfs_∑th
 *
∑th
)

3289 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

3290 
båfs_roŸ
 *
exã¡_roŸ
;

3291 
båfs_key
 
found
;

3292 
exã¡_buf„r
 *
s¸©ch_Àaf
 = 
NULL
;

3293 
u64
 
num_byãs
;

3294 
boﬁ
 
d⁄e
;

3295 
¶Ÿ
;

3296 
ªt
;

3298 
	`muãx_lock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3299 
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
,

3300 
fs_öfo
->
qgroup_ªsˇn_¥ogªss
.
obje˘id
);

3301 
ªt
 = 
	`båfs_£¨ch_¶Ÿ_f‹_ªad
(
exã¡_roŸ
,

3302 &
fs_öfo
->
qgroup_ªsˇn_¥ogªss
,

3303 
∑th
, 1, 0);

3305 
	`båfs_debug
(
fs_öfo
,

3307 
fs_öfo
->
qgroup_ªsˇn_¥ogªss
.
obje˘id
,

3308 
fs_öfo
->
qgroup_ªsˇn_¥ogªss
.
ty≥
,

3309 
fs_öfo
->
qgroup_ªsˇn_¥ogªss
.
off£t
, 
ªt
);

3311 i‡(
ªt
) {

3320 
fs_öfo
->
qgroup_ªsˇn_¥ogªss
.
obje˘id
 = (
u64
)-1;

3321 
	`båfs_ªÀa£_∑th
(
∑th
);

3322 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3323  
ªt
;

3325 
d⁄e
 = 
	`is_œ°_Àaf
(
∑th
);

3327 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
found
,

3328 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0]) - 1);

3329 
fs_öfo
->
qgroup_ªsˇn_¥ogªss
.
obje˘id
 = 
found
.objectid + 1;

3331 
s¸©ch_Àaf
 = 
	`båfs_˛⁄e_exã¡_buf„r
(
∑th
->
nodes
[0]);

3332 i‡(!
s¸©ch_Àaf
) {

3333 
ªt
 = -
ENOMEM
;

3334 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3335 
out
;

3337 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

3338 
	`båfs_ªÀa£_∑th
(
∑th
);

3339 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3341 ; 
¶Ÿ
 < 
	`båfs_hódî_ƒôems
(
s¸©ch_Àaf
); ++slot) {

3342 
båfs_backªf_wÆk_˘x
 
˘x
 = { 0 };

3344 
	`båfs_ôem_key_to_˝u
(
s¸©ch_Àaf
, &
found
, 
¶Ÿ
);

3345 i‡(
found
.
ty≥
 !
BTRFS_EXTENT_ITEM_KEY
 &&

3346 
found
.
ty≥
 !
BTRFS_METADATA_ITEM_KEY
)

3348 i‡(
found
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
)

3349 
num_byãs
 = 
fs_öfo
->
nodesize
;

3351 
num_byãs
 = 
found
.
off£t
;

3353 
˘x
.
byãƒ
 = 
found
.
obje˘id
;

3354 
˘x
.
fs_öfo
 = fs_info;

3356 
ªt
 = 
	`båfs_föd_Æl_roŸs
(&
˘x
, 
Ál£
);

3357 i‡(
ªt
 < 0)

3358 
out
;

3360 
ªt
 = 
	`båfs_qgroup_accou¡_exã¡
(
å™s
, 
found
.
obje˘id
,

3361 
num_byãs
, 
NULL
, 
˘x
.
roŸs
);

3362 i‡(
ªt
 < 0)

3363 
out
;

3365 
out
:

3366 i‡(
s¸©ch_Àaf
)

3367 
	`‰ì_exã¡_buf„r
(
s¸©ch_Àaf
);

3369 i‡(
d⁄e
 && !
ªt
) {

3370 
ªt
 = 1;

3371 
fs_öfo
->
qgroup_ªsˇn_¥ogªss
.
obje˘id
 = (
u64
)-1;

3373  
ªt
;

3374 
	}
}

3376 
boﬁ
 
	$ªsˇn_should_°›
(
båfs_fs_öfo
 *
fs_öfo
)

3378  
	`båfs_fs_˛osög
(
fs_öfo
) ||

3379 
	`ã°_bô
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_öfo
->
fs_°©e
) ||

3380 !
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
) ||

3381 
fs_öfo
->
qgroup_Êags
 & 
BTRFS_QGROUP_RUNTIME_FLAG_CANCEL_RESCAN
;

3382 
	}
}

3384 
	$båfs_qgroup_ªsˇn_w‹kî
(
båfs_w‹k
 *
w‹k
)

3386 
båfs_fs_öfo
 *
fs_öfo
 = 
	`c⁄èöî_of
(
w‹k
, btrfs_fs_info,

3387 
qgroup_ªsˇn_w‹k
);

3388 
båfs_∑th
 *
∑th
;

3389 
båfs_å™s_h™dÀ
 *
å™s
 = 
NULL
;

3390 
îr
 = -
ENOMEM
;

3391 
ªt
 = 0;

3392 
boﬁ
 
°›≥d
 = 
Ál£
;

3393 
boﬁ
 
did_Àaf_ªsˇns
 = 
Ál£
;

3395 
∑th
 = 
	`båfs_Æloc_∑th
();

3396 i‡(!
∑th
)

3397 
out
;

3402 
∑th
->
£¨ch_commô_roŸ
 = 1;

3403 
∑th
->
skù_lockög
 = 1;

3405 
îr
 = 0;

3406 !
îr
 && !(
°›≥d
 = 
	`ªsˇn_should_°›
(
fs_öfo
))) {

3407 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
fs_öfo
->
fs_roŸ
, 0);

3408 i‡(
	`IS_ERR
(
å™s
)) {

3409 
îr
 = 
	`PTR_ERR
(
å™s
);

3413 
îr
 = 
	`qgroup_ªsˇn_Àaf
(
å™s
, 
∑th
);

3414 
did_Àaf_ªsˇns
 = 
åue
;

3416 i‡(
îr
 > 0)

3417 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

3419 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

3422 
out
:

3423 
	`båfs_‰ì_∑th
(
∑th
);

3425 
	`muãx_lock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3426 i‡(
îr
 > 0 &&

3427 
fs_öfo
->
qgroup_Êags
 & 
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
) {

3428 
fs_öfo
->
qgroup_Êags
 &~
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

3429 } i‡(
îr
 < 0 || 
°›≥d
) {

3430 
fs_öfo
->
qgroup_Êags
 |
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

3432 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3441 i‡(
did_Àaf_ªsˇns
) {

3442 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
fs_öfo
->
quŸa_roŸ
, 1);

3443 i‡(
	`IS_ERR
(
å™s
)) {

3444 
îr
 = 
	`PTR_ERR
(
å™s
);

3445 
å™s
 = 
NULL
;

3446 
	`båfs_îr
(
fs_öfo
,

3448 
îr
);

3451 
å™s
 = 
NULL
;

3454 
	`muãx_lock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3455 i‡(!
°›≥d
 ||

3456 
fs_öfo
->
qgroup_Êags
 & 
BTRFS_QGROUP_RUNTIME_FLAG_CANCEL_RESCAN
)

3457 
fs_öfo
->
qgroup_Êags
 &~
BTRFS_QGROUP_STATUS_FLAG_RESCAN
;

3458 i‡(
å™s
) {

3459 
ªt
 = 
	`upd©e_qgroup_°©us_ôem
(
å™s
);

3460 i‡(
ªt
 < 0) {

3461 
îr
 = 
ªt
;

3462 
	`båfs_îr
(
fs_öfo
, "failÅo update qgroup status: %d",

3463 
îr
);

3466 
fs_öfo
->
qgroup_ªsˇn_ru¬ög
 = 
Ál£
;

3467 
fs_öfo
->
qgroup_Êags
 &~
BTRFS_QGROUP_RUNTIME_FLAG_CANCEL_RESCAN
;

3468 
	`com∂ëe_Æl
(&
fs_öfo
->
qgroup_ªsˇn_com∂ëi⁄
);

3469 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3471 i‡(!
å™s
)

3474 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

3476 i‡(
°›≥d
) {

3477 
	`båfs_öfo
(
fs_öfo
, "qgroup scanÖaused");

3478 } i‡(
fs_öfo
->
qgroup_Êags
 & 
BTRFS_QGROUP_RUNTIME_FLAG_CANCEL_RESCAN
) {

3479 
	`båfs_öfo
(
fs_öfo
, "qgroup scan cancelled");

3480 } i‡(
îr
 >= 0) {

3481 
	`båfs_öfo
(
fs_öfo
, "qgroup scan completed%s",

3482 
îr
 > 0 ? " (inconsistency flag cleared)" : "");

3484 
	`båfs_îr
(
fs_öfo
, "qgrou∞sˇ¿Áûed wôh %d", 
îr
);

3486 
	}
}

3493 
	$qgroup_ªsˇn_öô
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
¥ogªss_obje˘id
,

3494 
öô_Êags
)

3496 
ªt
 = 0;

3498 i‡(!
öô_Êags
) {

3500 i‡(!(
fs_öfo
->
qgroup_Êags
 &

3501 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
)) {

3502 
	`båfs_w¨n
(
fs_öfo
,

3504 
ªt
 = -
EINVAL
;

3505 } i‡(!(
fs_öfo
->
qgroup_Êags
 &

3506 
BTRFS_QGROUP_STATUS_FLAG_ON
)) {

3507 
	`båfs_w¨n
(
fs_öfo
,

3509 
ªt
 = -
EINVAL
;

3512 i‡(
ªt
)

3513  
ªt
;

3516 
	`muãx_lock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3518 i‡(
öô_Êags
) {

3519 i‡(
fs_öfo
->
qgroup_Êags
 & 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
) {

3520 
	`båfs_w¨n
(
fs_öfo
,

3522 
ªt
 = -
EINPROGRESS
;

3523 } i‡(!(
fs_öfo
->
qgroup_Êags
 &

3524 
BTRFS_QGROUP_STATUS_FLAG_ON
)) {

3525 
	`båfs_w¨n
(
fs_öfo
,

3527 
ªt
 = -
EINVAL
;

3528 } i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
)) {

3530 
ªt
 = -
EBUSY
;

3533 i‡(
ªt
) {

3534 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3535  
ªt
;

3537 
fs_öfo
->
qgroup_Êags
 |
BTRFS_QGROUP_STATUS_FLAG_RESCAN
;

3540 
	`mem£t
(&
fs_öfo
->
qgroup_ªsˇn_¥ogªss
, 0,

3541 (
fs_öfo
->
qgroup_ªsˇn_¥ogªss
));

3542 
fs_öfo
->
qgroup_Êags
 &~(
BTRFS_QGROUP_RUNTIME_FLAG_CANCEL_RESCAN
 |

3543 
BTRFS_QGROUP_RUNTIME_FLAG_NO_ACCOUNTING
);

3544 
fs_öfo
->
qgroup_ªsˇn_¥ogªss
.
obje˘id
 = 
¥ogªss_obje˘id
;

3545 
	`öô_com∂ëi⁄
(&
fs_öfo
->
qgroup_ªsˇn_com∂ëi⁄
);

3546 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3548 
	`båfs_öô_w‹k
(&
fs_öfo
->
qgroup_ªsˇn_w‹k
,

3549 
båfs_qgroup_ªsˇn_w‹kî
, 
NULL
, NULL);

3551 
	}
}

3554 
	$qgroup_ªsˇn_zîo_åackög
(
båfs_fs_öfo
 *
fs_öfo
)

3556 
rb_node
 *
n
;

3557 
båfs_qgroup
 *
qgroup
;

3559 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

3561 
n
 = 
	`rb_fú°
(&
fs_öfo
->
qgroup_åì
);Ç;Ç = 
	`rb_√xt
(n)) {

3562 
qgroup
 = 
	`rb_íåy
(
n
, 
båfs_qgroup
, 
node
);

3563 
qgroup
->
r„r
 = 0;

3564 
qgroup
->
r„r_cm¥
 = 0;

3565 
qgroup
->
ex˛
 = 0;

3566 
qgroup
->
ex˛_cm¥
 = 0;

3567 
	`qgroup_dúty
(
fs_öfo
, 
qgroup
);

3569 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

3570 
	}
}

3573 
	$båfs_qgroup_ªsˇn
(
båfs_fs_öfo
 *
fs_öfo
)

3575 
ªt
 = 0;

3576 
båfs_å™s_h™dÀ
 *
å™s
;

3578 
ªt
 = 
	`qgroup_ªsˇn_öô
(
fs_öfo
, 0, 1);

3579 i‡(
ªt
)

3580  
ªt
;

3593 
å™s
 = 
	`båfs_©èch_å™ß˘i⁄_b¨rõr
(
fs_öfo
->
fs_roŸ
);

3594 i‡(
	`IS_ERR
(
å™s
Ë&&Åøn†!
	`ERR_PTR
(-
ENOENT
)) {

3595 
fs_öfo
->
qgroup_Êags
 &~
BTRFS_QGROUP_STATUS_FLAG_RESCAN
;

3596  
	`PTR_ERR
(
å™s
);

3597 } i‡(
å™s
 !
	`ERR_PTR
(-
ENOENT
)) {

3598 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

3599 i‡(
ªt
) {

3600 
fs_öfo
->
qgroup_Êags
 &~
BTRFS_QGROUP_STATUS_FLAG_RESCAN
;

3601  
ªt
;

3605 
	`qgroup_ªsˇn_zîo_åackög
(
fs_öfo
);

3607 
	`muãx_lock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3608 
fs_öfo
->
qgroup_ªsˇn_ru¬ög
 = 
åue
;

3609 
	`båfs_queue_w‹k
(
fs_öfo
->
qgroup_ªsˇn_w‹kîs
,

3610 &
fs_öfo
->
qgroup_ªsˇn_w‹k
);

3611 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3614 
	}
}

3616 
	$båfs_qgroup_waô_f‹_com∂ëi⁄
(
båfs_fs_öfo
 *
fs_öfo
,

3617 
boﬁ
 
öãºu±ibÀ
)

3619 
ru¬ög
;

3620 
ªt
 = 0;

3622 
	`muãx_lock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3623 
ru¬ög
 = 
fs_öfo
->
qgroup_ªsˇn_ru¬ög
;

3624 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3626 i‡(!
ru¬ög
)

3629 i‡(
öãºu±ibÀ
)

3630 
ªt
 = 
	`waô_f‹_com∂ëi⁄_öãºu±ibÀ
(

3631 &
fs_öfo
->
qgroup_ªsˇn_com∂ëi⁄
);

3633 
	`waô_f‹_com∂ëi⁄
(&
fs_öfo
->
qgroup_ªsˇn_com∂ëi⁄
);

3635  
ªt
;

3636 
	}
}

3643 
	$båfs_qgroup_ªsˇn_ªsume
(
båfs_fs_öfo
 *
fs_öfo
)

3645 i‡(
fs_öfo
->
qgroup_Êags
 & 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
) {

3646 
	`muãx_lock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3647 
fs_öfo
->
qgroup_ªsˇn_ru¬ög
 = 
åue
;

3648 
	`båfs_queue_w‹k
(
fs_öfo
->
qgroup_ªsˇn_w‹kîs
,

3649 &
fs_öfo
->
qgroup_ªsˇn_w‹k
);

3650 
	`muãx_u∆ock
(&
fs_öfo
->
qgroup_ªsˇn_lock
);

3652 
	}
}

3654 
	#rbåì_ôî©e_‰om_ß„
(
node
, 
√xt
, 
°¨t
) \

3655 
node
 = 
°¨t
;Çodê&& ({ 
√xt
 = 
	`rb_√xt
“ode); 1;});Çodê√xt)

	)

3657 
	$qgroup_uƒe£rve_ønge
(
båfs_öode
 *
öode
,

3658 
exã¡_ch™ge£t
 *
ª£rved
, 
u64
 
°¨t
,

3659 
u64
 
Àn
)

3661 
rb_node
 *
node
;

3662 
rb_node
 *
√xt
;

3663 
uli°_node
 *
íåy
;

3664 
ªt
 = 0;

3666 
node
 = 
ª£rved
->
ønge_ch™ged
.
roŸ
.
rb_node
;

3667 i‡(!
node
)

3669 
node
) {

3670 
íåy
 = 
	`rb_íåy
(
node
, 
uli°_node
, 
rb_node
);

3671 i‡(
íåy
->
vÆ
 < 
°¨t
)

3672 
node
 =Çode->
rb_right
;

3674 
node
 =Çode->
rb_À·
;

3677 i‡(
íåy
->
vÆ
 > 
°¨t
 && 
	`rb_¥ev
(&íåy->
rb_node
))

3678 
íåy
 = 
	`rb_íåy
(
	`rb_¥ev
(&íåy->
rb_node
), 
uli°_node
,

3679 
rb_node
);

3681 
	`rbåì_ôî©e_‰om_ß„
(
node
, 
√xt
, &
íåy
->
rb_node
) {

3682 
u64
 
íåy_°¨t
;

3683 
u64
 
íåy_íd
;

3684 
u64
 
íåy_Àn
;

3685 
˛ór_ªt
;

3687 
íåy
 = 
	`rb_íåy
(
node
, 
uli°_node
, 
rb_node
);

3688 
íåy_°¨t
 = 
íåy
->
vÆ
;

3689 
íåy_íd
 = 
íåy
->
aux
;

3690 
íåy_Àn
 = 
íåy_íd
 - 
íåy_°¨t
 + 1;

3692 i‡(
íåy_°¨t
 >
°¨t
 + 
Àn
)

3694 i‡(
íåy_°¨t
 + 
íåy_Àn
 <
°¨t
)

3700 
˛ór_ªt
 = 
	`˛ór_exã¡_bôs
(&
öode
->
io_åì
, 
íåy_°¨t
,

3701 
íåy_íd
, 
EXTENT_QGROUP_RESERVED
);

3702 i‡(!
ªt
 && 
˛ór_ªt
 < 0)

3703 
ªt
 = 
˛ór_ªt
;

3705 
	`uli°_dñ
(&
ª£rved
->
ønge_ch™ged
, 
íåy
->
vÆ
,É¡ry->
aux
);

3706 i‡(
	`likñy
(
ª£rved
->
byãs_ch™ged
 >
íåy_Àn
)) {

3707 
ª£rved
->
byãs_ch™ged
 -
íåy_Àn
;

3709 
	`WARN_ON
(1);

3710 
ª£rved
->
byãs_ch™ged
 = 0;

3714  
ªt
;

3715 
	}
}

3736 
	$åy_Êush_qgroup
(
båfs_roŸ
 *
roŸ
)

3738 
båfs_å™s_h™dÀ
 *
å™s
;

3739 
ªt
;

3742 
	`ASSERT
(
cuºít
->
jou∫Æ_öfo
 =
NULL
);

3743 i‡(
	`WARN_ON
(
cuºít
->
jou∫Æ_öfo
))

3750 i‡(
	`ã°_™d_£t_bô
(
BTRFS_ROOT_QGROUP_FLUSHING
, &
roŸ
->
°©e
)) {

3751 
	`waô_evít
(
roŸ
->
qgroup_Êush_waô
,

3752 !
	`ã°_bô
(
BTRFS_ROOT_QGROUP_FLUSHING
, &
roŸ
->
°©e
));

3756 
ªt
 = 
	`båfs_°¨t_dñÆloc_¢≠shŸ
(
roŸ
, 
åue
);

3757 i‡(
ªt
 < 0)

3758 
out
;

3759 
	`båfs_waô_‹dîed_exã¡s
(
roŸ
, 
U64_MAX
, 0, (
u64
)-1);

3761 
å™s
 = 
	`båfs_©èch_å™ß˘i⁄_b¨rõr
(
roŸ
);

3762 i‡(
	`IS_ERR
(
å™s
)) {

3763 
ªt
 = 
	`PTR_ERR
(
å™s
);

3764 i‡(
ªt
 =-
ENOENT
)

3765 
ªt
 = 0;

3766 
out
;

3769 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

3770 
out
:

3771 
	`˛ór_bô
(
BTRFS_ROOT_QGROUP_FLUSHING
, &
roŸ
->
°©e
);

3772 
	`wake_up
(&
roŸ
->
qgroup_Êush_waô
);

3773  
ªt
;

3774 
	}
}

3776 
	$qgroup_ª£rve_d©a
(
båfs_öode
 *
öode
,

3777 
exã¡_ch™ge£t
 **
ª£rved_ªt
, 
u64
 
°¨t
,

3778 
u64
 
Àn
)

3780 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

3781 
exã¡_ch™ge£t
 *
ª£rved
;

3782 
boﬁ
 
√w_ª£rved
 = 
Ál£
;

3783 
u64
 
‹ig_ª£rved
;

3784 
u64
 
to_ª£rve
;

3785 
ªt
;

3787 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
roŸ
->
fs_öfo
->
Êags
) ||

3788 !
	`is_f°ªe
(
roŸ
->
roŸ_key
.
obje˘id
Ë|| 
Àn
 == 0)

3792 i‡(
	`WARN_ON
(!
ª£rved_ªt
))

3793  -
EINVAL
;

3794 i‡(!*
ª£rved_ªt
) {

3795 
√w_ª£rved
 = 
åue
;

3796 *
ª£rved_ªt
 = 
	`exã¡_ch™ge£t_Æloc
();

3797 i‡(!*
ª£rved_ªt
)

3798  -
ENOMEM
;

3800 
ª£rved
 = *
ª£rved_ªt
;

3802 
‹ig_ª£rved
 = 
ª£rved
->
byãs_ch™ged
;

3803 
ªt
 = 
	`£t_ªc‹d_exã¡_bôs
(&
öode
->
io_åì
, 
°¨t
,

3804 
°¨t
 + 
Àn
 -1, 
EXTENT_QGROUP_RESERVED
, 
ª£rved
);

3807 
to_ª£rve
 = 
ª£rved
->
byãs_ch™ged
 - 
‹ig_ª£rved
;

3808 
	`åa˚_båfs_qgroup_ª£rve_d©a
(&
öode
->
vfs_öode
, 
°¨t
, 
Àn
,

3809 
to_ª£rve
, 
QGROUP_RESERVE
);

3810 i‡(
ªt
 < 0)

3811 
out
;

3812 
ªt
 = 
	`qgroup_ª£rve
(
roŸ
, 
to_ª£rve
, 
åue
, 
BTRFS_QGROUP_RSV_DATA
);

3813 i‡(
ªt
 < 0)

3814 
˛ónup
;

3816  
ªt
;

3818 
˛ónup
:

3819 
	`qgroup_uƒe£rve_ønge
(
öode
, 
ª£rved
, 
°¨t
, 
Àn
);

3820 
out
:

3821 i‡(
√w_ª£rved
) {

3822 
	`exã¡_ch™ge£t_‰ì
(
ª£rved
);

3823 *
ª£rved_ªt
 = 
NULL
;

3825  
ªt
;

3826 
	}
}

3840 
	$båfs_qgroup_ª£rve_d©a
(
båfs_öode
 *
öode
,

3841 
exã¡_ch™ge£t
 **
ª£rved_ªt
, 
u64
 
°¨t
,

3842 
u64
 
Àn
)

3844 
ªt
;

3846 
ªt
 = 
	`qgroup_ª£rve_d©a
(
öode
, 
ª£rved_ªt
, 
°¨t
, 
Àn
);

3847 i‡(
ªt
 <0 &&Ñë !-
EDQUOT
)

3848  
ªt
;

3850 
ªt
 = 
	`åy_Êush_qgroup
(
öode
->
roŸ
);

3851 i‡(
ªt
 < 0)

3852  
ªt
;

3853  
	`qgroup_ª£rve_d©a
(
öode
, 
ª£rved_ªt
, 
°¨t
, 
Àn
);

3854 
	}
}

3857 
	$qgroup_‰ì_ª£rved_d©a
(
båfs_öode
 *
öode
,

3858 
exã¡_ch™ge£t
 *
ª£rved
,

3859 
u64
 
°¨t
, u64 
Àn
, u64 *
‰ìd_ªt
)

3861 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

3862 
uli°_node
 *
unode
;

3863 
uli°_ôî©‹
 
uôî
;

3864 
exã¡_ch™ge£t
 
ch™ge£t
;

3865 
u64
 
‰ìd
 = 0;

3866 
ªt
;

3868 
	`exã¡_ch™ge£t_öô
(&
ch™ge£t
);

3869 
Àn
 = 
	`round_up
(
°¨t
 +Üí, 
roŸ
->
fs_öfo
->
£˘‹size
);

3870 
°¨t
 = 
	`round_down
(°¨t, 
roŸ
->
fs_öfo
->
£˘‹size
);

3872 
	`ULIST_ITER_INIT
(&
uôî
);

3873 (
unode
 = 
	`uli°_√xt
(&
ª£rved
->
ønge_ch™ged
, &
uôî
))) {

3874 
u64
 
ønge_°¨t
 = 
unode
->
vÆ
;

3876 
u64
 
ønge_Àn
 = 
unode
->
aux
 - 
ønge_°¨t
 + 1;

3877 
u64
 
‰ì_°¨t
;

3878 
u64
 
‰ì_Àn
;

3880 
	`exã¡_ch™ge£t_ªÀa£
(&
ch™ge£t
);

3883 i‡(
ønge_°¨t
 >
°¨t
 + 
Àn
 ||

3884 
ønge_°¨t
 + 
ønge_Àn
 <
°¨t
)

3886 
‰ì_°¨t
 = 
	`max
(
ønge_°¨t
, 
°¨t
);

3887 
‰ì_Àn
 = 
	`mö
(
°¨t
 + 
Àn
, 
ønge_°¨t
 + 
ønge_Àn
) -

3888 
‰ì_°¨t
;

3897 
ªt
 = 
	`˛ór_ªc‹d_exã¡_bôs
(&
öode
->
io_åì
, 
‰ì_°¨t
,

3898 
‰ì_°¨t
 + 
‰ì_Àn
 - 1,

3899 
EXTENT_QGROUP_RESERVED
, &
ch™ge£t
);

3900 i‡(
ªt
 < 0)

3901 
out
;

3902 
‰ìd
 +
ch™ge£t
.
byãs_ch™ged
;

3904 
	`båfs_qgroup_‰ì_ª‰oŸ
(
roŸ
->
fs_öfo
,ÑoŸ->
roŸ_key
.
obje˘id
, 
‰ìd
,

3905 
BTRFS_QGROUP_RSV_DATA
);

3906 i‡(
‰ìd_ªt
)

3907 *
‰ìd_ªt
 = 
‰ìd
;

3908 
ªt
 = 0;

3909 
out
:

3910 
	`exã¡_ch™ge£t_ªÀa£
(&
ch™ge£t
);

3911  
ªt
;

3912 
	}
}

3914 
	$__båfs_qgroup_ªÀa£_d©a
(
båfs_öode
 *
öode
,

3915 
exã¡_ch™ge£t
 *
ª£rved
, 
u64
 
°¨t
, u64 
Àn
,

3916 
u64
 *
ªÀa£d
, 
‰ì
)

3918 
exã¡_ch™ge£t
 
ch™ge£t
;

3919 
åa˚_›
 = 
QGROUP_RELEASE
;

3920 
ªt
;

3922 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
öode
->
roŸ
->
fs_öfo
->
Êags
))

3926 
	`WARN_ON
(!
‰ì
 && 
ª£rved
);

3927 i‡(
‰ì
 && 
ª£rved
)

3928  
	`qgroup_‰ì_ª£rved_d©a
(
öode
, 
ª£rved
, 
°¨t
, 
Àn
, 
ªÀa£d
);

3929 
	`exã¡_ch™ge£t_öô
(&
ch™ge£t
);

3930 
ªt
 = 
	`˛ór_ªc‹d_exã¡_bôs
(&
öode
->
io_åì
, 
°¨t
, sèπ + 
Àn
 -1,

3931 
EXTENT_QGROUP_RESERVED
, &
ch™ge£t
);

3932 i‡(
ªt
 < 0)

3933 
out
;

3935 i‡(
‰ì
)

3936 
åa˚_›
 = 
QGROUP_FREE
;

3937 
	`åa˚_båfs_qgroup_ªÀa£_d©a
(&
öode
->
vfs_öode
, 
°¨t
, 
Àn
,

3938 
ch™ge£t
.
byãs_ch™ged
, 
åa˚_›
);

3939 i‡(
‰ì
)

3940 
	`båfs_qgroup_‰ì_ª‰oŸ
(
öode
->
roŸ
->
fs_öfo
,

3941 
öode
->
roŸ
->
roŸ_key
.
obje˘id
,

3942 
ch™ge£t
.
byãs_ch™ged
, 
BTRFS_QGROUP_RSV_DATA
);

3943 i‡(
ªÀa£d
)

3944 *
ªÀa£d
 = 
ch™ge£t
.
byãs_ch™ged
;

3945 
out
:

3946 
	`exã¡_ch™ge£t_ªÀa£
(&
ch™ge£t
);

3947  
ªt
;

3948 
	}
}

3962 
	$båfs_qgroup_‰ì_d©a
(
båfs_öode
 *
öode
,

3963 
exã¡_ch™ge£t
 *
ª£rved
,

3964 
u64
 
°¨t
, u64 
Àn
, u64 *
‰ìd
)

3966  
	`__båfs_qgroup_ªÀa£_d©a
(
öode
, 
ª£rved
, 
°¨t
, 
Àn
, 
‰ìd
, 1);

3967 
	}
}

3984 
	$båfs_qgroup_ªÀa£_d©a
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
Àn
, u64 *
ªÀa£d
)

3986  
	`__båfs_qgroup_ªÀa£_d©a
(
öode
, 
NULL
, 
°¨t
, 
Àn
, 
ªÀa£d
, 0);

3987 
	}
}

3989 
	$add_roŸ_mëa_rsv
(
båfs_roŸ
 *
roŸ
, 
num_byãs
,

3990 
båfs_qgroup_rsv_ty≥
 
ty≥
)

3992 i‡(
ty≥
 !
BTRFS_QGROUP_RSV_META_PREALLOC
 &&

3993 
ty≥
 !
BTRFS_QGROUP_RSV_META_PERTRANS
)

3995 i‡(
num_byãs
 == 0)

3998 
	`•ö_lock
(&
roŸ
->
qgroup_mëa_rsv_lock
);

3999 i‡(
ty≥
 =
BTRFS_QGROUP_RSV_META_PREALLOC
)

4000 
roŸ
->
qgroup_mëa_rsv_¥óŒoc
 +
num_byãs
;

4002 
roŸ
->
qgroup_mëa_rsv_≥πøns
 +
num_byãs
;

4003 
	`•ö_u∆ock
(&
roŸ
->
qgroup_mëa_rsv_lock
);

4004 
	}
}

4006 
	$sub_roŸ_mëa_rsv
(
båfs_roŸ
 *
roŸ
, 
num_byãs
,

4007 
båfs_qgroup_rsv_ty≥
 
ty≥
)

4009 i‡(
ty≥
 !
BTRFS_QGROUP_RSV_META_PREALLOC
 &&

4010 
ty≥
 !
BTRFS_QGROUP_RSV_META_PERTRANS
)

4012 i‡(
num_byãs
 == 0)

4015 
	`•ö_lock
(&
roŸ
->
qgroup_mëa_rsv_lock
);

4016 i‡(
ty≥
 =
BTRFS_QGROUP_RSV_META_PREALLOC
) {

4017 
num_byãs
 = 
	`mö_t
(
u64
, 
roŸ
->
qgroup_mëa_rsv_¥óŒoc
,

4018 
num_byãs
);

4019 
roŸ
->
qgroup_mëa_rsv_¥óŒoc
 -
num_byãs
;

4021 
num_byãs
 = 
	`mö_t
(
u64
, 
roŸ
->
qgroup_mëa_rsv_≥πøns
,

4022 
num_byãs
);

4023 
roŸ
->
qgroup_mëa_rsv_≥πøns
 -
num_byãs
;

4025 
	`•ö_u∆ock
(&
roŸ
->
qgroup_mëa_rsv_lock
);

4026  
num_byãs
;

4027 
	}
}

4029 
	$båfs_qgroup_ª£rve_mëa
(
båfs_roŸ
 *
roŸ
, 
num_byãs
,

4030 
båfs_qgroup_rsv_ty≥
 
ty≥
, 
boﬁ
 
íf‹˚
)

4032 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4033 
ªt
;

4035 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
) ||

4036 !
	`is_f°ªe
(
roŸ
->
roŸ_key
.
obje˘id
Ë|| 
num_byãs
 == 0)

4039 
	`BUG_ON
(
num_byãs
 !
	`round_down
“um_byãs, 
fs_öfo
->
nodesize
));

4040 
	`åa˚_qgroup_mëa_ª£rve
(
roŸ
, (
s64
)
num_byãs
, 
ty≥
);

4041 
ªt
 = 
	`qgroup_ª£rve
(
roŸ
, 
num_byãs
, 
íf‹˚
, 
ty≥
);

4042 i‡(
ªt
 < 0)

4043  
ªt
;

4052 
	`add_roŸ_mëa_rsv
(
roŸ
, 
num_byãs
, 
ty≥
);

4053  
ªt
;

4054 
	}
}

4056 
	$__båfs_qgroup_ª£rve_mëa
(
båfs_roŸ
 *
roŸ
, 
num_byãs
,

4057 
båfs_qgroup_rsv_ty≥
 
ty≥
, 
boﬁ
 
íf‹˚
,

4058 
boﬁ
 
noÊush
)

4060 
ªt
;

4062 
ªt
 = 
	`båfs_qgroup_ª£rve_mëa
(
roŸ
, 
num_byãs
, 
ty≥
, 
íf‹˚
);

4063 i‡((
ªt
 <0 &&Ñë !-
EDQUOT
Ë|| 
noÊush
)

4064  
ªt
;

4066 
ªt
 = 
	`åy_Êush_qgroup
(
roŸ
);

4067 i‡(
ªt
 < 0)

4068  
ªt
;

4069  
	`båfs_qgroup_ª£rve_mëa
(
roŸ
, 
num_byãs
, 
ty≥
, 
íf‹˚
);

4070 
	}
}

4072 
	$båfs_qgroup_‰ì_mëa_Æl_≥πøns
(
båfs_roŸ
 *
roŸ
)

4074 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4076 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
) ||

4077 !
	`is_f°ªe
(
roŸ
->
roŸ_key
.
obje˘id
))

4081 
	`åa˚_qgroup_mëa_‰ì_Æl_≥πøns
(
roŸ
);

4083 
	`båfs_qgroup_‰ì_ª‰oŸ
(
fs_öfo
, 
roŸ
->
roŸ_key
.
obje˘id
, (
u64
)-1,

4084 
BTRFS_QGROUP_RSV_META_PERTRANS
);

4085 
	}
}

4087 
	$__båfs_qgroup_‰ì_mëa
(
båfs_roŸ
 *
roŸ
, 
num_byãs
,

4088 
båfs_qgroup_rsv_ty≥
 
ty≥
)

4090 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4092 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
) ||

4093 !
	`is_f°ªe
(
roŸ
->
roŸ_key
.
obje˘id
))

4101 
num_byãs
 = 
	`sub_roŸ_mëa_rsv
(
roŸ
,Çum_byãs, 
ty≥
);

4102 
	`BUG_ON
(
num_byãs
 !
	`round_down
“um_byãs, 
fs_öfo
->
nodesize
));

4103 
	`åa˚_qgroup_mëa_ª£rve
(
roŸ
, -(
s64
)
num_byãs
, 
ty≥
);

4104 
	`båfs_qgroup_‰ì_ª‰oŸ
(
fs_öfo
, 
roŸ
->
roŸ_key
.
obje˘id
,

4105 
num_byãs
, 
ty≥
);

4106 
	}
}

4108 
	$qgroup_c⁄vît_mëa
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
ªf_roŸ
,

4109 
num_byãs
)

4111 
båfs_qgroup
 *
qgroup
;

4112 
uli°_node
 *
unode
;

4113 
uli°_ôî©‹
 
uôî
;

4114 
ªt
 = 0;

4116 i‡(
num_byãs
 == 0)

4118 i‡(!
fs_öfo
->
quŸa_roŸ
)

4121 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

4122 
qgroup
 = 
	`föd_qgroup_rb
(
fs_öfo
, 
ªf_roŸ
);

4123 i‡(!
qgroup
)

4124 
out
;

4125 
	`uli°_ªöô
(
fs_öfo
->
qgroup_uli°
);

4126 
ªt
 = 
	`uli°_add
(
fs_öfo
->
qgroup_uli°
, 
qgroup
->
qgroupid
,

4127 
	`qgroup_to_aux
(
qgroup
), 
GFP_ATOMIC
);

4128 i‡(
ªt
 < 0)

4129 
out
;

4130 
	`ULIST_ITER_INIT
(&
uôî
);

4131 (
unode
 = 
	`uli°_√xt
(
fs_öfo
->
qgroup_uli°
, &
uôî
))) {

4132 
båfs_qgroup
 *
qg
;

4133 
båfs_qgroup_li°
 *
gli°
;

4135 
qg
 = 
	`unode_aux_to_qgroup
(
unode
);

4137 
	`qgroup_rsv_ªÀa£
(
fs_öfo
, 
qg
, 
num_byãs
,

4138 
BTRFS_QGROUP_RSV_META_PREALLOC
);

4139 
	`qgroup_rsv_add
(
fs_öfo
, 
qg
, 
num_byãs
,

4140 
BTRFS_QGROUP_RSV_META_PERTRANS
);

4141 
	`li°_f‹_óch_íåy
(
gli°
, &
qg
->
groups
, 
√xt_group
) {

4142 
ªt
 = 
	`uli°_add
(
fs_öfo
->
qgroup_uli°
,

4143 
gli°
->
group
->
qgroupid
,

4144 
	`qgroup_to_aux
(
gli°
->
group
), 
GFP_ATOMIC
);

4145 i‡(
ªt
 < 0)

4146 
out
;

4149 
out
:

4150 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

4151 
	}
}

4153 
	$båfs_qgroup_c⁄vît_ª£rved_mëa
(
båfs_roŸ
 *
roŸ
, 
num_byãs
)

4155 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4157 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
) ||

4158 !
	`is_f°ªe
(
roŸ
->
roŸ_key
.
obje˘id
))

4161 
num_byãs
 = 
	`sub_roŸ_mëa_rsv
(
roŸ
,Çum_bytes,

4162 
BTRFS_QGROUP_RSV_META_PREALLOC
);

4163 
	`åa˚_qgroup_mëa_c⁄vît
(
roŸ
, 
num_byãs
);

4164 
	`qgroup_c⁄vît_mëa
(
fs_öfo
, 
roŸ
->
roŸ_key
.
obje˘id
, 
num_byãs
);

4165 
	}
}

4171 
	$båfs_qgroup_check_ª£rved_Àak
(
båfs_öode
 *
öode
)

4173 
exã¡_ch™ge£t
 
ch™ge£t
;

4174 
uli°_node
 *
unode
;

4175 
uli°_ôî©‹
 
ôî
;

4176 
ªt
;

4178 
	`exã¡_ch™ge£t_öô
(&
ch™ge£t
);

4179 
ªt
 = 
	`˛ór_ªc‹d_exã¡_bôs
(&
öode
->
io_åì
, 0, (
u64
)-1,

4180 
EXTENT_QGROUP_RESERVED
, &
ch™ge£t
);

4182 
	`WARN_ON
(
ªt
 < 0);

4183 i‡(
	`WARN_ON
(
ch™ge£t
.
byãs_ch™ged
)) {

4184 
	`ULIST_ITER_INIT
(&
ôî
);

4185 (
unode
 = 
	`uli°_√xt
(&
ch™ge£t
.
ønge_ch™ged
, &
ôî
))) {

4186 
	`båfs_w¨n
(
öode
->
roŸ
->
fs_öfo
,

4188 
	`båfs_öo
(
öode
), 
unode
->
vÆ
, unode->
aux
);

4190 
	`båfs_qgroup_‰ì_ª‰oŸ
(
öode
->
roŸ
->
fs_öfo
,

4191 
öode
->
roŸ
->
roŸ_key
.
obje˘id
,

4192 
ch™ge£t
.
byãs_ch™ged
, 
BTRFS_QGROUP_RSV_DATA
);

4195 
	`exã¡_ch™ge£t_ªÀa£
(&
ch™ge£t
);

4196 
	}
}

4198 
	$båfs_qgroup_öô_sw≠≥d_blocks
(

4199 
båfs_qgroup_sw≠≥d_blocks
 *
sw≠≥d_blocks
)

4201 
i
;

4203 
	`•ö_lock_öô
(&
sw≠≥d_blocks
->
lock
);

4204 
i
 = 0; i < 
BTRFS_MAX_LEVEL
; i++)

4205 
sw≠≥d_blocks
->
blocks
[
i
] = 
RB_ROOT
;

4206 
sw≠≥d_blocks
->
sw≠≥d
 = 
Ál£
;

4207 
	}
}

4215 
	$båfs_qgroup_˛ón_sw≠≥d_blocks
(
båfs_roŸ
 *
roŸ
)

4217 
båfs_qgroup_sw≠≥d_blocks
 *
sw≠≥d_blocks
;

4218 
i
;

4220 
sw≠≥d_blocks
 = &
roŸ
->swapped_blocks;

4222 
	`•ö_lock
(&
sw≠≥d_blocks
->
lock
);

4223 i‡(!
sw≠≥d_blocks
->
sw≠≥d
)

4224 
out
;

4225 
i
 = 0; i < 
BTRFS_MAX_LEVEL
; i++) {

4226 
rb_roŸ
 *
cur_roŸ
 = &
sw≠≥d_blocks
->
blocks
[
i
];

4227 
båfs_qgroup_sw≠≥d_block
 *
íåy
;

4228 
båfs_qgroup_sw≠≥d_block
 *
√xt
;

4230 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
íåy
, 
√xt
, 
cur_roŸ
,

4231 
node
)

4232 
	`k‰ì
(
íåy
);

4233 
sw≠≥d_blocks
->
blocks
[
i
] = 
RB_ROOT
;

4235 
sw≠≥d_blocks
->
sw≠≥d
 = 
Ál£
;

4236 
out
:

4237 
	`•ö_u∆ock
(&
sw≠≥d_blocks
->
lock
);

4238 
	}
}

4250 
	$båfs_qgroup_add_sw≠≥d_blocks
(
båfs_å™s_h™dÀ
 *
å™s
,

4251 
båfs_roŸ
 *
subvﬁ_roŸ
,

4252 
båfs_block_group
 *
bg
,

4253 
exã¡_buf„r
 *
subvﬁ_∑ª¡
, 
subvﬁ_¶Ÿ
,

4254 
exã¡_buf„r
 *
ªloc_∑ª¡
, 
ªloc_¶Ÿ
,

4255 
u64
 
œ°_¢≠shŸ
)

4257 
båfs_fs_öfo
 *
fs_öfo
 = 
subvﬁ_roŸ
->fs_info;

4258 
båfs_qgroup_sw≠≥d_blocks
 *
blocks
 = &
subvﬁ_roŸ
->
sw≠≥d_blocks
;

4259 
båfs_qgroup_sw≠≥d_block
 *
block
;

4260 
rb_node
 **
cur
;

4261 
rb_node
 *
∑ª¡
 = 
NULL
;

4262 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
subvﬁ_∑ª¡
) - 1;

4263 
ªt
 = 0;

4265 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
))

4268 i‡(
	`båfs_node_±r_gíî©i⁄
(
subvﬁ_∑ª¡
, 
subvﬁ_¶Ÿ
) >

4269 
	`båfs_node_±r_gíî©i⁄
(
ªloc_∑ª¡
, 
ªloc_¶Ÿ
)) {

4270 
	`båfs_îr_æ
(
fs_öfo
,

4272 
__func__
,

4273 
	`båfs_node_±r_gíî©i⁄
(
subvﬁ_∑ª¡
, 
subvﬁ_¶Ÿ
),

4274 
	`båfs_node_±r_gíî©i⁄
(
ªloc_∑ª¡
, 
ªloc_¶Ÿ
));

4275  -
EUCLEAN
;

4278 
block
 = 
	`kmÆloc
((*block), 
GFP_NOFS
);

4279 i‡(!
block
) {

4280 
ªt
 = -
ENOMEM
;

4281 
out
;

4288 
block
->
subvﬁ_byãƒ
 = 
	`båfs_node_block±r
(
ªloc_∑ª¡
, 
ªloc_¶Ÿ
);

4289 
block
->
subvﬁ_gíî©i⁄
 = 
	`båfs_node_±r_gíî©i⁄
(
ªloc_∑ª¡
,

4290 
ªloc_¶Ÿ
);

4291 
block
->
ªloc_byãƒ
 = 
	`båfs_node_block±r
(
subvﬁ_∑ª¡
, 
subvﬁ_¶Ÿ
);

4292 
block
->
ªloc_gíî©i⁄
 = 
	`båfs_node_±r_gíî©i⁄
(
subvﬁ_∑ª¡
,

4293 
subvﬁ_¶Ÿ
);

4294 
block
->
œ°_¢≠shŸ
 =Üast_snapshot;

4295 
block
->
Àvñ
 =Üevel;

4302 i‡(
bg
 && bg->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
)

4303 
block
->
åa˚_Àaf
 = 
åue
;

4305 
block
->
åa˚_Àaf
 = 
Ál£
;

4306 
	`båfs_node_key_to_˝u
(
ªloc_∑ª¡
, &
block
->
fú°_key
, 
ªloc_¶Ÿ
);

4309 
	`•ö_lock
(&
blocks
->
lock
);

4310 
cur
 = &
blocks
->blocks[
Àvñ
].
rb_node
;

4311 *
cur
) {

4312 
båfs_qgroup_sw≠≥d_block
 *
íåy
;

4314 
∑ª¡
 = *
cur
;

4315 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
båfs_qgroup_sw≠≥d_block
,

4316 
node
);

4318 i‡(
íåy
->
subvﬁ_byãƒ
 < 
block
->subvol_bytenr) {

4319 
cur
 = &(*cur)->
rb_À·
;

4320 } i‡(
íåy
->
subvﬁ_byãƒ
 > 
block
->subvol_bytenr) {

4321 
cur
 = &(*cur)->
rb_right
;

4323 i‡(
íåy
->
subvﬁ_gíî©i⁄
 !=

4324 
block
->
subvﬁ_gíî©i⁄
 ||

4325 
íåy
->
ªloc_byãƒ
 !
block
->reloc_bytenr ||

4326 
íåy
->
ªloc_gíî©i⁄
 !=

4327 
block
->
ªloc_gíî©i⁄
) {

4335 
	`WARN_ON
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
));

4336 
ªt
 = -
EEXIST
;

4338 
	`k‰ì
(
block
);

4339 
out_u∆ock
;

4342 
	`rb_lök_node
(&
block
->
node
, 
∑ª¡
, 
cur
);

4343 
	`rb_ö£π_cﬁ‹
(&
block
->
node
, &
blocks
->blocks[
Àvñ
]);

4344 
blocks
->
sw≠≥d
 = 
åue
;

4345 
out_u∆ock
:

4346 
	`•ö_u∆ock
(&
blocks
->
lock
);

4347 
out
:

4348 i‡(
ªt
 < 0)

4349 
	`qgroup_m¨k_öc⁄si°ít
(
fs_öfo
);

4350  
ªt
;

4351 
	}
}

4359 
	$båfs_qgroup_åa˚_subåì_a·î_cow
(
båfs_å™s_h™dÀ
 *
å™s
,

4360 
båfs_roŸ
 *
roŸ
,

4361 
exã¡_buf„r
 *
subvﬁ_eb
)

4363 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4364 
båfs_åì_∑ª¡_check
 
check
 = { 0 };

4365 
båfs_qgroup_sw≠≥d_blocks
 *
blocks
 = &
roŸ
->
sw≠≥d_blocks
;

4366 
båfs_qgroup_sw≠≥d_block
 *
block
;

4367 
exã¡_buf„r
 *
ªloc_eb
 = 
NULL
;

4368 
rb_node
 *
node
;

4369 
boﬁ
 
found
 = 
Ál£
;

4370 
boﬁ
 
sw≠≥d
 = 
Ál£
;

4371 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
subvﬁ_eb
);

4372 
ªt
 = 0;

4373 
i
;

4375 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
))

4377 i‡(!
	`is_f°ªe
(
roŸ
->
roŸ_key
.
obje˘id
Ë|| !roŸ->
ªloc_roŸ
)

4380 
	`•ö_lock
(&
blocks
->
lock
);

4381 i‡(!
blocks
->
sw≠≥d
) {

4382 
	`•ö_u∆ock
(&
blocks
->
lock
);

4385 
node
 = 
blocks
->blocks[
Àvñ
].
rb_node
;

4387 
node
) {

4388 
block
 = 
	`rb_íåy
(
node
, 
båfs_qgroup_sw≠≥d_block
,Çode);

4389 i‡(
block
->
subvﬁ_byãƒ
 < 
subvﬁ_eb
->
°¨t
) {

4390 
node
 =Çode->
rb_À·
;

4391 } i‡(
block
->
subvﬁ_byãƒ
 > 
subvﬁ_eb
->
°¨t
) {

4392 
node
 =Çode->
rb_right
;

4394 
found
 = 
åue
;

4398 i‡(!
found
) {

4399 
	`•ö_u∆ock
(&
blocks
->
lock
);

4400 
out
;

4403 
	`rb_îa£
(&
block
->
node
, &
blocks
->blocks[
Àvñ
]);

4404 
i
 = 0; i < 
BTRFS_MAX_LEVEL
; i++) {

4405 i‡(
	`RB_EMPTY_ROOT
(&
blocks
->blocks[
i
])) {

4406 
sw≠≥d
 = 
åue
;

4410 
blocks
->
sw≠≥d
 = swapped;

4411 
	`•ö_u∆ock
(&
blocks
->
lock
);

4413 
check
.
Àvñ
 = 
block
->level;

4414 
check
.
å™sid
 = 
block
->
ªloc_gíî©i⁄
;

4415 
check
.
has_fú°_key
 = 
åue
;

4416 
	`mem˝y
(&
check
.
fú°_key
, &
block
->first_key, (check.first_key));

4419 
ªloc_eb
 = 
	`ªad_åì_block
(
fs_öfo
, 
block
->
ªloc_byãƒ
, &
check
);

4420 i‡(
	`IS_ERR
(
ªloc_eb
)) {

4421 
ªt
 = 
	`PTR_ERR
(
ªloc_eb
);

4422 
ªloc_eb
 = 
NULL
;

4423 
‰ì_out
;

4425 i‡(!
	`exã¡_buf„r_u±od©e
(
ªloc_eb
)) {

4426 
ªt
 = -
EIO
;

4427 
‰ì_out
;

4430 
ªt
 = 
	`qgroup_åa˚_subåì_sw≠
(
å™s
, 
ªloc_eb
, 
subvﬁ_eb
,

4431 
block
->
œ°_¢≠shŸ
, block->
åa˚_Àaf
);

4432 
‰ì_out
:

4433 
	`k‰ì
(
block
);

4434 
	`‰ì_exã¡_buf„r
(
ªloc_eb
);

4435 
out
:

4436 i‡(
ªt
 < 0) {

4437 
	`båfs_îr_æ
(
fs_öfo
,

4439 
subvﬁ_eb
->
°¨t
, 
ªt
);

4440 
	`qgroup_m¨k_öc⁄si°ít
(
fs_öfo
);

4442  
ªt
;

4443 
	}
}

4445 
	$båfs_qgroup_de°roy_exã¡_ªc‹ds
(
båfs_å™ß˘i⁄
 *
å™s
)

4447 
båfs_qgroup_exã¡_ªc‹d
 *
íåy
;

4448 
båfs_qgroup_exã¡_ªc‹d
 *
√xt
;

4449 
rb_roŸ
 *
roŸ
;

4451 
roŸ
 = &
å™s
->
dñayed_ªfs
.
dúty_exã¡_roŸ
;

4452 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
íåy
, 
√xt
, 
roŸ
, 
node
) {

4453 
	`uli°_‰ì
(
íåy
->
ﬁd_roŸs
);

4454 
	`k‰ì
(
íåy
);

4456 *
roŸ
 = 
RB_ROOT
;

4457 
	}
}

	@qgroup.h

6 #i‚de‡
BTRFS_QGROUP_H


7 
	#BTRFS_QGROUP_H


	)

9 
	~<löux/•ölock.h
>

10 
	~<löux/rbåì.h
>

11 
	~<löux/kobje˘.h
>

12 
	~"uli°.h
"

13 
	~"dñayed-ªf.h
"

14 
	~"misc.h
"

104 
	#BTRFS_QGROUP_RUNTIME_FLAG_CANCEL_RESCAN
 (1UL << 3)

	)

105 
	#BTRFS_QGROUP_RUNTIME_FLAG_NO_ACCOUNTING
 (1UL << 4)

	)

111 
	sbåfs_qgroup_exã¡_ªc‹d
 {

112 
rb_node
 
	mnode
;

113 
u64
 
	mbyãƒ
;

114 
u64
 
	mnum_byãs
;

124 
u32
 
	md©a_rsv
;

125 
u64
 
	md©a_rsv_ª‰oŸ
;

126 
uli°
 *
	mﬁd_roŸs
;

129 
	sbåfs_qgroup_sw≠≥d_block
 {

130 
rb_node
 
	mnode
;

132 
	mÀvñ
;

133 
boﬁ
 
	måa˚_Àaf
;

136 
u64
 
	msubvﬁ_byãƒ
;

137 
u64
 
	msubvﬁ_gíî©i⁄
;

140 
u64
 
	mªloc_byãƒ
;

141 
u64
 
	mªloc_gíî©i⁄
;

143 
u64
 
	mœ°_¢≠shŸ
;

144 
båfs_key
 
	mfú°_key
;

168 
	ebåfs_qgroup_rsv_ty≥
 {

169 
	mBTRFS_QGROUP_RSV_DATA
,

170 
	mBTRFS_QGROUP_RSV_META_PERTRANS
,

171 
	mBTRFS_QGROUP_RSV_META_PREALLOC
,

172 
	mBTRFS_QGROUP_RSV_LAST
,

185 
	sbåfs_qgroup_rsv
 {

186 
u64
 
	mvÆues
[
BTRFS_QGROUP_RSV_LAST
];

192 
	sbåfs_qgroup
 {

193 
u64
 
	mqgroupid
;

198 
u64
 
	mr„r
;

199 
u64
 
	mr„r_cm¥
;

200 
u64
 
	mex˛
;

201 
u64
 
	mex˛_cm¥
;

206 
u64
 
	mlim_Êags
;

207 
u64
 
	mmax_r„r
;

208 
u64
 
	mmax_ex˛
;

209 
u64
 
	mrsv_r„r
;

210 
u64
 
	mrsv_ex˛
;

215 
båfs_qgroup_rsv
 
	mrsv
;

220 
li°_hód
 
	mgroups
;

221 
li°_hód
 
	mmembîs
;

222 
li°_hód
 
	mdúty
;

223 
rb_node
 
	mnode
;

229 
u64
 
	mﬁd_ªf˙t
;

230 
u64
 
	m√w_ªf˙t
;

235 
kobje˘
 
	mkobj
;

238 
ölöe
 
u64
 
	$båfs_qgroup_subvﬁid
(
u64
 
qgroupid
)

240  (
qgroupid
 & ((1ULL << 
BTRFS_QGROUP_LEVEL_SHIFT
) - 1));

241 
	}
}

247 
ENUM_BIT
(
QGROUP_RESERVE
),

248 
ENUM_BIT
(
QGROUP_RELEASE
),

249 
ENUM_BIT
(
QGROUP_FREE
),

252 
båfs_quŸa_íabÀ
(
båfs_fs_öfo
 *
fs_öfo
);

253 
båfs_quŸa_dißbÀ
(
båfs_fs_öfo
 *
fs_öfo
);

254 
båfs_qgroup_ªsˇn
(
båfs_fs_öfo
 *
fs_öfo
);

255 
båfs_qgroup_ªsˇn_ªsume
(
båfs_fs_öfo
 *
fs_öfo
);

256 
båfs_qgroup_waô_f‹_com∂ëi⁄
(
båfs_fs_öfo
 *
fs_öfo
,

257 
boﬁ
 
öãºu±ibÀ
);

258 
båfs_add_qgroup_ªœti⁄
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
§c
,

259 
u64
 
d°
);

260 
båfs_dñ_qgroup_ªœti⁄
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
§c
,

261 
u64
 
d°
);

262 
båfs_¸óã_qgroup
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
qgroupid
);

263 
båfs_ªmove_qgroup
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
qgroupid
);

264 
båfs_limô_qgroup
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
qgroupid
,

265 
båfs_qgroup_limô
 *
limô
);

266 
båfs_ªad_qgroup_c⁄fig
(
båfs_fs_öfo
 *
fs_öfo
);

267 
båfs_‰ì_qgroup_c⁄fig
(
båfs_fs_öfo
 *
fs_öfo
);

268 
	gbåfs_dñayed_exã¡_›
;

281 
båfs_qgroup_åa˚_exã¡_nﬁock
(

282 
båfs_fs_öfo
 *
fs_öfo
,

283 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
,

284 
båfs_qgroup_exã¡_ªc‹d
 *
ªc‹d
);

307 
båfs_qgroup_åa˚_exã¡_po°
(
båfs_å™s_h™dÀ
 *
å™s
,

308 
båfs_qgroup_exã¡_ªc‹d
 *
qªc‹d
);

323 
båfs_qgroup_åa˚_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
byãƒ
,

324 
u64
 
num_byãs
);

332 
båfs_qgroup_åa˚_Àaf_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

333 
exã¡_buf„r
 *
eb
);

344 
båfs_qgroup_åa˚_subåì
(
båfs_å™s_h™dÀ
 *
å™s
,

345 
exã¡_buf„r
 *
roŸ_eb
,

346 
u64
 
roŸ_gí
, 
roŸ_Àvñ
);

347 
båfs_qgroup_accou¡_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
byãƒ
,

348 
u64
 
num_byãs
, 
uli°
 *
ﬁd_roŸs
,

349 
uli°
 *
√w_roŸs
);

350 
båfs_qgroup_accou¡_exã¡s
(
båfs_å™s_h™dÀ
 *
å™s
);

351 
båfs_run_qgroups
(
båfs_å™s_h™dÀ
 *
å™s
);

352 
båfs_qgroup_öhîô
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
§cid
,

353 
u64
 
obje˘id
, 
båfs_qgroup_öhîô
 *
öhîô
);

354 
båfs_qgroup_‰ì_ª‰oŸ
(
båfs_fs_öfo
 *
fs_öfo
,

355 
u64
 
ªf_roŸ
, u64 
num_byãs
,

356 
båfs_qgroup_rsv_ty≥
 
ty≥
);

358 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


359 
båfs_vîify_qgroup_cou¡s
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
qgroupid
,

360 
u64
 
r„r
, u64 
ex˛
);

364 
båfs_qgroup_ª£rve_d©a
(
båfs_öode
 *
öode
,

365 
exã¡_ch™ge£t
 **
ª£rved
, 
u64
 
°¨t
, u64 
Àn
);

366 
båfs_qgroup_ªÀa£_d©a
(
båfs_öode
 *
öode
, 
u64
 
°¨t
, u64 
Àn
, u64 *
ªÀa£d
);

367 
båfs_qgroup_‰ì_d©a
(
båfs_öode
 *
öode
,

368 
exã¡_ch™ge£t
 *
ª£rved
, 
u64
 
°¨t
,

369 
u64
 
Àn
, u64 *
‰ìd
);

370 
båfs_qgroup_ª£rve_mëa
(
båfs_roŸ
 *
roŸ
, 
num_byãs
,

371 
båfs_qgroup_rsv_ty≥
 
ty≥
, 
boﬁ
 
íf‹˚
);

372 
__båfs_qgroup_ª£rve_mëa
(
båfs_roŸ
 *
roŸ
, 
num_byãs
,

373 
båfs_qgroup_rsv_ty≥
 
ty≥
, 
boﬁ
 
íf‹˚
,

374 
boﬁ
 
noÊush
);

376 
ölöe
 
	$båfs_qgroup_ª£rve_mëa_≥πøns
(
båfs_roŸ
 *
roŸ
,

377 
num_byãs
, 
boﬁ
 
íf‹˚
)

379  
	`__båfs_qgroup_ª£rve_mëa
(
roŸ
, 
num_byãs
,

380 
BTRFS_QGROUP_RSV_META_PERTRANS
,

381 
íf‹˚
, 
Ál£
);

382 
	}
}

383 
ölöe
 
	$båfs_qgroup_ª£rve_mëa_¥óŒoc
(
båfs_roŸ
 *
roŸ
,

384 
num_byãs
, 
boﬁ
 
íf‹˚
,

385 
boﬁ
 
noÊush
)

387  
	`__båfs_qgroup_ª£rve_mëa
(
roŸ
, 
num_byãs
,

388 
BTRFS_QGROUP_RSV_META_PREALLOC
,

389 
íf‹˚
, 
noÊush
);

390 
	}
}

392 
__båfs_qgroup_‰ì_mëa
(
båfs_roŸ
 *
roŸ
, 
num_byãs
,

393 
båfs_qgroup_rsv_ty≥
 
ty≥
);

396 
ölöe
 
	$båfs_qgroup_‰ì_mëa_≥πøns
(
båfs_roŸ
 *
roŸ
,

397 
num_byãs
)

399 
	`__båfs_qgroup_‰ì_mëa
(
roŸ
, 
num_byãs
,

400 
BTRFS_QGROUP_RSV_META_PERTRANS
);

401 
	}
}

404 
ölöe
 
	$båfs_qgroup_‰ì_mëa_¥óŒoc
(
båfs_roŸ
 *
roŸ
,

405 
num_byãs
)

407 
	`__båfs_qgroup_‰ì_mëa
(
roŸ
, 
num_byãs
,

408 
BTRFS_QGROUP_RSV_META_PREALLOC
);

409 
	}
}

415 
båfs_qgroup_‰ì_mëa_Æl_≥πøns
(
båfs_roŸ
 *
roŸ
);

423 
båfs_qgroup_c⁄vît_ª£rved_mëa
(
båfs_roŸ
 *
roŸ
, 
num_byãs
);

425 
båfs_qgroup_check_ª£rved_Àak
(
båfs_öode
 *
öode
);

428 
båfs_qgroup_öô_sw≠≥d_blocks
(

429 
båfs_qgroup_sw≠≥d_blocks
 *
sw≠≥d_blocks
);

431 
båfs_qgroup_˛ón_sw≠≥d_blocks
(
båfs_roŸ
 *
roŸ
);

432 
båfs_qgroup_add_sw≠≥d_blocks
(
båfs_å™s_h™dÀ
 *
å™s
,

433 
båfs_roŸ
 *
subvﬁ_roŸ
,

434 
båfs_block_group
 *
bg
,

435 
exã¡_buf„r
 *
subvﬁ_∑ª¡
, 
subvﬁ_¶Ÿ
,

436 
exã¡_buf„r
 *
ªloc_∑ª¡
, 
ªloc_¶Ÿ
,

437 
u64
 
œ°_¢≠shŸ
);

438 
båfs_qgroup_åa˚_subåì_a·î_cow
(
båfs_å™s_h™dÀ
 *
å™s
,

439 
båfs_roŸ
 *
roŸ
, 
exã¡_buf„r
 *
eb
);

440 
båfs_qgroup_de°roy_exã¡_ªc‹ds
(
båfs_å™ß˘i⁄
 *
å™s
);

441 
boﬁ
 
båfs_check_quŸa_Àak
(
båfs_fs_öfo
 *
fs_öfo
);

	@raid56.c

7 
	~<löux/sched.h
>

8 
	~<löux/bio.h
>

9 
	~<löux/¶ab.h
>

10 
	~<löux/blkdev.h
>

11 
	~<löux/øid/pq.h
>

12 
	~<löux/hash.h
>

13 
	~<löux/li°_s‹t.h
>

14 
	~<löux/øid/x‹.h
>

15 
	~<löux/mm.h
>

16 
	~"mesßges.h
"

17 
	~"misc.h
"

18 
	~"˘ªe.h
"

19 
	~"disk-io.h
"

20 
	~"vﬁumes.h
"

21 
	~"øid56.h
"

22 
	~"async-thªad.h
"

23 
	~"fûe-ôem.h
"

24 
	~"båfs_öode.h
"

27 
	#RBIO_RMW_LOCKED_BIT
 1

	)

33 
	#RBIO_CACHE_BIT
 2

	)

38 
	#RBIO_CACHE_READY_BIT
 3

	)

40 
	#RBIO_CACHE_SIZE
 1024

	)

42 
	#BTRFS_STRIPE_HASH_TABLE_BITS
 11

	)

45 
	sbåfs_°rùe_hash
 {

46 
li°_hód
 
	mhash_li°
;

47 
•ölock_t
 
	mlock
;

51 
	sbåfs_°rùe_hash_èbÀ
 {

52 
li°_hód
 
	m°rùe_ˇche
;

53 
•ölock_t
 
	mˇche_lock
;

54 
	mˇche_size
;

55 
båfs_°rùe_hash
 
	mèbÀ
[];

63 
	s£˘‹_±r
 {

64 
∑ge
 *
	m∑ge
;

65 
	mpgoff
:24;

66 
	mu±od©e
:8;

69 
rmw_rbio_w‹k
(
w‹k_°ru˘
 *
w‹k
);

70 
rmw_rbio_w‹k_locked
(
w‹k_°ru˘
 *
w‹k
);

71 
ödex_rbio_∑ges
(
båfs_øid_bio
 *
rbio
);

72 
Æloc_rbio_∑ges
(
båfs_øid_bio
 *
rbio
);

74 
föish_∑rôy_s¸ub
(
båfs_øid_bio
 *
rbio
);

75 
s¸ub_rbio_w‹k_locked
(
w‹k_°ru˘
 *
w‹k
);

77 
	$‰ì_øid_bio_poöãrs
(
båfs_øid_bio
 *
rbio
)

79 
	`bôm≠_‰ì
(
rbio
->
îr‹_bôm≠
);

80 
	`k‰ì
(
rbio
->
°rùe_∑ges
);

81 
	`k‰ì
(
rbio
->
bio_£˘‹s
);

82 
	`k‰ì
(
rbio
->
°rùe_£˘‹s
);

83 
	`k‰ì
(
rbio
->
föish_poöãrs
);

84 
	}
}

86 
	$‰ì_øid_bio
(
båfs_øid_bio
 *
rbio
)

88 
i
;

90 i‡(!
	`ªfcou¡_dec_™d_ã°
(&
rbio
->
ªfs
))

93 
	`WARN_ON
(!
	`li°_em±y
(&
rbio
->
°rùe_ˇche
));

94 
	`WARN_ON
(!
	`li°_em±y
(&
rbio
->
hash_li°
));

95 
	`WARN_ON
(!
	`bio_li°_em±y
(&
rbio
->
bio_li°
));

97 
i
 = 0; i < 
rbio
->
ƒ_∑ges
; i++) {

98 i‡(
rbio
->
°rùe_∑ges
[
i
]) {

99 
	`__‰ì_∑ge
(
rbio
->
°rùe_∑ges
[
i
]);

100 
rbio
->
°rùe_∑ges
[
i
] = 
NULL
;

104 
	`båfs_put_bioc
(
rbio
->
bioc
);

105 
	`‰ì_øid_bio_poöãrs
(
rbio
);

106 
	`k‰ì
(
rbio
);

107 
	}
}

109 
	$°¨t_async_w‹k
(
båfs_øid_bio
 *
rbio
, 
w‹k_func_t
 
w‹k_func
)

111 
	`INIT_WORK
(&
rbio
->
w‹k
, 
w‹k_func
);

112 
	`queue_w‹k
(
rbio
->
bioc
->
fs_öfo
->
rmw_w‹kîs
, &rbio->
w‹k
);

113 
	}
}

119 
	$båfs_Æloc_°rùe_hash_èbÀ
(
båfs_fs_öfo
 *
öfo
)

121 
båfs_°rùe_hash_èbÀ
 *
èbÀ
;

122 
båfs_°rùe_hash_èbÀ
 *
x
;

123 
båfs_°rùe_hash
 *
cur
;

124 
båfs_°rùe_hash
 *
h
;

125 
num_íåõs
 = 1 << 
BTRFS_STRIPE_HASH_TABLE_BITS
;

126 
i
;

128 i‡(
öfo
->
°rùe_hash_èbÀ
)

138 
èbÀ
 = 
	`kvzÆloc
(
	`°ru˘_size
—abÀ,ÅabÀ, 
num_íåõs
), 
GFP_KERNEL
);

139 i‡(!
èbÀ
)

140  -
ENOMEM
;

142 
	`•ö_lock_öô
(&
èbÀ
->
ˇche_lock
);

143 
	`INIT_LIST_HEAD
(&
èbÀ
->
°rùe_ˇche
);

145 
h
 = 
èbÀ
->table;

147 
i
 = 0; i < 
num_íåõs
; i++) {

148 
cur
 = 
h
 + 
i
;

149 
	`INIT_LIST_HEAD
(&
cur
->
hash_li°
);

150 
	`•ö_lock_öô
(&
cur
->
lock
);

153 
x
 = 
	`cmpxchg
(&
öfo
->
°rùe_hash_èbÀ
, 
NULL
, 
èbÀ
);

154 
	`kv‰ì
(
x
);

156 
	}
}

167 
	$ˇche_rbio_∑ges
(
båfs_øid_bio
 *
rbio
)

169 
i
;

170 
ªt
;

172 
ªt
 = 
	`Æloc_rbio_∑ges
(
rbio
);

173 i‡(
ªt
)

176 
i
 = 0; i < 
rbio
->
ƒ_£˘‹s
; i++) {

178 i‡(!
rbio
->
bio_£˘‹s
[
i
].
∑ge
) {

184 i‡(
i
 < 
rbio
->
ƒ_d©a
 *Ñbio->
°rùe_n£˘‹s
)

185 
	`ASSERT
(
rbio
->
°rùe_£˘‹s
[
i
].
u±od©e
);

189 
	`ASSERT
(
rbio
->
°rùe_£˘‹s
[
i
].
∑ge
);

190 
	`mem˝y_∑ge
(
rbio
->
°rùe_£˘‹s
[
i
].
∑ge
,

191 
rbio
->
°rùe_£˘‹s
[
i
].
pgoff
,

192 
rbio
->
bio_£˘‹s
[
i
].
∑ge
,

193 
rbio
->
bio_£˘‹s
[
i
].
pgoff
,

194 
rbio
->
bioc
->
fs_öfo
->
£˘‹size
);

195 
rbio
->
°rùe_£˘‹s
[
i
].
u±od©e
 = 1;

197 
	`£t_bô
(
RBIO_CACHE_READY_BIT
, &
rbio
->
Êags
);

198 
	}
}

203 
	$rbio_buckë
(
båfs_øid_bio
 *
rbio
)

205 
u64
 
num
 = 
rbio
->
bioc
->
fuŒ_°rùe_logiˇl
;

215  
	`hash_64
(
num
 >> 16, 
BTRFS_STRIPE_HASH_TABLE_BITS
);

216 
	}
}

218 
boﬁ
 
	$fuŒ_∑ge_£˘‹s_u±od©e
(
båfs_øid_bio
 *
rbio
,

219 
∑ge_ƒ
)

221 c⁄° 
u32
 
£˘‹size
 = 
rbio
->
bioc
->
fs_öfo
->sectorsize;

222 c⁄° 
u32
 
£˘‹s_≥r_∑ge
 = 
PAGE_SIZE
 / 
£˘‹size
;

223 
i
;

225 
	`ASSERT
(
∑ge_ƒ
 < 
rbio
->
ƒ_∑ges
);

227 
i
 = 
£˘‹s_≥r_∑ge
 * 
∑ge_ƒ
;

228 
i
 < 
£˘‹s_≥r_∑ge
 * 
∑ge_ƒ
 + sectors_per_page;

229 
i
++) {

230 i‡(!
rbio
->
°rùe_£˘‹s
[
i
].
u±od©e
)

231  
Ál£
;

233  
åue
;

234 
	}
}

241 
	$ödex_°rùe_£˘‹s
(
båfs_øid_bio
 *
rbio
)

243 c⁄° 
u32
 
£˘‹size
 = 
rbio
->
bioc
->
fs_öfo
->sectorsize;

244 
u32
 
off£t
;

245 
i
;

247 
i
 = 0, 
off£t
 = 0; i < 
rbio
->
ƒ_£˘‹s
; i++, off£à+
£˘‹size
) {

248 
∑ge_ödex
 = 
off£t
 >> 
PAGE_SHIFT
;

250 
	`ASSERT
(
∑ge_ödex
 < 
rbio
->
ƒ_∑ges
);

251 
rbio
->
°rùe_£˘‹s
[
i
].
∑ge
 =Ñbio->
°rùe_∑ges
[
∑ge_ödex
];

252 
rbio
->
°rùe_£˘‹s
[
i
].
pgoff
 = 
	`off£t_ö_∑ge
(
off£t
);

254 
	}
}

256 
	$°ól_rbio_∑ge
(
båfs_øid_bio
 *
§c
,

257 
båfs_øid_bio
 *
de°
, 
∑ge_ƒ
)

259 c⁄° 
u32
 
£˘‹size
 = 
§c
->
bioc
->
fs_öfo
->sectorsize;

260 c⁄° 
u32
 
£˘‹s_≥r_∑ge
 = 
PAGE_SIZE
 / 
£˘‹size
;

261 
i
;

263 i‡(
de°
->
°rùe_∑ges
[
∑ge_ƒ
])

264 
	`__‰ì_∑ge
(
de°
->
°rùe_∑ges
[
∑ge_ƒ
]);

265 
de°
->
°rùe_∑ges
[
∑ge_ƒ
] = 
§c
->stripe_pages[page_nr];

266 
§c
->
°rùe_∑ges
[
∑ge_ƒ
] = 
NULL
;

269 
i
 = 
£˘‹s_≥r_∑ge
 * 
∑ge_ƒ
;

270 
i
 < 
£˘‹s_≥r_∑ge
 * 
∑ge_ƒ
 + sectors_per_page; i++)

271 
de°
->
°rùe_£˘‹s
[
i
].
u±od©e
 = 
åue
;

272 
	}
}

274 
boﬁ
 
	$is_d©a_°rùe_∑ge
(
båfs_øid_bio
 *
rbio
, 
∑ge_ƒ
)

276 c⁄° 
£˘‹_ƒ
 = (
∑ge_ƒ
 << 
PAGE_SHIFT
) >>

277 
rbio
->
bioc
->
fs_öfo
->
£˘‹size_bôs
;

286  (
£˘‹_ƒ
 < 
rbio
->
ƒ_d©a
 *Ñbio->
°rùe_n£˘‹s
);

287 
	}
}

296 
	$°ól_rbio
(
båfs_øid_bio
 *
§c
, båfs_øid_biÿ*
de°
)

298 
i
;

300 i‡(!
	`ã°_bô
(
RBIO_CACHE_READY_BIT
, &
§c
->
Êags
))

303 
i
 = 0; i < 
de°
->
ƒ_∑ges
; i++) {

304 
∑ge
 *
p
 = 
§c
->
°rùe_∑ges
[
i
];

310 i‡(!
	`is_d©a_°rùe_∑ge
(
§c
, 
i
))

317 
	`ASSERT
(
p
);

318 
	`ASSERT
(
	`fuŒ_∑ge_£˘‹s_u±od©e
(
§c
, 
i
));

319 
	`°ól_rbio_∑ge
(
§c
, 
de°
, 
i
);

321 
	`ödex_°rùe_£˘‹s
(
de°
);

322 
	`ödex_°rùe_£˘‹s
(
§c
);

323 
	}
}

332 
	$mîge_rbio
(
båfs_øid_bio
 *
de°
,

333 
båfs_øid_bio
 *
vi˘im
)

335 
	`bio_li°_mîge
(&
de°
->
bio_li°
, &
vi˘im
->bio_list);

336 
de°
->
bio_li°_byãs
 +
vi˘im
->bio_list_bytes;

338 
	`bôm≠_‹
(&
de°
->
dbôm≠
, &
vi˘im
->dbitmap, &dest->dbitmap,

339 
de°
->
°rùe_n£˘‹s
);

340 
	`bio_li°_öô
(&
vi˘im
->
bio_li°
);

341 
	}
}

347 
	$__ªmove_rbio_‰om_ˇche
(
båfs_øid_bio
 *
rbio
)

349 
buckë
 = 
	`rbio_buckë
(
rbio
);

350 
båfs_°rùe_hash_èbÀ
 *
èbÀ
;

351 
båfs_°rùe_hash
 *
h
;

352 
‰ìô
 = 0;

357 i‡(!
	`ã°_bô
(
RBIO_CACHE_BIT
, &
rbio
->
Êags
))

360 
èbÀ
 = 
rbio
->
bioc
->
fs_öfo
->
°rùe_hash_èbÀ
;

361 
h
 = 
èbÀ
->èbÀ + 
buckë
;

366 
	`•ö_lock
(&
h
->
lock
);

372 
	`•ö_lock
(&
rbio
->
bio_li°_lock
);

374 i‡(
	`ã°_™d_˛ór_bô
(
RBIO_CACHE_BIT
, &
rbio
->
Êags
)) {

375 
	`li°_dñ_öô
(&
rbio
->
°rùe_ˇche
);

376 
èbÀ
->
ˇche_size
 -= 1;

377 
‰ìô
 = 1;

388 i‡(
	`bio_li°_em±y
(&
rbio
->
bio_li°
)) {

389 i‡(!
	`li°_em±y
(&
rbio
->
hash_li°
)) {

390 
	`li°_dñ_öô
(&
rbio
->
hash_li°
);

391 
	`ªfcou¡_dec
(&
rbio
->
ªfs
);

392 
	`BUG_ON
(!
	`li°_em±y
(&
rbio
->
∂ug_li°
));

397 
	`•ö_u∆ock
(&
rbio
->
bio_li°_lock
);

398 
	`•ö_u∆ock
(&
h
->
lock
);

400 i‡(
‰ìô
)

401 
	`‰ì_øid_bio
(
rbio
);

402 
	}
}

407 
	$ªmove_rbio_‰om_ˇche
(
båfs_øid_bio
 *
rbio
)

409 
båfs_°rùe_hash_èbÀ
 *
èbÀ
;

411 i‡(!
	`ã°_bô
(
RBIO_CACHE_BIT
, &
rbio
->
Êags
))

414 
èbÀ
 = 
rbio
->
bioc
->
fs_öfo
->
°rùe_hash_èbÀ
;

416 
	`•ö_lock
(&
èbÀ
->
ˇche_lock
);

417 
	`__ªmove_rbio_‰om_ˇche
(
rbio
);

418 
	`•ö_u∆ock
(&
èbÀ
->
ˇche_lock
);

419 
	}
}

424 
	$båfs_˛ór_rbio_ˇche
(
båfs_fs_öfo
 *
öfo
)

426 
båfs_°rùe_hash_èbÀ
 *
èbÀ
;

427 
båfs_øid_bio
 *
rbio
;

429 
èbÀ
 = 
öfo
->
°rùe_hash_èbÀ
;

431 
	`•ö_lock
(&
èbÀ
->
ˇche_lock
);

432 !
	`li°_em±y
(&
èbÀ
->
°rùe_ˇche
)) {

433 
rbio
 = 
	`li°_íåy
(
èbÀ
->
°rùe_ˇche
.
√xt
,

434 
båfs_øid_bio
,

435 
°rùe_ˇche
);

436 
	`__ªmove_rbio_‰om_ˇche
(
rbio
);

438 
	`•ö_u∆ock
(&
èbÀ
->
ˇche_lock
);

439 
	}
}

445 
	$båfs_‰ì_°rùe_hash_èbÀ
(
båfs_fs_öfo
 *
öfo
)

447 i‡(!
öfo
->
°rùe_hash_èbÀ
)

449 
	`båfs_˛ór_rbio_ˇche
(
öfo
);

450 
	`kv‰ì
(
öfo
->
°rùe_hash_èbÀ
);

451 
öfo
->
°rùe_hash_èbÀ
 = 
NULL
;

452 
	}
}

465 
	$ˇche_rbio
(
båfs_øid_bio
 *
rbio
)

467 
båfs_°rùe_hash_èbÀ
 *
èbÀ
;

469 i‡(!
	`ã°_bô
(
RBIO_CACHE_READY_BIT
, &
rbio
->
Êags
))

472 
èbÀ
 = 
rbio
->
bioc
->
fs_öfo
->
°rùe_hash_èbÀ
;

474 
	`•ö_lock
(&
èbÀ
->
ˇche_lock
);

475 
	`•ö_lock
(&
rbio
->
bio_li°_lock
);

478 i‡(!
	`ã°_™d_£t_bô
(
RBIO_CACHE_BIT
, &
rbio
->
Êags
))

479 
	`ªfcou¡_öc
(&
rbio
->
ªfs
);

481 i‡(!
	`li°_em±y
(&
rbio
->
°rùe_ˇche
)){

482 
	`li°_move
(&
rbio
->
°rùe_ˇche
, &
èbÀ
->stripe_cache);

484 
	`li°_add
(&
rbio
->
°rùe_ˇche
, &
èbÀ
->stripe_cache);

485 
èbÀ
->
ˇche_size
 += 1;

488 
	`•ö_u∆ock
(&
rbio
->
bio_li°_lock
);

490 i‡(
èbÀ
->
ˇche_size
 > 
RBIO_CACHE_SIZE
) {

491 
båfs_øid_bio
 *
found
;

493 
found
 = 
	`li°_íåy
(
èbÀ
->
°rùe_ˇche
.
¥ev
,

494 
båfs_øid_bio
,

495 
°rùe_ˇche
);

497 i‡(
found
 !
rbio
)

498 
	`__ªmove_rbio_‰om_ˇche
(
found
);

501 
	`•ö_u∆ock
(&
èbÀ
->
ˇche_lock
);

502 
	}
}

509 
	$run_x‹
(**
∑ges
, 
§c_˙t
, 
ssize_t
 
Àn
)

511 
§c_off
 = 0;

512 
x‹_§c_˙t
 = 0;

513 *
de°
 = 
∑ges
[
§c_˙t
];

515 
§c_˙t
 > 0) {

516 
x‹_§c_˙t
 = 
	`mö
(
§c_˙t
, 
MAX_XOR_BLOCKS
);

517 
	`x‹_blocks
(
x‹_§c_˙t
, 
Àn
, 
de°
, 
∑ges
 + 
§c_off
);

519 
§c_˙t
 -
x‹_§c_˙t
;

520 
§c_off
 +
x‹_§c_˙t
;

522 
	}
}

528 
	$rbio_is_fuŒ
(
båfs_øid_bio
 *
rbio
)

530 
size
 = 
rbio
->
bio_li°_byãs
;

531 
ªt
 = 1;

533 
	`•ö_lock
(&
rbio
->
bio_li°_lock
);

534 i‡(
size
 !
rbio
->
ƒ_d©a
 * 
BTRFS_STRIPE_LEN
)

535 
ªt
 = 0;

536 
	`BUG_ON
(
size
 > 
rbio
->
ƒ_d©a
 * 
BTRFS_STRIPE_LEN
);

537 
	`•ö_u∆ock
(&
rbio
->
bio_li°_lock
);

539  
ªt
;

540 
	}
}

552 
	$rbio_ˇn_mîge
(
båfs_øid_bio
 *
œ°
,

553 
båfs_øid_bio
 *
cur
)

555 i‡(
	`ã°_bô
(
RBIO_RMW_LOCKED_BIT
, &
œ°
->
Êags
) ||

556 
	`ã°_bô
(
RBIO_RMW_LOCKED_BIT
, &
cur
->
Êags
))

566 i‡(
	`ã°_bô
(
RBIO_CACHE_BIT
, &
œ°
->
Êags
) ||

567 
	`ã°_bô
(
RBIO_CACHE_BIT
, &
cur
->
Êags
))

570 i‡(
œ°
->
bioc
->
fuŒ_°rùe_logiˇl
 !
cur
->bioc->full_stripe_logical)

574 i‡(
œ°
->
›î©i⁄
 !
cur
->operation)

584 i‡(
œ°
->
›î©i⁄
 =
BTRFS_RBIO_PARITY_SCRUB
)

587 i‡(
œ°
->
›î©i⁄
 =
BTRFS_RBIO_READ_REBUILD
)

591 
	}
}

593 
	$rbio_°rùe_£˘‹_ödex
(c⁄° 
båfs_øid_bio
 *
rbio
,

594 
°rùe_ƒ
,

595 
£˘‹_ƒ
)

597 
	`ASSERT
(
°rùe_ƒ
 < 
rbio
->
ªÆ_°rùes
);

598 
	`ASSERT
(
£˘‹_ƒ
 < 
rbio
->
°rùe_n£˘‹s
);

600  
°rùe_ƒ
 * 
rbio
->
°rùe_n£˘‹s
 + 
£˘‹_ƒ
;

601 
	}
}

604 
£˘‹_±r
 *
	$rbio_°rùe_£˘‹
(c⁄° 
båfs_øid_bio
 *
rbio
,

605 
°rùe_ƒ
,

606 
£˘‹_ƒ
)

608  &
rbio
->
°rùe_£˘‹s
[
	`rbio_°rùe_£˘‹_ödex
‘bio, 
°rùe_ƒ
,

609 
£˘‹_ƒ
)];

610 
	}
}

613 
£˘‹_±r
 *
	$rbio_p°rùe_£˘‹
(c⁄° 
båfs_øid_bio
 *
rbio
,

614 
£˘‹_ƒ
)

616  
	`rbio_°rùe_£˘‹
(
rbio
,Ñbio->
ƒ_d©a
, 
£˘‹_ƒ
);

617 
	}
}

620 
£˘‹_±r
 *
	$rbio_q°rùe_£˘‹
(c⁄° 
båfs_øid_bio
 *
rbio
,

621 
£˘‹_ƒ
)

623 i‡(
rbio
->
ƒ_d©a
 + 1 =rbio->
ªÆ_°rùes
)

624  
NULL
;

625  
	`rbio_°rùe_£˘‹
(
rbio
,Ñbio->
ƒ_d©a
 + 1, 
£˘‹_ƒ
);

626 
	}
}

650 
noölöe
 
	$lock_°rùe_add
(
båfs_øid_bio
 *
rbio
)

652 
båfs_°rùe_hash
 *
h
;

653 
båfs_øid_bio
 *
cur
;

654 
båfs_øid_bio
 *
≥ndög
;

655 
båfs_øid_bio
 *
‰ìô
 = 
NULL
;

656 
båfs_øid_bio
 *
ˇche_dr›
 = 
NULL
;

657 
ªt
 = 0;

659 
h
 = 
rbio
->
bioc
->
fs_öfo
->
°rùe_hash_èbÀ
->
èbÀ
 + 
	`rbio_buckë
(rbio);

661 
	`•ö_lock
(&
h
->
lock
);

662 
	`li°_f‹_óch_íåy
(
cur
, &
h
->
hash_li°
, hash_list) {

663 i‡(
cur
->
bioc
->
fuŒ_°rùe_logiˇl
 !
rbio
->bioc->full_stripe_logical)

666 
	`•ö_lock
(&
cur
->
bio_li°_lock
);

669 i‡(
	`bio_li°_em±y
(&
cur
->
bio_li°
) &&

670 
	`li°_em±y
(&
cur
->
∂ug_li°
) &&

671 
	`ã°_bô
(
RBIO_CACHE_BIT
, &
cur
->
Êags
) &&

672 !
	`ã°_bô
(
RBIO_RMW_LOCKED_BIT
, &
cur
->
Êags
)) {

673 
	`li°_dñ_öô
(&
cur
->
hash_li°
);

674 
	`ªfcou¡_dec
(&
cur
->
ªfs
);

676 
	`°ól_rbio
(
cur
, 
rbio
);

677 
ˇche_dr›
 = 
cur
;

678 
	`•ö_u∆ock
(&
cur
->
bio_li°_lock
);

680 
lockô
;

684 i‡(
	`rbio_ˇn_mîge
(
cur
, 
rbio
)) {

685 
	`mîge_rbio
(
cur
, 
rbio
);

686 
	`•ö_u∆ock
(&
cur
->
bio_li°_lock
);

687 
‰ìô
 = 
rbio
;

688 
ªt
 = 1;

689 
out
;

698 
	`li°_f‹_óch_íåy
(
≥ndög
, &
cur
->
∂ug_li°
,Ölug_list) {

699 i‡(
	`rbio_ˇn_mîge
(
≥ndög
, 
rbio
)) {

700 
	`mîge_rbio
(
≥ndög
, 
rbio
);

701 
	`•ö_u∆ock
(&
cur
->
bio_li°_lock
);

702 
‰ìô
 = 
rbio
;

703 
ªt
 = 1;

704 
out
;

712 
	`li°_add_èû
(&
rbio
->
∂ug_li°
, &
cur
->plug_list);

713 
	`•ö_u∆ock
(&
cur
->
bio_li°_lock
);

714 
ªt
 = 1;

715 
out
;

717 
lockô
:

718 
	`ªfcou¡_öc
(&
rbio
->
ªfs
);

719 
	`li°_add
(&
rbio
->
hash_li°
, &
h
->hash_list);

720 
out
:

721 
	`•ö_u∆ock
(&
h
->
lock
);

722 i‡(
ˇche_dr›
)

723 
	`ªmove_rbio_‰om_ˇche
(
ˇche_dr›
);

724 i‡(
‰ìô
)

725 
	`‰ì_øid_bio
(
‰ìô
);

726  
ªt
;

727 
	}
}

729 
ªcovî_rbio_w‹k_locked
(
w‹k_°ru˘
 *
w‹k
);

735 
noölöe
 
	$u∆ock_°rùe
(
båfs_øid_bio
 *
rbio
)

737 
buckë
;

738 
båfs_°rùe_hash
 *
h
;

739 
kìp_ˇche
 = 0;

741 
buckë
 = 
	`rbio_buckë
(
rbio
);

742 
h
 = 
rbio
->
bioc
->
fs_öfo
->
°rùe_hash_èbÀ
->
èbÀ
 + 
buckë
;

744 i‡(
	`li°_em±y
(&
rbio
->
∂ug_li°
))

745 
	`ˇche_rbio
(
rbio
);

747 
	`•ö_lock
(&
h
->
lock
);

748 
	`•ö_lock
(&
rbio
->
bio_li°_lock
);

750 i‡(!
	`li°_em±y
(&
rbio
->
hash_li°
)) {

756 i‡(
	`li°_em±y
(&
rbio
->
∂ug_li°
) &&

757 
	`ã°_bô
(
RBIO_CACHE_BIT
, &
rbio
->
Êags
)) {

758 
kìp_ˇche
 = 1;

759 
	`˛ór_bô
(
RBIO_RMW_LOCKED_BIT
, &
rbio
->
Êags
);

760 
	`BUG_ON
(!
	`bio_li°_em±y
(&
rbio
->
bio_li°
));

761 
d⁄e
;

764 
	`li°_dñ_öô
(&
rbio
->
hash_li°
);

765 
	`ªfcou¡_dec
(&
rbio
->
ªfs
);

772 i‡(!
	`li°_em±y
(&
rbio
->
∂ug_li°
)) {

773 
båfs_øid_bio
 *
√xt
;

774 
li°_hód
 *
hód
 = 
rbio
->
∂ug_li°
.
√xt
;

776 
√xt
 = 
	`li°_íåy
(
hód
, 
båfs_øid_bio
,

777 
∂ug_li°
);

779 
	`li°_dñ_öô
(&
rbio
->
∂ug_li°
);

781 
	`li°_add
(&
√xt
->
hash_li°
, &
h
->hash_list);

782 
	`ªfcou¡_öc
(&
√xt
->
ªfs
);

783 
	`•ö_u∆ock
(&
rbio
->
bio_li°_lock
);

784 
	`•ö_u∆ock
(&
h
->
lock
);

786 i‡(
√xt
->
›î©i⁄
 =
BTRFS_RBIO_READ_REBUILD
) {

787 
	`°¨t_async_w‹k
(
√xt
, 
ªcovî_rbio_w‹k_locked
);

788 } i‡(
√xt
->
›î©i⁄
 =
BTRFS_RBIO_WRITE
) {

789 
	`°ól_rbio
(
rbio
, 
√xt
);

790 
	`°¨t_async_w‹k
(
√xt
, 
rmw_rbio_w‹k_locked
);

791 } i‡(
√xt
->
›î©i⁄
 =
BTRFS_RBIO_PARITY_SCRUB
) {

792 
	`°ól_rbio
(
rbio
, 
√xt
);

793 
	`°¨t_async_w‹k
(
√xt
, 
s¸ub_rbio_w‹k_locked
);

796 
d⁄e_nﬁock
;

799 
d⁄e
:

800 
	`•ö_u∆ock
(&
rbio
->
bio_li°_lock
);

801 
	`•ö_u∆ock
(&
h
->
lock
);

803 
d⁄e_nﬁock
:

804 i‡(!
kìp_ˇche
)

805 
	`ªmove_rbio_‰om_ˇche
(
rbio
);

806 
	}
}

808 
	$rbio_ídio_bio_li°
(
bio
 *
cur
, 
blk_°©us_t
 
îr
)

810 
bio
 *
√xt
;

812 
cur
) {

813 
√xt
 = 
cur
->
bi_√xt
;

814 
cur
->
bi_√xt
 = 
NULL
;

815 
cur
->
bi_°©us
 = 
îr
;

816 
	`bio_ídio
(
cur
);

817 
cur
 = 
√xt
;

819 
	}
}

825 
	$rbio_‹ig_íd_io
(
båfs_øid_bio
 *
rbio
, 
blk_°©us_t
 
îr
)

827 
bio
 *
cur
 = 
	`bio_li°_gë
(&
rbio
->
bio_li°
);

828 
bio
 *
exåa
;

830 
	`k‰ì
(
rbio
->
csum_buf
);

831 
	`bôm≠_‰ì
(
rbio
->
csum_bôm≠
);

832 
rbio
->
csum_buf
 = 
NULL
;

833 
rbio
->
csum_bôm≠
 = 
NULL
;

840 
	`bôm≠_˛ór
(&
rbio
->
dbôm≠
, 0,Ñbio->
°rùe_n£˘‹s
);

850 
	`u∆ock_°rùe
(
rbio
);

851 
exåa
 = 
	`bio_li°_gë
(&
rbio
->
bio_li°
);

852 
	`‰ì_øid_bio
(
rbio
);

854 
	`rbio_ídio_bio_li°
(
cur
, 
îr
);

855 i‡(
exåa
)

856 
	`rbio_ídio_bio_li°
(
exåa
, 
îr
);

857 
	}
}

871 
£˘‹_±r
 *
	$£˘‹_ö_rbio
(
båfs_øid_bio
 *
rbio
,

872 
°rùe_ƒ
, 
£˘‹_ƒ
,

873 
boﬁ
 
bio_li°_⁄ly
)

875 
£˘‹_±r
 *
£˘‹
;

876 
ödex
;

878 
	`ASSERT
(
°rùe_ƒ
 >0 && såùe_ƒ < 
rbio
->
ªÆ_°rùes
);

879 
	`ASSERT
(
£˘‹_ƒ
 >0 && se˘‹_ƒ < 
rbio
->
°rùe_n£˘‹s
);

881 
ödex
 = 
°rùe_ƒ
 * 
rbio
->
°rùe_n£˘‹s
 + 
£˘‹_ƒ
;

882 
	`ASSERT
(
ödex
 >0 && index < 
rbio
->
ƒ_£˘‹s
);

884 
	`•ö_lock
(&
rbio
->
bio_li°_lock
);

885 
£˘‹
 = &
rbio
->
bio_£˘‹s
[
ödex
];

886 i‡(
£˘‹
->
∑ge
 || 
bio_li°_⁄ly
) {

888 i‡(!
£˘‹
->
∑ge
)

889 
£˘‹
 = 
NULL
;

890 
	`•ö_u∆ock
(&
rbio
->
bio_li°_lock
);

891  
£˘‹
;

893 
	`•ö_u∆ock
(&
rbio
->
bio_li°_lock
);

895  &
rbio
->
°rùe_£˘‹s
[
ödex
];

896 
	}
}

902 
båfs_øid_bio
 *
	$Æloc_rbio
(
båfs_fs_öfo
 *
fs_öfo
,

903 
båfs_io_c⁄ãxt
 *
bioc
)

905 c⁄° 
ªÆ_°rùes
 = 
bioc
->
num_°rùes
 - bioc->
ª∂a˚_ƒ_°rùes
;

906 c⁄° 
°rùe_≈ages
 = 
BTRFS_STRIPE_LEN
 >> 
PAGE_SHIFT
;

907 c⁄° 
num_∑ges
 = 
°rùe_≈ages
 * 
ªÆ_°rùes
;

908 c⁄° 
°rùe_n£˘‹s
 =

909 
BTRFS_STRIPE_LEN
 >> 
fs_öfo
->
£˘‹size_bôs
;

910 c⁄° 
num_£˘‹s
 = 
°rùe_n£˘‹s
 * 
ªÆ_°rùes
;

911 
båfs_øid_bio
 *
rbio
;

914 
	`ASSERT
(
	`IS_ALIGNED
(
PAGE_SIZE
, 
fs_öfo
->
£˘‹size
));

919 
	`ASSERT
(
°rùe_n£˘‹s
 <
BITS_PER_LONG
);

921 
rbio
 = 
	`kzÆloc
((*rbio), 
GFP_NOFS
);

922 i‡(!
rbio
)

923  
	`ERR_PTR
(-
ENOMEM
);

924 
rbio
->
°rùe_∑ges
 = 
	`kˇŒoc
(
num_∑ges
, (
∑ge
 *),

925 
GFP_NOFS
);

926 
rbio
->
bio_£˘‹s
 = 
	`kˇŒoc
(
num_£˘‹s
, (
£˘‹_±r
),

927 
GFP_NOFS
);

928 
rbio
->
°rùe_£˘‹s
 = 
	`kˇŒoc
(
num_£˘‹s
, (
£˘‹_±r
),

929 
GFP_NOFS
);

930 
rbio
->
föish_poöãrs
 = 
	`kˇŒoc
(
ªÆ_°rùes
, (*), 
GFP_NOFS
);

931 
rbio
->
îr‹_bôm≠
 = 
	`bôm≠_zÆloc
(
num_£˘‹s
, 
GFP_NOFS
);

933 i‡(!
rbio
->
°rùe_∑ges
 || !rbio->
bio_£˘‹s
 || !rbio->
°rùe_£˘‹s
 ||

934 !
rbio
->
föish_poöãrs
 || !rbio->
îr‹_bôm≠
) {

935 
	`‰ì_øid_bio_poöãrs
(
rbio
);

936 
	`k‰ì
(
rbio
);

937  
	`ERR_PTR
(-
ENOMEM
);

940 
	`bio_li°_öô
(&
rbio
->
bio_li°
);

941 
	`öô_waôqueue_hód
(&
rbio
->
io_waô
);

942 
	`INIT_LIST_HEAD
(&
rbio
->
∂ug_li°
);

943 
	`•ö_lock_öô
(&
rbio
->
bio_li°_lock
);

944 
	`INIT_LIST_HEAD
(&
rbio
->
°rùe_ˇche
);

945 
	`INIT_LIST_HEAD
(&
rbio
->
hash_li°
);

946 
	`båfs_gë_bioc
(
bioc
);

947 
rbio
->
bioc
 = bioc;

948 
rbio
->
ƒ_∑ges
 = 
num_∑ges
;

949 
rbio
->
ƒ_£˘‹s
 = 
num_£˘‹s
;

950 
rbio
->
ªÆ_°rùes
 =Ñeal_stripes;

951 
rbio
->
°rùe_≈ages
 = stripe_npages;

952 
rbio
->
°rùe_n£˘‹s
 = stripe_nsectors;

953 
	`ªfcou¡_£t
(&
rbio
->
ªfs
, 1);

954 
	`©omic_£t
(&
rbio
->
°rùes_≥ndög
, 0);

956 
	`ASSERT
(
	`båfs_ƒ_∑rôy_°rùes
(
bioc
->
m≠_ty≥
));

957 
rbio
->
ƒ_d©a
 = 
ªÆ_°rùes
 - 
	`båfs_ƒ_∑rôy_°rùes
(
bioc
->
m≠_ty≥
);

959  
rbio
;

960 
	}
}

963 
	$Æloc_rbio_∑ges
(
båfs_øid_bio
 *
rbio
)

965 
ªt
;

967 
ªt
 = 
	`båfs_Æloc_∑ge_¨øy
(
rbio
->
ƒ_∑ges
,Ñbio->
°rùe_∑ges
);

968 i‡(
ªt
 < 0)

969  
ªt
;

971 
	`ödex_°rùe_£˘‹s
(
rbio
);

973 
	}
}

976 
	$Æloc_rbio_∑rôy_∑ges
(
båfs_øid_bio
 *
rbio
)

978 c⁄° 
d©a_∑ges
 = 
rbio
->
ƒ_d©a
 *Ñbio->
°rùe_≈ages
;

979 
ªt
;

981 
ªt
 = 
	`båfs_Æloc_∑ge_¨øy
(
rbio
->
ƒ_∑ges
 - 
d©a_∑ges
,

982 
rbio
->
°rùe_∑ges
 + 
d©a_∑ges
);

983 i‡(
ªt
 < 0)

984  
ªt
;

986 
	`ödex_°rùe_£˘‹s
(
rbio
);

988 
	}
}

996 
	$gë_rbio_vîôiˇl_îr‹s
(
båfs_øid_bio
 *
rbio
, 
£˘‹_ƒ
,

997 *
Áûa
, *
Áûb
)

999 
°rùe_ƒ
;

1000 
found_îr‹s
 = 0;

1002 i‡(
Áûa
 || 
Áûb
) {

1007 
	`ASSERT
(
Áûa
 && 
Áûb
);

1008 *
Áûa
 = -1;

1009 *
Áûb
 = -1;

1012 
°rùe_ƒ
 = 0; såùe_ƒ < 
rbio
->
ªÆ_°rùes
; stripe_nr++) {

1013 
tŸÆ_£˘‹_ƒ
 = 
°rùe_ƒ
 * 
rbio
->
°rùe_n£˘‹s
 + 
£˘‹_ƒ
;

1015 i‡(
	`ã°_bô
(
tŸÆ_£˘‹_ƒ
, 
rbio
->
îr‹_bôm≠
)) {

1016 
found_îr‹s
++;

1017 i‡(
Áûa
) {

1019 i‡(*
Áûa
 < 0)

1020 *
Áûa
 = 
°rùe_ƒ
;

1021 i‡(*
Áûb
 < 0)

1022 *
Áûb
 = 
°rùe_ƒ
;

1026  
found_îr‹s
;

1027 
	}
}

1035 
	$rbio_add_io_£˘‹
(
båfs_øid_bio
 *
rbio
,

1036 
bio_li°
 *bio_list,

1037 
£˘‹_±r
 *
£˘‹
,

1038 
°rùe_ƒ
,

1039 
£˘‹_ƒ
,

1040 
ªq_›
 
›
)

1042 c⁄° 
u32
 
£˘‹size
 = 
rbio
->
bioc
->
fs_öfo
->sectorsize;

1043 
bio
 *
œ°
 = 
bio_li°
->
èû
;

1044 
ªt
;

1045 
bio
 *bio;

1046 
båfs_io_°rùe
 *
°rùe
;

1047 
u64
 
disk_°¨t
;

1054 
	`ASSERT
(
°rùe_ƒ
 >0 && såùe_ƒ < 
rbio
->
bioc
->
num_°rùes
);

1055 
	`ASSERT
(
£˘‹_ƒ
 >0 && se˘‹_ƒ < 
rbio
->
°rùe_n£˘‹s
);

1056 
	`ASSERT
(
£˘‹
->
∑ge
);

1058 
°rùe
 = &
rbio
->
bioc
->
°rùes
[
°rùe_ƒ
];

1059 
disk_°¨t
 = 
°rùe
->
physiˇl
 + 
£˘‹_ƒ
 * 
£˘‹size
;

1062 i‡(!
°rùe
->
dev
->
bdev
) {

1063 
found_îr‹s
;

1065 
	`£t_bô
(
°rùe_ƒ
 * 
rbio
->
°rùe_n£˘‹s
 + 
£˘‹_ƒ
,

1066 
rbio
->
îr‹_bôm≠
);

1069 
found_îr‹s
 = 
	`gë_rbio_vîôiˇl_îr‹s
(
rbio
, 
£˘‹_ƒ
,

1070 
NULL
, NULL);

1071 i‡(
found_îr‹s
 > 
rbio
->
bioc
->
max_îr‹s
)

1072  -
EIO
;

1077 i‡(
œ°
) {

1078 
u64
 
œ°_íd
 = 
œ°
->
bi_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
;

1079 
œ°_íd
 +
œ°
->
bi_ôî
.
bi_size
;

1085 i‡(
œ°_íd
 =
disk_°¨t
 && !
œ°
->
bi_°©us
 &&

1086 
œ°
->
bi_bdev
 =
°rùe
->
dev
->
bdev
) {

1087 
ªt
 = 
	`bio_add_∑ge
(
œ°
, 
£˘‹
->
∑ge
, 
£˘‹size
,

1088 
£˘‹
->
pgoff
);

1089 i‡(
ªt
 =
£˘‹size
)

1095 
bio
 = 
	`bio_Æloc
(
°rùe
->
dev
->
bdev
,

1096 
	`max
(
BTRFS_STRIPE_LEN
 >> 
PAGE_SHIFT
, 1),

1097 
›
, 
GFP_NOFS
);

1098 
bio
->
bi_ôî
.
bi_£˘‹
 = 
disk_°¨t
 >> 
SECTOR_SHIFT
;

1099 
bio
->
bi_¥iv©e
 = 
rbio
;

1101 
	`__bio_add_∑ge
(
bio
, 
£˘‹
->
∑ge
, 
£˘‹size
, se˘‹->
pgoff
);

1102 
	`bio_li°_add
(
bio_li°
, 
bio
);

1104 
	}
}

1106 
	$ödex_⁄e_bio
(
båfs_øid_bio
 *
rbio
, 
bio
 *bio)

1108 c⁄° 
u32
 
£˘‹size
 = 
rbio
->
bioc
->
fs_öfo
->sectorsize;

1109 
bio_vec
 
bvec
;

1110 
bvec_ôî
 
ôî
;

1111 
u32
 
off£t
 = (
bio
->
bi_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
) -

1112 
rbio
->
bioc
->
fuŒ_°rùe_logiˇl
;

1114 
	`bio_f‹_óch_£gmít
(
bvec
, 
bio
, 
ôî
) {

1115 
u32
 
bvec_off£t
;

1117 
bvec_off£t
 = 0; bvec_off£à< 
bvec
.
bv_Àn
;

1118 
bvec_off£t
 +
£˘‹size
, 
off£t
 += sectorsize) {

1119 
ödex
 = 
off£t
 / 
£˘‹size
;

1120 
£˘‹_±r
 *
£˘‹
 = &
rbio
->
bio_£˘‹s
[
ödex
];

1122 
£˘‹
->
∑ge
 = 
bvec
.
bv_∑ge
;

1123 
£˘‹
->
pgoff
 = 
bvec
.
bv_off£t
 + 
bvec_off£t
;

1124 
	`ASSERT
(
£˘‹
->
pgoff
 < 
PAGE_SIZE
);

1127 
	}
}

1137 
	$ödex_rbio_∑ges
(
båfs_øid_bio
 *
rbio
)

1139 
bio
 *bio;

1141 
	`•ö_lock
(&
rbio
->
bio_li°_lock
);

1142 
	`bio_li°_f‹_óch
(
bio
, &
rbio
->
bio_li°
)

1143 
	`ödex_⁄e_bio
(
rbio
, 
bio
);

1145 
	`•ö_u∆ock
(&
rbio
->
bio_li°_lock
);

1146 
	}
}

1148 
	$bio_gë_åa˚_öfo
(
båfs_øid_bio
 *
rbio
, 
bio
 *bio,

1149 
øid56_bio_åa˚_öfo
 *
åa˚_öfo
)

1151 c⁄° 
båfs_io_c⁄ãxt
 *
bioc
 = 
rbio
->bioc;

1152 
i
;

1154 
	`ASSERT
(
bioc
);

1157 i‡(!
bio
->
bi_bdev
)

1158 
nŸ_found
;

1160 
i
 = 0; i < 
bioc
->
num_°rùes
; i++) {

1161 i‡(
bio
->
bi_bdev
 !
bioc
->
°rùes
[
i
].
dev
->
bdev
)

1163 
åa˚_öfo
->
°rùe_ƒ
 = 
i
;

1164 
åa˚_öfo
->
devid
 = 
bioc
->
°rùes
[
i
].
dev
->devid;

1165 
åa˚_öfo
->
off£t
 = (
bio
->
bi_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
) -

1166 
bioc
->
°rùes
[
i
].
physiˇl
;

1170 
nŸ_found
:

1171 
åa˚_öfo
->
devid
 = -1;

1172 
åa˚_öfo
->
off£t
 = -1;

1173 
åa˚_öfo
->
°rùe_ƒ
 = -1;

1174 
	}
}

1176 
ölöe
 
	$bio_li°_put
(
bio_li°
 *bio_list)

1178 
bio
 *bio;

1180 (
bio
 = 
	`bio_li°_p›
(
bio_li°
)))

1181 
	`bio_put
(
bio
);

1182 
	}
}

1185 
	$gíî©e_pq_vîtiˇl
(
båfs_øid_bio
 *
rbio
, 
£˘‹ƒ
)

1187 **
poöãrs
 = 
rbio
->
föish_poöãrs
;

1188 c⁄° 
u32
 
£˘‹size
 = 
rbio
->
bioc
->
fs_öfo
->sectorsize;

1189 
£˘‹_±r
 *
£˘‹
;

1190 
°rùe
;

1191 c⁄° 
boﬁ
 
has_q°rùe
 = 
rbio
->
bioc
->
m≠_ty≥
 & 
BTRFS_BLOCK_GROUP_RAID6
;

1194 
°rùe
 = 0; såùê< 
rbio
->
ƒ_d©a
; stripe++) {

1195 
£˘‹
 = 
	`£˘‹_ö_rbio
(
rbio
, 
°rùe
, 
£˘‹ƒ
, 0);

1196 
poöãrs
[
°rùe
] = 
	`km≠_loˇl_∑ge
(
£˘‹
->
∑ge
) +

1197 
£˘‹
->
pgoff
;

1201 
£˘‹
 = 
	`rbio_p°rùe_£˘‹
(
rbio
, 
£˘‹ƒ
);

1202 
£˘‹
->
u±od©e
 = 1;

1203 
poöãrs
[
°rùe
++] = 
	`km≠_loˇl_∑ge
(
£˘‹
->
∑ge
Ë+ se˘‹->
pgoff
;

1205 i‡(
has_q°rùe
) {

1210 
£˘‹
 = 
	`rbio_q°rùe_£˘‹
(
rbio
, 
£˘‹ƒ
);

1211 
£˘‹
->
u±od©e
 = 1;

1212 
poöãrs
[
°rùe
++] = 
	`km≠_loˇl_∑ge
(
£˘‹
->
∑ge
) +

1213 
£˘‹
->
pgoff
;

1215 
øid6_ˇŒ
.
	`gí_syndrome
(
rbio
->
ªÆ_°rùes
, 
£˘‹size
,

1216 
poöãrs
);

1219 
	`mem˝y
(
poöãrs
[
rbio
->
ƒ_d©a
],Öoöãrs[0], 
£˘‹size
);

1220 
	`run_x‹
(
poöãrs
 + 1, 
rbio
->
ƒ_d©a
 - 1, 
£˘‹size
);

1222 
°rùe
 = stripe - 1; stripe >= 0; stripe--)

1223 
	`kunm≠_loˇl
(
poöãrs
[
°rùe
]);

1224 
	}
}

1226 
	$rmw_as£mbÀ_wrôe_bios
(
båfs_øid_bio
 *
rbio
,

1227 
bio_li°
 *bio_list)

1230 
tŸÆ_£˘‹_ƒ
;

1231 
£˘‹ƒ
;

1232 
°rùe
;

1233 
ªt
;

1235 
	`ASSERT
(
	`bio_li°_size
(
bio_li°
) == 0);

1238 
	`ASSERT
(
	`bôm≠_weight
(&
rbio
->
dbôm≠
,Ñbio->
°rùe_n£˘‹s
));

1244 
	`bôm≠_˛ór
(
rbio
->
îr‹_bôm≠
, 0,Ñbio->
ƒ_£˘‹s
);

1250 
tŸÆ_£˘‹_ƒ
 = 0;ÅŸÆ_£˘‹_ƒ < 
rbio
->
ƒ_£˘‹s
;

1251 
tŸÆ_£˘‹_ƒ
++) {

1252 
£˘‹_±r
 *
£˘‹
;

1254 
°rùe
 = 
tŸÆ_£˘‹_ƒ
 / 
rbio
->
°rùe_n£˘‹s
;

1255 
£˘‹ƒ
 = 
tŸÆ_£˘‹_ƒ
 % 
rbio
->
°rùe_n£˘‹s
;

1258 i‡(!
	`ã°_bô
(
£˘‹ƒ
, &
rbio
->
dbôm≠
))

1261 i‡(
°rùe
 < 
rbio
->
ƒ_d©a
) {

1262 
£˘‹
 = 
	`£˘‹_ö_rbio
(
rbio
, 
°rùe
, 
£˘‹ƒ
, 1);

1263 i‡(!
£˘‹
)

1266 
£˘‹
 = 
	`rbio_°rùe_£˘‹
(
rbio
, 
°rùe
, 
£˘‹ƒ
);

1269 
ªt
 = 
	`rbio_add_io_£˘‹
(
rbio
, 
bio_li°
, 
£˘‹
, 
°rùe
,

1270 
£˘‹ƒ
, 
REQ_OP_WRITE
);

1271 i‡(
ªt
)

1272 
îr‹
;

1275 i‡(
	`likñy
(!
rbio
->
bioc
->
ª∂a˚_ƒ_°rùes
))

1283 
	`ASSERT
(
rbio
->
bioc
->
ª∂a˚_°rùe_§c
 >= 0);

1285 
tŸÆ_£˘‹_ƒ
 = 0;ÅŸÆ_£˘‹_ƒ < 
rbio
->
ƒ_£˘‹s
;

1286 
tŸÆ_£˘‹_ƒ
++) {

1287 
£˘‹_±r
 *
£˘‹
;

1289 
°rùe
 = 
tŸÆ_£˘‹_ƒ
 / 
rbio
->
°rùe_n£˘‹s
;

1290 
£˘‹ƒ
 = 
tŸÆ_£˘‹_ƒ
 % 
rbio
->
°rùe_n£˘‹s
;

1297 i‡(
°rùe
 !
rbio
->
bioc
->
ª∂a˚_°rùe_§c
) {

1302 
	`ASSERT
(
£˘‹ƒ
 == 0);

1303 
tŸÆ_£˘‹_ƒ
 +
rbio
->
°rùe_n£˘‹s
 - 1;

1308 i‡(!
	`ã°_bô
(
£˘‹ƒ
, &
rbio
->
dbôm≠
))

1311 i‡(
°rùe
 < 
rbio
->
ƒ_d©a
) {

1312 
£˘‹
 = 
	`£˘‹_ö_rbio
(
rbio
, 
°rùe
, 
£˘‹ƒ
, 1);

1313 i‡(!
£˘‹
)

1316 
£˘‹
 = 
	`rbio_°rùe_£˘‹
(
rbio
, 
°rùe
, 
£˘‹ƒ
);

1319 
ªt
 = 
	`rbio_add_io_£˘‹
(
rbio
, 
bio_li°
, 
£˘‹
,

1320 
rbio
->
ªÆ_°rùes
,

1321 
£˘‹ƒ
, 
REQ_OP_WRITE
);

1322 i‡(
ªt
)

1323 
îr‹
;

1327 
îr‹
:

1328 
	`bio_li°_put
(
bio_li°
);

1329  -
EIO
;

1330 
	}
}

1332 
	$£t_rbio_ønge_îr‹
(
båfs_øid_bio
 *
rbio
, 
bio
 *bio)

1334 
båfs_fs_öfo
 *
fs_öfo
 = 
rbio
->
bioc
->fs_info;

1335 
u32
 
off£t
 = (
bio
->
bi_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
) -

1336 
rbio
->
bioc
->
fuŒ_°rùe_logiˇl
;

1337 
tŸÆ_ƒ_£˘‹
 = 
off£t
 >> 
fs_öfo
->
£˘‹size_bôs
;

1339 
	`ASSERT
(
tŸÆ_ƒ_£˘‹
 < 
rbio
->
ƒ_d©a
 *Ñbio->
°rùe_n£˘‹s
);

1341 
	`bôm≠_£t
(
rbio
->
îr‹_bôm≠
, 
tŸÆ_ƒ_£˘‹
,

1342 
bio
->
bi_ôî
.
bi_size
 >> 
fs_öfo
->
£˘‹size_bôs
);

1350 i‡(
bio
->
bi_ôî
.
bi_size
 == 0) {

1351 
boﬁ
 
found_missög
 = 
Ál£
;

1352 
°rùe_ƒ
;

1354 
°rùe_ƒ
 = 0; såùe_ƒ < 
rbio
->
ªÆ_°rùes
; stripe_nr++) {

1355 i‡(!
rbio
->
bioc
->
°rùes
[
°rùe_ƒ
].
dev
->
bdev
) {

1356 
found_missög
 = 
åue
;

1357 
	`bôm≠_£t
(
rbio
->
îr‹_bôm≠
,

1358 
°rùe_ƒ
 * 
rbio
->
°rùe_n£˘‹s
,

1359 
rbio
->
°rùe_n£˘‹s
);

1362 
	`ASSERT
(
found_missög
);

1364 
	}
}

1370 
£˘‹_±r
 *
	$föd_°rùe_£˘‹
(
båfs_øid_bio
 *
rbio
,

1371 
∑ge
 *page,

1372 
pgoff
)

1374 
i
;

1376 
i
 = 0; i < 
rbio
->
ƒ_£˘‹s
; i++) {

1377 
£˘‹_±r
 *
£˘‹
 = &
rbio
->
°rùe_£˘‹s
[
i
];

1379 i‡(
£˘‹
->
∑ge
 =∑gê&& se˘‹->
pgoff
 ==Ögoff)

1380  
£˘‹
;

1382  
NULL
;

1383 
	}
}

1389 
	$£t_bio_∑ges_u±od©e
(
båfs_øid_bio
 *
rbio
, 
bio
 *bio)

1391 c⁄° 
u32
 
£˘‹size
 = 
rbio
->
bioc
->
fs_öfo
->sectorsize;

1392 
bio_vec
 *
bvec
;

1393 
bvec_ôî_Æl
 
ôî_Æl
;

1395 
	`ASSERT
(!
	`bio_Êagged
(
bio
, 
BIO_CLONED
));

1397 
	`bio_f‹_óch_£gmít_Æl
(
bvec
, 
bio
, 
ôî_Æl
) {

1398 
£˘‹_±r
 *
£˘‹
;

1399 
pgoff
;

1401 
pgoff
 = 
bvec
->
bv_off£t
;Ögof‡- bvec->bv_off£à< bvec->
bv_Àn
;

1402 
pgoff
 +
£˘‹size
) {

1403 
£˘‹
 = 
	`föd_°rùe_£˘‹
(
rbio
, 
bvec
->
bv_∑ge
, 
pgoff
);

1404 
	`ASSERT
(
£˘‹
);

1405 i‡(
£˘‹
)

1406 
£˘‹
->
u±od©e
 = 1;

1409 
	}
}

1411 
	$gë_bio_£˘‹_ƒ
(
båfs_øid_bio
 *
rbio
, 
bio
 *bio)

1413 
bio_vec
 *
bv
 = 
	`bio_fú°_bvec_Æl
(
bio
);

1414 
i
;

1416 
i
 = 0; i < 
rbio
->
ƒ_£˘‹s
; i++) {

1417 
£˘‹_±r
 *
£˘‹
;

1419 
£˘‹
 = &
rbio
->
°rùe_£˘‹s
[
i
];

1420 i‡(
£˘‹
->
∑ge
 =
bv
->
bv_∑ge
 && se˘‹->
pgoff
 =bv->
bv_off£t
)

1422 
£˘‹
 = &
rbio
->
bio_£˘‹s
[
i
];

1423 i‡(
£˘‹
->
∑ge
 =
bv
->
bv_∑ge
 && se˘‹->
pgoff
 =bv->
bv_off£t
)

1426 
	`ASSERT
(
i
 < 
rbio
->
ƒ_£˘‹s
);

1427  
i
;

1428 
	}
}

1430 
	$rbio_upd©e_îr‹_bôm≠
(
båfs_øid_bio
 *
rbio
, 
bio
 *bio)

1432 
tŸÆ_£˘‹_ƒ
 = 
	`gë_bio_£˘‹_ƒ
(
rbio
, 
bio
);

1433 
u32
 
bio_size
 = 0;

1434 
bio_vec
 *
bvec
;

1435 
i
;

1437 
	`bio_f‹_óch_bvec_Æl
(
bvec
, 
bio
, 
i
)

1438 
bio_size
 +
bvec
->
bv_Àn
;

1446 
i
 = 
tŸÆ_£˘‹_ƒ
; i <Åotal_sector_nr +

1447 (
bio_size
 >> 
rbio
->
bioc
->
fs_öfo
->
£˘‹size_bôs
); 
i
++)

1448 
	`£t_bô
(
i
, 
rbio
->
îr‹_bôm≠
);

1449 
	}
}

1452 
	$vîify_bio_d©a_£˘‹s
(
båfs_øid_bio
 *
rbio
,

1453 
bio
 *bio)

1455 
båfs_fs_öfo
 *
fs_öfo
 = 
rbio
->
bioc
->fs_info;

1456 
tŸÆ_£˘‹_ƒ
 = 
	`gë_bio_£˘‹_ƒ
(
rbio
, 
bio
);

1457 
bio_vec
 *
bvec
;

1458 
bvec_ôî_Æl
 
ôî_Æl
;

1461 i‡(!
rbio
->
csum_bôm≠
 || !rbio->
csum_buf
)

1465 i‡(
tŸÆ_£˘‹_ƒ
 >
rbio
->
ƒ_d©a
 *Ñbio->
°rùe_n£˘‹s
)

1468 
	`bio_f‹_óch_£gmít_Æl
(
bvec
, 
bio
, 
ôî_Æl
) {

1469 
bv_off£t
;

1471 
bv_off£t
 = 
bvec
->bv_offset;

1472 
bv_off£t
 < 
bvec
->bv_off£à+ bvec->
bv_Àn
;

1473 
bv_off£t
 +
fs_öfo
->
£˘‹size
, 
tŸÆ_£˘‹_ƒ
++) {

1474 
u8
 
csum_buf
[
BTRFS_CSUM_SIZE
];

1475 
u8
 *
ex≥˘ed_csum
 = 
rbio
->
csum_buf
 +

1476 
tŸÆ_£˘‹_ƒ
 * 
fs_öfo
->
csum_size
;

1477 
ªt
;

1480 i‡(!
	`ã°_bô
(
tŸÆ_£˘‹_ƒ
, 
rbio
->
csum_bôm≠
))

1483 
ªt
 = 
	`båfs_check_£˘‹_csum
(
fs_öfo
, 
bvec
->
bv_∑ge
,

1484 
bv_off£t
, 
csum_buf
, 
ex≥˘ed_csum
);

1485 i‡(
ªt
 < 0)

1486 
	`£t_bô
(
tŸÆ_£˘‹_ƒ
, 
rbio
->
îr‹_bôm≠
);

1489 
	}
}

1491 
	$øid_waô_ªad_íd_io
(
bio
 *bio)

1493 
båfs_øid_bio
 *
rbio
 = 
bio
->
bi_¥iv©e
;

1495 i‡(
bio
->
bi_°©us
) {

1496 
	`rbio_upd©e_îr‹_bôm≠
(
rbio
, 
bio
);

1498 
	`£t_bio_∑ges_u±od©e
(
rbio
, 
bio
);

1499 
	`vîify_bio_d©a_£˘‹s
(
rbio
, 
bio
);

1502 
	`bio_put
(
bio
);

1503 i‡(
	`©omic_dec_™d_ã°
(&
rbio
->
°rùes_≥ndög
))

1504 
	`wake_up
(&
rbio
->
io_waô
);

1505 
	}
}

1507 
	$submô_ªad_waô_bio_li°
(
båfs_øid_bio
 *
rbio
,

1508 
bio_li°
 *bio_list)

1510 
bio
 *bio;

1512 
	`©omic_£t
(&
rbio
->
°rùes_≥ndög
, 
	`bio_li°_size
(
bio_li°
));

1513 (
bio
 = 
	`bio_li°_p›
(
bio_li°
))) {

1514 
bio
->
bi_íd_io
 = 
øid_waô_ªad_íd_io
;

1516 i‡(
	`åa˚_øid56_ªad_íabÀd
()) {

1517 
øid56_bio_åa˚_öfo
 
åa˚_öfo
 = { 0 };

1519 
	`bio_gë_åa˚_öfo
(
rbio
, 
bio
, &
åa˚_öfo
);

1520 
	`åa˚_øid56_ªad
(
rbio
, 
bio
, &
åa˚_öfo
);

1522 
	`submô_bio
(
bio
);

1525 
	`waô_evít
(
rbio
->
io_waô
, 
	`©omic_ªad
(&rbio->
°rùes_≥ndög
) == 0);

1526 
	}
}

1528 
	$Æloc_rbio_d©a_∑ges
(
båfs_øid_bio
 *
rbio
)

1530 c⁄° 
d©a_∑ges
 = 
rbio
->
ƒ_d©a
 *Ñbio->
°rùe_≈ages
;

1531 
ªt
;

1533 
ªt
 = 
	`båfs_Æloc_∑ge_¨øy
(
d©a_∑ges
, 
rbio
->
°rùe_∑ges
);

1534 i‡(
ªt
 < 0)

1535  
ªt
;

1537 
	`ödex_°rùe_£˘‹s
(
rbio
);

1539 
	}
}

1548 
	sbåfs_∂ug_cb
 {

1549 
blk_∂ug_cb
 
	mcb
;

1550 
båfs_fs_öfo
 *
	möfo
;

1551 
li°_hód
 
	mrbio_li°
;

1552 
w‹k_°ru˘
 
	mw‹k
;

1558 
	$∂ug_cmp
(*
¥iv
, c⁄° 
li°_hód
 *
a
,

1559 c⁄° 
li°_hód
 *
b
)

1561 c⁄° 
båfs_øid_bio
 *
ø
 = 
	`c⁄èöî_of
(
a
, btrfs_raid_bio,

1562 
∂ug_li°
);

1563 c⁄° 
båfs_øid_bio
 *
rb
 = 
	`c⁄èöî_of
(
b
, btrfs_raid_bio,

1564 
∂ug_li°
);

1565 
u64
 
a_£˘‹
 = 
ø
->
bio_li°
.
hód
->
bi_ôî
.
bi_£˘‹
;

1566 
u64
 
b_£˘‹
 = 
rb
->
bio_li°
.
hód
->
bi_ôî
.
bi_£˘‹
;

1568 i‡(
a_£˘‹
 < 
b_£˘‹
)

1570 i‡(
a_£˘‹
 > 
b_£˘‹
)

1573 
	}
}

1575 
	$øid_u≈lug
(
blk_∂ug_cb
 *
cb
, 
boﬁ
 
‰om_scheduÀ
)

1577 
båfs_∂ug_cb
 *
∂ug
 = 
	`c⁄èöî_of
(
cb
, btrfs_plug_cb, cb);

1578 
båfs_øid_bio
 *
cur
;

1579 
båfs_øid_bio
 *
œ°
 = 
NULL
;

1581 
	`li°_s‹t
(
NULL
, &
∂ug
->
rbio_li°
, 
∂ug_cmp
);

1583 !
	`li°_em±y
(&
∂ug
->
rbio_li°
)) {

1584 
cur
 = 
	`li°_íåy
(
∂ug
->
rbio_li°
.
√xt
,

1585 
båfs_øid_bio
, 
∂ug_li°
);

1586 
	`li°_dñ_öô
(&
cur
->
∂ug_li°
);

1588 i‡(
	`rbio_is_fuŒ
(
cur
)) {

1590 
	`°¨t_async_w‹k
(
cur
, 
rmw_rbio_w‹k
);

1593 i‡(
œ°
) {

1594 i‡(
	`rbio_ˇn_mîge
(
œ°
, 
cur
)) {

1595 
	`mîge_rbio
(
œ°
, 
cur
);

1596 
	`‰ì_øid_bio
(
cur
);

1599 
	`°¨t_async_w‹k
(
œ°
, 
rmw_rbio_w‹k
);

1601 
œ°
 = 
cur
;

1603 i‡(
œ°
)

1604 
	`°¨t_async_w‹k
(
œ°
, 
rmw_rbio_w‹k
);

1605 
	`k‰ì
(
∂ug
);

1606 
	}
}

1609 
	$rbio_add_bio
(
båfs_øid_bio
 *
rbio
, 
bio
 *
‹ig_bio
)

1611 c⁄° 
båfs_fs_öfo
 *
fs_öfo
 = 
rbio
->
bioc
->fs_info;

1612 c⁄° 
u64
 
‹ig_logiˇl
 = 
‹ig_bio
->
bi_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
;

1613 c⁄° 
u64
 
fuŒ_°rùe_°¨t
 = 
rbio
->
bioc
->
fuŒ_°rùe_logiˇl
;

1614 c⁄° 
u32
 
‹ig_Àn
 = 
‹ig_bio
->
bi_ôî
.
bi_size
;

1615 c⁄° 
u32
 
£˘‹size
 = 
fs_öfo
->sectorsize;

1616 
u64
 
cur_logiˇl
;

1618 
	`ASSERT
(
‹ig_logiˇl
 >
fuŒ_°rùe_°¨t
 &&

1619 
‹ig_logiˇl
 + 
‹ig_Àn
 <
fuŒ_°rùe_°¨t
 +

1620 
rbio
->
ƒ_d©a
 * 
BTRFS_STRIPE_LEN
);

1622 
	`bio_li°_add
(&
rbio
->
bio_li°
, 
‹ig_bio
);

1623 
rbio
->
bio_li°_byãs
 +
‹ig_bio
->
bi_ôî
.
bi_size
;

1626 
cur_logiˇl
 = 
‹ig_logiˇl
; cur_logiˇ»< orig_logiˇ»+ 
‹ig_Àn
;

1627 
cur_logiˇl
 +
£˘‹size
) {

1628 
bô
 = ((
u32
)(
cur_logiˇl
 - 
fuŒ_°rùe_°¨t
) >>

1629 
fs_öfo
->
£˘‹size_bôs
Ë% 
rbio
->
°rùe_n£˘‹s
;

1631 
	`£t_bô
(
bô
, &
rbio
->
dbôm≠
);

1633 
	}
}

1638 
	$øid56_∑rôy_wrôe
(
bio
 *bio, 
båfs_io_c⁄ãxt
 *
bioc
)

1640 
båfs_fs_öfo
 *
fs_öfo
 = 
bioc
->fs_info;

1641 
båfs_øid_bio
 *
rbio
;

1642 
båfs_∂ug_cb
 *
∂ug
 = 
NULL
;

1643 
blk_∂ug_cb
 *
cb
;

1645 
rbio
 = 
	`Æloc_rbio
(
fs_öfo
, 
bioc
);

1646 i‡(
	`IS_ERR
(
rbio
)) {

1647 
bio
->
bi_°©us
 = 
	`î∫o_to_blk_°©us
(
	`PTR_ERR
(
rbio
));

1648 
	`bio_ídio
(
bio
);

1651 
rbio
->
›î©i⁄
 = 
BTRFS_RBIO_WRITE
;

1652 
	`rbio_add_bio
(
rbio
, 
bio
);

1658 i‡(!
	`rbio_is_fuŒ
(
rbio
)) {

1659 
cb
 = 
	`blk_check_∂ugged
(
øid_u≈lug
, 
fs_öfo
, (*
∂ug
));

1660 i‡(
cb
) {

1661 
∂ug
 = 
	`c⁄èöî_of
(
cb
, 
båfs_∂ug_cb
, cb);

1662 i‡(!
∂ug
->
öfo
) {

1663 
∂ug
->
öfo
 = 
fs_öfo
;

1664 
	`INIT_LIST_HEAD
(&
∂ug
->
rbio_li°
);

1666 
	`li°_add_èû
(&
rbio
->
∂ug_li°
, &
∂ug
->
rbio_li°
);

1675 
	`°¨t_async_w‹k
(
rbio
, 
rmw_rbio_w‹k
);

1676 
	}
}

1678 
	$vîify_⁄e_£˘‹
(
båfs_øid_bio
 *
rbio
,

1679 
°rùe_ƒ
, 
£˘‹_ƒ
)

1681 
båfs_fs_öfo
 *
fs_öfo
 = 
rbio
->
bioc
->fs_info;

1682 
£˘‹_±r
 *
£˘‹
;

1683 
u8
 
csum_buf
[
BTRFS_CSUM_SIZE
];

1684 
u8
 *
csum_ex≥˘ed
;

1685 
ªt
;

1687 i‡(!
rbio
->
csum_bôm≠
 || !rbio->
csum_buf
)

1691 i‡(
°rùe_ƒ
 >
rbio
->
ƒ_d©a
)

1697 i‡(
rbio
->
›î©i⁄
 =
BTRFS_RBIO_READ_REBUILD
) {

1698 
£˘‹
 = 
	`£˘‹_ö_rbio
(
rbio
, 
°rùe_ƒ
, 
£˘‹_ƒ
, 0);

1700 
£˘‹
 = 
	`rbio_°rùe_£˘‹
(
rbio
, 
°rùe_ƒ
, 
£˘‹_ƒ
);

1703 
	`ASSERT
(
£˘‹
->
∑ge
);

1705 
csum_ex≥˘ed
 = 
rbio
->
csum_buf
 +

1706 (
°rùe_ƒ
 * 
rbio
->
°rùe_n£˘‹s
 + 
£˘‹_ƒ
) *

1707 
fs_öfo
->
csum_size
;

1708 
ªt
 = 
	`båfs_check_£˘‹_csum
(
fs_öfo
, 
£˘‹
->
∑ge
, se˘‹->
pgoff
,

1709 
csum_buf
, 
csum_ex≥˘ed
);

1710  
ªt
;

1711 
	}
}

1718 
	$ªcovî_vîtiˇl
(
båfs_øid_bio
 *
rbio
, 
£˘‹_ƒ
,

1719 **
poöãrs
, **
unm≠_¨øy
)

1721 
båfs_fs_öfo
 *
fs_öfo
 = 
rbio
->
bioc
->fs_info;

1722 
£˘‹_±r
 *
£˘‹
;

1723 c⁄° 
u32
 
£˘‹size
 = 
fs_öfo
->sectorsize;

1724 
found_îr‹s
;

1725 
Áûa
;

1726 
Áûb
;

1727 
°rùe_ƒ
;

1728 
ªt
 = 0;

1734 i‡(
rbio
->
›î©i⁄
 =
BTRFS_RBIO_PARITY_SCRUB
 &&

1735 !
	`ã°_bô
(
£˘‹_ƒ
, &
rbio
->
dbôm≠
))

1738 
found_îr‹s
 = 
	`gë_rbio_vîôiˇl_îr‹s
(
rbio
, 
£˘‹_ƒ
, &
Áûa
,

1739 &
Áûb
);

1744 i‡(!
found_îr‹s
)

1747 i‡(
found_îr‹s
 > 
rbio
->
bioc
->
max_îr‹s
)

1748  -
EIO
;

1756 
°rùe_ƒ
 = 0; såùe_ƒ < 
rbio
->
ªÆ_°rùes
; stripe_nr++) {

1761 i‡(
rbio
->
›î©i⁄
 =
BTRFS_RBIO_READ_REBUILD
) {

1762 
£˘‹
 = 
	`£˘‹_ö_rbio
(
rbio
, 
°rùe_ƒ
, 
£˘‹_ƒ
, 0);

1764 
£˘‹
 = 
	`rbio_°rùe_£˘‹
(
rbio
, 
°rùe_ƒ
, 
£˘‹_ƒ
);

1766 
	`ASSERT
(
£˘‹
->
∑ge
);

1767 
poöãrs
[
°rùe_ƒ
] = 
	`km≠_loˇl_∑ge
(
£˘‹
->
∑ge
) +

1768 
£˘‹
->
pgoff
;

1769 
unm≠_¨øy
[
°rùe_ƒ
] = 
poöãrs
[stripe_nr];

1773 i‡(
rbio
->
bioc
->
m≠_ty≥
 & 
BTRFS_BLOCK_GROUP_RAID6
) {

1775 i‡(
Áûb
 < 0) {

1776 i‡(
Áûa
 =
rbio
->
ƒ_d©a
)

1783 
˛ónup
;

1788 
p°rùe
;

1798 i‡(
Áûb
 =
rbio
->
ªÆ_°rùes
 - 1) {

1799 i‡(
Áûa
 =
rbio
->
ªÆ_°rùes
 - 2)

1805 
˛ónup
;

1810 
p°rùe
;

1813 i‡(
Áûb
 =
rbio
->
ªÆ_°rùes
 - 2) {

1814 
	`øid6_d©≠_ªcov
(
rbio
->
ªÆ_°rùes
, 
£˘‹size
,

1815 
Áûa
, 
poöãrs
);

1817 
	`øid6_2d©a_ªcov
(
rbio
->
ªÆ_°rùes
, 
£˘‹size
,

1818 
Áûa
, 
Áûb
, 
poöãrs
);

1821 *
p
;

1824 
	`ASSERT
(
Áûb
 == -1);

1825 
p°rùe
:

1827 
	`mem˝y
(
poöãrs
[
Áûa
],Öoöãrs[
rbio
->
ƒ_d©a
], 
£˘‹size
);

1830 
p
 = 
poöãrs
[
Áûa
];

1831 
°rùe_ƒ
 = 
Áûa
; såùe_ƒ < 
rbio
->
ƒ_d©a
 - 1;

1832 
°rùe_ƒ
++)

1833 
poöãrs
[
°rùe_ƒ
] =Öointers[stripe_nr + 1];

1834 
poöãrs
[
rbio
->
ƒ_d©a
 - 1] = 
p
;

1837 
	`run_x‹
(
poöãrs
, 
rbio
->
ƒ_d©a
 - 1, 
£˘‹size
);

1851 i‡(
Áûa
 >= 0) {

1852 
ªt
 = 
	`vîify_⁄e_£˘‹
(
rbio
, 
Áûa
, 
£˘‹_ƒ
);

1853 i‡(
ªt
 < 0)

1854 
˛ónup
;

1856 
£˘‹
 = 
	`rbio_°rùe_£˘‹
(
rbio
, 
Áûa
, 
£˘‹_ƒ
);

1857 
£˘‹
->
u±od©e
 = 1;

1859 i‡(
Áûb
 >= 0) {

1860 
ªt
 = 
	`vîify_⁄e_£˘‹
(
rbio
, 
Áûb
, 
£˘‹_ƒ
);

1861 i‡(
ªt
 < 0)

1862 
˛ónup
;

1864 
£˘‹
 = 
	`rbio_°rùe_£˘‹
(
rbio
, 
Áûb
, 
£˘‹_ƒ
);

1865 
£˘‹
->
u±od©e
 = 1;

1868 
˛ónup
:

1869 
°rùe_ƒ
 = 
rbio
->
ªÆ_°rùes
 - 1; stripe_nr >= 0; stripe_nr--)

1870 
	`kunm≠_loˇl
(
unm≠_¨øy
[
°rùe_ƒ
]);

1871  
ªt
;

1872 
	}
}

1874 
	$ªcovî_£˘‹s
(
båfs_øid_bio
 *
rbio
)

1876 **
poöãrs
 = 
NULL
;

1877 **
unm≠_¨øy
 = 
NULL
;

1878 
£˘‹ƒ
;

1879 
ªt
 = 0;

1887 
poöãrs
 = 
	`kˇŒoc
(
rbio
->
ªÆ_°rùes
, (*), 
GFP_NOFS
);

1888 
unm≠_¨øy
 = 
	`kˇŒoc
(
rbio
->
ªÆ_°rùes
, (*), 
GFP_NOFS
);

1889 i‡(!
poöãrs
 || !
unm≠_¨øy
) {

1890 
ªt
 = -
ENOMEM
;

1891 
out
;

1894 i‡(
rbio
->
›î©i⁄
 =
BTRFS_RBIO_READ_REBUILD
) {

1895 
	`•ö_lock
(&
rbio
->
bio_li°_lock
);

1896 
	`£t_bô
(
RBIO_RMW_LOCKED_BIT
, &
rbio
->
Êags
);

1897 
	`•ö_u∆ock
(&
rbio
->
bio_li°_lock
);

1900 
	`ödex_rbio_∑ges
(
rbio
);

1902 
£˘‹ƒ
 = 0; se˘‹ƒ < 
rbio
->
°rùe_n£˘‹s
; sectornr++) {

1903 
ªt
 = 
	`ªcovî_vîtiˇl
(
rbio
, 
£˘‹ƒ
, 
poöãrs
, 
unm≠_¨øy
);

1904 i‡(
ªt
 < 0)

1908 
out
:

1909 
	`k‰ì
(
poöãrs
);

1910 
	`k‰ì
(
unm≠_¨øy
);

1911  
ªt
;

1912 
	}
}

1914 
	$ªcovî_rbio
(
båfs_øid_bio
 *
rbio
)

1916 
bio_li°
 bio_li° = 
BIO_EMPTY_LIST
;

1917 
tŸÆ_£˘‹_ƒ
;

1918 
ªt
 = 0;

1924 
	`ASSERT
(
	`bôm≠_weight
(
rbio
->
îr‹_bôm≠
,Ñbio->
ƒ_£˘‹s
));

1927 
ªt
 = 
	`Æloc_rbio_∑ges
(
rbio
);

1928 i‡(
ªt
 < 0)

1929 
out
;

1931 
	`ödex_rbio_∑ges
(
rbio
);

1941 
tŸÆ_£˘‹_ƒ
 = 0;ÅŸÆ_£˘‹_ƒ < 
rbio
->
ƒ_£˘‹s
;

1942 
tŸÆ_£˘‹_ƒ
++) {

1943 
°rùe
 = 
tŸÆ_£˘‹_ƒ
 / 
rbio
->
°rùe_n£˘‹s
;

1944 
£˘‹ƒ
 = 
tŸÆ_£˘‹_ƒ
 % 
rbio
->
°rùe_n£˘‹s
;

1945 
£˘‹_±r
 *
£˘‹
;

1952 i‡(!
rbio
->
bioc
->
°rùes
[
°rùe
].
dev
->
bdev
 ||

1953 
	`ã°_bô
(
tŸÆ_£˘‹_ƒ
, 
rbio
->
îr‹_bôm≠
)) {

1958 
	`£t_bô
(
tŸÆ_£˘‹_ƒ
, 
rbio
->
îr‹_bôm≠
);

1962 
£˘‹
 = 
	`rbio_°rùe_£˘‹
(
rbio
, 
°rùe
, 
£˘‹ƒ
);

1963 
ªt
 = 
	`rbio_add_io_£˘‹
(
rbio
, &
bio_li°
, 
£˘‹
, 
°rùe
,

1964 
£˘‹ƒ
, 
REQ_OP_READ
);

1965 i‡(
ªt
 < 0) {

1966 
	`bio_li°_put
(&
bio_li°
);

1967 
out
;

1971 
	`submô_ªad_waô_bio_li°
(
rbio
, &
bio_li°
);

1972 
ªt
 = 
	`ªcovî_£˘‹s
(
rbio
);

1973 
out
:

1974 
	`rbio_‹ig_íd_io
(
rbio
, 
	`î∫o_to_blk_°©us
(
ªt
));

1975 
	}
}

1977 
	$ªcovî_rbio_w‹k
(
w‹k_°ru˘
 *
w‹k
)

1979 
båfs_øid_bio
 *
rbio
;

1981 
rbio
 = 
	`c⁄èöî_of
(
w‹k
, 
båfs_øid_bio
, work);

1982 i‡(!
	`lock_°rùe_add
(
rbio
))

1983 
	`ªcovî_rbio
(
rbio
);

1984 
	}
}

1986 
	$ªcovî_rbio_w‹k_locked
(
w‹k_°ru˘
 *
w‹k
)

1988 
	`ªcovî_rbio
(
	`c⁄èöî_of
(
w‹k
, 
båfs_øid_bio
, work));

1989 
	}
}

1991 
	$£t_rbio_øid6_exåa_îr‹
(
båfs_øid_bio
 *
rbio
, 
múr‹_num
)

1993 
boﬁ
 
found
 = 
Ál£
;

1994 
£˘‹_ƒ
;

2002 
	`ASSERT
(
múr‹_num
 > 2);

2003 
£˘‹_ƒ
 = 0; se˘‹_ƒ < 
rbio
->
°rùe_n£˘‹s
; sector_nr++) {

2004 
found_îr‹s
;

2005 
Áûa
;

2006 
Áûb
;

2008 
found_îr‹s
 = 
	`gë_rbio_vîôiˇl_îr‹s
(
rbio
, 
£˘‹_ƒ
,

2009 &
Áûa
, &
Áûb
);

2011 i‡(!
found_îr‹s
)

2018 
	`ASSERT
(
found_îr‹s
 == 1);

2019 
found
 = 
åue
;

2022 
Áûb
 = 
rbio
->
ªÆ_°rùes
 - (
múr‹_num
 - 1);

2023 i‡(
Áûb
 <
Áûa
)

2024 
Áûb
--;

2027 i‡(
Áûb
 >= 0)

2028 
	`£t_bô
(
Áûb
 * 
rbio
->
°rùe_n£˘‹s
 + 
£˘‹_ƒ
,

2029 
rbio
->
îr‹_bôm≠
);

2033 
	`ASSERT
(
found
);

2034 
	}
}

2042 
	$øid56_∑rôy_ªcovî
(
bio
 *bio, 
båfs_io_c⁄ãxt
 *
bioc
,

2043 
múr‹_num
)

2045 
båfs_fs_öfo
 *
fs_öfo
 = 
bioc
->fs_info;

2046 
båfs_øid_bio
 *
rbio
;

2048 
rbio
 = 
	`Æloc_rbio
(
fs_öfo
, 
bioc
);

2049 i‡(
	`IS_ERR
(
rbio
)) {

2050 
bio
->
bi_°©us
 = 
	`î∫o_to_blk_°©us
(
	`PTR_ERR
(
rbio
));

2051 
	`bio_ídio
(
bio
);

2055 
rbio
->
›î©i⁄
 = 
BTRFS_RBIO_READ_REBUILD
;

2056 
	`rbio_add_bio
(
rbio
, 
bio
);

2058 
	`£t_rbio_ønge_îr‹
(
rbio
, 
bio
);

2065 i‡(
múr‹_num
 > 2)

2066 
	`£t_rbio_øid6_exåa_îr‹
(
rbio
, 
múr‹_num
);

2068 
	`°¨t_async_w‹k
(
rbio
, 
ªcovî_rbio_w‹k
);

2069 
	}
}

2071 
	$fûl_d©a_csums
(
båfs_øid_bio
 *
rbio
)

2073 
båfs_fs_öfo
 *
fs_öfo
 = 
rbio
->
bioc
->fs_info;

2074 
båfs_roŸ
 *
csum_roŸ
 = 
	`båfs_csum_roŸ
(
fs_öfo
,

2075 
rbio
->
bioc
->
fuŒ_°rùe_logiˇl
);

2076 c⁄° 
u64
 
°¨t
 = 
rbio
->
bioc
->
fuŒ_°rùe_logiˇl
;

2077 c⁄° 
u32
 
Àn
 = (
rbio
->
ƒ_d©a
 *Ñbio->
°rùe_n£˘‹s
) <<

2078 
fs_öfo
->
£˘‹size_bôs
;

2079 
ªt
;

2082 
	`ASSERT
(!
rbio
->
csum_buf
 && !rbio->
csum_bôm≠
);

2095 i‡(!(
rbio
->
bioc
->
m≠_ty≥
 & 
BTRFS_BLOCK_GROUP_DATA
) ||

2096 
rbio
->
bioc
->
m≠_ty≥
 & 
BTRFS_BLOCK_GROUP_METADATA
)

2099 
rbio
->
csum_buf
 = 
	`kzÆloc
‘bio->
ƒ_d©a
 *Ñbio->
°rùe_n£˘‹s
 *

2100 
fs_öfo
->
csum_size
, 
GFP_NOFS
);

2101 
rbio
->
csum_bôm≠
 = 
	`bôm≠_zÆloc
‘bio->
ƒ_d©a
 *Ñbio->
°rùe_n£˘‹s
,

2102 
GFP_NOFS
);

2103 i‡(!
rbio
->
csum_buf
 || !rbio->
csum_bôm≠
) {

2104 
ªt
 = -
ENOMEM
;

2105 
îr‹
;

2108 
ªt
 = 
	`båfs_lookup_csums_bôm≠
(
csum_roŸ
, 
NULL
, 
°¨t
, sèπ + 
Àn
 - 1,

2109 
rbio
->
csum_buf
,Ñbio->
csum_bôm≠
);

2110 i‡(
ªt
 < 0)

2111 
îr‹
;

2112 i‡(
	`bôm≠_em±y
(
rbio
->
csum_bôm≠
, 
Àn
 >> 
fs_öfo
->
£˘‹size_bôs
))

2113 
no_csum
;

2116 
îr‹
:

2122 
	`båfs_w¨n_æ
(
fs_öfo
,

2124 
rbio
->
bioc
->
fuŒ_°rùe_logiˇl
, 
ªt
);

2125 
no_csum
:

2126 
	`k‰ì
(
rbio
->
csum_buf
);

2127 
	`bôm≠_‰ì
(
rbio
->
csum_bôm≠
);

2128 
rbio
->
csum_buf
 = 
NULL
;

2129 
rbio
->
csum_bôm≠
 = 
NULL
;

2130 
	}
}

2132 
	$rmw_ªad_waô_ªcovî
(
båfs_øid_bio
 *
rbio
)

2134 
bio_li°
 bio_li° = 
BIO_EMPTY_LIST
;

2135 
tŸÆ_£˘‹_ƒ
;

2136 
ªt
 = 0;

2143 
	`fûl_d©a_csums
(
rbio
);

2150 
tŸÆ_£˘‹_ƒ
 = 0;ÅŸÆ_£˘‹_ƒ < 
rbio
->
ƒ_£˘‹s
;

2151 
tŸÆ_£˘‹_ƒ
++) {

2152 
£˘‹_±r
 *
£˘‹
;

2153 
°rùe
 = 
tŸÆ_£˘‹_ƒ
 / 
rbio
->
°rùe_n£˘‹s
;

2154 
£˘‹ƒ
 = 
tŸÆ_£˘‹_ƒ
 % 
rbio
->
°rùe_n£˘‹s
;

2156 
£˘‹
 = 
	`rbio_°rùe_£˘‹
(
rbio
, 
°rùe
, 
£˘‹ƒ
);

2157 
ªt
 = 
	`rbio_add_io_£˘‹
(
rbio
, &
bio_li°
, 
£˘‹
,

2158 
°rùe
, 
£˘‹ƒ
, 
REQ_OP_READ
);

2159 i‡(
ªt
) {

2160 
	`bio_li°_put
(&
bio_li°
);

2161  
ªt
;

2169 
	`submô_ªad_waô_bio_li°
(
rbio
, &
bio_li°
);

2170  
	`ªcovî_£˘‹s
(
rbio
);

2171 
	}
}

2173 
	$øid_waô_wrôe_íd_io
(
bio
 *bio)

2175 
båfs_øid_bio
 *
rbio
 = 
bio
->
bi_¥iv©e
;

2176 
blk_°©us_t
 
îr
 = 
bio
->
bi_°©us
;

2178 i‡(
îr
)

2179 
	`rbio_upd©e_îr‹_bôm≠
(
rbio
, 
bio
);

2180 
	`bio_put
(
bio
);

2181 i‡(
	`©omic_dec_™d_ã°
(&
rbio
->
°rùes_≥ndög
))

2182 
	`wake_up
(&
rbio
->
io_waô
);

2183 
	}
}

2185 
	$submô_wrôe_bios
(
båfs_øid_bio
 *
rbio
,

2186 
bio_li°
 *bio_list)

2188 
bio
 *bio;

2190 
	`©omic_£t
(&
rbio
->
°rùes_≥ndög
, 
	`bio_li°_size
(
bio_li°
));

2191 (
bio
 = 
	`bio_li°_p›
(
bio_li°
))) {

2192 
bio
->
bi_íd_io
 = 
øid_waô_wrôe_íd_io
;

2194 i‡(
	`åa˚_øid56_wrôe_íabÀd
()) {

2195 
øid56_bio_åa˚_öfo
 
åa˚_öfo
 = { 0 };

2197 
	`bio_gë_åa˚_öfo
(
rbio
, 
bio
, &
åa˚_öfo
);

2198 
	`åa˚_øid56_wrôe
(
rbio
, 
bio
, &
åa˚_öfo
);

2200 
	`submô_bio
(
bio
);

2202 
	}
}

2208 
boﬁ
 
	$√ed_ªad_°rùe_£˘‹s
(
båfs_øid_bio
 *
rbio
)

2210 
i
;

2212 
i
 = 0; i < 
rbio
->
ƒ_d©a
 *Ñbio->
°rùe_n£˘‹s
; i++) {

2213 
£˘‹_±r
 *
£˘‹
 = &
rbio
->
°rùe_£˘‹s
[
i
];

2220 i‡(!
£˘‹
->
∑ge
 || !£˘‹->
u±od©e
)

2221  
åue
;

2223  
Ál£
;

2224 
	}
}

2226 
	$rmw_rbio
(
båfs_øid_bio
 *
rbio
)

2228 
bio_li°
 bio_list;

2229 
£˘‹ƒ
;

2230 
ªt
 = 0;

2236 
ªt
 = 
	`Æloc_rbio_∑rôy_∑ges
(
rbio
);

2237 i‡(
ªt
 < 0)

2238 
out
;

2244 i‡(!
	`rbio_is_fuŒ
(
rbio
Ë&& 
	`√ed_ªad_°rùe_£˘‹s
(rbio)) {

2249 
ªt
 = 
	`Æloc_rbio_d©a_∑ges
(
rbio
);

2250 i‡(
ªt
 < 0)

2251 
out
;

2253 
	`ödex_rbio_∑ges
(
rbio
);

2255 
ªt
 = 
	`rmw_ªad_waô_ªcovî
(
rbio
);

2256 i‡(
ªt
 < 0)

2257 
out
;

2265 
	`•ö_lock
(&
rbio
->
bio_li°_lock
);

2266 
	`£t_bô
(
RBIO_RMW_LOCKED_BIT
, &
rbio
->
Êags
);

2267 
	`•ö_u∆ock
(&
rbio
->
bio_li°_lock
);

2269 
	`bôm≠_˛ór
(
rbio
->
îr‹_bôm≠
, 0,Ñbio->
ƒ_£˘‹s
);

2271 
	`ödex_rbio_∑ges
(
rbio
);

2279 i‡(!
	`rbio_is_fuŒ
(
rbio
))

2280 
	`ˇche_rbio_∑ges
(
rbio
);

2282 
	`˛ór_bô
(
RBIO_CACHE_READY_BIT
, &
rbio
->
Êags
);

2284 
£˘‹ƒ
 = 0; se˘‹ƒ < 
rbio
->
°rùe_n£˘‹s
; sectornr++)

2285 
	`gíî©e_pq_vîtiˇl
(
rbio
, 
£˘‹ƒ
);

2287 
	`bio_li°_öô
(&
bio_li°
);

2288 
ªt
 = 
	`rmw_as£mbÀ_wrôe_bios
(
rbio
, &
bio_li°
);

2289 i‡(
ªt
 < 0)

2290 
out
;

2293 
	`ASSERT
(
	`bio_li°_size
(&
bio_li°
));

2294 
	`submô_wrôe_bios
(
rbio
, &
bio_li°
);

2295 
	`waô_evít
(
rbio
->
io_waô
, 
	`©omic_ªad
(&rbio->
°rùes_≥ndög
) == 0);

2298 
£˘‹ƒ
 = 0; se˘‹ƒ < 
rbio
->
°rùe_n£˘‹s
; sectornr++) {

2299 
found_îr‹s
;

2301 
found_îr‹s
 = 
	`gë_rbio_vîôiˇl_îr‹s
(
rbio
, 
£˘‹ƒ
, 
NULL
, NULL);

2302 i‡(
found_îr‹s
 > 
rbio
->
bioc
->
max_îr‹s
) {

2303 
ªt
 = -
EIO
;

2307 
out
:

2308 
	`rbio_‹ig_íd_io
(
rbio
, 
	`î∫o_to_blk_°©us
(
ªt
));

2309 
	}
}

2311 
	$rmw_rbio_w‹k
(
w‹k_°ru˘
 *
w‹k
)

2313 
båfs_øid_bio
 *
rbio
;

2315 
rbio
 = 
	`c⁄èöî_of
(
w‹k
, 
båfs_øid_bio
, work);

2316 i‡(
	`lock_°rùe_add
(
rbio
) == 0)

2317 
	`rmw_rbio
(
rbio
);

2318 
	}
}

2320 
	$rmw_rbio_w‹k_locked
(
w‹k_°ru˘
 *
w‹k
)

2322 
	`rmw_rbio
(
	`c⁄èöî_of
(
w‹k
, 
båfs_øid_bio
, work));

2323 
	}
}

2335 
båfs_øid_bio
 *
	$øid56_∑rôy_Æloc_s¸ub_rbio
(
bio
 *bio,

2336 
båfs_io_c⁄ãxt
 *
bioc
,

2337 
båfs_devi˚
 *
s¸ub_dev
,

2338 *
dbôm≠
, 
°rùe_n£˘‹s
)

2340 
båfs_fs_öfo
 *
fs_öfo
 = 
bioc
->fs_info;

2341 
båfs_øid_bio
 *
rbio
;

2342 
i
;

2344 
rbio
 = 
	`Æloc_rbio
(
fs_öfo
, 
bioc
);

2345 i‡(
	`IS_ERR
(
rbio
))

2346  
NULL
;

2347 
	`bio_li°_add
(&
rbio
->
bio_li°
, 
bio
);

2352 
	`ASSERT
(!
bio
->
bi_ôî
.
bi_size
);

2353 
rbio
->
›î©i⁄
 = 
BTRFS_RBIO_PARITY_SCRUB
;

2360 
i
 = 
rbio
->
ƒ_d©a
; i <Ñbio->
ªÆ_°rùes
; i++) {

2361 i‡(
bioc
->
°rùes
[
i
].
dev
 =
s¸ub_dev
) {

2362 
rbio
->
s¸ubp
 = 
i
;

2366 
	`ASSERT
(
i
 < 
rbio
->
ªÆ_°rùes
);

2368 
	`bôm≠_c›y
(&
rbio
->
dbôm≠
, dbôm≠, 
°rùe_n£˘‹s
);

2369  
rbio
;

2370 
	}
}

2376 
	$Æloc_rbio_es£¡ül_∑ges
(
båfs_øid_bio
 *
rbio
)

2378 c⁄° 
u32
 
£˘‹size
 = 
rbio
->
bioc
->
fs_öfo
->sectorsize;

2379 
tŸÆ_£˘‹_ƒ
;

2381 
tŸÆ_£˘‹_ƒ
 = 0;ÅŸÆ_£˘‹_ƒ < 
rbio
->
ƒ_£˘‹s
;

2382 
tŸÆ_£˘‹_ƒ
++) {

2383 
∑ge
 *page;

2384 
£˘‹ƒ
 = 
tŸÆ_£˘‹_ƒ
 % 
rbio
->
°rùe_n£˘‹s
;

2385 
ödex
 = (
tŸÆ_£˘‹_ƒ
 * 
£˘‹size
Ë>> 
PAGE_SHIFT
;

2387 i‡(!
	`ã°_bô
(
£˘‹ƒ
, &
rbio
->
dbôm≠
))

2389 i‡(
rbio
->
°rùe_∑ges
[
ödex
])

2391 
∑ge
 = 
	`Æloc_∑ge
(
GFP_NOFS
);

2392 i‡(!
∑ge
)

2393  -
ENOMEM
;

2394 
rbio
->
°rùe_∑ges
[
ödex
] = 
∑ge
;

2396 
	`ödex_°rùe_£˘‹s
(
rbio
);

2398 
	}
}

2400 
	$föish_∑rôy_s¸ub
(
båfs_øid_bio
 *
rbio
)

2402 
båfs_io_c⁄ãxt
 *
bioc
 = 
rbio
->bioc;

2403 c⁄° 
u32
 
£˘‹size
 = 
bioc
->
fs_öfo
->sectorsize;

2404 **
poöãrs
 = 
rbio
->
föish_poöãrs
;

2405 *
pbôm≠
 = &
rbio
->
föish_pbôm≠
;

2406 
ƒ_d©a
 = 
rbio
->nr_data;

2407 
°rùe
;

2408 
£˘‹ƒ
;

2409 
boﬁ
 
has_q°rùe
;

2410 
£˘‹_±r
 
p_£˘‹
 = { 0 };

2411 
£˘‹_±r
 
q_£˘‹
 = { 0 };

2412 
bio_li°
 bio_list;

2413 
is_ª∂a˚
 = 0;

2414 
ªt
;

2416 
	`bio_li°_öô
(&
bio_li°
);

2418 i‡(
rbio
->
ªÆ_°rùes
 -Ñbio->
ƒ_d©a
 == 1)

2419 
has_q°rùe
 = 
Ál£
;

2420 i‡(
rbio
->
ªÆ_°rùes
 -Ñbio->
ƒ_d©a
 == 2)

2421 
has_q°rùe
 = 
åue
;

2423 
	`BUG
();

2429 i‡(
bioc
->
ª∂a˚_ƒ_°rùes
 && bioc->
ª∂a˚_°rùe_§c
 =
rbio
->
s¸ubp
) {

2430 
is_ª∂a˚
 = 1;

2431 
	`bôm≠_c›y
(
pbôm≠
, &
rbio
->
dbôm≠
,Ñbio->
°rùe_n£˘‹s
);

2439 
	`˛ór_bô
(
RBIO_CACHE_READY_BIT
, &
rbio
->
Êags
);

2441 
p_£˘‹
.
∑ge
 = 
	`Æloc_∑ge
(
GFP_NOFS
);

2442 i‡(!
p_£˘‹
.
∑ge
)

2443  -
ENOMEM
;

2444 
p_£˘‹
.
pgoff
 = 0;

2445 
p_£˘‹
.
u±od©e
 = 1;

2447 i‡(
has_q°rùe
) {

2449 
q_£˘‹
.
∑ge
 = 
	`Æloc_∑ge
(
GFP_NOFS
);

2450 i‡(!
q_£˘‹
.
∑ge
) {

2451 
	`__‰ì_∑ge
(
p_£˘‹
.
∑ge
);

2452 
p_£˘‹
.
∑ge
 = 
NULL
;

2453  -
ENOMEM
;

2455 
q_£˘‹
.
pgoff
 = 0;

2456 
q_£˘‹
.
u±od©e
 = 1;

2457 
poöãrs
[
rbio
->
ªÆ_°rùes
 - 1] = 
	`km≠_loˇl_∑ge
(
q_£˘‹
.
∑ge
);

2460 
	`bôm≠_˛ór
(
rbio
->
îr‹_bôm≠
, 0,Ñbio->
ƒ_£˘‹s
);

2463 
poöãrs
[
ƒ_d©a
] = 
	`km≠_loˇl_∑ge
(
p_£˘‹
.
∑ge
);

2465 
	`f‹_óch_£t_bô
(
£˘‹ƒ
, &
rbio
->
dbôm≠
,Ñbio->
°rùe_n£˘‹s
) {

2466 
£˘‹_±r
 *
£˘‹
;

2467 *
∑rôy
;

2470 
°rùe
 = 0; såùê< 
ƒ_d©a
; stripe++) {

2471 
£˘‹
 = 
	`£˘‹_ö_rbio
(
rbio
, 
°rùe
, 
£˘‹ƒ
, 0);

2472 
poöãrs
[
°rùe
] = 
	`km≠_loˇl_∑ge
(
£˘‹
->
∑ge
) +

2473 
£˘‹
->
pgoff
;

2476 i‡(
has_q°rùe
) {

2478 
øid6_ˇŒ
.
	`gí_syndrome
(
rbio
->
ªÆ_°rùes
, 
£˘‹size
,

2479 
poöãrs
);

2482 
	`mem˝y
(
poöãrs
[
ƒ_d©a
],Öoöãrs[0], 
£˘‹size
);

2483 
	`run_x‹
(
poöãrs
 + 1, 
ƒ_d©a
 - 1, 
£˘‹size
);

2487 
£˘‹
 = 
	`rbio_°rùe_£˘‹
(
rbio
,Ñbio->
s¸ubp
, 
£˘‹ƒ
);

2488 
∑rôy
 = 
	`km≠_loˇl_∑ge
(
£˘‹
->
∑ge
Ë+ se˘‹->
pgoff
;

2489 i‡(
	`memcmp
(
∑rôy
, 
poöãrs
[
rbio
->
s¸ubp
], 
£˘‹size
) != 0)

2490 
	`mem˝y
(
∑rôy
, 
poöãrs
[
rbio
->
s¸ubp
], 
£˘‹size
);

2493 
	`bôm≠_˛ór
(&
rbio
->
dbôm≠
, 
£˘‹ƒ
, 1);

2494 
	`kunm≠_loˇl
(
∑rôy
);

2496 
°rùe
 = 
ƒ_d©a
 - 1; stripe >= 0; stripe--)

2497 
	`kunm≠_loˇl
(
poöãrs
[
°rùe
]);

2500 
	`kunm≠_loˇl
(
poöãrs
[
ƒ_d©a
]);

2501 
	`__‰ì_∑ge
(
p_£˘‹
.
∑ge
);

2502 
p_£˘‹
.
∑ge
 = 
NULL
;

2503 i‡(
q_£˘‹
.
∑ge
) {

2504 
	`kunm≠_loˇl
(
poöãrs
[
rbio
->
ªÆ_°rùes
 - 1]);

2505 
	`__‰ì_∑ge
(
q_£˘‹
.
∑ge
);

2506 
q_£˘‹
.
∑ge
 = 
NULL
;

2514 
	`f‹_óch_£t_bô
(
£˘‹ƒ
, &
rbio
->
dbôm≠
,Ñbio->
°rùe_n£˘‹s
) {

2515 
£˘‹_±r
 *
£˘‹
;

2517 
£˘‹
 = 
	`rbio_°rùe_£˘‹
(
rbio
,Ñbio->
s¸ubp
, 
£˘‹ƒ
);

2518 
ªt
 = 
	`rbio_add_io_£˘‹
(
rbio
, &
bio_li°
, 
£˘‹
,Ñbio->
s¸ubp
,

2519 
£˘‹ƒ
, 
REQ_OP_WRITE
);

2520 i‡(
ªt
)

2521 
˛ónup
;

2524 i‡(!
is_ª∂a˚
)

2525 
submô_wrôe
;

2531 
	`ASSERT
(
rbio
->
bioc
->
ª∂a˚_°rùe_§c
 >= 0);

2532 
	`f‹_óch_£t_bô
(
£˘‹ƒ
, 
pbôm≠
, 
rbio
->
°rùe_n£˘‹s
) {

2533 
£˘‹_±r
 *
£˘‹
;

2535 
£˘‹
 = 
	`rbio_°rùe_£˘‹
(
rbio
,Ñbio->
s¸ubp
, 
£˘‹ƒ
);

2536 
ªt
 = 
	`rbio_add_io_£˘‹
(
rbio
, &
bio_li°
, 
£˘‹
,

2537 
rbio
->
ªÆ_°rùes
,

2538 
£˘‹ƒ
, 
REQ_OP_WRITE
);

2539 i‡(
ªt
)

2540 
˛ónup
;

2543 
submô_wrôe
:

2544 
	`submô_wrôe_bios
(
rbio
, &
bio_li°
);

2547 
˛ónup
:

2548 
	`bio_li°_put
(&
bio_li°
);

2549  
ªt
;

2550 
	}
}

2552 
ölöe
 
	$is_d©a_°rùe
(
båfs_øid_bio
 *
rbio
, 
°rùe
)

2554 i‡(
°rùe
 >0 && såùê< 
rbio
->
ƒ_d©a
)

2557 
	}
}

2559 
	$ªcovî_s¸ub_rbio
(
båfs_øid_bio
 *
rbio
)

2561 **
poöãrs
 = 
NULL
;

2562 **
unm≠_¨øy
 = 
NULL
;

2563 
£˘‹_ƒ
;

2564 
ªt
 = 0;

2572 
poöãrs
 = 
	`kˇŒoc
(
rbio
->
ªÆ_°rùes
, (*), 
GFP_NOFS
);

2573 
unm≠_¨øy
 = 
	`kˇŒoc
(
rbio
->
ªÆ_°rùes
, (*), 
GFP_NOFS
);

2574 i‡(!
poöãrs
 || !
unm≠_¨øy
) {

2575 
ªt
 = -
ENOMEM
;

2576 
out
;

2579 
£˘‹_ƒ
 = 0; se˘‹_ƒ < 
rbio
->
°rùe_n£˘‹s
; sector_nr++) {

2580 
dÁû
 = 0, 
Áûp
 = -1;

2581 
Áûa
;

2582 
Áûb
;

2583 
found_îr‹s
;

2585 
found_îr‹s
 = 
	`gë_rbio_vîôiˇl_îr‹s
(
rbio
, 
£˘‹_ƒ
,

2586 &
Áûa
, &
Áûb
);

2587 i‡(
found_îr‹s
 > 
rbio
->
bioc
->
max_îr‹s
) {

2588 
ªt
 = -
EIO
;

2589 
out
;

2591 i‡(
found_îr‹s
 == 0)

2595 
	`ASSERT
(
Áûa
 >0 || 
Áûb
 >= 0);

2597 i‡(
	`is_d©a_°rùe
(
rbio
, 
Áûa
))

2598 
dÁû
++;

2599 i‡(
	`is_∑rôy_°rùe
(
Áûa
))

2600 
Áûp
 = 
Áûa
;

2602 i‡(
	`is_d©a_°rùe
(
rbio
, 
Áûb
))

2603 
dÁû
++;

2604 i‡(
	`is_∑rôy_°rùe
(
Áûb
))

2605 
Áûp
 = 
Áûb
;

2611 i‡(
dÁû
 > 
rbio
->
bioc
->
max_îr‹s
 - 1) {

2612 
ªt
 = -
EIO
;

2613 
out
;

2619 i‡(
dÁû
 == 0)

2628 i‡(
Áûp
 !
rbio
->
s¸ubp
) {

2629 
ªt
 = -
EIO
;

2630 
out
;

2633 
ªt
 = 
	`ªcovî_vîtiˇl
(
rbio
, 
£˘‹_ƒ
, 
poöãrs
, 
unm≠_¨øy
);

2634 i‡(
ªt
 < 0)

2635 
out
;

2637 
out
:

2638 
	`k‰ì
(
poöãrs
);

2639 
	`k‰ì
(
unm≠_¨øy
);

2640  
ªt
;

2641 
	}
}

2643 
	$s¸ub_as£mbÀ_ªad_bios
(
båfs_øid_bio
 *
rbio
)

2645 
bio_li°
 bio_li° = 
BIO_EMPTY_LIST
;

2646 
tŸÆ_£˘‹_ƒ
;

2647 
ªt
 = 0;

2650 
tŸÆ_£˘‹_ƒ
 = 0;ÅŸÆ_£˘‹_ƒ < 
rbio
->
ƒ_£˘‹s
;

2651 
tŸÆ_£˘‹_ƒ
++) {

2652 
£˘‹ƒ
 = 
tŸÆ_£˘‹_ƒ
 % 
rbio
->
°rùe_n£˘‹s
;

2653 
°rùe
 = 
tŸÆ_£˘‹_ƒ
 / 
rbio
->
°rùe_n£˘‹s
;

2654 
£˘‹_±r
 *
£˘‹
;

2657 i‡(!
	`ã°_bô
(
£˘‹ƒ
, &
rbio
->
dbôm≠
))

2665 
£˘‹
 = 
	`£˘‹_ö_rbio
(
rbio
, 
°rùe
, 
£˘‹ƒ
, 1);

2666 i‡(
£˘‹
)

2669 
£˘‹
 = 
	`rbio_°rùe_£˘‹
(
rbio
, 
°rùe
, 
£˘‹ƒ
);

2674 i‡(
£˘‹
->
u±od©e
)

2677 
ªt
 = 
	`rbio_add_io_£˘‹
(
rbio
, &
bio_li°
, 
£˘‹
, 
°rùe
,

2678 
£˘‹ƒ
, 
REQ_OP_READ
);

2679 i‡(
ªt
) {

2680 
	`bio_li°_put
(&
bio_li°
);

2681  
ªt
;

2685 
	`submô_ªad_waô_bio_li°
(
rbio
, &
bio_li°
);

2687 
	}
}

2689 
	$s¸ub_rbio
(
båfs_øid_bio
 *
rbio
)

2691 
£˘‹_ƒ
;

2692 
ªt
;

2694 
ªt
 = 
	`Æloc_rbio_es£¡ül_∑ges
(
rbio
);

2695 i‡(
ªt
)

2696 
out
;

2698 
	`bôm≠_˛ór
(
rbio
->
îr‹_bôm≠
, 0,Ñbio->
ƒ_£˘‹s
);

2700 
ªt
 = 
	`s¸ub_as£mbÀ_ªad_bios
(
rbio
);

2701 i‡(
ªt
 < 0)

2702 
out
;

2705 
ªt
 = 
	`ªcovî_s¸ub_rbio
(
rbio
);

2706 i‡(
ªt
 < 0)

2707 
out
;

2713 
ªt
 = 
	`föish_∑rôy_s¸ub
(
rbio
);

2714 
	`waô_evít
(
rbio
->
io_waô
, 
	`©omic_ªad
(&rbio->
°rùes_≥ndög
) == 0);

2715 
£˘‹_ƒ
 = 0; se˘‹_ƒ < 
rbio
->
°rùe_n£˘‹s
; sector_nr++) {

2716 
found_îr‹s
;

2718 
found_îr‹s
 = 
	`gë_rbio_vîôiˇl_îr‹s
(
rbio
, 
£˘‹_ƒ
, 
NULL
, NULL);

2719 i‡(
found_îr‹s
 > 
rbio
->
bioc
->
max_îr‹s
) {

2720 
ªt
 = -
EIO
;

2724 
out
:

2725 
	`rbio_‹ig_íd_io
(
rbio
, 
	`î∫o_to_blk_°©us
(
ªt
));

2726 
	}
}

2728 
	$s¸ub_rbio_w‹k_locked
(
w‹k_°ru˘
 *
w‹k
)

2730 
	`s¸ub_rbio
(
	`c⁄èöî_of
(
w‹k
, 
båfs_øid_bio
, work));

2731 
	}
}

2733 
	$øid56_∑rôy_submô_s¸ub_rbio
(
båfs_øid_bio
 *
rbio
)

2735 i‡(!
	`lock_°rùe_add
(
rbio
))

2736 
	`°¨t_async_w‹k
(
rbio
, 
s¸ub_rbio_w‹k_locked
);

2737 
	}
}

2746 
	$øid56_∑rôy_ˇche_d©a_∑ges
(
båfs_øid_bio
 *
rbio
,

2747 
∑ge
 **
d©a_∑ges
, 
u64
 
d©a_logiˇl
)

2749 c⁄° 
u64
 
off£t_ö_fuŒ_°rùe
 = 
d©a_logiˇl
 -

2750 
rbio
->
bioc
->
fuŒ_°rùe_logiˇl
;

2751 c⁄° 
∑ge_ödex
 = 
off£t_ö_fuŒ_°rùe
 >> 
PAGE_SHIFT
;

2752 c⁄° 
u32
 
£˘‹size
 = 
rbio
->
bioc
->
fs_öfo
->sectorsize;

2753 c⁄° 
u32
 
£˘‹s_≥r_∑ge
 = 
PAGE_SIZE
 / 
£˘‹size
;

2754 
ªt
;

2764 
ªt
 = 
	`Æloc_rbio_d©a_∑ges
(
rbio
);

2765 i‡(
ªt
 < 0)

2769 
	`ASSERT
(
	`IS_ALIGNED
(
off£t_ö_fuŒ_°rùe
, 
BTRFS_STRIPE_LEN
));

2770 
	`ASSERT
(
off£t_ö_fuŒ_°rùe
 < (
rbio
->
ƒ_d©a
 << 
BTRFS_STRIPE_LEN_SHIFT
));

2772 
∑ge_ƒ
 = 0;Öage_ƒ < (
BTRFS_STRIPE_LEN
 >> 
PAGE_SHIFT
);Öage_nr++) {

2773 
∑ge
 *
d°
 = 
rbio
->
°rùe_∑ges
[
∑ge_ƒ
 + 
∑ge_ödex
];

2774 
∑ge
 *
§c
 = 
d©a_∑ges
[
∑ge_ƒ
];

2776 
	`mem˝y_∑ge
(
d°
, 0, 
§c
, 0, 
PAGE_SIZE
);

2777 
£˘‹_ƒ
 = 
£˘‹s_≥r_∑ge
 * 
∑ge_ödex
;

2778 
£˘‹_ƒ
 < 
£˘‹s_≥r_∑ge
 * (
∑ge_ödex
 + 1);

2779 
£˘‹_ƒ
++)

2780 
rbio
->
°rùe_£˘‹s
[
£˘‹_ƒ
].
u±od©e
 = 
åue
;

2782 
	}
}

	@raid56.h

7 #i‚de‡
BTRFS_RAID56_H


8 
	#BTRFS_RAID56_H


	)

10 
	~<löux/w‹kqueue.h
>

11 
	~"vﬁumes.h
"

13 
	ebåfs_rbio_›s
 {

14 
	mBTRFS_RBIO_WRITE
,

15 
	mBTRFS_RBIO_READ_REBUILD
,

16 
	mBTRFS_RBIO_PARITY_SCRUB
,

19 
	sbåfs_øid_bio
 {

20 
båfs_io_c⁄ãxt
 *
	mbioc
;

26 
li°_hód
 
	mhash_li°
;

29 
li°_hód
 
	m°rùe_ˇche
;

32 
w‹k_°ru˘
 
	mw‹k
;

38 
bio_li°
 
	mbio_li°
;

39 
•ölock_t
 
	mbio_li°_lock
;

47 
li°_hód
 
	m∂ug_li°
;

50 
	mÊags
;

56 
båfs_rbio_›s
 
	m›î©i⁄
;

59 
u16
 
	mƒ_∑ges
;

62 
u16
 
	mƒ_£˘‹s
;

65 
u8
 
	mƒ_d©a
;

68 
u8
 
	mªÆ_°rùes
;

71 
u8
 
	m°rùe_≈ages
;

74 
u8
 
	m°rùe_n£˘‹s
;

77 
u8
 
	ms¸ubp
;

83 
	mbio_li°_byãs
;

85 
ªfcou¡_t
 
	mªfs
;

87 
©omic_t
 
	m°rùes_≥ndög
;

89 
waô_queue_hód_t
 
	mio_waô
;

92 
	mdbôm≠
;

95 
	mföish_pbôm≠
;

107 
∑ge
 **
	m°rùe_∑ges
;

110 
£˘‹_±r
 *
	mbio_£˘‹s
;

116 
£˘‹_±r
 *
	m°rùe_£˘‹s
;

119 **
	mföish_poöãrs
;

130 *
	mîr‹_bôm≠
;

136 
u8
 *
	mcsum_buf
;

142 *
	mcsum_bôm≠
;

152 
	søid56_bio_åa˚_öfo
 {

153 
u64
 
	mdevid
;

156 
u32
 
	moff£t
;

164 
u8
 
	m°rùe_ƒ
;

167 
ölöe
 
	$ƒ_d©a_°rùes
(c⁄° 
m≠_lookup
 *
m≠
)

169  
m≠
->
num_°rùes
 - 
	`båfs_ƒ_∑rôy_°rùes
(m≠->
ty≥
);

170 
	}
}

172 
ölöe
 
	$ƒ_bioc_d©a_°rùes
(c⁄° 
båfs_io_c⁄ãxt
 *
bioc
)

174  
bioc
->
num_°rùes
 - 
	`båfs_ƒ_∑rôy_°rùes
(bioc->
m≠_ty≥
);

175 
	}
}

177 
	#RAID5_P_STRIPE
 ((
u64
)-2)

	)

178 
	#RAID6_Q_STRIPE
 ((
u64
)-1)

	)

180 
	#is_∑rôy_°rùe
(
x
Ë(((xË=
RAID5_P_STRIPE
) || \

181 ((
x
Ë=
RAID6_Q_STRIPE
))

	)

183 
	gbåfs_devi˚
;

185 
øid56_∑rôy_ªcovî
(
bio
 *bio, 
båfs_io_c⁄ãxt
 *
bioc
,

186 
múr‹_num
);

187 
øid56_∑rôy_wrôe
(
bio
 *bio, 
båfs_io_c⁄ãxt
 *
bioc
);

189 
båfs_øid_bio
 *
øid56_∑rôy_Æloc_s¸ub_rbio
(
bio
 *bio,

190 
båfs_io_c⁄ãxt
 *
bioc
,

191 
båfs_devi˚
 *
s¸ub_dev
,

192 *
dbôm≠
, 
°rùe_n£˘‹s
);

193 
øid56_∑rôy_submô_s¸ub_rbio
(
båfs_øid_bio
 *
rbio
);

195 
øid56_∑rôy_ˇche_d©a_∑ges
(
båfs_øid_bio
 *
rbio
,

196 
∑ge
 **
d©a_∑ges
, 
u64
 
d©a_logiˇl
);

198 
båfs_Æloc_°rùe_hash_èbÀ
(
båfs_fs_öfo
 *
öfo
);

199 
båfs_‰ì_°rùe_hash_èbÀ
(
båfs_fs_öfo
 *
öfo
);

	@rcu-string.h

6 #i‚de‡
BTRFS_RCU_STRING_H


7 
	#BTRFS_RCU_STRING_H


	)

9 
	srcu_°rög
 {

10 
rcu_hód
 
	mrcu
;

11 
	m°r
[];

14 
ölöe
 
rcu_°rög
 *
	$rcu_°rög_°rdup
(c⁄° *
§c
, 
gÂ_t
 
mask
)

16 
size_t
 
Àn
 = 
	`°æí
(
§c
) + 1;

17 
rcu_°rög
 *
ªt
 = 
	`kzÆloc
((rcu_string) +

18 (
Àn
 * ()), 
mask
);

19 i‡(!
ªt
)

20  
ªt
;

22 i‡(
	`WARN_ON
(
	`°rs˝y
(
ªt
->
°r
, 
§c
, 
Àn
) < 0)) {

23 
	`k‰ì
(
ªt
);

24  
NULL
;

26  
ªt
;

27 
	}
}

29 
ölöe
 
	$rcu_°rög_‰ì
(
rcu_°rög
 *
°r
)

31 i‡(
°r
)

32 
	`k‰ì_rcu
(
°r
, 
rcu
);

33 
	}
}

35 
	#¥ötk_ö_rcu
(
fmt
, ...) do { \

36 
	`rcu_ªad_lock
(); \

37 
	`¥ötk
(
fmt
, 
__VA_ARGS__
); \

38 
	`rcu_ªad_u∆ock
(); \

39 } 0)

	)

41 
	#¥ötk_øãlimôed_ö_rcu
(
fmt
, ...) do { \

42 
	`rcu_ªad_lock
(); \

43 
	`¥ötk_øãlimôed
(
fmt
, 
__VA_ARGS__
); \

44 
	`rcu_ªad_u∆ock
(); \

45 } 0)

	)

47 
	#rcu_°r_dîef
(
rcu_°r
) ({ \

48 
rcu_°rög
 *
__°r
 = 
	`rcu_dîe„ªn˚
(
rcu_°r
); \

49 
__°r
->
°r
; \

50 })

	)

	@ref-verify.c

6 
	~<löux/sched.h
>

7 
	~<löux/°ackåa˚.h
>

8 
	~"mesßges.h
"

9 
	~"˘ªe.h
"

10 
	~"disk-io.h
"

11 
	~"lockög.h
"

12 
	~"dñayed-ªf.h
"

13 
	~"ªf-vîify.h
"

14 
	~"fs.h
"

15 
	~"ac˚ss‹s.h
"

22 
	sroŸ_íåy
 {

23 
u64
 
	mroŸ_obje˘id
;

24 
u64
 
	mnum_ªfs
;

25 
rb_node
 
	mnode
;

33 
	sªf_íåy
 {

34 
u64
 
	mroŸ_obje˘id
;

35 
u64
 
	m∑ª¡
;

36 
u64
 
	mow√r
;

37 
u64
 
	moff£t
;

38 
u64
 
	mnum_ªfs
;

39 
rb_node
 
	mnode
;

42 
	#MAX_TRACE
 16

	)

51 
	sªf_a˘i⁄
 {

52 
	ma˘i⁄
;

53 
u64
 
	mroŸ
;

54 
ªf_íåy
 
	mªf
;

55 
li°_hód
 
	mli°
;

56 
	måa˚
[
MAX_TRACE
];

57 
	måa˚_Àn
;

66 
	sblock_íåy
 {

67 
u64
 
	mbyãƒ
;

68 
u64
 
	mÀn
;

69 
u64
 
	mnum_ªfs
;

70 
	mmëad©a
;

71 
	m‰om_disk
;

72 
rb_roŸ
 
	mroŸs
;

73 
rb_roŸ
 
	mªfs
;

74 
rb_node
 
	mnode
;

75 
li°_hód
 
	ma˘i⁄s
;

78 
block_íåy
 *
	$ö£π_block_íåy
(
rb_roŸ
 *
roŸ
,

79 
block_íåy
 *
be
)

81 
rb_node
 **
p
 = &
roŸ
->rb_node;

82 
rb_node
 *
∑ª¡_node
 = 
NULL
;

83 
block_íåy
 *
íåy
;

85 *
p
) {

86 
∑ª¡_node
 = *
p
;

87 
íåy
 = 
	`rb_íåy
(
∑ª¡_node
, 
block_íåy
, 
node
);

88 i‡(
íåy
->
byãƒ
 > 
be
->bytenr)

89 
p
 = &(*p)->
rb_À·
;

90 i‡(
íåy
->
byãƒ
 < 
be
->bytenr)

91 
p
 = &(*p)->
rb_right
;

93  
íåy
;

96 
	`rb_lök_node
(&
be
->
node
, 
∑ª¡_node
, 
p
);

97 
	`rb_ö£π_cﬁ‹
(&
be
->
node
, 
roŸ
);

98  
NULL
;

99 
	}
}

101 
block_íåy
 *
	$lookup_block_íåy
(
rb_roŸ
 *
roŸ
, 
u64
 
byãƒ
)

103 
rb_node
 *
n
;

104 
block_íåy
 *
íåy
 = 
NULL
;

106 
n
 = 
roŸ
->
rb_node
;

107 
n
) {

108 
íåy
 = 
	`rb_íåy
(
n
, 
block_íåy
, 
node
);

109 i‡(
íåy
->
byãƒ
 < bytenr)

110 
n
 =Ç->
rb_right
;

111 i‡(
íåy
->
byãƒ
 > bytenr)

112 
n
 =Ç->
rb_À·
;

114  
íåy
;

116  
NULL
;

117 
	}
}

119 
roŸ_íåy
 *
	$ö£π_roŸ_íåy
(
rb_roŸ
 *
roŸ
,

120 
roŸ_íåy
 *
ª
)

122 
rb_node
 **
p
 = &
roŸ
->rb_node;

123 
rb_node
 *
∑ª¡_node
 = 
NULL
;

124 
roŸ_íåy
 *
íåy
;

126 *
p
) {

127 
∑ª¡_node
 = *
p
;

128 
íåy
 = 
	`rb_íåy
(
∑ª¡_node
, 
roŸ_íåy
, 
node
);

129 i‡(
íåy
->
roŸ_obje˘id
 > 
ª
->root_objectid)

130 
p
 = &(*p)->
rb_À·
;

131 i‡(
íåy
->
roŸ_obje˘id
 < 
ª
->root_objectid)

132 
p
 = &(*p)->
rb_right
;

134  
íåy
;

137 
	`rb_lök_node
(&
ª
->
node
, 
∑ª¡_node
, 
p
);

138 
	`rb_ö£π_cﬁ‹
(&
ª
->
node
, 
roŸ
);

139  
NULL
;

141 
	}
}

143 
	$comp_ªfs
(
ªf_íåy
 *
ªf1
, ªf_íåy *
ªf2
)

145 i‡(
ªf1
->
roŸ_obje˘id
 < 
ªf2
->root_objectid)

147 i‡(
ªf1
->
roŸ_obje˘id
 > 
ªf2
->root_objectid)

149 i‡(
ªf1
->
∑ª¡
 < 
ªf2
->parent)

151 i‡(
ªf1
->
∑ª¡
 > 
ªf2
->parent)

153 i‡(
ªf1
->
ow√r
 < 
ªf2
->owner)

155 i‡(
ªf1
->
ow√r
 > 
ªf2
->owner)

157 i‡(
ªf1
->
off£t
 < 
ªf2
->offset)

159 i‡(
ªf1
->
off£t
 > 
ªf2
->offset)

162 
	}
}

164 
ªf_íåy
 *
	$ö£π_ªf_íåy
(
rb_roŸ
 *
roŸ
,

165 
ªf_íåy
 *
ªf
)

167 
rb_node
 **
p
 = &
roŸ
->rb_node;

168 
rb_node
 *
∑ª¡_node
 = 
NULL
;

169 
ªf_íåy
 *
íåy
;

170 
cmp
;

172 *
p
) {

173 
∑ª¡_node
 = *
p
;

174 
íåy
 = 
	`rb_íåy
(
∑ª¡_node
, 
ªf_íåy
, 
node
);

175 
cmp
 = 
	`comp_ªfs
(
íåy
, 
ªf
);

176 i‡(
cmp
 > 0)

177 
p
 = &(*p)->
rb_À·
;

178 i‡(
cmp
 < 0)

179 
p
 = &(*p)->
rb_right
;

181  
íåy
;

184 
	`rb_lök_node
(&
ªf
->
node
, 
∑ª¡_node
, 
p
);

185 
	`rb_ö£π_cﬁ‹
(&
ªf
->
node
, 
roŸ
);

186  
NULL
;

188 
	}
}

190 
roŸ_íåy
 *
	$lookup_roŸ_íåy
(
rb_roŸ
 *
roŸ
, 
u64
 
obje˘id
)

192 
rb_node
 *
n
;

193 
roŸ_íåy
 *
íåy
 = 
NULL
;

195 
n
 = 
roŸ
->
rb_node
;

196 
n
) {

197 
íåy
 = 
	`rb_íåy
(
n
, 
roŸ_íåy
, 
node
);

198 i‡(
íåy
->
roŸ_obje˘id
 < 
obje˘id
)

199 
n
 =Ç->
rb_right
;

200 i‡(
íåy
->
roŸ_obje˘id
 > 
obje˘id
)

201 
n
 =Ç->
rb_À·
;

203  
íåy
;

205  
NULL
;

206 
	}
}

208 #ifde‡
CONFIG_STACKTRACE


209 
	$__ßve_°ack_åa˚
(
ªf_a˘i⁄
 *
ø
)

211 
ø
->
åa˚_Àn
 = 
	`°ack_åa˚_ßve
‘a->
åa˚
, 
MAX_TRACE
, 2);

212 
	}
}

214 
	$__¥öt_°ack_åa˚
(
båfs_fs_öfo
 *
fs_öfo
,

215 
ªf_a˘i⁄
 *
ø
)

217 i‡(
ø
->
åa˚_Àn
 == 0) {

218 
	`båfs_îr
(
fs_öfo
, "Ñef-verify:Ço stacktrace");

221 
	`°ack_åa˚_¥öt
(
ø
->
åa˚
,Ña->
åa˚_Àn
, 2);

222 
	}
}

224 
ölöe
 
	$__ßve_°ack_åa˚
(
ªf_a˘i⁄
 *
ø
)

226 
	}
}

228 
ölöe
 
	$__¥öt_°ack_åa˚
(
båfs_fs_öfo
 *
fs_öfo
,

229 
ªf_a˘i⁄
 *
ø
)

231 
	`båfs_îr
(
fs_öfo
, "Ñef-verify:Ço stacktrace support");

232 
	}
}

235 
	$‰ì_block_íåy
(
block_íåy
 *
be
)

237 
roŸ_íåy
 *
ª
;

238 
ªf_íåy
 *
ªf
;

239 
ªf_a˘i⁄
 *
ø
;

240 
rb_node
 *
n
;

242 (
n
 = 
	`rb_fú°
(&
be
->
roŸs
))) {

243 
ª
 = 
	`rb_íåy
(
n
, 
roŸ_íåy
, 
node
);

244 
	`rb_îa£
(&
ª
->
node
, &
be
->
roŸs
);

245 
	`k‰ì
(
ª
);

248 (
n
 = 
	`rb_fú°
(&
be
->
ªfs
))) {

249 
ªf
 = 
	`rb_íåy
(
n
, 
ªf_íåy
, 
node
);

250 
	`rb_îa£
(&
ªf
->
node
, &
be
->
ªfs
);

251 
	`k‰ì
(
ªf
);

254 !
	`li°_em±y
(&
be
->
a˘i⁄s
)) {

255 
ø
 = 
	`li°_fú°_íåy
(&
be
->
a˘i⁄s
, 
ªf_a˘i⁄
,

256 
li°
);

257 
	`li°_dñ
(&
ø
->
li°
);

258 
	`k‰ì
(
ø
);

260 
	`k‰ì
(
be
);

261 
	}
}

263 
block_íåy
 *
	$add_block_íåy
(
båfs_fs_öfo
 *
fs_öfo
,

264 
u64
 
byãƒ
, u64 
Àn
,

265 
u64
 
roŸ_obje˘id
)

267 
block_íåy
 *
be
 = 
NULL
, *
exi°
;

268 
roŸ_íåy
 *
ª
 = 
NULL
;

270 
ª
 = 
	`kzÆloc
((
roŸ_íåy
), 
GFP_NOFS
);

271 
be
 = 
	`kzÆloc
((
block_íåy
), 
GFP_NOFS
);

272 i‡(!
be
 || !
ª
) {

273 
	`k‰ì
(
ª
);

274 
	`k‰ì
(
be
);

275  
	`ERR_PTR
(-
ENOMEM
);

277 
be
->
byãƒ
 = bytenr;

278 
be
->
Àn
 =Üen;

280 
ª
->
roŸ_obje˘id
 =Ñoot_objectid;

281 
ª
->
num_ªfs
 = 0;

283 
	`•ö_lock
(&
fs_öfo
->
ªf_vîify_lock
);

284 
exi°
 = 
	`ö£π_block_íåy
(&
fs_öfo
->
block_åì
, 
be
);

285 i‡(
exi°
) {

286 i‡(
roŸ_obje˘id
) {

287 
roŸ_íåy
 *
exi°_ª
;

289 
exi°_ª
 = 
	`ö£π_roŸ_íåy
(&
exi°
->
roŸs
, 
ª
);

290 i‡(
exi°_ª
)

291 
	`k‰ì
(
ª
);

293 
	`k‰ì
(
ª
);

295 
	`k‰ì
(
be
);

296  
exi°
;

299 
be
->
num_ªfs
 = 0;

300 
be
->
mëad©a
 = 0;

301 
be
->
‰om_disk
 = 0;

302 
be
->
roŸs
 = 
RB_ROOT
;

303 
be
->
ªfs
 = 
RB_ROOT
;

304 
	`INIT_LIST_HEAD
(&
be
->
a˘i⁄s
);

305 i‡(
roŸ_obje˘id
)

306 
	`ö£π_roŸ_íåy
(&
be
->
roŸs
, 
ª
);

308 
	`k‰ì
(
ª
);

309  
be
;

310 
	}
}

312 
	$add_åì_block
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
ªf_roŸ
,

313 
u64
 
∑ª¡
, u64 
byãƒ
, 
Àvñ
)

315 
block_íåy
 *
be
;

316 
roŸ_íåy
 *
ª
;

317 
ªf_íåy
 *
ªf
 = 
NULL
, *
exi°
;

319 
ªf
 = 
	`kmÆloc
((
ªf_íåy
), 
GFP_NOFS
);

320 i‡(!
ªf
)

321  -
ENOMEM
;

323 i‡(
∑ª¡
)

324 
ªf
->
roŸ_obje˘id
 = 0;

326 
ªf
->
roŸ_obje˘id
 = 
ªf_roŸ
;

327 
ªf
->
∑ª¡
 =Öarent;

328 
ªf
->
ow√r
 = 
Àvñ
;

329 
ªf
->
off£t
 = 0;

330 
ªf
->
num_ªfs
 = 1;

332 
be
 = 
	`add_block_íåy
(
fs_öfo
, 
byãƒ
, fs_öfo->
nodesize
, 
ªf_roŸ
);

333 i‡(
	`IS_ERR
(
be
)) {

334 
	`k‰ì
(
ªf
);

335  
	`PTR_ERR
(
be
);

337 
be
->
num_ªfs
++;

338 
be
->
‰om_disk
 = 1;

339 
be
->
mëad©a
 = 1;

341 i‡(!
∑ª¡
) {

342 
	`ASSERT
(
ªf_roŸ
);

343 
ª
 = 
	`lookup_roŸ_íåy
(&
be
->
roŸs
, 
ªf_roŸ
);

344 
	`ASSERT
(
ª
);

345 
ª
->
num_ªfs
++;

347 
exi°
 = 
	`ö£π_ªf_íåy
(&
be
->
ªfs
, 
ªf
);

348 i‡(
exi°
) {

349 
exi°
->
num_ªfs
++;

350 
	`k‰ì
(
ªf
);

352 
	`•ö_u∆ock
(&
fs_öfo
->
ªf_vîify_lock
);

355 
	}
}

357 
	$add_sh¨ed_d©a_ªf
(
båfs_fs_öfo
 *
fs_öfo
,

358 
u64
 
∑ª¡
, 
u32
 
num_ªfs
, u64 
byãƒ
,

359 
u64
 
num_byãs
)

361 
block_íåy
 *
be
;

362 
ªf_íåy
 *
ªf
;

364 
ªf
 = 
	`kzÆloc
((
ªf_íåy
), 
GFP_NOFS
);

365 i‡(!
ªf
)

366  -
ENOMEM
;

367 
be
 = 
	`add_block_íåy
(
fs_öfo
, 
byãƒ
, 
num_byãs
, 0);

368 i‡(
	`IS_ERR
(
be
)) {

369 
	`k‰ì
(
ªf
);

370  
	`PTR_ERR
(
be
);

372 
be
->
num_ªfs
 +=Çum_refs;

374 
ªf
->
∑ª¡
 =Öarent;

375 
ªf
->
num_ªfs
 =Çum_refs;

376 i‡(
	`ö£π_ªf_íåy
(&
be
->
ªfs
, 
ªf
)) {

377 
	`•ö_u∆ock
(&
fs_öfo
->
ªf_vîify_lock
);

378 
	`båfs_îr
(
fs_öfo
, "existing sharedÑef whenÑeading from disk?");

379 
	`k‰ì
(
ªf
);

380  -
EINVAL
;

382 
	`•ö_u∆ock
(&
fs_öfo
->
ªf_vîify_lock
);

384 
	}
}

386 
	$add_exã¡_d©a_ªf
(
båfs_fs_öfo
 *
fs_öfo
,

387 
exã¡_buf„r
 *
Àaf
,

388 
båfs_exã¡_d©a_ªf
 *
dªf
,

389 
u64
 
byãƒ
, u64 
num_byãs
)

391 
block_íåy
 *
be
;

392 
ªf_íåy
 *
ªf
;

393 
roŸ_íåy
 *
ª
;

394 
u64
 
ªf_roŸ
 = 
	`båfs_exã¡_d©a_ªf_roŸ
(
Àaf
, 
dªf
);

395 
u64
 
ow√r
 = 
	`båfs_exã¡_d©a_ªf_obje˘id
(
Àaf
, 
dªf
);

396 
u64
 
off£t
 = 
	`båfs_exã¡_d©a_ªf_off£t
(
Àaf
, 
dªf
);

397 
u32
 
num_ªfs
 = 
	`båfs_exã¡_d©a_ªf_cou¡
(
Àaf
, 
dªf
);

399 
ªf
 = 
	`kzÆloc
((
ªf_íåy
), 
GFP_NOFS
);

400 i‡(!
ªf
)

401  -
ENOMEM
;

402 
be
 = 
	`add_block_íåy
(
fs_öfo
, 
byãƒ
, 
num_byãs
, 
ªf_roŸ
);

403 i‡(
	`IS_ERR
(
be
)) {

404 
	`k‰ì
(
ªf
);

405  
	`PTR_ERR
(
be
);

407 
be
->
num_ªfs
 +=Çum_refs;

409 
ªf
->
∑ª¡
 = 0;

410 
ªf
->
ow√r
 = owner;

411 
ªf
->
roŸ_obje˘id
 = 
ªf_roŸ
;

412 
ªf
->
off£t
 = offset;

413 
ªf
->
num_ªfs
 =Çum_refs;

414 i‡(
	`ö£π_ªf_íåy
(&
be
->
ªfs
, 
ªf
)) {

415 
	`•ö_u∆ock
(&
fs_öfo
->
ªf_vîify_lock
);

416 
	`båfs_îr
(
fs_öfo
, "existingÑef whenÑeading from disk?");

417 
	`k‰ì
(
ªf
);

418  -
EINVAL
;

421 
ª
 = 
	`lookup_roŸ_íåy
(&
be
->
roŸs
, 
ªf_roŸ
);

422 i‡(!
ª
) {

423 
	`•ö_u∆ock
(&
fs_öfo
->
ªf_vîify_lock
);

424 
	`båfs_îr
(
fs_öfo
, "missingÑoot inÇew blockÉntry?");

425  -
EINVAL
;

427 
ª
->
num_ªfs
 +=Çum_refs;

428 
	`•ö_u∆ock
(&
fs_öfo
->
ªf_vîify_lock
);

430 
	}
}

432 
	$¥o˚ss_exã¡_ôem
(
båfs_fs_öfo
 *
fs_öfo
,

433 
båfs_∑th
 *
∑th
, 
båfs_key
 *
key
,

434 
¶Ÿ
, *
åì_block_Àvñ
)

436 
båfs_exã¡_ôem
 *
ei
;

437 
båfs_exã¡_ölöe_ªf
 *
úef
;

438 
båfs_exã¡_d©a_ªf
 *
dªf
;

439 
båfs_sh¨ed_d©a_ªf
 *
§ef
;

440 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

441 
u32
 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

442 
íd
, 
±r
;

443 
u64
 
off£t
, 
Êags
, 
cou¡
;

444 
ty≥
, 
ªt
;

446 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_exã¡_ôem
);

447 
Êags
 = 
	`båfs_exã¡_Êags
(
Àaf
, 
ei
);

449 i‡((
key
->
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
) &&

450 
Êags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

451 
båfs_åì_block_öfo
 *
öfo
;

453 
öfo
 = (
båfs_åì_block_öfo
 *)(
ei
 + 1);

454 *
åì_block_Àvñ
 = 
	`båfs_åì_block_Àvñ
(
Àaf
, 
öfo
);

455 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)(
öfo
 + 1);

457 i‡(
key
->
ty≥
 =
BTRFS_METADATA_ITEM_KEY
)

458 *
åì_block_Àvñ
 = 
key
->
off£t
;

459 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)(
ei
 + 1);

462 
±r
 = ()
úef
;

463 
íd
 = ()
ei
 + 
ôem_size
;

464 
±r
 < 
íd
) {

465 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)
±r
;

466 
ty≥
 = 
	`båfs_exã¡_ölöe_ªf_ty≥
(
Àaf
, 
úef
);

467 
off£t
 = 
	`båfs_exã¡_ölöe_ªf_off£t
(
Àaf
, 
úef
);

468 
ty≥
) {

469 
BTRFS_TREE_BLOCK_REF_KEY
:

470 
ªt
 = 
	`add_åì_block
(
fs_öfo
, 
off£t
, 0, 
key
->
obje˘id
,

471 *
åì_block_Àvñ
);

473 
BTRFS_SHARED_BLOCK_REF_KEY
:

474 
ªt
 = 
	`add_åì_block
(
fs_öfo
, 0, 
off£t
, 
key
->
obje˘id
,

475 *
åì_block_Àvñ
);

477 
BTRFS_EXTENT_DATA_REF_KEY
:

478 
dªf
 = (
båfs_exã¡_d©a_ªf
 *)(&
úef
->
off£t
);

479 
ªt
 = 
	`add_exã¡_d©a_ªf
(
fs_öfo
, 
Àaf
, 
dªf
,

480 
key
->
obje˘id
, key->
off£t
);

482 
BTRFS_SHARED_DATA_REF_KEY
:

483 
§ef
 = (
båfs_sh¨ed_d©a_ªf
 *)(
úef
 + 1);

484 
cou¡
 = 
	`båfs_sh¨ed_d©a_ªf_cou¡
(
Àaf
, 
§ef
);

485 
ªt
 = 
	`add_sh¨ed_d©a_ªf
(
fs_öfo
, 
off£t
, 
cou¡
,

486 
key
->
obje˘id
, key->
off£t
);

489 
	`båfs_îr
(
fs_öfo
, "invalid keyÅype in iref");

490 
ªt
 = -
EINVAL
;

493 i‡(
ªt
)

495 
±r
 +
	`båfs_exã¡_ölöe_ªf_size
(
ty≥
);

497  
ªt
;

498 
	}
}

500 
	$¥o˚ss_Àaf
(
båfs_roŸ
 *
roŸ
,

501 
båfs_∑th
 *
∑th
, 
u64
 *
byãƒ
, u64 *
num_byãs
,

502 *
åì_block_Àvñ
)

504 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

505 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

506 
båfs_exã¡_d©a_ªf
 *
dªf
;

507 
båfs_sh¨ed_d©a_ªf
 *
§ef
;

508 
u32
 
cou¡
;

509 
i
 = 0, 
ªt
 = 0;

510 
båfs_key
 
key
;

511 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

513 
i
 = 0; i < 
ƒôems
; i++) {

514 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
i
);

515 
key
.
ty≥
) {

516 
BTRFS_EXTENT_ITEM_KEY
:

517 *
num_byãs
 = 
key
.
off£t
;

518 
ÁŒthrough
;

519 
BTRFS_METADATA_ITEM_KEY
:

520 *
byãƒ
 = 
key
.
obje˘id
;

521 
ªt
 = 
	`¥o˚ss_exã¡_ôem
(
fs_öfo
, 
∑th
, &
key
, 
i
,

522 
åì_block_Àvñ
);

524 
BTRFS_TREE_BLOCK_REF_KEY
:

525 
ªt
 = 
	`add_åì_block
(
fs_öfo
, 
key
.
off£t
, 0,

526 
key
.
obje˘id
, *
åì_block_Àvñ
);

528 
BTRFS_SHARED_BLOCK_REF_KEY
:

529 
ªt
 = 
	`add_åì_block
(
fs_öfo
, 0, 
key
.
off£t
,

530 
key
.
obje˘id
, *
åì_block_Àvñ
);

532 
BTRFS_EXTENT_DATA_REF_KEY
:

533 
dªf
 = 
	`båfs_ôem_±r
(
Àaf
, 
i
,

534 
båfs_exã¡_d©a_ªf
);

535 
ªt
 = 
	`add_exã¡_d©a_ªf
(
fs_öfo
, 
Àaf
, 
dªf
, *
byãƒ
,

536 *
num_byãs
);

538 
BTRFS_SHARED_DATA_REF_KEY
:

539 
§ef
 = 
	`båfs_ôem_±r
(
Àaf
, 
i
,

540 
båfs_sh¨ed_d©a_ªf
);

541 
cou¡
 = 
	`båfs_sh¨ed_d©a_ªf_cou¡
(
Àaf
, 
§ef
);

542 
ªt
 = 
	`add_sh¨ed_d©a_ªf
(
fs_öfo
, 
key
.
off£t
, 
cou¡
,

543 *
byãƒ
, *
num_byãs
);

548 i‡(
ªt
)

551  
ªt
;

552 
	}
}

555 
	$wÆk_down_åì
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
,

556 
Àvñ
, 
u64
 *
byãƒ
, u64 *
num_byãs
,

557 *
åì_block_Àvñ
)

559 
exã¡_buf„r
 *
eb
;

560 
ªt
 = 0;

562 
Àvñ
 >= 0) {

563 i‡(
Àvñ
) {

564 
eb
 = 
	`båfs_ªad_node_¶Ÿ
(
∑th
->
nodes
[
Àvñ
],

565 
∑th
->
¶Ÿs
[
Àvñ
]);

566 i‡(
	`IS_ERR
(
eb
))

567  
	`PTR_ERR
(
eb
);

568 
	`båfs_åì_ªad_lock
(
eb
);

569 
∑th
->
nodes
[
Àvñ
-1] = 
eb
;

570 
∑th
->
¶Ÿs
[
Àvñ
-1] = 0;

571 
∑th
->
locks
[
Àvñ
-1] = 
BTRFS_READ_LOCK
;

573 
ªt
 = 
	`¥o˚ss_Àaf
(
roŸ
, 
∑th
, 
byãƒ
, 
num_byãs
,

574 
åì_block_Àvñ
);

575 i‡(
ªt
)

578 
Àvñ
--;

580  
ªt
;

581 
	}
}

584 
	$wÆk_up_åì
(
båfs_∑th
 *
∑th
, *
Àvñ
)

586 
l
;

588 
l
 = 0;Ü < 
BTRFS_MAX_LEVEL
;Ü++) {

589 i‡(!
∑th
->
nodes
[
l
])

591 i‡(
l
) {

592 
∑th
->
¶Ÿs
[
l
]++;

593 i‡(
∑th
->
¶Ÿs
[
l
] <

594 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[
l
])) {

595 *
Àvñ
 = 
l
;

599 
	`båfs_åì_u∆ock_rw
(
∑th
->
nodes
[
l
],Ö©h->
locks
[l]);

600 
	`‰ì_exã¡_buf„r
(
∑th
->
nodes
[
l
]);

601 
∑th
->
nodes
[
l
] = 
NULL
;

602 
∑th
->
¶Ÿs
[
l
] = 0;

603 
∑th
->
locks
[
l
] = 0;

607 
	}
}

609 
	$dump_ªf_a˘i⁄
(
båfs_fs_öfo
 *
fs_öfo
,

610 
ªf_a˘i⁄
 *
ø
)

612 
	`båfs_îr
(
fs_öfo
,

614 
ø
->
a˘i⁄
,Ña->
roŸ
,Ña->
ªf
.
roŸ_obje˘id
,Ña->ªf.
∑ª¡
,

615 
ø
->
ªf
.
ow√r
,Ña->ªf.
off£t
,Ña->ªf.
num_ªfs
);

616 
	`__¥öt_°ack_åa˚
(
fs_öfo
, 
ø
);

617 
	}
}

623 
	$dump_block_íåy
(
båfs_fs_öfo
 *
fs_öfo
,

624 
block_íåy
 *
be
)

626 
ªf_íåy
 *
ªf
;

627 
roŸ_íåy
 *
ª
;

628 
ªf_a˘i⁄
 *
ø
;

629 
rb_node
 *
n
;

631 
	`båfs_îr
(
fs_öfo
,

633 
be
->
byãƒ
, be->
Àn
, be->
num_ªfs
, be->
mëad©a
,

634 
be
->
‰om_disk
);

636 
n
 = 
	`rb_fú°
(&
be
->
ªfs
);Ç;Ç = 
	`rb_√xt
(n)) {

637 
ªf
 = 
	`rb_íåy
(
n
, 
ªf_íåy
, 
node
);

638 
	`båfs_îr
(
fs_öfo
,

640 
ªf
->
roŸ_obje˘id
,Ñef->
∑ª¡
,Ñef->
ow√r
,

641 
ªf
->
off£t
,Ñef->
num_ªfs
);

644 
n
 = 
	`rb_fú°
(&
be
->
roŸs
);Ç;Ç = 
	`rb_√xt
(n)) {

645 
ª
 = 
	`rb_íåy
(
n
, 
roŸ_íåy
, 
node
);

646 
	`båfs_îr
(
fs_öfo
, "ÑootÉntry %llu,Çum_refs %llu",

647 
ª
->
roŸ_obje˘id
,Ñe->
num_ªfs
);

650 
	`li°_f‹_óch_íåy
(
ø
, &
be
->
a˘i⁄s
, 
li°
)

651 
	`dump_ªf_a˘i⁄
(
fs_öfo
, 
ø
);

652 
	}
}

662 
	$båfs_ªf_åì_mod
(
båfs_fs_öfo
 *
fs_öfo
,

663 
båfs_ªf
 *
gíîic_ªf
)

665 
ªf_íåy
 *
ªf
 = 
NULL
, *
exi°
;

666 
ªf_a˘i⁄
 *
ø
 = 
NULL
;

667 
block_íåy
 *
be
 = 
NULL
;

668 
roŸ_íåy
 *
ª
 = 
NULL
;

669 
a˘i⁄
 = 
gíîic_ªf
->action;

670 
ªt
 = 0;

671 
boﬁ
 
mëad©a
;

672 
u64
 
byãƒ
 = 
gíîic_ªf
->bytenr;

673 
u64
 
num_byãs
 = 
gíîic_ªf
->
Àn
;

674 
u64
 
∑ª¡
 = 
gíîic_ªf
->parent;

675 
u64
 
ªf_roŸ
 = 0;

676 
u64
 
ow√r
 = 0;

677 
u64
 
off£t
 = 0;

679 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
REF_VERIFY
))

682 i‡(
gíîic_ªf
->
ty≥
 =
BTRFS_REF_METADATA
) {

683 i‡(!
∑ª¡
)

684 
ªf_roŸ
 = 
gíîic_ªf
->
åì_ªf
.
ownög_roŸ
;

685 
ow√r
 = 
gíîic_ªf
->
åì_ªf
.
Àvñ
;

686 } i‡(!
∑ª¡
) {

687 
ªf_roŸ
 = 
gíîic_ªf
->
d©a_ªf
.
ownög_roŸ
;

688 
ow√r
 = 
gíîic_ªf
->
d©a_ªf
.
öo
;

689 
off£t
 = 
gíîic_ªf
->
d©a_ªf
.offset;

691 
mëad©a
 = 
ow√r
 < 
BTRFS_FIRST_FREE_OBJECTID
;

693 
ªf
 = 
	`kzÆloc
((
ªf_íåy
), 
GFP_NOFS
);

694 
ø
 = 
	`kmÆloc
((
ªf_a˘i⁄
), 
GFP_NOFS
);

695 i‡(!
ø
 || !
ªf
) {

696 
	`k‰ì
(
ªf
);

697 
	`k‰ì
(
ø
);

698 
ªt
 = -
ENOMEM
;

699 
out
;

702 
ªf
->
∑ª¡
 =Öarent;

703 
ªf
->
ow√r
 = owner;

704 
ªf
->
roŸ_obje˘id
 = 
ªf_roŸ
;

705 
ªf
->
off£t
 = offset;

706 
ªf
->
num_ªfs
 = (
a˘i⁄
 =
BTRFS_DROP_DELAYED_REF
) ? -1 : 1;

708 
	`mem˝y
(&
ø
->
ªf
,Ñef, (
ªf_íåy
));

715 
ø
->
ªf
.
ow√r
 = owner;

716 
ø
->
ªf
.
off£t
 = offset;

717 
ø
->
ªf
.
roŸ_obje˘id
 = 
ªf_roŸ
;

718 
	`__ßve_°ack_åa˚
(
ø
);

720 
	`INIT_LIST_HEAD
(&
ø
->
li°
);

721 
ø
->
a˘i⁄
 =áction;

722 
ø
->
roŸ
 = 
gíîic_ªf
->
ªÆ_roŸ
;

728 
ªt
 = -
EINVAL
;

729 i‡(
a˘i⁄
 =
BTRFS_ADD_DELAYED_EXTENT
) {

735 
be
 = 
	`add_block_íåy
(
fs_öfo
, 
byãƒ
, 
num_byãs
, 
ªf_roŸ
);

736 i‡(
	`IS_ERR
(
be
)) {

737 
	`k‰ì
(
ªf
);

738 
	`k‰ì
(
ø
);

739 
ªt
 = 
	`PTR_ERR
(
be
);

740 
out
;

742 
be
->
num_ªfs
++;

743 i‡(
mëad©a
)

744 
be
->
mëad©a
 = 1;

746 i‡(
be
->
num_ªfs
 != 1) {

747 
	`båfs_îr
(
fs_öfo
,

749 
	`dump_block_íåy
(
fs_öfo
, 
be
);

750 
	`dump_ªf_a˘i⁄
(
fs_öfo
, 
ø
);

751 
	`k‰ì
(
ªf
);

752 
	`k‰ì
(
ø
);

753 
out_u∆ock
;

756 !
	`li°_em±y
(&
be
->
a˘i⁄s
)) {

757 
ªf_a˘i⁄
 *
tmp
;

759 
tmp
 = 
	`li°_fú°_íåy
(&
be
->
a˘i⁄s
, 
ªf_a˘i⁄
,

760 
li°
);

761 
	`li°_dñ
(&
tmp
->
li°
);

762 
	`k‰ì
(
tmp
);

765 
roŸ_íåy
 *
tmp
;

767 i‡(!
∑ª¡
) {

768 
ª
 = 
	`kmÆloc
((
roŸ_íåy
), 
GFP_NOFS
);

769 i‡(!
ª
) {

770 
	`k‰ì
(
ªf
);

771 
	`k‰ì
(
ø
);

772 
ªt
 = -
ENOMEM
;

773 
out
;

780 
ªf_roŸ
 = 
gíîic_ªf
->
ªÆ_roŸ
;

781 
ª
->
roŸ_obje˘id
 = 
gíîic_ªf
->
ªÆ_roŸ
;

782 
ª
->
num_ªfs
 = 0;

785 
	`•ö_lock
(&
fs_öfo
->
ªf_vîify_lock
);

786 
be
 = 
	`lookup_block_íåy
(&
fs_öfo
->
block_åì
, 
byãƒ
);

787 i‡(!
be
) {

788 
	`båfs_îr
(
fs_öfo
,

790 
a˘i⁄
, 
byãƒ
, 
num_byãs
);

791 
	`dump_ªf_a˘i⁄
(
fs_öfo
, 
ø
);

792 
	`k‰ì
(
ªf
);

793 
	`k‰ì
(
ø
);

794 
	`k‰ì
(
ª
);

795 
out_u∆ock
;

796 } i‡(
be
->
num_ªfs
 == 0) {

797 
	`båfs_îr
(
fs_öfo
,

799 
a˘i⁄
);

800 
	`dump_block_íåy
(
fs_öfo
, 
be
);

801 
	`dump_ªf_a˘i⁄
(
fs_öfo
, 
ø
);

802 
	`k‰ì
(
ªf
);

803 
	`k‰ì
(
ø
);

804 
	`k‰ì
(
ª
);

805 
out_u∆ock
;

808 i‡(!
∑ª¡
) {

809 
tmp
 = 
	`ö£π_roŸ_íåy
(&
be
->
roŸs
, 
ª
);

810 i‡(
tmp
) {

811 
	`k‰ì
(
ª
);

812 
ª
 = 
tmp
;

817 
exi°
 = 
	`ö£π_ªf_íåy
(&
be
->
ªfs
, 
ªf
);

818 i‡(
exi°
) {

819 i‡(
a˘i⁄
 =
BTRFS_DROP_DELAYED_REF
) {

820 i‡(
exi°
->
num_ªfs
 == 0) {

821 
	`båfs_îr
(
fs_öfo
,

823 
	`dump_block_íåy
(
fs_öfo
, 
be
);

824 
	`dump_ªf_a˘i⁄
(
fs_öfo
, 
ø
);

825 
	`k‰ì
(
ªf
);

826 
	`k‰ì
(
ø
);

827 
out_u∆ock
;

829 
exi°
->
num_ªfs
--;

830 i‡(
exi°
->
num_ªfs
 == 0) {

831 
	`rb_îa£
(&
exi°
->
node
, &
be
->
ªfs
);

832 
	`k‰ì
(
exi°
);

834 } i‡(!
be
->
mëad©a
) {

835 
exi°
->
num_ªfs
++;

837 
	`båfs_îr
(
fs_öfo
,

839 
	`dump_block_íåy
(
fs_öfo
, 
be
);

840 
	`dump_ªf_a˘i⁄
(
fs_öfo
, 
ø
);

841 
	`k‰ì
(
ªf
);

842 
	`k‰ì
(
ø
);

843 
out_u∆ock
;

845 
	`k‰ì
(
ªf
);

847 i‡(
a˘i⁄
 =
BTRFS_DROP_DELAYED_REF
) {

848 
	`båfs_îr
(
fs_öfo
,

850 
	`dump_block_íåy
(
fs_öfo
, 
be
);

851 
	`dump_ªf_a˘i⁄
(
fs_öfo
, 
ø
);

852 
	`k‰ì
(
ªf
);

853 
	`k‰ì
(
ø
);

854 
out_u∆ock
;

858 i‡(!
∑ª¡
 && !
ª
) {

859 
ª
 = 
	`lookup_roŸ_íåy
(&
be
->
roŸs
, 
ªf_roŸ
);

860 i‡(!
ª
) {

867 
	`båfs_îr
(
fs_öfo
, "failedÅo findÑoot %llu for %llu",

868 
gíîic_ªf
->
ªÆ_roŸ
, 
be
->
byãƒ
);

869 
	`dump_block_íåy
(
fs_öfo
, 
be
);

870 
	`dump_ªf_a˘i⁄
(
fs_öfo
, 
ø
);

871 
	`k‰ì
(
ø
);

872 
out_u∆ock
;

875 i‡(
a˘i⁄
 =
BTRFS_DROP_DELAYED_REF
) {

876 i‡(
ª
)

877 
ª
->
num_ªfs
--;

878 
be
->
num_ªfs
--;

879 } i‡(
a˘i⁄
 =
BTRFS_ADD_DELAYED_REF
) {

880 
be
->
num_ªfs
++;

881 i‡(
ª
)

882 
ª
->
num_ªfs
++;

884 
	`li°_add_èû
(&
ø
->
li°
, &
be
->
a˘i⁄s
);

885 
ªt
 = 0;

886 
out_u∆ock
:

887 
	`•ö_u∆ock
(&
fs_öfo
->
ªf_vîify_lock
);

888 
out
:

889 i‡(
ªt
)

890 
	`båfs_˛ór_›t
(
fs_öfo
->
mou¡_›t
, 
REF_VERIFY
);

891  
ªt
;

892 
	}
}

895 
	$båfs_‰ì_ªf_ˇche
(
båfs_fs_öfo
 *
fs_öfo
)

897 
block_íåy
 *
be
;

898 
rb_node
 *
n
;

900 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
REF_VERIFY
))

903 
	`•ö_lock
(&
fs_öfo
->
ªf_vîify_lock
);

904 (
n
 = 
	`rb_fú°
(&
fs_öfo
->
block_åì
))) {

905 
be
 = 
	`rb_íåy
(
n
, 
block_íåy
, 
node
);

906 
	`rb_îa£
(&
be
->
node
, &
fs_öfo
->
block_åì
);

907 
	`‰ì_block_íåy
(
be
);

908 
	`c⁄d_ªsched_lock
(&
fs_öfo
->
ªf_vîify_lock
);

910 
	`•ö_u∆ock
(&
fs_öfo
->
ªf_vîify_lock
);

911 
	}
}

913 
	$båfs_‰ì_ªf_åì_ønge
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
°¨t
,

914 
u64
 
Àn
)

916 
block_íåy
 *
be
 = 
NULL
, *
íåy
;

917 
rb_node
 *
n
;

919 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
REF_VERIFY
))

922 
	`•ö_lock
(&
fs_öfo
->
ªf_vîify_lock
);

923 
n
 = 
fs_öfo
->
block_åì
.
rb_node
;

924 
n
) {

925 
íåy
 = 
	`rb_íåy
(
n
, 
block_íåy
, 
node
);

926 i‡(
íåy
->
byãƒ
 < 
°¨t
) {

927 
n
 =Ç->
rb_right
;

928 } i‡(
íåy
->
byãƒ
 > 
°¨t
) {

929 
n
 =Ç->
rb_À·
;

931 
be
 = 
íåy
;

935 i‡(
be
 =
NULL
 ||

936 (
íåy
->
byãƒ
 < 
°¨t
 && 
be
->bytenr > start) ||

937 (
íåy
->
byãƒ
 < 
°¨t
 &&É¡ry->byãƒ > 
be
->bytenr))

938 
be
 = 
íåy
;

945 i‡(!
be
) {

946 
	`•ö_u∆ock
(&
fs_öfo
->
ªf_vîify_lock
);

950 
n
 = &
be
->
node
;

951 
n
) {

952 
be
 = 
	`rb_íåy
(
n
, 
block_íåy
, 
node
);

953 
n
 = 
	`rb_√xt
(n);

954 i‡(
be
->
byãƒ
 < 
°¨t
 && be->byãƒ + be->
Àn
 > start) {

955 
	`båfs_îr
(
fs_öfo
,

957 
°¨t
, 
Àn
);

958 
	`dump_block_íåy
(
fs_öfo
, 
be
);

961 i‡(
be
->
byãƒ
 < 
°¨t
)

963 i‡(
be
->
byãƒ
 >
°¨t
 + 
Àn
)

965 i‡(
be
->
byãƒ
 + be->
Àn
 > 
°¨t
 +Üen) {

966 
	`båfs_îr
(
fs_öfo
,

968 
°¨t
, 
Àn
);

969 
	`dump_block_íåy
(
fs_öfo
, 
be
);

971 
	`rb_îa£
(&
be
->
node
, &
fs_öfo
->
block_åì
);

972 
	`‰ì_block_íåy
(
be
);

974 
	`•ö_u∆ock
(&
fs_öfo
->
ªf_vîify_lock
);

975 
	}
}

978 
	$båfs_buûd_ªf_åì
(
båfs_fs_öfo
 *
fs_öfo
)

980 
båfs_roŸ
 *
exã¡_roŸ
;

981 
båfs_∑th
 *
∑th
;

982 
exã¡_buf„r
 *
eb
;

983 
åì_block_Àvñ
 = 0;

984 
u64
 
byãƒ
 = 0, 
num_byãs
 = 0;

985 
ªt
, 
Àvñ
;

987 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
REF_VERIFY
))

990 
∑th
 = 
	`båfs_Æloc_∑th
();

991 i‡(!
∑th
)

992  -
ENOMEM
;

994 
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
, 0);

995 
eb
 = 
	`båfs_ªad_lock_roŸ_node
(
exã¡_roŸ
);

996 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
eb
);

997 
∑th
->
nodes
[
Àvñ
] = 
eb
;

998 
∑th
->
¶Ÿs
[
Àvñ
] = 0;

999 
∑th
->
locks
[
Àvñ
] = 
BTRFS_READ_LOCK
;

1008 
ªt
 = 
	`wÆk_down_åì
(
exã¡_roŸ
, 
∑th
, 
Àvñ
,

1009 &
byãƒ
, &
num_byãs
, &
åì_block_Àvñ
);

1010 i‡(
ªt
)

1012 
ªt
 = 
	`wÆk_up_åì
(
∑th
, &
Àvñ
);

1013 i‡(
ªt
 < 0)

1015 i‡(
ªt
 > 0) {

1016 
ªt
 = 0;

1020 i‡(
ªt
) {

1021 
	`båfs_˛ór_›t
(
fs_öfo
->
mou¡_›t
, 
REF_VERIFY
);

1022 
	`båfs_‰ì_ªf_ˇche
(
fs_öfo
);

1024 
	`båfs_‰ì_∑th
(
∑th
);

1025  
ªt
;

1026 
	}
}

	@ref-verify.h

6 #i‚de‡
BTRFS_REF_VERIFY_H


7 
	#BTRFS_REF_VERIFY_H


	)

9 #ifde‡
CONFIG_BTRFS_FS_REF_VERIFY


10 
båfs_buûd_ªf_åì
(
båfs_fs_öfo
 *
fs_öfo
);

11 
båfs_‰ì_ªf_ˇche
(
båfs_fs_öfo
 *
fs_öfo
);

12 
båfs_ªf_åì_mod
(
båfs_fs_öfo
 *
fs_öfo
,

13 
båfs_ªf
 *
gíîic_ªf
);

14 
båfs_‰ì_ªf_åì_ønge
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
°¨t
,

15 
u64
 
Àn
);

17 
ölöe
 
	$båfs_öô_ªf_vîify
(
båfs_fs_öfo
 *
fs_öfo
)

19 
	`•ö_lock_öô
(&
fs_öfo
->
ªf_vîify_lock
);

20 
fs_öfo
->
block_åì
 = 
RB_ROOT
;

21 
	}
}

23 
ölöe
 
	$båfs_buûd_ªf_åì
(
båfs_fs_öfo
 *
fs_öfo
)

26 
	}
}

28 
ölöe
 
	$båfs_‰ì_ªf_ˇche
(
båfs_fs_öfo
 *
fs_öfo
)

30 
	}
}

32 
ölöe
 
	$båfs_ªf_åì_mod
(
båfs_fs_öfo
 *
fs_öfo
,

33 
båfs_ªf
 *
gíîic_ªf
)

36 
	}
}

38 
ölöe
 
	$båfs_‰ì_ªf_åì_ønge
(
båfs_fs_öfo
 *
fs_öfo
,

39 
u64
 
°¨t
, u64 
Àn
)

41 
	}
}

43 
ölöe
 
	$båfs_öô_ªf_vîify
(
båfs_fs_öfo
 *
fs_öfo
)

45 
	}
}

	@reflink.c

3 
	~<löux/blkdev.h
>

4 
	~<löux/ivîsi⁄.h
>

5 
	~"˘ªe.h
"

6 
	~"fs.h
"

7 
	~"mesßges.h
"

8 
	~"com¥essi⁄.h
"

9 
	~"dñÆloc-•a˚.h
"

10 
	~"disk-io.h
"

11 
	~"ªÊök.h
"

12 
	~"å™ß˘i⁄.h
"

13 
	~"sub∑ge.h
"

14 
	~"ac˚ss‹s.h
"

15 
	~"fûe-ôem.h
"

16 
	~"fûe.h
"

17 
	~"su≥r.h
"

19 
	#BTRFS_MAX_DEDUPE_LEN
 
SZ_16M


	)

21 
	$˛⁄e_föish_öode_upd©e
(
båfs_å™s_h™dÀ
 *
å™s
,

22 
öode
 *inode,

23 
u64
 
ídoff
,

24 c⁄° 
u64
 
de°off
,

25 c⁄° 
u64
 
ﬁí
,

26 
no_time_upd©e
)

28 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

29 
ªt
;

31 
	`öode_öc_ivîsi⁄
(
öode
);

32 i‡(!
no_time_upd©e
) {

33 
öode
->
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(inode);

39 i‡(
ídoff
 > 
de°off
 + 
ﬁí
)

40 
ídoff
 = 
de°off
 + 
ﬁí
;

41 i‡(
ídoff
 > 
öode
->
i_size
) {

42 
	`i_size_wrôe
(
öode
, 
ídoff
);

43 
	`båfs_öode_ß„_disk_i_size_wrôe
(
	`BTRFS_I
(
öode
), 0);

46 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

47 i‡(
ªt
) {

48 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

49 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

50 
out
;

52 
ªt
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

53 
out
:

54  
ªt
;

55 
	}
}

57 
	$c›y_ölöe_to_∑ge
(
båfs_öode
 *
öode
,

58 c⁄° 
u64
 
fûe_off£t
,

59 *
ölöe_d©a
,

60 c⁄° 
u64
 
size
,

61 c⁄° 
u64
 
d©Æ
,

62 c⁄° 
u8
 
comp_ty≥
)

64 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

65 c⁄° 
u32
 
block_size
 = 
fs_öfo
->
£˘‹size
;

66 c⁄° 
u64
 
ønge_íd
 = 
fûe_off£t
 + 
block_size
 - 1;

67 c⁄° 
size_t
 
ölöe_size
 = 
size
 - 
	`båfs_fûe_exã¡_ˇlc_ölöe_size
(0);

68 *
d©a_°¨t
 = 
ölöe_d©a
 + 
	`båfs_fûe_exã¡_ˇlc_ölöe_size
(0);

69 
exã¡_ch™ge£t
 *
d©a_ª£rved
 = 
NULL
;

70 
∑ge
 *∑gê
NULL
;

71 
addªss_•a˚
 *
m≠pög
 = 
öode
->
vfs_öode
.
i_m≠pög
;

72 
ªt
;

74 
	`ASSERT
(
	`IS_ALIGNED
(
fûe_off£t
, 
block_size
));

82 
ªt
 = 
	`båfs_dñÆloc_ª£rve_•a˚
(
öode
, &
d©a_ª£rved
, 
fûe_off£t
,

83 
block_size
);

84 i‡(
ªt
)

85 
out
;

87 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
m≠pög
, 
fûe_off£t
 >> 
PAGE_SHIFT
,

88 
	`båfs_Æloc_wrôe_mask
(
m≠pög
));

89 i‡(!
∑ge
) {

90 
ªt
 = -
ENOMEM
;

91 
out_u∆ock
;

94 
ªt
 = 
	`£t_∑ge_exã¡_m≠≥d
(
∑ge
);

95 i‡(
ªt
 < 0)

96 
out_u∆ock
;

98 
	`˛ór_exã¡_bô
(&
öode
->
io_åì
, 
fûe_off£t
, 
ønge_íd
,

99 
EXTENT_DELALLOC
 | 
EXTENT_DO_ACCOUNTING
 | 
EXTENT_DEFRAG
,

100 
NULL
);

101 
ªt
 = 
	`båfs_£t_exã¡_dñÆloc
(
öode
, 
fûe_off£t
, 
ønge_íd
, 0, 
NULL
);

102 i‡(
ªt
)

103 
out_u∆ock
;

116 
	`£t_bô
(
BTRFS_INODE_NO_DELALLOC_FLUSH
, &
öode
->
ru¡ime_Êags
);

118 i‡(
comp_ty≥
 =
BTRFS_COMPRESS_NONE
) {

119 
	`mem˝y_to_∑ge
(
∑ge
, 
	`off£t_ö_∑ge
(
fûe_off£t
), 
d©a_°¨t
,

120 
d©Æ
);

122 
ªt
 = 
	`båfs_decom¥ess
(
comp_ty≥
, 
d©a_°¨t
, 
∑ge
,

123 
	`off£t_ö_∑ge
(
fûe_off£t
),

124 
ölöe_size
, 
d©Æ
);

125 i‡(
ªt
)

126 
out_u∆ock
;

127 
	`Êush_dˇche_∑ge
(
∑ge
);

142 i‡(
d©Æ
 < 
block_size
)

143 
	`memzîo_∑ge
(
∑ge
, 
d©Æ
, 
block_size
 - datal);

145 
	`båfs_∑ge_£t_u±od©e
(
fs_öfo
, 
∑ge
, 
fûe_off£t
, 
block_size
);

146 
	`båfs_∑ge_˛ór_checked
(
fs_öfo
, 
∑ge
, 
fûe_off£t
, 
block_size
);

147 
	`båfs_∑ge_£t_dúty
(
fs_öfo
, 
∑ge
, 
fûe_off£t
, 
block_size
);

148 
out_u∆ock
:

149 i‡(
∑ge
) {

150 
	`u∆ock_∑ge
(
∑ge
);

151 
	`put_∑ge
(
∑ge
);

153 i‡(
ªt
)

154 
	`båfs_dñÆloc_ªÀa£_•a˚
(
öode
, 
d©a_ª£rved
, 
fûe_off£t
,

155 
block_size
, 
åue
);

156 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
öode
, 
block_size
);

157 
out
:

158 
	`exã¡_ch™ge£t_‰ì
(
d©a_ª£rved
);

160  
ªt
;

161 
	}
}

168 
	$˛⁄e_c›y_ölöe_exã¡
(
öode
 *
d°
,

169 
båfs_∑th
 *
∑th
,

170 
båfs_key
 *
√w_key
,

171 c⁄° 
u64
 
dr›_°¨t
,

172 c⁄° 
u64
 
d©Æ
,

173 c⁄° 
u64
 
size
,

174 c⁄° 
u8
 
comp_ty≥
,

175 *
ölöe_d©a
,

176 
båfs_å™s_h™dÀ
 **
å™s_out
)

178 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
d°
->
i_sb
);

179 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
d°
)->root;

180 c⁄° 
u64
 
Æig√d_íd
 = 
	`ALIGN
(
√w_key
->
off£t
 + 
d©Æ
,

181 
fs_öfo
->
£˘‹size
);

182 
båfs_å™s_h™dÀ
 *
å™s
 = 
NULL
;

183 
båfs_dr›_exã¡s_¨gs
 
dr›_¨gs
 = { 0 };

184 
ªt
;

185 
båfs_key
 
key
;

187 i‡(
√w_key
->
off£t
 > 0) {

188 
ªt
 = 
	`c›y_ölöe_to_∑ge
(
	`BTRFS_I
(
d°
), 
√w_key
->
off£t
,

189 
ölöe_d©a
, 
size
, 
d©Æ
, 
comp_ty≥
);

190 
out
;

193 
key
.
obje˘id
 = 
	`båfs_öo
(
	`BTRFS_I
(
d°
));

194 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

195 
key
.
off£t
 = 0;

196 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

197 i‡(
ªt
 < 0) {

198  
ªt
;

199 } i‡(
ªt
 > 0) {

200 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
’©h->
nodes
[0])) {

201 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

202 i‡(
ªt
 < 0)

203  
ªt
;

204 i‡(
ªt
 > 0)

205 
c›y_ölöe_exã¡
;

207 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

208 i‡(
key
.
obje˘id
 =
	`båfs_öo
(
	`BTRFS_I
(
d°
)) &&

209 
key
.
ty≥
 =
BTRFS_EXTENT_DATA_KEY
) {

214 
	`ASSERT
(
key
.
off£t
 > 0);

215 
c›y_to_∑ge
;

217 } i‡(
	`i_size_ªad
(
d°
Ë<
d©Æ
) {

218 
båfs_fûe_exã¡_ôem
 *
ei
;

220 
ei
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

221 
båfs_fûe_exã¡_ôem
);

227 i‡(
	`båfs_fûe_exã¡_ty≥
(
∑th
->
nodes
[0], 
ei
) ==

228 
BTRFS_FILE_EXTENT_INLINE
)

229 
c›y_ölöe_exã¡
;

231 
c›y_to_∑ge
;

234 
c›y_ölöe_exã¡
:

239 i‡(
	`i_size_ªad
(
d°
Ë> 
d©Æ
) {

246 
c›y_to_∑ge
;

253 
	`båfs_ªÀa£_∑th
(
∑th
);

263 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 3);

264 i‡(
	`IS_ERR
(
å™s
)) {

265 
ªt
 = 
	`PTR_ERR
(
å™s
);

266 
å™s
 = 
NULL
;

267 
out
;

269 
dr›_¨gs
.
∑th
 =Öath;

270 
dr›_¨gs
.
°¨t
 = 
dr›_°¨t
;

271 
dr›_¨gs
.
íd
 = 
Æig√d_íd
;

272 
dr›_¨gs
.
dr›_ˇche
 = 
åue
;

273 
ªt
 = 
	`båfs_dr›_exã¡s
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
d°
), &
dr›_¨gs
);

274 i‡(
ªt
)

275 
out
;

276 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, 
√w_key
, 
size
);

277 i‡(
ªt
)

278 
out
;

280 
	`wrôe_exã¡_buf„r
(
∑th
->
nodes
[0], 
ölöe_d©a
,

281 
	`båfs_ôem_±r_off£t
(
∑th
->
nodes
[0],

282 
∑th
->
¶Ÿs
[0]),

283 
size
);

284 
	`båfs_upd©e_öode_byãs
(
	`BTRFS_I
(
d°
), 
d©Æ
, 
dr›_¨gs
.
byãs_found
);

285 
	`båfs_£t_öode_fuŒ_sync
(
	`BTRFS_I
(
d°
));

286 
ªt
 = 
	`båfs_öode_£t_fûe_exã¡_ønge
(
	`BTRFS_I
(
d°
), 0, 
Æig√d_íd
);

287 
out
:

288 i‡(!
ªt
 && !
å™s
) {

295 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 1);

296 i‡(
	`IS_ERR
(
å™s
)) {

297 
ªt
 = 
	`PTR_ERR
(
å™s
);

298 
å™s
 = 
NULL
;

301 i‡(
ªt
 && 
å™s
) {

302 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

303 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

305 i‡(!
ªt
)

306 *
å™s_out
 = 
å™s
;

308  
ªt
;

310 
c›y_to_∑ge
:

319 
	`båfs_ªÀa£_∑th
(
∑th
);

321 
ªt
 = 
	`c›y_ölöe_to_∑ge
(
	`BTRFS_I
(
d°
), 
√w_key
->
off£t
,

322 
ölöe_d©a
, 
size
, 
d©Æ
, 
comp_ty≥
);

323 
out
;

324 
	}
}

337 
	$båfs_˛⁄e
(
öode
 *
§c
, inode *inode,

338 c⁄° 
u64
 
off
, c⁄° u64 
ﬁí
, c⁄° u64 
ﬁí_Æig√d
,

339 c⁄° 
u64
 
de°off
, 
no_time_upd©e
)

341 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

342 
båfs_∑th
 *
∑th
 = 
NULL
;

343 
exã¡_buf„r
 *
Àaf
;

344 
båfs_å™s_h™dÀ
 *
å™s
;

345 *
buf
 = 
NULL
;

346 
båfs_key
 
key
;

347 
u32
 
ƒôems
;

348 
¶Ÿ
;

349 
ªt
;

350 c⁄° 
u64
 
Àn
 = 
ﬁí_Æig√d
;

351 
u64
 
œ°_de°_íd
 = 
de°off
;

352 
u64
 
¥ev_exã¡_íd
 = 
off
;

354 
ªt
 = -
ENOMEM
;

355 
buf
 = 
	`kvmÆloc
(
fs_öfo
->
nodesize
, 
GFP_KERNEL
);

356 i‡(!
buf
)

357  
ªt
;

359 
∑th
 = 
	`båfs_Æloc_∑th
();

360 i‡(!
∑th
) {

361 
	`kv‰ì
(
buf
);

362  
ªt
;

365 
∑th
->
ªada
 = 
READA_FORWARD
;

367 
key
.
obje˘id
 = 
	`båfs_öo
(
	`BTRFS_I
(
§c
));

368 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

369 
key
.
off£t
 = 
off
;

372 
båfs_fûe_exã¡_ôem
 *
exã¡
;

373 
u64
 
exã¡_gí
;

374 
ty≥
;

375 
u32
 
size
;

376 
båfs_key
 
√w_key
;

377 
u64
 
disko
 = 0, 
diskl
 = 0;

378 
u64
 
d©ao
 = 0, 
d©Æ
 = 0;

379 
u8
 
comp
;

380 
u64
 
dr›_°¨t
;

383 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
	`BTRFS_I
(
§c
)->
roŸ
, &
key
, 
∑th
,

385 i‡(
ªt
 < 0)

386 
out
;

392 i‡(
key
.
off£t
 =
off
 && 
ªt
 > 0 && 
∑th
->
¶Ÿs
[0] > 0) {

393 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,

394 
∑th
->
¶Ÿs
[0] - 1);

395 i‡(
key
.
ty≥
 =
BTRFS_EXTENT_DATA_KEY
)

396 
∑th
->
¶Ÿs
[0]--;

399 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0]);

400 
¥o˚ss_¶Ÿ
:

401 i‡(
∑th
->
¶Ÿs
[0] >
ƒôems
) {

402 
ªt
 = 
	`båfs_√xt_Àaf
(
	`BTRFS_I
(
§c
)->
roŸ
, 
∑th
);

403 i‡(
ªt
 < 0)

404 
out
;

405 i‡(
ªt
 > 0)

407 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0]);

409 
Àaf
 = 
∑th
->
nodes
[0];

410 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

412 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

413 i‡(
key
.
ty≥
 > 
BTRFS_EXTENT_DATA_KEY
 ||

414 
key
.
obje˘id
 !
	`båfs_öo
(
	`BTRFS_I
(
§c
)))

417 
	`ASSERT
(
key
.
ty≥
 =
BTRFS_EXTENT_DATA_KEY
);

419 
exã¡
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
,

420 
båfs_fûe_exã¡_ôem
);

421 
exã¡_gí
 = 
	`båfs_fûe_exã¡_gíî©i⁄
(
Àaf
, 
exã¡
);

422 
comp
 = 
	`båfs_fûe_exã¡_com¥essi⁄
(
Àaf
, 
exã¡
);

423 
ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
exã¡
);

424 i‡(
ty≥
 =
BTRFS_FILE_EXTENT_REG
 ||

425 
ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
) {

426 
disko
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
exã¡
);

427 
diskl
 = 
	`båfs_fûe_exã¡_disk_num_byãs
(
Àaf
, 
exã¡
);

428 
d©ao
 = 
	`båfs_fûe_exã¡_off£t
(
Àaf
, 
exã¡
);

429 
d©Æ
 = 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
exã¡
);

430 } i‡(
ty≥
 =
BTRFS_FILE_EXTENT_INLINE
) {

432 
d©Æ
 = 
	`båfs_fûe_exã¡_øm_byãs
(
Àaf
, 
exã¡
);

446 i‡(
key
.
off£t
 + 
d©Æ
 <
¥ev_exã¡_íd
) {

447 
∑th
->
¶Ÿs
[0]++;

448 
¥o˚ss_¶Ÿ
;

449 } i‡(
key
.
off£t
 >
off
 + 
Àn
) {

453 
¥ev_exã¡_íd
 = 
key
.
off£t
 + 
d©Æ
;

454 
size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

455 
	`ªad_exã¡_buf„r
(
Àaf
, 
buf
, 
	`båfs_ôem_±r_off£t
÷óf, 
¶Ÿ
),

456 
size
);

458 
	`båfs_ªÀa£_∑th
(
∑th
);

460 
	`mem˝y
(&
√w_key
, &
key
, (new_key));

461 
√w_key
.
obje˘id
 = 
	`båfs_öo
(
	`BTRFS_I
(
öode
));

462 i‡(
off
 <
key
.
off£t
)

463 
√w_key
.
off£t
 = 
key
.off£à+ 
de°off
 - 
off
;

465 
√w_key
.
off£t
 = 
de°off
;

473 i‡(
√w_key
.
off£t
 !
œ°_de°_íd
)

474 
dr›_°¨t
 = 
œ°_de°_íd
;

476 
dr›_°¨t
 = 
√w_key
.
off£t
;

478 i‡(
ty≥
 =
BTRFS_FILE_EXTENT_REG
 ||

479 
ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
) {

480 
båfs_ª∂a˚_exã¡_öfo
 
˛⁄e_öfo
;

488 i‡(
key
.
off£t
 + 
d©Æ
 > 
off
 + 
Àn
)

489 
d©Æ
 = 
off
 + 
Àn
 - 
key
.
off£t
;

492 i‡(
off
 > 
key
.
off£t
) {

493 
d©ao
 +
off
 - 
key
.
off£t
;

494 
d©Æ
 -
off
 - 
key
.
off£t
;

497 
˛⁄e_öfo
.
disk_off£t
 = 
disko
;

498 
˛⁄e_öfo
.
disk_Àn
 = 
diskl
;

499 
˛⁄e_öfo
.
d©a_off£t
 = 
d©ao
;

500 
˛⁄e_öfo
.
d©a_Àn
 = 
d©Æ
;

501 
˛⁄e_öfo
.
fûe_off£t
 = 
√w_key
.
off£t
;

502 
˛⁄e_öfo
.
exã¡_buf
 = 
buf
;

503 
˛⁄e_öfo
.
is_√w_exã¡
 = 
Ál£
;

504 
˛⁄e_öfo
.
upd©e_times
 = !
no_time_upd©e
;

505 
ªt
 = 
	`båfs_ª∂a˚_fûe_exã¡s
(
	`BTRFS_I
(
öode
), 
∑th
,

506 
dr›_°¨t
, 
√w_key
.
off£t
 + 
d©Æ
 - 1,

507 &
˛⁄e_öfo
, &
å™s
);

508 i‡(
ªt
)

509 
out
;

511 
	`ASSERT
(
ty≥
 =
BTRFS_FILE_EXTENT_INLINE
);

520 
	`ASSERT
(
key
.
off£t
 == 0);

521 
	`ASSERT
(
d©Æ
 <
fs_öfo
->
£˘‹size
);

522 i‡(
	`WARN_ON
(
ty≥
 !
BTRFS_FILE_EXTENT_INLINE
) ||

523 
	`WARN_ON
(
key
.
off£t
 != 0) ||

524 
	`WARN_ON
(
d©Æ
 > 
fs_öfo
->
£˘‹size
)) {

525 
ªt
 = -
EUCLEAN
;

526 
out
;

529 
ªt
 = 
	`˛⁄e_c›y_ölöe_exã¡
(
öode
, 
∑th
, &
√w_key
,

530 
dr›_°¨t
, 
d©Æ
, 
size
,

531 
comp
, 
buf
, &
å™s
);

532 i‡(
ªt
)

533 
out
;

536 
	`båfs_ªÀa£_∑th
(
∑th
);

551 i‡(
exã¡_gí
 =
å™s
->
å™sid
 && 
disko
 > 0)

552 
	`BTRFS_I
(
§c
)->
œ°_ªÊök_å™s
 = 
å™s
->
å™sid
;

554 
	`BTRFS_I
(
öode
)->
œ°_ªÊök_å™s
 = 
å™s
->
å™sid
;

556 
œ°_de°_íd
 = 
	`ALIGN
(
√w_key
.
off£t
 + 
d©Æ
,

557 
fs_öfo
->
£˘‹size
);

558 
ªt
 = 
	`˛⁄e_föish_öode_upd©e
(
å™s
, 
öode
, 
œ°_de°_íd
,

559 
de°off
, 
ﬁí
, 
no_time_upd©e
);

560 i‡(
ªt
)

561 
out
;

562 i‡(
√w_key
.
off£t
 + 
d©Æ
 >
de°off
 + 
Àn
)

565 
	`båfs_ªÀa£_∑th
(
∑th
);

566 
key
.
off£t
 = 
¥ev_exã¡_íd
;

568 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

569 
ªt
 = -
EINTR
;

570 
out
;

573 
	`c⁄d_ªsched
();

575 
ªt
 = 0;

577 i‡(
œ°_de°_íd
 < 
de°off
 + 
Àn
) {

584 
	`båfs_ªÀa£_∑th
(
∑th
);

600 i‡(
œ°_de°_íd
 >
	`i_size_ªad
(
öode
))

601 
	`båfs_£t_öode_fuŒ_sync
(
	`BTRFS_I
(
öode
));

603 
ªt
 = 
	`båfs_ª∂a˚_fûe_exã¡s
(
	`BTRFS_I
(
öode
), 
∑th
,

604 
œ°_de°_íd
, 
de°off
 + 
Àn
 - 1, 
NULL
, &
å™s
);

605 i‡(
ªt
)

606 
out
;

608 
ªt
 = 
	`˛⁄e_föish_öode_upd©e
(
å™s
, 
öode
, 
de°off
 + 
Àn
,

609 
de°off
, 
ﬁí
, 
no_time_upd©e
);

612 
out
:

613 
	`båfs_‰ì_∑th
(
∑th
);

614 
	`kv‰ì
(
buf
);

615 
	`˛ór_bô
(
BTRFS_INODE_NO_DELALLOC_FLUSH
, &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
);

617  
ªt
;

618 
	}
}

620 
	$båfs_doubÀ_exã¡_u∆ock
(
öode
 *
öode1
, 
u64
 
loff1
,

621 
öode
 *
öode2
, 
u64
 
loff2
, u64 
Àn
)

623 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode1
)->
io_åì
, 
loff1
,Üoff1 + 
Àn
 - 1, 
NULL
);

624 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode2
)->
io_åì
, 
loff2
,Üoff2 + 
Àn
 - 1, 
NULL
);

625 
	}
}

627 
	$båfs_doubÀ_exã¡_lock
(
öode
 *
öode1
, 
u64
 
loff1
,

628 
öode
 *
öode2
, 
u64
 
loff2
, u64 
Àn
)

630 
u64
 
ønge1_íd
 = 
loff1
 + 
Àn
 - 1;

631 
u64
 
ønge2_íd
 = 
loff2
 + 
Àn
 - 1;

633 i‡(
öode1
 < 
öode2
) {

634 
	`sw≠
(
öode1
, 
öode2
);

635 
	`sw≠
(
loff1
, 
loff2
);

636 
	`sw≠
(
ønge1_íd
, 
ønge2_íd
);

637 } i‡(
öode1
 =
öode2
 && 
loff2
 < 
loff1
) {

638 
	`sw≠
(
loff1
, 
loff2
);

639 
	`sw≠
(
ønge1_íd
, 
ønge2_íd
);

642 
	`lock_exã¡
(&
	`BTRFS_I
(
öode1
)->
io_åì
, 
loff1
, 
ønge1_íd
, 
NULL
);

643 
	`lock_exã¡
(&
	`BTRFS_I
(
öode2
)->
io_åì
, 
loff2
, 
ønge2_íd
, 
NULL
);

645 
	`båfs_as£π_öode_ønge_˛ón
(
	`BTRFS_I
(
öode1
), 
loff1
, 
ønge1_íd
);

646 
	`båfs_as£π_öode_ønge_˛ón
(
	`BTRFS_I
(
öode2
), 
loff2
, 
ønge2_íd
);

647 
	}
}

649 
	$båfs_doubÀ_mm≠_lock
(
öode
 *
öode1
, öodê*
öode2
)

651 i‡(
öode1
 < 
öode2
)

652 
	`sw≠
(
öode1
, 
öode2
);

653 
	`down_wrôe
(&
	`BTRFS_I
(
öode1
)->
i_mm≠_lock
);

654 
	`down_wrôe_√°ed
(&
	`BTRFS_I
(
öode2
)->
i_mm≠_lock
, 
SINGLE_DEPTH_NESTING
);

655 
	}
}

657 
	$båfs_doubÀ_mm≠_u∆ock
(
öode
 *
öode1
, öodê*
öode2
)

659 
	`up_wrôe
(&
	`BTRFS_I
(
öode1
)->
i_mm≠_lock
);

660 
	`up_wrôe
(&
	`BTRFS_I
(
öode2
)->
i_mm≠_lock
);

661 
	}
}

663 
	$båfs_exã¡_ßme_ønge
(
öode
 *
§c
, 
u64
 
loff
, u64 
Àn
,

664 
öode
 *
d°
, 
u64
 
d°_loff
)

666 
båfs_fs_öfo
 *
fs_öfo
 = 
	`BTRFS_I
(
§c
)->
roŸ
->fs_info;

667 c⁄° 
u64
 
bs
 = 
fs_öfo
->
sb
->
s_blocksize
;

668 
ªt
;

674 
	`båfs_doubÀ_exã¡_lock
(
§c
, 
loff
, 
d°
, 
d°_loff
, 
Àn
);

675 
ªt
 = 
	`båfs_˛⁄e
(
§c
, 
d°
, 
loff
, 
Àn
, 
	`ALIGN
÷í, 
bs
), 
d°_loff
, 1);

676 
	`båfs_doubÀ_exã¡_u∆ock
(
§c
, 
loff
, 
d°
, 
d°_loff
, 
Àn
);

678 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

680  
ªt
;

681 
	}
}

683 
	$båfs_exã¡_ßme
(
öode
 *
§c
, 
u64
 
loff
, u64 
ﬁí
,

684 
öode
 *
d°
, 
u64
 
d°_loff
)

686 
ªt
 = 0;

687 
u64
 
i
, 
èû_Àn
, 
chunk_cou¡
;

688 
båfs_roŸ
 *
roŸ_d°
 = 
	`BTRFS_I
(
d°
)->
roŸ
;

690 
	`•ö_lock
(&
roŸ_d°
->
roŸ_ôem_lock
);

691 i‡(
roŸ_d°
->
£nd_ö_¥ogªss
) {

692 
	`båfs_w¨n_æ
(
roŸ_d°
->
fs_öfo
,

694 
roŸ_d°
->
roŸ_key
.
obje˘id
,

695 
roŸ_d°
->
£nd_ö_¥ogªss
);

696 
	`•ö_u∆ock
(&
roŸ_d°
->
roŸ_ôem_lock
);

697  -
EAGAIN
;

699 
roŸ_d°
->
dedu≥_ö_¥ogªss
++;

700 
	`•ö_u∆ock
(&
roŸ_d°
->
roŸ_ôem_lock
);

702 
èû_Àn
 = 
ﬁí
 % 
BTRFS_MAX_DEDUPE_LEN
;

703 
chunk_cou¡
 = 
	`div_u64
(
ﬁí
, 
BTRFS_MAX_DEDUPE_LEN
);

705 
i
 = 0; i < 
chunk_cou¡
; i++) {

706 
ªt
 = 
	`båfs_exã¡_ßme_ønge
(
§c
, 
loff
, 
BTRFS_MAX_DEDUPE_LEN
,

707 
d°
, 
d°_loff
);

708 i‡(
ªt
)

709 
out
;

711 
loff
 +
BTRFS_MAX_DEDUPE_LEN
;

712 
d°_loff
 +
BTRFS_MAX_DEDUPE_LEN
;

715 i‡(
èû_Àn
 > 0)

716 
ªt
 = 
	`båfs_exã¡_ßme_ønge
(
§c
, 
loff
, 
èû_Àn
, 
d°
, 
d°_loff
);

717 
out
:

718 
	`•ö_lock
(&
roŸ_d°
->
roŸ_ôem_lock
);

719 
roŸ_d°
->
dedu≥_ö_¥ogªss
--;

720 
	`•ö_u∆ock
(&
roŸ_d°
->
roŸ_ôem_lock
);

722  
ªt
;

723 
	}
}

725 
noölöe
 
	$båfs_˛⁄e_fûes
(
fûe
 *fûe, fûê*
fûe_§c
,

726 
u64
 
off
, u64 
ﬁí
, u64 
de°off
)

728 
öode
 *öodê
	`fûe_öode
(
fûe
);

729 
öode
 *
§c
 = 
	`fûe_öode
(
fûe_§c
);

730 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

731 
ªt
;

732 
wb_ªt
;

733 
u64
 
Àn
 = 
ﬁí
;

734 
u64
 
bs
 = 
fs_öfo
->
sb
->
s_blocksize
;

742 i‡(
off
 + 
Àn
 =
§c
->
i_size
)

743 
Àn
 = 
	`ALIGN
(
§c
->
i_size
, 
bs
Ë- 
off
;

745 i‡(
de°off
 > 
öode
->
i_size
) {

746 c⁄° 
u64
 
wb_°¨t
 = 
	`ALIGN_DOWN
(
öode
->
i_size
, 
bs
);

748 
ªt
 = 
	`båfs_c⁄t_ex∑nd
(
	`BTRFS_I
(
öode
), inode->
i_size
, 
de°off
);

749 i‡(
ªt
)

750  
ªt
;

760 
ªt
 = 
	`båfs_waô_‹dîed_ønge
(
öode
, 
wb_°¨t
,

761 
de°off
 - 
wb_°¨t
);

762 i‡(
ªt
)

763  
ªt
;

770 
	`båfs_doubÀ_exã¡_lock
(
§c
, 
off
, 
öode
, 
de°off
, 
Àn
);

771 
ªt
 = 
	`båfs_˛⁄e
(
§c
, 
öode
, 
off
, 
ﬁí
, 
Àn
, 
de°off
, 0);

772 
	`båfs_doubÀ_exã¡_u∆ock
(
§c
, 
off
, 
öode
, 
de°off
, 
Àn
);

779 
wb_ªt
 = 
	`båfs_waô_‹dîed_ønge
(
öode
, 
de°off
, 
Àn
);

780 
ªt
 =Ñë ?Ñë : 
wb_ªt
;

785 
	`åunˇã_öode_∑ges_ønge
(&
öode
->
i_d©a
,

786 
	`round_down
(
de°off
, 
PAGE_SIZE
),

787 
	`round_up
(
de°off
 + 
Àn
, 
PAGE_SIZE
) - 1);

789 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

791  
ªt
;

792 
	}
}

794 
	$båfs_ªm≠_fûe_ønge_¥ï
(
fûe
 *
fûe_ö
, 
loff_t
 
pos_ö
,

795 
fûe
 *
fûe_out
, 
loff_t
 
pos_out
,

796 
loff_t
 *
Àn
, 
ªm≠_Êags
)

798 
öode
 *
öode_ö
 = 
	`fûe_öode
(
fûe_ö
);

799 
öode
 *
öode_out
 = 
	`fûe_öode
(
fûe_out
);

800 
u64
 
bs
 = 
	`BTRFS_I
(
öode_out
)->
roŸ
->
fs_öfo
->
sb
->
s_blocksize
;

801 
u64
 
wb_Àn
;

802 
ªt
;

804 i‡(!(
ªm≠_Êags
 & 
REMAP_FILE_DEDUP
)) {

805 
båfs_roŸ
 *
roŸ_out
 = 
	`BTRFS_I
(
öode_out
)->
roŸ
;

807 i‡(
	`båfs_roŸ_ªad⁄ly
(
roŸ_out
))

808  -
EROFS
;

810 
	`ASSERT
(
öode_ö
->
i_sb
 =
öode_out
->i_sb);

814 i‡((
	`BTRFS_I
(
öode_ö
)->
Êags
 & 
BTRFS_INODE_NODATASUM
) !=

815 (
	`BTRFS_I
(
öode_out
)->
Êags
 & 
BTRFS_INODE_NODATASUM
)) {

816  -
EINVAL
;

833 i‡(*
Àn
 =0 && !(
ªm≠_Êags
 & 
REMAP_FILE_DEDUP
))

834 
wb_Àn
 = 
	`ALIGN
(
öode_ö
->
i_size
, 
bs
Ë- 
	`ALIGN_DOWN
(
pos_ö
, bs);

836 
wb_Àn
 = 
	`ALIGN
(*
Àn
, 
bs
);

855 
ªt
 = 
	`fûem≠_Êush
(
öode_ö
->
i_m≠pög
);

856 i‡(
ªt
 < 0)

857  
ªt
;

859 
ªt
 = 
	`båfs_waô_‹dîed_ønge
(
öode_ö
, 
	`ALIGN_DOWN
(
pos_ö
, 
bs
),

860 
wb_Àn
);

861 i‡(
ªt
 < 0)

862  
ªt
;

863 
ªt
 = 
	`båfs_waô_‹dîed_ønge
(
öode_out
, 
	`ALIGN_DOWN
(
pos_out
, 
bs
),

864 
wb_Àn
);

865 i‡(
ªt
 < 0)

866  
ªt
;

868  
	`gíîic_ªm≠_fûe_ønge_¥ï
(
fûe_ö
, 
pos_ö
, 
fûe_out
, 
pos_out
,

869 
Àn
, 
ªm≠_Êags
);

870 
	}
}

872 
boﬁ
 
	$fûe_sync_wrôe
(c⁄° 
fûe
 *file)

874 i‡(
fûe
->
f_Êags
 & (
__O_SYNC
 | 
O_DSYNC
))

875  
åue
;

876 i‡(
	`IS_SYNC
(
	`fûe_öode
(
fûe
)))

877  
åue
;

879  
Ál£
;

880 
	}
}

882 
loff_t
 
	$båfs_ªm≠_fûe_ønge
(
fûe
 *
§c_fûe
, 
loff_t
 
off
,

883 
fûe
 *
d°_fûe
, 
loff_t
 
de°off
,Üoff_à
Àn
,

884 
ªm≠_Êags
)

886 
öode
 *
§c_öode
 = 
	`fûe_öode
(
§c_fûe
);

887 
öode
 *
d°_öode
 = 
	`fûe_öode
(
d°_fûe
);

888 
boﬁ
 
ßme_öode
 = 
d°_öode
 =
§c_öode
;

889 
ªt
;

891 i‡(
ªm≠_Êags
 & ~(
REMAP_FILE_DEDUP
 | 
REMAP_FILE_ADVISORY
))

892  -
EINVAL
;

894 i‡(
ßme_öode
) {

895 
	`båfs_öode_lock
(
	`BTRFS_I
(
§c_öode
), 
BTRFS_ILOCK_MMAP
);

897 
	`lock_two_n⁄dúe˘‹õs
(
§c_öode
, 
d°_öode
);

898 
	`båfs_doubÀ_mm≠_lock
(
§c_öode
, 
d°_öode
);

901 
ªt
 = 
	`båfs_ªm≠_fûe_ønge_¥ï
(
§c_fûe
, 
off
, 
d°_fûe
, 
de°off
,

902 &
Àn
, 
ªm≠_Êags
);

903 i‡(
ªt
 < 0 || 
Àn
 == 0)

904 
out_u∆ock
;

906 i‡(
ªm≠_Êags
 & 
REMAP_FILE_DEDUP
)

907 
ªt
 = 
	`båfs_exã¡_ßme
(
§c_öode
, 
off
, 
Àn
, 
d°_öode
, 
de°off
);

909 
ªt
 = 
	`båfs_˛⁄e_fûes
(
d°_fûe
, 
§c_fûe
, 
off
, 
Àn
, 
de°off
);

911 
out_u∆ock
:

912 i‡(
ßme_öode
) {

913 
	`båfs_öode_u∆ock
(
	`BTRFS_I
(
§c_öode
), 
BTRFS_ILOCK_MMAP
);

915 
	`båfs_doubÀ_mm≠_u∆ock
(
§c_öode
, 
d°_öode
);

916 
	`u∆ock_two_n⁄dúe˘‹õs
(
§c_öode
, 
d°_öode
);

926 i‡(
ªt
 =0 && 
Àn
 > 0 &&

927 (
	`fûe_sync_wrôe
(
§c_fûe
Ë|| fûe_sync_wrôe(
d°_fûe
))) {

928 
ªt
 = 
	`båfs_sync_fûe
(
§c_fûe
, 
off
, of‡+ 
Àn
 - 1, 0);

929 i‡(
ªt
 == 0)

930 
ªt
 = 
	`båfs_sync_fûe
(
d°_fûe
, 
de°off
,

931 
de°off
 + 
Àn
 - 1, 0);

934  
ªt
 < 0 ?Ñë : 
Àn
;

935 
	}
}

	@reflink.h

3 #i‚de‡
BTRFS_REFLINK_H


4 
	#BTRFS_REFLINK_H


	)

6 
	~<löux/fs.h
>

8 
loff_t
 
båfs_ªm≠_fûe_ønge
(
fûe
 *
fûe_ö
,Üoff_à
pos_ö
,

9 
fûe
 *
fûe_out
, 
loff_t
 
pos_out
,

10 
loff_t
 
Àn
, 
ªm≠_Êags
);

	@relocation.c

6 
	~<löux/sched.h
>

7 
	~<löux/∑gem≠.h
>

8 
	~<löux/wrôeback.h
>

9 
	~<löux/blkdev.h
>

10 
	~<löux/rbåì.h
>

11 
	~<löux/¶ab.h
>

12 
	~<löux/îr‹-öje˘i⁄.h
>

13 
	~"˘ªe.h
"

14 
	~"disk-io.h
"

15 
	~"å™ß˘i⁄.h
"

16 
	~"vﬁumes.h
"

17 
	~"lockög.h
"

18 
	~"båfs_öode.h
"

19 
	~"async-thªad.h
"

20 
	~"‰ì-•a˚-ˇche.h
"

21 
	~"qgroup.h
"

22 
	~"¥öt-åì.h
"

23 
	~"dñÆloc-•a˚.h
"

24 
	~"block-group.h
"

25 
	~"backªf.h
"

26 
	~"misc.h
"

27 
	~"sub∑ge.h
"

28 
	~"z⁄ed.h
"

29 
	~"öode-ôem.h
"

30 
	~"•a˚-öfo.h
"

31 
	~"fs.h
"

32 
	~"ac˚ss‹s.h
"

33 
	~"exã¡-åì.h
"

34 
	~"roŸ-åì.h
"

35 
	~"fûe-ôem.h
"

36 
	~"ªloˇti⁄.h
"

37 
	~"su≥r.h
"

38 
	~"åì-checkî.h
"

87 
	#RELOCATION_RESERVED_NODES
 256

	)

91 
	sm≠pög_node
 {

93 
rb_node
 
	mrb_node
;

94 
u64
 
	mbyãƒ
;

96 *
	md©a
;

99 
	sm≠pög_åì
 {

100 
rb_roŸ
 
	mrb_roŸ
;

101 
•ölock_t
 
	mlock
;

107 
	såì_block
 {

109 
rb_node
 
	mrb_node
;

110 
u64
 
	mbyãƒ
;

112 
u64
 
	mow√r
;

113 
båfs_key
 
	mkey
;

114 
	mÀvñ
:8;

115 
	mkey_ªady
:1;

118 
	#MAX_EXTENTS
 128

	)

120 
	sfûe_exã¡_˛u°î
 {

121 
u64
 
	m°¨t
;

122 
u64
 
	míd
;

123 
u64
 
	mbound¨y
[
MAX_EXTENTS
];

124 
	mƒ
;

127 
	sªloc_c⁄åﬁ
 {

129 
båfs_block_group
 *
	mblock_group
;

131 
båfs_roŸ
 *
	mexã¡_roŸ
;

133 
öode
 *
	md©a_öode
;

135 
båfs_block_rsv
 *
	mblock_rsv
;

137 
båfs_backªf_ˇche
 
	mbackªf_ˇche
;

139 
fûe_exã¡_˛u°î
 
	m˛u°î
;

141 
exã¡_io_åì
 
	m¥o˚s£d_blocks
;

143 
m≠pög_åì
 
	mªloc_roŸ_åì
;

145 
li°_hód
 
	mªloc_roŸs
;

147 
li°_hód
 
	mdúty_subvﬁ_roŸs
;

149 
u64
 
	mmîgög_rsv_size
;

151 
u64
 
	mnodes_ªloˇãd
;

153 
u64
 
	mª£rved_byãs
;

155 
u64
 
	m£¨ch_°¨t
;

156 
u64
 
	mexã¡s_found
;

158 
	m°age
:8;

159 
	m¸óã_ªloc_åì
:1;

160 
	mmîge_ªloc_åì
:1;

161 
	mfound_fûe_exã¡
:1;

165 
	#MOVE_DATA_EXTENTS
 0

	)

166 
	#UPDATE_DATA_PTRS
 1

	)

168 
	$m¨k_block_¥o˚s£d
(
ªloc_c⁄åﬁ
 *
rc
,

169 
båfs_backªf_node
 *
node
)

171 
u32
 
blocksize
;

173 i‡(
node
->
Àvñ
 == 0 ||

174 
	`ö_ønge
(
node
->
byãƒ
, 
rc
->
block_group
->
°¨t
,

175 
rc
->
block_group
->
Àngth
)) {

176 
blocksize
 = 
rc
->
exã¡_roŸ
->
fs_öfo
->
nodesize
;

177 
	`£t_exã¡_bô
(&
rc
->
¥o˚s£d_blocks
, 
node
->
byãƒ
,

178 
node
->
byãƒ
 + 
blocksize
 - 1, 
EXTENT_DIRTY
, 
NULL
);

180 
node
->
¥o˚s£d
 = 1;

181 
	}
}

184 
	$m≠pög_åì_öô
(
m≠pög_åì
 *
åì
)

186 
åì
->
rb_roŸ
 = 
RB_ROOT
;

187 
	`•ö_lock_öô
(&
åì
->
lock
);

188 
	}
}

193 
båfs_backªf_node
 *
	$wÆk_up_backªf
(

194 
båfs_backªf_node
 *
node
,

195 
båfs_backªf_edge
 *
edges
[], *
ödex
)

197 
båfs_backªf_edge
 *
edge
;

198 
idx
 = *
ödex
;

200 !
	`li°_em±y
(&
node
->
uµî
)) {

201 
edge
 = 
	`li°_íåy
(
node
->
uµî
.
√xt
,

202 
båfs_backªf_edge
, 
li°
[
LOWER
]);

203 
edges
[
idx
++] = 
edge
;

204 
node
 = 
edge
->node[
UPPER
];

206 
	`BUG_ON
(
node
->
dëached
);

207 *
ödex
 = 
idx
;

208  
node
;

209 
	}
}

214 
båfs_backªf_node
 *
	$wÆk_down_backªf
(

215 
båfs_backªf_edge
 *
edges
[], *
ödex
)

217 
båfs_backªf_edge
 *
edge
;

218 
båfs_backªf_node
 *
lowî
;

219 
idx
 = *
ödex
;

221 
idx
 > 0) {

222 
edge
 = 
edges
[
idx
 - 1];

223 
lowî
 = 
edge
->
node
[
LOWER
];

224 i‡(
	`li°_is_œ°
(&
edge
->
li°
[
LOWER
], &
lowî
->
uµî
)) {

225 
idx
--;

228 
edge
 = 
	`li°_íåy
”dge->
li°
[
LOWER
].
√xt
,

229 
båfs_backªf_edge
, 
li°
[
LOWER
]);

230 
edges
[
idx
 - 1] = 
edge
;

231 *
ödex
 = 
idx
;

232  
edge
->
node
[
UPPER
];

234 *
ödex
 = 0;

235  
NULL
;

236 
	}
}

238 
	$upd©e_backªf_node
(
båfs_backªf_ˇche
 *
ˇche
,

239 
båfs_backªf_node
 *
node
, 
u64
 
byãƒ
)

241 
rb_node
 *rb_node;

242 
	`rb_îa£
(&
node
->
rb_node
, &
ˇche
->
rb_roŸ
);

243 
node
->
byãƒ
 = bytenr;

244 
rb_node
 = 
	`rb_sim∂e_ö£π
(&
ˇche
->
rb_roŸ
, 
node
->
byãƒ
, &node->rb_node);

245 i‡(
rb_node
)

246 
	`båfs_backªf_∑nic
(
ˇche
->
fs_öfo
, 
byãƒ
, -
EEXIST
);

247 
	}
}

252 
	$upd©e_backªf_ˇche
(
båfs_å™s_h™dÀ
 *
å™s
,

253 
båfs_backªf_ˇche
 *
ˇche
)

255 
båfs_backªf_node
 *
node
;

256 
Àvñ
 = 0;

258 i‡(
ˇche
->
œ°_å™s
 == 0) {

259 
ˇche
->
œ°_å™s
 = 
å™s
->
å™sid
;

263 i‡(
ˇche
->
œ°_å™s
 =
å™s
->
å™sid
)

271 !
	`li°_em±y
(&
ˇche
->
dëached
)) {

272 
node
 = 
	`li°_íåy
(
ˇche
->
dëached
.
√xt
,

273 
båfs_backªf_node
, 
li°
);

274 
	`båfs_backªf_˛ónup_node
(
ˇche
, 
node
);

277 !
	`li°_em±y
(&
ˇche
->
ch™ged
)) {

278 
node
 = 
	`li°_íåy
(
ˇche
->
ch™ged
.
√xt
,

279 
båfs_backªf_node
, 
li°
);

280 
	`li°_dñ_öô
(&
node
->
li°
);

281 
	`BUG_ON
(
node
->
≥ndög
);

282 
	`upd©e_backªf_node
(
ˇche
, 
node
,Çode->
√w_byãƒ
);

289 
Àvñ
 = 0;Üevñ < 
BTRFS_MAX_LEVEL
;Üevel++) {

290 
	`li°_f‹_óch_íåy
(
node
, &
ˇche
->
≥ndög
[
Àvñ
], 
li°
) {

291 
	`BUG_ON
(!
node
->
≥ndög
);

292 i‡(
node
->
byãƒ
 =node->
√w_byãƒ
)

294 
	`upd©e_backªf_node
(
ˇche
, 
node
,Çode->
√w_byãƒ
);

298 
ˇche
->
œ°_å™s
 = 0;

300 
	}
}

302 
boﬁ
 
	$ªloc_roŸ_is_dód
(
båfs_roŸ
 *
roŸ
)

309 
	`smp_rmb
();

310 i‡(
	`ã°_bô
(
BTRFS_ROOT_DEAD_RELOC_TREE
, &
roŸ
->
°©e
))

311  
åue
;

312  
Ál£
;

313 
	}
}

323 
boﬁ
 
	$have_ªloc_roŸ
(
båfs_roŸ
 *
roŸ
)

325 i‡(
	`ªloc_roŸ_is_dód
(
roŸ
))

326  
Ál£
;

327 i‡(!
roŸ
->
ªloc_roŸ
)

328  
Ál£
;

329  
åue
;

330 
	}
}

332 
	$båfs_should_ign‹e_ªloc_roŸ
(
båfs_roŸ
 *
roŸ
)

334 
båfs_roŸ
 *
ªloc_roŸ
;

336 i‡(!
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
))

340 i‡(
	`ªloc_roŸ_is_dód
(
roŸ
))

343 
ªloc_roŸ
 = 
roŸ
->reloc_root;

344 i‡(!
ªloc_roŸ
)

347 i‡(
	`båfs_hódî_gíî©i⁄
(
ªloc_roŸ
->
commô_roŸ
) ==

348 
roŸ
->
fs_öfo
->
ru¬ög_å™ß˘i⁄
->
å™sid
)

357 
	}
}

362 
båfs_roŸ
 *
	$föd_ªloc_roŸ
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
byãƒ
)

364 
ªloc_c⁄åﬁ
 *
rc
 = 
fs_öfo
->
ªloc_˘l
;

365 
rb_node
 *rb_node;

366 
m≠pög_node
 *
node
;

367 
båfs_roŸ
 *
roŸ
 = 
NULL
;

369 
	`ASSERT
(
rc
);

370 
	`•ö_lock
(&
rc
->
ªloc_roŸ_åì
.
lock
);

371 
rb_node
 = 
	`rb_sim∂e_£¨ch
(&
rc
->
ªloc_roŸ_åì
.
rb_roŸ
, 
byãƒ
);

372 i‡(
rb_node
) {

373 
node
 = 
	`rb_íåy
(
rb_node
, 
m≠pög_node
,Ñb_node);

374 
roŸ
 = 
node
->
d©a
;

376 
	`•ö_u∆ock
(&
rc
->
ªloc_roŸ_åì
.
lock
);

377  
	`båfs_gøb_roŸ
(
roŸ
);

378 
	}
}

393 
boﬁ
 
	$h™dÀ_u£Àss_nodes
(
ªloc_c⁄åﬁ
 *
rc
,

394 
båfs_backªf_node
 *
node
)

396 
båfs_backªf_ˇche
 *
ˇche
 = &
rc
->
backªf_ˇche
;

397 
li°_hód
 *
u£Àss_node
 = &
ˇche
->useless_node;

398 
boﬁ
 
ªt
 = 
Ál£
;

400 !
	`li°_em±y
(
u£Àss_node
)) {

401 
båfs_backªf_node
 *
cur
;

403 
cur
 = 
	`li°_fú°_íåy
(
u£Àss_node
, 
båfs_backªf_node
,

404 
li°
);

405 
	`li°_dñ_öô
(&
cur
->
li°
);

408 
	`ASSERT
(
	`li°_em±y
(&
cur
->
uµî
));

410 i‡(
cur
 =
node
)

411 
ªt
 = 
åue
;

414 i‡(
cur
->
lowe°
) {

415 
	`li°_dñ_öô
(&
cur
->
lowî
);

416 
cur
->
lowe°
 = 0;

420 !
	`li°_em±y
(&
cur
->
lowî
)) {

421 
båfs_backªf_edge
 *
edge
;

422 
båfs_backªf_node
 *
lowî
;

424 
edge
 = 
	`li°_íåy
(
cur
->
lowî
.
√xt
,

425 
båfs_backªf_edge
, 
li°
[
UPPER
]);

426 
	`li°_dñ
(&
edge
->
li°
[
UPPER
]);

427 
	`li°_dñ
(&
edge
->
li°
[
LOWER
]);

428 
lowî
 = 
edge
->
node
[
LOWER
];

429 
	`båfs_backªf_‰ì_edge
(
ˇche
, 
edge
);

432 i‡(
	`li°_em±y
(&
lowî
->
uµî
))

433 
	`li°_add
(&
lowî
->
li°
, 
u£Àss_node
);

436 
	`m¨k_block_¥o˚s£d
(
rc
, 
cur
);

443 i‡(
cur
->
Àvñ
 > 0) {

444 
	`li°_add
(&
cur
->
li°
, &
ˇche
->
dëached
);

445 
cur
->
dëached
 = 1;

447 
	`rb_îa£
(&
cur
->
rb_node
, &
ˇche
->
rb_roŸ
);

448 
	`båfs_backªf_‰ì_node
(
ˇche
, 
cur
);

451  
ªt
;

452 
	}
}

468 
noölöe_f‹_°ack
 
båfs_backªf_node
 *
	$buûd_backªf_åì
(

469 
båfs_å™s_h™dÀ
 *
å™s
,

470 
ªloc_c⁄åﬁ
 *
rc
, 
båfs_key
 *
node_key
,

471 
Àvñ
, 
u64
 
byãƒ
)

473 
båfs_backªf_ôî
 *
ôî
;

474 
båfs_backªf_ˇche
 *
ˇche
 = &
rc
->
backªf_ˇche
;

476 
båfs_∑th
 *
∑th
;

477 
båfs_backªf_node
 *
cur
;

478 
båfs_backªf_node
 *
node
 = 
NULL
;

479 
båfs_backªf_edge
 *
edge
;

480 
ªt
;

481 
îr
 = 0;

483 
ôî
 = 
	`båfs_backªf_ôî_Æloc
(
rc
->
exã¡_roŸ
->
fs_öfo
);

484 i‡(!
ôî
)

485  
	`ERR_PTR
(-
ENOMEM
);

486 
∑th
 = 
	`båfs_Æloc_∑th
();

487 i‡(!
∑th
) {

488 
îr
 = -
ENOMEM
;

489 
out
;

492 
node
 = 
	`båfs_backªf_Æloc_node
(
ˇche
, 
byãƒ
, 
Àvñ
);

493 i‡(!
node
) {

494 
îr
 = -
ENOMEM
;

495 
out
;

498 
node
->
lowe°
 = 1;

499 
cur
 = 
node
;

503 
ªt
 = 
	`båfs_backªf_add_åì_node
(
å™s
, 
ˇche
, 
∑th
, 
ôî
,

504 
node_key
, 
cur
);

505 i‡(
ªt
 < 0) {

506 
îr
 = 
ªt
;

507 
out
;

509 
edge
 = 
	`li°_fú°_íåy_‹_nuŒ
(&
ˇche
->
≥ndög_edge
,

510 
båfs_backªf_edge
, 
li°
[
UPPER
]);

515 i‡(
edge
) {

516 
	`li°_dñ_öô
(&
edge
->
li°
[
UPPER
]);

517 
cur
 = 
edge
->
node
[
UPPER
];

519 } 
edge
);

522 
ªt
 = 
	`båfs_backªf_föish_uµî_löks
(
ˇche
, 
node
);

523 i‡(
ªt
 < 0) {

524 
îr
 = 
ªt
;

525 
out
;

528 i‡(
	`h™dÀ_u£Àss_nodes
(
rc
, 
node
))

529 
node
 = 
NULL
;

530 
out
:

531 
	`båfs_backªf_ôî_‰ì
(
ôî
);

532 
	`båfs_‰ì_∑th
(
∑th
);

533 i‡(
îr
) {

534 
	`båfs_backªf_îr‹_˛ónup
(
ˇche
, 
node
);

535  
	`ERR_PTR
(
îr
);

537 
	`ASSERT
(!
node
 || !node->
dëached
);

538 
	`ASSERT
(
	`li°_em±y
(&
ˇche
->
u£Àss_node
) &&

539 
	`li°_em±y
(&
ˇche
->
≥ndög_edge
));

540  
node
;

541 
	}
}

548 
	$˛⁄e_backªf_node
(
båfs_å™s_h™dÀ
 *
å™s
,

549 
ªloc_c⁄åﬁ
 *
rc
,

550 
båfs_roŸ
 *
§c
,

551 
båfs_roŸ
 *
de°
)

553 
båfs_roŸ
 *
ªloc_roŸ
 = 
§c
->reloc_root;

554 
båfs_backªf_ˇche
 *
ˇche
 = &
rc
->
backªf_ˇche
;

555 
båfs_backªf_node
 *
node
 = 
NULL
;

556 
båfs_backªf_node
 *
√w_node
;

557 
båfs_backªf_edge
 *
edge
;

558 
båfs_backªf_edge
 *
√w_edge
;

559 
rb_node
 *rb_node;

561 i‡(
ˇche
->
œ°_å™s
 > 0)

562 
	`upd©e_backªf_ˇche
(
å™s
, 
ˇche
);

564 
rb_node
 = 
	`rb_sim∂e_£¨ch
(&
ˇche
->
rb_roŸ
, 
§c
->
commô_roŸ
->
°¨t
);

565 i‡(
rb_node
) {

566 
node
 = 
	`rb_íåy
(
rb_node
, 
båfs_backªf_node
,Ñb_node);

567 i‡(
node
->
dëached
)

568 
node
 = 
NULL
;

570 
	`BUG_ON
(
node
->
√w_byãƒ
 !
ªloc_roŸ
->node->
°¨t
);

573 i‡(!
node
) {

574 
rb_node
 = 
	`rb_sim∂e_£¨ch
(&
ˇche
->
rb_roŸ
,

575 
ªloc_roŸ
->
commô_roŸ
->
°¨t
);

576 i‡(
rb_node
) {

577 
node
 = 
	`rb_íåy
(
rb_node
, 
båfs_backªf_node
,

578 
rb_node
);

579 
	`BUG_ON
(
node
->
dëached
);

583 i‡(!
node
)

586 
√w_node
 = 
	`båfs_backªf_Æloc_node
(
ˇche
, 
de°
->
node
->
°¨t
,

587 
node
->
Àvñ
);

588 i‡(!
√w_node
)

589  -
ENOMEM
;

591 
√w_node
->
lowe°
 = 
node
->lowest;

592 
√w_node
->
checked
 = 1;

593 
√w_node
->
roŸ
 = 
	`båfs_gøb_roŸ
(
de°
);

594 
	`ASSERT
(
√w_node
->
roŸ
);

596 i‡(!
node
->
lowe°
) {

597 
	`li°_f‹_óch_íåy
(
edge
, &
node
->
lowî
, 
li°
[
UPPER
]) {

598 
√w_edge
 = 
	`båfs_backªf_Æloc_edge
(
ˇche
);

599 i‡(!
√w_edge
)

600 
Áû
;

602 
	`båfs_backªf_lök_edge
(
√w_edge
, 
edge
->
node
[
LOWER
],

603 
√w_node
, 
LINK_UPPER
);

606 
	`li°_add_èû
(&
√w_node
->
lowî
, &
ˇche
->
Àaves
);

609 
rb_node
 = 
	`rb_sim∂e_ö£π
(&
ˇche
->
rb_roŸ
, 
√w_node
->
byãƒ
,

610 &
√w_node
->
rb_node
);

611 i‡(
rb_node
)

612 
	`båfs_backªf_∑nic
(
å™s
->
fs_öfo
, 
√w_node
->
byãƒ
, -
EEXIST
);

614 i‡(!
√w_node
->
lowe°
) {

615 
	`li°_f‹_óch_íåy
(
√w_edge
, &
√w_node
->
lowî
, 
li°
[
UPPER
]) {

616 
	`li°_add_èû
(&
√w_edge
->
li°
[
LOWER
],

617 &
√w_edge
->
node
[
LOWER
]->
uµî
);

621 
Áû
:

622 !
	`li°_em±y
(&
√w_node
->
lowî
)) {

623 
√w_edge
 = 
	`li°_íåy
(
√w_node
->
lowî
.
√xt
,

624 
båfs_backªf_edge
, 
li°
[
UPPER
]);

625 
	`li°_dñ
(&
√w_edge
->
li°
[
UPPER
]);

626 
	`båfs_backªf_‰ì_edge
(
ˇche
, 
√w_edge
);

628 
	`båfs_backªf_‰ì_node
(
ˇche
, 
√w_node
);

629  -
ENOMEM
;

630 
	}
}

635 
__mu°_check
 
	$__add_ªloc_roŸ
(
båfs_roŸ
 *
roŸ
)

637 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

638 
rb_node
 *rb_node;

639 
m≠pög_node
 *
node
;

640 
ªloc_c⁄åﬁ
 *
rc
 = 
fs_öfo
->
ªloc_˘l
;

642 
node
 = 
	`kmÆloc
((*node), 
GFP_NOFS
);

643 i‡(!
node
)

644  -
ENOMEM
;

646 
node
->
byãƒ
 = 
roŸ
->
commô_roŸ
->
°¨t
;

647 
node
->
d©a
 = 
roŸ
;

649 
	`•ö_lock
(&
rc
->
ªloc_roŸ_åì
.
lock
);

650 
rb_node
 = 
	`rb_sim∂e_ö£π
(&
rc
->
ªloc_roŸ_åì
.
rb_roŸ
,

651 
node
->
byãƒ
, &node->
rb_node
);

652 
	`•ö_u∆ock
(&
rc
->
ªloc_roŸ_åì
.
lock
);

653 i‡(
rb_node
) {

654 
	`båfs_îr
(
fs_öfo
,

656 
node
->
byãƒ
);

657  -
EEXIST
;

660 
	`li°_add_èû
(&
roŸ
->
roŸ_li°
, &
rc
->
ªloc_roŸs
);

662 
	}
}

668 
	$__dñ_ªloc_roŸ
(
båfs_roŸ
 *
roŸ
)

670 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

671 
rb_node
 *rb_node;

672 
m≠pög_node
 *
node
 = 
NULL
;

673 
ªloc_c⁄åﬁ
 *
rc
 = 
fs_öfo
->
ªloc_˘l
;

674 
boﬁ
 
put_ªf
 = 
Ál£
;

676 i‡(
rc
 && 
roŸ
->
node
) {

677 
	`•ö_lock
(&
rc
->
ªloc_roŸ_åì
.
lock
);

678 
rb_node
 = 
	`rb_sim∂e_£¨ch
(&
rc
->
ªloc_roŸ_åì
.
rb_roŸ
,

679 
roŸ
->
commô_roŸ
->
°¨t
);

680 i‡(
rb_node
) {

681 
node
 = 
	`rb_íåy
(
rb_node
, 
m≠pög_node
,Ñb_node);

682 
	`rb_îa£
(&
node
->
rb_node
, &
rc
->
ªloc_roŸ_åì
.
rb_roŸ
);

683 
	`RB_CLEAR_NODE
(&
node
->
rb_node
);

685 
	`•ö_u∆ock
(&
rc
->
ªloc_roŸ_åì
.
lock
);

686 
	`ASSERT
(!
node
 || (
båfs_roŸ
 *Íode->
d©a
 =
roŸ
);

697 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

698 i‡(!
	`li°_em±y
(&
roŸ
->
roŸ_li°
)) {

699 
put_ªf
 = 
åue
;

700 
	`li°_dñ_öô
(&
roŸ
->
roŸ_li°
);

702 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

703 i‡(
put_ªf
)

704 
	`båfs_put_roŸ
(
roŸ
);

705 
	`k‰ì
(
node
);

706 
	}
}

712 
	$__upd©e_ªloc_roŸ
(
båfs_roŸ
 *
roŸ
)

714 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

715 
rb_node
 *rb_node;

716 
m≠pög_node
 *
node
 = 
NULL
;

717 
ªloc_c⁄åﬁ
 *
rc
 = 
fs_öfo
->
ªloc_˘l
;

719 
	`•ö_lock
(&
rc
->
ªloc_roŸ_åì
.
lock
);

720 
rb_node
 = 
	`rb_sim∂e_£¨ch
(&
rc
->
ªloc_roŸ_åì
.
rb_roŸ
,

721 
roŸ
->
commô_roŸ
->
°¨t
);

722 i‡(
rb_node
) {

723 
node
 = 
	`rb_íåy
(
rb_node
, 
m≠pög_node
,Ñb_node);

724 
	`rb_îa£
(&
node
->
rb_node
, &
rc
->
ªloc_roŸ_åì
.
rb_roŸ
);

726 
	`•ö_u∆ock
(&
rc
->
ªloc_roŸ_åì
.
lock
);

728 i‡(!
node
)

730 
	`BUG_ON
((
båfs_roŸ
 *)
node
->
d©a
 !
roŸ
);

732 
	`•ö_lock
(&
rc
->
ªloc_roŸ_åì
.
lock
);

733 
node
->
byãƒ
 = 
roŸ
->node->
°¨t
;

734 
rb_node
 = 
	`rb_sim∂e_ö£π
(&
rc
->
ªloc_roŸ_åì
.
rb_roŸ
,

735 
node
->
byãƒ
, &node->
rb_node
);

736 
	`•ö_u∆ock
(&
rc
->
ªloc_roŸ_åì
.
lock
);

737 i‡(
rb_node
)

738 
	`båfs_backªf_∑nic
(
fs_öfo
, 
node
->
byãƒ
, -
EEXIST
);

740 
	}
}

742 
båfs_roŸ
 *
	$¸óã_ªloc_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

743 
båfs_roŸ
 *
roŸ
, 
u64
 
obje˘id
)

745 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

746 
båfs_roŸ
 *
ªloc_roŸ
;

747 
exã¡_buf„r
 *
eb
;

748 
båfs_roŸ_ôem
 *
roŸ_ôem
;

749 
båfs_key
 
roŸ_key
;

750 
ªt
 = 0;

751 
boﬁ
 
mu°_ab‹t
 = 
Ál£
;

753 
roŸ_ôem
 = 
	`kmÆloc
((*roŸ_ôem), 
GFP_NOFS
);

754 i‡(!
roŸ_ôem
)

755  
	`ERR_PTR
(-
ENOMEM
);

757 
roŸ_key
.
obje˘id
 = 
BTRFS_TREE_RELOC_OBJECTID
;

758 
roŸ_key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

759 
roŸ_key
.
off£t
 = 
obje˘id
;

761 i‡(
roŸ
->
roŸ_key
.
obje˘id
 == objectid) {

762 
u64
 
commô_roŸ_gí
;

765 
ªt
 = 
	`båfs_c›y_roŸ
(
å™s
, 
roŸ
,ÑoŸ->
commô_roŸ
, &
eb
,

766 
BTRFS_TREE_RELOC_OBJECTID
);

767 i‡(
ªt
)

768 
Áû
;

778 
commô_roŸ_gí
 = 
	`båfs_hódî_gíî©i⁄
(
roŸ
->
commô_roŸ
);

779 
	`båfs_£t_roŸ_œ°_¢≠shŸ
(&
roŸ
->
roŸ_ôem
, 
commô_roŸ_gí
);

788 
ªt
 = 
	`båfs_c›y_roŸ
(
å™s
, 
roŸ
,ÑoŸ->
node
, &
eb
,

789 
BTRFS_TREE_RELOC_OBJECTID
);

790 i‡(
ªt
)

791 
Áû
;

798 
mu°_ab‹t
 = 
åue
;

800 
	`mem˝y
(
roŸ_ôem
, &
roŸ
->root_item, (*root_item));

801 
	`båfs_£t_roŸ_byãƒ
(
roŸ_ôem
, 
eb
->
°¨t
);

802 
	`båfs_£t_roŸ_Àvñ
(
roŸ_ôem
, 
	`båfs_hódî_Àvñ
(
eb
));

803 
	`båfs_£t_roŸ_gíî©i⁄
(
roŸ_ôem
, 
å™s
->
å™sid
);

805 i‡(
roŸ
->
roŸ_key
.
obje˘id
 == objectid) {

806 
	`båfs_£t_roŸ_ªfs
(
roŸ_ôem
, 0);

807 
	`mem£t
(&
roŸ_ôem
->
dr›_¥ogªss
, 0,

808 (
båfs_disk_key
));

809 
	`båfs_£t_roŸ_dr›_Àvñ
(
roŸ_ôem
, 0);

812 
	`båfs_åì_u∆ock
(
eb
);

813 
	`‰ì_exã¡_buf„r
(
eb
);

815 
ªt
 = 
	`båfs_ö£π_roŸ
(
å™s
, 
fs_öfo
->
åì_roŸ
,

816 &
roŸ_key
, 
roŸ_ôem
);

817 i‡(
ªt
)

818 
Áû
;

820 
	`k‰ì
(
roŸ_ôem
);

822 
ªloc_roŸ
 = 
	`båfs_ªad_åì_roŸ
(
fs_öfo
->
åì_roŸ
, &
roŸ_key
);

823 i‡(
	`IS_ERR
(
ªloc_roŸ
)) {

824 
ªt
 = 
	`PTR_ERR
(
ªloc_roŸ
);

825 
ab‹t
;

827 
	`£t_bô
(
BTRFS_ROOT_SHAREABLE
, &
ªloc_roŸ
->
°©e
);

828 
ªloc_roŸ
->
œ°_å™s
 = 
å™s
->
å™sid
;

829  
ªloc_roŸ
;

830 
Áû
:

831 
	`k‰ì
(
roŸ_ôem
);

832 
ab‹t
:

833 i‡(
mu°_ab‹t
)

834 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

835  
	`ERR_PTR
(
ªt
);

836 
	}
}

845 
	$båfs_öô_ªloc_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

846 
båfs_roŸ
 *
roŸ
)

848 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

849 
båfs_roŸ
 *
ªloc_roŸ
;

850 
ªloc_c⁄åﬁ
 *
rc
 = 
fs_öfo
->
ªloc_˘l
;

851 
båfs_block_rsv
 *
rsv
;

852 
˛ór_rsv
 = 0;

853 
ªt
;

855 i‡(!
rc
)

862 i‡(
	`ªloc_roŸ_is_dód
(
roŸ
))

873 i‡(
roŸ
->
ªloc_roŸ
) {

874 
ªloc_roŸ
 = 
roŸ
->reloc_root;

875 
ªloc_roŸ
->
œ°_å™s
 = 
å™s
->
å™sid
;

883 i‡(!
rc
->
¸óã_ªloc_åì
 ||

884 
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
)

887 i‡(!
å™s
->
ªloc_ª£rved
) {

888 
rsv
 = 
å™s
->
block_rsv
;

889 
å™s
->
block_rsv
 = 
rc
->block_rsv;

890 
˛ór_rsv
 = 1;

892 
ªloc_roŸ
 = 
	`¸óã_ªloc_roŸ
(
å™s
, 
roŸ
,ÑoŸ->
roŸ_key
.
obje˘id
);

893 i‡(
˛ór_rsv
)

894 
å™s
->
block_rsv
 = 
rsv
;

895 i‡(
	`IS_ERR
(
ªloc_roŸ
))

896  
	`PTR_ERR
(
ªloc_roŸ
);

898 
ªt
 = 
	`__add_ªloc_roŸ
(
ªloc_roŸ
);

899 
	`ASSERT
(
ªt
 !-
EEXIST
);

900 i‡(
ªt
) {

902 
	`båfs_put_roŸ
(
ªloc_roŸ
);

903  
ªt
;

905 
roŸ
->
ªloc_roŸ
 = 
	`båfs_gøb_roŸ
(reloc_root);

907 
	}
}

912 
	$båfs_upd©e_ªloc_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

913 
båfs_roŸ
 *
roŸ
)

915 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

916 
båfs_roŸ
 *
ªloc_roŸ
;

917 
båfs_roŸ_ôem
 *
roŸ_ôem
;

918 
ªt
;

920 i‡(!
	`have_ªloc_roŸ
(
roŸ
))

923 
ªloc_roŸ
 = 
roŸ
->reloc_root;

924 
roŸ_ôem
 = &
ªloc_roŸ
->root_item;

931 
	`båfs_gøb_roŸ
(
ªloc_roŸ
);

934 i‡(
fs_öfo
->
ªloc_˘l
->
mîge_ªloc_åì
 &&

935 
	`båfs_roŸ_ªfs
(
roŸ_ôem
) == 0) {

936 
	`£t_bô
(
BTRFS_ROOT_DEAD_RELOC_TREE
, &
roŸ
->
°©e
);

941 
	`smp_wmb
();

942 
	`__dñ_ªloc_roŸ
(
ªloc_roŸ
);

945 i‡(
ªloc_roŸ
->
commô_roŸ
 !ªloc_roŸ->
node
) {

946 
	`__upd©e_ªloc_roŸ
(
ªloc_roŸ
);

947 
	`båfs_£t_roŸ_node
(
roŸ_ôem
, 
ªloc_roŸ
->
node
);

948 
	`‰ì_exã¡_buf„r
(
ªloc_roŸ
->
commô_roŸ
);

949 
ªloc_roŸ
->
commô_roŸ
 = 
	`båfs_roŸ_node
(reloc_root);

952 
ªt
 = 
	`båfs_upd©e_roŸ
(
å™s
, 
fs_öfo
->
åì_roŸ
,

953 &
ªloc_roŸ
->
roŸ_key
, 
roŸ_ôem
);

954 
	`båfs_put_roŸ
(
ªloc_roŸ
);

955  
ªt
;

956 
	}
}

962 
öode
 *
	$föd_√xt_öode
(
båfs_roŸ
 *
roŸ
, 
u64
 
obje˘id
)

964 
rb_node
 *
node
;

965 
rb_node
 *
¥ev
;

966 
båfs_öode
 *
íåy
;

967 
öode
 *inode;

969 
	`•ö_lock
(&
roŸ
->
öode_lock
);

970 
agaö
:

971 
node
 = 
roŸ
->
öode_åì
.
rb_node
;

972 
¥ev
 = 
NULL
;

973 
node
) {

974 
¥ev
 = 
node
;

975 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_öode
, 
rb_node
);

977 i‡(
obje˘id
 < 
	`båfs_öo
(
íåy
))

978 
node
 =Çode->
rb_À·
;

979 i‡(
obje˘id
 > 
	`båfs_öo
(
íåy
))

980 
node
 =Çode->
rb_right
;

984 i‡(!
node
) {

985 
¥ev
) {

986 
íåy
 = 
	`rb_íåy
(
¥ev
, 
båfs_öode
, 
rb_node
);

987 i‡(
obje˘id
 <
	`båfs_öo
(
íåy
)) {

988 
node
 = 
¥ev
;

991 
¥ev
 = 
	`rb_√xt
(prev);

994 
node
) {

995 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_öode
, 
rb_node
);

996 
öode
 = 
	`igøb
(&
íåy
->
vfs_öode
);

997 i‡(
öode
) {

998 
	`•ö_u∆ock
(&
roŸ
->
öode_lock
);

999  
öode
;

1002 
obje˘id
 = 
	`båfs_öo
(
íåy
) + 1;

1003 i‡(
	`c⁄d_ªsched_lock
(&
roŸ
->
öode_lock
))

1004 
agaö
;

1006 
node
 = 
	`rb_√xt
(node);

1008 
	`•ö_u∆ock
(&
roŸ
->
öode_lock
);

1009  
NULL
;

1010 
	}
}

1015 
	$gë_√w_loˇti⁄
(
öode
 *
ªloc_öode
, 
u64
 *
√w_byãƒ
,

1016 
u64
 
byãƒ
, u64 
num_byãs
)

1018 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
ªloc_öode
)->root;

1019 
båfs_∑th
 *
∑th
;

1020 
båfs_fûe_exã¡_ôem
 *
fi
;

1021 
exã¡_buf„r
 *
Àaf
;

1022 
ªt
;

1024 
∑th
 = 
	`båfs_Æloc_∑th
();

1025 i‡(!
∑th
)

1026  -
ENOMEM
;

1028 
byãƒ
 -
	`BTRFS_I
(
ªloc_öode
)->
ödex_˙t
;

1029 
ªt
 = 
	`båfs_lookup_fûe_exã¡
(
NULL
, 
roŸ
, 
∑th
,

1030 
	`båfs_öo
(
	`BTRFS_I
(
ªloc_öode
)), 
byãƒ
, 0);

1031 i‡(
ªt
 < 0)

1032 
out
;

1033 i‡(
ªt
 > 0) {

1034 
ªt
 = -
ENOENT
;

1035 
out
;

1038 
Àaf
 = 
∑th
->
nodes
[0];

1039 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

1040 
båfs_fûe_exã¡_ôem
);

1042 
	`BUG_ON
(
	`båfs_fûe_exã¡_off£t
(
Àaf
, 
fi
) ||

1043 
	`båfs_fûe_exã¡_com¥essi⁄
(
Àaf
, 
fi
) ||

1044 
	`båfs_fûe_exã¡_í¸y±i⁄
(
Àaf
, 
fi
) ||

1045 
	`båfs_fûe_exã¡_Ÿhî_ícodög
(
Àaf
, 
fi
));

1047 i‡(
num_byãs
 !
	`båfs_fûe_exã¡_disk_num_byãs
(
Àaf
, 
fi
)) {

1048 
ªt
 = -
EINVAL
;

1049 
out
;

1052 *
√w_byãƒ
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
fi
);

1053 
ªt
 = 0;

1054 
out
:

1055 
	`båfs_‰ì_∑th
(
∑th
);

1056  
ªt
;

1057 
	}
}

1063 
noölöe_f‹_°ack


1064 
	$ª∂a˚_fûe_exã¡s
(
båfs_å™s_h™dÀ
 *
å™s
,

1065 
ªloc_c⁄åﬁ
 *
rc
,

1066 
båfs_roŸ
 *
roŸ
,

1067 
exã¡_buf„r
 *
Àaf
)

1069 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1070 
båfs_key
 
key
;

1071 
båfs_fûe_exã¡_ôem
 *
fi
;

1072 
öode
 *öodê
NULL
;

1073 
u64
 
∑ª¡
;

1074 
u64
 
byãƒ
;

1075 
u64
 
√w_byãƒ
 = 0;

1076 
u64
 
num_byãs
;

1077 
u64
 
íd
;

1078 
u32
 
ƒôems
;

1079 
u32
 
i
;

1080 
ªt
 = 0;

1081 
fú°
 = 1;

1082 
dúty
 = 0;

1084 i‡(
rc
->
°age
 !
UPDATE_DATA_PTRS
)

1088 i‡(
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
)

1089 
∑ª¡
 = 
Àaf
->
°¨t
;

1091 
∑ª¡
 = 0;

1093 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

1094 
i
 = 0; i < 
ƒôems
; i++) {

1095 
båfs_ªf
 
ªf
 = { 0 };

1097 
	`c⁄d_ªsched
();

1098 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
i
);

1099 i‡(
key
.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

1101 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
i
, 
båfs_fûe_exã¡_ôem
);

1102 i‡(
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
fi
) ==

1103 
BTRFS_FILE_EXTENT_INLINE
)

1105 
byãƒ
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
fi
);

1106 
num_byãs
 = 
	`båfs_fûe_exã¡_disk_num_byãs
(
Àaf
, 
fi
);

1107 i‡(
byãƒ
 == 0)

1109 i‡(!
	`ö_ønge
(
byãƒ
, 
rc
->
block_group
->
°¨t
,

1110 
rc
->
block_group
->
Àngth
))

1117 i‡(
roŸ
->
roŸ_key
.
obje˘id
 !
BTRFS_TREE_RELOC_OBJECTID
) {

1118 i‡(
fú°
) {

1119 
öode
 = 
	`föd_√xt_öode
(
roŸ
, 
key
.
obje˘id
);

1120 
fú°
 = 0;

1121 } i‡(
öode
 && 
	`båfs_öo
(
	`BTRFS_I
(öode)Ë< 
key
.
obje˘id
) {

1122 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
öode
));

1123 
öode
 = 
	`föd_√xt_öode
(
roŸ
, 
key
.
obje˘id
);

1125 i‡(
öode
 && 
	`båfs_öo
(
	`BTRFS_I
(öode)Ë=
key
.
obje˘id
) {

1126 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

1128 
íd
 = 
key
.
off£t
 +

1129 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
fi
);

1130 
	`WARN_ON
(!
	`IS_ALIGNED
(
key
.
off£t
,

1131 
fs_öfo
->
£˘‹size
));

1132 
	`WARN_ON
(!
	`IS_ALIGNED
(
íd
, 
fs_öfo
->
£˘‹size
));

1133 
íd
--;

1134 
ªt
 = 
	`åy_lock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
,

1135 
key
.
off£t
, 
íd
,

1136 &
ˇched_°©e
);

1137 i‡(!
ªt
)

1140 
	`båfs_dr›_exã¡_m≠_ønge
(
	`BTRFS_I
(
öode
),

1141 
key
.
off£t
, 
íd
, 
åue
);

1142 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
,

1143 
key
.
off£t
, 
íd
, &
ˇched_°©e
);

1147 
ªt
 = 
	`gë_√w_loˇti⁄
(
rc
->
d©a_öode
, &
√w_byãƒ
,

1148 
byãƒ
, 
num_byãs
);

1149 i‡(
ªt
) {

1157 
	`båfs_£t_fûe_exã¡_disk_byãƒ
(
Àaf
, 
fi
, 
√w_byãƒ
);

1158 
dúty
 = 1;

1160 
key
.
off£t
 -
	`båfs_fûe_exã¡_off£t
(
Àaf
, 
fi
);

1161 
	`båfs_öô_gíîic_ªf
(&
ªf
, 
BTRFS_ADD_DELAYED_REF
, 
√w_byãƒ
,

1162 
num_byãs
, 
∑ª¡
);

1163 
	`båfs_öô_d©a_ªf
(&
ªf
, 
	`båfs_hódî_ow√r
(
Àaf
),

1164 
key
.
obje˘id
, key.
off£t
,

1165 
roŸ
->
roŸ_key
.
obje˘id
, 
Ál£
);

1166 
ªt
 = 
	`båfs_öc_exã¡_ªf
(
å™s
, &
ªf
);

1167 i‡(
ªt
) {

1168 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1172 
	`båfs_öô_gíîic_ªf
(&
ªf
, 
BTRFS_DROP_DELAYED_REF
, 
byãƒ
,

1173 
num_byãs
, 
∑ª¡
);

1174 
	`båfs_öô_d©a_ªf
(&
ªf
, 
	`båfs_hódî_ow√r
(
Àaf
),

1175 
key
.
obje˘id
, key.
off£t
,

1176 
roŸ
->
roŸ_key
.
obje˘id
, 
Ál£
);

1177 
ªt
 = 
	`båfs_‰ì_exã¡
(
å™s
, &
ªf
);

1178 i‡(
ªt
) {

1179 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1183 i‡(
dúty
)

1184 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

1185 i‡(
öode
)

1186 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
öode
));

1187  
ªt
;

1188 
	}
}

1190 
noölöe_f‹_°ack


1191 
	$memcmp_node_keys
(
exã¡_buf„r
 *
eb
, 
¶Ÿ
,

1192 
båfs_∑th
 *
∑th
, 
Àvñ
)

1194 
båfs_disk_key
 
key1
;

1195 
båfs_disk_key
 
key2
;

1196 
	`båfs_node_key
(
eb
, &
key1
, 
¶Ÿ
);

1197 
	`båfs_node_key
(
∑th
->
nodes
[
Àvñ
], &
key2
,Ö©h->
¶Ÿs
[level]);

1198  
	`memcmp
(&
key1
, &
key2
, (key1));

1199 
	}
}

1210 
noölöe_f‹_°ack


1211 
	$ª∂a˚_∑th
(
båfs_å™s_h™dÀ
 *
å™s
, 
ªloc_c⁄åﬁ
 *
rc
,

1212 
båfs_roŸ
 *
de°
, båfs_roŸ *
§c
,

1213 
båfs_∑th
 *
∑th
, 
båfs_key
 *
√xt_key
,

1214 
lowe°_Àvñ
, 
max_Àvñ
)

1216 
båfs_fs_öfo
 *
fs_öfo
 = 
de°
->fs_info;

1217 
exã¡_buf„r
 *
eb
;

1218 
exã¡_buf„r
 *
∑ª¡
;

1219 
båfs_ªf
 
ªf
 = { 0 };

1220 
båfs_key
 
key
;

1221 
u64
 
ﬁd_byãƒ
;

1222 
u64
 
√w_byãƒ
;

1223 
u64
 
ﬁd_±r_gí
;

1224 
u64
 
√w_±r_gí
;

1225 
u64
 
œ°_¢≠shŸ
;

1226 
u32
 
blocksize
;

1227 
cow
 = 0;

1228 
Àvñ
;

1229 
ªt
;

1230 
¶Ÿ
;

1232 
	`ASSERT
(
§c
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
);

1233 
	`ASSERT
(
de°
->
roŸ_key
.
obje˘id
 !
BTRFS_TREE_RELOC_OBJECTID
);

1235 
œ°_¢≠shŸ
 = 
	`båfs_roŸ_œ°_¢≠shŸ
(&
§c
->
roŸ_ôem
);

1236 
agaö
:

1237 
¶Ÿ
 = 
∑th
->
¶Ÿs
[
lowe°_Àvñ
];

1238 
	`båfs_node_key_to_˝u
(
∑th
->
nodes
[
lowe°_Àvñ
], &
key
, 
¶Ÿ
);

1240 
eb
 = 
	`båfs_lock_roŸ_node
(
de°
);

1241 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
eb
);

1243 i‡(
Àvñ
 < 
lowe°_Àvñ
) {

1244 
	`båfs_åì_u∆ock
(
eb
);

1245 
	`‰ì_exã¡_buf„r
(
eb
);

1249 i‡(
cow
) {

1250 
ªt
 = 
	`båfs_cow_block
(
å™s
, 
de°
, 
eb
, 
NULL
, 0, &eb,

1251 
BTRFS_NESTING_COW
);

1252 i‡(
ªt
) {

1253 
	`båfs_åì_u∆ock
(
eb
);

1254 
	`‰ì_exã¡_buf„r
(
eb
);

1255  
ªt
;

1259 i‡(
√xt_key
) {

1260 
√xt_key
->
obje˘id
 = (
u64
)-1;

1261 
√xt_key
->
ty≥
 = (
u8
)-1;

1262 
√xt_key
->
off£t
 = (
u64
)-1;

1265 
∑ª¡
 = 
eb
;

1267 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
∑ª¡
);

1268 
	`ASSERT
(
Àvñ
 >
lowe°_Àvñ
);

1270 
ªt
 = 
	`båfs_bö_£¨ch
(
∑ª¡
, 0, &
key
, &
¶Ÿ
);

1271 i‡(
ªt
 < 0)

1273 i‡(
ªt
 && 
¶Ÿ
 > 0)

1274 
¶Ÿ
--;

1276 i‡(
√xt_key
 && 
¶Ÿ
 + 1 < 
	`båfs_hódî_ƒôems
(
∑ª¡
))

1277 
	`båfs_node_key_to_˝u
(
∑ª¡
, 
√xt_key
, 
¶Ÿ
 + 1);

1279 
ﬁd_byãƒ
 = 
	`båfs_node_block±r
(
∑ª¡
, 
¶Ÿ
);

1280 
blocksize
 = 
fs_öfo
->
nodesize
;

1281 
ﬁd_±r_gí
 = 
	`båfs_node_±r_gíî©i⁄
(
∑ª¡
, 
¶Ÿ
);

1283 i‡(
Àvñ
 <
max_Àvñ
) {

1284 
eb
 = 
∑th
->
nodes
[
Àvñ
];

1285 
√w_byãƒ
 = 
	`båfs_node_block±r
(
eb
,

1286 
∑th
->
¶Ÿs
[
Àvñ
]);

1287 
√w_±r_gí
 = 
	`båfs_node_±r_gíî©i⁄
(
eb
,

1288 
∑th
->
¶Ÿs
[
Àvñ
]);

1290 
√w_byãƒ
 = 0;

1291 
√w_±r_gí
 = 0;

1294 i‡(
	`WARN_ON
(
√w_byãƒ
 > 0 &&Çew_byãƒ =
ﬁd_byãƒ
)) {

1295 
ªt
 = 
Àvñ
;

1299 i‡(
√w_byãƒ
 =0 || 
ﬁd_±r_gí
 > 
œ°_¢≠shŸ
 ||

1300 
	`memcmp_node_keys
(
∑ª¡
, 
¶Ÿ
, 
∑th
, 
Àvñ
)) {

1301 i‡(
Àvñ
 <
lowe°_Àvñ
) {

1302 
ªt
 = 0;

1306 
eb
 = 
	`båfs_ªad_node_¶Ÿ
(
∑ª¡
, 
¶Ÿ
);

1307 i‡(
	`IS_ERR
(
eb
)) {

1308 
ªt
 = 
	`PTR_ERR
(
eb
);

1311 
	`båfs_åì_lock
(
eb
);

1312 i‡(
cow
) {

1313 
ªt
 = 
	`båfs_cow_block
(
å™s
, 
de°
, 
eb
, 
∑ª¡
,

1314 
¶Ÿ
, &
eb
,

1315 
BTRFS_NESTING_COW
);

1316 i‡(
ªt
) {

1317 
	`båfs_åì_u∆ock
(
eb
);

1318 
	`‰ì_exã¡_buf„r
(
eb
);

1323 
	`båfs_åì_u∆ock
(
∑ª¡
);

1324 
	`‰ì_exã¡_buf„r
(
∑ª¡
);

1326 
∑ª¡
 = 
eb
;

1330 i‡(!
cow
) {

1331 
	`båfs_åì_u∆ock
(
∑ª¡
);

1332 
	`‰ì_exã¡_buf„r
(
∑ª¡
);

1333 
cow
 = 1;

1334 
agaö
;

1337 
	`båfs_node_key_to_˝u
(
∑th
->
nodes
[
Àvñ
], &
key
,

1338 
∑th
->
¶Ÿs
[
Àvñ
]);

1339 
	`båfs_ªÀa£_∑th
(
∑th
);

1341 
∑th
->
lowe°_Àvñ
 = 
Àvñ
;

1342 
	`£t_bô
(
BTRFS_ROOT_RESET_LOCKDEP_CLASS
, &
§c
->
°©e
);

1343 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
§c
, &
key
, 
∑th
, 0, 1);

1344 
	`˛ór_bô
(
BTRFS_ROOT_RESET_LOCKDEP_CLASS
, &
§c
->
°©e
);

1345 
∑th
->
lowe°_Àvñ
 = 0;

1346 i‡(
ªt
) {

1347 i‡(
ªt
 > 0)

1348 
ªt
 = -
ENOENT
;

1366 
ªt
 = 
	`båfs_qgroup_add_sw≠≥d_blocks
(
å™s
, 
de°
,

1367 
rc
->
block_group
, 
∑ª¡
, 
¶Ÿ
,

1368 
∑th
->
nodes
[
Àvñ
],Ö©h->
¶Ÿs
[level],

1369 
œ°_¢≠shŸ
);

1370 i‡(
ªt
 < 0)

1375 
	`båfs_£t_node_block±r
(
∑ª¡
, 
¶Ÿ
, 
√w_byãƒ
);

1376 
	`båfs_£t_node_±r_gíî©i⁄
(
∑ª¡
, 
¶Ÿ
, 
√w_±r_gí
);

1377 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑ª¡
);

1379 
	`båfs_£t_node_block±r
(
∑th
->
nodes
[
Àvñ
],

1380 
∑th
->
¶Ÿs
[
Àvñ
], 
ﬁd_byãƒ
);

1381 
	`båfs_£t_node_±r_gíî©i⁄
(
∑th
->
nodes
[
Àvñ
],

1382 
∑th
->
¶Ÿs
[
Àvñ
], 
ﬁd_±r_gí
);

1383 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑th
->
nodes
[
Àvñ
]);

1385 
	`båfs_öô_gíîic_ªf
(&
ªf
, 
BTRFS_ADD_DELAYED_REF
, 
ﬁd_byãƒ
,

1386 
blocksize
, 
∑th
->
nodes
[
Àvñ
]->
°¨t
);

1387 
	`båfs_öô_åì_ªf
(&
ªf
, 
Àvñ
 - 1, 
§c
->
roŸ_key
.
obje˘id
,

1388 0, 
åue
);

1389 
ªt
 = 
	`båfs_öc_exã¡_ªf
(
å™s
, &
ªf
);

1390 i‡(
ªt
) {

1391 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1394 
	`båfs_öô_gíîic_ªf
(&
ªf
, 
BTRFS_ADD_DELAYED_REF
, 
√w_byãƒ
,

1395 
blocksize
, 0);

1396 
	`båfs_öô_åì_ªf
(&
ªf
, 
Àvñ
 - 1, 
de°
->
roŸ_key
.
obje˘id
, 0,

1397 
åue
);

1398 
ªt
 = 
	`båfs_öc_exã¡_ªf
(
å™s
, &
ªf
);

1399 i‡(
ªt
) {

1400 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1404 
	`båfs_öô_gíîic_ªf
(&
ªf
, 
BTRFS_DROP_DELAYED_REF
, 
√w_byãƒ
,

1405 
blocksize
, 
∑th
->
nodes
[
Àvñ
]->
°¨t
);

1406 
	`båfs_öô_åì_ªf
(&
ªf
, 
Àvñ
 - 1, 
§c
->
roŸ_key
.
obje˘id
,

1407 0, 
åue
);

1408 
ªt
 = 
	`båfs_‰ì_exã¡
(
å™s
, &
ªf
);

1409 i‡(
ªt
) {

1410 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1414 
	`båfs_öô_gíîic_ªf
(&
ªf
, 
BTRFS_DROP_DELAYED_REF
, 
ﬁd_byãƒ
,

1415 
blocksize
, 0);

1416 
	`båfs_öô_åì_ªf
(&
ªf
, 
Àvñ
 - 1, 
de°
->
roŸ_key
.
obje˘id
,

1417 0, 
åue
);

1418 
ªt
 = 
	`båfs_‰ì_exã¡
(
å™s
, &
ªf
);

1419 i‡(
ªt
) {

1420 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1424 
	`båfs_u∆ock_up_ß„
(
∑th
, 0);

1426 
ªt
 = 
Àvñ
;

1429 
	`båfs_åì_u∆ock
(
∑ª¡
);

1430 
	`‰ì_exã¡_buf„r
(
∑ª¡
);

1431  
ªt
;

1432 
	}
}

1437 
noölöe_f‹_°ack


1438 
	$wÆk_up_ªloc_åì
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
,

1439 *
Àvñ
)

1441 
exã¡_buf„r
 *
eb
;

1442 
i
;

1443 
u64
 
œ°_¢≠shŸ
;

1444 
u32
 
ƒôems
;

1446 
œ°_¢≠shŸ
 = 
	`båfs_roŸ_œ°_¢≠shŸ
(&
roŸ
->
roŸ_ôem
);

1448 
i
 = 0; i < *
Àvñ
; i++) {

1449 
	`‰ì_exã¡_buf„r
(
∑th
->
nodes
[
i
]);

1450 
∑th
->
nodes
[
i
] = 
NULL
;

1453 
i
 = *
Àvñ
; i < 
BTRFS_MAX_LEVEL
 && 
∑th
->
nodes
[i]; i++) {

1454 
eb
 = 
∑th
->
nodes
[
i
];

1455 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
eb
);

1456 
∑th
->
¶Ÿs
[
i
] + 1 < 
ƒôems
) {

1457 
∑th
->
¶Ÿs
[
i
]++;

1458 i‡(
	`båfs_node_±r_gíî©i⁄
(
eb
, 
∑th
->
¶Ÿs
[
i
]) <=

1459 
œ°_¢≠shŸ
)

1462 *
Àvñ
 = 
i
;

1465 
	`‰ì_exã¡_buf„r
(
∑th
->
nodes
[
i
]);

1466 
∑th
->
nodes
[
i
] = 
NULL
;

1469 
	}
}

1474 
noölöe_f‹_°ack


1475 
	$wÆk_down_ªloc_åì
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
,

1476 *
Àvñ
)

1478 
exã¡_buf„r
 *
eb
 = 
NULL
;

1479 
i
;

1480 
u64
 
±r_gí
 = 0;

1481 
u64
 
œ°_¢≠shŸ
;

1482 
u32
 
ƒôems
;

1484 
œ°_¢≠shŸ
 = 
	`båfs_roŸ_œ°_¢≠shŸ
(&
roŸ
->
roŸ_ôem
);

1486 
i
 = *
Àvñ
; i > 0; i--) {

1487 
eb
 = 
∑th
->
nodes
[
i
];

1488 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
eb
);

1489 
∑th
->
¶Ÿs
[
i
] < 
ƒôems
) {

1490 
±r_gí
 = 
	`båfs_node_±r_gíî©i⁄
(
eb
, 
∑th
->
¶Ÿs
[
i
]);

1491 i‡(
±r_gí
 > 
œ°_¢≠shŸ
)

1493 
∑th
->
¶Ÿs
[
i
]++;

1495 i‡(
∑th
->
¶Ÿs
[
i
] >
ƒôems
) {

1496 i‡(
i
 =*
Àvñ
)

1498 *
Àvñ
 = 
i
 + 1;

1501 i‡(
i
 == 1) {

1502 *
Àvñ
 = 
i
;

1506 
eb
 = 
	`båfs_ªad_node_¶Ÿ
”b, 
∑th
->
¶Ÿs
[
i
]);

1507 i‡(
	`IS_ERR
(
eb
))

1508  
	`PTR_ERR
(
eb
);

1509 
	`BUG_ON
(
	`båfs_hódî_Àvñ
(
eb
Ë!
i
 - 1);

1510 
∑th
->
nodes
[
i
 - 1] = 
eb
;

1511 
∑th
->
¶Ÿs
[
i
 - 1] = 0;

1514 
	}
}

1520 
	$övÆid©e_exã¡_ˇche
(
båfs_roŸ
 *
roŸ
,

1521 
båfs_key
 *
mö_key
,

1522 
båfs_key
 *
max_key
)

1524 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1525 
öode
 *öodê
NULL
;

1526 
u64
 
obje˘id
;

1527 
u64
 
°¨t
, 
íd
;

1528 
u64
 
öo
;

1530 
obje˘id
 = 
mö_key
->objectid;

1532 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

1534 
	`c⁄d_ªsched
();

1535 
	`ùut
(
öode
);

1537 i‡(
obje˘id
 > 
max_key
->objectid)

1540 
öode
 = 
	`föd_√xt_öode
(
roŸ
, 
obje˘id
);

1541 i‡(!
öode
)

1543 
öo
 = 
	`båfs_öo
(
	`BTRFS_I
(
öode
));

1545 i‡(
öo
 > 
max_key
->
obje˘id
) {

1546 
	`ùut
(
öode
);

1550 
obje˘id
 = 
öo
 + 1;

1551 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

1554 i‡(
	`u∆ikñy
(
mö_key
->
obje˘id
 =
öo
)) {

1555 i‡(
mö_key
->
ty≥
 > 
BTRFS_EXTENT_DATA_KEY
)

1557 i‡(
mö_key
->
ty≥
 < 
BTRFS_EXTENT_DATA_KEY
)

1558 
°¨t
 = 0;

1560 
°¨t
 = 
mö_key
->
off£t
;

1561 
	`WARN_ON
(!
	`IS_ALIGNED
(
°¨t
, 
fs_öfo
->
£˘‹size
));

1564 
°¨t
 = 0;

1567 i‡(
	`u∆ikñy
(
max_key
->
obje˘id
 =
öo
)) {

1568 i‡(
max_key
->
ty≥
 < 
BTRFS_EXTENT_DATA_KEY
)

1570 i‡(
max_key
->
ty≥
 > 
BTRFS_EXTENT_DATA_KEY
) {

1571 
íd
 = (
u64
)-1;

1573 i‡(
max_key
->
off£t
 == 0)

1575 
íd
 = 
max_key
->
off£t
;

1576 
	`WARN_ON
(!
	`IS_ALIGNED
(
íd
, 
fs_öfo
->
£˘‹size
));

1577 
íd
--;

1580 
íd
 = (
u64
)-1;

1584 
	`lock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
°¨t
, 
íd
, &
ˇched_°©e
);

1585 
	`båfs_dr›_exã¡_m≠_ønge
(
	`BTRFS_I
(
öode
), 
°¨t
, 
íd
, 
åue
);

1586 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
°¨t
, 
íd
, &
ˇched_°©e
);

1589 
	}
}

1591 
	$föd_√xt_key
(
båfs_∑th
 *
∑th
, 
Àvñ
,

1592 
båfs_key
 *
key
)

1595 
Àvñ
 < 
BTRFS_MAX_LEVEL
) {

1596 i‡(!
∑th
->
nodes
[
Àvñ
])

1598 i‡(
∑th
->
¶Ÿs
[
Àvñ
] + 1 <

1599 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[
Àvñ
])) {

1600 
	`båfs_node_key_to_˝u
(
∑th
->
nodes
[
Àvñ
], 
key
,

1601 
∑th
->
¶Ÿs
[
Àvñ
] + 1);

1604 
Àvñ
++;

1607 
	}
}

1612 
	$ö£π_dúty_subvﬁ
(
båfs_å™s_h™dÀ
 *
å™s
,

1613 
ªloc_c⁄åﬁ
 *
rc
,

1614 
båfs_roŸ
 *
roŸ
)

1616 
båfs_roŸ
 *
ªloc_roŸ
 = 
roŸ
->reloc_root;

1617 
båfs_roŸ_ôem
 *
ªloc_roŸ_ôem
;

1618 
ªt
;

1621 
	`ASSERT
(
roŸ
->
roŸ_key
.
obje˘id
 !
BTRFS_TREE_RELOC_OBJECTID
);

1622 
	`ASSERT
(
ªloc_roŸ
);

1624 
ªloc_roŸ_ôem
 = &
ªloc_roŸ
->
roŸ_ôem
;

1625 
	`mem£t
(&
ªloc_roŸ_ôem
->
dr›_¥ogªss
, 0,

1626 (
ªloc_roŸ_ôem
->
dr›_¥ogªss
));

1627 
	`båfs_£t_roŸ_dr›_Àvñ
(
ªloc_roŸ_ôem
, 0);

1628 
	`båfs_£t_roŸ_ªfs
(
ªloc_roŸ_ôem
, 0);

1629 
ªt
 = 
	`båfs_upd©e_ªloc_roŸ
(
å™s
, 
roŸ
);

1630 i‡(
ªt
)

1631  
ªt
;

1633 i‡(
	`li°_em±y
(&
roŸ
->
ªloc_dúty_li°
)) {

1634 
	`båfs_gøb_roŸ
(
roŸ
);

1635 
	`li°_add_èû
(&
roŸ
->
ªloc_dúty_li°
, &
rc
->
dúty_subvﬁ_roŸs
);

1639 
	}
}

1641 
	$˛ón_dúty_subvﬁs
(
ªloc_c⁄åﬁ
 *
rc
)

1643 
båfs_roŸ
 *
roŸ
;

1644 
båfs_roŸ
 *
√xt
;

1645 
ªt
 = 0;

1646 
ªt2
;

1648 
	`li°_f‹_óch_íåy_ß„
(
roŸ
, 
√xt
, &
rc
->
dúty_subvﬁ_roŸs
,

1649 
ªloc_dúty_li°
) {

1650 i‡(
roŸ
->
roŸ_key
.
obje˘id
 !
BTRFS_TREE_RELOC_OBJECTID
) {

1652 
båfs_roŸ
 *
ªloc_roŸ
 = 
roŸ
->reloc_root;

1654 
	`li°_dñ_öô
(&
roŸ
->
ªloc_dúty_li°
);

1655 
roŸ
->
ªloc_roŸ
 = 
NULL
;

1660 
	`smp_wmb
();

1661 
	`˛ór_bô
(
BTRFS_ROOT_DEAD_RELOC_TREE
, &
roŸ
->
°©e
);

1662 i‡(
ªloc_roŸ
) {

1668 
ªt2
 = 
	`båfs_dr›_¢≠shŸ
(
ªloc_roŸ
, 0, 1);

1669 i‡(
ªt2
 < 0) {

1670 
	`båfs_put_roŸ
(
ªloc_roŸ
);

1671 i‡(!
ªt
)

1672 
ªt
 = 
ªt2
;

1675 
	`båfs_put_roŸ
(
roŸ
);

1678 
ªt2
 = 
	`båfs_dr›_¢≠shŸ
(
roŸ
, 0, 1);

1679 i‡(
ªt2
 < 0) {

1680 
	`båfs_put_roŸ
(
roŸ
);

1681 i‡(!
ªt
)

1682 
ªt
 = 
ªt2
;

1686  
ªt
;

1687 
	}
}

1693 
noölöe_f‹_°ack
 
	$mîge_ªloc_roŸ
(
ªloc_c⁄åﬁ
 *
rc
,

1694 
båfs_roŸ
 *
roŸ
)

1696 
båfs_fs_öfo
 *
fs_öfo
 = 
rc
->
exã¡_roŸ
->fs_info;

1697 
båfs_key
 
key
;

1698 
båfs_key
 
√xt_key
;

1699 
båfs_å™s_h™dÀ
 *
å™s
 = 
NULL
;

1700 
båfs_roŸ
 *
ªloc_roŸ
;

1701 
båfs_roŸ_ôem
 *
roŸ_ôem
;

1702 
båfs_∑th
 *
∑th
;

1703 
exã¡_buf„r
 *
Àaf
;

1704 
ª£rve_Àvñ
;

1705 
Àvñ
;

1706 
max_Àvñ
;

1707 
ª∂a˚d
 = 0;

1708 
ªt
 = 0;

1709 
u32
 
mö_ª£rved
;

1711 
∑th
 = 
	`båfs_Æloc_∑th
();

1712 i‡(!
∑th
)

1713  -
ENOMEM
;

1714 
∑th
->
ªada
 = 
READA_FORWARD
;

1716 
ªloc_roŸ
 = 
roŸ
->reloc_root;

1717 
roŸ_ôem
 = &
ªloc_roŸ
->root_item;

1719 i‡(
	`båfs_disk_key_obje˘id
(&
roŸ_ôem
->
dr›_¥ogªss
) == 0) {

1720 
Àvñ
 = 
	`båfs_roŸ_Àvñ
(
roŸ_ôem
);

1721 
	`©omic_öc
(&
ªloc_roŸ
->
node
->
ªfs
);

1722 
∑th
->
nodes
[
Àvñ
] = 
ªloc_roŸ
->
node
;

1723 
∑th
->
¶Ÿs
[
Àvñ
] = 0;

1725 
	`båfs_disk_key_to_˝u
(&
key
, &
roŸ_ôem
->
dr›_¥ogªss
);

1727 
Àvñ
 = 
	`båfs_roŸ_dr›_Àvñ
(
roŸ_ôem
);

1728 
	`BUG_ON
(
Àvñ
 == 0);

1729 
∑th
->
lowe°_Àvñ
 = 
Àvñ
;

1730 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
ªloc_roŸ
, &
key
, 
∑th
, 0, 0);

1731 
∑th
->
lowe°_Àvñ
 = 0;

1732 i‡(
ªt
 < 0) {

1733 
	`båfs_‰ì_∑th
(
∑th
);

1734  
ªt
;

1737 
	`båfs_node_key_to_˝u
(
∑th
->
nodes
[
Àvñ
], &
√xt_key
,

1738 
∑th
->
¶Ÿs
[
Àvñ
]);

1739 
	`WARN_ON
(
	`memcmp
(&
key
, &
√xt_key
, (key)));

1741 
	`båfs_u∆ock_up_ß„
(
∑th
, 0);

1752 
ª£rve_Àvñ
 = 
	`max_t
(, 1, 
	`båfs_roŸ_Àvñ
(
roŸ_ôem
));

1753 
mö_ª£rved
 = 
fs_öfo
->
nodesize
 * 
ª£rve_Àvñ
 * 2;

1754 
	`mem£t
(&
√xt_key
, 0, (next_key));

1757 
ªt
 = 
	`båfs_block_rsv_ªfûl
(
fs_öfo
, 
rc
->
block_rsv
,

1758 
mö_ª£rved
,

1759 
BTRFS_RESERVE_FLUSH_LIMIT
);

1760 i‡(
ªt
)

1761 
out
;

1762 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

1763 i‡(
	`IS_ERR
(
å™s
)) {

1764 
ªt
 = 
	`PTR_ERR
(
å™s
);

1765 
å™s
 = 
NULL
;

1766 
out
;

1779 
ªloc_roŸ
->
œ°_å™s
 = 
å™s
->
å™sid
;

1780 
å™s
->
block_rsv
 = 
rc
->block_rsv;

1782 
ª∂a˚d
 = 0;

1783 
max_Àvñ
 = 
Àvñ
;

1785 
ªt
 = 
	`wÆk_down_ªloc_åì
(
ªloc_roŸ
, 
∑th
, &
Àvñ
);

1786 i‡(
ªt
 < 0)

1787 
out
;

1788 i‡(
ªt
 > 0)

1791 i‡(!
	`föd_√xt_key
(
∑th
, 
Àvñ
, &
key
) &&

1792 
	`båfs_comp_˝u_keys
(&
√xt_key
, &
key
) >= 0) {

1793 
ªt
 = 0;

1795 
ªt
 = 
	`ª∂a˚_∑th
(
å™s
, 
rc
, 
roŸ
, 
ªloc_roŸ
, 
∑th
,

1796 &
√xt_key
, 
Àvñ
, 
max_Àvñ
);

1798 i‡(
ªt
 < 0)

1799 
out
;

1800 i‡(
ªt
 > 0) {

1801 
Àvñ
 = 
ªt
;

1802 
	`båfs_node_key_to_˝u
(
∑th
->
nodes
[
Àvñ
], &
key
,

1803 
∑th
->
¶Ÿs
[
Àvñ
]);

1804 
ª∂a˚d
 = 1;

1807 
ªt
 = 
	`wÆk_up_ªloc_åì
(
ªloc_roŸ
, 
∑th
, &
Àvñ
);

1808 i‡(
ªt
 > 0)

1811 
	`BUG_ON
(
Àvñ
 == 0);

1816 
	`båfs_node_key
(
∑th
->
nodes
[
Àvñ
], &
roŸ_ôem
->
dr›_¥ogªss
,

1817 
∑th
->
¶Ÿs
[
Àvñ
]);

1818 
	`båfs_£t_roŸ_dr›_Àvñ
(
roŸ_ôem
, 
Àvñ
);

1820 
	`båfs_íd_å™ß˘i⁄_thrŸée
(
å™s
);

1821 
å™s
 = 
NULL
;

1823 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

1825 i‡(
ª∂a˚d
 && 
rc
->
°age
 =
UPDATE_DATA_PTRS
)

1826 
	`övÆid©e_exã¡_ˇche
(
roŸ
, &
key
, &
√xt_key
);

1833 
Àaf
 = 
	`båfs_lock_roŸ_node
(
roŸ
);

1834 
ªt
 = 
	`båfs_cow_block
(
å™s
, 
roŸ
, 
Àaf
, 
NULL
, 0, &leaf,

1835 
BTRFS_NESTING_COW
);

1836 
	`båfs_åì_u∆ock
(
Àaf
);

1837 
	`‰ì_exã¡_buf„r
(
Àaf
);

1838 
out
:

1839 
	`båfs_‰ì_∑th
(
∑th
);

1841 i‡(
ªt
 == 0) {

1842 
ªt
 = 
	`ö£π_dúty_subvﬁ
(
å™s
, 
rc
, 
roŸ
);

1843 i‡(
ªt
)

1844 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1847 i‡(
å™s
)

1848 
	`båfs_íd_å™ß˘i⁄_thrŸée
(
å™s
);

1850 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

1852 i‡(
ª∂a˚d
 && 
rc
->
°age
 =
UPDATE_DATA_PTRS
)

1853 
	`övÆid©e_exã¡_ˇche
(
roŸ
, &
key
, &
√xt_key
);

1855  
ªt
;

1856 
	}
}

1858 
noölöe_f‹_°ack


1859 
	$¥ï¨e_to_mîge
(
ªloc_c⁄åﬁ
 *
rc
, 
îr
)

1861 
båfs_roŸ
 *
roŸ
 = 
rc
->
exã¡_roŸ
;

1862 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1863 
båfs_roŸ
 *
ªloc_roŸ
;

1864 
båfs_å™s_h™dÀ
 *
å™s
;

1865 
	`LIST_HEAD
(
ªloc_roŸs
);

1866 
u64
 
num_byãs
 = 0;

1867 
ªt
;

1869 
	`muãx_lock
(&
fs_öfo
->
ªloc_muãx
);

1870 
rc
->
mîgög_rsv_size
 +
fs_öfo
->
nodesize
 * (
BTRFS_MAX_LEVEL
 - 1) * 2;

1871 
rc
->
mîgög_rsv_size
 +rc->
nodes_ªloˇãd
 * 2;

1872 
	`muãx_u∆ock
(&
fs_öfo
->
ªloc_muãx
);

1874 
agaö
:

1875 i‡(!
îr
) {

1876 
num_byãs
 = 
rc
->
mîgög_rsv_size
;

1877 
ªt
 = 
	`båfs_block_rsv_add
(
fs_öfo
, 
rc
->
block_rsv
, 
num_byãs
,

1878 
BTRFS_RESERVE_FLUSH_ALL
);

1879 i‡(
ªt
)

1880 
îr
 = 
ªt
;

1883 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
rc
->
exã¡_roŸ
);

1884 i‡(
	`IS_ERR
(
å™s
)) {

1885 i‡(!
îr
)

1886 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, 
rc
->
block_rsv
,

1887 
num_byãs
, 
NULL
);

1888  
	`PTR_ERR
(
å™s
);

1891 i‡(!
îr
) {

1892 i‡(
num_byãs
 !
rc
->
mîgög_rsv_size
) {

1893 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1894 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, 
rc
->
block_rsv
,

1895 
num_byãs
, 
NULL
);

1896 
agaö
;

1900 
rc
->
mîge_ªloc_åì
 = 1;

1902 !
	`li°_em±y
(&
rc
->
ªloc_roŸs
)) {

1903 
ªloc_roŸ
 = 
	`li°_íåy
(
rc
->
ªloc_roŸs
.
√xt
,

1904 
båfs_roŸ
, 
roŸ_li°
);

1905 
	`li°_dñ_öô
(&
ªloc_roŸ
->
roŸ_li°
);

1907 
roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
ªloc_roŸ
->
roŸ_key
.
off£t
,

1908 
Ál£
);

1909 i‡(
	`IS_ERR
(
roŸ
)) {

1914 
	`li°_add
(&
ªloc_roŸ
->
roŸ_li°
, &
ªloc_roŸs
);

1915 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, ()
	`PTR_ERR
(
roŸ
));

1916 i‡(!
îr
)

1917 
îr
 = 
	`PTR_ERR
(
roŸ
);

1921 i‡(
	`u∆ikñy
(
roŸ
->
ªloc_roŸ
 !=Ñeloc_root)) {

1922 i‡(
roŸ
->
ªloc_roŸ
) {

1923 
	`båfs_îr
(
fs_öfo
,

1925 
roŸ
->
roŸ_key
.
obje˘id
,

1926 
roŸ
->
ªloc_roŸ
->
roŸ_key
.
obje˘id
,

1927 
roŸ
->
ªloc_roŸ
->
roŸ_key
.
ty≥
,

1928 
roŸ
->
ªloc_roŸ
->
roŸ_key
.
off£t
,

1929 
	`båfs_roŸ_gíî©i⁄
(

1930 &
roŸ
->
ªloc_roŸ
->
roŸ_ôem
),

1931 
ªloc_roŸ
->
roŸ_key
.
obje˘id
,

1932 
ªloc_roŸ
->
roŸ_key
.
ty≥
,

1933 
ªloc_roŸ
->
roŸ_key
.
off£t
,

1934 
	`båfs_roŸ_gíî©i⁄
(

1935 &
ªloc_roŸ
->
roŸ_ôem
));

1937 
	`båfs_îr
(
fs_öfo
,

1939 
roŸ
->
roŸ_key
.
obje˘id
,

1940 
ªloc_roŸ
->
roŸ_key
.
obje˘id
,

1941 
ªloc_roŸ
->
roŸ_key
.
ty≥
,

1942 
ªloc_roŸ
->
roŸ_key
.
off£t
,

1943 
	`båfs_roŸ_gíî©i⁄
(

1944 &
ªloc_roŸ
->
roŸ_ôem
));

1946 
	`li°_add
(&
ªloc_roŸ
->
roŸ_li°
, &
ªloc_roŸs
);

1947 
	`båfs_put_roŸ
(
roŸ
);

1948 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, -
EUCLEAN
);

1949 i‡(!
îr
)

1950 
îr
 = -
EUCLEAN
;

1958 i‡(!
îr
)

1959 
	`båfs_£t_roŸ_ªfs
(&
ªloc_roŸ
->
roŸ_ôem
, 1);

1960 
ªt
 = 
	`båfs_upd©e_ªloc_roŸ
(
å™s
, 
roŸ
);

1966 
	`li°_add
(&
ªloc_roŸ
->
roŸ_li°
, &
ªloc_roŸs
);

1967 
	`båfs_put_roŸ
(
roŸ
);

1969 i‡(
ªt
) {

1970 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1971 i‡(!
îr
)

1972 
îr
 = 
ªt
;

1977 
	`li°_•li˚
(&
ªloc_roŸs
, &
rc
->reloc_roots);

1979 i‡(!
îr
)

1980 
îr
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

1982 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1983  
îr
;

1984 
	}
}

1986 
noölöe_f‹_°ack


1987 
	$‰ì_ªloc_roŸs
(
li°_hód
 *
li°
)

1989 
båfs_roŸ
 *
ªloc_roŸ
, *
tmp
;

1991 
	`li°_f‹_óch_íåy_ß„
(
ªloc_roŸ
, 
tmp
, 
li°
, 
roŸ_li°
)

1992 
	`__dñ_ªloc_roŸ
(
ªloc_roŸ
);

1993 
	}
}

1995 
noölöe_f‹_°ack


1996 
	$mîge_ªloc_roŸs
(
ªloc_c⁄åﬁ
 *
rc
)

1998 
båfs_fs_öfo
 *
fs_öfo
 = 
rc
->
exã¡_roŸ
->fs_info;

1999 
båfs_roŸ
 *
roŸ
;

2000 
båfs_roŸ
 *
ªloc_roŸ
;

2001 
	`LIST_HEAD
(
ªloc_roŸs
);

2002 
found
 = 0;

2003 
ªt
 = 0;

2004 
agaö
:

2005 
roŸ
 = 
rc
->
exã¡_roŸ
;

2013 
	`muãx_lock
(&
fs_öfo
->
ªloc_muãx
);

2014 
	`li°_•li˚_öô
(&
rc
->
ªloc_roŸs
, &reloc_roots);

2015 
	`muãx_u∆ock
(&
fs_öfo
->
ªloc_muãx
);

2017 !
	`li°_em±y
(&
ªloc_roŸs
)) {

2018 
found
 = 1;

2019 
ªloc_roŸ
 = 
	`li°_íåy
(
ªloc_roŸs
.
√xt
,

2020 
båfs_roŸ
, 
roŸ_li°
);

2022 
roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
ªloc_roŸ
->
roŸ_key
.
off£t
,

2023 
Ál£
);

2024 i‡(
	`båfs_roŸ_ªfs
(&
ªloc_roŸ
->
roŸ_ôem
) > 0) {

2025 i‡(
	`WARN_ON
(
	`IS_ERR
(
roŸ
))) {

2034 
ªt
 = 
	`PTR_ERR
(
roŸ
);

2035 
out
;

2037 i‡(
	`WARN_ON
(
roŸ
->
ªloc_roŸ
 !=Ñeloc_root)) {

2042 
ªt
 = -
EINVAL
;

2043 
out
;

2045 
ªt
 = 
	`mîge_ªloc_roŸ
(
rc
, 
roŸ
);

2046 
	`båfs_put_roŸ
(
roŸ
);

2047 i‡(
ªt
) {

2048 i‡(
	`li°_em±y
(&
ªloc_roŸ
->
roŸ_li°
))

2049 
	`li°_add_èû
(&
ªloc_roŸ
->
roŸ_li°
,

2050 &
ªloc_roŸs
);

2051 
out
;

2054 i‡(!
	`IS_ERR
(
roŸ
)) {

2055 i‡(
roŸ
->
ªloc_roŸ
 ==Ñeloc_root) {

2056 
roŸ
->
ªloc_roŸ
 = 
NULL
;

2057 
	`båfs_put_roŸ
(
ªloc_roŸ
);

2059 
	`˛ór_bô
(
BTRFS_ROOT_DEAD_RELOC_TREE
,

2060 &
roŸ
->
°©e
);

2061 
	`båfs_put_roŸ
(
roŸ
);

2064 
	`li°_dñ_öô
(&
ªloc_roŸ
->
roŸ_li°
);

2066 
	`li°_add_èû
(&
ªloc_roŸ
->
ªloc_dúty_li°
,

2067 &
rc
->
dúty_subvﬁ_roŸs
);

2071 i‡(
found
) {

2072 
found
 = 0;

2073 
agaö
;

2075 
out
:

2076 i‡(
ªt
) {

2077 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
ªt
, 
NULL
);

2078 
	`‰ì_ªloc_roŸs
(&
ªloc_roŸs
);

2081 
	`muãx_lock
(&
fs_öfo
->
ªloc_muãx
);

2082 
	`li°_•li˚_öô
(&
rc
->
ªloc_roŸs
, &reloc_roots);

2083 
	`muãx_u∆ock
(&
fs_öfo
->
ªloc_muãx
);

2084 
	`‰ì_ªloc_roŸs
(&
ªloc_roŸs
);

2102 
	}
}

2104 
	$‰ì_block_li°
(
rb_roŸ
 *
blocks
)

2106 
åì_block
 *
block
;

2107 
rb_node
 *rb_node;

2108 (
rb_node
 = 
	`rb_fú°
(
blocks
))) {

2109 
block
 = 
	`rb_íåy
(
rb_node
, 
åì_block
,Ñb_node);

2110 
	`rb_îa£
(
rb_node
, 
blocks
);

2111 
	`k‰ì
(
block
);

2113 
	}
}

2115 
	$ªc‹d_ªloc_roŸ_ö_å™s
(
båfs_å™s_h™dÀ
 *
å™s
,

2116 
båfs_roŸ
 *
ªloc_roŸ
)

2118 
båfs_fs_öfo
 *
fs_öfo
 = 
ªloc_roŸ
->fs_info;

2119 
båfs_roŸ
 *
roŸ
;

2120 
ªt
;

2122 i‡(
ªloc_roŸ
->
œ°_å™s
 =
å™s
->
å™sid
)

2125 
roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
ªloc_roŸ
->
roŸ_key
.
off£t
, 
Ál£
);

2135 i‡(
	`IS_ERR
(
roŸ
)) {

2136 
	`ASSERT
(0);

2137  
	`PTR_ERR
(
roŸ
);

2139 i‡(
roŸ
->
ªloc_roŸ
 !=Ñeloc_root) {

2140 
	`ASSERT
(0);

2141 
	`båfs_îr
(
fs_öfo
,

2143 
ªloc_roŸ
->
roŸ_key
.
off£t
);

2144 
	`båfs_put_roŸ
(
roŸ
);

2145  -
EUCLEAN
;

2147 
ªt
 = 
	`båfs_ªc‹d_roŸ_ö_å™s
(
å™s
, 
roŸ
);

2148 
	`båfs_put_roŸ
(
roŸ
);

2150  
ªt
;

2151 
	}
}

2153 
noölöe_f‹_°ack


2154 
båfs_roŸ
 *
	$£À˘_ªloc_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

2155 
ªloc_c⁄åﬁ
 *
rc
,

2156 
båfs_backªf_node
 *
node
,

2157 
båfs_backªf_edge
 *
edges
[])

2159 
båfs_backªf_node
 *
√xt
;

2160 
båfs_roŸ
 *
roŸ
;

2161 
ödex
 = 0;

2162 
ªt
;

2164 
√xt
 = 
node
;

2166 
	`c⁄d_ªsched
();

2167 
√xt
 = 
	`wÆk_up_backªf
“ext, 
edges
, &
ödex
);

2168 
roŸ
 = 
√xt
->root;

2182 i‡(!
roŸ
) {

2183 
	`ASSERT
(0);

2184 
	`båfs_îr
(
å™s
->
fs_öfo
,

2186 
node
->
byãƒ
);

2187  
	`ERR_PTR
(-
EUCLEAN
);

2189 i‡(!
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
)) {

2190 
	`ASSERT
(0);

2191 
	`båfs_îr
(
å™s
->
fs_öfo
,

2193 
node
->
byãƒ
);

2194  
	`ERR_PTR
(-
EUCLEAN
);

2197 i‡(
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
) {

2198 
ªt
 = 
	`ªc‹d_ªloc_roŸ_ö_å™s
(
å™s
, 
roŸ
);

2199 i‡(
ªt
)

2200  
	`ERR_PTR
(
ªt
);

2204 
ªt
 = 
	`båfs_ªc‹d_roŸ_ö_å™s
(
å™s
, 
roŸ
);

2205 i‡(
ªt
)

2206  
	`ERR_PTR
(
ªt
);

2207 
roŸ
 =ÑoŸ->
ªloc_roŸ
;

2213 i‡(!
roŸ
)

2214  
	`ERR_PTR
(-
ENOENT
);

2216 i‡(
√xt
->
√w_byãƒ
 !
roŸ
->
node
->
°¨t
) {

2224 
	`ASSERT
(
√xt
->
√w_byãƒ
 == 0);

2225 
	`ASSERT
(
	`li°_em±y
(&
√xt
->
li°
));

2226 i‡(
√xt
->
√w_byãƒ
 || !
	`li°_em±y
(&√xt->
li°
)) {

2227 
	`båfs_îr
(
å™s
->
fs_öfo
,

2229 
node
->
byãƒ
, 
√xt
->bytenr);

2230  
	`ERR_PTR
(-
EUCLEAN
);

2233 
√xt
->
√w_byãƒ
 = 
roŸ
->
node
->
°¨t
;

2234 
	`båfs_put_roŸ
(
√xt
->
roŸ
);

2235 
√xt
->
roŸ
 = 
	`båfs_gøb_roŸ
(root);

2236 
	`ASSERT
(
√xt
->
roŸ
);

2237 
	`li°_add_èû
(&
√xt
->
li°
,

2238 &
rc
->
backªf_ˇche
.
ch™ged
);

2239 
	`m¨k_block_¥o˚s£d
(
rc
, 
√xt
);

2243 
	`WARN_ON
(1);

2244 
roŸ
 = 
NULL
;

2245 
√xt
 = 
	`wÆk_down_backªf
(
edges
, &
ödex
);

2246 i‡(!
√xt
 ||Çext->
Àvñ
 <
node
->level)

2249 i‡(!
roŸ
) {

2254 
	`ASSERT
(0);

2255  
	`ERR_PTR
(-
ENOENT
);

2258 
√xt
 = 
node
;

2261 
rc
->
backªf_ˇche
.
∑th
[
√xt
->
Àvñ
] =Çext;

2262 i‡(--
ödex
 < 0)

2264 
√xt
 = 
edges
[
ödex
]->
node
[
UPPER
];

2266  
roŸ
;

2267 
	}
}

2278 
noölöe_f‹_°ack


2279 
båfs_roŸ
 *
	$£À˘_⁄e_roŸ
(
båfs_backªf_node
 *
node
)

2281 
båfs_backªf_node
 *
√xt
;

2282 
båfs_roŸ
 *
roŸ
;

2283 
båfs_roŸ
 *
fs_roŸ
 = 
NULL
;

2284 
båfs_backªf_edge
 *
edges
[
BTRFS_MAX_LEVEL
 - 1];

2285 
ödex
 = 0;

2287 
√xt
 = 
node
;

2289 
	`c⁄d_ªsched
();

2290 
√xt
 = 
	`wÆk_up_backªf
“ext, 
edges
, &
ödex
);

2291 
roŸ
 = 
√xt
->root;

2297 i‡(!
roŸ
)

2298  
	`ERR_PTR
(-
EUCLEAN
);

2301 i‡(!
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
))

2302  
roŸ
;

2304 i‡(
roŸ
->
roŸ_key
.
obje˘id
 !
BTRFS_TREE_RELOC_OBJECTID
)

2305 
fs_roŸ
 = 
roŸ
;

2307 i‡(
√xt
 !
node
)

2308  
NULL
;

2310 
√xt
 = 
	`wÆk_down_backªf
(
edges
, &
ödex
);

2311 i‡(!
√xt
 ||Çext->
Àvñ
 <
node
->level)

2315 i‡(!
fs_roŸ
)

2316  
	`ERR_PTR
(-
ENOENT
);

2317  
fs_roŸ
;

2318 
	}
}

2320 
noölöe_f‹_°ack


2321 
u64
 
	$ˇlcu_mëad©a_size
(
ªloc_c⁄åﬁ
 *
rc
,

2322 
båfs_backªf_node
 *
node
, 
ª£rve
)

2324 
båfs_fs_öfo
 *
fs_öfo
 = 
rc
->
exã¡_roŸ
->fs_info;

2325 
båfs_backªf_node
 *
√xt
 = 
node
;

2326 
båfs_backªf_edge
 *
edge
;

2327 
båfs_backªf_edge
 *
edges
[
BTRFS_MAX_LEVEL
 - 1];

2328 
u64
 
num_byãs
 = 0;

2329 
ödex
 = 0;

2331 
	`BUG_ON
(
ª£rve
 && 
node
->
¥o˚s£d
);

2333 
√xt
) {

2334 
	`c⁄d_ªsched
();

2336 i‡(
√xt
->
¥o˚s£d
 && (
ª£rve
 ||Çexà!
node
))

2339 
num_byãs
 +
fs_öfo
->
nodesize
;

2341 i‡(
	`li°_em±y
(&
√xt
->
uµî
))

2344 
edge
 = 
	`li°_íåy
(
√xt
->
uµî
.next,

2345 
båfs_backªf_edge
, 
li°
[
LOWER
]);

2346 
edges
[
ödex
++] = 
edge
;

2347 
√xt
 = 
edge
->
node
[
UPPER
];

2349 
√xt
 = 
	`wÆk_down_backªf
(
edges
, &
ödex
);

2351  
num_byãs
;

2352 
	}
}

2354 
	$ª£rve_mëad©a_•a˚
(
båfs_å™s_h™dÀ
 *
å™s
,

2355 
ªloc_c⁄åﬁ
 *
rc
,

2356 
båfs_backªf_node
 *
node
)

2358 
båfs_roŸ
 *
roŸ
 = 
rc
->
exã¡_roŸ
;

2359 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

2360 
u64
 
num_byãs
;

2361 
ªt
;

2362 
u64
 
tmp
;

2364 
num_byãs
 = 
	`ˇlcu_mëad©a_size
(
rc
, 
node
, 1) * 2;

2366 
å™s
->
block_rsv
 = 
rc
->block_rsv;

2367 
rc
->
ª£rved_byãs
 +
num_byãs
;

2374 
ªt
 = 
	`båfs_block_rsv_ªfûl
(
fs_öfo
, 
rc
->
block_rsv
, 
num_byãs
,

2375 
BTRFS_RESERVE_FLUSH_LIMIT
);

2376 i‡(
ªt
) {

2377 
tmp
 = 
fs_öfo
->
nodesize
 * 
RELOCATION_RESERVED_NODES
;

2378 
tmp
 <
rc
->
ª£rved_byãs
)

2379 
tmp
 <<= 1;

2387 
rc
->
block_rsv
->
size
 = 
tmp
 + 
fs_öfo
->
nodesize
 *

2388 
RELOCATION_RESERVED_NODES
;

2389  -
EAGAIN
;

2393 
	}
}

2402 
	$do_ªloˇti⁄
(
båfs_å™s_h™dÀ
 *
å™s
,

2403 
ªloc_c⁄åﬁ
 *
rc
,

2404 
båfs_backªf_node
 *
node
,

2405 
båfs_key
 *
key
,

2406 
båfs_∑th
 *
∑th
, 
lowe°
)

2408 
båfs_backªf_node
 *
uµî
;

2409 
båfs_backªf_edge
 *
edge
;

2410 
båfs_backªf_edge
 *
edges
[
BTRFS_MAX_LEVEL
 - 1];

2411 
båfs_roŸ
 *
roŸ
;

2412 
exã¡_buf„r
 *
eb
;

2413 
u32
 
blocksize
;

2414 
u64
 
byãƒ
;

2415 
¶Ÿ
;

2416 
ªt
 = 0;

2422 
	`ASSERT
(!
lowe°
 || !
node
->
eb
);

2424 
∑th
->
lowe°_Àvñ
 = 
node
->
Àvñ
 + 1;

2425 
rc
->
backªf_ˇche
.
∑th
[
node
->
Àvñ
] =Çode;

2426 
	`li°_f‹_óch_íåy
(
edge
, &
node
->
uµî
, 
li°
[
LOWER
]) {

2427 
båfs_ªf
 
ªf
 = { 0 };

2429 
	`c⁄d_ªsched
();

2431 
uµî
 = 
edge
->
node
[
UPPER
];

2432 
roŸ
 = 
	`£À˘_ªloc_roŸ
(
å™s
, 
rc
, 
uµî
, 
edges
);

2433 i‡(
	`IS_ERR
(
roŸ
)) {

2434 
ªt
 = 
	`PTR_ERR
(
roŸ
);

2435 
√xt
;

2438 i‡(
uµî
->
eb
 && !uµî->
locked
) {

2439 i‡(!
lowe°
) {

2440 
ªt
 = 
	`båfs_bö_£¨ch
(
uµî
->
eb
, 0, 
key
, &
¶Ÿ
);

2441 i‡(
ªt
 < 0)

2442 
√xt
;

2443 
	`BUG_ON
(
ªt
);

2444 
byãƒ
 = 
	`båfs_node_block±r
(
uµî
->
eb
, 
¶Ÿ
);

2445 i‡(
node
->
eb
->
°¨t
 =
byãƒ
)

2446 
√xt
;

2448 
	`båfs_backªf_dr›_node_buf„r
(
uµî
);

2451 i‡(!
uµî
->
eb
) {

2452 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, 
key
, 
∑th
, 0, 1);

2453 i‡(
ªt
) {

2454 i‡(
ªt
 > 0)

2455 
ªt
 = -
ENOENT
;

2457 
	`båfs_ªÀa£_∑th
(
∑th
);

2461 i‡(!
uµî
->
eb
) {

2462 
uµî
->
eb
 = 
∑th
->
nodes
[uµî->
Àvñ
];

2463 
∑th
->
nodes
[
uµî
->
Àvñ
] = 
NULL
;

2465 
	`BUG_ON
(
uµî
->
eb
 !
∑th
->
nodes
[uµî->
Àvñ
]);

2468 
uµî
->
locked
 = 1;

2469 
∑th
->
locks
[
uµî
->
Àvñ
] = 0;

2471 
¶Ÿ
 = 
∑th
->
¶Ÿs
[
uµî
->
Àvñ
];

2472 
	`båfs_ªÀa£_∑th
(
∑th
);

2474 
ªt
 = 
	`båfs_bö_£¨ch
(
uµî
->
eb
, 0, 
key
, &
¶Ÿ
);

2475 i‡(
ªt
 < 0)

2476 
√xt
;

2477 
	`BUG_ON
(
ªt
);

2480 
byãƒ
 = 
	`båfs_node_block±r
(
uµî
->
eb
, 
¶Ÿ
);

2481 i‡(
lowe°
) {

2482 i‡(
byãƒ
 !
node
->bytenr) {

2483 
	`båfs_îr
(
roŸ
->
fs_öfo
,

2485 
byãƒ
, 
node
->byãƒ, 
¶Ÿ
,

2486 
uµî
->
eb
->
°¨t
);

2487 
ªt
 = -
EIO
;

2488 
√xt
;

2491 i‡(
node
->
eb
->
°¨t
 =
byãƒ
)

2492 
√xt
;

2495 
blocksize
 = 
roŸ
->
fs_öfo
->
nodesize
;

2496 
eb
 = 
	`båfs_ªad_node_¶Ÿ
(
uµî
->eb, 
¶Ÿ
);

2497 i‡(
	`IS_ERR
(
eb
)) {

2498 
ªt
 = 
	`PTR_ERR
(
eb
);

2499 
√xt
;

2501 
	`båfs_åì_lock
(
eb
);

2503 i‡(!
node
->
eb
) {

2504 
ªt
 = 
	`båfs_cow_block
(
å™s
, 
roŸ
, 
eb
, 
uµî
->eb,

2505 
¶Ÿ
, &
eb
, 
BTRFS_NESTING_COW
);

2506 
	`båfs_åì_u∆ock
(
eb
);

2507 
	`‰ì_exã¡_buf„r
(
eb
);

2508 i‡(
ªt
 < 0)

2509 
√xt
;

2514 
	`ASSERT
(
node
->
eb
 ==Éb);

2516 
	`båfs_£t_node_block±r
(
uµî
->
eb
, 
¶Ÿ
,

2517 
node
->
eb
->
°¨t
);

2518 
	`båfs_£t_node_±r_gíî©i⁄
(
uµî
->
eb
, 
¶Ÿ
,

2519 
å™s
->
å™sid
);

2520 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
uµî
->
eb
);

2522 
	`båfs_öô_gíîic_ªf
(&
ªf
, 
BTRFS_ADD_DELAYED_REF
,

2523 
node
->
eb
->
°¨t
, 
blocksize
,

2524 
uµî
->
eb
->
°¨t
);

2525 
	`båfs_öô_åì_ªf
(&
ªf
, 
node
->
Àvñ
,

2526 
	`båfs_hódî_ow√r
(
uµî
->
eb
),

2527 
roŸ
->
roŸ_key
.
obje˘id
, 
Ál£
);

2528 
ªt
 = 
	`båfs_öc_exã¡_ªf
(
å™s
, &
ªf
);

2529 i‡(!
ªt
)

2530 
ªt
 = 
	`båfs_dr›_subåì
(
å™s
, 
roŸ
, 
eb
,

2531 
uµî
->
eb
);

2532 i‡(
ªt
)

2533 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2535 
√xt
:

2536 i‡(!
uµî
->
≥ndög
)

2537 
	`båfs_backªf_dr›_node_buf„r
(
uµî
);

2539 
	`båfs_backªf_u∆ock_node_buf„r
(
uµî
);

2540 i‡(
ªt
)

2544 i‡(!
ªt
 && 
node
->
≥ndög
) {

2545 
	`båfs_backªf_dr›_node_buf„r
(
node
);

2546 
	`li°_move_èû
(&
node
->
li°
, &
rc
->
backªf_ˇche
.
ch™ged
);

2547 
node
->
≥ndög
 = 0;

2550 
∑th
->
lowe°_Àvñ
 = 0;

2556 
	`ASSERT
(
ªt
 !-
ENOSPC
);

2557  
ªt
;

2558 
	}
}

2560 
	$lök_to_uµî
(
båfs_å™s_h™dÀ
 *
å™s
,

2561 
ªloc_c⁄åﬁ
 *
rc
,

2562 
båfs_backªf_node
 *
node
,

2563 
båfs_∑th
 *
∑th
)

2565 
båfs_key
 
key
;

2567 
	`båfs_node_key_to_˝u
(
node
->
eb
, &
key
, 0);

2568  
	`do_ªloˇti⁄
(
å™s
, 
rc
, 
node
, &
key
, 
∑th
, 0);

2569 
	}
}

2571 
	$föish_≥ndög_nodes
(
båfs_å™s_h™dÀ
 *
å™s
,

2572 
ªloc_c⁄åﬁ
 *
rc
,

2573 
båfs_∑th
 *
∑th
, 
îr
)

2575 
	`LIST_HEAD
(
li°
);

2576 
båfs_backªf_ˇche
 *
ˇche
 = &
rc
->
backªf_ˇche
;

2577 
båfs_backªf_node
 *
node
;

2578 
Àvñ
;

2579 
ªt
;

2581 
Àvñ
 = 0;Üevñ < 
BTRFS_MAX_LEVEL
;Üevel++) {

2582 !
	`li°_em±y
(&
ˇche
->
≥ndög
[
Àvñ
])) {

2583 
node
 = 
	`li°_íåy
(
ˇche
->
≥ndög
[
Àvñ
].
√xt
,

2584 
båfs_backªf_node
, 
li°
);

2585 
	`li°_move_èû
(&
node
->
li°
, &list);

2586 
	`BUG_ON
(!
node
->
≥ndög
);

2588 i‡(!
îr
) {

2589 
ªt
 = 
	`lök_to_uµî
(
å™s
, 
rc
, 
node
, 
∑th
);

2590 i‡(
ªt
 < 0)

2591 
îr
 = 
ªt
;

2594 
	`li°_•li˚_öô
(&
li°
, &
ˇche
->
≥ndög
[
Àvñ
]);

2596  
îr
;

2597 
	}
}

2603 
	$upd©e_¥o˚s£d_blocks
(
ªloc_c⁄åﬁ
 *
rc
,

2604 
båfs_backªf_node
 *
node
)

2606 
båfs_backªf_node
 *
√xt
 = 
node
;

2607 
båfs_backªf_edge
 *
edge
;

2608 
båfs_backªf_edge
 *
edges
[
BTRFS_MAX_LEVEL
 - 1];

2609 
ödex
 = 0;

2611 
√xt
) {

2612 
	`c⁄d_ªsched
();

2614 i‡(
√xt
->
¥o˚s£d
)

2617 
	`m¨k_block_¥o˚s£d
(
rc
, 
√xt
);

2619 i‡(
	`li°_em±y
(&
√xt
->
uµî
))

2622 
edge
 = 
	`li°_íåy
(
√xt
->
uµî
.next,

2623 
båfs_backªf_edge
, 
li°
[
LOWER
]);

2624 
edges
[
ödex
++] = 
edge
;

2625 
√xt
 = 
edge
->
node
[
UPPER
];

2627 
√xt
 = 
	`wÆk_down_backªf
(
edges
, &
ödex
);

2629 
	}
}

2631 
	$åì_block_¥o˚s£d
(
u64
 
byãƒ
, 
ªloc_c⁄åﬁ
 *
rc
)

2633 
u32
 
blocksize
 = 
rc
->
exã¡_roŸ
->
fs_öfo
->
nodesize
;

2635 i‡(
	`ã°_ønge_bô
(&
rc
->
¥o˚s£d_blocks
, 
byãƒ
,

2636 
byãƒ
 + 
blocksize
 - 1, 
EXTENT_DIRTY
, 1, 
NULL
))

2639 
	}
}

2641 
	$gë_åì_block_key
(
båfs_fs_öfo
 *
fs_öfo
,

2642 
åì_block
 *
block
)

2644 
båfs_åì_∑ª¡_check
 
check
 = {

2645 .
Àvñ
 = 
block
->level,

2646 .
ow√r_roŸ
 = 
block
->
ow√r
,

2647 .
å™sid
 = 
block
->
key
.
off£t


2649 
exã¡_buf„r
 *
eb
;

2651 
eb
 = 
	`ªad_åì_block
(
fs_öfo
, 
block
->
byãƒ
, &
check
);

2652 i‡(
	`IS_ERR
(
eb
))

2653  
	`PTR_ERR
(
eb
);

2654 i‡(!
	`exã¡_buf„r_u±od©e
(
eb
)) {

2655 
	`‰ì_exã¡_buf„r
(
eb
);

2656  -
EIO
;

2658 i‡(
block
->
Àvñ
 == 0)

2659 
	`båfs_ôem_key_to_˝u
(
eb
, &
block
->
key
, 0);

2661 
	`båfs_node_key_to_˝u
(
eb
, &
block
->
key
, 0);

2662 
	`‰ì_exã¡_buf„r
(
eb
);

2663 
block
->
key_ªady
 = 1;

2665 
	}
}

2670 
	$ªloˇã_åì_block
(
båfs_å™s_h™dÀ
 *
å™s
,

2671 
ªloc_c⁄åﬁ
 *
rc
,

2672 
båfs_backªf_node
 *
node
,

2673 
båfs_key
 *
key
,

2674 
båfs_∑th
 *
∑th
)

2676 
båfs_roŸ
 *
roŸ
;

2677 
ªt
 = 0;

2679 i‡(!
node
)

2686 
ªt
 = 
	`ª£rve_mëad©a_•a˚
(
å™s
, 
rc
, 
node
);

2687 i‡(
ªt
)

2688 
out
;

2690 
	`BUG_ON
(
node
->
¥o˚s£d
);

2691 
roŸ
 = 
	`£À˘_⁄e_roŸ
(
node
);

2692 i‡(
	`IS_ERR
(
roŸ
)) {

2693 
ªt
 = 
	`PTR_ERR
(
roŸ
);

2696 
	`ASSERT
(
ªt
 =-
ENOENT
);

2697 i‡(
ªt
 =-
ENOENT
) {

2698 
ªt
 = 0;

2699 
	`upd©e_¥o˚s£d_blocks
(
rc
, 
node
);

2701 
out
;

2704 i‡(
roŸ
) {

2705 i‡(
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
)) {

2719 
	`ASSERT
(
node
->
√w_byãƒ
 == 0);

2720 
	`ASSERT
(
	`li°_em±y
(&
node
->
li°
));

2721 i‡(
node
->
√w_byãƒ
 || !
	`li°_em±y
(&node->
li°
)) {

2722 
	`båfs_îr
(
roŸ
->
fs_öfo
,

2724 
node
->
byãƒ
);

2725 
ªt
 = -
EUCLEAN
;

2726 
out
;

2728 
ªt
 = 
	`båfs_ªc‹d_roŸ_ö_å™s
(
å™s
, 
roŸ
);

2729 i‡(
ªt
)

2730 
out
;

2735 i‡(!
roŸ
->
ªloc_roŸ
) {

2736 
ªt
 = -
ENOENT
;

2737 
out
;

2739 
roŸ
 =ÑoŸ->
ªloc_roŸ
;

2740 
node
->
√w_byãƒ
 = 
roŸ
->node->
°¨t
;

2741 
	`båfs_put_roŸ
(
node
->
roŸ
);

2742 
node
->
roŸ
 = 
	`båfs_gøb_roŸ
(root);

2743 
	`ASSERT
(
node
->
roŸ
);

2744 
	`li°_add_èû
(&
node
->
li°
, &
rc
->
backªf_ˇche
.
ch™ged
);

2746 
∑th
->
lowe°_Àvñ
 = 
node
->
Àvñ
;

2747 i‡(
roŸ
 =roŸ->
fs_öfo
->
chunk_roŸ
)

2748 
	`båfs_ª£rve_chunk_mëad©a
(
å™s
, 
Ál£
);

2749 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, 
key
, 
∑th
, 0, 1);

2750 
	`båfs_ªÀa£_∑th
(
∑th
);

2751 i‡(
roŸ
 =roŸ->
fs_öfo
->
chunk_roŸ
)

2752 
	`båfs_å™s_ªÀa£_chunk_mëad©a
(
å™s
);

2753 i‡(
ªt
 > 0)

2754 
ªt
 = 0;

2756 i‡(!
ªt
)

2757 
	`upd©e_¥o˚s£d_blocks
(
rc
, 
node
);

2759 
ªt
 = 
	`do_ªloˇti⁄
(
å™s
, 
rc
, 
node
, 
key
, 
∑th
, 1);

2761 
out
:

2762 i‡(
ªt
 || 
node
->
Àvñ
 =0 ||Çode->
cow⁄ly
)

2763 
	`båfs_backªf_˛ónup_node
(&
rc
->
backªf_ˇche
, 
node
);

2764  
ªt
;

2765 
	}
}

2770 
noölöe_f‹_°ack


2771 
	$ªloˇã_åì_blocks
(
båfs_å™s_h™dÀ
 *
å™s
,

2772 
ªloc_c⁄åﬁ
 *
rc
, 
rb_roŸ
 *
blocks
)

2774 
båfs_fs_öfo
 *
fs_öfo
 = 
rc
->
exã¡_roŸ
->fs_info;

2775 
båfs_backªf_node
 *
node
;

2776 
båfs_∑th
 *
∑th
;

2777 
åì_block
 *
block
;

2778 
åì_block
 *
√xt
;

2779 
ªt
;

2780 
îr
 = 0;

2782 
∑th
 = 
	`båfs_Æloc_∑th
();

2783 i‡(!
∑th
) {

2784 
îr
 = -
ENOMEM
;

2785 
out_‰ì_blocks
;

2789 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
block
, 
√xt
, 
blocks
, 
rb_node
) {

2790 i‡(!
block
->
key_ªady
)

2791 
	`båfs_ªadahód_åì_block
(
fs_öfo
, 
block
->
byãƒ
,

2792 
block
->
ow√r
, 0,

2793 
block
->
Àvñ
);

2797 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
block
, 
√xt
, 
blocks
, 
rb_node
) {

2798 i‡(!
block
->
key_ªady
) {

2799 
îr
 = 
	`gë_åì_block_key
(
fs_öfo
, 
block
);

2800 i‡(
îr
)

2801 
out_‰ì_∑th
;

2806 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
block
, 
√xt
, 
blocks
, 
rb_node
) {

2807 
node
 = 
	`buûd_backªf_åì
(
å™s
, 
rc
, &
block
->
key
,

2808 
block
->
Àvñ
, block->
byãƒ
);

2809 i‡(
	`IS_ERR
(
node
)) {

2810 
îr
 = 
	`PTR_ERR
(
node
);

2811 
out
;

2814 
ªt
 = 
	`ªloˇã_åì_block
(
å™s
, 
rc
, 
node
, &
block
->
key
,

2815 
∑th
);

2816 i‡(
ªt
 < 0) {

2817 
îr
 = 
ªt
;

2821 
out
:

2822 
îr
 = 
	`föish_≥ndög_nodes
(
å™s
, 
rc
, 
∑th
,Érr);

2824 
out_‰ì_∑th
:

2825 
	`båfs_‰ì_∑th
(
∑th
);

2826 
out_‰ì_blocks
:

2827 
	`‰ì_block_li°
(
blocks
);

2828  
îr
;

2829 
	}
}

2831 
noölöe_f‹_°ack
 
	$¥óŒoc_fûe_exã¡_˛u°î
(

2832 
båfs_öode
 *
öode
,

2833 
fûe_exã¡_˛u°î
 *
˛u°î
)

2835 
u64
 
Æloc_höt
 = 0;

2836 
u64
 
°¨t
;

2837 
u64
 
íd
;

2838 
u64
 
off£t
 = 
öode
->
ödex_˙t
;

2839 
u64
 
num_byãs
;

2840 
ƒ
;

2841 
ªt
 = 0;

2842 
u64
 
i_size
 = 
	`i_size_ªad
(&
öode
->
vfs_öode
);

2843 
u64
 
¥óŒoc_°¨t
 = 
˛u°î
->
°¨t
 - 
off£t
;

2844 
u64
 
¥óŒoc_íd
 = 
˛u°î
->
íd
 - 
off£t
;

2845 
u64
 
cur_off£t
 = 
¥óŒoc_°¨t
;

2858 i‡(!
	`PAGE_ALIGNED
(
i_size
)) {

2859 
addªss_•a˚
 *
m≠pög
 = 
öode
->
vfs_öode
.
i_m≠pög
;

2860 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

2861 c⁄° 
u32
 
£˘‹size
 = 
fs_öfo
->sectorsize;

2862 
∑ge
 *page;

2864 
	`ASSERT
(
£˘‹size
 < 
PAGE_SIZE
);

2865 
	`ASSERT
(
	`IS_ALIGNED
(
i_size
, 
£˘‹size
));

2886 
ªt
 = 
	`fûem≠_wrôe_™d_waô
(
m≠pög
);

2887 i‡(
ªt
 < 0)

2888  
ªt
;

2890 
	`˛ór_exã¡_bôs
(&
öode
->
io_åì
, 
i_size
,

2891 
	`round_up
(
i_size
, 
PAGE_SIZE
) - 1,

2892 
EXTENT_UPTODATE
);

2893 
∑ge
 = 
	`föd_lock_∑ge
(
m≠pög
, 
i_size
 >> 
PAGE_SHIFT
);

2898 i‡(
∑ge
) {

2899 
	`båfs_sub∑ge_˛ór_u±od©e
(
fs_öfo
, 
∑ge
, 
i_size
,

2900 
	`round_up
(
i_size
, 
PAGE_SIZE
) - i_size);

2901 
	`u∆ock_∑ge
(
∑ge
);

2902 
	`put_∑ge
(
∑ge
);

2906 
	`BUG_ON
(
˛u°î
->
°¨t
 !˛u°î->
bound¨y
[0]);

2907 
ªt
 = 
	`båfs_Æloc_d©a_chunk_⁄dem™d
(
öode
,

2908 
¥óŒoc_íd
 + 1 - 
¥óŒoc_°¨t
);

2909 i‡(
ªt
)

2910  
ªt
;

2912 
	`båfs_öode_lock
(
öode
, 0);

2913 
ƒ
 = 0;Ç∏< 
˛u°î
->nr;Çr++) {

2914 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

2916 
°¨t
 = 
˛u°î
->
bound¨y
[
ƒ
] - 
off£t
;

2917 i‡(
ƒ
 + 1 < 
˛u°î
->nr)

2918 
íd
 = 
˛u°î
->
bound¨y
[
ƒ
 + 1] - 1 - 
off£t
;

2920 
íd
 = 
˛u°î
->íd - 
off£t
;

2922 
	`lock_exã¡
(&
öode
->
io_åì
, 
°¨t
, 
íd
, &
ˇched_°©e
);

2923 
num_byãs
 = 
íd
 + 1 - 
°¨t
;

2924 
ªt
 = 
	`båfs_¥óŒoc_fûe_ønge
(&
öode
->
vfs_öode
, 0, 
°¨t
,

2925 
num_byãs
,Çum_bytes,

2926 
íd
 + 1, &
Æloc_höt
);

2927 
cur_off£t
 = 
íd
 + 1;

2928 
	`u∆ock_exã¡
(&
öode
->
io_åì
, 
°¨t
, 
íd
, &
ˇched_°©e
);

2929 i‡(
ªt
)

2932 
	`båfs_öode_u∆ock
(
öode
, 0);

2934 i‡(
cur_off£t
 < 
¥óŒoc_íd
)

2935 
	`båfs_‰ì_ª£rved_d©a_•a˚_noquŸa
(
öode
->
roŸ
->
fs_öfo
,

2936 
¥óŒoc_íd
 + 1 - 
cur_off£t
);

2937  
ªt
;

2938 
	}
}

2940 
noölöe_f‹_°ack
 
	$£tup_ªloˇti⁄_exã¡_m≠pög
(
öode
 *inode,

2941 
u64
 
°¨t
, u64 
íd
, u64 
block_°¨t
)

2943 
exã¡_m≠
 *
em
;

2944 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

2945 
ªt
 = 0;

2947 
em
 = 
	`Æloc_exã¡_m≠
();

2948 i‡(!
em
)

2949  -
ENOMEM
;

2951 
em
->
°¨t
 = start;

2952 
em
->
Àn
 = 
íd
 + 1 - 
°¨t
;

2953 
em
->
block_Àn
 =Ém->
Àn
;

2954 
em
->
block_°¨t
 = block_start;

2955 
	`£t_bô
(
EXTENT_FLAG_PINNED
, &
em
->
Êags
);

2957 
	`lock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
°¨t
, 
íd
, &
ˇched_°©e
);

2958 
ªt
 = 
	`båfs_ª∂a˚_exã¡_m≠_ønge
(
	`BTRFS_I
(
öode
), 
em
, 
Ál£
);

2959 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
°¨t
, 
íd
, &
ˇched_°©e
);

2960 
	`‰ì_exã¡_m≠
(
em
);

2962  
ªt
;

2963 
	}
}

2968 
noölöe
 
	$båfs_should_ˇn˚l_bÆ™˚
(
båfs_fs_öfo
 *
fs_öfo
)

2970  
	`©omic_ªad
(&
fs_öfo
->
bÆ™˚_ˇn˚l_ªq
) ||

2971 
	`©omic_ªad
(&
fs_öfo
->
ªloc_ˇn˚l_ªq
) ||

2972 
	`Áèl_sig«l_≥ndög
(
cuºít
);

2973 
	}
}

2974 
ALLOW_ERROR_INJECTION
(
båfs_should_ˇn˚l_bÆ™˚
, 
TRUE
);

2976 
u64
 
	$gë_˛u°î_bound¨y_íd
(
fûe_exã¡_˛u°î
 *
˛u°î
,

2977 
˛u°î_ƒ
)

2980 i‡(
˛u°î_ƒ
 >
˛u°î
->
ƒ
 - 1)

2981  
˛u°î
->
íd
;

2984  
˛u°î
->
bound¨y
[
˛u°î_ƒ
 + 1] - 1;

2985 
	}
}

2987 
	$ªloˇã_⁄e_∑ge
(
öode
 *öode, 
fûe_ø_°©e
 *
ø
,

2988 
fûe_exã¡_˛u°î
 *
˛u°î
,

2989 *
˛u°î_ƒ
, 
∑ge_ödex
)

2991 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
öode
->
i_sb
);

2992 
u64
 
off£t
 = 
	`BTRFS_I
(
öode
)->
ödex_˙t
;

2993 c⁄° 
œ°_ödex
 = (
˛u°î
->
íd
 - 
off£t
Ë>> 
PAGE_SHIFT
;

2994 
gÂ_t
 
mask
 = 
	`båfs_Æloc_wrôe_mask
(
öode
->
i_m≠pög
);

2995 
∑ge
 *page;

2996 
u64
 
∑ge_°¨t
;

2997 
u64
 
∑ge_íd
;

2998 
u64
 
cur
;

2999 
ªt
;

3001 
	`ASSERT
(
∑ge_ödex
 <
œ°_ödex
);

3002 
∑ge
 = 
	`föd_lock_∑ge
(
öode
->
i_m≠pög
, 
∑ge_ödex
);

3003 i‡(!
∑ge
) {

3004 
	`∑ge_ˇche_sync_ªadahód
(
öode
->
i_m≠pög
, 
ø
, 
NULL
,

3005 
∑ge_ödex
, 
œ°_ödex
 + 1 -Öage_index);

3006 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
∑ge_ödex
, 
mask
);

3007 i‡(!
∑ge
)

3008  -
ENOMEM
;

3011 i‡(
	`PageRódahód
(
∑ge
))

3012 
	`∑ge_ˇche_async_ªadahód
(
öode
->
i_m≠pög
, 
ø
, 
NULL
,

3013 
	`∑ge_fﬁio
(
∑ge
), 
∑ge_ödex
,

3014 
œ°_ödex
 + 1 - 
∑ge_ödex
);

3016 i‡(!
	`PageU±od©e
(
∑ge
)) {

3017 
	`båfs_ªad_fﬁio
(
NULL
, 
	`∑ge_fﬁio
(
∑ge
));

3018 
	`lock_∑ge
(
∑ge
);

3019 i‡(!
	`PageU±od©e
(
∑ge
)) {

3020 
ªt
 = -
EIO
;

3021 
ªÀa£_∑ge
;

3030 
ªt
 = 
	`£t_∑ge_exã¡_m≠≥d
(
∑ge
);

3031 i‡(
ªt
 < 0)

3032 
ªÀa£_∑ge
;

3034 
∑ge_°¨t
 = 
	`∑ge_off£t
(
∑ge
);

3035 
∑ge_íd
 = 
∑ge_°¨t
 + 
PAGE_SIZE
 - 1;

3041 
cur
 = 
	`max
(
∑ge_°¨t
, 
˛u°î
->
bound¨y
[*
˛u°î_ƒ
] - 
off£t
);

3042 
cur
 <
∑ge_íd
) {

3043 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

3044 
u64
 
exã¡_°¨t
 = 
˛u°î
->
bound¨y
[*
˛u°î_ƒ
] - 
off£t
;

3045 
u64
 
exã¡_íd
 = 
	`gë_˛u°î_bound¨y_íd
(
˛u°î
,

3046 *
˛u°î_ƒ
Ë- 
off£t
;

3047 
u64
 
˛am≥d_°¨t
 = 
	`max
(
∑ge_°¨t
, 
exã¡_°¨t
);

3048 
u64
 
˛am≥d_íd
 = 
	`mö
(
∑ge_íd
, 
exã¡_íd
);

3049 
u32
 
˛am≥d_Àn
 = 
˛am≥d_íd
 + 1 - 
˛am≥d_°¨t
;

3052 
ªt
 = 
	`båfs_dñÆloc_ª£rve_mëad©a
(
	`BTRFS_I
(
öode
),

3053 
˛am≥d_Àn
, clamped_len,

3054 
Ál£
);

3055 i‡(
ªt
)

3056 
ªÀa£_∑ge
;

3059 
	`lock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
˛am≥d_°¨t
, 
˛am≥d_íd
,

3060 &
ˇched_°©e
);

3061 
ªt
 = 
	`båfs_£t_exã¡_dñÆloc
(
	`BTRFS_I
(
öode
), 
˛am≥d_°¨t
,

3062 
˛am≥d_íd
, 0, &
ˇched_°©e
);

3063 i‡(
ªt
) {

3064 
	`˛ór_exã¡_bô
(&
	`BTRFS_I
(
öode
)->
io_åì
,

3065 
˛am≥d_°¨t
, 
˛am≥d_íd
,

3066 
EXTENT_LOCKED
 | 
EXTENT_BOUNDARY
,

3067 &
ˇched_°©e
);

3068 
	`båfs_dñÆloc_ªÀa£_mëad©a
(
	`BTRFS_I
(
öode
),

3069 
˛am≥d_Àn
, 
åue
);

3070 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
	`BTRFS_I
(
öode
),

3071 
˛am≥d_Àn
);

3072 
ªÀa£_∑ge
;

3074 
	`båfs_∑ge_£t_dúty
(
fs_öfo
, 
∑ge
, 
˛am≥d_°¨t
, 
˛am≥d_Àn
);

3083 i‡(
	`ö_ønge
(
˛u°î
->
bound¨y
[*
˛u°î_ƒ
] - 
off£t
,

3084 
∑ge_°¨t
, 
PAGE_SIZE
)) {

3085 
u64
 
bound¨y_°¨t
 = 
˛u°î
->
bound¨y
[*
˛u°î_ƒ
] -

3086 
off£t
;

3087 
u64
 
bound¨y_íd
 = 
bound¨y_°¨t
 +

3088 
fs_öfo
->
£˘‹size
 - 1;

3090 
	`£t_exã¡_bô
(&
	`BTRFS_I
(
öode
)->
io_åì
,

3091 
bound¨y_°¨t
, 
bound¨y_íd
,

3092 
EXTENT_BOUNDARY
, 
NULL
);

3094 
	`u∆ock_exã¡
(&
	`BTRFS_I
(
öode
)->
io_åì
, 
˛am≥d_°¨t
, 
˛am≥d_íd
,

3095 &
ˇched_°©e
);

3096 
	`båfs_dñÆloc_ªÀa£_exã¡s
(
	`BTRFS_I
(
öode
), 
˛am≥d_Àn
);

3097 
cur
 +
˛am≥d_Àn
;

3100 i‡(
cur
 >
exã¡_íd
) {

3101 (*
˛u°î_ƒ
)++;

3103 i‡(*
˛u°î_ƒ
 >
˛u°î
->
ƒ
)

3107 
	`u∆ock_∑ge
(
∑ge
);

3108 
	`put_∑ge
(
∑ge
);

3110 
	`bÆ™˚_dúty_∑ges_øãlimôed
(
öode
->
i_m≠pög
);

3111 
	`båfs_thrŸée
(
fs_öfo
);

3112 i‡(
	`båfs_should_ˇn˚l_bÆ™˚
(
fs_öfo
))

3113 
ªt
 = -
ECANCELED
;

3114  
ªt
;

3116 
ªÀa£_∑ge
:

3117 
	`u∆ock_∑ge
(
∑ge
);

3118 
	`put_∑ge
(
∑ge
);

3119  
ªt
;

3120 
	}
}

3122 
	$ªloˇã_fûe_exã¡_˛u°î
(
öode
 *inode,

3123 
fûe_exã¡_˛u°î
 *
˛u°î
)

3125 
u64
 
off£t
 = 
	`BTRFS_I
(
öode
)->
ödex_˙t
;

3126 
ödex
;

3127 
œ°_ödex
;

3128 
fûe_ø_°©e
 *
ø
;

3129 
˛u°î_ƒ
 = 0;

3130 
ªt
 = 0;

3132 i‡(!
˛u°î
->
ƒ
)

3135 
ø
 = 
	`kzÆloc
((*ø), 
GFP_NOFS
);

3136 i‡(!
ø
)

3137  -
ENOMEM
;

3139 
ªt
 = 
	`¥óŒoc_fûe_exã¡_˛u°î
(
	`BTRFS_I
(
öode
), 
˛u°î
);

3140 i‡(
ªt
)

3141 
out
;

3143 
	`fûe_ø_°©e_öô
(
ø
, 
öode
->
i_m≠pög
);

3145 
ªt
 = 
	`£tup_ªloˇti⁄_exã¡_m≠pög
(
öode
, 
˛u°î
->
°¨t
 - 
off£t
,

3146 
˛u°î
->
íd
 - 
off£t
, clu°î->
°¨t
);

3147 i‡(
ªt
)

3148 
out
;

3150 
œ°_ödex
 = (
˛u°î
->
íd
 - 
off£t
Ë>> 
PAGE_SHIFT
;

3151 
ödex
 = (
˛u°î
->
°¨t
 - 
off£t
Ë>> 
PAGE_SHIFT
;

3152 
ödex
 <
œ°_ödex
 && !
ªt
; index++)

3153 
ªt
 = 
	`ªloˇã_⁄e_∑ge
(
öode
, 
ø
, 
˛u°î
, &
˛u°î_ƒ
, 
ödex
);

3154 i‡(
ªt
 == 0)

3155 
	`WARN_ON
(
˛u°î_ƒ
 !
˛u°î
->
ƒ
);

3156 
out
:

3157 
	`k‰ì
(
ø
);

3158  
ªt
;

3159 
	}
}

3161 
noölöe_f‹_°ack


3162 
	$ªloˇã_d©a_exã¡
(
öode
 *öode, 
båfs_key
 *
exã¡_key
,

3163 
fûe_exã¡_˛u°î
 *
˛u°î
)

3165 
ªt
;

3167 i‡(
˛u°î
->
ƒ
 > 0 && 
exã¡_key
->
obje˘id
 !˛u°î->
íd
 + 1) {

3168 
ªt
 = 
	`ªloˇã_fûe_exã¡_˛u°î
(
öode
, 
˛u°î
);

3169 i‡(
ªt
)

3170  
ªt
;

3171 
˛u°î
->
ƒ
 = 0;

3174 i‡(!
˛u°î
->
ƒ
)

3175 
˛u°î
->
°¨t
 = 
exã¡_key
->
obje˘id
;

3177 
	`BUG_ON
(
˛u°î
->
ƒ
 >
MAX_EXTENTS
);

3178 
˛u°î
->
íd
 = 
exã¡_key
->
obje˘id
 +Éxã¡_key->
off£t
 - 1;

3179 
˛u°î
->
bound¨y
[˛u°î->
ƒ
] = 
exã¡_key
->
obje˘id
;

3180 
˛u°î
->
ƒ
++;

3182 i‡(
˛u°î
->
ƒ
 >
MAX_EXTENTS
) {

3183 
ªt
 = 
	`ªloˇã_fûe_exã¡_˛u°î
(
öode
, 
˛u°î
);

3184 i‡(
ªt
)

3185  
ªt
;

3186 
˛u°î
->
ƒ
 = 0;

3189 
	}
}

3195 
	$add_åì_block
(
ªloc_c⁄åﬁ
 *
rc
,

3196 
båfs_key
 *
exã¡_key
,

3197 
båfs_∑th
 *
∑th
,

3198 
rb_roŸ
 *
blocks
)

3200 
exã¡_buf„r
 *
eb
;

3201 
båfs_exã¡_ôem
 *
ei
;

3202 
båfs_åì_block_öfo
 *
bi
;

3203 
åì_block
 *
block
;

3204 
rb_node
 *rb_node;

3205 
u32
 
ôem_size
;

3206 
Àvñ
 = -1;

3207 
u64
 
gíî©i⁄
;

3208 
u64
 
ow√r
 = 0;

3210 
eb
 = 
∑th
->
nodes
[0];

3211 
ôem_size
 = 
	`båfs_ôem_size
(
eb
, 
∑th
->
¶Ÿs
[0]);

3213 i‡(
exã¡_key
->
ty≥
 =
BTRFS_METADATA_ITEM_KEY
 ||

3214 
ôem_size
 >(*
ei
Ë+ (*
bi
)) {

3215 
±r
 = 0, 
íd
;

3217 
ei
 = 
	`båfs_ôem_±r
(
eb
, 
∑th
->
¶Ÿs
[0],

3218 
båfs_exã¡_ôem
);

3219 
íd
 = ()
ei
 + 
ôem_size
;

3220 i‡(
exã¡_key
->
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
) {

3221 
bi
 = (
båfs_åì_block_öfo
 *)(
ei
 + 1);

3222 
Àvñ
 = 
	`båfs_åì_block_Àvñ
(
eb
, 
bi
);

3223 
±r
 = ()(
bi
 + 1);

3225 
Àvñ
 = ()
exã¡_key
->
off£t
;

3226 
±r
 = ()(
ei
 + 1);

3228 
gíî©i⁄
 = 
	`båfs_exã¡_gíî©i⁄
(
eb
, 
ei
);

3245 i‡(
	`båfs_exã¡_ªfs
(
eb
, 
ei
) == 1 &&

3246 !(
	`båfs_exã¡_Êags
(
eb
, 
ei
) &

3247 
BTRFS_BLOCK_FLAG_FULL_BACKREF
) &&

3248 
±r
 < 
íd
) {

3249 
båfs_exã¡_ölöe_ªf
 *
úef
;

3250 
ty≥
;

3252 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)
±r
;

3253 
ty≥
 = 
	`båfs_gë_exã¡_ölöe_ªf_ty≥
(
eb
, 
úef
,

3254 
BTRFS_REF_TYPE_BLOCK
);

3255 i‡(
ty≥
 =
BTRFS_REF_TYPE_INVALID
)

3256  -
EINVAL
;

3257 i‡(
ty≥
 =
BTRFS_TREE_BLOCK_REF_KEY
)

3258 
ow√r
 = 
	`båfs_exã¡_ölöe_ªf_off£t
(
eb
, 
úef
);

3261 
	`båfs_¥öt_Àaf
(
eb
);

3262 
	`båfs_îr
(
rc
->
block_group
->
fs_öfo
,

3264 
eb
->
°¨t
, 
∑th
->
¶Ÿs
[0]);

3265 
	`båfs_ªÀa£_∑th
(
∑th
);

3266  -
EUCLEAN
;

3269 
	`båfs_ªÀa£_∑th
(
∑th
);

3271 
	`BUG_ON
(
Àvñ
 == -1);

3273 
block
 = 
	`kmÆloc
((*block), 
GFP_NOFS
);

3274 i‡(!
block
)

3275  -
ENOMEM
;

3277 
block
->
byãƒ
 = 
exã¡_key
->
obje˘id
;

3278 
block
->
key
.
obje˘id
 = 
rc
->
exã¡_roŸ
->
fs_öfo
->
nodesize
;

3279 
block
->
key
.
off£t
 = 
gíî©i⁄
;

3280 
block
->
Àvñ
 =Üevel;

3281 
block
->
key_ªady
 = 0;

3282 
block
->
ow√r
 = owner;

3284 
rb_node
 = 
	`rb_sim∂e_ö£π
(
blocks
, 
block
->
byãƒ
, &block->rb_node);

3285 i‡(
rb_node
)

3286 
	`båfs_backªf_∑nic
(
rc
->
exã¡_roŸ
->
fs_öfo
, 
block
->
byãƒ
,

3287 -
EEXIST
);

3290 
	}
}

3295 
	$__add_åì_block
(
ªloc_c⁄åﬁ
 *
rc
,

3296 
u64
 
byãƒ
, 
u32
 
blocksize
,

3297 
rb_roŸ
 *
blocks
)

3299 
båfs_fs_öfo
 *
fs_öfo
 = 
rc
->
exã¡_roŸ
->fs_info;

3300 
båfs_∑th
 *
∑th
;

3301 
båfs_key
 
key
;

3302 
ªt
;

3303 
boﬁ
 
sköny
 = 
	`båfs_fs_öcom∑t
(
fs_öfo
, 
SKINNY_METADATA
);

3305 i‡(
	`åì_block_¥o˚s£d
(
byãƒ
, 
rc
))

3308 i‡(
	`rb_sim∂e_£¨ch
(
blocks
, 
byãƒ
))

3311 
∑th
 = 
	`båfs_Æloc_∑th
();

3312 i‡(!
∑th
)

3313  -
ENOMEM
;

3314 
agaö
:

3315 
key
.
obje˘id
 = 
byãƒ
;

3316 i‡(
sköny
) {

3317 
key
.
ty≥
 = 
BTRFS_METADATA_ITEM_KEY
;

3318 
key
.
off£t
 = (
u64
)-1;

3320 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

3321 
key
.
off£t
 = 
blocksize
;

3324 
∑th
->
£¨ch_commô_roŸ
 = 1;

3325 
∑th
->
skù_lockög
 = 1;

3326 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
rc
->
exã¡_roŸ
, &
key
, 
∑th
, 0, 0);

3327 i‡(
ªt
 < 0)

3328 
out
;

3330 i‡(
ªt
 > 0 && 
sköny
) {

3331 i‡(
∑th
->
¶Ÿs
[0]) {

3332 
∑th
->
¶Ÿs
[0]--;

3333 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,

3334 
∑th
->
¶Ÿs
[0]);

3335 i‡(
key
.
obje˘id
 =
byãƒ
 &&

3336 (
key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
 ||

3337 (
key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 &&

3338 
key
.
off£t
 =
blocksize
)))

3339 
ªt
 = 0;

3342 i‡(
ªt
) {

3343 
sköny
 = 
Ál£
;

3344 
	`båfs_ªÀa£_∑th
(
∑th
);

3345 
agaö
;

3348 i‡(
ªt
) {

3349 
	`ASSERT
(
ªt
 == 1);

3350 
	`båfs_¥öt_Àaf
(
∑th
->
nodes
[0]);

3351 
	`båfs_îr
(
fs_öfo
,

3353 
byãƒ
);

3354 
	`WARN_ON
(1);

3355 
ªt
 = -
EINVAL
;

3356 
out
;

3359 
ªt
 = 
	`add_åì_block
(
rc
, &
key
, 
∑th
, 
blocks
);

3360 
out
:

3361 
	`båfs_‰ì_∑th
(
∑th
);

3362  
ªt
;

3363 
	}
}

3365 
	$dñëe_block_group_ˇche
(
båfs_fs_öfo
 *
fs_öfo
,

3366 
båfs_block_group
 *
block_group
,

3367 
öode
 *inode,

3368 
u64
 
öo
)

3370 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
åì_roŸ
;

3371 
båfs_å™s_h™dÀ
 *
å™s
;

3372 
ªt
 = 0;

3374 i‡(
öode
)

3375 
åunˇã
;

3377 
öode
 = 
	`båfs_igë
(
fs_öfo
->
sb
, 
öo
, 
roŸ
);

3378 i‡(
	`IS_ERR
(
öode
))

3379  -
ENOENT
;

3381 
åunˇã
:

3382 
ªt
 = 
	`båfs_check_åunc_ˇche_‰ì_•a˚
(
fs_öfo
,

3383 &
fs_öfo
->
globÆ_block_rsv
);

3384 i‡(
ªt
)

3385 
out
;

3387 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
roŸ
);

3388 i‡(
	`IS_ERR
(
å™s
)) {

3389 
ªt
 = 
	`PTR_ERR
(
å™s
);

3390 
out
;

3393 
ªt
 = 
	`båfs_åunˇã_‰ì_•a˚_ˇche
(
å™s
, 
block_group
, 
öode
);

3395 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

3396 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

3397 
out
:

3398 
	`ùut
(
öode
);

3399  
ªt
;

3400 
	}
}

3406 
	$dñëe_v1_•a˚_ˇche
(
exã¡_buf„r
 *
Àaf
,

3407 
båfs_block_group
 *
block_group
,

3408 
u64
 
d©a_byãƒ
)

3410 
u64
 
•a˚_ˇche_öo
;

3411 
båfs_fûe_exã¡_ôem
 *
ei
;

3412 
båfs_key
 
key
;

3413 
boﬁ
 
found
 = 
Ál£
;

3414 
i
;

3415 
ªt
;

3417 i‡(
	`båfs_hódî_ow√r
(
Àaf
Ë!
BTRFS_ROOT_TREE_OBJECTID
)

3420 
i
 = 0; i < 
	`båfs_hódî_ƒôems
(
Àaf
); i++) {

3421 
u8
 
ty≥
;

3423 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
i
);

3424 i‡(
key
.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

3426 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
i
, 
båfs_fûe_exã¡_ôem
);

3427 
ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
ei
);

3429 i‡((
ty≥
 =
BTRFS_FILE_EXTENT_REG
 ||

3430 
ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
) &&

3431 
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
ei
Ë=
d©a_byãƒ
) {

3432 
found
 = 
åue
;

3433 
•a˚_ˇche_öo
 = 
key
.
obje˘id
;

3437 i‡(!
found
)

3438  -
ENOENT
;

3439 
ªt
 = 
	`dñëe_block_group_ˇche
(
Àaf
->
fs_öfo
, 
block_group
, 
NULL
,

3440 
•a˚_ˇche_öo
);

3441  
ªt
;

3442 
	}
}

3447 
noölöe_f‹_°ack


3448 
	$add_d©a_ª„ªn˚s
(
ªloc_c⁄åﬁ
 *
rc
,

3449 
båfs_key
 *
exã¡_key
,

3450 
båfs_∑th
 *
∑th
,

3451 
rb_roŸ
 *
blocks
)

3453 
båfs_backªf_wÆk_˘x
 
˘x
 = { 0 };

3454 
uli°_ôî©‹
 
Àaf_uôî
;

3455 
uli°_node
 *
ªf_node
 = 
NULL
;

3456 c⁄° 
u32
 
blocksize
 = 
rc
->
exã¡_roŸ
->
fs_öfo
->
nodesize
;

3457 
ªt
 = 0;

3459 
	`båfs_ªÀa£_∑th
(
∑th
);

3461 
˘x
.
byãƒ
 = 
exã¡_key
->
obje˘id
;

3462 
˘x
.
skù_öode_ªf_li°
 = 
åue
;

3463 
˘x
.
fs_öfo
 = 
rc
->
exã¡_roŸ
->fs_info;

3465 
ªt
 = 
	`båfs_föd_Æl_Àafs
(&
˘x
);

3466 i‡(
ªt
 < 0)

3467  
ªt
;

3469 
	`ULIST_ITER_INIT
(&
Àaf_uôî
);

3470 (
ªf_node
 = 
	`uli°_√xt
(
˘x
.
ªfs
, &
Àaf_uôî
))) {

3471 
båfs_åì_∑ª¡_check
 
check
 = { 0 };

3472 
exã¡_buf„r
 *
eb
;

3474 
eb
 = 
	`ªad_åì_block
(
˘x
.
fs_öfo
, 
ªf_node
->
vÆ
, &
check
);

3475 i‡(
	`IS_ERR
(
eb
)) {

3476 
ªt
 = 
	`PTR_ERR
(
eb
);

3479 
ªt
 = 
	`dñëe_v1_•a˚_ˇche
(
eb
, 
rc
->
block_group
,

3480 
exã¡_key
->
obje˘id
);

3481 
	`‰ì_exã¡_buf„r
(
eb
);

3482 i‡(
ªt
 < 0)

3484 
ªt
 = 
	`__add_åì_block
(
rc
, 
ªf_node
->
vÆ
, 
blocksize
, 
blocks
);

3485 i‡(
ªt
 < 0)

3488 i‡(
ªt
 < 0)

3489 
	`‰ì_block_li°
(
blocks
);

3490 
	`uli°_‰ì
(
˘x
.
ªfs
);

3491  
ªt
;

3492 
	}
}

3497 
noölöe_f‹_°ack


3498 
	$föd_√xt_exã¡
(
ªloc_c⁄åﬁ
 *
rc
, 
båfs_∑th
 *
∑th
,

3499 
båfs_key
 *
exã¡_key
)

3501 
båfs_fs_öfo
 *
fs_öfo
 = 
rc
->
exã¡_roŸ
->fs_info;

3502 
båfs_key
 
key
;

3503 
exã¡_buf„r
 *
Àaf
;

3504 
u64
 
°¨t
, 
íd
, 
œ°
;

3505 
ªt
;

3507 
œ°
 = 
rc
->
block_group
->
°¨t
 +Ñc->block_group->
Àngth
;

3509 
boﬁ
 
block_found
;

3511 
	`c⁄d_ªsched
();

3512 i‡(
rc
->
£¨ch_°¨t
 >
œ°
) {

3513 
ªt
 = 1;

3517 
key
.
obje˘id
 = 
rc
->
£¨ch_°¨t
;

3518 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

3519 
key
.
off£t
 = 0;

3521 
∑th
->
£¨ch_commô_roŸ
 = 1;

3522 
∑th
->
skù_lockög
 = 1;

3523 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
rc
->
exã¡_roŸ
, &
key
, 
∑th
,

3525 i‡(
ªt
 < 0)

3527 
√xt
:

3528 
Àaf
 = 
∑th
->
nodes
[0];

3529 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
(
Àaf
)) {

3530 
ªt
 = 
	`båfs_√xt_Àaf
(
rc
->
exã¡_roŸ
, 
∑th
);

3531 i‡(
ªt
 != 0)

3533 
Àaf
 = 
∑th
->
nodes
[0];

3536 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

3537 i‡(
key
.
obje˘id
 >
œ°
) {

3538 
ªt
 = 1;

3542 i‡(
key
.
ty≥
 !
BTRFS_EXTENT_ITEM_KEY
 &&

3543 
key
.
ty≥
 !
BTRFS_METADATA_ITEM_KEY
) {

3544 
∑th
->
¶Ÿs
[0]++;

3545 
√xt
;

3548 i‡(
key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 &&

3549 
key
.
obje˘id
 + key.
off£t
 <
rc
->
£¨ch_°¨t
) {

3550 
∑th
->
¶Ÿs
[0]++;

3551 
√xt
;

3554 i‡(
key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
 &&

3555 
key
.
obje˘id
 + 
fs_öfo
->
nodesize
 <=

3556 
rc
->
£¨ch_°¨t
) {

3557 
∑th
->
¶Ÿs
[0]++;

3558 
√xt
;

3561 
block_found
 = 
	`föd_fú°_exã¡_bô
(&
rc
->
¥o˚s£d_blocks
,

3562 
key
.
obje˘id
, &
°¨t
, &
íd
,

3563 
EXTENT_DIRTY
, 
NULL
);

3565 i‡(
block_found
 && 
°¨t
 <
key
.
obje˘id
) {

3566 
	`båfs_ªÀa£_∑th
(
∑th
);

3567 
rc
->
£¨ch_°¨t
 = 
íd
 + 1;

3569 i‡(
key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
)

3570 
rc
->
£¨ch_°¨t
 = 
key
.
obje˘id
 + key.
off£t
;

3572 
rc
->
£¨ch_°¨t
 = 
key
.
obje˘id
 +

3573 
fs_öfo
->
nodesize
;

3574 
	`mem˝y
(
exã¡_key
, &
key
, (key));

3578 
	`båfs_ªÀa£_∑th
(
∑th
);

3579  
ªt
;

3580 
	}
}

3582 
	$£t_ªloc_c⁄åﬁ
(
ªloc_c⁄åﬁ
 *
rc
)

3584 
båfs_fs_öfo
 *
fs_öfo
 = 
rc
->
exã¡_roŸ
->fs_info;

3586 
	`muãx_lock
(&
fs_öfo
->
ªloc_muãx
);

3587 
fs_öfo
->
ªloc_˘l
 = 
rc
;

3588 
	`muãx_u∆ock
(&
fs_öfo
->
ªloc_muãx
);

3589 
	}
}

3591 
	$un£t_ªloc_c⁄åﬁ
(
ªloc_c⁄åﬁ
 *
rc
)

3593 
båfs_fs_öfo
 *
fs_öfo
 = 
rc
->
exã¡_roŸ
->fs_info;

3595 
	`muãx_lock
(&
fs_öfo
->
ªloc_muãx
);

3596 
fs_öfo
->
ªloc_˘l
 = 
NULL
;

3597 
	`muãx_u∆ock
(&
fs_öfo
->
ªloc_muãx
);

3598 
	}
}

3600 
noölöe_f‹_°ack


3601 
	$¥ï¨e_to_ªloˇã
(
ªloc_c⁄åﬁ
 *
rc
)

3603 
båfs_å™s_h™dÀ
 *
å™s
;

3604 
ªt
;

3606 
rc
->
block_rsv
 = 
	`båfs_Æloc_block_rsv
‘c->
exã¡_roŸ
->
fs_öfo
,

3607 
BTRFS_BLOCK_RSV_TEMP
);

3608 i‡(!
rc
->
block_rsv
)

3609  -
ENOMEM
;

3611 
	`mem£t
(&
rc
->
˛u°î
, 0, (rc->cluster));

3612 
rc
->
£¨ch_°¨t
 =Ñc->
block_group
->
°¨t
;

3613 
rc
->
exã¡s_found
 = 0;

3614 
rc
->
nodes_ªloˇãd
 = 0;

3615 
rc
->
mîgög_rsv_size
 = 0;

3616 
rc
->
ª£rved_byãs
 = 0;

3617 
rc
->
block_rsv
->
size
 =Ñc->
exã¡_roŸ
->
fs_öfo
->
nodesize
 *

3618 
RELOCATION_RESERVED_NODES
;

3619 
ªt
 = 
	`båfs_block_rsv_ªfûl
(
rc
->
exã¡_roŸ
->
fs_öfo
,

3620 
rc
->
block_rsv
,Ñc->block_rsv->
size
,

3621 
BTRFS_RESERVE_FLUSH_ALL
);

3622 i‡(
ªt
)

3623  
ªt
;

3625 
rc
->
¸óã_ªloc_åì
 = 1;

3626 
	`£t_ªloc_c⁄åﬁ
(
rc
);

3628 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
rc
->
exã¡_roŸ
);

3629 i‡(
	`IS_ERR
(
å™s
)) {

3630 
	`un£t_ªloc_c⁄åﬁ
(
rc
);

3636  
	`PTR_ERR
(
å™s
);

3639 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

3640 i‡(
ªt
)

3641 
	`un£t_ªloc_c⁄åﬁ
(
rc
);

3643  
ªt
;

3644 
	}
}

3646 
noölöe_f‹_°ack
 
	$ªloˇã_block_group
(
ªloc_c⁄åﬁ
 *
rc
)

3648 
båfs_fs_öfo
 *
fs_öfo
 = 
rc
->
exã¡_roŸ
->fs_info;

3649 
rb_roŸ
 
blocks
 = 
RB_ROOT
;

3650 
båfs_key
 
key
;

3651 
båfs_å™s_h™dÀ
 *
å™s
 = 
NULL
;

3652 
båfs_∑th
 *
∑th
;

3653 
båfs_exã¡_ôem
 *
ei
;

3654 
u64
 
Êags
;

3655 
ªt
;

3656 
îr
 = 0;

3657 
¥ogªss
 = 0;

3659 
∑th
 = 
	`båfs_Æloc_∑th
();

3660 i‡(!
∑th
)

3661  -
ENOMEM
;

3662 
∑th
->
ªada
 = 
READA_FORWARD
;

3664 
ªt
 = 
	`¥ï¨e_to_ªloˇã
(
rc
);

3665 i‡(
ªt
) {

3666 
îr
 = 
ªt
;

3667 
out_‰ì
;

3671 
rc
->
ª£rved_byãs
 = 0;

3672 
ªt
 = 
	`båfs_block_rsv_ªfûl
(
fs_öfo
, 
rc
->
block_rsv
,

3673 
rc
->
block_rsv
->
size
,

3674 
BTRFS_RESERVE_FLUSH_ALL
);

3675 i‡(
ªt
) {

3676 
îr
 = 
ªt
;

3679 
¥ogªss
++;

3680 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
rc
->
exã¡_roŸ
, 0);

3681 i‡(
	`IS_ERR
(
å™s
)) {

3682 
îr
 = 
	`PTR_ERR
(
å™s
);

3683 
å™s
 = 
NULL
;

3686 
ª°¨t
:

3687 i‡(
	`upd©e_backªf_ˇche
(
å™s
, &
rc
->
backªf_ˇche
)) {

3688 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

3689 
å™s
 = 
NULL
;

3693 
ªt
 = 
	`föd_√xt_exã¡
(
rc
, 
∑th
, &
key
);

3694 i‡(
ªt
 < 0)

3695 
îr
 = 
ªt
;

3696 i‡(
ªt
 != 0)

3699 
rc
->
exã¡s_found
++;

3701 
ei
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

3702 
båfs_exã¡_ôem
);

3703 
Êags
 = 
	`båfs_exã¡_Êags
(
∑th
->
nodes
[0], 
ei
);

3705 i‡(
Êags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

3706 
ªt
 = 
	`add_åì_block
(
rc
, &
key
, 
∑th
, &
blocks
);

3707 } i‡(
rc
->
°age
 =
UPDATE_DATA_PTRS
 &&

3708 (
Êags
 & 
BTRFS_EXTENT_FLAG_DATA
)) {

3709 
ªt
 = 
	`add_d©a_ª„ªn˚s
(
rc
, &
key
, 
∑th
, &
blocks
);

3711 
	`båfs_ªÀa£_∑th
(
∑th
);

3712 
ªt
 = 0;

3714 i‡(
ªt
 < 0) {

3715 
îr
 = 
ªt
;

3719 i‡(!
	`RB_EMPTY_ROOT
(&
blocks
)) {

3720 
ªt
 = 
	`ªloˇã_åì_blocks
(
å™s
, 
rc
, &
blocks
);

3721 i‡(
ªt
 < 0) {

3722 i‡(
ªt
 !-
EAGAIN
) {

3723 
îr
 = 
ªt
;

3726 
rc
->
exã¡s_found
--;

3727 
rc
->
£¨ch_°¨t
 = 
key
.
obje˘id
;

3731 
	`båfs_íd_å™ß˘i⁄_thrŸée
(
å™s
);

3732 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

3733 
å™s
 = 
NULL
;

3735 i‡(
rc
->
°age
 =
MOVE_DATA_EXTENTS
 &&

3736 (
Êags
 & 
BTRFS_EXTENT_FLAG_DATA
)) {

3737 
rc
->
found_fûe_exã¡
 = 1;

3738 
ªt
 = 
	`ªloˇã_d©a_exã¡
(
rc
->
d©a_öode
,

3739 &
key
, &
rc
->
˛u°î
);

3740 i‡(
ªt
 < 0) {

3741 
îr
 = 
ªt
;

3745 i‡(
	`båfs_should_ˇn˚l_bÆ™˚
(
fs_öfo
)) {

3746 
îr
 = -
ECANCELED
;

3750 i‡(
å™s
 && 
¥ogªss
 && 
îr
 =-
ENOSPC
) {

3751 
ªt
 = 
	`båfs_f‹˚_chunk_Æloc
(
å™s
, 
rc
->
block_group
->
Êags
);

3752 i‡(
ªt
 == 1) {

3753 
îr
 = 0;

3754 
¥ogªss
 = 0;

3755 
ª°¨t
;

3759 
	`båfs_ªÀa£_∑th
(
∑th
);

3760 
	`˛ór_exã¡_bôs
(&
rc
->
¥o˚s£d_blocks
, 0, (
u64
)-1, 
EXTENT_DIRTY
);

3762 i‡(
å™s
) {

3763 
	`båfs_íd_å™ß˘i⁄_thrŸée
(
å™s
);

3764 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

3767 i‡(!
îr
) {

3768 
ªt
 = 
	`ªloˇã_fûe_exã¡_˛u°î
(
rc
->
d©a_öode
,

3769 &
rc
->
˛u°î
);

3770 i‡(
ªt
 < 0)

3771 
îr
 = 
ªt
;

3774 
rc
->
¸óã_ªloc_åì
 = 0;

3775 
	`£t_ªloc_c⁄åﬁ
(
rc
);

3777 
	`båfs_backªf_ªÀa£_ˇche
(&
rc
->
backªf_ˇche
);

3778 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, 
rc
->
block_rsv
, (
u64
)-1, 
NULL
);

3788 
îr
 = 
	`¥ï¨e_to_mîge
(
rc
,Érr);

3790 
	`mîge_ªloc_roŸs
(
rc
);

3792 
rc
->
mîge_ªloc_åì
 = 0;

3793 
	`un£t_ªloc_c⁄åﬁ
(
rc
);

3794 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, 
rc
->
block_rsv
, (
u64
)-1, 
NULL
);

3797 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
rc
->
exã¡_roŸ
);

3798 i‡(
	`IS_ERR
(
å™s
)) {

3799 
îr
 = 
	`PTR_ERR
(
å™s
);

3800 
out_‰ì
;

3802 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

3803 i‡(
ªt
 && !
îr
)

3804 
îr
 = 
ªt
;

3805 
out_‰ì
:

3806 
ªt
 = 
	`˛ón_dúty_subvﬁs
(
rc
);

3807 i‡(
ªt
 < 0 && !
îr
)

3808 
îr
 = 
ªt
;

3809 
	`båfs_‰ì_block_rsv
(
fs_öfo
, 
rc
->
block_rsv
);

3810 
	`båfs_‰ì_∑th
(
∑th
);

3811  
îr
;

3812 
	}
}

3814 
	$__ö£π_‹ph™_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

3815 
båfs_roŸ
 *
roŸ
, 
u64
 
obje˘id
)

3817 
båfs_∑th
 *
∑th
;

3818 
båfs_öode_ôem
 *
ôem
;

3819 
exã¡_buf„r
 *
Àaf
;

3820 
ªt
;

3822 
∑th
 = 
	`båfs_Æloc_∑th
();

3823 i‡(!
∑th
)

3824  -
ENOMEM
;

3826 
ªt
 = 
	`båfs_ö£π_em±y_öode
(
å™s
, 
roŸ
, 
∑th
, 
obje˘id
);

3827 i‡(
ªt
)

3828 
out
;

3830 
Àaf
 = 
∑th
->
nodes
[0];

3831 
ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_öode_ôem
);

3832 
	`memzîo_exã¡_buf„r
(
Àaf
, ()
ôem
, (*item));

3833 
	`båfs_£t_öode_gíî©i⁄
(
Àaf
, 
ôem
, 1);

3834 
	`båfs_£t_öode_size
(
Àaf
, 
ôem
, 0);

3835 
	`båfs_£t_öode_mode
(
Àaf
, 
ôem
, 
S_IFREG
 | 0600);

3836 
	`båfs_£t_öode_Êags
(
Àaf
, 
ôem
, 
BTRFS_INODE_NOCOMPRESS
 |

3837 
BTRFS_INODE_PREALLOC
);

3838 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

3839 
out
:

3840 
	`båfs_‰ì_∑th
(
∑th
);

3841  
ªt
;

3842 
	}
}

3844 
	$dñëe_‹ph™_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

3845 
båfs_roŸ
 *
roŸ
, 
u64
 
obje˘id
)

3847 
båfs_∑th
 *
∑th
;

3848 
båfs_key
 
key
;

3849 
ªt
 = 0;

3851 
∑th
 = 
	`båfs_Æloc_∑th
();

3852 i‡(!
∑th
) {

3853 
ªt
 = -
ENOMEM
;

3854 
out
;

3857 
key
.
obje˘id
 = objectid;

3858 
key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

3859 
key
.
off£t
 = 0;

3860 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

3861 i‡(
ªt
) {

3862 i‡(
ªt
 > 0)

3863 
ªt
 = -
ENOENT
;

3864 
out
;

3866 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

3867 
out
:

3868 i‡(
ªt
)

3869 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3870 
	`båfs_‰ì_∑th
(
∑th
);

3871 
	}
}

3877 
noölöe_f‹_°ack


3878 
öode
 *
	$¸óã_ªloc_öode
(
båfs_fs_öfo
 *
fs_öfo
,

3879 
båfs_block_group
 *
group
)

3881 
öode
 *öodê
NULL
;

3882 
båfs_å™s_h™dÀ
 *
å™s
;

3883 
båfs_roŸ
 *
roŸ
;

3884 
u64
 
obje˘id
;

3885 
îr
 = 0;

3887 
roŸ
 = 
	`båfs_gøb_roŸ
(
fs_öfo
->
d©a_ªloc_roŸ
);

3888 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 6);

3889 i‡(
	`IS_ERR
(
å™s
)) {

3890 
	`båfs_put_roŸ
(
roŸ
);

3891  
	`ERR_CAST
(
å™s
);

3894 
îr
 = 
	`båfs_gë_‰ì_obje˘id
(
roŸ
, &
obje˘id
);

3895 i‡(
îr
)

3896 
out
;

3898 
îr
 = 
	`__ö£π_‹ph™_öode
(
å™s
, 
roŸ
, 
obje˘id
);

3899 i‡(
îr
)

3900 
out
;

3902 
öode
 = 
	`båfs_igë
(
fs_öfo
->
sb
, 
obje˘id
, 
roŸ
);

3903 i‡(
	`IS_ERR
(
öode
)) {

3904 
	`dñëe_‹ph™_öode
(
å™s
, 
roŸ
, 
obje˘id
);

3905 
îr
 = 
	`PTR_ERR
(
öode
);

3906 
öode
 = 
NULL
;

3907 
out
;

3909 
	`BTRFS_I
(
öode
)->
ödex_˙t
 = 
group
->
°¨t
;

3911 
îr
 = 
	`båfs_‹ph™_add
(
å™s
, 
	`BTRFS_I
(
öode
));

3912 
out
:

3913 
	`båfs_put_roŸ
(
roŸ
);

3914 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

3915 
	`båfs_båì_bÆ™˚_dúty
(
fs_öfo
);

3916 i‡(
îr
) {

3917 
	`ùut
(
öode
);

3918 
öode
 = 
	`ERR_PTR
(
îr
);

3920  
öode
;

3921 
	}
}

3932 
	$ªloc_chunk_°¨t
(
båfs_fs_öfo
 *
fs_öfo
)

3934 i‡(
	`ã°_™d_£t_bô
(
BTRFS_FS_RELOC_RUNNING
, &
fs_öfo
->
Êags
)) {

3936 
	`båfs_îr
(
fs_öfo
, "relocálreadyÑunning, cannot start");

3937  -
EINPROGRESS
;

3940 i‡(
	`©omic_ªad
(&
fs_öfo
->
ªloc_ˇn˚l_ªq
) > 0) {

3941 
	`båfs_öfo
(
fs_öfo
, "chunkÑelocation canceled on start");

3946 
	`©omic_£t
(&
fs_öfo
->
ªloc_ˇn˚l_ªq
, 0);

3947  -
ECANCELED
;

3950 
	}
}

3955 
	$ªloc_chunk_íd
(
båfs_fs_öfo
 *
fs_öfo
)

3958 i‡(
	`©omic_ªad
(&
fs_öfo
->
ªloc_ˇn˚l_ªq
) > 0)

3959 
	`båfs_öfo
(
fs_öfo
, "chunkÑelocation canceled during operation");

3960 
	`˛ór_™d_wake_up_bô
(
BTRFS_FS_RELOC_RUNNING
, &
fs_öfo
->
Êags
);

3961 
	`©omic_£t
(&
fs_öfo
->
ªloc_ˇn˚l_ªq
, 0);

3962 
	}
}

3964 
ªloc_c⁄åﬁ
 *
	$Æloc_ªloc_c⁄åﬁ
(
båfs_fs_öfo
 *
fs_öfo
)

3966 
ªloc_c⁄åﬁ
 *
rc
;

3968 
rc
 = 
	`kzÆloc
((*rc), 
GFP_NOFS
);

3969 i‡(!
rc
)

3970  
NULL
;

3972 
	`INIT_LIST_HEAD
(&
rc
->
ªloc_roŸs
);

3973 
	`INIT_LIST_HEAD
(&
rc
->
dúty_subvﬁ_roŸs
);

3974 
	`båfs_backªf_öô_ˇche
(
fs_öfo
, &
rc
->
backªf_ˇche
, 1);

3975 
	`m≠pög_åì_öô
(&
rc
->
ªloc_roŸ_åì
);

3976 
	`exã¡_io_åì_öô
(
fs_öfo
, &
rc
->
¥o˚s£d_blocks
, 
IO_TREE_RELOC_BLOCKS
);

3977  
rc
;

3978 
	}
}

3980 
	$‰ì_ªloc_c⁄åﬁ
(
ªloc_c⁄åﬁ
 *
rc
)

3982 
m≠pög_node
 *
node
, *
tmp
;

3984 
	`‰ì_ªloc_roŸs
(&
rc
->
ªloc_roŸs
);

3985 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
node
, 
tmp
,

3986 &
rc
->
ªloc_roŸ_åì
.
rb_roŸ
, 
rb_node
)

3987 
	`k‰ì
(
node
);

3989 
	`k‰ì
(
rc
);

3990 
	}
}

3995 
	$des¸ibe_ªloˇti⁄
(
båfs_fs_öfo
 *
fs_öfo
,

3996 
båfs_block_group
 *
block_group
)

3998 
buf
[128] = {'\0'};

4000 
	`båfs_des¸ibe_block_groups
(
block_group
->
Êags
, 
buf
, (buf));

4002 
	`båfs_öfo
(
fs_öfo
,

4004 
block_group
->
°¨t
, 
buf
);

4005 
	}
}

4007 c⁄° *
	$°age_to_°rög
(
°age
)

4009 i‡(
°age
 =
MOVE_DATA_EXTENTS
)

4011 i‡(
°age
 =
UPDATE_DATA_PTRS
)

4014 
	}
}

4019 
	$båfs_ªloˇã_block_group
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
group_°¨t
)

4021 
båfs_block_group
 *
bg
;

4022 
båfs_roŸ
 *
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
, 
group_°¨t
);

4023 
ªloc_c⁄åﬁ
 *
rc
;

4024 
öode
 *inode;

4025 
båfs_∑th
 *
∑th
;

4026 
ªt
;

4027 
rw
 = 0;

4028 
îr
 = 0;

4035 
ªt
 = 
	`waô_⁄_bô
(&
fs_öfo
->
Êags
, 
BTRFS_FS_UNFINISHED_DROPS
, 
TASK_INTERRUPTIBLE
);

4036 i‡(
ªt
)

4037  
ªt
;

4040 i‡(
	`båfs_fs_˛osög
(
fs_öfo
))

4041  -
EINTR
;

4043 
bg
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
group_°¨t
);

4044 i‡(!
bg
)

4045  -
ENOENT
;

4055 i‡(
bg
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
)

4056 
	`ASSERT
(
	`sb_wrôe_°¨ãd
(
fs_öfo
->
sb
));

4058 i‡(
	`båfs_pö√d_by_sw≠fûe
(
fs_öfo
, 
bg
)) {

4059 
	`båfs_put_block_group
(
bg
);

4060  -
ETXTBSY
;

4063 
rc
 = 
	`Æloc_ªloc_c⁄åﬁ
(
fs_öfo
);

4064 i‡(!
rc
) {

4065 
	`båfs_put_block_group
(
bg
);

4066  -
ENOMEM
;

4069 
ªt
 = 
	`ªloc_chunk_°¨t
(
fs_öfo
);

4070 i‡(
ªt
 < 0) {

4071 
îr
 = 
ªt
;

4072 
out_put_bg
;

4075 
rc
->
exã¡_roŸ
 =Éxtent_root;

4076 
rc
->
block_group
 = 
bg
;

4078 
ªt
 = 
	`båfs_öc_block_group_ro
(
rc
->
block_group
, 
åue
);

4079 i‡(
ªt
) {

4080 
îr
 = 
ªt
;

4081 
out
;

4083 
rw
 = 1;

4085 
∑th
 = 
	`båfs_Æloc_∑th
();

4086 i‡(!
∑th
) {

4087 
îr
 = -
ENOMEM
;

4088 
out
;

4091 
öode
 = 
	`lookup_‰ì_•a˚_öode
(
rc
->
block_group
, 
∑th
);

4092 
	`båfs_‰ì_∑th
(
∑th
);

4094 i‡(!
	`IS_ERR
(
öode
))

4095 
ªt
 = 
	`dñëe_block_group_ˇche
(
fs_öfo
, 
rc
->
block_group
, 
öode
, 0);

4097 
ªt
 = 
	`PTR_ERR
(
öode
);

4099 i‡(
ªt
 &&Ñë !-
ENOENT
) {

4100 
îr
 = 
ªt
;

4101 
out
;

4104 
rc
->
d©a_öode
 = 
	`¸óã_ªloc_öode
(
fs_öfo
,Ñc->
block_group
);

4105 i‡(
	`IS_ERR
(
rc
->
d©a_öode
)) {

4106 
îr
 = 
	`PTR_ERR
(
rc
->
d©a_öode
);

4107 
rc
->
d©a_öode
 = 
NULL
;

4108 
out
;

4111 
	`des¸ibe_ªloˇti⁄
(
fs_öfo
, 
rc
->
block_group
);

4113 
	`båfs_waô_block_group_ª£rv©i⁄s
(
rc
->
block_group
);

4114 
	`båfs_waô_nocow_wrôîs
(
rc
->
block_group
);

4115 
	`båfs_waô_‹dîed_roŸs
(
fs_öfo
, 
U64_MAX
,

4116 
rc
->
block_group
->
°¨t
,

4117 
rc
->
block_group
->
Àngth
);

4119 
ªt
 = 
	`båfs_z⁄e_föish
(
rc
->
block_group
);

4120 
	`WARN_ON
(
ªt
 &&Ñë !-
EAGAIN
);

4123 
föishes_°age
;

4125 
	`muãx_lock
(&
fs_öfo
->
˛ó√r_muãx
);

4126 
ªt
 = 
	`ªloˇã_block_group
(
rc
);

4127 
	`muãx_u∆ock
(&
fs_öfo
->
˛ó√r_muãx
);

4128 i‡(
ªt
 < 0)

4129 
îr
 = 
ªt
;

4131 
föishes_°age
 = 
rc
->
°age
;

4141 i‡(
rc
->
°age
 =
MOVE_DATA_EXTENTS
 &&Ñc->
found_fûe_exã¡
) {

4142 
ªt
 = 
	`båfs_waô_‹dîed_ønge
(
rc
->
d©a_öode
, 0,

4143 (
u64
)-1);

4144 i‡(
ªt
)

4145 
îr
 = 
ªt
;

4146 
	`övÆid©e_m≠pög_∑ges
(
rc
->
d©a_öode
->
i_m≠pög
,

4148 
rc
->
°age
 = 
UPDATE_DATA_PTRS
;

4151 i‡(
îr
 < 0)

4152 
out
;

4154 i‡(
rc
->
exã¡s_found
 == 0)

4157 
	`båfs_öfo
(
fs_öfo
, "found %lluÉxtents, stage: %s",

4158 
rc
->
exã¡s_found
, 
	`°age_to_°rög
(
föishes_°age
));

4161 
	`WARN_ON
(
rc
->
block_group
->
pö√d
 > 0);

4162 
	`WARN_ON
(
rc
->
block_group
->
ª£rved
 > 0);

4163 
	`WARN_ON
(
rc
->
block_group
->
u£d
 > 0);

4164 
out
:

4165 i‡(
îr
 && 
rw
)

4166 
	`båfs_dec_block_group_ro
(
rc
->
block_group
);

4167 
	`ùut
(
rc
->
d©a_öode
);

4168 
out_put_bg
:

4169 
	`båfs_put_block_group
(
bg
);

4170 
	`ªloc_chunk_íd
(
fs_öfo
);

4171 
	`‰ì_ªloc_c⁄åﬁ
(
rc
);

4172  
îr
;

4173 
	}
}

4175 
noölöe_f‹_°ack
 
	$m¨k_g¨bage_roŸ
(
båfs_roŸ
 *
roŸ
)

4177 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4178 
båfs_å™s_h™dÀ
 *
å™s
;

4179 
ªt
, 
îr
;

4181 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
fs_öfo
->
åì_roŸ
, 0);

4182 i‡(
	`IS_ERR
(
å™s
))

4183  
	`PTR_ERR
(
å™s
);

4185 
	`mem£t
(&
roŸ
->
roŸ_ôem
.
dr›_¥ogªss
, 0,

4186 (
roŸ
->
roŸ_ôem
.
dr›_¥ogªss
));

4187 
	`båfs_£t_roŸ_dr›_Àvñ
(&
roŸ
->
roŸ_ôem
, 0);

4188 
	`båfs_£t_roŸ_ªfs
(&
roŸ
->
roŸ_ôem
, 0);

4189 
ªt
 = 
	`båfs_upd©e_roŸ
(
å™s
, 
fs_öfo
->
åì_roŸ
,

4190 &
roŸ
->
roŸ_key
, &roŸ->
roŸ_ôem
);

4192 
îr
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

4193 i‡(
îr
)

4194  
îr
;

4195  
ªt
;

4196 
	}
}

4204 
	$båfs_ªcovî_ªloˇti⁄
(
båfs_fs_öfo
 *
fs_öfo
)

4206 
	`LIST_HEAD
(
ªloc_roŸs
);

4207 
båfs_key
 
key
;

4208 
båfs_roŸ
 *
fs_roŸ
;

4209 
båfs_roŸ
 *
ªloc_roŸ
;

4210 
båfs_∑th
 *
∑th
;

4211 
exã¡_buf„r
 *
Àaf
;

4212 
ªloc_c⁄åﬁ
 *
rc
 = 
NULL
;

4213 
båfs_å™s_h™dÀ
 *
å™s
;

4214 
ªt
;

4215 
îr
 = 0;

4217 
∑th
 = 
	`båfs_Æloc_∑th
();

4218 i‡(!
∑th
)

4219  -
ENOMEM
;

4220 
∑th
->
ªada
 = 
READA_BACK
;

4222 
key
.
obje˘id
 = 
BTRFS_TREE_RELOC_OBJECTID
;

4223 
key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

4224 
key
.
off£t
 = (
u64
)-1;

4227 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
fs_öfo
->
åì_roŸ
, &
key
,

4228 
∑th
, 0, 0);

4229 i‡(
ªt
 < 0) {

4230 
îr
 = 
ªt
;

4231 
out
;

4233 i‡(
ªt
 > 0) {

4234 i‡(
∑th
->
¶Ÿs
[0] == 0)

4236 
∑th
->
¶Ÿs
[0]--;

4238 
Àaf
 = 
∑th
->
nodes
[0];

4239 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

4240 
	`båfs_ªÀa£_∑th
(
∑th
);

4242 i‡(
key
.
obje˘id
 !
BTRFS_TREE_RELOC_OBJECTID
 ||

4243 
key
.
ty≥
 !
BTRFS_ROOT_ITEM_KEY
)

4246 
ªloc_roŸ
 = 
	`båfs_ªad_åì_roŸ
(
fs_öfo
->
åì_roŸ
, &
key
);

4247 i‡(
	`IS_ERR
(
ªloc_roŸ
)) {

4248 
îr
 = 
	`PTR_ERR
(
ªloc_roŸ
);

4249 
out
;

4252 
	`£t_bô
(
BTRFS_ROOT_SHAREABLE
, &
ªloc_roŸ
->
°©e
);

4253 
	`li°_add
(&
ªloc_roŸ
->
roŸ_li°
, &
ªloc_roŸs
);

4255 i‡(
	`båfs_roŸ_ªfs
(&
ªloc_roŸ
->
roŸ_ôem
) > 0) {

4256 
fs_roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
,

4257 
ªloc_roŸ
->
roŸ_key
.
off£t
, 
Ál£
);

4258 i‡(
	`IS_ERR
(
fs_roŸ
)) {

4259 
ªt
 = 
	`PTR_ERR
(
fs_roŸ
);

4260 i‡(
ªt
 !-
ENOENT
) {

4261 
îr
 = 
ªt
;

4262 
out
;

4264 
ªt
 = 
	`m¨k_g¨bage_roŸ
(
ªloc_roŸ
);

4265 i‡(
ªt
 < 0) {

4266 
îr
 = 
ªt
;

4267 
out
;

4270 
	`båfs_put_roŸ
(
fs_roŸ
);

4274 i‡(
key
.
off£t
 == 0)

4277 
key
.
off£t
--;

4279 
	`båfs_ªÀa£_∑th
(
∑th
);

4281 i‡(
	`li°_em±y
(&
ªloc_roŸs
))

4282 
out
;

4284 
rc
 = 
	`Æloc_ªloc_c⁄åﬁ
(
fs_öfo
);

4285 i‡(!
rc
) {

4286 
îr
 = -
ENOMEM
;

4287 
out
;

4290 
ªt
 = 
	`ªloc_chunk_°¨t
(
fs_öfo
);

4291 i‡(
ªt
 < 0) {

4292 
îr
 = 
ªt
;

4293 
out_íd
;

4296 
rc
->
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
, 0);

4298 
	`£t_ªloc_c⁄åﬁ
(
rc
);

4300 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
rc
->
exã¡_roŸ
);

4301 i‡(
	`IS_ERR
(
å™s
)) {

4302 
îr
 = 
	`PTR_ERR
(
å™s
);

4303 
out_un£t
;

4306 
rc
->
mîge_ªloc_åì
 = 1;

4308 !
	`li°_em±y
(&
ªloc_roŸs
)) {

4309 
ªloc_roŸ
 = 
	`li°_íåy
(
ªloc_roŸs
.
√xt
,

4310 
båfs_roŸ
, 
roŸ_li°
);

4311 
	`li°_dñ
(&
ªloc_roŸ
->
roŸ_li°
);

4313 i‡(
	`båfs_roŸ_ªfs
(&
ªloc_roŸ
->
roŸ_ôem
) == 0) {

4314 
	`li°_add_èû
(&
ªloc_roŸ
->
roŸ_li°
,

4315 &
rc
->
ªloc_roŸs
);

4319 
fs_roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
ªloc_roŸ
->
roŸ_key
.
off£t
,

4320 
Ál£
);

4321 i‡(
	`IS_ERR
(
fs_roŸ
)) {

4322 
îr
 = 
	`PTR_ERR
(
fs_roŸ
);

4323 
	`li°_add_èû
(&
ªloc_roŸ
->
roŸ_li°
, &
ªloc_roŸs
);

4324 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

4325 
out_un£t
;

4328 
îr
 = 
	`__add_ªloc_roŸ
(
ªloc_roŸ
);

4329 
	`ASSERT
(
îr
 !-
EEXIST
);

4330 i‡(
îr
) {

4331 
	`li°_add_èû
(&
ªloc_roŸ
->
roŸ_li°
, &
ªloc_roŸs
);

4332 
	`båfs_put_roŸ
(
fs_roŸ
);

4333 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

4334 
out_un£t
;

4336 
fs_roŸ
->
ªloc_roŸ
 = 
	`båfs_gøb_roŸ
(reloc_root);

4337 
	`båfs_put_roŸ
(
fs_roŸ
);

4340 
îr
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

4341 i‡(
îr
)

4342 
out_un£t
;

4344 
	`mîge_ªloc_roŸs
(
rc
);

4346 
	`un£t_ªloc_c⁄åﬁ
(
rc
);

4348 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
rc
->
exã¡_roŸ
);

4349 i‡(
	`IS_ERR
(
å™s
)) {

4350 
îr
 = 
	`PTR_ERR
(
å™s
);

4351 
out_˛ón
;

4353 
îr
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

4354 
out_˛ón
:

4355 
ªt
 = 
	`˛ón_dúty_subvﬁs
(
rc
);

4356 i‡(
ªt
 < 0 && !
îr
)

4357 
îr
 = 
ªt
;

4358 
out_un£t
:

4359 
	`un£t_ªloc_c⁄åﬁ
(
rc
);

4360 
out_íd
:

4361 
	`ªloc_chunk_íd
(
fs_öfo
);

4362 
	`‰ì_ªloc_c⁄åﬁ
(
rc
);

4363 
out
:

4364 
	`‰ì_ªloc_roŸs
(&
ªloc_roŸs
);

4366 
	`båfs_‰ì_∑th
(
∑th
);

4368 i‡(
îr
 == 0) {

4370 
fs_roŸ
 = 
	`båfs_gøb_roŸ
(
fs_öfo
->
d©a_ªloc_roŸ
);

4371 
	`ASSERT
(
fs_roŸ
);

4372 
îr
 = 
	`båfs_‹ph™_˛ónup
(
fs_roŸ
);

4373 
	`båfs_put_roŸ
(
fs_roŸ
);

4375  
îr
;

4376 
	}
}

4384 
	$båfs_ªloc_˛⁄e_csums
(
båfs_‹dîed_exã¡
 *
‹dîed
)

4386 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
‹dîed
->inode);

4387 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

4388 
u64
 
disk_byãƒ
 = 
‹dîed
->
fûe_off£t
 + 
öode
->
ödex_˙t
;

4389 
båfs_roŸ
 *
csum_roŸ
 = 
	`båfs_csum_roŸ
(
fs_öfo
, 
disk_byãƒ
);

4390 
	`LIST_HEAD
(
li°
);

4391 
ªt
;

4393 
ªt
 = 
	`båfs_lookup_csums_li°
(
csum_roŸ
, 
disk_byãƒ
,

4394 
disk_byãƒ
 + 
‹dîed
->
num_byãs
 - 1,

4395 &
li°
, 0, 
Ál£
);

4396 i‡(
ªt
)

4397  
ªt
;

4399 !
	`li°_em±y
(&
li°
)) {

4400 
båfs_‹dîed_sum
 *
sums
 =

4401 
	`li°_íåy
(
li°
.
√xt
, 
båfs_‹dîed_sum
,Üist);

4403 
	`li°_dñ_öô
(&
sums
->
li°
);

4417 
sums
->
logiˇl
 = 
‹dîed
->
disk_byãƒ
 + sums->logical - disk_bytenr;

4418 
	`båfs_add_‹dîed_sum
(
‹dîed
, 
sums
);

4422 
	}
}

4424 
	$båfs_ªloc_cow_block
(
båfs_å™s_h™dÀ
 *
å™s
,

4425 
båfs_roŸ
 *
roŸ
, 
exã¡_buf„r
 *
buf
,

4426 
exã¡_buf„r
 *
cow
)

4428 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

4429 
ªloc_c⁄åﬁ
 *
rc
;

4430 
båfs_backªf_node
 *
node
;

4431 
fú°_cow
 = 0;

4432 
Àvñ
;

4433 
ªt
 = 0;

4435 
rc
 = 
fs_öfo
->
ªloc_˘l
;

4436 i‡(!
rc
)

4439 
	`BUG_ON
(
rc
->
°age
 =
UPDATE_DATA_PTRS
 && 
	`båfs_is_d©a_ªloc_roŸ
(
roŸ
));

4441 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
buf
);

4442 i‡(
	`båfs_hódî_gíî©i⁄
(
buf
) <=

4443 
	`båfs_roŸ_œ°_¢≠shŸ
(&
roŸ
->
roŸ_ôem
))

4444 
fú°_cow
 = 1;

4446 i‡(
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
 &&

4447 
rc
->
¸óã_ªloc_åì
) {

4448 
	`WARN_ON
(!
fú°_cow
 && 
Àvñ
 == 0);

4450 
node
 = 
rc
->
backªf_ˇche
.
∑th
[
Àvñ
];

4451 
	`BUG_ON
(
node
->
byãƒ
 !
buf
->
°¨t
 &&

4452 
node
->
√w_byãƒ
 !
buf
->
°¨t
);

4454 
	`båfs_backªf_dr›_node_buf„r
(
node
);

4455 
	`©omic_öc
(&
cow
->
ªfs
);

4456 
node
->
eb
 = 
cow
;

4457 
node
->
√w_byãƒ
 = 
cow
->
°¨t
;

4459 i‡(!
node
->
≥ndög
) {

4460 
	`li°_move_èû
(&
node
->
li°
,

4461 &
rc
->
backªf_ˇche
.
≥ndög
[
Àvñ
]);

4462 
node
->
≥ndög
 = 1;

4465 i‡(
fú°_cow
)

4466 
	`m¨k_block_¥o˚s£d
(
rc
, 
node
);

4468 i‡(
fú°_cow
 && 
Àvñ
 > 0)

4469 
rc
->
nodes_ªloˇãd
 +
buf
->
Àn
;

4472 i‡(
Àvñ
 =0 && 
fú°_cow
 && 
rc
->
°age
 =
UPDATE_DATA_PTRS
)

4473 
ªt
 = 
	`ª∂a˚_fûe_exã¡s
(
å™s
, 
rc
, 
roŸ
, 
cow
);

4474  
ªt
;

4475 
	}
}

4481 
	$båfs_ªloc_¥e_¢≠shŸ
(
båfs_≥ndög_¢≠shŸ
 *
≥ndög
,

4482 
u64
 *
byãs_to_ª£rve
)

4484 
båfs_roŸ
 *
roŸ
 = 
≥ndög
->root;

4485 
ªloc_c⁄åﬁ
 *
rc
 = 
roŸ
->
fs_öfo
->
ªloc_˘l
;

4487 i‡(!
rc
 || !
	`have_ªloc_roŸ
(
roŸ
))

4490 i‡(!
rc
->
mîge_ªloc_åì
)

4493 
roŸ
 =ÑoŸ->
ªloc_roŸ
;

4494 
	`BUG_ON
(
	`båfs_roŸ_ªfs
(&
roŸ
->
roŸ_ôem
) == 0);

4505 *
byãs_to_ª£rve
 +
rc
->
nodes_ªloˇãd
;

4506 
	}
}

4516 
	$båfs_ªloc_po°_¢≠shŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

4517 
båfs_≥ndög_¢≠shŸ
 *
≥ndög
)

4519 
båfs_roŸ
 *
roŸ
 = 
≥ndög
->root;

4520 
båfs_roŸ
 *
ªloc_roŸ
;

4521 
båfs_roŸ
 *
√w_roŸ
;

4522 
ªloc_c⁄åﬁ
 *
rc
 = 
roŸ
->
fs_öfo
->
ªloc_˘l
;

4523 
ªt
;

4525 i‡(!
rc
 || !
	`have_ªloc_roŸ
(
roŸ
))

4528 
rc
 = 
roŸ
->
fs_öfo
->
ªloc_˘l
;

4529 
rc
->
mîgög_rsv_size
 +rc->
nodes_ªloˇãd
;

4531 i‡(
rc
->
mîge_ªloc_åì
) {

4532 
ªt
 = 
	`båfs_block_rsv_migøã
(&
≥ndög
->
block_rsv
,

4533 
rc
->
block_rsv
,

4534 
rc
->
nodes_ªloˇãd
, 
åue
);

4535 i‡(
ªt
)

4536  
ªt
;

4539 
√w_roŸ
 = 
≥ndög
->
¢≠
;

4540 
ªloc_roŸ
 = 
	`¸óã_ªloc_roŸ
(
å™s
, 
roŸ
->reloc_root,

4541 
√w_roŸ
->
roŸ_key
.
obje˘id
);

4542 i‡(
	`IS_ERR
(
ªloc_roŸ
))

4543  
	`PTR_ERR
(
ªloc_roŸ
);

4545 
ªt
 = 
	`__add_ªloc_roŸ
(
ªloc_roŸ
);

4546 
	`ASSERT
(
ªt
 !-
EEXIST
);

4547 i‡(
ªt
) {

4549 
	`båfs_put_roŸ
(
ªloc_roŸ
);

4550  
ªt
;

4552 
√w_roŸ
->
ªloc_roŸ
 = 
	`båfs_gøb_roŸ
(reloc_root);

4554 i‡(
rc
->
¸óã_ªloc_åì
)

4555 
ªt
 = 
	`˛⁄e_backªf_node
(
å™s
, 
rc
, 
roŸ
, 
ªloc_roŸ
);

4556  
ªt
;

4557 
	}
}

4564 
u64
 
	$båfs_gë_ªloc_bg_byãƒ
(
båfs_fs_öfo
 *
fs_öfo
)

4566 
u64
 
logiˇl
 = 
U64_MAX
;

4568 
	`lockdï_as£π_hñd
(&
fs_öfo
->
ªloc_muãx
);

4570 i‡(
fs_öfo
->
ªloc_˘l
 && fs_öfo->ªloc_˘l->
block_group
)

4571 
logiˇl
 = 
fs_öfo
->
ªloc_˘l
->
block_group
->
°¨t
;

4572  
logiˇl
;

4573 
	}
}

	@relocation.h

3 #i‚de‡
BTRFS_RELOCATION_H


4 
	#BTRFS_RELOCATION_H


	)

6 
båfs_ªloˇã_block_group
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
group_°¨t
);

7 
båfs_öô_ªloc_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
);

8 
båfs_upd©e_ªloc_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

9 
båfs_roŸ
 *
roŸ
);

10 
båfs_ªcovî_ªloˇti⁄
(
båfs_fs_öfo
 *
fs_öfo
);

11 
båfs_ªloc_˛⁄e_csums
(
båfs_‹dîed_exã¡
 *
‹dîed
);

12 
båfs_ªloc_cow_block
(
båfs_å™s_h™dÀ
 *
å™s
,

13 
båfs_roŸ
 *
roŸ
, 
exã¡_buf„r
 *
buf
,

14 
exã¡_buf„r
 *
cow
);

15 
båfs_ªloc_¥e_¢≠shŸ
(
båfs_≥ndög_¢≠shŸ
 *
≥ndög
,

16 
u64
 *
byãs_to_ª£rve
);

17 
båfs_ªloc_po°_¢≠shŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

18 
båfs_≥ndög_¢≠shŸ
 *
≥ndög
);

19 
båfs_should_ˇn˚l_bÆ™˚
(
båfs_fs_öfo
 *
fs_öfo
);

20 
båfs_roŸ
 *
föd_ªloc_roŸ
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
byãƒ
);

21 
båfs_should_ign‹e_ªloc_roŸ
(
båfs_roŸ
 *
roŸ
);

22 
u64
 
båfs_gë_ªloc_bg_byãƒ
(
båfs_fs_öfo
 *
fs_öfo
);

	@root-tree.c

6 
	~<löux/îr.h
>

7 
	~<löux/uuid.h
>

8 
	~"˘ªe.h
"

9 
	~"fs.h
"

10 
	~"mesßges.h
"

11 
	~"å™ß˘i⁄.h
"

12 
	~"disk-io.h
"

13 
	~"¥öt-åì.h
"

14 
	~"qgroup.h
"

15 
	~"•a˚-öfo.h
"

16 
	~"ac˚ss‹s.h
"

17 
	~"roŸ-åì.h
"

18 
	~"‹ph™.h
"

27 
	$båfs_ªad_roŸ_ôem
(
exã¡_buf„r
 *
eb
, 
¶Ÿ
,

28 
båfs_roŸ_ôem
 *
ôem
)

30 
u32
 
Àn
;

31 
√ed_ª£t
 = 0;

33 
Àn
 = 
	`båfs_ôem_size
(
eb
, 
¶Ÿ
);

34 
	`ªad_exã¡_buf„r
(
eb
, 
ôem
, 
	`båfs_ôem_±r_off£t
”b, 
¶Ÿ
),

35 
	`mö_t
(
u32
, 
Àn
, (*
ôem
)));

36 i‡(
Àn
 < (*
ôem
))

37 
√ed_ª£t
 = 1;

38 i‡(!
√ed_ª£t
 && 
	`båfs_roŸ_gíî©i⁄
(
ôem
)

39 !
	`båfs_roŸ_gíî©i⁄_v2
(
ôem
)) {

40 i‡(
	`båfs_roŸ_gíî©i⁄_v2
(
ôem
) != 0) {

41 
	`båfs_w¨n
(
eb
->
fs_öfo
,

44 
√ed_ª£t
 = 1;

46 i‡(
√ed_ª£t
) {

48 
	`mem£t_°¨èt
(
ôem
, 0, 
gíî©i⁄_v2
);

49 
	`gíî©e_øndom_guid
(
ôem
->
uuid
);

51 
	}
}

67 
	$båfs_föd_roŸ
(
båfs_roŸ
 *
roŸ
, c⁄° 
båfs_key
 *
£¨ch_key
,

68 
båfs_∑th
 *
∑th
, 
båfs_roŸ_ôem
 *
roŸ_ôem
,

69 
båfs_key
 *
roŸ_key
)

71 
båfs_key
 
found_key
;

72 
exã¡_buf„r
 *
l
;

73 
ªt
;

74 
¶Ÿ
;

76 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, 
£¨ch_key
, 
∑th
, 0, 0);

77 i‡(
ªt
 < 0)

78  
ªt
;

80 i‡(
£¨ch_key
->
off£t
 != -1ULL) {

81 i‡(
ªt
 > 0)

82 
out
;

84 
	`BUG_ON
(
ªt
 == 0);

85 i‡(
∑th
->
¶Ÿs
[0] == 0)

86 
out
;

87 
∑th
->
¶Ÿs
[0]--;

88 
ªt
 = 0;

91 
l
 = 
∑th
->
nodes
[0];

92 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

94 
	`båfs_ôem_key_to_˝u
(
l
, &
found_key
, 
¶Ÿ
);

95 i‡(
found_key
.
obje˘id
 !
£¨ch_key
->objectid ||

96 
found_key
.
ty≥
 !
BTRFS_ROOT_ITEM_KEY
) {

97 
ªt
 = 1;

98 
out
;

101 i‡(
roŸ_ôem
)

102 
	`båfs_ªad_roŸ_ôem
(
l
, 
¶Ÿ
, 
roŸ_ôem
);

103 i‡(
roŸ_key
)

104 
	`mem˝y
(
roŸ_key
, &
found_key
, (found_key));

105 
out
:

106 
	`båfs_ªÀa£_∑th
(
∑th
);

107  
ªt
;

108 
	}
}

110 
	$båfs_£t_roŸ_node
(
båfs_roŸ_ôem
 *
ôem
,

111 
exã¡_buf„r
 *
node
)

113 
	`båfs_£t_roŸ_byãƒ
(
ôem
, 
node
->
°¨t
);

114 
	`båfs_£t_roŸ_Àvñ
(
ôem
, 
	`båfs_hódî_Àvñ
(
node
));

115 
	`båfs_£t_roŸ_gíî©i⁄
(
ôem
, 
	`båfs_hódî_gíî©i⁄
(
node
));

116 
	}
}

121 
	$båfs_upd©e_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ


122 *
roŸ
, 
båfs_key
 *
key
, 
båfs_roŸ_ôem


123 *
ôem
)

125 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

126 
båfs_∑th
 *
∑th
;

127 
exã¡_buf„r
 *
l
;

128 
ªt
;

129 
¶Ÿ
;

130 
±r
;

131 
u32
 
ﬁd_Àn
;

133 
∑th
 = 
	`båfs_Æloc_∑th
();

134 i‡(!
∑th
)

135  -
ENOMEM
;

137 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, 
key
, 
∑th
, 0, 1);

138 i‡(
ªt
 < 0)

139 
out
;

141 i‡(
ªt
 > 0) {

142 
	`båfs_¸ô
(
fs_öfo
,

144 
key
->
obje˘id
, key->
ty≥
, key->
off£t
,

145 
roŸ
->
roŸ_key
.
obje˘id
);

146 
ªt
 = -
EUCLEAN
;

147 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

148 
out
;

151 
l
 = 
∑th
->
nodes
[0];

152 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

153 
±r
 = 
	`båfs_ôem_±r_off£t
(
l
, 
¶Ÿ
);

154 
ﬁd_Àn
 = 
	`båfs_ôem_size
(
l
, 
¶Ÿ
);

161 i‡(
ﬁd_Àn
 < (*
ôem
)) {

162 
	`båfs_ªÀa£_∑th
(
∑th
);

163 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, 
key
, 
∑th
,

165 i‡(
ªt
 < 0) {

166 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

167 
out
;

170 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

171 i‡(
ªt
 < 0) {

172 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

173 
out
;

175 
	`båfs_ªÀa£_∑th
(
∑th
);

176 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
,

177 
key
, (*
ôem
));

178 i‡(
ªt
 < 0) {

179 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

180 
out
;

182 
l
 = 
∑th
->
nodes
[0];

183 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

184 
±r
 = 
	`båfs_ôem_±r_off£t
(
l
, 
¶Ÿ
);

191 
	`båfs_£t_roŸ_gíî©i⁄_v2
(
ôem
, 
	`båfs_roŸ_gíî©i⁄
(item));

193 
	`wrôe_exã¡_buf„r
(
l
, 
ôem
, 
±r
, (*item));

194 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑th
->
nodes
[0]);

195 
out
:

196 
	`båfs_‰ì_∑th
(
∑th
);

197  
ªt
;

198 
	}
}

200 
	$båfs_ö£π_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
,

201 c⁄° 
båfs_key
 *
key
, 
båfs_roŸ_ôem
 *
ôem
)

206 
	`båfs_£t_roŸ_gíî©i⁄_v2
(
ôem
, 
	`båfs_roŸ_gíî©i⁄
(item));

207  
	`båfs_ö£π_ôem
(
å™s
, 
roŸ
, 
key
, 
ôem
, (*item));

208 
	}
}

210 
	$båfs_föd_‹ph™_roŸs
(
båfs_fs_öfo
 *
fs_öfo
)

212 
båfs_roŸ
 *
åì_roŸ
 = 
fs_öfo
->tree_root;

213 
exã¡_buf„r
 *
Àaf
;

214 
båfs_∑th
 *
∑th
;

215 
båfs_key
 
key
;

216 
båfs_roŸ
 *
roŸ
;

217 
îr
 = 0;

218 
ªt
;

220 
∑th
 = 
	`båfs_Æloc_∑th
();

221 i‡(!
∑th
)

222  -
ENOMEM
;

224 
key
.
obje˘id
 = 
BTRFS_ORPHAN_OBJECTID
;

225 
key
.
ty≥
 = 
BTRFS_ORPHAN_ITEM_KEY
;

226 
key
.
off£t
 = 0;

229 
u64
 
roŸ_obje˘id
;

231 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
åì_roŸ
, &
key
, 
∑th
, 0, 0);

232 i‡(
ªt
 < 0) {

233 
îr
 = 
ªt
;

237 
Àaf
 = 
∑th
->
nodes
[0];

238 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
(
Àaf
)) {

239 
ªt
 = 
	`båfs_√xt_Àaf
(
åì_roŸ
, 
∑th
);

240 i‡(
ªt
 < 0)

241 
îr
 = 
ªt
;

242 i‡(
ªt
 != 0)

244 
Àaf
 = 
∑th
->
nodes
[0];

247 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

248 
	`båfs_ªÀa£_∑th
(
∑th
);

250 i‡(
key
.
obje˘id
 !
BTRFS_ORPHAN_OBJECTID
 ||

251 
key
.
ty≥
 !
BTRFS_ORPHAN_ITEM_KEY
)

254 
roŸ_obje˘id
 = 
key
.
off£t
;

255 
key
.
off£t
++;

257 
roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
roŸ_obje˘id
, 
Ál£
);

258 
îr
 = 
	`PTR_ERR_OR_ZERO
(
roŸ
);

259 i‡(
îr
 &&Éº !-
ENOENT
) {

261 } i‡(
îr
 =-
ENOENT
) {

262 
båfs_å™s_h™dÀ
 *
å™s
;

264 
	`båfs_ªÀa£_∑th
(
∑th
);

266 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
åì_roŸ
);

267 i‡(
	`IS_ERR
(
å™s
)) {

268 
îr
 = 
	`PTR_ERR
(
å™s
);

269 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
îr
,

273 
îr
 = 
	`båfs_dñ_‹ph™_ôem
(
å™s
, 
åì_roŸ
,

274 
roŸ_obje˘id
);

275 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

276 i‡(
îr
) {

277 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
îr
,

284 
	`WARN_ON
(!
	`ã°_bô
(
BTRFS_ROOT_ORPHAN_ITEM_INSERTED
, &
roŸ
->
°©e
));

285 i‡(
	`båfs_roŸ_ªfs
(&
roŸ
->
roŸ_ôem
) == 0) {

286 
båfs_key
 
dr›_key
;

288 
	`båfs_disk_key_to_˝u
(&
dr›_key
, &
roŸ
->
roŸ_ôem
.
dr›_¥ogªss
);

295 i‡(
dr›_key
.
obje˘id
 !0 || dr›_key.
ty≥
 != 0 ||

296 
dr›_key
.
off£t
 != 0) {

297 
	`£t_bô
(
BTRFS_FS_UNFINISHED_DROPS
, &
fs_öfo
->
Êags
);

298 
	`£t_bô
(
BTRFS_ROOT_UNFINISHED_DROP
, &
roŸ
->
°©e
);

301 
	`£t_bô
(
BTRFS_ROOT_DEAD_TREE
, &
roŸ
->
°©e
);

302 
	`båfs_add_dód_roŸ
(
roŸ
);

304 
	`båfs_put_roŸ
(
roŸ
);

307 
	`båfs_‰ì_∑th
(
∑th
);

308  
îr
;

309 
	}
}

312 
	$båfs_dñ_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

313 c⁄° 
båfs_key
 *
key
)

315 
båfs_roŸ
 *
roŸ
 = 
å™s
->
fs_öfo
->
åì_roŸ
;

316 
båfs_∑th
 *
∑th
;

317 
ªt
;

319 
∑th
 = 
	`båfs_Æloc_∑th
();

320 i‡(!
∑th
)

321  -
ENOMEM
;

322 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, 
key
, 
∑th
, -1, 1);

323 i‡(
ªt
 < 0)

324 
out
;

326 
	`BUG_ON
(
ªt
 != 0);

328 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

329 
out
:

330 
	`båfs_‰ì_∑th
(
∑th
);

331  
ªt
;

332 
	}
}

334 
	$båfs_dñ_roŸ_ªf
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
roŸ_id
,

335 
u64
 
ªf_id
, u64 
dúid
, u64 *
£quí˚
,

336 c⁄° 
fs¸y±_°r
 *
«me
)

338 
båfs_roŸ
 *
åì_roŸ
 = 
å™s
->
fs_öfo
->tree_root;

339 
båfs_∑th
 *
∑th
;

340 
båfs_roŸ_ªf
 *
ªf
;

341 
exã¡_buf„r
 *
Àaf
;

342 
båfs_key
 
key
;

343 
±r
;

344 
ªt
;

346 
∑th
 = 
	`båfs_Æloc_∑th
();

347 i‡(!
∑th
)

348  -
ENOMEM
;

350 
key
.
obje˘id
 = 
roŸ_id
;

351 
key
.
ty≥
 = 
BTRFS_ROOT_BACKREF_KEY
;

352 
key
.
off£t
 = 
ªf_id
;

353 
agaö
:

354 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
åì_roŸ
, &
key
, 
∑th
, -1, 1);

355 i‡(
ªt
 < 0) {

356 
out
;

357 } i‡(
ªt
 == 0) {

358 
Àaf
 = 
∑th
->
nodes
[0];

359 
ªf
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

360 
båfs_roŸ_ªf
);

361 
±r
 = ()(
ªf
 + 1);

362 i‡((
	`båfs_roŸ_ªf_dúid
(
Àaf
, 
ªf
Ë!
dúid
) ||

363 (
	`båfs_roŸ_ªf_«me_Àn
(
Àaf
, 
ªf
Ë!
«me
->
Àn
) ||

364 
	`memcmp_exã¡_buf„r
(
Àaf
, 
«me
->«me, 
±r
,Çame->
Àn
)) {

365 
ªt
 = -
ENOENT
;

366 
out
;

368 *
£quí˚
 = 
	`båfs_roŸ_ªf_£quí˚
(
Àaf
, 
ªf
);

370 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
åì_roŸ
, 
∑th
);

371 i‡(
ªt
)

372 
out
;

374 
ªt
 = -
ENOENT
;

375 
out
;

378 i‡(
key
.
ty≥
 =
BTRFS_ROOT_BACKREF_KEY
) {

379 
	`båfs_ªÀa£_∑th
(
∑th
);

380 
key
.
obje˘id
 = 
ªf_id
;

381 
key
.
ty≥
 = 
BTRFS_ROOT_REF_KEY
;

382 
key
.
off£t
 = 
roŸ_id
;

383 
agaö
;

386 
out
:

387 
	`båfs_‰ì_∑th
(
∑th
);

388  
ªt
;

389 
	}
}

406 
	$båfs_add_roŸ_ªf
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
roŸ_id
,

407 
u64
 
ªf_id
, u64 
dúid
, u64 
£quí˚
,

408 c⁄° 
fs¸y±_°r
 *
«me
)

410 
båfs_roŸ
 *
åì_roŸ
 = 
å™s
->
fs_öfo
->tree_root;

411 
båfs_key
 
key
;

412 
ªt
;

413 
båfs_∑th
 *
∑th
;

414 
båfs_roŸ_ªf
 *
ªf
;

415 
exã¡_buf„r
 *
Àaf
;

416 
±r
;

418 
∑th
 = 
	`båfs_Æloc_∑th
();

419 i‡(!
∑th
)

420  -
ENOMEM
;

422 
key
.
obje˘id
 = 
roŸ_id
;

423 
key
.
ty≥
 = 
BTRFS_ROOT_BACKREF_KEY
;

424 
key
.
off£t
 = 
ªf_id
;

425 
agaö
:

426 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
åì_roŸ
, 
∑th
, &
key
,

427 (*
ªf
Ë+ 
«me
->
Àn
);

428 i‡(
ªt
) {

429 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

430 
	`båfs_‰ì_∑th
(
∑th
);

431  
ªt
;

434 
Àaf
 = 
∑th
->
nodes
[0];

435 
ªf
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_roŸ_ªf
);

436 
	`båfs_£t_roŸ_ªf_dúid
(
Àaf
, 
ªf
, 
dúid
);

437 
	`båfs_£t_roŸ_ªf_£quí˚
(
Àaf
, 
ªf
, 
£quí˚
);

438 
	`båfs_£t_roŸ_ªf_«me_Àn
(
Àaf
, 
ªf
, 
«me
->
Àn
);

439 
±r
 = ()(
ªf
 + 1);

440 
	`wrôe_exã¡_buf„r
(
Àaf
, 
«me
->«me, 
±r
,Çame->
Àn
);

441 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

443 i‡(
key
.
ty≥
 =
BTRFS_ROOT_BACKREF_KEY
) {

444 
	`båfs_ªÀa£_∑th
(
∑th
);

445 
key
.
obje˘id
 = 
ªf_id
;

446 
key
.
ty≥
 = 
BTRFS_ROOT_REF_KEY
;

447 
key
.
off£t
 = 
roŸ_id
;

448 
agaö
;

451 
	`båfs_‰ì_∑th
(
∑th
);

453 
	}
}

461 
	$båfs_check_™d_öô_roŸ_ôem
(
båfs_roŸ_ôem
 *
roŸ_ôem
)

463 
u64
 
öode_Êags
 = 
	`båfs_°ack_öode_Êags
(&
roŸ_ôem
->
öode
);

465 i‡(!(
öode_Êags
 & 
BTRFS_INODE_ROOT_ITEM_INIT
)) {

466 
öode_Êags
 |
BTRFS_INODE_ROOT_ITEM_INIT
;

467 
	`båfs_£t_°ack_öode_Êags
(&
roŸ_ôem
->
öode
, 
öode_Êags
);

468 
	`båfs_£t_roŸ_Êags
(
roŸ_ôem
, 0);

469 
	`båfs_£t_roŸ_limô
(
roŸ_ôem
, 0);

471 
	}
}

473 
	$båfs_upd©e_roŸ_times
(
båfs_å™s_h™dÀ
 *
å™s
,

474 
båfs_roŸ
 *
roŸ
)

476 
båfs_roŸ_ôem
 *
ôem
 = &
roŸ
->
roŸ_ôem
;

477 
time•ec64
 
˘
;

479 
	`ktime_gë_ªÆ_ts64
(&
˘
);

480 
	`•ö_lock
(&
roŸ
->
roŸ_ôem_lock
);

481 
	`båfs_£t_roŸ_˘ønsid
(
ôem
, 
å™s
->
å™sid
);

482 
	`båfs_£t_°ack_time•ec_£c
(&
ôem
->
˘ime
, 
˘
.
tv_£c
);

483 
	`båfs_£t_°ack_time•ec_n£c
(&
ôem
->
˘ime
, 
˘
.
tv_n£c
);

484 
	`•ö_u∆ock
(&
roŸ
->
roŸ_ôem_lock
);

485 
	}
}

501 
	$båfs_subvﬁume_ª£rve_mëad©a
(
båfs_roŸ
 *
roŸ
,

502 
båfs_block_rsv
 *
rsv
, 
ôems
,

503 
boﬁ
 
u£_globÆ_rsv
)

505 
u64
 
qgroup_num_byãs
 = 0;

506 
u64
 
num_byãs
;

507 
ªt
;

508 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

509 
båfs_block_rsv
 *
globÆ_rsv
 = &
fs_öfo
->
globÆ_block_rsv
;

511 i‡(
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
)) {

513 
qgroup_num_byãs
 = 3 * 
fs_öfo
->
nodesize
;

514 
ªt
 = 
	`båfs_qgroup_ª£rve_mëa_¥óŒoc
(
roŸ
,

515 
qgroup_num_byãs
, 
åue
,

516 
Ál£
);

517 i‡(
ªt
)

518  
ªt
;

521 
num_byãs
 = 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
, 
ôems
);

522 
rsv
->
•a˚_öfo
 = 
	`båfs_föd_•a˚_öfo
(
fs_öfo
,

523 
BTRFS_BLOCK_GROUP_METADATA
);

524 
ªt
 = 
	`båfs_block_rsv_add
(
fs_öfo
, 
rsv
, 
num_byãs
,

525 
BTRFS_RESERVE_FLUSH_ALL
);

527 i‡(
ªt
 =-
ENOSPC
 && 
u£_globÆ_rsv
)

528 
ªt
 = 
	`båfs_block_rsv_migøã
(
globÆ_rsv
, 
rsv
, 
num_byãs
, 
åue
);

530 i‡(
ªt
 && 
qgroup_num_byãs
)

531 
	`båfs_qgroup_‰ì_mëa_¥óŒoc
(
roŸ
, 
qgroup_num_byãs
);

533 i‡(!
ªt
) {

534 
	`•ö_lock
(&
rsv
->
lock
);

535 
rsv
->
qgroup_rsv_ª£rved
 +
qgroup_num_byãs
;

536 
	`•ö_u∆ock
(&
rsv
->
lock
);

538  
ªt
;

539 
	}
}

541 
	$båfs_subvﬁume_ªÀa£_mëad©a
(
båfs_roŸ
 *
roŸ
,

542 
båfs_block_rsv
 *
rsv
)

544 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

545 
u64
 
qgroup_to_ªÀa£
;

547 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, 
rsv
, (
u64
)-1, &
qgroup_to_ªÀa£
);

548 
	`båfs_qgroup_c⁄vît_ª£rved_mëa
(
roŸ
, 
qgroup_to_ªÀa£
);

549 
	}
}

	@root-tree.h

3 #i‚de‡
BTRFS_ROOT_TREE_H


4 
	#BTRFS_ROOT_TREE_H


	)

6 
båfs_subvﬁume_ª£rve_mëad©a
(
båfs_roŸ
 *
roŸ
,

7 
båfs_block_rsv
 *
rsv
,

8 
nôems
, 
boﬁ
 
u£_globÆ_rsv
);

9 
båfs_subvﬁume_ªÀa£_mëad©a
(
båfs_roŸ
 *
roŸ
,

10 
båfs_block_rsv
 *
rsv
);

11 
båfs_add_roŸ_ªf
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
roŸ_id
,

12 
u64
 
ªf_id
, u64 
dúid
, u64 
£quí˚
,

13 c⁄° 
fs¸y±_°r
 *
«me
);

14 
båfs_dñ_roŸ_ªf
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
roŸ_id
,

15 
u64
 
ªf_id
, u64 
dúid
, u64 *
£quí˚
,

16 c⁄° 
fs¸y±_°r
 *
«me
);

17 
båfs_dñ_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
, c⁄° 
båfs_key
 *
key
);

18 
båfs_ö£π_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
,

19 c⁄° 
båfs_key
 *
key
,

20 
båfs_roŸ_ôem
 *
ôem
);

21 
__mu°_check
 
båfs_upd©e_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

22 
båfs_roŸ
 *
roŸ
,

23 
båfs_key
 *
key
,

24 
båfs_roŸ_ôem
 *
ôem
);

25 
båfs_föd_roŸ
(
båfs_roŸ
 *
roŸ
, c⁄° 
båfs_key
 *
£¨ch_key
,

26 
båfs_∑th
 *
∑th
, 
båfs_roŸ_ôem
 *
roŸ_ôem
,

27 
båfs_key
 *
roŸ_key
);

28 
båfs_föd_‹ph™_roŸs
(
båfs_fs_öfo
 *
fs_öfo
);

29 
båfs_£t_roŸ_node
(
båfs_roŸ_ôem
 *
ôem
,

30 
exã¡_buf„r
 *
node
);

31 
båfs_check_™d_öô_roŸ_ôem
(
båfs_roŸ_ôem
 *
ôem
);

32 
båfs_upd©e_roŸ_times
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
);

	@scrub.c

6 
	~<löux/blkdev.h
>

7 
	~<löux/øãlimô.h
>

8 
	~<löux/sched/mm.h
>

9 
	~<¸y±o/hash.h
>

10 
	~"˘ªe.h
"

11 
	~"disˇrd.h
"

12 
	~"vﬁumes.h
"

13 
	~"disk-io.h
"

14 
	~"‹dîed-d©a.h
"

15 
	~"å™ß˘i⁄.h
"

16 
	~"backªf.h
"

17 
	~"exã¡_io.h
"

18 
	~"dev-ª∂a˚.h
"

19 
	~"check-öãgrôy.h
"

20 
	~"øid56.h
"

21 
	~"block-group.h
"

22 
	~"z⁄ed.h
"

23 
	~"fs.h
"

24 
	~"ac˚ss‹s.h
"

25 
	~"fûe-ôem.h
"

26 
	~"s¸ub.h
"

41 
	gs¸ub_˘x
;

49 
	#SCRUB_STRIPES_PER_GROUP
 8

	)

57 
	#SCRUB_GROUPS_PER_SCTX
 16

	)

59 
	#SCRUB_TOTAL_STRIPES
 (
SCRUB_GROUPS_PER_SCTX
 * 
SCRUB_STRIPES_PER_GROUP
)

	)

65 
	#SCRUB_MAX_SECTORS_PER_BLOCK
 (
BTRFS_MAX_METADATA_BLOCKSIZE
 / 
SZ_4K
)

	)

68 
	ss¸ub_£˘‹_vîifiˇti⁄
 {

69 
boﬁ
 
	mis_mëad©a
;

78 
u8
 *
	mcsum
;

84 
u64
 
	mgíî©i⁄
;

88 
	es¸ub_°rùe_Êags
 {

90 
	mSCRUB_STRIPE_FLAG_INITIALIZED
,

93 
	mSCRUB_STRIPE_FLAG_REPAIR_DONE
,

100 
	mSCRUB_STRIPE_FLAG_NO_REPORT
,

103 
	#SCRUB_STRIPE_PAGES
 (
BTRFS_STRIPE_LEN
 / 
PAGE_SIZE
)

	)

108 
	ss¸ub_°rùe
 {

109 
s¸ub_˘x
 *
	ms˘x
;

110 
båfs_block_group
 *
	mbg
;

112 
∑ge
 *
	m∑ges
[
SCRUB_STRIPE_PAGES
];

113 
s¸ub_£˘‹_vîifiˇti⁄
 *
	m£˘‹s
;

115 
båfs_devi˚
 *
	mdev
;

116 
u64
 
	mlogiˇl
;

117 
u64
 
	mphysiˇl
;

119 
u16
 
	mmúr‹_num
;

122 
u16
 
	mƒ_£˘‹s
;

128 
u16
 
	mƒ_d©a_exã¡s
;

129 
u16
 
	mƒ_mëa_exã¡s
;

131 
©omic_t
 
	m≥ndög_io
;

132 
waô_queue_hód_t
 
	mio_waô
;

133 
waô_queue_hód_t
 
	mª∑ú_waô
;

139 
	m°©e
;

142 
	mexã¡_£˘‹_bôm≠
;

152 
	möô_îr‹_bôm≠
;

153 
	möô_ƒ_io_îr‹s
;

154 
	möô_ƒ_csum_îr‹s
;

155 
	möô_ƒ_mëa_îr‹s
;

165 
	mîr‹_bôm≠
;

166 
	mio_îr‹_bôm≠
;

167 
	mcsum_îr‹_bôm≠
;

168 
	mmëa_îr‹_bôm≠
;

171 
	mwrôe_îr‹_bôm≠
;

174 
•ölock_t
 
	mwrôe_îr‹_lock
;

180 
u8
 *
	mcsums
;

182 
w‹k_°ru˘
 
	mw‹k
;

185 
	ss¸ub_˘x
 {

186 
s¸ub_°rùe
 
	m°rùes
[
SCRUB_TOTAL_STRIPES
];

187 
s¸ub_°rùe
 *
	møid56_d©a_°rùes
;

188 
båfs_fs_öfo
 *
	mfs_öfo
;

189 
båfs_∑th
 
	mexã¡_∑th
;

190 
båfs_∑th
 
	mcsum_∑th
;

191 
	mfú°_‰ì
;

192 
	mcur_°rùe
;

193 
©omic_t
 
	mˇn˚l_ªq
;

194 
	mªad⁄ly
;

195 
	m£˘‹s_≥r_bio
;

198 
ktime_t
 
	mthrŸée_dódlöe
;

199 
u64
 
	mthrŸée_£¡
;

201 
	mis_dev_ª∂a˚
;

202 
u64
 
	mwrôe_poöãr
;

204 
muãx
 
	mwr_lock
;

205 
båfs_devi˚
 *
	mwr_tgtdev
;

210 
båfs_s¸ub_¥ogªss
 
	m°©
;

211 
•ölock_t
 
	m°©_lock
;

220 
ªfcou¡_t
 
	mªfs
;

223 
	ss¸ub_w¨nög
 {

224 
båfs_∑th
 *
	m∑th
;

225 
u64
 
	mexã¡_ôem_size
;

226 c⁄° *
	mîr°r
;

227 
u64
 
	mphysiˇl
;

228 
u64
 
	mlogiˇl
;

229 
båfs_devi˚
 *
	mdev
;

232 
	$ªÀa£_s¸ub_°rùe
(
s¸ub_°rùe
 *
°rùe
)

234 i‡(!
°rùe
)

237 
i
 = 0; i < 
SCRUB_STRIPE_PAGES
; i++) {

238 i‡(
°rùe
->
∑ges
[
i
])

239 
	`__‰ì_∑ge
(
°rùe
->
∑ges
[
i
]);

240 
°rùe
->
∑ges
[
i
] = 
NULL
;

242 
	`k‰ì
(
°rùe
->
£˘‹s
);

243 
	`k‰ì
(
°rùe
->
csums
);

244 
°rùe
->
£˘‹s
 = 
NULL
;

245 
°rùe
->
csums
 = 
NULL
;

246 
°rùe
->
s˘x
 = 
NULL
;

247 
°rùe
->
°©e
 = 0;

248 
	}
}

250 
	$öô_s¸ub_°rùe
(
båfs_fs_öfo
 *
fs_öfo
,

251 
s¸ub_°rùe
 *
°rùe
)

253 
ªt
;

255 
	`mem£t
(
°rùe
, 0, (*stripe));

257 
°rùe
->
ƒ_£˘‹s
 = 
BTRFS_STRIPE_LEN
 >> 
fs_öfo
->
£˘‹size_bôs
;

258 
°rùe
->
°©e
 = 0;

260 
	`öô_waôqueue_hód
(&
°rùe
->
io_waô
);

261 
	`öô_waôqueue_hód
(&
°rùe
->
ª∑ú_waô
);

262 
	`©omic_£t
(&
°rùe
->
≥ndög_io
, 0);

263 
	`•ö_lock_öô
(&
°rùe
->
wrôe_îr‹_lock
);

265 
ªt
 = 
	`båfs_Æloc_∑ge_¨øy
(
SCRUB_STRIPE_PAGES
, 
°rùe
->
∑ges
);

266 i‡(
ªt
 < 0)

267 
îr‹
;

269 
°rùe
->
£˘‹s
 = 
	`kˇŒoc
(°rùe->
ƒ_£˘‹s
,

270 (
s¸ub_£˘‹_vîifiˇti⁄
),

271 
GFP_KERNEL
);

272 i‡(!
°rùe
->
£˘‹s
)

273 
îr‹
;

275 
°rùe
->
csums
 = 
	`kˇŒoc
(
BTRFS_STRIPE_LEN
 >> 
fs_öfo
->
£˘‹size_bôs
,

276 
fs_öfo
->
csum_size
, 
GFP_KERNEL
);

277 i‡(!
°rùe
->
csums
)

278 
îr‹
;

280 
îr‹
:

281 
	`ªÀa£_s¸ub_°rùe
(
°rùe
);

282  -
ENOMEM
;

283 
	}
}

285 
	$waô_s¸ub_°rùe_io
(
s¸ub_°rùe
 *
°rùe
)

287 
	`waô_evít
(
°rùe
->
io_waô
, 
	`©omic_ªad
(&°rùe->
≥ndög_io
) == 0);

288 
	}
}

290 
s¸ub_put_˘x
(
s¸ub_˘x
 *
s˘x
);

292 
	$__s¸ub_blocked_if_√eded
(
båfs_fs_öfo
 *
fs_öfo
)

294 
	`©omic_ªad
(&
fs_öfo
->
s¸ub_∑u£_ªq
)) {

295 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

296 
	`waô_evít
(
fs_öfo
->
s¸ub_∑u£_waô
,

297 
	`©omic_ªad
(&
fs_öfo
->
s¸ub_∑u£_ªq
) == 0);

298 
	`muãx_lock
(&
fs_öfo
->
s¸ub_lock
);

300 
	}
}

302 
	$s¸ub_∑u£_⁄
(
båfs_fs_öfo
 *
fs_öfo
)

304 
	`©omic_öc
(&
fs_öfo
->
s¸ubs_∑u£d
);

305 
	`wake_up
(&
fs_öfo
->
s¸ub_∑u£_waô
);

306 
	}
}

308 
	$s¸ub_∑u£_off
(
båfs_fs_öfo
 *
fs_öfo
)

310 
	`muãx_lock
(&
fs_öfo
->
s¸ub_lock
);

311 
	`__s¸ub_blocked_if_√eded
(
fs_öfo
);

312 
	`©omic_dec
(&
fs_öfo
->
s¸ubs_∑u£d
);

313 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

315 
	`wake_up
(&
fs_öfo
->
s¸ub_∑u£_waô
);

316 
	}
}

318 
	$s¸ub_blocked_if_√eded
(
båfs_fs_öfo
 *
fs_öfo
)

320 
	`s¸ub_∑u£_⁄
(
fs_öfo
);

321 
	`s¸ub_∑u£_off
(
fs_öfo
);

322 
	}
}

324 
noölöe_f‹_°ack
 
	$s¸ub_‰ì_˘x
(
s¸ub_˘x
 *
s˘x
)

326 
i
;

328 i‡(!
s˘x
)

331 
i
 = 0; i < 
SCRUB_TOTAL_STRIPES
; i++)

332 
	`ªÀa£_s¸ub_°rùe
(&
s˘x
->
°rùes
[
i
]);

334 
	`kv‰ì
(
s˘x
);

335 
	}
}

337 
	$s¸ub_put_˘x
(
s¸ub_˘x
 *
s˘x
)

339 i‡(
	`ªfcou¡_dec_™d_ã°
(&
s˘x
->
ªfs
))

340 
	`s¸ub_‰ì_˘x
(
s˘x
);

341 
	}
}

343 
noölöe_f‹_°ack
 
s¸ub_˘x
 *
	$s¸ub_£tup_˘x
(

344 
båfs_fs_öfo
 *
fs_öfo
, 
is_dev_ª∂a˚
)

346 
s¸ub_˘x
 *
s˘x
;

347 
i
;

352 
s˘x
 = 
	`kvzÆloc
((*s˘x), 
GFP_KERNEL
);

353 i‡(!
s˘x
)

354 
nomem
;

355 
	`ªfcou¡_£t
(&
s˘x
->
ªfs
, 1);

356 
s˘x
->
is_dev_ª∂a˚
 = is_dev_replace;

357 
s˘x
->
fs_öfo
 = fs_info;

358 
s˘x
->
exã¡_∑th
.
£¨ch_commô_roŸ
 = 1;

359 
s˘x
->
exã¡_∑th
.
skù_lockög
 = 1;

360 
s˘x
->
csum_∑th
.
£¨ch_commô_roŸ
 = 1;

361 
s˘x
->
csum_∑th
.
skù_lockög
 = 1;

362 
i
 = 0; i < 
SCRUB_TOTAL_STRIPES
; i++) {

363 
ªt
;

365 
ªt
 = 
	`öô_s¸ub_°rùe
(
fs_öfo
, &
s˘x
->
°rùes
[
i
]);

366 i‡(
ªt
 < 0)

367 
nomem
;

368 
s˘x
->
°rùes
[
i
].sctx = sctx;

370 
s˘x
->
fú°_‰ì
 = 0;

371 
	`©omic_£t
(&
s˘x
->
ˇn˚l_ªq
, 0);

373 
	`•ö_lock_öô
(&
s˘x
->
°©_lock
);

374 
s˘x
->
thrŸée_dódlöe
 = 0;

376 
	`muãx_öô
(&
s˘x
->
wr_lock
);

377 i‡(
is_dev_ª∂a˚
) {

378 
	`WARN_ON
(!
fs_öfo
->
dev_ª∂a˚
.
tgtdev
);

379 
s˘x
->
wr_tgtdev
 = 
fs_öfo
->
dev_ª∂a˚
.
tgtdev
;

382  
s˘x
;

384 
nomem
:

385 
	`s¸ub_‰ì_˘x
(
s˘x
);

386  
	`ERR_PTR
(-
ENOMEM
);

387 
	}
}

389 
	$s¸ub_¥öt_w¨nög_öode
(
u64
 
öum
, u64 
off£t
, u64 
num_byãs
,

390 
u64
 
roŸ
, *
w¨n_˘x
)

392 
u32
 
∆ök
;

393 
ªt
;

394 
i
;

395 
nofs_Êag
;

396 
exã¡_buf„r
 *
eb
;

397 
båfs_öode_ôem
 *
öode_ôem
;

398 
s¸ub_w¨nög
 *
sw¨n
 = 
w¨n_˘x
;

399 
båfs_fs_öfo
 *
fs_öfo
 = 
sw¨n
->
dev
->fs_info;

400 
öode_fs_∑ths
 *
ù©h
 = 
NULL
;

401 
båfs_roŸ
 *
loˇl_roŸ
;

402 
båfs_key
 
key
;

404 
loˇl_roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
roŸ
, 
åue
);

405 i‡(
	`IS_ERR
(
loˇl_roŸ
)) {

406 
ªt
 = 
	`PTR_ERR
(
loˇl_roŸ
);

407 
îr
;

413 
key
.
obje˘id
 = 
öum
;

414 
key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

415 
key
.
off£t
 = 0;

417 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
loˇl_roŸ
, &
key
, 
sw¨n
->
∑th
, 0, 0);

418 i‡(
ªt
) {

419 
	`båfs_put_roŸ
(
loˇl_roŸ
);

420 
	`båfs_ªÀa£_∑th
(
sw¨n
->
∑th
);

421 
îr
;

424 
eb
 = 
sw¨n
->
∑th
->
nodes
[0];

425 
öode_ôem
 = 
	`båfs_ôem_±r
(
eb
, 
sw¨n
->
∑th
->
¶Ÿs
[0],

426 
båfs_öode_ôem
);

427 
∆ök
 = 
	`båfs_öode_∆ök
(
eb
, 
öode_ôem
);

428 
	`båfs_ªÀa£_∑th
(
sw¨n
->
∑th
);

435 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

436 
ù©h
 = 
	`öô_ù©h
(4096, 
loˇl_roŸ
, 
sw¨n
->
∑th
);

437 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

438 i‡(
	`IS_ERR
(
ù©h
)) {

439 
	`båfs_put_roŸ
(
loˇl_roŸ
);

440 
ªt
 = 
	`PTR_ERR
(
ù©h
);

441 
ù©h
 = 
NULL
;

442 
îr
;

444 
ªt
 = 
	`∑ths_‰om_öode
(
öum
, 
ù©h
);

446 i‡(
ªt
 < 0)

447 
îr
;

453 
i
 = 0; i < 
ù©h
->
f•©h
->
ñem_˙t
; ++i)

454 
	`båfs_w¨n_ö_rcu
(
fs_öfo
,

456 
sw¨n
->
îr°r
, sw¨n->
logiˇl
,

457 
	`båfs_dev_«me
(
sw¨n
->
dev
),

458 
sw¨n
->
physiˇl
,

459 
roŸ
, 
öum
, 
off£t
,

460 
fs_öfo
->
£˘‹size
, 
∆ök
,

461 (*)()
ù©h
->
f•©h
->
vÆ
[
i
]);

463 
	`båfs_put_roŸ
(
loˇl_roŸ
);

464 
	`‰ì_ù©h
(
ù©h
);

467 
îr
:

468 
	`båfs_w¨n_ö_rcu
(
fs_öfo
,

470 
sw¨n
->
îr°r
, sw¨n->
logiˇl
,

471 
	`båfs_dev_«me
(
sw¨n
->
dev
),

472 
sw¨n
->
physiˇl
,

473 
roŸ
, 
öum
, 
off£t
, 
ªt
);

475 
	`‰ì_ù©h
(
ù©h
);

477 
	}
}

479 
	$s¸ub_¥öt_comm⁄_w¨nög
(c⁄° *
îr°r
, 
båfs_devi˚
 *
dev
,

480 
boﬁ
 
is_su≥r
, 
u64
 
logiˇl
, u64 
physiˇl
)

482 
båfs_fs_öfo
 *
fs_öfo
 = 
dev
->fs_info;

483 
båfs_∑th
 *
∑th
;

484 
båfs_key
 
found_key
;

485 
exã¡_buf„r
 *
eb
;

486 
båfs_exã¡_ôem
 *
ei
;

487 
s¸ub_w¨nög
 
sw¨n
;

488 
u64
 
Êags
 = 0;

489 
u32
 
ôem_size
;

490 
ªt
;

493 i‡(
is_su≥r
) {

494 
	`båfs_w¨n_ö_rcu
(
fs_öfo
, "%s on device %s,Öhysical %llu",

495 
îr°r
, 
	`båfs_dev_«me
(
dev
), 
physiˇl
);

498 
∑th
 = 
	`båfs_Æloc_∑th
();

499 i‡(!
∑th
)

502 
sw¨n
.
physiˇl
 =Öhysical;

503 
sw¨n
.
logiˇl
 =Üogical;

504 
sw¨n
.
îr°r
 =Érrstr;

505 
sw¨n
.
dev
 = 
NULL
;

507 
ªt
 = 
	`exã¡_‰om_logiˇl
(
fs_öfo
, 
sw¨n
.
logiˇl
, 
∑th
, &
found_key
,

508 &
Êags
);

509 i‡(
ªt
 < 0)

510 
out
;

512 
sw¨n
.
exã¡_ôem_size
 = 
found_key
.
off£t
;

514 
eb
 = 
∑th
->
nodes
[0];

515 
ei
 = 
	`båfs_ôem_±r
(
eb
, 
∑th
->
¶Ÿs
[0], 
båfs_exã¡_ôem
);

516 
ôem_size
 = 
	`båfs_ôem_size
(
eb
, 
∑th
->
¶Ÿs
[0]);

518 i‡(
Êags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

519 
±r
 = 0;

520 
u8
 
ªf_Àvñ
;

521 
u64
 
ªf_roŸ
;

523 
åue
) {

524 
ªt
 = 
	`åì_backªf_f‹_exã¡
(&
±r
, 
eb
, &
found_key
, 
ei
,

525 
ôem_size
, &
ªf_roŸ
,

526 &
ªf_Àvñ
);

527 i‡(
ªt
 < 0) {

528 
	`båfs_w¨n
(
fs_öfo
,

530 
sw¨n
.
logiˇl
, 
ªt
);

533 i‡(
ªt
 > 0)

535 
	`båfs_w¨n_ö_rcu
(
fs_öfo
,

537 
îr°r
, 
sw¨n
.
logiˇl
, 
	`båfs_dev_«me
(
dev
),

538 
sw¨n
.
physiˇl
, (
ªf_Àvñ
 ? "node" : "leaf"),

539 
ªf_Àvñ
, 
ªf_roŸ
);

541 
	`båfs_ªÀa£_∑th
(
∑th
);

543 
båfs_backªf_wÆk_˘x
 
˘x
 = { 0 };

545 
	`båfs_ªÀa£_∑th
(
∑th
);

547 
˘x
.
byãƒ
 = 
found_key
.
obje˘id
;

548 
˘x
.
exã¡_ôem_pos
 = 
sw¨n
.
logiˇl
 - 
found_key
.
obje˘id
;

549 
˘x
.
fs_öfo
 = fs_info;

551 
sw¨n
.
∑th
 =Öath;

552 
sw¨n
.
dev
 = dev;

554 
	`ôî©e_exã¡_öodes
(&
˘x
, 
åue
, 
s¸ub_¥öt_w¨nög_öode
, &
sw¨n
);

557 
out
:

558 
	`båfs_‰ì_∑th
(
∑th
);

559 
	}
}

561 
	$fûl_wrôî_poöãr_g≠
(
s¸ub_˘x
 *
s˘x
, 
u64
 
physiˇl
)

563 
ªt
 = 0;

564 
u64
 
Àngth
;

566 i‡(!
	`båfs_is_z⁄ed
(
s˘x
->
fs_öfo
))

569 i‡(!
	`båfs_dev_is_£quítül
(
s˘x
->
wr_tgtdev
, 
physiˇl
))

572 i‡(
s˘x
->
wrôe_poöãr
 < 
physiˇl
) {

573 
Àngth
 = 
physiˇl
 - 
s˘x
->
wrôe_poöãr
;

575 
ªt
 = 
	`båfs_z⁄ed_issue_zîoout
(
s˘x
->
wr_tgtdev
,

576 
s˘x
->
wrôe_poöãr
, 
Àngth
);

577 i‡(!
ªt
)

578 
s˘x
->
wrôe_poöãr
 = 
physiˇl
;

580  
ªt
;

581 
	}
}

583 
∑ge
 *
	$s¸ub_°rùe_gë_∑ge
(
s¸ub_°rùe
 *
°rùe
, 
£˘‹_ƒ
)

585 
båfs_fs_öfo
 *
fs_öfo
 = 
°rùe
->
bg
->fs_info;

586 
∑ge_ödex
 = (
£˘‹_ƒ
 << 
fs_öfo
->
£˘‹size_bôs
Ë>> 
PAGE_SHIFT
;

588  
°rùe
->
∑ges
[
∑ge_ödex
];

589 
	}
}

591 
	$s¸ub_°rùe_gë_∑ge_off£t
(
s¸ub_°rùe
 *
°rùe
,

592 
£˘‹_ƒ
)

594 
båfs_fs_öfo
 *
fs_öfo
 = 
°rùe
->
bg
->fs_info;

596  
	`off£t_ö_∑ge
(
£˘‹_ƒ
 << 
fs_öfo
->
£˘‹size_bôs
);

597 
	}
}

599 
	$s¸ub_vîify_⁄e_mëad©a
(
s¸ub_°rùe
 *
°rùe
, 
£˘‹_ƒ
)

601 
båfs_fs_öfo
 *
fs_öfo
 = 
°rùe
->
bg
->fs_info;

602 c⁄° 
u32
 
£˘‹s_≥r_åì
 = 
fs_öfo
->
nodesize
 >> fs_öfo->
£˘‹size_bôs
;

603 c⁄° 
u64
 
logiˇl
 = 
°rùe
->logiˇ»+ (
£˘‹_ƒ
 << 
fs_öfo
->
£˘‹size_bôs
);

604 c⁄° 
∑ge
 *
fú°_∑ge
 = 
	`s¸ub_°rùe_gë_∑ge
(
°rùe
, 
£˘‹_ƒ
);

605 c⁄° 
fú°_off
 = 
	`s¸ub_°rùe_gë_∑ge_off£t
(
°rùe
, 
£˘‹_ƒ
);

606 
	`SHASH_DESC_ON_STACK
(
shash
, 
fs_öfo
->
csum_shash
);

607 
u8
 
⁄_disk_csum
[
BTRFS_CSUM_SIZE
];

608 
u8
 
ˇlcuœãd_csum
[
BTRFS_CSUM_SIZE
];

609 
båfs_hódî
 *
hódî
;

616 
hódî
 = (
båfs_hódî
 *)(
	`∑ge_addªss
(
fú°_∑ge
Ë+ 
fú°_off
);

617 
	`mem˝y
(
⁄_disk_csum
, 
hódî
->
csum
, 
fs_öfo
->
csum_size
);

619 i‡(
logiˇl
 !
	`båfs_°ack_hódî_byãƒ
(
hódî
)) {

620 
	`bôm≠_£t
(&
°rùe
->
csum_îr‹_bôm≠
, 
£˘‹_ƒ
, 
£˘‹s_≥r_åì
);

621 
	`bôm≠_£t
(&
°rùe
->
îr‹_bôm≠
, 
£˘‹_ƒ
, 
£˘‹s_≥r_åì
);

622 
	`båfs_w¨n_æ
(
fs_öfo
,

624 
logiˇl
, 
°rùe
->
múr‹_num
,

625 
	`båfs_°ack_hódî_byãƒ
(
hódî
), 
logiˇl
);

628 i‡(
	`memcmp
(
hódî
->
fsid
, 
fs_öfo
->
fs_devi˚s
->
mëad©a_uuid
,

629 
BTRFS_FSID_SIZE
) != 0) {

630 
	`bôm≠_£t
(&
°rùe
->
mëa_îr‹_bôm≠
, 
£˘‹_ƒ
, 
£˘‹s_≥r_åì
);

631 
	`bôm≠_£t
(&
°rùe
->
îr‹_bôm≠
, 
£˘‹_ƒ
, 
£˘‹s_≥r_åì
);

632 
	`båfs_w¨n_æ
(
fs_öfo
,

634 
logiˇl
, 
°rùe
->
múr‹_num
,

635 
hódî
->
fsid
, 
fs_öfo
->
fs_devi˚s
->fsid);

638 i‡(
	`memcmp
(
hódî
->
chunk_åì_uuid
, 
fs_öfo
->chunk_tree_uuid,

639 
BTRFS_UUID_SIZE
) != 0) {

640 
	`bôm≠_£t
(&
°rùe
->
mëa_îr‹_bôm≠
, 
£˘‹_ƒ
, 
£˘‹s_≥r_åì
);

641 
	`bôm≠_£t
(&
°rùe
->
îr‹_bôm≠
, 
£˘‹_ƒ
, 
£˘‹s_≥r_åì
);

642 
	`båfs_w¨n_æ
(
fs_öfo
,

644 
logiˇl
, 
°rùe
->
múr‹_num
,

645 
hódî
->
chunk_åì_uuid
, 
fs_öfo
->chunk_tree_uuid);

650 
shash
->
tfm
 = 
fs_öfo
->
csum_shash
;

651 
	`¸y±o_shash_öô
(
shash
);

652 
	`¸y±o_shash_upd©e
(
shash
, 
	`∑ge_addªss
(
fú°_∑ge
Ë+ 
fú°_off
 +

653 
BTRFS_CSUM_SIZE
, 
fs_öfo
->
£˘‹size
 - BTRFS_CSUM_SIZE);

655 
i
 = 
£˘‹_ƒ
 + 1; i < se˘‹_ƒ + 
£˘‹s_≥r_åì
; i++) {

656 
∑ge
 *∑gê
	`s¸ub_°rùe_gë_∑ge
(
°rùe
, 
i
);

657 
∑ge_off
 = 
	`s¸ub_°rùe_gë_∑ge_off£t
(
°rùe
, 
i
);

659 
	`¸y±o_shash_upd©e
(
shash
, 
	`∑ge_addªss
(
∑ge
Ë+ 
∑ge_off
,

660 
fs_öfo
->
£˘‹size
);

663 
	`¸y±o_shash_föÆ
(
shash
, 
ˇlcuœãd_csum
);

664 i‡(
	`memcmp
(
ˇlcuœãd_csum
, 
⁄_disk_csum
, 
fs_öfo
->
csum_size
) != 0) {

665 
	`bôm≠_£t
(&
°rùe
->
mëa_îr‹_bôm≠
, 
£˘‹_ƒ
, 
£˘‹s_≥r_åì
);

666 
	`bôm≠_£t
(&
°rùe
->
îr‹_bôm≠
, 
£˘‹_ƒ
, 
£˘‹s_≥r_åì
);

667 
	`båfs_w¨n_æ
(
fs_öfo
,

668 "åì block %Œu múr‹ %u ha†bad csum, ha†" 
CSUM_FMT
 " want " CSUM_FMT,

669 
logiˇl
, 
°rùe
->
múr‹_num
,

670 
	`CSUM_FMT_VALUE
(
fs_öfo
->
csum_size
, 
⁄_disk_csum
),

671 
	`CSUM_FMT_VALUE
(
fs_öfo
->
csum_size
, 
ˇlcuœãd_csum
));

674 i‡(
°rùe
->
£˘‹s
[
£˘‹_ƒ
].
gíî©i⁄
 !=

675 
	`båfs_°ack_hódî_gíî©i⁄
(
hódî
)) {

676 
	`bôm≠_£t
(&
°rùe
->
mëa_îr‹_bôm≠
, 
£˘‹_ƒ
, 
£˘‹s_≥r_åì
);

677 
	`bôm≠_£t
(&
°rùe
->
îr‹_bôm≠
, 
£˘‹_ƒ
, 
£˘‹s_≥r_åì
);

678 
	`båfs_w¨n_æ
(
fs_öfo
,

680 
logiˇl
, 
°rùe
->
múr‹_num
,

681 
	`båfs_°ack_hódî_gíî©i⁄
(
hódî
),

682 
°rùe
->
£˘‹s
[
£˘‹_ƒ
].
gíî©i⁄
);

685 
	`bôm≠_˛ór
(&
°rùe
->
îr‹_bôm≠
, 
£˘‹_ƒ
, 
£˘‹s_≥r_åì
);

686 
	`bôm≠_˛ór
(&
°rùe
->
csum_îr‹_bôm≠
, 
£˘‹_ƒ
, 
£˘‹s_≥r_åì
);

687 
	`bôm≠_˛ór
(&
°rùe
->
mëa_îr‹_bôm≠
, 
£˘‹_ƒ
, 
£˘‹s_≥r_åì
);

688 
	}
}

690 
	$s¸ub_vîify_⁄e_£˘‹
(
s¸ub_°rùe
 *
°rùe
, 
£˘‹_ƒ
)

692 
båfs_fs_öfo
 *
fs_öfo
 = 
°rùe
->
bg
->fs_info;

693 
s¸ub_£˘‹_vîifiˇti⁄
 *
£˘‹
 = &
°rùe
->
£˘‹s
[
£˘‹_ƒ
];

694 c⁄° 
u32
 
£˘‹s_≥r_åì
 = 
fs_öfo
->
nodesize
 >> fs_öfo->
£˘‹size_bôs
;

695 
∑ge
 *∑gê
	`s¸ub_°rùe_gë_∑ge
(
°rùe
, 
£˘‹_ƒ
);

696 
pgoff
 = 
	`s¸ub_°rùe_gë_∑ge_off£t
(
°rùe
, 
£˘‹_ƒ
);

697 
u8
 
csum_buf
[
BTRFS_CSUM_SIZE
];

698 
ªt
;

700 
	`ASSERT
(
£˘‹_ƒ
 >0 && se˘‹_ƒ < 
°rùe
->
ƒ_£˘‹s
);

703 i‡(!
	`ã°_bô
(
£˘‹_ƒ
, &
°rùe
->
exã¡_£˘‹_bôm≠
))

707 i‡(
	`ã°_bô
(
£˘‹_ƒ
, &
°rùe
->
io_îr‹_bôm≠
))

711 i‡(
£˘‹
->
is_mëad©a
) {

720 i‡(
	`u∆ikñy
(
£˘‹_ƒ
 + 
£˘‹s_≥r_åì
 > 
°rùe
->
ƒ_£˘‹s
)) {

721 
	`båfs_w¨n_æ
(
fs_öfo
,

723 
°rùe
->
logiˇl
 +

724 (
£˘‹_ƒ
 << 
fs_öfo
->
£˘‹size_bôs
),

725 
°rùe
->
logiˇl
);

728 
	`s¸ub_vîify_⁄e_mëad©a
(
°rùe
, 
£˘‹_ƒ
);

736 i‡(!
£˘‹
->
csum
) {

737 
	`˛ór_bô
(
£˘‹_ƒ
, &
°rùe
->
îr‹_bôm≠
);

741 
ªt
 = 
	`båfs_check_£˘‹_csum
(
fs_öfo
, 
∑ge
, 
pgoff
, 
csum_buf
, 
£˘‹
->
csum
);

742 i‡(
ªt
 < 0) {

743 
	`£t_bô
(
£˘‹_ƒ
, &
°rùe
->
csum_îr‹_bôm≠
);

744 
	`£t_bô
(
£˘‹_ƒ
, &
°rùe
->
îr‹_bôm≠
);

746 
	`˛ór_bô
(
£˘‹_ƒ
, &
°rùe
->
csum_îr‹_bôm≠
);

747 
	`˛ór_bô
(
£˘‹_ƒ
, &
°rùe
->
îr‹_bôm≠
);

749 
	}
}

752 
	$s¸ub_vîify_⁄e_°rùe
(
s¸ub_°rùe
 *
°rùe
, 
bôm≠
)

754 
båfs_fs_öfo
 *
fs_öfo
 = 
°rùe
->
bg
->fs_info;

755 c⁄° 
u32
 
£˘‹s_≥r_åì
 = 
fs_öfo
->
nodesize
 >> fs_öfo->
£˘‹size_bôs
;

756 
£˘‹_ƒ
;

758 
	`f‹_óch_£t_bô
(
£˘‹_ƒ
, &
bôm≠
, 
°rùe
->
ƒ_£˘‹s
) {

759 
	`s¸ub_vîify_⁄e_£˘‹
(
°rùe
, 
£˘‹_ƒ
);

760 i‡(
°rùe
->
£˘‹s
[
£˘‹_ƒ
].
is_mëad©a
)

761 
£˘‹_ƒ
 +
£˘‹s_≥r_åì
 - 1;

763 
	}
}

765 
	$ˇlc_£˘‹_numbî
(
s¸ub_°rùe
 *
°rùe
, 
bio_vec
 *
fú°_bvec
)

767 
i
;

769 
i
 = 0; i < 
°rùe
->
ƒ_£˘‹s
; i++) {

770 i‡(
	`s¸ub_°rùe_gë_∑ge
(
°rùe
, 
i
Ë=
fú°_bvec
->
bv_∑ge
 &&

771 
	`s¸ub_°rùe_gë_∑ge_off£t
(
°rùe
, 
i
Ë=
fú°_bvec
->
bv_off£t
)

774 
	`ASSERT
(
i
 < 
°rùe
->
ƒ_£˘‹s
);

775  
i
;

776 
	}
}

784 
	$s¸ub_ª∑ú_ªad_ídio
(
båfs_bio
 *
bbio
)

786 
s¸ub_°rùe
 *
°rùe
 = 
bbio
->
¥iv©e
;

787 
båfs_fs_öfo
 *
fs_öfo
 = 
°rùe
->
bg
->fs_info;

788 
bio_vec
 *
bvec
;

789 
£˘‹_ƒ
 = 
	`ˇlc_£˘‹_numbî
(
°rùe
, 
	`bio_fú°_bvec_Æl
(&
bbio
->
bio
));

790 
u32
 
bio_size
 = 0;

791 
i
;

793 
	`ASSERT
(
£˘‹_ƒ
 < 
°rùe
->
ƒ_£˘‹s
);

795 
	`bio_f‹_óch_bvec_Æl
(
bvec
, &
bbio
->
bio
, 
i
)

796 
bio_size
 +
bvec
->
bv_Àn
;

798 i‡(
bbio
->
bio
.
bi_°©us
) {

799 
	`bôm≠_£t
(&
°rùe
->
io_îr‹_bôm≠
, 
£˘‹_ƒ
,

800 
bio_size
 >> 
fs_öfo
->
£˘‹size_bôs
);

801 
	`bôm≠_£t
(&
°rùe
->
îr‹_bôm≠
, 
£˘‹_ƒ
,

802 
bio_size
 >> 
fs_öfo
->
£˘‹size_bôs
);

804 
	`bôm≠_˛ór
(&
°rùe
->
io_îr‹_bôm≠
, 
£˘‹_ƒ
,

805 
bio_size
 >> 
fs_öfo
->
£˘‹size_bôs
);

807 
	`bio_put
(&
bbio
->
bio
);

808 i‡(
	`©omic_dec_™d_ã°
(&
°rùe
->
≥ndög_io
))

809 
	`wake_up
(&
°rùe
->
io_waô
);

810 
	}
}

812 
	$ˇlc_√xt_múr‹
(
múr‹
, 
num_c›õs
)

814 
	`ASSERT
(
múr‹
 <
num_c›õs
);

815  (
múr‹
 + 1 > 
num_c›õs
) ? 1 : mirror + 1;

816 
	}
}

818 
	$s¸ub_°rùe_submô_ª∑ú_ªad
(
s¸ub_°rùe
 *
°rùe
,

819 
múr‹
, 
blocksize
, 
boﬁ
 
waô
)

821 
båfs_fs_öfo
 *
fs_öfo
 = 
°rùe
->
bg
->fs_info;

822 
båfs_bio
 *
bbio
 = 
NULL
;

823 c⁄° 
ﬁd_îr‹_bôm≠
 = 
°rùe
->
îr‹_bôm≠
;

824 
i
;

826 
	`ASSERT
(
°rùe
->
múr‹_num
 >= 1);

827 
	`ASSERT
(
	`©omic_ªad
(&
°rùe
->
≥ndög_io
) == 0);

829 
	`f‹_óch_£t_bô
(
i
, &
ﬁd_îr‹_bôm≠
, 
°rùe
->
ƒ_£˘‹s
) {

830 
∑ge
 *page;

831 
pgoff
;

832 
ªt
;

834 
∑ge
 = 
	`s¸ub_°rùe_gë_∑ge
(
°rùe
, 
i
);

835 
pgoff
 = 
	`s¸ub_°rùe_gë_∑ge_off£t
(
°rùe
, 
i
);

838 i‡(
bbio
 && ((
i
 > 0 && !
	`ã°_bô
(ò- 1, &
°rùe
->
îr‹_bôm≠
)) ||

839 
bbio
->
bio
.
bi_ôî
.
bi_size
 >
blocksize
)) {

840 
	`ASSERT
(
bbio
->
bio
.
bi_ôî
.
bi_size
);

841 
	`©omic_öc
(&
°rùe
->
≥ndög_io
);

842 
	`båfs_submô_bio
(
bbio
, 
múr‹
);

843 i‡(
waô
)

844 
	`waô_s¸ub_°rùe_io
(
°rùe
);

845 
bbio
 = 
NULL
;

848 i‡(!
bbio
) {

849 
bbio
 = 
	`båfs_bio_Æloc
(
°rùe
->
ƒ_£˘‹s
, 
REQ_OP_READ
,

850 
fs_öfo
, 
s¸ub_ª∑ú_ªad_ídio
, 
°rùe
);

851 
bbio
->
bio
.
bi_ôî
.
bi_£˘‹
 = (
°rùe
->
logiˇl
 +

852 (
i
 << 
fs_öfo
->
£˘‹size_bôs
)Ë>> 
SECTOR_SHIFT
;

855 
ªt
 = 
	`bio_add_∑ge
(&
bbio
->
bio
, 
∑ge
, 
fs_öfo
->
£˘‹size
, 
pgoff
);

856 
	`ASSERT
(
ªt
 =
fs_öfo
->
£˘‹size
);

858 i‡(
bbio
) {

859 
	`ASSERT
(
bbio
->
bio
.
bi_ôî
.
bi_size
);

860 
	`©omic_öc
(&
°rùe
->
≥ndög_io
);

861 
	`båfs_submô_bio
(
bbio
, 
múr‹
);

862 i‡(
waô
)

863 
	`waô_s¸ub_°rùe_io
(
°rùe
);

865 
	}
}

867 
	$s¸ub_°rùe_ªp‹t_îr‹s
(
s¸ub_˘x
 *
s˘x
,

868 
s¸ub_°rùe
 *
°rùe
)

870 
	`DEFINE_RATELIMIT_STATE
(
rs
, 
DEFAULT_RATELIMIT_INTERVAL
,

871 
DEFAULT_RATELIMIT_BURST
);

872 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->fs_info;

873 
båfs_devi˚
 *
dev
 = 
NULL
;

874 
u64
 
physiˇl
 = 0;

875 
ƒ_d©a_£˘‹s
 = 0;

876 
ƒ_mëa_£˘‹s
 = 0;

877 
ƒ_nod©acsum_£˘‹s
 = 0;

878 
ƒ_ª∑úed_£˘‹s
 = 0;

879 
£˘‹_ƒ
;

881 i‡(
	`ã°_bô
(
SCRUB_STRIPE_FLAG_NO_REPORT
, &
°rùe
->
°©e
))

890 i‡(!
	`bôm≠_em±y
(&
°rùe
->
öô_îr‹_bôm≠
, såùe->
ƒ_£˘‹s
)) {

891 
u64
 
m≠≥d_Àn
 = 
fs_öfo
->
£˘‹size
;

892 
båfs_io_c⁄ãxt
 *
bioc
 = 
NULL
;

893 
°rùe_ödex
 = 
°rùe
->
múr‹_num
 - 1;

894 
ªt
;

897 
	`ASSERT
(
°rùe
->
múr‹_num
 >= 1);

898 
ªt
 = 
	`båfs_m≠_block
(
fs_öfo
, 
BTRFS_MAP_GET_READ_MIRRORS
,

899 
°rùe
->
logiˇl
, &
m≠≥d_Àn
, &
bioc
,

900 
NULL
, NULL, 1);

905 i‡(
ªt
 < 0)

906 
skù
;

907 
physiˇl
 = 
bioc
->
°rùes
[
°rùe_ödex
].physical;

908 
dev
 = 
bioc
->
°rùes
[
°rùe_ödex
].dev;

909 
	`båfs_put_bioc
(
bioc
);

912 
skù
:

913 
	`f‹_óch_£t_bô
(
£˘‹_ƒ
, &
°rùe
->
exã¡_£˘‹_bôm≠
, såùe->
ƒ_£˘‹s
) {

914 
boﬁ
 
ª∑úed
 = 
Ál£
;

916 i‡(
°rùe
->
£˘‹s
[
£˘‹_ƒ
].
is_mëad©a
) {

917 
ƒ_mëa_£˘‹s
++;

919 
ƒ_d©a_£˘‹s
++;

920 i‡(!
°rùe
->
£˘‹s
[
£˘‹_ƒ
].
csum
)

921 
ƒ_nod©acsum_£˘‹s
++;

924 i‡(
	`ã°_bô
(
£˘‹_ƒ
, &
°rùe
->
öô_îr‹_bôm≠
) &&

925 !
	`ã°_bô
(
£˘‹_ƒ
, &
°rùe
->
îr‹_bôm≠
)) {

926 
ƒ_ª∑úed_£˘‹s
++;

927 
ª∑úed
 = 
åue
;

931 i‡(!
	`ã°_bô
(
£˘‹_ƒ
, &
°rùe
->
öô_îr‹_bôm≠
))

938 i‡(
ª∑úed
) {

939 i‡(
dev
) {

940 
	`båfs_îr_æ_ö_rcu
(
fs_öfo
,

942 
°rùe
->
logiˇl
, 
	`båfs_dev_«me
(
dev
),

943 
physiˇl
);

945 
	`båfs_îr_æ_ö_rcu
(
fs_öfo
,

947 
°rùe
->
logiˇl
, såùe->
múr‹_num
);

953 i‡(
dev
) {

954 
	`båfs_îr_æ_ö_rcu
(
fs_öfo
,

956 
°rùe
->
logiˇl
, 
	`båfs_dev_«me
(
dev
),

957 
physiˇl
);

959 
	`båfs_îr_æ_ö_rcu
(
fs_öfo
,

961 
°rùe
->
logiˇl
, såùe->
múr‹_num
);

964 i‡(
	`ã°_bô
(
£˘‹_ƒ
, &
°rùe
->
io_îr‹_bôm≠
))

965 i‡(
	`__øãlimô
(&
rs
Ë&& 
dev
)

966 
	`s¸ub_¥öt_comm⁄_w¨nög
("i/ÿîr‹", 
dev
, 
Ál£
,

967 
°rùe
->
logiˇl
, 
physiˇl
);

968 i‡(
	`ã°_bô
(
£˘‹_ƒ
, &
°rùe
->
csum_îr‹_bôm≠
))

969 i‡(
	`__øãlimô
(&
rs
Ë&& 
dev
)

970 
	`s¸ub_¥öt_comm⁄_w¨nög
("checksumÉº‹", 
dev
, 
Ál£
,

971 
°rùe
->
logiˇl
, 
physiˇl
);

972 i‡(
	`ã°_bô
(
£˘‹_ƒ
, &
°rùe
->
mëa_îr‹_bôm≠
))

973 i‡(
	`__øãlimô
(&
rs
Ë&& 
dev
)

974 
	`s¸ub_¥öt_comm⁄_w¨nög
("hódîÉº‹", 
dev
, 
Ál£
,

975 
°rùe
->
logiˇl
, 
physiˇl
);

978 
	`•ö_lock
(&
s˘x
->
°©_lock
);

979 
s˘x
->
°©
.
d©a_exã¡s_s¸ubbed
 +
°rùe
->
ƒ_d©a_exã¡s
;

980 
s˘x
->
°©
.
åì_exã¡s_s¸ubbed
 +
°rùe
->
ƒ_mëa_exã¡s
;

981 
s˘x
->
°©
.
d©a_byãs_s¸ubbed
 +
ƒ_d©a_£˘‹s
 << 
fs_öfo
->
£˘‹size_bôs
;

982 
s˘x
->
°©
.
åì_byãs_s¸ubbed
 +
ƒ_mëa_£˘‹s
 << 
fs_öfo
->
£˘‹size_bôs
;

983 
s˘x
->
°©
.
no_csum
 +
ƒ_nod©acsum_£˘‹s
;

984 
s˘x
->
°©
.
ªad_îr‹s
 +
°rùe
->
öô_ƒ_io_îr‹s
;

985 
s˘x
->
°©
.
csum_îr‹s
 +
°rùe
->
öô_ƒ_csum_îr‹s
;

986 
s˘x
->
°©
.
vîify_îr‹s
 +
°rùe
->
öô_ƒ_mëa_îr‹s
;

987 
s˘x
->
°©
.
unc‹ª˘abÀ_îr‹s
 +=

988 
	`bôm≠_weight
(&
°rùe
->
îr‹_bôm≠
, såùe->
ƒ_£˘‹s
);

989 
s˘x
->
°©
.
c‹ª˘ed_îr‹s
 +
ƒ_ª∑úed_£˘‹s
;

990 
	`•ö_u∆ock
(&
s˘x
->
°©_lock
);

991 
	}
}

993 
s¸ub_wrôe_£˘‹s
(
s¸ub_˘x
 *
s˘x
, 
s¸ub_°rùe
 *
°rùe
,

994 
wrôe_bôm≠
, 
boﬁ
 
dev_ª∂a˚
);

1009 
	$s¸ub_°rùe_ªad_ª∑ú_w‹kî
(
w‹k_°ru˘
 *
w‹k
)

1011 
s¸ub_°rùe
 *
°rùe
 = 
	`c⁄èöî_of
(
w‹k
, scrub_stripe, work);

1012 
s¸ub_˘x
 *
s˘x
 = 
°rùe
->sctx;

1013 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->fs_info;

1014 
num_c›õs
 = 
	`båfs_num_c›õs
(
fs_öfo
, 
°rùe
->
bg
->
°¨t
,

1015 
°rùe
->
bg
->
Àngth
);

1016 
múr‹
;

1017 
i
;

1019 
	`ASSERT
(
°rùe
->
múr‹_num
 > 0);

1021 
	`waô_s¸ub_°rùe_io
(
°rùe
);

1022 
	`s¸ub_vîify_⁄e_°rùe
(
°rùe
, såùe->
exã¡_£˘‹_bôm≠
);

1024 
°rùe
->
öô_îr‹_bôm≠
 = såùe->
îr‹_bôm≠
;

1025 
°rùe
->
öô_ƒ_io_îr‹s
 = 
	`bôm≠_weight
(&°rùe->
io_îr‹_bôm≠
,

1026 
°rùe
->
ƒ_£˘‹s
);

1027 
°rùe
->
öô_ƒ_csum_îr‹s
 = 
	`bôm≠_weight
(&°rùe->
csum_îr‹_bôm≠
,

1028 
°rùe
->
ƒ_£˘‹s
);

1029 
°rùe
->
öô_ƒ_mëa_îr‹s
 = 
	`bôm≠_weight
(&°rùe->
mëa_îr‹_bôm≠
,

1030 
°rùe
->
ƒ_£˘‹s
);

1032 i‡(
	`bôm≠_em±y
(&
°rùe
->
öô_îr‹_bôm≠
, såùe->
ƒ_£˘‹s
))

1033 
out
;

1041 
múr‹
 = 
	`ˇlc_√xt_múr‹
(
°rùe
->
múr‹_num
, 
num_c›õs
);

1042 
múr‹
 !
°rùe
->
múr‹_num
;

1043 
múr‹
 = 
	`ˇlc_√xt_múr‹
(múr‹, 
num_c›õs
)) {

1044 c⁄° 
ﬁd_îr‹_bôm≠
 = 
°rùe
->
îr‹_bôm≠
;

1046 
	`s¸ub_°rùe_submô_ª∑ú_ªad
(
°rùe
, 
múr‹
,

1047 
BTRFS_STRIPE_LEN
, 
Ál£
);

1048 
	`waô_s¸ub_°rùe_io
(
°rùe
);

1049 
	`s¸ub_vîify_⁄e_°rùe
(
°rùe
, 
ﬁd_îr‹_bôm≠
);

1050 i‡(
	`bôm≠_em±y
(&
°rùe
->
îr‹_bôm≠
, såùe->
ƒ_£˘‹s
))

1051 
out
;

1065 
i
 = 0, 
múr‹
 = 
°rùe
->
múr‹_num
;

1066 
i
 < 
num_c›õs
;

1067 
i
++, 
múr‹
 = 
	`ˇlc_√xt_múr‹
(múr‹, 
num_c›õs
)) {

1068 c⁄° 
ﬁd_îr‹_bôm≠
 = 
°rùe
->
îr‹_bôm≠
;

1070 
	`s¸ub_°rùe_submô_ª∑ú_ªad
(
°rùe
, 
múr‹
,

1071 
fs_öfo
->
£˘‹size
, 
åue
);

1072 
	`waô_s¸ub_°rùe_io
(
°rùe
);

1073 
	`s¸ub_vîify_⁄e_°rùe
(
°rùe
, 
ﬁd_îr‹_bôm≠
);

1074 i‡(
	`bôm≠_em±y
(&
°rùe
->
îr‹_bôm≠
, såùe->
ƒ_£˘‹s
))

1075 
out
;

1077 
out
:

1082 i‡(
	`båfs_is_z⁄ed
(
fs_öfo
)) {

1083 i‡(!
	`bôm≠_em±y
(&
°rùe
->
îr‹_bôm≠
, såùe->
ƒ_£˘‹s
))

1084 
	`båfs_ª∑ú_⁄e_z⁄e
(
fs_öfo
, 
s˘x
->
°rùes
[0].
bg
->
°¨t
);

1085 } i‡(!
s˘x
->
ªad⁄ly
) {

1086 
ª∑úed
;

1088 
	`bôm≠_™dnŸ
(&
ª∑úed
, &
°rùe
->
öô_îr‹_bôm≠
,

1089 &
°rùe
->
îr‹_bôm≠
, såùe->
ƒ_£˘‹s
);

1090 
	`s¸ub_wrôe_£˘‹s
(
s˘x
, 
°rùe
, 
ª∑úed
, 
Ál£
);

1091 
	`waô_s¸ub_°rùe_io
(
°rùe
);

1094 
	`s¸ub_°rùe_ªp‹t_îr‹s
(
s˘x
, 
°rùe
);

1095 
	`£t_bô
(
SCRUB_STRIPE_FLAG_REPAIR_DONE
, &
°rùe
->
°©e
);

1096 
	`wake_up
(&
°rùe
->
ª∑ú_waô
);

1097 
	}
}

1099 
	$s¸ub_ªad_ídio
(
båfs_bio
 *
bbio
)

1101 
s¸ub_°rùe
 *
°rùe
 = 
bbio
->
¥iv©e
;

1103 i‡(
bbio
->
bio
.
bi_°©us
) {

1104 
	`bôm≠_£t
(&
°rùe
->
io_îr‹_bôm≠
, 0, såùe->
ƒ_£˘‹s
);

1105 
	`bôm≠_£t
(&
°rùe
->
îr‹_bôm≠
, 0, såùe->
ƒ_£˘‹s
);

1107 
	`bôm≠_˛ór
(&
°rùe
->
io_îr‹_bôm≠
, 0, såùe->
ƒ_£˘‹s
);

1109 
	`bio_put
(&
bbio
->
bio
);

1110 i‡(
	`©omic_dec_™d_ã°
(&
°rùe
->
≥ndög_io
)) {

1111 
	`wake_up
(&
°rùe
->
io_waô
);

1112 
	`INIT_WORK
(&
°rùe
->
w‹k
, 
s¸ub_°rùe_ªad_ª∑ú_w‹kî
);

1113 
	`queue_w‹k
(
°rùe
->
bg
->
fs_öfo
->
s¸ub_w‹kîs
, &°rùe->
w‹k
);

1115 
	}
}

1117 
	$s¸ub_wrôe_ídio
(
båfs_bio
 *
bbio
)

1119 
s¸ub_°rùe
 *
°rùe
 = 
bbio
->
¥iv©e
;

1120 
båfs_fs_öfo
 *
fs_öfo
 = 
°rùe
->
bg
->fs_info;

1121 
bio_vec
 *
bvec
;

1122 
£˘‹_ƒ
 = 
	`ˇlc_£˘‹_numbî
(
°rùe
, 
	`bio_fú°_bvec_Æl
(&
bbio
->
bio
));

1123 
u32
 
bio_size
 = 0;

1124 
i
;

1126 
	`bio_f‹_óch_bvec_Æl
(
bvec
, &
bbio
->
bio
, 
i
)

1127 
bio_size
 +
bvec
->
bv_Àn
;

1129 i‡(
bbio
->
bio
.
bi_°©us
) {

1130 
Êags
;

1132 
	`•ö_lock_úqßve
(&
°rùe
->
wrôe_îr‹_lock
, 
Êags
);

1133 
	`bôm≠_£t
(&
°rùe
->
wrôe_îr‹_bôm≠
, 
£˘‹_ƒ
,

1134 
bio_size
 >> 
fs_öfo
->
£˘‹size_bôs
);

1135 
	`•ö_u∆ock_úqª°‹e
(&
°rùe
->
wrôe_îr‹_lock
, 
Êags
);

1137 
	`bio_put
(&
bbio
->
bio
);

1139 i‡(
	`©omic_dec_™d_ã°
(&
°rùe
->
≥ndög_io
))

1140 
	`wake_up
(&
°rùe
->
io_waô
);

1141 
	}
}

1143 
	$s¸ub_submô_wrôe_bio
(
s¸ub_˘x
 *
s˘x
,

1144 
s¸ub_°rùe
 *
°rùe
,

1145 
båfs_bio
 *
bbio
, 
boﬁ
 
dev_ª∂a˚
)

1147 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->fs_info;

1148 
u32
 
bio_Àn
 = 
bbio
->
bio
.
bi_ôî
.
bi_size
;

1149 
u32
 
bio_off
 = (
bbio
->
bio
.
bi_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
) -

1150 
°rùe
->
logiˇl
;

1152 
	`fûl_wrôî_poöãr_g≠
(
s˘x
, 
°rùe
->
physiˇl
 + 
bio_off
);

1153 
	`©omic_öc
(&
°rùe
->
≥ndög_io
);

1154 
	`båfs_submô_ª∑ú_wrôe
(
bbio
, 
°rùe
->
múr‹_num
, 
dev_ª∂a˚
);

1155 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

1161 
	`waô_s¸ub_°rùe_io
(
°rùe
);

1167 i‡(!
	`ã°_bô
(
bio_off
 >> 
fs_öfo
->
£˘‹size_bôs
,

1168 &
°rùe
->
wrôe_îr‹_bôm≠
))

1169 
s˘x
->
wrôe_poöãr
 +
bio_Àn
;

1170 
	}
}

1185 
	$s¸ub_wrôe_£˘‹s
(
s¸ub_˘x
 *
s˘x
, 
s¸ub_°rùe
 *
°rùe
,

1186 
wrôe_bôm≠
, 
boﬁ
 
dev_ª∂a˚
)

1188 
båfs_fs_öfo
 *
fs_öfo
 = 
°rùe
->
bg
->fs_info;

1189 
båfs_bio
 *
bbio
 = 
NULL
;

1190 
£˘‹_ƒ
;

1192 
	`f‹_óch_£t_bô
(
£˘‹_ƒ
, &
wrôe_bôm≠
, 
°rùe
->
ƒ_£˘‹s
) {

1193 
∑ge
 *∑gê
	`s¸ub_°rùe_gë_∑ge
(
°rùe
, 
£˘‹_ƒ
);

1194 
pgoff
 = 
	`s¸ub_°rùe_gë_∑ge_off£t
(
°rùe
, 
£˘‹_ƒ
);

1195 
ªt
;

1198 
	`ASSERT
(
	`ã°_bô
(
£˘‹_ƒ
, &
°rùe
->
exã¡_£˘‹_bôm≠
));

1201 i‡(
bbio
 && 
£˘‹_ƒ
 && !
	`ã°_bô
(£˘‹_ƒ - 1, &
wrôe_bôm≠
)) {

1202 
	`s¸ub_submô_wrôe_bio
(
s˘x
, 
°rùe
, 
bbio
, 
dev_ª∂a˚
);

1203 
bbio
 = 
NULL
;

1205 i‡(!
bbio
) {

1206 
bbio
 = 
	`båfs_bio_Æloc
(
°rùe
->
ƒ_£˘‹s
, 
REQ_OP_WRITE
,

1207 
fs_öfo
, 
s¸ub_wrôe_ídio
, 
°rùe
);

1208 
bbio
->
bio
.
bi_ôî
.
bi_£˘‹
 = (
°rùe
->
logiˇl
 +

1209 (
£˘‹_ƒ
 << 
fs_öfo
->
£˘‹size_bôs
)) >>

1210 
SECTOR_SHIFT
;

1212 
ªt
 = 
	`bio_add_∑ge
(&
bbio
->
bio
, 
∑ge
, 
fs_öfo
->
£˘‹size
, 
pgoff
);

1213 
	`ASSERT
(
ªt
 =
fs_öfo
->
£˘‹size
);

1215 i‡(
bbio
)

1216 
	`s¸ub_submô_wrôe_bio
(
s˘x
, 
°rùe
, 
bbio
, 
dev_ª∂a˚
);

1217 
	}
}

1223 
	$s¸ub_thrŸée_dev_io
(
s¸ub_˘x
 *
s˘x
, 
båfs_devi˚
 *
devi˚
,

1224 
bio_size
)

1226 c⁄° 
time_¶i˚
 = 1000;

1227 
s64
 
dñè
;

1228 
ktime_t
 
now
;

1229 
u32
 
div
;

1230 
u64
 
bwlimô
;

1232 
bwlimô
 = 
	`READ_ONCE
(
devi˚
->
s¸ub_•ìd_max
);

1233 i‡(
bwlimô
 == 0)

1240 
div
 = 
	`max_t
(
u32
, 1, (u32)(
bwlimô
 / (16 * 1024 * 1024)));

1241 
div
 = 
	`mö_t
(
u32
, 64, div);

1244 
now
 = 
	`ktime_gë
();

1245 i‡(
s˘x
->
thrŸée_dódlöe
 == 0) {

1246 
s˘x
->
thrŸée_dódlöe
 = 
	`ktime_add_ms
(
now
, 
time_¶i˚
 / 
div
);

1247 
s˘x
->
thrŸée_£¡
 = 0;

1251 i‡(
	`ktime_bef‹e
(
now
, 
s˘x
->
thrŸée_dódlöe
)) {

1253 
s˘x
->
thrŸée_£¡
 +
bio_size
;

1254 i‡(
s˘x
->
thrŸée_£¡
 <
	`div_u64
(
bwlimô
, 
div
))

1258 
dñè
 = 
	`ktime_ms_dñè
(
s˘x
->
thrŸée_dódlöe
, 
now
);

1261 
dñè
 = 0;

1264 i‡(
dñè
) {

1265 
timeout
;

1267 
timeout
 = 
	`div_u64
(
dñè
 * 
HZ
, 1000);

1268 
	`scheduÀ_timeout_öãºu±ibÀ
(
timeout
);

1272 
s˘x
->
thrŸée_dódlöe
 = 0;

1273 
	}
}

1282 
	$gë_øid56_logic_off£t
(
u64
 
physiˇl
, 
num
,

1283 
m≠_lookup
 *
m≠
, 
u64
 *
off£t
,

1284 
u64
 *
°rùe_°¨t
)

1286 
i
;

1287 
j
 = 0;

1288 
u64
 
œ°_off£t
;

1289 c⁄° 
d©a_°rùes
 = 
	`ƒ_d©a_°rùes
(
m≠
);

1291 
œ°_off£t
 = (
physiˇl
 - 
m≠
->
°rùes
[
num
].physiˇlË* 
d©a_°rùes
;

1292 i‡(
°rùe_°¨t
)

1293 *
°rùe_°¨t
 = 
œ°_off£t
;

1295 *
off£t
 = 
œ°_off£t
;

1296 
i
 = 0; i < 
d©a_°rùes
; i++) {

1297 
u32
 
°rùe_ƒ
;

1298 
u32
 
°rùe_ödex
;

1299 
u32
 
rŸ
;

1301 *
off£t
 = 
œ°_off£t
 + 
	`båfs_°rùe_ƒ_to_off£t
(
i
);

1303 
°rùe_ƒ
 = (
u32
)(*
off£t
 >> 
BTRFS_STRIPE_LEN_SHIFT
Ë/ 
d©a_°rùes
;

1306 
rŸ
 = 
°rùe_ƒ
 % 
m≠
->
num_°rùes
;

1308 
rŸ
 +
i
;

1309 
°rùe_ödex
 = 
rŸ
 % 
m≠
->
num_°rùes
;

1310 i‡(
°rùe_ödex
 =
num
)

1312 i‡(
°rùe_ödex
 < 
num
)

1313 
j
++;

1315 *
off£t
 = 
œ°_off£t
 + 
	`båfs_°rùe_ƒ_to_off£t
(
j
);

1317 
	}
}

1324 
	$com∑ª_exã¡_ôem_ønge
(
båfs_∑th
 *
∑th
,

1325 
u64
 
£¨ch_°¨t
, u64 
£¨ch_Àn
)

1327 
båfs_fs_öfo
 *
fs_öfo
 = 
∑th
->
nodes
[0]->fs_info;

1328 
u64
 
Àn
;

1329 
båfs_key
 
key
;

1331 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

1332 
	`ASSERT
(
key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 ||

1333 
key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
);

1334 i‡(
key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
)

1335 
Àn
 = 
fs_öfo
->
nodesize
;

1337 
Àn
 = 
key
.
off£t
;

1339 i‡(
key
.
obje˘id
 + 
Àn
 <
£¨ch_°¨t
)

1341 i‡(
key
.
obje˘id
 >
£¨ch_°¨t
 + 
£¨ch_Àn
)

1344 
	}
}

1362 
	$föd_fú°_exã¡_ôem
(
båfs_roŸ
 *
exã¡_roŸ
,

1363 
båfs_∑th
 *
∑th
,

1364 
u64
 
£¨ch_°¨t
, u64 
£¨ch_Àn
)

1366 
båfs_fs_öfo
 *
fs_öfo
 = 
exã¡_roŸ
->fs_info;

1367 
båfs_key
 
key
;

1368 
ªt
;

1371 i‡(
∑th
->
nodes
[0])

1372 
£¨ch_f‹w¨d
;

1374 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
SKINNY_METADATA
))

1375 
key
.
ty≥
 = 
BTRFS_METADATA_ITEM_KEY
;

1377 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

1378 
key
.
obje˘id
 = 
£¨ch_°¨t
;

1379 
key
.
off£t
 = (
u64
)-1;

1381 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
exã¡_roŸ
, &
key
, 
∑th
, 0, 0);

1382 i‡(
ªt
 < 0)

1383  
ªt
;

1385 
	`ASSERT
(
ªt
 > 0);

1390 
ªt
 = 
	`båfs_¥evious_exã¡_ôem
(
exã¡_roŸ
, 
∑th
, 0);

1391 i‡(
ªt
 < 0)

1392  
ªt
;

1397 
£¨ch_f‹w¨d
:

1398 
åue
) {

1399 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

1400 i‡(
key
.
obje˘id
 >
£¨ch_°¨t
 + 
£¨ch_Àn
)

1402 i‡(
key
.
ty≥
 !
BTRFS_METADATA_ITEM_KEY
 &&

1403 
key
.
ty≥
 !
BTRFS_EXTENT_ITEM_KEY
)

1404 
√xt
;

1406 
ªt
 = 
	`com∑ª_exã¡_ôem_ønge
(
∑th
, 
£¨ch_°¨t
, 
£¨ch_Àn
);

1407 i‡(
ªt
 == 0)

1408  
ªt
;

1409 i‡(
ªt
 > 0)

1411 
√xt
:

1412 
∑th
->
¶Ÿs
[0]++;

1413 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
’©h->
nodes
[0])) {

1414 
ªt
 = 
	`båfs_√xt_Àaf
(
exã¡_roŸ
, 
∑th
);

1415 i‡(
ªt
) {

1417 
	`båfs_ªÀa£_∑th
(
∑th
);

1418  
ªt
;

1422 
	`båfs_ªÀa£_∑th
(
∑th
);

1424 
	}
}

1426 
	$gë_exã¡_öfo
(
båfs_∑th
 *
∑th
, 
u64
 *
exã¡_°¨t_ªt
,

1427 
u64
 *
size_ªt
, u64 *
Êags_ªt
, u64 *
gíî©i⁄_ªt
)

1429 
båfs_key
 
key
;

1430 
båfs_exã¡_ôem
 *
ei
;

1432 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

1433 
	`ASSERT
(
key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
 ||

1434 
key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
);

1435 *
exã¡_°¨t_ªt
 = 
key
.
obje˘id
;

1436 i‡(
key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
)

1437 *
size_ªt
 = 
∑th
->
nodes
[0]->
fs_öfo
->
nodesize
;

1439 *
size_ªt
 = 
key
.
off£t
;

1440 
ei
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0], 
båfs_exã¡_ôem
);

1441 *
Êags_ªt
 = 
	`båfs_exã¡_Êags
(
∑th
->
nodes
[0], 
ei
);

1442 *
gíî©i⁄_ªt
 = 
	`båfs_exã¡_gíî©i⁄
(
∑th
->
nodes
[0], 
ei
);

1443 
	}
}

1445 
	$sync_wrôe_poöãr_f‹_z⁄ed
(
s¸ub_˘x
 *
s˘x
, 
u64
 
logiˇl
,

1446 
u64
 
physiˇl
, u64 
physiˇl_íd
)

1448 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->fs_info;

1449 
ªt
 = 0;

1451 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

1454 
	`muãx_lock
(&
s˘x
->
wr_lock
);

1455 i‡(
s˘x
->
wrôe_poöãr
 < 
physiˇl_íd
) {

1456 
ªt
 = 
	`båfs_sync_z⁄e_wrôe_poöãr
(
s˘x
->
wr_tgtdev
, 
logiˇl
,

1457 
physiˇl
,

1458 
s˘x
->
wrôe_poöãr
);

1459 i‡(
ªt
)

1460 
	`båfs_îr
(
fs_öfo
,

1463 
	`muãx_u∆ock
(&
s˘x
->
wr_lock
);

1464 
	`båfs_dev_˛ór_z⁄e_em±y
(
s˘x
->
wr_tgtdev
, 
physiˇl
);

1466  
ªt
;

1467 
	}
}

1469 
	$fûl_⁄e_exã¡_öfo
(
båfs_fs_öfo
 *
fs_öfo
,

1470 
s¸ub_°rùe
 *
°rùe
,

1471 
u64
 
exã¡_°¨t
, u64 
exã¡_Àn
,

1472 
u64
 
exã¡_Êags
, u64 
exã¡_gí
)

1474 
u64
 
cur_logiˇl
 = 
	`max
(
°rùe
->
logiˇl
, 
exã¡_°¨t
);

1475 
cur_logiˇl
 < 
	`mö
(
°rùe
->
logiˇl
 + 
BTRFS_STRIPE_LEN
,

1476 
exã¡_°¨t
 + 
exã¡_Àn
);

1477 
cur_logiˇl
 +
fs_öfo
->
£˘‹size
) {

1478 c⁄° 
ƒ_£˘‹
 = (
cur_logiˇl
 - 
°rùe
->
logiˇl
) >>

1479 
fs_öfo
->
£˘‹size_bôs
;

1480 
s¸ub_£˘‹_vîifiˇti⁄
 *
£˘‹
 =

1481 &
°rùe
->
£˘‹s
[
ƒ_£˘‹
];

1483 
	`£t_bô
(
ƒ_£˘‹
, &
°rùe
->
exã¡_£˘‹_bôm≠
);

1484 i‡(
exã¡_Êags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

1485 
£˘‹
->
is_mëad©a
 = 
åue
;

1486 
£˘‹
->
gíî©i⁄
 = 
exã¡_gí
;

1489 
	}
}

1491 
	$s¸ub_°rùe_ª£t_bôm≠s
(
s¸ub_°rùe
 *
°rùe
)

1493 
°rùe
->
exã¡_£˘‹_bôm≠
 = 0;

1494 
°rùe
->
öô_îr‹_bôm≠
 = 0;

1495 
°rùe
->
öô_ƒ_io_îr‹s
 = 0;

1496 
°rùe
->
öô_ƒ_csum_îr‹s
 = 0;

1497 
°rùe
->
öô_ƒ_mëa_îr‹s
 = 0;

1498 
°rùe
->
îr‹_bôm≠
 = 0;

1499 
°rùe
->
io_îr‹_bôm≠
 = 0;

1500 
°rùe
->
csum_îr‹_bôm≠
 = 0;

1501 
°rùe
->
mëa_îr‹_bôm≠
 = 0;

1502 
	}
}

1511 
	$s¸ub_föd_fûl_fú°_°rùe
(
båfs_block_group
 *
bg
,

1512 
båfs_∑th
 *
exã¡_∑th
,

1513 
båfs_∑th
 *
csum_∑th
,

1514 
båfs_devi˚
 *
dev
, 
u64
 
physiˇl
,

1515 
múr‹_num
, 
u64
 
logiˇl_°¨t
,

1516 
u32
 
logiˇl_Àn
,

1517 
s¸ub_°rùe
 *
°rùe
)

1519 
båfs_fs_öfo
 *
fs_öfo
 = 
bg
->fs_info;

1520 
båfs_roŸ
 *
exã¡_roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
, 
bg
->
°¨t
);

1521 
båfs_roŸ
 *
csum_roŸ
 = 
	`båfs_csum_roŸ
(
fs_öfo
, 
bg
->
°¨t
);

1522 c⁄° 
u64
 
logiˇl_íd
 = 
logiˇl_°¨t
 + 
logiˇl_Àn
;

1523 
u64
 
cur_logiˇl
 = 
logiˇl_°¨t
;

1524 
u64
 
°rùe_íd
;

1525 
u64
 
exã¡_°¨t
;

1526 
u64
 
exã¡_Àn
;

1527 
u64
 
exã¡_Êags
;

1528 
u64
 
exã¡_gí
;

1529 
ªt
;

1531 
	`mem£t
(
°rùe
->
£˘‹s
, 0, (
s¸ub_£˘‹_vîifiˇti⁄
) *

1532 
°rùe
->
ƒ_£˘‹s
);

1533 
	`s¸ub_°rùe_ª£t_bôm≠s
(
°rùe
);

1536 
	`ASSERT
(
logiˇl_°¨t
 >
bg
->
°¨t
 && 
logiˇl_íd
 <bg->°¨à+ bg->
Àngth
);

1538 
ªt
 = 
	`föd_fú°_exã¡_ôem
(
exã¡_roŸ
, 
exã¡_∑th
, 
logiˇl_°¨t
,

1539 
logiˇl_Àn
);

1541 i‡(
ªt
)

1542 
out
;

1543 
	`gë_exã¡_öfo
(
exã¡_∑th
, &
exã¡_°¨t
, &
exã¡_Àn
, &
exã¡_Êags
,

1544 &
exã¡_gí
);

1545 i‡(
exã¡_Êags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
)

1546 
°rùe
->
ƒ_mëa_exã¡s
++;

1547 i‡(
exã¡_Êags
 & 
BTRFS_EXTENT_FLAG_DATA
)

1548 
°rùe
->
ƒ_d©a_exã¡s
++;

1549 
cur_logiˇl
 = 
	`max
(
exã¡_°¨t
, cur_logical);

1557 
°rùe
->
logiˇl
 = 
	`round_down
(
cur_logiˇl
 - 
bg
->
°¨t
, 
BTRFS_STRIPE_LEN
) +

1558 
bg
->
°¨t
;

1559 
°rùe
->
physiˇl
 =Öhysiˇ»+ såùe->
logiˇl
 - 
logiˇl_°¨t
;

1560 
°rùe
->
dev
 = dev;

1561 
°rùe
->
bg
 = bg;

1562 
°rùe
->
múr‹_num
 = mirror_num;

1563 
°rùe_íd
 = 
°rùe
->
logiˇl
 + 
BTRFS_STRIPE_LEN
 - 1;

1566 
	`fûl_⁄e_exã¡_öfo
(
fs_öfo
, 
°rùe
, 
exã¡_°¨t
, 
exã¡_Àn
,

1567 
exã¡_Êags
, 
exã¡_gí
);

1568 
cur_logiˇl
 = 
exã¡_°¨t
 + 
exã¡_Àn
;

1571 
cur_logiˇl
 <
°rùe_íd
) {

1572 
ªt
 = 
	`föd_fú°_exã¡_ôem
(
exã¡_roŸ
, 
exã¡_∑th
, 
cur_logiˇl
,

1573 
°rùe_íd
 - 
cur_logiˇl
 + 1);

1574 i‡(
ªt
 < 0)

1575 
out
;

1576 i‡(
ªt
 > 0) {

1577 
ªt
 = 0;

1580 
	`gë_exã¡_öfo
(
exã¡_∑th
, &
exã¡_°¨t
, &
exã¡_Àn
,

1581 &
exã¡_Êags
, &
exã¡_gí
);

1582 i‡(
exã¡_Êags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
)

1583 
°rùe
->
ƒ_mëa_exã¡s
++;

1584 i‡(
exã¡_Êags
 & 
BTRFS_EXTENT_FLAG_DATA
)

1585 
°rùe
->
ƒ_d©a_exã¡s
++;

1586 
	`fûl_⁄e_exã¡_öfo
(
fs_öfo
, 
°rùe
, 
exã¡_°¨t
, 
exã¡_Àn
,

1587 
exã¡_Êags
, 
exã¡_gí
);

1588 
cur_logiˇl
 = 
exã¡_°¨t
 + 
exã¡_Àn
;

1592 i‡(
bg
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
) {

1593 
£˘‹_ƒ
;

1594 
csum_bôm≠
 = 0;

1597 
	`ASSERT
(
°rùe
->
csums
);

1603 
	`ASSERT
(
BITS_PER_LONG
 >
BTRFS_STRIPE_LEN
 >> 
fs_öfo
->
£˘‹size_bôs
);

1605 
ªt
 = 
	`båfs_lookup_csums_bôm≠
(
csum_roŸ
, 
csum_∑th
,

1606 
°rùe
->
logiˇl
, 
°rùe_íd
,

1607 
°rùe
->
csums
, &
csum_bôm≠
);

1608 i‡(
ªt
 < 0)

1609 
out
;

1610 i‡(
ªt
 > 0)

1611 
ªt
 = 0;

1613 
	`f‹_óch_£t_bô
(
£˘‹_ƒ
, &
csum_bôm≠
, 
°rùe
->
ƒ_£˘‹s
) {

1614 
°rùe
->
£˘‹s
[
£˘‹_ƒ
].
csum
 = såùe->
csums
 +

1615 
£˘‹_ƒ
 * 
fs_öfo
->
csum_size
;

1618 
	`£t_bô
(
SCRUB_STRIPE_FLAG_INITIALIZED
, &
°rùe
->
°©e
);

1619 
out
:

1620  
ªt
;

1621 
	}
}

1623 
	$s¸ub_ª£t_°rùe
(
s¸ub_°rùe
 *
°rùe
)

1625 
	`s¸ub_°rùe_ª£t_bôm≠s
(
°rùe
);

1627 
°rùe
->
ƒ_mëa_exã¡s
 = 0;

1628 
°rùe
->
ƒ_d©a_exã¡s
 = 0;

1629 
°rùe
->
°©e
 = 0;

1631 
i
 = 0; i < 
°rùe
->
ƒ_£˘‹s
; i++) {

1632 
°rùe
->
£˘‹s
[
i
].
is_mëad©a
 = 
Ál£
;

1633 
°rùe
->
£˘‹s
[
i
].
csum
 = 
NULL
;

1634 
°rùe
->
£˘‹s
[
i
].
gíî©i⁄
 = 0;

1636 
	}
}

1638 
	$s¸ub_submô_öôül_ªad
(
s¸ub_˘x
 *
s˘x
,

1639 
s¸ub_°rùe
 *
°rùe
)

1641 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->fs_info;

1642 
båfs_bio
 *
bbio
;

1643 
múr‹
 = 
°rùe
->
múr‹_num
;

1645 
	`ASSERT
(
°rùe
->
bg
);

1646 
	`ASSERT
(
°rùe
->
múr‹_num
 > 0);

1647 
	`ASSERT
(
	`ã°_bô
(
SCRUB_STRIPE_FLAG_INITIALIZED
, &
°rùe
->
°©e
));

1649 
bbio
 = 
	`båfs_bio_Æloc
(
SCRUB_STRIPE_PAGES
, 
REQ_OP_READ
, 
fs_öfo
,

1650 
s¸ub_ªad_ídio
, 
°rùe
);

1653 
bbio
->
bio
.
bi_ôî
.
bi_£˘‹
 = 
°rùe
->
logiˇl
 >> 
SECTOR_SHIFT
;

1654 
i
 = 0; i < 
BTRFS_STRIPE_LEN
 >> 
PAGE_SHIFT
; i++) {

1655 
ªt
;

1657 
ªt
 = 
	`bio_add_∑ge
(&
bbio
->
bio
, 
°rùe
->
∑ges
[
i
], 
PAGE_SIZE
, 0);

1659 
	`ASSERT
(
ªt
 =
PAGE_SIZE
);

1661 
	`©omic_öc
(&
°rùe
->
≥ndög_io
);

1667 i‡(
s˘x
->
is_dev_ª∂a˚
 &&

1668 (
fs_öfo
->
dev_ª∂a˚
.
c⁄t_ªadög_‰om_§cdev_mode
 ==

1669 
BTRFS_DEV_REPLACE_ITEM_CONT_READING_FROM_SRCDEV_MODE_AVOID
 ||

1670 !
°rùe
->
dev
->
bdev
)) {

1671 
num_c›õs
 = 
	`båfs_num_c›õs
(
fs_öfo
, 
°rùe
->
bg
->
°¨t
,

1672 
°rùe
->
bg
->
Àngth
);

1674 
múr‹
 = 
	`ˇlc_√xt_múr‹
(múr‹, 
num_c›õs
);

1676 
	`båfs_submô_bio
(
bbio
, 
múr‹
);

1677 
	}
}

1679 
boﬁ
 
	$°rùe_has_mëad©a_îr‹
(
s¸ub_°rùe
 *
°rùe
)

1681 
i
;

1683 
	`f‹_óch_£t_bô
(
i
, &
°rùe
->
îr‹_bôm≠
, såùe->
ƒ_£˘‹s
) {

1684 i‡(
°rùe
->
£˘‹s
[
i
].
is_mëad©a
) {

1685 
båfs_fs_öfo
 *
fs_öfo
 = 
°rùe
->
bg
->fs_info;

1687 
	`båfs_îr
(
fs_öfo
,

1689 
°rùe
->
logiˇl
,

1690 
°rùe
->
logiˇl
 + (
i
 << 
fs_öfo
->
£˘‹size_bôs
));

1691  
åue
;

1694  
Ál£
;

1695 
	}
}

1697 
	$submô_öôül_group_ªad
(
s¸ub_˘x
 *
s˘x
,

1698 
fú°_¶Ÿ
,

1699 
ƒ_°rùes
)

1701 
blk_∂ug
 
∂ug
;

1703 
	`ASSERT
(
fú°_¶Ÿ
 < 
SCRUB_TOTAL_STRIPES
);

1704 
	`ASSERT
(
fú°_¶Ÿ
 + 
ƒ_°rùes
 <
SCRUB_TOTAL_STRIPES
);

1706 
	`s¸ub_thrŸée_dev_io
(
s˘x
, s˘x->
°rùes
[0].
dev
,

1707 
	`båfs_°rùe_ƒ_to_off£t
(
ƒ_°rùes
));

1708 
	`blk_°¨t_∂ug
(&
∂ug
);

1709 
i
 = 0; i < 
ƒ_°rùes
; i++) {

1710 
s¸ub_°rùe
 *
°rùe
 = &
s˘x
->
°rùes
[
fú°_¶Ÿ
 + 
i
];

1713 
	`ASSERT
(
	`ã°_bô
(
SCRUB_STRIPE_FLAG_INITIALIZED
, &
°rùe
->
°©e
));

1714 
	`s¸ub_submô_öôül_ªad
(
s˘x
, 
°rùe
);

1716 
	`blk_föish_∂ug
(&
∂ug
);

1717 
	}
}

1719 
	$Êush_s¸ub_°rùes
(
s¸ub_˘x
 *
s˘x
)

1721 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->fs_info;

1722 
s¸ub_°rùe
 *
°rùe
;

1723 c⁄° 
ƒ_°rùes
 = 
s˘x
->
cur_°rùe
;

1724 
ªt
 = 0;

1726 i‡(!
ƒ_°rùes
)

1729 
	`ASSERT
(
	`ã°_bô
(
SCRUB_STRIPE_FLAG_INITIALIZED
, &
s˘x
->
°rùes
[0].
°©e
));

1732 i‡(
ƒ_°rùes
 % 
SCRUB_STRIPES_PER_GROUP
) {

1733 c⁄° 
fú°_¶Ÿ
 = 
	`round_down
(
ƒ_°rùes
, 
SCRUB_STRIPES_PER_GROUP
);

1735 
	`submô_öôül_group_ªad
(
s˘x
, 
fú°_¶Ÿ
, 
ƒ_°rùes
 - first_slot);

1738 
i
 = 0; i < 
ƒ_°rùes
; i++) {

1739 
°rùe
 = &
s˘x
->
°rùes
[
i
];

1741 
	`waô_evít
(
°rùe
->
ª∑ú_waô
,

1742 
	`ã°_bô
(
SCRUB_STRIPE_FLAG_REPAIR_DONE
, &
°rùe
->
°©e
));

1746 i‡(
s˘x
->
is_dev_ª∂a˚
) {

1751 
i
 = 0; i < 
ƒ_°rùes
; i++) {

1752 i‡(
	`°rùe_has_mëad©a_îr‹
(&
s˘x
->
°rùes
[
i
])) {

1753 
ªt
 = -
EIO
;

1754 
out
;

1757 
i
 = 0; i < 
ƒ_°rùes
; i++) {

1758 
good
;

1760 
°rùe
 = &
s˘x
->
°rùes
[
i
];

1762 
	`ASSERT
(
°rùe
->
dev
 =
fs_öfo
->
dev_ª∂a˚
.
§cdev
);

1764 
	`bôm≠_™dnŸ
(&
good
, &
°rùe
->
exã¡_£˘‹_bôm≠
,

1765 &
°rùe
->
îr‹_bôm≠
, såùe->
ƒ_£˘‹s
);

1766 
	`s¸ub_wrôe_£˘‹s
(
s˘x
, 
°rùe
, 
good
, 
åue
);

1771 
i
 = 0; i < 
ƒ_°rùes
; i++) {

1772 
°rùe
 = &
s˘x
->
°rùes
[
i
];

1774 
	`waô_s¸ub_°rùe_io
(
°rùe
);

1775 
	`s¸ub_ª£t_°rùe
(
°rùe
);

1777 
out
:

1778 
s˘x
->
cur_°rùe
 = 0;

1779  
ªt
;

1780 
	}
}

1782 
	$øid56_s¸ub_waô_ídio
(
bio
 *bio)

1784 
	`com∂ëe
(
bio
->
bi_¥iv©e
);

1785 
	}
}

1787 
	$queue_s¸ub_°rùe
(
s¸ub_˘x
 *
s˘x
, 
båfs_block_group
 *
bg
,

1788 
båfs_devi˚
 *
dev
, 
múr‹_num
,

1789 
u64
 
logiˇl
, 
u32
 
Àngth
, u64 
physiˇl
,

1790 
u64
 *
found_logiˇl_ªt
)

1792 
s¸ub_°rùe
 *
°rùe
;

1793 
ªt
;

1799 
	`ASSERT
(
s˘x
->
cur_°rùe
 < 
SCRUB_TOTAL_STRIPES
);

1802 
	`ASSERT
(
found_logiˇl_ªt
);

1804 
°rùe
 = &
s˘x
->
°rùes
[s˘x->
cur_°rùe
];

1805 
	`s¸ub_ª£t_°rùe
(
°rùe
);

1806 
ªt
 = 
	`s¸ub_föd_fûl_fú°_°rùe
(
bg
, &
s˘x
->
exã¡_∑th
,

1807 &
s˘x
->
csum_∑th
, 
dev
, 
physiˇl
,

1808 
múr‹_num
, 
logiˇl
, 
Àngth
, 
°rùe
);

1810 i‡(
ªt
)

1811  
ªt
;

1812 *
found_logiˇl_ªt
 = 
°rùe
->
logiˇl
;

1813 
s˘x
->
cur_°rùe
++;

1816 i‡(
s˘x
->
cur_°rùe
 % 
SCRUB_STRIPES_PER_GROUP
 == 0) {

1817 c⁄° 
fú°_¶Ÿ
 = 
s˘x
->
cur_°rùe
 - 
SCRUB_STRIPES_PER_GROUP
;

1819 
	`submô_öôül_group_ªad
(
s˘x
, 
fú°_¶Ÿ
, 
SCRUB_STRIPES_PER_GROUP
);

1823 i‡(
s˘x
->
cur_°rùe
 =
SCRUB_TOTAL_STRIPES
)

1824  
	`Êush_s¸ub_°rùes
(
s˘x
);

1826 
	}
}

1828 
	$s¸ub_øid56_∑rôy_°rùe
(
s¸ub_˘x
 *
s˘x
,

1829 
båfs_devi˚
 *
s¸ub_dev
,

1830 
båfs_block_group
 *
bg
,

1831 
m≠_lookup
 *
m≠
,

1832 
u64
 
fuŒ_°rùe_°¨t
)

1834 
	`DECLARE_COMPLETION_ONSTACK
(
io_d⁄e
);

1835 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->fs_info;

1836 
båfs_øid_bio
 *
rbio
;

1837 
båfs_io_c⁄ãxt
 *
bioc
 = 
NULL
;

1838 
båfs_∑th
 
exã¡_∑th
 = { 0 };

1839 
båfs_∑th
 
csum_∑th
 = { 0 };

1840 
bio
 *bio;

1841 
s¸ub_°rùe
 *
°rùe
;

1842 
boﬁ
 
Æl_em±y
 = 
åue
;

1843 c⁄° 
d©a_°rùes
 = 
	`ƒ_d©a_°rùes
(
m≠
);

1844 
exã¡_bôm≠
 = 0;

1845 
u64
 
Àngth
 = 
	`båfs_°rùe_ƒ_to_off£t
(
d©a_°rùes
);

1846 
ªt
;

1848 
	`ASSERT
(
s˘x
->
øid56_d©a_°rùes
);

1855 
exã¡_∑th
.
£¨ch_commô_roŸ
 = 1;

1856 
exã¡_∑th
.
skù_lockög
 = 1;

1857 
csum_∑th
.
£¨ch_commô_roŸ
 = 1;

1858 
csum_∑th
.
skù_lockög
 = 1;

1860 
i
 = 0; i < 
d©a_°rùes
; i++) {

1861 
°rùe_ödex
;

1862 
rŸ
;

1863 
u64
 
physiˇl
;

1865 
°rùe
 = &
s˘x
->
øid56_d©a_°rùes
[
i
];

1866 
rŸ
 = 
	`div_u64
(
fuŒ_°rùe_°¨t
 - 
bg
->
°¨t
,

1867 
d©a_°rùes
Ë>> 
BTRFS_STRIPE_LEN_SHIFT
;

1868 
°rùe_ödex
 = (
i
 + 
rŸ
Ë% 
m≠
->
num_°rùes
;

1869 
physiˇl
 = 
m≠
->
°rùes
[
°rùe_ödex
].physical +

1870 
	`båfs_°rùe_ƒ_to_off£t
(
rŸ
);

1872 
	`s¸ub_ª£t_°rùe
(
°rùe
);

1873 
	`£t_bô
(
SCRUB_STRIPE_FLAG_NO_REPORT
, &
°rùe
->
°©e
);

1874 
ªt
 = 
	`s¸ub_föd_fûl_fú°_°rùe
(
bg
, &
exã¡_∑th
, &
csum_∑th
,

1875 
m≠
->
°rùes
[
°rùe_ödex
].
dev
, 
physiˇl
, 1,

1876 
fuŒ_°rùe_°¨t
 + 
	`båfs_°rùe_ƒ_to_off£t
(
i
),

1877 
BTRFS_STRIPE_LEN
, 
°rùe
);

1878 i‡(
ªt
 < 0)

1879 
out
;

1884 i‡(
ªt
 > 0) {

1885 
°rùe
->
logiˇl
 = 
fuŒ_°rùe_°¨t
 +

1886 
	`båfs_°rùe_ƒ_to_off£t
(
i
);

1887 
°rùe
->
dev
 = 
m≠
->
°rùes
[
°rùe_ödex
].dev;

1888 
°rùe
->
múr‹_num
 = 1;

1889 
	`£t_bô
(
SCRUB_STRIPE_FLAG_INITIALIZED
, &
°rùe
->
°©e
);

1894 
i
 = 0; i < 
d©a_°rùes
; i++) {

1895 
°rùe
 = &
s˘x
->
øid56_d©a_°rùes
[
i
];

1896 i‡(!
	`bôm≠_em±y
(&
°rùe
->
exã¡_£˘‹_bôm≠
, såùe->
ƒ_£˘‹s
)) {

1897 
Æl_em±y
 = 
Ál£
;

1901 i‡(
Æl_em±y
) {

1902 
ªt
 = 0;

1903 
out
;

1906 
i
 = 0; i < 
d©a_°rùes
; i++) {

1907 
°rùe
 = &
s˘x
->
øid56_d©a_°rùes
[
i
];

1908 
	`s¸ub_submô_öôül_ªad
(
s˘x
, 
°rùe
);

1910 
i
 = 0; i < 
d©a_°rùes
; i++) {

1911 
°rùe
 = &
s˘x
->
øid56_d©a_°rùes
[
i
];

1913 
	`waô_evít
(
°rùe
->
ª∑ú_waô
,

1914 
	`ã°_bô
(
SCRUB_STRIPE_FLAG_REPAIR_DONE
, &
°rùe
->
°©e
));

1917 
	`ASSERT
(!
	`båfs_is_z⁄ed
(
s˘x
->
fs_öfo
));

1926 
i
 = 0; i < 
d©a_°rùes
; i++) {

1927 
îr‹
;

1929 
°rùe
 = &
s˘x
->
øid56_d©a_°rùes
[
i
];

1935 
	`bôm≠_™d
(&
îr‹
, &
°rùe
->
îr‹_bôm≠
,

1936 &
°rùe
->
exã¡_£˘‹_bôm≠
, såùe->
ƒ_£˘‹s
);

1937 i‡(!
	`bôm≠_em±y
(&
îr‹
, 
°rùe
->
ƒ_£˘‹s
)) {

1938 
	`båfs_îr
(
fs_öfo
,

1940 
fuŒ_°rùe_°¨t
, 
i
, 
°rùe
->
ƒ_£˘‹s
,

1941 &
îr‹
);

1942 
ªt
 = -
EIO
;

1943 
out
;

1945 
	`bôm≠_‹
(&
exã¡_bôm≠
, &extent_bitmap,

1946 &
°rùe
->
exã¡_£˘‹_bôm≠
, såùe->
ƒ_£˘‹s
);

1950 
bio
 = 
	`bio_Æloc
(
NULL
, 1, 
REQ_OP_READ
, 
GFP_NOFS
);

1951 
bio
->
bi_ôî
.
bi_£˘‹
 = 
fuŒ_°rùe_°¨t
 >> 
SECTOR_SHIFT
;

1952 
bio
->
bi_¥iv©e
 = &
io_d⁄e
;

1953 
bio
->
bi_íd_io
 = 
øid56_s¸ub_waô_ídio
;

1955 
	`båfs_bio_cou¡î_öc_blocked
(
fs_öfo
);

1956 
ªt
 = 
	`båfs_m≠_block
(
fs_öfo
, 
BTRFS_MAP_WRITE
, 
fuŒ_°rùe_°¨t
,

1957 &
Àngth
, &
bioc
, 
NULL
, NULL, 1);

1958 i‡(
ªt
 < 0) {

1959 
	`båfs_put_bioc
(
bioc
);

1960 
	`båfs_bio_cou¡î_dec
(
fs_öfo
);

1961 
out
;

1963 
rbio
 = 
	`øid56_∑rôy_Æloc_s¸ub_rbio
(
bio
, 
bioc
, 
s¸ub_dev
, &
exã¡_bôm≠
,

1964 
BTRFS_STRIPE_LEN
 >> 
fs_öfo
->
£˘‹size_bôs
);

1965 
	`båfs_put_bioc
(
bioc
);

1966 i‡(!
rbio
) {

1967 
ªt
 = -
ENOMEM
;

1968 
	`båfs_bio_cou¡î_dec
(
fs_öfo
);

1969 
out
;

1972 
i
 = 0; i < 
d©a_°rùes
; i++) {

1973 
°rùe
 = &
s˘x
->
øid56_d©a_°rùes
[
i
];

1975 
	`øid56_∑rôy_ˇche_d©a_∑ges
(
rbio
, 
°rùe
->
∑ges
,

1976 
fuŒ_°rùe_°¨t
 + (
i
 << 
BTRFS_STRIPE_LEN_SHIFT
));

1978 
	`øid56_∑rôy_submô_s¸ub_rbio
(
rbio
);

1979 
	`waô_f‹_com∂ëi⁄_io
(&
io_d⁄e
);

1980 
ªt
 = 
	`blk_°©us_to_î∫o
(
bio
->
bi_°©us
);

1981 
	`bio_put
(
bio
);

1982 
	`båfs_bio_cou¡î_dec
(
fs_öfo
);

1984 
	`båfs_ªÀa£_∑th
(&
exã¡_∑th
);

1985 
	`båfs_ªÀa£_∑th
(&
csum_∑th
);

1986 
out
:

1987  
ªt
;

1988 
	}
}

1998 
	$s¸ub_sim∂e_múr‹
(
s¸ub_˘x
 *
s˘x
,

1999 
båfs_block_group
 *
bg
,

2000 
m≠_lookup
 *
m≠
,

2001 
u64
 
logiˇl_°¨t
, u64 
logiˇl_Àngth
,

2002 
båfs_devi˚
 *
devi˚
,

2003 
u64
 
physiˇl
, 
múr‹_num
)

2005 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->fs_info;

2006 c⁄° 
u64
 
logiˇl_íd
 = 
logiˇl_°¨t
 + 
logiˇl_Àngth
;

2007 
u64
 
cur_logiˇl
 = 
logiˇl_°¨t
;

2008 
ªt
;

2011 
	`ASSERT
(
logiˇl_°¨t
 >
bg
->
°¨t
 && 
logiˇl_íd
 <bg->°¨à+ bg->
Àngth
);

2014 
cur_logiˇl
 < 
logiˇl_íd
) {

2015 
u64
 
found_logiˇl
 = 
U64_MAX
;

2016 
u64
 
cur_physiˇl
 = 
physiˇl
 + 
cur_logiˇl
 - 
logiˇl_°¨t
;

2019 i‡(
	`©omic_ªad
(&
fs_öfo
->
s¸ub_ˇn˚l_ªq
) ||

2020 
	`©omic_ªad
(&
s˘x
->
ˇn˚l_ªq
)) {

2021 
ªt
 = -
ECANCELED
;

2025 i‡(
	`©omic_ªad
(&
fs_öfo
->
s¸ub_∑u£_ªq
)) {

2027 
	`s¸ub_blocked_if_√eded
(
fs_öfo
);

2030 
	`•ö_lock
(&
bg
->
lock
);

2031 i‡(
	`ã°_bô
(
BLOCK_GROUP_FLAG_REMOVED
, &
bg
->
ru¡ime_Êags
)) {

2032 
	`•ö_u∆ock
(&
bg
->
lock
);

2033 
ªt
 = 0;

2036 
	`•ö_u∆ock
(&
bg
->
lock
);

2038 
ªt
 = 
	`queue_s¸ub_°rùe
(
s˘x
, 
bg
, 
devi˚
, 
múr‹_num
,

2039 
cur_logiˇl
, 
logiˇl_íd
 - cur_logical,

2040 
cur_physiˇl
, &
found_logiˇl
);

2041 i‡(
ªt
 > 0) {

2043 
s˘x
->
°©
.
œ°_physiˇl
 = 
physiˇl
 + 
logiˇl_Àngth
;

2044 
ªt
 = 0;

2047 i‡(
ªt
 < 0)

2051 
	`ASSERT
(
found_logiˇl
 !
U64_MAX
);

2052 
cur_logiˇl
 = 
found_logiˇl
 + 
BTRFS_STRIPE_LEN
;

2055 
	`c⁄d_ªsched
();

2057  
ªt
;

2058 
	}
}

2061 
u64
 
	$sim∂e_°rùe_fuŒ_°rùe_Àn
(c⁄° 
m≠_lookup
 *
m≠
)

2063 
	`ASSERT
(
m≠
->
ty≥
 & (
BTRFS_BLOCK_GROUP_RAID0
 |

2064 
BTRFS_BLOCK_GROUP_RAID10
));

2066  
	`båfs_°rùe_ƒ_to_off£t
(
m≠
->
num_°rùes
 / m≠->
sub_°rùes
);

2067 
	}
}

2070 
u64
 
	$sim∂e_°rùe_gë_logiˇl
(
m≠_lookup
 *
m≠
,

2071 
båfs_block_group
 *
bg
,

2072 
°rùe_ödex
)

2074 
	`ASSERT
(
m≠
->
ty≥
 & (
BTRFS_BLOCK_GROUP_RAID0
 |

2075 
BTRFS_BLOCK_GROUP_RAID10
));

2076 
	`ASSERT
(
°rùe_ödex
 < 
m≠
->
num_°rùes
);

2082  
	`båfs_°rùe_ƒ_to_off£t
(
°rùe_ödex
 / 
m≠
->
sub_°rùes
) +

2083 
bg
->
°¨t
;

2084 
	}
}

2087 
	$sim∂e_°rùe_múr‹_num
(
m≠_lookup
 *
m≠
, 
°rùe_ödex
)

2089 
	`ASSERT
(
m≠
->
ty≥
 & (
BTRFS_BLOCK_GROUP_RAID0
 |

2090 
BTRFS_BLOCK_GROUP_RAID10
));

2091 
	`ASSERT
(
°rùe_ödex
 < 
m≠
->
num_°rùes
);

2094  
°rùe_ödex
 % 
m≠
->
sub_°rùes
 + 1;

2095 
	}
}

2097 
	$s¸ub_sim∂e_°rùe
(
s¸ub_˘x
 *
s˘x
,

2098 
båfs_block_group
 *
bg
,

2099 
m≠_lookup
 *
m≠
,

2100 
båfs_devi˚
 *
devi˚
,

2101 
°rùe_ödex
)

2103 c⁄° 
u64
 
logiˇl_ö¸emít
 = 
	`sim∂e_°rùe_fuŒ_°rùe_Àn
(
m≠
);

2104 c⁄° 
u64
 
‹ig_logiˇl
 = 
	`sim∂e_°rùe_gë_logiˇl
(
m≠
, 
bg
, 
°rùe_ödex
);

2105 c⁄° 
u64
 
‹ig_physiˇl
 = 
m≠
->
°rùes
[
°rùe_ödex
].
physiˇl
;

2106 c⁄° 
múr‹_num
 = 
	`sim∂e_°rùe_múr‹_num
(
m≠
, 
°rùe_ödex
);

2107 
u64
 
cur_logiˇl
 = 
‹ig_logiˇl
;

2108 
u64
 
cur_physiˇl
 = 
‹ig_physiˇl
;

2109 
ªt
 = 0;

2111 
cur_logiˇl
 < 
bg
->
°¨t
 + bg->
Àngth
) {

2117 
ªt
 = 
	`s¸ub_sim∂e_múr‹
(
s˘x
, 
bg
, 
m≠
, 
cur_logiˇl
,

2118 
BTRFS_STRIPE_LEN
, 
devi˚
, 
cur_physiˇl
,

2119 
múr‹_num
);

2120 i‡(
ªt
)

2121  
ªt
;

2123 
cur_logiˇl
 +
logiˇl_ö¸emít
;

2125 
cur_physiˇl
 +
BTRFS_STRIPE_LEN
;

2127  
ªt
;

2128 
	}
}

2130 
noölöe_f‹_°ack
 
	$s¸ub_°rùe
(
s¸ub_˘x
 *
s˘x
,

2131 
båfs_block_group
 *
bg
,

2132 
exã¡_m≠
 *
em
,

2133 
båfs_devi˚
 *
s¸ub_dev
,

2134 
°rùe_ödex
)

2136 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->fs_info;

2137 
m≠_lookup
 *
m≠
 = 
em
->map_lookup;

2138 c⁄° 
u64
 
¥ofûe
 = 
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
;

2139 c⁄° 
u64
 
chunk_logiˇl
 = 
bg
->
°¨t
;

2140 
ªt
;

2141 
ªt2
;

2142 
u64
 
physiˇl
 = 
m≠
->
°rùes
[
°rùe_ödex
].physical;

2143 c⁄° 
u64
 
dev_°rùe_Àn
 = 
	`båfs_ˇlc_°rùe_Àngth
(
em
);

2144 c⁄° 
u64
 
physiˇl_íd
 = 
physiˇl
 + 
dev_°rùe_Àn
;

2145 
u64
 
logiˇl
;

2146 
u64
 
logic_íd
;

2148 
u64
 
ö¸emít
;

2150 
u64
 
off£t
;

2151 
u64
 
°rùe_logiˇl
;

2152 
°›_lo›
 = 0;

2155 
	`ASSERT
(
s˘x
->
exã¡_∑th
.
nodes
[0] =
NULL
);

2157 
	`s¸ub_blocked_if_√eded
(
fs_öfo
);

2159 i‡(
s˘x
->
is_dev_ª∂a˚
 &&

2160 
	`båfs_dev_is_£quítül
(
s˘x
->
wr_tgtdev
, 
physiˇl
)) {

2161 
	`muãx_lock
(&
s˘x
->
wr_lock
);

2162 
s˘x
->
wrôe_poöãr
 = 
physiˇl
;

2163 
	`muãx_u∆ock
(&
s˘x
->
wr_lock
);

2167 i‡(
¥ofûe
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

2168 
	`ASSERT
(
s˘x
->
øid56_d©a_°rùes
 =
NULL
);

2170 
s˘x
->
øid56_d©a_°rùes
 = 
	`kˇŒoc
(
	`ƒ_d©a_°rùes
(
m≠
),

2171 (
s¸ub_°rùe
),

2172 
GFP_KERNEL
);

2173 i‡(!
s˘x
->
øid56_d©a_°rùes
) {

2174 
ªt
 = -
ENOMEM
;

2175 
out
;

2177 
i
 = 0; i < 
	`ƒ_d©a_°rùes
(
m≠
); i++) {

2178 
ªt
 = 
	`öô_s¸ub_°rùe
(
fs_öfo
,

2179 &
s˘x
->
øid56_d©a_°rùes
[
i
]);

2180 i‡(
ªt
 < 0)

2181 
out
;

2182 
s˘x
->
øid56_d©a_°rùes
[
i
].
bg
 = bg;

2183 
s˘x
->
øid56_d©a_°rùes
[
i
].sctx = sctx;

2193 i‡(!(
¥ofûe
 & (
BTRFS_BLOCK_GROUP_RAID0
 | 
BTRFS_BLOCK_GROUP_RAID10
 |

2194 
BTRFS_BLOCK_GROUP_RAID56_MASK
))) {

2203 
ªt
 = 
	`s¸ub_sim∂e_múr‹
(
s˘x
, 
bg
, 
m≠
, bg->
°¨t
, bg->
Àngth
,

2204 
s¸ub_dev
, 
m≠
->
°rùes
[
°rùe_ödex
].
physiˇl
,

2205 
°rùe_ödex
 + 1);

2206 
off£t
 = 0;

2207 
out
;

2209 i‡(
¥ofûe
 & (
BTRFS_BLOCK_GROUP_RAID0
 | 
BTRFS_BLOCK_GROUP_RAID10
)) {

2210 
ªt
 = 
	`s¸ub_sim∂e_°rùe
(
s˘x
, 
bg
, 
m≠
, 
s¸ub_dev
, 
°rùe_ödex
);

2211 
off£t
 = 
	`båfs_°rùe_ƒ_to_off£t
(
°rùe_ödex
 / 
m≠
->
sub_°rùes
);

2212 
out
;

2216 
	`ASSERT
(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
);

2217 
ªt
 = 0;

2220 
	`gë_øid56_logic_off£t
(
physiˇl_íd
, 
°rùe_ödex
,

2221 
m≠
, &
logic_íd
, 
NULL
);

2222 
logic_íd
 +
chunk_logiˇl
;

2225 
	`gë_øid56_logic_off£t
(
physiˇl
, 
°rùe_ödex
, 
m≠
, &
off£t
, 
NULL
);

2226 
ö¸emít
 = 
	`båfs_°rùe_ƒ_to_off£t
(
	`ƒ_d©a_°rùes
(
m≠
));

2232 
physiˇl
 < 
physiˇl_íd
) {

2233 
ªt
 = 
	`gë_øid56_logic_off£t
(
physiˇl
, 
°rùe_ödex
, 
m≠
,

2234 &
logiˇl
, &
°rùe_logiˇl
);

2235 
logiˇl
 +
chunk_logiˇl
;

2236 i‡(
ªt
) {

2238 
°rùe_logiˇl
 +
chunk_logiˇl
;

2239 
ªt
 = 
	`s¸ub_øid56_∑rôy_°rùe
(
s˘x
, 
s¸ub_dev
, 
bg
,

2240 
m≠
, 
°rùe_logiˇl
);

2241 i‡(
ªt
)

2242 
out
;

2243 
√xt
;

2254 
ªt
 = 
	`s¸ub_sim∂e_múr‹
(
s˘x
, 
bg
, 
m≠
, 
logiˇl
, 
BTRFS_STRIPE_LEN
,

2255 
s¸ub_dev
, 
physiˇl
, 1);

2256 i‡(
ªt
 < 0)

2257 
out
;

2258 
√xt
:

2259 
logiˇl
 +
ö¸emít
;

2260 
physiˇl
 +
BTRFS_STRIPE_LEN
;

2261 
	`•ö_lock
(&
s˘x
->
°©_lock
);

2262 i‡(
°›_lo›
)

2263 
s˘x
->
°©
.
œ°_physiˇl
 =

2264 
m≠
->
°rùes
[
°rùe_ödex
].
physiˇl
 + 
dev_°rùe_Àn
;

2266 
s˘x
->
°©
.
œ°_physiˇl
 = 
physiˇl
;

2267 
	`•ö_u∆ock
(&
s˘x
->
°©_lock
);

2268 i‡(
°›_lo›
)

2271 
out
:

2272 
ªt2
 = 
	`Êush_s¸ub_°rùes
(
s˘x
);

2273 i‡(!
ªt
)

2274 
ªt
 = 
ªt2
;

2275 
	`båfs_ªÀa£_∑th
(&
s˘x
->
exã¡_∑th
);

2276 
	`båfs_ªÀa£_∑th
(&
s˘x
->
csum_∑th
);

2278 i‡(
s˘x
->
øid56_d©a_°rùes
) {

2279 
i
 = 0; i < 
	`ƒ_d©a_°rùes
(
m≠
); i++)

2280 
	`ªÀa£_s¸ub_°rùe
(&
s˘x
->
øid56_d©a_°rùes
[
i
]);

2281 
	`k‰ì
(
s˘x
->
øid56_d©a_°rùes
);

2282 
s˘x
->
øid56_d©a_°rùes
 = 
NULL
;

2285 i‡(
s˘x
->
is_dev_ª∂a˚
 && 
ªt
 >= 0) {

2286 
ªt2
;

2288 
ªt2
 = 
	`sync_wrôe_poöãr_f‹_z⁄ed
(
s˘x
,

2289 
chunk_logiˇl
 + 
off£t
,

2290 
m≠
->
°rùes
[
°rùe_ödex
].
physiˇl
,

2291 
physiˇl_íd
);

2292 i‡(
ªt2
)

2293 
ªt
 = 
ªt2
;

2296  
ªt
 < 0 ?Ñet : 0;

2297 
	}
}

2299 
noölöe_f‹_°ack
 
	$s¸ub_chunk
(
s¸ub_˘x
 *
s˘x
,

2300 
båfs_block_group
 *
bg
,

2301 
båfs_devi˚
 *
s¸ub_dev
,

2302 
u64
 
dev_off£t
,

2303 
u64
 
dev_exã¡_Àn
)

2305 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->fs_info;

2306 
exã¡_m≠_åì
 *
m≠_åì
 = &
fs_öfo
->
m≠pög_åì
;

2307 
m≠_lookup
 *
m≠
;

2308 
exã¡_m≠
 *
em
;

2309 
i
;

2310 
ªt
 = 0;

2312 
	`ªad_lock
(&
m≠_åì
->
lock
);

2313 
em
 = 
	`lookup_exã¡_m≠pög
(
m≠_åì
, 
bg
->
°¨t
, bg->
Àngth
);

2314 
	`ªad_u∆ock
(&
m≠_åì
->
lock
);

2316 i‡(!
em
) {

2321 
	`•ö_lock
(&
bg
->
lock
);

2322 i‡(!
	`ã°_bô
(
BLOCK_GROUP_FLAG_REMOVED
, &
bg
->
ru¡ime_Êags
))

2323 
ªt
 = -
EINVAL
;

2324 
	`•ö_u∆ock
(&
bg
->
lock
);

2326  
ªt
;

2328 i‡(
em
->
°¨t
 !
bg
->start)

2329 
out
;

2330 i‡(
em
->
Àn
 < 
dev_exã¡_Àn
)

2331 
out
;

2333 
m≠
 = 
em
->
m≠_lookup
;

2334 
i
 = 0; i < 
m≠
->
num_°rùes
; ++i) {

2335 i‡(
m≠
->
°rùes
[
i
].
dev
->
bdev
 =
s¸ub_dev
->bdev &&

2336 
m≠
->
°rùes
[
i
].
physiˇl
 =
dev_off£t
) {

2337 
ªt
 = 
	`s¸ub_°rùe
(
s˘x
, 
bg
, 
em
, 
s¸ub_dev
, 
i
);

2338 i‡(
ªt
)

2339 
out
;

2342 
out
:

2343 
	`‰ì_exã¡_m≠
(
em
);

2345  
ªt
;

2346 
	}
}

2348 
	$föish_exã¡_wrôes_f‹_z⁄ed
(
båfs_roŸ
 *
roŸ
,

2349 
båfs_block_group
 *
ˇche
)

2351 
båfs_fs_öfo
 *
fs_öfo
 = 
ˇche
->fs_info;

2352 
båfs_å™s_h™dÀ
 *
å™s
;

2354 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

2357 
	`båfs_waô_block_group_ª£rv©i⁄s
(
ˇche
);

2358 
	`båfs_waô_nocow_wrôîs
(
ˇche
);

2359 
	`båfs_waô_‹dîed_roŸs
(
fs_öfo
, 
U64_MAX
, 
ˇche
->
°¨t
, cache->
Àngth
);

2361 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
roŸ
);

2362 i‡(
	`IS_ERR
(
å™s
))

2363  
	`PTR_ERR
(
å™s
);

2364  
	`båfs_commô_å™ß˘i⁄
(
å™s
);

2365 
	}
}

2367 
noölöe_f‹_°ack


2368 
	$s¸ub_íumî©e_chunks
(
s¸ub_˘x
 *
s˘x
,

2369 
båfs_devi˚
 *
s¸ub_dev
, 
u64
 
°¨t
, u64 
íd
)

2371 
båfs_dev_exã¡
 *
dev_exã¡
 = 
NULL
;

2372 
båfs_∑th
 *
∑th
;

2373 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->fs_info;

2374 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
dev_roŸ
;

2375 
u64
 
chunk_off£t
;

2376 
ªt
 = 0;

2377 
ro_£t
;

2378 
¶Ÿ
;

2379 
exã¡_buf„r
 *
l
;

2380 
båfs_key
 
key
;

2381 
båfs_key
 
found_key
;

2382 
båfs_block_group
 *
ˇche
;

2383 
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
 = &
fs_öfo
->dev_replace;

2385 
∑th
 = 
	`båfs_Æloc_∑th
();

2386 i‡(!
∑th
)

2387  -
ENOMEM
;

2389 
∑th
->
ªada
 = 
READA_FORWARD
;

2390 
∑th
->
£¨ch_commô_roŸ
 = 1;

2391 
∑th
->
skù_lockög
 = 1;

2393 
key
.
obje˘id
 = 
s¸ub_dev
->
devid
;

2394 
key
.
off£t
 = 0ull;

2395 
key
.
ty≥
 = 
BTRFS_DEV_EXTENT_KEY
;

2398 
u64
 
dev_exã¡_Àn
;

2400 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

2401 i‡(
ªt
 < 0)

2403 i‡(
ªt
 > 0) {

2404 i‡(
∑th
->
¶Ÿs
[0] >=

2405 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0])) {

2406 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

2407 i‡(
ªt
 < 0)

2409 i‡(
ªt
 > 0) {

2410 
ªt
 = 0;

2414 
ªt
 = 0;

2418 
l
 = 
∑th
->
nodes
[0];

2419 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

2421 
	`båfs_ôem_key_to_˝u
(
l
, &
found_key
, 
¶Ÿ
);

2423 i‡(
found_key
.
obje˘id
 !
s¸ub_dev
->
devid
)

2426 i‡(
found_key
.
ty≥
 !
BTRFS_DEV_EXTENT_KEY
)

2429 i‡(
found_key
.
off£t
 >
íd
)

2432 i‡(
found_key
.
off£t
 < 
key
.offset)

2435 
dev_exã¡
 = 
	`båfs_ôem_±r
(
l
, 
¶Ÿ
, 
båfs_dev_exã¡
);

2436 
dev_exã¡_Àn
 = 
	`båfs_dev_exã¡_Àngth
(
l
, 
dev_exã¡
);

2438 i‡(
found_key
.
off£t
 + 
dev_exã¡_Àn
 <
°¨t
)

2439 
skù
;

2441 
chunk_off£t
 = 
	`båfs_dev_exã¡_chunk_off£t
(
l
, 
dev_exã¡
);

2447 
ˇche
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
chunk_off£t
);

2451 i‡(!
ˇche
)

2452 
skù
;

2454 
	`ASSERT
(
ˇche
->
°¨t
 <
chunk_off£t
);

2474 i‡(
ˇche
->
°¨t
 < 
chunk_off£t
) {

2475 
	`båfs_put_block_group
(
ˇche
);

2476 
skù
;

2479 i‡(
s˘x
->
is_dev_ª∂a˚
 && 
	`båfs_is_z⁄ed
(
fs_öfo
)) {

2480 i‡(!
	`ã°_bô
(
BLOCK_GROUP_FLAG_TO_COPY
, &
ˇche
->
ru¡ime_Êags
)) {

2481 
	`båfs_put_block_group
(
ˇche
);

2482 
skù
;

2494 
	`•ö_lock
(&
ˇche
->
lock
);

2495 i‡(
	`ã°_bô
(
BLOCK_GROUP_FLAG_REMOVED
, &
ˇche
->
ru¡ime_Êags
)) {

2496 
	`•ö_u∆ock
(&
ˇche
->
lock
);

2497 
	`båfs_put_block_group
(
ˇche
);

2498 
skù
;

2500 
	`båfs_‰ìze_block_group
(
ˇche
);

2501 
	`•ö_u∆ock
(&
ˇche
->
lock
);

2511 
	`s¸ub_∑u£_⁄
(
fs_öfo
);

2543 
ªt
 = 
	`båfs_öc_block_group_ro
(
ˇche
, 
s˘x
->
is_dev_ª∂a˚
);

2544 i‡(!
ªt
 && 
s˘x
->
is_dev_ª∂a˚
) {

2545 
ªt
 = 
	`föish_exã¡_wrôes_f‹_z⁄ed
(
roŸ
, 
ˇche
);

2546 i‡(
ªt
) {

2547 
	`båfs_dec_block_group_ro
(
ˇche
);

2548 
	`s¸ub_∑u£_off
(
fs_öfo
);

2549 
	`båfs_put_block_group
(
ˇche
);

2554 i‡(
ªt
 == 0) {

2555 
ro_£t
 = 1;

2556 } i‡(
ªt
 =-
ENOSPC
 && !
s˘x
->
is_dev_ª∂a˚
 &&

2557 !(
ˇche
->
Êags
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
)) {

2571 
ro_£t
 = 0;

2572 } i‡(
ªt
 =-
ETXTBSY
) {

2573 
	`båfs_w¨n
(
fs_öfo
,

2575 
ˇche
->
°¨t
);

2576 
	`s¸ub_∑u£_off
(
fs_öfo
);

2577 
ªt
 = 0;

2578 
skù_un‰ìze
;

2580 
	`båfs_w¨n
(
fs_öfo
,

2581 "Áûed sëtög block grou∞ro: %d", 
ªt
);

2582 
	`båfs_un‰ìze_block_group
(
ˇche
);

2583 
	`båfs_put_block_group
(
ˇche
);

2584 
	`s¸ub_∑u£_off
(
fs_öfo
);

2593 i‡(
s˘x
->
is_dev_ª∂a˚
) {

2594 
	`båfs_waô_nocow_wrôîs
(
ˇche
);

2595 
	`båfs_waô_‹dîed_roŸs
(
fs_öfo
, 
U64_MAX
, 
ˇche
->
°¨t
,

2596 
ˇche
->
Àngth
);

2599 
	`s¸ub_∑u£_off
(
fs_öfo
);

2600 
	`down_wrôe
(&
dev_ª∂a˚
->
rw£m
);

2601 
dev_ª∂a˚
->
curs‹_right
 = 
found_key
.
off£t
 + 
dev_exã¡_Àn
;

2602 
dev_ª∂a˚
->
curs‹_À·
 = 
found_key
.
off£t
;

2603 
dev_ª∂a˚
->
ôem_√eds_wrôeback
 = 1;

2604 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

2606 
ªt
 = 
	`s¸ub_chunk
(
s˘x
, 
ˇche
, 
s¸ub_dev
, 
found_key
.
off£t
,

2607 
dev_exã¡_Àn
);

2608 i‡(
s˘x
->
is_dev_ª∂a˚
 &&

2609 !
	`båfs_föish_block_group_to_c›y
(
dev_ª∂a˚
->
§cdev
,

2610 
ˇche
, 
found_key
.
off£t
))

2611 
ro_£t
 = 0;

2613 
	`down_wrôe
(&
dev_ª∂a˚
->
rw£m
);

2614 
dev_ª∂a˚
->
curs‹_À·
 = dev_ª∂a˚->
curs‹_right
;

2615 
dev_ª∂a˚
->
ôem_√eds_wrôeback
 = 1;

2616 
	`up_wrôe
(&
dev_ª∂a˚
->
rw£m
);

2618 i‡(
ro_£t
)

2619 
	`båfs_dec_block_group_ro
(
ˇche
);

2628 
	`•ö_lock
(&
ˇche
->
lock
);

2629 i‡(!
	`ã°_bô
(
BLOCK_GROUP_FLAG_REMOVED
, &
ˇche
->
ru¡ime_Êags
) &&

2630 !
ˇche
->
ro
 && cache->
ª£rved
 =0 && cache->
u£d
 == 0) {

2631 
	`•ö_u∆ock
(&
ˇche
->
lock
);

2632 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
DISCARD_ASYNC
))

2633 
	`båfs_disˇrd_queue_w‹k
(&
fs_öfo
->
disˇrd_˘l
,

2634 
ˇche
);

2636 
	`båfs_m¨k_bg_unu£d
(
ˇche
);

2638 
	`•ö_u∆ock
(&
ˇche
->
lock
);

2640 
skù_un‰ìze
:

2641 
	`båfs_un‰ìze_block_group
(
ˇche
);

2642 
	`båfs_put_block_group
(
ˇche
);

2643 i‡(
ªt
)

2645 i‡(
s˘x
->
is_dev_ª∂a˚
 &&

2646 
	`©omic64_ªad
(&
dev_ª∂a˚
->
num_wrôe_îr‹s
) > 0) {

2647 
ªt
 = -
EIO
;

2650 i‡(
s˘x
->
°©
.
mÆloc_îr‹s
 > 0) {

2651 
ªt
 = -
ENOMEM
;

2654 
skù
:

2655 
key
.
off£t
 = 
found_key
.off£à+ 
dev_exã¡_Àn
;

2656 
	`båfs_ªÀa£_∑th
(
∑th
);

2659 
	`båfs_‰ì_∑th
(
∑th
);

2661  
ªt
;

2662 
	}
}

2664 
	$s¸ub_⁄e_su≥r
(
s¸ub_˘x
 *
s˘x
, 
båfs_devi˚
 *
dev
,

2665 
∑ge
 *∑ge, 
u64
 
physiˇl
, u64 
gíî©i⁄
)

2667 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->fs_info;

2668 
bio_vec
 
bvec
;

2669 
bio
 bio;

2670 
båfs_su≥r_block
 *
sb
 = 
	`∑ge_addªss
(
∑ge
);

2671 
ªt
;

2673 
	`bio_öô
(&
bio
, 
dev
->
bdev
, &
bvec
, 1, 
REQ_OP_READ
);

2674 
bio
.
bi_ôî
.
bi_£˘‹
 = 
physiˇl
 >> 
SECTOR_SHIFT
;

2675 
	`__bio_add_∑ge
(&
bio
, 
∑ge
, 
BTRFS_SUPER_INFO_SIZE
, 0);

2676 
ªt
 = 
	`submô_bio_waô
(&
bio
);

2677 
	`bio_unöô
(&
bio
);

2679 i‡(
ªt
 < 0)

2680  
ªt
;

2681 
ªt
 = 
	`båfs_check_su≥r_csum
(
fs_öfo
, 
sb
);

2682 i‡(
ªt
 != 0) {

2683 
	`båfs_îr_æ
(
fs_öfo
,

2685 
physiˇl
, 
dev
->
devid
);

2686  -
EIO
;

2688 i‡(
	`båfs_su≥r_gíî©i⁄
(
sb
Ë!
gíî©i⁄
) {

2689 
	`båfs_îr_æ
(
fs_öfo
,

2691 
physiˇl
, 
dev
->
devid
,

2692 
	`båfs_su≥r_gíî©i⁄
(
sb
), 
gíî©i⁄
);

2693  -
EUCLEAN
;

2696  
	`båfs_vÆid©e_su≥r
(
fs_öfo
, 
sb
, -1);

2697 
	}
}

2699 
noölöe_f‹_°ack
 
	$s¸ub_su≥rs
(
s¸ub_˘x
 *
s˘x
,

2700 
båfs_devi˚
 *
s¸ub_dev
)

2702 
i
;

2703 
u64
 
byãƒ
;

2704 
u64
 
gí
;

2705 
ªt
 = 0;

2706 
∑ge
 *page;

2707 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->fs_info;

2709 i‡(
	`BTRFS_FS_ERROR
(
fs_öfo
))

2710  -
EROFS
;

2712 
∑ge
 = 
	`Æloc_∑ge
(
GFP_KERNEL
);

2713 i‡(!
∑ge
) {

2714 
	`•ö_lock
(&
s˘x
->
°©_lock
);

2715 
s˘x
->
°©
.
mÆloc_îr‹s
++;

2716 
	`•ö_u∆ock
(&
s˘x
->
°©_lock
);

2717  -
ENOMEM
;

2721 i‡(
s¸ub_dev
->
fs_devi˚s
 !
fs_öfo
->fs_devices)

2722 
gí
 = 
s¸ub_dev
->
gíî©i⁄
;

2724 
gí
 = 
fs_öfo
->
œ°_å™s_commôãd
;

2726 
i
 = 0; i < 
BTRFS_SUPER_MIRROR_MAX
; i++) {

2727 
byãƒ
 = 
	`båfs_sb_off£t
(
i
);

2728 i‡(
byãƒ
 + 
BTRFS_SUPER_INFO_SIZE
 >

2729 
s¸ub_dev
->
commô_tŸÆ_byãs
)

2731 i‡(!
	`båfs_check_su≥r_loˇti⁄
(
s¸ub_dev
, 
byãƒ
))

2734 
ªt
 = 
	`s¸ub_⁄e_su≥r
(
s˘x
, 
s¸ub_dev
, 
∑ge
, 
byãƒ
, 
gí
);

2735 i‡(
ªt
) {

2736 
	`•ö_lock
(&
s˘x
->
°©_lock
);

2737 
s˘x
->
°©
.
su≥r_îr‹s
++;

2738 
	`•ö_u∆ock
(&
s˘x
->
°©_lock
);

2741 
	`__‰ì_∑ge
(
∑ge
);

2743 
	}
}

2745 
	$s¸ub_w‹kîs_put
(
båfs_fs_öfo
 *
fs_öfo
)

2747 i‡(
	`ªfcou¡_dec_™d_muãx_lock
(&
fs_öfo
->
s¸ub_w‹kîs_ªf˙t
,

2748 &
fs_öfo
->
s¸ub_lock
)) {

2749 
w‹kqueue_°ru˘
 *
s¸ub_w‹kîs
 = 
fs_öfo
->scrub_workers;

2751 
fs_öfo
->
s¸ub_w‹kîs
 = 
NULL
;

2752 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

2754 i‡(
s¸ub_w‹kîs
)

2755 
	`de°roy_w‹kqueue
(
s¸ub_w‹kîs
);

2757 
	}
}

2762 
noölöe_f‹_°ack
 
	$s¸ub_w‹kîs_gë
(
båfs_fs_öfo
 *
fs_öfo
)

2764 
w‹kqueue_°ru˘
 *
s¸ub_w‹kîs
 = 
NULL
;

2765 
Êags
 = 
WQ_FREEZABLE
 | 
WQ_UNBOUND
;

2766 
max_a˘ive
 = 
fs_öfo
->
thªad_poﬁ_size
;

2767 
ªt
 = -
ENOMEM
;

2769 i‡(
	`ªfcou¡_öc_nŸ_zîo
(&
fs_öfo
->
s¸ub_w‹kîs_ªf˙t
))

2772 
s¸ub_w‹kîs
 = 
	`Æloc_w‹kqueue
("båfs-s¸ub", 
Êags
, 
max_a˘ive
);

2773 i‡(!
s¸ub_w‹kîs
)

2774  -
ENOMEM
;

2776 
	`muãx_lock
(&
fs_öfo
->
s¸ub_lock
);

2777 i‡(
	`ªfcou¡_ªad
(&
fs_öfo
->
s¸ub_w‹kîs_ªf˙t
) == 0) {

2778 
	`ASSERT
(
fs_öfo
->
s¸ub_w‹kîs
 =
NULL
);

2779 
fs_öfo
->
s¸ub_w‹kîs
 = scrub_workers;

2780 
	`ªfcou¡_£t
(&
fs_öfo
->
s¸ub_w‹kîs_ªf˙t
, 1);

2781 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

2785 
	`ªfcou¡_öc
(&
fs_öfo
->
s¸ub_w‹kîs_ªf˙t
);

2786 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

2788 
ªt
 = 0;

2790 
	`de°roy_w‹kqueue
(
s¸ub_w‹kîs
);

2791  
ªt
;

2792 
	}
}

2794 
	$båfs_s¸ub_dev
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
devid
, u64 
°¨t
,

2795 
u64
 
íd
, 
båfs_s¸ub_¥ogªss
 *
¥ogªss
,

2796 
ªad⁄ly
, 
is_dev_ª∂a˚
)

2798 
båfs_dev_lookup_¨gs
 
¨gs
 = { .
devid
 = devid };

2799 
s¸ub_˘x
 *
s˘x
;

2800 
ªt
;

2801 
båfs_devi˚
 *
dev
;

2802 
nofs_Êag
;

2803 
boﬁ
 
√ed_commô
 = 
Ál£
;

2805 i‡(
	`båfs_fs_˛osög
(
fs_öfo
))

2806  -
EAGAIN
;

2809 
	`ASSERT
(
fs_öfo
->
nodesize
 <
BTRFS_STRIPE_LEN
);

2816 
	`ASSERT
(
fs_öfo
->
nodesize
 <=

2817 
SCRUB_MAX_SECTORS_PER_BLOCK
 << 
fs_öfo
->
£˘‹size_bôs
);

2820 
s˘x
 = 
	`s¸ub_£tup_˘x
(
fs_öfo
, 
is_dev_ª∂a˚
);

2821 i‡(
	`IS_ERR
(
s˘x
))

2822  
	`PTR_ERR
(
s˘x
);

2824 
ªt
 = 
	`s¸ub_w‹kîs_gë
(
fs_öfo
);

2825 i‡(
ªt
)

2826 
out_‰ì_˘x
;

2828 
	`muãx_lock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

2829 
dev
 = 
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, &
¨gs
);

2830 i‡(!
dev
 || (
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
, &dev->
dev_°©e
) &&

2831 !
is_dev_ª∂a˚
)) {

2832 
	`muãx_u∆ock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

2833 
ªt
 = -
ENODEV
;

2834 
out
;

2837 i‡(!
is_dev_ª∂a˚
 && !
ªad⁄ly
 &&

2838 !
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
dev
->
dev_°©e
)) {

2839 
	`muãx_u∆ock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

2840 
	`båfs_îr_ö_rcu
(
fs_öfo
,

2842 
devid
, 
	`båfs_dev_«me
(
dev
));

2843 
ªt
 = -
EROFS
;

2844 
out
;

2847 
	`muãx_lock
(&
fs_öfo
->
s¸ub_lock
);

2848 i‡(!
	`ã°_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
dev
->
dev_°©e
) ||

2849 
	`ã°_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
dev
->
dev_°©e
)) {

2850 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

2851 
	`muãx_u∆ock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

2852 
ªt
 = -
EIO
;

2853 
out
;

2856 
	`down_ªad
(&
fs_öfo
->
dev_ª∂a˚
.
rw£m
);

2857 i‡(
dev
->
s¸ub_˘x
 ||

2858 (!
is_dev_ª∂a˚
 &&

2859 
	`båfs_dev_ª∂a˚_is_⁄goög
(&
fs_öfo
->
dev_ª∂a˚
))) {

2860 
	`up_ªad
(&
fs_öfo
->
dev_ª∂a˚
.
rw£m
);

2861 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

2862 
	`muãx_u∆ock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

2863 
ªt
 = -
EINPROGRESS
;

2864 
out
;

2866 
	`up_ªad
(&
fs_öfo
->
dev_ª∂a˚
.
rw£m
);

2868 
s˘x
->
ªad⁄ly
 =Ñeadonly;

2869 
dev
->
s¸ub_˘x
 = 
s˘x
;

2870 
	`muãx_u∆ock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

2876 
	`__s¸ub_blocked_if_√eded
(
fs_öfo
);

2877 
	`©omic_öc
(&
fs_öfo
->
s¸ubs_ru¬ög
);

2878 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

2889 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

2890 i‡(!
is_dev_ª∂a˚
) {

2891 
u64
 
ﬁd_su≥r_îr‹s
;

2893 
	`•ö_lock
(&
s˘x
->
°©_lock
);

2894 
ﬁd_su≥r_îr‹s
 = 
s˘x
->
°©
.
su≥r_îr‹s
;

2895 
	`•ö_u∆ock
(&
s˘x
->
°©_lock
);

2897 
	`båfs_öfo
(
fs_öfo
, "s¸ub: sèπed o¿devid %Œu", 
devid
);

2902 
	`muãx_lock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

2903 
ªt
 = 
	`s¸ub_su≥rs
(
s˘x
, 
dev
);

2904 
	`muãx_u∆ock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

2906 
	`•ö_lock
(&
s˘x
->
°©_lock
);

2912 i‡(
s˘x
->
°©
.
su≥r_îr‹s
 > 
ﬁd_su≥r_îr‹s
 && !s˘x->
ªad⁄ly
)

2913 
√ed_commô
 = 
åue
;

2914 
	`•ö_u∆ock
(&
s˘x
->
°©_lock
);

2917 i‡(!
ªt
)

2918 
ªt
 = 
	`s¸ub_íumî©e_chunks
(
s˘x
, 
dev
, 
°¨t
, 
íd
);

2919 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

2921 
	`©omic_dec
(&
fs_öfo
->
s¸ubs_ru¬ög
);

2922 
	`wake_up
(&
fs_öfo
->
s¸ub_∑u£_waô
);

2924 i‡(
¥ogªss
)

2925 
	`mem˝y
(
¥ogªss
, &
s˘x
->
°©
, (*progress));

2927 i‡(!
is_dev_ª∂a˚
)

2928 
	`båfs_öfo
(
fs_öfo
, "scrub: %s on devid %llu with status: %d",

2929 
ªt
 ? "nŸ föished" : "föished", 
devid
,Ñet);

2931 
	`muãx_lock
(&
fs_öfo
->
s¸ub_lock
);

2932 
dev
->
s¸ub_˘x
 = 
NULL
;

2933 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

2935 
	`s¸ub_w‹kîs_put
(
fs_öfo
);

2936 
	`s¸ub_put_˘x
(
s˘x
);

2942 i‡(
√ed_commô
) {

2943 
båfs_å™s_h™dÀ
 *
å™s
;

2945 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
fs_öfo
->
åì_roŸ
, 0);

2946 i‡(
	`IS_ERR
(
å™s
)) {

2947 
ªt
 = 
	`PTR_ERR
(
å™s
);

2948 
	`båfs_îr
(
fs_öfo
,

2949 "s¸ub: faûedÅÿ°¨àå™ß˘i⁄Åÿfix su≥∏blockÉº‹s: %d", 
ªt
);

2950  
ªt
;

2952 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

2953 i‡(
ªt
 < 0)

2954 
	`båfs_îr
(
fs_öfo
,

2955 "s¸ub: faûedÅÿcommôÅønß˘i⁄Åÿfix su≥∏blockÉº‹s: %d", 
ªt
);

2957  
ªt
;

2958 
out
:

2959 
	`s¸ub_w‹kîs_put
(
fs_öfo
);

2960 
out_‰ì_˘x
:

2961 
	`s¸ub_‰ì_˘x
(
s˘x
);

2963  
ªt
;

2964 
	}
}

2966 
	$båfs_s¸ub_∑u£
(
båfs_fs_öfo
 *
fs_öfo
)

2968 
	`muãx_lock
(&
fs_öfo
->
s¸ub_lock
);

2969 
	`©omic_öc
(&
fs_öfo
->
s¸ub_∑u£_ªq
);

2970 
	`©omic_ªad
(&
fs_öfo
->
s¸ubs_∑u£d
) !=

2971 
	`©omic_ªad
(&
fs_öfo
->
s¸ubs_ru¬ög
)) {

2972 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

2973 
	`waô_evít
(
fs_öfo
->
s¸ub_∑u£_waô
,

2974 
	`©omic_ªad
(&
fs_öfo
->
s¸ubs_∑u£d
) ==

2975 
	`©omic_ªad
(&
fs_öfo
->
s¸ubs_ru¬ög
));

2976 
	`muãx_lock
(&
fs_öfo
->
s¸ub_lock
);

2978 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

2979 
	}
}

2981 
	$båfs_s¸ub_c⁄töue
(
båfs_fs_öfo
 *
fs_öfo
)

2983 
	`©omic_dec
(&
fs_öfo
->
s¸ub_∑u£_ªq
);

2984 
	`wake_up
(&
fs_öfo
->
s¸ub_∑u£_waô
);

2985 
	}
}

2987 
	$båfs_s¸ub_ˇn˚l
(
båfs_fs_öfo
 *
fs_öfo
)

2989 
	`muãx_lock
(&
fs_öfo
->
s¸ub_lock
);

2990 i‡(!
	`©omic_ªad
(&
fs_öfo
->
s¸ubs_ru¬ög
)) {

2991 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

2992  -
ENOTCONN
;

2995 
	`©omic_öc
(&
fs_öfo
->
s¸ub_ˇn˚l_ªq
);

2996 
	`©omic_ªad
(&
fs_öfo
->
s¸ubs_ru¬ög
)) {

2997 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

2998 
	`waô_evít
(
fs_öfo
->
s¸ub_∑u£_waô
,

2999 
	`©omic_ªad
(&
fs_öfo
->
s¸ubs_ru¬ög
) == 0);

3000 
	`muãx_lock
(&
fs_öfo
->
s¸ub_lock
);

3002 
	`©omic_dec
(&
fs_öfo
->
s¸ub_ˇn˚l_ªq
);

3003 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

3006 
	}
}

3008 
	$båfs_s¸ub_ˇn˚l_dev
(
båfs_devi˚
 *
dev
)

3010 
båfs_fs_öfo
 *
fs_öfo
 = 
dev
->fs_info;

3011 
s¸ub_˘x
 *
s˘x
;

3013 
	`muãx_lock
(&
fs_öfo
->
s¸ub_lock
);

3014 
s˘x
 = 
dev
->
s¸ub_˘x
;

3015 i‡(!
s˘x
) {

3016 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

3017  -
ENOTCONN
;

3019 
	`©omic_öc
(&
s˘x
->
ˇn˚l_ªq
);

3020 
dev
->
s¸ub_˘x
) {

3021 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

3022 
	`waô_evít
(
fs_öfo
->
s¸ub_∑u£_waô
,

3023 
dev
->
s¸ub_˘x
 =
NULL
);

3024 
	`muãx_lock
(&
fs_öfo
->
s¸ub_lock
);

3026 
	`muãx_u∆ock
(&
fs_öfo
->
s¸ub_lock
);

3029 
	}
}

3031 
	$båfs_s¸ub_¥ogªss
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
devid
,

3032 
båfs_s¸ub_¥ogªss
 *
¥ogªss
)

3034 
båfs_dev_lookup_¨gs
 
¨gs
 = { .
devid
 = devid };

3035 
båfs_devi˚
 *
dev
;

3036 
s¸ub_˘x
 *
s˘x
 = 
NULL
;

3038 
	`muãx_lock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

3039 
dev
 = 
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, &
¨gs
);

3040 i‡(
dev
)

3041 
s˘x
 = 
dev
->
s¸ub_˘x
;

3042 i‡(
s˘x
)

3043 
	`mem˝y
(
¥ogªss
, &
s˘x
->
°©
, (*progress));

3044 
	`muãx_u∆ock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

3046  
dev
 ? (
s˘x
 ? 0 : -
ENOTCONN
Ë: -
ENODEV
;

3047 
	}
}

	@scrub.h

3 #i‚de‡
BTRFS_SCRUB_H


4 
	#BTRFS_SCRUB_H


	)

6 
båfs_s¸ub_dev
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
devid
, u64 
°¨t
,

7 
u64
 
íd
, 
båfs_s¸ub_¥ogªss
 *
¥ogªss
,

8 
ªad⁄ly
, 
is_dev_ª∂a˚
);

9 
båfs_s¸ub_∑u£
(
båfs_fs_öfo
 *
fs_öfo
);

10 
båfs_s¸ub_c⁄töue
(
båfs_fs_öfo
 *
fs_öfo
);

11 
båfs_s¸ub_ˇn˚l
(
båfs_fs_öfo
 *
öfo
);

12 
båfs_s¸ub_ˇn˚l_dev
(
båfs_devi˚
 *
dev
);

13 
båfs_s¸ub_¥ogªss
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
devid
,

14 
båfs_s¸ub_¥ogªss
 *
¥ogªss
);

	@send.c

6 
	~<löux/b£¨ch.h
>

7 
	~<löux/fs.h
>

8 
	~<löux/fûe.h
>

9 
	~<löux/s‹t.h
>

10 
	~<löux/mou¡.h
>

11 
	~<löux/x©å.h
>

12 
	~<löux/posix_a˛_x©å.h
>

13 
	~<löux/ødix-åì.h
>

14 
	~<löux/vmÆloc.h
>

15 
	~<löux/°rög.h
>

16 
	~<löux/com∑t.h
>

17 
	~<löux/¸c32c.h
>

18 
	~<löux/fsvîôy.h
>

20 
	~"£nd.h
"

21 
	~"˘ªe.h
"

22 
	~"backªf.h
"

23 
	~"lockög.h
"

24 
	~"disk-io.h
"

25 
	~"båfs_öode.h
"

26 
	~"å™ß˘i⁄.h
"

27 
	~"com¥essi⁄.h
"

28 
	~"x©å.h
"

29 
	~"¥öt-åì.h
"

30 
	~"ac˚ss‹s.h
"

31 
	~"dú-ôem.h
"

32 
	~"fûe-ôem.h
"

33 
	~"io˘l.h
"

34 
	~"vîôy.h
"

35 
	~"Ãu_ˇche.h
"

43 
	#SEND_MAX_EXTENT_REFS
 1024

	)

52 
	sfs_∑th
 {

55 *
	m°¨t
;

56 *
	míd
;

58 *
	mbuf
;

59 
	mbuf_Àn
:15;

60 
	mªvî£d
:1;

61 
	mölöe_buf
[];

68 
	m∑d
[256];

71 
	#FS_PATH_INLINE_SIZE
 \

72 ((
fs_∑th
Ë- 
	`off£tof
(fs_∑th, 
ölöe_buf
))

	)

76 
	s˛⁄e_roŸ
 {

77 
båfs_roŸ
 *
	mroŸ
;

78 
u64
 
	möo
;

79 
u64
 
	moff£t
;

80 
u64
 
	mnum_byãs
;

81 
boﬁ
 
	mfound_ªf
;

84 
	#SEND_MAX_NAME_CACHE_SIZE
 256

	)

95 
	#SEND_MAX_BACKREF_CACHE_ROOTS
 17

	)

102 
	#SEND_MAX_BACKREF_CACHE_SIZE
 128

	)

110 
	sbackªf_ˇche_íåy
 {

111 
båfs_Ãu_ˇche_íåy
 
	míåy
;

112 
u64
 
	mroŸ_ids
[
SEND_MAX_BACKREF_CACHE_ROOTS
];

114 
	mnum_roŸs
;

118 
°©ic_as£π
(
off£tof
(
backªf_ˇche_íåy
, 
íåy
) == 0);

126 
	#SEND_MAX_DIR_CREATED_CACHE_SIZE
 64

	)

134 
	#SEND_MAX_DIR_UTIMES_CACHE_SIZE
 64

	)

136 
	s£nd_˘x
 {

137 
fûe
 *
	m£nd_fûp
;

138 
loff_t
 
	m£nd_off
;

139 *
	m£nd_buf
;

140 
u32
 
	m£nd_size
;

141 
u32
 
	m£nd_max_size
;

146 
boﬁ
 
	mput_d©a
;

147 
∑ge
 **
	m£nd_buf_∑ges
;

148 
u64
 
	mÊags
;

150 
u32
 
	m¥Ÿo
;

152 
båfs_roŸ
 *
	m£nd_roŸ
;

153 
båfs_roŸ
 *
	m∑ª¡_roŸ
;

154 
˛⁄e_roŸ
 *
	m˛⁄e_roŸs
;

155 
	m˛⁄e_roŸs_˙t
;

158 
båfs_∑th
 *
	mÀ·_∑th
;

159 
båfs_∑th
 *
	mright_∑th
;

160 
båfs_key
 *
	mcmp_key
;

169 
u64
 
	mœ°_ªloc_å™s
;

175 
u64
 
	mcur_öo
;

176 
u64
 
	mcur_öode_gí
;

177 
u64
 
	mcur_öode_size
;

178 
u64
 
	mcur_öode_mode
;

179 
u64
 
	mcur_öode_rdev
;

180 
u64
 
	mcur_öode_œ°_exã¡
;

181 
u64
 
	mcur_öode_√xt_wrôe_off£t
;

182 
boﬁ
 
	mcur_öode_√w
;

183 
boﬁ
 
	mcur_öode_√w_gí
;

184 
boﬁ
 
	mcur_öode_dñëed
;

185 
boﬁ
 
	mign‹e_cur_öode
;

186 
boﬁ
 
	mcur_öode_√eds_vîôy
;

187 *
	mvîôy_des¸ùt‹
;

189 
u64
 
	m£nd_¥ogªss
;

191 
li°_hód
 
	m√w_ªfs
;

192 
li°_hód
 
	mdñëed_ªfs
;

194 
båfs_Ãu_ˇche
 
	m«me_ˇche
;

200 
öode
 *
	mcur_öode
;

201 
fûe_ø_°©e
 
	mø
;

202 
u64
 
	m∑ge_ˇche_˛ór_°¨t
;

203 
boﬁ
 
	m˛ón_∑ge_ˇche
;

250 
rb_roŸ
 
	m≥ndög_dú_moves
;

257 
rb_roŸ
 
	mwaôög_dú_moves
;

298 
rb_roŸ
 
	m‹ph™_dús
;

300 
rb_roŸ
 
	mrbåì_√w_ªfs
;

301 
rb_roŸ
 
	mrbåì_dñëed_ªfs
;

303 
båfs_Ãu_ˇche
 
	mbackªf_ˇche
;

304 
u64
 
	mbackªf_ˇche_œ°_ªloc_å™s
;

306 
båfs_Ãu_ˇche
 
	mdú_¸óãd_ˇche
;

307 
båfs_Ãu_ˇche
 
	mdú_utimes_ˇche
;

310 
	s≥ndög_dú_move
 {

311 
rb_node
 
	mnode
;

312 
li°_hód
 
	mli°
;

313 
u64
 
	m∑ª¡_öo
;

314 
u64
 
	möo
;

315 
u64
 
	mgí
;

316 
li°_hód
 
	mupd©e_ªfs
;

319 
	swaôög_dú_move
 {

320 
rb_node
 
	mnode
;

321 
u64
 
	möo
;

327 
u64
 
	mrmdú_öo
;

328 
u64
 
	mrmdú_gí
;

329 
boﬁ
 
	m‹ph™ized
;

332 
	s‹ph™_dú_öfo
 {

333 
rb_node
 
	mnode
;

334 
u64
 
	möo
;

335 
u64
 
	mgí
;

336 
u64
 
	mœ°_dú_ödex_off£t
;

337 
u64
 
	mdú_high_£q_öo
;

340 
	s«me_ˇche_íåy
 {

345 
båfs_Ãu_ˇche_íåy
 
	míåy
;

346 
u64
 
	m∑ª¡_öo
;

347 
u64
 
	m∑ª¡_gí
;

348 
	mªt
;

349 
	m√ed_œãr_upd©e
;

350 
	m«me_Àn
;

351 
	m«me
[];

355 
°©ic_as£π
(
off£tof
(
«me_ˇche_íåy
, 
íåy
) == 0);

357 
	#ADVANCE
 1

	)

358 
	#ADVANCE_ONLY_NEXT
 -1

	)

360 
	ebåfs_com∑ª_åì_ªsu…
 {

361 
	mBTRFS_COMPARE_TREE_NEW
,

362 
	mBTRFS_COMPARE_TREE_DELETED
,

363 
	mBTRFS_COMPARE_TREE_CHANGED
,

364 
	mBTRFS_COMPARE_TREE_SAME
,

367 
__cﬁd


368 
	$öc⁄si°ít_¢≠shŸ_îr‹
(
£nd_˘x
 *
s˘x
,

369 
båfs_com∑ª_åì_ªsu…
 
ªsu…
,

370 c⁄° *
wh©
)

372 c⁄° *
ªsu…_°rög
;

374 
ªsu…
) {

375 
BTRFS_COMPARE_TREE_NEW
:

376 
ªsu…_°rög
 = "new";

378 
BTRFS_COMPARE_TREE_DELETED
:

379 
ªsu…_°rög
 = "deleted";

381 
BTRFS_COMPARE_TREE_CHANGED
:

382 
ªsu…_°rög
 = "updated";

384 
BTRFS_COMPARE_TREE_SAME
:

385 
	`ASSERT
(0);

386 
ªsu…_°rög
 = "unchanged";

389 
	`ASSERT
(0);

390 
ªsu…_°rög
 = "unexpected";

393 
	`båfs_îr
(
s˘x
->
£nd_roŸ
->
fs_öfo
,

395 
ªsu…_°rög
, 
wh©
, 
s˘x
->
cmp_key
->
obje˘id
,

396 
s˘x
->
£nd_roŸ
->
roŸ_key
.
obje˘id
,

397 (
s˘x
->
∑ª¡_roŸ
 ?

398 
s˘x
->
∑ª¡_roŸ
->
roŸ_key
.
obje˘id
 : 0));

399 
	}
}

401 
__maybe_unu£d


402 
boﬁ
 
	$¥Ÿo_cmd_ok
(c⁄° 
£nd_˘x
 *
s˘x
, 
cmd
)

404 
s˘x
->
¥Ÿo
) {

405 1:  
cmd
 <
BTRFS_SEND_C_MAX_V1
;

406 2:  
cmd
 <
BTRFS_SEND_C_MAX_V2
;

407 3:  
cmd
 <
BTRFS_SEND_C_MAX_V3
;

408 :  
Ál£
;

410 
	}
}

412 
is_waôög_f‹_move
(
£nd_˘x
 *
s˘x
, 
u64
 
öo
);

414 
waôög_dú_move
 *

415 
gë_waôög_dú_move
(
£nd_˘x
 *
s˘x
, 
u64
 
öo
);

417 
is_waôög_f‹_rm
(
£nd_˘x
 *
s˘x
, 
u64
 
dú_öo
, u64 
gí
);

419 
	$√ed_£nd_hﬁe
(
£nd_˘x
 *
s˘x
)

421  (
s˘x
->
∑ª¡_roŸ
 && !s˘x->
cur_öode_√w
 &&

422 !
s˘x
->
cur_öode_√w_gí
 && !s˘x->
cur_öode_dñëed
 &&

423 
	`S_ISREG
(
s˘x
->
cur_öode_mode
));

424 
	}
}

426 
	$fs_∑th_ª£t
(
fs_∑th
 *
p
)

428 i‡(
p
->
ªvî£d
) {

429 
p
->
°¨t
 =Ö->
buf
 +Ö->
buf_Àn
 - 1;

430 
p
->
íd
 =Ö->
°¨t
;

431 *
p
->
°¨t
 = 0;

433 
p
->
°¨t
 =Ö->
buf
;

434 
p
->
íd
 =Ö->
°¨t
;

435 *
p
->
°¨t
 = 0;

437 
	}
}

439 
fs_∑th
 *
	$fs_∑th_Æloc
()

441 
fs_∑th
 *
p
;

443 
p
 = 
	`kmÆloc
((*p), 
GFP_KERNEL
);

444 i‡(!
p
)

445  
NULL
;

446 
p
->
ªvî£d
 = 0;

447 
p
->
buf
 =Ö->
ölöe_buf
;

448 
p
->
buf_Àn
 = 
FS_PATH_INLINE_SIZE
;

449 
	`fs_∑th_ª£t
(
p
);

450  
p
;

451 
	}
}

453 
fs_∑th
 *
	$fs_∑th_Æloc_ªvî£d
()

455 
fs_∑th
 *
p
;

457 
p
 = 
	`fs_∑th_Æloc
();

458 i‡(!
p
)

459  
NULL
;

460 
p
->
ªvî£d
 = 1;

461 
	`fs_∑th_ª£t
(
p
);

462  
p
;

463 
	}
}

465 
	$fs_∑th_‰ì
(
fs_∑th
 *
p
)

467 i‡(!
p
)

469 i‡(
p
->
buf
 !p->
ölöe_buf
)

470 
	`k‰ì
(
p
->
buf
);

471 
	`k‰ì
(
p
);

472 
	}
}

474 
	$fs_∑th_Àn
(
fs_∑th
 *
p
)

476  
p
->
íd
 -Ö->
°¨t
;

477 
	}
}

479 
	$fs_∑th_ísuª_buf
(
fs_∑th
 *
p
, 
Àn
)

481 *
tmp_buf
;

482 
∑th_Àn
;

483 
ﬁd_buf_Àn
;

485 
Àn
++;

487 i‡(
p
->
buf_Àn
 >
Àn
)

490 i‡(
Àn
 > 
PATH_MAX
) {

491 
	`WARN_ON
(1);

492  -
ENOMEM
;

495 
∑th_Àn
 = 
p
->
íd
 -Ö->
°¨t
;

496 
ﬁd_buf_Àn
 = 
p
->
buf_Àn
;

502 
Àn
 = 
	`kmÆloc_size_roundup
(len);

506 i‡(
p
->
buf
 =p->
ölöe_buf
) {

507 
tmp_buf
 = 
	`kmÆloc
(
Àn
, 
GFP_KERNEL
);

508 i‡(
tmp_buf
)

509 
	`mem˝y
(
tmp_buf
, 
p
->
buf
, 
ﬁd_buf_Àn
);

511 
tmp_buf
 = 
	`kªÆloc
(
p
->
buf
, 
Àn
, 
GFP_KERNEL
);

513 i‡(!
tmp_buf
)

514  -
ENOMEM
;

515 
p
->
buf
 = 
tmp_buf
;

516 
p
->
buf_Àn
 = 
Àn
;

518 i‡(
p
->
ªvî£d
) {

519 
tmp_buf
 = 
p
->
buf
 + 
ﬁd_buf_Àn
 - 
∑th_Àn
 - 1;

520 
p
->
íd
 =Ö->
buf
 +Ö->
buf_Àn
 - 1;

521 
p
->
°¨t
 =Ö->
íd
 - 
∑th_Àn
;

522 
	`memmove
(
p
->
°¨t
, 
tmp_buf
, 
∑th_Àn
 + 1);

524 
p
->
°¨t
 =Ö->
buf
;

525 
p
->
íd
 =Ö->
°¨t
 + 
∑th_Àn
;

528 
	}
}

530 
	$fs_∑th_¥ï¨e_f‹_add
(
fs_∑th
 *
p
, 
«me_Àn
,

531 **
¥ï¨ed
)

533 
ªt
;

534 
√w_Àn
;

536 
√w_Àn
 = 
p
->
íd
 -Ö->
°¨t
 + 
«me_Àn
;

537 i‡(
p
->
°¨t
 !p->
íd
)

538 
√w_Àn
++;

539 
ªt
 = 
	`fs_∑th_ísuª_buf
(
p
, 
√w_Àn
);

540 i‡(
ªt
 < 0)

541 
out
;

543 i‡(
p
->
ªvî£d
) {

544 i‡(
p
->
°¨t
 !p->
íd
)

545 *--
p
->
°¨t
 = '/';

546 
p
->
°¨t
 -
«me_Àn
;

547 *
¥ï¨ed
 = 
p
->
°¨t
;

549 i‡(
p
->
°¨t
 !p->
íd
)

550 *
p
->
íd
++ = '/';

551 *
¥ï¨ed
 = 
p
->
íd
;

552 
p
->
íd
 +
«me_Àn
;

553 *
p
->
íd
 = 0;

556 
out
:

557  
ªt
;

558 
	}
}

560 
	$fs_∑th_add
(
fs_∑th
 *
p
, c⁄° *
«me
, 
«me_Àn
)

562 
ªt
;

563 *
¥ï¨ed
;

565 
ªt
 = 
	`fs_∑th_¥ï¨e_f‹_add
(
p
, 
«me_Àn
, &
¥ï¨ed
);

566 i‡(
ªt
 < 0)

567 
out
;

568 
	`mem˝y
(
¥ï¨ed
, 
«me
, 
«me_Àn
);

570 
out
:

571  
ªt
;

572 
	}
}

574 
	$fs_∑th_add_∑th
(
fs_∑th
 *
p
, fs_∑th *
p2
)

576 
ªt
;

577 *
¥ï¨ed
;

579 
ªt
 = 
	`fs_∑th_¥ï¨e_f‹_add
(
p
, 
p2
->
íd
 -Ö2->
°¨t
, &
¥ï¨ed
);

580 i‡(
ªt
 < 0)

581 
out
;

582 
	`mem˝y
(
¥ï¨ed
, 
p2
->
°¨t
,Ö2->
íd
 -Ö2->start);

584 
out
:

585  
ªt
;

586 
	}
}

588 
	$fs_∑th_add_‰om_exã¡_buf„r
(
fs_∑th
 *
p
,

589 
exã¡_buf„r
 *
eb
,

590 
off
, 
Àn
)

592 
ªt
;

593 *
¥ï¨ed
;

595 
ªt
 = 
	`fs_∑th_¥ï¨e_f‹_add
(
p
, 
Àn
, &
¥ï¨ed
);

596 i‡(
ªt
 < 0)

597 
out
;

599 
	`ªad_exã¡_buf„r
(
eb
, 
¥ï¨ed
, 
off
, 
Àn
);

601 
out
:

602  
ªt
;

603 
	}
}

605 
	$fs_∑th_c›y
(
fs_∑th
 *
p
, fs_∑th *
‰om
)

607 
p
->
ªvî£d
 = 
‰om
->reversed;

608 
	`fs_∑th_ª£t
(
p
);

610  
	`fs_∑th_add_∑th
(
p
, 
‰om
);

611 
	}
}

613 
	$fs_∑th_uƒevî£
(
fs_∑th
 *
p
)

615 *
tmp
;

616 
Àn
;

618 i‡(!
p
->
ªvî£d
)

621 
tmp
 = 
p
->
°¨t
;

622 
Àn
 = 
p
->
íd
 -Ö->
°¨t
;

623 
p
->
°¨t
 =Ö->
buf
;

624 
p
->
íd
 =Ö->
°¨t
 + 
Àn
;

625 
	`memmove
(
p
->
°¨t
, 
tmp
, 
Àn
 + 1);

626 
p
->
ªvî£d
 = 0;

627 
	}
}

629 
båfs_∑th
 *
	$Æloc_∑th_f‹_£nd
()

631 
båfs_∑th
 *
∑th
;

633 
∑th
 = 
	`båfs_Æloc_∑th
();

634 i‡(!
∑th
)

635  
NULL
;

636 
∑th
->
£¨ch_commô_roŸ
 = 1;

637 
∑th
->
skù_lockög
 = 1;

638 
∑th
->
√ed_commô_£m
 = 1;

639  
∑th
;

640 
	}
}

642 
	$wrôe_buf
(
fûe
 *
fûp
, c⁄° *
buf
, 
u32
 
Àn
, 
loff_t
 *
off
)

644 
ªt
;

645 
u32
 
pos
 = 0;

647 
pos
 < 
Àn
) {

648 
ªt
 = 
	`kî√l_wrôe
(
fûp
, 
buf
 + 
pos
, 
Àn
 -Öos, 
off
);

649 i‡(
ªt
 < 0)

650  
ªt
;

651 i‡(
ªt
 == 0)

652  -
EIO
;

653 
pos
 +
ªt
;

657 
	}
}

659 
	$év_put
(
£nd_˘x
 *
s˘x
, 
u16
 
©å
, c⁄° *
d©a
, 
Àn
)

661 
båfs_év_hódî
 *
hdr
;

662 
tŸÆ_Àn
 = (*
hdr
Ë+ 
Àn
;

663 
À·
 = 
s˘x
->
£nd_max_size
 - s˘x->
£nd_size
;

665 i‡(
	`WARN_ON_ONCE
(
s˘x
->
put_d©a
))

666  -
EINVAL
;

668 i‡(
	`u∆ikñy
(
À·
 < 
tŸÆ_Àn
))

669  -
EOVERFLOW
;

671 
hdr
 = (
båfs_év_hódî
 *Ë(
s˘x
->
£nd_buf
 + s˘x->
£nd_size
);

672 
	`put_u«lig√d_À16
(
©å
, &
hdr
->
év_ty≥
);

673 
	`put_u«lig√d_À16
(
Àn
, &
hdr
->
év_Àn
);

674 
	`mem˝y
(
hdr
 + 1, 
d©a
, 
Àn
);

675 
s˘x
->
£nd_size
 +
tŸÆ_Àn
;

678 
	}
}

680 
	#TLV_PUT_DEFINE_INT
(
bôs
) \

681 
év_put_u
##
	`bôs
(
£nd_˘x
 *
s˘x
, \

682 
u
##
bôs
 
©å
, u##bô†
vÆue
) \

684 
__À
##
bôs
 
__tmp
 = 
˝u_to_À
##
	`bôs
(
vÆue
); \

685  
	`év_put
(
s˘x
, 
©å
, &
__tmp
, (__tmp)); \

686 }

	)

688 
	$TLV_PUT_DEFINE_INT
(8)

689 
	$TLV_PUT_DEFINE_INT
(32)

690 
	$TLV_PUT_DEFINE_INT
(64)

692 
	$év_put_°rög
(
£nd_˘x
 *
s˘x
, 
u16
 
©å
,

693 c⁄° *
°r
, 
Àn
)

695 i‡(
Àn
 == -1)

696 
Àn
 = 
	`°æí
(
°r
);

697  
	`év_put
(
s˘x
, 
©å
, 
°r
, 
Àn
);

698 
	}
}

700 
	$év_put_uuid
(
£nd_˘x
 *
s˘x
, 
u16
 
©å
,

701 c⁄° 
u8
 *
uuid
)

703  
	`év_put
(
s˘x
, 
©å
, 
uuid
, 
BTRFS_UUID_SIZE
);

704 
	}
}

706 
	$év_put_båfs_time•ec
(
£nd_˘x
 *
s˘x
, 
u16
 
©å
,

707 
exã¡_buf„r
 *
eb
,

708 
båfs_time•ec
 *
ts
)

710 
båfs_time•ec
 
bts
;

711 
	`ªad_exã¡_buf„r
(
eb
, &
bts
, ()
ts
, (bts));

712  
	`év_put
(
s˘x
, 
©å
, &
bts
, (bts));

713 
	}
}

716 
	#TLV_PUT
(
s˘x
, 
©åty≥
, 
d©a
, 
©åÀn
) \

718 
ªt
 = 
	`év_put
(
s˘x
, 
©åty≥
, 
d©a
, 
©åÀn
); \

719 i‡(
ªt
 < 0) \

720 
év_put_Áûuª
; \

721 } 0)

	)

723 
	#TLV_PUT_INT
(
s˘x
, 
©åty≥
, 
bôs
, 
vÆue
) \

725 
ªt
 = 
év_put_u
##
	`bôs
(
s˘x
, 
©åty≥
, 
vÆue
); \

726 i‡(
ªt
 < 0) \

727 
év_put_Áûuª
; \

728 } 0)

	)

730 
	#TLV_PUT_U8
(
s˘x
, 
©åty≥
, 
d©a
Ë
	`TLV_PUT_INT
(s˘x,áâπy≥, 8, d©a)

	)

731 
	#TLV_PUT_U16
(
s˘x
, 
©åty≥
, 
d©a
Ë
	`TLV_PUT_INT
(s˘x,áâπy≥, 16, d©a)

	)

732 
	#TLV_PUT_U32
(
s˘x
, 
©åty≥
, 
d©a
Ë
	`TLV_PUT_INT
(s˘x,áâπy≥, 32, d©a)

	)

733 
	#TLV_PUT_U64
(
s˘x
, 
©åty≥
, 
d©a
Ë
	`TLV_PUT_INT
(s˘x,áâπy≥, 64, d©a)

	)

734 
	#TLV_PUT_STRING
(
s˘x
, 
©åty≥
, 
°r
, 
Àn
) \

736 
ªt
 = 
	`év_put_°rög
(
s˘x
, 
©åty≥
, 
°r
, 
Àn
); \

737 i‡(
ªt
 < 0) \

738 
év_put_Áûuª
; \

739 } 0)

	)

740 
	#TLV_PUT_PATH
(
s˘x
, 
©åty≥
, 
p
) \

742 
ªt
 = 
	`év_put_°rög
(
s˘x
, 
©åty≥
, 
p
->
°¨t
, \

743 
p
->
íd
 -Ö->
°¨t
); \

744 i‡(
ªt
 < 0) \

745 
év_put_Áûuª
; \

746 } 0)

	)

747 
	#TLV_PUT_UUID
(
s˘x
, 
©åty≥
, 
uuid
) \

749 
ªt
 = 
	`év_put_uuid
(
s˘x
, 
©åty≥
, 
uuid
); \

750 i‡(
ªt
 < 0) \

751 
év_put_Áûuª
; \

752 } 0)

	)

753 
	#TLV_PUT_BTRFS_TIMESPEC
(
s˘x
, 
©åty≥
, 
eb
, 
ts
) \

755 
ªt
 = 
	`év_put_båfs_time•ec
(
s˘x
, 
©åty≥
, 
eb
, 
ts
); \

756 i‡(
ªt
 < 0) \

757 
év_put_Áûuª
; \

758 } 0)

	)

760 
	$£nd_hódî
(
£nd_˘x
 *
s˘x
)

762 
båfs_°ªam_hódî
 
hdr
;

764 
	`°r˝y
(
hdr
.
magic
, 
BTRFS_SEND_STREAM_MAGIC
);

765 
hdr
.
vîsi⁄
 = 
	`˝u_to_À32
(
s˘x
->
¥Ÿo
);

766  
	`wrôe_buf
(
s˘x
->
£nd_fûp
, &
hdr
, (hdr),

767 &
s˘x
->
£nd_off
);

768 
	}
}

773 
	$begö_cmd
(
£nd_˘x
 *
s˘x
, 
cmd
)

775 
båfs_cmd_hódî
 *
hdr
;

777 i‡(
	`WARN_ON
(!
s˘x
->
£nd_buf
))

778  -
EINVAL
;

780 
	`BUG_ON
(
s˘x
->
£nd_size
);

782 
s˘x
->
£nd_size
 +(*
hdr
);

783 
hdr
 = (
båfs_cmd_hódî
 *)
s˘x
->
£nd_buf
;

784 
	`put_u«lig√d_À16
(
cmd
, &
hdr
->cmd);

787 
	}
}

789 
	$£nd_cmd
(
£nd_˘x
 *
s˘x
)

791 
ªt
;

792 
båfs_cmd_hódî
 *
hdr
;

793 
u32
 
¸c
;

795 
hdr
 = (
båfs_cmd_hódî
 *)
s˘x
->
£nd_buf
;

796 
	`put_u«lig√d_À32
(
s˘x
->
£nd_size
 - (*
hdr
), &hdr->
Àn
);

797 
	`put_u«lig√d_À32
(0, &
hdr
->
¸c
);

799 
¸c
 = 
	`båfs_¸c32c
(0, (*)
s˘x
->
£nd_buf
, s˘x->
£nd_size
);

800 
	`put_u«lig√d_À32
(
¸c
, &
hdr
->crc);

802 
ªt
 = 
	`wrôe_buf
(
s˘x
->
£nd_fûp
, s˘x->
£nd_buf
, s˘x->
£nd_size
,

803 &
s˘x
->
£nd_off
);

805 
s˘x
->
£nd_size
 = 0;

806 
s˘x
->
put_d©a
 = 
Ál£
;

808  
ªt
;

809 
	}
}

814 
	$£nd_ª«me
(
£nd_˘x
 *
s˘x
,

815 
fs_∑th
 *
‰om
, fs_∑th *
to
)

817 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
£nd_roŸ
->fs_info;

818 
ªt
;

820 
	`båfs_debug
(
fs_öfo
, "£nd_ª«mê%†-> %s", 
‰om
->
°¨t
, 
to
->start);

822 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_RENAME
);

823 i‡(
ªt
 < 0)

824 
out
;

826 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
‰om
);

827 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH_TO
, 
to
);

829 
ªt
 = 
	`£nd_cmd
(
s˘x
);

831 
év_put_Áûuª
:

832 
out
:

833  
ªt
;

834 
	}
}

839 
	$£nd_lök
(
£nd_˘x
 *
s˘x
,

840 
fs_∑th
 *
∑th
, fs_∑th *
 k
)

842 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
£nd_roŸ
->fs_info;

843 
ªt
;

845 
	`båfs_debug
(
fs_öfo
, "£nd_lök %†-> %s", 
∑th
->
°¨t
, 
 k
->start);

847 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_LINK
);

848 i‡(
ªt
 < 0)

849 
out
;

851 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
∑th
);

852 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH_LINK
, 
 k
);

854 
ªt
 = 
	`£nd_cmd
(
s˘x
);

856 
év_put_Áûuª
:

857 
out
:

858  
ªt
;

859 
	}
}

864 
	$£nd_u∆ök
(
£nd_˘x
 *
s˘x
, 
fs_∑th
 *
∑th
)

866 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
£nd_roŸ
->fs_info;

867 
ªt
;

869 
	`båfs_debug
(
fs_öfo
, "£nd_u∆ök %s", 
∑th
->
°¨t
);

871 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_UNLINK
);

872 i‡(
ªt
 < 0)

873 
out
;

875 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
∑th
);

877 
ªt
 = 
	`£nd_cmd
(
s˘x
);

879 
év_put_Áûuª
:

880 
out
:

881  
ªt
;

882 
	}
}

887 
	$£nd_rmdú
(
£nd_˘x
 *
s˘x
, 
fs_∑th
 *
∑th
)

889 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
£nd_roŸ
->fs_info;

890 
ªt
;

892 
	`båfs_debug
(
fs_öfo
, "£nd_rmdú %s", 
∑th
->
°¨t
);

894 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_RMDIR
);

895 i‡(
ªt
 < 0)

896 
out
;

898 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
∑th
);

900 
ªt
 = 
	`£nd_cmd
(
s˘x
);

902 
év_put_Áûuª
:

903 
out
:

904  
ªt
;

905 
	}
}

907 
	sbåfs_öode_öfo
 {

908 
u64
 
	msize
;

909 
u64
 
	mgí
;

910 
u64
 
	mmode
;

911 
u64
 
	muid
;

912 
u64
 
	mgid
;

913 
u64
 
	mrdev
;

914 
u64
 
	mfûóâr
;

915 
u64
 
	m∆ök
;

921 
	$gë_öode_öfo
(
båfs_roŸ
 *
roŸ
, 
u64
 
öo
,

922 
båfs_öode_öfo
 *
öfo
)

924 
ªt
;

925 
båfs_∑th
 *
∑th
;

926 
båfs_öode_ôem
 *
ii
;

927 
båfs_key
 
key
;

929 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

930 i‡(!
∑th
)

931  -
ENOMEM
;

933 
key
.
obje˘id
 = 
öo
;

934 
key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

935 
key
.
off£t
 = 0;

936 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

937 i‡(
ªt
) {

938 i‡(
ªt
 > 0)

939 
ªt
 = -
ENOENT
;

940 
out
;

943 i‡(!
öfo
)

944 
out
;

946 
ii
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

947 
båfs_öode_ôem
);

948 
öfo
->
size
 = 
	`båfs_öode_size
(
∑th
->
nodes
[0], 
ii
);

949 
öfo
->
gí
 = 
	`båfs_öode_gíî©i⁄
(
∑th
->
nodes
[0], 
ii
);

950 
öfo
->
mode
 = 
	`båfs_öode_mode
(
∑th
->
nodes
[0], 
ii
);

951 
öfo
->
uid
 = 
	`båfs_öode_uid
(
∑th
->
nodes
[0], 
ii
);

952 
öfo
->
gid
 = 
	`båfs_öode_gid
(
∑th
->
nodes
[0], 
ii
);

953 
öfo
->
rdev
 = 
	`båfs_öode_rdev
(
∑th
->
nodes
[0], 
ii
);

954 
öfo
->
∆ök
 = 
	`båfs_öode_∆ök
(
∑th
->
nodes
[0], 
ii
);

959 
öfo
->
fûóâr
 = 
	`båfs_öode_Êags
(
∑th
->
nodes
[0], 
ii
);

961 
out
:

962 
	`båfs_‰ì_∑th
(
∑th
);

963  
ªt
;

964 
	}
}

966 
	$gë_öode_gí
(
båfs_roŸ
 *
roŸ
, 
u64
 
öo
, u64 *
gí
)

968 
ªt
;

969 
båfs_öode_öfo
 
öfo
 = { 0 };

971 
	`ASSERT
(
gí
);

973 
ªt
 = 
	`gë_öode_öfo
(
roŸ
, 
öo
, &
öfo
);

974 *
gí
 = 
öfo
.gen;

975  
ªt
;

976 
	}
}

978 (*
	tôî©e_öode_ªf_t
)(
	tnum
, 
	tu64
 
	tdú
, 
	tödex
,

979 
	tfs_∑th
 *
	tp
,

980 *
	t˘x
);

990 
	$ôî©e_öode_ªf
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
,

991 
båfs_key
 *
found_key
, 
ªsﬁve
,

992 
ôî©e_öode_ªf_t
 
ôî©e
, *
˘x
)

994 
exã¡_buf„r
 *
eb
 = 
∑th
->
nodes
[0];

995 
båfs_öode_ªf
 *
úef
;

996 
båfs_öode_exåef
 *
exåef
;

997 
båfs_∑th
 *
tmp_∑th
;

998 
fs_∑th
 *
p
;

999 
u32
 
cur
 = 0;

1000 
u32
 
tŸÆ
;

1001 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

1002 
u32
 
«me_Àn
;

1003 *
°¨t
;

1004 
ªt
 = 0;

1005 
num
 = 0;

1006 
ödex
;

1007 
u64
 
dú
;

1008 
«me_off
;

1009 
ñem_size
;

1010 
±r
;

1012 
p
 = 
	`fs_∑th_Æloc_ªvî£d
();

1013 i‡(!
p
)

1014  -
ENOMEM
;

1016 
tmp_∑th
 = 
	`Æloc_∑th_f‹_£nd
();

1017 i‡(!
tmp_∑th
) {

1018 
	`fs_∑th_‰ì
(
p
);

1019  -
ENOMEM
;

1023 i‡(
found_key
->
ty≥
 =
BTRFS_INODE_REF_KEY
) {

1024 
±r
 = ()
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
,

1025 
båfs_öode_ªf
);

1026 
tŸÆ
 = 
	`båfs_ôem_size
(
eb
, 
¶Ÿ
);

1027 
ñem_size
 = (*
úef
);

1029 
±r
 = 
	`båfs_ôem_±r_off£t
(
eb
, 
¶Ÿ
);

1030 
tŸÆ
 = 
	`båfs_ôem_size
(
eb
, 
¶Ÿ
);

1031 
ñem_size
 = (*
exåef
);

1034 
cur
 < 
tŸÆ
) {

1035 
	`fs_∑th_ª£t
(
p
);

1037 i‡(
found_key
->
ty≥
 =
BTRFS_INODE_REF_KEY
) {

1038 
úef
 = (
båfs_öode_ªf
 *)(
±r
 + 
cur
);

1039 
«me_Àn
 = 
	`båfs_öode_ªf_«me_Àn
(
eb
, 
úef
);

1040 
«me_off
 = ()(
úef
 + 1);

1041 
ödex
 = 
	`båfs_öode_ªf_ödex
(
eb
, 
úef
);

1042 
dú
 = 
found_key
->
off£t
;

1044 
exåef
 = (
båfs_öode_exåef
 *)(
±r
 + 
cur
);

1045 
«me_Àn
 = 
	`båfs_öode_exåef_«me_Àn
(
eb
, 
exåef
);

1046 
«me_off
 = ()&
exåef
->
«me
;

1047 
ödex
 = 
	`båfs_öode_exåef_ödex
(
eb
, 
exåef
);

1048 
dú
 = 
	`båfs_öode_exåef_∑ª¡
(
eb
, 
exåef
);

1051 i‡(
ªsﬁve
) {

1052 
°¨t
 = 
	`båfs_ªf_to_∑th
(
roŸ
, 
tmp_∑th
, 
«me_Àn
,

1053 
«me_off
, 
eb
, 
dú
,

1054 
p
->
buf
,Ö->
buf_Àn
);

1055 i‡(
	`IS_ERR
(
°¨t
)) {

1056 
ªt
 = 
	`PTR_ERR
(
°¨t
);

1057 
out
;

1059 i‡(
°¨t
 < 
p
->
buf
) {

1061 
ªt
 = 
	`fs_∑th_ísuª_buf
(
p
,

1062 
p
->
buf_Àn
 +Ö->
buf
 - 
°¨t
);

1063 i‡(
ªt
 < 0)

1064 
out
;

1065 
°¨t
 = 
	`båfs_ªf_to_∑th
(
roŸ
, 
tmp_∑th
,

1066 
«me_Àn
, 
«me_off
,

1067 
eb
, 
dú
,

1068 
p
->
buf
,Ö->
buf_Àn
);

1069 i‡(
	`IS_ERR
(
°¨t
)) {

1070 
ªt
 = 
	`PTR_ERR
(
°¨t
);

1071 
out
;

1073 
	`BUG_ON
(
°¨t
 < 
p
->
buf
);

1075 
p
->
°¨t
 = start;

1077 
ªt
 = 
	`fs_∑th_add_‰om_exã¡_buf„r
(
p
, 
eb
, 
«me_off
,

1078 
«me_Àn
);

1079 i‡(
ªt
 < 0)

1080 
out
;

1083 
cur
 +
ñem_size
 + 
«me_Àn
;

1084 
ªt
 = 
	`ôî©e
(
num
, 
dú
, 
ödex
, 
p
, 
˘x
);

1085 i‡(
ªt
)

1086 
out
;

1087 
num
++;

1090 
out
:

1091 
	`båfs_‰ì_∑th
(
tmp_∑th
);

1092 
	`fs_∑th_‰ì
(
p
);

1093  
ªt
;

1094 
	}
}

1096 (*
	tôî©e_dú_ôem_t
)(
	tnum
, 
	tbåfs_key
 *
	tdi_key
,

1097 c⁄° *
	t«me
, 
	t«me_Àn
,

1098 c⁄° *
	td©a
, 
	td©a_Àn
,

1099 *
	t˘x
);

1108 
	$ôî©e_dú_ôem
(
båfs_roŸ
 *
roŸ
, 
båfs_∑th
 *
∑th
,

1109 
ôî©e_dú_ôem_t
 
ôî©e
, *
˘x
)

1111 
ªt
 = 0;

1112 
exã¡_buf„r
 *
eb
;

1113 
båfs_dú_ôem
 *
di
;

1114 
båfs_key
 
di_key
;

1115 *
buf
 = 
NULL
;

1116 
buf_Àn
;

1117 
u32
 
«me_Àn
;

1118 
u32
 
d©a_Àn
;

1119 
u32
 
cur
;

1120 
u32
 
Àn
;

1121 
u32
 
tŸÆ
;

1122 
¶Ÿ
;

1123 
num
;

1131 
buf_Àn
 = 
PATH_MAX
;

1132 
buf
 = 
	`kmÆloc
(
buf_Àn
, 
GFP_KERNEL
);

1133 i‡(!
buf
) {

1134 
ªt
 = -
ENOMEM
;

1135 
out
;

1138 
eb
 = 
∑th
->
nodes
[0];

1139 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

1140 
di
 = 
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
, 
båfs_dú_ôem
);

1141 
cur
 = 0;

1142 
Àn
 = 0;

1143 
tŸÆ
 = 
	`båfs_ôem_size
(
eb
, 
¶Ÿ
);

1145 
num
 = 0;

1146 
cur
 < 
tŸÆ
) {

1147 
«me_Àn
 = 
	`båfs_dú_«me_Àn
(
eb
, 
di
);

1148 
d©a_Àn
 = 
	`båfs_dú_d©a_Àn
(
eb
, 
di
);

1149 
	`båfs_dú_ôem_key_to_˝u
(
eb
, 
di
, &
di_key
);

1151 i‡(
	`båfs_dú_·y≥
(
eb
, 
di
Ë=
BTRFS_FT_XATTR
) {

1152 i‡(
«me_Àn
 > 
XATTR_NAME_MAX
) {

1153 
ªt
 = -
ENAMETOOLONG
;

1154 
out
;

1156 i‡(
«me_Àn
 + 
d©a_Àn
 >

1157 
	`BTRFS_MAX_XATTR_SIZE
(
roŸ
->
fs_öfo
)) {

1158 
ªt
 = -
E2BIG
;

1159 
out
;

1165 i‡(
«me_Àn
 + 
d©a_Àn
 > 
PATH_MAX
) {

1166 
ªt
 = -
ENAMETOOLONG
;

1167 
out
;

1171 i‡(
«me_Àn
 + 
d©a_Àn
 > 
buf_Àn
) {

1172 
buf_Àn
 = 
«me_Àn
 + 
d©a_Àn
;

1173 i‡(
	`is_vmÆloc_addr
(
buf
)) {

1174 
	`v‰ì
(
buf
);

1175 
buf
 = 
NULL
;

1177 *
tmp
 = 
	`kªÆloc
(
buf
, 
buf_Àn
,

1178 
GFP_KERNEL
 | 
__GFP_NOWARN
);

1180 i‡(!
tmp
)

1181 
	`k‰ì
(
buf
);

1182 
buf
 = 
tmp
;

1184 i‡(!
buf
) {

1185 
buf
 = 
	`kvmÆloc
(
buf_Àn
, 
GFP_KERNEL
);

1186 i‡(!
buf
) {

1187 
ªt
 = -
ENOMEM
;

1188 
out
;

1193 
	`ªad_exã¡_buf„r
(
eb
, 
buf
, ()(
di
 + 1),

1194 
«me_Àn
 + 
d©a_Àn
);

1196 
Àn
 = (*
di
Ë+ 
«me_Àn
 + 
d©a_Àn
;

1197 
di
 = (
båfs_dú_ôem
 *)((*)dò+ 
Àn
);

1198 
cur
 +
Àn
;

1200 
ªt
 = 
	`ôî©e
(
num
, &
di_key
, 
buf
, 
«me_Àn
, buf +Çame_len,

1201 
d©a_Àn
, 
˘x
);

1202 i‡(
ªt
 < 0)

1203 
out
;

1204 i‡(
ªt
) {

1205 
ªt
 = 0;

1206 
out
;

1209 
num
++;

1212 
out
:

1213 
	`kv‰ì
(
buf
);

1214  
ªt
;

1215 
	}
}

1217 
	$__c›y_fú°_ªf
(
num
, 
u64
 
dú
, 
ödex
,

1218 
fs_∑th
 *
p
, *
˘x
)

1220 
ªt
;

1221 
fs_∑th
 *
±
 = 
˘x
;

1223 
ªt
 = 
	`fs_∑th_c›y
(
±
, 
p
);

1224 i‡(
ªt
 < 0)

1225  
ªt
;

1229 
	}
}

1235 
	$gë_öode_∑th
(
båfs_roŸ
 *
roŸ
,

1236 
u64
 
öo
, 
fs_∑th
 *
∑th
)

1238 
ªt
;

1239 
båfs_key
 
key
, 
found_key
;

1240 
båfs_∑th
 *
p
;

1242 
p
 = 
	`Æloc_∑th_f‹_£nd
();

1243 i‡(!
p
)

1244  -
ENOMEM
;

1246 
	`fs_∑th_ª£t
(
∑th
);

1248 
key
.
obje˘id
 = 
öo
;

1249 
key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

1250 
key
.
off£t
 = 0;

1252 
ªt
 = 
	`båfs_£¨ch_¶Ÿ_f‹_ªad
(
roŸ
, &
key
, 
p
, 1, 0);

1253 i‡(
ªt
 < 0)

1254 
out
;

1255 i‡(
ªt
) {

1256 
ªt
 = 1;

1257 
out
;

1259 
	`båfs_ôem_key_to_˝u
(
p
->
nodes
[0], &
found_key
,Ö->
¶Ÿs
[0]);

1260 i‡(
found_key
.
obje˘id
 !
öo
 ||

1261 (
found_key
.
ty≥
 !
BTRFS_INODE_REF_KEY
 &&

1262 
found_key
.
ty≥
 !
BTRFS_INODE_EXTREF_KEY
)) {

1263 
ªt
 = -
ENOENT
;

1264 
out
;

1267 
ªt
 = 
	`ôî©e_öode_ªf
(
roŸ
, 
p
, &
found_key
, 1,

1268 
__c›y_fú°_ªf
, 
∑th
);

1269 i‡(
ªt
 < 0)

1270 
out
;

1271 
ªt
 = 0;

1273 
out
:

1274 
	`båfs_‰ì_∑th
(
p
);

1275  
ªt
;

1276 
	}
}

1278 
	sbackªf_˘x
 {

1279 
£nd_˘x
 *
	ms˘x
;

1282 
u64
 
	mfound
;

1288 
u64
 
	mcur_obje˘id
;

1289 
u64
 
	mcur_off£t
;

1292 
u64
 
	mexã¡_Àn
;

1295 
u64
 
	mbyãƒ
;

1297 
u64
 
	mbackªf_ow√r
;

1299 
u64
 
	mbackªf_off£t
;

1302 
	$__˛⁄e_roŸ_cmp_b£¨ch
(c⁄° *
key
, c⁄° *
ñt
)

1304 
u64
 
roŸ
 = (u64)(
uöçå_t
)
key
;

1305 c⁄° 
˛⁄e_roŸ
 *
¸
 = 
ñt
;

1307 i‡(
roŸ
 < 
¸
->roŸ->
roŸ_key
.
obje˘id
)

1309 i‡(
roŸ
 > 
¸
->roŸ->
roŸ_key
.
obje˘id
)

1312 
	}
}

1314 
	$__˛⁄e_roŸ_cmp_s‹t
(c⁄° *
e1
, c⁄° *
e2
)

1316 c⁄° 
˛⁄e_roŸ
 *
¸1
 = 
e1
;

1317 c⁄° 
˛⁄e_roŸ
 *
¸2
 = 
e2
;

1319 i‡(
¸1
->
roŸ
->
roŸ_key
.
obje˘id
 < 
¸2
->root->root_key.objectid)

1321 i‡(
¸1
->
roŸ
->
roŸ_key
.
obje˘id
 > 
¸2
->root->root_key.objectid)

1324 
	}
}

1330 
	$ôî©e_backªfs
(
u64
 
öo
, u64 
off£t
, u64 
num_byãs
, u64 
roŸ_id
,

1331 *
˘x_
)

1333 
backªf_˘x
 *
b˘x
 = 
˘x_
;

1334 
˛⁄e_roŸ
 *clone_root;

1337 
˛⁄e_roŸ
 = 
	`b£¨ch
((*)(
uöçå_t
)
roŸ_id
, 
b˘x
->
s˘x
->
˛⁄e_roŸs
,

1338 
b˘x
->
s˘x
->
˛⁄e_roŸs_˙t
,

1339 (
˛⁄e_roŸ
),

1340 
__˛⁄e_roŸ_cmp_b£¨ch
);

1341 i‡(!
˛⁄e_roŸ
)

1345 i‡(
˛⁄e_roŸ
->
roŸ
 =
b˘x
->
s˘x
->
£nd_roŸ
 &&

1346 
öo
 =
b˘x
->
cur_obje˘id
 &&

1347 
off£t
 =
b˘x
->
cur_off£t
)

1354 i‡(
˛⁄e_roŸ
->
roŸ
 =
b˘x
->
s˘x
->
£nd_roŸ
) {

1360 i‡(
öo
 > 
b˘x
->
cur_obje˘id
)

1368 i‡(
öo
 =
b˘x
->
cur_obje˘id
 &&

1369 
off£t
 + 
b˘x
->
exã¡_Àn
 >

1370 
b˘x
->
s˘x
->
cur_öode_√xt_wrôe_off£t
)

1374 
b˘x
->
found
++;

1375 
˛⁄e_roŸ
->
found_ªf
 = 
åue
;

1383 i‡(
num_byãs
 > 
˛⁄e_roŸ
->num_bytes) {

1384 
˛⁄e_roŸ
->
öo
 = ino;

1385 
˛⁄e_roŸ
->
off£t
 = offset;

1386 
˛⁄e_roŸ
->
num_byãs
 =Çum_bytes;

1392 i‡(
num_byãs
 >
b˘x
->
exã¡_Àn
)

1393  
BTRFS_ITERATE_EXTENT_INODES_STOP
;

1397 
	}
}

1399 
boﬁ
 
	$lookup_backªf_ˇche
(
u64
 
Àaf_byãƒ
, *
˘x
,

1400 c⁄° 
u64
 **
roŸ_ids_ªt
, *
roŸ_cou¡_ªt
)

1402 
backªf_˘x
 *
b˘x
 = 
˘x
;

1403 
£nd_˘x
 *
s˘x
 = 
b˘x
->sctx;

1404 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
£nd_roŸ
->fs_info;

1405 c⁄° 
u64
 
key
 = 
Àaf_byãƒ
 >> 
fs_öfo
->
£˘‹size_bôs
;

1406 
båfs_Ãu_ˇche_íåy
 *
øw_íåy
;

1407 
backªf_ˇche_íåy
 *
íåy
;

1409 i‡(
	`båfs_Ãu_ˇche_size
(&
s˘x
->
backªf_ˇche
) == 0)

1410  
Ál£
;

1423 i‡(
fs_öfo
->
œ°_ªloc_å™s
 > 
s˘x
->
backªf_ˇche_œ°_ªloc_å™s
) {

1424 
	`båfs_Ãu_ˇche_˛ór
(&
s˘x
->
backªf_ˇche
);

1425  
Ál£
;

1428 
øw_íåy
 = 
	`båfs_Ãu_ˇche_lookup
(&
s˘x
->
backªf_ˇche
, 
key
, 0);

1429 i‡(!
øw_íåy
)

1430  
Ál£
;

1432 
íåy
 = 
	`c⁄èöî_of
(
øw_íåy
, 
backªf_ˇche_íåy
,Éntry);

1433 *
roŸ_ids_ªt
 = 
íåy
->
roŸ_ids
;

1434 *
roŸ_cou¡_ªt
 = 
íåy
->
num_roŸs
;

1436  
åue
;

1437 
	}
}

1439 
	$°‹e_backªf_ˇche
(
u64
 
Àaf_byãƒ
, c⁄° 
uli°
 *
roŸ_ids
,

1440 *
˘x
)

1442 
backªf_˘x
 *
b˘x
 = 
˘x
;

1443 
£nd_˘x
 *
s˘x
 = 
b˘x
->sctx;

1444 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
£nd_roŸ
->fs_info;

1445 
backªf_ˇche_íåy
 *
√w_íåy
;

1446 
uli°_ôî©‹
 
uôî
;

1447 
uli°_node
 *
node
;

1448 
ªt
;

1455 
√w_íåy
 = 
	`kmÆloc
((
backªf_ˇche_íåy
), 
GFP_NOFS
);

1457 i‡(!
√w_íåy
)

1460 
√w_íåy
->
íåy
.
key
 = 
Àaf_byãƒ
 >> 
fs_öfo
->
£˘‹size_bôs
;

1461 
√w_íåy
->
íåy
.
gí
 = 0;

1462 
√w_íåy
->
num_roŸs
 = 0;

1463 
	`ULIST_ITER_INIT
(&
uôî
);

1464 (
node
 = 
	`uli°_√xt
(
roŸ_ids
, &
uôî
)Ë!
NULL
) {

1465 c⁄° 
u64
 
roŸ_id
 = 
node
->
vÆ
;

1466 
˛⁄e_roŸ
 *
roŸ
;

1468 
roŸ
 = 
	`b£¨ch
((*)(
uöçå_t
)
roŸ_id
, 
s˘x
->
˛⁄e_roŸs
,

1469 
s˘x
->
˛⁄e_roŸs_˙t
, (
˛⁄e_roŸ
),

1470 
__˛⁄e_roŸ_cmp_b£¨ch
);

1471 i‡(!
roŸ
)

1475 i‡(
√w_íåy
->
num_roŸs
 >
SEND_MAX_BACKREF_CACHE_ROOTS
) {

1476 
	`k‰ì
(
√w_íåy
);

1480 
√w_íåy
->
roŸ_ids
[√w_íåy->
num_roŸs
] = 
roŸ_id
;

1481 
√w_íåy
->
num_roŸs
++;

1493 
ªt
 = 
	`båfs_Ãu_ˇche_°‹e
(&
s˘x
->
backªf_ˇche
, &
√w_íåy
->
íåy
,

1494 
GFP_NOFS
);

1495 
	`ASSERT
(
ªt
 =0 ||Ñë =-
ENOMEM
);

1496 i‡(
ªt
) {

1498 
	`k‰ì
(
√w_íåy
);

1507 i‡(
	`båfs_Ãu_ˇche_size
(&
s˘x
->
backªf_ˇche
) == 1)

1508 
s˘x
->
backªf_ˇche_œ°_ªloc_å™s
 = 
fs_öfo
->
œ°_ªloc_å™s
;

1509 
	}
}

1511 
	$check_exã¡_ôem
(
u64
 
byãƒ
, c⁄° 
båfs_exã¡_ôem
 *
ei
,

1512 c⁄° 
exã¡_buf„r
 *
Àaf
, *
˘x
)

1514 c⁄° 
u64
 
ªfs
 = 
	`båfs_exã¡_ªfs
(
Àaf
, 
ei
);

1515 c⁄° 
backªf_˘x
 *
b˘x
 = 
˘x
;

1516 c⁄° 
£nd_˘x
 *
s˘x
 = 
b˘x
->sctx;

1518 i‡(
byãƒ
 =
b˘x
->bytenr) {

1519 c⁄° 
u64
 
Êags
 = 
	`båfs_exã¡_Êags
(
Àaf
, 
ei
);

1521 i‡(
	`WARN_ON
(
Êags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
))

1522  -
EUCLEAN
;

1531 i‡(
ªfs
 =1 && 
s˘x
->
˛⁄e_roŸs_˙t
 == 1)

1532  -
ENOENT
;

1542 i‡(
ªfs
 > 
SEND_MAX_EXTENT_REFS
)

1543  -
ENOENT
;

1546 
	}
}

1548 
boﬁ
 
	$skù_£lf_d©a_ªf
(
u64
 
roŸ
, u64 
öo
, u64 
off£t
, *
˘x
)

1550 c⁄° 
backªf_˘x
 *
b˘x
 = 
˘x
;

1552 i‡(
öo
 =
b˘x
->
cur_obje˘id
 &&

1553 
roŸ
 =
b˘x
->
backªf_ow√r
 &&

1554 
off£t
 =
b˘x
->
backªf_off£t
)

1555  
åue
;

1557  
Ál£
;

1558 
	}
}

1569 
	$föd_exã¡_˛⁄e
(
£nd_˘x
 *
s˘x
,

1570 
båfs_∑th
 *
∑th
,

1571 
u64
 
öo
, u64 
d©a_off£t
,

1572 
u64
 
öo_size
,

1573 
˛⁄e_roŸ
 **
found
)

1575 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
£nd_roŸ
->fs_info;

1576 
ªt
;

1577 
exã¡_ty≥
;

1578 
u64
 
logiˇl
;

1579 
u64
 
disk_byã
;

1580 
u64
 
num_byãs
;

1581 
båfs_fûe_exã¡_ôem
 *
fi
;

1582 
exã¡_buf„r
 *
eb
 = 
∑th
->
nodes
[0];

1583 
backªf_˘x
 backref_ctx = { 0 };

1584 
båfs_backªf_wÆk_˘x
 
backªf_wÆk_˘x
 = { 0 };

1585 
˛⁄e_roŸ
 *
cur_˛⁄e_roŸ
;

1586 
com¥es£d
;

1587 
u32
 
i
;

1595 i‡(
d©a_off£t
 >
öo_size
)

1598 
fi
 = 
	`båfs_ôem_±r
(
eb
, 
∑th
->
¶Ÿs
[0], 
båfs_fûe_exã¡_ôem
);

1599 
exã¡_ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
eb
, 
fi
);

1600 i‡(
exã¡_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
)

1601  -
ENOENT
;

1603 
disk_byã
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
eb
, 
fi
);

1604 i‡(
disk_byã
 == 0)

1605  -
ENOENT
;

1607 
com¥es£d
 = 
	`båfs_fûe_exã¡_com¥essi⁄
(
eb
, 
fi
);

1608 
num_byãs
 = 
	`båfs_fûe_exã¡_num_byãs
(
eb
, 
fi
);

1609 
logiˇl
 = 
disk_byã
 + 
	`båfs_fûe_exã¡_off£t
(
eb
, 
fi
);

1614 
i
 = 0; i < 
s˘x
->
˛⁄e_roŸs_˙t
; i++) {

1615 
cur_˛⁄e_roŸ
 = 
s˘x
->
˛⁄e_roŸs
 + 
i
;

1616 
cur_˛⁄e_roŸ
->
öo
 = (
u64
)-1;

1617 
cur_˛⁄e_roŸ
->
off£t
 = 0;

1618 
cur_˛⁄e_roŸ
->
num_byãs
 = 0;

1619 
cur_˛⁄e_roŸ
->
found_ªf
 = 
Ál£
;

1622 
backªf_˘x
.
s˘x
 = sctx;

1623 
backªf_˘x
.
cur_obje˘id
 = 
öo
;

1624 
backªf_˘x
.
cur_off£t
 = 
d©a_off£t
;

1625 
backªf_˘x
.
byãƒ
 = 
disk_byã
;

1630 
backªf_˘x
.
backªf_ow√r
 = 
	`båfs_hódî_ow√r
(
eb
);

1631 
backªf_˘x
.
backªf_off£t
 = 
d©a_off£t
 - 
	`båfs_fûe_exã¡_off£t
(
eb
, 
fi
);

1638 i‡(
d©a_off£t
 + 
num_byãs
 >
öo_size
)

1639 
backªf_˘x
.
exã¡_Àn
 = 
öo_size
 - 
d©a_off£t
;

1641 
backªf_˘x
.
exã¡_Àn
 = 
num_byãs
;

1646 
backªf_wÆk_˘x
.
byãƒ
 = 
disk_byã
;

1647 i‡(
com¥es£d
 =
BTRFS_COMPRESS_NONE
)

1648 
backªf_wÆk_˘x
.
exã¡_ôem_pos
 = 
	`båfs_fûe_exã¡_off£t
(
eb
, 
fi
);

1649 
backªf_wÆk_˘x
.
fs_öfo
 = fs_info;

1650 
backªf_wÆk_˘x
.
ˇche_lookup
 = 
lookup_backªf_ˇche
;

1651 
backªf_wÆk_˘x
.
ˇche_°‹e
 = 
°‹e_backªf_ˇche
;

1652 
backªf_wÆk_˘x
.
ödúe˘_ªf_ôî©‹
 = 
ôî©e_backªfs
;

1653 
backªf_wÆk_˘x
.
check_exã¡_ôem
 = check_extent_item;

1654 
backªf_wÆk_˘x
.
u£r_˘x
 = &
backªf_˘x
;

1664 i‡(
s˘x
->
˛⁄e_roŸs_˙t
 == 1)

1665 
backªf_wÆk_˘x
.
skù_d©a_ªf
 = 
skù_£lf_d©a_ªf
;

1667 
ªt
 = 
	`ôî©e_exã¡_öodes
(&
backªf_wÆk_˘x
, 
åue
, 
ôî©e_backªfs
,

1668 &
backªf_˘x
);

1669 i‡(
ªt
 < 0)

1670  
ªt
;

1672 
	`down_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

1673 i‡(
fs_öfo
->
œ°_ªloc_å™s
 > 
s˘x
->last_reloc_trans) {

1686 
	`up_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

1687  -
ENOENT
;

1689 
	`up_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

1691 
	`båfs_debug
(
fs_öfo
,

1693 
d©a_off£t
, 
öo
, 
num_byãs
, 
logiˇl
);

1695 i‡(!
backªf_˘x
.
found
) {

1696 
	`båfs_debug
(
fs_öfo
, "no clones found");

1697  -
ENOENT
;

1700 
cur_˛⁄e_roŸ
 = 
NULL
;

1701 
i
 = 0; i < 
s˘x
->
˛⁄e_roŸs_˙t
; i++) {

1702 
˛⁄e_roŸ
 *˛⁄e_roŸ = &
s˘x
->
˛⁄e_roŸs
[
i
];

1704 i‡(!
˛⁄e_roŸ
->
found_ªf
)

1712 i‡(!
cur_˛⁄e_roŸ
 ||

1713 
˛⁄e_roŸ
->
num_byãs
 > 
cur_˛⁄e_roŸ
->num_bytes) {

1714 
cur_˛⁄e_roŸ
 = 
˛⁄e_roŸ
;

1720 i‡(
˛⁄e_roŸ
->
num_byãs
 >
backªf_˘x
.
exã¡_Àn
)

1725 i‡(
cur_˛⁄e_roŸ
) {

1726 *
found
 = 
cur_˛⁄e_roŸ
;

1727 
ªt
 = 0;

1729 
ªt
 = -
ENOENT
;

1732  
ªt
;

1733 
	}
}

1735 
	$ªad_symlök
(
båfs_roŸ
 *
roŸ
,

1736 
u64
 
öo
,

1737 
fs_∑th
 *
de°
)

1739 
ªt
;

1740 
båfs_∑th
 *
∑th
;

1741 
båfs_key
 
key
;

1742 
båfs_fûe_exã¡_ôem
 *
ei
;

1743 
u8
 
ty≥
;

1744 
u8
 
com¥essi⁄
;

1745 
off
;

1746 
Àn
;

1748 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

1749 i‡(!
∑th
)

1750  -
ENOMEM
;

1752 
key
.
obje˘id
 = 
öo
;

1753 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

1754 
key
.
off£t
 = 0;

1755 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

1756 i‡(
ªt
 < 0)

1757 
out
;

1758 i‡(
ªt
) {

1767 
	`båfs_îr
(
roŸ
->
fs_öfo
,

1769 
öo
, 
roŸ
->
roŸ_key
.
obje˘id
);

1770 
ªt
 = -
EIO
;

1771 
out
;

1774 
ei
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

1775 
båfs_fûe_exã¡_ôem
);

1776 
ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
∑th
->
nodes
[0], 
ei
);

1777 i‡(
	`u∆ikñy
(
ty≥
 !
BTRFS_FILE_EXTENT_INLINE
)) {

1778 
ªt
 = -
EUCLEAN
;

1779 
	`båfs_¸ô
(
roŸ
->
fs_öfo
,

1781 
öo
, 
	`båfs_roŸ_id
(
roŸ
), 
ty≥
);

1782 
out
;

1784 
com¥essi⁄
 = 
	`båfs_fûe_exã¡_com¥essi⁄
(
∑th
->
nodes
[0], 
ei
);

1785 i‡(
	`u∆ikñy
(
com¥essi⁄
 !
BTRFS_COMPRESS_NONE
)) {

1786 
ªt
 = -
EUCLEAN
;

1787 
	`båfs_¸ô
(
roŸ
->
fs_öfo
,

1789 
öo
, 
	`båfs_roŸ_id
(
roŸ
), 
com¥essi⁄
);

1790 
out
;

1793 
off
 = 
	`båfs_fûe_exã¡_ölöe_°¨t
(
ei
);

1794 
Àn
 = 
	`båfs_fûe_exã¡_øm_byãs
(
∑th
->
nodes
[0], 
ei
);

1796 
ªt
 = 
	`fs_∑th_add_‰om_exã¡_buf„r
(
de°
, 
∑th
->
nodes
[0], 
off
, 
Àn
);

1798 
out
:

1799 
	`båfs_‰ì_∑th
(
∑th
);

1800  
ªt
;

1801 
	}
}

1807 
	$gí_unique_«me
(
£nd_˘x
 *
s˘x
,

1808 
u64
 
öo
, u64 
gí
,

1809 
fs_∑th
 *
de°
)

1811 
ªt
 = 0;

1812 
båfs_∑th
 *
∑th
;

1813 
båfs_dú_ôem
 *
di
;

1814 
tmp
[64];

1815 
Àn
;

1816 
u64
 
idx
 = 0;

1818 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

1819 i‡(!
∑th
)

1820  -
ENOMEM
;

1823 
fs¸y±_°r
 
tmp_«me
;

1825 
Àn
 = 
	`¢¥ötf
(
tmp
, (tmp), "o%llu-%llu-%llu",

1826 
öo
, 
gí
, 
idx
);

1827 
	`ASSERT
(
Àn
 < (
tmp
));

1828 
tmp_«me
.
«me
 = 
tmp
;

1829 
tmp_«me
.
Àn
 = 
	`°æí
(
tmp
);

1831 
di
 = 
	`båfs_lookup_dú_ôem
(
NULL
, 
s˘x
->
£nd_roŸ
,

1832 
∑th
, 
BTRFS_FIRST_FREE_OBJECTID
,

1833 &
tmp_«me
, 0);

1834 
	`båfs_ªÀa£_∑th
(
∑th
);

1835 i‡(
	`IS_ERR
(
di
)) {

1836 
ªt
 = 
	`PTR_ERR
(
di
);

1837 
out
;

1839 i‡(
di
) {

1841 
idx
++;

1845 i‡(!
s˘x
->
∑ª¡_roŸ
) {

1847 
ªt
 = 0;

1851 
di
 = 
	`båfs_lookup_dú_ôem
(
NULL
, 
s˘x
->
∑ª¡_roŸ
,

1852 
∑th
, 
BTRFS_FIRST_FREE_OBJECTID
,

1853 &
tmp_«me
, 0);

1854 
	`båfs_ªÀa£_∑th
(
∑th
);

1855 i‡(
	`IS_ERR
(
di
)) {

1856 
ªt
 = 
	`PTR_ERR
(
di
);

1857 
out
;

1859 i‡(
di
) {

1861 
idx
++;

1868 
ªt
 = 
	`fs_∑th_add
(
de°
, 
tmp
, 
	`°æí
(tmp));

1870 
out
:

1871 
	`båfs_‰ì_∑th
(
∑th
);

1872  
ªt
;

1873 
	}
}

1875 
	eöode_°©e
 {

1876 
	möode_°©e_no_ch™ge
,

1877 
	möode_°©e_wûl_¸óã
,

1878 
	möode_°©e_did_¸óã
,

1879 
	möode_°©e_wûl_dñëe
,

1880 
	möode_°©e_did_dñëe
,

1883 
	$gë_cur_öode_°©e
(
£nd_˘x
 *
s˘x
, 
u64
 
öo
, u64 
gí
,

1884 
u64
 *
£nd_gí
, u64 *
∑ª¡_gí
)

1886 
ªt
;

1887 
À·_ªt
;

1888 
right_ªt
;

1889 
u64
 
À·_gí
;

1890 
u64
 
right_gí
 = 0;

1891 
båfs_öode_öfo
 
öfo
;

1893 
ªt
 = 
	`gë_öode_öfo
(
s˘x
->
£nd_roŸ
, 
öo
, &
öfo
);

1894 i‡(
ªt
 < 0 &&Ñë !-
ENOENT
)

1895 
out
;

1896 
À·_ªt
 = (
öfo
.
∆ök
 =0Ë? -
ENOENT
 : 
ªt
;

1897 
À·_gí
 = 
öfo
.
gí
;

1898 i‡(
£nd_gí
)

1899 *
£nd_gí
 = ((
À·_ªt
 =-
ENOENT
Ë? 0 : 
öfo
.
gí
);

1901 i‡(!
s˘x
->
∑ª¡_roŸ
) {

1902 
right_ªt
 = -
ENOENT
;

1904 
ªt
 = 
	`gë_öode_öfo
(
s˘x
->
∑ª¡_roŸ
, 
öo
, &
öfo
);

1905 i‡(
ªt
 < 0 &&Ñë !-
ENOENT
)

1906 
out
;

1907 
right_ªt
 = (
öfo
.
∆ök
 =0Ë? -
ENOENT
 : 
ªt
;

1908 
right_gí
 = 
öfo
.
gí
;

1909 i‡(
∑ª¡_gí
)

1910 *
∑ª¡_gí
 = ((
right_ªt
 =-
ENOENT
Ë? 0 : 
öfo
.
gí
);

1913 i‡(!
À·_ªt
 && !
right_ªt
) {

1914 i‡(
À·_gí
 =
gí
 && 
right_gí
 == gen) {

1915 
ªt
 = 
öode_°©e_no_ch™ge
;

1916 } i‡(
À·_gí
 =
gí
) {

1917 i‡(
öo
 < 
s˘x
->
£nd_¥ogªss
)

1918 
ªt
 = 
öode_°©e_did_¸óã
;

1920 
ªt
 = 
öode_°©e_wûl_¸óã
;

1921 } i‡(
right_gí
 =
gí
) {

1922 i‡(
öo
 < 
s˘x
->
£nd_¥ogªss
)

1923 
ªt
 = 
öode_°©e_did_dñëe
;

1925 
ªt
 = 
öode_°©e_wûl_dñëe
;

1927 
ªt
 = -
ENOENT
;

1929 } i‡(!
À·_ªt
) {

1930 i‡(
À·_gí
 =
gí
) {

1931 i‡(
öo
 < 
s˘x
->
£nd_¥ogªss
)

1932 
ªt
 = 
öode_°©e_did_¸óã
;

1934 
ªt
 = 
öode_°©e_wûl_¸óã
;

1936 
ªt
 = -
ENOENT
;

1938 } i‡(!
right_ªt
) {

1939 i‡(
right_gí
 =
gí
) {

1940 i‡(
öo
 < 
s˘x
->
£nd_¥ogªss
)

1941 
ªt
 = 
öode_°©e_did_dñëe
;

1943 
ªt
 = 
öode_°©e_wûl_dñëe
;

1945 
ªt
 = -
ENOENT
;

1948 
ªt
 = -
ENOENT
;

1951 
out
:

1952  
ªt
;

1953 
	}
}

1955 
	$is_öode_exi°ít
(
£nd_˘x
 *
s˘x
, 
u64
 
öo
, u64 
gí
,

1956 
u64
 *
£nd_gí
, u64 *
∑ª¡_gí
)

1958 
ªt
;

1960 i‡(
öo
 =
BTRFS_FIRST_FREE_OBJECTID
)

1963 
ªt
 = 
	`gë_cur_öode_°©e
(
s˘x
, 
öo
, 
gí
, 
£nd_gí
, 
∑ª¡_gí
);

1964 i‡(
ªt
 < 0)

1965 
out
;

1967 i‡(
ªt
 =
öode_°©e_no_ch™ge
 ||

1968 
ªt
 =
öode_°©e_did_¸óã
 ||

1969 
ªt
 =
öode_°©e_wûl_dñëe
)

1970 
ªt
 = 1;

1972 
ªt
 = 0;

1974 
out
:

1975  
ªt
;

1976 
	}
}

1981 
	$lookup_dú_ôem_öode
(
båfs_roŸ
 *
roŸ
,

1982 
u64
 
dú
, c⁄° *
«me
, 
«me_Àn
,

1983 
u64
 *
found_öode
)

1985 
ªt
 = 0;

1986 
båfs_dú_ôem
 *
di
;

1987 
båfs_key
 
key
;

1988 
båfs_∑th
 *
∑th
;

1989 
fs¸y±_°r
 
«me_°r
 = 
	`FSTR_INIT
((*)
«me
, 
«me_Àn
);

1991 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

1992 i‡(!
∑th
)

1993  -
ENOMEM
;

1995 
di
 = 
	`båfs_lookup_dú_ôem
(
NULL
, 
roŸ
, 
∑th
, 
dú
, &
«me_°r
, 0);

1996 i‡(
	`IS_ERR_OR_NULL
(
di
)) {

1997 
ªt
 = 
di
 ? 
	`PTR_ERR
(diË: -
ENOENT
;

1998 
out
;

2000 
	`båfs_dú_ôem_key_to_˝u
(
∑th
->
nodes
[0], 
di
, &
key
);

2001 i‡(
key
.
ty≥
 =
BTRFS_ROOT_ITEM_KEY
) {

2002 
ªt
 = -
ENOENT
;

2003 
out
;

2005 *
found_öode
 = 
key
.
obje˘id
;

2007 
out
:

2008 
	`båfs_‰ì_∑th
(
∑th
);

2009  
ªt
;

2010 
	}
}

2016 
	$gë_fú°_ªf
(
båfs_roŸ
 *
roŸ
, 
u64
 
öo
,

2017 
u64
 *
dú
, u64 *
dú_gí
, 
fs_∑th
 *
«me
)

2019 
ªt
;

2020 
båfs_key
 
key
;

2021 
båfs_key
 
found_key
;

2022 
båfs_∑th
 *
∑th
;

2023 
Àn
;

2024 
u64
 
∑ª¡_dú
;

2026 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

2027 i‡(!
∑th
)

2028  -
ENOMEM
;

2030 
key
.
obje˘id
 = 
öo
;

2031 
key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

2032 
key
.
off£t
 = 0;

2034 
ªt
 = 
	`båfs_£¨ch_¶Ÿ_f‹_ªad
(
roŸ
, &
key
, 
∑th
, 1, 0);

2035 i‡(
ªt
 < 0)

2036 
out
;

2037 i‡(!
ªt
)

2038 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
found_key
,

2039 
∑th
->
¶Ÿs
[0]);

2040 i‡(
ªt
 || 
found_key
.
obje˘id
 !
öo
 ||

2041 (
found_key
.
ty≥
 !
BTRFS_INODE_REF_KEY
 &&

2042 
found_key
.
ty≥
 !
BTRFS_INODE_EXTREF_KEY
)) {

2043 
ªt
 = -
ENOENT
;

2044 
out
;

2047 i‡(
found_key
.
ty≥
 =
BTRFS_INODE_REF_KEY
) {

2048 
båfs_öode_ªf
 *
úef
;

2049 
úef
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

2050 
båfs_öode_ªf
);

2051 
Àn
 = 
	`båfs_öode_ªf_«me_Àn
(
∑th
->
nodes
[0], 
úef
);

2052 
ªt
 = 
	`fs_∑th_add_‰om_exã¡_buf„r
(
«me
, 
∑th
->
nodes
[0],

2053 ()(
úef
 + 1),

2054 
Àn
);

2055 
∑ª¡_dú
 = 
found_key
.
off£t
;

2057 
båfs_öode_exåef
 *
exåef
;

2058 
exåef
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

2059 
båfs_öode_exåef
);

2060 
Àn
 = 
	`båfs_öode_exåef_«me_Àn
(
∑th
->
nodes
[0], 
exåef
);

2061 
ªt
 = 
	`fs_∑th_add_‰om_exã¡_buf„r
(
«me
, 
∑th
->
nodes
[0],

2062 ()&
exåef
->
«me
, 
Àn
);

2063 
∑ª¡_dú
 = 
	`båfs_öode_exåef_∑ª¡
(
∑th
->
nodes
[0], 
exåef
);

2065 i‡(
ªt
 < 0)

2066 
out
;

2067 
	`båfs_ªÀa£_∑th
(
∑th
);

2069 i‡(
dú_gí
) {

2070 
ªt
 = 
	`gë_öode_gí
(
roŸ
, 
∑ª¡_dú
, 
dú_gí
);

2071 i‡(
ªt
 < 0)

2072 
out
;

2075 *
dú
 = 
∑ª¡_dú
;

2077 
out
:

2078 
	`båfs_‰ì_∑th
(
∑th
);

2079  
ªt
;

2080 
	}
}

2082 
	$is_fú°_ªf
(
båfs_roŸ
 *
roŸ
,

2083 
u64
 
öo
, u64 
dú
,

2084 c⁄° *
«me
, 
«me_Àn
)

2086 
ªt
;

2087 
fs_∑th
 *
tmp_«me
;

2088 
u64
 
tmp_dú
;

2090 
tmp_«me
 = 
	`fs_∑th_Æloc
();

2091 i‡(!
tmp_«me
)

2092  -
ENOMEM
;

2094 
ªt
 = 
	`gë_fú°_ªf
(
roŸ
, 
öo
, &
tmp_dú
, 
NULL
, 
tmp_«me
);

2095 i‡(
ªt
 < 0)

2096 
out
;

2098 i‡(
dú
 !
tmp_dú
 || 
«me_Àn
 !
	`fs_∑th_Àn
(
tmp_«me
)) {

2099 
ªt
 = 0;

2100 
out
;

2103 
ªt
 = !
	`memcmp
(
tmp_«me
->
°¨t
, 
«me
, 
«me_Àn
);

2105 
out
:

2106 
	`fs_∑th_‰ì
(
tmp_«me
);

2107  
ªt
;

2108 
	}
}

2120 
	$wûl_ovîwrôe_ªf
(
£nd_˘x
 *
s˘x
, 
u64
 
dú
, u64 
dú_gí
,

2121 c⁄° *
«me
, 
«me_Àn
,

2122 
u64
 *
who_öo
, u64 *
who_gí
, u64 *
who_mode
)

2124 
ªt
;

2125 
u64
 
∑ª¡_roŸ_dú_gí
;

2126 
u64
 
Ÿhî_öode
 = 0;

2127 
båfs_öode_öfo
 
öfo
;

2129 i‡(!
s˘x
->
∑ª¡_roŸ
)

2132 
ªt
 = 
	`is_öode_exi°ít
(
s˘x
, 
dú
, 
dú_gí
, 
NULL
, &
∑ª¡_roŸ_dú_gí
);

2133 i‡(
ªt
 <= 0)

2144 i‡(
s˘x
->
∑ª¡_roŸ
 && 
dú
 !
BTRFS_FIRST_FREE_OBJECTID
 &&

2145 
∑ª¡_roŸ_dú_gí
 !
dú_gí
)

2148 
ªt
 = 
	`lookup_dú_ôem_öode
(
s˘x
->
∑ª¡_roŸ
, 
dú
, 
«me
, 
«me_Àn
,

2149 &
Ÿhî_öode
);

2150 i‡(
ªt
 =-
ENOENT
)

2152 i‡(
ªt
 < 0)

2153  
ªt
;

2160 i‡(
Ÿhî_öode
 > 
s˘x
->
£nd_¥ogªss
 ||

2161 
	`is_waôög_f‹_move
(
s˘x
, 
Ÿhî_öode
)) {

2162 
ªt
 = 
	`gë_öode_öfo
(
s˘x
->
∑ª¡_roŸ
, 
Ÿhî_öode
, &
öfo
);

2163 i‡(
ªt
 < 0)

2164  
ªt
;

2166 *
who_öo
 = 
Ÿhî_öode
;

2167 *
who_gí
 = 
öfo
.
gí
;

2168 *
who_mode
 = 
öfo
.
mode
;

2173 
	}
}

2182 
	$did_ovîwrôe_ªf
(
£nd_˘x
 *
s˘x
,

2183 
u64
 
dú
, u64 
dú_gí
,

2184 
u64
 
öo
, u64 
öo_gí
,

2185 c⁄° *
«me
, 
«me_Àn
)

2187 
ªt
;

2188 
u64
 
ow_öode
;

2189 
u64
 
ow_gí
 = 0;

2190 
u64
 
£nd_roŸ_dú_gí
;

2192 i‡(!
s˘x
->
∑ª¡_roŸ
)

2195 
ªt
 = 
	`is_öode_exi°ít
(
s˘x
, 
dú
, 
dú_gí
, &
£nd_roŸ_dú_gí
, 
NULL
);

2196 i‡(
ªt
 <= 0)

2197  
ªt
;

2203 i‡(
dú
 !
BTRFS_FIRST_FREE_OBJECTID
 && 
£nd_roŸ_dú_gí
 !
dú_gí
)

2207 
ªt
 = 
	`lookup_dú_ôem_öode
(
s˘x
->
£nd_roŸ
, 
dú
, 
«me
, 
«me_Àn
,

2208 &
ow_öode
);

2209 i‡(
ªt
 =-
ENOENT
) {

2212 } i‡(
ªt
 < 0) {

2213  
ªt
;

2216 i‡(
ow_öode
 =
öo
) {

2217 
ªt
 = 
	`gë_öode_gí
(
s˘x
->
£nd_roŸ
, 
ow_öode
, &
ow_gí
);

2218 i‡(
ªt
 < 0)

2219  
ªt
;

2222 i‡(
ow_gí
 =
öo_gí
)

2232 i‡(
ow_öode
 < 
s˘x
->
£nd_¥ogªss
)

2235 i‡(
öo
 !
s˘x
->
cur_öo
 && 
ow_öode
 == sctx->cur_ino) {

2236 i‡(
ow_gí
 == 0) {

2237 
ªt
 = 
	`gë_öode_gí
(
s˘x
->
£nd_roŸ
, 
ow_öode
, &
ow_gí
);

2238 i‡(
ªt
 < 0)

2239  
ªt
;

2241 i‡(
ow_gí
 =
s˘x
->
cur_öode_gí
)

2246 
	}
}

2253 
	$did_ovîwrôe_fú°_ªf
(
£nd_˘x
 *
s˘x
, 
u64
 
öo
, u64 
gí
)

2255 
ªt
 = 0;

2256 
fs_∑th
 *
«me
 = 
NULL
;

2257 
u64
 
dú
;

2258 
u64
 
dú_gí
;

2260 i‡(!
s˘x
->
∑ª¡_roŸ
)

2261 
out
;

2263 
«me
 = 
	`fs_∑th_Æloc
();

2264 i‡(!
«me
)

2265  -
ENOMEM
;

2267 
ªt
 = 
	`gë_fú°_ªf
(
s˘x
->
∑ª¡_roŸ
, 
öo
, &
dú
, &
dú_gí
, 
«me
);

2268 i‡(
ªt
 < 0)

2269 
out
;

2271 
ªt
 = 
	`did_ovîwrôe_ªf
(
s˘x
, 
dú
, 
dú_gí
, 
öo
, 
gí
,

2272 
«me
->
°¨t
, 
	`fs_∑th_Àn
(name));

2274 
out
:

2275 
	`fs_∑th_‰ì
(
«me
);

2276  
ªt
;

2277 
	}
}

2279 
ölöe
 
«me_ˇche_íåy
 *
	$«me_ˇche_£¨ch
(
£nd_˘x
 *
s˘x
,

2280 
u64
 
öo
, u64 
gí
)

2282 
båfs_Ãu_ˇche_íåy
 *
íåy
;

2284 
íåy
 = 
	`båfs_Ãu_ˇche_lookup
(&
s˘x
->
«me_ˇche
, 
öo
, 
gí
);

2285 i‡(!
íåy
)

2286  
NULL
;

2288  
	`c⁄èöî_of
(
íåy
, 
«me_ˇche_íåy
,Éntry);

2289 
	}
}

2299 
	$__gë_cur_«me_™d_∑ª¡
(
£nd_˘x
 *
s˘x
,

2300 
u64
 
öo
, u64 
gí
,

2301 
u64
 *
∑ª¡_öo
,

2302 
u64
 *
∑ª¡_gí
,

2303 
fs_∑th
 *
de°
)

2305 
ªt
;

2306 
n˚_ªt
;

2307 
«me_ˇche_íåy
 *
n˚
;

2314 
n˚
 = 
	`«me_ˇche_£¨ch
(
s˘x
, 
öo
, 
gí
);

2315 i‡(
n˚
) {

2316 i‡(
öo
 < 
s˘x
->
£nd_¥ogªss
 && 
n˚
->
√ed_œãr_upd©e
) {

2317 
	`båfs_Ãu_ˇche_ªmove
(&
s˘x
->
«me_ˇche
, &
n˚
->
íåy
);

2318 
n˚
 = 
NULL
;

2320 *
∑ª¡_öo
 = 
n˚
->parent_ino;

2321 *
∑ª¡_gí
 = 
n˚
->parent_gen;

2322 
ªt
 = 
	`fs_∑th_add
(
de°
, 
n˚
->
«me
,Ç˚->
«me_Àn
);

2323 i‡(
ªt
 < 0)

2324 
out
;

2325 
ªt
 = 
n˚
->ret;

2326 
out
;

2335 
ªt
 = 
	`is_öode_exi°ít
(
s˘x
, 
öo
, 
gí
, 
NULL
, NULL);

2336 i‡(
ªt
 < 0)

2337 
out
;

2339 i‡(!
ªt
) {

2340 
ªt
 = 
	`gí_unique_«me
(
s˘x
, 
öo
, 
gí
, 
de°
);

2341 i‡(
ªt
 < 0)

2342 
out
;

2343 
ªt
 = 1;

2344 
out_ˇche
;

2351 i‡(
öo
 < 
s˘x
->
£nd_¥ogªss
)

2352 
ªt
 = 
	`gë_fú°_ªf
(
s˘x
->
£nd_roŸ
, 
öo
,

2353 
∑ª¡_öo
, 
∑ª¡_gí
, 
de°
);

2355 
ªt
 = 
	`gë_fú°_ªf
(
s˘x
->
∑ª¡_roŸ
, 
öo
,

2356 
∑ª¡_öo
, 
∑ª¡_gí
, 
de°
);

2357 i‡(
ªt
 < 0)

2358 
out
;

2364 
ªt
 = 
	`did_ovîwrôe_ªf
(
s˘x
, *
∑ª¡_öo
, *
∑ª¡_gí
, 
öo
, 
gí
,

2365 
de°
->
°¨t
, de°->
íd
 - dest->start);

2366 i‡(
ªt
 < 0)

2367 
out
;

2368 i‡(
ªt
) {

2369 
	`fs_∑th_ª£t
(
de°
);

2370 
ªt
 = 
	`gí_unique_«me
(
s˘x
, 
öo
, 
gí
, 
de°
);

2371 i‡(
ªt
 < 0)

2372 
out
;

2373 
ªt
 = 1;

2376 
out_ˇche
:

2380 
n˚
 = 
	`kmÆloc
((*n˚Ë+ 
	`fs_∑th_Àn
(
de°
Ë+ 1, 
GFP_KERNEL
);

2381 i‡(!
n˚
) {

2382 
ªt
 = -
ENOMEM
;

2383 
out
;

2386 
n˚
->
íåy
.
key
 = 
öo
;

2387 
n˚
->
íåy
.
gí
 = gen;

2388 
n˚
->
∑ª¡_öo
 = *parent_ino;

2389 
n˚
->
∑ª¡_gí
 = *parent_gen;

2390 
n˚
->
«me_Àn
 = 
	`fs_∑th_Àn
(
de°
);

2391 
n˚
->
ªt
 =Ñet;

2392 
	`°r˝y
(
n˚
->
«me
, 
de°
->
°¨t
);

2394 i‡(
öo
 < 
s˘x
->
£nd_¥ogªss
)

2395 
n˚
->
√ed_œãr_upd©e
 = 0;

2397 
n˚
->
√ed_œãr_upd©e
 = 1;

2399 
n˚_ªt
 = 
	`båfs_Ãu_ˇche_°‹e
(&
s˘x
->
«me_ˇche
, &
n˚
->
íåy
, 
GFP_KERNEL
);

2400 i‡(
n˚_ªt
 < 0) {

2401 
	`k‰ì
(
n˚
);

2402 
ªt
 = 
n˚_ªt
;

2405 
out
:

2406  
ªt
;

2407 
	}
}

2434 
	$gë_cur_∑th
(
£nd_˘x
 *
s˘x
, 
u64
 
öo
, u64 
gí
,

2435 
fs_∑th
 *
de°
)

2437 
ªt
 = 0;

2438 
fs_∑th
 *
«me
 = 
NULL
;

2439 
u64
 
∑ª¡_öode
 = 0;

2440 
u64
 
∑ª¡_gí
 = 0;

2441 
°›
 = 0;

2443 
«me
 = 
	`fs_∑th_Æloc
();

2444 i‡(!
«me
) {

2445 
ªt
 = -
ENOMEM
;

2446 
out
;

2449 
de°
->
ªvî£d
 = 1;

2450 
	`fs_∑th_ª£t
(
de°
);

2452 !
°›
 && 
öo
 !
BTRFS_FIRST_FREE_OBJECTID
) {

2453 
waôög_dú_move
 *
wdm
;

2455 
	`fs_∑th_ª£t
(
«me
);

2457 i‡(
	`is_waôög_f‹_rm
(
s˘x
, 
öo
, 
gí
)) {

2458 
ªt
 = 
	`gí_unique_«me
(
s˘x
, 
öo
, 
gí
, 
«me
);

2459 i‡(
ªt
 < 0)

2460 
out
;

2461 
ªt
 = 
	`fs_∑th_add_∑th
(
de°
, 
«me
);

2465 
wdm
 = 
	`gë_waôög_dú_move
(
s˘x
, 
öo
);

2466 i‡(
wdm
 && wdm->
‹ph™ized
) {

2467 
ªt
 = 
	`gí_unique_«me
(
s˘x
, 
öo
, 
gí
, 
«me
);

2468 
°›
 = 1;

2469 } i‡(
wdm
) {

2470 
ªt
 = 
	`gë_fú°_ªf
(
s˘x
->
∑ª¡_roŸ
, 
öo
,

2471 &
∑ª¡_öode
, &
∑ª¡_gí
, 
«me
);

2473 
ªt
 = 
	`__gë_cur_«me_™d_∑ª¡
(
s˘x
, 
öo
, 
gí
,

2474 &
∑ª¡_öode
,

2475 &
∑ª¡_gí
, 
«me
);

2476 i‡(
ªt
)

2477 
°›
 = 1;

2480 i‡(
ªt
 < 0)

2481 
out
;

2483 
ªt
 = 
	`fs_∑th_add_∑th
(
de°
, 
«me
);

2484 i‡(
ªt
 < 0)

2485 
out
;

2487 
öo
 = 
∑ª¡_öode
;

2488 
gí
 = 
∑ª¡_gí
;

2491 
out
:

2492 
	`fs_∑th_‰ì
(
«me
);

2493 i‡(!
ªt
)

2494 
	`fs_∑th_uƒevî£
(
de°
);

2495  
ªt
;

2496 
	}
}

2501 
	$£nd_subvﬁ_begö
(
£nd_˘x
 *
s˘x
)

2503 
ªt
;

2504 
båfs_roŸ
 *
£nd_roŸ
 = 
s˘x
->send_root;

2505 
båfs_roŸ
 *
∑ª¡_roŸ
 = 
s˘x
->parent_root;

2506 
båfs_∑th
 *
∑th
;

2507 
båfs_key
 
key
;

2508 
båfs_roŸ_ªf
 *
ªf
;

2509 
exã¡_buf„r
 *
Àaf
;

2510 *
«me
 = 
NULL
;

2511 
«mñí
;

2513 
∑th
 = 
	`båfs_Æloc_∑th
();

2514 i‡(!
∑th
)

2515  -
ENOMEM
;

2517 
«me
 = 
	`kmÆloc
(
BTRFS_PATH_NAME_MAX
, 
GFP_KERNEL
);

2518 i‡(!
«me
) {

2519 
	`båfs_‰ì_∑th
(
∑th
);

2520  -
ENOMEM
;

2523 
key
.
obje˘id
 = 
£nd_roŸ
->
roŸ_key
.objectid;

2524 
key
.
ty≥
 = 
BTRFS_ROOT_BACKREF_KEY
;

2525 
key
.
off£t
 = 0;

2527 
ªt
 = 
	`båfs_£¨ch_¶Ÿ_f‹_ªad
(
£nd_roŸ
->
fs_öfo
->
åì_roŸ
,

2528 &
key
, 
∑th
, 1, 0);

2529 i‡(
ªt
 < 0)

2530 
out
;

2531 i‡(
ªt
) {

2532 
ªt
 = -
ENOENT
;

2533 
out
;

2536 
Àaf
 = 
∑th
->
nodes
[0];

2537 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

2538 i‡(
key
.
ty≥
 !
BTRFS_ROOT_BACKREF_KEY
 ||

2539 
key
.
obje˘id
 !
£nd_roŸ
->
roŸ_key
.objectid) {

2540 
ªt
 = -
ENOENT
;

2541 
out
;

2543 
ªf
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_roŸ_ªf
);

2544 
«mñí
 = 
	`båfs_roŸ_ªf_«me_Àn
(
Àaf
, 
ªf
);

2545 
	`ªad_exã¡_buf„r
(
Àaf
, 
«me
, ()(
ªf
 + 1), 
«mñí
);

2546 
	`båfs_ªÀa£_∑th
(
∑th
);

2548 i‡(
∑ª¡_roŸ
) {

2549 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_SNAPSHOT
);

2550 i‡(
ªt
 < 0)

2551 
out
;

2553 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_SUBVOL
);

2554 i‡(
ªt
 < 0)

2555 
out
;

2558 
	`TLV_PUT_STRING
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
«me
, 
«mñí
);

2560 i‡(!
	`båfs_is_em±y_uuid
(
s˘x
->
£nd_roŸ
->
roŸ_ôem
.
ª˚ived_uuid
))

2561 
	`TLV_PUT_UUID
(
s˘x
, 
BTRFS_SEND_A_UUID
,

2562 
s˘x
->
£nd_roŸ
->
roŸ_ôem
.
ª˚ived_uuid
);

2564 
	`TLV_PUT_UUID
(
s˘x
, 
BTRFS_SEND_A_UUID
,

2565 
s˘x
->
£nd_roŸ
->
roŸ_ôem
.
uuid
);

2567 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_CTRANSID
,

2568 
	`båfs_roŸ_˘ønsid
(&
s˘x
->
£nd_roŸ
->
roŸ_ôem
));

2569 i‡(
∑ª¡_roŸ
) {

2570 i‡(!
	`båfs_is_em±y_uuid
(
∑ª¡_roŸ
->
roŸ_ôem
.
ª˚ived_uuid
))

2571 
	`TLV_PUT_UUID
(
s˘x
, 
BTRFS_SEND_A_CLONE_UUID
,

2572 
∑ª¡_roŸ
->
roŸ_ôem
.
ª˚ived_uuid
);

2574 
	`TLV_PUT_UUID
(
s˘x
, 
BTRFS_SEND_A_CLONE_UUID
,

2575 
∑ª¡_roŸ
->
roŸ_ôem
.
uuid
);

2576 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_CLONE_CTRANSID
,

2577 
	`båfs_roŸ_˘ønsid
(&
s˘x
->
∑ª¡_roŸ
->
roŸ_ôem
));

2580 
ªt
 = 
	`£nd_cmd
(
s˘x
);

2582 
év_put_Áûuª
:

2583 
out
:

2584 
	`båfs_‰ì_∑th
(
∑th
);

2585 
	`k‰ì
(
«me
);

2586  
ªt
;

2587 
	}
}

2589 
	$£nd_åunˇã
(
£nd_˘x
 *
s˘x
, 
u64
 
öo
, u64 
gí
, u64 
size
)

2591 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
£nd_roŸ
->fs_info;

2592 
ªt
 = 0;

2593 
fs_∑th
 *
p
;

2595 
	`båfs_debug
(
fs_öfo
, "£nd_åunˇã %Œu size=%Œu", 
öo
, 
size
);

2597 
p
 = 
	`fs_∑th_Æloc
();

2598 i‡(!
p
)

2599  -
ENOMEM
;

2601 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_TRUNCATE
);

2602 i‡(
ªt
 < 0)

2603 
out
;

2605 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, 
öo
, 
gí
, 
p
);

2606 i‡(
ªt
 < 0)

2607 
out
;

2608 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
p
);

2609 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_SIZE
, 
size
);

2611 
ªt
 = 
	`£nd_cmd
(
s˘x
);

2613 
év_put_Áûuª
:

2614 
out
:

2615 
	`fs_∑th_‰ì
(
p
);

2616  
ªt
;

2617 
	}
}

2619 
	$£nd_chmod
(
£nd_˘x
 *
s˘x
, 
u64
 
öo
, u64 
gí
, u64 
mode
)

2621 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
£nd_roŸ
->fs_info;

2622 
ªt
 = 0;

2623 
fs_∑th
 *
p
;

2625 
	`båfs_debug
(
fs_öfo
, "£nd_chmod %Œu mode=%Œu", 
öo
, 
mode
);

2627 
p
 = 
	`fs_∑th_Æloc
();

2628 i‡(!
p
)

2629  -
ENOMEM
;

2631 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_CHMOD
);

2632 i‡(
ªt
 < 0)

2633 
out
;

2635 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, 
öo
, 
gí
, 
p
);

2636 i‡(
ªt
 < 0)

2637 
out
;

2638 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
p
);

2639 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_MODE
, 
mode
 & 07777);

2641 
ªt
 = 
	`£nd_cmd
(
s˘x
);

2643 
év_put_Áûuª
:

2644 
out
:

2645 
	`fs_∑th_‰ì
(
p
);

2646  
ªt
;

2647 
	}
}

2649 
	$£nd_fûóâr
(
£nd_˘x
 *
s˘x
, 
u64
 
öo
, u64 
gí
, u64 
fûóâr
)

2651 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
£nd_roŸ
->fs_info;

2652 
ªt
 = 0;

2653 
fs_∑th
 *
p
;

2655 i‡(
s˘x
->
¥Ÿo
 < 2)

2658 
	`båfs_debug
(
fs_öfo
, "£nd_fûóâ∏%Œu fûóâr=%Œu", 
öo
, 
fûóâr
);

2660 
p
 = 
	`fs_∑th_Æloc
();

2661 i‡(!
p
)

2662  -
ENOMEM
;

2664 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_FILEATTR
);

2665 i‡(
ªt
 < 0)

2666 
out
;

2668 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, 
öo
, 
gí
, 
p
);

2669 i‡(
ªt
 < 0)

2670 
out
;

2671 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
p
);

2672 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_FILEATTR
, 
fûóâr
);

2674 
ªt
 = 
	`£nd_cmd
(
s˘x
);

2676 
év_put_Áûuª
:

2677 
out
:

2678 
	`fs_∑th_‰ì
(
p
);

2679  
ªt
;

2680 
	}
}

2682 
	$£nd_chown
(
£nd_˘x
 *
s˘x
, 
u64
 
öo
, u64 
gí
, u64 
uid
, u64 
gid
)

2684 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
£nd_roŸ
->fs_info;

2685 
ªt
 = 0;

2686 
fs_∑th
 *
p
;

2688 
	`båfs_debug
(
fs_öfo
, "send_chown %llu uid=%llu, gid=%llu",

2689 
öo
, 
uid
, 
gid
);

2691 
p
 = 
	`fs_∑th_Æloc
();

2692 i‡(!
p
)

2693  -
ENOMEM
;

2695 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_CHOWN
);

2696 i‡(
ªt
 < 0)

2697 
out
;

2699 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, 
öo
, 
gí
, 
p
);

2700 i‡(
ªt
 < 0)

2701 
out
;

2702 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
p
);

2703 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_UID
, 
uid
);

2704 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_GID
, 
gid
);

2706 
ªt
 = 
	`£nd_cmd
(
s˘x
);

2708 
év_put_Áûuª
:

2709 
out
:

2710 
	`fs_∑th_‰ì
(
p
);

2711  
ªt
;

2712 
	}
}

2714 
	$£nd_utimes
(
£nd_˘x
 *
s˘x
, 
u64
 
öo
, u64 
gí
)

2716 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
£nd_roŸ
->fs_info;

2717 
ªt
 = 0;

2718 
fs_∑th
 *
p
 = 
NULL
;

2719 
båfs_öode_ôem
 *
ii
;

2720 
båfs_∑th
 *
∑th
 = 
NULL
;

2721 
exã¡_buf„r
 *
eb
;

2722 
båfs_key
 
key
;

2723 
¶Ÿ
;

2725 
	`båfs_debug
(
fs_öfo
, "£nd_utime†%Œu", 
öo
);

2727 
p
 = 
	`fs_∑th_Æloc
();

2728 i‡(!
p
)

2729  -
ENOMEM
;

2731 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

2732 i‡(!
∑th
) {

2733 
ªt
 = -
ENOMEM
;

2734 
out
;

2737 
key
.
obje˘id
 = 
öo
;

2738 
key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

2739 
key
.
off£t
 = 0;

2740 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
s˘x
->
£nd_roŸ
, &
key
, 
∑th
, 0, 0);

2741 i‡(
ªt
 > 0)

2742 
ªt
 = -
ENOENT
;

2743 i‡(
ªt
 < 0)

2744 
out
;

2746 
eb
 = 
∑th
->
nodes
[0];

2747 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

2748 
ii
 = 
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
, 
båfs_öode_ôem
);

2750 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_UTIMES
);

2751 i‡(
ªt
 < 0)

2752 
out
;

2754 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, 
öo
, 
gí
, 
p
);

2755 i‡(
ªt
 < 0)

2756 
out
;

2757 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
p
);

2758 
	`TLV_PUT_BTRFS_TIMESPEC
(
s˘x
, 
BTRFS_SEND_A_ATIME
, 
eb
, &
ii
->
©ime
);

2759 
	`TLV_PUT_BTRFS_TIMESPEC
(
s˘x
, 
BTRFS_SEND_A_MTIME
, 
eb
, &
ii
->
mtime
);

2760 
	`TLV_PUT_BTRFS_TIMESPEC
(
s˘x
, 
BTRFS_SEND_A_CTIME
, 
eb
, &
ii
->
˘ime
);

2761 i‡(
s˘x
->
¥Ÿo
 >= 2)

2762 
	`TLV_PUT_BTRFS_TIMESPEC
(
s˘x
, 
BTRFS_SEND_A_OTIME
, 
eb
, &
ii
->
Ÿime
);

2764 
ªt
 = 
	`£nd_cmd
(
s˘x
);

2766 
év_put_Áûuª
:

2767 
out
:

2768 
	`fs_∑th_‰ì
(
p
);

2769 
	`båfs_‰ì_∑th
(
∑th
);

2770  
ªt
;

2771 
	}
}

2783 
	$ˇche_dú_utimes
(
£nd_˘x
 *
s˘x
, 
u64
 
dú
, u64 
gí
)

2785 
båfs_Ãu_ˇche_íåy
 *
íåy
;

2786 
ªt
;

2788 
íåy
 = 
	`båfs_Ãu_ˇche_lookup
(&
s˘x
->
dú_utimes_ˇche
, 
dú
, 
gí
);

2789 i‡(
íåy
 !
NULL
)

2793 
íåy
 = 
	`kmÆloc
((*íåy), 
GFP_KERNEL
);

2794 i‡(!
íåy
)

2795  
	`£nd_utimes
(
s˘x
, 
dú
, 
gí
);

2797 
íåy
->
key
 = 
dú
;

2798 
íåy
->
gí
 = gen;

2800 
ªt
 = 
	`båfs_Ãu_ˇche_°‹e
(&
s˘x
->
dú_utimes_ˇche
, 
íåy
, 
GFP_KERNEL
);

2801 
	`ASSERT
(
ªt
 !-
EEXIST
);

2802 i‡(
ªt
) {

2803 
	`k‰ì
(
íåy
);

2804  
	`£nd_utimes
(
s˘x
, 
dú
, 
gí
);

2808 
	}
}

2810 
	$åim_dú_utimes_ˇche
(
£nd_˘x
 *
s˘x
)

2812 
	`båfs_Ãu_ˇche_size
(&
s˘x
->
dú_utimes_ˇche
) >

2813 
SEND_MAX_DIR_UTIMES_CACHE_SIZE
) {

2814 
båfs_Ãu_ˇche_íåy
 *
Ãu
;

2815 
ªt
;

2817 
Ãu
 = 
	`båfs_Ãu_ˇche_Ãu_íåy
(&
s˘x
->
dú_utimes_ˇche
);

2818 
	`ASSERT
(
Ãu
 !
NULL
);

2820 
ªt
 = 
	`£nd_utimes
(
s˘x
, 
Ãu
->
key
,Üru->
gí
);

2821 i‡(
ªt
)

2822  
ªt
;

2824 
	`båfs_Ãu_ˇche_ªmove
(&
s˘x
->
dú_utimes_ˇche
, 
Ãu
);

2828 
	}
}

2835 
	$£nd_¸óã_öode
(
£nd_˘x
 *
s˘x
, 
u64
 
öo
)

2837 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
£nd_roŸ
->fs_info;

2838 
ªt
 = 0;

2839 
fs_∑th
 *
p
;

2840 
cmd
;

2841 
båfs_öode_öfo
 
öfo
;

2842 
u64
 
gí
;

2843 
u64
 
mode
;

2844 
u64
 
rdev
;

2846 
	`båfs_debug
(
fs_öfo
, "£nd_¸óã_öodê%Œu", 
öo
);

2848 
p
 = 
	`fs_∑th_Æloc
();

2849 i‡(!
p
)

2850  -
ENOMEM
;

2852 i‡(
öo
 !
s˘x
->
cur_öo
) {

2853 
ªt
 = 
	`gë_öode_öfo
(
s˘x
->
£nd_roŸ
, 
öo
, &
öfo
);

2854 i‡(
ªt
 < 0)

2855 
out
;

2856 
gí
 = 
öfo
.gen;

2857 
mode
 = 
öfo
.mode;

2858 
rdev
 = 
öfo
.rdev;

2860 
gí
 = 
s˘x
->
cur_öode_gí
;

2861 
mode
 = 
s˘x
->
cur_öode_mode
;

2862 
rdev
 = 
s˘x
->
cur_öode_rdev
;

2865 i‡(
	`S_ISREG
(
mode
)) {

2866 
cmd
 = 
BTRFS_SEND_C_MKFILE
;

2867 } i‡(
	`S_ISDIR
(
mode
)) {

2868 
cmd
 = 
BTRFS_SEND_C_MKDIR
;

2869 } i‡(
	`S_ISLNK
(
mode
)) {

2870 
cmd
 = 
BTRFS_SEND_C_SYMLINK
;

2871 } i‡(
	`S_ISCHR
(
mode
Ë|| 
	`S_ISBLK
(mode)) {

2872 
cmd
 = 
BTRFS_SEND_C_MKNOD
;

2873 } i‡(
	`S_ISFIFO
(
mode
)) {

2874 
cmd
 = 
BTRFS_SEND_C_MKFIFO
;

2875 } i‡(
	`S_ISSOCK
(
mode
)) {

2876 
cmd
 = 
BTRFS_SEND_C_MKSOCK
;

2878 
	`båfs_w¨n
(
s˘x
->
£nd_roŸ
->
fs_öfo
, "unexpected inodeÅype %o",

2879 ()(
mode
 & 
S_IFMT
));

2880 
ªt
 = -
EOPNOTSUPP
;

2881 
out
;

2884 
ªt
 = 
	`begö_cmd
(
s˘x
, 
cmd
);

2885 i‡(
ªt
 < 0)

2886 
out
;

2888 
ªt
 = 
	`gí_unique_«me
(
s˘x
, 
öo
, 
gí
, 
p
);

2889 i‡(
ªt
 < 0)

2890 
out
;

2892 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
p
);

2893 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_INO
, 
öo
);

2895 i‡(
	`S_ISLNK
(
mode
)) {

2896 
	`fs_∑th_ª£t
(
p
);

2897 
ªt
 = 
	`ªad_symlök
(
s˘x
->
£nd_roŸ
, 
öo
, 
p
);

2898 i‡(
ªt
 < 0)

2899 
out
;

2900 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH_LINK
, 
p
);

2901 } i‡(
	`S_ISCHR
(
mode
Ë|| 
	`S_ISBLK
(mode) ||

2902 
	`S_ISFIFO
(
mode
Ë|| 
	`S_ISSOCK
(mode)) {

2903 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_RDEV
, 
	`√w_ícode_dev
(
rdev
));

2904 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_MODE
, 
mode
);

2907 
ªt
 = 
	`£nd_cmd
(
s˘x
);

2908 i‡(
ªt
 < 0)

2909 
out
;

2912 
év_put_Áûuª
:

2913 
out
:

2914 
	`fs_∑th_‰ì
(
p
);

2915  
ªt
;

2916 
	}
}

2918 
	$ˇche_dú_¸óãd
(
£nd_˘x
 *
s˘x
, 
u64
 
dú
)

2920 
båfs_Ãu_ˇche_íåy
 *
íåy
;

2921 
ªt
;

2924 
íåy
 = 
	`kmÆloc
((*íåy), 
GFP_KERNEL
);

2925 i‡(!
íåy
)

2928 
íåy
->
key
 = 
dú
;

2929 
íåy
->
gí
 = 0;

2930 
ªt
 = 
	`båfs_Ãu_ˇche_°‹e
(&
s˘x
->
dú_¸óãd_ˇche
, 
íåy
, 
GFP_KERNEL
);

2931 i‡(
ªt
 < 0)

2932 
	`k‰ì
(
íåy
);

2933 
	}
}

2940 
	$did_¸óã_dú
(
£nd_˘x
 *
s˘x
, 
u64
 
dú
)

2942 
ªt
 = 0;

2943 
ôî_ªt
 = 0;

2944 
båfs_∑th
 *
∑th
 = 
NULL
;

2945 
båfs_key
 
key
;

2946 
båfs_key
 
found_key
;

2947 
båfs_key
 
di_key
;

2948 
båfs_dú_ôem
 *
di
;

2950 i‡(
	`båfs_Ãu_ˇche_lookup
(&
s˘x
->
dú_¸óãd_ˇche
, 
dú
, 0))

2953 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

2954 i‡(!
∑th
)

2955  -
ENOMEM
;

2957 
key
.
obje˘id
 = 
dú
;

2958 
key
.
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

2959 
key
.
off£t
 = 0;

2961 
	`båfs_f‹_óch_¶Ÿ
(
s˘x
->
£nd_roŸ
, &
key
, &
found_key
, 
∑th
, 
ôî_ªt
) {

2962 
exã¡_buf„r
 *
eb
 = 
∑th
->
nodes
[0];

2964 i‡(
found_key
.
obje˘id
 !
key
.objectid ||

2965 
found_key
.
ty≥
 !
key
.type) {

2966 
ªt
 = 0;

2970 
di
 = 
	`båfs_ôem_±r
(
eb
, 
∑th
->
¶Ÿs
[0], 
båfs_dú_ôem
);

2971 
	`båfs_dú_ôem_key_to_˝u
(
eb
, 
di
, &
di_key
);

2973 i‡(
di_key
.
ty≥
 !
BTRFS_ROOT_ITEM_KEY
 &&

2974 
di_key
.
obje˘id
 < 
s˘x
->
£nd_¥ogªss
) {

2975 
ªt
 = 1;

2976 
	`ˇche_dú_¸óãd
(
s˘x
, 
dú
);

2981 i‡(
ôî_ªt
 < 0)

2982 
ªt
 = 
ôî_ªt
;

2984 
	`båfs_‰ì_∑th
(
∑th
);

2985  
ªt
;

2986 
	}
}

2994 
	$£nd_¸óã_öode_if_√eded
(
£nd_˘x
 *
s˘x
)

2996 
ªt
;

2998 i‡(
	`S_ISDIR
(
s˘x
->
cur_öode_mode
)) {

2999 
ªt
 = 
	`did_¸óã_dú
(
s˘x
, s˘x->
cur_öo
);

3000 i‡(
ªt
 < 0)

3001  
ªt
;

3002 i‡(
ªt
 > 0)

3006 
ªt
 = 
	`£nd_¸óã_öode
(
s˘x
, s˘x->
cur_öo
);

3008 i‡(
ªt
 =0 && 
	`S_ISDIR
(
s˘x
->
cur_öode_mode
))

3009 
	`ˇche_dú_¸óãd
(
s˘x
, s˘x->
cur_öo
);

3011  
ªt
;

3012 
	}
}

3014 
	sªc‹ded_ªf
 {

3015 
li°_hód
 
	mli°
;

3016 *
	m«me
;

3017 
fs_∑th
 *
	mfuŒ_∑th
;

3018 
u64
 
	mdú
;

3019 
u64
 
	mdú_gí
;

3020 
	m«me_Àn
;

3021 
rb_node
 
	mnode
;

3022 
rb_roŸ
 *
	mroŸ
;

3025 
ªc‹ded_ªf
 *
	$ªc‹ded_ªf_Æloc
()

3027 
ªc‹ded_ªf
 *
ªf
;

3029 
ªf
 = 
	`kzÆloc
((*ªf), 
GFP_KERNEL
);

3030 i‡(!
ªf
)

3031  
NULL
;

3032 
	`RB_CLEAR_NODE
(&
ªf
->
node
);

3033 
	`INIT_LIST_HEAD
(&
ªf
->
li°
);

3034  
ªf
;

3035 
	}
}

3037 
	$ªc‹ded_ªf_‰ì
(
ªc‹ded_ªf
 *
ªf
)

3039 i‡(!
ªf
)

3041 i‡(!
	`RB_EMPTY_NODE
(&
ªf
->
node
))

3042 
	`rb_îa£
(&
ªf
->
node
,Ñef->
roŸ
);

3043 
	`li°_dñ
(&
ªf
->
li°
);

3044 
	`fs_∑th_‰ì
(
ªf
->
fuŒ_∑th
);

3045 
	`k‰ì
(
ªf
);

3046 
	}
}

3048 
	$£t_ªf_∑th
(
ªc‹ded_ªf
 *
ªf
, 
fs_∑th
 *
∑th
)

3050 
ªf
->
fuŒ_∑th
 = 
∑th
;

3051 
ªf
->
«me
 = (*)
	`kba£«me
‘ef->
fuŒ_∑th
->
°¨t
);

3052 
ªf
->
«me_Àn
 =Ñef->
fuŒ_∑th
->
íd
 -Ñef->
«me
;

3053 
	}
}

3055 
	$dup_ªf
(
ªc‹ded_ªf
 *
ªf
, 
li°_hód
 *
li°
)

3057 
ªc‹ded_ªf
 *
√w
;

3059 
√w
 = 
	`ªc‹ded_ªf_Æloc
();

3060 i‡(!
√w
)

3061  -
ENOMEM
;

3063 
√w
->
dú
 = 
ªf
->dir;

3064 
√w
->
dú_gí
 = 
ªf
->dir_gen;

3065 
	`li°_add_èû
(&
√w
->
li°
,Üist);

3067 
	}
}

3069 
	$__‰ì_ªc‹ded_ªfs
(
li°_hód
 *
hód
)

3071 
ªc‹ded_ªf
 *
cur
;

3073 !
	`li°_em±y
(
hód
)) {

3074 
cur
 = 
	`li°_íåy
(
hód
->
√xt
, 
ªc‹ded_ªf
, 
li°
);

3075 
	`ªc‹ded_ªf_‰ì
(
cur
);

3077 
	}
}

3079 
	$‰ì_ªc‹ded_ªfs
(
£nd_˘x
 *
s˘x
)

3081 
	`__‰ì_ªc‹ded_ªfs
(&
s˘x
->
√w_ªfs
);

3082 
	`__‰ì_ªc‹ded_ªfs
(&
s˘x
->
dñëed_ªfs
);

3083 
	}
}

3090 
	$‹ph™ize_öode
(
£nd_˘x
 *
s˘x
, 
u64
 
öo
, u64 
gí
,

3091 
fs_∑th
 *
∑th
)

3093 
ªt
;

3094 
fs_∑th
 *
‹ph™
;

3096 
‹ph™
 = 
	`fs_∑th_Æloc
();

3097 i‡(!
‹ph™
)

3098  -
ENOMEM
;

3100 
ªt
 = 
	`gí_unique_«me
(
s˘x
, 
öo
, 
gí
, 
‹ph™
);

3101 i‡(
ªt
 < 0)

3102 
out
;

3104 
ªt
 = 
	`£nd_ª«me
(
s˘x
, 
∑th
, 
‹ph™
);

3106 
out
:

3107 
	`fs_∑th_‰ì
(
‹ph™
);

3108  
ªt
;

3109 
	}
}

3111 
‹ph™_dú_öfo
 *
	$add_‹ph™_dú_öfo
(
£nd_˘x
 *
s˘x
,

3112 
u64
 
dú_öo
, u64 
dú_gí
)

3114 
rb_node
 **
p
 = &
s˘x
->
‹ph™_dús
.rb_node;

3115 
rb_node
 *
∑ª¡
 = 
NULL
;

3116 
‹ph™_dú_öfo
 *
íåy
, *
odi
;

3118 *
p
) {

3119 
∑ª¡
 = *
p
;

3120 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
‹ph™_dú_öfo
, 
node
);

3121 i‡(
dú_öo
 < 
íåy
->
öo
)

3122 
p
 = &(*p)->
rb_À·
;

3123 i‡(
dú_öo
 > 
íåy
->
öo
)

3124 
p
 = &(*p)->
rb_right
;

3125 i‡(
dú_gí
 < 
íåy
->
gí
)

3126 
p
 = &(*p)->
rb_À·
;

3127 i‡(
dú_gí
 > 
íåy
->
gí
)

3128 
p
 = &(*p)->
rb_right
;

3130  
íåy
;

3133 
odi
 = 
	`kmÆloc
((*odi), 
GFP_KERNEL
);

3134 i‡(!
odi
)

3135  
	`ERR_PTR
(-
ENOMEM
);

3136 
odi
->
öo
 = 
dú_öo
;

3137 
odi
->
gí
 = 
dú_gí
;

3138 
odi
->
œ°_dú_ödex_off£t
 = 0;

3139 
odi
->
dú_high_£q_öo
 = 0;

3141 
	`rb_lök_node
(&
odi
->
node
, 
∑ª¡
, 
p
);

3142 
	`rb_ö£π_cﬁ‹
(&
odi
->
node
, &
s˘x
->
‹ph™_dús
);

3143  
odi
;

3144 
	}
}

3146 
‹ph™_dú_öfo
 *
	$gë_‹ph™_dú_öfo
(
£nd_˘x
 *
s˘x
,

3147 
u64
 
dú_öo
, u64 
gí
)

3149 
rb_node
 *
n
 = 
s˘x
->
‹ph™_dús
.rb_node;

3150 
‹ph™_dú_öfo
 *
íåy
;

3152 
n
) {

3153 
íåy
 = 
	`rb_íåy
(
n
, 
‹ph™_dú_öfo
, 
node
);

3154 i‡(
dú_öo
 < 
íåy
->
öo
)

3155 
n
 =Ç->
rb_À·
;

3156 i‡(
dú_öo
 > 
íåy
->
öo
)

3157 
n
 =Ç->
rb_right
;

3158 i‡(
gí
 < 
íåy
->gen)

3159 
n
 =Ç->
rb_À·
;

3160 i‡(
gí
 > 
íåy
->gen)

3161 
n
 =Ç->
rb_right
;

3163  
íåy
;

3165  
NULL
;

3166 
	}
}

3168 
	$is_waôög_f‹_rm
(
£nd_˘x
 *
s˘x
, 
u64
 
dú_öo
, u64 
gí
)

3170 
‹ph™_dú_öfo
 *
odi
 = 
	`gë_‹ph™_dú_öfo
(
s˘x
, 
dú_öo
, 
gí
);

3172  
odi
 !
NULL
;

3173 
	}
}

3175 
	$‰ì_‹ph™_dú_öfo
(
£nd_˘x
 *
s˘x
,

3176 
‹ph™_dú_öfo
 *
odi
)

3178 i‡(!
odi
)

3180 
	`rb_îa£
(&
odi
->
node
, &
s˘x
->
‹ph™_dús
);

3181 
	`k‰ì
(
odi
);

3182 
	}
}

3189 
	$ˇn_rmdú
(
£nd_˘x
 *
s˘x
, 
u64
 
dú
, u64 
dú_gí
)

3191 
ªt
 = 0;

3192 
ôî_ªt
 = 0;

3193 
båfs_roŸ
 *
roŸ
 = 
s˘x
->
∑ª¡_roŸ
;

3194 
båfs_∑th
 *
∑th
;

3195 
båfs_key
 
key
;

3196 
båfs_key
 
found_key
;

3197 
båfs_key
 
loc
;

3198 
båfs_dú_ôem
 *
di
;

3199 
‹ph™_dú_öfo
 *
odi
 = 
NULL
;

3200 
u64
 
dú_high_£q_öo
 = 0;

3201 
u64
 
œ°_dú_ödex_off£t
 = 0;

3206 i‡(
dú
 =
BTRFS_FIRST_FREE_OBJECTID
)

3209 
odi
 = 
	`gë_‹ph™_dú_öfo
(
s˘x
, 
dú
, 
dú_gí
);

3210 i‡(
odi
 && 
s˘x
->
cur_öo
 < odi->
dú_high_£q_öo
)

3213 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

3214 i‡(!
∑th
)

3215  -
ENOMEM
;

3217 i‡(!
odi
) {

3226 
key
.
obje˘id
 = 
dú
;

3227 
key
.
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

3228 
key
.
off£t
 = (
u64
)-1;

3230 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

3231 i‡(
ªt
 < 0) {

3232 
out
;

3233 } i‡(
ªt
 > 0) {

3235 
	`ASSERT
(
∑th
->
¶Ÿs
[0] > 0);

3236 i‡(
	`WARN_ON
(
∑th
->
¶Ÿs
[0] == 0)) {

3237 
ªt
 = -
EUCLEAN
;

3238 
out
;

3240 
∑th
->
¶Ÿs
[0]--;

3243 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

3244 i‡(
key
.
obje˘id
 !
dú
 || key.
ty≥
 !
BTRFS_DIR_INDEX_KEY
) {

3246 
ªt
 = 1;

3247 
out
;

3250 
di
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

3251 
båfs_dú_ôem
);

3252 
	`båfs_dú_ôem_key_to_˝u
(
∑th
->
nodes
[0], 
di
, &
loc
);

3253 
dú_high_£q_öo
 = 
loc
.
obje˘id
;

3254 i‡(
s˘x
->
cur_öo
 < 
dú_high_£q_öo
) {

3255 
ªt
 = 0;

3256 
out
;

3259 
	`båfs_ªÀa£_∑th
(
∑th
);

3262 
key
.
obje˘id
 = 
dú
;

3263 
key
.
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

3264 
key
.
off£t
 = (
odi
 ? odi->
œ°_dú_ödex_off£t
 : 0);

3266 
	`båfs_f‹_óch_¶Ÿ
(
roŸ
, &
key
, &
found_key
, 
∑th
, 
ôî_ªt
) {

3267 
waôög_dú_move
 *
dm
;

3269 i‡(
found_key
.
obje˘id
 !
key
.objectid ||

3270 
found_key
.
ty≥
 !
key
.type)

3273 
di
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

3274 
båfs_dú_ôem
);

3275 
	`båfs_dú_ôem_key_to_˝u
(
∑th
->
nodes
[0], 
di
, &
loc
);

3277 
dú_high_£q_öo
 = 
	`max
(dú_high_£q_öo, 
loc
.
obje˘id
);

3278 
œ°_dú_ödex_off£t
 = 
found_key
.
off£t
;

3280 
dm
 = 
	`gë_waôög_dú_move
(
s˘x
, 
loc
.
obje˘id
);

3281 i‡(
dm
) {

3282 
dm
->
rmdú_öo
 = 
dú
;

3283 
dm
->
rmdú_gí
 = 
dú_gí
;

3284 
ªt
 = 0;

3285 
out
;

3288 i‡(
loc
.
obje˘id
 > 
s˘x
->
cur_öo
) {

3289 
ªt
 = 0;

3290 
out
;

3293 i‡(
ôî_ªt
 < 0) {

3294 
ªt
 = 
ôî_ªt
;

3295 
out
;

3297 
	`‰ì_‹ph™_dú_öfo
(
s˘x
, 
odi
);

3299 
ªt
 = 1;

3301 
out
:

3302 
	`båfs_‰ì_∑th
(
∑th
);

3304 i‡(
ªt
)

3305  
ªt
;

3307 i‡(!
odi
) {

3308 
odi
 = 
	`add_‹ph™_dú_öfo
(
s˘x
, 
dú
, 
dú_gí
);

3309 i‡(
	`IS_ERR
(
odi
))

3310  
	`PTR_ERR
(
odi
);

3312 
odi
->
gí
 = 
dú_gí
;

3315 
odi
->
œ°_dú_ödex_off£t
 =Üast_dir_index_offset;

3316 
odi
->
dú_high_£q_öo
 = 
	`max
(odi->dir_high_seq_ino, dir_high_seq_ino);

3319 
	}
}

3321 
	$is_waôög_f‹_move
(
£nd_˘x
 *
s˘x
, 
u64
 
öo
)

3323 
waôög_dú_move
 *
íåy
 = 
	`gë_waôög_dú_move
(
s˘x
, 
öo
);

3325  
íåy
 !
NULL
;

3326 
	}
}

3328 
	$add_waôög_dú_move
(
£nd_˘x
 *
s˘x
, 
u64
 
öo
, 
boﬁ
 
‹ph™ized
)

3330 
rb_node
 **
p
 = &
s˘x
->
waôög_dú_moves
.rb_node;

3331 
rb_node
 *
∑ª¡
 = 
NULL
;

3332 
waôög_dú_move
 *
íåy
, *
dm
;

3334 
dm
 = 
	`kmÆloc
((*dm), 
GFP_KERNEL
);

3335 i‡(!
dm
)

3336  -
ENOMEM
;

3337 
dm
->
öo
 = ino;

3338 
dm
->
rmdú_öo
 = 0;

3339 
dm
->
rmdú_gí
 = 0;

3340 
dm
->
‹ph™ized
 = orphanized;

3342 *
p
) {

3343 
∑ª¡
 = *
p
;

3344 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
waôög_dú_move
, 
node
);

3345 i‡(
öo
 < 
íåy
->ino) {

3346 
p
 = &(*p)->
rb_À·
;

3347 } i‡(
öo
 > 
íåy
->ino) {

3348 
p
 = &(*p)->
rb_right
;

3350 
	`k‰ì
(
dm
);

3351  -
EEXIST
;

3355 
	`rb_lök_node
(&
dm
->
node
, 
∑ª¡
, 
p
);

3356 
	`rb_ö£π_cﬁ‹
(&
dm
->
node
, &
s˘x
->
waôög_dú_moves
);

3358 
	}
}

3360 
waôög_dú_move
 *

3361 
	$gë_waôög_dú_move
(
£nd_˘x
 *
s˘x
, 
u64
 
öo
)

3363 
rb_node
 *
n
 = 
s˘x
->
waôög_dú_moves
.rb_node;

3364 
waôög_dú_move
 *
íåy
;

3366 
n
) {

3367 
íåy
 = 
	`rb_íåy
(
n
, 
waôög_dú_move
, 
node
);

3368 i‡(
öo
 < 
íåy
->ino)

3369 
n
 =Ç->
rb_À·
;

3370 i‡(
öo
 > 
íåy
->ino)

3371 
n
 =Ç->
rb_right
;

3373  
íåy
;

3375  
NULL
;

3376 
	}
}

3378 
	$‰ì_waôög_dú_move
(
£nd_˘x
 *
s˘x
,

3379 
waôög_dú_move
 *
dm
)

3381 i‡(!
dm
)

3383 
	`rb_îa£
(&
dm
->
node
, &
s˘x
->
waôög_dú_moves
);

3384 
	`k‰ì
(
dm
);

3385 
	}
}

3387 
	$add_≥ndög_dú_move
(
£nd_˘x
 *
s˘x
,

3388 
u64
 
öo
,

3389 
u64
 
öo_gí
,

3390 
u64
 
∑ª¡_öo
,

3391 
li°_hód
 *
√w_ªfs
,

3392 
li°_hód
 *
dñëed_ªfs
,

3393 c⁄° 
boﬁ
 
is_‹ph™
)

3395 
rb_node
 **
p
 = &
s˘x
->
≥ndög_dú_moves
.rb_node;

3396 
rb_node
 *
∑ª¡
 = 
NULL
;

3397 
≥ndög_dú_move
 *
íåy
 = 
NULL
, *
pm
;

3398 
ªc‹ded_ªf
 *
cur
;

3399 
exi°s
 = 0;

3400 
ªt
;

3402 
pm
 = 
	`kmÆloc
((*pm), 
GFP_KERNEL
);

3403 i‡(!
pm
)

3404  -
ENOMEM
;

3405 
pm
->
∑ª¡_öo
 =Öarent_ino;

3406 
pm
->
öo
 = ino;

3407 
pm
->
gí
 = 
öo_gí
;

3408 
	`INIT_LIST_HEAD
(&
pm
->
li°
);

3409 
	`INIT_LIST_HEAD
(&
pm
->
upd©e_ªfs
);

3410 
	`RB_CLEAR_NODE
(&
pm
->
node
);

3412 *
p
) {

3413 
∑ª¡
 = *
p
;

3414 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
≥ndög_dú_move
, 
node
);

3415 i‡(
∑ª¡_öo
 < 
íåy
->parent_ino) {

3416 
p
 = &(*p)->
rb_À·
;

3417 } i‡(
∑ª¡_öo
 > 
íåy
->parent_ino) {

3418 
p
 = &(*p)->
rb_right
;

3420 
exi°s
 = 1;

3425 
	`li°_f‹_óch_íåy
(
cur
, 
dñëed_ªfs
, 
li°
) {

3426 
ªt
 = 
	`dup_ªf
(
cur
, &
pm
->
upd©e_ªfs
);

3427 i‡(
ªt
 < 0)

3428 
out
;

3430 
	`li°_f‹_óch_íåy
(
cur
, 
√w_ªfs
, 
li°
) {

3431 
ªt
 = 
	`dup_ªf
(
cur
, &
pm
->
upd©e_ªfs
);

3432 i‡(
ªt
 < 0)

3433 
out
;

3436 
ªt
 = 
	`add_waôög_dú_move
(
s˘x
, 
pm
->
öo
, 
is_‹ph™
);

3437 i‡(
ªt
)

3438 
out
;

3440 i‡(
exi°s
) {

3441 
	`li°_add_èû
(&
pm
->
li°
, &
íåy
->list);

3443 
	`rb_lök_node
(&
pm
->
node
, 
∑ª¡
, 
p
);

3444 
	`rb_ö£π_cﬁ‹
(&
pm
->
node
, &
s˘x
->
≥ndög_dú_moves
);

3446 
ªt
 = 0;

3447 
out
:

3448 i‡(
ªt
) {

3449 
	`__‰ì_ªc‹ded_ªfs
(&
pm
->
upd©e_ªfs
);

3450 
	`k‰ì
(
pm
);

3452  
ªt
;

3453 
	}
}

3455 
≥ndög_dú_move
 *
	$gë_≥ndög_dú_moves
(
£nd_˘x
 *
s˘x
,

3456 
u64
 
∑ª¡_öo
)

3458 
rb_node
 *
n
 = 
s˘x
->
≥ndög_dú_moves
.rb_node;

3459 
≥ndög_dú_move
 *
íåy
;

3461 
n
) {

3462 
íåy
 = 
	`rb_íåy
(
n
, 
≥ndög_dú_move
, 
node
);

3463 i‡(
∑ª¡_öo
 < 
íåy
->parent_ino)

3464 
n
 =Ç->
rb_À·
;

3465 i‡(
∑ª¡_öo
 > 
íåy
->parent_ino)

3466 
n
 =Ç->
rb_right
;

3468  
íåy
;

3470  
NULL
;

3471 
	}
}

3473 
	$∑th_lo›
(
£nd_˘x
 *
s˘x
, 
fs_∑th
 *
«me
,

3474 
u64
 
öo
, u64 
gí
, u64 *
™˚°‹_öo
)

3476 
ªt
 = 0;

3477 
u64
 
∑ª¡_öode
 = 0;

3478 
u64
 
∑ª¡_gí
 = 0;

3479 
u64
 
°¨t_öo
 = 
öo
;

3481 *
™˚°‹_öo
 = 0;

3482 
öo
 !
BTRFS_FIRST_FREE_OBJECTID
) {

3483 
	`fs_∑th_ª£t
(
«me
);

3485 i‡(
	`is_waôög_f‹_rm
(
s˘x
, 
öo
, 
gí
))

3487 i‡(
	`is_waôög_f‹_move
(
s˘x
, 
öo
)) {

3488 i‡(*
™˚°‹_öo
 == 0)

3489 *
™˚°‹_öo
 = 
öo
;

3490 
ªt
 = 
	`gë_fú°_ªf
(
s˘x
->
∑ª¡_roŸ
, 
öo
,

3491 &
∑ª¡_öode
, &
∑ª¡_gí
, 
«me
);

3493 
ªt
 = 
	`__gë_cur_«me_™d_∑ª¡
(
s˘x
, 
öo
, 
gí
,

3494 &
∑ª¡_öode
,

3495 &
∑ª¡_gí
, 
«me
);

3496 i‡(
ªt
 > 0) {

3497 
ªt
 = 0;

3501 i‡(
ªt
 < 0)

3503 i‡(
∑ª¡_öode
 =
°¨t_öo
) {

3504 
ªt
 = 1;

3505 i‡(*
™˚°‹_öo
 == 0)

3506 *
™˚°‹_öo
 = 
öo
;

3509 
öo
 = 
∑ª¡_öode
;

3510 
gí
 = 
∑ª¡_gí
;

3512  
ªt
;

3513 
	}
}

3515 
	$≠∂y_dú_move
(
£nd_˘x
 *
s˘x
, 
≥ndög_dú_move
 *
pm
)

3517 
fs_∑th
 *
‰om_∑th
 = 
NULL
;

3518 
fs_∑th
 *
to_∑th
 = 
NULL
;

3519 
fs_∑th
 *
«me
 = 
NULL
;

3520 
u64
 
‹ig_¥ogªss
 = 
s˘x
->
£nd_¥ogªss
;

3521 
ªc‹ded_ªf
 *
cur
;

3522 
u64
 
∑ª¡_öo
, 
∑ª¡_gí
;

3523 
waôög_dú_move
 *
dm
 = 
NULL
;

3524 
u64
 
rmdú_öo
 = 0;

3525 
u64
 
rmdú_gí
;

3526 
u64
 
™˚°‹
;

3527 
boﬁ
 
is_‹ph™
;

3528 
ªt
;

3530 
«me
 = 
	`fs_∑th_Æloc
();

3531 
‰om_∑th
 = 
	`fs_∑th_Æloc
();

3532 i‡(!
«me
 || !
‰om_∑th
) {

3533 
ªt
 = -
ENOMEM
;

3534 
out
;

3537 
dm
 = 
	`gë_waôög_dú_move
(
s˘x
, 
pm
->
öo
);

3538 
	`ASSERT
(
dm
);

3539 
rmdú_öo
 = 
dm
->rmdir_ino;

3540 
rmdú_gí
 = 
dm
->rmdir_gen;

3541 
is_‹ph™
 = 
dm
->
‹ph™ized
;

3542 
	`‰ì_waôög_dú_move
(
s˘x
, 
dm
);

3544 i‡(
is_‹ph™
) {

3545 
ªt
 = 
	`gí_unique_«me
(
s˘x
, 
pm
->
öo
,

3546 
pm
->
gí
, 
‰om_∑th
);

3548 
ªt
 = 
	`gë_fú°_ªf
(
s˘x
->
∑ª¡_roŸ
, 
pm
->
öo
,

3549 &
∑ª¡_öo
, &
∑ª¡_gí
, 
«me
);

3550 i‡(
ªt
 < 0)

3551 
out
;

3552 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, 
∑ª¡_öo
, 
∑ª¡_gí
,

3553 
‰om_∑th
);

3554 i‡(
ªt
 < 0)

3555 
out
;

3556 
ªt
 = 
	`fs_∑th_add_∑th
(
‰om_∑th
, 
«me
);

3558 i‡(
ªt
 < 0)

3559 
out
;

3561 
s˘x
->
£nd_¥ogªss
 = s˘x->
cur_öo
 + 1;

3562 
ªt
 = 
	`∑th_lo›
(
s˘x
, 
«me
, 
pm
->
öo
,Öm->
gí
, &
™˚°‹
);

3563 i‡(
ªt
 < 0)

3564 
out
;

3565 i‡(
ªt
) {

3566 
	`LIST_HEAD
(
dñëed_ªfs
);

3567 
	`ASSERT
(
™˚°‹
 > 
BTRFS_FIRST_FREE_OBJECTID
);

3568 
ªt
 = 
	`add_≥ndög_dú_move
(
s˘x
, 
pm
->
öo
,Öm->
gí
, 
™˚°‹
,

3569 &
pm
->
upd©e_ªfs
, &
dñëed_ªfs
,

3570 
is_‹ph™
);

3571 i‡(
ªt
 < 0)

3572 
out
;

3573 i‡(
rmdú_öo
) {

3574 
dm
 = 
	`gë_waôög_dú_move
(
s˘x
, 
pm
->
öo
);

3575 
	`ASSERT
(
dm
);

3576 
dm
->
rmdú_öo
 =Ñmdir_ino;

3577 
dm
->
rmdú_gí
 =Ñmdir_gen;

3579 
out
;

3581 
	`fs_∑th_ª£t
(
«me
);

3582 
to_∑th
 = 
«me
;

3583 
«me
 = 
NULL
;

3584 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, 
pm
->
öo
,Öm->
gí
, 
to_∑th
);

3585 i‡(
ªt
 < 0)

3586 
out
;

3588 
ªt
 = 
	`£nd_ª«me
(
s˘x
, 
‰om_∑th
, 
to_∑th
);

3589 i‡(
ªt
 < 0)

3590 
out
;

3592 i‡(
rmdú_öo
) {

3593 
‹ph™_dú_öfo
 *
odi
;

3594 
u64
 
gí
;

3596 
odi
 = 
	`gë_‹ph™_dú_öfo
(
s˘x
, 
rmdú_öo
, 
rmdú_gí
);

3597 i‡(!
odi
) {

3599 
föish
;

3601 
gí
 = 
odi
->gen;

3603 
ªt
 = 
	`ˇn_rmdú
(
s˘x
, 
rmdú_öo
, 
gí
);

3604 i‡(
ªt
 < 0)

3605 
out
;

3606 i‡(!
ªt
)

3607 
föish
;

3609 
«me
 = 
	`fs_∑th_Æloc
();

3610 i‡(!
«me
) {

3611 
ªt
 = -
ENOMEM
;

3612 
out
;

3614 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, 
rmdú_öo
, 
gí
, 
«me
);

3615 i‡(
ªt
 < 0)

3616 
out
;

3617 
ªt
 = 
	`£nd_rmdú
(
s˘x
, 
«me
);

3618 i‡(
ªt
 < 0)

3619 
out
;

3622 
föish
:

3623 
ªt
 = 
	`ˇche_dú_utimes
(
s˘x
, 
pm
->
öo
,Öm->
gí
);

3624 i‡(
ªt
 < 0)

3625 
out
;

3631 
	`li°_f‹_óch_íåy
(
cur
, &
pm
->
upd©e_ªfs
, 
li°
) {

3635 
ªt
 = 
	`gë_öode_öfo
(
s˘x
->
£nd_roŸ
, 
cur
->
dú
, 
NULL
);

3636 i‡(
ªt
 =-
ENOENT
) {

3637 
ªt
 = 0;

3640 i‡(
ªt
 < 0)

3641 
out
;

3643 
ªt
 = 
	`ˇche_dú_utimes
(
s˘x
, 
cur
->
dú
, cur->
dú_gí
);

3644 i‡(
ªt
 < 0)

3645 
out
;

3648 
out
:

3649 
	`fs_∑th_‰ì
(
«me
);

3650 
	`fs_∑th_‰ì
(
‰om_∑th
);

3651 
	`fs_∑th_‰ì
(
to_∑th
);

3652 
s˘x
->
£nd_¥ogªss
 = 
‹ig_¥ogªss
;

3654  
ªt
;

3655 
	}
}

3657 
	$‰ì_≥ndög_move
(
£nd_˘x
 *
s˘x
, 
≥ndög_dú_move
 *
m
)

3659 i‡(!
	`li°_em±y
(&
m
->
li°
))

3660 
	`li°_dñ
(&
m
->
li°
);

3661 i‡(!
	`RB_EMPTY_NODE
(&
m
->
node
))

3662 
	`rb_îa£
(&
m
->
node
, &
s˘x
->
≥ndög_dú_moves
);

3663 
	`__‰ì_ªc‹ded_ªfs
(&
m
->
upd©e_ªfs
);

3664 
	`k‰ì
(
m
);

3665 
	}
}

3667 
	$èû_≠≥nd_≥ndög_moves
(
£nd_˘x
 *
s˘x
,

3668 
≥ndög_dú_move
 *
moves
,

3669 
li°_hód
 *
°ack
)

3671 i‡(
	`li°_em±y
(&
moves
->
li°
)) {

3672 
	`li°_add_èû
(&
moves
->
li°
, 
°ack
);

3674 
	`LIST_HEAD
(
li°
);

3675 
	`li°_•li˚_öô
(&
moves
->
li°
, &list);

3676 
	`li°_add_èû
(&
moves
->
li°
, 
°ack
);

3677 
	`li°_•li˚_èû
(&
li°
, 
°ack
);

3679 i‡(!
	`RB_EMPTY_NODE
(&
moves
->
node
)) {

3680 
	`rb_îa£
(&
moves
->
node
, &
s˘x
->
≥ndög_dú_moves
);

3681 
	`RB_CLEAR_NODE
(&
moves
->
node
);

3683 
	}
}

3685 
	$≠∂y_chûdªn_dú_moves
(
£nd_˘x
 *
s˘x
)

3687 
≥ndög_dú_move
 *
pm
;

3688 
	`LIST_HEAD
(
°ack
);

3689 
u64
 
∑ª¡_öo
 = 
s˘x
->
cur_öo
;

3690 
ªt
 = 0;

3692 
pm
 = 
	`gë_≥ndög_dú_moves
(
s˘x
, 
∑ª¡_öo
);

3693 i‡(!
pm
)

3696 
	`èû_≠≥nd_≥ndög_moves
(
s˘x
, 
pm
, &
°ack
);

3698 !
	`li°_em±y
(&
°ack
)) {

3699 
pm
 = 
	`li°_fú°_íåy
(&
°ack
, 
≥ndög_dú_move
, 
li°
);

3700 
∑ª¡_öo
 = 
pm
->
öo
;

3701 
ªt
 = 
	`≠∂y_dú_move
(
s˘x
, 
pm
);

3702 
	`‰ì_≥ndög_move
(
s˘x
, 
pm
);

3703 i‡(
ªt
)

3704 
out
;

3705 
pm
 = 
	`gë_≥ndög_dú_moves
(
s˘x
, 
∑ª¡_öo
);

3706 i‡(
pm
)

3707 
	`èû_≠≥nd_≥ndög_moves
(
s˘x
, 
pm
, &
°ack
);

3711 
out
:

3712 !
	`li°_em±y
(&
°ack
)) {

3713 
pm
 = 
	`li°_fú°_íåy
(&
°ack
, 
≥ndög_dú_move
, 
li°
);

3714 
	`‰ì_≥ndög_move
(
s˘x
, 
pm
);

3716  
ªt
;

3717 
	}
}

3755 
	$waô_f‹_de°_dú_move
(
£nd_˘x
 *
s˘x
,

3756 
ªc‹ded_ªf
 *
∑ª¡_ªf
,

3757 c⁄° 
boﬁ
 
is_‹ph™
)

3759 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
∑ª¡_roŸ
->fs_info;

3760 
båfs_∑th
 *
∑th
;

3761 
båfs_key
 
key
;

3762 
båfs_key
 
di_key
;

3763 
båfs_dú_ôem
 *
di
;

3764 
u64
 
À·_gí
;

3765 
u64
 
right_gí
;

3766 
ªt
 = 0;

3767 
waôög_dú_move
 *
wdm
;

3769 i‡(
	`RB_EMPTY_ROOT
(&
s˘x
->
waôög_dú_moves
))

3772 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

3773 i‡(!
∑th
)

3774  -
ENOMEM
;

3776 
key
.
obje˘id
 = 
∑ª¡_ªf
->
dú
;

3777 
key
.
ty≥
 = 
BTRFS_DIR_ITEM_KEY
;

3778 
key
.
off£t
 = 
	`båfs_«me_hash
(
∑ª¡_ªf
->
«me
,Ö¨ít_ªf->
«me_Àn
);

3780 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
s˘x
->
∑ª¡_roŸ
, &
key
, 
∑th
, 0, 0);

3781 i‡(
ªt
 < 0) {

3782 
out
;

3783 } i‡(
ªt
 > 0) {

3784 
ªt
 = 0;

3785 
out
;

3788 
di
 = 
	`båfs_m©ch_dú_ôem_«me
(
fs_öfo
, 
∑th
, 
∑ª¡_ªf
->
«me
,

3789 
∑ª¡_ªf
->
«me_Àn
);

3790 i‡(!
di
) {

3791 
ªt
 = 0;

3792 
out
;

3802 
	`båfs_dú_ôem_key_to_˝u
(
∑th
->
nodes
[0], 
di
, &
di_key
);

3803 i‡(
di_key
.
ty≥
 !
BTRFS_INODE_ITEM_KEY
) {

3804 
ªt
 = 0;

3805 
out
;

3808 
ªt
 = 
	`gë_öode_gí
(
s˘x
->
∑ª¡_roŸ
, 
di_key
.
obje˘id
, &
À·_gí
);

3809 i‡(
ªt
 < 0)

3810 
out
;

3811 
ªt
 = 
	`gë_öode_gí
(
s˘x
->
£nd_roŸ
, 
di_key
.
obje˘id
, &
right_gí
);

3812 i‡(
ªt
 < 0) {

3813 i‡(
ªt
 =-
ENOENT
)

3814 
ªt
 = 0;

3815 
out
;

3819 i‡(
right_gí
 !
À·_gí
) {

3820 
ªt
 = 0;

3821 
out
;

3824 
wdm
 = 
	`gë_waôög_dú_move
(
s˘x
, 
di_key
.
obje˘id
);

3825 i‡(
wdm
 && !wdm->
‹ph™ized
) {

3826 
ªt
 = 
	`add_≥ndög_dú_move
(
s˘x
,

3827 
s˘x
->
cur_öo
,

3828 
s˘x
->
cur_öode_gí
,

3829 
di_key
.
obje˘id
,

3830 &
s˘x
->
√w_ªfs
,

3831 &
s˘x
->
dñëed_ªfs
,

3832 
is_‹ph™
);

3833 i‡(!
ªt
)

3834 
ªt
 = 1;

3836 
out
:

3837 
	`båfs_‰ì_∑th
(
∑th
);

3838  
ªt
;

3839 
	}
}

3845 
	$check_öo_ö_∑th
(
båfs_roŸ
 *
roŸ
,

3846 c⁄° 
u64
 
öo1
,

3847 c⁄° 
u64
 
öo1_gí
,

3848 c⁄° 
u64
 
öo2
,

3849 c⁄° 
u64
 
öo2_gí
,

3850 
fs_∑th
 *fs_path)

3852 
u64
 
öo
 = 
öo2
;

3854 i‡(
öo1
 =
öo2
)

3855  
öo1_gí
 =
öo2_gí
;

3857 
öo
 > 
BTRFS_FIRST_FREE_OBJECTID
) {

3858 
u64
 
∑ª¡
;

3859 
u64
 
∑ª¡_gí
;

3860 
ªt
;

3862 
	`fs_∑th_ª£t
(
fs_∑th
);

3863 
ªt
 = 
	`gë_fú°_ªf
(
roŸ
, 
öo
, &
∑ª¡
, &
∑ª¡_gí
, 
fs_∑th
);

3864 i‡(
ªt
 < 0)

3865  
ªt
;

3866 i‡(
∑ª¡
 =
öo1
)

3867  
∑ª¡_gí
 =
öo1_gí
;

3868 
öo
 = 
∑ª¡
;

3871 
	}
}

3878 
	$is_™˚°‹
(
båfs_roŸ
 *
roŸ
,

3879 c⁄° 
u64
 
öo1
,

3880 c⁄° 
u64
 
öo1_gí
,

3881 c⁄° 
u64
 
öo2
,

3882 
fs_∑th
 *fs_path)

3884 
boﬁ
 
‰ì_fs_∑th
 = 
Ál£
;

3885 
ªt
 = 0;

3886 
ôî_ªt
 = 0;

3887 
båfs_∑th
 *
∑th
 = 
NULL
;

3888 
båfs_key
 
key
;

3890 i‡(!
fs_∑th
) {

3891 
fs_∑th
 = 
	`fs_∑th_Æloc
();

3892 i‡(!
fs_∑th
)

3893  -
ENOMEM
;

3894 
‰ì_fs_∑th
 = 
åue
;

3897 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

3898 i‡(!
∑th
) {

3899 
ªt
 = -
ENOMEM
;

3900 
out
;

3903 
key
.
obje˘id
 = 
öo2
;

3904 
key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

3905 
key
.
off£t
 = 0;

3907 
	`båfs_f‹_óch_¶Ÿ
(
roŸ
, &
key
, &key, 
∑th
, 
ôî_ªt
) {

3908 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

3909 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

3910 
u32
 
cur_off£t
 = 0;

3911 
u32
 
ôem_size
;

3913 i‡(
key
.
obje˘id
 !
öo2
)

3915 i‡(
key
.
ty≥
 !
BTRFS_INODE_REF_KEY
 &&

3916 
key
.
ty≥
 !
BTRFS_INODE_EXTREF_KEY
)

3919 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

3920 
cur_off£t
 < 
ôem_size
) {

3921 
u64
 
∑ª¡
;

3922 
u64
 
∑ª¡_gí
;

3924 i‡(
key
.
ty≥
 =
BTRFS_INODE_EXTREF_KEY
) {

3925 
±r
;

3926 
båfs_öode_exåef
 *
exåef
;

3928 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
¶Ÿ
);

3929 
exåef
 = (
båfs_öode_exåef
 *)

3930 (
±r
 + 
cur_off£t
);

3931 
∑ª¡
 = 
	`båfs_öode_exåef_∑ª¡
(
Àaf
,

3932 
exåef
);

3933 
cur_off£t
 +(*
exåef
);

3934 
cur_off£t
 +
	`båfs_öode_exåef_«me_Àn
(
Àaf
,

3935 
exåef
);

3937 
∑ª¡
 = 
key
.
off£t
;

3938 
cur_off£t
 = 
ôem_size
;

3941 
ªt
 = 
	`gë_öode_gí
(
roŸ
, 
∑ª¡
, &
∑ª¡_gí
);

3942 i‡(
ªt
 < 0)

3943 
out
;

3944 
ªt
 = 
	`check_öo_ö_∑th
(
roŸ
, 
öo1
, 
öo1_gí
,

3945 
∑ª¡
, 
∑ª¡_gí
, 
fs_∑th
);

3946 i‡(
ªt
)

3947 
out
;

3950 
ªt
 = 0;

3951 i‡(
ôî_ªt
 < 0)

3952 
ªt
 = 
ôî_ªt
;

3954 
out
:

3955 
	`båfs_‰ì_∑th
(
∑th
);

3956 i‡(
‰ì_fs_∑th
)

3957 
	`fs_∑th_‰ì
(
fs_∑th
);

3958  
ªt
;

3959 
	}
}

3961 
	$waô_f‹_∑ª¡_move
(
£nd_˘x
 *
s˘x
,

3962 
ªc‹ded_ªf
 *
∑ª¡_ªf
,

3963 c⁄° 
boﬁ
 
is_‹ph™
)

3965 
ªt
 = 0;

3966 
u64
 
öo
 = 
∑ª¡_ªf
->
dú
;

3967 
u64
 
öo_gí
 = 
∑ª¡_ªf
->
dú_gí
;

3968 
u64
 
∑ª¡_öo_bef‹e
, 
∑ª¡_öo_a·î
;

3969 
fs_∑th
 *
∑th_bef‹e
 = 
NULL
;

3970 
fs_∑th
 *
∑th_a·î
 = 
NULL
;

3971 
Àn1
, 
Àn2
;

3973 
∑th_a·î
 = 
	`fs_∑th_Æloc
();

3974 
∑th_bef‹e
 = 
	`fs_∑th_Æloc
();

3975 i‡(!
∑th_a·î
 || !
∑th_bef‹e
) {

3976 
ªt
 = -
ENOMEM
;

3977 
out
;

3987 
öo
 > 
BTRFS_FIRST_FREE_OBJECTID
) {

3988 
u64
 
∑ª¡_öo_a·î_gí
;

3990 i‡(
	`is_waôög_f‹_move
(
s˘x
, 
öo
)) {

4001 
ªt
 = 
	`is_™˚°‹
(
s˘x
->
∑ª¡_roŸ
,

4002 
s˘x
->
cur_öo
, s˘x->
cur_öode_gí
,

4003 
öo
, 
∑th_bef‹e
);

4004 i‡(
ªt
)

4008 
	`fs_∑th_ª£t
(
∑th_bef‹e
);

4009 
	`fs_∑th_ª£t
(
∑th_a·î
);

4011 
ªt
 = 
	`gë_fú°_ªf
(
s˘x
->
£nd_roŸ
, 
öo
, &
∑ª¡_öo_a·î
,

4012 &
∑ª¡_öo_a·î_gí
, 
∑th_a·î
);

4013 i‡(
ªt
 < 0)

4014 
out
;

4015 
ªt
 = 
	`gë_fú°_ªf
(
s˘x
->
∑ª¡_roŸ
, 
öo
, &
∑ª¡_öo_bef‹e
,

4016 
NULL
, 
∑th_bef‹e
);

4017 i‡(
ªt
 < 0 &&Ñë !-
ENOENT
) {

4018 
out
;

4019 } i‡(
ªt
 =-
ENOENT
) {

4020 
ªt
 = 0;

4024 
Àn1
 = 
	`fs_∑th_Àn
(
∑th_bef‹e
);

4025 
Àn2
 = 
	`fs_∑th_Àn
(
∑th_a·î
);

4026 i‡(
öo
 > 
s˘x
->
cur_öo
 &&

4027 (
∑ª¡_öo_bef‹e
 !
∑ª¡_öo_a·î
 || 
Àn1
 !
Àn2
 ||

4028 
	`memcmp
(
∑th_bef‹e
->
°¨t
, 
∑th_a·î
->°¨t, 
Àn1
))) {

4029 
u64
 
∑ª¡_öo_gí
;

4031 
ªt
 = 
	`gë_öode_gí
(
s˘x
->
∑ª¡_roŸ
, 
öo
, &
∑ª¡_öo_gí
);

4032 i‡(
ªt
 < 0)

4033 
out
;

4034 i‡(
öo_gí
 =
∑ª¡_öo_gí
) {

4035 
ªt
 = 1;

4039 
öo
 = 
∑ª¡_öo_a·î
;

4040 
öo_gí
 = 
∑ª¡_öo_a·î_gí
;

4043 
out
:

4044 
	`fs_∑th_‰ì
(
∑th_bef‹e
);

4045 
	`fs_∑th_‰ì
(
∑th_a·î
);

4047 i‡(
ªt
 == 1) {

4048 
ªt
 = 
	`add_≥ndög_dú_move
(
s˘x
,

4049 
s˘x
->
cur_öo
,

4050 
s˘x
->
cur_öode_gí
,

4051 
öo
,

4052 &
s˘x
->
√w_ªfs
,

4053 &
s˘x
->
dñëed_ªfs
,

4054 
is_‹ph™
);

4055 i‡(!
ªt
)

4056 
ªt
 = 1;

4059  
ªt
;

4060 
	}
}

4062 
	$upd©e_ªf_∑th
(
£nd_˘x
 *
s˘x
, 
ªc‹ded_ªf
 *
ªf
)

4064 
ªt
;

4065 
fs_∑th
 *
√w_∑th
;

4071 
√w_∑th
 = 
	`fs_∑th_Æloc
();

4072 i‡(!
√w_∑th
)

4073  -
ENOMEM
;

4075 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, 
ªf
->
dú
,Ñef->
dú_gí
, 
√w_∑th
);

4076 i‡(
ªt
 < 0) {

4077 
	`fs_∑th_‰ì
(
√w_∑th
);

4078  
ªt
;

4080 
ªt
 = 
	`fs_∑th_add
(
√w_∑th
, 
ªf
->
«me
,Ñef->
«me_Àn
);

4081 i‡(
ªt
 < 0) {

4082 
	`fs_∑th_‰ì
(
√w_∑th
);

4083  
ªt
;

4086 
	`fs_∑th_‰ì
(
ªf
->
fuŒ_∑th
);

4087 
	`£t_ªf_∑th
(
ªf
, 
√w_∑th
);

4090 
	}
}

4133 
	$ª‰esh_ªf_∑th
(
£nd_˘x
 *
s˘x
, 
ªc‹ded_ªf
 *
ªf
)

4135 *
«me
;

4136 
ªt
;

4138 
«me
 = 
	`kmemdup
(
ªf
->«me,Ñef->
«me_Àn
, 
GFP_KERNEL
);

4139 i‡(!
«me
)

4140  -
ENOMEM
;

4142 
	`fs_∑th_ª£t
(
ªf
->
fuŒ_∑th
);

4143 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, 
ªf
->
dú
,Ñef->
dú_gí
,Ñef->
fuŒ_∑th
);

4144 i‡(
ªt
 < 0)

4145 
out
;

4147 
ªt
 = 
	`fs_∑th_add
(
ªf
->
fuŒ_∑th
, 
«me
,Ñef->
«me_Àn
);

4148 i‡(
ªt
 < 0)

4149 
out
;

4152 
	`£t_ªf_∑th
(
ªf
,Ñef->
fuŒ_∑th
);

4153 
out
:

4154 
	`k‰ì
(
«me
);

4155  
ªt
;

4156 
	}
}

4161 
	$¥o˚ss_ªc‹ded_ªfs
(
£nd_˘x
 *
s˘x
, *
≥ndög_move
)

4163 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
£nd_roŸ
->fs_info;

4164 
ªt
 = 0;

4165 
ªc‹ded_ªf
 *
cur
;

4166 
ªc‹ded_ªf
 *
cur2
;

4167 
	`LIST_HEAD
(
check_dús
);

4168 
fs_∑th
 *
vÆid_∑th
 = 
NULL
;

4169 
u64
 
ow_öode
 = 0;

4170 
u64
 
ow_gí
;

4171 
u64
 
ow_mode
;

4172 
did_ovîwrôe
 = 0;

4173 
is_‹ph™
 = 0;

4174 
u64
 
œ°_dú_öo_rm
 = 0;

4175 
boﬁ
 
ˇn_ª«me
 = 
åue
;

4176 
boﬁ
 
‹ph™ized_dú
 = 
Ál£
;

4177 
boﬁ
 
‹ph™ized_™˚°‹
 = 
Ál£
;

4179 
	`båfs_debug
(
fs_öfo
, "¥o˚ss_ªc‹ded_ªf†%Œu", 
s˘x
->
cur_öo
);

4185 
	`BUG_ON
(
s˘x
->
cur_öo
 <
BTRFS_FIRST_FREE_OBJECTID
);

4187 
vÆid_∑th
 = 
	`fs_∑th_Æloc
();

4188 i‡(!
vÆid_∑th
) {

4189 
ªt
 = -
ENOMEM
;

4190 
out
;

4204 i‡(!
s˘x
->
cur_öode_√w
) {

4205 
ªt
 = 
	`did_ovîwrôe_fú°_ªf
(
s˘x
, s˘x->
cur_öo
,

4206 
s˘x
->
cur_öode_gí
);

4207 i‡(
ªt
 < 0)

4208 
out
;

4209 i‡(
ªt
)

4210 
did_ovîwrôe
 = 1;

4212 i‡(
s˘x
->
cur_öode_√w
 || 
did_ovîwrôe
) {

4213 
ªt
 = 
	`gí_unique_«me
(
s˘x
, s˘x->
cur_öo
,

4214 
s˘x
->
cur_öode_gí
, 
vÆid_∑th
);

4215 i‡(
ªt
 < 0)

4216 
out
;

4217 
is_‹ph™
 = 1;

4219 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
,

4220 
vÆid_∑th
);

4221 i‡(
ªt
 < 0)

4222 
out
;

4263 
	`li°_f‹_óch_íåy
(
cur
, &
s˘x
->
√w_ªfs
, 
li°
) {

4264 
ªt
 = 
	`gë_cur_öode_°©e
(
s˘x
, 
cur
->
dú
, cur->
dú_gí
, 
NULL
, NULL);

4265 i‡(
ªt
 < 0)

4266 
out
;

4267 i‡(
ªt
 =
öode_°©e_wûl_¸óã
)

4276 
ªt
 = 
	`wûl_ovîwrôe_ªf
(
s˘x
, 
cur
->
dú
, cur->
dú_gí
,

4277 
cur
->
«me
, cur->
«me_Àn
,

4278 &
ow_öode
, &
ow_gí
, &
ow_mode
);

4279 i‡(
ªt
 < 0)

4280 
out
;

4281 i‡(
ªt
) {

4282 
ªt
 = 
	`is_fú°_ªf
(
s˘x
->
∑ª¡_roŸ
,

4283 
ow_öode
, 
cur
->
dú
, cur->
«me
,

4284 
cur
->
«me_Àn
);

4285 i‡(
ªt
 < 0)

4286 
out
;

4287 i‡(
ªt
) {

4288 
«me_ˇche_íåy
 *
n˚
;

4289 
waôög_dú_move
 *
wdm
;

4291 i‡(
‹ph™ized_dú
) {

4292 
ªt
 = 
	`ª‰esh_ªf_∑th
(
s˘x
, 
cur
);

4293 i‡(
ªt
 < 0)

4294 
out
;

4297 
ªt
 = 
	`‹ph™ize_öode
(
s˘x
, 
ow_öode
, 
ow_gí
,

4298 
cur
->
fuŒ_∑th
);

4299 i‡(
ªt
 < 0)

4300 
out
;

4301 i‡(
	`S_ISDIR
(
ow_mode
))

4302 
‹ph™ized_dú
 = 
åue
;

4310 
wdm
 = 
	`gë_waôög_dú_move
(
s˘x
, 
ow_öode
);

4311 i‡(
wdm
)

4312 
wdm
->
‹ph™ized
 = 
åue
;

4324 
n˚
 = 
	`«me_ˇche_£¨ch
(
s˘x
, 
ow_öode
, 
ow_gí
);

4325 i‡(
n˚
)

4326 
	`båfs_Ãu_ˇche_ªmove
(&
s˘x
->
«me_ˇche
,

4327 &
n˚
->
íåy
);

4336 
ªt
 = 
	`is_™˚°‹
(
s˘x
->
∑ª¡_roŸ
,

4337 
ow_öode
, 
ow_gí
,

4338 
s˘x
->
cur_öo
, 
NULL
);

4339 i‡(
ªt
 > 0) {

4340 
‹ph™ized_™˚°‹
 = 
åue
;

4341 
	`fs_∑th_ª£t
(
vÆid_∑th
);

4342 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, s˘x->
cur_öo
,

4343 
s˘x
->
cur_öode_gí
,

4344 
vÆid_∑th
);

4346 i‡(
ªt
 < 0)

4347 
out
;

4355 i‡(
‹ph™ized_dú
) {

4356 
ªt
 = 
	`ª‰esh_ªf_∑th
(
s˘x
, 
cur
);

4357 i‡(
ªt
 < 0)

4358 
out
;

4360 
ªt
 = 
	`£nd_u∆ök
(
s˘x
, 
cur
->
fuŒ_∑th
);

4361 i‡(
ªt
 < 0)

4362 
out
;

4368 
	`li°_f‹_óch_íåy
(
cur
, &
s˘x
->
√w_ªfs
, 
li°
) {

4376 
ªt
 = 
	`gë_cur_öode_°©e
(
s˘x
, 
cur
->
dú
, cur->
dú_gí
, 
NULL
, NULL);

4377 i‡(
ªt
 < 0)

4378 
out
;

4379 i‡(
ªt
 =
öode_°©e_wûl_¸óã
) {

4380 
ªt
 = 0;

4385 
	`li°_f‹_óch_íåy
(
cur2
, &
s˘x
->
√w_ªfs
, 
li°
) {

4386 i‡(
cur
 =
cur2
)

4388 i‡(
cur2
->
dú
 =
cur
->dir) {

4389 
ªt
 = 1;

4398 i‡(!
ªt
)

4399 
ªt
 = 
	`did_¸óã_dú
(
s˘x
, 
cur
->
dú
);

4400 i‡(
ªt
 < 0)

4401 
out
;

4402 i‡(!
ªt
) {

4403 
ªt
 = 
	`£nd_¸óã_öode
(
s˘x
, 
cur
->
dú
);

4404 i‡(
ªt
 < 0)

4405 
out
;

4406 
	`ˇche_dú_¸óãd
(
s˘x
, 
cur
->
dú
);

4410 i‡(
	`S_ISDIR
(
s˘x
->
cur_öode_mode
Ë&& s˘x->
∑ª¡_roŸ
) {

4411 
ªt
 = 
	`waô_f‹_de°_dú_move
(
s˘x
, 
cur
, 
is_‹ph™
);

4412 i‡(
ªt
 < 0)

4413 
out
;

4414 i‡(
ªt
 == 1) {

4415 
ˇn_ª«me
 = 
Ál£
;

4416 *
≥ndög_move
 = 1;

4420 i‡(
	`S_ISDIR
(
s˘x
->
cur_öode_mode
Ë&& s˘x->
∑ª¡_roŸ
 &&

4421 
ˇn_ª«me
) {

4422 
ªt
 = 
	`waô_f‹_∑ª¡_move
(
s˘x
, 
cur
, 
is_‹ph™
);

4423 i‡(
ªt
 < 0)

4424 
out
;

4425 i‡(
ªt
 == 1) {

4426 
ˇn_ª«me
 = 
Ál£
;

4427 *
≥ndög_move
 = 1;

4436 i‡(
is_‹ph™
 && 
ˇn_ª«me
) {

4437 
ªt
 = 
	`£nd_ª«me
(
s˘x
, 
vÆid_∑th
, 
cur
->
fuŒ_∑th
);

4438 i‡(
ªt
 < 0)

4439 
out
;

4440 
is_‹ph™
 = 0;

4441 
ªt
 = 
	`fs_∑th_c›y
(
vÆid_∑th
, 
cur
->
fuŒ_∑th
);

4442 i‡(
ªt
 < 0)

4443 
out
;

4444 } i‡(
ˇn_ª«me
) {

4445 i‡(
	`S_ISDIR
(
s˘x
->
cur_öode_mode
)) {

4451 
ªt
 = 
	`£nd_ª«me
(
s˘x
, 
vÆid_∑th
,

4452 
cur
->
fuŒ_∑th
);

4453 i‡(!
ªt
)

4454 
ªt
 = 
	`fs_∑th_c›y
(
vÆid_∑th
,

4455 
cur
->
fuŒ_∑th
);

4456 i‡(
ªt
 < 0)

4457 
out
;

4466 i‡(
‹ph™ized_dú
) {

4467 
ªt
 = 
	`upd©e_ªf_∑th
(
s˘x
, 
cur
);

4468 i‡(
ªt
 < 0)

4469 
out
;

4471 
ªt
 = 
	`£nd_lök
(
s˘x
, 
cur
->
fuŒ_∑th
,

4472 
vÆid_∑th
);

4473 i‡(
ªt
 < 0)

4474 
out
;

4477 
ªt
 = 
	`dup_ªf
(
cur
, &
check_dús
);

4478 i‡(
ªt
 < 0)

4479 
out
;

4482 i‡(
	`S_ISDIR
(
s˘x
->
cur_öode_mode
Ë&& s˘x->
cur_öode_dñëed
) {

4489 
ªt
 = 
	`ˇn_rmdú
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
);

4490 i‡(
ªt
 < 0)

4491 
out
;

4492 i‡(
ªt
) {

4493 
ªt
 = 
	`£nd_rmdú
(
s˘x
, 
vÆid_∑th
);

4494 i‡(
ªt
 < 0)

4495 
out
;

4496 } i‡(!
is_‹ph™
) {

4497 
ªt
 = 
	`‹ph™ize_öode
(
s˘x
, s˘x->
cur_öo
,

4498 
s˘x
->
cur_öode_gí
, 
vÆid_∑th
);

4499 i‡(
ªt
 < 0)

4500 
out
;

4501 
is_‹ph™
 = 1;

4504 
	`li°_f‹_óch_íåy
(
cur
, &
s˘x
->
dñëed_ªfs
, 
li°
) {

4505 
ªt
 = 
	`dup_ªf
(
cur
, &
check_dús
);

4506 i‡(
ªt
 < 0)

4507 
out
;

4509 } i‡(
	`S_ISDIR
(
s˘x
->
cur_öode_mode
) &&

4510 !
	`li°_em±y
(&
s˘x
->
dñëed_ªfs
)) {

4514 
cur
 = 
	`li°_íåy
(
s˘x
->
dñëed_ªfs
.
√xt
, 
ªc‹ded_ªf
,

4515 
li°
);

4516 
ªt
 = 
	`dup_ªf
(
cur
, &
check_dús
);

4517 i‡(
ªt
 < 0)

4518 
out
;

4519 } i‡(!
	`S_ISDIR
(
s˘x
->
cur_öode_mode
)) {

4525 
	`li°_f‹_óch_íåy
(
cur
, &
s˘x
->
dñëed_ªfs
, 
li°
) {

4526 
ªt
 = 
	`did_ovîwrôe_ªf
(
s˘x
, 
cur
->
dú
, cur->
dú_gí
,

4527 
s˘x
->
cur_öo
, s˘x->
cur_öode_gí
,

4528 
cur
->
«me
, cur->
«me_Àn
);

4529 i‡(
ªt
 < 0)

4530 
out
;

4531 i‡(!
ªt
) {

4539 i‡(
‹ph™ized_™˚°‹
) {

4540 
ªt
 = 
	`upd©e_ªf_∑th
(
s˘x
, 
cur
);

4541 i‡(
ªt
 < 0)

4542 
out
;

4544 
ªt
 = 
	`£nd_u∆ök
(
s˘x
, 
cur
->
fuŒ_∑th
);

4545 i‡(
ªt
 < 0)

4546 
out
;

4548 
ªt
 = 
	`dup_ªf
(
cur
, &
check_dús
);

4549 i‡(
ªt
 < 0)

4550 
out
;

4560 i‡(
is_‹ph™
) {

4561 
ªt
 = 
	`£nd_u∆ök
(
s˘x
, 
vÆid_∑th
);

4562 i‡(
ªt
 < 0)

4563 
out
;

4573 
	`li°_f‹_óch_íåy
(
cur
, &
check_dús
, 
li°
) {

4579 i‡(
cur
->
dú
 > 
s˘x
->
cur_öo
)

4582 
ªt
 = 
	`gë_cur_öode_°©e
(
s˘x
, 
cur
->
dú
, cur->
dú_gí
, 
NULL
, NULL);

4583 i‡(
ªt
 < 0)

4584 
out
;

4586 i‡(
ªt
 =
öode_°©e_did_¸óã
 ||

4587 
ªt
 =
öode_°©e_no_ch™ge
) {

4588 
ªt
 = 
	`ˇche_dú_utimes
(
s˘x
, 
cur
->
dú
, cur->
dú_gí
);

4589 i‡(
ªt
 < 0)

4590 
out
;

4591 } i‡(
ªt
 =
öode_°©e_did_dñëe
 &&

4592 
cur
->
dú
 !
œ°_dú_öo_rm
) {

4593 
ªt
 = 
	`ˇn_rmdú
(
s˘x
, 
cur
->
dú
, cur->
dú_gí
);

4594 i‡(
ªt
 < 0)

4595 
out
;

4596 i‡(
ªt
) {

4597 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, 
cur
->
dú
,

4598 
cur
->
dú_gí
, 
vÆid_∑th
);

4599 i‡(
ªt
 < 0)

4600 
out
;

4601 
ªt
 = 
	`£nd_rmdú
(
s˘x
, 
vÆid_∑th
);

4602 i‡(
ªt
 < 0)

4603 
out
;

4604 
œ°_dú_öo_rm
 = 
cur
->
dú
;

4609 
ªt
 = 0;

4611 
out
:

4612 
	`__‰ì_ªc‹ded_ªfs
(&
check_dús
);

4613 
	`‰ì_ªc‹ded_ªfs
(
s˘x
);

4614 
	`fs_∑th_‰ì
(
vÆid_∑th
);

4615  
ªt
;

4616 
	}
}

4618 
	$rbåì_ªf_comp
(c⁄° *
k
, c⁄° 
rb_node
 *
node
)

4620 c⁄° 
ªc‹ded_ªf
 *
d©a
 = 
k
;

4621 c⁄° 
ªc‹ded_ªf
 *
ªf
 = 
	`rb_íåy
(
node
, recorded_ref,Çode);

4622 
ªsu…
;

4624 i‡(
d©a
->
dú
 > 
ªf
->dir)

4626 i‡(
d©a
->
dú
 < 
ªf
->dir)

4628 i‡(
d©a
->
dú_gí
 > 
ªf
->dir_gen)

4630 i‡(
d©a
->
dú_gí
 < 
ªf
->dir_gen)

4632 i‡(
d©a
->
«me_Àn
 > 
ªf
->name_len)

4634 i‡(
d©a
->
«me_Àn
 < 
ªf
->name_len)

4636 
ªsu…
 = 
	`°rcmp
(
d©a
->
«me
, 
ªf
->name);

4637 i‡(
ªsu…
 > 0)

4639 i‡(
ªsu…
 < 0)

4642 
	}
}

4644 
boﬁ
 
	$rbåì_ªf_Àss
(
rb_node
 *
node
, c⁄° rb_nodê*
∑ª¡
)

4646 c⁄° 
ªc‹ded_ªf
 *
íåy
 = 
	`rb_íåy
(
node
, recorded_ref,Çode);

4648  
	`rbåì_ªf_comp
(
íåy
, 
∑ª¡
) < 0;

4649 
	}
}

4651 
	$ªc‹d_ªf_ö_åì
(
rb_roŸ
 *
roŸ
, 
li°_hód
 *
ªfs
,

4652 
fs_∑th
 *
«me
, 
u64
 
dú
, u64 
dú_gí
,

4653 
£nd_˘x
 *
s˘x
)

4655 
ªt
 = 0;

4656 
fs_∑th
 *
∑th
 = 
NULL
;

4657 
ªc‹ded_ªf
 *
ªf
 = 
NULL
;

4659 
∑th
 = 
	`fs_∑th_Æloc
();

4660 i‡(!
∑th
) {

4661 
ªt
 = -
ENOMEM
;

4662 
out
;

4665 
ªf
 = 
	`ªc‹ded_ªf_Æloc
();

4666 i‡(!
ªf
) {

4667 
ªt
 = -
ENOMEM
;

4668 
out
;

4671 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, 
dú
, 
dú_gí
, 
∑th
);

4672 i‡(
ªt
 < 0)

4673 
out
;

4674 
ªt
 = 
	`fs_∑th_add_∑th
(
∑th
, 
«me
);

4675 i‡(
ªt
 < 0)

4676 
out
;

4678 
ªf
->
dú
 = dir;

4679 
ªf
->
dú_gí
 = dir_gen;

4680 
	`£t_ªf_∑th
(
ªf
, 
∑th
);

4681 
	`li°_add_èû
(&
ªf
->
li°
, 
ªfs
);

4682 
	`rb_add
(&
ªf
->
node
, 
roŸ
, 
rbåì_ªf_Àss
);

4683 
ªf
->
roŸ
 =Ñoot;

4684 
out
:

4685 i‡(
ªt
) {

4686 i‡(
∑th
 && (!
ªf
 || !ªf->
fuŒ_∑th
))

4687 
	`fs_∑th_‰ì
(
∑th
);

4688 
	`ªc‹ded_ªf_‰ì
(
ªf
);

4690  
ªt
;

4691 
	}
}

4693 
	$ªc‹d_√w_ªf_if_√eded
(
num
, 
u64
 
dú
, 
ödex
,

4694 
fs_∑th
 *
«me
, *
˘x
)

4696 
ªt
 = 0;

4697 
£nd_˘x
 *
s˘x
 = 
˘x
;

4698 
rb_node
 *
node
 = 
NULL
;

4699 
ªc‹ded_ªf
 
d©a
;

4700 
ªc‹ded_ªf
 *
ªf
;

4701 
u64
 
dú_gí
;

4703 
ªt
 = 
	`gë_öode_gí
(
s˘x
->
£nd_roŸ
, 
dú
, &
dú_gí
);

4704 i‡(
ªt
 < 0)

4705 
out
;

4707 
d©a
.
dú
 = dir;

4708 
d©a
.
dú_gí
 = dir_gen;

4709 
	`£t_ªf_∑th
(&
d©a
, 
«me
);

4710 
node
 = 
	`rb_föd
(&
d©a
, &
s˘x
->
rbåì_dñëed_ªfs
, 
rbåì_ªf_comp
);

4711 i‡(
node
) {

4712 
ªf
 = 
	`rb_íåy
(
node
, 
ªc‹ded_ªf
,Çode);

4713 
	`ªc‹ded_ªf_‰ì
(
ªf
);

4715 
ªt
 = 
	`ªc‹d_ªf_ö_åì
(&
s˘x
->
rbåì_√w_ªfs
,

4716 &
s˘x
->
√w_ªfs
, 
«me
, 
dú
, 
dú_gí
,

4717 
s˘x
);

4719 
out
:

4720  
ªt
;

4721 
	}
}

4723 
	$ªc‹d_dñëed_ªf_if_√eded
(
num
, 
u64
 
dú
, 
ödex
,

4724 
fs_∑th
 *
«me
, *
˘x
)

4726 
ªt
 = 0;

4727 
£nd_˘x
 *
s˘x
 = 
˘x
;

4728 
rb_node
 *
node
 = 
NULL
;

4729 
ªc‹ded_ªf
 
d©a
;

4730 
ªc‹ded_ªf
 *
ªf
;

4731 
u64
 
dú_gí
;

4733 
ªt
 = 
	`gë_öode_gí
(
s˘x
->
∑ª¡_roŸ
, 
dú
, &
dú_gí
);

4734 i‡(
ªt
 < 0)

4735 
out
;

4737 
d©a
.
dú
 = dir;

4738 
d©a
.
dú_gí
 = dir_gen;

4739 
	`£t_ªf_∑th
(&
d©a
, 
«me
);

4740 
node
 = 
	`rb_föd
(&
d©a
, &
s˘x
->
rbåì_√w_ªfs
, 
rbåì_ªf_comp
);

4741 i‡(
node
) {

4742 
ªf
 = 
	`rb_íåy
(
node
, 
ªc‹ded_ªf
,Çode);

4743 
	`ªc‹ded_ªf_‰ì
(
ªf
);

4745 
ªt
 = 
	`ªc‹d_ªf_ö_åì
(&
s˘x
->
rbåì_dñëed_ªfs
,

4746 &
s˘x
->
dñëed_ªfs
, 
«me
, 
dú
,

4747 
dú_gí
, 
s˘x
);

4749 
out
:

4750  
ªt
;

4751 
	}
}

4753 
	$ªc‹d_√w_ªf
(
£nd_˘x
 *
s˘x
)

4755 
ªt
;

4757 
ªt
 = 
	`ôî©e_öode_ªf
(
s˘x
->
£nd_roŸ
, s˘x->
À·_∑th
,

4758 
s˘x
->
cmp_key
, 0, 
ªc‹d_√w_ªf_if_√eded
, sctx);

4759 i‡(
ªt
 < 0)

4760 
out
;

4761 
ªt
 = 0;

4763 
out
:

4764  
ªt
;

4765 
	}
}

4767 
	$ªc‹d_dñëed_ªf
(
£nd_˘x
 *
s˘x
)

4769 
ªt
;

4771 
ªt
 = 
	`ôî©e_öode_ªf
(
s˘x
->
∑ª¡_roŸ
, s˘x->
right_∑th
,

4772 
s˘x
->
cmp_key
, 0, 
ªc‹d_dñëed_ªf_if_√eded
,

4773 
s˘x
);

4774 i‡(
ªt
 < 0)

4775 
out
;

4776 
ªt
 = 0;

4778 
out
:

4779  
ªt
;

4780 
	}
}

4782 
	$ªc‹d_ch™ged_ªf
(
£nd_˘x
 *
s˘x
)

4784 
ªt
 = 0;

4786 
ªt
 = 
	`ôî©e_öode_ªf
(
s˘x
->
£nd_roŸ
, s˘x->
À·_∑th
,

4787 
s˘x
->
cmp_key
, 0, 
ªc‹d_√w_ªf_if_√eded
, sctx);

4788 i‡(
ªt
 < 0)

4789 
out
;

4790 
ªt
 = 
	`ôî©e_öode_ªf
(
s˘x
->
∑ª¡_roŸ
, s˘x->
right_∑th
,

4791 
s˘x
->
cmp_key
, 0, 
ªc‹d_dñëed_ªf_if_√eded
, sctx);

4792 i‡(
ªt
 < 0)

4793 
out
;

4794 
ªt
 = 0;

4796 
out
:

4797  
ªt
;

4798 
	}
}

4804 
	$¥o˚ss_Æl_ªfs
(
£nd_˘x
 *
s˘x
,

4805 
båfs_com∑ª_åì_ªsu…
 
cmd
)

4807 
ªt
 = 0;

4808 
ôî_ªt
 = 0;

4809 
båfs_roŸ
 *
roŸ
;

4810 
båfs_∑th
 *
∑th
;

4811 
båfs_key
 
key
;

4812 
båfs_key
 
found_key
;

4813 
ôî©e_öode_ªf_t
 
cb
;

4814 
≥ndög_move
 = 0;

4816 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

4817 i‡(!
∑th
)

4818  -
ENOMEM
;

4820 i‡(
cmd
 =
BTRFS_COMPARE_TREE_NEW
) {

4821 
roŸ
 = 
s˘x
->
£nd_roŸ
;

4822 
cb
 = 
ªc‹d_√w_ªf_if_√eded
;

4823 } i‡(
cmd
 =
BTRFS_COMPARE_TREE_DELETED
) {

4824 
roŸ
 = 
s˘x
->
∑ª¡_roŸ
;

4825 
cb
 = 
ªc‹d_dñëed_ªf_if_√eded
;

4827 
	`båfs_îr
(
s˘x
->
£nd_roŸ
->
fs_öfo
,

4828 "Wr⁄g comm™d %d i¿¥o˚ss_Æl_ªfs", 
cmd
);

4829 
ªt
 = -
EINVAL
;

4830 
out
;

4833 
key
.
obje˘id
 = 
s˘x
->
cmp_key
->objectid;

4834 
key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

4835 
key
.
off£t
 = 0;

4836 
	`båfs_f‹_óch_¶Ÿ
(
roŸ
, &
key
, &
found_key
, 
∑th
, 
ôî_ªt
) {

4837 i‡(
found_key
.
obje˘id
 !
key
.objectid ||

4838 (
found_key
.
ty≥
 !
BTRFS_INODE_REF_KEY
 &&

4839 
found_key
.
ty≥
 !
BTRFS_INODE_EXTREF_KEY
))

4842 
ªt
 = 
	`ôî©e_öode_ªf
(
roŸ
, 
∑th
, &
found_key
, 0, 
cb
, 
s˘x
);

4843 i‡(
ªt
 < 0)

4844 
out
;

4847 i‡(
ôî_ªt
 < 0) {

4848 
ªt
 = 
ôî_ªt
;

4849 
out
;

4851 
	`båfs_ªÀa£_∑th
(
∑th
);

4858 
ªt
 = 
	`¥o˚ss_ªc‹ded_ªfs
(
s˘x
, &
≥ndög_move
);

4859 
out
:

4860 
	`båfs_‰ì_∑th
(
∑th
);

4861  
ªt
;

4862 
	}
}

4864 
	$£nd_£t_x©å
(
£nd_˘x
 *
s˘x
,

4865 
fs_∑th
 *
∑th
,

4866 c⁄° *
«me
, 
«me_Àn
,

4867 c⁄° *
d©a
, 
d©a_Àn
)

4869 
ªt
 = 0;

4871 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_SET_XATTR
);

4872 i‡(
ªt
 < 0)

4873 
out
;

4875 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
∑th
);

4876 
	`TLV_PUT_STRING
(
s˘x
, 
BTRFS_SEND_A_XATTR_NAME
, 
«me
, 
«me_Àn
);

4877 
	`TLV_PUT
(
s˘x
, 
BTRFS_SEND_A_XATTR_DATA
, 
d©a
, 
d©a_Àn
);

4879 
ªt
 = 
	`£nd_cmd
(
s˘x
);

4881 
év_put_Áûuª
:

4882 
out
:

4883  
ªt
;

4884 
	}
}

4886 
	$£nd_ªmove_x©å
(
£nd_˘x
 *
s˘x
,

4887 
fs_∑th
 *
∑th
,

4888 c⁄° *
«me
, 
«me_Àn
)

4890 
ªt
 = 0;

4892 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_REMOVE_XATTR
);

4893 i‡(
ªt
 < 0)

4894 
out
;

4896 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
∑th
);

4897 
	`TLV_PUT_STRING
(
s˘x
, 
BTRFS_SEND_A_XATTR_NAME
, 
«me
, 
«me_Àn
);

4899 
ªt
 = 
	`£nd_cmd
(
s˘x
);

4901 
év_put_Áûuª
:

4902 
out
:

4903  
ªt
;

4904 
	}
}

4906 
	$__¥o˚ss_√w_x©å
(
num
, 
båfs_key
 *
di_key
,

4907 c⁄° *
«me
, 
«me_Àn
, c⁄° *
d©a
,

4908 
d©a_Àn
, *
˘x
)

4910 
ªt
;

4911 
£nd_˘x
 *
s˘x
 = 
˘x
;

4912 
fs_∑th
 *
p
;

4913 
posix_a˛_x©å_hódî
 
dummy_a˛
;

4916 i‡(!
	`°∫cmp
(
«me
, 
XATTR_NAME_CAPS
, 
«me_Àn
))

4919 
p
 = 
	`fs_∑th_Æloc
();

4920 i‡(!
p
)

4921  -
ENOMEM
;

4929 i‡(!
	`°∫cmp
(
«me
, 
XATTR_NAME_POSIX_ACL_ACCESS
, 
«me_Àn
) ||

4930 !
	`°∫cmp
(
«me
, 
XATTR_NAME_POSIX_ACL_DEFAULT
, 
«me_Àn
)) {

4931 i‡(
d©a_Àn
 == 0) {

4932 
dummy_a˛
.
a_vîsi⁄
 =

4933 
	`˝u_to_À32
(
POSIX_ACL_XATTR_VERSION
);

4934 
d©a
 = (*)&
dummy_a˛
;

4935 
d©a_Àn
 = (
dummy_a˛
);

4939 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
, 
p
);

4940 i‡(
ªt
 < 0)

4941 
out
;

4943 
ªt
 = 
	`£nd_£t_x©å
(
s˘x
, 
p
, 
«me
, 
«me_Àn
, 
d©a
, 
d©a_Àn
);

4945 
out
:

4946 
	`fs_∑th_‰ì
(
p
);

4947  
ªt
;

4948 
	}
}

4950 
	$__¥o˚ss_dñëed_x©å
(
num
, 
båfs_key
 *
di_key
,

4951 c⁄° *
«me
, 
«me_Àn
,

4952 c⁄° *
d©a
, 
d©a_Àn
, *
˘x
)

4954 
ªt
;

4955 
£nd_˘x
 *
s˘x
 = 
˘x
;

4956 
fs_∑th
 *
p
;

4958 
p
 = 
	`fs_∑th_Æloc
();

4959 i‡(!
p
)

4960  -
ENOMEM
;

4962 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
, 
p
);

4963 i‡(
ªt
 < 0)

4964 
out
;

4966 
ªt
 = 
	`£nd_ªmove_x©å
(
s˘x
, 
p
, 
«me
, 
«me_Àn
);

4968 
out
:

4969 
	`fs_∑th_‰ì
(
p
);

4970  
ªt
;

4971 
	}
}

4973 
	$¥o˚ss_√w_x©å
(
£nd_˘x
 *
s˘x
)

4975 
ªt
 = 0;

4977 
ªt
 = 
	`ôî©e_dú_ôem
(
s˘x
->
£nd_roŸ
, s˘x->
À·_∑th
,

4978 
__¥o˚ss_√w_x©å
, 
s˘x
);

4980  
ªt
;

4981 
	}
}

4983 
	$¥o˚ss_dñëed_x©å
(
£nd_˘x
 *
s˘x
)

4985  
	`ôî©e_dú_ôem
(
s˘x
->
∑ª¡_roŸ
, s˘x->
right_∑th
,

4986 
__¥o˚ss_dñëed_x©å
, 
s˘x
);

4987 
	}
}

4989 
	sföd_x©å_˘x
 {

4990 c⁄° *
	m«me
;

4991 
	m«me_Àn
;

4992 
	mfound_idx
;

4993 *
	mfound_d©a
;

4994 
	mfound_d©a_Àn
;

4997 
	$__föd_x©å
(
num
, 
båfs_key
 *
di_key
, c⁄° *
«me
,

4998 
«me_Àn
, c⁄° *
d©a
, 
d©a_Àn
, *
v˘x
)

5000 
föd_x©å_˘x
 *
˘x
 = 
v˘x
;

5002 i‡(
«me_Àn
 =
˘x
->name_len &&

5003 
	`°∫cmp
(
«me
, 
˘x
->«me, 
«me_Àn
) == 0) {

5004 
˘x
->
found_idx
 = 
num
;

5005 
˘x
->
found_d©a_Àn
 = 
d©a_Àn
;

5006 
˘x
->
found_d©a
 = 
	`kmemdup
(
d©a
, 
d©a_Àn
, 
GFP_KERNEL
);

5007 i‡(!
˘x
->
found_d©a
)

5008  -
ENOMEM
;

5012 
	}
}

5014 
	$föd_x©å
(
båfs_roŸ
 *
roŸ
,

5015 
båfs_∑th
 *
∑th
,

5016 
båfs_key
 *
key
,

5017 c⁄° *
«me
, 
«me_Àn
,

5018 **
d©a
, *
d©a_Àn
)

5020 
ªt
;

5021 
föd_x©å_˘x
 
˘x
;

5023 
˘x
.
«me
 =Çame;

5024 
˘x
.
«me_Àn
 =Çame_len;

5025 
˘x
.
found_idx
 = -1;

5026 
˘x
.
found_d©a
 = 
NULL
;

5027 
˘x
.
found_d©a_Àn
 = 0;

5029 
ªt
 = 
	`ôî©e_dú_ôem
(
roŸ
, 
∑th
, 
__föd_x©å
, &
˘x
);

5030 i‡(
ªt
 < 0)

5031  
ªt
;

5033 i‡(
˘x
.
found_idx
 == -1)

5034  -
ENOENT
;

5035 i‡(
d©a
) {

5036 *
d©a
 = 
˘x
.
found_d©a
;

5037 *
d©a_Àn
 = 
˘x
.
found_d©a_Àn
;

5039 
	`k‰ì
(
˘x
.
found_d©a
);

5041  
˘x
.
found_idx
;

5042 
	}
}

5045 
	$__¥o˚ss_ch™ged_√w_x©å
(
num
, 
båfs_key
 *
di_key
,

5046 c⁄° *
«me
, 
«me_Àn
,

5047 c⁄° *
d©a
, 
d©a_Àn
,

5048 *
˘x
)

5050 
ªt
;

5051 
£nd_˘x
 *
s˘x
 = 
˘x
;

5052 *
found_d©a
 = 
NULL
;

5053 
found_d©a_Àn
 = 0;

5055 
ªt
 = 
	`föd_x©å
(
s˘x
->
∑ª¡_roŸ
, s˘x->
right_∑th
,

5056 
s˘x
->
cmp_key
, 
«me
, 
«me_Àn
, &
found_d©a
,

5057 &
found_d©a_Àn
);

5058 i‡(
ªt
 =-
ENOENT
) {

5059 
ªt
 = 
	`__¥o˚ss_√w_x©å
(
num
, 
di_key
, 
«me
, 
«me_Àn
, 
d©a
,

5060 
d©a_Àn
, 
˘x
);

5061 } i‡(
ªt
 >= 0) {

5062 i‡(
d©a_Àn
 !
found_d©a_Àn
 ||

5063 
	`memcmp
(
d©a
, 
found_d©a
, 
d©a_Àn
)) {

5064 
ªt
 = 
	`__¥o˚ss_√w_x©å
(
num
, 
di_key
, 
«me
, 
«me_Àn
,

5065 
d©a
, 
d©a_Àn
, 
˘x
);

5067 
ªt
 = 0;

5071 
	`k‰ì
(
found_d©a
);

5072  
ªt
;

5073 
	}
}

5075 
	$__¥o˚ss_ch™ged_dñëed_x©å
(
num
, 
båfs_key
 *
di_key
,

5076 c⁄° *
«me
, 
«me_Àn
,

5077 c⁄° *
d©a
, 
d©a_Àn
,

5078 *
˘x
)

5080 
ªt
;

5081 
£nd_˘x
 *
s˘x
 = 
˘x
;

5083 
ªt
 = 
	`föd_x©å
(
s˘x
->
£nd_roŸ
, s˘x->
À·_∑th
, s˘x->
cmp_key
,

5084 
«me
, 
«me_Àn
, 
NULL
, NULL);

5085 i‡(
ªt
 =-
ENOENT
)

5086 
ªt
 = 
	`__¥o˚ss_dñëed_x©å
(
num
, 
di_key
, 
«me
, 
«me_Àn
, 
d©a
,

5087 
d©a_Àn
, 
˘x
);

5088 i‡(
ªt
 >= 0)

5089 
ªt
 = 0;

5091  
ªt
;

5092 
	}
}

5094 
	$¥o˚ss_ch™ged_x©å
(
£nd_˘x
 *
s˘x
)

5096 
ªt
 = 0;

5098 
ªt
 = 
	`ôî©e_dú_ôem
(
s˘x
->
£nd_roŸ
, s˘x->
À·_∑th
,

5099 
__¥o˚ss_ch™ged_√w_x©å
, 
s˘x
);

5100 i‡(
ªt
 < 0)

5101 
out
;

5102 
ªt
 = 
	`ôî©e_dú_ôem
(
s˘x
->
∑ª¡_roŸ
, s˘x->
right_∑th
,

5103 
__¥o˚ss_ch™ged_dñëed_x©å
, 
s˘x
);

5105 
out
:

5106  
ªt
;

5107 
	}
}

5109 
	$¥o˚ss_Æl_√w_x©ås
(
£nd_˘x
 *
s˘x
)

5111 
ªt
 = 0;

5112 
ôî_ªt
 = 0;

5113 
båfs_roŸ
 *
roŸ
;

5114 
båfs_∑th
 *
∑th
;

5115 
båfs_key
 
key
;

5116 
båfs_key
 
found_key
;

5118 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

5119 i‡(!
∑th
)

5120  -
ENOMEM
;

5122 
roŸ
 = 
s˘x
->
£nd_roŸ
;

5124 
key
.
obje˘id
 = 
s˘x
->
cmp_key
->objectid;

5125 
key
.
ty≥
 = 
BTRFS_XATTR_ITEM_KEY
;

5126 
key
.
off£t
 = 0;

5127 
	`båfs_f‹_óch_¶Ÿ
(
roŸ
, &
key
, &
found_key
, 
∑th
, 
ôî_ªt
) {

5128 i‡(
found_key
.
obje˘id
 !
key
.objectid ||

5129 
found_key
.
ty≥
 !
key
.type) {

5130 
ªt
 = 0;

5134 
ªt
 = 
	`ôî©e_dú_ôem
(
roŸ
, 
∑th
, 
__¥o˚ss_√w_x©å
, 
s˘x
);

5135 i‡(
ªt
 < 0)

5139 i‡(
ôî_ªt
 < 0)

5140 
ªt
 = 
ôî_ªt
;

5142 
	`båfs_‰ì_∑th
(
∑th
);

5143  
ªt
;

5144 
	}
}

5146 
	$£nd_vîôy
(
£nd_˘x
 *
s˘x
, 
fs_∑th
 *
∑th
,

5147 
fsvîôy_des¸ùt‹
 *
desc
)

5149 
ªt
;

5151 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_ENABLE_VERITY
);

5152 i‡(
ªt
 < 0)

5153 
out
;

5155 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
∑th
);

5156 
	`TLV_PUT_U8
(
s˘x
, 
BTRFS_SEND_A_VERITY_ALGORITHM
,

5157 
	`À8_to_˝u
(
desc
->
hash_Æg‹ôhm
));

5158 
	`TLV_PUT_U32
(
s˘x
, 
BTRFS_SEND_A_VERITY_BLOCK_SIZE
,

5159 1U << 
	`À8_to_˝u
(
desc
->
log_blocksize
));

5160 
	`TLV_PUT
(
s˘x
, 
BTRFS_SEND_A_VERITY_SALT_DATA
, 
desc
->
ß…
,

5161 
	`À8_to_˝u
(
desc
->
ß…_size
));

5162 
	`TLV_PUT
(
s˘x
, 
BTRFS_SEND_A_VERITY_SIG_DATA
, 
desc
->
sig«tuª
,

5163 
	`À32_to_˝u
(
desc
->
sig_size
));

5165 
ªt
 = 
	`£nd_cmd
(
s˘x
);

5167 
év_put_Áûuª
:

5168 
out
:

5169  
ªt
;

5170 
	}
}

5172 
	$¥o˚ss_vîôy
(
£nd_˘x
 *
s˘x
)

5174 
ªt
 = 0;

5175 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
£nd_roŸ
->fs_info;

5176 
öode
 *inode;

5177 
fs_∑th
 *
p
;

5179 
öode
 = 
	`båfs_igë
(
fs_öfo
->
sb
, 
s˘x
->
cur_öo
, s˘x->
£nd_roŸ
);

5180 i‡(
	`IS_ERR
(
öode
))

5181  
	`PTR_ERR
(
öode
);

5183 
ªt
 = 
	`båfs_gë_vîôy_des¸ùt‹
(
öode
, 
NULL
, 0);

5184 i‡(
ªt
 < 0)

5185 
ùut
;

5187 i‡(
ªt
 > 
FS_VERITY_MAX_DESCRIPTOR_SIZE
) {

5188 
ªt
 = -
EMSGSIZE
;

5189 
ùut
;

5191 i‡(!
s˘x
->
vîôy_des¸ùt‹
) {

5192 
s˘x
->
vîôy_des¸ùt‹
 = 
	`kvmÆloc
(
FS_VERITY_MAX_DESCRIPTOR_SIZE
,

5193 
GFP_KERNEL
);

5194 i‡(!
s˘x
->
vîôy_des¸ùt‹
) {

5195 
ªt
 = -
ENOMEM
;

5196 
ùut
;

5200 
ªt
 = 
	`båfs_gë_vîôy_des¸ùt‹
(
öode
, 
s˘x
->
vîôy_des¸ùt‹
,Ñet);

5201 i‡(
ªt
 < 0)

5202 
ùut
;

5204 
p
 = 
	`fs_∑th_Æloc
();

5205 i‡(!
p
) {

5206 
ªt
 = -
ENOMEM
;

5207 
ùut
;

5209 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
, 
p
);

5210 i‡(
ªt
 < 0)

5211 
‰ì_∑th
;

5213 
ªt
 = 
	`£nd_vîôy
(
s˘x
, 
p
, s˘x->
vîôy_des¸ùt‹
);

5214 i‡(
ªt
 < 0)

5215 
‰ì_∑th
;

5217 
‰ì_∑th
:

5218 
	`fs_∑th_‰ì
(
p
);

5219 
ùut
:

5220 
	`ùut
(
öode
);

5221  
ªt
;

5222 
	}
}

5224 
ölöe
 
u64
 
	$max_£nd_ªad_size
(c⁄° 
£nd_˘x
 *
s˘x
)

5226  
s˘x
->
£nd_max_size
 - 
SZ_16K
;

5227 
	}
}

5229 
	$put_d©a_hódî
(
£nd_˘x
 *
s˘x
, 
u32
 
Àn
)

5231 i‡(
	`WARN_ON_ONCE
(
s˘x
->
put_d©a
))

5232  -
EINVAL
;

5233 
s˘x
->
put_d©a
 = 
åue
;

5234 i‡(
s˘x
->
¥Ÿo
 >= 2) {

5239 i‡(
s˘x
->
£nd_max_size
 - s˘x->
£nd_size
 < (
__À16
Ë+ 
Àn
)

5240  -
EOVERFLOW
;

5241 
	`put_u«lig√d_À16
(
BTRFS_SEND_A_DATA
, 
s˘x
->
£nd_buf
 + s˘x->
£nd_size
);

5242 
s˘x
->
£nd_size
 +(
__À16
);

5244 
båfs_év_hódî
 *
hdr
;

5246 i‡(
s˘x
->
£nd_max_size
 - s˘x->
£nd_size
 < (*
hdr
Ë+ 
Àn
)

5247  -
EOVERFLOW
;

5248 
hdr
 = (
båfs_év_hódî
 *)(
s˘x
->
£nd_buf
 + s˘x->
£nd_size
);

5249 
	`put_u«lig√d_À16
(
BTRFS_SEND_A_DATA
, &
hdr
->
év_ty≥
);

5250 
	`put_u«lig√d_À16
(
Àn
, &
hdr
->
év_Àn
);

5251 
s˘x
->
£nd_size
 +(*
hdr
);

5254 
	}
}

5256 
	$put_fûe_d©a
(
£nd_˘x
 *
s˘x
, 
u64
 
off£t
, 
u32
 
Àn
)

5258 
båfs_roŸ
 *
roŸ
 = 
s˘x
->
£nd_roŸ
;

5259 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

5260 
∑ge
 *page;

5261 
pgoff_t
 
ödex
 = 
off£t
 >> 
PAGE_SHIFT
;

5262 
pgoff_t
 
œ°_ödex
;

5263 
pg_off£t
 = 
	`off£t_ö_∑ge
(
off£t
);

5264 
ªt
;

5266 
ªt
 = 
	`put_d©a_hódî
(
s˘x
, 
Àn
);

5267 i‡(
ªt
)

5268  
ªt
;

5270 
œ°_ödex
 = (
off£t
 + 
Àn
 - 1Ë>> 
PAGE_SHIFT
;

5272 
ödex
 <
œ°_ödex
) {

5273 
cur_Àn
 = 
	`mö_t
(, 
Àn
,

5274 
PAGE_SIZE
 - 
pg_off£t
);

5276 
∑ge
 = 
	`föd_lock_∑ge
(
s˘x
->
cur_öode
->
i_m≠pög
, 
ödex
);

5277 i‡(!
∑ge
) {

5278 
	`∑ge_ˇche_sync_ªadahód
(
s˘x
->
cur_öode
->
i_m≠pög
,

5279 &
s˘x
->
ø
, 
NULL
, 
ödex
,

5280 
œ°_ödex
 + 1 - 
ödex
);

5282 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
s˘x
->
cur_öode
->
i_m≠pög
,

5283 
ödex
, 
GFP_KERNEL
);

5284 i‡(!
∑ge
) {

5285 
ªt
 = -
ENOMEM
;

5290 i‡(
	`PageRódahód
(
∑ge
))

5291 
	`∑ge_ˇche_async_ªadahód
(
s˘x
->
cur_öode
->
i_m≠pög
,

5292 &
s˘x
->
ø
, 
NULL
, 
	`∑ge_fﬁio
(
∑ge
),

5293 
ödex
, 
œ°_ödex
 + 1 - index);

5295 i‡(!
	`PageU±od©e
(
∑ge
)) {

5296 
	`båfs_ªad_fﬁio
(
NULL
, 
	`∑ge_fﬁio
(
∑ge
));

5297 
	`lock_∑ge
(
∑ge
);

5298 i‡(!
	`PageU±od©e
(
∑ge
)) {

5299 
	`u∆ock_∑ge
(
∑ge
);

5300 
	`båfs_îr
(
fs_öfo
,

5302 
	`∑ge_off£t
(
∑ge
), 
s˘x
->
cur_öo
,

5303 
s˘x
->
£nd_roŸ
->
roŸ_key
.
obje˘id
);

5304 
	`put_∑ge
(
∑ge
);

5305 
ªt
 = -
EIO
;

5310 
	`mem˝y_‰om_∑ge
(
s˘x
->
£nd_buf
 + s˘x->
£nd_size
, 
∑ge
,

5311 
pg_off£t
, 
cur_Àn
);

5312 
	`u∆ock_∑ge
(
∑ge
);

5313 
	`put_∑ge
(
∑ge
);

5314 
ödex
++;

5315 
pg_off£t
 = 0;

5316 
Àn
 -
cur_Àn
;

5317 
s˘x
->
£nd_size
 +
cur_Àn
;

5320  
ªt
;

5321 
	}
}

5327 
	$£nd_wrôe
(
£nd_˘x
 *
s˘x
, 
u64
 
off£t
, 
u32
 
Àn
)

5329 
båfs_fs_öfo
 *
fs_öfo
 = 
s˘x
->
£nd_roŸ
->fs_info;

5330 
ªt
 = 0;

5331 
fs_∑th
 *
p
;

5333 
p
 = 
	`fs_∑th_Æloc
();

5334 i‡(!
p
)

5335  -
ENOMEM
;

5337 
	`båfs_debug
(
fs_öfo
, "£nd_wrôêoff£t=%Œu,Üí=%d", 
off£t
, 
Àn
);

5339 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_WRITE
);

5340 i‡(
ªt
 < 0)

5341 
out
;

5343 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
, 
p
);

5344 i‡(
ªt
 < 0)

5345 
out
;

5347 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
p
);

5348 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_FILE_OFFSET
, 
off£t
);

5349 
ªt
 = 
	`put_fûe_d©a
(
s˘x
, 
off£t
, 
Àn
);

5350 i‡(
ªt
 < 0)

5351 
out
;

5353 
ªt
 = 
	`£nd_cmd
(
s˘x
);

5355 
év_put_Áûuª
:

5356 
out
:

5357 
	`fs_∑th_‰ì
(
p
);

5358  
ªt
;

5359 
	}
}

5364 
	$£nd_˛⁄e
(
£nd_˘x
 *
s˘x
,

5365 
u64
 
off£t
, 
u32
 
Àn
,

5366 
˛⁄e_roŸ
 *clone_root)

5368 
ªt
 = 0;

5369 
fs_∑th
 *
p
;

5370 
u64
 
gí
;

5372 
	`båfs_debug
(
s˘x
->
£nd_roŸ
->
fs_öfo
,

5374 
off£t
, 
Àn
, 
˛⁄e_roŸ
->
roŸ
->
roŸ_key
.
obje˘id
,

5375 
˛⁄e_roŸ
->
öo
, cl⁄e_roŸ->
off£t
);

5377 
p
 = 
	`fs_∑th_Æloc
();

5378 i‡(!
p
)

5379  -
ENOMEM
;

5381 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_CLONE
);

5382 i‡(
ªt
 < 0)

5383 
out
;

5385 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
, 
p
);

5386 i‡(
ªt
 < 0)

5387 
out
;

5389 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_FILE_OFFSET
, 
off£t
);

5390 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_CLONE_LEN
, 
Àn
);

5391 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
p
);

5393 i‡(
˛⁄e_roŸ
->
roŸ
 =
s˘x
->
£nd_roŸ
) {

5394 
ªt
 = 
	`gë_öode_gí
(
s˘x
->
£nd_roŸ
, 
˛⁄e_roŸ
->
öo
, &
gí
);

5395 i‡(
ªt
 < 0)

5396 
out
;

5397 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, 
˛⁄e_roŸ
->
öo
, 
gí
, 
p
);

5399 
ªt
 = 
	`gë_öode_∑th
(
˛⁄e_roŸ
->
roŸ
, cl⁄e_roŸ->
öo
, 
p
);

5401 i‡(
ªt
 < 0)

5402 
out
;

5413 i‡(!
	`båfs_is_em±y_uuid
(
˛⁄e_roŸ
->
roŸ
->
roŸ_ôem
.
ª˚ived_uuid
))

5414 
	`TLV_PUT_UUID
(
s˘x
, 
BTRFS_SEND_A_CLONE_UUID
,

5415 
˛⁄e_roŸ
->
roŸ
->
roŸ_ôem
.
ª˚ived_uuid
);

5417 
	`TLV_PUT_UUID
(
s˘x
, 
BTRFS_SEND_A_CLONE_UUID
,

5418 
˛⁄e_roŸ
->
roŸ
->
roŸ_ôem
.
uuid
);

5419 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_CLONE_CTRANSID
,

5420 
	`båfs_roŸ_˘ønsid
(&
˛⁄e_roŸ
->
roŸ
->
roŸ_ôem
));

5421 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_CLONE_PATH
, 
p
);

5422 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_CLONE_OFFSET
,

5423 
˛⁄e_roŸ
->
off£t
);

5425 
ªt
 = 
	`£nd_cmd
(
s˘x
);

5427 
év_put_Áûuª
:

5428 
out
:

5429 
	`fs_∑th_‰ì
(
p
);

5430  
ªt
;

5431 
	}
}

5436 
	$£nd_upd©e_exã¡
(
£nd_˘x
 *
s˘x
,

5437 
u64
 
off£t
, 
u32
 
Àn
)

5439 
ªt
 = 0;

5440 
fs_∑th
 *
p
;

5442 
p
 = 
	`fs_∑th_Æloc
();

5443 i‡(!
p
)

5444  -
ENOMEM
;

5446 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_UPDATE_EXTENT
);

5447 i‡(
ªt
 < 0)

5448 
out
;

5450 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
, 
p
);

5451 i‡(
ªt
 < 0)

5452 
out
;

5454 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
p
);

5455 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_FILE_OFFSET
, 
off£t
);

5456 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_SIZE
, 
Àn
);

5458 
ªt
 = 
	`£nd_cmd
(
s˘x
);

5460 
év_put_Áûuª
:

5461 
out
:

5462 
	`fs_∑th_‰ì
(
p
);

5463  
ªt
;

5464 
	}
}

5466 
	$£nd_hﬁe
(
£nd_˘x
 *
s˘x
, 
u64
 
íd
)

5468 
fs_∑th
 *
p
 = 
NULL
;

5469 
u64
 
ªad_size
 = 
	`max_£nd_ªad_size
(
s˘x
);

5470 
u64
 
off£t
 = 
s˘x
->
cur_öode_œ°_exã¡
;

5471 
ªt
 = 0;

5479 i‡(
off£t
 >
s˘x
->
cur_öode_size
)

5486 
íd
 = 
	`mö_t
(
u64
,Énd, 
s˘x
->
cur_öode_size
);

5488 i‡(
s˘x
->
Êags
 & 
BTRFS_SEND_FLAG_NO_FILE_DATA
)

5489  
	`£nd_upd©e_exã¡
(
s˘x
, 
off£t
, 
íd
 - offset);

5491 
p
 = 
	`fs_∑th_Æloc
();

5492 i‡(!
p
)

5493  -
ENOMEM
;

5494 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
, 
p
);

5495 i‡(
ªt
 < 0)

5496 
év_put_Áûuª
;

5497 
off£t
 < 
íd
) {

5498 
u64
 
Àn
 = 
	`mö
(
íd
 - 
off£t
, 
ªad_size
);

5500 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_WRITE
);

5501 i‡(
ªt
 < 0)

5503 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
p
);

5504 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_FILE_OFFSET
, 
off£t
);

5505 
ªt
 = 
	`put_d©a_hódî
(
s˘x
, 
Àn
);

5506 i‡(
ªt
 < 0)

5508 
	`mem£t
(
s˘x
->
£nd_buf
 + s˘x->
£nd_size
, 0, 
Àn
);

5509 
s˘x
->
£nd_size
 +
Àn
;

5510 
ªt
 = 
	`£nd_cmd
(
s˘x
);

5511 i‡(
ªt
 < 0)

5513 
off£t
 +
Àn
;

5515 
s˘x
->
cur_öode_√xt_wrôe_off£t
 = 
off£t
;

5516 
év_put_Áûuª
:

5517 
	`fs_∑th_‰ì
(
p
);

5518  
ªt
;

5519 
	}
}

5521 
	$£nd_ícoded_ölöe_exã¡
(
£nd_˘x
 *
s˘x
,

5522 
båfs_∑th
 *
∑th
, 
u64
 
off£t
,

5523 
u64
 
Àn
)

5525 
båfs_roŸ
 *
roŸ
 = 
s˘x
->
£nd_roŸ
;

5526 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

5527 
öode
 *inode;

5528 
fs_∑th
 *
f•©h
;

5529 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

5530 
båfs_key
 
key
;

5531 
båfs_fûe_exã¡_ôem
 *
ei
;

5532 
u64
 
øm_byãs
;

5533 
size_t
 
ölöe_size
;

5534 
ªt
;

5536 
öode
 = 
	`båfs_igë
(
fs_öfo
->
sb
, 
s˘x
->
cur_öo
, 
roŸ
);

5537 i‡(
	`IS_ERR
(
öode
))

5538  
	`PTR_ERR
(
öode
);

5540 
f•©h
 = 
	`fs_∑th_Æloc
();

5541 i‡(!
f•©h
) {

5542 
ªt
 = -
ENOMEM
;

5543 
out
;

5546 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_ENCODED_WRITE
);

5547 i‡(
ªt
 < 0)

5548 
out
;

5550 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
, 
f•©h
);

5551 i‡(
ªt
 < 0)

5552 
out
;

5554 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

5555 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_fûe_exã¡_ôem
);

5556 
øm_byãs
 = 
	`båfs_fûe_exã¡_øm_byãs
(
Àaf
, 
ei
);

5557 
ölöe_size
 = 
	`båfs_fûe_exã¡_ölöe_ôem_Àn
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

5559 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
f•©h
);

5560 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_FILE_OFFSET
, 
off£t
);

5561 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_UNENCODED_FILE_LEN
,

5562 
	`mö
(
key
.
off£t
 + 
øm_byãs
 - off£t, 
Àn
));

5563 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_UNENCODED_LEN
, 
øm_byãs
);

5564 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_UNENCODED_OFFSET
, 
off£t
 - 
key
.offset);

5565 
ªt
 = 
	`båfs_ícoded_io_com¥essi⁄_‰om_exã¡
(
fs_öfo
,

5566 
	`båfs_fûe_exã¡_com¥essi⁄
(
Àaf
, 
ei
));

5567 i‡(
ªt
 < 0)

5568 
out
;

5569 
	`TLV_PUT_U32
(
s˘x
, 
BTRFS_SEND_A_COMPRESSION
, 
ªt
);

5571 
ªt
 = 
	`put_d©a_hódî
(
s˘x
, 
ölöe_size
);

5572 i‡(
ªt
 < 0)

5573 
out
;

5574 
	`ªad_exã¡_buf„r
(
Àaf
, 
s˘x
->
£nd_buf
 + s˘x->
£nd_size
,

5575 
	`båfs_fûe_exã¡_ölöe_°¨t
(
ei
), 
ölöe_size
);

5576 
s˘x
->
£nd_size
 +
ölöe_size
;

5578 
ªt
 = 
	`£nd_cmd
(
s˘x
);

5580 
év_put_Áûuª
:

5581 
out
:

5582 
	`fs_∑th_‰ì
(
f•©h
);

5583 
	`ùut
(
öode
);

5584  
ªt
;

5585 
	}
}

5587 
	$£nd_ícoded_exã¡
(
£nd_˘x
 *
s˘x
, 
båfs_∑th
 *
∑th
,

5588 
u64
 
off£t
, u64 
Àn
)

5590 
båfs_roŸ
 *
roŸ
 = 
s˘x
->
£nd_roŸ
;

5591 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

5592 
öode
 *inode;

5593 
fs_∑th
 *
f•©h
;

5594 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

5595 
båfs_key
 
key
;

5596 
båfs_fûe_exã¡_ôem
 *
ei
;

5597 
u64
 
disk_byãƒ
, 
disk_num_byãs
;

5598 
u32
 
d©a_off£t
;

5599 
båfs_cmd_hódî
 *
hdr
;

5600 
u32
 
¸c
;

5601 
ªt
;

5603 
öode
 = 
	`båfs_igë
(
fs_öfo
->
sb
, 
s˘x
->
cur_öo
, 
roŸ
);

5604 i‡(
	`IS_ERR
(
öode
))

5605  
	`PTR_ERR
(
öode
);

5607 
f•©h
 = 
	`fs_∑th_Æloc
();

5608 i‡(!
f•©h
) {

5609 
ªt
 = -
ENOMEM
;

5610 
out
;

5613 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_ENCODED_WRITE
);

5614 i‡(
ªt
 < 0)

5615 
out
;

5617 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
, 
f•©h
);

5618 i‡(
ªt
 < 0)

5619 
out
;

5621 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

5622 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_fûe_exã¡_ôem
);

5623 
disk_byãƒ
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
ei
);

5624 
disk_num_byãs
 = 
	`båfs_fûe_exã¡_disk_num_byãs
(
Àaf
, 
ei
);

5626 
	`TLV_PUT_PATH
(
s˘x
, 
BTRFS_SEND_A_PATH
, 
f•©h
);

5627 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_FILE_OFFSET
, 
off£t
);

5628 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_UNENCODED_FILE_LEN
,

5629 
	`mö
(
key
.
off£t
 + 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
ei
) - offset,

5630 
Àn
));

5631 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_UNENCODED_LEN
,

5632 
	`båfs_fûe_exã¡_øm_byãs
(
Àaf
, 
ei
));

5633 
	`TLV_PUT_U64
(
s˘x
, 
BTRFS_SEND_A_UNENCODED_OFFSET
,

5634 
off£t
 - 
key
.off£à+ 
	`båfs_fûe_exã¡_off£t
(
Àaf
, 
ei
));

5635 
ªt
 = 
	`båfs_ícoded_io_com¥essi⁄_‰om_exã¡
(
fs_öfo
,

5636 
	`båfs_fûe_exã¡_com¥essi⁄
(
Àaf
, 
ei
));

5637 i‡(
ªt
 < 0)

5638 
out
;

5639 
	`TLV_PUT_U32
(
s˘x
, 
BTRFS_SEND_A_COMPRESSION
, 
ªt
);

5640 
	`TLV_PUT_U32
(
s˘x
, 
BTRFS_SEND_A_ENCRYPTION
, 0);

5642 
ªt
 = 
	`put_d©a_hódî
(
s˘x
, 
disk_num_byãs
);

5643 i‡(
ªt
 < 0)

5644 
out
;

5651 
d©a_off£t
 = 
	`PAGE_ALIGN
(
s˘x
->
£nd_size
);

5652 i‡(
d©a_off£t
 > 
s˘x
->
£nd_max_size
 ||

5653 
s˘x
->
£nd_max_size
 - 
d©a_off£t
 < 
disk_num_byãs
) {

5654 
ªt
 = -
EOVERFLOW
;

5655 
out
;

5662 
ªt
 = 
	`båfs_ícoded_ªad_ªguœr_fûl_∑ges
(
	`BTRFS_I
(
öode
), 
off£t
,

5663 
disk_byãƒ
, 
disk_num_byãs
,

5664 
s˘x
->
£nd_buf_∑ges
 +

5665 (
d©a_off£t
 >> 
PAGE_SHIFT
));

5666 i‡(
ªt
)

5667 
out
;

5669 
hdr
 = (
båfs_cmd_hódî
 *)
s˘x
->
£nd_buf
;

5670 
hdr
->
Àn
 = 
	`˝u_to_À32
(
s˘x
->
£nd_size
 + 
disk_num_byãs
 - (*hdr));

5671 
hdr
->
¸c
 = 0;

5672 
¸c
 = 
	`båfs_¸c32c
(0, 
s˘x
->
£nd_buf
, s˘x->
£nd_size
);

5673 
¸c
 = 
	`båfs_¸c32c
(¸c, 
s˘x
->
£nd_buf
 + 
d©a_off£t
, 
disk_num_byãs
);

5674 
hdr
->
¸c
 = 
	`˝u_to_À32
(crc);

5676 
ªt
 = 
	`wrôe_buf
(
s˘x
->
£nd_fûp
, s˘x->
£nd_buf
, s˘x->
£nd_size
,

5677 &
s˘x
->
£nd_off
);

5678 i‡(!
ªt
) {

5679 
ªt
 = 
	`wrôe_buf
(
s˘x
->
£nd_fûp
, s˘x->
£nd_buf
 + 
d©a_off£t
,

5680 
disk_num_byãs
, &
s˘x
->
£nd_off
);

5682 
s˘x
->
£nd_size
 = 0;

5683 
s˘x
->
put_d©a
 = 
Ál£
;

5685 
év_put_Áûuª
:

5686 
out
:

5687 
	`fs_∑th_‰ì
(
f•©h
);

5688 
	`ùut
(
öode
);

5689  
ªt
;

5690 
	}
}

5692 
	$£nd_exã¡_d©a
(
£nd_˘x
 *
s˘x
, 
båfs_∑th
 *
∑th
,

5693 c⁄° 
u64
 
off£t
, c⁄° u64 
Àn
)

5695 c⁄° 
u64
 
íd
 = 
off£t
 + 
Àn
;

5696 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

5697 
båfs_fûe_exã¡_ôem
 *
ei
;

5698 
u64
 
ªad_size
 = 
	`max_£nd_ªad_size
(
s˘x
);

5699 
u64
 
£¡
 = 0;

5701 i‡(
s˘x
->
Êags
 & 
BTRFS_SEND_FLAG_NO_FILE_DATA
)

5702  
	`£nd_upd©e_exã¡
(
s˘x
, 
off£t
, 
Àn
);

5704 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

5705 
båfs_fûe_exã¡_ôem
);

5706 i‡((
s˘x
->
Êags
 & 
BTRFS_SEND_FLAG_COMPRESSED
) &&

5707 
	`båfs_fûe_exã¡_com¥essi⁄
(
Àaf
, 
ei
Ë!
BTRFS_COMPRESS_NONE
) {

5708 
boﬁ
 
is_ölöe
 = (
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
ei
) ==

5709 
BTRFS_FILE_EXTENT_INLINE
);

5718 i‡(
is_ölöe
 &&

5719 
	`båfs_fûe_exã¡_ölöe_ôem_Àn
(
Àaf
,

5720 
∑th
->
¶Ÿs
[0]Ë<
Àn
) {

5721  
	`£nd_ícoded_ölöe_exã¡
(
s˘x
, 
∑th
, 
off£t
,

5722 
Àn
);

5723 } i‡(!
is_ölöe
 &&

5724 
	`båfs_fûe_exã¡_disk_num_byãs
(
Àaf
, 
ei
Ë<
Àn
) {

5725  
	`£nd_ícoded_exã¡
(
s˘x
, 
∑th
, 
off£t
, 
Àn
);

5729 i‡(
s˘x
->
cur_öode
 =
NULL
) {

5730 
båfs_roŸ
 *
roŸ
 = 
s˘x
->
£nd_roŸ
;

5732 
s˘x
->
cur_öode
 = 
	`båfs_igë
(
roŸ
->
fs_öfo
->
sb
, s˘x->
cur_öo
,Ñoot);

5733 i‡(
	`IS_ERR
(
s˘x
->
cur_öode
)) {

5734 
îr
 = 
	`PTR_ERR
(
s˘x
->
cur_öode
);

5736 
s˘x
->
cur_öode
 = 
NULL
;

5737  
îr
;

5739 
	`mem£t
(&
s˘x
->
ø
, 0, (
fûe_ø_°©e
));

5740 
	`fûe_ø_°©e_öô
(&
s˘x
->
ø
, s˘x->
cur_öode
->
i_m≠pög
);

5761 
s˘x
->
˛ón_∑ge_ˇche
 = (s˘x->
cur_öode
->
i_m≠pög
->
ƒ∑ges
 == 0);

5762 
s˘x
->
∑ge_ˇche_˛ór_°¨t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

5765 
£¡
 < 
Àn
) {

5766 
u64
 
size
 = 
	`mö
(
Àn
 - 
£¡
, 
ªad_size
);

5767 
ªt
;

5769 
ªt
 = 
	`£nd_wrôe
(
s˘x
, 
off£t
 + 
£¡
, 
size
);

5770 i‡(
ªt
 < 0)

5771  
ªt
;

5772 
£¡
 +
size
;

5775 i‡(
s˘x
->
˛ón_∑ge_ˇche
 && 
	`PAGE_ALIGNED
(
íd
)) {

5799 
	`åunˇã_öode_∑ges_ønge
(&
s˘x
->
cur_öode
->
i_d©a
,

5800 
s˘x
->
∑ge_ˇche_˛ór_°¨t
,

5801 
íd
 - 1);

5802 
s˘x
->
∑ge_ˇche_˛ór_°¨t
 = 
íd
;

5806 
	}
}

5815 
	$£nd_ˇ∑bûôõs
(
£nd_˘x
 *
s˘x
)

5817 
fs_∑th
 *
f•©h
 = 
NULL
;

5818 
båfs_∑th
 *
∑th
;

5819 
båfs_dú_ôem
 *
di
;

5820 
exã¡_buf„r
 *
Àaf
;

5821 
d©a_±r
;

5822 *
buf
 = 
NULL
;

5823 
buf_Àn
;

5824 
ªt
 = 0;

5826 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

5827 i‡(!
∑th
)

5828  -
ENOMEM
;

5830 
di
 = 
	`båfs_lookup_x©å
(
NULL
, 
s˘x
->
£nd_roŸ
, 
∑th
, s˘x->
cur_öo
,

5831 
XATTR_NAME_CAPS
, 
	`°æí
(XATTR_NAME_CAPS), 0);

5832 i‡(!
di
) {

5834 
out
;

5835 } i‡(
	`IS_ERR
(
di
)) {

5836 
ªt
 = 
	`PTR_ERR
(
di
);

5837 
out
;

5840 
Àaf
 = 
∑th
->
nodes
[0];

5841 
buf_Àn
 = 
	`båfs_dú_d©a_Àn
(
Àaf
, 
di
);

5843 
f•©h
 = 
	`fs_∑th_Æloc
();

5844 
buf
 = 
	`kmÆloc
(
buf_Àn
, 
GFP_KERNEL
);

5845 i‡(!
f•©h
 || !
buf
) {

5846 
ªt
 = -
ENOMEM
;

5847 
out
;

5850 
ªt
 = 
	`gë_cur_∑th
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
, 
f•©h
);

5851 i‡(
ªt
 < 0)

5852 
out
;

5854 
d©a_±r
 = ()(
di
 + 1Ë+ 
	`båfs_dú_«me_Àn
(
Àaf
, di);

5855 
	`ªad_exã¡_buf„r
(
Àaf
, 
buf
, 
d©a_±r
, 
buf_Àn
);

5857 
ªt
 = 
	`£nd_£t_x©å
(
s˘x
, 
f•©h
, 
XATTR_NAME_CAPS
,

5858 
	`°æí
(
XATTR_NAME_CAPS
), 
buf
, 
buf_Àn
);

5859 
out
:

5860 
	`k‰ì
(
buf
);

5861 
	`fs_∑th_‰ì
(
f•©h
);

5862 
	`båfs_‰ì_∑th
(
∑th
);

5863  
ªt
;

5864 
	}
}

5866 
	$˛⁄e_ønge
(
£nd_˘x
 *
s˘x
, 
båfs_∑th
 *
d°_∑th
,

5867 
˛⁄e_roŸ
 *˛⁄e_roŸ, c⁄° 
u64
 
disk_byã
,

5868 
u64
 
d©a_off£t
, u64 
off£t
, u64 
Àn
)

5870 
båfs_∑th
 *
∑th
;

5871 
båfs_key
 
key
;

5872 
ªt
;

5873 
båfs_öode_öfo
 
öfo
;

5874 
u64
 
˛⁄e_§c_i_size
 = 0;

5891 i‡(
˛⁄e_roŸ
->
off£t
 == 0 &&

5892 
Àn
 =
s˘x
->
£nd_roŸ
->
fs_öfo
->
£˘‹size
)

5893  
	`£nd_exã¡_d©a
(
s˘x
, 
d°_∑th
, 
off£t
, 
Àn
);

5895 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

5896 i‡(!
∑th
)

5897  -
ENOMEM
;

5903 
ªt
 = 
	`gë_öode_öfo
(
˛⁄e_roŸ
->
roŸ
, cl⁄e_roŸ->
öo
, &
öfo
);

5904 
	`båfs_ªÀa£_∑th
(
∑th
);

5905 i‡(
ªt
 < 0)

5906 
out
;

5907 
˛⁄e_§c_i_size
 = 
öfo
.
size
;

5931 
key
.
obje˘id
 = 
˛⁄e_roŸ
->
öo
;

5932 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

5933 
key
.
off£t
 = 
˛⁄e_roŸ
->offset;

5934 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
˛⁄e_roŸ
->
roŸ
, &
key
, 
∑th
, 0, 0);

5935 i‡(
ªt
 < 0)

5936 
out
;

5937 i‡(
ªt
 > 0 && 
∑th
->
¶Ÿs
[0] > 0) {

5938 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0] - 1);

5939 i‡(
key
.
obje˘id
 =
˛⁄e_roŸ
->
öo
 &&

5940 
key
.
ty≥
 =
BTRFS_EXTENT_DATA_KEY
)

5941 
∑th
->
¶Ÿs
[0]--;

5944 
åue
) {

5945 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

5946 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

5947 
båfs_fûe_exã¡_ôem
 *
ei
;

5948 
u8
 
ty≥
;

5949 
u64
 
ext_Àn
;

5950 
u64
 
˛⁄e_Àn
;

5951 
u64
 
˛⁄e_d©a_off£t
;

5952 
boﬁ
 
¸os£d_§c_i_size
 = 
Ál£
;

5954 i‡(
¶Ÿ
 >
	`båfs_hódî_ƒôems
(
Àaf
)) {

5955 
ªt
 = 
	`båfs_√xt_Àaf
(
˛⁄e_roŸ
->
roŸ
, 
∑th
);

5956 i‡(
ªt
 < 0)

5957 
out
;

5958 i‡(
ªt
 > 0)

5963 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

5969 i‡(
key
.
obje˘id
 !
˛⁄e_roŸ
->
öo
 ||

5970 
key
.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

5973 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_fûe_exã¡_ôem
);

5974 
ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
ei
);

5975 i‡(
ty≥
 =
BTRFS_FILE_EXTENT_INLINE
) {

5976 
ext_Àn
 = 
	`båfs_fûe_exã¡_øm_byãs
(
Àaf
, 
ei
);

5977 
ext_Àn
 = 
	`PAGE_ALIGN
(ext_len);

5979 
ext_Àn
 = 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
ei
);

5982 i‡(
key
.
off£t
 + 
ext_Àn
 <
˛⁄e_roŸ
->offset)

5983 
√xt
;

5985 i‡(
key
.
off£t
 > 
˛⁄e_roŸ
->offset) {

5987 
u64
 
hﬁe_Àn
 = 
key
.
off£t
 - 
˛⁄e_roŸ
->offset;

5989 i‡(
hﬁe_Àn
 > 
Àn
)

5990 
hﬁe_Àn
 = 
Àn
;

5991 
ªt
 = 
	`£nd_exã¡_d©a
(
s˘x
, 
d°_∑th
, 
off£t
,

5992 
hﬁe_Àn
);

5993 i‡(
ªt
 < 0)

5994 
out
;

5996 
Àn
 -
hﬁe_Àn
;

5997 i‡(
Àn
 == 0)

5999 
off£t
 +
hﬁe_Àn
;

6000 
˛⁄e_roŸ
->
off£t
 +
hﬁe_Àn
;

6001 
d©a_off£t
 +
hﬁe_Àn
;

6004 i‡(
key
.
off£t
 >
˛⁄e_roŸ
->off£à+ 
Àn
)

6007 i‡(
key
.
off£t
 >
˛⁄e_§c_i_size
)

6010 i‡(
key
.
off£t
 + 
ext_Àn
 > 
˛⁄e_§c_i_size
) {

6011 
ext_Àn
 = 
˛⁄e_§c_i_size
 - 
key
.
off£t
;

6012 
¸os£d_§c_i_size
 = 
åue
;

6015 
˛⁄e_d©a_off£t
 = 
	`båfs_fûe_exã¡_off£t
(
Àaf
, 
ei
);

6016 i‡(
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
ei
Ë=
disk_byã
) {

6017 
˛⁄e_roŸ
->
off£t
 = 
key
.offset;

6018 i‡(
˛⁄e_d©a_off£t
 < 
d©a_off£t
 &&

6019 
˛⁄e_d©a_off£t
 + 
ext_Àn
 > 
d©a_off£t
) {

6020 
u64
 
exã¡_off£t
;

6022 
exã¡_off£t
 = 
d©a_off£t
 - 
˛⁄e_d©a_off£t
;

6023 
ext_Àn
 -
exã¡_off£t
;

6024 
˛⁄e_d©a_off£t
 +
exã¡_off£t
;

6025 
˛⁄e_roŸ
->
off£t
 +
exã¡_off£t
;

6029 
˛⁄e_Àn
 = 
	`mö_t
(
u64
, 
ext_Àn
, 
Àn
);

6031 i‡(
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
ei
Ë=
disk_byã
 &&

6032 
˛⁄e_d©a_off£t
 =
d©a_off£t
) {

6033 c⁄° 
u64
 
§c_íd
 = 
˛⁄e_roŸ
->
off£t
 + 
˛⁄e_Àn
;

6034 c⁄° 
u64
 
£˘‹size
 = 
SZ_64K
;

6054 i‡(
§c_íd
 =
˛⁄e_§c_i_size
 &&

6055 !
	`IS_ALIGNED
(
§c_íd
, 
£˘‹size
) &&

6056 
off£t
 + 
˛⁄e_Àn
 < 
s˘x
->
cur_öode_size
) {

6057 
u64
 
¶í
;

6059 
¶í
 = 
	`ALIGN_DOWN
(
§c_íd
 - 
˛⁄e_roŸ
->
off£t
,

6060 
£˘‹size
);

6061 i‡(
¶í
 > 0) {

6062 
ªt
 = 
	`£nd_˛⁄e
(
s˘x
, 
off£t
, 
¶í
,

6063 
˛⁄e_roŸ
);

6064 i‡(
ªt
 < 0)

6065 
out
;

6067 
ªt
 = 
	`£nd_exã¡_d©a
(
s˘x
, 
d°_∑th
,

6068 
off£t
 + 
¶í
,

6069 
˛⁄e_Àn
 - 
¶í
);

6071 
ªt
 = 
	`£nd_˛⁄e
(
s˘x
, 
off£t
, 
˛⁄e_Àn
,

6072 
˛⁄e_roŸ
);

6074 } i‡(
¸os£d_§c_i_size
 && 
˛⁄e_Àn
 < 
Àn
) {

6094 
ªt
 = 
	`£nd_exã¡_d©a
(
s˘x
, 
d°_∑th
, 
off£t
,

6095 
˛⁄e_Àn
);

6098 i‡(
ªt
 < 0)

6099 
out
;

6101 
Àn
 -
˛⁄e_Àn
;

6102 i‡(
Àn
 == 0)

6104 
off£t
 +
˛⁄e_Àn
;

6105 
˛⁄e_roŸ
->
off£t
 +
˛⁄e_Àn
;

6116 i‡(
˛⁄e_roŸ
->
roŸ
 =
s˘x
->
£nd_roŸ
 &&

6117 
˛⁄e_roŸ
->
öo
 =
s˘x
->
cur_öo
 &&

6118 
˛⁄e_roŸ
->
off£t
 >
s˘x
->
cur_öode_√xt_wrôe_off£t
)

6121 
d©a_off£t
 +
˛⁄e_Àn
;

6122 
√xt
:

6123 
∑th
->
¶Ÿs
[0]++;

6126 i‡(
Àn
 > 0)

6127 
ªt
 = 
	`£nd_exã¡_d©a
(
s˘x
, 
d°_∑th
, 
off£t
, 
Àn
);

6129 
ªt
 = 0;

6130 
out
:

6131 
	`båfs_‰ì_∑th
(
∑th
);

6132  
ªt
;

6133 
	}
}

6135 
	$£nd_wrôe_‹_˛⁄e
(
£nd_˘x
 *
s˘x
,

6136 
båfs_∑th
 *
∑th
,

6137 
båfs_key
 *
key
,

6138 
˛⁄e_roŸ
 *clone_root)

6140 
ªt
 = 0;

6141 
u64
 
off£t
 = 
key
->offset;

6142 
u64
 
íd
;

6143 
u64
 
bs
 = 
s˘x
->
£nd_roŸ
->
fs_öfo
->
sb
->
s_blocksize
;

6145 
íd
 = 
	`mö_t
(
u64
, 
	`båfs_fûe_exã¡_íd
(
∑th
), 
s˘x
->
cur_öode_size
);

6146 i‡(
off£t
 >
íd
)

6149 i‡(
˛⁄e_roŸ
 && 
	`IS_ALIGNED
(
íd
, 
bs
)) {

6150 
båfs_fûe_exã¡_ôem
 *
ei
;

6151 
u64
 
disk_byã
;

6152 
u64
 
d©a_off£t
;

6154 
ei
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

6155 
båfs_fûe_exã¡_ôem
);

6156 
disk_byã
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
∑th
->
nodes
[0], 
ei
);

6157 
d©a_off£t
 = 
	`båfs_fûe_exã¡_off£t
(
∑th
->
nodes
[0], 
ei
);

6158 
ªt
 = 
	`˛⁄e_ønge
(
s˘x
, 
∑th
, 
˛⁄e_roŸ
, 
disk_byã
,

6159 
d©a_off£t
, 
off£t
, 
íd
 - offset);

6161 
ªt
 = 
	`£nd_exã¡_d©a
(
s˘x
, 
∑th
, 
off£t
, 
íd
 - offset);

6163 
s˘x
->
cur_öode_√xt_wrôe_off£t
 = 
íd
;

6164  
ªt
;

6165 
	}
}

6167 
	$is_exã¡_unch™ged
(
£nd_˘x
 *
s˘x
,

6168 
båfs_∑th
 *
À·_∑th
,

6169 
båfs_key
 *
ekey
)

6171 
ªt
 = 0;

6172 
båfs_key
 
key
;

6173 
båfs_∑th
 *
∑th
 = 
NULL
;

6174 
exã¡_buf„r
 *
eb
;

6175 
¶Ÿ
;

6176 
båfs_key
 
found_key
;

6177 
båfs_fûe_exã¡_ôem
 *
ei
;

6178 
u64
 
À·_diskƒ
;

6179 
u64
 
right_diskƒ
;

6180 
u64
 
À·_off£t
;

6181 
u64
 
right_off£t
;

6182 
u64
 
À·_off£t_fixed
;

6183 
u64
 
À·_Àn
;

6184 
u64
 
right_Àn
;

6185 
u64
 
À·_gí
;

6186 
u64
 
right_gí
;

6187 
u8
 
À·_ty≥
;

6188 
u8
 
right_ty≥
;

6190 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

6191 i‡(!
∑th
)

6192  -
ENOMEM
;

6194 
eb
 = 
À·_∑th
->
nodes
[0];

6195 
¶Ÿ
 = 
À·_∑th
->
¶Ÿs
[0];

6196 
ei
 = 
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
, 
båfs_fûe_exã¡_ôem
);

6197 
À·_ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
eb
, 
ei
);

6199 i‡(
À·_ty≥
 !
BTRFS_FILE_EXTENT_REG
) {

6200 
ªt
 = 0;

6201 
out
;

6203 
À·_diskƒ
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
eb
, 
ei
);

6204 
À·_Àn
 = 
	`båfs_fûe_exã¡_num_byãs
(
eb
, 
ei
);

6205 
À·_off£t
 = 
	`båfs_fûe_exã¡_off£t
(
eb
, 
ei
);

6206 
À·_gí
 = 
	`båfs_fûe_exã¡_gíî©i⁄
(
eb
, 
ei
);

6229 
key
.
obje˘id
 = 
ekey
->objectid;

6230 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

6231 
key
.
off£t
 = 
ekey
->offset;

6232 
ªt
 = 
	`båfs_£¨ch_¶Ÿ_f‹_ªad
(
s˘x
->
∑ª¡_roŸ
, &
key
, 
∑th
, 0, 0);

6233 i‡(
ªt
 < 0)

6234 
out
;

6235 i‡(
ªt
) {

6236 
ªt
 = 0;

6237 
out
;

6243 
eb
 = 
∑th
->
nodes
[0];

6244 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

6245 
	`båfs_ôem_key_to_˝u
(
eb
, &
found_key
, 
¶Ÿ
);

6246 i‡(
found_key
.
obje˘id
 !
key
.objectid ||

6247 
found_key
.
ty≥
 !
key
.type) {

6249 
ªt
 = (
À·_diskƒ
) ? 0 : 1;

6250 
out
;

6256 
key
 = 
found_key
;

6257 
key
.
off£t
 < 
ekey
->off£à+ 
À·_Àn
) {

6258 
ei
 = 
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
, 
båfs_fûe_exã¡_ôem
);

6259 
right_ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
eb
, 
ei
);

6260 i‡(
right_ty≥
 !
BTRFS_FILE_EXTENT_REG
 &&

6261 
right_ty≥
 !
BTRFS_FILE_EXTENT_INLINE
) {

6262 
ªt
 = 0;

6263 
out
;

6266 i‡(
right_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
) {

6267 
right_Àn
 = 
	`båfs_fûe_exã¡_øm_byãs
(
eb
, 
ei
);

6268 
right_Àn
 = 
	`PAGE_ALIGN
(right_len);

6270 
right_Àn
 = 
	`båfs_fûe_exã¡_num_byãs
(
eb
, 
ei
);

6277 i‡(
found_key
.
off£t
 + 
right_Àn
 <
ekey
->offset) {

6279 
ªt
 = (
À·_diskƒ
) ? 0 : 1;

6280 
out
;

6291 i‡(
right_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
) {

6292 
ªt
 = 0;

6293 
out
;

6296 
right_diskƒ
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
eb
, 
ei
);

6297 
right_off£t
 = 
	`båfs_fûe_exã¡_off£t
(
eb
, 
ei
);

6298 
right_gí
 = 
	`båfs_fûe_exã¡_gíî©i⁄
(
eb
, 
ei
);

6300 
À·_off£t_fixed
 = 
À·_off£t
;

6301 i‡(
key
.
off£t
 < 
ekey
->offset) {

6303 
right_off£t
 +
ekey
->
off£t
 - 
key
.offset;

6306 
À·_off£t_fixed
 +
key
.
off£t
 - 
ekey
->offset;

6312 i‡(
À·_diskƒ
 !
right_diskƒ
 ||

6313 
À·_off£t_fixed
 !
right_off£t
 ||

6314 
À·_gí
 !
right_gí
) {

6315 
ªt
 = 0;

6316 
out
;

6322 
ªt
 = 
	`båfs_√xt_ôem
(
s˘x
->
∑ª¡_roŸ
, 
∑th
);

6323 i‡(
ªt
 < 0)

6324 
out
;

6325 i‡(!
ªt
) {

6326 
eb
 = 
∑th
->
nodes
[0];

6327 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

6328 
	`båfs_ôem_key_to_˝u
(
eb
, &
found_key
, 
¶Ÿ
);

6330 i‡(
ªt
 || 
found_key
.
obje˘id
 !
key
.objectid ||

6331 
found_key
.
ty≥
 !
key
.type) {

6332 
key
.
off£t
 +
right_Àn
;

6335 i‡(
found_key
.
off£t
 !
key
.off£à+ 
right_Àn
) {

6336 
ªt
 = 0;

6337 
out
;

6339 
key
 = 
found_key
;

6346 i‡(
key
.
off£t
 >
ekey
->off£à+ 
À·_Àn
)

6347 
ªt
 = 1;

6349 
ªt
 = 0;

6352 
out
:

6353 
	`båfs_‰ì_∑th
(
∑th
);

6354  
ªt
;

6355 
	}
}

6357 
	$gë_œ°_exã¡
(
£nd_˘x
 *
s˘x
, 
u64
 
off£t
)

6359 
båfs_∑th
 *
∑th
;

6360 
båfs_roŸ
 *
roŸ
 = 
s˘x
->
£nd_roŸ
;

6361 
båfs_key
 
key
;

6362 
ªt
;

6364 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

6365 i‡(!
∑th
)

6366  -
ENOMEM
;

6368 
s˘x
->
cur_öode_œ°_exã¡
 = 0;

6370 
key
.
obje˘id
 = 
s˘x
->
cur_öo
;

6371 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

6372 
key
.
off£t
 = offset;

6373 
ªt
 = 
	`båfs_£¨ch_¶Ÿ_f‹_ªad
(
roŸ
, &
key
, 
∑th
, 0, 1);

6374 i‡(
ªt
 < 0)

6375 
out
;

6376 
ªt
 = 0;

6377 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

6378 i‡(
key
.
obje˘id
 !
s˘x
->
cur_öo
 || key.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

6379 
out
;

6381 
s˘x
->
cur_öode_œ°_exã¡
 = 
	`båfs_fûe_exã¡_íd
(
∑th
);

6382 
out
:

6383 
	`båfs_‰ì_∑th
(
∑th
);

6384  
ªt
;

6385 
	}
}

6387 
	$ønge_is_hﬁe_ö_∑ª¡
(
£nd_˘x
 *
s˘x
,

6388 c⁄° 
u64
 
°¨t
,

6389 c⁄° 
u64
 
íd
)

6391 
båfs_∑th
 *
∑th
;

6392 
båfs_key
 
key
;

6393 
båfs_roŸ
 *
roŸ
 = 
s˘x
->
∑ª¡_roŸ
;

6394 
u64
 
£¨ch_°¨t
 = 
°¨t
;

6395 
ªt
;

6397 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

6398 i‡(!
∑th
)

6399  -
ENOMEM
;

6401 
key
.
obje˘id
 = 
s˘x
->
cur_öo
;

6402 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

6403 
key
.
off£t
 = 
£¨ch_°¨t
;

6404 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

6405 i‡(
ªt
 < 0)

6406 
out
;

6407 i‡(
ªt
 > 0 && 
∑th
->
¶Ÿs
[0] > 0)

6408 
∑th
->
¶Ÿs
[0]--;

6410 
£¨ch_°¨t
 < 
íd
) {

6411 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

6412 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

6413 
båfs_fûe_exã¡_ôem
 *
fi
;

6414 
u64
 
exã¡_íd
;

6416 i‡(
¶Ÿ
 >
	`båfs_hódî_ƒôems
(
Àaf
)) {

6417 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

6418 i‡(
ªt
 < 0)

6419 
out
;

6420 i‡(
ªt
 > 0)

6425 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

6426 i‡(
key
.
obje˘id
 < 
s˘x
->
cur_öo
 ||

6427 
key
.
ty≥
 < 
BTRFS_EXTENT_DATA_KEY
)

6428 
√xt
;

6429 i‡(
key
.
obje˘id
 > 
s˘x
->
cur_öo
 ||

6430 
key
.
ty≥
 > 
BTRFS_EXTENT_DATA_KEY
 ||

6431 
key
.
off£t
 >
íd
)

6434 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_fûe_exã¡_ôem
);

6435 
exã¡_íd
 = 
	`båfs_fûe_exã¡_íd
(
∑th
);

6436 i‡(
exã¡_íd
 <
°¨t
)

6437 
√xt
;

6438 i‡(
	`båfs_fûe_exã¡_disk_byãƒ
(
Àaf
, 
fi
) == 0) {

6439 
£¨ch_°¨t
 = 
exã¡_íd
;

6440 
√xt
;

6442 
ªt
 = 0;

6443 
out
;

6444 
√xt
:

6445 
∑th
->
¶Ÿs
[0]++;

6447 
ªt
 = 1;

6448 
out
:

6449 
	`båfs_‰ì_∑th
(
∑th
);

6450  
ªt
;

6451 
	}
}

6453 
	$maybe_£nd_hﬁe
(
£nd_˘x
 *
s˘x
, 
båfs_∑th
 *
∑th
,

6454 
båfs_key
 *
key
)

6456 
ªt
 = 0;

6458 i‡(
s˘x
->
cur_öo
 !
key
->
obje˘id
 || !
	`√ed_£nd_hﬁe
(sctx))

6461 i‡(
s˘x
->
cur_öode_œ°_exã¡
 =(
u64
)-1) {

6462 
ªt
 = 
	`gë_œ°_exã¡
(
s˘x
, 
key
->
off£t
 - 1);

6463 i‡(
ªt
)

6464  
ªt
;

6467 i‡(
∑th
->
¶Ÿs
[0] == 0 &&

6468 
s˘x
->
cur_öode_œ°_exã¡
 < 
key
->
off£t
) {

6476 
ªt
 = 
	`gë_œ°_exã¡
(
s˘x
, 
key
->
off£t
 - 1);

6477 i‡(
ªt
)

6478  
ªt
;

6481 i‡(
s˘x
->
cur_öode_œ°_exã¡
 < 
key
->
off£t
) {

6482 
ªt
 = 
	`ønge_is_hﬁe_ö_∑ª¡
(
s˘x
,

6483 
s˘x
->
cur_öode_œ°_exã¡
,

6484 
key
->
off£t
);

6485 i‡(
ªt
 < 0)

6486  
ªt
;

6487 i‡(
ªt
 == 0)

6488 
ªt
 = 
	`£nd_hﬁe
(
s˘x
, 
key
->
off£t
);

6490 
ªt
 = 0;

6492 
s˘x
->
cur_öode_œ°_exã¡
 = 
	`båfs_fûe_exã¡_íd
(
∑th
);

6493  
ªt
;

6494 
	}
}

6496 
	$¥o˚ss_exã¡
(
£nd_˘x
 *
s˘x
,

6497 
båfs_∑th
 *
∑th
,

6498 
båfs_key
 *
key
)

6500 
˛⁄e_roŸ
 *
found_˛⁄e
 = 
NULL
;

6501 
ªt
 = 0;

6503 i‡(
	`S_ISLNK
(
s˘x
->
cur_öode_mode
))

6506 i‡(
s˘x
->
∑ª¡_roŸ
 && !s˘x->
cur_öode_√w
) {

6507 
ªt
 = 
	`is_exã¡_unch™ged
(
s˘x
, 
∑th
, 
key
);

6508 i‡(
ªt
 < 0)

6509 
out
;

6510 i‡(
ªt
) {

6511 
ªt
 = 0;

6512 
out_hﬁe
;

6515 
båfs_fûe_exã¡_ôem
 *
ei
;

6516 
u8
 
ty≥
;

6518 
ei
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

6519 
båfs_fûe_exã¡_ôem
);

6520 
ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
∑th
->
nodes
[0], 
ei
);

6521 i‡(
ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
 ||

6522 
ty≥
 =
BTRFS_FILE_EXTENT_REG
) {

6529 i‡(
ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
) {

6530 
ªt
 = 0;

6531 
out
;

6535 i‡(
	`båfs_fûe_exã¡_disk_byãƒ
(
∑th
->
nodes
[0], 
ei
) == 0) {

6536 
ªt
 = 0;

6537 
out
;

6542 
ªt
 = 
	`föd_exã¡_˛⁄e
(
s˘x
, 
∑th
, 
key
->
obje˘id
, key->
off£t
,

6543 
s˘x
->
cur_öode_size
, &
found_˛⁄e
);

6544 i‡(
ªt
 !-
ENOENT
 &&Ñet < 0)

6545 
out
;

6547 
ªt
 = 
	`£nd_wrôe_‹_˛⁄e
(
s˘x
, 
∑th
, 
key
, 
found_˛⁄e
);

6548 i‡(
ªt
)

6549 
out
;

6550 
out_hﬁe
:

6551 
ªt
 = 
	`maybe_£nd_hﬁe
(
s˘x
, 
∑th
, 
key
);

6552 
out
:

6553  
ªt
;

6554 
	}
}

6556 
	$¥o˚ss_Æl_exã¡s
(
£nd_˘x
 *
s˘x
)

6558 
ªt
 = 0;

6559 
ôî_ªt
 = 0;

6560 
båfs_roŸ
 *
roŸ
;

6561 
båfs_∑th
 *
∑th
;

6562 
båfs_key
 
key
;

6563 
båfs_key
 
found_key
;

6565 
roŸ
 = 
s˘x
->
£nd_roŸ
;

6566 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

6567 i‡(!
∑th
)

6568  -
ENOMEM
;

6570 
key
.
obje˘id
 = 
s˘x
->
cmp_key
->objectid;

6571 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

6572 
key
.
off£t
 = 0;

6573 
	`båfs_f‹_óch_¶Ÿ
(
roŸ
, &
key
, &
found_key
, 
∑th
, 
ôî_ªt
) {

6574 i‡(
found_key
.
obje˘id
 !
key
.objectid ||

6575 
found_key
.
ty≥
 !
key
.type) {

6576 
ªt
 = 0;

6580 
ªt
 = 
	`¥o˚ss_exã¡
(
s˘x
, 
∑th
, &
found_key
);

6581 i‡(
ªt
 < 0)

6585 i‡(
ôî_ªt
 < 0)

6586 
ªt
 = 
ôî_ªt
;

6588 
	`båfs_‰ì_∑th
(
∑th
);

6589  
ªt
;

6590 
	}
}

6592 
	$¥o˚ss_ªc‹ded_ªfs_if_√eded
(
£nd_˘x
 *
s˘x
, 
©_íd
,

6593 *
≥ndög_move
,

6594 *
ªfs_¥o˚s£d
)

6596 
ªt
 = 0;

6598 i‡(
s˘x
->
cur_öo
 == 0)

6599 
out
;

6600 i‡(!
©_íd
 && 
s˘x
->
cur_öo
 =s˘x->
cmp_key
->
obje˘id
 &&

6601 
s˘x
->
cmp_key
->
ty≥
 <
BTRFS_INODE_EXTREF_KEY
)

6602 
out
;

6603 i‡(
	`li°_em±y
(&
s˘x
->
√w_ªfs
Ë&&Üi°_em±y(&s˘x->
dñëed_ªfs
))

6604 
out
;

6606 
ªt
 = 
	`¥o˚ss_ªc‹ded_ªfs
(
s˘x
, 
≥ndög_move
);

6607 i‡(
ªt
 < 0)

6608 
out
;

6610 *
ªfs_¥o˚s£d
 = 1;

6611 
out
:

6612  
ªt
;

6613 
	}
}

6615 
	$föish_öode_if_√eded
(
£nd_˘x
 *
s˘x
, 
©_íd
)

6617 
ªt
 = 0;

6618 
båfs_öode_öfo
 
öfo
;

6619 
u64
 
À·_mode
;

6620 
u64
 
À·_uid
;

6621 
u64
 
À·_gid
;

6622 
u64
 
À·_fûóâr
;

6623 
u64
 
right_mode
;

6624 
u64
 
right_uid
;

6625 
u64
 
right_gid
;

6626 
u64
 
right_fûóâr
;

6627 
√ed_chmod
 = 0;

6628 
√ed_chown
 = 0;

6629 
boﬁ
 
√ed_fûóâr
 = 
Ál£
;

6630 
√ed_åunˇã
 = 1;

6631 
≥ndög_move
 = 0;

6632 
ªfs_¥o˚s£d
 = 0;

6634 i‡(
s˘x
->
ign‹e_cur_öode
)

6637 
ªt
 = 
	`¥o˚ss_ªc‹ded_ªfs_if_√eded
(
s˘x
, 
©_íd
, &
≥ndög_move
,

6638 &
ªfs_¥o˚s£d
);

6639 i‡(
ªt
 < 0)

6640 
out
;

6654 i‡(
ªfs_¥o˚s£d
 && !
≥ndög_move
)

6655 
s˘x
->
£nd_¥ogªss
 = s˘x->
cur_öo
 + 1;

6657 i‡(
s˘x
->
cur_öo
 =0 || s˘x->
cur_öode_dñëed
)

6658 
out
;

6659 i‡(!
©_íd
 && 
s˘x
->
cmp_key
->
obje˘id
 =s˘x->
cur_öo
)

6660 
out
;

6661 
ªt
 = 
	`gë_öode_öfo
(
s˘x
->
£nd_roŸ
, s˘x->
cur_öo
, &
öfo
);

6662 i‡(
ªt
 < 0)

6663 
out
;

6664 
À·_mode
 = 
öfo
.
mode
;

6665 
À·_uid
 = 
öfo
.
uid
;

6666 
À·_gid
 = 
öfo
.
gid
;

6667 
À·_fûóâr
 = 
öfo
.
fûóâr
;

6669 i‡(!
s˘x
->
∑ª¡_roŸ
 || s˘x->
cur_öode_√w
) {

6670 
√ed_chown
 = 1;

6671 i‡(!
	`S_ISLNK
(
s˘x
->
cur_öode_mode
))

6672 
√ed_chmod
 = 1;

6673 i‡(
s˘x
->
cur_öode_√xt_wrôe_off£t
 =s˘x->
cur_öode_size
)

6674 
√ed_åunˇã
 = 0;

6676 
u64
 
ﬁd_size
;

6678 
ªt
 = 
	`gë_öode_öfo
(
s˘x
->
∑ª¡_roŸ
, s˘x->
cur_öo
, &
öfo
);

6679 i‡(
ªt
 < 0)

6680 
out
;

6681 
ﬁd_size
 = 
öfo
.
size
;

6682 
right_mode
 = 
öfo
.
mode
;

6683 
right_uid
 = 
öfo
.
uid
;

6684 
right_gid
 = 
öfo
.
gid
;

6685 
right_fûóâr
 = 
öfo
.
fûóâr
;

6687 i‡(
À·_uid
 !
right_uid
 || 
À·_gid
 !
right_gid
)

6688 
√ed_chown
 = 1;

6689 i‡(!
	`S_ISLNK
(
s˘x
->
cur_öode_mode
Ë&& 
À·_mode
 !
right_mode
)

6690 
√ed_chmod
 = 1;

6691 i‡(!
	`S_ISLNK
(
s˘x
->
cur_öode_mode
Ë&& 
À·_fûóâr
 !
right_fûóâr
)

6692 
√ed_fûóâr
 = 
åue
;

6693 i‡((
ﬁd_size
 =
s˘x
->
cur_öode_size
) ||

6694 (
s˘x
->
cur_öode_size
 > 
ﬁd_size
 &&

6695 
s˘x
->
cur_öode_√xt_wrôe_off£t
 =s˘x->
cur_öode_size
))

6696 
√ed_åunˇã
 = 0;

6699 i‡(
	`S_ISREG
(
s˘x
->
cur_öode_mode
)) {

6700 i‡(
	`√ed_£nd_hﬁe
(
s˘x
)) {

6701 i‡(
s˘x
->
cur_öode_œ°_exã¡
 =(
u64
)-1 ||

6702 
s˘x
->
cur_öode_œ°_exã¡
 <

6703 
s˘x
->
cur_öode_size
) {

6704 
ªt
 = 
	`gë_œ°_exã¡
(
s˘x
, (
u64
)-1);

6705 i‡(
ªt
)

6706 
out
;

6708 i‡(
s˘x
->
cur_öode_œ°_exã¡
 <

6709 
s˘x
->
cur_öode_size
) {

6710 
ªt
 = 
	`£nd_hﬁe
(
s˘x
, s˘x->
cur_öode_size
);

6711 i‡(
ªt
)

6712 
out
;

6715 i‡(
√ed_åunˇã
) {

6716 
ªt
 = 
	`£nd_åunˇã
(
s˘x
, s˘x->
cur_öo
,

6717 
s˘x
->
cur_öode_gí
,

6718 
s˘x
->
cur_öode_size
);

6719 i‡(
ªt
 < 0)

6720 
out
;

6724 i‡(
√ed_chown
) {

6725 
ªt
 = 
	`£nd_chown
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
,

6726 
À·_uid
, 
À·_gid
);

6727 i‡(
ªt
 < 0)

6728 
out
;

6730 i‡(
√ed_chmod
) {

6731 
ªt
 = 
	`£nd_chmod
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
,

6732 
À·_mode
);

6733 i‡(
ªt
 < 0)

6734 
out
;

6736 i‡(
√ed_fûóâr
) {

6737 
ªt
 = 
	`£nd_fûóâr
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
,

6738 
À·_fûóâr
);

6739 i‡(
ªt
 < 0)

6740 
out
;

6743 i‡(
	`¥Ÿo_cmd_ok
(
s˘x
, 
BTRFS_SEND_C_ENABLE_VERITY
)

6744 && 
s˘x
->
cur_öode_√eds_vîôy
) {

6745 
ªt
 = 
	`¥o˚ss_vîôy
(
s˘x
);

6746 i‡(
ªt
 < 0)

6747 
out
;

6750 
ªt
 = 
	`£nd_ˇ∑bûôõs
(
s˘x
);

6751 i‡(
ªt
 < 0)

6752 
out
;

6758 i‡(!
	`is_waôög_f‹_move
(
s˘x
, s˘x->
cur_öo
)) {

6759 
ªt
 = 
	`≠∂y_chûdªn_dú_moves
(
s˘x
);

6760 i‡(
ªt
)

6761 
out
;

6769 
s˘x
->
£nd_¥ogªss
 = s˘x->
cur_öo
 + 1;

6777 i‡(
	`S_ISDIR
(
s˘x
->
cur_öode_mode
Ë&& s˘x->
cur_öode_size
 > 0)

6778 
ªt
 = 
	`ˇche_dú_utimes
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
);

6780 
ªt
 = 
	`£nd_utimes
(
s˘x
, s˘x->
cur_öo
, s˘x->
cur_öode_gí
);

6782 i‡(
ªt
 < 0)

6783 
out
;

6786 
out
:

6787 i‡(!
ªt
)

6788 
ªt
 = 
	`åim_dú_utimes_ˇche
(
s˘x
);

6790  
ªt
;

6791 
	}
}

6793 
	$˛o£_cuºít_öode
(
£nd_˘x
 *
s˘x
)

6795 
u64
 
i_size
;

6797 i‡(
s˘x
->
cur_öode
 =
NULL
)

6800 
i_size
 = 
	`i_size_ªad
(
s˘x
->
cur_öode
);

6808 i‡(
s˘x
->
˛ón_∑ge_ˇche
 && s˘x->
∑ge_ˇche_˛ór_°¨t
 < 
i_size
)

6809 
	`åunˇã_öode_∑ges_ønge
(&
s˘x
->
cur_öode
->
i_d©a
,

6810 
s˘x
->
∑ge_ˇche_˛ór_°¨t
,

6811 
	`round_up
(
i_size
, 
PAGE_SIZE
) - 1);

6813 
	`ùut
(
s˘x
->
cur_öode
);

6814 
s˘x
->
cur_öode
 = 
NULL
;

6815 
	}
}

6817 
	$ch™ged_öode
(
£nd_˘x
 *
s˘x
,

6818 
båfs_com∑ª_åì_ªsu…
 
ªsu…
)

6820 
ªt
 = 0;

6821 
båfs_key
 *
key
 = 
s˘x
->
cmp_key
;

6822 
båfs_öode_ôem
 *
À·_ii
 = 
NULL
;

6823 
båfs_öode_ôem
 *
right_ii
 = 
NULL
;

6824 
u64
 
À·_gí
 = 0;

6825 
u64
 
right_gí
 = 0;

6827 
	`˛o£_cuºít_öode
(
s˘x
);

6829 
s˘x
->
cur_öo
 = 
key
->
obje˘id
;

6830 
s˘x
->
cur_öode_√w_gí
 = 
Ál£
;

6831 
s˘x
->
cur_öode_œ°_exã¡
 = (
u64
)-1;

6832 
s˘x
->
cur_öode_√xt_wrôe_off£t
 = 0;

6833 
s˘x
->
ign‹e_cur_öode
 = 
Ál£
;

6840 
s˘x
->
£nd_¥ogªss
 = s˘x->
cur_öo
;

6842 i‡(
ªsu…
 =
BTRFS_COMPARE_TREE_NEW
 ||

6843 
ªsu…
 =
BTRFS_COMPARE_TREE_CHANGED
) {

6844 
À·_ii
 = 
	`båfs_ôem_±r
(
s˘x
->
À·_∑th
->
nodes
[0],

6845 
s˘x
->
À·_∑th
->
¶Ÿs
[0],

6846 
båfs_öode_ôem
);

6847 
À·_gí
 = 
	`båfs_öode_gíî©i⁄
(
s˘x
->
À·_∑th
->
nodes
[0],

6848 
À·_ii
);

6850 
right_ii
 = 
	`båfs_ôem_±r
(
s˘x
->
right_∑th
->
nodes
[0],

6851 
s˘x
->
right_∑th
->
¶Ÿs
[0],

6852 
båfs_öode_ôem
);

6853 
right_gí
 = 
	`båfs_öode_gíî©i⁄
(
s˘x
->
right_∑th
->
nodes
[0],

6854 
right_ii
);

6856 i‡(
ªsu…
 =
BTRFS_COMPARE_TREE_CHANGED
) {

6857 
right_ii
 = 
	`båfs_ôem_±r
(
s˘x
->
right_∑th
->
nodes
[0],

6858 
s˘x
->
right_∑th
->
¶Ÿs
[0],

6859 
båfs_öode_ôem
);

6861 
right_gí
 = 
	`båfs_öode_gíî©i⁄
(
s˘x
->
right_∑th
->
nodes
[0],

6862 
right_ii
);

6869 i‡(
À·_gí
 !
right_gí
 &&

6870 
s˘x
->
cur_öo
 !
BTRFS_FIRST_FREE_OBJECTID
)

6871 
s˘x
->
cur_öode_√w_gí
 = 
åue
;

6908 i‡(
ªsu…
 =
BTRFS_COMPARE_TREE_NEW
) {

6909 i‡(
	`båfs_öode_∆ök
(
s˘x
->
À·_∑th
->
nodes
[0], 
À·_ii
) == 0) {

6910 
s˘x
->
ign‹e_cur_öode
 = 
åue
;

6911 
out
;

6913 
s˘x
->
cur_öode_gí
 = 
À·_gí
;

6914 
s˘x
->
cur_öode_√w
 = 
åue
;

6915 
s˘x
->
cur_öode_dñëed
 = 
Ál£
;

6916 
s˘x
->
cur_öode_size
 = 
	`båfs_öode_size
(

6917 
s˘x
->
À·_∑th
->
nodes
[0], 
À·_ii
);

6918 
s˘x
->
cur_öode_mode
 = 
	`båfs_öode_mode
(

6919 
s˘x
->
À·_∑th
->
nodes
[0], 
À·_ii
);

6920 
s˘x
->
cur_öode_rdev
 = 
	`båfs_öode_rdev
(

6921 
s˘x
->
À·_∑th
->
nodes
[0], 
À·_ii
);

6922 i‡(
s˘x
->
cur_öo
 !
BTRFS_FIRST_FREE_OBJECTID
)

6923 
ªt
 = 
	`£nd_¸óã_öode_if_√eded
(
s˘x
);

6924 } i‡(
ªsu…
 =
BTRFS_COMPARE_TREE_DELETED
) {

6925 
s˘x
->
cur_öode_gí
 = 
right_gí
;

6926 
s˘x
->
cur_öode_√w
 = 
Ál£
;

6927 
s˘x
->
cur_öode_dñëed
 = 
åue
;

6928 
s˘x
->
cur_öode_size
 = 
	`båfs_öode_size
(

6929 
s˘x
->
right_∑th
->
nodes
[0], 
right_ii
);

6930 
s˘x
->
cur_öode_mode
 = 
	`båfs_öode_mode
(

6931 
s˘x
->
right_∑th
->
nodes
[0], 
right_ii
);

6932 } i‡(
ªsu…
 =
BTRFS_COMPARE_TREE_CHANGED
) {

6933 
u32
 
√w_∆öks
, 
ﬁd_∆öks
;

6935 
√w_∆öks
 = 
	`båfs_öode_∆ök
(
s˘x
->
À·_∑th
->
nodes
[0], 
À·_ii
);

6936 
ﬁd_∆öks
 = 
	`båfs_öode_∆ök
(
s˘x
->
right_∑th
->
nodes
[0], 
right_ii
);

6937 i‡(
√w_∆öks
 =0 && 
ﬁd_∆öks
 == 0) {

6938 
s˘x
->
ign‹e_cur_öode
 = 
åue
;

6939 
out
;

6940 } i‡(
√w_∆öks
 =0 || 
ﬁd_∆öks
 == 0) {

6941 
s˘x
->
cur_öode_√w_gí
 = 1;

6950 i‡(
s˘x
->
cur_öode_√w_gí
) {

6954 i‡(
ﬁd_∆öks
 > 0) {

6955 
s˘x
->
cur_öode_gí
 = 
right_gí
;

6956 
s˘x
->
cur_öode_√w
 = 
Ál£
;

6957 
s˘x
->
cur_öode_dñëed
 = 
åue
;

6958 
s˘x
->
cur_öode_size
 = 
	`båfs_öode_size
(

6959 
s˘x
->
right_∑th
->
nodes
[0], 
right_ii
);

6960 
s˘x
->
cur_öode_mode
 = 
	`båfs_öode_mode
(

6961 
s˘x
->
right_∑th
->
nodes
[0], 
right_ii
);

6962 
ªt
 = 
	`¥o˚ss_Æl_ªfs
(
s˘x
,

6963 
BTRFS_COMPARE_TREE_DELETED
);

6964 i‡(
ªt
 < 0)

6965 
out
;

6971 i‡(
√w_∆öks
 > 0) {

6972 
s˘x
->
cur_öode_gí
 = 
À·_gí
;

6973 
s˘x
->
cur_öode_√w
 = 
åue
;

6974 
s˘x
->
cur_öode_dñëed
 = 
Ál£
;

6975 
s˘x
->
cur_öode_size
 = 
	`båfs_öode_size
(

6976 
s˘x
->
À·_∑th
->
nodes
[0],

6977 
À·_ii
);

6978 
s˘x
->
cur_öode_mode
 = 
	`båfs_öode_mode
(

6979 
s˘x
->
À·_∑th
->
nodes
[0],

6980 
À·_ii
);

6981 
s˘x
->
cur_öode_rdev
 = 
	`båfs_öode_rdev
(

6982 
s˘x
->
À·_∑th
->
nodes
[0],

6983 
À·_ii
);

6984 
ªt
 = 
	`£nd_¸óã_öode_if_√eded
(
s˘x
);

6985 i‡(
ªt
 < 0)

6986 
out
;

6988 
ªt
 = 
	`¥o˚ss_Æl_ªfs
(
s˘x
, 
BTRFS_COMPARE_TREE_NEW
);

6989 i‡(
ªt
 < 0)

6990 
out
;

6996 
s˘x
->
£nd_¥ogªss
 = s˘x->
cur_öo
 + 1;

7002 
ªt
 = 
	`¥o˚ss_Æl_exã¡s
(
s˘x
);

7003 i‡(
ªt
 < 0)

7004 
out
;

7005 
ªt
 = 
	`¥o˚ss_Æl_√w_x©ås
(
s˘x
);

7006 i‡(
ªt
 < 0)

7007 
out
;

7010 
s˘x
->
cur_öode_gí
 = 
À·_gí
;

7011 
s˘x
->
cur_öode_√w
 = 
Ál£
;

7012 
s˘x
->
cur_öode_√w_gí
 = 
Ál£
;

7013 
s˘x
->
cur_öode_dñëed
 = 
Ál£
;

7014 
s˘x
->
cur_öode_size
 = 
	`båfs_öode_size
(

7015 
s˘x
->
À·_∑th
->
nodes
[0], 
À·_ii
);

7016 
s˘x
->
cur_öode_mode
 = 
	`båfs_öode_mode
(

7017 
s˘x
->
À·_∑th
->
nodes
[0], 
À·_ii
);

7021 
out
:

7022  
ªt
;

7023 
	}
}

7035 
	$ch™ged_ªf
(
£nd_˘x
 *
s˘x
,

7036 
båfs_com∑ª_åì_ªsu…
 
ªsu…
)

7038 
ªt
 = 0;

7040 i‡(
s˘x
->
cur_öo
 !s˘x->
cmp_key
->
obje˘id
) {

7041 
	`öc⁄si°ít_¢≠shŸ_îr‹
(
s˘x
, 
ªsu…
, "reference");

7042  -
EIO
;

7045 i‡(!
s˘x
->
cur_öode_√w_gí
 &&

7046 
s˘x
->
cur_öo
 !
BTRFS_FIRST_FREE_OBJECTID
) {

7047 i‡(
ªsu…
 =
BTRFS_COMPARE_TREE_NEW
)

7048 
ªt
 = 
	`ªc‹d_√w_ªf
(
s˘x
);

7049 i‡(
ªsu…
 =
BTRFS_COMPARE_TREE_DELETED
)

7050 
ªt
 = 
	`ªc‹d_dñëed_ªf
(
s˘x
);

7051 i‡(
ªsu…
 =
BTRFS_COMPARE_TREE_CHANGED
)

7052 
ªt
 = 
	`ªc‹d_ch™ged_ªf
(
s˘x
);

7055  
ªt
;

7056 
	}
}

7063 
	$ch™ged_x©å
(
£nd_˘x
 *
s˘x
,

7064 
båfs_com∑ª_åì_ªsu…
 
ªsu…
)

7066 
ªt
 = 0;

7068 i‡(
s˘x
->
cur_öo
 !s˘x->
cmp_key
->
obje˘id
) {

7069 
	`öc⁄si°ít_¢≠shŸ_îr‹
(
s˘x
, 
ªsu…
, "xattr");

7070  -
EIO
;

7073 i‡(!
s˘x
->
cur_öode_√w_gí
 && !s˘x->
cur_öode_dñëed
) {

7074 i‡(
ªsu…
 =
BTRFS_COMPARE_TREE_NEW
)

7075 
ªt
 = 
	`¥o˚ss_√w_x©å
(
s˘x
);

7076 i‡(
ªsu…
 =
BTRFS_COMPARE_TREE_DELETED
)

7077 
ªt
 = 
	`¥o˚ss_dñëed_x©å
(
s˘x
);

7078 i‡(
ªsu…
 =
BTRFS_COMPARE_TREE_CHANGED
)

7079 
ªt
 = 
	`¥o˚ss_ch™ged_x©å
(
s˘x
);

7082  
ªt
;

7083 
	}
}

7090 
	$ch™ged_exã¡
(
£nd_˘x
 *
s˘x
,

7091 
båfs_com∑ª_åì_ªsu…
 
ªsu…
)

7093 
ªt
 = 0;

7108 i‡(
s˘x
->
cur_öo
 !s˘x->
cmp_key
->
obje˘id
)

7111 i‡(!
s˘x
->
cur_öode_√w_gí
 && !s˘x->
cur_öode_dñëed
) {

7112 i‡(
ªsu…
 !
BTRFS_COMPARE_TREE_DELETED
)

7113 
ªt
 = 
	`¥o˚ss_exã¡
(
s˘x
, s˘x->
À·_∑th
,

7114 
s˘x
->
cmp_key
);

7117  
ªt
;

7118 
	}
}

7120 
	$ch™ged_vîôy
(
£nd_˘x
 *
s˘x
, 
båfs_com∑ª_åì_ªsu…
 
ªsu…
)

7122 
ªt
 = 0;

7124 i‡(!
s˘x
->
cur_öode_√w_gí
 && !s˘x->
cur_öode_dñëed
) {

7125 i‡(
ªsu…
 =
BTRFS_COMPARE_TREE_NEW
)

7126 
s˘x
->
cur_öode_√eds_vîôy
 = 
åue
;

7128  
ªt
;

7129 
	}
}

7131 
	$dú_ch™ged
(
£nd_˘x
 *
s˘x
, 
u64
 
dú
)

7133 
u64
 
‹ig_gí
, 
√w_gí
;

7134 
ªt
;

7136 
ªt
 = 
	`gë_öode_gí
(
s˘x
->
£nd_roŸ
, 
dú
, &
√w_gí
);

7137 i‡(
ªt
)

7138  
ªt
;

7140 
ªt
 = 
	`gë_öode_gí
(
s˘x
->
∑ª¡_roŸ
, 
dú
, &
‹ig_gí
);

7141 i‡(
ªt
)

7142  
ªt
;

7144  (
‹ig_gí
 !
√w_gí
) ? 1 : 0;

7145 
	}
}

7147 
	$com∑ª_ªfs
(
£nd_˘x
 *
s˘x
, 
båfs_∑th
 *
∑th
,

7148 
båfs_key
 *
key
)

7150 
båfs_öode_exåef
 *
exåef
;

7151 
exã¡_buf„r
 *
Àaf
;

7152 
u64
 
dúid
 = 0, 
œ°_dúid
 = 0;

7153 
±r
;

7154 
u32
 
ôem_size
;

7155 
u32
 
cur_off£t
 = 0;

7156 
ªf_«me_Àn
;

7157 
ªt
 = 0;

7160 i‡(
key
->
ty≥
 =
BTRFS_INODE_REF_KEY
) {

7161 
dúid
 = 
key
->
off£t
;

7163 
ªt
 = 
	`dú_ch™ged
(
s˘x
, 
dúid
);

7164 
out
;

7167 
Àaf
 = 
∑th
->
nodes
[0];

7168 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

7169 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

7170 
cur_off£t
 < 
ôem_size
) {

7171 
exåef
 = (
båfs_öode_exåef
 *)(
±r
 +

7172 
cur_off£t
);

7173 
dúid
 = 
	`båfs_öode_exåef_∑ª¡
(
Àaf
, 
exåef
);

7174 
ªf_«me_Àn
 = 
	`båfs_öode_exåef_«me_Àn
(
Àaf
, 
exåef
);

7175 
cur_off£t
 +
ªf_«me_Àn
 + (*
exåef
);

7176 i‡(
dúid
 =
œ°_dúid
)

7178 
ªt
 = 
	`dú_ch™ged
(
s˘x
, 
dúid
);

7179 i‡(
ªt
)

7181 
œ°_dúid
 = 
dúid
;

7183 
out
:

7184  
ªt
;

7185 
	}
}

7191 
	$ch™ged_cb
(
båfs_∑th
 *
À·_∑th
,

7192 
båfs_∑th
 *
right_∑th
,

7193 
båfs_key
 *
key
,

7194 
båfs_com∑ª_åì_ªsu…
 
ªsu…
,

7195 
£nd_˘x
 *
s˘x
)

7197 
ªt
 = 0;

7224 
	`lockdï_as£π_nŸ_hñd
(&
s˘x
->
£nd_roŸ
->
fs_öfo
->
commô_roŸ_£m
);

7231 i‡(
À·_∑th
->
nodes
[0])

7232 
	`ASSERT
(
	`ã°_bô
(
EXTENT_BUFFER_UNMAPPED
,

7233 &
À·_∑th
->
nodes
[0]->
bÊags
));

7239 i‡(
right_∑th
 &&Ñight_∑th->
nodes
[0])

7240 
	`ASSERT
(
	`ã°_bô
(
EXTENT_BUFFER_UNMAPPED
,

7241 &
right_∑th
->
nodes
[0]->
bÊags
));

7243 i‡(
ªsu…
 =
BTRFS_COMPARE_TREE_SAME
) {

7244 i‡(
key
->
ty≥
 =
BTRFS_INODE_REF_KEY
 ||

7245 
key
->
ty≥
 =
BTRFS_INODE_EXTREF_KEY
) {

7246 
ªt
 = 
	`com∑ª_ªfs
(
s˘x
, 
À·_∑th
, 
key
);

7247 i‡(!
ªt
)

7249 i‡(
ªt
 < 0)

7250  
ªt
;

7251 } i‡(
key
->
ty≥
 =
BTRFS_EXTENT_DATA_KEY
) {

7252  
	`maybe_£nd_hﬁe
(
s˘x
, 
À·_∑th
, 
key
);

7256 
ªsu…
 = 
BTRFS_COMPARE_TREE_CHANGED
;

7257 
ªt
 = 0;

7260 
s˘x
->
À·_∑th
 =Üeft_path;

7261 
s˘x
->
right_∑th
 =Ñight_path;

7262 
s˘x
->
cmp_key
 = 
key
;

7264 
ªt
 = 
	`föish_öode_if_√eded
(
s˘x
, 0);

7265 i‡(
ªt
 < 0)

7266 
out
;

7269 i‡(
key
->
obje˘id
 =
BTRFS_FREE_INO_OBJECTID
 ||

7270 
key
->
obje˘id
 =
BTRFS_FREE_SPACE_OBJECTID
)

7271 
out
;

7273 i‡(
key
->
ty≥
 =
BTRFS_INODE_ITEM_KEY
) {

7274 
ªt
 = 
	`ch™ged_öode
(
s˘x
, 
ªsu…
);

7275 } i‡(!
s˘x
->
ign‹e_cur_öode
) {

7276 i‡(
key
->
ty≥
 =
BTRFS_INODE_REF_KEY
 ||

7277 
key
->
ty≥
 =
BTRFS_INODE_EXTREF_KEY
)

7278 
ªt
 = 
	`ch™ged_ªf
(
s˘x
, 
ªsu…
);

7279 i‡(
key
->
ty≥
 =
BTRFS_XATTR_ITEM_KEY
)

7280 
ªt
 = 
	`ch™ged_x©å
(
s˘x
, 
ªsu…
);

7281 i‡(
key
->
ty≥
 =
BTRFS_EXTENT_DATA_KEY
)

7282 
ªt
 = 
	`ch™ged_exã¡
(
s˘x
, 
ªsu…
);

7283 i‡(
key
->
ty≥
 =
BTRFS_VERITY_DESC_ITEM_KEY
 &&

7284 
key
->
off£t
 == 0)

7285 
ªt
 = 
	`ch™ged_vîôy
(
s˘x
, 
ªsu…
);

7288 
out
:

7289  
ªt
;

7290 
	}
}

7292 
	$£¨ch_key_agaö
(c⁄° 
£nd_˘x
 *
s˘x
,

7293 
båfs_roŸ
 *
roŸ
,

7294 
båfs_∑th
 *
∑th
,

7295 c⁄° 
båfs_key
 *
key
)

7297 
ªt
;

7299 i‡(!
∑th
->
√ed_commô_£m
)

7300 
	`lockdï_as£π_hñd_ªad
(&
roŸ
->
fs_öfo
->
commô_roŸ_£m
);

7309 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, 
key
, 
∑th
, 0, 0);

7310 
	`ASSERT
(
ªt
 <= 0);

7311 i‡(
ªt
 > 0) {

7312 
	`båfs_¥öt_åì
(
∑th
->
nodes
[∑th->
lowe°_Àvñ
], 
Ál£
);

7313 
	`båfs_îr
(
roŸ
->
fs_öfo
,

7315 
key
->
obje˘id
, key->
ty≥
, key->
off£t
,

7316 (
roŸ
 =
s˘x
->
∑ª¡_roŸ
 ? "parent" : "send"),

7317 
roŸ
->
roŸ_key
.
obje˘id
, 
∑th
->
lowe°_Àvñ
,

7318 
∑th
->
¶Ÿs
[∑th->
lowe°_Àvñ
]);

7319  -
EUCLEAN
;

7322  
ªt
;

7323 
	}
}

7325 
	$fuŒ_£nd_åì
(
£nd_˘x
 *
s˘x
)

7327 
ªt
;

7328 
båfs_roŸ
 *
£nd_roŸ
 = 
s˘x
->send_root;

7329 
båfs_key
 
key
;

7330 
båfs_fs_öfo
 *
fs_öfo
 = 
£nd_roŸ
->fs_info;

7331 
båfs_∑th
 *
∑th
;

7333 
∑th
 = 
	`Æloc_∑th_f‹_£nd
();

7334 i‡(!
∑th
)

7335  -
ENOMEM
;

7336 
∑th
->
ªada
 = 
READA_FORWARD_ALWAYS
;

7338 
key
.
obje˘id
 = 
BTRFS_FIRST_FREE_OBJECTID
;

7339 
key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

7340 
key
.
off£t
 = 0;

7342 
	`down_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

7343 
s˘x
->
œ°_ªloc_å™s
 = 
fs_öfo
->last_reloc_trans;

7344 
	`up_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

7346 
ªt
 = 
	`båfs_£¨ch_¶Ÿ_f‹_ªad
(
£nd_roŸ
, &
key
, 
∑th
, 1, 0);

7347 i‡(
ªt
 < 0)

7348 
out
;

7349 i‡(
ªt
)

7350 
out_föish
;

7353 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

7355 
ªt
 = 
	`ch™ged_cb
(
∑th
, 
NULL
, &
key
,

7356 
BTRFS_COMPARE_TREE_NEW
, 
s˘x
);

7357 i‡(
ªt
 < 0)

7358 
out
;

7360 
	`down_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

7361 i‡(
fs_öfo
->
œ°_ªloc_å™s
 > 
s˘x
->last_reloc_trans) {

7362 
s˘x
->
œ°_ªloc_å™s
 = 
fs_öfo
->last_reloc_trans;

7363 
	`up_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

7374 
	`båfs_ªÀa£_∑th
(
∑th
);

7375 
ªt
 = 
	`£¨ch_key_agaö
(
s˘x
, 
£nd_roŸ
, 
∑th
, &
key
);

7376 i‡(
ªt
 < 0)

7377 
out
;

7379 
	`up_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

7382 
ªt
 = 
	`båfs_√xt_ôem
(
£nd_roŸ
, 
∑th
);

7383 i‡(
ªt
 < 0)

7384 
out
;

7385 i‡(
ªt
) {

7386 
ªt
 = 0;

7391 
out_föish
:

7392 
ªt
 = 
	`föish_öode_if_√eded
(
s˘x
, 1);

7394 
out
:

7395 
	`båfs_‰ì_∑th
(
∑th
);

7396  
ªt
;

7397 
	}
}

7399 
	$ª∂a˚_node_wôh_˛⁄e
(
båfs_∑th
 *
∑th
, 
Àvñ
)

7401 
exã¡_buf„r
 *
˛⁄e
;

7403 
˛⁄e
 = 
	`båfs_˛⁄e_exã¡_buf„r
(
∑th
->
nodes
[
Àvñ
]);

7404 i‡(!
˛⁄e
)

7405  -
ENOMEM
;

7407 
	`‰ì_exã¡_buf„r
(
∑th
->
nodes
[
Àvñ
]);

7408 
∑th
->
nodes
[
Àvñ
] = 
˛⁄e
;

7411 
	}
}

7413 
	$åì_move_down
(
båfs_∑th
 *
∑th
, *
Àvñ
, 
u64
 
ªada_mö_gí
)

7415 
exã¡_buf„r
 *
eb
;

7416 
exã¡_buf„r
 *
∑ª¡
 = 
∑th
->
nodes
[*
Àvñ
];

7417 
¶Ÿ
 = 
∑th
->
¶Ÿs
[*
Àvñ
];

7418 c⁄° 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑ª¡
);

7419 
u64
 
ªada_max
;

7420 
u64
 
ªada_d⁄e
 = 0;

7422 
	`lockdï_as£π_hñd_ªad
(&
∑ª¡
->
fs_öfo
->
commô_roŸ_£m
);

7424 
	`BUG_ON
(*
Àvñ
 == 0);

7425 
eb
 = 
	`båfs_ªad_node_¶Ÿ
(
∑ª¡
, 
¶Ÿ
);

7426 i‡(
	`IS_ERR
(
eb
))

7427  
	`PTR_ERR
(
eb
);

7435 
ªada_max
 = (*
Àvñ
 =1 ? 
SZ_128K
 : 
eb
->
fs_öfo
->
nodesize
);

7437 
¶Ÿ
++; slŸ < 
ƒôems
 && 
ªada_d⁄e
 < 
ªada_max
; slot++) {

7438 i‡(
	`båfs_node_±r_gíî©i⁄
(
∑ª¡
, 
¶Ÿ
Ë> 
ªada_mö_gí
) {

7439 
	`båfs_ªadahód_node_chûd
(
∑ª¡
, 
¶Ÿ
);

7440 
ªada_d⁄e
 +
eb
->
fs_öfo
->
nodesize
;

7444 
∑th
->
nodes
[*
Àvñ
 - 1] = 
eb
;

7445 
∑th
->
¶Ÿs
[*
Àvñ
 - 1] = 0;

7446 (*
Àvñ
)--;

7448 i‡(*
Àvñ
 == 0)

7449  
	`ª∂a˚_node_wôh_˛⁄e
(
∑th
, 0);

7452 
	}
}

7454 
	$åì_move_√xt_‹_u≤ext
(
båfs_∑th
 *
∑th
,

7455 *
Àvñ
, 
roŸ_Àvñ
)

7457 
ªt
 = 0;

7458 
ƒôems
;

7459 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[*
Àvñ
]);

7461 
∑th
->
¶Ÿs
[*
Àvñ
]++;

7463 
∑th
->
¶Ÿs
[*
Àvñ
] >
ƒôems
) {

7464 i‡(*
Àvñ
 =
roŸ_Àvñ
) {

7465 
∑th
->
¶Ÿs
[*
Àvñ
] = 
ƒôems
 - 1;

7470 
∑th
->
¶Ÿs
[*
Àvñ
] = 0;

7471 
	`‰ì_exã¡_buf„r
(
∑th
->
nodes
[*
Àvñ
]);

7472 
∑th
->
nodes
[*
Àvñ
] = 
NULL
;

7473 (*
Àvñ
)++;

7474 
∑th
->
¶Ÿs
[*
Àvñ
]++;

7476 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[*
Àvñ
]);

7477 
ªt
 = 1;

7479  
ªt
;

7480 
	}
}

7486 
	$åì_adv™˚
(
båfs_∑th
 *
∑th
,

7487 *
Àvñ
, 
roŸ_Àvñ
,

7488 
Ælow_down
,

7489 
båfs_key
 *
key
,

7490 
u64
 
ªada_mö_gí
)

7492 
ªt
;

7494 i‡(*
Àvñ
 =0 || !
Ælow_down
) {

7495 
ªt
 = 
	`åì_move_√xt_‹_u≤ext
(
∑th
, 
Àvñ
, 
roŸ_Àvñ
);

7497 
ªt
 = 
	`åì_move_down
(
∑th
, 
Àvñ
, 
ªada_mö_gí
);

7506 i‡(*
Àvñ
 == 0)

7507 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[*
Àvñ
], 
key
,

7508 
∑th
->
¶Ÿs
[*
Àvñ
]);

7510 
	`båfs_node_key_to_˝u
(
∑th
->
nodes
[*
Àvñ
], 
key
,

7511 
∑th
->
¶Ÿs
[*
Àvñ
]);

7513  
ªt
;

7514 
	}
}

7516 
	$åì_com∑ª_ôem
(
båfs_∑th
 *
À·_∑th
,

7517 
båfs_∑th
 *
right_∑th
,

7518 *
tmp_buf
)

7520 
cmp
;

7521 
Àn1
, 
Àn2
;

7522 
off1
, 
off2
;

7524 
Àn1
 = 
	`båfs_ôem_size
(
À·_∑th
->
nodes
[0],Üe·_∑th->
¶Ÿs
[0]);

7525 
Àn2
 = 
	`båfs_ôem_size
(
right_∑th
->
nodes
[0],Ñight_∑th->
¶Ÿs
[0]);

7526 i‡(
Àn1
 !
Àn2
)

7529 
off1
 = 
	`båfs_ôem_±r_off£t
(
À·_∑th
->
nodes
[0],Üe·_∑th->
¶Ÿs
[0]);

7530 
off2
 = 
	`båfs_ôem_±r_off£t
(
right_∑th
->
nodes
[0],

7531 
right_∑th
->
¶Ÿs
[0]);

7533 
	`ªad_exã¡_buf„r
(
À·_∑th
->
nodes
[0], 
tmp_buf
, 
off1
, 
Àn1
);

7535 
cmp
 = 
	`memcmp_exã¡_buf„r
(
right_∑th
->
nodes
[0], 
tmp_buf
, 
off2
, 
Àn1
);

7536 i‡(
cmp
)

7539 
	}
}

7560 
	$ª°¨t_a·î_ªloˇti⁄
(
båfs_∑th
 *
À·_∑th
,

7561 
båfs_∑th
 *
right_∑th
,

7562 c⁄° 
båfs_key
 *
À·_key
,

7563 c⁄° 
båfs_key
 *
right_key
,

7564 
À·_Àvñ
,

7565 
right_Àvñ
,

7566 c⁄° 
£nd_˘x
 *
s˘x
)

7568 
roŸ_Àvñ
;

7569 
ªt
;

7571 
	`lockdï_as£π_hñd_ªad
(&
s˘x
->
£nd_roŸ
->
fs_öfo
->
commô_roŸ_£m
);

7573 
	`båfs_ªÀa£_∑th
(
À·_∑th
);

7574 
	`båfs_ªÀa£_∑th
(
right_∑th
);

7582 
À·_∑th
->
lowe°_Àvñ
 = 
À·_Àvñ
;

7583 
ªt
 = 
	`£¨ch_key_agaö
(
s˘x
, s˘x->
£nd_roŸ
, 
À·_∑th
, 
À·_key
);

7584 i‡(
ªt
 < 0)

7585  
ªt
;

7587 
right_∑th
->
lowe°_Àvñ
 = 
right_Àvñ
;

7588 
ªt
 = 
	`£¨ch_key_agaö
(
s˘x
, s˘x->
∑ª¡_roŸ
, 
right_∑th
, 
right_key
);

7589 i‡(
ªt
 < 0)

7590  
ªt
;

7598 i‡(
À·_Àvñ
 == 0) {

7599 
ªt
 = 
	`ª∂a˚_node_wôh_˛⁄e
(
À·_∑th
, 0);

7600 i‡(
ªt
 < 0)

7601  
ªt
;

7604 i‡(
right_Àvñ
 == 0) {

7605 
ªt
 = 
	`ª∂a˚_node_wôh_˛⁄e
(
right_∑th
, 0);

7606 i‡(
ªt
 < 0)

7607  
ªt
;

7615 
roŸ_Àvñ
 = 
	`båfs_hódî_Àvñ
(
s˘x
->
£nd_roŸ
->
commô_roŸ
);

7616 i‡(
roŸ_Àvñ
 > 0) {

7617 
ªt
 = 
	`ª∂a˚_node_wôh_˛⁄e
(
À·_∑th
, 
roŸ_Àvñ
);

7618 i‡(
ªt
 < 0)

7619  
ªt
;

7622 
roŸ_Àvñ
 = 
	`båfs_hódî_Àvñ
(
s˘x
->
∑ª¡_roŸ
->
commô_roŸ
);

7623 i‡(
roŸ_Àvñ
 > 0) {

7624 
ªt
 = 
	`ª∂a˚_node_wôh_˛⁄e
(
right_∑th
, 
roŸ_Àvñ
);

7625 i‡(
ªt
 < 0)

7626  
ªt
;

7630 
	}
}

7645 
	$båfs_com∑ª_åìs
(
båfs_roŸ
 *
À·_roŸ
,

7646 
båfs_roŸ
 *
right_roŸ
, 
£nd_˘x
 *
s˘x
)

7648 
båfs_fs_öfo
 *
fs_öfo
 = 
À·_roŸ
->fs_info;

7649 
ªt
;

7650 
cmp
;

7651 
båfs_∑th
 *
À·_∑th
 = 
NULL
;

7652 
båfs_∑th
 *
right_∑th
 = 
NULL
;

7653 
båfs_key
 
À·_key
;

7654 
båfs_key
 
right_key
;

7655 *
tmp_buf
 = 
NULL
;

7656 
À·_roŸ_Àvñ
;

7657 
right_roŸ_Àvñ
;

7658 
À·_Àvñ
;

7659 
right_Àvñ
;

7660 
À·_íd_ªached
 = 0;

7661 
right_íd_ªached
 = 0;

7662 
adv™˚_À·
 = 0;

7663 
adv™˚_right
 = 0;

7664 
u64
 
À·_block±r
;

7665 
u64
 
right_block±r
;

7666 
u64
 
À·_gí
;

7667 
u64
 
right_gí
;

7668 
u64
 
ªada_mö_gí
;

7670 
À·_∑th
 = 
	`båfs_Æloc_∑th
();

7671 i‡(!
À·_∑th
) {

7672 
ªt
 = -
ENOMEM
;

7673 
out
;

7675 
right_∑th
 = 
	`båfs_Æloc_∑th
();

7676 i‡(!
right_∑th
) {

7677 
ªt
 = -
ENOMEM
;

7678 
out
;

7681 
tmp_buf
 = 
	`kvmÆloc
(
fs_öfo
->
nodesize
, 
GFP_KERNEL
);

7682 i‡(!
tmp_buf
) {

7683 
ªt
 = -
ENOMEM
;

7684 
out
;

7687 
À·_∑th
->
£¨ch_commô_roŸ
 = 1;

7688 
À·_∑th
->
skù_lockög
 = 1;

7689 
right_∑th
->
£¨ch_commô_roŸ
 = 1;

7690 
right_∑th
->
skù_lockög
 = 1;

7728 
	`down_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

7729 
À·_Àvñ
 = 
	`båfs_hódî_Àvñ
(
À·_roŸ
->
commô_roŸ
);

7730 
À·_roŸ_Àvñ
 = 
À·_Àvñ
;

7738 
À·_∑th
->
nodes
[
À·_Àvñ
] =

7739 
	`båfs_˛⁄e_exã¡_buf„r
(
À·_roŸ
->
commô_roŸ
);

7740 i‡(!
À·_∑th
->
nodes
[
À·_Àvñ
]) {

7741 
ªt
 = -
ENOMEM
;

7742 
out_u∆ock
;

7745 
right_Àvñ
 = 
	`båfs_hódî_Àvñ
(
right_roŸ
->
commô_roŸ
);

7746 
right_roŸ_Àvñ
 = 
right_Àvñ
;

7747 
right_∑th
->
nodes
[
right_Àvñ
] =

7748 
	`båfs_˛⁄e_exã¡_buf„r
(
right_roŸ
->
commô_roŸ
);

7749 i‡(!
right_∑th
->
nodes
[
right_Àvñ
]) {

7750 
ªt
 = -
ENOMEM
;

7751 
out_u∆ock
;

7760 
ªada_mö_gí
 = 
	`båfs_hódî_gíî©i⁄
(
right_roŸ
->
commô_roŸ
);

7762 i‡(
À·_Àvñ
 == 0)

7763 
	`båfs_ôem_key_to_˝u
(
À·_∑th
->
nodes
[
À·_Àvñ
],

7764 &
À·_key
, 
À·_∑th
->
¶Ÿs
[
À·_Àvñ
]);

7766 
	`båfs_node_key_to_˝u
(
À·_∑th
->
nodes
[
À·_Àvñ
],

7767 &
À·_key
, 
À·_∑th
->
¶Ÿs
[
À·_Àvñ
]);

7768 i‡(
right_Àvñ
 == 0)

7769 
	`båfs_ôem_key_to_˝u
(
right_∑th
->
nodes
[
right_Àvñ
],

7770 &
right_key
, 
right_∑th
->
¶Ÿs
[
right_Àvñ
]);

7772 
	`båfs_node_key_to_˝u
(
right_∑th
->
nodes
[
right_Àvñ
],

7773 &
right_key
, 
right_∑th
->
¶Ÿs
[
right_Àvñ
]);

7775 
s˘x
->
œ°_ªloc_å™s
 = 
fs_öfo
->last_reloc_trans;

7778 i‡(
	`√ed_ªsched
() ||

7779 
	`rw£m_is_c⁄ãnded
(&
fs_öfo
->
commô_roŸ_£m
)) {

7780 
	`up_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

7781 
	`c⁄d_ªsched
();

7782 
	`down_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

7785 i‡(
fs_öfo
->
œ°_ªloc_å™s
 > 
s˘x
->last_reloc_trans) {

7786 
ªt
 = 
	`ª°¨t_a·î_ªloˇti⁄
(
À·_∑th
, 
right_∑th
,

7787 &
À·_key
, &
right_key
,

7788 
À·_Àvñ
, 
right_Àvñ
,

7789 
s˘x
);

7790 i‡(
ªt
 < 0)

7791 
out_u∆ock
;

7792 
s˘x
->
œ°_ªloc_å™s
 = 
fs_öfo
->last_reloc_trans;

7795 i‡(
adv™˚_À·
 && !
À·_íd_ªached
) {

7796 
ªt
 = 
	`åì_adv™˚
(
À·_∑th
, &
À·_Àvñ
,

7797 
À·_roŸ_Àvñ
,

7798 
adv™˚_À·
 !
ADVANCE_ONLY_NEXT
,

7799 &
À·_key
, 
ªada_mö_gí
);

7800 i‡(
ªt
 == -1)

7801 
À·_íd_ªached
 = 
ADVANCE
;

7802 i‡(
ªt
 < 0)

7803 
out_u∆ock
;

7804 
adv™˚_À·
 = 0;

7806 i‡(
adv™˚_right
 && !
right_íd_ªached
) {

7807 
ªt
 = 
	`åì_adv™˚
(
right_∑th
, &
right_Àvñ
,

7808 
right_roŸ_Àvñ
,

7809 
adv™˚_right
 !
ADVANCE_ONLY_NEXT
,

7810 &
right_key
, 
ªada_mö_gí
);

7811 i‡(
ªt
 == -1)

7812 
right_íd_ªached
 = 
ADVANCE
;

7813 i‡(
ªt
 < 0)

7814 
out_u∆ock
;

7815 
adv™˚_right
 = 0;

7818 i‡(
À·_íd_ªached
 && 
right_íd_ªached
) {

7819 
ªt
 = 0;

7820 
out_u∆ock
;

7821 } i‡(
À·_íd_ªached
) {

7822 i‡(
right_Àvñ
 == 0) {

7823 
	`up_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

7824 
ªt
 = 
	`ch™ged_cb
(
À·_∑th
, 
right_∑th
,

7825 &
right_key
,

7826 
BTRFS_COMPARE_TREE_DELETED
,

7827 
s˘x
);

7828 i‡(
ªt
 < 0)

7829 
out
;

7830 
	`down_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

7832 
adv™˚_right
 = 
ADVANCE
;

7834 } i‡(
right_íd_ªached
) {

7835 i‡(
À·_Àvñ
 == 0) {

7836 
	`up_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

7837 
ªt
 = 
	`ch™ged_cb
(
À·_∑th
, 
right_∑th
,

7838 &
À·_key
,

7839 
BTRFS_COMPARE_TREE_NEW
,

7840 
s˘x
);

7841 i‡(
ªt
 < 0)

7842 
out
;

7843 
	`down_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

7845 
adv™˚_À·
 = 
ADVANCE
;

7849 i‡(
À·_Àvñ
 =0 && 
right_Àvñ
 == 0) {

7850 
	`up_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

7851 
cmp
 = 
	`båfs_comp_˝u_keys
(&
À·_key
, &
right_key
);

7852 i‡(
cmp
 < 0) {

7853 
ªt
 = 
	`ch™ged_cb
(
À·_∑th
, 
right_∑th
,

7854 &
À·_key
,

7855 
BTRFS_COMPARE_TREE_NEW
,

7856 
s˘x
);

7857 
adv™˚_À·
 = 
ADVANCE
;

7858 } i‡(
cmp
 > 0) {

7859 
ªt
 = 
	`ch™ged_cb
(
À·_∑th
, 
right_∑th
,

7860 &
right_key
,

7861 
BTRFS_COMPARE_TREE_DELETED
,

7862 
s˘x
);

7863 
adv™˚_right
 = 
ADVANCE
;

7865 
båfs_com∑ª_åì_ªsu…
 
ªsu…
;

7867 
	`WARN_ON
(!
	`exã¡_buf„r_u±od©e
(
À·_∑th
->
nodes
[0]));

7868 
ªt
 = 
	`åì_com∑ª_ôem
(
À·_∑th
, 
right_∑th
,

7869 
tmp_buf
);

7870 i‡(
ªt
)

7871 
ªsu…
 = 
BTRFS_COMPARE_TREE_CHANGED
;

7873 
ªsu…
 = 
BTRFS_COMPARE_TREE_SAME
;

7874 
ªt
 = 
	`ch™ged_cb
(
À·_∑th
, 
right_∑th
,

7875 &
À·_key
, 
ªsu…
, 
s˘x
);

7876 
adv™˚_À·
 = 
ADVANCE
;

7877 
adv™˚_right
 = 
ADVANCE
;

7880 i‡(
ªt
 < 0)

7881 
out
;

7882 
	`down_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

7883 } i‡(
À·_Àvñ
 =
right_Àvñ
) {

7884 
cmp
 = 
	`båfs_comp_˝u_keys
(&
À·_key
, &
right_key
);

7885 i‡(
cmp
 < 0) {

7886 
adv™˚_À·
 = 
ADVANCE
;

7887 } i‡(
cmp
 > 0) {

7888 
adv™˚_right
 = 
ADVANCE
;

7890 
À·_block±r
 = 
	`båfs_node_block±r
(

7891 
À·_∑th
->
nodes
[
À·_Àvñ
],

7892 
À·_∑th
->
¶Ÿs
[
À·_Àvñ
]);

7893 
right_block±r
 = 
	`båfs_node_block±r
(

7894 
right_∑th
->
nodes
[
right_Àvñ
],

7895 
right_∑th
->
¶Ÿs
[
right_Àvñ
]);

7896 
À·_gí
 = 
	`båfs_node_±r_gíî©i⁄
(

7897 
À·_∑th
->
nodes
[
À·_Àvñ
],

7898 
À·_∑th
->
¶Ÿs
[
À·_Àvñ
]);

7899 
right_gí
 = 
	`båfs_node_±r_gíî©i⁄
(

7900 
right_∑th
->
nodes
[
right_Àvñ
],

7901 
right_∑th
->
¶Ÿs
[
right_Àvñ
]);

7902 i‡(
À·_block±r
 =
right_block±r
 &&

7903 
À·_gí
 =
right_gí
) {

7908 
adv™˚_À·
 = 
ADVANCE_ONLY_NEXT
;

7909 
adv™˚_right
 = 
ADVANCE_ONLY_NEXT
;

7911 
adv™˚_À·
 = 
ADVANCE
;

7912 
adv™˚_right
 = 
ADVANCE
;

7915 } i‡(
À·_Àvñ
 < 
right_Àvñ
) {

7916 
adv™˚_right
 = 
ADVANCE
;

7918 
adv™˚_À·
 = 
ADVANCE
;

7922 
out_u∆ock
:

7923 
	`up_ªad
(&
fs_öfo
->
commô_roŸ_£m
);

7924 
out
:

7925 
	`båfs_‰ì_∑th
(
À·_∑th
);

7926 
	`båfs_‰ì_∑th
(
right_∑th
);

7927 
	`kv‰ì
(
tmp_buf
);

7928  
ªt
;

7929 
	}
}

7931 
	$£nd_subvﬁ
(
£nd_˘x
 *
s˘x
)

7933 
ªt
;

7935 i‡(!(
s˘x
->
Êags
 & 
BTRFS_SEND_FLAG_OMIT_STREAM_HEADER
)) {

7936 
ªt
 = 
	`£nd_hódî
(
s˘x
);

7937 i‡(
ªt
 < 0)

7938 
out
;

7941 
ªt
 = 
	`£nd_subvﬁ_begö
(
s˘x
);

7942 i‡(
ªt
 < 0)

7943 
out
;

7945 i‡(
s˘x
->
∑ª¡_roŸ
) {

7946 
ªt
 = 
	`båfs_com∑ª_åìs
(
s˘x
->
£nd_roŸ
, s˘x->
∑ª¡_roŸ
, sctx);

7947 i‡(
ªt
 < 0)

7948 
out
;

7949 
ªt
 = 
	`föish_öode_if_√eded
(
s˘x
, 1);

7950 i‡(
ªt
 < 0)

7951 
out
;

7953 
ªt
 = 
	`fuŒ_£nd_åì
(
s˘x
);

7954 i‡(
ªt
 < 0)

7955 
out
;

7958 
out
:

7959 
	`‰ì_ªc‹ded_ªfs
(
s˘x
);

7960  
ªt
;

7961 
	}
}

7976 
	$ísuª_commô_roŸs_u±od©e
(
£nd_˘x
 *
s˘x
)

7978 
i
;

7979 
båfs_å™s_h™dÀ
 *
å™s
 = 
NULL
;

7981 
agaö
:

7982 i‡(
s˘x
->
∑ª¡_roŸ
 &&

7983 
s˘x
->
∑ª¡_roŸ
->
node
 !s˘x->∑ª¡_roŸ->
commô_roŸ
)

7984 
commô_å™s
;

7986 
i
 = 0; i < 
s˘x
->
˛⁄e_roŸs_˙t
; i++)

7987 i‡(
s˘x
->
˛⁄e_roŸs
[
i
].
roŸ
->
node
 !=

7988 
s˘x
->
˛⁄e_roŸs
[
i
].
roŸ
->
commô_roŸ
)

7989 
commô_å™s
;

7991 i‡(
å™s
)

7992  
	`båfs_íd_å™ß˘i⁄
(
å™s
);

7996 
commô_å™s
:

7998 i‡(!
å™s
) {

7999 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
s˘x
->
£nd_roŸ
);

8000 i‡(
	`IS_ERR
(
å™s
))

8001  
	`PTR_ERR
(
å™s
);

8002 
agaö
;

8005  
	`båfs_commô_å™ß˘i⁄
(
å™s
);

8006 
	}
}

8016 
	$Êush_dñÆloc_roŸs
(
£nd_˘x
 *
s˘x
)

8018 
båfs_roŸ
 *
roŸ
 = 
s˘x
->
∑ª¡_roŸ
;

8019 
ªt
;

8020 
i
;

8022 i‡(
roŸ
) {

8023 
ªt
 = 
	`båfs_°¨t_dñÆloc_¢≠shŸ
(
roŸ
, 
Ál£
);

8024 i‡(
ªt
)

8025  
ªt
;

8026 
	`båfs_waô_‹dîed_exã¡s
(
roŸ
, 
U64_MAX
, 0, U64_MAX);

8029 
i
 = 0; i < 
s˘x
->
˛⁄e_roŸs_˙t
; i++) {

8030 
roŸ
 = 
s˘x
->
˛⁄e_roŸs
[
i
].root;

8031 
ªt
 = 
	`båfs_°¨t_dñÆloc_¢≠shŸ
(
roŸ
, 
Ál£
);

8032 i‡(
ªt
)

8033  
ªt
;

8034 
	`båfs_waô_‹dîed_exã¡s
(
roŸ
, 
U64_MAX
, 0, U64_MAX);

8038 
	}
}

8040 
	$båfs_roŸ_dec_£nd_ö_¥ogªss
(
båfs_roŸ
* 
roŸ
)

8042 
	`•ö_lock
(&
roŸ
->
roŸ_ôem_lock
);

8043 
roŸ
->
£nd_ö_¥ogªss
--;

8048 i‡(
roŸ
->
£nd_ö_¥ogªss
 < 0)

8049 
	`båfs_îr
(
roŸ
->
fs_öfo
,

8051 
roŸ
->
£nd_ö_¥ogªss
,ÑoŸ->
roŸ_key
.
obje˘id
);

8052 
	`•ö_u∆ock
(&
roŸ
->
roŸ_ôem_lock
);

8053 
	}
}

8055 
	$dedu≥_ö_¥ogªss_w¨n
(c⁄° 
båfs_roŸ
 *
roŸ
)

8057 
	`båfs_w¨n_æ
(
roŸ
->
fs_öfo
,

8059 
roŸ
->
roŸ_key
.
obje˘id
,ÑoŸ->
dedu≥_ö_¥ogªss
);

8060 
	}
}

8062 
	$båfs_io˘l_£nd
(
öode
 *öode, 
båfs_io˘l_£nd_¨gs
 *
¨g
)

8064 
ªt
 = 0;

8065 
båfs_roŸ
 *
£nd_roŸ
 = 
	`BTRFS_I
(
öode
)->
roŸ
;

8066 
båfs_fs_öfo
 *
fs_öfo
 = 
£nd_roŸ
->fs_info;

8067 
båfs_roŸ
 *
˛⁄e_roŸ
;

8068 
£nd_˘x
 *
s˘x
 = 
NULL
;

8069 
u32
 
i
;

8070 
u64
 *
˛⁄e_sour˚s_tmp
 = 
NULL
;

8071 
˛⁄e_sour˚s_to_rﬁlback
 = 0;

8072 
size_t
 
Æloc_size
;

8073 
s‹t_˛⁄e_roŸs
 = 0;

8074 
båfs_Ãu_ˇche_íåy
 *
íåy
;

8075 
båfs_Ãu_ˇche_íåy
 *
tmp
;

8077 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

8078  -
EPERM
;

8084 
	`•ö_lock
(&
£nd_roŸ
->
roŸ_ôem_lock
);

8085 i‡(
	`båfs_roŸ_ªad⁄ly
(
£nd_roŸ
Ë&& síd_roŸ->
dedu≥_ö_¥ogªss
) {

8086 
	`dedu≥_ö_¥ogªss_w¨n
(
£nd_roŸ
);

8087 
	`•ö_u∆ock
(&
£nd_roŸ
->
roŸ_ôem_lock
);

8088  -
EAGAIN
;

8090 
£nd_roŸ
->
£nd_ö_¥ogªss
++;

8091 
	`•ö_u∆ock
(&
£nd_roŸ
->
roŸ_ôem_lock
);

8097 i‡(!
	`båfs_roŸ_ªad⁄ly
(
£nd_roŸ
)) {

8098 
ªt
 = -
EPERM
;

8099 
out
;

8108 i‡(
¨g
->
˛⁄e_sour˚s_cou¡
 > 
SZ_8M
 / (
˛⁄e_roŸ
)) {

8109 
ªt
 = -
EINVAL
;

8110 
out
;

8113 i‡(
¨g
->
Êags
 & ~
BTRFS_SEND_FLAG_MASK
) {

8114 
ªt
 = -
EINVAL
;

8115 
out
;

8118 
s˘x
 = 
	`kzÆloc
((
£nd_˘x
), 
GFP_KERNEL
);

8119 i‡(!
s˘x
) {

8120 
ªt
 = -
ENOMEM
;

8121 
out
;

8124 
	`INIT_LIST_HEAD
(&
s˘x
->
√w_ªfs
);

8125 
	`INIT_LIST_HEAD
(&
s˘x
->
dñëed_ªfs
);

8127 
	`båfs_Ãu_ˇche_öô
(&
s˘x
->
«me_ˇche
, 
SEND_MAX_NAME_CACHE_SIZE
);

8128 
	`båfs_Ãu_ˇche_öô
(&
s˘x
->
backªf_ˇche
, 
SEND_MAX_BACKREF_CACHE_SIZE
);

8129 
	`båfs_Ãu_ˇche_öô
(&
s˘x
->
dú_¸óãd_ˇche
,

8130 
SEND_MAX_DIR_CREATED_CACHE_SIZE
);

8135 
	`båfs_Ãu_ˇche_öô
(&
s˘x
->
dú_utimes_ˇche
, 0);

8137 
s˘x
->
≥ndög_dú_moves
 = 
RB_ROOT
;

8138 
s˘x
->
waôög_dú_moves
 = 
RB_ROOT
;

8139 
s˘x
->
‹ph™_dús
 = 
RB_ROOT
;

8140 
s˘x
->
rbåì_√w_ªfs
 = 
RB_ROOT
;

8141 
s˘x
->
rbåì_dñëed_ªfs
 = 
RB_ROOT
;

8143 
s˘x
->
Êags
 = 
¨g
->flags;

8145 i‡(
¨g
->
Êags
 & 
BTRFS_SEND_FLAG_VERSION
) {

8146 i‡(
¨g
->
vîsi⁄
 > 
BTRFS_SEND_STREAM_VERSION
) {

8147 
ªt
 = -
EPROTO
;

8148 
out
;

8151 
s˘x
->
¥Ÿo
 = 
¨g
->
vîsi⁄
 ?: 
BTRFS_SEND_STREAM_VERSION
;

8153 
s˘x
->
¥Ÿo
 = 1;

8155 i‡((
¨g
->
Êags
 & 
BTRFS_SEND_FLAG_COMPRESSED
Ë&& 
s˘x
->
¥Ÿo
 < 2) {

8156 
ªt
 = -
EINVAL
;

8157 
out
;

8160 
s˘x
->
£nd_fûp
 = 
	`fgë
(
¨g
->
£nd_fd
);

8161 i‡(!
s˘x
->
£nd_fûp
 || !(s˘x->£nd_fûp->
f_mode
 & 
FMODE_WRITE
)) {

8162 
ªt
 = -
EBADF
;

8163 
out
;

8166 
s˘x
->
£nd_roŸ
 = send_root;

8171 i‡(
	`båfs_roŸ_dód
(
s˘x
->
£nd_roŸ
)) {

8172 
ªt
 = -
EPERM
;

8173 
out
;

8176 
s˘x
->
˛⁄e_roŸs_˙t
 = 
¨g
->
˛⁄e_sour˚s_cou¡
;

8178 i‡(
s˘x
->
¥Ÿo
 >= 2) {

8179 
u32
 
£nd_buf_num_∑ges
;

8181 
s˘x
->
£nd_max_size
 = 
BTRFS_SEND_BUF_SIZE_V2
;

8182 
s˘x
->
£nd_buf
 = 
	`vmÆloc
(s˘x->
£nd_max_size
);

8183 i‡(!
s˘x
->
£nd_buf
) {

8184 
ªt
 = -
ENOMEM
;

8185 
out
;

8187 
£nd_buf_num_∑ges
 = 
s˘x
->
£nd_max_size
 >> 
PAGE_SHIFT
;

8188 
s˘x
->
£nd_buf_∑ges
 = 
	`kˇŒoc
(
£nd_buf_num_∑ges
,

8189 (*
s˘x
->
£nd_buf_∑ges
),

8190 
GFP_KERNEL
);

8191 i‡(!
s˘x
->
£nd_buf_∑ges
) {

8192 
ªt
 = -
ENOMEM
;

8193 
out
;

8195 
i
 = 0; i < 
£nd_buf_num_∑ges
; i++) {

8196 
s˘x
->
£nd_buf_∑ges
[
i
] =

8197 
	`vmÆloc_to_∑ge
(
s˘x
->
£nd_buf
 + (
i
 << 
PAGE_SHIFT
));

8200 
s˘x
->
£nd_max_size
 = 
BTRFS_SEND_BUF_SIZE_V1
;

8201 
s˘x
->
£nd_buf
 = 
	`kvmÆloc
(s˘x->
£nd_max_size
, 
GFP_KERNEL
);

8203 i‡(!
s˘x
->
£nd_buf
) {

8204 
ªt
 = -
ENOMEM
;

8205 
out
;

8208 
s˘x
->
˛⁄e_roŸs
 = 
	`kvˇŒoc
((*sctx->clone_roots),

8209 
¨g
->
˛⁄e_sour˚s_cou¡
 + 1,

8210 
GFP_KERNEL
);

8211 i‡(!
s˘x
->
˛⁄e_roŸs
) {

8212 
ªt
 = -
ENOMEM
;

8213 
out
;

8216 
Æloc_size
 = 
	`¨øy_size
((*
¨g
->
˛⁄e_sour˚s
),

8217 
¨g
->
˛⁄e_sour˚s_cou¡
);

8219 i‡(
¨g
->
˛⁄e_sour˚s_cou¡
) {

8220 
˛⁄e_sour˚s_tmp
 = 
	`kvmÆloc
(
Æloc_size
, 
GFP_KERNEL
);

8221 i‡(!
˛⁄e_sour˚s_tmp
) {

8222 
ªt
 = -
ENOMEM
;

8223 
out
;

8226 
ªt
 = 
	`c›y_‰om_u£r
(
˛⁄e_sour˚s_tmp
, 
¨g
->
˛⁄e_sour˚s
,

8227 
Æloc_size
);

8228 i‡(
ªt
) {

8229 
ªt
 = -
EFAULT
;

8230 
out
;

8233 
i
 = 0; i < 
¨g
->
˛⁄e_sour˚s_cou¡
; i++) {

8234 
˛⁄e_roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
,

8235 
˛⁄e_sour˚s_tmp
[
i
], 
åue
);

8236 i‡(
	`IS_ERR
(
˛⁄e_roŸ
)) {

8237 
ªt
 = 
	`PTR_ERR
(
˛⁄e_roŸ
);

8238 
out
;

8240 
	`•ö_lock
(&
˛⁄e_roŸ
->
roŸ_ôem_lock
);

8241 i‡(!
	`båfs_roŸ_ªad⁄ly
(
˛⁄e_roŸ
) ||

8242 
	`båfs_roŸ_dód
(
˛⁄e_roŸ
)) {

8243 
	`•ö_u∆ock
(&
˛⁄e_roŸ
->
roŸ_ôem_lock
);

8244 
	`båfs_put_roŸ
(
˛⁄e_roŸ
);

8245 
ªt
 = -
EPERM
;

8246 
out
;

8248 i‡(
˛⁄e_roŸ
->
dedu≥_ö_¥ogªss
) {

8249 
	`dedu≥_ö_¥ogªss_w¨n
(
˛⁄e_roŸ
);

8250 
	`•ö_u∆ock
(&
˛⁄e_roŸ
->
roŸ_ôem_lock
);

8251 
	`båfs_put_roŸ
(
˛⁄e_roŸ
);

8252 
ªt
 = -
EAGAIN
;

8253 
out
;

8255 
˛⁄e_roŸ
->
£nd_ö_¥ogªss
++;

8256 
	`•ö_u∆ock
(&
˛⁄e_roŸ
->
roŸ_ôem_lock
);

8258 
s˘x
->
˛⁄e_roŸs
[
i
].
roŸ
 = 
˛⁄e_roŸ
;

8259 
˛⁄e_sour˚s_to_rﬁlback
 = 
i
 + 1;

8261 
	`kv‰ì
(
˛⁄e_sour˚s_tmp
);

8262 
˛⁄e_sour˚s_tmp
 = 
NULL
;

8265 i‡(
¨g
->
∑ª¡_roŸ
) {

8266 
s˘x
->
∑ª¡_roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
¨g
->parent_root,

8267 
åue
);

8268 i‡(
	`IS_ERR
(
s˘x
->
∑ª¡_roŸ
)) {

8269 
ªt
 = 
	`PTR_ERR
(
s˘x
->
∑ª¡_roŸ
);

8270 
out
;

8273 
	`•ö_lock
(&
s˘x
->
∑ª¡_roŸ
->
roŸ_ôem_lock
);

8274 
s˘x
->
∑ª¡_roŸ
->
£nd_ö_¥ogªss
++;

8275 i‡(!
	`båfs_roŸ_ªad⁄ly
(
s˘x
->
∑ª¡_roŸ
) ||

8276 
	`båfs_roŸ_dód
(
s˘x
->
∑ª¡_roŸ
)) {

8277 
	`•ö_u∆ock
(&
s˘x
->
∑ª¡_roŸ
->
roŸ_ôem_lock
);

8278 
ªt
 = -
EPERM
;

8279 
out
;

8281 i‡(
s˘x
->
∑ª¡_roŸ
->
dedu≥_ö_¥ogªss
) {

8282 
	`dedu≥_ö_¥ogªss_w¨n
(
s˘x
->
∑ª¡_roŸ
);

8283 
	`•ö_u∆ock
(&
s˘x
->
∑ª¡_roŸ
->
roŸ_ôem_lock
);

8284 
ªt
 = -
EAGAIN
;

8285 
out
;

8287 
	`•ö_u∆ock
(&
s˘x
->
∑ª¡_roŸ
->
roŸ_ôem_lock
);

8295 
s˘x
->
˛⁄e_roŸs
[s˘x->
˛⁄e_roŸs_˙t
++].
roŸ
 =

8296 
	`båfs_gøb_roŸ
(
s˘x
->
£nd_roŸ
);

8299 
	`s‹t
(
s˘x
->
˛⁄e_roŸs
, s˘x->
˛⁄e_roŸs_˙t
,

8300 (*
s˘x
->
˛⁄e_roŸs
), 
__˛⁄e_roŸ_cmp_s‹t
,

8301 
NULL
);

8302 
s‹t_˛⁄e_roŸs
 = 1;

8304 
ªt
 = 
	`Êush_dñÆloc_roŸs
(
s˘x
);

8305 i‡(
ªt
)

8306 
out
;

8308 
ªt
 = 
	`ísuª_commô_roŸs_u±od©e
(
s˘x
);

8309 i‡(
ªt
)

8310 
out
;

8312 
ªt
 = 
	`£nd_subvﬁ
(
s˘x
);

8313 i‡(
ªt
 < 0)

8314 
out
;

8316 
	`båfs_Ãu_ˇche_f‹_óch_íåy_ß„
(&
s˘x
->
dú_utimes_ˇche
, 
íåy
, 
tmp
) {

8317 
ªt
 = 
	`£nd_utimes
(
s˘x
, 
íåy
->
key
,É¡ry->
gí
);

8318 i‡(
ªt
 < 0)

8319 
out
;

8320 
	`båfs_Ãu_ˇche_ªmove
(&
s˘x
->
dú_utimes_ˇche
, 
íåy
);

8323 i‡(!(
s˘x
->
Êags
 & 
BTRFS_SEND_FLAG_OMIT_END_CMD
)) {

8324 
ªt
 = 
	`begö_cmd
(
s˘x
, 
BTRFS_SEND_C_END
);

8325 i‡(
ªt
 < 0)

8326 
out
;

8327 
ªt
 = 
	`£nd_cmd
(
s˘x
);

8328 i‡(
ªt
 < 0)

8329 
out
;

8332 
out
:

8333 
	`WARN_ON
(
s˘x
 && !
ªt
 && !
	`RB_EMPTY_ROOT
(&s˘x->
≥ndög_dú_moves
));

8334 
s˘x
 && !
	`RB_EMPTY_ROOT
(&s˘x->
≥ndög_dú_moves
)) {

8335 
rb_node
 *
n
;

8336 
≥ndög_dú_move
 *
pm
;

8338 
n
 = 
	`rb_fú°
(&
s˘x
->
≥ndög_dú_moves
);

8339 
pm
 = 
	`rb_íåy
(
n
, 
≥ndög_dú_move
, 
node
);

8340 !
	`li°_em±y
(&
pm
->
li°
)) {

8341 
≥ndög_dú_move
 *
pm2
;

8343 
pm2
 = 
	`li°_fú°_íåy
(&
pm
->
li°
,

8344 
≥ndög_dú_move
, 
li°
);

8345 
	`‰ì_≥ndög_move
(
s˘x
, 
pm2
);

8347 
	`‰ì_≥ndög_move
(
s˘x
, 
pm
);

8350 
	`WARN_ON
(
s˘x
 && !
ªt
 && !
	`RB_EMPTY_ROOT
(&s˘x->
waôög_dú_moves
));

8351 
s˘x
 && !
	`RB_EMPTY_ROOT
(&s˘x->
waôög_dú_moves
)) {

8352 
rb_node
 *
n
;

8353 
waôög_dú_move
 *
dm
;

8355 
n
 = 
	`rb_fú°
(&
s˘x
->
waôög_dú_moves
);

8356 
dm
 = 
	`rb_íåy
(
n
, 
waôög_dú_move
, 
node
);

8357 
	`rb_îa£
(&
dm
->
node
, &
s˘x
->
waôög_dú_moves
);

8358 
	`k‰ì
(
dm
);

8361 
	`WARN_ON
(
s˘x
 && !
ªt
 && !
	`RB_EMPTY_ROOT
(&s˘x->
‹ph™_dús
));

8362 
s˘x
 && !
	`RB_EMPTY_ROOT
(&s˘x->
‹ph™_dús
)) {

8363 
rb_node
 *
n
;

8364 
‹ph™_dú_öfo
 *
odi
;

8366 
n
 = 
	`rb_fú°
(&
s˘x
->
‹ph™_dús
);

8367 
odi
 = 
	`rb_íåy
(
n
, 
‹ph™_dú_öfo
, 
node
);

8368 
	`‰ì_‹ph™_dú_öfo
(
s˘x
, 
odi
);

8371 i‡(
s‹t_˛⁄e_roŸs
) {

8372 
i
 = 0; i < 
s˘x
->
˛⁄e_roŸs_˙t
; i++) {

8373 
	`båfs_roŸ_dec_£nd_ö_¥ogªss
(

8374 
s˘x
->
˛⁄e_roŸs
[
i
].
roŸ
);

8375 
	`båfs_put_roŸ
(
s˘x
->
˛⁄e_roŸs
[
i
].
roŸ
);

8378 
i
 = 0; 
s˘x
 && i < 
˛⁄e_sour˚s_to_rﬁlback
; i++) {

8379 
	`båfs_roŸ_dec_£nd_ö_¥ogªss
(

8380 
s˘x
->
˛⁄e_roŸs
[
i
].
roŸ
);

8381 
	`båfs_put_roŸ
(
s˘x
->
˛⁄e_roŸs
[
i
].
roŸ
);

8384 
	`båfs_roŸ_dec_£nd_ö_¥ogªss
(
£nd_roŸ
);

8386 i‡(
s˘x
 && !
	`IS_ERR_OR_NULL
(s˘x->
∑ª¡_roŸ
)) {

8387 
	`båfs_roŸ_dec_£nd_ö_¥ogªss
(
s˘x
->
∑ª¡_roŸ
);

8388 
	`båfs_put_roŸ
(
s˘x
->
∑ª¡_roŸ
);

8391 
	`kv‰ì
(
˛⁄e_sour˚s_tmp
);

8393 i‡(
s˘x
) {

8394 i‡(
s˘x
->
£nd_fûp
)

8395 
	`Âut
(
s˘x
->
£nd_fûp
);

8397 
	`kv‰ì
(
s˘x
->
˛⁄e_roŸs
);

8398 
	`k‰ì
(
s˘x
->
£nd_buf_∑ges
);

8399 
	`kv‰ì
(
s˘x
->
£nd_buf
);

8400 
	`kv‰ì
(
s˘x
->
vîôy_des¸ùt‹
);

8402 
	`˛o£_cuºít_öode
(
s˘x
);

8404 
	`båfs_Ãu_ˇche_˛ór
(&
s˘x
->
«me_ˇche
);

8405 
	`båfs_Ãu_ˇche_˛ór
(&
s˘x
->
backªf_ˇche
);

8406 
	`båfs_Ãu_ˇche_˛ór
(&
s˘x
->
dú_¸óãd_ˇche
);

8407 
	`båfs_Ãu_ˇche_˛ór
(&
s˘x
->
dú_utimes_ˇche
);

8409 
	`k‰ì
(
s˘x
);

8412  
ªt
;

8413 
	}
}

	@send.h

7 #i‚de‡
BTRFS_SEND_H


8 
	#BTRFS_SEND_H


	)

10 
	~<löux/ty≥s.h
>

12 
	#BTRFS_SEND_STREAM_MAGIC
 "båfs-°ªam"

	)

14 #ifde‡
CONFIG_BTRFS_DEBUG


15 
	#BTRFS_SEND_STREAM_VERSION
 3

	)

17 
	#BTRFS_SEND_STREAM_VERSION
 2

	)

25 
	#BTRFS_SEND_BUF_SIZE_V1
 
SZ_64K


	)

26 
	#BTRFS_SEND_BUF_SIZE_V2
 
	`ALIGN
(
SZ_16K
 + 
BTRFS_MAX_COMPRESSED
, 
PAGE_SIZE
)

	)

28 
	göode
;

29 
	gbåfs_io˘l_£nd_¨gs
;

31 
	ebåfs_év_ty≥
 {

32 
	mBTRFS_TLV_U8
,

33 
	mBTRFS_TLV_U16
,

34 
	mBTRFS_TLV_U32
,

35 
	mBTRFS_TLV_U64
,

36 
	mBTRFS_TLV_BINARY
,

37 
	mBTRFS_TLV_STRING
,

38 
	mBTRFS_TLV_UUID
,

39 
	mBTRFS_TLV_TIMESPEC
,

42 
	sbåfs_°ªam_hódî
 {

43 
	mmagic
[(
BTRFS_SEND_STREAM_MAGIC
)];

44 
__À32
 
	mvîsi⁄
;

45 } 
__©åibuã__
 ((
__∑cked__
));

47 
	sbåfs_cmd_hódî
 {

49 
__À32
 
	mÀn
;

50 
__À16
 
	mcmd
;

52 
__À32
 
	m¸c
;

53 } 
__©åibuã__
 ((
__∑cked__
));

55 
	sbåfs_év_hódî
 {

56 
__À16
 
	mév_ty≥
;

58 
__À16
 
	mév_Àn
;

59 } 
__©åibuã__
 ((
__∑cked__
));

62 
	ebåfs_£nd_cmd
 {

63 
	mBTRFS_SEND_C_UNSPEC
 = 0,

66 
	mBTRFS_SEND_C_SUBVOL
 = 1,

67 
	mBTRFS_SEND_C_SNAPSHOT
 = 2,

69 
	mBTRFS_SEND_C_MKFILE
 = 3,

70 
	mBTRFS_SEND_C_MKDIR
 = 4,

71 
	mBTRFS_SEND_C_MKNOD
 = 5,

72 
	mBTRFS_SEND_C_MKFIFO
 = 6,

73 
	mBTRFS_SEND_C_MKSOCK
 = 7,

74 
	mBTRFS_SEND_C_SYMLINK
 = 8,

76 
	mBTRFS_SEND_C_RENAME
 = 9,

77 
	mBTRFS_SEND_C_LINK
 = 10,

78 
	mBTRFS_SEND_C_UNLINK
 = 11,

79 
	mBTRFS_SEND_C_RMDIR
 = 12,

81 
	mBTRFS_SEND_C_SET_XATTR
 = 13,

82 
	mBTRFS_SEND_C_REMOVE_XATTR
 = 14,

84 
	mBTRFS_SEND_C_WRITE
 = 15,

85 
	mBTRFS_SEND_C_CLONE
 = 16,

87 
	mBTRFS_SEND_C_TRUNCATE
 = 17,

88 
	mBTRFS_SEND_C_CHMOD
 = 18,

89 
	mBTRFS_SEND_C_CHOWN
 = 19,

90 
	mBTRFS_SEND_C_UTIMES
 = 20,

92 
	mBTRFS_SEND_C_END
 = 21,

93 
	mBTRFS_SEND_C_UPDATE_EXTENT
 = 22,

94 
	mBTRFS_SEND_C_MAX_V1
 = 22,

97 
	mBTRFS_SEND_C_FALLOCATE
 = 23,

98 
	mBTRFS_SEND_C_FILEATTR
 = 24,

99 
	mBTRFS_SEND_C_ENCODED_WRITE
 = 25,

100 
	mBTRFS_SEND_C_MAX_V2
 = 25,

103 
	mBTRFS_SEND_C_ENABLE_VERITY
 = 26,

104 
	mBTRFS_SEND_C_MAX_V3
 = 26,

106 
	mBTRFS_SEND_C_MAX
 = 26,

111 
	mBTRFS_SEND_A_UNSPEC
 = 0,

114 
	mBTRFS_SEND_A_UUID
 = 1,

115 
	mBTRFS_SEND_A_CTRANSID
 = 2,

117 
	mBTRFS_SEND_A_INO
 = 3,

118 
	mBTRFS_SEND_A_SIZE
 = 4,

119 
	mBTRFS_SEND_A_MODE
 = 5,

120 
	mBTRFS_SEND_A_UID
 = 6,

121 
	mBTRFS_SEND_A_GID
 = 7,

122 
	mBTRFS_SEND_A_RDEV
 = 8,

123 
	mBTRFS_SEND_A_CTIME
 = 9,

124 
	mBTRFS_SEND_A_MTIME
 = 10,

125 
	mBTRFS_SEND_A_ATIME
 = 11,

126 
	mBTRFS_SEND_A_OTIME
 = 12,

128 
	mBTRFS_SEND_A_XATTR_NAME
 = 13,

129 
	mBTRFS_SEND_A_XATTR_DATA
 = 14,

131 
	mBTRFS_SEND_A_PATH
 = 15,

132 
	mBTRFS_SEND_A_PATH_TO
 = 16,

133 
	mBTRFS_SEND_A_PATH_LINK
 = 17,

135 
	mBTRFS_SEND_A_FILE_OFFSET
 = 18,

141 
	mBTRFS_SEND_A_DATA
 = 19,

143 
	mBTRFS_SEND_A_CLONE_UUID
 = 20,

144 
	mBTRFS_SEND_A_CLONE_CTRANSID
 = 21,

145 
	mBTRFS_SEND_A_CLONE_PATH
 = 22,

146 
	mBTRFS_SEND_A_CLONE_OFFSET
 = 23,

147 
	mBTRFS_SEND_A_CLONE_LEN
 = 24,

149 
	mBTRFS_SEND_A_MAX_V1
 = 24,

152 
	mBTRFS_SEND_A_FALLOCATE_MODE
 = 25,

160 
	mBTRFS_SEND_A_FILEATTR
 = 26,

162 
	mBTRFS_SEND_A_UNENCODED_FILE_LEN
 = 27,

163 
	mBTRFS_SEND_A_UNENCODED_LEN
 = 28,

164 
	mBTRFS_SEND_A_UNENCODED_OFFSET
 = 29,

169 
	mBTRFS_SEND_A_COMPRESSION
 = 30,

170 
	mBTRFS_SEND_A_ENCRYPTION
 = 31,

171 
	mBTRFS_SEND_A_MAX_V2
 = 31,

174 
	mBTRFS_SEND_A_VERITY_ALGORITHM
 = 32,

175 
	mBTRFS_SEND_A_VERITY_BLOCK_SIZE
 = 33,

176 
	mBTRFS_SEND_A_VERITY_SALT_DATA
 = 34,

177 
	mBTRFS_SEND_A_VERITY_SIG_DATA
 = 35,

178 
	mBTRFS_SEND_A_MAX_V3
 = 35,

180 
	m__BTRFS_SEND_A_MAX
 = 35,

183 
båfs_io˘l_£nd
(
öode
 *öode, 
båfs_io˘l_£nd_¨gs
 *
¨g
);

	@space-info.c

3 
	~"misc.h
"

4 
	~"˘ªe.h
"

5 
	~"•a˚-öfo.h
"

6 
	~"sysfs.h
"

7 
	~"vﬁumes.h
"

8 
	~"‰ì-•a˚-ˇche.h
"

9 
	~"‹dîed-d©a.h
"

10 
	~"å™ß˘i⁄.h
"

11 
	~"block-group.h
"

12 
	~"z⁄ed.h
"

13 
	~"fs.h
"

14 
	~"ac˚ss‹s.h
"

15 
	~"exã¡-åì.h
"

165 
u64
 
__puª
 
	$båfs_•a˚_öfo_u£d
(
båfs_•a˚_öfo
 *
s_öfo
,

166 
boﬁ
 
may_u£_ö˛uded
)

168 
	`ASSERT
(
s_öfo
);

169  
s_öfo
->
byãs_u£d
 + s_öfo->
byãs_ª£rved
 +

170 
s_öfo
->
byãs_pö√d
 + s_öfo->
byãs_ªad⁄ly
 +

171 
s_öfo
->
byãs_z⁄e_unußbÀ
 +

172 (
may_u£_ö˛uded
 ? 
s_öfo
->
byãs_may_u£
 : 0);

173 
	}
}

179 
	$båfs_˛ór_•a˚_öfo_fuŒ
(
båfs_fs_öfo
 *
öfo
)

181 
li°_hód
 *
hód
 = &
öfo
->
•a˚_öfo
;

182 
båfs_•a˚_öfo
 *
found
;

184 
	`li°_f‹_óch_íåy
(
found
, 
hód
, 
li°
)

185 
found
->
fuŒ
 = 0;

186 
	}
}

192 
	#BTRFS_DEFAULT_ZONED_RECLAIM_THRESH
 (75)

	)

197 
u64
 
	$ˇlc_chunk_size
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
Êags
)

199 i‡(
	`båfs_is_z⁄ed
(
fs_öfo
))

200  
fs_öfo
->
z⁄e_size
;

202 
	`ASSERT
(
Êags
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
);

204 i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
)

205  
BTRFS_MAX_DATA_CHUNK_SIZE
;

206 i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

207  
SZ_32M
;

210 i‡(
fs_öfo
->
fs_devi˚s
->
tŸÆ_rw_byãs
 > 50ULL * 
SZ_1G
)

211  
SZ_1G
;

213  
SZ_256M
;

214 
	}
}

219 
	$båfs_upd©e_•a˚_öfo_chunk_size
(
båfs_•a˚_öfo
 *
•a˚_öfo
,

220 
u64
 
chunk_size
)

222 
	`WRITE_ONCE
(
•a˚_öfo
->
chunk_size
, chunk_size);

223 
	}
}

225 
	$¸óã_•a˚_öfo
(
båfs_fs_öfo
 *
öfo
, 
u64
 
Êags
)

228 
båfs_•a˚_öfo
 *
•a˚_öfo
;

229 
i
;

230 
ªt
;

232 
•a˚_öfo
 = 
	`kzÆloc
((*•a˚_öfo), 
GFP_NOFS
);

233 i‡(!
•a˚_öfo
)

234  -
ENOMEM
;

236 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; i++)

237 
	`INIT_LIST_HEAD
(&
•a˚_öfo
->
block_groups
[
i
]);

238 
	`öô_rw£m
(&
•a˚_öfo
->
groups_£m
);

239 
	`•ö_lock_öô
(&
•a˚_öfo
->
lock
);

240 
•a˚_öfo
->
Êags
 = fœg†& 
BTRFS_BLOCK_GROUP_TYPE_MASK
;

241 
•a˚_öfo
->
f‹˚_Æloc
 = 
CHUNK_ALLOC_NO_FORCE
;

242 
	`INIT_LIST_HEAD
(&
•a˚_öfo
->
ro_bgs
);

243 
	`INIT_LIST_HEAD
(&
•a˚_öfo
->
tickës
);

244 
	`INIT_LIST_HEAD
(&
•a˚_öfo
->
¥i‹ôy_tickës
);

245 
•a˚_öfo
->
˛amp
 = 1;

246 
	`båfs_upd©e_•a˚_öfo_chunk_size
(
•a˚_öfo
, 
	`ˇlc_chunk_size
(
öfo
, 
Êags
));

248 i‡(
	`båfs_is_z⁄ed
(
öfo
))

249 
•a˚_öfo
->
bg_ª˛aim_thªshﬁd
 = 
BTRFS_DEFAULT_ZONED_RECLAIM_THRESH
;

251 
ªt
 = 
	`båfs_sysfs_add_•a˚_öfo_ty≥
(
öfo
, 
•a˚_öfo
);

252 i‡(
ªt
)

253  
ªt
;

255 
	`li°_add
(&
•a˚_öfo
->
li°
, &
öfo
->space_info);

256 i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
)

257 
öfo
->
d©a_söfo
 = 
•a˚_öfo
;

259  
ªt
;

260 
	}
}

262 
	$båfs_öô_•a˚_öfo
(
båfs_fs_öfo
 *
fs_öfo
)

264 
båfs_su≥r_block
 *
disk_su≥r
;

265 
u64
 
„©uªs
;

266 
u64
 
Êags
;

267 
mixed
 = 0;

268 
ªt
;

270 
disk_su≥r
 = 
fs_öfo
->
su≥r_c›y
;

271 i‡(!
	`båfs_su≥r_roŸ
(
disk_su≥r
))

272  -
EINVAL
;

274 
„©uªs
 = 
	`båfs_su≥r_öcom∑t_Êags
(
disk_su≥r
);

275 i‡(
„©uªs
 & 
BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
)

276 
mixed
 = 1;

278 
Êags
 = 
BTRFS_BLOCK_GROUP_SYSTEM
;

279 
ªt
 = 
	`¸óã_•a˚_öfo
(
fs_öfo
, 
Êags
);

280 i‡(
ªt
)

281 
out
;

283 i‡(
mixed
) {

284 
Êags
 = 
BTRFS_BLOCK_GROUP_METADATA
 | 
BTRFS_BLOCK_GROUP_DATA
;

285 
ªt
 = 
	`¸óã_•a˚_öfo
(
fs_öfo
, 
Êags
);

287 
Êags
 = 
BTRFS_BLOCK_GROUP_METADATA
;

288 
ªt
 = 
	`¸óã_•a˚_öfo
(
fs_öfo
, 
Êags
);

289 i‡(
ªt
)

290 
out
;

292 
Êags
 = 
BTRFS_BLOCK_GROUP_DATA
;

293 
ªt
 = 
	`¸óã_•a˚_öfo
(
fs_öfo
, 
Êags
);

295 
out
:

296  
ªt
;

297 
	}
}

299 
	$båfs_add_bg_to_•a˚_öfo
(
båfs_fs_öfo
 *
öfo
,

300 
båfs_block_group
 *
block_group
)

302 
båfs_•a˚_öfo
 *
found
;

303 
Á˘‹
, 
ödex
;

305 
Á˘‹
 = 
	`båfs_bg_ty≥_to_Á˘‹
(
block_group
->
Êags
);

307 
found
 = 
	`båfs_föd_•a˚_öfo
(
öfo
, 
block_group
->
Êags
);

308 
	`ASSERT
(
found
);

309 
	`•ö_lock
(&
found
->
lock
);

310 
found
->
tŸÆ_byãs
 +
block_group
->
Àngth
;

311 
found
->
disk_tŸÆ
 +
block_group
->
Àngth
 * 
Á˘‹
;

312 
found
->
byãs_u£d
 +
block_group
->
u£d
;

313 
found
->
disk_u£d
 +
block_group
->
u£d
 * 
Á˘‹
;

314 
found
->
byãs_ªad⁄ly
 +
block_group
->
byãs_su≥r
;

315 
found
->
byãs_z⁄e_unußbÀ
 +
block_group
->
z⁄e_unußbÀ
;

316 i‡(
block_group
->
Àngth
 > 0)

317 
found
->
fuŒ
 = 0;

318 
	`båfs_åy_gø¡ög_tickës
(
öfo
, 
found
);

319 
	`•ö_u∆ock
(&
found
->
lock
);

321 
block_group
->
•a˚_öfo
 = 
found
;

323 
ödex
 = 
	`båfs_bg_Êags_to_øid_ödex
(
block_group
->
Êags
);

324 
	`down_wrôe
(&
found
->
groups_£m
);

325 
	`li°_add_èû
(&
block_group
->
li°
, &
found
->
block_groups
[
ödex
]);

326 
	`up_wrôe
(&
found
->
groups_£m
);

327 
	}
}

329 
båfs_•a˚_öfo
 *
	$båfs_föd_•a˚_öfo
(
båfs_fs_öfo
 *
öfo
,

330 
u64
 
Êags
)

332 
li°_hód
 *
hód
 = &
öfo
->
•a˚_öfo
;

333 
båfs_•a˚_öfo
 *
found
;

335 
Êags
 &
BTRFS_BLOCK_GROUP_TYPE_MASK
;

337 
	`li°_f‹_óch_íåy
(
found
, 
hód
, 
li°
) {

338 i‡(
found
->
Êags
 & flags)

339  
found
;

341  
NULL
;

342 
	}
}

344 
u64
 
	$ˇlc_avaûabÀ_‰ì_•a˚
(
båfs_fs_öfo
 *
fs_öfo
,

345 
båfs_•a˚_öfo
 *
•a˚_öfo
,

346 
båfs_ª£rve_Êush_íum
 
Êush
)

348 
u64
 
¥ofûe
;

349 
u64
 
avaû
;

350 
Á˘‹
;

352 i‡(
•a˚_öfo
->
Êags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

353 
¥ofûe
 = 
	`båfs_sy°em_Æloc_¥ofûe
(
fs_öfo
);

355 
¥ofûe
 = 
	`båfs_mëad©a_Æloc_¥ofûe
(
fs_öfo
);

357 
avaû
 = 
	`©omic64_ªad
(&
fs_öfo
->
‰ì_chunk_•a˚
);

365 
Á˘‹
 = 
	`båfs_bg_ty≥_to_Á˘‹
(
¥ofûe
);

366 
avaû
 = 
	`div_u64
◊vaû, 
Á˘‹
);

373 i‡(
Êush
 =
BTRFS_RESERVE_FLUSH_ALL
)

374 
avaû
 >>= 3;

376 
avaû
 >>= 1;

377  
avaû
;

378 
	}
}

380 
	$båfs_ˇn_ovîcommô
(
båfs_fs_öfo
 *
fs_öfo
,

381 
båfs_•a˚_öfo
 *
•a˚_öfo
, 
u64
 
byãs
,

382 
båfs_ª£rve_Êush_íum
 
Êush
)

384 
u64
 
avaû
;

385 
u64
 
u£d
;

388 i‡(
•a˚_öfo
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
)

391 
u£d
 = 
	`båfs_•a˚_öfo_u£d
(
•a˚_öfo
, 
åue
);

392 
avaû
 = 
	`ˇlc_avaûabÀ_‰ì_•a˚
(
fs_öfo
, 
•a˚_öfo
, 
Êush
);

394 i‡(
u£d
 + 
byãs
 < 
•a˚_öfo
->
tŸÆ_byãs
 + 
avaû
)

397 
	}
}

399 
	$ªmove_tickë
(
båfs_•a˚_öfo
 *
•a˚_öfo
,

400 
ª£rve_tickë
 *
tickë
)

402 i‡(!
	`li°_em±y
(&
tickë
->
li°
)) {

403 
	`li°_dñ_öô
(&
tickë
->
li°
);

404 
	`ASSERT
(
•a˚_öfo
->
ª˛aim_size
 >
tickë
->
byãs
);

405 
•a˚_öfo
->
ª˛aim_size
 -
tickë
->
byãs
;

407 
	}
}

413 
	$båfs_åy_gø¡ög_tickës
(
båfs_fs_öfo
 *
fs_öfo
,

414 
båfs_•a˚_öfo
 *
•a˚_öfo
)

416 
li°_hód
 *
hód
;

417 
båfs_ª£rve_Êush_íum
 
Êush
 = 
BTRFS_RESERVE_NO_FLUSH
;

419 
	`lockdï_as£π_hñd
(&
•a˚_öfo
->
lock
);

421 
hód
 = &
•a˚_öfo
->
¥i‹ôy_tickës
;

422 
agaö
:

423 !
	`li°_em±y
(
hód
)) {

424 
ª£rve_tickë
 *
tickë
;

425 
u64
 
u£d
 = 
	`båfs_•a˚_öfo_u£d
(
•a˚_öfo
, 
åue
);

427 
tickë
 = 
	`li°_fú°_íåy
(
hód
, 
ª£rve_tickë
, 
li°
);

430 i‡((
u£d
 + 
tickë
->
byãs
 <
•a˚_öfo
->
tŸÆ_byãs
) ||

431 
	`båfs_ˇn_ovîcommô
(
fs_öfo
, 
•a˚_öfo
, 
tickë
->
byãs
,

432 
Êush
)) {

433 
	`båfs_•a˚_öfo_upd©e_byãs_may_u£
(
fs_öfo
,

434 
•a˚_öfo
,

435 
tickë
->
byãs
);

436 
	`ªmove_tickë
(
•a˚_öfo
, 
tickë
);

437 
tickë
->
byãs
 = 0;

438 
•a˚_öfo
->
tickës_id
++;

439 
	`wake_up
(&
tickë
->
waô
);

445 i‡(
hód
 =&
•a˚_öfo
->
¥i‹ôy_tickës
) {

446 
hód
 = &
•a˚_öfo
->
tickës
;

447 
Êush
 = 
BTRFS_RESERVE_FLUSH_ALL
;

448 
agaö
;

450 
	}
}

452 
	#DUMP_BLOCK_RSV
(
fs_öfo
, 
rsv_«me
) \

454 
båfs_block_rsv
 *
__rsv
 = &(
fs_öfo
)->
rsv_«me
; \

455 
	`•ö_lock
(&
__rsv
->
lock
); \

456 
	`båfs_öfo
(
fs_öfo
, #rsv_name ": size %lluÑeserved %llu", \

457 
__rsv
->
size
, __rsv->
ª£rved
); \

458 
	`•ö_u∆ock
(&
__rsv
->
lock
); \

459 } 0)

	)

461 c⁄° *
	$•a˚_öfo_Êag_to_°r
(c⁄° 
båfs_•a˚_öfo
 *
•a˚_öfo
)

463 
•a˚_öfo
->
Êags
) {

464 
BTRFS_BLOCK_GROUP_SYSTEM
:

466 
BTRFS_BLOCK_GROUP_METADATA
 | 
BTRFS_BLOCK_GROUP_DATA
:

468 
BTRFS_BLOCK_GROUP_DATA
:

470 
BTRFS_BLOCK_GROUP_METADATA
:

475 
	}
}

477 
	$dump_globÆ_block_rsv
(
båfs_fs_öfo
 *
fs_öfo
)

479 
	`DUMP_BLOCK_RSV
(
fs_öfo
, 
globÆ_block_rsv
);

480 
	`DUMP_BLOCK_RSV
(
fs_öfo
, 
å™s_block_rsv
);

481 
	`DUMP_BLOCK_RSV
(
fs_öfo
, 
chunk_block_rsv
);

482 
	`DUMP_BLOCK_RSV
(
fs_öfo
, 
dñayed_block_rsv
);

483 
	`DUMP_BLOCK_RSV
(
fs_öfo
, 
dñayed_ªfs_rsv
);

484 
	}
}

486 
	$__båfs_dump_•a˚_öfo
(
båfs_fs_öfo
 *
fs_öfo
,

487 
båfs_•a˚_öfo
 *
öfo
)

489 c⁄° *
Êag_°r
 = 
	`•a˚_öfo_Êag_to_°r
(
öfo
);

490 
	`lockdï_as£π_hñd
(&
öfo
->
lock
);

493 
	`båfs_öfo
(
fs_öfo
, "space_info %s has %lld free, is %sfull",

494 
Êag_°r
,

495 (
s64
)(
öfo
->
tŸÆ_byãs
 - 
	`båfs_•a˚_öfo_u£d
(öfo, 
åue
)),

496 
öfo
->
fuŒ
 ? "" : "not ");

497 
	`båfs_öfo
(
fs_öfo
,

499 
öfo
->
tŸÆ_byãs
, info->
byãs_u£d
, info->
byãs_pö√d
,

500 
öfo
->
byãs_ª£rved
, info->
byãs_may_u£
,

501 
öfo
->
byãs_ªad⁄ly
, info->
byãs_z⁄e_unußbÀ
);

502 
	}
}

504 
	$båfs_dump_•a˚_öfo
(
båfs_fs_öfo
 *
fs_öfo
,

505 
båfs_•a˚_öfo
 *
öfo
, 
u64
 
byãs
,

506 
dump_block_groups
)

508 
båfs_block_group
 *
ˇche
;

509 
u64
 
tŸÆ_avaû
 = 0;

510 
ödex
 = 0;

512 
	`•ö_lock
(&
öfo
->
lock
);

513 
	`__båfs_dump_•a˚_öfo
(
fs_öfo
, 
öfo
);

514 
	`dump_globÆ_block_rsv
(
fs_öfo
);

515 
	`•ö_u∆ock
(&
öfo
->
lock
);

517 i‡(!
dump_block_groups
)

520 
	`down_ªad
(&
öfo
->
groups_£m
);

521 
agaö
:

522 
	`li°_f‹_óch_íåy
(
ˇche
, &
öfo
->
block_groups
[
ödex
], 
li°
) {

523 
u64
 
avaû
;

525 
	`•ö_lock
(&
ˇche
->
lock
);

526 
avaû
 = 
ˇche
->
Àngth
 - cache->
u£d
 - cache->
pö√d
 -

527 
ˇche
->
ª£rved
 - cache->
dñÆloc_byãs
 -

528 
ˇche
->
byãs_su≥r
 - cache->
z⁄e_unußbÀ
;

529 
	`båfs_öfo
(
fs_öfo
,

531 
ˇche
->
°¨t
, cache->
Àngth
, cache->
u£d
, cache->
pö√d
,

532 
ˇche
->
ª£rved
, cache->
dñÆloc_byãs
,

533 
ˇche
->
byãs_su≥r
, cache->
z⁄e_unußbÀ
,

534 
avaû
, 
ˇche
->
ro
 ? "[readonly]" : "");

535 
	`•ö_u∆ock
(&
ˇche
->
lock
);

536 
	`båfs_dump_‰ì_•a˚
(
ˇche
, 
byãs
);

537 
tŸÆ_avaû
 +
avaû
;

539 i‡(++
ödex
 < 
BTRFS_NR_RAID_TYPES
)

540 
agaö
;

541 
	`up_ªad
(&
öfo
->
groups_£m
);

543 
	`båfs_öfo
(
fs_öfo
, "%Œu byã†avaûabÀá¸os†Æ»block groups", 
tŸÆ_avaû
);

544 
	}
}

546 
ölöe
 
u64
 
	$ˇlc_ª˛aim_ôems_ƒ
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

547 
u64
 
to_ª˛aim
)

549 
u64
 
byãs
;

550 
u64
 
ƒ
;

552 
byãs
 = 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
, 1);

553 
ƒ
 = 
	`div64_u64
(
to_ª˛aim
, 
byãs
);

554 i‡(!
ƒ
)

555 
ƒ
 = 1;

556  
ƒ
;

557 
	}
}

559 
ölöe
 
u64
 
	$ˇlc_dñayed_ªfs_ƒ
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

560 
u64
 
to_ª˛aim
)

562 c⁄° 
u64
 
byãs
 = 
	`båfs_ˇlc_dñayed_ªf_byãs
(
fs_öfo
, 1);

563 
u64
 
ƒ
;

565 
ƒ
 = 
	`div64_u64
(
to_ª˛aim
, 
byãs
);

566 i‡(!
ƒ
)

567 
ƒ
 = 1;

568  
ƒ
;

569 
	}
}

571 
	#EXTENT_SIZE_PER_ITEM
 
SZ_256K


	)

576 
	$shrök_dñÆloc
(
båfs_fs_öfo
 *
fs_öfo
,

577 
båfs_•a˚_öfo
 *
•a˚_öfo
,

578 
u64
 
to_ª˛aim
, 
boﬁ
 
waô_‹dîed
,

579 
boﬁ
 
f‹_¥ìm±
)

581 
båfs_å™s_h™dÀ
 *
å™s
;

582 
u64
 
dñÆloc_byãs
;

583 
u64
 
‹dîed_byãs
;

584 
u64
 
ôems
;

585 
time_À·
;

586 
lo›s
;

588 
dñÆloc_byãs
 = 
	`≥r˝u_cou¡î_sum_posôive
(&
fs_öfo
->delalloc_bytes);

589 
‹dîed_byãs
 = 
	`≥r˝u_cou¡î_sum_posôive
(&
fs_öfo
->ordered_bytes);

590 i‡(
dñÆloc_byãs
 =0 && 
‹dîed_byãs
 == 0)

594 i‡(
to_ª˛aim
 =
U64_MAX
) {

595 
ôems
 = 
U64_MAX
;

609 
to_ª˛aim
 = 
	`max
—o_ª˛aim, 
dñÆloc_byãs
 >> 3);

610 
ôems
 = 
	`ˇlc_ª˛aim_ôems_ƒ
(
fs_öfo
, 
to_ª˛aim
) * 2;

613 
å™s
 = 
cuºít
->
jou∫Æ_öfo
;

620 i‡(
‹dîed_byãs
 > 
dñÆloc_byãs
 && !
f‹_¥ìm±
)

621 
waô_‹dîed
 = 
åue
;

623 
lo›s
 = 0;

624 (
dñÆloc_byãs
 || 
‹dîed_byãs
Ë&& 
lo›s
 < 3) {

625 
u64
 
ãmp
 = 
	`mö
(
dñÆloc_byãs
, 
to_ª˛aim
Ë>> 
PAGE_SHIFT
;

626 
ƒ_∑ges
 = 
	`mö_t
(
u64
, 
ãmp
, 
LONG_MAX
);

627 
async_∑ges
;

629 
	`båfs_°¨t_dñÆloc_roŸs
(
fs_öfo
, 
ƒ_∑ges
, 
åue
);

652 
async_∑ges
 = 
	`©omic_ªad
(&
fs_öfo
->
async_dñÆloc_∑ges
);

653 i‡(!
async_∑ges
)

654 
skù_async
;

662 i‡(
async_∑ges
 > 
ƒ_∑ges
)

663 
async_∑ges
 -
ƒ_∑ges
;

665 
async_∑ges
 = 0;

666 
	`waô_evít
(
fs_öfo
->
async_submô_waô
,

667 
	`©omic_ªad
(&
fs_öfo
->
async_dñÆloc_∑ges
) <=

668 
async_∑ges
);

669 
skù_async
:

670 
lo›s
++;

671 i‡(
waô_‹dîed
 && !
å™s
) {

672 
	`båfs_waô_‹dîed_roŸs
(
fs_öfo
, 
ôems
, 0, (
u64
)-1);

674 
time_À·
 = 
	`scheduÀ_timeout_kûœbÀ
(1);

675 i‡(
time_À·
)

684 i‡(
f‹_¥ìm±
)

687 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

688 i‡(
	`li°_em±y
(&
•a˚_öfo
->
tickës
) &&

689 
	`li°_em±y
(&
•a˚_öfo
->
¥i‹ôy_tickës
)) {

690 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

693 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

695 
dñÆloc_byãs
 = 
	`≥r˝u_cou¡î_sum_posôive
(

696 &
fs_öfo
->
dñÆloc_byãs
);

697 
‹dîed_byãs
 = 
	`≥r˝u_cou¡î_sum_posôive
(

698 &
fs_öfo
->
‹dîed_byãs
);

700 
	}
}

707 
	$Êush_•a˚
(
båfs_fs_öfo
 *
fs_öfo
,

708 
båfs_•a˚_öfo
 *
•a˚_öfo
, 
u64
 
num_byãs
,

709 
båfs_Êush_°©e
 
°©e
, 
boﬁ
 
f‹_¥ìm±
)

711 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
åì_roŸ
;

712 
båfs_å™s_h™dÀ
 *
å™s
;

713 
ƒ
;

714 
ªt
 = 0;

716 
°©e
) {

717 
FLUSH_DELAYED_ITEMS_NR
:

718 
FLUSH_DELAYED_ITEMS
:

719 i‡(
°©e
 =
FLUSH_DELAYED_ITEMS_NR
)

720 
ƒ
 = 
	`ˇlc_ª˛aim_ôems_ƒ
(
fs_öfo
, 
num_byãs
) * 2;

722 
ƒ
 = -1;

724 
å™s
 = 
	`båfs_joö_å™ß˘i⁄_no°¨t
(
roŸ
);

725 i‡(
	`IS_ERR
(
å™s
)) {

726 
ªt
 = 
	`PTR_ERR
(
å™s
);

727 i‡(
ªt
 =-
ENOENT
)

728 
ªt
 = 0;

731 
ªt
 = 
	`båfs_run_dñayed_ôems_ƒ
(
å™s
, 
ƒ
);

732 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

734 
FLUSH_DELALLOC
:

735 
FLUSH_DELALLOC_WAIT
:

736 
FLUSH_DELALLOC_FULL
:

737 i‡(
°©e
 =
FLUSH_DELALLOC_FULL
)

738 
num_byãs
 = 
U64_MAX
;

739 
	`shrök_dñÆloc
(
fs_öfo
, 
•a˚_öfo
, 
num_byãs
,

740 
°©e
 !
FLUSH_DELALLOC
, 
f‹_¥ìm±
);

742 
FLUSH_DELAYED_REFS_NR
:

743 
FLUSH_DELAYED_REFS
:

744 
å™s
 = 
	`båfs_joö_å™ß˘i⁄_no°¨t
(
roŸ
);

745 i‡(
	`IS_ERR
(
å™s
)) {

746 
ªt
 = 
	`PTR_ERR
(
å™s
);

747 i‡(
ªt
 =-
ENOENT
)

748 
ªt
 = 0;

751 i‡(
°©e
 =
FLUSH_DELAYED_REFS_NR
)

752 
ƒ
 = 
	`ˇlc_dñayed_ªfs_ƒ
(
fs_öfo
, 
num_byãs
);

754 
ƒ
 = 0;

755 
	`båfs_run_dñayed_ªfs
(
å™s
, 
ƒ
);

756 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

758 
ALLOC_CHUNK
:

759 
ALLOC_CHUNK_FORCE
:

760 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
roŸ
);

761 i‡(
	`IS_ERR
(
å™s
)) {

762 
ªt
 = 
	`PTR_ERR
(
å™s
);

765 
ªt
 = 
	`båfs_chunk_Æloc
(
å™s
,

766 
	`båfs_gë_Æloc_¥ofûe
(
fs_öfo
, 
•a˚_öfo
->
Êags
),

767 (
°©e
 =
ALLOC_CHUNK
Ë? 
CHUNK_ALLOC_NO_FORCE
 :

768 
CHUNK_ALLOC_FORCE
);

769 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

771 i‡(
ªt
 > 0 ||Ñë =-
ENOSPC
)

772 
ªt
 = 0;

774 
RUN_DELAYED_IPUTS
:

780 
	`båfs_run_dñayed_ùuts
(
fs_öfo
);

781 
	`båfs_waô_⁄_dñayed_ùuts
(
fs_öfo
);

783 
COMMIT_TRANS
:

784 
	`ASSERT
(
cuºít
->
jou∫Æ_öfo
 =
NULL
);

792 
å™s
 = 
	`båfs_©èch_å™ß˘i⁄_b¨rõr
(
roŸ
);

793 i‡(
	`IS_ERR
(
å™s
)) {

794 
ªt
 = 
	`PTR_ERR
(
å™s
);

795 i‡(
ªt
 =-
ENOENT
)

796 
ªt
 = 0;

799 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

802 
ªt
 = -
ENOSPC
;

806 
	`åa˚_båfs_Êush_•a˚
(
fs_öfo
, 
•a˚_öfo
->
Êags
, 
num_byãs
, 
°©e
,

807 
ªt
, 
f‹_¥ìm±
);

809 
	}
}

811 
ölöe
 
u64


812 
	$båfs_ˇlc_ª˛aim_mëad©a_size
(
båfs_fs_öfo
 *
fs_öfo
,

813 
båfs_•a˚_öfo
 *
•a˚_öfo
)

815 
u64
 
u£d
;

816 
u64
 
avaû
;

817 
u64
 
to_ª˛aim
 = 
•a˚_öfo
->
ª˛aim_size
;

819 
	`lockdï_as£π_hñd
(&
•a˚_öfo
->
lock
);

821 
avaû
 = 
	`ˇlc_avaûabÀ_‰ì_•a˚
(
fs_öfo
, 
•a˚_öfo
,

822 
BTRFS_RESERVE_FLUSH_ALL
);

823 
u£d
 = 
	`båfs_•a˚_öfo_u£d
(
•a˚_öfo
, 
åue
);

831 i‡(
•a˚_öfo
->
tŸÆ_byãs
 + 
avaû
 < 
u£d
)

832 
to_ª˛aim
 +
u£d
 - (
•a˚_öfo
->
tŸÆ_byãs
 + 
avaû
);

834  
to_ª˛aim
;

835 
	}
}

837 
boﬁ
 
	$√ed_¥ìm±ive_ª˛aim
(
båfs_fs_öfo
 *
fs_öfo
,

838 
båfs_•a˚_öfo
 *
•a˚_öfo
)

840 
u64
 
globÆ_rsv_size
 = 
fs_öfo
->
globÆ_block_rsv
.
ª£rved
;

841 
u64
 
‹dîed
, 
dñÆloc
;

842 
u64
 
thªsh
;

843 
u64
 
u£d
;

845 
thªsh
 = 
	`mu…_≥rc
(
•a˚_öfo
->
tŸÆ_byãs
, 90);

847 
	`lockdï_as£π_hñd
(&
•a˚_öfo
->
lock
);

850 i‡((
•a˚_öfo
->
byãs_u£d
 + s∑˚_öfo->
byãs_ª£rved
 +

851 
globÆ_rsv_size
Ë>
thªsh
)

852  
Ál£
;

854 
u£d
 = 
•a˚_öfo
->
byãs_may_u£
 + s∑˚_öfo->
byãs_pö√d
;

857 i‡(
globÆ_rsv_size
 >
u£d
)

858  
Ál£
;

865 i‡(
u£d
 - 
globÆ_rsv_size
 <
SZ_128M
)

866  
Ál£
;

872 i‡(
•a˚_öfo
->
ª˛aim_size
)

873  
Ál£
;

904 
thªsh
 = 
	`ˇlc_avaûabÀ_‰ì_•a˚
(
fs_öfo
, 
•a˚_öfo
,

905 
BTRFS_RESERVE_FLUSH_ALL
);

906 
u£d
 = 
•a˚_öfo
->
byãs_u£d
 + s∑˚_öfo->
byãs_ª£rved
 +

907 
•a˚_öfo
->
byãs_ªad⁄ly
 + 
globÆ_rsv_size
;

908 i‡(
u£d
 < 
•a˚_öfo
->
tŸÆ_byãs
)

909 
thªsh
 +
•a˚_öfo
->
tŸÆ_byãs
 - 
u£d
;

910 
thªsh
 >>
•a˚_öfo
->
˛amp
;

912 
u£d
 = 
•a˚_öfo
->
byãs_pö√d
;

937 
‹dîed
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
fs_öfo
->
‹dîed_byãs
) >> 1;

938 
dñÆloc
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
fs_öfo
->
dñÆloc_byãs
);

939 i‡(
‹dîed
 >
dñÆloc
)

940 
u£d
 +
fs_öfo
->
dñayed_ªfs_rsv
.
ª£rved
 +

941 
fs_öfo
->
dñayed_block_rsv
.
ª£rved
;

943 
u£d
 +
•a˚_öfo
->
byãs_may_u£
 - 
globÆ_rsv_size
;

945  (
u£d
 >
thªsh
 && !
	`båfs_fs_˛osög
(
fs_öfo
) &&

946 !
	`ã°_bô
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_öfo
->
fs_°©e
));

947 
	}
}

949 
boﬁ
 
	$°ól_‰om_globÆ_rsv
(
båfs_fs_öfo
 *
fs_öfo
,

950 
båfs_•a˚_öfo
 *
•a˚_öfo
,

951 
ª£rve_tickë
 *
tickë
)

953 
båfs_block_rsv
 *
globÆ_rsv
 = &
fs_öfo
->
globÆ_block_rsv
;

954 
u64
 
mö_byãs
;

956 i‡(!
tickë
->
°ól
)

957  
Ál£
;

959 i‡(
globÆ_rsv
->
•a˚_öfo
 != space_info)

960  
Ál£
;

962 
	`•ö_lock
(&
globÆ_rsv
->
lock
);

963 
mö_byãs
 = 
	`mu…_≥rc
(
globÆ_rsv
->
size
, 10);

964 i‡(
globÆ_rsv
->
ª£rved
 < 
mö_byãs
 + 
tickë
->
byãs
) {

965 
	`•ö_u∆ock
(&
globÆ_rsv
->
lock
);

966  
Ál£
;

968 
globÆ_rsv
->
ª£rved
 -
tickë
->
byãs
;

969 
	`ªmove_tickë
(
•a˚_öfo
, 
tickë
);

970 
tickë
->
byãs
 = 0;

971 
	`wake_up
(&
tickë
->
waô
);

972 
•a˚_öfo
->
tickës_id
++;

973 i‡(
globÆ_rsv
->
ª£rved
 < globÆ_rsv->
size
)

974 
globÆ_rsv
->
fuŒ
 = 0;

975 
	`•ö_u∆ock
(&
globÆ_rsv
->
lock
);

977  
åue
;

978 
	}
}

995 
boﬁ
 
	$maybe_Áû_Æl_tickës
(
båfs_fs_öfo
 *
fs_öfo
,

996 
båfs_•a˚_öfo
 *
•a˚_öfo
)

998 
ª£rve_tickë
 *
tickë
;

999 
u64
 
tickës_id
 = 
•a˚_öfo
->tickets_id;

1000 c⁄° 
boﬁ
 
ab‹ãd
 = 
	`BTRFS_FS_ERROR
(
fs_öfo
);

1002 
	`åa˚_båfs_Áû_Æl_tickës
(
fs_öfo
, 
•a˚_öfo
);

1004 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
ENOSPC_DEBUG
)) {

1005 
	`båfs_öfo
(
fs_öfo
, "cannot satisfyÅickets, dumping space info");

1006 
	`__båfs_dump_•a˚_öfo
(
fs_öfo
, 
•a˚_öfo
);

1009 !
	`li°_em±y
(&
•a˚_öfo
->
tickës
) &&

1010 
tickës_id
 =
•a˚_öfo
->tickets_id) {

1011 
tickë
 = 
	`li°_fú°_íåy
(&
•a˚_öfo
->
tickës
,

1012 
ª£rve_tickë
, 
li°
);

1014 i‡(!
ab‹ãd
 && 
	`°ól_‰om_globÆ_rsv
(
fs_öfo
, 
•a˚_öfo
, 
tickë
))

1015  
åue
;

1017 i‡(!
ab‹ãd
 && 
	`båfs_ã°_›t
(
fs_öfo
, 
ENOSPC_DEBUG
))

1018 
	`båfs_öfo
(
fs_öfo
, "failingÅicket with %llu bytes",

1019 
tickë
->
byãs
);

1021 
	`ªmove_tickë
(
•a˚_öfo
, 
tickë
);

1022 i‡(
ab‹ãd
)

1023 
tickë
->
îr‹
 = -
EIO
;

1025 
tickë
->
îr‹
 = -
ENOSPC
;

1026 
	`wake_up
(&
tickë
->
waô
);

1034 i‡(!
ab‹ãd
)

1035 
	`båfs_åy_gø¡ög_tickës
(
fs_öfo
, 
•a˚_öfo
);

1037  (
tickës_id
 !
•a˚_öfo
->tickets_id);

1038 
	}
}

1045 
	$båfs_async_ª˛aim_mëad©a_•a˚
(
w‹k_°ru˘
 *
w‹k
)

1047 
båfs_fs_öfo
 *
fs_öfo
;

1048 
båfs_•a˚_öfo
 *
•a˚_öfo
;

1049 
u64
 
to_ª˛aim
;

1050 
båfs_Êush_°©e
 
Êush_°©e
;

1051 
commô_cy˛es
 = 0;

1052 
u64
 
œ°_tickës_id
;

1054 
fs_öfo
 = 
	`c⁄èöî_of
(
w‹k
, 
båfs_fs_öfo
, 
async_ª˛aim_w‹k
);

1055 
•a˚_öfo
 = 
	`båfs_föd_•a˚_öfo
(
fs_öfo
, 
BTRFS_BLOCK_GROUP_METADATA
);

1057 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1058 
to_ª˛aim
 = 
	`båfs_ˇlc_ª˛aim_mëad©a_size
(
fs_öfo
, 
•a˚_öfo
);

1059 i‡(!
to_ª˛aim
) {

1060 
•a˚_öfo
->
Êush
 = 0;

1061 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1064 
œ°_tickës_id
 = 
•a˚_öfo
->
tickës_id
;

1065 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1067 
Êush_°©e
 = 
FLUSH_DELAYED_ITEMS_NR
;

1069 
	`Êush_•a˚
(
fs_öfo
, 
•a˚_öfo
, 
to_ª˛aim
, 
Êush_°©e
, 
Ál£
);

1070 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1071 i‡(
	`li°_em±y
(&
•a˚_öfo
->
tickës
)) {

1072 
•a˚_öfo
->
Êush
 = 0;

1073 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1076 
to_ª˛aim
 = 
	`båfs_ˇlc_ª˛aim_mëad©a_size
(
fs_öfo
,

1077 
•a˚_öfo
);

1078 i‡(
œ°_tickës_id
 =
•a˚_öfo
->
tickës_id
) {

1079 
Êush_°©e
++;

1081 
œ°_tickës_id
 = 
•a˚_öfo
->
tickës_id
;

1082 
Êush_°©e
 = 
FLUSH_DELAYED_ITEMS_NR
;

1083 i‡(
commô_cy˛es
)

1084 
commô_cy˛es
--;

1092 i‡(
Êush_°©e
 =
FLUSH_DELALLOC_FULL
 && !
commô_cy˛es
)

1093 
Êush_°©e
++;

1105 i‡(
Êush_°©e
 =
ALLOC_CHUNK_FORCE
 && !
commô_cy˛es
)

1106 
Êush_°©e
++;

1108 i‡(
Êush_°©e
 > 
COMMIT_TRANS
) {

1109 
commô_cy˛es
++;

1110 i‡(
commô_cy˛es
 > 2) {

1111 i‡(
	`maybe_Áû_Æl_tickës
(
fs_öfo
, 
•a˚_öfo
)) {

1112 
Êush_°©e
 = 
FLUSH_DELAYED_ITEMS_NR
;

1113 
commô_cy˛es
--;

1115 
•a˚_öfo
->
Êush
 = 0;

1118 
Êush_°©e
 = 
FLUSH_DELAYED_ITEMS_NR
;

1121 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1122 } 
Êush_°©e
 <
COMMIT_TRANS
);

1123 
	}
}

1133 
	$båfs_¥ìm±_ª˛aim_mëad©a_•a˚
(
w‹k_°ru˘
 *
w‹k
)

1135 
båfs_fs_öfo
 *
fs_öfo
;

1136 
båfs_•a˚_öfo
 *
•a˚_öfo
;

1137 
båfs_block_rsv
 *
dñayed_block_rsv
;

1138 
båfs_block_rsv
 *
dñayed_ªfs_rsv
;

1139 
båfs_block_rsv
 *
globÆ_rsv
;

1140 
båfs_block_rsv
 *
å™s_rsv
;

1141 
lo›s
 = 0;

1143 
fs_öfo
 = 
	`c⁄èöî_of
(
w‹k
, 
båfs_fs_öfo
,

1144 
¥ìm±_ª˛aim_w‹k
);

1145 
•a˚_öfo
 = 
	`båfs_föd_•a˚_öfo
(
fs_öfo
, 
BTRFS_BLOCK_GROUP_METADATA
);

1146 
dñayed_block_rsv
 = &
fs_öfo
->delayed_block_rsv;

1147 
dñayed_ªfs_rsv
 = &
fs_öfo
->delayed_refs_rsv;

1148 
globÆ_rsv
 = &
fs_öfo
->
globÆ_block_rsv
;

1149 
å™s_rsv
 = &
fs_öfo
->
å™s_block_rsv
;

1151 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1152 
	`√ed_¥ìm±ive_ª˛aim
(
fs_öfo
, 
•a˚_öfo
)) {

1153 
båfs_Êush_°©e
 
Êush
;

1154 
u64
 
dñÆloc_size
 = 0;

1155 
u64
 
to_ª˛aim
, 
block_rsv_size
;

1156 
u64
 
globÆ_rsv_size
 = 
globÆ_rsv
->
ª£rved
;

1158 
lo›s
++;

1167 
block_rsv_size
 = 
globÆ_rsv_size
 +

1168 
dñayed_block_rsv
->
ª£rved
 +

1169 
dñayed_ªfs_rsv
->
ª£rved
 +

1170 
å™s_rsv
->
ª£rved
;

1171 i‡(
block_rsv_size
 < 
•a˚_öfo
->
byãs_may_u£
)

1172 
dñÆloc_size
 = 
•a˚_öfo
->
byãs_may_u£
 - 
block_rsv_size
;

1179 
block_rsv_size
 -
globÆ_rsv_size
;

1186 i‡(
dñÆloc_size
 > 
block_rsv_size
) {

1187 
to_ª˛aim
 = 
dñÆloc_size
;

1188 
Êush
 = 
FLUSH_DELALLOC
;

1189 } i‡(
•a˚_öfo
->
byãs_pö√d
 >

1190 (
dñayed_block_rsv
->
ª£rved
 +

1191 
dñayed_ªfs_rsv
->
ª£rved
)) {

1192 
to_ª˛aim
 = 
•a˚_öfo
->
byãs_pö√d
;

1193 
Êush
 = 
COMMIT_TRANS
;

1194 } i‡(
dñayed_block_rsv
->
ª£rved
 >

1195 
dñayed_ªfs_rsv
->
ª£rved
) {

1196 
to_ª˛aim
 = 
dñayed_block_rsv
->
ª£rved
;

1197 
Êush
 = 
FLUSH_DELAYED_ITEMS_NR
;

1199 
to_ª˛aim
 = 
dñayed_ªfs_rsv
->
ª£rved
;

1200 
Êush
 = 
FLUSH_DELAYED_REFS_NR
;

1203 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1210 
to_ª˛aim
 >>= 2;

1211 i‡(!
to_ª˛aim
)

1212 
to_ª˛aim
 = 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
, 1);

1213 
	`Êush_•a˚
(
fs_öfo
, 
•a˚_öfo
, 
to_ª˛aim
, 
Êush
, 
åue
);

1214 
	`c⁄d_ªsched
();

1215 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1219 i‡(
lo›s
 =1 && !
•a˚_öfo
->
ª˛aim_size
)

1220 
•a˚_öfo
->
˛amp
 = 
	`max
(1, space_info->clamp - 1);

1221 
	`åa˚_båfs_d⁄e_¥ìm±ive_ª˛aim
(
fs_öfo
, 
•a˚_öfo
);

1222 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1223 
	}
}

1258 c⁄° 
båfs_Êush_°©e
 
	gd©a_Êush_°©es
[] = {

1259 
FLUSH_DELALLOC_FULL
,

1260 
RUN_DELAYED_IPUTS
,

1261 
COMMIT_TRANS
,

1262 
ALLOC_CHUNK_FORCE
,

1265 
	$båfs_async_ª˛aim_d©a_•a˚
(
w‹k_°ru˘
 *
w‹k
)

1267 
båfs_fs_öfo
 *
fs_öfo
;

1268 
båfs_•a˚_öfo
 *
•a˚_öfo
;

1269 
u64
 
œ°_tickës_id
;

1270 
båfs_Êush_°©e
 
Êush_°©e
 = 0;

1272 
fs_öfo
 = 
	`c⁄èöî_of
(
w‹k
, 
båfs_fs_öfo
, 
async_d©a_ª˛aim_w‹k
);

1273 
•a˚_öfo
 = 
fs_öfo
->
d©a_söfo
;

1275 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1276 i‡(
	`li°_em±y
(&
•a˚_öfo
->
tickës
)) {

1277 
•a˚_öfo
->
Êush
 = 0;

1278 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1281 
œ°_tickës_id
 = 
•a˚_öfo
->
tickës_id
;

1282 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1284 !
•a˚_öfo
->
fuŒ
) {

1285 
	`Êush_•a˚
(
fs_öfo
, 
•a˚_öfo
, 
U64_MAX
, 
ALLOC_CHUNK_FORCE
, 
Ál£
);

1286 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1287 i‡(
	`li°_em±y
(&
•a˚_öfo
->
tickës
)) {

1288 
•a˚_öfo
->
Êush
 = 0;

1289 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1294 i‡(
	`BTRFS_FS_ERROR
(
fs_öfo
))

1295 
ab‹ãd_fs
;

1296 
œ°_tickës_id
 = 
•a˚_öfo
->
tickës_id
;

1297 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1300 
Êush_°©e
 < 
	`ARRAY_SIZE
(
d©a_Êush_°©es
)) {

1301 
	`Êush_•a˚
(
fs_öfo
, 
•a˚_öfo
, 
U64_MAX
,

1302 
d©a_Êush_°©es
[
Êush_°©e
], 
Ál£
);

1303 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1304 i‡(
	`li°_em±y
(&
•a˚_öfo
->
tickës
)) {

1305 
•a˚_öfo
->
Êush
 = 0;

1306 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1310 i‡(
œ°_tickës_id
 =
•a˚_öfo
->
tickës_id
) {

1311 
Êush_°©e
++;

1313 
œ°_tickës_id
 = 
•a˚_öfo
->
tickës_id
;

1314 
Êush_°©e
 = 0;

1317 i‡(
Êush_°©e
 >
	`ARRAY_SIZE
(
d©a_Êush_°©es
)) {

1318 i‡(
•a˚_öfo
->
fuŒ
) {

1319 i‡(
	`maybe_Áû_Æl_tickës
(
fs_öfo
, 
•a˚_öfo
))

1320 
Êush_°©e
 = 0;

1322 
•a˚_öfo
->
Êush
 = 0;

1324 
Êush_°©e
 = 0;

1328 i‡(
	`BTRFS_FS_ERROR
(
fs_öfo
))

1329 
ab‹ãd_fs
;

1332 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1336 
ab‹ãd_fs
:

1337 
	`maybe_Áû_Æl_tickës
(
fs_öfo
, 
•a˚_öfo
);

1338 
•a˚_öfo
->
Êush
 = 0;

1339 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1340 
	}
}

1342 
	$båfs_öô_async_ª˛aim_w‹k
(
båfs_fs_öfo
 *
fs_öfo
)

1344 
	`INIT_WORK
(&
fs_öfo
->
async_ª˛aim_w‹k
, 
båfs_async_ª˛aim_mëad©a_•a˚
);

1345 
	`INIT_WORK
(&
fs_öfo
->
async_d©a_ª˛aim_w‹k
, 
båfs_async_ª˛aim_d©a_•a˚
);

1346 
	`INIT_WORK
(&
fs_öfo
->
¥ìm±_ª˛aim_w‹k
,

1347 
båfs_¥ìm±_ª˛aim_mëad©a_•a˚
);

1348 
	}
}

1350 c⁄° 
båfs_Êush_°©e
 
	g¥i‹ôy_Êush_°©es
[] = {

1351 
FLUSH_DELAYED_ITEMS_NR
,

1352 
FLUSH_DELAYED_ITEMS
,

1353 
ALLOC_CHUNK
,

1356 c⁄° 
båfs_Êush_°©e
 
	gevi˘_Êush_°©es
[] = {

1357 
FLUSH_DELAYED_ITEMS_NR
,

1358 
FLUSH_DELAYED_ITEMS
,

1359 
FLUSH_DELAYED_REFS_NR
,

1360 
FLUSH_DELAYED_REFS
,

1361 
FLUSH_DELALLOC
,

1362 
FLUSH_DELALLOC_WAIT
,

1363 
FLUSH_DELALLOC_FULL
,

1364 
ALLOC_CHUNK
,

1365 
COMMIT_TRANS
,

1368 
	$¥i‹ôy_ª˛aim_mëad©a_•a˚
(
båfs_fs_öfo
 *
fs_öfo
,

1369 
båfs_•a˚_öfo
 *
•a˚_öfo
,

1370 
ª£rve_tickë
 *
tickë
,

1371 c⁄° 
båfs_Êush_°©e
 *
°©es
,

1372 
°©es_ƒ
)

1374 
u64
 
to_ª˛aim
;

1375 
Êush_°©e
 = 0;

1377 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1378 
to_ª˛aim
 = 
	`båfs_ˇlc_ª˛aim_mëad©a_size
(
fs_öfo
, 
•a˚_öfo
);

1385 i‡(
tickë
->
byãs
 == 0) {

1386 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1390 
Êush_°©e
 < 
°©es_ƒ
) {

1391 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1392 
	`Êush_•a˚
(
fs_öfo
, 
•a˚_öfo
, 
to_ª˛aim
, 
°©es
[
Êush_°©e
],

1393 
Ál£
);

1394 
Êush_°©e
++;

1395 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1396 i‡(
tickë
->
byãs
 == 0) {

1397 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1410 i‡(
	`BTRFS_FS_ERROR
(
fs_öfo
)) {

1411 
tickë
->
îr‹
 = 
	`BTRFS_FS_ERROR
(
fs_öfo
);

1412 
	`ªmove_tickë
(
•a˚_öfo
, 
tickë
);

1413 } i‡(!
	`°ól_‰om_globÆ_rsv
(
fs_öfo
, 
•a˚_öfo
, 
tickë
)) {

1414 
tickë
->
îr‹
 = -
ENOSPC
;

1415 
	`ªmove_tickë
(
•a˚_öfo
, 
tickë
);

1423 
	`båfs_åy_gø¡ög_tickës
(
fs_öfo
, 
•a˚_öfo
);

1424 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1425 
	}
}

1427 
	$¥i‹ôy_ª˛aim_d©a_•a˚
(
båfs_fs_öfo
 *
fs_öfo
,

1428 
båfs_•a˚_öfo
 *
•a˚_öfo
,

1429 
ª£rve_tickë
 *
tickë
)

1431 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1434 i‡(
tickë
->
byãs
 == 0) {

1435 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1439 !
•a˚_öfo
->
fuŒ
) {

1440 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1441 
	`Êush_•a˚
(
fs_öfo
, 
•a˚_öfo
, 
U64_MAX
, 
ALLOC_CHUNK_FORCE
, 
Ál£
);

1442 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1443 i‡(
tickë
->
byãs
 == 0) {

1444 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1449 
tickë
->
îr‹
 = -
ENOSPC
;

1450 
	`ªmove_tickë
(
•a˚_öfo
, 
tickë
);

1451 
	`båfs_åy_gø¡ög_tickës
(
fs_öfo
, 
•a˚_öfo
);

1452 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1453 
	}
}

1455 
	$waô_ª£rve_tickë
(
båfs_fs_öfo
 *
fs_öfo
,

1456 
båfs_•a˚_öfo
 *
•a˚_öfo
,

1457 
ª£rve_tickë
 *
tickë
)

1460 
	`DEFINE_WAIT
(
waô
);

1461 
ªt
 = 0;

1463 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1464 
tickë
->
byãs
 > 0 &&Åickë->
îr‹
 == 0) {

1465 
ªt
 = 
	`¥ï¨e_to_waô_evít
(&
tickë
->
waô
, &waô, 
TASK_KILLABLE
);

1466 i‡(
ªt
) {

1475 
	`ªmove_tickë
(
•a˚_öfo
, 
tickë
);

1476 
tickë
->
îr‹
 = -
EINTR
;

1479 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1481 
	`scheduÀ
();

1483 
	`föish_waô
(&
tickë
->
waô
, &wait);

1484 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1486 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1487 
	}
}

1502 
	$h™dÀ_ª£rve_tickë
(
båfs_fs_öfo
 *
fs_öfo
,

1503 
båfs_•a˚_öfo
 *
•a˚_öfo
,

1504 
ª£rve_tickë
 *
tickë
,

1505 
u64
 
°¨t_ns
, u64 
‹ig_byãs
,

1506 
båfs_ª£rve_Êush_íum
 
Êush
)

1508 
ªt
;

1510 
Êush
) {

1511 
BTRFS_RESERVE_FLUSH_DATA
:

1512 
BTRFS_RESERVE_FLUSH_ALL
:

1513 
BTRFS_RESERVE_FLUSH_ALL_STEAL
:

1514 
	`waô_ª£rve_tickë
(
fs_öfo
, 
•a˚_öfo
, 
tickë
);

1516 
BTRFS_RESERVE_FLUSH_LIMIT
:

1517 
	`¥i‹ôy_ª˛aim_mëad©a_•a˚
(
fs_öfo
, 
•a˚_öfo
, 
tickë
,

1518 
¥i‹ôy_Êush_°©es
,

1519 
	`ARRAY_SIZE
(
¥i‹ôy_Êush_°©es
));

1521 
BTRFS_RESERVE_FLUSH_EVICT
:

1522 
	`¥i‹ôy_ª˛aim_mëad©a_•a˚
(
fs_öfo
, 
•a˚_öfo
, 
tickë
,

1523 
evi˘_Êush_°©es
,

1524 
	`ARRAY_SIZE
(
evi˘_Êush_°©es
));

1526 
BTRFS_RESERVE_FLUSH_FREE_SPACE_INODE
:

1527 
	`¥i‹ôy_ª˛aim_d©a_•a˚
(
fs_öfo
, 
•a˚_öfo
, 
tickë
);

1530 
	`ASSERT
(0);

1534 
ªt
 = 
tickë
->
îr‹
;

1535 
	`ASSERT
(
	`li°_em±y
(&
tickë
->
li°
));

1542 
	`ASSERT
(!(
tickë
->
byãs
 =0 &&Åickë->
îr‹
));

1543 
	`åa˚_båfs_ª£rve_tickë
(
fs_öfo
, 
•a˚_öfo
->
Êags
, 
‹ig_byãs
,

1544 
°¨t_ns
, 
Êush
, 
tickë
->
îr‹
);

1545  
ªt
;

1546 
	}
}

1552 
ölöe
 
boﬁ
 
	$is_n‹mÆ_Êushög
(
båfs_ª£rve_Êush_íum
 
Êush
)

1554  (
Êush
 =
BTRFS_RESERVE_FLUSH_ALL
) ||

1555 (
Êush
 =
BTRFS_RESERVE_FLUSH_ALL_STEAL
);

1556 
	}
}

1558 
ölöe
 
	$maybe_˛amp_¥ìm±
(
båfs_fs_öfo
 *
fs_öfo
,

1559 
båfs_•a˚_öfo
 *
•a˚_öfo
)

1561 
u64
 
‹dîed
 = 
	`≥r˝u_cou¡î_sum_posôive
(&
fs_öfo
->
‹dîed_byãs
);

1562 
u64
 
dñÆloc
 = 
	`≥r˝u_cou¡î_sum_posôive
(&
fs_öfo
->
dñÆloc_byãs
);

1572 i‡(
‹dîed
 < 
dñÆloc
)

1573 
•a˚_öfo
->
˛amp
 = 
	`mö
(space_info->clamp + 1, 8);

1574 
	}
}

1576 
ölöe
 
boﬁ
 
	$ˇn_°ól
(
båfs_ª£rve_Êush_íum
 
Êush
)

1578  (
Êush
 =
BTRFS_RESERVE_FLUSH_ALL_STEAL
 ||

1579 
Êush
 =
BTRFS_RESERVE_FLUSH_EVICT
);

1580 
	}
}

1586 
ölöe
 
boﬁ
 
	$ˇn_tickë
(
båfs_ª£rve_Êush_íum
 
Êush
)

1588  (
Êush
 !
BTRFS_RESERVE_NO_FLUSH
 &&

1589 
Êush
 !
BTRFS_RESERVE_FLUSH_EMERGENCY
);

1590 
	}
}

1607 
	$__ª£rve_byãs
(
båfs_fs_öfo
 *
fs_öfo
,

1608 
båfs_•a˚_öfo
 *
•a˚_öfo
, 
u64
 
‹ig_byãs
,

1609 
båfs_ª£rve_Êush_íum
 
Êush
)

1611 
w‹k_°ru˘
 *
async_w‹k
;

1612 
ª£rve_tickë
 
tickë
;

1613 
u64
 
°¨t_ns
 = 0;

1614 
u64
 
u£d
;

1615 
ªt
 = -
ENOSPC
;

1616 
boﬁ
 
≥ndög_tickës
;

1618 
	`ASSERT
(
‹ig_byãs
);

1625 i‡(
cuºít
->
jou∫Æ_öfo
) {

1627 
	`ASSERT
(
Êush
 !
BTRFS_RESERVE_FLUSH_ALL
);

1628 
	`ASSERT
(
Êush
 !
BTRFS_RESERVE_FLUSH_ALL_STEAL
);

1629 
	`ASSERT
(
Êush
 !
BTRFS_RESERVE_FLUSH_EVICT
);

1632 i‡(
Êush
 =
BTRFS_RESERVE_FLUSH_DATA
)

1633 
async_w‹k
 = &
fs_öfo
->
async_d©a_ª˛aim_w‹k
;

1635 
async_w‹k
 = &
fs_öfo
->
async_ª˛aim_w‹k
;

1637 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1638 
u£d
 = 
	`båfs_•a˚_öfo_u£d
(
•a˚_öfo
, 
åue
);

1645 i‡(
	`is_n‹mÆ_Êushög
(
Êush
Ë|| (Êush =
BTRFS_RESERVE_NO_FLUSH
))

1646 
≥ndög_tickës
 = !
	`li°_em±y
(&
•a˚_öfo
->
tickës
) ||

1647 !
	`li°_em±y
(&
•a˚_öfo
->
¥i‹ôy_tickës
);

1649 
≥ndög_tickës
 = !
	`li°_em±y
(&
•a˚_öfo
->
¥i‹ôy_tickës
);

1655 i‡(!
≥ndög_tickës
 &&

1656 ((
u£d
 + 
‹ig_byãs
 <
•a˚_öfo
->
tŸÆ_byãs
) ||

1657 
	`båfs_ˇn_ovîcommô
(
fs_öfo
, 
•a˚_öfo
, 
‹ig_byãs
, 
Êush
))) {

1658 
	`båfs_•a˚_öfo_upd©e_byãs_may_u£
(
fs_öfo
, 
•a˚_öfo
,

1659 
‹ig_byãs
);

1660 
ªt
 = 0;

1668 i‡(
ªt
 && 
	`u∆ikñy
(
Êush
 =
BTRFS_RESERVE_FLUSH_EMERGENCY
)) {

1669 
u£d
 = 
	`båfs_•a˚_öfo_u£d
(
•a˚_öfo
, 
Ál£
);

1670 i‡(
u£d
 + 
‹ig_byãs
 <
•a˚_öfo
->
tŸÆ_byãs
) {

1671 
	`båfs_•a˚_öfo_upd©e_byãs_may_u£
(
fs_öfo
, 
•a˚_öfo
,

1672 
‹ig_byãs
);

1673 
ªt
 = 0;

1684 i‡(
ªt
 && 
	`ˇn_tickë
(
Êush
)) {

1685 
tickë
.
byãs
 = 
‹ig_byãs
;

1686 
tickë
.
îr‹
 = 0;

1687 
•a˚_öfo
->
ª˛aim_size
 +
tickë
.
byãs
;

1688 
	`öô_waôqueue_hód
(&
tickë
.
waô
);

1689 
tickë
.
°ól
 = 
	`ˇn_°ól
(
Êush
);

1690 i‡(
	`åa˚_båfs_ª£rve_tickë_íabÀd
())

1691 
°¨t_ns
 = 
	`ktime_gë_ns
();

1693 i‡(
Êush
 =
BTRFS_RESERVE_FLUSH_ALL
 ||

1694 
Êush
 =
BTRFS_RESERVE_FLUSH_ALL_STEAL
 ||

1695 
Êush
 =
BTRFS_RESERVE_FLUSH_DATA
) {

1696 
	`li°_add_èû
(&
tickë
.
li°
, &
•a˚_öfo
->
tickës
);

1697 i‡(!
•a˚_öfo
->
Êush
) {

1705 
	`maybe_˛amp_¥ìm±
(
fs_öfo
, 
•a˚_öfo
);

1707 
•a˚_öfo
->
Êush
 = 1;

1708 
	`åa˚_båfs_åiggî_Êush
(
fs_öfo
,

1709 
•a˚_öfo
->
Êags
,

1710 
‹ig_byãs
, 
Êush
,

1712 
	`queue_w‹k
(
sy°em_unbound_wq
, 
async_w‹k
);

1715 
	`li°_add_èû
(&
tickë
.
li°
,

1716 &
•a˚_öfo
->
¥i‹ôy_tickës
);

1718 } i‡(!
ªt
 && 
•a˚_öfo
->
Êags
 & 
BTRFS_BLOCK_GROUP_METADATA
) {

1724 i‡(!
	`ã°_bô
(
BTRFS_FS_LOG_RECOVERING
, &
fs_öfo
->
Êags
) &&

1725 !
	`w‹k_busy
(&
fs_öfo
->
¥ìm±_ª˛aim_w‹k
) &&

1726 
	`√ed_¥ìm±ive_ª˛aim
(
fs_öfo
, 
•a˚_öfo
)) {

1727 
	`åa˚_båfs_åiggî_Êush
(
fs_öfo
, 
•a˚_öfo
->
Êags
,

1728 
‹ig_byãs
, 
Êush
, "preempt");

1729 
	`queue_w‹k
(
sy°em_unbound_wq
,

1730 &
fs_öfo
->
¥ìm±_ª˛aim_w‹k
);

1733 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1734 i‡(!
ªt
 || !
	`ˇn_tickë
(
Êush
))

1735  
ªt
;

1737  
	`h™dÀ_ª£rve_tickë
(
fs_öfo
, 
•a˚_öfo
, &
tickë
, 
°¨t_ns
,

1738 
‹ig_byãs
, 
Êush
);

1739 
	}
}

1756 
	$båfs_ª£rve_mëad©a_byãs
(
båfs_fs_öfo
 *
fs_öfo
,

1757 
båfs_block_rsv
 *
block_rsv
,

1758 
u64
 
‹ig_byãs
,

1759 
båfs_ª£rve_Êush_íum
 
Êush
)

1761 
ªt
;

1763 
ªt
 = 
	`__ª£rve_byãs
(
fs_öfo
, 
block_rsv
->
•a˚_öfo
, 
‹ig_byãs
, 
Êush
);

1764 i‡(
ªt
 =-
ENOSPC
) {

1765 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, "space_info:enospc",

1766 
block_rsv
->
•a˚_öfo
->
Êags
,

1767 
‹ig_byãs
, 1);

1769 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
ENOSPC_DEBUG
))

1770 
	`båfs_dump_•a˚_öfo
(
fs_öfo
, 
block_rsv
->
•a˚_öfo
,

1771 
‹ig_byãs
, 0);

1773  
ªt
;

1774 
	}
}

1786 
	$båfs_ª£rve_d©a_byãs
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
byãs
,

1787 
båfs_ª£rve_Êush_íum
 
Êush
)

1789 
båfs_•a˚_öfo
 *
d©a_söfo
 = 
fs_öfo
->data_sinfo;

1790 
ªt
;

1792 
	`ASSERT
(
Êush
 =
BTRFS_RESERVE_FLUSH_DATA
 ||

1793 
Êush
 =
BTRFS_RESERVE_FLUSH_FREE_SPACE_INODE
 ||

1794 
Êush
 =
BTRFS_RESERVE_NO_FLUSH
);

1795 
	`ASSERT
(!
cuºít
->
jou∫Æ_öfo
 || 
Êush
 !
BTRFS_RESERVE_FLUSH_DATA
);

1797 
ªt
 = 
	`__ª£rve_byãs
(
fs_öfo
, 
d©a_söfo
, 
byãs
, 
Êush
);

1798 i‡(
ªt
 =-
ENOSPC
) {

1799 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, "space_info:enospc",

1800 
d©a_söfo
->
Êags
, 
byãs
, 1);

1801 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
ENOSPC_DEBUG
))

1802 
	`båfs_dump_•a˚_öfo
(
fs_öfo
, 
d©a_söfo
, 
byãs
, 0);

1804  
ªt
;

1805 
	}
}

1808 
__cﬁd
 
	$båfs_dump_•a˚_öfo_f‹_å™s_ab‹t
(
båfs_fs_öfo
 *
fs_öfo
)

1810 
båfs_•a˚_öfo
 *
•a˚_öfo
;

1812 
	`båfs_öfo
(
fs_öfo
, "dumping space info:");

1813 
	`li°_f‹_óch_íåy
(
•a˚_öfo
, &
fs_öfo
->•a˚_öfo, 
li°
) {

1814 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1815 
	`__båfs_dump_•a˚_öfo
(
fs_öfo
, 
•a˚_öfo
);

1816 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1818 
	`dump_globÆ_block_rsv
(
fs_öfo
);

1819 
	}
}

1825 
u64
 
	$båfs_accou¡_ro_block_groups_‰ì_•a˚
(
båfs_•a˚_öfo
 *
söfo
)

1827 
båfs_block_group
 *
block_group
;

1828 
u64
 
‰ì_byãs
 = 0;

1829 
Á˘‹
;

1832 i‡(
	`li°_em±y
(&
söfo
->
ro_bgs
))

1835 
	`•ö_lock
(&
söfo
->
lock
);

1836 
	`li°_f‹_óch_íåy
(
block_group
, &
söfo
->
ro_bgs
, 
ro_li°
) {

1837 
	`•ö_lock
(&
block_group
->
lock
);

1839 i‡(!
block_group
->
ro
) {

1840 
	`•ö_u∆ock
(&
block_group
->
lock
);

1844 
Á˘‹
 = 
	`båfs_bg_ty≥_to_Á˘‹
(
block_group
->
Êags
);

1845 
‰ì_byãs
 +(
block_group
->
Àngth
 -

1846 
block_group
->
u£d
Ë* 
Á˘‹
;

1848 
	`•ö_u∆ock
(&
block_group
->
lock
);

1850 
	`•ö_u∆ock
(&
söfo
->
lock
);

1852  
‰ì_byãs
;

1853 
	}
}

	@space-info.h

3 #i‚de‡
BTRFS_SPACE_INFO_H


4 
	#BTRFS_SPACE_INFO_H


	)

6 
	~"vﬁumes.h
"

13 
	ebåfs_ª£rve_Êush_íum
 {

15 
	mBTRFS_RESERVE_NO_FLUSH
,

22 
	mBTRFS_RESERVE_FLUSH_LIMIT
,

32 
	mBTRFS_RESERVE_FLUSH_EVICT
,

41 
	mBTRFS_RESERVE_FLUSH_DATA
,

42 
	mBTRFS_RESERVE_FLUSH_FREE_SPACE_INODE
,

43 
	mBTRFS_RESERVE_FLUSH_ALL
,

51 
	mBTRFS_RESERVE_FLUSH_ALL_STEAL
,

69 
	mBTRFS_RESERVE_FLUSH_EMERGENCY
,

72 
	ebåfs_Êush_°©e
 {

73 
	mFLUSH_DELAYED_ITEMS_NR
 = 1,

74 
	mFLUSH_DELAYED_ITEMS
 = 2,

75 
	mFLUSH_DELAYED_REFS_NR
 = 3,

76 
	mFLUSH_DELAYED_REFS
 = 4,

77 
	mFLUSH_DELALLOC
 = 5,

78 
	mFLUSH_DELALLOC_WAIT
 = 6,

79 
	mFLUSH_DELALLOC_FULL
 = 7,

80 
	mALLOC_CHUNK
 = 8,

81 
	mALLOC_CHUNK_FORCE
 = 9,

82 
	mRUN_DELAYED_IPUTS
 = 10,

83 
	mCOMMIT_TRANS
 = 11,

86 
	sbåfs_•a˚_öfo
 {

87 
•ölock_t
 
	mlock
;

89 
u64
 
	mtŸÆ_byãs
;

91 
u64
 
	mbyãs_u£d
;

93 
u64
 
	mbyãs_pö√d
;

95 
u64
 
	mbyãs_ª£rved
;

97 
u64
 
	mbyãs_may_u£
;

99 
u64
 
	mbyãs_ªad⁄ly
;

100 
u64
 
	mbyãs_z⁄e_unußbÀ
;

103 
u64
 
	mmax_exã¡_size
;

107 
u64
 
	mchunk_size
;

113 
	mbg_ª˛aim_thªshﬁd
;

115 
	m˛amp
;

119 
	mfuŒ
:1;

121 
	mchunk_Æloc
:1;

123 
	mÊush
:1;

125 
	mf‹˚_Æloc
;

128 
u64
 
	mdisk_u£d
;

129 
u64
 
	mdisk_tŸÆ
;

132 
u64
 
	mÊags
;

134 
li°_hód
 
	mli°
;

136 
li°_hód
 
	mro_bgs
;

137 
li°_hód
 
	m¥i‹ôy_tickës
;

138 
li°_hód
 
	mtickës
;

144 
u64
 
	mª˛aim_size
;

150 
u64
 
	mtickës_id
;

152 
rw_£m≠h‹e
 
	mgroups_£m
;

154 
li°_hód
 
	mblock_groups
[
BTRFS_NR_RAID_TYPES
];

156 
kobje˘
 
	mkobj
;

157 
kobje˘
 *
	mblock_group_kobjs
[
BTRFS_NR_RAID_TYPES
];

160 
	sª£rve_tickë
 {

161 
u64
 
	mbyãs
;

162 
	mîr‹
;

163 
boﬁ
 
	m°ól
;

164 
li°_hód
 
	mli°
;

165 
waô_queue_hód_t
 
	mwaô
;

168 
ölöe
 
boﬁ
 
	$båfs_mixed_•a˚_öfo
(
båfs_•a˚_öfo
 *
•a˚_öfo
)

170  ((
•a˚_öfo
->
Êags
 & 
BTRFS_BLOCK_GROUP_METADATA
) &&

171 (
•a˚_öfo
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
));

172 
	}
}

178 
	#DECLARE_SPACE_INFO_UPDATE
(
«me
, 
åa˚_«me
) \

179 
ölöe
 \

180 
båfs_•a˚_öfo_upd©e_
##
	`«me
(
båfs_fs_öfo
 *
fs_öfo
, \

181 
båfs_•a˚_öfo
 *
söfo
, \

182 
s64
 
byãs
) \

184 c⁄° 
u64
 
abs_byãs
 = (
byãs
 < 0) ? -bytes : bytes; \

185 
	`lockdï_as£π_hñd
(&
söfo
->
lock
); \

186 
åa˚_upd©e_
##
	`«me
(
fs_öfo
, 
söfo
, söfo->
«me
, 
byãs
); \

187 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, 
åa˚_«me
, \

188 
söfo
->
Êags
, 
abs_byãs
, \

189 
byãs
 > 0); \

190 i‡(
byãs
 < 0 && 
söfo
->
«me
 < -bytes) { \

191 
	`WARN_ON
(1); \

192 
söfo
->
«me
 = 0; \

195 
söfo
->
«me
 +
byãs
; \

196 }

	)

198 
DECLARE_SPACE_INFO_UPDATE
(
byãs_may_u£
, "space_info");

199 
DECLARE_SPACE_INFO_UPDATE
(
byãs_pö√d
, "pinned");

201 
båfs_öô_•a˚_öfo
(
båfs_fs_öfo
 *
fs_öfo
);

202 
båfs_add_bg_to_•a˚_öfo
(
båfs_fs_öfo
 *
öfo
,

203 
båfs_block_group
 *
block_group
);

204 
båfs_upd©e_•a˚_öfo_chunk_size
(
båfs_•a˚_öfo
 *
•a˚_öfo
,

205 
u64
 
chunk_size
);

206 
båfs_•a˚_öfo
 *
båfs_föd_•a˚_öfo
(
båfs_fs_öfo
 *
öfo
,

207 
u64
 
Êags
);

208 
u64
 
__puª
 
båfs_•a˚_öfo_u£d
(
båfs_•a˚_öfo
 *
s_öfo
,

209 
boﬁ
 
may_u£_ö˛uded
);

210 
båfs_˛ór_•a˚_öfo_fuŒ
(
båfs_fs_öfo
 *
öfo
);

211 
båfs_dump_•a˚_öfo
(
båfs_fs_öfo
 *
fs_öfo
,

212 
båfs_•a˚_öfo
 *
öfo
, 
u64
 
byãs
,

213 
dump_block_groups
);

214 
båfs_ª£rve_mëad©a_byãs
(
båfs_fs_öfo
 *
fs_öfo
,

215 
båfs_block_rsv
 *
block_rsv
,

216 
u64
 
‹ig_byãs
,

217 
båfs_ª£rve_Êush_íum
 
Êush
);

218 
båfs_åy_gø¡ög_tickës
(
båfs_fs_öfo
 *
fs_öfo
,

219 
båfs_•a˚_öfo
 *
•a˚_öfo
);

220 
båfs_ˇn_ovîcommô
(
båfs_fs_öfo
 *
fs_öfo
,

221 
båfs_•a˚_öfo
 *
•a˚_öfo
, 
u64
 
byãs
,

222 
båfs_ª£rve_Êush_íum
 
Êush
);

224 
ölöe
 
	$båfs_•a˚_öfo_‰ì_byãs_may_u£
(

225 
båfs_fs_öfo
 *
fs_öfo
,

226 
båfs_•a˚_öfo
 *
•a˚_öfo
,

227 
u64
 
num_byãs
)

229 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

230 
	`båfs_•a˚_öfo_upd©e_byãs_may_u£
(
fs_öfo
, 
•a˚_öfo
, -
num_byãs
);

231 
	`båfs_åy_gø¡ög_tickës
(
fs_öfo
, 
•a˚_öfo
);

232 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

233 
	}
}

234 
båfs_ª£rve_d©a_byãs
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
byãs
,

235 
båfs_ª£rve_Êush_íum
 
Êush
);

236 
båfs_dump_•a˚_öfo_f‹_å™s_ab‹t
(
båfs_fs_öfo
 *
fs_öfo
);

237 
båfs_öô_async_ª˛aim_w‹k
(
båfs_fs_öfo
 *
fs_öfo
);

238 
u64
 
båfs_accou¡_ro_block_groups_‰ì_•a˚
(
båfs_•a˚_öfo
 *
söfo
);

	@subpage.c

3 
	~<löux/¶ab.h
>

4 
	~"mesßges.h
"

5 
	~"˘ªe.h
"

6 
	~"sub∑ge.h
"

7 
	~"båfs_öode.h
"

67 
boﬁ
 
	$båfs_is_sub∑ge
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, 
∑ge
 *page)

69 i‡(
fs_öfo
->
£˘‹size
 >
PAGE_SIZE
)

70  
Ál£
;

77 i‡(!
∑ge
->
m≠pög
 || !∑ge->m≠pög->
ho°
 ||

78 
	`is_d©a_öode
(
∑ge
->
m≠pög
->
ho°
))

79  
åue
;

85 i‡(
fs_öfo
->
nodesize
 < 
PAGE_SIZE
)

86  
åue
;

87  
Ál£
;

88 
	}
}

90 
	$båfs_öô_sub∑ge_öfo
(
båfs_sub∑ge_öfo
 *
sub∑ge_öfo
, 
u32
 
£˘‹size
)

92 
cur
 = 0;

93 
ƒ_bôs
;

95 
	`ASSERT
(
	`IS_ALIGNED
(
PAGE_SIZE
, 
£˘‹size
));

97 
ƒ_bôs
 = 
PAGE_SIZE
 / 
£˘‹size
;

98 
sub∑ge_öfo
->
bôm≠_ƒ_bôs
 = 
ƒ_bôs
;

100 
sub∑ge_öfo
->
u±od©e_off£t
 = 
cur
;

101 
cur
 +
ƒ_bôs
;

103 
sub∑ge_öfo
->
dúty_off£t
 = 
cur
;

104 
cur
 +
ƒ_bôs
;

106 
sub∑ge_öfo
->
wrôeback_off£t
 = 
cur
;

107 
cur
 +
ƒ_bôs
;

109 
sub∑ge_öfo
->
‹dîed_off£t
 = 
cur
;

110 
cur
 +
ƒ_bôs
;

112 
sub∑ge_öfo
->
checked_off£t
 = 
cur
;

113 
cur
 +
ƒ_bôs
;

115 
sub∑ge_öfo
->
tŸÆ_ƒ_bôs
 = 
cur
;

116 
	}
}

118 
	$båfs_©èch_sub∑ge
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

119 
∑ge
 *∑ge, 
båfs_sub∑ge_ty≥
 
ty≥
)

121 
båfs_sub∑ge
 *
sub∑ge
;

127 i‡(
∑ge
->
m≠pög
)

128 
	`ASSERT
(
	`PageLocked
(
∑ge
));

131 i‡(!
	`båfs_is_sub∑ge
(
fs_öfo
, 
∑ge
Ë|| 
	`PagePriv©e
(page))

134 
sub∑ge
 = 
	`båfs_Æloc_sub∑ge
(
fs_öfo
, 
ty≥
);

135 i‡(
	`IS_ERR
(
sub∑ge
))

136  
	`PTR_ERR
(
sub∑ge
);

138 
	`©èch_∑ge_¥iv©e
(
∑ge
, 
sub∑ge
);

140 
	}
}

142 
	$båfs_dëach_sub∑ge
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

143 
∑ge
 *page)

145 
båfs_sub∑ge
 *
sub∑ge
;

148 i‡(!
	`båfs_is_sub∑ge
(
fs_öfo
, 
∑ge
Ë|| !
	`PagePriv©e
(page))

151 
sub∑ge
 = 
	`dëach_∑ge_¥iv©e
(
∑ge
);

152 
	`ASSERT
(
sub∑ge
);

153 
	`båfs_‰ì_sub∑ge
(
sub∑ge
);

154 
	}
}

156 
båfs_sub∑ge
 *
	$båfs_Æloc_sub∑ge
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

157 
båfs_sub∑ge_ty≥
 
ty≥
)

159 
båfs_sub∑ge
 *
ªt
;

160 
ªÆ_size
;

162 
	`ASSERT
(
fs_öfo
->
£˘‹size
 < 
PAGE_SIZE
);

164 
ªÆ_size
 = 
	`°ru˘_size
(
ªt
, 
bôm≠s
,

165 
	`BITS_TO_LONGS
(
fs_öfo
->
sub∑ge_öfo
->
tŸÆ_ƒ_bôs
));

166 
ªt
 = 
	`kzÆloc
(
ªÆ_size
, 
GFP_NOFS
);

167 i‡(!
ªt
)

168  
	`ERR_PTR
(-
ENOMEM
);

170 
	`•ö_lock_öô
(&
ªt
->
lock
);

171 i‡(
ty≥
 =
BTRFS_SUBPAGE_METADATA
) {

172 
	`©omic_£t
(&
ªt
->
eb_ªfs
, 0);

174 
	`©omic_£t
(&
ªt
->
ªadîs
, 0);

175 
	`©omic_£t
(&
ªt
->
wrôîs
, 0);

177  
ªt
;

178 
	}
}

180 
	$båfs_‰ì_sub∑ge
(
båfs_sub∑ge
 *
sub∑ge
)

182 
	`k‰ì
(
sub∑ge
);

183 
	}
}

194 
	$båfs_∑ge_öc_eb_ªfs
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

195 
∑ge
 *page)

197 
båfs_sub∑ge
 *
sub∑ge
;

199 i‡(!
	`båfs_is_sub∑ge
(
fs_öfo
, 
∑ge
))

202 
	`ASSERT
(
	`PagePriv©e
(
∑ge
Ë&&Öage->
m≠pög
);

203 
	`lockdï_as£π_hñd
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

205 
sub∑ge
 = (
båfs_sub∑ge
 *)
∑ge
->
¥iv©e
;

206 
	`©omic_öc
(&
sub∑ge
->
eb_ªfs
);

207 
	}
}

209 
	$båfs_∑ge_dec_eb_ªfs
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

210 
∑ge
 *page)

212 
båfs_sub∑ge
 *
sub∑ge
;

214 i‡(!
	`båfs_is_sub∑ge
(
fs_öfo
, 
∑ge
))

217 
	`ASSERT
(
	`PagePriv©e
(
∑ge
Ë&&Öage->
m≠pög
);

218 
	`lockdï_as£π_hñd
(&
∑ge
->
m≠pög
->
¥iv©e_lock
);

220 
sub∑ge
 = (
båfs_sub∑ge
 *)
∑ge
->
¥iv©e
;

221 
	`ASSERT
(
	`©omic_ªad
(&
sub∑ge
->
eb_ªfs
));

222 
	`©omic_dec
(&
sub∑ge
->
eb_ªfs
);

223 
	}
}

225 
	$båfs_sub∑ge_as£π
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

226 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

229 
	`ASSERT
(
	`PagePriv©e
(
∑ge
Ë&&Öage->
¥iv©e
);

230 
	`ASSERT
(
	`IS_ALIGNED
(
°¨t
, 
fs_öfo
->
£˘‹size
) &&

231 
	`IS_ALIGNED
(
Àn
, 
fs_öfo
->
£˘‹size
));

236 i‡(
∑ge
->
m≠pög
)

237 
	`ASSERT
(
	`∑ge_off£t
(
∑ge
Ë<
°¨t
 &&

238 
°¨t
 + 
Àn
 <
	`∑ge_off£t
(
∑ge
Ë+ 
PAGE_SIZE
);

239 
	}
}

241 
	$båfs_sub∑ge_°¨t_ªadî
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

242 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

244 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

245 c⁄° 
nbôs
 = 
Àn
 >> 
fs_öfo
->
£˘‹size_bôs
;

247 
	`båfs_sub∑ge_as£π
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

249 
	`©omic_add
(
nbôs
, &
sub∑ge
->
ªadîs
);

250 
	}
}

252 
	$båfs_sub∑ge_íd_ªadî
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

253 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

255 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

256 c⁄° 
nbôs
 = 
Àn
 >> 
fs_öfo
->
£˘‹size_bôs
;

257 
boﬁ
 
is_d©a
;

258 
boﬁ
 
œ°
;

260 
	`båfs_sub∑ge_as£π
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

261 
is_d©a
 = 
	`is_d©a_öode
(
∑ge
->
m≠pög
->
ho°
);

262 
	`ASSERT
(
	`©omic_ªad
(&
sub∑ge
->
ªadîs
Ë>
nbôs
);

263 
œ°
 = 
	`©omic_sub_™d_ã°
(
nbôs
, &
sub∑ge
->
ªadîs
);

272 i‡(
is_d©a
 && 
œ°
)

273 
	`u∆ock_∑ge
(
∑ge
);

274 
	}
}

276 
	$båfs_sub∑ge_˛amp_ønge
(
∑ge
 *∑ge, 
u64
 *
°¨t
, 
u32
 *
Àn
)

278 
u64
 
‹ig_°¨t
 = *
°¨t
;

279 
u32
 
‹ig_Àn
 = *
Àn
;

281 *
°¨t
 = 
	`max_t
(
u64
, 
	`∑ge_off£t
(
∑ge
), 
‹ig_°¨t
);

287 i‡(
	`∑ge_off£t
(
∑ge
Ë>
‹ig_°¨t
 + 
‹ig_Àn
)

288 *
Àn
 = 0;

290 *
Àn
 = 
	`mö_t
(
u64
, 
	`∑ge_off£t
(
∑ge
Ë+ 
PAGE_SIZE
,

291 
‹ig_°¨t
 + 
‹ig_Àn
Ë- *
°¨t
;

292 
	}
}

294 
	$båfs_sub∑ge_°¨t_wrôî
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

295 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

297 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

298 c⁄° 
nbôs
 = (
Àn
 >> 
fs_öfo
->
£˘‹size_bôs
);

299 
ªt
;

301 
	`båfs_sub∑ge_as£π
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

303 
	`ASSERT
(
	`©omic_ªad
(&
sub∑ge
->
ªadîs
) == 0);

304 
ªt
 = 
	`©omic_add_ªtu∫
(
nbôs
, &
sub∑ge
->
wrôîs
);

305 
	`ASSERT
(
ªt
 =
nbôs
);

306 
	}
}

308 
boﬁ
 
	$båfs_sub∑ge_íd_™d_ã°_wrôî
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

309 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

311 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

312 c⁄° 
nbôs
 = (
Àn
 >> 
fs_öfo
->
£˘‹size_bôs
);

314 
	`båfs_sub∑ge_as£π
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

323 i‡(
	`©omic_ªad
(&
sub∑ge
->
wrôîs
) == 0)

324  
åue
;

326 
	`ASSERT
(
	`©omic_ªad
(&
sub∑ge
->
wrôîs
Ë>
nbôs
);

327  
	`©omic_sub_™d_ã°
(
nbôs
, &
sub∑ge
->
wrôîs
);

328 
	}
}

340 
	$båfs_∑ge_°¨t_wrôî_lock
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

341 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

343 i‡(
	`u∆ikñy
(!
fs_öfo
Ë|| !
	`båfs_is_sub∑ge
(fs_öfo, 
∑ge
)) {

344 
	`lock_∑ge
(
∑ge
);

347 
	`lock_∑ge
(
∑ge
);

348 i‡(!
	`PagePriv©e
(
∑ge
Ë|| !∑ge->
¥iv©e
) {

349 
	`u∆ock_∑ge
(
∑ge
);

350  -
EAGAIN
;

352 
	`båfs_sub∑ge_˛amp_ønge
(
∑ge
, &
°¨t
, &
Àn
);

353 
	`båfs_sub∑ge_°¨t_wrôî
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

355 
	}
}

357 
	$båfs_∑ge_íd_wrôî_lock
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

358 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

360 i‡(
	`u∆ikñy
(!
fs_öfo
Ë|| !
	`båfs_is_sub∑ge
(fs_öfo, 
∑ge
))

361  
	`u∆ock_∑ge
(
∑ge
);

362 
	`båfs_sub∑ge_˛amp_ønge
(
∑ge
, &
°¨t
, &
Àn
);

363 i‡(
	`båfs_sub∑ge_íd_™d_ã°_wrôî
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
))

364 
	`u∆ock_∑ge
(
∑ge
);

365 
	}
}

367 
	#sub∑ge_ˇlc_°¨t_bô
(
fs_öfo
, 
∑ge
, 
«me
, 
°¨t
, 
Àn
) \

369 
°¨t_bô
; \

371 
	`båfs_sub∑ge_as£π
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
); \

372 
°¨t_bô
 = 
	`off£t_ö_∑ge
(
°¨t
Ë>> 
fs_öfo
->
£˘‹size_bôs
; \

373 
°¨t_bô
 +
fs_öfo
->
sub∑ge_öfo
->
«me
##
_off£t
; \

374 
°¨t_bô
; \

375 })

	)

377 
	#sub∑ge_ã°_bôm≠_Æl_£t
(
fs_öfo
, 
sub∑ge
, 
«me
) \

378 
	`bôm≠_ã°_ønge_Æl_£t
(
sub∑ge
->
bôm≠s
, \

379 
fs_öfo
->
sub∑ge_öfo
->
«me
##
_off£t
, \

380 
fs_öfo
->
sub∑ge_öfo
->
bôm≠_ƒ_bôs
)

	)

382 
	#sub∑ge_ã°_bôm≠_Æl_zîo
(
fs_öfo
, 
sub∑ge
, 
«me
) \

383 
	`bôm≠_ã°_ønge_Æl_zîo
(
sub∑ge
->
bôm≠s
, \

384 
fs_öfo
->
sub∑ge_öfo
->
«me
##
_off£t
, \

385 
fs_öfo
->
sub∑ge_öfo
->
bôm≠_ƒ_bôs
)

	)

387 
	$båfs_sub∑ge_£t_u±od©e
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

388 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

390 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

391 
°¨t_bô
 = 
	`sub∑ge_ˇlc_°¨t_bô
(
fs_öfo
, 
∑ge
,

392 
u±od©e
, 
°¨t
, 
Àn
);

393 
Êags
;

395 
	`•ö_lock_úqßve
(&
sub∑ge
->
lock
, 
Êags
);

396 
	`bôm≠_£t
(
sub∑ge
->
bôm≠s
, 
°¨t_bô
, 
Àn
 >> 
fs_öfo
->
£˘‹size_bôs
);

397 i‡(
	`sub∑ge_ã°_bôm≠_Æl_£t
(
fs_öfo
, 
sub∑ge
, 
u±od©e
))

398 
	`SëPageU±od©e
(
∑ge
);

399 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
);

400 
	}
}

402 
	$båfs_sub∑ge_˛ór_u±od©e
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

403 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

405 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

406 
°¨t_bô
 = 
	`sub∑ge_ˇlc_°¨t_bô
(
fs_öfo
, 
∑ge
,

407 
u±od©e
, 
°¨t
, 
Àn
);

408 
Êags
;

410 
	`•ö_lock_úqßve
(&
sub∑ge
->
lock
, 
Êags
);

411 
	`bôm≠_˛ór
(
sub∑ge
->
bôm≠s
, 
°¨t_bô
, 
Àn
 >> 
fs_öfo
->
£˘‹size_bôs
);

412 
	`CÀ¨PageU±od©e
(
∑ge
);

413 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
);

414 
	}
}

416 
	$båfs_sub∑ge_£t_dúty
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

417 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

419 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

420 
°¨t_bô
 = 
	`sub∑ge_ˇlc_°¨t_bô
(
fs_öfo
, 
∑ge
,

421 
dúty
, 
°¨t
, 
Àn
);

422 
Êags
;

424 
	`•ö_lock_úqßve
(&
sub∑ge
->
lock
, 
Êags
);

425 
	`bôm≠_£t
(
sub∑ge
->
bôm≠s
, 
°¨t_bô
, 
Àn
 >> 
fs_öfo
->
£˘‹size_bôs
);

426 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
);

427 
	`£t_∑ge_dúty
(
∑ge
);

428 
	}
}

440 
boﬁ
 
	$båfs_sub∑ge_˛ór_™d_ã°_dúty
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

441 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

443 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

444 
°¨t_bô
 = 
	`sub∑ge_ˇlc_°¨t_bô
(
fs_öfo
, 
∑ge
,

445 
dúty
, 
°¨t
, 
Àn
);

446 
Êags
;

447 
boﬁ
 
œ°
 = 
Ál£
;

449 
	`•ö_lock_úqßve
(&
sub∑ge
->
lock
, 
Êags
);

450 
	`bôm≠_˛ór
(
sub∑ge
->
bôm≠s
, 
°¨t_bô
, 
Àn
 >> 
fs_öfo
->
£˘‹size_bôs
);

451 i‡(
	`sub∑ge_ã°_bôm≠_Æl_zîo
(
fs_öfo
, 
sub∑ge
, 
dúty
))

452 
œ°
 = 
åue
;

453 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
);

454  
œ°
;

455 
	}
}

457 
	$båfs_sub∑ge_˛ór_dúty
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

458 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

460 
boﬁ
 
œ°
;

462 
œ°
 = 
	`båfs_sub∑ge_˛ór_™d_ã°_dúty
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

463 i‡(
œ°
)

464 
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
);

465 
	}
}

467 
	$båfs_sub∑ge_£t_wrôeback
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

468 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

470 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

471 
°¨t_bô
 = 
	`sub∑ge_ˇlc_°¨t_bô
(
fs_öfo
, 
∑ge
,

472 
wrôeback
, 
°¨t
, 
Àn
);

473 
Êags
;

475 
	`•ö_lock_úqßve
(&
sub∑ge
->
lock
, 
Êags
);

476 
	`bôm≠_£t
(
sub∑ge
->
bôm≠s
, 
°¨t_bô
, 
Àn
 >> 
fs_öfo
->
£˘‹size_bôs
);

477 
	`£t_∑ge_wrôeback
(
∑ge
);

478 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
);

479 
	}
}

481 
	$båfs_sub∑ge_˛ór_wrôeback
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

482 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

484 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

485 
°¨t_bô
 = 
	`sub∑ge_ˇlc_°¨t_bô
(
fs_öfo
, 
∑ge
,

486 
wrôeback
, 
°¨t
, 
Àn
);

487 
Êags
;

489 
	`•ö_lock_úqßve
(&
sub∑ge
->
lock
, 
Êags
);

490 
	`bôm≠_˛ór
(
sub∑ge
->
bôm≠s
, 
°¨t_bô
, 
Àn
 >> 
fs_öfo
->
£˘‹size_bôs
);

491 i‡(
	`sub∑ge_ã°_bôm≠_Æl_zîo
(
fs_öfo
, 
sub∑ge
, 
wrôeback
)) {

492 
	`ASSERT
(
	`PageWrôeback
(
∑ge
));

493 
	`íd_∑ge_wrôeback
(
∑ge
);

495 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
);

496 
	}
}

498 
	$båfs_sub∑ge_£t_‹dîed
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

499 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

501 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

502 
°¨t_bô
 = 
	`sub∑ge_ˇlc_°¨t_bô
(
fs_öfo
, 
∑ge
,

503 
‹dîed
, 
°¨t
, 
Àn
);

504 
Êags
;

506 
	`•ö_lock_úqßve
(&
sub∑ge
->
lock
, 
Êags
);

507 
	`bôm≠_£t
(
sub∑ge
->
bôm≠s
, 
°¨t_bô
, 
Àn
 >> 
fs_öfo
->
£˘‹size_bôs
);

508 
	`SëPageOrdîed
(
∑ge
);

509 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
);

510 
	}
}

512 
	$båfs_sub∑ge_˛ór_‹dîed
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

513 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

515 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

516 
°¨t_bô
 = 
	`sub∑ge_ˇlc_°¨t_bô
(
fs_öfo
, 
∑ge
,

517 
‹dîed
, 
°¨t
, 
Àn
);

518 
Êags
;

520 
	`•ö_lock_úqßve
(&
sub∑ge
->
lock
, 
Êags
);

521 
	`bôm≠_˛ór
(
sub∑ge
->
bôm≠s
, 
°¨t_bô
, 
Àn
 >> 
fs_öfo
->
£˘‹size_bôs
);

522 i‡(
	`sub∑ge_ã°_bôm≠_Æl_zîo
(
fs_öfo
, 
sub∑ge
, 
‹dîed
))

523 
	`CÀ¨PageOrdîed
(
∑ge
);

524 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
);

525 
	}
}

527 
	$båfs_sub∑ge_£t_checked
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

528 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

530 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

531 
°¨t_bô
 = 
	`sub∑ge_ˇlc_°¨t_bô
(
fs_öfo
, 
∑ge
,

532 
checked
, 
°¨t
, 
Àn
);

533 
Êags
;

535 
	`•ö_lock_úqßve
(&
sub∑ge
->
lock
, 
Êags
);

536 
	`bôm≠_£t
(
sub∑ge
->
bôm≠s
, 
°¨t_bô
, 
Àn
 >> 
fs_öfo
->
£˘‹size_bôs
);

537 i‡(
	`sub∑ge_ã°_bôm≠_Æl_£t
(
fs_öfo
, 
sub∑ge
, 
checked
))

538 
	`SëPageChecked
(
∑ge
);

539 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
);

540 
	}
}

542 
	$båfs_sub∑ge_˛ór_checked
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

543 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

545 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

546 
°¨t_bô
 = 
	`sub∑ge_ˇlc_°¨t_bô
(
fs_öfo
, 
∑ge
,

547 
checked
, 
°¨t
, 
Àn
);

548 
Êags
;

550 
	`•ö_lock_úqßve
(&
sub∑ge
->
lock
, 
Êags
);

551 
	`bôm≠_˛ór
(
sub∑ge
->
bôm≠s
, 
°¨t_bô
, 
Àn
 >> 
fs_öfo
->
£˘‹size_bôs
);

552 
	`CÀ¨PageChecked
(
∑ge
);

553 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
);

554 
	}
}

560 
	#IMPLEMENT_BTRFS_SUBPAGE_TEST_OP
(
«me
) \

561 
boﬁ
 
båfs_sub∑ge_ã°_
##
	`«me
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, \

562 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
) \

564 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
; \

565 
°¨t_bô
 = 
	`sub∑ge_ˇlc_°¨t_bô
(
fs_öfo
, 
∑ge
, \

566 
«me
, 
°¨t
, 
Àn
); \

567 
Êags
; \

568 
boﬁ
 
ªt
; \

570 
	`•ö_lock_úqßve
(&
sub∑ge
->
lock
, 
Êags
); \

571 
ªt
 = 
	`bôm≠_ã°_ønge_Æl_£t
(
sub∑ge
->
bôm≠s
, 
°¨t_bô
, \

572 
Àn
 >> 
fs_öfo
->
£˘‹size_bôs
); \

573 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
); \

574  
ªt
; \

575 }

	)

576 
IMPLEMENT_BTRFS_SUBPAGE_TEST_OP
(
u±od©e
);

577 
IMPLEMENT_BTRFS_SUBPAGE_TEST_OP
(
dúty
);

578 
IMPLEMENT_BTRFS_SUBPAGE_TEST_OP
(
wrôeback
);

579 
IMPLEMENT_BTRFS_SUBPAGE_TEST_OP
(
‹dîed
);

580 
IMPLEMENT_BTRFS_SUBPAGE_TEST_OP
(
checked
);

587 
	#IMPLEMENT_BTRFS_PAGE_OPS
(
«me
, 
£t_∑ge_func
, 
˛ór_∑ge_func
, \

588 
ã°_∑ge_func
) \

589 
båfs_∑ge_£t_
##
	`«me
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, \

590 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
) \

592 i‡(
	`u∆ikñy
(!
fs_öfo
Ë|| !
	`båfs_is_sub∑ge
(fs_öfo, 
∑ge
)) { \

593 
	`£t_∑ge_func
(
∑ge
); \

596 
båfs_sub∑ge_£t_
##
	`«me
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
); \

598 
båfs_∑ge_˛ór_
##
	`«me
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, \

599 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
) \

601 i‡(
	`u∆ikñy
(!
fs_öfo
Ë|| !
	`båfs_is_sub∑ge
(fs_öfo, 
∑ge
)) { \

602 
	`˛ór_∑ge_func
(
∑ge
); \

605 
båfs_sub∑ge_˛ór_
##
	`«me
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
); \

607 
boﬁ
 
båfs_∑ge_ã°_
##
	`«me
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, \

608 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
) \

610 i‡(
	`u∆ikñy
(!
fs_öfo
Ë|| !
	`båfs_is_sub∑ge
(fs_öfo, 
∑ge
)) \

611  
	`ã°_∑ge_func
(
∑ge
); \

612  
båfs_sub∑ge_ã°_
##
	`«me
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
); \

614 
båfs_∑ge_˛amp_£t_
##
	`«me
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, \

615 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
) \

617 i‡(
	`u∆ikñy
(!
fs_öfo
Ë|| !
	`båfs_is_sub∑ge
(fs_öfo, 
∑ge
)) { \

618 
	`£t_∑ge_func
(
∑ge
); \

621 
	`båfs_sub∑ge_˛amp_ønge
(
∑ge
, &
°¨t
, &
Àn
); \

622 
båfs_sub∑ge_£t_
##
	`«me
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
); \

624 
båfs_∑ge_˛amp_˛ór_
##
	`«me
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, \

625 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
) \

627 i‡(
	`u∆ikñy
(!
fs_öfo
Ë|| !
	`båfs_is_sub∑ge
(fs_öfo, 
∑ge
)) { \

628 
	`˛ór_∑ge_func
(
∑ge
); \

631 
	`båfs_sub∑ge_˛amp_ønge
(
∑ge
, &
°¨t
, &
Àn
); \

632 
båfs_sub∑ge_˛ór_
##
	`«me
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
); \

634 
boﬁ
 
båfs_∑ge_˛amp_ã°_
##
	`«me
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, \

635 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
) \

637 i‡(
	`u∆ikñy
(!
fs_öfo
Ë|| !
	`båfs_is_sub∑ge
(fs_öfo, 
∑ge
)) \

638  
	`ã°_∑ge_func
(
∑ge
); \

639 
	`båfs_sub∑ge_˛amp_ønge
(
∑ge
, &
°¨t
, &
Àn
); \

640  
båfs_sub∑ge_ã°_
##
	`«me
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
); \

641 }

	)

642 
IMPLEMENT_BTRFS_PAGE_OPS
(
u±od©e
, 
SëPageU±od©e
, 
CÀ¨PageU±od©e
,

643 
PageU±od©e
);

644 
IMPLEMENT_BTRFS_PAGE_OPS
(
dúty
, 
£t_∑ge_dúty
, 
˛ór_∑ge_dúty_f‹_io
,

645 
PageDúty
);

646 
IMPLEMENT_BTRFS_PAGE_OPS
(
wrôeback
, 
£t_∑ge_wrôeback
, 
íd_∑ge_wrôeback
,

647 
PageWrôeback
);

648 
IMPLEMENT_BTRFS_PAGE_OPS
(
‹dîed
, 
SëPageOrdîed
, 
CÀ¨PageOrdîed
,

649 
PageOrdîed
);

650 
IMPLEMENT_BTRFS_PAGE_OPS
(
checked
, 
SëPageChecked
, 
CÀ¨PageChecked
, 
PageChecked
);

656 
	$båfs_∑ge_as£π_nŸ_dúty
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

657 
∑ge
 *page)

659 
båfs_sub∑ge
 *
sub∑ge
 = (båfs_sub∑gê*)
∑ge
->
¥iv©e
;

661 i‡(!
	`IS_ENABLED
(
CONFIG_BTRFS_ASSERT
))

664 
	`ASSERT
(!
	`PageDúty
(
∑ge
));

665 i‡(!
	`båfs_is_sub∑ge
(
fs_öfo
, 
∑ge
))

668 
	`ASSERT
(
	`PagePriv©e
(
∑ge
Ë&&Öage->
¥iv©e
);

669 
	`ASSERT
(
	`sub∑ge_ã°_bôm≠_Æl_zîo
(
fs_öfo
, 
sub∑ge
, 
dúty
));

670 
	}
}

687 
	$båfs_∑ge_u∆ock_wrôî
(
båfs_fs_öfo
 *
fs_öfo
, 
∑ge
 *page,

688 
u64
 
°¨t
, 
u32
 
Àn
)

690 
båfs_sub∑ge
 *
sub∑ge
;

692 
	`ASSERT
(
	`PageLocked
(
∑ge
));

694 i‡(!
	`båfs_is_sub∑ge
(
fs_öfo
, 
∑ge
))

695  
	`u∆ock_∑ge
(
∑ge
);

697 
	`ASSERT
(
	`PagePriv©e
(
∑ge
Ë&&Öage->
¥iv©e
);

698 
sub∑ge
 = (
båfs_sub∑ge
 *)
∑ge
->
¥iv©e
;

707 i‡(
	`©omic_ªad
(&
sub∑ge
->
wrôîs
) == 0)

709  
	`u∆ock_∑ge
(
∑ge
);

712 
	`båfs_∑ge_íd_wrôî_lock
(
fs_öfo
, 
∑ge
, 
°¨t
, 
Àn
);

713 
	}
}

715 
	#GET_SUBPAGE_BITMAP
(
sub∑ge
, 
sub∑ge_öfo
, 
«me
, 
d°
) \

716 
	`bôm≠_cut
(
d°
, 
sub∑ge
->
bôm≠s
, 0, \

717 
sub∑ge_öfo
->
«me
##
_off£t
, sub∑ge_öfo->
bôm≠_ƒ_bôs
)

	)

719 
__cﬁd
 
	$båfs_sub∑ge_dump_bôm≠
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

720 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
)

722 
båfs_sub∑ge_öfo
 *
sub∑ge_öfo
 = 
fs_öfo
->subpage_info;

723 
båfs_sub∑ge
 *
sub∑ge
;

724 
u±od©e_bôm≠
;

725 
îr‹_bôm≠
;

726 
dúty_bôm≠
;

727 
wrôeback_bôm≠
;

728 
‹dîed_bôm≠
;

729 
checked_bôm≠
;

730 
Êags
;

732 
	`ASSERT
(
	`PagePriv©e
(
∑ge
Ë&&Öage->
¥iv©e
);

733 
	`ASSERT
(
sub∑ge_öfo
);

734 
sub∑ge
 = (
båfs_sub∑ge
 *)
∑ge
->
¥iv©e
;

736 
	`•ö_lock_úqßve
(&
sub∑ge
->
lock
, 
Êags
);

737 
	`GET_SUBPAGE_BITMAP
(
sub∑ge
, 
sub∑ge_öfo
, 
u±od©e
, &
u±od©e_bôm≠
);

738 
	`GET_SUBPAGE_BITMAP
(
sub∑ge
, 
sub∑ge_öfo
, 
dúty
, &
dúty_bôm≠
);

739 
	`GET_SUBPAGE_BITMAP
(
sub∑ge
, 
sub∑ge_öfo
, 
wrôeback
, &
wrôeback_bôm≠
);

740 
	`GET_SUBPAGE_BITMAP
(
sub∑ge
, 
sub∑ge_öfo
, 
‹dîed
, &
‹dîed_bôm≠
);

741 
	`GET_SUBPAGE_BITMAP
(
sub∑ge
, 
sub∑ge_öfo
, 
checked
, &
checked_bôm≠
);

742 
	`•ö_u∆ock_úqª°‹e
(&
sub∑ge
->
lock
, 
Êags
);

744 
	`dump_∑ge
(
∑ge
, "btrfs subpage dump");

745 
	`båfs_w¨n
(
fs_öfo
,

747 
°¨t
, 
Àn
, 
	`∑ge_off£t
(
∑ge
),

748 
sub∑ge_öfo
->
bôm≠_ƒ_bôs
, &
u±od©e_bôm≠
,

749 
sub∑ge_öfo
->
bôm≠_ƒ_bôs
, &
îr‹_bôm≠
,

750 
sub∑ge_öfo
->
bôm≠_ƒ_bôs
, &
dúty_bôm≠
,

751 
sub∑ge_öfo
->
bôm≠_ƒ_bôs
, &
wrôeback_bôm≠
,

752 
sub∑ge_öfo
->
bôm≠_ƒ_bôs
, &
‹dîed_bôm≠
,

753 
sub∑ge_öfo
->
bôm≠_ƒ_bôs
, &
checked_bôm≠
);

754 
	}
}

	@subpage.h

3 #i‚de‡
BTRFS_SUBPAGE_H


4 
	#BTRFS_SUBPAGE_H


	)

6 
	~<löux/•ölock.h
>

23 
	sbåfs_sub∑ge_öfo
 {

25 
	mbôm≠_ƒ_bôs
;

28 
	mtŸÆ_ƒ_bôs
;

34 
	mu±od©e_off£t
;

35 
	mdúty_off£t
;

36 
	mwrôeback_off£t
;

37 
	m‹dîed_off£t
;

38 
	mchecked_off£t
;

45 
	sbåfs_sub∑ge
 {

47 
•ölock_t
 
	mlock
;

55 
©omic_t
 
	mªadîs
;

63 
©omic_t
 
	meb_ªfs
;

66 
©omic_t
 
	mwrôîs
;

68 
	mbôm≠s
[];

71 
	ebåfs_sub∑ge_ty≥
 {

72 
	mBTRFS_SUBPAGE_METADATA
,

73 
	mBTRFS_SUBPAGE_DATA
,

76 
boﬁ
 
båfs_is_sub∑ge
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, 
∑ge
 *page);

78 
båfs_öô_sub∑ge_öfo
(
båfs_sub∑ge_öfo
 *
sub∑ge_öfo
, 
u32
 
£˘‹size
);

79 
båfs_©èch_sub∑ge
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

80 
∑ge
 *∑ge, 
båfs_sub∑ge_ty≥
 
ty≥
);

81 
båfs_dëach_sub∑ge
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

82 
∑ge
 *page);

85 
båfs_sub∑ge
 *
båfs_Æloc_sub∑ge
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

86 
båfs_sub∑ge_ty≥
 
ty≥
);

87 
båfs_‰ì_sub∑ge
(
båfs_sub∑ge
 *
sub∑ge
);

89 
båfs_∑ge_öc_eb_ªfs
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

90 
∑ge
 *page);

91 
båfs_∑ge_dec_eb_ªfs
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

92 
∑ge
 *page);

94 
båfs_sub∑ge_°¨t_ªadî
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

95 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
);

96 
båfs_sub∑ge_íd_ªadî
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

97 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
);

99 
båfs_sub∑ge_°¨t_wrôî
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

100 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
);

101 
boﬁ
 
båfs_sub∑ge_íd_™d_ã°_wrôî
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

102 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
);

103 
båfs_∑ge_°¨t_wrôî_lock
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

104 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
);

105 
båfs_∑ge_íd_wrôî_lock
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

106 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
);

122 
	#DECLARE_BTRFS_SUBPAGE_OPS
(
«me
) \

123 
båfs_sub∑ge_£t_
##
	`«me
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, \

124 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
); \

125 
båfs_sub∑ge_˛ór_
##
	`«me
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, \

126 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
); \

127 
boﬁ
 
båfs_sub∑ge_ã°_
##
	`«me
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, \

128 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
); \

129 
båfs_∑ge_£t_
##
	`«me
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, \

130 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
); \

131 
båfs_∑ge_˛ór_
##
	`«me
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, \

132 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
); \

133 
boﬁ
 
båfs_∑ge_ã°_
##
	`«me
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, \

134 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
); \

135 
båfs_∑ge_˛amp_£t_
##
	`«me
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, \

136 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
); \

137 
båfs_∑ge_˛amp_˛ór_
##
	`«me
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, \

138 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
); \

139 
boﬁ
 
båfs_∑ge_˛amp_ã°_
##
	`«me
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
, \

140 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
);

	)

142 
DECLARE_BTRFS_SUBPAGE_OPS
(
u±od©e
);

143 
DECLARE_BTRFS_SUBPAGE_OPS
(
dúty
);

144 
DECLARE_BTRFS_SUBPAGE_OPS
(
wrôeback
);

145 
DECLARE_BTRFS_SUBPAGE_OPS
(
‹dîed
);

146 
DECLARE_BTRFS_SUBPAGE_OPS
(
checked
);

148 
boﬁ
 
båfs_sub∑ge_˛ór_™d_ã°_dúty
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

149 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
);

151 
båfs_∑ge_as£π_nŸ_dúty
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

152 
∑ge
 *page);

153 
båfs_∑ge_u∆ock_wrôî
(
båfs_fs_öfo
 *
fs_öfo
, 
∑ge
 *page,

154 
u64
 
°¨t
, 
u32
 
Àn
);

155 
__cﬁd
 
båfs_sub∑ge_dump_bôm≠
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

156 
∑ge
 *∑ge, 
u64
 
°¨t
, 
u32
 
Àn
);

	@super.c

6 
	~<löux/blkdev.h
>

7 
	~<löux/moduÀ.h
>

8 
	~<löux/fs.h
>

9 
	~<löux/∑gem≠.h
>

10 
	~<löux/highmem.h
>

11 
	~<löux/time.h
>

12 
	~<löux/öô.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/°rög.h
>

15 
	~<löux/backög-dev.h
>

16 
	~<löux/mou¡.h
>

17 
	~<löux/wrôeback.h
>

18 
	~<löux/°©fs.h
>

19 
	~<löux/com∑t.h
>

20 
	~<löux/∑r£r.h
>

21 
	~<löux/˘y≥.h
>

22 
	~<löux/«mei.h
>

23 
	~<löux/miscdevi˚.h
>

24 
	~<löux/magic.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/øãlimô.h
>

27 
	~<löux/¸c32c.h
>

28 
	~<löux/båfs.h
>

29 
	~"mesßges.h
"

30 
	~"dñayed-öode.h
"

31 
	~"˘ªe.h
"

32 
	~"disk-io.h
"

33 
	~"å™ß˘i⁄.h
"

34 
	~"båfs_öode.h
"

35 
	~"¥öt-åì.h
"

36 
	~"¥›s.h
"

37 
	~"x©å.h
"

38 
	~"bio.h
"

39 
	~"exp‹t.h
"

40 
	~"com¥essi⁄.h
"

41 
	~"rcu-°rög.h
"

42 
	~"dev-ª∂a˚.h
"

43 
	~"‰ì-•a˚-ˇche.h
"

44 
	~"backªf.h
"

45 
	~"•a˚-öfo.h
"

46 
	~"sysfs.h
"

47 
	~"z⁄ed.h
"

48 
	~"ã°s/båfs-ã°s.h
"

49 
	~"block-group.h
"

50 
	~"disˇrd.h
"

51 
	~"qgroup.h
"

52 
	~"øid56.h
"

53 
	~"fs.h
"

54 
	~"ac˚ss‹s.h
"

55 
	~"de‰ag.h
"

56 
	~"dú-ôem.h
"

57 
	~"io˘l.h
"

58 
	~"s¸ub.h
"

59 
	~"vîôy.h
"

60 
	~"su≥r.h
"

61 
	~"exã¡-åì.h
"

62 
	#CREATE_TRACE_POINTS


	)

63 
	~<åa˚/evíts/båfs.h
>

65 c⁄° 
su≥r_›î©i⁄s
 
	gbåfs_su≥r_›s
;

75 
fûe_sy°em_ty≥
 
	gbåfs_fs_ty≥
;

76 
fûe_sy°em_ty≥
 
	gbåfs_roŸ_fs_ty≥
;

78 
båfs_ªmou¡
(
su≥r_block
 *
sb
, *
Êags
, *
d©a
);

80 
	$båfs_put_su≥r
(
su≥r_block
 *
sb
)

82 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
sb
);

84 
	`båfs_öfo
(
fs_öfo
, "œ° unmou¡ o‡fûesy°em %pU", fs_öfo->
fs_devi˚s
->
fsid
);

85 
	`˛o£_˘ªe
(
fs_öfo
);

86 
	}
}

89 
	mO±_a˛
, 
	mO±_nﬂ˛
,

90 
	mO±_˛ór_ˇche
,

91 
	mO±_commô_öãrvÆ
,

92 
	mO±_com¥ess
,

93 
	mO±_com¥ess_f‹˚
,

94 
	mO±_com¥ess_f‹˚_ty≥
,

95 
	mO±_com¥ess_ty≥
,

96 
	mO±_degøded
,

97 
	mO±_devi˚
,

98 
	mO±_Áèl_îr‹s
,

99 
	mO±_Êush⁄commô
, 
	mO±_noÊush⁄commô
,

100 
	mO±_max_ölöe
,

101 
	mO±_b¨rõr
, 
	mO±_nob¨rõr
,

102 
	mO±_d©acow
, 
	mO±_nod©acow
,

103 
	mO±_d©asum
, 
	mO±_nod©asum
,

104 
	mO±_de‰ag
, 
	mO±_node‰ag
,

105 
	mO±_disˇrd
, 
	mO±_nodisˇrd
,

106 
	mO±_disˇrd_mode
,

107 
	mO±_n‹ecovîy
,

108 
	mO±_øtio
,

109 
	mO±_ªsˇn_uuid_åì
,

110 
	mO±_skù_bÆ™˚
,

111 
	mO±_•a˚_ˇche
, 
	mO±_no_•a˚_ˇche
,

112 
	mO±_•a˚_ˇche_vîsi⁄
,

113 
	mO±_ssd
, 
	mO±_nossd
,

114 
	mO±_ssd_•ªad
, 
	mO±_nossd_•ªad
,

115 
	mO±_subvﬁ
,

116 
	mO±_subvﬁ_em±y
,

117 
	mO±_subvﬁid
,

118 
	mO±_thªad_poﬁ
,

119 
	mO±_åìlog
, 
	mO±_nŸªñog
,

120 
	mO±_u£r_subvﬁ_rm_Ælowed
,

123 
	mO±_ªscue
,

124 
	mO±_u£backu¥oŸ
,

125 
	mO±_nﬁogª∂ay
,

126 
	mO±_ign‹ebadroŸs
,

127 
	mO±_ign‹ed©acsums
,

128 
	mO±_ªscue_Æl
,

131 
	mO±_ªcovîy
,

132 
	mO±_öode_ˇche
, 
	mO±_noöode_ˇche
,

135 
	mO±_check_öãgrôy
,

136 
	mO±_check_öãgrôy_ö˛udög_exã¡_d©a
,

137 
	mO±_check_öãgrôy_¥öt_mask
,

138 
	mO±_ío•c_debug
, 
	mO±_n€no•c_debug
,

139 #ifde‡
CONFIG_BTRFS_DEBUG


140 
	mO±_‰agmít_d©a
, 
	mO±_‰agmít_mëad©a
, 
	mO±_‰agmít_Æl
,

142 #ifde‡
CONFIG_BTRFS_FS_REF_VERIFY


143 
	mO±_ªf_vîify
,

145 
	mO±_îr
,

148 c⁄° 
m©ch_èbÀ_t
 
	gtokís
 = {

149 {
O±_a˛
, "acl"},

150 {
O±_nﬂ˛
, "noacl"},

151 {
O±_˛ór_ˇche
, "clear_cache"},

152 {
O±_commô_öãrvÆ
, "commit=%u"},

153 {
O±_com¥ess
, "compress"},

154 {
O±_com¥ess_ty≥
, "compress=%s"},

155 {
O±_com¥ess_f‹˚
, "compress-force"},

156 {
O±_com¥ess_f‹˚_ty≥
, "compress-force=%s"},

157 {
O±_degøded
, "degraded"},

158 {
O±_devi˚
, "device=%s"},

159 {
O±_Áèl_îr‹s
, "fatal_errors=%s"},

160 {
O±_Êush⁄commô
, "flushoncommit"},

161 {
O±_noÊush⁄commô
, "noflushoncommit"},

162 {
O±_öode_ˇche
, "inode_cache"},

163 {
O±_noöode_ˇche
, "noinode_cache"},

164 {
O±_max_ölöe
, "max_inline=%s"},

165 {
O±_b¨rõr
, "barrier"},

166 {
O±_nob¨rõr
, "nobarrier"},

167 {
O±_d©acow
, "datacow"},

168 {
O±_nod©acow
, "nodatacow"},

169 {
O±_d©asum
, "datasum"},

170 {
O±_nod©asum
, "nodatasum"},

171 {
O±_de‰ag
, "autodefrag"},

172 {
O±_node‰ag
, "noautodefrag"},

173 {
O±_disˇrd
, "discard"},

174 {
O±_disˇrd_mode
, "discard=%s"},

175 {
O±_nodisˇrd
, "nodiscard"},

176 {
O±_n‹ecovîy
, "norecovery"},

177 {
O±_øtio
, "metadata_ratio=%u"},

178 {
O±_ªsˇn_uuid_åì
, "rescan_uuid_tree"},

179 {
O±_skù_bÆ™˚
, "skip_balance"},

180 {
O±_•a˚_ˇche
, "space_cache"},

181 {
O±_no_•a˚_ˇche
, "nospace_cache"},

182 {
O±_•a˚_ˇche_vîsi⁄
, "space_cache=%s"},

183 {
O±_ssd
, "ssd"},

184 {
O±_nossd
, "nossd"},

185 {
O±_ssd_•ªad
, "ssd_spread"},

186 {
O±_nossd_•ªad
, "nossd_spread"},

187 {
O±_subvﬁ
, "subvol=%s"},

188 {
O±_subvﬁ_em±y
, "subvol="},

189 {
O±_subvﬁid
, "subvolid=%s"},

190 {
O±_thªad_poﬁ
, "thread_pool=%u"},

191 {
O±_åìlog
, "treelog"},

192 {
O±_nŸªñog
, "notreelog"},

193 {
O±_u£r_subvﬁ_rm_Ælowed
, "user_subvol_rm_allowed"},

196 {
O±_ªscue
, "rescue=%s"},

198 {
O±_nﬁogª∂ay
, "nologreplay"},

200 {
O±_u£backu¥oŸ
, "usebackuproot"},

203 {
O±_ªcovîy
, "recovery"},

206 {
O±_check_öãgrôy
, "check_int"},

207 {
O±_check_öãgrôy_ö˛udög_exã¡_d©a
, "check_int_data"},

208 {
O±_check_öãgrôy_¥öt_mask
, "check_int_print_mask=%u"},

209 {
O±_ío•c_debug
, "enospc_debug"},

210 {
O±_n€no•c_debug
, "noenospc_debug"},

211 #ifde‡
CONFIG_BTRFS_DEBUG


212 {
O±_‰agmít_d©a
, "fragment=data"},

213 {
O±_‰agmít_mëad©a
, "fragment=metadata"},

214 {
O±_‰agmít_Æl
, "fragment=all"},

216 #ifde‡
CONFIG_BTRFS_FS_REF_VERIFY


217 {
O±_ªf_vîify
, "ref_verify"},

219 {
O±_îr
, 
NULL
},

222 c⁄° 
m©ch_èbÀ_t
 
	gªscue_tokís
 = {

223 {
O±_u£backu¥oŸ
, "usebackuproot"},

224 {
O±_nﬁogª∂ay
, "nologreplay"},

225 {
O±_ign‹ebadroŸs
, "ignorebadroots"},

226 {
O±_ign‹ebadroŸs
, "ibadroots"},

227 {
O±_ign‹ed©acsums
, "ignoredatacsums"},

228 {
O±_ign‹ed©acsums
, "idatacsums"},

229 {
O±_ªscue_Æl
, "all"},

230 {
O±_îr
, 
NULL
},

233 
boﬁ
 
	$check_ro_›ti⁄
(
båfs_fs_öfo
 *
fs_öfo
, 
›t
,

234 c⁄° *
›t_«me
)

236 i‡(
fs_öfo
->
mou¡_›t
 & 
›t
) {

237 
	`båfs_îr
(
fs_öfo
, "%s must be used withÑo mount option",

238 
›t_«me
);

239  
åue
;

241  
Ál£
;

242 
	}
}

244 
	$∑r£_ªscue_›ti⁄s
(
båfs_fs_öfo
 *
öfo
, c⁄° *
›ti⁄s
)

246 *
›ts
;

247 *
‹ig
;

248 *
p
;

249 
sub°rög_t
 
¨gs
[
MAX_OPT_ARGS
];

250 
ªt
 = 0;

252 
›ts
 = 
	`k°rdup
(
›ti⁄s
, 
GFP_KERNEL
);

253 i‡(!
›ts
)

254  -
ENOMEM
;

255 
‹ig
 = 
›ts
;

257 (
p
 = 
	`°r£p
(&
›ts
, ":")Ë!
NULL
) {

258 
tokí
;

260 i‡(!*
p
)

262 
tokí
 = 
	`m©ch_tokí
(
p
, 
ªscue_tokís
, 
¨gs
);

263 
tokí
){

264 
O±_u£backu¥oŸ
:

265 
	`båfs_öfo
(
öfo
,

267 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
USEBACKUPROOT
);

269 
O±_nﬁogª∂ay
:

270 
	`båfs_£t_™d_öfo
(
öfo
, 
NOLOGREPLAY
,

273 
O±_ign‹ebadroŸs
:

274 
	`båfs_£t_™d_öfo
(
öfo
, 
IGNOREBADROOTS
,

277 
O±_ign‹ed©acsums
:

278 
	`båfs_£t_™d_öfo
(
öfo
, 
IGNOREDATACSUMS
,

281 
O±_ªscue_Æl
:

282 
	`båfs_öfo
(
öfo
, "enablingáll ofÅheÑescue options");

283 
	`båfs_£t_™d_öfo
(
öfo
, 
IGNOREDATACSUMS
,

285 
	`båfs_£t_™d_öfo
(
öfo
, 
IGNOREBADROOTS
,

287 
	`båfs_£t_™d_öfo
(
öfo
, 
NOLOGREPLAY
,

290 
O±_îr
:

291 
	`båfs_öfo
(
öfo
, "uƒecognizedÑescuê›ti⁄ '%s'", 
p
);

292 
ªt
 = -
EINVAL
;

293 
out
;

299 
out
:

300 
	`k‰ì
(
‹ig
);

301  
ªt
;

302 
	}
}

309 
	$båfs_∑r£_›ti⁄s
(
båfs_fs_öfo
 *
öfo
, *
›ti⁄s
,

310 
√w_Êags
)

312 
sub°rög_t
 
¨gs
[
MAX_OPT_ARGS
];

313 *
p
, *
num
;

314 
öèrg
;

315 
ªt
 = 0;

316 *
com¥ess_ty≥
;

317 
boﬁ
 
com¥ess_f‹˚
 = 
Ál£
;

318 
båfs_com¥essi⁄_ty≥
 
ßved_com¥ess_ty≥
;

319 
ßved_com¥ess_Àvñ
;

320 
boﬁ
 
ßved_com¥ess_f‹˚
;

321 
no_com¥ess
 = 0;

322 c⁄° 
boﬁ
 
ªmou¡ög
 = 
	`ã°_bô
(
BTRFS_FS_STATE_REMOUNTING
, &
öfo
->
fs_°©e
);

324 i‡(
	`båfs_fs_com∑t_ro
(
öfo
, 
FREE_SPACE_TREE
))

325 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
FREE_SPACE_TREE
);

326 i‡(
	`båfs_‰ì_•a˚_ˇche_v1_a˘ive
(
öfo
)) {

327 i‡(
	`båfs_is_z⁄ed
(
öfo
)) {

328 
	`båfs_öfo
(
öfo
,

330 
	`båfs_£t_su≥r_ˇche_gíî©i⁄
(
öfo
->
su≥r_c›y
, 0);

332 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
SPACE_CACHE
);

340 i‡(!
›ti⁄s
)

341 
check
;

343 (
p
 = 
	`°r£p
(&
›ti⁄s
, ",")Ë!
NULL
) {

344 
tokí
;

345 i‡(!*
p
)

348 
tokí
 = 
	`m©ch_tokí
(
p
, 
tokís
, 
¨gs
);

349 
tokí
) {

350 
O±_degøded
:

351 
	`båfs_öfo
(
öfo
, "allowing degraded mounts");

352 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
DEGRADED
);

354 
O±_subvﬁ
:

355 
O±_subvﬁ_em±y
:

356 
O±_subvﬁid
:

357 
O±_devi˚
:

363 
O±_nod©asum
:

364 
	`båfs_£t_™d_öfo
(
öfo
, 
NODATASUM
,

367 
O±_d©asum
:

368 i‡(
	`båfs_ã°_›t
(
öfo
, 
NODATASUM
)) {

369 i‡(
	`båfs_ã°_›t
(
öfo
, 
NODATACOW
))

370 
	`båfs_öfo
(
öfo
,

373 
	`båfs_öfo
(
öfo
, "setting datasum");

375 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
NODATACOW
);

376 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
NODATASUM
);

378 
O±_nod©acow
:

379 i‡(!
	`båfs_ã°_›t
(
öfo
, 
NODATACOW
)) {

380 i‡(!
	`båfs_ã°_›t
(
öfo
, 
COMPRESS
) ||

381 !
	`båfs_ã°_›t
(
öfo
, 
FORCE_COMPRESS
)) {

382 
	`båfs_öfo
(
öfo
,

385 
	`båfs_öfo
(
öfo
, "settingÇodatacow");

388 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
COMPRESS
);

389 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
FORCE_COMPRESS
);

390 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
NODATACOW
);

391 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
NODATASUM
);

393 
O±_d©acow
:

394 
	`båfs_˛ór_™d_öfo
(
öfo
, 
NODATACOW
,

397 
O±_com¥ess_f‹˚
:

398 
O±_com¥ess_f‹˚_ty≥
:

399 
com¥ess_f‹˚
 = 
åue
;

400 
ÁŒthrough
;

401 
O±_com¥ess
:

402 
O±_com¥ess_ty≥
:

403 
ßved_com¥ess_ty≥
 = 
	`båfs_ã°_›t
(
öfo
,

404 
COMPRESS
) ?

405 
öfo
->
com¥ess_ty≥
 : 
BTRFS_COMPRESS_NONE
;

406 
ßved_com¥ess_f‹˚
 =

407 
	`båfs_ã°_›t
(
öfo
, 
FORCE_COMPRESS
);

408 
ßved_com¥ess_Àvñ
 = 
öfo
->
com¥ess_Àvñ
;

409 i‡(
tokí
 =
O±_com¥ess
 ||

410 
tokí
 =
O±_com¥ess_f‹˚
 ||

411 
	`°∫cmp
(
¨gs
[0].
‰om
, "zlib", 4) == 0) {

412 
com¥ess_ty≥
 = "zlib";

414 
öfo
->
com¥ess_ty≥
 = 
BTRFS_COMPRESS_ZLIB
;

415 
öfo
->
com¥ess_Àvñ
 = 
BTRFS_ZLIB_DEFAULT_LEVEL
;

421 i‡(
tokí
 !
O±_com¥ess
 &&

422 
tokí
 !
O±_com¥ess_f‹˚
)

423 
öfo
->
com¥ess_Àvñ
 =

424 
	`båfs_com¥ess_°r2Àvñ
(

425 
BTRFS_COMPRESS_ZLIB
,

426 
¨gs
[0].
‰om
 + 4);

427 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
COMPRESS
);

428 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
NODATACOW
);

429 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
NODATASUM
);

430 
no_com¥ess
 = 0;

431 } i‡(
	`°∫cmp
(
¨gs
[0].
‰om
, "lzo", 3) == 0) {

432 
com¥ess_ty≥
 = "lzo";

433 
öfo
->
com¥ess_ty≥
 = 
BTRFS_COMPRESS_LZO
;

434 
öfo
->
com¥ess_Àvñ
 = 0;

435 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
COMPRESS
);

436 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
NODATACOW
);

437 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
NODATASUM
);

438 
	`båfs_£t_fs_öcom∑t
(
öfo
, 
COMPRESS_LZO
);

439 
no_com¥ess
 = 0;

440 } i‡(
	`°∫cmp
(
¨gs
[0].
‰om
, "zstd", 4) == 0) {

441 
com¥ess_ty≥
 = "zstd";

442 
öfo
->
com¥ess_ty≥
 = 
BTRFS_COMPRESS_ZSTD
;

443 
öfo
->
com¥ess_Àvñ
 =

444 
	`båfs_com¥ess_°r2Àvñ
(

445 
BTRFS_COMPRESS_ZSTD
,

446 
¨gs
[0].
‰om
 + 4);

447 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
COMPRESS
);

448 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
NODATACOW
);

449 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
NODATASUM
);

450 
	`båfs_£t_fs_öcom∑t
(
öfo
, 
COMPRESS_ZSTD
);

451 
no_com¥ess
 = 0;

452 } i‡(
	`°∫cmp
(
¨gs
[0].
‰om
, "no", 2) == 0) {

453 
com¥ess_ty≥
 = "no";

454 
öfo
->
com¥ess_Àvñ
 = 0;

455 
öfo
->
com¥ess_ty≥
 = 0;

456 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
COMPRESS
);

457 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
FORCE_COMPRESS
);

458 
com¥ess_f‹˚
 = 
Ál£
;

459 
no_com¥ess
++;

461 
	`båfs_îr
(
öfo
, "unrecognized compression value %s",

462 
¨gs
[0].
‰om
);

463 
ªt
 = -
EINVAL
;

464 
out
;

467 i‡(
com¥ess_f‹˚
) {

468 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
FORCE_COMPRESS
);

476 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
FORCE_COMPRESS
);

478 i‡(
no_com¥ess
 == 1) {

479 
	`båfs_öfo
(
öfo
, "useÇo compression");

480 } i‡((
öfo
->
com¥ess_ty≥
 !
ßved_com¥ess_ty≥
) ||

481 (
com¥ess_f‹˚
 !
ßved_com¥ess_f‹˚
) ||

482 (
öfo
->
com¥ess_Àvñ
 !
ßved_com¥ess_Àvñ
)) {

483 
	`båfs_öfo
(
öfo
, "%s %s compression,Üevel %d",

484 (
com¥ess_f‹˚
) ? "force" : "use",

485 
com¥ess_ty≥
, 
öfo
->
com¥ess_Àvñ
);

487 
com¥ess_f‹˚
 = 
Ál£
;

489 
O±_ssd
:

490 
	`båfs_£t_™d_öfo
(
öfo
, 
SSD
,

492 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
NOSSD
);

494 
O±_ssd_•ªad
:

495 
	`båfs_£t_™d_öfo
(
öfo
, 
SSD
,

497 
	`båfs_£t_™d_öfo
(
öfo
, 
SSD_SPREAD
,

499 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
NOSSD
);

501 
O±_nossd
:

502 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
NOSSD
);

503 
	`båfs_˛ór_™d_öfo
(
öfo
, 
SSD
,

505 
ÁŒthrough
;

506 
O±_nossd_•ªad
:

507 
	`båfs_˛ór_™d_öfo
(
öfo
, 
SSD_SPREAD
,

510 
O±_b¨rõr
:

511 
	`båfs_˛ór_™d_öfo
(
öfo
, 
NOBARRIER
,

514 
O±_nob¨rõr
:

515 
	`båfs_£t_™d_öfo
(
öfo
, 
NOBARRIER
,

518 
O±_thªad_poﬁ
:

519 
ªt
 = 
	`m©ch_öt
(&
¨gs
[0], &
öèrg
);

520 i‡(
ªt
) {

521 
	`båfs_îr
(
öfo
, "unrecognizedÅhread_pool value %s",

522 
¨gs
[0].
‰om
);

523 
out
;

524 } i‡(
öèrg
 == 0) {

525 
	`båfs_îr
(
öfo
, "invalid value 0 forÅhread_pool");

526 
ªt
 = -
EINVAL
;

527 
out
;

529 
öfo
->
thªad_poﬁ_size
 = 
öèrg
;

531 
O±_max_ölöe
:

532 
num
 = 
	`m©ch_°rdup
(&
¨gs
[0]);

533 i‡(
num
) {

534 
öfo
->
max_ölöe
 = 
	`mem∑r£
(
num
, 
NULL
);

535 
	`k‰ì
(
num
);

537 i‡(
öfo
->
max_ölöe
) {

538 
öfo
->
max_ölöe
 = 
	`mö_t
(
u64
,

539 
öfo
->
max_ölöe
,

540 
öfo
->
£˘‹size
);

542 
	`båfs_öfo
(
öfo
, "max_inlineát %llu",

543 
öfo
->
max_ölöe
);

545 
ªt
 = -
ENOMEM
;

546 
out
;

549 
O±_a˛
:

550 #ifde‡
CONFIG_BTRFS_FS_POSIX_ACL


551 
öfo
->
sb
->
s_Êags
 |
SB_POSIXACL
;

554 
	`båfs_îr
(
öfo
, "support for ACLÇot compiled in!");

555 
ªt
 = -
EINVAL
;

556 
out
;

558 
O±_nﬂ˛
:

559 
öfo
->
sb
->
s_Êags
 &~
SB_POSIXACL
;

561 
O±_nŸªñog
:

562 
	`båfs_£t_™d_öfo
(
öfo
, 
NOTREELOG
,

565 
O±_åìlog
:

566 
	`båfs_˛ór_™d_öfo
(
öfo
, 
NOTREELOG
,

569 
O±_n‹ecovîy
:

570 
O±_nﬁogª∂ay
:

571 
	`båfs_w¨n
(
öfo
,

573 
	`båfs_£t_™d_öfo
(
öfo
, 
NOLOGREPLAY
,

576 
O±_Êush⁄commô
:

577 
	`båfs_£t_™d_öfo
(
öfo
, 
FLUSHONCOMMIT
,

580 
O±_noÊush⁄commô
:

581 
	`båfs_˛ór_™d_öfo
(
öfo
, 
FLUSHONCOMMIT
,

584 
O±_øtio
:

585 
ªt
 = 
	`m©ch_öt
(&
¨gs
[0], &
öèrg
);

586 i‡(
ªt
) {

587 
	`båfs_îr
(
öfo
, "unrecognized metadata_ratio value %s",

588 
¨gs
[0].
‰om
);

589 
out
;

591 
öfo
->
mëad©a_øtio
 = 
öèrg
;

592 
	`båfs_öfo
(
öfo
, "metadataÑatio %u",

593 
öfo
->
mëad©a_øtio
);

595 
O±_disˇrd
:

596 
O±_disˇrd_mode
:

597 i‡(
tokí
 =
O±_disˇrd
 ||

598 
	`°rcmp
(
¨gs
[0].
‰om
, "sync") == 0) {

599 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
DISCARD_ASYNC
);

600 
	`båfs_£t_™d_öfo
(
öfo
, 
DISCARD_SYNC
,

602 } i‡(
	`°rcmp
(
¨gs
[0].
‰om
, "async") == 0) {

603 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
DISCARD_SYNC
);

604 
	`båfs_£t_™d_öfo
(
öfo
, 
DISCARD_ASYNC
,

607 
	`båfs_îr
(
öfo
, "unrecognized discard mode value %s",

608 
¨gs
[0].
‰om
);

609 
ªt
 = -
EINVAL
;

610 
out
;

612 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
NODISCARD
);

614 
O±_nodisˇrd
:

615 
	`båfs_˛ór_™d_öfo
(
öfo
, 
DISCARD_SYNC
,

617 
	`båfs_˛ór_™d_öfo
(
öfo
, 
DISCARD_ASYNC
,

619 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
NODISCARD
);

621 
O±_•a˚_ˇche
:

622 
O±_•a˚_ˇche_vîsi⁄
:

629 i‡(
	`båfs_fs_öcom∑t
(
öfo
, 
EXTENT_TREE_V2
))

631 i‡(
tokí
 =
O±_•a˚_ˇche
 ||

632 
	`°rcmp
(
¨gs
[0].
‰om
, "v1") == 0) {

633 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
,

634 
FREE_SPACE_TREE
);

635 
	`båfs_£t_™d_öfo
(
öfo
, 
SPACE_CACHE
,

637 } i‡(
	`°rcmp
(
¨gs
[0].
‰om
, "v2") == 0) {

638 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
,

639 
SPACE_CACHE
);

640 
	`båfs_£t_™d_öfo
(
öfo
, 
FREE_SPACE_TREE
,

643 
	`båfs_îr
(
öfo
, "unrecognized space_cache value %s",

644 
¨gs
[0].
‰om
);

645 
ªt
 = -
EINVAL
;

646 
out
;

649 
O±_ªsˇn_uuid_åì
:

650 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
RESCAN_UUID_TREE
);

652 
O±_no_•a˚_ˇche
:

657 i‡(
	`båfs_fs_öcom∑t
(
öfo
, 
EXTENT_TREE_V2
))

659 i‡(
	`båfs_ã°_›t
(
öfo
, 
SPACE_CACHE
)) {

660 
	`båfs_˛ór_™d_öfo
(
öfo
, 
SPACE_CACHE
,

663 i‡(
	`båfs_ã°_›t
(
öfo
, 
FREE_SPACE_TREE
)) {

664 
	`båfs_˛ór_™d_öfo
(
öfo
, 
FREE_SPACE_TREE
,

668 
O±_öode_ˇche
:

669 
O±_noöode_ˇche
:

670 
	`båfs_w¨n
(
öfo
,

673 
O±_˛ór_ˇche
:

678 i‡(
	`båfs_fs_öcom∑t
(
öfo
, 
EXTENT_TREE_V2
))

680 
	`båfs_£t_™d_öfo
(
öfo
, 
CLEAR_CACHE
,

683 
O±_u£r_subvﬁ_rm_Ælowed
:

684 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
USER_SUBVOL_RM_ALLOWED
);

686 
O±_ío•c_debug
:

687 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
ENOSPC_DEBUG
);

689 
O±_n€no•c_debug
:

690 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
, 
ENOSPC_DEBUG
);

692 
O±_de‰ag
:

693 
	`båfs_£t_™d_öfo
(
öfo
, 
AUTO_DEFRAG
,

696 
O±_node‰ag
:

697 
	`båfs_˛ór_™d_öfo
(
öfo
, 
AUTO_DEFRAG
,

700 
O±_ªcovîy
:

701 
O±_u£backu¥oŸ
:

702 
	`båfs_w¨n
(
öfo
,

704 
tokí
 =
O±_ªcovîy
 ? "recovery" :

706 
	`båfs_öfo
(
öfo
,

708 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
USEBACKUPROOT
);

710 
O±_skù_bÆ™˚
:

711 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
SKIP_BALANCE
);

713 #ifde‡
CONFIG_BTRFS_FS_CHECK_INTEGRITY


714 
O±_check_öãgrôy_ö˛udög_exã¡_d©a
:

715 
	`båfs_w¨n
(
öfo
,

717 
	`båfs_öfo
(
öfo
,

719 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
CHECK_INTEGRITY_DATA
);

720 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
CHECK_INTEGRITY
);

722 
O±_check_öãgrôy
:

723 
	`båfs_w¨n
(
öfo
,

725 
	`båfs_öfo
(
öfo
, "enabling check integrity");

726 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
CHECK_INTEGRITY
);

728 
O±_check_öãgrôy_¥öt_mask
:

729 
ªt
 = 
	`m©ch_öt
(&
¨gs
[0], &
öèrg
);

730 i‡(
ªt
) {

731 
	`båfs_îr
(
öfo
,

733 
¨gs
[0].
‰om
);

734 
out
;

736 
öfo
->
check_öãgrôy_¥öt_mask
 = 
öèrg
;

737 
	`båfs_w¨n
(
öfo
,

739 
	`båfs_öfo
(
öfo
, "check_integrity_print_mask 0x%x",

740 
öfo
->
check_öãgrôy_¥öt_mask
);

743 
O±_check_öãgrôy_ö˛udög_exã¡_d©a
:

744 
O±_check_öãgrôy
:

745 
O±_check_öãgrôy_¥öt_mask
:

746 
	`båfs_îr
(
öfo
,

748 
ªt
 = -
EINVAL
;

749 
out
;

751 
O±_Áèl_îr‹s
:

752 i‡(
	`°rcmp
(
¨gs
[0].
‰om
, "panic") == 0) {

753 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
,

754 
PANIC_ON_FATAL_ERROR
);

755 } i‡(
	`°rcmp
(
¨gs
[0].
‰om
, "bug") == 0) {

756 
	`båfs_˛ór_›t
(
öfo
->
mou¡_›t
,

757 
PANIC_ON_FATAL_ERROR
);

759 
	`båfs_îr
(
öfo
, "unrecognized fatal_errors value %s",

760 
¨gs
[0].
‰om
);

761 
ªt
 = -
EINVAL
;

762 
out
;

765 
O±_commô_öãrvÆ
:

766 
öèrg
 = 0;

767 
ªt
 = 
	`m©ch_öt
(&
¨gs
[0], &
öèrg
);

768 i‡(
ªt
) {

769 
	`båfs_îr
(
öfo
, "unrecognized commit_interval value %s",

770 
¨gs
[0].
‰om
);

771 
ªt
 = -
EINVAL
;

772 
out
;

774 i‡(
öèrg
 == 0) {

775 
	`båfs_öfo
(
öfo
,

777 
BTRFS_DEFAULT_COMMIT_INTERVAL
);

778 
öèrg
 = 
BTRFS_DEFAULT_COMMIT_INTERVAL
;

779 } i‡(
öèrg
 > 300) {

780 
	`båfs_w¨n
(
öfo
, "excessive commit interval %d",

781 
öèrg
);

783 
öfo
->
commô_öãrvÆ
 = 
öèrg
;

785 
O±_ªscue
:

786 
ªt
 = 
	`∑r£_ªscue_›ti⁄s
(
öfo
, 
¨gs
[0].
‰om
);

787 i‡(
ªt
 < 0) {

788 
	`båfs_îr
(
öfo
, "unrecognizedÑescue value %s",

789 
¨gs
[0].
‰om
);

790 
out
;

793 #ifde‡
CONFIG_BTRFS_DEBUG


794 
O±_‰agmít_Æl
:

795 
	`båfs_öfo
(
öfo
, "fragmentingáll space");

796 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
FRAGMENT_DATA
);

797 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
FRAGMENT_METADATA
);

799 
O±_‰agmít_mëad©a
:

800 
	`båfs_öfo
(
öfo
, "fragmenting metadata");

801 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
,

802 
FRAGMENT_METADATA
);

804 
O±_‰agmít_d©a
:

805 
	`båfs_öfo
(
öfo
, "fragmenting data");

806 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
FRAGMENT_DATA
);

809 #ifde‡
CONFIG_BTRFS_FS_REF_VERIFY


810 
O±_ªf_vîify
:

811 
	`båfs_öfo
(
öfo
, "doingÑef verification");

812 
	`båfs_£t_›t
(
öfo
->
mou¡_›t
, 
REF_VERIFY
);

815 
O±_îr
:

816 
	`båfs_îr
(
öfo
, "uƒecognized mou¡ o±i⁄ '%s'", 
p
);

817 
ªt
 = -
EINVAL
;

818 
out
;

823 
check
:

825 i‡(
√w_Êags
 & 
SB_RDONLY
)

826 
out
;

828 i‡(
	`check_ro_›ti⁄
(
öfo
, 
BTRFS_MOUNT_NOLOGREPLAY
, "nologreplay") ||

829 
	`check_ro_›ti⁄
(
öfo
, 
BTRFS_MOUNT_IGNOREBADROOTS
, "ignorebadroots") ||

830 
	`check_ro_›ti⁄
(
öfo
, 
BTRFS_MOUNT_IGNOREDATACSUMS
, "ignoredatacsums"))

831 
ªt
 = -
EINVAL
;

832 
out
:

833 i‡(
	`båfs_fs_com∑t_ro
(
öfo
, 
FREE_SPACE_TREE
) &&

834 !
	`båfs_ã°_›t
(
öfo
, 
FREE_SPACE_TREE
) &&

835 !
	`båfs_ã°_›t
(
öfo
, 
CLEAR_CACHE
)) {

836 
	`båfs_îr
(
öfo
, "cannot disable free spaceÅree");

837 
ªt
 = -
EINVAL
;

839 i‡(
	`båfs_fs_com∑t_ro
(
öfo
, 
BLOCK_GROUP_TREE
) &&

840 !
	`båfs_ã°_›t
(
öfo
, 
FREE_SPACE_TREE
)) {

841 
	`båfs_îr
(
öfo
, "cannot disable free spaceÅree with block-group-tree feature");

842 
ªt
 = -
EINVAL
;

844 i‡(!
ªt
)

845 
ªt
 = 
	`båfs_check_mou¡›ts_z⁄ed
(
öfo
);

846 i‡(!
ªt
 && !
ªmou¡ög
) {

847 i‡(
	`båfs_ã°_›t
(
öfo
, 
SPACE_CACHE
))

848 
	`båfs_öfo
(
öfo
, "disk space caching isÉnabled");

849 i‡(
	`båfs_ã°_›t
(
öfo
, 
FREE_SPACE_TREE
))

850 
	`båfs_öfo
(
öfo
, "using free spaceÅree");

852  
ªt
;

853 
	}
}

861 
	$båfs_∑r£_devi˚_›ti⁄s
(c⁄° *
›ti⁄s
, 
blk_mode_t
 
Êags
)

863 
sub°rög_t
 
¨gs
[
MAX_OPT_ARGS
];

864 *
devi˚_«me
, *
›ts
, *
‹ig
, *
p
;

865 
båfs_devi˚
 *
devi˚
 = 
NULL
;

866 
îr‹
 = 0;

868 
	`lockdï_as£π_hñd
(&
uuid_muãx
);

870 i‡(!
›ti⁄s
)

877 
›ts
 = 
	`k°rdup
(
›ti⁄s
, 
GFP_KERNEL
);

878 i‡(!
›ts
)

879  -
ENOMEM
;

880 
‹ig
 = 
›ts
;

882 (
p
 = 
	`°r£p
(&
›ts
, ",")Ë!
NULL
) {

883 
tokí
;

885 i‡(!*
p
)

888 
tokí
 = 
	`m©ch_tokí
(
p
, 
tokís
, 
¨gs
);

889 i‡(
tokí
 =
O±_devi˚
) {

890 
devi˚_«me
 = 
	`m©ch_°rdup
(&
¨gs
[0]);

891 i‡(!
devi˚_«me
) {

892 
îr‹
 = -
ENOMEM
;

893 
out
;

895 
devi˚
 = 
	`båfs_sˇn_⁄e_devi˚
(
devi˚_«me
, 
Êags
);

896 
	`k‰ì
(
devi˚_«me
);

897 i‡(
	`IS_ERR
(
devi˚
)) {

898 
îr‹
 = 
	`PTR_ERR
(
devi˚
);

899 
out
;

904 
out
:

905 
	`k‰ì
(
‹ig
);

906  
îr‹
;

907 
	}
}

914 
	$båfs_∑r£_subvﬁ_›ti⁄s
(c⁄° *
›ti⁄s
, **
subvﬁ_«me
,

915 
u64
 *
subvﬁ_obje˘id
)

917 
sub°rög_t
 
¨gs
[
MAX_OPT_ARGS
];

918 *
›ts
, *
‹ig
, *
p
;

919 
îr‹
 = 0;

920 
u64
 
subvﬁid
;

922 i‡(!
›ti⁄s
)

929 
›ts
 = 
	`k°rdup
(
›ti⁄s
, 
GFP_KERNEL
);

930 i‡(!
›ts
)

931  -
ENOMEM
;

932 
‹ig
 = 
›ts
;

934 (
p
 = 
	`°r£p
(&
›ts
, ",")Ë!
NULL
) {

935 
tokí
;

936 i‡(!*
p
)

939 
tokí
 = 
	`m©ch_tokí
(
p
, 
tokís
, 
¨gs
);

940 
tokí
) {

941 
O±_subvﬁ
:

942 
	`k‰ì
(*
subvﬁ_«me
);

943 *
subvﬁ_«me
 = 
	`m©ch_°rdup
(&
¨gs
[0]);

944 i‡(!*
subvﬁ_«me
) {

945 
îr‹
 = -
ENOMEM
;

946 
out
;

949 
O±_subvﬁid
:

950 
îr‹
 = 
	`m©ch_u64
(&
¨gs
[0], &
subvﬁid
);

951 i‡(
îr‹
)

952 
out
;

955 i‡(
subvﬁid
 == 0)

956 
subvﬁid
 = 
BTRFS_FS_TREE_OBJECTID
;

958 *
subvﬁ_obje˘id
 = 
subvﬁid
;

965 
out
:

966 
	`k‰ì
(
‹ig
);

967  
îr‹
;

968 
	}
}

970 *
	$båfs_gë_subvﬁ_«me_‰om_obje˘id
(
båfs_fs_öfo
 *
fs_öfo
,

971 
u64
 
subvﬁ_obje˘id
)

973 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
åì_roŸ
;

974 
båfs_roŸ
 *
fs_roŸ
 = 
NULL
;

975 
båfs_roŸ_ªf
 *
roŸ_ªf
;

976 
båfs_öode_ªf
 *
öode_ªf
;

977 
båfs_key
 
key
;

978 
båfs_∑th
 *
∑th
 = 
NULL
;

979 *
«me
 = 
NULL
, *
±r
;

980 
u64
 
dúid
;

981 
Àn
;

982 
ªt
;

984 
∑th
 = 
	`båfs_Æloc_∑th
();

985 i‡(!
∑th
) {

986 
ªt
 = -
ENOMEM
;

987 
îr
;

990 
«me
 = 
	`kmÆloc
(
PATH_MAX
, 
GFP_KERNEL
);

991 i‡(!
«me
) {

992 
ªt
 = -
ENOMEM
;

993 
îr
;

995 
±r
 = 
«me
 + 
PATH_MAX
 - 1;

996 
±r
[0] = '\0';

1002 
subvﬁ_obje˘id
 !
BTRFS_FS_TREE_OBJECTID
) {

1003 
key
.
obje˘id
 = 
subvﬁ_obje˘id
;

1004 
key
.
ty≥
 = 
BTRFS_ROOT_BACKREF_KEY
;

1005 
key
.
off£t
 = (
u64
)-1;

1007 
ªt
 = 
	`båfs_£¨ch_backw¨ds
(
roŸ
, &
key
, 
∑th
);

1008 i‡(
ªt
 < 0) {

1009 
îr
;

1010 } i‡(
ªt
 > 0) {

1011 
ªt
 = -
ENOENT
;

1012 
îr
;

1015 
subvﬁ_obje˘id
 = 
key
.
off£t
;

1017 
roŸ_ªf
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

1018 
båfs_roŸ_ªf
);

1019 
Àn
 = 
	`båfs_roŸ_ªf_«me_Àn
(
∑th
->
nodes
[0], 
roŸ_ªf
);

1020 
±r
 -
Àn
 + 1;

1021 i‡(
±r
 < 
«me
) {

1022 
ªt
 = -
ENAMETOOLONG
;

1023 
îr
;

1025 
	`ªad_exã¡_buf„r
(
∑th
->
nodes
[0], 
±r
 + 1,

1026 ()(
roŸ_ªf
 + 1), 
Àn
);

1027 
±r
[0] = '/';

1028 
dúid
 = 
	`båfs_roŸ_ªf_dúid
(
∑th
->
nodes
[0], 
roŸ_ªf
);

1029 
	`båfs_ªÀa£_∑th
(
∑th
);

1031 
fs_roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
subvﬁ_obje˘id
, 
åue
);

1032 i‡(
	`IS_ERR
(
fs_roŸ
)) {

1033 
ªt
 = 
	`PTR_ERR
(
fs_roŸ
);

1034 
fs_roŸ
 = 
NULL
;

1035 
îr
;

1042 
dúid
 !
BTRFS_FIRST_FREE_OBJECTID
) {

1043 
key
.
obje˘id
 = 
dúid
;

1044 
key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

1045 
key
.
off£t
 = (
u64
)-1;

1047 
ªt
 = 
	`båfs_£¨ch_backw¨ds
(
fs_roŸ
, &
key
, 
∑th
);

1048 i‡(
ªt
 < 0) {

1049 
îr
;

1050 } i‡(
ªt
 > 0) {

1051 
ªt
 = -
ENOENT
;

1052 
îr
;

1055 
dúid
 = 
key
.
off£t
;

1057 
öode_ªf
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],

1058 
∑th
->
¶Ÿs
[0],

1059 
båfs_öode_ªf
);

1060 
Àn
 = 
	`båfs_öode_ªf_«me_Àn
(
∑th
->
nodes
[0],

1061 
öode_ªf
);

1062 
±r
 -
Àn
 + 1;

1063 i‡(
±r
 < 
«me
) {

1064 
ªt
 = -
ENAMETOOLONG
;

1065 
îr
;

1067 
	`ªad_exã¡_buf„r
(
∑th
->
nodes
[0], 
±r
 + 1,

1068 ()(
öode_ªf
 + 1), 
Àn
);

1069 
±r
[0] = '/';

1070 
	`båfs_ªÀa£_∑th
(
∑th
);

1072 
	`båfs_put_roŸ
(
fs_roŸ
);

1073 
fs_roŸ
 = 
NULL
;

1076 
	`båfs_‰ì_∑th
(
∑th
);

1077 i‡(
±r
 =
«me
 + 
PATH_MAX
 - 1) {

1078 
«me
[0] = '/';

1079 
«me
[1] = '\0';

1081 
	`memmove
(
«me
, 
±r
,Çamê+ 
PATH_MAX
 -Ötr);

1083  
«me
;

1085 
îr
:

1086 
	`båfs_put_roŸ
(
fs_roŸ
);

1087 
	`båfs_‰ì_∑th
(
∑th
);

1088 
	`k‰ì
(
«me
);

1089  
	`ERR_PTR
(
ªt
);

1090 
	}
}

1092 
	$gë_deÁu…_subvﬁ_obje˘id
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 *
obje˘id
)

1094 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
åì_roŸ
;

1095 
båfs_dú_ôem
 *
di
;

1096 
båfs_∑th
 *
∑th
;

1097 
båfs_key
 
loˇti⁄
;

1098 
fs¸y±_°r
 
«me
 = 
	`FSTR_INIT
("default", 7);

1099 
u64
 
dú_id
;

1101 
∑th
 = 
	`båfs_Æloc_∑th
();

1102 i‡(!
∑th
)

1103  -
ENOMEM
;

1110 
dú_id
 = 
	`båfs_su≥r_roŸ_dú
(
fs_öfo
->
su≥r_c›y
);

1111 
di
 = 
	`båfs_lookup_dú_ôem
(
NULL
, 
roŸ
, 
∑th
, 
dú_id
, &
«me
, 0);

1112 i‡(
	`IS_ERR
(
di
)) {

1113 
	`båfs_‰ì_∑th
(
∑th
);

1114  
	`PTR_ERR
(
di
);

1116 i‡(!
di
) {

1122 
	`båfs_‰ì_∑th
(
∑th
);

1123 *
obje˘id
 = 
BTRFS_FS_TREE_OBJECTID
;

1127 
	`båfs_dú_ôem_key_to_˝u
(
∑th
->
nodes
[0], 
di
, &
loˇti⁄
);

1128 
	`båfs_‰ì_∑th
(
∑th
);

1129 *
obje˘id
 = 
loˇti⁄
.objectid;

1131 
	}
}

1133 
	$båfs_fûl_su≥r
(
su≥r_block
 *
sb
,

1134 
båfs_fs_devi˚s
 *
fs_devi˚s
,

1135 *
d©a
)

1137 
öode
 *inode;

1138 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
sb
);

1139 
îr
;

1141 
sb
->
s_maxbyãs
 = 
MAX_LFS_FILESIZE
;

1142 
sb
->
s_magic
 = 
BTRFS_SUPER_MAGIC
;

1143 
sb
->
s_›
 = &
båfs_su≥r_›s
;

1144 
sb
->
s_d_›
 = &
båfs_díåy_›î©i⁄s
;

1145 
sb
->
s_exp‹t_›
 = &
båfs_exp‹t_›s
;

1146 #ifde‡
CONFIG_FS_VERITY


1147 
sb
->
s_v›
 = &
båfs_vîôy›s
;

1149 
sb
->
s_x©å
 = 
båfs_x©å_h™dÀrs
;

1150 
sb
->
s_time_gøn
 = 1;

1151 #ifde‡
CONFIG_BTRFS_FS_POSIX_ACL


1152 
sb
->
s_Êags
 |
SB_POSIXACL
;

1154 
sb
->
s_Êags
 |
SB_I_VERSION
;

1155 
sb
->
s_iÊags
 |
SB_I_CGROUPWB
;

1157 
îr
 = 
	`su≥r_£tup_bdi
(
sb
);

1158 i‡(
îr
) {

1159 
	`båfs_îr
(
fs_öfo
, "super_setup_bdi failed");

1160  
îr
;

1163 
îr
 = 
	`›í_˘ªe
(
sb
, 
fs_devi˚s
, (*)
d©a
);

1164 i‡(
îr
) {

1165 
	`båfs_îr
(
fs_öfo
, "open_ctree failed");

1166  
îr
;

1169 
öode
 = 
	`båfs_igë
(
sb
, 
BTRFS_FIRST_FREE_OBJECTID
, 
fs_öfo
->
fs_roŸ
);

1170 i‡(
	`IS_ERR
(
öode
)) {

1171 
îr
 = 
	`PTR_ERR
(
öode
);

1172 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
îr
, 
NULL
);

1173 
Áû_˛o£
;

1176 
sb
->
s_roŸ
 = 
	`d_make_roŸ
(
öode
);

1177 i‡(!
sb
->
s_roŸ
) {

1178 
îr
 = -
ENOMEM
;

1179 
Áû_˛o£
;

1182 
sb
->
s_Êags
 |
SB_ACTIVE
;

1185 
Áû_˛o£
:

1186 
	`˛o£_˘ªe
(
fs_öfo
);

1187  
îr
;

1188 
	}
}

1191 
	$båfs_fûl_su≥r_∑πôi⁄
(
su≥r_block
 *
sb
,

1192 
båfs_fs_devi˚s
 *
fs_devi˚s
,

1193 *
d©a
, 
∑πôi⁄_‹dî
)

1195 
öode
 *inode;

1196 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
sb
);

1197 
îr
;

1199 
sb
->
s_maxbyãs
 = 
MAX_LFS_FILESIZE
;

1200 
sb
->
s_magic
 = 
BTRFS_SUPER_MAGIC
;

1201 
sb
->
s_›
 = &
båfs_su≥r_›s
;

1202 
sb
->
s_d_›
 = &
båfs_díåy_›î©i⁄s
;

1203 
sb
->
s_exp‹t_›
 = &
båfs_exp‹t_›s
;

1204 #ifde‡
CONFIG_FS_VERITY


1205 
sb
->
s_v›
 = &
båfs_vîôy›s
;

1207 
sb
->
s_x©å
 = 
båfs_x©å_h™dÀrs
;

1208 
sb
->
s_time_gøn
 = 1;

1209 #ifde‡
CONFIG_BTRFS_FS_POSIX_ACL


1210 
sb
->
s_Êags
 |
SB_POSIXACL
;

1212 
sb
->
s_Êags
 |
SB_I_VERSION
;

1213 
sb
->
s_iÊags
 |
SB_I_CGROUPWB
;

1215 
îr
 = 
	`su≥r_£tup_bdi
(
sb
);

1216 
backög_dev_öfo
 *
bdi
 = 
sb
->
s_bdi
;

1224 i‡(
îr
) {

1225 
	`båfs_îr
(
fs_öfo
, "super_setup_bdi failed");

1226  
îr
;

1229 
îr
 = 
	`›í_˘ªe_∑πôi⁄
(
sb
, 
fs_devi˚s
, (*)
d©a
, 
∑πôi⁄_‹dî
);

1230 i‡(
îr
) {

1231 
	`båfs_îr
(
fs_öfo
, "open_ctree failed");

1232  
îr
;

1235 
öode
 = 
	`båfs_igë
(
sb
, 
BTRFS_FIRST_FREE_OBJECTID
, 
fs_öfo
->
fs_roŸ
);

1236 i‡(
	`IS_ERR
(
öode
)) {

1237 
îr
 = 
	`PTR_ERR
(
öode
);

1238 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
îr
, 
NULL
);

1239 
Áû_˛o£
;

1242 
sb
->
s_roŸ
 = 
	`d_make_roŸ
(
öode
);

1243 i‡(!
sb
->
s_roŸ
) {

1244 
îr
 = -
ENOMEM
;

1245 
Áû_˛o£
;

1248 
sb
->
s_Êags
 |
SB_ACTIVE
;

1251 
Áû_˛o£
:

1252 
	`˛o£_˘ªe
(
fs_öfo
);

1253  
îr
;

1254 
	}
}

1256 
	$båfs_sync_fs
(
su≥r_block
 *
sb
, 
waô
)

1258 
båfs_å™s_h™dÀ
 *
å™s
;

1259 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
sb
);

1260 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
åì_roŸ
;

1262 
	`åa˚_båfs_sync_fs
(
fs_öfo
, 
waô
);

1264 i‡(!
waô
) {

1265 
	`fûem≠_Êush
(
fs_öfo
->
båì_öode
->
i_m≠pög
);

1269 
	`båfs_waô_‹dîed_roŸs
(
fs_öfo
, 
U64_MAX
, 0, (
u64
)-1);

1271 
å™s
 = 
	`båfs_©èch_å™ß˘i⁄_b¨rõr
(
roŸ
);

1272 i‡(
	`IS_ERR
(
å™s
)) {

1274 i‡(
	`PTR_ERR
(
å™s
Ë=-
ENOENT
) {

1279 i‡(!
	`ã°_bô
(
BTRFS_FS_NEED_TRANS_COMMIT
,

1280 &
fs_öfo
->
Êags
))

1288 i‡(
	`sb_°¨t_wrôe_åylock
(
sb
))

1289 
	`sb_íd_wrôe
(
sb
);

1292 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

1294 i‡(
	`IS_ERR
(
å™s
))

1295  
	`PTR_ERR
(
å™s
);

1297  
	`båfs_commô_å™ß˘i⁄
(
å™s
);

1298 
	}
}

1300 
	$¥öt_ªscue_›ti⁄
(
£q_fûe
 *
£q
, c⁄° *
s
, 
boﬁ
 *
¥öãd
)

1302 
	`£q_¥ötf
(
£q
, "%s%s", (*
¥öãd
Ë? ":" : ",ªscue=", 
s
);

1303 *
¥öãd
 = 
åue
;

1304 
	}
}

1306 
	$båfs_show_›ti⁄s
(
£q_fûe
 *
£q
, 
díåy
 *dentry)

1308 
båfs_fs_öfo
 *
öfo
 = 
	`båfs_sb
(
díåy
->
d_sb
);

1309 c⁄° *
com¥ess_ty≥
;

1310 c⁄° *
subvﬁ_«me
;

1311 
boﬁ
 
¥öãd
 = 
Ál£
;

1313 i‡(
	`båfs_ã°_›t
(
öfo
, 
DEGRADED
))

1314 
	`£q_puts
(
£q
, ",degraded");

1315 i‡(
	`båfs_ã°_›t
(
öfo
, 
NODATASUM
))

1316 
	`£q_puts
(
£q
, ",nodatasum");

1317 i‡(
	`båfs_ã°_›t
(
öfo
, 
NODATACOW
))

1318 
	`£q_puts
(
£q
, ",nodatacow");

1319 i‡(
	`båfs_ã°_›t
(
öfo
, 
NOBARRIER
))

1320 
	`£q_puts
(
£q
, ",nobarrier");

1321 i‡(
öfo
->
max_ölöe
 !
BTRFS_DEFAULT_MAX_INLINE
)

1322 
	`£q_¥ötf
(
£q
, ",max_ölöe=%Œu", 
öfo
->
max_ölöe
);

1323 i‡(
öfo
->
thªad_poﬁ_size
 !
	`mö_t
(,

1324 
	`num_⁄löe_˝us
() + 2, 8))

1325 
	`£q_¥ötf
(
£q
, ",thªad_poﬁ=%u", 
öfo
->
thªad_poﬁ_size
);

1326 i‡(
	`båfs_ã°_›t
(
öfo
, 
COMPRESS
)) {

1327 
com¥ess_ty≥
 = 
	`båfs_com¥ess_ty≥2°r
(
öfo
->compress_type);

1328 i‡(
	`båfs_ã°_›t
(
öfo
, 
FORCE_COMPRESS
))

1329 
	`£q_¥ötf
(
£q
, ",com¥ess-f‹˚=%s", 
com¥ess_ty≥
);

1331 
	`£q_¥ötf
(
£q
, ",com¥ess=%s", 
com¥ess_ty≥
);

1332 i‡(
öfo
->
com¥ess_Àvñ
)

1333 
	`£q_¥ötf
(
£q
, ":%d", 
öfo
->
com¥ess_Àvñ
);

1335 i‡(
	`båfs_ã°_›t
(
öfo
, 
NOSSD
))

1336 
	`£q_puts
(
£q
, ",nossd");

1337 i‡(
	`båfs_ã°_›t
(
öfo
, 
SSD_SPREAD
))

1338 
	`£q_puts
(
£q
, ",ssd_spread");

1339 i‡(
	`båfs_ã°_›t
(
öfo
, 
SSD
))

1340 
	`£q_puts
(
£q
, ",ssd");

1341 i‡(
	`båfs_ã°_›t
(
öfo
, 
NOTREELOG
))

1342 
	`£q_puts
(
£q
, ",notreelog");

1343 i‡(
	`båfs_ã°_›t
(
öfo
, 
NOLOGREPLAY
))

1344 
	`¥öt_ªscue_›ti⁄
(
£q
, "nﬁogª∂ay", &
¥öãd
);

1345 i‡(
	`båfs_ã°_›t
(
öfo
, 
USEBACKUPROOT
))

1346 
	`¥öt_ªscue_›ti⁄
(
£q
, "u£backu¥oŸ", &
¥öãd
);

1347 i‡(
	`båfs_ã°_›t
(
öfo
, 
IGNOREBADROOTS
))

1348 
	`¥öt_ªscue_›ti⁄
(
£q
, "ign‹ebadroŸs", &
¥öãd
);

1349 i‡(
	`båfs_ã°_›t
(
öfo
, 
IGNOREDATACSUMS
))

1350 
	`¥öt_ªscue_›ti⁄
(
£q
, "ign‹ed©acsums", &
¥öãd
);

1351 i‡(
	`båfs_ã°_›t
(
öfo
, 
FLUSHONCOMMIT
))

1352 
	`£q_puts
(
£q
, ",flushoncommit");

1353 i‡(
	`båfs_ã°_›t
(
öfo
, 
DISCARD_SYNC
))

1354 
	`£q_puts
(
£q
, ",discard");

1355 i‡(
	`båfs_ã°_›t
(
öfo
, 
DISCARD_ASYNC
))

1356 
	`£q_puts
(
£q
, ",discard=async");

1357 i‡(!(
öfo
->
sb
->
s_Êags
 & 
SB_POSIXACL
))

1358 
	`£q_puts
(
£q
, ",noacl");

1359 i‡(
	`båfs_‰ì_•a˚_ˇche_v1_a˘ive
(
öfo
))

1360 
	`£q_puts
(
£q
, ",space_cache");

1361 i‡(
	`båfs_fs_com∑t_ro
(
öfo
, 
FREE_SPACE_TREE
))

1362 
	`£q_puts
(
£q
, ",space_cache=v2");

1364 
	`£q_puts
(
£q
, ",nospace_cache");

1365 i‡(
	`båfs_ã°_›t
(
öfo
, 
RESCAN_UUID_TREE
))

1366 
	`£q_puts
(
£q
, ",rescan_uuid_tree");

1367 i‡(
	`båfs_ã°_›t
(
öfo
, 
CLEAR_CACHE
))

1368 
	`£q_puts
(
£q
, ",clear_cache");

1369 i‡(
	`båfs_ã°_›t
(
öfo
, 
USER_SUBVOL_RM_ALLOWED
))

1370 
	`£q_puts
(
£q
, ",user_subvol_rm_allowed");

1371 i‡(
	`båfs_ã°_›t
(
öfo
, 
ENOSPC_DEBUG
))

1372 
	`£q_puts
(
£q
, ",enospc_debug");

1373 i‡(
	`båfs_ã°_›t
(
öfo
, 
AUTO_DEFRAG
))

1374 
	`£q_puts
(
£q
, ",autodefrag");

1375 i‡(
	`båfs_ã°_›t
(
öfo
, 
SKIP_BALANCE
))

1376 
	`£q_puts
(
£q
, ",skip_balance");

1377 #ifde‡
CONFIG_BTRFS_FS_CHECK_INTEGRITY


1378 i‡(
	`båfs_ã°_›t
(
öfo
, 
CHECK_INTEGRITY_DATA
))

1379 
	`£q_puts
(
£q
, ",check_int_data");

1380 i‡(
	`båfs_ã°_›t
(
öfo
, 
CHECK_INTEGRITY
))

1381 
	`£q_puts
(
£q
, ",check_int");

1382 i‡(
öfo
->
check_öãgrôy_¥öt_mask
)

1383 
	`£q_¥ötf
(
£q
, ",check_int_print_mask=%d",

1384 
öfo
->
check_öãgrôy_¥öt_mask
);

1386 i‡(
öfo
->
mëad©a_øtio
)

1387 
	`£q_¥ötf
(
£q
, ",mëad©a_øtio=%u", 
öfo
->
mëad©a_øtio
);

1388 i‡(
	`båfs_ã°_›t
(
öfo
, 
PANIC_ON_FATAL_ERROR
))

1389 
	`£q_puts
(
£q
, ",fatal_errors=panic");

1390 i‡(
öfo
->
commô_öãrvÆ
 !
BTRFS_DEFAULT_COMMIT_INTERVAL
)

1391 
	`£q_¥ötf
(
£q
, ",commô=%u", 
öfo
->
commô_öãrvÆ
);

1392 #ifde‡
CONFIG_BTRFS_DEBUG


1393 i‡(
	`båfs_ã°_›t
(
öfo
, 
FRAGMENT_DATA
))

1394 
	`£q_puts
(
£q
, ",fragment=data");

1395 i‡(
	`båfs_ã°_›t
(
öfo
, 
FRAGMENT_METADATA
))

1396 
	`£q_puts
(
£q
, ",fragment=metadata");

1398 i‡(
	`båfs_ã°_›t
(
öfo
, 
REF_VERIFY
))

1399 
	`£q_puts
(
£q
, ",ref_verify");

1400 
	`£q_¥ötf
(
£q
, ",subvolid=%llu",

1401 
	`BTRFS_I
(
	`d_öode
(
díåy
))->
roŸ
->
roŸ_key
.
obje˘id
);

1402 
subvﬁ_«me
 = 
	`båfs_gë_subvﬁ_«me_‰om_obje˘id
(
öfo
,

1403 
	`BTRFS_I
(
	`d_öode
(
díåy
))->
roŸ
->
roŸ_key
.
obje˘id
);

1404 i‡(!
	`IS_ERR
(
subvﬁ_«me
)) {

1405 
	`£q_puts
(
£q
, ",subvol=");

1406 
	`£q_esˇ≥
(
£q
, 
subvﬁ_«me
, " \t\n\\");

1407 
	`k‰ì
(
subvﬁ_«me
);

1410 
	}
}

1412 
	$båfs_ã°_su≥r
(
su≥r_block
 *
s
, *
d©a
)

1414 
båfs_fs_öfo
 *
p
 = 
d©a
;

1415 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
s
);

1417  
fs_öfo
->
fs_devi˚s
 =
p
->fs_devices;

1418 
	}
}

1420 
	$båfs_£t_su≥r
(
su≥r_block
 *
s
, *
d©a
)

1422 
îr
 = 
	`£t_™⁄_su≥r
(
s
, 
d©a
);

1423 i‡(!
îr
)

1424 
s
->
s_fs_öfo
 = 
d©a
;

1425  
îr
;

1426 
	}
}

1431 
ölöe
 
	$is_subvﬁume_öode
(
öode
 *inode)

1433 i‡(
öode
 && inode->
i_öo
 =
BTRFS_FIRST_FREE_OBJECTID
)

1436 
	}
}

1438 
díåy
 *
	$mou¡_subvﬁ
(c⁄° *
subvﬁ_«me
, 
u64
 
subvﬁ_obje˘id
,

1439 
vfsmou¡
 *
m¡
)

1441 
díåy
 *
roŸ
;

1442 
ªt
;

1444 i‡(!
subvﬁ_«me
) {

1445 i‡(!
subvﬁ_obje˘id
) {

1446 
ªt
 = 
	`gë_deÁu…_subvﬁ_obje˘id
(
	`båfs_sb
(
m¡
->
m¡_sb
),

1447 &
subvﬁ_obje˘id
);

1448 i‡(
ªt
) {

1449 
roŸ
 = 
	`ERR_PTR
(
ªt
);

1450 
out
;

1453 
subvﬁ_«me
 = 
	`båfs_gë_subvﬁ_«me_‰om_obje˘id
(

1454 
	`båfs_sb
(
m¡
->
m¡_sb
), 
subvﬁ_obje˘id
);

1455 i‡(
	`IS_ERR
(
subvﬁ_«me
)) {

1456 
roŸ
 = 
	`ERR_CAST
(
subvﬁ_«me
);

1457 
subvﬁ_«me
 = 
NULL
;

1458 
out
;

1463 
roŸ
 = 
	`mou¡_subåì
(
m¡
, 
subvﬁ_«me
);

1465 
m¡
 = 
NULL
;

1467 i‡(!
	`IS_ERR
(
roŸ
)) {

1468 
su≥r_block
 *
s
 = 
roŸ
->
d_sb
;

1469 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
s
);

1470 
öode
 *
roŸ_öode
 = 
	`d_öode
(
roŸ
);

1471 
u64
 
roŸ_obje˘id
 = 
	`BTRFS_I
(
roŸ_öode
)->
roŸ
->
roŸ_key
.
obje˘id
;

1473 
ªt
 = 0;

1474 i‡(!
	`is_subvﬁume_öode
(
roŸ_öode
)) {

1475 
	`båfs_îr
(
fs_öfo
, "'%s' isÇotá valid subvolume",

1476 
subvﬁ_«me
);

1477 
ªt
 = -
EINVAL
;

1479 i‡(
subvﬁ_obje˘id
 && 
roŸ_obje˘id
 != subvol_objectid) {

1485 
	`båfs_îr
(
fs_öfo
,

1487 
subvﬁ_«me
, 
subvﬁ_obje˘id
);

1488 
ªt
 = -
EINVAL
;

1490 i‡(
ªt
) {

1491 
	`dput
(
roŸ
);

1492 
roŸ
 = 
	`ERR_PTR
(
ªt
);

1493 
	`dó˘iv©e_locked_su≥r
(
s
);

1497 
out
:

1498 
	`m¡put
(
m¡
);

1499 
	`k‰ì
(
subvﬁ_«me
);

1500  
roŸ
;

1501 
	}
}

1503 
båfs_fs_öfo
 *
	gglobÆ_fs_öfo_li°
[
BTRFS_SUPER_INFO_COUNT
];

1511 
díåy
 *
	$båfs_mou¡_roŸ
(
fûe_sy°em_ty≥
 *
fs_ty≥
,

1512 
Êags
, c⁄° *
devi˚_«me
, *
d©a
)

1515 
block_devi˚
 *
bdev
 = 
NULL
;

1516 
su≥r_block
 *
s
;

1517 
båfs_devi˚
 *
devi˚
 = 
NULL
;

1518 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
NULL
;

1519 
båfs_fs_öfo
 *
fs_öfo
 = 
NULL
;

1521 *
√w_£c_›ts
 = 
NULL
;

1522 
blk_mode_t
 
mode
 = 
	`sb_›í_mode
(
Êags
);

1523 
îr‹
 = 0;

1525 i‡(
d©a
) {

1526 
îr‹
 = 
	`£curôy_sb_ót_lsm_›ts
(
d©a
, &
√w_£c_›ts
);

1527 i‡(
îr‹
)

1528  
	`ERR_PTR
(
îr‹
);

1533 
∑πôi⁄_‹dî
 = 
BTRFS_SUPER_INFO_COUNT
-1;Öartition_order >= 0;Öartition_order--) {

1542 
globÆ_fs_öfo_li°
[
∑πôi⁄_‹dî
] = 
	`kvzÆloc
((
båfs_fs_öfo
), 
GFP_KERNEL
);

1543 i‡(!
globÆ_fs_öfo_li°
[
∑πôi⁄_‹dî
]) {

1544 
îr‹
 = -
ENOMEM
;

1545 
îr‹_£c_›ts
;

1547 
globÆ_fs_öfo_li°
[
∑πôi⁄_‹dî
]->
id
 =Öartition_order;

1549 
	`båfs_öô_fs_öfo
(
globÆ_fs_öfo_li°
[
∑πôi⁄_‹dî
]);

1551 
globÆ_fs_öfo_li°
[
∑πôi⁄_‹dî
]->
su≥r_c›y
 = 
	`kzÆloc
(
BTRFS_SUPER_INFO_SIZE
, 
GFP_KERNEL
);

1552 
globÆ_fs_öfo_li°
[
∑πôi⁄_‹dî
]->
su≥r_f‹_commô
 = 
	`kzÆloc
(
BTRFS_SUPER_INFO_SIZE
, 
GFP_KERNEL
);

1553 i‡(!
globÆ_fs_öfo_li°
[
∑πôi⁄_‹dî
]->
su≥r_c›y
 || !globÆ_fs_öfo_li°[∑πôi⁄_‹dî]->
su≥r_f‹_commô
) {

1554 
îr‹
 = -
ENOMEM
;

1555 
îr‹_fs_öfo
;

1558 
	`muãx_lock
(&
uuid_muãx
);

1559 
îr‹
 = 
	`båfs_∑r£_devi˚_›ti⁄s
(
d©a
, 
mode
);

1560 i‡(
îr‹
) {

1561 
	`muãx_u∆ock
(&
uuid_muãx
);

1562 
îr‹_fs_öfo
;

1565 
devi˚
 = 
	`båfs_sˇn_⁄e_devi˚_∑πôi⁄
(
devi˚_«me
, 
mode
, 
∑πôi⁄_‹dî
);

1566 i‡(
	`IS_ERR
(
devi˚
)) {

1567 
	`muãx_u∆ock
(&
uuid_muãx
);

1568 
îr‹
 = 
	`PTR_ERR
(
devi˚
);

1569 
îr‹_fs_öfo
;

1572 
fs_devi˚s
 = 
devi˚
->fs_devices;

1573 
globÆ_fs_öfo_li°
[
∑πôi⁄_‹dî
]->
fs_devi˚s
 = fs_devices;

1575 
îr‹
 = 
	`båfs_›í_devi˚s_∑πôi⁄
(
fs_devi˚s
, 
mode
, 
fs_ty≥
, 
∑πôi⁄_‹dî
);

1576 
	`muãx_u∆ock
(&
uuid_muãx
);

1577 i‡(
îr‹
)

1578 
îr‹_fs_öfo
;

1580 i‡(!(
Êags
 & 
SB_RDONLY
Ë&& 
fs_devi˚s
->
rw_devi˚s
 == 0) {

1581 
îr‹
 = -
EACCES
;

1582 
îr‹_˛o£_devi˚s
;

1585 
bdev
 = 
fs_devi˚s
->
œã°_dev
->bdev;

1586 
s
 = 
	`sgë
(
fs_ty≥
, 
båfs_ã°_su≥r
, 
båfs_£t_su≥r
, 
Êags
 | 
SB_NOSEC
,

1587 
globÆ_fs_öfo_li°
[
∑πôi⁄_‹dî
]);

1588 i‡(
	`IS_ERR
(
s
)) {

1589 
îr‹
 = 
	`PTR_ERR
(
s
);

1590 
îr‹_˛o£_devi˚s
;

1592 i‡(
s
->
s_roŸ
) {

1593 
	`båfs_˛o£_devi˚s
(
fs_devi˚s
);

1594 
	`båfs_‰ì_fs_öfo
(
globÆ_fs_öfo_li°
[
∑πôi⁄_‹dî
]);

1595 i‡((
Êags
 ^ 
s
->
s_Êags
Ë& 
SB_RDONLY
)

1596 
îr‹
 = -
EBUSY
;

1598 
	`¢¥ötf
(
s
->
s_id
, (s->s_id), "%pg", 
bdev
);

1599 
	`shrökî_debugfs_ª«me
(&
s
->
s_shrök
, "sb-%s:%s", 
fs_ty≥
->
«me
,

1600 
s
->
s_id
);

1601 
	`båfs_sb
(
s
)->
bdev_hﬁdî
 = 
fs_ty≥
;

1603 
îr‹
 = 
	`båfs_fûl_su≥r_∑πôi⁄
(
s
, 
fs_devi˚s
, 
d©a
, 
∑πôi⁄_‹dî
);

1605 i‡(!
îr‹
)

1606 
îr‹
 = 
	`£curôy_sb_£t_m¡_›ts
(
s
, 
√w_£c_›ts
, 0, 
NULL
);

1607 
	`£curôy_‰ì_m¡_›ts
(&
√w_£c_›ts
);

1608 i‡(
îr‹
) {

1609 
	`dó˘iv©e_locked_su≥r
(
s
);

1610  
	`ERR_PTR
(
îr‹
);

1615  
	`dgë
(
s
->
s_roŸ
);

1617 
îr‹_˛o£_devi˚s
:

1618 
	`båfs_˛o£_devi˚s
(
fs_devi˚s
);

1619 
îr‹_fs_öfo
:

1620 
	`båfs_‰ì_fs_öfo
(
fs_öfo
);

1621 
îr‹_£c_›ts
:

1622 
	`£curôy_‰ì_m¡_›ts
(&
√w_£c_›ts
);

1623  
	`ERR_PTR
(
îr‹
);

1624 
	}
}

1648 
díåy
 *
	$båfs_mou¡
(
fûe_sy°em_ty≥
 *
fs_ty≥
, 
Êags
,

1649 c⁄° *
devi˚_«me
, *
d©a
)

1651 
vfsmou¡
 *
m¡_roŸ
;

1652 
díåy
 *
roŸ
;

1653 *
subvﬁ_«me
 = 
NULL
;

1654 
u64
 
subvﬁ_obje˘id
 = 0;

1655 
îr‹
 = 0;

1657 
îr‹
 = 
	`båfs_∑r£_subvﬁ_›ti⁄s
(
d©a
, &
subvﬁ_«me
,

1658 &
subvﬁ_obje˘id
);

1659 i‡(
îr‹
) {

1660 
	`k‰ì
(
subvﬁ_«me
);

1661  
	`ERR_PTR
(
îr‹
);

1665 
m¡_roŸ
 = 
	`vfs_kîn_mou¡
(&
båfs_roŸ_fs_ty≥
, 
Êags
, 
devi˚_«me
, 
d©a
);

1666 i‡(
	`PTR_ERR_OR_ZERO
(
m¡_roŸ
Ë=-
EBUSY
) {

1667 i‡(
Êags
 & 
SB_RDONLY
) {

1668 
m¡_roŸ
 = 
	`vfs_kîn_mou¡
(&
båfs_roŸ_fs_ty≥
,

1669 
Êags
 & ~
SB_RDONLY
, 
devi˚_«me
, 
d©a
);

1671 
m¡_roŸ
 = 
	`vfs_kîn_mou¡
(&
båfs_roŸ_fs_ty≥
,

1672 
Êags
 | 
SB_RDONLY
, 
devi˚_«me
, 
d©a
);

1673 i‡(
	`IS_ERR
(
m¡_roŸ
)) {

1674 
roŸ
 = 
	`ERR_CAST
(
m¡_roŸ
);

1675 
	`k‰ì
(
subvﬁ_«me
);

1676 
out
;

1679 
	`down_wrôe
(&
m¡_roŸ
->
m¡_sb
->
s_umou¡
);

1680 
îr‹
 = 
	`båfs_ªmou¡
(
m¡_roŸ
->
m¡_sb
, &
Êags
, 
NULL
);

1681 
	`up_wrôe
(&
m¡_roŸ
->
m¡_sb
->
s_umou¡
);

1682 i‡(
îr‹
 < 0) {

1683 
roŸ
 = 
	`ERR_PTR
(
îr‹
);

1684 
	`m¡put
(
m¡_roŸ
);

1685 
	`k‰ì
(
subvﬁ_«me
);

1686 
out
;

1690 i‡(
	`IS_ERR
(
m¡_roŸ
)) {

1691 
roŸ
 = 
	`ERR_CAST
(
m¡_roŸ
);

1692 
	`k‰ì
(
subvﬁ_«me
);

1693 
out
;

1697 
roŸ
 = 
	`mou¡_subvﬁ
(
subvﬁ_«me
, 
subvﬁ_obje˘id
, 
m¡_roŸ
);

1699 
out
:

1700  
roŸ
;

1701 
	}
}

1703 
	$båfs_ªsize_thªad_poﬁ
(
båfs_fs_öfo
 *
fs_öfo
,

1704 
u32
 
√w_poﬁ_size
, u32 
ﬁd_poﬁ_size
)

1706 i‡(
√w_poﬁ_size
 =
ﬁd_poﬁ_size
)

1709 
fs_öfo
->
thªad_poﬁ_size
 = 
√w_poﬁ_size
;

1711 
	`båfs_öfo
(
fs_öfo
, "resizeÅhreadÖool %d -> %d",

1712 
ﬁd_poﬁ_size
, 
√w_poﬁ_size
);

1714 
	`båfs_w‹kqueue_£t_max
(
fs_öfo
->
w‹kîs
, 
√w_poﬁ_size
);

1715 
	`båfs_w‹kqueue_£t_max
(
fs_öfo
->
dñÆloc_w‹kîs
, 
√w_poﬁ_size
);

1716 
	`båfs_w‹kqueue_£t_max
(
fs_öfo
->
ˇchög_w‹kîs
, 
√w_poﬁ_size
);

1717 
	`w‹kqueue_£t_max_a˘ive
(
fs_öfo
->
ídio_w‹kîs
, 
√w_poﬁ_size
);

1718 
	`w‹kqueue_£t_max_a˘ive
(
fs_öfo
->
ídio_mëa_w‹kîs
, 
√w_poﬁ_size
);

1719 
	`båfs_w‹kqueue_£t_max
(
fs_öfo
->
ídio_wrôe_w‹kîs
, 
√w_poﬁ_size
);

1720 
	`båfs_w‹kqueue_£t_max
(
fs_öfo
->
ídio_‰ì•a˚_w‹kî
, 
√w_poﬁ_size
);

1721 
	`båfs_w‹kqueue_£t_max
(
fs_öfo
->
dñayed_w‹kîs
, 
√w_poﬁ_size
);

1722 
	}
}

1724 
ölöe
 
	$båfs_ªmou¡_begö
(
båfs_fs_öfo
 *
fs_öfo
,

1725 
ﬁd_›ts
, 
Êags
)

1727 i‡(
	`båfs_øw_ã°_›t
(
ﬁd_›ts
, 
AUTO_DEFRAG
) &&

1728 (!
	`båfs_øw_ã°_›t
(
fs_öfo
->
mou¡_›t
, 
AUTO_DEFRAG
) ||

1729 (
Êags
 & 
SB_RDONLY
))) {

1731 
	`waô_evít
(
fs_öfo
->
å™ß˘i⁄_waô
,

1732 (
	`©omic_ªad
(&
fs_öfo
->
de‰ag_ru¬ög
) == 0));

1733 i‡(
Êags
 & 
SB_RDONLY
)

1734 
	`sync_fûesy°em
(
fs_öfo
->
sb
);

1736 
	}
}

1738 
ölöe
 
	$båfs_ªmou¡_˛ónup
(
båfs_fs_öfo
 *
fs_öfo
,

1739 
ﬁd_›ts
)

1741 c⁄° 
boﬁ
 
ˇche_›t
 = 
	`båfs_ã°_›t
(
fs_öfo
, 
SPACE_CACHE
);

1747 i‡(
	`båfs_øw_ã°_›t
(
ﬁd_›ts
, 
AUTO_DEFRAG
) &&

1748 (!
	`båfs_øw_ã°_›t
(
fs_öfo
->
mou¡_›t
, 
AUTO_DEFRAG
Ë|| 
	`sb_rd⁄ly
(fs_öfo->
sb
))) {

1749 
	`båfs_˛ónup_de‰ag_öodes
(
fs_öfo
);

1753 i‡(!
	`båfs_øw_ã°_›t
(
ﬁd_›ts
, 
DISCARD_ASYNC
) &&

1754 
	`båfs_ã°_›t
(
fs_öfo
, 
DISCARD_ASYNC
))

1755 
	`båfs_disˇrd_ªsume
(
fs_öfo
);

1756 i‡(
	`båfs_øw_ã°_›t
(
ﬁd_›ts
, 
DISCARD_ASYNC
) &&

1757 !
	`båfs_ã°_›t
(
fs_öfo
, 
DISCARD_ASYNC
))

1758 
	`båfs_disˇrd_˛ónup
(
fs_öfo
);

1761 i‡(
ˇche_›t
 !
	`båfs_‰ì_•a˚_ˇche_v1_a˘ive
(
fs_öfo
))

1762 
	`båfs_£t_‰ì_•a˚_ˇche_v1_a˘ive
(
fs_öfo
, 
ˇche_›t
);

1763 
	}
}

1765 
	$båfs_ªmou¡
(
su≥r_block
 *
sb
, *
Êags
, *
d©a
)

1767 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
sb
);

1768 
ﬁd_Êags
 = 
sb
->
s_Êags
;

1769 
ﬁd_›ts
 = 
fs_öfo
->
mou¡_›t
;

1770 
ﬁd_com¥ess_ty≥
 = 
fs_öfo
->
com¥ess_ty≥
;

1771 
u64
 
ﬁd_max_ölöe
 = 
fs_öfo
->
max_ölöe
;

1772 
u32
 
ﬁd_thªad_poﬁ_size
 = 
fs_öfo
->
thªad_poﬁ_size
;

1773 
u32
 
ﬁd_mëad©a_øtio
 = 
fs_öfo
->
mëad©a_øtio
;

1774 
ªt
;

1776 
	`sync_fûesy°em
(
sb
);

1777 
	`£t_bô
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_öfo
->
fs_°©e
);

1779 i‡(
d©a
) {

1780 *
√w_£c_›ts
 = 
NULL
;

1782 
ªt
 = 
	`£curôy_sb_ót_lsm_›ts
(
d©a
, &
√w_£c_›ts
);

1783 i‡(!
ªt
)

1784 
ªt
 = 
	`£curôy_sb_ªmou¡
(
sb
, 
√w_£c_›ts
);

1785 
	`£curôy_‰ì_m¡_›ts
(&
√w_£c_›ts
);

1786 i‡(
ªt
)

1787 
ª°‹e
;

1790 
ªt
 = 
	`båfs_∑r£_›ti⁄s
(
fs_öfo
, 
d©a
, *
Êags
);

1791 i‡(
ªt
)

1792 
ª°‹e
;

1794 
ªt
 = 
	`båfs_check_„©uªs
(
fs_öfo
, !(*
Êags
 & 
SB_RDONLY
));

1795 i‡(
ªt
 < 0)

1796 
ª°‹e
;

1798 
	`båfs_ªmou¡_begö
(
fs_öfo
, 
ﬁd_›ts
, *
Êags
);

1799 
	`båfs_ªsize_thªad_poﬁ
(
fs_öfo
,

1800 
fs_öfo
->
thªad_poﬁ_size
, 
ﬁd_thªad_poﬁ_size
);

1802 i‡((
boﬁ
)
	`båfs_ã°_›t
(
fs_öfo
, 
FREE_SPACE_TREE
) !=

1803 (
boﬁ
)
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE
) &&

1804 (!
	`sb_rd⁄ly
(
sb
Ë|| (*
Êags
 & 
SB_RDONLY
))) {

1805 
	`båfs_w¨n
(
fs_öfo
,

1808 i‡(
	`båfs_fs_com∑t_ro
(
fs_öfo
, 
FREE_SPACE_TREE
)) {

1809 
	`båfs_£t_›t
(
fs_öfo
->
mou¡_›t
, 
FREE_SPACE_TREE
);

1810 
	`båfs_˛ór_›t
(
fs_öfo
->
mou¡_›t
, 
SPACE_CACHE
);

1812 i‡(
	`båfs_‰ì_•a˚_ˇche_v1_a˘ive
(
fs_öfo
)) {

1813 
	`båfs_˛ór_›t
(
fs_öfo
->
mou¡_›t
, 
FREE_SPACE_TREE
);

1814 
	`båfs_£t_›t
(
fs_öfo
->
mou¡_›t
, 
SPACE_CACHE
);

1818 i‡((
boﬁ
)(*
Êags
 & 
SB_RDONLY
Ë=
	`sb_rd⁄ly
(
sb
))

1819 
out
;

1821 i‡(*
Êags
 & 
SB_RDONLY
) {

1826 
	`ˇn˚l_w‹k_sync
(&
fs_öfo
->
async_ª˛aim_w‹k
);

1827 
	`ˇn˚l_w‹k_sync
(&
fs_öfo
->
async_d©a_ª˛aim_w‹k
);

1829 
	`båfs_disˇrd_˛ónup
(
fs_öfo
);

1832 
	`down
(&
fs_öfo
->
uuid_åì_ªsˇn_£m
);

1834 
	`up
(&
fs_öfo
->
uuid_åì_ªsˇn_£m
);

1836 
	`båfs_£t_sb_rd⁄ly
(
sb
);

1845 
	`båfs_dñëe_unu£d_bgs
(
fs_öfo
);

1858 
	`waô_⁄_bô
(&
fs_öfo
->
Êags
, 
BTRFS_FS_CLEANER_RUNNING
,

1859 
TASK_UNINTERRUPTIBLE
);

1869 
	`båfs_run_dñayed_ùuts
(
fs_öfo
);

1871 
	`båfs_dev_ª∂a˚_su•íd_f‹_unmou¡
(
fs_öfo
);

1872 
	`båfs_s¸ub_ˇn˚l
(
fs_öfo
);

1873 
	`båfs_∑u£_bÆ™˚
(
fs_öfo
);

1881 
	`båfs_qgroup_waô_f‹_com∂ëi⁄
(
fs_öfo
, 
Ál£
);

1883 
ªt
 = 
	`båfs_commô_su≥r
(
fs_öfo
);

1884 i‡(
ªt
)

1885 
ª°‹e
;

1887 i‡(
	`BTRFS_FS_ERROR
(
fs_öfo
)) {

1888 
	`båfs_îr
(
fs_öfo
,

1890 
ªt
 = -
EINVAL
;

1891 
ª°‹e
;

1893 i‡(
fs_öfo
->
fs_devi˚s
->
rw_devi˚s
 == 0) {

1894 
ªt
 = -
EACCES
;

1895 
ª°‹e
;

1898 i‡(!
	`båfs_check_rw_degødabÀ
(
fs_öfo
, 
NULL
)) {

1899 
	`båfs_w¨n
(
fs_öfo
,

1901 
ªt
 = -
EACCES
;

1902 
ª°‹e
;

1905 i‡(
	`båfs_su≥r_log_roŸ
(
fs_öfo
->
su≥r_c›y
) != 0) {

1906 
	`båfs_w¨n
(
fs_öfo
,

1908 
ªt
 = -
EINVAL
;

1909 
ª°‹e
;

1917 
ªt
 = 
	`båfs_°¨t_¥e_rw_mou¡
(
fs_öfo
);

1918 i‡(
ªt
)

1919 
ª°‹e
;

1921 
	`båfs_˛ór_sb_rd⁄ly
(
sb
);

1923 
	`£t_bô
(
BTRFS_FS_OPEN
, &
fs_öfo
->
Êags
);

1929 
	`båfs_disˇrd_ªsume
(
fs_öfo
);

1931 
out
:

1936 *
Êags
 |
SB_I_VERSION
;

1938 
	`wake_up_¥o˚ss
(
fs_öfo
->
å™ß˘i⁄_kthªad
);

1939 
	`båfs_ªmou¡_˛ónup
(
fs_öfo
, 
ﬁd_›ts
);

1940 
	`båfs_˛ór_⁄eshŸ_›ti⁄s
(
fs_öfo
);

1941 
	`˛ór_bô
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_öfo
->
fs_°©e
);

1945 
ª°‹e
:

1947 i‡(
	`sb_rd⁄ly
(
sb
))

1948 
ﬁd_Êags
 |
SB_RDONLY
;

1949 i‡(!(
ﬁd_Êags
 & 
SB_RDONLY
))

1950 
	`˛ór_bô
(
BTRFS_FS_STATE_RO
, &
fs_öfo
->
fs_°©e
);

1951 
sb
->
s_Êags
 = 
ﬁd_Êags
;

1952 
fs_öfo
->
mou¡_›t
 = 
ﬁd_›ts
;

1953 
fs_öfo
->
com¥ess_ty≥
 = 
ﬁd_com¥ess_ty≥
;

1954 
fs_öfo
->
max_ölöe
 = 
ﬁd_max_ölöe
;

1955 
	`båfs_ªsize_thªad_poﬁ
(
fs_öfo
,

1956 
ﬁd_thªad_poﬁ_size
, 
fs_öfo
->
thªad_poﬁ_size
);

1957 
fs_öfo
->
mëad©a_øtio
 = 
ﬁd_mëad©a_øtio
;

1958 
	`båfs_ªmou¡_˛ónup
(
fs_öfo
, 
ﬁd_›ts
);

1959 
	`˛ór_bô
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_öfo
->
fs_°©e
);

1961  
ªt
;

1962 
	}
}

1965 
	$båfs_cmp_devi˚_‰ì_byãs
(c⁄° *
a
, c⁄° *
b
)

1967 c⁄° 
båfs_devi˚_öfo
 *
dev_öfo1
 = 
a
;

1968 c⁄° 
båfs_devi˚_öfo
 *
dev_öfo2
 = 
b
;

1970 i‡(
dev_öfo1
->
max_avaû
 > 
dev_öfo2
->max_avail)

1972 i‡(
dev_öfo1
->
max_avaû
 < 
dev_öfo2
->max_avail)

1975 
	}
}

1981 
ölöe
 
	$båfs_des˚ndög_s‹t_devi˚s
(

1982 
båfs_devi˚_öfo
 *
devi˚s
,

1983 
size_t
 
ƒ_devi˚s
)

1985 
	`s‹t
(
devi˚s
, 
ƒ_devi˚s
, (
båfs_devi˚_öfo
),

1986 
båfs_cmp_devi˚_‰ì_byãs
, 
NULL
);

1987 
	}
}

1993 
ölöe
 
	$båfs_ˇlc_avaû_d©a_•a˚
(
båfs_fs_öfo
 *
fs_öfo
,

1994 
u64
 *
‰ì_byãs
)

1996 
båfs_devi˚_öfo
 *
devi˚s_öfo
;

1997 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

1998 
båfs_devi˚
 *
devi˚
;

1999 
u64
 
ty≥
;

2000 
u64
 
avaû_•a˚
;

2001 
u64
 
mö_°rùe_size
;

2002 
num_°rùes
 = 1;

2003 
i
 = 0, 
ƒ_devi˚s
;

2004 c⁄° 
båfs_øid_©å
 *
øâr
;

2010 
ƒ_devi˚s
 = 
fs_öfo
->
fs_devi˚s
->
›í_devi˚s
;

2011 i‡(!
ƒ_devi˚s
) {

2012 
	`smp_mb
();

2013 
ƒ_devi˚s
 = 
fs_öfo
->
fs_devi˚s
->
›í_devi˚s
;

2014 
	`ASSERT
(
ƒ_devi˚s
);

2015 i‡(!
ƒ_devi˚s
) {

2016 *
‰ì_byãs
 = 0;

2021 
devi˚s_öfo
 = 
	`kmÆloc_¨øy
(
ƒ_devi˚s
, (*devices_info),

2022 
GFP_KERNEL
);

2023 i‡(!
devi˚s_öfo
)

2024  -
ENOMEM
;

2027 
ty≥
 = 
	`båfs_d©a_Æloc_¥ofûe
(
fs_öfo
);

2028 
øâr
 = &
båfs_øid_¨øy
[
	`båfs_bg_Êags_to_øid_ödex
(
ty≥
)];

2030 i‡(
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID0
)

2031 
num_°rùes
 = 
ƒ_devi˚s
;

2032 i‡(
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID1_MASK
)

2033 
num_°rùes
 = 
øâr
->
nc›õs
;

2034 i‡(
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID10
)

2035 
num_°rùes
 = 4;

2038 
mö_°rùe_size
 = 
øâr
->
dev_°rùes
 * 
BTRFS_STRIPE_LEN
;

2040 
	`rcu_ªad_lock
();

2041 
	`li°_f‹_óch_íåy_rcu
(
devi˚
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

2042 i‡(!
	`ã°_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
,

2043 &
devi˚
->
dev_°©e
) ||

2044 !
devi˚
->
bdev
 ||

2045 
	`ã°_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
))

2048 i‡(
i
 >
ƒ_devi˚s
)

2051 
avaû_•a˚
 = 
devi˚
->
tŸÆ_byãs
 - devi˚->
byãs_u£d
;

2054 
avaû_•a˚
 = 
	`rounddown
◊vaû_•a˚, 
BTRFS_STRIPE_LEN
);

2060 i‡(
avaû_•a˚
 <
BTRFS_DEVICE_RANGE_RESERVED
 + 
mö_°rùe_size
)

2063 
avaû_•a˚
 -
BTRFS_DEVICE_RANGE_RESERVED
;

2065 
devi˚s_öfo
[
i
].
dev
 = 
devi˚
;

2066 
devi˚s_öfo
[
i
].
max_avaû
 = 
avaû_•a˚
;

2068 
i
++;

2070 
	`rcu_ªad_u∆ock
();

2072 
ƒ_devi˚s
 = 
i
;

2074 
	`båfs_des˚ndög_s‹t_devi˚s
(
devi˚s_öfo
, 
ƒ_devi˚s
);

2076 
i
 = 
ƒ_devi˚s
 - 1;

2077 
avaû_•a˚
 = 0;

2078 
ƒ_devi˚s
 >
øâr
->
devs_mö
) {

2079 
num_°rùes
 = 
	`mö
“um_°rùes, 
ƒ_devi˚s
);

2081 i‡(
devi˚s_öfo
[
i
].
max_avaû
 >
mö_°rùe_size
) {

2082 
j
;

2083 
u64
 
Æloc_size
;

2085 
avaû_•a˚
 +
devi˚s_öfo
[
i
].
max_avaû
 * 
num_°rùes
;

2086 
Æloc_size
 = 
devi˚s_öfo
[
i
].
max_avaû
;

2087 
j
 = 
i
 + 1 - 
num_°rùes
; j <= i; j++)

2088 
devi˚s_öfo
[
j
].
max_avaû
 -
Æloc_size
;

2090 
i
--;

2091 
ƒ_devi˚s
--;

2094 
	`k‰ì
(
devi˚s_öfo
);

2095 *
‰ì_byãs
 = 
avaû_•a˚
;

2097 
	}
}

2112 
	$båfs_°©fs
(
díåy
 *díåy, 
k°©fs
 *
buf
)

2114 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
díåy
->
d_sb
);

2115 
båfs_su≥r_block
 *
disk_su≥r
 = 
fs_öfo
->
su≥r_c›y
;

2116 
båfs_•a˚_öfo
 *
found
;

2117 
u64
 
tŸÆ_u£d
 = 0;

2118 
u64
 
tŸÆ_‰ì_d©a
 = 0;

2119 
u64
 
tŸÆ_‰ì_mëa
 = 0;

2120 
u32
 
bôs
 = 
fs_öfo
->
£˘‹size_bôs
;

2121 
__be32
 *
fsid
 = (__be32 *)
fs_öfo
->
fs_devi˚s
->fsid;

2122 
Á˘‹
 = 1;

2123 
båfs_block_rsv
 *
block_rsv
 = &
fs_öfo
->
globÆ_block_rsv
;

2124 
ªt
;

2125 
u64
 
thªsh
 = 0;

2126 
mixed
 = 0;

2128 
	`li°_f‹_óch_íåy
(
found
, &
fs_öfo
->
•a˚_öfo
, 
li°
) {

2129 i‡(
found
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
) {

2130 
i
;

2132 
tŸÆ_‰ì_d©a
 +
found
->
disk_tŸÆ
 - found->
disk_u£d
;

2133 
tŸÆ_‰ì_d©a
 -=

2134 
	`båfs_accou¡_ro_block_groups_‰ì_•a˚
(
found
);

2136 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; i++) {

2137 i‡(!
	`li°_em±y
(&
found
->
block_groups
[
i
]))

2138 
Á˘‹
 = 
	`båfs_bg_ty≥_to_Á˘‹
(

2139 
båfs_øid_¨øy
[
i
].
bg_Êag
);

2146 i‡(!
mixed
 && 
found
->
Êags
 & 
BTRFS_BLOCK_GROUP_METADATA
) {

2147 i‡(
found
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
)

2148 
mixed
 = 1;

2150 
tŸÆ_‰ì_mëa
 +
found
->
disk_tŸÆ
 -

2151 
found
->
disk_u£d
;

2154 
tŸÆ_u£d
 +
found
->
disk_u£d
;

2157 
buf
->
f_blocks
 = 
	`div_u64
(
	`båfs_su≥r_tŸÆ_byãs
(
disk_su≥r
), 
Á˘‹
);

2158 
buf
->
f_blocks
 >>
bôs
;

2159 
buf
->
f_b‰ì
 = buf->
f_blocks
 - (
	`div_u64
(
tŸÆ_u£d
, 
Á˘‹
Ë>> 
bôs
);

2162 
	`•ö_lock
(&
block_rsv
->
lock
);

2164 i‡(
buf
->
f_b‰ì
 >
block_rsv
->
size
 >> 
bôs
)

2165 
buf
->
f_b‰ì
 -
block_rsv
->
size
 >> 
bôs
;

2167 
buf
->
f_b‰ì
 = 0;

2168 
	`•ö_u∆ock
(&
block_rsv
->
lock
);

2170 
buf
->
f_bavaû
 = 
	`div_u64
(
tŸÆ_‰ì_d©a
, 
Á˘‹
);

2171 
ªt
 = 
	`båfs_ˇlc_avaû_d©a_•a˚
(
fs_öfo
, &
tŸÆ_‰ì_d©a
);

2172 i‡(
ªt
)

2173  
ªt
;

2174 
buf
->
f_bavaû
 +
	`div_u64
(
tŸÆ_‰ì_d©a
, 
Á˘‹
);

2175 
buf
->
f_bavaû
 = buf->f_bavaû >> 
bôs
;

2190 
thªsh
 = 
SZ_4M
;

2199 i‡(!
mixed
 && 
block_rsv
->
•a˚_öfo
->
fuŒ
 &&

2200 (
tŸÆ_‰ì_mëa
 < 
thªsh
 ||ÅŸÆ_‰ì_më®-Åhªsh < 
block_rsv
->
size
))

2201 
buf
->
f_bavaû
 = 0;

2203 
buf
->
f_ty≥
 = 
BTRFS_SUPER_MAGIC
;

2204 
buf
->
f_bsize
 = 
díåy
->
d_sb
->
s_blocksize
;

2205 
buf
->
f_«mñí
 = 
BTRFS_NAME_LEN
;

2210 
buf
->
f_fsid
.
vÆ
[0] = 
	`be32_to_˝u
(
fsid
[0]) ^ be32_to_cpu(fsid[2]);

2211 
buf
->
f_fsid
.
vÆ
[1] = 
	`be32_to_˝u
(
fsid
[1]) ^ be32_to_cpu(fsid[3]);

2213 
buf
->
f_fsid
.
vÆ
[0] ^=

2214 
	`BTRFS_I
(
	`d_öode
(
díåy
))->
roŸ
->
roŸ_key
.
obje˘id
 >> 32;

2215 
buf
->
f_fsid
.
vÆ
[1] ^=

2216 
	`BTRFS_I
(
	`d_öode
(
díåy
))->
roŸ
->
roŸ_key
.
obje˘id
;

2219 
	}
}

2221 
kûl_su≥r_nŸify
(
su≥r_block
 *
sb
);

2222 
put_su≥r
(
su≥r_block
 *
sb
);

2223 
	$båfs_put_fûesy°em
(
fûe_sy°em_ty≥
 *
fs
)

2225 
	`moduÀ_put
(
fs
->
ow√r
);

2226 
	}
}

2228 
	$båfs_dó˘iv©e_locked_su≥r
(
su≥r_block
 *
s
)

2230 
fûe_sy°em_ty≥
 *
fs
 = 
s
->
s_ty≥
;

2231 i‡(
	`©omic_dec_™d_ã°
(&
s
->
s_a˘ive
)) {

2232 
	`uƒegi°î_shrökî
(&
s
->
s_shrök
);

2233 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
s
);

2234 
	`kûl_™⁄_su≥r
(
s
);

2235 
	`kûl_su≥r_nŸify
(
s
);

2242 
	`li°_Ãu_de°roy
(&
s
->
s_díåy_Ãu
);

2243 
	`li°_Ãu_de°roy
(&
s
->
s_öode_Ãu
);

2245 
	`båfs_put_fûesy°em
(
fs
);

2246 
	`put_su≥r
(
s
);

2248 
	`up_wrôe
(&
s
->
s_umou¡
);

2250 
	}
}

2252 
	$båfs_umou¡_mu…ùÀ
(
cur_∑πôi⁄_id
)

2254 
∑πôi⁄_‹dî
 = 
BTRFS_SUPER_INFO_COUNT
-1;

2255 
∑πôi⁄_‹dî
 >= 0;Öartition_order--) {

2256 
su≥r_block
 *
s
 = 
globÆ_fs_öfo_li°
[
∑πôi⁄_‹dî
]->
sb
;

2257 i‡(
cur_∑πôi⁄_id
 =
∑πôi⁄_‹dî
)

2259 
	`båfs_dó˘iv©e_locked_su≥r
(
s
);

2261 
	}
}

2263 
	$båfs_kûl_su≥r
(
su≥r_block
 *
sb
)

2265 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
sb
);

2266 
cur_∑πôi⁄_id
 = 0; cur_∑πôi⁄_id < 
BTRFS_SUPER_INFO_COUNT
; cur_partition_id++) {

2267 i‡(
sb
 =
globÆ_fs_öfo_li°
[
cur_∑πôi⁄_id
]->sb){

2268 
	`båfs_umou¡_mu…ùÀ
(
cur_∑πôi⁄_id
);

2273 
	`kûl_™⁄_su≥r
(
sb
);

2274 
	`båfs_‰ì_fs_öfo
(
fs_öfo
);

2275 
	}
}

2277 
fûe_sy°em_ty≥
 
	gbåfs_fs_ty≥
 = {

2278 .
ow√r
 = 
THIS_MODULE
,

2279 .
	g«me
 = "btrfs",

2280 .
	gmou¡
 = 
båfs_mou¡
,

2281 .
	gkûl_sb
 = 
båfs_kûl_su≥r
,

2282 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
 | 
FS_BINARY_MOUNTDATA
,

2285 
fûe_sy°em_ty≥
 
	gbåfs_roŸ_fs_ty≥
 = {

2286 .
ow√r
 = 
THIS_MODULE
,

2287 .
	g«me
 = "btrfs",

2288 .
	gmou¡
 = 
båfs_mou¡_roŸ
,

2289 .
	gkûl_sb
 = 
båfs_kûl_su≥r
,

2290 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
 | 
FS_BINARY_MOUNTDATA
 | 
FS_ALLOW_IDMAP
,

2293 
MODULE_ALIAS_FS
("btrfs");

2295 
	$båfs_c⁄åﬁ_›í
(
öode
 *öode, 
fûe
 *file)

2302 
fûe
->
¥iv©e_d©a
 = 
NULL
;

2304 
	}
}

2309 
	$båfs_c⁄åﬁ_io˘l
(
fûe
 *fûe, 
cmd
,

2310 
¨g
)

2312 
båfs_io˘l_vﬁ_¨gs
 *
vﬁ
;

2313 
båfs_devi˚
 *
devi˚
 = 
NULL
;

2314 
dev_t
 
devt
 = 0;

2315 
ªt
 = -
ENOTTY
;

2317 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

2318  -
EPERM
;

2320 
vﬁ
 = 
	`memdup_u£r
((
__u£r
 *)
¨g
, (*vol));

2321 i‡(
	`IS_ERR
(
vﬁ
))

2322  
	`PTR_ERR
(
vﬁ
);

2323 
vﬁ
->
«me
[
BTRFS_PATH_NAME_MAX
] = '\0';

2325 
cmd
) {

2326 
BTRFS_IOC_SCAN_DEV
:

2327 
	`muãx_lock
(&
uuid_muãx
);

2328 
devi˚
 = 
	`båfs_sˇn_⁄e_devi˚
(
vﬁ
->
«me
, 
BLK_OPEN_READ
);

2329 
ªt
 = 
	`PTR_ERR_OR_ZERO
(
devi˚
);

2330 
	`muãx_u∆ock
(&
uuid_muãx
);

2332 
BTRFS_IOC_FORGET_DEV
:

2333 i‡(
vﬁ
->
«me
[0] != 0) {

2334 
ªt
 = 
	`lookup_bdev
(
vﬁ
->
«me
, &
devt
);

2335 i‡(
ªt
)

2338 
ªt
 = 
	`båfs_f‹gë_devi˚s
(
devt
);

2340 
BTRFS_IOC_DEVICES_READY
:

2341 
	`muãx_lock
(&
uuid_muãx
);

2342 
devi˚
 = 
	`båfs_sˇn_⁄e_devi˚
(
vﬁ
->
«me
, 
BLK_OPEN_READ
);

2343 i‡(
	`IS_ERR
(
devi˚
)) {

2344 
	`muãx_u∆ock
(&
uuid_muãx
);

2345 
ªt
 = 
	`PTR_ERR
(
devi˚
);

2348 
ªt
 = !(
devi˚
->
fs_devi˚s
->
num_devi˚s
 ==

2349 
devi˚
->
fs_devi˚s
->
tŸÆ_devi˚s
);

2350 
	`muãx_u∆ock
(&
uuid_muãx
);

2352 
BTRFS_IOC_GET_SUPPORTED_FEATURES
:

2353 
ªt
 = 
	`båfs_io˘l_gë_suµ‹ãd_„©uªs
((
__u£r
*)
¨g
);

2357 
	`k‰ì
(
vﬁ
);

2358  
ªt
;

2359 
	}
}

2361 
	$båfs_‰ìze
(
su≥r_block
 *
sb
)

2363 
båfs_å™s_h™dÀ
 *
å™s
;

2364 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
sb
);

2365 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
åì_roŸ
;

2367 
	`£t_bô
(
BTRFS_FS_FROZEN
, &
fs_öfo
->
Êags
);

2374 
å™s
 = 
	`båfs_©èch_å™ß˘i⁄_b¨rõr
(
roŸ
);

2375 i‡(
	`IS_ERR
(
å™s
)) {

2377 i‡(
	`PTR_ERR
(
å™s
Ë=-
ENOENT
)

2379  
	`PTR_ERR
(
å™s
);

2381  
	`båfs_commô_å™ß˘i⁄
(
å™s
);

2382 
	}
}

2384 
	$check_dev_su≥r
(
båfs_devi˚
 *
dev
)

2386 
båfs_fs_öfo
 *
fs_öfo
 = 
dev
->fs_info;

2387 
båfs_su≥r_block
 *
sb
;

2388 
u16
 
csum_ty≥
;

2389 
ªt
 = 0;

2392 
	`ASSERT
(
	`ã°_bô
(
BTRFS_FS_FROZEN
, &
fs_öfo
->
Êags
));

2395 i‡(!
dev
->
bdev
)

2399 
sb
 = 
	`båfs_ªad_dev_⁄e_su≥r
(
dev
->
bdev
, 0, 
åue
);

2400 i‡(
	`IS_ERR
(
sb
))

2401  
	`PTR_ERR
(
sb
);

2404 
csum_ty≥
 = 
	`båfs_su≥r_csum_ty≥
(
sb
);

2405 i‡(
csum_ty≥
 !
	`båfs_su≥r_csum_ty≥
(
fs_öfo
->
su≥r_c›y
)) {

2406 
	`båfs_îr
(
fs_öfo
, "csumÅype changed, has %uÉxpect %u",

2407 
csum_ty≥
, 
	`båfs_su≥r_csum_ty≥
(
fs_öfo
->
su≥r_c›y
));

2408 
ªt
 = -
EUCLEAN
;

2409 
out
;

2412 i‡(
	`båfs_check_su≥r_csum
(
fs_öfo
, 
sb
)) {

2413 
	`båfs_îr
(
fs_öfo
, "csum for on-disk super blockÇoÜonger matches");

2414 
ªt
 = -
EUCLEAN
;

2415 
out
;

2419 
ªt
 = 
	`båfs_vÆid©e_su≥r
(
fs_öfo
, 
sb
, 0);

2420 i‡(
ªt
 < 0)

2421 
out
;

2423 i‡(
	`båfs_su≥r_gíî©i⁄
(
sb
Ë!
fs_öfo
->
œ°_å™s_commôãd
) {

2424 
	`båfs_îr
(
fs_öfo
, "transid mismatch, has %lluÉxpect %llu",

2425 
	`båfs_su≥r_gíî©i⁄
(
sb
),

2426 
fs_öfo
->
œ°_å™s_commôãd
);

2427 
ªt
 = -
EUCLEAN
;

2428 
out
;

2430 
out
:

2431 
	`båfs_ªÀa£_disk_su≥r
(
sb
);

2432  
ªt
;

2433 
	}
}

2435 
	$båfs_un‰ìze
(
su≥r_block
 *
sb
)

2437 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
sb
);

2438 
båfs_devi˚
 *
devi˚
;

2439 
ªt
 = 0;

2449 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_öfo
->
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

2450 
ªt
 = 
	`check_dev_su≥r
(
devi˚
);

2451 i‡(
ªt
 < 0) {

2452 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
ªt
,

2454 
devi˚
->
devid
);

2458 
	`˛ór_bô
(
BTRFS_FS_FROZEN
, &
fs_öfo
->
Êags
);

2466 
	}
}

2468 
	$båfs_show_dev«me
(
£q_fûe
 *
m
, 
díåy
 *
roŸ
)

2470 
båfs_fs_öfo
 *
fs_öfo
 = 
	`båfs_sb
(
roŸ
->
d_sb
);

2477 
	`rcu_ªad_lock
();

2478 
	`£q_esˇ≥
(
m
, 
	`båfs_dev_«me
(
fs_öfo
->
fs_devi˚s
->
œã°_dev
), " \t\n\\");

2479 
	`rcu_ªad_u∆ock
();

2482 
	}
}

2484 c⁄° 
su≥r_›î©i⁄s
 
	gbåfs_su≥r_›s
 = {

2485 .
dr›_öode
 = 
båfs_dr›_öode
,

2486 .
	gevi˘_öode
 = 
båfs_evi˘_öode
,

2487 .
	gput_su≥r
 = 
båfs_put_su≥r
,

2488 .
	gsync_fs
 = 
båfs_sync_fs
,

2489 .
	gshow_›ti⁄s
 = 
båfs_show_›ti⁄s
,

2490 .
	gshow_dev«me
 = 
båfs_show_dev«me
,

2491 .
	gÆloc_öode
 = 
båfs_Æloc_öode
,

2492 .
	gde°roy_öode
 = 
båfs_de°roy_öode
,

2493 .
	g‰ì_öode
 = 
båfs_‰ì_öode
,

2494 .
	g°©fs
 = 
båfs_°©fs
,

2495 .
	gªmou¡_fs
 = 
båfs_ªmou¡
,

2496 .
	g‰ìze_fs
 = 
båfs_‰ìze
,

2497 .
	gun‰ìze_fs
 = 
båfs_un‰ìze
,

2500 c⁄° 
fûe_›î©i⁄s
 
	gbåfs_˘l_f›s
 = {

2501 .
›í
 = 
båfs_c⁄åﬁ_›í
,

2502 .
	gu∆ocked_io˘l
 = 
båfs_c⁄åﬁ_io˘l
,

2503 .
	gcom∑t_io˘l
 = 
com∑t_±r_io˘l
,

2504 .
	gow√r
 = 
THIS_MODULE
,

2505 .
	gŒ£ek
 = 
no›_Œ£ek
,

2508 
miscdevi˚
 
	gbåfs_misc
 = {

2509 .
mö‹
 = 
BTRFS_MINOR
,

2510 .
	g«me
 = "btrfs-control",

2511 .
	gf›s
 = &
båfs_˘l_f›s


2514 
MODULE_ALIAS_MISCDEV
(
BTRFS_MINOR
);

2515 
MODULE_ALIAS
("devname:btrfs-control");

2517 
__öô
 
	$båfs_öãrÁ˚_öô
()

2519  
	`misc_ªgi°î
(&
båfs_misc
);

2520 
	}
}

2522 
__cﬁd
 
	$båfs_öãrÁ˚_exô
()

2524 
	`misc_dîegi°î
(&
båfs_misc
);

2525 
	}
}

2527 
__öô
 
	$båfs_¥öt_mod_öfo
()

2529 c⁄° 
›ti⁄s
[] = ""

2530 #ifde‡
CONFIG_BTRFS_DEBUG


2533 #ifde‡
CONFIG_BTRFS_ASSERT


2536 #ifde‡
CONFIG_BTRFS_FS_CHECK_INTEGRITY


2539 #ifde‡
CONFIG_BTRFS_FS_REF_VERIFY


2542 #ifde‡
CONFIG_BLK_DEV_ZONED


2547 #ifde‡
CONFIG_FS_VERITY


2553 
	`¥_öfo
("Båf†lﬂded%s\n", 
›ti⁄s
);

2555 
	}
}

2557 
	$ªgi°î_båfs
()

2559  
	`ªgi°î_fûesy°em
(&
båfs_fs_ty≥
);

2560 
	}
}

2562 
	$uƒegi°î_båfs
()

2564 
	`uƒegi°î_fûesy°em
(&
båfs_fs_ty≥
);

2565 
	}
}

2568 
	söô_£quí˚
 {

2569 (*
	möô_func
)();

2571 (*
	mexô_func
)();

2574 c⁄° 
öô_£quí˚
 
	gmod_öô_£q
[] = {

2576 .
öô_func
 = 
båfs_¥›s_öô
,

2577 .
	gexô_func
 = 
NULL
,

2579 .
	göô_func
 = 
båfs_öô_sysfs
,

2580 .
	gexô_func
 = 
båfs_exô_sysfs
,

2582 .
	göô_func
 = 
båfs_öô_com¥ess
,

2583 .
	gexô_func
 = 
båfs_exô_com¥ess
,

2585 .
	göô_func
 = 
båfs_öô_ˇchï
,

2586 .
	gexô_func
 = 
båfs_de°roy_ˇchï
,

2588 .
	göô_func
 = 
båfs_å™ß˘i⁄_öô
,

2589 .
	gexô_func
 = 
båfs_å™ß˘i⁄_exô
,

2591 .
	göô_func
 = 
båfs_˘ªe_öô
,

2592 .
	gexô_func
 = 
båfs_˘ªe_exô
,

2594 .
	göô_func
 = 
båfs_‰ì_•a˚_öô
,

2595 .
	gexô_func
 = 
båfs_‰ì_•a˚_exô
,

2597 .
	göô_func
 = 
exã¡_°©e_öô_ˇchï
,

2598 .
	gexô_func
 = 
exã¡_°©e_‰ì_ˇchï
,

2600 .
	göô_func
 = 
exã¡_buf„r_öô_ˇchï
,

2601 .
	gexô_func
 = 
exã¡_buf„r_‰ì_ˇchï
,

2603 .
	göô_func
 = 
båfs_bio£t_öô
,

2604 .
	gexô_func
 = 
båfs_bio£t_exô
,

2606 .
	göô_func
 = 
exã¡_m≠_öô
,

2607 .
	gexô_func
 = 
exã¡_m≠_exô
,

2609 .
	göô_func
 = 
‹dîed_d©a_öô
,

2610 .
	gexô_func
 = 
‹dîed_d©a_exô
,

2612 .
	göô_func
 = 
båfs_dñayed_öode_öô
,

2613 .
	gexô_func
 = 
båfs_dñayed_öode_exô
,

2615 .
	göô_func
 = 
båfs_auto_de‰ag_öô
,

2616 .
	gexô_func
 = 
båfs_auto_de‰ag_exô
,

2618 .
	göô_func
 = 
båfs_dñayed_ªf_öô
,

2619 .
	gexô_func
 = 
båfs_dñayed_ªf_exô
,

2621 .
	göô_func
 = 
båfs_¥ñim_ªf_öô
,

2622 .
	gexô_func
 = 
båfs_¥ñim_ªf_exô
,

2624 .
	göô_func
 = 
båfs_öãrÁ˚_öô
,

2625 .
	gexô_func
 = 
båfs_öãrÁ˚_exô
,

2627 .
	göô_func
 = 
båfs_¥öt_mod_öfo
,

2628 .
	gexô_func
 = 
NULL
,

2630 .
	göô_func
 = 
båfs_run_ßnôy_ã°s
,

2631 .
	gexô_func
 = 
NULL
,

2633 .
	göô_func
 = 
ªgi°î_båfs
,

2634 .
	gexô_func
 = 
uƒegi°î_båfs
,

2638 
boﬁ
 
	gmod_öô_ªsu…
[
ARRAY_SIZE
(
mod_öô_£q
)];

2640 
__Æways_ölöe
 
	$båfs_exô_båfs_fs
()

2642 
i
;

2644 
i
 = 
	`ARRAY_SIZE
(
mod_öô_£q
) - 1; i >= 0; i--) {

2645 i‡(!
mod_öô_ªsu…
[
i
])

2647 i‡(
mod_öô_£q
[
i
].
exô_func
)

2648 
mod_öô_£q
[
i
].
	`exô_func
();

2649 
mod_öô_ªsu…
[
i
] = 
Ál£
;

2651 
	}
}

2653 
__exô
 
	$exô_båfs_fs
()

2655 
	`båfs_exô_båfs_fs
();

2656 
	`båfs_˛ónup_fs_uuids
();

2657 
	}
}

2659 
__öô
 
	$öô_båfs_fs
()

2661 
ªt
;

2662 
i
;

2664 
i
 = 0; i < 
	`ARRAY_SIZE
(
mod_öô_£q
); i++) {

2665 
	`ASSERT
(!
mod_öô_ªsu…
[
i
]);

2666 
ªt
 = 
mod_öô_£q
[
i
].
	`öô_func
();

2667 i‡(
ªt
 < 0) {

2668 
	`båfs_exô_båfs_fs
();

2669  
ªt
;

2671 
mod_öô_ªsu…
[
i
] = 
åue
;

2674 
	}
}

2676 
œã_öôˇŒ
(
öô_båfs_fs
);

2677 
	$moduÀ_exô
(
exô_båfs_fs
)

2679 
	`MODULE_LICENSE
("GPL");

2680 
	`MODULE_SOFTDEP
("pre: crc32c");

2681 
	`MODULE_SOFTDEP
("pre: xxhash64");

2682 
	`MODULE_SOFTDEP
("pre: sha256");

2683 
	`MODULE_SOFTDEP
("pre: blake2b-256");

	@super.h

3 #i‚de‡
BTRFS_SUPER_H


4 
	#BTRFS_SUPER_H


	)

6 
båfs_∑r£_›ti⁄s
(
båfs_fs_öfo
 *
öfo
, *
›ti⁄s
,

7 
√w_Êags
);

8 
båfs_sync_fs
(
su≥r_block
 *
sb
, 
waô
);

9 *
båfs_gë_subvﬁ_«me_‰om_obje˘id
(
båfs_fs_öfo
 *
fs_öfo
,

10 
u64
 
subvﬁ_obje˘id
);

12 
ölöe
 
båfs_fs_öfo
 *
	$båfs_sb
(
su≥r_block
 *
sb
)

14  
sb
->
s_fs_öfo
;

15 
	}
}

17 
ölöe
 
	$båfs_£t_sb_rd⁄ly
(
su≥r_block
 *
sb
)

19 
sb
->
s_Êags
 |
SB_RDONLY
;

20 
	`£t_bô
(
BTRFS_FS_STATE_RO
, &
	`båfs_sb
(
sb
)->
fs_°©e
);

21 
	}
}

23 
ölöe
 
	$båfs_˛ór_sb_rd⁄ly
(
su≥r_block
 *
sb
)

25 
sb
->
s_Êags
 &~
SB_RDONLY
;

26 
	`˛ór_bô
(
BTRFS_FS_STATE_RO
, &
	`båfs_sb
(
sb
)->
fs_°©e
);

27 
	}
}

	@sysfs.c

6 
	~<löux/sched.h
>

7 
	~<löux/sched/mm.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/•ölock.h
>

10 
	~<löux/com∂ëi⁄.h
>

11 
	~<löux/bug.h
>

12 
	~<löux/li°.h
>

13 
	~<¸y±o/hash.h
>

14 
	~"mesßges.h
"

15 
	~"˘ªe.h
"

16 
	~"disˇrd.h
"

17 
	~"disk-io.h
"

18 
	~"£nd.h
"

19 
	~"å™ß˘i⁄.h
"

20 
	~"sysfs.h
"

21 
	~"vﬁumes.h
"

22 
	~"•a˚-öfo.h
"

23 
	~"block-group.h
"

24 
	~"qgroup.h
"

25 
	~"misc.h
"

26 
	~"fs.h
"

27 
	~"ac˚ss‹s.h
"

49 
	sbåfs_„©uª_©å
 {

50 
kobj_©åibuã
 
	mkobj_©å
;

51 
båfs_„©uª_£t
 
	m„©uª_£t
;

52 
u64
 
	m„©uª_bô
;

56 
	søid_kobje˘
 {

57 
u64
 
	mÊags
;

58 
kobje˘
 
	mkobj
;

61 
	#__INIT_KOBJ_ATTR
(
_«me
, 
_mode
, 
_show
, 
_°‹e
) \

63 .
©å
 = { .
«me
 = 
	`__°rögify
(
_«me
), .
mode
 = 
_mode
 }, \

64 .
show
 = 
_show
, \

65 .
°‹e
 = 
_°‹e
, \

66 }

	)

68 
	#BTRFS_ATTR_W
(
_¥efix
, 
_«me
, 
_°‹e
) \

69 
kobj_©åibuã
 
båfs_©å_
##
_¥efix
##
_
##
_«me
 = \

70 
	`__INIT_KOBJ_ATTR
(
_«me
, 0200, 
NULL
, 
_°‹e
)

	)

72 
	#BTRFS_ATTR_RW
(
_¥efix
, 
_«me
, 
_show
, 
_°‹e
) \

73 
kobj_©åibuã
 
båfs_©å_
##
_¥efix
##
_
##
_«me
 = \

74 
	`__INIT_KOBJ_ATTR
(
_«me
, 0644, 
_show
, 
_°‹e
)

	)

76 
	#BTRFS_ATTR
(
_¥efix
, 
_«me
, 
_show
) \

77 
kobj_©åibuã
 
båfs_©å_
##
_¥efix
##
_
##
_«me
 = \

78 
	`__INIT_KOBJ_ATTR
(
_«me
, 0444, 
_show
, 
NULL
)

	)

80 
	#BTRFS_ATTR_PTR
(
_¥efix
, 
_«me
) \

81 (&
båfs_©å_
##
_¥efix
##
_
##
_«me
.
©å
)

	)

83 
	#BTRFS_FEAT_ATTR
(
_«me
, 
_„©uª_£t
, 
_„©uª_¥efix
, 
_„©uª_bô
) \

84 
båfs_„©uª_©å
 
båfs_©å_„©uªs_
##
_«me
 = { \

85 .
kobj_©å
 = 
	`__INIT_KOBJ_ATTR
(
_«me
, 
S_IRUGO
, \

86 
båfs_„©uª_©å_show
, \

87 
båfs_„©uª_©å_°‹e
), \

88 .
„©uª_£t
 = 
_„©uª_£t
, \

89 .
„©uª_bô
 = 
_„©uª_¥efix
 ##
_
## 
_„©uª_bô
, \

90 }

	)

91 
	#BTRFS_FEAT_ATTR_PTR
(
_«me
) \

92 (&
båfs_©å_„©uªs_
##
_«me
.
kobj_©å
.
©å
)

	)

94 
	#BTRFS_FEAT_ATTR_COMPAT
(
«me
, 
„©uª
) \

95 
	`BTRFS_FEAT_ATTR
(
«me
, 
FEAT_COMPAT
, 
BTRFS_FEATURE_COMPAT
, 
„©uª
)

	)

96 
	#BTRFS_FEAT_ATTR_COMPAT_RO
(
«me
, 
„©uª
) \

97 
	`BTRFS_FEAT_ATTR
(
«me
, 
FEAT_COMPAT_RO
, 
BTRFS_FEATURE_COMPAT_RO
, 
„©uª
)

	)

98 
	#BTRFS_FEAT_ATTR_INCOMPAT
(
«me
, 
„©uª
) \

99 
	`BTRFS_FEAT_ATTR
(
«me
, 
FEAT_INCOMPAT
, 
BTRFS_FEATURE_INCOMPAT
, 
„©uª
)

	)

101 
ölöe
 
båfs_fs_öfo
 *
to_fs_öfo
(
kobje˘
 *
kobj
);

102 
ölöe
 
båfs_fs_devi˚s
 *
to_fs_devs
(
kobje˘
 *
kobj
);

103 
kobje˘
 *
gë_båfs_kobj
(kobje˘ *
kobj
);

105 
båfs_„©uª_©å
 *
	$to_båfs_„©uª_©å
(
kobj_©åibuã
 *
a
)

107  
	`c⁄èöî_of
(
a
, 
båfs_„©uª_©å
, 
kobj_©å
);

108 
	}
}

110 
kobj_©åibuã
 *
	$©å_to_båfs_©å
(
©åibuã
 *
©å
)

112  
	`c⁄èöî_of
(
©å
, 
kobj_©åibuã
,áttr);

113 
	}
}

115 
båfs_„©uª_©å
 *
	$©å_to_båfs_„©uª_©å
(

116 
©åibuã
 *
©å
)

118  
	`to_båfs_„©uª_©å
(
	`©å_to_båfs_©å
(
©å
));

119 
	}
}

121 
u64
 
	$gë_„©uªs
(
båfs_fs_öfo
 *
fs_öfo
,

122 
båfs_„©uª_£t
 
£t
)

124 
båfs_su≥r_block
 *
disk_su≥r
 = 
fs_öfo
->
su≥r_c›y
;

125 i‡(
£t
 =
FEAT_COMPAT
)

126  
	`båfs_su≥r_com∑t_Êags
(
disk_su≥r
);

127 i‡(
£t
 =
FEAT_COMPAT_RO
)

128  
	`båfs_su≥r_com∑t_ro_Êags
(
disk_su≥r
);

130  
	`båfs_su≥r_öcom∑t_Êags
(
disk_su≥r
);

131 
	}
}

133 
	$£t_„©uªs
(
båfs_fs_öfo
 *
fs_öfo
,

134 
båfs_„©uª_£t
 
£t
, 
u64
 
„©uªs
)

136 
båfs_su≥r_block
 *
disk_su≥r
 = 
fs_öfo
->
su≥r_c›y
;

137 i‡(
£t
 =
FEAT_COMPAT
)

138 
	`båfs_£t_su≥r_com∑t_Êags
(
disk_su≥r
, 
„©uªs
);

139 i‡(
£t
 =
FEAT_COMPAT_RO
)

140 
	`båfs_£t_su≥r_com∑t_ro_Êags
(
disk_su≥r
, 
„©uªs
);

142 
	`båfs_£t_su≥r_öcom∑t_Êags
(
disk_su≥r
, 
„©uªs
);

143 
	}
}

145 
	$ˇn_modify_„©uª
(
båfs_„©uª_©å
 *
Á
)

147 
vÆ
 = 0;

148 
u64
 
£t
, 
˛ór
;

149 
Á
->
„©uª_£t
) {

150 
FEAT_COMPAT
:

151 
£t
 = 
BTRFS_FEATURE_COMPAT_SAFE_SET
;

152 
˛ór
 = 
BTRFS_FEATURE_COMPAT_SAFE_CLEAR
;

154 
FEAT_COMPAT_RO
:

155 
£t
 = 
BTRFS_FEATURE_COMPAT_RO_SAFE_SET
;

156 
˛ór
 = 
BTRFS_FEATURE_COMPAT_RO_SAFE_CLEAR
;

158 
FEAT_INCOMPAT
:

159 
£t
 = 
BTRFS_FEATURE_INCOMPAT_SAFE_SET
;

160 
˛ór
 = 
BTRFS_FEATURE_INCOMPAT_SAFE_CLEAR
;

163 
	`¥_w¨n
("btrfs: sysfs: unknown feature set %d\n",

164 
Á
->
„©uª_£t
);

168 i‡(
£t
 & 
Á
->
„©uª_bô
)

169 
vÆ
 |= 1;

170 i‡(
˛ór
 & 
Á
->
„©uª_bô
)

171 
vÆ
 |= 2;

173  
vÆ
;

174 
	}
}

176 
ssize_t
 
	$båfs_„©uª_©å_show
(
kobje˘
 *
kobj
,

177 
kobj_©åibuã
 *
a
, *
buf
)

179 
vÆ
 = 0;

180 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

181 
båfs_„©uª_©å
 *
Á
 = 
	`to_båfs_„©uª_©å
(
a
);

182 i‡(
fs_öfo
) {

183 
u64
 
„©uªs
 = 
	`gë_„©uªs
(
fs_öfo
, 
Á
->
„©uª_£t
);

184 i‡(
„©uªs
 & 
Á
->
„©uª_bô
)

185 
vÆ
 = 1;

187 
vÆ
 = 
	`ˇn_modify_„©uª
(
Á
);

189  
	`sysfs_emô
(
buf
, "%d\n", 
vÆ
);

190 
	}
}

192 
ssize_t
 
	$båfs_„©uª_©å_°‹e
(
kobje˘
 *
kobj
,

193 
kobj_©åibuã
 *
a
,

194 c⁄° *
buf
, 
size_t
 
cou¡
)

196 
båfs_fs_öfo
 *
fs_öfo
;

197 
båfs_„©uª_©å
 *
Á
 = 
	`to_båfs_„©uª_©å
(
a
);

198 
u64
 
„©uªs
, 
£t
, 
˛ór
;

199 
vÆ
;

200 
ªt
;

202 
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

203 i‡(!
fs_öfo
)

204  -
EPERM
;

206 i‡(
	`sb_rd⁄ly
(
fs_öfo
->
sb
))

207  -
EROFS
;

209 
ªt
 = 
	`k°πoul
(
	`skù_•a˚s
(
buf
), 0, &
vÆ
);

210 i‡(
ªt
)

211  
ªt
;

213 i‡(
Á
->
„©uª_£t
 =
FEAT_COMPAT
) {

214 
£t
 = 
BTRFS_FEATURE_COMPAT_SAFE_SET
;

215 
˛ór
 = 
BTRFS_FEATURE_COMPAT_SAFE_CLEAR
;

216 } i‡(
Á
->
„©uª_£t
 =
FEAT_COMPAT_RO
) {

217 
£t
 = 
BTRFS_FEATURE_COMPAT_RO_SAFE_SET
;

218 
˛ór
 = 
BTRFS_FEATURE_COMPAT_RO_SAFE_CLEAR
;

220 
£t
 = 
BTRFS_FEATURE_INCOMPAT_SAFE_SET
;

221 
˛ór
 = 
BTRFS_FEATURE_INCOMPAT_SAFE_CLEAR
;

224 
„©uªs
 = 
	`gë_„©uªs
(
fs_öfo
, 
Á
->
„©uª_£t
);

227 i‡((
vÆ
 && (
„©uªs
 & 
Á
->
„©uª_bô
)) ||

228 (!
vÆ
 && !(
„©uªs
 & 
Á
->
„©uª_bô
)))

229  
cou¡
;

231 i‡((
vÆ
 && !(
£t
 & 
Á
->
„©uª_bô
)) ||

232 (!
vÆ
 && !(
˛ór
 & 
Á
->
„©uª_bô
))) {

233 
	`båfs_öfo
(
fs_öfo
,

235 
vÆ
 ? "En" : "Dis", 
Á
->
kobj_©å
.
©å
.
«me
);

236  -
EPERM
;

239 
	`båfs_öfo
(
fs_öfo
, "%s %s feature flag",

240 
vÆ
 ? "Sëtög" : "CÀ¨ög", 
Á
->
kobj_©å
.
©å
.
«me
);

242 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

243 
„©uªs
 = 
	`gë_„©uªs
(
fs_öfo
, 
Á
->
„©uª_£t
);

244 i‡(
vÆ
)

245 
„©uªs
 |
Á
->
„©uª_bô
;

247 
„©uªs
 &~
Á
->
„©uª_bô
;

248 
	`£t_„©uªs
(
fs_öfo
, 
Á
->
„©uª_£t
, 
„©uªs
);

249 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

254 
	`£t_bô
(
BTRFS_FS_NEED_TRANS_COMMIT
, &
fs_öfo
->
Êags
);

255 
	`wake_up_¥o˚ss
(
fs_öfo
->
å™ß˘i⁄_kthªad
);

257  
cou¡
;

258 
	}
}

260 
umode_t
 
	$båfs_„©uª_visibÀ
(
kobje˘
 *
kobj
,

261 
©åibuã
 *
©å
, 
unu£d
)

263 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

264 
umode_t
 
mode
 = 
©å
->mode;

266 i‡(
fs_öfo
) {

267 
båfs_„©uª_©å
 *
Á
;

268 
u64
 
„©uªs
;

270 
Á
 = 
	`©å_to_båfs_„©uª_©å
(
©å
);

271 
„©uªs
 = 
	`gë_„©uªs
(
fs_öfo
, 
Á
->
„©uª_£t
);

273 i‡(
	`ˇn_modify_„©uª
(
Á
))

274 
mode
 |
S_IWUSR
;

275 i‡(!(
„©uªs
 & 
Á
->
„©uª_bô
))

276 
mode
 = 0;

279  
mode
;

280 
	}
}

282 
BTRFS_FEAT_ATTR_INCOMPAT
(
deÁu…_subvﬁ
, 
DEFAULT_SUBVOL
);

283 
BTRFS_FEAT_ATTR_INCOMPAT
(
mixed_groups
, 
MIXED_GROUPS
);

284 
BTRFS_FEAT_ATTR_INCOMPAT
(
com¥ess_lzo
, 
COMPRESS_LZO
);

285 
BTRFS_FEAT_ATTR_INCOMPAT
(
com¥ess_z°d
, 
COMPRESS_ZSTD
);

286 
BTRFS_FEAT_ATTR_INCOMPAT
(
exãnded_úef
, 
EXTENDED_IREF
);

287 
BTRFS_FEAT_ATTR_INCOMPAT
(
øid56
, 
RAID56
);

288 
BTRFS_FEAT_ATTR_INCOMPAT
(
sköny_mëad©a
, 
SKINNY_METADATA
);

289 
BTRFS_FEAT_ATTR_INCOMPAT
(
no_hﬁes
, 
NO_HOLES
);

290 
BTRFS_FEAT_ATTR_INCOMPAT
(
mëad©a_uuid
, 
METADATA_UUID
);

291 
BTRFS_FEAT_ATTR_COMPAT_RO
(
‰ì_•a˚_åì
, 
FREE_SPACE_TREE
);

292 
BTRFS_FEAT_ATTR_COMPAT_RO
(
block_group_åì
, 
BLOCK_GROUP_TREE
);

293 
BTRFS_FEAT_ATTR_INCOMPAT
(
øid1c34
, 
RAID1C34
);

294 #ifde‡
CONFIG_BLK_DEV_ZONED


295 
BTRFS_FEAT_ATTR_INCOMPAT
(
z⁄ed
, 
ZONED
);

297 #ifde‡
CONFIG_BTRFS_DEBUG


299 
BTRFS_FEAT_ATTR_INCOMPAT
(
exã¡_åì_v2
, 
EXTENT_TREE_V2
);

301 #ifde‡
CONFIG_FS_VERITY


302 
BTRFS_FEAT_ATTR_COMPAT_RO
(
vîôy
, 
VERITY
);

312 
©åibuã
 *
	gbåfs_suµ‹ãd_„©uª_©ås
[] = {

313 
BTRFS_FEAT_ATTR_PTR
(
deÁu…_subvﬁ
),

314 
BTRFS_FEAT_ATTR_PTR
(
mixed_groups
),

315 
BTRFS_FEAT_ATTR_PTR
(
com¥ess_lzo
),

316 
BTRFS_FEAT_ATTR_PTR
(
com¥ess_z°d
),

317 
BTRFS_FEAT_ATTR_PTR
(
exãnded_úef
),

318 
BTRFS_FEAT_ATTR_PTR
(
øid56
),

319 
BTRFS_FEAT_ATTR_PTR
(
sköny_mëad©a
),

320 
BTRFS_FEAT_ATTR_PTR
(
no_hﬁes
),

321 
BTRFS_FEAT_ATTR_PTR
(
mëad©a_uuid
),

322 
BTRFS_FEAT_ATTR_PTR
(
‰ì_•a˚_åì
),

323 
BTRFS_FEAT_ATTR_PTR
(
øid1c34
),

324 
BTRFS_FEAT_ATTR_PTR
(
block_group_åì
),

325 #ifde‡
CONFIG_BLK_DEV_ZONED


326 
BTRFS_FEAT_ATTR_PTR
(
z⁄ed
),

328 #ifde‡
CONFIG_BTRFS_DEBUG


329 
BTRFS_FEAT_ATTR_PTR
(
exã¡_åì_v2
),

331 #ifde‡
CONFIG_FS_VERITY


332 
BTRFS_FEAT_ATTR_PTR
(
vîôy
),

334 
NULL


337 c⁄° 
©åibuã_group
 
	gbåfs_„©uª_©å_group
 = {

338 .
«me
 = "features",

339 .
	gis_visibÀ
 = 
båfs_„©uª_visibÀ
,

340 .
	g©ås
 = 
båfs_suµ‹ãd_„©uª_©ås
,

343 
ssize_t
 
	$rmdú_subvﬁ_show
(
kobje˘
 *
kobj
,

344 
kobj_©åibuã
 *
ka
, *
buf
)

346  
	`sysfs_emô
(
buf
, "0\n");

347 
	}
}

348 
BTRFS_ATTR
(
°©ic_„©uª
, 
rmdú_subvﬁ
, 
rmdú_subvﬁ_show
);

350 
ssize_t
 
	$suµ‹ãd_checksums_show
(
kobje˘
 *
kobj
,

351 
kobj_©åibuã
 *
a
, *
buf
)

353 
ssize_t
 
ªt
 = 0;

354 
i
;

356 
i
 = 0; i < 
	`båfs_gë_num_csums
(); i++) {

361 
ªt
 +
	`sysfs_emô_©
(
buf
,Ñë, "%s%s", (
i
 == 0 ? "" : " "),

362 
	`båfs_su≥r_csum_«me
(
i
));

366 
ªt
 +
	`sysfs_emô_©
(
buf
,Ñet, "\n");

367  
ªt
;

368 
	}
}

369 
BTRFS_ATTR
(
°©ic_„©uª
, 
suµ‹ãd_checksums
, 
suµ‹ãd_checksums_show
);

371 
ssize_t
 
	$£nd_°ªam_vîsi⁄_show
(
kobje˘
 *
kobj
,

372 
kobj_©åibuã
 *
ka
, *
buf
)

374  
	`sysfs_emô
(
buf
, "%d\n", 
BTRFS_SEND_STREAM_VERSION
);

375 
	}
}

376 
BTRFS_ATTR
(
°©ic_„©uª
, 
£nd_°ªam_vîsi⁄
, 
£nd_°ªam_vîsi⁄_show
);

378 c⁄° *
	gªscue_›ts
[] = {

386 
ssize_t
 
	$suµ‹ãd_ªscue_›ti⁄s_show
(
kobje˘
 *
kobj
,

387 
kobj_©åibuã
 *
a
,

388 *
buf
)

390 
ssize_t
 
ªt
 = 0;

391 
i
;

393 
i
 = 0; i < 
	`ARRAY_SIZE
(
ªscue_›ts
); i++)

394 
ªt
 +
	`sysfs_emô_©
(
buf
,Ñë, "%s%s", (
i
 ? " " : ""), 
ªscue_›ts
[i]);

395 
ªt
 +
	`sysfs_emô_©
(
buf
,Ñet, "\n");

396  
ªt
;

397 
	}
}

398 
BTRFS_ATTR
(
°©ic_„©uª
, 
suµ‹ãd_ªscue_›ti⁄s
,

399 
suµ‹ãd_ªscue_›ti⁄s_show
);

401 
ssize_t
 
	$suµ‹ãd_£˘‹sizes_show
(
kobje˘
 *
kobj
,

402 
kobj_©åibuã
 *
a
,

403 *
buf
)

405 
ssize_t
 
ªt
 = 0;

408 i‡(
PAGE_SIZE
 > 
SZ_4K
)

409 
ªt
 +
	`sysfs_emô_©
(
buf
,Ñë, "%u ", 
SZ_4K
);

410 
ªt
 +
	`sysfs_emô_©
(
buf
,Ñë, "%lu\n", 
PAGE_SIZE
);

412  
ªt
;

413 
	}
}

414 
BTRFS_ATTR
(
°©ic_„©uª
, 
suµ‹ãd_£˘‹sizes
,

415 
suµ‹ãd_£˘‹sizes_show
);

417 
ssize_t
 
	$a˛_show
(
kobje˘
 *
kobj
, 
kobj_©åibuã
 *
a
, *
buf
)

419  
	`sysfs_emô
(
buf
, "%d\n", !!
	`IS_ENABLED
(
CONFIG_BTRFS_FS_POSIX_ACL
));

420 
	}
}

421 
BTRFS_ATTR
(
°©ic_„©uª
, 
a˛
, 
a˛_show
);

429 
©åibuã
 *
	gbåfs_suµ‹ãd_°©ic_„©uª_©ås
[] = {

430 
BTRFS_ATTR_PTR
(
°©ic_„©uª
, 
a˛
),

431 
BTRFS_ATTR_PTR
(
°©ic_„©uª
, 
rmdú_subvﬁ
),

432 
BTRFS_ATTR_PTR
(
°©ic_„©uª
, 
suµ‹ãd_checksums
),

433 
BTRFS_ATTR_PTR
(
°©ic_„©uª
, 
£nd_°ªam_vîsi⁄
),

434 
BTRFS_ATTR_PTR
(
°©ic_„©uª
, 
suµ‹ãd_ªscue_›ti⁄s
),

435 
BTRFS_ATTR_PTR
(
°©ic_„©uª
, 
suµ‹ãd_£˘‹sizes
),

436 
NULL


439 c⁄° 
©åibuã_group
 
	gbåfs_°©ic_„©uª_©å_group
 = {

440 .
«me
 = "features",

441 .
	g©ås
 = 
båfs_suµ‹ãd_°©ic_„©uª_©ås
,

447 
	#disˇrd_to_fs_öfo
(
_kobj
Ë
	`to_fs_öfo
(
	`gë_båfs_kobj
(_kobj))

	)

449 
ssize_t
 
	$båfs_disˇrdabÀ_byãs_show
(
kobje˘
 *
kobj
,

450 
kobj_©åibuã
 *
a
,

451 *
buf
)

453 
båfs_fs_öfo
 *
fs_öfo
 = 
	`disˇrd_to_fs_öfo
(
kobj
);

455  
	`sysfs_emô
(
buf
, "%lld\n",

456 
	`©omic64_ªad
(&
fs_öfo
->
disˇrd_˘l
.
disˇrdabÀ_byãs
));

457 
	}
}

458 
BTRFS_ATTR
(
disˇrd
, 
disˇrdabÀ_byãs
, 
båfs_disˇrdabÀ_byãs_show
);

460 
ssize_t
 
	$båfs_disˇrdabÀ_exã¡s_show
(
kobje˘
 *
kobj
,

461 
kobj_©åibuã
 *
a
,

462 *
buf
)

464 
båfs_fs_öfo
 *
fs_öfo
 = 
	`disˇrd_to_fs_öfo
(
kobj
);

466  
	`sysfs_emô
(
buf
, "%d\n",

467 
	`©omic_ªad
(&
fs_öfo
->
disˇrd_˘l
.
disˇrdabÀ_exã¡s
));

468 
	}
}

469 
BTRFS_ATTR
(
disˇrd
, 
disˇrdabÀ_exã¡s
, 
båfs_disˇrdabÀ_exã¡s_show
);

471 
ssize_t
 
	$båfs_disˇrd_bôm≠_byãs_show
(
kobje˘
 *
kobj
,

472 
kobj_©åibuã
 *
a
,

473 *
buf
)

475 
båfs_fs_öfo
 *
fs_öfo
 = 
	`disˇrd_to_fs_öfo
(
kobj
);

477  
	`sysfs_emô
(
buf
, "%llu\n",

478 
fs_öfo
->
disˇrd_˘l
.
disˇrd_bôm≠_byãs
);

479 
	}
}

480 
BTRFS_ATTR
(
disˇrd
, 
disˇrd_bôm≠_byãs
, 
båfs_disˇrd_bôm≠_byãs_show
);

482 
ssize_t
 
	$båfs_disˇrd_byãs_ßved_show
(
kobje˘
 *
kobj
,

483 
kobj_©åibuã
 *
a
,

484 *
buf
)

486 
båfs_fs_öfo
 *
fs_öfo
 = 
	`disˇrd_to_fs_öfo
(
kobj
);

488  
	`sysfs_emô
(
buf
, "%lld\n",

489 
	`©omic64_ªad
(&
fs_öfo
->
disˇrd_˘l
.
disˇrd_byãs_ßved
));

490 
	}
}

491 
BTRFS_ATTR
(
disˇrd
, 
disˇrd_byãs_ßved
, 
båfs_disˇrd_byãs_ßved_show
);

493 
ssize_t
 
	$båfs_disˇrd_exã¡_byãs_show
(
kobje˘
 *
kobj
,

494 
kobj_©åibuã
 *
a
,

495 *
buf
)

497 
båfs_fs_öfo
 *
fs_öfo
 = 
	`disˇrd_to_fs_öfo
(
kobj
);

499  
	`sysfs_emô
(
buf
, "%llu\n",

500 
fs_öfo
->
disˇrd_˘l
.
disˇrd_exã¡_byãs
);

501 
	}
}

502 
BTRFS_ATTR
(
disˇrd
, 
disˇrd_exã¡_byãs
, 
båfs_disˇrd_exã¡_byãs_show
);

504 
ssize_t
 
	$båfs_disˇrd_i›s_limô_show
(
kobje˘
 *
kobj
,

505 
kobj_©åibuã
 *
a
,

506 *
buf
)

508 
båfs_fs_öfo
 *
fs_öfo
 = 
	`disˇrd_to_fs_öfo
(
kobj
);

510  
	`sysfs_emô
(
buf
, "%u\n",

511 
	`READ_ONCE
(
fs_öfo
->
disˇrd_˘l
.
i›s_limô
));

512 
	}
}

514 
ssize_t
 
	$båfs_disˇrd_i›s_limô_°‹e
(
kobje˘
 *
kobj
,

515 
kobj_©åibuã
 *
a
,

516 c⁄° *
buf
, 
size_t
 
Àn
)

518 
båfs_fs_öfo
 *
fs_öfo
 = 
	`disˇrd_to_fs_öfo
(
kobj
);

519 
båfs_disˇrd_˘l
 *
disˇrd_˘l
 = &
fs_öfo
->discard_ctl;

520 
u32
 
i›s_limô
;

521 
ªt
;

523 
ªt
 = 
	`k°πou32
(
buf
, 10, &
i›s_limô
);

524 i‡(
ªt
)

525  -
EINVAL
;

527 
	`WRITE_ONCE
(
disˇrd_˘l
->
i›s_limô
, iops_limit);

528 
	`båfs_disˇrd_ˇlc_dñay
(
disˇrd_˘l
);

529 
	`båfs_disˇrd_scheduÀ_w‹k
(
disˇrd_˘l
, 
åue
);

530  
Àn
;

531 
	}
}

532 
BTRFS_ATTR_RW
(
disˇrd
, 
i›s_limô
, 
båfs_disˇrd_i›s_limô_show
,

533 
båfs_disˇrd_i›s_limô_°‹e
);

535 
ssize_t
 
	$båfs_disˇrd_kbps_limô_show
(
kobje˘
 *
kobj
,

536 
kobj_©åibuã
 *
a
,

537 *
buf
)

539 
båfs_fs_öfo
 *
fs_öfo
 = 
	`disˇrd_to_fs_öfo
(
kobj
);

541  
	`sysfs_emô
(
buf
, "%u\n",

542 
	`READ_ONCE
(
fs_öfo
->
disˇrd_˘l
.
kbps_limô
));

543 
	}
}

545 
ssize_t
 
	$båfs_disˇrd_kbps_limô_°‹e
(
kobje˘
 *
kobj
,

546 
kobj_©åibuã
 *
a
,

547 c⁄° *
buf
, 
size_t
 
Àn
)

549 
båfs_fs_öfo
 *
fs_öfo
 = 
	`disˇrd_to_fs_öfo
(
kobj
);

550 
båfs_disˇrd_˘l
 *
disˇrd_˘l
 = &
fs_öfo
->discard_ctl;

551 
u32
 
kbps_limô
;

552 
ªt
;

554 
ªt
 = 
	`k°πou32
(
buf
, 10, &
kbps_limô
);

555 i‡(
ªt
)

556  -
EINVAL
;

558 
	`WRITE_ONCE
(
disˇrd_˘l
->
kbps_limô
, kbps_limit);

559 
	`båfs_disˇrd_scheduÀ_w‹k
(
disˇrd_˘l
, 
åue
);

560  
Àn
;

561 
	}
}

562 
BTRFS_ATTR_RW
(
disˇrd
, 
kbps_limô
, 
båfs_disˇrd_kbps_limô_show
,

563 
båfs_disˇrd_kbps_limô_°‹e
);

565 
ssize_t
 
	$båfs_disˇrd_max_disˇrd_size_show
(
kobje˘
 *
kobj
,

566 
kobj_©åibuã
 *
a
,

567 *
buf
)

569 
båfs_fs_öfo
 *
fs_öfo
 = 
	`disˇrd_to_fs_öfo
(
kobj
);

571  
	`sysfs_emô
(
buf
, "%llu\n",

572 
	`READ_ONCE
(
fs_öfo
->
disˇrd_˘l
.
max_disˇrd_size
));

573 
	}
}

575 
ssize_t
 
	$båfs_disˇrd_max_disˇrd_size_°‹e
(
kobje˘
 *
kobj
,

576 
kobj_©åibuã
 *
a
,

577 c⁄° *
buf
, 
size_t
 
Àn
)

579 
båfs_fs_öfo
 *
fs_öfo
 = 
	`disˇrd_to_fs_öfo
(
kobj
);

580 
båfs_disˇrd_˘l
 *
disˇrd_˘l
 = &
fs_öfo
->discard_ctl;

581 
u64
 
max_disˇrd_size
;

582 
ªt
;

584 
ªt
 = 
	`k°πou64
(
buf
, 10, &
max_disˇrd_size
);

585 i‡(
ªt
)

586  -
EINVAL
;

588 
	`WRITE_ONCE
(
disˇrd_˘l
->
max_disˇrd_size
, max_discard_size);

590  
Àn
;

591 
	}
}

592 
BTRFS_ATTR_RW
(
disˇrd
, 
max_disˇrd_size
, 
båfs_disˇrd_max_disˇrd_size_show
,

593 
båfs_disˇrd_max_disˇrd_size_°‹e
);

600 c⁄° 
©åibuã
 *
	gdisˇrd_©ås
[] = {

601 
BTRFS_ATTR_PTR
(
disˇrd
, 
disˇrdabÀ_byãs
),

602 
BTRFS_ATTR_PTR
(
disˇrd
, 
disˇrdabÀ_exã¡s
),

603 
BTRFS_ATTR_PTR
(
disˇrd
, 
disˇrd_bôm≠_byãs
),

604 
BTRFS_ATTR_PTR
(
disˇrd
, 
disˇrd_byãs_ßved
),

605 
BTRFS_ATTR_PTR
(
disˇrd
, 
disˇrd_exã¡_byãs
),

606 
BTRFS_ATTR_PTR
(
disˇrd
, 
i›s_limô
),

607 
BTRFS_ATTR_PTR
(
disˇrd
, 
kbps_limô
),

608 
BTRFS_ATTR_PTR
(
disˇrd
, 
max_disˇrd_size
),

609 
NULL
,

612 #ifde‡
CONFIG_BTRFS_DEBUG


619 c⁄° 
©åibuã
 *
	gbåfs_debug_mou¡_©ås
[] = {

620 
NULL
,

628 
©åibuã
 *
	gbåfs_debug_„©uª_©ås
[] = {

629 
NULL


632 c⁄° 
©åibuã_group
 
	gbåfs_debug_„©uª_©å_group
 = {

633 .
«me
 = "debug",

634 .
	g©ås
 = 
båfs_debug_„©uª_©ås
,

639 
ssize_t
 
	$båfs_show_u64
(
u64
 *
vÆue_±r
, 
•ölock_t
 *
lock
, *
buf
)

641 
u64
 
vÆ
;

642 i‡(
lock
)

643 
	`•ö_lock
(
lock
);

644 
vÆ
 = *
vÆue_±r
;

645 i‡(
lock
)

646 
	`•ö_u∆ock
(
lock
);

647  
	`sysfs_emô
(
buf
, "%Œu\n", 
vÆ
);

648 
	}
}

650 
ssize_t
 
	$globÆ_rsv_size_show
(
kobje˘
 *
kobj
,

651 
kobj_©åibuã
 *
ka
, *
buf
)

653 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
->
∑ª¡
);

654 
båfs_block_rsv
 *
block_rsv
 = &
fs_öfo
->
globÆ_block_rsv
;

655  
	`båfs_show_u64
(&
block_rsv
->
size
, &block_rsv->
lock
, 
buf
);

656 
	}
}

657 
BTRFS_ATTR
(
Æloˇti⁄
, 
globÆ_rsv_size
, 
globÆ_rsv_size_show
);

659 
ssize_t
 
	$globÆ_rsv_ª£rved_show
(
kobje˘
 *
kobj
,

660 
kobj_©åibuã
 *
a
, *
buf
)

662 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
->
∑ª¡
);

663 
båfs_block_rsv
 *
block_rsv
 = &
fs_öfo
->
globÆ_block_rsv
;

664  
	`båfs_show_u64
(&
block_rsv
->
ª£rved
, &block_rsv->
lock
, 
buf
);

665 
	}
}

666 
BTRFS_ATTR
(
Æloˇti⁄
, 
globÆ_rsv_ª£rved
, 
globÆ_rsv_ª£rved_show
);

668 
	#to_•a˚_öfo
(
_kobj
Ë
	`c⁄èöî_of
(_kobj, 
båfs_•a˚_öfo
, 
kobj
)

	)

669 
	#to_øid_kobj
(
_kobj
Ë
	`c⁄èöî_of
(_kobj, 
øid_kobje˘
, 
kobj
)

	)

671 
ssize_t
 
øid_byãs_show
(
kobje˘
 *
kobj
,

672 
kobj_©åibuã
 *
©å
, *
buf
);

673 
BTRFS_ATTR
(
øid
, 
tŸÆ_byãs
, 
øid_byãs_show
);

674 
BTRFS_ATTR
(
øid
, 
u£d_byãs
, 
øid_byãs_show
);

676 
ssize_t
 
	$øid_byãs_show
(
kobje˘
 *
kobj
,

677 
kobj_©åibuã
 *
©å
, *
buf
)

680 
båfs_•a˚_öfo
 *
söfo
 = 
	`to_•a˚_öfo
(
kobj
->
∑ª¡
);

681 
båfs_block_group
 *
block_group
;

682 
ödex
 = 
	`båfs_bg_Êags_to_øid_ödex
(
	`to_øid_kobj
(
kobj
)->
Êags
);

683 
u64
 
vÆ
 = 0;

685 
	`down_ªad
(&
söfo
->
groups_£m
);

686 
	`li°_f‹_óch_íåy
(
block_group
, &
söfo
->
block_groups
[
ödex
], 
li°
) {

687 i‡(&
©å
->©å =
	`BTRFS_ATTR_PTR
(
øid
, 
tŸÆ_byãs
))

688 
vÆ
 +
block_group
->
Àngth
;

690 
vÆ
 +
block_group
->
u£d
;

692 
	`up_ªad
(&
söfo
->
groups_£m
);

693  
	`sysfs_emô
(
buf
, "%Œu\n", 
vÆ
);

694 
	}
}

701 
©åibuã
 *
	gøid_©ås
[] = {

702 
BTRFS_ATTR_PTR
(
øid
, 
tŸÆ_byãs
),

703 
BTRFS_ATTR_PTR
(
øid
, 
u£d_byãs
),

704 
NULL


706 
ATTRIBUTE_GROUPS
(
øid
);

708 
	$ªÀa£_øid_kobj
(
kobje˘
 *
kobj
)

710 
	`k‰ì
(
	`to_øid_kobj
(
kobj
));

711 
	}
}

713 c⁄° 
kobj_ty≥
 
	gbåfs_øid_kty≥
 = {

714 .
sysfs_›s
 = &
kobj_sysfs_›s
,

715 .
	gªÀa£
 = 
ªÀa£_øid_kobj
,

716 .
	gdeÁu…_groups
 = 
øid_groups
,

719 
	#SPACE_INFO_ATTR
(
fõld
) \

720 
ssize_t
 
båfs_•a˚_öfo_show_
##
	`fõld
(
kobje˘
 *
kobj
, \

721 
kobj_©åibuã
 *
a
, \

722 *
buf
) \

724 
båfs_•a˚_öfo
 *
söfo
 = 
	`to_•a˚_öfo
(
kobj
); \

725  
	`båfs_show_u64
(&
söfo
->
fõld
, &söfo->
lock
, 
buf
); \

727 
	`BTRFS_ATTR
(
•a˚_öfo
, 
fõld
, 
båfs_•a˚_öfo_show_
##fõld)

	)

729 
ssize_t
 
	$båfs_chunk_size_show
(
kobje˘
 *
kobj
,

730 
kobj_©åibuã
 *
a
, *
buf
)

732 
båfs_•a˚_öfo
 *
söfo
 = 
	`to_•a˚_öfo
(
kobj
);

734  
	`sysfs_emô
(
buf
, "%Œu\n", 
	`READ_ONCE
(
söfo
->
chunk_size
));

735 
	}
}

744 
ssize_t
 
	$båfs_chunk_size_°‹e
(
kobje˘
 *
kobj
,

745 
kobj_©åibuã
 *
a
,

746 c⁄° *
buf
, 
size_t
 
Àn
)

748 
båfs_•a˚_öfo
 *
•a˚_öfo
 = 
	`to_•a˚_öfo
(
kobj
);

749 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
	`gë_båfs_kobj
(
kobj
));

750 *
ªçå
;

751 
u64
 
vÆ
;

753 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

754  -
EPERM
;

756 i‡(!
fs_öfo
->
fs_devi˚s
)

757  -
EINVAL
;

759 i‡(
	`båfs_is_z⁄ed
(
fs_öfo
))

760  -
EINVAL
;

763 i‡(
•a˚_öfo
->
Êags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

764  -
EPERM
;

766 
vÆ
 = 
	`mem∑r£
(
buf
, &
ªçå
);

768 
ªçå
 = 
	`skù_•a˚s
(retptr);

769 i‡(*
ªçå
 !0 || 
vÆ
 == 0)

770  -
EINVAL
;

772 
vÆ
 = 
	`mö
(vÆ, 
BTRFS_MAX_DATA_CHUNK_SIZE
);

775 
vÆ
 = 
	`mö
(
	`mu…_≥rc
(
fs_öfo
->
fs_devi˚s
->
tŸÆ_rw_byãs
, 10), val);

778 
vÆ
 &~((
u64
)
SZ_256M
 - 1);

781 i‡(
vÆ
 < 
SZ_256M
)

782  -
EINVAL
;

784 
	`båfs_upd©e_•a˚_öfo_chunk_size
(
•a˚_öfo
, 
vÆ
);

786  
Àn
;

787 
	}
}

789 
ssize_t
 
	$båfs_size_˛as£s_show
(
kobje˘
 *
kobj
,

790 
kobj_©åibuã
 *
a
, *
buf
)

792 
båfs_•a˚_öfo
 *
söfo
 = 
	`to_•a˚_öfo
(
kobj
);

793 
båfs_block_group
 *
bg
;

794 
u32
 
n⁄e
 = 0;

795 
u32
 
smÆl
 = 0;

796 
u32
 
medium
 = 0;

797 
u32
 
œrge
 = 0;

799 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; ++i) {

800 
	`down_ªad
(&
söfo
->
groups_£m
);

801 
	`li°_f‹_óch_íåy
(
bg
, &
söfo
->
block_groups
[
i
], 
li°
) {

802 i‡(!
	`båfs_block_group_should_u£_size_˛ass
(
bg
))

804 
bg
->
size_˛ass
) {

805 
BTRFS_BG_SZ_NONE
:

806 
n⁄e
++;

808 
BTRFS_BG_SZ_SMALL
:

809 
smÆl
++;

811 
BTRFS_BG_SZ_MEDIUM
:

812 
medium
++;

814 
BTRFS_BG_SZ_LARGE
:

815 
œrge
++;

819 
	`up_ªad
(&
söfo
->
groups_£m
);

821  
	`sysfs_emô
(
buf
, "none %u\n"

825 
n⁄e
, 
smÆl
, 
medium
, 
œrge
);

826 
	}
}

828 #ifde‡
CONFIG_BTRFS_DEBUG


832 
ssize_t
 
	$båfs_f‹˚_chunk_Æloc_°‹e
(
kobje˘
 *
kobj
,

833 
kobj_©åibuã
 *
a
,

834 c⁄° *
buf
, 
size_t
 
Àn
)

836 
båfs_•a˚_öfo
 *
•a˚_öfo
 = 
	`to_•a˚_öfo
(
kobj
);

837 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
	`gë_båfs_kobj
(
kobj
));

838 
båfs_å™s_h™dÀ
 *
å™s
;

839 
boﬁ
 
vÆ
;

840 
ªt
;

842 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

843  -
EPERM
;

845 i‡(
	`sb_rd⁄ly
(
fs_öfo
->
sb
))

846  -
EROFS
;

848 
ªt
 = 
	`k°πoboﬁ
(
buf
, &
vÆ
);

849 i‡(
ªt
)

850  
ªt
;

852 i‡(!
vÆ
)

853  -
EINVAL
;

859 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
fs_öfo
->
åì_roŸ
, 0);

860 i‡(
	`IS_ERR
(
å™s
))

861  
	`PTR_ERR
(
å™s
);

862 
ªt
 = 
	`båfs_f‹˚_chunk_Æloc
(
å™s
, 
•a˚_öfo
->
Êags
);

863 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

865 i‡(
ªt
 == 1)

866  
Àn
;

868  -
ENOSPC
;

869 
	}
}

870 
BTRFS_ATTR_W
(
•a˚_öfo
, 
f‹˚_chunk_Æloc
, 
båfs_f‹˚_chunk_Æloc_°‹e
);

874 
SPACE_INFO_ATTR
(
Êags
);

875 
SPACE_INFO_ATTR
(
tŸÆ_byãs
);

876 
SPACE_INFO_ATTR
(
byãs_u£d
);

877 
SPACE_INFO_ATTR
(
byãs_pö√d
);

878 
SPACE_INFO_ATTR
(
byãs_ª£rved
);

879 
SPACE_INFO_ATTR
(
byãs_may_u£
);

880 
SPACE_INFO_ATTR
(
byãs_ªad⁄ly
);

881 
SPACE_INFO_ATTR
(
byãs_z⁄e_unußbÀ
);

882 
SPACE_INFO_ATTR
(
disk_u£d
);

883 
SPACE_INFO_ATTR
(
disk_tŸÆ
);

884 
BTRFS_ATTR_RW
(
•a˚_öfo
, 
chunk_size
, 
båfs_chunk_size_show
, 
båfs_chunk_size_°‹e
);

885 
BTRFS_ATTR
(
•a˚_öfo
, 
size_˛as£s
, 
båfs_size_˛as£s_show
);

887 
ssize_t
 
	$båfs_söfo_bg_ª˛aim_thªshﬁd_show
(
kobje˘
 *
kobj
,

888 
kobj_©åibuã
 *
a
,

889 *
buf
)

891 
båfs_•a˚_öfo
 *
•a˚_öfo
 = 
	`to_•a˚_öfo
(
kobj
);

893  
	`sysfs_emô
(
buf
, "%d\n", 
	`READ_ONCE
(
•a˚_öfo
->
bg_ª˛aim_thªshﬁd
));

894 
	}
}

896 
ssize_t
 
	$båfs_söfo_bg_ª˛aim_thªshﬁd_°‹e
(
kobje˘
 *
kobj
,

897 
kobj_©åibuã
 *
a
,

898 c⁄° *
buf
, 
size_t
 
Àn
)

900 
båfs_•a˚_öfo
 *
•a˚_öfo
 = 
	`to_•a˚_öfo
(
kobj
);

901 
thªsh
;

902 
ªt
;

904 
ªt
 = 
	`k°πoöt
(
buf
, 10, &
thªsh
);

905 i‡(
ªt
)

906  
ªt
;

908 i‡(
thªsh
 < 0 ||Åhresh > 100)

909  -
EINVAL
;

911 
	`WRITE_ONCE
(
•a˚_öfo
->
bg_ª˛aim_thªshﬁd
, 
thªsh
);

913  
Àn
;

914 
	}
}

916 
BTRFS_ATTR_RW
(
•a˚_öfo
, 
bg_ª˛aim_thªshﬁd
,

917 
båfs_söfo_bg_ª˛aim_thªshﬁd_show
,

918 
båfs_söfo_bg_ª˛aim_thªshﬁd_°‹e
);

925 
©åibuã
 *
	g•a˚_öfo_©ås
[] = {

926 
BTRFS_ATTR_PTR
(
•a˚_öfo
, 
Êags
),

927 
BTRFS_ATTR_PTR
(
•a˚_öfo
, 
tŸÆ_byãs
),

928 
BTRFS_ATTR_PTR
(
•a˚_öfo
, 
byãs_u£d
),

929 
BTRFS_ATTR_PTR
(
•a˚_öfo
, 
byãs_pö√d
),

930 
BTRFS_ATTR_PTR
(
•a˚_öfo
, 
byãs_ª£rved
),

931 
BTRFS_ATTR_PTR
(
•a˚_öfo
, 
byãs_may_u£
),

932 
BTRFS_ATTR_PTR
(
•a˚_öfo
, 
byãs_ªad⁄ly
),

933 
BTRFS_ATTR_PTR
(
•a˚_öfo
, 
byãs_z⁄e_unußbÀ
),

934 
BTRFS_ATTR_PTR
(
•a˚_öfo
, 
disk_u£d
),

935 
BTRFS_ATTR_PTR
(
•a˚_öfo
, 
disk_tŸÆ
),

936 
BTRFS_ATTR_PTR
(
•a˚_öfo
, 
bg_ª˛aim_thªshﬁd
),

937 
BTRFS_ATTR_PTR
(
•a˚_öfo
, 
chunk_size
),

938 
BTRFS_ATTR_PTR
(
•a˚_öfo
, 
size_˛as£s
),

939 #ifde‡
CONFIG_BTRFS_DEBUG


940 
BTRFS_ATTR_PTR
(
•a˚_öfo
, 
f‹˚_chunk_Æloc
),

942 
NULL
,

944 
ATTRIBUTE_GROUPS
(
•a˚_öfo
);

946 
	$•a˚_öfo_ªÀa£
(
kobje˘
 *
kobj
)

948 
båfs_•a˚_öfo
 *
söfo
 = 
	`to_•a˚_öfo
(
kobj
);

949 
	`k‰ì
(
söfo
);

950 
	}
}

952 c⁄° 
kobj_ty≥
 
	g•a˚_öfo_kty≥
 = {

953 .
sysfs_›s
 = &
kobj_sysfs_›s
,

954 .
	gªÀa£
 = 
•a˚_öfo_ªÀa£
,

955 .
	gdeÁu…_groups
 = 
•a˚_öfo_groups
,

963 c⁄° 
©åibuã
 *
	gÆloˇti⁄_©ås
[] = {

964 
BTRFS_ATTR_PTR
(
Æloˇti⁄
, 
globÆ_rsv_ª£rved
),

965 
BTRFS_ATTR_PTR
(
Æloˇti⁄
, 
globÆ_rsv_size
),

966 
NULL
,

969 
ssize_t
 
	$båfs_œbñ_show
(
kobje˘
 *
kobj
,

970 
kobj_©åibuã
 *
a
, *
buf
)

972 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

973 *
œbñ
 = 
fs_öfo
->
su≥r_c›y
->label;

974 
ssize_t
 
ªt
;

976 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

977 
ªt
 = 
	`sysfs_emô
(
buf
, 
œbñ
[0] ? "%s\n" : "%s",Üabel);

978 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

980  
ªt
;

981 
	}
}

983 
ssize_t
 
	$båfs_œbñ_°‹e
(
kobje˘
 *
kobj
,

984 
kobj_©åibuã
 *
a
,

985 c⁄° *
buf
, 
size_t
 
Àn
)

987 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

988 
size_t
 
p_Àn
;

990 i‡(!
fs_öfo
)

991  -
EPERM
;

993 i‡(
	`sb_rd⁄ly
(
fs_öfo
->
sb
))

994  -
EROFS
;

1000 
p_Àn
 = 
	`°rc•n
(
buf
, "\n");

1002 i‡(
p_Àn
 >
BTRFS_LABEL_SIZE
)

1003  -
EINVAL
;

1005 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

1006 
	`mem£t
(
fs_öfo
->
su≥r_c›y
->
œbñ
, 0, 
BTRFS_LABEL_SIZE
);

1007 
	`mem˝y
(
fs_öfo
->
su≥r_c›y
->
œbñ
, 
buf
, 
p_Àn
);

1008 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

1013 
	`£t_bô
(
BTRFS_FS_NEED_TRANS_COMMIT
, &
fs_öfo
->
Êags
);

1014 
	`wake_up_¥o˚ss
(
fs_öfo
->
å™ß˘i⁄_kthªad
);

1016  
Àn
;

1017 
	}
}

1018 
BTRFS_ATTR_RW
(, 
œbñ
, 
båfs_œbñ_show
, 
båfs_œbñ_°‹e
);

1020 
ssize_t
 
	$båfs_nodesize_show
(
kobje˘
 *
kobj
,

1021 
kobj_©åibuã
 *
a
, *
buf
)

1023 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

1025  
	`sysfs_emô
(
buf
, "%u\n", 
fs_öfo
->
su≥r_c›y
->
nodesize
);

1026 
	}
}

1028 
BTRFS_ATTR
(, 
nodesize
, 
båfs_nodesize_show
);

1030 
ssize_t
 
	$båfs_£˘‹size_show
(
kobje˘
 *
kobj
,

1031 
kobj_©åibuã
 *
a
, *
buf
)

1033 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

1035  
	`sysfs_emô
(
buf
, "%u\n", 
fs_öfo
->
su≥r_c›y
->
£˘‹size
);

1036 
	}
}

1038 
BTRFS_ATTR
(, 
£˘‹size
, 
båfs_£˘‹size_show
);

1040 
ssize_t
 
	$båfs_commô_°©s_show
(
kobje˘
 *
kobj
,

1041 
kobj_©åibuã
 *
a
, *
buf
)

1043 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

1045  
	`sysfs_emô
(
buf
,

1050 
fs_öfo
->
commô_°©s
.
commô_cou¡
,

1051 
	`div_u64
(
fs_öfo
->
commô_°©s
.
œ°_commô_dur
, 
NSEC_PER_MSEC
),

1052 
	`div_u64
(
fs_öfo
->
commô_°©s
.
max_commô_dur
, 
NSEC_PER_MSEC
),

1053 
	`div_u64
(
fs_öfo
->
commô_°©s
.
tŸÆ_commô_dur
, 
NSEC_PER_MSEC
));

1054 
	}
}

1056 
ssize_t
 
	$båfs_commô_°©s_°‹e
(
kobje˘
 *
kobj
,

1057 
kobj_©åibuã
 *
a
,

1058 c⁄° *
buf
, 
size_t
 
Àn
)

1060 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

1061 
vÆ
;

1062 
ªt
;

1064 i‡(!
fs_öfo
)

1065  -
EPERM
;

1067 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
))

1068  -
EPERM
;

1070 
ªt
 = 
	`k°πoul
(
buf
, 10, &
vÆ
);

1071 i‡(
ªt
)

1072  
ªt
;

1073 i‡(
vÆ
)

1074  -
EINVAL
;

1076 
	`WRITE_ONCE
(
fs_öfo
->
commô_°©s
.
max_commô_dur
, 0);

1078  
Àn
;

1079 
	}
}

1080 
BTRFS_ATTR_RW
(, 
commô_°©s
, 
båfs_commô_°©s_show
, 
båfs_commô_°©s_°‹e
);

1082 
ssize_t
 
	$båfs_˛⁄e_Æignmít_show
(
kobje˘
 *
kobj
,

1083 
kobj_©åibuã
 *
a
, *
buf
)

1085 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

1087  
	`sysfs_emô
(
buf
, "%u\n", 
fs_öfo
->
su≥r_c›y
->
£˘‹size
);

1088 
	}
}

1090 
BTRFS_ATTR
(, 
˛⁄e_Æignmít
, 
båfs_˛⁄e_Æignmít_show
);

1092 
ssize_t
 
	$quŸa_ovîride_show
(
kobje˘
 *
kobj
,

1093 
kobj_©åibuã
 *
a
, *
buf
)

1095 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

1096 
quŸa_ovîride
;

1098 
quŸa_ovîride
 = 
	`ã°_bô
(
BTRFS_FS_QUOTA_OVERRIDE
, &
fs_öfo
->
Êags
);

1099  
	`sysfs_emô
(
buf
, "%d\n", 
quŸa_ovîride
);

1100 
	}
}

1102 
ssize_t
 
	$quŸa_ovîride_°‹e
(
kobje˘
 *
kobj
,

1103 
kobj_©åibuã
 *
a
,

1104 c⁄° *
buf
, 
size_t
 
Àn
)

1106 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

1107 
knob
;

1108 
îr
;

1110 i‡(!
fs_öfo
)

1111  -
EPERM
;

1113 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
))

1114  -
EPERM
;

1116 
îr
 = 
	`k°πoul
(
buf
, 10, &
knob
);

1117 i‡(
îr
)

1118  
îr
;

1119 i‡(
knob
 > 1)

1120  -
EINVAL
;

1122 i‡(
knob
)

1123 
	`£t_bô
(
BTRFS_FS_QUOTA_OVERRIDE
, &
fs_öfo
->
Êags
);

1125 
	`˛ór_bô
(
BTRFS_FS_QUOTA_OVERRIDE
, &
fs_öfo
->
Êags
);

1127  
Àn
;

1128 
	}
}

1130 
BTRFS_ATTR_RW
(, 
quŸa_ovîride
, 
quŸa_ovîride_show
, 
quŸa_ovîride_°‹e
);

1132 
ssize_t
 
	$båfs_mëad©a_uuid_show
(
kobje˘
 *
kobj
,

1133 
kobj_©åibuã
 *
a
, *
buf
)

1135 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

1137  
	`sysfs_emô
(
buf
, "%pU\n", 
fs_öfo
->
fs_devi˚s
->
mëad©a_uuid
);

1138 
	}
}

1140 
BTRFS_ATTR
(, 
mëad©a_uuid
, 
båfs_mëad©a_uuid_show
);

1142 
ssize_t
 
	$båfs_checksum_show
(
kobje˘
 *
kobj
,

1143 
kobj_©åibuã
 *
a
, *
buf
)

1145 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

1146 
u16
 
csum_ty≥
 = 
	`båfs_su≥r_csum_ty≥
(
fs_öfo
->
su≥r_c›y
);

1148  
	`sysfs_emô
(
buf
, "%s (%s)\n",

1149 
	`båfs_su≥r_csum_«me
(
csum_ty≥
),

1150 
	`¸y±o_shash_drivî_«me
(
fs_öfo
->
csum_shash
));

1151 
	}
}

1153 
BTRFS_ATTR
(, 
checksum
, 
båfs_checksum_show
);

1155 
ssize_t
 
	$båfs_ex˛usive_›î©i⁄_show
(
kobje˘
 *
kobj
,

1156 
kobj_©åibuã
 *
a
, *
buf
)

1158 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

1159 c⁄° *
°r
;

1161 
	`READ_ONCE
(
fs_öfo
->
ex˛usive_›î©i⁄
)) {

1162 
BTRFS_EXCLOP_NONE
:

1163 
°r
 = "none\n";

1165 
BTRFS_EXCLOP_BALANCE
:

1166 
°r
 = "balance\n";

1168 
BTRFS_EXCLOP_BALANCE_PAUSED
:

1169 
°r
 = "balanceÖaused\n";

1171 
BTRFS_EXCLOP_DEV_ADD
:

1172 
°r
 = "deviceádd\n";

1174 
BTRFS_EXCLOP_DEV_REMOVE
:

1175 
°r
 = "deviceÑemove\n";

1177 
BTRFS_EXCLOP_DEV_REPLACE
:

1178 
°r
 = "deviceÑeplace\n";

1180 
BTRFS_EXCLOP_RESIZE
:

1181 
°r
 = "resize\n";

1183 
BTRFS_EXCLOP_SWAP_ACTIVATE
:

1184 
°r
 = "swapáctivate\n";

1187 
°r
 = "UNKNOWN\n";

1190  
	`sysfs_emô
(
buf
, "%s", 
°r
);

1191 
	}
}

1192 
BTRFS_ATTR
(, 
ex˛usive_›î©i⁄
, 
båfs_ex˛usive_›î©i⁄_show
);

1194 
ssize_t
 
	$båfs_gíî©i⁄_show
(
kobje˘
 *
kobj
,

1195 
kobj_©åibuã
 *
a
, *
buf
)

1197 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

1199  
	`sysfs_emô
(
buf
, "%Œu\n", 
fs_öfo
->
gíî©i⁄
);

1200 
	}
}

1201 
BTRFS_ATTR
(, 
gíî©i⁄
, 
båfs_gíî©i⁄_show
);

1203 c⁄° * c⁄° 
	gbåfs_ªad_pﬁicy_«me
[] = { "pid" };

1205 
ssize_t
 
	$båfs_ªad_pﬁicy_show
(
kobje˘
 *
kobj
,

1206 
kobj_©åibuã
 *
a
, *
buf
)

1208 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
	`to_fs_devs
(
kobj
);

1209 
ssize_t
 
ªt
 = 0;

1210 
i
;

1212 
i
 = 0; i < 
BTRFS_NR_READ_POLICY
; i++) {

1213 i‡(
fs_devi˚s
->
ªad_pﬁicy
 =
i
)

1214 
ªt
 +
	`sysfs_emô_©
(
buf
,Ñet, "%s[%s]",

1215 (
ªt
 == 0 ? "" : " "),

1216 
båfs_ªad_pﬁicy_«me
[
i
]);

1218 
ªt
 +
	`sysfs_emô_©
(
buf
,Ñet, "%s%s",

1219 (
ªt
 == 0 ? "" : " "),

1220 
båfs_ªad_pﬁicy_«me
[
i
]);

1223 
ªt
 +
	`sysfs_emô_©
(
buf
,Ñet, "\n");

1225  
ªt
;

1226 
	}
}

1228 
ssize_t
 
	$båfs_ªad_pﬁicy_°‹e
(
kobje˘
 *
kobj
,

1229 
kobj_©åibuã
 *
a
,

1230 c⁄° *
buf
, 
size_t
 
Àn
)

1232 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
	`to_fs_devs
(
kobj
);

1233 
i
;

1235 
i
 = 0; i < 
BTRFS_NR_READ_POLICY
; i++) {

1236 i‡(
	`sysfs_°ªq
(
buf
, 
båfs_ªad_pﬁicy_«me
[
i
])) {

1237 i‡(
i
 !
fs_devi˚s
->
ªad_pﬁicy
) {

1238 
fs_devi˚s
->
ªad_pﬁicy
 = 
i
;

1239 
	`båfs_öfo
(
fs_devi˚s
->
fs_öfo
,

1241 
båfs_ªad_pﬁicy_«me
[
i
]);

1243  
Àn
;

1247  -
EINVAL
;

1248 
	}
}

1249 
BTRFS_ATTR_RW
(, 
ªad_pﬁicy
, 
båfs_ªad_pﬁicy_show
, 
båfs_ªad_pﬁicy_°‹e
);

1251 
ssize_t
 
	$båfs_bg_ª˛aim_thªshﬁd_show
(
kobje˘
 *
kobj
,

1252 
kobj_©åibuã
 *
a
,

1253 *
buf
)

1255 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

1257  
	`sysfs_emô
(
buf
, "%d\n", 
	`READ_ONCE
(
fs_öfo
->
bg_ª˛aim_thªshﬁd
));

1258 
	}
}

1260 
ssize_t
 
	$båfs_bg_ª˛aim_thªshﬁd_°‹e
(
kobje˘
 *
kobj
,

1261 
kobj_©åibuã
 *
a
,

1262 c⁄° *
buf
, 
size_t
 
Àn
)

1264 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
kobj
);

1265 
thªsh
;

1266 
ªt
;

1268 
ªt
 = 
	`k°πoöt
(
buf
, 10, &
thªsh
);

1269 i‡(
ªt
)

1270  
ªt
;

1272 #ifde‡
CONFIG_BTRFS_DEBUG


1273 i‡(
thªsh
 != 0 && (thresh > 100))

1274  -
EINVAL
;

1276 i‡(
thªsh
 != 0 && (thresh <= 50 ||Åhresh > 100))

1277  -
EINVAL
;

1280 
	`WRITE_ONCE
(
fs_öfo
->
bg_ª˛aim_thªshﬁd
, 
thªsh
);

1282  
Àn
;

1283 
	}
}

1284 
BTRFS_ATTR_RW
(, 
bg_ª˛aim_thªshﬁd
, 
båfs_bg_ª˛aim_thªshﬁd_show
,

1285 
båfs_bg_ª˛aim_thªshﬁd_°‹e
);

1292 c⁄° 
©åibuã
 *
	gbåfs_©ås
[] = {

1293 
BTRFS_ATTR_PTR
(, 
œbñ
),

1294 
BTRFS_ATTR_PTR
(, 
nodesize
),

1295 
BTRFS_ATTR_PTR
(, 
£˘‹size
),

1296 
BTRFS_ATTR_PTR
(, 
˛⁄e_Æignmít
),

1297 
BTRFS_ATTR_PTR
(, 
quŸa_ovîride
),

1298 
BTRFS_ATTR_PTR
(, 
mëad©a_uuid
),

1299 
BTRFS_ATTR_PTR
(, 
checksum
),

1300 
BTRFS_ATTR_PTR
(, 
ex˛usive_›î©i⁄
),

1301 
BTRFS_ATTR_PTR
(, 
gíî©i⁄
),

1302 
BTRFS_ATTR_PTR
(, 
ªad_pﬁicy
),

1303 
BTRFS_ATTR_PTR
(, 
bg_ª˛aim_thªshﬁd
),

1304 
BTRFS_ATTR_PTR
(, 
commô_°©s
),

1305 
NULL
,

1308 
	$båfs_ªÀa£_fsid_kobj
(
kobje˘
 *
kobj
)

1310 
båfs_fs_devi˚s
 *
fs_devs
 = 
	`to_fs_devs
(
kobj
);

1312 
	`mem£t
(&
fs_devs
->
fsid_kobj
, 0, (
kobje˘
));

1313 
	`com∂ëe
(&
fs_devs
->
kobj_uƒegi°î
);

1314 
	}
}

1316 c⁄° 
kobj_ty≥
 
	gbåfs_kty≥
 = {

1317 .
sysfs_›s
 = &
kobj_sysfs_›s
,

1318 .
	gªÀa£
 = 
båfs_ªÀa£_fsid_kobj
,

1321 
ölöe
 
båfs_fs_devi˚s
 *
	$to_fs_devs
(
kobje˘
 *
kobj
)

1323 i‡(
kobj
->
kty≥
 !&
båfs_kty≥
)

1324  
NULL
;

1325  
	`c⁄èöî_of
(
kobj
, 
båfs_fs_devi˚s
, 
fsid_kobj
);

1326 
	}
}

1328 
ölöe
 
båfs_fs_öfo
 *
	$to_fs_öfo
(
kobje˘
 *
kobj
)

1330 i‡(
kobj
->
kty≥
 !&
båfs_kty≥
)

1331  
NULL
;

1332  
	`to_fs_devs
(
kobj
)->
fs_öfo
;

1333 
	}
}

1335 
kobje˘
 *
	$gë_båfs_kobj
(
kobje˘
 *
kobj
)

1337 
kobj
) {

1338 i‡(
kobj
->
kty≥
 =&
båfs_kty≥
)

1339  
kobj
;

1340 
kobj
 = kobj->
∑ª¡
;

1342  
NULL
;

1343 
	}
}

1345 
	#NUM_FEATURE_BITS
 64

	)

1346 
	#BTRFS_FEATURE_NAME_MAX
 13

	)

1347 
	gbåfs_unknown_„©uª_«mes
[
FEAT_MAX
][
NUM_FEATURE_BITS
][
BTRFS_FEATURE_NAME_MAX
];

1348 
båfs_„©uª_©å
 
	gbåfs_„©uª_©ås
[
FEAT_MAX
][
NUM_FEATURE_BITS
];

1350 
°©ic_as£π
(
ARRAY_SIZE
(
båfs_unknown_„©uª_«mes
) ==

1351 
ARRAY_SIZE
(
båfs_„©uª_©ås
));

1352 
°©ic_as£π
(
ARRAY_SIZE
(
båfs_unknown_„©uª_«mes
[0]) ==

1353 
ARRAY_SIZE
(
båfs_„©uª_©ås
[0]));

1355 c⁄° 
u64
 
	gsuµ‹ãd_„©uª_masks
[
FEAT_MAX
] = {

1356 [
FEAT_COMPAT
] = 
BTRFS_FEATURE_COMPAT_SUPP
,

1357 [
FEAT_COMPAT_RO
] = 
BTRFS_FEATURE_COMPAT_RO_SUPP
,

1358 [
FEAT_INCOMPAT
] = 
BTRFS_FEATURE_INCOMPAT_SUPP
,

1361 
	$addrm_unknown_„©uª_©ås
(
båfs_fs_öfo
 *
fs_öfo
, 
boﬁ
 
add
)

1363 
£t
;

1365 
£t
 = 0; së < 
FEAT_MAX
; set++) {

1366 
i
;

1367 
©åibuã
 *
©ås
[2];

1368 
©åibuã_group
 
agroup
 = {

1369 .
«me
 = "features",

1370 .
©ås
 =áttrs,

1372 
u64
 
„©uªs
 = 
	`gë_„©uªs
(
fs_öfo
, 
£t
);

1373 
„©uªs
 &~
suµ‹ãd_„©uª_masks
[
£t
];

1375 i‡(!
„©uªs
)

1378 
©ås
[1] = 
NULL
;

1379 
i
 = 0; i < 
NUM_FEATURE_BITS
; i++) {

1380 
båfs_„©uª_©å
 *
Á
;

1382 i‡(!(
„©uªs
 & (1ULL << 
i
)))

1385 
Á
 = &
båfs_„©uª_©ås
[
£t
][
i
];

1386 
©ås
[0] = &
Á
->
kobj_©å
.
©å
;

1387 i‡(
add
) {

1388 
ªt
;

1389 
ªt
 = 
	`sysfs_mîge_group
(&
fs_öfo
->
fs_devi˚s
->
fsid_kobj
,

1390 &
agroup
);

1391 i‡(
ªt
)

1392  
ªt
;

1394 
	`sysfs_unmîge_group
(&
fs_öfo
->
fs_devi˚s
->
fsid_kobj
,

1395 &
agroup
);

1400 
	}
}

1402 
	$__båfs_sysfs_ªmove_fsid
(
båfs_fs_devi˚s
 *
fs_devs
)

1404 i‡(
fs_devs
->
devöfo_kobj
) {

1405 
	`kobje˘_dñ
(
fs_devs
->
devöfo_kobj
);

1406 
	`kobje˘_put
(
fs_devs
->
devöfo_kobj
);

1407 
fs_devs
->
devöfo_kobj
 = 
NULL
;

1410 i‡(
fs_devs
->
devi˚s_kobj
) {

1411 
	`kobje˘_dñ
(
fs_devs
->
devi˚s_kobj
);

1412 
	`kobje˘_put
(
fs_devs
->
devi˚s_kobj
);

1413 
fs_devs
->
devi˚s_kobj
 = 
NULL
;

1416 i‡(
fs_devs
->
fsid_kobj
.
°©e_öôülized
) {

1417 
	`kobje˘_dñ
(&
fs_devs
->
fsid_kobj
);

1418 
	`kobje˘_put
(&
fs_devs
->
fsid_kobj
);

1419 
	`waô_f‹_com∂ëi⁄
(&
fs_devs
->
kobj_uƒegi°î
);

1421 
	}
}

1424 
	$båfs_sysfs_ªmove_fsid
(
båfs_fs_devi˚s
 *
fs_devs
)

1426 
li°_hód
 *
fs_uuids
 = 
	`båfs_gë_fs_uuids
();

1428 i‡(
fs_devs
) {

1429 
	`__båfs_sysfs_ªmove_fsid
(
fs_devs
);

1433 
	`li°_f‹_óch_íåy
(
fs_devs
, 
fs_uuids
, 
fs_li°
) {

1434 
	`__båfs_sysfs_ªmove_fsid
(
fs_devs
);

1436 
	}
}

1438 
	$båfs_sysfs_ªmove_fs_devi˚s
(
båfs_fs_devi˚s
 *
fs_devi˚s
)

1440 
båfs_devi˚
 *
devi˚
;

1441 
båfs_fs_devi˚s
 *
£ed
;

1443 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
)

1444 
	`båfs_sysfs_ªmove_devi˚
(
devi˚
);

1446 
	`li°_f‹_óch_íåy
(
£ed
, &
fs_devi˚s
->
£ed_li°
, seed_list) {

1447 
	`li°_f‹_óch_íåy
(
devi˚
, &
£ed
->
devi˚s
, 
dev_li°
)

1448 
	`båfs_sysfs_ªmove_devi˚
(
devi˚
);

1450 
	}
}

1452 
	$båfs_sysfs_ªmove_mou¡ed
(
båfs_fs_öfo
 *
fs_öfo
)

1454 
kobje˘
 *
fsid_kobj
 = &
fs_öfo
->
fs_devi˚s
->fsid_kobj;

1456 
	`sysfs_ªmove_lök
(
fsid_kobj
, "bdi");

1458 i‡(
fs_öfo
->
•a˚_öfo_kobj
) {

1459 
	`sysfs_ªmove_fûes
(
fs_öfo
->
•a˚_öfo_kobj
, 
Æloˇti⁄_©ås
);

1460 
	`kobje˘_dñ
(
fs_öfo
->
•a˚_öfo_kobj
);

1461 
	`kobje˘_put
(
fs_öfo
->
•a˚_öfo_kobj
);

1463 i‡(
fs_öfo
->
disˇrd_kobj
) {

1464 
	`sysfs_ªmove_fûes
(
fs_öfo
->
disˇrd_kobj
, 
disˇrd_©ås
);

1465 
	`kobje˘_dñ
(
fs_öfo
->
disˇrd_kobj
);

1466 
	`kobje˘_put
(
fs_öfo
->
disˇrd_kobj
);

1468 #ifde‡
CONFIG_BTRFS_DEBUG


1469 i‡(
fs_öfo
->
debug_kobj
) {

1470 
	`sysfs_ªmove_fûes
(
fs_öfo
->
debug_kobj
, 
båfs_debug_mou¡_©ås
);

1471 
	`kobje˘_dñ
(
fs_öfo
->
debug_kobj
);

1472 
	`kobje˘_put
(
fs_öfo
->
debug_kobj
);

1475 
	`addrm_unknown_„©uª_©ås
(
fs_öfo
, 
Ál£
);

1476 
	`sysfs_ªmove_group
(
fsid_kobj
, &
båfs_„©uª_©å_group
);

1477 
	`sysfs_ªmove_fûes
(
fsid_kobj
, 
båfs_©ås
);

1478 
	`båfs_sysfs_ªmove_fs_devi˚s
(
fs_öfo
->
fs_devi˚s
);

1479 
	}
}

1481 c⁄° * c⁄° 
	gbåfs_„©uª_£t_«mes
[
FEAT_MAX
] = {

1482 [
FEAT_COMPAT
] = "compat",

1483 [
FEAT_COMPAT_RO
] = "compat_ro",

1484 [
FEAT_INCOMPAT
] = "incompat",

1487 c⁄° *
	$båfs_„©uª_£t_«me
(
båfs_„©uª_£t
 
£t
)

1489  
båfs_„©uª_£t_«mes
[
£t
];

1490 
	}
}

1492 *
	$båfs_¥öèbÀ_„©uªs
(
båfs_„©uª_£t
 
£t
, 
u64
 
Êags
)

1494 
size_t
 
bufsize
 = 4096;

1495 
Àn
 = 0;

1496 
i
;

1497 *
°r
;

1499 
°r
 = 
	`kmÆloc
(
bufsize
, 
GFP_KERNEL
);

1500 i‡(!
°r
)

1501  
°r
;

1503 
i
 = 0; i < 
	`ARRAY_SIZE
(
båfs_„©uª_©ås
[
£t
]); i++) {

1504 c⁄° *
«me
;

1506 i‡(!(
Êags
 & (1ULL << 
i
)))

1509 
«me
 = 
båfs_„©uª_©ås
[
£t
][
i
].
kobj_©å
.
©å
.name;

1510 
Àn
 +
	`s˙¥ötf
(
°r
 +Üí, 
bufsize
 -Üen, "%s%s",

1511 
Àn
 ? "," : "", 
«me
);

1514  
°r
;

1515 
	}
}

1517 
	$öô_„©uª_©ås
()

1519 
båfs_„©uª_©å
 *
Á
;

1520 
£t
, 
i
;

1522 
	`mem£t
(
båfs_„©uª_©ås
, 0, (btrfs_feature_attrs));

1523 
	`mem£t
(
båfs_unknown_„©uª_«mes
, 0,

1524 (
båfs_unknown_„©uª_«mes
));

1526 
i
 = 0; 
båfs_suµ‹ãd_„©uª_©ås
[i]; i++) {

1527 
båfs_„©uª_©å
 *
sÁ
;

1528 
©åibuã
 *
a
 = 
båfs_suµ‹ãd_„©uª_©ås
[
i
];

1529 
bô
;

1530 
sÁ
 = 
	`©å_to_båfs_„©uª_©å
(
a
);

1531 
bô
 = 
	`ûog2
(
sÁ
->
„©uª_bô
);

1532 
Á
 = &
båfs_„©uª_©ås
[
sÁ
->
„©uª_£t
][
bô
];

1534 
Á
->
kobj_©å
.
©å
.
«me
 = 
sÁ
->kobj_attr.attr.name;

1537 
£t
 = 0; së < 
FEAT_MAX
; set++) {

1538 
i
 = 0; i < 
	`ARRAY_SIZE
(
båfs_„©uª_©ås
[
£t
]); i++) {

1539 *
«me
 = 
båfs_unknown_„©uª_«mes
[
£t
][
i
];

1540 
Á
 = &
båfs_„©uª_©ås
[
£t
][
i
];

1542 i‡(
Á
->
kobj_©å
.
©å
.
«me
)

1545 
	`¢¥ötf
(
«me
, 
BTRFS_FEATURE_NAME_MAX
, "%s:%u",

1546 
båfs_„©uª_£t_«mes
[
£t
], 
i
);

1548 
Á
->
kobj_©å
.
©å
.
«me
 =Çame;

1549 
Á
->
kobj_©å
.
©å
.
mode
 = 
S_IRUGO
;

1550 
Á
->
„©uª_£t
 = 
£t
;

1551 
Á
->
„©uª_bô
 = 1ULL << 
i
;

1554 
	}
}

1560 
	$båfs_sysfs_add_block_group_ty≥
(
båfs_block_group
 *
ˇche
)

1562 
båfs_fs_öfo
 *
fs_öfo
 = 
ˇche
->fs_info;

1563 
båfs_•a˚_öfo
 *
•a˚_öfo
 = 
ˇche
->space_info;

1564 
øid_kobje˘
 *
rkobj
;

1565 c⁄° 
ödex
 = 
	`båfs_bg_Êags_to_øid_ödex
(
ˇche
->
Êags
);

1566 
nofs_Êag
;

1567 
ªt
;

1576 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

1578 
rkobj
 = 
	`kzÆloc
((*rkobj), 
GFP_NOFS
);

1579 i‡(!
rkobj
) {

1580 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

1581 
	`båfs_w¨n
(
ˇche
->
fs_öfo
,

1586 
rkobj
->
Êags
 = 
ˇche
->flags;

1587 
	`kobje˘_öô
(&
rkobj
->
kobj
, &
båfs_øid_kty≥
);

1598 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1599 i‡(
•a˚_öfo
->
block_group_kobjs
[
ödex
]) {

1600 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1601 
	`kobje˘_put
(&
rkobj
->
kobj
);

1604 
•a˚_öfo
->
block_group_kobjs
[
ödex
] = &
rkobj
->
kobj
;

1606 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1608 
ªt
 = 
	`kobje˘_add
(&
rkobj
->
kobj
, &
•a˚_öfo
->kobj, "%s",

1609 
	`båfs_bg_ty≥_to_øid_«me
(
rkobj
->
Êags
));

1610 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

1611 i‡(
ªt
) {

1612 
	`•ö_lock
(&
•a˚_öfo
->
lock
);

1613 
•a˚_öfo
->
block_group_kobjs
[
ödex
] = 
NULL
;

1614 
	`•ö_u∆ock
(&
•a˚_öfo
->
lock
);

1615 
	`kobje˘_put
(&
rkobj
->
kobj
);

1616 
	`båfs_w¨n
(
fs_öfo
,

1620 
	}
}

1626 
	$båfs_sysfs_ªmove_•a˚_öfo
(
båfs_•a˚_öfo
 *
•a˚_öfo
)

1628 
i
;

1630 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; i++) {

1631 
kobje˘
 *
kobj
;

1633 
kobj
 = 
•a˚_öfo
->
block_group_kobjs
[
i
];

1634 
•a˚_öfo
->
block_group_kobjs
[
i
] = 
NULL
;

1635 i‡(
kobj
) {

1636 
	`kobje˘_dñ
(
kobj
);

1637 
	`kobje˘_put
(
kobj
);

1640 
	`kobje˘_dñ
(&
•a˚_öfo
->
kobj
);

1641 
	`kobje˘_put
(&
•a˚_öfo
->
kobj
);

1642 
	}
}

1644 c⁄° *
	$Æloc_«me
(
u64
 
Êags
)

1646 
Êags
) {

1647 
BTRFS_BLOCK_GROUP_METADATA
 | 
BTRFS_BLOCK_GROUP_DATA
:

1649 
BTRFS_BLOCK_GROUP_METADATA
:

1651 
BTRFS_BLOCK_GROUP_DATA
:

1653 
BTRFS_BLOCK_GROUP_SYSTEM
:

1656 
	`WARN_ON
(1);

1659 
	}
}

1665 
	$båfs_sysfs_add_•a˚_öfo_ty≥
(
båfs_fs_öfo
 *
fs_öfo
,

1666 
båfs_•a˚_öfo
 *
•a˚_öfo
)

1668 
ªt
;

1670 
ªt
 = 
	`kobje˘_öô_™d_add
(&
•a˚_öfo
->
kobj
, &
•a˚_öfo_kty≥
,

1671 
fs_öfo
->
•a˚_öfo_kobj
, "%s",

1672 
	`Æloc_«me
(
•a˚_öfo
->
Êags
));

1673 i‡(
ªt
) {

1674 
	`kobje˘_put
(&
•a˚_öfo
->
kobj
);

1675  
ªt
;

1679 
	}
}

1681 
	$båfs_sysfs_ªmove_devi˚
(
båfs_devi˚
 *
devi˚
)

1683 
kobje˘
 *
devi˚s_kobj
;

1689 
devi˚s_kobj
 = 
devi˚
->
fs_öfo
->
fs_devi˚s
->devices_kobj;

1690 
	`ASSERT
(
devi˚s_kobj
);

1692 i‡(
devi˚
->
bdev
)

1693 
	`sysfs_ªmove_lök
(
devi˚s_kobj
, 
	`bdev_kobj
(
devi˚
->
bdev
)->
«me
);

1695 i‡(
devi˚
->
devid_kobj
.
°©e_öôülized
) {

1696 
	`kobje˘_dñ
(&
devi˚
->
devid_kobj
);

1697 
	`kobje˘_put
(&
devi˚
->
devid_kobj
);

1698 
	`waô_f‹_com∂ëi⁄
(&
devi˚
->
kobj_uƒegi°î
);

1700 
	}
}

1702 
ssize_t
 
	$båfs_devöfo_ö_fs_mëad©a_show
(
kobje˘
 *
kobj
,

1703 
kobj_©åibuã
 *
a
,

1704 *
buf
)

1706 
vÆ
;

1707 
båfs_devi˚
 *
devi˚
 = 
	`c⁄èöî_of
(
kobj
, btrfs_device,

1708 
devid_kobj
);

1710 
vÆ
 = !!
	`ã°_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
devi˚
->
dev_°©e
);

1712  
	`sysfs_emô
(
buf
, "%d\n", 
vÆ
);

1713 
	}
}

1714 
BTRFS_ATTR
(
devid
, 
ö_fs_mëad©a
, 
båfs_devöfo_ö_fs_mëad©a_show
);

1716 
ssize_t
 
	$båfs_devöfo_missög_show
(
kobje˘
 *
kobj
,

1717 
kobj_©åibuã
 *
a
, *
buf
)

1719 
vÆ
;

1720 
båfs_devi˚
 *
devi˚
 = 
	`c⁄èöî_of
(
kobj
, btrfs_device,

1721 
devid_kobj
);

1723 
vÆ
 = !!
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
, &
devi˚
->
dev_°©e
);

1725  
	`sysfs_emô
(
buf
, "%d\n", 
vÆ
);

1726 
	}
}

1727 
BTRFS_ATTR
(
devid
, 
missög
, 
båfs_devöfo_missög_show
);

1729 
ssize_t
 
	$båfs_devöfo_ª∂a˚_èrgë_show
(
kobje˘
 *
kobj
,

1730 
kobj_©åibuã
 *
a
,

1731 *
buf
)

1733 
vÆ
;

1734 
båfs_devi˚
 *
devi˚
 = 
	`c⁄èöî_of
(
kobj
, btrfs_device,

1735 
devid_kobj
);

1737 
vÆ
 = !!
	`ã°_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
);

1739  
	`sysfs_emô
(
buf
, "%d\n", 
vÆ
);

1740 
	}
}

1741 
BTRFS_ATTR
(
devid
, 
ª∂a˚_èrgë
, 
båfs_devöfo_ª∂a˚_èrgë_show
);

1743 
ssize_t
 
	$båfs_devöfo_s¸ub_•ìd_max_show
(
kobje˘
 *
kobj
,

1744 
kobj_©åibuã
 *
a
,

1745 *
buf
)

1747 
båfs_devi˚
 *
devi˚
 = 
	`c⁄èöî_of
(
kobj
, btrfs_device,

1748 
devid_kobj
);

1750  
	`sysfs_emô
(
buf
, "%Œu\n", 
	`READ_ONCE
(
devi˚
->
s¸ub_•ìd_max
));

1751 
	}
}

1753 
ssize_t
 
	$båfs_devöfo_s¸ub_•ìd_max_°‹e
(
kobje˘
 *
kobj
,

1754 
kobj_©åibuã
 *
a
,

1755 c⁄° *
buf
, 
size_t
 
Àn
)

1757 
båfs_devi˚
 *
devi˚
 = 
	`c⁄èöî_of
(
kobj
, btrfs_device,

1758 
devid_kobj
);

1759 *
íd±r
;

1760 
limô
;

1762 
limô
 = 
	`mem∑r£
(
buf
, &
íd±r
);

1763 
	`WRITE_ONCE
(
devi˚
->
s¸ub_•ìd_max
, 
limô
);

1764  
Àn
;

1765 
	}
}

1766 
BTRFS_ATTR_RW
(
devid
, 
s¸ub_•ìd_max
, 
båfs_devöfo_s¸ub_•ìd_max_show
,

1767 
båfs_devöfo_s¸ub_•ìd_max_°‹e
);

1769 
ssize_t
 
	$båfs_devöfo_wrôóbÀ_show
(
kobje˘
 *
kobj
,

1770 
kobj_©åibuã
 *
a
, *
buf
)

1772 
vÆ
;

1773 
båfs_devi˚
 *
devi˚
 = 
	`c⁄èöî_of
(
kobj
, btrfs_device,

1774 
devid_kobj
);

1776 
vÆ
 = !!
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
);

1778  
	`sysfs_emô
(
buf
, "%d\n", 
vÆ
);

1779 
	}
}

1780 
BTRFS_ATTR
(
devid
, 
wrôóbÀ
, 
båfs_devöfo_wrôóbÀ_show
);

1782 
ssize_t
 
	$båfs_devöfo_fsid_show
(
kobje˘
 *
kobj
,

1783 
kobj_©åibuã
 *
a
, *
buf
)

1785 
båfs_devi˚
 *
devi˚
 = 
	`c⁄èöî_of
(
kobj
, btrfs_device,

1786 
devid_kobj
);

1788  
	`sysfs_emô
(
buf
, "%pU\n", 
devi˚
->
fs_devi˚s
->
fsid
);

1789 
	}
}

1790 
BTRFS_ATTR
(
devid
, 
fsid
, 
båfs_devöfo_fsid_show
);

1792 
ssize_t
 
	$båfs_devöfo_îr‹_°©s_show
(
kobje˘
 *
kobj
,

1793 
kobj_©åibuã
 *
a
, *
buf
)

1795 
båfs_devi˚
 *
devi˚
 = 
	`c⁄èöî_of
(
kobj
, btrfs_device,

1796 
devid_kobj
);

1798 i‡(!
devi˚
->
dev_°©s_vÆid
)

1799  
	`sysfs_emô
(
buf
, "invalid\n");

1806  
	`sysfs_emô
(
buf
,

1812 
	`båfs_dev_°©_ªad
(
devi˚
, 
BTRFS_DEV_STAT_WRITE_ERRS
),

1813 
	`båfs_dev_°©_ªad
(
devi˚
, 
BTRFS_DEV_STAT_READ_ERRS
),

1814 
	`båfs_dev_°©_ªad
(
devi˚
, 
BTRFS_DEV_STAT_FLUSH_ERRS
),

1815 
	`båfs_dev_°©_ªad
(
devi˚
, 
BTRFS_DEV_STAT_CORRUPTION_ERRS
),

1816 
	`båfs_dev_°©_ªad
(
devi˚
, 
BTRFS_DEV_STAT_GENERATION_ERRS
));

1817 
	}
}

1818 
BTRFS_ATTR
(
devid
, 
îr‹_°©s
, 
båfs_devöfo_îr‹_°©s_show
);

1825 
©åibuã
 *
	gdevid_©ås
[] = {

1826 
BTRFS_ATTR_PTR
(
devid
, 
îr‹_°©s
),

1827 
BTRFS_ATTR_PTR
(
devid
, 
fsid
),

1828 
BTRFS_ATTR_PTR
(
devid
, 
ö_fs_mëad©a
),

1829 
BTRFS_ATTR_PTR
(
devid
, 
missög
),

1830 
BTRFS_ATTR_PTR
(
devid
, 
ª∂a˚_èrgë
),

1831 
BTRFS_ATTR_PTR
(
devid
, 
s¸ub_•ìd_max
),

1832 
BTRFS_ATTR_PTR
(
devid
, 
wrôóbÀ
),

1833 
NULL


1835 
ATTRIBUTE_GROUPS
(
devid
);

1837 
	$båfs_ªÀa£_devid_kobj
(
kobje˘
 *
kobj
)

1839 
båfs_devi˚
 *
devi˚
 = 
	`c⁄èöî_of
(
kobj
, btrfs_device,

1840 
devid_kobj
);

1842 
	`mem£t
(&
devi˚
->
devid_kobj
, 0, (
kobje˘
));

1843 
	`com∂ëe
(&
devi˚
->
kobj_uƒegi°î
);

1844 
	}
}

1846 c⁄° 
kobj_ty≥
 
	gdevid_kty≥
 = {

1847 .
sysfs_›s
 = &
kobj_sysfs_›s
,

1848 .
	gdeÁu…_groups
 = 
devid_groups
,

1849 .
	gªÀa£
 = 
båfs_ªÀa£_devid_kobj
,

1852 
	$båfs_sysfs_add_devi˚
(
båfs_devi˚
 *
devi˚
)

1854 
ªt
;

1855 
nofs_Êag
;

1856 
kobje˘
 *
devi˚s_kobj
;

1857 
kobje˘
 *
devöfo_kobj
;

1863 
devi˚s_kobj
 = 
devi˚
->
fs_öfo
->
fs_devi˚s
->devices_kobj;

1864 
devöfo_kobj
 = 
devi˚
->
fs_öfo
->
fs_devi˚s
->devinfo_kobj;

1865 
	`ASSERT
(
devi˚s_kobj
);

1866 
	`ASSERT
(
devöfo_kobj
);

1868 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

1870 i‡(
devi˚
->
bdev
) {

1871 
kobje˘
 *
disk_kobj
 = 
	`bdev_kobj
(
devi˚
->
bdev
);

1873 
ªt
 = 
	`sysfs_¸óã_lök
(
devi˚s_kobj
, 
disk_kobj
, disk_kobj->
«me
);

1874 i‡(
ªt
) {

1875 
	`båfs_w¨n
(
devi˚
->
fs_öfo
,

1877 
devi˚
->
devid
, 
ªt
);

1878 
out
;

1882 
	`öô_com∂ëi⁄
(&
devi˚
->
kobj_uƒegi°î
);

1883 
ªt
 = 
	`kobje˘_öô_™d_add
(&
devi˚
->
devid_kobj
, &
devid_kty≥
,

1884 
devöfo_kobj
, "%Œu", 
devi˚
->
devid
);

1885 i‡(
ªt
) {

1886 
	`kobje˘_put
(&
devi˚
->
devid_kobj
);

1887 
	`båfs_w¨n
(
devi˚
->
fs_öfo
,

1889 
devi˚
->
devid
, 
ªt
);

1892 
out
:

1893 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

1894  
ªt
;

1895 
	}
}

1897 
	$båfs_sysfs_add_fs_devi˚s
(
båfs_fs_devi˚s
 *
fs_devi˚s
)

1899 
ªt
;

1900 
båfs_devi˚
 *
devi˚
;

1901 
båfs_fs_devi˚s
 *
£ed
;

1903 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

1904 
ªt
 = 
	`båfs_sysfs_add_devi˚
(
devi˚
);

1905 i‡(
ªt
)

1906 
Áû
;

1909 
	`li°_f‹_óch_íåy
(
£ed
, &
fs_devi˚s
->
£ed_li°
, seed_list) {

1910 
	`li°_f‹_óch_íåy
(
devi˚
, &
£ed
->
devi˚s
, 
dev_li°
) {

1911 
ªt
 = 
	`båfs_sysfs_add_devi˚
(
devi˚
);

1912 i‡(
ªt
)

1913 
Áû
;

1919 
Áû
:

1920 
	`båfs_sysfs_ªmove_fs_devi˚s
(
fs_devi˚s
);

1921  
ªt
;

1922 
	}
}

1924 
	$båfs_kobje˘_uevít
(
block_devi˚
 *
bdev
, 
kobje˘_a˘i⁄
 
a˘i⁄
)

1926 
ªt
;

1928 
ªt
 = 
	`kobje˘_uevít
(&
	`disk_to_dev
(
bdev
->
bd_disk
)->
kobj
, 
a˘i⁄
);

1929 i‡(
ªt
)

1930 
	`¥_w¨n
("BTRFS: SendingÉvent '%d'Åo kobject: '%s' (%p): failed\n",

1931 
a˘i⁄
, 
	`kobje˘_«me
(&
	`disk_to_dev
(
bdev
->
bd_disk
)->
kobj
),

1932 &
	`disk_to_dev
(
bdev
->
bd_disk
)->
kobj
);

1933 
	}
}

1935 
	$båfs_sysfs_upd©e_•rout_fsid
(
båfs_fs_devi˚s
 *
fs_devi˚s
)

1938 
fsid_buf
[
BTRFS_UUID_UNPARSED_SIZE
];

1944 
	`¢¥ötf
(
fsid_buf
, 
BTRFS_UUID_UNPARSED_SIZE
, "%pU", 
fs_devi˚s
->
fsid
);

1945 i‡(
	`kobje˘_ª«me
(&
fs_devi˚s
->
fsid_kobj
, 
fsid_buf
))

1946 
	`båfs_w¨n
(
fs_devi˚s
->
fs_öfo
,

1948 
	}
}

1950 
	$båfs_sysfs_upd©e_devid
(
båfs_devi˚
 *
devi˚
)

1952 
tmp
[24];

1954 
	`¢¥ötf
(
tmp
, —mp), "%Œu", 
devi˚
->
devid
);

1956 i‡(
	`kobje˘_ª«me
(&
devi˚
->
devid_kobj
, 
tmp
))

1957 
	`båfs_w¨n
(
devi˚
->
fs_devi˚s
->
fs_öfo
,

1959 
devi˚
->
devid
);

1960 
	}
}

1963 
k£t
 *
	gbåfs_k£t
;

1971 
	$båfs_sysfs_add_fsid
(
båfs_fs_devi˚s
 *
fs_devs
)

1973 
îr‹
;

1975 
	`öô_com∂ëi⁄
(&
fs_devs
->
kobj_uƒegi°î
);

1976 
fs_devs
->
fsid_kobj
.
k£t
 = 
båfs_k£t
;

1977 
îr‹
 = 
	`kobje˘_öô_™d_add
(&
fs_devs
->
fsid_kobj
, &
båfs_kty≥
, 
NULL
,

1978 "%pU", 
fs_devs
->
fsid
);

1979 i‡(
îr‹
) {

1980 
	`kobje˘_put
(&
fs_devs
->
fsid_kobj
);

1981  
îr‹
;

1984 
fs_devs
->
devi˚s_kobj
 = 
	`kobje˘_¸óã_™d_add
("devices",

1985 &
fs_devs
->
fsid_kobj
);

1986 i‡(!
fs_devs
->
devi˚s_kobj
) {

1987 
	`båfs_îr
(
fs_devs
->
fs_öfo
,

1989 
	`båfs_sysfs_ªmove_fsid
(
fs_devs
);

1990  -
ENOMEM
;

1993 
fs_devs
->
devöfo_kobj
 = 
	`kobje˘_¸óã_™d_add
("devinfo",

1994 &
fs_devs
->
fsid_kobj
);

1995 i‡(!
fs_devs
->
devöfo_kobj
) {

1996 
	`båfs_îr
(
fs_devs
->
fs_öfo
,

1998 
	`båfs_sysfs_ªmove_fsid
(
fs_devs
);

1999  -
ENOMEM
;

2003 
	}
}

2005 
	$båfs_sysfs_add_mou¡ed
(
båfs_fs_öfo
 *
fs_öfo
)

2007 
îr‹
;

2008 
båfs_fs_devi˚s
 *
fs_devs
 = 
fs_öfo
->
fs_devi˚s
;

2009 
kobje˘
 *
fsid_kobj
 = &
fs_devs
->fsid_kobj;

2011 
îr‹
 = 
	`båfs_sysfs_add_fs_devi˚s
(
fs_devs
);

2012 i‡(
îr‹
)

2013  
îr‹
;

2015 
îr‹
 = 
	`sysfs_¸óã_fûes
(
fsid_kobj
, 
båfs_©ås
);

2016 i‡(
îr‹
) {

2017 
	`båfs_sysfs_ªmove_fs_devi˚s
(
fs_devs
);

2018  
îr‹
;

2021 
îr‹
 = 
	`sysfs_¸óã_group
(
fsid_kobj
,

2022 &
båfs_„©uª_©å_group
);

2023 i‡(
îr‹
)

2024 
Áûuª
;

2026 #ifde‡
CONFIG_BTRFS_DEBUG


2027 
fs_öfo
->
debug_kobj
 = 
	`kobje˘_¸óã_™d_add
("debug", 
fsid_kobj
);

2028 i‡(!
fs_öfo
->
debug_kobj
) {

2029 
îr‹
 = -
ENOMEM
;

2030 
Áûuª
;

2033 
îr‹
 = 
	`sysfs_¸óã_fûes
(
fs_öfo
->
debug_kobj
, 
båfs_debug_mou¡_©ås
);

2034 i‡(
îr‹
)

2035 
Áûuª
;

2039 
fs_öfo
->
disˇrd_kobj
 = 
	`kobje˘_¸óã_™d_add
("disˇrd", 
fsid_kobj
);

2040 i‡(!
fs_öfo
->
disˇrd_kobj
) {

2041 
îr‹
 = -
ENOMEM
;

2042 
Áûuª
;

2045 
îr‹
 = 
	`sysfs_¸óã_fûes
(
fs_öfo
->
disˇrd_kobj
, 
disˇrd_©ås
);

2046 i‡(
îr‹
)

2047 
Áûuª
;

2049 
îr‹
 = 
	`addrm_unknown_„©uª_©ås
(
fs_öfo
, 
åue
);

2050 i‡(
îr‹
)

2051 
Áûuª
;

2053 
îr‹
 = 
	`sysfs_¸óã_lök
(
fsid_kobj
, &
fs_öfo
->
sb
->
s_bdi
->
dev
->
kobj
, "bdi");

2054 i‡(
îr‹
)

2055 
Áûuª
;

2057 
fs_öfo
->
•a˚_öfo_kobj
 = 
	`kobje˘_¸óã_™d_add
("allocation",

2058 
fsid_kobj
);

2059 i‡(!
fs_öfo
->
•a˚_öfo_kobj
) {

2060 
îr‹
 = -
ENOMEM
;

2061 
Áûuª
;

2064 
îr‹
 = 
	`sysfs_¸óã_fûes
(
fs_öfo
->
•a˚_öfo_kobj
, 
Æloˇti⁄_©ås
);

2065 i‡(
îr‹
)

2066 
Áûuª
;

2069 
Áûuª
:

2070 
	`båfs_sysfs_ªmove_mou¡ed
(
fs_öfo
);

2071  
îr‹
;

2072 
	}
}

2074 
ssize_t
 
	$qgroup_íabÀd_show
(
kobje˘
 *
qgroups_kobj
,

2075 
kobj_©åibuã
 *
a
,

2076 *
buf
)

2078 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
qgroups_kobj
->
∑ª¡
);

2079 
boﬁ
 
íabÀd
;

2081 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

2082 
íabÀd
 = 
fs_öfo
->
qgroup_Êags
 & 
BTRFS_QGROUP_STATUS_FLAG_ON
;

2083 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

2085  
	`sysfs_emô
(
buf
, "%d\n", 
íabÀd
);

2086 
	}
}

2087 
BTRFS_ATTR
(
qgroups
, 
íabÀd
, 
qgroup_íabÀd_show
);

2089 
ssize_t
 
	$qgroup_öc⁄si°ít_show
(
kobje˘
 *
qgroups_kobj
,

2090 
kobj_©åibuã
 *
a
,

2091 *
buf
)

2093 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
qgroups_kobj
->
∑ª¡
);

2094 
boﬁ
 
öc⁄si°ít
;

2096 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

2097 
öc⁄si°ít
 = (
fs_öfo
->
qgroup_Êags
 & 
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
);

2098 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

2100  
	`sysfs_emô
(
buf
, "%d\n", 
öc⁄si°ít
);

2101 
	}
}

2102 
BTRFS_ATTR
(
qgroups
, 
öc⁄si°ít
, 
qgroup_öc⁄si°ít_show
);

2104 
ssize_t
 
	$qgroup_dr›_subåì_thªs_show
(
kobje˘
 *
qgroups_kobj
,

2105 
kobj_©åibuã
 *
a
,

2106 *
buf
)

2108 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
qgroups_kobj
->
∑ª¡
);

2109 
u8
 
ªsu…
;

2111 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

2112 
ªsu…
 = 
fs_öfo
->
qgroup_dr›_subåì_thªs
;

2113 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

2115  
	`sysfs_emô
(
buf
, "%d\n", 
ªsu…
);

2116 
	}
}

2118 
ssize_t
 
	$qgroup_dr›_subåì_thªs_°‹e
(
kobje˘
 *
qgroups_kobj
,

2119 
kobj_©åibuã
 *
a
,

2120 c⁄° *
buf
, 
size_t
 
Àn
)

2122 
båfs_fs_öfo
 *
fs_öfo
 = 
	`to_fs_öfo
(
qgroups_kobj
->
∑ª¡
);

2123 
u8
 
√w_thªs
;

2124 
ªt
;

2126 
ªt
 = 
	`k°πou8
(
buf
, 10, &
√w_thªs
);

2127 i‡(
ªt
)

2128  -
EINVAL
;

2130 i‡(
√w_thªs
 > 
BTRFS_MAX_LEVEL
)

2131  -
EINVAL
;

2133 
	`•ö_lock
(&
fs_öfo
->
qgroup_lock
);

2134 
fs_öfo
->
qgroup_dr›_subåì_thªs
 = 
√w_thªs
;

2135 
	`•ö_u∆ock
(&
fs_öfo
->
qgroup_lock
);

2137  
Àn
;

2138 
	}
}

2139 
BTRFS_ATTR_RW
(
qgroups
, 
dr›_subåì_thªshﬁd
, 
qgroup_dr›_subåì_thªs_show
,

2140 
qgroup_dr›_subåì_thªs_°‹e
);

2147 
©åibuã
 *
	gqgroups_©ås
[] = {

2148 
BTRFS_ATTR_PTR
(
qgroups
, 
íabÀd
),

2149 
BTRFS_ATTR_PTR
(
qgroups
, 
öc⁄si°ít
),

2150 
BTRFS_ATTR_PTR
(
qgroups
, 
dr›_subåì_thªshﬁd
),

2151 
NULL


2153 
ATTRIBUTE_GROUPS
(
qgroups
);

2155 
	$qgroups_ªÀa£
(
kobje˘
 *
kobj
)

2157 
	`k‰ì
(
kobj
);

2158 
	}
}

2160 c⁄° 
kobj_ty≥
 
	gqgroups_kty≥
 = {

2161 .
sysfs_›s
 = &
kobj_sysfs_›s
,

2162 .
	gdeÁu…_groups
 = 
qgroups_groups
,

2163 .
	gªÀa£
 = 
qgroups_ªÀa£
,

2166 
ölöe
 
båfs_fs_öfo
 *
	$qgroup_kobj_to_fs_öfo
(
kobje˘
 *
kobj
)

2168  
	`to_fs_öfo
(
kobj
->
∑ª¡
->parent);

2169 
	}
}

2171 
	#QGROUP_ATTR
(
_membî
, 
_show_«me
) \

2172 
ssize_t
 
båfs_qgroup_show_
##
	`_membî
(
kobje˘
 *
qgroup_kobj
, \

2173 
kobj_©åibuã
 *
a
, \

2174 *
buf
) \

2176 
båfs_fs_öfo
 *
fs_öfo
 = 
	`qgroup_kobj_to_fs_öfo
(
qgroup_kobj
); \

2177 
båfs_qgroup
 *
qgroup
 = 
	`c⁄èöî_of
(
qgroup_kobj
, \

2178 
båfs_qgroup
, 
kobj
); \

2179  
	`båfs_show_u64
(&
qgroup
->
_membî
, &
fs_öfo
->
qgroup_lock
, 
buf
); \

2181 
	`BTRFS_ATTR
(
qgroup
, 
_show_«me
, 
båfs_qgroup_show_
##
_membî
)

	)

2183 
	#QGROUP_RSV_ATTR
(
_«me
, 
_ty≥
) \

2184 
ssize_t
 
båfs_qgroup_rsv_show_
##
	`_«me
(
kobje˘
 *
qgroup_kobj
, \

2185 
kobj_©åibuã
 *
a
, \

2186 *
buf
) \

2188 
båfs_fs_öfo
 *
fs_öfo
 = 
	`qgroup_kobj_to_fs_öfo
(
qgroup_kobj
); \

2189 
båfs_qgroup
 *
qgroup
 = 
	`c⁄èöî_of
(
qgroup_kobj
, \

2190 
båfs_qgroup
, 
kobj
); \

2191  
	`båfs_show_u64
(&
qgroup
->
rsv
.
vÆues
[
_ty≥
], \

2192 &
fs_öfo
->
qgroup_lock
, 
buf
); \

2194 
	`BTRFS_ATTR
(
qgroup
, 
rsv_
##
_«me
, 
båfs_qgroup_rsv_show_
##_«me)

	)

2196 
QGROUP_ATTR
(
r„r
, 
ª„ªn˚d
);

2197 
QGROUP_ATTR
(
ex˛
, 
ex˛usive
);

2198 
QGROUP_ATTR
(
max_r„r
, 
max_ª„ªn˚d
);

2199 
QGROUP_ATTR
(
max_ex˛
, 
max_ex˛usive
);

2200 
QGROUP_ATTR
(
lim_Êags
, 
limô_Êags
);

2201 
QGROUP_RSV_ATTR
(
d©a
, 
BTRFS_QGROUP_RSV_DATA
);

2202 
QGROUP_RSV_ATTR
(
mëa_≥πøns
, 
BTRFS_QGROUP_RSV_META_PERTRANS
);

2203 
QGROUP_RSV_ATTR
(
mëa_¥óŒoc
, 
BTRFS_QGROUP_RSV_META_PREALLOC
);

2210 
©åibuã
 *
	gqgroup_©ås
[] = {

2211 
BTRFS_ATTR_PTR
(
qgroup
, 
ª„ªn˚d
),

2212 
BTRFS_ATTR_PTR
(
qgroup
, 
ex˛usive
),

2213 
BTRFS_ATTR_PTR
(
qgroup
, 
max_ª„ªn˚d
),

2214 
BTRFS_ATTR_PTR
(
qgroup
, 
max_ex˛usive
),

2215 
BTRFS_ATTR_PTR
(
qgroup
, 
limô_Êags
),

2216 
BTRFS_ATTR_PTR
(
qgroup
, 
rsv_d©a
),

2217 
BTRFS_ATTR_PTR
(
qgroup
, 
rsv_mëa_≥πøns
),

2218 
BTRFS_ATTR_PTR
(
qgroup
, 
rsv_mëa_¥óŒoc
),

2219 
NULL


2221 
ATTRIBUTE_GROUPS
(
qgroup
);

2223 
	$qgroup_ªÀa£
(
kobje˘
 *
kobj
)

2225 
båfs_qgroup
 *
qgroup
 = 
	`c⁄èöî_of
(
kobj
, btrfs_qgroup, kobj);

2227 
	`mem£t
(&
qgroup
->
kobj
, 0, (*kobj));

2228 
	}
}

2230 c⁄° 
kobj_ty≥
 
	gqgroup_kty≥
 = {

2231 .
sysfs_›s
 = &
kobj_sysfs_›s
,

2232 .
	gªÀa£
 = 
qgroup_ªÀa£
,

2233 .
	gdeÁu…_groups
 = 
qgroup_groups
,

2236 
	$båfs_sysfs_add_⁄e_qgroup
(
båfs_fs_öfo
 *
fs_öfo
,

2237 
båfs_qgroup
 *
qgroup
)

2239 
kobje˘
 *
qgroups_kobj
 = 
fs_öfo
->qgroups_kobj;

2240 
ªt
;

2242 i‡(
	`ã°_bô
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_öfo
->
fs_°©e
))

2244 i‡(
qgroup
->
kobj
.
°©e_öôülized
)

2246 i‡(!
qgroups_kobj
)

2247  -
EINVAL
;

2249 
ªt
 = 
	`kobje˘_öô_™d_add
(&
qgroup
->
kobj
, &
qgroup_kty≥
, 
qgroups_kobj
,

2250 "%hu_%Œu", 
	`båfs_qgroup_Àvñ
(
qgroup
->
qgroupid
),

2251 
	`båfs_qgroup_subvﬁid
(
qgroup
->
qgroupid
));

2252 i‡(
ªt
 < 0)

2253 
	`kobje˘_put
(&
qgroup
->
kobj
);

2255  
ªt
;

2256 
	}
}

2258 
	$båfs_sysfs_dñ_qgroups
(
båfs_fs_öfo
 *
fs_öfo
)

2260 
båfs_qgroup
 *
qgroup
;

2261 
båfs_qgroup
 *
√xt
;

2263 i‡(
	`ã°_bô
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_öfo
->
fs_°©e
))

2266 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
qgroup
, 
√xt
,

2267 &
fs_öfo
->
qgroup_åì
, 
node
)

2268 
	`båfs_sysfs_dñ_⁄e_qgroup
(
fs_öfo
, 
qgroup
);

2269 i‡(
fs_öfo
->
qgroups_kobj
) {

2270 
	`kobje˘_dñ
(
fs_öfo
->
qgroups_kobj
);

2271 
	`kobje˘_put
(
fs_öfo
->
qgroups_kobj
);

2272 
fs_öfo
->
qgroups_kobj
 = 
NULL
;

2274 
	}
}

2277 
	$båfs_sysfs_add_qgroups
(
båfs_fs_öfo
 *
fs_öfo
)

2279 
kobje˘
 *
fsid_kobj
 = &
fs_öfo
->
fs_devi˚s
->fsid_kobj;

2280 
båfs_qgroup
 *
qgroup
;

2281 
båfs_qgroup
 *
√xt
;

2282 
ªt
 = 0;

2284 i‡(
	`ã°_bô
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_öfo
->
fs_°©e
))

2287 
	`ASSERT
(
fsid_kobj
);

2288 i‡(
fs_öfo
->
qgroups_kobj
)

2291 
fs_öfo
->
qgroups_kobj
 = 
	`kzÆloc
((
kobje˘
), 
GFP_KERNEL
);

2292 i‡(!
fs_öfo
->
qgroups_kobj
)

2293  -
ENOMEM
;

2295 
ªt
 = 
	`kobje˘_öô_™d_add
(
fs_öfo
->
qgroups_kobj
, &
qgroups_kty≥
,

2296 
fsid_kobj
, "qgroups");

2297 i‡(
ªt
 < 0)

2298 
out
;

2300 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
qgroup
, 
√xt
,

2301 &
fs_öfo
->
qgroup_åì
, 
node
) {

2302 
ªt
 = 
	`båfs_sysfs_add_⁄e_qgroup
(
fs_öfo
, 
qgroup
);

2303 i‡(
ªt
 < 0)

2304 
out
;

2307 
out
:

2308 i‡(
ªt
 < 0)

2309 
	`båfs_sysfs_dñ_qgroups
(
fs_öfo
);

2310  
ªt
;

2311 
	}
}

2313 
	$båfs_sysfs_dñ_⁄e_qgroup
(
båfs_fs_öfo
 *
fs_öfo
,

2314 
båfs_qgroup
 *
qgroup
)

2316 i‡(
	`ã°_bô
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_öfo
->
fs_°©e
))

2319 i‡(
qgroup
->
kobj
.
°©e_öôülized
) {

2320 
	`kobje˘_dñ
(&
qgroup
->
kobj
);

2321 
	`kobje˘_put
(&
qgroup
->
kobj
);

2323 
	}
}

2329 
	$båfs_sysfs_„©uª_upd©e
(
båfs_fs_öfo
 *
fs_öfo
)

2331 
kobje˘
 *
fsid_kobj
;

2332 
ªt
;

2334 i‡(!
fs_öfo
)

2337 
fsid_kobj
 = &
fs_öfo
->
fs_devi˚s
->fsid_kobj;

2338 i‡(!
fsid_kobj
->
°©e_öôülized
)

2341 
ªt
 = 
	`sysfs_upd©e_group
(
fsid_kobj
, &
båfs_„©uª_©å_group
);

2342 i‡(
ªt
 < 0)

2343 
	`båfs_w¨n
(
fs_öfo
,

2345 
fs_öfo
->
fs_devi˚s
->
fsid
, 
ªt
);

2346 
	}
}

2348 
__öô
 
	$båfs_öô_sysfs
()

2350 
ªt
;

2352 
båfs_k£t
 = 
	`k£t_¸óã_™d_add
("båfs", 
NULL
, 
fs_kobj
);

2353 i‡(!
båfs_k£t
)

2354  -
ENOMEM
;

2356 
	`öô_„©uª_©ås
();

2357 
ªt
 = 
	`sysfs_¸óã_group
(&
båfs_k£t
->
kobj
, &
båfs_„©uª_©å_group
);

2358 i‡(
ªt
)

2359 
out2
;

2360 
ªt
 = 
	`sysfs_mîge_group
(&
båfs_k£t
->
kobj
,

2361 &
båfs_°©ic_„©uª_©å_group
);

2362 i‡(
ªt
)

2363 
out_ªmove_group
;

2365 #ifde‡
CONFIG_BTRFS_DEBUG


2366 
ªt
 = 
	`sysfs_¸óã_group
(&
båfs_k£t
->
kobj
, &
båfs_debug_„©uª_©å_group
);

2367 i‡(
ªt
) {

2368 
	`sysfs_unmîge_group
(&
båfs_k£t
->
kobj
,

2369 &
båfs_°©ic_„©uª_©å_group
);

2370 
out_ªmove_group
;

2376 
out_ªmove_group
:

2377 
	`sysfs_ªmove_group
(&
båfs_k£t
->
kobj
, &
båfs_„©uª_©å_group
);

2378 
out2
:

2379 
	`k£t_uƒegi°î
(
båfs_k£t
);

2381  
ªt
;

2382 
	}
}

2384 
__cﬁd
 
	$båfs_exô_sysfs
()

2386 
	`sysfs_unmîge_group
(&
båfs_k£t
->
kobj
,

2387 &
båfs_°©ic_„©uª_©å_group
);

2388 
	`sysfs_ªmove_group
(&
båfs_k£t
->
kobj
, &
båfs_„©uª_©å_group
);

2389 #ifde‡
CONFIG_BTRFS_DEBUG


2390 
	`sysfs_ªmove_group
(&
båfs_k£t
->
kobj
, &
båfs_debug_„©uª_©å_group
);

2392 
	`k£t_uƒegi°î
(
båfs_k£t
);

2393 
	}
}

	@sysfs.h

3 #i‚de‡
BTRFS_SYSFS_H


4 
	#BTRFS_SYSFS_H


	)

6 
	~<löux/kobje˘.h
>

8 
	ebåfs_„©uª_£t
 {

9 
	mFEAT_COMPAT
,

10 
	mFEAT_COMPAT_RO
,

11 
	mFEAT_INCOMPAT
,

12 
	mFEAT_MAX


15 *
båfs_¥öèbÀ_„©uªs
(
båfs_„©uª_£t
 
£t
, 
u64
 
Êags
);

16 c⁄° *
båfs_„©uª_£t_«me
(
båfs_„©uª_£t
 
£t
);

17 
båfs_sysfs_add_devi˚
(
båfs_devi˚
 *
devi˚
);

18 
båfs_sysfs_ªmove_devi˚
(
båfs_devi˚
 *
devi˚
);

19 
båfs_sysfs_add_fsid
(
båfs_fs_devi˚s
 *
fs_devs
);

20 
båfs_sysfs_ªmove_fsid
(
båfs_fs_devi˚s
 *
fs_devs
);

21 
båfs_sysfs_upd©e_•rout_fsid
(
båfs_fs_devi˚s
 *
fs_devi˚s
);

22 
båfs_sysfs_„©uª_upd©e
(
båfs_fs_öfo
 *
fs_öfo
);

23 
båfs_kobje˘_uevít
(
block_devi˚
 *
bdev
, 
kobje˘_a˘i⁄
 
a˘i⁄
);

25 
__öô
 
båfs_öô_sysfs
();

26 
__cﬁd
 
båfs_exô_sysfs
();

27 
båfs_sysfs_add_mou¡ed
(
båfs_fs_öfo
 *
fs_öfo
);

28 
båfs_sysfs_ªmove_mou¡ed
(
båfs_fs_öfo
 *
fs_öfo
);

29 
båfs_sysfs_add_block_group_ty≥
(
båfs_block_group
 *
ˇche
);

30 
båfs_sysfs_add_•a˚_öfo_ty≥
(
båfs_fs_öfo
 *
fs_öfo
,

31 
båfs_•a˚_öfo
 *
•a˚_öfo
);

32 
båfs_sysfs_ªmove_•a˚_öfo
(
båfs_•a˚_öfo
 *
•a˚_öfo
);

33 
båfs_sysfs_upd©e_devid
(
båfs_devi˚
 *
devi˚
);

35 
båfs_sysfs_add_⁄e_qgroup
(
båfs_fs_öfo
 *
fs_öfo
,

36 
båfs_qgroup
 *
qgroup
);

37 
båfs_sysfs_dñ_qgroups
(
båfs_fs_öfo
 *
fs_öfo
);

38 
båfs_sysfs_add_qgroups
(
båfs_fs_öfo
 *
fs_öfo
);

39 
båfs_sysfs_dñ_⁄e_qgroup
(
båfs_fs_öfo
 *
fs_öfo
,

40 
båfs_qgroup
 *
qgroup
);

	@tests/btrfs-tests.c

6 
	~<löux/fs.h
>

7 
	~<löux/mou¡.h
>

8 
	~<löux/p£udo_fs.h
>

9 
	~<löux/magic.h
>

10 
	~"båfs-ã°s.h
"

11 
	~"../˘ªe.h
"

12 
	~"../‰ì-•a˚-ˇche.h
"

13 
	~"../‰ì-•a˚-åì.h
"

14 
	~"../å™ß˘i⁄.h
"

15 
	~"../vﬁumes.h
"

16 
	~"../disk-io.h
"

17 
	~"../qgroup.h
"

18 
	~"../block-group.h
"

19 
	~"../fs.h
"

21 
vfsmou¡
 *
	gã°_m¡
 = 
NULL
;

23 c⁄° *
	gã°_îr‹
[] = {

24 [
TEST_ALLOC_FS_INFO
] = "cannotállocate fs_info",

25 [
TEST_ALLOC_ROOT
] = "cannotállocateÑoot",

26 [
TEST_ALLOC_EXTENT_BUFFER
] = "cannotÉxtent buffer",

27 [
TEST_ALLOC_PATH
] = "cannotállocateÖath",

28 [
TEST_ALLOC_INODE
] = "cannotállocate inode",

29 [
TEST_ALLOC_BLOCK_GROUP
] = "cannotállocate block group",

30 [
TEST_ALLOC_EXTENT_MAP
] = "cannotállocateÉxtent map",

33 c⁄° 
su≥r_›î©i⁄s
 
	gbåfs_ã°_su≥r_›s
 = {

34 .
Æloc_öode
 = 
båfs_Æloc_öode
,

35 .
	gde°roy_öode
 = 
båfs_ã°_de°roy_öode
,

39 
	$båfs_ã°_öô_fs_c⁄ãxt
(
fs_c⁄ãxt
 *
fc
)

41 
p£udo_fs_c⁄ãxt
 *
˘x
 = 
	`öô_p£udo
(
fc
, 
BTRFS_TEST_MAGIC
);

42 i‡(!
˘x
)

43  -
ENOMEM
;

44 
˘x
->
›s
 = &
båfs_ã°_su≥r_›s
;

46 
	}
}

48 
fûe_sy°em_ty≥
 
	gã°_ty≥
 = {

49 .
«me
 = "btrfs_test_fs",

50 .
	göô_fs_c⁄ãxt
 = 
båfs_ã°_öô_fs_c⁄ãxt
,

51 .
	gkûl_sb
 = 
kûl_™⁄_su≥r
,

54 
öode
 *
	$båfs_√w_ã°_öode
()

56 
öode
 *inode;

58 
öode
 = 
	`√w_öode
(
ã°_m¡
->
m¡_sb
);

59 i‡(!
öode
)

60  
NULL
;

62 
öode
->
i_mode
 = 
S_IFREG
;

63 
öode
->
i_öo
 = 
BTRFS_FIRST_FREE_OBJECTID
;

64 
	`BTRFS_I
(
öode
)->
loˇti⁄
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

65 
	`BTRFS_I
(
öode
)->
loˇti⁄
.
obje˘id
 = 
BTRFS_FIRST_FREE_OBJECTID
;

66 
	`BTRFS_I
(
öode
)->
loˇti⁄
.
off£t
 = 0;

67 
	`öode_öô_ow√r
(&
n›_m¡_idm≠
, 
öode
, 
NULL
, 
S_IFREG
);

69  
öode
;

70 
	}
}

72 
	$båfs_öô_ã°_fs
()

74 
ªt
;

76 
ªt
 = 
	`ªgi°î_fûesy°em
(&
ã°_ty≥
);

77 i‡(
ªt
) {

78 
	`¥ötk
(
KERN_ERR
 "btrfs: cannotÑegisterÅest file system\n");

79  
ªt
;

82 
ã°_m¡
 = 
	`kîn_mou¡
(&
ã°_ty≥
);

83 i‡(
	`IS_ERR
(
ã°_m¡
)) {

84 
	`¥ötk
(
KERN_ERR
 "btrfs: cannot mountÅest file system\n");

85 
	`uƒegi°î_fûesy°em
(&
ã°_ty≥
);

86  
	`PTR_ERR
(
ã°_m¡
);

89 
	}
}

91 
	$båfs_de°roy_ã°_fs
()

93 
	`kîn_unmou¡
(
ã°_m¡
);

94 
	`uƒegi°î_fûesy°em
(&
ã°_ty≥
);

95 
	}
}

97 
båfs_devi˚
 *
	$båfs_Æloc_dummy_devi˚
(
båfs_fs_öfo
 *
fs_öfo
)

99 
båfs_devi˚
 *
dev
;

101 
dev
 = 
	`kzÆloc
((*dev), 
GFP_KERNEL
);

102 i‡(!
dev
)

103  
	`ERR_PTR
(-
ENOMEM
);

105 
	`exã¡_io_åì_öô
(
NULL
, &
dev
->
Æloc_°©e
, 0);

106 
	`INIT_LIST_HEAD
(&
dev
->
dev_li°
);

107 
	`li°_add
(&
dev
->
dev_li°
, &
fs_öfo
->
fs_devi˚s
->
devi˚s
);

109  
dev
;

110 
	}
}

112 
	$båfs_‰ì_dummy_devi˚
(
båfs_devi˚
 *
dev
)

114 
	`exã¡_io_åì_ªÀa£
(&
dev
->
Æloc_°©e
);

115 
	`k‰ì
(
dev
);

116 
	}
}

118 
båfs_fs_öfo
 *
	$båfs_Æloc_dummy_fs_öfo
(
u32
 
nodesize
, u32 
£˘‹size
)

120 
båfs_fs_öfo
 *
fs_öfo
 = 
	`kzÆloc
((btrfs_fs_info),

121 
GFP_KERNEL
);

123 i‡(!
fs_öfo
)

124  
fs_öfo
;

125 
fs_öfo
->
fs_devi˚s
 = 
	`kzÆloc
((
båfs_fs_devi˚s
),

126 
GFP_KERNEL
);

127 i‡(!
fs_öfo
->
fs_devi˚s
) {

128 
	`k‰ì
(
fs_öfo
);

129  
NULL
;

131 
	`INIT_LIST_HEAD
(&
fs_öfo
->
fs_devi˚s
->
devi˚s
);

133 
fs_öfo
->
su≥r_c›y
 = 
	`kzÆloc
((
båfs_su≥r_block
),

134 
GFP_KERNEL
);

135 i‡(!
fs_öfo
->
su≥r_c›y
) {

136 
	`k‰ì
(
fs_öfo
->
fs_devi˚s
);

137 
	`k‰ì
(
fs_öfo
);

138  
NULL
;

141 
	`båfs_öô_fs_öfo
(
fs_öfo
);

143 
fs_öfo
->
nodesize
 =Çodesize;

144 
fs_öfo
->
£˘‹size
 = sectorsize;

145 
fs_öfo
->
£˘‹size_bôs
 = 
	`ûog2
(
£˘‹size
);

146 
	`£t_bô
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_öfo
->
fs_°©e
);

148 
ã°_m¡
->
m¡_sb
->
s_fs_öfo
 = 
fs_öfo
;

150  
fs_öfo
;

151 
	}
}

153 
	$båfs_‰ì_dummy_fs_öfo
(
båfs_fs_öfo
 *
fs_öfo
)

155 
ødix_åì_ôî
 
ôî
;

156 **
¶Ÿ
;

157 
båfs_devi˚
 *
dev
, *
tmp
;

159 i‡(!
fs_öfo
)

162 i‡(
	`WARN_ON
(!
	`ã°_bô
(
BTRFS_FS_STATE_DUMMY_FS_INFO
,

163 &
fs_öfo
->
fs_°©e
)))

166 
ã°_m¡
->
m¡_sb
->
s_fs_öfo
 = 
NULL
;

168 
	`•ö_lock
(&
fs_öfo
->
buf„r_lock
);

169 
	`ødix_åì_f‹_óch_¶Ÿ
(
¶Ÿ
, &
fs_öfo
->
buf„r_ødix
, &
ôî
, 0) {

170 
exã¡_buf„r
 *
eb
;

172 
eb
 = 
	`ødix_åì_dîef_¶Ÿ_¥Ÿe˘ed
(
¶Ÿ
, &
fs_öfo
->
buf„r_lock
);

173 i‡(!
eb
)

176 i‡(
	`ødix_åì_ex˚±i⁄
(
eb
)) {

177 i‡(
	`ødix_åì_dîef_ªåy
(
eb
))

178 
¶Ÿ
 = 
	`ødix_åì_ôî_ªåy
(&
ôî
);

181 
¶Ÿ
 = 
	`ødix_åì_ôî_ªsume
(¶Ÿ, &
ôî
);

182 
	`•ö_u∆ock
(&
fs_öfo
->
buf„r_lock
);

183 
	`‰ì_exã¡_buf„r_°Æe
(
eb
);

184 
	`•ö_lock
(&
fs_öfo
->
buf„r_lock
);

186 
	`•ö_u∆ock
(&
fs_öfo
->
buf„r_lock
);

188 
	`båfs_m≠pög_åì_‰ì
(&
fs_öfo
->
m≠pög_åì
);

189 
	`li°_f‹_óch_íåy_ß„
(
dev
, 
tmp
, &
fs_öfo
->
fs_devi˚s
->
devi˚s
,

190 
dev_li°
) {

191 
	`båfs_‰ì_dummy_devi˚
(
dev
);

193 
	`båfs_‰ì_qgroup_c⁄fig
(
fs_öfo
);

194 
	`båfs_‰ì_fs_roŸs
(
fs_öfo
);

195 
	`k‰ì
(
fs_öfo
->
su≥r_c›y
);

196 
	`båfs_check_Àaked_roŸs
(
fs_öfo
);

197 
	`båfs_exã¡_buf„r_Àak_debug_check
(
fs_öfo
);

198 
	`k‰ì
(
fs_öfo
->
fs_devi˚s
);

199 
	`k‰ì
(
fs_öfo
);

200 
	}
}

202 
	$båfs_‰ì_dummy_roŸ
(
båfs_roŸ
 *
roŸ
)

204 i‡(
	`IS_ERR_OR_NULL
(
roŸ
))

207 i‡(
	`WARN_ON
(
	`ã°_bô
(
BTRFS_ROOT_IN_RADIX
, &
roŸ
->
°©e
)))

209 
	`båfs_globÆ_roŸ_dñëe
(
roŸ
);

210 
	`båfs_put_roŸ
(
roŸ
);

211 
	}
}

213 
båfs_block_group
 *

214 
	$båfs_Æloc_dummy_block_group
(
båfs_fs_öfo
 *
fs_öfo
,

215 
Àngth
)

217 
båfs_block_group
 *
ˇche
;

219 
ˇche
 = 
	`kzÆloc
((*ˇche), 
GFP_KERNEL
);

220 i‡(!
ˇche
)

221  
NULL
;

222 
ˇche
->
‰ì_•a˚_˘l
 = 
	`kzÆloc
((*cache->free_space_ctl),

223 
GFP_KERNEL
);

224 i‡(!
ˇche
->
‰ì_•a˚_˘l
) {

225 
	`k‰ì
(
ˇche
);

226  
NULL
;

229 
ˇche
->
°¨t
 = 0;

230 
ˇche
->
Àngth
 =Üength;

231 
ˇche
->
fuŒ_°rùe_Àn
 = 
fs_öfo
->
£˘‹size
;

232 
ˇche
->
fs_öfo
 = fs_info;

234 
	`INIT_LIST_HEAD
(&
ˇche
->
li°
);

235 
	`INIT_LIST_HEAD
(&
ˇche
->
˛u°î_li°
);

236 
	`INIT_LIST_HEAD
(&
ˇche
->
bg_li°
);

237 
	`båfs_öô_‰ì_•a˚_˘l
(
ˇche
, cache->
‰ì_•a˚_˘l
);

238 
	`muãx_öô
(&
ˇche
->
‰ì_•a˚_lock
);

240  
ˇche
;

241 
	}
}

243 
	$båfs_‰ì_dummy_block_group
(
båfs_block_group
 *
ˇche
)

245 i‡(!
ˇche
)

247 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
ˇche
);

248 
	`k‰ì
(
ˇche
->
‰ì_•a˚_˘l
);

249 
	`k‰ì
(
ˇche
);

250 
	}
}

252 
	$båfs_öô_dummy_å™s
(
båfs_å™s_h™dÀ
 *
å™s
,

253 
båfs_fs_öfo
 *
fs_öfo
)

255 
	`mem£t
(
å™s
, 0, (*trans));

256 
å™s
->
å™sid
 = 1;

257 
å™s
->
ty≥
 = 
__TRANS_DUMMY
;

258 
å™s
->
fs_öfo
 = fs_info;

259 
	}
}

261 
	$båfs_run_ßnôy_ã°s
()

263 
ªt
, 
i
;

264 
u32
 
£˘‹size
, 
nodesize
;

265 
u32
 
ã°_£˘‹size
[] = {

266 
PAGE_SIZE
,

268 
ªt
 = 
	`båfs_öô_ã°_fs
();

269 i‡(
ªt
)

270  
ªt
;

271 
i
 = 0; i < 
	`ARRAY_SIZE
(
ã°_£˘‹size
); i++) {

272 
£˘‹size
 = 
ã°_£˘‹size
[
i
];

273 
nodesize
 = 
£˘‹size
;

274 
nodesize
 <
BTRFS_MAX_METADATA_BLOCKSIZE
;

275 
nodesize
 <<= 1) {

276 
	`¥_öfo
("BTRFS: selftest: sectorsize: %uÇodesize: %u\n",

277 
£˘‹size
, 
nodesize
);

278 
ªt
 = 
	`båfs_ã°_‰ì_•a˚_ˇche
(
£˘‹size
, 
nodesize
);

279 i‡(
ªt
)

280 
out
;

281 
ªt
 = 
	`båfs_ã°_exã¡_buf„r_›î©i⁄s
(
£˘‹size
,

282 
nodesize
);

283 i‡(
ªt
)

284 
out
;

285 
ªt
 = 
	`båfs_ã°_exã¡_io
(
£˘‹size
, 
nodesize
);

286 i‡(
ªt
)

287 
out
;

288 
ªt
 = 
	`båfs_ã°_öodes
(
£˘‹size
, 
nodesize
);

289 i‡(
ªt
)

290 
out
;

291 
ªt
 = 
	`båfs_ã°_qgroups
(
£˘‹size
, 
nodesize
);

292 i‡(
ªt
)

293 
out
;

294 
ªt
 = 
	`båfs_ã°_‰ì_•a˚_åì
(
£˘‹size
, 
nodesize
);

295 i‡(
ªt
)

296 
out
;

299 
ªt
 = 
	`båfs_ã°_exã¡_m≠
();

301 
out
:

302 
	`båfs_de°roy_ã°_fs
();

303  
ªt
;

304 
	}
}

	@tests/btrfs-tests.h

6 #i‚de‡
BTRFS_TESTS_H


7 
	#BTRFS_TESTS_H


	)

9 #ifde‡
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


10 
båfs_run_ßnôy_ã°s
();

12 
	#ã°_msg
(
fmt
, ...Ë
	`¥_öfo
("BTRFS: sñ·e°: " fmà"\n", ##
__VA_ARGS__
)

	)

13 
	#ã°_îr
(
fmt
, ...Ë
	`¥_îr
("BTRFS: selftest: %s:%d " fmt "\n", \

14 
__FILE__
, 
__LINE__
, ##
__VA_ARGS__
)

	)

16 
	#ã°_°d_îr
(
ödex
Ë
	`ã°_îr
("%s", 
ã°_îr‹
[ödex])

	)

19 
	mTEST_ALLOC_FS_INFO
,

20 
	mTEST_ALLOC_ROOT
,

21 
	mTEST_ALLOC_EXTENT_BUFFER
,

22 
	mTEST_ALLOC_PATH
,

23 
	mTEST_ALLOC_INODE
,

24 
	mTEST_ALLOC_BLOCK_GROUP
,

25 
	mTEST_ALLOC_EXTENT_MAP
,

28 c⁄° *
ã°_îr‹
[];

30 
	gbåfs_roŸ
;

31 
	gbåfs_å™s_h™dÀ
;

33 
båfs_ã°_exã¡_buf„r_›î©i⁄s
(
u32
 
£˘‹size
, u32 
nodesize
);

34 
båfs_ã°_‰ì_•a˚_ˇche
(
u32
 
£˘‹size
, u32 
nodesize
);

35 
båfs_ã°_exã¡_io
(
u32
 
£˘‹size
, u32 
nodesize
);

36 
båfs_ã°_öodes
(
u32
 
£˘‹size
, u32 
nodesize
);

37 
båfs_ã°_qgroups
(
u32
 
£˘‹size
, u32 
nodesize
);

38 
båfs_ã°_‰ì_•a˚_åì
(
u32
 
£˘‹size
, u32 
nodesize
);

39 
båfs_ã°_exã¡_m≠
();

40 
öode
 *
båfs_√w_ã°_öode
();

41 
båfs_fs_öfo
 *
båfs_Æloc_dummy_fs_öfo
(
u32
 
nodesize
, u32 
£˘‹size
);

42 
båfs_‰ì_dummy_fs_öfo
(
båfs_fs_öfo
 *
fs_öfo
);

43 
båfs_‰ì_dummy_roŸ
(
båfs_roŸ
 *
roŸ
);

44 
båfs_block_group
 *

45 
båfs_Æloc_dummy_block_group
(
båfs_fs_öfo
 *
fs_öfo
, 
Àngth
);

46 
båfs_‰ì_dummy_block_group
(
båfs_block_group
 *
ˇche
);

47 
båfs_öô_dummy_å™s
(
båfs_å™s_h™dÀ
 *
å™s
,

48 
båfs_fs_öfo
 *
fs_öfo
);

49 
båfs_devi˚
 *
båfs_Æloc_dummy_devi˚
(
båfs_fs_öfo
 *
fs_öfo
);

51 
ölöe
 
	$båfs_run_ßnôy_ã°s
()

54 
	}
}

	@tests/extent-buffer-tests.c

6 
	~<löux/¶ab.h
>

7 
	~"båfs-ã°s.h
"

8 
	~"../˘ªe.h
"

9 
	~"../exã¡_io.h
"

10 
	~"../disk-io.h
"

11 
	~"../ac˚ss‹s.h
"

13 
	$ã°_båfs_•lô_ôem
(
u32
 
£˘‹size
, u32 
nodesize
)

15 
båfs_fs_öfo
 *
fs_öfo
;

16 
båfs_∑th
 *
∑th
 = 
NULL
;

17 
båfs_roŸ
 *
roŸ
 = 
NULL
;

18 
exã¡_buf„r
 *
eb
;

19 *
vÆue
 = "mary hadáÜittleÜamb";

20 *
•lô1
 = "mary hadáÜittle";

21 *
•lô2
 = "Üamb";

22 *
•lô3
 = "mary";

23 *
•lô4
 = " hadáÜittle";

24 
buf
[32];

25 
båfs_key
 
key
;

26 
u32
 
vÆue_Àn
 = 
	`°æí
(
vÆue
);

27 
ªt
 = 0;

29 
	`ã°_msg
("running btrfs_split_itemÅests");

31 
fs_öfo
 = 
	`båfs_Æloc_dummy_fs_öfo
(
nodesize
, 
£˘‹size
);

32 i‡(!
fs_öfo
) {

33 
	`ã°_°d_îr
(
TEST_ALLOC_FS_INFO
);

34  -
ENOMEM
;

37 
roŸ
 = 
	`båfs_Æloc_dummy_roŸ
(
fs_öfo
);

38 i‡(
	`IS_ERR
(
roŸ
)) {

39 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

40 
ªt
 = 
	`PTR_ERR
(
roŸ
);

41 
out
;

44 
∑th
 = 
	`båfs_Æloc_∑th
();

45 i‡(!
∑th
) {

46 
	`ã°_°d_îr
(
TEST_ALLOC_PATH
);

47 
ªt
 = -
ENOMEM
;

48 
out
;

51 
eb
 = 
	`Æloc_dummy_exã¡_buf„r
(
fs_öfo
, 
nodesize
);

52 
∑th
->
nodes
[0] = 
eb
;

53 i‡(!
eb
) {

54 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_BUFFER
);

55 
ªt
 = -
ENOMEM
;

56 
out
;

58 
∑th
->
¶Ÿs
[0] = 0;

60 
key
.
obje˘id
 = 0;

61 
key
.
ty≥
 = 
BTRFS_EXTENT_CSUM_KEY
;

62 
key
.
off£t
 = 0;

68 
	`båfs_£tup_ôem_f‹_ö£π
(
NULL
, 
roŸ
, 
∑th
, &
key
, 
vÆue_Àn
);

69 
	`wrôe_exã¡_buf„r
(
eb
, 
vÆue
, 
	`båfs_ôem_±r_off£t
(eb, 0),

70 
vÆue_Àn
);

72 
key
.
off£t
 = 3;

79 
ªt
 = 
	`båfs_•lô_ôem
(
NULL
, 
roŸ
, 
∑th
, &
key
, 17);

80 i‡(
ªt
) {

81 
	`ã°_îr
("•lô iãm faûed %d", 
ªt
);

82 
out
;

89 
	`båfs_ôem_key_to_˝u
(
eb
, &
key
, 0);

90 i‡(
key
.
obje˘id
 !0 || key.
ty≥
 !
BTRFS_EXTENT_CSUM_KEY
 ||

91 
key
.
off£t
 != 0) {

92 
	`ã°_îr
("invalid keyát slot 0");

93 
ªt
 = -
EINVAL
;

94 
out
;

97 i‡(
	`båfs_ôem_size
(
eb
, 0Ë!
	`°æí
(
•lô1
)) {

98 
	`ã°_îr
("invalidÜen inÅhe first split");

99 
ªt
 = -
EINVAL
;

100 
out
;

103 
	`ªad_exã¡_buf„r
(
eb
, 
buf
, 
	`båfs_ôem_±r_off£t
(eb, 0),

104 
	`°æí
(
•lô1
));

105 i‡(
	`memcmp
(
buf
, 
•lô1
, 
	`°æí
(split1))) {

106 
	`ã°_îr
(

108 ()
	`°æí
(
•lô1
), 
buf
, split1);

109 
ªt
 = -
EINVAL
;

110 
out
;

113 
	`båfs_ôem_key_to_˝u
(
eb
, &
key
, 1);

114 i‡(
key
.
obje˘id
 !0 || key.
ty≥
 !
BTRFS_EXTENT_CSUM_KEY
 ||

115 
key
.
off£t
 != 3) {

116 
	`ã°_îr
("invalid keyát slot 1");

117 
ªt
 = -
EINVAL
;

118 
out
;

121 i‡(
	`båfs_ôem_size
(
eb
, 1Ë!
	`°æí
(
•lô2
)) {

122 
	`ã°_îr
("invalidÜen inÅhe second split");

123 
ªt
 = -
EINVAL
;

124 
out
;

127 
	`ªad_exã¡_buf„r
(
eb
, 
buf
, 
	`båfs_ôem_±r_off£t
(eb, 1),

128 
	`°æí
(
•lô2
));

129 i‡(
	`memcmp
(
buf
, 
•lô2
, 
	`°æí
(split2))) {

130 
	`ã°_îr
(

132 
ªt
 = -
EINVAL
;

133 
out
;

136 
key
.
off£t
 = 1;

138 
ªt
 = 
	`båfs_•lô_ôem
(
NULL
, 
roŸ
, 
∑th
, &
key
, 4);

139 i‡(
ªt
) {

140 
	`ã°_îr
("£c⁄d s∂ô iãm faûed %d", 
ªt
);

141 
out
;

144 
	`båfs_ôem_key_to_˝u
(
eb
, &
key
, 0);

145 i‡(
key
.
obje˘id
 !0 || key.
ty≥
 !
BTRFS_EXTENT_CSUM_KEY
 ||

146 
key
.
off£t
 != 0) {

147 
	`ã°_îr
("invalid keyát slot 0");

148 
ªt
 = -
EINVAL
;

149 
out
;

152 i‡(
	`båfs_ôem_size
(
eb
, 0Ë!
	`°æí
(
•lô3
)) {

153 
	`ã°_îr
("invalidÜen inÅhe first split");

154 
ªt
 = -
EINVAL
;

155 
out
;

158 
	`ªad_exã¡_buf„r
(
eb
, 
buf
, 
	`båfs_ôem_±r_off£t
(eb, 0),

159 
	`°æí
(
•lô3
));

160 i‡(
	`memcmp
(
buf
, 
•lô3
, 
	`°æí
(split3))) {

161 
	`ã°_îr
(

163 
ªt
 = -
EINVAL
;

164 
out
;

167 
	`båfs_ôem_key_to_˝u
(
eb
, &
key
, 1);

168 i‡(
key
.
obje˘id
 !0 || key.
ty≥
 !
BTRFS_EXTENT_CSUM_KEY
 ||

169 
key
.
off£t
 != 1) {

170 
	`ã°_îr
("invalid keyát slot 1");

171 
ªt
 = -
EINVAL
;

172 
out
;

175 i‡(
	`båfs_ôem_size
(
eb
, 1Ë!
	`°æí
(
•lô4
)) {

176 
	`ã°_îr
("invalidÜen inÅhe second split");

177 
ªt
 = -
EINVAL
;

178 
out
;

181 
	`ªad_exã¡_buf„r
(
eb
, 
buf
, 
	`båfs_ôem_±r_off£t
(eb, 1),

182 
	`°æí
(
•lô4
));

183 i‡(
	`memcmp
(
buf
, 
•lô4
, 
	`°æí
(split4))) {

184 
	`ã°_îr
(

186 
ªt
 = -
EINVAL
;

187 
out
;

190 
	`båfs_ôem_key_to_˝u
(
eb
, &
key
, 2);

191 i‡(
key
.
obje˘id
 !0 || key.
ty≥
 !
BTRFS_EXTENT_CSUM_KEY
 ||

192 
key
.
off£t
 != 3) {

193 
	`ã°_îr
("invalid keyát slot 2");

194 
ªt
 = -
EINVAL
;

195 
out
;

198 i‡(
	`båfs_ôem_size
(
eb
, 2Ë!
	`°æí
(
•lô2
)) {

199 
	`ã°_îr
("invalidÜen inÅhe second split");

200 
ªt
 = -
EINVAL
;

201 
out
;

204 
	`ªad_exã¡_buf„r
(
eb
, 
buf
, 
	`båfs_ôem_±r_off£t
(eb, 2),

205 
	`°æí
(
•lô2
));

206 i‡(
	`memcmp
(
buf
, 
•lô2
, 
	`°æí
(split2))) {

207 
	`ã°_îr
(

209 
ªt
 = -
EINVAL
;

210 
out
;

212 
out
:

213 
	`båfs_‰ì_∑th
(
∑th
);

214 
	`båfs_‰ì_dummy_roŸ
(
roŸ
);

215 
	`båfs_‰ì_dummy_fs_öfo
(
fs_öfo
);

216  
ªt
;

217 
	}
}

219 
	$båfs_ã°_exã¡_buf„r_›î©i⁄s
(
u32
 
£˘‹size
, u32 
nodesize
)

221 
	`ã°_msg
("runningÉxtent buffer operationÅests");

222  
	`ã°_båfs_•lô_ôem
(
£˘‹size
, 
nodesize
);

223 
	}
}

	@tests/extent-io-tests.c

6 
	~<löux/∑gem≠.h
>

7 
	~<löux/∑gevec.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/¶ab.h
>

10 
	~<löux/sizes.h
>

11 
	~"båfs-ã°s.h
"

12 
	~"../˘ªe.h
"

13 
	~"../exã¡_io.h
"

14 
	~"../båfs_öode.h
"

16 
	#PROCESS_UNLOCK
 (1 << 0)

	)

17 
	#PROCESS_RELEASE
 (1 << 1)

	)

18 
	#PROCESS_TEST_LOCKED
 (1 << 2)

	)

20 
noölöe
 
	$¥o˚ss_∑ge_ønge
(
öode
 *öode, 
u64
 
°¨t
, u64 
íd
,

21 
Êags
)

23 
ªt
;

24 
fﬁio_b©ch
 
fb©ch
;

25 
ödex
 = 
°¨t
 >> 
PAGE_SHIFT
;

26 
íd_ödex
 = 
íd
 >> 
PAGE_SHIFT
;

27 
i
;

28 
cou¡
 = 0;

29 
lo›s
 = 0;

31 
	`fﬁio_b©ch_öô
(&
fb©ch
);

33 
ödex
 <
íd_ödex
) {

34 
ªt
 = 
	`fûem≠_gë_fﬁios_c⁄tig
(
öode
->
i_m≠pög
, &
ödex
,

35 
íd_ödex
, &
fb©ch
);

36 
i
 = 0; i < 
ªt
; i++) {

37 
fﬁio
 *fﬁiÿ
fb©ch
.
fﬁios
[
i
];

39 i‡(
Êags
 & 
PROCESS_TEST_LOCKED
 &&

40 !
	`fﬁio_ã°_locked
(
fﬁio
))

41 
cou¡
++;

42 i‡(
Êags
 & 
PROCESS_UNLOCK
 && 
	`fﬁio_ã°_locked
(
fﬁio
))

43 
	`fﬁio_u∆ock
(
fﬁio
);

44 i‡(
Êags
 & 
PROCESS_RELEASE
)

45 
	`fﬁio_put
(
fﬁio
);

47 
	`fﬁio_b©ch_ªÀa£
(&
fb©ch
);

48 
	`c⁄d_ªsched
();

49 
lo›s
++;

50 i‡(
lo›s
 > 100000) {

51 
	`¥ötk
(
KERN_ERR


53 
°¨t
, 
íd
, 
ªt
);

58  
cou¡
;

59 
	}
}

61 
	#STATE_FLAG_STR_LEN
 256

	)

63 
	#PRINT_ONE_FLAG
(
°©e
, 
de°
, 
cur
, 
«me
) \

65 i‡(
°©e
->°©ê& 
EXTENT_
##
«me
) \

66 
cur
 +
	`s˙¥ötf
(
de°
 + cur, 
STATE_FLAG_STR_LEN
 - cur, \

67 "%s" #«me, 
cur
 == 0 ? "" : "|"); \

68 })

	)

70 
	$exã¡_Êag_to_°r
(c⁄° 
exã¡_°©e
 *
°©e
, *
de°
)

72 
cur
 = 0;

74 
de°
[0] = 0;

75 
	`PRINT_ONE_FLAG
(
°©e
, 
de°
, 
cur
, 
DIRTY
);

76 
	`PRINT_ONE_FLAG
(
°©e
, 
de°
, 
cur
, 
UPTODATE
);

77 
	`PRINT_ONE_FLAG
(
°©e
, 
de°
, 
cur
, 
LOCKED
);

78 
	`PRINT_ONE_FLAG
(
°©e
, 
de°
, 
cur
, 
NEW
);

79 
	`PRINT_ONE_FLAG
(
°©e
, 
de°
, 
cur
, 
DELALLOC
);

80 
	`PRINT_ONE_FLAG
(
°©e
, 
de°
, 
cur
, 
DEFRAG
);

81 
	`PRINT_ONE_FLAG
(
°©e
, 
de°
, 
cur
, 
BOUNDARY
);

82 
	`PRINT_ONE_FLAG
(
°©e
, 
de°
, 
cur
, 
NODATASUM
);

83 
	`PRINT_ONE_FLAG
(
°©e
, 
de°
, 
cur
, 
CLEAR_META_RESV
);

84 
	`PRINT_ONE_FLAG
(
°©e
, 
de°
, 
cur
, 
NEED_WAIT
);

85 
	`PRINT_ONE_FLAG
(
°©e
, 
de°
, 
cur
, 
NORESERVE
);

86 
	`PRINT_ONE_FLAG
(
°©e
, 
de°
, 
cur
, 
QGROUP_RESERVED
);

87 
	`PRINT_ONE_FLAG
(
°©e
, 
de°
, 
cur
, 
CLEAR_DATA_RESV
);

88 
	}
}

90 
	$dump_exã¡_io_åì
(c⁄° 
exã¡_io_åì
 *
åì
)

92 
rb_node
 *
node
;

93 
Êags_°r
[
STATE_FLAG_STR_LEN
];

95 
node
 = 
	`rb_fú°
(&
åì
->
°©e
);

96 
	`ã°_msg
("ioÅree content:");

97 
node
) {

98 
exã¡_°©e
 *
°©e
;

100 
°©e
 = 
	`rb_íåy
(
node
, 
exã¡_°©e
, 
rb_node
);

101 
	`exã¡_Êag_to_°r
(
°©e
, 
Êags_°r
);

102 
	`ã°_msg
(" sèπ=%ŒuÜí=%Œu fœgs=%s", 
°©e
->
°¨t
,

103 
°©e
->
íd
 + 1 - sèã->
°¨t
, 
Êags_°r
);

104 
node
 = 
	`rb_√xt
(node);

106 
	}
}

108 
	$ã°_föd_dñÆloc
(
u32
 
£˘‹size
)

110 
öode
 *inode;

111 
exã¡_io_åì
 *
tmp
;

112 
∑ge
 *page;

113 
∑ge
 *
locked_∑ge
 = 
NULL
;

114 
ödex
 = 0;

116 
u64
 
max_byãs
 = 
BTRFS_MAX_EXTENT_SIZE
;

117 
u64
 
tŸÆ_dúty
 = 2 * 
max_byãs
;

118 
u64
 
°¨t
, 
íd
, 
ã°_°¨t
;

119 
boﬁ
 
found
;

120 
ªt
 = -
EINVAL
;

122 
	`ã°_msg
("running find delallocÅests");

124 
öode
 = 
	`båfs_√w_ã°_öode
();

125 i‡(!
öode
) {

126 
	`ã°_°d_îr
(
TEST_ALLOC_INODE
);

127  -
ENOMEM
;

129 
tmp
 = &
	`BTRFS_I
(
öode
)->
io_åì
;

135 
	`exã¡_io_åì_öô
(
NULL
, 
tmp
, 
IO_TREE_SELFTEST
);

142 
ödex
 = 0; index < (
tŸÆ_dúty
 >> 
PAGE_SHIFT
); index++) {

143 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
ödex
, 
GFP_KERNEL
);

144 i‡(!
∑ge
) {

145 
	`ã°_îr
("failedÅoállocateÅestÖage");

146 
ªt
 = -
ENOMEM
;

147 
out
;

149 
	`SëPageDúty
(
∑ge
);

150 i‡(
ödex
) {

151 
	`u∆ock_∑ge
(
∑ge
);

153 
	`gë_∑ge
(
∑ge
);

154 
locked_∑ge
 = 
∑ge
;

162 
	`£t_exã¡_bô
(
tmp
, 0, 
£˘‹size
 - 1, 
EXTENT_DELALLOC
, 
NULL
);

163 
°¨t
 = 0;

164 
íd
 = 
°¨t
 + 
PAGE_SIZE
 - 1;

165 
found
 = 
	`föd_lock_dñÆloc_ønge
(
öode
, 
locked_∑ge
, &
°¨t
,

166 &
íd
);

167 i‡(!
found
) {

168 
	`ã°_îr
("should have foundátÜeast one delalloc");

169 
out_bôs
;

171 i‡(
°¨t
 !0 || 
íd
 !(
£˘‹size
 - 1)) {

172 
	`ã°_îr
("expected start 0Énd %u, got start %lluÉnd %llu",

173 
£˘‹size
 - 1, 
°¨t
, 
íd
);

174 
out_bôs
;

176 
	`u∆ock_exã¡
(
tmp
, 
°¨t
, 
íd
, 
NULL
);

177 
	`u∆ock_∑ge
(
locked_∑ge
);

178 
	`put_∑ge
(
locked_∑ge
);

186 
ã°_°¨t
 = 
SZ_64M
;

187 
locked_∑ge
 = 
	`föd_lock_∑ge
(
öode
->
i_m≠pög
,

188 
ã°_°¨t
 >> 
PAGE_SHIFT
);

189 i‡(!
locked_∑ge
) {

190 
	`ã°_îr
("couldn't findÅheÜockedÖage");

191 
out_bôs
;

193 
	`£t_exã¡_bô
(
tmp
, 
£˘‹size
, 
max_byãs
 - 1, 
EXTENT_DELALLOC
, 
NULL
);

194 
°¨t
 = 
ã°_°¨t
;

195 
íd
 = 
°¨t
 + 
PAGE_SIZE
 - 1;

196 
found
 = 
	`föd_lock_dñÆloc_ønge
(
öode
, 
locked_∑ge
, &
°¨t
,

197 &
íd
);

198 i‡(!
found
) {

199 
	`ã°_îr
("couldn't find delalloc in ourÑange");

200 
out_bôs
;

202 i‡(
°¨t
 !
ã°_°¨t
 || 
íd
 !
max_byãs
 - 1) {

203 
	`ã°_îr
("expected start %lluÉnd %llu, got start %llu,Énd %llu",

204 
ã°_°¨t
, 
max_byãs
 - 1, 
°¨t
, 
íd
);

205 
out_bôs
;

207 i‡(
	`¥o˚ss_∑ge_ønge
(
öode
, 
°¨t
, 
íd
,

208 
PROCESS_TEST_LOCKED
 | 
PROCESS_UNLOCK
)) {

209 
	`ã°_îr
("there were unlockedÖages inÅheÑange");

210 
out_bôs
;

212 
	`u∆ock_exã¡
(
tmp
, 
°¨t
, 
íd
, 
NULL
);

214 
	`put_∑ge
(
locked_∑ge
);

221 
ã°_°¨t
 = 
max_byãs
 + 
£˘‹size
;

222 
locked_∑ge
 = 
	`föd_lock_∑ge
(
öode
->
i_m≠pög
, 
ã°_°¨t
 >>

223 
PAGE_SHIFT
);

224 i‡(!
locked_∑ge
) {

225 
	`ã°_îr
("couldn't findÅheÜockedÖage");

226 
out_bôs
;

228 
°¨t
 = 
ã°_°¨t
;

229 
íd
 = 
°¨t
 + 
PAGE_SIZE
 - 1;

230 
found
 = 
	`föd_lock_dñÆloc_ønge
(
öode
, 
locked_∑ge
, &
°¨t
,

231 &
íd
);

232 i‡(
found
) {

233 
	`ã°_îr
("foundÑange when we shouldn't have");

234 
out_bôs
;

236 i‡(
íd
 !
ã°_°¨t
 + 
PAGE_SIZE
 - 1) {

237 
	`ã°_îr
("didÇotÑeturnÅheÖroperÉnd offset");

238 
out_bôs
;

248 
	`£t_exã¡_bô
(
tmp
, 
max_byãs
, 
tŸÆ_dúty
 - 1, 
EXTENT_DELALLOC
, 
NULL
);

249 
°¨t
 = 
ã°_°¨t
;

250 
íd
 = 
°¨t
 + 
PAGE_SIZE
 - 1;

251 
found
 = 
	`föd_lock_dñÆloc_ønge
(
öode
, 
locked_∑ge
, &
°¨t
,

252 &
íd
);

253 i‡(!
found
) {

254 
	`ã°_îr
("didn't find ourÑange");

255 
out_bôs
;

257 i‡(
°¨t
 !
ã°_°¨t
 || 
íd
 !
tŸÆ_dúty
 - 1) {

258 
	`ã°_îr
("expected start %lluÉnd %llu, got start %lluÉnd %llu",

259 
ã°_°¨t
, 
tŸÆ_dúty
 - 1, 
°¨t
, 
íd
);

260 
out_bôs
;

262 i‡(
	`¥o˚ss_∑ge_ønge
(
öode
, 
°¨t
, 
íd
,

263 
PROCESS_TEST_LOCKED
 | 
PROCESS_UNLOCK
)) {

264 
	`ã°_îr
("pages inÑange wereÇotállÜocked");

265 
out_bôs
;

267 
	`u∆ock_exã¡
(
tmp
, 
°¨t
, 
íd
, 
NULL
);

273 
∑ge
 = 
	`föd_gë_∑ge
(
öode
->
i_m≠pög
,

274 (
max_byãs
 + 
SZ_1M
Ë>> 
PAGE_SHIFT
);

275 i‡(!
∑ge
) {

276 
	`ã°_îr
("couldn't find ourÖage");

277 
out_bôs
;

279 
	`CÀ¨PageDúty
(
∑ge
);

280 
	`put_∑ge
(
∑ge
);

283 
	`lock_∑ge
(
locked_∑ge
);

284 
°¨t
 = 
ã°_°¨t
;

285 
íd
 = 
°¨t
 + 
PAGE_SIZE
 - 1;

292 
found
 = 
	`föd_lock_dñÆloc_ønge
(
öode
, 
locked_∑ge
, &
°¨t
,

293 &
íd
);

294 i‡(!
found
) {

295 
	`ã°_îr
("didn't find ourÑange");

296 
out_bôs
;

298 i‡(
°¨t
 !
ã°_°¨t
 && 
íd
 !ã°_°¨à+ 
PAGE_SIZE
 - 1) {

299 
	`ã°_îr
("expected start %lluÉnd %llu, got start %lluÉnd %llu",

300 
ã°_°¨t
,Åe°_°¨à+ 
PAGE_SIZE
 - 1, 
°¨t
, 
íd
);

301 
out_bôs
;

303 i‡(
	`¥o˚ss_∑ge_ønge
(
öode
, 
°¨t
, 
íd
, 
PROCESS_TEST_LOCKED
 |

304 
PROCESS_UNLOCK
)) {

305 
	`ã°_îr
("pages inÑange wereÇotállÜocked");

306 
out_bôs
;

308 
ªt
 = 0;

309 
out_bôs
:

310 i‡(
ªt
)

311 
	`dump_exã¡_io_åì
(
tmp
);

312 
	`˛ór_exã¡_bôs
(
tmp
, 0, 
tŸÆ_dúty
 - 1, ()-1);

313 
out
:

314 i‡(
locked_∑ge
)

315 
	`put_∑ge
(
locked_∑ge
);

316 
	`¥o˚ss_∑ge_ønge
(
öode
, 0, 
tŸÆ_dúty
 - 1,

317 
PROCESS_UNLOCK
 | 
PROCESS_RELEASE
);

318 
	`ùut
(
öode
);

319  
ªt
;

320 
	}
}

322 
	$check_eb_bôm≠
(*
bôm≠
, 
exã¡_buf„r
 *
eb
)

324 
i
;

326 
i
 = 0; i < 
eb
->
Àn
 * 
BITS_PER_BYTE
; i++) {

327 
bô
, 
bô1
;

329 
bô
 = !!
	`ã°_bô
(
i
, 
bôm≠
);

330 
bô1
 = !!
	`exã¡_buf„r_ã°_bô
(
eb
, 0, 
i
);

331 i‡(
bô1
 !
bô
) {

332 
u8
 
has
;

333 
u8
 
ex≥˘
;

335 
	`ªad_exã¡_buf„r
(
eb
, &
has
, 
i
 / 
BITS_PER_BYTE
, 1);

336 
ex≥˘
 = 
	`bôm≠_gë_vÆue8
(
bôm≠
, 
	`ALIGN
(
i
, 
BITS_PER_BYTE
));

338 
	`ã°_îr
(

340 
i
, i / 
BITS_PER_BYTE
, 
has
, 
ex≥˘
);

341  -
EINVAL
;

344 
bô1
 = !!
	`exã¡_buf„r_ã°_bô
(
eb
, 
i
 / 
BITS_PER_BYTE
,

345 
i
 % 
BITS_PER_BYTE
);

346 i‡(
bô1
 !
bô
) {

347 
u8
 
has
;

348 
u8
 
ex≥˘
;

350 
	`ªad_exã¡_buf„r
(
eb
, &
has
, 
i
 / 
BITS_PER_BYTE
, 1);

351 
ex≥˘
 = 
	`bôm≠_gë_vÆue8
(
bôm≠
, 
	`ALIGN
(
i
, 
BITS_PER_BYTE
));

353 
	`ã°_îr
(

355 
i
 / 
BITS_PER_BYTE
, i % BITS_PER_BYTE,

356 
i
 / 
BITS_PER_BYTE
, 
has
, 
ex≥˘
);

357  -
EINVAL
;

361 
	}
}

363 
	$ã°_bôm≠_£t
(c⁄° *
«me
, *
bôm≠
,

364 
exã¡_buf„r
 *
eb
,

365 
byã_°¨t
, 
bô_°¨t
,

366 
bô_Àn
)

368 
ªt
;

370 
	`bôm≠_£t
(
bôm≠
, 
byã_°¨t
 * 
BITS_PER_BYTE
 + 
bô_°¨t
, 
bô_Àn
);

371 
	`exã¡_buf„r_bôm≠_£t
(
eb
, 
byã_°¨t
, 
bô_°¨t
, 
bô_Àn
);

372 
ªt
 = 
	`check_eb_bôm≠
(
bôm≠
, 
eb
);

373 i‡(
ªt
 < 0)

374 
	`ã°_îr
("%†ã° faûed", 
«me
);

375  
ªt
;

376 
	}
}

378 
	$ã°_bôm≠_˛ór
(c⁄° *
«me
, *
bôm≠
,

379 
exã¡_buf„r
 *
eb
,

380 
byã_°¨t
, 
bô_°¨t
,

381 
bô_Àn
)

383 
ªt
;

385 
	`bôm≠_˛ór
(
bôm≠
, 
byã_°¨t
 * 
BITS_PER_BYTE
 + 
bô_°¨t
, 
bô_Àn
);

386 
	`exã¡_buf„r_bôm≠_˛ór
(
eb
, 
byã_°¨t
, 
bô_°¨t
, 
bô_Àn
);

387 
ªt
 = 
	`check_eb_bôm≠
(
bôm≠
, 
eb
);

388 i‡(
ªt
 < 0)

389 
	`ã°_îr
("%†ã° faûed", 
«me
);

390  
ªt
;

391 
	}
}

392 
	$__ã°_eb_bôm≠s
(*
bôm≠
, 
exã¡_buf„r
 *
eb
)

394 
i
, 
j
;

395 
byã_Àn
 = 
eb
->
Àn
;

396 
u32
 
x
;

397 
ªt
;

399 
ªt
 = 
	`ã°_bôm≠_˛ór
("˛ó∏Æ»ru¿1", 
bôm≠
, 
eb
, 0, 0,

400 
byã_Àn
 * 
BITS_PER_BYTE
);

401 i‡(
ªt
 < 0)

402  
ªt
;

404 
ªt
 = 
	`ã°_bôm≠_£t
("£àÆl", 
bôm≠
, 
eb
, 0, 0, 
byã_Àn
 * 
BITS_PER_BYTE
);

405 i‡(
ªt
 < 0)

406  
ªt
;

408 
ªt
 = 
	`ã°_bôm≠_˛ór
("˛ó∏Æ»ru¿2", 
bôm≠
, 
eb
, 0, 0,

409 
byã_Àn
 * 
BITS_PER_BYTE
);

410 i‡(
ªt
 < 0)

411  
ªt
;

413 
ªt
 = 
	`ã°_bôm≠_£t
("ßmêbyã së", 
bôm≠
, 
eb
, 0, 2, 4);

414 i‡(
ªt
 < 0)

415  
ªt
;

417 
ªt
 = 
	`ã°_bôm≠_˛ór
("ßmêbyãÖ¨tü»˛ór", 
bôm≠
, 
eb
, 0, 4, 1);

418 i‡(
ªt
 < 0)

419  
ªt
;

421 
ªt
 = 
	`ã°_bôm≠_£t
("¸os†byã së", 
bôm≠
, 
eb
, 2, 4, 8);

422 i‡(
ªt
 < 0)

423  
ªt
;

425 
ªt
 = 
	`ã°_bôm≠_£t
("¸os†mu…òbyã së", 
bôm≠
, 
eb
, 4, 4, 24);

426 i‡(
ªt
 < 0)

427  
ªt
;

429 
ªt
 = 
	`ã°_bôm≠_˛ór
("¸os†byã cÀ¨", 
bôm≠
, 
eb
, 2, 6, 4);

430 i‡(
ªt
 < 0)

431  
ªt
;

433 
ªt
 = 
	`ã°_bôm≠_˛ór
("¸os†mu…òbyã cÀ¨", 
bôm≠
, 
eb
, 4, 6, 20);

434 i‡(
ªt
 < 0)

435  
ªt
;

438 i‡(
byã_Àn
 > 
PAGE_SIZE
) {

439 
ªt
 = 
	`ã°_bôm≠_£t
("¸os†∑gê£t", 
bôm≠
, 
eb
,

440 
PAGE_SIZE
 - () / 2, 0,

441 (Ë* 
BITS_PER_BYTE
);

442 i‡(
ªt
 < 0)

443  
ªt
;

445 
ªt
 = 
	`ã°_bôm≠_£t
("¸os†∑gê£àÆl", 
bôm≠
, 
eb
, 0, 0,

446 
byã_Àn
 * 
BITS_PER_BYTE
);

447 i‡(
ªt
 < 0)

448  
ªt
;

450 
ªt
 = 
	`ã°_bôm≠_˛ór
("¸os†∑gê˛ór", 
bôm≠
, 
eb
,

451 
PAGE_SIZE
 - () / 2, 0,

452 (Ë* 
BITS_PER_BYTE
);

453 i‡(
ªt
 < 0)

454  
ªt
;

461 
x
 = 0;

462 
ªt
 = 
	`ã°_bôm≠_˛ór
("˛ó∏Æ»ru¿3", 
bôm≠
, 
eb
, 0, 0,

463 
byã_Àn
 * 
BITS_PER_BYTE
);

464 i‡(
ªt
 < 0)

465  
ªt
;

467 
i
 = 0; i < 
byã_Àn
 * 
BITS_PER_BYTE
 / 32; i++) {

468 
x
 = (0x19660dULL * (
u64
)x + 0x3c6ef35fULL) & 0xffffffffU;

469 
j
 = 0; j < 32; j++) {

470 i‡(
x
 & (1U << 
j
)) {

471 
	`bôm≠_£t
(
bôm≠
, 
i
 * 32 + 
j
, 1);

472 
	`exã¡_buf„r_bôm≠_£t
(
eb
, 0, 
i
 * 32 + 
j
, 1);

477 
ªt
 = 
	`check_eb_bôm≠
(
bôm≠
, 
eb
);

478 i‡(
ªt
) {

479 
	`ã°_îr
("random bitÖattern failed");

480  
ªt
;

484 
	}
}

486 
	$ã°_eb_bôm≠s
(
u32
 
£˘‹size
, u32 
nodesize
)

488 
båfs_fs_öfo
 *
fs_öfo
;

489 *
bôm≠
 = 
NULL
;

490 
exã¡_buf„r
 *
eb
 = 
NULL
;

491 
ªt
;

493 
	`ã°_msg
("runningÉxtent buffer bitmapÅests");

495 
fs_öfo
 = 
	`båfs_Æloc_dummy_fs_öfo
(
nodesize
, 
£˘‹size
);

496 i‡(!
fs_öfo
) {

497 
	`ã°_°d_îr
(
TEST_ALLOC_FS_INFO
);

498  -
ENOMEM
;

501 
bôm≠
 = 
	`kmÆloc
(
nodesize
, 
GFP_KERNEL
);

502 i‡(!
bôm≠
) {

503 
	`ã°_îr
("couldn'tállocateÅest bitmap");

504 
ªt
 = -
ENOMEM
;

505 
out
;

508 
eb
 = 
	`__Æloc_dummy_exã¡_buf„r
(
fs_öfo
, 0, 
nodesize
);

509 i‡(!
eb
) {

510 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

511 
ªt
 = -
ENOMEM
;

512 
out
;

515 
ªt
 = 
	`__ã°_eb_bôm≠s
(
bôm≠
, 
eb
);

516 i‡(
ªt
)

517 
out
;

519 
	`‰ì_exã¡_buf„r
(
eb
);

525 
eb
 = 
	`__Æloc_dummy_exã¡_buf„r
(
fs_öfo
, 
£˘‹size
, 
nodesize
);

526 i‡(!
eb
) {

527 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

528 
ªt
 = -
ENOMEM
;

529 
out
;

532 
ªt
 = 
	`__ã°_eb_bôm≠s
(
bôm≠
, 
eb
);

533 
out
:

534 
	`‰ì_exã¡_buf„r
(
eb
);

535 
	`k‰ì
(
bôm≠
);

536 
	`båfs_‰ì_dummy_fs_öfo
(
fs_öfo
);

537  
ªt
;

538 
	}
}

540 
	$ã°_föd_fú°_˛ór_exã¡_bô
()

542 
exã¡_io_åì
 
åì
;

543 
u64
 
°¨t
, 
íd
;

544 
ªt
 = -
EINVAL
;

546 
	`ã°_msg
("running find_first_clear_extent_bitÅest");

548 
	`exã¡_io_åì_öô
(
NULL
, &
åì
, 
IO_TREE_SELFTEST
);

551 
	`föd_fú°_˛ór_exã¡_bô
(&
åì
, 0, &
°¨t
, &
íd
, 
CHUNK_TRIMMED
);

552 i‡(
°¨t
 !0 || 
íd
 != -1) {

553 
	`ã°_îr
(

555 
°¨t
, 
íd
);

556 
out
;

562 
	`£t_exã¡_bô
(&
åì
, 
SZ_1M
, 
SZ_4M
 - 1,

563 
CHUNK_TRIMMED
 | 
CHUNK_ALLOCATED
, 
NULL
);

565 
	`föd_fú°_˛ór_exã¡_bô
(&
åì
, 
SZ_512K
, &
°¨t
, &
íd
,

566 
CHUNK_TRIMMED
 | 
CHUNK_ALLOCATED
);

568 i‡(
°¨t
 !0 || 
íd
 !
SZ_1M
 - 1) {

569 
	`ã°_îr
("error finding beginningÑange: start %lluÉnd %llu",

570 
°¨t
, 
íd
);

571 
out
;

575 
	`£t_exã¡_bô
(&
åì
, 
SZ_32M
, 
SZ_64M
 - 1,

576 
CHUNK_TRIMMED
 | 
CHUNK_ALLOCATED
, 
NULL
);

581 
	`föd_fú°_˛ór_exã¡_bô
(&
åì
, 12 * 
SZ_1M
, &
°¨t
, &
íd
,

582 
CHUNK_TRIMMED
 | 
CHUNK_ALLOCATED
);

584 i‡(
°¨t
 !
SZ_4M
 || 
íd
 !
SZ_32M
 - 1) {

585 
	`ã°_îr
("error findingÅrimmedÑange: start %lluÉnd %llu",

586 
°¨t
, 
íd
);

587 
out
;

594 
	`föd_fú°_˛ór_exã¡_bô
(&
åì
, 
SZ_2M
, &
°¨t
, &
íd
,

595 
CHUNK_TRIMMED
 | 
CHUNK_ALLOCATED
);

597 i‡(
°¨t
 !
SZ_4M
 || 
íd
 !
SZ_32M
 - 1) {

598 
	`ã°_îr
("error findingÇext unallocÑange: start %lluÉnd %llu",

599 
°¨t
, 
íd
);

600 
out
;

607 
	`£t_exã¡_bô
(&
åì
, 
SZ_64M
, SZ_64M + 
SZ_8M
 - 1, 
CHUNK_ALLOCATED
, 
NULL
);

608 
	`föd_fú°_˛ór_exã¡_bô
(&
åì
, 
SZ_64M
 + 
SZ_1M
, &
°¨t
, &
íd
,

609 
CHUNK_TRIMMED
);

611 i‡(
°¨t
 !
SZ_64M
 || 
íd
 !SZ_64M + 
SZ_8M
 - 1) {

612 
	`ã°_îr
("error findingÉxactÑange: start %lluÉnd %llu",

613 
°¨t
, 
íd
);

614 
out
;

617 
	`föd_fú°_˛ór_exã¡_bô
(&
åì
, 
SZ_64M
 - 
SZ_8M
, &
°¨t
, &
íd
,

618 
CHUNK_TRIMMED
);

624 i‡(
°¨t
 !
SZ_64M
 || 
íd
 !SZ_64M + 
SZ_8M
 - 1) {

625 
	`ã°_îr
("error findingÇextállocÑange: start %lluÉnd %llu",

626 
°¨t
, 
íd
);

627 
out
;

634 
	`föd_fú°_˛ór_exã¡_bô
(&
åì
, -1, &
°¨t
, &
íd
, 
CHUNK_TRIMMED
);

635 i‡(
°¨t
 !
SZ_64M
 + 
SZ_8M
 || 
íd
 != -1) {

636 
	`ã°_îr
(

638 
°¨t
, 
íd
);

639 
out
;

642 
ªt
 = 0;

643 
out
:

644 i‡(
ªt
)

645 
	`dump_exã¡_io_åì
(&
åì
);

646 
	`˛ór_exã¡_bôs
(&
åì
, 0, (
u64
)-1, 
CHUNK_TRIMMED
 | 
CHUNK_ALLOCATED
);

648  
ªt
;

649 
	}
}

651 
	$dump_eb_™d_mem‹y_c⁄ã¡s
(
exã¡_buf„r
 *
eb
, *
mem‹y
,

652 c⁄° *
ã°_«me
)

654 
i
 = 0; i < 
eb
->
Àn
; i++) {

655 
∑ge
 *∑gê
eb
->
∑ges
[
i
 >> 
PAGE_SHIFT
];

656 *
addr
 = 
	`∑ge_addªss
(
∑ge
Ë+ 
	`off£t_ö_∑ge
(
i
);

658 i‡(
	`memcmp
(
addr
, 
mem‹y
 + 
i
, 1) != 0) {

659 
	`ã°_îr
("%†Áûed", 
ã°_«me
);

660 
	`ã°_îr
("ebánd memory diffsát byte %u,Éb has 0x%02x memory has 0x%02x",

661 
i
, *(
u8
 *)
addr
, *(u8 *)(
mem‹y
 + i));

665 
	}
}

667 
	$vîify_eb_™d_mem‹y
(
exã¡_buf„r
 *
eb
, *
mem‹y
,

668 c⁄° *
ã°_«me
)

670 
i
 = 0; i < (
eb
->
Àn
 >> 
PAGE_SHIFT
); i++) {

671 *
eb_addr
 = 
	`∑ge_addªss
(
eb
->
∑ges
[
i
]);

673 i‡(
	`memcmp
(
mem‹y
 + (
i
 << 
PAGE_SHIFT
), 
eb_addr
, 
PAGE_SIZE
) != 0) {

674 
	`dump_eb_™d_mem‹y_c⁄ã¡s
(
eb
, 
mem‹y
, 
ã°_«me
);

675  -
EUCLEAN
;

679 
	}
}

685 
	$öô_eb_™d_mem‹y
(
exã¡_buf„r
 *
eb
, *
mem‹y
)

687 
	`gë_øndom_byãs
(
mem‹y
, 
eb
->
Àn
);

688 
	`wrôe_exã¡_buf„r
(
eb
, 
mem‹y
, 0,Éb->
Àn
);

689 
	}
}

691 
	$ã°_eb_mem_›s
(
u32
 
£˘‹size
, u32 
nodesize
)

693 
båfs_fs_öfo
 *
fs_öfo
;

694 
exã¡_buf„r
 *
eb
 = 
NULL
;

695 *
mem‹y
 = 
NULL
;

696 
ªt
;

698 
	`ã°_msg
("runningÉxtent buffer memory operationÅests");

700 
fs_öfo
 = 
	`båfs_Æloc_dummy_fs_öfo
(
nodesize
, 
£˘‹size
);

701 i‡(!
fs_öfo
) {

702 
	`ã°_°d_îr
(
TEST_ALLOC_FS_INFO
);

703  -
ENOMEM
;

706 
mem‹y
 = 
	`kvzÆloc
(
nodesize
, 
GFP_KERNEL
);

707 i‡(!
mem‹y
) {

708 
	`ã°_îr
("failedÅoállocate memory");

709 
ªt
 = -
ENOMEM
;

710 
out
;

713 
eb
 = 
	`__Æloc_dummy_exã¡_buf„r
(
fs_öfo
, 
SZ_1M
, 
nodesize
);

714 i‡(!
eb
) {

715 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_BUFFER
);

716 
ªt
 = -
ENOMEM
;

717 
out
;

720 
	`öô_eb_™d_mem‹y
(
eb
, 
mem‹y
);

721 
ªt
 = 
	`vîify_eb_™d_mem‹y
(
eb
, 
mem‹y
, "fullÉb write");

722 i‡(
ªt
 < 0)

723 
out
;

725 
	`mem˝y
(
mem‹y
, memory + 16, 16);

726 
	`mem˝y_exã¡_buf„r
(
eb
, 0, 16, 16);

727 
ªt
 = 
	`vîify_eb_™d_mem‹y
(
eb
, 
mem‹y
, "sameÖageÇon-overlapping memcpy 1");

728 i‡(
ªt
 < 0)

729 
out
;

731 
	`mem˝y
(
mem‹y
, memory + 2048, 16);

732 
	`mem˝y_exã¡_buf„r
(
eb
, 0, 2048, 16);

733 
ªt
 = 
	`vîify_eb_™d_mem‹y
(
eb
, 
mem‹y
, "sameÖageÇon-overlapping memcpy 2");

734 i‡(
ªt
 < 0)

735 
out
;

736 
	`mem˝y
(
mem‹y
, memory + 2048, 2048);

737 
	`mem˝y_exã¡_buf„r
(
eb
, 0, 2048, 2048);

738 
ªt
 = 
	`vîify_eb_™d_mem‹y
(
eb
, 
mem‹y
, "sameÖageÇon-overlapping memcpy 3");

739 i‡(
ªt
 < 0)

740 
out
;

742 
	`memmove
(
mem‹y
 + 512, memory + 256, 512);

743 
	`memmove_exã¡_buf„r
(
eb
, 512, 256, 512);

744 
ªt
 = 
	`vîify_eb_™d_mem‹y
(
eb
, 
mem‹y
, "sameÖage overlapping memcpy 1");

745 i‡(
ªt
 < 0)

746 
out
;

748 
	`memmove
(
mem‹y
 + 2048, memory + 512, 2048);

749 
	`memmove_exã¡_buf„r
(
eb
, 2048, 512, 2048);

750 
ªt
 = 
	`vîify_eb_™d_mem‹y
(
eb
, 
mem‹y
, "sameÖage overlapping memcpy 2");

751 i‡(
ªt
 < 0)

752 
out
;

753 
	`memmove
(
mem‹y
 + 512, memory + 2048, 2048);

754 
	`memmove_exã¡_buf„r
(
eb
, 512, 2048, 2048);

755 
ªt
 = 
	`vîify_eb_™d_mem‹y
(
eb
, 
mem‹y
, "sameÖage overlapping memcpy 3");

756 i‡(
ªt
 < 0)

757 
out
;

759 i‡(
nodesize
 > 
PAGE_SIZE
) {

760 
	`mem˝y
(
mem‹y
, memory + 4096 - 128, 256);

761 
	`mem˝y_exã¡_buf„r
(
eb
, 0, 4096 - 128, 256);

762 
ªt
 = 
	`vîify_eb_™d_mem‹y
(
eb
, 
mem‹y
, "crossÖageÇon-overlapping memcpy 1");

763 i‡(
ªt
 < 0)

764 
out
;

766 
	`mem˝y
(
mem‹y
 + 4096 - 128, memory + 4096 + 128, 256);

767 
	`mem˝y_exã¡_buf„r
(
eb
, 4096 - 128, 4096 + 128, 256);

768 
ªt
 = 
	`vîify_eb_™d_mem‹y
(
eb
, 
mem‹y
, "crossÖageÇon-overlapping memcpy 2");

769 i‡(
ªt
 < 0)

770 
out
;

772 
	`memmove
(
mem‹y
 + 4096 - 128, memory + 4096 - 64, 256);

773 
	`memmove_exã¡_buf„r
(
eb
, 4096 - 128, 4096 - 64, 256);

774 
ªt
 = 
	`vîify_eb_™d_mem‹y
(
eb
, 
mem‹y
, "crossÖage overlapping memcpy 1");

775 i‡(
ªt
 < 0)

776 
out
;

778 
	`memmove
(
mem‹y
 + 4096 - 64, memory + 4096 - 128, 256);

779 
	`memmove_exã¡_buf„r
(
eb
, 4096 - 64, 4096 - 128, 256);

780 
ªt
 = 
	`vîify_eb_™d_mem‹y
(
eb
, 
mem‹y
, "crossÖage overlapping memcpy 2");

781 i‡(
ªt
 < 0)

782 
out
;

784 
out
:

785 
	`‰ì_exã¡_buf„r
(
eb
);

786 
	`kv‰ì
(
mem‹y
);

787 
	`båfs_‰ì_dummy_fs_öfo
(
fs_öfo
);

788  
ªt
;

789 
	}
}

791 
	$båfs_ã°_exã¡_io
(
u32
 
£˘‹size
, u32 
nodesize
)

793 
ªt
;

795 
	`ã°_msg
("runningÉxtent I/OÅests");

797 
ªt
 = 
	`ã°_föd_dñÆloc
(
£˘‹size
);

798 i‡(
ªt
)

799 
out
;

801 
ªt
 = 
	`ã°_föd_fú°_˛ór_exã¡_bô
();

802 i‡(
ªt
)

803 
out
;

805 
ªt
 = 
	`ã°_eb_bôm≠s
(
£˘‹size
, 
nodesize
);

806 i‡(
ªt
)

807 
out
;

809 
ªt
 = 
	`ã°_eb_mem_›s
(
£˘‹size
, 
nodesize
);

810 
out
:

811  
ªt
;

812 
	}
}

	@tests/extent-map-tests.c

6 
	~<löux/ty≥s.h
>

7 
	~"båfs-ã°s.h
"

8 
	~"../˘ªe.h
"

9 
	~"../båfs_öode.h
"

10 
	~"../vﬁumes.h
"

11 
	~"../disk-io.h
"

12 
	~"../block-group.h
"

14 
	$‰ì_exã¡_m≠_åì
(
exã¡_m≠_åì
 *
em_åì
)

16 
exã¡_m≠
 *
em
;

17 
rb_node
 *
node
;

19 
	`wrôe_lock
(&
em_åì
->
lock
);

20 !
	`RB_EMPTY_ROOT
(&
em_åì
->
m≠
.
rb_roŸ
)) {

21 
node
 = 
	`rb_fú°_ˇched
(&
em_åì
->
m≠
);

22 
em
 = 
	`rb_íåy
(
node
, 
exã¡_m≠
, 
rb_node
);

23 
	`ªmove_exã¡_m≠pög
(
em_åì
, 
em
);

25 #ifde‡
CONFIG_BTRFS_DEBUG


26 i‡(
	`ªfcou¡_ªad
(&
em
->
ªfs
) != 1) {

27 
	`ã°_îr
(

29 
em
->
°¨t
,Ém->
Àn
,Ém->
block_°¨t
,

30 
em
->
block_Àn
, 
	`ªfcou¡_ªad
(&em->
ªfs
));

32 
	`ªfcou¡_£t
(&
em
->
ªfs
, 1);

35 
	`‰ì_exã¡_m≠
(
em
);

37 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

38 
	}
}

56 
	$ã°_ˇ£_1
(
båfs_fs_öfo
 *
fs_öfo
,

57 
exã¡_m≠_åì
 *
em_åì
)

59 
exã¡_m≠
 *
em
;

60 
u64
 
°¨t
 = 0;

61 
u64
 
Àn
 = 
SZ_8K
;

62 
ªt
;

64 
em
 = 
	`Æloc_exã¡_m≠
();

65 i‡(!
em
) {

66 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

67  -
ENOMEM
;

71 
em
->
°¨t
 = 0;

72 
em
->
Àn
 = 
SZ_16K
;

73 
em
->
block_°¨t
 = 0;

74 
em
->
block_Àn
 = 
SZ_16K
;

75 
	`wrôe_lock
(&
em_åì
->
lock
);

76 
ªt
 = 
	`add_exã¡_m≠pög
(
em_åì
, 
em
, 0);

77 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

78 i‡(
ªt
 < 0) {

79 
	`ã°_îr
("cannotáddÉxtentÑange [0, 16K)");

80 
out
;

82 
	`‰ì_exã¡_m≠
(
em
);

85 
em
 = 
	`Æloc_exã¡_m≠
();

86 i‡(!
em
) {

87 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

88 
ªt
 = -
ENOMEM
;

89 
out
;

92 
em
->
°¨t
 = 
SZ_16K
;

93 
em
->
Àn
 = 
SZ_4K
;

94 
em
->
block_°¨t
 = 
SZ_32K
;

95 
em
->
block_Àn
 = 
SZ_4K
;

96 
	`wrôe_lock
(&
em_åì
->
lock
);

97 
ªt
 = 
	`add_exã¡_m≠pög
(
em_åì
, 
em
, 0);

98 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

99 i‡(
ªt
 < 0) {

100 
	`ã°_îr
("cannotáddÉxtentÑange [16K, 20K)");

101 
out
;

103 
	`‰ì_exã¡_m≠
(
em
);

105 
em
 = 
	`Æloc_exã¡_m≠
();

106 i‡(!
em
) {

107 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

108 
ªt
 = -
ENOMEM
;

109 
out
;

113 
em
->
°¨t
 = start;

114 
em
->
Àn
 =Üen;

115 
em
->
block_°¨t
 = 
°¨t
;

116 
em
->
block_Àn
 = 
Àn
;

117 
	`wrôe_lock
(&
em_åì
->
lock
);

118 
ªt
 = 
	`båfs_add_exã¡_m≠pög
(
fs_öfo
, 
em_åì
, &
em
,Ém->
°¨t
,Ém->
Àn
);

119 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

120 i‡(
ªt
) {

121 
	`ã°_îr
("ˇ£1 [%Œu %Œu]:Ñë %d", 
°¨t
, sèπ + 
Àn
, 
ªt
);

122 
out
;

124 i‡(
em
 &&

125 (
em
->
°¨t
 !0 || 
	`exã¡_m≠_íd
”mË!
SZ_16K
 ||

126 
em
->
block_°¨t
 !0 ||Ém->
block_Àn
 !
SZ_16K
)) {

127 
	`ã°_îr
(

129 
°¨t
, sèπ + 
Àn
, 
ªt
, 
em
->start,Ém->len,

130 
em
->
block_°¨t
,Ém->
block_Àn
);

131 
ªt
 = -
EINVAL
;

133 
	`‰ì_exã¡_m≠
(
em
);

134 
out
:

135 
	`‰ì_exã¡_m≠_åì
(
em_åì
);

137  
ªt
;

138 
	}
}

146 
	$ã°_ˇ£_2
(
båfs_fs_öfo
 *
fs_öfo
,

147 
exã¡_m≠_åì
 *
em_åì
)

149 
exã¡_m≠
 *
em
;

150 
ªt
;

152 
em
 = 
	`Æloc_exã¡_m≠
();

153 i‡(!
em
) {

154 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

155  -
ENOMEM
;

159 
em
->
°¨t
 = 0;

160 
em
->
Àn
 = 
SZ_1K
;

161 
em
->
block_°¨t
 = 
EXTENT_MAP_INLINE
;

162 
em
->
block_Àn
 = (
u64
)-1;

163 
	`wrôe_lock
(&
em_åì
->
lock
);

164 
ªt
 = 
	`add_exã¡_m≠pög
(
em_åì
, 
em
, 0);

165 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

166 i‡(
ªt
 < 0) {

167 
	`ã°_îr
("cannotáddÉxtentÑange [0, 1K)");

168 
out
;

170 
	`‰ì_exã¡_m≠
(
em
);

173 
em
 = 
	`Æloc_exã¡_m≠
();

174 i‡(!
em
) {

175 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

176 
ªt
 = -
ENOMEM
;

177 
out
;

180 
em
->
°¨t
 = 
SZ_4K
;

181 
em
->
Àn
 = 
SZ_4K
;

182 
em
->
block_°¨t
 = 
SZ_4K
;

183 
em
->
block_Àn
 = 
SZ_4K
;

184 
	`wrôe_lock
(&
em_åì
->
lock
);

185 
ªt
 = 
	`add_exã¡_m≠pög
(
em_åì
, 
em
, 0);

186 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

187 i‡(
ªt
 < 0) {

188 
	`ã°_îr
("cannotáddÉxtentÑange [4K, 8K)");

189 
out
;

191 
	`‰ì_exã¡_m≠
(
em
);

193 
em
 = 
	`Æloc_exã¡_m≠
();

194 i‡(!
em
) {

195 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

196 
ªt
 = -
ENOMEM
;

197 
out
;

201 
em
->
°¨t
 = 0;

202 
em
->
Àn
 = 
SZ_1K
;

203 
em
->
block_°¨t
 = 
EXTENT_MAP_INLINE
;

204 
em
->
block_Àn
 = (
u64
)-1;

205 
	`wrôe_lock
(&
em_åì
->
lock
);

206 
ªt
 = 
	`båfs_add_exã¡_m≠pög
(
fs_öfo
, 
em_åì
, &
em
,Ém->
°¨t
,Ém->
Àn
);

207 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

208 i‡(
ªt
) {

209 
	`ã°_îr
("ˇ£2 [0 1K]:Ñë %d", 
ªt
);

210 
out
;

212 i‡(
em
 &&

213 (
em
->
°¨t
 !0 || 
	`exã¡_m≠_íd
”mË!
SZ_1K
 ||

214 
em
->
block_°¨t
 !
EXTENT_MAP_INLINE
 ||Ém->
block_Àn
 !(
u64
)-1)) {

215 
	`ã°_îr
(

217 
ªt
, 
em
->
°¨t
,Ém->
Àn
,Ém->
block_°¨t
,

218 
em
->
block_Àn
);

219 
ªt
 = -
EINVAL
;

221 
	`‰ì_exã¡_m≠
(
em
);

222 
out
:

223 
	`‰ì_exã¡_m≠_åì
(
em_åì
);

225  
ªt
;

226 
	}
}

228 
	$__ã°_ˇ£_3
(
båfs_fs_öfo
 *
fs_öfo
,

229 
exã¡_m≠_åì
 *
em_åì
, 
u64
 
°¨t
)

231 
exã¡_m≠
 *
em
;

232 
u64
 
Àn
 = 
SZ_4K
;

233 
ªt
;

235 
em
 = 
	`Æloc_exã¡_m≠
();

236 i‡(!
em
) {

237 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

238  -
ENOMEM
;

242 
em
->
°¨t
 = 
SZ_4K
;

243 
em
->
Àn
 = 
SZ_4K
;

244 
em
->
block_°¨t
 = 
SZ_4K
;

245 
em
->
block_Àn
 = 
SZ_4K
;

246 
	`wrôe_lock
(&
em_åì
->
lock
);

247 
ªt
 = 
	`add_exã¡_m≠pög
(
em_åì
, 
em
, 0);

248 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

249 i‡(
ªt
 < 0) {

250 
	`ã°_îr
("cannotáddÉxtentÑange [4K, 8K)");

251 
out
;

253 
	`‰ì_exã¡_m≠
(
em
);

255 
em
 = 
	`Æloc_exã¡_m≠
();

256 i‡(!
em
) {

257 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

258 
ªt
 = -
ENOMEM
;

259 
out
;

263 
em
->
°¨t
 = 0;

264 
em
->
Àn
 = 
SZ_16K
;

265 
em
->
block_°¨t
 = 0;

266 
em
->
block_Àn
 = 
SZ_16K
;

267 
	`wrôe_lock
(&
em_åì
->
lock
);

268 
ªt
 = 
	`båfs_add_exã¡_m≠pög
(
fs_öfo
, 
em_åì
, &
em
, 
°¨t
, 
Àn
);

269 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

270 i‡(
ªt
) {

271 
	`ã°_îr
("case3 [0x%llx 0x%llx):Ñet %d",

272 
°¨t
, sèπ + 
Àn
, 
ªt
);

273 
out
;

279 i‡(
em
 &&

280 (
°¨t
 < 
em
->°¨à|| sèπ + 
Àn
 > 
	`exã¡_m≠_íd
(em) ||

281 
em
->
°¨t
 !em->
block_°¨t
 ||Ém->
Àn
 !em->
block_Àn
)) {

282 
	`ã°_îr
(

284 
°¨t
, sèπ + 
Àn
, 
ªt
, 
em
->start,Ém->len,

285 
em
->
block_°¨t
,Ém->
block_Àn
);

286 
ªt
 = -
EINVAL
;

288 
	`‰ì_exã¡_m≠
(
em
);

289 
out
:

290 
	`‰ì_exã¡_m≠_åì
(
em_åì
);

292  
ªt
;

293 
	}
}

311 
	$ã°_ˇ£_3
(
båfs_fs_öfo
 *
fs_öfo
,

312 
exã¡_m≠_åì
 *
em_åì
)

314 
ªt
;

316 
ªt
 = 
	`__ã°_ˇ£_3
(
fs_öfo
, 
em_åì
, 0);

317 i‡(
ªt
)

318  
ªt
;

319 
ªt
 = 
	`__ã°_ˇ£_3
(
fs_öfo
, 
em_åì
, 
SZ_8K
);

320 i‡(
ªt
)

321  
ªt
;

322 
ªt
 = 
	`__ã°_ˇ£_3
(
fs_öfo
, 
em_åì
, (12 * 
SZ_1K
));

324  
ªt
;

325 
	}
}

327 
	$__ã°_ˇ£_4
(
båfs_fs_öfo
 *
fs_öfo
,

328 
exã¡_m≠_åì
 *
em_åì
, 
u64
 
°¨t
)

330 
exã¡_m≠
 *
em
;

331 
u64
 
Àn
 = 
SZ_4K
;

332 
ªt
;

334 
em
 = 
	`Æloc_exã¡_m≠
();

335 i‡(!
em
) {

336 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

337  -
ENOMEM
;

341 
em
->
°¨t
 = 0;

342 
em
->
Àn
 = 
SZ_8K
;

343 
em
->
block_°¨t
 = 0;

344 
em
->
block_Àn
 = 
SZ_8K
;

345 
	`wrôe_lock
(&
em_åì
->
lock
);

346 
ªt
 = 
	`add_exã¡_m≠pög
(
em_åì
, 
em
, 0);

347 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

348 i‡(
ªt
 < 0) {

349 
	`ã°_îr
("cannotáddÉxtentÑange [0, 8K)");

350 
out
;

352 
	`‰ì_exã¡_m≠
(
em
);

354 
em
 = 
	`Æloc_exã¡_m≠
();

355 i‡(!
em
) {

356 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

357 
ªt
 = -
ENOMEM
;

358 
out
;

362 
em
->
°¨t
 = 
SZ_8K
;

363 
em
->
Àn
 = 24 * 
SZ_1K
;

364 
em
->
block_°¨t
 = 
SZ_16K
;

365 
em
->
block_Àn
 = 24 * 
SZ_1K
;

366 
	`wrôe_lock
(&
em_åì
->
lock
);

367 
ªt
 = 
	`add_exã¡_m≠pög
(
em_åì
, 
em
, 0);

368 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

369 i‡(
ªt
 < 0) {

370 
	`ã°_îr
("cannotáddÉxtentÑange [8K, 32K)");

371 
out
;

373 
	`‰ì_exã¡_m≠
(
em
);

375 
em
 = 
	`Æloc_exã¡_m≠
();

376 i‡(!
em
) {

377 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

378 
ªt
 = -
ENOMEM
;

379 
out
;

382 
em
->
°¨t
 = 0;

383 
em
->
Àn
 = 
SZ_32K
;

384 
em
->
block_°¨t
 = 0;

385 
em
->
block_Àn
 = 
SZ_32K
;

386 
	`wrôe_lock
(&
em_åì
->
lock
);

387 
ªt
 = 
	`båfs_add_exã¡_m≠pög
(
fs_öfo
, 
em_åì
, &
em
, 
°¨t
, 
Àn
);

388 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

389 i‡(
ªt
) {

390 
	`ã°_îr
("case4 [0x%llx 0x%llx):Ñet %d",

391 
°¨t
, 
Àn
, 
ªt
);

392 
out
;

394 i‡(
em
 && (
°¨t
 <Ém->°¨à|| sèπ + 
Àn
 > 
	`exã¡_m≠_íd
(em))) {

395 
	`ã°_îr
(

397 
°¨t
, 
Àn
, 
ªt
, 
em
->°¨t,Ém->Àn,Ém->
block_°¨t
,

398 
em
->
block_Àn
);

399 
ªt
 = -
EINVAL
;

401 
	`‰ì_exã¡_m≠
(
em
);

402 
out
:

403 
	`‰ì_exã¡_m≠_åì
(
em_åì
);

405  
ªt
;

406 
	}
}

433 
	$ã°_ˇ£_4
(
båfs_fs_öfo
 *
fs_öfo
,

434 
exã¡_m≠_åì
 *
em_åì
)

436 
ªt
;

438 
ªt
 = 
	`__ã°_ˇ£_4
(
fs_öfo
, 
em_åì
, 0);

439 i‡(
ªt
)

440  
ªt
;

441 
ªt
 = 
	`__ã°_ˇ£_4
(
fs_öfo
, 
em_åì
, 
SZ_4K
);

443  
ªt
;

444 
	}
}

446 
	$add_com¥es£d_exã¡
(
exã¡_m≠_åì
 *
em_åì
,

447 
u64
 
°¨t
, u64 
Àn
, u64 
block_°¨t
)

449 
exã¡_m≠
 *
em
;

450 
ªt
;

452 
em
 = 
	`Æloc_exã¡_m≠
();

453 i‡(!
em
) {

454 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

455  -
ENOMEM
;

458 
em
->
°¨t
 = start;

459 
em
->
Àn
 =Üen;

460 
em
->
block_°¨t
 = block_start;

461 
em
->
block_Àn
 = 
SZ_4K
;

462 
	`£t_bô
(
EXTENT_FLAG_COMPRESSED
, &
em
->
Êags
);

463 
	`wrôe_lock
(&
em_åì
->
lock
);

464 
ªt
 = 
	`add_exã¡_m≠pög
(
em_åì
, 
em
, 0);

465 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

466 
	`‰ì_exã¡_m≠
(
em
);

467 i‡(
ªt
 < 0) {

468 
	`ã°_îr
("ˇ¬ŸáddÉxã¡ m≠ [%Œu, %Œu)", 
°¨t
, sèπ + 
Àn
);

469  
ªt
;

473 
	}
}

475 
	sexã¡_ønge
 {

476 
u64
 
	m°¨t
;

477 
u64
 
	mÀn
;

481 
exã¡_ønge
 
	gvÆid_ønges
[][7] = {

483 { .
°¨t
 = 0, .
	gÀn
 = 
SZ_8K
 },

484 { .
	g°¨t
 = 
SZ_4K
 * 3, .
	gÀn
 = SZ_4K * 3},

485 { .
	g°¨t
 = 
SZ_4K
 * 6, .
	gÀn
 = SZ_4K * 3},

486 { .
	g°¨t
 = 
SZ_32K
 + 
SZ_4K
, .
	gÀn
 = SZ_4K},

487 { .
	g°¨t
 = 
SZ_4K
 * 10, .
	gÀn
 = SZ_4K * 6},

490 { .
	g°¨t
 = 0, .
	gÀn
 = 
SZ_8K
 },

491 { .
	g°¨t
 = 
SZ_4K
 * 5, .
	gÀn
 = SZ_4K},

492 { .
	g°¨t
 = 
SZ_4K
 * 6, .
	gÀn
 = SZ_4K * 3},

493 { .
	g°¨t
 = 
SZ_32K
 + 
SZ_4K
, .
	gÀn
 = SZ_4K},

494 { .
	g°¨t
 = 
SZ_4K
 * 10, .
	gÀn
 = SZ_4K * 6},

497 { .
	g°¨t
 = 0, .
	gÀn
 = 
SZ_8K
 },

498 { .
	g°¨t
 = 
SZ_4K
 * 5, .
	gÀn
 = SZ_4K},

499 { .
	g°¨t
 = 
SZ_4K
 * 6, .
	gÀn
 = SZ_4K},

500 { .
	g°¨t
 = 
SZ_32K
, .
	gÀn
 = 
SZ_4K
},

501 { .
	g°¨t
 = 
SZ_32K
 + 
SZ_4K
, .
	gÀn
 = SZ_4K},

502 { .
	g°¨t
 = 
SZ_4K
 * 10, .
	gÀn
 = SZ_4K * 6},

505 { .
	g°¨t
 = 0, .
	gÀn
 = 
SZ_8K
},

506 { .
	g°¨t
 = 
SZ_4K
 * 5, .
	gÀn
 = SZ_4K},

507 { .
	g°¨t
 = 
SZ_4K
 * 6, .
	gÀn
 = SZ_4K},

511 
	$vÆid©e_ønge
(
exã¡_m≠_åì
 *
em_åì
, 
ödex
)

513 
rb_node
 *
n
;

514 
i
;

516 
i
 = 0, 
n
 = 
	`rb_fú°_ˇched
(&
em_åì
->
m≠
);

517 
vÆid_ønges
[
ödex
][
i
].
Àn
 && 
n
;

518 
i
++, 
n
 = 
	`rb_√xt
(n)) {

519 
exã¡_m≠
 *
íåy
 = 
	`rb_íåy
(
n
, exã¡_m≠, 
rb_node
);

521 i‡(
íåy
->
°¨t
 !
vÆid_ønges
[
ödex
][
i
].start) {

522 
	`ã°_îr
("mapping has start %lluÉxpected %llu",

523 
íåy
->
°¨t
, 
vÆid_ønges
[
ödex
][
i
].start);

524  -
EINVAL
;

527 i‡(
íåy
->
Àn
 !
vÆid_ønges
[
ödex
][
i
].len) {

528 
	`ã°_îr
("mapping hasÜen %lluÉxpected %llu",

529 
íåy
->
Àn
, 
vÆid_ønges
[
ödex
][
i
].len);

530  -
EINVAL
;

538 i‡(
vÆid_ønges
[
ödex
][
i
].
Àn
) {

539 
	`ã°_îr
("missingánÉntry");

540  -
EINVAL
;

544 i‡(
n
) {

545 
	`ã°_îr
("we haveáÜeft overÉntry inÅheÉxtent map we didn'tÉxpect");

546  -
EINVAL
;

550 
	}
}

570 
	$ã°_ˇ£_5
()

572 
exã¡_m≠_åì
 *
em_åì
;

573 
öode
 *inode;

574 
u64
 
°¨t
, 
íd
;

575 
ªt
;

577 
	`ã°_msg
("Running btrfs_drop_extent_map_rangeÅests");

579 
öode
 = 
	`båfs_√w_ã°_öode
();

580 i‡(!
öode
) {

581 
	`ã°_°d_îr
(
TEST_ALLOC_INODE
);

582  -
ENOMEM
;

585 
em_åì
 = &
	`BTRFS_I
(
öode
)->
exã¡_åì
;

588 
ªt
 = 
	`add_com¥es£d_exã¡
(
em_åì
, 0, 
SZ_4K
 * 3, 0);

589 i‡(
ªt
) {

590 
	`ã°_îr
("cannotáddÉxtentÑange [0, 12K)");

591 
out
;

595 
ªt
 = 
	`add_com¥es£d_exã¡
(
em_åì
, 
SZ_4K
 * 3, SZ_4K * 3, SZ_4K);

596 i‡(
ªt
) {

597 
	`ã°_îr
("cannotáddÉxtentÑange [12k, 24k)");

598 
out
;

602 
ªt
 = 
	`add_com¥es£d_exã¡
(
em_åì
, 
SZ_4K
 * 6, SZ_4K * 3, 
SZ_8K
);

603 i‡(
ªt
) {

604 
	`ã°_îr
("cannotáddÉxtentÑange [12k, 24k)");

605 
out
;

609 
ªt
 = 
	`add_com¥es£d_exã¡
(
em_åì
, 
SZ_32K
 + 
SZ_4K
, SZ_4K, SZ_4K * 3);

610 i‡(
ªt
) {

611 
	`ã°_îr
("cannotáddÉxtentÑange [12k, 24k)");

612 
out
;

616 
ªt
 = 
	`add_com¥es£d_exã¡
(
em_åì
, 
SZ_4K
 * 10, SZ_4K * 6, 
SZ_16K
);

617 i‡(
ªt
) {

618 
	`ã°_îr
("cannotáddÉxtentÑange [12k, 24k)");

619 
out
;

623 
°¨t
 = 
SZ_8K
;

624 
íd
 = (3 * 
SZ_4K
) - 1;

625 
	`båfs_dr›_exã¡_m≠_ønge
(
	`BTRFS_I
(
öode
), 
°¨t
, 
íd
, 
Ál£
);

626 
ªt
 = 
	`vÆid©e_ønge
(&
	`BTRFS_I
(
öode
)->
exã¡_åì
, 0);

627 i‡(
ªt
)

628 
out
;

631 
°¨t
 = 
SZ_4K
 * 3;

632 
íd
 = 
SZ_16K
 + 
SZ_4K
 - 1;

633 
	`båfs_dr›_exã¡_m≠_ønge
(
	`BTRFS_I
(
öode
), 
°¨t
, 
íd
, 
Ál£
);

634 
ªt
 = 
	`vÆid©e_ønge
(&
	`BTRFS_I
(
öode
)->
exã¡_åì
, 1);

635 i‡(
ªt
)

636 
out
;

639 
°¨t
 = 
SZ_32K
 - 
SZ_4K
;

640 
íd
 = 
SZ_32K
 - 1;

641 
	`båfs_dr›_exã¡_m≠_ønge
(
	`BTRFS_I
(
öode
), 
°¨t
, 
íd
, 
Ál£
);

642 
ªt
 = 
	`vÆid©e_ønge
(&
	`BTRFS_I
(
öode
)->
exã¡_åì
, 2);

643 i‡(
ªt
)

644 
out
;

647 
°¨t
 = 
SZ_32K
;

648 
íd
 = 
SZ_64K
 - 1;

649 
	`båfs_dr›_exã¡_m≠_ønge
(
	`BTRFS_I
(
öode
), 
°¨t
, 
íd
, 
Ál£
);

650 
ªt
 = 
	`vÆid©e_ønge
(&
	`BTRFS_I
(
öode
)->
exã¡_åì
, 3);

651 i‡(
ªt
)

652 
out
;

653 
out
:

654 
	`ùut
(
öode
);

655  
ªt
;

656 
	}
}

663 
	$ã°_ˇ£_6
(
båfs_fs_öfo
 *
fs_öfo
, 
exã¡_m≠_åì
 *
em_åì
)

665 
exã¡_m≠
 *
em
 = 
NULL
;

666 
ªt
;

668 
ªt
 = 
	`add_com¥es£d_exã¡
(
em_åì
, 0, 
SZ_4K
, 0);

669 i‡(
ªt
)

670 
out
;

672 
ªt
 = 
	`add_com¥es£d_exã¡
(
em_åì
, 
SZ_4K
, SZ_4K, 0);

673 i‡(
ªt
)

674 
out
;

676 
em
 = 
	`Æloc_exã¡_m≠
();

677 i‡(!
em
) {

678 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

679  -
ENOMEM
;

682 
em
->
°¨t
 = 
SZ_4K
;

683 
em
->
Àn
 = 
SZ_4K
;

684 
em
->
block_°¨t
 = 
SZ_16K
;

685 
em
->
block_Àn
 = 
SZ_16K
;

686 
	`wrôe_lock
(&
em_åì
->
lock
);

687 
ªt
 = 
	`båfs_add_exã¡_m≠pög
(
fs_öfo
, 
em_åì
, &
em
, 0, 
SZ_8K
);

688 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

690 i‡(
ªt
 != 0) {

691 
	`ã°_îr
("gŸá¿îr‹ whíáddög ou∏em: %d", 
ªt
);

692 
out
;

695 
ªt
 = -
EINVAL
;

696 i‡(
em
->
°¨t
 != 0) {

697 
	`ã°_îr
("u√x≥˘edÉm->°¨à© %Œu, w™ãd 0", 
em
->
°¨t
);

698 
out
;

700 i‡(
em
->
Àn
 !
SZ_4K
) {

701 
	`ã°_îr
("u√x≥˘edÉm->À¿%Œu,Éx≥˘ed 4K", 
em
->
Àn
);

702 
out
;

704 
ªt
 = 0;

705 
out
:

706 
	`‰ì_exã¡_m≠
(
em
);

707 
	`‰ì_exã¡_m≠_åì
(
em_åì
);

708  
ªt
;

709 
	}
}

716 
	$ã°_ˇ£_7
()

718 
exã¡_m≠_åì
 *
em_åì
;

719 
exã¡_m≠
 *
em
;

720 
öode
 *inode;

721 
ªt
;

723 
	`ã°_msg
("Running btrfs_drop_extent_cache withÖinned");

725 
öode
 = 
	`båfs_√w_ã°_öode
();

726 i‡(!
öode
) {

727 
	`ã°_°d_îr
(
TEST_ALLOC_INODE
);

728  -
ENOMEM
;

731 
em_åì
 = &
	`BTRFS_I
(
öode
)->
exã¡_åì
;

733 
em
 = 
	`Æloc_exã¡_m≠
();

734 i‡(!
em
) {

735 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

736 
ªt
 = -
ENOMEM
;

737 
out
;

741 
em
->
°¨t
 = 0;

742 
em
->
Àn
 = 
SZ_16K
;

743 
em
->
block_°¨t
 = 0;

744 
em
->
block_Àn
 = 
SZ_4K
;

745 
	`£t_bô
(
EXTENT_FLAG_PINNED
, &
em
->
Êags
);

746 
	`wrôe_lock
(&
em_åì
->
lock
);

747 
ªt
 = 
	`add_exã¡_m≠pög
(
em_åì
, 
em
, 0);

748 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

749 i‡(
ªt
 < 0) {

750 
	`ã°_îr
("couldn'táddÉxtent map");

751 
out
;

753 
	`‰ì_exã¡_m≠
(
em
);

755 
em
 = 
	`Æloc_exã¡_m≠
();

756 i‡(!
em
) {

757 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

758 
ªt
 = -
ENOMEM
;

759 
out
;

763 
em
->
°¨t
 = 
SZ_32K
;

764 
em
->
Àn
 = 
SZ_16K
;

765 
em
->
block_°¨t
 = 
SZ_32K
;

766 
em
->
block_Àn
 = 
SZ_16K
;

767 
	`wrôe_lock
(&
em_åì
->
lock
);

768 
ªt
 = 
	`add_exã¡_m≠pög
(
em_åì
, 
em
, 0);

769 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

770 i‡(
ªt
 < 0) {

771 
	`ã°_îr
("couldn'táddÉxtent map");

772 
out
;

774 
	`‰ì_exã¡_m≠
(
em
);

780 
	`båfs_dr›_exã¡_m≠_ønge
(
	`BTRFS_I
(
öode
), 0, (36 * 
SZ_1K
Ë- 1, 
åue
);

783 
ªt
 = -
EINVAL
;

785 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 0, 
SZ_16K
);

786 i‡(!
em
) {

787 
	`ã°_îr
("didn't findánÉmát 0ásÉxpected");

788 
out
;

791 i‡(
em
->
°¨t
 != 0) {

792 
	`ã°_îr
("em->°¨ài†%Œu,Éx≥˘ed 0", 
em
->
°¨t
);

793 
out
;

796 i‡(
em
->
Àn
 !
SZ_16K
) {

797 
	`ã°_îr
("em->À¿i†%Œu,Éx≥˘ed 16K", 
em
->
Àn
);

798 
out
;

801 
	`‰ì_exã¡_m≠
(
em
);

803 
	`ªad_lock
(&
em_åì
->
lock
);

804 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 
SZ_16K
, SZ_16K);

805 
	`ªad_u∆ock
(&
em_åì
->
lock
);

806 i‡(
em
) {

807 
	`ã°_îr
("foundánÉm when we weren'tÉxpecting one");

808 
out
;

811 
	`ªad_lock
(&
em_åì
->
lock
);

812 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 
SZ_32K
, 
SZ_16K
);

813 
	`ªad_u∆ock
(&
em_åì
->
lock
);

814 i‡(!
em
) {

815 
	`ã°_îr
("didn't findánÉmát 32KásÉxpected");

816 
out
;

819 i‡(
em
->
°¨t
 !(36 * 
SZ_1K
)) {

820 
	`ã°_îr
("em->°¨ài†%Œu,Éx≥˘ed 36K", 
em
->
°¨t
);

821 
out
;

824 i‡(
em
->
Àn
 !(12 * 
SZ_1K
)) {

825 
	`ã°_îr
("em->À¿i†%Œu,Éx≥˘ed 12K", 
em
->
Àn
);

826 
out
;

829 
	`‰ì_exã¡_m≠
(
em
);

831 
	`ªad_lock
(&
em_åì
->
lock
);

832 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 48 * 
SZ_1K
, (
u64
)-1);

833 
	`ªad_u∆ock
(&
em_åì
->
lock
);

834 i‡(
em
) {

835 
	`ã°_îr
("foundán unexpectedÉmábove 48K");

836 
out
;

839 
ªt
 = 0;

840 
out
:

841 
	`‰ì_exã¡_m≠
(
em
);

842 
	`ùut
(
öode
);

843  
ªt
;

844 
	}
}

846 
	srm≠_ã°_ve˘‹
 {

847 
u64
 
	møid_ty≥
;

848 
u64
 
	mphysiˇl_°¨t
;

849 
u64
 
	md©a_°rùe_size
;

850 
u64
 
	mnum_d©a_°rùes
;

851 
u64
 
	mnum_°rùes
;

853 
u64
 
	md©a_°rùe_phys_°¨t
[5];

854 
boﬁ
 
	mex≥˘ed_m≠≥d_addr
;

856 
u64
 
	mm≠≥d_logiˇl
[5];

859 
	$ã°_rm≠_block
(
båfs_fs_öfo
 *
fs_öfo
,

860 
rm≠_ã°_ve˘‹
 *
ã°
)

862 
exã¡_m≠
 *
em
;

863 
m≠_lookup
 *
m≠
 = 
NULL
;

864 
u64
 *
logiˇl
 = 
NULL
;

865 
i
, 
out_ndaddrs
, 
out_°rùe_Àn
;

866 
ªt
;

868 
em
 = 
	`Æloc_exã¡_m≠
();

869 i‡(!
em
) {

870 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

871  -
ENOMEM
;

874 
m≠
 = 
	`kmÆloc
(
	`m≠_lookup_size
(
ã°
->
num_°rùes
), 
GFP_KERNEL
);

875 i‡(!
m≠
) {

876 
	`k‰ì
(
em
);

877 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_MAP
);

878  -
ENOMEM
;

881 
	`£t_bô
(
EXTENT_FLAG_FS_MAPPING
, &
em
->
Êags
);

883 
em
->
°¨t
 = 
SZ_4G
;

884 
em
->
Àn
 = 
ã°
->
d©a_°rùe_size
 *Åe°->
num_d©a_°rùes
;

885 
em
->
block_Àn
 =Ém->
Àn
;

886 
em
->
‹ig_block_Àn
 = 
ã°
->
d©a_°rùe_size
;

887 
em
->
m≠_lookup
 = 
m≠
;

889 
m≠
->
num_°rùes
 = 
ã°
->num_stripes;

890 
m≠
->
ty≥
 = 
ã°
->
øid_ty≥
;

892 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

893 
båfs_devi˚
 *
dev
 = 
	`båfs_Æloc_dummy_devi˚
(
fs_öfo
);

895 i‡(
	`IS_ERR
(
dev
)) {

896 
	`ã°_îr
("cannotállocate device");

897 
ªt
 = 
	`PTR_ERR
(
dev
);

898 
out
;

900 
m≠
->
°rùes
[
i
].
dev
 = dev;

901 
m≠
->
°rùes
[
i
].
physiˇl
 = 
ã°
->
d©a_°rùe_phys_°¨t
[i];

904 
	`wrôe_lock
(&
fs_öfo
->
m≠pög_åì
.
lock
);

905 
ªt
 = 
	`add_exã¡_m≠pög
(&
fs_öfo
->
m≠pög_åì
, 
em
, 0);

906 
	`wrôe_u∆ock
(&
fs_öfo
->
m≠pög_åì
.
lock
);

907 i‡(
ªt
) {

908 
	`ã°_îr
("errorádding block group mappingÅo mappingÅree");

909 
out_‰ì
;

912 
ªt
 = 
	`båfs_rm≠_block
(
fs_öfo
, 
em
->
°¨t
, 
	`båfs_sb_off£t
(1),

913 &
logiˇl
, &
out_ndaddrs
, &
out_°rùe_Àn
);

914 i‡(
ªt
 || (
out_ndaddrs
 =0 && 
ã°
->
ex≥˘ed_m≠≥d_addr
)) {

915 
	`ã°_îr
("didn'tÑmapánything butÉxpected %d",

916 
ã°
->
ex≥˘ed_m≠≥d_addr
);

917 
out
;

920 i‡(
out_°rùe_Àn
 !
BTRFS_STRIPE_LEN
) {

921 
	`ã°_îr
("calculated stripeÜength doesn't match");

922 
out
;

925 i‡(
out_ndaddrs
 !
ã°
->
ex≥˘ed_m≠≥d_addr
) {

926 
i
 = 0; i < 
out_ndaddrs
; i++)

927 
	`ã°_msg
("m≠≥d %Œu", 
logiˇl
[
i
]);

928 
	`ã°_îr
("u√x≥˘edÇumbî o‡m≠≥dáddªs£s: %d", 
out_ndaddrs
);

929 
out
;

932 
i
 = 0; i < 
out_ndaddrs
; i++) {

933 i‡(
logiˇl
[
i
] !
ã°
->
m≠≥d_logiˇl
[i]) {

934 
	`ã°_îr
("unexpectedÜogicaláddress mapped");

935 
out
;

939 
ªt
 = 0;

940 
out
:

941 
	`wrôe_lock
(&
fs_öfo
->
m≠pög_åì
.
lock
);

942 
	`ªmove_exã¡_m≠pög
(&
fs_öfo
->
m≠pög_åì
, 
em
);

943 
	`wrôe_u∆ock
(&
fs_öfo
->
m≠pög_åì
.
lock
);

945 
	`‰ì_exã¡_m≠
(
em
);

946 
out_‰ì
:

948 
	`‰ì_exã¡_m≠
(
em
);

949 
	`k‰ì
(
logiˇl
);

950  
ªt
;

951 
	}
}

953 
	$båfs_ã°_exã¡_m≠
()

955 
båfs_fs_öfo
 *
fs_öfo
 = 
NULL
;

956 
exã¡_m≠_åì
 *
em_åì
;

957 
ªt
 = 0, 
i
;

958 
rm≠_ã°_ve˘‹
 
rm≠_ã°s
[] = {

965 .
øid_ty≥
 = 
BTRFS_BLOCK_GROUP_RAID1
,

966 .
physiˇl_°¨t
 = 
SZ_64M
 - 
SZ_4M
,

967 .
d©a_°rùe_size
 = 
SZ_256M
,

968 .
num_d©a_°rùes
 = 2,

969 .
num_°rùes
 = 2,

970 .
d©a_°rùe_phys_°¨t
 =

971 {
SZ_64M
 - 
SZ_4M
, SZ_64M - SZ_4M + 
SZ_256M
},

972 .
ex≥˘ed_m≠≥d_addr
 = 
åue
,

973 .
m≠≥d_logiˇl
{
SZ_4G
 + 
SZ_4M
}

982 .
øid_ty≥
 = 0,

983 .
physiˇl_°¨t
 = 
SZ_4G
,

984 .
d©a_°rùe_size
 = 
SZ_256M
,

985 .
num_d©a_°rùes
 = 1,

986 .
num_°rùes
 = 1,

987 .
d©a_°rùe_phys_°¨t
 = {
SZ_256M
},

988 .
ex≥˘ed_m≠≥d_addr
 = 
Ál£
,

989 .
m≠≥d_logiˇl
 = {0}

993 
	`ã°_msg
("runningÉxtent_mapÅests");

999 
fs_öfo
 = 
	`båfs_Æloc_dummy_fs_öfo
(
PAGE_SIZE
, PAGE_SIZE);

1000 i‡(!
fs_öfo
) {

1001 
	`ã°_°d_îr
(
TEST_ALLOC_FS_INFO
);

1002  -
ENOMEM
;

1005 
em_åì
 = 
	`kzÆloc
((*em_åì), 
GFP_KERNEL
);

1006 i‡(!
em_åì
) {

1007 
ªt
 = -
ENOMEM
;

1008 
out
;

1011 
	`exã¡_m≠_åì_öô
(
em_åì
);

1013 
ªt
 = 
	`ã°_ˇ£_1
(
fs_öfo
, 
em_åì
);

1014 i‡(
ªt
)

1015 
out
;

1016 
ªt
 = 
	`ã°_ˇ£_2
(
fs_öfo
, 
em_åì
);

1017 i‡(
ªt
)

1018 
out
;

1019 
ªt
 = 
	`ã°_ˇ£_3
(
fs_öfo
, 
em_åì
);

1020 i‡(
ªt
)

1021 
out
;

1022 
ªt
 = 
	`ã°_ˇ£_4
(
fs_öfo
, 
em_åì
);

1023 i‡(
ªt
)

1024 
out
;

1025 
ªt
 = 
	`ã°_ˇ£_5
();

1026 i‡(
ªt
)

1027 
out
;

1028 
ªt
 = 
	`ã°_ˇ£_6
(
fs_öfo
, 
em_åì
);

1029 i‡(
ªt
)

1030 
out
;

1031 
ªt
 = 
	`ã°_ˇ£_7
();

1032 i‡(
ªt
)

1033 
out
;

1035 
	`ã°_msg
("runningÑmapÅests");

1036 
i
 = 0; i < 
	`ARRAY_SIZE
(
rm≠_ã°s
); i++) {

1037 
ªt
 = 
	`ã°_rm≠_block
(
fs_öfo
, &
rm≠_ã°s
[
i
]);

1038 i‡(
ªt
)

1039 
out
;

1042 
out
:

1043 
	`k‰ì
(
em_åì
);

1044 
	`båfs_‰ì_dummy_fs_öfo
(
fs_öfo
);

1046  
ªt
;

1047 
	}
}

	@tests/free-space-tests.c

6 
	~<löux/¶ab.h
>

7 
	~"båfs-ã°s.h
"

8 
	~"../˘ªe.h
"

9 
	~"../disk-io.h
"

10 
	~"../‰ì-•a˚-ˇche.h
"

11 
	~"../block-group.h
"

13 
	#BITS_PER_BITMAP
 (
PAGE_SIZE
 * 8UL)

	)

20 
	$ã°_exã¡s
(
båfs_block_group
 *
ˇche
)

22 
ªt
 = 0;

24 
	`ã°_msg
("runningÉxtent onlyÅests");

27 
ªt
 = 
	`båfs_add_‰ì_•a˚
(
ˇche
, 0, 
SZ_4M
);

28 i‡(
ªt
) {

29 
	`ã°_îr
("îr‹áddög inôü»exã¡†%d", 
ªt
);

30  
ªt
;

33 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
ˇche
, 0, 
SZ_4M
);

34 i‡(
ªt
) {

35 
	`ã°_îr
("îr‹ÑemovögÉxã¡ %d", 
ªt
);

36  
ªt
;

39 i‡(
	`ã°_check_exi°s
(
ˇche
, 0, 
SZ_4M
)) {

40 
	`ã°_îr
("fullÑemoveÜeft someÜingering space");

45 
ªt
 = 
	`båfs_add_‰ì_•a˚
(
ˇche
, 0, 
SZ_4M
);

46 i‡(
ªt
) {

47 
	`ã°_îr
("îr‹áddög hÆ‡exã¡ %d", 
ªt
);

48  
ªt
;

51 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
ˇche
, 3 * 
SZ_1M
, SZ_1M);

52 i‡(
ªt
) {

53 
	`ã°_îr
("îr‹ÑemovögÅaûÉnd %d", 
ªt
);

54  
ªt
;

57 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
ˇche
, 0, 
SZ_1M
);

58 i‡(
ªt
) {

59 
	`ã°_îr
("îr‹Ñemovög fr⁄àíd %d", 
ªt
);

60  
ªt
;

63 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
ˇche
, 
SZ_2M
, 4096);

64 i‡(
ªt
) {

65 
	`ã°_îr
("îr‹Ñemovög middÀÖõ˚ %d", 
ªt
);

66  
ªt
;

69 i‡(
	`ã°_check_exi°s
(
ˇche
, 0, 
SZ_1M
)) {

70 
	`ã°_îr
("still have spaceátÅhe front");

74 i‡(
	`ã°_check_exi°s
(
ˇche
, 
SZ_2M
, 4096)) {

75 
	`ã°_îr
("still have space inÅhe middle");

79 i‡(
	`ã°_check_exi°s
(
ˇche
, 3 * 
SZ_1M
, SZ_1M)) {

80 
	`ã°_îr
("still have spaceátÅheÉnd");

85 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
ˇche
);

88 
	}
}

90 
	$ã°_bôm≠s
(
båfs_block_group
 *
ˇche
, 
u32
 
£˘‹size
)

92 
u64
 
√xt_bôm≠_off£t
;

93 
ªt
;

95 
	`ã°_msg
("running bitmap onlyÅests");

97 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 0, 
SZ_4M
, 1);

98 i‡(
ªt
) {

99 
	`ã°_îr
("couldn'à¸óãá bôm≠É¡ry %d", 
ªt
);

100  
ªt
;

103 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
ˇche
, 0, 
SZ_4M
);

104 i‡(
ªt
) {

105 
	`ã°_îr
("îr‹Ñemovög bôm≠ fuŒÑ™gê%d", 
ªt
);

106  
ªt
;

109 i‡(
	`ã°_check_exi°s
(
ˇche
, 0, 
SZ_4M
)) {

110 
	`ã°_îr
("left some space in bitmap");

114 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 0, 
SZ_4M
, 1);

115 i‡(
ªt
) {

116 
	`ã°_îr
("couldn'àaddÅÿou∏bôm≠É¡ry %d", 
ªt
);

117  
ªt
;

120 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
ˇche
, 
SZ_1M
, 
SZ_2M
);

121 i‡(
ªt
) {

122 
	`ã°_îr
("couldn'àªmovêmiddÀ chunk %d", 
ªt
);

123  
ªt
;

130 
√xt_bôm≠_off£t
 = (
u64
)(
BITS_PER_BITMAP
 * 
£˘‹size
);

133 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 
√xt_bôm≠_off£t
 - 
SZ_2M
,

134 
SZ_4M
, 1);

135 i‡(
ªt
) {

136 
	`ã°_îr
("couldn'tádd spaceÅhat straddlesÅwo bitmaps %d",

137 
ªt
);

138  
ªt
;

141 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
ˇche
, 
√xt_bôm≠_off£t
 - 
SZ_1M
, 
SZ_2M
);

142 i‡(
ªt
) {

143 
	`ã°_îr
("couldn'àªmovêovîœµög s∑˚ %d", 
ªt
);

144  
ªt
;

147 i‡(
	`ã°_check_exi°s
(
ˇche
, 
√xt_bôm≠_off£t
 - 
SZ_1M
, 
SZ_2M
)) {

148 
	`ã°_îr
("left some space whenÑemoving overlapping");

152 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
ˇche
);

155 
	}
}

158 
	$ã°_bôm≠s_™d_exã¡s
(
båfs_block_group
 *
ˇche
,

159 
u32
 
£˘‹size
)

161 
u64
 
bôm≠_off£t
 = (u64)(
BITS_PER_BITMAP
 * 
£˘‹size
);

162 
ªt
;

164 
	`ã°_msg
("running bitmapándÉxtentÅests");

171 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 
SZ_4M
, 
SZ_1M
, 1);

172 i‡(
ªt
) {

173 
	`ã°_îr
("couldn'à¸óã bôm≠É¡ry %d", 
ªt
);

174  
ªt
;

177 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 0, 
SZ_1M
, 0);

178 i‡(
ªt
) {

179 
	`ã°_îr
("couldn'àaddÉxã¡É¡ry %d", 
ªt
);

180  
ªt
;

183 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
ˇche
, 0, 
SZ_1M
);

184 i‡(
ªt
) {

185 
	`ã°_îr
("couldn'àªmovêexã¡É¡ry %d", 
ªt
);

186  
ªt
;

189 i‡(
	`ã°_check_exi°s
(
ˇche
, 0, 
SZ_1M
)) {

190 
	`ã°_îr
("leftÑemnantsáfter ourÑemove");

195 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 0, 
SZ_1M
, 0);

196 i‡(
ªt
) {

197 
	`ã°_îr
("couldn'àª-addÉxã¡É¡ry %d", 
ªt
);

198  
ªt
;

201 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
ˇche
, 
SZ_4M
, 
SZ_1M
);

202 i‡(
ªt
) {

203 
	`ã°_îr
("couldn'àªmovê‰om bôm≠ %d", 
ªt
);

204  
ªt
;

207 i‡(
	`ã°_check_exi°s
(
ˇche
, 
SZ_4M
, 
SZ_1M
)) {

208 
	`ã°_îr
("leftÑemnants inÅhe bitmap");

216 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 
SZ_1M
, 
SZ_4M
, 1);

217 i‡(
ªt
) {

218 
	`ã°_îr
("couldn'àaddÅÿ®bôm≠ %d", 
ªt
);

219  
ªt
;

222 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
ˇche
, 
SZ_512K
, 3 * 
SZ_1M
);

223 i‡(
ªt
) {

224 
	`ã°_îr
("couldn'àªmovêovîœµög s∑˚ %d", 
ªt
);

225  
ªt
;

228 i‡(
	`ã°_check_exi°s
(
ˇche
, 
SZ_512K
, 3 * 
SZ_1M
)) {

229 
	`ã°_îr
("left overÖiecesáfterÑemoving overlapping");

233 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
ˇche
);

236 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 
SZ_4M
, SZ_4M, 1);

237 i‡(
ªt
) {

238 
	`ã°_îr
("couldn'àadd s∑˚Åÿthêbôm≠ %d", 
ªt
);

239  
ªt
;

242 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 
SZ_2M
, SZ_2M, 0);

243 i‡(
ªt
) {

244 
	`ã°_îr
("couldn'àaddÉxã¡Åÿthêˇchê%d", 
ªt
);

245  
ªt
;

248 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
ˇche
, 3 * 
SZ_1M
, 
SZ_4M
);

249 i‡(
ªt
) {

250 
	`ã°_îr
("¥obÀmÑemovög ovîœµög s∑˚ %d", 
ªt
);

251  
ªt
;

254 i‡(
	`ã°_check_exi°s
(
ˇche
, 3 * 
SZ_1M
, 
SZ_4M
)) {

255 
	`ã°_îr
("left something behind whenÑemoving space");

269 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
ˇche
);

270 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 
bôm≠_off£t
 + 
SZ_4M
, SZ_4M, 1);

271 i‡(
ªt
) {

272 
	`ã°_îr
("couldn'àadd bôm≠ %d", 
ªt
);

273  
ªt
;

276 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 
bôm≠_off£t
 - 
SZ_1M
,

277 5 * 
SZ_1M
, 0);

278 i‡(
ªt
) {

279 
	`ã°_îr
("couldn'àaddÉxã¡É¡ry %d", 
ªt
);

280  
ªt
;

283 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
ˇche
, 
bôm≠_off£t
 + 
SZ_1M
, 5 * SZ_1M);

284 i‡(
ªt
) {

285 
	`ã°_îr
("ÁûedÅÿ‰ì ou∏•a˚ %d", 
ªt
);

286  
ªt
;

289 i‡(
	`ã°_check_exi°s
(
ˇche
, 
bôm≠_off£t
 + 
SZ_1M
, 5 * SZ_1M)) {

290 
	`ã°_îr
("left stuff over");

294 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
ˇche
);

302 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 
SZ_1M
, 
SZ_2M
, 1);

303 i‡(
ªt
) {

304 
	`ã°_îr
("couldn'àadd bôm≠É¡ry %d", 
ªt
);

305  
ªt
;

308 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 3 * 
SZ_1M
, SZ_1M, 0);

309 i‡(
ªt
) {

310 
	`ã°_îr
("couldn'àaddÉxã¡É¡ry %d", 
ªt
);

311  
ªt
;

314 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
ˇche
, 
SZ_1M
, 3 * SZ_1M);

315 i‡(
ªt
) {

316 
	`ã°_îr
("îr‹Ñemovög bôm≠ándÉxã¡ ovîœµög %d", 
ªt
);

317  
ªt
;

320 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
ˇche
);

322 
	}
}

325 
boﬁ
 
	$ã°_u£_bôm≠
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

326 
båfs_‰ì_•a˚
 *
öfo
)

328  
˘l
->
‰ì_exã¡s
 > 0;

329 
	}
}

333 
	$check_num_exã¡s_™d_bôm≠s
(c⁄° 
båfs_block_group
 *
ˇche
,

334 c⁄° 
num_exã¡s
,

335 c⁄° 
num_bôm≠s
)

337 i‡(
ˇche
->
‰ì_•a˚_˘l
->
‰ì_exã¡s
 !
num_exã¡s
) {

338 
	`ã°_îr
(

340 
ˇche
->
‰ì_•a˚_˘l
->
‰ì_exã¡s
, 
num_exã¡s
);

341  -
EINVAL
;

343 i‡(
ˇche
->
‰ì_•a˚_˘l
->
tŸÆ_bôm≠s
 !
num_bôm≠s
) {

344 
	`ã°_îr
(

346 
ˇche
->
‰ì_•a˚_˘l
->
tŸÆ_bôm≠s
, 
num_bôm≠s
);

347  -
EINVAL
;

350 
	}
}

353 
	$check_ˇche_em±y
(
båfs_block_group
 *
ˇche
)

355 
u64
 
off£t
;

356 
u64
 
max_exã¡_size
;

362 i‡(
ˇche
->
‰ì_•a˚_˘l
->
‰ì_•a˚
 != 0) {

363 
	`ã°_îr
("cache free space isÇot 0");

364  -
EINVAL
;

368 
off£t
 = 
	`båfs_föd_•a˚_f‹_Æloc
(
ˇche
, 0, 4096, 0,

369 &
max_exã¡_size
);

370 i‡(
off£t
 != 0) {

371 
	`ã°_îr
("spaceállocation didÇot fail,Ñeturned offset: %llu",

372 
off£t
);

373  -
EINVAL
;

377  
	`check_num_exã¡s_™d_bôm≠s
(
ˇche
, 0, 0);

378 
	}
}

395 
	$ã°_°ól_•a˚_‰om_bôm≠_to_exã¡
(
båfs_block_group
 *
ˇche
,

396 
u32
 
£˘‹size
)

398 
ªt
;

399 
u64
 
off£t
;

400 
u64
 
max_exã¡_size
;

401 c⁄° 
båfs_‰ì_•a˚_›
 
ã°_‰ì_•a˚_›s
 = {

402 .
u£_bôm≠
 = 
ã°_u£_bôm≠
,

404 c⁄° 
båfs_‰ì_•a˚_›
 *
‹ig_‰ì_•a˚_›s
;

406 
	`ã°_msg
("running space stealing from bitmapÅoÉxtentÅests");

426 
‹ig_‰ì_•a˚_›s
 = 
ˇche
->
‰ì_•a˚_˘l
->
›
;

427 
ˇche
->
‰ì_•a˚_˘l
->
›
 = &
ã°_‰ì_•a˚_›s
;

432 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 
SZ_128M
 - 
SZ_256K
, 
SZ_128K
, 0);

433 i‡(
ªt
) {

434 
	`ã°_îr
("couldn'àaddÉxã¡É¡ry %d", 
ªt
);

435  
ªt
;

439 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 
SZ_128M
 + 
SZ_512K
,

440 
SZ_128M
 - 
SZ_512K
, 1);

441 i‡(
ªt
) {

442 
	`ã°_îr
("couldn'àadd bôm≠É¡ry %d", 
ªt
);

443  
ªt
;

446 
ªt
 = 
	`check_num_exã¡s_™d_bôm≠s
(
ˇche
, 2, 1);

447 i‡(
ªt
)

448  
ªt
;

457 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
ˇche
,

458 
SZ_128M
 + 768 * 
SZ_1K
,

459 
SZ_128M
 - 768 * 
SZ_1K
);

460 i‡(
ªt
) {

461 
	`ã°_îr
("ÁûedÅÿ‰ìÖ¨ào‡bôm≠ s∑˚ %d", 
ªt
);

462  
ªt
;

466 i‡(!
	`ã°_check_exi°s
(
ˇche
, 
SZ_128M
 - 
SZ_256K
, 
SZ_128K
)) {

467 
	`ã°_îr
("free spaceÑange missing");

468  -
ENOENT
;

470 i‡(!
	`ã°_check_exi°s
(
ˇche
, 
SZ_128M
 + 
SZ_512K
, 
SZ_256K
)) {

471 
	`ã°_îr
("free spaceÑange missing");

472  -
ENOENT
;

479 i‡(
	`ã°_check_exi°s
(
ˇche
, 
SZ_128M
 + 768 * 
SZ_1K
,

480 
SZ_128M
 - 768 * 
SZ_1K
)) {

481 
	`ã°_îr
("bitmapÑegionÇotÑemoved from space cache");

482  -
EINVAL
;

489 i‡(
	`ã°_check_exi°s
(
ˇche
, 
SZ_128M
 + 
SZ_256K
, SZ_256K)) {

490 
	`ã°_îr
("invalid bitmapÑegion markedás free");

491  -
EINVAL
;

498 i‡(
	`ã°_check_exi°s
(
ˇche
, 
SZ_128M
, 
SZ_256K
)) {

499 
	`ã°_îr
("invalid bitmapÑegion markedás free");

500  -
EINVAL
;

508 
ªt
 = 
	`båfs_add_‰ì_•a˚
(
ˇche
, 
SZ_128M
, 
SZ_512K
);

509 i‡(
ªt
) {

510 
	`ã°_îr
("îr‹áddög fªê•a˚: %d", 
ªt
);

511  
ªt
;

514 i‡(!
	`ã°_check_exi°s
(
ˇche
, 
SZ_128M
, 
SZ_512K
)) {

515 
	`ã°_îr
("bitmapÑegionÇot markedás free");

516  -
ENOENT
;

523 
ªt
 = 
	`check_num_exã¡s_™d_bôm≠s
(
ˇche
, 2, 1);

524 i‡(
ªt
)

525  
ªt
;

533 
ªt
 = 
	`båfs_add_‰ì_•a˚
(
ˇche
, 
SZ_128M
 + 
SZ_16M
, 
£˘‹size
);

534 i‡(
ªt
) {

535 
	`ã°_îr
("îr‹áddög fªê•a˚: %d", 
ªt
);

536  
ªt
;

543 
ªt
 = 
	`check_num_exã¡s_™d_bôm≠s
(
ˇche
, 2, 1);

544 i‡(
ªt
)

545  
ªt
;

552 
ªt
 = 
	`båfs_add_‰ì_•a˚
(
ˇche
, 
SZ_128M
 - 
SZ_128K
, SZ_128K);

553 i‡(
ªt
) {

554 
	`ã°_îr
("îr‹áddög fªê•a˚: %d", 
ªt
);

555  
ªt
;

558 i‡(!
	`ã°_check_exi°s
(
ˇche
, 
SZ_128M
 - 
SZ_128K
, SZ_128K)) {

559 
	`ã°_îr
("extentÑegionÇot markedás free");

560  -
ENOENT
;

567 
ªt
 = 
	`check_num_exã¡s_™d_bôm≠s
(
ˇche
, 2, 1);

568 i‡(
ªt
)

569  
ªt
;

586 i‡(!
	`ã°_check_exi°s
(
ˇche
, 
SZ_128M
 - 
SZ_256K
, 
SZ_1M
)) {

587 
	`ã°_îr
("expectedÑegionÇot markedás free");

588  -
ENOENT
;

591 i‡(
ˇche
->
‰ì_•a˚_˘l
->
‰ì_•a˚
 !(
SZ_1M
 + 
£˘‹size
)) {

592 
	`ã°_îr
("ˇchê‰ì s∑˚ i†nŸ 1Mb + %u", 
£˘‹size
);

593  -
EINVAL
;

596 
off£t
 = 
	`båfs_föd_•a˚_f‹_Æloc
(
ˇche
,

597 0, 
SZ_1M
, 0,

598 &
max_exã¡_size
);

599 i‡(
off£t
 !(
SZ_128M
 - 
SZ_256K
)) {

600 
	`ã°_îr
(

602 
off£t
);

603  -
EINVAL
;

610 
ªt
 = 
	`check_num_exã¡s_™d_bôm≠s
(
ˇche
, 1, 1);

611 i‡(
ªt
)

612  
ªt
;

614 i‡(
ˇche
->
‰ì_•a˚_˘l
->
‰ì_•a˚
 !
£˘‹size
) {

615 
	`ã°_îr
("ˇchê‰ì s∑˚ i†nŸ %u", 
£˘‹size
);

616  -
EINVAL
;

619 
off£t
 = 
	`båfs_föd_•a˚_f‹_Æloc
(
ˇche
,

620 0, 
£˘‹size
, 0,

621 &
max_exã¡_size
);

622 i‡(
off£t
 !(
SZ_128M
 + 
SZ_16M
)) {

623 
	`ã°_îr
("failedÅoállocate %u,Ñeturned offset : %llu",

624 
£˘‹size
, 
off£t
);

625  -
EINVAL
;

628 
ªt
 = 
	`check_ˇche_em±y
(
ˇche
);

629 i‡(
ªt
)

630  
ªt
;

632 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
ˇche
);

643 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 
SZ_128M
 + 
SZ_128K
, SZ_128K, 0);

644 i‡(
ªt
) {

645 
	`ã°_îr
("couldn'àaddÉxã¡É¡ry %d", 
ªt
);

646  
ªt
;

650 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 0, 
SZ_128M
 - 
SZ_512K
, 1);

651 i‡(
ªt
) {

652 
	`ã°_îr
("couldn'àadd bôm≠É¡ry %d", 
ªt
);

653  
ªt
;

656 
ªt
 = 
	`check_num_exã¡s_™d_bôm≠s
(
ˇche
, 2, 1);

657 i‡(
ªt
)

658  
ªt
;

667 
ªt
 = 
	`båfs_ªmove_‰ì_•a˚
(
ˇche
, 0, 
SZ_128M
 - 768 * 
SZ_1K
);

668 i‡(
ªt
) {

669 
	`ã°_îr
("ÁûedÅÿ‰ìÖ¨ào‡bôm≠ s∑˚ %d", 
ªt
);

670  
ªt
;

674 i‡(!
	`ã°_check_exi°s
(
ˇche
, 
SZ_128M
 + 
SZ_128K
, SZ_128K)) {

675 
	`ã°_îr
("free spaceÑange missing");

676  -
ENOENT
;

678 i‡(!
	`ã°_check_exi°s
(
ˇche
, 
SZ_128M
 - 768 * 
SZ_1K
, 
SZ_256K
)) {

679 
	`ã°_îr
("free spaceÑange missing");

680  -
ENOENT
;

687 i‡(
	`ã°_check_exi°s
(
ˇche
, 0, 
SZ_128M
 - 768 * 
SZ_1K
)) {

688 
	`ã°_îr
("bitmapÑegionÇotÑemoved from space cache");

689  -
EINVAL
;

696 i‡(
	`ã°_check_exi°s
(
ˇche
, 
SZ_128M
 - 
SZ_512K
, SZ_512K)) {

697 
	`ã°_îr
("invalid bitmapÑegion markedás free");

698  -
EINVAL
;

706 
ªt
 = 
	`båfs_add_‰ì_•a˚
(
ˇche
, 
SZ_128M
 - 
SZ_512K
, SZ_512K);

707 i‡(
ªt
) {

708 
	`ã°_îr
("îr‹áddög fªê•a˚: %d", 
ªt
);

709  
ªt
;

712 i‡(!
	`ã°_check_exi°s
(
ˇche
, 
SZ_128M
 - 
SZ_512K
, SZ_512K)) {

713 
	`ã°_îr
("bitmapÑegionÇot markedás free");

714  -
ENOENT
;

721 
ªt
 = 
	`check_num_exã¡s_™d_bôm≠s
(
ˇche
, 2, 1);

722 i‡(
ªt
)

723  
ªt
;

731 
ªt
 = 
	`båfs_add_‰ì_•a˚
(
ˇche
, 
SZ_32M
, 2 * 
£˘‹size
);

732 i‡(
ªt
) {

733 
	`ã°_îr
("îr‹áddög fªê•a˚: %d", 
ªt
);

734  
ªt
;

742 
ªt
 = 
	`båfs_add_‰ì_•a˚
(
ˇche
, 
SZ_128M
, 
SZ_128K
);

743 i‡(
ªt
) {

744 
	`ã°_îr
("îr‹áddög fªê•a˚: %d", 
ªt
);

745  
ªt
;

748 i‡(!
	`ã°_check_exi°s
(
ˇche
, 
SZ_128M
, 
SZ_128K
)) {

749 
	`ã°_îr
("extentÑegionÇot markedás free");

750  -
ENOENT
;

757 
ªt
 = 
	`check_num_exã¡s_™d_bôm≠s
(
ˇche
, 2, 1);

758 i‡(
ªt
)

759  
ªt
;

776 i‡(!
	`ã°_check_exi°s
(
ˇche
, 
SZ_128M
 - 768 * 
SZ_1K
, 
SZ_1M
)) {

777 
	`ã°_îr
("expectedÑegionÇot markedás free");

778  -
ENOENT
;

781 i‡(
ˇche
->
‰ì_•a˚_˘l
->
‰ì_•a˚
 !(
SZ_1M
 + 2 * 
£˘‹size
)) {

782 
	`ã°_îr
("ˇchê‰ì s∑˚ i†nŸ 1Mb + %u", 2 * 
£˘‹size
);

783  -
EINVAL
;

786 
off£t
 = 
	`båfs_föd_•a˚_f‹_Æloc
(
ˇche
, 0, 
SZ_1M
, 0,

787 &
max_exã¡_size
);

788 i‡(
off£t
 !(
SZ_128M
 - 768 * 
SZ_1K
)) {

789 
	`ã°_îr
(

791 
off£t
);

792  -
EINVAL
;

799 
ªt
 = 
	`check_num_exã¡s_™d_bôm≠s
(
ˇche
, 1, 1);

800 i‡(
ªt
)

801  
ªt
;

803 i‡(
ˇche
->
‰ì_•a˚_˘l
->
‰ì_•a˚
 !2 * 
£˘‹size
) {

804 
	`ã°_îr
("ˇchê‰ì s∑˚ i†nŸ %u", 2 * 
£˘‹size
);

805  -
EINVAL
;

808 
off£t
 = 
	`båfs_föd_•a˚_f‹_Æloc
(
ˇche
,

809 0, 2 * 
£˘‹size
, 0,

810 &
max_exã¡_size
);

811 i‡(
off£t
 !
SZ_32M
) {

812 
	`ã°_îr
("failedÅoállocate %u, offset: %llu",

813 2 * 
£˘‹size
, 
off£t
);

814  -
EINVAL
;

817 
ªt
 = 
	`check_ˇche_em±y
(
ˇche
);

818 i‡(
ªt
)

819  
ªt
;

821 
ˇche
->
‰ì_•a˚_˘l
->
›
 = 
‹ig_‰ì_•a˚_›s
;

822 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
ˇche
);

825 
	}
}

827 
boﬁ
 
	$byãs_ödex_u£_bôm≠
(
båfs_‰ì_•a˚_˘l
 *
˘l
,

828 
båfs_‰ì_•a˚
 *
öfo
)

830  
åue
;

831 
	}
}

833 
	$ã°_byãs_ödex
(
båfs_block_group
 *
ˇche
, 
u32
 
£˘‹size
)

835 c⁄° 
båfs_‰ì_•a˚_›
 
ã°_‰ì_•a˚_›s
 = {

836 .
u£_bôm≠
 = 
byãs_ödex_u£_bôm≠
,

838 c⁄° 
båfs_‰ì_•a˚_›
 *
‹ig_‰ì_•a˚_›s
;

839 
båfs_‰ì_•a˚_˘l
 *
˘l
 = 
ˇche
->
‰ì_•a˚_˘l
;

840 
båfs_‰ì_•a˚
 *
íåy
;

841 
rb_node
 *
node
;

842 
u64
 
off£t
, 
max_exã¡_size
, 
byãs
;

843 
ªt
, 
i
;

845 
	`ã°_msg
("running bytes indexÅests");

848 
off£t
 = 0;

849 
i
 = 0; i < 10; i++) {

850 
byãs
 = (
i
 + 1Ë* 
SZ_1M
;

851 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 
off£t
, 
byãs
, 0);

852 i‡(
ªt
) {

853 
	`ã°_îr
("couldn'àaddÉxã¡É¡ry %d\n", 
ªt
);

854  
ªt
;

856 
off£t
 +
byãs
 + 
£˘‹size
;

859 
node
 = 
	`rb_fú°_ˇched
(&
˘l
->
‰ì_•a˚_byãs
), 
i
 = 9;Çode;

860 
node
 = 
	`rb_√xt
“ode), 
i
--) {

861 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
, 
byãs_ödex
);

862 
byãs
 = (
i
 + 1Ë* 
SZ_1M
;

863 i‡(
íåy
->
byãs
 != bytes) {

864 
	`ã°_îr
("invalid bytes index order, found %lluÉxpected %llu",

865 
íåy
->
byãs
, bytes);

866  -
EINVAL
;

871 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
ˇche
);

872 
i
 = 0; i < 2; i++) {

873 
off£t
 = 
i
 * 
BITS_PER_BITMAP
 * 
£˘‹size
;

874 
byãs
 = (
i
 + 1Ë* 
SZ_1M
;

875 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 
off£t
, 
byãs
, 1);

876 i‡(
ªt
) {

877 
	`ã°_îr
("couldn'tádd bitmapÉntry");

878  
ªt
;

882 
node
 = 
	`rb_fú°_ˇched
(&
˘l
->
‰ì_•a˚_byãs
), 
i
 = 1;Çode;

883 
node
 = 
	`rb_√xt
“ode), 
i
--) {

884 
íåy
 = 
	`rb_íåy
(
node
, 
båfs_‰ì_•a˚
, 
byãs_ödex
);

885 
byãs
 = (
i
 + 1Ë* 
SZ_1M
;

886 i‡(
íåy
->
byãs
 != bytes) {

887 
	`ã°_îr
("invalid bytes index order, found %lluÉxpected %llu",

888 
íåy
->
byãs
, bytes);

889  -
EINVAL
;

894 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
ˇche
);

895 
‹ig_‰ì_•a˚_›s
 = 
ˇche
->
‰ì_•a˚_˘l
->
›
;

896 
ˇche
->
‰ì_•a˚_˘l
->
›
 = &
ã°_‰ì_•a˚_›s
;

898 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 0, 
£˘‹size
, 1);

899 i‡(
ªt
) {

900 
	`ã°_îr
("couldn'tádd bitmapÉntry");

901  
ªt
;

904 
off£t
 = 
BITS_PER_BITMAP
 * 
£˘‹size
;

905 
ªt
 = 
	`ã°_add_‰ì_•a˚_íåy
(
ˇche
, 
off£t
, 
£˘‹size
, 1);

906 i‡(
ªt
) {

907 
	`ã°_îr
("couldn'tádd bitmap_entry");

908  
ªt
;

915 
i
 = 2; i < 20; i += 2) {

916 
off£t
 = 
£˘‹size
 * 
i
;

917 
ªt
 = 
	`båfs_add_‰ì_•a˚
(
ˇche
, 
off£t
, 
£˘‹size
);

918 i‡(
ªt
) {

919 
	`ã°_îr
("îr‹Ö›uœtög s∑r£ bôm≠ %d", 
ªt
);

920  
ªt
;

928 
off£t
 = (
BITS_PER_BITMAP
 * 
£˘‹size
) + sectorsize;

929 
ªt
 = 
	`båfs_add_‰ì_•a˚
(
ˇche
, 
off£t
, 
£˘‹size
);

930 i‡(
ªt
) {

931 
	`ã°_îr
("îr‹áddög c⁄tiguou†exã¡ %d", 
ªt
);

932  
ªt
;

939 
íåy
 = 
	`rb_íåy
(
	`rb_fú°_ˇched
(&
˘l
->
‰ì_•a˚_byãs
),

940 
båfs_‰ì_•a˚
, 
byãs_ödex
);

941 i‡(
íåy
->
byãs
 !(10 * 
£˘‹size
)) {

942 
	`ã°_îr
("error, wrongÉntry inÅhe first slot in bytes_index");

943  -
EINVAL
;

946 
max_exã¡_size
 = 0;

947 
off£t
 = 
	`båfs_föd_•a˚_f‹_Æloc
(
ˇche
, cache->
°¨t
, 
£˘‹size
 * 3,

948 0, &
max_exã¡_size
);

949 i‡(
off£t
 != 0) {

950 
	`ã°_îr
("found spaceÅoállocÉvenÅhough we don't haveÉnough space");

951  -
EINVAL
;

954 i‡(
max_exã¡_size
 !(2 * 
£˘‹size
)) {

955 
	`ã°_îr
("gotÅhe wrong max_extent size %lluÉxpected %llu",

956 
max_exã¡_size
, ()(2 * 
£˘‹size
));

957  -
EINVAL
;

964 
íåy
 = 
	`rb_íåy
(
	`rb_fú°_ˇched
(&
˘l
->
‰ì_•a˚_byãs
),

965 
båfs_‰ì_•a˚
, 
byãs_ödex
);

966 i‡(
íåy
->
byãs
 !(2 * 
£˘‹size
)) {

967 
	`ã°_îr
("error,Åhe bytes index wasn'tÑecalculatedÖroperly");

968  -
EINVAL
;

972 
off£t
 = (
BITS_PER_BITMAP
 * 
£˘‹size
) - sectorsize;

973 
ªt
 = 
	`båfs_add_‰ì_•a˚
(
ˇche
, 
off£t
, 
£˘‹size
);

974 i‡(
ªt
) {

975 
	`ã°_îr
("îr‹áddögÉxã¡Åÿthê•¨£É¡ry %d", 
ªt
);

976  
ªt
;

979 
íåy
 = 
	`rb_íåy
(
	`rb_fú°_ˇched
(&
˘l
->
‰ì_•a˚_byãs
),

980 
båfs_‰ì_•a˚
, 
byãs_ödex
);

981 i‡(
íåy
->
byãs
 !(11 * 
£˘‹size
)) {

982 
	`ã°_îr
("error, wrongÉntry inÅhe first slot in bytes_index");

983  -
EINVAL
;

990 
max_exã¡_size
 = 0;

991 
off£t
 = 
	`båfs_föd_•a˚_f‹_Æloc
(
ˇche
, cache->
°¨t
, 
£˘‹size
 * 2,

992 0, &
max_exã¡_size
);

993 i‡(
off£t
 !(
BITS_PER_BITMAP
 * 
£˘‹size
)) {

994 
	`ã°_îr
("error, found %llu instead of %llu for ourálloc",

995 
off£t
,

996 ()(
BITS_PER_BITMAP
 * 
£˘‹size
));

997  -
EINVAL
;

1000 
ˇche
->
‰ì_•a˚_˘l
->
›
 = 
‹ig_‰ì_•a˚_›s
;

1001 
	`båfs_ªmove_‰ì_•a˚_ˇche
(
ˇche
);

1003 
	}
}

1005 
	$båfs_ã°_‰ì_•a˚_ˇche
(
u32
 
£˘‹size
, u32 
nodesize
)

1007 
båfs_fs_öfo
 *
fs_öfo
;

1008 
båfs_block_group
 *
ˇche
;

1009 
båfs_roŸ
 *
roŸ
 = 
NULL
;

1010 
ªt
 = -
ENOMEM
;

1012 
	`ã°_msg
("running btrfs free space cacheÅests");

1013 
fs_öfo
 = 
	`båfs_Æloc_dummy_fs_öfo
(
nodesize
, 
£˘‹size
);

1014 i‡(!
fs_öfo
) {

1015 
	`ã°_°d_îr
(
TEST_ALLOC_FS_INFO
);

1016  -
ENOMEM
;

1024 
ˇche
 = 
	`båfs_Æloc_dummy_block_group
(
fs_öfo
,

1025 
BITS_PER_BITMAP
 * 
£˘‹size
 + 
PAGE_SIZE
);

1026 i‡(!
ˇche
) {

1027 
	`ã°_°d_îr
(
TEST_ALLOC_BLOCK_GROUP
);

1028 
	`båfs_‰ì_dummy_fs_öfo
(
fs_öfo
);

1032 
roŸ
 = 
	`båfs_Æloc_dummy_roŸ
(
fs_öfo
);

1033 i‡(
	`IS_ERR
(
roŸ
)) {

1034 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

1035 
ªt
 = 
	`PTR_ERR
(
roŸ
);

1036 
out
;

1039 
roŸ
->
roŸ_key
.
obje˘id
 = 
BTRFS_EXTENT_TREE_OBJECTID
;

1040 
roŸ
->
roŸ_key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

1041 
roŸ
->
roŸ_key
.
off£t
 = 0;

1042 
	`båfs_globÆ_roŸ_ö£π
(
roŸ
);

1044 
ªt
 = 
	`ã°_exã¡s
(
ˇche
);

1045 i‡(
ªt
)

1046 
out
;

1047 
ªt
 = 
	`ã°_bôm≠s
(
ˇche
, 
£˘‹size
);

1048 i‡(
ªt
)

1049 
out
;

1050 
ªt
 = 
	`ã°_bôm≠s_™d_exã¡s
(
ˇche
, 
£˘‹size
);

1051 i‡(
ªt
)

1052 
out
;

1054 
ªt
 = 
	`ã°_°ól_•a˚_‰om_bôm≠_to_exã¡
(
ˇche
, 
£˘‹size
);

1055 i‡(
ªt
)

1056 
out
;

1057 
ªt
 = 
	`ã°_byãs_ödex
(
ˇche
, 
£˘‹size
);

1058 
out
:

1059 
	`båfs_‰ì_dummy_block_group
(
ˇche
);

1060 
	`båfs_‰ì_dummy_roŸ
(
roŸ
);

1061 
	`båfs_‰ì_dummy_fs_öfo
(
fs_öfo
);

1062  
ªt
;

1063 
	}
}

	@tests/free-space-tree-tests.c

6 
	~<löux/ty≥s.h
>

7 
	~"båfs-ã°s.h
"

8 
	~"../˘ªe.h
"

9 
	~"../disk-io.h
"

10 
	~"../‰ì-•a˚-åì.h
"

11 
	~"../å™ß˘i⁄.h
"

12 
	~"../block-group.h
"

13 
	~"../ac˚ss‹s.h
"

15 
	s‰ì_•a˚_exã¡
 {

16 
u64
 
	m°¨t
;

17 
u64
 
	mÀngth
;

20 
	$__check_‰ì_•a˚_exã¡s
(
båfs_å™s_h™dÀ
 *
å™s
,

21 
båfs_fs_öfo
 *
fs_öfo
,

22 
båfs_block_group
 *
ˇche
,

23 
båfs_∑th
 *
∑th
,

24 c⁄° 
‰ì_•a˚_exã¡
 * c⁄° 
exã¡s
,

25 
num_exã¡s
)

27 
båfs_‰ì_•a˚_öfo
 *
öfo
;

28 
båfs_key
 
key
;

29 
¥ev_bô
 = 0, 
bô
;

30 
u64
 
exã¡_°¨t
 = 0, 
off£t
, 
íd
;

31 
u32
 
Êags
, 
exã¡_cou¡
;

32 
i
;

33 
ªt
;

35 
öfo
 = 
	`£¨ch_‰ì_•a˚_öfo
(
å™s
, 
ˇche
, 
∑th
, 0);

36 i‡(
	`IS_ERR
(
öfo
)) {

37 
	`ã°_îr
("couldÇot find free space info");

38 
ªt
 = 
	`PTR_ERR
(
öfo
);

39 
out
;

41 
Êags
 = 
	`båfs_‰ì_•a˚_Êags
(
∑th
->
nodes
[0], 
öfo
);

42 
exã¡_cou¡
 = 
	`båfs_‰ì_•a˚_exã¡_cou¡
(
∑th
->
nodes
[0], 
öfo
);

44 i‡(
exã¡_cou¡
 !
num_exã¡s
) {

45 
	`ã°_îr
("extent count is wrong");

46 
ªt
 = -
EINVAL
;

47 
out
;

49 i‡(
Êags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) {

50 i‡(
∑th
->
¶Ÿs
[0] != 0)

51 
övÆid
;

52 
íd
 = 
ˇche
->
°¨t
 + cache->
Àngth
;

53 
i
 = 0;

54 ++
∑th
->
¶Ÿs
[0] < 
	`båfs_hódî_ƒôems
’©h->
nodes
[0])) {

55 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

56 i‡(
key
.
ty≥
 !
BTRFS_FREE_SPACE_BITMAP_KEY
)

57 
övÆid
;

58 
off£t
 = 
key
.
obje˘id
;

59 
off£t
 < 
key
.
obje˘id
 + key.offset) {

60 
bô
 = 
	`‰ì_•a˚_ã°_bô
(
ˇche
, 
∑th
, 
off£t
);

61 i‡(
¥ev_bô
 =0 && 
bô
 == 1) {

62 
exã¡_°¨t
 = 
off£t
;

63 } i‡(
¥ev_bô
 =1 && 
bô
 == 0) {

64 i‡(
i
 >
num_exã¡s
 ||

65 
exã¡_°¨t
 !
exã¡s
[
i
].
°¨t
 ||

66 
off£t
 - 
exã¡_°¨t
 !
exã¡s
[
i
].
Àngth
)

67 
övÆid
;

68 
i
++;

70 
¥ev_bô
 = 
bô
;

71 
off£t
 +
fs_öfo
->
£˘‹size
;

74 i‡(
¥ev_bô
 == 1) {

75 i‡(
i
 >
num_exã¡s
 ||

76 
exã¡_°¨t
 !
exã¡s
[
i
].
°¨t
 ||

77 
íd
 - 
exã¡_°¨t
 !
exã¡s
[
i
].
Àngth
)

78 
övÆid
;

79 
i
++;

81 i‡(
i
 !
num_exã¡s
)

82 
övÆid
;

84 i‡(
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0]Ë!
num_exã¡s
 + 1 ||

85 
∑th
->
¶Ÿs
[0] != 0)

86 
övÆid
;

87 
i
 = 0; i < 
num_exã¡s
; i++) {

88 
∑th
->
¶Ÿs
[0]++;

89 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

90 i‡(
key
.
ty≥
 !
BTRFS_FREE_SPACE_EXTENT_KEY
 ||

91 
key
.
obje˘id
 !
exã¡s
[
i
].
°¨t
 ||

92 
key
.
off£t
 !
exã¡s
[
i
].
Àngth
)

93 
övÆid
;

97 
ªt
 = 0;

98 
out
:

99 
	`båfs_ªÀa£_∑th
(
∑th
);

100  
ªt
;

101 
övÆid
:

102 
	`ã°_îr
("free spaceÅree is invalid");

103 
ªt
 = -
EINVAL
;

104 
out
;

105 
	}
}

107 
	$check_‰ì_•a˚_exã¡s
(
båfs_å™s_h™dÀ
 *
å™s
,

108 
båfs_fs_öfo
 *
fs_öfo
,

109 
båfs_block_group
 *
ˇche
,

110 
båfs_∑th
 *
∑th
,

111 c⁄° 
‰ì_•a˚_exã¡
 * c⁄° 
exã¡s
,

112 
num_exã¡s
)

114 
båfs_‰ì_•a˚_öfo
 *
öfo
;

115 
u32
 
Êags
;

116 
ªt
;

118 
öfo
 = 
	`£¨ch_‰ì_•a˚_öfo
(
å™s
, 
ˇche
, 
∑th
, 0);

119 i‡(
	`IS_ERR
(
öfo
)) {

120 
	`ã°_îr
("couldÇot find free space info");

121 
	`båfs_ªÀa£_∑th
(
∑th
);

122  
	`PTR_ERR
(
öfo
);

124 
Êags
 = 
	`båfs_‰ì_•a˚_Êags
(
∑th
->
nodes
[0], 
öfo
);

125 
	`båfs_ªÀa£_∑th
(
∑th
);

127 
ªt
 = 
	`__check_‰ì_•a˚_exã¡s
(
å™s
, 
fs_öfo
, 
ˇche
, 
∑th
, 
exã¡s
,

128 
num_exã¡s
);

129 i‡(
ªt
)

130  
ªt
;

133 i‡(
Êags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) {

134 
ªt
 = 
	`c⁄vît_‰ì_•a˚_to_exã¡s
(
å™s
, 
ˇche
, 
∑th
);

135 i‡(
ªt
) {

136 
	`ã°_îr
("couldÇot convertÅoÉxtents");

137  
ªt
;

140 
ªt
 = 
	`c⁄vît_‰ì_•a˚_to_bôm≠s
(
å™s
, 
ˇche
, 
∑th
);

141 i‡(
ªt
) {

142 
	`ã°_îr
("couldÇot convertÅo bitmaps");

143  
ªt
;

146  
	`__check_‰ì_•a˚_exã¡s
(
å™s
, 
fs_öfo
, 
ˇche
, 
∑th
, 
exã¡s
,

147 
num_exã¡s
);

148 
	}
}

150 
	$ã°_em±y_block_group
(
båfs_å™s_h™dÀ
 *
å™s
,

151 
båfs_fs_öfo
 *
fs_öfo
,

152 
båfs_block_group
 *
ˇche
,

153 
båfs_∑th
 *
∑th
,

154 
u32
 
Æignmít
)

156 c⁄° 
‰ì_•a˚_exã¡
 
exã¡s
[] = {

157 {
ˇche
->
°¨t
, cache->
Àngth
},

160  
	`check_‰ì_•a˚_exã¡s
(
å™s
, 
fs_öfo
, 
ˇche
, 
∑th
,

161 
exã¡s
, 
	`ARRAY_SIZE
(extents));

162 
	}
}

164 
	$ã°_ªmove_Æl
(
båfs_å™s_h™dÀ
 *
å™s
,

165 
båfs_fs_öfo
 *
fs_öfo
,

166 
båfs_block_group
 *
ˇche
,

167 
båfs_∑th
 *
∑th
,

168 
u32
 
Æignmít
)

170 c⁄° 
‰ì_•a˚_exã¡
 
exã¡s
[] = {};

171 
ªt
;

173 
ªt
 = 
	`__ªmove_‰om_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
,

174 
ˇche
->
°¨t
,

175 
ˇche
->
Àngth
);

176 i‡(
ªt
) {

177 
	`ã°_îr
("couldÇotÑemove free space");

178  
ªt
;

181  
	`check_‰ì_•a˚_exã¡s
(
å™s
, 
fs_öfo
, 
ˇche
, 
∑th
,

182 
exã¡s
, 
	`ARRAY_SIZE
(extents));

183 
	}
}

185 
	$ã°_ªmove_begönög
(
båfs_å™s_h™dÀ
 *
å™s
,

186 
båfs_fs_öfo
 *
fs_öfo
,

187 
båfs_block_group
 *
ˇche
,

188 
båfs_∑th
 *
∑th
,

189 
u32
 
Æignmít
)

191 c⁄° 
‰ì_•a˚_exã¡
 
exã¡s
[] = {

192 {
ˇche
->
°¨t
 + 
Æignmít
, cache->
Àngth
 -álignment},

194 
ªt
;

196 
ªt
 = 
	`__ªmove_‰om_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
,

197 
ˇche
->
°¨t
, 
Æignmít
);

198 i‡(
ªt
) {

199 
	`ã°_îr
("couldÇotÑemove free space");

200  
ªt
;

203  
	`check_‰ì_•a˚_exã¡s
(
å™s
, 
fs_öfo
, 
ˇche
, 
∑th
,

204 
exã¡s
, 
	`ARRAY_SIZE
(extents));

206 
	}
}

208 
	$ã°_ªmove_íd
(
båfs_å™s_h™dÀ
 *
å™s
,

209 
båfs_fs_öfo
 *
fs_öfo
,

210 
båfs_block_group
 *
ˇche
,

211 
båfs_∑th
 *
∑th
,

212 
u32
 
Æignmít
)

214 c⁄° 
‰ì_•a˚_exã¡
 
exã¡s
[] = {

215 {
ˇche
->
°¨t
, cache->
Àngth
 - 
Æignmít
},

217 
ªt
;

219 
ªt
 = 
	`__ªmove_‰om_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
,

220 
ˇche
->
°¨t
 + cache->
Àngth
 - 
Æignmít
,

221 
Æignmít
);

222 i‡(
ªt
) {

223 
	`ã°_îr
("couldÇotÑemove free space");

224  
ªt
;

227  
	`check_‰ì_•a˚_exã¡s
(
å™s
, 
fs_öfo
, 
ˇche
, 
∑th
,

228 
exã¡s
, 
	`ARRAY_SIZE
(extents));

229 
	}
}

231 
	$ã°_ªmove_middÀ
(
båfs_å™s_h™dÀ
 *
å™s
,

232 
båfs_fs_öfo
 *
fs_öfo
,

233 
båfs_block_group
 *
ˇche
,

234 
båfs_∑th
 *
∑th
,

235 
u32
 
Æignmít
)

237 c⁄° 
‰ì_•a˚_exã¡
 
exã¡s
[] = {

238 {
ˇche
->
°¨t
, 
Æignmít
},

239 {
ˇche
->
°¨t
 + 2 * 
Æignmít
, cache->
Àngth
 - 2 *álignment},

241 
ªt
;

243 
ªt
 = 
	`__ªmove_‰om_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
,

244 
ˇche
->
°¨t
 + 
Æignmít
,

245 
Æignmít
);

246 i‡(
ªt
) {

247 
	`ã°_îr
("couldÇotÑemove free space");

248  
ªt
;

251  
	`check_‰ì_•a˚_exã¡s
(
å™s
, 
fs_öfo
, 
ˇche
, 
∑th
,

252 
exã¡s
, 
	`ARRAY_SIZE
(extents));

253 
	}
}

255 
	$ã°_mîge_À·
(
båfs_å™s_h™dÀ
 *
å™s
,

256 
båfs_fs_öfo
 *
fs_öfo
,

257 
båfs_block_group
 *
ˇche
,

258 
båfs_∑th
 *
∑th
,

259 
u32
 
Æignmít
)

261 c⁄° 
‰ì_•a˚_exã¡
 
exã¡s
[] = {

262 {
ˇche
->
°¨t
, 2 * 
Æignmít
},

264 
ªt
;

266 
ªt
 = 
	`__ªmove_‰om_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
,

267 
ˇche
->
°¨t
, cache->
Àngth
);

268 i‡(
ªt
) {

269 
	`ã°_îr
("couldÇotÑemove free space");

270  
ªt
;

273 
ªt
 = 
	`__add_to_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
, cache->
°¨t
,

274 
Æignmít
);

275 i‡(
ªt
) {

276 
	`ã°_îr
("couldÇotádd free space");

277  
ªt
;

280 
ªt
 = 
	`__add_to_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
,

281 
ˇche
->
°¨t
 + 
Æignmít
,

282 
Æignmít
);

283 i‡(
ªt
) {

284 
	`ã°_îr
("couldÇotádd free space");

285  
ªt
;

288  
	`check_‰ì_•a˚_exã¡s
(
å™s
, 
fs_öfo
, 
ˇche
, 
∑th
,

289 
exã¡s
, 
	`ARRAY_SIZE
(extents));

290 
	}
}

292 
	$ã°_mîge_right
(
båfs_å™s_h™dÀ
 *
å™s
,

293 
båfs_fs_öfo
 *
fs_öfo
,

294 
båfs_block_group
 *
ˇche
,

295 
båfs_∑th
 *
∑th
,

296 
u32
 
Æignmít
)

298 c⁄° 
‰ì_•a˚_exã¡
 
exã¡s
[] = {

299 {
ˇche
->
°¨t
 + 
Æignmít
, 2 *álignment},

301 
ªt
;

303 
ªt
 = 
	`__ªmove_‰om_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
,

304 
ˇche
->
°¨t
, cache->
Àngth
);

305 i‡(
ªt
) {

306 
	`ã°_îr
("couldÇotÑemove free space");

307  
ªt
;

310 
ªt
 = 
	`__add_to_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
,

311 
ˇche
->
°¨t
 + 2 * 
Æignmít
,

312 
Æignmít
);

313 i‡(
ªt
) {

314 
	`ã°_îr
("couldÇotádd free space");

315  
ªt
;

318 
ªt
 = 
	`__add_to_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
,

319 
ˇche
->
°¨t
 + 
Æignmít
,

320 
Æignmít
);

321 i‡(
ªt
) {

322 
	`ã°_îr
("couldÇotádd free space");

323  
ªt
;

326  
	`check_‰ì_•a˚_exã¡s
(
å™s
, 
fs_öfo
, 
ˇche
, 
∑th
,

327 
exã¡s
, 
	`ARRAY_SIZE
(extents));

328 
	}
}

330 
	$ã°_mîge_bŸh
(
båfs_å™s_h™dÀ
 *
å™s
,

331 
båfs_fs_öfo
 *
fs_öfo
,

332 
båfs_block_group
 *
ˇche
,

333 
båfs_∑th
 *
∑th
,

334 
u32
 
Æignmít
)

336 c⁄° 
‰ì_•a˚_exã¡
 
exã¡s
[] = {

337 {
ˇche
->
°¨t
, 3 * 
Æignmít
},

339 
ªt
;

341 
ªt
 = 
	`__ªmove_‰om_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
,

342 
ˇche
->
°¨t
, cache->
Àngth
);

343 i‡(
ªt
) {

344 
	`ã°_îr
("couldÇotÑemove free space");

345  
ªt
;

348 
ªt
 = 
	`__add_to_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
, cache->
°¨t
,

349 
Æignmít
);

350 i‡(
ªt
) {

351 
	`ã°_îr
("couldÇotádd free space");

352  
ªt
;

355 
ªt
 = 
	`__add_to_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
,

356 
ˇche
->
°¨t
 + 2 * 
Æignmít
,álignment);

357 i‡(
ªt
) {

358 
	`ã°_îr
("couldÇotádd free space");

359  
ªt
;

362 
ªt
 = 
	`__add_to_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
,

363 
ˇche
->
°¨t
 + 
Æignmít
,álignment);

364 i‡(
ªt
) {

365 
	`ã°_îr
("couldÇotádd free space");

366  
ªt
;

369  
	`check_‰ì_•a˚_exã¡s
(
å™s
, 
fs_öfo
, 
ˇche
, 
∑th
,

370 
exã¡s
, 
	`ARRAY_SIZE
(extents));

371 
	}
}

373 
	$ã°_mîge_n⁄e
(
båfs_å™s_h™dÀ
 *
å™s
,

374 
båfs_fs_öfo
 *
fs_öfo
,

375 
båfs_block_group
 *
ˇche
,

376 
båfs_∑th
 *
∑th
,

377 
u32
 
Æignmít
)

379 c⁄° 
‰ì_•a˚_exã¡
 
exã¡s
[] = {

380 {
ˇche
->
°¨t
, 
Æignmít
},

381 {
ˇche
->
°¨t
 + 2 * 
Æignmít
,álignment},

382 {
ˇche
->
°¨t
 + 4 * 
Æignmít
,álignment},

384 
ªt
;

386 
ªt
 = 
	`__ªmove_‰om_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
,

387 
ˇche
->
°¨t
, cache->
Àngth
);

388 i‡(
ªt
) {

389 
	`ã°_îr
("couldÇotÑemove free space");

390  
ªt
;

393 
ªt
 = 
	`__add_to_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
, cache->
°¨t
,

394 
Æignmít
);

395 i‡(
ªt
) {

396 
	`ã°_îr
("couldÇotádd free space");

397  
ªt
;

400 
ªt
 = 
	`__add_to_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
,

401 
ˇche
->
°¨t
 + 4 * 
Æignmít
,álignment);

402 i‡(
ªt
) {

403 
	`ã°_îr
("couldÇotádd free space");

404  
ªt
;

407 
ªt
 = 
	`__add_to_‰ì_•a˚_åì
(
å™s
, 
ˇche
, 
∑th
,

408 
ˇche
->
°¨t
 + 2 * 
Æignmít
,álignment);

409 i‡(
ªt
) {

410 
	`ã°_îr
("couldÇotádd free space");

411  
ªt
;

414  
	`check_‰ì_•a˚_exã¡s
(
å™s
, 
fs_öfo
, 
ˇche
, 
∑th
,

415 
exã¡s
, 
	`ARRAY_SIZE
(extents));

416 
	}
}

418 (*
	tã°_func_t
)(
	tbåfs_å™s_h™dÀ
 *,

419 
	tbåfs_fs_öfo
 *,

420 
	tbåfs_block_group
 *,

421 
	tbåfs_∑th
 *,

422 
	tu32
 
	tÆignmít
);

424 
	$run_ã°
(
ã°_func_t
 
ã°_func
, 
bôm≠s
, 
u32
 
£˘‹size
,

425 
u32
 
nodesize
, u32 
Æignmít
)

427 
båfs_fs_öfo
 *
fs_öfo
;

428 
båfs_roŸ
 *
roŸ
 = 
NULL
;

429 
båfs_block_group
 *
ˇche
 = 
NULL
;

430 
båfs_å™s_h™dÀ
 
å™s
;

431 
båfs_∑th
 *
∑th
 = 
NULL
;

432 
ªt
;

434 
fs_öfo
 = 
	`båfs_Æloc_dummy_fs_öfo
(
nodesize
, 
£˘‹size
);

435 i‡(!
fs_öfo
) {

436 
	`ã°_°d_îr
(
TEST_ALLOC_FS_INFO
);

437 
ªt
 = -
ENOMEM
;

438 
out
;

441 
roŸ
 = 
	`båfs_Æloc_dummy_roŸ
(
fs_öfo
);

442 i‡(
	`IS_ERR
(
roŸ
)) {

443 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

444 
ªt
 = 
	`PTR_ERR
(
roŸ
);

445 
out
;

448 
	`båfs_£t_su≥r_com∑t_ro_Êags
(
roŸ
->
fs_öfo
->
su≥r_c›y
,

449 
BTRFS_FEATURE_COMPAT_RO_FREE_SPACE_TREE
);

450 
roŸ
->
roŸ_key
.
obje˘id
 = 
BTRFS_FREE_SPACE_TREE_OBJECTID
;

451 
roŸ
->
roŸ_key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

452 
roŸ
->
roŸ_key
.
off£t
 = 0;

453 
	`båfs_globÆ_roŸ_ö£π
(
roŸ
);

454 
roŸ
->
fs_öfo
->
åì_roŸ
 =Ñoot;

456 
roŸ
->
node
 = 
	`Æloc_ã°_exã¡_buf„r
‘oŸ->
fs_öfo
, 
nodesize
);

457 i‡(
	`IS_ERR
(
roŸ
->
node
)) {

458 
	`ã°_°d_îr
(
TEST_ALLOC_EXTENT_BUFFER
);

459 
ªt
 = 
	`PTR_ERR
(
roŸ
->
node
);

460 
out
;

462 
	`båfs_£t_hódî_Àvñ
(
roŸ
->
node
, 0);

463 
	`båfs_£t_hódî_ƒôems
(
roŸ
->
node
, 0);

464 
roŸ
->
Æloc_byãƒ
 +2 * 
nodesize
;

466 
ˇche
 = 
	`båfs_Æloc_dummy_block_group
(
fs_öfo
, 8 * 
Æignmít
);

467 i‡(!
ˇche
) {

468 
	`ã°_°d_îr
(
TEST_ALLOC_BLOCK_GROUP
);

469 
ªt
 = -
ENOMEM
;

470 
out
;

472 
ˇche
->
bôm≠_low_thªsh
 = 0;

473 
ˇche
->
bôm≠_high_thªsh
 = (
u32
)-1;

474 
	`£t_bô
(
BLOCK_GROUP_FLAG_NEEDS_FREE_SPACE
, &
ˇche
->
ru¡ime_Êags
);

475 
ˇche
->
fs_öfo
 = 
roŸ
->fs_info;

477 
	`båfs_öô_dummy_å™s
(&
å™s
, 
roŸ
->
fs_öfo
);

479 
∑th
 = 
	`båfs_Æloc_∑th
();

480 i‡(!
∑th
) {

481 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

482 
ªt
 = -
ENOMEM
;

483 
out
;

486 
ªt
 = 
	`add_block_group_‰ì_•a˚
(&
å™s
, 
ˇche
);

487 i‡(
ªt
) {

488 
	`ã°_îr
("couldÇotádd block group free space");

489 
out
;

492 i‡(
bôm≠s
) {

493 
ªt
 = 
	`c⁄vît_‰ì_•a˚_to_bôm≠s
(&
å™s
, 
ˇche
, 
∑th
);

494 i‡(
ªt
) {

495 
	`ã°_îr
("couldÇot convert block groupÅo bitmaps");

496 
out
;

500 
ªt
 = 
	`ã°_func
(&
å™s
, 
roŸ
->
fs_öfo
, 
ˇche
, 
∑th
, 
Æignmít
);

501 i‡(
ªt
)

502 
out
;

504 
ªt
 = 
	`ªmove_block_group_‰ì_•a˚
(&
å™s
, 
ˇche
);

505 i‡(
ªt
) {

506 
	`ã°_îr
("couldÇotÑemove block group free space");

507 
out
;

510 i‡(
	`båfs_hódî_ƒôems
(
roŸ
->
node
) != 0) {

511 
	`ã°_îr
("free spaceÅree hasÜeftover items");

512 
ªt
 = -
EINVAL
;

513 
out
;

516 
ªt
 = 0;

517 
out
:

518 
	`båfs_‰ì_∑th
(
∑th
);

519 
	`båfs_‰ì_dummy_block_group
(
ˇche
);

520 
	`båfs_‰ì_dummy_roŸ
(
roŸ
);

521 
	`båfs_‰ì_dummy_fs_öfo
(
fs_öfo
);

522  
ªt
;

523 
	}
}

525 
	$run_ã°_bŸh_f‹m©s
(
ã°_func_t
 
ã°_func
, 
u32
 
£˘‹size
,

526 
u32
 
nodesize
, u32 
Æignmít
)

528 
ã°_ªt
 = 0;

529 
ªt
;

531 
ªt
 = 
	`run_ã°
(
ã°_func
, 0, 
£˘‹size
, 
nodesize
, 
Æignmít
);

532 i‡(
ªt
) {

533 
	`ã°_îr
(

535 
ã°_func
, 
£˘‹size
, 
nodesize
, 
Æignmít
);

536 
ã°_ªt
 = 
ªt
;

539 
ªt
 = 
	`run_ã°
(
ã°_func
, 1, 
£˘‹size
, 
nodesize
, 
Æignmít
);

540 i‡(
ªt
) {

541 
	`ã°_îr
(

543 
ã°_func
, 
£˘‹size
, 
nodesize
, 
Æignmít
);

544 
ã°_ªt
 = 
ªt
;

547  
ã°_ªt
;

548 
	}
}

550 
	$båfs_ã°_‰ì_•a˚_åì
(
u32
 
£˘‹size
, u32 
nodesize
)

552 
ã°_func_t
 
ã°s
[] = {

553 
ã°_em±y_block_group
,

554 
ã°_ªmove_Æl
,

555 
ã°_ªmove_begönög
,

556 
ã°_ªmove_íd
,

557 
ã°_ªmove_middÀ
,

558 
ã°_mîge_À·
,

559 
ã°_mîge_right
,

560 
ã°_mîge_bŸh
,

561 
ã°_mîge_n⁄e
,

563 
u32
 
bôm≠_Æignmít
;

564 
ã°_ªt
 = 0;

565 
i
;

571 
bôm≠_Æignmít
 = 
BTRFS_FREE_SPACE_BITMAP_BITS
 * 
PAGE_SIZE
;

573 
	`ã°_msg
("running free spaceÅreeÅests");

574 
i
 = 0; i < 
	`ARRAY_SIZE
(
ã°s
); i++) {

575 
ªt
;

577 
ªt
 = 
	`run_ã°_bŸh_f‹m©s
(
ã°s
[
i
], 
£˘‹size
, 
nodesize
,

578 
£˘‹size
);

579 i‡(
ªt
)

580 
ã°_ªt
 = 
ªt
;

582 
ªt
 = 
	`run_ã°_bŸh_f‹m©s
(
ã°s
[
i
], 
£˘‹size
, 
nodesize
,

583 
bôm≠_Æignmít
);

584 i‡(
ªt
)

585 
ã°_ªt
 = 
ªt
;

588  
ã°_ªt
;

589 
	}
}

	@tests/inode-tests.c

6 
	~<löux/ty≥s.h
>

7 
	~"båfs-ã°s.h
"

8 
	~"../˘ªe.h
"

9 
	~"../båfs_öode.h
"

10 
	~"../disk-io.h
"

11 
	~"../exã¡_io.h
"

12 
	~"../vﬁumes.h
"

13 
	~"../com¥essi⁄.h
"

14 
	~"../ac˚ss‹s.h
"

16 
	$ö£π_exã¡
(
båfs_roŸ
 *
roŸ
, 
u64
 
°¨t
, u64 
Àn
,

17 
u64
 
øm_byãs
, u64 
off£t
, u64 
disk_byãƒ
,

18 
u64
 
disk_Àn
, 
u32
 
ty≥
, 
u8
 
com¥essi⁄
, 
¶Ÿ
)

20 
båfs_∑th
 
∑th
;

21 
båfs_fûe_exã¡_ôem
 *
fi
;

22 
exã¡_buf„r
 *
Àaf
 = 
roŸ
->
node
;

23 
båfs_key
 
key
;

24 
u32
 
vÆue_Àn
 = (
båfs_fûe_exã¡_ôem
);

26 i‡(
ty≥
 =
BTRFS_FILE_EXTENT_INLINE
)

27 
vÆue_Àn
 +
Àn
;

28 
	`mem£t
(&
∑th
, 0, (path));

30 
∑th
.
nodes
[0] = 
Àaf
;

31 
∑th
.
¶Ÿs
[0] = 
¶Ÿ
;

33 
key
.
obje˘id
 = 
BTRFS_FIRST_FREE_OBJECTID
;

34 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

35 
key
.
off£t
 = 
°¨t
;

41 
	`båfs_£tup_ôem_f‹_ö£π
(
NULL
, 
roŸ
, &
∑th
, &
key
, 
vÆue_Àn
);

42 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_fûe_exã¡_ôem
);

43 
	`båfs_£t_fûe_exã¡_gíî©i⁄
(
Àaf
, 
fi
, 1);

44 
	`båfs_£t_fûe_exã¡_ty≥
(
Àaf
, 
fi
, 
ty≥
);

45 
	`båfs_£t_fûe_exã¡_disk_byãƒ
(
Àaf
, 
fi
, 
disk_byãƒ
);

46 
	`båfs_£t_fûe_exã¡_disk_num_byãs
(
Àaf
, 
fi
, 
disk_Àn
);

47 
	`båfs_£t_fûe_exã¡_off£t
(
Àaf
, 
fi
, 
off£t
);

48 
	`båfs_£t_fûe_exã¡_num_byãs
(
Àaf
, 
fi
, 
Àn
);

49 
	`båfs_£t_fûe_exã¡_øm_byãs
(
Àaf
, 
fi
, 
øm_byãs
);

50 
	`båfs_£t_fûe_exã¡_com¥essi⁄
(
Àaf
, 
fi
, 
com¥essi⁄
);

51 
	`båfs_£t_fûe_exã¡_í¸y±i⁄
(
Àaf
, 
fi
, 0);

52 
	`båfs_£t_fûe_exã¡_Ÿhî_ícodög
(
Àaf
, 
fi
, 0);

53 
	}
}

55 
	$ö£π_öode_ôem_key
(
båfs_roŸ
 *
roŸ
)

57 
båfs_∑th
 
∑th
;

58 
exã¡_buf„r
 *
Àaf
 = 
roŸ
->
node
;

59 
båfs_key
 
key
;

60 
u32
 
vÆue_Àn
 = 0;

62 
	`mem£t
(&
∑th
, 0, (path));

64 
∑th
.
nodes
[0] = 
Àaf
;

65 
∑th
.
¶Ÿs
[0] = 0;

67 
key
.
obje˘id
 = 
BTRFS_INODE_ITEM_KEY
;

68 
key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

69 
key
.
off£t
 = 0;

75 
	`båfs_£tup_ôem_f‹_ö£π
(
NULL
, 
roŸ
, &
∑th
, &
key
, 
vÆue_Àn
);

76 
	}
}

96 
	$£tup_fûe_exã¡s
(
båfs_roŸ
 *
roŸ
, 
u32
 
£˘‹size
)

98 
¶Ÿ
 = 0;

99 
u64
 
disk_byãƒ
 = 
SZ_1M
;

100 
u64
 
off£t
 = 0;

107 
	`ö£π_exã¡
(
roŸ
, 
off£t
, 6, 6, 0, 0, 0, 
BTRFS_FILE_EXTENT_INLINE
, 0,

108 
¶Ÿ
);

109 
¶Ÿ
++;

110 
off£t
 = 
£˘‹size
;

113 
	`ö£π_exã¡
(
roŸ
, 
off£t
, 4, 4, 0, 0, 0, 
BTRFS_FILE_EXTENT_REG
, 0,

114 
¶Ÿ
);

115 
¶Ÿ
++;

116 
off£t
 += 4;

119 
	`ö£π_exã¡
(
roŸ
, 
off£t
, 
£˘‹size
 - 1, sectorsize - 1, 0,

120 
disk_byãƒ
, 
£˘‹size
, 
BTRFS_FILE_EXTENT_REG
, 0, 
¶Ÿ
);

121 
¶Ÿ
++;

122 
disk_byãƒ
 +
£˘‹size
;

123 
off£t
 +
£˘‹size
 - 1;

129 
	`ö£π_exã¡
(
roŸ
, 
off£t
, 
£˘‹size
, 4 * se˘‹size, 0, 
disk_byãƒ
,

130 4 * 
£˘‹size
, 
BTRFS_FILE_EXTENT_REG
, 0, 
¶Ÿ
);

131 
¶Ÿ
++;

132 
off£t
 +
£˘‹size
;

133 
	`ö£π_exã¡
(
roŸ
, 
off£t
, 
£˘‹size
, sectorsize, 0, 0, 0,

134 
BTRFS_FILE_EXTENT_REG
, 0, 
¶Ÿ
);

135 
¶Ÿ
++;

136 
off£t
 +
£˘‹size
;

137 
	`ö£π_exã¡
(
roŸ
, 
off£t
, 2 * 
£˘‹size
, 4 * sectorsize,

138 2 * 
£˘‹size
, 
disk_byãƒ
, 4 * sectorsize,

139 
BTRFS_FILE_EXTENT_REG
, 0, 
¶Ÿ
);

140 
¶Ÿ
++;

141 
off£t
 +2 * 
£˘‹size
;

142 
disk_byãƒ
 +4 * 
£˘‹size
;

145 
	`ö£π_exã¡
(
roŸ
, 
off£t
, 
£˘‹size
, se˘‹size, 0, 
disk_byãƒ
,

146 
£˘‹size
, 
BTRFS_FILE_EXTENT_PREALLOC
, 0, 
¶Ÿ
);

147 
¶Ÿ
++;

148 
off£t
 +
£˘‹size
;

154 
disk_byãƒ
 +2 * 
£˘‹size
;

161 
	`ö£π_exã¡
(
roŸ
, 
off£t
, 
£˘‹size
, 4 * se˘‹size, 0, 
disk_byãƒ
,

162 4 * 
£˘‹size
, 
BTRFS_FILE_EXTENT_PREALLOC
, 0, 
¶Ÿ
);

163 
¶Ÿ
++;

164 
off£t
 +
£˘‹size
;

165 
	`ö£π_exã¡
(
roŸ
, 
off£t
, 
£˘‹size
, 4 * sectorsize, sectorsize,

166 
disk_byãƒ
, 4 * 
£˘‹size
, 
BTRFS_FILE_EXTENT_REG
, 0,

167 
¶Ÿ
);

168 
¶Ÿ
++;

169 
off£t
 +
£˘‹size
;

170 
	`ö£π_exã¡
(
roŸ
, 
off£t
, 2 * 
£˘‹size
, 4 * sectorsize,

171 2 * 
£˘‹size
, 
disk_byãƒ
, 4 * sectorsize,

172 
BTRFS_FILE_EXTENT_PREALLOC
, 0, 
¶Ÿ
);

173 
¶Ÿ
++;

174 
off£t
 +2 * 
£˘‹size
;

175 
disk_byãƒ
 +4 * 
£˘‹size
;

178 
	`ö£π_exã¡
(
roŸ
, 
off£t
, 2 * 
£˘‹size
, 2 * sectorsize, 0,

179 
disk_byãƒ
, 
£˘‹size
, 
BTRFS_FILE_EXTENT_REG
,

180 
BTRFS_COMPRESS_ZLIB
, 
¶Ÿ
);

181 
¶Ÿ
++;

182 
off£t
 +2 * 
£˘‹size
;

184 
disk_byãƒ
 +2 * 
£˘‹size
;

187 
	`ö£π_exã¡
(
roŸ
, 
off£t
, 
£˘‹size
, 4 * se˘‹size, 0, 
disk_byãƒ
,

188 
£˘‹size
, 
BTRFS_FILE_EXTENT_REG
,

189 
BTRFS_COMPRESS_ZLIB
, 
¶Ÿ
);

190 
¶Ÿ
++;

191 
off£t
 +
£˘‹size
;

192 
	`ö£π_exã¡
(
roŸ
, 
off£t
, 
£˘‹size
, sectorsize, 0,

193 
disk_byãƒ
 + 
£˘‹size
, sectorsize,

194 
BTRFS_FILE_EXTENT_REG
, 0, 
¶Ÿ
);

195 
¶Ÿ
++;

196 
off£t
 +
£˘‹size
;

197 
	`ö£π_exã¡
(
roŸ
, 
off£t
, 2 * 
£˘‹size
, 4 * sectorsize,

198 2 * 
£˘‹size
, 
disk_byãƒ
, sectorsize,

199 
BTRFS_FILE_EXTENT_REG
, 
BTRFS_COMPRESS_ZLIB
, 
¶Ÿ
);

200 
¶Ÿ
++;

201 
off£t
 +2 * 
£˘‹size
;

202 
disk_byãƒ
 +2 * 
£˘‹size
;

205 
	`ö£π_exã¡
(
roŸ
, 
off£t
, 
£˘‹size
, se˘‹size, 0, 
disk_byãƒ
,

206 
£˘‹size
, 
BTRFS_FILE_EXTENT_REG
, 0, 
¶Ÿ
);

207 
¶Ÿ
++;

208 
off£t
 +4 * 
£˘‹size
;

209 
disk_byãƒ
 +
£˘‹size
;

210 
	`ö£π_exã¡
(
roŸ
, 
off£t
, 
£˘‹size
, se˘‹size, 0, 
disk_byãƒ
,

211 
£˘‹size
, 
BTRFS_FILE_EXTENT_REG
, 0, 
¶Ÿ
);

212 
	}
}

214 
	g¥óŒoc_⁄ly
 = 0;

215 
	gcom¥es£d_⁄ly
 = 0;

216 
	gvaˇncy_⁄ly
 = 0;

218 
noölöe
 
	$ã°_båfs_gë_exã¡
(
u32
 
£˘‹size
, u32 
nodesize
)

220 
båfs_fs_öfo
 *
fs_öfo
 = 
NULL
;

221 
öode
 *öodê
NULL
;

222 
båfs_roŸ
 *
roŸ
 = 
NULL
;

223 
exã¡_m≠
 *
em
 = 
NULL
;

224 
u64
 
‹ig_°¨t
;

225 
u64
 
disk_byãƒ
;

226 
u64
 
off£t
;

227 
ªt
 = -
ENOMEM
;

229 
	`ã°_msg
("running btrfs_get_extentÅests");

231 
öode
 = 
	`båfs_√w_ã°_öode
();

232 i‡(!
öode
) {

233 
	`ã°_°d_îr
(
TEST_ALLOC_INODE
);

234  
ªt
;

237 
fs_öfo
 = 
	`båfs_Æloc_dummy_fs_öfo
(
nodesize
, 
£˘‹size
);

238 i‡(!
fs_öfo
) {

239 
	`ã°_°d_îr
(
TEST_ALLOC_FS_INFO
);

240 
out
;

243 
roŸ
 = 
	`båfs_Æloc_dummy_roŸ
(
fs_öfo
);

244 i‡(
	`IS_ERR
(
roŸ
)) {

245 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

246 
out
;

249 
roŸ
->
node
 = 
	`Æloc_dummy_exã¡_buf„r
(
fs_öfo
, 
nodesize
);

250 i‡(!
roŸ
->
node
) {

251 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

252 
out
;

255 
	`båfs_£t_hódî_ƒôems
(
roŸ
->
node
, 0);

256 
	`båfs_£t_hódî_Àvñ
(
roŸ
->
node
, 0);

257 
ªt
 = -
EINVAL
;

260 
	`BTRFS_I
(
öode
)->
roŸ
 =Ñoot;

261 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 0, 
£˘‹size
);

262 i‡(
	`IS_ERR
(
em
)) {

263 
em
 = 
NULL
;

264 
	`ã°_îr
("gotánÉrror when we shouldn't have");

265 
out
;

267 i‡(
em
->
block_°¨t
 !
EXTENT_MAP_HOLE
) {

268 
	`ã°_îr
("ex≥˘edá hﬁe, gŸ %Œu", 
em
->
block_°¨t
);

269 
out
;

271 
	`‰ì_exã¡_m≠
(
em
);

272 
	`båfs_dr›_exã¡_m≠_ønge
(
	`BTRFS_I
(
öode
), 0, (
u64
)-1, 
Ál£
);

279 
	`£tup_fûe_exã¡s
(
roŸ
, 
£˘‹size
);

281 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 0, (
u64
)-1);

282 i‡(
	`IS_ERR
(
em
)) {

283 
	`ã°_îr
("gotánÉrror when we shouldn't have");

284 
out
;

286 i‡(
em
->
block_°¨t
 !
EXTENT_MAP_INLINE
) {

287 
	`ã°_îr
("ex≥˘edá¿ölöe, gŸ %Œu", 
em
->
block_°¨t
);

288 
out
;

301 i‡(
em
->
°¨t
 !0 ||Ém->
Àn
 !
£˘‹size
) {

302 
	`ã°_îr
(

304 
£˘‹size
, 
em
->
°¨t
,Ém->
Àn
);

305 
out
;

307 i‡(
em
->
Êags
 != 0) {

308 
	`ã°_îr
("u√x≥˘ed fœg†£t, w™à0 havê%lu", 
em
->
Êags
);

309 
out
;

316 
off£t
 = 
em
->
°¨t
 +Ém->
Àn
;

317 
	`‰ì_exã¡_m≠
(
em
);

319 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
off£t
, 
£˘‹size
);

320 i‡(
	`IS_ERR
(
em
)) {

321 
	`ã°_îr
("gotánÉrror when we shouldn't have");

322 
out
;

324 i‡(
em
->
block_°¨t
 !
EXTENT_MAP_HOLE
) {

325 
	`ã°_îr
("ex≥˘edá hﬁe, gŸ %Œu", 
em
->
block_°¨t
);

326 
out
;

328 i‡(
em
->
°¨t
 !
off£t
 ||Ém->
Àn
 != 4) {

329 
	`ã°_îr
(

331 
off£t
, 
em
->
°¨t
,Ém->
Àn
);

332 
out
;

334 i‡(
em
->
Êags
 != 0) {

335 
	`ã°_îr
("u√x≥˘ed fœg†£t, w™à0 havê%lu", 
em
->
Êags
);

336 
out
;

338 
off£t
 = 
em
->
°¨t
 +Ém->
Àn
;

339 
	`‰ì_exã¡_m≠
(
em
);

342 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
off£t
, 
£˘‹size
);

343 i‡(
	`IS_ERR
(
em
)) {

344 
	`ã°_îr
("gotánÉrror when we shouldn't have");

345 
out
;

347 i‡(
em
->
block_°¨t
 >
EXTENT_MAP_LAST_BYTE
) {

348 
	`ã°_îr
("ex≥˘edáÑó»exã¡, gŸ %Œu", 
em
->
block_°¨t
);

349 
out
;

351 i‡(
em
->
°¨t
 !
off£t
 ||Ém->
Àn
 !
£˘‹size
 - 1) {

352 
	`ã°_îr
(

354 
off£t
, 
em
->
°¨t
,Ém->
Àn
);

355 
out
;

357 i‡(
em
->
Êags
 != 0) {

358 
	`ã°_îr
("u√x≥˘ed fœg†£t, w™à0 havê%lu", 
em
->
Êags
);

359 
out
;

361 i‡(
em
->
‹ig_°¨t
 !em->
°¨t
) {

362 
	`ã°_îr
("wr⁄g orig off£t, w™à%Œu, havê%Œu", 
em
->
°¨t
,

363 
em
->
‹ig_°¨t
);

364 
out
;

366 
off£t
 = 
em
->
°¨t
 +Ém->
Àn
;

367 
	`‰ì_exã¡_m≠
(
em
);

370 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
off£t
, 
£˘‹size
);

371 i‡(
	`IS_ERR
(
em
)) {

372 
	`ã°_îr
("gotánÉrror when we shouldn't have");

373 
out
;

375 i‡(
em
->
block_°¨t
 >
EXTENT_MAP_LAST_BYTE
) {

376 
	`ã°_îr
("ex≥˘edáÑó»exã¡, gŸ %Œu", 
em
->
block_°¨t
);

377 
out
;

379 i‡(
em
->
°¨t
 !
off£t
 ||Ém->
Àn
 !
£˘‹size
) {

380 
	`ã°_îr
(

382 
off£t
, 
£˘‹size
, 
em
->
°¨t
,Ém->
Àn
);

383 
out
;

385 i‡(
em
->
Êags
 != 0) {

386 
	`ã°_îr
("u√x≥˘ed fœg†£t, w™à0 havê%lu", 
em
->
Êags
);

387 
out
;

389 i‡(
em
->
‹ig_°¨t
 !em->
°¨t
) {

390 
	`ã°_îr
("wr⁄g orig off£t, w™à%Œu, havê%Œu", 
em
->
°¨t
,

391 
em
->
‹ig_°¨t
);

392 
out
;

394 
disk_byãƒ
 = 
em
->
block_°¨t
;

395 
‹ig_°¨t
 = 
em
->
°¨t
;

396 
off£t
 = 
em
->
°¨t
 +Ém->
Àn
;

397 
	`‰ì_exã¡_m≠
(
em
);

399 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
off£t
, 
£˘‹size
);

400 i‡(
	`IS_ERR
(
em
)) {

401 
	`ã°_îr
("gotánÉrror when we shouldn't have");

402 
out
;

404 i‡(
em
->
block_°¨t
 !
EXTENT_MAP_HOLE
) {

405 
	`ã°_îr
("ex≥˘edá hﬁe, gŸ %Œu", 
em
->
block_°¨t
);

406 
out
;

408 i‡(
em
->
°¨t
 !
off£t
 ||Ém->
Àn
 !
£˘‹size
) {

409 
	`ã°_îr
(

411 
off£t
, 
£˘‹size
, 
em
->
°¨t
,Ém->
Àn
);

412 
out
;

414 i‡(
em
->
Êags
 != 0) {

415 
	`ã°_îr
("u√x≥˘ed fœg†£t, w™à0 havê%lu", 
em
->
Êags
);

416 
out
;

418 
off£t
 = 
em
->
°¨t
 +Ém->
Àn
;

419 
	`‰ì_exã¡_m≠
(
em
);

421 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
off£t
, 
£˘‹size
);

422 i‡(
	`IS_ERR
(
em
)) {

423 
	`ã°_îr
("gotánÉrror when we shouldn't have");

424 
out
;

426 i‡(
em
->
block_°¨t
 >
EXTENT_MAP_LAST_BYTE
) {

427 
	`ã°_îr
("ex≥˘edáÑó»exã¡, gŸ %Œu", 
em
->
block_°¨t
);

428 
out
;

430 i‡(
em
->
°¨t
 !
off£t
 ||Ém->
Àn
 !2 * 
£˘‹size
) {

431 
	`ã°_îr
(

433 
off£t
, 2 * 
£˘‹size
, 
em
->
°¨t
,Ém->
Àn
);

434 
out
;

436 i‡(
em
->
Êags
 != 0) {

437 
	`ã°_îr
("u√x≥˘ed fœg†£t, w™à0 havê%lu", 
em
->
Êags
);

438 
out
;

440 i‡(
em
->
‹ig_°¨t
 != orig_start) {

441 
	`ã°_îr
("wrong orig offset, want %llu, have %llu",

442 
‹ig_°¨t
, 
em
->orig_start);

443 
out
;

445 
disk_byãƒ
 +(
em
->
°¨t
 - 
‹ig_°¨t
);

446 i‡(
em
->
block_°¨t
 !
disk_byãƒ
) {

447 
	`ã°_îr
("wrong block start, want %llu, have %llu",

448 
disk_byãƒ
, 
em
->
block_°¨t
);

449 
out
;

451 
off£t
 = 
em
->
°¨t
 +Ém->
Àn
;

452 
	`‰ì_exã¡_m≠
(
em
);

455 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
off£t
, 
£˘‹size
);

456 i‡(
	`IS_ERR
(
em
)) {

457 
	`ã°_îr
("gotánÉrror when we shouldn't have");

458 
out
;

460 i‡(
em
->
block_°¨t
 >
EXTENT_MAP_LAST_BYTE
) {

461 
	`ã°_îr
("ex≥˘edáÑó»exã¡, gŸ %Œu", 
em
->
block_°¨t
);

462 
out
;

464 i‡(
em
->
°¨t
 !
off£t
 ||Ém->
Àn
 !
£˘‹size
) {

465 
	`ã°_îr
(

467 
off£t
, 
£˘‹size
, 
em
->
°¨t
,Ém->
Àn
);

468 
out
;

470 i‡(
em
->
Êags
 !
¥óŒoc_⁄ly
) {

471 
	`ã°_îr
("unexpected flags set, want %lu have %lu",

472 
¥óŒoc_⁄ly
, 
em
->
Êags
);

473 
out
;

475 i‡(
em
->
‹ig_°¨t
 !em->
°¨t
) {

476 
	`ã°_îr
("wr⁄g orig off£t, w™à%Œu, havê%Œu", 
em
->
°¨t
,

477 
em
->
‹ig_°¨t
);

478 
out
;

480 
off£t
 = 
em
->
°¨t
 +Ém->
Àn
;

481 
	`‰ì_exã¡_m≠
(
em
);

484 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
off£t
, 
£˘‹size
);

485 i‡(
	`IS_ERR
(
em
)) {

486 
	`ã°_îr
("gotánÉrror when we shouldn't have");

487 
out
;

489 i‡(
em
->
block_°¨t
 >
EXTENT_MAP_LAST_BYTE
) {

490 
	`ã°_îr
("ex≥˘edáÑó»exã¡, gŸ %Œu", 
em
->
block_°¨t
);

491 
out
;

493 i‡(
em
->
°¨t
 !
off£t
 ||Ém->
Àn
 !
£˘‹size
) {

494 
	`ã°_îr
(

496 
off£t
, 
£˘‹size
, 
em
->
°¨t
,Ém->
Àn
);

497 
out
;

499 i‡(
em
->
Êags
 !
¥óŒoc_⁄ly
) {

500 
	`ã°_îr
("unexpected flags set, want %lu have %lu",

501 
¥óŒoc_⁄ly
, 
em
->
Êags
);

502 
out
;

504 i‡(
em
->
‹ig_°¨t
 !em->
°¨t
) {

505 
	`ã°_îr
("wr⁄g orig off£t, w™à%Œu, havê%Œu", 
em
->
°¨t
,

506 
em
->
‹ig_°¨t
);

507 
out
;

509 
disk_byãƒ
 = 
em
->
block_°¨t
;

510 
‹ig_°¨t
 = 
em
->
°¨t
;

511 
off£t
 = 
em
->
°¨t
 +Ém->
Àn
;

512 
	`‰ì_exã¡_m≠
(
em
);

514 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
off£t
, 
£˘‹size
);

515 i‡(
	`IS_ERR
(
em
)) {

516 
	`ã°_îr
("gotánÉrror when we shouldn't have");

517 
out
;

519 i‡(
em
->
block_°¨t
 >
EXTENT_MAP_HOLE
) {

520 
	`ã°_îr
("ex≥˘edáÑó»exã¡, gŸ %Œu", 
em
->
block_°¨t
);

521 
out
;

523 i‡(
em
->
°¨t
 !
off£t
 ||Ém->
Àn
 !
£˘‹size
) {

524 
	`ã°_îr
(

526 
off£t
, 
£˘‹size
, 
em
->
°¨t
,Ém->
Àn
);

527 
out
;

529 i‡(
em
->
Êags
 != 0) {

530 
	`ã°_îr
("u√x≥˘ed fœg†£t, w™à0 havê%lu", 
em
->
Êags
);

531 
out
;

533 i‡(
em
->
‹ig_°¨t
 != orig_start) {

534 
	`ã°_îr
("unexpected orig offset, wanted %llu, have %llu",

535 
‹ig_°¨t
, 
em
->orig_start);

536 
out
;

538 i‡(
em
->
block_°¨t
 !(
disk_byãƒ
 + (em->
°¨t
 -Ém->
‹ig_°¨t
))) {

539 
	`ã°_îr
("unexpected block start, wanted %llu, have %llu",

540 
disk_byãƒ
 + (
em
->
°¨t
 -Ém->
‹ig_°¨t
),

541 
em
->
block_°¨t
);

542 
out
;

544 
off£t
 = 
em
->
°¨t
 +Ém->
Àn
;

545 
	`‰ì_exã¡_m≠
(
em
);

547 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
off£t
, 
£˘‹size
);

548 i‡(
	`IS_ERR
(
em
)) {

549 
	`ã°_îr
("gotánÉrror when we shouldn't have");

550 
out
;

552 i‡(
em
->
block_°¨t
 >
EXTENT_MAP_LAST_BYTE
) {

553 
	`ã°_îr
("ex≥˘edáÑó»exã¡, gŸ %Œu", 
em
->
block_°¨t
);

554 
out
;

556 i‡(
em
->
°¨t
 !
off£t
 ||Ém->
Àn
 !2 * 
£˘‹size
) {

557 
	`ã°_îr
(

559 
off£t
, 2 * 
£˘‹size
, 
em
->
°¨t
,Ém->
Àn
);

560 
out
;

562 i‡(
em
->
Êags
 !
¥óŒoc_⁄ly
) {

563 
	`ã°_îr
("unexpected flags set, want %lu have %lu",

564 
¥óŒoc_⁄ly
, 
em
->
Êags
);

565 
out
;

567 i‡(
em
->
‹ig_°¨t
 != orig_start) {

568 
	`ã°_îr
("wr⁄g orig off£t, w™à%Œu, havê%Œu", 
‹ig_°¨t
,

569 
em
->
‹ig_°¨t
);

570 
out
;

572 i‡(
em
->
block_°¨t
 !(
disk_byãƒ
 + (em->
°¨t
 -Ém->
‹ig_°¨t
))) {

573 
	`ã°_îr
("unexpected block start, wanted %llu, have %llu",

574 
disk_byãƒ
 + (
em
->
°¨t
 -Ém->
‹ig_°¨t
),

575 
em
->
block_°¨t
);

576 
out
;

578 
off£t
 = 
em
->
°¨t
 +Ém->
Àn
;

579 
	`‰ì_exã¡_m≠
(
em
);

582 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
off£t
, 
£˘‹size
);

583 i‡(
	`IS_ERR
(
em
)) {

584 
	`ã°_îr
("gotánÉrror when we shouldn't have");

585 
out
;

587 i‡(
em
->
block_°¨t
 >
EXTENT_MAP_LAST_BYTE
) {

588 
	`ã°_îr
("ex≥˘edáÑó»exã¡, gŸ %Œu", 
em
->
block_°¨t
);

589 
out
;

591 i‡(
em
->
°¨t
 !
off£t
 ||Ém->
Àn
 !2 * 
£˘‹size
) {

592 
	`ã°_îr
(

594 
off£t
, 2 * 
£˘‹size
, 
em
->
°¨t
,Ém->
Àn
);

595 
out
;

597 i‡(
em
->
Êags
 !
com¥es£d_⁄ly
) {

598 
	`ã°_îr
("unexpected flags set, want %lu have %lu",

599 
com¥es£d_⁄ly
, 
em
->
Êags
);

600 
out
;

602 i‡(
em
->
‹ig_°¨t
 !em->
°¨t
) {

603 
	`ã°_îr
("wrong orig offset, want %llu, have %llu",

604 
em
->
°¨t
,Ém->
‹ig_°¨t
);

605 
out
;

607 i‡(
em
->
com¥ess_ty≥
 !
BTRFS_COMPRESS_ZLIB
) {

608 
	`ã°_îr
("unexpected compressÅype, wanted %d, got %d",

609 
BTRFS_COMPRESS_ZLIB
, 
em
->
com¥ess_ty≥
);

610 
out
;

612 
off£t
 = 
em
->
°¨t
 +Ém->
Àn
;

613 
	`‰ì_exã¡_m≠
(
em
);

616 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
off£t
, 
£˘‹size
);

617 i‡(
	`IS_ERR
(
em
)) {

618 
	`ã°_îr
("gotánÉrror when we shouldn't have");

619 
out
;

621 i‡(
em
->
block_°¨t
 >
EXTENT_MAP_LAST_BYTE
) {

622 
	`ã°_îr
("ex≥˘edáÑó»exã¡, gŸ %Œu", 
em
->
block_°¨t
);

623 
out
;

625 i‡(
em
->
°¨t
 !
off£t
 ||Ém->
Àn
 !
£˘‹size
) {

626 
	`ã°_îr
(

628 
off£t
, 
£˘‹size
, 
em
->
°¨t
,Ém->
Àn
);

629 
out
;

631 i‡(
em
->
Êags
 !
com¥es£d_⁄ly
) {

632 
	`ã°_îr
("unexpected flags set, want %lu have %lu",

633 
com¥es£d_⁄ly
, 
em
->
Êags
);

634 
out
;

636 i‡(
em
->
‹ig_°¨t
 !em->
°¨t
) {

637 
	`ã°_îr
("wrong orig offset, want %llu, have %llu",

638 
em
->
°¨t
,Ém->
‹ig_°¨t
);

639 
out
;

641 i‡(
em
->
com¥ess_ty≥
 !
BTRFS_COMPRESS_ZLIB
) {

642 
	`ã°_îr
("unexpected compressÅype, wanted %d, got %d",

643 
BTRFS_COMPRESS_ZLIB
, 
em
->
com¥ess_ty≥
);

644 
out
;

646 
disk_byãƒ
 = 
em
->
block_°¨t
;

647 
‹ig_°¨t
 = 
em
->
°¨t
;

648 
off£t
 = 
em
->
°¨t
 +Ém->
Àn
;

649 
	`‰ì_exã¡_m≠
(
em
);

651 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
off£t
, 
£˘‹size
);

652 i‡(
	`IS_ERR
(
em
)) {

653 
	`ã°_îr
("gotánÉrror when we shouldn't have");

654 
out
;

656 i‡(
em
->
block_°¨t
 >
EXTENT_MAP_LAST_BYTE
) {

657 
	`ã°_îr
("ex≥˘edáÑó»exã¡, gŸ %Œu", 
em
->
block_°¨t
);

658 
out
;

660 i‡(
em
->
°¨t
 !
off£t
 ||Ém->
Àn
 !
£˘‹size
) {

661 
	`ã°_îr
(

663 
off£t
, 
£˘‹size
, 
em
->
°¨t
,Ém->
Àn
);

664 
out
;

666 i‡(
em
->
Êags
 != 0) {

667 
	`ã°_îr
("u√x≥˘ed fœg†£t, w™à0 havê%lu", 
em
->
Êags
);

668 
out
;

670 i‡(
em
->
‹ig_°¨t
 !em->
°¨t
) {

671 
	`ã°_îr
("wr⁄g orig off£t, w™à%Œu, havê%Œu", 
em
->
°¨t
,

672 
em
->
‹ig_°¨t
);

673 
out
;

675 
off£t
 = 
em
->
°¨t
 +Ém->
Àn
;

676 
	`‰ì_exã¡_m≠
(
em
);

678 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
off£t
, 
£˘‹size
);

679 i‡(
	`IS_ERR
(
em
)) {

680 
	`ã°_îr
("gotánÉrror when we shouldn't have");

681 
out
;

683 i‡(
em
->
block_°¨t
 !
disk_byãƒ
) {

684 
	`ã°_îr
("block start doesÇot match, want %llu got %llu",

685 
disk_byãƒ
, 
em
->
block_°¨t
);

686 
out
;

688 i‡(
em
->
°¨t
 !
off£t
 ||Ém->
Àn
 !2 * 
£˘‹size
) {

689 
	`ã°_îr
(

691 
off£t
, 2 * 
£˘‹size
, 
em
->
°¨t
,Ém->
Àn
);

692 
out
;

694 i‡(
em
->
Êags
 !
com¥es£d_⁄ly
) {

695 
	`ã°_îr
("unexpected flags set, want %lu have %lu",

696 
com¥es£d_⁄ly
, 
em
->
Êags
);

697 
out
;

699 i‡(
em
->
‹ig_°¨t
 != orig_start) {

700 
	`ã°_îr
("wrong orig offset, want %llu, have %llu",

701 
em
->
°¨t
, 
‹ig_°¨t
);

702 
out
;

704 i‡(
em
->
com¥ess_ty≥
 !
BTRFS_COMPRESS_ZLIB
) {

705 
	`ã°_îr
("unexpected compressÅype, wanted %d, got %d",

706 
BTRFS_COMPRESS_ZLIB
, 
em
->
com¥ess_ty≥
);

707 
out
;

709 
off£t
 = 
em
->
°¨t
 +Ém->
Àn
;

710 
	`‰ì_exã¡_m≠
(
em
);

713 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
off£t
 + 6, 
£˘‹size
);

714 i‡(
	`IS_ERR
(
em
)) {

715 
	`ã°_îr
("gotánÉrror when we shouldn't have");

716 
out
;

718 i‡(
em
->
block_°¨t
 >
EXTENT_MAP_LAST_BYTE
) {

719 
	`ã°_îr
("ex≥˘edáÑó»exã¡, gŸ %Œu", 
em
->
block_°¨t
);

720 
out
;

722 i‡(
em
->
°¨t
 !
off£t
 ||Ém->
Àn
 !
£˘‹size
) {

723 
	`ã°_îr
(

725 
off£t
, 
£˘‹size
, 
em
->
°¨t
,Ém->
Àn
);

726 
out
;

728 i‡(
em
->
Êags
 != 0) {

729 
	`ã°_îr
("u√x≥˘ed fœg†£t, w™à0 havê%lu", 
em
->
Êags
);

730 
out
;

732 i‡(
em
->
‹ig_°¨t
 !em->
°¨t
) {

733 
	`ã°_îr
("wr⁄g orig off£t, w™à%Œu, havê%Œu", 
em
->
°¨t
,

734 
em
->
‹ig_°¨t
);

735 
out
;

737 
off£t
 = 
em
->
°¨t
 +Ém->
Àn
;

738 
	`‰ì_exã¡_m≠
(
em
);

740 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
off£t
, 
SZ_4M
);

741 i‡(
	`IS_ERR
(
em
)) {

742 
	`ã°_îr
("gotánÉrror when we shouldn't have");

743 
out
;

745 i‡(
em
->
block_°¨t
 !
EXTENT_MAP_HOLE
) {

746 
	`ã°_îr
("ex≥˘edá hﬁêexã¡, gŸ %Œu", 
em
->
block_°¨t
);

747 
out
;

754 i‡(
em
->
°¨t
 !
off£t
 ||Ém->
Àn
 !3 * 
£˘‹size
) {

755 
	`ã°_îr
(

757 
off£t
, 3 * 
£˘‹size
, 
em
->
°¨t
,Ém->
Àn
);

758 
out
;

760 i‡(
em
->
Êags
 !
vaˇncy_⁄ly
) {

761 
	`ã°_îr
("unexpected flags set, want %lu have %lu",

762 
vaˇncy_⁄ly
, 
em
->
Êags
);

763 
out
;

765 i‡(
em
->
‹ig_°¨t
 !em->
°¨t
) {

766 
	`ã°_îr
("wr⁄g orig off£t, w™à%Œu, havê%Œu", 
em
->
°¨t
,

767 
em
->
‹ig_°¨t
);

768 
out
;

770 
off£t
 = 
em
->
°¨t
 +Ém->
Àn
;

771 
	`‰ì_exã¡_m≠
(
em
);

773 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
off£t
, 
£˘‹size
);

774 i‡(
	`IS_ERR
(
em
)) {

775 
	`ã°_îr
("gotánÉrror when we shouldn't have");

776 
out
;

778 i‡(
em
->
block_°¨t
 >
EXTENT_MAP_LAST_BYTE
) {

779 
	`ã°_îr
("ex≥˘edáÑó»exã¡, gŸ %Œu", 
em
->
block_°¨t
);

780 
out
;

782 i‡(
em
->
°¨t
 !
off£t
 ||Ém->
Àn
 !
£˘‹size
) {

783 
	`ã°_îr
(

785 
off£t
, 
£˘‹size
, 
em
->
°¨t
,Ém->
Àn
);

786 
out
;

788 i‡(
em
->
Êags
 != 0) {

789 
	`ã°_îr
("u√x≥˘ed fœg†£t, w™à0 havê%lu", 
em
->
Êags
);

790 
out
;

792 i‡(
em
->
‹ig_°¨t
 !em->
°¨t
) {

793 
	`ã°_îr
("wr⁄g orig off£t, w™à%Œu, havê%Œu", 
em
->
°¨t
,

794 
em
->
‹ig_°¨t
);

795 
out
;

797 
ªt
 = 0;

798 
out
:

799 i‡(!
	`IS_ERR
(
em
))

800 
	`‰ì_exã¡_m≠
(
em
);

801 
	`ùut
(
öode
);

802 
	`båfs_‰ì_dummy_roŸ
(
roŸ
);

803 
	`båfs_‰ì_dummy_fs_öfo
(
fs_öfo
);

804  
ªt
;

805 
	}
}

807 
	$ã°_hﬁe_fú°
(
u32
 
£˘‹size
, u32 
nodesize
)

809 
båfs_fs_öfo
 *
fs_öfo
 = 
NULL
;

810 
öode
 *öodê
NULL
;

811 
båfs_roŸ
 *
roŸ
 = 
NULL
;

812 
exã¡_m≠
 *
em
 = 
NULL
;

813 
ªt
 = -
ENOMEM
;

815 
	`ã°_msg
("running hole first btrfs_get_extentÅest");

817 
öode
 = 
	`båfs_√w_ã°_öode
();

818 i‡(!
öode
) {

819 
	`ã°_°d_îr
(
TEST_ALLOC_INODE
);

820  
ªt
;

823 
fs_öfo
 = 
	`båfs_Æloc_dummy_fs_öfo
(
nodesize
, 
£˘‹size
);

824 i‡(!
fs_öfo
) {

825 
	`ã°_°d_îr
(
TEST_ALLOC_FS_INFO
);

826 
out
;

829 
roŸ
 = 
	`båfs_Æloc_dummy_roŸ
(
fs_öfo
);

830 i‡(
	`IS_ERR
(
roŸ
)) {

831 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

832 
out
;

835 
roŸ
->
node
 = 
	`Æloc_dummy_exã¡_buf„r
(
fs_öfo
, 
nodesize
);

836 i‡(!
roŸ
->
node
) {

837 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

838 
out
;

841 
	`båfs_£t_hódî_ƒôems
(
roŸ
->
node
, 0);

842 
	`båfs_£t_hódî_Àvñ
(
roŸ
->
node
, 0);

843 
	`BTRFS_I
(
öode
)->
roŸ
 =Ñoot;

844 
ªt
 = -
EINVAL
;

850 
	`ö£π_öode_ôem_key
(
roŸ
);

851 
	`ö£π_exã¡
(
roŸ
, 
£˘‹size
, sectorsize, sectorsize, 0, sectorsize,

852 
£˘‹size
, 
BTRFS_FILE_EXTENT_REG
, 0, 1);

853 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 0, 2 * 
£˘‹size
);

854 i‡(
	`IS_ERR
(
em
)) {

855 
	`ã°_îr
("gotánÉrror when we shouldn't have");

856 
out
;

858 i‡(
em
->
block_°¨t
 !
EXTENT_MAP_HOLE
) {

859 
	`ã°_îr
("ex≥˘edá hﬁe, gŸ %Œu", 
em
->
block_°¨t
);

860 
out
;

862 i‡(
em
->
°¨t
 !0 ||Ém->
Àn
 !
£˘‹size
) {

863 
	`ã°_îr
(

865 
£˘‹size
, 
em
->
°¨t
,Ém->
Àn
);

866 
out
;

868 i‡(
em
->
Êags
 !
vaˇncy_⁄ly
) {

869 
	`ã°_îr
("wr⁄g fœgs, w™ãd %lu, havê%lu", 
vaˇncy_⁄ly
,

870 
em
->
Êags
);

871 
out
;

873 
	`‰ì_exã¡_m≠
(
em
);

875 
em
 = 
	`båfs_gë_exã¡
(
	`BTRFS_I
(
öode
), 
NULL
, 0, 
£˘‹size
, 2 * sectorsize);

876 i‡(
	`IS_ERR
(
em
)) {

877 
	`ã°_îr
("gotánÉrror when we shouldn't have");

878 
out
;

880 i‡(
em
->
block_°¨t
 !
£˘‹size
) {

881 
	`ã°_îr
("ex≥˘edáÑó»exã¡, gŸ %Œu", 
em
->
block_°¨t
);

882 
out
;

884 i‡(
em
->
°¨t
 !
£˘‹size
 ||Ém->
Àn
 != sectorsize) {

885 
	`ã°_îr
(

887 
£˘‹size
, se˘‹size, 
em
->
°¨t
,Ém->
Àn
);

888 
out
;

890 i‡(
em
->
Êags
 != 0) {

891 
	`ã°_îr
("unexpected flags set, wanted 0 got %lu",

892 
em
->
Êags
);

893 
out
;

895 
ªt
 = 0;

896 
out
:

897 i‡(!
	`IS_ERR
(
em
))

898 
	`‰ì_exã¡_m≠
(
em
);

899 
	`ùut
(
öode
);

900 
	`båfs_‰ì_dummy_roŸ
(
roŸ
);

901 
	`båfs_‰ì_dummy_fs_öfo
(
fs_öfo
);

902  
ªt
;

903 
	}
}

905 
	$ã°_exã¡_accou¡ög
(
u32
 
£˘‹size
, u32 
nodesize
)

907 
båfs_fs_öfo
 *
fs_öfo
 = 
NULL
;

908 
öode
 *öodê
NULL
;

909 
båfs_roŸ
 *
roŸ
 = 
NULL
;

910 
ªt
 = -
ENOMEM
;

912 
	`ã°_msg
("running outstanding_extentsÅests");

914 
öode
 = 
	`båfs_√w_ã°_öode
();

915 i‡(!
öode
) {

916 
	`ã°_°d_îr
(
TEST_ALLOC_INODE
);

917  
ªt
;

920 
fs_öfo
 = 
	`båfs_Æloc_dummy_fs_öfo
(
nodesize
, 
£˘‹size
);

921 i‡(!
fs_öfo
) {

922 
	`ã°_°d_îr
(
TEST_ALLOC_FS_INFO
);

923 
out
;

926 
roŸ
 = 
	`båfs_Æloc_dummy_roŸ
(
fs_öfo
);

927 i‡(
	`IS_ERR
(
roŸ
)) {

928 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

929 
out
;

932 
	`BTRFS_I
(
öode
)->
roŸ
 =Ñoot;

935 
ªt
 = 
	`båfs_£t_exã¡_dñÆloc
(
	`BTRFS_I
(
öode
), 0,

936 
BTRFS_MAX_EXTENT_SIZE
 - 1, 0, 
NULL
);

937 i‡(
ªt
) {

938 
	`ã°_îr
("båfs_£t_exã¡_dñÆlo¯ªtu∫ed %d", 
ªt
);

939 
out
;

941 i‡(
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
 != 1) {

942 
ªt
 = -
EINVAL
;

943 
	`ã°_îr
("miscount, wanted 1, got %u",

944 
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
);

945 
out
;

949 
ªt
 = 
	`båfs_£t_exã¡_dñÆloc
(
	`BTRFS_I
(
öode
), 
BTRFS_MAX_EXTENT_SIZE
,

950 
BTRFS_MAX_EXTENT_SIZE
 + 
£˘‹size
 - 1,

951 0, 
NULL
);

952 i‡(
ªt
) {

953 
	`ã°_îr
("båfs_£t_exã¡_dñÆlo¯ªtu∫ed %d", 
ªt
);

954 
out
;

956 i‡(
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
 != 2) {

957 
ªt
 = -
EINVAL
;

958 
	`ã°_îr
("miscount, wanted 2, got %u",

959 
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
);

960 
out
;

964 
ªt
 = 
	`˛ór_exã¡_bô
(&
	`BTRFS_I
(
öode
)->
io_åì
,

965 
BTRFS_MAX_EXTENT_SIZE
 >> 1,

966 (
BTRFS_MAX_EXTENT_SIZE
 >> 1Ë+ 
£˘‹size
 - 1,

967 
EXTENT_DELALLOC
 | 
EXTENT_DELALLOC_NEW
 |

968 
EXTENT_UPTODATE
, 
NULL
);

969 i‡(
ªt
) {

970 
	`ã°_îr
("˛ór_exã¡_bôÑëu∫ed %d", 
ªt
);

971 
out
;

973 i‡(
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
 != 2) {

974 
ªt
 = -
EINVAL
;

975 
	`ã°_îr
("miscount, wanted 2, got %u",

976 
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
);

977 
out
;

981 
ªt
 = 
	`båfs_£t_exã¡_dñÆloc
(
	`BTRFS_I
(
öode
), 
BTRFS_MAX_EXTENT_SIZE
 >> 1,

982 (
BTRFS_MAX_EXTENT_SIZE
 >> 1)

983 + 
£˘‹size
 - 1,

984 0, 
NULL
);

985 i‡(
ªt
) {

986 
	`ã°_îr
("båfs_£t_exã¡_dñÆlo¯ªtu∫ed %d", 
ªt
);

987 
out
;

989 i‡(
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
 != 2) {

990 
ªt
 = -
EINVAL
;

991 
	`ã°_îr
("miscount, wanted 2, got %u",

992 
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
);

993 
out
;

999 
ªt
 = 
	`båfs_£t_exã¡_dñÆloc
(
	`BTRFS_I
(
öode
),

1000 
BTRFS_MAX_EXTENT_SIZE
 + 2 * 
£˘‹size
,

1001 (
BTRFS_MAX_EXTENT_SIZE
 << 1Ë+ 3 * 
£˘‹size
 - 1,

1002 0, 
NULL
);

1003 i‡(
ªt
) {

1004 
	`ã°_îr
("båfs_£t_exã¡_dñÆlo¯ªtu∫ed %d", 
ªt
);

1005 
out
;

1007 i‡(
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
 != 4) {

1008 
ªt
 = -
EINVAL
;

1009 
	`ã°_îr
("miscount, wanted 4, got %u",

1010 
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
);

1011 
out
;

1017 
ªt
 = 
	`båfs_£t_exã¡_dñÆloc
(
	`BTRFS_I
(
öode
),

1018 
BTRFS_MAX_EXTENT_SIZE
 + 
£˘‹size
,

1019 
BTRFS_MAX_EXTENT_SIZE
 + 2 * 
£˘‹size
 - 1, 0, 
NULL
);

1020 i‡(
ªt
) {

1021 
	`ã°_îr
("båfs_£t_exã¡_dñÆlo¯ªtu∫ed %d", 
ªt
);

1022 
out
;

1024 i‡(
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
 != 3) {

1025 
ªt
 = -
EINVAL
;

1026 
	`ã°_îr
("miscount, wanted 3, got %u",

1027 
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
);

1028 
out
;

1032 
ªt
 = 
	`˛ór_exã¡_bô
(&
	`BTRFS_I
(
öode
)->
io_åì
,

1033 
BTRFS_MAX_EXTENT_SIZE
 + 
£˘‹size
,

1034 
BTRFS_MAX_EXTENT_SIZE
 + 2 * 
£˘‹size
 - 1,

1035 
EXTENT_DELALLOC
 | 
EXTENT_DELALLOC_NEW
 |

1036 
EXTENT_UPTODATE
, 
NULL
);

1037 i‡(
ªt
) {

1038 
	`ã°_îr
("˛ór_exã¡_bôÑëu∫ed %d", 
ªt
);

1039 
out
;

1041 i‡(
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
 != 4) {

1042 
ªt
 = -
EINVAL
;

1043 
	`ã°_îr
("miscount, wanted 4, got %u",

1044 
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
);

1045 
out
;

1052 
ªt
 = 
	`båfs_£t_exã¡_dñÆloc
(
	`BTRFS_I
(
öode
),

1053 
BTRFS_MAX_EXTENT_SIZE
 + 
£˘‹size
,

1054 
BTRFS_MAX_EXTENT_SIZE
 + 2 * 
£˘‹size
 - 1, 0, 
NULL
);

1055 i‡(
ªt
) {

1056 
	`ã°_îr
("båfs_£t_exã¡_dñÆlo¯ªtu∫ed %d", 
ªt
);

1057 
out
;

1059 i‡(
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
 != 3) {

1060 
ªt
 = -
EINVAL
;

1061 
	`ã°_îr
("miscount, wanted 3, got %u",

1062 
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
);

1063 
out
;

1067 
ªt
 = 
	`˛ór_exã¡_bô
(&
	`BTRFS_I
(
öode
)->
io_åì
, 0, (
u64
)-1,

1068 
EXTENT_DELALLOC
 | 
EXTENT_DELALLOC_NEW
 |

1069 
EXTENT_UPTODATE
, 
NULL
);

1070 i‡(
ªt
) {

1071 
	`ã°_îr
("˛ór_exã¡_bôÑëu∫ed %d", 
ªt
);

1072 
out
;

1074 i‡(
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
) {

1075 
ªt
 = -
EINVAL
;

1076 
	`ã°_îr
("miscount, wanted 0, got %u",

1077 
	`BTRFS_I
(
öode
)->
out°™dög_exã¡s
);

1078 
out
;

1080 
ªt
 = 0;

1081 
out
:

1082 i‡(
ªt
)

1083 
	`˛ór_exã¡_bô
(&
	`BTRFS_I
(
öode
)->
io_åì
, 0, (
u64
)-1,

1084 
EXTENT_DELALLOC
 | 
EXTENT_DELALLOC_NEW
 |

1085 
EXTENT_UPTODATE
, 
NULL
);

1086 
	`ùut
(
öode
);

1087 
	`båfs_‰ì_dummy_roŸ
(
roŸ
);

1088 
	`båfs_‰ì_dummy_fs_öfo
(
fs_öfo
);

1089  
ªt
;

1090 
	}
}

1092 
	$båfs_ã°_öodes
(
u32
 
£˘‹size
, u32 
nodesize
)

1094 
ªt
;

1096 
	`ã°_msg
("running inodeÅests");

1098 
	`£t_bô
(
EXTENT_FLAG_COMPRESSED
, &
com¥es£d_⁄ly
);

1099 
	`£t_bô
(
EXTENT_FLAG_PREALLOC
, &
¥óŒoc_⁄ly
);

1101 
ªt
 = 
	`ã°_båfs_gë_exã¡
(
£˘‹size
, 
nodesize
);

1102 i‡(
ªt
)

1103  
ªt
;

1104 
ªt
 = 
	`ã°_hﬁe_fú°
(
£˘‹size
, 
nodesize
);

1105 i‡(
ªt
)

1106  
ªt
;

1107  
	`ã°_exã¡_accou¡ög
(
£˘‹size
, 
nodesize
);

1108 
	}
}

	@tests/qgroup-tests.c

6 
	~<löux/ty≥s.h
>

7 
	~"båfs-ã°s.h
"

8 
	~"../˘ªe.h
"

9 
	~"../å™ß˘i⁄.h
"

10 
	~"../disk-io.h
"

11 
	~"../qgroup.h
"

12 
	~"../backªf.h
"

13 
	~"../fs.h
"

14 
	~"../ac˚ss‹s.h
"

16 
	$ö£π_n‹mÆ_åì_ªf
(
båfs_roŸ
 *
roŸ
, 
u64
 
byãƒ
,

17 
u64
 
num_byãs
, u64 
∑ª¡
, u64 
roŸ_obje˘id
)

19 
båfs_å™s_h™dÀ
 
å™s
;

20 
båfs_exã¡_ôem
 *
ôem
;

21 
båfs_exã¡_ölöe_ªf
 *
úef
;

22 
båfs_åì_block_öfo
 *
block_öfo
;

23 
båfs_∑th
 *
∑th
;

24 
exã¡_buf„r
 *
Àaf
;

25 
båfs_key
 
ös
;

26 
u32
 
size
 = (*
ôem
Ë+ (*
úef
Ë+ (*
block_öfo
);

27 
ªt
;

29 
	`båfs_öô_dummy_å™s
(&
å™s
, 
NULL
);

31 
ös
.
obje˘id
 = 
byãƒ
;

32 
ös
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

33 
ös
.
off£t
 = 
num_byãs
;

35 
∑th
 = 
	`båfs_Æloc_∑th
();

36 i‡(!
∑th
) {

37 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

38  -
ENOMEM
;

41 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(&
å™s
, 
roŸ
, 
∑th
, &
ös
, 
size
);

42 i‡(
ªt
) {

43 
	`ã°_îr
("couldn'àö£πÑe‡%d", 
ªt
);

44 
	`båfs_‰ì_∑th
(
∑th
);

45  
ªt
;

48 
Àaf
 = 
∑th
->
nodes
[0];

49 
ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_exã¡_ôem
);

50 
	`båfs_£t_exã¡_ªfs
(
Àaf
, 
ôem
, 1);

51 
	`båfs_£t_exã¡_gíî©i⁄
(
Àaf
, 
ôem
, 1);

52 
	`båfs_£t_exã¡_Êags
(
Àaf
, 
ôem
, 
BTRFS_EXTENT_FLAG_TREE_BLOCK
);

53 
block_öfo
 = (
båfs_åì_block_öfo
 *)(
ôem
 + 1);

54 
	`båfs_£t_åì_block_Àvñ
(
Àaf
, 
block_öfo
, 0);

55 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)(
block_öfo
 + 1);

56 i‡(
∑ª¡
 > 0) {

57 
	`båfs_£t_exã¡_ölöe_ªf_ty≥
(
Àaf
, 
úef
,

58 
BTRFS_SHARED_BLOCK_REF_KEY
);

59 
	`båfs_£t_exã¡_ölöe_ªf_off£t
(
Àaf
, 
úef
, 
∑ª¡
);

61 
	`båfs_£t_exã¡_ölöe_ªf_ty≥
(
Àaf
, 
úef
, 
BTRFS_TREE_BLOCK_REF_KEY
);

62 
	`båfs_£t_exã¡_ölöe_ªf_off£t
(
Àaf
, 
úef
, 
roŸ_obje˘id
);

64 
	`båfs_‰ì_∑th
(
∑th
);

66 
	}
}

68 
	$add_åì_ªf
(
båfs_roŸ
 *
roŸ
, 
u64
 
byãƒ
, u64 
num_byãs
,

69 
u64
 
∑ª¡
, u64 
roŸ_obje˘id
)

71 
båfs_å™s_h™dÀ
 
å™s
;

72 
båfs_exã¡_ôem
 *
ôem
;

73 
båfs_∑th
 *
∑th
;

74 
båfs_key
 
key
;

75 
u64
 
ªfs
;

76 
ªt
;

78 
	`båfs_öô_dummy_å™s
(&
å™s
, 
NULL
);

80 
key
.
obje˘id
 = 
byãƒ
;

81 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

82 
key
.
off£t
 = 
num_byãs
;

84 
∑th
 = 
	`båfs_Æloc_∑th
();

85 i‡(!
∑th
) {

86 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

87  -
ENOMEM
;

90 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(&
å™s
, 
roŸ
, &
key
, 
∑th
, 0, 1);

91 i‡(
ªt
) {

92 
	`ã°_îr
("couldn't findÉxtentÑef");

93 
	`båfs_‰ì_∑th
(
∑th
);

94  
ªt
;

97 
ôem
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

98 
båfs_exã¡_ôem
);

99 
ªfs
 = 
	`båfs_exã¡_ªfs
(
∑th
->
nodes
[0], 
ôem
);

100 
	`båfs_£t_exã¡_ªfs
(
∑th
->
nodes
[0], 
ôem
, 
ªfs
 + 1);

101 
	`båfs_ªÀa£_∑th
(
∑th
);

103 
key
.
obje˘id
 = 
byãƒ
;

104 i‡(
∑ª¡
) {

105 
key
.
ty≥
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

106 
key
.
off£t
 = 
∑ª¡
;

108 
key
.
ty≥
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

109 
key
.
off£t
 = 
roŸ_obje˘id
;

112 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(&
å™s
, 
roŸ
, 
∑th
, &
key
, 0);

113 i‡(
ªt
)

114 
	`ã°_îr
("failedÅo insert backref");

115 
	`båfs_‰ì_∑th
(
∑th
);

116  
ªt
;

117 
	}
}

119 
	$ªmove_exã¡_ôem
(
båfs_roŸ
 *
roŸ
, 
u64
 
byãƒ
,

120 
u64
 
num_byãs
)

122 
båfs_å™s_h™dÀ
 
å™s
;

123 
båfs_key
 
key
;

124 
båfs_∑th
 *
∑th
;

125 
ªt
;

127 
	`båfs_öô_dummy_å™s
(&
å™s
, 
NULL
);

129 
key
.
obje˘id
 = 
byãƒ
;

130 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

131 
key
.
off£t
 = 
num_byãs
;

133 
∑th
 = 
	`båfs_Æloc_∑th
();

134 i‡(!
∑th
) {

135 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

136  -
ENOMEM
;

139 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(&
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

140 i‡(
ªt
) {

141 
	`ã°_îr
("didn'àföd ou∏key %d", 
ªt
);

142 
	`båfs_‰ì_∑th
(
∑th
);

143  
ªt
;

145 
	`båfs_dñ_ôem
(&
å™s
, 
roŸ
, 
∑th
);

146 
	`båfs_‰ì_∑th
(
∑th
);

148 
	}
}

150 
	$ªmove_exã¡_ªf
(
båfs_roŸ
 *
roŸ
, 
u64
 
byãƒ
,

151 
u64
 
num_byãs
, u64 
∑ª¡
, u64 
roŸ_obje˘id
)

153 
båfs_å™s_h™dÀ
 
å™s
;

154 
båfs_exã¡_ôem
 *
ôem
;

155 
båfs_∑th
 *
∑th
;

156 
båfs_key
 
key
;

157 
u64
 
ªfs
;

158 
ªt
;

160 
	`båfs_öô_dummy_å™s
(&
å™s
, 
NULL
);

162 
key
.
obje˘id
 = 
byãƒ
;

163 
key
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

164 
key
.
off£t
 = 
num_byãs
;

166 
∑th
 = 
	`båfs_Æloc_∑th
();

167 i‡(!
∑th
) {

168 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

169  -
ENOMEM
;

172 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(&
å™s
, 
roŸ
, &
key
, 
∑th
, 0, 1);

173 i‡(
ªt
) {

174 
	`ã°_îr
("couldn't findÉxtentÑef");

175 
	`båfs_‰ì_∑th
(
∑th
);

176  
ªt
;

179 
ôem
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

180 
båfs_exã¡_ôem
);

181 
ªfs
 = 
	`båfs_exã¡_ªfs
(
∑th
->
nodes
[0], 
ôem
);

182 
	`båfs_£t_exã¡_ªfs
(
∑th
->
nodes
[0], 
ôem
, 
ªfs
 - 1);

183 
	`båfs_ªÀa£_∑th
(
∑th
);

185 
key
.
obje˘id
 = 
byãƒ
;

186 i‡(
∑ª¡
) {

187 
key
.
ty≥
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

188 
key
.
off£t
 = 
∑ª¡
;

190 
key
.
ty≥
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

191 
key
.
off£t
 = 
roŸ_obje˘id
;

194 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(&
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

195 i‡(
ªt
) {

196 
	`ã°_îr
("couldn'àföd backª‡%d", 
ªt
);

197 
	`båfs_‰ì_∑th
(
∑th
);

198  
ªt
;

200 
	`båfs_dñ_ôem
(&
å™s
, 
roŸ
, 
∑th
);

201 
	`båfs_‰ì_∑th
(
∑th
);

202  
ªt
;

203 
	}
}

205 
	$ã°_no_sh¨ed_qgroup
(
båfs_roŸ
 *
roŸ
,

206 
u32
 
£˘‹size
, u32 
nodesize
)

208 
båfs_backªf_wÆk_˘x
 
˘x
 = { 0 };

209 
båfs_å™s_h™dÀ
 
å™s
;

210 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

211 
uli°
 *
ﬁd_roŸs
 = 
NULL
;

212 
uli°
 *
√w_roŸs
 = 
NULL
;

213 
ªt
;

215 
	`båfs_öô_dummy_å™s
(&
å™s
, 
fs_öfo
);

217 
	`ã°_msg
("running qgroupádd/removeÅests");

218 
ªt
 = 
	`båfs_¸óã_qgroup
(&
å™s
, 
BTRFS_FS_TREE_OBJECTID
);

219 i‡(
ªt
) {

220 
	`ã°_îr
("couldn'à¸óãá qgrou∞%d", 
ªt
);

221  
ªt
;

224 
˘x
.
byãƒ
 = 
nodesize
;

225 
˘x
.
å™s
 = &trans;

226 
˘x
.
fs_öfo
 = fs_info;

233 
ªt
 = 
	`båfs_föd_Æl_roŸs
(&
˘x
, 
Ál£
);

234 i‡(
ªt
) {

235 
	`ã°_îr
("couldn'àföd oldÑoŸs: %d", 
ªt
);

236  
ªt
;

238 
ﬁd_roŸs
 = 
˘x
.
roŸs
;

239 
˘x
.
roŸs
 = 
NULL
;

241 
ªt
 = 
	`ö£π_n‹mÆ_åì_ªf
(
roŸ
, 
nodesize
,Çodesize, 0,

242 
BTRFS_FS_TREE_OBJECTID
);

243 i‡(
ªt
) {

244 
	`uli°_‰ì
(
ﬁd_roŸs
);

245  
ªt
;

248 
ªt
 = 
	`båfs_föd_Æl_roŸs
(&
˘x
, 
Ál£
);

249 i‡(
ªt
) {

250 
	`uli°_‰ì
(
ﬁd_roŸs
);

251 
	`ã°_îr
("couldn'àföd oldÑoŸs: %d", 
ªt
);

252  
ªt
;

254 
√w_roŸs
 = 
˘x
.
roŸs
;

255 
˘x
.
roŸs
 = 
NULL
;

257 
ªt
 = 
	`båfs_qgroup_accou¡_exã¡
(&
å™s
, 
nodesize
,Çodesize, 
ﬁd_roŸs
,

258 
√w_roŸs
);

259 i‡(
ªt
) {

260 
	`ã°_îr
("couldn'àaccou¡ s∑˚ f‹á qgrou∞%d", 
ªt
);

261  
ªt
;

265 
ﬁd_roŸs
 = 
NULL
;

266 
√w_roŸs
 = 
NULL
;

268 i‡(
	`båfs_vîify_qgroup_cou¡s
(
fs_öfo
, 
BTRFS_FS_TREE_OBJECTID
,

269 
nodesize
,Çodesize)) {

270 
	`ã°_îr
("qgroup counts didn't matchÉxpected values");

271  -
EINVAL
;

274 
ªt
 = 
	`båfs_föd_Æl_roŸs
(&
˘x
, 
Ál£
);

275 i‡(
ªt
) {

276 
	`ã°_îr
("couldn'àföd oldÑoŸs: %d", 
ªt
);

277  
ªt
;

279 
ﬁd_roŸs
 = 
˘x
.
roŸs
;

280 
˘x
.
roŸs
 = 
NULL
;

282 
ªt
 = 
	`ªmove_exã¡_ôem
(
roŸ
, 
nodesize
,Çodesize);

283 i‡(
ªt
) {

284 
	`uli°_‰ì
(
ﬁd_roŸs
);

285  -
EINVAL
;

288 
ªt
 = 
	`båfs_föd_Æl_roŸs
(&
˘x
, 
Ál£
);

289 i‡(
ªt
) {

290 
	`uli°_‰ì
(
ﬁd_roŸs
);

291 
	`ã°_îr
("couldn'àföd oldÑoŸs: %d", 
ªt
);

292  
ªt
;

294 
√w_roŸs
 = 
˘x
.
roŸs
;

295 
˘x
.
roŸs
 = 
NULL
;

297 
ªt
 = 
	`båfs_qgroup_accou¡_exã¡
(&
å™s
, 
nodesize
,Çodesize, 
ﬁd_roŸs
,

298 
√w_roŸs
);

299 i‡(
ªt
) {

300 
	`ã°_îr
("couldn'àaccou¡ s∑˚ f‹á qgrou∞%d", 
ªt
);

301  -
EINVAL
;

304 i‡(
	`båfs_vîify_qgroup_cou¡s
(
fs_öfo
, 
BTRFS_FS_TREE_OBJECTID
, 0, 0)) {

305 
	`ã°_îr
("qgroup counts didn't matchÉxpected values");

306  -
EINVAL
;

310 
	}
}

317 
	$ã°_mu…ùÀ_ªfs
(
båfs_roŸ
 *
roŸ
,

318 
u32
 
£˘‹size
, u32 
nodesize
)

320 
båfs_backªf_wÆk_˘x
 
˘x
 = { 0 };

321 
båfs_å™s_h™dÀ
 
å™s
;

322 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

323 
uli°
 *
ﬁd_roŸs
 = 
NULL
;

324 
uli°
 *
√w_roŸs
 = 
NULL
;

325 
ªt
;

327 
	`båfs_öô_dummy_å™s
(&
å™s
, 
fs_öfo
);

329 
	`ã°_msg
("running qgroup multipleÑefsÅest");

335 
ªt
 = 
	`båfs_¸óã_qgroup
(&
å™s
, 
BTRFS_FIRST_FREE_OBJECTID
);

336 i‡(
ªt
) {

337 
	`ã°_îr
("couldn'à¸óãá qgrou∞%d", 
ªt
);

338  
ªt
;

341 
˘x
.
byãƒ
 = 
nodesize
;

342 
˘x
.
å™s
 = &trans;

343 
˘x
.
fs_öfo
 = fs_info;

345 
ªt
 = 
	`båfs_föd_Æl_roŸs
(&
˘x
, 
Ál£
);

346 i‡(
ªt
) {

347 
	`ã°_îr
("couldn'àföd oldÑoŸs: %d", 
ªt
);

348  
ªt
;

350 
ﬁd_roŸs
 = 
˘x
.
roŸs
;

351 
˘x
.
roŸs
 = 
NULL
;

353 
ªt
 = 
	`ö£π_n‹mÆ_åì_ªf
(
roŸ
, 
nodesize
,Çodesize, 0,

354 
BTRFS_FS_TREE_OBJECTID
);

355 i‡(
ªt
) {

356 
	`uli°_‰ì
(
ﬁd_roŸs
);

357  
ªt
;

360 
ªt
 = 
	`båfs_föd_Æl_roŸs
(&
˘x
, 
Ál£
);

361 i‡(
ªt
) {

362 
	`uli°_‰ì
(
ﬁd_roŸs
);

363 
	`ã°_îr
("couldn'àföd oldÑoŸs: %d", 
ªt
);

364  
ªt
;

366 
√w_roŸs
 = 
˘x
.
roŸs
;

367 
˘x
.
roŸs
 = 
NULL
;

369 
ªt
 = 
	`båfs_qgroup_accou¡_exã¡
(&
å™s
, 
nodesize
,Çodesize, 
ﬁd_roŸs
,

370 
√w_roŸs
);

371 i‡(
ªt
) {

372 
	`ã°_îr
("couldn'àaccou¡ s∑˚ f‹á qgrou∞%d", 
ªt
);

373  
ªt
;

376 i‡(
	`båfs_vîify_qgroup_cou¡s
(
fs_öfo
, 
BTRFS_FS_TREE_OBJECTID
,

377 
nodesize
,Çodesize)) {

378 
	`ã°_îr
("qgroup counts didn't matchÉxpected values");

379  -
EINVAL
;

382 
ªt
 = 
	`båfs_föd_Æl_roŸs
(&
˘x
, 
Ál£
);

383 i‡(
ªt
) {

384 
	`ã°_îr
("couldn'àföd oldÑoŸs: %d", 
ªt
);

385  
ªt
;

387 
ﬁd_roŸs
 = 
˘x
.
roŸs
;

388 
˘x
.
roŸs
 = 
NULL
;

390 
ªt
 = 
	`add_åì_ªf
(
roŸ
, 
nodesize
,Çodesize, 0,

391 
BTRFS_FIRST_FREE_OBJECTID
);

392 i‡(
ªt
) {

393 
	`uli°_‰ì
(
ﬁd_roŸs
);

394  
ªt
;

397 
ªt
 = 
	`båfs_föd_Æl_roŸs
(&
˘x
, 
Ál£
);

398 i‡(
ªt
) {

399 
	`uli°_‰ì
(
ﬁd_roŸs
);

400 
	`ã°_îr
("couldn'àföd oldÑoŸs: %d", 
ªt
);

401  
ªt
;

403 
√w_roŸs
 = 
˘x
.
roŸs
;

404 
˘x
.
roŸs
 = 
NULL
;

406 
ªt
 = 
	`båfs_qgroup_accou¡_exã¡
(&
å™s
, 
nodesize
,Çodesize, 
ﬁd_roŸs
,

407 
√w_roŸs
);

408 i‡(
ªt
) {

409 
	`ã°_îr
("couldn'àaccou¡ s∑˚ f‹á qgrou∞%d", 
ªt
);

410  
ªt
;

413 i‡(
	`båfs_vîify_qgroup_cou¡s
(
fs_öfo
, 
BTRFS_FS_TREE_OBJECTID
,

414 
nodesize
, 0)) {

415 
	`ã°_îr
("qgroup counts didn't matchÉxpected values");

416  -
EINVAL
;

419 i‡(
	`båfs_vîify_qgroup_cou¡s
(
fs_öfo
, 
BTRFS_FIRST_FREE_OBJECTID
,

420 
nodesize
, 0)) {

421 
	`ã°_îr
("qgroup counts didn't matchÉxpected values");

422  -
EINVAL
;

425 
ªt
 = 
	`båfs_föd_Æl_roŸs
(&
˘x
, 
Ál£
);

426 i‡(
ªt
) {

427 
	`ã°_îr
("couldn'àföd oldÑoŸs: %d", 
ªt
);

428  
ªt
;

430 
ﬁd_roŸs
 = 
˘x
.
roŸs
;

431 
˘x
.
roŸs
 = 
NULL
;

433 
ªt
 = 
	`ªmove_exã¡_ªf
(
roŸ
, 
nodesize
,Çodesize, 0,

434 
BTRFS_FIRST_FREE_OBJECTID
);

435 i‡(
ªt
) {

436 
	`uli°_‰ì
(
ﬁd_roŸs
);

437  
ªt
;

440 
ªt
 = 
	`båfs_föd_Æl_roŸs
(&
˘x
, 
Ál£
);

441 i‡(
ªt
) {

442 
	`uli°_‰ì
(
ﬁd_roŸs
);

443 
	`ã°_îr
("couldn'àföd oldÑoŸs: %d", 
ªt
);

444  
ªt
;

446 
√w_roŸs
 = 
˘x
.
roŸs
;

447 
˘x
.
roŸs
 = 
NULL
;

449 
ªt
 = 
	`båfs_qgroup_accou¡_exã¡
(&
å™s
, 
nodesize
,Çodesize, 
ﬁd_roŸs
,

450 
√w_roŸs
);

451 i‡(
ªt
) {

452 
	`ã°_îr
("couldn'àaccou¡ s∑˚ f‹á qgrou∞%d", 
ªt
);

453  
ªt
;

456 i‡(
	`båfs_vîify_qgroup_cou¡s
(
fs_öfo
, 
BTRFS_FIRST_FREE_OBJECTID
,

458 
	`ã°_îr
("qgroup counts didn't matchÉxpected values");

459  -
EINVAL
;

462 i‡(
	`båfs_vîify_qgroup_cou¡s
(
fs_öfo
, 
BTRFS_FS_TREE_OBJECTID
,

463 
nodesize
,Çodesize)) {

464 
	`ã°_îr
("qgroup counts didn't matchÉxpected values");

465  -
EINVAL
;

469 
	}
}

471 
	$båfs_ã°_qgroups
(
u32
 
£˘‹size
, u32 
nodesize
)

473 
båfs_fs_öfo
 *
fs_öfo
 = 
NULL
;

474 
båfs_roŸ
 *
roŸ
;

475 
båfs_roŸ
 *
tmp_roŸ
;

476 
ªt
 = 0;

478 
fs_öfo
 = 
	`båfs_Æloc_dummy_fs_öfo
(
nodesize
, 
£˘‹size
);

479 i‡(!
fs_öfo
) {

480 
	`ã°_°d_îr
(
TEST_ALLOC_FS_INFO
);

481  -
ENOMEM
;

484 
roŸ
 = 
	`båfs_Æloc_dummy_roŸ
(
fs_öfo
);

485 i‡(
	`IS_ERR
(
roŸ
)) {

486 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

487 
ªt
 = 
	`PTR_ERR
(
roŸ
);

488 
out
;

492 
roŸ
->
roŸ_key
.
obje˘id
 = 
BTRFS_EXTENT_TREE_OBJECTID
;

493 
roŸ
->
roŸ_key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

494 
roŸ
->
roŸ_key
.
off£t
 = 0;

495 
	`båfs_globÆ_roŸ_ö£π
(
roŸ
);

501 
roŸ
->
fs_öfo
->
åì_roŸ
 =Ñoot;

502 
roŸ
->
fs_öfo
->
quŸa_roŸ
 =Ñoot;

503 
	`£t_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
);

509 
roŸ
->
node
 = 
	`Æloc_ã°_exã¡_buf„r
‘oŸ->
fs_öfo
, 
nodesize
);

510 i‡(
	`IS_ERR
(
roŸ
->
node
)) {

511 
	`ã°_îr
("couldn'tállocate dummy buffer");

512 
ªt
 = 
	`PTR_ERR
(
roŸ
->
node
);

513 
out
;

515 
	`båfs_£t_hódî_Àvñ
(
roŸ
->
node
, 0);

516 
	`båfs_£t_hódî_ƒôems
(
roŸ
->
node
, 0);

517 
roŸ
->
Æloc_byãƒ
 +2 * 
nodesize
;

519 
tmp_roŸ
 = 
	`båfs_Æloc_dummy_roŸ
(
fs_öfo
);

520 i‡(
	`IS_ERR
(
tmp_roŸ
)) {

521 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

522 
ªt
 = 
	`PTR_ERR
(
tmp_roŸ
);

523 
out
;

526 
tmp_roŸ
->
roŸ_key
.
obje˘id
 = 
BTRFS_FS_TREE_OBJECTID
;

527 
roŸ
->
fs_öfo
->
fs_roŸ
 = 
tmp_roŸ
;

528 
ªt
 = 
	`båfs_ö£π_fs_roŸ
(
roŸ
->
fs_öfo
, 
tmp_roŸ
);

529 i‡(
ªt
) {

530 
	`ã°_îr
("couldn'àö£π f†roŸ %d", 
ªt
);

531 
out
;

533 
	`båfs_put_roŸ
(
tmp_roŸ
);

535 
tmp_roŸ
 = 
	`båfs_Æloc_dummy_roŸ
(
fs_öfo
);

536 i‡(
	`IS_ERR
(
tmp_roŸ
)) {

537 
	`ã°_°d_îr
(
TEST_ALLOC_ROOT
);

538 
ªt
 = 
	`PTR_ERR
(
tmp_roŸ
);

539 
out
;

542 
tmp_roŸ
->
roŸ_key
.
obje˘id
 = 
BTRFS_FIRST_FREE_OBJECTID
;

543 
ªt
 = 
	`båfs_ö£π_fs_roŸ
(
roŸ
->
fs_öfo
, 
tmp_roŸ
);

544 i‡(
ªt
) {

545 
	`ã°_îr
("couldn'àö£π f†roŸ %d", 
ªt
);

546 
out
;

548 
	`båfs_put_roŸ
(
tmp_roŸ
);

550 
	`ã°_msg
("running qgroupÅests");

551 
ªt
 = 
	`ã°_no_sh¨ed_qgroup
(
roŸ
, 
£˘‹size
, 
nodesize
);

552 i‡(
ªt
)

553 
out
;

554 
ªt
 = 
	`ã°_mu…ùÀ_ªfs
(
roŸ
, 
£˘‹size
, 
nodesize
);

555 
out
:

556 
	`båfs_‰ì_dummy_roŸ
(
roŸ
);

557 
	`båfs_‰ì_dummy_fs_öfo
(
fs_öfo
);

558  
ªt
;

559 
	}
}

	@transaction.c

6 
	~<löux/fs.h
>

7 
	~<löux/¶ab.h
>

8 
	~<löux/sched.h
>

9 
	~<löux/sched/mm.h
>

10 
	~<löux/wrôeback.h
>

11 
	~<löux/∑gem≠.h
>

12 
	~<löux/blkdev.h
>

13 
	~<löux/uuid.h
>

14 
	~<löux/timekìpög.h
>

15 
	~"misc.h
"

16 
	~"˘ªe.h
"

17 
	~"disk-io.h
"

18 
	~"å™ß˘i⁄.h
"

19 
	~"lockög.h
"

20 
	~"åì-log.h
"

21 
	~"vﬁumes.h
"

22 
	~"dev-ª∂a˚.h
"

23 
	~"qgroup.h
"

24 
	~"block-group.h
"

25 
	~"•a˚-öfo.h
"

26 
	~"z⁄ed.h
"

27 
	~"fs.h
"

28 
	~"ac˚ss‹s.h
"

29 
	~"exã¡-åì.h
"

30 
	~"roŸ-åì.h
"

31 
	~"de‰ag.h
"

32 
	~"dú-ôem.h
"

33 
	~"uuid-åì.h
"

34 
	~"io˘l.h
"

35 
	~"ªloˇti⁄.h
"

36 
	~"s¸ub.h
"

38 
kmem_ˇche
 *
	gbåfs_å™s_h™dÀ_ˇchï
;

40 
	#BTRFS_ROOT_TRANS_TAG
 0

	)

118 c⁄° 
	gbåfs_blocked_å™s_ty≥s
[
TRANS_STATE_MAX
] = {

119 [
TRANS_STATE_RUNNING
] = 0U,

120 [
TRANS_STATE_COMMIT_PREP
] = 0U,

121 [
TRANS_STATE_COMMIT_START
] = (
__TRANS_START
 | 
__TRANS_ATTACH
),

122 [
TRANS_STATE_COMMIT_DOING
] = (
__TRANS_START
 |

123 
__TRANS_ATTACH
 |

124 
__TRANS_JOIN
 |

125 
__TRANS_JOIN_NOSTART
),

126 [
TRANS_STATE_UNBLOCKED
] = (
__TRANS_START
 |

127 
__TRANS_ATTACH
 |

128 
__TRANS_JOIN
 |

129 
__TRANS_JOIN_NOLOCK
 |

130 
__TRANS_JOIN_NOSTART
),

131 [
TRANS_STATE_SUPER_COMMITTED
] = (
__TRANS_START
 |

132 
__TRANS_ATTACH
 |

133 
__TRANS_JOIN
 |

134 
__TRANS_JOIN_NOLOCK
 |

135 
__TRANS_JOIN_NOSTART
),

136 [
TRANS_STATE_COMPLETED
] = (
__TRANS_START
 |

137 
__TRANS_ATTACH
 |

138 
__TRANS_JOIN
 |

139 
__TRANS_JOIN_NOLOCK
 |

140 
__TRANS_JOIN_NOSTART
),

143 
	$båfs_put_å™ß˘i⁄
(
båfs_å™ß˘i⁄
 *
å™ß˘i⁄
)

145 
	`WARN_ON
(
	`ªfcou¡_ªad
(&
å™ß˘i⁄
->
u£_cou¡
) == 0);

146 i‡(
	`ªfcou¡_dec_™d_ã°
(&
å™ß˘i⁄
->
u£_cou¡
)) {

147 
	`BUG_ON
(!
	`li°_em±y
(&
å™ß˘i⁄
->
li°
));

148 
	`WARN_ON
(!
	`RB_EMPTY_ROOT
(

149 &
å™ß˘i⁄
->
dñayed_ªfs
.
hªf_roŸ
.
rb_roŸ
));

150 
	`WARN_ON
(!
	`RB_EMPTY_ROOT
(

151 &
å™ß˘i⁄
->
dñayed_ªfs
.
dúty_exã¡_roŸ
));

152 i‡(
å™ß˘i⁄
->
dñayed_ªfs
.
≥ndög_csums
)

153 
	`båfs_îr
(
å™ß˘i⁄
->
fs_öfo
,

155 
å™ß˘i⁄
->
dñayed_ªfs
.
≥ndög_csums
);

163 !
	`li°_em±y
(&
å™ß˘i⁄
->
dñëed_bgs
)) {

164 
båfs_block_group
 *
ˇche
;

166 
ˇche
 = 
	`li°_fú°_íåy
(&
å™ß˘i⁄
->
dñëed_bgs
,

167 
båfs_block_group
,

168 
bg_li°
);

169 
	`li°_dñ_öô
(&
ˇche
->
bg_li°
);

170 
	`båfs_un‰ìze_block_group
(
ˇche
);

171 
	`båfs_put_block_group
(
ˇche
);

173 
	`WARN_ON
(!
	`li°_em±y
(&
å™ß˘i⁄
->
dev_upd©e_li°
));

174 
	`k‰ì
(
å™ß˘i⁄
);

176 
	}
}

178 
noölöe
 
	$swôch_commô_roŸs
(
båfs_å™s_h™dÀ
 *
å™s
)

180 
båfs_å™ß˘i⁄
 *
cur_å™s
 = 
å™s
->
å™ß˘i⁄
;

181 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

182 
båfs_roŸ
 *
roŸ
, *
tmp
;

188 
	`ASSERT
(
cur_å™s
->
°©e
 =
TRANS_STATE_COMMIT_DOING
);

190 
	`down_wrôe
(&
fs_öfo
->
commô_roŸ_£m
);

192 i‡(
	`ã°_bô
(
BTRFS_FS_RELOC_RUNNING
, &
fs_öfo
->
Êags
))

193 
fs_öfo
->
œ°_ªloc_å™s
 = 
å™s
->
å™sid
;

195 
	`li°_f‹_óch_íåy_ß„
(
roŸ
, 
tmp
, &
cur_å™s
->
swôch_commôs
,

196 
dúty_li°
) {

197 
	`li°_dñ_öô
(&
roŸ
->
dúty_li°
);

198 
	`‰ì_exã¡_buf„r
(
roŸ
->
commô_roŸ
);

199 
roŸ
->
commô_roŸ
 = 
	`båfs_roŸ_node
(root);

200 
	`exã¡_io_åì_ªÀa£
(&
roŸ
->
dúty_log_∑ges
);

201 
	`båfs_qgroup_˛ón_sw≠≥d_blocks
(
roŸ
);

205 
	`•ö_lock
(&
cur_å™s
->
dr›≥d_roŸs_lock
);

206 !
	`li°_em±y
(&
cur_å™s
->
dr›≥d_roŸs
)) {

207 
roŸ
 = 
	`li°_fú°_íåy
(&
cur_å™s
->
dr›≥d_roŸs
,

208 
båfs_roŸ
, 
roŸ_li°
);

209 
	`li°_dñ_öô
(&
roŸ
->
roŸ_li°
);

210 
	`•ö_u∆ock
(&
cur_å™s
->
dr›≥d_roŸs_lock
);

211 
	`båfs_‰ì_log
(
å™s
, 
roŸ
);

212 
	`båfs_dr›_™d_‰ì_fs_roŸ
(
fs_öfo
, 
roŸ
);

213 
	`•ö_lock
(&
cur_å™s
->
dr›≥d_roŸs_lock
);

215 
	`•ö_u∆ock
(&
cur_å™s
->
dr›≥d_roŸs_lock
);

217 
	`up_wrôe
(&
fs_öfo
->
commô_roŸ_£m
);

218 
	}
}

220 
ölöe
 
	$extwrôî_cou¡î_öc
(
båfs_å™ß˘i⁄
 *
å™s
,

221 
ty≥
)

223 i‡(
ty≥
 & 
TRANS_EXTWRITERS
)

224 
	`©omic_öc
(&
å™s
->
num_extwrôîs
);

225 
	}
}

227 
ölöe
 
	$extwrôî_cou¡î_dec
(
båfs_å™ß˘i⁄
 *
å™s
,

228 
ty≥
)

230 i‡(
ty≥
 & 
TRANS_EXTWRITERS
)

231 
	`©omic_dec
(&
å™s
->
num_extwrôîs
);

232 
	}
}

234 
ölöe
 
	$extwrôî_cou¡î_öô
(
båfs_å™ß˘i⁄
 *
å™s
,

235 
ty≥
)

237 
	`©omic_£t
(&
å™s
->
num_extwrôîs
, ((
ty≥
 & 
TRANS_EXTWRITERS
) ? 1 : 0));

238 
	}
}

240 
ölöe
 
	$extwrôî_cou¡î_ªad
(
båfs_å™ß˘i⁄
 *
å™s
)

242  
	`©omic_ªad
(&
å™s
->
num_extwrôîs
);

243 
	}
}

252 
	$båfs_å™s_ªÀa£_chunk_mëad©a
(
båfs_å™s_h™dÀ
 *
å™s
)

254 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

256 i‡(!
å™s
->
chunk_byãs_ª£rved
)

259 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, &fs_öfo->
chunk_block_rsv
,

260 
å™s
->
chunk_byãs_ª£rved
, 
NULL
);

261 
å™s
->
chunk_byãs_ª£rved
 = 0;

262 
	}
}

267 
noölöe
 
	$joö_å™ß˘i⁄
(
båfs_fs_öfo
 *
fs_öfo
,

268 
ty≥
)

270 
båfs_å™ß˘i⁄
 *
cur_å™s
;

272 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

273 
lo›
:

275 i‡(
	`BTRFS_FS_ERROR
(
fs_öfo
)) {

276 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

277  -
EROFS
;

280 
cur_å™s
 = 
fs_öfo
->
ru¬ög_å™ß˘i⁄
;

281 i‡(
cur_å™s
) {

282 i‡(
	`TRANS_ABORTED
(
cur_å™s
)) {

283 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

284  
cur_å™s
->
ab‹ãd
;

286 i‡(
båfs_blocked_å™s_ty≥s
[
cur_å™s
->
°©e
] & 
ty≥
) {

287 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

288  -
EBUSY
;

290 
	`ªfcou¡_öc
(&
cur_å™s
->
u£_cou¡
);

291 
	`©omic_öc
(&
cur_å™s
->
num_wrôîs
);

292 
	`extwrôî_cou¡î_öc
(
cur_å™s
, 
ty≥
);

293 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

294 
	`båfs_lockdï_acquúe
(
fs_öfo
, 
båfs_å™s_num_wrôîs
);

295 
	`båfs_lockdï_acquúe
(
fs_öfo
, 
båfs_å™s_num_extwrôîs
);

298 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

305 i‡(
ty≥
 =
TRANS_ATTACH
 ||Åy≥ =
TRANS_JOIN_NOSTART
)

306  -
ENOENT
;

312 
	`BUG_ON
(
ty≥
 =
TRANS_JOIN_NOLOCK
);

314 
cur_å™s
 = 
	`kmÆloc
((*cur_å™s), 
GFP_NOFS
);

315 i‡(!
cur_å™s
)

316  -
ENOMEM
;

318 
	`båfs_lockdï_acquúe
(
fs_öfo
, 
båfs_å™s_num_wrôîs
);

319 
	`båfs_lockdï_acquúe
(
fs_öfo
, 
båfs_å™s_num_extwrôîs
);

321 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

322 i‡(
fs_öfo
->
ru¬ög_å™ß˘i⁄
) {

327 
	`båfs_lockdï_ªÀa£
(
fs_öfo
, 
båfs_å™s_num_extwrôîs
);

328 
	`båfs_lockdï_ªÀa£
(
fs_öfo
, 
båfs_å™s_num_wrôîs
);

329 
	`k‰ì
(
cur_å™s
);

330 
lo›
;

331 } i‡(
	`BTRFS_FS_ERROR
(
fs_öfo
)) {

332 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

333 
	`båfs_lockdï_ªÀa£
(
fs_öfo
, 
båfs_å™s_num_extwrôîs
);

334 
	`båfs_lockdï_ªÀa£
(
fs_öfo
, 
båfs_å™s_num_wrôîs
);

335 
	`k‰ì
(
cur_å™s
);

336  -
EROFS
;

339 
cur_å™s
->
fs_öfo
 = fs_info;

340 
	`©omic_£t
(&
cur_å™s
->
≥ndög_‹dîed
, 0);

341 
	`öô_waôqueue_hód
(&
cur_å™s
->
≥ndög_waô
);

342 
	`©omic_£t
(&
cur_å™s
->
num_wrôîs
, 1);

343 
	`extwrôî_cou¡î_öô
(
cur_å™s
, 
ty≥
);

344 
	`öô_waôqueue_hód
(&
cur_å™s
->
wrôî_waô
);

345 
	`öô_waôqueue_hód
(&
cur_å™s
->
commô_waô
);

346 
cur_å™s
->
°©e
 = 
TRANS_STATE_RUNNING
;

351 
	`ªfcou¡_£t
(&
cur_å™s
->
u£_cou¡
, 2);

352 
cur_å™s
->
Êags
 = 0;

353 
cur_å™s
->
°¨t_time
 = 
	`ktime_gë_£c⁄ds
();

355 
	`mem£t
(&
cur_å™s
->
dñayed_ªfs
, 0, (cur_trans->delayed_refs));

357 
cur_å™s
->
dñayed_ªfs
.
hªf_roŸ
 = 
RB_ROOT_CACHED
;

358 
cur_å™s
->
dñayed_ªfs
.
dúty_exã¡_roŸ
 = 
RB_ROOT
;

359 
	`©omic_£t
(&
cur_å™s
->
dñayed_ªfs
.
num_íåõs
, 0);

365 
	`smp_mb
();

366 i‡(!
	`li°_em±y
(&
fs_öfo
->
åì_mod_£q_li°
))

367 
	`WARN
(1, 
KERN_ERR
 "BTRFS:Åree_mod_seq_listÇotÉmpty when creatingá freshÅransaction\n");

368 i‡(!
	`RB_EMPTY_ROOT
(&
fs_öfo
->
åì_mod_log
))

369 
	`WARN
(1, 
KERN_ERR
 "BTRFS:Åree_mod_logÑbÅreeÇotÉmpty when creatingá freshÅransaction\n");

370 
	`©omic64_£t
(&
fs_öfo
->
åì_mod_£q
, 0);

372 
	`•ö_lock_öô
(&
cur_å™s
->
dñayed_ªfs
.
lock
);

374 
	`INIT_LIST_HEAD
(&
cur_å™s
->
≥ndög_¢≠shŸs
);

375 
	`INIT_LIST_HEAD
(&
cur_å™s
->
dev_upd©e_li°
);

376 
	`INIT_LIST_HEAD
(&
cur_å™s
->
swôch_commôs
);

377 
	`INIT_LIST_HEAD
(&
cur_å™s
->
dúty_bgs
);

378 
	`INIT_LIST_HEAD
(&
cur_å™s
->
io_bgs
);

379 
	`INIT_LIST_HEAD
(&
cur_å™s
->
dr›≥d_roŸs
);

380 
	`muãx_öô
(&
cur_å™s
->
ˇche_wrôe_muãx
);

381 
	`•ö_lock_öô
(&
cur_å™s
->
dúty_bgs_lock
);

382 
	`INIT_LIST_HEAD
(&
cur_å™s
->
dñëed_bgs
);

383 
	`•ö_lock_öô
(&
cur_å™s
->
dr›≥d_roŸs_lock
);

384 
	`li°_add_èû
(&
cur_å™s
->
li°
, &
fs_öfo
->
å™s_li°
);

385 
	`exã¡_io_åì_öô
(
fs_öfo
, &
cur_å™s
->
dúty_∑ges
,

386 
IO_TREE_TRANS_DIRTY_PAGES
);

387 
	`exã¡_io_åì_öô
(
fs_öfo
, &
cur_å™s
->
pö√d_exã¡s
,

388 
IO_TREE_FS_PINNED_EXTENTS
);

389 
fs_öfo
->
gíî©i⁄
++;

390 
cur_å™s
->
å™sid
 = 
fs_öfo
->
gíî©i⁄
;

391 
fs_öfo
->
ru¬ög_å™ß˘i⁄
 = 
cur_å™s
;

392 
cur_å™s
->
ab‹ãd
 = 0;

393 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

396 
	}
}

404 
	$ªc‹d_roŸ_ö_å™s
(
båfs_å™s_h™dÀ
 *
å™s
,

405 
båfs_roŸ
 *
roŸ
,

406 
f‹˚
)

408 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

409 
ªt
 = 0;

411 i‡((
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
) &&

412 
roŸ
->
œ°_å™s
 < 
å™s
->
å™sid
Ë|| 
f‹˚
) {

413 
	`WARN_ON
(!
f‹˚
 && 
roŸ
->
commô_roŸ
 !roŸ->
node
);

420 
	`£t_bô
(
BTRFS_ROOT_IN_TRANS_SETUP
, &
roŸ
->
°©e
);

425 
	`smp_wmb
();

427 
	`•ö_lock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

428 i‡(
roŸ
->
œ°_å™s
 =
å™s
->
å™sid
 && !
f‹˚
) {

429 
	`•ö_u∆ock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

432 
	`ødix_åì_èg_£t
(&
fs_öfo
->
fs_roŸs_ødix
,

433 ()
roŸ
->
roŸ_key
.
obje˘id
,

434 
BTRFS_ROOT_TRANS_TAG
);

435 
	`•ö_u∆ock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

436 
roŸ
->
œ°_å™s
 = 
å™s
->
å™sid
;

457 
ªt
 = 
	`båfs_öô_ªloc_roŸ
(
å™s
, 
roŸ
);

458 
	`smp_mb__bef‹e_©omic
();

459 
	`˛ór_bô
(
BTRFS_ROOT_IN_TRANS_SETUP
, &
roŸ
->
°©e
);

461  
ªt
;

462 
	}
}

465 
	$båfs_add_dr›≥d_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

466 
båfs_roŸ
 *
roŸ
)

468 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

469 
båfs_å™ß˘i⁄
 *
cur_å™s
 = 
å™s
->
å™ß˘i⁄
;

472 
	`•ö_lock
(&
cur_å™s
->
dr›≥d_roŸs_lock
);

473 
	`li°_add_èû
(&
roŸ
->
roŸ_li°
, &
cur_å™s
->
dr›≥d_roŸs
);

474 
	`•ö_u∆ock
(&
cur_å™s
->
dr›≥d_roŸs_lock
);

477 
	`•ö_lock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

478 
	`ødix_åì_èg_˛ór
(&
fs_öfo
->
fs_roŸs_ødix
,

479 ()
roŸ
->
roŸ_key
.
obje˘id
,

480 
BTRFS_ROOT_TRANS_TAG
);

481 
	`•ö_u∆ock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

482 
	}
}

484 
	$båfs_ªc‹d_roŸ_ö_å™s
(
båfs_å™s_h™dÀ
 *
å™s
,

485 
båfs_roŸ
 *
roŸ
)

487 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

488 
ªt
;

490 i‡(!
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
))

497 
	`smp_rmb
();

498 i‡(
roŸ
->
œ°_å™s
 =
å™s
->
å™sid
 &&

499 !
	`ã°_bô
(
BTRFS_ROOT_IN_TRANS_SETUP
, &
roŸ
->
°©e
))

502 
	`muãx_lock
(&
fs_öfo
->
ªloc_muãx
);

503 
ªt
 = 
	`ªc‹d_roŸ_ö_å™s
(
å™s
, 
roŸ
, 0);

504 
	`muãx_u∆ock
(&
fs_öfo
->
ªloc_muãx
);

506  
ªt
;

507 
	}
}

509 
ölöe
 
	$is_å™ß˘i⁄_blocked
(
båfs_å™ß˘i⁄
 *
å™s
)

511  (
å™s
->
°©e
 >
TRANS_STATE_COMMIT_START
 &&

512 
å™s
->
°©e
 < 
TRANS_STATE_UNBLOCKED
 &&

513 !
	`TRANS_ABORTED
(
å™s
));

514 
	}
}

520 
	$waô_cuºít_å™s
(
båfs_fs_öfo
 *
fs_öfo
)

522 
båfs_å™ß˘i⁄
 *
cur_å™s
;

524 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

525 
cur_å™s
 = 
fs_öfo
->
ru¬ög_å™ß˘i⁄
;

526 i‡(
cur_å™s
 && 
	`is_å™ß˘i⁄_blocked
(cur_trans)) {

527 
	`ªfcou¡_öc
(&
cur_å™s
->
u£_cou¡
);

528 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

530 
	`båfs_might_waô_f‹_°©e
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_UNBLOCKED
);

531 
	`waô_evít
(
fs_öfo
->
å™ß˘i⁄_waô
,

532 
cur_å™s
->
°©e
 >
TRANS_STATE_UNBLOCKED
 ||

533 
	`TRANS_ABORTED
(
cur_å™s
));

534 
	`båfs_put_å™ß˘i⁄
(
cur_å™s
);

536 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

538 
	}
}

540 
	$may_waô_å™ß˘i⁄
(
båfs_fs_öfo
 *
fs_öfo
, 
ty≥
)

542 i‡(
	`ã°_bô
(
BTRFS_FS_LOG_RECOVERING
, &
fs_öfo
->
Êags
))

545 i‡(
ty≥
 =
TRANS_START
)

549 
	}
}

551 
ölöe
 
boﬁ
 
	$√ed_ª£rve_ªloc_roŸ
(
båfs_roŸ
 *
roŸ
)

553 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

555 i‡(!
fs_öfo
->
ªloc_˘l
 ||

556 !
	`ã°_bô
(
BTRFS_ROOT_SHAREABLE
, &
roŸ
->
°©e
) ||

557 
roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
 ||

558 
roŸ
->
ªloc_roŸ
)

559  
Ál£
;

561  
åue
;

562 
	}
}

564 
båfs_å™s_h™dÀ
 *

565 
	$°¨t_å™ß˘i⁄
(
båfs_roŸ
 *
roŸ
, 
num_ôems
,

566 
ty≥
, 
båfs_ª£rve_Êush_íum
 
Êush
,

567 
boﬁ
 
íf‹˚_qgroups
)

569 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

570 
båfs_block_rsv
 *
dñayed_ªfs_rsv
 = &
fs_öfo
->delayed_refs_rsv;

571 
båfs_å™s_h™dÀ
 *
h
;

572 
båfs_å™ß˘i⁄
 *
cur_å™s
;

573 
u64
 
num_byãs
 = 0;

574 
u64
 
qgroup_ª£rved
 = 0;

575 
boﬁ
 
ªloc_ª£rved
 = 
Ál£
;

576 
boﬁ
 
do_chunk_Æloc
 = 
Ál£
;

577 
ªt
;

579 i‡(
	`BTRFS_FS_ERROR
(
fs_öfo
))

580  
	`ERR_PTR
(-
EROFS
);

582 i‡(
cuºít
->
jou∫Æ_öfo
) {

583 
	`WARN_ON
(
ty≥
 & 
TRANS_EXTWRITERS
);

584 
h
 = 
cuºít
->
jou∫Æ_öfo
;

585 
	`ªfcou¡_öc
(&
h
->
u£_cou¡
);

586 
	`WARN_ON
(
	`ªfcou¡_ªad
(&
h
->
u£_cou¡
) > 2);

587 
h
->
‹ig_rsv
 = h->
block_rsv
;

588 
h
->
block_rsv
 = 
NULL
;

589 
gŸ_ô
;

596 i‡(
num_ôems
 && 
roŸ
 !
fs_öfo
->
chunk_roŸ
) {

597 
båfs_block_rsv
 *
rsv
 = &
fs_öfo
->
å™s_block_rsv
;

598 
u64
 
dñayed_ªfs_byãs
 = 0;

600 
qgroup_ª£rved
 = 
num_ôems
 * 
fs_öfo
->
nodesize
;

606 
ªt
 = 
	`båfs_qgroup_ª£rve_mëa_¥óŒoc
(
roŸ
, 
qgroup_ª£rved
,

607 
íf‹˚_qgroups
, 
Ál£
);

608 i‡(
ªt
)

609  
	`ERR_PTR
(
ªt
);

618 
num_byãs
 = 
	`båfs_ˇlc_ö£π_mëad©a_size
(
fs_öfo
, 
num_ôems
);

619 i‡(
Êush
 =
BTRFS_RESERVE_FLUSH_ALL
 &&

620 !
	`båfs_block_rsv_fuŒ
(
dñayed_ªfs_rsv
)) {

621 
dñayed_ªfs_byãs
 = 
	`båfs_ˇlc_dñayed_ªf_byãs
(
fs_öfo
,

622 
num_ôems
);

623 
num_byãs
 +
dñayed_ªfs_byãs
;

629 i‡(
	`√ed_ª£rve_ªloc_roŸ
(
roŸ
)) {

630 
num_byãs
 +
fs_öfo
->
nodesize
;

631 
ªloc_ª£rved
 = 
åue
;

634 
ªt
 = 
	`båfs_ª£rve_mëad©a_byãs
(
fs_öfo
, 
rsv
, 
num_byãs
, 
Êush
);

635 i‡(
ªt
)

636 
ª£rve_Áû
;

637 i‡(
dñayed_ªfs_byãs
) {

638 
	`båfs_migøã_to_dñayed_ªfs_rsv
(
fs_öfo
, 
dñayed_ªfs_byãs
);

639 
num_byãs
 -
dñayed_ªfs_byãs
;

641 
	`båfs_block_rsv_add_byãs
(
rsv
, 
num_byãs
, 
åue
);

643 i‡(
rsv
->
•a˚_öfo
->
f‹˚_Æloc
)

644 
do_chunk_Æloc
 = 
åue
;

645 } i‡(
num_ôems
 =0 && 
Êush
 =
BTRFS_RESERVE_FLUSH_ALL
 &&

646 !
	`båfs_block_rsv_fuŒ
(
dñayed_ªfs_rsv
)) {

654 
ªt
 = 
	`båfs_dñayed_ªfs_rsv_ªfûl
(
fs_öfo
, 
Êush
);

655 i‡(
ªt
)

656 
ª£rve_Áû
;

658 
agaö
:

659 
h
 = 
	`kmem_ˇche_zÆloc
(
båfs_å™s_h™dÀ_ˇchï
, 
GFP_NOFS
);

660 i‡(!
h
) {

661 
ªt
 = -
ENOMEM
;

662 
Æloc_Áû
;

675 i‡(
ty≥
 & 
__TRANS_FREEZABLE
)

676 
	`sb_°¨t_ötwrôe
(
fs_öfo
->
sb
);

678 i‡(
	`may_waô_å™ß˘i⁄
(
fs_öfo
, 
ty≥
))

679 
	`waô_cuºít_å™s
(
fs_öfo
);

682 
ªt
 = 
	`joö_å™ß˘i⁄
(
fs_öfo
, 
ty≥
);

683 i‡(
ªt
 =-
EBUSY
) {

684 
	`waô_cuºít_å™s
(
fs_öfo
);

685 i‡(
	`u∆ikñy
(
ty≥
 =
TRANS_ATTACH
 ||

686 
ty≥
 =
TRANS_JOIN_NOSTART
))

687 
ªt
 = -
ENOENT
;

689 } 
ªt
 =-
EBUSY
);

691 i‡(
ªt
 < 0)

692 
joö_Áû
;

694 
cur_å™s
 = 
fs_öfo
->
ru¬ög_å™ß˘i⁄
;

696 
h
->
å™sid
 = 
cur_å™s
->transid;

697 
h
->
å™ß˘i⁄
 = 
cur_å™s
;

698 
	`ªfcou¡_£t
(&
h
->
u£_cou¡
, 1);

699 
h
->
fs_öfo
 = 
roŸ
->fs_info;

701 
h
->
ty≥
 =Åype;

702 
	`INIT_LIST_HEAD
(&
h
->
√w_bgs
);

704 
	`smp_mb
();

705 i‡(
cur_å™s
->
°©e
 >
TRANS_STATE_COMMIT_START
 &&

706 
	`may_waô_å™ß˘i⁄
(
fs_öfo
, 
ty≥
)) {

707 
cuºít
->
jou∫Æ_öfo
 = 
h
;

708 
	`båfs_commô_å™ß˘i⁄
(
h
);

709 
agaö
;

712 i‡(
num_byãs
) {

713 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, "transaction",

714 
h
->
å™sid
, 
num_byãs
, 1);

715 
h
->
block_rsv
 = &
fs_öfo
->
å™s_block_rsv
;

716 
h
->
byãs_ª£rved
 = 
num_byãs
;

717 
h
->
ªloc_ª£rved
 =Ñeloc_reserved;

725 i‡(
qgroup_ª£rved
)

726 
	`båfs_qgroup_c⁄vît_ª£rved_mëa
(
roŸ
, 
qgroup_ª£rved
);

728 
gŸ_ô
:

729 i‡(!
cuºít
->
jou∫Æ_öfo
)

730 
cuºít
->
jou∫Æ_öfo
 = 
h
;

738 i‡(
do_chunk_Æloc
 && 
num_byãs
) {

739 
u64
 
Êags
 = 
h
->
block_rsv
->
•a˚_öfo
->flags;

741 
	`båfs_chunk_Æloc
(
h
, 
	`båfs_gë_Æloc_¥ofûe
(
fs_öfo
, 
Êags
),

742 
CHUNK_ALLOC_NO_FORCE
);

753 
ªt
 = 
	`båfs_ªc‹d_roŸ_ö_å™s
(
h
, 
roŸ
);

754 i‡(
ªt
) {

760 
	`båfs_íd_å™ß˘i⁄
(
h
);

761  
	`ERR_PTR
(
ªt
);

764  
h
;

766 
joö_Áû
:

767 i‡(
ty≥
 & 
__TRANS_FREEZABLE
)

768 
	`sb_íd_ötwrôe
(
fs_öfo
->
sb
);

769 
	`kmem_ˇche_‰ì
(
båfs_å™s_h™dÀ_ˇchï
, 
h
);

770 
Æloc_Áû
:

771 i‡(
num_byãs
)

772 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, &fs_öfo->
å™s_block_rsv
,

773 
num_byãs
, 
NULL
);

774 
ª£rve_Áû
:

775 
	`båfs_qgroup_‰ì_mëa_¥óŒoc
(
roŸ
, 
qgroup_ª£rved
);

776  
	`ERR_PTR
(
ªt
);

777 
	}
}

779 
båfs_å™s_h™dÀ
 *
	$båfs_°¨t_å™ß˘i⁄
(
båfs_roŸ
 *
roŸ
,

780 
num_ôems
)

782  
	`°¨t_å™ß˘i⁄
(
roŸ
, 
num_ôems
, 
TRANS_START
,

783 
BTRFS_RESERVE_FLUSH_ALL
, 
åue
);

784 
	}
}

786 
båfs_å™s_h™dÀ
 *
	$båfs_°¨t_å™ß˘i⁄_ÁŒback_globÆ_rsv
(

787 
båfs_roŸ
 *
roŸ
,

788 
num_ôems
)

790  
	`°¨t_å™ß˘i⁄
(
roŸ
, 
num_ôems
, 
TRANS_START
,

791 
BTRFS_RESERVE_FLUSH_ALL_STEAL
, 
Ál£
);

792 
	}
}

794 
båfs_å™s_h™dÀ
 *
	$båfs_joö_å™ß˘i⁄
(
båfs_roŸ
 *
roŸ
)

796  
	`°¨t_å™ß˘i⁄
(
roŸ
, 0, 
TRANS_JOIN
, 
BTRFS_RESERVE_NO_FLUSH
,

797 
åue
);

798 
	}
}

800 
båfs_å™s_h™dÀ
 *
	$båfs_joö_å™ß˘i⁄_•a˚ˇche
(
båfs_roŸ
 *
roŸ
)

802  
	`°¨t_å™ß˘i⁄
(
roŸ
, 0, 
TRANS_JOIN_NOLOCK
,

803 
BTRFS_RESERVE_NO_FLUSH
, 
åue
);

804 
	}
}

813 
båfs_å™s_h™dÀ
 *
	$båfs_joö_å™ß˘i⁄_no°¨t
(
båfs_roŸ
 *
roŸ
)

815  
	`°¨t_å™ß˘i⁄
(
roŸ
, 0, 
TRANS_JOIN_NOSTART
,

816 
BTRFS_RESERVE_NO_FLUSH
, 
åue
);

817 
	}
}

832 
båfs_å™s_h™dÀ
 *
	$båfs_©èch_å™ß˘i⁄
(
båfs_roŸ
 *
roŸ
)

834  
	`°¨t_å™ß˘i⁄
(
roŸ
, 0, 
TRANS_ATTACH
,

835 
BTRFS_RESERVE_NO_FLUSH
, 
åue
);

836 
	}
}

845 
båfs_å™s_h™dÀ
 *

846 
	$båfs_©èch_å™ß˘i⁄_b¨rõr
(
båfs_roŸ
 *
roŸ
)

848 
båfs_å™s_h™dÀ
 *
å™s
;

850 
å™s
 = 
	`°¨t_å™ß˘i⁄
(
roŸ
, 0, 
TRANS_ATTACH
,

851 
BTRFS_RESERVE_NO_FLUSH
, 
åue
);

852 i‡(
å™s
 =
	`ERR_PTR
(-
ENOENT
)) {

853 
ªt
;

855 
ªt
 = 
	`båfs_waô_f‹_commô
(
roŸ
->
fs_öfo
, 0);

856 i‡(
ªt
)

857  
	`ERR_PTR
(
ªt
);

860  
å™s
;

861 
	}
}

864 
noölöe
 
	$waô_f‹_commô
(
båfs_å™ß˘i⁄
 *
commô
,

865 c⁄° 
båfs_å™s_°©e
 
mö_°©e
)

867 
båfs_fs_öfo
 *
fs_öfo
 = 
commô
->fs_info;

868 
u64
 
å™sid
 = 
commô
->transid;

869 
boﬁ
 
put
 = 
Ál£
;

875 i‡(
mö_°©e
 =
TRANS_STATE_COMPLETED
)

876 
	`båfs_might_waô_f‹_°©e
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_COMPLETED
);

878 
	`båfs_might_waô_f‹_°©e
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_SUPER_COMMITTED
);

881 
	`waô_evít
(
commô
->
commô_waô
, commô->
°©e
 >
mö_°©e
);

882 i‡(
put
)

883 
	`båfs_put_å™ß˘i⁄
(
commô
);

885 i‡(
mö_°©e
 < 
TRANS_STATE_COMPLETED
)

895 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

896 
commô
 = 
	`li°_fú°_íåy_‹_nuŒ
(&
fs_öfo
->
å™s_li°
,

897 
båfs_å™ß˘i⁄
,

898 
li°
);

899 i‡(!
commô
 || commô->
å™sid
 >Åransid) {

900 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

903 
	`ªfcou¡_öc
(&
commô
->
u£_cou¡
);

904 
put
 = 
åue
;

905 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

907 
	}
}

909 
	$båfs_waô_f‹_commô
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
å™sid
)

911 
båfs_å™ß˘i⁄
 *
cur_å™s
 = 
NULL
, *
t
;

912 
ªt
 = 0;

914 i‡(
å™sid
) {

915 i‡(
å™sid
 <
fs_öfo
->
œ°_å™s_commôãd
)

916 
out
;

919 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

920 
	`li°_f‹_óch_íåy
(
t
, &
fs_öfo
->
å™s_li°
, 
li°
) {

921 i‡(
t
->
å™sid
 ==Åransid) {

922 
cur_å™s
 = 
t
;

923 
	`ªfcou¡_öc
(&
cur_å™s
->
u£_cou¡
);

924 
ªt
 = 0;

927 i‡(
t
->
å™sid
 >Åransid) {

928 
ªt
 = 0;

932 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

938 i‡(!
cur_å™s
) {

939 i‡(
å™sid
 > 
fs_öfo
->
œ°_å™s_commôãd
)

940 
ªt
 = -
EINVAL
;

941 
out
;

945 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

946 
	`li°_f‹_óch_íåy_ªvî£
(
t
, &
fs_öfo
->
å™s_li°
,

947 
li°
) {

948 i‡(
t
->
°©e
 >
TRANS_STATE_COMMIT_START
) {

949 i‡(
t
->
°©e
 =
TRANS_STATE_COMPLETED
)

951 
cur_å™s
 = 
t
;

952 
	`ªfcou¡_öc
(&
cur_å™s
->
u£_cou¡
);

956 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

957 i‡(!
cur_å™s
)

958 
out
;

961 
	`waô_f‹_commô
(
cur_å™s
, 
TRANS_STATE_COMPLETED
);

962 
ªt
 = 
cur_å™s
->
ab‹ãd
;

963 
	`båfs_put_å™ß˘i⁄
(
cur_å™s
);

964 
out
:

965  
ªt
;

966 
	}
}

968 
	$båfs_thrŸée
(
båfs_fs_öfo
 *
fs_öfo
)

970 
	`waô_cuºít_å™s
(
fs_öfo
);

971 
	}
}

973 
boﬁ
 
	$båfs_should_íd_å™ß˘i⁄
(
båfs_å™s_h™dÀ
 *
å™s
)

975 
båfs_å™ß˘i⁄
 *
cur_å™s
 = 
å™s
->
å™ß˘i⁄
;

977 i‡(
cur_å™s
->
°©e
 >
TRANS_STATE_COMMIT_START
 ||

978 
	`ã°_bô
(
BTRFS_DELAYED_REFS_FLUSHING
, &
cur_å™s
->
dñayed_ªfs
.
Êags
))

979  
åue
;

981 i‡(
	`båfs_check_•a˚_f‹_dñayed_ªfs
(
å™s
->
fs_öfo
))

982  
åue
;

984  !!
	`båfs_block_rsv_check
(&
å™s
->
fs_öfo
->
globÆ_block_rsv
, 50);

985 
	}
}

987 
	$båfs_å™s_ªÀa£_mëad©a
(
båfs_å™s_h™dÀ
 *
å™s
)

990 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

992 i‡(!
å™s
->
block_rsv
) {

993 
	`ASSERT
(!
å™s
->
byãs_ª£rved
);

997 i‡(!
å™s
->
byãs_ª£rved
)

1000 
	`ASSERT
(
å™s
->
block_rsv
 =&
fs_öfo
->
å™s_block_rsv
);

1001 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, "transaction",

1002 
å™s
->
å™sid
,Åøns->
byãs_ª£rved
, 0);

1003 
	`båfs_block_rsv_ªÀa£
(
fs_öfo
, 
å™s
->
block_rsv
,

1004 
å™s
->
byãs_ª£rved
, 
NULL
);

1005 
å™s
->
byãs_ª£rved
 = 0;

1006 
	}
}

1008 
	$__båfs_íd_å™ß˘i⁄
(
båfs_å™s_h™dÀ
 *
å™s
,

1009 
thrŸée
)

1011 
båfs_fs_öfo
 *
öfo
 = 
å™s
->
fs_öfo
;

1012 
båfs_å™ß˘i⁄
 *
cur_å™s
 = 
å™s
->
å™ß˘i⁄
;

1013 
îr
 = 0;

1015 i‡(
	`ªfcou¡_ªad
(&
å™s
->
u£_cou¡
) > 1) {

1016 
	`ªfcou¡_dec
(&
å™s
->
u£_cou¡
);

1017 
å™s
->
block_rsv
 =Åøns->
‹ig_rsv
;

1021 
	`båfs_å™s_ªÀa£_mëad©a
(
å™s
);

1022 
å™s
->
block_rsv
 = 
NULL
;

1024 
	`båfs_¸óã_≥ndög_block_groups
(
å™s
);

1026 
	`båfs_å™s_ªÀa£_chunk_mëad©a
(
å™s
);

1028 i‡(
å™s
->
ty≥
 & 
__TRANS_FREEZABLE
)

1029 
	`sb_íd_ötwrôe
(
öfo
->
sb
);

1031 
	`WARN_ON
(
cur_å™s
 !
öfo
->
ru¬ög_å™ß˘i⁄
);

1032 
	`WARN_ON
(
	`©omic_ªad
(&
cur_å™s
->
num_wrôîs
) < 1);

1033 
	`©omic_dec
(&
cur_å™s
->
num_wrôîs
);

1034 
	`extwrôî_cou¡î_dec
(
cur_å™s
, 
å™s
->
ty≥
);

1036 
	`c⁄d_wake_up
(&
cur_å™s
->
wrôî_waô
);

1038 
	`båfs_lockdï_ªÀa£
(
öfo
, 
båfs_å™s_num_extwrôîs
);

1039 
	`båfs_lockdï_ªÀa£
(
öfo
, 
båfs_å™s_num_wrôîs
);

1041 
	`båfs_put_å™ß˘i⁄
(
cur_å™s
);

1043 i‡(
cuºít
->
jou∫Æ_öfo
 =
å™s
)

1044 
cuºít
->
jou∫Æ_öfo
 = 
NULL
;

1046 i‡(
thrŸée
)

1047 
	`båfs_run_dñayed_ùuts
(
öfo
);

1049 i‡(
	`TRANS_ABORTED
(
å™s
Ë|| 
	`BTRFS_FS_ERROR
(
öfo
)) {

1050 
	`wake_up_¥o˚ss
(
öfo
->
å™ß˘i⁄_kthªad
);

1051 i‡(
	`TRANS_ABORTED
(
å™s
))

1052 
îr
 = 
å™s
->
ab‹ãd
;

1054 
îr
 = -
EROFS
;

1057 
	`kmem_ˇche_‰ì
(
båfs_å™s_h™dÀ_ˇchï
, 
å™s
);

1058  
îr
;

1059 
	}
}

1061 
	$båfs_íd_å™ß˘i⁄
(
båfs_å™s_h™dÀ
 *
å™s
)

1063  
	`__båfs_íd_å™ß˘i⁄
(
å™s
, 0);

1064 
	}
}

1066 
	$båfs_íd_å™ß˘i⁄_thrŸée
(
båfs_å™s_h™dÀ
 *
å™s
)

1068  
	`__båfs_íd_å™ß˘i⁄
(
å™s
, 1);

1069 
	}
}

1076 
	$båfs_wrôe_m¨ked_exã¡s
(
båfs_fs_öfo
 *
fs_öfo
,

1077 
exã¡_io_åì
 *
dúty_∑ges
, 
m¨k
)

1079 
îr
 = 0;

1080 
wîr
 = 0;

1081 
addªss_•a˚
 *
m≠pög
 = 
fs_öfo
->
båì_öode
->
i_m≠pög
;

1082 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

1083 
u64
 
°¨t
 = 0;

1084 
u64
 
íd
;

1086 
	`föd_fú°_exã¡_bô
(
dúty_∑ges
, 
°¨t
, &°¨t, &
íd
,

1087 
m¨k
, &
ˇched_°©e
)) {

1088 
boﬁ
 
waô_wrôeback
 = 
Ál£
;

1090 
îr
 = 
	`c⁄vît_exã¡_bô
(
dúty_∑ges
, 
°¨t
, 
íd
,

1091 
EXTENT_NEED_WAIT
,

1092 
m¨k
, &
ˇched_°©e
);

1106 i‡(
îr
 =-
ENOMEM
) {

1107 
îr
 = 0;

1108 
waô_wrôeback
 = 
åue
;

1110 i‡(!
îr
)

1111 
îr
 = 
	`fûem≠_fd©awrôe_ønge
(
m≠pög
, 
°¨t
, 
íd
);

1112 i‡(
îr
)

1113 
wîr
 = 
îr
;

1114 i‡(
waô_wrôeback
)

1115 
wîr
 = 
	`fûem≠_fd©awaô_ønge
(
m≠pög
, 
°¨t
, 
íd
);

1116 
	`‰ì_exã¡_°©e
(
ˇched_°©e
);

1117 
ˇched_°©e
 = 
NULL
;

1118 
	`c⁄d_ªsched
();

1119 
°¨t
 = 
íd
 + 1;

1121  
wîr
;

1122 
	}
}

1130 
	$__båfs_waô_m¨ked_exã¡s
(
båfs_fs_öfo
 *
fs_öfo
,

1131 
exã¡_io_åì
 *
dúty_∑ges
)

1133 
îr
 = 0;

1134 
wîr
 = 0;

1135 
addªss_•a˚
 *
m≠pög
 = 
fs_öfo
->
båì_öode
->
i_m≠pög
;

1136 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

1137 
u64
 
°¨t
 = 0;

1138 
u64
 
íd
;

1140 
	`föd_fú°_exã¡_bô
(
dúty_∑ges
, 
°¨t
, &°¨t, &
íd
,

1141 
EXTENT_NEED_WAIT
, &
ˇched_°©e
)) {

1150 
îr
 = 
	`˛ór_exã¡_bô
(
dúty_∑ges
, 
°¨t
, 
íd
,

1151 
EXTENT_NEED_WAIT
, &
ˇched_°©e
);

1152 i‡(
îr
 =-
ENOMEM
)

1153 
îr
 = 0;

1154 i‡(!
îr
)

1155 
îr
 = 
	`fûem≠_fd©awaô_ønge
(
m≠pög
, 
°¨t
, 
íd
);

1156 i‡(
îr
)

1157 
wîr
 = 
îr
;

1158 
	`‰ì_exã¡_°©e
(
ˇched_°©e
);

1159 
ˇched_°©e
 = 
NULL
;

1160 
	`c⁄d_ªsched
();

1161 
°¨t
 = 
íd
 + 1;

1163 i‡(
îr
)

1164 
wîr
 = 
îr
;

1165  
wîr
;

1166 
	}
}

1168 
	$båfs_waô_exã¡s
(
båfs_fs_öfo
 *
fs_öfo
,

1169 
exã¡_io_åì
 *
dúty_∑ges
)

1171 
boﬁ
 
îr‹s
 = 
Ál£
;

1172 
îr
;

1174 
îr
 = 
	`__båfs_waô_m¨ked_exã¡s
(
fs_öfo
, 
dúty_∑ges
);

1175 i‡(
	`ã°_™d_˛ór_bô
(
BTRFS_FS_BTREE_ERR
, &
fs_öfo
->
Êags
))

1176 
îr‹s
 = 
åue
;

1178 i‡(
îr‹s
 && !
îr
)

1179 
îr
 = -
EIO
;

1180  
îr
;

1181 
	}
}

1183 
	$båfs_waô_åì_log_exã¡s
(
båfs_roŸ
 *
log_roŸ
, 
m¨k
)

1185 
båfs_fs_öfo
 *
fs_öfo
 = 
log_roŸ
->fs_info;

1186 
exã¡_io_åì
 *
dúty_∑ges
 = &
log_roŸ
->
dúty_log_∑ges
;

1187 
boﬁ
 
îr‹s
 = 
Ál£
;

1188 
îr
;

1190 
	`ASSERT
(
log_roŸ
->
roŸ_key
.
obje˘id
 =
BTRFS_TREE_LOG_OBJECTID
);

1192 
îr
 = 
	`__båfs_waô_m¨ked_exã¡s
(
fs_öfo
, 
dúty_∑ges
);

1193 i‡((
m¨k
 & 
EXTENT_DIRTY
) &&

1194 
	`ã°_™d_˛ór_bô
(
BTRFS_FS_LOG1_ERR
, &
fs_öfo
->
Êags
))

1195 
îr‹s
 = 
åue
;

1197 i‡((
m¨k
 & 
EXTENT_NEW
) &&

1198 
	`ã°_™d_˛ór_bô
(
BTRFS_FS_LOG2_ERR
, &
fs_öfo
->
Êags
))

1199 
îr‹s
 = 
åue
;

1201 i‡(
îr‹s
 && !
îr
)

1202 
îr
 = -
EIO
;

1203  
îr
;

1204 
	}
}

1213 
	$båfs_wrôe_™d_waô_å™ß˘i⁄
(
båfs_å™s_h™dÀ
 *
å™s
)

1215 
ªt
;

1216 
ªt2
;

1217 
exã¡_io_åì
 *
dúty_∑ges
 = &
å™s
->
å™ß˘i⁄
->dirty_pages;

1218 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1219 
blk_∂ug
 
∂ug
;

1221 
	`blk_°¨t_∂ug
(&
∂ug
);

1222 
ªt
 = 
	`båfs_wrôe_m¨ked_exã¡s
(
fs_öfo
, 
dúty_∑ges
, 
EXTENT_DIRTY
);

1223 
	`blk_föish_∂ug
(&
∂ug
);

1224 
ªt2
 = 
	`båfs_waô_exã¡s
(
fs_öfo
, 
dúty_∑ges
);

1226 
	`exã¡_io_åì_ªÀa£
(&
å™s
->
å™ß˘i⁄
->
dúty_∑ges
);

1228 i‡(
ªt
)

1229  
ªt
;

1230 i‡(
ªt2
)

1231  
ªt2
;

1234 
	}
}

1246 
	$upd©e_cow⁄ly_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

1247 
båfs_roŸ
 *
roŸ
)

1249 
ªt
;

1250 
u64
 
ﬁd_roŸ_byãƒ
;

1251 
u64
 
ﬁd_roŸ_u£d
;

1252 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1253 
båfs_roŸ
 *
åì_roŸ
 = 
fs_öfo
->tree_root;

1255 
ﬁd_roŸ_u£d
 = 
	`båfs_roŸ_u£d
(&
roŸ
->
roŸ_ôem
);

1258 
ﬁd_roŸ_byãƒ
 = 
	`båfs_roŸ_byãƒ
(&
roŸ
->
roŸ_ôem
);

1259 i‡(
ﬁd_roŸ_byãƒ
 =
roŸ
->
node
->
°¨t
 &&

1260 
ﬁd_roŸ_u£d
 =
	`båfs_roŸ_u£d
(&
roŸ
->
roŸ_ôem
))

1263 
	`båfs_£t_roŸ_node
(&
roŸ
->
roŸ_ôem
,ÑoŸ->
node
);

1264 
ªt
 = 
	`båfs_upd©e_roŸ
(
å™s
, 
åì_roŸ
,

1265 &
roŸ
->
roŸ_key
,

1266 &
roŸ
->
roŸ_ôem
);

1267 i‡(
ªt
)

1268  
ªt
;

1270 
ﬁd_roŸ_u£d
 = 
	`båfs_roŸ_u£d
(&
roŸ
->
roŸ_ôem
);

1274 
	}
}

1283 
noölöe
 
	$commô_cow⁄ly_roŸs
(
båfs_å™s_h™dÀ
 *
å™s
)

1285 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1286 
li°_hód
 *
dúty_bgs
 = &
å™s
->
å™ß˘i⁄
->dirty_bgs;

1287 
li°_hód
 *
io_bgs
 = &
å™s
->
å™ß˘i⁄
->io_bgs;

1288 
li°_hód
 *
√xt
;

1289 
exã¡_buf„r
 *
eb
;

1290 
ªt
;

1296 
	`ASSERT
(
å™s
->
å™ß˘i⁄
->
°©e
 =
TRANS_STATE_COMMIT_DOING
);

1298 
eb
 = 
	`båfs_lock_roŸ_node
(
fs_öfo
->
åì_roŸ
);

1299 
ªt
 = 
	`båfs_cow_block
(
å™s
, 
fs_öfo
->
åì_roŸ
, 
eb
, 
NULL
,

1300 0, &
eb
, 
BTRFS_NESTING_COW
);

1301 
	`båfs_åì_u∆ock
(
eb
);

1302 
	`‰ì_exã¡_buf„r
(
eb
);

1304 i‡(
ªt
)

1305  
ªt
;

1307 
ªt
 = 
	`båfs_run_dev_°©s
(
å™s
);

1308 i‡(
ªt
)

1309  
ªt
;

1310 
ªt
 = 
	`båfs_run_dev_ª∂a˚
(
å™s
);

1311 i‡(
ªt
)

1312  
ªt
;

1313 
ªt
 = 
	`båfs_run_qgroups
(
å™s
);

1314 i‡(
ªt
)

1315  
ªt
;

1317 
ªt
 = 
	`båfs_£tup_•a˚_ˇche
(
å™s
);

1318 i‡(
ªt
)

1319  
ªt
;

1321 
agaö
:

1322 !
	`li°_em±y
(&
fs_öfo
->
dúty_cow⁄ly_roŸs
)) {

1323 
båfs_roŸ
 *
roŸ
;

1324 
√xt
 = 
fs_öfo
->
dúty_cow⁄ly_roŸs
.next;

1325 
	`li°_dñ_öô
(
√xt
);

1326 
roŸ
 = 
	`li°_íåy
(
√xt
, 
båfs_roŸ
, 
dúty_li°
);

1327 
	`˛ór_bô
(
BTRFS_ROOT_DIRTY
, &
roŸ
->
°©e
);

1329 
	`li°_add_èû
(&
roŸ
->
dúty_li°
,

1330 &
å™s
->
å™ß˘i⁄
->
swôch_commôs
);

1331 
ªt
 = 
	`upd©e_cow⁄ly_roŸ
(
å™s
, 
roŸ
);

1332 i‡(
ªt
)

1333  
ªt
;

1337 
ªt
 = 
	`båfs_run_dñayed_ªfs
(
å™s
, ()-1);

1338 i‡(
ªt
)

1339  
ªt
;

1341 !
	`li°_em±y
(
dúty_bgs
Ë|| !li°_em±y(
io_bgs
)) {

1342 
ªt
 = 
	`båfs_wrôe_dúty_block_groups
(
å™s
);

1343 i‡(
ªt
)

1344  
ªt
;

1352 
ªt
 = 
	`båfs_run_dñayed_ªfs
(
å™s
, ()-1);

1353 i‡(
ªt
)

1354  
ªt
;

1357 i‡(!
	`li°_em±y
(&
fs_öfo
->
dúty_cow⁄ly_roŸs
))

1358 
agaö
;

1361 
fs_öfo
->
dev_ª∂a˚
.
commôãd_curs‹_À·
 =

1362 
fs_öfo
->
dev_ª∂a˚
.
curs‹_À·_œ°_wrôe_of_ôem
;

1365 
	}
}

1371 
	$båfs_maybe_wake_unföished_dr›
(
båfs_fs_öfo
 *
fs_öfo
)

1378 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

1379 i‡(!
	`li°_em±y
(&
fs_öfo
->
dód_roŸs
)) {

1380 
båfs_roŸ
 *
roŸ
 = 
	`li°_fú°_íåy
(&
fs_öfo
->
dód_roŸs
,

1381 
båfs_roŸ
,

1382 
roŸ_li°
);

1383 i‡(
	`ã°_bô
(
BTRFS_ROOT_UNFINISHED_DROP
, &
roŸ
->
°©e
)) {

1384 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

1388 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

1390 
	`båfs_wake_unföished_dr›
(
fs_öfo
);

1391 
	}
}

1398 
	$båfs_add_dód_roŸ
(
båfs_roŸ
 *
roŸ
)

1400 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

1402 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

1403 i‡(
	`li°_em±y
(&
roŸ
->
roŸ_li°
)) {

1404 
	`båfs_gøb_roŸ
(
roŸ
);

1407 i‡(
	`ã°_bô
(
BTRFS_ROOT_UNFINISHED_DROP
, &
roŸ
->
°©e
))

1408 
	`li°_add
(&
roŸ
->
roŸ_li°
, &
fs_öfo
->
dód_roŸs
);

1410 
	`li°_add_èû
(&
roŸ
->
roŸ_li°
, &
fs_öfo
->
dód_roŸs
);

1412 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

1413 
	}
}

1419 
noölöe
 
	$commô_fs_roŸs
(
båfs_å™s_h™dÀ
 *
å™s
)

1421 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1422 
båfs_roŸ
 *
g™g
[8];

1423 
i
;

1424 
ªt
;

1430 
	`ASSERT
(
å™s
->
å™ß˘i⁄
->
°©e
 =
TRANS_STATE_COMMIT_DOING
);

1432 
	`•ö_lock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

1434 
ªt
 = 
	`ødix_åì_g™g_lookup_èg
(&
fs_öfo
->
fs_roŸs_ødix
,

1435 (**)
g™g
, 0,

1436 
	`ARRAY_SIZE
(
g™g
),

1437 
BTRFS_ROOT_TRANS_TAG
);

1438 i‡(
ªt
 == 0)

1440 
i
 = 0; i < 
ªt
; i++) {

1441 
båfs_roŸ
 *
roŸ
 = 
g™g
[
i
];

1442 
ªt2
;

1448 
	`ASSERT
(
	`©omic_ªad
(&
roŸ
->
log_wrôîs
) == 0);

1449 
	`ASSERT
(
	`©omic_ªad
(&
roŸ
->
log_commô
[0]) == 0);

1450 
	`ASSERT
(
	`©omic_ªad
(&
roŸ
->
log_commô
[1]) == 0);

1452 
	`ødix_åì_èg_˛ór
(&
fs_öfo
->
fs_roŸs_ødix
,

1453 ()
roŸ
->
roŸ_key
.
obje˘id
,

1454 
BTRFS_ROOT_TRANS_TAG
);

1455 
	`•ö_u∆ock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

1457 
	`båfs_‰ì_log
(
å™s
, 
roŸ
);

1458 
ªt2
 = 
	`båfs_upd©e_ªloc_roŸ
(
å™s
, 
roŸ
);

1459 i‡(
ªt2
)

1460  
ªt2
;

1463 
	`˛ór_bô
(
BTRFS_ROOT_FORCE_COW
, &
roŸ
->
°©e
);

1464 
	`smp_mb__a·î_©omic
();

1466 i‡(
roŸ
->
commô_roŸ
 !roŸ->
node
) {

1467 
	`li°_add_èû
(&
roŸ
->
dúty_li°
,

1468 &
å™s
->
å™ß˘i⁄
->
swôch_commôs
);

1469 
	`båfs_£t_roŸ_node
(&
roŸ
->
roŸ_ôem
,

1470 
roŸ
->
node
);

1473 
ªt2
 = 
	`båfs_upd©e_roŸ
(
å™s
, 
fs_öfo
->
åì_roŸ
,

1474 &
roŸ
->
roŸ_key
,

1475 &
roŸ
->
roŸ_ôem
);

1476 i‡(
ªt2
)

1477  
ªt2
;

1478 
	`•ö_lock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

1479 
	`båfs_qgroup_‰ì_mëa_Æl_≥πøns
(
roŸ
);

1482 
	`•ö_u∆ock
(&
fs_öfo
->
fs_roŸs_ødix_lock
);

1484 
	}
}

1490 
	$båfs_de‰ag_roŸ
(
båfs_roŸ
 *
roŸ
)

1492 
båfs_fs_öfo
 *
öfo
 = 
roŸ
->
fs_öfo
;

1493 
båfs_å™s_h™dÀ
 *
å™s
;

1494 
ªt
;

1496 i‡(
	`ã°_™d_£t_bô
(
BTRFS_ROOT_DEFRAG_RUNNING
, &
roŸ
->
°©e
))

1500 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

1501 i‡(
	`IS_ERR
(
å™s
)) {

1502 
ªt
 = 
	`PTR_ERR
(
å™s
);

1506 
ªt
 = 
	`båfs_de‰ag_Àaves
(
å™s
, 
roŸ
);

1508 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1509 
	`båfs_båì_bÆ™˚_dúty
(
öfo
);

1510 
	`c⁄d_ªsched
();

1512 i‡(
	`båfs_fs_˛osög
(
öfo
Ë|| 
ªt
 !-
EAGAIN
)

1515 i‡(
	`båfs_de‰ag_ˇn˚Œed
(
öfo
)) {

1516 
	`båfs_debug
(
öfo
, "defrag_root cancelled");

1517 
ªt
 = -
EAGAIN
;

1521 
	`˛ór_bô
(
BTRFS_ROOT_DEFRAG_RUNNING
, &
roŸ
->
°©e
);

1522  
ªt
;

1523 
	}
}

1532 
	$qgroup_accou¡_¢≠shŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

1533 
båfs_roŸ
 *
§c
,

1534 
båfs_roŸ
 *
∑ª¡
,

1535 
båfs_qgroup_öhîô
 *
öhîô
,

1536 
u64
 
d°_obje˘id
)

1538 
båfs_fs_öfo
 *
fs_öfo
 = 
§c
->fs_info;

1539 
ªt
;

1546 i‡(!
	`ã°_bô
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_öfo
->
Êags
))

1555 
ªt
 = 
	`ªc‹d_roŸ_ö_å™s
(
å™s
, 
§c
, 1);

1556 i‡(
ªt
)

1557  
ªt
;

1570 
ªt
 = 
	`båfs_run_dñayed_ªfs
(
å™s
, ()-1);

1571 i‡(
ªt
) {

1572 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1573  
ªt
;

1576 
ªt
 = 
	`commô_fs_roŸs
(
å™s
);

1577 i‡(
ªt
)

1578 
out
;

1579 
ªt
 = 
	`båfs_qgroup_accou¡_exã¡s
(
å™s
);

1580 i‡(
ªt
 < 0)

1581 
out
;

1584 
ªt
 = 
	`båfs_qgroup_öhîô
(
å™s
, 
§c
->
roŸ_key
.
obje˘id
, 
d°_obje˘id
,

1585 
öhîô
);

1586 i‡(
ªt
 < 0)

1587 
out
;

1601 
ªt
 = 
	`commô_cow⁄ly_roŸs
(
å™s
);

1602 i‡(
ªt
)

1603 
out
;

1604 
	`swôch_commô_roŸs
(
å™s
);

1605 
ªt
 = 
	`båfs_wrôe_™d_waô_å™ß˘i⁄
(
å™s
);

1606 i‡(
ªt
)

1607 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
ªt
,

1610 
out
:

1617 i‡(!
ªt
)

1618 
ªt
 = 
	`ªc‹d_roŸ_ö_å™s
(
å™s
, 
∑ª¡
, 1);

1619  
ªt
;

1620 
	}
}

1631 
noölöe
 
	$¸óã_≥ndög_¢≠shŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

1632 
båfs_≥ndög_¢≠shŸ
 *
≥ndög
)

1635 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1636 
båfs_key
 
key
;

1637 
båfs_roŸ_ôem
 *
√w_roŸ_ôem
;

1638 
båfs_roŸ
 *
åì_roŸ
 = 
fs_öfo
->tree_root;

1639 
båfs_roŸ
 *
roŸ
 = 
≥ndög
->root;

1640 
båfs_roŸ
 *
∑ª¡_roŸ
;

1641 
båfs_block_rsv
 *
rsv
;

1642 
öode
 *
∑ª¡_öode
 = 
≥ndög
->
dú
;

1643 
båfs_∑th
 *
∑th
;

1644 
båfs_dú_ôem
 *
dú_ôem
;

1645 
exã¡_buf„r
 *
tmp
;

1646 
exã¡_buf„r
 *
ﬁd
;

1647 
time•ec64
 
cur_time
;

1648 
ªt
 = 0;

1649 
u64
 
to_ª£rve
 = 0;

1650 
u64
 
ödex
 = 0;

1651 
u64
 
obje˘id
;

1652 
u64
 
roŸ_Êags
;

1653 
nofs_Êags
;

1654 
fs¸y±_«me
 
‚ame
;

1656 
	`ASSERT
(
≥ndög
->
∑th
);

1657 
∑th
 = 
≥ndög
->path;

1659 
	`ASSERT
(
≥ndög
->
roŸ_ôem
);

1660 
√w_roŸ_ôem
 = 
≥ndög
->
roŸ_ôem
;

1667 
nofs_Êags
 = 
	`memÆloc_nofs_ßve
();

1668 
≥ndög
->
îr‹
 = 
	`fs¸y±_£tup_fûíame
(
∑ª¡_öode
,

1669 &
≥ndög
->
díåy
->
d_«me
, 0,

1670 &
‚ame
);

1671 
	`memÆloc_nofs_ª°‹e
(
nofs_Êags
);

1672 i‡(
≥ndög
->
îr‹
)

1673 
‰ì_≥ndög
;

1675 
≥ndög
->
îr‹
 = 
	`båfs_gë_‰ì_obje˘id
(
åì_roŸ
, &
obje˘id
);

1676 i‡(
≥ndög
->
îr‹
)

1677 
‰ì_‚ame
;

1683 
	`båfs_£t_skù_qgroup
(
å™s
, 
obje˘id
);

1685 
	`båfs_ªloc_¥e_¢≠shŸ
(
≥ndög
, &
to_ª£rve
);

1687 i‡(
to_ª£rve
 > 0) {

1688 
≥ndög
->
îr‹
 = 
	`båfs_block_rsv_add
(
fs_öfo
,

1689 &
≥ndög
->
block_rsv
,

1690 
to_ª£rve
,

1691 
BTRFS_RESERVE_NO_FLUSH
);

1692 i‡(
≥ndög
->
îr‹
)

1693 
˛ór_skù_qgroup
;

1696 
key
.
obje˘id
 = objectid;

1697 
key
.
off£t
 = (
u64
)-1;

1698 
key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

1700 
rsv
 = 
å™s
->
block_rsv
;

1701 
å™s
->
block_rsv
 = &
≥ndög
->block_rsv;

1702 
å™s
->
byãs_ª£rved
 =Åøns->
block_rsv
->
ª£rved
;

1703 
	`åa˚_båfs_•a˚_ª£rv©i⁄
(
fs_öfo
, "transaction",

1704 
å™s
->
å™sid
,

1705 
å™s
->
byãs_ª£rved
, 1);

1706 
∑ª¡_roŸ
 = 
	`BTRFS_I
(
∑ª¡_öode
)->
roŸ
;

1707 
ªt
 = 
	`ªc‹d_roŸ_ö_å™s
(
å™s
, 
∑ª¡_roŸ
, 0);

1708 i‡(
ªt
)

1709 
Áû
;

1710 
cur_time
 = 
	`cuºít_time
(
∑ª¡_öode
);

1715 
ªt
 = 
	`båfs_£t_öode_ödex
(
	`BTRFS_I
(
∑ª¡_öode
), &
ödex
);

1716 i‡(
ªt
) {

1717 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1718 
Áû
;

1722 
dú_ôem
 = 
	`båfs_lookup_dú_ôem
(
NULL
, 
∑ª¡_roŸ
, 
∑th
,

1723 
	`båfs_öo
(
	`BTRFS_I
(
∑ª¡_öode
)),

1724 &
‚ame
.
disk_«me
, 0);

1725 i‡(
dú_ôem
 !
NULL
 && !
	`IS_ERR
(dir_item)) {

1726 
≥ndög
->
îr‹
 = -
EEXIST
;

1727 
dú_ôem_exi°ed
;

1728 } i‡(
	`IS_ERR
(
dú_ôem
)) {

1729 
ªt
 = 
	`PTR_ERR
(
dú_ôem
);

1730 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1731 
Áû
;

1733 
	`båfs_ªÀa£_∑th
(
∑th
);

1741 
ªt
 = 
	`båfs_run_dñayed_ôems
(
å™s
);

1742 i‡(
ªt
) {

1743 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1744 
Áû
;

1747 
ªt
 = 
	`ªc‹d_roŸ_ö_å™s
(
å™s
, 
roŸ
, 0);

1748 i‡(
ªt
) {

1749 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1750 
Áû
;

1752 
	`båfs_£t_roŸ_œ°_¢≠shŸ
(&
roŸ
->
roŸ_ôem
, 
å™s
->
å™sid
);

1753 
	`mem˝y
(
√w_roŸ_ôem
, &
roŸ
->
roŸ_ôem
, (*new_root_item));

1754 
	`båfs_check_™d_öô_roŸ_ôem
(
√w_roŸ_ôem
);

1756 
roŸ_Êags
 = 
	`båfs_roŸ_Êags
(
√w_roŸ_ôem
);

1757 i‡(
≥ndög
->
ªad⁄ly
)

1758 
roŸ_Êags
 |
BTRFS_ROOT_SUBVOL_RDONLY
;

1760 
roŸ_Êags
 &~
BTRFS_ROOT_SUBVOL_RDONLY
;

1761 
	`båfs_£t_roŸ_Êags
(
√w_roŸ_ôem
, 
roŸ_Êags
);

1763 
	`båfs_£t_roŸ_gíî©i⁄_v2
(
√w_roŸ_ôem
,

1764 
å™s
->
å™sid
);

1765 
	`gíî©e_øndom_guid
(
√w_roŸ_ôem
->
uuid
);

1766 
	`mem˝y
(
√w_roŸ_ôem
->
∑ª¡_uuid
, 
roŸ
->
roŸ_ôem
.
uuid
,

1767 
BTRFS_UUID_SIZE
);

1768 i‡(!(
roŸ_Êags
 & 
BTRFS_ROOT_SUBVOL_RDONLY
)) {

1769 
	`mem£t
(
√w_roŸ_ôem
->
ª˚ived_uuid
, 0,

1770 (
√w_roŸ_ôem
->
ª˚ived_uuid
));

1771 
	`mem£t
(&
√w_roŸ_ôem
->
°ime
, 0, (new_root_item->stime));

1772 
	`mem£t
(&
√w_roŸ_ôem
->
πime
, 0, (new_root_item->rtime));

1773 
	`båfs_£t_roŸ_°ønsid
(
√w_roŸ_ôem
, 0);

1774 
	`båfs_£t_roŸ_πønsid
(
√w_roŸ_ôem
, 0);

1776 
	`båfs_£t_°ack_time•ec_£c
(&
√w_roŸ_ôem
->
Ÿime
, 
cur_time
.
tv_£c
);

1777 
	`båfs_£t_°ack_time•ec_n£c
(&
√w_roŸ_ôem
->
Ÿime
, 
cur_time
.
tv_n£c
);

1778 
	`båfs_£t_roŸ_Ÿønsid
(
√w_roŸ_ôem
, 
å™s
->
å™sid
);

1780 
ﬁd
 = 
	`båfs_lock_roŸ_node
(
roŸ
);

1781 
ªt
 = 
	`båfs_cow_block
(
å™s
, 
roŸ
, 
ﬁd
, 
NULL
, 0, &old,

1782 
BTRFS_NESTING_COW
);

1783 i‡(
ªt
) {

1784 
	`båfs_åì_u∆ock
(
ﬁd
);

1785 
	`‰ì_exã¡_buf„r
(
ﬁd
);

1786 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1787 
Áû
;

1790 
ªt
 = 
	`båfs_c›y_roŸ
(
å™s
, 
roŸ
, 
ﬁd
, &
tmp
, 
obje˘id
);

1792 
	`båfs_åì_u∆ock
(
ﬁd
);

1793 
	`‰ì_exã¡_buf„r
(
ﬁd
);

1794 i‡(
ªt
) {

1795 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1796 
Áû
;

1799 
	`£t_bô
(
BTRFS_ROOT_FORCE_COW
, &
roŸ
->
°©e
);

1800 
	`smp_wmb
();

1802 
	`båfs_£t_roŸ_node
(
√w_roŸ_ôem
, 
tmp
);

1804 
key
.
off£t
 = 
å™s
->
å™sid
;

1805 
ªt
 = 
	`båfs_ö£π_roŸ
(
å™s
, 
åì_roŸ
, &
key
, 
√w_roŸ_ôem
);

1806 
	`båfs_åì_u∆ock
(
tmp
);

1807 
	`‰ì_exã¡_buf„r
(
tmp
);

1808 i‡(
ªt
) {

1809 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1810 
Áû
;

1816 
ªt
 = 
	`båfs_add_roŸ_ªf
(
å™s
, 
obje˘id
,

1817 
∑ª¡_roŸ
->
roŸ_key
.
obje˘id
,

1818 
	`båfs_öo
(
	`BTRFS_I
(
∑ª¡_öode
)), 
ödex
,

1819 &
‚ame
.
disk_«me
);

1820 i‡(
ªt
) {

1821 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1822 
Áû
;

1825 
key
.
off£t
 = (
u64
)-1;

1826 
≥ndög
->
¢≠
 = 
	`båfs_gë_√w_fs_roŸ
(
fs_öfo
, 
obje˘id
,Öídög->
™⁄_dev
);

1827 i‡(
	`IS_ERR
(
≥ndög
->
¢≠
)) {

1828 
ªt
 = 
	`PTR_ERR
(
≥ndög
->
¢≠
);

1829 
≥ndög
->
¢≠
 = 
NULL
;

1830 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1831 
Áû
;

1834 
ªt
 = 
	`båfs_ªloc_po°_¢≠shŸ
(
å™s
, 
≥ndög
);

1835 i‡(
ªt
) {

1836 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1837 
Áû
;

1846 
ªt
 = 
	`qgroup_accou¡_¢≠shŸ
(
å™s
, 
roŸ
, 
∑ª¡_roŸ
,

1847 
≥ndög
->
öhîô
, 
obje˘id
);

1848 i‡(
ªt
 < 0)

1849 
Áû
;

1851 
ªt
 = 
	`båfs_ö£π_dú_ôem
(
å™s
, &
‚ame
.
disk_«me
,

1852 
	`BTRFS_I
(
∑ª¡_öode
), &
key
, 
BTRFS_FT_DIR
,

1853 
ödex
);

1855 
	`BUG_ON
(
ªt
 =-
EEXIST
 ||Ñë =-
EOVERFLOW
);

1856 i‡(
ªt
) {

1857 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1858 
Áû
;

1861 
	`båfs_i_size_wrôe
(
	`BTRFS_I
(
∑ª¡_öode
),Ö¨ít_öode->
i_size
 +

1862 
‚ame
.
disk_«me
.
Àn
 * 2);

1863 
∑ª¡_öode
->
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(parent_inode);

1864 
ªt
 = 
	`båfs_upd©e_öode_ÁŒback
(
å™s
, 
∑ª¡_roŸ
, 
	`BTRFS_I
(
∑ª¡_öode
));

1865 i‡(
ªt
) {

1866 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1867 
Áû
;

1869 
ªt
 = 
	`båfs_uuid_åì_add
(
å™s
, 
√w_roŸ_ôem
->
uuid
,

1870 
BTRFS_UUID_KEY_SUBVOL
,

1871 
obje˘id
);

1872 i‡(
ªt
) {

1873 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1874 
Áû
;

1876 i‡(!
	`båfs_is_em±y_uuid
(
√w_roŸ_ôem
->
ª˚ived_uuid
)) {

1877 
ªt
 = 
	`båfs_uuid_åì_add
(
å™s
, 
√w_roŸ_ôem
->
ª˚ived_uuid
,

1878 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
,

1879 
obje˘id
);

1880 i‡(
ªt
 &&Ñë !-
EEXIST
) {

1881 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

1882 
Áû
;

1886 
Áû
:

1887 
≥ndög
->
îr‹
 = 
ªt
;

1888 
dú_ôem_exi°ed
:

1889 
å™s
->
block_rsv
 = 
rsv
;

1890 
å™s
->
byãs_ª£rved
 = 0;

1891 
˛ór_skù_qgroup
:

1892 
	`båfs_˛ór_skù_qgroup
(
å™s
);

1893 
‰ì_‚ame
:

1894 
	`fs¸y±_‰ì_fûíame
(&
‚ame
);

1895 
‰ì_≥ndög
:

1896 
	`k‰ì
(
√w_roŸ_ôem
);

1897 
≥ndög
->
roŸ_ôem
 = 
NULL
;

1898 
	`båfs_‰ì_∑th
(
∑th
);

1899 
≥ndög
->
∑th
 = 
NULL
;

1901  
ªt
;

1902 
	}
}

1907 
noölöe
 
	$¸óã_≥ndög_¢≠shŸs
(
båfs_å™s_h™dÀ
 *
å™s
)

1909 
båfs_≥ndög_¢≠shŸ
 *
≥ndög
, *
√xt
;

1910 
li°_hód
 *
hód
 = &
å™s
->
å™ß˘i⁄
->
≥ndög_¢≠shŸs
;

1911 
ªt
 = 0;

1913 
	`li°_f‹_óch_íåy_ß„
(
≥ndög
, 
√xt
, 
hód
, 
li°
) {

1914 
	`li°_dñ
(&
≥ndög
->
li°
);

1915 
ªt
 = 
	`¸óã_≥ndög_¢≠shŸ
(
å™s
, 
≥ndög
);

1916 i‡(
ªt
)

1919  
ªt
;

1920 
	}
}

1922 
	$upd©e_su≥r_roŸs
(
båfs_fs_öfo
 *
fs_öfo
)

1924 
båfs_roŸ_ôem
 *
roŸ_ôem
;

1925 
båfs_su≥r_block
 *
su≥r
;

1927 
su≥r
 = 
fs_öfo
->
su≥r_c›y
;

1929 
roŸ_ôem
 = &
fs_öfo
->
chunk_roŸ
->root_item;

1930 
su≥r
->
chunk_roŸ
 = 
roŸ_ôem
->
byãƒ
;

1931 
su≥r
->
chunk_roŸ_gíî©i⁄
 = 
roŸ_ôem
->
gíî©i⁄
;

1932 
su≥r
->
chunk_roŸ_Àvñ
 = 
roŸ_ôem
->
Àvñ
;

1934 
roŸ_ôem
 = &
fs_öfo
->
åì_roŸ
->root_item;

1935 
su≥r
->
roŸ
 = 
roŸ_ôem
->
byãƒ
;

1936 
su≥r
->
gíî©i⁄
 = 
roŸ_ôem
->generation;

1937 
su≥r
->
roŸ_Àvñ
 = 
roŸ_ôem
->
Àvñ
;

1938 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
SPACE_CACHE
))

1939 
su≥r
->
ˇche_gíî©i⁄
 = 
roŸ_ôem
->
gíî©i⁄
;

1940 i‡(
	`ã°_bô
(
BTRFS_FS_CLEANUP_SPACE_CACHE_V1
, &
fs_öfo
->
Êags
))

1941 
su≥r
->
ˇche_gíî©i⁄
 = 0;

1942 i‡(
	`ã°_bô
(
BTRFS_FS_UPDATE_UUID_TREE_GEN
, &
fs_öfo
->
Êags
))

1943 
su≥r
->
uuid_åì_gíî©i⁄
 = 
roŸ_ôem
->
gíî©i⁄
;

1944 
	}
}

1946 
	$båfs_å™ß˘i⁄_ö_commô
(
båfs_fs_öfo
 *
öfo
)

1948 
båfs_å™ß˘i⁄
 *
å™s
;

1949 
ªt
 = 0;

1951 
	`•ö_lock
(&
öfo
->
å™s_lock
);

1952 
å™s
 = 
öfo
->
ru¬ög_å™ß˘i⁄
;

1953 i‡(
å™s
)

1954 
ªt
 = (
å™s
->
°©e
 >
TRANS_STATE_COMMIT_START
);

1955 
	`•ö_u∆ock
(&
öfo
->
å™s_lock
);

1956  
ªt
;

1957 
	}
}

1959 
	$båfs_å™ß˘i⁄_blocked
(
båfs_fs_öfo
 *
öfo
)

1961 
båfs_å™ß˘i⁄
 *
å™s
;

1962 
ªt
 = 0;

1964 
	`•ö_lock
(&
öfo
->
å™s_lock
);

1965 
å™s
 = 
öfo
->
ru¬ög_å™ß˘i⁄
;

1966 i‡(
å™s
)

1967 
ªt
 = 
	`is_å™ß˘i⁄_blocked
(
å™s
);

1968 
	`•ö_u∆ock
(&
öfo
->
å™s_lock
);

1969  
ªt
;

1970 
	}
}

1972 
	$båfs_commô_å™ß˘i⁄_async
(
båfs_å™s_h™dÀ
 *
å™s
)

1974 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

1975 
båfs_å™ß˘i⁄
 *
cur_å™s
;

1978 
	`£t_bô
(
BTRFS_FS_COMMIT_TRANS
, &
fs_öfo
->
Êags
);

1979 
	`wake_up_¥o˚ss
(
fs_öfo
->
å™ß˘i⁄_kthªad
);

1982 
cur_å™s
 = 
å™s
->
å™ß˘i⁄
;

1983 
	`ªfcou¡_öc
(&
cur_å™s
->
u£_cou¡
);

1985 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

1991 
	`båfs_might_waô_f‹_°©e
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_COMMIT_PREP
);

1992 
	`waô_evít
(
fs_öfo
->
å™ß˘i⁄_blocked_waô
,

1993 
cur_å™s
->
°©e
 >
TRANS_STATE_COMMIT_START
 ||

1994 
	`TRANS_ABORTED
(
cur_å™s
));

1995 
	`båfs_put_å™ß˘i⁄
(
cur_å™s
);

1996 
	}
}

1998 
	$˛ónup_å™ß˘i⁄
(
båfs_å™s_h™dÀ
 *
å™s
, 
îr
)

2000 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2001 
båfs_å™ß˘i⁄
 *
cur_å™s
 = 
å™s
->
å™ß˘i⁄
;

2003 
	`WARN_ON
(
	`ªfcou¡_ªad
(&
å™s
->
u£_cou¡
) > 1);

2005 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
îr
);

2007 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

2014 
	`BUG_ON
(
	`li°_em±y
(&
cur_å™s
->
li°
));

2016 i‡(
cur_å™s
 =
fs_öfo
->
ru¬ög_å™ß˘i⁄
) {

2017 
cur_å™s
->
°©e
 = 
TRANS_STATE_COMMIT_DOING
;

2018 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

2024 
	`båfs_might_waô_f‹_evít
(
fs_öfo
, 
båfs_å™s_num_wrôîs
);

2025 
	`waô_evít
(
cur_å™s
->
wrôî_waô
,

2026 
	`©omic_ªad
(&
cur_å™s
->
num_wrôîs
) == 1);

2028 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

2039 
	`li°_dñ_öô
(&
cur_å™s
->
li°
);

2041 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

2043 
	`båfs_˛ónup_⁄e_å™ß˘i⁄
(
å™s
->
å™ß˘i⁄
, 
fs_öfo
);

2045 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

2046 i‡(
cur_å™s
 =
fs_öfo
->
ru¬ög_å™ß˘i⁄
)

2047 
fs_öfo
->
ru¬ög_å™ß˘i⁄
 = 
NULL
;

2048 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

2050 i‡(
å™s
->
ty≥
 & 
__TRANS_FREEZABLE
)

2051 
	`sb_íd_ötwrôe
(
fs_öfo
->
sb
);

2052 
	`båfs_put_å™ß˘i⁄
(
cur_å™s
);

2053 
	`båfs_put_å™ß˘i⁄
(
cur_å™s
);

2055 
	`åa˚_båfs_å™ß˘i⁄_commô
(
fs_öfo
);

2057 i‡(
cuºít
->
jou∫Æ_öfo
 =
å™s
)

2058 
cuºít
->
jou∫Æ_öfo
 = 
NULL
;

2071 i‡(!
	`ã°_bô
(
BTRFS_FS_RELOC_RUNNING
, &
fs_öfo
->
Êags
))

2072 
	`båfs_s¸ub_ˇn˚l
(
fs_öfo
);

2074 
	`kmem_ˇche_‰ì
(
båfs_å™s_h™dÀ_ˇchï
, 
å™s
);

2075 
	}
}

2081 
	$båfs_˛ónup_≥ndög_block_groups
(
båfs_å™s_h™dÀ
 *
å™s
)

2083 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2084 
båfs_block_group
 *
block_group
, *
tmp
;

2086 
	`li°_f‹_óch_íåy_ß„
(
block_group
, 
tmp
, &
å™s
->
√w_bgs
, 
bg_li°
) {

2087 
	`båfs_dñayed_ªfs_rsv_ªÀa£
(
fs_öfo
, 1);

2088 
	`li°_dñ_öô
(&
block_group
->
bg_li°
);

2090 
	}
}

2092 
ölöe
 
	$båfs_°¨t_dñÆloc_Êush
(
båfs_fs_öfo
 *
fs_öfo
)

2111 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
FLUSHONCOMMIT
))

2112 
	`åy_to_wrôeback_öodes_sb
(
fs_öfo
->
sb
, 
WB_REASON_SYNC
);

2114 
	}
}

2116 
ölöe
 
	$båfs_waô_dñÆloc_Êush
(
båfs_fs_öfo
 *
fs_öfo
)

2118 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
FLUSHONCOMMIT
))

2119 
	`båfs_waô_‹dîed_roŸs
(
fs_öfo
, 
U64_MAX
, 0, (
u64
)-1);

2120 
	}
}

2130 
	$add_≥ndög_¢≠shŸ
(
båfs_å™s_h™dÀ
 *
å™s
)

2132 
båfs_å™ß˘i⁄
 *
cur_å™s
 = 
å™s
->
å™ß˘i⁄
;

2134 i‡(!
å™s
->
≥ndög_¢≠shŸ
)

2137 
	`lockdï_as£π_hñd
(&
å™s
->
fs_öfo
->
å™s_lock
);

2138 
	`ASSERT
(
cur_å™s
->
°©e
 >
TRANS_STATE_COMMIT_PREP
);

2140 
	`li°_add
(&
å™s
->
≥ndög_¢≠shŸ
->
li°
, &
cur_å™s
->
≥ndög_¢≠shŸs
);

2141 
	}
}

2143 
	$upd©e_commô_°©s
(
båfs_fs_öfo
 *
fs_öfo
, 
ktime_t
 
öãrvÆ
)

2145 
fs_öfo
->
commô_°©s
.
commô_cou¡
++;

2146 
fs_öfo
->
commô_°©s
.
œ°_commô_dur
 = 
öãrvÆ
;

2147 
fs_öfo
->
commô_°©s
.
max_commô_dur
 =

2148 
	`max_t
(
u64
, 
fs_öfo
->
commô_°©s
.
max_commô_dur
, 
öãrvÆ
);

2149 
fs_öfo
->
commô_°©s
.
tŸÆ_commô_dur
 +
öãrvÆ
;

2150 
	}
}

2152 
	$båfs_commô_å™ß˘i⁄
(
båfs_å™s_h™dÀ
 *
å™s
)

2154 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2155 
båfs_å™ß˘i⁄
 *
cur_å™s
 = 
å™s
->
å™ß˘i⁄
;

2156 
båfs_å™ß˘i⁄
 *
¥ev_å™s
 = 
NULL
;

2157 
ªt
;

2158 
ktime_t
 
°¨t_time
;

2159 
ktime_t
 
öãrvÆ
;

2161 
	`ASSERT
(
	`ªfcou¡_ªad
(&
å™s
->
u£_cou¡
) == 1);

2162 
	`båfs_å™s_°©e_lockdï_acquúe
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_COMMIT_PREP
);

2164 
	`˛ór_bô
(
BTRFS_FS_NEED_TRANS_COMMIT
, &
fs_öfo
->
Êags
);

2168 i‡(
	`TRANS_ABORTED
(
cur_å™s
)) {

2169 
ªt
 = 
cur_å™s
->
ab‹ãd
;

2170 
lockdï_å™s_commô_°¨t_ªÀa£
;

2173 
	`båfs_å™s_ªÀa£_mëad©a
(
å™s
);

2174 
å™s
->
block_rsv
 = 
NULL
;

2180 i‡(!
	`ã°_™d_£t_bô
(
BTRFS_DELAYED_REFS_FLUSHING
,

2181 &
cur_å™s
->
dñayed_ªfs
.
Êags
)) {

2186 
ªt
 = 
	`båfs_run_dñayed_ªfs
(
å™s
, 0);

2187 i‡(
ªt
)

2188 
lockdï_å™s_commô_°¨t_ªÀa£
;

2191 
	`båfs_¸óã_≥ndög_block_groups
(
å™s
);

2193 i‡(!
	`ã°_bô
(
BTRFS_TRANS_DIRTY_BG_RUN
, &
cur_å™s
->
Êags
)) {

2194 
run_ô
 = 0;

2209 
	`muãx_lock
(&
fs_öfo
->
ro_block_group_muãx
);

2210 i‡(!
	`ã°_™d_£t_bô
(
BTRFS_TRANS_DIRTY_BG_RUN
,

2211 &
cur_å™s
->
Êags
))

2212 
run_ô
 = 1;

2213 
	`muãx_u∆ock
(&
fs_öfo
->
ro_block_group_muãx
);

2215 i‡(
run_ô
) {

2216 
ªt
 = 
	`båfs_°¨t_dúty_block_groups
(
å™s
);

2217 i‡(
ªt
)

2218 
lockdï_å™s_commô_°¨t_ªÀa£
;

2222 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

2223 i‡(
cur_å™s
->
°©e
 >
TRANS_STATE_COMMIT_PREP
) {

2224 
båfs_å™s_°©e
 
w™t_°©e
 = 
TRANS_STATE_COMPLETED
;

2226 
	`add_≥ndög_¢≠shŸ
(
å™s
);

2228 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

2229 
	`ªfcou¡_öc
(&
cur_å™s
->
u£_cou¡
);

2231 i‡(
å™s
->
ö_fsync
)

2232 
w™t_°©e
 = 
TRANS_STATE_SUPER_COMMITTED
;

2234 
	`båfs_å™s_°©e_lockdï_ªÀa£
(
fs_öfo
,

2235 
BTRFS_LOCKDEP_TRANS_COMMIT_PREP
);

2236 
ªt
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

2237 
	`waô_f‹_commô
(
cur_å™s
, 
w™t_°©e
);

2239 i‡(
	`TRANS_ABORTED
(
cur_å™s
))

2240 
ªt
 = 
cur_å™s
->
ab‹ãd
;

2242 
	`båfs_put_å™ß˘i⁄
(
cur_å™s
);

2244  
ªt
;

2247 
cur_å™s
->
°©e
 = 
TRANS_STATE_COMMIT_PREP
;

2248 
	`wake_up
(&
fs_öfo
->
å™ß˘i⁄_blocked_waô
);

2249 
	`båfs_å™s_°©e_lockdï_ªÀa£
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_COMMIT_PREP
);

2251 i‡(
cur_å™s
->
li°
.
¥ev
 !&
fs_öfo
->
å™s_li°
) {

2252 
båfs_å™s_°©e
 
w™t_°©e
 = 
TRANS_STATE_COMPLETED
;

2254 i‡(
å™s
->
ö_fsync
)

2255 
w™t_°©e
 = 
TRANS_STATE_SUPER_COMMITTED
;

2257 
¥ev_å™s
 = 
	`li°_íåy
(
cur_å™s
->
li°
.
¥ev
,

2258 
båfs_å™ß˘i⁄
, 
li°
);

2259 i‡(
¥ev_å™s
->
°©e
 < 
w™t_°©e
) {

2260 
	`ªfcou¡_öc
(&
¥ev_å™s
->
u£_cou¡
);

2261 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

2263 
	`waô_f‹_commô
(
¥ev_å™s
, 
w™t_°©e
);

2265 
ªt
 = 
	`READ_ONCE
(
¥ev_å™s
->
ab‹ãd
);

2267 
	`båfs_put_å™ß˘i⁄
(
¥ev_å™s
);

2268 i‡(
ªt
)

2269 
lockdï_ªÀa£
;

2270 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

2279 i‡(
	`BTRFS_FS_ERROR
(
fs_öfo
)) {

2280 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

2281 
ªt
 = -
EROFS
;

2282 
lockdï_ªÀa£
;

2286 
cur_å™s
->
°©e
 = 
TRANS_STATE_COMMIT_START
;

2287 
	`wake_up
(&
fs_öfo
->
å™ß˘i⁄_blocked_waô
);

2288 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

2294 
°¨t_time
 = 
	`ktime_gë_ns
();

2296 
	`extwrôî_cou¡î_dec
(
cur_å™s
, 
å™s
->
ty≥
);

2298 
ªt
 = 
	`båfs_°¨t_dñÆloc_Êush
(
fs_öfo
);

2300 i‡(
ªt
)

2301 
lockdï_ªÀa£
;

2303 
ªt
 = 
	`båfs_run_dñayed_ôems
(
å™s
);

2304 i‡(
ªt
)

2305 
lockdï_ªÀa£
;

2312 
	`båfs_lockdï_ªÀa£
(
fs_öfo
, 
båfs_å™s_num_extwrôîs
);

2313 
	`båfs_might_waô_f‹_evít
(
fs_öfo
, 
båfs_å™s_num_extwrôîs
);

2314 
	`waô_evít
(
cur_å™s
->
wrôî_waô
,

2315 
	`extwrôî_cou¡î_ªad
(
cur_å™s
) == 0);

2318 
ªt
 = 
	`båfs_run_dñayed_ôems
(
å™s
);

2319 i‡(
ªt
) {

2320 
	`båfs_lockdï_ªÀa£
(
fs_öfo
, 
båfs_å™s_num_wrôîs
);

2321 
˛ónup_å™ß˘i⁄
;

2324 
	`båfs_waô_dñÆloc_Êush
(
fs_öfo
);

2332 
	`båfs_might_waô_f‹_evít
(
fs_öfo
, 
båfs_å™s_≥ndög_‹dîed
);

2333 
	`waô_evít
(
cur_å™s
->
≥ndög_waô
,

2334 
	`©omic_ªad
(&
cur_å™s
->
≥ndög_‹dîed
) == 0);

2336 
	`båfs_s¸ub_∑u£
(
fs_öfo
);

2342 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

2343 
	`add_≥ndög_¢≠shŸ
(
å™s
);

2344 
cur_å™s
->
°©e
 = 
TRANS_STATE_COMMIT_DOING
;

2345 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

2352 
	`båfs_lockdï_ªÀa£
(
fs_öfo
, 
båfs_å™s_num_wrôîs
);

2353 
	`båfs_might_waô_f‹_evít
(
fs_öfo
, 
båfs_å™s_num_wrôîs
);

2354 
	`waô_evít
(
cur_å™s
->
wrôî_waô
,

2355 
	`©omic_ªad
(&
cur_å™s
->
num_wrôîs
) == 1);

2363 
	`båfs_å™s_°©e_lockdï_acquúe
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_COMPLETED
);

2364 
	`båfs_å™s_°©e_lockdï_acquúe
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_SUPER_COMMITTED
);

2365 
	`båfs_å™s_°©e_lockdï_acquúe
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_UNBLOCKED
);

2372 
	`˛ór_bô
(
BTRFS_FS_COMMIT_TRANS
, &
fs_öfo
->
Êags
);

2374 i‡(
	`TRANS_ABORTED
(
cur_å™s
)) {

2375 
ªt
 = 
cur_å™s
->
ab‹ãd
;

2376 
	`båfs_å™s_°©e_lockdï_ªÀa£
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_UNBLOCKED
);

2377 
s¸ub_c⁄töue
;

2384 
	`muãx_lock
(&
fs_öfo
->
ªloc_muãx
);

2391 
ªt
 = 
	`¸óã_≥ndög_¢≠shŸs
(
å™s
);

2392 i‡(
ªt
)

2393 
u∆ock_ªloc
;

2405 
ªt
 = 
	`båfs_run_dñayed_ôems
(
å™s
);

2406 i‡(
ªt
)

2407 
u∆ock_ªloc
;

2409 
ªt
 = 
	`båfs_run_dñayed_ªfs
(
å™s
, ()-1);

2410 i‡(
ªt
)

2411 
u∆ock_ªloc
;

2418 
	`båfs_as£π_dñayed_roŸ_em±y
(
fs_öfo
);

2420 
	`WARN_ON
(
cur_å™s
 !
å™s
->
å™ß˘i⁄
);

2422 
ªt
 = 
	`commô_fs_roŸs
(
å™s
);

2423 i‡(
ªt
)

2424 
u∆ock_ªloc
;

2429 
	`båfs_‰ì_log_roŸ_åì
(
å™s
, 
fs_öfo
);

2435 
ªt
 = 
	`båfs_qgroup_accou¡_exã¡s
(
å™s
);

2436 i‡(
ªt
 < 0)

2437 
u∆ock_ªloc
;

2439 
ªt
 = 
	`commô_cow⁄ly_roŸs
(
å™s
);

2441 i‡(
ªt
)

2442 
u∆ock_ªloc
;

2448 i‡(
	`TRANS_ABORTED
(
cur_å™s
)) {

2449 
ªt
 = 
cur_å™s
->
ab‹ãd
;

2450 
u∆ock_ªloc
;

2453 
cur_å™s
 = 
fs_öfo
->
ru¬ög_å™ß˘i⁄
;

2455 
	`båfs_£t_roŸ_node
(&
fs_öfo
->
åì_roŸ
->
roŸ_ôem
,

2456 
fs_öfo
->
åì_roŸ
->
node
);

2457 
	`li°_add_èû
(&
fs_öfo
->
åì_roŸ
->
dúty_li°
,

2458 &
cur_å™s
->
swôch_commôs
);

2460 
	`båfs_£t_roŸ_node
(&
fs_öfo
->
chunk_roŸ
->
roŸ_ôem
,

2461 
fs_öfo
->
chunk_roŸ
->
node
);

2462 
	`li°_add_èû
(&
fs_öfo
->
chunk_roŸ
->
dúty_li°
,

2463 &
cur_å™s
->
swôch_commôs
);

2465 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
EXTENT_TREE_V2
)) {

2466 
	`båfs_£t_roŸ_node
(&
fs_öfo
->
block_group_roŸ
->
roŸ_ôem
,

2467 
fs_öfo
->
block_group_roŸ
->
node
);

2468 
	`li°_add_èû
(&
fs_öfo
->
block_group_roŸ
->
dúty_li°
,

2469 &
cur_å™s
->
swôch_commôs
);

2472 
	`swôch_commô_roŸs
(
å™s
);

2474 
	`ASSERT
(
	`li°_em±y
(&
cur_å™s
->
dúty_bgs
));

2475 
	`ASSERT
(
	`li°_em±y
(&
cur_å™s
->
io_bgs
));

2476 
	`upd©e_su≥r_roŸs
(
fs_öfo
);

2478 
	`båfs_£t_su≥r_log_roŸ
(
fs_öfo
->
su≥r_c›y
, 0);

2479 
	`båfs_£t_su≥r_log_roŸ_Àvñ
(
fs_öfo
->
su≥r_c›y
, 0);

2480 
	`mem˝y
(
fs_öfo
->
su≥r_f‹_commô
, fs_öfo->
su≥r_c›y
,

2481 (*
fs_öfo
->
su≥r_c›y
));

2483 
	`båfs_commô_devi˚_sizes
(
cur_å™s
);

2485 
	`˛ór_bô
(
BTRFS_FS_LOG1_ERR
, &
fs_öfo
->
Êags
);

2486 
	`˛ór_bô
(
BTRFS_FS_LOG2_ERR
, &
fs_öfo
->
Êags
);

2488 
	`båfs_å™s_ªÀa£_chunk_mëad©a
(
å™s
);

2498 
	`muãx_lock
(&
fs_öfo
->
åì_log_muãx
);

2500 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

2501 
cur_å™s
->
°©e
 = 
TRANS_STATE_UNBLOCKED
;

2502 
fs_öfo
->
ru¬ög_å™ß˘i⁄
 = 
NULL
;

2503 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

2504 
	`muãx_u∆ock
(&
fs_öfo
->
ªloc_muãx
);

2506 
	`wake_up
(&
fs_öfo
->
å™ß˘i⁄_waô
);

2507 
	`båfs_å™s_°©e_lockdï_ªÀa£
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_UNBLOCKED
);

2510 i‡(
	`ã°_bô
(
BTRFS_FS_FEATURE_CHANGED
, &
fs_öfo
->
Êags
) &&

2511 
fs_öfo
->
˛ó√r_kthªad
)

2512 
	`wake_up_¥o˚ss
(
fs_öfo
->
˛ó√r_kthªad
);

2514 
ªt
 = 
	`båfs_wrôe_™d_waô_å™ß˘i⁄
(
å™s
);

2515 i‡(
ªt
) {

2516 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
ªt
,

2518 
	`muãx_u∆ock
(&
fs_öfo
->
åì_log_muãx
);

2519 
s¸ub_c⁄töue
;

2523 
ªt
 = 
	`wrôe_Æl_su≥rs
(
fs_öfo
, 0);

2529 
	`muãx_u∆ock
(&
fs_öfo
->
åì_log_muãx
);

2530 i‡(
ªt
)

2531 
s¸ub_c⁄töue
;

2537 
cur_å™s
->
°©e
 = 
TRANS_STATE_SUPER_COMMITTED
;

2538 
	`wake_up
(&
cur_å™s
->
commô_waô
);

2539 
	`båfs_å™s_°©e_lockdï_ªÀa£
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_SUPER_COMMITTED
);

2541 
	`båfs_föish_exã¡_commô
(
å™s
);

2544 i‡(
	`ã°_bô
(
BTRFS_TRANS_HAVE_FREE_BGS
, &
cur_å™s
->
Êags
))

2545 
	`båfs_˛ór_•a˚_öfo_fuŒ
(
fs_öfo
);

2547 
fs_öfo
->
œ°_å™s_commôãd
 = 
cur_å™s
->
å™sid
;

2552 
cur_å™s
->
°©e
 = 
TRANS_STATE_COMPLETED
;

2553 
	`wake_up
(&
cur_å™s
->
commô_waô
);

2554 
	`båfs_å™s_°©e_lockdï_ªÀa£
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_COMPLETED
);

2556 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

2557 
	`li°_dñ_öô
(&
cur_å™s
->
li°
);

2558 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

2560 
	`båfs_put_å™ß˘i⁄
(
cur_å™s
);

2561 
	`båfs_put_å™ß˘i⁄
(
cur_å™s
);

2563 i‡(
å™s
->
ty≥
 & 
__TRANS_FREEZABLE
)

2564 
	`sb_íd_ötwrôe
(
fs_öfo
->
sb
);

2566 
	`åa˚_båfs_å™ß˘i⁄_commô
(
fs_öfo
);

2568 
öãrvÆ
 = 
	`ktime_gë_ns
(Ë- 
°¨t_time
;

2570 
	`båfs_s¸ub_c⁄töue
(
fs_öfo
);

2572 i‡(
cuºít
->
jou∫Æ_öfo
 =
å™s
)

2573 
cuºít
->
jou∫Æ_öfo
 = 
NULL
;

2575 
	`kmem_ˇche_‰ì
(
båfs_å™s_h™dÀ_ˇchï
, 
å™s
);

2577 
	`upd©e_commô_°©s
(
fs_öfo
, 
öãrvÆ
);

2579  
ªt
;

2581 
u∆ock_ªloc
:

2582 
	`muãx_u∆ock
(&
fs_öfo
->
ªloc_muãx
);

2583 
	`båfs_å™s_°©e_lockdï_ªÀa£
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_UNBLOCKED
);

2584 
s¸ub_c⁄töue
:

2585 
	`båfs_å™s_°©e_lockdï_ªÀa£
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_SUPER_COMMITTED
);

2586 
	`båfs_å™s_°©e_lockdï_ªÀa£
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_COMPLETED
);

2587 
	`båfs_s¸ub_c⁄töue
(
fs_öfo
);

2588 
˛ónup_å™ß˘i⁄
:

2589 
	`båfs_å™s_ªÀa£_mëad©a
(
å™s
);

2590 
	`båfs_˛ónup_≥ndög_block_groups
(
å™s
);

2591 
	`båfs_å™s_ªÀa£_chunk_mëad©a
(
å™s
);

2592 
å™s
->
block_rsv
 = 
NULL
;

2593 
	`båfs_w¨n
(
fs_öfo
, "Skipping commit ofábortedÅransaction.");

2594 i‡(
cuºít
->
jou∫Æ_öfo
 =
å™s
)

2595 
cuºít
->
jou∫Æ_öfo
 = 
NULL
;

2596 
	`˛ónup_å™ß˘i⁄
(
å™s
, 
ªt
);

2598  
ªt
;

2600 
lockdï_ªÀa£
:

2601 
	`båfs_lockdï_ªÀa£
(
fs_öfo
, 
båfs_å™s_num_extwrôîs
);

2602 
	`båfs_lockdï_ªÀa£
(
fs_öfo
, 
båfs_å™s_num_wrôîs
);

2603 
˛ónup_å™ß˘i⁄
;

2605 
lockdï_å™s_commô_°¨t_ªÀa£
:

2606 
	`båfs_å™s_°©e_lockdï_ªÀa£
(
fs_öfo
, 
BTRFS_LOCKDEP_TRANS_COMMIT_PREP
);

2607 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

2608  
ªt
;

2609 
	}
}

2621 
	$båfs_˛ón_⁄e_dñëed_¢≠shŸ
(
båfs_fs_öfo
 *
fs_öfo
)

2623 
båfs_roŸ
 *
roŸ
;

2624 
ªt
;

2626 
	`•ö_lock
(&
fs_öfo
->
å™s_lock
);

2627 i‡(
	`li°_em±y
(&
fs_öfo
->
dód_roŸs
)) {

2628 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

2631 
roŸ
 = 
	`li°_fú°_íåy
(&
fs_öfo
->
dód_roŸs
,

2632 
båfs_roŸ
, 
roŸ_li°
);

2633 
	`li°_dñ_öô
(&
roŸ
->
roŸ_li°
);

2634 
	`•ö_u∆ock
(&
fs_öfo
->
å™s_lock
);

2636 
	`båfs_debug
(
fs_öfo
, "˛ó√∏ªmovög %Œu", 
roŸ
->
roŸ_key
.
obje˘id
);

2638 
	`båfs_kûl_Æl_dñayed_nodes
(
roŸ
);

2640 i‡(
	`båfs_hódî_backªf_ªv
(
roŸ
->
node
) <

2641 
BTRFS_MIXED_BACKREF_REV
)

2642 
ªt
 = 
	`båfs_dr›_¢≠shŸ
(
roŸ
, 0, 0);

2644 
ªt
 = 
	`båfs_dr›_¢≠shŸ
(
roŸ
, 1, 0);

2646 
	`båfs_put_roŸ
(
roŸ
);

2647  (
ªt
 < 0) ? 0 : 1;

2648 
	}
}

2663 
__cﬁd
 
	$__båfs_ab‹t_å™ß˘i⁄
(
båfs_å™s_h™dÀ
 *
å™s
,

2664 c⁄° *
fun˘i⁄
,

2665 
löe
, 
î∫o
, 
boﬁ
 
fú°_hô
)

2667 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2669 
	`WRITE_ONCE
(
å™s
->
ab‹ãd
, 
î∫o
);

2670 
	`WRITE_ONCE
(
å™s
->
å™ß˘i⁄
->
ab‹ãd
, 
î∫o
);

2671 i‡(
fú°_hô
 && 
î∫o
 =-
ENOSPC
)

2672 
	`båfs_dump_•a˚_öfo_f‹_å™s_ab‹t
(
fs_öfo
);

2674 
	`wake_up
(&
fs_öfo
->
å™ß˘i⁄_waô
);

2675 
	`wake_up
(&
fs_öfo
->
å™ß˘i⁄_blocked_waô
);

2676 
	`__båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
fun˘i⁄
, 
löe
, 
î∫o
, 
NULL
);

2677 
	}
}

2679 
__öô
 
	$båfs_å™ß˘i⁄_öô
()

2681 
båfs_å™s_h™dÀ_ˇchï
 = 
	`kmem_ˇche_¸óã
("btrfs_trans_handle",

2682 (
båfs_å™s_h™dÀ
), 0,

2683 
SLAB_TEMPORARY
 | 
SLAB_MEM_SPREAD
, 
NULL
);

2684 i‡(!
båfs_å™s_h™dÀ_ˇchï
)

2685  -
ENOMEM
;

2687 
	}
}

2689 
__cﬁd
 
	$båfs_å™ß˘i⁄_exô
()

2691 
	`kmem_ˇche_de°roy
(
båfs_å™s_h™dÀ_ˇchï
);

2692 
	}
}

	@transaction.h

6 #i‚de‡
BTRFS_TRANSACTION_H


7 
	#BTRFS_TRANSACTION_H


	)

9 
	~<löux/ªfcou¡.h
>

10 
	~"båfs_öode.h
"

11 
	~"dñayed-ªf.h
"

12 
	~"˘ªe.h
"

13 
	~"misc.h
"

15 
	ebåfs_å™s_°©e
 {

16 
	mTRANS_STATE_RUNNING
,

17 
	mTRANS_STATE_COMMIT_PREP
,

18 
	mTRANS_STATE_COMMIT_START
,

19 
	mTRANS_STATE_COMMIT_DOING
,

20 
	mTRANS_STATE_UNBLOCKED
,

21 
	mTRANS_STATE_SUPER_COMMITTED
,

22 
	mTRANS_STATE_COMPLETED
,

23 
	mTRANS_STATE_MAX
,

26 
	#BTRFS_TRANS_HAVE_FREE_BGS
 0

	)

27 
	#BTRFS_TRANS_DIRTY_BG_RUN
 1

	)

28 
	#BTRFS_TRANS_CACHE_ENOSPC
 2

	)

30 
	sbåfs_å™ß˘i⁄
 {

31 
u64
 
	må™sid
;

37 
©omic_t
 
	mnum_extwrôîs
;

42 
©omic_t
 
	mnum_wrôîs
;

43 
ªfcou¡_t
 
	mu£_cou¡
;

45 
	mÊags
;

48 
båfs_å™s_°©e
 
	m°©e
;

49 
	mab‹ãd
;

50 
li°_hód
 
	mli°
;

51 
exã¡_io_åì
 
	mdúty_∑ges
;

52 
time64_t
 
	m°¨t_time
;

53 
waô_queue_hód_t
 
	mwrôî_waô
;

54 
waô_queue_hód_t
 
	mcommô_waô
;

55 
li°_hód
 
	m≥ndög_¢≠shŸs
;

56 
li°_hód
 
	mdev_upd©e_li°
;

57 
li°_hód
 
	mswôch_commôs
;

58 
li°_hód
 
	mdúty_bgs
;

75 
li°_hód
 
	mio_bgs
;

76 
li°_hód
 
	mdr›≥d_roŸs
;

77 
exã¡_io_åì
 
	mpö√d_exã¡s
;

84 
muãx
 
	mˇche_wrôe_muãx
;

85 
•ölock_t
 
	mdúty_bgs_lock
;

87 
li°_hód
 
	mdñëed_bgs
;

88 
•ölock_t
 
	mdr›≥d_roŸs_lock
;

89 
båfs_dñayed_ªf_roŸ
 
	mdñayed_ªfs
;

90 
båfs_fs_öfo
 *
	mfs_öfo
;

96 
©omic_t
 
	m≥ndög_‹dîed
;

97 
waô_queue_hód_t
 
	m≥ndög_waô
;

101 
ENUM_BIT
(
__TRANS_FREEZABLE
),

102 
ENUM_BIT
(
__TRANS_START
),

103 
ENUM_BIT
(
__TRANS_ATTACH
),

104 
ENUM_BIT
(
__TRANS_JOIN
),

105 
ENUM_BIT
(
__TRANS_JOIN_NOLOCK
),

106 
ENUM_BIT
(
__TRANS_DUMMY
),

107 
ENUM_BIT
(
__TRANS_JOIN_NOSTART
),

110 
	#TRANS_START
 (
__TRANS_START
 | 
__TRANS_FREEZABLE
)

	)

111 
	#TRANS_ATTACH
 (
__TRANS_ATTACH
)

	)

112 
	#TRANS_JOIN
 (
__TRANS_JOIN
 | 
__TRANS_FREEZABLE
)

	)

113 
	#TRANS_JOIN_NOLOCK
 (
__TRANS_JOIN_NOLOCK
)

	)

114 
	#TRANS_JOIN_NOSTART
 (
__TRANS_JOIN_NOSTART
)

	)

116 
	#TRANS_EXTWRITERS
 (
__TRANS_START
 | 
__TRANS_ATTACH
)

	)

118 
	sbåfs_å™s_h™dÀ
 {

119 
u64
 
	må™sid
;

120 
u64
 
	mbyãs_ª£rved
;

121 
u64
 
	mchunk_byãs_ª£rved
;

122 
	mdñayed_ªf_upd©es
;

123 
båfs_å™ß˘i⁄
 *
	må™ß˘i⁄
;

124 
båfs_block_rsv
 *
	mblock_rsv
;

125 
båfs_block_rsv
 *
	m‹ig_rsv
;

127 
båfs_≥ndög_¢≠shŸ
 *
	m≥ndög_¢≠shŸ
;

128 
ªfcou¡_t
 
	mu£_cou¡
;

129 
	mty≥
;

134 
	mab‹ãd
;

135 
boﬁ
 
	maddög_csums
;

136 
boﬁ
 
	mÆloˇtög_chunk
;

137 
boﬁ
 
	mªmovög_chunk
;

138 
boﬁ
 
	mªloc_ª£rved
;

139 
boﬁ
 
	mö_fsync
;

140 
båfs_fs_öfo
 *
	mfs_öfo
;

141 
li°_hód
 
	m√w_bgs
;

150 
	#TRANS_ABORTED
(
å™s
Ë(
	`u∆ikñy
(
	`READ_ONCE
(—øns)->
ab‹ãd
)))

	)

152 
	sbåfs_≥ndög_¢≠shŸ
 {

153 
díåy
 *
	mdíåy
;

154 
öode
 *
	mdú
;

155 
båfs_roŸ
 *
	mroŸ
;

156 
båfs_roŸ_ôem
 *
	mroŸ_ôem
;

157 
båfs_roŸ
 *
	m¢≠
;

158 
båfs_qgroup_öhîô
 *
	möhîô
;

159 
båfs_∑th
 *
	m∑th
;

161 
båfs_block_rsv
 
	mblock_rsv
;

163 
	mîr‹
;

165 
dev_t
 
	m™⁄_dev
;

166 
boﬁ
 
	mªad⁄ly
;

167 
li°_hód
 
	mli°
;

170 
ölöe
 
	$båfs_£t_öode_œ°_å™s
(
båfs_å™s_h™dÀ
 *
å™s
,

171 
båfs_öode
 *
öode
)

173 
	`•ö_lock
(&
öode
->
lock
);

174 
öode
->
œ°_å™s
 = 
å™s
->
å™ß˘i⁄
->
å™sid
;

175 
öode
->
œ°_sub_å™s
 = inode->
roŸ
->
log_å™sid
;

176 
öode
->
œ°_log_commô
 = inode->
œ°_sub_å™s
 - 1;

177 
	`•ö_u∆ock
(&
öode
->
lock
);

178 
	}
}

184 
ölöe
 
	$båfs_£t_skù_qgroup
(
båfs_å™s_h™dÀ
 *
å™s
,

185 
u64
 
qgroupid
)

187 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
;

189 
dñayed_ªfs
 = &
å™s
->
å™ß˘i⁄
->delayed_refs;

190 
	`WARN_ON
(
dñayed_ªfs
->
qgroup_to_skù
);

191 
dñayed_ªfs
->
qgroup_to_skù
 = 
qgroupid
;

192 
	}
}

194 
ölöe
 
	$båfs_˛ór_skù_qgroup
(
båfs_å™s_h™dÀ
 *
å™s
)

196 
båfs_dñayed_ªf_roŸ
 *
dñayed_ªfs
;

198 
dñayed_ªfs
 = &
å™s
->
å™ß˘i⁄
->delayed_refs;

199 
	`WARN_ON
(!
dñayed_ªfs
->
qgroup_to_skù
);

200 
dñayed_ªfs
->
qgroup_to_skù
 = 0;

201 
	}
}

203 
boﬁ
 
__cﬁd
 
ab‹t_should_¥öt_°ack
(
î∫o
);

209 
	#båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
î∫o
) \

211 
boﬁ
 
fú°
 = 
Ál£
; \

213 i‡(!
	`ã°_™d_£t_bô
(
BTRFS_FS_STATE_TRANS_ABORTED
, \

214 &((
å™s
)->
fs_öfo
->
fs_°©e
))) { \

215 
fú°
 = 
åue
; \

216 i‡(
	`WARN
(
	`ab‹t_should_¥öt_°ack
(
î∫o
), \

217 
KERN_ERR
 \

219 (
î∫o
))) { \

222 
	`båfs_îr
((
å™s
)->
fs_öfo
, \

224 (
î∫o
)); \

227 
	`__båfs_ab‹t_å™ß˘i⁄
((
å™s
), 
__func__
, \

228 
__LINE__
, (
î∫o
), 
fú°
); \

229 } 0)

	)

231 
båfs_íd_å™ß˘i⁄
(
båfs_å™s_h™dÀ
 *
å™s
);

232 
båfs_å™s_h™dÀ
 *
båfs_°¨t_å™ß˘i⁄
(
båfs_roŸ
 *
roŸ
,

233 
num_ôems
);

234 
båfs_å™s_h™dÀ
 *
båfs_°¨t_å™ß˘i⁄_ÁŒback_globÆ_rsv
(

235 
båfs_roŸ
 *
roŸ
,

236 
num_ôems
);

237 
båfs_å™s_h™dÀ
 *
båfs_joö_å™ß˘i⁄
(
båfs_roŸ
 *
roŸ
);

238 
båfs_å™s_h™dÀ
 *
båfs_joö_å™ß˘i⁄_•a˚ˇche
(
båfs_roŸ
 *
roŸ
);

239 
båfs_å™s_h™dÀ
 *
båfs_joö_å™ß˘i⁄_no°¨t
(
båfs_roŸ
 *
roŸ
);

240 
båfs_å™s_h™dÀ
 *
båfs_©èch_å™ß˘i⁄
(
båfs_roŸ
 *
roŸ
);

241 
båfs_å™s_h™dÀ
 *
båfs_©èch_å™ß˘i⁄_b¨rõr
(

242 
båfs_roŸ
 *
roŸ
);

243 
båfs_waô_f‹_commô
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
å™sid
);

245 
båfs_add_dód_roŸ
(
båfs_roŸ
 *
roŸ
);

246 
båfs_de‰ag_roŸ
(
båfs_roŸ
 *
roŸ
);

247 
båfs_maybe_wake_unföished_dr›
(
båfs_fs_öfo
 *
fs_öfo
);

248 
båfs_˛ón_⁄e_dñëed_¢≠shŸ
(
båfs_fs_öfo
 *
fs_öfo
);

249 
båfs_commô_å™ß˘i⁄
(
båfs_å™s_h™dÀ
 *
å™s
);

250 
båfs_commô_å™ß˘i⁄_async
(
båfs_å™s_h™dÀ
 *
å™s
);

251 
båfs_íd_å™ß˘i⁄_thrŸée
(
båfs_å™s_h™dÀ
 *
å™s
);

252 
boﬁ
 
båfs_should_íd_å™ß˘i⁄
(
båfs_å™s_h™dÀ
 *
å™s
);

253 
båfs_thrŸée
(
båfs_fs_öfo
 *
fs_öfo
);

254 
båfs_ªc‹d_roŸ_ö_å™s
(
båfs_å™s_h™dÀ
 *
å™s
,

255 
båfs_roŸ
 *
roŸ
);

256 
båfs_wrôe_m¨ked_exã¡s
(
båfs_fs_öfo
 *
fs_öfo
,

257 
exã¡_io_åì
 *
dúty_∑ges
, 
m¨k
);

258 
båfs_waô_åì_log_exã¡s
(
båfs_roŸ
 *
roŸ
, 
m¨k
);

259 
båfs_å™ß˘i⁄_blocked
(
båfs_fs_öfo
 *
öfo
);

260 
båfs_å™ß˘i⁄_ö_commô
(
båfs_fs_öfo
 *
öfo
);

261 
båfs_put_å™ß˘i⁄
(
båfs_å™ß˘i⁄
 *
å™ß˘i⁄
);

262 
båfs_add_dr›≥d_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

263 
båfs_roŸ
 *
roŸ
);

264 
båfs_å™s_ªÀa£_chunk_mëad©a
(
båfs_å™s_h™dÀ
 *
å™s
);

265 
__cﬁd
 
__båfs_ab‹t_å™ß˘i⁄
(
båfs_å™s_h™dÀ
 *
å™s
,

266 c⁄° *
fun˘i⁄
,

267 
löe
, 
î∫o
, 
boﬁ
 
fú°_hô
);

269 
__öô
 
båfs_å™ß˘i⁄_öô
();

270 
__cﬁd
 
båfs_å™ß˘i⁄_exô
();

	@tree-checker.c

18 
	~<löux/ty≥s.h
>

19 
	~<löux/°ddef.h
>

20 
	~<löux/îr‹-öje˘i⁄.h
>

21 
	~"mesßges.h
"

22 
	~"˘ªe.h
"

23 
	~"åì-checkî.h
"

24 
	~"disk-io.h
"

25 
	~"com¥essi⁄.h
"

26 
	~"vﬁumes.h
"

27 
	~"misc.h
"

28 
	~"fs.h
"

29 
	~"ac˚ss‹s.h
"

30 
	~"fûe-ôem.h
"

31 
	~"öode-ôem.h
"

53 
	$__¥ötf
(3, 4)

54 
__cﬁd


55 
	$gíîic_îr
(c⁄° 
exã¡_buf„r
 *
eb
, 
¶Ÿ
,

56 c⁄° *
fmt
, ...)

58 c⁄° 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

59 
va_f‹m©
 
vaf
;

60 
va_li°
 
¨gs
;

62 
	`va_°¨t
(
¨gs
, 
fmt
);

64 
vaf
.
fmt
 = fmt;

65 
vaf
.
va
 = &
¨gs
;

67 
	`båfs_¸ô
(
fs_öfo
,

69 
	`båfs_hódî_Àvñ
(
eb
) == 0 ? "leaf" : "node",

70 
	`båfs_hódî_ow√r
(
eb
), 
	`båfs_hódî_byãƒ
”b), 
¶Ÿ
, &
vaf
);

71 
	`va_íd
(
¨gs
);

72 
	}
}

78 
	$__¥ötf
(3, 4)

79 
__cﬁd


80 
	$fûe_exã¡_îr
(c⁄° 
exã¡_buf„r
 *
eb
, 
¶Ÿ
,

81 c⁄° *
fmt
, ...)

83 c⁄° 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

84 
båfs_key
 
key
;

85 
va_f‹m©
 
vaf
;

86 
va_li°
 
¨gs
;

88 
	`båfs_ôem_key_to_˝u
(
eb
, &
key
, 
¶Ÿ
);

89 
	`va_°¨t
(
¨gs
, 
fmt
);

91 
vaf
.
fmt
 = fmt;

92 
vaf
.
va
 = &
¨gs
;

94 
	`båfs_¸ô
(
fs_öfo
,

96 
	`båfs_hódî_Àvñ
(
eb
) == 0 ? "leaf" : "node",

97 
	`båfs_hódî_ow√r
(
eb
), 
	`båfs_hódî_byãƒ
”b), 
¶Ÿ
,

98 
key
.
obje˘id
, key.
off£t
, &
vaf
);

99 
	`va_íd
(
¨gs
);

100 
	}
}

106 
	#CHECK_FE_ALIGNED
(
Àaf
, 
¶Ÿ
, 
fi
, 
«me
, 
Æignmít
) \

108 i‡(
	`u∆ikñy
(!
	`IS_ALIGNED
(
båfs_fûe_exã¡_
##
	`«me
((
Àaf
), (
fi
)), \

109 (
Æignmít
)))) \

110 
	`fûe_exã¡_îr
((
Àaf
), (
¶Ÿ
), \

112 (#«me), 
båfs_fûe_exã¡_
##
	`«me
((
Àaf
), (
fi
)), \

113 (
Æignmít
)); \

114 (!
	`IS_ALIGNED
(
båfs_fûe_exã¡_
##
	`«me
((
Àaf
), (
fi
)), (
Æignmít
))); \

115 })

	)

117 
u64
 
	$fûe_exã¡_íd
(
exã¡_buf„r
 *
Àaf
,

118 
båfs_key
 *
key
,

119 
båfs_fûe_exã¡_ôem
 *
exã¡
)

121 
u64
 
íd
;

122 
u64
 
Àn
;

124 i‡(
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
exã¡
Ë=
BTRFS_FILE_EXTENT_INLINE
) {

125 
Àn
 = 
	`båfs_fûe_exã¡_øm_byãs
(
Àaf
, 
exã¡
);

126 
íd
 = 
	`ALIGN
(
key
->
off£t
 + 
Àn
, 
Àaf
->
fs_öfo
->
£˘‹size
);

128 
Àn
 = 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
exã¡
);

129 
íd
 = 
key
->
off£t
 + 
Àn
;

131  
íd
;

132 
	}
}

138 
	$__¥ötf
(3, 4)

139 
__cﬁd


140 
	$dú_ôem_îr
(c⁄° 
exã¡_buf„r
 *
eb
, 
¶Ÿ
,

141 c⁄° *
fmt
, ...)

143 c⁄° 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

144 
båfs_key
 
key
;

145 
va_f‹m©
 
vaf
;

146 
va_li°
 
¨gs
;

148 
	`båfs_ôem_key_to_˝u
(
eb
, &
key
, 
¶Ÿ
);

149 
	`va_°¨t
(
¨gs
, 
fmt
);

151 
vaf
.
fmt
 = fmt;

152 
vaf
.
va
 = &
¨gs
;

154 
	`båfs_¸ô
(
fs_öfo
,

156 
	`båfs_hódî_Àvñ
(
eb
) == 0 ? "leaf" : "node",

157 
	`båfs_hódî_ow√r
(
eb
), 
	`båfs_hódî_byãƒ
”b), 
¶Ÿ
,

158 
key
.
obje˘id
, &
vaf
);

159 
	`va_íd
(
¨gs
);

160 
	}
}

171 
boﬁ
 
	$check_¥ev_öo
(
exã¡_buf„r
 *
Àaf
,

172 
båfs_key
 *
key
, 
¶Ÿ
,

173 
båfs_key
 *
¥ev_key
)

176 i‡(
¶Ÿ
 == 0)

177  
åue
;

180 
	`ASSERT
(
key
->
ty≥
 =
BTRFS_XATTR_ITEM_KEY
 ||

181 
key
->
ty≥
 =
BTRFS_INODE_REF_KEY
 ||

182 
key
->
ty≥
 =
BTRFS_DIR_INDEX_KEY
 ||

183 
key
->
ty≥
 =
BTRFS_DIR_ITEM_KEY
 ||

184 
key
->
ty≥
 =
BTRFS_EXTENT_DATA_KEY
);

190 i‡(!
	`is_f°ªe
(
	`båfs_hódî_ow√r
(
Àaf
)))

191  
åue
;

193 i‡(
key
->
obje˘id
 =
¥ev_key
->objectid)

194  
åue
;

197 
	`dú_ôem_îr
(
Àaf
, 
¶Ÿ
,

199 
¥ev_key
->
obje˘id
, 
key
->objectid);

200  
Ál£
;

201 
	}
}

202 
	$check_exã¡_d©a_ôem
(
exã¡_buf„r
 *
Àaf
,

203 
båfs_key
 *
key
, 
¶Ÿ
,

204 
båfs_key
 *
¥ev_key
)

206 
båfs_fs_öfo
 *
fs_öfo
 = 
Àaf
->fs_info;

207 
båfs_fûe_exã¡_ôem
 *
fi
;

208 
u32
 
£˘‹size
 = 
fs_öfo
->sectorsize;

209 
u32
 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

210 
u64
 
exã¡_íd
;

212 i‡(
	`u∆ikñy
(!
	`IS_ALIGNED
(
key
->
off£t
, 
£˘‹size
))) {

213 
	`fûe_exã¡_îr
(
Àaf
, 
¶Ÿ
,

215 
key
->
off£t
, 
£˘‹size
);

216  -
EUCLEAN
;

225 i‡(
	`u∆ikñy
(!
	`check_¥ev_öo
(
Àaf
, 
key
, 
¶Ÿ
, 
¥ev_key
)))

226  -
EUCLEAN
;

228 
fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_fûe_exã¡_ôem
);

234 i‡(
	`u∆ikñy
(
ôem_size
 < 
BTRFS_FILE_EXTENT_INLINE_DATA_START
)) {

235 
	`fûe_exã¡_îr
(
Àaf
, 
¶Ÿ
,

237 
ôem_size
, 
BTRFS_FILE_EXTENT_INLINE_DATA_START
,

238 
SZ_4K
);

239  -
EUCLEAN
;

241 i‡(
	`u∆ikñy
(
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
fi
) >=

242 
BTRFS_NR_FILE_EXTENT_TYPES
)) {

243 
	`fûe_exã¡_îr
(
Àaf
, 
¶Ÿ
,

245 
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
fi
),

246 
BTRFS_NR_FILE_EXTENT_TYPES
 - 1);

247  -
EUCLEAN
;

254 i‡(
	`u∆ikñy
(
	`båfs_fûe_exã¡_com¥essi⁄
(
Àaf
, 
fi
) >=

255 
BTRFS_NR_COMPRESS_TYPES
)) {

256 
	`fûe_exã¡_îr
(
Àaf
, 
¶Ÿ
,

258 
	`båfs_fûe_exã¡_com¥essi⁄
(
Àaf
, 
fi
),

259 
BTRFS_NR_COMPRESS_TYPES
 - 1);

260  -
EUCLEAN
;

262 i‡(
	`u∆ikñy
(
	`båfs_fûe_exã¡_í¸y±i⁄
(
Àaf
, 
fi
))) {

263 
	`fûe_exã¡_îr
(
Àaf
, 
¶Ÿ
,

265 
	`båfs_fûe_exã¡_í¸y±i⁄
(
Àaf
, 
fi
));

266  -
EUCLEAN
;

268 i‡(
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
fi
Ë=
BTRFS_FILE_EXTENT_INLINE
) {

270 i‡(
	`u∆ikñy
(
key
->
off£t
)) {

271 
	`fûe_exã¡_îr
(
Àaf
, 
¶Ÿ
,

273 
key
->
off£t
);

274  -
EUCLEAN
;

278 i‡(
	`båfs_fûe_exã¡_com¥essi⁄
(
Àaf
, 
fi
) !=

279 
BTRFS_COMPRESS_NONE
)

283 i‡(
	`u∆ikñy
(
ôem_size
 !
BTRFS_FILE_EXTENT_INLINE_DATA_START
 +

284 
	`båfs_fûe_exã¡_øm_byãs
(
Àaf
, 
fi
))) {

285 
	`fûe_exã¡_îr
(
Àaf
, 
¶Ÿ
,

287 
ôem_size
, 
BTRFS_FILE_EXTENT_INLINE_DATA_START
 +

288 
	`båfs_fûe_exã¡_øm_byãs
(
Àaf
, 
fi
));

289  -
EUCLEAN
;

295 i‡(
	`u∆ikñy
(
ôem_size
 !(*
fi
))) {

296 
	`fûe_exã¡_îr
(
Àaf
, 
¶Ÿ
,

298 
ôem_size
, (*
fi
));

299  -
EUCLEAN
;

301 i‡(
	`u∆ikñy
(
	`CHECK_FE_ALIGNED
(
Àaf
, 
¶Ÿ
, 
fi
, 
øm_byãs
, 
£˘‹size
) ||

302 
	`CHECK_FE_ALIGNED
(
Àaf
, 
¶Ÿ
, 
fi
, 
disk_byãƒ
, 
£˘‹size
) ||

303 
	`CHECK_FE_ALIGNED
(
Àaf
, 
¶Ÿ
, 
fi
, 
disk_num_byãs
, 
£˘‹size
) ||

304 
	`CHECK_FE_ALIGNED
(
Àaf
, 
¶Ÿ
, 
fi
, 
off£t
, 
£˘‹size
) ||

305 
	`CHECK_FE_ALIGNED
(
Àaf
, 
¶Ÿ
, 
fi
, 
num_byãs
, 
£˘‹size
)))

306  -
EUCLEAN
;

309 i‡(
	`u∆ikñy
(
	`check_add_ovîÊow
(
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
fi
),

310 
key
->
off£t
, &
exã¡_íd
))) {

311 
	`fûe_exã¡_îr
(
Àaf
, 
¶Ÿ
,

313 
key
->
off£t
,

314 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
fi
));

315  -
EUCLEAN
;

322 i‡(
¶Ÿ
 > 0 &&

323 
¥ev_key
->
obje˘id
 =
key
->objectid &&

324 
¥ev_key
->
ty≥
 =
BTRFS_EXTENT_DATA_KEY
) {

325 
båfs_fûe_exã¡_ôem
 *
¥ev_fi
;

326 
u64
 
¥ev_íd
;

328 
¥ev_fi
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
 - 1,

329 
båfs_fûe_exã¡_ôem
);

330 
¥ev_íd
 = 
	`fûe_exã¡_íd
(
Àaf
, 
¥ev_key
, 
¥ev_fi
);

331 i‡(
	`u∆ikñy
(
¥ev_íd
 > 
key
->
off£t
)) {

332 
	`fûe_exã¡_îr
(
Àaf
, 
¶Ÿ
 - 1,

334 
¥ev_íd
, 
key
->
off£t
);

335  -
EUCLEAN
;

340 
	}
}

342 
	$check_csum_ôem
(
exã¡_buf„r
 *
Àaf
, 
båfs_key
 *
key
,

343 
¶Ÿ
, 
båfs_key
 *
¥ev_key
)

345 
båfs_fs_öfo
 *
fs_öfo
 = 
Àaf
->fs_info;

346 
u32
 
£˘‹size
 = 
fs_öfo
->sectorsize;

347 c⁄° 
u32
 
csumsize
 = 
fs_öfo
->
csum_size
;

349 i‡(
	`u∆ikñy
(
key
->
obje˘id
 !
BTRFS_EXTENT_CSUM_OBJECTID
)) {

350 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

352 
key
->
obje˘id
, 
BTRFS_EXTENT_CSUM_OBJECTID
);

353  -
EUCLEAN
;

355 i‡(
	`u∆ikñy
(!
	`IS_ALIGNED
(
key
->
off£t
, 
£˘‹size
))) {

356 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

358 
key
->
off£t
, 
£˘‹size
);

359  -
EUCLEAN
;

361 i‡(
	`u∆ikñy
(!
	`IS_ALIGNED
(
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
), 
csumsize
))) {

362 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

364 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
), 
csumsize
);

365  -
EUCLEAN
;

367 i‡(
¶Ÿ
 > 0 && 
¥ev_key
->
ty≥
 =
BTRFS_EXTENT_CSUM_KEY
) {

368 
u64
 
¥ev_csum_íd
;

369 
u32
 
¥ev_ôem_size
;

371 
¥ev_ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
 - 1);

372 
¥ev_csum_íd
 = (
¥ev_ôem_size
 / 
csumsize
Ë* 
£˘‹size
;

373 
¥ev_csum_íd
 +
¥ev_key
->
off£t
;

374 i‡(
	`u∆ikñy
(
¥ev_csum_íd
 > 
key
->
off£t
)) {

375 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
 - 1,

377 
¥ev_csum_íd
, 
key
->
off£t
);

378  -
EUCLEAN
;

382 
	}
}

385 
	#öode_ôem_îr
(
eb
, 
¶Ÿ
, 
fmt
, ...) \

386 
	`dú_ôem_îr
(
eb
, 
¶Ÿ
, 
fmt
, 
__VA_ARGS__
)

	)

388 
	$check_öode_key
(
exã¡_buf„r
 *
Àaf
, 
båfs_key
 *
key
,

389 
¶Ÿ
)

391 
båfs_key
 
ôem_key
;

392 
boﬁ
 
is_öode_ôem
;

394 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
ôem_key
, 
¶Ÿ
);

395 
is_öode_ôem
 = (
ôem_key
.
ty≥
 =
BTRFS_INODE_ITEM_KEY
);

398 i‡(
ôem_key
.
ty≥
 =
BTRFS_XATTR_ITEM_KEY
) {

399 i‡(
	`u∆ikñy
(
key
->
obje˘id
 !0 || key->
ty≥
 != 0 ||

400 
key
->
off£t
 != 0))

401  -
EUCLEAN
;

405 i‡(
	`u∆ikñy
((
key
->
obje˘id
 < 
BTRFS_FIRST_FREE_OBJECTID
 ||

406 
key
->
obje˘id
 > 
BTRFS_LAST_FREE_OBJECTID
) &&

407 
key
->
obje˘id
 !
BTRFS_ROOT_TREE_DIR_OBJECTID
 &&

408 
key
->
obje˘id
 !
BTRFS_FREE_INO_OBJECTID
)) {

409 i‡(
is_öode_ôem
) {

410 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

412 
key
->
obje˘id
, 
BTRFS_ROOT_TREE_DIR_OBJECTID
,

413 
BTRFS_FIRST_FREE_OBJECTID
,

414 
BTRFS_LAST_FREE_OBJECTID
,

415 
BTRFS_FREE_INO_OBJECTID
);

417 
	`dú_ôem_îr
(
Àaf
, 
¶Ÿ
,

419 
key
->
obje˘id
, 
BTRFS_ROOT_TREE_DIR_OBJECTID
,

420 
BTRFS_FIRST_FREE_OBJECTID
,

421 
BTRFS_LAST_FREE_OBJECTID
,

422 
BTRFS_FREE_INO_OBJECTID
);

424  -
EUCLEAN
;

426 i‡(
	`u∆ikñy
(
key
->
off£t
 != 0)) {

427 i‡(
is_öode_ôem
)

428 
	`öode_ôem_îr
(
Àaf
, 
¶Ÿ
,

430 
key
->
off£t
);

432 
	`dú_ôem_îr
(
Àaf
, 
¶Ÿ
,

434 
key
->
off£t
);

435  -
EUCLEAN
;

438 
	}
}

440 
	$check_roŸ_key
(
exã¡_buf„r
 *
Àaf
, 
båfs_key
 *
key
,

441 
¶Ÿ
)

443 
båfs_key
 
ôem_key
;

444 
boﬁ
 
is_roŸ_ôem
;

446 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
ôem_key
, 
¶Ÿ
);

447 
is_roŸ_ôem
 = (
ôem_key
.
ty≥
 =
BTRFS_ROOT_ITEM_KEY
);

455 i‡(
	`u∆ikñy
(
is_roŸ_ôem
 && 
key
->
obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
 &&

456 !
	`is_f°ªe
(
key
->
off£t
))) {

457 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

459 
key
->
off£t
);

460  -
EUCLEAN
;

464 i‡(
	`u∆ikñy
(
key
->
obje˘id
 == 0)) {

465 i‡(
is_roŸ_ôem
)

466 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
, "invalidÑoot id 0");

468 
	`dú_ôem_îr
(
Àaf
, 
¶Ÿ
,

470  -
EUCLEAN
;

474 i‡(
	`u∆ikñy
(!
	`is_f°ªe
(
key
->
obje˘id
Ë&& !
is_roŸ_ôem
)) {

475 
	`dú_ôem_îr
(
Àaf
, 
¶Ÿ
,

477 
key
->
obje˘id
, 
BTRFS_FIRST_FREE_OBJECTID
,

478 
BTRFS_LAST_FREE_OBJECTID
);

479  -
EUCLEAN
;

490 i‡(
	`u∆ikñy
(
key
->
obje˘id
 =
BTRFS_TREE_RELOC_OBJECTID
 &&

491 
key
->
off£t
 == 0)) {

492 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
, "invalidÑoot id 0 forÑelocÅree");

493  -
EUCLEAN
;

496 
	}
}

498 
	$check_dú_ôem
(
exã¡_buf„r
 *
Àaf
,

499 
båfs_key
 *
key
, båfs_key *
¥ev_key
,

500 
¶Ÿ
)

502 
båfs_fs_öfo
 *
fs_öfo
 = 
Àaf
->fs_info;

503 
båfs_dú_ôem
 *
di
;

504 
u32
 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

505 
u32
 
cur
 = 0;

507 i‡(
	`u∆ikñy
(!
	`check_¥ev_öo
(
Àaf
, 
key
, 
¶Ÿ
, 
¥ev_key
)))

508  -
EUCLEAN
;

510 
di
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_dú_ôem
);

511 
cur
 < 
ôem_size
) {

512 
båfs_key
 
loˇti⁄_key
;

513 
u32
 
«me_Àn
;

514 
u32
 
d©a_Àn
;

515 
u32
 
max_«me_Àn
;

516 
u32
 
tŸÆ_size
;

517 
u32
 
«me_hash
;

518 
u8
 
dú_ty≥
;

519 
ªt
;

522 i‡(
	`u∆ikñy
(
cur
 + (*
di
Ë> 
ôem_size
)) {

523 
	`dú_ôem_îr
(
Àaf
, 
¶Ÿ
,

525 
cur
 + (*
di
), 
ôem_size
);

526  -
EUCLEAN
;

530 
	`båfs_dú_ôem_key_to_˝u
(
Àaf
, 
di
, &
loˇti⁄_key
);

531 i‡(
loˇti⁄_key
.
ty≥
 =
BTRFS_ROOT_ITEM_KEY
) {

532 
ªt
 = 
	`check_roŸ_key
(
Àaf
, &
loˇti⁄_key
, 
¶Ÿ
);

533 i‡(
	`u∆ikñy
(
ªt
 < 0))

534  
ªt
;

535 } i‡(
loˇti⁄_key
.
ty≥
 =
BTRFS_INODE_ITEM_KEY
 ||

536 
loˇti⁄_key
.
ty≥
 == 0) {

537 
ªt
 = 
	`check_öode_key
(
Àaf
, &
loˇti⁄_key
, 
¶Ÿ
);

538 i‡(
	`u∆ikñy
(
ªt
 < 0))

539  
ªt
;

541 
	`dú_ôem_îr
(
Àaf
, 
¶Ÿ
,

543 
loˇti⁄_key
.
ty≥
, 
BTRFS_ROOT_ITEM_KEY
,

544 
BTRFS_INODE_ITEM_KEY
);

545  -
EUCLEAN
;

549 
dú_ty≥
 = 
	`båfs_dú_·y≥
(
Àaf
, 
di
);

550 i‡(
	`u∆ikñy
(
dú_ty≥
 >
BTRFS_FT_MAX
)) {

551 
	`dú_ôem_îr
(
Àaf
, 
¶Ÿ
,

553 
dú_ty≥
, 
BTRFS_FT_MAX
);

554  -
EUCLEAN
;

557 i‡(
	`u∆ikñy
(
key
->
ty≥
 =
BTRFS_XATTR_ITEM_KEY
 &&

558 
dú_ty≥
 !
BTRFS_FT_XATTR
)) {

559 
	`dú_ôem_îr
(
Àaf
, 
¶Ÿ
,

561 
dú_ty≥
, 
BTRFS_FT_XATTR
);

562  -
EUCLEAN
;

564 i‡(
	`u∆ikñy
(
dú_ty≥
 =
BTRFS_FT_XATTR
 &&

565 
key
->
ty≥
 !
BTRFS_XATTR_ITEM_KEY
)) {

566 
	`dú_ôem_îr
(
Àaf
, 
¶Ÿ
,

568  -
EUCLEAN
;

570 i‡(
dú_ty≥
 =
BTRFS_FT_XATTR
)

571 
max_«me_Àn
 = 
XATTR_NAME_MAX
;

573 
max_«me_Àn
 = 
BTRFS_NAME_LEN
;

576 
«me_Àn
 = 
	`båfs_dú_«me_Àn
(
Àaf
, 
di
);

577 
d©a_Àn
 = 
	`båfs_dú_d©a_Àn
(
Àaf
, 
di
);

578 i‡(
	`u∆ikñy
(
«me_Àn
 > 
max_«me_Àn
)) {

579 
	`dú_ôem_îr
(
Àaf
, 
¶Ÿ
,

581 
«me_Àn
, 
max_«me_Àn
);

582  -
EUCLEAN
;

584 i‡(
	`u∆ikñy
(
«me_Àn
 + 
d©a_Àn
 > 
	`BTRFS_MAX_XATTR_SIZE
(
fs_öfo
))) {

585 
	`dú_ôem_îr
(
Àaf
, 
¶Ÿ
,

587 
«me_Àn
 + 
d©a_Àn
,

588 
	`BTRFS_MAX_XATTR_SIZE
(
fs_öfo
));

589  -
EUCLEAN
;

592 i‡(
	`u∆ikñy
(
d©a_Àn
 && 
dú_ty≥
 !
BTRFS_FT_XATTR
)) {

593 
	`dú_ôem_îr
(
Àaf
, 
¶Ÿ
,

595 
d©a_Àn
);

596  -
EUCLEAN
;

599 
tŸÆ_size
 = (*
di
Ë+ 
«me_Àn
 + 
d©a_Àn
;

602 i‡(
	`u∆ikñy
(
cur
 + 
tŸÆ_size
 > 
ôem_size
)) {

603 
	`dú_ôem_îr
(
Àaf
, 
¶Ÿ
,

605 
cur
 + 
tŸÆ_size
, 
ôem_size
);

606  -
EUCLEAN
;

613 i‡(
key
->
ty≥
 =
BTRFS_DIR_ITEM_KEY
 ||

614 
key
->
ty≥
 =
BTRFS_XATTR_ITEM_KEY
) {

615 
«mebuf
[
	`max
(
BTRFS_NAME_LEN
, 
XATTR_NAME_MAX
)];

617 
	`ªad_exã¡_buf„r
(
Àaf
, 
«mebuf
,

618 ()(
di
 + 1), 
«me_Àn
);

619 
«me_hash
 = 
	`båfs_«me_hash
(
«mebuf
, 
«me_Àn
);

620 i‡(
	`u∆ikñy
(
key
->
off£t
 !
«me_hash
)) {

621 
	`dú_ôem_îr
(
Àaf
, 
¶Ÿ
,

623 
«me_hash
, 
key
->
off£t
);

624  -
EUCLEAN
;

627 
cur
 +
tŸÆ_size
;

628 
di
 = (
båfs_dú_ôem
 *)((*)dò+ 
tŸÆ_size
);

631 
	}
}

633 
	$__¥ötf
(3, 4)

634 
__cﬁd


635 
	$block_group_îr
(c⁄° 
exã¡_buf„r
 *
eb
, 
¶Ÿ
,

636 c⁄° *
fmt
, ...)

638 c⁄° 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

639 
båfs_key
 
key
;

640 
va_f‹m©
 
vaf
;

641 
va_li°
 
¨gs
;

643 
	`båfs_ôem_key_to_˝u
(
eb
, &
key
, 
¶Ÿ
);

644 
	`va_°¨t
(
¨gs
, 
fmt
);

646 
vaf
.
fmt
 = fmt;

647 
vaf
.
va
 = &
¨gs
;

649 
	`båfs_¸ô
(
fs_öfo
,

651 
	`båfs_hódî_Àvñ
(
eb
) == 0 ? "leaf" : "node",

652 
	`båfs_hódî_ow√r
(
eb
), 
	`båfs_hódî_byãƒ
”b), 
¶Ÿ
,

653 
key
.
obje˘id
, key.
off£t
, &
vaf
);

654 
	`va_íd
(
¨gs
);

655 
	}
}

657 
	$check_block_group_ôem
(
exã¡_buf„r
 *
Àaf
,

658 
båfs_key
 *
key
, 
¶Ÿ
)

660 
båfs_fs_öfo
 *
fs_öfo
 = 
Àaf
->fs_info;

661 
båfs_block_group_ôem
 
bgi
;

662 
u32
 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

663 
u64
 
chunk_obje˘id
;

664 
u64
 
Êags
;

665 
u64
 
ty≥
;

671 i‡(
	`u∆ikñy
(
key
->
off£t
 == 0)) {

672 
	`block_group_îr
(
Àaf
, 
¶Ÿ
,

674  -
EUCLEAN
;

677 i‡(
	`u∆ikñy
(
ôem_size
 !(
bgi
))) {

678 
	`block_group_îr
(
Àaf
, 
¶Ÿ
,

680 
ôem_size
, (
bgi
));

681  -
EUCLEAN
;

684 
	`ªad_exã¡_buf„r
(
Àaf
, &
bgi
, 
	`båfs_ôem_±r_off£t
÷óf, 
¶Ÿ
),

685 (
bgi
));

686 
chunk_obje˘id
 = 
	`båfs_°ack_block_group_chunk_obje˘id
(&
bgi
);

687 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
EXTENT_TREE_V2
)) {

694 i‡(
	`u∆ikñy
(
fs_öfo
->
ƒ_globÆ_roŸs
 &&

695 
chunk_obje˘id
 >
fs_öfo
->
ƒ_globÆ_roŸs
)) {

696 
	`block_group_îr
(
Àaf
, 
¶Ÿ
,

698 
chunk_obje˘id
,

699 
fs_öfo
->
ƒ_globÆ_roŸs
);

700  -
EUCLEAN
;

702 } i‡(
	`u∆ikñy
(
chunk_obje˘id
 !
BTRFS_FIRST_CHUNK_TREE_OBJECTID
)) {

703 
	`block_group_îr
(
Àaf
, 
¶Ÿ
,

705 
	`båfs_°ack_block_group_chunk_obje˘id
(&
bgi
),

706 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
);

707  -
EUCLEAN
;

710 i‡(
	`u∆ikñy
(
	`båfs_°ack_block_group_u£d
(&
bgi
Ë> 
key
->
off£t
)) {

711 
	`block_group_îr
(
Àaf
, 
¶Ÿ
,

713 
	`båfs_°ack_block_group_u£d
(&
bgi
), 
key
->
off£t
);

714  -
EUCLEAN
;

717 
Êags
 = 
	`båfs_°ack_block_group_Êags
(&
bgi
);

718 i‡(
	`u∆ikñy
(
	`hweight64
(
Êags
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) > 1)) {

719 
	`block_group_îr
(
Àaf
, 
¶Ÿ
,

721 
Êags
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
,

722 
	`hweight64
(
Êags
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
));

723  -
EUCLEAN
;

726 
ty≥
 = 
Êags
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
;

727 i‡(
	`u∆ikñy
(
ty≥
 !
BTRFS_BLOCK_GROUP_DATA
 &&

728 
ty≥
 !
BTRFS_BLOCK_GROUP_METADATA
 &&

729 
ty≥
 !
BTRFS_BLOCK_GROUP_SYSTEM
 &&

730 
ty≥
 !(
BTRFS_BLOCK_GROUP_METADATA
 |

731 
BTRFS_BLOCK_GROUP_DATA
))) {

732 
	`block_group_îr
(
Àaf
, 
¶Ÿ
,

734 
ty≥
, 
	`hweight64
(type),

735 
BTRFS_BLOCK_GROUP_DATA
, 
BTRFS_BLOCK_GROUP_METADATA
,

736 
BTRFS_BLOCK_GROUP_SYSTEM
,

737 
BTRFS_BLOCK_GROUP_METADATA
 | 
BTRFS_BLOCK_GROUP_DATA
);

738  -
EUCLEAN
;

741 
	}
}

743 
	$__¥ötf
(4, 5)

744 
__cﬁd


745 
	$chunk_îr
(c⁄° 
exã¡_buf„r
 *
Àaf
,

746 c⁄° 
båfs_chunk
 *
chunk
, 
u64
 
logiˇl
,

747 c⁄° *
fmt
, ...)

749 c⁄° 
båfs_fs_öfo
 *
fs_öfo
 = 
Àaf
->fs_info;

750 
boﬁ
 
is_sb
;

751 
va_f‹m©
 
vaf
;

752 
va_li°
 
¨gs
;

753 
i
;

754 
¶Ÿ
 = -1;

757 
is_sb
 = (
Àaf
->
°¨t
 =
BTRFS_SUPER_INFO_OFFSET
);

759 i‡(!
is_sb
) {

764 
i
 = 0; i < 
	`båfs_hódî_ƒôems
(
Àaf
); i++) {

765 i‡(
	`båfs_ôem_±r_off£t
(
Àaf
, 
i
) ==

766 ()
chunk
) {

767 
¶Ÿ
 = 
i
;

772 
	`va_°¨t
(
¨gs
, 
fmt
);

773 
vaf
.
fmt
 = fmt;

774 
vaf
.
va
 = &
¨gs
;

776 i‡(
is_sb
)

777 
	`båfs_¸ô
(
fs_öfo
,

779 
logiˇl
, &
vaf
);

781 
	`båfs_¸ô
(
fs_öfo
,

783 
BTRFS_CHUNK_TREE_OBJECTID
, 
Àaf
->
°¨t
, 
¶Ÿ
,

784 
logiˇl
, &
vaf
);

785 
	`va_íd
(
¨gs
);

786 
	}
}

794 
	$båfs_check_chunk_vÆid
(
exã¡_buf„r
 *
Àaf
,

795 
båfs_chunk
 *
chunk
, 
u64
 
logiˇl
)

797 
båfs_fs_öfo
 *
fs_öfo
 = 
Àaf
->fs_info;

798 
u64
 
Àngth
;

799 
u64
 
chunk_íd
;

800 
u64
 
°rùe_Àn
;

801 
u16
 
num_°rùes
;

802 
u16
 
sub_°rùes
;

803 
u64
 
ty≥
;

804 
u64
 
„©uªs
;

805 
boﬁ
 
mixed
 = 
Ál£
;

806 
øid_ödex
;

807 
≈¨ôy
;

808 
nc›õs
;

810 
Àngth
 = 
	`båfs_chunk_Àngth
(
Àaf
, 
chunk
);

811 
°rùe_Àn
 = 
	`båfs_chunk_°rùe_Àn
(
Àaf
, 
chunk
);

812 
num_°rùes
 = 
	`båfs_chunk_num_°rùes
(
Àaf
, 
chunk
);

813 
sub_°rùes
 = 
	`båfs_chunk_sub_°rùes
(
Àaf
, 
chunk
);

814 
ty≥
 = 
	`båfs_chunk_ty≥
(
Àaf
, 
chunk
);

815 
øid_ödex
 = 
	`båfs_bg_Êags_to_øid_ödex
(
ty≥
);

816 
nc›õs
 = 
båfs_øid_¨øy
[
øid_ödex
].ncopies;

817 
≈¨ôy
 = 
båfs_øid_¨øy
[
øid_ödex
].nparity;

819 i‡(
	`u∆ikñy
(!
num_°rùes
)) {

820 
	`chunk_îr
(
Àaf
, 
chunk
, 
logiˇl
,

821 "övÆid chunkÇum_°rùes, havê%u", 
num_°rùes
);

822  -
EUCLEAN
;

824 i‡(
	`u∆ikñy
(
num_°rùes
 < 
nc›õs
)) {

825 
	`chunk_îr
(
Àaf
, 
chunk
, 
logiˇl
,

827 
num_°rùes
, 
nc›õs
);

828  -
EUCLEAN
;

830 i‡(
	`u∆ikñy
(
≈¨ôy
 && 
num_°rùes
 ==Çparity)) {

831 
	`chunk_îr
(
Àaf
, 
chunk
, 
logiˇl
,

833 
num_°rùes
, 
≈¨ôy
);

834  -
EUCLEAN
;

836 i‡(
	`u∆ikñy
(!
	`IS_ALIGNED
(
logiˇl
, 
fs_öfo
->
£˘‹size
))) {

837 
	`chunk_îr
(
Àaf
, 
chunk
, 
logiˇl
,

839 
logiˇl
, 
fs_öfo
->
£˘‹size
);

840  -
EUCLEAN
;

842 i‡(
	`u∆ikñy
(
	`båfs_chunk_£˘‹_size
(
Àaf
, 
chunk
Ë!
fs_öfo
->
£˘‹size
)) {

843 
	`chunk_îr
(
Àaf
, 
chunk
, 
logiˇl
,

845 
	`båfs_chunk_£˘‹_size
(
Àaf
, 
chunk
),

846 
fs_öfo
->
£˘‹size
);

847  -
EUCLEAN
;

849 i‡(
	`u∆ikñy
(!
Àngth
 || !
	`IS_ALIGNED
÷ígth, 
fs_öfo
->
£˘‹size
))) {

850 
	`chunk_îr
(
Àaf
, 
chunk
, 
logiˇl
,

851 "övÆid chunkÜígth, havê%Œu", 
Àngth
);

852  -
EUCLEAN
;

854 i‡(
	`u∆ikñy
(
	`check_add_ovîÊow
(
logiˇl
, 
Àngth
, &
chunk_íd
))) {

855 
	`chunk_îr
(
Àaf
, 
chunk
, 
logiˇl
,

857 
logiˇl
, 
Àngth
);

858  -
EUCLEAN
;

860 i‡(
	`u∆ikñy
(!
	`is_powî_of_2
(
°rùe_Àn
Ë|| såùe_À¿!
BTRFS_STRIPE_LEN
)) {

861 
	`chunk_îr
(
Àaf
, 
chunk
, 
logiˇl
,

863 
°rùe_Àn
);

864  -
EUCLEAN
;

874 i‡(
	`u∆ikñy
(
Àngth
 >
	`båfs_°rùe_ƒ_to_off£t
(
U32_MAX
))) {

875 
	`chunk_îr
(
Àaf
, 
chunk
, 
logiˇl
,

877 
Àngth
, 
	`båfs_°rùe_ƒ_to_off£t
(
U32_MAX
));

878  -
EUCLEAN
;

880 i‡(
	`u∆ikñy
(
ty≥
 & ~(
BTRFS_BLOCK_GROUP_TYPE_MASK
 |

881 
BTRFS_BLOCK_GROUP_PROFILE_MASK
))) {

882 
	`chunk_îr
(
Àaf
, 
chunk
, 
logiˇl
,

884 ~(
BTRFS_BLOCK_GROUP_TYPE_MASK
 |

885 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) &

886 
	`båfs_chunk_ty≥
(
Àaf
, 
chunk
));

887  -
EUCLEAN
;

890 i‡(
	`u∆ikñy
(!
	`has_sögÀ_bô_£t
(
ty≥
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) &&

891 (
ty≥
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) != 0)) {

892 
	`chunk_îr
(
Àaf
, 
chunk
, 
logiˇl
,

894 
ty≥
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
);

895  -
EUCLEAN
;

897 i‡(
	`u∆ikñy
((
ty≥
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
) == 0)) {

898 
	`chunk_îr
(
Àaf
, 
chunk
, 
logiˇl
,

900 
ty≥
, 
BTRFS_BLOCK_GROUP_TYPE_MASK
);

901  -
EUCLEAN
;

904 i‡(
	`u∆ikñy
((
ty≥
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) &&

905 (
ty≥
 & (
BTRFS_BLOCK_GROUP_METADATA
 |

906 
BTRFS_BLOCK_GROUP_DATA
)))) {

907 
	`chunk_îr
(
Àaf
, 
chunk
, 
logiˇl
,

909 
ty≥
);

910  -
EUCLEAN
;

913 
„©uªs
 = 
	`båfs_su≥r_öcom∑t_Êags
(
fs_öfo
->
su≥r_c›y
);

914 i‡(
„©uªs
 & 
BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
)

915 
mixed
 = 
åue
;

917 i‡(!
mixed
) {

918 i‡(
	`u∆ikñy
((
ty≥
 & 
BTRFS_BLOCK_GROUP_METADATA
) &&

919 (
ty≥
 & 
BTRFS_BLOCK_GROUP_DATA
))) {

920 
	`chunk_îr
(
Àaf
, 
chunk
, 
logiˇl
,

921 "mixed chunkÅy≥ i¿n⁄-mixed mode: 0x%Œx", 
ty≥
);

922  -
EUCLEAN
;

926 i‡(
	`u∆ikñy
((
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID10
 &&

927 
sub_°rùes
 !
båfs_øid_¨øy
[
BTRFS_RAID_RAID10
].sub_stripes) ||

928 (
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID1
 &&

929 
num_°rùes
 !
båfs_øid_¨øy
[
BTRFS_RAID_RAID1
].
devs_mö
) ||

930 (
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID1C3
 &&

931 
num_°rùes
 !
båfs_øid_¨øy
[
BTRFS_RAID_RAID1C3
].
devs_mö
) ||

932 (
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID1C4
 &&

933 
num_°rùes
 !
båfs_øid_¨øy
[
BTRFS_RAID_RAID1C4
].
devs_mö
) ||

934 (
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID5
 &&

935 
num_°rùes
 < 
båfs_øid_¨øy
[
BTRFS_RAID_RAID5
].
devs_mö
) ||

936 (
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID6
 &&

937 
num_°rùes
 < 
båfs_øid_¨øy
[
BTRFS_RAID_RAID6
].
devs_mö
) ||

938 (
ty≥
 & 
BTRFS_BLOCK_GROUP_DUP
 &&

939 
num_°rùes
 !
båfs_øid_¨øy
[
BTRFS_RAID_DUP
].
dev_°rùes
) ||

940 ((
ty≥
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) == 0 &&

941 
num_°rùes
 !
båfs_øid_¨øy
[
BTRFS_RAID_SINGLE
].
dev_°rùes
))) {

942 
	`chunk_îr
(
Àaf
, 
chunk
, 
logiˇl
,

944 
num_°rùes
, 
sub_°rùes
,

945 
ty≥
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
);

946  -
EUCLEAN
;

950 
	}
}

958 
	$check_Àaf_chunk_ôem
(
exã¡_buf„r
 *
Àaf
,

959 
båfs_chunk
 *
chunk
,

960 
båfs_key
 *
key
, 
¶Ÿ
)

962 
num_°rùes
;

964 i‡(
	`u∆ikñy
(
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
Ë< (
båfs_chunk
))) {

965 
	`chunk_îr
(
Àaf
, 
chunk
, 
key
->
off£t
,

967 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
),

968 (
båfs_chunk
),

969 
	`BTRFS_LEAF_DATA_SIZE
(
Àaf
->
fs_öfo
));

970  -
EUCLEAN
;

973 
num_°rùes
 = 
	`båfs_chunk_num_°rùes
(
Àaf
, 
chunk
);

975 i‡(
num_°rùes
 == 0)

976 
out
;

978 i‡(
	`u∆ikñy
(
	`båfs_chunk_ôem_size
(
num_°rùes
) !=

979 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
))) {

980 
	`chunk_îr
(
Àaf
, 
chunk
, 
key
->
off£t
,

982 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
),

983 
	`båfs_chunk_ôem_size
(
num_°rùes
));

984  -
EUCLEAN
;

986 
out
:

987  
	`båfs_check_chunk_vÆid
(
Àaf
, 
chunk
, 
key
->
off£t
);

988 
	}
}

990 
	$__¥ötf
(3, 4)

991 
__cﬁd


992 
	$dev_ôem_îr
(c⁄° 
exã¡_buf„r
 *
eb
, 
¶Ÿ
,

993 c⁄° *
fmt
, ...)

995 
båfs_key
 
key
;

996 
va_f‹m©
 
vaf
;

997 
va_li°
 
¨gs
;

999 
	`båfs_ôem_key_to_˝u
(
eb
, &
key
, 
¶Ÿ
);

1000 
	`va_°¨t
(
¨gs
, 
fmt
);

1002 
vaf
.
fmt
 = fmt;

1003 
vaf
.
va
 = &
¨gs
;

1005 
	`båfs_¸ô
(
eb
->
fs_öfo
,

1007 
	`båfs_hódî_Àvñ
(
eb
) == 0 ? "leaf" : "node",

1008 
	`båfs_hódî_ow√r
(
eb
), 
	`båfs_hódî_byãƒ
”b), 
¶Ÿ
,

1009 
key
.
obje˘id
, &
vaf
);

1010 
	`va_íd
(
¨gs
);

1011 
	}
}

1013 
	$check_dev_ôem
(
exã¡_buf„r
 *
Àaf
,

1014 
båfs_key
 *
key
, 
¶Ÿ
)

1016 
båfs_dev_ôem
 *
dôem
;

1017 c⁄° 
u32
 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

1020 i‡(
	`u∆ikñy
(
key
->
obje˘id
 !
BTRFS_DEV_ITEMS_OBJECTID
)) {

1021 
	`dev_ôem_îr
(
Àaf
, 
¶Ÿ
,

1023 
key
->
obje˘id
, 
BTRFS_DEV_ITEMS_OBJECTID
);

1024  -
EUCLEAN
;

1027 i‡(
	`u∆ikñy
(
ôem_size
 !(*
dôem
))) {

1028 
	`dev_ôem_îr
(
Àaf
, 
¶Ÿ
, "invalid item size: has %uÉxpect %zu",

1029 
ôem_size
, (*
dôem
));

1030  -
EUCLEAN
;

1033 
dôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_dev_ôem
);

1034 i‡(
	`u∆ikñy
(
	`båfs_devi˚_id
(
Àaf
, 
dôem
Ë!
key
->
off£t
)) {

1035 
	`dev_ôem_îr
(
Àaf
, 
¶Ÿ
,

1037 
key
->
off£t
, 
	`båfs_devi˚_id
(
Àaf
, 
dôem
));

1038  -
EUCLEAN
;

1049 i‡(
	`u∆ikñy
(
	`båfs_devi˚_byãs_u£d
(
Àaf
, 
dôem
) >

1050 
	`båfs_devi˚_tŸÆ_byãs
(
Àaf
, 
dôem
))) {

1051 
	`dev_ôem_îr
(
Àaf
, 
¶Ÿ
,

1053 
	`båfs_devi˚_byãs_u£d
(
Àaf
, 
dôem
),

1054 
	`båfs_devi˚_tŸÆ_byãs
(
Àaf
, 
dôem
));

1055  -
EUCLEAN
;

1064 
	}
}

1066 
	$check_öode_ôem
(
exã¡_buf„r
 *
Àaf
,

1067 
båfs_key
 *
key
, 
¶Ÿ
)

1069 
båfs_fs_öfo
 *
fs_öfo
 = 
Àaf
->fs_info;

1070 
båfs_öode_ôem
 *
iôem
;

1071 
u64
 
su≥r_gí
 = 
	`båfs_su≥r_gíî©i⁄
(
fs_öfo
->
su≥r_c›y
);

1072 
u32
 
vÆid_mask
 = (
S_IFMT
 | 
S_ISUID
 | 
S_ISGID
 | 
S_ISVTX
 | 0777);

1073 c⁄° 
u32
 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

1074 
u32
 
mode
;

1075 
ªt
;

1076 
u32
 
Êags
;

1077 
u32
 
ro_Êags
;

1079 
ªt
 = 
	`check_öode_key
(
Àaf
, 
key
, 
¶Ÿ
);

1080 i‡(
	`u∆ikñy
(
ªt
 < 0))

1081  
ªt
;

1083 i‡(
	`u∆ikñy
(
ôem_size
 !(*
iôem
))) {

1084 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
, "invalid item size: has %uÉxpect %zu",

1085 
ôem_size
, (*
iôem
));

1086  -
EUCLEAN
;

1089 
iôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_öode_ôem
);

1092 i‡(
	`u∆ikñy
(
	`båfs_öode_gíî©i⁄
(
Àaf
, 
iôem
Ë> 
su≥r_gí
 + 1)) {

1093 
	`öode_ôem_îr
(
Àaf
, 
¶Ÿ
,

1095 
	`båfs_öode_gíî©i⁄
(
Àaf
, 
iôem
),

1096 
su≥r_gí
 + 1);

1097  -
EUCLEAN
;

1100 i‡(
	`u∆ikñy
(
	`båfs_öode_å™sid
(
Àaf
, 
iôem
Ë> 
su≥r_gí
 + 1)) {

1101 
	`öode_ôem_îr
(
Àaf
, 
¶Ÿ
,

1103 
	`båfs_öode_å™sid
(
Àaf
, 
iôem
), 
su≥r_gí
 + 1);

1104  -
EUCLEAN
;

1112 
mode
 = 
	`båfs_öode_mode
(
Àaf
, 
iôem
);

1113 i‡(
	`u∆ikñy
(
mode
 & ~
vÆid_mask
)) {

1114 
	`öode_ôem_îr
(
Àaf
, 
¶Ÿ
,

1116 
mode
 & ~
vÆid_mask
);

1117  -
EUCLEAN
;

1125 i‡(!
	`has_sögÀ_bô_£t
(
mode
 & 
S_IFMT
)) {

1126 i‡(
	`u∆ikñy
(!
	`S_ISLNK
(
mode
Ë&& !
	`S_ISBLK
(modeË&& !
	`S_ISSOCK
(mode))) {

1127 
	`öode_ôem_îr
(
Àaf
, 
¶Ÿ
,

1129 
mode
 & 
S_IFMT
);

1130  -
EUCLEAN
;

1133 i‡(
	`u∆ikñy
(
	`S_ISDIR
(
mode
Ë&& 
	`båfs_öode_∆ök
(
Àaf
, 
iôem
) > 1)) {

1134 
	`öode_ôem_îr
(
Àaf
, 
¶Ÿ
,

1136 
	`båfs_öode_∆ök
(
Àaf
, 
iôem
));

1137  -
EUCLEAN
;

1139 
	`båfs_öode_•lô_Êags
(
	`båfs_öode_Êags
(
Àaf
, 
iôem
), &
Êags
, &
ro_Êags
);

1140 i‡(
	`u∆ikñy
(
Êags
 & ~
BTRFS_INODE_FLAG_MASK
)) {

1141 
	`öode_ôem_îr
(
Àaf
, 
¶Ÿ
,

1142 "unknow¿öcom∑àÊag†dëe˘ed: 0x%x", 
Êags
);

1143  -
EUCLEAN
;

1145 i‡(
	`u∆ikñy
(!
	`sb_rd⁄ly
(
fs_öfo
->
sb
) &&

1146 (
ro_Êags
 & ~
BTRFS_INODE_RO_FLAG_MASK
))) {

1147 
	`öode_ôem_îr
(
Àaf
, 
¶Ÿ
,

1149 
ro_Êags
);

1150  -
EUCLEAN
;

1153 
	}
}

1155 
	$check_roŸ_ôem
(
exã¡_buf„r
 *
Àaf
, 
båfs_key
 *
key
,

1156 
¶Ÿ
)

1158 
båfs_fs_öfo
 *
fs_öfo
 = 
Àaf
->fs_info;

1159 
båfs_roŸ_ôem
 
ri
 = { 0 };

1160 c⁄° 
u64
 
vÆid_roŸ_Êags
 = 
BTRFS_ROOT_SUBVOL_RDONLY
 |

1161 
BTRFS_ROOT_SUBVOL_DEAD
;

1162 
ªt
;

1164 
ªt
 = 
	`check_roŸ_key
(
Àaf
, 
key
, 
¶Ÿ
);

1165 i‡(
	`u∆ikñy
(
ªt
 < 0))

1166  
ªt
;

1168 i‡(
	`u∆ikñy
(
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
Ë!(
ri
) &&

1169 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
) !=

1170 
	`båfs_Àgacy_roŸ_ôem_size
())) {

1171 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1173 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
), (
ri
),

1174 
	`båfs_Àgacy_roŸ_ôem_size
());

1175  -
EUCLEAN
;

1183 
	`ªad_exã¡_buf„r
(
Àaf
, &
ri
, 
	`båfs_ôem_±r_off£t
÷óf, 
¶Ÿ
),

1184 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
));

1187 i‡(
	`u∆ikñy
(
	`båfs_roŸ_gíî©i⁄
(&
ri
) >

1188 
	`båfs_su≥r_gíî©i⁄
(
fs_öfo
->
su≥r_c›y
) + 1)) {

1189 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1191 
	`båfs_roŸ_gíî©i⁄
(&
ri
),

1192 
	`båfs_su≥r_gíî©i⁄
(
fs_öfo
->
su≥r_c›y
) + 1);

1193  -
EUCLEAN
;

1195 i‡(
	`u∆ikñy
(
	`båfs_roŸ_gíî©i⁄_v2
(&
ri
) >

1196 
	`båfs_su≥r_gíî©i⁄
(
fs_öfo
->
su≥r_c›y
) + 1)) {

1197 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1199 
	`båfs_roŸ_gíî©i⁄_v2
(&
ri
),

1200 
	`båfs_su≥r_gíî©i⁄
(
fs_öfo
->
su≥r_c›y
) + 1);

1201  -
EUCLEAN
;

1203 i‡(
	`u∆ikñy
(
	`båfs_roŸ_œ°_¢≠shŸ
(&
ri
) >

1204 
	`båfs_su≥r_gíî©i⁄
(
fs_öfo
->
su≥r_c›y
) + 1)) {

1205 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1207 
	`båfs_roŸ_œ°_¢≠shŸ
(&
ri
),

1208 
	`båfs_su≥r_gíî©i⁄
(
fs_öfo
->
su≥r_c›y
) + 1);

1209  -
EUCLEAN
;

1213 i‡(
	`u∆ikñy
(!
	`IS_ALIGNED
(
	`båfs_roŸ_byãƒ
(&
ri
), 
fs_öfo
->
£˘‹size
))) {

1214 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1216 
	`båfs_roŸ_byãƒ
(&
ri
), 
fs_öfo
->
£˘‹size
);

1217  -
EUCLEAN
;

1219 i‡(
	`u∆ikñy
(
	`båfs_roŸ_Àvñ
(&
ri
Ë>
BTRFS_MAX_LEVEL
)) {

1220 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1222 
	`båfs_roŸ_Àvñ
(&
ri
), 
BTRFS_MAX_LEVEL
 - 1);

1223  -
EUCLEAN
;

1225 i‡(
	`u∆ikñy
(
	`båfs_roŸ_dr›_Àvñ
(&
ri
Ë>
BTRFS_MAX_LEVEL
)) {

1226 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1228 
	`båfs_roŸ_dr›_Àvñ
(&
ri
), 
BTRFS_MAX_LEVEL
 - 1);

1229  -
EUCLEAN
;

1233 i‡(
	`u∆ikñy
(
	`båfs_roŸ_Êags
(&
ri
Ë& ~
vÆid_roŸ_Êags
)) {

1234 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1236 
	`båfs_roŸ_Êags
(&
ri
), 
vÆid_roŸ_Êags
);

1237  -
EUCLEAN
;

1240 
	}
}

1242 
	$__¥ötf
(3,4)

1243 
__cﬁd


1244 
	$exã¡_îr
(c⁄° 
exã¡_buf„r
 *
eb
, 
¶Ÿ
,

1245 c⁄° *
fmt
, ...)

1247 
båfs_key
 
key
;

1248 
va_f‹m©
 
vaf
;

1249 
va_li°
 
¨gs
;

1250 
u64
 
byãƒ
;

1251 
u64
 
Àn
;

1253 
	`båfs_ôem_key_to_˝u
(
eb
, &
key
, 
¶Ÿ
);

1254 
byãƒ
 = 
key
.
obje˘id
;

1255 i‡(
key
.
ty≥
 =
BTRFS_METADATA_ITEM_KEY
 ||

1256 
key
.
ty≥
 =
BTRFS_TREE_BLOCK_REF_KEY
 ||

1257 
key
.
ty≥
 =
BTRFS_SHARED_BLOCK_REF_KEY
)

1258 
Àn
 = 
eb
->
fs_öfo
->
nodesize
;

1260 
Àn
 = 
key
.
off£t
;

1261 
	`va_°¨t
(
¨gs
, 
fmt
);

1263 
vaf
.
fmt
 = fmt;

1264 
vaf
.
va
 = &
¨gs
;

1266 
	`båfs_¸ô
(
eb
->
fs_öfo
,

1268 
	`båfs_hódî_Àvñ
(
eb
) == 0 ? "leaf" : "node",

1269 
eb
->
°¨t
, 
¶Ÿ
, 
byãƒ
, 
Àn
, &
vaf
);

1270 
	`va_íd
(
¨gs
);

1271 
	}
}

1273 
	$check_exã¡_ôem
(
exã¡_buf„r
 *
Àaf
,

1274 
båfs_key
 *
key
, 
¶Ÿ
,

1275 
båfs_key
 *
¥ev_key
)

1277 
båfs_fs_öfo
 *
fs_öfo
 = 
Àaf
->fs_info;

1278 
båfs_exã¡_ôem
 *
ei
;

1279 
boﬁ
 
is_åì_block
 = 
Ál£
;

1280 
±r
;

1281 
íd
;

1282 c⁄° 
u32
 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

1283 
u64
 
Êags
;

1284 
u64
 
gíî©i⁄
;

1285 
u64
 
tŸÆ_ªfs
;

1286 
u64
 
ölöe_ªfs
 = 0;

1288 i‡(
	`u∆ikñy
(
key
->
ty≥
 =
BTRFS_METADATA_ITEM_KEY
 &&

1289 !
	`båfs_fs_öcom∑t
(
fs_öfo
, 
SKINNY_METADATA
))) {

1290 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1292  -
EUCLEAN
;

1295 i‡(
	`u∆ikñy
(!
	`IS_ALIGNED
(
key
->
obje˘id
, 
fs_öfo
->
£˘‹size
))) {

1296 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1298 
key
->
obje˘id
, 
fs_öfo
->
£˘‹size
);

1299  -
EUCLEAN
;

1303 i‡(
	`u∆ikñy
(
key
->
ty≥
 =
BTRFS_METADATA_ITEM_KEY
 &&

1304 
key
->
off£t
 >
BTRFS_MAX_LEVEL
)) {

1305 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1307 
key
->
off£t
, 
BTRFS_MAX_LEVEL
 - 1);

1308  -
EUCLEAN
;

1330 i‡(
	`u∆ikñy
(
ôem_size
 < (*
ei
))) {

1331 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1333 
ôem_size
, (*
ei
),

1334 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
));

1335  -
EUCLEAN
;

1337 
íd
 = 
ôem_size
 + 
	`båfs_ôem_±r_off£t
(
Àaf
, 
¶Ÿ
);

1340 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_exã¡_ôem
);

1341 
Êags
 = 
	`båfs_exã¡_Êags
(
Àaf
, 
ei
);

1342 
tŸÆ_ªfs
 = 
	`båfs_exã¡_ªfs
(
Àaf
, 
ei
);

1343 
gíî©i⁄
 = 
	`båfs_exã¡_gíî©i⁄
(
Àaf
, 
ei
);

1344 i‡(
	`u∆ikñy
(
gíî©i⁄
 >

1345 
	`båfs_su≥r_gíî©i⁄
(
fs_öfo
->
su≥r_c›y
) + 1)) {

1346 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1348 
gíî©i⁄
,

1349 
	`båfs_su≥r_gíî©i⁄
(
fs_öfo
->
su≥r_c›y
) + 1);

1350  -
EUCLEAN
;

1352 i‡(
	`u∆ikñy
(!
	`has_sögÀ_bô_£t
(
Êags
 & (
BTRFS_EXTENT_FLAG_DATA
 |

1353 
BTRFS_EXTENT_FLAG_TREE_BLOCK
)))) {

1354 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1356 
Êags
, 
BTRFS_EXTENT_FLAG_DATA
 |

1357 
BTRFS_EXTENT_FLAG_TREE_BLOCK
);

1358  -
EUCLEAN
;

1360 
is_åì_block
 = !!(
Êags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
);

1361 i‡(
is_åì_block
) {

1362 i‡(
	`u∆ikñy
(
key
->
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
 &&

1363 
key
->
off£t
 !
fs_öfo
->
nodesize
)) {

1364 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1366 
key
->
off£t
, 
fs_öfo
->
nodesize
);

1367  -
EUCLEAN
;

1370 i‡(
	`u∆ikñy
(
key
->
ty≥
 !
BTRFS_EXTENT_ITEM_KEY
)) {

1371 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1373 
key
->
ty≥
, 
BTRFS_EXTENT_ITEM_KEY
);

1374  -
EUCLEAN
;

1376 i‡(
	`u∆ikñy
(!
	`IS_ALIGNED
(
key
->
off£t
, 
fs_öfo
->
£˘‹size
))) {

1377 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1379 
key
->
off£t
, 
fs_öfo
->
£˘‹size
);

1380  -
EUCLEAN
;

1382 i‡(
	`u∆ikñy
(
Êags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
)) {

1383 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1385  -
EUCLEAN
;

1388 
±r
 = ()(
båfs_exã¡_ôem
 *)(
ei
 + 1);

1391 i‡(
is_åì_block
 && 
key
->
ty≥
 !
BTRFS_METADATA_ITEM_KEY
) {

1392 
båfs_åì_block_öfo
 *
öfo
;

1394 
öfo
 = (
båfs_åì_block_öfo
 *)
±r
;

1395 i‡(
	`u∆ikñy
(
	`båfs_åì_block_Àvñ
(
Àaf
, 
öfo
Ë>
BTRFS_MAX_LEVEL
)) {

1396 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1398 
	`båfs_åì_block_Àvñ
(
Àaf
, 
öfo
),

1399 
BTRFS_MAX_LEVEL
 - 1);

1400  -
EUCLEAN
;

1402 
±r
 = ()(
båfs_åì_block_öfo
 *)(
öfo
 + 1);

1406 
±r
 < 
íd
) {

1407 
båfs_exã¡_ölöe_ªf
 *
úef
;

1408 
båfs_exã¡_d©a_ªf
 *
dªf
;

1409 
båfs_sh¨ed_d©a_ªf
 *
§ef
;

1410 
u64
 
dªf_off£t
;

1411 
u64
 
ölöe_off£t
;

1412 
u8
 
ölöe_ty≥
;

1414 i‡(
	`u∆ikñy
(
±r
 + (*
úef
Ë> 
íd
)) {

1415 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1417 
±r
, (*
úef
), 
íd
);

1418  -
EUCLEAN
;

1420 
úef
 = (
båfs_exã¡_ölöe_ªf
 *)
±r
;

1421 
ölöe_ty≥
 = 
	`båfs_exã¡_ölöe_ªf_ty≥
(
Àaf
, 
úef
);

1422 
ölöe_off£t
 = 
	`båfs_exã¡_ölöe_ªf_off£t
(
Àaf
, 
úef
);

1423 i‡(
	`u∆ikñy
(
±r
 + 
	`båfs_exã¡_ölöe_ªf_size
(
ölöe_ty≥
Ë> 
íd
)) {

1424 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1426 
±r
, 
ölöe_ty≥
, 
íd
);

1427  -
EUCLEAN
;

1430 
ölöe_ty≥
) {

1432 
BTRFS_TREE_BLOCK_REF_KEY
:

1433 
ölöe_ªfs
++;

1436 
BTRFS_SHARED_BLOCK_REF_KEY
:

1437 i‡(
	`u∆ikñy
(!
	`IS_ALIGNED
(
ölöe_off£t
,

1438 
fs_öfo
->
£˘‹size
))) {

1439 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1441 
ölöe_off£t
, 
fs_öfo
->
£˘‹size
);

1442  -
EUCLEAN
;

1444 
ölöe_ªfs
++;

1450 
BTRFS_EXTENT_DATA_REF_KEY
:

1451 
dªf
 = (
båfs_exã¡_d©a_ªf
 *)(&
úef
->
off£t
);

1452 
dªf_off£t
 = 
	`båfs_exã¡_d©a_ªf_off£t
(
Àaf
, 
dªf
);

1453 i‡(
	`u∆ikñy
(!
	`IS_ALIGNED
(
dªf_off£t
,

1454 
fs_öfo
->
£˘‹size
))) {

1455 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1457 
dªf_off£t
, 
fs_öfo
->
£˘‹size
);

1458  -
EUCLEAN
;

1460 
ölöe_ªfs
 +
	`båfs_exã¡_d©a_ªf_cou¡
(
Àaf
, 
dªf
);

1463 
BTRFS_SHARED_DATA_REF_KEY
:

1464 
§ef
 = (
båfs_sh¨ed_d©a_ªf
 *)(
úef
 + 1);

1465 i‡(
	`u∆ikñy
(!
	`IS_ALIGNED
(
ölöe_off£t
,

1466 
fs_öfo
->
£˘‹size
))) {

1467 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1469 
ölöe_off£t
, 
fs_öfo
->
£˘‹size
);

1470  -
EUCLEAN
;

1472 
ölöe_ªfs
 +
	`båfs_sh¨ed_d©a_ªf_cou¡
(
Àaf
, 
§ef
);

1475 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
, "unknown inlineÑefÅype: %u",

1476 
ölöe_ty≥
);

1477  -
EUCLEAN
;

1479 
±r
 +
	`båfs_exã¡_ölöe_ªf_size
(
ölöe_ty≥
);

1482 i‡(
	`u∆ikñy
(
±r
 !
íd
)) {

1483 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1485  -
EUCLEAN
;

1489 i‡(
	`u∆ikñy
(
ölöe_ªfs
 > 
tŸÆ_ªfs
)) {

1490 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1492 
tŸÆ_ªfs
, 
ölöe_ªfs
);

1493  -
EUCLEAN
;

1496 i‡((
¥ev_key
->
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
) ||

1497 (
¥ev_key
->
ty≥
 =
BTRFS_METADATA_ITEM_KEY
)) {

1498 
u64
 
¥ev_íd
 = 
¥ev_key
->
obje˘id
;

1500 i‡(
¥ev_key
->
ty≥
 =
BTRFS_METADATA_ITEM_KEY
)

1501 
¥ev_íd
 +
fs_öfo
->
nodesize
;

1503 
¥ev_íd
 +
¥ev_key
->
off£t
;

1505 i‡(
	`u∆ikñy
(
¥ev_íd
 > 
key
->
obje˘id
)) {

1506 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1508 
¥ev_key
->
obje˘id
,Öªv_key->
ty≥
,

1509 
¥ev_key
->
off£t
, 
key
->
obje˘id
, key->
ty≥
,

1510 
key
->
off£t
);

1511  -
EUCLEAN
;

1516 
	}
}

1518 
	$check_sim∂e_keyed_ªfs
(
exã¡_buf„r
 *
Àaf
,

1519 
båfs_key
 *
key
, 
¶Ÿ
)

1521 
u32
 
ex≥˘_ôem_size
 = 0;

1523 i‡(
key
->
ty≥
 =
BTRFS_SHARED_DATA_REF_KEY
)

1524 
ex≥˘_ôem_size
 = (
båfs_sh¨ed_d©a_ªf
);

1526 i‡(
	`u∆ikñy
(
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
Ë!
ex≥˘_ôem_size
)) {

1527 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1529 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
),

1530 
ex≥˘_ôem_size
, 
key
->
ty≥
);

1531  -
EUCLEAN
;

1533 i‡(
	`u∆ikñy
(!
	`IS_ALIGNED
(
key
->
obje˘id
, 
Àaf
->
fs_öfo
->
£˘‹size
))) {

1534 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1536 
key
->
obje˘id
, 
Àaf
->
fs_öfo
->
£˘‹size
);

1537  -
EUCLEAN
;

1539 i‡(
	`u∆ikñy
(
key
->
ty≥
 !
BTRFS_TREE_BLOCK_REF_KEY
 &&

1540 !
	`IS_ALIGNED
(
key
->
off£t
, 
Àaf
->
fs_öfo
->
£˘‹size
))) {

1541 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1543 
key
->
off£t
, 
Àaf
->
fs_öfo
->
£˘‹size
);

1544  -
EUCLEAN
;

1547 
	}
}

1549 
	$check_exã¡_d©a_ªf
(
exã¡_buf„r
 *
Àaf
,

1550 
båfs_key
 *
key
, 
¶Ÿ
)

1552 
båfs_exã¡_d©a_ªf
 *
dªf
;

1553 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
¶Ÿ
);

1554 c⁄° 
íd
 = 
±r
 + 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

1556 i‡(
	`u∆ikñy
(
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
Ë% (*
dªf
) != 0)) {

1557 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1559 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
),

1560 (*
dªf
), 
key
->
ty≥
);

1561  -
EUCLEAN
;

1563 i‡(
	`u∆ikñy
(!
	`IS_ALIGNED
(
key
->
obje˘id
, 
Àaf
->
fs_öfo
->
£˘‹size
))) {

1564 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1566 
key
->
obje˘id
, 
Àaf
->
fs_öfo
->
£˘‹size
);

1567  -
EUCLEAN
;

1569 ; 
±r
 < 
íd
;Öå +(*
dªf
)) {

1570 
u64
 
off£t
;

1576 
dªf
 = (
båfs_exã¡_d©a_ªf
 *)
±r
;

1577 
off£t
 = 
	`båfs_exã¡_d©a_ªf_off£t
(
Àaf
, 
dªf
);

1578 i‡(
	`u∆ikñy
(!
	`IS_ALIGNED
(
off£t
, 
Àaf
->
fs_öfo
->
£˘‹size
))) {

1579 
	`exã¡_îr
(
Àaf
, 
¶Ÿ
,

1581 
off£t
, 
Àaf
->
fs_öfo
->
£˘‹size
);

1582  -
EUCLEAN
;

1586 
	}
}

1588 
	#öode_ªf_îr
(
eb
, 
¶Ÿ
, 
fmt
, 
¨gs
...) \

1589 
	`öode_ôem_îr
(
eb
, 
¶Ÿ
, 
fmt
, ##
¨gs
)

	)

1590 
	$check_öode_ªf
(
exã¡_buf„r
 *
Àaf
,

1591 
båfs_key
 *
key
, båfs_key *
¥ev_key
,

1592 
¶Ÿ
)

1594 
båfs_öode_ªf
 *
úef
;

1595 
±r
;

1596 
íd
;

1598 i‡(
	`u∆ikñy
(!
	`check_¥ev_öo
(
Àaf
, 
key
, 
¶Ÿ
, 
¥ev_key
)))

1599  -
EUCLEAN
;

1601 i‡(
	`u∆ikñy
(
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
Ë<(*
úef
))) {

1602 
	`öode_ªf_îr
(
Àaf
, 
¶Ÿ
,

1604 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
),

1605 (*
úef
), 
	`BTRFS_LEAF_DATA_SIZE
(
Àaf
->
fs_öfo
));

1606  -
EUCLEAN
;

1609 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
¶Ÿ
);

1610 
íd
 = 
±r
 + 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

1611 
±r
 < 
íd
) {

1612 
u16
 
«mñí
;

1614 i‡(
	`u∆ikñy
(
±r
 + (
úef
Ë> 
íd
)) {

1615 
	`öode_ªf_îr
(
Àaf
, 
¶Ÿ
,

1617 
±r
, 
íd
, (
úef
));

1618  -
EUCLEAN
;

1621 
úef
 = (
båfs_öode_ªf
 *)
±r
;

1622 
«mñí
 = 
	`båfs_öode_ªf_«me_Àn
(
Àaf
, 
úef
);

1623 i‡(
	`u∆ikñy
(
±r
 + (*
úef
Ë+ 
«mñí
 > 
íd
)) {

1624 
	`öode_ªf_îr
(
Àaf
, 
¶Ÿ
,

1626 
±r
, 
íd
, 
«mñí
);

1627  -
EUCLEAN
;

1635 
±r
 +(*
úef
Ë+ 
«mñí
;

1638 
	}
}

1643 
båfs_åì_block_°©us
 
	$check_Àaf_ôem
(
exã¡_buf„r
 *
Àaf
,

1644 
båfs_key
 *
key
,

1645 
¶Ÿ
,

1646 
båfs_key
 *
¥ev_key
)

1648 
ªt
 = 0;

1649 
båfs_chunk
 *
chunk
;

1651 
key
->
ty≥
) {

1652 
BTRFS_EXTENT_DATA_KEY
:

1653 
ªt
 = 
	`check_exã¡_d©a_ôem
(
Àaf
, 
key
, 
¶Ÿ
, 
¥ev_key
);

1655 
BTRFS_EXTENT_CSUM_KEY
:

1656 
ªt
 = 
	`check_csum_ôem
(
Àaf
, 
key
, 
¶Ÿ
, 
¥ev_key
);

1658 
BTRFS_DIR_ITEM_KEY
:

1659 
BTRFS_DIR_INDEX_KEY
:

1660 
BTRFS_XATTR_ITEM_KEY
:

1661 
ªt
 = 
	`check_dú_ôem
(
Àaf
, 
key
, 
¥ev_key
, 
¶Ÿ
);

1663 
BTRFS_INODE_REF_KEY
:

1664 
ªt
 = 
	`check_öode_ªf
(
Àaf
, 
key
, 
¥ev_key
, 
¶Ÿ
);

1666 
BTRFS_BLOCK_GROUP_ITEM_KEY
:

1667 
ªt
 = 
	`check_block_group_ôem
(
Àaf
, 
key
, 
¶Ÿ
);

1669 
BTRFS_CHUNK_ITEM_KEY
:

1670 
chunk
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_chunk
);

1671 
ªt
 = 
	`check_Àaf_chunk_ôem
(
Àaf
, 
chunk
, 
key
, 
¶Ÿ
);

1673 
BTRFS_DEV_ITEM_KEY
:

1674 
ªt
 = 
	`check_dev_ôem
(
Àaf
, 
key
, 
¶Ÿ
);

1676 
BTRFS_INODE_ITEM_KEY
:

1677 
ªt
 = 
	`check_öode_ôem
(
Àaf
, 
key
, 
¶Ÿ
);

1679 
BTRFS_ROOT_ITEM_KEY
:

1680 
ªt
 = 
	`check_roŸ_ôem
(
Àaf
, 
key
, 
¶Ÿ
);

1682 
BTRFS_EXTENT_ITEM_KEY
:

1683 
BTRFS_METADATA_ITEM_KEY
:

1684 
ªt
 = 
	`check_exã¡_ôem
(
Àaf
, 
key
, 
¶Ÿ
, 
¥ev_key
);

1686 
BTRFS_TREE_BLOCK_REF_KEY
:

1687 
BTRFS_SHARED_DATA_REF_KEY
:

1688 
BTRFS_SHARED_BLOCK_REF_KEY
:

1689 
ªt
 = 
	`check_sim∂e_keyed_ªfs
(
Àaf
, 
key
, 
¶Ÿ
);

1691 
BTRFS_EXTENT_DATA_REF_KEY
:

1692 
ªt
 = 
	`check_exã¡_d©a_ªf
(
Àaf
, 
key
, 
¶Ÿ
);

1696 i‡(
ªt
)

1697  
BTRFS_TREE_BLOCK_INVALID_ITEM
;

1698  
BTRFS_TREE_BLOCK_CLEAN
;

1699 
	}
}

1701 
båfs_åì_block_°©us
 
	$__båfs_check_Àaf
(
exã¡_buf„r
 *
Àaf
)

1703 
båfs_fs_öfo
 *
fs_öfo
 = 
Àaf
->fs_info;

1705 
båfs_key
 
¥ev_key
 = {0, 0, 0};

1706 
båfs_key
 
key
;

1707 
u32
 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

1708 
¶Ÿ
;

1710 i‡(
	`u∆ikñy
(
	`båfs_hódî_Àvñ
(
Àaf
) != 0)) {

1711 
	`gíîic_îr
(
Àaf
, 0,

1713 
	`båfs_hódî_Àvñ
(
Àaf
));

1714  
BTRFS_TREE_BLOCK_INVALID_LEVEL
;

1725 i‡(
ƒôems
 =0 && !
	`båfs_hódî_Êag
(
Àaf
, 
BTRFS_HEADER_FLAG_RELOC
)) {

1726 
u64
 
ow√r
 = 
	`båfs_hódî_ow√r
(
Àaf
);

1729 i‡(
	`u∆ikñy
(
ow√r
 =
BTRFS_ROOT_TREE_OBJECTID
 ||

1730 
ow√r
 =
BTRFS_CHUNK_TREE_OBJECTID
 ||

1731 
ow√r
 =
BTRFS_DEV_TREE_OBJECTID
 ||

1732 
ow√r
 =
BTRFS_FS_TREE_OBJECTID
 ||

1733 
ow√r
 =
BTRFS_DATA_RELOC_TREE_OBJECTID
)) {

1734 
	`gíîic_îr
(
Àaf
, 0,

1736 
ow√r
);

1737  
BTRFS_TREE_BLOCK_INVALID_NRITEMS
;

1741 i‡(
	`u∆ikñy
(
ow√r
 == 0)) {

1742 
	`gíîic_îr
(
Àaf
, 0,

1744  
BTRFS_TREE_BLOCK_INVALID_OWNER
;

1748 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
EXTENT_TREE_V2
))

1749  
BTRFS_TREE_BLOCK_CLEAN
;

1751 i‡(
	`u∆ikñy
(
ow√r
 =
BTRFS_EXTENT_TREE_OBJECTID
)) {

1752 
	`gíîic_îr
(
Àaf
, 0,

1754 
ow√r
);

1755  
BTRFS_TREE_BLOCK_INVALID_NRITEMS
;

1758  
BTRFS_TREE_BLOCK_CLEAN
;

1761 i‡(
	`u∆ikñy
(
ƒôems
 == 0))

1762  
BTRFS_TREE_BLOCK_CLEAN
;

1775 
¶Ÿ
 = 0; slŸ < 
ƒôems
; slot++) {

1776 
u32
 
ôem_íd_ex≥˘ed
;

1777 
u64
 
ôem_d©a_íd
;

1779 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

1782 i‡(
	`u∆ikñy
(
	`båfs_comp_˝u_keys
(&
¥ev_key
, &
key
) >= 0)) {

1783 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1785 
¥ev_key
.
obje˘id
,Öªv_key.
ty≥
,

1786 
¥ev_key
.
off£t
, 
key
.
obje˘id
, key.
ty≥
,

1787 
key
.
off£t
);

1788  
BTRFS_TREE_BLOCK_BAD_KEY_ORDER
;

1791 
ôem_d©a_íd
 = (
u64
)
	`båfs_ôem_off£t
(
Àaf
, 
¶Ÿ
) +

1792 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

1798 i‡(
¶Ÿ
 == 0)

1799 
ôem_íd_ex≥˘ed
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
);

1801 
ôem_íd_ex≥˘ed
 = 
	`båfs_ôem_off£t
(
Àaf
,

1802 
¶Ÿ
 - 1);

1803 i‡(
	`u∆ikñy
(
ôem_d©a_íd
 !
ôem_íd_ex≥˘ed
)) {

1804 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1806 
ôem_d©a_íd
, 
ôem_íd_ex≥˘ed
);

1807  
BTRFS_TREE_BLOCK_INVALID_OFFSETS
;

1815 i‡(
	`u∆ikñy
(
ôem_d©a_íd
 > 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
))) {

1816 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1818 
ôem_d©a_íd
, 
	`BTRFS_LEAF_DATA_SIZE
(
fs_öfo
));

1819  
BTRFS_TREE_BLOCK_INVALID_OFFSETS
;

1823 i‡(
	`u∆ikñy
(
	`båfs_ôem_±r_off£t
(
Àaf
, 
¶Ÿ
) <

1824 
	`båfs_ôem_ƒ_off£t
(
Àaf
, 
¶Ÿ
Ë+ (
båfs_ôem
))) {

1825 
	`gíîic_îr
(
Àaf
, 
¶Ÿ
,

1827 
	`båfs_ôem_ƒ_off£t
(
Àaf
, 
¶Ÿ
) +

1828 (
båfs_ôem
),

1829 
	`båfs_ôem_±r_off£t
(
Àaf
, 
¶Ÿ
));

1830  
BTRFS_TREE_BLOCK_INVALID_OFFSETS
;

1837 i‡(
	`båfs_hódî_Êag
(
Àaf
, 
BTRFS_HEADER_FLAG_WRITTEN
)) {

1838 
båfs_åì_block_°©us
 
ªt
;

1844 
ªt
 = 
	`check_Àaf_ôem
(
Àaf
, &
key
, 
¶Ÿ
, &
¥ev_key
);

1845 i‡(
	`u∆ikñy
(
ªt
 !
BTRFS_TREE_BLOCK_CLEAN
))

1846  
ªt
;

1849 
¥ev_key
.
obje˘id
 = 
key
.objectid;

1850 
¥ev_key
.
ty≥
 = 
key
.type;

1851 
¥ev_key
.
off£t
 = 
key
.offset;

1854  
BTRFS_TREE_BLOCK_CLEAN
;

1855 
	}
}

1857 
	$båfs_check_Àaf
(
exã¡_buf„r
 *
Àaf
)

1859 
båfs_åì_block_°©us
 
ªt
;

1861 
ªt
 = 
	`__båfs_check_Àaf
(
Àaf
);

1862 i‡(
	`u∆ikñy
(
ªt
 !
BTRFS_TREE_BLOCK_CLEAN
))

1863  -
EUCLEAN
;

1865 
	}
}

1866 
ALLOW_ERROR_INJECTION
(
båfs_check_Àaf
, 
ERRNO
);

1868 
båfs_åì_block_°©us
 
	$__båfs_check_node
(
exã¡_buf„r
 *
node
)

1870 
båfs_fs_öfo
 *
fs_öfo
 = 
node
->fs_info;

1871 
ƒ
 = 
	`båfs_hódî_ƒôems
(
node
);

1872 
båfs_key
 
key
, 
√xt_key
;

1873 
¶Ÿ
;

1874 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
node
);

1875 
u64
 
byãƒ
;

1877 i‡(
	`u∆ikñy
(
Àvñ
 <0 ||Üevñ >
BTRFS_MAX_LEVEL
)) {

1878 
	`gíîic_îr
(
node
, 0,

1880 
Àvñ
, 
BTRFS_MAX_LEVEL
 - 1);

1881  
BTRFS_TREE_BLOCK_INVALID_LEVEL
;

1883 i‡(
	`u∆ikñy
(
ƒ
 =0 ||Ç∏> 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_öfo
))) {

1884 
	`båfs_¸ô
(
fs_öfo
,

1886 
	`båfs_hódî_ow√r
(
node
),Çode->
°¨t
,

1887 
ƒ
 == 0 ? "small" : "large",Çr,

1888 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_öfo
));

1889  
BTRFS_TREE_BLOCK_INVALID_NRITEMS
;

1892 
¶Ÿ
 = 0; slŸ < 
ƒ
 - 1; slot++) {

1893 
byãƒ
 = 
	`båfs_node_block±r
(
node
, 
¶Ÿ
);

1894 
	`båfs_node_key_to_˝u
(
node
, &
key
, 
¶Ÿ
);

1895 
	`båfs_node_key_to_˝u
(
node
, &
√xt_key
, 
¶Ÿ
 + 1);

1897 i‡(
	`u∆ikñy
(!
byãƒ
)) {

1898 
	`gíîic_îr
(
node
, 
¶Ÿ
,

1900  
BTRFS_TREE_BLOCK_INVALID_BLOCKPTR
;

1902 i‡(
	`u∆ikñy
(!
	`IS_ALIGNED
(
byãƒ
, 
fs_öfo
->
£˘‹size
))) {

1903 
	`gíîic_îr
(
node
, 
¶Ÿ
,

1905 
byãƒ
, 
fs_öfo
->
£˘‹size
);

1906  
BTRFS_TREE_BLOCK_INVALID_BLOCKPTR
;

1909 i‡(
	`u∆ikñy
(
	`båfs_comp_˝u_keys
(&
key
, &
√xt_key
) >= 0)) {

1910 
	`gíîic_îr
(
node
, 
¶Ÿ
,

1912 
key
.
obje˘id
, key.
ty≥
, key.
off£t
,

1913 
√xt_key
.
obje˘id
,Çext_key.
ty≥
,

1914 
√xt_key
.
off£t
);

1915  
BTRFS_TREE_BLOCK_BAD_KEY_ORDER
;

1918  
BTRFS_TREE_BLOCK_CLEAN
;

1919 
	}
}

1921 
	$båfs_check_node
(
exã¡_buf„r
 *
node
)

1923 
båfs_åì_block_°©us
 
ªt
;

1925 
ªt
 = 
	`__båfs_check_node
(
node
);

1926 i‡(
	`u∆ikñy
(
ªt
 !
BTRFS_TREE_BLOCK_CLEAN
))

1927  -
EUCLEAN
;

1929 
	}
}

1930 
ALLOW_ERROR_INJECTION
(
båfs_check_node
, 
ERRNO
);

1932 
	$båfs_check_eb_ow√r
(c⁄° 
exã¡_buf„r
 *
eb
, 
u64
 
roŸ_ow√r
)

1934 c⁄° 
boﬁ
 
is_subvﬁ
 = 
	`is_f°ªe
(
roŸ_ow√r
);

1935 c⁄° 
u64
 
eb_ow√r
 = 
	`båfs_hódî_ow√r
(
eb
);

1941 i‡(
	`ã°_bô
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
eb
->
fs_öfo
->
fs_°©e
))

1949 i‡(
roŸ_ow√r
 == 0)

1955 i‡(
roŸ_ow√r
 =
BTRFS_TREE_LOG_OBJECTID
 ||

1956 
roŸ_ow√r
 =
BTRFS_TREE_RELOC_OBJECTID
)

1959 i‡(!
is_subvﬁ
) {

1961 i‡(
	`u∆ikñy
(
roŸ_ow√r
 !
eb_ow√r
)) {

1962 
	`båfs_¸ô
(
eb
->
fs_öfo
,

1964 
	`båfs_hódî_Àvñ
(
eb
) == 0 ? "leaf" : "node",

1965 
roŸ_ow√r
, 
	`båfs_hódî_byãƒ
(
eb
), 
eb_ow√r
,

1966 
roŸ_ow√r
);

1967  -
EUCLEAN
;

1976 i‡(
	`u∆ikñy
(
is_subvﬁ
 !
	`is_f°ªe
(
eb_ow√r
))) {

1977 
	`båfs_¸ô
(
eb
->
fs_öfo
,

1979 
	`båfs_hódî_Àvñ
(
eb
) == 0 ? "leaf" : "node",

1980 
roŸ_ow√r
, 
	`båfs_hódî_byãƒ
(
eb
), 
eb_ow√r
,

1981 
BTRFS_FIRST_FREE_OBJECTID
, 
BTRFS_LAST_FREE_OBJECTID
);

1982  -
EUCLEAN
;

1985 
	}
}

1987 
	$båfs_vîify_Àvñ_key
(
exã¡_buf„r
 *
eb
, 
Àvñ
,

1988 
båfs_key
 *
fú°_key
, 
u64
 
∑ª¡_å™sid
)

1990 
båfs_fs_öfo
 *
fs_öfo
 = 
eb
->fs_info;

1991 
found_Àvñ
;

1992 
båfs_key
 
found_key
;

1993 
ªt
;

1995 
found_Àvñ
 = 
	`båfs_hódî_Àvñ
(
eb
);

1996 i‡(
found_Àvñ
 !
Àvñ
) {

1997 
	`WARN
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
),

1998 
KERN_ERR
 "BTRFS:ÅreeÜevel check failed\n");

1999 
	`båfs_îr
(
fs_öfo
,

2001 
eb
->
°¨t
, 
Àvñ
, 
found_Àvñ
);

2002  -
EIO
;

2005 i‡(!
fú°_key
)

2014 i‡(
	`båfs_hódî_gíî©i⁄
(
eb
Ë> 
fs_öfo
->
œ°_å™s_commôãd
)

2018 i‡(
	`båfs_hódî_ƒôems
(
eb
) == 0) {

2019 
	`båfs_îr
(
fs_öfo
,

2021 
eb
->
°¨t
);

2022 
	`WARN_ON
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
));

2023  -
EUCLEAN
;

2026 i‡(
found_Àvñ
)

2027 
	`båfs_node_key_to_˝u
(
eb
, &
found_key
, 0);

2029 
	`båfs_ôem_key_to_˝u
(
eb
, &
found_key
, 0);

2030 
ªt
 = 
	`båfs_comp_˝u_keys
(
fú°_key
, &
found_key
);

2032 i‡(
ªt
) {

2033 
	`WARN
(
	`IS_ENABLED
(
CONFIG_BTRFS_DEBUG
),

2034 
KERN_ERR
 "BTRFS:Åree first key check failed\n");

2035 
	`båfs_îr
(
fs_öfo
,

2037 
eb
->
°¨t
, 
∑ª¡_å™sid
, 
fú°_key
->
obje˘id
,

2038 
fú°_key
->
ty≥
, fú°_key->
off£t
,

2039 
found_key
.
obje˘id
, found_key.
ty≥
,

2040 
found_key
.
off£t
);

2042  
ªt
;

2043 
	}
}

	@tree-checker.h

6 #i‚de‡
BTRFS_TREE_CHECKER_H


7 
	#BTRFS_TREE_CHECKER_H


	)

9 
	~<u≠i/löux/båfs_åì.h
>

11 
	gexã¡_buf„r
;

12 
	gbåfs_chunk
;

15 
	sbåfs_åì_∑ª¡_check
 {

21 
u64
 
	mow√r_roŸ
;

27 
u64
 
	må™sid
;

36 
båfs_key
 
	mfú°_key
;

37 
boﬁ
 
	mhas_fú°_key
;

40 
u8
 
	mÀvñ
;

43 
	ebåfs_åì_block_°©us
 {

44 
	mBTRFS_TREE_BLOCK_CLEAN
,

45 
	mBTRFS_TREE_BLOCK_INVALID_NRITEMS
,

46 
	mBTRFS_TREE_BLOCK_INVALID_PARENT_KEY
,

47 
	mBTRFS_TREE_BLOCK_BAD_KEY_ORDER
,

48 
	mBTRFS_TREE_BLOCK_INVALID_LEVEL
,

49 
	mBTRFS_TREE_BLOCK_INVALID_FREE_SPACE
,

50 
	mBTRFS_TREE_BLOCK_INVALID_OFFSETS
,

51 
	mBTRFS_TREE_BLOCK_INVALID_BLOCKPTR
,

52 
	mBTRFS_TREE_BLOCK_INVALID_ITEM
,

53 
	mBTRFS_TREE_BLOCK_INVALID_OWNER
,

60 
båfs_åì_block_°©us
 
__båfs_check_Àaf
(
exã¡_buf„r
 *
Àaf
);

61 
båfs_åì_block_°©us
 
__båfs_check_node
(
exã¡_buf„r
 *
node
);

63 
båfs_check_Àaf
(
exã¡_buf„r
 *
Àaf
);

64 
båfs_check_node
(
exã¡_buf„r
 *
node
);

66 
båfs_check_chunk_vÆid
(
exã¡_buf„r
 *
Àaf
,

67 
båfs_chunk
 *
chunk
, 
u64
 
logiˇl
);

68 
båfs_check_eb_ow√r
(c⁄° 
exã¡_buf„r
 *
eb
, 
u64
 
roŸ_ow√r
);

69 
båfs_vîify_Àvñ_key
(
exã¡_buf„r
 *
eb
, 
Àvñ
,

70 
båfs_key
 *
fú°_key
, 
u64
 
∑ª¡_å™sid
);

	@tree-log.c

6 
	~<löux/sched.h
>

7 
	~<löux/¶ab.h
>

8 
	~<löux/blkdev.h
>

9 
	~<löux/li°_s‹t.h
>

10 
	~<löux/ivîsi⁄.h
>

11 
	~"misc.h
"

12 
	~"˘ªe.h
"

13 
	~"åì-log.h
"

14 
	~"disk-io.h
"

15 
	~"lockög.h
"

16 
	~"¥öt-åì.h
"

17 
	~"backªf.h
"

18 
	~"com¥essi⁄.h
"

19 
	~"qgroup.h
"

20 
	~"block-group.h
"

21 
	~"•a˚-öfo.h
"

22 
	~"z⁄ed.h
"

23 
	~"öode-ôem.h
"

24 
	~"fs.h
"

25 
	~"ac˚ss‹s.h
"

26 
	~"exã¡-åì.h
"

27 
	~"roŸ-åì.h
"

28 
	~"dú-ôem.h
"

29 
	~"fûe-ôem.h
"

30 
	~"fûe.h
"

31 
	~"‹ph™.h
"

32 
	~"åì-checkî.h
"

34 
	#MAX_CONFLICT_INODES
 10

	)

43 
	mLOG_INODE_ALL
,

44 
	mLOG_INODE_EXISTS
,

100 
	mLOG_WALK_PIN_ONLY
,

101 
	mLOG_WALK_REPLAY_INODES
,

102 
	mLOG_WALK_REPLAY_DIR_INDEX
,

103 
	mLOG_WALK_REPLAY_ALL
,

106 
båfs_log_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

107 
båfs_öode
 *
öode
,

108 
öode_⁄ly
,

109 
båfs_log_˘x
 *
˘x
);

110 
lök_to_fixup_dú
(
båfs_å™s_h™dÀ
 *
å™s
,

111 
båfs_roŸ
 *
roŸ
,

112 
båfs_∑th
 *
∑th
, 
u64
 
obje˘id
);

113 
noölöe
 
ª∂ay_dú_dñëes
(
båfs_å™s_h™dÀ
 *
å™s
,

114 
båfs_roŸ
 *
roŸ
,

115 
båfs_roŸ
 *
log
,

116 
båfs_∑th
 *
∑th
,

117 
u64
 
dúid
, 
dñ_Æl
);

118 
waô_log_commô
(
båfs_roŸ
 *
roŸ
, 
å™sid
);

148 
	$°¨t_log_å™s
(
båfs_å™s_h™dÀ
 *
å™s
,

149 
båfs_roŸ
 *
roŸ
,

150 
båfs_log_˘x
 *
˘x
)

152 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

153 
båfs_roŸ
 *
åì_roŸ
 = 
fs_öfo
->tree_root;

154 c⁄° 
boﬁ
 
z⁄ed
 = 
	`båfs_is_z⁄ed
(
fs_öfo
);

155 
ªt
 = 0;

156 
boﬁ
 
¸óãd
 = 
Ál£
;

162 i‡(!
	`ã°_bô
(
BTRFS_ROOT_HAS_LOG_TREE
, &
åì_roŸ
->
°©e
)) {

163 
	`muãx_lock
(&
åì_roŸ
->
log_muãx
);

164 i‡(!
fs_öfo
->
log_roŸ_åì
) {

165 
ªt
 = 
	`båfs_öô_log_roŸ_åì
(
å™s
, 
fs_öfo
);

166 i‡(!
ªt
) {

167 
	`£t_bô
(
BTRFS_ROOT_HAS_LOG_TREE
, &
åì_roŸ
->
°©e
);

168 
¸óãd
 = 
åue
;

171 
	`muãx_u∆ock
(&
åì_roŸ
->
log_muãx
);

172 i‡(
ªt
)

173  
ªt
;

176 
	`muãx_lock
(&
roŸ
->
log_muãx
);

178 
agaö
:

179 i‡(
roŸ
->
log_roŸ
) {

180 
ödex
 = (
roŸ
->
log_å™sid
 + 1) % 2;

182 i‡(
	`båfs_√ed_log_fuŒ_commô
(
å™s
)) {

183 
ªt
 = 
BTRFS_LOG_FORCE_COMMIT
;

184 
out
;

187 i‡(
z⁄ed
 && 
	`©omic_ªad
(&
roŸ
->
log_commô
[
ödex
])) {

188 
	`waô_log_commô
(
roŸ
,ÑoŸ->
log_å™sid
 - 1);

189 
agaö
;

192 i‡(!
roŸ
->
log_°¨t_pid
) {

193 
	`˛ór_bô
(
BTRFS_ROOT_MULTI_LOG_TASKS
, &
roŸ
->
°©e
);

194 
roŸ
->
log_°¨t_pid
 = 
cuºít
->
pid
;

195 } i‡(
roŸ
->
log_°¨t_pid
 !
cuºít
->
pid
) {

196 
	`£t_bô
(
BTRFS_ROOT_MULTI_LOG_TASKS
, &
roŸ
->
°©e
);

205 i‡(
z⁄ed
 && !
¸óãd
) {

206 
ªt
 = 
BTRFS_LOG_FORCE_COMMIT
;

207 
out
;

210 
ªt
 = 
	`båfs_add_log_åì
(
å™s
, 
roŸ
);

211 i‡(
ªt
)

212 
out
;

214 
	`£t_bô
(
BTRFS_ROOT_HAS_LOG_TREE
, &
roŸ
->
°©e
);

215 
	`˛ór_bô
(
BTRFS_ROOT_MULTI_LOG_TASKS
, &
roŸ
->
°©e
);

216 
roŸ
->
log_°¨t_pid
 = 
cuºít
->
pid
;

219 
	`©omic_öc
(&
roŸ
->
log_wrôîs
);

220 i‡(!
˘x
->
loggög_√w_«me
) {

221 
ödex
 = 
roŸ
->
log_å™sid
 % 2;

222 
	`li°_add_èû
(&
˘x
->
li°
, &
roŸ
->
log_˘xs
[
ödex
]);

223 
˘x
->
log_å™sid
 = 
roŸ
->log_transid;

226 
out
:

227 
	`muãx_u∆ock
(&
roŸ
->
log_muãx
);

228  
ªt
;

229 
	}
}

236 
	$joö_ru¬ög_log_å™s
(
båfs_roŸ
 *
roŸ
)

238 c⁄° 
boﬁ
 
z⁄ed
 = 
	`båfs_is_z⁄ed
(
roŸ
->
fs_öfo
);

239 
ªt
 = -
ENOENT
;

241 i‡(!
	`ã°_bô
(
BTRFS_ROOT_HAS_LOG_TREE
, &
roŸ
->
°©e
))

242  
ªt
;

244 
	`muãx_lock
(&
roŸ
->
log_muãx
);

245 
agaö
:

246 i‡(
roŸ
->
log_roŸ
) {

247 
ödex
 = (
roŸ
->
log_å™sid
 + 1) % 2;

249 
ªt
 = 0;

250 i‡(
z⁄ed
 && 
	`©omic_ªad
(&
roŸ
->
log_commô
[
ödex
])) {

251 
	`waô_log_commô
(
roŸ
,ÑoŸ->
log_å™sid
 - 1);

252 
agaö
;

254 
	`©omic_öc
(&
roŸ
->
log_wrôîs
);

256 
	`muãx_u∆ock
(&
roŸ
->
log_muãx
);

257  
ªt
;

258 
	}
}

265 
	$båfs_pö_log_å™s
(
båfs_roŸ
 *
roŸ
)

267 
	`©omic_öc
(&
roŸ
->
log_wrôîs
);

268 
	}
}

274 
	$båfs_íd_log_å™s
(
båfs_roŸ
 *
roŸ
)

276 i‡(
	`©omic_dec_™d_ã°
(&
roŸ
->
log_wrôîs
)) {

278 
	`c⁄d_wake_up_nomb
(&
roŸ
->
log_wrôî_waô
);

280 
	}
}

288 
	swÆk_c⁄åﬁ
 {

292 
	m‰ì
;

297 
	mpö
;

300 
	m°age
;

307 
boﬁ
 
	mign‹e_cur_öode
;

310 
båfs_roŸ
 *
	mª∂ay_de°
;

313 
båfs_å™s_h™dÀ
 *
	må™s
;

320 (*
	m¥o˚ss_func
)(
båfs_roŸ
 *
	mlog
, 
exã¡_buf„r
 *
	meb
,

321 
wÆk_c⁄åﬁ
 *
	mwc
, 
u64
 
	mgí
, 
	mÀvñ
);

327 
	$¥o˚ss_⁄e_buf„r
(
båfs_roŸ
 *
log
,

328 
exã¡_buf„r
 *
eb
,

329 
wÆk_c⁄åﬁ
 *
wc
, 
u64
 
gí
, 
Àvñ
)

331 
båfs_fs_öfo
 *
fs_öfo
 = 
log
->fs_info;

332 
ªt
 = 0;

338 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
MIXED_GROUPS
)) {

339 
båfs_åì_∑ª¡_check
 
check
 = {

340 .
Àvñ
 =Üevel,

341 .
å™sid
 = 
gí


344 
ªt
 = 
	`båfs_ªad_exã¡_buf„r
(
eb
, &
check
);

345 i‡(
ªt
)

346  
ªt
;

349 i‡(
wc
->
pö
) {

350 
ªt
 = 
	`båfs_pö_exã¡_f‹_log_ª∂ay
(
wc
->
å™s
, 
eb
->
°¨t
,

351 
eb
->
Àn
);

352 i‡(
ªt
)

353  
ªt
;

355 i‡(
	`båfs_buf„r_u±od©e
(
eb
, 
gí
, 0) &&

356 
	`båfs_hódî_Àvñ
(
eb
) == 0)

357 
ªt
 = 
	`båfs_ex˛ude_logged_exã¡s
(
eb
);

359  
ªt
;

360 
	}
}

376 
	$ovîwrôe_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

377 
båfs_roŸ
 *
roŸ
,

378 
båfs_∑th
 *
∑th
,

379 
exã¡_buf„r
 *
eb
, 
¶Ÿ
,

380 
båfs_key
 *
key
)

382 
ªt
;

383 
u32
 
ôem_size
;

384 
u64
 
ßved_i_size
 = 0;

385 
ßve_ﬁd_i_size
 = 0;

386 
§c_±r
;

387 
d°_±r
;

388 
boﬁ
 
öode_ôem
 = 
key
->
ty≥
 =
BTRFS_INODE_ITEM_KEY
;

397 
	`ASSERT
(
roŸ
->
roŸ_key
.
obje˘id
 !
BTRFS_TREE_LOG_OBJECTID
);

399 
ôem_size
 = 
	`båfs_ôem_size
(
eb
, 
¶Ÿ
);

400 
§c_±r
 = 
	`båfs_ôem_±r_off£t
(
eb
, 
¶Ÿ
);

403 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, 
key
, 
∑th
, 0, 0);

404 i‡(
ªt
 < 0)

405  
ªt
;

407 i‡(
ªt
 == 0) {

408 *
§c_c›y
;

409 *
d°_c›y
;

410 
u32
 
d°_size
 = 
	`båfs_ôem_size
(
∑th
->
nodes
[0],

411 
∑th
->
¶Ÿs
[0]);

412 i‡(
d°_size
 !
ôem_size
)

413 
ö£π
;

415 i‡(
ôem_size
 == 0) {

416 
	`båfs_ªÀa£_∑th
(
∑th
);

419 
d°_c›y
 = 
	`kmÆloc
(
ôem_size
, 
GFP_NOFS
);

420 
§c_c›y
 = 
	`kmÆloc
(
ôem_size
, 
GFP_NOFS
);

421 i‡(!
d°_c›y
 || !
§c_c›y
) {

422 
	`båfs_ªÀa£_∑th
(
∑th
);

423 
	`k‰ì
(
d°_c›y
);

424 
	`k‰ì
(
§c_c›y
);

425  -
ENOMEM
;

428 
	`ªad_exã¡_buf„r
(
eb
, 
§c_c›y
, 
§c_±r
, 
ôem_size
);

430 
d°_±r
 = 
	`båfs_ôem_±r_off£t
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0]);

431 
	`ªad_exã¡_buf„r
(
∑th
->
nodes
[0], 
d°_c›y
, 
d°_±r
,

432 
ôem_size
);

433 
ªt
 = 
	`memcmp
(
d°_c›y
, 
§c_c›y
, 
ôem_size
);

435 
	`k‰ì
(
d°_c›y
);

436 
	`k‰ì
(
§c_c›y
);

443 i‡(
ªt
 == 0) {

444 
	`båfs_ªÀa£_∑th
(
∑th
);

452 i‡(
öode_ôem
) {

453 
båfs_öode_ôem
 *
ôem
;

454 
u64
 
nbyãs
;

455 
u32
 
mode
;

457 
ôem
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

458 
båfs_öode_ôem
);

459 
nbyãs
 = 
	`båfs_öode_nbyãs
(
∑th
->
nodes
[0], 
ôem
);

460 
ôem
 = 
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
,

461 
båfs_öode_ôem
);

462 
	`båfs_£t_öode_nbyãs
(
eb
, 
ôem
, 
nbyãs
);

469 
mode
 = 
	`båfs_öode_mode
(
eb
, 
ôem
);

470 i‡(
	`S_ISDIR
(
mode
))

471 
	`båfs_£t_öode_size
(
eb
, 
ôem
, 0);

473 } i‡(
öode_ôem
) {

474 
båfs_öode_ôem
 *
ôem
;

475 
u32
 
mode
;

481 
ôem
 = 
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
, 
båfs_öode_ôem
);

482 
	`båfs_£t_öode_nbyãs
(
eb
, 
ôem
, 0);

489 
mode
 = 
	`båfs_öode_mode
(
eb
, 
ôem
);

490 i‡(
	`S_ISDIR
(
mode
))

491 
	`båfs_£t_öode_size
(
eb
, 
ôem
, 0);

493 
ö£π
:

494 
	`båfs_ªÀa£_∑th
(
∑th
);

496 
∑th
->
skù_ªÀa£_⁄_îr‹
 = 1;

497 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
,

498 
key
, 
ôem_size
);

499 
∑th
->
skù_ªÀa£_⁄_îr‹
 = 0;

502 i‡(
ªt
 =-
EEXIST
 ||Ñë =-
EOVERFLOW
) {

503 
u32
 
found_size
;

504 
found_size
 = 
	`båfs_ôem_size
(
∑th
->
nodes
[0],

505 
∑th
->
¶Ÿs
[0]);

506 i‡(
found_size
 > 
ôem_size
)

507 
	`båfs_åunˇã_ôem
(
å™s
, 
∑th
, 
ôem_size
, 1);

508 i‡(
found_size
 < 
ôem_size
)

509 
	`båfs_exãnd_ôem
(
å™s
, 
∑th
, 
ôem_size
 - 
found_size
);

510 } i‡(
ªt
) {

511  
ªt
;

513 
d°_±r
 = 
	`båfs_ôem_±r_off£t
(
∑th
->
nodes
[0],

514 
∑th
->
¶Ÿs
[0]);

525 i‡(
key
->
ty≥
 =
BTRFS_INODE_ITEM_KEY
 && 
ªt
 =-
EEXIST
) {

526 
båfs_öode_ôem
 *
§c_ôem
;

527 
båfs_öode_ôem
 *
d°_ôem
;

529 
§c_ôem
 = (
båfs_öode_ôem
 *)
§c_±r
;

530 
d°_ôem
 = (
båfs_öode_ôem
 *)
d°_±r
;

532 i‡(
	`båfs_öode_gíî©i⁄
(
eb
, 
§c_ôem
) == 0) {

533 
exã¡_buf„r
 *
d°_eb
 = 
∑th
->
nodes
[0];

534 c⁄° 
u64
 
öo_size
 = 
	`båfs_öode_size
(
eb
, 
§c_ôem
);

543 i‡(
	`S_ISREG
(
	`båfs_öode_mode
(
eb
, 
§c_ôem
)) &&

544 
	`S_ISREG
(
	`båfs_öode_mode
(
d°_eb
, 
d°_ôem
)) &&

545 
öo_size
 != 0)

546 
	`båfs_£t_öode_size
(
d°_eb
, 
d°_ôem
, 
öo_size
);

547 
no_c›y
;

550 i‡(
	`S_ISDIR
(
	`båfs_öode_mode
(
eb
, 
§c_ôem
)) &&

551 
	`S_ISDIR
(
	`båfs_öode_mode
(
∑th
->
nodes
[0], 
d°_ôem
))) {

552 
ßve_ﬁd_i_size
 = 1;

553 
ßved_i_size
 = 
	`båfs_öode_size
(
∑th
->
nodes
[0],

554 
d°_ôem
);

558 
	`c›y_exã¡_buf„r
(
∑th
->
nodes
[0], 
eb
, 
d°_±r
,

559 
§c_±r
, 
ôem_size
);

561 i‡(
ßve_ﬁd_i_size
) {

562 
båfs_öode_ôem
 *
d°_ôem
;

563 
d°_ôem
 = (
båfs_öode_ôem
 *)
d°_±r
;

564 
	`båfs_£t_öode_size
(
∑th
->
nodes
[0], 
d°_ôem
, 
ßved_i_size
);

568 i‡(
key
->
ty≥
 =
BTRFS_INODE_ITEM_KEY
) {

569 
båfs_öode_ôem
 *
d°_ôem
;

570 
d°_ôem
 = (
båfs_öode_ôem
 *)
d°_±r
;

571 i‡(
	`båfs_öode_gíî©i⁄
(
∑th
->
nodes
[0], 
d°_ôem
) == 0) {

572 
	`båfs_£t_öode_gíî©i⁄
(
∑th
->
nodes
[0], 
d°_ôem
,

573 
å™s
->
å™sid
);

576 
no_c›y
:

577 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑th
->
nodes
[0]);

578 
	`båfs_ªÀa£_∑th
(
∑th
);

580 
	}
}

582 
	$ªad_Æloc_⁄e_«me
(
exã¡_buf„r
 *
eb
, *
°¨t
, 
Àn
,

583 
fs¸y±_°r
 *
«me
)

585 *
buf
;

587 
buf
 = 
	`kmÆloc
(
Àn
, 
GFP_NOFS
);

588 i‡(!
buf
)

589  -
ENOMEM
;

591 
	`ªad_exã¡_buf„r
(
eb
, 
buf
, ()
°¨t
, 
Àn
);

592 
«me
->«mê
buf
;

593 
«me
->
Àn
 =Üen;

595 
	}
}

601 
noölöe
 
öode
 *
	$ªad_⁄e_öode
(
båfs_roŸ
 *
roŸ
,

602 
u64
 
obje˘id
)

604 
öode
 *inode;

606 
öode
 = 
	`båfs_igë
(
roŸ
->
fs_öfo
->
sb
, 
obje˘id
,Ñoot);

607 i‡(
	`IS_ERR
(
öode
))

608 
öode
 = 
NULL
;

609  
öode
;

610 
	}
}

624 
noölöe
 
	$ª∂ay_⁄e_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

625 
båfs_roŸ
 *
roŸ
,

626 
båfs_∑th
 *
∑th
,

627 
exã¡_buf„r
 *
eb
, 
¶Ÿ
,

628 
båfs_key
 *
key
)

630 
båfs_dr›_exã¡s_¨gs
 
dr›_¨gs
 = { 0 };

631 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

632 
found_ty≥
;

633 
u64
 
exã¡_íd
;

634 
u64
 
°¨t
 = 
key
->
off£t
;

635 
u64
 
nbyãs
 = 0;

636 
båfs_fûe_exã¡_ôem
 *
ôem
;

637 
öode
 *öodê
NULL
;

638 
size
;

639 
ªt
 = 0;

641 
ôem
 = 
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
, 
båfs_fûe_exã¡_ôem
);

642 
found_ty≥
 = 
	`båfs_fûe_exã¡_ty≥
(
eb
, 
ôem
);

644 i‡(
found_ty≥
 =
BTRFS_FILE_EXTENT_REG
 ||

645 
found_ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
) {

646 
nbyãs
 = 
	`båfs_fûe_exã¡_num_byãs
(
eb
, 
ôem
);

647 
exã¡_íd
 = 
°¨t
 + 
nbyãs
;

653 i‡(
	`båfs_fûe_exã¡_disk_byãƒ
(
eb
, 
ôem
) == 0)

654 
nbyãs
 = 0;

655 } i‡(
found_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
) {

656 
size
 = 
	`båfs_fûe_exã¡_øm_byãs
(
eb
, 
ôem
);

657 
nbyãs
 = 
	`båfs_fûe_exã¡_øm_byãs
(
eb
, 
ôem
);

658 
exã¡_íd
 = 
	`ALIGN
(
°¨t
 + 
size
,

659 
fs_öfo
->
£˘‹size
);

661 
ªt
 = 0;

662 
out
;

665 
öode
 = 
	`ªad_⁄e_öode
(
roŸ
, 
key
->
obje˘id
);

666 i‡(!
öode
) {

667 
ªt
 = -
EIO
;

668 
out
;

676 
ªt
 = 
	`båfs_lookup_fûe_exã¡
(
å™s
, 
roŸ
, 
∑th
,

677 
	`båfs_öo
(
	`BTRFS_I
(
öode
)), 
°¨t
, 0);

679 i‡(
ªt
 == 0 &&

680 (
found_ty≥
 =
BTRFS_FILE_EXTENT_REG
 ||

681 
found_ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
)) {

682 
båfs_fûe_exã¡_ôem
 
cmp1
;

683 
båfs_fûe_exã¡_ôem
 
cmp2
;

684 
båfs_fûe_exã¡_ôem
 *
exi°ög
;

685 
exã¡_buf„r
 *
Àaf
;

687 
Àaf
 = 
∑th
->
nodes
[0];

688 
exi°ög
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

689 
båfs_fûe_exã¡_ôem
);

691 
	`ªad_exã¡_buf„r
(
eb
, &
cmp1
, ()
ôem
,

692 (
cmp1
));

693 
	`ªad_exã¡_buf„r
(
Àaf
, &
cmp2
, ()
exi°ög
,

694 (
cmp2
));

700 i‡(
	`memcmp
(&
cmp1
, &
cmp2
, (cmp1)) == 0) {

701 
	`båfs_ªÀa£_∑th
(
∑th
);

702 
out
;

705 
	`båfs_ªÀa£_∑th
(
∑th
);

708 
dr›_¨gs
.
°¨t
 = start;

709 
dr›_¨gs
.
íd
 = 
exã¡_íd
;

710 
dr›_¨gs
.
dr›_ˇche
 = 
åue
;

711 
ªt
 = 
	`båfs_dr›_exã¡s
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
), &
dr›_¨gs
);

712 i‡(
ªt
)

713 
out
;

715 i‡(
found_ty≥
 =
BTRFS_FILE_EXTENT_REG
 ||

716 
found_ty≥
 =
BTRFS_FILE_EXTENT_PREALLOC
) {

717 
u64
 
off£t
;

718 
de°_off£t
;

719 
båfs_key
 
ös
;

721 i‡(
	`båfs_fûe_exã¡_disk_byãƒ
(
eb
, 
ôem
) == 0 &&

722 
	`båfs_fs_öcom∑t
(
fs_öfo
, 
NO_HOLES
))

723 
upd©e_öode
;

725 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, 
key
,

726 (*
ôem
));

727 i‡(
ªt
)

728 
out
;

729 
de°_off£t
 = 
	`båfs_ôem_±r_off£t
(
∑th
->
nodes
[0],

730 
∑th
->
¶Ÿs
[0]);

731 
	`c›y_exã¡_buf„r
(
∑th
->
nodes
[0], 
eb
, 
de°_off£t
,

732 ()
ôem
, (*item));

734 
ös
.
obje˘id
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
eb
, 
ôem
);

735 
ös
.
off£t
 = 
	`båfs_fûe_exã¡_disk_num_byãs
(
eb
, 
ôem
);

736 
ös
.
ty≥
 = 
BTRFS_EXTENT_ITEM_KEY
;

737 
off£t
 = 
key
->off£à- 
	`båfs_fûe_exã¡_off£t
(
eb
, 
ôem
);

747 
ªt
 = 
	`båfs_qgroup_åa˚_exã¡
(
å™s
,

748 
	`båfs_fûe_exã¡_disk_byãƒ
(
eb
, 
ôem
),

749 
	`båfs_fûe_exã¡_disk_num_byãs
(
eb
, 
ôem
));

750 i‡(
ªt
 < 0)

751 
out
;

753 i‡(
ös
.
obje˘id
 > 0) {

754 
båfs_ªf
 
ªf
 = { 0 };

755 
u64
 
csum_°¨t
;

756 
u64
 
csum_íd
;

757 
	`LIST_HEAD
(
‹dîed_sums
);

763 
ªt
 = 
	`båfs_lookup_d©a_exã¡
(
fs_öfo
, 
ös
.
obje˘id
,

764 
ös
.
off£t
);

765 i‡(
ªt
 < 0) {

766 
out
;

767 } i‡(
ªt
 == 0) {

768 
	`båfs_öô_gíîic_ªf
(&
ªf
,

769 
BTRFS_ADD_DELAYED_REF
,

770 
ös
.
obje˘id
, ins.
off£t
, 0);

771 
	`båfs_öô_d©a_ªf
(&
ªf
,

772 
roŸ
->
roŸ_key
.
obje˘id
,

773 
key
->
obje˘id
, 
off£t
, 0, 
Ál£
);

774 
ªt
 = 
	`båfs_öc_exã¡_ªf
(
å™s
, &
ªf
);

775 i‡(
ªt
)

776 
out
;

782 
ªt
 = 
	`båfs_Æloc_logged_fûe_exã¡
(
å™s
,

783 
roŸ
->
roŸ_key
.
obje˘id
,

784 
key
->
obje˘id
, 
off£t
, &
ös
);

785 i‡(
ªt
)

786 
out
;

788 
	`båfs_ªÀa£_∑th
(
∑th
);

790 i‡(
	`båfs_fûe_exã¡_com¥essi⁄
(
eb
, 
ôem
)) {

791 
csum_°¨t
 = 
ös
.
obje˘id
;

792 
csum_íd
 = 
csum_°¨t
 + 
ös
.
off£t
;

794 
csum_°¨t
 = 
ös
.
obje˘id
 +

795 
	`båfs_fûe_exã¡_off£t
(
eb
, 
ôem
);

796 
csum_íd
 = 
csum_°¨t
 +

797 
	`båfs_fûe_exã¡_num_byãs
(
eb
, 
ôem
);

800 
ªt
 = 
	`båfs_lookup_csums_li°
(
roŸ
->
log_roŸ
,

801 
csum_°¨t
, 
csum_íd
 - 1,

802 &
‹dîed_sums
, 0, 
Ál£
);

803 i‡(
ªt
)

804 
out
;

854 !
	`li°_em±y
(&
‹dîed_sums
)) {

855 
båfs_‹dîed_sum
 *
sums
;

856 
båfs_roŸ
 *
csum_roŸ
;

858 
sums
 = 
	`li°_íåy
(
‹dîed_sums
.
√xt
,

859 
båfs_‹dîed_sum
,

860 
li°
);

861 
csum_roŸ
 = 
	`båfs_csum_roŸ
(
fs_öfo
,

862 
sums
->
logiˇl
);

863 i‡(!
ªt
)

864 
ªt
 = 
	`båfs_dñ_csums
(
å™s
, 
csum_roŸ
,

865 
sums
->
logiˇl
,

866 
sums
->
Àn
);

867 i‡(!
ªt
)

868 
ªt
 = 
	`båfs_csum_fûe_blocks
(
å™s
,

869 
csum_roŸ
,

870 
sums
);

871 
	`li°_dñ
(&
sums
->
li°
);

872 
	`k‰ì
(
sums
);

874 i‡(
ªt
)

875 
out
;

877 
	`båfs_ªÀa£_∑th
(
∑th
);

879 } i‡(
found_ty≥
 =
BTRFS_FILE_EXTENT_INLINE
) {

881 
ªt
 = 
	`ovîwrôe_ôem
(
å™s
, 
roŸ
, 
∑th
, 
eb
, 
¶Ÿ
, 
key
);

882 i‡(
ªt
)

883 
out
;

886 
ªt
 = 
	`båfs_öode_£t_fûe_exã¡_ønge
(
	`BTRFS_I
(
öode
), 
°¨t
,

887 
exã¡_íd
 - 
°¨t
);

888 i‡(
ªt
)

889 
out
;

891 
upd©e_öode
:

892 
	`båfs_upd©e_öode_byãs
(
	`BTRFS_I
(
öode
), 
nbyãs
, 
dr›_¨gs
.
byãs_found
);

893 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

894 
out
:

895 
	`ùut
(
öode
);

896  
ªt
;

897 
	}
}

899 
	$u∆ök_öode_f‹_log_ª∂ay
(
båfs_å™s_h™dÀ
 *
å™s
,

900 
båfs_öode
 *
dú
,

901 
båfs_öode
 *
öode
,

902 c⁄° 
fs¸y±_°r
 *
«me
)

904 
ªt
;

906 
ªt
 = 
	`båfs_u∆ök_öode
(
å™s
, 
dú
, 
öode
, 
«me
);

907 i‡(
ªt
)

908  
ªt
;

915  
	`båfs_run_dñayed_ôems
(
å™s
);

916 
	}
}

926 
noölöe
 
	$dr›_⁄e_dú_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

927 
båfs_∑th
 *
∑th
,

928 
båfs_öode
 *
dú
,

929 
båfs_dú_ôem
 *
di
)

931 
båfs_roŸ
 *
roŸ
 = 
dú
->root;

932 
öode
 *inode;

933 
fs¸y±_°r
 
«me
;

934 
exã¡_buf„r
 *
Àaf
;

935 
båfs_key
 
loˇti⁄
;

936 
ªt
;

938 
Àaf
 = 
∑th
->
nodes
[0];

940 
	`båfs_dú_ôem_key_to_˝u
(
Àaf
, 
di
, &
loˇti⁄
);

941 
ªt
 = 
	`ªad_Æloc_⁄e_«me
(
Àaf
, 
di
 + 1, 
	`båfs_dú_«me_Àn
÷óf, di), &
«me
);

942 i‡(
ªt
)

943  -
ENOMEM
;

945 
	`båfs_ªÀa£_∑th
(
∑th
);

947 
öode
 = 
	`ªad_⁄e_öode
(
roŸ
, 
loˇti⁄
.
obje˘id
);

948 i‡(!
öode
) {

949 
ªt
 = -
EIO
;

950 
out
;

953 
ªt
 = 
	`lök_to_fixup_dú
(
å™s
, 
roŸ
, 
∑th
, 
loˇti⁄
.
obje˘id
);

954 i‡(
ªt
)

955 
out
;

957 
ªt
 = 
	`u∆ök_öode_f‹_log_ª∂ay
(
å™s
, 
dú
, 
	`BTRFS_I
(
öode
), &
«me
);

958 
out
:

959 
	`k‰ì
(
«me
.name);

960 
	`ùut
(
öode
);

961  
ªt
;

962 
	}
}

971 
noölöe
 
	$öode_ö_dú
(
båfs_roŸ
 *
roŸ
,

972 
båfs_∑th
 *
∑th
,

973 
u64
 
dúid
, u64 
obje˘id
, u64 
ödex
,

974 
fs¸y±_°r
 *
«me
)

976 
båfs_dú_ôem
 *
di
;

977 
båfs_key
 
loˇti⁄
;

978 
ªt
 = 0;

980 
di
 = 
	`båfs_lookup_dú_ödex_ôem
(
NULL
, 
roŸ
, 
∑th
, 
dúid
,

981 
ödex
, 
«me
, 0);

982 i‡(
	`IS_ERR
(
di
)) {

983 
ªt
 = 
	`PTR_ERR
(
di
);

984 
out
;

985 } i‡(
di
) {

986 
	`båfs_dú_ôem_key_to_˝u
(
∑th
->
nodes
[0], 
di
, &
loˇti⁄
);

987 i‡(
loˇti⁄
.
obje˘id
 != objectid)

988 
out
;

990 
out
;

993 
	`båfs_ªÀa£_∑th
(
∑th
);

994 
di
 = 
	`båfs_lookup_dú_ôem
(
NULL
, 
roŸ
, 
∑th
, 
dúid
, 
«me
, 0);

995 i‡(
	`IS_ERR
(
di
)) {

996 
ªt
 = 
	`PTR_ERR
(
di
);

997 
out
;

998 } i‡(
di
) {

999 
	`båfs_dú_ôem_key_to_˝u
(
∑th
->
nodes
[0], 
di
, &
loˇti⁄
);

1000 i‡(
loˇti⁄
.
obje˘id
 == objectid)

1001 
ªt
 = 1;

1003 
out
:

1004 
	`båfs_ªÀa£_∑th
(
∑th
);

1005  
ªt
;

1006 
	}
}

1018 
noölöe
 
	$backªf_ö_log
(
båfs_roŸ
 *
log
,

1019 
båfs_key
 *
key
,

1020 
u64
 
ªf_obje˘id
,

1021 c⁄° 
fs¸y±_°r
 *
«me
)

1023 
båfs_∑th
 *
∑th
;

1024 
ªt
;

1026 
∑th
 = 
	`båfs_Æloc_∑th
();

1027 i‡(!
∑th
)

1028  -
ENOMEM
;

1030 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
log
, 
key
, 
∑th
, 0, 0);

1031 i‡(
ªt
 < 0) {

1032 
out
;

1033 } i‡(
ªt
 == 1) {

1034 
ªt
 = 0;

1035 
out
;

1038 i‡(
key
->
ty≥
 =
BTRFS_INODE_EXTREF_KEY
)

1039 
ªt
 = !!
	`båfs_föd_«me_ö_ext_backªf
(
∑th
->
nodes
[0],

1040 
∑th
->
¶Ÿs
[0],

1041 
ªf_obje˘id
, 
«me
);

1043 
ªt
 = !!
	`båfs_föd_«me_ö_backªf
(
∑th
->
nodes
[0],

1044 
∑th
->
¶Ÿs
[0], 
«me
);

1045 
out
:

1046 
	`båfs_‰ì_∑th
(
∑th
);

1047  
ªt
;

1048 
	}
}

1050 
ölöe
 
	$__add_öode_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

1051 
båfs_roŸ
 *
roŸ
,

1052 
båfs_∑th
 *
∑th
,

1053 
båfs_roŸ
 *
log_roŸ
,

1054 
båfs_öode
 *
dú
,

1055 
båfs_öode
 *
öode
,

1056 
u64
 
öode_obje˘id
, u64 
∑ª¡_obje˘id
,

1057 
u64
 
ªf_ödex
, 
fs¸y±_°r
 *
«me
)

1059 
ªt
;

1060 
exã¡_buf„r
 *
Àaf
;

1061 
båfs_dú_ôem
 *
di
;

1062 
båfs_key
 
£¨ch_key
;

1063 
båfs_öode_exåef
 *
exåef
;

1065 
agaö
:

1067 
£¨ch_key
.
obje˘id
 = 
öode_obje˘id
;

1068 
£¨ch_key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

1069 
£¨ch_key
.
off£t
 = 
∑ª¡_obje˘id
;

1070 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
£¨ch_key
, 
∑th
, 0, 0);

1071 i‡(
ªt
 == 0) {

1072 
båfs_öode_ªf
 *
vi˘im_ªf
;

1073 
±r
;

1074 
±r_íd
;

1076 
Àaf
 = 
∑th
->
nodes
[0];

1081 i‡(
£¨ch_key
.
obje˘id
 =£¨ch_key.
off£t
)

1088 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

1089 
±r_íd
 = 
±r
 + 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

1090 
±r
 < 
±r_íd
) {

1091 
fs¸y±_°r
 
vi˘im_«me
;

1093 
vi˘im_ªf
 = (
båfs_öode_ªf
 *)
±r
;

1094 
ªt
 = 
	`ªad_Æloc_⁄e_«me
(
Àaf
, (
vi˘im_ªf
 + 1),

1095 
	`båfs_öode_ªf_«me_Àn
(
Àaf
, 
vi˘im_ªf
),

1096 &
vi˘im_«me
);

1097 i‡(
ªt
)

1098  
ªt
;

1100 
ªt
 = 
	`backªf_ö_log
(
log_roŸ
, &
£¨ch_key
,

1101 
∑ª¡_obje˘id
, &
vi˘im_«me
);

1102 i‡(
ªt
 < 0) {

1103 
	`k‰ì
(
vi˘im_«me
.
«me
);

1104  
ªt
;

1105 } i‡(!
ªt
) {

1106 
	`öc_∆ök
(&
öode
->
vfs_öode
);

1107 
	`båfs_ªÀa£_∑th
(
∑th
);

1109 
ªt
 = 
	`u∆ök_öode_f‹_log_ª∂ay
(
å™s
, 
dú
, 
öode
,

1110 &
vi˘im_«me
);

1111 
	`k‰ì
(
vi˘im_«me
.
«me
);

1112 i‡(
ªt
)

1113  
ªt
;

1114 
agaö
;

1116 
	`k‰ì
(
vi˘im_«me
.
«me
);

1118 
±r
 = ()(
vi˘im_ªf
 + 1Ë+ 
vi˘im_«me
.
Àn
;

1121 
	`båfs_ªÀa£_∑th
(
∑th
);

1124 
exåef
 = 
	`båfs_lookup_öode_exåef
(
NULL
, 
roŸ
, 
∑th
, 
«me
,

1125 
öode_obje˘id
, 
∑ª¡_obje˘id
, 0,

1127 i‡(
	`IS_ERR
(
exåef
)) {

1128  
	`PTR_ERR
(
exåef
);

1129 } i‡(
exåef
) {

1130 
u32
 
ôem_size
;

1131 
u32
 
cur_off£t
 = 0;

1132 
ba£
;

1133 
öode
 *
vi˘im_∑ª¡
;

1135 
Àaf
 = 
∑th
->
nodes
[0];

1137 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

1138 
ba£
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

1140 
cur_off£t
 < 
ôem_size
) {

1141 
fs¸y±_°r
 
vi˘im_«me
;

1143 
exåef
 = (
båfs_öode_exåef
 *)(
ba£
 + 
cur_off£t
);

1145 i‡(
	`båfs_öode_exåef_∑ª¡
(
Àaf
, 
exåef
Ë!
∑ª¡_obje˘id
)

1146 
√xt
;

1148 
ªt
 = 
	`ªad_Æloc_⁄e_«me
(
Àaf
, &
exåef
->
«me
,

1149 
	`båfs_öode_exåef_«me_Àn
(
Àaf
, 
exåef
),

1150 &
vi˘im_«me
);

1151 i‡(
ªt
)

1152  
ªt
;

1154 
£¨ch_key
.
obje˘id
 = 
öode_obje˘id
;

1155 
£¨ch_key
.
ty≥
 = 
BTRFS_INODE_EXTREF_KEY
;

1156 
£¨ch_key
.
off£t
 = 
	`båfs_exåef_hash
(
∑ª¡_obje˘id
,

1157 
vi˘im_«me
.
«me
,

1158 
vi˘im_«me
.
Àn
);

1159 
ªt
 = 
	`backªf_ö_log
(
log_roŸ
, &
£¨ch_key
,

1160 
∑ª¡_obje˘id
, &
vi˘im_«me
);

1161 i‡(
ªt
 < 0) {

1162 
	`k‰ì
(
vi˘im_«me
.
«me
);

1163  
ªt
;

1164 } i‡(!
ªt
) {

1165 
ªt
 = -
ENOENT
;

1166 
vi˘im_∑ª¡
 = 
	`ªad_⁄e_öode
(
roŸ
,

1167 
∑ª¡_obje˘id
);

1168 i‡(
vi˘im_∑ª¡
) {

1169 
	`öc_∆ök
(&
öode
->
vfs_öode
);

1170 
	`båfs_ªÀa£_∑th
(
∑th
);

1172 
ªt
 = 
	`u∆ök_öode_f‹_log_ª∂ay
(
å™s
,

1173 
	`BTRFS_I
(
vi˘im_∑ª¡
),

1174 
öode
, &
vi˘im_«me
);

1176 
	`ùut
(
vi˘im_∑ª¡
);

1177 
	`k‰ì
(
vi˘im_«me
.
«me
);

1178 i‡(
ªt
)

1179  
ªt
;

1180 
agaö
;

1182 
	`k‰ì
(
vi˘im_«me
.
«me
);

1183 
√xt
:

1184 
cur_off£t
 +
vi˘im_«me
.
Àn
 + (*
exåef
);

1187 
	`båfs_ªÀa£_∑th
(
∑th
);

1190 
di
 = 
	`båfs_lookup_dú_ödex_ôem
(
å™s
, 
roŸ
, 
∑th
, 
	`båfs_öo
(
dú
),

1191 
ªf_ödex
, 
«me
, 0);

1192 i‡(
	`IS_ERR
(
di
)) {

1193  
	`PTR_ERR
(
di
);

1194 } i‡(
di
) {

1195 
ªt
 = 
	`dr›_⁄e_dú_ôem
(
å™s
, 
∑th
, 
dú
, 
di
);

1196 i‡(
ªt
)

1197  
ªt
;

1199 
	`båfs_ªÀa£_∑th
(
∑th
);

1202 
di
 = 
	`båfs_lookup_dú_ôem
(
å™s
, 
roŸ
, 
∑th
, 
	`båfs_öo
(
dú
), 
«me
, 0);

1203 i‡(
	`IS_ERR
(
di
)) {

1204  
	`PTR_ERR
(
di
);

1205 } i‡(
di
) {

1206 
ªt
 = 
	`dr›_⁄e_dú_ôem
(
å™s
, 
∑th
, 
dú
, 
di
);

1207 i‡(
ªt
)

1208  
ªt
;

1210 
	`båfs_ªÀa£_∑th
(
∑th
);

1213 
	}
}

1215 
	$exåef_gë_fõlds
(
exã¡_buf„r
 *
eb
, 
ªf_±r
,

1216 
fs¸y±_°r
 *
«me
, 
u64
 *
ödex
,

1217 
u64
 *
∑ª¡_obje˘id
)

1219 
båfs_öode_exåef
 *
exåef
;

1220 
ªt
;

1222 
exåef
 = (
båfs_öode_exåef
 *)
ªf_±r
;

1224 
ªt
 = 
	`ªad_Æloc_⁄e_«me
(
eb
, &
exåef
->
«me
,

1225 
	`båfs_öode_exåef_«me_Àn
(
eb
, 
exåef
), 
«me
);

1226 i‡(
ªt
)

1227  
ªt
;

1229 i‡(
ödex
)

1230 *
ödex
 = 
	`båfs_öode_exåef_ödex
(
eb
, 
exåef
);

1231 i‡(
∑ª¡_obje˘id
)

1232 *
∑ª¡_obje˘id
 = 
	`båfs_öode_exåef_∑ª¡
(
eb
, 
exåef
);

1235 
	}
}

1237 
	$ªf_gë_fõlds
(
exã¡_buf„r
 *
eb
, 
ªf_±r
,

1238 
fs¸y±_°r
 *
«me
, 
u64
 *
ödex
)

1240 
båfs_öode_ªf
 *
ªf
;

1241 
ªt
;

1243 
ªf
 = (
båfs_öode_ªf
 *)
ªf_±r
;

1245 
ªt
 = 
	`ªad_Æloc_⁄e_«me
(
eb
, 
ªf
 + 1, 
	`båfs_öode_ªf_«me_Àn
(eb,Ñef),

1246 
«me
);

1247 i‡(
ªt
)

1248  
ªt
;

1250 i‡(
ödex
)

1251 *
ödex
 = 
	`båfs_öode_ªf_ödex
(
eb
, 
ªf
);

1254 
	}
}

1263 
	$u∆ök_ﬁd_öode_ªfs
(
båfs_å™s_h™dÀ
 *
å™s
,

1264 
båfs_roŸ
 *
roŸ
,

1265 
båfs_∑th
 *
∑th
,

1266 
båfs_öode
 *
öode
,

1267 
exã¡_buf„r
 *
log_eb
,

1268 
log_¶Ÿ
,

1269 
båfs_key
 *
key
)

1271 
ªt
;

1272 
ªf_±r
;

1273 
ªf_íd
;

1274 
exã¡_buf„r
 *
eb
;

1276 
agaö
:

1277 
	`båfs_ªÀa£_∑th
(
∑th
);

1278 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, 
key
, 
∑th
, 0, 0);

1279 i‡(
ªt
 > 0) {

1280 
ªt
 = 0;

1281 
out
;

1283 i‡(
ªt
 < 0)

1284 
out
;

1286 
eb
 = 
∑th
->
nodes
[0];

1287 
ªf_±r
 = 
	`båfs_ôem_±r_off£t
(
eb
, 
∑th
->
¶Ÿs
[0]);

1288 
ªf_íd
 = 
ªf_±r
 + 
	`båfs_ôem_size
(
eb
, 
∑th
->
¶Ÿs
[0]);

1289 
ªf_±r
 < 
ªf_íd
) {

1290 
fs¸y±_°r
 
«me
;

1291 
u64
 
∑ª¡_id
;

1293 i‡(
key
->
ty≥
 =
BTRFS_INODE_EXTREF_KEY
) {

1294 
ªt
 = 
	`exåef_gë_fõlds
(
eb
, 
ªf_±r
, &
«me
,

1295 
NULL
, &
∑ª¡_id
);

1297 
∑ª¡_id
 = 
key
->
off£t
;

1298 
ªt
 = 
	`ªf_gë_fõlds
(
eb
, 
ªf_±r
, &
«me
, 
NULL
);

1300 i‡(
ªt
)

1301 
out
;

1303 i‡(
key
->
ty≥
 =
BTRFS_INODE_EXTREF_KEY
)

1304 
ªt
 = !!
	`båfs_föd_«me_ö_ext_backªf
(
log_eb
, 
log_¶Ÿ
,

1305 
∑ª¡_id
, &
«me
);

1307 
ªt
 = !!
	`båfs_föd_«me_ö_backªf
(
log_eb
, 
log_¶Ÿ
, &
«me
);

1309 i‡(!
ªt
) {

1310 
öode
 *
dú
;

1312 
	`båfs_ªÀa£_∑th
(
∑th
);

1313 
dú
 = 
	`ªad_⁄e_öode
(
roŸ
, 
∑ª¡_id
);

1314 i‡(!
dú
) {

1315 
ªt
 = -
ENOENT
;

1316 
	`k‰ì
(
«me
.name);

1317 
out
;

1319 
ªt
 = 
	`u∆ök_öode_f‹_log_ª∂ay
(
å™s
, 
	`BTRFS_I
(
dú
),

1320 
öode
, &
«me
);

1321 
	`k‰ì
(
«me
.name);

1322 
	`ùut
(
dú
);

1323 i‡(
ªt
)

1324 
out
;

1325 
agaö
;

1328 
	`k‰ì
(
«me
.name);

1329 
ªf_±r
 +
«me
.
Àn
;

1330 i‡(
key
->
ty≥
 =
BTRFS_INODE_EXTREF_KEY
)

1331 
ªf_±r
 +(
båfs_öode_exåef
);

1333 
ªf_±r
 +(
båfs_öode_ªf
);

1335 
ªt
 = 0;

1336 
out
:

1337 
	`båfs_ªÀa£_∑th
(
∑th
);

1338  
ªt
;

1339 
	}
}

1347 
noölöe
 
	$add_öode_ªf
(
båfs_å™s_h™dÀ
 *
å™s
,

1348 
båfs_roŸ
 *
roŸ
,

1349 
båfs_roŸ
 *
log
,

1350 
båfs_∑th
 *
∑th
,

1351 
exã¡_buf„r
 *
eb
, 
¶Ÿ
,

1352 
båfs_key
 *
key
)

1354 
öode
 *
dú
 = 
NULL
;

1355 
öode
 *öodê
NULL
;

1356 
ªf_±r
;

1357 
ªf_íd
;

1358 
fs¸y±_°r
 
«me
;

1359 
ªt
;

1360 
log_ªf_vî
 = 0;

1361 
u64
 
∑ª¡_obje˘id
;

1362 
u64
 
öode_obje˘id
;

1363 
u64
 
ªf_ödex
 = 0;

1364 
ªf_°ru˘_size
;

1366 
ªf_±r
 = 
	`båfs_ôem_±r_off£t
(
eb
, 
¶Ÿ
);

1367 
ªf_íd
 = 
ªf_±r
 + 
	`båfs_ôem_size
(
eb
, 
¶Ÿ
);

1369 i‡(
key
->
ty≥
 =
BTRFS_INODE_EXTREF_KEY
) {

1370 
båfs_öode_exåef
 *
r
;

1372 
ªf_°ru˘_size
 = (
båfs_öode_exåef
);

1373 
log_ªf_vî
 = 1;

1374 
r
 = (
båfs_öode_exåef
 *)
ªf_±r
;

1375 
∑ª¡_obje˘id
 = 
	`båfs_öode_exåef_∑ª¡
(
eb
, 
r
);

1377 
ªf_°ru˘_size
 = (
båfs_öode_ªf
);

1378 
∑ª¡_obje˘id
 = 
key
->
off£t
;

1380 
öode_obje˘id
 = 
key
->
obje˘id
;

1388 
dú
 = 
	`ªad_⁄e_öode
(
roŸ
, 
∑ª¡_obje˘id
);

1389 i‡(!
dú
) {

1390 
ªt
 = -
ENOENT
;

1391 
out
;

1394 
öode
 = 
	`ªad_⁄e_öode
(
roŸ
, 
öode_obje˘id
);

1395 i‡(!
öode
) {

1396 
ªt
 = -
EIO
;

1397 
out
;

1400 
ªf_±r
 < 
ªf_íd
) {

1401 i‡(
log_ªf_vî
) {

1402 
ªt
 = 
	`exåef_gë_fõlds
(
eb
, 
ªf_±r
, &
«me
,

1403 &
ªf_ödex
, &
∑ª¡_obje˘id
);

1408 i‡(!
dú
)

1409 
dú
 = 
	`ªad_⁄e_öode
(
roŸ
, 
∑ª¡_obje˘id
);

1410 i‡(!
dú
) {

1411 
ªt
 = -
ENOENT
;

1412 
out
;

1415 
ªt
 = 
	`ªf_gë_fõlds
(
eb
, 
ªf_±r
, &
«me
, &
ªf_ödex
);

1417 i‡(
ªt
)

1418 
out
;

1420 
ªt
 = 
	`öode_ö_dú
(
roŸ
, 
∑th
, 
	`båfs_öo
(
	`BTRFS_I
(
dú
)),

1421 
	`båfs_öo
(
	`BTRFS_I
(
öode
)), 
ªf_ödex
, &
«me
);

1422 i‡(
ªt
 < 0) {

1423 
out
;

1424 } i‡(
ªt
 == 0) {

1432 
ªt
 = 
	`__add_öode_ªf
(
å™s
, 
roŸ
, 
∑th
, 
log
,

1433 
	`BTRFS_I
(
dú
), BTRFS_I(
öode
),

1434 
öode_obje˘id
, 
∑ª¡_obje˘id
,

1435 
ªf_ödex
, &
«me
);

1436 i‡(
ªt
) {

1437 i‡(
ªt
 == 1)

1438 
ªt
 = 0;

1439 
out
;

1443 
ªt
 = 
	`båfs_add_lök
(
å™s
, 
	`BTRFS_I
(
dú
), BTRFS_I(
öode
),

1444 &
«me
, 0, 
ªf_ödex
);

1445 i‡(
ªt
)

1446 
out
;

1448 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

1449 i‡(
ªt
)

1450 
out
;

1454 
ªf_±r
 = ()‘ef_±∏+ 
ªf_°ru˘_size
Ë+ 
«me
.
Àn
;

1455 
	`k‰ì
(
«me
.name);

1456 
«me
.«mê
NULL
;

1457 i‡(
log_ªf_vî
) {

1458 
	`ùut
(
dú
);

1459 
dú
 = 
NULL
;

1471 
ªt
 = 
	`u∆ök_ﬁd_öode_ªfs
(
å™s
, 
roŸ
, 
∑th
, 
	`BTRFS_I
(
öode
), 
eb
, 
¶Ÿ
,

1472 
key
);

1473 i‡(
ªt
)

1474 
out
;

1477 
ªt
 = 
	`ovîwrôe_ôem
(
å™s
, 
roŸ
, 
∑th
, 
eb
, 
¶Ÿ
, 
key
);

1478 
out
:

1479 
	`båfs_ªÀa£_∑th
(
∑th
);

1480 
	`k‰ì
(
«me
.name);

1481 
	`ùut
(
dú
);

1482 
	`ùut
(
öode
);

1483  
ªt
;

1484 
	}
}

1486 
	$cou¡_öode_exåefs
(
båfs_roŸ
 *
roŸ
,

1487 
båfs_öode
 *
öode
, 
båfs_∑th
 *
∑th
)

1489 
ªt
 = 0;

1490 
«me_Àn
;

1491 
∆ök
 = 0;

1492 
u32
 
ôem_size
;

1493 
u32
 
cur_off£t
 = 0;

1494 
u64
 
öode_obje˘id
 = 
	`båfs_öo
(
öode
);

1495 
u64
 
off£t
 = 0;

1496 
±r
;

1497 
båfs_öode_exåef
 *
exåef
;

1498 
exã¡_buf„r
 *
Àaf
;

1501 
ªt
 = 
	`båfs_föd_⁄e_exåef
(
roŸ
, 
öode_obje˘id
, 
off£t
, 
∑th
,

1502 &
exåef
, &
off£t
);

1503 i‡(
ªt
)

1506 
Àaf
 = 
∑th
->
nodes
[0];

1507 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

1508 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]);

1509 
cur_off£t
 = 0;

1511 
cur_off£t
 < 
ôem_size
) {

1512 
exåef
 = (
båfs_öode_exåef
 *Ë(
±r
 + 
cur_off£t
);

1513 
«me_Àn
 = 
	`båfs_öode_exåef_«me_Àn
(
Àaf
, 
exåef
);

1515 
∆ök
++;

1517 
cur_off£t
 +
«me_Àn
 + (*
exåef
);

1520 
off£t
++;

1521 
	`båfs_ªÀa£_∑th
(
∑th
);

1523 
	`båfs_ªÀa£_∑th
(
∑th
);

1525 i‡(
ªt
 < 0 &&Ñë !-
ENOENT
)

1526  
ªt
;

1527  
∆ök
;

1528 
	}
}

1530 
	$cou¡_öode_ªfs
(
båfs_roŸ
 *
roŸ
,

1531 
båfs_öode
 *
öode
, 
båfs_∑th
 *
∑th
)

1533 
ªt
;

1534 
båfs_key
 
key
;

1535 
∆ök
 = 0;

1536 
±r
;

1537 
±r_íd
;

1538 
«me_Àn
;

1539 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

1541 
key
.
obje˘id
 = 
öo
;

1542 
key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

1543 
key
.
off£t
 = (
u64
)-1;

1546 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

1547 i‡(
ªt
 < 0)

1549 i‡(
ªt
 > 0) {

1550 i‡(
∑th
->
¶Ÿs
[0] == 0)

1552 
∑th
->
¶Ÿs
[0]--;

1554 
¥o˚ss_¶Ÿ
:

1555 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,

1556 
∑th
->
¶Ÿs
[0]);

1557 i‡(
key
.
obje˘id
 !
öo
 ||

1558 
key
.
ty≥
 !
BTRFS_INODE_REF_KEY
)

1560 
±r
 = 
	`båfs_ôem_±r_off£t
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0]);

1561 
±r_íd
 = 
±r
 + 
	`båfs_ôem_size
(
∑th
->
nodes
[0],

1562 
∑th
->
¶Ÿs
[0]);

1563 
±r
 < 
±r_íd
) {

1564 
båfs_öode_ªf
 *
ªf
;

1566 
ªf
 = (
båfs_öode_ªf
 *)
±r
;

1567 
«me_Àn
 = 
	`båfs_öode_ªf_«me_Àn
(
∑th
->
nodes
[0],

1568 
ªf
);

1569 
±r
 = ()(
ªf
 + 1Ë+ 
«me_Àn
;

1570 
∆ök
++;

1573 i‡(
key
.
off£t
 == 0)

1575 i‡(
∑th
->
¶Ÿs
[0] > 0) {

1576 
∑th
->
¶Ÿs
[0]--;

1577 
¥o˚ss_¶Ÿ
;

1579 
key
.
off£t
--;

1580 
	`båfs_ªÀa£_∑th
(
∑th
);

1582 
	`båfs_ªÀa£_∑th
(
∑th
);

1584  
∆ök
;

1585 
	}
}

1597 
noölöe
 
	$fixup_öode_lök_cou¡
(
båfs_å™s_h™dÀ
 *
å™s
,

1598 
båfs_roŸ
 *
roŸ
,

1599 
öode
 *inode)

1601 
båfs_∑th
 *
∑th
;

1602 
ªt
;

1603 
u64
 
∆ök
 = 0;

1604 
u64
 
öo
 = 
	`båfs_öo
(
	`BTRFS_I
(
öode
));

1606 
∑th
 = 
	`båfs_Æloc_∑th
();

1607 i‡(!
∑th
)

1608  -
ENOMEM
;

1610 
ªt
 = 
	`cou¡_öode_ªfs
(
roŸ
, 
	`BTRFS_I
(
öode
), 
∑th
);

1611 i‡(
ªt
 < 0)

1612 
out
;

1614 
∆ök
 = 
ªt
;

1616 
ªt
 = 
	`cou¡_öode_exåefs
(
roŸ
, 
	`BTRFS_I
(
öode
), 
∑th
);

1617 i‡(
ªt
 < 0)

1618 
out
;

1620 
∆ök
 +
ªt
;

1622 
ªt
 = 0;

1624 i‡(
∆ök
 !
öode
->
i_∆ök
) {

1625 
	`£t_∆ök
(
öode
, 
∆ök
);

1626 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

1627 i‡(
ªt
)

1628 
out
;

1630 
	`BTRFS_I
(
öode
)->
ödex_˙t
 = (
u64
)-1;

1632 i‡(
öode
->
i_∆ök
 == 0) {

1633 i‡(
	`S_ISDIR
(
öode
->
i_mode
)) {

1634 
ªt
 = 
	`ª∂ay_dú_dñëes
(
å™s
, 
roŸ
, 
NULL
, 
∑th
,

1635 
öo
, 1);

1636 i‡(
ªt
)

1637 
out
;

1639 
ªt
 = 
	`båfs_ö£π_‹ph™_ôem
(
å™s
, 
roŸ
, 
öo
);

1640 i‡(
ªt
 =-
EEXIST
)

1641 
ªt
 = 0;

1644 
out
:

1645 
	`båfs_‰ì_∑th
(
∑th
);

1646  
ªt
;

1647 
	}
}

1649 
noölöe
 
	$fixup_öode_lök_cou¡s
(
båfs_å™s_h™dÀ
 *
å™s
,

1650 
båfs_roŸ
 *
roŸ
,

1651 
båfs_∑th
 *
∑th
)

1653 
ªt
;

1654 
båfs_key
 
key
;

1655 
öode
 *inode;

1657 
key
.
obje˘id
 = 
BTRFS_TREE_LOG_FIXUP_OBJECTID
;

1658 
key
.
ty≥
 = 
BTRFS_ORPHAN_ITEM_KEY
;

1659 
key
.
off£t
 = (
u64
)-1;

1661 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

1662 i‡(
ªt
 < 0)

1665 i‡(
ªt
 == 1) {

1666 
ªt
 = 0;

1667 i‡(
∑th
->
¶Ÿs
[0] == 0)

1669 
∑th
->
¶Ÿs
[0]--;

1672 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

1673 i‡(
key
.
obje˘id
 !
BTRFS_TREE_LOG_FIXUP_OBJECTID
 ||

1674 
key
.
ty≥
 !
BTRFS_ORPHAN_ITEM_KEY
)

1677 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

1678 i‡(
ªt
)

1681 
	`båfs_ªÀa£_∑th
(
∑th
);

1682 
öode
 = 
	`ªad_⁄e_öode
(
roŸ
, 
key
.
off£t
);

1683 i‡(!
öode
) {

1684 
ªt
 = -
EIO
;

1688 
ªt
 = 
	`fixup_öode_lök_cou¡
(
å™s
, 
roŸ
, 
öode
);

1689 
	`ùut
(
öode
);

1690 i‡(
ªt
)

1698 
key
.
off£t
 = (
u64
)-1;

1700 
	`båfs_ªÀa£_∑th
(
∑th
);

1701  
ªt
;

1702 
	}
}

1710 
noölöe
 
	$lök_to_fixup_dú
(
båfs_å™s_h™dÀ
 *
å™s
,

1711 
båfs_roŸ
 *
roŸ
,

1712 
båfs_∑th
 *
∑th
,

1713 
u64
 
obje˘id
)

1715 
båfs_key
 
key
;

1716 
ªt
 = 0;

1717 
öode
 *inode;

1719 
öode
 = 
	`ªad_⁄e_öode
(
roŸ
, 
obje˘id
);

1720 i‡(!
öode
)

1721  -
EIO
;

1723 
key
.
obje˘id
 = 
BTRFS_TREE_LOG_FIXUP_OBJECTID
;

1724 
key
.
ty≥
 = 
BTRFS_ORPHAN_ITEM_KEY
;

1725 
key
.
off£t
 = 
obje˘id
;

1727 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
, 0);

1729 
	`båfs_ªÀa£_∑th
(
∑th
);

1730 i‡(
ªt
 == 0) {

1731 i‡(!
öode
->
i_∆ök
)

1732 
	`£t_∆ök
(
öode
, 1);

1734 
	`öc_∆ök
(
öode
);

1735 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

1736 } i‡(
ªt
 =-
EEXIST
) {

1737 
ªt
 = 0;

1739 
	`ùut
(
öode
);

1741  
ªt
;

1742 
	}
}

1749 
noölöe
 
	$ö£π_⁄e_«me
(
båfs_å™s_h™dÀ
 *
å™s
,

1750 
båfs_roŸ
 *
roŸ
,

1751 
u64
 
dúid
, u64 
ödex
,

1752 c⁄° 
fs¸y±_°r
 *
«me
,

1753 
båfs_key
 *
loˇti⁄
)

1755 
öode
 *inode;

1756 
öode
 *
dú
;

1757 
ªt
;

1759 
öode
 = 
	`ªad_⁄e_öode
(
roŸ
, 
loˇti⁄
->
obje˘id
);

1760 i‡(!
öode
)

1761  -
ENOENT
;

1763 
dú
 = 
	`ªad_⁄e_öode
(
roŸ
, 
dúid
);

1764 i‡(!
dú
) {

1765 
	`ùut
(
öode
);

1766  -
EIO
;

1769 
ªt
 = 
	`båfs_add_lök
(
å™s
, 
	`BTRFS_I
(
dú
), BTRFS_I(
öode
), 
«me
,

1770 1, 
ödex
);

1774 
	`ùut
(
öode
);

1775 
	`ùut
(
dú
);

1776  
ªt
;

1777 
	}
}

1779 
	$dñëe_c⁄Êi˘ög_dú_íåy
(
båfs_å™s_h™dÀ
 *
å™s
,

1780 
båfs_öode
 *
dú
,

1781 
båfs_∑th
 *
∑th
,

1782 
båfs_dú_ôem
 *
d°_di
,

1783 c⁄° 
båfs_key
 *
log_key
,

1784 
u8
 
log_Êags
,

1785 
boﬁ
 
exi°s
)

1787 
båfs_key
 
found_key
;

1789 
	`båfs_dú_ôem_key_to_˝u
(
∑th
->
nodes
[0], 
d°_di
, &
found_key
);

1791 i‡(
found_key
.
obje˘id
 =
log_key
->objectid &&

1792 
found_key
.
ty≥
 =
log_key
->type &&

1793 
found_key
.
off£t
 =
log_key
->offset &&

1794 
	`båfs_dú_Êags
(
∑th
->
nodes
[0], 
d°_di
Ë=
log_Êags
)

1801 i‡(!
exi°s
)

1804  
	`dr›_⁄e_dú_ôem
(
å™s
, 
∑th
, 
dú
, 
d°_di
);

1805 
	}
}

1823 
noölöe
 
	$ª∂ay_⁄e_«me
(
båfs_å™s_h™dÀ
 *
å™s
,

1824 
båfs_roŸ
 *
roŸ
,

1825 
båfs_∑th
 *
∑th
,

1826 
exã¡_buf„r
 *
eb
,

1827 
båfs_dú_ôem
 *
di
,

1828 
båfs_key
 *
key
)

1830 
fs¸y±_°r
 
«me
;

1831 
båfs_dú_ôem
 *
dú_d°_di
;

1832 
båfs_dú_ôem
 *
ödex_d°_di
;

1833 
boﬁ
 
dú_d°_m©ches
 = 
Ál£
;

1834 
boﬁ
 
ödex_d°_m©ches
 = 
Ál£
;

1835 
båfs_key
 
log_key
;

1836 
båfs_key
 
£¨ch_key
;

1837 
öode
 *
dú
;

1838 
u8
 
log_Êags
;

1839 
boﬁ
 
exi°s
;

1840 
ªt
;

1841 
boﬁ
 
upd©e_size
 = 
åue
;

1842 
boﬁ
 
«me_added
 = 
Ál£
;

1844 
dú
 = 
	`ªad_⁄e_öode
(
roŸ
, 
key
->
obje˘id
);

1845 i‡(!
dú
)

1846  -
EIO
;

1848 
ªt
 = 
	`ªad_Æloc_⁄e_«me
(
eb
, 
di
 + 1, 
	`båfs_dú_«me_Àn
”b, di), &
«me
);

1849 i‡(
ªt
)

1850 
out
;

1852 
log_Êags
 = 
	`båfs_dú_Êags
(
eb
, 
di
);

1853 
	`båfs_dú_ôem_key_to_˝u
(
eb
, 
di
, &
log_key
);

1854 
ªt
 = 
	`båfs_lookup_öode
(
å™s
, 
roŸ
, 
∑th
, &
log_key
, 0);

1855 
	`båfs_ªÀa£_∑th
(
∑th
);

1856 i‡(
ªt
 < 0)

1857 
out
;

1858 
exi°s
 = (
ªt
 == 0);

1859 
ªt
 = 0;

1861 
dú_d°_di
 = 
	`båfs_lookup_dú_ôem
(
å™s
, 
roŸ
, 
∑th
, 
key
->
obje˘id
,

1862 &
«me
, 1);

1863 i‡(
	`IS_ERR
(
dú_d°_di
)) {

1864 
ªt
 = 
	`PTR_ERR
(
dú_d°_di
);

1865 
out
;

1866 } i‡(
dú_d°_di
) {

1867 
ªt
 = 
	`dñëe_c⁄Êi˘ög_dú_íåy
(
å™s
, 
	`BTRFS_I
(
dú
), 
∑th
,

1868 
dú_d°_di
, &
log_key
,

1869 
log_Êags
, 
exi°s
);

1870 i‡(
ªt
 < 0)

1871 
out
;

1872 
dú_d°_m©ches
 = (
ªt
 == 1);

1875 
	`båfs_ªÀa£_∑th
(
∑th
);

1877 
ödex_d°_di
 = 
	`båfs_lookup_dú_ödex_ôem
(
å™s
, 
roŸ
, 
∑th
,

1878 
key
->
obje˘id
, key->
off£t
,

1879 &
«me
, 1);

1880 i‡(
	`IS_ERR
(
ödex_d°_di
)) {

1881 
ªt
 = 
	`PTR_ERR
(
ödex_d°_di
);

1882 
out
;

1883 } i‡(
ödex_d°_di
) {

1884 
ªt
 = 
	`dñëe_c⁄Êi˘ög_dú_íåy
(
å™s
, 
	`BTRFS_I
(
dú
), 
∑th
,

1885 
ödex_d°_di
, &
log_key
,

1886 
log_Êags
, 
exi°s
);

1887 i‡(
ªt
 < 0)

1888 
out
;

1889 
ödex_d°_m©ches
 = (
ªt
 == 1);

1892 
	`båfs_ªÀa£_∑th
(
∑th
);

1894 i‡(
dú_d°_m©ches
 && 
ödex_d°_m©ches
) {

1895 
ªt
 = 0;

1896 
upd©e_size
 = 
Ál£
;

1897 
out
;

1904 
£¨ch_key
.
obje˘id
 = 
log_key
.objectid;

1905 
£¨ch_key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

1906 
£¨ch_key
.
off£t
 = 
key
->
obje˘id
;

1907 
ªt
 = 
	`backªf_ö_log
(
roŸ
->
log_roŸ
, &
£¨ch_key
, 0, &
«me
);

1908 i‡(
ªt
 < 0) {

1909 
out
;

1910 } i‡(
ªt
) {

1912 
ªt
 = 0;

1913 
upd©e_size
 = 
Ál£
;

1914 
out
;

1917 
£¨ch_key
.
obje˘id
 = 
log_key
.objectid;

1918 
£¨ch_key
.
ty≥
 = 
BTRFS_INODE_EXTREF_KEY
;

1919 
£¨ch_key
.
off£t
 = 
key
->
obje˘id
;

1920 
ªt
 = 
	`backªf_ö_log
(
roŸ
->
log_roŸ
, &
£¨ch_key
, 
key
->
obje˘id
, &
«me
);

1921 i‡(
ªt
 < 0) {

1922 
out
;

1923 } i‡(
ªt
) {

1925 
ªt
 = 0;

1926 
upd©e_size
 = 
Ál£
;

1927 
out
;

1929 
	`båfs_ªÀa£_∑th
(
∑th
);

1930 
ªt
 = 
	`ö£π_⁄e_«me
(
å™s
, 
roŸ
, 
key
->
obje˘id
, key->
off£t
,

1931 &
«me
, &
log_key
);

1932 i‡(
ªt
 &&Ñë !-
ENOENT
 &&Ñë !-
EEXIST
)

1933 
out
;

1934 i‡(!
ªt
)

1935 
«me_added
 = 
åue
;

1936 
upd©e_size
 = 
Ál£
;

1937 
ªt
 = 0;

1939 
out
:

1940 i‡(!
ªt
 && 
upd©e_size
) {

1941 
	`båfs_i_size_wrôe
(
	`BTRFS_I
(
dú
), dú->
i_size
 + 
«me
.
Àn
 * 2);

1942 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
dú
));

1944 
	`k‰ì
(
«me
.name);

1945 
	`ùut
(
dú
);

1946 i‡(!
ªt
 && 
«me_added
)

1947 
ªt
 = 1;

1948  
ªt
;

1949 
	}
}

1952 
noölöe
 
	$ª∂ay_⁄e_dú_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

1953 
båfs_roŸ
 *
roŸ
,

1954 
båfs_∑th
 *
∑th
,

1955 
exã¡_buf„r
 *
eb
, 
¶Ÿ
,

1956 
båfs_key
 *
key
)

1958 
ªt
;

1959 
båfs_dú_ôem
 *
di
;

1962 
	`ASSERT
(
key
->
ty≥
 =
BTRFS_DIR_INDEX_KEY
);

1964 
di
 = 
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
, 
båfs_dú_ôem
);

1965 
ªt
 = 
	`ª∂ay_⁄e_«me
(
å™s
, 
roŸ
, 
∑th
, 
eb
, 
di
, 
key
);

1966 i‡(
ªt
 < 0)

1967  
ªt
;

1995 i‡(
ªt
 =1 && 
	`båfs_dú_·y≥
(
eb
, 
di
Ë!
BTRFS_FT_DIR
) {

1996 
båfs_∑th
 *
fixup_∑th
;

1997 
båfs_key
 
di_key
;

1999 
fixup_∑th
 = 
	`båfs_Æloc_∑th
();

2000 i‡(!
fixup_∑th
)

2001  -
ENOMEM
;

2003 
	`båfs_dú_ôem_key_to_˝u
(
eb
, 
di
, &
di_key
);

2004 
ªt
 = 
	`lök_to_fixup_dú
(
å™s
, 
roŸ
, 
fixup_∑th
, 
di_key
.
obje˘id
);

2005 
	`båfs_‰ì_∑th
(
fixup_∑th
);

2008  
ªt
;

2009 
	}
}

2022 
noölöe
 
	$föd_dú_ønge
(
båfs_roŸ
 *
roŸ
,

2023 
båfs_∑th
 *
∑th
,

2024 
u64
 
dúid
,

2025 
u64
 *
°¨t_ªt
, u64 *
íd_ªt
)

2027 
båfs_key
 
key
;

2028 
u64
 
found_íd
;

2029 
båfs_dú_log_ôem
 *
ôem
;

2030 
ªt
;

2031 
ƒôems
;

2033 i‡(*
°¨t_ªt
 =(
u64
)-1)

2036 
key
.
obje˘id
 = 
dúid
;

2037 
key
.
ty≥
 = 
BTRFS_DIR_LOG_INDEX_KEY
;

2038 
key
.
off£t
 = *
°¨t_ªt
;

2040 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

2041 i‡(
ªt
 < 0)

2042 
out
;

2043 i‡(
ªt
 > 0) {

2044 i‡(
∑th
->
¶Ÿs
[0] == 0)

2045 
out
;

2046 
∑th
->
¶Ÿs
[0]--;

2048 i‡(
ªt
 != 0)

2049 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

2051 i‡(
key
.
ty≥
 !
BTRFS_DIR_LOG_INDEX_KEY
 || key.
obje˘id
 !
dúid
) {

2052 
ªt
 = 1;

2053 
√xt
;

2055 
ôem
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

2056 
båfs_dú_log_ôem
);

2057 
found_íd
 = 
	`båfs_dú_log_íd
(
∑th
->
nodes
[0], 
ôem
);

2059 i‡(*
°¨t_ªt
 >
key
.
off£t
 && *°¨t_ªà<
found_íd
) {

2060 
ªt
 = 0;

2061 *
°¨t_ªt
 = 
key
.
off£t
;

2062 *
íd_ªt
 = 
found_íd
;

2063 
out
;

2065 
ªt
 = 1;

2066 
√xt
:

2068 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0]);

2069 
∑th
->
¶Ÿs
[0]++;

2070 i‡(
∑th
->
¶Ÿs
[0] >
ƒôems
) {

2071 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

2072 i‡(
ªt
)

2073 
out
;

2076 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

2078 i‡(
key
.
ty≥
 !
BTRFS_DIR_LOG_INDEX_KEY
 || key.
obje˘id
 !
dúid
) {

2079 
ªt
 = 1;

2080 
out
;

2082 
ôem
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

2083 
båfs_dú_log_ôem
);

2084 
found_íd
 = 
	`båfs_dú_log_íd
(
∑th
->
nodes
[0], 
ôem
);

2085 *
°¨t_ªt
 = 
key
.
off£t
;

2086 *
íd_ªt
 = 
found_íd
;

2087 
ªt
 = 0;

2088 
out
:

2089 
	`båfs_ªÀa£_∑th
(
∑th
);

2090  
ªt
;

2091 
	}
}

2098 
noölöe
 
	$check_ôem_ö_log
(
båfs_å™s_h™dÀ
 *
å™s
,

2099 
båfs_roŸ
 *
log
,

2100 
båfs_∑th
 *
∑th
,

2101 
båfs_∑th
 *
log_∑th
,

2102 
öode
 *
dú
,

2103 
båfs_key
 *
dú_key
)

2105 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
dú
)->root;

2106 
ªt
;

2107 
exã¡_buf„r
 *
eb
;

2108 
¶Ÿ
;

2109 
båfs_dú_ôem
 *
di
;

2110 
fs¸y±_°r
 
«me
;

2111 
öode
 *öodê
NULL
;

2112 
båfs_key
 
loˇti⁄
;

2120 
	`ASSERT
(
dú_key
->
ty≥
 =
BTRFS_DIR_INDEX_KEY
);

2122 
eb
 = 
∑th
->
nodes
[0];

2123 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

2124 
di
 = 
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
, 
båfs_dú_ôem
);

2125 
ªt
 = 
	`ªad_Æloc_⁄e_«me
(
eb
, 
di
 + 1, 
	`båfs_dú_«me_Àn
”b, di), &
«me
);

2126 i‡(
ªt
)

2127 
out
;

2129 i‡(
log
) {

2130 
båfs_dú_ôem
 *
log_di
;

2132 
log_di
 = 
	`båfs_lookup_dú_ödex_ôem
(
å™s
, 
log
, 
log_∑th
,

2133 
dú_key
->
obje˘id
,

2134 
dú_key
->
off£t
, &
«me
, 0);

2135 i‡(
	`IS_ERR
(
log_di
)) {

2136 
ªt
 = 
	`PTR_ERR
(
log_di
);

2137 
out
;

2138 } i‡(
log_di
) {

2140 
ªt
 = 0;

2141 
out
;

2145 
	`båfs_dú_ôem_key_to_˝u
(
eb
, 
di
, &
loˇti⁄
);

2146 
	`båfs_ªÀa£_∑th
(
∑th
);

2147 
	`båfs_ªÀa£_∑th
(
log_∑th
);

2148 
öode
 = 
	`ªad_⁄e_öode
(
roŸ
, 
loˇti⁄
.
obje˘id
);

2149 i‡(!
öode
) {

2150 
ªt
 = -
EIO
;

2151 
out
;

2154 
ªt
 = 
	`lök_to_fixup_dú
(
å™s
, 
roŸ
, 
∑th
, 
loˇti⁄
.
obje˘id
);

2155 i‡(
ªt
)

2156 
out
;

2158 
	`öc_∆ök
(
öode
);

2159 
ªt
 = 
	`u∆ök_öode_f‹_log_ª∂ay
(
å™s
, 
	`BTRFS_I
(
dú
), BTRFS_I(
öode
),

2160 &
«me
);

2166 
out
:

2167 
	`båfs_ªÀa£_∑th
(
∑th
);

2168 
	`båfs_ªÀa£_∑th
(
log_∑th
);

2169 
	`k‰ì
(
«me
.name);

2170 
	`ùut
(
öode
);

2171  
ªt
;

2172 
	}
}

2174 
	$ª∂ay_x©å_dñëes
(
båfs_å™s_h™dÀ
 *
å™s
,

2175 
båfs_roŸ
 *
roŸ
,

2176 
båfs_roŸ
 *
log
,

2177 
båfs_∑th
 *
∑th
,

2178 c⁄° 
u64
 
öo
)

2180 
båfs_key
 
£¨ch_key
;

2181 
båfs_∑th
 *
log_∑th
;

2182 
i
;

2183 
ƒôems
;

2184 
ªt
;

2186 
log_∑th
 = 
	`båfs_Æloc_∑th
();

2187 i‡(!
log_∑th
)

2188  -
ENOMEM
;

2190 
£¨ch_key
.
obje˘id
 = 
öo
;

2191 
£¨ch_key
.
ty≥
 = 
BTRFS_XATTR_ITEM_KEY
;

2192 
£¨ch_key
.
off£t
 = 0;

2193 
agaö
:

2194 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
£¨ch_key
, 
∑th
, 0, 0);

2195 i‡(
ªt
 < 0)

2196 
out
;

2197 
¥o˚ss_Àaf
:

2198 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0]);

2199 
i
 = 
∑th
->
¶Ÿs
[0]; i < 
ƒôems
; i++) {

2200 
båfs_key
 
key
;

2201 
båfs_dú_ôem
 *
di
;

2202 
båfs_dú_ôem
 *
log_di
;

2203 
u32
 
tŸÆ_size
;

2204 
u32
 
cur
;

2206 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
, 
i
);

2207 i‡(
key
.
obje˘id
 !
öo
 || key.
ty≥
 !
BTRFS_XATTR_ITEM_KEY
) {

2208 
ªt
 = 0;

2209 
out
;

2212 
di
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0], 
i
, 
båfs_dú_ôem
);

2213 
tŸÆ_size
 = 
	`båfs_ôem_size
(
∑th
->
nodes
[0], 
i
);

2214 
cur
 = 0;

2215 
cur
 < 
tŸÆ_size
) {

2216 
u16
 
«me_Àn
 = 
	`båfs_dú_«me_Àn
(
∑th
->
nodes
[0], 
di
);

2217 
u16
 
d©a_Àn
 = 
	`båfs_dú_d©a_Àn
(
∑th
->
nodes
[0], 
di
);

2218 
u32
 
this_Àn
 = (*
di
Ë+ 
«me_Àn
 + 
d©a_Àn
;

2219 *
«me
;

2221 
«me
 = 
	`kmÆloc
(
«me_Àn
, 
GFP_NOFS
);

2222 i‡(!
«me
) {

2223 
ªt
 = -
ENOMEM
;

2224 
out
;

2226 
	`ªad_exã¡_buf„r
(
∑th
->
nodes
[0], 
«me
,

2227 ()(
di
 + 1), 
«me_Àn
);

2229 
log_di
 = 
	`båfs_lookup_x©å
(
NULL
, 
log
, 
log_∑th
, 
öo
,

2230 
«me
, 
«me_Àn
, 0);

2231 
	`båfs_ªÀa£_∑th
(
log_∑th
);

2232 i‡(!
log_di
) {

2234 
	`båfs_ªÀa£_∑th
(
∑th
);

2235 
di
 = 
	`båfs_lookup_x©å
(
å™s
, 
roŸ
, 
∑th
, 
öo
,

2236 
«me
, 
«me_Àn
, -1);

2237 
	`k‰ì
(
«me
);

2238 i‡(
	`IS_ERR
(
di
)) {

2239 
ªt
 = 
	`PTR_ERR
(
di
);

2240 
out
;

2242 
	`ASSERT
(
di
);

2243 
ªt
 = 
	`båfs_dñëe_⁄e_dú_«me
(
å™s
, 
roŸ
,

2244 
∑th
, 
di
);

2245 i‡(
ªt
)

2246 
out
;

2247 
	`båfs_ªÀa£_∑th
(
∑th
);

2248 
£¨ch_key
 = 
key
;

2249 
agaö
;

2251 
	`k‰ì
(
«me
);

2252 i‡(
	`IS_ERR
(
log_di
)) {

2253 
ªt
 = 
	`PTR_ERR
(
log_di
);

2254 
out
;

2256 
cur
 +
this_Àn
;

2257 
di
 = (
båfs_dú_ôem
 *)((*)dò+ 
this_Àn
);

2260 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

2261 i‡(
ªt
 > 0)

2262 
ªt
 = 0;

2263 i‡(
ªt
 == 0)

2264 
¥o˚ss_Àaf
;

2265 
out
:

2266 
	`båfs_‰ì_∑th
(
log_∑th
);

2267 
	`båfs_ªÀa£_∑th
(
∑th
);

2268  
ªt
;

2269 
	}
}

2282 
noölöe
 
	$ª∂ay_dú_dñëes
(
båfs_å™s_h™dÀ
 *
å™s
,

2283 
båfs_roŸ
 *
roŸ
,

2284 
båfs_roŸ
 *
log
,

2285 
båfs_∑th
 *
∑th
,

2286 
u64
 
dúid
, 
dñ_Æl
)

2288 
u64
 
ønge_°¨t
;

2289 
u64
 
ønge_íd
;

2290 
ªt
 = 0;

2291 
båfs_key
 
dú_key
;

2292 
båfs_key
 
found_key
;

2293 
båfs_∑th
 *
log_∑th
;

2294 
öode
 *
dú
;

2296 
dú_key
.
obje˘id
 = 
dúid
;

2297 
dú_key
.
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

2298 
log_∑th
 = 
	`båfs_Æloc_∑th
();

2299 i‡(!
log_∑th
)

2300  -
ENOMEM
;

2302 
dú
 = 
	`ªad_⁄e_öode
(
roŸ
, 
dúid
);

2307 i‡(!
dú
) {

2308 
	`båfs_‰ì_∑th
(
log_∑th
);

2312 
ønge_°¨t
 = 0;

2313 
ønge_íd
 = 0;

2315 i‡(
dñ_Æl
)

2316 
ønge_íd
 = (
u64
)-1;

2318 
ªt
 = 
	`föd_dú_ønge
(
log
, 
∑th
, 
dúid
,

2319 &
ønge_°¨t
, &
ønge_íd
);

2320 i‡(
ªt
 < 0)

2321 
out
;

2322 i‡(
ªt
 > 0)

2326 
dú_key
.
off£t
 = 
ønge_°¨t
;

2328 
ƒôems
;

2329 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
dú_key
, 
∑th
,

2331 i‡(
ªt
 < 0)

2332 
out
;

2334 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0]);

2335 i‡(
∑th
->
¶Ÿs
[0] >
ƒôems
) {

2336 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

2337 i‡(
ªt
 == 1)

2339 i‡(
ªt
 < 0)

2340 
out
;

2342 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
found_key
,

2343 
∑th
->
¶Ÿs
[0]);

2344 i‡(
found_key
.
obje˘id
 !
dúid
 ||

2345 
found_key
.
ty≥
 !
dú_key
.type) {

2346 
ªt
 = 0;

2347 
out
;

2350 i‡(
found_key
.
off£t
 > 
ønge_íd
)

2353 
ªt
 = 
	`check_ôem_ö_log
(
å™s
, 
log
, 
∑th
,

2354 
log_∑th
, 
dú
,

2355 &
found_key
);

2356 i‡(
ªt
)

2357 
out
;

2358 i‡(
found_key
.
off£t
 =(
u64
)-1)

2360 
dú_key
.
off£t
 = 
found_key
.offset + 1;

2362 
	`båfs_ªÀa£_∑th
(
∑th
);

2363 i‡(
ønge_íd
 =(
u64
)-1)

2365 
ønge_°¨t
 = 
ønge_íd
 + 1;

2367 
ªt
 = 0;

2368 
out
:

2369 
	`båfs_ªÀa£_∑th
(
∑th
);

2370 
	`båfs_‰ì_∑th
(
log_∑th
);

2371 
	`ùut
(
dú
);

2372  
ªt
;

2373 
	}
}

2386 
	$ª∂ay_⁄e_buf„r
(
båfs_roŸ
 *
log
, 
exã¡_buf„r
 *
eb
,

2387 
wÆk_c⁄åﬁ
 *
wc
, 
u64
 
gí
, 
Àvñ
)

2389 
ƒôems
;

2390 
båfs_åì_∑ª¡_check
 
check
 = {

2391 .
å™sid
 = 
gí
,

2392 .
Àvñ
 =Üevel

2394 
båfs_∑th
 *
∑th
;

2395 
båfs_roŸ
 *
roŸ
 = 
wc
->
ª∂ay_de°
;

2396 
båfs_key
 
key
;

2397 
i
;

2398 
ªt
;

2400 
ªt
 = 
	`båfs_ªad_exã¡_buf„r
(
eb
, &
check
);

2401 i‡(
ªt
)

2402  
ªt
;

2404 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
eb
);

2406 i‡(
Àvñ
 != 0)

2409 
∑th
 = 
	`båfs_Æloc_∑th
();

2410 i‡(!
∑th
)

2411  -
ENOMEM
;

2413 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
eb
);

2414 
i
 = 0; i < 
ƒôems
; i++) {

2415 
	`båfs_ôem_key_to_˝u
(
eb
, &
key
, 
i
);

2418 i‡(
key
.
ty≥
 =
BTRFS_INODE_ITEM_KEY
 &&

2419 
wc
->
°age
 =
LOG_WALK_REPLAY_INODES
) {

2420 
båfs_öode_ôem
 *
öode_ôem
;

2421 
u32
 
mode
;

2423 
öode_ôem
 = 
	`båfs_ôem_±r
(
eb
, 
i
,

2424 
båfs_öode_ôem
);

2433 i‡(
	`båfs_öode_∆ök
(
eb
, 
öode_ôem
) == 0) {

2434 
wc
->
ign‹e_cur_öode
 = 
åue
;

2437 
wc
->
ign‹e_cur_öode
 = 
Ál£
;

2439 
ªt
 = 
	`ª∂ay_x©å_dñëes
(
wc
->
å™s
, 
roŸ
, 
log
,

2440 
∑th
, 
key
.
obje˘id
);

2441 i‡(
ªt
)

2443 
mode
 = 
	`båfs_öode_mode
(
eb
, 
öode_ôem
);

2444 i‡(
	`S_ISDIR
(
mode
)) {

2445 
ªt
 = 
	`ª∂ay_dú_dñëes
(
wc
->
å™s
,

2446 
roŸ
, 
log
, 
∑th
, 
key
.
obje˘id
, 0);

2447 i‡(
ªt
)

2450 
ªt
 = 
	`ovîwrôe_ôem
(
wc
->
å™s
, 
roŸ
, 
∑th
,

2451 
eb
, 
i
, &
key
);

2452 i‡(
ªt
)

2463 i‡(
	`S_ISREG
(
mode
)) {

2464 
båfs_dr›_exã¡s_¨gs
 
dr›_¨gs
 = { 0 };

2465 
öode
 *inode;

2466 
u64
 
‰om
;

2468 
öode
 = 
	`ªad_⁄e_öode
(
roŸ
, 
key
.
obje˘id
);

2469 i‡(!
öode
) {

2470 
ªt
 = -
EIO
;

2473 
‰om
 = 
	`ALIGN
(
	`i_size_ªad
(
öode
),

2474 
roŸ
->
fs_öfo
->
£˘‹size
);

2475 
dr›_¨gs
.
°¨t
 = 
‰om
;

2476 
dr›_¨gs
.
íd
 = (
u64
)-1;

2477 
dr›_¨gs
.
dr›_ˇche
 = 
åue
;

2478 
ªt
 = 
	`båfs_dr›_exã¡s
(
wc
->
å™s
, 
roŸ
,

2479 
	`BTRFS_I
(
öode
),

2480 &
dr›_¨gs
);

2481 i‡(!
ªt
) {

2482 
	`öode_sub_byãs
(
öode
,

2483 
dr›_¨gs
.
byãs_found
);

2485 
ªt
 = 
	`båfs_upd©e_öode
(
wc
->
å™s
,

2486 
roŸ
, 
	`BTRFS_I
(
öode
));

2488 
	`ùut
(
öode
);

2489 i‡(
ªt
)

2493 
ªt
 = 
	`lök_to_fixup_dú
(
wc
->
å™s
, 
roŸ
,

2494 
∑th
, 
key
.
obje˘id
);

2495 i‡(
ªt
)

2499 i‡(
wc
->
ign‹e_cur_öode
)

2502 i‡(
key
.
ty≥
 =
BTRFS_DIR_INDEX_KEY
 &&

2503 
wc
->
°age
 =
LOG_WALK_REPLAY_DIR_INDEX
) {

2504 
ªt
 = 
	`ª∂ay_⁄e_dú_ôem
(
wc
->
å™s
, 
roŸ
, 
∑th
,

2505 
eb
, 
i
, &
key
);

2506 i‡(
ªt
)

2510 i‡(
wc
->
°age
 < 
LOG_WALK_REPLAY_ALL
)

2514 i‡(
key
.
ty≥
 =
BTRFS_XATTR_ITEM_KEY
) {

2515 
ªt
 = 
	`ovîwrôe_ôem
(
wc
->
å™s
, 
roŸ
, 
∑th
,

2516 
eb
, 
i
, &
key
);

2517 i‡(
ªt
)

2519 } i‡(
key
.
ty≥
 =
BTRFS_INODE_REF_KEY
 ||

2520 
key
.
ty≥
 =
BTRFS_INODE_EXTREF_KEY
) {

2521 
ªt
 = 
	`add_öode_ªf
(
wc
->
å™s
, 
roŸ
, 
log
, 
∑th
,

2522 
eb
, 
i
, &
key
);

2523 i‡(
ªt
 &&Ñë !-
ENOENT
)

2525 
ªt
 = 0;

2526 } i‡(
key
.
ty≥
 =
BTRFS_EXTENT_DATA_KEY
) {

2527 
ªt
 = 
	`ª∂ay_⁄e_exã¡
(
wc
->
å™s
, 
roŸ
, 
∑th
,

2528 
eb
, 
i
, &
key
);

2529 i‡(
ªt
)

2539 
	`båfs_‰ì_∑th
(
∑th
);

2540  
ªt
;

2541 
	}
}

2546 
	$u«ccou¡_log_buf„r
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
°¨t
)

2548 
båfs_block_group
 *
ˇche
;

2550 
ˇche
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
°¨t
);

2551 i‡(!
ˇche
) {

2552 
	`båfs_îr
(
fs_öfo
, "u«bÀÅÿföd block grou∞f‹ %Œu", 
°¨t
);

2556 
	`•ö_lock
(&
ˇche
->
•a˚_öfo
->
lock
);

2557 
	`•ö_lock
(&
ˇche
->
lock
);

2558 
ˇche
->
ª£rved
 -
fs_öfo
->
nodesize
;

2559 
ˇche
->
•a˚_öfo
->
byãs_ª£rved
 -
fs_öfo
->
nodesize
;

2560 
	`•ö_u∆ock
(&
ˇche
->
lock
);

2561 
	`•ö_u∆ock
(&
ˇche
->
•a˚_öfo
->
lock
);

2563 
	`båfs_put_block_group
(
ˇche
);

2564 
	}
}

2566 
	$˛ón_log_buf„r
(
båfs_å™s_h™dÀ
 *
å™s
,

2567 
exã¡_buf„r
 *
eb
)

2569 
ªt
;

2571 
	`båfs_åì_lock
(
eb
);

2572 
	`båfs_˛ór_buf„r_dúty
(
å™s
, 
eb
);

2573 
	`waô_⁄_exã¡_buf„r_wrôeback
(
eb
);

2574 
	`båfs_åì_u∆ock
(
eb
);

2576 i‡(
å™s
) {

2577 
ªt
 = 
	`båfs_pö_ª£rved_exã¡
(
å™s
, 
eb
->
°¨t
,Éb->
Àn
);

2578 i‡(
ªt
)

2579  
ªt
;

2580 
	`båfs_ªdúty_li°_add
(
å™s
->
å™ß˘i⁄
, 
eb
);

2582 
	`u«ccou¡_log_buf„r
(
eb
->
fs_öfo
,Éb->
°¨t
);

2586 
	}
}

2588 
noölöe
 
	$wÆk_down_log_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

2589 
båfs_roŸ
 *
roŸ
,

2590 
båfs_∑th
 *
∑th
, *
Àvñ
,

2591 
wÆk_c⁄åﬁ
 *
wc
)

2593 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

2594 
u64
 
byãƒ
;

2595 
u64
 
±r_gí
;

2596 
exã¡_buf„r
 *
√xt
;

2597 
exã¡_buf„r
 *
cur
;

2598 
ªt
 = 0;

2600 *
Àvñ
 > 0) {

2601 
båfs_åì_∑ª¡_check
 
check
 = { 0 };

2603 
cur
 = 
∑th
->
nodes
[*
Àvñ
];

2605 
	`WARN_ON
(
	`båfs_hódî_Àvñ
(
cur
Ë!*
Àvñ
);

2607 i‡(
∑th
->
¶Ÿs
[*
Àvñ
] >=

2608 
	`båfs_hódî_ƒôems
(
cur
))

2611 
byãƒ
 = 
	`båfs_node_block±r
(
cur
, 
∑th
->
¶Ÿs
[*
Àvñ
]);

2612 
±r_gí
 = 
	`båfs_node_±r_gíî©i⁄
(
cur
, 
∑th
->
¶Ÿs
[*
Àvñ
]);

2613 
check
.
å™sid
 = 
±r_gí
;

2614 
check
.
Àvñ
 = *level - 1;

2615 
check
.
has_fú°_key
 = 
åue
;

2616 
	`båfs_node_key_to_˝u
(
cur
, &
check
.
fú°_key
, 
∑th
->
¶Ÿs
[*
Àvñ
]);

2618 
√xt
 = 
	`båfs_föd_¸óã_åì_block
(
fs_öfo
, 
byãƒ
,

2619 
	`båfs_hódî_ow√r
(
cur
),

2620 *
Àvñ
 - 1);

2621 i‡(
	`IS_ERR
(
√xt
))

2622  
	`PTR_ERR
(
√xt
);

2624 i‡(*
Àvñ
 == 1) {

2625 
ªt
 = 
wc
->
	`¥o˚ss_func
(
roŸ
, 
√xt
, wc, 
±r_gí
,

2626 *
Àvñ
 - 1);

2627 i‡(
ªt
) {

2628 
	`‰ì_exã¡_buf„r
(
√xt
);

2629  
ªt
;

2632 
∑th
->
¶Ÿs
[*
Àvñ
]++;

2633 i‡(
wc
->
‰ì
) {

2634 
ªt
 = 
	`båfs_ªad_exã¡_buf„r
(
√xt
, &
check
);

2635 i‡(
ªt
) {

2636 
	`‰ì_exã¡_buf„r
(
√xt
);

2637  
ªt
;

2640 
ªt
 = 
	`˛ón_log_buf„r
(
å™s
, 
√xt
);

2641 i‡(
ªt
) {

2642 
	`‰ì_exã¡_buf„r
(
√xt
);

2643  
ªt
;

2646 
	`‰ì_exã¡_buf„r
(
√xt
);

2649 
ªt
 = 
	`båfs_ªad_exã¡_buf„r
(
√xt
, &
check
);

2650 i‡(
ªt
) {

2651 
	`‰ì_exã¡_buf„r
(
√xt
);

2652  
ªt
;

2655 i‡(
∑th
->
nodes
[*
Àvñ
-1])

2656 
	`‰ì_exã¡_buf„r
(
∑th
->
nodes
[*
Àvñ
-1]);

2657 
∑th
->
nodes
[*
Àvñ
-1] = 
√xt
;

2658 *
Àvñ
 = 
	`båfs_hódî_Àvñ
(
√xt
);

2659 
∑th
->
¶Ÿs
[*
Àvñ
] = 0;

2660 
	`c⁄d_ªsched
();

2662 
∑th
->
¶Ÿs
[*
Àvñ
] = 
	`båfs_hódî_ƒôems
’©h->
nodes
[*level]);

2664 
	`c⁄d_ªsched
();

2666 
	}
}

2668 
noölöe
 
	$wÆk_up_log_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

2669 
båfs_roŸ
 *
roŸ
,

2670 
båfs_∑th
 *
∑th
, *
Àvñ
,

2671 
wÆk_c⁄åﬁ
 *
wc
)

2673 
i
;

2674 
¶Ÿ
;

2675 
ªt
;

2677 
i
 = *
Àvñ
; i < 
BTRFS_MAX_LEVEL
 - 1 && 
∑th
->
nodes
[i]; i++) {

2678 
¶Ÿ
 = 
∑th
->
¶Ÿs
[
i
];

2679 i‡(
¶Ÿ
 + 1 < 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[
i
])) {

2680 
∑th
->
¶Ÿs
[
i
]++;

2681 *
Àvñ
 = 
i
;

2682 
	`WARN_ON
(*
Àvñ
 == 0);

2685 
ªt
 = 
wc
->
	`¥o˚ss_func
(
roŸ
, 
∑th
->
nodes
[*
Àvñ
], wc,

2686 
	`båfs_hódî_gíî©i⁄
(
∑th
->
nodes
[*
Àvñ
]),

2687 *
Àvñ
);

2688 i‡(
ªt
)

2689  
ªt
;

2691 i‡(
wc
->
‰ì
) {

2692 
ªt
 = 
	`˛ón_log_buf„r
(
å™s
, 
∑th
->
nodes
[*
Àvñ
]);

2693 i‡(
ªt
)

2694  
ªt
;

2696 
	`‰ì_exã¡_buf„r
(
∑th
->
nodes
[*
Àvñ
]);

2697 
∑th
->
nodes
[*
Àvñ
] = 
NULL
;

2698 *
Àvñ
 = 
i
 + 1;

2702 
	}
}

2709 
	$wÆk_log_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

2710 
båfs_roŸ
 *
log
, 
wÆk_c⁄åﬁ
 *
wc
)

2712 
ªt
 = 0;

2713 
wªt
;

2714 
Àvñ
;

2715 
båfs_∑th
 *
∑th
;

2716 
‹ig_Àvñ
;

2718 
∑th
 = 
	`båfs_Æloc_∑th
();

2719 i‡(!
∑th
)

2720  -
ENOMEM
;

2722 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
log
->
node
);

2723 
‹ig_Àvñ
 = 
Àvñ
;

2724 
∑th
->
nodes
[
Àvñ
] = 
log
->
node
;

2725 
	`©omic_öc
(&
log
->
node
->
ªfs
);

2726 
∑th
->
¶Ÿs
[
Àvñ
] = 0;

2729 
wªt
 = 
	`wÆk_down_log_åì
(
å™s
, 
log
, 
∑th
, &
Àvñ
, 
wc
);

2730 i‡(
wªt
 > 0)

2732 i‡(
wªt
 < 0) {

2733 
ªt
 = 
wªt
;

2734 
out
;

2737 
wªt
 = 
	`wÆk_up_log_åì
(
å™s
, 
log
, 
∑th
, &
Àvñ
, 
wc
);

2738 i‡(
wªt
 > 0)

2740 i‡(
wªt
 < 0) {

2741 
ªt
 = 
wªt
;

2742 
out
;

2747 i‡(
∑th
->
nodes
[
‹ig_Àvñ
]) {

2748 
ªt
 = 
wc
->
	`¥o˚ss_func
(
log
, 
∑th
->
nodes
[
‹ig_Àvñ
], wc,

2749 
	`båfs_hódî_gíî©i⁄
(
∑th
->
nodes
[
‹ig_Àvñ
]),

2750 
‹ig_Àvñ
);

2751 i‡(
ªt
)

2752 
out
;

2753 i‡(
wc
->
‰ì
)

2754 
ªt
 = 
	`˛ón_log_buf„r
(
å™s
, 
∑th
->
nodes
[
‹ig_Àvñ
]);

2757 
out
:

2758 
	`båfs_‰ì_∑th
(
∑th
);

2759  
ªt
;

2760 
	}
}

2766 
	$upd©e_log_roŸ
(
båfs_å™s_h™dÀ
 *
å™s
,

2767 
båfs_roŸ
 *
log
,

2768 
båfs_roŸ_ôem
 *
roŸ_ôem
)

2770 
båfs_fs_öfo
 *
fs_öfo
 = 
log
->fs_info;

2771 
ªt
;

2773 i‡(
log
->
log_å™sid
 == 1) {

2775 
ªt
 = 
	`båfs_ö£π_roŸ
(
å™s
, 
fs_öfo
->
log_roŸ_åì
,

2776 &
log
->
roŸ_key
, 
roŸ_ôem
);

2778 
ªt
 = 
	`båfs_upd©e_roŸ
(
å™s
, 
fs_öfo
->
log_roŸ_åì
,

2779 &
log
->
roŸ_key
, 
roŸ_ôem
);

2781  
ªt
;

2782 
	}
}

2784 
	$waô_log_commô
(
båfs_roŸ
 *
roŸ
, 
å™sid
)

2786 
	`DEFINE_WAIT
(
waô
);

2787 
ödex
 = 
å™sid
 % 2;

2795 
	`¥ï¨e_to_waô
(&
roŸ
->
log_commô_waô
[
ödex
],

2796 &
waô
, 
TASK_UNINTERRUPTIBLE
);

2798 i‡(!(
roŸ
->
log_å™sid_commôãd
 < 
å™sid
 &&

2799 
	`©omic_ªad
(&
roŸ
->
log_commô
[
ödex
])))

2802 
	`muãx_u∆ock
(&
roŸ
->
log_muãx
);

2803 
	`scheduÀ
();

2804 
	`muãx_lock
(&
roŸ
->
log_muãx
);

2806 
	`föish_waô
(&
roŸ
->
log_commô_waô
[
ödex
], &
waô
);

2807 
	}
}

2809 
	$waô_f‹_wrôî
(
båfs_roŸ
 *
roŸ
)

2811 
	`DEFINE_WAIT
(
waô
);

2814 
	`¥ï¨e_to_waô
(&
roŸ
->
log_wrôî_waô
, &
waô
,

2815 
TASK_UNINTERRUPTIBLE
);

2816 i‡(!
	`©omic_ªad
(&
roŸ
->
log_wrôîs
))

2819 
	`muãx_u∆ock
(&
roŸ
->
log_muãx
);

2820 
	`scheduÀ
();

2821 
	`muãx_lock
(&
roŸ
->
log_muãx
);

2823 
	`föish_waô
(&
roŸ
->
log_wrôî_waô
, &
waô
);

2824 
	}
}

2826 
ölöe
 
	$båfs_ªmove_log_˘x
(
båfs_roŸ
 *
roŸ
,

2827 
båfs_log_˘x
 *
˘x
)

2829 
	`muãx_lock
(&
roŸ
->
log_muãx
);

2830 
	`li°_dñ_öô
(&
˘x
->
li°
);

2831 
	`muãx_u∆ock
(&
roŸ
->
log_muãx
);

2832 
	}
}

2838 
ölöe
 
	$båfs_ªmove_Æl_log_˘xs
(
båfs_roŸ
 *
roŸ
,

2839 
ödex
, 
îr‹
)

2841 
båfs_log_˘x
 *
˘x
;

2842 
båfs_log_˘x
 *
ß„
;

2844 
	`li°_f‹_óch_íåy_ß„
(
˘x
, 
ß„
, &
roŸ
->
log_˘xs
[
ödex
], 
li°
) {

2845 
	`li°_dñ_öô
(&
˘x
->
li°
);

2846 
˘x
->
log_ªt
 = 
îr‹
;

2848 
	}
}

2862 
	$båfs_sync_log
(
båfs_å™s_h™dÀ
 *
å™s
,

2863 
båfs_roŸ
 *
roŸ
, 
båfs_log_˘x
 *
˘x
)

2865 
ödex1
;

2866 
ödex2
;

2867 
m¨k
;

2868 
ªt
;

2869 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

2870 
båfs_roŸ
 *
log
 = 
roŸ
->
log_roŸ
;

2871 
båfs_roŸ
 *
log_roŸ_åì
 = 
fs_öfo
->log_root_tree;

2872 
båfs_roŸ_ôem
 
√w_roŸ_ôem
;

2873 
log_å™sid
 = 0;

2874 
båfs_log_˘x
 
roŸ_log_˘x
;

2875 
blk_∂ug
 
∂ug
;

2876 
u64
 
log_roŸ_°¨t
;

2877 
u64
 
log_roŸ_Àvñ
;

2879 
	`muãx_lock
(&
roŸ
->
log_muãx
);

2880 
log_å™sid
 = 
˘x
->log_transid;

2881 i‡(
roŸ
->
log_å™sid_commôãd
 >
log_å™sid
) {

2882 
	`muãx_u∆ock
(&
roŸ
->
log_muãx
);

2883  
˘x
->
log_ªt
;

2886 
ödex1
 = 
log_å™sid
 % 2;

2887 i‡(
	`©omic_ªad
(&
roŸ
->
log_commô
[
ödex1
])) {

2888 
	`waô_log_commô
(
roŸ
, 
log_å™sid
);

2889 
	`muãx_u∆ock
(&
roŸ
->
log_muãx
);

2890  
˘x
->
log_ªt
;

2892 
	`ASSERT
(
log_å™sid
 =
roŸ
->log_transid);

2893 
	`©omic_£t
(&
roŸ
->
log_commô
[
ödex1
], 1);

2896 i‡(
	`©omic_ªad
(&
roŸ
->
log_commô
[(
ödex1
 + 1) % 2]))

2897 
	`waô_log_commô
(
roŸ
, 
log_å™sid
 - 1);

2900 
b©ch
 = 
	`©omic_ªad
(&
roŸ
->
log_b©ch
);

2902 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
SSD
) &&

2903 
	`ã°_bô
(
BTRFS_ROOT_MULTI_LOG_TASKS
, &
roŸ
->
°©e
)) {

2904 
	`muãx_u∆ock
(&
roŸ
->
log_muãx
);

2905 
	`scheduÀ_timeout_unöãºu±ibÀ
(1);

2906 
	`muãx_lock
(&
roŸ
->
log_muãx
);

2908 
	`waô_f‹_wrôî
(
roŸ
);

2909 i‡(
b©ch
 =
	`©omic_ªad
(&
roŸ
->
log_b©ch
))

2914 i‡(
	`båfs_√ed_log_fuŒ_commô
(
å™s
)) {

2915 
ªt
 = 
BTRFS_LOG_FORCE_COMMIT
;

2916 
	`muãx_u∆ock
(&
roŸ
->
log_muãx
);

2917 
out
;

2920 i‡(
log_å™sid
 % 2 == 0)

2921 
m¨k
 = 
EXTENT_DIRTY
;

2923 
m¨k
 = 
EXTENT_NEW
;

2928 
	`blk_°¨t_∂ug
(&
∂ug
);

2929 
ªt
 = 
	`båfs_wrôe_m¨ked_exã¡s
(
fs_öfo
, &
log
->
dúty_log_∑ges
, 
m¨k
);

2939 i‡(
ªt
 =-
EAGAIN
 && 
	`båfs_is_z⁄ed
(
fs_öfo
))

2940 
ªt
 = 0;

2941 i‡(
ªt
) {

2942 
	`blk_föish_∂ug
(&
∂ug
);

2943 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

2944 
	`muãx_u∆ock
(&
roŸ
->
log_muãx
);

2945 
out
;

2961 
	`båfs_£t_roŸ_node
(&
log
->
roŸ_ôem
,Üog->
node
);

2962 
	`mem˝y
(&
√w_roŸ_ôem
, &
log
->
roŸ_ôem
, (new_root_item));

2964 
roŸ
->
log_å™sid
++;

2965 
log
->
log_å™sid
 = 
roŸ
->log_transid;

2966 
roŸ
->
log_°¨t_pid
 = 0;

2972 
	`muãx_u∆ock
(&
roŸ
->
log_muãx
);

2974 i‡(
	`båfs_is_z⁄ed
(
fs_öfo
)) {

2975 
	`muãx_lock
(&
fs_öfo
->
åì_roŸ
->
log_muãx
);

2976 i‡(!
log_roŸ_åì
->
node
) {

2977 
ªt
 = 
	`båfs_Æloc_log_åì_node
(
å™s
, 
log_roŸ_åì
);

2978 i‡(
ªt
) {

2979 
	`muãx_u∆ock
(&
fs_öfo
->
åì_roŸ
->
log_muãx
);

2980 
	`blk_föish_∂ug
(&
∂ug
);

2981 
out
;

2984 
	`muãx_u∆ock
(&
fs_öfo
->
åì_roŸ
->
log_muãx
);

2987 
	`båfs_öô_log_˘x
(&
roŸ_log_˘x
, 
NULL
);

2989 
	`muãx_lock
(&
log_roŸ_åì
->
log_muãx
);

2991 
ödex2
 = 
log_roŸ_åì
->
log_å™sid
 % 2;

2992 
	`li°_add_èû
(&
roŸ_log_˘x
.
li°
, &
log_roŸ_åì
->
log_˘xs
[
ödex2
]);

2993 
roŸ_log_˘x
.
log_å™sid
 = 
log_roŸ_åì
->log_transid;

3000 
ªt
 = 
	`upd©e_log_roŸ
(
å™s
, 
log
, &
√w_roŸ_ôem
);

3001 i‡(
ªt
) {

3002 i‡(!
	`li°_em±y
(&
roŸ_log_˘x
.
li°
))

3003 
	`li°_dñ_öô
(&
roŸ_log_˘x
.
li°
);

3005 
	`blk_föish_∂ug
(&
∂ug
);

3006 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

3007 i‡(
ªt
 !-
ENOSPC
)

3008 
	`båfs_îr
(
fs_öfo
,

3010 
roŸ
->
roŸ_key
.
obje˘id
, 
ªt
);

3011 
	`båfs_waô_åì_log_exã¡s
(
log
, 
m¨k
);

3012 
	`muãx_u∆ock
(&
log_roŸ_åì
->
log_muãx
);

3013 
out
;

3016 i‡(
log_roŸ_åì
->
log_å™sid_commôãd
 >
roŸ_log_˘x
.
log_å™sid
) {

3017 
	`blk_föish_∂ug
(&
∂ug
);

3018 
	`li°_dñ_öô
(&
roŸ_log_˘x
.
li°
);

3019 
	`muãx_u∆ock
(&
log_roŸ_åì
->
log_muãx
);

3020 
ªt
 = 
roŸ_log_˘x
.
log_ªt
;

3021 
out
;

3024 
ödex2
 = 
roŸ_log_˘x
.
log_å™sid
 % 2;

3025 i‡(
	`©omic_ªad
(&
log_roŸ_åì
->
log_commô
[
ödex2
])) {

3026 
	`blk_föish_∂ug
(&
∂ug
);

3027 
ªt
 = 
	`båfs_waô_åì_log_exã¡s
(
log
, 
m¨k
);

3028 
	`waô_log_commô
(
log_roŸ_åì
,

3029 
roŸ_log_˘x
.
log_å™sid
);

3030 
	`muãx_u∆ock
(&
log_roŸ_åì
->
log_muãx
);

3031 i‡(!
ªt
)

3032 
ªt
 = 
roŸ_log_˘x
.
log_ªt
;

3033 
out
;

3035 
	`ASSERT
(
roŸ_log_˘x
.
log_å™sid
 =
log_roŸ_åì
->log_transid);

3036 
	`©omic_£t
(&
log_roŸ_åì
->
log_commô
[
ödex2
], 1);

3038 i‡(
	`©omic_ªad
(&
log_roŸ_åì
->
log_commô
[(
ödex2
 + 1) % 2])) {

3039 
	`waô_log_commô
(
log_roŸ_åì
,

3040 
roŸ_log_˘x
.
log_å™sid
 - 1);

3047 i‡(
	`båfs_√ed_log_fuŒ_commô
(
å™s
)) {

3048 
	`blk_föish_∂ug
(&
∂ug
);

3049 
	`båfs_waô_åì_log_exã¡s
(
log
, 
m¨k
);

3050 
	`muãx_u∆ock
(&
log_roŸ_åì
->
log_muãx
);

3051 
ªt
 = 
BTRFS_LOG_FORCE_COMMIT
;

3052 
out_wake_log_roŸ
;

3055 
ªt
 = 
	`båfs_wrôe_m¨ked_exã¡s
(
fs_öfo
,

3056 &
log_roŸ_åì
->
dúty_log_∑ges
,

3057 
EXTENT_DIRTY
 | 
EXTENT_NEW
);

3058 
	`blk_föish_∂ug
(&
∂ug
);

3064 i‡(
ªt
 =-
EAGAIN
 && 
	`båfs_is_z⁄ed
(
fs_öfo
)) {

3065 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

3066 
	`båfs_waô_åì_log_exã¡s
(
log
, 
m¨k
);

3067 
	`muãx_u∆ock
(&
log_roŸ_åì
->
log_muãx
);

3068 
out_wake_log_roŸ
;

3069 } i‡(
ªt
) {

3070 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

3071 
	`muãx_u∆ock
(&
log_roŸ_åì
->
log_muãx
);

3072 
out_wake_log_roŸ
;

3074 
ªt
 = 
	`båfs_waô_åì_log_exã¡s
(
log
, 
m¨k
);

3075 i‡(!
ªt
)

3076 
ªt
 = 
	`båfs_waô_åì_log_exã¡s
(
log_roŸ_åì
,

3077 
EXTENT_NEW
 | 
EXTENT_DIRTY
);

3078 i‡(
ªt
) {

3079 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

3080 
	`muãx_u∆ock
(&
log_roŸ_åì
->
log_muãx
);

3081 
out_wake_log_roŸ
;

3084 
log_roŸ_°¨t
 = 
log_roŸ_åì
->
node
->
°¨t
;

3085 
log_roŸ_Àvñ
 = 
	`båfs_hódî_Àvñ
(
log_roŸ_åì
->
node
);

3086 
log_roŸ_åì
->
log_å™sid
++;

3087 
	`muãx_u∆ock
(&
log_roŸ_åì
->
log_muãx
);

3104 
	`muãx_lock
(&
fs_öfo
->
åì_log_muãx
);

3113 i‡(
	`BTRFS_FS_ERROR
(
fs_öfo
)) {

3114 
ªt
 = -
EIO
;

3115 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

3116 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3117 
	`muãx_u∆ock
(&
fs_öfo
->
åì_log_muãx
);

3118 
out_wake_log_roŸ
;

3121 
	`båfs_£t_su≥r_log_roŸ
(
fs_öfo
->
su≥r_f‹_commô
, 
log_roŸ_°¨t
);

3122 
	`båfs_£t_su≥r_log_roŸ_Àvñ
(
fs_öfo
->
su≥r_f‹_commô
, 
log_roŸ_Àvñ
);

3123 
ªt
 = 
	`wrôe_Æl_su≥rs
(
fs_öfo
, 1);

3124 
	`muãx_u∆ock
(&
fs_öfo
->
åì_log_muãx
);

3125 i‡(
ªt
) {

3126 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

3127 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3128 
out_wake_log_roŸ
;

3139 
	`ASSERT
(
roŸ
->
œ°_log_commô
 <
log_å™sid
);

3140 
roŸ
->
œ°_log_commô
 = 
log_å™sid
;

3142 
out_wake_log_roŸ
:

3143 
	`muãx_lock
(&
log_roŸ_åì
->
log_muãx
);

3144 
	`båfs_ªmove_Æl_log_˘xs
(
log_roŸ_åì
, 
ödex2
, 
ªt
);

3146 
log_roŸ_åì
->
log_å™sid_commôãd
++;

3147 
	`©omic_£t
(&
log_roŸ_åì
->
log_commô
[
ödex2
], 0);

3148 
	`muãx_u∆ock
(&
log_roŸ_åì
->
log_muãx
);

3155 
	`c⁄d_wake_up
(&
log_roŸ_åì
->
log_commô_waô
[
ödex2
]);

3156 
out
:

3157 
	`muãx_lock
(&
roŸ
->
log_muãx
);

3158 
	`båfs_ªmove_Æl_log_˘xs
(
roŸ
, 
ödex1
, 
ªt
);

3159 
roŸ
->
log_å™sid_commôãd
++;

3160 
	`©omic_£t
(&
roŸ
->
log_commô
[
ödex1
], 0);

3161 
	`muãx_u∆ock
(&
roŸ
->
log_muãx
);

3168 
	`c⁄d_wake_up
(&
roŸ
->
log_commô_waô
[
ödex1
]);

3169  
ªt
;

3170 
	}
}

3172 
	$‰ì_log_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

3173 
båfs_roŸ
 *
log
)

3175 
ªt
;

3176 
wÆk_c⁄åﬁ
 
wc
 = {

3177 .
‰ì
 = 1,

3178 .
¥o˚ss_func
 = 
¥o˚ss_⁄e_buf„r


3181 i‡(
log
->
node
) {

3182 
ªt
 = 
	`wÆk_log_åì
(
å™s
, 
log
, &
wc
);

3183 i‡(
ªt
) {

3190 
	`£t_bô
(
BTRFS_FS_STATE_LOG_CLEANUP_ERROR
,

3191 &
log
->
fs_öfo
->
fs_°©e
);

3201 
	`båfs_wrôe_m¨ked_exã¡s
(
log
->
fs_öfo
,

3202 &
log
->
dúty_log_∑ges
,

3203 
EXTENT_DIRTY
 | 
EXTENT_NEW
);

3204 
	`båfs_waô_åì_log_exã¡s
(
log
,

3205 
EXTENT_DIRTY
 | 
EXTENT_NEW
);

3207 i‡(
å™s
)

3208 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3210 
	`båfs_h™dÀ_fs_îr‹
(
log
->
fs_öfo
, 
ªt
, 
NULL
);

3214 
	`˛ór_exã¡_bôs
(&
log
->
dúty_log_∑ges
, 0, (
u64
)-1,

3215 
EXTENT_DIRTY
 | 
EXTENT_NEW
 | 
EXTENT_NEED_WAIT
);

3216 
	`exã¡_io_åì_ªÀa£
(&
log
->
log_csum_ønge
);

3218 
	`båfs_put_roŸ
(
log
);

3219 
	}
}

3225 
	$båfs_‰ì_log
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
)

3227 i‡(
roŸ
->
log_roŸ
) {

3228 
	`‰ì_log_åì
(
å™s
, 
roŸ
->
log_roŸ
);

3229 
roŸ
->
log_roŸ
 = 
NULL
;

3230 
	`˛ór_bô
(
BTRFS_ROOT_HAS_LOG_TREE
, &
roŸ
->
°©e
);

3233 
	}
}

3235 
	$båfs_‰ì_log_roŸ_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

3236 
båfs_fs_öfo
 *
fs_öfo
)

3238 i‡(
fs_öfo
->
log_roŸ_åì
) {

3239 
	`‰ì_log_åì
(
å™s
, 
fs_öfo
->
log_roŸ_åì
);

3240 
fs_öfo
->
log_roŸ_åì
 = 
NULL
;

3241 
	`˛ór_bô
(
BTRFS_ROOT_HAS_LOG_TREE
, &
fs_öfo
->
åì_roŸ
->
°©e
);

3244 
	}
}

3255 
	$öode_logged
(c⁄° 
båfs_å™s_h™dÀ
 *
å™s
,

3256 
båfs_öode
 *
öode
,

3257 
båfs_∑th
 *
∑th_ö
)

3259 
båfs_∑th
 *
∑th
 = 
∑th_ö
;

3260 
båfs_key
 
key
;

3261 
ªt
;

3263 i‡(
öode
->
logged_å™s
 =
å™s
->
å™sid
)

3270 i‡(
öode
->
logged_å™s
 > 0)

3280 i‡(!
	`ã°_bô
(
BTRFS_ROOT_HAS_LOG_TREE
, &
öode
->
roŸ
->
°©e
)) {

3281 
öode
->
logged_å™s
 = 
å™s
->
å™sid
 - 1;

3309 
key
.
obje˘id
 = 
	`båfs_öo
(
öode
);

3310 
key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

3311 
key
.
off£t
 = 0;

3313 i‡(!
∑th
) {

3314 
∑th
 = 
	`båfs_Æloc_∑th
();

3315 i‡(!
∑th
)

3316  -
ENOMEM
;

3319 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
öode
->
roŸ
->
log_roŸ
, &
key
, 
∑th
, 0, 0);

3321 i‡(
∑th_ö
)

3322 
	`båfs_ªÀa£_∑th
(
∑th
);

3324 
	`båfs_‰ì_∑th
(
∑th
);

3330 i‡(
ªt
 < 0) {

3331  
ªt
;

3332 } i‡(
ªt
 > 0) {

3337 
öode
->
logged_å™s
 = 
å™s
->
å™sid
 - 1;

3346 
öode
->
logged_å™s
 = 
å™s
->
å™sid
;

3358 i‡(
	`S_ISDIR
(
öode
->
vfs_öode
.
i_mode
))

3359 
öode
->
œ°_dú_ödex_off£t
 = (
u64
)-1;

3362 
	}
}

3371 
	$dñ_logged_díåy
(
båfs_å™s_h™dÀ
 *
å™s
,

3372 
båfs_roŸ
 *
log
,

3373 
båfs_∑th
 *
∑th
,

3374 
u64
 
dú_öo
,

3375 c⁄° 
fs¸y±_°r
 *
«me
,

3376 
u64
 
ödex
)

3378 
båfs_dú_ôem
 *
di
;

3384 
di
 = 
	`båfs_lookup_dú_ödex_ôem
(
å™s
, 
log
, 
∑th
, 
dú_öo
,

3385 
ödex
, 
«me
, -1);

3386 i‡(
	`IS_ERR
(
di
))

3387  
	`PTR_ERR
(
di
);

3388 i‡(!
di
)

3396  
	`båfs_dñëe_⁄e_dú_«me
(
å™s
, 
log
, 
∑th
, 
di
);

3397 
	}
}

3420 
	$båfs_dñ_dú_íåõs_ö_log
(
båfs_å™s_h™dÀ
 *
å™s
,

3421 
båfs_roŸ
 *
roŸ
,

3422 c⁄° 
fs¸y±_°r
 *
«me
,

3423 
båfs_öode
 *
dú
, 
u64
 
ödex
)

3425 
båfs_∑th
 *
∑th
;

3426 
ªt
;

3428 
ªt
 = 
	`öode_logged
(
å™s
, 
dú
, 
NULL
);

3429 i‡(
ªt
 == 0)

3431 i‡(
ªt
 < 0) {

3432 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

3436 
ªt
 = 
	`joö_ru¬ög_log_å™s
(
roŸ
);

3437 i‡(
ªt
)

3440 
	`muãx_lock
(&
dú
->
log_muãx
);

3442 
∑th
 = 
	`båfs_Æloc_∑th
();

3443 i‡(!
∑th
) {

3444 
ªt
 = -
ENOMEM
;

3445 
out_u∆ock
;

3448 
ªt
 = 
	`dñ_logged_díåy
(
å™s
, 
roŸ
->
log_roŸ
, 
∑th
, 
	`båfs_öo
(
dú
),

3449 
«me
, 
ödex
);

3450 
	`båfs_‰ì_∑th
(
∑th
);

3451 
out_u∆ock
:

3452 
	`muãx_u∆ock
(&
dú
->
log_muãx
);

3453 i‡(
ªt
 < 0)

3454 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

3455 
	`båfs_íd_log_å™s
(
roŸ
);

3456 
	}
}

3459 
	$båfs_dñ_öode_ªf_ö_log
(
båfs_å™s_h™dÀ
 *
å™s
,

3460 
båfs_roŸ
 *
roŸ
,

3461 c⁄° 
fs¸y±_°r
 *
«me
,

3462 
båfs_öode
 *
öode
, 
u64
 
dúid
)

3464 
båfs_roŸ
 *
log
;

3465 
u64
 
ödex
;

3466 
ªt
;

3468 
ªt
 = 
	`öode_logged
(
å™s
, 
öode
, 
NULL
);

3469 i‡(
ªt
 == 0)

3471 i‡(
ªt
 < 0) {

3472 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

3476 
ªt
 = 
	`joö_ru¬ög_log_å™s
(
roŸ
);

3477 i‡(
ªt
)

3479 
log
 = 
roŸ
->
log_roŸ
;

3480 
	`muãx_lock
(&
öode
->
log_muãx
);

3482 
ªt
 = 
	`båfs_dñ_öode_ªf
(
å™s
, 
log
, 
«me
, 
	`båfs_öo
(
öode
),

3483 
dúid
, &
ödex
);

3484 
	`muãx_u∆ock
(&
öode
->
log_muãx
);

3485 i‡(
ªt
 < 0 &&Ñë !-
ENOENT
)

3486 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

3487 
	`båfs_íd_log_å™s
(
roŸ
);

3488 
	}
}

3495 
noölöe
 
	$ö£π_dú_log_key
(
båfs_å™s_h™dÀ
 *
å™s
,

3496 
båfs_roŸ
 *
log
,

3497 
båfs_∑th
 *
∑th
,

3498 
u64
 
dúid
,

3499 
u64
 
fú°_off£t
, u64 
œ°_off£t
)

3501 
ªt
;

3502 
båfs_key
 
key
;

3503 
båfs_dú_log_ôem
 *
ôem
;

3505 
key
.
obje˘id
 = 
dúid
;

3506 
key
.
off£t
 = 
fú°_off£t
;

3507 
key
.
ty≥
 = 
BTRFS_DIR_LOG_INDEX_KEY
;

3508 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
log
, 
∑th
, &
key
, (*
ôem
));

3516 i‡(
ªt
 &&Ñë !-
EEXIST
)

3517  
ªt
;

3519 
ôem
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

3520 
båfs_dú_log_ôem
);

3521 i‡(
ªt
 =-
EEXIST
) {

3522 c⁄° 
u64
 
cuº_íd
 = 
	`båfs_dú_log_íd
(
∑th
->
nodes
[0], 
ôem
);

3530 
œ°_off£t
 = 
	`max
÷a°_off£t, 
cuº_íd
);

3532 
	`båfs_£t_dú_log_íd
(
∑th
->
nodes
[0], 
ôem
, 
œ°_off£t
);

3533 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
∑th
->
nodes
[0]);

3534 
	`båfs_ªÀa£_∑th
(
∑th
);

3536 
	}
}

3538 
	$Êush_dú_ôems_b©ch
(
båfs_å™s_h™dÀ
 *
å™s
,

3539 
båfs_öode
 *
öode
,

3540 
exã¡_buf„r
 *
§c
,

3541 
båfs_∑th
 *
d°_∑th
,

3542 
°¨t_¶Ÿ
,

3543 
cou¡
)

3545 
båfs_roŸ
 *
log
 = 
öode
->
roŸ
->
log_roŸ
;

3546 *
ös_d©a
 = 
NULL
;

3547 
båfs_ôem_b©ch
 
b©ch
;

3548 
exã¡_buf„r
 *
d°
;

3549 
§c_off£t
;

3550 
d°_off£t
;

3551 
u64
 
œ°_ödex
;

3552 
båfs_key
 
key
;

3553 
u32
 
ôem_size
;

3554 
ªt
;

3555 
i
;

3557 
	`ASSERT
(
cou¡
 > 0);

3558 
b©ch
.
ƒ
 = 
cou¡
;

3560 i‡(
cou¡
 == 1) {

3561 
	`båfs_ôem_key_to_˝u
(
§c
, &
key
, 
°¨t_¶Ÿ
);

3562 
ôem_size
 = 
	`båfs_ôem_size
(
§c
, 
°¨t_¶Ÿ
);

3563 
b©ch
.
keys
 = &
key
;

3564 
b©ch
.
d©a_sizes
 = &
ôem_size
;

3565 
b©ch
.
tŸÆ_d©a_size
 = 
ôem_size
;

3567 
båfs_key
 *
ös_keys
;

3568 
u32
 *
ös_sizes
;

3570 
ös_d©a
 = 
	`kmÆloc
(
cou¡
 * (
u32
) +

3571 
cou¡
 * (
båfs_key
), 
GFP_NOFS
);

3572 i‡(!
ös_d©a
)

3573  -
ENOMEM
;

3575 
ös_sizes
 = (
u32
 *)
ös_d©a
;

3576 
ös_keys
 = (
båfs_key
 *)(
ös_d©a
 + 
cou¡
 * (
u32
));

3577 
b©ch
.
keys
 = 
ös_keys
;

3578 
b©ch
.
d©a_sizes
 = 
ös_sizes
;

3579 
b©ch
.
tŸÆ_d©a_size
 = 0;

3581 
i
 = 0; i < 
cou¡
; i++) {

3582 c⁄° 
¶Ÿ
 = 
°¨t_¶Ÿ
 + 
i
;

3584 
	`båfs_ôem_key_to_˝u
(
§c
, &
ös_keys
[
i
], 
¶Ÿ
);

3585 
ös_sizes
[
i
] = 
	`båfs_ôem_size
(
§c
, 
¶Ÿ
);

3586 
b©ch
.
tŸÆ_d©a_size
 +
ös_sizes
[
i
];

3590 
ªt
 = 
	`båfs_ö£π_em±y_ôems
(
å™s
, 
log
, 
d°_∑th
, &
b©ch
);

3591 i‡(
ªt
)

3592 
out
;

3594 
d°
 = 
d°_∑th
->
nodes
[0];

3605 
d°_off£t
 = 
	`båfs_ôem_±r_off£t
(
d°
, 
d°_∑th
->
¶Ÿs
[0] + 
cou¡
 - 1);

3606 
§c_off£t
 = 
	`båfs_ôem_±r_off£t
(
§c
, 
°¨t_¶Ÿ
 + 
cou¡
 - 1);

3607 
	`c›y_exã¡_buf„r
(
d°
, 
§c
, 
d°_off£t
, 
§c_off£t
, 
b©ch
.
tŸÆ_d©a_size
);

3608 
	`båfs_ªÀa£_∑th
(
d°_∑th
);

3610 
œ°_ödex
 = 
b©ch
.
keys
[
cou¡
 - 1].
off£t
;

3611 
	`ASSERT
(
œ°_ödex
 > 
öode
->
œ°_dú_ödex_off£t
);

3617 i‡(
	`WARN_ON
(
œ°_ödex
 <
öode
->
œ°_dú_ödex_off£t
))

3618 
ªt
 = 
BTRFS_LOG_FORCE_COMMIT
;

3620 
öode
->
œ°_dú_ödex_off£t
 = 
œ°_ödex
;

3622 i‡(
	`båfs_gë_fú°_dú_ödex_to_log
(
öode
) == 0)

3623 
	`båfs_£t_fú°_dú_ödex_to_log
(
öode
, 
b©ch
.
keys
[0].
off£t
);

3624 
out
:

3625 
	`k‰ì
(
ös_d©a
);

3627  
ªt
;

3628 
	}
}

3630 
	$¥o˚ss_dú_ôems_Àaf
(
båfs_å™s_h™dÀ
 *
å™s
,

3631 
båfs_öode
 *
öode
,

3632 
båfs_∑th
 *
∑th
,

3633 
båfs_∑th
 *
d°_∑th
,

3634 
båfs_log_˘x
 *
˘x
,

3635 
u64
 *
œ°_ﬁd_díåy_off£t
)

3637 
båfs_roŸ
 *
log
 = 
öode
->
roŸ
->
log_roŸ
;

3638 
exã¡_buf„r
 *
§c
;

3639 c⁄° 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
∑th
->
nodes
[0]);

3640 c⁄° 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

3641 
boﬁ
 
œ°_found
 = 
Ál£
;

3642 
b©ch_°¨t
 = 0;

3643 
b©ch_size
 = 0;

3644 
i
;

3651 
§c
 = 
	`båfs_˛⁄e_exã¡_buf„r
(
∑th
->
nodes
[0]);

3652 i‡(!
§c
)

3653  -
ENOMEM
;

3655 
i
 = 
∑th
->
¶Ÿs
[0];

3656 
	`båfs_ªÀa£_∑th
(
∑th
);

3657 
∑th
->
nodes
[0] = 
§c
;

3658 
∑th
->
¶Ÿs
[0] = 
i
;

3660 ; 
i
 < 
ƒôems
; i++) {

3661 
båfs_dú_ôem
 *
di
;

3662 
båfs_key
 
key
;

3663 
ªt
;

3665 
	`båfs_ôem_key_to_˝u
(
§c
, &
key
, 
i
);

3667 i‡(
key
.
obje˘id
 !
öo
 || key.
ty≥
 !
BTRFS_DIR_INDEX_KEY
) {

3668 
œ°_found
 = 
åue
;

3672 
di
 = 
	`båfs_ôem_±r
(
§c
, 
i
, 
båfs_dú_ôem
);

3680 i‡(
	`båfs_dú_å™sid
(
§c
, 
di
Ë< 
å™s
->
å™sid
) {

3681 i‡(
key
.
off£t
 > *
œ°_ﬁd_díåy_off£t
 + 1) {

3682 
ªt
 = 
	`ö£π_dú_log_key
(
å™s
, 
log
, 
d°_∑th
,

3683 
öo
, *
œ°_ﬁd_díåy_off£t
 + 1,

3684 
key
.
off£t
 - 1);

3685 i‡(
ªt
 < 0)

3686  
ªt
;

3689 *
œ°_ﬁd_díåy_off£t
 = 
key
.
off£t
;

3694 i‡(
key
.
off£t
 <
öode
->
œ°_dú_ödex_off£t
)

3719 i‡(!
˘x
->
log_√w_díåõs
) {

3720 
båfs_key
 
di_key
;

3722 
	`båfs_dú_ôem_key_to_˝u
(
§c
, 
di
, &
di_key
);

3723 i‡(
di_key
.
ty≥
 !
BTRFS_ROOT_ITEM_KEY
)

3724 
˘x
->
log_√w_díåõs
 = 
åue
;

3727 i‡(
b©ch_size
 == 0)

3728 
b©ch_°¨t
 = 
i
;

3729 
b©ch_size
++;

3732 i‡(
b©ch_size
 > 0) {

3733 
ªt
;

3735 
ªt
 = 
	`Êush_dú_ôems_b©ch
(
å™s
, 
öode
, 
§c
, 
d°_∑th
,

3736 
b©ch_°¨t
, 
b©ch_size
);

3737 i‡(
ªt
 < 0)

3738  
ªt
;

3741  
œ°_found
 ? 1 : 0;

3742 
	}
}

3749 
noölöe
 
	$log_dú_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

3750 
båfs_öode
 *
öode
,

3751 
båfs_∑th
 *
∑th
,

3752 
båfs_∑th
 *
d°_∑th
,

3753 
båfs_log_˘x
 *
˘x
,

3754 
u64
 
mö_off£t
, u64 *
œ°_off£t_ªt
)

3756 
båfs_key
 
mö_key
;

3757 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

3758 
båfs_roŸ
 *
log
 = 
roŸ
->
log_roŸ
;

3759 
ªt
;

3760 
u64
 
œ°_ﬁd_díåy_off£t
 = 
mö_off£t
 - 1;

3761 
u64
 
œ°_off£t
 = (u64)-1;

3762 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

3764 
mö_key
.
obje˘id
 = 
öo
;

3765 
mö_key
.
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

3766 
mö_key
.
off£t
 = 
mö_off£t
;

3768 
ªt
 = 
	`båfs_£¨ch_f‹w¨d
(
roŸ
, &
mö_key
, 
∑th
, 
å™s
->
å™sid
);

3774 i‡(
ªt
 !0 || 
mö_key
.
obje˘id
 !
öo
 ||

3775 
mö_key
.
ty≥
 !
BTRFS_DIR_INDEX_KEY
) {

3776 
mö_key
.
obje˘id
 = 
öo
;

3777 
mö_key
.
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

3778 
mö_key
.
off£t
 = (
u64
)-1;

3779 
	`båfs_ªÀa£_∑th
(
∑th
);

3780 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
mö_key
, 
∑th
, 0, 0);

3781 i‡(
ªt
 < 0) {

3782 
	`båfs_ªÀa£_∑th
(
∑th
);

3783  
ªt
;

3785 
ªt
 = 
	`båfs_¥evious_ôem
(
roŸ
, 
∑th
, 
öo
, 
BTRFS_DIR_INDEX_KEY
);

3792 i‡(
ªt
 == 0) {

3793 
båfs_key
 
tmp
;

3795 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
tmp
,

3796 
∑th
->
¶Ÿs
[0]);

3797 i‡(
tmp
.
ty≥
 =
BTRFS_DIR_INDEX_KEY
)

3798 
œ°_ﬁd_díåy_off£t
 = 
tmp
.
off£t
;

3799 } i‡(
ªt
 > 0) {

3800 
ªt
 = 0;

3803 
d⁄e
;

3807 
ªt
 = 
	`båfs_¥evious_ôem
(
roŸ
, 
∑th
, 
öo
, 
BTRFS_DIR_INDEX_KEY
);

3808 i‡(
ªt
 == 0) {

3809 
båfs_key
 
tmp
;

3811 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
tmp
,Ö©h->
¶Ÿs
[0]);

3820 i‡(
tmp
.
ty≥
 =
BTRFS_DIR_INDEX_KEY
)

3821 
œ°_ﬁd_díåy_off£t
 = 
tmp
.
off£t
;

3822 } i‡(
ªt
 < 0) {

3823 
d⁄e
;

3826 
	`båfs_ªÀa£_∑th
(
∑th
);

3842 
£¨ch
:

3843 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
mö_key
, 
∑th
, 0, 0);

3844 i‡(
ªt
 > 0) {

3845 
ªt
 = 
	`båfs_√xt_ôem
(
roŸ
, 
∑th
);

3846 i‡(
ªt
 > 0) {

3848 
ªt
 = 0;

3849 
d⁄e
;

3852 i‡(
ªt
 < 0)

3853 
d⁄e
;

3860 
ªt
 = 
	`¥o˚ss_dú_ôems_Àaf
(
å™s
, 
öode
, 
∑th
, 
d°_∑th
, 
˘x
,

3861 &
œ°_ﬁd_díåy_off£t
);

3862 i‡(
ªt
 != 0) {

3863 i‡(
ªt
 > 0)

3864 
ªt
 = 0;

3865 
d⁄e
;

3867 
∑th
->
¶Ÿs
[0] = 
	`båfs_hódî_ƒôems
’©h->
nodes
[0]);

3873 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

3874 i‡(
ªt
) {

3875 i‡(
ªt
 == 1) {

3876 
œ°_off£t
 = (
u64
)-1;

3877 
ªt
 = 0;

3879 
d⁄e
;

3881 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
mö_key
,Ö©h->
¶Ÿs
[0]);

3882 i‡(
mö_key
.
obje˘id
 !
öo
 || mö_key.
ty≥
 !
BTRFS_DIR_INDEX_KEY
) {

3883 
œ°_off£t
 = (
u64
)-1;

3884 
d⁄e
;

3886 i‡(
	`båfs_hódî_gíî©i⁄
(
∑th
->
nodes
[0]Ë!
å™s
->
å™sid
) {

3896 
œ°_off£t
 = 
mö_key
.
off£t
 - 1;

3897 
d⁄e
;

3899 i‡(
	`√ed_ªsched
()) {

3900 
	`båfs_ªÀa£_∑th
(
∑th
);

3901 
	`c⁄d_ªsched
();

3902 
£¨ch
;

3905 
d⁄e
:

3906 
	`båfs_ªÀa£_∑th
(
∑th
);

3907 
	`båfs_ªÀa£_∑th
(
d°_∑th
);

3909 i‡(
ªt
 == 0) {

3910 *
œ°_off£t_ªt
 = 
œ°_off£t
;

3919 
	`ASSERT
(
œ°_ﬁd_díåy_off£t
 <
œ°_off£t
);

3920 i‡(
œ°_ﬁd_díåy_off£t
 < 
œ°_off£t
)

3921 
ªt
 = 
	`ö£π_dú_log_key
(
å™s
, 
log
, 
∑th
, 
öo
,

3922 
œ°_ﬁd_díåy_off£t
 + 1,

3923 
œ°_off£t
);

3926  
ªt
;

3927 
	}
}

3937 
	$upd©e_œ°_dú_ödex_off£t
(
båfs_öode
 *
öode
,

3938 
båfs_∑th
 *
∑th
,

3939 c⁄° 
båfs_log_˘x
 *
˘x
)

3941 c⁄° 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

3942 
båfs_key
 
key
;

3943 
ªt
;

3945 
	`lockdï_as£π_hñd
(&
öode
->
log_muãx
);

3947 i‡(
öode
->
œ°_dú_ödex_off£t
 !(
u64
)-1)

3950 i‡(!
˘x
->
logged_bef‹e
) {

3951 
öode
->
œ°_dú_ödex_off£t
 = 
BTRFS_DIR_START_INDEX
 - 1;

3955 
key
.
obje˘id
 = 
öo
;

3956 
key
.
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

3957 
key
.
off£t
 = (
u64
)-1;

3959 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
öode
->
roŸ
->
log_roŸ
, &
key
, 
∑th
, 0, 0);

3964 i‡(
ªt
 <= 0)

3965 
out
;

3967 
ªt
 = 0;

3968 
öode
->
œ°_dú_ödex_off£t
 = 
BTRFS_DIR_START_INDEX
 - 1;

3974 i‡(
∑th
->
¶Ÿs
[0] == 0)

3975 
out
;

3984 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0] - 1);

3985 i‡(
key
.
obje˘id
 =
öo
 && key.
ty≥
 =
BTRFS_DIR_INDEX_KEY
)

3986 
öode
->
œ°_dú_ödex_off£t
 = 
key
.
off£t
;

3988 
out
:

3989 
	`båfs_ªÀa£_∑th
(
∑th
);

3991  
ªt
;

3992 
	}
}

4006 
noölöe
 
	$log_dúe˘‹y_ch™ges
(
båfs_å™s_h™dÀ
 *
å™s
,

4007 
båfs_öode
 *
öode
,

4008 
båfs_∑th
 *
∑th
,

4009 
båfs_∑th
 *
d°_∑th
,

4010 
båfs_log_˘x
 *
˘x
)

4012 
u64
 
mö_key
;

4013 
u64
 
max_key
;

4014 
ªt
;

4016 
ªt
 = 
	`upd©e_œ°_dú_ödex_off£t
(
öode
, 
∑th
, 
˘x
);

4017 i‡(
ªt
)

4018  
ªt
;

4020 
mö_key
 = 
BTRFS_DIR_START_INDEX
;

4021 
max_key
 = 0;

4024 
ªt
 = 
	`log_dú_ôems
(
å™s
, 
öode
, 
∑th
, 
d°_∑th
,

4025 
˘x
, 
mö_key
, &
max_key
);

4026 i‡(
ªt
)

4027  
ªt
;

4028 i‡(
max_key
 =(
u64
)-1)

4030 
mö_key
 = 
max_key
 + 1;

4034 
	}
}

4042 
	$dr›_öode_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

4043 
båfs_roŸ
 *
log
,

4044 
båfs_∑th
 *
∑th
,

4045 
båfs_öode
 *
öode
,

4046 
max_key_ty≥
)

4048 
ªt
;

4049 
båfs_key
 
key
;

4050 
båfs_key
 
found_key
;

4051 
°¨t_¶Ÿ
;

4053 
key
.
obje˘id
 = 
	`båfs_öo
(
öode
);

4054 
key
.
ty≥
 = 
max_key_ty≥
;

4055 
key
.
off£t
 = (
u64
)-1;

4058 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
log
, &
key
, 
∑th
, -1, 1);

4059 i‡(
ªt
 < 0) {

4061 } i‡(
ªt
 > 0) {

4062 i‡(
∑th
->
¶Ÿs
[0] == 0)

4064 
∑th
->
¶Ÿs
[0]--;

4067 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
found_key
,

4068 
∑th
->
¶Ÿs
[0]);

4070 i‡(
found_key
.
obje˘id
 !
key
.objectid)

4073 
found_key
.
off£t
 = 0;

4074 
found_key
.
ty≥
 = 0;

4075 
ªt
 = 
	`båfs_bö_£¨ch
(
∑th
->
nodes
[0], 0, &
found_key
, &
°¨t_¶Ÿ
);

4076 i‡(
ªt
 < 0)

4079 
ªt
 = 
	`båfs_dñ_ôems
(
å™s
, 
log
, 
∑th
, 
°¨t_¶Ÿ
,

4080 
∑th
->
¶Ÿs
[0] - 
°¨t_¶Ÿ
 + 1);

4085 i‡(
ªt
 || 
°¨t_¶Ÿ
 != 0)

4087 
	`båfs_ªÀa£_∑th
(
∑th
);

4089 
	`båfs_ªÀa£_∑th
(
∑th
);

4090 i‡(
ªt
 > 0)

4091 
ªt
 = 0;

4092  
ªt
;

4093 
	}
}

4095 
	$åunˇã_öode_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

4096 
båfs_roŸ
 *
log_roŸ
,

4097 
båfs_öode
 *
öode
,

4098 
u64
 
√w_size
, 
u32
 
mö_ty≥
)

4100 
båfs_åunˇã_c⁄åﬁ
 
c⁄åﬁ
 = {

4101 .
√w_size
 =Çew_size,

4102 .
öo
 = 
	`båfs_öo
(
öode
),

4103 .
mö_ty≥
 = min_type,

4104 .
skù_ªf_upd©es
 = 
åue
,

4107  
	`båfs_åunˇã_öode_ôems
(
å™s
, 
log_roŸ
, &
c⁄åﬁ
);

4108 
	}
}

4110 
	$fûl_öode_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

4111 
exã¡_buf„r
 *
Àaf
,

4112 
båfs_öode_ôem
 *
ôem
,

4113 
öode
 *öode, 
log_öode_⁄ly
,

4114 
u64
 
logged_isize
)

4116 
båfs_m≠_tokí
 
tokí
;

4117 
u64
 
Êags
;

4119 
	`båfs_öô_m≠_tokí
(&
tokí
, 
Àaf
);

4121 i‡(
log_öode_⁄ly
) {

4127 
	`båfs_£t_tokí_öode_gíî©i⁄
(&
tokí
, 
ôem
, 0);

4128 
	`båfs_£t_tokí_öode_size
(&
tokí
, 
ôem
, 
logged_isize
);

4130 
	`båfs_£t_tokí_öode_gíî©i⁄
(&
tokí
, 
ôem
,

4131 
	`BTRFS_I
(
öode
)->
gíî©i⁄
);

4132 
	`båfs_£t_tokí_öode_size
(&
tokí
, 
ôem
, 
öode
->
i_size
);

4135 
	`båfs_£t_tokí_öode_uid
(&
tokí
, 
ôem
, 
	`i_uid_ªad
(
öode
));

4136 
	`båfs_£t_tokí_öode_gid
(&
tokí
, 
ôem
, 
	`i_gid_ªad
(
öode
));

4137 
	`båfs_£t_tokí_öode_mode
(&
tokí
, 
ôem
, 
öode
->
i_mode
);

4138 
	`båfs_£t_tokí_öode_∆ök
(&
tokí
, 
ôem
, 
öode
->
i_∆ök
);

4140 
	`båfs_£t_tokí_time•ec_£c
(&
tokí
, &
ôem
->
©ime
,

4141 
öode
->
i_©ime
.
tv_£c
);

4142 
	`båfs_£t_tokí_time•ec_n£c
(&
tokí
, &
ôem
->
©ime
,

4143 
öode
->
i_©ime
.
tv_n£c
);

4145 
	`båfs_£t_tokí_time•ec_£c
(&
tokí
, &
ôem
->
mtime
,

4146 
öode
->
i_mtime
.
tv_£c
);

4147 
	`båfs_£t_tokí_time•ec_n£c
(&
tokí
, &
ôem
->
mtime
,

4148 
öode
->
i_mtime
.
tv_n£c
);

4150 
	`båfs_£t_tokí_time•ec_£c
(&
tokí
, &
ôem
->
˘ime
,

4151 
	`öode_gë_˘ime
(
öode
).
tv_£c
);

4152 
	`båfs_£t_tokí_time•ec_n£c
(&
tokí
, &
ôem
->
˘ime
,

4153 
	`öode_gë_˘ime
(
öode
).
tv_n£c
);

4164 
	`båfs_£t_tokí_öode_£quí˚
(&
tokí
, 
ôem
, 
	`öode_≥ek_ivîsi⁄
(
öode
));

4165 
	`båfs_£t_tokí_öode_å™sid
(&
tokí
, 
ôem
, 
å™s
->
å™sid
);

4166 
	`båfs_£t_tokí_öode_rdev
(&
tokí
, 
ôem
, 
öode
->
i_rdev
);

4167 
Êags
 = 
	`båfs_öode_comböe_Êags
(
	`BTRFS_I
(
öode
)->flags,

4168 
	`BTRFS_I
(
öode
)->
ro_Êags
);

4169 
	`båfs_£t_tokí_öode_Êags
(&
tokí
, 
ôem
, 
Êags
);

4170 
	`båfs_£t_tokí_öode_block_group
(&
tokí
, 
ôem
, 0);

4171 
	}
}

4173 
	$log_öode_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

4174 
båfs_roŸ
 *
log
, 
båfs_∑th
 *
∑th
,

4175 
båfs_öode
 *
öode
, 
boﬁ
 
öode_ôem_dr›≥d
)

4177 
båfs_öode_ôem
 *
öode_ôem
;

4178 
ªt
;

4190 i‡(!
öode_ôem_dr›≥d
 && 
öode
->
logged_å™s
 =
å™s
->
å™sid
) {

4191 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
log
, &
öode
->
loˇti⁄
, 
∑th
, 0, 1);

4192 
	`ASSERT
(
ªt
 <= 0);

4193 i‡(
ªt
 > 0)

4194 
ªt
 = -
ENOENT
;

4205 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
log
, 
∑th
, &
öode
->
loˇti⁄
,

4206 (*
öode_ôem
));

4207 
	`ASSERT
(
ªt
 !-
EEXIST
);

4209 i‡(
ªt
)

4210  
ªt
;

4211 
öode_ôem
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

4212 
båfs_öode_ôem
);

4213 
	`fûl_öode_ôem
(
å™s
, 
∑th
->
nodes
[0], 
öode_ôem
, &
öode
->
vfs_öode
,

4215 
	`båfs_ªÀa£_∑th
(
∑th
);

4217 
	}
}

4219 
	$log_csums
(
båfs_å™s_h™dÀ
 *
å™s
,

4220 
båfs_öode
 *
öode
,

4221 
båfs_roŸ
 *
log_roŸ
,

4222 
båfs_‹dîed_sum
 *
sums
)

4224 c⁄° 
u64
 
lock_íd
 = 
sums
->
logiˇl
 + sums->
Àn
 - 1;

4225 
exã¡_°©e
 *
ˇched_°©e
 = 
NULL
;

4226 
ªt
;

4233 i‡(
öode
->
œ°_ªÊök_å™s
 < 
å™s
->
å™sid
)

4234  
	`båfs_csum_fûe_blocks
(
å™s
, 
log_roŸ
, 
sums
);

4242 
ªt
 = 
	`lock_exã¡
(&
log_roŸ
->
log_csum_ønge
, 
sums
->
logiˇl
, 
lock_íd
,

4243 &
ˇched_°©e
);

4244 i‡(
ªt
)

4245  
ªt
;

4255 
ªt
 = 
	`båfs_dñ_csums
(
å™s
, 
log_roŸ
, 
sums
->
logiˇl
, sums->
Àn
);

4256 i‡(!
ªt
)

4257 
ªt
 = 
	`båfs_csum_fûe_blocks
(
å™s
, 
log_roŸ
, 
sums
);

4259 
	`u∆ock_exã¡
(&
log_roŸ
->
log_csum_ønge
, 
sums
->
logiˇl
, 
lock_íd
,

4260 &
ˇched_°©e
);

4262  
ªt
;

4263 
	}
}

4265 
noölöe
 
	$c›y_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

4266 
båfs_öode
 *
öode
,

4267 
båfs_∑th
 *
d°_∑th
,

4268 
båfs_∑th
 *
§c_∑th
,

4269 
°¨t_¶Ÿ
, 
ƒ
, 
öode_⁄ly
,

4270 
u64
 
logged_isize
)

4272 
båfs_roŸ
 *
log
 = 
öode
->
roŸ
->
log_roŸ
;

4273 
båfs_fûe_exã¡_ôem
 *
exã¡
;

4274 
exã¡_buf„r
 *
§c
;

4275 
ªt
 = 0;

4276 
båfs_key
 *
ös_keys
;

4277 
u32
 *
ös_sizes
;

4278 
båfs_ôem_b©ch
 
b©ch
;

4279 *
ös_d©a
;

4280 
i
;

4281 
d°_ödex
;

4282 c⁄° 
boﬁ
 
skù_csum
 = (
öode
->
Êags
 & 
BTRFS_INODE_NODATASUM
);

4283 c⁄° 
u64
 
i_size
 = 
	`i_size_ªad
(&
öode
->
vfs_öode
);

4313 
§c
 = 
	`båfs_˛⁄e_exã¡_buf„r
(
§c_∑th
->
nodes
[0]);

4314 i‡(!
§c
)

4315  -
ENOMEM
;

4317 
i
 = 
§c_∑th
->
¶Ÿs
[0];

4318 
	`båfs_ªÀa£_∑th
(
§c_∑th
);

4319 
§c_∑th
->
nodes
[0] = 
§c
;

4320 
§c_∑th
->
¶Ÿs
[0] = 
i
;

4322 
ös_d©a
 = 
	`kmÆloc
(
ƒ
 * (
båfs_key
) +

4323 
ƒ
 * (
u32
), 
GFP_NOFS
);

4324 i‡(!
ös_d©a
)

4325  -
ENOMEM
;

4327 
ös_sizes
 = (
u32
 *)
ös_d©a
;

4328 
ös_keys
 = (
båfs_key
 *)(
ös_d©a
 + 
ƒ
 * (
u32
));

4329 
b©ch
.
keys
 = 
ös_keys
;

4330 
b©ch
.
d©a_sizes
 = 
ös_sizes
;

4331 
b©ch
.
tŸÆ_d©a_size
 = 0;

4332 
b©ch
.
ƒ
 = 0;

4334 
d°_ödex
 = 0;

4335 
i
 = 0; i < 
ƒ
; i++) {

4336 c⁄° 
§c_¶Ÿ
 = 
°¨t_¶Ÿ
 + 
i
;

4337 
båfs_roŸ
 *
csum_roŸ
;

4338 
båfs_‹dîed_sum
 *
sums
;

4339 
båfs_‹dîed_sum
 *
sums_√xt
;

4340 
	`LIST_HEAD
(
‹dîed_sums
);

4341 
u64
 
disk_byãƒ
;

4342 
u64
 
disk_num_byãs
;

4343 
u64
 
exã¡_off£t
;

4344 
u64
 
exã¡_num_byãs
;

4345 
boﬁ
 
is_ﬁd_exã¡
;

4347 
	`båfs_ôem_key_to_˝u
(
§c
, &
ös_keys
[
d°_ödex
], 
§c_¶Ÿ
);

4349 i‡(
ös_keys
[
d°_ödex
].
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

4350 
add_to_b©ch
;

4352 
exã¡
 = 
	`båfs_ôem_±r
(
§c
, 
§c_¶Ÿ
,

4353 
båfs_fûe_exã¡_ôem
);

4355 
is_ﬁd_exã¡
 = (
	`båfs_fûe_exã¡_gíî©i⁄
(
§c
, 
exã¡
) <

4356 
å™s
->
å™sid
);

4371 i‡(
is_ﬁd_exã¡
 &&

4372 
ös_keys
[
d°_ödex
].
off£t
 < 
i_size
 &&

4373 
öode
->
œ°_ªÊök_å™s
 < 
å™s
->
å™sid
)

4376 i‡(
skù_csum
)

4377 
add_to_b©ch
;

4380 i‡(
	`båfs_fûe_exã¡_ty≥
(
§c
, 
exã¡
Ë!
BTRFS_FILE_EXTENT_REG
)

4381 
add_to_b©ch
;

4388 i‡(
is_ﬁd_exã¡
)

4389 
add_to_b©ch
;

4391 
disk_byãƒ
 = 
	`båfs_fûe_exã¡_disk_byãƒ
(
§c
, 
exã¡
);

4393 i‡(
disk_byãƒ
 == 0)

4394 
add_to_b©ch
;

4396 
disk_num_byãs
 = 
	`båfs_fûe_exã¡_disk_num_byãs
(
§c
, 
exã¡
);

4398 i‡(
	`båfs_fûe_exã¡_com¥essi⁄
(
§c
, 
exã¡
)) {

4399 
exã¡_off£t
 = 0;

4400 
exã¡_num_byãs
 = 
disk_num_byãs
;

4402 
exã¡_off£t
 = 
	`båfs_fûe_exã¡_off£t
(
§c
, 
exã¡
);

4403 
exã¡_num_byãs
 = 
	`båfs_fûe_exã¡_num_byãs
(
§c
, 
exã¡
);

4406 
csum_roŸ
 = 
	`båfs_csum_roŸ
(
å™s
->
fs_öfo
, 
disk_byãƒ
);

4407 
disk_byãƒ
 +
exã¡_off£t
;

4408 
ªt
 = 
	`båfs_lookup_csums_li°
(
csum_roŸ
, 
disk_byãƒ
,

4409 
disk_byãƒ
 + 
exã¡_num_byãs
 - 1,

4410 &
‹dîed_sums
, 0, 
Ál£
);

4411 i‡(
ªt
)

4412 
out
;

4414 
	`li°_f‹_óch_íåy_ß„
(
sums
, 
sums_√xt
, &
‹dîed_sums
, 
li°
) {

4415 i‡(!
ªt
)

4416 
ªt
 = 
	`log_csums
(
å™s
, 
öode
, 
log
, 
sums
);

4417 
	`li°_dñ
(&
sums
->
li°
);

4418 
	`k‰ì
(
sums
);

4420 i‡(
ªt
)

4421 
out
;

4423 
add_to_b©ch
:

4424 
ös_sizes
[
d°_ödex
] = 
	`båfs_ôem_size
(
§c
, 
§c_¶Ÿ
);

4425 
b©ch
.
tŸÆ_d©a_size
 +
ös_sizes
[
d°_ödex
];

4426 
b©ch
.
ƒ
++;

4427 
d°_ödex
++;

4434 i‡(
b©ch
.
ƒ
 == 0)

4435 
out
;

4437 
ªt
 = 
	`båfs_ö£π_em±y_ôems
(
å™s
, 
log
, 
d°_∑th
, &
b©ch
);

4438 i‡(
ªt
)

4439 
out
;

4441 
d°_ödex
 = 0;

4442 
i
 = 0; i < 
ƒ
; i++) {

4443 c⁄° 
§c_¶Ÿ
 = 
°¨t_¶Ÿ
 + 
i
;

4444 c⁄° 
d°_¶Ÿ
 = 
d°_∑th
->
¶Ÿs
[0] + 
d°_ödex
;

4445 
båfs_key
 
key
;

4446 
§c_off£t
;

4447 
d°_off£t
;

4453 i‡(
d°_ödex
 >
b©ch
.
ƒ
)

4456 
	`båfs_ôem_key_to_˝u
(
§c
, &
key
, 
§c_¶Ÿ
);

4458 i‡(
key
.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

4459 
c›y_ôem
;

4461 
exã¡
 = 
	`båfs_ôem_±r
(
§c
, 
§c_¶Ÿ
,

4462 
båfs_fûe_exã¡_ôem
);

4465 i‡(
	`båfs_fûe_exã¡_gíî©i⁄
(
§c
, 
exã¡
Ë< 
å™s
->
å™sid
 &&

4466 
key
.
off£t
 < 
i_size
 &&

4467 
öode
->
œ°_ªÊök_å™s
 < 
å™s
->
å™sid
)

4470 
c›y_ôem
:

4471 
d°_off£t
 = 
	`båfs_ôem_±r_off£t
(
d°_∑th
->
nodes
[0], 
d°_¶Ÿ
);

4472 
§c_off£t
 = 
	`båfs_ôem_±r_off£t
(
§c
, 
§c_¶Ÿ
);

4474 i‡(
key
.
ty≥
 =
BTRFS_INODE_ITEM_KEY
) {

4475 
båfs_öode_ôem
 *
öode_ôem
;

4477 
öode_ôem
 = 
	`båfs_ôem_±r
(
d°_∑th
->
nodes
[0], 
d°_¶Ÿ
,

4478 
båfs_öode_ôem
);

4479 
	`fûl_öode_ôem
(
å™s
, 
d°_∑th
->
nodes
[0], 
öode_ôem
,

4480 &
öode
->
vfs_öode
,

4481 
öode_⁄ly
 =
LOG_INODE_EXISTS
,

4482 
logged_isize
);

4484 
	`c›y_exã¡_buf„r
(
d°_∑th
->
nodes
[0], 
§c
, 
d°_off£t
,

4485 
§c_off£t
, 
ös_sizes
[
d°_ödex
]);

4488 
d°_ödex
++;

4491 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
d°_∑th
->
nodes
[0]);

4492 
	`båfs_ªÀa£_∑th
(
d°_∑th
);

4493 
out
:

4494 
	`k‰ì
(
ös_d©a
);

4496  
ªt
;

4497 
	}
}

4499 
	$exã¡_cmp
(*
¥iv
, c⁄° 
li°_hód
 *
a
,

4500 c⁄° 
li°_hód
 *
b
)

4502 c⁄° 
exã¡_m≠
 *
em1
, *
em2
;

4504 
em1
 = 
	`li°_íåy
(
a
, 
exã¡_m≠
, 
li°
);

4505 
em2
 = 
	`li°_íåy
(
b
, 
exã¡_m≠
, 
li°
);

4507 i‡(
em1
->
°¨t
 < 
em2
->start)

4509 i‡(
em1
->
°¨t
 > 
em2
->start)

4512 
	}
}

4514 
	$log_exã¡_csums
(
båfs_å™s_h™dÀ
 *
å™s
,

4515 
båfs_öode
 *
öode
,

4516 
båfs_roŸ
 *
log_roŸ
,

4517 c⁄° 
exã¡_m≠
 *
em
,

4518 
båfs_log_˘x
 *
˘x
)

4520 
båfs_‹dîed_exã¡
 *
‹dîed
;

4521 
båfs_roŸ
 *
csum_roŸ
;

4522 
u64
 
csum_off£t
;

4523 
u64
 
csum_Àn
;

4524 
u64
 
mod_°¨t
 = 
em
->mod_start;

4525 
u64
 
mod_Àn
 = 
em
->mod_len;

4526 
	`LIST_HEAD
(
‹dîed_sums
);

4527 
ªt
 = 0;

4529 i‡(
öode
->
Êags
 & 
BTRFS_INODE_NODATASUM
 ||

4530 
	`ã°_bô
(
EXTENT_FLAG_PREALLOC
, &
em
->
Êags
) ||

4531 
em
->
block_°¨t
 =
EXTENT_MAP_HOLE
)

4534 
	`li°_f‹_óch_íåy
(
‹dîed
, &
˘x
->
‹dîed_exã¡s
, 
log_li°
) {

4535 c⁄° 
u64
 
‹dîed_íd
 = 
‹dîed
->
fûe_off£t
 + ordîed->
num_byãs
;

4536 c⁄° 
u64
 
mod_íd
 = 
mod_°¨t
 + 
mod_Àn
;

4537 
båfs_‹dîed_sum
 *
sums
;

4539 i‡(
mod_Àn
 == 0)

4542 i‡(
‹dîed_íd
 <
mod_°¨t
)

4544 i‡(
mod_íd
 <
‹dîed
->
fûe_off£t
)

4552 i‡(
‹dîed
->
fûe_off£t
 > 
mod_°¨t
) {

4553 i‡(
‹dîed_íd
 >
mod_íd
)

4554 
mod_Àn
 = 
‹dîed
->
fûe_off£t
 - 
mod_°¨t
;

4566 i‡(
‹dîed_íd
 < 
mod_íd
) {

4567 
mod_Àn
 = 
mod_íd
 - 
‹dîed_íd
;

4568 
mod_°¨t
 = 
‹dîed_íd
;

4570 
mod_Àn
 = 0;

4578 i‡(
	`ã°_™d_£t_bô
(
BTRFS_ORDERED_LOGGED_CSUM
, &
‹dîed
->
Êags
))

4581 
	`li°_f‹_óch_íåy
(
sums
, &
‹dîed
->
li°
,Üist) {

4582 
ªt
 = 
	`log_csums
(
å™s
, 
öode
, 
log_roŸ
, 
sums
);

4583 i‡(
ªt
)

4584  
ªt
;

4589 i‡(
mod_Àn
 == 0)

4593 i‡(
em
->
com¥ess_ty≥
) {

4594 
csum_off£t
 = 0;

4595 
csum_Àn
 = 
	`max
(
em
->
block_Àn
,Ém->
‹ig_block_Àn
);

4597 
csum_off£t
 = 
mod_°¨t
 - 
em
->
°¨t
;

4598 
csum_Àn
 = 
mod_Àn
;

4602 
csum_roŸ
 = 
	`båfs_csum_roŸ
(
å™s
->
fs_öfo
, 
em
->
block_°¨t
);

4603 
ªt
 = 
	`båfs_lookup_csums_li°
(
csum_roŸ
, 
em
->
block_°¨t
 + 
csum_off£t
,

4604 
em
->
block_°¨t
 + 
csum_off£t
 +

4605 
csum_Àn
 - 1, &
‹dîed_sums
, 0, 
Ál£
);

4606 i‡(
ªt
)

4607  
ªt
;

4609 !
	`li°_em±y
(&
‹dîed_sums
)) {

4610 
båfs_‹dîed_sum
 *
sums
 = 
	`li°_íåy
(
‹dîed_sums
.
√xt
,

4611 
båfs_‹dîed_sum
,

4612 
li°
);

4613 i‡(!
ªt
)

4614 
ªt
 = 
	`log_csums
(
å™s
, 
öode
, 
log_roŸ
, 
sums
);

4615 
	`li°_dñ
(&
sums
->
li°
);

4616 
	`k‰ì
(
sums
);

4619  
ªt
;

4620 
	}
}

4622 
	$log_⁄e_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

4623 
båfs_öode
 *
öode
,

4624 c⁄° 
exã¡_m≠
 *
em
,

4625 
båfs_∑th
 *
∑th
,

4626 
båfs_log_˘x
 *
˘x
)

4628 
båfs_dr›_exã¡s_¨gs
 
dr›_¨gs
 = { 0 };

4629 
båfs_roŸ
 *
log
 = 
öode
->
roŸ
->
log_roŸ
;

4630 
båfs_fûe_exã¡_ôem
 
fi
 = { 0 };

4631 
exã¡_buf„r
 *
Àaf
;

4632 
båfs_key
 
key
;

4633 
u64
 
exã¡_off£t
 = 
em
->
°¨t
 -Ém->
‹ig_°¨t
;

4634 
u64
 
block_Àn
;

4635 
ªt
;

4637 
	`båfs_£t_°ack_fûe_exã¡_gíî©i⁄
(&
fi
, 
å™s
->
å™sid
);

4638 i‡(
	`ã°_bô
(
EXTENT_FLAG_PREALLOC
, &
em
->
Êags
))

4639 
	`båfs_£t_°ack_fûe_exã¡_ty≥
(&
fi
, 
BTRFS_FILE_EXTENT_PREALLOC
);

4641 
	`båfs_£t_°ack_fûe_exã¡_ty≥
(&
fi
, 
BTRFS_FILE_EXTENT_REG
);

4643 
block_Àn
 = 
	`max
(
em
->block_Àn,Ém->
‹ig_block_Àn
);

4644 i‡(
em
->
com¥ess_ty≥
 !
BTRFS_COMPRESS_NONE
) {

4645 
	`båfs_£t_°ack_fûe_exã¡_disk_byãƒ
(&
fi
, 
em
->
block_°¨t
);

4646 
	`båfs_£t_°ack_fûe_exã¡_disk_num_byãs
(&
fi
, 
block_Àn
);

4647 } i‡(
em
->
block_°¨t
 < 
EXTENT_MAP_LAST_BYTE
) {

4648 
	`båfs_£t_°ack_fûe_exã¡_disk_byãƒ
(&
fi
, 
em
->
block_°¨t
 -

4649 
exã¡_off£t
);

4650 
	`båfs_£t_°ack_fûe_exã¡_disk_num_byãs
(&
fi
, 
block_Àn
);

4653 
	`båfs_£t_°ack_fûe_exã¡_off£t
(&
fi
, 
exã¡_off£t
);

4654 
	`båfs_£t_°ack_fûe_exã¡_num_byãs
(&
fi
, 
em
->
Àn
);

4655 
	`båfs_£t_°ack_fûe_exã¡_øm_byãs
(&
fi
, 
em
->
øm_byãs
);

4656 
	`båfs_£t_°ack_fûe_exã¡_com¥essi⁄
(&
fi
, 
em
->
com¥ess_ty≥
);

4658 
ªt
 = 
	`log_exã¡_csums
(
å™s
, 
öode
, 
log
, 
em
, 
˘x
);

4659 i‡(
ªt
)

4660  
ªt
;

4671 i‡(
˘x
->
logged_bef‹e
) {

4672 
dr›_¨gs
.
∑th
 =Öath;

4673 
dr›_¨gs
.
°¨t
 = 
em
->start;

4674 
dr›_¨gs
.
íd
 = 
em
->
°¨t
 +Ém->
Àn
;

4675 
dr›_¨gs
.
ª∂a˚_exã¡
 = 
åue
;

4676 
dr›_¨gs
.
exã¡_ôem_size
 = (
fi
);

4677 
ªt
 = 
	`båfs_dr›_exã¡s
(
å™s
, 
log
, 
öode
, &
dr›_¨gs
);

4678 i‡(
ªt
)

4679  
ªt
;

4682 i‡(!
dr›_¨gs
.
exã¡_ö£πed
) {

4683 
key
.
obje˘id
 = 
	`båfs_öo
(
öode
);

4684 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

4685 
key
.
off£t
 = 
em
->
°¨t
;

4687 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
log
, 
∑th
, &
key
,

4688 (
fi
));

4689 i‡(
ªt
)

4690  
ªt
;

4692 
Àaf
 = 
∑th
->
nodes
[0];

4693 
	`wrôe_exã¡_buf„r
(
Àaf
, &
fi
,

4694 
	`båfs_ôem_±r_off£t
(
Àaf
, 
∑th
->
¶Ÿs
[0]),

4695 (
fi
));

4696 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

4698 
	`båfs_ªÀa£_∑th
(
∑th
);

4700  
ªt
;

4701 
	}
}

4711 
	$båfs_log_¥óŒoc_exã¡s
(
båfs_å™s_h™dÀ
 *
å™s
,

4712 
båfs_öode
 *
öode
,

4713 
båfs_∑th
 *
∑th
)

4715 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

4716 
båfs_key
 
key
;

4717 c⁄° 
u64
 
i_size
 = 
	`i_size_ªad
(&
öode
->
vfs_öode
);

4718 c⁄° 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

4719 
båfs_∑th
 *
d°_∑th
 = 
NULL
;

4720 
boﬁ
 
dr›≥d_exã¡s
 = 
Ál£
;

4721 
u64
 
åunˇã_off£t
 = 
i_size
;

4722 
exã¡_buf„r
 *
Àaf
;

4723 
¶Ÿ
;

4724 
ös_ƒ
 = 0;

4725 
°¨t_¶Ÿ
 = 0;

4726 
ªt
;

4728 i‡(!(
öode
->
Êags
 & 
BTRFS_INODE_PREALLOC
))

4731 
key
.
obje˘id
 = 
öo
;

4732 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

4733 
key
.
off£t
 = 
i_size
;

4734 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

4735 i‡(
ªt
 < 0)

4736 
out
;

4746 
ªt
 = 
	`båfs_¥evious_ôem
(
roŸ
, 
∑th
, 
öo
, 
BTRFS_EXTENT_DATA_KEY
);

4747 i‡(
ªt
 < 0)

4748 
out
;

4750 i‡(
ªt
 == 0) {

4751 
båfs_fûe_exã¡_ôem
 *
ei
;

4753 
Àaf
 = 
∑th
->
nodes
[0];

4754 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

4755 
ei
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_fûe_exã¡_ôem
);

4757 i‡(
	`båfs_fûe_exã¡_ty≥
(
Àaf
, 
ei
) ==

4758 
BTRFS_FILE_EXTENT_PREALLOC
) {

4759 
u64
 
exã¡_íd
;

4761 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

4762 
exã¡_íd
 = 
key
.
off£t
 +

4763 
	`båfs_fûe_exã¡_num_byãs
(
Àaf
, 
ei
);

4765 i‡(
exã¡_íd
 > 
i_size
)

4766 
åunˇã_off£t
 = 
exã¡_íd
;

4769 
ªt
 = 0;

4772 
åue
) {

4773 
Àaf
 = 
∑th
->
nodes
[0];

4774 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

4776 i‡(
¶Ÿ
 >
	`båfs_hódî_ƒôems
(
Àaf
)) {

4777 i‡(
ös_ƒ
 > 0) {

4778 
ªt
 = 
	`c›y_ôems
(
å™s
, 
öode
, 
d°_∑th
, 
∑th
,

4779 
°¨t_¶Ÿ
, 
ös_ƒ
, 1, 0);

4780 i‡(
ªt
 < 0)

4781 
out
;

4782 
ös_ƒ
 = 0;

4784 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

4785 i‡(
ªt
 < 0)

4786 
out
;

4787 i‡(
ªt
 > 0) {

4788 
ªt
 = 0;

4794 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

4795 i‡(
key
.
obje˘id
 > 
öo
)

4797 i‡(
	`WARN_ON_ONCE
(
key
.
obje˘id
 < 
öo
) ||

4798 
key
.
ty≥
 < 
BTRFS_EXTENT_DATA_KEY
 ||

4799 
key
.
off£t
 < 
i_size
) {

4800 
∑th
->
¶Ÿs
[0]++;

4803 i‡(!
dr›≥d_exã¡s
) {

4808 
ªt
 = 
	`åunˇã_öode_ôems
(
å™s
, 
roŸ
->
log_roŸ
, 
öode
,

4809 
åunˇã_off£t
,

4810 
BTRFS_EXTENT_DATA_KEY
);

4811 i‡(
ªt
)

4812 
out
;

4813 
dr›≥d_exã¡s
 = 
åue
;

4815 i‡(
ös_ƒ
 == 0)

4816 
°¨t_¶Ÿ
 = 
¶Ÿ
;

4817 
ös_ƒ
++;

4818 
∑th
->
¶Ÿs
[0]++;

4819 i‡(!
d°_∑th
) {

4820 
d°_∑th
 = 
	`båfs_Æloc_∑th
();

4821 i‡(!
d°_∑th
) {

4822 
ªt
 = -
ENOMEM
;

4823 
out
;

4827 i‡(
ös_ƒ
 > 0)

4828 
ªt
 = 
	`c›y_ôems
(
å™s
, 
öode
, 
d°_∑th
, 
∑th
,

4829 
°¨t_¶Ÿ
, 
ös_ƒ
, 1, 0);

4830 
out
:

4831 
	`båfs_ªÀa£_∑th
(
∑th
);

4832 
	`båfs_‰ì_∑th
(
d°_∑th
);

4833  
ªt
;

4834 
	}
}

4836 
	$båfs_log_ch™ged_exã¡s
(
båfs_å™s_h™dÀ
 *
å™s
,

4837 
båfs_öode
 *
öode
,

4838 
båfs_∑th
 *
∑th
,

4839 
båfs_log_˘x
 *
˘x
)

4841 
båfs_‹dîed_exã¡
 *
‹dîed
;

4842 
båfs_‹dîed_exã¡
 *
tmp
;

4843 
exã¡_m≠
 *
em
, *
n
;

4844 
	`LIST_HEAD
(
exã¡s
);

4845 
exã¡_m≠_åì
 *
åì
 = &
öode
->
exã¡_åì
;

4846 
ªt
 = 0;

4847 
num
 = 0;

4849 
	`wrôe_lock
(&
åì
->
lock
);

4851 
	`li°_f‹_óch_íåy_ß„
(
em
, 
n
, &
åì
->
modifõd_exã¡s
, 
li°
) {

4852 
	`li°_dñ_öô
(&
em
->
li°
);

4859 i‡(++
num
 > 32768) {

4860 
	`li°_dñ_öô
(&
åì
->
modifõd_exã¡s
);

4861 
ªt
 = -
EFBIG
;

4862 
¥o˚ss
;

4865 i‡(
em
->
gíî©i⁄
 < 
å™s
->
å™sid
)

4869 i‡(
	`ã°_bô
(
EXTENT_FLAG_PREALLOC
, &
em
->
Êags
) &&

4870 
em
->
°¨t
 >
	`i_size_ªad
(&
öode
->
vfs_öode
))

4874 
	`ªfcou¡_öc
(&
em
->
ªfs
);

4875 
	`£t_bô
(
EXTENT_FLAG_LOGGING
, &
em
->
Êags
);

4876 
	`li°_add_èû
(&
em
->
li°
, &
exã¡s
);

4877 
num
++;

4880 
	`li°_s‹t
(
NULL
, &
exã¡s
, 
exã¡_cmp
);

4881 
¥o˚ss
:

4882 !
	`li°_em±y
(&
exã¡s
)) {

4883 
em
 = 
	`li°_íåy
(
exã¡s
.
√xt
, 
exã¡_m≠
, 
li°
);

4885 
	`li°_dñ_öô
(&
em
->
li°
);

4891 i‡(
ªt
) {

4892 
	`˛ór_em_loggög
(
åì
, 
em
);

4893 
	`‰ì_exã¡_m≠
(
em
);

4897 
	`wrôe_u∆ock
(&
åì
->
lock
);

4899 
ªt
 = 
	`log_⁄e_exã¡
(
å™s
, 
öode
, 
em
, 
∑th
, 
˘x
);

4900 
	`wrôe_lock
(&
åì
->
lock
);

4901 
	`˛ór_em_loggög
(
åì
, 
em
);

4902 
	`‰ì_exã¡_m≠
(
em
);

4904 
	`WARN_ON
(!
	`li°_em±y
(&
exã¡s
));

4905 
	`wrôe_u∆ock
(&
åì
->
lock
);

4907 i‡(!
ªt
)

4908 
ªt
 = 
	`båfs_log_¥óŒoc_exã¡s
(
å™s
, 
öode
, 
∑th
);

4909 i‡(
ªt
)

4910  
ªt
;

4919 
	`li°_f‹_óch_íåy_ß„
(
‹dîed
, 
tmp
, &
˘x
->
‹dîed_exã¡s
, 
log_li°
) {

4920 
	`li°_dñ_öô
(&
‹dîed
->
log_li°
);

4921 
	`£t_bô
(
BTRFS_ORDERED_LOGGED
, &
‹dîed
->
Êags
);

4923 i‡(!
	`ã°_bô
(
BTRFS_ORDERED_COMPLETE
, &
‹dîed
->
Êags
)) {

4924 
	`•ö_lock_úq
(&
öode
->
‹dîed_åì
.
lock
);

4925 i‡(!
	`ã°_bô
(
BTRFS_ORDERED_COMPLETE
, &
‹dîed
->
Êags
)) {

4926 
	`£t_bô
(
BTRFS_ORDERED_PENDING
, &
‹dîed
->
Êags
);

4927 
	`©omic_öc
(&
å™s
->
å™ß˘i⁄
->
≥ndög_‹dîed
);

4929 
	`•ö_u∆ock_úq
(&
öode
->
‹dîed_åì
.
lock
);

4931 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

4935 
	}
}

4937 
	$logged_öode_size
(
båfs_roŸ
 *
log
, 
båfs_öode
 *
öode
,

4938 
båfs_∑th
 *
∑th
, 
u64
 *
size_ªt
)

4940 
båfs_key
 
key
;

4941 
ªt
;

4943 
key
.
obje˘id
 = 
	`båfs_öo
(
öode
);

4944 
key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

4945 
key
.
off£t
 = 0;

4947 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
log
, &
key
, 
∑th
, 0, 0);

4948 i‡(
ªt
 < 0) {

4949  
ªt
;

4950 } i‡(
ªt
 > 0) {

4951 *
size_ªt
 = 0;

4953 
båfs_öode_ôem
 *
ôem
;

4955 
ôem
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

4956 
båfs_öode_ôem
);

4957 *
size_ªt
 = 
	`båfs_öode_size
(
∑th
->
nodes
[0], 
ôem
);

4969 i‡(*
size_ªt
 > 
öode
->
vfs_öode
.
i_size
)

4970 *
size_ªt
 = 
öode
->
vfs_öode
.
i_size
;

4973 
	`båfs_ªÀa£_∑th
(
∑th
);

4975 
	}
}

4986 
	$båfs_log_Æl_x©ås
(
båfs_å™s_h™dÀ
 *
å™s
,

4987 
båfs_öode
 *
öode
,

4988 
båfs_∑th
 *
∑th
,

4989 
båfs_∑th
 *
d°_∑th
)

4991 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

4992 
ªt
;

4993 
båfs_key
 
key
;

4994 c⁄° 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

4995 
ös_ƒ
 = 0;

4996 
°¨t_¶Ÿ
 = 0;

4997 
boﬁ
 
found_x©ås
 = 
Ál£
;

4999 i‡(
	`ã°_bô
(
BTRFS_INODE_NO_XATTRS
, &
öode
->
ru¡ime_Êags
))

5002 
key
.
obje˘id
 = 
öo
;

5003 
key
.
ty≥
 = 
BTRFS_XATTR_ITEM_KEY
;

5004 
key
.
off£t
 = 0;

5006 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

5007 i‡(
ªt
 < 0)

5008  
ªt
;

5010 
åue
) {

5011 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

5012 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

5013 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
Àaf
);

5015 i‡(
¶Ÿ
 >
ƒôems
) {

5016 i‡(
ös_ƒ
 > 0) {

5017 
ªt
 = 
	`c›y_ôems
(
å™s
, 
öode
, 
d°_∑th
, 
∑th
,

5018 
°¨t_¶Ÿ
, 
ös_ƒ
, 1, 0);

5019 i‡(
ªt
 < 0)

5020  
ªt
;

5021 
ös_ƒ
 = 0;

5023 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

5024 i‡(
ªt
 < 0)

5025  
ªt
;

5026 i‡(
ªt
 > 0)

5031 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

5032 i‡(
key
.
obje˘id
 !
öo
 || key.
ty≥
 !
BTRFS_XATTR_ITEM_KEY
)

5035 i‡(
ös_ƒ
 == 0)

5036 
°¨t_¶Ÿ
 = 
¶Ÿ
;

5037 
ös_ƒ
++;

5038 
∑th
->
¶Ÿs
[0]++;

5039 
found_x©ås
 = 
åue
;

5040 
	`c⁄d_ªsched
();

5042 i‡(
ös_ƒ
 > 0) {

5043 
ªt
 = 
	`c›y_ôems
(
å™s
, 
öode
, 
d°_∑th
, 
∑th
,

5044 
°¨t_¶Ÿ
, 
ös_ƒ
, 1, 0);

5045 i‡(
ªt
 < 0)

5046  
ªt
;

5049 i‡(!
found_x©ås
)

5050 
	`£t_bô
(
BTRFS_INODE_NO_XATTRS
, &
öode
->
ru¡ime_Êags
);

5053 
	}
}

5064 
	$båfs_log_hﬁes
(
båfs_å™s_h™dÀ
 *
å™s
,

5065 
båfs_öode
 *
öode
,

5066 
båfs_∑th
 *
∑th
)

5068 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

5069 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

5070 
båfs_key
 
key
;

5071 c⁄° 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

5072 c⁄° 
u64
 
i_size
 = 
	`i_size_ªad
(&
öode
->
vfs_öode
);

5073 
u64
 
¥ev_exã¡_íd
 = 0;

5074 
ªt
;

5076 i‡(!
	`båfs_fs_öcom∑t
(
fs_öfo
, 
NO_HOLES
Ë|| 
i_size
 == 0)

5079 
key
.
obje˘id
 = 
öo
;

5080 
key
.
ty≥
 = 
BTRFS_EXTENT_DATA_KEY
;

5081 
key
.
off£t
 = 0;

5083 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

5084 i‡(
ªt
 < 0)

5085  
ªt
;

5087 
åue
) {

5088 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

5090 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
’©h->
nodes
[0])) {

5091 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

5092 i‡(
ªt
 < 0)

5093  
ªt
;

5094 i‡(
ªt
 > 0) {

5095 
ªt
 = 0;

5098 
Àaf
 = 
∑th
->
nodes
[0];

5101 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

5102 i‡(
key
.
obje˘id
 !
öo
 || key.
ty≥
 !
BTRFS_EXTENT_DATA_KEY
)

5106 i‡(
¥ev_exã¡_íd
 < 
key
.
off£t
) {

5107 c⁄° 
u64
 
hﬁe_Àn
 = 
key
.
off£t
 - 
¥ev_exã¡_íd
;

5114 
	`båfs_ªÀa£_∑th
(
∑th
);

5115 
ªt
 = 
	`båfs_ö£π_hﬁe_exã¡
(
å™s
, 
roŸ
->
log_roŸ
,

5116 
öo
, 
¥ev_exã¡_íd
,

5117 
hﬁe_Àn
);

5118 i‡(
ªt
 < 0)

5119  
ªt
;

5128 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

5129 i‡(
ªt
 < 0)

5130  
ªt
;

5131 i‡(
	`WARN_ON
(
ªt
 > 0))

5132  -
ENOENT
;

5133 
Àaf
 = 
∑th
->
nodes
[0];

5136 
¥ev_exã¡_íd
 = 
	`båfs_fûe_exã¡_íd
(
∑th
);

5137 
∑th
->
¶Ÿs
[0]++;

5138 
	`c⁄d_ªsched
();

5141 i‡(
¥ev_exã¡_íd
 < 
i_size
) {

5142 
u64
 
hﬁe_Àn
;

5144 
	`båfs_ªÀa£_∑th
(
∑th
);

5145 
hﬁe_Àn
 = 
	`ALIGN
(
i_size
 - 
¥ev_exã¡_íd
, 
fs_öfo
->
£˘‹size
);

5146 
ªt
 = 
	`båfs_ö£π_hﬁe_exã¡
(
å™s
, 
roŸ
->
log_roŸ
, 
öo
,

5147 
¥ev_exã¡_íd
, 
hﬁe_Àn
);

5148 i‡(
ªt
 < 0)

5149  
ªt
;

5153 
	}
}

5197 
	$båfs_check_ªf_«me_ovîride
(
exã¡_buf„r
 *
eb
,

5198 c⁄° 
¶Ÿ
,

5199 c⁄° 
båfs_key
 *
key
,

5200 
båfs_öode
 *
öode
,

5201 
u64
 *
Ÿhî_öo
, u64 *
Ÿhî_∑ª¡
)

5203 
ªt
;

5204 
båfs_∑th
 *
£¨ch_∑th
;

5205 *
«me
 = 
NULL
;

5206 
u32
 
«me_Àn
 = 0;

5207 
u32
 
ôem_size
 = 
	`båfs_ôem_size
(
eb
, 
¶Ÿ
);

5208 
u32
 
cur_off£t
 = 0;

5209 
±r
 = 
	`båfs_ôem_±r_off£t
(
eb
, 
¶Ÿ
);

5211 
£¨ch_∑th
 = 
	`båfs_Æloc_∑th
();

5212 i‡(!
£¨ch_∑th
)

5213  -
ENOMEM
;

5214 
£¨ch_∑th
->
£¨ch_commô_roŸ
 = 1;

5215 
£¨ch_∑th
->
skù_lockög
 = 1;

5217 
cur_off£t
 < 
ôem_size
) {

5218 
u64
 
∑ª¡
;

5219 
u32
 
this_«me_Àn
;

5220 
u32
 
this_Àn
;

5221 
«me_±r
;

5222 
båfs_dú_ôem
 *
di
;

5223 
fs¸y±_°r
 
«me_°r
;

5225 i‡(
key
->
ty≥
 =
BTRFS_INODE_REF_KEY
) {

5226 
båfs_öode_ªf
 *
úef
;

5228 
úef
 = (
båfs_öode_ªf
 *)(
±r
 + 
cur_off£t
);

5229 
∑ª¡
 = 
key
->
off£t
;

5230 
this_«me_Àn
 = 
	`båfs_öode_ªf_«me_Àn
(
eb
, 
úef
);

5231 
«me_±r
 = ()(
úef
 + 1);

5232 
this_Àn
 = (*
úef
Ë+ 
this_«me_Àn
;

5234 
båfs_öode_exåef
 *
exåef
;

5236 
exåef
 = (
båfs_öode_exåef
 *)(
±r
 +

5237 
cur_off£t
);

5238 
∑ª¡
 = 
	`båfs_öode_exåef_∑ª¡
(
eb
, 
exåef
);

5239 
this_«me_Àn
 = 
	`båfs_öode_exåef_«me_Àn
(
eb
, 
exåef
);

5240 
«me_±r
 = ()&
exåef
->
«me
;

5241 
this_Àn
 = (*
exåef
Ë+ 
this_«me_Àn
;

5244 i‡(
this_«me_Àn
 > 
«me_Àn
) {

5245 *
√w_«me
;

5247 
√w_«me
 = 
	`kªÆloc
(
«me
, 
this_«me_Àn
, 
GFP_NOFS
);

5248 i‡(!
√w_«me
) {

5249 
ªt
 = -
ENOMEM
;

5250 
out
;

5252 
«me_Àn
 = 
this_«me_Àn
;

5253 
«me
 = 
√w_«me
;

5256 
	`ªad_exã¡_buf„r
(
eb
, 
«me
, 
«me_±r
, 
this_«me_Àn
);

5258 
«me_°r
.
«me
 =Çame;

5259 
«me_°r
.
Àn
 = 
this_«me_Àn
;

5260 
di
 = 
	`båfs_lookup_dú_ôem
(
NULL
, 
öode
->
roŸ
, 
£¨ch_∑th
,

5261 
∑ª¡
, &
«me_°r
, 0);

5262 i‡(
di
 && !
	`IS_ERR
(di)) {

5263 
båfs_key
 
di_key
;

5265 
	`båfs_dú_ôem_key_to_˝u
(
£¨ch_∑th
->
nodes
[0],

5266 
di
, &
di_key
);

5267 i‡(
di_key
.
ty≥
 =
BTRFS_INODE_ITEM_KEY
) {

5268 i‡(
di_key
.
obje˘id
 !
key
->objectid) {

5269 
ªt
 = 1;

5270 *
Ÿhî_öo
 = 
di_key
.
obje˘id
;

5271 *
Ÿhî_∑ª¡
 = 
∑ª¡
;

5273 
ªt
 = 0;

5276 
ªt
 = -
EAGAIN
;

5278 
out
;

5279 } i‡(
	`IS_ERR
(
di
)) {

5280 
ªt
 = 
	`PTR_ERR
(
di
);

5281 
out
;

5283 
	`båfs_ªÀa£_∑th
(
£¨ch_∑th
);

5285 
cur_off£t
 +
this_Àn
;

5287 
ªt
 = 0;

5288 
out
:

5289 
	`båfs_‰ì_∑th
(
£¨ch_∑th
);

5290 
	`k‰ì
(
«me
);

5291  
ªt
;

5292 
	}
}

5303 
boﬁ
 
	$√ed_log_öode
(c⁄° 
båfs_å™s_h™dÀ
 *
å™s
,

5304 
båfs_öode
 *
öode
)

5310 i‡(
	`S_ISDIR
(
öode
->
vfs_öode
.
i_mode
Ë&& inode->
œ°_å™s
 < 
å™s
->
å™sid
)

5311  
Ál£
;

5322 i‡(
	`öode_logged
(
å™s
, 
öode
, 
NULL
) == 1 &&

5323 !
	`ã°_bô
(
BTRFS_INODE_COPY_EVERYTHING
, &
öode
->
ru¡ime_Êags
))

5324  
Ál£
;

5326  
åue
;

5327 
	}
}

5329 
	sbåfs_dú_li°
 {

5330 
u64
 
	möo
;

5331 
li°_hód
 
	mli°
;

5370 
	$log_√w_dú_díåõs
(
båfs_å™s_h™dÀ
 *
å™s
,

5371 
båfs_öode
 *
°¨t_öode
,

5372 
båfs_log_˘x
 *
˘x
)

5374 
båfs_roŸ
 *
roŸ
 = 
°¨t_öode
->root;

5375 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

5376 
båfs_∑th
 *
∑th
;

5377 
	`LIST_HEAD
(
dú_li°
);

5378 
båfs_dú_li°
 *
dú_ñem
;

5379 
u64
 
öo
 = 
	`båfs_öo
(
°¨t_öode
);

5380 
båfs_öode
 *
cuº_öode
 = 
°¨t_öode
;

5381 
ªt
 = 0;

5388 i‡(
˘x
->
loggög_√w_«me
)

5391 
∑th
 = 
	`båfs_Æloc_∑th
();

5392 i‡(!
∑th
)

5393  -
ENOMEM
;

5396 
	`ihﬁd
(&
cuº_öode
->
vfs_öode
);

5398 
åue
) {

5399 
öode
 *
vfs_öode
;

5400 
båfs_key
 
key
;

5401 
båfs_key
 
found_key
;

5402 
u64
 
√xt_ödex
;

5403 
boﬁ
 
c⁄töue_cuº_öode
 = 
åue
;

5404 
ôî_ªt
;

5406 
key
.
obje˘id
 = 
öo
;

5407 
key
.
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

5408 
key
.
off£t
 = 
	`båfs_gë_fú°_dú_ödex_to_log
(
cuº_öode
);

5409 
√xt_ödex
 = 
key
.
off£t
;

5410 
agaö
:

5411 
	`båfs_f‹_óch_¶Ÿ
(
roŸ
->
log_roŸ
, &
key
, &
found_key
, 
∑th
, 
ôî_ªt
) {

5412 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

5413 
båfs_dú_ôem
 *
di
;

5414 
båfs_key
 
di_key
;

5415 
öode
 *
di_öode
;

5416 
log_mode
 = 
LOG_INODE_EXISTS
;

5417 
ty≥
;

5419 i‡(
found_key
.
obje˘id
 !
öo
 ||

5420 
found_key
.
ty≥
 !
BTRFS_DIR_INDEX_KEY
) {

5421 
c⁄töue_cuº_öode
 = 
Ál£
;

5425 
√xt_ödex
 = 
found_key
.
off£t
 + 1;

5427 
di
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_dú_ôem
);

5428 
ty≥
 = 
	`båfs_dú_·y≥
(
Àaf
, 
di
);

5429 i‡(
	`båfs_dú_å™sid
(
Àaf
, 
di
Ë< 
å™s
->
å™sid
)

5431 
	`båfs_dú_ôem_key_to_˝u
(
Àaf
, 
di
, &
di_key
);

5432 i‡(
di_key
.
ty≥
 =
BTRFS_ROOT_ITEM_KEY
)

5435 
	`båfs_ªÀa£_∑th
(
∑th
);

5436 
di_öode
 = 
	`båfs_igë
(
fs_öfo
->
sb
, 
di_key
.
obje˘id
, 
roŸ
);

5437 i‡(
	`IS_ERR
(
di_öode
)) {

5438 
ªt
 = 
	`PTR_ERR
(
di_öode
);

5439 
out
;

5442 i‡(!
	`√ed_log_öode
(
å™s
, 
	`BTRFS_I
(
di_öode
))) {

5443 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
di_öode
));

5447 
˘x
->
log_√w_díåõs
 = 
Ál£
;

5448 i‡(
ty≥
 =
BTRFS_FT_DIR
)

5449 
log_mode
 = 
LOG_INODE_ALL
;

5450 
ªt
 = 
	`båfs_log_öode
(
å™s
, 
	`BTRFS_I
(
di_öode
),

5451 
log_mode
, 
˘x
);

5452 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
di_öode
));

5453 i‡(
ªt
)

5454 
out
;

5455 i‡(
˘x
->
log_√w_díåõs
) {

5456 
dú_ñem
 = 
	`kmÆloc
((*dú_ñem), 
GFP_NOFS
);

5457 i‡(!
dú_ñem
) {

5458 
ªt
 = -
ENOMEM
;

5459 
out
;

5461 
dú_ñem
->
öo
 = 
di_key
.
obje˘id
;

5462 
	`li°_add_èû
(&
dú_ñem
->
li°
, &
dú_li°
);

5467 
	`båfs_ªÀa£_∑th
(
∑th
);

5469 i‡(
ôî_ªt
 < 0) {

5470 
ªt
 = 
ôî_ªt
;

5471 
out
;

5472 } i‡(
ôî_ªt
 > 0) {

5473 
c⁄töue_cuº_öode
 = 
Ál£
;

5475 
key
 = 
found_key
;

5478 i‡(
c⁄töue_cuº_öode
 && 
key
.
off£t
 < (
u64
)-1) {

5479 
key
.
off£t
++;

5480 
agaö
;

5483 
	`båfs_£t_fú°_dú_ödex_to_log
(
cuº_öode
, 
√xt_ödex
);

5485 i‡(
	`li°_em±y
(&
dú_li°
))

5488 
dú_ñem
 = 
	`li°_fú°_íåy
(&
dú_li°
, 
båfs_dú_li°
, 
li°
);

5489 
öo
 = 
dú_ñem
->ino;

5490 
	`li°_dñ
(&
dú_ñem
->
li°
);

5491 
	`k‰ì
(
dú_ñem
);

5493 
	`båfs_add_dñayed_ùut
(
cuº_öode
);

5494 
cuº_öode
 = 
NULL
;

5496 
vfs_öode
 = 
	`båfs_igë
(
fs_öfo
->
sb
, 
öo
, 
roŸ
);

5497 i‡(
	`IS_ERR
(
vfs_öode
)) {

5498 
ªt
 = 
	`PTR_ERR
(
vfs_öode
);

5501 
cuº_öode
 = 
	`BTRFS_I
(
vfs_öode
);

5503 
out
:

5504 
	`båfs_‰ì_∑th
(
∑th
);

5505 i‡(
cuº_öode
)

5506 
	`båfs_add_dñayed_ùut
(
cuº_öode
);

5508 i‡(
ªt
) {

5509 
båfs_dú_li°
 *
√xt
;

5511 
	`li°_f‹_óch_íåy_ß„
(
dú_ñem
, 
√xt
, &
dú_li°
, 
li°
)

5512 
	`k‰ì
(
dú_ñem
);

5515  
ªt
;

5516 
	}
}

5518 
	sbåfs_öo_li°
 {

5519 
u64
 
	möo
;

5520 
u64
 
	m∑ª¡
;

5521 
li°_hód
 
	mli°
;

5524 
	$‰ì_c⁄Êi˘ög_öodes
(
båfs_log_˘x
 *
˘x
)

5526 
båfs_öo_li°
 *
cuº
;

5527 
båfs_öo_li°
 *
√xt
;

5529 
	`li°_f‹_óch_íåy_ß„
(
cuº
, 
√xt
, &
˘x
->
c⁄Êi˘_öodes
, 
li°
) {

5530 
	`li°_dñ
(&
cuº
->
li°
);

5531 
	`k‰ì
(
cuº
);

5533 
	}
}

5535 
	$c⁄Êi˘ög_öode_is_dú
(
båfs_roŸ
 *
roŸ
, 
u64
 
öo
,

5536 
båfs_∑th
 *
∑th
)

5538 
båfs_key
 
key
;

5539 
ªt
;

5541 
key
.
obje˘id
 = 
öo
;

5542 
key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

5543 
key
.
off£t
 = 0;

5545 
∑th
->
£¨ch_commô_roŸ
 = 1;

5546 
∑th
->
skù_lockög
 = 1;

5548 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

5549 i‡(
	`WARN_ON_ONCE
(
ªt
 > 0)) {

5555 
ªt
 = -
ENOENT
;

5556 } i‡(
ªt
 == 0) {

5557 
båfs_öode_ôem
 *
ôem
;

5559 
ôem
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0],

5560 
båfs_öode_ôem
);

5561 i‡(
	`S_ISDIR
(
	`båfs_öode_mode
(
∑th
->
nodes
[0], 
ôem
)))

5562 
ªt
 = 1;

5565 
	`båfs_ªÀa£_∑th
(
∑th
);

5566 
∑th
->
£¨ch_commô_roŸ
 = 0;

5567 
∑th
->
skù_lockög
 = 0;

5569  
ªt
;

5570 
	}
}

5572 
	$add_c⁄Êi˘ög_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

5573 
båfs_roŸ
 *
roŸ
,

5574 
båfs_∑th
 *
∑th
,

5575 
u64
 
öo
, u64 
∑ª¡
,

5576 
båfs_log_˘x
 *
˘x
)

5578 
båfs_öo_li°
 *
öo_ñem
;

5579 
öode
 *inode;

5588 i‡(
˘x
->
num_c⁄Êi˘_öodes
 >
MAX_CONFLICT_INODES
)

5589  
BTRFS_LOG_FORCE_COMMIT
;

5591 
öode
 = 
	`båfs_igë
(
roŸ
->
fs_öfo
->
sb
, 
öo
,Ñoot);

5612 i‡(
	`IS_ERR
(
öode
)) {

5613 
ªt
 = 
	`PTR_ERR
(
öode
);

5615 i‡(
ªt
 !-
ENOENT
)

5616  
ªt
;

5618 
ªt
 = 
	`c⁄Êi˘ög_öode_is_dú
(
roŸ
, 
öo
, 
∑th
);

5620 i‡(
ªt
 <= 0)

5621  
ªt
;

5624 
öo_ñem
 = 
	`kmÆloc
((*öo_ñem), 
GFP_NOFS
);

5625 i‡(!
öo_ñem
)

5626  -
ENOMEM
;

5627 
öo_ñem
->
öo
 = ino;

5628 
öo_ñem
->
∑ª¡
 =Öarent;

5629 
	`li°_add_èû
(&
öo_ñem
->
li°
, &
˘x
->
c⁄Êi˘_öodes
);

5630 
˘x
->
num_c⁄Êi˘_öodes
++;

5670 i‡(!
	`√ed_log_öode
(
å™s
, 
	`BTRFS_I
(
öode
))) {

5671 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
öode
));

5675 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
öode
));

5677 
öo_ñem
 = 
	`kmÆloc
((*öo_ñem), 
GFP_NOFS
);

5678 i‡(!
öo_ñem
)

5679  -
ENOMEM
;

5680 
öo_ñem
->
öo
 = ino;

5681 
öo_ñem
->
∑ª¡
 =Öarent;

5682 
	`li°_add_èû
(&
öo_ñem
->
li°
, &
˘x
->
c⁄Êi˘_öodes
);

5683 
˘x
->
num_c⁄Êi˘_öodes
++;

5686 
	}
}

5688 
	$log_c⁄Êi˘ög_öodes
(
båfs_å™s_h™dÀ
 *
å™s
,

5689 
båfs_roŸ
 *
roŸ
,

5690 
båfs_log_˘x
 *
˘x
)

5692 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

5693 
ªt
 = 0;

5700 i‡(
˘x
->
loggög_c⁄Êi˘_öodes
)

5703 
˘x
->
loggög_c⁄Êi˘_öodes
 = 
åue
;

5710 !
	`li°_em±y
(&
˘x
->
c⁄Êi˘_öodes
)) {

5711 
båfs_öo_li°
 *
cuº
;

5712 
öode
 *inode;

5713 
u64
 
öo
;

5714 
u64
 
∑ª¡
;

5716 
cuº
 = 
	`li°_fú°_íåy
(&
˘x
->
c⁄Êi˘_öodes
,

5717 
båfs_öo_li°
, 
li°
);

5718 
öo
 = 
cuº
->ino;

5719 
∑ª¡
 = 
cuº
->parent;

5720 
	`li°_dñ
(&
cuº
->
li°
);

5721 
	`k‰ì
(
cuº
);

5723 
öode
 = 
	`båfs_igë
(
fs_öfo
->
sb
, 
öo
, 
roŸ
);

5729 i‡(
	`IS_ERR
(
öode
)) {

5730 
ªt
 = 
	`PTR_ERR
(
öode
);

5731 i‡(
ªt
 !-
ENOENT
)

5734 
öode
 = 
	`båfs_igë
(
fs_öfo
->
sb
, 
∑ª¡
, 
roŸ
);

5735 i‡(
	`IS_ERR
(
öode
)) {

5736 
ªt
 = 
	`PTR_ERR
(
öode
);

5748 
ªt
 = 
	`båfs_log_öode
(
å™s
, 
	`BTRFS_I
(
öode
),

5749 
LOG_INODE_ALL
, 
˘x
);

5750 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
öode
));

5751 i‡(
ªt
)

5766 i‡(!
	`√ed_log_öode
(
å™s
, 
	`BTRFS_I
(
öode
))) {

5767 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
öode
));

5778 
ªt
 = 
	`båfs_log_öode
(
å™s
, 
	`BTRFS_I
(
öode
), 
LOG_INODE_EXISTS
, 
˘x
);

5779 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
öode
));

5780 i‡(
ªt
)

5784 
˘x
->
loggög_c⁄Êi˘_öodes
 = 
Ál£
;

5785 i‡(
ªt
)

5786 
	`‰ì_c⁄Êi˘ög_öodes
(
˘x
);

5788  
ªt
;

5789 
	}
}

5791 
	$c›y_öode_ôems_to_log
(
båfs_å™s_h™dÀ
 *
å™s
,

5792 
båfs_öode
 *
öode
,

5793 
båfs_key
 *
mö_key
,

5794 c⁄° 
båfs_key
 *
max_key
,

5795 
båfs_∑th
 *
∑th
,

5796 
båfs_∑th
 *
d°_∑th
,

5797 c⁄° 
u64
 
logged_isize
,

5798 c⁄° 
öode_⁄ly
,

5799 
båfs_log_˘x
 *
˘x
,

5800 
boﬁ
 *
√ed_log_öode_ôem
)

5802 c⁄° 
u64
 
i_size
 = 
	`i_size_ªad
(&
öode
->
vfs_öode
);

5803 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

5804 
ös_°¨t_¶Ÿ
 = 0;

5805 
ös_ƒ
 = 0;

5806 
ªt
;

5809 
ªt
 = 
	`båfs_£¨ch_f‹w¨d
(
roŸ
, 
mö_key
, 
∑th
, 
å™s
->
å™sid
);

5810 i‡(
ªt
 < 0)

5811  
ªt
;

5812 i‡(
ªt
 > 0) {

5813 
ªt
 = 0;

5816 
agaö
:

5818 i‡(
mö_key
->
obje˘id
 !
max_key
->objectid)

5820 i‡(
mö_key
->
ty≥
 > 
max_key
->type)

5823 i‡(
mö_key
->
ty≥
 =
BTRFS_INODE_ITEM_KEY
) {

5824 *
√ed_log_öode_ôem
 = 
Ál£
;

5825 } i‡(
mö_key
->
ty≥
 =
BTRFS_EXTENT_DATA_KEY
 &&

5826 
mö_key
->
off£t
 >
i_size
) {

5834 } i‡((
mö_key
->
ty≥
 =
BTRFS_INODE_REF_KEY
 ||

5835 
mö_key
->
ty≥
 =
BTRFS_INODE_EXTREF_KEY
) &&

5836 (
öode
->
gíî©i⁄
 =
å™s
->
å™sid
 ||

5837 
˘x
->
loggög_c⁄Êi˘_öodes
)) {

5838 
u64
 
Ÿhî_öo
 = 0;

5839 
u64
 
Ÿhî_∑ª¡
 = 0;

5841 
ªt
 = 
	`båfs_check_ªf_«me_ovîride
(
∑th
->
nodes
[0],

5842 
∑th
->
¶Ÿs
[0], 
mö_key
, 
öode
,

5843 &
Ÿhî_öo
, &
Ÿhî_∑ª¡
);

5844 i‡(
ªt
 < 0) {

5845  
ªt
;

5846 } i‡(
ªt
 > 0 &&

5847 
Ÿhî_öo
 !
	`båfs_öo
(
	`BTRFS_I
(
˘x
->
öode
))) {

5848 i‡(
ös_ƒ
 > 0) {

5849 
ös_ƒ
++;

5851 
ös_ƒ
 = 1;

5852 
ös_°¨t_¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

5854 
ªt
 = 
	`c›y_ôems
(
å™s
, 
öode
, 
d°_∑th
, 
∑th
,

5855 
ös_°¨t_¶Ÿ
, 
ös_ƒ
,

5856 
öode_⁄ly
, 
logged_isize
);

5857 i‡(
ªt
 < 0)

5858  
ªt
;

5859 
ös_ƒ
 = 0;

5861 
	`båfs_ªÀa£_∑th
(
∑th
);

5862 
ªt
 = 
	`add_c⁄Êi˘ög_öode
(
å™s
, 
roŸ
, 
∑th
,

5863 
Ÿhî_öo
,

5864 
Ÿhî_∑ª¡
, 
˘x
);

5865 i‡(
ªt
)

5866  
ªt
;

5867 
√xt_key
;

5869 } i‡(
mö_key
->
ty≥
 =
BTRFS_XATTR_ITEM_KEY
) {

5871 i‡(
ös_ƒ
 == 0)

5872 
√xt_¶Ÿ
;

5873 
ªt
 = 
	`c›y_ôems
(
å™s
, 
öode
, 
d°_∑th
, 
∑th
,

5874 
ös_°¨t_¶Ÿ
,

5875 
ös_ƒ
, 
öode_⁄ly
, 
logged_isize
);

5876 i‡(
ªt
 < 0)

5877  
ªt
;

5878 
ös_ƒ
 = 0;

5879 
√xt_¶Ÿ
;

5882 i‡(
ös_ƒ
 && 
ös_°¨t_¶Ÿ
 + ins_ƒ =
∑th
->
¶Ÿs
[0]) {

5883 
ös_ƒ
++;

5884 
√xt_¶Ÿ
;

5885 } i‡(!
ös_ƒ
) {

5886 
ös_°¨t_¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

5887 
ös_ƒ
 = 1;

5888 
√xt_¶Ÿ
;

5891 
ªt
 = 
	`c›y_ôems
(
å™s
, 
öode
, 
d°_∑th
, 
∑th
, 
ös_°¨t_¶Ÿ
,

5892 
ös_ƒ
, 
öode_⁄ly
, 
logged_isize
);

5893 i‡(
ªt
 < 0)

5894  
ªt
;

5895 
ös_ƒ
 = 1;

5896 
ös_°¨t_¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

5897 
√xt_¶Ÿ
:

5898 
∑th
->
¶Ÿs
[0]++;

5899 i‡(
∑th
->
¶Ÿs
[0] < 
	`båfs_hódî_ƒôems
’©h->
nodes
[0])) {

5900 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], 
mö_key
,

5901 
∑th
->
¶Ÿs
[0]);

5902 
agaö
;

5904 i‡(
ös_ƒ
) {

5905 
ªt
 = 
	`c›y_ôems
(
å™s
, 
öode
, 
d°_∑th
, 
∑th
,

5906 
ös_°¨t_¶Ÿ
, 
ös_ƒ
, 
öode_⁄ly
,

5907 
logged_isize
);

5908 i‡(
ªt
 < 0)

5909  
ªt
;

5910 
ös_ƒ
 = 0;

5912 
	`båfs_ªÀa£_∑th
(
∑th
);

5913 
√xt_key
:

5914 i‡(
mö_key
->
off£t
 < (
u64
)-1) {

5915 
mö_key
->
off£t
++;

5916 } i‡(
mö_key
->
ty≥
 < 
max_key
->type) {

5917 
mö_key
->
ty≥
++;

5918 
mö_key
->
off£t
 = 0;

5928 
	`c⁄d_ªsched
();

5930 i‡(
ös_ƒ
) {

5931 
ªt
 = 
	`c›y_ôems
(
å™s
, 
öode
, 
d°_∑th
, 
∑th
, 
ös_°¨t_¶Ÿ
,

5932 
ös_ƒ
, 
öode_⁄ly
, 
logged_isize
);

5933 i‡(
ªt
)

5934  
ªt
;

5937 i‡(
öode_⁄ly
 =
LOG_INODE_ALL
 && 
	`S_ISREG
(
öode
->
vfs_öode
.
i_mode
)) {

5942 
	`båfs_ªÀa£_∑th
(
∑th
);

5943 
ªt
 = 
	`båfs_log_¥óŒoc_exã¡s
(
å™s
, 
öode
, 
d°_∑th
);

5946  
ªt
;

5947 
	}
}

5949 
	$ö£π_dñayed_ôems_b©ch
(
båfs_å™s_h™dÀ
 *
å™s
,

5950 
båfs_roŸ
 *
log
,

5951 
båfs_∑th
 *
∑th
,

5952 c⁄° 
båfs_ôem_b©ch
 *
b©ch
,

5953 c⁄° 
båfs_dñayed_ôem
 *
fú°_ôem
)

5955 c⁄° 
båfs_dñayed_ôem
 *
cuº
 = 
fú°_ôem
;

5956 
ªt
;

5958 
ªt
 = 
	`båfs_ö£π_em±y_ôems
(
å™s
, 
log
, 
∑th
, 
b©ch
);

5959 i‡(
ªt
)

5960  
ªt
;

5962 
i
 = 0; i < 
b©ch
->
ƒ
; i++) {

5963 *
d©a_±r
;

5965 
d©a_±r
 = 
	`båfs_ôem_±r
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0], );

5966 
	`wrôe_exã¡_buf„r
(
∑th
->
nodes
[0], &
cuº
->
d©a
,

5967 ()
d©a_±r
, 
cuº
->
d©a_Àn
);

5968 
cuº
 = 
	`li°_√xt_íåy
(cuº, 
log_li°
);

5969 
∑th
->
¶Ÿs
[0]++;

5972 
	`båfs_ªÀa£_∑th
(
∑th
);

5975 
	}
}

5977 
	$log_dñayed_ö£πi⁄_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

5978 
båfs_öode
 *
öode
,

5979 
båfs_∑th
 *
∑th
,

5980 c⁄° 
li°_hód
 *
dñayed_ös_li°
,

5981 
båfs_log_˘x
 *
˘x
)

5984 c⁄° 
max_b©ch_size
 = 195;

5985 c⁄° 
Àaf_d©a_size
 = 
	`BTRFS_LEAF_DATA_SIZE
(
å™s
->
fs_öfo
);

5986 c⁄° 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

5987 
båfs_roŸ
 *
log
 = 
öode
->
roŸ
->
log_roŸ
;

5988 
båfs_ôem_b©ch
 
b©ch
 = {

5989 .
ƒ
 = 0,

5990 .
tŸÆ_d©a_size
 = 0,

5992 c⁄° 
båfs_dñayed_ôem
 *
fú°
 = 
NULL
;

5993 c⁄° 
båfs_dñayed_ôem
 *
cuº
;

5994 *
ös_d©a
;

5995 
båfs_key
 *
ös_keys
;

5996 
u32
 *
ös_sizes
;

5997 
u64
 
cuº_b©ch_size
 = 0;

5998 
b©ch_idx
 = 0;

5999 
ªt
;

6002 
	`lockdï_as£π_hñd
(&
öode
->
log_muãx
);

6012 
	`li°_f‹_óch_íåy
(
cuº
, 
dñayed_ös_li°
, 
log_li°
) {

6013 i‡(
cuº
->
ödex
 > 
öode
->
œ°_dú_ödex_off£t
) {

6014 
fú°
 = 
cuº
;

6020 i‡(!
fú°
)

6023 
ös_d©a
 = 
	`kmÆloc
(
max_b©ch_size
 * (
u32
) +

6024 
max_b©ch_size
 * (
båfs_key
), 
GFP_NOFS
);

6025 i‡(!
ös_d©a
)

6026  -
ENOMEM
;

6027 
ös_sizes
 = (
u32
 *)
ös_d©a
;

6028 
b©ch
.
d©a_sizes
 = 
ös_sizes
;

6029 
ös_keys
 = (
båfs_key
 *)(
ös_d©a
 + 
max_b©ch_size
 * (
u32
));

6030 
b©ch
.
keys
 = 
ös_keys
;

6032 
cuº
 = 
fú°
;

6033 !
	`li°_íåy_is_hód
(
cuº
, 
dñayed_ös_li°
, 
log_li°
)) {

6034 c⁄° 
u32
 
cuº_size
 = 
cuº
->
d©a_Àn
 + (
båfs_ôem
);

6036 i‡(
cuº_b©ch_size
 + 
cuº_size
 > 
Àaf_d©a_size
 ||

6037 
b©ch
.
ƒ
 =
max_b©ch_size
) {

6038 
ªt
 = 
	`ö£π_dñayed_ôems_b©ch
(
å™s
, 
log
, 
∑th
,

6039 &
b©ch
, 
fú°
);

6040 i‡(
ªt
)

6041 
out
;

6042 
b©ch_idx
 = 0;

6043 
b©ch
.
ƒ
 = 0;

6044 
b©ch
.
tŸÆ_d©a_size
 = 0;

6045 
cuº_b©ch_size
 = 0;

6046 
fú°
 = 
cuº
;

6049 
ös_sizes
[
b©ch_idx
] = 
cuº
->
d©a_Àn
;

6050 
ös_keys
[
b©ch_idx
].
obje˘id
 = 
öo
;

6051 
ös_keys
[
b©ch_idx
].
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

6052 
ös_keys
[
b©ch_idx
].
off£t
 = 
cuº
->
ödex
;

6053 
cuº_b©ch_size
 +
cuº_size
;

6054 
b©ch
.
tŸÆ_d©a_size
 +
cuº
->
d©a_Àn
;

6055 
b©ch
.
ƒ
++;

6056 
b©ch_idx
++;

6057 
cuº
 = 
	`li°_√xt_íåy
(cuº, 
log_li°
);

6060 
	`ASSERT
(
b©ch
.
ƒ
 >= 1);

6061 
ªt
 = 
	`ö£π_dñayed_ôems_b©ch
(
å™s
, 
log
, 
∑th
, &
b©ch
, 
fú°
);

6063 
cuº
 = 
	`li°_œ°_íåy
(
dñayed_ös_li°
, 
båfs_dñayed_ôem
,

6064 
log_li°
);

6065 
öode
->
œ°_dú_ödex_off£t
 = 
cuº
->
ödex
;

6066 
out
:

6067 
	`k‰ì
(
ös_d©a
);

6069  
ªt
;

6070 
	}
}

6072 
	$log_dñayed_dñëi⁄s_fuŒ
(
båfs_å™s_h™dÀ
 *
å™s
,

6073 
båfs_öode
 *
öode
,

6074 
båfs_∑th
 *
∑th
,

6075 c⁄° 
li°_hód
 *
dñayed_dñ_li°
,

6076 
båfs_log_˘x
 *
˘x
)

6078 c⁄° 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

6079 c⁄° 
båfs_dñayed_ôem
 *
cuº
;

6081 
cuº
 = 
	`li°_fú°_íåy
(
dñayed_dñ_li°
, 
båfs_dñayed_ôem
,

6082 
log_li°
);

6084 !
	`li°_íåy_is_hód
(
cuº
, 
dñayed_dñ_li°
, 
log_li°
)) {

6085 
u64
 
fú°_dú_ödex
 = 
cuº
->
ödex
;

6086 
u64
 
œ°_dú_ödex
;

6087 c⁄° 
båfs_dñayed_ôem
 *
√xt
;

6088 
ªt
;

6095 
√xt
 = 
	`li°_√xt_íåy
(
cuº
, 
log_li°
);

6096 !
	`li°_íåy_is_hód
(
√xt
, 
dñayed_dñ_li°
, 
log_li°
)) {

6097 i‡(
√xt
->
ödex
 !
cuº
->index + 1)

6099 
cuº
 = 
√xt
;

6100 
√xt
 = 
	`li°_√xt_íåy
“ext, 
log_li°
);

6103 
œ°_dú_ödex
 = 
cuº
->
ödex
;

6104 
	`ASSERT
(
œ°_dú_ödex
 >
fú°_dú_ödex
);

6106 
ªt
 = 
	`ö£π_dú_log_key
(
å™s
, 
öode
->
roŸ
->
log_roŸ
, 
∑th
,

6107 
öo
, 
fú°_dú_ödex
, 
œ°_dú_ödex
);

6108 i‡(
ªt
)

6109  
ªt
;

6110 
cuº
 = 
	`li°_√xt_íåy
(cuº, 
log_li°
);

6114 
	}
}

6116 
	$b©ch_dñëe_dú_ödex_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

6117 
båfs_öode
 *
öode
,

6118 
båfs_∑th
 *
∑th
,

6119 
båfs_log_˘x
 *
˘x
,

6120 c⁄° 
li°_hód
 *
dñayed_dñ_li°
,

6121 c⁄° 
båfs_dñayed_ôem
 *
fú°
,

6122 c⁄° 
båfs_dñayed_ôem
 **
œ°_ªt
)

6124 c⁄° 
båfs_dñayed_ôem
 *
√xt
;

6125 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

6126 c⁄° 
œ°_¶Ÿ
 = 
	`båfs_hódî_ƒôems
(
Àaf
) - 1;

6127 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0] + 1;

6128 c⁄° 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

6130 
√xt
 = 
	`li°_√xt_íåy
(
fú°
, 
log_li°
);

6132 
¶Ÿ
 < 
œ°_¶Ÿ
 &&

6133 !
	`li°_íåy_is_hód
(
√xt
, 
dñayed_dñ_li°
, 
log_li°
)) {

6134 
båfs_key
 
key
;

6136 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

6137 i‡(
key
.
obje˘id
 !
öo
 ||

6138 
key
.
ty≥
 !
BTRFS_DIR_INDEX_KEY
 ||

6139 
key
.
off£t
 !
√xt
->
ödex
)

6142 
¶Ÿ
++;

6143 *
œ°_ªt
 = 
√xt
;

6144 
√xt
 = 
	`li°_√xt_íåy
“ext, 
log_li°
);

6147  
	`båfs_dñ_ôems
(
å™s
, 
öode
->
roŸ
->
log_roŸ
, 
∑th
,

6148 
∑th
->
¶Ÿs
[0], 
¶Ÿ
 -Öath->slots[0]);

6149 
	}
}

6151 
	$log_dñayed_dñëi⁄s_ö¸emíèl
(
båfs_å™s_h™dÀ
 *
å™s
,

6152 
båfs_öode
 *
öode
,

6153 
båfs_∑th
 *
∑th
,

6154 c⁄° 
li°_hód
 *
dñayed_dñ_li°
,

6155 
båfs_log_˘x
 *
˘x
)

6157 
båfs_roŸ
 *
log
 = 
öode
->
roŸ
->
log_roŸ
;

6158 c⁄° 
båfs_dñayed_ôem
 *
cuº
;

6159 
u64
 
œ°_ønge_°¨t
 = 0;

6160 
u64
 
œ°_ønge_íd
 = 0;

6161 
båfs_key
 
key
;

6163 
key
.
obje˘id
 = 
	`båfs_öo
(
öode
);

6164 
key
.
ty≥
 = 
BTRFS_DIR_INDEX_KEY
;

6165 
cuº
 = 
	`li°_fú°_íåy
(
dñayed_dñ_li°
, 
båfs_dñayed_ôem
,

6166 
log_li°
);

6168 !
	`li°_íåy_is_hód
(
cuº
, 
dñayed_dñ_li°
, 
log_li°
)) {

6169 c⁄° 
båfs_dñayed_ôem
 *
œ°
 = 
cuº
;

6170 
u64
 
fú°_dú_ödex
 = 
cuº
->
ödex
;

6171 
u64
 
œ°_dú_ödex
;

6172 
boﬁ
 
dñëed_ôems
 = 
Ál£
;

6173 
ªt
;

6175 
key
.
off£t
 = 
cuº
->
ödex
;

6176 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
log
, &
key
, 
∑th
, -1, 1);

6177 i‡(
ªt
 < 0) {

6178  
ªt
;

6179 } i‡(
ªt
 == 0) {

6180 
ªt
 = 
	`b©ch_dñëe_dú_ödex_ôems
(
å™s
, 
öode
, 
∑th
, 
˘x
,

6181 
dñayed_dñ_li°
, 
cuº
,

6182 &
œ°
);

6183 i‡(
ªt
)

6184  
ªt
;

6185 
dñëed_ôems
 = 
åue
;

6188 
	`båfs_ªÀa£_∑th
(
∑th
);

6195 i‡(
dñëed_ôems
)

6196 
√xt_b©ch
;

6198 
œ°_dú_ödex
 = 
œ°
->
ödex
;

6199 
	`ASSERT
(
œ°_dú_ödex
 >
fú°_dú_ödex
);

6206 i‡(
œ°_ønge_íd
 !0 && 
fú°_dú_ödex
 ==Üast_range_end + 1)

6207 
fú°_dú_ödex
 = 
œ°_ønge_°¨t
;

6209 
ªt
 = 
	`ö£π_dú_log_key
(
å™s
, 
log
, 
∑th
, 
key
.
obje˘id
,

6210 
fú°_dú_ödex
, 
œ°_dú_ödex
);

6211 i‡(
ªt
)

6212  
ªt
;

6214 
œ°_ønge_°¨t
 = 
fú°_dú_ödex
;

6215 
œ°_ønge_íd
 = 
œ°_dú_ödex
;

6216 
√xt_b©ch
:

6217 
cuº
 = 
	`li°_√xt_íåy
(
œ°
, 
log_li°
);

6221 
	}
}

6223 
	$log_dñayed_dñëi⁄_ôems
(
båfs_å™s_h™dÀ
 *
å™s
,

6224 
båfs_öode
 *
öode
,

6225 
båfs_∑th
 *
∑th
,

6226 c⁄° 
li°_hód
 *
dñayed_dñ_li°
,

6227 
båfs_log_˘x
 *
˘x
)

6233 
	`lockdï_as£π_hñd
(&
öode
->
log_muãx
);

6235 i‡(
	`li°_em±y
(
dñayed_dñ_li°
))

6238 i‡(
˘x
->
logged_bef‹e
)

6239  
	`log_dñayed_dñëi⁄s_ö¸emíèl
(
å™s
, 
öode
, 
∑th
,

6240 
dñayed_dñ_li°
, 
˘x
);

6242  
	`log_dñayed_dñëi⁄s_fuŒ
(
å™s
, 
öode
, 
∑th
, 
dñayed_dñ_li°
,

6243 
˘x
);

6244 
	}
}

6250 
	$log_√w_dñayed_díåõs
(
båfs_å™s_h™dÀ
 *
å™s
,

6251 
båfs_öode
 *
öode
,

6252 c⁄° 
li°_hód
 *
dñayed_ös_li°
,

6253 
båfs_log_˘x
 *
˘x
)

6255 c⁄° 
boﬁ
 
‹ig_log_√w_díåõs
 = 
˘x
->
log_√w_díåõs
;

6256 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

6257 
båfs_dñayed_ôem
 *
ôem
;

6258 
ªt
 = 0;

6265 
	`lockdï_as£π_nŸ_hñd
(&
öode
->
log_muãx
);

6267 
	`ASSERT
(!
˘x
->
loggög_√w_dñayed_díåõs
);

6268 
˘x
->
loggög_√w_dñayed_díåõs
 = 
åue
;

6270 
	`li°_f‹_óch_íåy
(
ôem
, 
dñayed_ös_li°
, 
log_li°
) {

6271 
båfs_dú_ôem
 *
dú_ôem
;

6272 
öode
 *
di_öode
;

6273 
båfs_key
 
key
;

6274 
log_mode
 = 
LOG_INODE_EXISTS
;

6276 
dú_ôem
 = (
båfs_dú_ôem
 *)
ôem
->
d©a
;

6277 
	`båfs_disk_key_to_˝u
(&
key
, &
dú_ôem
->
loˇti⁄
);

6279 i‡(
key
.
ty≥
 =
BTRFS_ROOT_ITEM_KEY
)

6282 
di_öode
 = 
	`båfs_igë
(
fs_öfo
->
sb
, 
key
.
obje˘id
, 
öode
->
roŸ
);

6283 i‡(
	`IS_ERR
(
di_öode
)) {

6284 
ªt
 = 
	`PTR_ERR
(
di_öode
);

6288 i‡(!
	`√ed_log_öode
(
å™s
, 
	`BTRFS_I
(
di_öode
))) {

6289 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
di_öode
));

6293 i‡(
	`båfs_°ack_dú_·y≥
(
dú_ôem
Ë=
BTRFS_FT_DIR
)

6294 
log_mode
 = 
LOG_INODE_ALL
;

6296 
˘x
->
log_√w_díåõs
 = 
Ál£
;

6297 
ªt
 = 
	`båfs_log_öode
(
å™s
, 
	`BTRFS_I
(
di_öode
), 
log_mode
, 
˘x
);

6299 i‡(!
ªt
 && 
˘x
->
log_√w_díåõs
)

6300 
ªt
 = 
	`log_√w_dú_díåõs
(
å™s
, 
	`BTRFS_I
(
di_öode
), 
˘x
);

6302 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
di_öode
));

6304 i‡(
ªt
)

6308 
˘x
->
log_√w_díåõs
 = 
‹ig_log_√w_díåõs
;

6309 
˘x
->
loggög_√w_dñayed_díåõs
 = 
Ál£
;

6311  
ªt
;

6312 
	}
}

6328 
	$båfs_log_öode
(
båfs_å™s_h™dÀ
 *
å™s
,

6329 
båfs_öode
 *
öode
,

6330 
öode_⁄ly
,

6331 
båfs_log_˘x
 *
˘x
)

6333 
båfs_∑th
 *
∑th
;

6334 
båfs_∑th
 *
d°_∑th
;

6335 
båfs_key
 
mö_key
;

6336 
båfs_key
 
max_key
;

6337 
båfs_roŸ
 *
log
 = 
öode
->
roŸ
->
log_roŸ
;

6338 
ªt
;

6339 
boﬁ
 
Á°_£¨ch
 = 
Ál£
;

6340 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

6341 
exã¡_m≠_åì
 *
em_åì
 = &
öode
->
exã¡_åì
;

6342 
u64
 
logged_isize
 = 0;

6343 
boﬁ
 
√ed_log_öode_ôem
 = 
åue
;

6344 
boﬁ
 
x©ås_logged
 = 
Ál£
;

6345 
boﬁ
 
öode_ôem_dr›≥d
 = 
åue
;

6346 
boﬁ
 
fuŒ_dú_loggög
 = 
Ál£
;

6347 
	`LIST_HEAD
(
dñayed_ös_li°
);

6348 
	`LIST_HEAD
(
dñayed_dñ_li°
);

6350 
∑th
 = 
	`båfs_Æloc_∑th
();

6351 i‡(!
∑th
)

6352  -
ENOMEM
;

6353 
d°_∑th
 = 
	`båfs_Æloc_∑th
();

6354 i‡(!
d°_∑th
) {

6355 
	`båfs_‰ì_∑th
(
∑th
);

6356  -
ENOMEM
;

6359 
mö_key
.
obje˘id
 = 
öo
;

6360 
mö_key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

6361 
mö_key
.
off£t
 = 0;

6363 
max_key
.
obje˘id
 = 
öo
;

6367 i‡(
	`S_ISDIR
(
öode
->
vfs_öode
.
i_mode
) ||

6368 (!
	`ã°_bô
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

6369 &
öode
->
ru¡ime_Êags
) &&

6370 
öode_⁄ly
 >
LOG_INODE_EXISTS
))

6371 
max_key
.
ty≥
 = 
BTRFS_XATTR_ITEM_KEY
;

6373 
max_key
.
ty≥
 = (
u8
)-1;

6374 
max_key
.
off£t
 = (
u64
)-1;

6376 i‡(
	`S_ISDIR
(
öode
->
vfs_öode
.
i_mode
Ë&& 
öode_⁄ly
 =
LOG_INODE_ALL
)

6377 
fuŒ_dú_loggög
 = 
åue
;

6409 i‡(
fuŒ_dú_loggög
 && 
˘x
->
loggög_√w_dñayed_díåõs
) {

6410 
ªt
 = 
	`båfs_commô_öode_dñayed_ôems
(
å™s
, 
öode
);

6411 i‡(
ªt
)

6412 
out
;

6415 
	`muãx_lock
(&
öode
->
log_muãx
);

6426 i‡(
	`S_ISLNK
(
öode
->
vfs_öode
.
i_mode
))

6427 
öode_⁄ly
 = 
LOG_INODE_ALL
;

6434 
ªt
 = 
	`öode_logged
(
å™s
, 
öode
, 
∑th
);

6435 i‡(
ªt
 < 0)

6436 
out_u∆ock
;

6437 
˘x
->
logged_bef‹e
 = (
ªt
 == 1);

6438 
ªt
 = 0;

6447 i‡(
fuŒ_dú_loggög
 && 
öode
->
œ°_u∆ök_å™s
 >
å™s
->
å™sid
) {

6448 
ªt
 = 
BTRFS_LOG_FORCE_COMMIT
;

6449 
out_u∆ock
;

6456 i‡(
	`S_ISDIR
(
öode
->
vfs_öode
.
i_mode
)) {

6457 
	`˛ór_bô
(
BTRFS_INODE_COPY_EVERYTHING
, &
öode
->
ru¡ime_Êags
);

6458 i‡(
˘x
->
logged_bef‹e
)

6459 
ªt
 = 
	`dr›_öode_ôems
(
å™s
, 
log
, 
∑th
, 
öode
,

6460 
BTRFS_XATTR_ITEM_KEY
);

6462 i‡(
öode_⁄ly
 =
LOG_INODE_EXISTS
 && 
˘x
->
logged_bef‹e
) {

6476 
ªt
 = 
	`logged_öode_size
(
log
, 
öode
, 
∑th
, &
logged_isize
);

6477 i‡(
ªt
)

6478 
out_u∆ock
;

6480 i‡(
	`ã°_bô
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

6481 &
öode
->
ru¡ime_Êags
)) {

6482 i‡(
öode_⁄ly
 =
LOG_INODE_EXISTS
) {

6483 
max_key
.
ty≥
 = 
BTRFS_XATTR_ITEM_KEY
;

6484 i‡(
˘x
->
logged_bef‹e
)

6485 
ªt
 = 
	`dr›_öode_ôems
(
å™s
, 
log
, 
∑th
,

6486 
öode
, 
max_key
.
ty≥
);

6488 
	`˛ór_bô
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

6489 &
öode
->
ru¡ime_Êags
);

6490 
	`˛ór_bô
(
BTRFS_INODE_COPY_EVERYTHING
,

6491 &
öode
->
ru¡ime_Êags
);

6492 i‡(
˘x
->
logged_bef‹e
)

6493 
ªt
 = 
	`åunˇã_öode_ôems
(
å™s
, 
log
,

6494 
öode
, 0, 0);

6496 } i‡(
	`ã°_™d_˛ór_bô
(
BTRFS_INODE_COPY_EVERYTHING
,

6497 &
öode
->
ru¡ime_Êags
) ||

6498 
öode_⁄ly
 =
LOG_INODE_EXISTS
) {

6499 i‡(
öode_⁄ly
 =
LOG_INODE_ALL
)

6500 
Á°_£¨ch
 = 
åue
;

6501 
max_key
.
ty≥
 = 
BTRFS_XATTR_ITEM_KEY
;

6502 i‡(
˘x
->
logged_bef‹e
)

6503 
ªt
 = 
	`dr›_öode_ôems
(
å™s
, 
log
, 
∑th
, 
öode
,

6504 
max_key
.
ty≥
);

6506 i‡(
öode_⁄ly
 =
LOG_INODE_ALL
)

6507 
Á°_£¨ch
 = 
åue
;

6508 
öode_ôem_dr›≥d
 = 
Ál£
;

6509 
log_exã¡s
;

6513 i‡(
ªt
)

6514 
out_u∆ock
;

6522 i‡(
fuŒ_dú_loggög
 && !
˘x
->
loggög_√w_dñayed_díåõs
)

6523 
	`båfs_log_gë_dñayed_ôems
(
öode
, &
dñayed_ös_li°
,

6524 &
dñayed_dñ_li°
);

6526 
ªt
 = 
	`c›y_öode_ôems_to_log
(
å™s
, 
öode
, &
mö_key
, &
max_key
,

6527 
∑th
, 
d°_∑th
, 
logged_isize
,

6528 
öode_⁄ly
, 
˘x
,

6529 &
√ed_log_öode_ôem
);

6530 i‡(
ªt
)

6531 
out_u∆ock
;

6533 
	`båfs_ªÀa£_∑th
(
∑th
);

6534 
	`båfs_ªÀa£_∑th
(
d°_∑th
);

6535 
ªt
 = 
	`båfs_log_Æl_x©ås
(
å™s
, 
öode
, 
∑th
, 
d°_∑th
);

6536 i‡(
ªt
)

6537 
out_u∆ock
;

6538 
x©ås_logged
 = 
åue
;

6539 i‡(
max_key
.
ty≥
 >
BTRFS_EXTENT_DATA_KEY
 && !
Á°_£¨ch
) {

6540 
	`båfs_ªÀa£_∑th
(
∑th
);

6541 
	`båfs_ªÀa£_∑th
(
d°_∑th
);

6542 
ªt
 = 
	`båfs_log_hﬁes
(
å™s
, 
öode
, 
∑th
);

6543 i‡(
ªt
)

6544 
out_u∆ock
;

6546 
log_exã¡s
:

6547 
	`båfs_ªÀa£_∑th
(
∑th
);

6548 
	`båfs_ªÀa£_∑th
(
d°_∑th
);

6549 i‡(
√ed_log_öode_ôem
) {

6550 
ªt
 = 
	`log_öode_ôem
(
å™s
, 
log
, 
d°_∑th
, 
öode
, 
öode_ôem_dr›≥d
);

6551 i‡(
ªt
)

6552 
out_u∆ock
;

6561 i‡(!
x©ås_logged
 && 
öode
->
logged_å™s
 < 
å™s
->
å™sid
) {

6562 
ªt
 = 
	`båfs_log_Æl_x©ås
(
å™s
, 
öode
, 
∑th
, 
d°_∑th
);

6563 i‡(
ªt
)

6564 
out_u∆ock
;

6565 
	`båfs_ªÀa£_∑th
(
∑th
);

6568 i‡(
Á°_£¨ch
) {

6569 
ªt
 = 
	`båfs_log_ch™ged_exã¡s
(
å™s
, 
öode
, 
d°_∑th
, 
˘x
);

6570 i‡(
ªt
)

6571 
out_u∆ock
;

6572 } i‡(
öode_⁄ly
 =
LOG_INODE_ALL
) {

6573 
exã¡_m≠
 *
em
, *
n
;

6575 
	`wrôe_lock
(&
em_åì
->
lock
);

6576 
	`li°_f‹_óch_íåy_ß„
(
em
, 
n
, &
em_åì
->
modifõd_exã¡s
, 
li°
)

6577 
	`li°_dñ_öô
(&
em
->
li°
);

6578 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

6581 i‡(
fuŒ_dú_loggög
) {

6582 
ªt
 = 
	`log_dúe˘‹y_ch™ges
(
å™s
, 
öode
, 
∑th
, 
d°_∑th
, 
˘x
);

6583 i‡(
ªt
)

6584 
out_u∆ock
;

6585 
ªt
 = 
	`log_dñayed_ö£πi⁄_ôems
(
å™s
, 
öode
, 
∑th
,

6586 &
dñayed_ös_li°
, 
˘x
);

6587 i‡(
ªt
)

6588 
out_u∆ock
;

6589 
ªt
 = 
	`log_dñayed_dñëi⁄_ôems
(
å™s
, 
öode
, 
∑th
,

6590 &
dñayed_dñ_li°
, 
˘x
);

6591 i‡(
ªt
)

6592 
out_u∆ock
;

6595 
	`•ö_lock
(&
öode
->
lock
);

6596 
öode
->
logged_å™s
 = 
å™s
->
å™sid
;

6628 i‡(
öode_⁄ly
 !
LOG_INODE_EXISTS
)

6629 
öode
->
œ°_log_commô
 = inode->
œ°_sub_å™s
;

6630 
	`•ö_u∆ock
(&
öode
->
lock
);

6636 i‡(
öode_⁄ly
 =
LOG_INODE_ALL
)

6637 
öode
->
œ°_ªÊök_å™s
 = 0;

6639 
out_u∆ock
:

6640 
	`muãx_u∆ock
(&
öode
->
log_muãx
);

6641 
out
:

6642 
	`båfs_‰ì_∑th
(
∑th
);

6643 
	`båfs_‰ì_∑th
(
d°_∑th
);

6645 i‡(
ªt
)

6646 
	`‰ì_c⁄Êi˘ög_öodes
(
˘x
);

6648 
ªt
 = 
	`log_c⁄Êi˘ög_öodes
(
å™s
, 
öode
->
roŸ
, 
˘x
);

6650 i‡(
fuŒ_dú_loggög
 && !
˘x
->
loggög_√w_dñayed_díåõs
) {

6651 i‡(!
ªt
)

6652 
ªt
 = 
	`log_√w_dñayed_díåõs
(
å™s
, 
öode
,

6653 &
dñayed_ös_li°
, 
˘x
);

6655 
	`båfs_log_put_dñayed_ôems
(
öode
, &
dñayed_ös_li°
,

6656 &
dñayed_dñ_li°
);

6659  
ªt
;

6660 
	}
}

6662 
	$båfs_log_Æl_∑ª¡s
(
båfs_å™s_h™dÀ
 *
å™s
,

6663 
båfs_öode
 *
öode
,

6664 
båfs_log_˘x
 *
˘x
)

6666 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

6667 
ªt
;

6668 
båfs_∑th
 *
∑th
;

6669 
båfs_key
 
key
;

6670 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

6671 c⁄° 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

6673 
∑th
 = 
	`båfs_Æloc_∑th
();

6674 i‡(!
∑th
)

6675  -
ENOMEM
;

6676 
∑th
->
skù_lockög
 = 1;

6677 
∑th
->
£¨ch_commô_roŸ
 = 1;

6679 
key
.
obje˘id
 = 
öo
;

6680 
key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

6681 
key
.
off£t
 = 0;

6682 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

6683 i‡(
ªt
 < 0)

6684 
out
;

6686 
åue
) {

6687 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

6688 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

6689 
u32
 
cur_off£t
 = 0;

6690 
u32
 
ôem_size
;

6691 
±r
;

6693 i‡(
¶Ÿ
 >
	`båfs_hódî_ƒôems
(
Àaf
)) {

6694 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

6695 i‡(
ªt
 < 0)

6696 
out
;

6697 i‡(
ªt
 > 0)

6702 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

6704 i‡(
key
.
obje˘id
 !
öo
 || key.
ty≥
 > 
BTRFS_INODE_EXTREF_KEY
)

6707 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

6708 
±r
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
¶Ÿ
);

6709 
cur_off£t
 < 
ôem_size
) {

6710 
båfs_key
 
öode_key
;

6711 
öode
 *
dú_öode
;

6713 
öode_key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

6714 
öode_key
.
off£t
 = 0;

6716 i‡(
key
.
ty≥
 =
BTRFS_INODE_EXTREF_KEY
) {

6717 
båfs_öode_exåef
 *
exåef
;

6719 
exåef
 = (
båfs_öode_exåef
 *)

6720 (
±r
 + 
cur_off£t
);

6721 
öode_key
.
obje˘id
 = 
	`båfs_öode_exåef_∑ª¡
(

6722 
Àaf
, 
exåef
);

6723 
cur_off£t
 +(*
exåef
);

6724 
cur_off£t
 +
	`båfs_öode_exåef_«me_Àn
(
Àaf
,

6725 
exåef
);

6727 
öode_key
.
obje˘id
 = 
key
.
off£t
;

6728 
cur_off£t
 = 
ôem_size
;

6731 
dú_öode
 = 
	`båfs_igë
(
fs_öfo
->
sb
, 
öode_key
.
obje˘id
,

6732 
roŸ
);

6756 i‡(
	`IS_ERR
(
dú_öode
)) {

6757 
ªt
 = 
	`PTR_ERR
(
dú_öode
);

6758 
out
;

6761 i‡(!
	`√ed_log_öode
(
å™s
, 
	`BTRFS_I
(
dú_öode
))) {

6762 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
dú_öode
));

6766 
˘x
->
log_√w_díåõs
 = 
Ál£
;

6767 
ªt
 = 
	`båfs_log_öode
(
å™s
, 
	`BTRFS_I
(
dú_öode
),

6768 
LOG_INODE_ALL
, 
˘x
);

6769 i‡(!
ªt
 && 
˘x
->
log_√w_díåõs
)

6770 
ªt
 = 
	`log_√w_dú_díåõs
(
å™s
,

6771 
	`BTRFS_I
(
dú_öode
), 
˘x
);

6772 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
dú_öode
));

6773 i‡(
ªt
)

6774 
out
;

6776 
∑th
->
¶Ÿs
[0]++;

6778 
ªt
 = 0;

6779 
out
:

6780 
	`båfs_‰ì_∑th
(
∑th
);

6781  
ªt
;

6782 
	}
}

6784 
	$log_√w_™˚°‹s
(
båfs_å™s_h™dÀ
 *
å™s
,

6785 
båfs_roŸ
 *
roŸ
,

6786 
båfs_∑th
 *
∑th
,

6787 
båfs_log_˘x
 *
˘x
)

6789 
båfs_key
 
found_key
;

6791 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
found_key
,Ö©h->
¶Ÿs
[0]);

6793 
åue
) {

6794 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

6795 
exã¡_buf„r
 *
Àaf
;

6796 
¶Ÿ
;

6797 
båfs_key
 
£¨ch_key
;

6798 
öode
 *inode;

6799 
u64
 
öo
;

6800 
ªt
 = 0;

6802 
	`båfs_ªÀa£_∑th
(
∑th
);

6804 
öo
 = 
found_key
.
off£t
;

6806 
£¨ch_key
.
obje˘id
 = 
found_key
.
off£t
;

6807 
£¨ch_key
.
ty≥
 = 
BTRFS_INODE_ITEM_KEY
;

6808 
£¨ch_key
.
off£t
 = 0;

6809 
öode
 = 
	`båfs_igë
(
fs_öfo
->
sb
, 
öo
, 
roŸ
);

6810 i‡(
	`IS_ERR
(
öode
))

6811  
	`PTR_ERR
(
öode
);

6813 i‡(
	`BTRFS_I
(
öode
)->
gíî©i⁄
 >
å™s
->
å™sid
 &&

6814 
	`√ed_log_öode
(
å™s
, 
	`BTRFS_I
(
öode
)))

6815 
ªt
 = 
	`båfs_log_öode
(
å™s
, 
	`BTRFS_I
(
öode
),

6816 
LOG_INODE_EXISTS
, 
˘x
);

6817 
	`båfs_add_dñayed_ùut
(
	`BTRFS_I
(
öode
));

6818 i‡(
ªt
)

6819  
ªt
;

6821 i‡(
£¨ch_key
.
obje˘id
 =
BTRFS_FIRST_FREE_OBJECTID
)

6824 
£¨ch_key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

6825 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
£¨ch_key
, 
∑th
, 0, 0);

6826 i‡(
ªt
 < 0)

6827  
ªt
;

6829 
Àaf
 = 
∑th
->
nodes
[0];

6830 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

6831 i‡(
¶Ÿ
 >
	`båfs_hódî_ƒôems
(
Àaf
)) {

6832 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

6833 i‡(
ªt
 < 0)

6834  
ªt
;

6835 i‡(
ªt
 > 0)

6836  -
ENOENT
;

6837 
Àaf
 = 
∑th
->
nodes
[0];

6838 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

6841 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
¶Ÿ
);

6842 i‡(
found_key
.
obje˘id
 !
£¨ch_key
.objectid ||

6843 
found_key
.
ty≥
 !
BTRFS_INODE_REF_KEY
)

6844  -
ENOENT
;

6847 
	}
}

6849 
	$log_√w_™˚°‹s_Á°
(
båfs_å™s_h™dÀ
 *
å™s
,

6850 
båfs_öode
 *
öode
,

6851 
díåy
 *
∑ª¡
,

6852 
båfs_log_˘x
 *
˘x
)

6854 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

6855 
díåy
 *
ﬁd_∑ª¡
 = 
NULL
;

6856 
su≥r_block
 *
sb
 = 
öode
->
vfs_öode
.
i_sb
;

6857 
ªt
 = 0;

6859 
åue
) {

6860 i‡(!
∑ª¡
 || 
	`d_ªÆly_is_√g©ive
(parent) ||

6861 
sb
 !
∑ª¡
->
d_sb
)

6864 
öode
 = 
	`BTRFS_I
(
	`d_öode
(
∑ª¡
));

6865 i‡(
roŸ
 !
öode
->root)

6868 i‡(
öode
->
gíî©i⁄
 >
å™s
->
å™sid
 &&

6869 
	`√ed_log_öode
(
å™s
, 
öode
)) {

6870 
ªt
 = 
	`båfs_log_öode
(
å™s
, 
öode
,

6871 
LOG_INODE_EXISTS
, 
˘x
);

6872 i‡(
ªt
)

6875 i‡(
	`IS_ROOT
(
∑ª¡
))

6878 
∑ª¡
 = 
	`dgë_∑ª¡
(parent);

6879 
	`dput
(
ﬁd_∑ª¡
);

6880 
ﬁd_∑ª¡
 = 
∑ª¡
;

6882 
	`dput
(
ﬁd_∑ª¡
);

6884  
ªt
;

6885 
	}
}

6887 
	$log_Æl_√w_™˚°‹s
(
båfs_å™s_h™dÀ
 *
å™s
,

6888 
båfs_öode
 *
öode
,

6889 
díåy
 *
∑ª¡
,

6890 
båfs_log_˘x
 *
˘x
)

6892 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

6893 c⁄° 
u64
 
öo
 = 
	`båfs_öo
(
öode
);

6894 
båfs_∑th
 *
∑th
;

6895 
båfs_key
 
£¨ch_key
;

6896 
ªt
;

6902 i‡(
öode
->
vfs_öode
.
i_∆ök
 < 2)

6903  
	`log_√w_™˚°‹s_Á°
(
å™s
, 
öode
, 
∑ª¡
, 
˘x
);

6905 
∑th
 = 
	`båfs_Æloc_∑th
();

6906 i‡(!
∑th
)

6907  -
ENOMEM
;

6909 
£¨ch_key
.
obje˘id
 = 
öo
;

6910 
£¨ch_key
.
ty≥
 = 
BTRFS_INODE_REF_KEY
;

6911 
£¨ch_key
.
off£t
 = 0;

6912 
agaö
:

6913 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
£¨ch_key
, 
∑th
, 0, 0);

6914 i‡(
ªt
 < 0)

6915 
out
;

6916 i‡(
ªt
 == 0)

6917 
∑th
->
¶Ÿs
[0]++;

6919 
åue
) {

6920 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

6921 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

6922 
båfs_key
 
found_key
;

6924 i‡(
¶Ÿ
 >
	`båfs_hódî_ƒôems
(
Àaf
)) {

6925 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

6926 i‡(
ªt
 < 0)

6927 
out
;

6928 i‡(
ªt
 > 0)

6933 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
¶Ÿ
);

6934 i‡(
found_key
.
obje˘id
 !
öo
 ||

6935 
found_key
.
ty≥
 > 
BTRFS_INODE_EXTREF_KEY
)

6945 i‡(
found_key
.
ty≥
 =
BTRFS_INODE_EXTREF_KEY
) {

6946 
ªt
 = -
EMLINK
;

6947 
out
;

6956 
	`mem˝y
(&
£¨ch_key
, &
found_key
, (search_key));

6958 
ªt
 = 
	`log_√w_™˚°‹s
(
å™s
, 
roŸ
, 
∑th
, 
˘x
);

6959 i‡(
ªt
)

6960 
out
;

6961 
	`båfs_ªÀa£_∑th
(
∑th
);

6962 
agaö
;

6964 
ªt
 = 0;

6965 
out
:

6966 
	`båfs_‰ì_∑th
(
∑th
);

6967  
ªt
;

6968 
	}
}

6976 
	$båfs_log_öode_∑ª¡
(
båfs_å™s_h™dÀ
 *
å™s
,

6977 
båfs_öode
 *
öode
,

6978 
díåy
 *
∑ª¡
,

6979 
öode_⁄ly
,

6980 
båfs_log_˘x
 *
˘x
)

6982 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

6983 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

6984 
ªt
 = 0;

6985 
boﬁ
 
log_díåõs
 = 
Ál£
;

6987 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
NOTREELOG
)) {

6988 
ªt
 = 
BTRFS_LOG_FORCE_COMMIT
;

6989 
íd_no_å™s
;

6992 i‡(
	`båfs_roŸ_ªfs
(&
roŸ
->
roŸ_ôem
) == 0) {

6993 
ªt
 = 
BTRFS_LOG_FORCE_COMMIT
;

6994 
íd_no_å™s
;

7002 i‡((
	`båfs_öode_ö_log
(
öode
, 
å™s
->
å™sid
) &&

7003 
	`li°_em±y
(&
˘x
->
‹dîed_exã¡s
)) ||

7004 
öode
->
vfs_öode
.
i_∆ök
 == 0) {

7005 
ªt
 = 
BTRFS_NO_LOG_SYNC
;

7006 
íd_no_å™s
;

7009 
ªt
 = 
	`°¨t_log_å™s
(
å™s
, 
roŸ
, 
˘x
);

7010 i‡(
ªt
)

7011 
íd_no_å™s
;

7013 
ªt
 = 
	`båfs_log_öode
(
å™s
, 
öode
, 
öode_⁄ly
, 
˘x
);

7014 i‡(
ªt
)

7015 
íd_å™s
;

7023 i‡(
	`S_ISREG
(
öode
->
vfs_öode
.
i_mode
) &&

7024 
öode
->
gíî©i⁄
 < 
å™s
->
å™sid
 &&

7025 
öode
->
œ°_u∆ök_å™s
 < 
å™s
->
å™sid
) {

7026 
ªt
 = 0;

7027 
íd_å™s
;

7030 i‡(
	`S_ISDIR
(
öode
->
vfs_öode
.
i_mode
Ë&& 
˘x
->
log_√w_díåõs
)

7031 
log_díåõs
 = 
åue
;

7074 i‡(
öode
->
œ°_u∆ök_å™s
 >
å™s
->
å™sid
) {

7075 
ªt
 = 
	`båfs_log_Æl_∑ª¡s
(
å™s
, 
öode
, 
˘x
);

7076 i‡(
ªt
)

7077 
íd_å™s
;

7080 
ªt
 = 
	`log_Æl_√w_™˚°‹s
(
å™s
, 
öode
, 
∑ª¡
, 
˘x
);

7081 i‡(
ªt
)

7082 
íd_å™s
;

7084 i‡(
log_díåõs
)

7085 
ªt
 = 
	`log_√w_dú_díåõs
(
å™s
, 
öode
, 
˘x
);

7087 
ªt
 = 0;

7088 
íd_å™s
:

7089 i‡(
ªt
 < 0) {

7090 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

7091 
ªt
 = 
BTRFS_LOG_FORCE_COMMIT
;

7094 i‡(
ªt
)

7095 
	`båfs_ªmove_log_˘x
(
roŸ
, 
˘x
);

7096 
	`båfs_íd_log_å™s
(
roŸ
);

7097 
íd_no_å™s
:

7098  
ªt
;

7099 
	}
}

7107 
	$båfs_log_díåy_ß„
(
båfs_å™s_h™dÀ
 *
å™s
,

7108 
díåy
 *dentry,

7109 
båfs_log_˘x
 *
˘x
)

7111 
díåy
 *
∑ª¡
 = 
	`dgë_∑ª¡
(dentry);

7112 
ªt
;

7114 
ªt
 = 
	`båfs_log_öode_∑ª¡
(
å™s
, 
	`BTRFS_I
(
	`d_öode
(
díåy
)), 
∑ª¡
,

7115 
LOG_INODE_ALL
, 
˘x
);

7116 
	`dput
(
∑ª¡
);

7118  
ªt
;

7119 
	}
}

7125 
	$båfs_ªcovî_log_åìs
(
båfs_roŸ
 *
log_roŸ_åì
)

7127 
ªt
;

7128 
båfs_∑th
 *
∑th
;

7129 
båfs_å™s_h™dÀ
 *
å™s
;

7130 
båfs_key
 
key
;

7131 
båfs_key
 
found_key
;

7132 
båfs_roŸ
 *
log
;

7133 
båfs_fs_öfo
 *
fs_öfo
 = 
log_roŸ_åì
->fs_info;

7134 
wÆk_c⁄åﬁ
 
wc
 = {

7135 .
¥o˚ss_func
 = 
¥o˚ss_⁄e_buf„r
,

7136 .
°age
 = 
LOG_WALK_PIN_ONLY
,

7139 
∑th
 = 
	`båfs_Æloc_∑th
();

7140 i‡(!
∑th
)

7141  -
ENOMEM
;

7143 
	`£t_bô
(
BTRFS_FS_LOG_RECOVERING
, &
fs_öfo
->
Êags
);

7145 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
fs_öfo
->
åì_roŸ
, 0);

7146 i‡(
	`IS_ERR
(
å™s
)) {

7147 
ªt
 = 
	`PTR_ERR
(
å™s
);

7148 
îr‹
;

7151 
wc
.
å™s
 =Årans;

7152 
wc
.
pö
 = 1;

7154 
ªt
 = 
	`wÆk_log_åì
(
å™s
, 
log_roŸ_åì
, &
wc
);

7155 i‡(
ªt
) {

7156 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

7157 
îr‹
;

7160 
agaö
:

7161 
key
.
obje˘id
 = 
BTRFS_TREE_LOG_OBJECTID
;

7162 
key
.
off£t
 = (
u64
)-1;

7163 
key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

7166 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
log_roŸ_åì
, &
key
, 
∑th
, 0, 0);

7168 i‡(
ªt
 < 0) {

7169 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

7170 
îr‹
;

7172 i‡(
ªt
 > 0) {

7173 i‡(
∑th
->
¶Ÿs
[0] == 0)

7175 
∑th
->
¶Ÿs
[0]--;

7177 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
found_key
,

7178 
∑th
->
¶Ÿs
[0]);

7179 
	`båfs_ªÀa£_∑th
(
∑th
);

7180 i‡(
found_key
.
obje˘id
 !
BTRFS_TREE_LOG_OBJECTID
)

7183 
log
 = 
	`båfs_ªad_åì_roŸ
(
log_roŸ_åì
, &
found_key
);

7184 i‡(
	`IS_ERR
(
log
)) {

7185 
ªt
 = 
	`PTR_ERR
(
log
);

7186 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

7187 
îr‹
;

7190 
wc
.
ª∂ay_de°
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
found_key
.
off£t
,

7191 
åue
);

7192 i‡(
	`IS_ERR
(
wc
.
ª∂ay_de°
)) {

7193 
ªt
 = 
	`PTR_ERR
(
wc
.
ª∂ay_de°
);

7206 i‡(
ªt
 =-
ENOENT
)

7207 
ªt
 = 
	`båfs_pö_exã¡_f‹_log_ª∂ay
(
å™s
,

7208 
log
->
node
->
°¨t
,

7209 
log
->
node
->
Àn
);

7210 
	`båfs_put_roŸ
(
log
);

7212 i‡(!
ªt
)

7213 
√xt
;

7214 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

7215 
îr‹
;

7218 
wc
.
ª∂ay_de°
->
log_roŸ
 = 
log
;

7219 
ªt
 = 
	`båfs_ªc‹d_roŸ_ö_å™s
(
å™s
, 
wc
.
ª∂ay_de°
);

7220 i‡(
ªt
)

7222 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

7224 
ªt
 = 
	`wÆk_log_åì
(
å™s
, 
log
, &
wc
);

7226 i‡(!
ªt
 && 
wc
.
°age
 =
LOG_WALK_REPLAY_ALL
) {

7227 
ªt
 = 
	`fixup_öode_lök_cou¡s
(
å™s
, 
wc
.
ª∂ay_de°
,

7228 
∑th
);

7229 i‡(
ªt
)

7230 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

7233 i‡(!
ªt
 && 
wc
.
°age
 =
LOG_WALK_REPLAY_ALL
) {

7234 
båfs_roŸ
 *
roŸ
 = 
wc
.
ª∂ay_de°
;

7236 
	`båfs_ªÀa£_∑th
(
∑th
);

7246 
ªt
 = 
	`båfs_öô_roŸ_‰ì_obje˘id
(
roŸ
);

7247 i‡(
ªt
)

7248 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

7251 
wc
.
ª∂ay_de°
->
log_roŸ
 = 
NULL
;

7252 
	`båfs_put_roŸ
(
wc
.
ª∂ay_de°
);

7253 
	`båfs_put_roŸ
(
log
);

7255 i‡(
ªt
)

7256 
îr‹
;

7257 
√xt
:

7258 i‡(
found_key
.
off£t
 == 0)

7260 
key
.
off£t
 = 
found_key
.offset - 1;

7262 
	`båfs_ªÀa£_∑th
(
∑th
);

7265 i‡(
wc
.
pö
) {

7266 
wc
.
pö
 = 0;

7267 
wc
.
¥o˚ss_func
 = 
ª∂ay_⁄e_buf„r
;

7268 
wc
.
°age
 = 
LOG_WALK_REPLAY_INODES
;

7269 
agaö
;

7272 i‡(
wc
.
°age
 < 
LOG_WALK_REPLAY_ALL
) {

7273 
wc
.
°age
++;

7274 
agaö
;

7277 
	`båfs_‰ì_∑th
(
∑th
);

7280 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

7281 i‡(
ªt
)

7282  
ªt
;

7284 
log_roŸ_åì
->
log_roŸ
 = 
NULL
;

7285 
	`˛ór_bô
(
BTRFS_FS_LOG_RECOVERING
, &
fs_öfo
->
Êags
);

7286 
	`båfs_put_roŸ
(
log_roŸ_åì
);

7289 
îr‹
:

7290 i‡(
wc
.
å™s
)

7291 
	`båfs_íd_å™ß˘i⁄
(
wc
.
å™s
);

7292 
	`˛ór_bô
(
BTRFS_FS_LOG_RECOVERING
, &
fs_öfo
->
Êags
);

7293 
	`båfs_‰ì_∑th
(
∑th
);

7294  
ªt
;

7295 
	}
}

7308 
	$båfs_ªc‹d_u∆ök_dú
(
båfs_å™s_h™dÀ
 *
å™s
,

7309 
båfs_öode
 *
dú
, båfs_öodê*
öode
,

7310 
boﬁ
 
f‹_ª«me
)

7322 
	`muãx_lock
(&
öode
->
log_muãx
);

7323 
öode
->
œ°_u∆ök_å™s
 = 
å™s
->
å™sid
;

7324 
	`muãx_u∆ock
(&
öode
->
log_muãx
);

7326 i‡(!
f‹_ª«me
)

7335 i‡(
	`öode_logged
(
å™s
, 
dú
, 
NULL
) == 1)

7344 i‡(
	`öode_logged
(
å™s
, 
öode
, 
NULL
) == 1)

7354 
	`muãx_lock
(&
dú
->
log_muãx
);

7355 
dú
->
œ°_u∆ök_å™s
 = 
å™s
->
å™sid
;

7356 
	`muãx_u∆ock
(&
dú
->
log_muãx
);

7357 
	}
}

7371 
	$båfs_ªc‹d_¢≠shŸ_de°roy
(
båfs_å™s_h™dÀ
 *
å™s
,

7372 
båfs_öode
 *
dú
)

7374 
	`muãx_lock
(&
dú
->
log_muãx
);

7375 
dú
->
œ°_u∆ök_å™s
 = 
å™s
->
å™sid
;

7376 
	`muãx_u∆ock
(&
dú
->
log_muãx
);

7377 
	}
}

7396 
	$båfs_log_√w_«me
(
båfs_å™s_h™dÀ
 *
å™s
,

7397 
díåy
 *
ﬁd_díåy
, 
båfs_öode
 *
ﬁd_dú
,

7398 
u64
 
ﬁd_dú_ödex
, 
díåy
 *
∑ª¡
)

7400 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
	`d_öode
(
ﬁd_díåy
));

7401 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

7402 
båfs_log_˘x
 
˘x
;

7403 
boﬁ
 
log_pö√d
 = 
Ál£
;

7404 
ªt
;

7410 i‡(!
	`S_ISDIR
(
öode
->
vfs_öode
.
i_mode
))

7411 
öode
->
œ°_u∆ök_å™s
 = 
å™s
->
å™sid
;

7417 
ªt
 = 
	`öode_logged
(
å™s
, 
öode
, 
NULL
);

7418 i‡(
ªt
 < 0) {

7419 
out
;

7420 } i‡(
ªt
 == 0) {

7421 i‡(!
ﬁd_dú
)

7428 
ªt
 = 
	`öode_logged
(
å™s
, 
ﬁd_dú
, 
NULL
);

7429 i‡(
ªt
 < 0)

7430 
out
;

7431 i‡(
ªt
 == 0)

7434 
ªt
 = 0;

7443 i‡(
ﬁd_dú
 && old_dú->
logged_å™s
 =
å™s
->
å™sid
) {

7444 
båfs_roŸ
 *
log
 = 
ﬁd_dú
->
roŸ
->
log_roŸ
;

7445 
båfs_∑th
 *
∑th
;

7446 
fs¸y±_«me
 
‚ame
;

7448 
	`ASSERT
(
ﬁd_dú_ödex
 >
BTRFS_DIR_START_INDEX
);

7450 
ªt
 = 
	`fs¸y±_£tup_fûíame
(&
ﬁd_dú
->
vfs_öode
,

7451 &
ﬁd_díåy
->
d_«me
, 0, &
‚ame
);

7452 i‡(
ªt
)

7453 
out
;

7460 
ªt
 = 
	`joö_ru¬ög_log_å™s
(
roŸ
);

7466 i‡(
	`WARN_ON_ONCE
(
ªt
 < 0)) {

7467 
	`fs¸y±_‰ì_fûíame
(&
‚ame
);

7468 
out
;

7471 
log_pö√d
 = 
åue
;

7473 
∑th
 = 
	`båfs_Æloc_∑th
();

7474 i‡(!
∑th
) {

7475 
ªt
 = -
ENOMEM
;

7476 
	`fs¸y±_‰ì_fûíame
(&
‚ame
);

7477 
out
;

7490 
	`muãx_lock
(&
ﬁd_dú
->
log_muãx
);

7491 
ªt
 = 
	`dñ_logged_díåy
(
å™s
, 
log
, 
∑th
, 
	`båfs_öo
(
ﬁd_dú
),

7492 &
‚ame
.
disk_«me
, 
ﬁd_dú_ödex
);

7493 i‡(
ªt
 > 0) {

7498 
	`båfs_ªÀa£_∑th
(
∑th
);

7499 
ªt
 = 
	`ö£π_dú_log_key
(
å™s
, 
log
, 
∑th
,

7500 
	`båfs_öo
(
ﬁd_dú
),

7501 
ﬁd_dú_ödex
, old_dir_index);

7503 
	`muãx_u∆ock
(&
ﬁd_dú
->
log_muãx
);

7505 
	`båfs_‰ì_∑th
(
∑th
);

7506 
	`fs¸y±_‰ì_fûíame
(&
‚ame
);

7507 i‡(
ªt
 < 0)

7508 
out
;

7511 
	`båfs_öô_log_˘x
(&
˘x
, &
öode
->
vfs_öode
);

7512 
˘x
.
loggög_√w_«me
 = 
åue
;

7520 
	`båfs_log_öode_∑ª¡
(
å™s
, 
öode
, 
∑ª¡
, 
LOG_INODE_EXISTS
, &
˘x
);

7521 
	`ASSERT
(
	`li°_em±y
(&
˘x
.
c⁄Êi˘_öodes
));

7522 
out
:

7529 i‡(
ªt
 < 0)

7530 
	`båfs_£t_log_fuŒ_commô
(
å™s
);

7531 i‡(
log_pö√d
)

7532 
	`båfs_íd_log_å™s
(
roŸ
);

7533 
	}
}

	@tree-log.h

6 #i‚de‡
BTRFS_TREE_LOG_H


7 
	#BTRFS_TREE_LOG_H


	)

9 
	~"mesßges.h
"

10 
	~"˘ªe.h
"

11 
	~"å™ß˘i⁄.h
"

14 
	#BTRFS_NO_LOG_SYNC
 256

	)

22 
	#BTRFS_LOG_FORCE_COMMIT
 (-(
MAX_ERRNO
 + 1))

	)

24 
	sbåfs_log_˘x
 {

25 
	mlog_ªt
;

26 
	mlog_å™sid
;

27 
boﬁ
 
	mlog_√w_díåõs
;

28 
boﬁ
 
	mloggög_√w_«me
;

29 
boﬁ
 
	mloggög_√w_dñayed_díåõs
;

31 
boﬁ
 
	mlogged_bef‹e
;

32 
öode
 *
	möode
;

33 
li°_hód
 
	mli°
;

35 
li°_hód
 
	m‹dîed_exã¡s
;

36 
li°_hód
 
	mc⁄Êi˘_öodes
;

37 
	mnum_c⁄Êi˘_öodes
;

38 
boﬁ
 
	mloggög_c⁄Êi˘_öodes
;

41 
ölöe
 
	$båfs_öô_log_˘x
(
båfs_log_˘x
 *
˘x
,

42 
öode
 *inode)

44 
˘x
->
log_ªt
 = 0;

45 
˘x
->
log_å™sid
 = 0;

46 
˘x
->
log_√w_díåõs
 = 
Ál£
;

47 
˘x
->
loggög_√w_«me
 = 
Ál£
;

48 
˘x
->
loggög_√w_dñayed_díåõs
 = 
Ál£
;

49 
˘x
->
logged_bef‹e
 = 
Ál£
;

50 
˘x
->
öode
 = inode;

51 
	`INIT_LIST_HEAD
(&
˘x
->
li°
);

52 
	`INIT_LIST_HEAD
(&
˘x
->
‹dîed_exã¡s
);

53 
	`INIT_LIST_HEAD
(&
˘x
->
c⁄Êi˘_öodes
);

54 
˘x
->
num_c⁄Êi˘_öodes
 = 0;

55 
˘x
->
loggög_c⁄Êi˘_öodes
 = 
Ál£
;

56 
	}
}

58 
ölöe
 
	$båfs_ªÀa£_log_˘x_exã¡s
(
båfs_log_˘x
 *
˘x
)

60 
båfs_‹dîed_exã¡
 *
‹dîed
;

61 
båfs_‹dîed_exã¡
 *
tmp
;

63 
	`ASSERT
(
	`öode_is_locked
(
˘x
->
öode
));

65 
	`li°_f‹_óch_íåy_ß„
(
‹dîed
, 
tmp
, &
˘x
->
‹dîed_exã¡s
, 
log_li°
) {

66 
	`li°_dñ_öô
(&
‹dîed
->
log_li°
);

67 
	`båfs_put_‹dîed_exã¡
(
‹dîed
);

69 
	}
}

71 
ölöe
 
	$båfs_£t_log_fuŒ_commô
(
båfs_å™s_h™dÀ
 *
å™s
)

73 
	`WRITE_ONCE
(
å™s
->
fs_öfo
->
œ°_å™s_log_fuŒ_commô
,Åøns->
å™sid
);

74 
	}
}

76 
ölöe
 
	$båfs_√ed_log_fuŒ_commô
(
båfs_å™s_h™dÀ
 *
å™s
)

78  
	`READ_ONCE
(
å™s
->
fs_öfo
->
œ°_å™s_log_fuŒ_commô
) ==

79 
å™s
->
å™sid
;

80 
	}
}

82 
båfs_sync_log
(
båfs_å™s_h™dÀ
 *
å™s
,

83 
båfs_roŸ
 *
roŸ
, 
båfs_log_˘x
 *
˘x
);

84 
båfs_‰ì_log
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_roŸ
 *
roŸ
);

85 
båfs_‰ì_log_roŸ_åì
(
båfs_å™s_h™dÀ
 *
å™s
,

86 
båfs_fs_öfo
 *
fs_öfo
);

87 
båfs_ªcovî_log_åìs
(
båfs_roŸ
 *
åì_roŸ
);

88 
båfs_log_díåy_ß„
(
båfs_å™s_h™dÀ
 *
å™s
,

89 
díåy
 *dentry,

90 
båfs_log_˘x
 *
˘x
);

91 
båfs_dñ_dú_íåõs_ö_log
(
båfs_å™s_h™dÀ
 *
å™s
,

92 
båfs_roŸ
 *
roŸ
,

93 c⁄° 
fs¸y±_°r
 *
«me
,

94 
båfs_öode
 *
dú
, 
u64
 
ödex
);

95 
båfs_dñ_öode_ªf_ö_log
(
båfs_å™s_h™dÀ
 *
å™s
,

96 
båfs_roŸ
 *
roŸ
,

97 c⁄° 
fs¸y±_°r
 *
«me
,

98 
båfs_öode
 *
öode
, 
u64
 
dúid
);

99 
båfs_íd_log_å™s
(
båfs_roŸ
 *
roŸ
);

100 
båfs_pö_log_å™s
(
båfs_roŸ
 *
roŸ
);

101 
båfs_ªc‹d_u∆ök_dú
(
båfs_å™s_h™dÀ
 *
å™s
,

102 
båfs_öode
 *
dú
, båfs_öodê*
öode
,

103 
boﬁ
 
f‹_ª«me
);

104 
båfs_ªc‹d_¢≠shŸ_de°roy
(
båfs_å™s_h™dÀ
 *
å™s
,

105 
båfs_öode
 *
dú
);

106 
båfs_log_√w_«me
(
båfs_å™s_h™dÀ
 *
å™s
,

107 
díåy
 *
ﬁd_díåy
, 
båfs_öode
 *
ﬁd_dú
,

108 
u64
 
ﬁd_dú_ödex
, 
díåy
 *
∑ª¡
);

	@tree-mod-log.c

3 
	~"mesßges.h
"

4 
	~"åì-mod-log.h
"

5 
	~"disk-io.h
"

6 
	~"fs.h
"

7 
	~"ac˚ss‹s.h
"

8 
	~"åì-checkî.h
"

10 
	såì_mod_roŸ
 {

11 
u64
 
	mlogiˇl
;

12 
u8
 
	mÀvñ
;

15 
	såì_mod_ñem
 {

16 
rb_node
 
	mnode
;

17 
u64
 
	mlogiˇl
;

18 
u64
 
	m£q
;

19 
båfs_mod_log_›
 
	m›
;

25 
	m¶Ÿ
;

28 
u64
 
	mgíî©i⁄
;

31 
båfs_disk_key
 
	mkey
;

32 
u64
 
	mblock±r
;

36 
	md°_¶Ÿ
;

37 
	mƒ_ôems
;

38 } 
	mmove
;

41 
åì_mod_roŸ
 
	mﬁd_roŸ
;

47 
ölöe
 
u64
 
	$båfs_öc_åì_mod_£q
(
båfs_fs_öfo
 *
fs_öfo
)

49  
	`©omic64_öc_ªtu∫
(&
fs_öfo
->
åì_mod_£q
);

50 
	}
}

60 
u64
 
	$båfs_gë_åì_mod_£q
(
båfs_fs_öfo
 *
fs_öfo
,

61 
båfs_£q_li°
 *
ñem
)

63 
	`wrôe_lock
(&
fs_öfo
->
åì_mod_log_lock
);

64 i‡(!
ñem
->
£q
) {

65 
ñem
->
£q
 = 
	`båfs_öc_åì_mod_£q
(
fs_öfo
);

66 
	`li°_add_èû
(&
ñem
->
li°
, &
fs_öfo
->
åì_mod_£q_li°
);

67 
	`£t_bô
(
BTRFS_FS_TREE_MOD_LOG_USERS
, &
fs_öfo
->
Êags
);

69 
	`wrôe_u∆ock
(&
fs_öfo
->
åì_mod_log_lock
);

71  
ñem
->
£q
;

72 
	}
}

74 
	$båfs_put_åì_mod_£q
(
båfs_fs_öfo
 *
fs_öfo
,

75 
båfs_£q_li°
 *
ñem
)

77 
rb_roŸ
 *
tm_roŸ
;

78 
rb_node
 *
node
;

79 
rb_node
 *
√xt
;

80 
åì_mod_ñem
 *
tm
;

81 
u64
 
mö_£q
 = 
BTRFS_SEQ_LAST
;

82 
u64
 
£q_puâög
 = 
ñem
->
£q
;

84 i‡(!
£q_puâög
)

87 
	`wrôe_lock
(&
fs_öfo
->
åì_mod_log_lock
);

88 
	`li°_dñ
(&
ñem
->
li°
);

89 
ñem
->
£q
 = 0;

91 i‡(
	`li°_em±y
(&
fs_öfo
->
åì_mod_£q_li°
)) {

92 
	`˛ór_bô
(
BTRFS_FS_TREE_MOD_LOG_USERS
, &
fs_öfo
->
Êags
);

94 
båfs_£q_li°
 *
fú°
;

96 
fú°
 = 
	`li°_fú°_íåy
(&
fs_öfo
->
åì_mod_£q_li°
,

97 
båfs_£q_li°
, 
li°
);

98 i‡(
£q_puâög
 > 
fú°
->
£q
) {

103 
	`wrôe_u∆ock
(&
fs_öfo
->
åì_mod_log_lock
);

106 
mö_£q
 = 
fú°
->
£q
;

113 
tm_roŸ
 = &
fs_öfo
->
åì_mod_log
;

114 
node
 = 
	`rb_fú°
(
tm_roŸ
);Çode;Çodê
√xt
) {

115 
√xt
 = 
	`rb_√xt
(
node
);

116 
tm
 = 
	`rb_íåy
(
node
, 
åì_mod_ñem
,Çode);

117 i‡(
tm
->
£q
 >
mö_£q
)

119 
	`rb_îa£
(
node
, 
tm_roŸ
);

120 
	`k‰ì
(
tm
);

122 
	`wrôe_u∆ock
(&
fs_öfo
->
åì_mod_log_lock
);

123 
	}
}

133 
noölöe
 
	$åì_mod_log_ö£π
(
båfs_fs_öfo
 *
fs_öfo
,

134 
åì_mod_ñem
 *
tm
)

136 
rb_roŸ
 *
tm_roŸ
;

137 
rb_node
 **
√w
;

138 
rb_node
 *
∑ª¡
 = 
NULL
;

139 
åì_mod_ñem
 *
cur
;

141 
	`lockdï_as£π_hñd_wrôe
(&
fs_öfo
->
åì_mod_log_lock
);

143 
tm
->
£q
 = 
	`båfs_öc_åì_mod_£q
(
fs_öfo
);

145 
tm_roŸ
 = &
fs_öfo
->
åì_mod_log
;

146 
√w
 = &
tm_roŸ
->
rb_node
;

147 *
√w
) {

148 
cur
 = 
	`rb_íåy
(*
√w
, 
åì_mod_ñem
, 
node
);

149 
∑ª¡
 = *
√w
;

150 i‡(
cur
->
logiˇl
 < 
tm
->logical)

151 
√w
 = &((*√w)->
rb_À·
);

152 i‡(
cur
->
logiˇl
 > 
tm
->logical)

153 
√w
 = &((*√w)->
rb_right
);

154 i‡(
cur
->
£q
 < 
tm
->seq)

155 
√w
 = &((*√w)->
rb_À·
);

156 i‡(
cur
->
£q
 > 
tm
->seq)

157 
√w
 = &((*√w)->
rb_right
);

159  -
EEXIST
;

162 
	`rb_lök_node
(&
tm
->
node
, 
∑ª¡
, 
√w
);

163 
	`rb_ö£π_cﬁ‹
(&
tm
->
node
, 
tm_roŸ
);

165 
	}
}

173 
ölöe
 
boﬁ
 
	$åì_mod_d⁄t_log
(
båfs_fs_öfo
 *
fs_öfo
,

174 
exã¡_buf„r
 *
eb
)

176 i‡(!
	`ã°_bô
(
BTRFS_FS_TREE_MOD_LOG_USERS
, &
fs_öfo
->
Êags
))

177  
åue
;

178 i‡(
eb
 && 
	`båfs_hódî_Àvñ
(eb) == 0)

179  
åue
;

181 
	`wrôe_lock
(&
fs_öfo
->
åì_mod_log_lock
);

182 i‡(
	`li°_em±y
(&(
fs_öfo
)->
åì_mod_£q_li°
)) {

183 
	`wrôe_u∆ock
(&
fs_öfo
->
åì_mod_log_lock
);

184  
åue
;

187  
Ál£
;

188 
	}
}

191 
ölöe
 
boﬁ
 
	$åì_mod_√ed_log
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

192 
exã¡_buf„r
 *
eb
)

194 i‡(!
	`ã°_bô
(
BTRFS_FS_TREE_MOD_LOG_USERS
, &
fs_öfo
->
Êags
))

195  
Ál£
;

196 i‡(
eb
 && 
	`båfs_hódî_Àvñ
(eb) == 0)

197  
Ál£
;

199  
åue
;

200 
	}
}

202 
åì_mod_ñem
 *
	$Æloc_åì_mod_ñem
(
exã¡_buf„r
 *
eb
,

203 
¶Ÿ
,

204 
båfs_mod_log_›
 
›
)

206 
åì_mod_ñem
 *
tm
;

208 
tm
 = 
	`kzÆloc
((*tm), 
GFP_NOFS
);

209 i‡(!
tm
)

210  
NULL
;

212 
tm
->
logiˇl
 = 
eb
->
°¨t
;

213 i‡(
›
 !
BTRFS_MOD_LOG_KEY_ADD
) {

214 
	`båfs_node_key
(
eb
, &
tm
->
key
, 
¶Ÿ
);

215 
tm
->
block±r
 = 
	`båfs_node_block±r
(
eb
, 
¶Ÿ
);

217 
tm
->
›
 = op;

218 
tm
->
¶Ÿ
 = slot;

219 
tm
->
gíî©i⁄
 = 
	`båfs_node_±r_gíî©i⁄
(
eb
, 
¶Ÿ
);

220 
	`RB_CLEAR_NODE
(&
tm
->
node
);

222  
tm
;

223 
	}
}

225 
	$båfs_åì_mod_log_ö£π_key
(
exã¡_buf„r
 *
eb
, 
¶Ÿ
,

226 
båfs_mod_log_›
 
›
)

228 
åì_mod_ñem
 *
tm
;

229 
ªt
 = 0;

231 i‡(!
	`åì_mod_√ed_log
(
eb
->
fs_öfo
,Éb))

234 
tm
 = 
	`Æloc_åì_mod_ñem
(
eb
, 
¶Ÿ
, 
›
);

235 i‡(!
tm
)

236 
ªt
 = -
ENOMEM
;

238 i‡(
	`åì_mod_d⁄t_log
(
eb
->
fs_öfo
,Éb)) {

239 
	`k‰ì
(
tm
);

245 } i‡(
ªt
 != 0) {

250 
out_u∆ock
;

253 
ªt
 = 
	`åì_mod_log_ö£π
(
eb
->
fs_öfo
, 
tm
);

254 
out_u∆ock
:

255 
	`wrôe_u∆ock
(&
eb
->
fs_öfo
->
åì_mod_log_lock
);

256 i‡(
ªt
)

257 
	`k‰ì
(
tm
);

259  
ªt
;

260 
	}
}

262 
åì_mod_ñem
 *
	$åì_mod_log_Æloc_move
(
exã¡_buf„r
 *
eb
,

263 
d°_¶Ÿ
, 
§c_¶Ÿ
,

264 
ƒ_ôems
)

266 
åì_mod_ñem
 *
tm
;

268 
tm
 = 
	`kzÆloc
((*tm), 
GFP_NOFS
);

269 i‡(!
tm
)

270  
	`ERR_PTR
(-
ENOMEM
);

272 
tm
->
logiˇl
 = 
eb
->
°¨t
;

273 
tm
->
¶Ÿ
 = 
§c_¶Ÿ
;

274 
tm
->
move
.
d°_¶Ÿ
 = dst_slot;

275 
tm
->
move
.
ƒ_ôems
 =Çr_items;

276 
tm
->
›
 = 
BTRFS_MOD_LOG_MOVE_KEYS
;

277 
	`RB_CLEAR_NODE
(&
tm
->
node
);

279  
tm
;

280 
	}
}

282 
	$båfs_åì_mod_log_ö£π_move
(
exã¡_buf„r
 *
eb
,

283 
d°_¶Ÿ
, 
§c_¶Ÿ
,

284 
ƒ_ôems
)

286 
åì_mod_ñem
 *
tm
 = 
NULL
;

287 
åì_mod_ñem
 **
tm_li°
 = 
NULL
;

288 
ªt
 = 0;

289 
i
;

290 
boﬁ
 
locked
 = 
Ál£
;

292 i‡(!
	`åì_mod_√ed_log
(
eb
->
fs_öfo
,Éb))

295 
tm_li°
 = 
	`kˇŒoc
(
ƒ_ôems
, (
åì_mod_ñem
 *), 
GFP_NOFS
);

296 i‡(!
tm_li°
) {

297 
ªt
 = -
ENOMEM
;

298 
lock
;

301 
tm
 = 
	`åì_mod_log_Æloc_move
(
eb
, 
d°_¶Ÿ
, 
§c_¶Ÿ
, 
ƒ_ôems
);

302 i‡(
	`IS_ERR
(
tm
)) {

303 
ªt
 = 
	`PTR_ERR
(
tm
);

304 
tm
 = 
NULL
;

305 
lock
;

308 
i
 = 0; i + 
d°_¶Ÿ
 < 
§c_¶Ÿ
 && i < 
ƒ_ôems
; i++) {

309 
tm_li°
[
i
] = 
	`Æloc_åì_mod_ñem
(
eb
, i + 
d°_¶Ÿ
,

310 
BTRFS_MOD_LOG_KEY_REMOVE_WHILE_MOVING
);

311 i‡(!
tm_li°
[
i
]) {

312 
ªt
 = -
ENOMEM
;

313 
lock
;

317 
lock
:

318 i‡(
	`åì_mod_d⁄t_log
(
eb
->
fs_öfo
,Éb)) {

323 
ªt
 = 0;

324 
‰ì_tms
;

326 
locked
 = 
åue
;

332 i‡(
ªt
 != 0)

333 
‰ì_tms
;

340 
i
 = 0; i + 
d°_¶Ÿ
 < 
§c_¶Ÿ
 && i < 
ƒ_ôems
; i++) {

341 
ªt
 = 
	`åì_mod_log_ö£π
(
eb
->
fs_öfo
, 
tm_li°
[
i
]);

342 i‡(
ªt
)

343 
‰ì_tms
;

346 
ªt
 = 
	`åì_mod_log_ö£π
(
eb
->
fs_öfo
, 
tm
);

347 i‡(
ªt
)

348 
‰ì_tms
;

349 
	`wrôe_u∆ock
(&
eb
->
fs_öfo
->
åì_mod_log_lock
);

350 
	`k‰ì
(
tm_li°
);

354 
‰ì_tms
:

355 i‡(
tm_li°
) {

356 
i
 = 0; i < 
ƒ_ôems
; i++) {

357 i‡(
tm_li°
[
i
] && !
	`RB_EMPTY_NODE
(&tm_li°[i]->
node
))

358 
	`rb_îa£
(&
tm_li°
[
i
]->
node
, &
eb
->
fs_öfo
->
åì_mod_log
);

359 
	`k‰ì
(
tm_li°
[
i
]);

362 i‡(
locked
)

363 
	`wrôe_u∆ock
(&
eb
->
fs_öfo
->
åì_mod_log_lock
);

364 
	`k‰ì
(
tm_li°
);

365 
	`k‰ì
(
tm
);

367  
ªt
;

368 
	}
}

370 
ölöe
 
	$åì_mod_log_‰ì_eb
(
båfs_fs_öfo
 *
fs_öfo
,

371 
åì_mod_ñem
 **
tm_li°
,

372 
ƒôems
)

374 
i
, 
j
;

375 
ªt
;

377 
i
 = 
ƒôems
 - 1; i >= 0; i--) {

378 
ªt
 = 
	`åì_mod_log_ö£π
(
fs_öfo
, 
tm_li°
[
i
]);

379 i‡(
ªt
) {

380 
j
 = 
ƒôems
 - 1; j > 
i
; j--)

381 
	`rb_îa£
(&
tm_li°
[
j
]->
node
,

382 &
fs_öfo
->
åì_mod_log
);

383  
ªt
;

388 
	}
}

390 
	$båfs_åì_mod_log_ö£π_roŸ
(
exã¡_buf„r
 *
ﬁd_roŸ
,

391 
exã¡_buf„r
 *
√w_roŸ
,

392 
boﬁ
 
log_ªmovÆ
)

394 
båfs_fs_öfo
 *
fs_öfo
 = 
ﬁd_roŸ
->fs_info;

395 
åì_mod_ñem
 *
tm
 = 
NULL
;

396 
åì_mod_ñem
 **
tm_li°
 = 
NULL
;

397 
ƒôems
 = 0;

398 
ªt
 = 0;

399 
i
;

401 i‡(!
	`åì_mod_√ed_log
(
fs_öfo
, 
NULL
))

404 i‡(
log_ªmovÆ
 && 
	`båfs_hódî_Àvñ
(
ﬁd_roŸ
) > 0) {

405 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
ﬁd_roŸ
);

406 
tm_li°
 = 
	`kˇŒoc
(
ƒôems
, (
åì_mod_ñem
 *),

407 
GFP_NOFS
);

408 i‡(!
tm_li°
) {

409 
ªt
 = -
ENOMEM
;

410 
lock
;

412 
i
 = 0; i < 
ƒôems
; i++) {

413 
tm_li°
[
i
] = 
	`Æloc_åì_mod_ñem
(
ﬁd_roŸ
, i,

414 
BTRFS_MOD_LOG_KEY_REMOVE_WHILE_FREEING
);

415 i‡(!
tm_li°
[
i
]) {

416 
ªt
 = -
ENOMEM
;

417 
lock
;

422 
tm
 = 
	`kzÆloc
((*tm), 
GFP_NOFS
);

423 i‡(!
tm
) {

424 
ªt
 = -
ENOMEM
;

425 
lock
;

428 
tm
->
logiˇl
 = 
√w_roŸ
->
°¨t
;

429 
tm
->
ﬁd_roŸ
.
logiˇl
 = old_roŸ->
°¨t
;

430 
tm
->
ﬁd_roŸ
.
Àvñ
 = 
	`båfs_hódî_Àvñ
(old_root);

431 
tm
->
gíî©i⁄
 = 
	`båfs_hódî_gíî©i⁄
(
ﬁd_roŸ
);

432 
tm
->
›
 = 
BTRFS_MOD_LOG_ROOT_REPLACE
;

434 
lock
:

435 i‡(
	`åì_mod_d⁄t_log
(
fs_öfo
, 
NULL
)) {

440 
ªt
 = 0;

441 
‰ì_tms
;

442 } i‡(
ªt
 != 0) {

447 
out_u∆ock
;

450 i‡(
tm_li°
)

451 
ªt
 = 
	`åì_mod_log_‰ì_eb
(
fs_öfo
, 
tm_li°
, 
ƒôems
);

452 i‡(!
ªt
)

453 
ªt
 = 
	`åì_mod_log_ö£π
(
fs_öfo
, 
tm
);

455 
out_u∆ock
:

456 
	`wrôe_u∆ock
(&
fs_öfo
->
åì_mod_log_lock
);

457 i‡(
ªt
)

458 
‰ì_tms
;

459 
	`k‰ì
(
tm_li°
);

461  
ªt
;

463 
‰ì_tms
:

464 i‡(
tm_li°
) {

465 
i
 = 0; i < 
ƒôems
; i++)

466 
	`k‰ì
(
tm_li°
[
i
]);

467 
	`k‰ì
(
tm_li°
);

469 
	`k‰ì
(
tm
);

471  
ªt
;

472 
	}
}

474 
åì_mod_ñem
 *
	$__åì_mod_log_£¨ch
(
båfs_fs_öfo
 *
fs_öfo
,

475 
u64
 
°¨t
, u64 
mö_£q
,

476 
boﬁ
 
smÆÀ°
)

478 
rb_roŸ
 *
tm_roŸ
;

479 
rb_node
 *
node
;

480 
åì_mod_ñem
 *
cur
 = 
NULL
;

481 
åì_mod_ñem
 *
found
 = 
NULL
;

483 
	`ªad_lock
(&
fs_öfo
->
åì_mod_log_lock
);

484 
tm_roŸ
 = &
fs_öfo
->
åì_mod_log
;

485 
node
 = 
tm_roŸ
->
rb_node
;

486 
node
) {

487 
cur
 = 
	`rb_íåy
(
node
, 
åì_mod_ñem
,Çode);

488 i‡(
cur
->
logiˇl
 < 
°¨t
) {

489 
node
 =Çode->
rb_À·
;

490 } i‡(
cur
->
logiˇl
 > 
°¨t
) {

491 
node
 =Çode->
rb_right
;

492 } i‡(
cur
->
£q
 < 
mö_£q
) {

493 
node
 =Çode->
rb_À·
;

494 } i‡(!
smÆÀ°
) {

496 i‡(
found
)

497 
	`BUG_ON
(
found
->
£q
 > 
cur
->seq);

498 
found
 = 
cur
;

499 
node
 =Çode->
rb_À·
;

500 } i‡(
cur
->
£q
 > 
mö_£q
) {

502 i‡(
found
)

503 
	`BUG_ON
(
found
->
£q
 < 
cur
->seq);

504 
found
 = 
cur
;

505 
node
 =Çode->
rb_right
;

507 
found
 = 
cur
;

511 
	`ªad_u∆ock
(&
fs_öfo
->
åì_mod_log_lock
);

513  
found
;

514 
	}
}

521 
åì_mod_ñem
 *
	$åì_mod_log_£¨ch_ﬁde°
(
båfs_fs_öfo
 *
fs_öfo
,

522 
u64
 
°¨t
, u64 
mö_£q
)

524  
	`__åì_mod_log_£¨ch
(
fs_öfo
, 
°¨t
, 
mö_£q
, 
åue
);

525 
	}
}

532 
åì_mod_ñem
 *
	$åì_mod_log_£¨ch
(
båfs_fs_öfo
 *
fs_öfo
,

533 
u64
 
°¨t
, u64 
mö_£q
)

535  
	`__åì_mod_log_£¨ch
(
fs_öfo
, 
°¨t
, 
mö_£q
, 
Ál£
);

536 
	}
}

538 
	$båfs_åì_mod_log_eb_c›y
(
exã¡_buf„r
 *
d°
,

539 
exã¡_buf„r
 *
§c
,

540 
d°_off£t
,

541 
§c_off£t
,

542 
ƒ_ôems
)

544 
båfs_fs_öfo
 *
fs_öfo
 = 
d°
->fs_info;

545 
ªt
 = 0;

546 
åì_mod_ñem
 **
tm_li°
 = 
NULL
;

547 
åì_mod_ñem
 **
tm_li°_add
 = 
NULL
;

548 
åì_mod_ñem
 **
tm_li°_ªm
 = 
NULL
;

549 
i
;

550 
boﬁ
 
locked
 = 
Ál£
;

551 
åì_mod_ñem
 *
d°_move_tm
 = 
NULL
;

552 
åì_mod_ñem
 *
§c_move_tm
 = 
NULL
;

553 
u32
 
d°_move_ƒ_ôems
 = 
	`båfs_hódî_ƒôems
(
d°
Ë- 
d°_off£t
;

554 
u32
 
§c_move_ƒ_ôems
 = 
	`båfs_hódî_ƒôems
(
§c
Ë- (
§c_off£t
 + 
ƒ_ôems
);

556 i‡(!
	`åì_mod_√ed_log
(
fs_öfo
, 
NULL
))

559 i‡(
	`båfs_hódî_Àvñ
(
d°
Ë=0 && båfs_hódî_Àvñ(
§c
) == 0)

562 
tm_li°
 = 
	`kˇŒoc
(
ƒ_ôems
 * 2, (
åì_mod_ñem
 *),

563 
GFP_NOFS
);

564 i‡(!
tm_li°
) {

565 
ªt
 = -
ENOMEM
;

566 
lock
;

569 i‡(
d°_move_ƒ_ôems
) {

570 
d°_move_tm
 = 
	`åì_mod_log_Æloc_move
(
d°
, 
d°_off£t
 + 
ƒ_ôems
,

571 
d°_off£t
, 
d°_move_ƒ_ôems
);

572 i‡(
	`IS_ERR
(
d°_move_tm
)) {

573 
ªt
 = 
	`PTR_ERR
(
d°_move_tm
);

574 
d°_move_tm
 = 
NULL
;

575 
lock
;

578 i‡(
§c_move_ƒ_ôems
) {

579 
§c_move_tm
 = 
	`åì_mod_log_Æloc_move
(
§c
, 
§c_off£t
,

580 
§c_off£t
 + 
ƒ_ôems
,

581 
§c_move_ƒ_ôems
);

582 i‡(
	`IS_ERR
(
§c_move_tm
)) {

583 
ªt
 = 
	`PTR_ERR
(
§c_move_tm
);

584 
§c_move_tm
 = 
NULL
;

585 
lock
;

589 
tm_li°_add
 = 
tm_li°
;

590 
tm_li°_ªm
 = 
tm_li°
 + 
ƒ_ôems
;

591 
i
 = 0; i < 
ƒ_ôems
; i++) {

592 
tm_li°_ªm
[
i
] = 
	`Æloc_åì_mod_ñem
(
§c
, i + 
§c_off£t
,

593 
BTRFS_MOD_LOG_KEY_REMOVE
);

594 i‡(!
tm_li°_ªm
[
i
]) {

595 
ªt
 = -
ENOMEM
;

596 
lock
;

599 
tm_li°_add
[
i
] = 
	`Æloc_åì_mod_ñem
(
d°
, i + 
d°_off£t
,

600 
BTRFS_MOD_LOG_KEY_ADD
);

601 i‡(!
tm_li°_add
[
i
]) {

602 
ªt
 = -
ENOMEM
;

603 
lock
;

607 
lock
:

608 i‡(
	`åì_mod_d⁄t_log
(
fs_öfo
, 
NULL
)) {

613 
ªt
 = 0;

614 
‰ì_tms
;

616 
locked
 = 
åue
;

622 i‡(
ªt
 != 0)

623 
‰ì_tms
;

625 i‡(
d°_move_tm
) {

626 
ªt
 = 
	`åì_mod_log_ö£π
(
fs_öfo
, 
d°_move_tm
);

627 i‡(
ªt
)

628 
‰ì_tms
;

630 
i
 = 0; i < 
ƒ_ôems
; i++) {

631 
ªt
 = 
	`åì_mod_log_ö£π
(
fs_öfo
, 
tm_li°_ªm
[
i
]);

632 i‡(
ªt
)

633 
‰ì_tms
;

634 
ªt
 = 
	`åì_mod_log_ö£π
(
fs_öfo
, 
tm_li°_add
[
i
]);

635 i‡(
ªt
)

636 
‰ì_tms
;

638 i‡(
§c_move_tm
) {

639 
ªt
 = 
	`åì_mod_log_ö£π
(
fs_öfo
, 
§c_move_tm
);

640 i‡(
ªt
)

641 
‰ì_tms
;

644 
	`wrôe_u∆ock
(&
fs_öfo
->
åì_mod_log_lock
);

645 
	`k‰ì
(
tm_li°
);

649 
‰ì_tms
:

650 i‡(
d°_move_tm
 && !
	`RB_EMPTY_NODE
(&d°_move_tm->
node
))

651 
	`rb_îa£
(&
d°_move_tm
->
node
, &
fs_öfo
->
åì_mod_log
);

652 
	`k‰ì
(
d°_move_tm
);

653 i‡(
§c_move_tm
 && !
	`RB_EMPTY_NODE
(&§c_move_tm->
node
))

654 
	`rb_îa£
(&
§c_move_tm
->
node
, &
fs_öfo
->
åì_mod_log
);

655 
	`k‰ì
(
§c_move_tm
);

656 i‡(
tm_li°
) {

657 
i
 = 0; i < 
ƒ_ôems
 * 2; i++) {

658 i‡(
tm_li°
[
i
] && !
	`RB_EMPTY_NODE
(&tm_li°[i]->
node
))

659 
	`rb_îa£
(&
tm_li°
[
i
]->
node
, &
fs_öfo
->
åì_mod_log
);

660 
	`k‰ì
(
tm_li°
[
i
]);

663 i‡(
locked
)

664 
	`wrôe_u∆ock
(&
fs_öfo
->
åì_mod_log_lock
);

665 
	`k‰ì
(
tm_li°
);

667  
ªt
;

668 
	}
}

670 
	$båfs_åì_mod_log_‰ì_eb
(
exã¡_buf„r
 *
eb
)

672 
åì_mod_ñem
 **
tm_li°
 = 
NULL
;

673 
ƒôems
 = 0;

674 
i
;

675 
ªt
 = 0;

677 i‡(!
	`åì_mod_√ed_log
(
eb
->
fs_öfo
,Éb))

680 
ƒôems
 = 
	`båfs_hódî_ƒôems
(
eb
);

681 
tm_li°
 = 
	`kˇŒoc
(
ƒôems
, (
åì_mod_ñem
 *), 
GFP_NOFS
);

682 i‡(!
tm_li°
) {

683 
ªt
 = -
ENOMEM
;

684 
lock
;

687 
i
 = 0; i < 
ƒôems
; i++) {

688 
tm_li°
[
i
] = 
	`Æloc_åì_mod_ñem
(
eb
, i,

689 
BTRFS_MOD_LOG_KEY_REMOVE_WHILE_FREEING
);

690 i‡(!
tm_li°
[
i
]) {

691 
ªt
 = -
ENOMEM
;

692 
lock
;

696 
lock
:

697 i‡(
	`åì_mod_d⁄t_log
(
eb
->
fs_öfo
,Éb)) {

702 
ªt
 = 0;

703 
‰ì_tms
;

704 } i‡(
ªt
 != 0) {

709 
out_u∆ock
;

712 
ªt
 = 
	`åì_mod_log_‰ì_eb
(
eb
->
fs_öfo
, 
tm_li°
, 
ƒôems
);

713 
out_u∆ock
:

714 
	`wrôe_u∆ock
(&
eb
->
fs_öfo
->
åì_mod_log_lock
);

715 i‡(
ªt
)

716 
‰ì_tms
;

717 
	`k‰ì
(
tm_li°
);

721 
‰ì_tms
:

722 i‡(
tm_li°
) {

723 
i
 = 0; i < 
ƒôems
; i++)

724 
	`k‰ì
(
tm_li°
[
i
]);

725 
	`k‰ì
(
tm_li°
);

728  
ªt
;

729 
	}
}

735 
åì_mod_ñem
 *
	$åì_mod_log_ﬁde°_roŸ
(
exã¡_buf„r
 *
eb_roŸ
,

736 
u64
 
time_£q
)

738 
åì_mod_ñem
 *
tm
;

739 
åì_mod_ñem
 *
found
 = 
NULL
;

740 
u64
 
roŸ_logiˇl
 = 
eb_roŸ
->
°¨t
;

741 
boﬁ
 
lo›ed
 = 
Ál£
;

743 i‡(!
time_£q
)

744  
NULL
;

753 
tm
 = 
	`åì_mod_log_£¨ch_ﬁde°
(
eb_roŸ
->
fs_öfo
, 
roŸ_logiˇl
,

754 
time_£q
);

755 i‡(!
lo›ed
 && !
tm
)

756  
NULL
;

762 i‡(!
tm
)

770 i‡(
tm
->
›
 !
BTRFS_MOD_LOG_ROOT_REPLACE
)

773 
found
 = 
tm
;

774 
roŸ_logiˇl
 = 
tm
->
ﬁd_roŸ
.
logiˇl
;

775 
lo›ed
 = 
åue
;

779 i‡(!
found
)

780 
found
 = 
tm
;

782  
found
;

783 
	}
}

791 
	$åì_mod_log_ªwöd
(
båfs_fs_öfo
 *
fs_öfo
,

792 
exã¡_buf„r
 *
eb
,

793 
u64
 
time_£q
,

794 
åì_mod_ñem
 *
fú°_tm
)

796 
u32
 
n
;

797 
rb_node
 *
√xt
;

798 
åì_mod_ñem
 *
tm
 = 
fú°_tm
;

799 
o_d°
;

800 
o_§c
;

801 
p_size
 = (
båfs_key_±r
);

814 
max_¶Ÿ
;

815 
move_§c_íd_¶Ÿ
;

816 
move_d°_íd_¶Ÿ
;

818 
n
 = 
	`båfs_hódî_ƒôems
(
eb
);

819 
max_¶Ÿ
 = 
n
 - 1;

820 
	`ªad_lock
(&
fs_öfo
->
åì_mod_log_lock
);

821 
tm
 &&Åm->
£q
 >
time_£q
) {

822 
	`ASSERT
(
max_¶Ÿ
 >= -1);

828 
tm
->
›
) {

829 
BTRFS_MOD_LOG_KEY_REMOVE_WHILE_FREEING
:

830 
	`BUG_ON
(
tm
->
¶Ÿ
 < 
n
);

831 
ÁŒthrough
;

832 
BTRFS_MOD_LOG_KEY_REMOVE_WHILE_MOVING
:

833 
BTRFS_MOD_LOG_KEY_REMOVE
:

834 
	`båfs_£t_node_key
(
eb
, &
tm
->
key
,Åm->
¶Ÿ
);

835 
	`båfs_£t_node_block±r
(
eb
, 
tm
->
¶Ÿ
,Åm->
block±r
);

836 
	`båfs_£t_node_±r_gíî©i⁄
(
eb
, 
tm
->
¶Ÿ
,

837 
tm
->
gíî©i⁄
);

838 
n
++;

839 i‡(
tm
->
¶Ÿ
 > 
max_¶Ÿ
)

840 
max_¶Ÿ
 = 
tm
->
¶Ÿ
;

842 
BTRFS_MOD_LOG_KEY_REPLACE
:

843 
	`BUG_ON
(
tm
->
¶Ÿ
 >
n
);

844 
	`båfs_£t_node_key
(
eb
, &
tm
->
key
,Åm->
¶Ÿ
);

845 
	`båfs_£t_node_block±r
(
eb
, 
tm
->
¶Ÿ
,Åm->
block±r
);

846 
	`båfs_£t_node_±r_gíî©i⁄
(
eb
, 
tm
->
¶Ÿ
,

847 
tm
->
gíî©i⁄
);

849 
BTRFS_MOD_LOG_KEY_ADD
:

859 i‡(
tm
->
¶Ÿ
 =
max_¶Ÿ
)

860 
max_¶Ÿ
--;

862 
n
--;

864 
BTRFS_MOD_LOG_MOVE_KEYS
:

865 
	`ASSERT
(
tm
->
move
.
ƒ_ôems
 > 0);

866 
move_§c_íd_¶Ÿ
 = 
tm
->
move
.
d°_¶Ÿ
 +Åm->move.
ƒ_ôems
 - 1;

867 
move_d°_íd_¶Ÿ
 = 
tm
->
¶Ÿ
 +Åm->
move
.
ƒ_ôems
 - 1;

868 
o_d°
 = 
	`båfs_node_key_±r_off£t
(
eb
, 
tm
->
¶Ÿ
);

869 
o_§c
 = 
	`båfs_node_key_±r_off£t
(
eb
, 
tm
->
move
.
d°_¶Ÿ
);

870 i‡(
	`WARN_ON
(
move_§c_íd_¶Ÿ
 > 
max_¶Ÿ
 ||

871 
tm
->
move
.
ƒ_ôems
 <= 0)) {

872 
	`båfs_w¨n
(
fs_öfo
,

874 
eb
->
°¨t
, 
tm
->
¶Ÿ
,

875 
tm
->
move
.
d°_¶Ÿ
,Åm->move.
ƒ_ôems
,

876 
tm
->
£q
, 
n
, 
max_¶Ÿ
);

878 
	`memmove_exã¡_buf„r
(
eb
, 
o_d°
, 
o_§c
,

879 
tm
->
move
.
ƒ_ôems
 * 
p_size
);

880 
max_¶Ÿ
 = 
move_d°_íd_¶Ÿ
;

882 
BTRFS_MOD_LOG_ROOT_REPLACE
:

894 
√xt
 = 
	`rb_√xt
(&
tm
->
node
);

895 i‡(!
√xt
)

897 
tm
 = 
	`rb_íåy
(
√xt
, 
åì_mod_ñem
, 
node
);

898 i‡(
tm
->
logiˇl
 !
fú°_tm
->logical)

901 
	`ªad_u∆ock
(&
fs_öfo
->
åì_mod_log_lock
);

902 
	`båfs_£t_hódî_ƒôems
(
eb
, 
n
);

903 
	}
}

912 
exã¡_buf„r
 *
	$båfs_åì_mod_log_ªwöd
(
båfs_fs_öfo
 *
fs_öfo
,

913 
båfs_∑th
 *
∑th
,

914 
exã¡_buf„r
 *
eb
,

915 
u64
 
time_£q
)

917 
exã¡_buf„r
 *
eb_ªwö
;

918 
åì_mod_ñem
 *
tm
;

920 i‡(!
time_£q
)

921  
eb
;

923 i‡(
	`båfs_hódî_Àvñ
(
eb
) == 0)

924  
eb
;

926 
tm
 = 
	`åì_mod_log_£¨ch
(
fs_öfo
, 
eb
->
°¨t
, 
time_£q
);

927 i‡(!
tm
)

928  
eb
;

930 i‡(
tm
->
›
 =
BTRFS_MOD_LOG_KEY_REMOVE_WHILE_FREEING
) {

931 
	`BUG_ON
(
tm
->
¶Ÿ
 != 0);

932 
eb_ªwö
 = 
	`Æloc_dummy_exã¡_buf„r
(
fs_öfo
, 
eb
->
°¨t
);

933 i‡(!
eb_ªwö
) {

934 
	`båfs_åì_ªad_u∆ock
(
eb
);

935 
	`‰ì_exã¡_buf„r
(
eb
);

936  
NULL
;

938 
	`båfs_£t_hódî_byãƒ
(
eb_ªwö
, 
eb
->
°¨t
);

939 
	`båfs_£t_hódî_backªf_ªv
(
eb_ªwö
,

940 
	`båfs_hódî_backªf_ªv
(
eb
));

941 
	`båfs_£t_hódî_ow√r
(
eb_ªwö
, 
	`båfs_hódî_ow√r
(
eb
));

942 
	`båfs_£t_hódî_Àvñ
(
eb_ªwö
, 
	`båfs_hódî_Àvñ
(
eb
));

944 
eb_ªwö
 = 
	`båfs_˛⁄e_exã¡_buf„r
(
eb
);

945 i‡(!
eb_ªwö
) {

946 
	`båfs_åì_ªad_u∆ock
(
eb
);

947 
	`‰ì_exã¡_buf„r
(
eb
);

948  
NULL
;

952 
	`båfs_åì_ªad_u∆ock
(
eb
);

953 
	`‰ì_exã¡_buf„r
(
eb
);

955 
	`båfs_£t_buf„r_lockdï_˛ass
(
	`båfs_hódî_ow√r
(
eb_ªwö
),

956 
eb_ªwö
, 
	`båfs_hódî_Àvñ
(eb_rewin));

957 
	`båfs_åì_ªad_lock
(
eb_ªwö
);

958 
	`åì_mod_log_ªwöd
(
fs_öfo
, 
eb_ªwö
, 
time_£q
, 
tm
);

959 
	`WARN_ON
(
	`båfs_hódî_ƒôems
(
eb_ªwö
) >

960 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_öfo
));

962  
eb_ªwö
;

963 
	}
}

972 
exã¡_buf„r
 *
	$båfs_gë_ﬁd_roŸ
(
båfs_roŸ
 *
roŸ
, 
u64
 
time_£q
)

974 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

975 
åì_mod_ñem
 *
tm
;

976 
exã¡_buf„r
 *
eb
 = 
NULL
;

977 
exã¡_buf„r
 *
eb_roŸ
;

978 
u64
 
eb_roŸ_ow√r
 = 0;

979 
exã¡_buf„r
 *
ﬁd
;

980 
åì_mod_roŸ
 *
ﬁd_roŸ
 = 
NULL
;

981 
u64
 
ﬁd_gíî©i⁄
 = 0;

982 
u64
 
logiˇl
;

983 
Àvñ
;

985 
eb_roŸ
 = 
	`båfs_ªad_lock_roŸ_node
(
roŸ
);

986 
tm
 = 
	`åì_mod_log_ﬁde°_roŸ
(
eb_roŸ
, 
time_£q
);

987 i‡(!
tm
)

988  
eb_roŸ
;

990 i‡(
tm
->
›
 =
BTRFS_MOD_LOG_ROOT_REPLACE
) {

991 
ﬁd_roŸ
 = &
tm
->old_root;

992 
ﬁd_gíî©i⁄
 = 
tm
->
gíî©i⁄
;

993 
logiˇl
 = 
ﬁd_roŸ
->logical;

994 
Àvñ
 = 
ﬁd_roŸ
->level;

996 
logiˇl
 = 
eb_roŸ
->
°¨t
;

997 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
eb_roŸ
);

1000 
tm
 = 
	`åì_mod_log_£¨ch
(
fs_öfo
, 
logiˇl
, 
time_£q
);

1001 i‡(
ﬁd_roŸ
 && 
tm
 &&Åm->
›
 !
BTRFS_MOD_LOG_KEY_REMOVE_WHILE_FREEING
) {

1002 
båfs_åì_∑ª¡_check
 
check
 = { 0 };

1004 
	`båfs_åì_ªad_u∆ock
(
eb_roŸ
);

1005 
	`‰ì_exã¡_buf„r
(
eb_roŸ
);

1007 
check
.
Àvñ
 =Üevel;

1008 
check
.
ow√r_roŸ
 = 
roŸ
->
roŸ_key
.
obje˘id
;

1010 
ﬁd
 = 
	`ªad_åì_block
(
fs_öfo
, 
logiˇl
, &
check
);

1011 i‡(
	`WARN_ON
(
	`IS_ERR
(
ﬁd
Ë|| !
	`exã¡_buf„r_u±od©e
(old))) {

1012 i‡(!
	`IS_ERR
(
ﬁd
))

1013 
	`‰ì_exã¡_buf„r
(
ﬁd
);

1014 
	`båfs_w¨n
(
fs_öfo
,

1016 
logiˇl
);

1018 
åì_mod_ñem
 *
tm2
;

1020 
	`båfs_åì_ªad_lock
(
ﬁd
);

1021 
eb
 = 
	`båfs_˛⁄e_exã¡_buf„r
(
ﬁd
);

1032 
tm2
 = 
	`åì_mod_log_£¨ch
(
fs_öfo
, 
logiˇl
, 
time_£q
);

1033 
	`båfs_åì_ªad_u∆ock
(
ﬁd
);

1034 
	`‰ì_exã¡_buf„r
(
ﬁd
);

1035 
	`ASSERT
(
tm2
);

1036 
	`ASSERT
(
tm2
 =
tm
 ||Åm2->
£q
 >Åm->seq);

1037 i‡(!
tm2
 ||Åm2->
£q
 < 
tm
->seq) {

1038 
	`‰ì_exã¡_buf„r
(
eb
);

1039  
NULL
;

1041 
tm
 = 
tm2
;

1043 } i‡(
ﬁd_roŸ
) {

1044 
eb_roŸ_ow√r
 = 
	`båfs_hódî_ow√r
(
eb_roŸ
);

1045 
	`båfs_åì_ªad_u∆ock
(
eb_roŸ
);

1046 
	`‰ì_exã¡_buf„r
(
eb_roŸ
);

1047 
eb
 = 
	`Æloc_dummy_exã¡_buf„r
(
fs_öfo
, 
logiˇl
);

1049 
eb
 = 
	`båfs_˛⁄e_exã¡_buf„r
(
eb_roŸ
);

1050 
	`båfs_åì_ªad_u∆ock
(
eb_roŸ
);

1051 
	`‰ì_exã¡_buf„r
(
eb_roŸ
);

1054 i‡(!
eb
)

1055  
NULL
;

1056 i‡(
ﬁd_roŸ
) {

1057 
	`båfs_£t_hódî_byãƒ
(
eb
,Éb->
°¨t
);

1058 
	`båfs_£t_hódî_backªf_ªv
(
eb
, 
BTRFS_MIXED_BACKREF_REV
);

1059 
	`båfs_£t_hódî_ow√r
(
eb
, 
eb_roŸ_ow√r
);

1060 
	`båfs_£t_hódî_Àvñ
(
eb
, 
ﬁd_roŸ
->
Àvñ
);

1061 
	`båfs_£t_hódî_gíî©i⁄
(
eb
, 
ﬁd_gíî©i⁄
);

1063 
	`båfs_£t_buf„r_lockdï_˛ass
(
	`båfs_hódî_ow√r
(
eb
),Éb,

1064 
	`båfs_hódî_Àvñ
(
eb
));

1065 
	`båfs_åì_ªad_lock
(
eb
);

1066 i‡(
tm
)

1067 
	`åì_mod_log_ªwöd
(
fs_öfo
, 
eb
, 
time_£q
, 
tm
);

1069 
	`WARN_ON
(
	`båfs_hódî_Àvñ
(
eb
) != 0);

1070 
	`WARN_ON
(
	`båfs_hódî_ƒôems
(
eb
Ë> 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_öfo
));

1072  
eb
;

1073 
	}
}

1075 
	$båfs_ﬁd_roŸ_Àvñ
(
båfs_roŸ
 *
roŸ
, 
u64
 
time_£q
)

1077 
åì_mod_ñem
 *
tm
;

1078 
Àvñ
;

1079 
exã¡_buf„r
 *
eb_roŸ
 = 
	`båfs_roŸ_node
(
roŸ
);

1081 
tm
 = 
	`åì_mod_log_ﬁde°_roŸ
(
eb_roŸ
, 
time_£q
);

1082 i‡(
tm
 &&Åm->
›
 =
BTRFS_MOD_LOG_ROOT_REPLACE
)

1083 
Àvñ
 = 
tm
->
ﬁd_roŸ
.level;

1085 
Àvñ
 = 
	`båfs_hódî_Àvñ
(
eb_roŸ
);

1087 
	`‰ì_exã¡_buf„r
(
eb_roŸ
);

1089  
Àvñ
;

1090 
	}
}

1099 
u64
 
	$båfs_åì_mod_log_lowe°_£q
(
båfs_fs_öfo
 *
fs_öfo
)

1101 
u64
 
ªt
 = 0;

1103 
	`ªad_lock
(&
fs_öfo
->
åì_mod_log_lock
);

1104 i‡(!
	`li°_em±y
(&
fs_öfo
->
åì_mod_£q_li°
)) {

1105 
båfs_£q_li°
 *
ñem
;

1107 
ñem
 = 
	`li°_fú°_íåy
(&
fs_öfo
->
åì_mod_£q_li°
,

1108 
båfs_£q_li°
, 
li°
);

1109 
ªt
 = 
ñem
->
£q
;

1111 
	`ªad_u∆ock
(&
fs_öfo
->
åì_mod_log_lock
);

1113  
ªt
;

1114 
	}
}

	@tree-mod-log.h

3 #i‚de‡
BTRFS_TREE_MOD_LOG_H


4 
	#BTRFS_TREE_MOD_LOG_H


	)

6 
	~"˘ªe.h
"

9 
	sbåfs_£q_li°
 {

10 
li°_hód
 
	mli°
;

11 
u64
 
	m£q
;

14 
	#BTRFS_SEQ_LIST_INIT
(
«me
Ë{ .
li°
 = 
	`LIST_HEAD_INIT
(“ame).li°), .
£q
 = 0 }

	)

15 
	#BTRFS_SEQ_LAST
 ((
u64
)-1)

	)

17 
	ebåfs_mod_log_›
 {

18 
	mBTRFS_MOD_LOG_KEY_REPLACE
,

19 
	mBTRFS_MOD_LOG_KEY_ADD
,

20 
	mBTRFS_MOD_LOG_KEY_REMOVE
,

21 
	mBTRFS_MOD_LOG_KEY_REMOVE_WHILE_FREEING
,

22 
	mBTRFS_MOD_LOG_KEY_REMOVE_WHILE_MOVING
,

23 
	mBTRFS_MOD_LOG_MOVE_KEYS
,

24 
	mBTRFS_MOD_LOG_ROOT_REPLACE
,

27 
u64
 
båfs_gë_åì_mod_£q
(
båfs_fs_öfo
 *
fs_öfo
,

28 
båfs_£q_li°
 *
ñem
);

29 
båfs_put_åì_mod_£q
(
båfs_fs_öfo
 *
fs_öfo
,

30 
båfs_£q_li°
 *
ñem
);

31 
båfs_åì_mod_log_ö£π_roŸ
(
exã¡_buf„r
 *
ﬁd_roŸ
,

32 
exã¡_buf„r
 *
√w_roŸ
,

33 
boﬁ
 
log_ªmovÆ
);

34 
båfs_åì_mod_log_ö£π_key
(
exã¡_buf„r
 *
eb
, 
¶Ÿ
,

35 
båfs_mod_log_›
 
›
);

36 
båfs_åì_mod_log_‰ì_eb
(
exã¡_buf„r
 *
eb
);

37 
exã¡_buf„r
 *
båfs_åì_mod_log_ªwöd
(
båfs_fs_öfo
 *
fs_öfo
,

38 
båfs_∑th
 *
∑th
,

39 
exã¡_buf„r
 *
eb
,

40 
u64
 
time_£q
);

41 
exã¡_buf„r
 *
båfs_gë_ﬁd_roŸ
(
båfs_roŸ
 *
roŸ
, 
u64
 
time_£q
);

42 
båfs_ﬁd_roŸ_Àvñ
(
båfs_roŸ
 *
roŸ
, 
u64
 
time_£q
);

43 
båfs_åì_mod_log_eb_c›y
(
exã¡_buf„r
 *
d°
,

44 
exã¡_buf„r
 *
§c
,

45 
d°_off£t
,

46 
§c_off£t
,

47 
ƒ_ôems
);

48 
båfs_åì_mod_log_ö£π_move
(
exã¡_buf„r
 *
eb
,

49 
d°_¶Ÿ
, 
§c_¶Ÿ
,

50 
ƒ_ôems
);

51 
u64
 
båfs_åì_mod_log_lowe°_£q
(
båfs_fs_öfo
 *
fs_öfo
);

	@ulist.c

7 
	~<löux/¶ab.h
>

8 
	~"mesßges.h
"

9 
	~"uli°.h
"

10 
	~"˘ªe.h
"

49 
	$uli°_öô
(
uli°
 *ulist)

51 
	`INIT_LIST_HEAD
(&
uli°
->
nodes
);

52 
uli°
->
roŸ
 = 
RB_ROOT
;

53 
uli°
->
¬odes
 = 0;

54 
	}
}

64 
	$uli°_ªÀa£
(
uli°
 *ulist)

66 
uli°_node
 *
node
;

67 
uli°_node
 *
√xt
;

69 
	`li°_f‹_óch_íåy_ß„
(
node
, 
√xt
, &
uli°
->
nodes
, 
li°
) {

70 
	`k‰ì
(
node
);

72 
uli°
->
roŸ
 = 
RB_ROOT
;

73 
	`INIT_LIST_HEAD
(&
uli°
->
nodes
);

74 
	}
}

84 
	$uli°_ªöô
(
uli°
 *ulist)

86 
	`uli°_ªÀa£
(
uli°
);

87 
	`uli°_öô
(
uli°
);

88 
	}
}

97 
uli°
 *
	$uli°_Æloc
(
gÂ_t
 
gÂ_mask
)

99 
uli°
 *uli° = 
	`kmÆloc
((*uli°), 
gÂ_mask
);

101 i‡(!
uli°
)

102  
NULL
;

104 
	`uli°_öô
(
uli°
);

106  
uli°
;

107 
	}
}

116 
	$uli°_‰ì
(
uli°
 *ulist)

118 i‡(!
uli°
)

120 
	`uli°_ªÀa£
(
uli°
);

121 
	`k‰ì
(
uli°
);

122 
	}
}

124 
uli°_node
 *
	$uli°_rbåì_£¨ch
(
uli°
 *uli°, 
u64
 
vÆ
)

126 
rb_node
 *
n
 = 
uli°
->
roŸ
.rb_node;

127 
uli°_node
 *
u
 = 
NULL
;

129 
n
) {

130 
u
 = 
	`rb_íåy
(
n
, 
uli°_node
, 
rb_node
);

131 i‡(
u
->
vÆ
 < val)

132 
n
 =Ç->
rb_right
;

133 i‡(
u
->
vÆ
 > val)

134 
n
 =Ç->
rb_À·
;

136  
u
;

138  
NULL
;

139 
	}
}

141 
	$uli°_rbåì_îa£
(
uli°
 *uli°, 
uli°_node
 *
node
)

143 
	`rb_îa£
(&
node
->
rb_node
, &
uli°
->
roŸ
);

144 
	`li°_dñ
(&
node
->
li°
);

145 
	`k‰ì
(
node
);

146 
	`BUG_ON
(
uli°
->
¬odes
 == 0);

147 
uli°
->
¬odes
--;

148 
	}
}

150 
	$uli°_rbåì_ö£π
(
uli°
 *uli°, 
uli°_node
 *
ös
)

152 
rb_node
 **
p
 = &
uli°
->
roŸ
.rb_node;

153 
rb_node
 *
∑ª¡
 = 
NULL
;

154 
uli°_node
 *
cur
 = 
NULL
;

156 *
p
) {

157 
∑ª¡
 = *
p
;

158 
cur
 = 
	`rb_íåy
(
∑ª¡
, 
uli°_node
, 
rb_node
);

160 i‡(
cur
->
vÆ
 < 
ös
->val)

161 
p
 = &(*p)->
rb_right
;

162 i‡(
cur
->
vÆ
 > 
ös
->val)

163 
p
 = &(*p)->
rb_À·
;

165  -
EEXIST
;

167 
	`rb_lök_node
(&
ös
->
rb_node
, 
∑ª¡
, 
p
);

168 
	`rb_ö£π_cﬁ‹
(&
ös
->
rb_node
, &
uli°
->
roŸ
);

170 
	}
}

193 
	$uli°_add
(
uli°
 *uli°, 
u64
 
vÆ
, u64 
aux
, 
gÂ_t
 
gÂ_mask
)

195  
	`uli°_add_mîge
(
uli°
, 
vÆ
, 
aux
, 
NULL
, 
gÂ_mask
);

196 
	}
}

198 
	$uli°_add_mîge
(
uli°
 *uli°, 
u64
 
vÆ
, u64 
aux
,

199 
u64
 *
ﬁd_aux
, 
gÂ_t
 
gÂ_mask
)

201 
ªt
;

202 
uli°_node
 *
node
;

204 
node
 = 
	`uli°_rbåì_£¨ch
(
uli°
, 
vÆ
);

205 i‡(
node
) {

206 i‡(
ﬁd_aux
)

207 *
ﬁd_aux
 = 
node
->
aux
;

210 
node
 = 
	`kmÆloc
((*node), 
gÂ_mask
);

211 i‡(!
node
)

212  -
ENOMEM
;

214 
node
->
vÆ
 = val;

215 
node
->
aux
 =áux;

217 
ªt
 = 
	`uli°_rbåì_ö£π
(
uli°
, 
node
);

218 
	`ASSERT
(!
ªt
);

219 
	`li°_add_èû
(&
node
->
li°
, &
uli°
->
nodes
);

220 
uli°
->
¬odes
++;

223 
	}
}

235 
	$uli°_dñ
(
uli°
 *uli°, 
u64
 
vÆ
, u64 
aux
)

237 
uli°_node
 *
node
;

239 
node
 = 
	`uli°_rbåì_£¨ch
(
uli°
, 
vÆ
);

241 i‡(!
node
)

244 i‡(
node
->
aux
 !=áux)

248 
	`uli°_rbåì_îa£
(
uli°
, 
node
);

250 
	}
}

269 
uli°_node
 *
	$uli°_√xt
(c⁄° 
uli°
 *uli°, 
uli°_ôî©‹
 *
uôî
)

271 
uli°_node
 *
node
;

273 i‡(
	`li°_em±y
(&
uli°
->
nodes
))

274  
NULL
;

275 i‡(
uôî
->
cur_li°
 && uôî->cur_li°->
√xt
 =&
uli°
->
nodes
)

276  
NULL
;

277 i‡(
uôî
->
cur_li°
) {

278 
uôî
->
cur_li°
 = uôî->cur_li°->
√xt
;

280 
uôî
->
cur_li°
 = 
uli°
->
nodes
.
√xt
;

282 
node
 = 
	`li°_íåy
(
uôî
->
cur_li°
, 
uli°_node
, 
li°
);

283  
node
;

284 
	}
}

	@ulist.h

7 #i‚de‡
BTRFS_ULIST_H


8 
	#BTRFS_ULIST_H


	)

10 
	~<löux/li°.h
>

11 
	~<löux/rbåì.h
>

20 
	suli°_ôî©‹
 {

21 
li°_hód
 *
	mcur_li°
;

27 
	suli°_node
 {

28 
u64
 
	mvÆ
;

29 
u64
 
	maux
;

31 
li°_hód
 
	mli°
;

32 
rb_node
 
	mrb_node
;

35 
	suli°
 {

39 
	m¬odes
;

41 
li°_hód
 
	mnodes
;

42 
rb_roŸ
 
	mroŸ
;

45 
uli°_öô
(
uli°
 *ulist);

46 
uli°_ªÀa£
(
uli°
 *ulist);

47 
uli°_ªöô
(
uli°
 *ulist);

48 
uli°
 *
uli°_Æloc
(
gÂ_t
 
gÂ_mask
);

49 
uli°_‰ì
(
uli°
 *ulist);

50 
uli°_add
(
uli°
 *uli°, 
u64
 
vÆ
, u64 
aux
, 
gÂ_t
 
gÂ_mask
);

51 
uli°_add_mîge
(
uli°
 *uli°, 
u64
 
vÆ
, u64 
aux
,

52 
u64
 *
ﬁd_aux
, 
gÂ_t
 
gÂ_mask
);

53 
uli°_dñ
(
uli°
 *uli°, 
u64
 
vÆ
, u64 
aux
);

56 
ölöe
 
	$uli°_add_mîge_±r
(
uli°
 *uli°, 
u64
 
vÆ
, *
aux
,

57 **
ﬁd_aux
, 
gÂ_t
 
gÂ_mask
)

59 #i‡
BITS_PER_LONG
 == 32

60 
u64
 
ﬁd64
 = (
uöçå_t
)*
ﬁd_aux
;

61 
ªt
 = 
	`uli°_add_mîge
(
uli°
, 
vÆ
, (
uöçå_t
)
aux
, &
ﬁd64
, 
gÂ_mask
);

62 *
ﬁd_aux
 = (*)((
uöçå_t
)
ﬁd64
);

63  
ªt
;

65  
	`uli°_add_mîge
(
uli°
, 
vÆ
, (
u64
)
aux
, (u64 *)
ﬁd_aux
, 
gÂ_mask
);

67 
	}
}

69 
uli°_node
 *
uli°_√xt
(c⁄° 
uli°
 *ulist,

70 
uli°_ôî©‹
 *
uôî
);

72 
	#ULIST_ITER_INIT
(
uôî
Ë((uôî)->
cur_li°
 = 
NULL
)

	)

	@uuid-tree.c

6 
	~<löux/uuid.h
>

7 
	~<asm/u«lig√d.h
>

8 
	~"mesßges.h
"

9 
	~"˘ªe.h
"

10 
	~"å™ß˘i⁄.h
"

11 
	~"disk-io.h
"

12 
	~"¥öt-åì.h
"

13 
	~"fs.h
"

14 
	~"ac˚ss‹s.h
"

15 
	~"uuid-åì.h
"

17 
	$båfs_uuid_to_key
(
u8
 *
uuid
, u8 
ty≥
, 
båfs_key
 *
key
)

19 
key
->
ty≥
 =Åype;

20 
key
->
obje˘id
 = 
	`gë_u«lig√d_À64
(
uuid
);

21 
key
->
off£t
 = 
	`gë_u«lig√d_À64
(
uuid
 + (
u64
));

22 
	}
}

25 
	$båfs_uuid_åì_lookup
(
båfs_roŸ
 *
uuid_roŸ
, 
u8
 *
uuid
,

26 
u8
 
ty≥
, 
u64
 
subid
)

28 
ªt
;

29 
båfs_∑th
 *
∑th
 = 
NULL
;

30 
exã¡_buf„r
 *
eb
;

31 
¶Ÿ
;

32 
u32
 
ôem_size
;

33 
off£t
;

34 
båfs_key
 
key
;

36 i‡(
	`WARN_ON_ONCE
(!
uuid_roŸ
)) {

37 
ªt
 = -
ENOENT
;

38 
out
;

41 
∑th
 = 
	`båfs_Æloc_∑th
();

42 i‡(!
∑th
) {

43 
ªt
 = -
ENOMEM
;

44 
out
;

47 
	`båfs_uuid_to_key
(
uuid
, 
ty≥
, &
key
);

48 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
uuid_roŸ
, &
key
, 
∑th
, 0, 0);

49 i‡(
ªt
 < 0) {

50 
out
;

51 } i‡(
ªt
 > 0) {

52 
ªt
 = -
ENOENT
;

53 
out
;

56 
eb
 = 
∑th
->
nodes
[0];

57 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

58 
ôem_size
 = 
	`båfs_ôem_size
(
eb
, 
¶Ÿ
);

59 
off£t
 = 
	`båfs_ôem_±r_off£t
(
eb
, 
¶Ÿ
);

60 
ªt
 = -
ENOENT
;

62 i‡(!
	`IS_ALIGNED
(
ôem_size
, (
u64
))) {

63 
	`båfs_w¨n
(
uuid_roŸ
->
fs_öfo
,

65 ()
ôem_size
);

66 
out
;

68 
ôem_size
) {

69 
__À64
 
d©a
;

71 
	`ªad_exã¡_buf„r
(
eb
, &
d©a
, 
off£t
, (data));

72 i‡(
	`À64_to_˝u
(
d©a
Ë=
subid
) {

73 
ªt
 = 0;

76 
off£t
 +(
d©a
);

77 
ôem_size
 -(
d©a
);

80 
out
:

81 
	`båfs_‰ì_∑th
(
∑th
);

82  
ªt
;

83 
	}
}

85 
	$båfs_uuid_åì_add
(
båfs_å™s_h™dÀ
 *
å™s
, 
u8
 *
uuid
, u8 
ty≥
,

86 
u64
 
subid_˝u
)

88 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

89 
båfs_roŸ
 *
uuid_roŸ
 = 
fs_öfo
->uuid_root;

90 
ªt
;

91 
båfs_∑th
 *
∑th
 = 
NULL
;

92 
båfs_key
 
key
;

93 
exã¡_buf„r
 *
eb
;

94 
¶Ÿ
;

95 
off£t
;

96 
__À64
 
subid_À
;

98 
ªt
 = 
	`båfs_uuid_åì_lookup
(
uuid_roŸ
, 
uuid
, 
ty≥
, 
subid_˝u
);

99 i‡(
ªt
 !-
ENOENT
)

100  
ªt
;

102 i‡(
	`WARN_ON_ONCE
(!
uuid_roŸ
)) {

103 
ªt
 = -
EINVAL
;

104 
out
;

107 
	`båfs_uuid_to_key
(
uuid
, 
ty≥
, &
key
);

109 
∑th
 = 
	`båfs_Æloc_∑th
();

110 i‡(!
∑th
) {

111 
ªt
 = -
ENOMEM
;

112 
out
;

115 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
uuid_roŸ
, 
∑th
, &
key
,

116 (
subid_À
));

117 i‡(
ªt
 >= 0) {

119 
eb
 = 
∑th
->
nodes
[0];

120 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

121 
off£t
 = 
	`båfs_ôem_±r_off£t
(
eb
, 
¶Ÿ
);

122 } i‡(
ªt
 =-
EEXIST
) {

127 
	`båfs_exãnd_ôem
(
å™s
, 
∑th
, (
subid_À
));

128 
eb
 = 
∑th
->
nodes
[0];

129 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

130 
off£t
 = 
	`båfs_ôem_±r_off£t
(
eb
, 
¶Ÿ
);

131 
off£t
 +
	`båfs_ôem_size
(
eb
, 
¶Ÿ
Ë- (
subid_À
);

133 
	`båfs_w¨n
(
fs_öfo
,

135 
ªt
, 
key
.
obje˘id
, key.
off£t
, 
ty≥
);

136 
out
;

139 
ªt
 = 0;

140 
subid_À
 = 
	`˝u_to_À64
(
subid_˝u
);

141 
	`wrôe_exã¡_buf„r
(
eb
, &
subid_À
, 
off£t
, (subid_le));

142 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
eb
);

144 
out
:

145 
	`båfs_‰ì_∑th
(
∑th
);

146  
ªt
;

147 
	}
}

149 
	$båfs_uuid_åì_ªmove
(
båfs_å™s_h™dÀ
 *
å™s
, 
u8
 *
uuid
, u8 
ty≥
,

150 
u64
 
subid
)

152 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

153 
båfs_roŸ
 *
uuid_roŸ
 = 
fs_öfo
->uuid_root;

154 
ªt
;

155 
båfs_∑th
 *
∑th
 = 
NULL
;

156 
båfs_key
 
key
;

157 
exã¡_buf„r
 *
eb
;

158 
¶Ÿ
;

159 
off£t
;

160 
u32
 
ôem_size
;

161 
move_d°
;

162 
move_§c
;

163 
move_Àn
;

165 i‡(
	`WARN_ON_ONCE
(!
uuid_roŸ
)) {

166 
ªt
 = -
EINVAL
;

167 
out
;

170 
	`båfs_uuid_to_key
(
uuid
, 
ty≥
, &
key
);

172 
∑th
 = 
	`båfs_Æloc_∑th
();

173 i‡(!
∑th
) {

174 
ªt
 = -
ENOMEM
;

175 
out
;

178 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
uuid_roŸ
, &
key
, 
∑th
, -1, 1);

179 i‡(
ªt
 < 0) {

180 
	`båfs_w¨n
(
fs_öfo
, "error %d while searching for uuid item!",

181 
ªt
);

182 
out
;

184 i‡(
ªt
 > 0) {

185 
ªt
 = -
ENOENT
;

186 
out
;

189 
eb
 = 
∑th
->
nodes
[0];

190 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

191 
off£t
 = 
	`båfs_ôem_±r_off£t
(
eb
, 
¶Ÿ
);

192 
ôem_size
 = 
	`båfs_ôem_size
(
eb
, 
¶Ÿ
);

193 i‡(!
	`IS_ALIGNED
(
ôem_size
, (
u64
))) {

194 
	`båfs_w¨n
(
fs_öfo
, "uuid item with illegal size %lu!",

195 ()
ôem_size
);

196 
ªt
 = -
ENOENT
;

197 
out
;

199 
ôem_size
) {

200 
__À64
 
ªad_subid
;

202 
	`ªad_exã¡_buf„r
(
eb
, &
ªad_subid
, 
off£t
, (read_subid));

203 i‡(
	`À64_to_˝u
(
ªad_subid
Ë=
subid
)

205 
off£t
 +(
ªad_subid
);

206 
ôem_size
 -(
ªad_subid
);

209 i‡(!
ôem_size
) {

210 
ªt
 = -
ENOENT
;

211 
out
;

214 
ôem_size
 = 
	`båfs_ôem_size
(
eb
, 
¶Ÿ
);

215 i‡(
ôem_size
 =(
subid
)) {

216 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
uuid_roŸ
, 
∑th
);

217 
out
;

220 
move_d°
 = 
off£t
;

221 
move_§c
 = 
off£t
 + (
subid
);

222 
move_Àn
 = 
ôem_size
 - (
move_§c
 - 
	`båfs_ôem_±r_off£t
(
eb
, 
¶Ÿ
));

223 
	`memmove_exã¡_buf„r
(
eb
, 
move_d°
, 
move_§c
, 
move_Àn
);

224 
	`båfs_åunˇã_ôem
(
å™s
, 
∑th
, 
ôem_size
 - (
subid
), 1);

226 
out
:

227 
	`båfs_‰ì_∑th
(
∑th
);

228  
ªt
;

229 
	}
}

231 
	$båfs_uuid_ôî_ªm
(
båfs_roŸ
 *
uuid_roŸ
, 
u8
 *
uuid
, u8 
ty≥
,

232 
u64
 
subid
)

234 
båfs_å™s_h™dÀ
 *
å™s
;

235 
ªt
;

238 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
uuid_roŸ
, 1);

239 i‡(
	`IS_ERR
(
å™s
)) {

240 
ªt
 = 
	`PTR_ERR
(
å™s
);

241 
out
;

244 
ªt
 = 
	`båfs_uuid_åì_ªmove
(
å™s
, 
uuid
, 
ty≥
, 
subid
);

245 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

247 
out
:

248  
ªt
;

249 
	}
}

259 
	$båfs_check_uuid_åì_íåy
(
båfs_fs_öfo
 *
fs_öfo
,

260 
u8
 *
uuid
, u8 
ty≥
, 
u64
 
subvﬁid
)

262 
ªt
 = 0;

263 
båfs_roŸ
 *
subvﬁ_roŸ
;

265 i‡(
ty≥
 !
BTRFS_UUID_KEY_SUBVOL
 &&

266 
ty≥
 !
BTRFS_UUID_KEY_RECEIVED_SUBVOL
)

267 
out
;

269 
subvﬁ_roŸ
 = 
	`båfs_gë_fs_roŸ
(
fs_öfo
, 
subvﬁid
, 
åue
);

270 i‡(
	`IS_ERR
(
subvﬁ_roŸ
)) {

271 
ªt
 = 
	`PTR_ERR
(
subvﬁ_roŸ
);

272 i‡(
ªt
 =-
ENOENT
)

273 
ªt
 = 1;

274 
out
;

277 
ty≥
) {

278 
BTRFS_UUID_KEY_SUBVOL
:

279 i‡(
	`memcmp
(
uuid
, 
subvﬁ_roŸ
->
roŸ_ôem
.uuid, 
BTRFS_UUID_SIZE
))

280 
ªt
 = 1;

282 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
:

283 i‡(
	`memcmp
(
uuid
, 
subvﬁ_roŸ
->
roŸ_ôem
.
ª˚ived_uuid
,

284 
BTRFS_UUID_SIZE
))

285 
ªt
 = 1;

288 
	`båfs_put_roŸ
(
subvﬁ_roŸ
);

289 
out
:

290  
ªt
;

291 
	}
}

293 
	$båfs_uuid_åì_ôî©e
(
båfs_fs_öfo
 *
fs_öfo
)

295 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
uuid_roŸ
;

296 
båfs_key
 
key
;

297 
båfs_∑th
 *
∑th
;

298 
ªt
 = 0;

299 
exã¡_buf„r
 *
Àaf
;

300 
¶Ÿ
;

301 
u32
 
ôem_size
;

302 
off£t
;

304 
∑th
 = 
	`båfs_Æloc_∑th
();

305 i‡(!
∑th
) {

306 
ªt
 = -
ENOMEM
;

307 
out
;

310 
key
.
obje˘id
 = 0;

311 
key
.
ty≥
 = 0;

312 
key
.
off£t
 = 0;

314 
agaö_£¨ch_¶Ÿ
:

315 
ªt
 = 
	`båfs_£¨ch_f‹w¨d
(
roŸ
, &
key
, 
∑th
, 
BTRFS_OLDEST_GENERATION
);

316 i‡(
ªt
) {

317 i‡(
ªt
 > 0)

318 
ªt
 = 0;

319 
out
;

323 i‡(
	`båfs_fs_˛osög
(
fs_öfo
)) {

324 
ªt
 = -
EINTR
;

325 
out
;

327 
	`c⁄d_ªsched
();

328 
Àaf
 = 
∑th
->
nodes
[0];

329 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

330 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

332 i‡(
key
.
ty≥
 !
BTRFS_UUID_KEY_SUBVOL
 &&

333 
key
.
ty≥
 !
BTRFS_UUID_KEY_RECEIVED_SUBVOL
)

334 
skù
;

336 
off£t
 = 
	`båfs_ôem_±r_off£t
(
Àaf
, 
¶Ÿ
);

337 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

338 i‡(!
	`IS_ALIGNED
(
ôem_size
, (
u64
))) {

339 
	`båfs_w¨n
(
fs_öfo
,

341 ()
ôem_size
);

342 
skù
;

344 
ôem_size
) {

345 
u8
 
uuid
[
BTRFS_UUID_SIZE
];

346 
__À64
 
subid_À
;

347 
u64
 
subid_˝u
;

349 
	`put_u«lig√d_À64
(
key
.
obje˘id
, 
uuid
);

350 
	`put_u«lig√d_À64
(
key
.
off£t
, 
uuid
 + (
u64
));

351 
	`ªad_exã¡_buf„r
(
Àaf
, &
subid_À
, 
off£t
,

352 (
subid_À
));

353 
subid_˝u
 = 
	`À64_to_˝u
(
subid_À
);

354 
ªt
 = 
	`båfs_check_uuid_åì_íåy
(
fs_öfo
, 
uuid
,

355 
key
.
ty≥
, 
subid_˝u
);

356 i‡(
ªt
 < 0)

357 
out
;

358 i‡(
ªt
 > 0) {

359 
	`båfs_ªÀa£_∑th
(
∑th
);

360 
ªt
 = 
	`båfs_uuid_ôî_ªm
(
roŸ
, 
uuid
, 
key
.
ty≥
,

361 
subid_˝u
);

362 i‡(
ªt
 == 0) {

370 
agaö_£¨ch_¶Ÿ
;

372 i‡(
ªt
 < 0 &&Ñë !-
ENOENT
)

373 
out
;

374 
key
.
off£t
++;

375 
agaö_£¨ch_¶Ÿ
;

377 
ôem_size
 -(
subid_À
);

378 
off£t
 +(
subid_À
);

381 
skù
:

382 
ªt
 = 
	`båfs_√xt_ôem
(
roŸ
, 
∑th
);

383 i‡(
ªt
 == 0)

385 i‡(
ªt
 > 0)

386 
ªt
 = 0;

390 
out
:

391 
	`båfs_‰ì_∑th
(
∑th
);

392  
ªt
;

393 
	}
}

	@uuid-tree.h

3 #i‚de‡
BTRFS_UUID_TREE_H


4 
	#BTRFS_UUID_TREE_H


	)

6 
båfs_uuid_åì_add
(
båfs_å™s_h™dÀ
 *
å™s
, 
u8
 *
uuid
, u8 
ty≥
,

7 
u64
 
subid
);

8 
båfs_uuid_åì_ªmove
(
båfs_å™s_h™dÀ
 *
å™s
, 
u8
 *
uuid
, u8 
ty≥
,

9 
u64
 
subid
);

10 
båfs_uuid_åì_ôî©e
(
båfs_fs_öfo
 *
fs_öfo
);

	@verity.c

3 
	~<löux/öô.h
>

4 
	~<löux/fs.h
>

5 
	~<löux/¶ab.h
>

6 
	~<löux/rw£m.h
>

7 
	~<löux/x©å.h
>

8 
	~<löux/£curôy.h
>

9 
	~<löux/posix_a˛_x©å.h
>

10 
	~<löux/ivîsi⁄.h
>

11 
	~<löux/fsvîôy.h
>

12 
	~<löux/sched/mm.h
>

13 
	~"mesßges.h
"

14 
	~"˘ªe.h
"

15 
	~"båfs_öode.h
"

16 
	~"å™ß˘i⁄.h
"

17 
	~"disk-io.h
"

18 
	~"lockög.h
"

19 
	~"fs.h
"

20 
	~"ac˚ss‹s.h
"

21 
	~"io˘l.h
"

22 
	~"vîôy.h
"

23 
	~"‹ph™.h
"

69 
	#MERKLE_START_ALIGN
 65536

	)

86 
loff_t
 
	$mîkÀ_fûe_pos
(c⁄° 
öode
 *inode)

88 
u64
 
sz
 = 
öode
->
i_size
;

89 
u64
 
rounded
 = 
	`round_up
(
sz
, 
MERKLE_START_ALIGN
);

91 i‡(
rounded
 > 
öode
->
i_sb
->
s_maxbyãs
)

92  -
EFBIG
;

94  
rounded
;

95 
	}
}

109 
	$dr›_vîôy_ôems
(
båfs_öode
 *
öode
, 
u8
 
key_ty≥
)

111 
båfs_å™s_h™dÀ
 *
å™s
;

112 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

113 
båfs_∑th
 *
∑th
;

114 
båfs_key
 
key
;

115 
cou¡
 = 0;

116 
ªt
;

118 
∑th
 = 
	`båfs_Æloc_∑th
();

119 i‡(!
∑th
)

120  -
ENOMEM
;

124 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 1);

125 i‡(
	`IS_ERR
(
å™s
)) {

126 
ªt
 = 
	`PTR_ERR
(
å™s
);

127 
out
;

134 
key
.
obje˘id
 = 
	`båfs_öo
(
öode
);

135 
key
.
ty≥
 = 
key_ty≥
;

136 
key
.
off£t
 = (
u64
)-1;

138 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

139 i‡(
ªt
 > 0) {

140 
ªt
 = 0;

142 i‡(
∑th
->
¶Ÿs
[0] == 0)

144 
∑th
->
¶Ÿs
[0]--;

145 } i‡(
ªt
 < 0) {

146 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

147 
out
;

150 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
key
,Ö©h->
¶Ÿs
[0]);

153 i‡(
key
.
obje˘id
 !
	`båfs_öo
(
öode
Ë|| key.
ty≥
 !
key_ty≥
)

162 
ªt
 = 
	`båfs_dñ_ôems
(
å™s
, 
roŸ
, 
∑th
,Ö©h->
¶Ÿs
[0], 1);

163 i‡(
ªt
) {

164 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

165 
out
;

167 
cou¡
++;

168 
	`båfs_ªÀa£_∑th
(
∑th
);

169 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

171 
ªt
 = 
cou¡
;

172 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

173 
out
:

174 
	`båfs_‰ì_∑th
(
∑th
);

175  
ªt
;

176 
	}
}

188 
	$båfs_dr›_vîôy_ôems
(
båfs_öode
 *
öode
)

190 
ªt
;

192 
ªt
 = 
	`dr›_vîôy_ôems
(
öode
, 
BTRFS_VERITY_DESC_ITEM_KEY
);

193 i‡(
ªt
 < 0)

194  
ªt
;

195 
ªt
 = 
	`dr›_vîôy_ôems
(
öode
, 
BTRFS_VERITY_MERKLE_ITEM_KEY
);

196 i‡(
ªt
 < 0)

197  
ªt
;

200 
	}
}

217 
	$wrôe_key_byãs
(
båfs_öode
 *
öode
, 
u8
 
key_ty≥
, 
u64
 
off£t
,

218 c⁄° *
§c
, 
u64
 
Àn
)

220 
båfs_å™s_h™dÀ
 *
å™s
;

221 
båfs_∑th
 *
∑th
;

222 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

223 
exã¡_buf„r
 *
Àaf
;

224 
båfs_key
 
key
;

225 
c›y_byãs
;

226 
§c_off£t
 = 0;

227 *
d©a
;

228 
ªt
 = 0;

230 
∑th
 = 
	`båfs_Æloc_∑th
();

231 i‡(!
∑th
)

232  -
ENOMEM
;

234 
Àn
 > 0) {

236 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 1);

237 i‡(
	`IS_ERR
(
å™s
)) {

238 
ªt
 = 
	`PTR_ERR
(
å™s
);

242 
key
.
obje˘id
 = 
	`båfs_öo
(
öode
);

243 
key
.
ty≥
 = 
key_ty≥
;

244 
key
.
off£t
 = offset;

250 
c›y_byãs
 = 
	`mö_t
(
u64
, 
Àn
, 2048);

252 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
, 
c›y_byãs
);

253 i‡(
ªt
) {

254 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

258 
Àaf
 = 
∑th
->
nodes
[0];

260 
d©a
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], );

261 
	`wrôe_exã¡_buf„r
(
Àaf
, 
§c
 + 
§c_off£t
,

262 ()
d©a
, 
c›y_byãs
);

263 
off£t
 +
c›y_byãs
;

264 
§c_off£t
 +
c›y_byãs
;

265 
Àn
 -
c›y_byãs
;

267 
	`båfs_ªÀa£_∑th
(
∑th
);

268 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

271 
	`båfs_‰ì_∑th
(
∑th
);

272  
ªt
;

273 
	}
}

297 
	$ªad_key_byãs
(
båfs_öode
 *
öode
, 
u8
 
key_ty≥
, 
u64
 
off£t
,

298 *
de°
, 
u64
 
Àn
, 
∑ge
 *
de°_∑ge
)

300 
båfs_∑th
 *
∑th
;

301 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

302 
exã¡_buf„r
 *
Àaf
;

303 
båfs_key
 
key
;

304 
u64
 
ôem_íd
;

305 
u64
 
c›y_íd
;

306 
c›õd
 = 0;

307 
u32
 
c›y_off£t
;

308 
c›y_byãs
;

309 
de°_off£t
 = 0;

310 *
d©a
;

311 *
kaddr
 = 
de°
;

312 
ªt
;

314 
∑th
 = 
	`båfs_Æloc_∑th
();

315 i‡(!
∑th
)

316  -
ENOMEM
;

318 i‡(
de°_∑ge
)

319 
∑th
->
ªada
 = 
READA_FORWARD
;

321 
key
.
obje˘id
 = 
	`båfs_öo
(
öode
);

322 
key
.
ty≥
 = 
key_ty≥
;

323 
key
.
off£t
 = offset;

325 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

326 i‡(
ªt
 < 0) {

327 
out
;

328 } i‡(
ªt
 > 0) {

329 
ªt
 = 0;

330 i‡(
∑th
->
¶Ÿs
[0] == 0)

331 
out
;

332 
∑th
->
¶Ÿs
[0]--;

335 
Àn
 > 0) {

336 
Àaf
 = 
∑th
->
nodes
[0];

337 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

339 i‡(
key
.
obje˘id
 !
	`båfs_öo
(
öode
Ë|| key.
ty≥
 !
key_ty≥
)

342 
ôem_íd
 = 
	`båfs_ôem_size
(
Àaf
, 
∑th
->
¶Ÿs
[0]Ë+ 
key
.
off£t
;

344 i‡(
c›õd
 > 0) {

349 i‡(
key
.
off£t
 != offset)

356 i‡(
key
.
off£t
 > offset)

358 i‡(
ôem_íd
 <
off£t
)

363 i‡(!
de°
)

364 
c›y_íd
 = 
ôem_íd
;

366 
c›y_íd
 = 
	`mö
(
off£t
 + 
Àn
, 
ôem_íd
);

369 
c›y_byãs
 = 
c›y_íd
 - 
off£t
;

372 
c›y_off£t
 = 
off£t
 - 
key
.offset;

374 i‡(
de°
) {

375 i‡(
de°_∑ge
)

376 
kaddr
 = 
	`km≠_loˇl_∑ge
(
de°_∑ge
);

378 
d©a
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], );

379 
	`ªad_exã¡_buf„r
(
Àaf
, 
kaddr
 + 
de°_off£t
,

380 ()
d©a
 + 
c›y_off£t
,

381 
c›y_byãs
);

383 i‡(
de°_∑ge
)

384 
	`kunm≠_loˇl
(
kaddr
);

387 
off£t
 +
c›y_byãs
;

388 
de°_off£t
 +
c›y_byãs
;

389 
Àn
 -
c›y_byãs
;

390 
c›õd
 +
c›y_byãs
;

392 
∑th
->
¶Ÿs
[0]++;

393 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
’©h->
nodes
[0])) {

398 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

399 i‡(
ªt
 < 0) {

401 } i‡(
ªt
 > 0) {

402 
ªt
 = 0;

407 
out
:

408 
	`båfs_‰ì_∑th
(
∑th
);

409 i‡(!
ªt
)

410 
ªt
 = 
c›õd
;

411  
ªt
;

412 
	}
}

426 
	$dñ_‹ph™
(
båfs_å™s_h™dÀ
 *
å™s
, 
båfs_öode
 *
öode
)

428 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

429 
ªt
;

438 i‡(!
öode
->
vfs_öode
.
i_∆ök
)

441 
ªt
 = 
	`båfs_dñ_‹ph™_ôem
(
å™s
, 
roŸ
, 
	`båfs_öo
(
öode
));

442 i‡(
ªt
 =-
ENOENT
)

443 
ªt
 = 0;

444  
ªt
;

445 
	}
}

458 
	$rﬁlback_vîôy
(
båfs_öode
 *
öode
)

460 
båfs_å™s_h™dÀ
 *
å™s
 = 
NULL
;

461 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

462 
ªt
;

464 
	`ASSERT
(
	`öode_is_locked
(&
öode
->
vfs_öode
));

465 
	`åunˇã_öode_∑ges
(
öode
->
vfs_öode
.
i_m≠pög
, inode->vfs_öode.
i_size
);

466 
	`˛ór_bô
(
BTRFS_INODE_VERITY_IN_PROGRESS
, &
öode
->
ru¡ime_Êags
);

467 
ªt
 = 
	`båfs_dr›_vîôy_ôems
(
öode
);

468 i‡(
ªt
) {

469 
	`båfs_h™dÀ_fs_îr‹
(
roŸ
->
fs_öfo
, 
ªt
,

471 (
u64
)
öode
->
vfs_öode
.
i_öo
);

472 
out
;

479 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 2);

480 i‡(
	`IS_ERR
(
å™s
)) {

481 
ªt
 = 
	`PTR_ERR
(
å™s
);

482 
å™s
 = 
NULL
;

483 
	`båfs_h™dÀ_fs_îr‹
(
roŸ
->
fs_öfo
, 
ªt
,

485 (
u64
)
öode
->
vfs_öode
.
i_öo
);

486 
out
;

488 
öode
->
ro_Êags
 &~
BTRFS_INODE_RO_VERITY
;

489 
	`båfs_sync_öode_Êags_to_i_Êags
(&
öode
->
vfs_öode
);

490 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
öode
);

491 i‡(
ªt
) {

492 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

493 
out
;

495 
ªt
 = 
	`dñ_‹ph™
(
å™s
, 
öode
);

496 i‡(
ªt
) {

497 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

498 
out
;

500 
out
:

501 i‡(
å™s
)

502 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

503  
ªt
;

504 
	}
}

524 
	$föish_vîôy
(
båfs_öode
 *
öode
, c⁄° *
desc
,

525 
size_t
 
desc_size
)

527 
båfs_å™s_h™dÀ
 *
å™s
 = 
NULL
;

528 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

529 
båfs_vîôy_des¸ùt‹_ôem
 
ôem
;

530 
ªt
;

533 
	`mem£t
(&
ôem
, 0, (item));

534 
	`båfs_£t_°ack_vîôy_des¸ùt‹_size
(&
ôem
, 
desc_size
);

535 
ªt
 = 
	`wrôe_key_byãs
(
öode
, 
BTRFS_VERITY_DESC_ITEM_KEY
, 0,

536 (c⁄° *)&
ôem
, (item));

537 i‡(
ªt
)

538 
out
;

541 
ªt
 = 
	`wrôe_key_byãs
(
öode
, 
BTRFS_VERITY_DESC_ITEM_KEY
, 1,

542 
desc
, 
desc_size
);

543 i‡(
ªt
)

544 
out
;

550 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 2);

551 i‡(
	`IS_ERR
(
å™s
)) {

552 
ªt
 = 
	`PTR_ERR
(
å™s
);

553 
out
;

555 
öode
->
ro_Êags
 |
BTRFS_INODE_RO_VERITY
;

556 
	`båfs_sync_öode_Êags_to_i_Êags
(&
öode
->
vfs_öode
);

557 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
öode
);

558 i‡(
ªt
)

559 
íd_å™s
;

560 
ªt
 = 
	`dñ_‹ph™
(
å™s
, 
öode
);

561 i‡(
ªt
)

562 
íd_å™s
;

563 
	`˛ór_bô
(
BTRFS_INODE_VERITY_IN_PROGRESS
, &
öode
->
ru¡ime_Êags
);

564 
	`båfs_£t_fs_com∑t_ro
(
roŸ
->
fs_öfo
, 
VERITY
);

565 
íd_å™s
:

566 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

567 
out
:

568  
ªt
;

570 
	}
}

582 
	$båfs_begö_íabÀ_vîôy
(
fûe
 *
fûp
)

584 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
	`fûe_öode
(
fûp
));

585 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

586 
båfs_å™s_h™dÀ
 *
å™s
;

587 
ªt
;

589 
	`ASSERT
(
	`öode_is_locked
(
	`fûe_öode
(
fûp
)));

591 i‡(
	`ã°_bô
(
BTRFS_INODE_VERITY_IN_PROGRESS
, &
öode
->
ru¡ime_Êags
))

592  -
EBUSY
;

600 
ªt
 = 
	`båfs_dr›_vîôy_ôems
(
öode
);

601 i‡(
ªt
)

602  
ªt
;

605 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 1);

606 i‡(
	`IS_ERR
(
å™s
))

607  
	`PTR_ERR
(
å™s
);

609 
ªt
 = 
	`båfs_‹ph™_add
(
å™s
, 
öode
);

610 i‡(!
ªt
)

611 
	`£t_bô
(
BTRFS_INODE_VERITY_IN_PROGRESS
, &
öode
->
ru¡ime_Êags
);

612 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

615 
	}
}

630 
	$båfs_íd_íabÀ_vîôy
(
fûe
 *
fûp
, c⁄° *
desc
,

631 
size_t
 
desc_size
, 
u64
 
mîkÀ_åì_size
)

633 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
	`fûe_öode
(
fûp
));

634 
ªt
 = 0;

635 
rﬁlback_ªt
;

637 
	`ASSERT
(
	`öode_is_locked
(
	`fûe_öode
(
fûp
)));

639 i‡(
desc
 =
NULL
)

640 
rﬁlback
;

642 
ªt
 = 
	`föish_vîôy
(
öode
, 
desc
, 
desc_size
);

643 i‡(
ªt
)

644 
rﬁlback
;

645  
ªt
;

647 
rﬁlback
:

648 
rﬁlback_ªt
 = 
	`rﬁlback_vîôy
(
öode
);

649 i‡(
rﬁlback_ªt
)

650 
	`båfs_îr
(
öode
->
roŸ
->
fs_öfo
,

651 "ÁûedÅÿrﬁlback vîôy iãms: %d", 
rﬁlback_ªt
);

652  
ªt
;

653 
	}
}

668 
	$båfs_gë_vîôy_des¸ùt‹
(
öode
 *öode, *
buf
, 
size_t
 
buf_size
)

670 
u64
 
åue_size
;

671 
ªt
 = 0;

672 
båfs_vîôy_des¸ùt‹_ôem
 
ôem
;

674 
	`mem£t
(&
ôem
, 0, (item));

675 
ªt
 = 
	`ªad_key_byãs
(
	`BTRFS_I
(
öode
), 
BTRFS_VERITY_DESC_ITEM_KEY
, 0,

676 (*)&
ôem
, (ôem), 
NULL
);

677 i‡(
ªt
 < 0)

678  
ªt
;

680 i‡(
ôem
.
ª£rved
[0] != 0 || item.reserved[1] != 0)

681  -
EUCLEAN
;

683 
åue_size
 = 
	`båfs_°ack_vîôy_des¸ùt‹_size
(&
ôem
);

684 i‡(
åue_size
 > 
INT_MAX
)

685  -
EUCLEAN
;

687 i‡(
buf_size
 == 0)

688  
åue_size
;

689 i‡(
buf_size
 < 
åue_size
)

690  -
ERANGE
;

692 
ªt
 = 
	`ªad_key_byãs
(
	`BTRFS_I
(
öode
), 
BTRFS_VERITY_DESC_ITEM_KEY
, 1,

693 
buf
, 
buf_size
, 
NULL
);

694 i‡(
ªt
 < 0)

695  
ªt
;

696 i‡(
ªt
 !
åue_size
)

697  -
EIO
;

699  
åue_size
;

700 
	}
}

714 
∑ge
 *
	$båfs_ªad_mîkÀ_åì_∑ge
(
öode
 *inode,

715 
pgoff_t
 
ödex
,

716 
num_ø_∑ges
)

718 
fﬁio
 *folio;

719 
u64
 
off
 = (u64)
ödex
 << 
PAGE_SHIFT
;

720 
loff_t
 
mîkÀ_pos
 = 
	`mîkÀ_fûe_pos
(
öode
);

721 
ªt
;

723 i‡(
mîkÀ_pos
 < 0)

724  
	`ERR_PTR
(
mîkÀ_pos
);

725 i‡(
mîkÀ_pos
 > 
öode
->
i_sb
->
s_maxbyãs
 - 
off
 - 
PAGE_SIZE
)

726  
	`ERR_PTR
(-
EFBIG
);

727 
ödex
 +
mîkÀ_pos
 >> 
PAGE_SHIFT
;

728 
agaö
:

729 
fﬁio
 = 
	`__fûem≠_gë_fﬁio
(
öode
->
i_m≠pög
, 
ödex
, 
FGP_ACCESSED
, 0);

730 i‡(!
	`IS_ERR
(
fﬁio
)) {

731 i‡(
	`fﬁio_ã°_u±od©e
(
fﬁio
))

732 
out
;

734 
	`fﬁio_lock
(
fﬁio
);

736 i‡(!
	`fﬁio_ã°_u±od©e
(
fﬁio
)) {

737 
	`fﬁio_u∆ock
(
fﬁio
);

738 
	`fﬁio_put
(
fﬁio
);

739  
	`ERR_PTR
(-
EIO
);

741 
	`fﬁio_u∆ock
(
fﬁio
);

742 
out
;

745 
fﬁio
 = 
	`fûem≠_Æloc_fﬁio
(
	`m≠pög_gÂ_c⁄°øöt
(
öode
->
i_m≠pög
, ~
__GFP_FS
),

747 i‡(!
fﬁio
)

748  
	`ERR_PTR
(-
ENOMEM
);

750 
ªt
 = 
	`fûem≠_add_fﬁio
(
öode
->
i_m≠pög
, 
fﬁio
, 
ödex
, 
GFP_NOFS
);

751 i‡(
ªt
) {

752 
	`fﬁio_put
(
fﬁio
);

754 i‡(
ªt
 =-
EEXIST
)

755 
agaö
;

756  
	`ERR_PTR
(
ªt
);

765 
ªt
 = 
	`ªad_key_byãs
(
	`BTRFS_I
(
öode
), 
BTRFS_VERITY_MERKLE_ITEM_KEY
, 
off
,

766 
	`fﬁio_addªss
(
fﬁio
), 
PAGE_SIZE
, &fﬁio->
∑ge
);

767 i‡(
ªt
 < 0) {

768 
	`fﬁio_put
(
fﬁio
);

769  
	`ERR_PTR
(
ªt
);

771 i‡(
ªt
 < 
PAGE_SIZE
)

772 
	`fﬁio_zîo_£gmít
(
fﬁio
, 
ªt
, 
PAGE_SIZE
);

774 
	`fﬁio_m¨k_u±od©e
(
fﬁio
);

775 
	`fﬁio_u∆ock
(
fﬁio
);

777 
out
:

778  
	`fﬁio_fûe_∑ge
(
fﬁio
, 
ödex
);

779 
	}
}

791 
	$båfs_wrôe_mîkÀ_åì_block
(
öode
 *öode, c⁄° *
buf
,

792 
u64
 
pos
, 
size
)

794 
loff_t
 
mîkÀ_pos
 = 
	`mîkÀ_fûe_pos
(
öode
);

796 i‡(
mîkÀ_pos
 < 0)

797  
mîkÀ_pos
;

798 i‡(
mîkÀ_pos
 > 
öode
->
i_sb
->
s_maxbyãs
 - 
pos
 - 
size
)

799  -
EFBIG
;

801  
	`wrôe_key_byãs
(
	`BTRFS_I
(
öode
), 
BTRFS_VERITY_MERKLE_ITEM_KEY
,

802 
pos
, 
buf
, 
size
);

803 
	}
}

805 c⁄° 
fsvîôy_›î©i⁄s
 
	gbåfs_vîôy›s
 = {

806 .
begö_íabÀ_vîôy
 = 
båfs_begö_íabÀ_vîôy
,

807 .
	gíd_íabÀ_vîôy
 = 
båfs_íd_íabÀ_vîôy
,

808 .
	ggë_vîôy_des¸ùt‹
 = 
båfs_gë_vîôy_des¸ùt‹
,

809 .
	gªad_mîkÀ_åì_∑ge
 = 
båfs_ªad_mîkÀ_åì_∑ge
,

810 .
	gwrôe_mîkÀ_åì_block
 = 
båfs_wrôe_mîkÀ_åì_block
,

	@verity.h

3 #i‚de‡
BTRFS_VERITY_H


4 
	#BTRFS_VERITY_H


	)

6 #ifde‡
CONFIG_FS_VERITY


8 c⁄° 
fsvîôy_›î©i⁄s
 
båfs_vîôy›s
;

10 
båfs_dr›_vîôy_ôems
(
båfs_öode
 *
öode
);

11 
båfs_gë_vîôy_des¸ùt‹
(
öode
 *öode, *
buf
, 
size_t
 
buf_size
);

15 
ölöe
 
	$båfs_dr›_vîôy_ôems
(
båfs_öode
 *
öode
)

18 
	}
}

20 
ölöe
 
	$båfs_gë_vîôy_des¸ùt‹
(
öode
 *öode, *
buf
,

21 
size_t
 
buf_size
)

23  -
EPERM
;

24 
	}
}

	@volumes.c

6 
	~<löux/sched.h
>

7 
	~<löux/sched/mm.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/øãlimô.h
>

10 
	~<löux/kthªad.h
>

11 
	~<löux/£m≠h‹e.h
>

12 
	~<löux/uuid.h
>

13 
	~<löux/li°_s‹t.h
>

14 
	~<löux/«mei.h
>

15 
	~"misc.h
"

16 
	~"˘ªe.h
"

17 
	~"exã¡_m≠.h
"

18 
	~"disk-io.h
"

19 
	~"å™ß˘i⁄.h
"

20 
	~"¥öt-åì.h
"

21 
	~"vﬁumes.h
"

22 
	~"øid56.h
"

23 
	~"rcu-°rög.h
"

24 
	~"dev-ª∂a˚.h
"

25 
	~"sysfs.h
"

26 
	~"åì-checkî.h
"

27 
	~"•a˚-öfo.h
"

28 
	~"block-group.h
"

29 
	~"disˇrd.h
"

30 
	~"z⁄ed.h
"

31 
	~"fs.h
"

32 
	~"ac˚ss‹s.h
"

33 
	~"uuid-åì.h
"

34 
	~"io˘l.h
"

35 
	~"ªloˇti⁄.h
"

36 
	~"s¸ub.h
"

37 
	~"su≥r.h
"

39 
	#BTRFS_BLOCK_GROUP_STRIPE_MASK
 (
BTRFS_BLOCK_GROUP_RAID0
 | \

40 
BTRFS_BLOCK_GROUP_RAID10
 | \

41 
BTRFS_BLOCK_GROUP_RAID56_MASK
)

	)

43 c⁄° 
båfs_øid_©å
 
	gbåfs_øid_¨øy
[
BTRFS_NR_RAID_TYPES
] = {

44 [
BTRFS_RAID_RAID10
] = {

45 .
sub_°rùes
 = 2,

46 .
	gdev_°rùes
 = 1,

47 .
	gdevs_max
 = 0,

48 .
	gdevs_mö
 = 2,

49 .
	gtﬁî©ed_Áûuªs
 = 1,

50 .
	gdevs_ö¸emít
 = 2,

51 .
	gnc›õs
 = 2,

52 .
	g≈¨ôy
 = 0,

53 .
	gøid_«me
 = "raid10",

54 .
	gbg_Êag
 = 
BTRFS_BLOCK_GROUP_RAID10
,

55 .
	gmödev_îr‹
 = 
BTRFS_ERROR_DEV_RAID10_MIN_NOT_MET
,

57 [
BTRFS_RAID_RAID1
] = {

58 .
sub_°rùes
 = 1,

59 .
	gdev_°rùes
 = 1,

60 .
	gdevs_max
 = 2,

61 .
	gdevs_mö
 = 2,

62 .
	gtﬁî©ed_Áûuªs
 = 1,

63 .
	gdevs_ö¸emít
 = 2,

64 .
	gnc›õs
 = 2,

65 .
	g≈¨ôy
 = 0,

66 .
	gøid_«me
 = "raid1",

67 .
	gbg_Êag
 = 
BTRFS_BLOCK_GROUP_RAID1
,

68 .
	gmödev_îr‹
 = 
BTRFS_ERROR_DEV_RAID1_MIN_NOT_MET
,

70 [
BTRFS_RAID_RAID1C3
] = {

71 .
sub_°rùes
 = 1,

72 .
	gdev_°rùes
 = 1,

73 .
	gdevs_max
 = 3,

74 .
	gdevs_mö
 = 3,

75 .
	gtﬁî©ed_Áûuªs
 = 2,

76 .
	gdevs_ö¸emít
 = 3,

77 .
	gnc›õs
 = 3,

78 .
	g≈¨ôy
 = 0,

79 .
	gøid_«me
 = "raid1c3",

80 .
	gbg_Êag
 = 
BTRFS_BLOCK_GROUP_RAID1C3
,

81 .
	gmödev_îr‹
 = 
BTRFS_ERROR_DEV_RAID1C3_MIN_NOT_MET
,

83 [
BTRFS_RAID_RAID1C4
] = {

84 .
sub_°rùes
 = 1,

85 .
	gdev_°rùes
 = 1,

86 .
	gdevs_max
 = 4,

87 .
	gdevs_mö
 = 4,

88 .
	gtﬁî©ed_Áûuªs
 = 3,

89 .
	gdevs_ö¸emít
 = 4,

90 .
	gnc›õs
 = 4,

91 .
	g≈¨ôy
 = 0,

92 .
	gøid_«me
 = "raid1c4",

93 .
	gbg_Êag
 = 
BTRFS_BLOCK_GROUP_RAID1C4
,

94 .
	gmödev_îr‹
 = 
BTRFS_ERROR_DEV_RAID1C4_MIN_NOT_MET
,

96 [
BTRFS_RAID_DUP
] = {

97 .
sub_°rùes
 = 1,

98 .
	gdev_°rùes
 = 2,

99 .
	gdevs_max
 = 1,

100 .
	gdevs_mö
 = 1,

101 .
	gtﬁî©ed_Áûuªs
 = 0,

102 .
	gdevs_ö¸emít
 = 1,

103 .
	gnc›õs
 = 2,

104 .
	g≈¨ôy
 = 0,

105 .
	gøid_«me
 = "dup",

106 .
	gbg_Êag
 = 
BTRFS_BLOCK_GROUP_DUP
,

107 .
	gmödev_îr‹
 = 0,

109 [
BTRFS_RAID_RAID0
] = {

110 .
sub_°rùes
 = 1,

111 .
	gdev_°rùes
 = 1,

112 .
	gdevs_max
 = 0,

113 .
	gdevs_mö
 = 1,

114 .
	gtﬁî©ed_Áûuªs
 = 0,

115 .
	gdevs_ö¸emít
 = 1,

116 .
	gnc›õs
 = 1,

117 .
	g≈¨ôy
 = 0,

118 .
	gøid_«me
 = "raid0",

119 .
	gbg_Êag
 = 
BTRFS_BLOCK_GROUP_RAID0
,

120 .
	gmödev_îr‹
 = 0,

122 [
BTRFS_RAID_SINGLE
] = {

123 .
sub_°rùes
 = 1,

124 .
	gdev_°rùes
 = 1,

125 .
	gdevs_max
 = 1,

126 .
	gdevs_mö
 = 1,

127 .
	gtﬁî©ed_Áûuªs
 = 0,

128 .
	gdevs_ö¸emít
 = 1,

129 .
	gnc›õs
 = 1,

130 .
	g≈¨ôy
 = 0,

131 .
	gøid_«me
 = "single",

132 .
	gbg_Êag
 = 0,

133 .
	gmödev_îr‹
 = 0,

135 [
BTRFS_RAID_RAID5
] = {

136 .
sub_°rùes
 = 1,

137 .
	gdev_°rùes
 = 1,

138 .
	gdevs_max
 = 0,

139 .
	gdevs_mö
 = 2,

140 .
	gtﬁî©ed_Áûuªs
 = 1,

141 .
	gdevs_ö¸emít
 = 1,

142 .
	gnc›õs
 = 1,

143 .
	g≈¨ôy
 = 1,

144 .
	gøid_«me
 = "raid5",

145 .
	gbg_Êag
 = 
BTRFS_BLOCK_GROUP_RAID5
,

146 .
	gmödev_îr‹
 = 
BTRFS_ERROR_DEV_RAID5_MIN_NOT_MET
,

148 [
BTRFS_RAID_RAID6
] = {

149 .
sub_°rùes
 = 1,

150 .
	gdev_°rùes
 = 1,

151 .
	gdevs_max
 = 0,

152 .
	gdevs_mö
 = 3,

153 .
	gtﬁî©ed_Áûuªs
 = 2,

154 .
	gdevs_ö¸emít
 = 1,

155 .
	gnc›õs
 = 1,

156 .
	g≈¨ôy
 = 2,

157 .
	gøid_«me
 = "raid6",

158 .
	gbg_Êag
 = 
BTRFS_BLOCK_GROUP_RAID6
,

159 .
	gmödev_îr‹
 = 
BTRFS_ERROR_DEV_RAID6_MIN_NOT_MET
,

167 
båfs_øid_ty≥s
 
__©åibuã_c⁄°__
 
	$båfs_bg_Êags_to_øid_ödex
(
u64
 
Êags
)

169 c⁄° 
u64
 
¥ofûe
 = (
Êags
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
);

171 i‡(!
¥ofûe
)

172  
BTRFS_RAID_SINGLE
;

174  
	`BTRFS_BG_FLAG_TO_INDEX
(
¥ofûe
);

175 
	}
}

177 c⁄° *
	$båfs_bg_ty≥_to_øid_«me
(
u64
 
Êags
)

179 c⁄° 
ödex
 = 
	`båfs_bg_Êags_to_øid_ödex
(
Êags
);

181 i‡(
ödex
 >
BTRFS_NR_RAID_TYPES
)

182  
NULL
;

184  
båfs_øid_¨øy
[
ödex
].
øid_«me
;

185 
	}
}

187 
	$båfs_ƒ_∑rôy_°rùes
(
u64
 
ty≥
)

189 
båfs_øid_ty≥s
 
ödex
 = 
	`båfs_bg_Êags_to_øid_ödex
(
ty≥
);

191  
båfs_øid_¨øy
[
ödex
].
≈¨ôy
;

192 
	}
}

198 
	$båfs_des¸ibe_block_groups
(
u64
 
bg_Êags
, *
buf
, 
u32
 
size_buf
)

200 
i
;

201 
ªt
;

202 *
bp
 = 
buf
;

203 
u64
 
Êags
 = 
bg_Êags
;

204 
u32
 
size_bp
 = 
size_buf
;

206 i‡(!
Êags
) {

207 
	`°r˝y
(
bp
, "NONE");

211 
	#DESCRIBE_FLAG
(
Êag
, 
desc
) \

213 i‡(
Êags
 & (
Êag
)) { \

214 
ªt
 = 
	`¢¥ötf
(
bp
, 
size_bp
, "%s|", (
desc
)); \

215 i‡(
ªt
 < 0 ||Ñë >
size_bp
) \

216 
out_ovîÊow
; \

217 
size_bp
 -
ªt
; \

218 
bp
 +
ªt
; \

219 
Êags
 &~(
Êag
); \

221 } 0)

	)

223 
	`DESCRIBE_FLAG
(
BTRFS_BLOCK_GROUP_DATA
, "data");

224 
	`DESCRIBE_FLAG
(
BTRFS_BLOCK_GROUP_SYSTEM
, "system");

225 
	`DESCRIBE_FLAG
(
BTRFS_BLOCK_GROUP_METADATA
, "metadata");

227 
	`DESCRIBE_FLAG
(
BTRFS_AVAIL_ALLOC_BIT_SINGLE
, "single");

228 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; i++)

229 
	`DESCRIBE_FLAG
(
båfs_øid_¨øy
[
i
].
bg_Êag
,

230 
båfs_øid_¨øy
[
i
].
øid_«me
);

231 #unde‡
DESCRIBE_FLAG


233 i‡(
Êags
) {

234 
ªt
 = 
	`¢¥ötf
(
bp
, 
size_bp
, "0x%Œx|", 
Êags
);

235 
size_bp
 -
ªt
;

238 i‡(
size_bp
 < 
size_buf
)

239 
buf
[
size_buf
 - 
size_bp
 - 1] = '\0';

245 
out_ovîÊow
:;

246 
	}
}

248 
öô_fú°_rw_devi˚
(
båfs_å™s_h™dÀ
 *
å™s
);

249 
båfs_ªloˇã_sys_chunks
(
båfs_fs_öfo
 *
fs_öfo
);

250 
båfs_dev_°©_¥öt_⁄_lﬂd
(
båfs_devi˚
 *
devi˚
);

352 
DEFINE_MUTEX
(
uuid_muãx
);

353 
LIST_HEAD
(
fs_uuids
);

354 
li°_hód
 * 
__©åibuã_c⁄°__
 
	$båfs_gë_fs_uuids
()

356  &
fs_uuids
;

357 
	}
}

368 
båfs_fs_devi˚s
 *
	$Æloc_fs_devi˚s
(c⁄° 
u8
 *
fsid
,

369 c⁄° 
u8
 *
mëad©a_fsid
)

371 
båfs_fs_devi˚s
 *
fs_devs
;

373 
	`ASSERT
(
fsid
 || !
mëad©a_fsid
);

375 
fs_devs
 = 
	`kzÆloc
((*fs_devs), 
GFP_KERNEL
);

376 i‡(!
fs_devs
)

377  
	`ERR_PTR
(-
ENOMEM
);

379 
	`muãx_öô
(&
fs_devs
->
devi˚_li°_muãx
);

381 
	`INIT_LIST_HEAD
(&
fs_devs
->
devi˚s
);

382 
	`INIT_LIST_HEAD
(&
fs_devs
->
Æloc_li°
);

383 
	`INIT_LIST_HEAD
(&
fs_devs
->
fs_li°
);

384 
	`INIT_LIST_HEAD
(&
fs_devs
->
£ed_li°
);

386 i‡(
fsid
) {

387 
	`mem˝y
(
fs_devs
->
fsid
, fsid, 
BTRFS_FSID_SIZE
);

388 
	`mem˝y
(
fs_devs
->
mëad©a_uuid
,

389 
mëad©a_fsid
 ?: 
fsid
, 
BTRFS_FSID_SIZE
);

392  
fs_devs
;

393 
	}
}

395 
	$båfs_‰ì_devi˚
(
båfs_devi˚
 *
devi˚
)

397 
	`WARN_ON
(!
	`li°_em±y
(&
devi˚
->
po°_commô_li°
));

398 
	`rcu_°rög_‰ì
(
devi˚
->
«me
);

399 
	`exã¡_io_åì_ªÀa£
(&
devi˚
->
Æloc_°©e
);

400 
	`båfs_de°roy_dev_z⁄e_öfo
(
devi˚
);

401 
	`k‰ì
(
devi˚
);

402 
	}
}

404 
	$‰ì_fs_devi˚s
(
båfs_fs_devi˚s
 *
fs_devi˚s
)

406 
båfs_devi˚
 *
devi˚
;

408 
	`WARN_ON
(
fs_devi˚s
->
›íed
);

409 !
	`li°_em±y
(&
fs_devi˚s
->
devi˚s
)) {

410 
devi˚
 = 
	`li°_íåy
(
fs_devi˚s
->
devi˚s
.
√xt
,

411 
båfs_devi˚
, 
dev_li°
);

412 
	`li°_dñ
(&
devi˚
->
dev_li°
);

413 
	`båfs_‰ì_devi˚
(
devi˚
);

415 
	`k‰ì
(
fs_devi˚s
);

416 
	}
}

418 
__exô
 
	$båfs_˛ónup_fs_uuids
()

420 
båfs_fs_devi˚s
 *
fs_devi˚s
;

422 !
	`li°_em±y
(&
fs_uuids
)) {

423 
fs_devi˚s
 = 
	`li°_íåy
(
fs_uuids
.
√xt
,

424 
båfs_fs_devi˚s
, 
fs_li°
);

425 
	`li°_dñ
(&
fs_devi˚s
->
fs_li°
);

426 
	`‰ì_fs_devi˚s
(
fs_devi˚s
);

428 
	}
}

430 
boﬁ
 
	$m©ch_fsid_fs_devi˚s
(c⁄° 
båfs_fs_devi˚s
 *
fs_devi˚s
,

431 c⁄° 
u8
 *
fsid
, c⁄° u8 *
mëad©a_fsid
)

433 i‡(
	`memcmp
(
fsid
, 
fs_devi˚s
->fsid, 
BTRFS_FSID_SIZE
) != 0)

434  
Ál£
;

436 i‡(!
mëad©a_fsid
)

437  
åue
;

439 i‡(
	`memcmp
(
mëad©a_fsid
, 
fs_devi˚s
->
mëad©a_uuid
, 
BTRFS_FSID_SIZE
) != 0)

440  
Ál£
;

442  
åue
;

443 
	}
}

445 
noölöe
 
båfs_fs_devi˚s
 *
	$föd_fsid
(

446 c⁄° 
u8
 *
fsid
, c⁄° u8 *
mëad©a_fsid
)

448 
båfs_fs_devi˚s
 *
fs_devi˚s
;

450 
	`ASSERT
(
fsid
);

453 
	`li°_f‹_óch_íåy
(
fs_devi˚s
, &
fs_uuids
, 
fs_li°
) {

454 i‡(
	`m©ch_fsid_fs_devi˚s
(
fs_devi˚s
, 
fsid
, 
mëad©a_fsid
))

455  
fs_devi˚s
;

457  
NULL
;

458 
	}
}

465 
ölöe
 
boﬁ
 
	$check_fsid_ch™ged
(c⁄° 
båfs_fs_devi˚s
 *
fs_devi˚s
,

466 c⁄° 
u8
 *
fsid
)

468  
	`memcmp
(
fs_devi˚s
->
fsid
, fs_devi˚s->
mëad©a_uuid
,

469 
BTRFS_FSID_SIZE
) != 0 &&

470 
	`memcmp
(
fs_devi˚s
->
mëad©a_uuid
, 
fsid
, 
BTRFS_FSID_SIZE
) == 0;

471 
	}
}

473 
båfs_fs_devi˚s
 *
	$föd_fsid_wôh_mëad©a_uuid
(

474 
båfs_su≥r_block
 *
disk_su≥r
)

477 
båfs_fs_devi˚s
 *
fs_devi˚s
;

485 
	`li°_f‹_óch_íåy
(
fs_devi˚s
, &
fs_uuids
, 
fs_li°
) {

486 i‡(!
fs_devi˚s
->
fsid_ch™ge
)

489 i‡(
	`m©ch_fsid_fs_devi˚s
(
fs_devi˚s
, 
disk_su≥r
->
mëad©a_uuid
,

490 
fs_devi˚s
->
fsid
))

491  
fs_devi˚s
;

500 
	`li°_f‹_óch_íåy
(
fs_devi˚s
, &
fs_uuids
, 
fs_li°
) {

501 i‡(!
fs_devi˚s
->
fsid_ch™ge
)

504 i‡(
	`check_fsid_ch™ged
(
fs_devi˚s
, 
disk_su≥r
->
mëad©a_uuid
))

505  
fs_devi˚s
;

508  
	`föd_fsid
(
disk_su≥r
->
fsid
, disk_su≥r->
mëad©a_uuid
);

509 
	}
}

512 
	$båfs_gë_bdev_™d_sb
(c⁄° *
devi˚_∑th
, 
blk_mode_t
 
Êags
, *
hﬁdî
,

513 
Êush
, 
block_devi˚
 **
bdev
,

514 
båfs_su≥r_block
 **
disk_su≥r
)

516 
ªt
;

518 *
bdev
 = 
	`blkdev_gë_by_∑th
(
devi˚_∑th
, 
Êags
, 
hﬁdî
, 
NULL
);

520 i‡(
	`IS_ERR
(*
bdev
)) {

521 
ªt
 = 
	`PTR_ERR
(*
bdev
);

522 
îr‹
;

525 i‡(
Êush
)

526 
	`sync_blockdev
(*
bdev
);

527 
ªt
 = 
	`£t_blocksize
(*
bdev
, 
BTRFS_BDEV_BLOCKSIZE
);

528 i‡(
ªt
) {

529 
	`blkdev_put
(*
bdev
, 
hﬁdî
);

530 
îr‹
;

532 
	`övÆid©e_bdev
(*
bdev
);

533 *
disk_su≥r
 = 
	`båfs_ªad_dev_su≥r
(*
bdev
);

534 i‡(
	`IS_ERR
(*
disk_su≥r
)) {

535 
ªt
 = 
	`PTR_ERR
(*
disk_su≥r
);

536 
	`blkdev_put
(*
bdev
, 
hﬁdî
);

537 
îr‹
;

542 
îr‹
:

543 *
bdev
 = 
NULL
;

544  
ªt
;

545 
	}
}

548 
	$båfs_gë_bdev_™d_sb_∑πôi⁄
(c⁄° *
devi˚_∑th
, 
blk_mode_t
 
Êags
, *
hﬁdî
,

549 
Êush
, 
block_devi˚
 **
bdev
,

550 
båfs_su≥r_block
 **
disk_su≥r
, 
∑πôi⁄_‹dî
)

552 
ªt
;

554 *
bdev
 = 
	`blkdev_gë_by_∑th
(
devi˚_∑th
, 
Êags
, 
hﬁdî
, 
NULL
);

556 i‡(
	`IS_ERR
(*
bdev
)) {

557 
ªt
 = 
	`PTR_ERR
(*
bdev
);

558 
îr‹
;

561 i‡(
Êush
)

562 
	`sync_blockdev
(*
bdev
);

563 
ªt
 = 
	`£t_blocksize
(*
bdev
, 
BTRFS_BDEV_BLOCKSIZE
);

564 i‡(
ªt
) {

565 
	`blkdev_put
(*
bdev
, 
hﬁdî
);

566 
îr‹
;

568 
	`övÆid©e_bdev
(*
bdev
);

569 *
disk_su≥r
 = 
	`båfs_ªad_dev_su≥r_∑πôi⁄
(*
bdev
, 
∑πôi⁄_‹dî
);

570 i‡(
	`IS_ERR
(*
disk_su≥r
)) {

571 
ªt
 = 
	`PTR_ERR
(*
disk_su≥r
);

572 
	`blkdev_put
(*
bdev
, 
hﬁdî
);

573 
îr‹
;

578 
îr‹
:

579 *
bdev
 = 
NULL
;

580  
ªt
;

581 
	}
}

596 
	$båfs_‰ì_°Æe_devi˚s
(
dev_t
 
devt
, 
båfs_devi˚
 *
skù_devi˚
)

598 
båfs_fs_devi˚s
 *
fs_devi˚s
, *
tmp_fs_devi˚s
;

599 
båfs_devi˚
 *
devi˚
, *
tmp_devi˚
;

600 
ªt
 = 0;

602 
	`lockdï_as£π_hñd
(&
uuid_muãx
);

604 i‡(
devt
)

605 
ªt
 = -
ENOENT
;

607 
	`li°_f‹_óch_íåy_ß„
(
fs_devi˚s
, 
tmp_fs_devi˚s
, &
fs_uuids
, 
fs_li°
) {

609 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

610 
	`li°_f‹_óch_íåy_ß„
(
devi˚
, 
tmp_devi˚
,

611 &
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

612 i‡(
skù_devi˚
 && skù_devi˚ =
devi˚
)

614 i‡(
devt
 && devà!
devi˚
->devt)

616 i‡(
fs_devi˚s
->
›íed
) {

618 i‡(
devt
 && 
ªt
 != 0)

619 
ªt
 = -
EBUSY
;

624 
fs_devi˚s
->
num_devi˚s
--;

625 
	`li°_dñ
(&
devi˚
->
dev_li°
);

626 
	`båfs_‰ì_devi˚
(
devi˚
);

628 
ªt
 = 0;

630 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

632 i‡(
fs_devi˚s
->
num_devi˚s
 == 0) {

633 
	`båfs_sysfs_ªmove_fsid
(
fs_devi˚s
);

634 
	`li°_dñ
(&
fs_devi˚s
->
fs_li°
);

635 
	`‰ì_fs_devi˚s
(
fs_devi˚s
);

639  
ªt
;

640 
	}
}

647 
	$båfs_›í_⁄e_devi˚
(
båfs_fs_devi˚s
 *
fs_devi˚s
,

648 
båfs_devi˚
 *
devi˚
, 
blk_mode_t
 
Êags
,

649 *
hﬁdî
)

651 
block_devi˚
 *
bdev
;

652 
båfs_su≥r_block
 *
disk_su≥r
;

653 
u64
 
devid
;

654 
ªt
;

656 i‡(
devi˚
->
bdev
)

657  -
EINVAL
;

658 i‡(!
devi˚
->
«me
)

659  -
EINVAL
;

661 
ªt
 = 
	`båfs_gë_bdev_™d_sb
(
devi˚
->
«me
->
°r
, 
Êags
, 
hﬁdî
, 1,

662 &
bdev
, &
disk_su≥r
);

663 i‡(
ªt
)

664  
ªt
;

666 
devid
 = 
	`båfs_°ack_devi˚_id
(&
disk_su≥r
->
dev_ôem
);

667 i‡(
devid
 !
devi˚
->devid)

668 
îr‹_‰ì_∑ge
;

670 i‡(
	`memcmp
(
devi˚
->
uuid
, 
disk_su≥r
->
dev_ôem
.uuid, 
BTRFS_UUID_SIZE
))

671 
îr‹_‰ì_∑ge
;

673 
devi˚
->
gíî©i⁄
 = 
	`båfs_su≥r_gíî©i⁄
(
disk_su≥r
);

675 i‡(
	`båfs_su≥r_Êags
(
disk_su≥r
Ë& 
BTRFS_SUPER_FLAG_SEEDING
) {

676 i‡(
	`båfs_su≥r_öcom∑t_Êags
(
disk_su≥r
) &

677 
BTRFS_FEATURE_INCOMPAT_METADATA_UUID
) {

678 
	`¥_îr
(

680 
îr‹_‰ì_∑ge
;

683 
	`˛ór_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
);

684 
fs_devi˚s
->
£edög
 = 
åue
;

686 i‡(
	`bdev_ªad_⁄ly
(
bdev
))

687 
	`˛ór_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
);

689 
	`£t_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
);

692 i‡(!
	`bdev_n⁄rŸ
(
bdev
))

693 
fs_devi˚s
->
rŸ©ög
 = 
åue
;

695 i‡(
	`bdev_max_disˇrd_£˘‹s
(
bdev
))

696 
fs_devi˚s
->
disˇrdabÀ
 = 
åue
;

698 
devi˚
->
bdev
 = bdev;

699 
	`˛ór_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
devi˚
->
dev_°©e
);

700 
devi˚
->
hﬁdî
 = holder;

702 
fs_devi˚s
->
›í_devi˚s
++;

703 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
) &&

704 
devi˚
->
devid
 !
BTRFS_DEV_REPLACE_DEVID
) {

705 
fs_devi˚s
->
rw_devi˚s
++;

706 
	`li°_add_èû
(&
devi˚
->
dev_Æloc_li°
, &
fs_devi˚s
->
Æloc_li°
);

708 
	`båfs_ªÀa£_disk_su≥r
(
disk_su≥r
);

712 
îr‹_‰ì_∑ge
:

713 
	`båfs_ªÀa£_disk_su≥r
(
disk_su≥r
);

714 
	`blkdev_put
(
bdev
, 
hﬁdî
);

716  -
EINVAL
;

717 
	}
}

720 
	$båfs_›í_⁄e_devi˚_∑πôi⁄
(
båfs_fs_devi˚s
 *
fs_devi˚s
,

721 
båfs_devi˚
 *
devi˚
, 
blk_mode_t
 
Êags
,

722 *
hﬁdî
, 
∑πôi⁄_‹dî
)

724 
block_devi˚
 *
bdev
;

725 
båfs_su≥r_block
 *
disk_su≥r
;

726 
u64
 
devid
;

727 
ªt
;

729 i‡(
devi˚
->
bdev
)

730  -
EINVAL
;

731 i‡(!
devi˚
->
«me
)

732  -
EINVAL
;

734 
ªt
 = 
	`båfs_gë_bdev_™d_sb_∑πôi⁄
(
devi˚
->
«me
->
°r
, 
Êags
, 
hﬁdî
, 1,

735 &
bdev
, &
disk_su≥r
, 
∑πôi⁄_‹dî
);

736 i‡(
ªt
)

737  
ªt
;

739 
devid
 = 
	`båfs_°ack_devi˚_id
(&
disk_su≥r
->
dev_ôem
);

740 i‡(
devid
 !
devi˚
->devid)

741 
îr‹_‰ì_∑ge
;

743 i‡(
	`memcmp
(
devi˚
->
uuid
, 
disk_su≥r
->
dev_ôem
.uuid, 
BTRFS_UUID_SIZE
))

744 
îr‹_‰ì_∑ge
;

746 
devi˚
->
gíî©i⁄
 = 
	`båfs_su≥r_gíî©i⁄
(
disk_su≥r
);

748 i‡(
	`båfs_su≥r_Êags
(
disk_su≥r
Ë& 
BTRFS_SUPER_FLAG_SEEDING
) {

749 i‡(
	`båfs_su≥r_öcom∑t_Êags
(
disk_su≥r
) &

750 
BTRFS_FEATURE_INCOMPAT_METADATA_UUID
) {

751 
	`¥_îr
(

753 
îr‹_‰ì_∑ge
;

756 
	`˛ór_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
);

757 
fs_devi˚s
->
£edög
 = 
åue
;

759 i‡(
	`bdev_ªad_⁄ly
(
bdev
))

760 
	`˛ór_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
);

762 
	`£t_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
);

765 i‡(!
	`bdev_n⁄rŸ
(
bdev
))

766 
fs_devi˚s
->
rŸ©ög
 = 
åue
;

768 i‡(
	`bdev_max_disˇrd_£˘‹s
(
bdev
))

769 
fs_devi˚s
->
disˇrdabÀ
 = 
åue
;

771 
devi˚
->
bdev
 = bdev;

772 
	`˛ór_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
devi˚
->
dev_°©e
);

773 
devi˚
->
hﬁdî
 = holder;

775 
fs_devi˚s
->
›í_devi˚s
++;

776 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
) &&

777 
devi˚
->
devid
 !
BTRFS_DEV_REPLACE_DEVID
) {

778 
fs_devi˚s
->
rw_devi˚s
++;

779 
	`li°_add_èû
(&
devi˚
->
dev_Æloc_li°
, &
fs_devi˚s
->
Æloc_li°
);

781 
	`båfs_ªÀa£_disk_su≥r
(
disk_su≥r
);

785 
îr‹_‰ì_∑ge
:

786 
	`båfs_ªÀa£_disk_su≥r
(
disk_su≥r
);

787 
	`blkdev_put
(
bdev
, 
hﬁdî
);

789  -
EINVAL
;

790 
	}
}

792 
u8
 *
	$båfs_sb_fsid_±r
(
båfs_su≥r_block
 *
sb
)

794 
boﬁ
 
has_mëad©a_uuid
 = (
	`båfs_su≥r_öcom∑t_Êags
(
sb
) &

795 
BTRFS_FEATURE_INCOMPAT_METADATA_UUID
);

797  
has_mëad©a_uuid
 ? 
sb
->
mëad©a_uuid
 : sb->
fsid
;

798 
	}
}

806 
båfs_fs_devi˚s
 *
	$föd_fsid_ö¥ogªss
(

807 
båfs_su≥r_block
 *
disk_su≥r
)

809 
båfs_fs_devi˚s
 *
fs_devi˚s
;

811 
	`li°_f‹_óch_íåy
(
fs_devi˚s
, &
fs_uuids
, 
fs_li°
) {

812 i‡(
fs_devi˚s
->
fsid_ch™ge
)

815 i‡(
	`check_fsid_ch™ged
(
fs_devi˚s
, 
disk_su≥r
->
fsid
))

816  
fs_devi˚s
;

819  
	`föd_fsid
(
disk_su≥r
->
fsid
, 
NULL
);

820 
	}
}

822 
båfs_fs_devi˚s
 *
	$föd_fsid_ch™ged
(

823 
båfs_su≥r_block
 *
disk_su≥r
)

825 
båfs_fs_devi˚s
 *
fs_devi˚s
;

836 
	`li°_f‹_óch_íåy
(
fs_devi˚s
, &
fs_uuids
, 
fs_li°
) {

838 i‡(
	`check_fsid_ch™ged
(
fs_devi˚s
, 
disk_su≥r
->
mëad©a_uuid
) &&

839 
	`memcmp
(
fs_devi˚s
->
fsid
, 
disk_su≥r
->fsid,

840 
BTRFS_FSID_SIZE
) != 0)

841  
fs_devi˚s
;

844 i‡(
	`memcmp
(
fs_devi˚s
->
mëad©a_uuid
, fs_devi˚s->
fsid
,

845 
BTRFS_FSID_SIZE
) == 0 &&

846 
	`memcmp
(
fs_devi˚s
->
fsid
, 
disk_su≥r
->
mëad©a_uuid
,

847 
BTRFS_FSID_SIZE
) == 0)

848  
fs_devi˚s
;

851  
NULL
;

852 
	}
}

854 
båfs_fs_devi˚s
 *
	$föd_fsid_ªvîãd_mëad©a
(

855 
båfs_su≥r_block
 *
disk_su≥r
)

857 
båfs_fs_devi˚s
 *
fs_devi˚s
;

868 
	`li°_f‹_óch_íåy
(
fs_devi˚s
, &
fs_uuids
, 
fs_li°
) {

869 i‡(!
fs_devi˚s
->
fsid_ch™ge
)

872 i‡(
	`check_fsid_ch™ged
(
fs_devi˚s
, 
disk_su≥r
->
fsid
))

873  
fs_devi˚s
;

876  
NULL
;

877 
	}
}

885 
noölöe
 
båfs_devi˚
 *
	$devi˚_li°_add
(c⁄° *
∑th
,

886 
båfs_su≥r_block
 *
disk_su≥r
,

887 
boﬁ
 *
√w_devi˚_added
)

889 
båfs_devi˚
 *
devi˚
;

890 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
NULL
;

891 
rcu_°rög
 *
«me
;

892 
u64
 
found_å™sid
 = 
	`båfs_su≥r_gíî©i⁄
(
disk_su≥r
);

893 
u64
 
devid
 = 
	`båfs_°ack_devi˚_id
(&
disk_su≥r
->
dev_ôem
);

894 
dev_t
 
∑th_devt
;

895 
îr‹
;

896 
boﬁ
 
has_mëad©a_uuid
 = (
	`båfs_su≥r_öcom∑t_Êags
(
disk_su≥r
) &

897 
BTRFS_FEATURE_INCOMPAT_METADATA_UUID
);

898 
boﬁ
 
fsid_ch™ge_ö_¥ogªss
 = (
	`båfs_su≥r_Êags
(
disk_su≥r
) &

899 
BTRFS_SUPER_FLAG_CHANGING_FSID_V2
);

901 
îr‹
 = 
	`lookup_bdev
(
∑th
, &
∑th_devt
);

902 i‡(
îr‹
) {

903 
	`båfs_îr
(
NULL
, "failedÅoÜookup block device forÖath %s: %d",

904 
∑th
, 
îr‹
);

905  
	`ERR_PTR
(
îr‹
);

908 i‡(
fsid_ch™ge_ö_¥ogªss
) {

909 i‡(!
has_mëad©a_uuid
)

910 
fs_devi˚s
 = 
	`föd_fsid_ö¥ogªss
(
disk_su≥r
);

912 
fs_devi˚s
 = 
	`föd_fsid_ch™ged
(
disk_su≥r
);

913 } i‡(
has_mëad©a_uuid
) {

914 
fs_devi˚s
 = 
	`föd_fsid_wôh_mëad©a_uuid
(
disk_su≥r
);

916 
fs_devi˚s
 = 
	`föd_fsid_ªvîãd_mëad©a
(
disk_su≥r
);

917 i‡(!
fs_devi˚s
)

918 
fs_devi˚s
 = 
	`föd_fsid
(
disk_su≥r
->
fsid
, 
NULL
);

922 i‡(!
fs_devi˚s
) {

923 
fs_devi˚s
 = 
	`Æloc_fs_devi˚s
(
disk_su≥r
->
fsid
,

924 
has_mëad©a_uuid
 ? 
disk_su≥r
->
mëad©a_uuid
 : 
NULL
);

925 i‡(
	`IS_ERR
(
fs_devi˚s
))

926  
	`ERR_CAST
(
fs_devi˚s
);

928 
fs_devi˚s
->
fsid_ch™ge
 = 
fsid_ch™ge_ö_¥ogªss
;

930 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

931 
	`li°_add
(&
fs_devi˚s
->
fs_li°
, &
fs_uuids
);

933 
devi˚
 = 
NULL
;

935 
båfs_dev_lookup_¨gs
 
¨gs
 = {

936 .
devid
 = devid,

937 .
uuid
 = 
disk_su≥r
->
dev_ôem
.uuid,

940 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

941 
devi˚
 = 
	`båfs_föd_devi˚
(
fs_devi˚s
, &
¨gs
);

948 i‡(
fs_devi˚s
->
fsid_ch™ge
 &&

949 
found_å™sid
 > 
fs_devi˚s
->
œã°_gíî©i⁄
) {

950 
	`mem˝y
(
fs_devi˚s
->
fsid
, 
disk_su≥r
->fsid,

951 
BTRFS_FSID_SIZE
);

952 
	`mem˝y
(
fs_devi˚s
->
mëad©a_uuid
,

953 
	`båfs_sb_fsid_±r
(
disk_su≥r
), 
BTRFS_FSID_SIZE
);

954 
fs_devi˚s
->
fsid_ch™ge
 = 
Ál£
;

958 i‡(!
devi˚
) {

959 
nofs_Êag
;

961 i‡(
fs_devi˚s
->
›íed
) {

962 
	`båfs_îr
(
NULL
,

964 
∑th
, 
fs_devi˚s
->
fsid
, 
cuºít
->
comm
,

965 
	`èsk_pid_ƒ
(
cuºít
));

966 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

967  
	`ERR_PTR
(-
EBUSY
);

970 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

971 
devi˚
 = 
	`båfs_Æloc_devi˚
(
NULL
, &
devid
,

972 
disk_su≥r
->
dev_ôem
.
uuid
, 
∑th
);

973 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

974 i‡(
	`IS_ERR
(
devi˚
)) {

975 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

977  
devi˚
;

980 
devi˚
->
devt
 = 
∑th_devt
;

982 
	`li°_add_rcu
(&
devi˚
->
dev_li°
, &
fs_devi˚s
->
devi˚s
);

983 
fs_devi˚s
->
num_devi˚s
++;

985 
devi˚
->
fs_devi˚s
 = fs_devices;

986 *
√w_devi˚_added
 = 
åue
;

988 i‡(
disk_su≥r
->
œbñ
[0])

989 
	`¥_öfo
(

991 
disk_su≥r
->
œbñ
, 
devid
, 
found_å™sid
, 
∑th
,

992 
cuºít
->
comm
, 
	`èsk_pid_ƒ
(current));

994 
	`¥_öfo
(

996 
disk_su≥r
->
fsid
, 
devid
, 
found_å™sid
, 
∑th
,

997 
cuºít
->
comm
, 
	`èsk_pid_ƒ
(current));

999 } i‡(!
devi˚
->
«me
 || 
	`°rcmp
(devi˚->«me->
°r
, 
∑th
)) {

1026 i‡(!
fs_devi˚s
->
›íed
 && 
found_å™sid
 < 
devi˚
->
gíî©i⁄
) {

1034 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

1035 
	`båfs_îr
(
NULL
,

1037 
∑th
, 
found_å™sid
, 
devi˚
->
gíî©i⁄
);

1038  
	`ERR_PTR
(-
EEXIST
);

1050 i‡(
devi˚
->
bdev
) {

1051 i‡(
devi˚
->
devt
 !
∑th_devt
) {

1052 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

1053 
	`båfs_w¨n_ö_rcu
(
NULL
,

1055 
∑th
, 
devid
, 
found_å™sid
,

1056 
cuºít
->
comm
,

1057 
	`èsk_pid_ƒ
(
cuºít
));

1058  
	`ERR_PTR
(-
EEXIST
);

1060 
	`båfs_öfo_ö_rcu
(
NULL
,

1062 
devid
, 
	`båfs_dev_«me
(
devi˚
),

1063 
∑th
, 
cuºít
->
comm
,

1064 
	`èsk_pid_ƒ
(
cuºít
));

1067 
«me
 = 
	`rcu_°rög_°rdup
(
∑th
, 
GFP_NOFS
);

1068 i‡(!
«me
) {

1069 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

1070  
	`ERR_PTR
(-
ENOMEM
);

1072 
	`rcu_°rög_‰ì
(
devi˚
->
«me
);

1073 
	`rcu_assign_poöãr
(
devi˚
->
«me
,Çame);

1074 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
, &
devi˚
->
dev_°©e
)) {

1075 
fs_devi˚s
->
missög_devi˚s
--;

1076 
	`˛ór_bô
(
BTRFS_DEV_STATE_MISSING
, &
devi˚
->
dev_°©e
);

1078 
devi˚
->
devt
 = 
∑th_devt
;

1087 i‡(!
fs_devi˚s
->
›íed
) {

1088 
devi˚
->
gíî©i⁄
 = 
found_å™sid
;

1089 
fs_devi˚s
->
œã°_gíî©i⁄
 = 
	`max_t
(
u64
, 
found_å™sid
,

1090 
fs_devi˚s
->
œã°_gíî©i⁄
);

1093 
fs_devi˚s
->
tŸÆ_devi˚s
 = 
	`båfs_su≥r_num_devi˚s
(
disk_su≥r
);

1095 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

1096  
devi˚
;

1097 
	}
}

1099 
båfs_fs_devi˚s
 *
	$˛⁄e_fs_devi˚s
(
båfs_fs_devi˚s
 *
‹ig
)

1101 
båfs_fs_devi˚s
 *
fs_devi˚s
;

1102 
båfs_devi˚
 *
devi˚
;

1103 
båfs_devi˚
 *
‹ig_dev
;

1104 
ªt
 = 0;

1106 
	`lockdï_as£π_hñd
(&
uuid_muãx
);

1108 
fs_devi˚s
 = 
	`Æloc_fs_devi˚s
(
‹ig
->
fsid
, 
NULL
);

1109 i‡(
	`IS_ERR
(
fs_devi˚s
))

1110  
fs_devi˚s
;

1112 
fs_devi˚s
->
tŸÆ_devi˚s
 = 
‹ig
->total_devices;

1114 
	`li°_f‹_óch_íåy
(
‹ig_dev
, &
‹ig
->
devi˚s
, 
dev_li°
) {

1115 c⁄° *
dev_∑th
 = 
NULL
;

1121 i‡(
‹ig_dev
->
«me
)

1122 
dev_∑th
 = 
‹ig_dev
->
«me
->
°r
;

1124 
devi˚
 = 
	`båfs_Æloc_devi˚
(
NULL
, &
‹ig_dev
->
devid
,

1125 
‹ig_dev
->
uuid
, 
dev_∑th
);

1126 i‡(
	`IS_ERR
(
devi˚
)) {

1127 
ªt
 = 
	`PTR_ERR
(
devi˚
);

1128 
îr‹
;

1131 i‡(
‹ig_dev
->
z⁄e_öfo
) {

1132 
båfs_z⁄ed_devi˚_öfo
 *
z⁄e_öfo
;

1134 
z⁄e_öfo
 = 
	`båfs_˛⁄e_dev_z⁄e_öfo
(
‹ig_dev
);

1135 i‡(!
z⁄e_öfo
) {

1136 
	`båfs_‰ì_devi˚
(
devi˚
);

1137 
ªt
 = -
ENOMEM
;

1138 
îr‹
;

1140 
devi˚
->
z⁄e_öfo
 = zone_info;

1143 
	`li°_add
(&
devi˚
->
dev_li°
, &
fs_devi˚s
->
devi˚s
);

1144 
devi˚
->
fs_devi˚s
 = fs_devices;

1145 
fs_devi˚s
->
num_devi˚s
++;

1147  
fs_devi˚s
;

1148 
îr‹
:

1149 
	`‰ì_fs_devi˚s
(
fs_devi˚s
);

1150  
	`ERR_PTR
(
ªt
);

1151 
	}
}

1153 
	$__båfs_‰ì_exåa_devids
(
båfs_fs_devi˚s
 *
fs_devi˚s
,

1154 
båfs_devi˚
 **
œã°_dev
)

1156 
båfs_devi˚
 *
devi˚
, *
√xt
;

1159 
	`li°_f‹_óch_íåy_ß„
(
devi˚
, 
√xt
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

1160 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
devi˚
->
dev_°©e
)) {

1161 i‡(!
	`ã°_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
,

1162 &
devi˚
->
dev_°©e
) &&

1163 !
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
,

1164 &
devi˚
->
dev_°©e
) &&

1165 (!*
œã°_dev
 ||

1166 
devi˚
->
gíî©i⁄
 > (*
œã°_dev
)->generation)) {

1167 *
œã°_dev
 = 
devi˚
;

1176 i‡(
devi˚
->
devid
 =
BTRFS_DEV_REPLACE_DEVID
)

1179 i‡(
devi˚
->
bdev
) {

1180 
	`blkdev_put
(
devi˚
->
bdev
, devi˚->
hﬁdî
);

1181 
devi˚
->
bdev
 = 
NULL
;

1182 
fs_devi˚s
->
›í_devi˚s
--;

1184 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
)) {

1185 
	`li°_dñ_öô
(&
devi˚
->
dev_Æloc_li°
);

1186 
	`˛ór_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
);

1187 
fs_devi˚s
->
rw_devi˚s
--;

1189 
	`li°_dñ_öô
(&
devi˚
->
dev_li°
);

1190 
fs_devi˚s
->
num_devi˚s
--;

1191 
	`båfs_‰ì_devi˚
(
devi˚
);

1194 
	}
}

1200 
	$båfs_‰ì_exåa_devids
(
båfs_fs_devi˚s
 *
fs_devi˚s
)

1202 
båfs_devi˚
 *
œã°_dev
 = 
NULL
;

1203 
båfs_fs_devi˚s
 *
£ed_dev
;

1205 
	`muãx_lock
(&
uuid_muãx
);

1206 
	`__båfs_‰ì_exåa_devids
(
fs_devi˚s
, &
œã°_dev
);

1208 
	`li°_f‹_óch_íåy
(
£ed_dev
, &
fs_devi˚s
->
£ed_li°
, seed_list)

1209 
	`__båfs_‰ì_exåa_devids
(
£ed_dev
, &
œã°_dev
);

1211 
fs_devi˚s
->
œã°_dev
 =Üatest_dev;

1213 
	`muãx_u∆ock
(&
uuid_muãx
);

1214 
	}
}

1216 
	$båfs_˛o£_bdev
(
båfs_devi˚
 *
devi˚
)

1218 i‡(!
devi˚
->
bdev
)

1221 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
)) {

1222 
	`sync_blockdev
(
devi˚
->
bdev
);

1223 
	`övÆid©e_bdev
(
devi˚
->
bdev
);

1226 
	`blkdev_put
(
devi˚
->
bdev
, devi˚->
hﬁdî
);

1227 
	}
}

1229 
	$båfs_˛o£_⁄e_devi˚
(
båfs_devi˚
 *
devi˚
)

1231 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
devi˚
->fs_devices;

1233 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
) &&

1234 
devi˚
->
devid
 !
BTRFS_DEV_REPLACE_DEVID
) {

1235 
	`li°_dñ_öô
(&
devi˚
->
dev_Æloc_li°
);

1236 
fs_devi˚s
->
rw_devi˚s
--;

1239 i‡(
devi˚
->
devid
 =
BTRFS_DEV_REPLACE_DEVID
)

1240 
	`˛ór_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
);

1242 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
, &
devi˚
->
dev_°©e
)) {

1243 
	`˛ór_bô
(
BTRFS_DEV_STATE_MISSING
, &
devi˚
->
dev_°©e
);

1244 
fs_devi˚s
->
missög_devi˚s
--;

1247 
	`båfs_˛o£_bdev
(
devi˚
);

1248 i‡(
devi˚
->
bdev
) {

1249 
fs_devi˚s
->
›í_devi˚s
--;

1250 
devi˚
->
bdev
 = 
NULL
;

1252 
	`˛ór_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
);

1253 
	`båfs_de°roy_dev_z⁄e_öfo
(
devi˚
);

1255 
devi˚
->
fs_öfo
 = 
NULL
;

1256 
	`©omic_£t
(&
devi˚
->
dev_°©s_c˙t
, 0);

1257 
	`exã¡_io_åì_ªÀa£
(&
devi˚
->
Æloc_°©e
);

1270 
devi˚
->
œ°_Êush_îr‹
 = 0;

1273 
	`WARN_ON
(
	`ã°_bô
(
BTRFS_DEV_STATE_FLUSH_SENT
, &
devi˚
->
dev_°©e
));

1274 
	`WARN_ON
(
	`ã°_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
));

1275 
	`WARN_ON
(!
	`li°_em±y
(&
devi˚
->
dev_Æloc_li°
));

1276 
	`WARN_ON
(!
	`li°_em±y
(&
devi˚
->
po°_commô_li°
));

1277 
	}
}

1279 
	$˛o£_fs_devi˚s
(
båfs_fs_devi˚s
 *
fs_devi˚s
)

1281 
båfs_devi˚
 *
devi˚
, *
tmp
;

1283 
	`lockdï_as£π_hñd
(&
uuid_muãx
);

1285 i‡(--
fs_devi˚s
->
›íed
 > 0)

1288 
	`li°_f‹_óch_íåy_ß„
(
devi˚
, 
tmp
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
)

1289 
	`båfs_˛o£_⁄e_devi˚
(
devi˚
);

1291 
	`WARN_ON
(
fs_devi˚s
->
›í_devi˚s
);

1292 
	`WARN_ON
(
fs_devi˚s
->
rw_devi˚s
);

1293 
fs_devi˚s
->
›íed
 = 0;

1294 
fs_devi˚s
->
£edög
 = 
Ál£
;

1295 
fs_devi˚s
->
fs_öfo
 = 
NULL
;

1296 
	}
}

1298 
	$båfs_˛o£_devi˚s
(
båfs_fs_devi˚s
 *
fs_devi˚s
)

1300 
	`LIST_HEAD
(
li°
);

1301 
båfs_fs_devi˚s
 *
tmp
;

1303 
	`muãx_lock
(&
uuid_muãx
);

1304 
	`˛o£_fs_devi˚s
(
fs_devi˚s
);

1305 i‡(!
fs_devi˚s
->
›íed
) {

1306 
	`li°_•li˚_öô
(&
fs_devi˚s
->
£ed_li°
, &
li°
);

1314 i‡(
fs_devi˚s
->
num_devi˚s
 == 1) {

1315 
	`li°_dñ
(&
fs_devi˚s
->
fs_li°
);

1316 
	`‰ì_fs_devi˚s
(
fs_devi˚s
);

1321 
	`li°_f‹_óch_íåy_ß„
(
fs_devi˚s
, 
tmp
, &
li°
, 
£ed_li°
) {

1322 
	`˛o£_fs_devi˚s
(
fs_devi˚s
);

1323 
	`li°_dñ
(&
fs_devi˚s
->
£ed_li°
);

1324 
	`‰ì_fs_devi˚s
(
fs_devi˚s
);

1326 
	`muãx_u∆ock
(&
uuid_muãx
);

1327 
	}
}

1329 
	$›í_fs_devi˚s
(
båfs_fs_devi˚s
 *
fs_devi˚s
,

1330 
blk_mode_t
 
Êags
, *
hﬁdî
)

1332 
båfs_devi˚
 *
devi˚
;

1333 
båfs_devi˚
 *
œã°_dev
 = 
NULL
;

1334 
båfs_devi˚
 *
tmp_devi˚
;

1336 
	`li°_f‹_óch_íåy_ß„
(
devi˚
, 
tmp_devi˚
, &
fs_devi˚s
->
devi˚s
,

1337 
dev_li°
) {

1338 
ªt
;

1340 
ªt
 = 
	`båfs_›í_⁄e_devi˚
(
fs_devi˚s
, 
devi˚
, 
Êags
, 
hﬁdî
);

1341 i‡(
ªt
 == 0 &&

1342 (!
œã°_dev
 || 
devi˚
->
gíî©i⁄
 >Üatest_dev->generation)) {

1343 
œã°_dev
 = 
devi˚
;

1344 } i‡(
ªt
 =-
ENODATA
) {

1345 
fs_devi˚s
->
num_devi˚s
--;

1346 
	`li°_dñ
(&
devi˚
->
dev_li°
);

1347 
	`båfs_‰ì_devi˚
(
devi˚
);

1350 i‡(
fs_devi˚s
->
›í_devi˚s
 == 0)

1351  -
EINVAL
;

1353 
fs_devi˚s
->
›íed
 = 1;

1354 
fs_devi˚s
->
œã°_dev
 =Üatest_dev;

1355 
fs_devi˚s
->
tŸÆ_rw_byãs
 = 0;

1356 
fs_devi˚s
->
chunk_Æloc_pﬁicy
 = 
BTRFS_CHUNK_ALLOC_REGULAR
;

1357 
fs_devi˚s
->
ªad_pﬁicy
 = 
BTRFS_READ_POLICY_PID
;

1360 
	}
}

1363 
	$›í_fs_devi˚s_∑πôi⁄
(
båfs_fs_devi˚s
 *
fs_devi˚s
,

1364 
blk_mode_t
 
Êags
, *
hﬁdî
, 
∑πôi⁄_‹dî
)

1366 
båfs_devi˚
 *
devi˚
;

1367 
båfs_devi˚
 *
œã°_dev
 = 
NULL
;

1368 
båfs_devi˚
 *
tmp_devi˚
;

1370 
	`li°_f‹_óch_íåy_ß„
(
devi˚
, 
tmp_devi˚
, &
fs_devi˚s
->
devi˚s
,

1371 
dev_li°
) {

1372 
ªt
;

1374 
ªt
 = 
	`båfs_›í_⁄e_devi˚_∑πôi⁄
(
fs_devi˚s
, 
devi˚
, 
Êags
, 
hﬁdî
, 
∑πôi⁄_‹dî
);

1375 i‡(
ªt
 == 0 &&

1376 (!
œã°_dev
 || 
devi˚
->
gíî©i⁄
 >Üatest_dev->generation)) {

1377 
œã°_dev
 = 
devi˚
;

1378 } i‡(
ªt
 =-
ENODATA
) {

1379 
fs_devi˚s
->
num_devi˚s
--;

1380 
	`li°_dñ
(&
devi˚
->
dev_li°
);

1381 
	`båfs_‰ì_devi˚
(
devi˚
);

1384 i‡(
fs_devi˚s
->
›í_devi˚s
 == 0)

1385  -
EINVAL
;

1387 
fs_devi˚s
->
›íed
 = 1;

1388 
fs_devi˚s
->
œã°_dev
 =Üatest_dev;

1389 
fs_devi˚s
->
tŸÆ_rw_byãs
 = 0;

1390 
fs_devi˚s
->
chunk_Æloc_pﬁicy
 = 
BTRFS_CHUNK_ALLOC_REGULAR
;

1391 
fs_devi˚s
->
ªad_pﬁicy
 = 
BTRFS_READ_POLICY_PID
;

1394 
	}
}

1396 
	$devid_cmp
(*
¥iv
, c⁄° 
li°_hód
 *
a
,

1397 c⁄° 
li°_hód
 *
b
)

1399 c⁄° 
båfs_devi˚
 *
dev1
, *
dev2
;

1401 
dev1
 = 
	`li°_íåy
(
a
, 
båfs_devi˚
, 
dev_li°
);

1402 
dev2
 = 
	`li°_íåy
(
b
, 
båfs_devi˚
, 
dev_li°
);

1404 i‡(
dev1
->
devid
 < 
dev2
->devid)

1406 i‡(
dev1
->
devid
 > 
dev2
->devid)

1409 
	}
}

1411 
	$båfs_›í_devi˚s
(
båfs_fs_devi˚s
 *
fs_devi˚s
,

1412 
blk_mode_t
 
Êags
, *
hﬁdî
)

1414 
ªt
;

1416 
	`lockdï_as£π_hñd
(&
uuid_muãx
);

1425 i‡(
fs_devi˚s
->
›íed
) {

1426 
fs_devi˚s
->
›íed
++;

1427 
ªt
 = 0;

1429 
	`li°_s‹t
(
NULL
, &
fs_devi˚s
->
devi˚s
, 
devid_cmp
);

1430 
ªt
 = 
	`›í_fs_devi˚s
(
fs_devi˚s
, 
Êags
, 
hﬁdî
);

1433  
ªt
;

1434 
	}
}

1437 
	$båfs_›í_devi˚s_∑πôi⁄
(
båfs_fs_devi˚s
 *
fs_devi˚s
,

1438 
blk_mode_t
 
Êags
, *
hﬁdî
, 
∑πôi⁄_‹dî
)

1440 
ªt
;

1442 
	`lockdï_as£π_hñd
(&
uuid_muãx
);

1451 i‡(
fs_devi˚s
->
›íed
) {

1452 
fs_devi˚s
->
›íed
++;

1453 
ªt
 = 0;

1455 
	`li°_s‹t
(
NULL
, &
fs_devi˚s
->
devi˚s
, 
devid_cmp
);

1456 
ªt
 = 
	`›í_fs_devi˚s_∑πôi⁄
(
fs_devi˚s
, 
Êags
, 
hﬁdî
, 
∑πôi⁄_‹dî
);

1459  
ªt
;

1460 
	}
}

1462 
	$båfs_ªÀa£_disk_su≥r
(
båfs_su≥r_block
 *
su≥r
)

1464 
∑ge
 *∑gê
	`vút_to_∑ge
(
su≥r
);

1466 
	`put_∑ge
(
∑ge
);

1467 
	}
}

1469 
båfs_su≥r_block
 *
	$båfs_ªad_disk_su≥r
(
block_devi˚
 *
bdev
,

1470 
u64
 
byãƒ
, u64 
byãƒ_‹ig
)

1472 
båfs_su≥r_block
 *
disk_su≥r
;

1473 
∑ge
 *page;

1474 *
p
;

1475 
pgoff_t
 
ödex
;

1478 i‡(
byãƒ
 + 
PAGE_SIZE
 >
	`bdev_ƒ_byãs
(
bdev
))

1479  
	`ERR_PTR
(-
EINVAL
);

1482 i‡((*
disk_su≥r
Ë> 
PAGE_SIZE
)

1483  
	`ERR_PTR
(-
EINVAL
);

1486 
ödex
 = 
byãƒ
 >> 
PAGE_SHIFT
;

1487 i‡((
byãƒ
 + (*
disk_su≥r
Ë- 1Ë>> 
PAGE_SHIFT
 !
ödex
)

1488  
	`ERR_PTR
(-
EINVAL
);

1491 
∑ge
 = 
	`ªad_ˇche_∑ge_gÂ
(
bdev
->
bd_öode
->
i_m≠pög
, 
ödex
, 
GFP_KERNEL
);

1493 i‡(
	`IS_ERR
(
∑ge
))

1494  
	`ERR_CAST
(
∑ge
);

1496 
p
 = 
	`∑ge_addªss
(
∑ge
);

1499 
disk_su≥r
 = 
p
 + 
	`off£t_ö_∑ge
(
byãƒ
);

1501 i‡(
	`båfs_su≥r_byãƒ
(
disk_su≥r
Ë!
byãƒ_‹ig
 ||

1502 
	`båfs_su≥r_magic
(
disk_su≥r
Ë!
BTRFS_MAGIC
) {

1503 
	`båfs_ªÀa£_disk_su≥r
(
p
);

1504  
	`ERR_PTR
(-
EINVAL
);

1507 i‡(
disk_su≥r
->
œbñ
[0] && disk_su≥r->œbñ[
BTRFS_LABEL_SIZE
 - 1])

1508 
disk_su≥r
->
œbñ
[
BTRFS_LABEL_SIZE
 - 1] = 0;

1510  
disk_su≥r
;

1511 
	}
}

1513 
	$båfs_f‹gë_devi˚s
(
dev_t
 
devt
)

1515 
ªt
;

1517 
	`muãx_lock
(&
uuid_muãx
);

1518 
ªt
 = 
	`båfs_‰ì_°Æe_devi˚s
(
devt
, 
NULL
);

1519 
	`muãx_u∆ock
(&
uuid_muãx
);

1521  
ªt
;

1522 
	}
}

1529 
båfs_devi˚
 *
	$båfs_sˇn_⁄e_devi˚
(c⁄° *
∑th
, 
blk_mode_t
 
Êags
)

1531 
båfs_su≥r_block
 *
disk_su≥r
;

1532 
boﬁ
 
√w_devi˚_added
 = 
Ál£
;

1533 
båfs_devi˚
 *
devi˚
 = 
NULL
;

1534 
block_devi˚
 *
bdev
;

1535 
u64
 
byãƒ
, 
byãƒ_‹ig
;

1536 
ªt
;

1538 
	`lockdï_as£π_hñd
(&
uuid_muãx
);

1557 
bdev
 = 
	`blkdev_gë_by_∑th
(
∑th
, 
Êags
, 
NULL
, NULL);

1558 i‡(
	`IS_ERR
(
bdev
))

1559  
	`ERR_CAST
(
bdev
);

1561 
byãƒ_‹ig
 = 
	`båfs_sb_off£t
(0);

1562 
ªt
 = 
	`båfs_sb_log_loˇti⁄_bdev
(
bdev
, 0, 
READ
, &
byãƒ
);

1563 i‡(
ªt
) {

1564 
devi˚
 = 
	`ERR_PTR
(
ªt
);

1565 
îr‹_bdev_put
;

1568 
disk_su≥r
 = 
	`båfs_ªad_disk_su≥r
(
bdev
, 
byãƒ
, 
byãƒ_‹ig
);

1569 i‡(
	`IS_ERR
(
disk_su≥r
)) {

1570 
devi˚
 = 
	`ERR_CAST
(
disk_su≥r
);

1571 
îr‹_bdev_put
;

1574 
devi˚
 = 
	`devi˚_li°_add
(
∑th
, 
disk_su≥r
, &
√w_devi˚_added
);

1575 i‡(!
	`IS_ERR
(
devi˚
Ë&& 
√w_devi˚_added
)

1576 
	`båfs_‰ì_°Æe_devi˚s
(
devi˚
->
devt
, device);

1578 
	`båfs_ªÀa£_disk_su≥r
(
disk_su≥r
);

1580 
îr‹_bdev_put
:

1581 
	`blkdev_put
(
bdev
, 
NULL
);

1583  
devi˚
;

1584 
	}
}

1587 
båfs_devi˚
 *
	$båfs_sˇn_⁄e_devi˚_∑πôi⁄
(c⁄° *
∑th
, 
blk_mode_t
 
Êags
, 
∑πôi⁄_‹dî
)

1589 
båfs_su≥r_block
 *
disk_su≥r
;

1590 
boﬁ
 
√w_devi˚_added
 = 
Ál£
;

1591 
båfs_devi˚
 *
devi˚
 = 
NULL
;

1592 
block_devi˚
 *
bdev
;

1593 
u64
 
byãƒ
, 
byãƒ_‹ig
;

1594 
ªt
;

1596 
	`lockdï_as£π_hñd
(&
uuid_muãx
);

1615 
bdev
 = 
	`blkdev_gë_by_∑th
(
∑th
, 
Êags
, 
NULL
, NULL);

1616 i‡(
	`IS_ERR
(
bdev
))

1617  
	`ERR_CAST
(
bdev
);

1618 
u64
 
sb_off£t
 = 
∑πôi⁄_‹dî
 * 
BTRFS_SUPER_INFO_SIZE
;

1619 
byãƒ_‹ig
 = 
	`båfs_sb_off£t_∑πôi⁄
(0, 
sb_off£t
);

1620 
ªt
 = 
	`båfs_sb_log_loˇti⁄_bdev_∑πôi⁄
(
bdev
, 0, 
READ
, &
byãƒ
, 
sb_off£t
);

1621 i‡(
ªt
) {

1622 
devi˚
 = 
	`ERR_PTR
(
ªt
);

1623 
îr‹_bdev_put
;

1633 
disk_su≥r
 = 
	`båfs_ªad_disk_su≥r
(
bdev
, 
byãƒ
, 
byãƒ_‹ig
);

1634 i‡(
	`IS_ERR
(
disk_su≥r
)) {

1635 
devi˚
 = 
	`ERR_CAST
(
disk_su≥r
);

1636 
îr‹_bdev_put
;

1647 
devi˚
 = 
	`devi˚_li°_add
(
∑th
, 
disk_su≥r
, &
√w_devi˚_added
);

1648 i‡(!
	`IS_ERR
(
devi˚
Ë&& 
√w_devi˚_added
)

1649 
	`båfs_‰ì_°Æe_devi˚s
(
devi˚
->
devt
, device);

1651 
	`båfs_ªÀa£_disk_su≥r
(
disk_su≥r
);

1653 
îr‹_bdev_put
:

1654 
	`blkdev_put
(
bdev
, 
NULL
);

1656  
devi˚
;

1657 
	}
}

1663 
boﬁ
 
	$c⁄èös_≥ndög_exã¡
(
båfs_devi˚
 *
devi˚
, 
u64
 *
°¨t
,

1664 
u64
 
Àn
)

1666 
u64
 
physiˇl_°¨t
, 
physiˇl_íd
;

1668 
	`lockdï_as£π_hñd
(&
devi˚
->
fs_öfo
->
chunk_muãx
);

1670 i‡(
	`föd_fú°_exã¡_bô
(&
devi˚
->
Æloc_°©e
, *
°¨t
,

1671 &
physiˇl_°¨t
, &
physiˇl_íd
,

1672 
CHUNK_ALLOCATED
, 
NULL
)) {

1674 i‡(
	`ö_ønge
(
physiˇl_°¨t
, *
°¨t
, 
Àn
) ||

1675 
	`ö_ønge
(*
°¨t
, 
physiˇl_°¨t
,

1676 
physiˇl_íd
 - 
physiˇl_°¨t
)) {

1677 *
°¨t
 = 
physiˇl_íd
 + 1;

1678  
åue
;

1681  
Ál£
;

1682 
	}
}

1684 
u64
 
	$dev_exã¡_£¨ch_°¨t
(
båfs_devi˚
 *
devi˚
)

1686 
devi˚
->
fs_devi˚s
->
chunk_Æloc_pﬁicy
) {

1687 
BTRFS_CHUNK_ALLOC_REGULAR
:

1688  
BTRFS_DEVICE_RANGE_RESERVED
;

1689 
BTRFS_CHUNK_ALLOC_ZONED
:

1697 
	`BUG
();

1699 
	}
}

1701 
boﬁ
 
	$dev_exã¡_hﬁe_check_z⁄ed
(
båfs_devi˚
 *
devi˚
,

1702 
u64
 *
hﬁe_°¨t
, u64 *
hﬁe_size
,

1703 
u64
 
num_byãs
)

1705 
u64
 
z⁄e_size
 = 
devi˚
->
z⁄e_öfo
->zone_size;

1706 
u64
 
pos
;

1707 
ªt
;

1708 
boﬁ
 
ch™ged
 = 
Ál£
;

1710 
	`ASSERT
(
	`IS_ALIGNED
(*
hﬁe_°¨t
, 
z⁄e_size
));

1712 *
hﬁe_size
 > 0) {

1713 
pos
 = 
	`båfs_föd_ÆloˇèbÀ_z⁄es
(
devi˚
, *
hﬁe_°¨t
,

1714 *
hﬁe_°¨t
 + *
hﬁe_size
,

1715 
num_byãs
);

1716 i‡(
pos
 !*
hﬁe_°¨t
) {

1717 *
hﬁe_size
 = *
hﬁe_°¨t
 + *hﬁe_sizê- 
pos
;

1718 *
hﬁe_°¨t
 = 
pos
;

1719 
ch™ged
 = 
åue
;

1720 i‡(*
hﬁe_size
 < 
num_byãs
)

1724 
ªt
 = 
	`båfs_ísuª_em±y_z⁄es
(
devi˚
, 
pos
, 
num_byãs
);

1727 i‡(!
ªt
)

1728  
ch™ged
;

1731 i‡(
ªt
 =-
ERANGE
) {

1732 *
hﬁe_°¨t
 +*
hﬁe_size
;

1733 *
hﬁe_size
 = 0;

1734  
åue
;

1737 *
hﬁe_°¨t
 +
z⁄e_size
;

1738 *
hﬁe_size
 -
z⁄e_size
;

1739 
ch™ged
 = 
åue
;

1742  
ch™ged
;

1743 
	}
}

1756 
boﬁ
 
	$dev_exã¡_hﬁe_check
(
båfs_devi˚
 *
devi˚
, 
u64
 *
hﬁe_°¨t
,

1757 
u64
 *
hﬁe_size
, u64 
num_byãs
)

1759 
boﬁ
 
ch™ged
 = 
Ál£
;

1760 
u64
 
hﬁe_íd
 = *
hﬁe_°¨t
 + *
hﬁe_size
;

1767 i‡(
	`c⁄èös_≥ndög_exã¡
(
devi˚
, 
hﬁe_°¨t
, *
hﬁe_size
)) {

1768 i‡(
hﬁe_íd
 >*
hﬁe_°¨t
)

1769 *
hﬁe_size
 = 
hﬁe_íd
 - *
hﬁe_°¨t
;

1771 *
hﬁe_size
 = 0;

1772 
ch™ged
 = 
åue
;

1775 
devi˚
->
fs_devi˚s
->
chunk_Æloc_pﬁicy
) {

1776 
BTRFS_CHUNK_ALLOC_REGULAR
:

1779 
BTRFS_CHUNK_ALLOC_ZONED
:

1780 i‡(
	`dev_exã¡_hﬁe_check_z⁄ed
(
devi˚
, 
hﬁe_°¨t
,

1781 
hﬁe_size
, 
num_byãs
)) {

1782 
ch™ged
 = 
åue
;

1791 
	`BUG
();

1797  
ch™ged
;

1798 
	}
}

1827 
	$föd_‰ì_dev_exã¡
(
båfs_devi˚
 *
devi˚
, 
u64
 
num_byãs
,

1828 
u64
 *
°¨t
, u64 *
Àn
)

1830 
båfs_fs_öfo
 *
fs_öfo
 = 
devi˚
->fs_info;

1831 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
dev_roŸ
;

1832 
båfs_key
 
key
;

1833 
båfs_dev_exã¡
 *
dev_exã¡
;

1834 
båfs_∑th
 *
∑th
;

1835 
u64
 
£¨ch_°¨t
;

1836 
u64
 
hﬁe_size
;

1837 
u64
 
max_hﬁe_°¨t
;

1838 
u64
 
max_hﬁe_size
 = 0;

1839 
u64
 
exã¡_íd
;

1840 
u64
 
£¨ch_íd
 = 
devi˚
->
tŸÆ_byãs
;

1841 
ªt
;

1842 
¶Ÿ
;

1843 
exã¡_buf„r
 *
l
;

1845 
£¨ch_°¨t
 = 
	`dev_exã¡_£¨ch_°¨t
(
devi˚
);

1846 
max_hﬁe_°¨t
 = 
£¨ch_°¨t
;

1848 
	`WARN_ON
(
devi˚
->
z⁄e_öfo
 &&

1849 !
	`IS_ALIGNED
(
num_byãs
, 
devi˚
->
z⁄e_öfo
->
z⁄e_size
));

1851 
∑th
 = 
	`båfs_Æloc_∑th
();

1852 i‡(!
∑th
) {

1853 
ªt
 = -
ENOMEM
;

1854 
out
;

1856 
agaö
:

1857 i‡(
£¨ch_°¨t
 >
£¨ch_íd
 ||

1858 
	`ã°_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
)) {

1859 
ªt
 = -
ENOSPC
;

1860 
out
;

1863 
∑th
->
ªada
 = 
READA_FORWARD
;

1864 
∑th
->
£¨ch_commô_roŸ
 = 1;

1865 
∑th
->
skù_lockög
 = 1;

1867 
key
.
obje˘id
 = 
devi˚
->
devid
;

1868 
key
.
off£t
 = 
£¨ch_°¨t
;

1869 
key
.
ty≥
 = 
BTRFS_DEV_EXTENT_KEY
;

1871 
ªt
 = 
	`båfs_£¨ch_backw¨ds
(
roŸ
, &
key
, 
∑th
);

1872 i‡(
ªt
 < 0)

1873 
out
;

1875 
£¨ch_°¨t
 < 
£¨ch_íd
) {

1876 
l
 = 
∑th
->
nodes
[0];

1877 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

1878 i‡(
¶Ÿ
 >
	`båfs_hódî_ƒôems
(
l
)) {

1879 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

1880 i‡(
ªt
 == 0)

1882 i‡(
ªt
 < 0)

1883 
out
;

1887 
	`båfs_ôem_key_to_˝u
(
l
, &
key
, 
¶Ÿ
);

1889 i‡(
key
.
obje˘id
 < 
devi˚
->
devid
)

1890 
√xt
;

1892 i‡(
key
.
obje˘id
 > 
devi˚
->
devid
)

1895 i‡(
key
.
ty≥
 !
BTRFS_DEV_EXTENT_KEY
)

1896 
√xt
;

1898 i‡(
key
.
off£t
 > 
£¨ch_íd
)

1901 i‡(
key
.
off£t
 > 
£¨ch_°¨t
) {

1902 
hﬁe_size
 = 
key
.
off£t
 - 
£¨ch_°¨t
;

1903 
	`dev_exã¡_hﬁe_check
(
devi˚
, &
£¨ch_°¨t
, &
hﬁe_size
,

1904 
num_byãs
);

1906 i‡(
hﬁe_size
 > 
max_hﬁe_size
) {

1907 
max_hﬁe_°¨t
 = 
£¨ch_°¨t
;

1908 
max_hﬁe_size
 = 
hﬁe_size
;

1920 i‡(
hﬁe_size
 >
num_byãs
) {

1921 
ªt
 = 0;

1922 
out
;

1926 
dev_exã¡
 = 
	`båfs_ôem_±r
(
l
, 
¶Ÿ
, 
båfs_dev_exã¡
);

1927 
exã¡_íd
 = 
key
.
off£t
 + 
	`båfs_dev_exã¡_Àngth
(
l
,

1928 
dev_exã¡
);

1929 i‡(
exã¡_íd
 > 
£¨ch_°¨t
)

1930 
£¨ch_°¨t
 = 
exã¡_íd
;

1931 
√xt
:

1932 
∑th
->
¶Ÿs
[0]++;

1933 
	`c⁄d_ªsched
();

1941 i‡(
£¨ch_íd
 > 
£¨ch_°¨t
) {

1942 
hﬁe_size
 = 
£¨ch_íd
 - 
£¨ch_°¨t
;

1943 i‡(
	`dev_exã¡_hﬁe_check
(
devi˚
, &
£¨ch_°¨t
, &
hﬁe_size
,

1944 
num_byãs
)) {

1945 
	`båfs_ªÀa£_∑th
(
∑th
);

1946 
agaö
;

1949 i‡(
hﬁe_size
 > 
max_hﬁe_size
) {

1950 
max_hﬁe_°¨t
 = 
£¨ch_°¨t
;

1951 
max_hﬁe_size
 = 
hﬁe_size
;

1956 i‡(
max_hﬁe_size
 < 
num_byãs
)

1957 
ªt
 = -
ENOSPC
;

1959 
ªt
 = 0;

1961 
	`ASSERT
(
max_hﬁe_°¨t
 + 
max_hﬁe_size
 <
£¨ch_íd
);

1962 
out
:

1963 
	`båfs_‰ì_∑th
(
∑th
);

1964 *
°¨t
 = 
max_hﬁe_°¨t
;

1965 i‡(
Àn
)

1966 *
Àn
 = 
max_hﬁe_size
;

1967  
ªt
;

1968 
	}
}

1970 
	$båfs_‰ì_dev_exã¡
(
båfs_å™s_h™dÀ
 *
å™s
,

1971 
båfs_devi˚
 *
devi˚
,

1972 
u64
 
°¨t
, u64 *
dev_exã¡_Àn
)

1974 
båfs_fs_öfo
 *
fs_öfo
 = 
devi˚
->fs_info;

1975 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
dev_roŸ
;

1976 
ªt
;

1977 
båfs_∑th
 *
∑th
;

1978 
båfs_key
 
key
;

1979 
båfs_key
 
found_key
;

1980 
exã¡_buf„r
 *
Àaf
 = 
NULL
;

1981 
båfs_dev_exã¡
 *
exã¡
 = 
NULL
;

1983 
∑th
 = 
	`båfs_Æloc_∑th
();

1984 i‡(!
∑th
)

1985  -
ENOMEM
;

1987 
key
.
obje˘id
 = 
devi˚
->
devid
;

1988 
key
.
off£t
 = 
°¨t
;

1989 
key
.
ty≥
 = 
BTRFS_DEV_EXTENT_KEY
;

1990 
agaö
:

1991 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

1992 i‡(
ªt
 > 0) {

1993 
ªt
 = 
	`båfs_¥evious_ôem
(
roŸ
, 
∑th
, 
key
.
obje˘id
,

1994 
BTRFS_DEV_EXTENT_KEY
);

1995 i‡(
ªt
)

1996 
out
;

1997 
Àaf
 = 
∑th
->
nodes
[0];

1998 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0]);

1999 
exã¡
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

2000 
båfs_dev_exã¡
);

2001 
	`BUG_ON
(
found_key
.
off£t
 > 
°¨t
 || found_key.offset +

2002 
	`båfs_dev_exã¡_Àngth
(
Àaf
, 
exã¡
Ë< 
°¨t
);

2003 
key
 = 
found_key
;

2004 
	`båfs_ªÀa£_∑th
(
∑th
);

2005 
agaö
;

2006 } i‡(
ªt
 == 0) {

2007 
Àaf
 = 
∑th
->
nodes
[0];

2008 
exã¡
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

2009 
båfs_dev_exã¡
);

2011 
out
;

2014 *
dev_exã¡_Àn
 = 
	`båfs_dev_exã¡_Àngth
(
Àaf
, 
exã¡
);

2016 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

2017 i‡(
ªt
 == 0)

2018 
	`£t_bô
(
BTRFS_TRANS_HAVE_FREE_BGS
, &
å™s
->
å™ß˘i⁄
->
Êags
);

2019 
out
:

2020 
	`båfs_‰ì_∑th
(
∑th
);

2021  
ªt
;

2022 
	}
}

2024 
u64
 
	$föd_√xt_chunk
(
båfs_fs_öfo
 *
fs_öfo
)

2026 
exã¡_m≠_åì
 *
em_åì
;

2027 
exã¡_m≠
 *
em
;

2028 
rb_node
 *
n
;

2029 
u64
 
ªt
 = 0;

2031 
em_åì
 = &
fs_öfo
->
m≠pög_åì
;

2032 
	`ªad_lock
(&
em_åì
->
lock
);

2033 
n
 = 
	`rb_œ°
(&
em_åì
->
m≠
.
rb_roŸ
);

2034 i‡(
n
) {

2035 
em
 = 
	`rb_íåy
(
n
, 
exã¡_m≠
, 
rb_node
);

2036 
ªt
 = 
em
->
°¨t
 +Ém->
Àn
;

2038 
	`ªad_u∆ock
(&
em_åì
->
lock
);

2040  
ªt
;

2041 
	}
}

2043 
noölöe
 
	$föd_√xt_devid
(
båfs_fs_öfo
 *
fs_öfo
,

2044 
u64
 *
devid_ªt
)

2046 
ªt
;

2047 
båfs_key
 
key
;

2048 
båfs_key
 
found_key
;

2049 
båfs_∑th
 *
∑th
;

2051 
∑th
 = 
	`båfs_Æloc_∑th
();

2052 i‡(!
∑th
)

2053  -
ENOMEM
;

2055 
key
.
obje˘id
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

2056 
key
.
ty≥
 = 
BTRFS_DEV_ITEM_KEY
;

2057 
key
.
off£t
 = (
u64
)-1;

2059 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
fs_öfo
->
chunk_roŸ
, &
key
, 
∑th
, 0, 0);

2060 i‡(
ªt
 < 0)

2061 
îr‹
;

2063 i‡(
ªt
 == 0) {

2065 
	`båfs_îr
(
fs_öfo
, "corrupted chunkÅree devid -1 matched");

2066 
ªt
 = -
EUCLEAN
;

2067 
îr‹
;

2070 
ªt
 = 
	`båfs_¥evious_ôem
(
fs_öfo
->
chunk_roŸ
, 
∑th
,

2071 
BTRFS_DEV_ITEMS_OBJECTID
,

2072 
BTRFS_DEV_ITEM_KEY
);

2073 i‡(
ªt
) {

2074 *
devid_ªt
 = 1;

2076 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
found_key
,

2077 
∑th
->
¶Ÿs
[0]);

2078 *
devid_ªt
 = 
found_key
.
off£t
 + 1;

2080 
ªt
 = 0;

2081 
îr‹
:

2082 
	`båfs_‰ì_∑th
(
∑th
);

2083  
ªt
;

2084 
	}
}

2090 
	$båfs_add_dev_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

2091 
båfs_devi˚
 *
devi˚
)

2093 
ªt
;

2094 
båfs_∑th
 *
∑th
;

2095 
båfs_dev_ôem
 *
dev_ôem
;

2096 
exã¡_buf„r
 *
Àaf
;

2097 
båfs_key
 
key
;

2098 
±r
;

2100 
∑th
 = 
	`båfs_Æloc_∑th
();

2101 i‡(!
∑th
)

2102  -
ENOMEM
;

2104 
key
.
obje˘id
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

2105 
key
.
ty≥
 = 
BTRFS_DEV_ITEM_KEY
;

2106 
key
.
off£t
 = 
devi˚
->
devid
;

2108 
	`båfs_ª£rve_chunk_mëad©a
(
å™s
, 
åue
);

2109 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
,Åøns->
fs_öfo
->
chunk_roŸ
, 
∑th
,

2110 &
key
, (*
dev_ôem
));

2111 
	`båfs_å™s_ªÀa£_chunk_mëad©a
(
å™s
);

2112 i‡(
ªt
)

2113 
out
;

2115 
Àaf
 = 
∑th
->
nodes
[0];

2116 
dev_ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_dev_ôem
);

2118 
	`båfs_£t_devi˚_id
(
Àaf
, 
dev_ôem
, 
devi˚
->
devid
);

2119 
	`båfs_£t_devi˚_gíî©i⁄
(
Àaf
, 
dev_ôem
, 0);

2120 
	`båfs_£t_devi˚_ty≥
(
Àaf
, 
dev_ôem
, 
devi˚
->
ty≥
);

2121 
	`båfs_£t_devi˚_io_Æign
(
Àaf
, 
dev_ôem
, 
devi˚
->
io_Æign
);

2122 
	`båfs_£t_devi˚_io_width
(
Àaf
, 
dev_ôem
, 
devi˚
->
io_width
);

2123 
	`båfs_£t_devi˚_£˘‹_size
(
Àaf
, 
dev_ôem
, 
devi˚
->
£˘‹_size
);

2124 
	`båfs_£t_devi˚_tŸÆ_byãs
(
Àaf
, 
dev_ôem
,

2125 
	`båfs_devi˚_gë_disk_tŸÆ_byãs
(
devi˚
));

2126 
	`båfs_£t_devi˚_byãs_u£d
(
Àaf
, 
dev_ôem
,

2127 
	`båfs_devi˚_gë_byãs_u£d
(
devi˚
));

2128 
	`båfs_£t_devi˚_group
(
Àaf
, 
dev_ôem
, 0);

2129 
	`båfs_£t_devi˚_£ek_•ìd
(
Àaf
, 
dev_ôem
, 0);

2130 
	`båfs_£t_devi˚_b™dwidth
(
Àaf
, 
dev_ôem
, 0);

2131 
	`båfs_£t_devi˚_°¨t_off£t
(
Àaf
, 
dev_ôem
, 0);

2133 
±r
 = 
	`båfs_devi˚_uuid
(
dev_ôem
);

2134 
	`wrôe_exã¡_buf„r
(
Àaf
, 
devi˚
->
uuid
, 
±r
, 
BTRFS_UUID_SIZE
);

2135 
±r
 = 
	`båfs_devi˚_fsid
(
dev_ôem
);

2136 
	`wrôe_exã¡_buf„r
(
Àaf
, 
å™s
->
fs_öfo
->
fs_devi˚s
->
mëad©a_uuid
,

2137 
±r
, 
BTRFS_FSID_SIZE
);

2138 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

2140 
ªt
 = 0;

2141 
out
:

2142 
	`båfs_‰ì_∑th
(
∑th
);

2143  
ªt
;

2144 
	}
}

2152 
	$upd©e_dev_time
(c⁄° *
devi˚_∑th
)

2154 
∑th
Öath;

2155 
ªt
;

2157 
ªt
 = 
	`kîn_∑th
(
devi˚_∑th
, 
LOOKUP_FOLLOW
, &
∑th
);

2158 i‡(
ªt
)

2161 
	`öode_upd©e_time
(
	`d_öode
(
∑th
.
díåy
), 
S_MTIME
 | 
S_CTIME
 | 
S_VERSION
);

2162 
	`∑th_put
(&
∑th
);

2163 
	}
}

2165 
	$båfs_rm_dev_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

2166 
båfs_devi˚
 *
devi˚
)

2168 
båfs_roŸ
 *
roŸ
 = 
devi˚
->
fs_öfo
->
chunk_roŸ
;

2169 
ªt
;

2170 
båfs_∑th
 *
∑th
;

2171 
båfs_key
 
key
;

2173 
∑th
 = 
	`båfs_Æloc_∑th
();

2174 i‡(!
∑th
)

2175  -
ENOMEM
;

2177 
key
.
obje˘id
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

2178 
key
.
ty≥
 = 
BTRFS_DEV_ITEM_KEY
;

2179 
key
.
off£t
 = 
devi˚
->
devid
;

2181 
	`båfs_ª£rve_chunk_mëad©a
(
å™s
, 
Ál£
);

2182 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

2183 
	`båfs_å™s_ªÀa£_chunk_mëad©a
(
å™s
);

2184 i‡(
ªt
) {

2185 i‡(
ªt
 > 0)

2186 
ªt
 = -
ENOENT
;

2187 
out
;

2190 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

2191 
out
:

2192 
	`båfs_‰ì_∑th
(
∑th
);

2193  
ªt
;

2194 
	}
}

2201 
	$båfs_check_øid_mö_devi˚s
(
båfs_fs_öfo
 *
fs_öfo
,

2202 
u64
 
num_devi˚s
)

2204 
u64
 
Æl_avaû
;

2205 
£q
;

2206 
i
;

2209 
£q
 = 
	`ªad_£qbegö
(&
fs_öfo
->
¥ofûes_lock
);

2211 
Æl_avaû
 = 
fs_öfo
->
avaû_d©a_Æloc_bôs
 |

2212 
fs_öfo
->
avaû_sy°em_Æloc_bôs
 |

2213 
fs_öfo
->
avaû_mëad©a_Æloc_bôs
;

2214 } 
	`ªad_£qªåy
(&
fs_öfo
->
¥ofûes_lock
, 
£q
));

2216 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; i++) {

2217 i‡(!(
Æl_avaû
 & 
båfs_øid_¨øy
[
i
].
bg_Êag
))

2220 i‡(
num_devi˚s
 < 
båfs_øid_¨øy
[
i
].
devs_mö
)

2221  
båfs_øid_¨øy
[
i
].
mödev_îr‹
;

2225 
	}
}

2227 
båfs_devi˚
 * 
	$båfs_föd_√xt_a˘ive_devi˚
(

2228 
båfs_fs_devi˚s
 *
fs_devs
, 
båfs_devi˚
 *
devi˚
)

2230 
båfs_devi˚
 *
√xt_devi˚
;

2232 
	`li°_f‹_óch_íåy
(
√xt_devi˚
, &
fs_devs
->
devi˚s
, 
dev_li°
) {

2233 i‡(
√xt_devi˚
 !
devi˚
 &&

2234 !
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
, &
√xt_devi˚
->
dev_°©e
)

2235 && 
√xt_devi˚
->
bdev
)

2236  
√xt_devi˚
;

2239  
NULL
;

2240 
	}
}

2248 
__cﬁd
 
	$båfs_assign_√xt_a˘ive_devi˚
(
båfs_devi˚
 *
devi˚
,

2249 
båfs_devi˚
 *
√xt_devi˚
)

2251 
båfs_fs_öfo
 *
fs_öfo
 = 
devi˚
->fs_info;

2253 i‡(!
√xt_devi˚
)

2254 
√xt_devi˚
 = 
	`båfs_föd_√xt_a˘ive_devi˚
(
fs_öfo
->
fs_devi˚s
,

2255 
devi˚
);

2256 
	`ASSERT
(
√xt_devi˚
);

2258 i‡(
fs_öfo
->
sb
->
s_bdev
 &&

2259 (
fs_öfo
->
sb
->
s_bdev
 =
devi˚
->
bdev
))

2260 
fs_öfo
->
sb
->
s_bdev
 = 
√xt_devi˚
->
bdev
;

2262 i‡(
fs_öfo
->
fs_devi˚s
->
œã°_dev
->
bdev
 =
devi˚
->bdev)

2263 
fs_öfo
->
fs_devi˚s
->
œã°_dev
 = 
√xt_devi˚
;

2264 
	}
}

2270 
u64
 
	$båfs_num_devi˚s
(
båfs_fs_öfo
 *
fs_öfo
)

2272 
u64
 
num_devi˚s
 = 
fs_öfo
->
fs_devi˚s
->num_devices;

2274 
	`down_ªad
(&
fs_öfo
->
dev_ª∂a˚
.
rw£m
);

2275 i‡(
	`båfs_dev_ª∂a˚_is_⁄goög
(&
fs_öfo
->
dev_ª∂a˚
)) {

2276 
	`ASSERT
(
num_devi˚s
 > 1);

2277 
num_devi˚s
--;

2279 
	`up_ªad
(&
fs_öfo
->
dev_ª∂a˚
.
rw£m
);

2281  
num_devi˚s
;

2282 
	}
}

2284 
	$båfs_s¸©ch_su≥rblock
(
båfs_fs_öfo
 *
fs_öfo
,

2285 
block_devi˚
 *
bdev
, 
c›y_num
)

2287 
båfs_su≥r_block
 *
disk_su≥r
;

2288 c⁄° 
size_t
 
Àn
 = (
disk_su≥r
->
magic
);

2289 c⁄° 
u64
 
byãƒ
 = 
	`båfs_sb_off£t
(
c›y_num
);

2290 
ªt
;

2292 
disk_su≥r
 = 
	`båfs_ªad_disk_su≥r
(
bdev
, 
byãƒ
, bytenr);

2293 i‡(
	`IS_ERR
(
disk_su≥r
))

2296 
	`mem£t
(&
disk_su≥r
->
magic
, 0, 
Àn
);

2297 
	`fﬁio_m¨k_dúty
(
	`vút_to_fﬁio
(
disk_su≥r
));

2298 
	`båfs_ªÀa£_disk_su≥r
(
disk_su≥r
);

2300 
ªt
 = 
	`sync_blockdev_ønge
(
bdev
, 
byãƒ
, byãƒ + 
Àn
 - 1);

2301 i‡(
ªt
)

2302 
	`båfs_w¨n
(
fs_öfo
, "error clearing superblockÇumber %d (%d)",

2303 
c›y_num
, 
ªt
);

2304 
	}
}

2306 
	$båfs_s¸©ch_su≥rblocks
(
båfs_fs_öfo
 *
fs_öfo
,

2307 
block_devi˚
 *
bdev
,

2308 c⁄° *
devi˚_∑th
)

2310 
c›y_num
;

2312 i‡(!
bdev
)

2315 
c›y_num
 = 0; c›y_num < 
BTRFS_SUPER_MIRROR_MAX
; copy_num++) {

2316 i‡(
	`bdev_is_z⁄ed
(
bdev
))

2317 
	`båfs_ª£t_sb_log_z⁄es
(
bdev
, 
c›y_num
);

2319 
	`båfs_s¸©ch_su≥rblock
(
fs_öfo
, 
bdev
, 
c›y_num
);

2323 
	`båfs_kobje˘_uevít
(
bdev
, 
KOBJ_CHANGE
);

2326 
	`upd©e_dev_time
(
devi˚_∑th
);

2327 
	}
}

2329 
	$båfs_rm_devi˚
(
båfs_fs_öfo
 *
fs_öfo
,

2330 
båfs_dev_lookup_¨gs
 *
¨gs
,

2331 
block_devi˚
 **
bdev
, **
hﬁdî
)

2333 
båfs_å™s_h™dÀ
 *
å™s
;

2334 
båfs_devi˚
 *
devi˚
;

2335 
båfs_fs_devi˚s
 *
cur_devi˚s
;

2336 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

2337 
u64
 
num_devi˚s
;

2338 
ªt
 = 0;

2340 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
EXTENT_TREE_V2
)) {

2341 
	`båfs_îr
(
fs_öfo
, "deviceÑemoveÇot supported onÉxtentÅree v2 yet");

2342  -
EINVAL
;

2350 
num_devi˚s
 = 
	`båfs_num_devi˚s
(
fs_öfo
);

2352 
ªt
 = 
	`båfs_check_øid_mö_devi˚s
(
fs_öfo
, 
num_devi˚s
 - 1);

2353 i‡(
ªt
)

2354  
ªt
;

2356 
devi˚
 = 
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, 
¨gs
);

2357 i‡(!
devi˚
) {

2358 i‡(
¨gs
->
missög
)

2359 
ªt
 = 
BTRFS_ERROR_DEV_MISSING_NOT_FOUND
;

2361 
ªt
 = -
ENOENT
;

2362  
ªt
;

2365 i‡(
	`båfs_pö√d_by_sw≠fûe
(
fs_öfo
, 
devi˚
)) {

2366 
	`båfs_w¨n_ö_rcu
(
fs_öfo
,

2368 
	`båfs_dev_«me
(
devi˚
), devi˚->
devid
);

2369  -
ETXTBSY
;

2372 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
))

2373  
BTRFS_ERROR_DEV_TGT_REPLACE
;

2375 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
) &&

2376 
fs_öfo
->
fs_devi˚s
->
rw_devi˚s
 == 1)

2377  
BTRFS_ERROR_DEV_ONLY_WRITABLE
;

2379 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
)) {

2380 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

2381 
	`li°_dñ_öô
(&
devi˚
->
dev_Æloc_li°
);

2382 
devi˚
->
fs_devi˚s
->
rw_devi˚s
--;

2383 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

2386 
ªt
 = 
	`båfs_shrök_devi˚
(
devi˚
, 0);

2387 i‡(
ªt
)

2388 
îr‹_undo
;

2390 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
fs_öfo
->
chunk_roŸ
, 0);

2391 i‡(
	`IS_ERR
(
å™s
)) {

2392 
ªt
 = 
	`PTR_ERR
(
å™s
);

2393 
îr‹_undo
;

2396 
ªt
 = 
	`båfs_rm_dev_ôem
(
å™s
, 
devi˚
);

2397 i‡(
ªt
) {

2399 
	`båfs_¸ô
(
fs_öfo
,

2401 
devi˚
->
devid
, 
ªt
);

2402 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2403 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

2404  
ªt
;

2407 
	`˛ór_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
devi˚
->
dev_°©e
);

2408 
	`båfs_s¸ub_ˇn˚l_dev
(
devi˚
);

2425 
cur_devi˚s
 = 
devi˚
->
fs_devi˚s
;

2426 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

2427 
	`li°_dñ_rcu
(&
devi˚
->
dev_li°
);

2429 
cur_devi˚s
->
num_devi˚s
--;

2430 
cur_devi˚s
->
tŸÆ_devi˚s
--;

2432 i‡(
cur_devi˚s
 !
fs_devi˚s
)

2433 
fs_devi˚s
->
tŸÆ_devi˚s
--;

2435 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
, &
devi˚
->
dev_°©e
))

2436 
cur_devi˚s
->
missög_devi˚s
--;

2438 
	`båfs_assign_√xt_a˘ive_devi˚
(
devi˚
, 
NULL
);

2440 i‡(
devi˚
->
bdev
) {

2441 
cur_devi˚s
->
›í_devi˚s
--;

2443 
	`båfs_sysfs_ªmove_devi˚
(
devi˚
);

2446 
num_devi˚s
 = 
	`båfs_su≥r_num_devi˚s
(
fs_öfo
->
su≥r_c›y
) - 1;

2447 
	`båfs_£t_su≥r_num_devi˚s
(
fs_öfo
->
su≥r_c›y
, 
num_devi˚s
);

2448 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

2460 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
)) {

2461 
	`båfs_s¸©ch_su≥rblocks
(
fs_öfo
, 
devi˚
->
bdev
,

2462 
devi˚
->
«me
->
°r
);

2463 i‡(
devi˚
->
bdev
) {

2464 
	`sync_blockdev
(
devi˚
->
bdev
);

2465 
	`övÆid©e_bdev
(
devi˚
->
bdev
);

2469 *
bdev
 = 
devi˚
->bdev;

2470 *
hﬁdî
 = 
devi˚
->holder;

2471 
	`synchr⁄ize_rcu
();

2472 
	`båfs_‰ì_devi˚
(
devi˚
);

2481 i‡(
cur_devi˚s
->
num_devi˚s
 == 0) {

2482 
	`li°_dñ_öô
(&
cur_devi˚s
->
£ed_li°
);

2483 
	`ASSERT
(
cur_devi˚s
->
›íed
 == 1);

2484 
cur_devi˚s
->
›íed
--;

2485 
	`‰ì_fs_devi˚s
(
cur_devi˚s
);

2488 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

2490  
ªt
;

2492 
îr‹_undo
:

2493 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
)) {

2494 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

2495 
	`li°_add
(&
devi˚
->
dev_Æloc_li°
,

2496 &
fs_devi˚s
->
Æloc_li°
);

2497 
devi˚
->
fs_devi˚s
->
rw_devi˚s
++;

2498 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

2500  
ªt
;

2501 
	}
}

2503 
	$båfs_rm_dev_ª∂a˚_ªmove_§cdev
(
båfs_devi˚
 *
§cdev
)

2505 
båfs_fs_devi˚s
 *
fs_devi˚s
;

2507 
	`lockdï_as£π_hñd
(&
§cdev
->
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

2515 
fs_devi˚s
 = 
§cdev
->fs_devices;

2517 
	`li°_dñ_rcu
(&
§cdev
->
dev_li°
);

2518 
	`li°_dñ
(&
§cdev
->
dev_Æloc_li°
);

2519 
fs_devi˚s
->
num_devi˚s
--;

2520 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
, &
§cdev
->
dev_°©e
))

2521 
fs_devi˚s
->
missög_devi˚s
--;

2523 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
§cdev
->
dev_°©e
))

2524 
fs_devi˚s
->
rw_devi˚s
--;

2526 i‡(
§cdev
->
bdev
)

2527 
fs_devi˚s
->
›í_devi˚s
--;

2528 
	}
}

2530 
	$båfs_rm_dev_ª∂a˚_‰ì_§cdev
(
båfs_devi˚
 *
§cdev
)

2532 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
§cdev
->fs_devices;

2534 
	`muãx_lock
(&
uuid_muãx
);

2536 
	`båfs_˛o£_bdev
(
§cdev
);

2537 
	`synchr⁄ize_rcu
();

2538 
	`båfs_‰ì_devi˚
(
§cdev
);

2541 i‡(!
fs_devi˚s
->
num_devi˚s
) {

2548 
	`ASSERT
(
fs_devi˚s
->
£edög
);

2550 
	`li°_dñ_öô
(&
fs_devi˚s
->
£ed_li°
);

2551 
	`˛o£_fs_devi˚s
(
fs_devi˚s
);

2552 
	`‰ì_fs_devi˚s
(
fs_devi˚s
);

2554 
	`muãx_u∆ock
(&
uuid_muãx
);

2555 
	}
}

2557 
	$båfs_de°roy_dev_ª∂a˚_tgtdev
(
båfs_devi˚
 *
tgtdev
)

2559 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
tgtdev
->
fs_öfo
->fs_devices;

2561 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

2563 
	`båfs_sysfs_ªmove_devi˚
(
tgtdev
);

2565 i‡(
tgtdev
->
bdev
)

2566 
fs_devi˚s
->
›í_devi˚s
--;

2568 
fs_devi˚s
->
num_devi˚s
--;

2570 
	`båfs_assign_√xt_a˘ive_devi˚
(
tgtdev
, 
NULL
);

2572 
	`li°_dñ_rcu
(&
tgtdev
->
dev_li°
);

2574 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

2576 
	`båfs_s¸©ch_su≥rblocks
(
tgtdev
->
fs_öfo
,Ågtdev->
bdev
,

2577 
tgtdev
->
«me
->
°r
);

2579 
	`båfs_˛o£_bdev
(
tgtdev
);

2580 
	`synchr⁄ize_rcu
();

2581 
	`båfs_‰ì_devi˚
(
tgtdev
);

2582 
	}
}

2602 
	$båfs_gë_dev_¨gs_‰om_∑th
(
båfs_fs_öfo
 *
fs_öfo
,

2603 
båfs_dev_lookup_¨gs
 *
¨gs
,

2604 c⁄° *
∑th
)

2606 
båfs_su≥r_block
 *
disk_su≥r
;

2607 
block_devi˚
 *
bdev
;

2608 
ªt
;

2610 i‡(!
∑th
 || !path[0])

2611  -
EINVAL
;

2612 i‡(!
	`°rcmp
(
∑th
, "missing")) {

2613 
¨gs
->
missög
 = 
åue
;

2617 
¨gs
->
uuid
 = 
	`kzÆloc
(
BTRFS_UUID_SIZE
, 
GFP_KERNEL
);

2618 
¨gs
->
fsid
 = 
	`kzÆloc
(
BTRFS_FSID_SIZE
, 
GFP_KERNEL
);

2619 i‡(!
¨gs
->
uuid
 || !¨gs->
fsid
) {

2620 
	`båfs_put_dev_¨gs_‰om_∑th
(
¨gs
);

2621  -
ENOMEM
;

2624 
ªt
 = 
	`båfs_gë_bdev_™d_sb
(
∑th
, 
BLK_OPEN_READ
, 
NULL
, 0,

2625 &
bdev
, &
disk_su≥r
);

2626 i‡(
ªt
) {

2627 
	`båfs_put_dev_¨gs_‰om_∑th
(
¨gs
);

2628  
ªt
;

2631 
¨gs
->
devid
 = 
	`båfs_°ack_devi˚_id
(&
disk_su≥r
->
dev_ôem
);

2632 
	`mem˝y
(
¨gs
->
uuid
, 
disk_su≥r
->
dev_ôem
.uuid, 
BTRFS_UUID_SIZE
);

2633 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
METADATA_UUID
))

2634 
	`mem˝y
(
¨gs
->
fsid
, 
disk_su≥r
->
mëad©a_uuid
, 
BTRFS_FSID_SIZE
);

2636 
	`mem˝y
(
¨gs
->
fsid
, 
disk_su≥r
->fsid, 
BTRFS_FSID_SIZE
);

2637 
	`båfs_ªÀa£_disk_su≥r
(
disk_su≥r
);

2638 
	`blkdev_put
(
bdev
, 
NULL
);

2640 
	}
}

2647 
	$båfs_put_dev_¨gs_‰om_∑th
(
båfs_dev_lookup_¨gs
 *
¨gs
)

2649 
	`k‰ì
(
¨gs
->
uuid
);

2650 
	`k‰ì
(
¨gs
->
fsid
);

2651 
¨gs
->
uuid
 = 
NULL
;

2652 
¨gs
->
fsid
 = 
NULL
;

2653 
	}
}

2655 
båfs_devi˚
 *
	$båfs_föd_devi˚_by_dev•ec
(

2656 
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
devid
,

2657 c⁄° *
devi˚_∑th
)

2659 
	`BTRFS_DEV_LOOKUP_ARGS
(
¨gs
);

2660 
båfs_devi˚
 *
devi˚
;

2661 
ªt
;

2663 i‡(
devid
) {

2664 
¨gs
.
devid
 = devid;

2665 
devi˚
 = 
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, &
¨gs
);

2666 i‡(!
devi˚
)

2667  
	`ERR_PTR
(-
ENOENT
);

2668  
devi˚
;

2671 
ªt
 = 
	`båfs_gë_dev_¨gs_‰om_∑th
(
fs_öfo
, &
¨gs
, 
devi˚_∑th
);

2672 i‡(
ªt
)

2673  
	`ERR_PTR
(
ªt
);

2674 
devi˚
 = 
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, &
¨gs
);

2675 
	`båfs_put_dev_¨gs_‰om_∑th
(&
¨gs
);

2676 i‡(!
devi˚
)

2677  
	`ERR_PTR
(-
ENOENT
);

2678  
devi˚
;

2679 
	}
}

2681 
båfs_fs_devi˚s
 *
	$båfs_öô_•rout
(
båfs_fs_öfo
 *
fs_öfo
)

2683 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

2684 
båfs_fs_devi˚s
 *
ﬁd_devi˚s
;

2685 
båfs_fs_devi˚s
 *
£ed_devi˚s
;

2687 
	`lockdï_as£π_hñd
(&
uuid_muãx
);

2688 i‡(!
fs_devi˚s
->
£edög
)

2689  
	`ERR_PTR
(-
EINVAL
);

2695 
£ed_devi˚s
 = 
	`Æloc_fs_devi˚s
(
NULL
, NULL);

2696 i‡(
	`IS_ERR
(
£ed_devi˚s
))

2697  
£ed_devi˚s
;

2705 
ﬁd_devi˚s
 = 
	`˛⁄e_fs_devi˚s
(
fs_devi˚s
);

2706 i‡(
	`IS_ERR
(
ﬁd_devi˚s
)) {

2707 
	`k‰ì
(
£ed_devi˚s
);

2708  
ﬁd_devi˚s
;

2711 
	`li°_add
(&
ﬁd_devi˚s
->
fs_li°
, &
fs_uuids
);

2713 
	`mem˝y
(
£ed_devi˚s
, 
fs_devi˚s
, (*seed_devices));

2714 
£ed_devi˚s
->
›íed
 = 1;

2715 
	`INIT_LIST_HEAD
(&
£ed_devi˚s
->
devi˚s
);

2716 
	`INIT_LIST_HEAD
(&
£ed_devi˚s
->
Æloc_li°
);

2717 
	`muãx_öô
(&
£ed_devi˚s
->
devi˚_li°_muãx
);

2719  
£ed_devi˚s
;

2720 
	}
}

2726 
	$båfs_£tup_•rout
(
båfs_fs_öfo
 *
fs_öfo
,

2727 
båfs_fs_devi˚s
 *
£ed_devi˚s
)

2729 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

2730 
båfs_su≥r_block
 *
disk_su≥r
 = 
fs_öfo
->
su≥r_c›y
;

2731 
båfs_devi˚
 *
devi˚
;

2732 
u64
 
su≥r_Êags
;

2738 
	`lockdï_as£π_hñd
(&
uuid_muãx
);

2752 
	`lockdï_as£π_hñd
(&
fs_devi˚s
->
devi˚_li°_muãx
);

2754 
	`li°_•li˚_öô_rcu
(&
fs_devi˚s
->
devi˚s
, &
£ed_devi˚s
->devices,

2755 
synchr⁄ize_rcu
);

2756 
	`li°_f‹_óch_íåy
(
devi˚
, &
£ed_devi˚s
->
devi˚s
, 
dev_li°
)

2757 
devi˚
->
fs_devi˚s
 = 
£ed_devi˚s
;

2759 
fs_devi˚s
->
£edög
 = 
Ál£
;

2760 
fs_devi˚s
->
num_devi˚s
 = 0;

2761 
fs_devi˚s
->
›í_devi˚s
 = 0;

2762 
fs_devi˚s
->
missög_devi˚s
 = 0;

2763 
fs_devi˚s
->
rŸ©ög
 = 
Ál£
;

2764 
	`li°_add
(&
£ed_devi˚s
->
£ed_li°
, &
fs_devi˚s
->seed_list);

2766 
	`gíî©e_øndom_uuid
(
fs_devi˚s
->
fsid
);

2767 
	`mem˝y
(
fs_devi˚s
->
mëad©a_uuid
, fs_devi˚s->
fsid
, 
BTRFS_FSID_SIZE
);

2768 
	`mem˝y
(
disk_su≥r
->
fsid
, 
fs_devi˚s
->fsid, 
BTRFS_FSID_SIZE
);

2770 
su≥r_Êags
 = 
	`båfs_su≥r_Êags
(
disk_su≥r
) &

2771 ~
BTRFS_SUPER_FLAG_SEEDING
;

2772 
	`båfs_£t_su≥r_Êags
(
disk_su≥r
, 
su≥r_Êags
);

2773 
	}
}

2778 
	$båfs_föish_•rout
(
båfs_å™s_h™dÀ
 *
å™s
)

2780 
	`BTRFS_DEV_LOOKUP_ARGS
(
¨gs
);

2781 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

2782 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
chunk_roŸ
;

2783 
båfs_∑th
 *
∑th
;

2784 
exã¡_buf„r
 *
Àaf
;

2785 
båfs_dev_ôem
 *
dev_ôem
;

2786 
båfs_devi˚
 *
devi˚
;

2787 
båfs_key
 
key
;

2788 
u8
 
fs_uuid
[
BTRFS_FSID_SIZE
];

2789 
u8
 
dev_uuid
[
BTRFS_UUID_SIZE
];

2790 
ªt
;

2792 
∑th
 = 
	`båfs_Æloc_∑th
();

2793 i‡(!
∑th
)

2794  -
ENOMEM
;

2796 
key
.
obje˘id
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

2797 
key
.
off£t
 = 0;

2798 
key
.
ty≥
 = 
BTRFS_DEV_ITEM_KEY
;

2801 
	`båfs_ª£rve_chunk_mëad©a
(
å™s
, 
Ál£
);

2802 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, 0, 1);

2803 
	`båfs_å™s_ªÀa£_chunk_mëad©a
(
å™s
);

2804 i‡(
ªt
 < 0)

2805 
îr‹
;

2807 
Àaf
 = 
∑th
->
nodes
[0];

2808 
√xt_¶Ÿ
:

2809 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
(
Àaf
)) {

2810 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

2811 i‡(
ªt
 > 0)

2813 i‡(
ªt
 < 0)

2814 
îr‹
;

2815 
Àaf
 = 
∑th
->
nodes
[0];

2816 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

2817 
	`båfs_ªÀa£_∑th
(
∑th
);

2821 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
∑th
->
¶Ÿs
[0]);

2822 i‡(
key
.
obje˘id
 !
BTRFS_DEV_ITEMS_OBJECTID
 ||

2823 
key
.
ty≥
 !
BTRFS_DEV_ITEM_KEY
)

2826 
dev_ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

2827 
båfs_dev_ôem
);

2828 
¨gs
.
devid
 = 
	`båfs_devi˚_id
(
Àaf
, 
dev_ôem
);

2829 
	`ªad_exã¡_buf„r
(
Àaf
, 
dev_uuid
, 
	`båfs_devi˚_uuid
(
dev_ôem
),

2830 
BTRFS_UUID_SIZE
);

2831 
	`ªad_exã¡_buf„r
(
Àaf
, 
fs_uuid
, 
	`båfs_devi˚_fsid
(
dev_ôem
),

2832 
BTRFS_FSID_SIZE
);

2833 
¨gs
.
uuid
 = 
dev_uuid
;

2834 
¨gs
.
fsid
 = 
fs_uuid
;

2835 
devi˚
 = 
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, &
¨gs
);

2836 
	`BUG_ON
(!
devi˚
);

2838 i‡(
devi˚
->
fs_devi˚s
->
£edög
) {

2839 
	`båfs_£t_devi˚_gíî©i⁄
(
Àaf
, 
dev_ôem
,

2840 
devi˚
->
gíî©i⁄
);

2841 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

2844 
∑th
->
¶Ÿs
[0]++;

2845 
√xt_¶Ÿ
;

2847 
ªt
 = 0;

2848 
îr‹
:

2849 
	`båfs_‰ì_∑th
(
∑th
);

2850  
ªt
;

2851 
	}
}

2853 
	$båfs_öô_√w_devi˚
(
båfs_fs_öfo
 *
fs_öfo
, c⁄° *
devi˚_∑th
)

2855 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
dev_roŸ
;

2856 
båfs_å™s_h™dÀ
 *
å™s
;

2857 
båfs_devi˚
 *
devi˚
;

2858 
block_devi˚
 *
bdev
;

2859 
su≥r_block
 *
sb
 = 
fs_öfo
->sb;

2860 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

2861 
båfs_fs_devi˚s
 *
£ed_devi˚s
 = 
NULL
;

2862 
u64
 
‹ig_su≥r_tŸÆ_byãs
;

2863 
u64
 
‹ig_su≥r_num_devi˚s
;

2864 
ªt
 = 0;

2865 
boﬁ
 
£edög_dev
 = 
Ál£
;

2866 
boﬁ
 
locked
 = 
Ál£
;

2868 i‡(
	`sb_rd⁄ly
(
sb
Ë&& !
fs_devi˚s
->
£edög
)

2869  -
EROFS
;

2871 
bdev
 = 
	`blkdev_gë_by_∑th
(
devi˚_∑th
, 
BLK_OPEN_WRITE
,

2872 
fs_öfo
->
bdev_hﬁdî
, 
NULL
);

2873 i‡(
	`IS_ERR
(
bdev
))

2874  
	`PTR_ERR
(
bdev
);

2876 i‡(!
	`båfs_check_devi˚_z⁄e_ty≥
(
fs_öfo
, 
bdev
)) {

2877 
ªt
 = -
EINVAL
;

2878 
îr‹
;

2881 i‡(
fs_devi˚s
->
£edög
) {

2882 
£edög_dev
 = 
åue
;

2883 
	`down_wrôe
(&
sb
->
s_umou¡
);

2884 
	`muãx_lock
(&
uuid_muãx
);

2885 
locked
 = 
åue
;

2888 
	`sync_blockdev
(
bdev
);

2890 
	`rcu_ªad_lock
();

2891 
	`li°_f‹_óch_íåy_rcu
(
devi˚
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

2892 i‡(
devi˚
->
bdev
 == bdev) {

2893 
ªt
 = -
EEXIST
;

2894 
	`rcu_ªad_u∆ock
();

2895 
îr‹
;

2898 
	`rcu_ªad_u∆ock
();

2900 
devi˚
 = 
	`båfs_Æloc_devi˚
(
fs_öfo
, 
NULL
, NULL, 
devi˚_∑th
);

2901 i‡(
	`IS_ERR
(
devi˚
)) {

2903 
ªt
 = 
	`PTR_ERR
(
devi˚
);

2904 
îr‹
;

2907 
devi˚
->
fs_öfo
 = fs_info;

2908 
devi˚
->
bdev
 = bdev;

2909 
ªt
 = 
	`lookup_bdev
(
devi˚_∑th
, &
devi˚
->
devt
);

2910 i‡(
ªt
)

2911 
îr‹_‰ì_devi˚
;

2913 
ªt
 = 
	`båfs_gë_dev_z⁄e_öfo
(
devi˚
, 
Ál£
);

2914 i‡(
ªt
)

2915 
îr‹_‰ì_devi˚
;

2917 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

2918 i‡(
	`IS_ERR
(
å™s
)) {

2919 
ªt
 = 
	`PTR_ERR
(
å™s
);

2920 
îr‹_‰ì_z⁄e
;

2923 
	`£t_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
);

2924 
devi˚
->
gíî©i⁄
 = 
å™s
->
å™sid
;

2925 
devi˚
->
io_width
 = 
fs_öfo
->
£˘‹size
;

2926 
devi˚
->
io_Æign
 = 
fs_öfo
->
£˘‹size
;

2927 
devi˚
->
£˘‹_size
 = 
fs_öfo
->
£˘‹size
;

2928 
devi˚
->
tŸÆ_byãs
 =

2929 
	`round_down
(
	`bdev_ƒ_byãs
(
bdev
), 
fs_öfo
->
£˘‹size
);

2930 
devi˚
->
disk_tŸÆ_byãs
 = devi˚->
tŸÆ_byãs
;

2931 
devi˚
->
commô_tŸÆ_byãs
 = devi˚->
tŸÆ_byãs
;

2932 
	`£t_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
devi˚
->
dev_°©e
);

2933 
	`˛ór_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
);

2934 
devi˚
->
hﬁdî
 = 
fs_öfo
->
bdev_hﬁdî
;

2935 
devi˚
->
dev_°©s_vÆid
 = 1;

2936 
	`£t_blocksize
(
devi˚
->
bdev
, 
BTRFS_BDEV_BLOCKSIZE
);

2938 i‡(
£edög_dev
) {

2939 
	`båfs_˛ór_sb_rd⁄ly
(
sb
);

2942 
£ed_devi˚s
 = 
	`båfs_öô_•rout
(
fs_öfo
);

2943 i‡(
	`IS_ERR
(
£ed_devi˚s
)) {

2944 
ªt
 = 
	`PTR_ERR
(
£ed_devi˚s
);

2945 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

2946 
îr‹_å™s
;

2950 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

2951 i‡(
£edög_dev
) {

2952 
	`båfs_£tup_•rout
(
fs_öfo
, 
£ed_devi˚s
);

2953 
	`båfs_assign_√xt_a˘ive_devi˚
(
fs_öfo
->
fs_devi˚s
->
œã°_dev
,

2954 
devi˚
);

2957 
devi˚
->
fs_devi˚s
 = fs_devices;

2959 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

2960 
	`li°_add_rcu
(&
devi˚
->
dev_li°
, &
fs_devi˚s
->
devi˚s
);

2961 
	`li°_add
(&
devi˚
->
dev_Æloc_li°
, &
fs_devi˚s
->
Æloc_li°
);

2962 
fs_devi˚s
->
num_devi˚s
++;

2963 
fs_devi˚s
->
›í_devi˚s
++;

2964 
fs_devi˚s
->
rw_devi˚s
++;

2965 
fs_devi˚s
->
tŸÆ_devi˚s
++;

2966 
fs_devi˚s
->
tŸÆ_rw_byãs
 +
devi˚
->
tŸÆ_byãs
;

2968 
	`©omic64_add
(
devi˚
->
tŸÆ_byãs
, &
fs_öfo
->
‰ì_chunk_•a˚
);

2970 i‡(!
	`bdev_n⁄rŸ
(
bdev
))

2971 
fs_devi˚s
->
rŸ©ög
 = 
åue
;

2973 
‹ig_su≥r_tŸÆ_byãs
 = 
	`båfs_su≥r_tŸÆ_byãs
(
fs_öfo
->
su≥r_c›y
);

2974 
	`båfs_£t_su≥r_tŸÆ_byãs
(
fs_öfo
->
su≥r_c›y
,

2975 
	`round_down
(
‹ig_su≥r_tŸÆ_byãs
 + 
devi˚
->
tŸÆ_byãs
,

2976 
fs_öfo
->
£˘‹size
));

2978 
‹ig_su≥r_num_devi˚s
 = 
	`båfs_su≥r_num_devi˚s
(
fs_öfo
->
su≥r_c›y
);

2979 
	`båfs_£t_su≥r_num_devi˚s
(
fs_öfo
->
su≥r_c›y
,

2980 
‹ig_su≥r_num_devi˚s
 + 1);

2986 
	`båfs_˛ór_•a˚_öfo_fuŒ
(
fs_öfo
);

2988 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

2991 
	`båfs_sysfs_add_devi˚
(
devi˚
);

2993 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

2995 i‡(
£edög_dev
) {

2996 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

2997 
ªt
 = 
	`öô_fú°_rw_devi˚
(
å™s
);

2998 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

2999 i‡(
ªt
) {

3000 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3001 
îr‹_sysfs
;

3005 
ªt
 = 
	`båfs_add_dev_ôem
(
å™s
, 
devi˚
);

3006 i‡(
ªt
) {

3007 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3008 
îr‹_sysfs
;

3011 i‡(
£edög_dev
) {

3012 
ªt
 = 
	`båfs_föish_•rout
(
å™s
);

3013 i‡(
ªt
) {

3014 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3015 
îr‹_sysfs
;

3022 
	`båfs_sysfs_upd©e_•rout_fsid
(
fs_devi˚s
);

3025 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

3027 i‡(
£edög_dev
) {

3028 
	`muãx_u∆ock
(&
uuid_muãx
);

3029 
	`up_wrôe
(&
sb
->
s_umou¡
);

3030 
locked
 = 
Ál£
;

3032 i‡(
ªt
)

3033  
ªt
;

3035 
ªt
 = 
	`båfs_ªloˇã_sys_chunks
(
fs_öfo
);

3036 i‡(
ªt
 < 0)

3037 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
ªt
,

3039 
å™s
 = 
	`båfs_©èch_å™ß˘i⁄
(
roŸ
);

3040 i‡(
	`IS_ERR
(
å™s
)) {

3041 i‡(
	`PTR_ERR
(
å™s
Ë=-
ENOENT
)

3043 
ªt
 = 
	`PTR_ERR
(
å™s
);

3044 
å™s
 = 
NULL
;

3045 
îr‹_sysfs
;

3047 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

3057 
	`båfs_f‹gë_devi˚s
(
devi˚
->
devt
);

3060 
	`upd©e_dev_time
(
devi˚_∑th
);

3062  
ªt
;

3064 
îr‹_sysfs
:

3065 
	`båfs_sysfs_ªmove_devi˚
(
devi˚
);

3066 
	`muãx_lock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

3067 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

3068 
	`li°_dñ_rcu
(&
devi˚
->
dev_li°
);

3069 
	`li°_dñ
(&
devi˚
->
dev_Æloc_li°
);

3070 
fs_öfo
->
fs_devi˚s
->
num_devi˚s
--;

3071 
fs_öfo
->
fs_devi˚s
->
›í_devi˚s
--;

3072 
fs_öfo
->
fs_devi˚s
->
rw_devi˚s
--;

3073 
fs_öfo
->
fs_devi˚s
->
tŸÆ_devi˚s
--;

3074 
fs_öfo
->
fs_devi˚s
->
tŸÆ_rw_byãs
 -
devi˚
->
tŸÆ_byãs
;

3075 
	`©omic64_sub
(
devi˚
->
tŸÆ_byãs
, &
fs_öfo
->
‰ì_chunk_•a˚
);

3076 
	`båfs_£t_su≥r_tŸÆ_byãs
(
fs_öfo
->
su≥r_c›y
,

3077 
‹ig_su≥r_tŸÆ_byãs
);

3078 
	`båfs_£t_su≥r_num_devi˚s
(
fs_öfo
->
su≥r_c›y
,

3079 
‹ig_su≥r_num_devi˚s
);

3080 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

3081 
	`muãx_u∆ock
(&
fs_öfo
->
fs_devi˚s
->
devi˚_li°_muãx
);

3082 
îr‹_å™s
:

3083 i‡(
£edög_dev
)

3084 
	`båfs_£t_sb_rd⁄ly
(
sb
);

3085 i‡(
å™s
)

3086 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

3087 
îr‹_‰ì_z⁄e
:

3088 
	`båfs_de°roy_dev_z⁄e_öfo
(
devi˚
);

3089 
îr‹_‰ì_devi˚
:

3090 
	`båfs_‰ì_devi˚
(
devi˚
);

3091 
îr‹
:

3092 
	`blkdev_put
(
bdev
, 
fs_öfo
->
bdev_hﬁdî
);

3093 i‡(
locked
) {

3094 
	`muãx_u∆ock
(&
uuid_muãx
);

3095 
	`up_wrôe
(&
sb
->
s_umou¡
);

3097  
ªt
;

3098 
	}
}

3100 
noölöe
 
	$båfs_upd©e_devi˚
(
båfs_å™s_h™dÀ
 *
å™s
,

3101 
båfs_devi˚
 *
devi˚
)

3103 
ªt
;

3104 
båfs_∑th
 *
∑th
;

3105 
båfs_roŸ
 *
roŸ
 = 
devi˚
->
fs_öfo
->
chunk_roŸ
;

3106 
båfs_dev_ôem
 *
dev_ôem
;

3107 
exã¡_buf„r
 *
Àaf
;

3108 
båfs_key
 
key
;

3110 
∑th
 = 
	`båfs_Æloc_∑th
();

3111 i‡(!
∑th
)

3112  -
ENOMEM
;

3114 
key
.
obje˘id
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

3115 
key
.
ty≥
 = 
BTRFS_DEV_ITEM_KEY
;

3116 
key
.
off£t
 = 
devi˚
->
devid
;

3118 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, 0, 1);

3119 i‡(
ªt
 < 0)

3120 
out
;

3122 i‡(
ªt
 > 0) {

3123 
ªt
 = -
ENOENT
;

3124 
out
;

3127 
Àaf
 = 
∑th
->
nodes
[0];

3128 
dev_ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_dev_ôem
);

3130 
	`båfs_£t_devi˚_id
(
Àaf
, 
dev_ôem
, 
devi˚
->
devid
);

3131 
	`båfs_£t_devi˚_ty≥
(
Àaf
, 
dev_ôem
, 
devi˚
->
ty≥
);

3132 
	`båfs_£t_devi˚_io_Æign
(
Àaf
, 
dev_ôem
, 
devi˚
->
io_Æign
);

3133 
	`båfs_£t_devi˚_io_width
(
Àaf
, 
dev_ôem
, 
devi˚
->
io_width
);

3134 
	`båfs_£t_devi˚_£˘‹_size
(
Àaf
, 
dev_ôem
, 
devi˚
->
£˘‹_size
);

3135 
	`båfs_£t_devi˚_tŸÆ_byãs
(
Àaf
, 
dev_ôem
,

3136 
	`båfs_devi˚_gë_disk_tŸÆ_byãs
(
devi˚
));

3137 
	`båfs_£t_devi˚_byãs_u£d
(
Àaf
, 
dev_ôem
,

3138 
	`båfs_devi˚_gë_byãs_u£d
(
devi˚
));

3139 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

3141 
out
:

3142 
	`båfs_‰ì_∑th
(
∑th
);

3143  
ªt
;

3144 
	}
}

3146 
	$båfs_grow_devi˚
(
båfs_å™s_h™dÀ
 *
å™s
,

3147 
båfs_devi˚
 *
devi˚
, 
u64
 
√w_size
)

3149 
båfs_fs_öfo
 *
fs_öfo
 = 
devi˚
->fs_info;

3150 
båfs_su≥r_block
 *
su≥r_c›y
 = 
fs_öfo
->super_copy;

3151 
u64
 
ﬁd_tŸÆ
;

3152 
u64
 
diff
;

3153 
ªt
;

3155 i‡(!
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
))

3156  -
EACCES
;

3158 
√w_size
 = 
	`round_down
“ew_size, 
fs_öfo
->
£˘‹size
);

3160 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

3161 
ﬁd_tŸÆ
 = 
	`båfs_su≥r_tŸÆ_byãs
(
su≥r_c›y
);

3162 
diff
 = 
	`round_down
(
√w_size
 - 
devi˚
->
tŸÆ_byãs
, 
fs_öfo
->
£˘‹size
);

3164 i‡(
√w_size
 <
devi˚
->
tŸÆ_byãs
 ||

3165 
	`ã°_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
)) {

3166 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

3167  -
EINVAL
;

3170 
	`båfs_£t_su≥r_tŸÆ_byãs
(
su≥r_c›y
,

3171 
	`round_down
(
ﬁd_tŸÆ
 + 
diff
, 
fs_öfo
->
£˘‹size
));

3172 
devi˚
->
fs_devi˚s
->
tŸÆ_rw_byãs
 +
diff
;

3174 
	`båfs_devi˚_£t_tŸÆ_byãs
(
devi˚
, 
√w_size
);

3175 
	`båfs_devi˚_£t_disk_tŸÆ_byãs
(
devi˚
, 
√w_size
);

3176 
	`båfs_˛ór_•a˚_öfo_fuŒ
(
devi˚
->
fs_öfo
);

3177 i‡(
	`li°_em±y
(&
devi˚
->
po°_commô_li°
))

3178 
	`li°_add_èû
(&
devi˚
->
po°_commô_li°
,

3179 &
å™s
->
å™ß˘i⁄
->
dev_upd©e_li°
);

3180 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

3182 
	`båfs_ª£rve_chunk_mëad©a
(
å™s
, 
Ál£
);

3183 
ªt
 = 
	`båfs_upd©e_devi˚
(
å™s
, 
devi˚
);

3184 
	`båfs_å™s_ªÀa£_chunk_mëad©a
(
å™s
);

3186  
ªt
;

3187 
	}
}

3189 
	$båfs_‰ì_chunk
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
chunk_off£t
)

3191 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

3192 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
chunk_roŸ
;

3193 
ªt
;

3194 
båfs_∑th
 *
∑th
;

3195 
båfs_key
 
key
;

3197 
∑th
 = 
	`båfs_Æloc_∑th
();

3198 i‡(!
∑th
)

3199  -
ENOMEM
;

3201 
key
.
obje˘id
 = 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
;

3202 
key
.
off£t
 = 
chunk_off£t
;

3203 
key
.
ty≥
 = 
BTRFS_CHUNK_ITEM_KEY
;

3205 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

3206 i‡(
ªt
 < 0)

3207 
out
;

3208 i‡(
ªt
 > 0) {

3209 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, -
ENOENT
,

3211 
ªt
 = -
ENOENT
;

3212 
out
;

3215 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

3216 i‡(
ªt
 < 0)

3217 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
ªt
,

3219 
out
:

3220 
	`båfs_‰ì_∑th
(
∑th
);

3221  
ªt
;

3222 
	}
}

3224 
	$båfs_dñ_sys_chunk
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
chunk_off£t
)

3226 
båfs_su≥r_block
 *
su≥r_c›y
 = 
fs_öfo
->super_copy;

3227 
båfs_disk_key
 *
disk_key
;

3228 
båfs_chunk
 *
chunk
;

3229 
u8
 *
±r
;

3230 
ªt
 = 0;

3231 
u32
 
num_°rùes
;

3232 
u32
 
¨øy_size
;

3233 
u32
 
Àn
 = 0;

3234 
u32
 
cur
;

3235 
båfs_key
 
key
;

3237 
	`lockdï_as£π_hñd
(&
fs_öfo
->
chunk_muãx
);

3238 
¨øy_size
 = 
	`båfs_su≥r_sys_¨øy_size
(
su≥r_c›y
);

3240 
±r
 = 
su≥r_c›y
->
sys_chunk_¨øy
;

3241 
cur
 = 0;

3243 
cur
 < 
¨øy_size
) {

3244 
disk_key
 = (
båfs_disk_key
 *)
±r
;

3245 
	`båfs_disk_key_to_˝u
(&
key
, 
disk_key
);

3247 
Àn
 = (*
disk_key
);

3249 i‡(
key
.
ty≥
 =
BTRFS_CHUNK_ITEM_KEY
) {

3250 
chunk
 = (
båfs_chunk
 *)(
±r
 + 
Àn
);

3251 
num_°rùes
 = 
	`båfs_°ack_chunk_num_°rùes
(
chunk
);

3252 
Àn
 +
	`båfs_chunk_ôem_size
(
num_°rùes
);

3254 
ªt
 = -
EIO
;

3257 i‡(
key
.
obje˘id
 =
BTRFS_FIRST_CHUNK_TREE_OBJECTID
 &&

3258 
key
.
off£t
 =
chunk_off£t
) {

3259 
	`memmove
(
±r
,Öå + 
Àn
, 
¨øy_size
 - (
cur
 +Üen));

3260 
¨øy_size
 -
Àn
;

3261 
	`båfs_£t_su≥r_sys_¨øy_size
(
su≥r_c›y
, 
¨øy_size
);

3263 
±r
 +
Àn
;

3264 
cur
 +
Àn
;

3267  
ªt
;

3268 
	}
}

3277 
exã¡_m≠
 *
	$båfs_gë_chunk_m≠
(
båfs_fs_öfo
 *
fs_öfo
,

3278 
u64
 
logiˇl
, u64 
Àngth
)

3280 
exã¡_m≠_åì
 *
em_åì
;

3281 
exã¡_m≠
 *
em
;

3283 
em_åì
 = &
fs_öfo
->
m≠pög_åì
;

3284 
	`ªad_lock
(&
em_åì
->
lock
);

3285 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 
logiˇl
, 
Àngth
);

3286 
	`ªad_u∆ock
(&
em_åì
->
lock
);

3288 i‡(!
em
) {

3289 
	`båfs_¸ô
(
fs_öfo
,

3291 
logiˇl
, 
Àngth
);

3292  
	`ERR_PTR
(-
EINVAL
);

3295 i‡(
em
->
°¨t
 > 
logiˇl
 ||Ém->°¨à+Ém->
Àn
 <=Üogical) {

3296 
	`båfs_¸ô
(
fs_öfo
,

3298 
logiˇl
,Üogiˇ»+ 
Àngth
, 
em
->
°¨t
,Ém->°¨à+Ém->
Àn
);

3299 
	`‰ì_exã¡_m≠
(
em
);

3300  
	`ERR_PTR
(-
EINVAL
);

3304  
em
;

3305 
	}
}

3307 
	$ªmove_chunk_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

3308 
m≠_lookup
 *
m≠
, 
u64
 
chunk_off£t
)

3310 
i
;

3317 
	`lockdï_as£π_hñd
(&
å™s
->
fs_öfo
->
chunk_muãx
);

3319 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

3320 
ªt
;

3322 
ªt
 = 
	`båfs_upd©e_devi˚
(
å™s
, 
m≠
->
°rùes
[
i
].
dev
);

3323 i‡(
ªt
)

3324  
ªt
;

3327  
	`båfs_‰ì_chunk
(
å™s
, 
chunk_off£t
);

3328 
	}
}

3330 
	$båfs_ªmove_chunk
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
chunk_off£t
)

3332 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

3333 
exã¡_m≠
 *
em
;

3334 
m≠_lookup
 *
m≠
;

3335 
u64
 
dev_exã¡_Àn
 = 0;

3336 
i
, 
ªt
 = 0;

3337 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

3339 
em
 = 
	`båfs_gë_chunk_m≠
(
fs_öfo
, 
chunk_off£t
, 1);

3340 i‡(
	`IS_ERR
(
em
)) {

3346 
	`ASSERT
(0);

3347  
	`PTR_ERR
(
em
);

3349 
m≠
 = 
em
->
m≠_lookup
;

3361 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

3362 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

3363 
båfs_devi˚
 *
devi˚
 = 
m≠
->
°rùes
[
i
].
dev
;

3364 
ªt
 = 
	`båfs_‰ì_dev_exã¡
(
å™s
, 
devi˚
,

3365 
m≠
->
°rùes
[
i
].
physiˇl
,

3366 &
dev_exã¡_Àn
);

3367 i‡(
ªt
) {

3368 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

3369 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3370 
out
;

3373 i‡(
devi˚
->
byãs_u£d
 > 0) {

3374 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

3375 
	`båfs_devi˚_£t_byãs_u£d
(
devi˚
,

3376 
devi˚
->
byãs_u£d
 - 
dev_exã¡_Àn
);

3377 
	`©omic64_add
(
dev_exã¡_Àn
, &
fs_öfo
->
‰ì_chunk_•a˚
);

3378 
	`båfs_˛ór_•a˚_öfo_fuŒ
(
fs_öfo
);

3379 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

3382 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

3405 
å™s
->
ªmovög_chunk
 = 
åue
;

3406 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

3408 
	`check_sy°em_chunk
(
å™s
, 
m≠
->
ty≥
);

3410 
ªt
 = 
	`ªmove_chunk_ôem
(
å™s
, 
m≠
, 
chunk_off£t
);

3425 i‡(
ªt
 =-
ENOSPC
) {

3426 c⁄° 
u64
 
sys_Êags
 = 
	`båfs_sy°em_Æloc_¥ofûe
(
fs_öfo
);

3427 
båfs_block_group
 *
sys_bg
;

3429 
sys_bg
 = 
	`båfs_¸óã_chunk
(
å™s
, 
sys_Êags
);

3430 i‡(
	`IS_ERR
(
sys_bg
)) {

3431 
ªt
 = 
	`PTR_ERR
(
sys_bg
);

3432 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3433 
out
;

3436 
ªt
 = 
	`båfs_chunk_Æloc_add_chunk_ôem
(
å™s
, 
sys_bg
);

3437 i‡(
ªt
) {

3438 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3439 
out
;

3442 
ªt
 = 
	`ªmove_chunk_ôem
(
å™s
, 
m≠
, 
chunk_off£t
);

3443 i‡(
ªt
) {

3444 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3445 
out
;

3447 } i‡(
ªt
) {

3448 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3449 
out
;

3452 
	`åa˚_båfs_chunk_‰ì
(
fs_öfo
, 
m≠
, 
chunk_off£t
, 
em
->
Àn
);

3454 i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) {

3455 
ªt
 = 
	`båfs_dñ_sys_chunk
(
fs_öfo
, 
chunk_off£t
);

3456 i‡(
ªt
) {

3457 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3458 
out
;

3462 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

3463 
å™s
->
ªmovög_chunk
 = 
Ál£
;

3469 
	`båfs_å™s_ªÀa£_chunk_mëad©a
(
å™s
);

3471 
ªt
 = 
	`båfs_ªmove_block_group
(
å™s
, 
chunk_off£t
, 
em
);

3472 i‡(
ªt
) {

3473 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

3474 
out
;

3477 
out
:

3478 i‡(
å™s
->
ªmovög_chunk
) {

3479 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

3480 
å™s
->
ªmovög_chunk
 = 
Ál£
;

3483 
	`‰ì_exã¡_m≠
(
em
);

3484  
ªt
;

3485 
	}
}

3487 
	$båfs_ªloˇã_chunk
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
chunk_off£t
)

3489 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
chunk_roŸ
;

3490 
båfs_å™s_h™dÀ
 *
å™s
;

3491 
båfs_block_group
 *
block_group
;

3492 
u64
 
Àngth
;

3493 
ªt
;

3495 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
EXTENT_TREE_V2
)) {

3496 
	`båfs_îr
(
fs_öfo
,

3498  -
EINVAL
;

3513 
	`lockdï_as£π_hñd
(&
fs_öfo
->
ª˛aim_bgs_lock
);

3516 
	`båfs_s¸ub_∑u£
(
fs_öfo
);

3517 
ªt
 = 
	`båfs_ªloˇã_block_group
(
fs_öfo
, 
chunk_off£t
);

3518 
	`båfs_s¸ub_c⁄töue
(
fs_öfo
);

3519 i‡(
ªt
) {

3524 i‡(
	`BTRFS_FS_ERROR
(
fs_öfo
))

3525 
	`båfs_s¸ub_ˇn˚l
(
fs_öfo
);

3526  
ªt
;

3529 
block_group
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
chunk_off£t
);

3530 i‡(!
block_group
)

3531  -
ENOENT
;

3532 
	`båfs_disˇrd_ˇn˚l_w‹k
(&
fs_öfo
->
disˇrd_˘l
, 
block_group
);

3533 
Àngth
 = 
block_group
->length;

3534 
	`båfs_put_block_group
(
block_group
);

3542 i‡(
	`båfs_is_z⁄ed
(
fs_öfo
)) {

3543 
ªt
 = 
	`båfs_disˇrd_exã¡
(
fs_öfo
, 
chunk_off£t
, 
Àngth
, 
NULL
);

3544 i‡(
ªt
)

3545 
	`båfs_öfo
(
fs_öfo
,

3547 
chunk_off£t
);

3550 
å™s
 = 
	`båfs_°¨t_å™s_ªmove_block_group
(
roŸ
->
fs_öfo
,

3551 
chunk_off£t
);

3552 i‡(
	`IS_ERR
(
å™s
)) {

3553 
ªt
 = 
	`PTR_ERR
(
å™s
);

3554 
	`båfs_h™dÀ_fs_îr‹
(
roŸ
->
fs_öfo
, 
ªt
, 
NULL
);

3555  
ªt
;

3562 
ªt
 = 
	`båfs_ªmove_chunk
(
å™s
, 
chunk_off£t
);

3563 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

3564  
ªt
;

3565 
	}
}

3567 
	$båfs_ªloˇã_sys_chunks
(
båfs_fs_öfo
 *
fs_öfo
)

3569 
båfs_roŸ
 *
chunk_roŸ
 = 
fs_öfo
->chunk_root;

3570 
båfs_∑th
 *
∑th
;

3571 
exã¡_buf„r
 *
Àaf
;

3572 
båfs_chunk
 *
chunk
;

3573 
båfs_key
 
key
;

3574 
båfs_key
 
found_key
;

3575 
u64
 
chunk_ty≥
;

3576 
boﬁ
 
ªåõd
 = 
Ál£
;

3577 
Áûed
 = 0;

3578 
ªt
;

3580 
∑th
 = 
	`båfs_Æloc_∑th
();

3581 i‡(!
∑th
)

3582  -
ENOMEM
;

3584 
agaö
:

3585 
key
.
obje˘id
 = 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
;

3586 
key
.
off£t
 = (
u64
)-1;

3587 
key
.
ty≥
 = 
BTRFS_CHUNK_ITEM_KEY
;

3590 
	`muãx_lock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

3591 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
chunk_roŸ
, &
key
, 
∑th
, 0, 0);

3592 i‡(
ªt
 < 0) {

3593 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

3594 
îr‹
;

3596 
	`BUG_ON
(
ªt
 == 0);

3598 
ªt
 = 
	`båfs_¥evious_ôem
(
chunk_roŸ
, 
∑th
, 
key
.
obje˘id
,

3599 
key
.
ty≥
);

3600 i‡(
ªt
)

3601 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

3602 i‡(
ªt
 < 0)

3603 
îr‹
;

3604 i‡(
ªt
 > 0)

3607 
Àaf
 = 
∑th
->
nodes
[0];

3608 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
∑th
->
¶Ÿs
[0]);

3610 
chunk
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0],

3611 
båfs_chunk
);

3612 
chunk_ty≥
 = 
	`båfs_chunk_ty≥
(
Àaf
, 
chunk
);

3613 
	`båfs_ªÀa£_∑th
(
∑th
);

3615 i‡(
chunk_ty≥
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) {

3616 
ªt
 = 
	`båfs_ªloˇã_chunk
(
fs_öfo
, 
found_key
.
off£t
);

3617 i‡(
ªt
 =-
ENOSPC
)

3618 
Áûed
++;

3620 
	`BUG_ON
(
ªt
);

3622 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

3624 i‡(
found_key
.
off£t
 == 0)

3626 
key
.
off£t
 = 
found_key
.offset - 1;

3628 
ªt
 = 0;

3629 i‡(
Áûed
 && !
ªåõd
) {

3630 
Áûed
 = 0;

3631 
ªåõd
 = 
åue
;

3632 
agaö
;

3633 } i‡(
	`WARN_ON
(
Áûed
 && 
ªåõd
)) {

3634 
ªt
 = -
ENOSPC
;

3636 
îr‹
:

3637 
	`båfs_‰ì_∑th
(
∑th
);

3638  
ªt
;

3639 
	}
}

3646 
	$båfs_may_Æloc_d©a_chunk
(
båfs_fs_öfo
 *
fs_öfo
,

3647 
u64
 
chunk_off£t
)

3649 
båfs_block_group
 *
ˇche
;

3650 
u64
 
byãs_u£d
;

3651 
u64
 
chunk_ty≥
;

3653 
ˇche
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
chunk_off£t
);

3654 
	`ASSERT
(
ˇche
);

3655 
chunk_ty≥
 = 
ˇche
->
Êags
;

3656 
	`båfs_put_block_group
(
ˇche
);

3658 i‡(!(
chunk_ty≥
 & 
BTRFS_BLOCK_GROUP_DATA
))

3661 
	`•ö_lock
(&
fs_öfo
->
d©a_söfo
->
lock
);

3662 
byãs_u£d
 = 
fs_öfo
->
d©a_söfo
->bytes_used;

3663 
	`•ö_u∆ock
(&
fs_öfo
->
d©a_söfo
->
lock
);

3665 i‡(!
byãs_u£d
) {

3666 
båfs_å™s_h™dÀ
 *
å™s
;

3667 
ªt
;

3669 
å™s
 = 
	`båfs_joö_å™ß˘i⁄
(
fs_öfo
->
åì_roŸ
);

3670 i‡(
	`IS_ERR
(
å™s
))

3671  
	`PTR_ERR
(
å™s
);

3673 
ªt
 = 
	`båfs_f‹˚_chunk_Æloc
(
å™s
, 
BTRFS_BLOCK_GROUP_DATA
);

3674 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

3675 i‡(
ªt
 < 0)

3676  
ªt
;

3681 
	}
}

3683 
	$ö£π_bÆ™˚_ôem
(
båfs_fs_öfo
 *
fs_öfo
,

3684 
båfs_bÆ™˚_c⁄åﬁ
 *
b˘l
)

3686 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
åì_roŸ
;

3687 
båfs_å™s_h™dÀ
 *
å™s
;

3688 
båfs_bÆ™˚_ôem
 *
ôem
;

3689 
båfs_disk_bÆ™˚_¨gs
 
disk_b¨gs
;

3690 
båfs_∑th
 *
∑th
;

3691 
exã¡_buf„r
 *
Àaf
;

3692 
båfs_key
 
key
;

3693 
ªt
, 
îr
;

3695 
∑th
 = 
	`båfs_Æloc_∑th
();

3696 i‡(!
∑th
)

3697  -
ENOMEM
;

3699 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

3700 i‡(
	`IS_ERR
(
å™s
)) {

3701 
	`båfs_‰ì_∑th
(
∑th
);

3702  
	`PTR_ERR
(
å™s
);

3705 
key
.
obje˘id
 = 
BTRFS_BALANCE_OBJECTID
;

3706 
key
.
ty≥
 = 
BTRFS_TEMPORARY_ITEM_KEY
;

3707 
key
.
off£t
 = 0;

3709 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
roŸ
, 
∑th
, &
key
,

3710 (*
ôem
));

3711 i‡(
ªt
)

3712 
out
;

3714 
Àaf
 = 
∑th
->
nodes
[0];

3715 
ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_bÆ™˚_ôem
);

3717 
	`memzîo_exã¡_buf„r
(
Àaf
, ()
ôem
, (*item));

3719 
	`båfs_˝u_bÆ™˚_¨gs_to_disk
(&
disk_b¨gs
, &
b˘l
->
d©a
);

3720 
	`båfs_£t_bÆ™˚_d©a
(
Àaf
, 
ôem
, &
disk_b¨gs
);

3721 
	`båfs_˝u_bÆ™˚_¨gs_to_disk
(&
disk_b¨gs
, &
b˘l
->
mëa
);

3722 
	`båfs_£t_bÆ™˚_mëa
(
Àaf
, 
ôem
, &
disk_b¨gs
);

3723 
	`båfs_˝u_bÆ™˚_¨gs_to_disk
(&
disk_b¨gs
, &
b˘l
->
sys
);

3724 
	`båfs_£t_bÆ™˚_sys
(
Àaf
, 
ôem
, &
disk_b¨gs
);

3726 
	`båfs_£t_bÆ™˚_Êags
(
Àaf
, 
ôem
, 
b˘l
->
Êags
);

3728 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

3729 
out
:

3730 
	`båfs_‰ì_∑th
(
∑th
);

3731 
îr
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

3732 i‡(
îr
 && !
ªt
)

3733 
ªt
 = 
îr
;

3734  
ªt
;

3735 
	}
}

3737 
	$dñ_bÆ™˚_ôem
(
båfs_fs_öfo
 *
fs_öfo
)

3739 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
åì_roŸ
;

3740 
båfs_å™s_h™dÀ
 *
å™s
;

3741 
båfs_∑th
 *
∑th
;

3742 
båfs_key
 
key
;

3743 
ªt
, 
îr
;

3745 
∑th
 = 
	`båfs_Æloc_∑th
();

3746 i‡(!
∑th
)

3747  -
ENOMEM
;

3749 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄_ÁŒback_globÆ_rsv
(
roŸ
, 0);

3750 i‡(
	`IS_ERR
(
å™s
)) {

3751 
	`båfs_‰ì_∑th
(
∑th
);

3752  
	`PTR_ERR
(
å™s
);

3755 
key
.
obje˘id
 = 
BTRFS_BALANCE_OBJECTID
;

3756 
key
.
ty≥
 = 
BTRFS_TEMPORARY_ITEM_KEY
;

3757 
key
.
off£t
 = 0;

3759 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
roŸ
, &
key
, 
∑th
, -1, 1);

3760 i‡(
ªt
 < 0)

3761 
out
;

3762 i‡(
ªt
 > 0) {

3763 
ªt
 = -
ENOENT
;

3764 
out
;

3767 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
roŸ
, 
∑th
);

3768 
out
:

3769 
	`båfs_‰ì_∑th
(
∑th
);

3770 
îr
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

3771 i‡(
îr
 && !
ªt
)

3772 
ªt
 = 
îr
;

3773  
ªt
;

3774 
	}
}

3780 
	$upd©e_bÆ™˚_¨gs
(
båfs_bÆ™˚_c⁄åﬁ
 *
b˘l
)

3785 i‡(
b˘l
->
d©a
.
Êags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)

3786 
b˘l
->
d©a
.
Êags
 |
BTRFS_BALANCE_ARGS_SOFT
;

3787 i‡(
b˘l
->
sys
.
Êags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)

3788 
b˘l
->
sys
.
Êags
 |
BTRFS_BALANCE_ARGS_SOFT
;

3789 i‡(
b˘l
->
mëa
.
Êags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)

3790 
b˘l
->
mëa
.
Êags
 |
BTRFS_BALANCE_ARGS_SOFT
;

3799 i‡(!(
b˘l
->
d©a
.
Êags
 & 
BTRFS_BALANCE_ARGS_USAGE
) &&

3800 !(
b˘l
->
d©a
.
Êags
 & 
BTRFS_BALANCE_ARGS_USAGE_RANGE
) &&

3801 !(
b˘l
->
d©a
.
Êags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)) {

3802 
b˘l
->
d©a
.
Êags
 |
BTRFS_BALANCE_ARGS_USAGE
;

3803 
b˘l
->
d©a
.
ußge
 = 90;

3805 i‡(!(
b˘l
->
sys
.
Êags
 & 
BTRFS_BALANCE_ARGS_USAGE
) &&

3806 !(
b˘l
->
sys
.
Êags
 & 
BTRFS_BALANCE_ARGS_USAGE_RANGE
) &&

3807 !(
b˘l
->
sys
.
Êags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)) {

3808 
b˘l
->
sys
.
Êags
 |
BTRFS_BALANCE_ARGS_USAGE
;

3809 
b˘l
->
sys
.
ußge
 = 90;

3811 i‡(!(
b˘l
->
mëa
.
Êags
 & 
BTRFS_BALANCE_ARGS_USAGE
) &&

3812 !(
b˘l
->
mëa
.
Êags
 & 
BTRFS_BALANCE_ARGS_USAGE_RANGE
) &&

3813 !(
b˘l
->
mëa
.
Êags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)) {

3814 
b˘l
->
mëa
.
Êags
 |
BTRFS_BALANCE_ARGS_USAGE
;

3815 
b˘l
->
mëa
.
ußge
 = 90;

3817 
	}
}

3822 
	$ª£t_bÆ™˚_°©e
(
båfs_fs_öfo
 *
fs_öfo
)

3824 
båfs_bÆ™˚_c⁄åﬁ
 *
b˘l
 = 
fs_öfo
->
bÆ™˚_˘l
;

3825 
ªt
;

3827 
	`BUG_ON
(!
fs_öfo
->
bÆ™˚_˘l
);

3829 
	`•ö_lock
(&
fs_öfo
->
bÆ™˚_lock
);

3830 
fs_öfo
->
bÆ™˚_˘l
 = 
NULL
;

3831 
	`•ö_u∆ock
(&
fs_öfo
->
bÆ™˚_lock
);

3833 
	`k‰ì
(
b˘l
);

3834 
ªt
 = 
	`dñ_bÆ™˚_ôem
(
fs_öfo
);

3835 i‡(
ªt
)

3836 
	`båfs_h™dÀ_fs_îr‹
(
fs_öfo
, 
ªt
, 
NULL
);

3837 
	}
}

3843 
	$chunk_¥ofûes_fûãr
(
u64
 
chunk_ty≥
,

3844 
båfs_bÆ™˚_¨gs
 *
b¨gs
)

3846 
chunk_ty≥
 = 
	`chunk_to_exãnded
(chunk_type) &

3847 
BTRFS_EXTENDED_PROFILE_MASK
;

3849 i‡(
b¨gs
->
¥ofûes
 & 
chunk_ty≥
)

3853 
	}
}

3855 
	$chunk_ußge_ønge_fûãr
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
chunk_off£t
,

3856 
båfs_bÆ™˚_¨gs
 *
b¨gs
)

3858 
båfs_block_group
 *
ˇche
;

3859 
u64
 
chunk_u£d
;

3860 
u64
 
u£r_thªsh_mö
;

3861 
u64
 
u£r_thªsh_max
;

3862 
ªt
 = 1;

3864 
ˇche
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
chunk_off£t
);

3865 
chunk_u£d
 = 
ˇche
->
u£d
;

3867 i‡(
b¨gs
->
ußge_mö
 == 0)

3868 
u£r_thªsh_mö
 = 0;

3870 
u£r_thªsh_mö
 = 
	`mu…_≥rc
(
ˇche
->
Àngth
, 
b¨gs
->
ußge_mö
);

3872 i‡(
b¨gs
->
ußge_max
 == 0)

3873 
u£r_thªsh_max
 = 1;

3874 i‡(
b¨gs
->
ußge_max
 > 100)

3875 
u£r_thªsh_max
 = 
ˇche
->
Àngth
;

3877 
u£r_thªsh_max
 = 
	`mu…_≥rc
(
ˇche
->
Àngth
, 
b¨gs
->
ußge_max
);

3879 i‡(
u£r_thªsh_mö
 <
chunk_u£d
 && chunk_u£d < 
u£r_thªsh_max
)

3880 
ªt
 = 0;

3882 
	`båfs_put_block_group
(
ˇche
);

3883  
ªt
;

3884 
	}
}

3886 
	$chunk_ußge_fûãr
(
båfs_fs_öfo
 *
fs_öfo
,

3887 
u64
 
chunk_off£t
, 
båfs_bÆ™˚_¨gs
 *
b¨gs
)

3889 
båfs_block_group
 *
ˇche
;

3890 
u64
 
chunk_u£d
, 
u£r_thªsh
;

3891 
ªt
 = 1;

3893 
ˇche
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
chunk_off£t
);

3894 
chunk_u£d
 = 
ˇche
->
u£d
;

3896 i‡(
b¨gs
->
ußge_mö
 == 0)

3897 
u£r_thªsh
 = 1;

3898 i‡(
b¨gs
->
ußge
 > 100)

3899 
u£r_thªsh
 = 
ˇche
->
Àngth
;

3901 
u£r_thªsh
 = 
	`mu…_≥rc
(
ˇche
->
Àngth
, 
b¨gs
->
ußge
);

3903 i‡(
chunk_u£d
 < 
u£r_thªsh
)

3904 
ªt
 = 0;

3906 
	`båfs_put_block_group
(
ˇche
);

3907  
ªt
;

3908 
	}
}

3910 
	$chunk_devid_fûãr
(
exã¡_buf„r
 *
Àaf
,

3911 
båfs_chunk
 *
chunk
,

3912 
båfs_bÆ™˚_¨gs
 *
b¨gs
)

3914 
båfs_°rùe
 *
°rùe
;

3915 
num_°rùes
 = 
	`båfs_chunk_num_°rùes
(
Àaf
, 
chunk
);

3916 
i
;

3918 
i
 = 0; i < 
num_°rùes
; i++) {

3919 
°rùe
 = 
	`båfs_°rùe_ƒ
(
chunk
, 
i
);

3920 i‡(
	`båfs_°rùe_devid
(
Àaf
, 
°rùe
Ë=
b¨gs
->
devid
)

3925 
	}
}

3927 
u64
 
	$ˇlc_d©a_°rùes
(
u64
 
ty≥
, 
num_°rùes
)

3929 c⁄° 
ödex
 = 
	`båfs_bg_Êags_to_øid_ödex
(
ty≥
);

3930 c⁄° 
nc›õs
 = 
båfs_øid_¨øy
[
ödex
].ncopies;

3931 c⁄° 
≈¨ôy
 = 
båfs_øid_¨øy
[
ödex
].nparity;

3933  (
num_°rùes
 - 
≈¨ôy
Ë/ 
nc›õs
;

3934 
	}
}

3937 
	$chunk_dønge_fûãr
(
exã¡_buf„r
 *
Àaf
,

3938 
båfs_chunk
 *
chunk
,

3939 
båfs_bÆ™˚_¨gs
 *
b¨gs
)

3941 
båfs_°rùe
 *
°rùe
;

3942 
num_°rùes
 = 
	`båfs_chunk_num_°rùes
(
Àaf
, 
chunk
);

3943 
u64
 
°rùe_off£t
;

3944 
u64
 
°rùe_Àngth
;

3945 
u64
 
ty≥
;

3946 
Á˘‹
;

3947 
i
;

3949 i‡(!(
b¨gs
->
Êags
 & 
BTRFS_BALANCE_ARGS_DEVID
))

3952 
ty≥
 = 
	`båfs_chunk_ty≥
(
Àaf
, 
chunk
);

3953 
Á˘‹
 = 
	`ˇlc_d©a_°rùes
(
ty≥
, 
num_°rùes
);

3955 
i
 = 0; i < 
num_°rùes
; i++) {

3956 
°rùe
 = 
	`båfs_°rùe_ƒ
(
chunk
, 
i
);

3957 i‡(
	`båfs_°rùe_devid
(
Àaf
, 
°rùe
Ë!
b¨gs
->
devid
)

3960 
°rùe_off£t
 = 
	`båfs_°rùe_off£t
(
Àaf
, 
°rùe
);

3961 
°rùe_Àngth
 = 
	`båfs_chunk_Àngth
(
Àaf
, 
chunk
);

3962 
°rùe_Àngth
 = 
	`div_u64
(°rùe_Àngth, 
Á˘‹
);

3964 i‡(
°rùe_off£t
 < 
b¨gs
->
≥nd
 &&

3965 
°rùe_off£t
 + 
°rùe_Àngth
 > 
b¨gs
->
p°¨t
)

3970 
	}
}

3973 
	$chunk_vønge_fûãr
(
exã¡_buf„r
 *
Àaf
,

3974 
båfs_chunk
 *
chunk
,

3975 
u64
 
chunk_off£t
,

3976 
båfs_bÆ™˚_¨gs
 *
b¨gs
)

3978 i‡(
chunk_off£t
 < 
b¨gs
->
víd
 &&

3979 
chunk_off£t
 + 
	`båfs_chunk_Àngth
(
Àaf
, 
chunk
Ë> 
b¨gs
->
v°¨t
)

3984 
	}
}

3986 
	$chunk_°rùes_ønge_fûãr
(
exã¡_buf„r
 *
Àaf
,

3987 
båfs_chunk
 *
chunk
,

3988 
båfs_bÆ™˚_¨gs
 *
b¨gs
)

3990 
num_°rùes
 = 
	`båfs_chunk_num_°rùes
(
Àaf
, 
chunk
);

3992 i‡(
b¨gs
->
°rùes_mö
 <
num_°rùes


3993 && 
num_°rùes
 <
b¨gs
->
°rùes_max
)

3997 
	}
}

3999 
	$chunk_so·_c⁄vît_fûãr
(
u64
 
chunk_ty≥
,

4000 
båfs_bÆ™˚_¨gs
 *
b¨gs
)

4002 i‡(!(
b¨gs
->
Êags
 & 
BTRFS_BALANCE_ARGS_CONVERT
))

4005 
chunk_ty≥
 = 
	`chunk_to_exãnded
(chunk_type) &

4006 
BTRFS_EXTENDED_PROFILE_MASK
;

4008 i‡(
b¨gs
->
èrgë
 =
chunk_ty≥
)

4012 
	}
}

4014 
	$should_bÆ™˚_chunk
(
exã¡_buf„r
 *
Àaf
,

4015 
båfs_chunk
 *
chunk
, 
u64
 
chunk_off£t
)

4017 
båfs_fs_öfo
 *
fs_öfo
 = 
Àaf
->fs_info;

4018 
båfs_bÆ™˚_c⁄åﬁ
 *
b˘l
 = 
fs_öfo
->
bÆ™˚_˘l
;

4019 
båfs_bÆ™˚_¨gs
 *
b¨gs
 = 
NULL
;

4020 
u64
 
chunk_ty≥
 = 
	`båfs_chunk_ty≥
(
Àaf
, 
chunk
);

4023 i‡(!((
chunk_ty≥
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
) &

4024 (
b˘l
->
Êags
 & 
BTRFS_BALANCE_TYPE_MASK
))) {

4028 i‡(
chunk_ty≥
 & 
BTRFS_BLOCK_GROUP_DATA
)

4029 
b¨gs
 = &
b˘l
->
d©a
;

4030 i‡(
chunk_ty≥
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

4031 
b¨gs
 = &
b˘l
->
sys
;

4032 i‡(
chunk_ty≥
 & 
BTRFS_BLOCK_GROUP_METADATA
)

4033 
b¨gs
 = &
b˘l
->
mëa
;

4036 i‡((
b¨gs
->
Êags
 & 
BTRFS_BALANCE_ARGS_PROFILES
) &&

4037 
	`chunk_¥ofûes_fûãr
(
chunk_ty≥
, 
b¨gs
)) {

4042 i‡((
b¨gs
->
Êags
 & 
BTRFS_BALANCE_ARGS_USAGE
) &&

4043 
	`chunk_ußge_fûãr
(
fs_öfo
, 
chunk_off£t
, 
b¨gs
)) {

4045 } i‡((
b¨gs
->
Êags
 & 
BTRFS_BALANCE_ARGS_USAGE_RANGE
) &&

4046 
	`chunk_ußge_ønge_fûãr
(
fs_öfo
, 
chunk_off£t
, 
b¨gs
)) {

4051 i‡((
b¨gs
->
Êags
 & 
BTRFS_BALANCE_ARGS_DEVID
) &&

4052 
	`chunk_devid_fûãr
(
Àaf
, 
chunk
, 
b¨gs
)) {

4057 i‡((
b¨gs
->
Êags
 & 
BTRFS_BALANCE_ARGS_DRANGE
) &&

4058 
	`chunk_dønge_fûãr
(
Àaf
, 
chunk
, 
b¨gs
)) {

4063 i‡((
b¨gs
->
Êags
 & 
BTRFS_BALANCE_ARGS_VRANGE
) &&

4064 
	`chunk_vønge_fûãr
(
Àaf
, 
chunk
, 
chunk_off£t
, 
b¨gs
)) {

4069 i‡((
b¨gs
->
Êags
 & 
BTRFS_BALANCE_ARGS_STRIPES_RANGE
) &&

4070 
	`chunk_°rùes_ønge_fûãr
(
Àaf
, 
chunk
, 
b¨gs
)) {

4075 i‡((
b¨gs
->
Êags
 & 
BTRFS_BALANCE_ARGS_SOFT
) &&

4076 
	`chunk_so·_c⁄vît_fûãr
(
chunk_ty≥
, 
b¨gs
)) {

4083 i‡((
b¨gs
->
Êags
 & 
BTRFS_BALANCE_ARGS_LIMIT
)) {

4084 i‡(
b¨gs
->
limô
 == 0)

4087 
b¨gs
->
limô
--;

4088 } i‡((
b¨gs
->
Êags
 & 
BTRFS_BALANCE_ARGS_LIMIT_RANGE
)) {

4094 i‡(
b¨gs
->
limô_max
 == 0)

4097 
b¨gs
->
limô_max
--;

4101 
	}
}

4103 
	$__båfs_bÆ™˚
(
båfs_fs_öfo
 *
fs_öfo
)

4105 
båfs_bÆ™˚_c⁄åﬁ
 *
b˘l
 = 
fs_öfo
->
bÆ™˚_˘l
;

4106 
båfs_roŸ
 *
chunk_roŸ
 = 
fs_öfo
->chunk_root;

4107 
u64
 
chunk_ty≥
;

4108 
båfs_chunk
 *
chunk
;

4109 
båfs_∑th
 *
∑th
 = 
NULL
;

4110 
båfs_key
 
key
;

4111 
båfs_key
 
found_key
;

4112 
exã¡_buf„r
 *
Àaf
;

4113 
¶Ÿ
;

4114 
ªt
;

4115 
ío•c_îr‹s
 = 0;

4116 
boﬁ
 
cou¡ög
 = 
åue
;

4118 
u64
 
limô_d©a
 = 
b˘l
->
d©a
.
limô
;

4119 
u64
 
limô_mëa
 = 
b˘l
->
mëa
.
limô
;

4120 
u64
 
limô_sys
 = 
b˘l
->
sys
.
limô
;

4121 
u32
 
cou¡_d©a
 = 0;

4122 
u32
 
cou¡_mëa
 = 0;

4123 
u32
 
cou¡_sys
 = 0;

4124 
chunk_ª£rved
 = 0;

4126 
∑th
 = 
	`båfs_Æloc_∑th
();

4127 i‡(!
∑th
) {

4128 
ªt
 = -
ENOMEM
;

4129 
îr‹
;

4133 
	`•ö_lock
(&
fs_öfo
->
bÆ™˚_lock
);

4134 
	`mem£t
(&
b˘l
->
°©
, 0, (bctl->stat));

4135 
	`•ö_u∆ock
(&
fs_öfo
->
bÆ™˚_lock
);

4136 
agaö
:

4137 i‡(!
cou¡ög
) {

4142 
b˘l
->
d©a
.
limô
 = 
limô_d©a
;

4143 
b˘l
->
mëa
.
limô
 = 
limô_mëa
;

4144 
b˘l
->
sys
.
limô
 = 
limô_sys
;

4146 
key
.
obje˘id
 = 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
;

4147 
key
.
off£t
 = (
u64
)-1;

4148 
key
.
ty≥
 = 
BTRFS_CHUNK_ITEM_KEY
;

4151 i‡((!
cou¡ög
 && 
	`©omic_ªad
(&
fs_öfo
->
bÆ™˚_∑u£_ªq
)) ||

4152 
	`©omic_ªad
(&
fs_öfo
->
bÆ™˚_ˇn˚l_ªq
)) {

4153 
ªt
 = -
ECANCELED
;

4154 
îr‹
;

4157 
	`muãx_lock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

4158 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
chunk_roŸ
, &
key
, 
∑th
, 0, 0);

4159 i‡(
ªt
 < 0) {

4160 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

4161 
îr‹
;

4168 i‡(
ªt
 == 0)

4169 
	`BUG
();

4171 
ªt
 = 
	`båfs_¥evious_ôem
(
chunk_roŸ
, 
∑th
, 0,

4172 
BTRFS_CHUNK_ITEM_KEY
);

4173 i‡(
ªt
) {

4174 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

4175 
ªt
 = 0;

4179 
Àaf
 = 
∑th
->
nodes
[0];

4180 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

4181 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
found_key
, 
¶Ÿ
);

4183 i‡(
found_key
.
obje˘id
 !
key
.objectid) {

4184 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

4188 
chunk
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_chunk
);

4189 
chunk_ty≥
 = 
	`båfs_chunk_ty≥
(
Àaf
, 
chunk
);

4191 i‡(!
cou¡ög
) {

4192 
	`•ö_lock
(&
fs_öfo
->
bÆ™˚_lock
);

4193 
b˘l
->
°©
.
c⁄sidîed
++;

4194 
	`•ö_u∆ock
(&
fs_öfo
->
bÆ™˚_lock
);

4197 
ªt
 = 
	`should_bÆ™˚_chunk
(
Àaf
, 
chunk
, 
found_key
.
off£t
);

4199 
	`båfs_ªÀa£_∑th
(
∑th
);

4200 i‡(!
ªt
) {

4201 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

4202 
lo›
;

4205 i‡(
cou¡ög
) {

4206 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

4207 
	`•ö_lock
(&
fs_öfo
->
bÆ™˚_lock
);

4208 
b˘l
->
°©
.
ex≥˘ed
++;

4209 
	`•ö_u∆ock
(&
fs_öfo
->
bÆ™˚_lock
);

4211 i‡(
chunk_ty≥
 & 
BTRFS_BLOCK_GROUP_DATA
)

4212 
cou¡_d©a
++;

4213 i‡(
chunk_ty≥
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

4214 
cou¡_sys
++;

4215 i‡(
chunk_ty≥
 & 
BTRFS_BLOCK_GROUP_METADATA
)

4216 
cou¡_mëa
++;

4218 
lo›
;

4225 i‡(((
chunk_ty≥
 & 
BTRFS_BLOCK_GROUP_DATA
) &&

4226 
cou¡_d©a
 < 
b˘l
->
d©a
.
limô_mö
)

4227 || ((
chunk_ty≥
 & 
BTRFS_BLOCK_GROUP_METADATA
) &&

4228 
cou¡_mëa
 < 
b˘l
->
mëa
.
limô_mö
)

4229 || ((
chunk_ty≥
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) &&

4230 
cou¡_sys
 < 
b˘l
->
sys
.
limô_mö
)) {

4231 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

4232 
lo›
;

4235 i‡(!
chunk_ª£rved
) {

4242 
ªt
 = 
	`båfs_may_Æloc_d©a_chunk
(
fs_öfo
,

4243 
found_key
.
off£t
);

4244 i‡(
ªt
 < 0) {

4245 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

4246 
îr‹
;

4247 } i‡(
ªt
 == 1) {

4248 
chunk_ª£rved
 = 1;

4252 
ªt
 = 
	`båfs_ªloˇã_chunk
(
fs_öfo
, 
found_key
.
off£t
);

4253 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

4254 i‡(
ªt
 =-
ENOSPC
) {

4255 
ío•c_îr‹s
++;

4256 } i‡(
ªt
 =-
ETXTBSY
) {

4257 
	`båfs_öfo
(
fs_öfo
,

4259 
found_key
.
off£t
);

4260 
ªt
 = 0;

4261 } i‡(
ªt
) {

4262 
îr‹
;

4264 
	`•ö_lock
(&
fs_öfo
->
bÆ™˚_lock
);

4265 
b˘l
->
°©
.
com∂ëed
++;

4266 
	`•ö_u∆ock
(&
fs_öfo
->
bÆ™˚_lock
);

4268 
lo›
:

4269 i‡(
found_key
.
off£t
 == 0)

4271 
key
.
off£t
 = 
found_key
.offset - 1;

4274 i‡(
cou¡ög
) {

4275 
	`båfs_ªÀa£_∑th
(
∑th
);

4276 
cou¡ög
 = 
Ál£
;

4277 
agaö
;

4279 
îr‹
:

4280 
	`båfs_‰ì_∑th
(
∑th
);

4281 i‡(
ío•c_îr‹s
) {

4282 
	`båfs_öfo
(
fs_öfo
, "%dÉnospcÉrrors during balance",

4283 
ío•c_îr‹s
);

4284 i‡(!
ªt
)

4285 
ªt
 = -
ENOSPC
;

4288  
ªt
;

4289 
	}
}

4297 
	$Æloc_¥ofûe_is_vÆid
(
u64
 
Êags
, 
exãnded
)

4299 
u64
 
mask
 = (
exãnded
 ? 
BTRFS_EXTENDED_PROFILE_MASK
 :

4300 
BTRFS_BLOCK_GROUP_PROFILE_MASK
);

4302 
Êags
 &~
BTRFS_BLOCK_GROUP_TYPE_MASK
;

4305 i‡(
Êags
 & ~
mask
)

4309 i‡(
Êags
 == 0)

4310  !
exãnded
;

4312  
	`has_sögÀ_bô_£t
(
Êags
);

4313 
	}
}

4319 
ölöe
 
	$vÆid©e_c⁄vît_¥ofûe
(
båfs_fs_öfo
 *
fs_öfo
,

4320 c⁄° 
båfs_bÆ™˚_¨gs
 *
b¨gs
,

4321 
u64
 
Ælowed
, c⁄° *
ty≥
)

4323 i‡(!(
b¨gs
->
Êags
 & 
BTRFS_BALANCE_ARGS_CONVERT
))

4324  
åue
;

4327 i‡(
	`Æloc_¥ofûe_is_vÆid
(
b¨gs
->
èrgë
, 1) &&

4328 (
b¨gs
->
èrgë
 & ~
Ælowed
) == 0)

4329  
åue
;

4331 
	`båfs_îr
(
fs_öfo
, "balance: invalid convert %sÖrofile %s",

4332 
ty≥
, 
	`båfs_bg_ty≥_to_øid_«me
(
b¨gs
->
èrgë
));

4333  
Ál£
;

4334 
	}
}

4341 
	$des¸ibe_bÆ™˚_¨gs
(
båfs_bÆ™˚_¨gs
 *
b¨gs
, *
buf
,

4342 
u32
 
size_buf
)

4344 
ªt
;

4345 
u32
 
size_bp
 = 
size_buf
;

4346 *
bp
 = 
buf
;

4347 
u64
 
Êags
 = 
b¨gs
->flags;

4348 
tmp_buf
[128] = {'\0'};

4350 i‡(!
Êags
)

4353 
	#CHECK_APPEND_NOARG
(
a
) \

4355 
ªt
 = 
	`¢¥ötf
(
bp
, 
size_bp
, (
a
)); \

4356 i‡(
ªt
 < 0 ||Ñë >
size_bp
) \

4357 
out_ovîÊow
; \

4358 
size_bp
 -
ªt
; \

4359 
bp
 +
ªt
; \

4360 } 0)

	)

4362 
	#CHECK_APPEND_1ARG
(
a
, 
v1
) \

4364 
ªt
 = 
	`¢¥ötf
(
bp
, 
size_bp
, (
a
), (
v1
)); \

4365 i‡(
ªt
 < 0 ||Ñë >
size_bp
) \

4366 
out_ovîÊow
; \

4367 
size_bp
 -
ªt
; \

4368 
bp
 +
ªt
; \

4369 } 0)

	)

4371 
	#CHECK_APPEND_2ARG
(
a
, 
v1
, 
v2
) \

4373 
ªt
 = 
	`¢¥ötf
(
bp
, 
size_bp
, (
a
), (
v1
), (
v2
)); \

4374 i‡(
ªt
 < 0 ||Ñë >
size_bp
) \

4375 
out_ovîÊow
; \

4376 
size_bp
 -
ªt
; \

4377 
bp
 +
ªt
; \

4378 } 0)

	)

4380 i‡(
Êags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)

4381 
	`CHECK_APPEND_1ARG
("convert=%s,",

4382 
	`båfs_bg_ty≥_to_øid_«me
(
b¨gs
->
èrgë
));

4384 i‡(
Êags
 & 
BTRFS_BALANCE_ARGS_SOFT
)

4385 
	`CHECK_APPEND_NOARG
("soft,");

4387 i‡(
Êags
 & 
BTRFS_BALANCE_ARGS_PROFILES
) {

4388 
	`båfs_des¸ibe_block_groups
(
b¨gs
->
¥ofûes
, 
tmp_buf
,

4389 (
tmp_buf
));

4390 
	`CHECK_APPEND_1ARG
("¥ofûes=%s,", 
tmp_buf
);

4393 i‡(
Êags
 & 
BTRFS_BALANCE_ARGS_USAGE
)

4394 
	`CHECK_APPEND_1ARG
("ußge=%Œu,", 
b¨gs
->
ußge
);

4396 i‡(
Êags
 & 
BTRFS_BALANCE_ARGS_USAGE_RANGE
)

4397 
	`CHECK_APPEND_2ARG
("usage=%u..%u,",

4398 
b¨gs
->
ußge_mö
, b¨gs->
ußge_max
);

4400 i‡(
Êags
 & 
BTRFS_BALANCE_ARGS_DEVID
)

4401 
	`CHECK_APPEND_1ARG
("devid=%Œu,", 
b¨gs
->
devid
);

4403 i‡(
Êags
 & 
BTRFS_BALANCE_ARGS_DRANGE
)

4404 
	`CHECK_APPEND_2ARG
("drange=%llu..%llu,",

4405 
b¨gs
->
p°¨t
, b¨gs->
≥nd
);

4407 i‡(
Êags
 & 
BTRFS_BALANCE_ARGS_VRANGE
)

4408 
	`CHECK_APPEND_2ARG
("vrange=%llu..%llu,",

4409 
b¨gs
->
v°¨t
, b¨gs->
víd
);

4411 i‡(
Êags
 & 
BTRFS_BALANCE_ARGS_LIMIT
)

4412 
	`CHECK_APPEND_1ARG
("limô=%Œu,", 
b¨gs
->
limô
);

4414 i‡(
Êags
 & 
BTRFS_BALANCE_ARGS_LIMIT_RANGE
)

4415 
	`CHECK_APPEND_2ARG
("limit=%u..%u,",

4416 
b¨gs
->
limô_mö
, b¨gs->
limô_max
);

4418 i‡(
Êags
 & 
BTRFS_BALANCE_ARGS_STRIPES_RANGE
)

4419 
	`CHECK_APPEND_2ARG
("stripes=%u..%u,",

4420 
b¨gs
->
°rùes_mö
, b¨gs->
°rùes_max
);

4422 #unde‡
CHECK_APPEND_2ARG


4423 #unde‡
CHECK_APPEND_1ARG


4424 #unde‡
CHECK_APPEND_NOARG


4426 
out_ovîÊow
:

4428 i‡(
size_bp
 < 
size_buf
)

4429 
buf
[
size_buf
 - 
size_bp
 - 1] = '\0';

4431 
buf
[0] = '\0';

4432 
	}
}

4434 
	$des¸ibe_bÆ™˚_°¨t_‹_ªsume
(
båfs_fs_öfo
 *
fs_öfo
)

4436 
u32
 
size_buf
 = 1024;

4437 
tmp_buf
[192] = {'\0'};

4438 *
buf
;

4439 *
bp
;

4440 
u32
 
size_bp
 = 
size_buf
;

4441 
ªt
;

4442 
båfs_bÆ™˚_c⁄åﬁ
 *
b˘l
 = 
fs_öfo
->
bÆ™˚_˘l
;

4444 
buf
 = 
	`kzÆloc
(
size_buf
, 
GFP_KERNEL
);

4445 i‡(!
buf
)

4448 
bp
 = 
buf
;

4450 
	#CHECK_APPEND_1ARG
(
a
, 
v1
) \

4452 
ªt
 = 
	`¢¥ötf
(
bp
, 
size_bp
, (
a
), (
v1
)); \

4453 i‡(
ªt
 < 0 ||Ñë >
size_bp
) \

4454 
out_ovîÊow
; \

4455 
size_bp
 -
ªt
; \

4456 
bp
 +
ªt
; \

4457 } 0)

	)

4459 i‡(
b˘l
->
Êags
 & 
BTRFS_BALANCE_FORCE
)

4460 
	`CHECK_APPEND_1ARG
("%s", "-f ");

4462 i‡(
b˘l
->
Êags
 & 
BTRFS_BALANCE_DATA
) {

4463 
	`des¸ibe_bÆ™˚_¨gs
(&
b˘l
->
d©a
, 
tmp_buf
, (tmp_buf));

4464 
	`CHECK_APPEND_1ARG
("-d%†", 
tmp_buf
);

4467 i‡(
b˘l
->
Êags
 & 
BTRFS_BALANCE_METADATA
) {

4468 
	`des¸ibe_bÆ™˚_¨gs
(&
b˘l
->
mëa
, 
tmp_buf
, (tmp_buf));

4469 
	`CHECK_APPEND_1ARG
("-m%†", 
tmp_buf
);

4472 i‡(
b˘l
->
Êags
 & 
BTRFS_BALANCE_SYSTEM
) {

4473 
	`des¸ibe_bÆ™˚_¨gs
(&
b˘l
->
sys
, 
tmp_buf
, (tmp_buf));

4474 
	`CHECK_APPEND_1ARG
("-s%†", 
tmp_buf
);

4477 #unde‡
CHECK_APPEND_1ARG


4479 
out_ovîÊow
:

4481 i‡(
size_bp
 < 
size_buf
)

4482 
buf
[
size_buf
 - 
size_bp
 - 1] = '\0';

4483 
	`båfs_öfo
(
fs_öfo
, "balance: %s %s",

4484 (
b˘l
->
Êags
 & 
BTRFS_BALANCE_RESUME
) ?

4485 "ªsume" : "°¨t", 
buf
);

4487 
	`k‰ì
(
buf
);

4488 
	}
}

4493 
	$båfs_bÆ™˚
(
båfs_fs_öfo
 *
fs_öfo
,

4494 
båfs_bÆ™˚_c⁄åﬁ
 *
b˘l
,

4495 
båfs_io˘l_bÆ™˚_¨gs
 *
b¨gs
)

4497 
u64
 
mëa_èrgë
, 
d©a_èrgë
;

4498 
u64
 
Ælowed
;

4499 
mixed
 = 0;

4500 
ªt
;

4501 
u64
 
num_devi˚s
;

4502 
£q
;

4503 
boﬁ
 
ªducög_ªdund™cy
;

4504 
boﬁ
 
∑u£d
 = 
Ál£
;

4505 
i
;

4507 i‡(
	`båfs_fs_˛osög
(
fs_öfo
) ||

4508 
	`©omic_ªad
(&
fs_öfo
->
bÆ™˚_∑u£_ªq
) ||

4509 
	`båfs_should_ˇn˚l_bÆ™˚
(
fs_öfo
)) {

4510 
ªt
 = -
EINVAL
;

4511 
out
;

4514 
Ælowed
 = 
	`båfs_su≥r_öcom∑t_Êags
(
fs_öfo
->
su≥r_c›y
);

4515 i‡(
Ælowed
 & 
BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
)

4516 
mixed
 = 1;

4522 
Ælowed
 = 
BTRFS_BALANCE_DATA
 | 
BTRFS_BALANCE_METADATA
;

4523 i‡(
mixed
 && (
b˘l
->
Êags
 & 
Ælowed
)) {

4524 i‡(!(
b˘l
->
Êags
 & 
BTRFS_BALANCE_DATA
) ||

4525 !(
b˘l
->
Êags
 & 
BTRFS_BALANCE_METADATA
) ||

4526 
	`memcmp
(&
b˘l
->
d©a
, &b˘l->
mëa
, (bctl->data))) {

4527 
	`båfs_îr
(
fs_öfo
,

4529 
ªt
 = -
EINVAL
;

4530 
out
;

4538 
num_devi˚s
 = 
fs_öfo
->
fs_devi˚s
->
rw_devi˚s
;

4545 
Ælowed
 = 
BTRFS_AVAIL_ALLOC_BIT_SINGLE
;

4546 
i
 = 0; i < 
	`ARRAY_SIZE
(
båfs_øid_¨øy
); i++)

4547 i‡(
num_devi˚s
 >
båfs_øid_¨øy
[
i
].
devs_mö
)

4548 
Ælowed
 |
båfs_øid_¨øy
[
i
].
bg_Êag
;

4550 i‡(!
	`vÆid©e_c⁄vît_¥ofûe
(
fs_öfo
, &
b˘l
->
d©a
, 
Ælowed
, "data") ||

4551 !
	`vÆid©e_c⁄vît_¥ofûe
(
fs_öfo
, &
b˘l
->
mëa
, 
Ælowed
, "metadata") ||

4552 !
	`vÆid©e_c⁄vît_¥ofûe
(
fs_öfo
, &
b˘l
->
sys
, 
Ælowed
, "system")) {

4553 
ªt
 = -
EINVAL
;

4554 
out
;

4561 
Ælowed
 = 0;

4562 
i
 = 0; i < 
	`ARRAY_SIZE
(
båfs_øid_¨øy
); i++) {

4563 i‡(
båfs_øid_¨øy
[
i
].
nc›õs
 >= 2 ||

4564 
båfs_øid_¨øy
[
i
].
tﬁî©ed_Áûuªs
 >= 1)

4565 
Ælowed
 |
båfs_øid_¨øy
[
i
].
bg_Êag
;

4568 
£q
 = 
	`ªad_£qbegö
(&
fs_öfo
->
¥ofûes_lock
);

4570 i‡(((
b˘l
->
sys
.
Êags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) &&

4571 (
fs_öfo
->
avaû_sy°em_Æloc_bôs
 & 
Ælowed
) &&

4572 !(
b˘l
->
sys
.
èrgë
 & 
Ælowed
)) ||

4573 ((
b˘l
->
mëa
.
Êags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) &&

4574 (
fs_öfo
->
avaû_mëad©a_Æloc_bôs
 & 
Ælowed
) &&

4575 !(
b˘l
->
mëa
.
èrgë
 & 
Ælowed
)))

4576 
ªducög_ªdund™cy
 = 
åue
;

4578 
ªducög_ªdund™cy
 = 
Ál£
;

4581 
mëa_èrgë
 = (
b˘l
->
mëa
.
Êags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) ?

4582 
b˘l
->
mëa
.
èrgë
 : 
fs_öfo
->
avaû_mëad©a_Æloc_bôs
;

4583 
d©a_èrgë
 = (
b˘l
->
d©a
.
Êags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) ?

4584 
b˘l
->
d©a
.
èrgë
 : 
fs_öfo
->
avaû_d©a_Æloc_bôs
;

4585 } 
	`ªad_£qªåy
(&
fs_öfo
->
¥ofûes_lock
, 
£q
));

4587 i‡(
ªducög_ªdund™cy
) {

4588 i‡(
b˘l
->
Êags
 & 
BTRFS_BALANCE_FORCE
) {

4589 
	`båfs_öfo
(
fs_öfo
,

4592 
	`båfs_îr
(
fs_öfo
,

4594 
ªt
 = -
EINVAL
;

4595 
out
;

4599 i‡(
	`båfs_gë_num_tﬁî©ed_disk_b¨rõr_Áûuªs
(
mëa_èrgë
) <

4600 
	`båfs_gë_num_tﬁî©ed_disk_b¨rõr_Áûuªs
(
d©a_èrgë
)) {

4601 
	`båfs_w¨n
(
fs_öfo
,

4603 
	`båfs_bg_ty≥_to_øid_«me
(
mëa_èrgë
),

4604 
	`båfs_bg_ty≥_to_øid_«me
(
d©a_èrgë
));

4607 
ªt
 = 
	`ö£π_bÆ™˚_ôem
(
fs_öfo
, 
b˘l
);

4608 i‡(
ªt
 &&Ñë !-
EEXIST
)

4609 
out
;

4611 i‡(!(
b˘l
->
Êags
 & 
BTRFS_BALANCE_RESUME
)) {

4612 
	`BUG_ON
(
ªt
 =-
EEXIST
);

4613 
	`BUG_ON
(
fs_öfo
->
bÆ™˚_˘l
);

4614 
	`•ö_lock
(&
fs_öfo
->
bÆ™˚_lock
);

4615 
fs_öfo
->
bÆ™˚_˘l
 = 
b˘l
;

4616 
	`•ö_u∆ock
(&
fs_öfo
->
bÆ™˚_lock
);

4618 
	`BUG_ON
(
ªt
 !-
EEXIST
);

4619 
	`•ö_lock
(&
fs_öfo
->
bÆ™˚_lock
);

4620 
	`upd©e_bÆ™˚_¨gs
(
b˘l
);

4621 
	`•ö_u∆ock
(&
fs_öfo
->
bÆ™˚_lock
);

4624 
	`ASSERT
(!
	`ã°_bô
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_öfo
->
Êags
));

4625 
	`£t_bô
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_öfo
->
Êags
);

4626 
	`des¸ibe_bÆ™˚_°¨t_‹_ªsume
(
fs_öfo
);

4627 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

4629 
ªt
 = 
	`__båfs_bÆ™˚
(
fs_öfo
);

4631 
	`muãx_lock
(&
fs_öfo
->
bÆ™˚_muãx
);

4632 i‡(
ªt
 =-
ECANCELED
 && 
	`©omic_ªad
(&
fs_öfo
->
bÆ™˚_∑u£_ªq
)) {

4633 
	`båfs_öfo
(
fs_öfo
, "balance:Öaused");

4634 
	`båfs_ex˛›_bÆ™˚
(
fs_öfo
, 
BTRFS_EXCLOP_BALANCE_PAUSED
);

4635 
∑u£d
 = 
åue
;

4652 i‡(
ªt
 =-
ECANCELED
 ||Ñë =-
EINTR
)

4653 
	`båfs_öfo
(
fs_öfo
, "balance: canceled");

4655 
	`båfs_öfo
(
fs_öfo
, "bÆ™˚:Énded wôh sètus: %d", 
ªt
);

4657 
	`˛ór_bô
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_öfo
->
Êags
);

4659 i‡(
b¨gs
) {

4660 
	`mem£t
(
b¨gs
, 0, (*bargs));

4661 
	`båfs_upd©e_io˘l_bÆ™˚_¨gs
(
fs_öfo
, 
b¨gs
);

4665 i‡(!
∑u£d
) {

4666 
	`ª£t_bÆ™˚_°©e
(
fs_öfo
);

4667 
	`båfs_ex˛›_föish
(
fs_öfo
);

4670 
	`wake_up
(&
fs_öfo
->
bÆ™˚_waô_q
);

4672  
ªt
;

4673 
out
:

4674 i‡(
b˘l
->
Êags
 & 
BTRFS_BALANCE_RESUME
)

4675 
	`ª£t_bÆ™˚_°©e
(
fs_öfo
);

4677 
	`k‰ì
(
b˘l
);

4678 
	`båfs_ex˛›_föish
(
fs_öfo
);

4680  
ªt
;

4681 
	}
}

4683 
	$bÆ™˚_kthªad
(*
d©a
)

4685 
båfs_fs_öfo
 *
fs_öfo
 = 
d©a
;

4686 
ªt
 = 0;

4688 
	`sb_°¨t_wrôe
(
fs_öfo
->
sb
);

4689 
	`muãx_lock
(&
fs_öfo
->
bÆ™˚_muãx
);

4690 i‡(
fs_öfo
->
bÆ™˚_˘l
)

4691 
ªt
 = 
	`båfs_bÆ™˚
(
fs_öfo
, fs_öfo->
bÆ™˚_˘l
, 
NULL
);

4692 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

4693 
	`sb_íd_wrôe
(
fs_öfo
->
sb
);

4695  
ªt
;

4696 
	}
}

4698 
	$båfs_ªsume_bÆ™˚_async
(
båfs_fs_öfo
 *
fs_öfo
)

4700 
èsk_°ru˘
 *
tsk
;

4702 
	`muãx_lock
(&
fs_öfo
->
bÆ™˚_muãx
);

4703 i‡(!
fs_öfo
->
bÆ™˚_˘l
) {

4704 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

4707 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

4709 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
SKIP_BALANCE
)) {

4710 
	`båfs_öfo
(
fs_öfo
, "balance:Ñesume skipped");

4714 
	`•ö_lock
(&
fs_öfo
->
su≥r_lock
);

4715 
	`ASSERT
(
fs_öfo
->
ex˛usive_›î©i⁄
 =
BTRFS_EXCLOP_BALANCE_PAUSED
);

4716 
fs_öfo
->
ex˛usive_›î©i⁄
 = 
BTRFS_EXCLOP_BALANCE
;

4717 
	`•ö_u∆ock
(&
fs_öfo
->
su≥r_lock
);

4723 
	`•ö_lock
(&
fs_öfo
->
bÆ™˚_lock
);

4724 
fs_öfo
->
bÆ™˚_˘l
->
Êags
 |
BTRFS_BALANCE_RESUME
;

4725 
	`•ö_u∆ock
(&
fs_öfo
->
bÆ™˚_lock
);

4727 
tsk
 = 
	`kthªad_run
(
bÆ™˚_kthªad
, 
fs_öfo
, "btrfs-balance");

4728  
	`PTR_ERR_OR_ZERO
(
tsk
);

4729 
	}
}

4731 
	$båfs_ªcovî_bÆ™˚
(
båfs_fs_öfo
 *
fs_öfo
)

4733 
båfs_bÆ™˚_c⁄åﬁ
 *
b˘l
;

4734 
båfs_bÆ™˚_ôem
 *
ôem
;

4735 
båfs_disk_bÆ™˚_¨gs
 
disk_b¨gs
;

4736 
båfs_∑th
 *
∑th
;

4737 
exã¡_buf„r
 *
Àaf
;

4738 
båfs_key
 
key
;

4739 
ªt
;

4741 
∑th
 = 
	`båfs_Æloc_∑th
();

4742 i‡(!
∑th
)

4743  -
ENOMEM
;

4745 
key
.
obje˘id
 = 
BTRFS_BALANCE_OBJECTID
;

4746 
key
.
ty≥
 = 
BTRFS_TEMPORARY_ITEM_KEY
;

4747 
key
.
off£t
 = 0;

4749 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
fs_öfo
->
åì_roŸ
, &
key
, 
∑th
, 0, 0);

4750 i‡(
ªt
 < 0)

4751 
out
;

4752 i‡(
ªt
 > 0) {

4753 
ªt
 = 0;

4754 
out
;

4757 
b˘l
 = 
	`kzÆloc
((*b˘l), 
GFP_NOFS
);

4758 i‡(!
b˘l
) {

4759 
ªt
 = -
ENOMEM
;

4760 
out
;

4763 
Àaf
 = 
∑th
->
nodes
[0];

4764 
ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_bÆ™˚_ôem
);

4766 
b˘l
->
Êags
 = 
	`båfs_bÆ™˚_Êags
(
Àaf
, 
ôem
);

4767 
b˘l
->
Êags
 |
BTRFS_BALANCE_RESUME
;

4769 
	`båfs_bÆ™˚_d©a
(
Àaf
, 
ôem
, &
disk_b¨gs
);

4770 
	`båfs_disk_bÆ™˚_¨gs_to_˝u
(&
b˘l
->
d©a
, &
disk_b¨gs
);

4771 
	`båfs_bÆ™˚_mëa
(
Àaf
, 
ôem
, &
disk_b¨gs
);

4772 
	`båfs_disk_bÆ™˚_¨gs_to_˝u
(&
b˘l
->
mëa
, &
disk_b¨gs
);

4773 
	`båfs_bÆ™˚_sys
(
Àaf
, 
ôem
, &
disk_b¨gs
);

4774 
	`båfs_disk_bÆ™˚_¨gs_to_˝u
(&
b˘l
->
sys
, &
disk_b¨gs
);

4786 i‡(!
	`båfs_ex˛›_°¨t
(
fs_öfo
, 
BTRFS_EXCLOP_BALANCE_PAUSED
))

4787 
	`båfs_w¨n
(
fs_öfo
,

4790 
	`båfs_ªÀa£_∑th
(
∑th
);

4792 
	`muãx_lock
(&
fs_öfo
->
bÆ™˚_muãx
);

4793 
	`BUG_ON
(
fs_öfo
->
bÆ™˚_˘l
);

4794 
	`•ö_lock
(&
fs_öfo
->
bÆ™˚_lock
);

4795 
fs_öfo
->
bÆ™˚_˘l
 = 
b˘l
;

4796 
	`•ö_u∆ock
(&
fs_öfo
->
bÆ™˚_lock
);

4797 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

4798 
out
:

4799 
	`båfs_‰ì_∑th
(
∑th
);

4800  
ªt
;

4801 
	}
}

4803 
	$båfs_∑u£_bÆ™˚
(
båfs_fs_öfo
 *
fs_öfo
)

4805 
ªt
 = 0;

4807 
	`muãx_lock
(&
fs_öfo
->
bÆ™˚_muãx
);

4808 i‡(!
fs_öfo
->
bÆ™˚_˘l
) {

4809 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

4810  -
ENOTCONN
;

4813 i‡(
	`ã°_bô
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_öfo
->
Êags
)) {

4814 
	`©omic_öc
(&
fs_öfo
->
bÆ™˚_∑u£_ªq
);

4815 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

4817 
	`waô_evít
(
fs_öfo
->
bÆ™˚_waô_q
,

4818 !
	`ã°_bô
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_öfo
->
Êags
));

4820 
	`muãx_lock
(&
fs_öfo
->
bÆ™˚_muãx
);

4822 
	`BUG_ON
(
	`ã°_bô
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_öfo
->
Êags
));

4823 
	`©omic_dec
(&
fs_öfo
->
bÆ™˚_∑u£_ªq
);

4825 
ªt
 = -
ENOTCONN
;

4828 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

4829  
ªt
;

4830 
	}
}

4832 
	$båfs_ˇn˚l_bÆ™˚
(
båfs_fs_öfo
 *
fs_öfo
)

4834 
	`muãx_lock
(&
fs_öfo
->
bÆ™˚_muãx
);

4835 i‡(!
fs_öfo
->
bÆ™˚_˘l
) {

4836 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

4837  -
ENOTCONN
;

4845 i‡(
	`sb_rd⁄ly
(
fs_öfo
->
sb
)) {

4846 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

4847  -
EROFS
;

4850 
	`©omic_öc
(&
fs_öfo
->
bÆ™˚_ˇn˚l_ªq
);

4855 i‡(
	`ã°_bô
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_öfo
->
Êags
)) {

4856 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

4857 
	`waô_evít
(
fs_öfo
->
bÆ™˚_waô_q
,

4858 !
	`ã°_bô
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_öfo
->
Êags
));

4859 
	`muãx_lock
(&
fs_öfo
->
bÆ™˚_muãx
);

4861 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

4866 
	`muãx_lock
(&
fs_öfo
->
bÆ™˚_muãx
);

4868 i‡(
fs_öfo
->
bÆ™˚_˘l
) {

4869 
	`ª£t_bÆ™˚_°©e
(
fs_öfo
);

4870 
	`båfs_ex˛›_föish
(
fs_öfo
);

4871 
	`båfs_öfo
(
fs_öfo
, "balance: canceled");

4875 
	`ASSERT
(!
	`ã°_bô
(
BTRFS_FS_BALANCE_RUNNING
, &
fs_öfo
->
Êags
));

4876 
	`©omic_dec
(&
fs_öfo
->
bÆ™˚_ˇn˚l_ªq
);

4877 
	`muãx_u∆ock
(&
fs_öfo
->
bÆ™˚_muãx
);

4879 
	}
}

4881 
	$båfs_uuid_sˇn_kthªad
(*
d©a
)

4883 
båfs_fs_öfo
 *
fs_öfo
 = 
d©a
;

4884 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
åì_roŸ
;

4885 
båfs_key
 
key
;

4886 
båfs_∑th
 *
∑th
 = 
NULL
;

4887 
ªt
 = 0;

4888 
exã¡_buf„r
 *
eb
;

4889 
¶Ÿ
;

4890 
båfs_roŸ_ôem
 
roŸ_ôem
;

4891 
u32
 
ôem_size
;

4892 
båfs_å™s_h™dÀ
 *
å™s
 = 
NULL
;

4893 
boﬁ
 
˛osög
 = 
Ál£
;

4895 
∑th
 = 
	`båfs_Æloc_∑th
();

4896 i‡(!
∑th
) {

4897 
ªt
 = -
ENOMEM
;

4898 
out
;

4901 
key
.
obje˘id
 = 0;

4902 
key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

4903 
key
.
off£t
 = 0;

4906 i‡(
	`båfs_fs_˛osög
(
fs_öfo
)) {

4907 
˛osög
 = 
åue
;

4910 
ªt
 = 
	`båfs_£¨ch_f‹w¨d
(
roŸ
, &
key
, 
∑th
,

4911 
BTRFS_OLDEST_GENERATION
);

4912 i‡(
ªt
) {

4913 i‡(
ªt
 > 0)

4914 
ªt
 = 0;

4918 i‡(
key
.
ty≥
 !
BTRFS_ROOT_ITEM_KEY
 ||

4919 (
key
.
obje˘id
 < 
BTRFS_FIRST_FREE_OBJECTID
 &&

4920 
key
.
obje˘id
 !
BTRFS_FS_TREE_OBJECTID
) ||

4921 
key
.
obje˘id
 > 
BTRFS_LAST_FREE_OBJECTID
)

4922 
skù
;

4924 
eb
 = 
∑th
->
nodes
[0];

4925 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

4926 
ôem_size
 = 
	`båfs_ôem_size
(
eb
, 
¶Ÿ
);

4927 i‡(
ôem_size
 < (
roŸ_ôem
))

4928 
skù
;

4930 
	`ªad_exã¡_buf„r
(
eb
, &
roŸ_ôem
,

4931 
	`båfs_ôem_±r_off£t
(
eb
, 
¶Ÿ
),

4932 ()(
roŸ_ôem
));

4933 i‡(
	`båfs_roŸ_ªfs
(&
roŸ_ôem
) == 0)

4934 
skù
;

4936 i‡(!
	`båfs_is_em±y_uuid
(
roŸ_ôem
.
uuid
) ||

4937 !
	`båfs_is_em±y_uuid
(
roŸ_ôem
.
ª˚ived_uuid
)) {

4938 i‡(
å™s
)

4939 
upd©e_åì
;

4941 
	`båfs_ªÀa£_∑th
(
∑th
);

4946 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
fs_öfo
->
uuid_roŸ
, 2);

4947 i‡(
	`IS_ERR
(
å™s
)) {

4948 
ªt
 = 
	`PTR_ERR
(
å™s
);

4953 
skù
;

4955 
upd©e_åì
:

4956 
	`båfs_ªÀa£_∑th
(
∑th
);

4957 i‡(!
	`båfs_is_em±y_uuid
(
roŸ_ôem
.
uuid
)) {

4958 
ªt
 = 
	`båfs_uuid_åì_add
(
å™s
, 
roŸ_ôem
.
uuid
,

4959 
BTRFS_UUID_KEY_SUBVOL
,

4960 
key
.
obje˘id
);

4961 i‡(
ªt
 < 0) {

4962 
	`båfs_w¨n
(
fs_öfo
, "uuid_tree_add failed %d",

4963 
ªt
);

4968 i‡(!
	`båfs_is_em±y_uuid
(
roŸ_ôem
.
ª˚ived_uuid
)) {

4969 
ªt
 = 
	`båfs_uuid_åì_add
(
å™s
,

4970 
roŸ_ôem
.
ª˚ived_uuid
,

4971 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
,

4972 
key
.
obje˘id
);

4973 i‡(
ªt
 < 0) {

4974 
	`båfs_w¨n
(
fs_öfo
, "uuid_tree_add failed %d",

4975 
ªt
);

4980 
skù
:

4981 
	`båfs_ªÀa£_∑th
(
∑th
);

4982 i‡(
å™s
) {

4983 
ªt
 = 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

4984 
å™s
 = 
NULL
;

4985 i‡(
ªt
)

4989 i‡(
key
.
off£t
 < (
u64
)-1) {

4990 
key
.
off£t
++;

4991 } i‡(
key
.
ty≥
 < 
BTRFS_ROOT_ITEM_KEY
) {

4992 
key
.
off£t
 = 0;

4993 
key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

4994 } i‡(
key
.
obje˘id
 < (
u64
)-1) {

4995 
key
.
off£t
 = 0;

4996 
key
.
ty≥
 = 
BTRFS_ROOT_ITEM_KEY
;

4997 
key
.
obje˘id
++;

5001 
	`c⁄d_ªsched
();

5004 
out
:

5005 
	`båfs_‰ì_∑th
(
∑th
);

5006 i‡(
å™s
 && !
	`IS_ERR
(trans))

5007 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

5008 i‡(
ªt
)

5009 
	`båfs_w¨n
(
fs_öfo
, "båfs_uuid_sˇn_kthªad faûed %d", 
ªt
);

5010 i‡(!
˛osög
)

5011 
	`£t_bô
(
BTRFS_FS_UPDATE_UUID_TREE_GEN
, &
fs_öfo
->
Êags
);

5012 
	`up
(&
fs_öfo
->
uuid_åì_ªsˇn_£m
);

5014 
	}
}

5016 
	$båfs_¸óã_uuid_åì
(
båfs_fs_öfo
 *
fs_öfo
)

5018 
båfs_å™s_h™dÀ
 *
å™s
;

5019 
båfs_roŸ
 *
åì_roŸ
 = 
fs_öfo
->tree_root;

5020 
båfs_roŸ
 *
uuid_roŸ
;

5021 
èsk_°ru˘
 *
èsk
;

5022 
ªt
;

5028 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
åì_roŸ
, 2);

5029 i‡(
	`IS_ERR
(
å™s
))

5030  
	`PTR_ERR
(
å™s
);

5032 
uuid_roŸ
 = 
	`båfs_¸óã_åì
(
å™s
, 
BTRFS_UUID_TREE_OBJECTID
);

5033 i‡(
	`IS_ERR
(
uuid_roŸ
)) {

5034 
ªt
 = 
	`PTR_ERR
(
uuid_roŸ
);

5035 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

5036 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

5037  
ªt
;

5040 
fs_öfo
->
uuid_roŸ
 = uuid_root;

5042 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

5043 i‡(
ªt
)

5044  
ªt
;

5046 
	`down
(&
fs_öfo
->
uuid_åì_ªsˇn_£m
);

5047 
èsk
 = 
	`kthªad_run
(
båfs_uuid_sˇn_kthªad
, 
fs_öfo
, "btrfs-uuid");

5048 i‡(
	`IS_ERR
(
èsk
)) {

5050 
	`båfs_w¨n
(
fs_öfo
, "failedÅo start uuid_scanÅask");

5051 
	`up
(&
fs_öfo
->
uuid_åì_ªsˇn_£m
);

5052  
	`PTR_ERR
(
èsk
);

5056 
	}
}

5063 
	$båfs_shrök_devi˚
(
båfs_devi˚
 *
devi˚
, 
u64
 
√w_size
)

5065 
båfs_fs_öfo
 *
fs_öfo
 = 
devi˚
->fs_info;

5066 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
dev_roŸ
;

5067 
båfs_å™s_h™dÀ
 *
å™s
;

5068 
båfs_dev_exã¡
 *
dev_exã¡
 = 
NULL
;

5069 
båfs_∑th
 *
∑th
;

5070 
u64
 
Àngth
;

5071 
u64
 
chunk_off£t
;

5072 
ªt
;

5073 
¶Ÿ
;

5074 
Áûed
 = 0;

5075 
boﬁ
 
ªåõd
 = 
Ál£
;

5076 
exã¡_buf„r
 *
l
;

5077 
båfs_key
 
key
;

5078 
båfs_su≥r_block
 *
su≥r_c›y
 = 
fs_öfo
->super_copy;

5079 
u64
 
ﬁd_tŸÆ
 = 
	`båfs_su≥r_tŸÆ_byãs
(
su≥r_c›y
);

5080 
u64
 
ﬁd_size
 = 
	`båfs_devi˚_gë_tŸÆ_byãs
(
devi˚
);

5081 
u64
 
diff
;

5082 
u64
 
°¨t
;

5084 
√w_size
 = 
	`round_down
“ew_size, 
fs_öfo
->
£˘‹size
);

5085 
°¨t
 = 
√w_size
;

5086 
diff
 = 
	`round_down
(
ﬁd_size
 - 
√w_size
, 
fs_öfo
->
£˘‹size
);

5088 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
))

5089  -
EINVAL
;

5091 
∑th
 = 
	`båfs_Æloc_∑th
();

5092 i‡(!
∑th
)

5093  -
ENOMEM
;

5095 
∑th
->
ªada
 = 
READA_BACK
;

5097 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

5098 i‡(
	`IS_ERR
(
å™s
)) {

5099 
	`båfs_‰ì_∑th
(
∑th
);

5100  
	`PTR_ERR
(
å™s
);

5103 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

5105 
	`båfs_devi˚_£t_tŸÆ_byãs
(
devi˚
, 
√w_size
);

5106 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
)) {

5107 
devi˚
->
fs_devi˚s
->
tŸÆ_rw_byãs
 -
diff
;

5108 
	`©omic64_sub
(
diff
, &
fs_öfo
->
‰ì_chunk_•a˚
);

5116 i‡(
	`c⁄èös_≥ndög_exã¡
(
devi˚
, &
°¨t
, 
diff
)) {

5117 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

5118 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

5119 i‡(
ªt
)

5120 
d⁄e
;

5122 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

5123 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

5126 
agaö
:

5127 
key
.
obje˘id
 = 
devi˚
->
devid
;

5128 
key
.
off£t
 = (
u64
)-1;

5129 
key
.
ty≥
 = 
BTRFS_DEV_EXTENT_KEY
;

5132 
	`muãx_lock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

5133 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

5134 i‡(
ªt
 < 0) {

5135 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

5136 
d⁄e
;

5139 
ªt
 = 
	`båfs_¥evious_ôem
(
roŸ
, 
∑th
, 0, 
key
.
ty≥
);

5140 i‡(
ªt
) {

5141 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

5142 i‡(
ªt
 < 0)

5143 
d⁄e
;

5144 
ªt
 = 0;

5145 
	`båfs_ªÀa£_∑th
(
∑th
);

5149 
l
 = 
∑th
->
nodes
[0];

5150 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

5151 
	`båfs_ôem_key_to_˝u
(
l
, &
key
, 
∑th
->
¶Ÿs
[0]);

5153 i‡(
key
.
obje˘id
 !
devi˚
->
devid
) {

5154 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

5155 
	`båfs_ªÀa£_∑th
(
∑th
);

5159 
dev_exã¡
 = 
	`båfs_ôem_±r
(
l
, 
¶Ÿ
, 
båfs_dev_exã¡
);

5160 
Àngth
 = 
	`båfs_dev_exã¡_Àngth
(
l
, 
dev_exã¡
);

5162 i‡(
key
.
off£t
 + 
Àngth
 <
√w_size
) {

5163 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

5164 
	`båfs_ªÀa£_∑th
(
∑th
);

5168 
chunk_off£t
 = 
	`båfs_dev_exã¡_chunk_off£t
(
l
, 
dev_exã¡
);

5169 
	`båfs_ªÀa£_∑th
(
∑th
);

5177 
ªt
 = 
	`båfs_may_Æloc_d©a_chunk
(
fs_öfo
, 
chunk_off£t
);

5178 i‡(
ªt
 < 0) {

5179 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

5180 
d⁄e
;

5183 
ªt
 = 
	`båfs_ªloˇã_chunk
(
fs_öfo
, 
chunk_off£t
);

5184 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

5185 i‡(
ªt
 =-
ENOSPC
) {

5186 
Áûed
++;

5187 } i‡(
ªt
) {

5188 i‡(
ªt
 =-
ETXTBSY
) {

5189 
	`båfs_w¨n
(
fs_öfo
,

5191 
chunk_off£t
);

5193 
d⁄e
;

5195 } 
key
.
off£t
-- > 0);

5197 i‡(
Áûed
 && !
ªåõd
) {

5198 
Áûed
 = 0;

5199 
ªåõd
 = 
åue
;

5200 
agaö
;

5201 } i‡(
Áûed
 && 
ªåõd
) {

5202 
ªt
 = -
ENOSPC
;

5203 
d⁄e
;

5207 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 0);

5208 i‡(
	`IS_ERR
(
å™s
)) {

5209 
ªt
 = 
	`PTR_ERR
(
å™s
);

5210 
d⁄e
;

5213 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

5215 
	`˛ór_exã¡_bôs
(&
devi˚
->
Æloc_°©e
, 
√w_size
, (
u64
)-1,

5216 
CHUNK_STATE_MASK
);

5218 
	`båfs_devi˚_£t_disk_tŸÆ_byãs
(
devi˚
, 
√w_size
);

5219 i‡(
	`li°_em±y
(&
devi˚
->
po°_commô_li°
))

5220 
	`li°_add_èû
(&
devi˚
->
po°_commô_li°
,

5221 &
å™s
->
å™ß˘i⁄
->
dev_upd©e_li°
);

5223 
	`WARN_ON
(
diff
 > 
ﬁd_tŸÆ
);

5224 
	`båfs_£t_su≥r_tŸÆ_byãs
(
su≥r_c›y
,

5225 
	`round_down
(
ﬁd_tŸÆ
 - 
diff
, 
fs_öfo
->
£˘‹size
));

5226 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

5228 
	`båfs_ª£rve_chunk_mëad©a
(
å™s
, 
Ál£
);

5230 
ªt
 = 
	`båfs_upd©e_devi˚
(
å™s
, 
devi˚
);

5231 
	`båfs_å™s_ªÀa£_chunk_mëad©a
(
å™s
);

5232 i‡(
ªt
 < 0) {

5233 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

5234 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

5236 
ªt
 = 
	`båfs_commô_å™ß˘i⁄
(
å™s
);

5238 
d⁄e
:

5239 
	`båfs_‰ì_∑th
(
∑th
);

5240 i‡(
ªt
) {

5241 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

5242 
	`båfs_devi˚_£t_tŸÆ_byãs
(
devi˚
, 
ﬁd_size
);

5243 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
))

5244 
devi˚
->
fs_devi˚s
->
tŸÆ_rw_byãs
 +
diff
;

5245 
	`©omic64_add
(
diff
, &
fs_öfo
->
‰ì_chunk_•a˚
);

5246 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

5248  
ªt
;

5249 
	}
}

5251 
	$båfs_add_sy°em_chunk
(
båfs_fs_öfo
 *
fs_öfo
,

5252 
båfs_key
 *
key
,

5253 
båfs_chunk
 *
chunk
, 
ôem_size
)

5255 
båfs_su≥r_block
 *
su≥r_c›y
 = 
fs_öfo
->super_copy;

5256 
båfs_disk_key
 
disk_key
;

5257 
u32
 
¨øy_size
;

5258 
u8
 *
±r
;

5260 
	`lockdï_as£π_hñd
(&
fs_öfo
->
chunk_muãx
);

5262 
¨øy_size
 = 
	`båfs_su≥r_sys_¨øy_size
(
su≥r_c›y
);

5263 i‡(
¨øy_size
 + 
ôem_size
 + (
disk_key
)

5264 > 
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
)

5265  -
EFBIG
;

5267 
±r
 = 
su≥r_c›y
->
sys_chunk_¨øy
 + 
¨øy_size
;

5268 
	`båfs_˝u_key_to_disk
(&
disk_key
, 
key
);

5269 
	`mem˝y
(
±r
, &
disk_key
, (disk_key));

5270 
±r
 +(
disk_key
);

5271 
	`mem˝y
(
±r
, 
chunk
, 
ôem_size
);

5272 
ôem_size
 +(
disk_key
);

5273 
	`båfs_£t_su≥r_sys_¨øy_size
(
su≥r_c›y
, 
¨øy_size
 + 
ôem_size
);

5276 
	}
}

5281 
	$båfs_cmp_devi˚_öfo
(c⁄° *
a
, c⁄° *
b
)

5283 c⁄° 
båfs_devi˚_öfo
 *
di_a
 = 
a
;

5284 c⁄° 
båfs_devi˚_öfo
 *
di_b
 = 
b
;

5286 i‡(
di_a
->
max_avaû
 > 
di_b
->max_avail)

5288 i‡(
di_a
->
max_avaû
 < 
di_b
->max_avail)

5290 i‡(
di_a
->
tŸÆ_avaû
 > 
di_b
->total_avail)

5292 i‡(
di_a
->
tŸÆ_avaû
 < 
di_b
->total_avail)

5295 
	}
}

5297 
	$check_øid56_öcom∑t_Êag
(
båfs_fs_öfo
 *
öfo
, 
u64
 
ty≥
)

5299 i‡(!(
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
))

5302 
	`båfs_£t_fs_öcom∑t
(
öfo
, 
RAID56
);

5303 
	}
}

5305 
	$check_øid1c34_öcom∑t_Êag
(
båfs_fs_öfo
 *
öfo
, 
u64
 
ty≥
)

5307 i‡(!(
ty≥
 & (
BTRFS_BLOCK_GROUP_RAID1C3
 | 
BTRFS_BLOCK_GROUP_RAID1C4
)))

5310 
	`båfs_£t_fs_öcom∑t
(
öfo
, 
RAID1C34
);

5311 
	}
}

5317 
	sÆloc_chunk_˘l
 {

5318 
u64
 
	m°¨t
;

5319 
u64
 
	mty≥
;

5321 
	mnum_°rùes
;

5323 
	msub_°rùes
;

5325 
	mdev_°rùes
;

5327 
	mdevs_max
;

5329 
	mdevs_mö
;

5331 
	mdevs_ö¸emít
;

5333 
	mnc›õs
;

5335 
	m≈¨ôy
;

5336 
u64
 
	mmax_°rùe_size
;

5337 
u64
 
	mmax_chunk_size
;

5338 
u64
 
	mdev_exã¡_mö
;

5339 
u64
 
	m°rùe_size
;

5340 
u64
 
	mchunk_size
;

5341 
	mndevs
;

5344 
	$öô_Æloc_chunk_˘l_pﬁicy_ªguœr
(

5345 
båfs_fs_devi˚s
 *
fs_devi˚s
,

5346 
Æloc_chunk_˘l
 *
˘l
)

5348 
båfs_•a˚_öfo
 *
•a˚_öfo
;

5350 
•a˚_öfo
 = 
	`båfs_föd_•a˚_öfo
(
fs_devi˚s
->
fs_öfo
, 
˘l
->
ty≥
);

5351 
	`ASSERT
(
•a˚_öfo
);

5353 
˘l
->
max_chunk_size
 = 
	`READ_ONCE
(
•a˚_öfo
->
chunk_size
);

5354 
˘l
->
max_°rùe_size
 = 
	`mö_t
(
u64
, cé->
max_chunk_size
, 
SZ_1G
);

5356 i‡(
˘l
->
ty≥
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

5357 
˘l
->
devs_max
 = 
	`mö_t
(, cé->devs_max, 
BTRFS_MAX_DEVS_SYS_CHUNK
);

5360 
˘l
->
max_chunk_size
 = 
	`mö
(
	`mu…_≥rc
(
fs_devi˚s
->
tŸÆ_rw_byãs
, 10),

5361 
˘l
->
max_chunk_size
);

5362 
˘l
->
dev_exã¡_mö
 = 
	`båfs_°rùe_ƒ_to_off£t
(˘l->
dev_°rùes
);

5363 
	}
}

5365 
	$öô_Æloc_chunk_˘l_pﬁicy_z⁄ed
(

5366 
båfs_fs_devi˚s
 *
fs_devi˚s
,

5367 
Æloc_chunk_˘l
 *
˘l
)

5369 
u64
 
z⁄e_size
 = 
fs_devi˚s
->
fs_öfo
->zone_size;

5370 
u64
 
limô
;

5371 
mö_num_°rùes
 = 
˘l
->
devs_mö
 * cé->
dev_°rùes
;

5372 
mö_d©a_°rùes
 = (
mö_num_°rùes
 - 
˘l
->
≈¨ôy
Ë/ cé->
nc›õs
;

5373 
u64
 
mö_chunk_size
 = 
mö_d©a_°rùes
 * 
z⁄e_size
;

5374 
u64
 
ty≥
 = 
˘l
->type;

5376 
˘l
->
max_°rùe_size
 = 
z⁄e_size
;

5377 i‡(
ty≥
 & 
BTRFS_BLOCK_GROUP_DATA
) {

5378 
˘l
->
max_chunk_size
 = 
	`round_down
(
BTRFS_MAX_DATA_CHUNK_SIZE
,

5379 
z⁄e_size
);

5380 } i‡(
ty≥
 & 
BTRFS_BLOCK_GROUP_METADATA
) {

5381 
˘l
->
max_chunk_size
 = cé->
max_°rùe_size
;

5382 } i‡(
ty≥
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) {

5383 
˘l
->
max_chunk_size
 = 2 * cé->
max_°rùe_size
;

5384 
˘l
->
devs_max
 = 
	`mö_t
(, ctl->devs_max,

5385 
BTRFS_MAX_DEVS_SYS_CHUNK
);

5387 
	`BUG
();

5391 
limô
 = 
	`max
(
	`round_down
(
	`mu…_≥rc
(
fs_devi˚s
->
tŸÆ_rw_byãs
, 10),

5392 
z⁄e_size
),

5393 
mö_chunk_size
);

5394 
˘l
->
max_chunk_size
 = 
	`mö
(
limô
, ctl->max_chunk_size);

5395 
˘l
->
dev_exã¡_mö
 = 
z⁄e_size
 * cé->
dev_°rùes
;

5396 
	}
}

5398 
	$öô_Æloc_chunk_˘l
(
båfs_fs_devi˚s
 *
fs_devi˚s
,

5399 
Æloc_chunk_˘l
 *
˘l
)

5401 
ödex
 = 
	`båfs_bg_Êags_to_øid_ödex
(
˘l
->
ty≥
);

5403 
˘l
->
sub_°rùes
 = 
båfs_øid_¨øy
[
ödex
].sub_stripes;

5404 
˘l
->
dev_°rùes
 = 
båfs_øid_¨øy
[
ödex
].dev_stripes;

5405 
˘l
->
devs_max
 = 
båfs_øid_¨øy
[
ödex
].devs_max;

5406 i‡(!
˘l
->
devs_max
)

5407 
˘l
->
devs_max
 = 
	`BTRFS_MAX_DEVS
(
fs_devi˚s
->
fs_öfo
);

5408 
˘l
->
devs_mö
 = 
båfs_øid_¨øy
[
ödex
].devs_min;

5409 
˘l
->
devs_ö¸emít
 = 
båfs_øid_¨øy
[
ödex
].devs_increment;

5410 
˘l
->
nc›õs
 = 
båfs_øid_¨øy
[
ödex
].ncopies;

5411 
˘l
->
≈¨ôy
 = 
båfs_øid_¨øy
[
ödex
].nparity;

5412 
˘l
->
ndevs
 = 0;

5414 
fs_devi˚s
->
chunk_Æloc_pﬁicy
) {

5415 
BTRFS_CHUNK_ALLOC_REGULAR
:

5416 
	`öô_Æloc_chunk_˘l_pﬁicy_ªguœr
(
fs_devi˚s
, 
˘l
);

5418 
BTRFS_CHUNK_ALLOC_ZONED
:

5419 
	`öô_Æloc_chunk_˘l_pﬁicy_z⁄ed
(
fs_devi˚s
, 
˘l
);

5422 
	`BUG
();

5424 
	}
}

5426 
	$g©hî_devi˚_öfo
(
båfs_fs_devi˚s
 *
fs_devi˚s
,

5427 
Æloc_chunk_˘l
 *
˘l
,

5428 
båfs_devi˚_öfo
 *
devi˚s_öfo
)

5430 
båfs_fs_öfo
 *
öfo
 = 
fs_devi˚s
->
fs_öfo
;

5431 
båfs_devi˚
 *
devi˚
;

5432 
u64
 
tŸÆ_avaû
;

5433 
u64
 
dev_exã¡_w™t
 = 
˘l
->
max_°rùe_size
 * cé->
dev_°rùes
;

5434 
ªt
;

5435 
ndevs
 = 0;

5436 
u64
 
max_avaû
;

5437 
u64
 
dev_off£t
;

5443 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_devi˚s
->
Æloc_li°
, 
dev_Æloc_li°
) {

5444 i‡(!
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
)) {

5445 
	`WARN
(1, 
KERN_ERR


5450 i‡(!
	`ã°_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
,

5451 &
devi˚
->
dev_°©e
) ||

5452 
	`ã°_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
))

5455 i‡(
devi˚
->
tŸÆ_byãs
 > devi˚->
byãs_u£d
)

5456 
tŸÆ_avaû
 = 
devi˚
->
tŸÆ_byãs
 - devi˚->
byãs_u£d
;

5458 
tŸÆ_avaû
 = 0;

5461 i‡(
tŸÆ_avaû
 < 
˘l
->
dev_exã¡_mö
)

5464 
ªt
 = 
	`föd_‰ì_dev_exã¡
(
devi˚
, 
dev_exã¡_w™t
, &
dev_off£t
,

5465 &
max_avaû
);

5466 i‡(
ªt
 &&Ñë !-
ENOSPC
)

5467  
ªt
;

5469 i‡(
ªt
 == 0)

5470 
max_avaû
 = 
dev_exã¡_w™t
;

5472 i‡(
max_avaû
 < 
˘l
->
dev_exã¡_mö
) {

5473 i‡(
	`båfs_ã°_›t
(
öfo
, 
ENOSPC_DEBUG
))

5474 
	`båfs_debug
(
öfo
,

5476 
__func__
, 
devi˚
->
devid
, 
max_avaû
,

5477 
˘l
->
dev_exã¡_mö
);

5481 i‡(
ndevs
 =
fs_devi˚s
->
rw_devi˚s
) {

5482 
	`WARN
(1, "%s: found moreÅhan %llu devices\n",

5483 
__func__
, 
fs_devi˚s
->
rw_devi˚s
);

5486 
devi˚s_öfo
[
ndevs
].
dev_off£t
 = dev_offset;

5487 
devi˚s_öfo
[
ndevs
].
max_avaû
 = max_avail;

5488 
devi˚s_öfo
[
ndevs
].
tŸÆ_avaû
 =Åotal_avail;

5489 
devi˚s_öfo
[
ndevs
].
dev
 = 
devi˚
;

5490 ++
ndevs
;

5492 
˘l
->
ndevs
 =Çdevs;

5497 
	`s‹t
(
devi˚s_öfo
, 
ndevs
, (
båfs_devi˚_öfo
),

5498 
båfs_cmp_devi˚_öfo
, 
NULL
);

5501 
	}
}

5503 
	$decide_°rùe_size_ªguœr
(
Æloc_chunk_˘l
 *
˘l
,

5504 
båfs_devi˚_öfo
 *
devi˚s_öfo
)

5507 
d©a_°rùes
;

5516 
˘l
->
°rùe_size
 = 
	`div_u64
(
devi˚s_öfo
[˘l->
ndevs
 - 1].
max_avaû
,

5517 
˘l
->
dev_°rùes
);

5518 
˘l
->
num_°rùes
 = cé->
ndevs
 * cé->
dev_°rùes
;

5521 
d©a_°rùes
 = (
˘l
->
num_°rùes
 - cé->
≈¨ôy
Ë/ cé->
nc›õs
;

5529 i‡(
˘l
->
°rùe_size
 * 
d©a_°rùes
 > cé->
max_chunk_size
) {

5535 
˘l
->
°rùe_size
 = 
	`mö
(
	`round_up
(
	`div_u64
(˘l->
max_chunk_size
,

5536 
d©a_°rùes
), 
SZ_16M
),

5537 
˘l
->
°rùe_size
);

5541 
˘l
->
°rùe_size
 = 
	`mö_t
(
u64
, cé->°rùe_size, 
SZ_1G
);

5544 
˘l
->
°rùe_size
 = 
	`round_down
(˘l->°rùe_size, 
BTRFS_STRIPE_LEN
);

5545 
˘l
->
chunk_size
 = cé->
°rùe_size
 * 
d©a_°rùes
;

5548 
	}
}

5550 
	$decide_°rùe_size_z⁄ed
(
Æloc_chunk_˘l
 *
˘l
,

5551 
båfs_devi˚_öfo
 *
devi˚s_öfo
)

5553 
u64
 
z⁄e_size
 = 
devi˚s_öfo
[0].
dev
->
z⁄e_öfo
->zone_size;

5555 
d©a_°rùes
;

5561 
	`ASSERT
(
devi˚s_öfo
[
˘l
->
ndevs
 - 1].
max_avaû
 =˘l->
dev_exã¡_mö
);

5563 
˘l
->
°rùe_size
 = 
z⁄e_size
;

5564 
˘l
->
num_°rùes
 = cé->
ndevs
 * cé->
dev_°rùes
;

5565 
d©a_°rùes
 = (
˘l
->
num_°rùes
 - cé->
≈¨ôy
Ë/ cé->
nc›õs
;

5568 i‡(
˘l
->
°rùe_size
 * 
d©a_°rùes
 > cé->
max_chunk_size
) {

5569 
˘l
->
ndevs
 = 
	`div_u64
(div_u64(˘l->
max_chunk_size
 * cé->
nc›õs
,

5570 
˘l
->
°rùe_size
Ë+ cé->
≈¨ôy
,

5571 
˘l
->
dev_°rùes
);

5572 
˘l
->
num_°rùes
 = cé->
ndevs
 * cé->
dev_°rùes
;

5573 
d©a_°rùes
 = (
˘l
->
num_°rùes
 - cé->
≈¨ôy
Ë/ cé->
nc›õs
;

5574 
	`ASSERT
(
˘l
->
°rùe_size
 * 
d©a_°rùes
 <˘l->
max_chunk_size
);

5577 
˘l
->
chunk_size
 = cé->
°rùe_size
 * 
d©a_°rùes
;

5580 
	}
}

5582 
	$decide_°rùe_size
(
båfs_fs_devi˚s
 *
fs_devi˚s
,

5583 
Æloc_chunk_˘l
 *
˘l
,

5584 
båfs_devi˚_öfo
 *
devi˚s_öfo
)

5586 
båfs_fs_öfo
 *
öfo
 = 
fs_devi˚s
->
fs_öfo
;

5593 
˘l
->
ndevs
 = 
	`rounddown
(˘l->ndevs, cé->
devs_ö¸emít
);

5595 i‡(
˘l
->
ndevs
 < cé->
devs_mö
) {

5596 i‡(
	`båfs_ã°_›t
(
öfo
, 
ENOSPC_DEBUG
)) {

5597 
	`båfs_debug
(
öfo
,

5599 
__func__
, 
˘l
->
ndevs
, cé->
devs_mö
);

5601  -
ENOSPC
;

5604 
˘l
->
ndevs
 = 
	`mö
(˘l->ndevs, cé->
devs_max
);

5606 
fs_devi˚s
->
chunk_Æloc_pﬁicy
) {

5607 
BTRFS_CHUNK_ALLOC_REGULAR
:

5608  
	`decide_°rùe_size_ªguœr
(
˘l
, 
devi˚s_öfo
);

5609 
BTRFS_CHUNK_ALLOC_ZONED
:

5610  
	`decide_°rùe_size_z⁄ed
(
˘l
, 
devi˚s_öfo
);

5612 
	`BUG
();

5614 
	}
}

5616 
båfs_block_group
 *
	$¸óã_chunk
(
båfs_å™s_h™dÀ
 *
å™s
,

5617 
Æloc_chunk_˘l
 *
˘l
,

5618 
båfs_devi˚_öfo
 *
devi˚s_öfo
)

5620 
båfs_fs_öfo
 *
öfo
 = 
å™s
->
fs_öfo
;

5621 
m≠_lookup
 *
m≠
 = 
NULL
;

5622 
exã¡_m≠_åì
 *
em_åì
;

5623 
båfs_block_group
 *
block_group
;

5624 
exã¡_m≠
 *
em
;

5625 
u64
 
°¨t
 = 
˘l
->start;

5626 
u64
 
ty≥
 = 
˘l
->type;

5627 
ªt
;

5628 
i
;

5629 
j
;

5631 
m≠
 = 
	`kmÆloc
(
	`m≠_lookup_size
(
˘l
->
num_°rùes
), 
GFP_NOFS
);

5632 i‡(!
m≠
)

5633  
	`ERR_PTR
(-
ENOMEM
);

5634 
m≠
->
num_°rùes
 = 
˘l
->num_stripes;

5636 
i
 = 0; i < 
˘l
->
ndevs
; ++i) {

5637 
j
 = 0; j < 
˘l
->
dev_°rùes
; ++j) {

5638 
s
 = 
i
 * 
˘l
->
dev_°rùes
 + 
j
;

5639 
m≠
->
°rùes
[
s
].
dev
 = 
devi˚s_öfo
[
i
].dev;

5640 
m≠
->
°rùes
[
s
].
physiˇl
 = 
devi˚s_öfo
[
i
].
dev_off£t
 +

5641 
j
 * 
˘l
->
°rùe_size
;

5644 
m≠
->
io_Æign
 = 
BTRFS_STRIPE_LEN
;

5645 
m≠
->
io_width
 = 
BTRFS_STRIPE_LEN
;

5646 
m≠
->
ty≥
 =Åype;

5647 
m≠
->
sub_°rùes
 = 
˘l
->sub_stripes;

5649 
	`åa˚_båfs_chunk_Æloc
(
öfo
, 
m≠
, 
°¨t
, 
˘l
->
chunk_size
);

5651 
em
 = 
	`Æloc_exã¡_m≠
();

5652 i‡(!
em
) {

5653 
	`k‰ì
(
m≠
);

5654  
	`ERR_PTR
(-
ENOMEM
);

5656 
	`£t_bô
(
EXTENT_FLAG_FS_MAPPING
, &
em
->
Êags
);

5657 
em
->
m≠_lookup
 = 
m≠
;

5658 
em
->
°¨t
 = start;

5659 
em
->
Àn
 = 
˘l
->
chunk_size
;

5660 
em
->
block_°¨t
 = 0;

5661 
em
->
block_Àn
 =Ém->
Àn
;

5662 
em
->
‹ig_block_Àn
 = 
˘l
->
°rùe_size
;

5664 
em_åì
 = &
öfo
->
m≠pög_åì
;

5665 
	`wrôe_lock
(&
em_åì
->
lock
);

5666 
ªt
 = 
	`add_exã¡_m≠pög
(
em_åì
, 
em
, 0);

5667 i‡(
ªt
) {

5668 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

5669 
	`‰ì_exã¡_m≠
(
em
);

5670  
	`ERR_PTR
(
ªt
);

5672 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

5674 
block_group
 = 
	`båfs_make_block_group
(
å™s
, 
ty≥
, 
°¨t
, 
˘l
->
chunk_size
);

5675 i‡(
	`IS_ERR
(
block_group
))

5676 
îr‹_dñ_exã¡
;

5678 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

5679 
båfs_devi˚
 *
dev
 = 
m≠
->
°rùes
[
i
].dev;

5681 
	`båfs_devi˚_£t_byãs_u£d
(
dev
,

5682 
dev
->
byãs_u£d
 + 
˘l
->
°rùe_size
);

5683 i‡(
	`li°_em±y
(&
dev
->
po°_commô_li°
))

5684 
	`li°_add_èû
(&
dev
->
po°_commô_li°
,

5685 &
å™s
->
å™ß˘i⁄
->
dev_upd©e_li°
);

5688 
	`©omic64_sub
(
˘l
->
°rùe_size
 * 
m≠
->
num_°rùes
,

5689 &
öfo
->
‰ì_chunk_•a˚
);

5691 
	`‰ì_exã¡_m≠
(
em
);

5692 
	`check_øid56_öcom∑t_Êag
(
öfo
, 
ty≥
);

5693 
	`check_øid1c34_öcom∑t_Êag
(
öfo
, 
ty≥
);

5695  
block_group
;

5697 
îr‹_dñ_exã¡
:

5698 
	`wrôe_lock
(&
em_åì
->
lock
);

5699 
	`ªmove_exã¡_m≠pög
(
em_åì
, 
em
);

5700 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

5703 
	`‰ì_exã¡_m≠
(
em
);

5705 
	`‰ì_exã¡_m≠
(
em
);

5707  
block_group
;

5708 
	}
}

5710 
båfs_block_group
 *
	$båfs_¸óã_chunk
(
båfs_å™s_h™dÀ
 *
å™s
,

5711 
u64
 
ty≥
)

5713 
båfs_fs_öfo
 *
öfo
 = 
å™s
->
fs_öfo
;

5714 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
öfo
->fs_devices;

5715 
båfs_devi˚_öfo
 *
devi˚s_öfo
 = 
NULL
;

5716 
Æloc_chunk_˘l
 
˘l
;

5717 
båfs_block_group
 *
block_group
;

5718 
ªt
;

5720 
	`lockdï_as£π_hñd
(&
öfo
->
chunk_muãx
);

5722 i‡(!
	`Æloc_¥ofûe_is_vÆid
(
ty≥
, 0)) {

5723 
	`ASSERT
(0);

5724  
	`ERR_PTR
(-
EINVAL
);

5727 i‡(
	`li°_em±y
(&
fs_devi˚s
->
Æloc_li°
)) {

5728 i‡(
	`båfs_ã°_›t
(
öfo
, 
ENOSPC_DEBUG
))

5729 
	`båfs_debug
(
öfo
, "%s:ÇÿwrôabÀ devi˚", 
__func__
);

5730  
	`ERR_PTR
(-
ENOSPC
);

5733 i‡(!(
ty≥
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
)) {

5734 
	`båfs_îr
(
öfo
, "övÆid chunkÅy≥ 0x%ŒxÑeque°ed", 
ty≥
);

5735 
	`ASSERT
(0);

5736  
	`ERR_PTR
(-
EINVAL
);

5739 
˘l
.
°¨t
 = 
	`föd_√xt_chunk
(
öfo
);

5740 
˘l
.
ty≥
 =Åype;

5741 
	`öô_Æloc_chunk_˘l
(
fs_devi˚s
, &
˘l
);

5743 
devi˚s_öfo
 = 
	`kˇŒoc
(
fs_devi˚s
->
rw_devi˚s
, (*devices_info),

5744 
GFP_NOFS
);

5745 i‡(!
devi˚s_öfo
)

5746  
	`ERR_PTR
(-
ENOMEM
);

5748 
ªt
 = 
	`g©hî_devi˚_öfo
(
fs_devi˚s
, &
˘l
, 
devi˚s_öfo
);

5749 i‡(
ªt
 < 0) {

5750 
block_group
 = 
	`ERR_PTR
(
ªt
);

5751 
out
;

5754 
ªt
 = 
	`decide_°rùe_size
(
fs_devi˚s
, &
˘l
, 
devi˚s_öfo
);

5755 i‡(
ªt
 < 0) {

5756 
block_group
 = 
	`ERR_PTR
(
ªt
);

5757 
out
;

5760 
block_group
 = 
	`¸óã_chunk
(
å™s
, &
˘l
, 
devi˚s_öfo
);

5762 
out
:

5763 
	`k‰ì
(
devi˚s_öfo
);

5764  
block_group
;

5765 
	}
}

5775 
	$båfs_chunk_Æloc_add_chunk_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

5776 
båfs_block_group
 *
bg
)

5778 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

5779 
båfs_roŸ
 *
chunk_roŸ
 = 
fs_öfo
->chunk_root;

5780 
båfs_key
 
key
;

5781 
båfs_chunk
 *
chunk
;

5782 
båfs_°rùe
 *
°rùe
;

5783 
exã¡_m≠
 *
em
;

5784 
m≠_lookup
 *
m≠
;

5785 
size_t
 
ôem_size
;

5786 
i
;

5787 
ªt
;

5811 
	`lockdï_as£π_hñd
(&
fs_öfo
->
chunk_muãx
);

5813 
em
 = 
	`båfs_gë_chunk_m≠
(
fs_öfo
, 
bg
->
°¨t
, bg->
Àngth
);

5814 i‡(
	`IS_ERR
(
em
)) {

5815 
ªt
 = 
	`PTR_ERR
(
em
);

5816 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

5817  
ªt
;

5820 
m≠
 = 
em
->
m≠_lookup
;

5821 
ôem_size
 = 
	`båfs_chunk_ôem_size
(
m≠
->
num_°rùes
);

5823 
chunk
 = 
	`kzÆloc
(
ôem_size
, 
GFP_NOFS
);

5824 i‡(!
chunk
) {

5825 
ªt
 = -
ENOMEM
;

5826 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

5827 
out
;

5830 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

5831 
båfs_devi˚
 *
devi˚
 = 
m≠
->
°rùes
[
i
].
dev
;

5833 
ªt
 = 
	`båfs_upd©e_devi˚
(
å™s
, 
devi˚
);

5834 i‡(
ªt
)

5835 
out
;

5838 
°rùe
 = &
chunk
->stripe;

5839 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

5840 
båfs_devi˚
 *
devi˚
 = 
m≠
->
°rùes
[
i
].
dev
;

5841 c⁄° 
u64
 
dev_off£t
 = 
m≠
->
°rùes
[
i
].
physiˇl
;

5843 
	`båfs_£t_°ack_°rùe_devid
(
°rùe
, 
devi˚
->
devid
);

5844 
	`båfs_£t_°ack_°rùe_off£t
(
°rùe
, 
dev_off£t
);

5845 
	`mem˝y
(
°rùe
->
dev_uuid
, 
devi˚
->
uuid
, 
BTRFS_UUID_SIZE
);

5846 
°rùe
++;

5849 
	`båfs_£t_°ack_chunk_Àngth
(
chunk
, 
bg
->
Àngth
);

5850 
	`båfs_£t_°ack_chunk_ow√r
(
chunk
, 
BTRFS_EXTENT_TREE_OBJECTID
);

5851 
	`båfs_£t_°ack_chunk_°rùe_Àn
(
chunk
, 
BTRFS_STRIPE_LEN
);

5852 
	`båfs_£t_°ack_chunk_ty≥
(
chunk
, 
m≠
->
ty≥
);

5853 
	`båfs_£t_°ack_chunk_num_°rùes
(
chunk
, 
m≠
->
num_°rùes
);

5854 
	`båfs_£t_°ack_chunk_io_Æign
(
chunk
, 
BTRFS_STRIPE_LEN
);

5855 
	`båfs_£t_°ack_chunk_io_width
(
chunk
, 
BTRFS_STRIPE_LEN
);

5856 
	`båfs_£t_°ack_chunk_£˘‹_size
(
chunk
, 
fs_öfo
->
£˘‹size
);

5857 
	`båfs_£t_°ack_chunk_sub_°rùes
(
chunk
, 
m≠
->
sub_°rùes
);

5859 
key
.
obje˘id
 = 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
;

5860 
key
.
ty≥
 = 
BTRFS_CHUNK_ITEM_KEY
;

5861 
key
.
off£t
 = 
bg
->
°¨t
;

5863 
ªt
 = 
	`båfs_ö£π_ôem
(
å™s
, 
chunk_roŸ
, &
key
, 
chunk
, 
ôem_size
);

5864 i‡(
ªt
)

5865 
out
;

5867 
	`£t_bô
(
BLOCK_GROUP_FLAG_CHUNK_ITEM_INSERTED
, &
bg
->
ru¡ime_Êags
);

5869 i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) {

5870 
ªt
 = 
	`båfs_add_sy°em_chunk
(
fs_öfo
, &
key
, 
chunk
, 
ôem_size
);

5871 i‡(
ªt
)

5872 
out
;

5875 
out
:

5876 
	`k‰ì
(
chunk
);

5877 
	`‰ì_exã¡_m≠
(
em
);

5878  
ªt
;

5879 
	}
}

5881 
noölöe
 
	$öô_fú°_rw_devi˚
(
båfs_å™s_h™dÀ
 *
å™s
)

5883 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

5884 
u64
 
Æloc_¥ofûe
;

5885 
båfs_block_group
 *
mëa_bg
;

5886 
båfs_block_group
 *
sys_bg
;

5909 
Æloc_¥ofûe
 = 
	`båfs_mëad©a_Æloc_¥ofûe
(
fs_öfo
);

5910 
mëa_bg
 = 
	`båfs_¸óã_chunk
(
å™s
, 
Æloc_¥ofûe
);

5911 i‡(
	`IS_ERR
(
mëa_bg
))

5912  
	`PTR_ERR
(
mëa_bg
);

5914 
Æloc_¥ofûe
 = 
	`båfs_sy°em_Æloc_¥ofûe
(
fs_öfo
);

5915 
sys_bg
 = 
	`båfs_¸óã_chunk
(
å™s
, 
Æloc_¥ofûe
);

5916 i‡(
	`IS_ERR
(
sys_bg
))

5917  
	`PTR_ERR
(
sys_bg
);

5920 
	}
}

5922 
ölöe
 
	$båfs_chunk_max_îr‹s
(
m≠_lookup
 *
m≠
)

5924 c⁄° 
ödex
 = 
	`båfs_bg_Êags_to_øid_ödex
(
m≠
->
ty≥
);

5926  
båfs_øid_¨øy
[
ödex
].
tﬁî©ed_Áûuªs
;

5927 
	}
}

5929 
boﬁ
 
	$båfs_chunk_wrôóbÀ
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
chunk_off£t
)

5931 
exã¡_m≠
 *
em
;

5932 
m≠_lookup
 *
m≠
;

5933 
miss_ndevs
 = 0;

5934 
i
;

5935 
boﬁ
 
ªt
 = 
åue
;

5937 
em
 = 
	`båfs_gë_chunk_m≠
(
fs_öfo
, 
chunk_off£t
, 1);

5938 i‡(
	`IS_ERR
(
em
))

5939  
Ál£
;

5941 
m≠
 = 
em
->
m≠_lookup
;

5942 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

5943 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
,

5944 &
m≠
->
°rùes
[
i
].
dev
->
dev_°©e
)) {

5945 
miss_ndevs
++;

5948 i‡(!
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
,

5949 &
m≠
->
°rùes
[
i
].
dev
->
dev_°©e
)) {

5950 
ªt
 = 
Ál£
;

5951 
íd
;

5959 i‡(
miss_ndevs
 > 
	`båfs_chunk_max_îr‹s
(
m≠
))

5960 
ªt
 = 
Ál£
;

5961 
íd
:

5962 
	`‰ì_exã¡_m≠
(
em
);

5963  
ªt
;

5964 
	}
}

5966 
	$båfs_m≠pög_åì_‰ì
(
exã¡_m≠_åì
 *
åì
)

5968 
exã¡_m≠
 *
em
;

5971 
	`wrôe_lock
(&
åì
->
lock
);

5972 
em
 = 
	`lookup_exã¡_m≠pög
(
åì
, 0, (
u64
)-1);

5973 i‡(
em
)

5974 
	`ªmove_exã¡_m≠pög
(
åì
, 
em
);

5975 
	`wrôe_u∆ock
(&
åì
->
lock
);

5976 i‡(!
em
)

5979 
	`‰ì_exã¡_m≠
(
em
);

5981 
	`‰ì_exã¡_m≠
(
em
);

5983 
	}
}

5985 
	$båfs_num_c›õs
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
logiˇl
, u64 
Àn
)

5987 
exã¡_m≠
 *
em
;

5988 
m≠_lookup
 *
m≠
;

5989 
båfs_øid_ty≥s
 
ödex
;

5990 
ªt
 = 1;

5992 
em
 = 
	`båfs_gë_chunk_m≠
(
fs_öfo
, 
logiˇl
, 
Àn
);

5993 i‡(
	`IS_ERR
(
em
))

6002 
m≠
 = 
em
->
m≠_lookup
;

6003 
ödex
 = 
	`båfs_bg_Êags_to_øid_ödex
(
m≠
->
ty≥
);

6006 i‡(!(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
))

6007 
ªt
 = 
båfs_øid_¨øy
[
ödex
].
nc›õs
;

6008 i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID5
)

6009 
ªt
 = 2;

6010 i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID6
)

6018 
ªt
 = 
m≠
->
num_°rùes
;

6019 
	`‰ì_exã¡_m≠
(
em
);

6020  
ªt
;

6021 
	}
}

6023 
	$båfs_fuŒ_°rùe_Àn
(
båfs_fs_öfo
 *
fs_öfo
,

6024 
u64
 
logiˇl
)

6026 
exã¡_m≠
 *
em
;

6027 
m≠_lookup
 *
m≠
;

6028 
Àn
 = 
fs_öfo
->
£˘‹size
;

6030 i‡(!
	`båfs_fs_öcom∑t
(
fs_öfo
, 
RAID56
))

6031  
Àn
;

6033 
em
 = 
	`båfs_gë_chunk_m≠
(
fs_öfo
, 
logiˇl
, 
Àn
);

6035 i‡(!
	`WARN_ON
(
	`IS_ERR
(
em
))) {

6036 
m≠
 = 
em
->
m≠_lookup
;

6037 i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
)

6038 
Àn
 = 
	`båfs_°rùe_ƒ_to_off£t
(
	`ƒ_d©a_°rùes
(
m≠
));

6039 
	`‰ì_exã¡_m≠
(
em
);

6041  
Àn
;

6042 
	}
}

6044 
	$båfs_is_∑rôy_múr‹
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
logiˇl
, u64 
Àn
)

6046 
exã¡_m≠
 *
em
;

6047 
m≠_lookup
 *
m≠
;

6048 
ªt
 = 0;

6050 i‡(!
	`båfs_fs_öcom∑t
(
fs_öfo
, 
RAID56
))

6053 
em
 = 
	`båfs_gë_chunk_m≠
(
fs_öfo
, 
logiˇl
, 
Àn
);

6055 if(!
	`WARN_ON
(
	`IS_ERR
(
em
))) {

6056 
m≠
 = 
em
->
m≠_lookup
;

6057 i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
)

6058 
ªt
 = 1;

6059 
	`‰ì_exã¡_m≠
(
em
);

6061  
ªt
;

6062 
	}
}

6064 
	$föd_live_múr‹
(
båfs_fs_öfo
 *
fs_öfo
,

6065 
m≠_lookup
 *
m≠
, 
fú°
,

6066 
dev_ª∂a˚_is_⁄goög
)

6068 
i
;

6069 
num_°rùes
;

6070 
¥e„ºed_múr‹
;

6071 
tﬁî™˚
;

6072 
båfs_devi˚
 *
§cdev
;

6074 
	`ASSERT
((
m≠
->
ty≥
 &

6075 (
BTRFS_BLOCK_GROUP_RAID1_MASK
 | 
BTRFS_BLOCK_GROUP_RAID10
)));

6077 i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID10
)

6078 
num_°rùes
 = 
m≠
->
sub_°rùes
;

6080 
num_°rùes
 = 
m≠
->num_stripes;

6082 
fs_öfo
->
fs_devi˚s
->
ªad_pﬁicy
) {

6085 
	`båfs_w¨n_æ
(
fs_öfo
,

6087 
fs_öfo
->
fs_devi˚s
->
ªad_pﬁicy
);

6088 
fs_öfo
->
fs_devi˚s
->
ªad_pﬁicy
 = 
BTRFS_READ_POLICY_PID
;

6089 
ÁŒthrough
;

6090 
BTRFS_READ_POLICY_PID
:

6091 
¥e„ºed_múr‹
 = 
fú°
 + (
cuºít
->
pid
 % 
num_°rùes
);

6095 i‡(
dev_ª∂a˚_is_⁄goög
 &&

6096 
fs_öfo
->
dev_ª∂a˚
.
c⁄t_ªadög_‰om_§cdev_mode
 ==

6097 
BTRFS_DEV_REPLACE_ITEM_CONT_READING_FROM_SRCDEV_MODE_AVOID
)

6098 
§cdev
 = 
fs_öfo
->
dev_ª∂a˚
.srcdev;

6100 
§cdev
 = 
NULL
;

6107 
tﬁî™˚
 = 0;Åolerance < 2;Åolerance++) {

6108 i‡(
m≠
->
°rùes
[
¥e„ºed_múr‹
].
dev
->
bdev
 &&

6109 (
tﬁî™˚
 || 
m≠
->
°rùes
[
¥e„ºed_múr‹
].
dev
 !
§cdev
))

6110  
¥e„ºed_múr‹
;

6111 
i
 = 
fú°
; i < fú° + 
num_°rùes
; i++) {

6112 i‡(
m≠
->
°rùes
[
i
].
dev
->
bdev
 &&

6113 (
tﬁî™˚
 || 
m≠
->
°rùes
[
i
].
dev
 !
§cdev
))

6114  
i
;

6121  
¥e„ºed_múr‹
;

6122 
	}
}

6124 
båfs_io_c⁄ãxt
 *
	$Æloc_båfs_io_c⁄ãxt
(
båfs_fs_öfo
 *
fs_öfo
,

6125 
u16
 
tŸÆ_°rùes
)

6127 
båfs_io_c⁄ãxt
 *
bioc
;

6129 
bioc
 = 
	`kzÆloc
(

6131 (
båfs_io_c⁄ãxt
) +

6133 (
båfs_io_°rùe
Ë* (
tŸÆ_°rùes
),

6134 
GFP_NOFS
);

6136 i‡(!
bioc
)

6137  
NULL
;

6139 
	`ªfcou¡_£t
(&
bioc
->
ªfs
, 1);

6141 
bioc
->
fs_öfo
 = fs_info;

6142 
bioc
->
ª∂a˚_°rùe_§c
 = -1;

6143 
bioc
->
fuŒ_°rùe_logiˇl
 = (
u64
)-1;

6145  
bioc
;

6146 
	}
}

6148 
	$båfs_gë_bioc
(
båfs_io_c⁄ãxt
 *
bioc
)

6150 
	`WARN_ON
(!
	`ªfcou¡_ªad
(&
bioc
->
ªfs
));

6151 
	`ªfcou¡_öc
(&
bioc
->
ªfs
);

6152 
	}
}

6154 
	$båfs_put_bioc
(
båfs_io_c⁄ãxt
 *
bioc
)

6156 i‡(!
bioc
)

6158 i‡(
	`ªfcou¡_dec_™d_ã°
(&
bioc
->
ªfs
))

6159 
	`k‰ì
(
bioc
);

6160 
	}
}

6166 
båfs_disˇrd_°rùe
 *
	$båfs_m≠_disˇrd
(
båfs_fs_öfo
 *
fs_öfo
,

6167 
u64
 
logiˇl
, u64 *
Àngth_ªt
,

6168 
u32
 *
num_°rùes
)

6170 
exã¡_m≠
 *
em
;

6171 
m≠_lookup
 *
m≠
;

6172 
båfs_disˇrd_°rùe
 *
°rùes
;

6173 
u64
 
Àngth
 = *
Àngth_ªt
;

6174 
u64
 
off£t
;

6175 
u32
 
°rùe_ƒ
;

6176 
u32
 
°rùe_ƒ_íd
;

6177 
u32
 
°rùe_˙t
;

6178 
u64
 
°rùe_íd_off£t
;

6179 
u64
 
°rùe_off£t
;

6180 
u32
 
°rùe_ödex
;

6181 
u32
 
Á˘‹
 = 0;

6182 
u32
 
sub_°rùes
 = 0;

6183 
u32
 
°rùes_≥r_dev
 = 0;

6184 
u32
 
ªmaöög_°rùes
 = 0;

6185 
u32
 
œ°_°rùe
 = 0;

6186 
ªt
;

6187 
i
;

6189 
em
 = 
	`båfs_gë_chunk_m≠
(
fs_öfo
, 
logiˇl
, 
Àngth
);

6190 i‡(
	`IS_ERR
(
em
))

6191  
	`ERR_CAST
(
em
);

6193 
m≠
 = 
em
->
m≠_lookup
;

6196 i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

6197 
ªt
 = -
EOPNOTSUPP
;

6198 
out_‰ì_m≠
;

6201 
off£t
 = 
logiˇl
 - 
em
->
°¨t
;

6202 
Àngth
 = 
	`mö_t
(
u64
, 
em
->
°¨t
 +Ém->
Àn
 - 
logiˇl
,Üength);

6203 *
Àngth_ªt
 = 
Àngth
;

6209 
°rùe_ƒ
 = 
off£t
 >> 
BTRFS_STRIPE_LEN_SHIFT
;

6212 
°rùe_off£t
 = 
off£t
 - 
	`båfs_°rùe_ƒ_to_off£t
(
°rùe_ƒ
);

6214 
°rùe_ƒ_íd
 = 
	`round_up
(
off£t
 + 
Àngth
, 
BTRFS_STRIPE_LEN
) >>

6215 
BTRFS_STRIPE_LEN_SHIFT
;

6216 
°rùe_˙t
 = 
°rùe_ƒ_íd
 - 
°rùe_ƒ
;

6217 
°rùe_íd_off£t
 = 
	`båfs_°rùe_ƒ_to_off£t
(
°rùe_ƒ_íd
) -

6218 (
off£t
 + 
Àngth
);

6224 *
num_°rùes
 = 1;

6225 
°rùe_ödex
 = 0;

6226 i‡(
m≠
->
ty≥
 & (
BTRFS_BLOCK_GROUP_RAID0
 |

6227 
BTRFS_BLOCK_GROUP_RAID10
)) {

6228 i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID0
)

6229 
sub_°rùes
 = 1;

6231 
sub_°rùes
 = 
m≠
->sub_stripes;

6233 
Á˘‹
 = 
m≠
->
num_°rùes
 / 
sub_°rùes
;

6234 *
num_°rùes
 = 
	`mö_t
(
u64
, 
m≠
->num_stripes,

6235 
sub_°rùes
 * 
°rùe_˙t
);

6236 
°rùe_ödex
 = 
°rùe_ƒ
 % 
Á˘‹
;

6237 
°rùe_ƒ
 /
Á˘‹
;

6238 
°rùe_ödex
 *
sub_°rùes
;

6240 
ªmaöög_°rùes
 = 
°rùe_˙t
 % 
Á˘‹
;

6241 
°rùes_≥r_dev
 = 
°rùe_˙t
 / 
Á˘‹
;

6242 
œ°_°rùe
 = ((
°rùe_ƒ_íd
 - 1Ë% 
Á˘‹
Ë* 
sub_°rùes
;

6243 } i‡(
m≠
->
ty≥
 & (
BTRFS_BLOCK_GROUP_RAID1_MASK
 |

6244 
BTRFS_BLOCK_GROUP_DUP
)) {

6245 *
num_°rùes
 = 
m≠
->num_stripes;

6247 
°rùe_ödex
 = 
°rùe_ƒ
 % 
m≠
->
num_°rùes
;

6248 
°rùe_ƒ
 /
m≠
->
num_°rùes
;

6251 
°rùes
 = 
	`kˇŒoc
(*
num_°rùes
, (*°rùes), 
GFP_NOFS
);

6252 i‡(!
°rùes
) {

6253 
ªt
 = -
ENOMEM
;

6254 
out_‰ì_m≠
;

6257 
i
 = 0; i < *
num_°rùes
; i++) {

6258 
°rùes
[
i
].
physiˇl
 =

6259 
m≠
->
°rùes
[
°rùe_ödex
].
physiˇl
 +

6260 
°rùe_off£t
 + 
	`båfs_°rùe_ƒ_to_off£t
(
°rùe_ƒ
);

6261 
°rùes
[
i
].
dev
 = 
m≠
->°rùes[
°rùe_ödex
].dev;

6263 i‡(
m≠
->
ty≥
 & (
BTRFS_BLOCK_GROUP_RAID0
 |

6264 
BTRFS_BLOCK_GROUP_RAID10
)) {

6265 
°rùes
[
i
].
Àngth
 = 
	`båfs_°rùe_ƒ_to_off£t
(
°rùes_≥r_dev
);

6267 i‡(
i
 / 
sub_°rùes
 < 
ªmaöög_°rùes
)

6268 
°rùes
[
i
].
Àngth
 +
BTRFS_STRIPE_LEN
;

6278 i‡(
i
 < 
sub_°rùes
)

6279 
°rùes
[
i
].
Àngth
 -
°rùe_off£t
;

6281 i‡(
°rùe_ödex
 >
œ°_°rùe
 &&

6282 
°rùe_ödex
 <(
œ°_°rùe
 +

6283 
sub_°rùes
 - 1))

6284 
°rùes
[
i
].
Àngth
 -
°rùe_íd_off£t
;

6286 i‡(
i
 =
sub_°rùes
 - 1)

6287 
°rùe_off£t
 = 0;

6289 
°rùes
[
i
].
Àngth
 =Üength;

6292 
°rùe_ödex
++;

6293 i‡(
°rùe_ödex
 =
m≠
->
num_°rùes
) {

6294 
°rùe_ödex
 = 0;

6295 
°rùe_ƒ
++;

6299 
	`‰ì_exã¡_m≠
(
em
);

6300  
°rùes
;

6301 
out_‰ì_m≠
:

6302 
	`‰ì_exã¡_m≠
(
em
);

6303  
	`ERR_PTR
(
ªt
);

6304 
	}
}

6306 
boﬁ
 
	$is_block_group_to_c›y
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
logiˇl
)

6308 
båfs_block_group
 *
ˇche
;

6309 
boﬁ
 
ªt
;

6312 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

6313  
Ál£
;

6315 
ˇche
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
logiˇl
);

6317 
ªt
 = 
	`ã°_bô
(
BLOCK_GROUP_FLAG_TO_COPY
, &
ˇche
->
ru¡ime_Êags
);

6319 
	`båfs_put_block_group
(
ˇche
);

6320  
ªt
;

6321 
	}
}

6323 
	$h™dÀ_›s_⁄_dev_ª∂a˚
(
båfs_m≠_›
 
›
,

6324 
båfs_io_c⁄ãxt
 *
bioc
,

6325 
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
,

6326 
u64
 
logiˇl
,

6327 *
num_°rùes_ªt
, *
max_îr‹s_ªt
)

6329 
u64
 
§cdev_devid
 = 
dev_ª∂a˚
->
§cdev
->
devid
;

6334 
num_°rùes
 = *
num_°rùes_ªt
;

6335 
ƒ_exåa_°rùes
 = 0;

6336 
max_îr‹s
 = *
max_îr‹s_ªt
;

6337 
i
;

6343 i‡(
	`is_block_group_to_c›y
(
dev_ª∂a˚
->
§cdev
->
fs_öfo
, 
logiˇl
))

6356 
i
 = 0; i < 
num_°rùes
; i++) {

6357 
båfs_io_°rùe
 *
ﬁd
 = &
bioc
->
°rùes
[
i
];

6358 
båfs_io_°rùe
 *
√w
 = &
bioc
->
°rùes
[
num_°rùes
 + 
ƒ_exåa_°rùes
];

6360 i‡(
ﬁd
->
dev
->
devid
 !
§cdev_devid
)

6363 
√w
->
physiˇl
 = 
ﬁd
->physical;

6364 
√w
->
dev
 = 
dev_ª∂a˚
->
tgtdev
;

6365 i‡(
bioc
->
m≠_ty≥
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
)

6366 
bioc
->
ª∂a˚_°rùe_§c
 = 
i
;

6367 
ƒ_exåa_°rùes
++;

6371 
	`ASSERT
(
ƒ_exåa_°rùes
 <= 2);

6377 i‡(
›
 =
BTRFS_MAP_GET_READ_MIRRORS
 && 
ƒ_exåa_°rùes
 == 2) {

6378 
båfs_io_°rùe
 *
fú°
 = &
bioc
->
°rùes
[
num_°rùes
];

6379 
båfs_io_°rùe
 *
£c⁄d
 = &
bioc
->
°rùes
[
num_°rùes
 + 1];

6382 
	`ASSERT
(
bioc
->
m≠_ty≥
 & 
BTRFS_BLOCK_GROUP_DUP
);

6388 i‡(
fú°
->
physiˇl
 > 
£c⁄d
->physical) {

6389 
	`sw≠
(
£c⁄d
->
physiˇl
, 
fú°
->physical);

6390 
	`sw≠
(
£c⁄d
->
dev
, 
fú°
->dev);

6391 
ƒ_exåa_°rùes
--;

6395 *
num_°rùes_ªt
 = 
num_°rùes
 + 
ƒ_exåa_°rùes
;

6396 *
max_îr‹s_ªt
 = 
max_îr‹s
 + 
ƒ_exåa_°rùes
;

6397 
bioc
->
ª∂a˚_ƒ_°rùes
 = 
ƒ_exåa_°rùes
;

6398 
	}
}

6400 
u64
 
	$båfs_max_io_Àn
(
m≠_lookup
 *
m≠
, 
båfs_m≠_›
 
›
,

6401 
u64
 
off£t
, 
u32
 *
°rùe_ƒ
, u64 *
°rùe_off£t
,

6402 
u64
 *
fuŒ_°rùe_°¨t
)

6408 *
°rùe_off£t
 = 
off£t
 & 
BTRFS_STRIPE_LEN_MASK
;

6409 *
°rùe_ƒ
 = 
off£t
 >> 
BTRFS_STRIPE_LEN_SHIFT
;

6410 
	`ASSERT
(*
°rùe_off£t
 < 
U32_MAX
);

6412 i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

6413 
fuŒ_°rùe_Àn
 =

6414 
	`båfs_°rùe_ƒ_to_off£t
(
	`ƒ_d©a_°rùes
(
m≠
));

6425 *
fuŒ_°rùe_°¨t
 =

6426 
	`båfs_°rùe_ƒ_to_off£t
(

6427 
	`rounddown
(*
°rùe_ƒ
, 
	`ƒ_d©a_°rùes
(
m≠
)));

6429 
	`ASSERT
(*
fuŒ_°rùe_°¨t
 + 
fuŒ_°rùe_Àn
 > 
off£t
);

6430 
	`ASSERT
(*
fuŒ_°rùe_°¨t
 <
off£t
);

6435 i‡(
›
 =
BTRFS_MAP_WRITE
)

6436  
fuŒ_°rùe_Àn
 - (
off£t
 - *
fuŒ_°rùe_°¨t
);

6443 i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_STRIPE_MASK
)

6444  
BTRFS_STRIPE_LEN
 - *
°rùe_off£t
;

6445  
U64_MAX
;

6446 
	}
}

6448 
	$£t_io_°rùe
(
båfs_io_°rùe
 *
d°
, c⁄° 
m≠_lookup
 *
m≠
,

6449 
u32
 
°rùe_ödex
, 
u64
 
°rùe_off£t
, u32 
°rùe_ƒ
)

6451 
d°
->
dev
 = 
m≠
->
°rùes
[
°rùe_ödex
].dev;

6452 
d°
->
physiˇl
 = 
m≠
->
°rùes
[
°rùe_ödex
].physical +

6453 
°rùe_off£t
 + 
	`båfs_°rùe_ƒ_to_off£t
(
°rùe_ƒ
);

6454 
	}
}

6495 
	$båfs_m≠_block
(
båfs_fs_öfo
 *
fs_öfo
, 
båfs_m≠_›
 
›
,

6496 
u64
 
logiˇl
, u64 *
Àngth
,

6497 
båfs_io_c⁄ãxt
 **
bioc_ªt
,

6498 
båfs_io_°rùe
 *
sm≠
, *
múr‹_num_ªt
,

6499 
√ed_øid_m≠
)

6501 
exã¡_m≠
 *
em
;

6502 
m≠_lookup
 *
m≠
;

6503 
u64
 
m≠_off£t
;

6504 
u64
 
°rùe_off£t
;

6505 
u32
 
°rùe_ƒ
;

6506 
u32
 
°rùe_ödex
;

6507 
d©a_°rùes
;

6508 
i
;

6509 
ªt
 = 0;

6510 
múr‹_num
 = (
múr‹_num_ªt
 ? *mirror_num_ret : 0);

6511 
num_°rùes
;

6512 
num_c›õs
;

6513 
max_îr‹s
 = 0;

6514 
båfs_io_c⁄ãxt
 *
bioc
 = 
NULL
;

6515 
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
 = &
fs_öfo
->dev_replace;

6516 
dev_ª∂a˚_is_⁄goög
 = 0;

6517 
u16
 
num_Æloc_°rùes
;

6518 
u64
 
øid56_fuŒ_°rùe_°¨t
 = (u64)-1;

6519 
u64
 
max_Àn
;

6521 
	`ASSERT
(
bioc_ªt
);

6523 
num_c›õs
 = 
	`båfs_num_c›õs
(
fs_öfo
, 
logiˇl
, fs_öfo->
£˘‹size
);

6524 i‡(
múr‹_num
 > 
num_c›õs
)

6525  -
EINVAL
;

6527 
em
 = 
	`båfs_gë_chunk_m≠
(
fs_öfo
, 
logiˇl
, *
Àngth
);

6528 i‡(
	`IS_ERR
(
em
))

6529  
	`PTR_ERR
(
em
);

6531 
m≠
 = 
em
->
m≠_lookup
;

6532 
d©a_°rùes
 = 
	`ƒ_d©a_°rùes
(
m≠
);

6534 
m≠_off£t
 = 
logiˇl
 - 
em
->
°¨t
;

6535 
max_Àn
 = 
	`båfs_max_io_Àn
(
m≠
, 
›
, 
m≠_off£t
, &
°rùe_ƒ
,

6536 &
°rùe_off£t
, &
øid56_fuŒ_°rùe_°¨t
);

6537 *
Àngth
 = 
	`mö_t
(
u64
, 
em
->
Àn
 - 
m≠_off£t
, 
max_Àn
);

6539 
	`down_ªad
(&
dev_ª∂a˚
->
rw£m
);

6540 
dev_ª∂a˚_is_⁄goög
 = 
	`båfs_dev_ª∂a˚_is_⁄goög
(
dev_ª∂a˚
);

6545 i‡(!
dev_ª∂a˚_is_⁄goög
)

6546 
	`up_ªad
(&
dev_ª∂a˚
->
rw£m
);

6548 
num_°rùes
 = 1;

6549 
°rùe_ödex
 = 0;

6550 i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID0
) {

6551 
°rùe_ödex
 = 
°rùe_ƒ
 % 
m≠
->
num_°rùes
;

6552 
°rùe_ƒ
 /
m≠
->
num_°rùes
;

6553 i‡(
›
 =
BTRFS_MAP_READ
)

6554 
múr‹_num
 = 1;

6555 } i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID1_MASK
) {

6556 i‡(
›
 !
BTRFS_MAP_READ
) {

6557 
num_°rùes
 = 
m≠
->num_stripes;

6558 } i‡(
múr‹_num
) {

6559 
°rùe_ödex
 = 
múr‹_num
 - 1;

6561 
°rùe_ödex
 = 
	`föd_live_múr‹
(
fs_öfo
, 
m≠
, 0,

6562 
dev_ª∂a˚_is_⁄goög
);

6563 
múr‹_num
 = 
°rùe_ödex
 + 1;

6566 } i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_DUP
) {

6567 i‡(
›
 !
BTRFS_MAP_READ
) {

6568 
num_°rùes
 = 
m≠
->num_stripes;

6569 } i‡(
múr‹_num
) {

6570 
°rùe_ödex
 = 
múr‹_num
 - 1;

6572 
múr‹_num
 = 1;

6575 } i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID10
) {

6576 
u32
 
Á˘‹
 = 
m≠
->
num_°rùes
 / m≠->
sub_°rùes
;

6578 
°rùe_ödex
 = (
°rùe_ƒ
 % 
Á˘‹
Ë* 
m≠
->
sub_°rùes
;

6579 
°rùe_ƒ
 /
Á˘‹
;

6581 i‡(
›
 !
BTRFS_MAP_READ
)

6582 
num_°rùes
 = 
m≠
->
sub_°rùes
;

6583 i‡(
múr‹_num
)

6584 
°rùe_ödex
 +
múr‹_num
 - 1;

6586 
ﬁd_°rùe_ödex
 = 
°rùe_ödex
;

6587 
°rùe_ödex
 = 
	`föd_live_múr‹
(
fs_öfo
, 
m≠
,

6588 
°rùe_ödex
,

6589 
dev_ª∂a˚_is_⁄goög
);

6590 
múr‹_num
 = 
°rùe_ödex
 - 
ﬁd_°rùe_ödex
 + 1;

6593 } i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

6594 i‡(
√ed_øid_m≠
 && (
›
 !
BTRFS_MAP_READ
 || 
múr‹_num
 > 1)) {

6604 
°rùe_ƒ
 /
d©a_°rùes
;

6607 
num_°rùes
 = 
m≠
->num_stripes;

6608 
max_îr‹s
 = 
	`båfs_chunk_max_îr‹s
(
m≠
);

6611 *
Àngth
 = 
	`mö
(
logiˇl
 + *length,

6612 
øid56_fuŒ_°rùe_°¨t
 + 
em
->
°¨t
 +

6613 
	`båfs_°rùe_ƒ_to_off£t
(
d©a_°rùes
)) -

6614 
logiˇl
;

6615 
°rùe_ödex
 = 0;

6616 
°rùe_off£t
 = 0;

6623 
°rùe_ödex
 = 
°rùe_ƒ
 % 
d©a_°rùes
;

6624 
°rùe_ƒ
 /
d©a_°rùes
;

6625 i‡(
múr‹_num
 > 1)

6626 
°rùe_ödex
 = 
d©a_°rùes
 + 
múr‹_num
 - 2;

6629 
°rùe_ödex
 = (
°rùe_ƒ
 + såùe_ödexË% 
m≠
->
num_°rùes
;

6630 i‡(
›
 =
BTRFS_MAP_READ
 && 
múr‹_num
 <= 1)

6631 
múr‹_num
 = 1;

6639 
°rùe_ödex
 = 
°rùe_ƒ
 % 
m≠
->
num_°rùes
;

6640 
°rùe_ƒ
 /
m≠
->
num_°rùes
;

6641 
múr‹_num
 = 
°rùe_ödex
 + 1;

6643 i‡(
°rùe_ödex
 >
m≠
->
num_°rùes
) {

6644 
	`båfs_¸ô
(
fs_öfo
,

6646 
°rùe_ödex
, 
m≠
->
num_°rùes
);

6647 
ªt
 = -
EINVAL
;

6648 
out
;

6651 
num_Æloc_°rùes
 = 
num_°rùes
;

6652 i‡(
dev_ª∂a˚_is_⁄goög
 && 
dev_ª∂a˚
->
tgtdev
 !
NULL
 &&

6653 
›
 !
BTRFS_MAP_READ
)

6661 
num_Æloc_°rùes
 += 2;

6668 i‡(
sm≠
 && 
num_Æloc_°rùes
 == 1 &&

6669 !((
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
Ë&& 
múr‹_num
 > 1)) {

6670 
	`£t_io_°rùe
(
sm≠
, 
m≠
, 
°rùe_ödex
, 
°rùe_off£t
, 
°rùe_ƒ
);

6671 i‡(
múr‹_num_ªt
)

6672 *
múr‹_num_ªt
 = 
múr‹_num
;

6673 *
bioc_ªt
 = 
NULL
;

6674 
ªt
 = 0;

6675 
out
;

6678 
bioc
 = 
	`Æloc_båfs_io_c⁄ãxt
(
fs_öfo
, 
num_Æloc_°rùes
);

6679 i‡(!
bioc
) {

6680 
ªt
 = -
ENOMEM
;

6681 
out
;

6683 
bioc
->
m≠_ty≥
 = 
m≠
->
ty≥
;

6692 i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
 && 
√ed_øid_m≠
 &&

6693 (
›
 !
BTRFS_MAP_READ
 || 
múr‹_num
 > 1)) {

6702 
bioc
->
fuŒ_°rùe_logiˇl
 = 
em
->
°¨t
 +

6703 
	`båfs_°rùe_ƒ_to_off£t
(
°rùe_ƒ
 * 
d©a_°rùes
);

6704 
i
 = 0; i < 
num_°rùes
; i++)

6705 
	`£t_io_°rùe
(&
bioc
->
°rùes
[
i
], 
m≠
,

6706 (
i
 + 
°rùe_ƒ
Ë% 
num_°rùes
,

6707 
°rùe_off£t
, 
°rùe_ƒ
);

6713 
i
 = 0; i < 
num_°rùes
; i++) {

6714 
	`£t_io_°rùe
(&
bioc
->
°rùes
[
i
], 
m≠
, 
°rùe_ödex
,

6715 
°rùe_off£t
, 
°rùe_ƒ
);

6716 
°rùe_ödex
++;

6720 i‡(
›
 !
BTRFS_MAP_READ
)

6721 
max_îr‹s
 = 
	`båfs_chunk_max_îr‹s
(
m≠
);

6723 i‡(
dev_ª∂a˚_is_⁄goög
 && 
dev_ª∂a˚
->
tgtdev
 !
NULL
 &&

6724 
›
 !
BTRFS_MAP_READ
) {

6725 
	`h™dÀ_›s_⁄_dev_ª∂a˚
(
›
, 
bioc
, 
dev_ª∂a˚
, 
logiˇl
,

6726 &
num_°rùes
, &
max_îr‹s
);

6729 *
bioc_ªt
 = 
bioc
;

6730 
bioc
->
num_°rùes
 =Çum_stripes;

6731 
bioc
->
max_îr‹s
 = max_errors;

6732 
bioc
->
múr‹_num
 = mirror_num;

6734 
out
:

6735 i‡(
dev_ª∂a˚_is_⁄goög
) {

6736 
	`lockdï_as£π_hñd
(&
dev_ª∂a˚
->
rw£m
);

6738 
	`up_ªad
(&
dev_ª∂a˚
->
rw£m
);

6740 
	`‰ì_exã¡_m≠
(
em
);

6741  
ªt
;

6742 
	}
}

6744 
boﬁ
 
	$dev_¨gs_m©ch_fs_devi˚s
(c⁄° 
båfs_dev_lookup_¨gs
 *
¨gs
,

6745 c⁄° 
båfs_fs_devi˚s
 *
fs_devi˚s
)

6747 i‡(
¨gs
->
fsid
 =
NULL
)

6748  
åue
;

6749 i‡(
	`memcmp
(
fs_devi˚s
->
mëad©a_uuid
, 
¨gs
->
fsid
, 
BTRFS_FSID_SIZE
) == 0)

6750  
åue
;

6751  
Ál£
;

6752 
	}
}

6754 
boﬁ
 
	$dev_¨gs_m©ch_devi˚
(c⁄° 
båfs_dev_lookup_¨gs
 *
¨gs
,

6755 c⁄° 
båfs_devi˚
 *
devi˚
)

6757 i‡(
¨gs
->
missög
) {

6758 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
devi˚
->
dev_°©e
) &&

6759 !
devi˚
->
bdev
)

6760  
åue
;

6761  
Ál£
;

6764 i‡(
devi˚
->
devid
 !
¨gs
->devid)

6765  
Ál£
;

6766 i‡(
¨gs
->
uuid
 && 
	`memcmp
(
devi˚
->uuid,árgs->uuid, 
BTRFS_UUID_SIZE
) != 0)

6767  
Ál£
;

6768  
åue
;

6769 
	}
}

6778 
båfs_devi˚
 *
	$båfs_föd_devi˚
(c⁄° 
båfs_fs_devi˚s
 *
fs_devi˚s
,

6779 c⁄° 
båfs_dev_lookup_¨gs
 *
¨gs
)

6781 
båfs_devi˚
 *
devi˚
;

6782 
båfs_fs_devi˚s
 *
£ed_devs
;

6784 i‡(
	`dev_¨gs_m©ch_fs_devi˚s
(
¨gs
, 
fs_devi˚s
)) {

6785 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

6786 i‡(
	`dev_¨gs_m©ch_devi˚
(
¨gs
, 
devi˚
))

6787  
devi˚
;

6791 
	`li°_f‹_óch_íåy
(
£ed_devs
, &
fs_devi˚s
->
£ed_li°
, seed_list) {

6792 i‡(!
	`dev_¨gs_m©ch_fs_devi˚s
(
¨gs
, 
£ed_devs
))

6794 
	`li°_f‹_óch_íåy
(
devi˚
, &
£ed_devs
->
devi˚s
, 
dev_li°
) {

6795 i‡(
	`dev_¨gs_m©ch_devi˚
(
¨gs
, 
devi˚
))

6796  
devi˚
;

6800  
NULL
;

6801 
	}
}

6803 
båfs_devi˚
 *
	$add_missög_dev
(
båfs_fs_devi˚s
 *
fs_devi˚s
,

6804 
u64
 
devid
, 
u8
 *
dev_uuid
)

6806 
båfs_devi˚
 *
devi˚
;

6807 
nofs_Êag
;

6816 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

6817 
devi˚
 = 
	`båfs_Æloc_devi˚
(
NULL
, &
devid
, 
dev_uuid
, NULL);

6818 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

6819 i‡(
	`IS_ERR
(
devi˚
))

6820  
devi˚
;

6822 
	`li°_add
(&
devi˚
->
dev_li°
, &
fs_devi˚s
->
devi˚s
);

6823 
devi˚
->
fs_devi˚s
 = fs_devices;

6824 
fs_devi˚s
->
num_devi˚s
++;

6826 
	`£t_bô
(
BTRFS_DEV_STATE_MISSING
, &
devi˚
->
dev_°©e
);

6827 
fs_devi˚s
->
missög_devi˚s
++;

6829  
devi˚
;

6830 
	}
}

6847 
båfs_devi˚
 *
	$båfs_Æloc_devi˚
(
båfs_fs_öfo
 *
fs_öfo
,

6848 c⁄° 
u64
 *
devid
, c⁄° 
u8
 *
uuid
,

6849 c⁄° *
∑th
)

6851 
båfs_devi˚
 *
dev
;

6852 
u64
 
tmp
;

6854 i‡(
	`WARN_ON
(!
devid
 && !
fs_öfo
))

6855  
	`ERR_PTR
(-
EINVAL
);

6857 
dev
 = 
	`kzÆloc
((*dev), 
GFP_KERNEL
);

6858 i‡(!
dev
)

6859  
	`ERR_PTR
(-
ENOMEM
);

6861 
	`INIT_LIST_HEAD
(&
dev
->
dev_li°
);

6862 
	`INIT_LIST_HEAD
(&
dev
->
dev_Æloc_li°
);

6863 
	`INIT_LIST_HEAD
(&
dev
->
po°_commô_li°
);

6865 
	`©omic_£t
(&
dev
->
dev_°©s_c˙t
, 0);

6866 
	`båfs_devi˚_d©a_‹dîed_öô
(
dev
);

6867 
	`exã¡_io_åì_öô
(
fs_öfo
, &
dev
->
Æloc_°©e
, 
IO_TREE_DEVICE_ALLOC_STATE
);

6869 i‡(
devid
)

6870 
tmp
 = *
devid
;

6872 
ªt
;

6874 
ªt
 = 
	`föd_√xt_devid
(
fs_öfo
, &
tmp
);

6875 i‡(
ªt
) {

6876 
	`båfs_‰ì_devi˚
(
dev
);

6877  
	`ERR_PTR
(
ªt
);

6880 
dev
->
devid
 = 
tmp
;

6882 i‡(
uuid
)

6883 
	`mem˝y
(
dev
->
uuid
, uuid, 
BTRFS_UUID_SIZE
);

6885 
	`gíî©e_øndom_uuid
(
dev
->
uuid
);

6887 i‡(
∑th
) {

6888 
rcu_°rög
 *
«me
;

6890 
«me
 = 
	`rcu_°rög_°rdup
(
∑th
, 
GFP_KERNEL
);

6891 i‡(!
«me
) {

6892 
	`båfs_‰ì_devi˚
(
dev
);

6893  
	`ERR_PTR
(-
ENOMEM
);

6895 
	`rcu_assign_poöãr
(
dev
->
«me
,Çame);

6898  
dev
;

6899 
	}
}

6901 
	$båfs_ªp‹t_missög_devi˚
(
båfs_fs_öfo
 *
fs_öfo
,

6902 
u64
 
devid
, 
u8
 *
uuid
, 
boﬁ
 
îr‹
)

6904 i‡(
îr‹
)

6905 
	`båfs_îr_æ
(
fs_öfo
, "devid %llu uuid %pU is missing",

6906 
devid
, 
uuid
);

6908 
	`båfs_w¨n_æ
(
fs_öfo
, "devid %llu uuid %pU is missing",

6909 
devid
, 
uuid
);

6910 
	}
}

6912 
u64
 
	$båfs_ˇlc_°rùe_Àngth
(c⁄° 
exã¡_m≠
 *
em
)

6914 c⁄° 
m≠_lookup
 *
m≠
 = 
em
->map_lookup;

6915 c⁄° 
d©a_°rùes
 = 
	`ˇlc_d©a_°rùes
(
m≠
->
ty≥
, m≠->
num_°rùes
);

6917  
	`div_u64
(
em
->
Àn
, 
d©a_°rùes
);

6918 
	}
}

6920 #i‡
BITS_PER_LONG
 == 32

6928 
	$check_32bô_mëa_chunk
(
båfs_fs_öfo
 *
fs_öfo
,

6929 
u64
 
logiˇl
, u64 
Àngth
, u64 
ty≥
)

6931 i‡(!(
ty≥
 & 
BTRFS_BLOCK_GROUP_METADATA
))

6934 i‡(
logiˇl
 + 
Àngth
 < 
MAX_LFS_FILESIZE
)

6937 
	`båfs_îr_32bô_limô
(
fs_öfo
);

6938  -
EOVERFLOW
;

6939 
	}
}

6947 
	$w¨n_32bô_mëa_chunk
(
båfs_fs_öfo
 *
fs_öfo
,

6948 
u64
 
logiˇl
, u64 
Àngth
, u64 
ty≥
)

6950 i‡(!(
ty≥
 & 
BTRFS_BLOCK_GROUP_METADATA
))

6953 i‡(
logiˇl
 + 
Àngth
 < 
BTRFS_32BIT_EARLY_WARN_THRESHOLD
)

6956 
	`båfs_w¨n_32bô_limô
(
fs_öfo
);

6957 
	}
}

6960 
båfs_devi˚
 *
	$h™dÀ_missög_devi˚
(
båfs_fs_öfo
 *
fs_öfo
,

6961 
u64
 
devid
, 
u8
 *
uuid
)

6963 
båfs_devi˚
 *
dev
;

6965 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
DEGRADED
)) {

6966 
	`båfs_ªp‹t_missög_devi˚
(
fs_öfo
, 
devid
, 
uuid
, 
åue
);

6967  
	`ERR_PTR
(-
ENOENT
);

6970 
dev
 = 
	`add_missög_dev
(
fs_öfo
->
fs_devi˚s
, 
devid
, 
uuid
);

6971 i‡(
	`IS_ERR
(
dev
)) {

6972 
	`båfs_îr
(
fs_öfo
, "failedÅo init missing device %llu: %ld",

6973 
devid
, 
	`PTR_ERR
(
dev
));

6974  
dev
;

6976 
	`båfs_ªp‹t_missög_devi˚
(
fs_öfo
, 
devid
, 
uuid
, 
Ál£
);

6978  
dev
;

6979 
	}
}

6981 
	$ªad_⁄e_chunk
(
båfs_key
 *
key
, 
exã¡_buf„r
 *
Àaf
,

6982 
båfs_chunk
 *
chunk
)

6984 
	`BTRFS_DEV_LOOKUP_ARGS
(
¨gs
);

6985 
båfs_fs_öfo
 *
fs_öfo
 = 
Àaf
->fs_info;

6986 
exã¡_m≠_åì
 *
m≠_åì
 = &
fs_öfo
->
m≠pög_åì
;

6987 
m≠_lookup
 *
m≠
;

6988 
exã¡_m≠
 *
em
;

6989 
u64
 
logiˇl
;

6990 
u64
 
Àngth
;

6991 
u64
 
devid
;

6992 
u64
 
ty≥
;

6993 
u8
 
uuid
[
BTRFS_UUID_SIZE
];

6994 
ödex
;

6995 
num_°rùes
;

6996 
ªt
;

6997 
i
;

6999 
logiˇl
 = 
key
->
off£t
;

7000 
Àngth
 = 
	`båfs_chunk_Àngth
(
Àaf
, 
chunk
);

7001 
ty≥
 = 
	`båfs_chunk_ty≥
(
Àaf
, 
chunk
);

7002 
ödex
 = 
	`båfs_bg_Êags_to_øid_ödex
(
ty≥
);

7003 
num_°rùes
 = 
	`båfs_chunk_num_°rùes
(
Àaf
, 
chunk
);

7005 #i‡
BITS_PER_LONG
 == 32

7006 
ªt
 = 
	`check_32bô_mëa_chunk
(
fs_öfo
, 
logiˇl
, 
Àngth
, 
ty≥
);

7007 i‡(
ªt
 < 0)

7008  
ªt
;

7009 
	`w¨n_32bô_mëa_chunk
(
fs_öfo
, 
logiˇl
, 
Àngth
, 
ty≥
);

7016 i‡(
Àaf
->
°¨t
 =
BTRFS_SUPER_INFO_OFFSET
) {

7017 
ªt
 = 
	`båfs_check_chunk_vÆid
(
Àaf
, 
chunk
, 
logiˇl
);

7018 i‡(
ªt
)

7019  
ªt
;

7022 
	`ªad_lock
(&
m≠_åì
->
lock
);

7023 
em
 = 
	`lookup_exã¡_m≠pög
(
m≠_åì
, 
logiˇl
, 1);

7024 
	`ªad_u∆ock
(&
m≠_åì
->
lock
);

7027 i‡(
em
 &&Ém->
°¨t
 <
logiˇl
 &&Ém->°¨à+Ém->
Àn
 >Üogical) {

7028 
	`‰ì_exã¡_m≠
(
em
);

7030 } i‡(
em
) {

7031 
	`‰ì_exã¡_m≠
(
em
);

7034 
em
 = 
	`Æloc_exã¡_m≠
();

7035 i‡(!
em
)

7036  -
ENOMEM
;

7037 
m≠
 = 
	`kmÆloc
(
	`m≠_lookup_size
(
num_°rùes
), 
GFP_NOFS
);

7038 i‡(!
m≠
) {

7039 
	`‰ì_exã¡_m≠
(
em
);

7040  -
ENOMEM
;

7043 
	`£t_bô
(
EXTENT_FLAG_FS_MAPPING
, &
em
->
Êags
);

7044 
em
->
m≠_lookup
 = 
m≠
;

7045 
em
->
°¨t
 = 
logiˇl
;

7046 
em
->
Àn
 = 
Àngth
;

7047 
em
->
‹ig_°¨t
 = 0;

7048 
em
->
block_°¨t
 = 0;

7049 
em
->
block_Àn
 =Ém->
Àn
;

7051 
m≠
->
num_°rùes
 =Çum_stripes;

7052 
m≠
->
io_width
 = 
	`båfs_chunk_io_width
(
Àaf
, 
chunk
);

7053 
m≠
->
io_Æign
 = 
	`båfs_chunk_io_Æign
(
Àaf
, 
chunk
);

7054 
m≠
->
ty≥
 =Åype;

7063 
m≠
->
sub_°rùes
 = 
båfs_øid_¨øy
[
ödex
].sub_stripes;

7064 
m≠
->
vîifõd_°rùes
 = 0;

7065 
em
->
‹ig_block_Àn
 = 
	`båfs_ˇlc_°rùe_Àngth
(em);

7066 
i
 = 0; i < 
num_°rùes
; i++) {

7067 
m≠
->
°rùes
[
i
].
physiˇl
 =

7068 
	`båfs_°rùe_off£t_ƒ
(
Àaf
, 
chunk
, 
i
);

7069 
devid
 = 
	`båfs_°rùe_devid_ƒ
(
Àaf
, 
chunk
, 
i
);

7070 
¨gs
.
devid
 = devid;

7071 
	`ªad_exã¡_buf„r
(
Àaf
, 
uuid
, ()

7072 
	`båfs_°rùe_dev_uuid_ƒ
(
chunk
, 
i
),

7073 
BTRFS_UUID_SIZE
);

7074 
¨gs
.
uuid
 = uuid;

7075 
m≠
->
°rùes
[
i
].
dev
 = 
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, &
¨gs
);

7076 i‡(!
m≠
->
°rùes
[
i
].
dev
) {

7077 
m≠
->
°rùes
[
i
].
dev
 = 
	`h™dÀ_missög_devi˚
(
fs_öfo
,

7078 
devid
, 
uuid
);

7079 i‡(
	`IS_ERR
(
m≠
->
°rùes
[
i
].
dev
)) {

7080 
ªt
 = 
	`PTR_ERR
(
m≠
->
°rùes
[
i
].
dev
);

7081 
	`‰ì_exã¡_m≠
(
em
);

7082  
ªt
;

7086 
	`£t_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
,

7087 &(
m≠
->
°rùes
[
i
].
dev
->
dev_°©e
));

7090 
	`wrôe_lock
(&
m≠_åì
->
lock
);

7091 
ªt
 = 
	`add_exã¡_m≠pög
(
m≠_åì
, 
em
, 0);

7092 
	`wrôe_u∆ock
(&
m≠_åì
->
lock
);

7093 i‡(
ªt
 < 0) {

7094 
	`båfs_îr
(
fs_öfo
,

7096 
em
->
°¨t
,Ém->
Àn
, 
ªt
);

7098 
	`‰ì_exã¡_m≠
(
em
);

7100  
ªt
;

7101 
	}
}

7103 
	$fûl_devi˚_‰om_ôem
(
exã¡_buf„r
 *
Àaf
,

7104 
båfs_dev_ôem
 *
dev_ôem
,

7105 
båfs_devi˚
 *
devi˚
)

7107 
±r
;

7109 
devi˚
->
devid
 = 
	`båfs_devi˚_id
(
Àaf
, 
dev_ôem
);

7110 
devi˚
->
disk_tŸÆ_byãs
 = 
	`båfs_devi˚_tŸÆ_byãs
(
Àaf
, 
dev_ôem
);

7111 
devi˚
->
tŸÆ_byãs
 = devi˚->
disk_tŸÆ_byãs
;

7112 
devi˚
->
commô_tŸÆ_byãs
 = devi˚->
disk_tŸÆ_byãs
;

7113 
devi˚
->
byãs_u£d
 = 
	`båfs_devi˚_byãs_u£d
(
Àaf
, 
dev_ôem
);

7114 
devi˚
->
commô_byãs_u£d
 = devi˚->
byãs_u£d
;

7115 
devi˚
->
ty≥
 = 
	`båfs_devi˚_ty≥
(
Àaf
, 
dev_ôem
);

7116 
devi˚
->
io_Æign
 = 
	`båfs_devi˚_io_Æign
(
Àaf
, 
dev_ôem
);

7117 
devi˚
->
io_width
 = 
	`båfs_devi˚_io_width
(
Àaf
, 
dev_ôem
);

7118 
devi˚
->
£˘‹_size
 = 
	`båfs_devi˚_£˘‹_size
(
Àaf
, 
dev_ôem
);

7119 
	`WARN_ON
(
devi˚
->
devid
 =
BTRFS_DEV_REPLACE_DEVID
);

7120 
	`˛ór_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
);

7122 
±r
 = 
	`båfs_devi˚_uuid
(
dev_ôem
);

7123 
	`ªad_exã¡_buf„r
(
Àaf
, 
devi˚
->
uuid
, 
±r
, 
BTRFS_UUID_SIZE
);

7124 
	}
}

7127 
	$fûl_devi˚_‰om_ôem_∑πôi⁄
(
exã¡_buf„r
 *
Àaf
,

7128 
båfs_dev_ôem
 *
dev_ôem
,

7129 
båfs_devi˚
 *
devi˚
, 
∑πôi⁄_‹dî
)

7131 
±r
;

7133 
devi˚
->
devid
 = 
	`båfs_devi˚_id
(
Àaf
, 
dev_ôem
);

7134 
devi˚
->
disk_tŸÆ_byãs
 = 
	`båfs_devi˚_tŸÆ_byãs
(
Àaf
, 
dev_ôem
);

7136 
devi˚
->
∑πôi⁄_°¨t
 = devi˚->
disk_tŸÆ_byãs
*
∑πôi⁄_‹dî
;

7137 
devi˚
->
∑πôi⁄_íd
 = devi˚->
disk_tŸÆ_byãs
*(
∑πôi⁄_‹dî
+1);

7139 
devi˚
->
tŸÆ_byãs
 = devi˚->
disk_tŸÆ_byãs
;

7141 
devi˚
->
commô_tŸÆ_byãs
 = devi˚->
disk_tŸÆ_byãs
;

7142 
devi˚
->
byãs_u£d
 = 
	`båfs_devi˚_byãs_u£d
(
Àaf
, 
dev_ôem
);

7143 
devi˚
->
commô_byãs_u£d
 = devi˚->
byãs_u£d
;

7144 
devi˚
->
ty≥
 = 
	`båfs_devi˚_ty≥
(
Àaf
, 
dev_ôem
);

7145 
devi˚
->
io_Æign
 = 
	`båfs_devi˚_io_Æign
(
Àaf
, 
dev_ôem
);

7146 
devi˚
->
io_width
 = 
	`båfs_devi˚_io_width
(
Àaf
, 
dev_ôem
);

7147 
devi˚
->
£˘‹_size
 = 
	`båfs_devi˚_£˘‹_size
(
Àaf
, 
dev_ôem
);

7148 
	`WARN_ON
(
devi˚
->
devid
 =
BTRFS_DEV_REPLACE_DEVID
);

7149 
	`˛ór_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
);

7151 
±r
 = 
	`båfs_devi˚_uuid
(
dev_ôem
);

7152 
	`ªad_exã¡_buf„r
(
Àaf
, 
devi˚
->
uuid
, 
±r
, 
BTRFS_UUID_SIZE
);

7153 
	}
}

7155 
båfs_fs_devi˚s
 *
	$›í_£ed_devi˚s
(
båfs_fs_öfo
 *
fs_öfo
,

7156 
u8
 *
fsid
)

7158 
båfs_fs_devi˚s
 *
fs_devi˚s
;

7159 
ªt
;

7161 
	`lockdï_as£π_hñd
(&
uuid_muãx
);

7162 
	`ASSERT
(
fsid
);

7165 
	`li°_f‹_óch_íåy
(
fs_devi˚s
, &
fs_öfo
->fs_devi˚s->
£ed_li°
, seed_list)

7166 i‡(!
	`memcmp
(
fs_devi˚s
->
fsid
, fsid, 
BTRFS_FSID_SIZE
))

7167  
fs_devi˚s
;

7170 
fs_devi˚s
 = 
	`föd_fsid
(
fsid
, 
NULL
);

7171 i‡(!
fs_devi˚s
) {

7172 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
DEGRADED
))

7173  
	`ERR_PTR
(-
ENOENT
);

7175 
fs_devi˚s
 = 
	`Æloc_fs_devi˚s
(
fsid
, 
NULL
);

7176 i‡(
	`IS_ERR
(
fs_devi˚s
))

7177  
fs_devi˚s
;

7179 
fs_devi˚s
->
£edög
 = 
åue
;

7180 
fs_devi˚s
->
›íed
 = 1;

7181  
fs_devi˚s
;

7188 
fs_devi˚s
 = 
	`˛⁄e_fs_devi˚s
(fs_devices);

7189 i‡(
	`IS_ERR
(
fs_devi˚s
))

7190  
fs_devi˚s
;

7192 
ªt
 = 
	`›í_fs_devi˚s
(
fs_devi˚s
, 
BLK_OPEN_READ
, 
fs_öfo
->
bdev_hﬁdî
);

7193 i‡(
ªt
) {

7194 
	`‰ì_fs_devi˚s
(
fs_devi˚s
);

7195  
	`ERR_PTR
(
ªt
);

7198 i‡(!
fs_devi˚s
->
£edög
) {

7199 
	`˛o£_fs_devi˚s
(
fs_devi˚s
);

7200 
	`‰ì_fs_devi˚s
(
fs_devi˚s
);

7201  
	`ERR_PTR
(-
EINVAL
);

7204 
	`li°_add
(&
fs_devi˚s
->
£ed_li°
, &
fs_öfo
->fs_devices->seed_list);

7206  
fs_devi˚s
;

7207 
	}
}

7209 
	$ªad_⁄e_dev
(
exã¡_buf„r
 *
Àaf
,

7210 
båfs_dev_ôem
 *
dev_ôem
)

7212 
	`BTRFS_DEV_LOOKUP_ARGS
(
¨gs
);

7213 
båfs_fs_öfo
 *
fs_öfo
 = 
Àaf
->fs_info;

7214 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

7215 
båfs_devi˚
 *
devi˚
;

7216 
u64
 
devid
;

7217 
ªt
;

7218 
u8
 
fs_uuid
[
BTRFS_FSID_SIZE
];

7219 
u8
 
dev_uuid
[
BTRFS_UUID_SIZE
];

7221 
devid
 = 
	`båfs_devi˚_id
(
Àaf
, 
dev_ôem
);

7222 
¨gs
.
devid
 = devid;

7223 
	`ªad_exã¡_buf„r
(
Àaf
, 
dev_uuid
, 
	`båfs_devi˚_uuid
(
dev_ôem
),

7224 
BTRFS_UUID_SIZE
);

7225 
	`ªad_exã¡_buf„r
(
Àaf
, 
fs_uuid
, 
	`båfs_devi˚_fsid
(
dev_ôem
),

7226 
BTRFS_FSID_SIZE
);

7227 
¨gs
.
uuid
 = 
dev_uuid
;

7228 
¨gs
.
fsid
 = 
fs_uuid
;

7230 i‡(
	`memcmp
(
fs_uuid
, 
fs_devi˚s
->
mëad©a_uuid
, 
BTRFS_FSID_SIZE
)) {

7231 
fs_devi˚s
 = 
	`›í_£ed_devi˚s
(
fs_öfo
, 
fs_uuid
);

7232 i‡(
	`IS_ERR
(
fs_devi˚s
))

7233  
	`PTR_ERR
(
fs_devi˚s
);

7236 
devi˚
 = 
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, &
¨gs
);

7237 i‡(!
devi˚
) {

7238 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
DEGRADED
)) {

7239 
	`båfs_ªp‹t_missög_devi˚
(
fs_öfo
, 
devid
,

7240 
dev_uuid
, 
åue
);

7241  -
ENOENT
;

7244 
devi˚
 = 
	`add_missög_dev
(
fs_devi˚s
, 
devid
, 
dev_uuid
);

7245 i‡(
	`IS_ERR
(
devi˚
)) {

7246 
	`båfs_îr
(
fs_öfo
,

7248 
devid
, 
	`PTR_ERR
(
devi˚
));

7249  
	`PTR_ERR
(
devi˚
);

7251 
	`båfs_ªp‹t_missög_devi˚
(
fs_öfo
, 
devid
, 
dev_uuid
, 
Ál£
);

7253 i‡(!
devi˚
->
bdev
) {

7254 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
DEGRADED
)) {

7255 
	`båfs_ªp‹t_missög_devi˚
(
fs_öfo
,

7256 
devid
, 
dev_uuid
, 
åue
);

7257  -
ENOENT
;

7259 
	`båfs_ªp‹t_missög_devi˚
(
fs_öfo
, 
devid
,

7260 
dev_uuid
, 
Ál£
);

7263 i‡(!
devi˚
->
bdev
 &&

7264 !
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
, &
devi˚
->
dev_°©e
)) {

7271 
devi˚
->
fs_devi˚s
->
missög_devi˚s
++;

7272 
	`£t_bô
(
BTRFS_DEV_STATE_MISSING
, &
devi˚
->
dev_°©e
);

7276 i‡(
devi˚
->
fs_devi˚s
 != fs_devices) {

7277 
	`ASSERT
(
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
,

7278 &
devi˚
->
dev_°©e
));

7280 
	`li°_move
(&
devi˚
->
dev_li°
, &
fs_devi˚s
->
devi˚s
);

7281 
devi˚
->
fs_devi˚s
->
num_devi˚s
--;

7282 
fs_devi˚s
->
num_devi˚s
++;

7284 
devi˚
->
fs_devi˚s
->
missög_devi˚s
--;

7285 
fs_devi˚s
->
missög_devi˚s
++;

7287 
devi˚
->
fs_devi˚s
 = fs_devices;

7291 i‡(
devi˚
->
fs_devi˚s
 !
fs_öfo
->fs_devices) {

7292 
	`BUG_ON
(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
));

7293 i‡(
devi˚
->
gíî©i⁄
 !=

7294 
	`båfs_devi˚_gíî©i⁄
(
Àaf
, 
dev_ôem
))

7295  -
EINVAL
;

7298 
	`fûl_devi˚_‰om_ôem
(
Àaf
, 
dev_ôem
, 
devi˚
);

7299 i‡(
devi˚
->
bdev
) {

7300 
u64
 
max_tŸÆ_byãs
 = 
	`bdev_ƒ_byãs
(
devi˚
->
bdev
);

7302 i‡(
devi˚
->
tŸÆ_byãs
 > 
max_tŸÆ_byãs
) {

7303 
	`båfs_îr
(
fs_öfo
,

7305 
max_tŸÆ_byãs
, 
devi˚
->
tŸÆ_byãs
);

7306  -
EINVAL
;

7309 
	`£t_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
devi˚
->
dev_°©e
);

7310 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
) &&

7311 !
	`ã°_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
)) {

7312 
devi˚
->
fs_devi˚s
->
tŸÆ_rw_byãs
 +devi˚->
tŸÆ_byãs
;

7313 
	`©omic64_add
(
devi˚
->
tŸÆ_byãs
 - devi˚->
byãs_u£d
,

7314 &
fs_öfo
->
‰ì_chunk_•a˚
);

7316 
ªt
 = 0;

7317  
ªt
;

7318 
	}
}

7321 
	$ªad_⁄e_dev_∑πôi⁄
(
exã¡_buf„r
 *
Àaf
,

7322 
båfs_dev_ôem
 *
dev_ôem
, 
∑πôi⁄_‹dî
)

7324 
	`BTRFS_DEV_LOOKUP_ARGS
(
¨gs
);

7325 
båfs_fs_öfo
 *
fs_öfo
 = 
Àaf
->fs_info;

7326 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

7327 
båfs_devi˚
 *
devi˚
;

7328 
u64
 
devid
;

7329 
ªt
;

7330 
u8
 
fs_uuid
[
BTRFS_FSID_SIZE
];

7331 
u8
 
dev_uuid
[
BTRFS_UUID_SIZE
];

7333 
devid
 = 
	`båfs_devi˚_id
(
Àaf
, 
dev_ôem
);

7334 
¨gs
.
devid
 = devid;

7335 
	`ªad_exã¡_buf„r
(
Àaf
, 
dev_uuid
, 
	`båfs_devi˚_uuid
(
dev_ôem
),

7336 
BTRFS_UUID_SIZE
);

7337 
	`ªad_exã¡_buf„r
(
Àaf
, 
fs_uuid
, 
	`båfs_devi˚_fsid
(
dev_ôem
),

7338 
BTRFS_FSID_SIZE
);

7339 
¨gs
.
uuid
 = 
dev_uuid
;

7340 
¨gs
.
fsid
 = 
fs_uuid
;

7342 i‡(
	`memcmp
(
fs_uuid
, 
fs_devi˚s
->
mëad©a_uuid
, 
BTRFS_FSID_SIZE
)) {

7343 
fs_devi˚s
 = 
	`›í_£ed_devi˚s
(
fs_öfo
, 
fs_uuid
);

7344 i‡(
	`IS_ERR
(
fs_devi˚s
))

7345  
	`PTR_ERR
(
fs_devi˚s
);

7348 
devi˚
 = 
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, &
¨gs
);

7349 i‡(!
devi˚
) {

7350 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
DEGRADED
)) {

7351 
	`båfs_ªp‹t_missög_devi˚
(
fs_öfo
, 
devid
,

7352 
dev_uuid
, 
åue
);

7353  -
ENOENT
;

7356 
devi˚
 = 
	`add_missög_dev
(
fs_devi˚s
, 
devid
, 
dev_uuid
);

7357 i‡(
	`IS_ERR
(
devi˚
)) {

7358 
	`båfs_îr
(
fs_öfo
,

7360 
devid
, 
	`PTR_ERR
(
devi˚
));

7361  
	`PTR_ERR
(
devi˚
);

7363 
	`båfs_ªp‹t_missög_devi˚
(
fs_öfo
, 
devid
, 
dev_uuid
, 
Ál£
);

7365 i‡(!
devi˚
->
bdev
) {

7366 i‡(!
	`båfs_ã°_›t
(
fs_öfo
, 
DEGRADED
)) {

7367 
	`båfs_ªp‹t_missög_devi˚
(
fs_öfo
,

7368 
devid
, 
dev_uuid
, 
åue
);

7369  -
ENOENT
;

7371 
	`båfs_ªp‹t_missög_devi˚
(
fs_öfo
, 
devid
,

7372 
dev_uuid
, 
Ál£
);

7375 i‡(!
devi˚
->
bdev
 &&

7376 !
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
, &
devi˚
->
dev_°©e
)) {

7383 
devi˚
->
fs_devi˚s
->
missög_devi˚s
++;

7384 
	`£t_bô
(
BTRFS_DEV_STATE_MISSING
, &
devi˚
->
dev_°©e
);

7388 i‡(
devi˚
->
fs_devi˚s
 != fs_devices) {

7389 
	`ASSERT
(
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
,

7390 &
devi˚
->
dev_°©e
));

7392 
	`li°_move
(&
devi˚
->
dev_li°
, &
fs_devi˚s
->
devi˚s
);

7393 
devi˚
->
fs_devi˚s
->
num_devi˚s
--;

7394 
fs_devi˚s
->
num_devi˚s
++;

7396 
devi˚
->
fs_devi˚s
->
missög_devi˚s
--;

7397 
fs_devi˚s
->
missög_devi˚s
++;

7399 
devi˚
->
fs_devi˚s
 = fs_devices;

7403 i‡(
devi˚
->
fs_devi˚s
 !
fs_öfo
->fs_devices) {

7404 
	`BUG_ON
(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
));

7405 i‡(
devi˚
->
gíî©i⁄
 !=

7406 
	`båfs_devi˚_gíî©i⁄
(
Àaf
, 
dev_ôem
))

7407  -
EINVAL
;

7410 
	`fûl_devi˚_‰om_ôem_∑πôi⁄
(
Àaf
, 
dev_ôem
, 
devi˚
, 
∑πôi⁄_‹dî
);

7411 i‡(
devi˚
->
bdev
) {

7412 
u64
 
max_tŸÆ_byãs
 = 
	`bdev_ƒ_byãs
(
devi˚
->
bdev
);

7414 i‡(
devi˚
->
tŸÆ_byãs
 > 
max_tŸÆ_byãs
) {

7415 
	`båfs_îr
(
fs_öfo
,

7417 
max_tŸÆ_byãs
, 
devi˚
->
tŸÆ_byãs
);

7418  -
EINVAL
;

7421 
	`£t_bô
(
BTRFS_DEV_STATE_IN_FS_METADATA
, &
devi˚
->
dev_°©e
);

7422 i‡(
	`ã°_bô
(
BTRFS_DEV_STATE_WRITEABLE
, &
devi˚
->
dev_°©e
) &&

7423 !
	`ã°_bô
(
BTRFS_DEV_STATE_REPLACE_TGT
, &
devi˚
->
dev_°©e
)) {

7424 
devi˚
->
fs_devi˚s
->
tŸÆ_rw_byãs
 +devi˚->
tŸÆ_byãs
;

7425 
	`©omic64_add
(
devi˚
->
tŸÆ_byãs
 - devi˚->
byãs_u£d
,

7426 &
fs_öfo
->
‰ì_chunk_•a˚
);

7428 
ªt
 = 0;

7429  
ªt
;

7430 
	}
}

7432 
	$båfs_ªad_sys_¨øy
(
båfs_fs_öfo
 *
fs_öfo
)

7434 
båfs_su≥r_block
 *
su≥r_c›y
 = 
fs_öfo
->super_copy;

7435 
exã¡_buf„r
 *
sb
;

7436 
båfs_disk_key
 *
disk_key
;

7437 
båfs_chunk
 *
chunk
;

7438 
u8
 *
¨øy_±r
;

7439 
sb_¨øy_off£t
;

7440 
ªt
 = 0;

7441 
u32
 
num_°rùes
;

7442 
u32
 
¨øy_size
;

7443 
u32
 
Àn
 = 0;

7444 
u32
 
cur_off£t
;

7445 
u64
 
ty≥
;

7446 
båfs_key
 
key
;

7448 
	`ASSERT
(
BTRFS_SUPER_INFO_SIZE
 <
fs_öfo
->
nodesize
);

7455 
sb
 = 
	`Æloc_dummy_exã¡_buf„r
(
fs_öfo
, 
BTRFS_SUPER_INFO_OFFSET
);

7456 i‡(!
sb
)

7457  -
ENOMEM
;

7458 
	`£t_exã¡_buf„r_u±od©e
(
sb
);

7460 
	`wrôe_exã¡_buf„r
(
sb
, 
su≥r_c›y
, 0, 
BTRFS_SUPER_INFO_SIZE
);

7461 
¨øy_size
 = 
	`båfs_su≥r_sys_¨øy_size
(
su≥r_c›y
);

7463 
¨øy_±r
 = 
su≥r_c›y
->
sys_chunk_¨øy
;

7464 
sb_¨øy_off£t
 = 
	`off£tof
(
båfs_su≥r_block
, 
sys_chunk_¨øy
);

7465 
cur_off£t
 = 0;

7467 
cur_off£t
 < 
¨øy_size
) {

7468 
disk_key
 = (
båfs_disk_key
 *)
¨øy_±r
;

7469 
Àn
 = (*
disk_key
);

7470 i‡(
cur_off£t
 + 
Àn
 > 
¨øy_size
)

7471 
out_sh‹t_ªad
;

7473 
	`båfs_disk_key_to_˝u
(&
key
, 
disk_key
);

7475 
¨øy_±r
 +
Àn
;

7476 
sb_¨øy_off£t
 +
Àn
;

7477 
cur_off£t
 +
Àn
;

7479 i‡(
key
.
ty≥
 !
BTRFS_CHUNK_ITEM_KEY
) {

7480 
	`båfs_îr
(
fs_öfo
,

7482 (
u32
)
key
.
ty≥
, 
cur_off£t
);

7483 
ªt
 = -
EIO
;

7487 
chunk
 = (
båfs_chunk
 *)
sb_¨øy_off£t
;

7492 
Àn
 = 
	`båfs_chunk_ôem_size
(1);

7493 i‡(
cur_off£t
 + 
Àn
 > 
¨øy_size
)

7494 
out_sh‹t_ªad
;

7496 
num_°rùes
 = 
	`båfs_chunk_num_°rùes
(
sb
, 
chunk
);

7497 i‡(!
num_°rùes
) {

7498 
	`båfs_îr
(
fs_öfo
,

7500 
num_°rùes
, 
cur_off£t
);

7501 
ªt
 = -
EIO
;

7505 
ty≥
 = 
	`båfs_chunk_ty≥
(
sb
, 
chunk
);

7506 i‡((
ty≥
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) == 0) {

7507 
	`båfs_îr
(
fs_öfo
,

7509 
ty≥
, 
cur_off£t
);

7510 
ªt
 = -
EIO
;

7514 
Àn
 = 
	`båfs_chunk_ôem_size
(
num_°rùes
);

7515 i‡(
cur_off£t
 + 
Àn
 > 
¨øy_size
)

7516 
out_sh‹t_ªad
;

7518 
ªt
 = 
	`ªad_⁄e_chunk
(&
key
, 
sb
, 
chunk
);

7519 i‡(
ªt
)

7522 
¨øy_±r
 +
Àn
;

7523 
sb_¨øy_off£t
 +
Àn
;

7524 
cur_off£t
 +
Àn
;

7526 
	`˛ór_exã¡_buf„r_u±od©e
(
sb
);

7527 
	`‰ì_exã¡_buf„r_°Æe
(
sb
);

7528  
ªt
;

7530 
out_sh‹t_ªad
:

7531 
	`båfs_îr
(
fs_öfo
, "sys_arrayÅoo shortÅoÑead %u bytesát offset %u",

7532 
Àn
, 
cur_off£t
);

7533 
	`˛ór_exã¡_buf„r_u±od©e
(
sb
);

7534 
	`‰ì_exã¡_buf„r_°Æe
(
sb
);

7535  -
EIO
;

7536 
	}
}

7546 
boﬁ
 
	$båfs_check_rw_degødabÀ
(
båfs_fs_öfo
 *
fs_öfo
,

7547 
båfs_devi˚
 *
Áûög_dev
)

7549 
exã¡_m≠_åì
 *
m≠_åì
 = &
fs_öfo
->
m≠pög_åì
;

7550 
exã¡_m≠
 *
em
;

7551 
u64
 
√xt_°¨t
 = 0;

7552 
boﬁ
 
ªt
 = 
åue
;

7554 
	`ªad_lock
(&
m≠_åì
->
lock
);

7555 
em
 = 
	`lookup_exã¡_m≠pög
(
m≠_åì
, 0, (
u64
)-1);

7556 
	`ªad_u∆ock
(&
m≠_åì
->
lock
);

7558 i‡(!
em
) {

7559 
ªt
 = 
Ál£
;

7560 
out
;

7562 
em
) {

7563 
m≠_lookup
 *
m≠
;

7564 
missög
 = 0;

7565 
max_tﬁî©ed
;

7566 
i
;

7568 
m≠
 = 
em
->
m≠_lookup
;

7569 
max_tﬁî©ed
 =

7570 
	`båfs_gë_num_tﬁî©ed_disk_b¨rõr_Áûuªs
(

7571 
m≠
->
ty≥
);

7572 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

7573 
båfs_devi˚
 *
dev
 = 
m≠
->
°rùes
[
i
].dev;

7575 i‡(!
dev
 || !dev->
bdev
 ||

7576 
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
, &
dev
->
dev_°©e
) ||

7577 
dev
->
œ°_Êush_îr‹
)

7578 
missög
++;

7579 i‡(
Áûög_dev
 && faûög_dev =
dev
)

7580 
missög
++;

7582 i‡(
missög
 > 
max_tﬁî©ed
) {

7583 i‡(!
Áûög_dev
)

7584 
	`båfs_w¨n
(
fs_öfo
,

7586 
em
->
°¨t
, 
missög
, 
max_tﬁî©ed
);

7587 
	`‰ì_exã¡_m≠
(
em
);

7588 
ªt
 = 
Ál£
;

7589 
out
;

7591 
√xt_°¨t
 = 
	`exã¡_m≠_íd
(
em
);

7592 
	`‰ì_exã¡_m≠
(
em
);

7594 
	`ªad_lock
(&
m≠_åì
->
lock
);

7595 
em
 = 
	`lookup_exã¡_m≠pög
(
m≠_åì
, 
√xt_°¨t
,

7596 (
u64
)(-1Ë- 
√xt_°¨t
);

7597 
	`ªad_u∆ock
(&
m≠_åì
->
lock
);

7599 
out
:

7600  
ªt
;

7601 
	}
}

7603 
	$ªadahód_åì_node_chûdªn
(
exã¡_buf„r
 *
node
)

7605 
i
;

7606 c⁄° 
ƒ_ôems
 = 
	`båfs_hódî_ƒôems
(
node
);

7608 
i
 = 0; i < 
ƒ_ôems
; i++)

7609 
	`båfs_ªadahód_node_chûd
(
node
, 
i
);

7610 
	}
}

7612 
	$båfs_ªad_chunk_åì
(
båfs_fs_öfo
 *
fs_öfo
)

7614 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
chunk_roŸ
;

7615 
båfs_∑th
 *
∑th
;

7616 
exã¡_buf„r
 *
Àaf
;

7617 
båfs_key
 
key
;

7618 
båfs_key
 
found_key
;

7619 
ªt
;

7620 
¶Ÿ
;

7621 
ôî_ªt
 = 0;

7622 
u64
 
tŸÆ_dev
 = 0;

7623 
u64
 
œ°_ø_node
 = 0;

7625 
∑th
 = 
	`båfs_Æloc_∑th
();

7626 i‡(!
∑th
)

7627  -
ENOMEM
;

7633 
	`muãx_lock
(&
uuid_muãx
);

7641 
fs_öfo
->
fs_devi˚s
->
tŸÆ_rw_byãs
 = 0;

7653 
	`ASSERT
(!
	`ã°_bô
(
BTRFS_FS_OPEN
, &
fs_öfo
->
Êags
));

7654 
∑th
->
skù_lockög
 = 1;

7662 
key
.
obje˘id
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

7663 
key
.
off£t
 = 0;

7664 
key
.
ty≥
 = 0;

7665 
	`båfs_f‹_óch_¶Ÿ
(
roŸ
, &
key
, &
found_key
, 
∑th
, 
ôî_ªt
) {

7666 
exã¡_buf„r
 *
node
 = 
∑th
->
nodes
[1];

7668 
Àaf
 = 
∑th
->
nodes
[0];

7669 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

7671 i‡(
node
) {

7672 i‡(
œ°_ø_node
 !
node
->
°¨t
) {

7673 
	`ªadahód_åì_node_chûdªn
(
node
);

7674 
œ°_ø_node
 = 
node
->
°¨t
;

7677 i‡(
found_key
.
ty≥
 =
BTRFS_DEV_ITEM_KEY
) {

7678 
båfs_dev_ôem
 *
dev_ôem
;

7679 
dev_ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
,

7680 
båfs_dev_ôem
);

7681 
ªt
 = 
	`ªad_⁄e_dev
(
Àaf
, 
dev_ôem
);

7682 i‡(
ªt
)

7683 
îr‹
;

7684 
tŸÆ_dev
++;

7685 } i‡(
found_key
.
ty≥
 =
BTRFS_CHUNK_ITEM_KEY
) {

7686 
båfs_chunk
 *
chunk
;

7696 
chunk
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_chunk
);

7697 
ªt
 = 
	`ªad_⁄e_chunk
(&
found_key
, 
Àaf
, 
chunk
);

7698 i‡(
ªt
)

7699 
îr‹
;

7703 i‡(
ôî_ªt
 < 0) {

7704 
ªt
 = 
ôî_ªt
;

7705 
îr‹
;

7712 i‡(
tŸÆ_dev
 !
fs_öfo
->
fs_devi˚s
->
tŸÆ_devi˚s
) {

7713 
	`båfs_w¨n
(
fs_öfo
,

7715 
	`båfs_su≥r_num_devi˚s
(
fs_öfo
->
su≥r_c›y
),

7716 
tŸÆ_dev
);

7717 
fs_öfo
->
fs_devi˚s
->
tŸÆ_devi˚s
 = 
tŸÆ_dev
;

7718 
	`båfs_£t_su≥r_num_devi˚s
(
fs_öfo
->
su≥r_c›y
, 
tŸÆ_dev
);

7720 i‡(
	`båfs_su≥r_tŸÆ_byãs
(
fs_öfo
->
su≥r_c›y
) <

7721 
fs_öfo
->
fs_devi˚s
->
tŸÆ_rw_byãs
) {

7722 
	`båfs_îr
(
fs_öfo
,

7724 
	`båfs_su≥r_tŸÆ_byãs
(
fs_öfo
->
su≥r_c›y
),

7725 
fs_öfo
->
fs_devi˚s
->
tŸÆ_rw_byãs
);

7726 
ªt
 = -
EINVAL
;

7727 
îr‹
;

7729 
ªt
 = 0;

7730 
îr‹
:

7731 
	`muãx_u∆ock
(&
uuid_muãx
);

7733 
	`båfs_‰ì_∑th
(
∑th
);

7734  
ªt
;

7735 
	}
}

7738 
	$båfs_ªad_chunk_åì_∑πôi⁄
(
båfs_fs_öfo
 *
fs_öfo
, 
∑πôi⁄_‹dî
)

7740 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
chunk_roŸ
;

7741 
båfs_∑th
 *
∑th
;

7742 
exã¡_buf„r
 *
Àaf
;

7743 
båfs_key
 
key
;

7744 
båfs_key
 
found_key
;

7745 
ªt
;

7746 
¶Ÿ
;

7747 
ôî_ªt
 = 0;

7748 
u64
 
tŸÆ_dev
 = 0;

7749 
u64
 
œ°_ø_node
 = 0;

7751 
∑th
 = 
	`båfs_Æloc_∑th
();

7752 i‡(!
∑th
)

7753  -
ENOMEM
;

7759 
	`muãx_lock
(&
uuid_muãx
);

7767 
fs_öfo
->
fs_devi˚s
->
tŸÆ_rw_byãs
 = 0;

7779 
	`ASSERT
(!
	`ã°_bô
(
BTRFS_FS_OPEN
, &
fs_öfo
->
Êags
));

7780 
∑th
->
skù_lockög
 = 1;

7788 
key
.
obje˘id
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

7789 
key
.
off£t
 = 0;

7790 
key
.
ty≥
 = 0;

7791 
	`båfs_f‹_óch_¶Ÿ
(
roŸ
, &
key
, &
found_key
, 
∑th
, 
ôî_ªt
) {

7792 
exã¡_buf„r
 *
node
 = 
∑th
->
nodes
[1];

7794 
Àaf
 = 
∑th
->
nodes
[0];

7795 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

7797 i‡(
node
) {

7798 i‡(
œ°_ø_node
 !
node
->
°¨t
) {

7799 
	`ªadahód_åì_node_chûdªn
(
node
);

7800 
œ°_ø_node
 = 
node
->
°¨t
;

7803 i‡(
found_key
.
ty≥
 =
BTRFS_DEV_ITEM_KEY
) {

7804 
båfs_dev_ôem
 *
dev_ôem
;

7805 
dev_ôem
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
,

7806 
båfs_dev_ôem
);

7807 
ªt
 = 
	`ªad_⁄e_dev_∑πôi⁄
(
Àaf
, 
dev_ôem
, 
∑πôi⁄_‹dî
);

7808 i‡(
ªt
)

7809 
îr‹
;

7810 
tŸÆ_dev
++;

7811 } i‡(
found_key
.
ty≥
 =
BTRFS_CHUNK_ITEM_KEY
) {

7812 
båfs_chunk
 *
chunk
;

7822 
chunk
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_chunk
);

7823 
ªt
 = 
	`ªad_⁄e_chunk
(&
found_key
, 
Àaf
, 
chunk
);

7824 i‡(
ªt
)

7825 
îr‹
;

7829 i‡(
ôî_ªt
 < 0) {

7830 
ªt
 = 
ôî_ªt
;

7831 
îr‹
;

7838 i‡(
tŸÆ_dev
 !
fs_öfo
->
fs_devi˚s
->
tŸÆ_devi˚s
) {

7839 
	`båfs_w¨n
(
fs_öfo
,

7841 
	`båfs_su≥r_num_devi˚s
(
fs_öfo
->
su≥r_c›y
),

7842 
tŸÆ_dev
);

7843 
fs_öfo
->
fs_devi˚s
->
tŸÆ_devi˚s
 = 
tŸÆ_dev
;

7844 
	`båfs_£t_su≥r_num_devi˚s
(
fs_öfo
->
su≥r_c›y
, 
tŸÆ_dev
);

7846 i‡(
	`båfs_su≥r_tŸÆ_byãs
(
fs_öfo
->
su≥r_c›y
) <

7847 
fs_öfo
->
fs_devi˚s
->
tŸÆ_rw_byãs
) {

7848 
	`båfs_îr
(
fs_öfo
,

7850 
	`båfs_su≥r_tŸÆ_byãs
(
fs_öfo
->
su≥r_c›y
),

7851 
fs_öfo
->
fs_devi˚s
->
tŸÆ_rw_byãs
);

7852 
ªt
 = -
EINVAL
;

7853 
îr‹
;

7855 
ªt
 = 0;

7856 
îr‹
:

7857 
	`muãx_u∆ock
(&
uuid_muãx
);

7859 
	`båfs_‰ì_∑th
(
∑th
);

7860  
ªt
;

7861 
	}
}

7863 
	$båfs_öô_devi˚s_œã
(
båfs_fs_öfo
 *
fs_öfo
)

7865 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devi˚s, *
£ed_devs
;

7866 
båfs_devi˚
 *
devi˚
;

7867 
ªt
 = 0;

7869 
fs_devi˚s
->
fs_öfo
 = fs_info;

7871 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

7872 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
)

7873 
devi˚
->
fs_öfo
 = fs_info;

7875 
	`li°_f‹_óch_íåy
(
£ed_devs
, &
fs_devi˚s
->
£ed_li°
, seed_list) {

7876 
	`li°_f‹_óch_íåy
(
devi˚
, &
£ed_devs
->
devi˚s
, 
dev_li°
) {

7877 
devi˚
->
fs_öfo
 = fs_info;

7878 
ªt
 = 
	`båfs_gë_dev_z⁄e_öfo
(
devi˚
, 
Ál£
);

7879 i‡(
ªt
)

7883 
£ed_devs
->
fs_öfo
 = fs_info;

7885 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

7887  
ªt
;

7888 
	}
}

7890 
u64
 
	$båfs_dev_°©s_vÆue
(c⁄° 
exã¡_buf„r
 *
eb
,

7891 c⁄° 
båfs_dev_°©s_ôem
 *
±r
,

7892 
ödex
)

7894 
u64
 
vÆ
;

7896 
	`ªad_exã¡_buf„r
(
eb
, &
vÆ
,

7897 
	`off£tof
(
båfs_dev_°©s_ôem
, 
vÆues
) +

7898 (()
±r
Ë+ (
ödex
 * (
u64
)),

7899 (
vÆ
));

7900  
vÆ
;

7901 
	}
}

7903 
	$båfs_£t_dev_°©s_vÆue
(
exã¡_buf„r
 *
eb
,

7904 
båfs_dev_°©s_ôem
 *
±r
,

7905 
ödex
, 
u64
 
vÆ
)

7907 
	`wrôe_exã¡_buf„r
(
eb
, &
vÆ
,

7908 
	`off£tof
(
båfs_dev_°©s_ôem
, 
vÆues
) +

7909 (()
±r
Ë+ (
ödex
 * (
u64
)),

7910 (
vÆ
));

7911 
	}
}

7913 
	$båfs_devi˚_öô_dev_°©s
(
båfs_devi˚
 *
devi˚
,

7914 
båfs_∑th
 *
∑th
)

7916 
båfs_dev_°©s_ôem
 *
±r
;

7917 
exã¡_buf„r
 *
eb
;

7918 
båfs_key
 
key
;

7919 
ôem_size
;

7920 
i
, 
ªt
, 
¶Ÿ
;

7922 i‡(!
devi˚
->
fs_öfo
->
dev_roŸ
)

7925 
key
.
obje˘id
 = 
BTRFS_DEV_STATS_OBJECTID
;

7926 
key
.
ty≥
 = 
BTRFS_PERSISTENT_ITEM_KEY
;

7927 
key
.
off£t
 = 
devi˚
->
devid
;

7928 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
devi˚
->
fs_öfo
->
dev_roŸ
, &
key
, 
∑th
, 0, 0);

7929 i‡(
ªt
) {

7930 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++)

7931 
	`båfs_dev_°©_£t
(
devi˚
, 
i
, 0);

7932 
devi˚
->
dev_°©s_vÆid
 = 1;

7933 
	`båfs_ªÀa£_∑th
(
∑th
);

7934  
ªt
 < 0 ?Ñet : 0;

7936 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

7937 
eb
 = 
∑th
->
nodes
[0];

7938 
ôem_size
 = 
	`båfs_ôem_size
(
eb
, 
¶Ÿ
);

7940 
±r
 = 
	`båfs_ôem_±r
(
eb
, 
¶Ÿ
, 
båfs_dev_°©s_ôem
);

7942 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++) {

7943 i‡(
ôem_size
 >(1 + 
i
Ë* (
__À64
))

7944 
	`båfs_dev_°©_£t
(
devi˚
, 
i
,

7945 
	`båfs_dev_°©s_vÆue
(
eb
, 
±r
, 
i
));

7947 
	`båfs_dev_°©_£t
(
devi˚
, 
i
, 0);

7950 
devi˚
->
dev_°©s_vÆid
 = 1;

7951 
	`båfs_dev_°©_¥öt_⁄_lﬂd
(
devi˚
);

7952 
	`båfs_ªÀa£_∑th
(
∑th
);

7955 
	}
}

7957 
	$båfs_öô_dev_°©s
(
båfs_fs_öfo
 *
fs_öfo
)

7959 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devi˚s, *
£ed_devs
;

7960 
båfs_devi˚
 *
devi˚
;

7961 
båfs_∑th
 *
∑th
 = 
NULL
;

7962 
ªt
 = 0;

7964 
∑th
 = 
	`båfs_Æloc_∑th
();

7965 i‡(!
∑th
)

7966  -
ENOMEM
;

7968 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

7969 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

7970 
ªt
 = 
	`båfs_devi˚_öô_dev_°©s
(
devi˚
, 
∑th
);

7971 i‡(
ªt
)

7972 
out
;

7974 
	`li°_f‹_óch_íåy
(
£ed_devs
, &
fs_devi˚s
->
£ed_li°
, seed_list) {

7975 
	`li°_f‹_óch_íåy
(
devi˚
, &
£ed_devs
->
devi˚s
, 
dev_li°
) {

7976 
ªt
 = 
	`båfs_devi˚_öô_dev_°©s
(
devi˚
, 
∑th
);

7977 i‡(
ªt
)

7978 
out
;

7981 
out
:

7982 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

7984 
	`båfs_‰ì_∑th
(
∑th
);

7985  
ªt
;

7986 
	}
}

7988 
	$upd©e_dev_°©_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

7989 
båfs_devi˚
 *
devi˚
)

7991 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

7992 
båfs_roŸ
 *
dev_roŸ
 = 
fs_öfo
->dev_root;

7993 
båfs_∑th
 *
∑th
;

7994 
båfs_key
 
key
;

7995 
exã¡_buf„r
 *
eb
;

7996 
båfs_dev_°©s_ôem
 *
±r
;

7997 
ªt
;

7998 
i
;

8000 
key
.
obje˘id
 = 
BTRFS_DEV_STATS_OBJECTID
;

8001 
key
.
ty≥
 = 
BTRFS_PERSISTENT_ITEM_KEY
;

8002 
key
.
off£t
 = 
devi˚
->
devid
;

8004 
∑th
 = 
	`båfs_Æloc_∑th
();

8005 i‡(!
∑th
)

8006  -
ENOMEM
;

8007 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
å™s
, 
dev_roŸ
, &
key
, 
∑th
, -1, 1);

8008 i‡(
ªt
 < 0) {

8009 
	`båfs_w¨n_ö_rcu
(
fs_öfo
,

8011 
ªt
, 
	`båfs_dev_«me
(
devi˚
));

8012 
out
;

8015 i‡(
ªt
 == 0 &&

8016 
	`båfs_ôem_size
(
∑th
->
nodes
[0],Ö©h->
¶Ÿs
[0]Ë< (*
±r
)) {

8018 
ªt
 = 
	`båfs_dñ_ôem
(
å™s
, 
dev_roŸ
, 
∑th
);

8019 i‡(
ªt
 != 0) {

8020 
	`båfs_w¨n_ö_rcu
(
fs_öfo
,

8022 
	`båfs_dev_«me
(
devi˚
), 
ªt
);

8023 
out
;

8025 
ªt
 = 1;

8028 i‡(
ªt
 == 1) {

8030 
	`båfs_ªÀa£_∑th
(
∑th
);

8031 
ªt
 = 
	`båfs_ö£π_em±y_ôem
(
å™s
, 
dev_roŸ
, 
∑th
,

8032 &
key
, (*
±r
));

8033 i‡(
ªt
 < 0) {

8034 
	`båfs_w¨n_ö_rcu
(
fs_öfo
,

8036 
	`båfs_dev_«me
(
devi˚
), 
ªt
);

8037 
out
;

8041 
eb
 = 
∑th
->
nodes
[0];

8042 
±r
 = 
	`båfs_ôem_±r
(
eb
, 
∑th
->
¶Ÿs
[0], 
båfs_dev_°©s_ôem
);

8043 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++)

8044 
	`båfs_£t_dev_°©s_vÆue
(
eb
, 
±r
, 
i
,

8045 
	`båfs_dev_°©_ªad
(
devi˚
, 
i
));

8046 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
eb
);

8048 
out
:

8049 
	`båfs_‰ì_∑th
(
∑th
);

8050  
ªt
;

8051 
	}
}

8056 
	$båfs_run_dev_°©s
(
båfs_å™s_h™dÀ
 *
å™s
)

8058 
båfs_fs_öfo
 *
fs_öfo
 = 
å™s
->fs_info;

8059 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

8060 
båfs_devi˚
 *
devi˚
;

8061 
°©s_˙t
;

8062 
ªt
 = 0;

8064 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

8065 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

8066 
°©s_˙t
 = 
	`©omic_ªad
(&
devi˚
->
dev_°©s_c˙t
);

8067 i‡(!
devi˚
->
dev_°©s_vÆid
 || 
°©s_˙t
 == 0)

8082 
	`smp_rmb
();

8084 
ªt
 = 
	`upd©e_dev_°©_ôem
(
å™s
, 
devi˚
);

8085 i‡(!
ªt
)

8086 
	`©omic_sub
(
°©s_˙t
, &
devi˚
->
dev_°©s_c˙t
);

8088 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

8090  
ªt
;

8091 
	}
}

8093 
	$båfs_dev_°©_öc_™d_¥öt
(
båfs_devi˚
 *
dev
, 
ödex
)

8095 
	`båfs_dev_°©_öc
(
dev
, 
ödex
);

8097 i‡(!
dev
->
dev_°©s_vÆid
)

8099 
	`båfs_îr_æ_ö_rcu
(
dev
->
fs_öfo
,

8101 
	`båfs_dev_«me
(
dev
),

8102 
	`båfs_dev_°©_ªad
(
dev
, 
BTRFS_DEV_STAT_WRITE_ERRS
),

8103 
	`båfs_dev_°©_ªad
(
dev
, 
BTRFS_DEV_STAT_READ_ERRS
),

8104 
	`båfs_dev_°©_ªad
(
dev
, 
BTRFS_DEV_STAT_FLUSH_ERRS
),

8105 
	`båfs_dev_°©_ªad
(
dev
, 
BTRFS_DEV_STAT_CORRUPTION_ERRS
),

8106 
	`båfs_dev_°©_ªad
(
dev
, 
BTRFS_DEV_STAT_GENERATION_ERRS
));

8107 
	}
}

8109 
	$båfs_dev_°©_¥öt_⁄_lﬂd
(
båfs_devi˚
 *
dev
)

8111 
i
;

8113 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++)

8114 i‡(
	`båfs_dev_°©_ªad
(
dev
, 
i
) != 0)

8116 i‡(
i
 =
BTRFS_DEV_STAT_VALUES_MAX
)

8119 
	`båfs_öfo_ö_rcu
(
dev
->
fs_öfo
,

8121 
	`båfs_dev_«me
(
dev
),

8122 
	`båfs_dev_°©_ªad
(
dev
, 
BTRFS_DEV_STAT_WRITE_ERRS
),

8123 
	`båfs_dev_°©_ªad
(
dev
, 
BTRFS_DEV_STAT_READ_ERRS
),

8124 
	`båfs_dev_°©_ªad
(
dev
, 
BTRFS_DEV_STAT_FLUSH_ERRS
),

8125 
	`båfs_dev_°©_ªad
(
dev
, 
BTRFS_DEV_STAT_CORRUPTION_ERRS
),

8126 
	`båfs_dev_°©_ªad
(
dev
, 
BTRFS_DEV_STAT_GENERATION_ERRS
));

8127 
	}
}

8129 
	$båfs_gë_dev_°©s
(
båfs_fs_öfo
 *
fs_öfo
,

8130 
båfs_io˘l_gë_dev_°©s
 *
°©s
)

8132 
	`BTRFS_DEV_LOOKUP_ARGS
(
¨gs
);

8133 
båfs_devi˚
 *
dev
;

8134 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

8135 
i
;

8137 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

8138 
¨gs
.
devid
 = 
°©s
->devid;

8139 
dev
 = 
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, &
¨gs
);

8140 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

8142 i‡(!
dev
) {

8143 
	`båfs_w¨n
(
fs_öfo
, "get dev_stats failed, deviceÇot found");

8144  -
ENODEV
;

8145 } i‡(!
dev
->
dev_°©s_vÆid
) {

8146 
	`båfs_w¨n
(
fs_öfo
, "get dev_stats failed,Çot yet valid");

8147  -
ENODEV
;

8148 } i‡(
°©s
->
Êags
 & 
BTRFS_DEV_STATS_RESET
) {

8149 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++) {

8150 i‡(
°©s
->
ƒ_ôems
 > 
i
)

8151 
°©s
->
vÆues
[
i
] =

8152 
	`båfs_dev_°©_ªad_™d_ª£t
(
dev
, 
i
);

8154 
	`båfs_dev_°©_£t
(
dev
, 
i
, 0);

8156 
	`båfs_öfo
(
fs_öfo
, "device stats zeroed by %s (%d)",

8157 
cuºít
->
comm
, 
	`èsk_pid_ƒ
(current));

8159 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++)

8160 i‡(
°©s
->
ƒ_ôems
 > 
i
)

8161 
°©s
->
vÆues
[
i
] = 
	`båfs_dev_°©_ªad
(
dev
, i);

8163 i‡(
°©s
->
ƒ_ôems
 > 
BTRFS_DEV_STAT_VALUES_MAX
)

8164 
°©s
->
ƒ_ôems
 = 
BTRFS_DEV_STAT_VALUES_MAX
;

8166 
	}
}

8175 
	$båfs_commô_devi˚_sizes
(
båfs_å™ß˘i⁄
 *
å™s
)

8177 
båfs_devi˚
 *
cuº
, *
√xt
;

8179 
	`ASSERT
(
å™s
->
°©e
 =
TRANS_STATE_COMMIT_DOING
);

8181 i‡(
	`li°_em±y
(&
å™s
->
dev_upd©e_li°
))

8189 
	`muãx_lock
(&
å™s
->
fs_öfo
->
chunk_muãx
);

8190 
	`li°_f‹_óch_íåy_ß„
(
cuº
, 
√xt
, &
å™s
->
dev_upd©e_li°
,

8191 
po°_commô_li°
) {

8192 
	`li°_dñ_öô
(&
cuº
->
po°_commô_li°
);

8193 
cuº
->
commô_tŸÆ_byãs
 = cuº->
disk_tŸÆ_byãs
;

8194 
cuº
->
commô_byãs_u£d
 = cuº->
byãs_u£d
;

8196 
	`muãx_u∆ock
(&
å™s
->
fs_öfo
->
chunk_muãx
);

8197 
	}
}

8202 
	$båfs_bg_ty≥_to_Á˘‹
(
u64
 
Êags
)

8204 c⁄° 
ödex
 = 
	`båfs_bg_Êags_to_øid_ödex
(
Êags
);

8206  
båfs_øid_¨øy
[
ödex
].
nc›õs
;

8207 
	}
}

8211 
	$vîify_⁄e_dev_exã¡
(
båfs_fs_öfo
 *
fs_öfo
,

8212 
u64
 
chunk_off£t
, u64 
devid
,

8213 
u64
 
physiˇl_off£t
, u64 
physiˇl_Àn
)

8215 
båfs_dev_lookup_¨gs
 
¨gs
 = { .
devid
 = devid };

8216 
exã¡_m≠_åì
 *
em_åì
 = &
fs_öfo
->
m≠pög_åì
;

8217 
exã¡_m≠
 *
em
;

8218 
m≠_lookup
 *
m≠
;

8219 
båfs_devi˚
 *
dev
;

8220 
u64
 
°rùe_Àn
;

8221 
boﬁ
 
found
 = 
Ál£
;

8222 
ªt
 = 0;

8223 
i
;

8225 
	`ªad_lock
(&
em_åì
->
lock
);

8226 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 
chunk_off£t
, 1);

8227 
	`ªad_u∆ock
(&
em_åì
->
lock
);

8229 i‡(!
em
) {

8230 
	`båfs_îr
(
fs_öfo
,

8232 
physiˇl_off£t
, 
devid
);

8233 
ªt
 = -
EUCLEAN
;

8234 
out
;

8237 
m≠
 = 
em
->
m≠_lookup
;

8238 
°rùe_Àn
 = 
	`båfs_ˇlc_°rùe_Àngth
(
em
);

8239 i‡(
physiˇl_Àn
 !
°rùe_Àn
) {

8240 
	`båfs_îr
(
fs_öfo
,

8242 
physiˇl_off£t
, 
devid
, 
em
->
°¨t
, 
physiˇl_Àn
,

8243 
°rùe_Àn
);

8244 
ªt
 = -
EUCLEAN
;

8245 
out
;

8253 i‡(
physiˇl_off£t
 < 
BTRFS_DEVICE_RANGE_RESERVED
)

8254 
	`båfs_w¨n
(
fs_öfo
,

8256 
devid
, 
physiˇl_off£t
, 
physiˇl_Àn
);

8258 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

8259 i‡(
m≠
->
°rùes
[
i
].
dev
->
devid
 == devid &&

8260 
m≠
->
°rùes
[
i
].
physiˇl
 =
physiˇl_off£t
) {

8261 
found
 = 
åue
;

8262 i‡(
m≠
->
vîifõd_°rùes
 >m≠->
num_°rùes
) {

8263 
	`båfs_îr
(
fs_öfo
,

8265 
em
->
°¨t
);

8266 
ªt
 = -
EUCLEAN
;

8267 
out
;

8269 
m≠
->
vîifõd_°rùes
++;

8273 i‡(!
found
) {

8274 
	`båfs_îr
(
fs_öfo
,

8276 
physiˇl_off£t
, 
devid
);

8277 
ªt
 = -
EUCLEAN
;

8281 
dev
 = 
	`båfs_föd_devi˚
(
fs_öfo
->
fs_devi˚s
, &
¨gs
);

8282 i‡(!
dev
) {

8283 
	`båfs_îr
(
fs_öfo
, "ÁûedÅÿföd devid %Œu", 
devid
);

8284 
ªt
 = -
EUCLEAN
;

8285 
out
;

8289 i‡(
physiˇl_off£t
 + 
physiˇl_Àn
 > 
dev
->
∑πôi⁄_íd
) {

8290 
	`båfs_îr
(
fs_öfo
,

8292 
devid
, 
physiˇl_off£t
, 
physiˇl_Àn
,

8293 
dev
->
disk_tŸÆ_byãs
);

8294 
ªt
 = -
EUCLEAN
;

8295 
out
;

8298 i‡(
dev
->
z⁄e_öfo
) {

8299 
u64
 
z⁄e_size
 = 
dev
->
z⁄e_öfo
->zone_size;

8301 i‡(!
	`IS_ALIGNED
(
physiˇl_off£t
, 
z⁄e_size
) ||

8302 !
	`IS_ALIGNED
(
physiˇl_Àn
, 
z⁄e_size
)) {

8303 
	`båfs_îr
(
fs_öfo
,

8305 
devid
, 
physiˇl_off£t
, 
physiˇl_Àn
);

8306 
ªt
 = -
EUCLEAN
;

8307 
out
;

8311 
out
:

8312 
	`‰ì_exã¡_m≠
(
em
);

8313  
ªt
;

8314 
	}
}

8316 
	$vîify_chunk_dev_exã¡_m≠pög
(
båfs_fs_öfo
 *
fs_öfo
)

8318 
exã¡_m≠_åì
 *
em_åì
 = &
fs_öfo
->
m≠pög_åì
;

8319 
exã¡_m≠
 *
em
;

8320 
rb_node
 *
node
;

8321 
ªt
 = 0;

8323 
	`ªad_lock
(&
em_åì
->
lock
);

8324 
node
 = 
	`rb_fú°_ˇched
(&
em_åì
->
m≠
);Çode;Çodê
	`rb_√xt
(node)) {

8325 
em
 = 
	`rb_íåy
(
node
, 
exã¡_m≠
, 
rb_node
);

8326 i‡(
em
->
m≠_lookup
->
num_°rùes
 !=

8327 
em
->
m≠_lookup
->
vîifõd_°rùes
) {

8328 
	`båfs_îr
(
fs_öfo
,

8330 
em
->
°¨t
,Ém->
m≠_lookup
->
vîifõd_°rùes
,

8331 
em
->
m≠_lookup
->
num_°rùes
);

8332 
ªt
 = -
EUCLEAN
;

8333 
out
;

8336 
out
:

8337 
	`ªad_u∆ock
(&
em_åì
->
lock
);

8338  
ªt
;

8339 
	}
}

8348 
	$båfs_vîify_dev_exã¡s
(
båfs_fs_öfo
 *
fs_öfo
)

8350 
båfs_∑th
 *
∑th
;

8351 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
dev_roŸ
;

8352 
båfs_key
 
key
;

8353 
u64
 
¥ev_devid
 = 0;

8354 
u64
 
¥ev_dev_ext_íd
 = 0;

8355 
ªt
 = 0;

8367 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
IGNOREBADROOTS
))

8370 
key
.
obje˘id
 = 1;

8371 
key
.
ty≥
 = 
BTRFS_DEV_EXTENT_KEY
;

8372 
key
.
off£t
 = 0;

8374 
∑th
 = 
	`båfs_Æloc_∑th
();

8375 i‡(!
∑th
)

8376  -
ENOMEM
;

8378 
∑th
->
ªada
 = 
READA_FORWARD
;

8379 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

8380 i‡(
ªt
 < 0)

8381 
out
;

8383 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
’©h->
nodes
[0])) {

8384 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

8385 i‡(
ªt
 < 0)

8386 
out
;

8388 i‡(
ªt
 > 0) {

8389 
ªt
 = -
EUCLEAN
;

8390 
out
;

8394 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

8395 
båfs_dev_exã¡
 *
dext
;

8396 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

8397 
u64
 
chunk_off£t
;

8398 
u64
 
physiˇl_off£t
;

8399 
u64
 
physiˇl_Àn
;

8400 
u64
 
devid
;

8402 
	`båfs_ôem_key_to_˝u
(
Àaf
, &
key
, 
¶Ÿ
);

8403 i‡(
key
.
ty≥
 !
BTRFS_DEV_EXTENT_KEY
)

8405 
devid
 = 
key
.
obje˘id
;

8406 
physiˇl_off£t
 = 
key
.
off£t
;

8408 
dext
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_dev_exã¡
);

8409 
chunk_off£t
 = 
	`båfs_dev_exã¡_chunk_off£t
(
Àaf
, 
dext
);

8410 
physiˇl_Àn
 = 
	`båfs_dev_exã¡_Àngth
(
Àaf
, 
dext
);

8413 i‡(
devid
 =
¥ev_devid
 && 
physiˇl_off£t
 < 
¥ev_dev_ext_íd
) {

8414 
	`båfs_îr
(
fs_öfo
,

8416 
devid
, 
physiˇl_off£t
, 
¥ev_dev_ext_íd
);

8417 
ªt
 = -
EUCLEAN
;

8418 
out
;

8422 
ªt
 = 
	`vîify_⁄e_dev_exã¡
(
fs_öfo
, 
chunk_off£t
, 
devid
,

8423 
physiˇl_off£t
, 
physiˇl_Àn
);

8424 i‡(
ªt
 < 0)

8425 
out
;

8426 
¥ev_devid
 = 
devid
;

8427 
¥ev_dev_ext_íd
 = 
physiˇl_off£t
 + 
physiˇl_Àn
;

8429 
ªt
 = 
	`båfs_√xt_ôem
(
roŸ
, 
∑th
);

8430 i‡(
ªt
 < 0)

8431 
out
;

8432 i‡(
ªt
 > 0) {

8433 
ªt
 = 0;

8439 
ªt
 = 
	`vîify_chunk_dev_exã¡_m≠pög
(
fs_öfo
);

8440 
out
:

8441 
	`båfs_‰ì_∑th
(
∑th
);

8442  
ªt
;

8443 
	}
}

8449 
boﬁ
 
	$båfs_pö√d_by_sw≠fûe
(
båfs_fs_öfo
 *
fs_öfo
, *
±r
)

8451 
båfs_sw≠fûe_pö
 *
•
;

8452 
rb_node
 *
node
;

8454 
	`•ö_lock
(&
fs_öfo
->
sw≠fûe_pös_lock
);

8455 
node
 = 
fs_öfo
->
sw≠fûe_pös
.
rb_node
;

8456 
node
) {

8457 
•
 = 
	`rb_íåy
(
node
, 
båfs_sw≠fûe_pö
,Çode);

8458 i‡(
±r
 < 
•
->ptr)

8459 
node
 =Çode->
rb_À·
;

8460 i‡(
±r
 > 
•
->ptr)

8461 
node
 =Çode->
rb_right
;

8465 
	`•ö_u∆ock
(&
fs_öfo
->
sw≠fûe_pös_lock
);

8466  
node
 !
NULL
;

8467 
	}
}

8469 
	$ªloˇtög_ª∑ú_kthªad
(*
d©a
)

8471 
båfs_block_group
 *
ˇche
 = 
d©a
;

8472 
båfs_fs_öfo
 *
fs_öfo
 = 
ˇche
->fs_info;

8473 
u64
 
èrgë
;

8474 
ªt
 = 0;

8476 
èrgë
 = 
ˇche
->
°¨t
;

8477 
	`båfs_put_block_group
(
ˇche
);

8479 
	`sb_°¨t_wrôe
(
fs_öfo
->
sb
);

8480 i‡(!
	`båfs_ex˛›_°¨t
(
fs_öfo
, 
BTRFS_EXCLOP_BALANCE
)) {

8481 
	`båfs_öfo
(
fs_öfo
,

8483 
èrgë
);

8484 
	`sb_íd_wrôe
(
fs_öfo
->
sb
);

8485  -
EBUSY
;

8488 
	`muãx_lock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

8491 
ˇche
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
èrgë
);

8492 i‡(!
ˇche
)

8493 
out
;

8495 i‡(!
	`ã°_bô
(
BLOCK_GROUP_FLAG_RELOCATING_REPAIR
, &
ˇche
->
ru¡ime_Êags
))

8496 
out
;

8498 
ªt
 = 
	`båfs_may_Æloc_d©a_chunk
(
fs_öfo
, 
èrgë
);

8499 i‡(
ªt
 < 0)

8500 
out
;

8502 
	`båfs_öfo
(
fs_öfo
,

8504 
èrgë
);

8505 
ªt
 = 
	`båfs_ªloˇã_chunk
(
fs_öfo
, 
èrgë
);

8507 
out
:

8508 i‡(
ˇche
)

8509 
	`båfs_put_block_group
(
ˇche
);

8510 
	`muãx_u∆ock
(&
fs_öfo
->
ª˛aim_bgs_lock
);

8511 
	`båfs_ex˛›_föish
(
fs_öfo
);

8512 
	`sb_íd_wrôe
(
fs_öfo
->
sb
);

8514  
ªt
;

8515 
	}
}

8517 
boﬁ
 
	$båfs_ª∑ú_⁄e_z⁄e
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
logiˇl
)

8519 
båfs_block_group
 *
ˇche
;

8521 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

8522  
Ál£
;

8525 i‡(
	`båfs_ã°_›t
(
fs_öfo
, 
DEGRADED
))

8526  
åue
;

8528 
ˇche
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
logiˇl
);

8529 i‡(!
ˇche
)

8530  
åue
;

8532 i‡(
	`ã°_™d_£t_bô
(
BLOCK_GROUP_FLAG_RELOCATING_REPAIR
, &
ˇche
->
ru¡ime_Êags
)) {

8533 
	`båfs_put_block_group
(
ˇche
);

8534  
åue
;

8537 
	`kthªad_run
(
ªloˇtög_ª∑ú_kthªad
, 
ˇche
,

8540  
åue
;

8541 
	}
}

8543 
	$m≠_øid56_ª∑ú_block
(
båfs_io_c⁄ãxt
 *
bioc
,

8544 
båfs_io_°rùe
 *
sm≠
,

8545 
u64
 
logiˇl
)

8547 
d©a_°rùes
 = 
	`ƒ_bioc_d©a_°rùes
(
bioc
);

8548 
i
;

8550 
i
 = 0; i < 
d©a_°rùes
; i++) {

8551 
u64
 
°rùe_°¨t
 = 
bioc
->
fuŒ_°rùe_logiˇl
 +

8552 
	`båfs_°rùe_ƒ_to_off£t
(
i
);

8554 i‡(
logiˇl
 >
°rùe_°¨t
 &&

8555 
logiˇl
 < 
°rùe_°¨t
 + 
BTRFS_STRIPE_LEN
)

8558 
	`ASSERT
(
i
 < 
d©a_°rùes
);

8559 
sm≠
->
dev
 = 
bioc
->
°rùes
[
i
].dev;

8560 
sm≠
->
physiˇl
 = 
bioc
->
°rùes
[
i
].physical +

8561 ((
logiˇl
 - 
bioc
->
fuŒ_°rùe_logiˇl
) &

8562 
BTRFS_STRIPE_LEN_MASK
);

8563 
	}
}

8578 
	$båfs_m≠_ª∑ú_block
(
båfs_fs_öfo
 *
fs_öfo
,

8579 
båfs_io_°rùe
 *
sm≠
, 
u64
 
logiˇl
,

8580 
u32
 
Àngth
, 
múr‹_num
)

8582 
båfs_io_c⁄ãxt
 *
bioc
 = 
NULL
;

8583 
u64
 
m≠_Àngth
 = 
Àngth
;

8584 
múr‹_ªt
 = 
múr‹_num
;

8585 
ªt
;

8587 
	`ASSERT
(
múr‹_num
 > 0);

8589 
ªt
 = 
	`båfs_m≠_block
(
fs_öfo
, 
BTRFS_MAP_WRITE
, 
logiˇl
, &
m≠_Àngth
,

8590 &
bioc
, 
sm≠
, &
múr‹_ªt
, 
åue
);

8591 i‡(
ªt
 < 0)

8592  
ªt
;

8595 
	`ASSERT
(
m≠_Àngth
 >
Àngth
);

8598 i‡(!
bioc
)

8599 
out
;

8602 i‡(
bioc
->
m≠_ty≥
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

8603 
	`m≠_øid56_ª∑ú_block
(
bioc
, 
sm≠
, 
logiˇl
);

8604 
out
;

8607 
	`ASSERT
(
múr‹_num
 <
bioc
->
num_°rùes
);

8608 
sm≠
->
dev
 = 
bioc
->
°rùes
[
múr‹_num
 - 1].dev;

8609 
sm≠
->
physiˇl
 = 
bioc
->
°rùes
[
múr‹_num
 - 1].physical;

8610 
out
:

8611 
	`båfs_put_bioc
(
bioc
);

8612 
	`ASSERT
(
sm≠
->
dev
);

8614 
	}
}

	@volumes.h

6 #i‚de‡
BTRFS_VOLUMES_H


7 
	#BTRFS_VOLUMES_H


	)

9 
	~<löux/s‹t.h
>

10 
	~<löux/båfs.h
>

11 
	~"async-thªad.h
"

12 
	~"mesßges.h
"

13 
	~"åì-checkî.h
"

14 
	~"rcu-°rög.h
"

16 
	#BTRFS_MAX_DATA_CHUNK_SIZE
 (10ULL * 
SZ_1G
)

	)

18 
muãx
 
uuid_muãx
;

20 
	#BTRFS_STRIPE_LEN
 
SZ_64K


	)

21 
	#BTRFS_STRIPE_LEN_SHIFT
 (16)

	)

22 
	#BTRFS_STRIPE_LEN_MASK
 (
BTRFS_STRIPE_LEN
 - 1)

	)

24 
°©ic_as£π
(
c⁄°_ûog2
(
BTRFS_STRIPE_LEN
Ë=
BTRFS_STRIPE_LEN_SHIFT
);

27 
	#c⁄°_ffs
(
n
Ë(
	`__buûtö_˘zŒ
“Ë+ 1)

	)

35 
°©ic_as£π
(
c⁄°_ffs
(
BTRFS_BLOCK_GROUP_RAID0
) <

36 
c⁄°_ffs
(
BTRFS_BLOCK_GROUP_PROFILE_MASK
 & ~
BTRFS_BLOCK_GROUP_RAID0
));

37 
°©ic_as£π
(
c⁄°_ûog2
(
BTRFS_BLOCK_GROUP_RAID0
) >

38 
ûog2
(
BTRFS_BLOCK_GROUP_TYPE_MASK
));

41 
	#BTRFS_BG_FLAG_TO_INDEX
(
¥ofûe
) \

42 
	`ûog2
((
¥ofûe
Ë>> (ûog2(
BTRFS_BLOCK_GROUP_RAID0
Ë- 1))

	)

44 
	ebåfs_øid_ty≥s
 {

46 
	mBTRFS_RAID_SINGLE
 = 0,

48 
	mBTRFS_RAID_RAID0
 = 
BTRFS_BG_FLAG_TO_INDEX
(
BTRFS_BLOCK_GROUP_RAID0
),

49 
	mBTRFS_RAID_RAID1
 = 
BTRFS_BG_FLAG_TO_INDEX
(
BTRFS_BLOCK_GROUP_RAID1
),

50 
	mBTRFS_RAID_DUP
 = 
BTRFS_BG_FLAG_TO_INDEX
(
BTRFS_BLOCK_GROUP_DUP
),

51 
	mBTRFS_RAID_RAID10
 = 
BTRFS_BG_FLAG_TO_INDEX
(
BTRFS_BLOCK_GROUP_RAID10
),

52 
	mBTRFS_RAID_RAID5
 = 
BTRFS_BG_FLAG_TO_INDEX
(
BTRFS_BLOCK_GROUP_RAID5
),

53 
	mBTRFS_RAID_RAID6
 = 
BTRFS_BG_FLAG_TO_INDEX
(
BTRFS_BLOCK_GROUP_RAID6
),

54 
	mBTRFS_RAID_RAID1C3
 = 
BTRFS_BG_FLAG_TO_INDEX
(
BTRFS_BLOCK_GROUP_RAID1C3
),

55 
	mBTRFS_RAID_RAID1C4
 = 
BTRFS_BG_FLAG_TO_INDEX
(
BTRFS_BLOCK_GROUP_RAID1C4
),

57 
	mBTRFS_NR_RAID_TYPES


64 #i‡
BITS_PER_LONG
==32 && 
deföed
(
CONFIG_SMP
)

65 
	~<löux/£qlock.h
>

66 
	#__BTRFS_NEED_DEVICE_DATA_ORDERED


	)

67 
	#båfs_devi˚_d©a_‹dîed_öô
(
devi˚
) \

68 
	`£qcou¡_öô
(&
devi˚
->
d©a_£qcou¡
)

	)

70 
	#båfs_devi˚_d©a_‹dîed_öô
(
devi˚
Ëdÿ{ } 0)

	)

73 
	#BTRFS_DEV_STATE_WRITEABLE
 (0)

	)

74 
	#BTRFS_DEV_STATE_IN_FS_METADATA
 (1)

	)

75 
	#BTRFS_DEV_STATE_MISSING
 (2)

	)

76 
	#BTRFS_DEV_STATE_REPLACE_TGT
 (3)

	)

77 
	#BTRFS_DEV_STATE_FLUSH_SENT
 (4)

	)

78 
	#BTRFS_DEV_STATE_NO_READA
 (5)

	)

80 
	gbåfs_z⁄ed_devi˚_öfo
;

82 
	sbåfs_devi˚
 {

83 
li°_hód
 
	mdev_li°
;

84 
li°_hód
 
	mdev_Æloc_li°
;

85 
li°_hód
 
	mpo°_commô_li°
;

86 
båfs_fs_devi˚s
 *
	mfs_devi˚s
;

87 
båfs_fs_öfo
 *
	mfs_öfo
;

89 
rcu_°rög
 
__rcu
 *
	m«me
;

91 
u64
 
	mgíî©i⁄
;

93 
block_devi˚
 *
	mbdev
;

95 
båfs_z⁄ed_devi˚_öfo
 *
	mz⁄e_öfo
;

98 *
	mhﬁdî
;

104 
dev_t
 
	mdevt
;

105 
	mdev_°©e
;

106 
blk_°©us_t
 
	mœ°_Êush_îr‹
;

108 #ifde‡
__BTRFS_NEED_DEVICE_DATA_ORDERED


109 
£qcou¡_t
 
	md©a_£qcou¡
;

113 
u64
 
	mdevid
;

116 
u64
 
	mtŸÆ_byãs
;

119 
u64
 
	mdisk_tŸÆ_byãs
;

122 
u64
 
	m∑πôi⁄_°¨t
;

123 
u64
 
	m∑πôi⁄_íd
;

126 
u64
 
	mbyãs_u£d
;

129 
u32
 
	mio_Æign
;

132 
u32
 
	mio_width
;

134 
u64
 
	mty≥
;

137 
u32
 
	m£˘‹_size
;

140 
u8
 
	muuid
[
BTRFS_UUID_SIZE
];

148 
u64
 
	mcommô_tŸÆ_byãs
;

151 
u64
 
	mcommô_byãs_u£d
;

154 
bio
 
	mÊush_bio
;

155 
com∂ëi⁄
 
	mÊush_waô
;

158 
s¸ub_˘x
 *
	ms¸ub_˘x
;

162 
	mdev_°©s_vÆid
;

165 
©omic_t
 
	mdev_°©s_c˙t
;

166 
©omic_t
 
	mdev_°©_vÆues
[
BTRFS_DEV_STAT_VALUES_MAX
];

168 
exã¡_io_åì
 
	mÆloc_°©e
;

170 
com∂ëi⁄
 
	mkobj_uƒegi°î
;

172 
kobje˘
 
	mdevid_kobj
;

175 
u64
 
	ms¸ub_•ìd_max
;

187 
	sbåfs_sw≠fûe_pö
 {

188 
rb_node
 
	mnode
;

189 *
	m±r
;

190 
öode
 *
	möode
;

195 
boﬁ
 
	mis_block_group
;

200 
	mbg_exã¡_cou¡
;

207 #i‡
BITS_PER_LONG
==32 && 
deföed
(
CONFIG_SMP
)

208 
	#BTRFS_DEVICE_GETSET_FUNCS
(
«me
) \

209 
ölöe
 
u64
 \

210 
båfs_devi˚_gë_
##
	`«me
(c⁄° 
båfs_devi˚
 *
dev
) \

212 
u64
 
size
; \

213 
£q
; \

216 
£q
 = 
	`ªad_£qcou¡_begö
(&
dev
->
d©a_£qcou¡
); \

217 
size
 = 
dev
->
«me
; \

218 } 
	`ªad_£qcou¡_ªåy
(&
dev
->
d©a_£qcou¡
, 
£q
)); \

219  
size
; \

222 
ölöe
 \

223 
båfs_devi˚_£t_
##
	`«me
(
båfs_devi˚
 *
dev
, 
u64
 
size
) \

225 
	`¥ìm±_dißbÀ
(); \

226 
	`wrôe_£qcou¡_begö
(&
dev
->
d©a_£qcou¡
); \

227 
dev
->
«me
 = 
size
; \

228 
	`wrôe_£qcou¡_íd
(&
dev
->
d©a_£qcou¡
); \

229 
	`¥ìm±_íabÀ
(); \

230 }

	)

231 #ñi‡
BITS_PER_LONG
==32 && 
deföed
(
CONFIG_PREEMPTION
)

232 
	#BTRFS_DEVICE_GETSET_FUNCS
(
«me
) \

233 
ölöe
 
u64
 \

234 
båfs_devi˚_gë_
##
	`«me
(c⁄° 
båfs_devi˚
 *
dev
) \

236 
u64
 
size
; \

238 
	`¥ìm±_dißbÀ
(); \

239 
size
 = 
dev
->
«me
; \

240 
	`¥ìm±_íabÀ
(); \

241  
size
; \

244 
ölöe
 \

245 
båfs_devi˚_£t_
##
	`«me
(
båfs_devi˚
 *
dev
, 
u64
 
size
) \

247 
	`¥ìm±_dißbÀ
(); \

248 
dev
->
«me
 = 
size
; \

249 
	`¥ìm±_íabÀ
(); \

250 }

	)

252 
	#BTRFS_DEVICE_GETSET_FUNCS
(
«me
) \

253 
ölöe
 
u64
 \

254 
båfs_devi˚_gë_
##
	`«me
(c⁄° 
båfs_devi˚
 *
dev
) \

256  
dev
->
«me
; \

259 
ölöe
 \

260 
båfs_devi˚_£t_
##
	`«me
(
båfs_devi˚
 *
dev
, 
u64
 
size
) \

262 
dev
->
«me
 = 
size
; \

263 }

	)

266 
BTRFS_DEVICE_GETSET_FUNCS
(
tŸÆ_byãs
);

267 
BTRFS_DEVICE_GETSET_FUNCS
(
disk_tŸÆ_byãs
);

268 
BTRFS_DEVICE_GETSET_FUNCS
(
byãs_u£d
);

270 
	ebåfs_chunk_Æloˇti⁄_pﬁicy
 {

271 
	mBTRFS_CHUNK_ALLOC_REGULAR
,

272 
	mBTRFS_CHUNK_ALLOC_ZONED
,

279 
	ebåfs_ªad_pﬁicy
 {

281 
	mBTRFS_READ_POLICY_PID
,

282 
	mBTRFS_NR_READ_POLICY
,

285 
	sbåfs_fs_devi˚s
 {

286 
u8
 
	mfsid
[
BTRFS_FSID_SIZE
];

298 
u8
 
	mmëad©a_uuid
[
BTRFS_FSID_SIZE
];

300 
li°_hód
 
	mfs_li°
;

306 
u64
 
	mnum_devi˚s
;

312 
u64
 
	m›í_devi˚s
;

315 
u64
 
	mrw_devi˚s
;

318 
u64
 
	mmissög_devi˚s
;

319 
u64
 
	mtŸÆ_rw_byãs
;

326 
u64
 
	mtŸÆ_devi˚s
;

329 
u64
 
	mœã°_gíî©i⁄
;

335 
båfs_devi˚
 *
	mœã°_dev
;

343 
muãx
 
	mdevi˚_li°_muãx
;

346 
li°_hód
 
	mdevi˚s
;

349 
li°_hód
 
	mÆloc_li°
;

351 
li°_hód
 
	m£ed_li°
;

354 
	m›íed
;

357 
boﬁ
 
	mrŸ©ög
;

359 
boﬁ
 
	mdisˇrdabÀ
;

360 
boﬁ
 
	mfsid_ch™ge
;

362 
boﬁ
 
	m£edög
;

364 
båfs_fs_öfo
 *
	mfs_öfo
;

366 
kobje˘
 
	mfsid_kobj
;

367 
kobje˘
 *
	mdevi˚s_kobj
;

368 
kobje˘
 *
	mdevöfo_kobj
;

369 
com∂ëi⁄
 
	mkobj_uƒegi°î
;

371 
båfs_chunk_Æloˇti⁄_pﬁicy
 
	mchunk_Æloc_pﬁicy
;

374 
båfs_ªad_pﬁicy
 
	mªad_pﬁicy
;

377 
	#BTRFS_MAX_DEVS
(
öfo
Ë((
	`BTRFS_MAX_ITEM_SIZE
(info) \

378 - (
båfs_chunk
)) \

379 / (
båfs_°rùe
Ë+ 1)

	)

381 
	#BTRFS_MAX_DEVS_SYS_CHUNK
 ((
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
 \

382 - 2 * (
båfs_disk_key
) \

383 - 2 * (
båfs_chunk
)) \

384 / (
båfs_°rùe
Ë+ 1)

	)

386 
	sbåfs_io_°rùe
 {

387 
båfs_devi˚
 *
	mdev
;

390 
u64
 
	mphysiˇl
;

392 
båfs_io_c⁄ãxt
 *
	mbioc
;

396 
	sbåfs_disˇrd_°rùe
 {

397 
båfs_devi˚
 *
	mdev
;

398 
u64
 
	mphysiˇl
;

399 
u64
 
	mÀngth
;

418 
	sbåfs_io_c⁄ãxt
 {

419 
ªfcou¡_t
 
	mªfs
;

420 
båfs_fs_öfo
 *
	mfs_öfo
;

421 
u64
 
	mm≠_ty≥
;

422 
bio
 *
	m‹ig_bio
;

423 
©omic_t
 
	mîr‹
;

424 
u16
 
	mmax_îr‹s
;

430 
u16
 
	mnum_°rùes
;

438 
u16
 
	mmúr‹_num
;

473 
u16
 
	mª∂a˚_ƒ_°rùes
;

474 
s16
 
	mª∂a˚_°rùe_§c
;

491 
u64
 
	mfuŒ_°rùe_logiˇl
;

492 
båfs_io_°rùe
 
	m°rùes
[];

495 
	sbåfs_devi˚_öfo
 {

496 
båfs_devi˚
 *
	mdev
;

497 
u64
 
	mdev_off£t
;

498 
u64
 
	mmax_avaû
;

499 
u64
 
	mtŸÆ_avaû
;

502 
	sbåfs_øid_©å
 {

503 
u8
 
	msub_°rùes
;

504 
u8
 
	mdev_°rùes
;

505 
u8
 
	mdevs_max
;

506 
u8
 
	mdevs_mö
;

507 
u8
 
	mtﬁî©ed_Áûuªs
;

508 
u8
 
	mdevs_ö¸emít
;

509 
u8
 
	mnc›õs
;

510 
u8
 
	m≈¨ôy
;

512 
u8
 
	mmödev_îr‹
;

513 c⁄° 
	møid_«me
[8];

514 
u64
 
	mbg_Êag
;

517 c⁄° 
båfs_øid_©å
 
båfs_øid_¨øy
[
BTRFS_NR_RAID_TYPES
];

519 
	sm≠_lookup
 {

520 
u64
 
	mty≥
;

521 
	mio_Æign
;

522 
	mio_width
;

523 
	mnum_°rùes
;

524 
	msub_°rùes
;

525 
	mvîifõd_°rùes
;

526 
båfs_io_°rùe
 
	m°rùes
[];

529 
	#m≠_lookup_size
(
n
Ë((
m≠_lookup
) + \

530 ((
båfs_io_°rùe
Ë* (
n
)))

	)

532 
	gbåfs_bÆ™˚_¨gs
;

533 
	gbåfs_bÆ™˚_¥ogªss
;

534 
	sbåfs_bÆ™˚_c⁄åﬁ
 {

535 
båfs_bÆ™˚_¨gs
 
	md©a
;

536 
båfs_bÆ™˚_¨gs
 
	mmëa
;

537 
båfs_bÆ™˚_¨gs
 
	msys
;

539 
u64
 
	mÊags
;

541 
båfs_bÆ™˚_¥ogªss
 
	m°©
;

547 
	sbåfs_dev_lookup_¨gs
 {

548 
u64
 
	mdevid
;

549 
u8
 *
	muuid
;

550 
u8
 *
	mfsid
;

551 
boﬁ
 
	mmissög
;

555 
	#BTRFS_DEV_LOOKUP_ARGS_INIT
 { .
devid
 = (
u64
)-1 }

	)

557 
	#BTRFS_DEV_LOOKUP_ARGS
(
«me
) \

558 
båfs_dev_lookup_¨gs
 
«me
 = 
BTRFS_DEV_LOOKUP_ARGS_INIT


	)

560 
	ebåfs_m≠_›
 {

561 
	mBTRFS_MAP_READ
,

562 
	mBTRFS_MAP_WRITE
,

563 
	mBTRFS_MAP_GET_READ_MIRRORS
,

566 
ölöe
 
båfs_m≠_›
 
	$båfs_›
(
bio
 *bio)

568 
	`bio_›
(
bio
)) {

569 
REQ_OP_WRITE
:

570 
REQ_OP_ZONE_APPEND
:

571  
BTRFS_MAP_WRITE
;

573 
	`WARN_ON_ONCE
(1);

574 
ÁŒthrough
;

575 
REQ_OP_READ
:

576  
BTRFS_MAP_READ
;

578 
	}
}

580 
ölöe
 
	$båfs_chunk_ôem_size
(
num_°rùes
)

582 
	`ASSERT
(
num_°rùes
);

583  (
båfs_chunk
) +

584 (
båfs_°rùe
Ë* (
num_°rùes
 - 1);

585 
	}
}

593 
ölöe
 
u64
 
	$båfs_°rùe_ƒ_to_off£t
(
u32
 
°rùe_ƒ
)

595  (
u64
)
°rùe_ƒ
 << 
BTRFS_STRIPE_LEN_SHIFT
;

596 
	}
}

598 
båfs_gë_bioc
(
båfs_io_c⁄ãxt
 *
bioc
);

599 
båfs_put_bioc
(
båfs_io_c⁄ãxt
 *
bioc
);

600 
båfs_m≠_block
(
båfs_fs_öfo
 *
fs_öfo
, 
båfs_m≠_›
 
›
,

601 
u64
 
logiˇl
, u64 *
Àngth
,

602 
båfs_io_c⁄ãxt
 **
bioc_ªt
,

603 
båfs_io_°rùe
 *
sm≠
, *
múr‹_num_ªt
,

604 
√ed_øid_m≠
);

605 
båfs_m≠_ª∑ú_block
(
båfs_fs_öfo
 *
fs_öfo
,

606 
båfs_io_°rùe
 *
sm≠
, 
u64
 
logiˇl
,

607 
u32
 
Àngth
, 
múr‹_num
);

608 
båfs_disˇrd_°rùe
 *
båfs_m≠_disˇrd
(
båfs_fs_öfo
 *
fs_öfo
,

609 
u64
 
logiˇl
, u64 *
Àngth_ªt
,

610 
u32
 *
num_°rùes
);

611 
båfs_ªad_sys_¨øy
(
båfs_fs_öfo
 *
fs_öfo
);

612 
båfs_ªad_chunk_åì
(
båfs_fs_öfo
 *
fs_öfo
);

613 
båfs_ªad_chunk_åì_∑πôi⁄
(
båfs_fs_öfo
 *
fs_öfo
, 
∑πôi⁄_‹dî
);

614 
båfs_block_group
 *
båfs_¸óã_chunk
(
båfs_å™s_h™dÀ
 *
å™s
,

615 
u64
 
ty≥
);

616 
båfs_m≠pög_åì_‰ì
(
exã¡_m≠_åì
 *
åì
);

617 
båfs_›í_devi˚s
(
båfs_fs_devi˚s
 *
fs_devi˚s
,

618 
blk_mode_t
 
Êags
, *
hﬁdî
);

619 
båfs_›í_devi˚s_∑πôi⁄
(
båfs_fs_devi˚s
 *
fs_devi˚s
,

620 
blk_mode_t
 
Êags
, *
hﬁdî
, 
∑πôi⁄_‹dî
);

621 
båfs_devi˚
 *
båfs_sˇn_⁄e_devi˚
(c⁄° *
∑th
, 
blk_mode_t
 
Êags
);

622 
båfs_devi˚
 *
båfs_sˇn_⁄e_devi˚_∑πôi⁄
(c⁄° *
∑th
, 
blk_mode_t
 
Êags
, 
∑πôi⁄_‹dî
);

623 
båfs_f‹gë_devi˚s
(
dev_t
 
devt
);

624 
båfs_˛o£_devi˚s
(
båfs_fs_devi˚s
 *
fs_devi˚s
);

625 
båfs_‰ì_exåa_devids
(
båfs_fs_devi˚s
 *
fs_devi˚s
);

626 
båfs_assign_√xt_a˘ive_devi˚
(
båfs_devi˚
 *
devi˚
,

627 
båfs_devi˚
 *
this_dev
);

628 
båfs_devi˚
 *
båfs_föd_devi˚_by_dev•ec
(
båfs_fs_öfo
 *
fs_öfo
,

629 
u64
 
devid
,

630 c⁄° *
dev∑th
);

631 
båfs_gë_dev_¨gs_‰om_∑th
(
båfs_fs_öfo
 *
fs_öfo
,

632 
båfs_dev_lookup_¨gs
 *
¨gs
,

633 c⁄° *
∑th
);

634 
båfs_devi˚
 *
båfs_Æloc_devi˚
(
båfs_fs_öfo
 *
fs_öfo
,

635 c⁄° 
u64
 *
devid
, c⁄° 
u8
 *
uuid
,

636 c⁄° *
∑th
);

637 
båfs_put_dev_¨gs_‰om_∑th
(
båfs_dev_lookup_¨gs
 *
¨gs
);

638 
båfs_rm_devi˚
(
båfs_fs_öfo
 *
fs_öfo
,

639 
båfs_dev_lookup_¨gs
 *
¨gs
,

640 
block_devi˚
 **
bdev
, **
hﬁdî
);

641 
__exô
 
båfs_˛ónup_fs_uuids
();

642 
båfs_num_c›õs
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
logiˇl
, u64 
Àn
);

643 
båfs_grow_devi˚
(
båfs_å™s_h™dÀ
 *
å™s
,

644 
båfs_devi˚
 *
devi˚
, 
u64
 
√w_size
);

645 
båfs_devi˚
 *
båfs_föd_devi˚
(c⁄° 
båfs_fs_devi˚s
 *
fs_devi˚s
,

646 c⁄° 
båfs_dev_lookup_¨gs
 *
¨gs
);

647 
båfs_shrök_devi˚
(
båfs_devi˚
 *
devi˚
, 
u64
 
√w_size
);

648 
båfs_öô_√w_devi˚
(
båfs_fs_öfo
 *
fs_öfo
, c⁄° *
∑th
);

649 
båfs_bÆ™˚
(
båfs_fs_öfo
 *
fs_öfo
,

650 
båfs_bÆ™˚_c⁄åﬁ
 *
b˘l
,

651 
båfs_io˘l_bÆ™˚_¨gs
 *
b¨gs
);

652 
båfs_des¸ibe_block_groups
(
u64
 
Êags
, *
buf
, 
u32
 
size_buf
);

653 
båfs_ªsume_bÆ™˚_async
(
båfs_fs_öfo
 *
fs_öfo
);

654 
båfs_ªcovî_bÆ™˚
(
båfs_fs_öfo
 *
fs_öfo
);

655 
båfs_∑u£_bÆ™˚
(
båfs_fs_öfo
 *
fs_öfo
);

656 
båfs_ªloˇã_chunk
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
chunk_off£t
);

657 
båfs_ˇn˚l_bÆ™˚
(
båfs_fs_öfo
 *
fs_öfo
);

658 
båfs_¸óã_uuid_åì
(
båfs_fs_öfo
 *
fs_öfo
);

659 
båfs_uuid_sˇn_kthªad
(*
d©a
);

660 
boﬁ
 
båfs_chunk_wrôóbÀ
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
chunk_off£t
);

661 
båfs_dev_°©_öc_™d_¥öt
(
båfs_devi˚
 *
dev
, 
ödex
);

662 
båfs_gë_dev_°©s
(
båfs_fs_öfo
 *
fs_öfo
,

663 
båfs_io˘l_gë_dev_°©s
 *
°©s
);

664 
båfs_öô_devi˚s_œã
(
båfs_fs_öfo
 *
fs_öfo
);

665 
båfs_öô_dev_°©s
(
båfs_fs_öfo
 *
fs_öfo
);

666 
båfs_run_dev_°©s
(
båfs_å™s_h™dÀ
 *
å™s
);

667 
båfs_rm_dev_ª∂a˚_ªmove_§cdev
(
båfs_devi˚
 *
§cdev
);

668 
båfs_rm_dev_ª∂a˚_‰ì_§cdev
(
båfs_devi˚
 *
§cdev
);

669 
båfs_de°roy_dev_ª∂a˚_tgtdev
(
båfs_devi˚
 *
tgtdev
);

670 
båfs_is_∑rôy_múr‹
(
båfs_fs_öfo
 *
fs_öfo
,

671 
u64
 
logiˇl
, u64 
Àn
);

672 
båfs_fuŒ_°rùe_Àn
(
båfs_fs_öfo
 *
fs_öfo
,

673 
u64
 
logiˇl
);

674 
u64
 
båfs_ˇlc_°rùe_Àngth
(c⁄° 
exã¡_m≠
 *
em
);

675 
båfs_ƒ_∑rôy_°rùes
(
u64
 
ty≥
);

676 
båfs_chunk_Æloc_add_chunk_ôem
(
båfs_å™s_h™dÀ
 *
å™s
,

677 
båfs_block_group
 *
bg
);

678 
båfs_ªmove_chunk
(
båfs_å™s_h™dÀ
 *
å™s
, 
u64
 
chunk_off£t
);

679 
exã¡_m≠
 *
båfs_gë_chunk_m≠
(
båfs_fs_öfo
 *
fs_öfo
,

680 
u64
 
logiˇl
, u64 
Àngth
);

681 
båfs_ªÀa£_disk_su≥r
(
båfs_su≥r_block
 *
su≥r
);

683 
ölöe
 
	$båfs_dev_°©_öc
(
båfs_devi˚
 *
dev
,

684 
ödex
)

686 
	`©omic_öc
(
dev
->
dev_°©_vÆues
 + 
ödex
);

693 
	`smp_mb__bef‹e_©omic
();

694 
	`©omic_öc
(&
dev
->
dev_°©s_c˙t
);

695 
	}
}

697 
ölöe
 
	$båfs_dev_°©_ªad
(
båfs_devi˚
 *
dev
,

698 
ödex
)

700  
	`©omic_ªad
(
dev
->
dev_°©_vÆues
 + 
ödex
);

701 
	}
}

703 
ölöe
 
	$båfs_dev_°©_ªad_™d_ª£t
(
båfs_devi˚
 *
dev
,

704 
ödex
)

706 
ªt
;

708 
ªt
 = 
	`©omic_xchg
(
dev
->
dev_°©_vÆues
 + 
ödex
, 0);

716 
	`©omic_öc
(&
dev
->
dev_°©s_c˙t
);

717  
ªt
;

718 
	}
}

720 
ölöe
 
	$båfs_dev_°©_£t
(
båfs_devi˚
 *
dev
,

721 
ödex
, 
vÆ
)

723 
	`©omic_£t
(
dev
->
dev_°©_vÆues
 + 
ödex
, 
vÆ
);

730 
	`smp_mb__bef‹e_©omic
();

731 
	`©omic_öc
(&
dev
->
dev_°©s_c˙t
);

732 
	}
}

734 
ölöe
 c⁄° *
	$båfs_dev_«me
(c⁄° 
båfs_devi˚
 *
devi˚
)

736 i‡(!
devi˚
 || 
	`ã°_bô
(
BTRFS_DEV_STATE_MISSING
, &devi˚->
dev_°©e
))

739  
	`rcu_°r_dîef
(
devi˚
->
«me
);

740 
	}
}

742 
båfs_commô_devi˚_sizes
(
båfs_å™ß˘i⁄
 *
å™s
);

744 
li°_hód
 * 
__©åibuã_c⁄°__
 
båfs_gë_fs_uuids
();

745 
boﬁ
 
båfs_check_rw_degødabÀ
(
båfs_fs_öfo
 *
fs_öfo
,

746 
båfs_devi˚
 *
Áûög_dev
);

747 
båfs_s¸©ch_su≥rblocks
(
båfs_fs_öfo
 *
fs_öfo
,

748 
block_devi˚
 *
bdev
,

749 c⁄° *
devi˚_∑th
);

751 
båfs_øid_ty≥s
 
__©åibuã_c⁄°__
 
båfs_bg_Êags_to_øid_ödex
(
u64
 
Êags
);

752 
båfs_bg_ty≥_to_Á˘‹
(
u64
 
Êags
);

753 c⁄° *
båfs_bg_ty≥_to_øid_«me
(
u64
 
Êags
);

754 
båfs_vîify_dev_exã¡s
(
båfs_fs_öfo
 *
fs_öfo
);

755 
boﬁ
 
båfs_ª∑ú_⁄e_z⁄e
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
logiˇl
);

757 
boﬁ
 
båfs_pö√d_by_sw≠fûe
(
båfs_fs_öfo
 *
fs_öfo
, *
±r
);

758 
u8
 *
båfs_sb_fsid_±r
(
båfs_su≥r_block
 *
sb
);

	@xattr.c

6 
	~<löux/öô.h
>

7 
	~<löux/fs.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/rw£m.h
>

10 
	~<löux/x©å.h
>

11 
	~<löux/£curôy.h
>

12 
	~<löux/posix_a˛_x©å.h
>

13 
	~<löux/ivîsi⁄.h
>

14 
	~<löux/sched/mm.h
>

15 
	~"˘ªe.h
"

16 
	~"fs.h
"

17 
	~"mesßges.h
"

18 
	~"båfs_öode.h
"

19 
	~"å™ß˘i⁄.h
"

20 
	~"x©å.h
"

21 
	~"disk-io.h
"

22 
	~"¥›s.h
"

23 
	~"lockög.h
"

24 
	~"ac˚ss‹s.h
"

25 
	~"dú-ôem.h
"

27 
	$båfs_gëx©å
(
öode
 *öode, c⁄° *
«me
,

28 *
buf„r
, 
size_t
 
size
)

30 
båfs_dú_ôem
 *
di
;

31 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

32 
båfs_∑th
 *
∑th
;

33 
exã¡_buf„r
 *
Àaf
;

34 
ªt
 = 0;

35 
d©a_±r
;

37 
∑th
 = 
	`båfs_Æloc_∑th
();

38 i‡(!
∑th
)

39  -
ENOMEM
;

42 
di
 = 
	`båfs_lookup_x©å
(
NULL
, 
roŸ
, 
∑th
, 
	`båfs_öo
(
	`BTRFS_I
(
öode
)),

43 
«me
, 
	`°æí
(name), 0);

44 i‡(!
di
) {

45 
ªt
 = -
ENODATA
;

46 
out
;

47 } i‡(
	`IS_ERR
(
di
)) {

48 
ªt
 = 
	`PTR_ERR
(
di
);

49 
out
;

52 
Àaf
 = 
∑th
->
nodes
[0];

54 i‡(!
size
) {

55 
ªt
 = 
	`båfs_dú_d©a_Àn
(
Àaf
, 
di
);

56 
out
;

60 i‡(
	`båfs_dú_d©a_Àn
(
Àaf
, 
di
Ë> 
size
) {

61 
ªt
 = -
ERANGE
;

62 
out
;

72 
d©a_±r
 = ()((*)(
di
 + 1) +

73 
	`båfs_dú_«me_Àn
(
Àaf
, 
di
));

74 
	`ªad_exã¡_buf„r
(
Àaf
, 
buf„r
, 
d©a_±r
,

75 
	`båfs_dú_d©a_Àn
(
Àaf
, 
di
));

76 
ªt
 = 
	`båfs_dú_d©a_Àn
(
Àaf
, 
di
);

78 
out
:

79 
	`båfs_‰ì_∑th
(
∑th
);

80  
ªt
;

81 
	}
}

83 
	$båfs_£tx©å
(
båfs_å™s_h™dÀ
 *
å™s
, 
öode
 *inode,

84 c⁄° *
«me
, c⁄° *
vÆue
, 
size_t
 
size
, 
Êags
)

86 
båfs_dú_ôem
 *
di
 = 
NULL
;

87 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

88 
båfs_fs_öfo
 *
fs_öfo
 = 
roŸ
->fs_info;

89 
båfs_∑th
 *
∑th
;

90 
size_t
 
«me_Àn
 = 
	`°æí
(
«me
);

91 
ªt
 = 0;

93 
	`ASSERT
(
å™s
);

95 i‡(
«me_Àn
 + 
size
 > 
	`BTRFS_MAX_XATTR_SIZE
(
roŸ
->
fs_öfo
))

96  -
ENOSPC
;

98 
∑th
 = 
	`båfs_Æloc_∑th
();

99 i‡(!
∑th
)

100  -
ENOMEM
;

101 
∑th
->
skù_ªÀa£_⁄_îr‹
 = 1;

103 i‡(!
vÆue
) {

104 
di
 = 
	`båfs_lookup_x©å
(
å™s
, 
roŸ
, 
∑th
,

105 
	`båfs_öo
(
	`BTRFS_I
(
öode
)), 
«me
, 
«me_Àn
, -1);

106 i‡(!
di
 && (
Êags
 & 
XATTR_REPLACE
))

107 
ªt
 = -
ENODATA
;

108 i‡(
	`IS_ERR
(
di
))

109 
ªt
 = 
	`PTR_ERR
(
di
);

110 i‡(
di
)

111 
ªt
 = 
	`båfs_dñëe_⁄e_dú_«me
(
å™s
, 
roŸ
, 
∑th
, 
di
);

112 
out
;

122 i‡(
Êags
 & 
XATTR_REPLACE
) {

123 
	`ASSERT
(
	`öode_is_locked
(
öode
));

124 
di
 = 
	`båfs_lookup_x©å
(
NULL
, 
roŸ
, 
∑th
,

125 
	`båfs_öo
(
	`BTRFS_I
(
öode
)), 
«me
, 
«me_Àn
, 0);

126 i‡(!
di
)

127 
ªt
 = -
ENODATA
;

128 i‡(
	`IS_ERR
(
di
))

129 
ªt
 = 
	`PTR_ERR
(
di
);

130 i‡(
ªt
)

131 
out
;

132 
	`båfs_ªÀa£_∑th
(
∑th
);

133 
di
 = 
NULL
;

136 
ªt
 = 
	`båfs_ö£π_x©å_ôem
(
å™s
, 
roŸ
, 
∑th
, 
	`båfs_öo
(
	`BTRFS_I
(
öode
)),

137 
«me
, 
«me_Àn
, 
vÆue
, 
size
);

138 i‡(
ªt
 =-
EOVERFLOW
) {

144 
ªt
 = 0;

145 
	`båfs_as£π_åì_wrôe_locked
(
∑th
->
nodes
[0]);

146 
di
 = 
	`båfs_m©ch_dú_ôem_«me
(
fs_öfo
, 
∑th
, 
«me
, 
«me_Àn
);

147 i‡(!
di
 && !(
Êags
 & 
XATTR_REPLACE
)) {

148 
ªt
 = -
ENOSPC
;

149 
out
;

151 } i‡(
ªt
 =-
EEXIST
) {

152 
ªt
 = 0;

153 
di
 = 
	`båfs_m©ch_dú_ôem_«me
(
fs_öfo
, 
∑th
, 
«me
, 
«me_Àn
);

154 
	`ASSERT
(
di
);

155 } i‡(
ªt
) {

156 
out
;

159 i‡(
di
 && (
Êags
 & 
XATTR_CREATE
)) {

160 
ªt
 = -
EEXIST
;

161 
out
;

164 i‡(
di
) {

172 c⁄° 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

173 
exã¡_buf„r
 *
Àaf
 = 
∑th
->
nodes
[0];

174 c⁄° 
u16
 
ﬁd_d©a_Àn
 = 
	`båfs_dú_d©a_Àn
(
Àaf
, 
di
);

175 c⁄° 
u32
 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

176 c⁄° 
u32
 
d©a_size
 = (*
di
Ë+ 
«me_Àn
 + 
size
;

177 
d©a_±r
;

178 *
±r
;

180 i‡(
size
 > 
ﬁd_d©a_Àn
) {

181 i‡(
	`båfs_Àaf_‰ì_•a˚
(
Àaf
) <

182 (
size
 - 
ﬁd_d©a_Àn
)) {

183 
ªt
 = -
ENOSPC
;

184 
out
;

188 i‡(
ﬁd_d©a_Àn
 + 
«me_Àn
 + (*
di
Ë=
ôem_size
) {

190 i‡(
size
 > 
ﬁd_d©a_Àn
)

191 
	`båfs_exãnd_ôem
(
å™s
, 
∑th
, 
size
 - 
ﬁd_d©a_Àn
);

192 i‡(
size
 < 
ﬁd_d©a_Àn
)

193 
	`båfs_åunˇã_ôem
(
å™s
, 
∑th
, 
d©a_size
, 1);

196 
ªt
 = 
	`båfs_dñëe_⁄e_dú_«me
(
å™s
, 
roŸ
, 
∑th
, 
di
);

197 i‡(
ªt
)

198 
out
;

199 
	`båfs_exãnd_ôem
(
å™s
, 
∑th
, 
d©a_size
);

202 
±r
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, );

203 
±r
 +
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
Ë- 
d©a_size
;

204 
di
 = (
båfs_dú_ôem
 *)
±r
;

205 
	`båfs_£t_dú_d©a_Àn
(
Àaf
, 
di
, 
size
);

206 
d©a_±r
 = (()(
di
 + 1)Ë+ 
«me_Àn
;

207 
	`wrôe_exã¡_buf„r
(
Àaf
, 
vÆue
, 
d©a_±r
, 
size
);

208 
	`båfs_m¨k_buf„r_dúty
(
å™s
, 
Àaf
);

216 
out
:

217 
	`båfs_‰ì_∑th
(
∑th
);

218 i‡(!
ªt
) {

219 
	`£t_bô
(
BTRFS_INODE_COPY_EVERYTHING
,

220 &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
);

221 
	`˛ór_bô
(
BTRFS_INODE_NO_XATTRS
, &
	`BTRFS_I
(
öode
)->
ru¡ime_Êags
);

223  
ªt
;

224 
	}
}

229 
	$båfs_£tx©å_å™s
(
öode
 *öode, c⁄° *
«me
,

230 c⁄° *
vÆue
, 
size_t
 
size
, 
Êags
)

232 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

233 
båfs_å™s_h™dÀ
 *
å™s
;

234 c⁄° 
boﬁ
 
°¨t_å™s
 = (
cuºít
->
jou∫Æ_öfo
 =
NULL
);

235 
ªt
;

237 i‡(
°¨t_å™s
) {

242 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 2);

243 i‡(
	`IS_ERR
(
å™s
))

244  
	`PTR_ERR
(
å™s
);

257 
	`ASSERT
(
	`°∫cmp
(
«me
, 
XATTR_SECURITY_PREFIX
,

258 
XATTR_SECURITY_PREFIX_LEN
) == 0);

259 
å™s
 = 
cuºít
->
jou∫Æ_öfo
;

262 
ªt
 = 
	`båfs_£tx©å
(
å™s
, 
öode
, 
«me
, 
vÆue
, 
size
, 
Êags
);

263 i‡(
ªt
)

264 
out
;

266 
	`öode_öc_ivîsi⁄
(
öode
);

267 
	`öode_£t_˘ime_cuºít
(
öode
);

268 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

269 i‡(
ªt
)

270 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

271 
out
:

272 i‡(
°¨t_å™s
)

273 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

274  
ªt
;

275 
	}
}

277 
ssize_t
 
	$båfs_li°x©å
(
díåy
 *díåy, *
buf„r
, 
size_t
 
size
)

279 
båfs_key
 
found_key
;

280 
båfs_key
 
key
;

281 
öode
 *öodê
	`d_öode
(
díåy
);

282 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

283 
båfs_∑th
 *
∑th
;

284 
ôî_ªt
 = 0;

285 
ªt
 = 0;

286 
size_t
 
tŸÆ_size
 = 0, 
size_À·
 = 
size
;

293 
key
.
obje˘id
 = 
	`båfs_öo
(
	`BTRFS_I
(
öode
));

294 
key
.
ty≥
 = 
BTRFS_XATTR_ITEM_KEY
;

295 
key
.
off£t
 = 0;

297 
∑th
 = 
	`båfs_Æloc_∑th
();

298 i‡(!
∑th
)

299  -
ENOMEM
;

300 
∑th
->
ªada
 = 
READA_FORWARD
;

303 
	`båfs_f‹_óch_¶Ÿ
(
roŸ
, &
key
, &
found_key
, 
∑th
, 
ôî_ªt
) {

304 
exã¡_buf„r
 *
Àaf
;

305 
¶Ÿ
;

306 
båfs_dú_ôem
 *
di
;

307 
u32
 
ôem_size
;

308 
u32
 
cur
;

310 
Àaf
 = 
∑th
->
nodes
[0];

311 
¶Ÿ
 = 
∑th
->
¶Ÿs
[0];

314 i‡(
found_key
.
obje˘id
 !
key
.objectid)

316 i‡(
found_key
.
ty≥
 > 
BTRFS_XATTR_ITEM_KEY
)

318 i‡(
found_key
.
ty≥
 < 
BTRFS_XATTR_ITEM_KEY
)

321 
di
 = 
	`båfs_ôem_±r
(
Àaf
, 
¶Ÿ
, 
båfs_dú_ôem
);

322 
ôem_size
 = 
	`båfs_ôem_size
(
Àaf
, 
¶Ÿ
);

323 
cur
 = 0;

324 
cur
 < 
ôem_size
) {

325 
u16
 
«me_Àn
 = 
	`båfs_dú_«me_Àn
(
Àaf
, 
di
);

326 
u16
 
d©a_Àn
 = 
	`båfs_dú_d©a_Àn
(
Àaf
, 
di
);

327 
u32
 
this_Àn
 = (*
di
Ë+ 
«me_Àn
 + 
d©a_Àn
;

328 
«me_±r
 = ()(
di
 + 1);

330 
tŸÆ_size
 +
«me_Àn
 + 1;

335 i‡(!
size
)

336 
√xt
;

338 i‡(!
buf„r
 || (
«me_Àn
 + 1Ë> 
size_À·
) {

339 
ôî_ªt
 = -
ERANGE
;

343 
	`ªad_exã¡_buf„r
(
Àaf
, 
buf„r
, 
«me_±r
, 
«me_Àn
);

344 
buf„r
[
«me_Àn
] = '\0';

346 
size_À·
 -
«me_Àn
 + 1;

347 
buf„r
 +
«me_Àn
 + 1;

348 
√xt
:

349 
cur
 +
this_Àn
;

350 
di
 = (
båfs_dú_ôem
 *)((*)dò+ 
this_Àn
);

354 i‡(
ôî_ªt
 < 0)

355 
ªt
 = 
ôî_ªt
;

357 
ªt
 = 
tŸÆ_size
;

359 
	`båfs_‰ì_∑th
(
∑th
);

361  
ªt
;

362 
	}
}

364 
	$båfs_x©å_h™dÀr_gë
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

365 
díåy
 *
unu£d
, 
öode
 *inode,

366 c⁄° *
«me
, *
buf„r
, 
size_t
 
size
)

368 
«me
 = 
	`x©å_fuŒ_«me
(
h™dÀr
,Çame);

369  
	`båfs_gëx©å
(
öode
, 
«me
, 
buf„r
, 
size
);

370 
	}
}

372 
	$båfs_x©å_h™dÀr_£t
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

373 
m¡_idm≠
 *
idm≠
,

374 
díåy
 *
unu£d
, 
öode
 *inode,

375 c⁄° *
«me
, c⁄° *
buf„r
,

376 
size_t
 
size
, 
Êags
)

378 i‡(
	`båfs_roŸ_ªad⁄ly
(
	`BTRFS_I
(
öode
)->
roŸ
))

379  -
EROFS
;

381 
«me
 = 
	`x©å_fuŒ_«me
(
h™dÀr
,Çame);

382  
	`båfs_£tx©å_å™s
(
öode
, 
«me
, 
buf„r
, 
size
, 
Êags
);

383 
	}
}

385 
	$båfs_x©å_h™dÀr_£t_¥›
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

386 
m¡_idm≠
 *
idm≠
,

387 
díåy
 *
unu£d
, 
öode
 *inode,

388 c⁄° *
«me
, c⁄° *
vÆue
,

389 
size_t
 
size
, 
Êags
)

391 
ªt
;

392 
båfs_å™s_h™dÀ
 *
å™s
;

393 
båfs_roŸ
 *
roŸ
 = 
	`BTRFS_I
(
öode
)->root;

395 
«me
 = 
	`x©å_fuŒ_«me
(
h™dÀr
,Çame);

396 
ªt
 = 
	`båfs_vÆid©e_¥›
(
	`BTRFS_I
(
öode
), 
«me
, 
vÆue
, 
size
);

397 i‡(
ªt
)

398  
ªt
;

400 i‡(
	`båfs_ign‹e_¥›
(
	`BTRFS_I
(
öode
), 
«me
))

403 
å™s
 = 
	`båfs_°¨t_å™ß˘i⁄
(
roŸ
, 2);

404 i‡(
	`IS_ERR
(
å™s
))

405  
	`PTR_ERR
(
å™s
);

407 
ªt
 = 
	`båfs_£t_¥›
(
å™s
, 
öode
, 
«me
, 
vÆue
, 
size
, 
Êags
);

408 i‡(!
ªt
) {

409 
	`öode_öc_ivîsi⁄
(
öode
);

410 
	`öode_£t_˘ime_cuºít
(
öode
);

411 
ªt
 = 
	`båfs_upd©e_öode
(
å™s
, 
roŸ
, 
	`BTRFS_I
(
öode
));

412 i‡(
ªt
)

413 
	`båfs_ab‹t_å™ß˘i⁄
(
å™s
, 
ªt
);

416 
	`båfs_íd_å™ß˘i⁄
(
å™s
);

418  
ªt
;

419 
	}
}

421 c⁄° 
x©å_h™dÀr
 
	gbåfs_£curôy_x©å_h™dÀr
 = {

422 .
¥efix
 = 
XATTR_SECURITY_PREFIX
,

423 .
	ggë
 = 
båfs_x©å_h™dÀr_gë
,

424 .
	g£t
 = 
båfs_x©å_h™dÀr_£t
,

427 c⁄° 
x©å_h™dÀr
 
	gbåfs_åu°ed_x©å_h™dÀr
 = {

428 .
¥efix
 = 
XATTR_TRUSTED_PREFIX
,

429 .
	ggë
 = 
båfs_x©å_h™dÀr_gë
,

430 .
	g£t
 = 
båfs_x©å_h™dÀr_£t
,

433 c⁄° 
x©å_h™dÀr
 
	gbåfs_u£r_x©å_h™dÀr
 = {

434 .
¥efix
 = 
XATTR_USER_PREFIX
,

435 .
	ggë
 = 
båfs_x©å_h™dÀr_gë
,

436 .
	g£t
 = 
båfs_x©å_h™dÀr_£t
,

439 c⁄° 
x©å_h™dÀr
 
	gbåfs_båfs_x©å_h™dÀr
 = {

440 .
¥efix
 = 
XATTR_BTRFS_PREFIX
,

441 .
	ggë
 = 
båfs_x©å_h™dÀr_gë
,

442 .
	g£t
 = 
båfs_x©å_h™dÀr_£t_¥›
,

445 c⁄° 
x©å_h™dÀr
 *
	gbåfs_x©å_h™dÀrs
[] = {

446 &
båfs_£curôy_x©å_h™dÀr
,

447 &
båfs_åu°ed_x©å_h™dÀr
,

448 &
båfs_u£r_x©å_h™dÀr
,

449 &
båfs_båfs_x©å_h™dÀr
,

450 
NULL
,

453 
	$båfs_öôx©ås
(
öode
 *inode,

454 c⁄° 
x©å
 *
x©å_¨øy
, *
fs_¥iv©e
)

456 
båfs_å™s_h™dÀ
 *
å™s
 = 
fs_¥iv©e
;

457 c⁄° 
x©å
 *xattr;

458 
nofs_Êag
;

459 *
«me
;

460 
îr
 = 0;

466 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

467 
x©å
 = 
x©å_¨øy
; x©å->
«me
 !
NULL
; xattr++) {

468 
«me
 = 
	`kmÆloc
(
XATTR_SECURITY_PREFIX_LEN
 +

469 
	`°æí
(
x©å
->
«me
Ë+ 1, 
GFP_KERNEL
);

470 i‡(!
«me
) {

471 
îr
 = -
ENOMEM
;

474 
	`°r˝y
(
«me
, 
XATTR_SECURITY_PREFIX
);

475 
	`°r˝y
(
«me
 + 
XATTR_SECURITY_PREFIX_LEN
, 
x©å
->name);

476 
îr
 = 
	`båfs_£tx©å
(
å™s
, 
öode
, 
«me
, 
x©å
->
vÆue
,

477 
x©å
->
vÆue_Àn
, 0);

478 
	`k‰ì
(
«me
);

479 i‡(
îr
 < 0)

482 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

483  
îr
;

484 
	}
}

486 
	$båfs_x©å_£curôy_öô
(
båfs_å™s_h™dÀ
 *
å™s
,

487 
öode
 *öode, öodê*
dú
,

488 c⁄° 
q°r
 *qstr)

490  
	`£curôy_öode_öô_£curôy
(
öode
, 
dú
, 
q°r
,

491 &
båfs_öôx©ås
, 
å™s
);

492 
	}
}

	@xattr.h

6 #i‚de‡
BTRFS_XATTR_H


7 
	#BTRFS_XATTR_H


	)

9 
	~<löux/x©å.h
>

11 c⁄° 
x©å_h™dÀr
 *
båfs_x©å_h™dÀrs
[];

13 
båfs_gëx©å
(
öode
 *öode, c⁄° *
«me
,

14 *
buf„r
, 
size_t
 
size
);

15 
båfs_£tx©å
(
båfs_å™s_h™dÀ
 *
å™s
, 
öode
 *inode,

16 c⁄° *
«me
, c⁄° *
vÆue
, 
size_t
 
size
, 
Êags
);

17 
båfs_£tx©å_å™s
(
öode
 *öode, c⁄° *
«me
,

18 c⁄° *
vÆue
, 
size_t
 
size
, 
Êags
);

19 
ssize_t
 
båfs_li°x©å
(
díåy
 *díåy, *
buf„r
, 
size_t
 
size
);

21 
båfs_x©å_£curôy_öô
(
båfs_å™s_h™dÀ
 *
å™s
,

22 
öode
 *öode, öodê*
dú
,

23 c⁄° 
q°r
 *qstr);

	@zlib.c

10 
	~<löux/kî√l.h
>

11 
	~<löux/¶ab.h
>

12 
	~<löux/zlib.h
>

13 
	~<löux/zutû.h
>

14 
	~<löux/mm.h
>

15 
	~<löux/öô.h
>

16 
	~<löux/îr.h
>

17 
	~<löux/sched.h
>

18 
	~<löux/∑gem≠.h
>

19 
	~<löux/bio.h
>

20 
	~<löux/ªfcou¡.h
>

21 
	~"com¥essi⁄.h
"

24 
	#ZLIB_DFLTCC_BUF_SIZE
 (4 * 
PAGE_SIZE
)

	)

26 
	sw‹k•a˚
 {

27 
z_°ªam
 
	m°rm
;

28 *
	mbuf
;

29 
	mbuf_size
;

30 
li°_hód
 
	mli°
;

31 
	mÀvñ
;

34 
w‹k•a˚_m™agî
 
	gwsm
;

36 
li°_hód
 *
	$zlib_gë_w‹k•a˚
(
Àvñ
)

38 
li°_hód
 *
ws
 = 
	`båfs_gë_w‹k•a˚
(
BTRFS_COMPRESS_ZLIB
, 
Àvñ
);

39 
w‹k•a˚
 *w‹k•a˚ = 
	`li°_íåy
(
ws
, w‹k•a˚, 
li°
);

41 
w‹k•a˚
->
Àvñ
 =Üevel;

43  
ws
;

44 
	}
}

46 
	$zlib_‰ì_w‹k•a˚
(
li°_hód
 *
ws
)

48 
w‹k•a˚
 *w‹k•a˚ = 
	`li°_íåy
(
ws
, w‹k•a˚, 
li°
);

50 
	`kv‰ì
(
w‹k•a˚
->
°rm
.workspace);

51 
	`k‰ì
(
w‹k•a˚
->
buf
);

52 
	`k‰ì
(
w‹k•a˚
);

53 
	}
}

55 
li°_hód
 *
	$zlib_Æloc_w‹k•a˚
(
Àvñ
)

57 
w‹k•a˚
 *workspace;

58 
w‹k•a˚size
;

60 
w‹k•a˚
 = 
	`kzÆloc
((*w‹k•a˚), 
GFP_KERNEL
);

61 i‡(!
w‹k•a˚
)

62  
	`ERR_PTR
(-
ENOMEM
);

64 
w‹k•a˚size
 = 
	`max
(
	`zlib_deÊ©e_w‹k•a˚size
(
MAX_WBITS
, 
MAX_MEM_LEVEL
),

65 
	`zlib_öÊ©e_w‹k•a˚size
());

66 
w‹k•a˚
->
°rm
.w‹k•a˚ = 
	`kvzÆloc
(
w‹k•a˚size
, 
GFP_KERNEL
 | 
__GFP_NOWARN
);

67 
w‹k•a˚
->
Àvñ
 =Üevel;

68 
w‹k•a˚
->
buf
 = 
NULL
;

73 i‡(
	`zlib_deÊ©e_dÊtcc_íabÀd
()) {

74 
w‹k•a˚
->
buf
 = 
	`kmÆloc
(
ZLIB_DFLTCC_BUF_SIZE
,

75 
__GFP_NOMEMALLOC
 | 
__GFP_NORETRY
 |

76 
__GFP_NOWARN
 | 
GFP_NOIO
);

77 
w‹k•a˚
->
buf_size
 = 
ZLIB_DFLTCC_BUF_SIZE
;

79 i‡(!
w‹k•a˚
->
buf
) {

80 
w‹k•a˚
->
buf
 = 
	`kmÆloc
(
PAGE_SIZE
, 
GFP_KERNEL
);

81 
w‹k•a˚
->
buf_size
 = 
PAGE_SIZE
;

83 i‡(!
w‹k•a˚
->
°rm
.w‹k•a˚ || !w‹k•a˚->
buf
)

84 
Áû
;

86 
	`INIT_LIST_HEAD
(&
w‹k•a˚
->
li°
);

88  &
w‹k•a˚
->
li°
;

89 
Áû
:

90 
	`zlib_‰ì_w‹k•a˚
(&
w‹k•a˚
->
li°
);

91  
	`ERR_PTR
(-
ENOMEM
);

92 
	}
}

94 
	$zlib_com¥ess_∑ges
(
li°_hód
 *
ws
, 
addªss_•a˚
 *
m≠pög
,

95 
u64
 
°¨t
, 
∑ge
 **
∑ges
, *
out_∑ges
,

96 *
tŸÆ_ö
, *
tŸÆ_out
)

98 
w‹k•a˚
 *w‹k•a˚ = 
	`li°_íåy
(
ws
, w‹k•a˚, 
li°
);

99 
ªt
;

100 *
d©a_ö
 = 
NULL
;

101 *
˝age_out
;

102 
ƒ_∑ges
 = 0;

103 
∑ge
 *
ö_∑ge
 = 
NULL
;

104 
∑ge
 *
out_∑ge
 = 
NULL
;

105 
byãs_À·
;

106 
ö_buf_∑ges
;

107 
Àn
 = *
tŸÆ_out
;

108 
ƒ_de°_∑ges
 = *
out_∑ges
;

109 c⁄° 
max_out
 = 
ƒ_de°_∑ges
 * 
PAGE_SIZE
;

111 *
out_∑ges
 = 0;

112 *
tŸÆ_out
 = 0;

113 *
tŸÆ_ö
 = 0;

115 i‡(
Z_OK
 !
	`zlib_deÊ©eInô
(&
w‹k•a˚
->
°rm
, w‹k•a˚->
Àvñ
)) {

116 
	`¥_w¨n
("BTRFS: deflateInit failed\n");

117 
ªt
 = -
EIO
;

118 
out
;

121 
w‹k•a˚
->
°rm
.
tŸÆ_ö
 = 0;

122 
w‹k•a˚
->
°rm
.
tŸÆ_out
 = 0;

124 
out_∑ge
 = 
	`Æloc_∑ge
(
GFP_NOFS
);

125 i‡(
out_∑ge
 =
NULL
) {

126 
ªt
 = -
ENOMEM
;

127 
out
;

129 
˝age_out
 = 
	`∑ge_addªss
(
out_∑ge
);

130 
∑ges
[0] = 
out_∑ge
;

131 
ƒ_∑ges
 = 1;

133 
w‹k•a˚
->
°rm
.
√xt_ö
 = w‹k•a˚->
buf
;

134 
w‹k•a˚
->
°rm
.
avaû_ö
 = 0;

135 
w‹k•a˚
->
°rm
.
√xt_out
 = 
˝age_out
;

136 
w‹k•a˚
->
°rm
.
avaû_out
 = 
PAGE_SIZE
;

138 
w‹k•a˚
->
°rm
.
tŸÆ_ö
 < 
Àn
) {

143 i‡(
w‹k•a˚
->
°rm
.
avaû_ö
 == 0) {

144 
byãs_À·
 = 
Àn
 - 
w‹k•a˚
->
°rm
.
tŸÆ_ö
;

145 
ö_buf_∑ges
 = 
	`mö
(
	`DIV_ROUND_UP
(
byãs_À·
, 
PAGE_SIZE
),

146 
w‹k•a˚
->
buf_size
 / 
PAGE_SIZE
);

147 i‡(
ö_buf_∑ges
 > 1) {

148 
i
;

150 
i
 = 0; i < 
ö_buf_∑ges
; i++) {

151 i‡(
d©a_ö
) {

152 
	`kunm≠_loˇl
(
d©a_ö
);

153 
	`put_∑ge
(
ö_∑ge
);

155 
ö_∑ge
 = 
	`föd_gë_∑ge
(
m≠pög
,

156 
°¨t
 >> 
PAGE_SHIFT
);

157 
d©a_ö
 = 
	`km≠_loˇl_∑ge
(
ö_∑ge
);

158 
	`c›y_∑ge
(
w‹k•a˚
->
buf
 + 
i
 * 
PAGE_SIZE
,

159 
d©a_ö
);

160 
°¨t
 +
PAGE_SIZE
;

162 
w‹k•a˚
->
°rm
.
√xt_ö
 = w‹k•a˚->
buf
;

164 i‡(
d©a_ö
) {

165 
	`kunm≠_loˇl
(
d©a_ö
);

166 
	`put_∑ge
(
ö_∑ge
);

168 
ö_∑ge
 = 
	`föd_gë_∑ge
(
m≠pög
,

169 
°¨t
 >> 
PAGE_SHIFT
);

170 
d©a_ö
 = 
	`km≠_loˇl_∑ge
(
ö_∑ge
);

171 
°¨t
 +
PAGE_SIZE
;

172 
w‹k•a˚
->
°rm
.
√xt_ö
 = 
d©a_ö
;

174 
w‹k•a˚
->
°rm
.
avaû_ö
 = 
	`mö
(
byãs_À·
,

175 (Ë
w‹k•a˚
->
buf_size
);

178 
ªt
 = 
	`zlib_deÊ©e
(&
w‹k•a˚
->
°rm
, 
Z_SYNC_FLUSH
);

179 i‡(
ªt
 !
Z_OK
) {

180 
	`¥_debug
("BTRFS: deflate inÜoopÑeturned %d\n",

181 
ªt
);

182 
	`zlib_deÊ©eEnd
(&
w‹k•a˚
->
°rm
);

183 
ªt
 = -
EIO
;

184 
out
;

188 i‡(
w‹k•a˚
->
°rm
.
tŸÆ_ö
 > 8192 &&

189 
w‹k•a˚
->
°rm
.
tŸÆ_ö
 <

190 
w‹k•a˚
->
°rm
.
tŸÆ_out
) {

191 
ªt
 = -
E2BIG
;

192 
out
;

198 i‡(
w‹k•a˚
->
°rm
.
avaû_out
 == 0) {

199 i‡(
ƒ_∑ges
 =
ƒ_de°_∑ges
) {

200 
ªt
 = -
E2BIG
;

201 
out
;

203 
out_∑ge
 = 
	`Æloc_∑ge
(
GFP_NOFS
);

204 i‡(
out_∑ge
 =
NULL
) {

205 
ªt
 = -
ENOMEM
;

206 
out
;

208 
˝age_out
 = 
	`∑ge_addªss
(
out_∑ge
);

209 
∑ges
[
ƒ_∑ges
] = 
out_∑ge
;

210 
ƒ_∑ges
++;

211 
w‹k•a˚
->
°rm
.
avaû_out
 = 
PAGE_SIZE
;

212 
w‹k•a˚
->
°rm
.
√xt_out
 = 
˝age_out
;

215 i‡(
w‹k•a˚
->
°rm
.
tŸÆ_ö
 >
Àn
)

217 i‡(
w‹k•a˚
->
°rm
.
tŸÆ_out
 > 
max_out
)

220 
w‹k•a˚
->
°rm
.
avaû_ö
 = 0;

225 
ªt
 !
Z_STREAM_END
) {

226 
ªt
 = 
	`zlib_deÊ©e
(&
w‹k•a˚
->
°rm
, 
Z_FINISH
);

227 i‡(
ªt
 =
Z_STREAM_END
)

229 i‡(
ªt
 !
Z_OK
 &&Ñë !
Z_BUF_ERROR
) {

230 
	`zlib_deÊ©eEnd
(&
w‹k•a˚
->
°rm
);

231 
ªt
 = -
EIO
;

232 
out
;

233 } i‡(
w‹k•a˚
->
°rm
.
avaû_out
 == 0) {

235 i‡(
ƒ_∑ges
 =
ƒ_de°_∑ges
) {

236 
ªt
 = -
E2BIG
;

237 
out
;

239 
out_∑ge
 = 
	`Æloc_∑ge
(
GFP_NOFS
);

240 i‡(
out_∑ge
 =
NULL
) {

241 
ªt
 = -
ENOMEM
;

242 
out
;

244 
˝age_out
 = 
	`∑ge_addªss
(
out_∑ge
);

245 
∑ges
[
ƒ_∑ges
] = 
out_∑ge
;

246 
ƒ_∑ges
++;

247 
w‹k•a˚
->
°rm
.
avaû_out
 = 
PAGE_SIZE
;

248 
w‹k•a˚
->
°rm
.
√xt_out
 = 
˝age_out
;

251 
	`zlib_deÊ©eEnd
(&
w‹k•a˚
->
°rm
);

253 i‡(
w‹k•a˚
->
°rm
.
tŸÆ_out
 >w‹k•a˚->°rm.
tŸÆ_ö
) {

254 
ªt
 = -
E2BIG
;

255 
out
;

258 
ªt
 = 0;

259 *
tŸÆ_out
 = 
w‹k•a˚
->
°rm
.total_out;

260 *
tŸÆ_ö
 = 
w‹k•a˚
->
°rm
.total_in;

261 
out
:

262 *
out_∑ges
 = 
ƒ_∑ges
;

263 i‡(
d©a_ö
) {

264 
	`kunm≠_loˇl
(
d©a_ö
);

265 
	`put_∑ge
(
ö_∑ge
);

268  
ªt
;

269 
	}
}

271 
	$zlib_decom¥ess_bio
(
li°_hód
 *
ws
, 
com¥es£d_bio
 *
cb
)

273 
w‹k•a˚
 *w‹k•a˚ = 
	`li°_íåy
(
ws
, w‹k•a˚, 
li°
);

274 
ªt
 = 0, 
ªt2
;

275 
wbôs
 = 
MAX_WBITS
;

276 *
d©a_ö
;

277 
size_t
 
tŸÆ_out
 = 0;

278 
∑ge_ö_ödex
 = 0;

279 
size_t
 
§˛í
 = 
cb
->
com¥es£d_Àn
;

280 
tŸÆ_∑ges_ö
 = 
	`DIV_ROUND_UP
(
§˛í
, 
PAGE_SIZE
);

281 
buf_°¨t
;

282 
∑ge
 **
∑ges_ö
 = 
cb
->
com¥es£d_∑ges
;

284 
d©a_ö
 = 
	`km≠_loˇl_∑ge
(
∑ges_ö
[
∑ge_ö_ödex
]);

285 
w‹k•a˚
->
°rm
.
√xt_ö
 = 
d©a_ö
;

286 
w‹k•a˚
->
°rm
.
avaû_ö
 = 
	`mö_t
(
size_t
, 
§˛í
, 
PAGE_SIZE
);

287 
w‹k•a˚
->
°rm
.
tŸÆ_ö
 = 0;

289 
w‹k•a˚
->
°rm
.
tŸÆ_out
 = 0;

290 
w‹k•a˚
->
°rm
.
√xt_out
 = w‹k•a˚->
buf
;

291 
w‹k•a˚
->
°rm
.
avaû_out
 = w‹k•a˚->
buf_size
;

295 i‡(
§˛í
 > 2 && !(
d©a_ö
[1] & 
PRESET_DICT
) &&

296 ((
d©a_ö
[0] & 0x0fË=
Z_DEFLATED
) &&

297 !(((
d©a_ö
[0]<<8) + data_in[1]) % 31)) {

299 
wbôs
 = -((
d©a_ö
[0] >> 4) + 8);

300 
w‹k•a˚
->
°rm
.
√xt_ö
 += 2;

301 
w‹k•a˚
->
°rm
.
avaû_ö
 -= 2;

304 i‡(
Z_OK
 !
	`zlib_öÊ©eInô2
(&
w‹k•a˚
->
°rm
, 
wbôs
)) {

305 
	`¥_w¨n
("BTRFS: inflateInit failed\n");

306 
	`kunm≠_loˇl
(
d©a_ö
);

307  -
EIO
;

309 
w‹k•a˚
->
°rm
.
tŸÆ_ö
 < 
§˛í
) {

310 
ªt
 = 
	`zlib_öÊ©e
(&
w‹k•a˚
->
°rm
, 
Z_NO_FLUSH
);

311 i‡(
ªt
 !
Z_OK
 &&Ñë !
Z_STREAM_END
)

314 
buf_°¨t
 = 
tŸÆ_out
;

315 
tŸÆ_out
 = 
w‹k•a˚
->
°rm
.total_out;

318 i‡(
buf_°¨t
 =
tŸÆ_out
)

321 
ªt2
 = 
	`båfs_decom¥ess_buf2∑ge
(
w‹k•a˚
->
buf
,

322 
tŸÆ_out
 - 
buf_°¨t
, 
cb
, buf_start);

323 i‡(
ªt2
 == 0) {

324 
ªt
 = 0;

325 
d⁄e
;

328 
w‹k•a˚
->
°rm
.
√xt_out
 = w‹k•a˚->
buf
;

329 
w‹k•a˚
->
°rm
.
avaû_out
 = w‹k•a˚->
buf_size
;

331 i‡(
w‹k•a˚
->
°rm
.
avaû_ö
 == 0) {

332 
tmp
;

333 
	`kunm≠_loˇl
(
d©a_ö
);

334 
∑ge_ö_ödex
++;

335 i‡(
∑ge_ö_ödex
 >
tŸÆ_∑ges_ö
) {

336 
d©a_ö
 = 
NULL
;

339 
d©a_ö
 = 
	`km≠_loˇl_∑ge
(
∑ges_ö
[
∑ge_ö_ödex
]);

340 
w‹k•a˚
->
°rm
.
√xt_ö
 = 
d©a_ö
;

341 
tmp
 = 
§˛í
 - 
w‹k•a˚
->
°rm
.
tŸÆ_ö
;

342 
w‹k•a˚
->
°rm
.
avaû_ö
 = 
	`mö
(
tmp
, 
PAGE_SIZE
);

345 i‡(
ªt
 !
Z_STREAM_END
)

346 
ªt
 = -
EIO
;

348 
ªt
 = 0;

349 
d⁄e
:

350 
	`zlib_öÊ©eEnd
(&
w‹k•a˚
->
°rm
);

351 i‡(
d©a_ö
)

352 
	`kunm≠_loˇl
(
d©a_ö
);

353  
ªt
;

354 
	}
}

356 
	$zlib_decom¥ess
(
li°_hód
 *
ws
, c⁄° 
u8
 *
d©a_ö
,

357 
∑ge
 *
de°_∑ge
, 
°¨t_byã
, 
size_t
 
§˛í
,

358 
size_t
 
de°Àn
)

360 
w‹k•a˚
 *w‹k•a˚ = 
	`li°_íåy
(
ws
, w‹k•a˚, 
li°
);

361 
ªt
 = 0;

362 
wbôs
 = 
MAX_WBITS
;

363 
byãs_À·
;

364 
tŸÆ_out
 = 0;

365 
pg_off£t
 = 0;

367 
de°Àn
 = 
	`mö_t
(, de°Àn, 
PAGE_SIZE
);

368 
byãs_À·
 = 
de°Àn
;

370 
w‹k•a˚
->
°rm
.
√xt_ö
 = 
d©a_ö
;

371 
w‹k•a˚
->
°rm
.
avaû_ö
 = 
§˛í
;

372 
w‹k•a˚
->
°rm
.
tŸÆ_ö
 = 0;

374 
w‹k•a˚
->
°rm
.
√xt_out
 = w‹k•a˚->
buf
;

375 
w‹k•a˚
->
°rm
.
avaû_out
 = w‹k•a˚->
buf_size
;

376 
w‹k•a˚
->
°rm
.
tŸÆ_out
 = 0;

379 i‡(
§˛í
 > 2 && !(
d©a_ö
[1] & 
PRESET_DICT
) &&

380 ((
d©a_ö
[0] & 0x0fË=
Z_DEFLATED
) &&

381 !(((
d©a_ö
[0]<<8) + data_in[1]) % 31)) {

383 
wbôs
 = -((
d©a_ö
[0] >> 4) + 8);

384 
w‹k•a˚
->
°rm
.
√xt_ö
 += 2;

385 
w‹k•a˚
->
°rm
.
avaû_ö
 -= 2;

388 i‡(
Z_OK
 !
	`zlib_öÊ©eInô2
(&
w‹k•a˚
->
°rm
, 
wbôs
)) {

389 
	`¥_w¨n
("BTRFS: inflateInit failed\n");

390  -
EIO
;

393 
byãs_À·
 > 0) {

394 
buf_°¨t
;

395 
buf_off£t
;

396 
byãs
;

398 
ªt
 = 
	`zlib_öÊ©e
(&
w‹k•a˚
->
°rm
, 
Z_NO_FLUSH
);

399 i‡(
ªt
 !
Z_OK
 &&Ñë !
Z_STREAM_END
)

402 
buf_°¨t
 = 
tŸÆ_out
;

403 
tŸÆ_out
 = 
w‹k•a˚
->
°rm
.total_out;

405 i‡(
tŸÆ_out
 =
buf_°¨t
) {

406 
ªt
 = -
EIO
;

410 i‡(
tŸÆ_out
 <
°¨t_byã
)

411 
√xt
;

413 i‡(
tŸÆ_out
 > 
°¨t_byã
 && 
buf_°¨t
 < start_byte)

414 
buf_off£t
 = 
°¨t_byã
 - 
buf_°¨t
;

416 
buf_off£t
 = 0;

418 
byãs
 = 
	`mö
(
PAGE_SIZE
 - 
pg_off£t
,

419 
PAGE_SIZE
 - (
buf_off£t
 % PAGE_SIZE));

420 
byãs
 = 
	`mö
(byãs, 
byãs_À·
);

422 
	`mem˝y_to_∑ge
(
de°_∑ge
, 
pg_off£t
,

423 
w‹k•a˚
->
buf
 + 
buf_off£t
, 
byãs
);

425 
pg_off£t
 +
byãs
;

426 
byãs_À·
 -
byãs
;

427 
√xt
:

428 
w‹k•a˚
->
°rm
.
√xt_out
 = w‹k•a˚->
buf
;

429 
w‹k•a˚
->
°rm
.
avaû_out
 = w‹k•a˚->
buf_size
;

432 i‡(
ªt
 !
Z_STREAM_END
 && 
byãs_À·
 != 0)

433 
ªt
 = -
EIO
;

435 
ªt
 = 0;

437 
	`zlib_öÊ©eEnd
(&
w‹k•a˚
->
°rm
);

444 i‡(
pg_off£t
 < 
de°Àn
) {

445 
	`memzîo_∑ge
(
de°_∑ge
, 
pg_off£t
, 
de°Àn
 -Ög_offset);

447  
ªt
;

448 
	}
}

450 c⁄° 
båfs_com¥ess_›
 
	gbåfs_zlib_com¥ess
 = {

451 .
w‹k•a˚_m™agî
 = &
wsm
,

452 .
	gmax_Àvñ
 = 9,

453 .
	gdeÁu…_Àvñ
 = 
BTRFS_ZLIB_DEFAULT_LEVEL
,

	@zoned.c

3 
	~<löux/bô›s.h
>

4 
	~<löux/¶ab.h
>

5 
	~<löux/blkdev.h
>

6 
	~<löux/sched/mm.h
>

7 
	~<löux/©omic.h
>

8 
	~<löux/vmÆloc.h
>

9 
	~"˘ªe.h
"

10 
	~"vﬁumes.h
"

11 
	~"z⁄ed.h
"

12 
	~"rcu-°rög.h
"

13 
	~"disk-io.h
"

14 
	~"block-group.h
"

15 
	~"å™ß˘i⁄.h
"

16 
	~"dev-ª∂a˚.h
"

17 
	~"•a˚-öfo.h
"

18 
	~"su≥r.h
"

19 
	~"fs.h
"

20 
	~"ac˚ss‹s.h
"

21 
	~"bio.h
"

24 
	#BTRFS_REPORT_NR_ZONES
 4096

	)

26 
	#WP_MISSING_DEV
 ((
u64
)-1)

	)

28 
	#WP_CONVENTIONAL
 ((
u64
)-2)

	)

37 
	#BTRFS_SB_LOG_PRIMARY_OFFSET
 (0ULL)

	)

38 
	#BTRFS_SB_LOG_FIRST_OFFSET
 (512ULL * 
SZ_1G
)

	)

39 
	#BTRFS_SB_LOG_SECOND_OFFSET
 (4096ULL * 
SZ_1G
)

	)

41 
	#BTRFS_SB_LOG_FIRST_SHIFT
 
	`c⁄°_ûog2
(
BTRFS_SB_LOG_FIRST_OFFSET
)

	)

42 
	#BTRFS_SB_LOG_SECOND_SHIFT
 
	`c⁄°_ûog2
(
BTRFS_SB_LOG_SECOND_OFFSET
)

	)

45 
	#BTRFS_NR_SB_LOG_ZONES
 2

	)

55 
	#BTRFS_MIN_ACTIVE_ZONES
 (
BTRFS_SUPER_MIRROR_MAX
 + 5)

	)

63 
	#BTRFS_MAX_ZONE_SIZE
 
SZ_8G


	)

64 
	#BTRFS_MIN_ZONE_SIZE
 
SZ_4M


	)

66 
	#SUPER_INFO_SECTORS
 ((
u64
)
BTRFS_SUPER_INFO_SIZE
 >> 
SECTOR_SHIFT
)

	)

68 
waô_eb_wrôebacks
(
båfs_block_group
 *
block_group
);

69 
do_z⁄e_föish
(
båfs_block_group
 *
block_group
, 
boﬁ
 
fuŒy_wrôãn
);

71 
ölöe
 
boﬁ
 
	$sb_z⁄e_is_fuŒ
(c⁄° 
blk_z⁄e
 *
z⁄e
)

73  (
z⁄e
->
c⁄d
 =
BLK_ZONE_COND_FULL
) ||

74 (
z⁄e
->
wp
 + 
SUPER_INFO_SECTORS
 > z⁄e->
°¨t
 + z⁄e->
ˇ∑côy
);

75 
	}
}

77 
	$c›y_z⁄e_öfo_cb
(
blk_z⁄e
 *
z⁄e
, 
idx
, *
d©a
)

79 
blk_z⁄e
 *
z⁄es
 = 
d©a
;

81 
	`mem˝y
(&
z⁄es
[
idx
], 
z⁄e
, (*zone));

84 
	}
}

86 
	$sb_wrôe_poöãr
(
block_devi˚
 *
bdev
, 
blk_z⁄e
 *
z⁄es
,

87 
u64
 *
wp_ªt
)

89 
boﬁ
 
em±y
[
BTRFS_NR_SB_LOG_ZONES
];

90 
boﬁ
 
fuŒ
[
BTRFS_NR_SB_LOG_ZONES
];

91 
£˘‹_t
 
£˘‹
;

92 
i
;

94 
i
 = 0; i < 
BTRFS_NR_SB_LOG_ZONES
; i++) {

95 
	`ASSERT
(
z⁄es
[
i
].
ty≥
 !
BLK_ZONE_TYPE_CONVENTIONAL
);

96 
em±y
[
i
] = (
z⁄es
[i].
c⁄d
 =
BLK_ZONE_COND_EMPTY
);

97 
fuŒ
[
i
] = 
	`sb_z⁄e_is_fuŒ
(&
z⁄es
[i]);

117 i‡(
em±y
[0] &&Émpty[1]) {

119 *
wp_ªt
 = 
z⁄es
[0].
°¨t
 << 
SECTOR_SHIFT
;

120  -
ENOENT
;

121 } i‡(
fuŒ
[0] && full[1]) {

123 
addªss_•a˚
 *
m≠pög
 = 
bdev
->
bd_öode
->
i_m≠pög
;

124 
∑ge
 *∑ge[
BTRFS_NR_SB_LOG_ZONES
];

125 
båfs_su≥r_block
 *
su≥r
[
BTRFS_NR_SB_LOG_ZONES
];

126 
i
;

128 
i
 = 0; i < 
BTRFS_NR_SB_LOG_ZONES
; i++) {

129 
u64
 
z⁄e_íd
 = (
z⁄es
[
i
].
°¨t
 + z⁄es[i].
ˇ∑côy
Ë<< 
SECTOR_SHIFT
;

130 
u64
 
byãƒ
 = 
	`ALIGN_DOWN
(
z⁄e_íd
, 
BTRFS_SUPER_INFO_SIZE
) -

131 
BTRFS_SUPER_INFO_SIZE
;

133 
∑ge
[
i
] = 
	`ªad_ˇche_∑ge_gÂ
(
m≠pög
,

134 
byãƒ
 >> 
PAGE_SHIFT
, 
GFP_NOFS
);

135 i‡(
	`IS_ERR
(
∑ge
[
i
])) {

136 i‡(
i
 == 1)

137 
	`båfs_ªÀa£_disk_su≥r
(
su≥r
[0]);

138  
	`PTR_ERR
(
∑ge
[
i
]);

140 
su≥r
[
i
] = 
	`∑ge_addªss
(
∑ge
[i]);

143 i‡(
	`båfs_su≥r_gíî©i⁄
(
su≥r
[0]) >

144 
	`båfs_su≥r_gíî©i⁄
(
su≥r
[1]))

145 
£˘‹
 = 
z⁄es
[1].
°¨t
;

147 
£˘‹
 = 
z⁄es
[0].
°¨t
;

149 
i
 = 0; i < 
BTRFS_NR_SB_LOG_ZONES
; i++)

150 
	`båfs_ªÀa£_disk_su≥r
(
su≥r
[
i
]);

151 } i‡(!
fuŒ
[0] && (
em±y
[1] || full[1])) {

152 
£˘‹
 = 
z⁄es
[0].
wp
;

153 } i‡(
fuŒ
[0]) {

154 
£˘‹
 = 
z⁄es
[1].
wp
;

156  -
EUCLEAN
;

158 *
wp_ªt
 = 
£˘‹
 << 
SECTOR_SHIFT
;

160 
	}
}

165 
ölöe
 
u32
 
	$sb_z⁄e_numbî
(
shi·
, 
múr‹
)

167 
u64
 
z⁄e
 = 
U64_MAX
;

169 
	`ASSERT
(
múr‹
 < 
BTRFS_SUPER_MIRROR_MAX
);

170 
múr‹
) {

171 0: 
z⁄e
 = 0; ;

172 1: 
z⁄e
 = 1ULL << (
BTRFS_SB_LOG_FIRST_SHIFT
 - 
shi·
); ;

173 2: 
z⁄e
 = 1ULL << (
BTRFS_SB_LOG_SECOND_SHIFT
 - 
shi·
); ;

176 
	`ASSERT
(
z⁄e
 <
U32_MAX
);

178  (
u32
)
z⁄e
;

179 
	}
}

181 
ölöe
 
£˘‹_t
 
	$z⁄e_°¨t_£˘‹
(
u32
 
z⁄e_numbî
,

182 
block_devi˚
 *
bdev
)

184  (
£˘‹_t
)
z⁄e_numbî
 << 
	`ûog2
(
	`bdev_z⁄e_£˘‹s
(
bdev
));

185 
	}
}

187 
ölöe
 
u64
 
	$z⁄e_°¨t_physiˇl
(
u32
 
z⁄e_numbî
,

188 
båfs_z⁄ed_devi˚_öfo
 *
z⁄e_öfo
)

190  (
u64
)
z⁄e_numbî
 << 
z⁄e_öfo
->
z⁄e_size_shi·
;

191 
	}
}

198 
	$emuœã_ªp‹t_z⁄es
(
båfs_devi˚
 *
devi˚
, 
u64
 
pos
,

199 
blk_z⁄e
 *
z⁄es
, 
ƒ_z⁄es
)

201 c⁄° 
£˘‹_t
 
z⁄e_£˘‹s
 = 
devi˚
->
fs_öfo
->
z⁄e_size
 >> 
SECTOR_SHIFT
;

202 
£˘‹_t
 
bdev_size
 = 
	`bdev_ƒ_£˘‹s
(
devi˚
->
bdev
);

203 
i
;

205 
pos
 >>
SECTOR_SHIFT
;

206 
i
 = 0; i < 
ƒ_z⁄es
; i++) {

207 
z⁄es
[
i
].
°¨t
 = i * 
z⁄e_£˘‹s
 + 
pos
;

208 
z⁄es
[
i
].
Àn
 = 
z⁄e_£˘‹s
;

209 
z⁄es
[
i
].
ˇ∑côy
 = 
z⁄e_£˘‹s
;

210 
z⁄es
[
i
].
wp
 = z⁄es[i].
°¨t
 + 
z⁄e_£˘‹s
;

211 
z⁄es
[
i
].
ty≥
 = 
BLK_ZONE_TYPE_CONVENTIONAL
;

212 
z⁄es
[
i
].
c⁄d
 = 
BLK_ZONE_COND_NOT_WP
;

214 i‡(
z⁄es
[
i
].
wp
 >
bdev_size
) {

215 
i
++;

220  
i
;

221 
	}
}

223 
	$båfs_gë_dev_z⁄es
(
båfs_devi˚
 *
devi˚
, 
u64
 
pos
,

224 
blk_z⁄e
 *
z⁄es
, *
ƒ_z⁄es
)

226 
båfs_z⁄ed_devi˚_öfo
 *
zöfo
 = 
devi˚
->
z⁄e_öfo
;

227 
ªt
;

229 i‡(!*
ƒ_z⁄es
)

232 i‡(!
	`bdev_is_z⁄ed
(
devi˚
->
bdev
)) {

233 
ªt
 = 
	`emuœã_ªp‹t_z⁄es
(
devi˚
, 
pos
, 
z⁄es
, *
ƒ_z⁄es
);

234 *
ƒ_z⁄es
 = 
ªt
;

239 i‡(
zöfo
->
z⁄e_ˇche
) {

240 
i
;

241 
u32
 
zno
;

243 
	`ASSERT
(
	`IS_ALIGNED
(
pos
, 
zöfo
->
z⁄e_size
));

244 
zno
 = 
pos
 >> 
zöfo
->
z⁄e_size_shi·
;

249 *
ƒ_z⁄es
 = 
	`mö_t
(
u32
, *ƒ_z⁄es, 
zöfo
->ƒ_z⁄e†- 
zno
);

251 
i
 = 0; i < *
ƒ_z⁄es
; i++) {

252 
blk_z⁄e
 *
z⁄e_öfo
;

254 
z⁄e_öfo
 = &
zöfo
->
z⁄e_ˇche
[
zno
 + 
i
];

255 i‡(!
z⁄e_öfo
->
Àn
)

259 i‡(
i
 =*
ƒ_z⁄es
) {

261 
	`mem˝y
(
z⁄es
, 
zöfo
->
z⁄e_ˇche
 + 
zno
,

262 (*
zöfo
->
z⁄e_ˇche
Ë* *
ƒ_z⁄es
);

267 
ªt
 = 
	`blkdev_ªp‹t_z⁄es
(
devi˚
->
bdev
, 
pos
 >> 
SECTOR_SHIFT
, *
ƒ_z⁄es
,

268 
c›y_z⁄e_öfo_cb
, 
z⁄es
);

269 i‡(
ªt
 < 0) {

270 
	`båfs_îr_ö_rcu
(
devi˚
->
fs_öfo
,

272 
pos
, 
	`rcu_°r_dîef
(
devi˚
->
«me
),

273 
devi˚
->
devid
);

274  
ªt
;

276 *
ƒ_z⁄es
 = 
ªt
;

277 i‡(!
ªt
)

278  -
EIO
;

281 i‡(
zöfo
->
z⁄e_ˇche
) {

282 
u32
 
zno
 = 
pos
 >> 
zöfo
->
z⁄e_size_shi·
;

284 
	`mem˝y
(
zöfo
->
z⁄e_ˇche
 + 
zno
, 
z⁄es
,

285 (*
zöfo
->
z⁄e_ˇche
Ë* *
ƒ_z⁄es
);

289 
	}
}

292 
	$ˇlcuœã_emuœãd_z⁄e_size
(
båfs_fs_öfo
 *
fs_öfo
)

294 
båfs_∑th
 *
∑th
;

295 
båfs_roŸ
 *
roŸ
 = 
fs_öfo
->
dev_roŸ
;

296 
båfs_key
 
key
;

297 
exã¡_buf„r
 *
Àaf
;

298 
båfs_dev_exã¡
 *
dext
;

299 
ªt
 = 0;

301 
key
.
obje˘id
 = 1;

302 
key
.
ty≥
 = 
BTRFS_DEV_EXTENT_KEY
;

303 
key
.
off£t
 = 0;

305 
∑th
 = 
	`båfs_Æloc_∑th
();

306 i‡(!
∑th
)

307  -
ENOMEM
;

309 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

310 i‡(
ªt
 < 0)

311 
out
;

313 i‡(
∑th
->
¶Ÿs
[0] >
	`båfs_hódî_ƒôems
’©h->
nodes
[0])) {

314 
ªt
 = 
	`båfs_√xt_Àaf
(
roŸ
, 
∑th
);

315 i‡(
ªt
 < 0)

316 
out
;

318 i‡(
ªt
 > 0) {

319 
ªt
 = -
EUCLEAN
;

320 
out
;

324 
Àaf
 = 
∑th
->
nodes
[0];

325 
dext
 = 
	`båfs_ôem_±r
(
Àaf
, 
∑th
->
¶Ÿs
[0], 
båfs_dev_exã¡
);

326 
fs_öfo
->
z⁄e_size
 = 
	`båfs_dev_exã¡_Àngth
(
Àaf
, 
dext
);

327 
ªt
 = 0;

329 
out
:

330 
	`båfs_‰ì_∑th
(
∑th
);

332  
ªt
;

333 
	}
}

335 
	$båfs_gë_dev_z⁄e_öfo_Æl_devi˚s
(
båfs_fs_öfo
 *
fs_öfo
)

337 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

338 
båfs_devi˚
 *
devi˚
;

339 
ªt
 = 0;

342 i‡(!
	`båfs_fs_öcom∑t
(
fs_öfo
, 
ZONED
))

345 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

346 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

348 i‡(!
devi˚
->
bdev
)

351 
ªt
 = 
	`båfs_gë_dev_z⁄e_öfo
(
devi˚
, 
åue
);

352 i‡(
ªt
)

355 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

357  
ªt
;

358 
	}
}

360 
	$båfs_gë_dev_z⁄e_öfo
(
båfs_devi˚
 *
devi˚
, 
boﬁ
 
p›uœã_ˇche
)

362 
båfs_fs_öfo
 *
fs_öfo
 = 
devi˚
->fs_info;

363 
båfs_z⁄ed_devi˚_öfo
 *
z⁄e_öfo
 = 
NULL
;

364 
block_devi˚
 *
bdev
 = 
devi˚
->bdev;

365 
max_a˘ive_z⁄es
;

366 
«˘ive
;

367 
£˘‹_t
 
ƒ_£˘‹s
;

368 
£˘‹_t
 
£˘‹
 = 0;

369 
blk_z⁄e
 *
z⁄es
 = 
NULL
;

370 
i
, 
ƒï‹ãd
 = 0, 
ƒ_z⁄es
;

371 
£˘‹_t
 
z⁄e_£˘‹s
;

372 *
modñ
, *
emuœãd
;

373 
ªt
;

379 i‡(!
	`båfs_fs_öcom∑t
(
fs_öfo
, 
ZONED
))

382 i‡(
devi˚
->
z⁄e_öfo
)

385 
z⁄e_öfo
 = 
	`kzÆloc
((*z⁄e_öfo), 
GFP_KERNEL
);

386 i‡(!
z⁄e_öfo
)

387  -
ENOMEM
;

389 
devi˚
->
z⁄e_öfo
 = zone_info;

391 i‡(!
	`bdev_is_z⁄ed
(
bdev
)) {

392 i‡(!
fs_öfo
->
z⁄e_size
) {

393 
ªt
 = 
	`ˇlcuœã_emuœãd_z⁄e_size
(
fs_öfo
);

394 i‡(
ªt
)

395 
out
;

398 
	`ASSERT
(
fs_öfo
->
z⁄e_size
);

399 
z⁄e_£˘‹s
 = 
fs_öfo
->
z⁄e_size
 >> 
SECTOR_SHIFT
;

401 
z⁄e_£˘‹s
 = 
	`bdev_z⁄e_£˘‹s
(
bdev
);

404 
	`ASSERT
(
	`is_powî_of_two_u64
(
z⁄e_£˘‹s
));

405 
z⁄e_öfo
->
z⁄e_size
 = 
z⁄e_£˘‹s
 << 
SECTOR_SHIFT
;

408 i‡(
z⁄e_öfo
->
z⁄e_size
 > 
BTRFS_MAX_ZONE_SIZE
) {

409 
	`båfs_îr_ö_rcu
(
fs_öfo
,

411 
	`rcu_°r_dîef
(
devi˚
->
«me
),

412 
z⁄e_öfo
->
z⁄e_size
, 
BTRFS_MAX_ZONE_SIZE
);

413 
ªt
 = -
EINVAL
;

414 
out
;

415 } i‡(
z⁄e_öfo
->
z⁄e_size
 < 
BTRFS_MIN_ZONE_SIZE
) {

416 
	`båfs_îr_ö_rcu
(
fs_öfo
,

418 
	`rcu_°r_dîef
(
devi˚
->
«me
),

419 
z⁄e_öfo
->
z⁄e_size
, 
BTRFS_MIN_ZONE_SIZE
);

420 
ªt
 = -
EINVAL
;

421 
out
;

424 
ƒ_£˘‹s
 = 
	`bdev_ƒ_£˘‹s
(
bdev
);

425 
z⁄e_öfo
->
z⁄e_size_shi·
 = 
	`ûog2
(z⁄e_öfo->
z⁄e_size
);

426 
z⁄e_öfo
->
ƒ_z⁄es
 = 
ƒ_£˘‹s
 >> 
	`ûog2
(
z⁄e_£˘‹s
);

427 i‡(!
	`IS_ALIGNED
(
ƒ_£˘‹s
, 
z⁄e_£˘‹s
))

428 
z⁄e_öfo
->
ƒ_z⁄es
++;

430 
max_a˘ive_z⁄es
 = 
	`bdev_max_a˘ive_z⁄es
(
bdev
);

431 i‡(
max_a˘ive_z⁄es
 && max_a˘ive_z⁄e†< 
BTRFS_MIN_ACTIVE_ZONES
) {

432 
	`båfs_îr_ö_rcu
(
fs_öfo
,

434 
	`rcu_°r_dîef
(
devi˚
->
«me
), 
max_a˘ive_z⁄es
,

435 
BTRFS_MIN_ACTIVE_ZONES
);

436 
ªt
 = -
EINVAL
;

437 
out
;

439 
z⁄e_öfo
->
max_a˘ive_z⁄es
 = max_active_zones;

441 
z⁄e_öfo
->
£q_z⁄es
 = 
	`bôm≠_zÆloc
(z⁄e_öfo->
ƒ_z⁄es
, 
GFP_KERNEL
);

442 i‡(!
z⁄e_öfo
->
£q_z⁄es
) {

443 
ªt
 = -
ENOMEM
;

444 
out
;

447 
z⁄e_öfo
->
em±y_z⁄es
 = 
	`bôm≠_zÆloc
(z⁄e_öfo->
ƒ_z⁄es
, 
GFP_KERNEL
);

448 i‡(!
z⁄e_öfo
->
em±y_z⁄es
) {

449 
ªt
 = -
ENOMEM
;

450 
out
;

453 
z⁄e_öfo
->
a˘ive_z⁄es
 = 
	`bôm≠_zÆloc
(z⁄e_öfo->
ƒ_z⁄es
, 
GFP_KERNEL
);

454 i‡(!
z⁄e_öfo
->
a˘ive_z⁄es
) {

455 
ªt
 = -
ENOMEM
;

456 
out
;

459 
z⁄es
 = 
	`kvˇŒoc
(
BTRFS_REPORT_NR_ZONES
, (
blk_z⁄e
), 
GFP_KERNEL
);

460 i‡(!
z⁄es
) {

461 
ªt
 = -
ENOMEM
;

462 
out
;

470 i‡(
p›uœã_ˇche
 && 
	`bdev_is_z⁄ed
(
devi˚
->
bdev
)) {

471 
z⁄e_öfo
->
z⁄e_ˇche
 = 
	`vˇŒoc
(z⁄e_öfo->
ƒ_z⁄es
,

472 (
blk_z⁄e
));

473 i‡(!
z⁄e_öfo
->
z⁄e_ˇche
) {

474 
	`båfs_îr_ö_rcu
(
devi˚
->
fs_öfo
,

476 
	`rcu_°r_dîef
(
devi˚
->
«me
));

477 
ªt
 = -
ENOMEM
;

478 
out
;

483 
«˘ive
 = 0;

484 
£˘‹
 < 
ƒ_£˘‹s
) {

485 
ƒ_z⁄es
 = 
BTRFS_REPORT_NR_ZONES
;

486 
ªt
 = 
	`båfs_gë_dev_z⁄es
(
devi˚
, 
£˘‹
 << 
SECTOR_SHIFT
, 
z⁄es
,

487 &
ƒ_z⁄es
);

488 i‡(
ªt
)

489 
out
;

491 
i
 = 0; i < 
ƒ_z⁄es
; i++) {

492 i‡(
z⁄es
[
i
].
ty≥
 =
BLK_ZONE_TYPE_SEQWRITE_REQ
)

493 
	`__£t_bô
(
ƒï‹ãd
, 
z⁄e_öfo
->
£q_z⁄es
);

494 
z⁄es
[
i
].
c⁄d
) {

495 
BLK_ZONE_COND_EMPTY
:

496 
	`__£t_bô
(
ƒï‹ãd
, 
z⁄e_öfo
->
em±y_z⁄es
);

498 
BLK_ZONE_COND_IMP_OPEN
:

499 
BLK_ZONE_COND_EXP_OPEN
:

500 
BLK_ZONE_COND_CLOSED
:

501 
	`__£t_bô
(
ƒï‹ãd
, 
z⁄e_öfo
->
a˘ive_z⁄es
);

502 
«˘ive
++;

505 
ƒï‹ãd
++;

507 
£˘‹
 = 
z⁄es
[
ƒ_z⁄es
 - 1].
°¨t
 + z⁄es[ƒ_z⁄e†- 1].
Àn
;

510 i‡(
ƒï‹ãd
 !
z⁄e_öfo
->
ƒ_z⁄es
) {

511 
	`båfs_îr_ö_rcu
(
devi˚
->
fs_öfo
,

513 
	`rcu_°r_dîef
(
devi˚
->
«me
), 
ƒï‹ãd
,

514 
z⁄e_öfo
->
ƒ_z⁄es
);

515 
ªt
 = -
EIO
;

516 
out
;

519 i‡(
max_a˘ive_z⁄es
) {

520 i‡(
«˘ive
 > 
max_a˘ive_z⁄es
) {

521 
	`båfs_îr_ö_rcu
(
devi˚
->
fs_öfo
,

523 
«˘ive
, 
	`rcu_°r_dîef
(
devi˚
->
«me
),

524 
max_a˘ive_z⁄es
);

525 
ªt
 = -
EIO
;

526 
out
;

528 
	`©omic_£t
(&
z⁄e_öfo
->
a˘ive_z⁄es_À·
,

529 
max_a˘ive_z⁄es
 - 
«˘ive
);

530 
	`£t_bô
(
BTRFS_FS_ACTIVE_ZONE_TRACKING
, &
fs_öfo
->
Êags
);

534 
ƒ_z⁄es
 = 
BTRFS_NR_SB_LOG_ZONES
;

535 
i
 = 0; i < 
BTRFS_SUPER_MIRROR_MAX
; i++) {

536 
u32
 
sb_z⁄e
;

537 
u64
 
sb_wp
;

538 
sb_pos
 = 
BTRFS_NR_SB_LOG_ZONES
 * 
i
;

540 
sb_z⁄e
 = 
	`sb_z⁄e_numbî
(
z⁄e_öfo
->
z⁄e_size_shi·
, 
i
);

541 i‡(
sb_z⁄e
 + 1 >
z⁄e_öfo
->
ƒ_z⁄es
)

544 
ªt
 = 
	`båfs_gë_dev_z⁄es
(
devi˚
,

545 
	`z⁄e_°¨t_physiˇl
(
sb_z⁄e
, 
z⁄e_öfo
),

546 &
z⁄e_öfo
->
sb_z⁄es
[
sb_pos
],

547 &
ƒ_z⁄es
);

548 i‡(
ªt
)

549 
out
;

551 i‡(
ƒ_z⁄es
 !
BTRFS_NR_SB_LOG_ZONES
) {

552 
	`båfs_îr_ö_rcu
(
devi˚
->
fs_öfo
,

554 
devi˚
->
devid
, 
sb_z⁄e
);

555 
ªt
 = -
EUCLEAN
;

556 
out
;

563 i‡(
z⁄e_öfo
->
sb_z⁄es
[
BTRFS_NR_SB_LOG_ZONES
 * 
i
].
ty≥
 ==

564 
BLK_ZONE_TYPE_CONVENTIONAL
)

567 
ªt
 = 
	`sb_wrôe_poöãr
(
devi˚
->
bdev
,

568 &
z⁄e_öfo
->
sb_z⁄es
[
sb_pos
], &
sb_wp
);

569 i‡(
ªt
 !-
ENOENT
 &&Ñet) {

570 
	`båfs_îr_ö_rcu
(
devi˚
->
fs_öfo
,

572 
devi˚
->
devid
, 
sb_z⁄e
);

573 
ªt
 = -
EUCLEAN
;

574 
out
;

579 
	`kv‰ì
(
z⁄es
);

581 
	`bdev_z⁄ed_modñ
(
bdev
)) {

582 
BLK_ZONED_HM
:

583 
modñ
 = "host-managed zoned";

584 
emuœãd
 = "";

586 
BLK_ZONED_HA
:

587 
modñ
 = "host-aware zoned";

588 
emuœãd
 = "";

590 
BLK_ZONED_NONE
:

591 
modñ
 = "regular";

592 
emuœãd
 = "emulated ";

596 
	`båfs_îr_ö_rcu
(
fs_öfo
, "zoned: unsupported model %d on %s",

597 
	`bdev_z⁄ed_modñ
(
bdev
),

598 
	`rcu_°r_dîef
(
devi˚
->
«me
));

599 
ªt
 = -
EOPNOTSUPP
;

600 
out_‰ì_z⁄e_öfo
;

603 
	`båfs_öfo_ö_rcu
(
fs_öfo
,

605 
modñ
, 
	`rcu_°r_dîef
(
devi˚
->
«me
), 
z⁄e_öfo
->
ƒ_z⁄es
,

606 
emuœãd
, 
z⁄e_öfo
->
z⁄e_size
);

610 
out
:

611 
	`kv‰ì
(
z⁄es
);

612 
out_‰ì_z⁄e_öfo
:

613 
	`båfs_de°roy_dev_z⁄e_öfo
(
devi˚
);

615  
ªt
;

616 
	}
}

618 
	$båfs_de°roy_dev_z⁄e_öfo
(
båfs_devi˚
 *
devi˚
)

620 
båfs_z⁄ed_devi˚_öfo
 *
z⁄e_öfo
 = 
devi˚
->zone_info;

622 i‡(!
z⁄e_öfo
)

625 
	`bôm≠_‰ì
(
z⁄e_öfo
->
a˘ive_z⁄es
);

626 
	`bôm≠_‰ì
(
z⁄e_öfo
->
£q_z⁄es
);

627 
	`bôm≠_‰ì
(
z⁄e_öfo
->
em±y_z⁄es
);

628 
	`v‰ì
(
z⁄e_öfo
->
z⁄e_ˇche
);

629 
	`k‰ì
(
z⁄e_öfo
);

630 
devi˚
->
z⁄e_öfo
 = 
NULL
;

631 
	}
}

633 
båfs_z⁄ed_devi˚_öfo
 *
	$båfs_˛⁄e_dev_z⁄e_öfo
(
båfs_devi˚
 *
‹ig_dev
)

635 
båfs_z⁄ed_devi˚_öfo
 *
z⁄e_öfo
;

637 
z⁄e_öfo
 = 
	`kmemdup
(
‹ig_dev
->z⁄e_öfo, (*z⁄e_öfo), 
GFP_KERNEL
);

638 i‡(!
z⁄e_öfo
)

639  
NULL
;

641 
z⁄e_öfo
->
£q_z⁄es
 = 
	`bôm≠_zÆloc
(z⁄e_öfo->
ƒ_z⁄es
, 
GFP_KERNEL
);

642 i‡(!
z⁄e_öfo
->
£q_z⁄es
)

643 
out
;

645 
	`bôm≠_c›y
(
z⁄e_öfo
->
£q_z⁄es
, 
‹ig_dev
->zone_info->seq_zones,

646 
z⁄e_öfo
->
ƒ_z⁄es
);

648 
z⁄e_öfo
->
em±y_z⁄es
 = 
	`bôm≠_zÆloc
(z⁄e_öfo->
ƒ_z⁄es
, 
GFP_KERNEL
);

649 i‡(!
z⁄e_öfo
->
em±y_z⁄es
)

650 
out
;

652 
	`bôm≠_c›y
(
z⁄e_öfo
->
em±y_z⁄es
, 
‹ig_dev
->zone_info->empty_zones,

653 
z⁄e_öfo
->
ƒ_z⁄es
);

655 
z⁄e_öfo
->
a˘ive_z⁄es
 = 
	`bôm≠_zÆloc
(z⁄e_öfo->
ƒ_z⁄es
, 
GFP_KERNEL
);

656 i‡(!
z⁄e_öfo
->
a˘ive_z⁄es
)

657 
out
;

659 
	`bôm≠_c›y
(
z⁄e_öfo
->
a˘ive_z⁄es
, 
‹ig_dev
->zone_info->active_zones,

660 
z⁄e_öfo
->
ƒ_z⁄es
);

661 
z⁄e_öfo
->
z⁄e_ˇche
 = 
NULL
;

663  
z⁄e_öfo
;

665 
out
:

666 
	`bôm≠_‰ì
(
z⁄e_öfo
->
£q_z⁄es
);

667 
	`bôm≠_‰ì
(
z⁄e_öfo
->
em±y_z⁄es
);

668 
	`bôm≠_‰ì
(
z⁄e_öfo
->
a˘ive_z⁄es
);

669 
	`k‰ì
(
z⁄e_öfo
);

670  
NULL
;

671 
	}
}

673 
	$båfs_gë_dev_z⁄e
(
båfs_devi˚
 *
devi˚
, 
u64
 
pos
,

674 
blk_z⁄e
 *
z⁄e
)

676 
ƒ_z⁄es
 = 1;

677 
ªt
;

679 
ªt
 = 
	`båfs_gë_dev_z⁄es
(
devi˚
, 
pos
, 
z⁄e
, &
ƒ_z⁄es
);

680 i‡(
ªt
 !0 || !
ƒ_z⁄es
)

681  
ªt
 ?Ñë : -
EIO
;

684 
	}
}

686 
	$båfs_check_f‹_z⁄ed_devi˚
(
båfs_fs_öfo
 *
fs_öfo
)

688 
båfs_devi˚
 *
devi˚
;

690 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_öfo
->
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

691 i‡(
devi˚
->
bdev
 &&

692 
	`bdev_z⁄ed_modñ
(
devi˚
->
bdev
Ë=
BLK_ZONED_HM
) {

693 
	`båfs_îr
(
fs_öfo
,

695 
devi˚
->
bdev
);

696  -
EINVAL
;

701 
	}
}

703 
	$båfs_check_z⁄ed_mode
(
båfs_fs_öfo
 *
fs_öfo
)

705 
queue_limôs
 *
lim
 = &
fs_öfo
->
limôs
;

706 
båfs_devi˚
 *
devi˚
;

707 
u64
 
z⁄e_size
 = 0;

708 
ªt
;

714 i‡(!
	`båfs_fs_öcom∑t
(
fs_öfo
, 
ZONED
))

715  
	`båfs_check_f‹_z⁄ed_devi˚
(
fs_öfo
);

717 
	`blk_£t_°ackög_limôs
(
lim
);

719 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_öfo
->
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

720 
båfs_z⁄ed_devi˚_öfo
 *
z⁄e_öfo
 = 
devi˚
->zone_info;

722 i‡(!
devi˚
->
bdev
)

725 i‡(!
z⁄e_size
) {

726 
z⁄e_size
 = 
z⁄e_öfo
->zone_size;

727 } i‡(
z⁄e_öfo
->
z⁄e_size
 != zone_size) {

728 
	`båfs_îr
(
fs_öfo
,

730 
z⁄e_öfo
->
z⁄e_size
, zone_size);

731  -
EINVAL
;

739 i‡(
	`bdev_is_z⁄ed
(
devi˚
->
bdev
)) {

740 
	`blk_°ack_limôs
(
lim
,

741 &
	`bdev_gë_queue
(
devi˚
->
bdev
)->
limôs
,

751 i‡(!
	`IS_ALIGNED
(
z⁄e_size
, 
BTRFS_STRIPE_LEN
)) {

752 
	`båfs_îr
(
fs_öfo
,

754 
z⁄e_size
, 
BTRFS_STRIPE_LEN
);

755  -
EINVAL
;

758 i‡(
	`båfs_fs_öcom∑t
(
fs_öfo
, 
MIXED_GROUPS
)) {

759 
	`båfs_îr
(
fs_öfo
, "zoned: mixed block groupsÇot supported");

760  -
EINVAL
;

763 
fs_öfo
->
z⁄e_size
 = zone_size;

771 
fs_öfo
->
max_z⁄e_≠≥nd_size
 = 
	`ALIGN_DOWN
(

772 
	`mö3
((
u64
)
lim
->
max_z⁄e_≠≥nd_£˘‹s
 << 
SECTOR_SHIFT
,

773 (
u64
)
lim
->
max_£˘‹s
 << 
SECTOR_SHIFT
,

774 (
u64
)
lim
->
max_£gmíts
 << 
PAGE_SHIFT
),

775 
fs_öfo
->
£˘‹size
);

776 
fs_öfo
->
fs_devi˚s
->
chunk_Æloc_pﬁicy
 = 
BTRFS_CHUNK_ALLOC_ZONED
;

777 i‡(
fs_öfo
->
max_z⁄e_≠≥nd_size
 < fs_öfo->
max_exã¡_size
)

778 
fs_öfo
->
max_exã¡_size
 = fs_öfo->
max_z⁄e_≠≥nd_size
;

784 
ªt
 = 
	`båfs_check_mou¡›ts_z⁄ed
(
fs_öfo
);

785 i‡(
ªt
)

786  
ªt
;

788 
	`båfs_öfo
(
fs_öfo
, "z⁄ed modêíabÀd wôh z⁄êsizê%Œu", 
z⁄e_size
);

790 
	}
}

792 
	$båfs_check_mou¡›ts_z⁄ed
(
båfs_fs_öfo
 *
öfo
)

794 i‡(!
	`båfs_is_z⁄ed
(
öfo
))

801 i‡(
	`båfs_ã°_›t
(
öfo
, 
SPACE_CACHE
)) {

802 
	`båfs_îr
(
öfo
, "zoned: space cache v1 isÇot supported");

803  -
EINVAL
;

806 i‡(
	`båfs_ã°_›t
(
öfo
, 
NODATACOW
)) {

807 
	`båfs_îr
(
öfo
, "zoned: NODATACOWÇot supported");

808  -
EINVAL
;

811 
	`båfs_˛ór_™d_öfo
(
öfo
, 
DISCARD_ASYNC
,

815 
	}
}

817 
	$sb_log_loˇti⁄
(
block_devi˚
 *
bdev
, 
blk_z⁄e
 *
z⁄es
,

818 
rw
, 
u64
 *
byãƒ_ªt
)

820 
u64
 
wp
;

821 
ªt
;

823 i‡(
z⁄es
[0].
ty≥
 =
BLK_ZONE_TYPE_CONVENTIONAL
) {

824 *
byãƒ_ªt
 = 
z⁄es
[0].
°¨t
 << 
SECTOR_SHIFT
;

828 
ªt
 = 
	`sb_wrôe_poöãr
(
bdev
, 
z⁄es
, &
wp
);

829 i‡(
ªt
 !-
ENOENT
 &&Ñet < 0)

830  
ªt
;

832 i‡(
rw
 =
WRITE
) {

833 
blk_z⁄e
 *
ª£t
 = 
NULL
;

835 i‡(
wp
 =
z⁄es
[0].
°¨t
 << 
SECTOR_SHIFT
)

836 
ª£t
 = &
z⁄es
[0];

837 i‡(
wp
 =
z⁄es
[1].
°¨t
 << 
SECTOR_SHIFT
)

838 
ª£t
 = &
z⁄es
[1];

840 i‡(
ª£t
 &&Ñe£t->
c⁄d
 !
BLK_ZONE_COND_EMPTY
) {

841 
	`ASSERT
(
	`sb_z⁄e_is_fuŒ
(
ª£t
));

843 
ªt
 = 
	`blkdev_z⁄e_mgmt
(
bdev
, 
REQ_OP_ZONE_RESET
,

844 
ª£t
->
°¨t
,Ñe£t->
Àn
,

845 
GFP_NOFS
);

846 i‡(
ªt
)

847  
ªt
;

849 
ª£t
->
c⁄d
 = 
BLK_ZONE_COND_EMPTY
;

850 
ª£t
->
wp
 =Ñe£t->
°¨t
;

852 } i‡(
ªt
 !-
ENOENT
) {

857 
u64
 
z⁄e_íd
 = 0;

859 i‡(
wp
 =
z⁄es
[0].
°¨t
 << 
SECTOR_SHIFT
)

860 
z⁄e_íd
 = 
z⁄es
[1].
°¨t
 + z⁄es[1].
ˇ∑côy
;

861 i‡(
wp
 =
z⁄es
[1].
°¨t
 << 
SECTOR_SHIFT
)

862 
z⁄e_íd
 = 
z⁄es
[0].
°¨t
 + z⁄es[0].
ˇ∑côy
;

863 i‡(
z⁄e_íd
)

864 
wp
 = 
	`ALIGN_DOWN
(
z⁄e_íd
 << 
SECTOR_SHIFT
,

865 
BTRFS_SUPER_INFO_SIZE
);

867 
wp
 -
BTRFS_SUPER_INFO_SIZE
;

870 *
byãƒ_ªt
 = 
wp
;

873 
	}
}

875 
	$båfs_sb_log_loˇti⁄_bdev
(
block_devi˚
 *
bdev
, 
múr‹
, 
rw
,

876 
u64
 *
byãƒ_ªt
)

878 
blk_z⁄e
 
z⁄es
[
BTRFS_NR_SB_LOG_ZONES
];

879 
£˘‹_t
 
z⁄e_£˘‹s
;

880 
u32
 
sb_z⁄e
;

881 
ªt
;

882 
u8
 
z⁄e_£˘‹s_shi·
;

883 
£˘‹_t
 
ƒ_£˘‹s
;

884 
u32
 
ƒ_z⁄es
;

886 i‡(!
	`bdev_is_z⁄ed
(
bdev
)) {

887 *
byãƒ_ªt
 = 
	`båfs_sb_off£t
(
múr‹
);

891 
	`ASSERT
(
rw
 =
READ
 ||Ñw =
WRITE
);

893 
z⁄e_£˘‹s
 = 
	`bdev_z⁄e_£˘‹s
(
bdev
);

894 i‡(!
	`is_powî_of_2
(
z⁄e_£˘‹s
))

895  -
EINVAL
;

896 
z⁄e_£˘‹s_shi·
 = 
	`ûog2
(
z⁄e_£˘‹s
);

897 
ƒ_£˘‹s
 = 
	`bdev_ƒ_£˘‹s
(
bdev
);

898 
ƒ_z⁄es
 = 
ƒ_£˘‹s
 >> 
z⁄e_£˘‹s_shi·
;

900 
sb_z⁄e
 = 
	`sb_z⁄e_numbî
(
z⁄e_£˘‹s_shi·
 + 
SECTOR_SHIFT
, 
múr‹
);

901 i‡(
sb_z⁄e
 + 1 >
ƒ_z⁄es
)

902  -
ENOENT
;

904 
ªt
 = 
	`blkdev_ªp‹t_z⁄es
(
bdev
, 
	`z⁄e_°¨t_£˘‹
(
sb_z⁄e
, bdev),

905 
BTRFS_NR_SB_LOG_ZONES
, 
c›y_z⁄e_öfo_cb
,

906 
z⁄es
);

907 i‡(
ªt
 < 0)

908  
ªt
;

909 i‡(
ªt
 !
BTRFS_NR_SB_LOG_ZONES
)

910  -
EIO
;

912  
	`sb_log_loˇti⁄
(
bdev
, 
z⁄es
, 
rw
, 
byãƒ_ªt
);

913 
	}
}

915 
	$båfs_sb_log_loˇti⁄_bdev_∑πôi⁄
(
block_devi˚
 *
bdev
,

916 
múr‹
, 
rw
, 
u64
 *
byãƒ_ªt
, u64 
sb_off£t
)

918 
blk_z⁄e
 
z⁄es
[
BTRFS_NR_SB_LOG_ZONES
];

919 
£˘‹_t
 
z⁄e_£˘‹s
;

920 
u32
 
sb_z⁄e
;

921 
ªt
;

922 
u8
 
z⁄e_£˘‹s_shi·
;

923 
£˘‹_t
 
ƒ_£˘‹s
;

924 
u32
 
ƒ_z⁄es
;

926 i‡(!
	`bdev_is_z⁄ed
(
bdev
)) {

927 *
byãƒ_ªt
 = 
	`båfs_sb_off£t_∑πôi⁄
(
múr‹
, 
sb_off£t
);

931 
	`ASSERT
(
rw
 =
READ
 ||Ñw =
WRITE
);

933 
z⁄e_£˘‹s
 = 
	`bdev_z⁄e_£˘‹s
(
bdev
);

934 i‡(!
	`is_powî_of_2
(
z⁄e_£˘‹s
))

935  -
EINVAL
;

936 
z⁄e_£˘‹s_shi·
 = 
	`ûog2
(
z⁄e_£˘‹s
);

937 
ƒ_£˘‹s
 = 
	`bdev_ƒ_£˘‹s
(
bdev
);

938 
ƒ_z⁄es
 = 
ƒ_£˘‹s
 >> 
z⁄e_£˘‹s_shi·
;

940 
sb_z⁄e
 = 
	`sb_z⁄e_numbî
(
z⁄e_£˘‹s_shi·
 + 
SECTOR_SHIFT
, 
múr‹
);

941 i‡(
sb_z⁄e
 + 1 >
ƒ_z⁄es
)

942  -
ENOENT
;

944 
ªt
 = 
	`blkdev_ªp‹t_z⁄es
(
bdev
, 
	`z⁄e_°¨t_£˘‹
(
sb_z⁄e
, bdev),

945 
BTRFS_NR_SB_LOG_ZONES
, 
c›y_z⁄e_öfo_cb
,

946 
z⁄es
);

947 i‡(
ªt
 < 0)

948  
ªt
;

949 i‡(
ªt
 !
BTRFS_NR_SB_LOG_ZONES
)

950  -
EIO
;

952  
	`sb_log_loˇti⁄
(
bdev
, 
z⁄es
, 
rw
, 
byãƒ_ªt
);

953 
	}
}

955 
	$båfs_sb_log_loˇti⁄
(
båfs_devi˚
 *
devi˚
, 
múr‹
, 
rw
,

956 
u64
 *
byãƒ_ªt
)

958 
båfs_z⁄ed_devi˚_öfo
 *
zöfo
 = 
devi˚
->
z⁄e_öfo
;

959 
u32
 
z⁄e_num
;

967 i‡(!
	`bdev_is_z⁄ed
(
devi˚
->
bdev
)) {

968 *
byãƒ_ªt
 = 
	`båfs_sb_off£t
(
múr‹
);

972 
z⁄e_num
 = 
	`sb_z⁄e_numbî
(
zöfo
->
z⁄e_size_shi·
, 
múr‹
);

973 i‡(
z⁄e_num
 + 1 >
zöfo
->
ƒ_z⁄es
)

974  -
ENOENT
;

976  
	`sb_log_loˇti⁄
(
devi˚
->
bdev
,

977 &
zöfo
->
sb_z⁄es
[
BTRFS_NR_SB_LOG_ZONES
 * 
múr‹
],

978 
rw
, 
byãƒ_ªt
);

979 
	}
}

981 
	$båfs_sb_log_loˇti⁄_∑πôi⁄
(
båfs_devi˚
 *
devi˚
, 
múr‹
, 
rw
,

982 
u64
 *
byãƒ_ªt
, u64 
sb_off£t
)

984 
båfs_z⁄ed_devi˚_öfo
 *
zöfo
 = 
devi˚
->
z⁄e_öfo
;

985 
u32
 
z⁄e_num
;

993 i‡(!
	`bdev_is_z⁄ed
(
devi˚
->
bdev
)) {

994 *
byãƒ_ªt
 = 
	`båfs_sb_off£t_∑πôi⁄
(
múr‹
, 
sb_off£t
);

998 
z⁄e_num
 = 
	`sb_z⁄e_numbî
(
zöfo
->
z⁄e_size_shi·
, 
múr‹
);

999 i‡(
z⁄e_num
 + 1 >
zöfo
->
ƒ_z⁄es
)

1000  -
ENOENT
;

1002  
	`sb_log_loˇti⁄
(
devi˚
->
bdev
,

1003 &
zöfo
->
sb_z⁄es
[
BTRFS_NR_SB_LOG_ZONES
 * 
múr‹
],

1004 
rw
, 
byãƒ_ªt
);

1005 
	}
}

1007 
ölöe
 
boﬁ
 
	$is_sb_log_z⁄e
(
båfs_z⁄ed_devi˚_öfo
 *
zöfo
,

1008 
múr‹
)

1010 
u32
 
z⁄e_num
;

1012 i‡(!
zöfo
)

1013  
Ál£
;

1015 
z⁄e_num
 = 
	`sb_z⁄e_numbî
(
zöfo
->
z⁄e_size_shi·
, 
múr‹
);

1016 i‡(
z⁄e_num
 + 1 >
zöfo
->
ƒ_z⁄es
)

1017  
Ál£
;

1019 i‡(!
	`ã°_bô
(
z⁄e_num
, 
zöfo
->
£q_z⁄es
))

1020  
Ál£
;

1022  
åue
;

1023 
	}
}

1025 
	$båfs_adv™˚_sb_log
(
båfs_devi˚
 *
devi˚
, 
múr‹
)

1027 
båfs_z⁄ed_devi˚_öfo
 *
zöfo
 = 
devi˚
->
z⁄e_öfo
;

1028 
blk_z⁄e
 *
z⁄e
;

1029 
i
;

1031 i‡(!
	`is_sb_log_z⁄e
(
zöfo
, 
múr‹
))

1034 
z⁄e
 = &
zöfo
->
sb_z⁄es
[
BTRFS_NR_SB_LOG_ZONES
 * 
múr‹
];

1035 
i
 = 0; i < 
BTRFS_NR_SB_LOG_ZONES
; i++) {

1037 i‡(
z⁄e
->
c⁄d
 =
BLK_ZONE_COND_FULL
) {

1038 
z⁄e
++;

1042 i‡(
z⁄e
->
c⁄d
 =
BLK_ZONE_COND_EMPTY
)

1043 
z⁄e
->
c⁄d
 = 
BLK_ZONE_COND_IMP_OPEN
;

1045 
z⁄e
->
wp
 +
SUPER_INFO_SECTORS
;

1047 i‡(
	`sb_z⁄e_is_fuŒ
(
z⁄e
)) {

1056 i‡(
z⁄e
->
wp
 !z⁄e->
°¨t
 + z⁄e->
ˇ∑côy
) {

1057 
ªt
;

1059 
ªt
 = 
	`blkdev_z⁄e_mgmt
(
devi˚
->
bdev
,

1060 
REQ_OP_ZONE_FINISH
, 
z⁄e
->
°¨t
,

1061 
z⁄e
->
Àn
, 
GFP_NOFS
);

1062 i‡(
ªt
)

1063  
ªt
;

1066 
z⁄e
->
wp
 = z⁄e->
°¨t
 + z⁄e->
Àn
;

1067 
z⁄e
->
c⁄d
 = 
BLK_ZONE_COND_FULL
;

1073 
	`ASSERT
(0);

1074  -
EIO
;

1075 
	}
}

1077 
	$båfs_ª£t_sb_log_z⁄es
(
block_devi˚
 *
bdev
, 
múr‹
)

1079 
£˘‹_t
 
z⁄e_£˘‹s
;

1080 
£˘‹_t
 
ƒ_£˘‹s
;

1081 
u8
 
z⁄e_£˘‹s_shi·
;

1082 
u32
 
sb_z⁄e
;

1083 
u32
 
ƒ_z⁄es
;

1085 
z⁄e_£˘‹s
 = 
	`bdev_z⁄e_£˘‹s
(
bdev
);

1086 
z⁄e_£˘‹s_shi·
 = 
	`ûog2
(
z⁄e_£˘‹s
);

1087 
ƒ_£˘‹s
 = 
	`bdev_ƒ_£˘‹s
(
bdev
);

1088 
ƒ_z⁄es
 = 
ƒ_£˘‹s
 >> 
z⁄e_£˘‹s_shi·
;

1090 
sb_z⁄e
 = 
	`sb_z⁄e_numbî
(
z⁄e_£˘‹s_shi·
 + 
SECTOR_SHIFT
, 
múr‹
);

1091 i‡(
sb_z⁄e
 + 1 >
ƒ_z⁄es
)

1092  -
ENOENT
;

1094  
	`blkdev_z⁄e_mgmt
(
bdev
, 
REQ_OP_ZONE_RESET
,

1095 
	`z⁄e_°¨t_£˘‹
(
sb_z⁄e
, 
bdev
),

1096 
z⁄e_£˘‹s
 * 
BTRFS_NR_SB_LOG_ZONES
, 
GFP_NOFS
);

1097 
	}
}

1110 
u64
 
	$båfs_föd_ÆloˇèbÀ_z⁄es
(
båfs_devi˚
 *
devi˚
, 
u64
 
hﬁe_°¨t
,

1111 
u64
 
hﬁe_íd
, u64 
num_byãs
)

1113 
båfs_z⁄ed_devi˚_öfo
 *
zöfo
 = 
devi˚
->
z⁄e_öfo
;

1114 c⁄° 
u8
 
shi·
 = 
zöfo
->
z⁄e_size_shi·
;

1115 
u64
 
nz⁄es
 = 
num_byãs
 >> 
shi·
;

1116 
u64
 
pos
 = 
hﬁe_°¨t
;

1117 
u64
 
begö
, 
íd
;

1118 
boﬁ
 
have_sb
;

1119 
i
;

1121 
	`ASSERT
(
	`IS_ALIGNED
(
hﬁe_°¨t
, 
zöfo
->
z⁄e_size
));

1122 
	`ASSERT
(
	`IS_ALIGNED
(
num_byãs
, 
zöfo
->
z⁄e_size
));

1124 
pos
 < 
hﬁe_íd
) {

1125 
begö
 = 
pos
 >> 
shi·
;

1126 
íd
 = 
begö
 + 
nz⁄es
;

1128 i‡(
íd
 > 
zöfo
->
ƒ_z⁄es
)

1129  
hﬁe_íd
;

1132 i‡(
	`båfs_dev_is_£quítül
(
devi˚
, 
pos
) &&

1133 !
	`bôm≠_ã°_ønge_Æl_£t
(
zöfo
->
em±y_z⁄es
, 
begö
, 
nz⁄es
)) {

1134 
pos
 +
zöfo
->
z⁄e_size
;

1138 
have_sb
 = 
Ál£
;

1139 
i
 = 0; i < 
BTRFS_SUPER_MIRROR_MAX
; i++) {

1140 
u32
 
sb_z⁄e
;

1141 
u64
 
sb_pos
;

1143 
sb_z⁄e
 = 
	`sb_z⁄e_numbî
(
shi·
, 
i
);

1144 i‡(!(
íd
 <
sb_z⁄e
 ||

1145 
sb_z⁄e
 + 
BTRFS_NR_SB_LOG_ZONES
 <
begö
)) {

1146 
have_sb
 = 
åue
;

1147 
pos
 = 
	`z⁄e_°¨t_physiˇl
(

1148 
sb_z⁄e
 + 
BTRFS_NR_SB_LOG_ZONES
, 
zöfo
);

1153 
sb_pos
 = 
	`båfs_sb_off£t
(
i
);

1154 i‡(!(
pos
 + 
num_byãs
 <
sb_pos
 ||

1155 
sb_pos
 + 
BTRFS_SUPER_INFO_SIZE
 <
pos
)) {

1156 
have_sb
 = 
åue
;

1157 
pos
 = 
	`ALIGN
(
sb_pos
 + 
BTRFS_SUPER_INFO_SIZE
,

1158 
zöfo
->
z⁄e_size
);

1162 i‡(!
have_sb
)

1166  
pos
;

1167 
	}
}

1169 
boﬁ
 
	$båfs_dev_£t_a˘ive_z⁄e
(
båfs_devi˚
 *
devi˚
, 
u64
 
pos
)

1171 
båfs_z⁄ed_devi˚_öfo
 *
z⁄e_öfo
 = 
devi˚
->zone_info;

1172 
zno
 = (
pos
 >> 
z⁄e_öfo
->
z⁄e_size_shi·
);

1175 i‡(
z⁄e_öfo
->
max_a˘ive_z⁄es
 == 0)

1176  
åue
;

1178 i‡(!
	`ã°_bô
(
zno
, 
z⁄e_öfo
->
a˘ive_z⁄es
)) {

1180 i‡(
	`©omic_dec_if_posôive
(&
z⁄e_öfo
->
a˘ive_z⁄es_À·
) < 0)

1181  
Ál£
;

1182 i‡(
	`ã°_™d_£t_bô
(
zno
, 
z⁄e_öfo
->
a˘ive_z⁄es
)) {

1184 
	`©omic_öc
(&
z⁄e_öfo
->
a˘ive_z⁄es_À·
);

1188  
åue
;

1189 
	}
}

1191 
	$båfs_dev_˛ór_a˘ive_z⁄e
(
båfs_devi˚
 *
devi˚
, 
u64
 
pos
)

1193 
båfs_z⁄ed_devi˚_öfo
 *
z⁄e_öfo
 = 
devi˚
->zone_info;

1194 
zno
 = (
pos
 >> 
z⁄e_öfo
->
z⁄e_size_shi·
);

1197 i‡(
z⁄e_öfo
->
max_a˘ive_z⁄es
 == 0)

1200 i‡(
	`ã°_™d_˛ór_bô
(
zno
, 
z⁄e_öfo
->
a˘ive_z⁄es
))

1201 
	`©omic_öc
(&
z⁄e_öfo
->
a˘ive_z⁄es_À·
);

1202 
	}
}

1204 
	$båfs_ª£t_devi˚_z⁄e
(
båfs_devi˚
 *
devi˚
, 
u64
 
physiˇl
,

1205 
u64
 
Àngth
, u64 *
byãs
)

1207 
ªt
;

1209 *
byãs
 = 0;

1210 
ªt
 = 
	`blkdev_z⁄e_mgmt
(
devi˚
->
bdev
, 
REQ_OP_ZONE_RESET
,

1211 
physiˇl
 >> 
SECTOR_SHIFT
, 
Àngth
 >> SECTOR_SHIFT,

1212 
GFP_NOFS
);

1213 i‡(
ªt
)

1214  
ªt
;

1216 *
byãs
 = 
Àngth
;

1217 
Àngth
) {

1218 
	`båfs_dev_£t_z⁄e_em±y
(
devi˚
, 
physiˇl
);

1219 
	`båfs_dev_˛ór_a˘ive_z⁄e
(
devi˚
, 
physiˇl
);

1220 
physiˇl
 +
devi˚
->
z⁄e_öfo
->
z⁄e_size
;

1221 
Àngth
 -
devi˚
->
z⁄e_öfo
->
z⁄e_size
;

1225 
	}
}

1227 
	$båfs_ísuª_em±y_z⁄es
(
båfs_devi˚
 *
devi˚
, 
u64
 
°¨t
, u64 
size
)

1229 
båfs_z⁄ed_devi˚_öfo
 *
zöfo
 = 
devi˚
->
z⁄e_öfo
;

1230 c⁄° 
u8
 
shi·
 = 
zöfo
->
z⁄e_size_shi·
;

1231 
begö
 = 
°¨t
 >> 
shi·
;

1232 
nbôs
 = 
size
 >> 
shi·
;

1233 
u64
 
pos
;

1234 
ªt
;

1236 
	`ASSERT
(
	`IS_ALIGNED
(
°¨t
, 
zöfo
->
z⁄e_size
));

1237 
	`ASSERT
(
	`IS_ALIGNED
(
size
, 
zöfo
->
z⁄e_size
));

1239 i‡(
begö
 + 
nbôs
 > 
zöfo
->
ƒ_z⁄es
)

1240  -
ERANGE
;

1243 i‡(
	`bôm≠_ã°_ønge_Æl_zîo
(
zöfo
->
£q_z⁄es
, 
begö
, 
nbôs
))

1247 i‡(
	`bôm≠_ã°_ønge_Æl_£t
(
zöfo
->
£q_z⁄es
, 
begö
, 
nbôs
) &&

1248 
	`bôm≠_ã°_ønge_Æl_£t
(
zöfo
->
em±y_z⁄es
, 
begö
, 
nbôs
))

1251 
pos
 = 
°¨t
;Öo†< sèπ + 
size
;Öo†+
zöfo
->
z⁄e_size
) {

1252 
u64
 
ª£t_byãs
;

1254 i‡(!
	`båfs_dev_is_£quítül
(
devi˚
, 
pos
) ||

1255 
	`båfs_dev_is_em±y_z⁄e
(
devi˚
, 
pos
))

1259 
	`båfs_w¨n_ö_rcu
(

1260 
devi˚
->
fs_öfo
,

1262 
	`rcu_°r_dîef
(
devi˚
->
«me
), devi˚->
devid
, 
pos
 >> 
shi·
);

1263 
	`WARN_ON_ONCE
(1);

1265 
ªt
 = 
	`båfs_ª£t_devi˚_z⁄e
(
devi˚
, 
pos
, 
zöfo
->
z⁄e_size
,

1266 &
ª£t_byãs
);

1267 i‡(
ªt
)

1268  
ªt
;

1272 
	}
}

1280 
	$ˇlcuœã_Æloc_poöãr
(
båfs_block_group
 *
ˇche
,

1281 
u64
 *
off£t_ªt
, 
boﬁ
 
√w
)

1283 
båfs_fs_öfo
 *
fs_öfo
 = 
ˇche
->fs_info;

1284 
båfs_roŸ
 *
roŸ
;

1285 
båfs_∑th
 *
∑th
;

1286 
båfs_key
 
key
;

1287 
båfs_key
 
found_key
;

1288 
ªt
;

1289 
u64
 
Àngth
;

1301 i‡(
√w
) {

1302 *
off£t_ªt
 = 0;

1306 
∑th
 = 
	`båfs_Æloc_∑th
();

1307 i‡(!
∑th
)

1308  -
ENOMEM
;

1310 
key
.
obje˘id
 = 
ˇche
->
°¨t
 + cache->
Àngth
;

1311 
key
.
ty≥
 = 0;

1312 
key
.
off£t
 = 0;

1314 
roŸ
 = 
	`båfs_exã¡_roŸ
(
fs_öfo
, 
key
.
obje˘id
);

1315 
ªt
 = 
	`båfs_£¨ch_¶Ÿ
(
NULL
, 
roŸ
, &
key
, 
∑th
, 0, 0);

1317 i‡(!
ªt
)

1318 
ªt
 = -
EUCLEAN
;

1319 i‡(
ªt
 < 0)

1320 
out
;

1322 
ªt
 = 
	`båfs_¥evious_exã¡_ôem
(
roŸ
, 
∑th
, 
ˇche
->
°¨t
);

1323 i‡(
ªt
) {

1324 i‡(
ªt
 == 1) {

1325 
ªt
 = 0;

1326 *
off£t_ªt
 = 0;

1328 
out
;

1331 
	`båfs_ôem_key_to_˝u
(
∑th
->
nodes
[0], &
found_key
,Ö©h->
¶Ÿs
[0]);

1333 i‡(
found_key
.
ty≥
 =
BTRFS_EXTENT_ITEM_KEY
)

1334 
Àngth
 = 
found_key
.
off£t
;

1336 
Àngth
 = 
fs_öfo
->
nodesize
;

1338 i‡(!(
found_key
.
obje˘id
 >
ˇche
->
°¨t
 &&

1339 
found_key
.
obje˘id
 + 
Àngth
 <
ˇche
->
°¨t
 + cache->length)) {

1340 
ªt
 = -
EUCLEAN
;

1341 
out
;

1343 *
off£t_ªt
 = 
found_key
.
obje˘id
 + 
Àngth
 - 
ˇche
->
°¨t
;

1344 
ªt
 = 0;

1346 
out
:

1347 
	`båfs_‰ì_∑th
(
∑th
);

1348  
ªt
;

1349 
	}
}

1351 
	$båfs_lﬂd_block_group_z⁄e_öfo
(
båfs_block_group
 *
ˇche
, 
boﬁ
 
√w
)

1353 
båfs_fs_öfo
 *
fs_öfo
 = 
ˇche
->fs_info;

1354 
exã¡_m≠_åì
 *
em_åì
 = &
fs_öfo
->
m≠pög_åì
;

1355 
exã¡_m≠
 *
em
;

1356 
m≠_lookup
 *
m≠
;

1357 
båfs_devi˚
 *
devi˚
;

1358 
u64
 
logiˇl
 = 
ˇche
->
°¨t
;

1359 
u64
 
Àngth
 = 
ˇche
->length;

1360 
ªt
;

1361 
i
;

1362 
nofs_Êag
;

1363 
u64
 *
Æloc_off£ts
 = 
NULL
;

1364 
u64
 *
ˇps
 = 
NULL
;

1365 
u64
 *
physiˇl
 = 
NULL
;

1366 *
a˘ive
 = 
NULL
;

1367 
u64
 
œ°_Æloc
 = 0;

1368 
u32
 
num_£quítül
 = 0, 
num_c⁄víti⁄Æ
 = 0;

1370 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

1374 i‡(!
	`IS_ALIGNED
(
Àngth
, 
fs_öfo
->
z⁄e_size
)) {

1375 
	`båfs_îr
(
fs_öfo
,

1377 
logiˇl
, 
Àngth
, 
fs_öfo
->
z⁄e_size
);

1378  -
EIO
;

1382 
	`ªad_lock
(&
em_åì
->
lock
);

1383 
em
 = 
	`lookup_exã¡_m≠pög
(
em_åì
, 
logiˇl
, 
Àngth
);

1384 
	`ªad_u∆ock
(&
em_åì
->
lock
);

1386 i‡(!
em
)

1387  -
EINVAL
;

1389 
m≠
 = 
em
->
m≠_lookup
;

1391 
ˇche
->
physiˇl_m≠
 = 
	`kmemdup
(
m≠
, 
	`m≠_lookup_size
(m≠->
num_°rùes
), 
GFP_NOFS
);

1392 i‡(!
ˇche
->
physiˇl_m≠
) {

1393 
ªt
 = -
ENOMEM
;

1394 
out
;

1397 
Æloc_off£ts
 = 
	`kˇŒoc
(
m≠
->
num_°rùes
, (*Æloc_off£ts), 
GFP_NOFS
);

1398 i‡(!
Æloc_off£ts
) {

1399 
ªt
 = -
ENOMEM
;

1400 
out
;

1403 
ˇps
 = 
	`kˇŒoc
(
m≠
->
num_°rùes
, (*ˇps), 
GFP_NOFS
);

1404 i‡(!
ˇps
) {

1405 
ªt
 = -
ENOMEM
;

1406 
out
;

1409 
physiˇl
 = 
	`kˇŒoc
(
m≠
->
num_°rùes
, (*physiˇl), 
GFP_NOFS
);

1410 i‡(!
physiˇl
) {

1411 
ªt
 = -
ENOMEM
;

1412 
out
;

1415 
a˘ive
 = 
	`bôm≠_zÆloc
(
m≠
->
num_°rùes
, 
GFP_NOFS
);

1416 i‡(!
a˘ive
) {

1417 
ªt
 = -
ENOMEM
;

1418 
out
;

1421 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

1422 
boﬁ
 
is_£quítül
;

1423 
blk_z⁄e
 
z⁄e
;

1424 
båfs_dev_ª∂a˚
 *
dev_ª∂a˚
 = &
fs_öfo
->dev_replace;

1425 
dev_ª∂a˚_is_⁄goög
 = 0;

1427 
devi˚
 = 
m≠
->
°rùes
[
i
].
dev
;

1428 
physiˇl
[
i
] = 
m≠
->
°rùes
[i].physical;

1430 i‡(
devi˚
->
bdev
 =
NULL
) {

1431 
Æloc_off£ts
[
i
] = 
WP_MISSING_DEV
;

1435 
is_£quítül
 = 
	`båfs_dev_is_£quítül
(
devi˚
, 
physiˇl
[
i
]);

1436 i‡(
is_£quítül
)

1437 
num_£quítül
++;

1439 
num_c⁄víti⁄Æ
++;

1445 i‡(!
devi˚
->
z⁄e_öfo
->
max_a˘ive_z⁄es
)

1446 
	`__£t_bô
(
i
, 
a˘ive
);

1448 i‡(!
is_£quítül
) {

1449 
Æloc_off£ts
[
i
] = 
WP_CONVENTIONAL
;

1457 
	`båfs_dev_˛ór_z⁄e_em±y
(
devi˚
, 
physiˇl
[
i
]);

1459 
	`down_ªad
(&
dev_ª∂a˚
->
rw£m
);

1460 
dev_ª∂a˚_is_⁄goög
 = 
	`båfs_dev_ª∂a˚_is_⁄goög
(
dev_ª∂a˚
);

1461 i‡(
dev_ª∂a˚_is_⁄goög
 && 
dev_ª∂a˚
->
tgtdev
 !
NULL
)

1462 
	`båfs_dev_˛ór_z⁄e_em±y
(
dev_ª∂a˚
->
tgtdev
, 
physiˇl
[
i
]);

1463 
	`up_ªad
(&
dev_ª∂a˚
->
rw£m
);

1469 
	`WARN_ON
(!
	`IS_ALIGNED
(
physiˇl
[
i
], 
fs_öfo
->
z⁄e_size
));

1470 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

1471 
ªt
 = 
	`båfs_gë_dev_z⁄e
(
devi˚
, 
physiˇl
[
i
], &
z⁄e
);

1472 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

1473 i‡(
ªt
 =-
EIO
 ||Ñë =-
EOPNOTSUPP
) {

1474 
ªt
 = 0;

1475 
Æloc_off£ts
[
i
] = 
WP_MISSING_DEV
;

1477 } i‡(
ªt
) {

1478 
out
;

1481 i‡(
z⁄e
.
ty≥
 =
BLK_ZONE_TYPE_CONVENTIONAL
) {

1482 
	`båfs_îr_ö_rcu
(
fs_öfo
,

1484 
z⁄e
.
°¨t
 << 
SECTOR_SHIFT
,

1485 
	`rcu_°r_dîef
(
devi˚
->
«me
), devi˚->
devid
);

1486 
ªt
 = -
EIO
;

1487 
out
;

1490 
ˇps
[
i
] = (
z⁄e
.
ˇ∑côy
 << 
SECTOR_SHIFT
);

1492 
z⁄e
.
c⁄d
) {

1493 
BLK_ZONE_COND_OFFLINE
:

1494 
BLK_ZONE_COND_READONLY
:

1495 
	`båfs_îr
(
fs_öfo
,

1497 
physiˇl
[
i
] >> 
devi˚
->
z⁄e_öfo
->
z⁄e_size_shi·
,

1498 
	`rcu_°r_dîef
(
devi˚
->
«me
), devi˚->
devid
);

1499 
Æloc_off£ts
[
i
] = 
WP_MISSING_DEV
;

1501 
BLK_ZONE_COND_EMPTY
:

1502 
Æloc_off£ts
[
i
] = 0;

1504 
BLK_ZONE_COND_FULL
:

1505 
Æloc_off£ts
[
i
] = 
ˇps
[i];

1509 
Æloc_off£ts
[
i
] =

1510 ((
z⁄e
.
wp
 - z⁄e.
°¨t
Ë<< 
SECTOR_SHIFT
);

1511 
	`__£t_bô
(
i
, 
a˘ive
);

1516 i‡(
num_£quítül
 > 0)

1517 
	`£t_bô
(
BLOCK_GROUP_FLAG_SEQUENTIAL_ZONE
, &
ˇche
->
ru¡ime_Êags
);

1519 i‡(
num_c⁄víti⁄Æ
 > 0) {

1521 
ˇche
->
z⁄e_ˇ∑côy
 = cache->
Àngth
;

1522 
ªt
 = 
	`ˇlcuœã_Æloc_poöãr
(
ˇche
, &
œ°_Æloc
, 
√w
);

1523 i‡(
ªt
) {

1524 
	`båfs_îr
(
fs_öfo
,

1526 
ˇche
->
°¨t
);

1527 
out
;

1528 } i‡(
m≠
->
num_°rùes
 =
num_c⁄víti⁄Æ
) {

1529 
ˇche
->
Æloc_off£t
 = 
œ°_Æloc
;

1530 
	`£t_bô
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
, &
ˇche
->
ru¡ime_Êags
);

1531 
out
;

1535 
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) {

1537 i‡(
Æloc_off£ts
[0] =
WP_MISSING_DEV
) {

1538 
	`båfs_îr
(
fs_öfo
,

1540 
physiˇl
[0]);

1541 
ªt
 = -
EIO
;

1542 
out
;

1544 
ˇche
->
Æloc_off£t
 = 
Æloc_off£ts
[0];

1545 
ˇche
->
z⁄e_ˇ∑côy
 = 
ˇps
[0];

1546 i‡(
	`ã°_bô
(0, 
a˘ive
))

1547 
	`£t_bô
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
, &
ˇche
->
ru¡ime_Êags
);

1549 
BTRFS_BLOCK_GROUP_DUP
:

1550 i‡(
m≠
->
ty≥
 & 
BTRFS_BLOCK_GROUP_DATA
) {

1551 
	`båfs_îr
(
fs_öfo
, "zoned:Örofile DUPÇot yet supported on data bg");

1552 
ªt
 = -
EINVAL
;

1553 
out
;

1555 i‡(
Æloc_off£ts
[0] =
WP_MISSING_DEV
) {

1556 
	`båfs_îr
(
fs_öfo
,

1558 
physiˇl
[0]);

1559 
ªt
 = -
EIO
;

1560 
out
;

1562 i‡(
Æloc_off£ts
[1] =
WP_MISSING_DEV
) {

1563 
	`båfs_îr
(
fs_öfo
,

1565 
physiˇl
[1]);

1566 
ªt
 = -
EIO
;

1567 
out
;

1569 i‡(
Æloc_off£ts
[0] !=álloc_offsets[1]) {

1570 
	`båfs_îr
(
fs_öfo
,

1572 
ªt
 = -
EIO
;

1573 
out
;

1575 i‡(
	`ã°_bô
(0, 
a˘ive
) !=Åest_bit(1,áctive)) {

1576 i‡(!
	`båfs_z⁄e_a˘iv©e
(
ˇche
)) {

1577 
ªt
 = -
EIO
;

1578 
out
;

1581 i‡(
	`ã°_bô
(0, 
a˘ive
))

1582 
	`£t_bô
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
,

1583 &
ˇche
->
ru¡ime_Êags
);

1585 
ˇche
->
Æloc_off£t
 = 
Æloc_off£ts
[0];

1586 
ˇche
->
z⁄e_ˇ∑côy
 = 
	`mö
(
ˇps
[0], caps[1]);

1588 
BTRFS_BLOCK_GROUP_RAID1
:

1589 
BTRFS_BLOCK_GROUP_RAID0
:

1590 
BTRFS_BLOCK_GROUP_RAID10
:

1591 
BTRFS_BLOCK_GROUP_RAID5
:

1592 
BTRFS_BLOCK_GROUP_RAID6
:

1595 
	`båfs_îr
(
fs_öfo
, "zoned:Örofile %sÇot yet supported",

1596 
	`båfs_bg_ty≥_to_øid_«me
(
m≠
->
ty≥
));

1597 
ªt
 = -
EINVAL
;

1598 
out
;

1601 
out
:

1602 i‡(
ˇche
->
Æloc_off£t
 > 
fs_öfo
->
z⁄e_size
) {

1603 
	`båfs_îr
(
fs_öfo
,

1605 
ˇche
->
Æloc_off£t
, cache->
°¨t
);

1606 
ªt
 = -
EIO
;

1609 i‡(
ˇche
->
Æloc_off£t
 > cache->
z⁄e_ˇ∑côy
) {

1610 
	`båfs_îr
(
fs_öfo
,

1612 
ˇche
->
Æloc_off£t
, cache->
z⁄e_ˇ∑côy
,

1613 
ˇche
->
°¨t
);

1614 
ªt
 = -
EIO
;

1618 i‡(!
ªt
 && 
num_c⁄víti⁄Æ
 && 
œ°_Æloc
 > 
ˇche
->
Æloc_off£t
) {

1619 
	`båfs_îr
(
fs_öfo
,

1621 
logiˇl
, 
œ°_Æloc
, 
ˇche
->
Æloc_off£t
);

1622 
ªt
 = -
EIO
;

1625 i‡(!
ªt
) {

1626 
ˇche
->
mëa_wrôe_poöãr
 = cache->
Æloc_off£t
 + cache->
°¨t
;

1627 i‡(
	`ã°_bô
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
, &
ˇche
->
ru¡ime_Êags
)) {

1628 
	`båfs_gë_block_group
(
ˇche
);

1629 
	`•ö_lock
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

1630 
	`li°_add_èû
(&
ˇche
->
a˘ive_bg_li°
,

1631 &
fs_öfo
->
z⁄e_a˘ive_bgs
);

1632 
	`•ö_u∆ock
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

1635 
	`k‰ì
(
ˇche
->
physiˇl_m≠
);

1636 
ˇche
->
physiˇl_m≠
 = 
NULL
;

1638 
	`bôm≠_‰ì
(
a˘ive
);

1639 
	`k‰ì
(
physiˇl
);

1640 
	`k‰ì
(
ˇps
);

1641 
	`k‰ì
(
Æloc_off£ts
);

1642 
	`‰ì_exã¡_m≠
(
em
);

1644  
ªt
;

1645 
	}
}

1647 
	$båfs_ˇlc_z⁄e_unußbÀ
(
båfs_block_group
 *
ˇche
)

1649 
u64
 
unußbÀ
, 
‰ì
;

1651 i‡(!
	`båfs_is_z⁄ed
(
ˇche
->
fs_öfo
))

1654 
	`WARN_ON
(
ˇche
->
byãs_su≥r
 != 0);

1655 
unußbÀ
 = (
ˇche
->
Æloc_off£t
 - cache->
u£d
) +

1656 (
ˇche
->
Àngth
 - cache->
z⁄e_ˇ∑côy
);

1657 
‰ì
 = 
ˇche
->
z⁄e_ˇ∑côy
 - cache->
Æloc_off£t
;

1660 
ˇche
->
ˇched
 = 
BTRFS_CACHE_FINISHED
;

1661 
ˇche
->
‰ì_•a˚_˘l
->
‰ì_•a˚
 = 
‰ì
;

1662 
ˇche
->
z⁄e_unußbÀ
 = 
unußbÀ
;

1663 
	}
}

1665 
	$båfs_ªdúty_li°_add
(
båfs_å™ß˘i⁄
 *
å™s
,

1666 
exã¡_buf„r
 *
eb
)

1668 i‡(!
	`båfs_is_z⁄ed
(
eb
->
fs_öfo
) ||

1669 
	`båfs_hódî_Êag
(
eb
, 
BTRFS_HEADER_FLAG_WRITTEN
))

1672 
	`ASSERT
(!
	`ã°_bô
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bÊags
));

1674 
	`memzîo_exã¡_buf„r
(
eb
, 0,Éb->
Àn
);

1675 
	`£t_bô
(
EXTENT_BUFFER_NO_CHECK
, &
eb
->
bÊags
);

1676 
	`£t_exã¡_buf„r_dúty
(
eb
);

1677 
	`£t_exã¡_bô
(&
å™s
->
dúty_∑ges
, 
eb
->
°¨t
,Éb->°¨à+Éb->
Àn
 - 1,

1678 
EXTENT_DIRTY
 | 
EXTENT_NOWAIT
, 
NULL
);

1679 
	}
}

1681 
boﬁ
 
	$båfs_u£_z⁄e_≠≥nd
(
båfs_bio
 *
bbio
)

1683 
u64
 
°¨t
 = (
bbio
->
bio
.
bi_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
);

1684 
båfs_öode
 *
öode
 = 
bbio
->inode;

1685 
båfs_fs_öfo
 *
fs_öfo
 = 
bbio
->fs_info;

1686 
båfs_block_group
 *
ˇche
;

1687 
boﬁ
 
ªt
 = 
Ál£
;

1689 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

1690  
Ál£
;

1692 i‡(!
öode
 || !
	`is_d©a_öode
(&öode->
vfs_öode
))

1693  
Ál£
;

1695 i‡(
	`båfs_›
(&
bbio
->
bio
Ë!
BTRFS_MAP_WRITE
)

1696  
Ál£
;

1706 i‡(
	`båfs_is_d©a_ªloc_roŸ
(
öode
->
roŸ
))

1707  
Ál£
;

1709 
ˇche
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
°¨t
);

1710 
	`ASSERT
(
ˇche
);

1711 i‡(!
ˇche
)

1712  
Ál£
;

1714 
ªt
 = !!
	`ã°_bô
(
BLOCK_GROUP_FLAG_SEQUENTIAL_ZONE
, &
ˇche
->
ru¡ime_Êags
);

1715 
	`båfs_put_block_group
(
ˇche
);

1717  
ªt
;

1718 
	}
}

1720 
	$båfs_ªc‹d_physiˇl_z⁄ed
(
båfs_bio
 *
bbio
)

1722 c⁄° 
u64
 
physiˇl
 = 
bbio
->
bio
.
bi_ôî
.
bi_£˘‹
 << 
SECTOR_SHIFT
;

1723 
båfs_‹dîed_sum
 *
sum
 = 
bbio
->
sums
;

1725 i‡(
physiˇl
 < 
bbio
->
‹ig_physiˇl
)

1726 
sum
->
logiˇl
 -
bbio
->
‹ig_physiˇl
 - 
physiˇl
;

1728 
sum
->
logiˇl
 +
physiˇl
 - 
bbio
->
‹ig_physiˇl
;

1729 
	}
}

1731 
	$båfs_ªwrôe_logiˇl_z⁄ed
(
båfs_‹dîed_exã¡
 *
‹dîed
,

1732 
u64
 
logiˇl
)

1734 
exã¡_m≠_åì
 *
em_åì
 = &
	`BTRFS_I
(
‹dîed
->
öode
)->
exã¡_åì
;

1735 
exã¡_m≠
 *
em
;

1737 
‹dîed
->
disk_byãƒ
 = 
logiˇl
;

1739 
	`wrôe_lock
(&
em_åì
->
lock
);

1740 
em
 = 
	`£¨ch_exã¡_m≠pög
(
em_åì
, 
‹dîed
->
fûe_off£t
,

1741 
‹dîed
->
num_byãs
);

1742 
em
->
block_°¨t
 = 
logiˇl
;

1743 
	`‰ì_exã¡_m≠
(
em
);

1744 
	`wrôe_u∆ock
(&
em_åì
->
lock
);

1745 
	}
}

1747 
boﬁ
 
	$båfs_z⁄ed_•lô_‹dîed
(
båfs_‹dîed_exã¡
 *
‹dîed
,

1748 
u64
 
logiˇl
, u64 
Àn
)

1750 
båfs_‹dîed_exã¡
 *
√w
;

1752 i‡(!
	`ã°_bô
(
BTRFS_ORDERED_NOCOW
, &
‹dîed
->
Êags
) &&

1753 
	`•lô_exã¡_m≠
(
	`BTRFS_I
(
‹dîed
->
öode
), ordîed->
fûe_off£t
,

1754 
‹dîed
->
num_byãs
, 
Àn
, 
logiˇl
))

1755  
Ál£
;

1757 
√w
 = 
	`båfs_•lô_‹dîed_exã¡
(
‹dîed
, 
Àn
);

1758 i‡(
	`IS_ERR
(
√w
))

1759  
Ál£
;

1760 
√w
->
disk_byãƒ
 = 
logiˇl
;

1761 
	`båfs_föish_⁄e_‹dîed
(
√w
);

1762  
åue
;

1763 
	}
}

1765 
	$båfs_föish_‹dîed_z⁄ed
(
båfs_‹dîed_exã¡
 *
‹dîed
)

1767 
båfs_öode
 *
öode
 = 
	`BTRFS_I
(
‹dîed
->inode);

1768 
båfs_fs_öfo
 *
fs_öfo
 = 
öode
->
roŸ
->fs_info;

1769 
båfs_‹dîed_sum
 *
sum
;

1770 
u64
 
logiˇl
, 
Àn
;

1776 i‡(
	`ã°_bô
(
BTRFS_ORDERED_PREALLOC
, &
‹dîed
->
Êags
))

1779 
	`ASSERT
(!
	`li°_em±y
(&
‹dîed
->
li°
));

1781 
sum
 = 
	`li°_fú°_íåy
(&
‹dîed
->
li°
, 
båfs_‹dîed_sum
,Üist);

1782 
logiˇl
 = 
sum
->logical;

1783 
Àn
 = 
sum
->len;

1785 
Àn
 < 
‹dîed
->
disk_num_byãs
) {

1786 
sum
 = 
	`li°_√xt_íåy
(sum, 
li°
);

1787 i‡(
sum
->
logiˇl
 =logiˇ»+ 
Àn
) {

1788 
Àn
 +
sum
->len;

1791 i‡(!
	`båfs_z⁄ed_•lô_‹dîed
(
‹dîed
, 
logiˇl
, 
Àn
)) {

1792 
	`£t_bô
(
BTRFS_ORDERED_IOERR
, &
‹dîed
->
Êags
);

1793 
	`båfs_îr
(
fs_öfo
, "failedÅo split orderedÉxtent");

1794 
out
;

1796 
logiˇl
 = 
sum
->logical;

1797 
Àn
 = 
sum
->len;

1800 i‡(
‹dîed
->
disk_byãƒ
 !
logiˇl
)

1801 
	`båfs_ªwrôe_logiˇl_z⁄ed
(
‹dîed
, 
logiˇl
);

1803 
out
:

1810 i‡((
öode
->
Êags
 & 
BTRFS_INODE_NODATASUM
) ||

1811 
	`ã°_bô
(
BTRFS_FS_STATE_NO_CSUMS
, &
fs_öfo
->
fs_°©e
)) {

1812 (
sum
 = 
	`li°_fú°_íåy_‹_nuŒ
(&
‹dîed
->
li°
,

1813 
	`ty≥of
(*
sum
), 
li°
))) {

1814 
	`li°_dñ
(&
sum
->
li°
);

1815 
	`k‰ì
(
sum
);

1818 
	}
}

1820 
boﬁ
 
	$check_bg_is_a˘ive
(
båfs_eb_wrôe_c⁄ãxt
 *
˘x
,

1821 
båfs_block_group
 **
a˘ive_bg
)

1823 c⁄° 
wrôeback_c⁄åﬁ
 *
wbc
 = 
˘x
->wbc;

1824 
båfs_block_group
 *
block_group
 = 
˘x
->
z⁄ed_bg
;

1825 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

1827 i‡(
	`ã°_bô
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
, &
block_group
->
ru¡ime_Êags
))

1828  
åue
;

1830 i‡(
fs_öfo
->
åìlog_bg
 =
block_group
->
°¨t
) {

1831 i‡(!
	`båfs_z⁄e_a˘iv©e
(
block_group
)) {

1832 
ªt_fö
 = 
	`båfs_z⁄e_föish_⁄e_bg
(
fs_öfo
);

1834 i‡(
ªt_fö
 !1 || !
	`båfs_z⁄e_a˘iv©e
(
block_group
))

1835  
Ál£
;

1837 } i‡(*
a˘ive_bg
 !
block_group
) {

1838 
båfs_block_group
 *
tgt
 = *
a˘ive_bg
;

1841 
	`lockdï_as£π_hñd
(&
fs_öfo
->
z⁄ed_mëa_io_lock
);

1843 i‡(
tgt
) {

1848 i‡(
tgt
->
mëa_wrôe_poöãr
 <Ågt->
°¨t
 +Ågt->
Æloc_off£t
) {

1849 i‡(
wbc
->
sync_mode
 =
WB_SYNC_NONE
 ||

1850 (
wbc
->
sync_mode
 =
WB_SYNC_ALL
 && !wbc->
f‹_sync
))

1851  
Ál£
;

1855 
	`båfs_z⁄ed_mëa_io_u∆ock
(
fs_öfo
);

1856 
	`waô_eb_wrôebacks
(
tgt
);

1857 
	`do_z⁄e_föish
(
tgt
, 
åue
);

1858 
	`båfs_z⁄ed_mëa_io_lock
(
fs_öfo
);

1859 i‡(*
a˘ive_bg
 =
tgt
) {

1860 
	`båfs_put_block_group
(
tgt
);

1861 *
a˘ive_bg
 = 
NULL
;

1864 i‡(!
	`båfs_z⁄e_a˘iv©e
(
block_group
))

1865  
Ál£
;

1866 i‡(*
a˘ive_bg
 !
block_group
) {

1867 
	`ASSERT
(*
a˘ive_bg
 =
NULL
);

1868 *
a˘ive_bg
 = 
block_group
;

1869 
	`båfs_gë_block_group
(
block_group
);

1873  
åue
;

1874 
	}
}

1884 
	$båfs_check_mëa_wrôe_poöãr
(
båfs_fs_öfo
 *
fs_öfo
,

1885 
båfs_eb_wrôe_c⁄ãxt
 *
˘x
)

1887 c⁄° 
wrôeback_c⁄åﬁ
 *
wbc
 = 
˘x
->wbc;

1888 c⁄° 
exã¡_buf„r
 *
eb
 = 
˘x
->eb;

1889 
båfs_block_group
 *
block_group
 = 
˘x
->
z⁄ed_bg
;

1891 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

1894 i‡(
block_group
) {

1895 i‡(
block_group
->
°¨t
 > 
eb
->start ||

1896 
block_group
->
°¨t
 + block_group->
Àngth
 <
eb
->start) {

1897 
	`båfs_put_block_group
(
block_group
);

1898 
block_group
 = 
NULL
;

1899 
˘x
->
z⁄ed_bg
 = 
NULL
;

1903 i‡(!
block_group
) {

1904 
block_group
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
eb
->
°¨t
);

1905 i‡(!
block_group
)

1907 
˘x
->
z⁄ed_bg
 = 
block_group
;

1910 i‡(
block_group
->
mëa_wrôe_poöãr
 =
eb
->
°¨t
) {

1911 
båfs_block_group
 **
tgt
;

1913 i‡(!
	`ã°_bô
(
BTRFS_FS_ACTIVE_ZONE_TRACKING
, &
fs_öfo
->
Êags
))

1916 i‡(
block_group
->
Êags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

1917 
tgt
 = &
fs_öfo
->
a˘ive_sy°em_bg
;

1919 
tgt
 = &
fs_öfo
->
a˘ive_mëa_bg
;

1920 i‡(
	`check_bg_is_a˘ive
(
˘x
, 
tgt
))

1928 i‡(
block_group
->
mëa_wrôe_poöãr
 > 
eb
->
°¨t
)

1929  -
EBUSY
;

1932 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
 && !wbc->
f‹_sync
)

1933  -
EAGAIN
;

1934  -
EBUSY
;

1935 
	}
}

1937 
	$båfs_z⁄ed_issue_zîoout
(
båfs_devi˚
 *
devi˚
, 
u64
 
physiˇl
, u64 
Àngth
)

1939 i‡(!
	`båfs_dev_is_£quítül
(
devi˚
, 
physiˇl
))

1940  -
EOPNOTSUPP
;

1942  
	`blkdev_issue_zîoout
(
devi˚
->
bdev
, 
physiˇl
 >> 
SECTOR_SHIFT
,

1943 
Àngth
 >> 
SECTOR_SHIFT
, 
GFP_NOFS
, 0);

1944 
	}
}

1946 
	$ªad_z⁄e_öfo
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
logiˇl
,

1947 
blk_z⁄e
 *
z⁄e
)

1949 
båfs_io_c⁄ãxt
 *
bioc
 = 
NULL
;

1950 
u64
 
m≠≥d_Àngth
 = 
PAGE_SIZE
;

1951 
nofs_Êag
;

1952 
nmúr‹s
;

1953 
i
, 
ªt
;

1955 
ªt
 = 
	`båfs_m≠_block
(
fs_öfo
, 
BTRFS_MAP_GET_READ_MIRRORS
, 
logiˇl
,

1956 &
m≠≥d_Àngth
, &
bioc
, 
NULL
, NULL, 1);

1957 i‡(
ªt
 || !
bioc
 || 
m≠≥d_Àngth
 < 
PAGE_SIZE
) {

1958 
ªt
 = -
EIO
;

1959 
out_put_bioc
;

1962 i‡(
bioc
->
m≠_ty≥
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

1963 
ªt
 = -
EINVAL
;

1964 
out_put_bioc
;

1967 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

1968 
nmúr‹s
 = ()
bioc
->
num_°rùes
;

1969 
i
 = 0; i < 
nmúr‹s
; i++) {

1970 
u64
 
physiˇl
 = 
bioc
->
°rùes
[
i
].physical;

1971 
båfs_devi˚
 *
dev
 = 
bioc
->
°rùes
[
i
].dev;

1974 i‡(!
dev
->
bdev
)

1977 
ªt
 = 
	`båfs_gë_dev_z⁄e
(
dev
, 
physiˇl
, 
z⁄e
);

1979 i‡(
ªt
 =-
EIO
 ||Ñë =-
EOPNOTSUPP
)

1983 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

1984 
out_put_bioc
:

1985 
	`båfs_put_bioc
(
bioc
);

1986  
ªt
;

1987 
	}
}

1994 
	$båfs_sync_z⁄e_wrôe_poöãr
(
båfs_devi˚
 *
tgt_dev
, 
u64
 
logiˇl
,

1995 
u64
 
physiˇl_°¨t
, u64 
physiˇl_pos
)

1997 
båfs_fs_öfo
 *
fs_öfo
 = 
tgt_dev
->fs_info;

1998 
blk_z⁄e
 
z⁄e
;

1999 
u64
 
Àngth
;

2000 
u64
 
wp
;

2001 
ªt
;

2003 i‡(!
	`båfs_dev_is_£quítül
(
tgt_dev
, 
physiˇl_pos
))

2006 
ªt
 = 
	`ªad_z⁄e_öfo
(
fs_öfo
, 
logiˇl
, &
z⁄e
);

2007 i‡(
ªt
)

2008  
ªt
;

2010 
wp
 = 
physiˇl_°¨t
 + ((
z⁄e
.w∞- z⁄e.
°¨t
Ë<< 
SECTOR_SHIFT
);

2012 i‡(
physiˇl_pos
 =
wp
)

2015 i‡(
physiˇl_pos
 > 
wp
)

2016  -
EUCLEAN
;

2018 
Àngth
 = 
wp
 - 
physiˇl_pos
;

2019  
	`båfs_z⁄ed_issue_zîoout
(
tgt_dev
, 
physiˇl_pos
, 
Àngth
);

2020 
	}
}

2029 
boﬁ
 
	$båfs_z⁄e_a˘iv©e
(
båfs_block_group
 *
block_group
)

2031 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

2032 
m≠_lookup
 *
m≠
;

2033 
båfs_devi˚
 *
devi˚
;

2034 
u64
 
physiˇl
;

2035 c⁄° 
boﬁ
 
is_d©a
 = (
block_group
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
);

2036 
boﬁ
 
ªt
;

2037 
i
;

2039 i‡(!
	`båfs_is_z⁄ed
(
block_group
->
fs_öfo
))

2040  
åue
;

2042 
m≠
 = 
block_group
->
physiˇl_m≠
;

2044 
	`•ö_lock
(&
block_group
->
lock
);

2045 i‡(
	`ã°_bô
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
, &
block_group
->
ru¡ime_Êags
)) {

2046 
ªt
 = 
åue
;

2047 
out_u∆ock
;

2051 i‡(
	`båfs_z⁄ed_bg_is_fuŒ
(
block_group
)) {

2052 
ªt
 = 
Ál£
;

2053 
out_u∆ock
;

2056 
	`•ö_lock
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

2057 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

2058 
båfs_z⁄ed_devi˚_öfo
 *
zöfo
;

2059 
ª£rved
 = 0;

2061 
devi˚
 = 
m≠
->
°rùes
[
i
].
dev
;

2062 
physiˇl
 = 
m≠
->
°rùes
[
i
].physical;

2063 
zöfo
 = 
devi˚
->
z⁄e_öfo
;

2065 i‡(
zöfo
->
max_a˘ive_z⁄es
 == 0)

2068 i‡(
is_d©a
)

2069 
ª£rved
 = 
zöfo
->
ª£rved_a˘ive_z⁄es
;

2074 i‡(
	`©omic_ªad
(&
zöfo
->
a˘ive_z⁄es_À·
Ë<
ª£rved
) {

2075 
ªt
 = 
Ál£
;

2076 
	`•ö_u∆ock
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

2077 
out_u∆ock
;

2080 i‡(!
	`båfs_dev_£t_a˘ive_z⁄e
(
devi˚
, 
physiˇl
)) {

2082 
ªt
 = 
Ál£
;

2083 
	`•ö_u∆ock
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

2084 
out_u∆ock
;

2086 i‡(!
is_d©a
)

2087 
zöfo
->
ª£rved_a˘ive_z⁄es
--;

2089 
	`•ö_u∆ock
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

2092 
	`£t_bô
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
, &
block_group
->
ru¡ime_Êags
);

2093 
	`•ö_u∆ock
(&
block_group
->
lock
);

2096 
	`båfs_gë_block_group
(
block_group
);

2098 
	`•ö_lock
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

2099 
	`li°_add_èû
(&
block_group
->
a˘ive_bg_li°
, &
fs_öfo
->
z⁄e_a˘ive_bgs
);

2100 
	`•ö_u∆ock
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

2102  
åue
;

2104 
out_u∆ock
:

2105 
	`•ö_u∆ock
(&
block_group
->
lock
);

2106  
ªt
;

2107 
	}
}

2109 
	$waô_eb_wrôebacks
(
båfs_block_group
 *
block_group
)

2111 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

2112 c⁄° 
u64
 
íd
 = 
block_group
->
°¨t
 + block_group->
Àngth
;

2113 
ødix_åì_ôî
 
ôî
;

2114 
exã¡_buf„r
 *
eb
;

2115 
__rcu
 **
¶Ÿ
;

2117 
	`rcu_ªad_lock
();

2118 
	`ødix_åì_f‹_óch_¶Ÿ
(
¶Ÿ
, &
fs_öfo
->
buf„r_ødix
, &
ôî
,

2119 
block_group
->
°¨t
 >> 
fs_öfo
->
£˘‹size_bôs
) {

2120 
eb
 = 
	`ødix_åì_dîef_¶Ÿ
(
¶Ÿ
);

2121 i‡(!
eb
)

2123 i‡(
	`ødix_åì_dîef_ªåy
(
eb
)) {

2124 
¶Ÿ
 = 
	`ødix_åì_ôî_ªåy
(&
ôî
);

2128 i‡(
eb
->
°¨t
 < 
block_group
->start)

2130 i‡(
eb
->
°¨t
 >
íd
)

2133 
¶Ÿ
 = 
	`ødix_åì_ôî_ªsume
(¶Ÿ, &
ôî
);

2134 
	`rcu_ªad_u∆ock
();

2135 
	`waô_⁄_exã¡_buf„r_wrôeback
(
eb
);

2136 
	`rcu_ªad_lock
();

2138 
	`rcu_ªad_u∆ock
();

2139 
	}
}

2141 
	$do_z⁄e_föish
(
båfs_block_group
 *
block_group
, 
boﬁ
 
fuŒy_wrôãn
)

2143 
båfs_fs_öfo
 *
fs_öfo
 = 
block_group
->fs_info;

2144 
m≠_lookup
 *
m≠
;

2145 c⁄° 
boﬁ
 
is_mëad©a
 = (
block_group
->
Êags
 &

2146 (
BTRFS_BLOCK_GROUP_METADATA
 | 
BTRFS_BLOCK_GROUP_SYSTEM
));

2147 
ªt
 = 0;

2148 
i
;

2150 
	`•ö_lock
(&
block_group
->
lock
);

2151 i‡(!
	`ã°_bô
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
, &
block_group
->
ru¡ime_Êags
)) {

2152 
	`•ö_u∆ock
(&
block_group
->
lock
);

2157 i‡(
is_mëad©a
 &&

2158 
block_group
->
°¨t
 + block_group->
Æloc_off£t
 > block_group->
mëa_wrôe_poöãr
) {

2159 
	`•ö_u∆ock
(&
block_group
->
lock
);

2160  -
EAGAIN
;

2170 i‡(!
fuŒy_wrôãn
) {

2171 i‡(
	`ã°_bô
(
BLOCK_GROUP_FLAG_ZONED_DATA_RELOC
, &
block_group
->
ru¡ime_Êags
)) {

2172 
	`•ö_u∆ock
(&
block_group
->
lock
);

2173  -
EAGAIN
;

2175 
	`•ö_u∆ock
(&
block_group
->
lock
);

2177 
ªt
 = 
	`båfs_öc_block_group_ro
(
block_group
, 
Ál£
);

2178 i‡(
ªt
)

2179  
ªt
;

2182 
	`båfs_waô_block_group_ª£rv©i⁄s
(
block_group
);

2184 
	`båfs_waô_‹dîed_roŸs
(
fs_öfo
, 
U64_MAX
, 
block_group
->
°¨t
,

2185 
block_group
->
Àngth
);

2187 i‡(
is_mëad©a
)

2188 
	`waô_eb_wrôebacks
(
block_group
);

2190 
	`•ö_lock
(&
block_group
->
lock
);

2196 i‡(!
	`ã°_bô
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
,

2197 &
block_group
->
ru¡ime_Êags
)) {

2198 
	`•ö_u∆ock
(&
block_group
->
lock
);

2199 
	`båfs_dec_block_group_ro
(
block_group
);

2203 i‡(
block_group
->
ª£rved
 ||

2204 
	`ã°_bô
(
BLOCK_GROUP_FLAG_ZONED_DATA_RELOC
,

2205 &
block_group
->
ru¡ime_Êags
)) {

2206 
	`•ö_u∆ock
(&
block_group
->
lock
);

2207 
	`båfs_dec_block_group_ro
(
block_group
);

2208  -
EAGAIN
;

2212 
	`˛ór_bô
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
, &
block_group
->
ru¡ime_Êags
);

2213 
block_group
->
Æloc_off£t
 = block_group->
z⁄e_ˇ∑côy
;

2214 i‡(
block_group
->
Êags
 & (
BTRFS_BLOCK_GROUP_METADATA
 | 
BTRFS_BLOCK_GROUP_SYSTEM
))

2215 
block_group
->
mëa_wrôe_poöãr
 = block_group->
°¨t
 +

2216 
block_group
->
z⁄e_ˇ∑côy
;

2217 
block_group
->
‰ì_•a˚_˘l
->
‰ì_•a˚
 = 0;

2218 
	`båfs_˛ór_åìlog_bg
(
block_group
);

2219 
	`båfs_˛ór_d©a_ªloc_bg
(
block_group
);

2220 
	`•ö_u∆ock
(&
block_group
->
lock
);

2222 
m≠
 = 
block_group
->
physiˇl_m≠
;

2223 
i
 = 0; i < 
m≠
->
num_°rùes
; i++) {

2224 
båfs_devi˚
 *
devi˚
 = 
m≠
->
°rùes
[
i
].
dev
;

2225 c⁄° 
u64
 
physiˇl
 = 
m≠
->
°rùes
[
i
].physical;

2226 
båfs_z⁄ed_devi˚_öfo
 *
zöfo
 = 
devi˚
->
z⁄e_öfo
;

2228 i‡(
zöfo
->
max_a˘ive_z⁄es
 == 0)

2231 
ªt
 = 
	`blkdev_z⁄e_mgmt
(
devi˚
->
bdev
, 
REQ_OP_ZONE_FINISH
,

2232 
physiˇl
 >> 
SECTOR_SHIFT
,

2233 
zöfo
->
z⁄e_size
 >> 
SECTOR_SHIFT
,

2234 
GFP_NOFS
);

2236 i‡(
ªt
)

2237  
ªt
;

2239 i‡(!(
block_group
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
))

2240 
zöfo
->
ª£rved_a˘ive_z⁄es
++;

2241 
	`båfs_dev_˛ór_a˘ive_z⁄e
(
devi˚
, 
physiˇl
);

2244 i‡(!
fuŒy_wrôãn
)

2245 
	`båfs_dec_block_group_ro
(
block_group
);

2247 
	`•ö_lock
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

2248 
	`ASSERT
(!
	`li°_em±y
(&
block_group
->
a˘ive_bg_li°
));

2249 
	`li°_dñ_öô
(&
block_group
->
a˘ive_bg_li°
);

2250 
	`•ö_u∆ock
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

2253 
	`båfs_put_block_group
(
block_group
);

2255 
	`˛ór_™d_wake_up_bô
(
BTRFS_FS_NEED_ZONE_FINISH
, &
fs_öfo
->
Êags
);

2258 
	}
}

2260 
	$båfs_z⁄e_föish
(
båfs_block_group
 *
block_group
)

2262 i‡(!
	`båfs_is_z⁄ed
(
block_group
->
fs_öfo
))

2265  
	`do_z⁄e_föish
(
block_group
, 
Ál£
);

2266 
	}
}

2268 
boﬁ
 
	$båfs_ˇn_a˘iv©e_z⁄e
(
båfs_fs_devi˚s
 *
fs_devi˚s
, 
u64
 
Êags
)

2270 
båfs_fs_öfo
 *
fs_öfo
 = 
fs_devi˚s
->fs_info;

2271 
båfs_devi˚
 *
devi˚
;

2272 
boﬁ
 
ªt
 = 
Ál£
;

2274 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

2275  
åue
;

2278 
	`muãx_lock
(&
fs_öfo
->
chunk_muãx
);

2279 
	`•ö_lock
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

2280 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_devi˚s
->
Æloc_li°
, 
dev_Æloc_li°
) {

2281 
båfs_z⁄ed_devi˚_öfo
 *
zöfo
 = 
devi˚
->
z⁄e_öfo
;

2282 
ª£rved
 = 0;

2284 i‡(!
devi˚
->
bdev
)

2287 i‡(!
zöfo
->
max_a˘ive_z⁄es
) {

2288 
ªt
 = 
åue
;

2292 i‡(
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
)

2293 
ª£rved
 = 
zöfo
->
ª£rved_a˘ive_z⁄es
;

2295 
Êags
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) {

2297 
ªt
 = (
	`©omic_ªad
(&
zöfo
->
a˘ive_z⁄es_À·
Ë>(1 + 
ª£rved
));

2299 
BTRFS_BLOCK_GROUP_DUP
:

2300 
ªt
 = (
	`©omic_ªad
(&
zöfo
->
a˘ive_z⁄es_À·
Ë>(2 + 
ª£rved
));

2303 i‡(
ªt
)

2306 
	`•ö_u∆ock
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

2307 
	`muãx_u∆ock
(&
fs_öfo
->
chunk_muãx
);

2309 i‡(!
ªt
)

2310 
	`£t_bô
(
BTRFS_FS_NEED_ZONE_FINISH
, &
fs_öfo
->
Êags
);

2312  
ªt
;

2313 
	}
}

2315 
	$båfs_z⁄e_föish_ídio
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
logiˇl
, u64 
Àngth
)

2317 
båfs_block_group
 *
block_group
;

2318 
u64
 
mö_Æloc_byãs
;

2320 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

2323 
block_group
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
logiˇl
);

2324 
	`ASSERT
(
block_group
);

2327 i‡(
block_group
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
)

2328 
mö_Æloc_byãs
 = 
fs_öfo
->
£˘‹size
;

2330 
mö_Æloc_byãs
 = 
fs_öfo
->
nodesize
;

2333 i‡(
logiˇl
 + 
Àngth
 + 
mö_Æloc_byãs
 <=

2334 
block_group
->
°¨t
 + block_group->
z⁄e_ˇ∑côy
)

2335 
out
;

2337 
	`do_z⁄e_föish
(
block_group
, 
åue
);

2339 
out
:

2340 
	`båfs_put_block_group
(
block_group
);

2341 
	}
}

2343 
	$båfs_z⁄e_föish_ídio_w‹k‚
(
w‹k_°ru˘
 *
w‹k
)

2345 
båfs_block_group
 *
bg
 =

2346 
	`c⁄èöî_of
(
w‹k
, 
båfs_block_group
, 
z⁄e_föish_w‹k
);

2348 
	`waô_⁄_exã¡_buf„r_wrôeback
(
bg
->
œ°_eb
);

2349 
	`‰ì_exã¡_buf„r
(
bg
->
œ°_eb
);

2350 
	`båfs_z⁄e_föish_ídio
(
bg
->
fs_öfo
, bg->
°¨t
, bg->
Àngth
);

2351 
	`båfs_put_block_group
(
bg
);

2352 
	}
}

2354 
	$båfs_scheduÀ_z⁄e_föish_bg
(
båfs_block_group
 *
bg
,

2355 
exã¡_buf„r
 *
eb
)

2357 i‡(!
	`ã°_bô
(
BLOCK_GROUP_FLAG_SEQUENTIAL_ZONE
, &
bg
->
ru¡ime_Êags
) ||

2358 
eb
->
°¨t
 +Éb->
Àn
 * 2 <
bg
->°¨à+ bg->
z⁄e_ˇ∑côy
)

2361 i‡(
	`WARN_ON
(
bg
->
z⁄e_föish_w‹k
.
func
 =
båfs_z⁄e_föish_ídio_w‹k‚
)) {

2362 
	`båfs_îr
(
bg
->
fs_öfo
, "double scheduling of bg %llu zone finishing",

2363 
bg
->
°¨t
);

2368 
	`båfs_gë_block_group
(
bg
);

2369 
	`©omic_öc
(&
eb
->
ªfs
);

2370 
bg
->
œ°_eb
 = 
eb
;

2371 
	`INIT_WORK
(&
bg
->
z⁄e_föish_w‹k
, 
båfs_z⁄e_föish_ídio_w‹k‚
);

2372 
	`queue_w‹k
(
sy°em_unbound_wq
, &
bg
->
z⁄e_föish_w‹k
);

2373 
	}
}

2375 
	$båfs_˛ór_d©a_ªloc_bg
(
båfs_block_group
 *
bg
)

2377 
båfs_fs_öfo
 *
fs_öfo
 = 
bg
->fs_info;

2379 
	`•ö_lock
(&
fs_öfo
->
ªloˇti⁄_bg_lock
);

2380 i‡(
fs_öfo
->
d©a_ªloc_bg
 =
bg
->
°¨t
)

2381 
fs_öfo
->
d©a_ªloc_bg
 = 0;

2382 
	`•ö_u∆ock
(&
fs_öfo
->
ªloˇti⁄_bg_lock
);

2383 
	}
}

2385 
	$båfs_‰ì_z⁄e_ˇche
(
båfs_fs_öfo
 *
fs_öfo
)

2387 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

2388 
båfs_devi˚
 *
devi˚
;

2390 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

2393 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

2394 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

2395 i‡(
devi˚
->
z⁄e_öfo
) {

2396 
	`v‰ì
(
devi˚
->
z⁄e_öfo
->
z⁄e_ˇche
);

2397 
devi˚
->
z⁄e_öfo
->
z⁄e_ˇche
 = 
NULL
;

2400 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

2401 
	}
}

2403 
boﬁ
 
	$båfs_z⁄ed_should_ª˛aim
(
båfs_fs_öfo
 *
fs_öfo
)

2405 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

2406 
båfs_devi˚
 *
devi˚
;

2407 
u64
 
u£d
 = 0;

2408 
u64
 
tŸÆ
 = 0;

2409 
u64
 
Á˘‹
;

2411 
	`ASSERT
(
	`båfs_is_z⁄ed
(
fs_öfo
));

2413 i‡(
fs_öfo
->
bg_ª˛aim_thªshﬁd
 == 0)

2414  
Ál£
;

2416 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

2417 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

2418 i‡(!
devi˚
->
bdev
)

2421 
tŸÆ
 +
devi˚
->
disk_tŸÆ_byãs
;

2422 
u£d
 +
devi˚
->
byãs_u£d
;

2424 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

2426 
Á˘‹
 = 
	`div64_u64
(
u£d
 * 100, 
tŸÆ
);

2427  
Á˘‹
 >
fs_öfo
->
bg_ª˛aim_thªshﬁd
;

2428 
	}
}

2430 
	$båfs_z⁄ed_ªÀa£_d©a_ªloc_bg
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
logiˇl
,

2431 
u64
 
Àngth
)

2433 
båfs_block_group
 *
block_group
;

2435 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

2438 
block_group
 = 
	`båfs_lookup_block_group
(
fs_öfo
, 
logiˇl
);

2440 
	`ASSERT
(
block_group
 && (block_group->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
));

2442 
	`•ö_lock
(&
block_group
->
lock
);

2443 i‡(!
	`ã°_bô
(
BLOCK_GROUP_FLAG_ZONED_DATA_RELOC
, &
block_group
->
ru¡ime_Êags
))

2444 
out
;

2447 i‡(
block_group
->
°¨t
 + block_group->
Æloc_off£t
 =
logiˇl
 + 
Àngth
) {

2452 
	`˛ór_bô
(
BLOCK_GROUP_FLAG_ZONED_DATA_RELOC
,

2453 &
block_group
->
ru¡ime_Êags
);

2456 
out
:

2457 
	`•ö_u∆ock
(&
block_group
->
lock
);

2458 
	`båfs_put_block_group
(
block_group
);

2459 
	}
}

2461 
	$båfs_z⁄e_föish_⁄e_bg
(
båfs_fs_öfo
 *
fs_öfo
)

2463 
båfs_block_group
 *
block_group
;

2464 
båfs_block_group
 *
mö_bg
 = 
NULL
;

2465 
u64
 
mö_avaû
 = 
U64_MAX
;

2466 
ªt
;

2468 
	`•ö_lock
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

2469 
	`li°_f‹_óch_íåy
(
block_group
, &
fs_öfo
->
z⁄e_a˘ive_bgs
,

2470 
a˘ive_bg_li°
) {

2471 
u64
 
avaû
;

2473 
	`•ö_lock
(&
block_group
->
lock
);

2474 i‡(
block_group
->
ª£rved
 || block_group->
Æloc_off£t
 == 0 ||

2475 (
block_group
->
Êags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) ||

2476 
	`ã°_bô
(
BLOCK_GROUP_FLAG_ZONED_DATA_RELOC
, &
block_group
->
ru¡ime_Êags
)) {

2477 
	`•ö_u∆ock
(&
block_group
->
lock
);

2481 
avaû
 = 
block_group
->
z⁄e_ˇ∑côy
 - block_group->
Æloc_off£t
;

2482 i‡(
mö_avaû
 > 
avaû
) {

2483 i‡(
mö_bg
)

2484 
	`båfs_put_block_group
(
mö_bg
);

2485 
mö_bg
 = 
block_group
;

2486 
mö_avaû
 = 
avaû
;

2487 
	`båfs_gë_block_group
(
mö_bg
);

2489 
	`•ö_u∆ock
(&
block_group
->
lock
);

2491 
	`•ö_u∆ock
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

2493 i‡(!
mö_bg
)

2496 
ªt
 = 
	`båfs_z⁄e_föish
(
mö_bg
);

2497 
	`båfs_put_block_group
(
mö_bg
);

2499  
ªt
 < 0 ?Ñet : 1;

2500 
	}
}

2502 
	$båfs_z⁄ed_a˘iv©e_⁄e_bg
(
båfs_fs_öfo
 *
fs_öfo
,

2503 
båfs_•a˚_öfo
 *
•a˚_öfo
,

2504 
boﬁ
 
do_föish
)

2506 
båfs_block_group
 *
bg
;

2507 
ödex
;

2509 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
Ë|| (
•a˚_öfo
->
Êags
 & 
BTRFS_BLOCK_GROUP_DATA
))

2513 
ªt
;

2514 
boﬁ
 
√ed_föish
 = 
Ál£
;

2516 
	`down_ªad
(&
•a˚_öfo
->
groups_£m
);

2517 
ödex
 = 0; index < 
BTRFS_NR_RAID_TYPES
; index++) {

2518 
	`li°_f‹_óch_íåy
(
bg
, &
•a˚_öfo
->
block_groups
[
ödex
],

2519 
li°
) {

2520 i‡(!
	`•ö_åylock
(&
bg
->
lock
))

2522 i‡(
	`båfs_z⁄ed_bg_is_fuŒ
(
bg
) ||

2523 
	`ã°_bô
(
BLOCK_GROUP_FLAG_ZONE_IS_ACTIVE
,

2524 &
bg
->
ru¡ime_Êags
)) {

2525 
	`•ö_u∆ock
(&
bg
->
lock
);

2528 
	`•ö_u∆ock
(&
bg
->
lock
);

2530 i‡(
	`båfs_z⁄e_a˘iv©e
(
bg
)) {

2531 
	`up_ªad
(&
•a˚_öfo
->
groups_£m
);

2535 
√ed_föish
 = 
åue
;

2538 
	`up_ªad
(&
•a˚_öfo
->
groups_£m
);

2540 i‡(!
do_föish
 || !
√ed_föish
)

2543 
ªt
 = 
	`båfs_z⁄e_föish_⁄e_bg
(
fs_öfo
);

2544 i‡(
ªt
 == 0)

2546 i‡(
ªt
 < 0)

2547  
ªt
;

2551 
	}
}

2557 
	$båfs_check_a˘ive_z⁄e_ª£rv©i⁄
(
båfs_fs_öfo
 *
fs_öfo
)

2559 
båfs_fs_devi˚s
 *
fs_devi˚s
 = 
fs_öfo
->fs_devices;

2560 
båfs_block_group
 *
block_group
;

2561 
båfs_devi˚
 *
devi˚
;

2563 
mëad©a_ª£rve
 = 2;

2565 
sy°em_ª£rve
 = 1;

2567 i‡(!
	`ã°_bô
(
BTRFS_FS_ACTIVE_ZONE_TRACKING
, &
fs_öfo
->
Êags
))

2574 i‡(
fs_öfo
->
avaû_mëad©a_Æloc_bôs
 & 
BTRFS_BLOCK_GROUP_DUP
)

2575 
mëad©a_ª£rve
 = 4;

2576 i‡(
fs_öfo
->
avaû_sy°em_Æloc_bôs
 & 
BTRFS_BLOCK_GROUP_DUP
)

2577 
sy°em_ª£rve
 = 2;

2580 
	`muãx_lock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

2581 
	`li°_f‹_óch_íåy
(
devi˚
, &
fs_devi˚s
->
devi˚s
, 
dev_li°
) {

2582 i‡(!
devi˚
->
bdev
)

2585 
devi˚
->
z⁄e_öfo
->
ª£rved_a˘ive_z⁄es
 =

2586 
mëad©a_ª£rve
 + 
sy°em_ª£rve
;

2588 
	`muãx_u∆ock
(&
fs_devi˚s
->
devi˚_li°_muãx
);

2591 
	`•ö_lock
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

2592 
	`li°_f‹_óch_íåy
(
block_group
, &
fs_öfo
->
z⁄e_a˘ive_bgs
, 
a˘ive_bg_li°
) {

2593 
m≠_lookup
 *
m≠
 = 
block_group
->
physiˇl_m≠
;

2595 i‡(!(
block_group
->
Êags
 &

2596 (
BTRFS_BLOCK_GROUP_METADATA
 | 
BTRFS_BLOCK_GROUP_SYSTEM
)))

2599 
i
 = 0; i < 
m≠
->
num_°rùes
; i++)

2600 
m≠
->
°rùes
[
i
].
dev
->
z⁄e_öfo
->
ª£rved_a˘ive_z⁄es
--;

2602 
	`•ö_u∆ock
(&
fs_öfo
->
z⁄e_a˘ive_bgs_lock
);

2603 
	}
}

	@zoned.h

3 #i‚de‡
BTRFS_ZONED_H


4 
	#BTRFS_ZONED_H


	)

6 
	~<löux/ty≥s.h
>

7 
	~<löux/blkdev.h
>

8 
	~"mesßges.h
"

9 
	~"vﬁumes.h
"

10 
	~"disk-io.h
"

11 
	~"block-group.h
"

12 
	~"båfs_öode.h
"

14 
	#BTRFS_DEFAULT_RECLAIM_THRESH
 (75)

	)

16 
	sbåfs_z⁄ed_devi˚_öfo
 {

21 
u64
 
	mz⁄e_size
;

22 
u8
 
	mz⁄e_size_shi·
;

23 
u32
 
	mƒ_z⁄es
;

24 
	mmax_a˘ive_z⁄es
;

29 
	mª£rved_a˘ive_z⁄es
;

30 
©omic_t
 
	ma˘ive_z⁄es_À·
;

31 *
	m£q_z⁄es
;

32 *
	mem±y_z⁄es
;

33 *
	ma˘ive_z⁄es
;

34 
blk_z⁄e
 *
	mz⁄e_ˇche
;

35 
blk_z⁄e
 
	msb_z⁄es
[2 * 
BTRFS_SUPER_MIRROR_MAX
];

38 
båfs_föish_‹dîed_z⁄ed
(
båfs_‹dîed_exã¡
 *
‹dîed
);

40 #ifde‡
CONFIG_BLK_DEV_ZONED


41 
båfs_gë_dev_z⁄e
(
båfs_devi˚
 *
devi˚
, 
u64
 
pos
,

42 
blk_z⁄e
 *
z⁄e
);

43 
båfs_gë_dev_z⁄e_öfo_Æl_devi˚s
(
båfs_fs_öfo
 *
fs_öfo
);

44 
båfs_gë_dev_z⁄e_öfo
(
båfs_devi˚
 *
devi˚
, 
boﬁ
 
p›uœã_ˇche
);

45 
båfs_de°roy_dev_z⁄e_öfo
(
båfs_devi˚
 *
devi˚
);

46 
båfs_z⁄ed_devi˚_öfo
 *
båfs_˛⁄e_dev_z⁄e_öfo
(
båfs_devi˚
 *
‹ig_dev
);

47 
båfs_check_z⁄ed_mode
(
båfs_fs_öfo
 *
fs_öfo
);

48 
båfs_check_mou¡›ts_z⁄ed
(
båfs_fs_öfo
 *
öfo
);

49 
båfs_sb_log_loˇti⁄_bdev
(
block_devi˚
 *
bdev
, 
múr‹
, 
rw
,

50 
u64
 *
byãƒ_ªt
);

51 
båfs_sb_log_loˇti⁄_bdev_∑πôi⁄
(
block_devi˚
 *
bdev
,

52 
múr‹
, 
rw
, 
u64
 *
byãƒ_ªt
, u64 
sb_off£t
);

53 
båfs_sb_log_loˇti⁄
(
båfs_devi˚
 *
devi˚
, 
múr‹
, 
rw
,

54 
u64
 *
byãƒ_ªt
);

55 
båfs_sb_log_loˇti⁄_∑πôi⁄
(
båfs_devi˚
 *
devi˚
, 
múr‹
,

56 
rw
, 
u64
 *
byãƒ_ªt
, u64 
sb_off£t
);

57 
båfs_adv™˚_sb_log
(
båfs_devi˚
 *
devi˚
, 
múr‹
);

58 
båfs_ª£t_sb_log_z⁄es
(
block_devi˚
 *
bdev
, 
múr‹
);

59 
u64
 
båfs_föd_ÆloˇèbÀ_z⁄es
(
båfs_devi˚
 *
devi˚
, u64 
hﬁe_°¨t
,

60 
u64
 
hﬁe_íd
, u64 
num_byãs
);

61 
båfs_ª£t_devi˚_z⁄e
(
båfs_devi˚
 *
devi˚
, 
u64
 
physiˇl
,

62 
u64
 
Àngth
, u64 *
byãs
);

63 
båfs_ísuª_em±y_z⁄es
(
båfs_devi˚
 *
devi˚
, 
u64
 
°¨t
, u64 
size
);

64 
båfs_lﬂd_block_group_z⁄e_öfo
(
båfs_block_group
 *
ˇche
, 
boﬁ
 
√w
);

65 
båfs_ˇlc_z⁄e_unußbÀ
(
båfs_block_group
 *
ˇche
);

66 
båfs_ªdúty_li°_add
(
båfs_å™ß˘i⁄
 *
å™s
,

67 
exã¡_buf„r
 *
eb
);

68 
boﬁ
 
båfs_u£_z⁄e_≠≥nd
(
båfs_bio
 *
bbio
);

69 
båfs_ªc‹d_physiˇl_z⁄ed
(
båfs_bio
 *
bbio
);

70 
båfs_check_mëa_wrôe_poöãr
(
båfs_fs_öfo
 *
fs_öfo
,

71 
båfs_eb_wrôe_c⁄ãxt
 *
˘x
);

72 
båfs_z⁄ed_issue_zîoout
(
båfs_devi˚
 *
devi˚
, 
u64
 
physiˇl
, u64 
Àngth
);

73 
båfs_sync_z⁄e_wrôe_poöãr
(
båfs_devi˚
 *
tgt_dev
, 
u64
 
logiˇl
,

74 
u64
 
physiˇl_°¨t
, u64 
physiˇl_pos
);

75 
boﬁ
 
båfs_z⁄e_a˘iv©e
(
båfs_block_group
 *
block_group
);

76 
båfs_z⁄e_föish
(
båfs_block_group
 *
block_group
);

77 
boﬁ
 
båfs_ˇn_a˘iv©e_z⁄e
(
båfs_fs_devi˚s
 *
fs_devi˚s
, 
u64
 
Êags
);

78 
båfs_z⁄e_föish_ídio
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
logiˇl
,

79 
u64
 
Àngth
);

80 
båfs_scheduÀ_z⁄e_föish_bg
(
båfs_block_group
 *
bg
,

81 
exã¡_buf„r
 *
eb
);

82 
båfs_˛ór_d©a_ªloc_bg
(
båfs_block_group
 *
bg
);

83 
båfs_‰ì_z⁄e_ˇche
(
båfs_fs_öfo
 *
fs_öfo
);

84 
boﬁ
 
båfs_z⁄ed_should_ª˛aim
(
båfs_fs_öfo
 *
fs_öfo
);

85 
båfs_z⁄ed_ªÀa£_d©a_ªloc_bg
(
båfs_fs_öfo
 *
fs_öfo
, 
u64
 
logiˇl
,

86 
u64
 
Àngth
);

87 
båfs_z⁄e_föish_⁄e_bg
(
båfs_fs_öfo
 *
fs_öfo
);

88 
båfs_z⁄ed_a˘iv©e_⁄e_bg
(
båfs_fs_öfo
 *
fs_öfo
,

89 
båfs_•a˚_öfo
 *
•a˚_öfo
, 
boﬁ
 
do_föish
);

90 
båfs_check_a˘ive_z⁄e_ª£rv©i⁄
(
båfs_fs_öfo
 *
fs_öfo
);

92 
ölöe
 
	$båfs_gë_dev_z⁄e
(
båfs_devi˚
 *
devi˚
, 
u64
 
pos
,

93 
blk_z⁄e
 *
z⁄e
)

96 
	}
}

98 
ölöe
 
	$båfs_gë_dev_z⁄e_öfo_Æl_devi˚s
(
båfs_fs_öfo
 *
fs_öfo
)

101 
	}
}

103 
ölöe
 
	$båfs_gë_dev_z⁄e_öfo
(
båfs_devi˚
 *
devi˚
,

104 
boﬁ
 
p›uœã_ˇche
)

107 
	}
}

109 
ölöe
 
	$båfs_de°roy_dev_z⁄e_öfo
(
båfs_devi˚
 *
devi˚
Ë{ 
	}
}

115 
ölöe
 
båfs_z⁄ed_devi˚_öfo
 *
	$båfs_˛⁄e_dev_z⁄e_öfo
(

116 
båfs_devi˚
 *
‹ig_dev
)

118  
NULL
;

119 
	}
}

121 
ölöe
 
	$båfs_check_z⁄ed_mode
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
)

123 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

126 
	`båfs_îr
(
fs_öfo
, "zoned block devices support isÇotÉnabled");

127  -
EOPNOTSUPP
;

128 
	}
}

130 
ölöe
 
	$båfs_check_mou¡›ts_z⁄ed
(
båfs_fs_öfo
 *
öfo
)

133 
	}
}

135 
ölöe
 
	$båfs_sb_log_loˇti⁄_bdev
(
block_devi˚
 *
bdev
,

136 
múr‹
, 
rw
, 
u64
 *
byãƒ_ªt
)

138 *
byãƒ_ªt
 = 
	`båfs_sb_off£t
(
múr‹
);

140 
	}
}

143 
ölöe
 
	$båfs_sb_log_loˇti⁄_bdev_∑πôi⁄
(
block_devi˚
 *
bdev
,

144 
múr‹
, 
rw
, 
u64
 *
byãƒ_ªt
, u64 
sb_off£t
)

146 *
byãƒ_ªt
 = 
	`båfs_sb_off£t_∑πôi⁄
(
múr‹
, 
sb_off£t
);

148 
	}
}

150 
ölöe
 
	$båfs_sb_log_loˇti⁄
(
båfs_devi˚
 *
devi˚
, 
múr‹
,

151 
rw
, 
u64
 *
byãƒ_ªt
)

153 *
byãƒ_ªt
 = 
	`båfs_sb_off£t
(
múr‹
);

155 
	}
}

157 
ölöe
 
	$båfs_sb_log_loˇti⁄_∑πôi⁄
(
båfs_devi˚
 *
devi˚
, 
múr‹
,

158 
rw
, 
u64
 *
byãƒ_ªt
, u64 
sb_off£t
)

160 *
byãƒ_ªt
 = 
	`båfs_sb_off£t_∑πôi⁄
(
múr‹
, 
sb_off£t
);

162 
	}
}

164 
ölöe
 
	$båfs_adv™˚_sb_log
(
båfs_devi˚
 *
devi˚
, 
múr‹
)

167 
	}
}

169 
ölöe
 
	$båfs_ª£t_sb_log_z⁄es
(
block_devi˚
 *
bdev
, 
múr‹
)

172 
	}
}

174 
ölöe
 
u64
 
	$båfs_föd_ÆloˇèbÀ_z⁄es
(
båfs_devi˚
 *
devi˚
,

175 
u64
 
hﬁe_°¨t
, u64 
hﬁe_íd
,

176 
u64
 
num_byãs
)

178  
hﬁe_°¨t
;

179 
	}
}

181 
ölöe
 
	$båfs_ª£t_devi˚_z⁄e
(
båfs_devi˚
 *
devi˚
,

182 
u64
 
physiˇl
, u64 
Àngth
, u64 *
byãs
)

184 *
byãs
 = 0;

186 
	}
}

188 
ölöe
 
	$båfs_ísuª_em±y_z⁄es
(
båfs_devi˚
 *
devi˚
,

189 
u64
 
°¨t
, u64 
size
)

192 
	}
}

194 
ölöe
 
	$båfs_lﬂd_block_group_z⁄e_öfo
(

195 
båfs_block_group
 *
ˇche
, 
boﬁ
 
√w
)

198 
	}
}

200 
ölöe
 
	$båfs_ˇlc_z⁄e_unußbÀ
(
båfs_block_group
 *
ˇche
Ë{ 
	}
}

202 
ölöe
 
	$båfs_ªdúty_li°_add
(
båfs_å™ß˘i⁄
 *
å™s
,

203 
exã¡_buf„r
 *
eb
Ë{ 
	}
}

205 
ölöe
 
boﬁ
 
	$båfs_u£_z⁄e_≠≥nd
(
båfs_bio
 *
bbio
)

207  
Ál£
;

208 
	}
}

210 
ölöe
 
	$båfs_ªc‹d_physiˇl_z⁄ed
(
båfs_bio
 *
bbio
)

212 
	}
}

214 
ölöe
 
	$båfs_check_mëa_wrôe_poöãr
(
båfs_fs_öfo
 *
fs_öfo
,

215 
båfs_eb_wrôe_c⁄ãxt
 *
˘x
)

218 
	}
}

220 
ölöe
 
	$båfs_z⁄ed_issue_zîoout
(
båfs_devi˚
 *
devi˚
,

221 
u64
 
physiˇl
, u64 
Àngth
)

223  -
EOPNOTSUPP
;

224 
	}
}

226 
ölöe
 
	$båfs_sync_z⁄e_wrôe_poöãr
(
båfs_devi˚
 *
tgt_dev
,

227 
u64
 
logiˇl
, u64 
physiˇl_°¨t
,

228 
u64
 
physiˇl_pos
)

230  -
EOPNOTSUPP
;

231 
	}
}

233 
ölöe
 
boﬁ
 
	$båfs_z⁄e_a˘iv©e
(
båfs_block_group
 *
block_group
)

235  
åue
;

236 
	}
}

238 
ölöe
 
	$båfs_z⁄e_föish
(
båfs_block_group
 *
block_group
)

241 
	}
}

243 
ölöe
 
boﬁ
 
	$båfs_ˇn_a˘iv©e_z⁄e
(
båfs_fs_devi˚s
 *
fs_devi˚s
,

244 
u64
 
Êags
)

246  
åue
;

247 
	}
}

249 
ölöe
 
	$båfs_z⁄e_föish_ídio
(
båfs_fs_öfo
 *
fs_öfo
,

250 
u64
 
logiˇl
, u64 
Àngth
Ë{ 
	}
}

252 
ölöe
 
	$båfs_scheduÀ_z⁄e_föish_bg
(
båfs_block_group
 *
bg
,

253 
exã¡_buf„r
 *
eb
Ë{ 
	}
}

255 
ölöe
 
	$båfs_˛ór_d©a_ªloc_bg
(
båfs_block_group
 *
bg
Ë{ 
	}
}

257 
ölöe
 
	$båfs_‰ì_z⁄e_ˇche
(
båfs_fs_öfo
 *
fs_öfo
Ë{ 
	}
}

259 
ölöe
 
boﬁ
 
	$båfs_z⁄ed_should_ª˛aim
(
båfs_fs_öfo
 *
fs_öfo
)

261  
Ál£
;

262 
	}
}

264 
ölöe
 
	$båfs_z⁄ed_ªÀa£_d©a_ªloc_bg
(
båfs_fs_öfo
 *
fs_öfo
,

265 
u64
 
logiˇl
, u64 
Àngth
Ë{ 
	}
}

267 
ölöe
 
	$båfs_z⁄e_föish_⁄e_bg
(
båfs_fs_öfo
 *
fs_öfo
)

270 
	}
}

272 
ölöe
 
	$båfs_z⁄ed_a˘iv©e_⁄e_bg
(
båfs_fs_öfo
 *
fs_öfo
,

273 
båfs_•a˚_öfo
 *
•a˚_öfo
,

274 
boﬁ
 
do_föish
)

278 
	}
}

280 
ölöe
 
	$båfs_check_a˘ive_z⁄e_ª£rv©i⁄
(
båfs_fs_öfo
 *
fs_öfo
Ë{ 
	}
}

284 
ölöe
 
boﬁ
 
	$båfs_dev_is_£quítül
(
båfs_devi˚
 *
devi˚
, 
u64
 
pos
)

286 
båfs_z⁄ed_devi˚_öfo
 *
z⁄e_öfo
 = 
devi˚
->zone_info;

288 i‡(!
z⁄e_öfo
)

289  
Ál£
;

291  
	`ã°_bô
(
pos
 >> 
z⁄e_öfo
->
z⁄e_size_shi·
, z⁄e_öfo->
£q_z⁄es
);

292 
	}
}

294 
ölöe
 
boﬁ
 
	$båfs_dev_is_em±y_z⁄e
(
båfs_devi˚
 *
devi˚
, 
u64
 
pos
)

296 
båfs_z⁄ed_devi˚_öfo
 *
z⁄e_öfo
 = 
devi˚
->zone_info;

298 i‡(!
z⁄e_öfo
)

299  
åue
;

301  
	`ã°_bô
(
pos
 >> 
z⁄e_öfo
->
z⁄e_size_shi·
, z⁄e_öfo->
em±y_z⁄es
);

302 
	}
}

304 
ölöe
 
	$båfs_dev_£t_em±y_z⁄e_bô
(
båfs_devi˚
 *
devi˚
,

305 
u64
 
pos
, 
boﬁ
 
£t
)

307 
båfs_z⁄ed_devi˚_öfo
 *
z⁄e_öfo
 = 
devi˚
->zone_info;

308 
zno
;

310 i‡(!
z⁄e_öfo
)

313 
zno
 = 
pos
 >> 
z⁄e_öfo
->
z⁄e_size_shi·
;

314 i‡(
£t
)

315 
	`£t_bô
(
zno
, 
z⁄e_öfo
->
em±y_z⁄es
);

317 
	`˛ór_bô
(
zno
, 
z⁄e_öfo
->
em±y_z⁄es
);

318 
	}
}

320 
ölöe
 
	$båfs_dev_£t_z⁄e_em±y
(
båfs_devi˚
 *
devi˚
, 
u64
 
pos
)

322 
	`båfs_dev_£t_em±y_z⁄e_bô
(
devi˚
, 
pos
, 
åue
);

323 
	}
}

325 
ölöe
 
	$båfs_dev_˛ór_z⁄e_em±y
(
båfs_devi˚
 *
devi˚
, 
u64
 
pos
)

327 
	`båfs_dev_£t_em±y_z⁄e_bô
(
devi˚
, 
pos
, 
Ál£
);

328 
	}
}

330 
ölöe
 
boﬁ
 
	$båfs_check_devi˚_z⁄e_ty≥
(c⁄° 
båfs_fs_öfo
 *
fs_öfo
,

331 
block_devi˚
 *
bdev
)

333 i‡(
	`båfs_is_z⁄ed
(
fs_öfo
)) {

338 i‡(!
	`bdev_is_z⁄ed
(
bdev
))

339  
åue
;

341  
fs_öfo
->
z⁄e_size
 ==

342 (
	`bdev_z⁄e_£˘‹s
(
bdev
Ë<< 
SECTOR_SHIFT
);

346  
	`bdev_z⁄ed_modñ
(
bdev
Ë!
BLK_ZONED_HM
;

347 
	}
}

349 
ölöe
 
boﬁ
 
	$båfs_check_su≥r_loˇti⁄
(
båfs_devi˚
 *
devi˚
, 
u64
 
pos
)

355  
devi˚
->
z⁄e_öfo
 =
NULL
 || !
	`båfs_dev_is_£quítül
(devi˚, 
pos
);

356 
	}
}

358 
ölöe
 
boﬁ
 
	$båfs_ˇn_z⁄e_ª£t
(
båfs_devi˚
 *
devi˚
,

359 
u64
 
physiˇl
, u64 
Àngth
)

361 
u64
 
z⁄e_size
;

363 i‡(!
	`båfs_dev_is_£quítül
(
devi˚
, 
physiˇl
))

364  
Ál£
;

366 
z⁄e_size
 = 
devi˚
->
z⁄e_öfo
->zone_size;

367 i‡(!
	`IS_ALIGNED
(
physiˇl
, 
z⁄e_size
Ë|| !IS_ALIGNED(
Àngth
, zone_size))

368  
Ál£
;

370  
åue
;

371 
	}
}

373 
ölöe
 
	$båfs_z⁄ed_mëa_io_lock
(
båfs_fs_öfo
 *
fs_öfo
)

375 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

377 
	`muãx_lock
(&
fs_öfo
->
z⁄ed_mëa_io_lock
);

378 
	}
}

380 
ölöe
 
	$båfs_z⁄ed_mëa_io_u∆ock
(
båfs_fs_öfo
 *
fs_öfo
)

382 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

384 
	`muãx_u∆ock
(&
fs_öfo
->
z⁄ed_mëa_io_lock
);

385 
	}
}

387 
ölöe
 
	$båfs_˛ór_åìlog_bg
(
båfs_block_group
 *
bg
)

389 
båfs_fs_öfo
 *
fs_öfo
 = 
bg
->fs_info;

391 i‡(!
	`båfs_is_z⁄ed
(
fs_öfo
))

394 
	`•ö_lock
(&
fs_öfo
->
åìlog_bg_lock
);

395 i‡(
fs_öfo
->
åìlog_bg
 =
bg
->
°¨t
)

396 
fs_öfo
->
åìlog_bg
 = 0;

397 
	`•ö_u∆ock
(&
fs_öfo
->
åìlog_bg_lock
);

398 
	}
}

400 
ölöe
 
	$båfs_z⁄ed_d©a_ªloc_lock
(
båfs_öode
 *
öode
)

402 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

404 i‡(
	`båfs_is_d©a_ªloc_roŸ
(
roŸ
Ë&& 
	`båfs_is_z⁄ed
‘oŸ->
fs_öfo
))

405 
	`muãx_lock
(&
roŸ
->
fs_öfo
->
z⁄ed_d©a_ªloc_io_lock
);

406 
	}
}

408 
ölöe
 
	$båfs_z⁄ed_d©a_ªloc_u∆ock
(
båfs_öode
 *
öode
)

410 
båfs_roŸ
 *
roŸ
 = 
öode
->root;

412 i‡(
	`båfs_is_d©a_ªloc_roŸ
(
roŸ
Ë&& 
	`båfs_is_z⁄ed
‘oŸ->
fs_öfo
))

413 
	`muãx_u∆ock
(&
roŸ
->
fs_öfo
->
z⁄ed_d©a_ªloc_io_lock
);

414 
	}
}

416 
ölöe
 
boﬁ
 
	$båfs_z⁄ed_bg_is_fuŒ
(c⁄° 
båfs_block_group
 *
bg
)

418 
	`ASSERT
(
	`båfs_is_z⁄ed
(
bg
->
fs_öfo
));

419  (
bg
->
Æloc_off£t
 =bg->
z⁄e_ˇ∑côy
);

420 
	}
}

	@zstd.c

8 
	~<löux/bio.h
>

9 
	~<löux/bôm≠.h
>

10 
	~<löux/îr.h
>

11 
	~<löux/öô.h
>

12 
	~<löux/kî√l.h
>

13 
	~<löux/mm.h
>

14 
	~<löux/sched/mm.h
>

15 
	~<löux/∑gem≠.h
>

16 
	~<löux/ªfcou¡.h
>

17 
	~<löux/sched.h
>

18 
	~<löux/¶ab.h
>

19 
	~<löux/z°d.h
>

20 
	~"misc.h
"

21 
	~"com¥essi⁄.h
"

22 
	~"˘ªe.h
"

24 
	#ZSTD_BTRFS_MAX_WINDOWLOG
 17

	)

25 
	#ZSTD_BTRFS_MAX_INPUT
 (1 << 
ZSTD_BTRFS_MAX_WINDOWLOG
)

	)

26 
	#ZSTD_BTRFS_DEFAULT_LEVEL
 3

	)

27 
	#ZSTD_BTRFS_MAX_LEVEL
 15

	)

29 
	#ZSTD_BTRFS_RECLAIM_JIFFIES
 (307 * 
HZ
)

	)

31 
z°d_∑ømëîs
 
	$z°d_gë_båfs_∑ømëîs
(
Àvñ
,

32 
size_t
 
§c_Àn
)

34 
z°d_∑ømëîs
 
∑øms
 = 
	`z°d_gë_∑øms
(
Àvñ
, 
§c_Àn
);

36 i‡(
∑øms
.
cP¨ams
.
wödowLog
 > 
ZSTD_BTRFS_MAX_WINDOWLOG
)

37 
∑øms
.
cP¨ams
.
wödowLog
 = 
ZSTD_BTRFS_MAX_WINDOWLOG
;

38 
	`WARN_ON
(
§c_Àn
 > 
ZSTD_BTRFS_MAX_INPUT
);

39  
∑øms
;

40 
	}
}

42 
	sw‹k•a˚
 {

43 *
	mmem
;

44 
size_t
 
	msize
;

45 *
	mbuf
;

46 
	mÀvñ
;

47 
	mªq_Àvñ
;

48 
	mœ°_u£d
;

49 
li°_hód
 
	mli°
;

50 
li°_hód
 
	mÃu_li°
;

51 
z°d_ö_buf„r
 
	mö_buf
;

52 
z°d_out_buf„r
 
	mout_buf
;

75 
	sz°d_w‹k•a˚_m™agî
 {

76 c⁄° 
båfs_com¥ess_›
 *
	m›s
;

77 
•ölock_t
 
	mlock
;

78 
li°_hód
 
	mÃu_li°
;

79 
li°_hód
 
	midÀ_ws
[
ZSTD_BTRFS_MAX_LEVEL
];

80 
	ma˘ive_m≠
;

81 
waô_queue_hód_t
 
	mwaô
;

82 
timî_li°
 
	mtimî
;

85 
z°d_w‹k•a˚_m™agî
 
	gwsm
;

87 
size_t
 
	gz°d_ws_mem_sizes
[
ZSTD_BTRFS_MAX_LEVEL
];

89 
ölöe
 
w‹k•a˚
 *
	$li°_to_w‹k•a˚
(
li°_hód
 *
li°
)

91  
	`c⁄èöî_of
(
li°
, 
w‹k•a˚
,Üist);

92 
	}
}

94 
z°d_‰ì_w‹k•a˚
(
li°_hód
 *
ws
);

95 
li°_hód
 *
z°d_Æloc_w‹k•a˚
(
Àvñ
);

107 
	$z°d_ª˛aim_timî_‚
(
timî_li°
 *
timî
)

109 
ª˛aim_thªshﬁd
 = 
jiffõs
 - 
ZSTD_BTRFS_RECLAIM_JIFFIES
;

110 
li°_hód
 *
pos
, *
√xt
;

112 
	`•ö_lock
(&
wsm
.
lock
);

114 i‡(
	`li°_em±y
(&
wsm
.
Ãu_li°
)) {

115 
	`•ö_u∆ock
(&
wsm
.
lock
);

119 
	`li°_f‹_óch_¥ev_ß„
(
pos
, 
√xt
, &
wsm
.
Ãu_li°
) {

120 
w‹k•a˚
 *
vi˘im
 = 
	`c⁄èöî_of
(
pos
, workspace,

121 
Ãu_li°
);

122 
Àvñ
;

124 i‡(
	`time_a·î
(
vi˘im
->
œ°_u£d
, 
ª˛aim_thªshﬁd
))

128 i‡(
vi˘im
->
ªq_Àvñ
)

131 
Àvñ
 = 
vi˘im
->level;

132 
	`li°_dñ
(&
vi˘im
->
Ãu_li°
);

133 
	`li°_dñ
(&
vi˘im
->
li°
);

134 
	`z°d_‰ì_w‹k•a˚
(&
vi˘im
->
li°
);

136 i‡(
	`li°_em±y
(&
wsm
.
idÀ_ws
[
Àvñ
 - 1]))

137 
	`˛ór_bô
(
Àvñ
 - 1, &
wsm
.
a˘ive_m≠
);

141 i‡(!
	`li°_em±y
(&
wsm
.
Ãu_li°
))

142 
	`mod_timî
(&
wsm
.
timî
, 
jiffõs
 + 
ZSTD_BTRFS_RECLAIM_JIFFIES
);

144 
	`•ö_u∆ock
(&
wsm
.
lock
);

145 
	}
}

156 
	$z°d_ˇlc_ws_mem_sizes
()

158 
size_t
 
max_size
 = 0;

159 
Àvñ
;

161 
Àvñ
 = 1;Üevñ <
ZSTD_BTRFS_MAX_LEVEL
;Üevel++) {

162 
z°d_∑ømëîs
 
∑øms
 =

163 
	`z°d_gë_båfs_∑ømëîs
(
Àvñ
, 
ZSTD_BTRFS_MAX_INPUT
);

164 
size_t
 
Àvñ_size
 =

165 
	`max_t
(
size_t
,

166 
	`z°d_c°ªam_w‹k•a˚_bound
(&
∑øms
.
cP¨ams
),

167 
	`z°d_d°ªam_w‹k•a˚_bound
(
ZSTD_BTRFS_MAX_INPUT
));

169 
max_size
 = 
	`max_t
(
size_t
, max_size, 
Àvñ_size
);

170 
z°d_ws_mem_sizes
[
Àvñ
 - 1] = 
max_size
;

172 
	}
}

174 
	$z°d_öô_w‹k•a˚_m™agî
()

176 
li°_hód
 *
ws
;

177 
i
;

179 
	`z°d_ˇlc_ws_mem_sizes
();

181 
wsm
.
›s
 = &
båfs_z°d_com¥ess
;

182 
	`•ö_lock_öô
(&
wsm
.
lock
);

183 
	`öô_waôqueue_hód
(&
wsm
.
waô
);

184 
	`timî_£tup
(&
wsm
.
timî
, 
z°d_ª˛aim_timî_‚
, 0);

186 
	`INIT_LIST_HEAD
(&
wsm
.
Ãu_li°
);

187 
i
 = 0; i < 
ZSTD_BTRFS_MAX_LEVEL
; i++)

188 
	`INIT_LIST_HEAD
(&
wsm
.
idÀ_ws
[
i
]);

190 
ws
 = 
	`z°d_Æloc_w‹k•a˚
(
ZSTD_BTRFS_MAX_LEVEL
);

191 i‡(
	`IS_ERR
(
ws
)) {

192 
	`¥_w¨n
(

195 
	`£t_bô
(
ZSTD_BTRFS_MAX_LEVEL
 - 1, &
wsm
.
a˘ive_m≠
);

196 
	`li°_add
(
ws
, &
wsm
.
idÀ_ws
[
ZSTD_BTRFS_MAX_LEVEL
 - 1]);

198 
	}
}

200 
	$z°d_˛ónup_w‹k•a˚_m™agî
()

202 
w‹k•a˚
 *workspace;

203 
i
;

205 
	`•ö_lock_bh
(&
wsm
.
lock
);

206 
i
 = 0; i < 
ZSTD_BTRFS_MAX_LEVEL
; i++) {

207 !
	`li°_em±y
(&
wsm
.
idÀ_ws
[
i
])) {

208 
w‹k•a˚
 = 
	`c⁄èöî_of
(
wsm
.
idÀ_ws
[
i
].
√xt
,

209 
w‹k•a˚
, 
li°
);

210 
	`li°_dñ
(&
w‹k•a˚
->
li°
);

211 
	`li°_dñ
(&
w‹k•a˚
->
Ãu_li°
);

212 
	`z°d_‰ì_w‹k•a˚
(&
w‹k•a˚
->
li°
);

215 
	`•ö_u∆ock_bh
(&
wsm
.
lock
);

217 
	`dñ_timî_sync
(&
wsm
.
timî
);

218 
	}
}

231 
li°_hód
 *
	$z°d_föd_w‹k•a˚
(
Àvñ
)

233 
li°_hód
 *
ws
;

234 
w‹k•a˚
 *workspace;

235 
i
 = 
Àvñ
 - 1;

237 
	`•ö_lock_bh
(&
wsm
.
lock
);

238 
	`f‹_óch_£t_bô_‰om
(
i
, &
wsm
.
a˘ive_m≠
, 
ZSTD_BTRFS_MAX_LEVEL
) {

239 i‡(!
	`li°_em±y
(&
wsm
.
idÀ_ws
[
i
])) {

240 
ws
 = 
wsm
.
idÀ_ws
[
i
].
√xt
;

241 
w‹k•a˚
 = 
	`li°_to_w‹k•a˚
(
ws
);

242 
	`li°_dñ_öô
(
ws
);

244 
w‹k•a˚
->
ªq_Àvñ
 = 
Àvñ
;

245 i‡(
Àvñ
 =
w‹k•a˚
->level)

246 
	`li°_dñ
(&
w‹k•a˚
->
Ãu_li°
);

247 i‡(
	`li°_em±y
(&
wsm
.
idÀ_ws
[
i
]))

248 
	`˛ór_bô
(
i
, &
wsm
.
a˘ive_m≠
);

249 
	`•ö_u∆ock_bh
(&
wsm
.
lock
);

250  
ws
;

253 
	`•ö_u∆ock_bh
(&
wsm
.
lock
);

255  
NULL
;

256 
	}
}

267 
li°_hód
 *
	$z°d_gë_w‹k•a˚
(
Àvñ
)

269 
li°_hód
 *
ws
;

270 
nofs_Êag
;

273 i‡(!
Àvñ
)

274 
Àvñ
 = 1;

276 
agaö
:

277 
ws
 = 
	`z°d_föd_w‹k•a˚
(
Àvñ
);

278 i‡(
ws
)

279  
ws
;

281 
nofs_Êag
 = 
	`memÆloc_nofs_ßve
();

282 
ws
 = 
	`z°d_Æloc_w‹k•a˚
(
Àvñ
);

283 
	`memÆloc_nofs_ª°‹e
(
nofs_Êag
);

285 i‡(
	`IS_ERR
(
ws
)) {

286 
	`DEFINE_WAIT
(
waô
);

288 
	`¥ï¨e_to_waô
(&
wsm
.
waô
, &waô, 
TASK_UNINTERRUPTIBLE
);

289 
	`scheduÀ
();

290 
	`föish_waô
(&
wsm
.
waô
, &wait);

292 
agaö
;

295  
ws
;

296 
	}
}

308 
	$z°d_put_w‹k•a˚
(
li°_hód
 *
ws
)

310 
w‹k•a˚
 *w‹k•a˚ = 
	`li°_to_w‹k•a˚
(
ws
);

312 
	`•ö_lock_bh
(&
wsm
.
lock
);

315 i‡(
w‹k•a˚
->
ªq_Àvñ
 =w‹k•a˚->
Àvñ
) {

317 i‡(
	`li°_em±y
(&
wsm
.
idÀ_ws
[
ZSTD_BTRFS_MAX_LEVEL
 - 1])) {

318 
	`INIT_LIST_HEAD
(&
w‹k•a˚
->
Ãu_li°
);

320 
w‹k•a˚
->
œ°_u£d
 = 
jiffõs
;

321 
	`li°_add
(&
w‹k•a˚
->
Ãu_li°
, &
wsm
.lru_list);

322 i‡(!
	`timî_≥ndög
(&
wsm
.
timî
))

323 
	`mod_timî
(&
wsm
.
timî
,

324 
jiffõs
 + 
ZSTD_BTRFS_RECLAIM_JIFFIES
);

328 
	`£t_bô
(
w‹k•a˚
->
Àvñ
 - 1, &
wsm
.
a˘ive_m≠
);

329 
	`li°_add
(&
w‹k•a˚
->
li°
, &
wsm
.
idÀ_ws
[w‹k•a˚->
Àvñ
 - 1]);

330 
w‹k•a˚
->
ªq_Àvñ
 = 0;

332 
	`•ö_u∆ock_bh
(&
wsm
.
lock
);

334 i‡(
w‹k•a˚
->
Àvñ
 =
ZSTD_BTRFS_MAX_LEVEL
)

335 
	`c⁄d_wake_up
(&
wsm
.
waô
);

336 
	}
}

338 
	$z°d_‰ì_w‹k•a˚
(
li°_hód
 *
ws
)

340 
w‹k•a˚
 *w‹k•a˚ = 
	`li°_íåy
(
ws
, w‹k•a˚, 
li°
);

342 
	`kv‰ì
(
w‹k•a˚
->
mem
);

343 
	`k‰ì
(
w‹k•a˚
->
buf
);

344 
	`k‰ì
(
w‹k•a˚
);

345 
	}
}

347 
li°_hód
 *
	$z°d_Æloc_w‹k•a˚
(
Àvñ
)

349 
w‹k•a˚
 *workspace;

351 
w‹k•a˚
 = 
	`kzÆloc
((*w‹k•a˚), 
GFP_KERNEL
);

352 i‡(!
w‹k•a˚
)

353  
	`ERR_PTR
(-
ENOMEM
);

355 
w‹k•a˚
->
size
 = 
z°d_ws_mem_sizes
[
Àvñ
 - 1];

356 
w‹k•a˚
->
Àvñ
 =Üevel;

357 
w‹k•a˚
->
ªq_Àvñ
 = 
Àvñ
;

358 
w‹k•a˚
->
œ°_u£d
 = 
jiffõs
;

359 
w‹k•a˚
->
mem
 = 
	`kvmÆloc
(w‹k•a˚->
size
, 
GFP_KERNEL
 | 
__GFP_NOWARN
);

360 
w‹k•a˚
->
buf
 = 
	`kmÆloc
(
PAGE_SIZE
, 
GFP_KERNEL
);

361 i‡(!
w‹k•a˚
->
mem
 || !w‹k•a˚->
buf
)

362 
Áû
;

364 
	`INIT_LIST_HEAD
(&
w‹k•a˚
->
li°
);

365 
	`INIT_LIST_HEAD
(&
w‹k•a˚
->
Ãu_li°
);

367  &
w‹k•a˚
->
li°
;

368 
Áû
:

369 
	`z°d_‰ì_w‹k•a˚
(&
w‹k•a˚
->
li°
);

370  
	`ERR_PTR
(-
ENOMEM
);

371 
	}
}

373 
	$z°d_com¥ess_∑ges
(
li°_hód
 *
ws
, 
addªss_•a˚
 *
m≠pög
,

374 
u64
 
°¨t
, 
∑ge
 **
∑ges
, *
out_∑ges
,

375 *
tŸÆ_ö
, *
tŸÆ_out
)

377 
w‹k•a˚
 *w‹k•a˚ = 
	`li°_íåy
(
ws
, w‹k•a˚, 
li°
);

378 
z°d_c°ªam
 *
°ªam
;

379 
ªt
 = 0;

380 
ƒ_∑ges
 = 0;

381 
∑ge
 *
ö_∑ge
 = 
NULL
;

382 
∑ge
 *
out_∑ge
 = 
NULL
;

383 
tŸ_ö
 = 0;

384 
tŸ_out
 = 0;

385 
Àn
 = *
tŸÆ_out
;

386 c⁄° 
ƒ_de°_∑ges
 = *
out_∑ges
;

387 
max_out
 = 
ƒ_de°_∑ges
 * 
PAGE_SIZE
;

388 
z°d_∑ømëîs
 
∑øms
 = 
	`z°d_gë_båfs_∑ømëîs
(
w‹k•a˚
->
ªq_Àvñ
,

389 
Àn
);

391 *
out_∑ges
 = 0;

392 *
tŸÆ_out
 = 0;

393 *
tŸÆ_ö
 = 0;

396 
°ªam
 = 
	`z°d_öô_c°ªam
(&
∑øms
, 
Àn
, 
w‹k•a˚
->
mem
,

397 
w‹k•a˚
->
size
);

398 i‡(!
°ªam
) {

399 
	`¥_w¨n
("BTRFS: zstd_init_cstream failed\n");

400 
ªt
 = -
EIO
;

401 
out
;

405 
ö_∑ge
 = 
	`föd_gë_∑ge
(
m≠pög
, 
°¨t
 >> 
PAGE_SHIFT
);

406 
w‹k•a˚
->
ö_buf
.
§c
 = 
	`km≠_loˇl_∑ge
(
ö_∑ge
);

407 
w‹k•a˚
->
ö_buf
.
pos
 = 0;

408 
w‹k•a˚
->
ö_buf
.
size
 = 
	`mö_t
(
size_t
, 
Àn
, 
PAGE_SIZE
);

412 
out_∑ge
 = 
	`Æloc_∑ge
(
GFP_NOFS
);

413 i‡(
out_∑ge
 =
NULL
) {

414 
ªt
 = -
ENOMEM
;

415 
out
;

417 
∑ges
[
ƒ_∑ges
++] = 
out_∑ge
;

418 
w‹k•a˚
->
out_buf
.
d°
 = 
	`∑ge_addªss
(
out_∑ge
);

419 
w‹k•a˚
->
out_buf
.
pos
 = 0;

420 
w‹k•a˚
->
out_buf
.
size
 = 
	`mö_t
(
size_t
, 
max_out
, 
PAGE_SIZE
);

423 
size_t
 
ªt2
;

425 
ªt2
 = 
	`z°d_com¥ess_°ªam
(
°ªam
, &
w‹k•a˚
->
out_buf
,

426 &
w‹k•a˚
->
ö_buf
);

427 i‡(
	`z°d_is_îr‹
(
ªt2
)) {

428 
	`¥_debug
("BTRFS: zstd_compress_streamÑeturned %d\n",

429 
	`z°d_gë_îr‹_code
(
ªt2
));

430 
ªt
 = -
EIO
;

431 
out
;

435 i‡(
tŸ_ö
 + 
w‹k•a˚
->
ö_buf
.
pos
 > 8192 &&

436 
tŸ_ö
 + 
w‹k•a˚
->
ö_buf
.
pos
 <

437 
tŸ_out
 + 
w‹k•a˚
->
out_buf
.
pos
) {

438 
ªt
 = -
E2BIG
;

439 
out
;

443 i‡(
w‹k•a˚
->
out_buf
.
pos
 >
max_out
) {

444 
tŸ_out
 +
w‹k•a˚
->
out_buf
.
pos
;

445 
ªt
 = -
E2BIG
;

446 
out
;

450 i‡(
w‹k•a˚
->
out_buf
.
pos
 =w‹k•a˚->out_buf.
size
) {

451 
tŸ_out
 +
PAGE_SIZE
;

452 
max_out
 -
PAGE_SIZE
;

453 i‡(
ƒ_∑ges
 =
ƒ_de°_∑ges
) {

454 
ªt
 = -
E2BIG
;

455 
out
;

457 
out_∑ge
 = 
	`Æloc_∑ge
(
GFP_NOFS
);

458 i‡(
out_∑ge
 =
NULL
) {

459 
ªt
 = -
ENOMEM
;

460 
out
;

462 
∑ges
[
ƒ_∑ges
++] = 
out_∑ge
;

463 
w‹k•a˚
->
out_buf
.
d°
 = 
	`∑ge_addªss
(
out_∑ge
);

464 
w‹k•a˚
->
out_buf
.
pos
 = 0;

465 
w‹k•a˚
->
out_buf
.
size
 = 
	`mö_t
(
size_t
, 
max_out
,

466 
PAGE_SIZE
);

470 i‡(
w‹k•a˚
->
ö_buf
.
pos
 >
Àn
) {

471 
tŸ_ö
 +
w‹k•a˚
->
ö_buf
.
pos
;

476 i‡(
w‹k•a˚
->
ö_buf
.
pos
 =w‹k•a˚->ö_buf.
size
) {

477 
tŸ_ö
 +
PAGE_SIZE
;

478 
	`kunm≠_loˇl
(
w‹k•a˚
->
ö_buf
.
§c
);

479 
	`put_∑ge
(
ö_∑ge
);

480 
°¨t
 +
PAGE_SIZE
;

481 
Àn
 -
PAGE_SIZE
;

482 
ö_∑ge
 = 
	`föd_gë_∑ge
(
m≠pög
, 
°¨t
 >> 
PAGE_SHIFT
);

483 
w‹k•a˚
->
ö_buf
.
§c
 = 
	`km≠_loˇl_∑ge
(
ö_∑ge
);

484 
w‹k•a˚
->
ö_buf
.
pos
 = 0;

485 
w‹k•a˚
->
ö_buf
.
size
 = 
	`mö_t
(
size_t
, 
Àn
, 
PAGE_SIZE
);

489 
size_t
 
ªt2
;

491 
ªt2
 = 
	`z°d_íd_°ªam
(
°ªam
, &
w‹k•a˚
->
out_buf
);

492 i‡(
	`z°d_is_îr‹
(
ªt2
)) {

493 
	`¥_debug
("BTRFS: zstd_end_streamÑeturned %d\n",

494 
	`z°d_gë_îr‹_code
(
ªt2
));

495 
ªt
 = -
EIO
;

496 
out
;

498 i‡(
ªt2
 == 0) {

499 
tŸ_out
 +
w‹k•a˚
->
out_buf
.
pos
;

502 i‡(
w‹k•a˚
->
out_buf
.
pos
 >
max_out
) {

503 
tŸ_out
 +
w‹k•a˚
->
out_buf
.
pos
;

504 
ªt
 = -
E2BIG
;

505 
out
;

508 
tŸ_out
 +
PAGE_SIZE
;

509 
max_out
 -
PAGE_SIZE
;

510 i‡(
ƒ_∑ges
 =
ƒ_de°_∑ges
) {

511 
ªt
 = -
E2BIG
;

512 
out
;

514 
out_∑ge
 = 
	`Æloc_∑ge
(
GFP_NOFS
);

515 i‡(
out_∑ge
 =
NULL
) {

516 
ªt
 = -
ENOMEM
;

517 
out
;

519 
∑ges
[
ƒ_∑ges
++] = 
out_∑ge
;

520 
w‹k•a˚
->
out_buf
.
d°
 = 
	`∑ge_addªss
(
out_∑ge
);

521 
w‹k•a˚
->
out_buf
.
pos
 = 0;

522 
w‹k•a˚
->
out_buf
.
size
 = 
	`mö_t
(
size_t
, 
max_out
, 
PAGE_SIZE
);

525 i‡(
tŸ_out
 >
tŸ_ö
) {

526 
ªt
 = -
E2BIG
;

527 
out
;

530 
ªt
 = 0;

531 *
tŸÆ_ö
 = 
tŸ_ö
;

532 *
tŸÆ_out
 = 
tŸ_out
;

533 
out
:

534 *
out_∑ges
 = 
ƒ_∑ges
;

535 i‡(
w‹k•a˚
->
ö_buf
.
§c
) {

536 
	`kunm≠_loˇl
(
w‹k•a˚
->
ö_buf
.
§c
);

537 
	`put_∑ge
(
ö_∑ge
);

539  
ªt
;

540 
	}
}

542 
	$z°d_decom¥ess_bio
(
li°_hód
 *
ws
, 
com¥es£d_bio
 *
cb
)

544 
w‹k•a˚
 *w‹k•a˚ = 
	`li°_íåy
(
ws
, w‹k•a˚, 
li°
);

545 
∑ge
 **
∑ges_ö
 = 
cb
->
com¥es£d_∑ges
;

546 
size_t
 
§˛í
 = 
cb
->
com¥es£d_Àn
;

547 
z°d_d°ªam
 *
°ªam
;

548 
ªt
 = 0;

549 
∑ge_ö_ödex
 = 0;

550 
tŸÆ_∑ges_ö
 = 
	`DIV_ROUND_UP
(
§˛í
, 
PAGE_SIZE
);

551 
buf_°¨t
;

552 
tŸÆ_out
 = 0;

554 
°ªam
 = 
	`z°d_öô_d°ªam
(

555 
ZSTD_BTRFS_MAX_INPUT
, 
w‹k•a˚
->
mem
, w‹k•a˚->
size
);

556 i‡(!
°ªam
) {

557 
	`¥_debug
("BTRFS: zstd_init_dstream failed\n");

558 
ªt
 = -
EIO
;

559 
d⁄e
;

562 
w‹k•a˚
->
ö_buf
.
§c
 = 
	`km≠_loˇl_∑ge
(
∑ges_ö
[
∑ge_ö_ödex
]);

563 
w‹k•a˚
->
ö_buf
.
pos
 = 0;

564 
w‹k•a˚
->
ö_buf
.
size
 = 
	`mö_t
(
size_t
, 
§˛í
, 
PAGE_SIZE
);

566 
w‹k•a˚
->
out_buf
.
d°
 = w‹k•a˚->
buf
;

567 
w‹k•a˚
->
out_buf
.
pos
 = 0;

568 
w‹k•a˚
->
out_buf
.
size
 = 
PAGE_SIZE
;

571 
size_t
 
ªt2
;

573 
ªt2
 = 
	`z°d_decom¥ess_°ªam
(
°ªam
, &
w‹k•a˚
->
out_buf
,

574 &
w‹k•a˚
->
ö_buf
);

575 i‡(
	`z°d_is_îr‹
(
ªt2
)) {

576 
	`¥_debug
("BTRFS: zstd_decompress_streamÑeturned %d\n",

577 
	`z°d_gë_îr‹_code
(
ªt2
));

578 
ªt
 = -
EIO
;

579 
d⁄e
;

581 
buf_°¨t
 = 
tŸÆ_out
;

582 
tŸÆ_out
 +
w‹k•a˚
->
out_buf
.
pos
;

583 
w‹k•a˚
->
out_buf
.
pos
 = 0;

585 
ªt
 = 
	`båfs_decom¥ess_buf2∑ge
(
w‹k•a˚
->
out_buf
.
d°
,

586 
tŸÆ_out
 - 
buf_°¨t
, 
cb
, buf_start);

587 i‡(
ªt
 == 0)

590 i‡(
w‹k•a˚
->
ö_buf
.
pos
 >
§˛í
)

594 i‡(
ªt2
 == 0)

597 i‡(
w‹k•a˚
->
ö_buf
.
pos
 =w‹k•a˚->ö_buf.
size
) {

598 
	`kunm≠_loˇl
(
w‹k•a˚
->
ö_buf
.
§c
);

599 
∑ge_ö_ödex
++;

600 i‡(
∑ge_ö_ödex
 >
tŸÆ_∑ges_ö
) {

601 
w‹k•a˚
->
ö_buf
.
§c
 = 
NULL
;

602 
ªt
 = -
EIO
;

603 
d⁄e
;

605 
§˛í
 -
PAGE_SIZE
;

606 
w‹k•a˚
->
ö_buf
.
§c
 = 
	`km≠_loˇl_∑ge
(
∑ges_ö
[
∑ge_ö_ödex
]);

607 
w‹k•a˚
->
ö_buf
.
pos
 = 0;

608 
w‹k•a˚
->
ö_buf
.
size
 = 
	`mö_t
(
size_t
, 
§˛í
, 
PAGE_SIZE
);

611 
ªt
 = 0;

612 
d⁄e
:

613 i‡(
w‹k•a˚
->
ö_buf
.
§c
)

614 
	`kunm≠_loˇl
(
w‹k•a˚
->
ö_buf
.
§c
);

615  
ªt
;

616 
	}
}

618 
	$z°d_decom¥ess
(
li°_hód
 *
ws
, c⁄° 
u8
 *
d©a_ö
,

619 
∑ge
 *
de°_∑ge
, 
°¨t_byã
, 
size_t
 
§˛í
,

620 
size_t
 
de°Àn
)

622 
w‹k•a˚
 *w‹k•a˚ = 
	`li°_íåy
(
ws
, w‹k•a˚, 
li°
);

623 
z°d_d°ªam
 *
°ªam
;

624 
ªt
 = 0;

625 
size_t
 
ªt2
;

626 
tŸÆ_out
 = 0;

627 
pg_off£t
 = 0;

629 
°ªam
 = 
	`z°d_öô_d°ªam
(

630 
ZSTD_BTRFS_MAX_INPUT
, 
w‹k•a˚
->
mem
, w‹k•a˚->
size
);

631 i‡(!
°ªam
) {

632 
	`¥_w¨n
("BTRFS: zstd_init_dstream failed\n");

633 
ªt
 = -
EIO
;

634 
föish
;

637 
de°Àn
 = 
	`mö_t
(
size_t
, de°Àn, 
PAGE_SIZE
);

639 
w‹k•a˚
->
ö_buf
.
§c
 = 
d©a_ö
;

640 
w‹k•a˚
->
ö_buf
.
pos
 = 0;

641 
w‹k•a˚
->
ö_buf
.
size
 = 
§˛í
;

643 
w‹k•a˚
->
out_buf
.
d°
 = w‹k•a˚->
buf
;

644 
w‹k•a˚
->
out_buf
.
pos
 = 0;

645 
w‹k•a˚
->
out_buf
.
size
 = 
PAGE_SIZE
;

647 
ªt2
 = 1;

648 
pg_off£t
 < 
de°Àn


649 && 
w‹k•a˚
->
ö_buf
.
pos
 < w‹k•a˚->ö_buf.
size
) {

650 
buf_°¨t
;

651 
buf_off£t
;

652 
byãs
;

655 i‡(
ªt2
 == 0) {

656 
	`¥_debug
("BTRFS: zstd_decompress_streamÉndedÉarly\n");

657 
ªt
 = -
EIO
;

658 
föish
;

660 
ªt2
 = 
	`z°d_decom¥ess_°ªam
(
°ªam
, &
w‹k•a˚
->
out_buf
,

661 &
w‹k•a˚
->
ö_buf
);

662 i‡(
	`z°d_is_îr‹
(
ªt2
)) {

663 
	`¥_debug
("BTRFS: zstd_decompress_streamÑeturned %d\n",

664 
	`z°d_gë_îr‹_code
(
ªt2
));

665 
ªt
 = -
EIO
;

666 
föish
;

669 
buf_°¨t
 = 
tŸÆ_out
;

670 
tŸÆ_out
 +
w‹k•a˚
->
out_buf
.
pos
;

671 
w‹k•a˚
->
out_buf
.
pos
 = 0;

673 i‡(
tŸÆ_out
 <
°¨t_byã
)

676 i‡(
tŸÆ_out
 > 
°¨t_byã
 && 
buf_°¨t
 < start_byte)

677 
buf_off£t
 = 
°¨t_byã
 - 
buf_°¨t
;

679 
buf_off£t
 = 0;

681 
byãs
 = 
	`mö_t
(, 
de°Àn
 - 
pg_off£t
,

682 
w‹k•a˚
->
out_buf
.
size
 - 
buf_off£t
);

684 
	`mem˝y_to_∑ge
(
de°_∑ge
, 
pg_off£t
,

685 
w‹k•a˚
->
out_buf
.
d°
 + 
buf_off£t
, 
byãs
);

687 
pg_off£t
 +
byãs
;

689 
ªt
 = 0;

690 
föish
:

691 i‡(
pg_off£t
 < 
de°Àn
) {

692 
	`memzîo_∑ge
(
de°_∑ge
, 
pg_off£t
, 
de°Àn
 -Ög_offset);

694  
ªt
;

695 
	}
}

697 c⁄° 
båfs_com¥ess_›
 
	gbåfs_z°d_com¥ess
 = {

699 .
w‹k•a˚_m™agî
 = 
NULL
,

700 .
	gmax_Àvñ
 = 
ZSTD_BTRFS_MAX_LEVEL
,

701 .
	gdeÁu…_Àvñ
 = 
ZSTD_BTRFS_DEFAULT_LEVEL
,

	@/usr/include/linux/btrfs.h

20 #i‚de‡
_LINUX_BTRFS_H


21 
	#_LINUX_BTRFS_H


	)

22 
	~<löux/ty≥s.h
>

23 
	~<löux/io˘l.h
>

25 
	#BTRFS_IOCTL_MAGIC
 0x94

	)

26 
	#BTRFS_VOL_NAME_MAX
 255

	)

27 
	#BTRFS_LABEL_SIZE
 256

	)

30 
	#BTRFS_PATH_NAME_MAX
 4087

	)

31 
	sbåfs_io˘l_vﬁ_¨gs
 {

32 
__s64
 
	mfd
;

33 
	m«me
[
BTRFS_PATH_NAME_MAX
 + 1];

36 
	#BTRFS_DEVICE_PATH_NAME_MAX
 1024

	)

37 
	#BTRFS_SUBVOL_NAME_MAX
 4039

	)

40 
	#BTRFS_SUBVOL_CREATE_ASYNC
 (1ULL << 0)

	)

41 
	#BTRFS_SUBVOL_RDONLY
 (1ULL << 1)

	)

42 
	#BTRFS_SUBVOL_QGROUP_INHERIT
 (1ULL << 2)

	)

44 
	#BTRFS_DEVICE_SPEC_BY_ID
 (1ULL << 3)

	)

46 
	#BTRFS_SUBVOL_SPEC_BY_ID
 (1ULL << 4)

	)

48 
	#BTRFS_VOL_ARG_V2_FLAGS_SUPPORTED
 \

49 (
BTRFS_SUBVOL_RDONLY
 | \

50 
BTRFS_SUBVOL_QGROUP_INHERIT
 | \

51 
BTRFS_DEVICE_SPEC_BY_ID
 | \

52 
BTRFS_SUBVOL_SPEC_BY_ID
)

	)

54 
	#BTRFS_FSID_SIZE
 16

	)

55 
	#BTRFS_UUID_SIZE
 16

	)

56 
	#BTRFS_UUID_UNPARSED_SIZE
 37

	)

65 
	#BTRFS_QGROUP_LIMIT_MAX_RFER
 (1ULL << 0)

	)

66 
	#BTRFS_QGROUP_LIMIT_MAX_EXCL
 (1ULL << 1)

	)

67 
	#BTRFS_QGROUP_LIMIT_RSV_RFER
 (1ULL << 2)

	)

68 
	#BTRFS_QGROUP_LIMIT_RSV_EXCL
 (1ULL << 3)

	)

69 
	#BTRFS_QGROUP_LIMIT_RFER_CMPR
 (1ULL << 4)

	)

70 
	#BTRFS_QGROUP_LIMIT_EXCL_CMPR
 (1ULL << 5)

	)

72 
	sbåfs_qgroup_limô
 {

73 
__u64
 
	mÊags
;

74 
__u64
 
	mmax_r„r
;

75 
__u64
 
	mmax_ex˛
;

76 
__u64
 
	mrsv_r„r
;

77 
__u64
 
	mrsv_ex˛
;

86 
	#BTRFS_QGROUP_INHERIT_SET_LIMITS
 (1ULL << 0)

	)

88 
	sbåfs_qgroup_öhîô
 {

89 
__u64
 
	mÊags
;

90 
__u64
 
	mnum_qgroups
;

91 
__u64
 
	mnum_ªf_c›õs
;

92 
__u64
 
	mnum_ex˛_c›õs
;

93 
båfs_qgroup_limô
 
	mlim
;

94 
__u64
 
	mqgroups
[0];

97 
	sbåfs_io˘l_qgroup_limô_¨gs
 {

98 
__u64
 
	mqgroupid
;

99 
båfs_qgroup_limô
 
	mlim
;

114 
	#BTRFS_DEVICE_REMOVE_ARGS_MASK
 \

115 (
BTRFS_DEVICE_SPEC_BY_ID
)

	)

118 
	#BTRFS_SUBVOL_CREATE_ARGS_MASK
 \

119 (
BTRFS_SUBVOL_RDONLY
 | \

120 
BTRFS_SUBVOL_QGROUP_INHERIT
)

	)

123 
	#BTRFS_SUBVOL_DELETE_ARGS_MASK
 \

124 (
BTRFS_SUBVOL_SPEC_BY_ID
)

	)

126 
	sbåfs_io˘l_vﬁ_¨gs_v2
 {

127 
__s64
 
	mfd
;

128 
__u64
 
	må™sid
;

129 
__u64
 
	mÊags
;

132 
__u64
 
	msize
;

133 
båfs_qgroup_öhîô
 *
	mqgroup_öhîô
;

135 
__u64
 
	munu£d
[4];

138 
	m«me
[
BTRFS_SUBVOL_NAME_MAX
 + 1];

139 
__u64
 
	mdevid
;

140 
__u64
 
	msubvﬁid
;

148 
	sbåfs_s¸ub_¥ogªss
 {

149 
__u64
 
	md©a_exã¡s_s¸ubbed
;

150 
__u64
 
	måì_exã¡s_s¸ubbed
;

151 
__u64
 
	md©a_byãs_s¸ubbed
;

152 
__u64
 
	måì_byãs_s¸ubbed
;

153 
__u64
 
	mªad_îr‹s
;

154 
__u64
 
	mcsum_îr‹s
;

155 
__u64
 
	mvîify_îr‹s
;

159 
__u64
 
	mno_csum
;

162 
__u64
 
	mcsum_disˇrds
;

164 
__u64
 
	msu≥r_îr‹s
;

165 
__u64
 
	mmÆloc_îr‹s
;

168 
__u64
 
	munc‹ª˘abÀ_îr‹s
;

171 
__u64
 
	mc‹ª˘ed_îr‹s
;

172 
__u64
 
	mœ°_physiˇl
;

175 
__u64
 
	munvîifõd_îr‹s
;

181 
	#BTRFS_SCRUB_READONLY
 1

	)

182 
	#BTRFS_SCRUB_SUPPORTED_FLAGS
 (
BTRFS_SCRUB_READONLY
)

	)

183 
	sbåfs_io˘l_s¸ub_¨gs
 {

184 
__u64
 
	mdevid
;

185 
__u64
 
	m°¨t
;

186 
__u64
 
	míd
;

187 
__u64
 
	mÊags
;

188 
båfs_s¸ub_¥ogªss
 
	m¥ogªss
;

190 
__u64
 
	munu£d
[(1024-32-(
båfs_s¸ub_¥ogªss
))/8];

193 
	#BTRFS_IOCTL_DEV_REPLACE_CONT_READING_FROM_SRCDEV_MODE_ALWAYS
 0

	)

194 
	#BTRFS_IOCTL_DEV_REPLACE_CONT_READING_FROM_SRCDEV_MODE_AVOID
 1

	)

195 
	sbåfs_io˘l_dev_ª∂a˚_°¨t_∑øms
 {

196 
__u64
 
	m§cdevid
;

197 
__u64
 
	mc⁄t_ªadög_‰om_§cdev_mode
;

199 
__u8
 
	m§cdev_«me
[
BTRFS_DEVICE_PATH_NAME_MAX
 + 1];

200 
__u8
 
	mtgtdev_«me
[
BTRFS_DEVICE_PATH_NAME_MAX
 + 1];

203 
	#BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
 0

	)

204 
	#BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
 1

	)

205 
	#BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
 2

	)

206 
	#BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
 3

	)

207 
	#BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
 4

	)

208 
	sbåfs_io˘l_dev_ª∂a˚_°©us_∑øms
 {

209 
__u64
 
	mª∂a˚_°©e
;

210 
__u64
 
	m¥ogªss_1000
;

211 
__u64
 
	mtime_°¨ãd
;

212 
__u64
 
	mtime_°›≥d
;

213 
__u64
 
	mnum_wrôe_îr‹s
;

214 
__u64
 
	mnum_unc‹ª˘abÀ_ªad_îr‹s
;

217 
	#BTRFS_IOCTL_DEV_REPLACE_CMD_START
 0

	)

218 
	#BTRFS_IOCTL_DEV_REPLACE_CMD_STATUS
 1

	)

219 
	#BTRFS_IOCTL_DEV_REPLACE_CMD_CANCEL
 2

	)

220 
	#BTRFS_IOCTL_DEV_REPLACE_RESULT_NO_ERROR
 0

	)

221 
	#BTRFS_IOCTL_DEV_REPLACE_RESULT_NOT_STARTED
 1

	)

222 
	#BTRFS_IOCTL_DEV_REPLACE_RESULT_ALREADY_STARTED
 2

	)

223 
	#BTRFS_IOCTL_DEV_REPLACE_RESULT_SCRUB_INPROGRESS
 3

	)

224 
	sbåfs_io˘l_dev_ª∂a˚_¨gs
 {

225 
__u64
 
	mcmd
;

226 
__u64
 
	mªsu…
;

229 
båfs_io˘l_dev_ª∂a˚_°¨t_∑øms
 
	m°¨t
;

230 
båfs_io˘l_dev_ª∂a˚_°©us_∑øms
 
	m°©us
;

233 
__u64
 
	m•¨e
[64];

236 
	sbåfs_io˘l_dev_öfo_¨gs
 {

237 
__u64
 
	mdevid
;

238 
__u8
 
	muuid
[
BTRFS_UUID_SIZE
];

239 
__u64
 
	mbyãs_u£d
;

240 
__u64
 
	mtŸÆ_byãs
;

241 
__u64
 
	munu£d
[379];

242 
__u8
 
	m∑th
[
BTRFS_DEVICE_PATH_NAME_MAX
];

250 
	#BTRFS_FS_INFO_FLAG_CSUM_INFO
 (1 << 0)

	)

253 
	#BTRFS_FS_INFO_FLAG_GENERATION
 (1 << 1)

	)

255 
	#BTRFS_FS_INFO_FLAG_METADATA_UUID
 (1 << 2)

	)

257 
	sbåfs_io˘l_fs_öfo_¨gs
 {

258 
__u64
 
	mmax_id
;

259 
__u64
 
	mnum_devi˚s
;

260 
__u8
 
	mfsid
[
BTRFS_FSID_SIZE
];

261 
__u32
 
	mnodesize
;

262 
__u32
 
	m£˘‹size
;

263 
__u32
 
	m˛⁄e_Æignmít
;

265 
__u16
 
	mcsum_ty≥
;

266 
__u16
 
	mcsum_size
;

267 
__u64
 
	mÊags
;

268 
__u64
 
	mgíî©i⁄
;

269 
__u8
 
	mmëad©a_uuid
[
BTRFS_FSID_SIZE
];

270 
__u8
 
	mª£rved
[944];

279 
	#BTRFS_FEATURE_COMPAT_RO_FREE_SPACE_TREE
 (1ULL << 0)

	)

289 
	#BTRFS_FEATURE_COMPAT_RO_FREE_SPACE_TREE_VALID
 (1ULL << 1)

	)

290 
	#BTRFS_FEATURE_COMPAT_RO_VERITY
 (1ULL << 2)

	)

292 
	#BTRFS_FEATURE_INCOMPAT_MIXED_BACKREF
 (1ULL << 0)

	)

293 
	#BTRFS_FEATURE_INCOMPAT_DEFAULT_SUBVOL
 (1ULL << 1)

	)

294 
	#BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
 (1ULL << 2)

	)

295 
	#BTRFS_FEATURE_INCOMPAT_COMPRESS_LZO
 (1ULL << 3)

	)

296 
	#BTRFS_FEATURE_INCOMPAT_COMPRESS_ZSTD
 (1ULL << 4)

	)

302 
	#BTRFS_FEATURE_INCOMPAT_BIG_METADATA
 (1ULL << 5)

	)

304 
	#BTRFS_FEATURE_INCOMPAT_EXTENDED_IREF
 (1ULL << 6)

	)

305 
	#BTRFS_FEATURE_INCOMPAT_RAID56
 (1ULL << 7)

	)

306 
	#BTRFS_FEATURE_INCOMPAT_SKINNY_METADATA
 (1ULL << 8)

	)

307 
	#BTRFS_FEATURE_INCOMPAT_NO_HOLES
 (1ULL << 9)

	)

308 
	#BTRFS_FEATURE_INCOMPAT_METADATA_UUID
 (1ULL << 10)

	)

309 
	#BTRFS_FEATURE_INCOMPAT_RAID1C34
 (1ULL << 11)

	)

310 
	#BTRFS_FEATURE_INCOMPAT_ZONED
 (1ULL << 12)

	)

311 
	#BTRFS_FEATURE_INCOMPAT_EXTENT_TREE_V2
 (1ULL << 13)

	)

313 
	sbåfs_io˘l_„©uª_Êags
 {

314 
__u64
 
	mcom∑t_Êags
;

315 
__u64
 
	mcom∑t_ro_Êags
;

316 
__u64
 
	möcom∑t_Êags
;

320 
	#BTRFS_BALANCE_CTL_PAUSE
 1

	)

321 
	#BTRFS_BALANCE_CTL_CANCEL
 2

	)

327 
	sbåfs_bÆ™˚_¨gs
 {

328 
__u64
 
	m¥ofûes
;

330 
__u64
 
	mußge
;

332 
__u32
 
	mußge_mö
;

333 
__u32
 
	mußge_max
;

336 
__u64
 
	mdevid
;

337 
__u64
 
	mp°¨t
;

338 
__u64
 
	m≥nd
;

339 
__u64
 
	mv°¨t
;

340 
__u64
 
	mvíd
;

342 
__u64
 
	mèrgë
;

344 
__u64
 
	mÊags
;

352 
__u64
 
	mlimô
;

354 
__u32
 
	mlimô_mö
;

355 
__u32
 
	mlimô_max
;

363 
__u32
 
	m°rùes_mö
;

364 
__u32
 
	m°rùes_max
;

366 
__u64
 
	munu£d
[6];

367 } 
__©åibuã__
 ((
__∑cked__
));

370 
	sbåfs_bÆ™˚_¥ogªss
 {

371 
__u64
 
	mex≥˘ed
;

373 
__u64
 
	mc⁄sidîed
;

374 
__u64
 
	mcom∂ëed
;

386 
	#BTRFS_BALANCE_DATA
 (1ULL << 0)

	)

387 
	#BTRFS_BALANCE_SYSTEM
 (1ULL << 1)

	)

388 
	#BTRFS_BALANCE_METADATA
 (1ULL << 2)

	)

390 
	#BTRFS_BALANCE_TYPE_MASK
 (
BTRFS_BALANCE_DATA
 | \

391 
BTRFS_BALANCE_SYSTEM
 | \

392 
BTRFS_BALANCE_METADATA
)

	)

394 
	#BTRFS_BALANCE_FORCE
 (1ULL << 3)

	)

395 
	#BTRFS_BALANCE_RESUME
 (1ULL << 4)

	)

405 
	#BTRFS_BALANCE_ARGS_PROFILES
 (1ULL << 0)

	)

406 
	#BTRFS_BALANCE_ARGS_USAGE
 (1ULL << 1)

	)

407 
	#BTRFS_BALANCE_ARGS_DEVID
 (1ULL << 2)

	)

408 
	#BTRFS_BALANCE_ARGS_DRANGE
 (1ULL << 3)

	)

409 
	#BTRFS_BALANCE_ARGS_VRANGE
 (1ULL << 4)

	)

410 
	#BTRFS_BALANCE_ARGS_LIMIT
 (1ULL << 5)

	)

411 
	#BTRFS_BALANCE_ARGS_LIMIT_RANGE
 (1ULL << 6)

	)

412 
	#BTRFS_BALANCE_ARGS_STRIPES_RANGE
 (1ULL << 7)

	)

413 
	#BTRFS_BALANCE_ARGS_USAGE_RANGE
 (1ULL << 10)

	)

415 
	#BTRFS_BALANCE_ARGS_MASK
 \

416 (
BTRFS_BALANCE_ARGS_PROFILES
 | \

417 
BTRFS_BALANCE_ARGS_USAGE
 | \

418 
BTRFS_BALANCE_ARGS_DEVID
 | \

419 
BTRFS_BALANCE_ARGS_DRANGE
 | \

420 
BTRFS_BALANCE_ARGS_VRANGE
 | \

421 
BTRFS_BALANCE_ARGS_LIMIT
 | \

422 
BTRFS_BALANCE_ARGS_LIMIT_RANGE
 | \

423 
BTRFS_BALANCE_ARGS_STRIPES_RANGE
 | \

424 
BTRFS_BALANCE_ARGS_USAGE_RANGE
)

	)

431 
	#BTRFS_BALANCE_ARGS_CONVERT
 (1ULL << 8)

	)

432 
	#BTRFS_BALANCE_ARGS_SOFT
 (1ULL << 9)

	)

441 
	#BTRFS_BALANCE_STATE_RUNNING
 (1ULL << 0)

	)

442 
	#BTRFS_BALANCE_STATE_PAUSE_REQ
 (1ULL << 1)

	)

443 
	#BTRFS_BALANCE_STATE_CANCEL_REQ
 (1ULL << 2)

	)

445 
	sbåfs_io˘l_bÆ™˚_¨gs
 {

446 
__u64
 
	mÊags
;

447 
__u64
 
	m°©e
;

449 
båfs_bÆ™˚_¨gs
 
	md©a
;

450 
båfs_bÆ™˚_¨gs
 
	mmëa
;

451 
båfs_bÆ™˚_¨gs
 
	msys
;

453 
båfs_bÆ™˚_¥ogªss
 
	m°©
;

455 
__u64
 
	munu£d
[72];

458 
	#BTRFS_INO_LOOKUP_PATH_MAX
 4080

	)

459 
	sbåfs_io˘l_öo_lookup_¨gs
 {

460 
__u64
 
	måìid
;

461 
__u64
 
	mobje˘id
;

462 
	m«me
[
BTRFS_INO_LOOKUP_PATH_MAX
];

465 
	#BTRFS_INO_LOOKUP_USER_PATH_MAX
 (4080 - 
BTRFS_VOL_NAME_MAX
 - 1)

	)

466 
	sbåfs_io˘l_öo_lookup_u£r_¨gs
 {

468 
__u64
 
	mdúid
;

470 
__u64
 
	måìid
;

472 
	m«me
[
BTRFS_VOL_NAME_MAX
 + 1];

477 
	m∑th
[
BTRFS_INO_LOOKUP_USER_PATH_MAX
];

481 
	sbåfs_io˘l_£¨ch_key
 {

489 
__u64
 
	måì_id
;

511 
__u64
 
	mmö_obje˘id
;

512 
__u64
 
	mmax_obje˘id
;

513 
__u64
 
	mmö_off£t
;

514 
__u64
 
	mmax_off£t
;

515 
__u64
 
	mmö_å™sid
;

516 
__u64
 
	mmax_å™sid
;

517 
__u32
 
	mmö_ty≥
;

518 
__u32
 
	mmax_ty≥
;

527 
__u32
 
	mƒ_ôems
;

530 
__u32
 
	munu£d
;

533 
__u64
 
	munu£d1
;

534 
__u64
 
	munu£d2
;

535 
__u64
 
	munu£d3
;

536 
__u64
 
	munu£d4
;

539 
	sbåfs_io˘l_£¨ch_hódî
 {

540 
__u64
 
	må™sid
;

541 
__u64
 
	mobje˘id
;

542 
__u64
 
	moff£t
;

543 
__u32
 
	mty≥
;

544 
__u32
 
	mÀn
;

547 
	#BTRFS_SEARCH_ARGS_BUFSIZE
 (4096 - (
båfs_io˘l_£¨ch_key
))

	)

553 
	sbåfs_io˘l_£¨ch_¨gs
 {

554 
båfs_io˘l_£¨ch_key
 
	mkey
;

555 
	mbuf
[
BTRFS_SEARCH_ARGS_BUFSIZE
];

558 
	sbåfs_io˘l_£¨ch_¨gs_v2
 {

559 
båfs_io˘l_£¨ch_key
 
	mkey
;

560 
__u64
 
	mbuf_size
;

563 
__u64
 
	mbuf
[0];

566 
	sbåfs_io˘l_˛⁄e_ønge_¨gs
 {

567 
__s64
 
	m§c_fd
;

568 
__u64
 
	m§c_off£t
, 
	m§c_Àngth
;

569 
__u64
 
	mde°_off£t
;

578 
	#BTRFS_DEFRAG_RANGE_COMPRESS
 1

	)

579 
	#BTRFS_DEFRAG_RANGE_START_IO
 2

	)

580 
	#BTRFS_DEFRAG_RANGE_FLAGS_SUPP
 (
BTRFS_DEFRAG_RANGE_COMPRESS
 | \

581 
BTRFS_DEFRAG_RANGE_START_IO
)

	)

583 
	sbåfs_io˘l_de‰ag_ønge_¨gs
 {

585 
__u64
 
	m°¨t
;

588 
__u64
 
	mÀn
;

594 
__u64
 
	mÊags
;

601 
__u32
 
	mexã¡_thªsh
;

608 
__u32
 
	mcom¥ess_ty≥
;

611 
__u32
 
	munu£d
[4];

615 
	#BTRFS_SAME_DATA_DIFFERS
 1

	)

617 
	sbåfs_io˘l_ßme_exã¡_öfo
 {

618 
__s64
 
	mfd
;

619 
__u64
 
	mlogiˇl_off£t
;

620 
__u64
 
	mbyãs_dedu≥d
;

627 
__s32
 
	m°©us
;

628 
__u32
 
	mª£rved
;

631 
	sbåfs_io˘l_ßme_¨gs
 {

632 
__u64
 
	mlogiˇl_off£t
;

633 
__u64
 
	mÀngth
;

634 
__u16
 
	mde°_cou¡
;

635 
__u16
 
	mª£rved1
;

636 
__u32
 
	mª£rved2
;

637 
båfs_io˘l_ßme_exã¡_öfo
 
	möfo
[0];

640 
	sbåfs_io˘l_•a˚_öfo
 {

641 
__u64
 
	mÊags
;

642 
__u64
 
	mtŸÆ_byãs
;

643 
__u64
 
	mu£d_byãs
;

646 
	sbåfs_io˘l_•a˚_¨gs
 {

647 
__u64
 
	m•a˚_¶Ÿs
;

648 
__u64
 
	mtŸÆ_•a˚s
;

649 
båfs_io˘l_•a˚_öfo
 
	m•a˚s
[0];

652 
	sbåfs_d©a_c⁄èöî
 {

653 
__u32
 
	mbyãs_À·
;

654 
__u32
 
	mbyãs_missög
;

655 
__u32
 
	mñem_˙t
;

656 
__u32
 
	mñem_mis£d
;

657 
__u64
 
	mvÆ
[0];

660 
	sbåfs_io˘l_öo_∑th_¨gs
 {

661 
__u64
 
	möum
;

662 
__u64
 
	msize
;

663 
__u64
 
	mª£rved
[4];

665 
__u64
 
	mf•©h
;

668 
	sbåfs_io˘l_logiˇl_öo_¨gs
 {

669 
__u64
 
	mlogiˇl
;

670 
__u64
 
	msize
;

671 
__u64
 
	mª£rved
[3];

672 
__u64
 
	mÊags
;

674 
__u64
 
	möodes
;

678 
	#BTRFS_LOGICAL_INO_ARGS_IGNORE_OFFSET
 (1ULL << 0)

	)

680 
	ebåfs_dev_°©_vÆues
 {

682 
	mBTRFS_DEV_STAT_WRITE_ERRS
,

683 
	mBTRFS_DEV_STAT_READ_ERRS
,

684 
	mBTRFS_DEV_STAT_FLUSH_ERRS
,

687 
	mBTRFS_DEV_STAT_CORRUPTION_ERRS
,

693 
	mBTRFS_DEV_STAT_GENERATION_ERRS
,

696 
	mBTRFS_DEV_STAT_VALUES_MAX


700 
	#BTRFS_DEV_STATS_RESET
 (1ULL << 0)

	)

702 
	sbåfs_io˘l_gë_dev_°©s
 {

703 
__u64
 
	mdevid
;

704 
__u64
 
	mƒ_ôems
;

705 
__u64
 
	mÊags
;

708 
__u64
 
	mvÆues
[
BTRFS_DEV_STAT_VALUES_MAX
];

715 
__u64
 
	munu£d
[128 - 2 - 
BTRFS_DEV_STAT_VALUES_MAX
];

718 
	#BTRFS_QUOTA_CTL_ENABLE
 1

	)

719 
	#BTRFS_QUOTA_CTL_DISABLE
 2

	)

720 
	#BTRFS_QUOTA_CTL_RESCAN__NOTUSED
 3

	)

721 
	sbåfs_io˘l_quŸa_˘l_¨gs
 {

722 
__u64
 
	mcmd
;

723 
__u64
 
	m°©us
;

726 
	sbåfs_io˘l_quŸa_ªsˇn_¨gs
 {

727 
__u64
 
	mÊags
;

728 
__u64
 
	m¥ogªss
;

729 
__u64
 
	mª£rved
[6];

732 
	sbåfs_io˘l_qgroup_assign_¨gs
 {

733 
__u64
 
	massign
;

734 
__u64
 
	m§c
;

735 
__u64
 
	md°
;

738 
	sbåfs_io˘l_qgroup_¸óã_¨gs
 {

739 
__u64
 
	m¸óã
;

740 
__u64
 
	mqgroupid
;

742 
	sbåfs_io˘l_time•ec
 {

743 
__u64
 
	m£c
;

744 
__u32
 
	mn£c
;

747 
	sbåfs_io˘l_ª˚ived_subvﬁ_¨gs
 {

748 
	muuid
[
BTRFS_UUID_SIZE
];

749 
__u64
 
	m°ønsid
;

750 
__u64
 
	mπønsid
;

751 
båfs_io˘l_time•ec
 
	m°ime
;

752 
båfs_io˘l_time•ec
 
	mπime
;

753 
__u64
 
	mÊags
;

754 
__u64
 
	mª£rved
[16];

762 
	#BTRFS_SEND_FLAG_NO_FILE_DATA
 0x1

	)

768 
	#BTRFS_SEND_FLAG_OMIT_STREAM_HEADER
 0x2

	)

775 
	#BTRFS_SEND_FLAG_OMIT_END_CMD
 0x4

	)

777 
	#BTRFS_SEND_FLAG_MASK
 \

778 (
BTRFS_SEND_FLAG_NO_FILE_DATA
 | \

779 
BTRFS_SEND_FLAG_OMIT_STREAM_HEADER
 | \

780 
BTRFS_SEND_FLAG_OMIT_END_CMD
)

	)

782 
	sbåfs_io˘l_£nd_¨gs
 {

783 
__s64
 
	m£nd_fd
;

784 
__u64
 
	m˛⁄e_sour˚s_cou¡
;

785 
__u64
 *
	m˛⁄e_sour˚s
;

786 
__u64
 
	m∑ª¡_roŸ
;

787 
__u64
 
	mÊags
;

788 
__u64
 
	mª£rved
[4];

796 
	sbåfs_io˘l_gë_subvﬁ_öfo_¨gs
 {

798 
__u64
 
	måìid
;

801 
	m«me
[
BTRFS_VOL_NAME_MAX
 + 1];

807 
__u64
 
	m∑ª¡_id
;

813 
__u64
 
	mdúid
;

816 
__u64
 
	mgíî©i⁄
;

819 
__u64
 
	mÊags
;

822 
__u8
 
	muuid
[
BTRFS_UUID_SIZE
];

828 
__u8
 
	m∑ª¡_uuid
[
BTRFS_UUID_SIZE
];

834 
__u8
 
	mª˚ived_uuid
[
BTRFS_UUID_SIZE
];

837 
__u64
 
	m˘ønsid
;

838 
__u64
 
	mŸønsid
;

839 
__u64
 
	m°ønsid
;

840 
__u64
 
	mπønsid
;

842 
båfs_io˘l_time•ec
 
	m˘ime
;

843 
båfs_io˘l_time•ec
 
	mŸime
;

844 
båfs_io˘l_time•ec
 
	m°ime
;

845 
båfs_io˘l_time•ec
 
	mπime
;

848 
__u64
 
	mª£rved
[8];

851 
	#BTRFS_MAX_ROOTREF_BUFFER_NUM
 255

	)

852 
	sbåfs_io˘l_gë_subvﬁ_roŸªf_¨gs
 {

854 
__u64
 
	mmö_åìid
;

858 
__u64
 
	måìid
;

859 
__u64
 
	mdúid
;

860 } 
	mroŸªf
[
BTRFS_MAX_ROOTREF_BUFFER_NUM
];

863 
__u8
 
	mnum_ôems
;

864 
__u8
 
	mÆign
[7];

868 
	ebåfs_îr_code
 {

869 
	mBTRFS_ERROR_DEV_RAID1_MIN_NOT_MET
 = 1,

870 
	mBTRFS_ERROR_DEV_RAID10_MIN_NOT_MET
,

871 
	mBTRFS_ERROR_DEV_RAID5_MIN_NOT_MET
,

872 
	mBTRFS_ERROR_DEV_RAID6_MIN_NOT_MET
,

873 
	mBTRFS_ERROR_DEV_TGT_REPLACE
,

874 
	mBTRFS_ERROR_DEV_MISSING_NOT_FOUND
,

875 
	mBTRFS_ERROR_DEV_ONLY_WRITABLE
,

876 
	mBTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
,

877 
	mBTRFS_ERROR_DEV_RAID1C3_MIN_NOT_MET
,

878 
	mBTRFS_ERROR_DEV_RAID1C4_MIN_NOT_MET
,

881 
	#BTRFS_IOC_SNAP_CREATE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 1, \

882 
båfs_io˘l_vﬁ_¨gs
)

	)

883 
	#BTRFS_IOC_DEFRAG
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 2, \

884 
båfs_io˘l_vﬁ_¨gs
)

	)

885 
	#BTRFS_IOC_RESIZE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 3, \

886 
båfs_io˘l_vﬁ_¨gs
)

	)

887 
	#BTRFS_IOC_SCAN_DEV
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 4, \

888 
båfs_io˘l_vﬁ_¨gs
)

	)

889 
	#BTRFS_IOC_FORGET_DEV
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 5, \

890 
båfs_io˘l_vﬁ_¨gs
)

	)

895 
	#BTRFS_IOC_TRANS_START
 
	`_IO
(
BTRFS_IOCTL_MAGIC
, 6)

	)

896 
	#BTRFS_IOC_TRANS_END
 
	`_IO
(
BTRFS_IOCTL_MAGIC
, 7)

	)

897 
	#BTRFS_IOC_SYNC
 
	`_IO
(
BTRFS_IOCTL_MAGIC
, 8)

	)

899 
	#BTRFS_IOC_CLONE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 9, )

	)

900 
	#BTRFS_IOC_ADD_DEV
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 10, \

901 
båfs_io˘l_vﬁ_¨gs
)

	)

902 
	#BTRFS_IOC_RM_DEV
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 11, \

903 
båfs_io˘l_vﬁ_¨gs
)

	)

904 
	#BTRFS_IOC_BALANCE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 12, \

905 
båfs_io˘l_vﬁ_¨gs
)

	)

907 
	#BTRFS_IOC_CLONE_RANGE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 13, \

908 
båfs_io˘l_˛⁄e_ønge_¨gs
)

	)

910 
	#BTRFS_IOC_SUBVOL_CREATE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 14, \

911 
båfs_io˘l_vﬁ_¨gs
)

	)

912 
	#BTRFS_IOC_SNAP_DESTROY
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 15, \

913 
båfs_io˘l_vﬁ_¨gs
)

	)

914 
	#BTRFS_IOC_DEFRAG_RANGE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 16, \

915 
båfs_io˘l_de‰ag_ønge_¨gs
)

	)

916 
	#BTRFS_IOC_TREE_SEARCH
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 17, \

917 
båfs_io˘l_£¨ch_¨gs
)

	)

918 
	#BTRFS_IOC_TREE_SEARCH_V2
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 17, \

919 
båfs_io˘l_£¨ch_¨gs_v2
)

	)

920 
	#BTRFS_IOC_INO_LOOKUP
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 18, \

921 
båfs_io˘l_öo_lookup_¨gs
)

	)

922 
	#BTRFS_IOC_DEFAULT_SUBVOL
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 19, 
__u64
)

	)

923 
	#BTRFS_IOC_SPACE_INFO
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 20, \

924 
båfs_io˘l_•a˚_¨gs
)

	)

925 
	#BTRFS_IOC_START_SYNC
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 24, 
__u64
)

	)

926 
	#BTRFS_IOC_WAIT_SYNC
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 22, 
__u64
)

	)

927 
	#BTRFS_IOC_SNAP_CREATE_V2
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 23, \

928 
båfs_io˘l_vﬁ_¨gs_v2
)

	)

929 
	#BTRFS_IOC_SUBVOL_CREATE_V2
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 24, \

930 
båfs_io˘l_vﬁ_¨gs_v2
)

	)

931 
	#BTRFS_IOC_SUBVOL_GETFLAGS
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 25, 
__u64
)

	)

932 
	#BTRFS_IOC_SUBVOL_SETFLAGS
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 26, 
__u64
)

	)

933 
	#BTRFS_IOC_SCRUB
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 27, \

934 
båfs_io˘l_s¸ub_¨gs
)

	)

935 
	#BTRFS_IOC_SCRUB_CANCEL
 
	`_IO
(
BTRFS_IOCTL_MAGIC
, 28)

	)

936 
	#BTRFS_IOC_SCRUB_PROGRESS
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 29, \

937 
båfs_io˘l_s¸ub_¨gs
)

	)

938 
	#BTRFS_IOC_DEV_INFO
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 30, \

939 
båfs_io˘l_dev_öfo_¨gs
)

	)

940 
	#BTRFS_IOC_FS_INFO
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 31, \

941 
båfs_io˘l_fs_öfo_¨gs
)

	)

942 
	#BTRFS_IOC_BALANCE_V2
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 32, \

943 
båfs_io˘l_bÆ™˚_¨gs
)

	)

944 
	#BTRFS_IOC_BALANCE_CTL
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 33, )

	)

945 
	#BTRFS_IOC_BALANCE_PROGRESS
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 34, \

946 
båfs_io˘l_bÆ™˚_¨gs
)

	)

947 
	#BTRFS_IOC_INO_PATHS
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 35, \

948 
båfs_io˘l_öo_∑th_¨gs
)

	)

949 
	#BTRFS_IOC_LOGICAL_INO
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 36, \

950 
båfs_io˘l_logiˇl_öo_¨gs
)

	)

951 
	#BTRFS_IOC_SET_RECEIVED_SUBVOL
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 37, \

952 
båfs_io˘l_ª˚ived_subvﬁ_¨gs
)

	)

953 
	#BTRFS_IOC_SEND
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 38, 
båfs_io˘l_£nd_¨gs
)

	)

954 
	#BTRFS_IOC_DEVICES_READY
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 39, \

955 
båfs_io˘l_vﬁ_¨gs
)

	)

956 
	#BTRFS_IOC_QUOTA_CTL
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 40, \

957 
båfs_io˘l_quŸa_˘l_¨gs
)

	)

958 
	#BTRFS_IOC_QGROUP_ASSIGN
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 41, \

959 
båfs_io˘l_qgroup_assign_¨gs
)

	)

960 
	#BTRFS_IOC_QGROUP_CREATE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 42, \

961 
båfs_io˘l_qgroup_¸óã_¨gs
)

	)

962 
	#BTRFS_IOC_QGROUP_LIMIT
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 43, \

963 
båfs_io˘l_qgroup_limô_¨gs
)

	)

964 
	#BTRFS_IOC_QUOTA_RESCAN
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 44, \

965 
båfs_io˘l_quŸa_ªsˇn_¨gs
)

	)

966 
	#BTRFS_IOC_QUOTA_RESCAN_STATUS
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 45, \

967 
båfs_io˘l_quŸa_ªsˇn_¨gs
)

	)

968 
	#BTRFS_IOC_QUOTA_RESCAN_WAIT
 
	`_IO
(
BTRFS_IOCTL_MAGIC
, 46)

	)

969 
	#BTRFS_IOC_GET_FSLABEL
 
FS_IOC_GETFSLABEL


	)

970 
	#BTRFS_IOC_SET_FSLABEL
 
FS_IOC_SETFSLABEL


	)

971 
	#BTRFS_IOC_GET_DEV_STATS
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 52, \

972 
båfs_io˘l_gë_dev_°©s
)

	)

973 
	#BTRFS_IOC_DEV_REPLACE
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 53, \

974 
båfs_io˘l_dev_ª∂a˚_¨gs
)

	)

975 
	#BTRFS_IOC_FILE_EXTENT_SAME
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 54, \

976 
båfs_io˘l_ßme_¨gs
)

	)

977 
	#BTRFS_IOC_GET_FEATURES
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 57, \

978 
båfs_io˘l_„©uª_Êags
)

	)

979 
	#BTRFS_IOC_SET_FEATURES
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 57, \

980 
båfs_io˘l_„©uª_Êags
[2])

	)

981 
	#BTRFS_IOC_GET_SUPPORTED_FEATURES
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 57, \

982 
båfs_io˘l_„©uª_Êags
[3])

	)

983 
	#BTRFS_IOC_RM_DEV_V2
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 58, \

984 
båfs_io˘l_vﬁ_¨gs_v2
)

	)

985 
	#BTRFS_IOC_LOGICAL_INO_V2
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 59, \

986 
båfs_io˘l_logiˇl_öo_¨gs
)

	)

987 
	#BTRFS_IOC_GET_SUBVOL_INFO
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 60, \

988 
båfs_io˘l_gë_subvﬁ_öfo_¨gs
)

	)

989 
	#BTRFS_IOC_GET_SUBVOL_ROOTREF
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 61, \

990 
båfs_io˘l_gë_subvﬁ_roŸªf_¨gs
)

	)

991 
	#BTRFS_IOC_INO_LOOKUP_USER
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 62, \

992 
båfs_io˘l_öo_lookup_u£r_¨gs
)

	)

993 
	#BTRFS_IOC_SNAP_DESTROY_V2
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 63, \

994 
båfs_io˘l_vﬁ_¨gs_v2
)

	)

	@/usr/include/linux/btrfs_tree.h

2 #i‚de‡
_BTRFS_CTREE_H_


3 
	#_BTRFS_CTREE_H_


	)

5 
	~<löux/båfs.h
>

6 
	~<löux/ty≥s.h
>

7 
	~<°ddef.h
>

17 
	#BTRFS_ROOT_TREE_OBJECTID
 1ULL

	)

20 
	#BTRFS_EXTENT_TREE_OBJECTID
 2ULL

	)

26 
	#BTRFS_CHUNK_TREE_OBJECTID
 3ULL

	)

32 
	#BTRFS_DEV_TREE_OBJECTID
 4ULL

	)

35 
	#BTRFS_FS_TREE_OBJECTID
 5ULL

	)

38 
	#BTRFS_ROOT_TREE_DIR_OBJECTID
 6ULL

	)

41 
	#BTRFS_CSUM_TREE_OBJECTID
 7ULL

	)

44 
	#BTRFS_QUOTA_TREE_OBJECTID
 8ULL

	)

47 
	#BTRFS_UUID_TREE_OBJECTID
 9ULL

	)

50 
	#BTRFS_FREE_SPACE_TREE_OBJECTID
 10ULL

	)

53 
	#BTRFS_DEV_STATS_OBJECTID
 0ULL

	)

56 
	#BTRFS_BALANCE_OBJECTID
 -4ULL

	)

59 
	#BTRFS_ORPHAN_OBJECTID
 -5ULL

	)

62 
	#BTRFS_TREE_LOG_OBJECTID
 -6ULL

	)

63 
	#BTRFS_TREE_LOG_FIXUP_OBJECTID
 -7ULL

	)

66 
	#BTRFS_TREE_RELOC_OBJECTID
 -8ULL

	)

67 
	#BTRFS_DATA_RELOC_TREE_OBJECTID
 -9ULL

	)

74 
	#BTRFS_EXTENT_CSUM_OBJECTID
 -10ULL

	)

77 
	#BTRFS_FREE_SPACE_OBJECTID
 -11ULL

	)

83 
	#BTRFS_FREE_INO_OBJECTID
 -12ULL

	)

86 
	#BTRFS_MULTIPLE_OBJECTIDS
 -255ULL

	)

91 
	#BTRFS_FIRST_FREE_OBJECTID
 256ULL

	)

92 
	#BTRFS_LAST_FREE_OBJECTID
 -256ULL

	)

93 
	#BTRFS_FIRST_CHUNK_TREE_OBJECTID
 256ULL

	)

100 
	#BTRFS_DEV_ITEMS_OBJECTID
 1ULL

	)

102 
	#BTRFS_BTREE_INODE_OBJECTID
 1

	)

104 
	#BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
 2

	)

106 
	#BTRFS_DEV_REPLACE_DEVID
 0ULL

	)

113 
	#BTRFS_INODE_ITEM_KEY
 1

	)

114 
	#BTRFS_INODE_REF_KEY
 12

	)

115 
	#BTRFS_INODE_EXTREF_KEY
 13

	)

116 
	#BTRFS_XATTR_ITEM_KEY
 24

	)

137 
	#BTRFS_VERITY_DESC_ITEM_KEY
 36

	)

138 
	#BTRFS_VERITY_MERKLE_ITEM_KEY
 37

	)

140 
	#BTRFS_ORPHAN_ITEM_KEY
 48

	)

149 
	#BTRFS_DIR_LOG_ITEM_KEY
 60

	)

150 
	#BTRFS_DIR_LOG_INDEX_KEY
 72

	)

151 
	#BTRFS_DIR_ITEM_KEY
 84

	)

152 
	#BTRFS_DIR_INDEX_KEY
 96

	)

156 
	#BTRFS_EXTENT_DATA_KEY
 108

	)

162 
	#BTRFS_EXTENT_CSUM_KEY
 128

	)

168 
	#BTRFS_ROOT_ITEM_KEY
 132

	)

174 
	#BTRFS_ROOT_BACKREF_KEY
 144

	)

181 
	#BTRFS_ROOT_REF_KEY
 156

	)

187 
	#BTRFS_EXTENT_ITEM_KEY
 168

	)

193 
	#BTRFS_METADATA_ITEM_KEY
 169

	)

195 
	#BTRFS_TREE_BLOCK_REF_KEY
 176

	)

197 
	#BTRFS_EXTENT_DATA_REF_KEY
 178

	)

199 
	#BTRFS_EXTENT_REF_V0_KEY
 180

	)

201 
	#BTRFS_SHARED_BLOCK_REF_KEY
 182

	)

203 
	#BTRFS_SHARED_DATA_REF_KEY
 184

	)

209 
	#BTRFS_BLOCK_GROUP_ITEM_KEY
 192

	)

216 
	#BTRFS_FREE_SPACE_INFO_KEY
 198

	)

222 
	#BTRFS_FREE_SPACE_EXTENT_KEY
 199

	)

230 
	#BTRFS_FREE_SPACE_BITMAP_KEY
 200

	)

232 
	#BTRFS_DEV_EXTENT_KEY
 204

	)

233 
	#BTRFS_DEV_ITEM_KEY
 216

	)

234 
	#BTRFS_CHUNK_ITEM_KEY
 228

	)

241 
	#BTRFS_QGROUP_STATUS_KEY
 240

	)

246 
	#BTRFS_QGROUP_INFO_KEY
 242

	)

251 
	#BTRFS_QGROUP_LIMIT_KEY
 244

	)

258 
	#BTRFS_QGROUP_RELATION_KEY
 246

	)

263 
	#BTRFS_BALANCE_ITEM_KEY
 248

	)

276 
	#BTRFS_TEMPORARY_ITEM_KEY
 248

	)

281 
	#BTRFS_DEV_STATS_KEY
 249

	)

296 
	#BTRFS_PERSISTENT_ITEM_KEY
 249

	)

302 
	#BTRFS_DEV_REPLACE_KEY
 250

	)

310 #i‡
BTRFS_UUID_SIZE
 != 16

313 
	#BTRFS_UUID_KEY_SUBVOL
 251

	)

314 
	#BTRFS_UUID_KEY_RECEIVED_SUBVOL
 252

	)

321 
	#BTRFS_STRING_ITEM_KEY
 253

	)

324 
	#BTRFS_MAX_METADATA_BLOCKSIZE
 65536

	)

327 
	#BTRFS_CSUM_SIZE
 32

	)

330 
	ebåfs_csum_ty≥
 {

331 
	mBTRFS_CSUM_TYPE_CRC32
 = 0,

332 
	mBTRFS_CSUM_TYPE_XXHASH
 = 1,

333 
	mBTRFS_CSUM_TYPE_SHA256
 = 2,

334 
	mBTRFS_CSUM_TYPE_BLAKE2
 = 3,

345 
	#BTRFS_FT_UNKNOWN
 0

	)

346 
	#BTRFS_FT_REG_FILE
 1

	)

347 
	#BTRFS_FT_DIR
 2

	)

348 
	#BTRFS_FT_CHRDEV
 3

	)

349 
	#BTRFS_FT_BLKDEV
 4

	)

350 
	#BTRFS_FT_FIFO
 5

	)

351 
	#BTRFS_FT_SOCK
 6

	)

352 
	#BTRFS_FT_SYMLINK
 7

	)

353 
	#BTRFS_FT_XATTR
 8

	)

354 
	#BTRFS_FT_MAX
 9

	)

373 
	sbåfs_disk_key
 {

374 
__À64
 
	mobje˘id
;

375 
__u8
 
	mty≥
;

376 
__À64
 
	moff£t
;

377 } 
__©åibuã__
 ((
__∑cked__
));

379 
	sbåfs_key
 {

380 
__u64
 
	mobje˘id
;

381 
__u8
 
	mty≥
;

382 
__u64
 
	moff£t
;

383 } 
__©åibuã__
 ((
__∑cked__
));

385 
	sbåfs_dev_ôem
 {

387 
__À64
 
	mdevid
;

390 
__À64
 
	mtŸÆ_byãs
;

393 
__À64
 
	mbyãs_u£d
;

396 
__À32
 
	mio_Æign
;

399 
__À32
 
	mio_width
;

402 
__À32
 
	m£˘‹_size
;

405 
__À64
 
	mty≥
;

408 
__À64
 
	mgíî©i⁄
;

414 
__À64
 
	m°¨t_off£t
;

417 
__À32
 
	mdev_group
;

420 
__u8
 
	m£ek_•ìd
;

423 
__u8
 
	mb™dwidth
;

426 
__u8
 
	muuid
[
BTRFS_UUID_SIZE
];

429 
__u8
 
	mfsid
[
BTRFS_UUID_SIZE
];

430 } 
__©åibuã__
 ((
__∑cked__
));

432 
	sbåfs_°rùe
 {

433 
__À64
 
	mdevid
;

434 
__À64
 
	moff£t
;

435 
__u8
 
	mdev_uuid
[
BTRFS_UUID_SIZE
];

436 } 
__©åibuã__
 ((
__∑cked__
));

438 
	sbåfs_chunk
 {

440 
__À64
 
	mÀngth
;

443 
__À64
 
	mow√r
;

445 
__À64
 
	m°rùe_Àn
;

446 
__À64
 
	mty≥
;

449 
__À32
 
	mio_Æign
;

452 
__À32
 
	mio_width
;

455 
__À32
 
	m£˘‹_size
;

460 
__À16
 
	mnum_°rùes
;

463 
__À16
 
	msub_°rùes
;

464 
båfs_°rùe
 
	m°rùe
;

466 } 
__©åibuã__
 ((
__∑cked__
));

468 
	#BTRFS_FREE_SPACE_EXTENT
 1

	)

469 
	#BTRFS_FREE_SPACE_BITMAP
 2

	)

471 
	sbåfs_‰ì_•a˚_íåy
 {

472 
__À64
 
	moff£t
;

473 
__À64
 
	mbyãs
;

474 
__u8
 
	mty≥
;

475 } 
__©åibuã__
 ((
__∑cked__
));

477 
	sbåfs_‰ì_•a˚_hódî
 {

478 
båfs_disk_key
 
	mloˇti⁄
;

479 
__À64
 
	mgíî©i⁄
;

480 
__À64
 
	mnum_íåõs
;

481 
__À64
 
	mnum_bôm≠s
;

482 } 
__©åibuã__
 ((
__∑cked__
));

484 
	#BTRFS_HEADER_FLAG_WRITTEN
 (1ULL << 0)

	)

485 
	#BTRFS_HEADER_FLAG_RELOC
 (1ULL << 1)

	)

489 
	#BTRFS_SUPER_FLAG_ERROR
 (1ULL << 2)

	)

491 
	#BTRFS_SUPER_FLAG_SEEDING
 (1ULL << 32)

	)

492 
	#BTRFS_SUPER_FLAG_METADUMP
 (1ULL << 33)

	)

493 
	#BTRFS_SUPER_FLAG_METADUMP_V2
 (1ULL << 34)

	)

494 
	#BTRFS_SUPER_FLAG_CHANGING_FSID
 (1ULL << 35)

	)

495 
	#BTRFS_SUPER_FLAG_CHANGING_FSID_V2
 (1ULL << 36)

	)

503 
	sbåfs_exã¡_ôem
 {

504 
__À64
 
	mªfs
;

505 
__À64
 
	mgíî©i⁄
;

506 
__À64
 
	mÊags
;

507 } 
__©åibuã__
 ((
__∑cked__
));

509 
	sbåfs_exã¡_ôem_v0
 {

510 
__À32
 
	mªfs
;

511 } 
__©åibuã__
 ((
__∑cked__
));

514 
	#BTRFS_EXTENT_FLAG_DATA
 (1ULL << 0)

	)

515 
	#BTRFS_EXTENT_FLAG_TREE_BLOCK
 (1ULL << 1)

	)

520 
	#BTRFS_BLOCK_FLAG_FULL_BACKREF
 (1ULL << 8)

	)

526 
	#BTRFS_EXTENT_FLAG_SUPER
 (1ULL << 48)

	)

528 
	sbåfs_åì_block_öfo
 {

529 
båfs_disk_key
 
	mkey
;

530 
__u8
 
	mÀvñ
;

531 } 
__©åibuã__
 ((
__∑cked__
));

533 
	sbåfs_exã¡_d©a_ªf
 {

534 
__À64
 
	mroŸ
;

535 
__À64
 
	mobje˘id
;

536 
__À64
 
	moff£t
;

537 
__À32
 
	mcou¡
;

538 } 
__©åibuã__
 ((
__∑cked__
));

540 
	sbåfs_sh¨ed_d©a_ªf
 {

541 
__À32
 
	mcou¡
;

542 } 
__©åibuã__
 ((
__∑cked__
));

544 
	sbåfs_exã¡_ölöe_ªf
 {

545 
__u8
 
	mty≥
;

546 
__À64
 
	moff£t
;

547 } 
__©åibuã__
 ((
__∑cked__
));

553 
	sbåfs_dev_exã¡
 {

554 
__À64
 
	mchunk_åì
;

555 
__À64
 
	mchunk_obje˘id
;

556 
__À64
 
	mchunk_off£t
;

557 
__À64
 
	mÀngth
;

558 
__u8
 
	mchunk_åì_uuid
[
BTRFS_UUID_SIZE
];

559 } 
__©åibuã__
 ((
__∑cked__
));

561 
	sbåfs_öode_ªf
 {

562 
__À64
 
	mödex
;

563 
__À16
 
	m«me_Àn
;

565 } 
__©åibuã__
 ((
__∑cked__
));

567 
	sbåfs_öode_exåef
 {

568 
__À64
 
	m∑ª¡_obje˘id
;

569 
__À64
 
	mödex
;

570 
__À16
 
	m«me_Àn
;

571 
__u8
 
	m«me
[0];

573 } 
__©åibuã__
 ((
__∑cked__
));

575 
	sbåfs_time•ec
 {

576 
__À64
 
	m£c
;

577 
__À32
 
	mn£c
;

578 } 
__©åibuã__
 ((
__∑cked__
));

580 
	sbåfs_öode_ôem
 {

582 
__À64
 
	mgíî©i⁄
;

584 
__À64
 
	må™sid
;

585 
__À64
 
	msize
;

586 
__À64
 
	mnbyãs
;

587 
__À64
 
	mblock_group
;

588 
__À32
 
	m∆ök
;

589 
__À32
 
	muid
;

590 
__À32
 
	mgid
;

591 
__À32
 
	mmode
;

592 
__À64
 
	mrdev
;

593 
__À64
 
	mÊags
;

596 
__À64
 
	m£quí˚
;

602 
__À64
 
	mª£rved
[4];

603 
båfs_time•ec
 
	m©ime
;

604 
båfs_time•ec
 
	m˘ime
;

605 
båfs_time•ec
 
	mmtime
;

606 
båfs_time•ec
 
	mŸime
;

607 } 
__©åibuã__
 ((
__∑cked__
));

609 
	sbåfs_dú_log_ôem
 {

610 
__À64
 
	míd
;

611 } 
__©åibuã__
 ((
__∑cked__
));

613 
	sbåfs_dú_ôem
 {

614 
båfs_disk_key
 
	mloˇti⁄
;

615 
__À64
 
	må™sid
;

616 
__À16
 
	md©a_Àn
;

617 
__À16
 
	m«me_Àn
;

618 
__u8
 
	mty≥
;

619 } 
__©åibuã__
 ((
__∑cked__
));

621 
	#BTRFS_ROOT_SUBVOL_RDONLY
 (1ULL << 0)

	)

627 
	#BTRFS_ROOT_SUBVOL_DEAD
 (1ULL << 48)

	)

629 
	sbåfs_roŸ_ôem
 {

630 
båfs_öode_ôem
 
	möode
;

631 
__À64
 
	mgíî©i⁄
;

632 
__À64
 
	mroŸ_dúid
;

633 
__À64
 
	mbyãƒ
;

634 
__À64
 
	mbyã_limô
;

635 
__À64
 
	mbyãs_u£d
;

636 
__À64
 
	mœ°_¢≠shŸ
;

637 
__À64
 
	mÊags
;

638 
__À32
 
	mªfs
;

639 
båfs_disk_key
 
	mdr›_¥ogªss
;

640 
__u8
 
	mdr›_Àvñ
;

641 
__u8
 
	mÀvñ
;

659 
__À64
 
	mgíî©i⁄_v2
;

660 
__u8
 
	muuid
[
BTRFS_UUID_SIZE
];

661 
__u8
 
	m∑ª¡_uuid
[
BTRFS_UUID_SIZE
];

662 
__u8
 
	mª˚ived_uuid
[
BTRFS_UUID_SIZE
];

663 
__À64
 
	m˘ønsid
;

664 
__À64
 
	mŸønsid
;

665 
__À64
 
	m°ønsid
;

666 
__À64
 
	mπønsid
;

667 
båfs_time•ec
 
	m˘ime
;

668 
båfs_time•ec
 
	mŸime
;

669 
båfs_time•ec
 
	m°ime
;

670 
båfs_time•ec
 
	mπime
;

671 
__À64
 
	mª£rved
[8];

672 } 
__©åibuã__
 ((
__∑cked__
));

678 
__ölöe__
 
__u32
 
	$båfs_Àgacy_roŸ_ôem_size
()

680  
	`off£tof
(
båfs_roŸ_ôem
, 
gíî©i⁄_v2
);

681 
	}
}

686 
	sbåfs_roŸ_ªf
 {

687 
__À64
 
	mdúid
;

688 
__À64
 
	m£quí˚
;

689 
__À16
 
	m«me_Àn
;

690 } 
__©åibuã__
 ((
__∑cked__
));

692 
	sbåfs_disk_bÆ™˚_¨gs
 {

697 
__À64
 
	m¥ofûes
;

705 
__À64
 
	mußge
;

707 
__À32
 
	mußge_mö
;

708 
__À32
 
	mußge_max
;

713 
__À64
 
	mdevid
;

716 
__À64
 
	mp°¨t
;

717 
__À64
 
	m≥nd
;

720 
__À64
 
	mv°¨t
;

721 
__À64
 
	mvíd
;

727 
__À64
 
	mèrgë
;

730 
__À64
 
	mÊags
;

738 
__À64
 
	mlimô
;

740 
__À32
 
	mlimô_mö
;

741 
__À32
 
	mlimô_max
;

749 
__À32
 
	m°rùes_mö
;

750 
__À32
 
	m°rùes_max
;

752 
__À64
 
	munu£d
[6];

753 } 
__©åibuã__
 ((
__∑cked__
));

759 
	sbåfs_bÆ™˚_ôem
 {

761 
__À64
 
	mÊags
;

763 
båfs_disk_bÆ™˚_¨gs
 
	md©a
;

764 
båfs_disk_bÆ™˚_¨gs
 
	mmëa
;

765 
båfs_disk_bÆ™˚_¨gs
 
	msys
;

767 
__À64
 
	munu£d
[4];

768 } 
__©åibuã__
 ((
__∑cked__
));

771 
	mBTRFS_FILE_EXTENT_INLINE
 = 0,

772 
	mBTRFS_FILE_EXTENT_REG
 = 1,

773 
	mBTRFS_FILE_EXTENT_PREALLOC
 = 2,

774 
	mBTRFS_NR_FILE_EXTENT_TYPES
 = 3,

777 
	sbåfs_fûe_exã¡_ôem
 {

781 
__À64
 
	mgíî©i⁄
;

789 
__À64
 
	møm_byãs
;

798 
__u8
 
	mcom¥essi⁄
;

799 
__u8
 
	mí¸y±i⁄
;

800 
__À16
 
	mŸhî_ícodög
;

803 
__u8
 
	mty≥
;

811 
__À64
 
	mdisk_byãƒ
;

812 
__À64
 
	mdisk_num_byãs
;

820 
__À64
 
	moff£t
;

825 
__À64
 
	mnum_byãs
;

827 } 
__©åibuã__
 ((
__∑cked__
));

829 
	sbåfs_csum_ôem
 {

830 
__u8
 
	mcsum
;

831 } 
__©åibuã__
 ((
__∑cked__
));

833 
	sbåfs_dev_°©s_ôem
 {

838 
__À64
 
	mvÆues
[
BTRFS_DEV_STAT_VALUES_MAX
];

839 } 
__©åibuã__
 ((
__∑cked__
));

841 
	#BTRFS_DEV_REPLACE_ITEM_CONT_READING_FROM_SRCDEV_MODE_ALWAYS
 0

	)

842 
	#BTRFS_DEV_REPLACE_ITEM_CONT_READING_FROM_SRCDEV_MODE_AVOID
 1

	)

844 
	sbåfs_dev_ª∂a˚_ôem
 {

849 
__À64
 
	m§c_devid
;

850 
__À64
 
	mcurs‹_À·
;

851 
__À64
 
	mcurs‹_right
;

852 
__À64
 
	mc⁄t_ªadög_‰om_§cdev_mode
;

854 
__À64
 
	mª∂a˚_°©e
;

855 
__À64
 
	mtime_°¨ãd
;

856 
__À64
 
	mtime_°›≥d
;

857 
__À64
 
	mnum_wrôe_îr‹s
;

858 
__À64
 
	mnum_unc‹ª˘abÀ_ªad_îr‹s
;

859 } 
__©åibuã__
 ((
__∑cked__
));

862 
	#BTRFS_BLOCK_GROUP_DATA
 (1ULL << 0)

	)

863 
	#BTRFS_BLOCK_GROUP_SYSTEM
 (1ULL << 1)

	)

864 
	#BTRFS_BLOCK_GROUP_METADATA
 (1ULL << 2)

	)

865 
	#BTRFS_BLOCK_GROUP_RAID0
 (1ULL << 3)

	)

866 
	#BTRFS_BLOCK_GROUP_RAID1
 (1ULL << 4)

	)

867 
	#BTRFS_BLOCK_GROUP_DUP
 (1ULL << 5)

	)

868 
	#BTRFS_BLOCK_GROUP_RAID10
 (1ULL << 6)

	)

869 
	#BTRFS_BLOCK_GROUP_RAID5
 (1ULL << 7)

	)

870 
	#BTRFS_BLOCK_GROUP_RAID6
 (1ULL << 8)

	)

871 
	#BTRFS_BLOCK_GROUP_RAID1C3
 (1ULL << 9)

	)

872 
	#BTRFS_BLOCK_GROUP_RAID1C4
 (1ULL << 10)

	)

873 
	#BTRFS_BLOCK_GROUP_RESERVED
 (
BTRFS_AVAIL_ALLOC_BIT_SINGLE
 | \

874 
BTRFS_SPACE_INFO_GLOBAL_RSV
)

	)

876 
	ebåfs_øid_ty≥s
 {

877 
	mBTRFS_RAID_RAID10
,

878 
	mBTRFS_RAID_RAID1
,

879 
	mBTRFS_RAID_DUP
,

880 
	mBTRFS_RAID_RAID0
,

881 
	mBTRFS_RAID_SINGLE
,

882 
	mBTRFS_RAID_RAID5
,

883 
	mBTRFS_RAID_RAID6
,

884 
	mBTRFS_RAID_RAID1C3
,

885 
	mBTRFS_RAID_RAID1C4
,

886 
	mBTRFS_NR_RAID_TYPES


889 
	#BTRFS_BLOCK_GROUP_TYPE_MASK
 (
BTRFS_BLOCK_GROUP_DATA
 | \

890 
BTRFS_BLOCK_GROUP_SYSTEM
 | \

891 
BTRFS_BLOCK_GROUP_METADATA
)

	)

893 
	#BTRFS_BLOCK_GROUP_PROFILE_MASK
 (
BTRFS_BLOCK_GROUP_RAID0
 | \

894 
BTRFS_BLOCK_GROUP_RAID1
 | \

895 
BTRFS_BLOCK_GROUP_RAID1C3
 | \

896 
BTRFS_BLOCK_GROUP_RAID1C4
 | \

897 
BTRFS_BLOCK_GROUP_RAID5
 | \

898 
BTRFS_BLOCK_GROUP_RAID6
 | \

899 
BTRFS_BLOCK_GROUP_DUP
 | \

900 
BTRFS_BLOCK_GROUP_RAID10
)

	)

901 
	#BTRFS_BLOCK_GROUP_RAID56_MASK
 (
BTRFS_BLOCK_GROUP_RAID5
 | \

902 
BTRFS_BLOCK_GROUP_RAID6
)

	)

904 
	#BTRFS_BLOCK_GROUP_RAID1_MASK
 (
BTRFS_BLOCK_GROUP_RAID1
 | \

905 
BTRFS_BLOCK_GROUP_RAID1C3
 | \

906 
BTRFS_BLOCK_GROUP_RAID1C4
)

	)

915 
	#BTRFS_AVAIL_ALLOC_BIT_SINGLE
 (1ULL << 48)

	)

921 
	#BTRFS_SPACE_INFO_GLOBAL_RSV
 (1ULL << 49)

	)

923 
	#BTRFS_EXTENDED_PROFILE_MASK
 (
BTRFS_BLOCK_GROUP_PROFILE_MASK
 | \

924 
BTRFS_AVAIL_ALLOC_BIT_SINGLE
)

	)

926 
__ölöe__
 
__u64
 
	$chunk_to_exãnded
(
__u64
 
Êags
)

928 i‡((
Êags
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) == 0)

929 
Êags
 |
BTRFS_AVAIL_ALLOC_BIT_SINGLE
;

931  
Êags
;

932 
	}
}

933 
__ölöe__
 
__u64
 
	$exãnded_to_chunk
(
__u64
 
Êags
)

935  
Êags
 & ~
BTRFS_AVAIL_ALLOC_BIT_SINGLE
;

936 
	}
}

938 
	sbåfs_block_group_ôem
 {

939 
__À64
 
	mu£d
;

940 
__À64
 
	mchunk_obje˘id
;

941 
__À64
 
	mÊags
;

942 } 
__©åibuã__
 ((
__∑cked__
));

944 
	sbåfs_‰ì_•a˚_öfo
 {

945 
__À32
 
	mexã¡_cou¡
;

946 
__À32
 
	mÊags
;

947 } 
__©åibuã__
 ((
__∑cked__
));

949 
	#BTRFS_FREE_SPACE_USING_BITMAPS
 (1ULL << 0)

	)

951 
	#BTRFS_QGROUP_LEVEL_SHIFT
 48

	)

952 
__ölöe__
 
__u16
 
	$båfs_qgroup_Àvñ
(
__u64
 
qgroupid
)

954  (
__u16
)(
qgroupid
 >> 
BTRFS_QGROUP_LEVEL_SHIFT
);

955 
	}
}

960 
	#BTRFS_QGROUP_STATUS_FLAG_ON
 (1ULL << 0)

	)

964 
	#BTRFS_QGROUP_STATUS_FLAG_RESCAN
 (1ULL << 1)

	)

972 
	#BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
 (1ULL << 2)

	)

974 
	#BTRFS_QGROUP_STATUS_VERSION
 1

	)

976 
	sbåfs_qgroup_°©us_ôem
 {

977 
__À64
 
	mvîsi⁄
;

984 
__À64
 
	mgíî©i⁄
;

987 
__À64
 
	mÊags
;

993 
__À64
 
	mªsˇn
;

994 } 
__©åibuã__
 ((
__∑cked__
));

996 
	sbåfs_qgroup_öfo_ôem
 {

997 
__À64
 
	mgíî©i⁄
;

998 
__À64
 
	mr„r
;

999 
__À64
 
	mr„r_cm¥
;

1000 
__À64
 
	mex˛
;

1001 
__À64
 
	mex˛_cm¥
;

1002 } 
__©åibuã__
 ((
__∑cked__
));

1004 
	sbåfs_qgroup_limô_ôem
 {

1008 
__À64
 
	mÊags
;

1009 
__À64
 
	mmax_r„r
;

1010 
__À64
 
	mmax_ex˛
;

1011 
__À64
 
	mrsv_r„r
;

1012 
__À64
 
	mrsv_ex˛
;

1013 } 
__©åibuã__
 ((
__∑cked__
));

1015 
	sbåfs_vîôy_des¸ùt‹_ôem
 {

1017 
__À64
 
	msize
;

1023 
__À64
 
	mª£rved
[2];

1024 
__u8
 
	mí¸y±i⁄
;

1025 } 
__©åibuã__
 ((
__∑cked__
));

	@/usr/include/linux/capability.h

14 #i‚de‡
_LINUX_CAPABILITY_H


15 
	#_LINUX_CAPABILITY_H


	)

17 
	~<löux/ty≥s.h
>

30 
	#_LINUX_CAPABILITY_VERSION_1
 0x19980330

	)

31 
	#_LINUX_CAPABILITY_U32S_1
 1

	)

33 
	#_LINUX_CAPABILITY_VERSION_2
 0x20071026

	)

34 
	#_LINUX_CAPABILITY_U32S_2
 2

	)

36 
	#_LINUX_CAPABILITY_VERSION_3
 0x20080522

	)

37 
	#_LINUX_CAPABILITY_U32S_3
 2

	)

39 
	s__u£r_ˇp_hódî_°ru˘
 {

40 
__u32
 
	mvîsi⁄
;

41 
	mpid
;

42 } *
	tˇp_u£r_hódî_t
;

44 
	s__u£r_ˇp_d©a_°ru˘
 {

45 
__u32
 
	mef„˘ive
;

46 
__u32
 
	m≥rmôãd
;

47 
__u32
 
	möhîôabÀ
;

48 } *
	tˇp_u£r_d©a_t
;

51 
	#VFS_CAP_REVISION_MASK
 0xFF000000

	)

52 
	#VFS_CAP_REVISION_SHIFT
 24

	)

53 
	#VFS_CAP_FLAGS_MASK
 ~
VFS_CAP_REVISION_MASK


	)

54 
	#VFS_CAP_FLAGS_EFFECTIVE
 0x000001

	)

56 
	#VFS_CAP_REVISION_1
 0x01000000

	)

57 
	#VFS_CAP_U32_1
 1

	)

58 
	#XATTR_CAPS_SZ_1
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_1
))

	)

60 
	#VFS_CAP_REVISION_2
 0x02000000

	)

61 
	#VFS_CAP_U32_2
 2

	)

62 
	#XATTR_CAPS_SZ_2
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_2
))

	)

64 
	#VFS_CAP_REVISION_3
 0x03000000

	)

65 
	#VFS_CAP_U32_3
 2

	)

66 
	#XATTR_CAPS_SZ_3
 ((
__À32
)*(2 + 2*
VFS_CAP_U32_3
))

	)

68 
	#XATTR_CAPS_SZ
 
XATTR_CAPS_SZ_3


	)

69 
	#VFS_CAP_U32
 
VFS_CAP_U32_3


	)

70 
	#VFS_CAP_REVISION
 
VFS_CAP_REVISION_3


	)

72 
	svfs_ˇp_d©a
 {

73 
__À32
 
	mmagic_ëc
;

75 
__À32
 
	m≥rmôãd
;

76 
__À32
 
	möhîôabÀ
;

77 } 
	md©a
[
VFS_CAP_U32
];

83 
	svfs_ns_ˇp_d©a
 {

84 
__À32
 
	mmagic_ëc
;

86 
__À32
 
	m≥rmôãd
;

87 
__À32
 
	möhîôabÀ
;

88 } 
	md©a
[
VFS_CAP_U32
];

89 
__À32
 
	mroŸid
;

98 
	#_LINUX_CAPABILITY_VERSION
 
_LINUX_CAPABILITY_VERSION_1


	)

99 
	#_LINUX_CAPABILITY_U32S
 
_LINUX_CAPABILITY_U32S_1


	)

111 
	#CAP_CHOWN
 0

	)

117 
	#CAP_DAC_OVERRIDE
 1

	)

123 
	#CAP_DAC_READ_SEARCH
 2

	)

129 
	#CAP_FOWNER
 3

	)

138 
	#CAP_FSETID
 4

	)

144 
	#CAP_KILL
 5

	)

150 
	#CAP_SETGID
 6

	)

155 
	#CAP_SETUID
 7

	)

172 
	#CAP_SETPCAP
 8

	)

176 
	#CAP_LINUX_IMMUTABLE
 9

	)

181 
	#CAP_NET_BIND_SERVICE
 10

	)

185 
	#CAP_NET_BROADCAST
 11

	)

201 
	#CAP_NET_ADMIN
 12

	)

207 
	#CAP_NET_RAW
 13

	)

213 
	#CAP_IPC_LOCK
 14

	)

217 
	#CAP_IPC_OWNER
 15

	)

220 
	#CAP_SYS_MODULE
 16

	)

225 
	#CAP_SYS_RAWIO
 17

	)

229 
	#CAP_SYS_CHROOT
 18

	)

233 
	#CAP_SYS_PTRACE
 19

	)

237 
	#CAP_SYS_PACCT
 20

	)

276 
	#CAP_SYS_ADMIN
 21

	)

280 
	#CAP_SYS_BOOT
 22

	)

291 
	#CAP_SYS_NICE
 23

	)

306 
	#CAP_SYS_RESOURCE
 24

	)

312 
	#CAP_SYS_TIME
 25

	)

317 
	#CAP_SYS_TTY_CONFIG
 26

	)

321 
	#CAP_MKNOD
 27

	)

325 
	#CAP_LEASE
 28

	)

329 
	#CAP_AUDIT_WRITE
 29

	)

333 
	#CAP_AUDIT_CONTROL
 30

	)

338 
	#CAP_SETFCAP
 31

	)

346 
	#CAP_MAC_OVERRIDE
 32

	)

355 
	#CAP_MAC_ADMIN
 33

	)

359 
	#CAP_SYSLOG
 34

	)

363 
	#CAP_WAKE_ALARM
 35

	)

367 
	#CAP_BLOCK_SUSPEND
 36

	)

371 
	#CAP_AUDIT_READ
 37

	)

378 
	#CAP_PERFMON
 38

	)

409 
	#CAP_BPF
 39

	)

416 
	#CAP_CHECKPOINT_RESTORE
 40

	)

418 
	#CAP_LAST_CAP
 
CAP_CHECKPOINT_RESTORE


	)

420 
	#ˇp_vÆid
(
x
Ë((xË>0 && (xË<
CAP_LAST_CAP
)

	)

426 
	#CAP_TO_INDEX
(
x
Ë((xË>> 5Ë

	)

427 
	#CAP_TO_MASK
(
x
Ë(1U << ((xË& 31)Ë

	)

	@/usr/include/linux/falloc.h

2 #i‚de‡
_FALLOC_H_


3 
	#_FALLOC_H_


	)

5 
	#FALLOC_FL_KEEP_SIZE
 0x01

	)

6 
	#FALLOC_FL_PUNCH_HOLE
 0x02

	)

7 
	#FALLOC_FL_NO_HIDE_STALE
 0x04

	)

29 
	#FALLOC_FL_COLLAPSE_RANGE
 0x08

	)

43 
	#FALLOC_FL_ZERO_RANGE
 0x10

	)

60 
	#FALLOC_FL_INSERT_RANGE
 0x20

	)

78 
	#FALLOC_FL_UNSHARE_RANGE
 0x40

	)

	@/usr/include/linux/fiemap.h

12 #i‚de‡
_LINUX_FIEMAP_H


13 
	#_LINUX_FIEMAP_H


	)

15 
	~<löux/ty≥s.h
>

17 
	sfõm≠_exã¡
 {

18 
__u64
 
	m„_logiˇl
;

20 
__u64
 
	m„_physiˇl
;

22 
__u64
 
	m„_Àngth
;

23 
__u64
 
	m„_ª£rved64
[2];

24 
__u32
 
	m„_Êags
;

25 
__u32
 
	m„_ª£rved
[3];

28 
	sfõm≠
 {

29 
__u64
 
	mfm_°¨t
;

31 
__u64
 
	mfm_Àngth
;

33 
__u32
 
	mfm_Êags
;

34 
__u32
 
	mfm_m≠≥d_exã¡s
;

35 
__u32
 
	mfm_exã¡_cou¡
;

36 
__u32
 
	mfm_ª£rved
;

37 
fõm≠_exã¡
 
	mfm_exã¡s
[0];

40 
	#FIEMAP_MAX_OFFSET
 (~0ULL)

	)

42 
	#FIEMAP_FLAG_SYNC
 0x00000001

	)

43 
	#FIEMAP_FLAG_XATTR
 0x00000002

	)

44 
	#FIEMAP_FLAG_CACHE
 0x00000004

	)

46 
	#FIEMAP_FLAGS_COMPAT
 (
FIEMAP_FLAG_SYNC
 | 
FIEMAP_FLAG_XATTR
)

	)

48 
	#FIEMAP_EXTENT_LAST
 0x00000001

	)

49 
	#FIEMAP_EXTENT_UNKNOWN
 0x00000002

	)

50 
	#FIEMAP_EXTENT_DELALLOC
 0x00000004

	)

52 
	#FIEMAP_EXTENT_ENCODED
 0x00000008

	)

54 
	#FIEMAP_EXTENT_DATA_ENCRYPTED
 0x00000080

	)

56 
	#FIEMAP_EXTENT_NOT_ALIGNED
 0x00000100

	)

58 
	#FIEMAP_EXTENT_DATA_INLINE
 0x00000200

	)

60 
	#FIEMAP_EXTENT_DATA_TAIL
 0x00000400

	)

62 
	#FIEMAP_EXTENT_UNWRITTEN
 0x00000800

	)

64 
	#FIEMAP_EXTENT_MERGED
 0x00001000

	)

67 
	#FIEMAP_EXTENT_SHARED
 0x00002000

	)

	@/usr/include/linux/fs.h

2 #i‚de‡
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<löux/limôs.h
>

14 
	~<löux/io˘l.h
>

15 
	~<löux/ty≥s.h
>

16 
	~<löux/fs¸y±.h
>

19 
	~<löux/mou¡.h
>

32 #unde‡
NR_OPEN


33 
	#INR_OPEN_CUR
 1024

	)

34 
	#INR_OPEN_MAX
 4096

	)

36 
	#BLOCK_SIZE_BITS
 10

	)

37 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

39 
	#SEEK_SET
 0

	)

40 
	#SEEK_CUR
 1

	)

41 
	#SEEK_END
 2

	)

42 
	#SEEK_DATA
 3

	)

43 
	#SEEK_HOLE
 4

	)

44 
	#SEEK_MAX
 
SEEK_HOLE


	)

46 
	#RENAME_NOREPLACE
 (1 << 0Ë

	)

47 
	#RENAME_EXCHANGE
 (1 << 1Ë

	)

48 
	#RENAME_WHITEOUT
 (1 << 2Ë

	)

50 
	sfûe_˛⁄e_ønge
 {

51 
__s64
 
	m§c_fd
;

52 
__u64
 
	m§c_off£t
;

53 
__u64
 
	m§c_Àngth
;

54 
__u64
 
	mde°_off£t
;

57 
	sf°rim_ønge
 {

58 
__u64
 
	m°¨t
;

59 
__u64
 
	mÀn
;

60 
__u64
 
	mmöÀn
;

64 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

65 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

68 
	sfûe_dedu≥_ønge_öfo
 {

69 
__s64
 
	mde°_fd
;

70 
__u64
 
	mde°_off£t
;

71 
__u64
 
	mbyãs_dedu≥d
;

78 
__s32
 
	m°©us
;

79 
__u32
 
	mª£rved
;

83 
	sfûe_dedu≥_ønge
 {

84 
__u64
 
	m§c_off£t
;

85 
__u64
 
	m§c_Àngth
;

86 
__u16
 
	mde°_cou¡
;

87 
__u16
 
	mª£rved1
;

88 
__u32
 
	mª£rved2
;

89 
fûe_dedu≥_ønge_öfo
 
	möfo
[0];

93 
	sfûes_°©_°ru˘
 {

94 
	mƒ_fûes
;

95 
	mƒ_‰ì_fûes
;

96 
	mmax_fûes
;

99 
	söodes_°©_t
 {

100 
	mƒ_öodes
;

101 
	mƒ_unu£d
;

102 
	mdummy
[5];

106 
	#NR_FILE
 8192

	)

111 
	sfsx©å
 {

112 
__u32
 
	mfsx_xÊags
;

113 
__u32
 
	mfsx_extsize
;

114 
__u32
 
	mfsx_√xã¡s
;

115 
__u32
 
	mfsx_¥ojid
;

116 
__u32
 
	mfsx_cowextsize
;

117 
	mfsx_∑d
[8];

123 
	#FS_XFLAG_REALTIME
 0x00000001

	)

124 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

125 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

126 
	#FS_XFLAG_APPEND
 0x00000010

	)

127 
	#FS_XFLAG_SYNC
 0x00000020

	)

128 
	#FS_XFLAG_NOATIME
 0x00000040

	)

129 
	#FS_XFLAG_NODUMP
 0x00000080

	)

130 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

131 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

132 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

133 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

134 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

135 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

136 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

137 
	#FS_XFLAG_DAX
 0x00008000

	)

138 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

139 
	#FS_XFLAG_HASATTR
 0x80000000

	)

144 
	#BLKROSET
 
	`_IO
(0x12,93Ë

	)

145 
	#BLKROGET
 
	`_IO
(0x12,94Ë

	)

146 
	#BLKRRPART
 
	`_IO
(0x12,95Ë

	)

147 
	#BLKGETSIZE
 
	`_IO
(0x12,96Ë

	)

148 
	#BLKFLSBUF
 
	`_IO
(0x12,97Ë

	)

149 
	#BLKRASET
 
	`_IO
(0x12,98Ë

	)

150 
	#BLKRAGET
 
	`_IO
(0x12,99Ë

	)

151 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

152 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

153 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

154 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

155 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

157 
	#BLKPG
 
	`_IO
(0x12,105)

	)

161 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

162 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

167 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

168 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

169 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
Ë

	)

170 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_åa˚_£tup
)

	)

171 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

172 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

173 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

174 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

175 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

176 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

177 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

178 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

179 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

180 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

181 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

182 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

183 
	#BLKGETDISKSEQ
 
	`_IOR
(0x12,128,
__u64
)

	)

189 
	#BMAP_IOCTL
 1

	)

190 
	#FIBMAP
 
	`_IO
(0x00,1Ë

	)

191 
	#FIGETBSZ
 
	`_IO
(0x00,2Ë

	)

192 
	#FIFREEZE
 
	`_IOWR
('X', 119, Ë

	)

193 
	#FITHAW
 
	`_IOWR
('X', 120, Ë

	)

194 
	#FITRIM
 
	`_IOWR
('X', 121, 
f°rim_ønge
Ë

	)

195 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

196 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fûe_˛⁄e_ønge
)

	)

197 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fûe_dedu≥_ønge
)

	)

199 
	#FSLABEL_MAX
 256

	)

201 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

202 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

203 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

204 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

205 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
fõm≠
)

	)

206 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

207 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

208 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

209 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

210 
	#FS_IOC_FSGETXATTR
 
	`_IOR
('X', 31, 
fsx©å
)

	)

211 
	#FS_IOC_FSSETXATTR
 
	`_IOW
('X', 32, 
fsx©å
)

	)

212 
	#FS_IOC_GETFSLABEL
 
	`_IOR
(0x94, 49, [
FSLABEL_MAX
])

	)

213 
	#FS_IOC_SETFSLABEL
 
	`_IOW
(0x94, 50, [
FSLABEL_MAX
])

	)

235 
	#FS_SECRM_FL
 0x00000001

	)

236 
	#FS_UNRM_FL
 0x00000002

	)

237 
	#FS_COMPR_FL
 0x00000004

	)

238 
	#FS_SYNC_FL
 0x00000008

	)

239 
	#FS_IMMUTABLE_FL
 0x00000010

	)

240 
	#FS_APPEND_FL
 0x00000020

	)

241 
	#FS_NODUMP_FL
 0x00000040

	)

242 
	#FS_NOATIME_FL
 0x00000080

	)

244 
	#FS_DIRTY_FL
 0x00000100

	)

245 
	#FS_COMPRBLK_FL
 0x00000200

	)

246 
	#FS_NOCOMP_FL
 0x00000400

	)

248 
	#FS_ENCRYPT_FL
 0x00000800

	)

249 
	#FS_BTREE_FL
 0x00001000

	)

250 
	#FS_INDEX_FL
 0x00001000

	)

251 
	#FS_IMAGIC_FL
 0x00002000

	)

252 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

253 
	#FS_NOTAIL_FL
 0x00008000

	)

254 
	#FS_DIRSYNC_FL
 0x00010000

	)

255 
	#FS_TOPDIR_FL
 0x00020000

	)

256 
	#FS_HUGE_FILE_FL
 0x00040000

	)

257 
	#FS_EXTENT_FL
 0x00080000

	)

258 
	#FS_VERITY_FL
 0x00100000

	)

259 
	#FS_EA_INODE_FL
 0x00200000

	)

260 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

261 
	#FS_NOCOW_FL
 0x00800000

	)

262 
	#FS_DAX_FL
 0x02000000

	)

263 
	#FS_INLINE_DATA_FL
 0x10000000

	)

264 
	#FS_PROJINHERIT_FL
 0x20000000

	)

265 
	#FS_CASEFOLD_FL
 0x40000000

	)

266 
	#FS_RESERVED_FL
 0x80000000

	)

268 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

269 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

272 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

273 
	#SYNC_FILE_RANGE_WRITE
 2

	)

274 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

275 
	#SYNC_FILE_RANGE_WRITE_AND_WAIT
 (
SYNC_FILE_RANGE_WRITE
 | \

276 
SYNC_FILE_RANGE_WAIT_BEFORE
 | \

277 
SYNC_FILE_RANGE_WAIT_AFTER
)

	)

283 
	t__bôwi£
 
	t__kî√l_rwf_t
;

286 
	#RWF_HIPRI
 ((
__kî√l_rwf_t
)0x00000001)

	)

289 
	#RWF_DSYNC
 ((
__kî√l_rwf_t
)0x00000002)

	)

292 
	#RWF_SYNC
 ((
__kî√l_rwf_t
)0x00000004)

	)

295 
	#RWF_NOWAIT
 ((
__kî√l_rwf_t
)0x00000008)

	)

298 
	#RWF_APPEND
 ((
__kî√l_rwf_t
)0x00000010)

	)

301 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
 |\

302 
RWF_APPEND
)

	)

	@/usr/include/linux/fscrypt.h

8 #i‚de‡
_LINUX_FSCRYPT_H


9 
	#_LINUX_FSCRYPT_H


	)

11 
	~<löux/io˘l.h
>

12 
	~<löux/ty≥s.h
>

15 
	#FSCRYPT_POLICY_FLAGS_PAD_4
 0x00

	)

16 
	#FSCRYPT_POLICY_FLAGS_PAD_8
 0x01

	)

17 
	#FSCRYPT_POLICY_FLAGS_PAD_16
 0x02

	)

18 
	#FSCRYPT_POLICY_FLAGS_PAD_32
 0x03

	)

19 
	#FSCRYPT_POLICY_FLAGS_PAD_MASK
 0x03

	)

20 
	#FSCRYPT_POLICY_FLAG_DIRECT_KEY
 0x04

	)

21 
	#FSCRYPT_POLICY_FLAG_IV_INO_LBLK_64
 0x08

	)

22 
	#FSCRYPT_POLICY_FLAG_IV_INO_LBLK_32
 0x10

	)

25 
	#FSCRYPT_MODE_AES_256_XTS
 1

	)

26 
	#FSCRYPT_MODE_AES_256_CTS
 4

	)

27 
	#FSCRYPT_MODE_AES_128_CBC
 5

	)

28 
	#FSCRYPT_MODE_AES_128_CTS
 6

	)

29 
	#FSCRYPT_MODE_ADIANTUM
 9

	)

38 
	#FSCRYPT_POLICY_V1
 0

	)

39 
	#FSCRYPT_KEY_DESCRIPTOR_SIZE
 8

	)

40 
	sfs¸y±_pﬁicy_v1
 {

41 
__u8
 
	mvîsi⁄
;

42 
__u8
 
	mc⁄ã¡s_í¸y±i⁄_mode
;

43 
__u8
 
	mfûíames_í¸y±i⁄_mode
;

44 
__u8
 
	mÊags
;

45 
__u8
 
	mma°î_key_des¸ùt‹
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

52 
	#FSCRYPT_KEY_DESC_PREFIX
 "fs¸y±:"

	)

53 
	#FSCRYPT_KEY_DESC_PREFIX_SIZE
 8

	)

54 
	#FSCRYPT_MAX_KEY_SIZE
 64

	)

55 
	sfs¸y±_key
 {

56 
__u32
 
	mmode
;

57 
__u8
 
	møw
[
FSCRYPT_MAX_KEY_SIZE
];

58 
__u32
 
	msize
;

64 
	#FSCRYPT_POLICY_V2
 2

	)

65 
	#FSCRYPT_KEY_IDENTIFIER_SIZE
 16

	)

66 
	sfs¸y±_pﬁicy_v2
 {

67 
__u8
 
	mvîsi⁄
;

68 
__u8
 
	mc⁄ã¡s_í¸y±i⁄_mode
;

69 
__u8
 
	mfûíames_í¸y±i⁄_mode
;

70 
__u8
 
	mÊags
;

71 
__u8
 
	m__ª£rved
[4];

72 
__u8
 
	mma°î_key_idítifõr
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

76 
	sfs¸y±_gë_pﬁicy_ex_¨g
 {

77 
__u64
 
	mpﬁicy_size
;

79 
__u8
 
	mvîsi⁄
;

80 
fs¸y±_pﬁicy_v1
 
	mv1
;

81 
fs¸y±_pﬁicy_v2
 
	mv2
;

82 } 
	mpﬁicy
;

89 
	#FSCRYPT_KEY_SPEC_TYPE_DESCRIPTOR
 1

	)

96 
	#FSCRYPT_KEY_SPEC_TYPE_IDENTIFIER
 2

	)

102 
	sfs¸y±_key_•ecifõr
 {

103 
__u32
 
	mty≥
;

104 
__u32
 
	m__ª£rved
;

106 
__u8
 
	m__ª£rved
[32];

107 
__u8
 
	mdes¸ùt‹
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

108 
__u8
 
	midítifõr
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

109 } 
	mu
;

116 
	sfs¸y±_¥ovisi⁄ög_key_∑ylﬂd
 {

117 
__u32
 
	mty≥
;

118 
__u32
 
	m__ª£rved
;

119 
__u8
 
	møw
[];

123 
	sfs¸y±_add_key_¨g
 {

124 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

125 
__u32
 
	møw_size
;

126 
__u32
 
	mkey_id
;

127 
__u32
 
	m__ª£rved
[8];

128 
__u8
 
	møw
[];

132 
	sfs¸y±_ªmove_key_¨g
 {

133 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

134 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_FILES_BUSY
 0x00000001

	)

135 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_OTHER_USERS
 0x00000002

	)

136 
__u32
 
	mªmovÆ_°©us_Êags
;

137 
__u32
 
	m__ª£rved
[5];

141 
	sfs¸y±_gë_key_°©us_¨g
 {

143 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

144 
__u32
 
	m__ª£rved
[6];

147 
	#FSCRYPT_KEY_STATUS_ABSENT
 1

	)

148 
	#FSCRYPT_KEY_STATUS_PRESENT
 2

	)

149 
	#FSCRYPT_KEY_STATUS_INCOMPLETELY_REMOVED
 3

	)

150 
__u32
 
	m°©us
;

151 
	#FSCRYPT_KEY_STATUS_FLAG_ADDED_BY_SELF
 0x00000001

	)

152 
__u32
 
	m°©us_Êags
;

153 
__u32
 
	mu£r_cou¡
;

154 
__u32
 
	m__out_ª£rved
[13];

157 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fs¸y±_pﬁicy_v1
)

	)

158 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

159 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fs¸y±_pﬁicy_v1
)

	)

160 
	#FS_IOC_GET_ENCRYPTION_POLICY_EX
 
	`_IOWR
('f', 22, 
__u8
[9]Ë

	)

161 
	#FS_IOC_ADD_ENCRYPTION_KEY
 
	`_IOWR
('f', 23, 
fs¸y±_add_key_¨g
)

	)

162 
	#FS_IOC_REMOVE_ENCRYPTION_KEY
 
	`_IOWR
('f', 24, 
fs¸y±_ªmove_key_¨g
)

	)

163 
	#FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
 
	`_IOWR
('f', 25, 
fs¸y±_ªmove_key_¨g
)

	)

164 
	#FS_IOC_GET_ENCRYPTION_KEY_STATUS
 
	`_IOWR
('f', 26, 
fs¸y±_gë_key_°©us_¨g
)

	)

165 
	#FS_IOC_GET_ENCRYPTION_NONCE
 
	`_IOR
('f', 27, 
__u8
[16])

	)

170 
	#fs¸y±_pﬁicy
 
fs¸y±_pﬁicy_v1


	)

171 
	#FS_KEY_DESCRIPTOR_SIZE
 
FSCRYPT_KEY_DESCRIPTOR_SIZE


	)

172 
	#FS_POLICY_FLAGS_PAD_4
 
FSCRYPT_POLICY_FLAGS_PAD_4


	)

173 
	#FS_POLICY_FLAGS_PAD_8
 
FSCRYPT_POLICY_FLAGS_PAD_8


	)

174 
	#FS_POLICY_FLAGS_PAD_16
 
FSCRYPT_POLICY_FLAGS_PAD_16


	)

175 
	#FS_POLICY_FLAGS_PAD_32
 
FSCRYPT_POLICY_FLAGS_PAD_32


	)

176 
	#FS_POLICY_FLAGS_PAD_MASK
 
FSCRYPT_POLICY_FLAGS_PAD_MASK


	)

177 
	#FS_POLICY_FLAG_DIRECT_KEY
 
FSCRYPT_POLICY_FLAG_DIRECT_KEY


	)

178 
	#FS_POLICY_FLAGS_VALID
 0x07

	)

179 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

180 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 
FSCRYPT_MODE_AES_256_XTS


	)

181 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

182 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

183 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 
FSCRYPT_MODE_AES_256_CTS


	)

184 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 
FSCRYPT_MODE_AES_128_CBC


	)

185 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 
FSCRYPT_MODE_AES_128_CTS


	)

186 
	#FS_ENCRYPTION_MODE_SPECK128_256_XTS
 7

	)

187 
	#FS_ENCRYPTION_MODE_SPECK128_256_CTS
 8

	)

188 
	#FS_ENCRYPTION_MODE_ADIANTUM
 
FSCRYPT_MODE_ADIANTUM


	)

189 
	#FS_KEY_DESC_PREFIX
 
FSCRYPT_KEY_DESC_PREFIX


	)

190 
	#FS_KEY_DESC_PREFIX_SIZE
 
FSCRYPT_KEY_DESC_PREFIX_SIZE


	)

191 
	#FS_MAX_KEY_SIZE
 
FSCRYPT_MAX_KEY_SIZE


	)

	@/usr/include/linux/fsverity.h

10 #i‚de‡
_LINUX_FSVERITY_H


11 
	#_LINUX_FSVERITY_H


	)

13 
	~<löux/io˘l.h
>

14 
	~<löux/ty≥s.h
>

16 
	#FS_VERITY_HASH_ALG_SHA256
 1

	)

17 
	#FS_VERITY_HASH_ALG_SHA512
 2

	)

19 
	sfsvîôy_íabÀ_¨g
 {

20 
__u32
 
	mvîsi⁄
;

21 
__u32
 
	mhash_Æg‹ôhm
;

22 
__u32
 
	mblock_size
;

23 
__u32
 
	mß…_size
;

24 
__u64
 
	mß…_±r
;

25 
__u32
 
	msig_size
;

26 
__u32
 
	m__ª£rved1
;

27 
__u64
 
	msig_±r
;

28 
__u64
 
	m__ª£rved2
[11];

31 
	sfsvîôy_dige°
 {

32 
__u16
 
	mdige°_Æg‹ôhm
;

33 
__u16
 
	mdige°_size
;

34 
__u8
 
	mdige°
[];

47 
	sfsvîôy_des¸ùt‹
 {

48 
__u8
 
	mvîsi⁄
;

49 
__u8
 
	mhash_Æg‹ôhm
;

50 
__u8
 
	mlog_blocksize
;

51 
__u8
 
	mß…_size
;

52 
__À32
 
	m__ª£rved_0x04
;

53 
__À64
 
	md©a_size
;

54 
__u8
 
	mroŸ_hash
[64];

55 
__u8
 
	mß…
[32];

56 
__u8
 
	m__ª£rved
[144];

72 
	sfsvîôy_f‹m©ãd_dige°
 {

73 
	mmagic
[8];

74 
__À16
 
	mdige°_Æg‹ôhm
;

75 
__À16
 
	mdige°_size
;

76 
__u8
 
	mdige°
[];

79 
	#FS_VERITY_METADATA_TYPE_MERKLE_TREE
 1

	)

80 
	#FS_VERITY_METADATA_TYPE_DESCRIPTOR
 2

	)

81 
	#FS_VERITY_METADATA_TYPE_SIGNATURE
 3

	)

83 
	sfsvîôy_ªad_mëad©a_¨g
 {

84 
__u64
 
	mmëad©a_ty≥
;

85 
__u64
 
	moff£t
;

86 
__u64
 
	mÀngth
;

87 
__u64
 
	mbuf_±r
;

88 
__u64
 
	m__ª£rved
;

91 
	#FS_IOC_ENABLE_VERITY
 
	`_IOW
('f', 133, 
fsvîôy_íabÀ_¨g
)

	)

92 
	#FS_IOC_MEASURE_VERITY
 
	`_IOWR
('f', 134, 
fsvîôy_dige°
)

	)

93 
	#FS_IOC_READ_VERITY_METADATA
 \

94 
	`_IOWR
('f', 135, 
fsvîôy_ªad_mëad©a_¨g
)

	)

	@/usr/include/linux/kernel.h

2 #i‚de‡
_LINUX_KERNEL_H


3 
	#_LINUX_KERNEL_H


	)

5 
	~<löux/sysöfo.h
>

6 
	~<löux/c⁄°.h
>

	@/usr/include/linux/magic.h

2 #i‚de‡
__LINUX_MAGIC_H__


3 
	#__LINUX_MAGIC_H__


	)

5 
	#ADFS_SUPER_MAGIC
 0xadf5

	)

6 
	#AFFS_SUPER_MAGIC
 0xadff

	)

7 
	#AFS_SUPER_MAGIC
 0x5346414F

	)

8 
	#AUTOFS_SUPER_MAGIC
 0x0187

	)

9 
	#CODA_SUPER_MAGIC
 0x73757245

	)

10 
	#CRAMFS_MAGIC
 0x28cd3d45

	)

11 
	#CRAMFS_MAGIC_WEND
 0x453dcd28

	)

12 
	#DEBUGFS_MAGIC
 0x64626720

	)

13 
	#SECURITYFS_MAGIC
 0x73636673

	)

14 
	#SELINUX_MAGIC
 0xf97cff8c

	)

15 
	#SMACK_MAGIC
 0x43415d53

	)

16 
	#RAMFS_MAGIC
 0x858458f6

	)

17 
	#TMPFS_MAGIC
 0x01021994

	)

18 
	#HUGETLBFS_MAGIC
 0x958458f6

	)

19 
	#SQUASHFS_MAGIC
 0x73717368

	)

20 
	#ECRYPTFS_SUPER_MAGIC
 0xf15f

	)

21 
	#EFS_SUPER_MAGIC
 0x414A53

	)

22 
	#EROFS_SUPER_MAGIC_V1
 0xE0F5E1E2

	)

23 
	#EXT2_SUPER_MAGIC
 0xEF53

	)

24 
	#EXT3_SUPER_MAGIC
 0xEF53

	)

25 
	#XENFS_SUPER_MAGIC
 0xabba1974

	)

26 
	#EXT4_SUPER_MAGIC
 0xEF53

	)

27 
	#BTRFS_SUPER_MAGIC
 0x9123683E

	)

28 
	#NILFS_SUPER_MAGIC
 0x3434

	)

29 
	#F2FS_SUPER_MAGIC
 0xF2F52010

	)

30 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

31 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

32 
	#JFFS2_SUPER_MAGIC
 0x72b6

	)

33 
	#XFS_SUPER_MAGIC
 0x58465342

	)

34 
	#PSTOREFS_MAGIC
 0x6165676C

	)

35 
	#EFIVARFS_MAGIC
 0xde5e81e4

	)

36 
	#HOSTFS_SUPER_MAGIC
 0x00c0f„e

	)

37 
	#OVERLAYFS_SUPER_MAGIC
 0x794c7630

	)

39 
	#MINIX_SUPER_MAGIC
 0x137F

	)

40 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

41 
	#MINIX2_SUPER_MAGIC
 0x2468

	)

42 
	#MINIX2_SUPER_MAGIC2
 0x2478

	)

43 
	#MINIX3_SUPER_MAGIC
 0x4d5®

	)

45 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

46 
	#NCP_SUPER_MAGIC
 0x564¯

	)

47 
	#NFS_SUPER_MAGIC
 0x6969

	)

48 
	#OCFS2_SUPER_MAGIC
 0x7461636f

	)

49 
	#OPENPROM_SUPER_MAGIC
 0x9Á1

	)

50 
	#QNX4_SUPER_MAGIC
 0x002‡

	)

51 
	#QNX6_SUPER_MAGIC
 0x68191122

	)

52 
	#AFS_FS_MAGIC
 0x6B414653

	)

54 
	#REISERFS_SUPER_MAGIC
 0x52654973

	)

57 
	#REISERFS_SUPER_MAGIC_STRING
 "ReIsErFs"

	)

58 
	#REISER2FS_SUPER_MAGIC_STRING
 "ReIsEr2Fs"

	)

59 
	#REISER2FS_JR_SUPER_MAGIC_STRING
 "ReIsEr3Fs"

	)

61 
	#SMB_SUPER_MAGIC
 0x517B

	)

62 
	#CGROUP_SUPER_MAGIC
 0x27e0eb

	)

63 
	#CGROUP2_SUPER_MAGIC
 0x63677270

	)

65 
	#RDTGROUP_SUPER_MAGIC
 0x7655821

	)

67 
	#STACK_END_MAGIC
 0x57AC6E9D

	)

69 
	#TRACEFS_MAGIC
 0x74726163

	)

71 
	#V9FS_MAGIC
 0x01021997

	)

73 
	#BDEVFS_MAGIC
 0x62646576

	)

74 
	#DAXFS_MAGIC
 0x64646178

	)

75 
	#BINFMTFS_MAGIC
 0x42494e4d

	)

76 
	#DEVPTS_SUPER_MAGIC
 0x1cd1

	)

77 
	#BINDERFS_SUPER_MAGIC
 0x6c6f6f70

	)

78 
	#FUTEXFS_SUPER_MAGIC
 0xBAD1DEA

	)

79 
	#PIPEFS_MAGIC
 0x50495045

	)

80 
	#PROC_SUPER_MAGIC
 0x9Á0

	)

81 
	#SOCKFS_MAGIC
 0x534F434B

	)

82 
	#SYSFS_MAGIC
 0x62656572

	)

83 
	#USBDEVICE_SUPER_MAGIC
 0x9Á2

	)

84 
	#MTD_INODE_FS_MAGIC
 0x11307854

	)

85 
	#ANON_INODE_FS_MAGIC
 0x09041934

	)

86 
	#BTRFS_TEST_MAGIC
 0x73727279

	)

87 
	#NSFS_MAGIC
 0x6e736673

	)

88 
	#BPF_FS_MAGIC
 0xˇ„4a11

	)

89 
	#AAFS_MAGIC
 0x5a3c69f0

	)

90 
	#ZONEFS_MAGIC
 0x5a4f4653

	)

93 
	#UDF_SUPER_MAGIC
 0x15013346

	)

94 
	#BALLOON_KVM_MAGIC
 0x13661366

	)

95 
	#ZSMALLOC_MAGIC
 0x58295829

	)

96 
	#DMA_BUF_MAGIC
 0x444d4142

	)

97 
	#DEVMEM_MAGIC
 0x454d444d

	)

98 
	#Z3FOLD_MAGIC
 0x33

	)

99 
	#PPC_CMM_MAGIC
 0xc7571590

	)

100 
	#SECRETMEM_MAGIC
 0x5345434d

	)

102 
	#SHIFTFS_MAGIC
 0x6a656a62

	)

	@/usr/include/linux/mman.h

2 #i‚de‡
_LINUX_MMAN_H


3 
	#_LINUX_MMAN_H


	)

5 
	~<asm/mm™.h
>

6 
	~<asm-gíîic/hugëlb_ícode.h
>

8 
	#MREMAP_MAYMOVE
 1

	)

9 
	#MREMAP_FIXED
 2

	)

10 
	#MREMAP_DONTUNMAP
 4

	)

12 
	#OVERCOMMIT_GUESS
 0

	)

13 
	#OVERCOMMIT_ALWAYS
 1

	)

14 
	#OVERCOMMIT_NEVER
 2

	)

16 
	#MAP_SHARED
 0x01

	)

17 
	#MAP_PRIVATE
 0x02

	)

18 
	#MAP_SHARED_VALIDATE
 0x03

	)

27 
	#MAP_HUGE_SHIFT
 
HUGETLB_FLAG_ENCODE_SHIFT


	)

28 
	#MAP_HUGE_MASK
 
HUGETLB_FLAG_ENCODE_MASK


	)

30 
	#MAP_HUGE_16KB
 
HUGETLB_FLAG_ENCODE_16KB


	)

31 
	#MAP_HUGE_64KB
 
HUGETLB_FLAG_ENCODE_64KB


	)

32 
	#MAP_HUGE_512KB
 
HUGETLB_FLAG_ENCODE_512KB


	)

33 
	#MAP_HUGE_1MB
 
HUGETLB_FLAG_ENCODE_1MB


	)

34 
	#MAP_HUGE_2MB
 
HUGETLB_FLAG_ENCODE_2MB


	)

35 
	#MAP_HUGE_8MB
 
HUGETLB_FLAG_ENCODE_8MB


	)

36 
	#MAP_HUGE_16MB
 
HUGETLB_FLAG_ENCODE_16MB


	)

37 
	#MAP_HUGE_32MB
 
HUGETLB_FLAG_ENCODE_32MB


	)

38 
	#MAP_HUGE_256MB
 
HUGETLB_FLAG_ENCODE_256MB


	)

39 
	#MAP_HUGE_512MB
 
HUGETLB_FLAG_ENCODE_512MB


	)

40 
	#MAP_HUGE_1GB
 
HUGETLB_FLAG_ENCODE_1GB


	)

41 
	#MAP_HUGE_2GB
 
HUGETLB_FLAG_ENCODE_2GB


	)

42 
	#MAP_HUGE_16GB
 
HUGETLB_FLAG_ENCODE_16GB


	)

	@/usr/include/linux/module.h

2 #i‚de‡
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/mount.h

1 #i‚de‡
_LINUX_MOUNT_H


2 
	#_LINUX_MOUNT_H


	)

4 
	~<löux/ty≥s.h
>

13 
	#MS_RDONLY
 1

	)

14 
	#MS_NOSUID
 2

	)

15 
	#MS_NODEV
 4

	)

16 
	#MS_NOEXEC
 8

	)

17 
	#MS_SYNCHRONOUS
 16

	)

18 
	#MS_REMOUNT
 32

	)

19 
	#MS_MANDLOCK
 64

	)

20 
	#MS_DIRSYNC
 128

	)

21 
	#MS_NOSYMFOLLOW
 256

	)

22 
	#MS_NOATIME
 1024

	)

23 
	#MS_NODIRATIME
 2048

	)

24 
	#MS_BIND
 4096

	)

25 
	#MS_MOVE
 8192

	)

26 
	#MS_REC
 16384

	)

27 
	#MS_VERBOSE
 32768

	)

29 
	#MS_SILENT
 32768

	)

30 
	#MS_POSIXACL
 (1<<16Ë

	)

31 
	#MS_UNBINDABLE
 (1<<17Ë

	)

32 
	#MS_PRIVATE
 (1<<18Ë

	)

33 
	#MS_SLAVE
 (1<<19Ë

	)

34 
	#MS_SHARED
 (1<<20Ë

	)

35 
	#MS_RELATIME
 (1<<21Ë

	)

36 
	#MS_KERNMOUNT
 (1<<22Ë

	)

37 
	#MS_I_VERSION
 (1<<23Ë

	)

38 
	#MS_STRICTATIME
 (1<<24Ë

	)

39 
	#MS_LAZYTIME
 (1<<25Ë

	)

42 
	#MS_SUBMOUNT
 (1<<26)

	)

43 
	#MS_NOREMOTELOCK
 (1<<27)

	)

44 
	#MS_NOSEC
 (1<<28)

	)

45 
	#MS_BORN
 (1<<29)

	)

46 
	#MS_ACTIVE
 (1<<30)

	)

47 
	#MS_NOUSER
 (1<<31)

	)

52 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

53 
MS_LAZYTIME
)

	)

58 
	#MS_MGC_VAL
 0xC0ED0000

	)

59 
	#MS_MGC_MSK
 0xffff0000

	)

64 
	#OPEN_TREE_CLONE
 1

	)

65 
	#OPEN_TREE_CLOEXEC
 
O_CLOEXEC


	)

70 
	#MOVE_MOUNT_F_SYMLINKS
 0x00000001

	)

71 
	#MOVE_MOUNT_F_AUTOMOUNTS
 0x00000002

	)

72 
	#MOVE_MOUNT_F_EMPTY_PATH
 0x00000004

	)

73 
	#MOVE_MOUNT_T_SYMLINKS
 0x00000010

	)

74 
	#MOVE_MOUNT_T_AUTOMOUNTS
 0x00000020

	)

75 
	#MOVE_MOUNT_T_EMPTY_PATH
 0x00000040

	)

76 
	#MOVE_MOUNT_SET_GROUP
 0x00000100

	)

77 
	#MOVE_MOUNT__MASK
 0x00000177

	)

82 
	#FSOPEN_CLOEXEC
 0x00000001

	)

87 
	#FSPICK_CLOEXEC
 0x00000001

	)

88 
	#FSPICK_SYMLINK_NOFOLLOW
 0x00000002

	)

89 
	#FSPICK_NO_AUTOMOUNT
 0x00000004

	)

90 
	#FSPICK_EMPTY_PATH
 0x00000008

	)

95 
	efsc⁄fig_comm™d
 {

96 
	mFSCONFIG_SET_FLAG
 = 0,

97 
	mFSCONFIG_SET_STRING
 = 1,

98 
	mFSCONFIG_SET_BINARY
 = 2,

99 
	mFSCONFIG_SET_PATH
 = 3,

100 
	mFSCONFIG_SET_PATH_EMPTY
 = 4,

101 
	mFSCONFIG_SET_FD
 = 5,

102 
	mFSCONFIG_CMD_CREATE
 = 6,

103 
	mFSCONFIG_CMD_RECONFIGURE
 = 7,

109 
	#FSMOUNT_CLOEXEC
 0x00000001

	)

114 
	#MOUNT_ATTR_RDONLY
 0x00000001

	)

115 
	#MOUNT_ATTR_NOSUID
 0x00000002

	)

116 
	#MOUNT_ATTR_NODEV
 0x00000004

	)

117 
	#MOUNT_ATTR_NOEXEC
 0x00000008

	)

118 
	#MOUNT_ATTR__ATIME
 0x00000070

	)

119 
	#MOUNT_ATTR_RELATIME
 0x00000000

	)

120 
	#MOUNT_ATTR_NOATIME
 0x00000010

	)

121 
	#MOUNT_ATTR_STRICTATIME
 0x00000020

	)

122 
	#MOUNT_ATTR_NODIRATIME
 0x00000080

	)

123 
	#MOUNT_ATTR_IDMAP
 0x00100000

	)

124 
	#MOUNT_ATTR_NOSYMFOLLOW
 0x00200000

	)

129 
	smou¡_©å
 {

130 
__u64
 
	m©å_£t
;

131 
__u64
 
	m©å_˛r
;

132 
__u64
 
	m¥›ag©i⁄
;

133 
__u64
 
	mu£∫s_fd
;

137 
	#MOUNT_ATTR_SIZE_VER0
 32

	)

	@/usr/include/linux/posix_acl.h

18 #i‚de‡
__UAPI_POSIX_ACL_H


19 
	#__UAPI_POSIX_ACL_H


	)

21 
	#ACL_UNDEFINED_ID
 (-1)

	)

24 
	#ACL_TYPE_ACCESS
 (0x8000)

	)

25 
	#ACL_TYPE_DEFAULT
 (0x4000)

	)

28 
	#ACL_USER_OBJ
 (0x01)

	)

29 
	#ACL_USER
 (0x02)

	)

30 
	#ACL_GROUP_OBJ
 (0x04)

	)

31 
	#ACL_GROUP
 (0x08)

	)

32 
	#ACL_MASK
 (0x10)

	)

33 
	#ACL_OTHER
 (0x20)

	)

36 
	#ACL_READ
 (0x04)

	)

37 
	#ACL_WRITE
 (0x02)

	)

38 
	#ACL_EXECUTE
 (0x01)

	)

	@/usr/include/linux/posix_acl_xattr.h

18 #i‚de‡
__UAPI_POSIX_ACL_XATTR_H


19 
	#__UAPI_POSIX_ACL_XATTR_H


	)

21 
	~<löux/ty≥s.h
>

24 
	#POSIX_ACL_XATTR_VERSION
 0x0002

	)

27 
	#ACL_UNDEFINED_ID
 (-1)

	)

29 
	sposix_a˛_x©å_íåy
 {

30 
__À16
 
	me_èg
;

31 
__À16
 
	me_≥rm
;

32 
__À32
 
	me_id
;

35 
	sposix_a˛_x©å_hódî
 {

36 
__À32
 
	ma_vîsi⁄
;

	@/usr/include/linux/sched.h

2 #i‚de‡
_LINUX_SCHED_H


3 
	#_LINUX_SCHED_H


	)

5 
	~<löux/ty≥s.h
>

10 
	#CSIGNAL
 0x000000f‡

	)

11 
	#CLONE_VM
 0x00000100

	)

12 
	#CLONE_FS
 0x00000200

	)

13 
	#CLONE_FILES
 0x00000400

	)

14 
	#CLONE_SIGHAND
 0x00000800

	)

15 
	#CLONE_PIDFD
 0x00001000

	)

16 
	#CLONE_PTRACE
 0x00002000

	)

17 
	#CLONE_VFORK
 0x00004000

	)

18 
	#CLONE_PARENT
 0x00008000

	)

19 
	#CLONE_THREAD
 0x00010000

	)

20 
	#CLONE_NEWNS
 0x00020000

	)

21 
	#CLONE_SYSVSEM
 0x00040000

	)

22 
	#CLONE_SETTLS
 0x00080000

	)

23 
	#CLONE_PARENT_SETTID
 0x00100000

	)

24 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

25 
	#CLONE_DETACHED
 0x00400000

	)

26 
	#CLONE_UNTRACED
 0x00800000

	)

27 
	#CLONE_CHILD_SETTID
 0x01000000

	)

28 
	#CLONE_NEWCGROUP
 0x02000000

	)

29 
	#CLONE_NEWUTS
 0x04000000

	)

30 
	#CLONE_NEWIPC
 0x08000000

	)

31 
	#CLONE_NEWUSER
 0x10000000

	)

32 
	#CLONE_NEWPID
 0x20000000

	)

33 
	#CLONE_NEWNET
 0x40000000

	)

34 
	#CLONE_IO
 0x80000000

	)

37 
	#CLONE_CLEAR_SIGHAND
 0x100000000ULL

	)

38 
	#CLONE_INTO_CGROUP
 0x200000000ULL

	)

44 
	#CLONE_NEWTIME
 0x00000080

	)

46 #i‚de‡
__ASSEMBLY__


92 
	s˛⁄e_¨gs
 {

93 
__Æig√d_u64
 
	mÊags
;

94 
__Æig√d_u64
 
	mpidfd
;

95 
__Æig√d_u64
 
	mchûd_tid
;

96 
__Æig√d_u64
 
	m∑ª¡_tid
;

97 
__Æig√d_u64
 
	mexô_sig«l
;

98 
__Æig√d_u64
 
	m°ack
;

99 
__Æig√d_u64
 
	m°ack_size
;

100 
__Æig√d_u64
 
	més
;

101 
__Æig√d_u64
 
	m£t_tid
;

102 
__Æig√d_u64
 
	m£t_tid_size
;

103 
__Æig√d_u64
 
	mcgroup
;

107 
	#CLONE_ARGS_SIZE_VER0
 64

	)

108 
	#CLONE_ARGS_SIZE_VER1
 80

	)

109 
	#CLONE_ARGS_SIZE_VER2
 88

	)

114 
	#SCHED_NORMAL
 0

	)

115 
	#SCHED_FIFO
 1

	)

116 
	#SCHED_RR
 2

	)

117 
	#SCHED_BATCH
 3

	)

119 
	#SCHED_IDLE
 5

	)

120 
	#SCHED_DEADLINE
 6

	)

123 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

128 
	#SCHED_FLAG_RESET_ON_FORK
 0x01

	)

129 
	#SCHED_FLAG_RECLAIM
 0x02

	)

130 
	#SCHED_FLAG_DL_OVERRUN
 0x04

	)

131 
	#SCHED_FLAG_KEEP_POLICY
 0x08

	)

132 
	#SCHED_FLAG_KEEP_PARAMS
 0x10

	)

133 
	#SCHED_FLAG_UTIL_CLAMP_MIN
 0x20

	)

134 
	#SCHED_FLAG_UTIL_CLAMP_MAX
 0x40

	)

136 
	#SCHED_FLAG_KEEP_ALL
 (
SCHED_FLAG_KEEP_POLICY
 | \

137 
SCHED_FLAG_KEEP_PARAMS
)

	)

139 
	#SCHED_FLAG_UTIL_CLAMP
 (
SCHED_FLAG_UTIL_CLAMP_MIN
 | \

140 
SCHED_FLAG_UTIL_CLAMP_MAX
)

	)

142 
	#SCHED_FLAG_ALL
 (
SCHED_FLAG_RESET_ON_FORK
 | \

143 
SCHED_FLAG_RECLAIM
 | \

144 
SCHED_FLAG_DL_OVERRUN
 | \

145 
SCHED_FLAG_KEEP_ALL
 | \

146 
SCHED_FLAG_UTIL_CLAMP
)

	)

	@/usr/include/linux/stddef.h

2 #i‚de‡
_LINUX_STDDEF_H


3 
	#_LINUX_STDDEF_H


	)

7 #i‚de‡
__Æways_ölöe


8 
	#__Æways_ölöe
 
__ölöe__


	)

26 
	#__°ru˘_group
(
TAG
, 
NAME
, 
ATTRS
, 
MEMBERS
...) \

28 °ru˘ { 
MEMBERS
 } 
ATTRS
; \

29 
	sTAG
 { 
MEMBERS
 } 
ATTRS
 
NAME
; \

30 } 
ATTRS


	)

42 
	#__DECLARE_FLEX_ARRAY
(
TYPE
, 
NAME
) \

44 °ru˘ { } 
__em±y_
 ## 
NAME
; \

45 
TYPE
 
NAME
[]; \

46 }

	)

	@/usr/include/linux/string.h

2 #i‚de‡
_LINUX_STRING_H_


3 
	#_LINUX_STRING_H_


	)

7 
	~<°rög.h
>

	@/usr/include/linux/time.h

2 #i‚de‡
_LINUX_TIME_H


3 
	#_LINUX_TIME_H


	)

5 
	~<löux/ty≥s.h
>

6 
	~<löux/time_ty≥s.h
>

8 #i‚de‡
_STRUCT_TIMESPEC


9 
	#_STRUCT_TIMESPEC


	)

10 
	stime•ec
 {

11 
__kî√l_ﬁd_time_t
 
	mtv_£c
;

12 
	mtv_n£c
;

16 
	stimevÆ
 {

17 
__kî√l_ﬁd_time_t
 
	mtv_£c
;

18 
__kî√l_su£c⁄ds_t
 
	mtv_u£c
;

21 
	sôimî•ec
 {

22 
time•ec
 
	mô_öãrvÆ
;

23 
time•ec
 
	mô_vÆue
;

26 
	sôimîvÆ
 {

27 
timevÆ
 
	mô_öãrvÆ
;

28 
timevÆ
 
	mô_vÆue
;

31 
	stimez⁄e
 {

32 
	mtz_möuãswe°
;

33 
	mtz_d°time
;

40 
	#ITIMER_REAL
 0

	)

41 
	#ITIMER_VIRTUAL
 1

	)

42 
	#ITIMER_PROF
 2

	)

47 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

49 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

50 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

51 
	#CLOCK_MONOTONIC_RAW
 4

	)

52 
	#CLOCK_REALTIME_COARSE
 5

	)

53 
	#CLOCK_MONOTONIC_COARSE
 6

	)

54 
	#CLOCK_BOOTTIME
 7

	)

55 
	#CLOCK_REALTIME_ALARM
 8

	)

56 
	#CLOCK_BOOTTIME_ALARM
 9

	)

61 
	#CLOCK_SGI_CYCLE
 10

	)

62 
	#CLOCK_TAI
 11

	)

64 
	#MAX_CLOCKS
 16

	)

65 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

66 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

71 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/types.h

2 #i‚de‡
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty≥s.h
>

7 #i‚de‡
__ASSEMBLY__


9 
	~<löux/posix_ty≥s.h
>

17 #ifde‡
__CHECKER__


18 
	#__bôwi£__
 
	`__©åibuã__
((
bôwi£
))

	)

20 
	#__bôwi£__


	)

22 
	#__bôwi£
 
__bôwi£__


	)

24 
__u16
 
	t__bôwi£
 
	t__À16
;

25 
__u16
 
	t__bôwi£
 
	t__be16
;

26 
__u32
 
	t__bôwi£
 
	t__À32
;

27 
__u32
 
	t__bôwi£
 
	t__be32
;

28 
__u64
 
	t__bôwi£
 
	t__À64
;

29 
__u64
 
	t__bôwi£
 
	t__be64
;

31 
__u16
 
	t__bôwi£
 
	t__sum16
;

32 
__u32
 
	t__bôwi£
 
	t__wsum
;

43 
	#__Æig√d_u64
 
__u64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

44 
	#__Æig√d_be64
 
__be64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

45 
	#__Æig√d_À64
 
__À64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

47 
	t__bôwi£
 
	t__pﬁl_t
;

	@/usr/include/linux/uio.h

10 #i‚de‡
__LINUX_UIO_H


11 
	#__LINUX_UIO_H


	)

14 
	~<löux/ty≥s.h
>

17 
	siovec


19 *
	miov_ba£
;

20 
__kî√l_size_t
 
	miov_Àn
;

27 
	#UIO_FASTIOV
 8

	)

28 
	#UIO_MAXIOV
 1024

	)

	@/usr/include/linux/uuid.h

18 #i‚de‡
_LINUX_UUID_H_


19 
	#_LINUX_UUID_H_


	)

21 
	~<löux/ty≥s.h
>

24 
__u8
 
	mb
[16];

25 } 
	tguid_t
;

27 
	#GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

28 ((
guid_t
) \

29 {{ (
a
) & 0xff, ((a) >> 8) & 0xff, ((a) >> 16) & 0xff, ((a) >> 24) & 0xff, \

30 (
b
) & 0xff, ((b) >> 8) & 0xff, \

31 (
c
) & 0xff, ((c) >> 8) & 0xff, \

32 (
d0
), (
d1
), (
d2
), (
d3
), (
d4
), (
d5
), (
d6
), (
d7
Ë}})

	)

35 
guid_t
 
	tuuid_À
;

36 
	#UUID_LE
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

37 
	`GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
)

	)

38 
	#NULL_UUID_LE
 \

39 
	`UUID_LE
(0x00000000, 0x0000, 0x0000, 0x00, 0x00, 0x00, 0x00, \

40 0x00, 0x00, 0x00, 0x00)

	)

	@/usr/include/linux/wait.h

2 #i‚de‡
_LINUX_WAIT_H


3 
	#_LINUX_WAIT_H


	)

5 
	#WNOHANG
 0x00000001

	)

6 
	#WUNTRACED
 0x00000002

	)

7 
	#WSTOPPED
 
WUNTRACED


	)

8 
	#WEXITED
 0x00000004

	)

9 
	#WCONTINUED
 0x00000008

	)

10 
	#WNOWAIT
 0x01000000

	)

12 
	#__WNOTHREAD
 0x20000000

	)

13 
	#__WALL
 0x40000000

	)

14 
	#__WCLONE
 0x80000000

	)

17 
	#P_ALL
 0

	)

18 
	#P_PID
 1

	)

19 
	#P_PGID
 2

	)

20 
	#P_PIDFD
 3

	)

	@/usr/include/linux/xattr.h

13 
	~<löux/libc-com∑t.h
>

15 #i‚de‡
_LINUX_XATTR_H


16 
	#_LINUX_XATTR_H


	)

18 #i‡
__UAPI_DEF_XATTR


19 
	#__USE_KERNEL_XATTR_DEFS


	)

21 
	#XATTR_CREATE
 0x1

	)

22 
	#XATTR_REPLACE
 0x2

	)

26 
	#XATTR_OS2_PREFIX
 "os2."

	)

27 
	#XATTR_OS2_PREFIX_LEN
 ((
XATTR_OS2_PREFIX
Ë- 1)

	)

29 
	#XATTR_MAC_OSX_PREFIX
 "osx."

	)

30 
	#XATTR_MAC_OSX_PREFIX_LEN
 ((
XATTR_MAC_OSX_PREFIX
Ë- 1)

	)

32 
	#XATTR_BTRFS_PREFIX
 "båfs."

	)

33 
	#XATTR_BTRFS_PREFIX_LEN
 ((
XATTR_BTRFS_PREFIX
Ë- 1)

	)

35 
	#XATTR_HURD_PREFIX
 "gnu."

	)

36 
	#XATTR_HURD_PREFIX_LEN
 ((
XATTR_HURD_PREFIX
Ë- 1)

	)

38 
	#XATTR_SECURITY_PREFIX
 "£curôy."

	)

39 
	#XATTR_SECURITY_PREFIX_LEN
 ((
XATTR_SECURITY_PREFIX
Ë- 1)

	)

41 
	#XATTR_SYSTEM_PREFIX
 "sy°em."

	)

42 
	#XATTR_SYSTEM_PREFIX_LEN
 ((
XATTR_SYSTEM_PREFIX
Ë- 1)

	)

44 
	#XATTR_TRUSTED_PREFIX
 "åu°ed."

	)

45 
	#XATTR_TRUSTED_PREFIX_LEN
 ((
XATTR_TRUSTED_PREFIX
Ë- 1)

	)

47 
	#XATTR_USER_PREFIX
 "u£r."

	)

48 
	#XATTR_USER_PREFIX_LEN
 ((
XATTR_USER_PREFIX
Ë- 1)

	)

51 
	#XATTR_EVM_SUFFIX
 "evm"

	)

52 
	#XATTR_NAME_EVM
 
XATTR_SECURITY_PREFIX
 
XATTR_EVM_SUFFIX


	)

54 
	#XATTR_IMA_SUFFIX
 "ima"

	)

55 
	#XATTR_NAME_IMA
 
XATTR_SECURITY_PREFIX
 
XATTR_IMA_SUFFIX


	)

57 
	#XATTR_SELINUX_SUFFIX
 "£löux"

	)

58 
	#XATTR_NAME_SELINUX
 
XATTR_SECURITY_PREFIX
 
XATTR_SELINUX_SUFFIX


	)

60 
	#XATTR_SMACK_SUFFIX
 "SMACK64"

	)

61 
	#XATTR_SMACK_IPIN
 "SMACK64IPIN"

	)

62 
	#XATTR_SMACK_IPOUT
 "SMACK64IPOUT"

	)

63 
	#XATTR_SMACK_EXEC
 "SMACK64EXEC"

	)

64 
	#XATTR_SMACK_TRANSMUTE
 "SMACK64TRANSMUTE"

	)

65 
	#XATTR_SMACK_MMAP
 "SMACK64MMAP"

	)

66 
	#XATTR_NAME_SMACK
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_SUFFIX


	)

67 
	#XATTR_NAME_SMACKIPIN
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPIN


	)

68 
	#XATTR_NAME_SMACKIPOUT
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPOUT


	)

69 
	#XATTR_NAME_SMACKEXEC
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_EXEC


	)

70 
	#XATTR_NAME_SMACKTRANSMUTE
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_TRANSMUTE


	)

71 
	#XATTR_NAME_SMACKMMAP
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_MMAP


	)

73 
	#XATTR_APPARMOR_SUFFIX
 "≠∑rm‹"

	)

74 
	#XATTR_NAME_APPARMOR
 
XATTR_SECURITY_PREFIX
 
XATTR_APPARMOR_SUFFIX


	)

76 
	#XATTR_CAPS_SUFFIX
 "ˇ∑bûôy"

	)

77 
	#XATTR_NAME_CAPS
 
XATTR_SECURITY_PREFIX
 
XATTR_CAPS_SUFFIX


	)

79 
	#XATTR_POSIX_ACL_ACCESS
 "posix_a˛_ac˚ss"

	)

80 
	#XATTR_NAME_POSIX_ACL_ACCESS
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_ACCESS


	)

81 
	#XATTR_POSIX_ACL_DEFAULT
 "posix_a˛_deÁu…"

	)

82 
	#XATTR_NAME_POSIX_ACL_DEFAULT
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_DEFAULT


	)

	@/usr/include/asm-generic/hugetlb_encode.h

1 #i‚de‡
_ASM_GENERIC_HUGETLB_ENCODE_H_


2 
	#_ASM_GENERIC_HUGETLB_ENCODE_H_


	)

20 
	#HUGETLB_FLAG_ENCODE_SHIFT
 26

	)

21 
	#HUGETLB_FLAG_ENCODE_MASK
 0x3f

	)

23 
	#HUGETLB_FLAG_ENCODE_16KB
 (14U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

24 
	#HUGETLB_FLAG_ENCODE_64KB
 (16U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

25 
	#HUGETLB_FLAG_ENCODE_512KB
 (19U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

26 
	#HUGETLB_FLAG_ENCODE_1MB
 (20U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

27 
	#HUGETLB_FLAG_ENCODE_2MB
 (21U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

28 
	#HUGETLB_FLAG_ENCODE_8MB
 (23U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

29 
	#HUGETLB_FLAG_ENCODE_16MB
 (24U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

30 
	#HUGETLB_FLAG_ENCODE_32MB
 (25U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

31 
	#HUGETLB_FLAG_ENCODE_256MB
 (28U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

32 
	#HUGETLB_FLAG_ENCODE_512MB
 (29U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

33 
	#HUGETLB_FLAG_ENCODE_1GB
 (30U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

34 
	#HUGETLB_FLAG_ENCODE_2GB
 (31U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

35 
	#HUGETLB_FLAG_ENCODE_16GB
 (34U << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

	@/usr/include/linux/const.h

4 #i‚de‡
_LINUX_CONST_H


5 
	#_LINUX_CONST_H


	)

16 #ifde‡
__ASSEMBLY__


17 
	#_AC
(
X
,
Y
Ë
	)
X

18 
	#_AT
(
T
,
X
Ë
	)
X

20 
	#__AC
(
X
,
Y
Ë(X##Y)

	)

21 
	#_AC
(
X
,
Y
Ë
	`__AC
(X,Y)

	)

22 
	#_AT
(
T
,
X
Ë((T)(X))

	)

25 
	#_UL
(
x
Ë(
	`_AC
(x, 
UL
))

	)

26 
	#_ULL
(
x
Ë(
	`_AC
(x, 
ULL
))

	)

28 
	#_BITUL
(
x
Ë(
	`_UL
(1Ë<< (x))

	)

29 
	#_BITULL
(
x
Ë(
	`_ULL
(1Ë<< (x))

	)

31 
	#__ALIGN_KERNEL
(
x
, 
a
Ë
	`__ALIGN_KERNEL_MASK
(x, (
	`__ty≥of__
(x))◊Ë- 1)

	)

32 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
Ë(((xË+ (mask)Ë& ~(mask))

	)

34 
	#__KERNEL_DIV_ROUND_UP
(
n
, 
d
Ë((“Ë+ (dË- 1Ë/ (d))

	)

	@/usr/include/linux/ioctl.h

2 #i‚de‡
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/io˘l.h
>

	@/usr/include/linux/libc-compat.h

49 #i‚de‡
_LIBC_COMPAT_H


50 
	#_LIBC_COMPAT_H


	)

53 #i‡
deföed
(
__GLIBC__
)

56 #i‡
deföed
(
_NET_IF_H
Ë&& deföed(
__USE_MISC
)

61 
	#__UAPI_DEF_IF_IFCONF
 0

	)

62 
	#__UAPI_DEF_IF_IFMAP
 0

	)

63 
	#__UAPI_DEF_IF_IFNAMSIZ
 0

	)

64 
	#__UAPI_DEF_IF_IFREQ
 0

	)

66 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 0

	)

68 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


69 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

78 
	#__UAPI_DEF_IF_IFCONF
 1

	)

79 
	#__UAPI_DEF_IF_IFMAP
 1

	)

80 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

81 
	#__UAPI_DEF_IF_IFREQ
 1

	)

83 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

85 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

90 #i‡
deföed
(
_NETINET_IN_H
)

94 
	#__UAPI_DEF_IN_ADDR
 0

	)

95 
	#__UAPI_DEF_IN_IPPROTO
 0

	)

96 
	#__UAPI_DEF_IN_PKTINFO
 0

	)

97 
	#__UAPI_DEF_IP_MREQ
 0

	)

98 
	#__UAPI_DEF_SOCKADDR_IN
 0

	)

99 
	#__UAPI_DEF_IN_CLASS
 0

	)

101 
	#__UAPI_DEF_IN6_ADDR
 0

	)

106 #i‡
deföed
(
__USE_MISC
Ë|| deföed (
__USE_GNU
)

107 
	#__UAPI_DEF_IN6_ADDR_ALT
 0

	)

109 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

111 
	#__UAPI_DEF_SOCKADDR_IN6
 0

	)

112 
	#__UAPI_DEF_IPV6_MREQ
 0

	)

113 
	#__UAPI_DEF_IPPROTO_V6
 0

	)

114 
	#__UAPI_DEF_IPV6_OPTIONS
 0

	)

115 
	#__UAPI_DEF_IN6_PKTINFO
 0

	)

116 
	#__UAPI_DEF_IP6_MTUINFO
 0

	)

123 
	#__UAPI_DEF_IN_ADDR
 1

	)

124 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

125 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

126 
	#__UAPI_DEF_IP_MREQ
 1

	)

127 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

128 
	#__UAPI_DEF_IN_CLASS
 1

	)

130 
	#__UAPI_DEF_IN6_ADDR
 1

	)

133 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

134 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

135 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

136 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

137 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

138 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

139 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

144 #i‡
deföed
(
__NETIPX_IPX_H
)

146 
	#__UAPI_DEF_SOCKADDR_IPX
 0

	)

147 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 0

	)

148 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 0

	)

149 
	#__UAPI_DEF_IPX_CONFIG_DATA
 0

	)

150 
	#__UAPI_DEF_IPX_ROUTE_DEF
 0

	)

154 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

155 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

156 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

157 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

158 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

163 #i‡
deföed
(
_SYS_XATTR_H
)

164 
	#__UAPI_DEF_XATTR
 0

	)

166 
	#__UAPI_DEF_XATTR
 1

	)

176 #i‚de‡
__UAPI_DEF_IF_IFCONF


177 
	#__UAPI_DEF_IF_IFCONF
 1

	)

179 #i‚de‡
__UAPI_DEF_IF_IFMAP


180 
	#__UAPI_DEF_IF_IFMAP
 1

	)

182 #i‚de‡
__UAPI_DEF_IF_IFNAMSIZ


183 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

185 #i‚de‡
__UAPI_DEF_IF_IFREQ


186 
	#__UAPI_DEF_IF_IFREQ
 1

	)

189 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS


190 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

193 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


194 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

198 #i‚de‡
__UAPI_DEF_IN_ADDR


199 
	#__UAPI_DEF_IN_ADDR
 1

	)

201 #i‚de‡
__UAPI_DEF_IN_IPPROTO


202 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

204 #i‚de‡
__UAPI_DEF_IN_PKTINFO


205 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

207 #i‚de‡
__UAPI_DEF_IP_MREQ


208 
	#__UAPI_DEF_IP_MREQ
 1

	)

210 #i‚de‡
__UAPI_DEF_SOCKADDR_IN


211 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

213 #i‚de‡
__UAPI_DEF_IN_CLASS


214 
	#__UAPI_DEF_IN_CLASS
 1

	)

218 #i‚de‡
__UAPI_DEF_IN6_ADDR


219 
	#__UAPI_DEF_IN6_ADDR
 1

	)

221 #i‚de‡
__UAPI_DEF_IN6_ADDR_ALT


222 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

224 #i‚de‡
__UAPI_DEF_SOCKADDR_IN6


225 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

227 #i‚de‡
__UAPI_DEF_IPV6_MREQ


228 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

230 #i‚de‡
__UAPI_DEF_IPPROTO_V6


231 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

233 #i‚de‡
__UAPI_DEF_IPV6_OPTIONS


234 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

236 #i‚de‡
__UAPI_DEF_IN6_PKTINFO


237 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

239 #i‚de‡
__UAPI_DEF_IP6_MTUINFO


240 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

244 #i‚de‡
__UAPI_DEF_SOCKADDR_IPX


245 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

247 #i‚de‡
__UAPI_DEF_IPX_ROUTE_DEFINITION


248 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

250 #i‚de‡
__UAPI_DEF_IPX_INTERFACE_DEFINITION


251 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

253 #i‚de‡
__UAPI_DEF_IPX_CONFIG_DATA


254 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

256 #i‚de‡
__UAPI_DEF_IPX_ROUTE_DEF


257 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

261 #i‚de‡
__UAPI_DEF_XATTR


262 
	#__UAPI_DEF_XATTR
 1

	)

	@/usr/include/linux/limits.h

2 #i‚de‡
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/posix_types.h

2 #i‚de‡
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<löux/°ddef.h
>

22 #unde‡
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_bôs
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__kî√l_fd_£t
;

30 (*
	t__kî√l_sigh™dÀr_t
)();

33 
	t__kî√l_key_t
;

34 
	t__kî√l_mqd_t
;

36 
	~<asm/posix_ty≥s.h
>

	@/usr/include/linux/sysinfo.h

2 #i‚de‡
_LINUX_SYSINFO_H


3 
	#_LINUX_SYSINFO_H


	)

5 
	~<löux/ty≥s.h
>

7 
	#SI_LOAD_SHIFT
 16

	)

8 
	ssysöfo
 {

9 
__kî√l_l⁄g_t
 
	mu±ime
;

10 
__kî√l_ul⁄g_t
 
	mlﬂds
[3];

11 
__kî√l_ul⁄g_t
 
	mtŸÆøm
;

12 
__kî√l_ul⁄g_t
 
	m‰ìøm
;

13 
__kî√l_ul⁄g_t
 
	msh¨edøm
;

14 
__kî√l_ul⁄g_t
 
	mbuf„ºam
;

15 
__kî√l_ul⁄g_t
 
	mtŸÆsw≠
;

16 
__kî√l_ul⁄g_t
 
	m‰ìsw≠
;

17 
__u16
 
	m¥ocs
;

18 
__u16
 
	m∑d
;

19 
__kî√l_ul⁄g_t
 
	mtŸÆhigh
;

20 
__kî√l_ul⁄g_t
 
	m‰ìhigh
;

21 
__u32
 
	mmem_unô
;

22 
	m_f
[20-2*(
__kî√l_ul⁄g_t
)-(
__u32
)];

	@/usr/include/linux/time_types.h

2 #i‚de‡
_LINUX_TIME_TYPES_H


3 
	#_LINUX_TIME_TYPES_H


	)

5 
	~<löux/ty≥s.h
>

7 
	s__kî√l_time•ec
 {

8 
__kî√l_time64_t
 
	mtv_£c
;

9 
	mtv_n£c
;

12 
	s__kî√l_ôimî•ec
 {

13 
__kî√l_time•ec
 
	mô_öãrvÆ
;

14 
__kî√l_time•ec
 
	mô_vÆue
;

24 #i‚de‡
__kî√l_ﬁd_timevÆ


25 
	s__kî√l_ﬁd_timevÆ
 {

26 
__kî√l_l⁄g_t
 
	mtv_£c
;

27 
__kî√l_l⁄g_t
 
	mtv_u£c
;

31 
	s__kî√l_ﬁd_time•ec
 {

32 
__kî√l_ﬁd_time_t
 
	mtv_£c
;

33 
	mtv_n£c
;

36 
	s__kî√l_ﬁd_ôimîvÆ
 {

37 
__kî√l_ﬁd_timevÆ
 
	mô_öãrvÆ
;

38 
__kî√l_ﬁd_timevÆ
 
	mô_vÆue
;

41 
	s__kî√l_sock_timevÆ
 {

42 
__s64
 
	mtv_£c
;

43 
__s64
 
	mtv_u£c
;

	@/usr/include/string.h

22 #i‚def 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<bôs/libc-hódî-°¨t.h
>

28 
	g__BEGIN_DECLS


31 
	#__√ed_size_t


	)

32 
	#__√ed_NULL


	)

33 
	~<°ddef.h
>

36 #i‡
deföed
 
__˝lu•lus
 && (
__GNUC_PREREQ
 (4, 4) \

37 || 
	$__glibc_˛™g_¥îeq
 (3, 5))

38 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

43 *
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

44 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

47 *
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

48 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

53 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN
 || 
	`__GLIBC_USE
 (
ISOC2X
)

54 *
	$memc˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__n⁄nuŒ
 ((1, 2)Ë
	`__©å_ac˚ss
 ((
__wrôe_⁄ly__
, 1, 4));

61 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

64 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

65 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

80 
	$__memcm≥q
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

81 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

84 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


87 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

88 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

89 c⁄° *
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

90 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

92 #ifde‡
__OPTIMIZE__


93 
__exã∫_Æways_ölöe
 *

94 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


96  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

99 
__exã∫_Æways_ölöe
 const *

100 
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


102  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

105 
	}
}

107 *
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

108 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

111 #ifde‡
__USE_GNU


114 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


115 "C++" *
	$øwmemchr
 (*
__s
, 
__c
)

116 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

117 "C++" c⁄° *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

118 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

120 *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

121 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

125 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


126 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

127 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1))

128 
	`__©å_ac˚ss
 ((
__ªad_⁄ly__
, 1, 3));

129 "C++" c⁄° *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

130 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1))

131 
	`__©å_ac˚ss
 ((
__ªad_⁄ly__
, 1, 3));

133 *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

134 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1))

135 
	`__©å_ac˚ss
 ((
__ªad_⁄ly__
, 1, 3));

141 *
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

142 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

144 *
	$°∫˝y
 (*
__ª°ri˘
 
__de°
,

145 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

146 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

149 *
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

150 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

152 *
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

153 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

156 
	$°rcmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

157 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

159 
	$°∫cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

160 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

163 
	$°rcﬁl
 (c⁄° *
__s1
, c⁄° *
__s2
)

164 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

166 
size_t
 
	$°rx‰m
 (*
__ª°ri˘
 
__de°
,

167 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

168 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
	`__©å_ac˚ss
 ((
__wrôe_⁄ly__
, 1, 3));

170 #ifde‡
__USE_XOPEN2K8


172 
	~<bôs/ty≥s/loˇÀ_t.h
>

175 
	$°rcﬁl_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
loˇÀ_t
 
__l
)

176 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

179 
size_t
 
	$°rx‰m_l
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

180 
loˇÀ_t
 
__l
Ë
__THROW
 
	`__n⁄nuŒ
 ((2, 4))

181 
	`__©å_ac˚ss
 ((
__wrôe_⁄ly__
, 1, 3));

184 #i‡(
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_XOPEN2K8
 \

185 || 
	`__GLIBC_USE
 (
LIB_EXT2
Ë|| 
	$__GLIBC_USE
 (
ISOC2X
))

187 *
	$°rdup
 (c⁄° *
__s
)

188 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

194 #i‡
deföed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
Ë|| __GLIBC_USE (
ISOC2X
)

195 *
	$°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

196 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

199 #i‡
deföed
 
__USE_GNU
 && deföed 
__GNUC__


201 
	#°rdu∑
(
s
) \

202 (
__exãnsi⁄__
 \

204 c⁄° *
__ﬁd
 = (
s
); \

205 
size_t
 
__Àn
 = 
	`°æí
 (
__ﬁd
) + 1; \

206 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
); \

207 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

208 
	}
}))

	)

211 
	#°∫du∑
(
s
, 
n
) \

212 (
__exãnsi⁄__
 \

214 c⁄° *
__ﬁd
 = (
s
); \

215 
size_t
 
__Àn
 = 
	`°∫Àn
 (
__ﬁd
, (
n
)); \

216 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
 + 1); \

217 
__√w
[
__Àn
] = '\0'; \

218 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

219 }))

	)

223 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


226 *
°rchr
 (*
__s
, 
__c
)

227 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

228 c⁄° *
°rchr
 (c⁄° *
__s
, 
__c
)

229 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

231 #ifde‡
__OPTIMIZE__


232 
__exã∫_Æways_ölöe
 *

233 
°rchr
 (*
__s
, 
__c
Ë
	g__THROW


235  
__buûtö_°rchr
 (
__s
, 
__c
);

238 
__exã∫_Æways_ölöe
 const *

239 
°rchr
 (c⁄° *
__s
, 
__c
Ë
	g__THROW


241  
__buûtö_°rchr
 (
__s
, 
__c
);

246 *
	$°rchr
 (c⁄° *
__s
, 
__c
)

247 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

250 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


253 *
	`°ºchr
 (*
__s
, 
__c
)

254 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

255 c⁄° *
	`°ºchr
 (c⁄° *
__s
, 
__c
)

256 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

258 #ifde‡
__OPTIMIZE__


259 
__exã∫_Æways_ölöe
 *

260 
	`°ºchr
 (*
__s
, 
__c
Ë
__THROW


262  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

265 
__exã∫_Æways_ölöe
 const *

266 
	`°ºchr
 (c⁄° *
__s
, 
__c
Ë
__THROW


268  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

271 
	}
}

273 *
	$°ºchr
 (c⁄° *
__s
, 
__c
)

274 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

277 #ifde‡
__USE_GNU


280 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


281 "C++" *
	$°rch∫ul
 (*
__s
, 
__c
)

282 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

283 "C++" c⁄° *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

284 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

286 *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

287 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

293 
size_t
 
	$°rc•n
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

294 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

297 
size_t
 
	$°r•n
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

298 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

300 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


303 *
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
)

304 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

305 c⁄° *
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

306 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

308 #ifde‡
__OPTIMIZE__


309 
__exã∫_Æways_ölöe
 *

310 
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
Ë
__THROW


312  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

315 
__exã∫_Æways_ölöe
 const *

316 
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
Ë
__THROW


318  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

321 
	}
}

323 *
	$°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

324 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

327 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


330 *
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

331 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

332 c⁄° *
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

333 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

335 #ifde‡
__OPTIMIZE__


336 
__exã∫_Æways_ölöe
 *

337 
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


339  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

342 
__exã∫_Æways_ölöe
 const *

343 
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


345  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

348 
	}
}

350 *
	$°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

351 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

356 *
	$°πok
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
)

357 
__THROW
 
	`__n⁄nuŒ
 ((2));

361 *
	$__°πok_r
 (*
__ª°ri˘
 
__s
,

362 c⁄° *
__ª°ri˘
 
__dñim
,

363 **
__ª°ri˘
 
__ßve_±r
)

364 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

365 #ifde‡
__USE_POSIX


366 *
	$°πok_r
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
,

367 **
__ª°ri˘
 
__ßve_±r
)

368 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

371 #ifde‡
__USE_GNU


373 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


374 "C++" *
	$°rˇ£°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

375 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

376 "C++" c⁄° *
	$°rˇ£°r
 (c⁄° *
__hay°ack
,

377 c⁄° *
__√edÀ
)

378 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

380 *
	$°rˇ£°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

381 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

385 #ifde‡
__USE_GNU


389 *
	$memmem
 (c⁄° *
__hay°ack
, 
size_t
 
__hay°ackÀn
,

390 c⁄° *
__√edÀ
, 
size_t
 
__√edÀÀn
)

391 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 3))

392 
	`__©å_ac˚ss
 ((
__ªad_⁄ly__
, 1, 2))

393 
	`__©å_ac˚ss
 ((
__ªad_⁄ly__
, 3, 4));

397 *
	$__memp˝y
 (*
__ª°ri˘
 
__de°
,

398 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

399 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

400 *
	$memp˝y
 (*
__ª°ri˘
 
__de°
,

401 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

402 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

407 
size_t
 
	$°æí
 (c⁄° *
__s
)

408 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

410 #ifdef 
__USE_XOPEN2K8


413 
size_t
 
	$°∫Àn
 (c⁄° *
__°rög
, 
size_t
 
__maxÀn
)

414 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

419 *
	$°ªº‹
 (
__î∫um
Ë
__THROW
;

420 #ifde‡
__USE_XOPEN2K


428 #i‡
deföed
 
__USE_XOPEN2K
 && !deföed 
__USE_GNU


431 #ifde‡
__REDIRECT_NTH


432 
	`__REDIRECT_NTH
 (
°ªº‹_r
,

433 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
),

434 
__xpg_°ªº‹_r
Ë
	`__n⁄nuŒ
 ((2))

435 
	`__©å_ac˚ss
 ((
__wrôe_⁄ly__
, 2, 3));

437 
	$__xpg_°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

438 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
	`__©å_ac˚ss
 ((
__wrôe_⁄ly__
, 2, 3));

439 
	#°ªº‹_r
 
__xpg_°ªº‹_r


	)

444 *
	$°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

445 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
__wur
 
	`__©å_ac˚ss
 ((
__wrôe_⁄ly__
, 2, 3));

448 #ifde‡
__USE_GNU


450 c⁄° *
	$°ªº‹desc_≈
 (
__îr
Ë
__THROW
;

452 c⁄° *
	$°ªº‹«me_≈
 (
__îr
Ë
__THROW
;

456 #ifde‡
__USE_XOPEN2K8


458 *
	$°ªº‹_l
 (
__î∫um
, 
loˇÀ_t
 
__l
Ë
__THROW
;

461 #ifde‡
__USE_MISC


462 
	~<°rögs.h
>

466 
	$ex∂icô_bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1))

467 
	`__f‹tifõd_©å_ac˚ss
 (
__wrôe_⁄ly__
, 1, 2);

471 *
	$°r£p
 (**
__ª°ri˘
 
__°rögp
,

472 c⁄° *
__ª°ri˘
 
__dñim
)

473 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

476 #ifdef 
__USE_XOPEN2K8


478 *
	$°rsig«l
 (
__sig
Ë
__THROW
;

480 #ifde‡
__USE_GNU


482 c⁄° *
	$sigabbªv_≈
 (
__sig
Ë
__THROW
;

485 c⁄° *
	$sigdes¸_≈
 (
__sig
Ë
__THROW
;

489 *
	$__°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

490 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

491 *
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

492 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

496 *
	$__°≤˝y
 (*
__ª°ri˘
 
__de°
,

497 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

498 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

499 *
	$°≤˝y
 (*
__ª°ri˘
 
__de°
,

500 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

501 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

504 #ifdef 
__USE_GNU


506 
	$°rvîscmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

507 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

510 *
	$°r‰y
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

513 *
	$mem‰ob
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1))

514 
	`__©å_ac˚ss
 ((
__ªad_wrôe__
, 1, 2));

516 #i‚de‡
ba£«me


521 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


522 "C++" *
	$ba£«me
 (*
__fûíame
)

523 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

524 "C++" c⁄° *
	$ba£«me
 (c⁄° *
__fûíame
)

525 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

527 *
	$ba£«me
 (c⁄° *
__fûíame
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

532 #i‡
	`__GNUC_PREREQ
 (3,4)

533 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


535 
	~<bôs/°rög_f‹tifõd.h
>

539 
__END_DECLS


	@/usr/include/strings.h

18 #i‚def 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

21 
	~<„©uªs.h
>

22 
	#__√ed_size_t


	)

23 
	~<°ddef.h
>

26 #i‡
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (4, 4)

27 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

30 
	g__BEGIN_DECLS


32 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8


34 
	$bcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

35 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

38 
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__n
)

39 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

42 
	$bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

45 #ifde‡
__CORRECT_ISO_CPP_STRINGS_H_PROTO


48 *
	`ödex
 (*
__s
, 
__c
)

49 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

50 c⁄° *
	`ödex
 (c⁄° *
__s
, 
__c
)

51 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

53 #i‡
deföed
 
__OPTIMIZE__


54 
__exã∫_Æways_ölöe
 *

55 
	`ödex
 (*
__s
, 
__c
Ë
__THROW


57  
	`__buûtö_ödex
 (
__s
, 
__c
);

60 
__exã∫_Æways_ölöe
 const *

61 
	`ödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


63  
	`__buûtö_ödex
 (
__s
, 
__c
);

66 
	}
}

68 *
	$ödex
 (c⁄° *
__s
, 
__c
)

69 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

73 #ifde‡
__CORRECT_ISO_CPP_STRINGS_H_PROTO


76 *
	`rödex
 (*
__s
, 
__c
)

77 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

78 c⁄° *
	`rödex
 (c⁄° *
__s
, 
__c
)

79 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

81 #i‡
deföed
 
__OPTIMIZE__


82 
__exã∫_Æways_ölöe
 *

83 
	`rödex
 (*
__s
, 
__c
Ë
__THROW


85  
	`__buûtö_rödex
 (
__s
, 
__c
);

88 
__exã∫_Æways_ölöe
 const *

89 
	`rödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


91  
	`__buûtö_rödex
 (
__s
, 
__c
);

94 
	}
}

96 *
	$rödex
 (c⁄° *
__s
, 
__c
)

97 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

101 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8
 || deföed 
__USE_XOPEN2K8XSI


104 
	$ffs
 (
__i
Ë
__THROW
 
__©åibuã_c⁄°__
;

109 #ifdef 
__USE_MISC


110 
	$ff¶
 (
__l
Ë
__THROW
 
__©åibuã_c⁄°__
;

111 
__exãnsi⁄__
 
	$ff¶l
 (
__Œ
)

112 
__THROW
 
__©åibuã_c⁄°__
;

116 
	$°rˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

117 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

120 
	$°∫ˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

121 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

123 #ifdef 
__USE_XOPEN2K8


125 
	~<bôs/ty≥s/loˇÀ_t.h
>

128 
	$°rˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
loˇÀ_t
 
__loc
)

129 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

133 
	$°∫ˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

134 
size_t
 
__n
, 
loˇÀ_t
 
__loc
)

135 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 4));

138 
__END_DECLS


140 #i‡
	`__GNUC_PREREQ
 (3,4Ë&& 
__USE_FORTIFY_LEVEL
 > 0 \

141 && 
deföed
 
__f‹tify_fun˘i⁄


143 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8


144 
	~<bôs/°rögs_f‹tifõd.h
>

	@/usr/include/features.h

18 #i‚def 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

126 #unde‡
__USE_ISOC11


127 #unde‡
__USE_ISOC99


128 #unde‡
__USE_ISOC95


129 #unde‡
__USE_ISOCXX11


130 #unde‡
__USE_POSIX


131 #unde‡
__USE_POSIX2


132 #unde‡
__USE_POSIX199309


133 #unde‡
__USE_POSIX199506


134 #unde‡
__USE_XOPEN


135 #unde‡
__USE_XOPEN_EXTENDED


136 #unde‡
__USE_UNIX98


137 #unde‡
__USE_XOPEN2K


138 #unde‡
__USE_XOPEN2KXSI


139 #unde‡
__USE_XOPEN2K8


140 #unde‡
__USE_XOPEN2K8XSI


141 #unde‡
__USE_LARGEFILE


142 #unde‡
__USE_LARGEFILE64


143 #unde‡
__USE_FILE_OFFSET64


144 #unde‡
__USE_MISC


145 #unde‡
__USE_ATFILE


146 #unde‡
__USE_DYNAMIC_STACK_SIZE


147 #unde‡
__USE_GNU


148 #unde‡
__USE_FORTIFY_LEVEL


149 #unde‡
__KERNEL_STRICT_NAMES


150 #unde‡
__GLIBC_USE_ISOC2X


151 #unde‡
__GLIBC_USE_DEPRECATED_GETS


152 #unde‡
__GLIBC_USE_DEPRECATED_SCANF


156 #i‚de‡
_LOOSE_KERNEL_NAMES


157 
	#__KERNEL_STRICT_NAMES


	)

167 #i‡
deföed
 
__GNUC__
 && deföed 
__GNUC_MINOR__


168 
	#__GNUC_PREREQ
(
maj
, 
mö
) \

169 ((
__GNUC__
 << 16Ë+ 
__GNUC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

171 
	#__GNUC_PREREQ
(
maj
, 
mö
Ë0

	)

178 #i‡
deföed
 
__˛™g_maj‹__
 && deföed 
__˛™g_mö‹__


179 
	#__glibc_˛™g_¥îeq
(
maj
, 
mö
) \

180 ((
__˛™g_maj‹__
 << 16Ë+ 
__˛™g_mö‹__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

182 
	#__glibc_˛™g_¥îeq
(
maj
, 
mö
Ë0

	)

186 
	#__GLIBC_USE
(
F
Ë
__GLIBC_USE_
 ## 
	)
F

192 #i‡(
deföed
 
_BSD_SOURCE
 || deföed 
_SVID_SOURCE
) \

193 && !
deföed
 
	g_DEFAULT_SOURCE


195 #unde‡
_DEFAULT_SOURCE


196 
	#_DEFAULT_SOURCE
 1

	)

200 #ifde‡
_GNU_SOURCE


201 #unde‡
_ISOC95_SOURCE


202 
	#_ISOC95_SOURCE
 1

	)

203 #unde‡
_ISOC99_SOURCE


204 
	#_ISOC99_SOURCE
 1

	)

205 #unde‡
_ISOC11_SOURCE


206 
	#_ISOC11_SOURCE
 1

	)

207 #unde‡
_ISOC2X_SOURCE


208 
	#_ISOC2X_SOURCE
 1

	)

209 #unde‡
_POSIX_SOURCE


210 
	#_POSIX_SOURCE
 1

	)

211 #unde‡
_POSIX_C_SOURCE


212 
	#_POSIX_C_SOURCE
 200809L

	)

213 #unde‡
_XOPEN_SOURCE


214 
	#_XOPEN_SOURCE
 700

	)

215 #unde‡
_XOPEN_SOURCE_EXTENDED


216 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

217 #unde‡
_LARGEFILE64_SOURCE


218 
	#_LARGEFILE64_SOURCE
 1

	)

219 #unde‡
_DEFAULT_SOURCE


220 
	#_DEFAULT_SOURCE
 1

	)

221 #unde‡
_ATFILE_SOURCE


222 
	#_ATFILE_SOURCE
 1

	)

223 #unde‡
_DYNAMIC_STACK_SIZE_SOURCE


224 
	#_DYNAMIC_STACK_SIZE_SOURCE
 1

	)

229 #i‡(
deföed
 
_DEFAULT_SOURCE
 \

230 || (!
deföed
 
	g__STRICT_ANSI__
 \

231 && !
deföed
 
	g_ISOC99_SOURCE
 && !deföed 
	g_ISOC11_SOURCE
 \

232 && !
deföed
 
	g_ISOC2X_SOURCE
 \

233 && !
deföed
 
	g_POSIX_SOURCE
 && !deföed 
	g_POSIX_C_SOURCE
 \

234 && !
deföed
 
	g_XOPEN_SOURCE
))

235 #unde‡
_DEFAULT_SOURCE


236 
	#_DEFAULT_SOURCE
 1

	)

240 #i‡(
deföed
 
_ISOC2X_SOURCE
 \

241 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ > 201710L))

242 
	#__GLIBC_USE_ISOC2X
 1

	)

244 
	#__GLIBC_USE_ISOC2X
 0

	)

248 #i‡(
deföed
 
_ISOC11_SOURCE
 || deföed 
_ISOC2X_SOURCE
 \

249 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

250 
	#__USE_ISOC11
 1

	)

254 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

255 || 
deföed
 
_ISOC2X_SOURCE
 \

256 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

257 
	#__USE_ISOC99
 1

	)

261 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

262 || 
deföed
 
_ISOC2X_SOURCE
 \

263 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

264 
	#__USE_ISOC95
 1

	)

267 #ifde‡
__˝lu•lus


269 #i‡
__˝lu•lus
 >= 201703L

270 
	#__USE_ISOC11
 1

	)

274 #i‡
__˝lu•lus
 >201103L || 
deföed
 
__GXX_EXPERIMENTAL_CXX0X__


275 
	#__USE_ISOCXX11
 1

	)

276 
	#__USE_ISOC99
 1

	)

283 #ifde‡
_DEFAULT_SOURCE


284 #i‡!
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE


285 
	#__USE_POSIX_IMPLICITLY
 1

	)

287 #unde‡
_POSIX_SOURCE


288 
	#_POSIX_SOURCE
 1

	)

289 #unde‡
_POSIX_C_SOURCE


290 
	#_POSIX_C_SOURCE
 200809L

	)

293 #i‡((!
deföed
 
__STRICT_ANSI__
 \

294 || (
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

295 && !
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE
)

296 
	#_POSIX_SOURCE
 1

	)

297 #i‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

298 
	#_POSIX_C_SOURCE
 2

	)

299 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

300 
	#_POSIX_C_SOURCE
 199506L

	)

301 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

302 
	#_POSIX_C_SOURCE
 200112L

	)

304 
	#_POSIX_C_SOURCE
 200809L

	)

306 
	#__USE_POSIX_IMPLICITLY
 1

	)

315 #i‡((!
deföed
 
_POSIX_C_SOURCE
 || (_POSIX_C_SOURCE - 0) < 199506L) \

316 && (
deföed
 
_REENTRANT
 || deföed 
_THREAD_SAFE
))

317 
	#_POSIX_SOURCE
 1

	)

318 #unde‡
_POSIX_C_SOURCE


319 
	#_POSIX_C_SOURCE
 199506L

	)

322 #i‡(
deföed
 
_POSIX_SOURCE
 \

323 || (
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

324 || 
deföed
 
_XOPEN_SOURCE
)

325 
	#__USE_POSIX
 1

	)

328 #i‡
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >2 || deföed 
_XOPEN_SOURCE


329 
	#__USE_POSIX2
 1

	)

332 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

333 
	#__USE_POSIX199309
 1

	)

336 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

337 
	#__USE_POSIX199506
 1

	)

340 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

341 
	#__USE_XOPEN2K
 1

	)

342 #unde‡
__USE_ISOC95


343 
	#__USE_ISOC95
 1

	)

344 #unde‡
__USE_ISOC99


345 
	#__USE_ISOC99
 1

	)

348 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

349 
	#__USE_XOPEN2K8
 1

	)

350 #unde‡
_ATFILE_SOURCE


351 
	#_ATFILE_SOURCE
 1

	)

354 #ifdef 
_XOPEN_SOURCE


355 
	#__USE_XOPEN
 1

	)

356 #i‡(
_XOPEN_SOURCE
 - 0) >= 500

357 
	#__USE_XOPEN_EXTENDED
 1

	)

358 
	#__USE_UNIX98
 1

	)

359 #unde‡
_LARGEFILE_SOURCE


360 
	#_LARGEFILE_SOURCE
 1

	)

361 #i‡(
_XOPEN_SOURCE
 - 0) >= 600

362 #i‡(
_XOPEN_SOURCE
 - 0) >= 700

363 
	#__USE_XOPEN2K8
 1

	)

364 
	#__USE_XOPEN2K8XSI
 1

	)

366 
	#__USE_XOPEN2K
 1

	)

367 
	#__USE_XOPEN2KXSI
 1

	)

368 #unde‡
__USE_ISOC95


369 
	#__USE_ISOC95
 1

	)

370 #unde‡
__USE_ISOC99


371 
	#__USE_ISOC99
 1

	)

374 #ifde‡
_XOPEN_SOURCE_EXTENDED


375 
	#__USE_XOPEN_EXTENDED
 1

	)

380 #ifde‡
_LARGEFILE_SOURCE


381 
	#__USE_LARGEFILE
 1

	)

384 #ifde‡
_LARGEFILE64_SOURCE


385 
	#__USE_LARGEFILE64
 1

	)

388 #i‡
deföed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

389 
	#__USE_FILE_OFFSET64
 1

	)

392 
	~<„©uªs-time64.h
>

394 #i‡
deföed
 
_DEFAULT_SOURCE


395 
	#__USE_MISC
 1

	)

398 #ifdef 
_ATFILE_SOURCE


399 
	#__USE_ATFILE
 1

	)

402 #ifdef 
_DYNAMIC_STACK_SIZE_SOURCE


403 
	#__USE_DYNAMIC_STACK_SIZE
 1

	)

406 #ifdef 
_GNU_SOURCE


407 
	#__USE_GNU
 1

	)

410 #i‡
deföed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0

411 #i‡!
deföed
 
__OPTIMIZE__
 || __OPTIMIZE__ <= 0

412 #ñi‡!
__GNUC_PREREQ
 (4, 1)

413 #ñi‡
_FORTIFY_SOURCE
 > 2 && (
__glibc_˛™g_¥îeq
 (9, 0) \

414 || 
	$__GNUC_PREREQ
 (12, 0))

416 #i‡
_FORTIFY_SOURCE
 > 3

418 
	#__USE_FORTIFY_LEVEL
 3

	)

419 #ñi‡
_FORTIFY_SOURCE
 > 1

420 #i‡
_FORTIFY_SOURCE
 > 2

422 
	#__USE_FORTIFY_LEVEL
 2

	)

424 
	#__USE_FORTIFY_LEVEL
 1

	)

427 #i‚de‡
__USE_FORTIFY_LEVEL


428 
	#__USE_FORTIFY_LEVEL
 0

	)

435 #i‡
deföed
 
__˝lu•lus
 ? __˝lu•lu†>201402L : deföed 
__USE_ISOC11


436 
	#__GLIBC_USE_DEPRECATED_GETS
 0

	)

438 
	#__GLIBC_USE_DEPRECATED_GETS
 1

	)

453 #i‡(
deföed
 
__USE_GNU
 \

454 && (
deföed
 
__˝lu•lus
 \

455 ? (
__˝lu•lus
 < 201103L && !
deföed
 
__GXX_EXPERIMENTAL_CXX0X__
) \

456 : (!
deföed
 
__STDC_VERSION__
 || __STDC_VERSION__ < 199901L)))

457 
	#__GLIBC_USE_DEPRECATED_SCANF
 1

	)

459 
	#__GLIBC_USE_DEPRECATED_SCANF
 0

	)

464 
	~<°dc-¥edef.h
>

472 #unde‡
__GNU_LIBRARY__


473 
	#__GNU_LIBRARY__
 6

	)

477 
	#__GLIBC__
 2

	)

478 
	#__GLIBC_MINOR__
 35

	)

480 
	#__GLIBC_PREREQ
(
maj
, 
mö
) \

481 ((
__GLIBC__
 << 16Ë+ 
__GLIBC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

484 #i‚de‡
__ASSEMBLER__


485 #i‚de‡
_SYS_CDEFS_H


486 
	~<sys/cdefs.h
>

491 #i‡
deföed
 
__USE_FILE_OFFSET64
 && !deföed 
__REDIRECT


492 
	#__USE_LARGEFILE
 1

	)

493 
	#__USE_LARGEFILE64
 1

	)

499 #i‡
	`__GNUC_PREREQ
 (2, 7Ë&& 
deföed
 
__OPTIMIZE__
 \

500 && !
deföed
 
__OPTIMIZE_SIZE__
 && !deföed 
__NO_INLINE__
 \

501 && 
deföed
 
__exã∫_ölöe


502 
	#__USE_EXTERN_INLINES
 1

	)

510 
	~<gnu/°ubs.h
>

	@/usr/include/features-time64.h

20 
	~<bôs/w‹dsize.h
>

21 
	~<bôs/timesize.h
>

23 #i‡
deföed
 
_TIME_BITS


24 #i‡
_TIME_BITS
 == 64

25 #i‡! 
deföed
 (
_FILE_OFFSET_BITS
) || _FILE_OFFSET_BITS != 64

27 #ñi‡
__TIMESIZE
 == 32

28 
	#__USE_TIME_BITS64
 1

	)

30 #ñi‡
_TIME_BITS
 == 32

31 #i‡
__TIMESIZE
 > 32

35 #îr‹ 
InvÆid
 
_TIME_BITS
 
vÆue
 (
ˇn
 
⁄ly
 
be
 32 
‹
 64-
bô
)

	@/usr/include/stdc-predef.h

18 #i‚def 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifde‡
__GCC_IEC_559


37 #i‡
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

39 
	#__STDC_IEC_60559_BFP__
 201404L

	)

42 
	#__STDC_IEC_559__
 1

	)

43 
	#__STDC_IEC_60559_BFP__
 201404L

	)

46 #ifde‡
__GCC_IEC_559_COMPLEX


47 #i‡
__GCC_IEC_559_COMPLEX
 > 0

48 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_60559_COMPLEX__
 201404L

	)

52 
	#__STDC_IEC_559_COMPLEX__
 1

	)

53 
	#__STDC_IEC_60559_COMPLEX__
 201404L

	)

62 
	#__STDC_ISO_10646__
 201706L

	)

	@
1
.
1
/usr/include
177
2761
accessors.c
accessors.h
acl.c
acl.h
async-thread.c
async-thread.h
backref.c
backref.h
bio.c
bio.h
block-group.c
block-group.h
block-rsv.c
block-rsv.h
btrfs.mod.c
btrfs_inode.h
calclock/calclock.c
calclock/calclock.h
check-integrity.c
check-integrity.h
compression.c
compression.h
ctree.c
ctree.h
defrag.c
defrag.h
delalloc-space.c
delalloc-space.h
delayed-inode.c
delayed-inode.h
delayed-ref.c
delayed-ref.h
dev-replace.c
dev-replace.h
dir-item.c
dir-item.h
discard.c
discard.h
disk-io.c
disk-io.h
export.c
export.h
extent-io-tree.c
extent-io-tree.h
extent-tree.c
extent-tree.h
extent_io.c
extent_io.h
extent_map.c
extent_map.h
file-item.c
file-item.h
file.c
file.h
free-space-cache.c
free-space-cache.h
free-space-tree.c
free-space-tree.h
fs.c
fs.h
inode-item.c
inode-item.h
inode.c
ioctl.c
ioctl.h
locking.c
locking.h
lru_cache.c
lru_cache.h
lzo.c
messages.c
messages.h
misc.h
mm/filemap.c
mm/filemap.h
mm/internal.h
ordered-data.c
ordered-data.h
orphan.c
orphan.h
print-tree.c
print-tree.h
props.c
props.h
qgroup.c
qgroup.h
raid56.c
raid56.h
rcu-string.h
ref-verify.c
ref-verify.h
reflink.c
reflink.h
relocation.c
relocation.h
root-tree.c
root-tree.h
scrub.c
scrub.h
send.c
send.h
space-info.c
space-info.h
subpage.c
subpage.h
super.c
super.h
sysfs.c
sysfs.h
tests/btrfs-tests.c
tests/btrfs-tests.h
tests/extent-buffer-tests.c
tests/extent-io-tests.c
tests/extent-map-tests.c
tests/free-space-tests.c
tests/free-space-tree-tests.c
tests/inode-tests.c
tests/qgroup-tests.c
transaction.c
transaction.h
tree-checker.c
tree-checker.h
tree-log.c
tree-log.h
tree-mod-log.c
tree-mod-log.h
ulist.c
ulist.h
uuid-tree.c
uuid-tree.h
verity.c
verity.h
volumes.c
volumes.h
xattr.c
xattr.h
zlib.c
zoned.c
zoned.h
zstd.c
/usr/include/linux/btrfs.h
/usr/include/linux/btrfs_tree.h
/usr/include/linux/capability.h
/usr/include/linux/falloc.h
/usr/include/linux/fiemap.h
/usr/include/linux/fs.h
/usr/include/linux/fscrypt.h
/usr/include/linux/fsverity.h
/usr/include/linux/kernel.h
/usr/include/linux/magic.h
/usr/include/linux/mman.h
/usr/include/linux/module.h
/usr/include/linux/mount.h
/usr/include/linux/posix_acl.h
/usr/include/linux/posix_acl_xattr.h
/usr/include/linux/sched.h
/usr/include/linux/stddef.h
/usr/include/linux/string.h
/usr/include/linux/time.h
/usr/include/linux/types.h
/usr/include/linux/uio.h
/usr/include/linux/uuid.h
/usr/include/linux/wait.h
/usr/include/linux/xattr.h
/usr/include/asm-generic/hugetlb_encode.h
/usr/include/linux/const.h
/usr/include/linux/ioctl.h
/usr/include/linux/libc-compat.h
/usr/include/linux/limits.h
/usr/include/linux/posix_types.h
/usr/include/linux/sysinfo.h
/usr/include/linux/time_types.h
/usr/include/string.h
/usr/include/strings.h
/usr/include/features.h
/usr/include/features-time64.h
/usr/include/stdc-predef.h
